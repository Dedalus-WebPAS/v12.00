.----------------------------------------------------------------------
. Program       : ALLWEB05
.
. Function      : Allied Health VINAH extract Enquiry/Maintenance
.
. Modifications : 
.----------------------------------------------------------------------
. V11.04.06 30/09/2024 Nikitha B       TSK 0948566
.           VINAH MDS for 2024-25 Vic health department changes
.           Added IT Program - Subcutaneous Immunoglobulin Infusion Therapy
. V11.04.05 19/06/2024 Ebon Clements   TSK 0948057 
.           Added contact delivery setting current IP at another hospital
.           functionality to the current IP flag display - ALHD0840 and GTAG0170
. V11.04.04 06/05/2024 Ebon Clements   TSK 0927546
.           Added remote script to validate VINAH data load date - XMLD0000
. V11.04.03 11/04/2024 Nikitha B       TSK 0941763
.           Added BOARDER test to ignore BHS boarder at INPF0000.
. V11.04.02 09/04/2024 Nikitha B       TSK 0941763
.           Added new routine INPF0000 Called by:ALHD0840 and GTAG0170 - VINAH19
.           to check if the patient was an inpatient at the time of contact. 
. V11.04.01 25/03/2024 Ebon Clements   TSK 0915988
.           2025 Vic health department changes to report VINAH 19
.           Added program EPC
.----------------------------------------------------------------------
. V11.02.04 07/07/2022  Ebon Clements TSK 0919769
.           When setting a rejected batch with removed messages to accepted
.           set the batch and all messages to accepted. UMES0000
. V11.02.03 04/04/2022  Ebon Clements TSK 0913610
.           Changed force referral in update to also update the date closed,
.           date rejected or date cancelled depending on the referral status.
.           USAC0000 - MHDT0000
. V11.02.02 09/02/2022  Thanh T       TSK 0905641
.           Recompiled as OUTMA1FD (PATMASTM) changes
. V11.02.01 07/02/2022  Thanh T       TSK 0896905
.           Recompiled for ALLDEPFD changes
. V11.01.02 02/09/2021 Ebon Clements   TSK 0907466 
.           Added program type VALP - Victorian artificial limb
.           program based on SACS
. V11.01.01 08/07/2021  Ebon Clements  TSK 0908174
.           Added error correction display and force update of 
.           the referral in reason
. V11.00.04 09/12/2020  Thanh T        TSK 0872840
.           Added PMSCCDFD/PMSCCDIO as PMSPX2TM changes
. V11.00.03 19/03/2020 Ebon Clements     TSK 0888624
.           Added referral in cancelled/rejected date tags - ALHD0820
. V11.00.02 16/03/2020 Ebon Clements     TSK 0888624
.           Added referral in reason description tag - ALHD0790
. V11.00.01 26/02/2020 Ebon Clements     TSK 0888624
.           2020/2021 Statutory Health Department changes
.----------------------------------------------------------------------
. V10.15.02 11/10/2019  Ebon Clements    TSK 0882862
.           Added check for duplicate key in reset all errors - RESE0000
. V10.15.01 08/10/2019 Ebon Clements     TSK 0323579
.           Added ALHDRSTA to ALLHDTFD
. V10.14.06 06/08/2019  Peter Vela       TSK 0876649
.           Recompiled for ALLENCTM
. V10.14.05 05/08/2019  Ebon Clements    TSK 0878080
.           Added report 7 referral in outcome error correction maintenance
. V10.14.04 12/06/2019  Ebon Clements    TSK 0875686
.           Added contact service department to error corrections
. V10.14.03 21/05/2019  Ebon Clements    TSK 0868837
.           Don't display duplicate errors - ETAB0000
. V10.14.02 09/05/2019  Thanh T. & Ebon  TSK 0868837
.           Added ALHDT073/ALHDUDT2, ALHDT073/ALHDCEDT, ALHDT073/ALHDCETM
. V10.14.01 17/04/2019  Steve Armstrong  TSK 0868837
.           Recompiled for changes to ALLHDTFD.
.----------------------------------------------------------------------
. V10.13.04 10/01/2019  Ebon Clements  TSK 0866590
.           Populate ALHDDEPT for referral in update department tags
.           as no allhhdaf record is in context - ALLEVT00 - EXDEPT00
. V10.13.03 03/10/2018  Ebon Clements   TSK 0859073
.           Added date filter to VINAH files list - TABF0000
.           24/08/2018  Steve Armstrong TSK 0845563
.           Mods to call CLALLAUD in WRTRAU00.
. V10.13.02 31/07/2018  Thanh T         TSK 0845563
.           Recompiled for ALLAUDFD
. V10.13.01 30/07/2018  Ebon Clements   TSK 0815359
.           Don't display IP department in selection lists
.----------------------------------------------------------------------
. V10.12.01 23/03/2018  Thanh T.       TSK 0854273
.           Recompiled as ALLENCTM changed
.----------------------------------------------------------------------
. V10.11.06 01/12/2017  Ania P         TSK 0846952
.           Changed EXDEPT00 to read using ALHDDEPT not blank ALREDEPT
. V10.11.05 27/11/2017  Thanh Tieu     Task 0821710
.           Recompiled as PATMASTM changed
. V10.11.04 20/10/2017  Ebon Clements  TSK 0846025
.           Only display error code on first line of each error - ETAB0000
. V10.11.03 15/08/2017  Thanh T.       TSK 0821710
.           Removed PATCMNFD/PATCMNIO since it is not used.
. V10.11.02 30/07/2017  Thanh T.       TSK 0821710
.           Audit admission/outpatient/UR comments. changed PATMASTM/PMSPX2TM.
. V10.11.01 25/07/2017  Ebon Clements  TSK 0842571
.           Remove white space from error code - ETAB0000
. V10.10.03 11/07/2017  Ebon Clements  TSK 0316484
.           Added ALCNVURL - VINAH extract URL prefix to TABF0000
. V10.10.02 15/05/2017  Ebon Clements  TSK 0833052
.           2017 VINAH - Added triage status and triage date
. V10.10.01 19/04/2017  Ebon Clements  TSK 0282482
.           Added traige status to referral update - UPDREF00
. V10.09.01 27/01/2017  Ebon Clements  TSK 0828785
.           Recompiled for ALLREFTM - OP Site selection list security test
. V10.08.04 15/11/2016  Nicole Torrisi  TSK 0815159
.           Recompiled for ALLENCTM/ALLENCTD
. V10.08.03 23/09/2016  Steve Armstrong TSK 0826625
.           Mods to SACM4000 to populate Referral In record as per
.           VINAH012 when creating an RRI^I12 for a PPP^PCB message.
. V10.08.02 02/09/2016  Ebon Clements  TSK 0320806
.           Recompiled for PATCODTM - Include inactive codes
. V10.08.01 08/07/2016  Jill Parkinson TSK 0822002
.           Recompiled for PATMASTM
.----------------------------------------------------------------------
. V10.07.01 09/11/2015  Ebon Clements  CAR 321920
.           Added create referral in update message functionality - SACM4000
.----------------------------------------------------------------------
. V10.06.04 11/08/2915  Ania P         CAR 319861
.           Recompile for ALLREFTM
. V10.06.03 07/08/2015  Peter Vela       CAR 320050
.           Recompiled for ALLSASFD
. V10.06.02 12/05/2015  Ebon Clements    CAR 303890
.           Added ALLPROFD and open
. V10.06.01 12/03/2015  Steve Armstrong  CAR 314108
.           Removed definition of PTCGDATE as PATCGPFD is no longer in use
.----------------------------------------------------------------------
. V10.05.02 19/11/2014  Ebon Clements  CAR 308788
.           Added ALHDSTAT = 99 - Removed to FSTM0000
. V10.05.01 03/10/2014  Ebon Clements  CAR 268970
.           Change to use OUTCLIFD index 1 instead of index 2
.----------------------------------------------------------------------
. V10.04.06 15/05/2014  Steve Armstrong CAR 285465
.           Recompiled for changes to ALLHDTFD
. V10.04.05 28/04/2014  Ebon Clements   CAR 295858
.           Do not display error id if blank - ETAB0000
. V10.04.04 07/04/2014  Peter Vela      CAR 286258
.           Recompiled for PATMASTM
. V10.04.03 31.03.2014  B.G.Ackland  CAR 299363
.           Replace META Tag Redirect with Javascript in Common RDIREC00
.           Routine
. V10.04.02 25/03/2014  Ebon Clements     CAR 298538
.           Write before and after change audits in UPDREF00 and UPDENC00
. V10.04.01 14/03/2014  Don Nguyen        CAR 285773
.           Recompiled for changes to ALLENCTM
.----------------------------------------------------------------------
. V10.03.17 24/10/2103  Ebon Clements     CAR 292850
.           Don't write spaces on tag for ALHDIFLG if blank
. V10.03.16 14/10/2103  Ebon Clements     CAR 292534
.           Added referral in or episode referal test to MHDT0000 
. V10.03.15 14/10/2103  Ebon Clements     CAR 292534
.           Fixed pack of USACSTAT in KEY42 - ULNK0000 
. V10.03.14 07/10/2103  Ania P            CAR 292273
.           Added FORCEFLG, force update of vars in USEN0000 & MHDT0000 
. V10.03.13 02/10/2013  Peter Vela        CAR 291757
.           Recompiled for ALLREFTM
. V10.03.12 04/09/2013  Ania P            CAR 287852
.           Added ALHDUDT1 / ALHDT070
. V10.03.11 19/08/2013  Ebon Clements     CAR 284521
.           Fixed message status update - UMES0000
. V10.03.10 30/06/2013  Davin             CAR 283202
.           Recompiled for changes to hl7 messaging
. V10.03.09 30/06/2013  Davin             CAR 279183
.           Recompiled for changes to hl7 messaging (allquefd)
. V10.03.08 12/06/2013  Ebon Clements     CAR 286297
.           Added preferred site to ALLHDTFD
. V10.03.07 11/06/2013  Ebon Clements     CAR 286297
.           Added inactive test to clinic type selection list - HDTCTY00
. V10.03.06 03/04/2013  Ebon Clements     CAR 283115
.           Added other department details tag - ALDEDT00
. V10.03.05 22/03/2013  Ebon Clements     CAR 282990
.           Added referral in service type tag - GTAG0030
. V10.03.04 04/03/2013  Ebon Clements     CAR 282076
.           Added update of referral in service type - REFU0000
. V10.03.03 08/02/2013  Ebon Clements   CAR 280973
.           Added missing cgi vars to CPALHD00
. V10.03.02 12/11/2012  Ebon Clements   CAR 272756
.           Changes for VINAH8 for 2012-2013.
. V10.03.01 16/01/2012  Sandra Barcham  CAR 256563
.           Recompiled for PATMASTM
. V10.02.02 10/07/2011  Ebon Clements     CAR 242070
.           Recompiled for ALLREFTM - Referral hospital
. V10.02.01 29/06/2011  Ebon Clements     CAR 243794
.           Recompiled for ALLREFFD - added referred to hospital
. V10.00.04 28/05/2010  Steve Armstrong   CAR 220289
.           Recompiled for changes to ALLHDTFD
. V10.00.03 26/05/2010  Ebon Clements     CAR 220289
.           VINAH6 mods
. V10.00.02 22/04/2010  Steve Armstrong   CAR 220289
.           Recompiled for changes to ALLHDTFD
. V10.00.01 02/02/2010  Steve Armstrong   CAR 135505
.           Added DGCLII13 and DGCLICEU triggers
.           Also added HL7TRGID & HL7INCLD setting for all broadcast messages
.----------------------------------------------------------------------
. V9.12.06  08/01/2010  Saroeun Soeur  XXXXXX
.           moved program stream tag to GTAG0020 
. V9.12.05  06/01/2010  Saroeun Soeur  213542
.           Recompiled for ALREFTM
. V9.12.04  05/01/2010  Saroeun Soeur  213542
.           added PROFLD35 - program stream tag
. V9.12.02  05/11/2009  Saroeun Soeur  207550
.           changed KEY54 to KEY57 to reflect ALLSEDAF file change
.           ETAB0000 
. V9.12.01  04/11/2009  Ebon Clements  CAR 207550
.           Added purged status to TABF0000 list of extract files
.           Changed RESE0000, USAC0000, USEN0000 & ULNK0000 to delete
.           any REF messages
. V9.11.02  13/03/2009  Ebon Clements  CAR 189263
.           Added status to key pack in TABM0000 if status populated
. V9.11.01  95/11/2008  Peter McMullen CAR 174725
.           convert internal javascript to W3C standards
. V9.10.03  30/07/2008  Ebon Clements  CAR 167977
.           Changed filtstat cgi to be packed with spaces
. V9.10.02  23/07/2008  Ebon Clements  CAR 168981
.           Added display of merge in U/R column in message by batch list
. V9.10.01  22/05/2008  Ebon Clements  CAR 167977
.           Added update extract file status functionality
. V9.09.12  19/03/2008  Ebon Clements  CAR 164345
.           Added update encounter functionality
. V9.09.11  04/01/2008  J.Tan          CAR 135498
.           Mods for NZ MHINC Extract
. V9.09.10  20/11/2007  Peter McMullen CAR 155307
.           Added link to extrace file on SACS extract list (see TABF0000)
. V9.09.09  01/11/2007  Ebon Clements CAR 153776   
.           Added list sacs error detail functionality - ETAB0000
. V9.09.08  26/10/2007  Ebon Clements CAR 153441   
.           Changed USAC000, ULNK000 and RESE0000 to delete merge records and
.           records created by SACSEXTR
. V9.09.07  12/10/2007  Ebon Clements CAR 152175   
.           Changed ULNK0000 to set printed error record back to waiting
. V9.09.06  24/08/2007  Ebon Clements CAR 133923
.           Changed department selection lists to be in alphabetical order
. V9.09.05  14/08/2007  Ebon Clements            CAR 147094 
.           Changed VINAHEXT to SACSEXTR
. V9.09.04  17/07/2007  Ebon Clements            CAR 145004 
.           Changed RESE0000 to delete pmi errors
. V9.09.03  11/07/2007  Ebon Clements            CAR 145004 
.           Changed USAC0000 to also update record with a status of waiting
. V9.09.02  09/07/2007  Ebon Clements            CAR 144772 
.           Added new cgi for ALHDRFND 
. V9.09.01  26/06/2007  Ebon Clements            CAR 143617 
.           Added ULNK0000 to delete pmi error records
. V9.08.03  24/05/2007  Ebon Clements            CAR 141588 
.           Changed USAC0000 to reset all records back to waiting
. V9.08.02  22/05/2007  Ebon Clements            CAR 111005
.           Added reset all errors back to waiting option   
. V9.08.01  02/05/2007  Ebon Clements            CAR 111005
.           Added update referral and message functionality
. V9.08.00  13/02/2007  Ebon Clements            CAR 111005
.           Created Web Server.
.----------------------------------------------------------------------
          INC       IBAWEBDF    
          INC       WEBDATDF
.
          INC       ALLAUDFD/INC
          INC       ALLAEFFD/INC
          INC       ALLBIAFD/INC
          INC       ALLCASFD/INC
          INC       ALLCONFD/INC
          INC       ALLDEPFD/INC
          INC       ALLDIAFD/INC
          INC       ALLEMDFD/INC
          INC       ALLENCFD/INC
          INC       ALLENCTD/INC
          INC       ALLERCFD/INC
          INC       ALLHBTFD/INC 
          INC       ALLHDTFD/INC
          INC       ALLHHDFD/INC 
          INC       ALLITMFD/INC
          INC       ALLITVFD/INC
          INC       ALLMDTFD/INC
          INC       ALLRITFD/INC
          INC       ALLRLNFD/INC
          INC       ALLPROFD/INC
          INC       ALLPRRFD/INC
          INC       ALLQUEFD/INC
          INC       ALLREFFD/INC
          INC       ALLREFTD/INC
          INC       ALLRIOFD/INC
          INC       ALLSASFD/INC
          INC       ALLSEDFD/INC
          INC       ALLSERFD/INC
          INC       ALLSUPFD/INC
          INC       HL7INBFD/INC
          INC       PATFIMFD/INC
          INC       PMSHCLFD/INC
          INC       PMSHCPTD/INC
          INC       PATDO1FD/INC   * Doctor File
.
          INC       APSMASFD/INC
          INC       HL7CISFD/INC
          INC       MLTSECFD/INC
          INC       MLTSITFD/INC
          INC       PATMA1FD/INC
          INC       PATNIDFD/INC
          INC       PATCONFD/INC
          INC       PATALRFD/INC
          INC       PATVISFD/INC
          INC       PMSHCPFD/INC
          INC       PMSQPTFD/INC
          INC       PMSVX1FD/INC
          INC       OUTSITFD/INC
          INC       OUTCTYFD/INC
          INC       OUTCLIFD/INC
          INC       PMSUCHFD/INC
          INC       PMSUCDFD/INC
          INC       PATMASTD/INC
          INC       PATHSPFD/INC
          INC       PATRE1FD/INC
          INC       PMSPX2FD/INC
          INC       PMSPX2TD/INC
          INC       PATMI1FD/INC
          INC       PATFN1FD/INC
          INC       PATPR1FD/INC
          INC       PATWR1FD/INC
          INC       MRTMASFD/INC
          INC       NHIMASFD/INC
          INC       NHIETHFD/INC
          INC       PATCALAG/INC
          INC       PATIN1FD/INC
          INC       PMSHCGTD/INC
          INC       PMSHCGFD/INC
          INC       PRIITMFD/INC
          INC       PATDSCFD/INC
          INC       PATASFFD/INC
          INC       PATDGWFD/INC
          INC       PATITMFD/INC
          INC       PMSCCDFD/INC            * Concession Card Details
.
          INC       ALLRHLTD/INC
          INC       ALLRHLFD/INC 
          INC       PATVADFD/INC
.
. allhdtaf cgi vars
.
.Name     Type      Length Description
.----     ----      ------ -----------
ALHDT001  DIM       2      Record Status
ALHDT002  DIM       8      Patient Identifier (alreurno)
ALHDT003  DIM       14     Date/Time Created (ccyymmddhhmmss)
ALHDT004  DIM       8      Episode Identifier (alrevisn/alenvisn)
ALHDT005  DIM       8      Contact Identifier (alenenct)
ALHDT006  DIM       20     Batch Number
ALHDT007  DIM       20     Message Id (from MSH-10)
ALHDT008  DIM       1      Record Type
ALHDT009  DIM       1      Action Type
ALHDT010  DIM       1      VINAH Referral Flag
ALHDT011  DIM       7      Message Type (eg ADT-A04)
ALHDT012  DIM       1      Record Source
ALHDT013  DIM       3      Department (alldepaf.alredept)
ALHDT014  DIM       2      Program Type
ALHDT015  DIM      10      Web User Id (alrecuid)
.
.                          Patient Related Fields
.                          ----------------------
ALHDT016  DIM       3      Patient Carer Residency Status
ALHDT017  DIM       3      Patient Carer Availability
ALHDT018  DIM       3      Patient Living Arrangement
ALHDT019  DIM       3      Patient Usual Accommodation Type
ALHDT020  DIM       3      Patient Main Carer's Relationship
ALHDT021  DIM       3      Patient Death Place
ALHDT022  DIM       8      Old U/R No. (A40 only)
.
.                          Referral-In Related Fields
.                          --------------------------
ALHDT023  DIM       8      Referral-In Received Date
ALHDT024  DIM       3      Referral-In Outcome Rejection Reason
ALHDT025  DIM       3      Referral-In Outcome Cancellation
ALHDT026  DIM       1      Referral-In Outcome (alrestat)
ALHDT027  DIM       3      Referral-In Clinical Urgency Code
ALHDT028  DIM       8      Referral-In Clinical Referral Date
ALHDT029  DIM       8      Referral-In Receipt Acknowledgement
ALHDT030  DIM       8      Linked Referral Visit No.
.
.                          Episode Related Fields
.                          ----------------------
ALHDT031  DIM       8      Episode Start Date
ALHDT032  DIM       8      Episode End Date
ALHDT033  DIM       1      Episode First Consultancy Flag
ALHDT034  DIM       3      Episode Completion of Proposed
ALHDT035  DIM       8      Episode Impairment Onset Date
ALHDT036  DIM       8      Episode Advanced Care Plan Documented
ALHDT037  DIM       8      Episode Care Plan Documented Date
ALHDT038  DIM       8      Episode First Appointment Booked Date
ALHDT039  DIM       8      Episode Hospital Discharge Date
ALHDT040  DIM       8      Episode Patient First Notified of
ALHDT041  DIM       3      Episode End Reason
ALHDT042  DIM       1      Episode Malignancy Flag
ALHDT043  DIM       6      Episode Clinic Type (alrectyp)
ALHDT044  DIM       3      Episode Event Program
.
.                          Contact Related Fields
.                          ----------------------
ALHDT045  DIM       3      Contact Account Class
ALHDT046  DIM       10     Contact Prof. Group 0 (alenhcp)
ALHDT047  DIM       10     Contact Prof. Group 1 (alenuhc1)
ALHDT048  DIM       10     Contact Prof. Group 2 (alenuhc2)
ALHDT049  DIM       10     Contact Prof. Group 3 (alenuhc3)
ALHDT050  DIM       10     Contact Prof. Group 4 (alenuhc4)
ALHDT051  DIM       8      Contact Date  (alensdat - ccyymmdd)
ALHDT052  DIM       8      Contact Time  (alenstim - hh:mm:ss)
ALHDT053  DIM       3      Contact Main Purpose
ALHDT054  DIM       3      Contact Session Type
ALHDT055  DIM       3      Contact Client Present Status
ALHDT056  DIM       3      Contact Delivery Mode
ALHDT057  DIM       3      Contact Delivery Setting
ALHDT058  DIM       3      Contact Phase of Care
ALHDT059  DIM       3      Contact Preferred Death Place
ALHDT060  DIM       3      Contact Care Model
ALHDT061  DIM       8      Contact Inpatient Flag
ALHDT062  DIM      10      Contact Specialist Palliative Care
ALHDT063  DIM       3      Contact Preferred Care Setting
ALHDT064  DIM       3      Contact Event Program
.
.                          Referral-Out Related Fields
.                          ---------------------------
ALHDT065  DIM       8      Referral-Out Date (allrhlaf.alrhdate)
ALHDT066  DIM       9      Referral-Out Service Type
ALHDT067  DIM       9      Referral-Out Place
ALHDT068  DIM       3      Referral-Out Record Count
.
ALHDT069  DIM       6      Preferred Site
ALHDT070  DIM       8      User Defined Date 1 (CCYYMMDD)
.

ALHDT071  DIM       3      Referral-In Triage Status (Cat ts) (alretrgs)
ALHDT072  DIM       8      Episode Referral Triage Date (ccyymmdd)
ALHDT073  DIM       8      Episode Patient Ready for Care Date (ccyymmdd)
ALHDT074  DIM       8      Contact End Date (ccyymmdd)
ALHDT075  DIM       8      Contact End Time (hh:mm:ss)
ALHDT076  DIM       3      Encounter Service Department (Cat CG)
ALHDT077  DIM       1      Contact Record Status (alenrsta)
ALHDT078  DIM       8      Referral-In Cancellation Date (ccyymmdd)
ALHDT079  DIM       3      Referral-In Reason Department
ALHDT080  DIM       9      Referral-In Reason
ALHDT081  DIM       3      Referral-In First Triage Score
ALHDT082  DIM       8      Referral-In Rejected Date  (CCYYMMDD)
ALHDT083  DIM       8      Referral-In Closed Date  (CCYYMMDD)
.
ALRIOKEY  DIM       27     Primary keycgi  to allrioaf records
ALRIO001  DIM       8      Visit Number
ALRIO002  DIM       8      Date of Change (ccyymmdd)
ALRIO003  DIM       8      Time of Change (hh:mm:ss)
ALRIO004  DIM       3      Referral In Outcome
OUTCARAY  DIM       63[20]
OUTCDESC  DIM       60
.
ACKNDATE  DIM       8
AUDITKEY  DIM       24      * Audit Key
BATCHNUM  DIM       20
CFILEPRE  DIM       3       * site prefix
CISMFLAG  FORM      1
CMDLINE   DIM       127
COUNTER   FORM      2
CURRDATE  DIM       8       * Current Date
DESCRTYP  DIM       12
DEPTCODE  DIM       3
D2A       DIM       2
D2B       DIM       2
D2C       DIM       2
D16       DIM       16
DIM3      DIM       3
DIM8      DIM       8
DIM12     DIM       12
DIM20     DIM       20
DIM42     DIM       42
DIM60     DIM       60
DISPDAT1  DIM       11                      * Display date
DOCTCODE  DIM       8
ENCOUTKY  DIM       16 
BFILNAME  DIM       20
CURGENCY  DIM       3
CONTDSET  DIM       3
CONTURNO  DIM       8
CONTTIME  DIM       8
CONTDATE  DIM       8
FILESTAT  DIM       35
FILTSTAT  DIM       2
FORCEFLG  FORM      1
FORM8     FORM      8 
FORM3     FORM      3 
HTMLLNK2  DIM       127
HTMLLNK3  DIM       127
IBAMFLAG  FORM      1
LOADDATE  DIM       8
LINKFLAG  FORM      1
MESSAGID  DIM       20
MESSGKEY  DIM       42
MBSDESC   DIM       70
NEXTPAGE  DIM       1       * Nextpage parameter CGI parameter
NMPNUMB   DIM       20
NXTDDATE  DATE      8
PRGMSTRM  FORM      1
PSAGETYP  DIM       3
PSAGECON  DIM       3
REFERLIN  FORM      1
REFSTAT   DIM       10
REFIRDEP  DIM       3
REFIRCOD  DIM       9
RFDTR001  DIM       9
RFDAT001  DIM       8
RFDPL001  DIM       9
SAVERDAT  DIM       8
SAVERIRD  DIM       3
SAVERIRS  DIM       9
SAVERRID  DIM       9
SAVFSTAT  DIM       1
SAVBSTAT  DIM       1
SAVEDATE  DIM       8
SAVKEY42  DIM       42
SAVKEY62  DIM       62
SAVEDESC  DIM       100
SERVFLAG  FORM      1 
SAVMSGKY  DIM       42
SAVEUDT1  DIM       8
SITECODE  DIM       6
STATUS    DIM       2
UPDTSTAT  DIM       1
UPDTTYPE  DIM       1       * Update Type
USACSTAT  DIM       2
VALDTYPE  FORM      1
VALDDATE  DIM       8
VISITNUM  DIM       8
.
. Init Vars
.
FILESTA0  INIT      "Extracted"
FILESTA1  INIT      "Submitted"
FILESTA2  INIT      "Rejected"
FILESTA3  INIT      "Accepted with rejections"
FILESTA4  INIT      "Accepted"
FILESTA5  INIT      "Rejections dealt with"
FILESTA6  INIT      "Purged"
.
BATCSTA0  INIT      "Extracted"
BATCSTA1  INIT      "Submitted"
BATCSTA2  INIT      "Rejected"
BATCSTA3  INIT      "Resubmitted"
BATCSTA4  INIT      "Accepted"
BATCSTA5  INIT      "Rejections resubmitted"
. 
LOWCASEZ  INIT      "z"
.
MESISTA0  INIT      "Waiting"
MESISTA1  INIT      "Ignore (printed error)"
MESISTA2  INIT      "Ignore (non VINAH record)"
MESISTA3  INIT      "Ignore (not required)"
MESISTA4  INIT      "Ignore (later message)"
MESISTA5  INIT      "Ignore (associated deletion)"
MESISTA6  INIT      "Extracted"
MESISTA7  INIT      "Submitted"
MESISTA8  INIT      "Rejected"
MESISTA9  INIT      "Resubmitted"
MESIST10  INIT      "Accepted"
MESIST99  INIT      "Removed"
.
ZERO1     INIT      "01"
ZERO2     INIT      "02"
ZERO3     INIT      "03"
ZERO4     INIT      "04"
ZERO6     INIT      "000000"
.
DIAGCODE  DIM       9
UNIQCODE  DIM       9
.
.----------------------------------------------------------------------
PRGID     INIT      "ALLWEB05"
VERSION   INIT      "V12.00.00"
PRGNAM    INIT      "Allied Health SAC Extract Maintenance"
.----------------------------------------------------------------------
.
          CALL      WEBINT00       * Initialise Fifo Etc.
          CALL      INIT0000       * Open Files
.
MAIN1000  CALL      WEBRED00       * Read Fifo WEBPID and USERID
.
          COMPARE   "999",REPORTNO * End Server Process on Report Option 999
          GOTO      MAIN9999 IF EQUAL
.
          CALL      OUTFIL00       * Check Correct Site Files Are Open
          BRANCH    EXIT,MAIN1000
.
          BRANCH    REPORTNO,MAIN1100,MAIN1200,MAIN1300,MAIN1400,MAIN1500:
                             MAIN1600,MAIN1700,MAIN1800
.
          PACK      WEBTITLE,PRGID,SP1,VERSION,SP1,PRGNAM,SP70
          MOVE      "Invalid Option",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          GOTO      MAIN1000
.
MAIN1100  CALL      SACF0000        * VINAH Filename Maintenance 
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1200  CALL      SACB0000        * VINAH Batch maintenance 
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1300  CALL      SACM0000        * VINAH Message Id Maintenance 
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1400  CALL      RBAT0000        * Validate Batch Remote Script
          GOTO      MAIN1000
.
MAIN1500  CALL      SACU0000        * VINAH Messages By U/R
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1600  CALL      ALLEVT00        * Update Referral/Enc and VINAH Details
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1700  CALL      RFIO0000        * Referral in outcome maintenance       
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1800  CALL      XMLD0000        * Validate VINAH date range data load
          GOTO      MAIN1000
.
MAIN9999  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      WEBERR00
          STOP
.------------------------------------------------------------
. Output Next Page Based on CGI Parameter nextpage
.------------------------------------------------------------
NXTPAG00  MOVE      ZERO,F1
          MOVE      NEXTPAGE,F1
          BRANCH    F1,NXTPAG10,NXTPAG20,NXTPAG30,NXTPAG40,NXTPAG50
.
          CALL      WINCLS00
          GOTO      NXTPAG99
.
NXTPAG10  CALL      RDIREC00
          GOTO      NXTPAG99
.
NXTPAG20  CALL      GOBACK00      * Go Back 1 Html page
          GOTO      NXTPAG99
.
NXTPAG30  CALL      DAH20000      * Go Back 2 html pages
          GOTO      NXTPAG99
.
NXTPAG40  CALL      PREDIR00      * Redirect Parent
          GOTO      NXTPAG99
.
NXTPAG50  CALL      SPCCLS00      * close window and reload parent.parent
          GOTO      NXTPAG99
.
NXTPAG99  RETURN
.------------------------------------------------------------------------------
.  Redirect Parent URL
.------------------------------------------------------------------------------
PREDIR00  CALL      OPENHTML
          BRANCH    EXIT,PREDIR90
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             " parent.location.href=#"",REDIRECT,"#";":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      PREDIR99
.
PREDIR90  DISPLAY   "*** Fifo Not Found ***"
.
PREDIR99  RETURN
.-------------------------------------------------------------------------------
.  Goes back 1 page
.-------------------------------------------------------------------------------
GOBACK00  CALL      OPENHTML
          BRANCH    EXIT,GOBACK99
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "    alert(#"",WEBTITLE,"#");":
                             "    self.close();":
                             "    opener.history.go(-1);":
                             "}":
                             "</script>"
          CALL      CLOSHTML
GOBACK99  RETURN
.------------------------------------------------------------
. Refresh Parent and Close Window
.------------------------------------------------------------
SPCCLS00  CALL      OPENHTML
          BRANCH    EXIT,SPCCLS99
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                               "src=#"../js/Standard.js#"></script>":
                               "<script type=#"text/javascript#" ":
                               "src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#"> {":
                             " if (self.name==#"PopUpFrame#") {":
                             "  reloadParentFrame();}":
                " else if (self.name==#"PopUpFrame1#") {":
                             "  reload3ParentFrame();}":
                             " else { ":
                             "  opener.history.go(0);":
                             "  self.close(); }":
                             "}":
                             "</script>"
          CALL      CLOSHTML     * End of Document
SPCCLS99  RETURN
.------------------------------------------------------------
. Open Files and Initialize Variables
.------------------------------------------------------------
INIT0000  OPEN      ALLAUDA1,"allaudaf"
          OPEN      ALLBIAA1,"allbiaaf"
          OPEN      ALLCASA1,"allcasaf"
          OPEN      ALLDEPA1,"alldepaf"
          OPEN      ALLHHDA1,"allhhdaf" 
          OPEN      ALLHHDA2,"allhhdaf" 
          OPEN      ALLHBTA1,"allhbtaf" 
          OPEN      ALLHBTA2,"allhbtaf" 
          OPEN      ALLHDTA1,"allhdtaf" 
          OPEN      ALLHDTA2,"allhdtaf" 
          OPEN      ALLHDTA3,"allhdtaf" 
          OPEN      ALLHDTA4,"allhdtaf" 
          OPEN      ALLSASA1,"allsasaf"
          OPEN      ALLITMA1,"allitmaf"
          OPEN      ALLDIAA1,"alldiaaf"
          OPEN      ALLDIAA2,"alldiaaf"
          OPEN      ALLENCA1,"allencaf"
          OPEN      ALLMDTA1,"allmdtaf"
          OPEN      ALLREFA1,"allrefaf"
          OPEN      ALLPROA1,"allproaf"
          OPEN      ALLPROA2,"allproaf"
          OPEN      ALLPRRA1,"allprraf"
          OPEN      ALLPRRA2,"allprraf"
          OPEN      ALLRIOA1,"allrioaf"
          OPEN      ALLRITA1,"allritaf"
          OPEN      ALLRLNA1,"allrlnaf"
          OPEN      ALLRLNA2,"allrlnaf"
          OPEN      ALLSEDA1,"allsedaf"
          OPEN      ALLSERA1,"allseraf"
          OPEN      ALLSERA2,"allseraf"
          OPEN      MLTSECA1,"mltsecaf"
          OPEN      MLTSITA1,"mltsitaf"
          OPEN      PMSHCLA1,"pmshclaf"
          OPEN      PMSHCPA1,"pmshcpaf"
          OPEN      PATDO1A1,"patdo1af"
          OPEN      PATCODE1,"patcodes"
          OPEN      PATCODE2,"patcodes"
          OPEN      PATFIMA1,"patfimaf"
          OPEN      PATHSPA1,"pathspaf"
          OPEN      PATMI1A8,"patmi1af"
.
          CALL      INTMAS00     * Open routine for PATMASTM
.
          OPEN      PATVISA2,"patvisaf"
          OPEN      PMSVX1A1,"pmsvx1af"
          OPEN      PATRE1A1,"patre1af"
          OPEN      PATDGWA1,"patdgwaf"
          OPEN      PATITEM1,"patitemn"
          OPEN      PATASFA1,"patasfaf"
          OPEN      PATDSCH1,"patdschf"
          OPEN      PATVADA1,"patvadaf"
          OPEN      PRIITEM1,"priitemf"
.
          OPEN      ALLRHLA1,"allrhlaf"
          OPEN      ALLRHLA2,"allrhlaf"         
.
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,HUND06;*27,ALCNRAUD,*28,ALCNEAUD,*183,ALCNEVTY
          READ      CONTROLF,HUND06;*57,ALCNSACO
          READ      CONTROLF,HUND26;*1,ALCNVURL
          SQUEEZE   ALCNSACO               * remove any trailing blanks        
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
            OPEN      MLTSECA1,"mltsecaf"
          ENDIF
.
          MATCH     "1",ALCNRAUD
          IF        @EQUAL
            OPEN      ALLAUDRE,"allaudre"
          ENDIF
.
          MATCH     "1",ALCNEAUD
          IF        @EQUAL
            OPEN      ALLAUDEN,"allauden"
            OPEN      ALLAUDEA,"allauden"
          ENDIF
.
          MOVE      "out",CFILEPRE
          OPEN      OUTSITA1,"outsitaf"
          OPEN      OUTSITA2,"outsitaf"
.
          CALL      OPNOUT00
          CALL      IOUTAR00
.
INIT9999  RETURN
.------------------------------------------------------------
. Clear Parameters
.------------------------------------------------------------
CLRPAR00  MOVE      ZERO,REPORTNO
          MOVE      SP70,TEMPLATE
          MOVE      SP70,NEXTPAGE
          MOVE      SP70,REDIRECT
          MOVE      SP70,UPDTTYPE
          MOVE      SP70,URNUMBER
          MOVE      SP70,ADMISSNO
          MOVE      SP70,FILTSTAT
          MOVE      SP70,BFILNAME
          MOVE      SP70,BATCHNUM
          MOVE      SP70,MESSGKEY
          MOVE      ZERO,VALDTYPE
          MOVE      SP70,DEPTCODE
          MOVE      Z70,UPDTSTAT
          MOVE      SP70,ENCOUTKY
          MOVE      SP70,RFDTR001
          MOVE      SP70,RFDAT001
          MOVE      SP70,RFDPL001
          MOVE      ZERO,FORCEFLG
          MOVE      SP70,VIEWTYPE
          MOVE      SP70,FRSTDATE
          MOVE      SP70,LASTDATE
          MOVE      SP70,VYEARMTH
          MOVE      SP70,ALRIOKEY
          MOVE      Z70,ALRIO001
          MOVE      Z70,ALRIO002
          MOVE      Z70,ALRIO003
          MOVE      Z70,ALRIO004
          MOVE      Z70,REFIRDEP
          MOVE      Z70,REFIRCOD
          MOVE      SP70,VALDDATE
.
          CALL      CPALHD00
          CALL      CPALRE00
          CALL      CPALEN00
.
CLRPAR99  RETURN
.------------------------------------------------------------
. Set Parameters
.------------------------------------------------------------
SETPAR00  MATCH     "reportno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REPORTNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "template=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TEMPLATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "deptcode=",QRYNAME
          IF        @EQUAL
            PACK      DEPTCODE,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updttype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDTTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "urnumber=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,URNUMBER
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admissno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMISSNO
            GOTO      SETPAR99
          ENDIF
.  
          MATCH     "nextpage=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTPAGE
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "redirect=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REDIRECT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtstat=",QRYNAME
          IF        @EQUAL
            PACK      FILTSTAT,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "bfilname=",QRYNAME
          IF        @EQUAL
            PACK      BFILNAME,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "batchnum=",QRYNAME
          IF        @EQUAL
            PACK      BATCHNUM,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "messgkey=",QRYNAME
          IF        @EQUAL
            PACK      MESSGKEY,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updtstat=",QRYNAME
          IF        @EQUAL
            PACK      UPDTSTAT,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "alhdt",QRYNAME
          IF        @EQUAL
            CALL      SPALHD00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "alref",QRYNAME
          IF        @EQUAL
            CALL      SPALR000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "alenc",QRYNAME
          IF        @EQUAL
            CALL      SPALE000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "encoutky=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ENCOUTKY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "diagcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DIAGCODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "uniqcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UNIQCODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "rfdtr001=",QRYNAME
          IF        @EQUAL
            PACK      RFDTR001,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "rfdpl001=",QRYNAME
          IF        @EQUAL
            PACK      RFDPL001,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "rfdat001=",QRYNAME
          IF        @EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00              * To Format Month
            PACK      RFDAT001,CCENT,CYEAR,CMON,CDAY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "forceflg=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FORCEFLG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "frstdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FRSTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "lastdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LASTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "vyearmth=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VYEARMTH
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "viewtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VIEWTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "alriokey=",QRYNAME
          IF        @EQUAL
            PACK      ALRIOKEY,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "alrio001=",QRYNAME
          IF        @EQUAL
            PACK      ALRIO001,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "alrio002=",QRYNAME
          IF        @EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00                *Set CMON from MTHNAM3
            PACK      ALRIO002,CCENT,CYEAR,CMON,CDAY,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "alrio003=",QRYNAME
          IF        @EQUAL
            PACK      ALRIO003,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "alrio004=",QRYNAME
          IF        @EQUAL
            PACK      ALRIO004,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "refirdep=",QRYNAME
          IF        @EQUAL
            PACK      REFIRDEP,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "refircod=",QRYNAME
          IF        @EQUAL
            PACK      REFIRCOD,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valddate=",QRYNAME
          IF        @EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00                *Set CMON from MTHNAM3
            PACK      VALDDATE,CCENT,CYEAR,CMON,CDAY,SP70
            GOTO      SETPAR99
          ENDIF
.
SETPAR99  RETURN
.
.------------------------------------------------------------
. VINAH Filename Maintenance 
.------------------------------------------------------------
SACF0000  MATCH     SP70,UPDTTYPE
          GOTO      SACF7000 IF EQUAL
.
          MATCH     ANSU,UPDTTYPE           * Update extract file
          GOTO      SACF1000 IF EQUAL
.
          GOTO      SACF9000
.
SACF1000  PACK      KEY20,BFILNAME,SP70
          CALL      RDALHHD1
          BRANCH    OVRCD,SACF9100
.
          MOVE      ALHHSTAT,SAVFSTAT       * Save the original file status
.
          MATCH     Z70,UPDTSTAT
          IF        !@EQUAL
            MOVE      UPDTSTAT,ALHHSTAT     * Extract file status
          ENDIF
.
          MATCH     ALHHSTAT,SAVFSTAT       * File status has not changed
          GOTO      SACF9200 IF EQUAL
.
          CALL      ESTA0000                * Perform status update edits
          BRANCH    EXIT,SACF9999
.
          CALL      UPALHHD1
.
          CALL      UBAT0000                * Perform status update
.
          MOVE      ZERO,EXIT
          GOTO      SACF9999
.
SACF7000  PACK      KEY20,BFILNAME,SP70
          CALL      RDALHHD1 
          IF        OVRCD=1
            CALL      CLALHH00
          ENDIF
.
          CALL      CURPER00   * Display Routine
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.
          CLEAR     WEBTITLE
          MOVE      "VINAH Filename Maintenance",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,SACF9999
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      SACF9999
.
SACF9000  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SACF9999
.
SACF9100  MOVE      "Invalid Extract File.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SACF9999
.
SACF9200  MOVE      "Invalid Update, File status has not changed.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SACF9999
.
SACF9999  RETURN
.
.------------------------------------------------------------
. VINAH Batch maintenance
.------------------------------------------------------------
SACB0000  MATCH     SP70,UPDTTYPE
          GOTO      SACB7000 IF EQUAL
.
          MATCH     ANSU,UPDTTYPE
          GOTO      SACB1000 IF EQUAL
.
          GOTO      SACB9000
.
SACB1000  PACK      KEY40,BFILNAME,BATCHNUM,SP70
          CALL      RDALHBT1
          BRANCH    OVRCD,SACB9100
.
          MOVE      ALHBSTAT,SAVBSTAT       * Save the original batch status
.
          MATCH     Z70,UPDTSTAT
          IF        !@EQUAL
            MOVE      UPDTSTAT,ALHBSTAT     * Update batch status
          ENDIF
.
          MATCH     ALHBSTAT,SAVBSTAT       * Batch status has not changed
          GOTO      SACB9200 IF EQUAL
.
          CALL      BEDT0000                * Perform status update edits
          BRANCH    EXIT,SACB9999
.
          CALL      UPALHBT1
.
          CALL      UMES0000                * Update message status for batch
.
          MOVE      ZERO,EXIT
          GOTO      SACB9999
.
SACB7000  PACK      KEY20,BFILNAME,SP70
          CALL      RDALHHD1
          IF        OVRCD=1
            CALL      CLALHH00
          ENDIF
.
          PACK      KEY40,BFILNAME,BATCHNUM,SP70
          CALL      RDALHBT1
          IF        OVRCD=1
            CALL      CLALHT00
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "VINAH Batch Maintenance",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,SACB9999
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      SACB9999
.
SACB9000  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SACB9999
.
SACB9100  MOVE      "Invalid Batch.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SACB9999
.
SACB9200  MOVE      "Invalid Update, Batch status has not changed.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SACB9999
.
SACB9999  RETURN
.
.------------------------------------------------------------
. VINAH Message Id Maintenance 
.------------------------------------------------------------
SACM0000  MATCH     SP70,UPDTTYPE
          GOTO      SACM7000 IF EQUAL
.
          MATCH     "U",UPDTTYPE            *  Update
          GOTO      SACM1000 IF EQUAL
.
          MATCH     "D",UPDTTYPE            *  Delete
          GOTO      SACM2000 IF EQUAL
.
          MATCH     "R",UPDTTYPE            *  Reset all errors 
          GOTO      SACM3000 IF EQUAL
.
          MATCH     "C",UPDTTYPE            *  Create allhdtaf record
          GOTO      SACM4000 IF EQUAL
.
          GOTO      SACM9000
.
.         Update formaction
.
SACM1000  PACK      KEY42,MESSGKEY,SP70
          CALL      RDALHDT1
          BRANCH    OVRCD,SACM9100
.
          CALL      MVALHD00                * Move cgi to file vars
.
          CALL      UPALHDT1
.
          MATCH     " 0",ALHDSTAT
          IF        @EQUAL
            CALL      DSED0000                 * Delete error records
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      SACM9999
.
.         Delete formaction
.
SACM2000  PACK      KEY42,MESSGKEY,SP70
          CALL      RDALHDT1
          BRANCH    OVRCD,SACM9100
.
          CALL      DEALHDT1
.
          CALL      DSED0000                   * Delete error records
.
          MOVE      ZERO,EXIT
          GOTO      SACM9999
.
.         Reset all errors  
.
SACM3000  CALL      RESE0000                     * Reset errors              
          GOTO      SACM9999
.
.         Create new allhdtaf referral in update record
.
SACM4000  PACK      KEY42,MESSGKEY,SP70
          CALL      RDALHDT1                * Read original episode 
          BRANCH    OVRCD,SACM9100          * referral message
.
          MOVE      ALHDURNO,URNUMBER       * Determine U/R number
.
          MOVE      " 0",DIM2               * Check for earlies waiting record
          MOVE      SP70,SAVEDATE
.
SACM4100  PACK      KEY42,DIM2,URNUMBER,SP70
          CALL      RSALHDT1
          CALL      RKALHDT1                * Check for first record
          BRANCH    OVRCD,SACM4200
.
          MATCH     DIM2,ALHDSTAT           * Waiting/Error
          GOTO      SACM4200 IF NOT EQUAL
.
          MATCH     URNUMBER,ALHDURNO       * Correct U/R
          GOTO      SACM4200 IF NOT EQUAL
.
          MATCH     SP70,SAVEDATE
          IF        @EQUAL
            UNPACK    ALHDDTTM,SAVEDATE     * Save earlies record date
          ENDIF
.
          MATCH     SAVEDATE,ALHDDTTM
          IF        @LESS
            UNPACK    ALHDDTTM,SAVEDATE     * Save earlies record date
          ENDIF
.
SACM4200  MATCH     " 0",DIM2               
          IF        @EQUAL
            MOVE      " 1",DIM2             * Check for earliest error record
            GOTO      SACM4100
          ENDIF
.
          PACK      KEY42,MESSGKEY,SP70
          CALL      RDALHDT1                * Read original episode
          BRANCH    OVRCD,SACM9100          * referral message
.
          PACK      KEY8,ALHDLINK,SP70
          CALL      RDALREF1                * Read latest referral in record
          BRANCH    OVRCD,SACM9300
.
.         Populate any fields here prior to Referral in RRI-I13 message creation
.
          PACK      ALHDSTAT,SP1,ZERO       * Message Status - Waiting
.
          MATCH     SP70,SAVEDATE           * Default message date if blank
          IF        @EQUAL
            UNPACK    ALHDDTTM,SAVEDATE
          ENDIF
          PACK      ALHDDTTM,SAVEDATE,ZERO6  * New referral in message date time
.
          MOVE      ALHDLINK,ALHDVISN       * Referral In Visit Number
          MOVE      SP70,ALHDCONT           * Clear Contact Identifier
          MOVE      SP70,ALHDBNUM           * Clear batch number
          MOVE      SP70,ALHDMESI           * Clear Message id
          MOVE      ZERO,ALHDRTYP           * Message Type - Referral-In
          MOVE      "C",ALHDACTN            * Action Type - Change
          MOVE      "1",ALHDVFLG            * VINAH Referral Flag - Referral in
          MOVE      "RRI-I13",ALHDMTYP      * Message Type Referral In Update
          MOVE      ZERO,ALHDSRCE           * Record Source - Load
          MOVE      ALREDEPT,ALHDDEPT       * Master Referral Department
          MOVE      USERID,ALHDWEBU         * Created by web user id
          MOVE      SP70,ALHDLINK           * Clear linked visit
.
.         We need to validate that the referral-in is for a valid VINAH
.         program using the department
.
          MATCH     SP3,ALHDDEPT                 * blank department ?
          GOTO      SACM9400 IF EQUAL            * yes - error
.
          PACK      KEY5,ANSC,ANSG,ALHDDEPT
          CALL      RDCODE1                      * department code on file ?
          BRANCH    OVRCD,SACM9500               * no - error
.
          MOVE      TCINDC8,ANS
          TYPE      ANS                          * indicator 8 numeric ?
          GOTO      SACM9600 IF EQUAL            * yes - error
.
          MATCH     "E",ANS
          IF        @EQUAL
            MOVE      TEN,ALHDPRGM               * HEN
            GOTO      SACM4300
          ENDIF
.
          MATCH     "L",ANS
          IF        @EQUAL
            MOVE      TEN1,ALHDPRGM               * TPN
            GOTO      SACM4300
          ENDIF
.
          MATCH     "D",ANS
          IF        @EQUAL
            MOVE      TEN2,ALHDPRGM               * HBD
            GOTO      SACM4300
          ENDIF
.
          MATCH     "V",ANS
          IF        @EQUAL
            MOVE      TEN3,ALHDPRGM               * VALP
            GOTO      SACM4300
          ENDIF
.
          MATCH     "C",ANS
          IF        @EQUAL
            MOVE      TEN4,ALHDPRGM               * EPC
            GOTO      SACM4300
          ENDIF
.
          MATCH     "F",ANS
          IF        @EQUAL
            MOVE      TEN5,ALHDPRGM               * IT
            GOTO      SACM4300
          ENDIF
.
          MOVE      ZERO,FORM1
          REP       "A5H2S7O8M3P4R6T9I1",ANS
          MOVE      ANS,FORM1
          COMPARE   ZERO,FORM1                   * VINAH program type ?
          GOTO      SACM9600 IF EQUAL            * yes - error
.
          MOVE      FORM1,ALHDPRGM               * load program type
.
SACM4300  MOVE      ALREUC35,ALHDCRST
          MOVE      ALREUC36,ALHDCAVL
          MOVE      ALREUC38,ALHDLARR
          MOVE      ALREUC39,ALHDUACC
          MOVE      ALREUC31,ALHDMREL
          MOVE      ALREUC10,ALHDDTHP
.
          MOVE      ALREDREC,ALHDRDAT
          MOVE      ALRESREJ,ALHDOTRR
          MOVE      ALRERCAN,ALHDOTRC
          MOVE      ALRESTAT,ALHDOUTC
          MOVE      ALREPRTY,ALHDCLUC
          MOVE      ALREUDT3,ALHDCRDT
          MOVE      ALREUDT5,ALHDRADT
.
          MOVE      SP8,ALHDSDAT
          MOVE      SP8,ALHDEDAT
          MOVE      SP1,ALHDFCFL
          MOVE      SP3,ALHDCPPT
          MOVE      SP8,ALHDIODT
          MOVE      SP8,ALHDACDD
          MOVE      SP8,ALHDCPDD
          MOVE      SP8,ALHDFABD
          MOVE      SP8,ALHDHDDT
          MOVE      SP8,ALHDFNAD
          MOVE      SP3,ALHDENDR
          MOVE      SP1,ALHDMFLG
          MOVE      SP6,ALHDCTYP
          MOVE      SP6,ALHDCLID
          MOVE      SP3,ALHDEEPR
          MOVE      SP8,ALHDUDT1
          MOVE      SP6,ALHDPSIT
.
          MOVE      SP3,ALHDCOMP
          MOVE      SP10,ALHDPGRP
          MOVE      SP10,ALHDPGR1
          MOVE      SP10,ALHDPGR2
          MOVE      SP10,ALHDPGR3
          MOVE      SP10,ALHDPGR4
          MOVE      SP8,ALHDDATE
          MOVE      SP8,ALHDTIME
          MOVE      SP3,ALHDPURP
          MOVE      SP3,ALHDSTYP
          MOVE      SP3,ALHDPRES
          MOVE      SP3,ALHDDMOD
          MOVE      SP3,ALHDDSET
          MOVE      SP3,ALHDPOFC
          MOVE      SP3,ALHDPDPL
          MOVE      SP3,ALHDCMOD
          MOVE      SP8,ALHDIFLG
          MOVE      SP10,ALHDSPCP
          MOVE      SP3,ALHDCSET
          MOVE      SP3,ALHDCEPR
.
          MOVE      SP8,ALHDRODT
          MOVE      SP9,ALHDSERT
          MOVE      SP9,ALHDPLAC
          MOVE      SP3,ALHDRCNT
.
          MOVE      SP70,ALHDRSTA
.
          PACK      KEY42,ALHDSTAT,ALHDURNO,ALHDVISN,ALHDCONT:
                          ALHDDTTM,ALHDRTYP,ALHDACTN,SP70
          CALL      RAALHDT1                * Check New record doesn't exits
          COMPARE   ONE,OVRCD         
          GOTO      SACM9200 IF NOT EQUAL
.
          CALL      WRALHDT1                * Write new RRI-I13 message record
.
          MOVE      ZERO,EXIT
          GOTO      SACM9999
.
SACM7000  PACK      KEY20,BFILNAME,SP70
          CALL      RDALHHD1
          IF        OVRCD=1
            CALL      CLALHH00
          ENDIF
.
          PACK      KEY40,BFILNAME,BATCHNUM,SP70
          CALL      RDALHBT1
          IF        OVRCD=1
            CALL      CLALHT00
          ENDIF
.
          PACK      KEY42,MESSGKEY,SP70
          CALL      RDALHDT1
          IF        OVRCD=1
            CALL      CLALHD00
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "VINAH Message Maintenance",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,SACM9999
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      SACM9999
.
SACM9000  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SACM9999
.
SACM9100  MOVE      "Invalid message record.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SACM9999
.
SACM9200  MOVE      "Message type already exits in this batch.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SACM9999
.
SACM9300  MOVE      "Invalid referral record.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SACM9999
.
SACM9400  MOVE      "Master referral department is blank.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SACM9999
.
SACM9500  MOVE      "Invalid Master referral department code.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SACM9999
.
SACM9600  MOVE      "Master referral is not a VINAH referral.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SACM9999
.
SACM9999  RETURN
.------------------------------------------------------------
. Process Fields 
.------------------------------------------------------------
PROFLD00  BRANCH    REPORTNO,PROFLD10,PROFLD20,PROFLD30,PROFLD99,PROFLD50:
                             PROFLD60,PROFLD70
.
          GOTO      PROFLD99 
.
PROFLD10  BRANCH    FLDSETNO,PROFLD11
          GOTO      PROFLD99
.
PROFLD11  CALL      TAGF0000                * File tags
          GOTO      PROFLD99
.
PROFLD20  BRANCH    FLDSETNO,PROFLD21,PROFLD22
          GOTO      PROFLD99
.
PROFLD21  CALL      TAGF0000                * File tags
          GOTO      PROFLD99
.
PROFLD22  CALL      TAGB0000                * batch tags
          GOTO      PROFLD99
.
PROFLD30  BRANCH    FLDSETNO,PROFLD31,PROFLD32,PROFLD33,PROFLD34,PROFLD35:
                             PROFLD36
          GOTO      PROFLD99
.
PROFLD31  CALL      TAGF0000                * File tags
          GOTO      PROFLD99
.
PROFLD32  CALL      TAGB0000                * batch tags
          GOTO      PROFLD99
.
PROFLD33  CALL      TAGM0000                * message id lists
          GOTO      PROFLD99
.
PROFLD34  CALL      ALHD0000                * message id tags
          GOTO      PROFLD99
.
PROFLD35  CALL      ALRE0000
          GOTO      PROFLD99
.
PROFLD36  CALL      GTAG0000
          GOTO      PROFLD99
.
PROFLD50  BRANCH    FLDSETNO,PROFLD51,PROFLD52
          GOTO      PROFLD99
.
PROFLD51  CALL      MASF0000                * Patient Master File
          GOTO      PROFLD99
.
PROFLD52  CALL      TAGM0000                * message id lists
          GOTO      PROFLD99
.
PROFLD60  BRANCH    FLDSETNO,PROFLD61,PROFLD62,PROFLD63,PROFLD64,PROFLD65
          GOTO      PROFLD99
.
PROFLD61  CALL      MASF0000
          GOTO      PROFLD99
.
PROFLD62  CALL      ALRE0000                * Patient Referral Details
          GOTO      PROFLD99
.
PROFLD63  CALL      ALEN0000                * Patient Enc Details
          GOTO      PROFLD99
.
PROFLD64  CALL      GTAG0000                * General Tags
          GOTO      PROFLD99
.
PROFLD65  CALL      ALRH0000
          GOTO      PROFLD99
.
PROFLD70  BRANCH    FLDSETNO,PROFLD71,PROFLD72,PROFLD73
          GOTO      PROFLD99
.
PROFLD71  CALL      MASF0000
          GOTO      PROFLD99
.
PROFLD72  CALL      ALRE0000                * Patient Referral Details
          GOTO      PROFLD99
.
PROFLD73  CALL      GTAG0000                * General Tags
          GOTO      PROFLD99
.
PROFLD99  RETURN
.
.------------------------------------------------------------
. VINAH file tags
.------------------------------------------------------------
TAGF0000  BRANCH    FLDITMNO,TAGF0010,TAGF0020,TAGF0030,TAGF0040,TAGF0050:
                             TAGF0060,TAGF0070,TAGF0080,TAGF0090,TAGF0100:
                             TAGF0110,TAGF0120
.
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      TAGF9999
.
TAGF0010  CALL      TABF0000                * Table of VINAH files
          GOTO      TAGF9999
.
TAGF0020  WRITE     HTMLFILE;FILTSTAT;
          GOTO      TAGF9999
.
TAGF0030  WRITE     HTMLFILE;BFILNAME;
          GOTO      TAGF9999
.
TAGF0040  WRITE     HTMLFILE;ALHHFNAM;
          GOTO      TAGF9999
.
TAGF0050  MATCH     ALHHSDAT,SP70
          GOTO      TAGF9999 IF EQUAL
.
          UNPACK    ALHHSDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      TAGF9999
.
TAGF0060  MATCH     ALHHEDAT,SP70
          GOTO      TAGF9999 IF EQUAL
.
          UNPACK    ALHHEDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      TAGF9999
.
TAGF0070  CALL      FSTA0000                * Get file status
          WRITE     HTMLFILE;FILESTAT;
          GOTO      TAGF9999
.
TAGF0080  WRITE     HTMLFILE;ALHHSTAT;
          GOTO      TAGF9999
.
TAGF0090  CALL      NEXT0000
          GOTO      TAGF9999
.
TAGF0100  CALL      PREV0000
          GOTO      TAGF9999
.
TAGF0110  CALL      SELV0000
          GOTO      TAGF9999
.
TAGF0120  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      TAGF9999
.
TAGF9999  RETURN
.
.-----------------------------------------------------------------------------.
. Next Day, Week, Month                                                       .
.-----------------------------------------------------------------------------.
NEXT0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
.
          REP       " +",FILTSTAT
.
          WRITE     HTMLFILE;"allweb05.pbl":
                             "?reportno=",KEY2:
                             "&template=",KEY3:
                             "&frstdate=",NXTFDATE:
                             "&lastdate=",NXTLDATE:
                             "&viewtype=",VIEWTYPE:
                             "&filtstat=",FILTSTAT;
.
          REP       "+ ",FILTSTAT
.
NEXT9999  RETURN
.
.-----------------------------------------------------------------------------.
. Previous Day, Week, Month                                                   .
.-----------------------------------------------------------------------------.
PREV0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
.
          REP       " +",FILTSTAT
.
          WRITE     HTMLFILE;"allweb05.pbl":
                             "?reportno=",KEY2:
                             "&template=",KEY3:
                             "&frstdate=",PREFDATE:
                             "&lastdate=",PRELDATE:
                             "&viewtype=",VIEWTYPE:
                             "&filtstat=",FILTSTAT;
.
          REP       "+ ",FILTSTAT
.
PREV9999  RETURN
.
.------------------------------------------------------------
. VINAH file tags
.------------------------------------------------------------
ALHD0000  BRANCH    FLDITMNO,ALHD0010,ALHD0020,ALHD0030,ALHD0040,ALHD0050:
                             ALHD0060,ALHD0070,ALHD0080,ALHD0090,ALHD0100:
                             ALHD0110,ALHD0120,ALHD0130,ALHD0140,ALHD0150:
                             ALHD0160,ALHD0170,ALHD0180,ALHD0190,ALHD0200:
                             ALHD0210,ALHD0220,ALHD0230,ALHD0240,ALHD0250:
                             ALHD0260,ALHD0270,ALHD0280,ALHD0290,ALHD0300:
                             ALHD0310,ALHD0320,ALHD0330,ALHD0340,ALHD0350:
                             ALHD0360,ALHD0370,ALHD0380,ALHD0390,ALHD0400:
                             ALHD0410,ALHD0420,ALHD0430,ALHD0440,ALHD0450:
                             ALHD0460,ALHD0470,ALHD0480,ALHD0490,ALHD0500:
                             ALHD0510,ALHD0520,ALHD0530,ALHD0540,ALHD0550:
                             ALHD0560,ALHD0570,ALHD0580,ALHD0590,ALHD0600:
                             ALHD0610,ALHD0620,ALHD0630,ALHD0640,ALHD0650:
                             ALHD0660,ALHD0670,ALHD0680,ALHD0690,ALHD0700:
                             ALHD0710,ALHD0720,ALHD0730,ALHD0740,ALHD0750:
                             ALHD0760,ALHD0770,ALHD0780,ALHD0790,ALHD0800:
                             ALHD0810,ALHD0820,ALHD0830,ALHD0840,ALHD0850
.
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      ALHD9999
.
ALHD0010  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,ALHD0011
.
          WRITE     HTMLFILE;ALHDSTAT;           * Record Status
          GOTO      ALHD9999
.
ALHD0011  CALL      FSTM0000
          WRITE     HTMLFILE;FILESTAT;
          GOTO      ALHD9999
.
ALHD0020  WRITE     HTMLFILE;ALHDURNO;           * Patient Identifier (alreurno)
          GOTO      ALHD9999
.
ALHD0030  UNPACK    DIM127,D1,KEY1,DIM127        * Date/Time Created
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,ALHD0031,ALHD0032
.
          WRITE     HTMLFILE;ALHDDTTM;
          GOTO      ALHD9999
.
ALHD0031  UNPACK    ALHDDTTM,D8
          MATCH     D8,SP70                      * Created Date
          GOTO      ALHD9999 IF EQUAL
.
          UNPACK    D8,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      ALHD9999
.
ALHD0032  UNPACK    ALHDDTTM,D8,D2A,D2B,D2C

          MATCH     D2A,SP70                      * Time Created
          GOTO      ALHD9999 IF EQUAL
.
          WRITE     HTMLFILE;D2A,COLON,D2B,COLON,D2C;
          GOTO      ALHD9999
.
ALHD0040  WRITE     HTMLFILE;ALHDVISN;  * Episode Identifier (alrevisn/alenvisn)
          GOTO      ALHD9999
.
ALHD0050  WRITE     HTMLFILE;ALHDCONT;  * Contact Identifier (alenenct)    
          GOTO      ALHD9999
.
ALHD0060  WRITE     HTMLFILE;ALHDBNUM;  * Batch Number
          GOTO      ALHD9999
.
ALHD0070  WRITE     HTMLFILE;ALHDMESI;  * Message Id (from MSH-10)
          GOTO      ALHD9999
.
ALHD0080  UNPACK    DIM127,D1,KEY1,DIM127        * Record Type
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,ALHD0081
.
          WRITE     HTMLFILE;ALHDRTYP;
          GOTO      ALHD9999
.
ALHD0081  MATCH     "0",ALHDRTYP
          IF        @EQUAL
            WRITE     HTMLFILE;"Referral-In";
          ENDIF
.
          MATCH     "1",ALHDRTYP
          IF        @EQUAL
            WRITE     HTMLFILE;"Episode";
          ENDIF
.
          MATCH     "2",ALHDRTYP
          IF        @EQUAL
            WRITE     HTMLFILE;"Contact";
          ENDIF
.
          MATCH     "3",ALHDRTYP
          IF        @EQUAL
            WRITE     HTMLFILE;"Merge";
          ENDIF
.
          MATCH     "4",ALHDRTYP
          IF        @EQUAL
            WRITE     HTMLFILE;"PMI";
          ENDIF
.
          MATCH     "5",ALHDRTYP
          IF        @EQUAL
            WRITE     HTMLFILE;"Referral-Out";
          ENDIF
          GOTO      ALHD9999
.
ALHD0090  UNPACK    DIM127,D1,KEY1,DIM127        * Action Type
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,ALHD0091
.
          WRITE     HTMLFILE;ALHDACTN;
          GOTO      ALHD9999
.
ALHD0091  MATCH     "A",ALHDACTN
          IF        @EQUAL
            WRITE     HTMLFILE;"Addition";
          ENDIF
.
          MATCH     "C",ALHDACTN
          IF        @EQUAL
            WRITE     HTMLFILE;"Change";
          ENDIF
.
          MATCH     "D",ALHDACTN
          IF        @EQUAL
            WRITE     HTMLFILE;"Deletion";
          ENDIF
.
          GOTO      ALHD9999
.

ALHD0100  WRITE     HTMLFILE;ALHDVFLG;           * VINAH Referral Flag
          GOTO      ALHD9999
.
ALHD0110  WRITE     HTMLFILE;ALHDMTYP;           * Message Type
          GOTO      ALHD9999
.
ALHD0120  UNPACK    DIM127,D1,KEY1,DIM127        * Record Source
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,ALHD0121

          WRITE     HTMLFILE;ALHDSRCE;
          GOTO      ALHD9999
.
ALHD0121  COMPARE   ZERO,ALHDSRCE
          IF        @EQUAL
            WRITE    HTMLFILE;"LDALLHDT";
          ENDIF
.
          COMPARE   ONE,ALHDSRCE
          IF        @EQUAL
            WRITE    HTMLFILE;"VINAHEXT";
          ENDIF
.
          GOTO      ALHD9999
.
ALHD0130  MOVE      "CG",CATEGORY      * Department (alldepaf.alredept)
          MOVE      ALHDDEPT,CODE
          CALL      CODITM00
          GOTO      ALHD9999
.
ALHD0140  UNPACK    DIM127,D1,KEY1,DIM127        * Program Type
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,ALHD0141
.
          WRITE     HTMLFILE;ALHDPRGM;
          GOTO      ALHD9999
.
ALHD0141  IF        ALHDPRGM=1
            WRITE     HTMLFILE;"HARP";
          ENDIF
.
          IF        ALHDPRGM=2
            WRITE     HTMLFILE;"HBPCCT";
          ENDIF
.
          IF        ALHDPRGM=3
            WRITE     HTMLFILE;"Medi-Hotel";
          ENDIF
.
          IF        ALHDPRGM=4
            WRITE     HTMLFILE;"Palliative Care";
          ENDIF
.
          IF        ALHDPRGM=5
            WRITE     HTMLFILE;"Post Acute Care";
          ENDIF
.
          IF        ALHDPRGM=6
            WRITE     HTMLFILE;"RIR";
          ENDIF
.
          IF        ALHDPRGM=7
            WRITE     HTMLFILE;"SACS";
          ENDIF
.
          IF        ALHDPRGM=8
            WRITE     HTMLFILE;"Specialist OP";
          ENDIF
.
          IF        ALHDPRGM=9
            WRITE     HTMLFILE;"TCP";
          ENDIF
.
          IF        ALHDPRGM=10
            WRITE     HTMLFILE;"HEN";
          ENDIF
.
          IF        ALHDPRGM=11
            WRITE     HTMLFILE;"TPN";
          ENDIF
.
          IF        ALHDPRGM=12
            WRITE     HTMLFILE;"HBD";
          ENDIF
.
          IF        ALHDPRGM=13
            WRITE     HTMLFILE;"VALP";
          ENDIF
.
          IF        ALHDPRGM=14
            WRITE     HTMLFILE;"EPC";
          ENDIF
.
          IF        ALHDPRGM=15
            WRITE     HTMLFILE;"IT";
          ENDIF
.
          GOTO      ALHD9999
.
ALHD0150  MATCH     SP70,ALHDWEBU                * Web User Id
          GOTO      ALHD9999 IF EQUAL
.
          PACK      KEY10,ALHDWEBU,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      ALHDWEBU,WBSENAM
          ENDIF
          WRITE     HTMLFILE;WBSENAM;
          GOTO      ALHD9999
.
ALHD0160  MOVE      "lI",CATEGORY                * Carer Residency Status
          MOVE      ALHDCRST,CODE
          CALL      CODITM00
          GOTO      ALHD9999
.
ALHD0170  MOVE      "lJ",CATEGORY                * Carer Availability
          MOVE      ALHDCAVL,CODE
          CALL      CODITM00
          GOTO      ALHD9999
.
ALHD0180  MOVE      "lL",CATEGORY                * Living Arrangement
          MOVE      ALHDLARR,CODE
          CALL      CODITM00
          GOTO      ALHD9999
.
ALHD0190  MOVE      "lM",CATEGORY                * Usual Accommodation
          MOVE      ALHDUACC,CODE
          CALL      CODITM00
          GOTO      ALHD9999
.
ALHD0200  MOVE      "lE",CATEGORY                * Main Carer's Rel. to Patient
          MOVE      ALHDMREL,CODE
          CALL      CODITM00
          GOTO      ALHD9999
.
ALHD0210  MOVE      "lj",CATEGORY                * Death Place                 
          MOVE      ALHDDTHP,CODE
          CALL      CODITM00
          GOTO      ALHD9999
.
ALHD0220  WRITE     HTMLFILE;ALHDOURN;           * Old U/R number
          GOTO      ALHD9999
.
ALHD0230  MATCH     ALHDRDAT,SP70               * Episode Start/Referral In Date
          GOTO      ALHD9999 IF EQUAL
.
          UNPACK    ALHDRDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      ALHD9999
.
ALHD0240  MOVE      "rr",CATEGORY                * Ref.-In Outcome Reason
          MOVE      ALHDOTRR,CODE
          CALL      CODITM00
          GOTO      ALHD9999
.
ALHD0250  MOVE      "LN",CATEGORY                * Ref.-In Outcome Cancellation
          MOVE      ALHDOTRC,CODE
          CALL      CODITM00
          GOTO      ALHD9999
.
ALHD0260  UNPACK    DIM127,D1,KEY1,DIM127        * Referral In Outcome
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,ALHD0261
.
          WRITE     HTMLFILE;ALHDOUTC;
          GOTO      ALHD9999
.
ALHD0261  MATCH     "0",ALHDOUTC
          IF        @EQUAL
            WRITE     HTMLFILE;"Waiting";
            GOTO      ALHD9999
          ENDIF
.
          MATCH     "1",ALHDOUTC
          IF        @EQUAL
            WRITE     HTMLFILE;"Active";
            GOTO      ALHD9999
          ENDIF
.
          MATCH     "2",ALHDOUTC
          IF        @EQUAL
            WRITE     HTMLFILE;"Closed";
            GOTO      ALHD9999
          ENDIF
.
          MATCH     "3",ALHDOUTC
          IF        @EQUAL
            WRITE     HTMLFILE;"Inactive";
            GOTO      ALHD9999
          ENDIF
.
          MATCH     "4",ALHDOUTC
          IF        @EQUAL
            WRITE     HTMLFILE;"Cancelled";
            GOTO      ALHD9999
          ENDIF
.
          MATCH     "5",ALHDOUTC
          IF        @EQUAL
            WRITE     HTMLFILE;"Rejected";
            GOTO      ALHD9999
          ENDIF
.
          GOTO      ALHD9999
.
ALHD0270  MOVE      "PR",CATEGORY                * Ref.-In Clinical Urgency
          MOVE      ALHDCLUC,CODE
          CALL      CODITM00
          GOTO      ALHD9999
.
ALHD0280  MATCH     ALHDCRDT,SP70                * Ref.-In Clinical ref date    
          GOTO      ALHD9999 IF EQUAL
.
          UNPACK    ALHDCRDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      ALHD9999
.
ALHD0290  MATCH     ALHDRADT,SP70                * Ref-In Rec. Ackn. Date
          GOTO      ALHD9999 IF EQUAL
.
          UNPACK    ALHDRADT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      ALHD9999
.
ALHD0300  WRITE     HTMLFILE;ALHDLINK;           * Linked ref visit number
          GOTO      ALHD9999
.
ALHD0310  MATCH     ALHDSDAT,SP70                * Episode Start Date
          GOTO      ALHD9999 IF EQUAL
.
          UNPACK    ALHDSDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      ALHD9999
.
ALHD0320  MATCH     ALHDEDAT,SP70                * Episode End/Referral Out Date
          GOTO      ALHD9999 IF EQUAL
.
          UNPACK    ALHDEDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      ALHD9999
.
ALHD0330  WRITE     HTMLFILE;ALHDFCFL;           * Episode First Cons. Flag
          GOTO      ALHD9999
.
ALHD0340  MOVE      "lG",CATEGORY                * Completion Proposed Program
          MOVE      ALHDCPPT,CODE
          CALL      CODITM00
          GOTO      ALHD9999
.
ALHD0350  MATCH     ALHDIODT,SP70               * Episode Imp. Onset Date
          GOTO      ALHD9999 IF EQUAL
.
          UNPACK    ALHDIODT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      ALHD9999
.
ALHD0360  MATCH     ALHDACDD,SP70               * Episode Adv. Care Plan Date
          GOTO      ALHD9999 IF EQUAL
.
          UNPACK    ALHDACDD,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      ALHD9999
.
ALHD0370  MATCH     ALHDCPDD,SP70               * Episode Care Plan Documented
          GOTO      ALHD9999 IF EQUAL
.
          UNPACK    ALHDCPDD,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      ALHD9999
.
ALHD0380  MATCH     ALHDFABD,SP70               * Episode First Appt Booked
          GOTO      ALHD9999 IF EQUAL
.
          UNPACK    ALHDFABD,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      ALHD9999
.
ALHD0390  MATCH     ALHDHDDT,SP70               * Episode Hospital Discharge   
          GOTO      ALHD9999 IF EQUAL           * Date 
.
          UNPACK    ALHDHDDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      ALHD9999
.
ALHD0400  MATCH     ALHDFNAD,SP70               * Episode Patient First       
          GOTO      ALHD9999 IF EQUAL           * Notified
.
          UNPACK    ALHDFNAD,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      ALHD9999
.
ALHD0410  MOVE      "LL",CATEGORY                * Episode Program Stream
          MOVE      ALHDENDR,CODE
          CALL      CODITM00
          GOTO      ALHD9999
.
ALHD0420  WRITE     HTMLFILE;ALHDMFLG;           * Malignancy Flag
          GOTO      ALHD9999
.
ALHD0430  UNPACK    DIM127,D1,KEY1,DIM127        * Clinic Type
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,ALHD0431,ALHD0432
.
          PACK      KEY12,WBSESIT,ALHDCTYP,SP70
          CALL      RDCTYA1
          BRANCH    OVRCD,ALHD9999
          WRITE     HTMLFILE;OCTDESC;
          GOTO      ALHD9999
.
ALHD0431  WRITE     HTMLFILE;ALHDCTYP;
          GOTO      ALHD9999
.
ALHD0432  CALL      HDTCTY00                  
          GOTO      ALHD9999
.
ALHD0440  MOVE      "zG",CATEGORY                * Episode Event Program
          MOVE      ALHDEEPR,CODE
          CALL      CODITM00
          GOTO      ALHD9999
.
ALHD0450  MOVE      "CL",CATEGORY                * Contact Account Class
          MOVE      ALHDCOMP,CODE
          CALL      CODITM00
          GOTO      ALHD9999
.
ALHD0460  UNPACK    DIM127,D1,KEY1,DIM127        * Contact Prof. Group 0
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,ALHD0461
.
          PACK      KEY10,ALHDPGRP,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,ALHD9999
          MOVE      PMHCTITL,FMTTITLE
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000
.
          WRITE     HTMLFILE;DOCFNAME;
          GOTO      ALHD9999
.
ALHD0461  WRITE     HTMLFILE;ALHDPGRP;
          GOTO      ALHD9999
.
ALHD0470  UNPACK    DIM127,D1,KEY1,DIM127           * Contact Prof. Group 1
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,ALHD0471
.
          PACK      KEY10,ALHDPGR1,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,ALHD9999
          MOVE      PMHCTITL,FMTTITLE
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000
.
          WRITE     HTMLFILE;DOCFNAME;
          GOTO      ALHD9999
.
ALHD0471  WRITE     HTMLFILE;ALHDPGR1;
          GOTO      ALHD9999
.
ALHD0480  UNPACK    DIM127,D1,KEY1,DIM127        * Contact Prof. Group 2
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,ALHD0481
.
          PACK      KEY10,ALHDPGR2,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,ALHD9999
          MOVE      PMHCTITL,FMTTITLE
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000
.
          WRITE     HTMLFILE;DOCFNAME;
          GOTO      ALHD9999
.
ALHD0481  WRITE     HTMLFILE;ALHDPGR2;
          GOTO      ALHD9999
.
ALHD0490  UNPACK    DIM127,D1,KEY1,DIM127        * Contact Prof. Group 3
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,ALHD0491
.
          PACK      KEY10,ALHDPGR3,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,ALHD9999
          MOVE      PMHCTITL,FMTTITLE
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000
.
          WRITE     HTMLFILE;DOCFNAME;
          GOTO      ALHD9999
.
ALHD0491  WRITE     HTMLFILE;ALHDPGR3;
          GOTO      ALHD9999
.
ALHD0500  UNPACK    DIM127,D1,KEY1,DIM127        * Contact Prof. Group 4
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,ALHD0501
.
          PACK      KEY10,ALHDPGR4,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,ALHD9999
          MOVE      PMHCTITL,FMTTITLE
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000
.
          WRITE     HTMLFILE;DOCFNAME;
          GOTO      ALHD9999
.
ALHD0501  WRITE     HTMLFILE;ALHDPGR4;
          GOTO      ALHD9999
.
ALHD0510  MATCH     ALHDDATE,SP70                * Contact Date   
          GOTO      ALHD9999 IF EQUAL
.
          UNPACK    ALHDDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      ALHD9999
.
ALHD0520  WRITE     HTMLFILE;ALHDTIME;
          GOTO      ALHD9999
.
ALHD0530  MOVE      "zH",CATEGORY                * Contact Main Purpose
          MOVE      ALHDPURP,CODE
          CALL      CODITM00
          GOTO      ALHD9999
.
ALHD0540  MOVE      "zI",CATEGORY                * Contact Session Type
          MOVE      ALHDSTYP,CODE
          CALL      CODITM00
          GOTO      ALHD9999
.
ALHD0550  MOVE      "zK",CATEGORY                * Client Present Status
          MOVE      ALHDPRES,CODE
          CALL      CODITM00
          GOTO      ALHD9999
.
ALHD0560  MOVE      "zL",CATEGORY                * Contact Delivery Mode
          MOVE      ALHDDMOD,CODE
          CALL      CODITM00
          GOTO      ALHD9999
.
ALHD0570  MOVE      "zN",CATEGORY                * Contact Delivery Setting
          MOVE      ALHDDSET,CODE
          CALL      CODITM00
          GOTO      ALHD9999
.
ALHD0580  MOVE      "zE",CATEGORY                * Contact Phase of Care
          MOVE      ALHDPOFC,CODE
          CALL      CODITM00
          GOTO      ALHD9999
.
ALHD0590  MOVE      "zh",CATEGORY                * Contact Pref death place
          MOVE      ALHDPDPL,CODE
          CALL      CODITM00
          GOTO      ALHD9999
.
ALHD0600  MOVE      "zf",CATEGORY                * Contact Care Model
          MOVE      ALHDCMOD,CODE
          CALL      CODITM00
          GOTO      ALHD9999
.
ALHD0610  MATCH     SP70,ALHDIFLG
          GOTO      ALHD9999 IF EQUAL
.
          WRITE     HTMLFILE;ALHDIFLG             * Contact IP Flag
          GOTO      ALHD9999
.
ALHD0620  UNPACK    DIM127,D1,KEY1,DIM127        * Contact Specialist Palliative
          MOVE      ZERO,F1                      * Care Provider
          MOVE      KEY1,F1
          BRANCH    F1,ALHD0621
.
          PACK      KEY10,ALHDSPCP,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,ALHD9999
          MOVE      PMHCTITL,FMTTITLE
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000
.
          WRITE     HTMLFILE;DOCFNAME;
          GOTO      ALHD9999
.
ALHD0621  WRITE     HTMLFILE;ALHDSPCP;
          GOTO      ALHD9999
.
ALHD0630  MOVE      "zg",CATEGORY                * Contact preferred care   
          MOVE      ALHDCSET,CODE                * setting
          CALL      CODITM00
          GOTO      ALHD9999
.
ALHD0640  MOVE      "zG",CATEGORY                * Contact event program    
          MOVE      ALHDCEPR,CODE     
          CALL      CODITM00
          GOTO      ALHD9999
.
ALHD0650  MATCH     ALHDRODT,SP70                * Referral out date
          GOTO      ALHD9999 IF EQUAL
.
          UNPACK    ALHDRODT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      ALHD9999
.
ALHD0660  MOVE      "zU",CATEGORY                * Referral out service type
          MOVE      ALHDSERT,CODE
          CALL      CODITM00
          GOTO      ALHD9999
.
ALHD0670  MOVE      "zV",CATEGORY                * Referral out place 
          MOVE      ALHDPLAC,CODE
          CALL      CODITM00
          GOTO      ALHD9999
.
ALHD0680  WRITE     HTMLFILE;ALHDRCNT;           * Referral Destination Count
          GOTO      ALHD9999
.
ALHD0690  UNPACK    DIM127,D1,KEY1,DIM127        * Outpatient Site
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,ALHD0691,ALHD0692
.
          PACK      KEY6,ALHDPSIT,SP70
          CALL      RDSITA1                      * Read Site Code File
          BRANCH    OVRCD,ALHD9999
          WRITE     HTMLFILE;OSTDESC;            * Descprition
          GOTO      ALHD9999
.
ALHD0691  WRITE     HTMLFILE;ALHDPSIT;           * Code
          GOTO      ALHD9999
.
ALHD0692  MOVE      ALHDPSIT,SITECODE
          CALL      SLSITE00                     * Options
          GOTO      ALHD9999
.
ALHD0700  MATCH     ALHDUDT1,SP70                * User Def. Date 1 (CCYYMMDD)
          GOTO      ALHD9999 IF EQUAL
.
          UNPACK    ALHDUDT1,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      ALHD9999
.
ALHD0710  MOVE      "ts",CATEGORY                * Referral-In Triage Status
          MOVE      ALHDTRGS,CODE
          CALL      CODITM00
          GOTO      ALHD9999
.
ALHD0720  MATCH     ALHDTRGD,SP70                * Referral-In Triage Date
          GOTO      ALHD9999 IF EQUAL
.
          UNPACK    ALHDTRGD,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      ALHD9999
.
ALHD0730  MATCH     ALHDUDT2,SP70                * Episode Patient rfC Date
          GOTO      ALHD9999 IF EQUAL
.
          UNPACK    ALHDUDT2,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      ALHD9999
.
ALHD0740  MATCH     ALHDCEDT,SP70                * Contact End Date
          GOTO      ALHD9999 IF EQUAL
.
          UNPACK    ALHDCEDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      ALHD9999
.
ALHD0750  WRITE     HTMLFILE;ALHDCETM;           * Contact End Time 
          GOTO      ALHD9999
.
ALHD0760  MOVE      "CG",CATEGORY                * Contact Service Dept(Cat CG)
          MOVE      ALHDSDEP,CODE
          CALL      CODITM00
          GOTO      ALHD9999
.
ALHD0770  WRITE     HTMLFILE;ALHDRSTA;       * Contact Record Status (alenrsta)
          GOTO      ALHD9999
.
ALHD0780  MATCH     ALHDDCAN,SP70                * Referral In Cancellation 
          GOTO      ALHD9999 IF EQUAL            * Date
.
          UNPACK    ALHDDCAN,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      ALHD9999
.
ALHD0790  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1                 * Referral In reason Department
          MOVE      KEY1,F1
          BRANCH    F1,ALHD0791,ALHD0792
.
          MOVE      "CG",CATEGORY
          MOVE      ALHDRIRD,CODE        
          CALL      GETCOD00
          WRITE     HTMLFILE;TDESC;
          GOTO      ALHD9999
.
ALHD0791  WRITE     HTMLFILE;ALHDRIRD;       
          GOTO      ALHD9999
.
ALHD0792  MOVE      ALHDRIRD,DIM3           
          CALL      DEPTSL00
          GOTO      ALHD9999
.
ALHD0800  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,ALHD0802,ALHD0805
.
          PACK      KEY12,ALHDRIRD,ALHDRIRS,SP70
          CALL      RDALPRR1
          BRANCH    OVRCD,ALHD9999
          WRITE     HTMLFILE;ALPRDESC;
          GOTO      ALHD9999
.
ALHD0802  WRITE     HTMLFILE;ALHDRIRS;       * Referral-In Reason
          GOTO      ALHD9999
.
ALHD0805  PACK      KEY52,ALHDRIRD,SP70
          CALL      RSALPRR2                * positional read
ALHD0806  CALL      RKALPRR2                * read a record
          BRANCH    OVRCD,ALHD9999
.
          MATCH     ALPRDEPT,ALHDRIRD
          GOTO      ALHD9999 IF NOT EQUAL
.
          MATCH     ALPRPROB,ALHDRIRS
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",ALPRPROB,"#" selected>":
                                 ALPRDESC,"</option>"
          ELSE
.
            MATCH     "1",ALPRACTV            * Only display active codes
            GOTO      ALHD0806 IF NOT EQUAL
.
            MATCH     "2",ALPROTHR          * Don't display other factors
            GOTO      ALHD0806 IF EQUAL
.
            WRITE     HTMLFILE;"<option value=#"",ALPRPROB,"#">":
                                 ALPRDESC,"</option>"
          ENDIF
          GOTO      ALHD0806
.
ALHD0810  WRITE     HTMLFILE;ALHDRITS;       * Referral-In First Triage Score
          GOTO      ALHD9999
.
ALHD0820  MATCH     ALHDSRDT,SP70                * Referral In Rejection
          GOTO      ALHD9999 IF EQUAL            * Date
.
          UNPACK    ALHDSRDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      ALHD9999
.
ALHD0830  MATCH     ALHDDCLO,SP70                * Referral In Close
          GOTO      ALHD9999 IF EQUAL            * Date
.
          UNPACK    ALHDDCLO,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      ALHD9999
.
ALHD0840  MOVE      ALHDURNO,CONTURNO       * Patient UR number
          MOVE      ALHDDATE,CONTDATE       * Date of Contact
          MOVE      ALHDTIME,CONTTIME       * Time of Contact
          MOVE      ALHDDSET,CONTDSET       * Contact Delvery Setting
          CALL      INPF0000                * check if patient was admmitted  
          GOTO      ALHD9999
.
ALHD0850  MOVE      ALHDURNO,CONTURNO       * Patient UR number
          MOVE      ALHDDATE,CONTDATE       * Date of Contact
          MOVE      ALHDTIME,CONTTIME       * Time of Contact
          MOVE      SP70,CONTDSET           * Ignore Contact Delvery Setting
          CALL      INPF0000                * check if patient was admmitted  
          GOTO      ALHD9999
.
ALHD9999  RETURN
.
.------------------------------------------------------------
. VINAH batch tags
.------------------------------------------------------------
TAGB0000  BRANCH    FLDITMNO,TAGB0010,TAGB0020,TAGB0030,TAGB0040,TAGB0050:
                             TAGB0060,TAGB0070,TAGB0080,TAGB0090,TAGB0100:
                             TAGB0110
.
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      TAGB9999
.
TAGB0010  CALL      TABB0000                * Table of batches
          GOTO      TAGB9999
.
TAGB0020  WRITE     HTMLFILE;FILTSTAT;
          GOTO      TAGB9999
.
TAGB0030  WRITE     HTMLFILE;BFILNAME;
          GOTO      TAGB9999
.
TAGB0040  WRITE     HTMLFILE;BATCHNUM;
          GOTO      TAGB9999
.
TAGB0050  WRITE     HTMLFILE;ALHBFNAM;
          GOTO      TAGB9999
.
TAGB0060  WRITE     HTMLFILE;ALHBBNUM;
          GOTO      TAGB9999
.
TAGB0070  CALL      FSTB0000
          WRITE     HTMLFILE;FILESTAT;
          GOTO      TAGB9999
.
TAGB0080  WRITE     HTMLFILE;ALHBURNO;
          GOTO      TAGB9999
.
TAGB0090  WRITE     HTMLFILE;ALHBNBTN;
          GOTO      TAGB9999
.
TAGB0100  WRITE     HTMLFILE;ALHBPBTN;
          GOTO      TAGB9999
.
TAGB0110  WRITE     HTMLFILE;ALHBSTAT;
          GOTO      TAGB9999
.
TAGB9999  RETURN
.
.------------------------------------------------------------
. VINAH message id tags
.------------------------------------------------------------
TAGM0000  BRANCH    FLDITMNO,TAGM0010,TAGM0020,TAGM0030,TAGM0040,TAGM0050:
                             TAGM0060,TAGM0070,TAGM0080,TAGM0090
.
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      TAGM9999
.
TAGM0010  CALL      TABM0000 
          GOTO      TAGM9999
.
TAGM0020  WRITE     HTMLFILE;FILTSTAT;
          GOTO      TAGM9999
.
TAGM0030  WRITE     HTMLFILE;BFILNAME;
          GOTO      TAGM9999
.
TAGM0040  WRITE     HTMLFILE;BATCHNUM;
          GOTO      TAGM9999
.
TAGM0050  WRITE     HTMLFILE;MESSGKEY;
          GOTO      TAGM9999
.
TAGM0060  CALL      TABU0000 
          GOTO      TAGM9999
.
TAGM0070  CALL      DEPSEL00            
          GOTO      TAGM9999
.
TAGM0080  MATCH     SP70,FILTSTAT
          GOTO      TAGM9999 IF EQUAL
.
          CALL      TABM0000 
          GOTO      TAGM9999
.
TAGM0090  CALL      ETAB0000            
          GOTO      TAGM9999
.
TAGM9999  RETURN
.
.------------------------------------------------------------
. List VINAH files
.------------------------------------------------------------
TABF0000  PACK      KEY28,FRSTDATE,SP70
          CALL      RSALHHD2
TABF1000  CALL      RKALHHD2
          BRANCH    OVRCD,TABF9999
.
          MATCH     ALHHSDAT,LASTDATE       * Checks start date
          GOTO      TABF9999 IF LESS
.
          MATCH     SP70,FILTSTAT
          IF        !@EQUAL
            MATCH     FILTSTAT,ALHHSTAT     * Status filter
            GOTO      TABF1000 IF NOT EQUAL
          ENDIF
.
          MOVE      ONE,LINKFLAG
          MATCH     "6",ALHHSTAT
          IF        @EQUAL
            PACK      HTMLLINK,SP70,SP70,SP70
            MOVE      ZERO,LINKFLAG
          ELSE
            CLEAR     HTMLLINK
            APPEND    "javascript:",HTMLLINK
            APPEND    "FileLink('",HTMLLINK
            APPEND    ALHHFNAM,HTMLLINK
            APPEND    "')",HTMLLINK
            RESET     HTMLLINK
          ENDIF
.
          MATCH     "6",ALHHSTAT
          IF        @EQUAL
            PACK      HTMLLNK2,SP70,SP70,SP70
          ELSE
            CLEAR     HTMLLNK2
            APPEND    "javascript:",HTMLLNK2
            APPEND    "FileUpdate('",HTMLLNK2
            APPEND    ALHHFNAM,HTMLLNK2
            APPEND    "')",HTMLLNK2
            RESET     HTMLLNK2
          ENDIF
.                                            * set up link to file

          MOVE      "../extracts/",DIM60     * Default URL prefix
.
          MATCH     "00000000000000000000",ALCNVURL
          IF        !@EQUAL
            MATCH     SP70,ALCNVURL          
            IF        !@EQUAL
              MOVE      ALCNVURL,DIM60       * Use parameter if setup
            ENDIF
          ENDIF
          STRIP     DIM60
.
          CLEAR     HTMLLNK3
          APPEND    "<a href=",HTMLLNK3
          APPEND    DIM60,HTMLLNK3
          APPEND    ALHHFNAM,HTMLLNK3
          APPEND    ">",HTMLLNK3
          APPEND    ALHHFNAM,HTMLLNK3
          APPEND    "</a>",HTMLLNK3
          RESET     HTMLLNK3
.                                           * test if file actually exists
          CLEAR     CMDLINE
          APPEND    "test -e ",CMDLINE      * set up test command
          APPEND    ALCNSACO,CMDLINE        * add the real path
          APPEND    "/",CMDLINE             * trailing slash - just for safety
          APPEND    ALHHFNAM,CMDLINE        * add file name
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID          * run the test
          MATCH     "0       ",TASKID
          GOTO      TABF2000 IF EQUAL
.
          MOVE      "File not found",HTMLLNK3
.
TABF2000  CALL      FSTA0000                * Get file status
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":           * 0
                             "#"",ALHHFNAM,"#",":                    * 1
                             "#"",ALHHSDAT,"#",":                    * 2
                             "#"",ALHHEDAT,"#",":                    * 3
                             "#"",ALHHSTAT,"#",":                    * 4
                             "#"",FILESTAT,"#",":                    * 5
                             "#"",HTMLLNK2,"#",":                    * 6
                             "#"",HTMLLNK3,"#",":                    * 7
                             "#"",LINKFLAG,"#"":                     * 8
                             ");"

.
          GOTO      TABF1000
.
TABF9999  RETURN
.------------------------------------------------------------
. Get batch file status
.------------------------------------------------------------
FSTA0000  MOVE      SP70,FILESTAT
.
          MATCH     SP70,ALHHSTAT
          GOTO      FSTA9999 IF EQUAL
.
          MOVE      ZERO,F1
          MOVE      ALHHSTAT,F1
          ADD       ONE,F1
.
          LOAD      FILESTAT,F1,FILESTA0,FILESTA1,FILESTA2,FILESTA3,FILESTA4:
                             FILESTA5,FILESTA6
.
FSTA9999  RETURN
.
.------------------------------------------------------------
. Get batch file status
.------------------------------------------------------------
FSTB0000  MOVE      SP70,FILESTAT
.
          MATCH     SP70,ALHBSTAT
          GOTO      FSTB9999 IF EQUAL
.
          MOVE      ZERO,F1
          MOVE      ALHBSTAT,F1
          ADD       ONE,F1
.
          LOAD      FILESTAT,F1,BATCSTA0,BATCSTA1,BATCSTA2,BATCSTA3,BATCSTA4:
                             BATCSTA5
.
FSTB9999  RETURN
.
.------------------------------------------------------------
. Get message id status
.------------------------------------------------------------
FSTM0000  MOVE      SP70,FILESTAT
.
          MATCH     SP70,ALHDSTAT
          GOTO      FSTB9999 IF EQUAL
.
          MATCH     "99",ALHDSTAT
          IF        @EQUAL
            MOVE      MESIST99,FILESTAT
            GOTO      FSTM9999
          ENDIF
.
          MOVE      ZERO,F2
          MOVE      ALHDSTAT,F2
          ADD       ONE,F2
.
          LOAD      FILESTAT,F2,MESISTA0,MESISTA1,MESISTA2,MESISTA3,MESISTA4:
                             MESISTA5,MESISTA6,MESISTA7,MESISTA8,MESISTA9:
                             MESIST10
.
FSTM9999  RETURN
.-------------------------------------------------------------------------
. Called by: ALHD0840 and GTAG0170 
. See if the patient was an inpatient at the time of the contact
. Or the contact delivery setting is admitted at another hospital
. Requires : UR Number : CONTURNO
.            Contact Date : CONTDATE
.            Contact Time : CONTTIME
.            Contact Delivery Setting : CONTDSET
.------------------------------------------------------------------------
INPF0000  MATCH     SP70,CONTDSET                * Blank devlivery setting
          GOTO      INPF0250 IF EQUAL
.
          PACK      KEY5,LOWCASEZ,ANSN,ALHDDSET,SP70
          CALL      RDCODE1                      * code on file ?
          BRANCH    OVRCD,INPF0250
.
          MATCH     "11",THCSCOD                 * Inpatient setting
          GOTO      INPF0250 IF NOT EQUAL
.
          MATCH     "O",TCINDC2                  * Admitted at another hospital
          GOTO      INPF9000 IF EQUAL
.
INPF0250  PACK      KEY17,CONTURNO,SP20
          CALL      RSPTMI18                     * position on U/R
INPF0500  CALL      RKPTMI18                     * read next record
          BRANCH    OVRCD,INPF9500               * eof - finished
.
          MATCH     CONTURNO,AURNO               * same U/R still ?
          GOTO      INPF9500 IF NOT EQUAL        * no - finished
.
          MATCH     SP70,ACLSS
          IF        !@EQUAL
            PACK      KEY5,ANSP,SP1,ACLSS,SP70
            CALL      RDCODE1
            IF        OVRCD <> 1
              MATCH     "3",TCINDC1              * BHS ignore boarder
              GOTO      INPF0500 IF EQUAL        * admissions
            ENDIF
          ENDIF
.
.         Check if the contact was prior to the admission (CAR 301450
.         added time check as well for same day)
.
          MATCH     ADATE,CONTDATE               * contact start date<adm date ?
          GOTO      INPF0500 IF LESS             * yes - get next record
          IF        @EQUAL
            MATCH     ATIME,CONTTIME            * contact start time<adm time ?
            GOTO      INPF0500 IF LESS          * yes - get next record
          ENDIF
.
.         The contact is on or after the admission, so check if the
.         patient was admitted when the contact took place.
.
          BRANCH    ASTAT,INPF0500:              * pre-admission
                          INPF9000:              * current admission
                          INPF1000:              * discharged
                          INPF9000:              * on-leave
                          INPF0500               * cancelled
.
          GOTO      INPF0500                     * shouldn't happen
.
INPF1000  MOVE      AADMNO,KEY8
          CALL      RDDSCH1                      * discharge record found ?
          BRANCH    OVRCD,INPF0500               * no - get next record
.
          MATCH     CONTDATE,DDATE               * discharge before contact ?
          GOTO      INPF0500 IF LESS             * yes - get next record
          GOTO      INPF9000 IF NOT EQUAL        * discharge date greater
.
.         Same day, so check times
.
          MATCH     CONTTIME,DTIME               * discharge before contact ?
          GOTO      INPF0500 IF LESS             * yes - get next record
.
.         Patient was admitted when contact took place
.
INPF9000  WRITE     HTMLFILE;"Yes";             * Diaplay Yes in inpatient flag
          GOTO      INPF9999
.
INPF9500  WRITE     HTMLFILE;"No";              * Display No in inpatient flag
.
INPF9999  RETURN
.------------------------------------------------------------
. List VINAH batches
.------------------------------------------------------------
TABB0000  PACK      KEY40,BFILNAME,SP70
          CALL      RDALHBT1
          IF        OVRCD=0
            GOTO      TABB1100
          ENDIF
.
          CALL      RSALHBT1
TABB1000  CALL      RKALHBT1
          BRANCH    OVRCD,TABB9999
.
TABB1100  MATCH     BFILNAME,ALHBFNAM
          GOTO      TABB9999 IF NOT EQUAL
.
          MATCH     SP70,FILTSTAT
          IF        !@EQUAL
            MATCH     FILTSTAT,ALHBSTAT     * Status filter
            GOTO      TABB1000 IF NOT EQUAL
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:",HTMLLINK
          APPEND    "BatchLink('",HTMLLINK
          APPEND    ALHBFNAM,HTMLLINK
          APPEND    "#',#'",HTMLLINK
          APPEND    ALHBBNUM,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          CLEAR     HTMLLNK2
          APPEND    "javascript:",HTMLLNK2
          APPEND    "BatchUpdate('",HTMLLNK2
          APPEND    ALHBFNAM,HTMLLNK2
          APPEND    "#',#'",HTMLLNK2
          APPEND    ALHBBNUM,HTMLLNK2
          APPEND    "')",HTMLLNK2
          RESET     HTMLLNK2
.
          CALL      FSTB0000                * Get batch status
.
          MATCH     SP70,ALHBURNO
          GOTO      TABB1200 IF NOT EQUAL
.
          PACK      KEY62,ALHBBNUM,SP70
          CALL      RSALHDT2
          CALL      RKALHDT2
          BRANCH    OVRCD,TABB1200
.
          MATCH     ALHBBNUM,ALHDBNUM
          GOTO      TABB1200 IF NOT EQUAL
.
          MATCH     "ADT-A40",ALHDMTYP
          IF        @EQUAL
            MOVE      "Merges",ALHBURNO
          ENDIF
.
TABB1200  WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":           * 0
                             "#"",ALHBFNAM,"#",":                    * 1
                             "#"",ALHBBNUM,"#",":                    * 2
                             "#"",ALHBURNO,"#",":                    * 3
                             "#"",ALHBNBTN,"#",":                    * 4
                             "#"",ALHBPBTN,"#",":                    * 5
                             "#"",ALHBSTAT,"#",":                    * 6
                             "#"",FILESTAT,"#",":                    * 7
                             "#"",HTMLLNK2,"#"":                     * 8
                             ");"
.
          GOTO      TABB1000
.
TABB9999  RETURN
.------------------------------------------------------------
. List VINAH message id by batch and status
.------------------------------------------------------------
TABM0000  PACK      KEY62,BATCHNUM,SP70
.
          MATCH     SP70,FILTSTAT
          IF        !@EQUAL
            MATCH     "~~",FILTSTAT           * All
            IF        !@EQUAL
              PACK      KEY62,BATCHNUM,FILTSTAT,SP70
            ENDIF
          ENDIF
.
          CALL      RSALHDT2
TABM1000  CALL      RKALHDT2
          BRANCH    OVRCD,TABM9999
.
          MATCH     BATCHNUM,ALHDBNUM
          GOTO      TABM9999 IF NOT EQUAL
.
          MATCH     SP70,FILTSTAT
          IF        !@EQUAL
            MATCH     "~~",FILTSTAT           * All
            GOTO      TABM1100 IF EQUAL
.
            MATCH     FILTSTAT,ALHDSTAT     * Status filter
            GOTO      TABM9999 IF NOT EQUAL
          ENDIF
.
TABM1100  MATCH     SP70,DEPTCODE
          IF        !@EQUAL
            MATCH     DEPTCODE,ALHDDEPT     * Status filter
            GOTO      TABM1000 IF NOT EQUAL
          ENDIF
.
          PACK      DIM42,ALHDSTAT,ALHDURNO,ALHDVISN,ALHDCONT:
                            ALHDDTTM,ALHDRTYP,ALHDACTN,SP70
.
          CLEAR     HTMLLINK
          APPEND    "javascript:",HTMLLINK
          APPEND    "MessageLink('",HTMLLINK
          APPEND    DIM42,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          CLEAR     HTMLLNK2
          APPEND    "javascript:",HTMLLNK2
          APPEND    "MessageLinkUr('",HTMLLNK2
          APPEND    ALHDURNO,HTMLLNK2
          APPEND    "#',#'",HTMLLNK2
          APPEND    ALHDVISN,HTMLLNK2
          APPEND    "')",HTMLLNK2
          RESET     HTMLLNK2
.
          CALL      FSTM0000                * Get batch status
.
          MOVE      SP70,DESCRTYP
          MATCH     "0",ALHDRTYP
          IF        @EQUAL
            MOVE      "Referral-In",DESCRTYP
          ENDIF
.
          MATCH     "1",ALHDRTYP
          IF        @EQUAL
            MOVE      "Episode",DESCRTYP
          ENDIF
.
          MATCH     "2",ALHDRTYP
          IF        @EQUAL
            MOVE      "Contact",DESCRTYP
          ENDIF
.
          MATCH     "3",ALHDRTYP
          IF        @EQUAL
            MOVE      "Merge",DESCRTYP
          ENDIF
.
          MATCH     "4",ALHDRTYP
          IF        @EQUAL
            MOVE      "PMI",DESCRTYP
          ENDIF
.
          MATCH     "5",ALHDRTYP
          IF        @EQUAL
            MOVE      "Referral-Out",DESCRTYP
          ENDIF
.
          UNPACK    ALHDDTTM,D8,D2A,D2B,D2C
          PACK      D16,D8,D2A,COLON,D2B,COLON,D2C
.
          MOVE      SP70,DIM12
          MATCH     "0",ALHDRTYP
          IF        @EQUAL
            MOVE      "Referral-In",DIM12
          ENDIF
.
          MATCH     "1",ALHDRTYP
          IF        @EQUAL
            MOVE      "Episode",DIM12
          ENDIF
.
          MATCH     "2",ALHDRTYP
          IF        @EQUAL
            MOVE      "Contact",DIM12
          ENDIF
.
          MATCH     "3",ALHDRTYP
          IF        @EQUAL
            MOVE      "Merge",DIM12
          ENDIF
.
          MATCH     "4",ALHDRTYP
          IF        @EQUAL
            MOVE      "PMI",DIM12
          ENDIF
.
          MATCH     "5",ALHDRTYP
          IF        @EQUAL
            MOVE      "Referral-Out",DIM12
          ENDIF
.
          MOVE      SP70,TDESC
          MATCH     SP70,ALHDDEPT
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSG,ALHDDEPT,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      ALHDDEPT,TDESC
            ENDIF
          ENDIF
.
          MOVE      SP70,DIM8
          COMPARE   ZERO,ALHDSRCE
          IF        @EQUAL
            MOVE     "LDALLHDT",DIM8
          ENDIF
.         
          COMPARE   ONE,ALHDSRCE
          IF        @EQUAL   
            MOVE     "VINAHEXT",DIM8
          ENDIF
.                
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":           * 0
                             "#"",ALHDSTAT,"#",":                    * 1
                             "#"",ALHDURNO,"#",":                    * 2
                             "#"",D16,"#",":                         * 3
                             "#"",ALHDRTYP,"#",":                    * 4
                             "#"",ALHDACTN,"#",":                    * 5
                             "#"",ALHDBNUM,"#",":                    * 6
                             "#"",ALHDMESI,"#",":                    * 7
                             "#"",ALHDVISN,"#",":                    * 8
                             "#"",FILESTAT,"#",":                    * 9
                             "#"",ALHDMTYP,"#",":                    * 10
                             "#"",DIM12,"#",":                       * 11
                             "#"",ALHDDEPT,"#",":                    * 12
                             "#"",TDESC,"#",":                       * 13
                             "#"",DIM8,"#",":                        * 14
                             "#"",HTMLLNK2,"#"":                     * 15
                             ");"
.
          GOTO      TABM1000
.
TABM9999  RETURN
.
.------------------------------------------------------------
. List VINAH message id by U/R
.------------------------------------------------------------
TABU0000  PACK      KEY42,URNUMBER,SP70
          CALL      RSALHDT3
TABU1000  CALL      RKALHDT3
          BRANCH    OVRCD,TABU9999
.
          MATCH     URNUMBER,ALHDURNO
          GOTO      TABU9999 IF NOT EQUAL
.
          MATCH     SP70,BATCHNUM
          IF        !@EQUAL
            MATCH     BATCHNUM,ALHDBNUM     * Batch Filter
            GOTO      TABU1000 IF NOT EQUAL
          ENDIF
. 
          MATCH     SP70,FILTSTAT
          IF        !@EQUAL
            MATCH     FILTSTAT,ALHDSTAT     * Status filter
            GOTO      TABU1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,DEPTCODE
          IF        !@EQUAL
            MATCH     DEPTCODE,ALHDDEPT     * Status filter
            GOTO      TABU1000 IF NOT EQUAL
          ENDIF
. 
          PACK      DIM42,ALHDSTAT,ALHDURNO,ALHDVISN,ALHDCONT:
                            ALHDDTTM,ALHDRTYP,ALHDACTN,SP70
.
          CLEAR     HTMLLINK
          APPEND    "javascript:",HTMLLINK
          APPEND    "MessageLink('",HTMLLINK
          APPEND    DIM42,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          CALL      FSTM0000                * Get batch status
.
          MOVE      SP70,DESCRTYP
          MATCH     "0",ALHDRTYP
          IF        @EQUAL
            MOVE      "Referral-In",DESCRTYP
          ENDIF
.
          MATCH     "1",ALHDRTYP
          IF        @EQUAL
            MOVE      "Episode",DESCRTYP
          ENDIF
.
          MATCH     "2",ALHDRTYP
          IF        @EQUAL
            MOVE      "Contact",DESCRTYP
          ENDIF
.
          MATCH     "3",ALHDRTYP
          IF        @EQUAL
            MOVE      "Merge",DESCRTYP
          ENDIF
.
          MATCH     "4",ALHDRTYP
          IF        @EQUAL
            MOVE      "PMI",DESCRTYP
          ENDIF
.
          MATCH     "5",ALHDRTYP
          IF        @EQUAL
            MOVE      "Referral-Out",DESCRTYP
          ENDIF
.
          UNPACK    ALHDDTTM,D8,D2A,D2B,D2C
          PACK      D16,D8,D2A,COLON,D2B,COLON,D2C
.
          MOVE      SP70,DIM12
          MATCH     "0",ALHDRTYP
          IF        @EQUAL
            MOVE      "Referral-In",DIM12
          ENDIF
.
          MATCH     "1",ALHDRTYP
          IF        @EQUAL
            MOVE      "Episode",DIM12
          ENDIF
.
          MATCH     "2",ALHDRTYP
          IF        @EQUAL
            MOVE      "Contact",DIM12
          ENDIF
.
          MATCH     "3",ALHDRTYP
          IF        @EQUAL
            MOVE      "Merge",DIM12
          ENDIF
.
          MATCH     "4",ALHDRTYP
          IF        @EQUAL
            MOVE      "PMI",DIM12
          ENDIF
.
          MATCH     "5",ALHDRTYP
          IF        @EQUAL
            MOVE      "Referral-Out",DIM12
          ENDIF
.
          MOVE      SP70,TDESC
          MATCH     SP70,ALHDDEPT
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSG,ALHDDEPT,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      ALHDDEPT,TDESC
            ENDIF
          ENDIF
.
          MOVE      SP70,DIM8
          COMPARE   ZERO,ALHDSRCE
          IF        @EQUAL
            MOVE     "LDALLHDT",DIM8
          ENDIF
.
          COMPARE   ONE,ALHDSRCE
          IF        @EQUAL
            MOVE     "VINAHEXT",DIM8
          ENDIF
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":           * 0
                             "#"",ALHDSTAT,"#",":                    * 1
                             "#"",ALHDURNO,"#",":                    * 2
                             "#"",D16,"#",":                         * 3
                             "#"",ALHDRTYP,"#",":                    * 4
                             "#"",ALHDACTN,"#",":                    * 5
                             "#"",ALHDBNUM,"#",":                    * 6
                             "#"",ALHDMESI,"#",":                    * 7
                             "#"",ALHDVISN,"#",":                    * 8
                             "#"",FILESTAT,"#",":                    * 9
                             "#"",ALHDMTYP,"#",":                    * 10
                             "#"",DIM12,"#",":                       * 11
                             "#"",ALHDDEPT,"#",":                    * 12
                             "#"",TDESC,"#",":                       * 13
                             "#"",DIM8,"#"":                         * 14
                             ");"
.
          GOTO      TABU1000
.
TABU9999  RETURN
.
.------------------------------------------------------------
. Clear file vars for allhhdaf
.------------------------------------------------------------
CLALHH00  MOVE      SP70,ALHHFNAM
          MOVE      SP70,ALHHSDAT
          MOVE      SP70,ALHHEDAT
          MOVE      SP70,ALHHSTAT
.
CLALHH99  RETURN
.
.------------------------------------------------------------
. Clear file vars for allhbtaf
.------------------------------------------------------------
CLALHT00  MOVE      SP70,ALHBFNAM 
          MOVE      SP70,ALHBBNUM 
          MOVE      SP70,ALHBSTAT 
          MOVE      SP70,ALHBURNO 
          MOVE      SP70,ALHBNBTN 
          MOVE      SP70,ALHBPBTN  
.
CLALHT99  RETURN
.
.------------------------------------------------------------
. Clear file vars for allhdtaf
.------------------------------------------------------------
CLALHD00  MOVE      SP70,ALHDSTAT 
          MOVE      SP70,ALHDURNO
          MOVE      SP70,ALHDDTTM
          MOVE      SP70,ALHDVISN
          MOVE      SP70,ALHDCONT
          MOVE      SP70,ALHDBNUM
          MOVE      SP70,ALHDMESI
          MOVE      SP70,ALHDRTYP
          MOVE      SP70,ALHDACTN
          MOVE      SP70,ALHDVFLG
          MOVE      SP70,ALHDMTYP
          MOVE      ZERO,ALHDSRCE
          MOVE      SP70,ALHDDEPT
          MOVE      ZERO,ALHDPRGM
          MOVE      SP70,ALHDWEBU
          MOVE      SP70,ALHDCRST
          MOVE      SP70,ALHDCAVL 
          MOVE      SP70,ALHDLARR
          MOVE      SP70,ALHDUACC
          MOVE      SP70,ALHDMREL
          MOVE      SP70,ALHDDTHP
          MOVE      SP70,ALHDOURN
          MOVE      SP70,ALHDRDAT
          MOVE      SP70,ALHDOTRR
          MOVE      SP70,ALHDOTRC
          MOVE      SP70,ALHDOUTC
          MOVE      SP70,ALHDCLUC
          MOVE      SP70,ALHDCRDT
          MOVE      SP70,ALHDRADT
          MOVE      SP70,ALHDLINK
          MOVE      SP70,ALHDSDAT
          MOVE      SP70,ALHDEDAT
          MOVE      SP70,ALHDFCFL
          MOVE      SP70,ALHDCPPT
          MOVE      SP70,ALHDIODT
          MOVE      SP70,ALHDACDD
          MOVE      SP70,ALHDCPDD
          MOVE      SP70,ALHDFABD
          MOVE      SP70,ALHDHDDT
          MOVE      SP70,ALHDFNAD
          MOVE      SP70,ALHDENDR
          MOVE      SP70,ALHDMFLG
          MOVE      SP70,ALHDCTYP
          MOVE      SP70,ALHDEEPR
          MOVE      SP70,ALHDCOMP
          MOVE      SP70,ALHDPGRP
          MOVE      SP70,ALHDPGR1
          MOVE      SP70,ALHDPGR2
          MOVE      SP70,ALHDPGR3
          MOVE      SP70,ALHDPGR4
          MOVE      SP70,ALHDDATE
          MOVE      SP70,ALHDTIME
          MOVE      SP70,ALHDPURP
          MOVE      SP70,ALHDSTYP
          MOVE      SP70,ALHDPRES
          MOVE      SP70,ALHDDMOD
          MOVE      SP70,ALHDDSET
          MOVE      SP70,ALHDPOFC
          MOVE      SP70,ALHDPDPL
          MOVE      SP70,ALHDCMOD
          MOVE      SP70,ALHDIFLG
          MOVE      SP70,ALHDSPCP
          MOVE      SP70,ALHDCSET
          MOVE      SP70,ALHDCEPR
          MOVE      SP70,ALHDRODT
          MOVE      SP70,ALHDSERT
          MOVE      SP70,ALHDPLAC
          MOVE      SP70,ALHDRCNT
          MOVE      SP70,ALHDPSIT
          MOVE      SP70,ALHDUDT1
          MOVE      SP70,ALHDCLID
          MOVE      SP70,ALHDTRGS
          MOVE      SP70,ALHDTRGD
          MOVE      SP70,ALHDSDEP 
          MOVE      SP70,ALHDUDT2 
          MOVE      SP70,ALHDCEDT 
          MOVE      SP70,ALHDCETM 
          MOVE      SP70,ALHDRSTA 
          MOVE      SP70,ALHDDCAN
          MOVE      SP70,ALHDRIRD
          MOVE      SP70,ALHDRIRS
          MOVE      SP70,ALHDRITS
          MOVE      SP70,ALHDSRDT
          MOVE      SP70,ALHDDCLO
          MOVE      SP70,ALHDSPAR
.
CLALHD99  RETURN
.
.------------------------------------------------------------
. Clear cgi vars for allhbtaf
.------------------------------------------------------------
CPALHD00  MOVE      Z70,ALHDT001
          MOVE      Z70,ALHDT002
          MOVE      Z70,ALHDT003
          MOVE      Z70,ALHDT004
          MOVE      Z70,ALHDT005
          MOVE      Z70,ALHDT006
          MOVE      Z70,ALHDT007
          MOVE      Z70,ALHDT008
          MOVE      Z70,ALHDT009
          MOVE      Z70,ALHDT010
          MOVE      Z70,ALHDT011
          MOVE      Z70,ALHDT012
          MOVE      Z70,ALHDT013
          MOVE      Z70,ALHDT014
          MOVE      Z70,ALHDT015
          MOVE      Z70,ALHDT017
          MOVE      Z70,ALHDT018
          MOVE      Z70,ALHDT019
          MOVE      Z70,ALHDT020
          MOVE      Z70,ALHDT021
          MOVE      Z70,ALHDT022
          MOVE      Z70,ALHDT023
          MOVE      Z70,ALHDT024
          MOVE      Z70,ALHDT025
          MOVE      Z70,ALHDT026
          MOVE      Z70,ALHDT027
          MOVE      Z70,ALHDT028
          MOVE      Z70,ALHDT029
          MOVE      Z70,ALHDT030
          MOVE      Z70,ALHDT031
          MOVE      Z70,ALHDT032
          MOVE      Z70,ALHDT033
          MOVE      Z70,ALHDT034
          MOVE      Z70,ALHDT035
          MOVE      Z70,ALHDT036
          MOVE      Z70,ALHDT037
          MOVE      Z70,ALHDT038
          MOVE      Z70,ALHDT039
          MOVE      Z70,ALHDT040
          MOVE      Z70,ALHDT041
          MOVE      Z70,ALHDT042
          MOVE      Z70,ALHDT043
          MOVE      Z70,ALHDT044
          MOVE      Z70,ALHDT045
          MOVE      Z70,ALHDT046
          MOVE      Z70,ALHDT047
          MOVE      Z70,ALHDT048
          MOVE      Z70,ALHDT049
          MOVE      Z70,ALHDT050
          MOVE      Z70,ALHDT051
          MOVE      Z70,ALHDT052
          MOVE      Z70,ALHDT053
          MOVE      Z70,ALHDT054
          MOVE      Z70,ALHDT055
          MOVE      Z70,ALHDT056
          MOVE      Z70,ALHDT057
          MOVE      Z70,ALHDT058
          MOVE      Z70,ALHDT059
          MOVE      Z70,ALHDT060
          MOVE      Z70,ALHDT061
          MOVE      Z70,ALHDT062
          MOVE      Z70,ALHDT063
          MOVE      Z70,ALHDT064
          MOVE      Z70,ALHDT065
          MOVE      Z70,ALHDT066
          MOVE      Z70,ALHDT067
          MOVE      Z70,ALHDT068
          MOVE      Z70,ALHDT069
          MOVE      Z70,ALHDT070
          MOVE      Z70,ALHDT071
          MOVE      Z70,ALHDT072
          MOVE      Z70,ALHDT073
          MOVE      Z70,ALHDT074
          MOVE      Z70,ALHDT075
          MOVE      Z70,ALHDT076
          MOVE      Z70,ALHDT077
          MOVE      Z70,ALHDT078
          MOVE      Z70,ALHDT079
          MOVE      Z70,ALHDT080
          MOVE      Z70,ALHDT081
          MOVE      Z70,ALHDT082
          MOVE      Z70,ALHDT083
.
CPALHD99  RETURN
.------------------------------------------------------------
.   Set Parameters for VINAH message id file
.------------------------------------------------------------
SPALHD00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SPALHD01,SPALHD02,SPALHD03,SPALHD04,SPALHD05:
                       SPALHD06,SPALHD07,SPALHD08,SPALHD09,SPALHD10:
                       SPALHD11,SPALHD12,SPALHD13,SPALHD14,SPALHD15:
                       SPALHD16,SPALHD17,SPALHD18,SPALHD19,SPALHD20:
                       SPALHD21,SPALHD22,SPALHD23,SPALHD24,SPALHD25:
                       SPALHD26,SPALHD27,SPALHD28,SPALHD29,SPALHD30:
                       SPALHD31,SPALHD32,SPALHD33,SPALHD34,SPALHD35:
                       SPALHD36,SPALHD37,SPALHD38,SPALHD39,SPALHD40:
                       SPALHD41,SPALHD42,SPALHD43,SPALHD44,SPALHD45:
                       SPALHD46,SPALHD47,SPALHD48,SPALHD49,SPALHD50:
                       SPALHD51,SPALHD52,SPALHD53,SPALHD54,SPALHD55:
                       SPALHD56,SPALHD57,SPALHD58,SPALHD59,SPALHD60:
                       SPALHD61,SPALHD62,SPALHD63,SPALHD64,SPALHD65:
                       SPALHD66,SPALHD67,SPALHD68,SPALHD69,SPALHD70:
                       SPALHD71,SPALHD72,SPALHD73,SPALHD74,SPALHD75:
                       SPALHD76,SPALHD77,SPALHD78,SPALHD79,SPALHD80:
                       SPALHD81,SPALHD82,SPALHD83
.
          MOVE      ONE,EXIT
          GOTO      SPALHD999
.
SPALHD01  MOVE      QRYDATA,ALHDT001
          GOTO      SPALHD99
.
SPALHD02  MOVE      QRYDATA,ALHDT002
          GOTO      SPALHD99
.
SPALHD03  MOVE      QRYDATA,ALHDT003
          GOTO      SPALHD99
.
SPALHD04  MOVE      QRYDATA,ALHDT004
          GOTO      SPALHD99
.
SPALHD05  MOVE      QRYDATA,ALHDT005
          GOTO      SPALHD99
.
SPALHD06  MOVE      QRYDATA,ALHDT006
          GOTO      SPALHD99
.
SPALHD07  MOVE      QRYDATA,ALHDT007
          GOTO      SPALHD99
.
SPALHD08  MOVE      QRYDATA,ALHDT008
          GOTO      SPALHD99
.
SPALHD09  MOVE      QRYDATA,ALHDT009
          GOTO      SPALHD99
.
SPALHD10  MOVE      QRYDATA,ALHDT010
          GOTO      SPALHD99
.
SPALHD11  MOVE      QRYDATA,ALHDT011
          GOTO      SPALHD99
.
SPALHD12  MOVE      QRYDATA,ALHDT012
          GOTO      SPALHD99
.
SPALHD13  MOVE      QRYDATA,ALHDT013
          GOTO      SPALHD99
.
SPALHD14  MOVE      QRYDATA,ALHDT014
          GOTO      SPALHD99
.
SPALHD15  MOVE      QRYDATA,ALHDT015
          GOTO      SPALHD99
.
SPALHD16  MOVE      QRYDATA,ALHDT016
          GOTO      SPALHD99
.
SPALHD17  MOVE      QRYDATA,ALHDT017
          GOTO      SPALHD99
.
SPALHD18  MOVE      QRYDATA,ALHDT018
          GOTO      SPALHD99
.
SPALHD19  MOVE      QRYDATA,ALHDT019
          GOTO      SPALHD99
.
SPALHD20  MOVE      QRYDATA,ALHDT020
          GOTO      SPALHD99
.
SPALHD21  MOVE      QRYDATA,ALHDT021
          GOTO      SPALHD99
.
SPALHD22  MOVE      QRYDATA,ALHDT022
          GOTO      SPALHD99
.
SPALHD23  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                *Set CMON from MTHNAM3
          PACK      ALHDT023,CCENT,CYEAR,CMON,CDAY
          GOTO      SPALHD99
.
SPALHD24  MOVE      QRYDATA,ALHDT024
          GOTO      SPALHD99
.
SPALHD25  MOVE      QRYDATA,ALHDT025
          GOTO      SPALHD99
.
SPALHD26  MOVE      QRYDATA,ALHDT026
          GOTO      SPALHD99
.
SPALHD27  MOVE      QRYDATA,ALHDT027
          GOTO      SPALHD99
.
SPALHD28  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                *Set CMON from MTHNAM3
          PACK      ALHDT028,CCENT,CYEAR,CMON,CDAY
          GOTO      SPALHD99
.
SPALHD29  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                *Set CMON from MTHNAM3
          PACK      ALHDT029,CCENT,CYEAR,CMON,CDAY
          GOTO      SPALHD99
.
SPALHD30  MOVE      QRYDATA,ALHDT030
          GOTO      SPALHD99
.
SPALHD31  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                *Set CMON from MTHNAM3
          PACK      ALHDT031,CCENT,CYEAR,CMON,CDAY
          GOTO      SPALHD99
.
SPALHD32  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                *Set CMON from MTHNAM3
          PACK      ALHDT032,CCENT,CYEAR,CMON,CDAY
          GOTO      SPALHD99
.
SPALHD33  MOVE      QRYDATA,ALHDT033
          GOTO      SPALHD99
.
SPALHD34  MOVE      QRYDATA,ALHDT034
          GOTO      SPALHD99
.
SPALHD35  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                *Set CMON from MTHNAM3
          PACK      ALHDT035,CCENT,CYEAR,CMON,CDAY
          GOTO      SPALHD99
.
SPALHD36  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                *Set CMON from MTHNAM3
          PACK      ALHDT036,CCENT,CYEAR,CMON,CDAY
          GOTO      SPALHD99
.
SPALHD37  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                *Set CMON from MTHNAM3
          PACK      ALHDT037,CCENT,CYEAR,CMON,CDAY
          GOTO      SPALHD99
.
SPALHD38  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                *Set CMON from MTHNAM3
          PACK      ALHDT038,CCENT,CYEAR,CMON,CDAY
          GOTO      SPALHD99
.
SPALHD39  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                *Set CMON from MTHNAM3
          PACK      ALHDT039,CCENT,CYEAR,CMON,CDAY
          GOTO      SPALHD99
.
SPALHD40  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                *Set CMON from MTHNAM3
          PACK      ALHDT040,CCENT,CYEAR,CMON,CDAY
          GOTO      SPALHD99
.
SPALHD41  MOVE      QRYDATA,ALHDT041
          GOTO      SPALHD99
.
SPALHD42  MOVE      QRYDATA,ALHDT042
          GOTO      SPALHD99
.
SPALHD43  MOVE      QRYDATA,ALHDT043
          GOTO      SPALHD99
.
SPALHD44  MOVE      QRYDATA,ALHDT044
          GOTO      SPALHD99
.
SPALHD45  MOVE      QRYDATA,ALHDT045
          GOTO      SPALHD99
.
SPALHD46  MOVE      QRYDATA,ALHDT046
          GOTO      SPALHD99
.
SPALHD47  MOVE      QRYDATA,ALHDT047
          GOTO      SPALHD99
.
SPALHD48  MOVE      QRYDATA,ALHDT048
          GOTO      SPALHD99
.
SPALHD49  MOVE      QRYDATA,ALHDT049
          GOTO      SPALHD99
.
SPALHD50  MOVE      QRYDATA,ALHDT050
          GOTO      SPALHD99
.
SPALHD51  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                *Set CMON from MTHNAM3
          PACK      ALHDT051,CCENT,CYEAR,CMON,CDAY
          GOTO      SPALHD99
.
SPALHD52  MOVE      QRYDATA,ALHDT052
          GOTO      SPALHD99
.
SPALHD53  MOVE      QRYDATA,ALHDT053
          GOTO      SPALHD99
.
SPALHD54  MOVE      QRYDATA,ALHDT054
          GOTO      SPALHD99
.
SPALHD55  MOVE      QRYDATA,ALHDT055
          GOTO      SPALHD99
.
SPALHD56  MOVE      QRYDATA,ALHDT056
          GOTO      SPALHD99
.
SPALHD57  MOVE      QRYDATA,ALHDT057
          GOTO      SPALHD99
.
SPALHD58  MOVE      QRYDATA,ALHDT058
          GOTO      SPALHD99
.
SPALHD59  MOVE      QRYDATA,ALHDT059
          GOTO      SPALHD99
.
SPALHD60  MOVE      QRYDATA,ALHDT060
          GOTO      SPALHD99
.
SPALHD61  MOVE      QRYDATA,ALHDT061
          GOTO      SPALHD99
.
SPALHD62  MOVE      QRYDATA,ALHDT062
          GOTO      SPALHD99
.
SPALHD63  MOVE      QRYDATA,ALHDT063
          GOTO      SPALHD99
.
SPALHD64  MOVE      QRYDATA,ALHDT064
          GOTO      SPALHD99
.
SPALHD65  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                *Set CMON from MTHNAM3
          PACK      ALHDT065,CCENT,CYEAR,CMON,CDAY
          GOTO      SPALHD99
.
SPALHD66  MOVE      QRYDATA,ALHDT066
          GOTO      SPALHD99
.
SPALHD67  MOVE      QRYDATA,ALHDT067
          GOTO      SPALHD99
.
SPALHD68  MOVE      QRYDATA,ALHDT068
          GOTO      SPALHD99
.
SPALHD69  MOVE      QRYDATA,ALHDT069
          GOTO      SPALHD99
.
SPALHD70  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                *Set CMON from MTHNAM3
          PACK      ALHDT070,CCENT,CYEAR,CMON,CDAY
          GOTO      SPALHD99
.
SPALHD71  MOVE      QRYDATA,ALHDT071
          GOTO      SPALHD99
.
SPALHD72  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                *Set CMON from MTHNAM3
          PACK      ALHDT072,CCENT,CYEAR,CMON,CDAY
          GOTO      SPALHD99
.
SPALHD73  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                *Set CMON from MTHNAM3
          PACK      ALHDT073,CCENT,CYEAR,CMON,CDAY
          GOTO      SPALHD99
.
SPALHD74  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                *Set CMON from MTHNAM3
          PACK      ALHDT074,CCENT,CYEAR,CMON,CDAY
          GOTO      SPALHD99
.
SPALHD75  MOVE      QRYDATA,ALHDT075
          GOTO      SPALHD99
.
SPALHD76  MOVE      QRYDATA,ALHDT076
          GOTO      SPALHD99
.
SPALHD77  PACK      ALHDT077,QRYDATA,SP70
          GOTO      SPALHD99
.
SPALHD78  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                *Set CMON from MTHNAM3
          PACK      ALHDT078,CCENT,CYEAR,CMON,CDAY
          GOTO      SPALHD99
.
SPALHD79  PACK      ALHDT079,QRYDATA,SP70
          GOTO      SPALHD99
.
SPALHD80  PACK      ALHDT080,QRYDATA,SP70
          GOTO      SPALHD99
.
SPALHD81  PACK      ALHDT081,QRYDATA,SP70
          GOTO      SPALHD99
.
SPALHD82  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                *Set CMON from MTHNAM3
          PACK      ALHDT082,CCENT,CYEAR,CMON,CDAY
          GOTO      SPALHD99
.
SPALHD83  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                *Set CMON from MTHNAM3
          PACK      ALHDT083,CCENT,CYEAR,CMON,CDAY
          GOTO      SPALHD99
.
SPALHD99  RETURN
.
.------------------------------------------------------------
.  Update VINAH message id file
.------------------------------------------------------------
MVALHD00  MATCH     Z70,ALHDT001
          IF        !@EQUAL
            MOVE      ALHDT001,ALHDSTAT
          ENDIF
.
          MATCH     Z70,ALHDT002
          IF        !@EQUAL
            MOVE      ALHDT002,ALHDURNO
          ENDIF
.
          MATCH     Z70,ALHDT003
          IF        !@EQUAL
            MOVE      ALHDT003,ALHDDTTM
          ENDIF
.
          MATCH     Z70,ALHDT004
          IF        !@EQUAL
            MOVE      ALHDT004,ALHDVISN
          ENDIF
.
          MATCH     Z70,ALHDT005
          IF        !@EQUAL
            MOVE      ALHDT005,ALHDCONT
          ENDIF
.
          MATCH     Z70,ALHDT006
          IF        !@EQUAL
            MOVE      ALHDT006,ALHDBNUM
          ENDIF
.
          MATCH     Z70,ALHDT007
          IF        !@EQUAL
            MOVE      ALHDT007,ALHDMESI
          ENDIF
.
          MATCH     Z70,ALHDT008
          IF        !@EQUAL
            MOVE      ALHDT008,ALHDRTYP
          ENDIF
.
          MATCH     Z70,ALHDT009
          IF        !@EQUAL
            MOVE      ALHDT009,ALHDACTN
          ENDIF
.
          MATCH     Z70,ALHDT010
          IF        !@EQUAL
            MOVE      ALHDT010,ALHDVFLG
          ENDIF
.
          MATCH     Z70,ALHDT011
          IF        !@EQUAL
            MOVE      ALHDT011,ALHDMTYP
          ENDIF
.
          MATCH     Z70,ALHDT012
          IF        !@EQUAL
            MOVE      ALHDT012,ALHDSRCE
          ENDIF
.
          MATCH     Z70,ALHDT013
          IF        !@EQUAL
            MOVE      ALHDT013,ALHDDEPT
          ENDIF
.
          MATCH     Z70,ALHDT014
          IF        !@EQUAL
            MOVE      ALHDT014,ALHDPRGM
          ENDIF
.
          MATCH     Z70,ALHDT015
          IF        !@EQUAL
            MOVE      ALHDT015,ALHDWEBU
          ENDIF
.
          MATCH     Z70,ALHDT016
          IF        !@EQUAL
            MOVE      ALHDT016,ALHDCRST
          ENDIF
.
          MATCH     Z70,ALHDT017
          IF        !@EQUAL
            MOVE      ALHDT017,ALHDCAVL
          ENDIF
.
          MATCH     Z70,ALHDT018
          IF        !@EQUAL
            MOVE      ALHDT018,ALHDLARR
          ENDIF
.
          MATCH     Z70,ALHDT019
          IF        !@EQUAL
            MOVE      ALHDT019,ALHDUACC
          ENDIF
.
          MATCH     Z70,ALHDT020
          IF        !@EQUAL
            MOVE      ALHDT020,ALHDMREL
          ENDIF
.
          MATCH     Z70,ALHDT021
          IF        !@EQUAL
            MOVE      ALHDT021,ALHDDTHP
          ENDIF
.
          MATCH     Z70,ALHDT022
          IF        !@EQUAL
            MOVE      ALHDT022,ALHDOURN
          ENDIF
.
          MATCH     Z70,ALHDT023
          IF        !@EQUAL
            MOVE      ALHDT023,ALHDRDAT
          ENDIF
.
          MATCH     Z70,ALHDT024
          IF        !@EQUAL
            MOVE      ALHDT024,ALHDOTRR
          ENDIF
.
          MATCH     Z70,ALHDT025
          IF        !@EQUAL
            MOVE      ALHDT025,ALHDOTRC
          ENDIF
.
          MATCH     Z70,ALHDT026
          IF        !@EQUAL
            MOVE      ALHDT026,ALHDOUTC
          ENDIF
.
          MATCH     Z70,ALHDT027
          IF        !@EQUAL
            MOVE      ALHDT027,ALHDCLUC
          ENDIF
.
          MATCH     Z70,ALHDT028
          IF        !@EQUAL
            MOVE      ALHDT028,ALHDCRDT
          ENDIF
.
          MATCH     Z70,ALHDT029
          IF        !@EQUAL
            MOVE      ALHDT029,ALHDRADT
          ENDIF
.
          MATCH     Z70,ALHDT030
          IF        !@EQUAL
            MOVE      ALHDT030,ALHDLINK
          ENDIF
.
          MATCH     Z70,ALHDT031
          IF        !@EQUAL
            MOVE      ALHDT031,ALHDSDAT
          ENDIF
.
          MATCH     Z70,ALHDT032
          IF        !@EQUAL
            MOVE      ALHDT032,ALHDEDAT
          ENDIF
.
          MATCH     Z70,ALHDT033
          IF        !@EQUAL
            MOVE      ALHDT033,ALHDFCFL
          ENDIF
.
          MATCH     Z70,ALHDT034
          IF        !@EQUAL
            MOVE      ALHDT034,ALHDCPPT
          ENDIF
.
          MATCH     Z70,ALHDT035
          IF        !@EQUAL
            MOVE      ALHDT035,ALHDIODT
          ENDIF
.
          MATCH     Z70,ALHDT036
          IF        !@EQUAL
            MOVE      ALHDT036,ALHDACDD
          ENDIF
.
          MATCH     Z70,ALHDT037
          IF        !@EQUAL
            MOVE      ALHDT037,ALHDCPDD
          ENDIF
.
          MATCH     Z70,ALHDT038
          IF        !@EQUAL
            MOVE      ALHDT038,ALHDFABD
          ENDIF
.
          MATCH     Z70,ALHDT039
          IF        !@EQUAL
            MOVE      ALHDT039,ALHDHDDT
          ENDIF
.
          MATCH     Z70,ALHDT040
          IF        !@EQUAL
            MOVE      ALHDT040,ALHDFNAD
          ENDIF
.
          MATCH     Z70,ALHDT041
          IF        !@EQUAL
            MOVE      ALHDT041,ALHDENDR
          ENDIF
.
          MATCH     Z70,ALHDT042
          IF        !@EQUAL
            MOVE      ALHDT042,ALHDMFLG
          ENDIF
.
          MATCH     Z70,ALHDT043
          IF        !@EQUAL
            MOVE      ALHDT043,ALHDCTYP
          ENDIF
.
          MATCH     Z70,ALHDT044
          IF        !@EQUAL
            MOVE      ALHDT044,ALHDEEPR
          ENDIF
.
          MATCH     Z70,ALHDT045
          IF        !@EQUAL
            MOVE      ALHDT045,ALHDCOMP
          ENDIF
.
          MATCH     Z70,ALHDT046
          IF        !@EQUAL
            MOVE      ALHDT046,ALHDPGRP
          ENDIF
.
          MATCH     Z70,ALHDT047
          IF        !@EQUAL
            MOVE      ALHDT047,ALHDPGR1
          ENDIF
.
          MATCH     Z70,ALHDT048
          IF        !@EQUAL
            MOVE      ALHDT048,ALHDPGR2
          ENDIF
.
          MATCH     Z70,ALHDT049
          IF        !@EQUAL
            MOVE      ALHDT049,ALHDPGR3
          ENDIF
.
          MATCH     Z70,ALHDT050
          IF        !@EQUAL
            MOVE      ALHDT050,ALHDPGR4
          ENDIF
.
          MATCH     Z70,ALHDT051
          IF        !@EQUAL
            MOVE      ALHDT051,ALHDDATE
          ENDIF
.
          MATCH     Z70,ALHDT052
          IF        !@EQUAL
            MOVE      ALHDT052,ALHDTIME
          ENDIF
.
          MATCH     Z70,ALHDT053
          IF        !@EQUAL
            MOVE      ALHDT053,ALHDPURP
          ENDIF
.
          MATCH     Z70,ALHDT054
          IF        !@EQUAL
            MOVE      ALHDT054,ALHDSTYP
          ENDIF
.
          MATCH     Z70,ALHDT055
          IF        !@EQUAL
            MOVE      ALHDT055,ALHDPRES
          ENDIF
.
          MATCH     Z70,ALHDT056
          IF        !@EQUAL
            MOVE      ALHDT056,ALHDDMOD
          ENDIF
.
          MATCH     Z70,ALHDT057
          IF        !@EQUAL
            MOVE      ALHDT057,ALHDDSET
          ENDIF
.
          MATCH     Z70,ALHDT058
          IF        !@EQUAL
            MOVE      ALHDT058,ALHDPOFC
          ENDIF
.
          MATCH     Z70,ALHDT059
          IF        !@EQUAL
            MOVE      ALHDT059,ALHDPDPL
          ENDIF
.
          MATCH     Z70,ALHDT060
          IF        !@EQUAL
            MOVE      ALHDT060,ALHDCMOD
          ENDIF
.
          MATCH     Z70,ALHDT061
          IF        !@EQUAL
            MOVE      ALHDT061,ALHDIFLG
          ENDIF
.
          MATCH     Z70,ALHDT062
          IF        !@EQUAL
            MOVE      ALHDT062,ALHDSPCP
          ENDIF
.
          MATCH     Z70,ALHDT063
          IF        !@EQUAL
            MOVE      ALHDT063,ALHDCSET
          ENDIF
.
          MATCH     Z70,ALHDT064
          IF        !@EQUAL
            MOVE      ALHDT064,ALHDCEPR
          ENDIF
.
          MATCH     Z70,ALHDT065
          IF        !@EQUAL
            MOVE      ALHDT065,ALHDRODT
          ENDIF
.
          MATCH     Z70,ALHDT066
          IF        !@EQUAL
            MOVE      ALHDT066,ALHDSERT
          ENDIF
.
          MATCH     Z70,ALHDT067
          IF        !@EQUAL
            MOVE      ALHDT067,ALHDPLAC
          ENDIF
.
          MATCH     Z70,ALHDT068
          IF        !@EQUAL
            MOVE      ALHDT068,ALHDRCNT
          ENDIF
.
          MATCH     Z70,ALHDT069
          IF        !@EQUAL
            MOVE      ALHDT069,ALHDPSIT
          ENDIF
.
          MATCH     Z70,ALHDT070
          IF        !@EQUAL
            MOVE      ALHDT070,ALHDUDT1
          ENDIF
.
          MATCH     Z70,ALHDT071
          IF        !@EQUAL
            MOVE      ALHDT071,ALHDTRGS
          ENDIF
.
          MATCH     Z70,ALHDT072
          IF        !@EQUAL
            MOVE      ALHDT072,ALHDTRGD
          ENDIF
.
          MATCH     Z70,ALHDT073
          IF        !@EQUAL
            MOVE      ALHDT073,ALHDUDT2
          ENDIF
.
          MATCH     Z70,ALHDT074
          IF        !@EQUAL
            MOVE      ALHDT074,ALHDCEDT
          ENDIF
.
          MATCH     Z70,ALHDT075
          IF        !@EQUAL
            MOVE      ALHDT075,ALHDCETM
          ENDIF
.
          MATCH     Z70,ALHDT076
          IF        !@EQUAL
            MOVE      ALHDT076,ALHDSDEP
          ENDIF
.
          MATCH     Z70,ALHDT077
          IF        !@EQUAL
            MOVE      ALHDT077,ALHDRSTA
          ENDIF
.
          MATCH     Z70,ALHDT078
          IF        !@EQUAL
            MOVE      ALHDT078,ALHDDCAN
          ENDIF
.
          MATCH     Z70,ALHDT079
          IF        !@EQUAL
            MOVE      ALHDT079,ALHDRIRD
          ENDIF
.
          MATCH     Z70,ALHDT080
          IF        !@EQUAL
            MOVE      ALHDT080,ALHDRIRS
          ENDIF
.
          MATCH     Z70,ALHDT081
          IF        !@EQUAL
            SQUEEZE   ALHDT081
            IF        @EOS
              MOVE      SP70,ALHDRITS
            ELSE
              MOVE      ZERO,F3               * Store as a number
              MOVE      ALHDT081,F3
              MOVE      F3,ALHDRITS
            ENDIF
          ENDIF
.
          MATCH     Z70,ALHDT082
          IF        !@EQUAL
            MOVE      ALHDT082,ALHDSRDT
          ENDIF
.
          MATCH     Z70,ALHDT083
          IF        !@EQUAL
            MOVE      ALHDT083,ALHDDCLO
          ENDIF
.
MVALHD99  RETURN
.
.------------------------------------------------------------
. Validate Batch Number Remote Script
.-----------------------------------------------------------
RBAT0000  CALL      XMLHED00
          BRANCH    EXIT,RBAT9999
.
          BRANCH    VALDTYPE,RBAT1000,RBAT2000
.
          GOTO      RBAT9100
.    
RBAT1000  PACK      KEY40,BFILNAME,BATCHNUM,SP70
          CALL      RDALHBT1
          BRANCH    OVRCD,RBAT9000
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             ALHBFNAM,"|",ALHBBNUM:
                             "</RETURN_VALUE>"
          GOTO      RBAT9800
.
RBAT2000  PACK      KEY40,BATCHNUM,SP70
          CALL      RSALHBT2
          CALL      RKALHBT2
          BRANCH    OVRCD,RBAT9200
.
          MATCH     BATCHNUM,ALHBBNUM
          GOTO      RBAT9200 IF NOT EQUAL
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             ALHBBNUM,"|",ALHBFNAM:
                             "</RETURN_VALUE>"
          GOTO      RBAT9800
.
RBAT9000  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid batch number for this extract file":
                             "</RETURN_VALUE>"
          GOTO      RBAT9800
.
RBAT9100  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid action":
                             "</RETURN_VALUE>"
          GOTO      RBAT9800
.
RBAT9200  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid batch number - ":
                             BATCHNUM:
                             "</RETURN_VALUE>"
          GOTO      RBAT9800
RBAT9800  CALL      XMLEND00
RBAT9999  RETURN
.
.------------------------------------------------------------
. VINAH Messages By U/R
.------------------------------------------------------------
SACU0000  MATCH     SP70,UPDTTYPE
          GOTO      SACU7000 IF EQUAL
.
          GOTO      SACU9000
.
SACU7000  PACK      KEY8,URNUMBER,SP70      * Patient Referral Details
          CALL      RDMAST1
          IF        OVRCD=1
            CALL      CLPATMAS
          ENDIF
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "VINAH Messages By U/R",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,SACU9999
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      SACU9999
.
SACU9000  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SACU9999
.
SACU9100  MOVE      "Invalid Patient U/R.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SACU9999
.
SACU9999  RETURN
.
.------------------------------------------------------------
.  Selection list of Departments
.----------------------------------------------------------------
DEPSEL00  PACK      PTCDKEY2,ANSC,ANSG,SP70
          CALL      RDSCODE2                      * positional read
DEPSEL10  CALL      RDKCODE2                      * read a record
          BRANCH    OVRCD,DEPSEL99
.
          MATCH     "CG",TCODE
          GOTO      DEPSEL99 IF NOT EQUAL
.
          MATCH     ANSI,TCINDC3                  * Skip IP Departments
          GOTO      DEPSEL10 IF EQUAL
.
          PACK      KEY3,ACODE,SP70
          CALL      RDALDEP1                      * Read department table
          BRANCH    OVRCD,DEPSEL10
.
          MATCH     "1",ALDEACTV
          GOTO      DEPSEL10 IF EQUAL
.
DEPSEL20  MATCH     DEPTCODE,ALDEDEPT
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",ALDEDEPT," selected>":
                          TDESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",ALDEDEPT,">":
                             TDESC,"</option>"
          ENDIF
          GOTO      DEPSEL10
.
DEPSEL99  RETURN
.
.------------------------------------------------------------
. Service Code Selection for a given Department
.------------------------------------------------------------
SRVITH00  UNPACK    DIM127,ANS,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,SRVITH10,SRVITH20
          PACK      KEY9,ALHDDEPT,ALHDPURP,SP70
          CALL      RDALSER1
          IF        OVRCD=0
            WRITE     HTMLFILE;ALSRDESC;
          ENDIF
          GOTO      SRVITH99
.
SRVITH10  WRITE     HTMLFILE;ALHDPURP;
          GOTO      SRVITH99
.
SRVITH20  PACK      KEY9,ALHDDEPT,ALHDPURP,SP70
          CALL      RDALSER1
          BRANCH    OVRCD,SRVITH25
.
          MATCH     "1",ALSRACTV
          IF        !@EQUAL
            WRITE     HTMLFILE;"<option value=",KEY9," selected>":
                               ALSRDESC,"</option>"
          ENDIF
.
SRVITH25  PACK      KEY9,ALHDDEPT,SP70
          CALL      RSALSER1
SRVITH80  CALL      RKALSER1
          BRANCH    OVRCD,SRVITH99
.
          MATCH     ALSRDEPT,ALHDDEPT
          GOTO      SRVITH99 IF NOT EQUAL
.
          MATCH     "1",ALSRACTV
          GOTO      SRVITH80 IF NOT EQUAL
.
          MATCH     "1",ALSRNURA
          GOTO      SRVITH80 IF EQUAL
.
          PACK      KEY9,QUOTE,ALSRSERV,ALSRVACS,QUOTE  * Add VACS Flag
.
          MATCH     ALHDPURP,ALSRSERV
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY9," selected>":
                               ALSRDESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY9,">":
                               ALSRDESC,"</option>"
          ENDIF
          GOTO      SRVITH80
.
SRVITH99  RETURN
.
.-----------------------------------------------------------------------------.
. Update the referral and matching VINAH details                       .
.-----------------------------------------------------------------------------.
ALLEVT00  RESET     UPDTTYPE
          MATCH     SP70,UPDTTYPE
          GOTO      ALLEVT40 IF EQUAL
.
          MATCH     "U",UPDTTYPE            * Update Referral
          GOTO      ALLEVT20 IF EQUAL
.
          MATCH     "E",UPDTTYPE            * Update Encounter
          GOTO      ALLEVT30 IF EQUAL
.
          GOTO      ALLEVT90
.
ALLEVT20  CALL      UPDREF00                * Update Referral
          BRANCH    EXIT,ALLEVT99
.
          MOVE      " 0",USACSTAT           * Update record with waiting status
          CALL      USAC0000                * Update VINAH records
.
          MOVE      " 1",USACSTAT           * Update record with error status
          CALL      USAC0000                * Update VINAH records
.
          MOVE      " 0",USACSTAT           * Update record with waiting status
          CALL      ULNK0000                * Update linked VINAH records
.
          MOVE      " 1",USACSTAT           * Update record with error status
          CALL      ULNK0000                * Update linked VINAH records
          GOTO      ALLEVT99
.
ALLEVT30  CALL      UPDENC00                * Update Encounter
          BRANCH    EXIT,ALLEVT99
.
          MOVE      " 0",USACSTAT           * Update record with waiting status
          CALL      USEN0000                * Update VINAH enc records
.
          MOVE      " 1",USACSTAT           * Update record with error status
          CALL      USEN0000                * Update VINAH enc records
.
          MOVE      " 0",USACSTAT           * Update record with waiting status
          CALL      ULNK0000                * Update linked VINAH records
.
          MOVE      " 1",USACSTAT           * Update record with error status
          CALL      ULNK0000                * Update linked VINAH record
          GOTO      ALLEVT99
.
ALLEVT40  CALL      CURPER00                * Display Routine
          CALL      CALCDT00                * Calculate Next/Last Period Dates
.
          PACK      KEY8,URNUMBER,SP70      * Patient Referral Details
          CALL      RDMAST1
          BRANCH    OVRCD,ALLEVT92
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          BRANCH    OVRCD,ALLEVT92
.
          PACK      KEY8,ADMISSNO,SP70      * Patient Referral Details
          CALL      RDVISA1
          BRANCH    OVRCD,ALLEVT91
.
          PACK      KEY8,ADMISSNO,SP70      * Patient Referral Details
          CALL      RDALREF1
          BRANCH    OVRCD,ALLEVT91
.
          PACK      KEY3,ALREDEPT,SP70
          CALL      RDALDEP1                      * Read department table
          BRANCH    OVRCD,ALLEVT93
.
          MOVE      ALREDEPT,DEPTCODE
          MOVE      ALREDEPT,ALHDDEPT       * Used for department tags
.
          PACK      KEY16,ENCOUTKY,SP70
          CALL      RDALENC1                * Read encounter file
          IF        OVRCD = 1
            CALL      CLALLENC
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Allied Health Referrals/VINAH Update",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,ALLEVT99
          CALL      WEBBOD00   * Process Web Body (calls PROFLD00)
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      ALLEVT99
.
ALLEVT90  MOVE      "Invalid Update Type.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLEVT99
.
ALLEVT91  MOVE      "Invalid Referral.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLEVT99
.
ALLEVT92  MOVE      "Invalid U/R Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLEVT99
.
ALLEVT93  MOVE      "Invalid Department",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLEVT99
.
ALLEVT99  RETURN
.
.******************************************************************************
.*                      Check Correct Files are Open for System               *
.******************************************************************************
OUTFIL00  MOVE      WBSESIT,KEY6
          CALL      RDSITA1
          BRANCH    OVRCD,OUTFIL90
          MATCH     OSTFILE,CFILEPRE        * Save Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE      * Save Current File Prefix
            CALL      OPNOUT00              * Open Outpatient Files
          ENDIF
          MOVE      ZERO,EXIT
          GOTO      OUTFIL99
.
OUTFIL90  MOVE      "Outpatient Site Invalid",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
OUTFIL99  RETURN
.
.------------------------------------------------------------
. Open Outpatient Files
.------------------------------------------------------------
OPNOUT00  CLOSE     OUTCTYA1
          PACK      CFNAME,CFILEPRE,FILCTYA1  * Get the name of the CTYA1 file
          OPEN      OUTCTYA1,CFNAME
.
          CLOSE     OUTCTYA2
          PACK      CFNAME,CFILEPRE,FILCTYA2  * Get the name of the CTYA2 file
          OPEN      OUTCTYA2,CFNAME
.
          CLOSE     OUTCTYA3
          PACK      CFNAME,CFILEPRE,FILCTYA3  * Get the name of the CTYA3 file
          OPEN      OUTCTYA3,CFNAME
.
          CLOSE     OUTCLIA1
          PACK      CFNAME,CFILEPRE,FILCLIA1  * Get the name of the CLIA1 file
          OPEN      OUTCLIA1,CFNAME
.
OPNOUT99  RETURN
.
.******************************************************************************
. Update Referral                                                             *
.******************************************************************************
UPDREF00  MATCH     SP70,DEPTCODE
          GOTO      UPDREF91 IF EQUAL       * Department code is blank
.
          MATCH     SP70,URNUMBER
          GOTO      UPDREF92 IF EQUAL       * U/R Number is blank
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,UPDREF92
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,UPDREF92
.
          MATCH     SP70,ADMISSNO
          GOTO      UPDREF93 IF EQUAL       * Visit/Reff is blank
.
          PACK      KEY3,DEPTCODE,SP70
          CALL      RDALDEP1
          BRANCH    OVRCD,UPDREF91
.
          MATCH     "0",ALDEREFE
          GOTO      UPDREF91 IF EQUAL       * Department not using referral
.
          PACK      KEY8,ADMISSNO,SP70
UPDREF10  CALL      RDALREF1                * read lock
          BRANCH    OVRCD,UPDREF93
.
          MOVE      TWO,AUDTTYPE            * before history record
          CALL      WAALRE00
.
.         * populate the CGI parameters from the screen
          CALL      MVALRE00

          MOVE      DEPTCODE,ALREDEPT       * Deptcode
.
          PACK      ALREUDAT,CCC,CYY,CMM,CDD  * Populate date record updated
          REP       " 0",ALREUDAT
          CLOCK     TIME,ALREUTIM
          MOVE      USERID,ALREUUID
.
          CALL      URMHI000                 * Set MHINC indicator
          CALL      UPALREF1                 * Update the record
.
          CALL      REFU0000                 * Update allrhl
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      ONE,HL7TRGID
          MOVE      SP8,HL7INCLD
          CALL      DGCLII13                * broadcast Update Ref. (REF^I13)
.
UPDREF80  CALL      WRTRAU00
.
          MOVE      THREE,AUDTTYPE          * after history record
          CALL      WAALRE00
.
          MOVE      ZERO,EXIT
          GOTO      UPDREF99
.
UPDREF91  MOVE      "Department does not exist/blank ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDREF99
.
UPDREF92  MOVE      "Invalid UR Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDREF99
.
UPDREF93  MOVE      "Invalid Referral",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDREF99
.
UPDREF99  RETURN
.
.******************************************************************************
. Update Encounter                                                            *
.******************************************************************************
UPDENC00  PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,UPDENC92
.         
          PACK      KEY8,URNUMBER,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,UPDENC92
.         
          MATCH     SP70,ADMISSNO
          GOTO      UPDENC93 IF EQUAL
.         
          MATCH     SP70,ENCOUTKY
          GOTO      UPDENC93 IF EQUAL
.         
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDALREF1 
          BRANCH    OVRCD,UPDREF93
.
          PACK      KEY3,ALREDEPT,SP70
          CALL      RDALDEP1
          BRANCH    OVRCD,UPDENC91
.
          PACK      KEY16,ENCOUTKY,SP70
          CALL      RDALENC1                * Read encounter file
          BRANCH    OVRCD,UPDENC91
.
          MOVE      TWO,AUDTTYPE            * before history record
          CALL      WAALEN00
.
          CALL      MVALEN00                * Move cgi to file vars
          CALL      UPALENC1                * Update encounter
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TWO,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICEU                * write message to broadcast queue
.
          MOVE      THREE,AUDTTYPE          * after history record
          CALL      WAALEN00
.
          MOVE      ZERO,EXIT
          GOTO      UPDENC99
.
UPDENC91  MOVE      "Department does not exist/blank ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDENC99
.
UPDENC92  MOVE      "Invalid UR Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDENC99
.
UPDENC93  MOVE      "Invalid Referral/Contact",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDENC99
.
UPDENC99  RETURN
.
.******************************************************************************
.         MHINC - Update Referral
.******************************************************************************
URMHI000  PACK      KEY5,ANSC,ANSG,ALREDEPT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,URMHI999
.
          MATCH     "M",TCINDC4
          GOTO      URMHI999 IF NOT EQUAL      * Not a Mental Health department
.
          MATCH     "1",ALREUYN4
          GOTO      URMHI999 IF NOT EQUAL      * Not Primary Referral
.
          MATCH     "0",ALREMOHR
          GOTO      URMHI200 IF EQUAL          * Unsent
.
          MATCH     "1",ALREMOHR
          GOTO      URMHI400 IF EQUAL          * Sent
.
          GOTO      URMHI999
.
.         if Closing referral for Unsent - then set indicator to 4
.
URMHI200  MATCH     "2",ALRESTAT
          GOTO      URMHI999 IF NOT EQUAL     * not Close status
.
          MOVE      "4",ALREMOHR              * 'Send RF and Discharge required'
          GOTO      URMHI999
.
.         Already sent
.
URMHI400  MATCH     "2",ALRESTAT
          GOTO      URMHI500 IF EQUAL          * Close Referral
.
          MATCH     "4",ALRESTAT
          GOTO      URMHI600 IF EQUAL          * Cancelled
.
          MATCH     "5",ALRESTAT
          GOTO      URMHI600 IF EQUAL          * Rejected
.
          MOVE      "0",ALREMOHR               * Unsent/Resend
          GOTO      URMHI999
.
URMHI500  MOVE      "3",ALREMOHR               * Send Discharge required
          GOTO      URMHI999
.
URMHI600  MOVE      "2",ALREMOHR               * Send delete
          GOTO      URMHI999
.
URMHI999  RETURN
+
.******************************************************************************
.  Update records with a status of USACSTAT for this referral and 
.  reset the status to waiting
.******************************************************************************
USAC0000  PACK      KEY42,URNUMBER,USACSTAT,ADMISSNO,SP70
          CALL      RSALHDT3
USAC1000  CALL      RKALHDT3
          BRANCH    OVRCD,USAC9000
.
          MATCH     URNUMBER,ALHDURNO
          GOTO      USAC9000 IF NOT EQUAL
.
          MATCH     USACSTAT,ALHDSTAT
          GOTO      USAC9000 IF NOT EQUAL
.
          MATCH     ADMISSNO,ALHDVISN
          GOTO      USAC9000 IF NOT EQUAL
.
          CALL      MHDT0000                     * Move allref to allhdt fields
.
          CALL      DSED0000                     * Delete error records
.
          PACK      SAVKEY42,ALHDURNO,ALHDSTAT,ALHDVISN,ALHDCONT,ALHDDTTM:
                             ALHDRTYP,ALHDACTN,SP70
.
          IF        ALHDSRCE=1
            PACK      KEY42,ALHDSTAT,ALHDURNO,ALHDVISN,ALHDCONT:         
                            ALHDDTTM,ALHDRTYP,ALHDACTN,SP70
            CALL      DEALHDT1
            GOTO      USAC8000
          ENDIF
.
          MOVE      " 0",ALHDSTAT                * Set status to waiting
          CALL      UPALHDT3
.
USAC8000  MOVE      SAVKEY42,KEY42
          CALL      RSALHDT3
.
          GOTO      USAC1000
.
USAC9000  MOVE      ZERO,EXIT
.
USAC9999  RETURN
.
.******************************************************************************
.  Update records with a status of USACSTAT for this encounter and
.  reset the status to waiting
.******************************************************************************
USEN0000  PACK      KEY42,URNUMBER,USACSTAT,ADMISSNO,ALENENCT,SP70
          CALL      RSALHDT3
USEN1000  CALL      RKALHDT3
          BRANCH    OVRCD,USEN9000
.
          MATCH     URNUMBER,ALHDURNO
          GOTO      USEN9000 IF NOT EQUAL
.
          MATCH     USACSTAT,ALHDSTAT
          GOTO      USEN9000 IF NOT EQUAL
.
          MATCH     ADMISSNO,ALHDVISN
          GOTO      USEN9000 IF NOT EQUAL
.
          MATCH     ALENENCT,ALHDCONT
          GOTO      USEN9000 IF NOT EQUAL
.
          MATCH     SP70,ALHDCOMP                * Account Class
          IF        @EQUAL|FORCEFLG=1
            MOVE      ALENCOMP,ALHDCOMP        
          ENDIF
.
          MATCH     SP70,ALHDPGRP                * Contact prof. Group 0
          IF        @EQUAL|FORCEFLG=1
            MOVE      ALENHCP,ALHDPGRP        
          ENDIF
.
          MATCH     SP70,ALHDPGR1                * Contact Prof. Group 1
          IF        @EQUAL|FORCEFLG=1
            MOVE      ALENUHC1,ALHDPGR1        
          ENDIF
.
          MATCH     SP70,ALHDPGR2                * Contact Prof. Group 2
          IF        @EQUAL|FORCEFLG=1
            MOVE      ALENUHC2,ALHDPGR2        
          ENDIF
.
          MATCH     SP70,ALHDPGR3                * Contact Prof. Group 3
          IF        @EQUAL|FORCEFLG=1
            MOVE      ALENUHC3,ALHDPGR3        
          ENDIF
.
          MATCH     SP70,ALHDPGR4                * Contact Prof. Group 4
          IF        @EQUAL|FORCEFLG=1
            MOVE      ALENUHC4,ALHDPGR4        
          ENDIF
.
          MATCH     SP70,ALHDPURP                * Main purpose 
          IF        @EQUAL|FORCEFLG=1
            MOVE      ALENUC34,ALHDPURP        
          ENDIF
.
          MATCH     SP70,ALHDSTYP
          IF        @EQUAL|FORCEFLG=1
            MOVE      ALENUC35,ALHDSTYP          * Session Type
          ENDIF
.
          MATCH     SP70,ALHDPRES
          IF        @EQUAL|FORCEFLG=1
            MOVE      ALENUC37,ALHDPRES          * Present Status
          ENDIF
.
          MATCH     SP70,ALHDDMOD
          IF        @EQUAL|FORCEFLG=1
            MOVE      ALENUC38,ALHDDMOD          * Delivery Mode
          ENDIF
.
          MATCH     SP70,ALHDDSET
          IF        @EQUAL|FORCEFLG=1
            MOVE      ALENUC40,ALHDDSET          * Delivery Setting
          ENDIF
.
          MATCH     SP70,ALHDPOFC
          IF        @EQUAL|FORCEFLG=1
            MOVE      ALENUC31,ALHDPOFC          * Phase of Care   
          ENDIF
.
          MATCH     SP70,ALHDPDPL
          IF        @EQUAL|FORCEFLG=1
            MOVE      ALENUC08,ALHDPDPL          * Pref Death Place
          ENDIF
.
          MATCH     SP70,ALHDCMOD
          IF        @EQUAL|FORCEFLG=1
            MOVE      ALENUC06,ALHDCMOD          * Care Model
          ENDIF
.
          MATCH     SP70,ALHDSPCP
          IF        @EQUAL|FORCEFLG=1
            MOVE      ALENUHC1,ALHDSPCP          * Palliative Care Provider
          ENDIF
.
          MATCH     SP70,ALHDCSET
          IF        @EQUAL|FORCEFLG=1
            MOVE      ALENUC07,ALHDCSET          * Care Setting
          ENDIF
.
          MATCH     SP70,ALHDCEPR
          IF        @EQUAL|FORCEFLG=1
            MOVE      ALENUC33,ALHDCEPR          * Event Program 
          ENDIF
.
          MATCH     SP70,ALHDCEDT
          IF        @EQUAL|FORCEFLG=1
            MOVE      ALENUDT1,ALHDCEDT          * Contact End Date
            MOVE      ALENUTM1,ALHDCETM          * Contact End Time
          ENDIF
.
...       MATCH     SP70,ALHDSDEP
...       IF        @EQUAL|FORCEFLG=1
...         MOVE      ALENSDEP,ALHDSDEP          * Contact service department
...       ENDIF
.
          PACK      SAVKEY42,ALHDURNO,ALHDSTAT,ALHDVISN,ALHDCONT,ALHDDTTM:
                             ALHDRTYP,ALHDACTN,SP70
.
          CALL      DSED0000                   * Delete error records
.
          IF        ALHDSRCE=1
            PACK      KEY42,ALHDSTAT,ALHDURNO,ALHDVISN,ALHDCONT:
                            ALHDDTTM,ALHDRTYP,ALHDACTN,SP70
            CALL      DEALHDT1
            GOTO      USEN8000
          ENDIF
.
          MOVE      " 0",ALHDSTAT                * Set status to waiting
          CALL      UPALHDT3
.
USEN8000  MOVE      SAVKEY42,KEY42
          CALL      RSALHDT3
.
          GOTO      USEN1000
.
USEN9000  MOVE      ZERO,EXIT
.
USEN9999  RETURN
.
.******************************************************************************
. Update records with a status of USACSTAT for this linked referral visit
. and reset the status to waiting
.******************************************************************************
ULNK0000  PACK      KEY42,URNUMBER,USACSTAT,SP70
          CALL      RSALHDT3
ULNK1000  CALL      RKALHDT3
          BRANCH    OVRCD,ULNK9000
.
          MATCH     URNUMBER,ALHDURNO
          GOTO      ULNK9000 IF NOT EQUAL
.
          MATCH     USACSTAT,ALHDSTAT           * Printer error
          GOTO      ULNK9000 IF NOT EQUAL
.
          MATCH     ADMISSNO,ALHDLINK       * Linked referral visit
          GOTO      ULNK1000 IF NOT EQUAL
.
          PACK      SAVKEY42,ALHDURNO,ALHDSTAT,ALHDVISN,ALHDCONT,ALHDDTTM:
                             ALHDRTYP,ALHDACTN,SP70
.
          CALL      MHDT0000                   * Move allref to allhdt fields
.
          CALL      DSED0000                   * Delete error records
.
          IF        ALHDSRCE=1
            PACK      KEY42,ALHDSTAT,ALHDURNO,ALHDVISN,ALHDCONT:
                            ALHDDTTM,ALHDRTYP,ALHDACTN,SP70
            CALL      DEALHDT1
            GOTO      ULNK8000
          ENDIF
.
          MOVE      " 0",ALHDSTAT                * Set status to waiting
          CALL      UPALHDT3
.
ULNK8000  MOVE      SAVKEY42,KEY42
          CALL      RSALHDT3
.
          GOTO      ULNK1000
.
ULNK9000  MOVE      ZERO,EXIT
.
ULNK9999  RETURN
.******************************************************************************
.  Populate allhdtaf fields with the correct allrefaf fields
.******************************************************************************
MHDT0000  MATCH     "1",ALREUYN4                 * Referral in
          GOTO      MHDT5000 IF NOT EQUAL
.
. Referral in and pmi related fields
.
          MATCH     SP70,ALHDCRST
          IF        @EQUAL|FORCEFLG=1
            MOVE      ALREUC35,ALHDCRST          * Carer residency
          ENDIF
.
          MATCH     SP70,ALHDCAVL
          IF        @EQUAL|FORCEFLG=1
            MOVE      ALREUC36,ALHDCAVL          * Carer availability
          ENDIF
.
          MATCH     SP70,ALHDLARR
          IF        @EQUAL|FORCEFLG=1
            MOVE      ALREUC38,ALHDLARR          * Living arrangement
          ENDIF
.
          MATCH     SP70,ALHDUACC
          IF        @EQUAL|FORCEFLG=1
            MOVE      ALREUC39,ALHDUACC          * Usual accommodation
          ENDIF
.
          MATCH     SP70,ALHDMREL
          IF        @EQUAL|FORCEFLG=1
            MOVE      ALREUC31,ALHDMREL          * Carer relationship
          ENDIF
.
          MATCH     SP70,ALHDDTHP
          IF        @EQUAL|FORCEFLG=1
            MOVE      ALREUC10,ALHDDTHP          * Death place
          ENDIF
.
          MATCH     SP70,ALHDRDAT
          IF        @EQUAL|FORCEFLG=1
            MOVE      ALREDREC,ALHDRDAT          * Ref in received date
          ENDIF
.
          MATCH     SP70,ALHDOTRR
          IF        @EQUAL|FORCEFLG=1
            MOVE      ALRESREJ,ALHDOTRR          * Ref in outcome rejection
          ENDIF
.
          MATCH     SP70,ALHDOTRC
          IF        @EQUAL|FORCEFLG=1
            MOVE      ALRERCAN,ALHDOTRC          * Ref in outcome cancellation
          ENDIF
.
          MATCH     SP70,ALHDOUTC
          IF        @EQUAL|FORCEFLG=1
            MOVE      ALRESTAT,ALHDOUTC          * Referral in outcome
            MOVE      ALREDCAN,ALHDDCAN          * Referral-In Cancellation Date
            MOVE      ALRESRDT,ALHDSRDT          * Referral-In Rejected Date
            MOVE      ALREDCLO,ALHDDCLO          * Referral-In Closed Date
          ENDIF
.
          MATCH     SP70,ALHDCLUC
          IF        @EQUAL|FORCEFLG=1
            MOVE      ALREPRTY,ALHDCLUC          * Priority
          ENDIF
.
          MATCH     SP70,ALHDCRDT
          IF        @EQUAL|FORCEFLG=1
            MOVE      ALREUDT3,ALHDCRDT          * Ref in clinical ref date
          ENDIF
.
          MATCH     SP70,ALHDRADT
          IF        @EQUAL|FORCEFLG=1
            MOVE      ALREUDT5,ALHDRADT          * Ref in receipt ack date
          ENDIF
.
          MATCH     SP70,ALHDTRGS
          IF        @EQUAL|FORCEFLG=1
            MOVE      ALRETRGS,ALHDTRGS          * Referral-In Triage Status
          ENDIF
.
          MATCH     SP70,ALHDTRGD
          IF        @EQUAL|FORCEFLG=1
            MOVE      ALRETRGD,ALHDTRGD          * Referral-In Triage Date
          ENDIF
.
          MATCH     SP70,ALHDRITS
          IF        @EQUAL|FORCEFLG=1
            MOVE      ALREFTSC,ALHDRITS          * Referral-In Triage Score
          ENDIF
.
          MATCH     SP70,ALHDRIRD
          IF        @EQUAL|FORCEFLG=1
            MATCH     Z70,REFIRDEP
            IF        !@EQUAL
              MOVE      REFIRDEP,ALHDRIRD        * Referral-In Reason Department
            ENDIF
            MATCH     Z70,REFIRCOD
            IF        !@EQUAL
              MOVE      REFIRCOD,ALHDRIRS        * Referral-In Reason Code
            ENDIF
          ENDIF
.
          MATCH     SP70,ALHDRIRS
          IF        @EQUAL|FORCEFLG=1
            MATCH     Z70,REFIRDEP
            IF        !@EQUAL
              MOVE      REFIRDEP,ALHDRIRD        * Referral-In Reason Department
            ENDIF
            MATCH     Z70,REFIRCOD
            IF        !@EQUAL
              MOVE      REFIRCOD,ALHDRIRS        * Referral-In Reason Code
            ENDIF
          ENDIF
.
          GOTO      MHDT9999
.
. Episode referral related fields
.
MHDT5000  MATCH     SP70,ALHDSDAT
          IF        @EQUAL|FORCEFLG=1
            MOVE      ALREDACT,ALHDSDAT          * Episode start date
          ENDIF
.
          MATCH     SP70,ALHDEDAT
          IF        @EQUAL|FORCEFLG=1
            MOVE      ALREDCLO,ALHDEDAT          * Episde end date
          ENDIF
.
          MATCH     SP70,ALHDFCFL
          IF        @EQUAL|FORCEFLG=1
            MOVE      ALREUYN5,ALHDFCFL          * First consultancy
          ENDIF
.
          MATCH     SP70,ALHDCPPT
          IF        @EQUAL|FORCEFLG=1
            MOVE      ALREUC33,ALHDCPPT          * Program completion
          ENDIF
.
          MATCH     SP70,ALHDIODT
          IF        @EQUAL|FORCEFLG=1
            MOVE      ALREEIOD,ALHDIODT          * Impairment onset
          ENDIF
.
          MATCH     SP70,ALHDACDD
          IF        @EQUAL|FORCEFLG=1
            MOVE      ALREACDD,ALHDACDD          * Adv care plan documented
          ENDIF
.
          MATCH     SP70,ALHDCPDD
          IF        @EQUAL|FORCEFLG=1
            MOVE      ALREUDT4,ALHDCPDD          * Care plan documented
          ENDIF
.
          MATCH     SP70,ALHDFABD
          IF        @EQUAL|FORCEFLG=1
            MOVE      ALREUDT8,ALHDFABD          * Fist appt booked
          ENDIF
.
          MATCH     SP70,ALHDHDDT
          IF        @EQUAL|FORCEFLG=1
            MOVE      ALREUD10,ALHDHDDT          * Hospital discharge
          ENDIF
.
          MATCH     SP70,ALHDFNAD
          IF        @EQUAL|FORCEFLG=1
            MOVE      ALREUDT9,ALHDFNAD          * First notified of app
          ENDIF
.
          MATCH     SP70,ALHDENDR
          IF        @EQUAL|FORCEFLG=1
            MOVE      ALRERCLO,ALHDENDR          * Episode end reason
          ENDIF
.
          MATCH     SP70,ALHDMFLG
          IF        @EQUAL|FORCEFLG=1
            MOVE      ALREYN10,ALHDMFLG          * Malignancy
          ENDIF
.
          MATCH     SP70,ALHDPSIT
          IF        @EQUAL|FORCEFLG=1
            MOVE      ALREPSIT,ALHDPSIT          * Preferred site
            MOVE      ALRECTYP,ALHDCTYP          * Clinic type
          ENDIF
.
          MATCH     SP70,ALHDCTYP
          IF        @EQUAL|FORCEFLG=1
            MOVE      ALREPSIT,ALHDPSIT          * Preferred site
            MOVE      ALRECTYP,ALHDCTYP          * Clinic type
          ENDIF
.
          MATCH     SP70,ALHDEEPR
          IF        @EQUAL|FORCEFLG=1
            MOVE      ALREEVPR,ALHDEEPR          * Event program
          ENDIF
.
          MATCH     SP70,ALHDUDT1
          IF        @EQUAL|FORCEFLG=1
            MOVE      ALREUDT1,ALHDUDT1          * User Def. Date 1 (CCYYMMDD)
          ENDIF
.
          MATCH     SP70,ALHDTRGS
          IF        @EQUAL|FORCEFLG=1
            MOVE      ALRETRGS,ALHDTRGS          * Referral-In Triage Status
          ENDIF
.
          MATCH     SP70,ALHDTRGD
          IF        @EQUAL|FORCEFLG=1
            MOVE      ALRETRGD,ALHDTRGD          * Episode Referral Triage Date
          ENDIF
.
          MATCH     SP70,ALHDUDT2
          IF        @EQUAL|FORCEFLG=1
            MOVE      ALREUDT2,ALHDUDT2          * Episode Ready for Care Date
          ENDIF
.
          MATCH     SP70,ALHDRIRD
          IF        @EQUAL|FORCEFLG=1
            MATCH     Z70,REFIRDEP
            IF        !@EQUAL
              MOVE      REFIRDEP,ALHDRIRD        * Referral-In Reason Department
            ENDIF
            MATCH     Z70,REFIRCOD
            IF        !@EQUAL
              MOVE      REFIRCOD,ALHDRIRS        * Referral-In Reason Code
            ENDIF
          ENDIF
.
          MATCH     SP70,ALHDRIRS
          IF        @EQUAL|FORCEFLG=1
            MATCH     Z70,REFIRDEP
            IF        !@EQUAL
              MOVE      REFIRDEP,ALHDRIRD        * Referral-In Reason Department
            ENDIF
            MATCH     Z70,REFIRCOD
            IF        !@EQUAL
              MOVE      REFIRCOD,ALHDRIRS        * Referral-In Reason Code
            ENDIF
          ENDIF
.
MHDT9999  RETURN
.
.******************************************************************************
.  Reset all error records back to waiting or delete
.******************************************************************************
RESE0000  PACK      KEY42,SP1,ONE,SP70
          CALL      RSALHDT1
          CALL      RKALHDT1
          BRANCH    OVRCD,RESE9999
.
          MATCH     " 1",ALHDSTAT                * Error record
          GOTO      RESE9999 IF NOT EQUAL
.
. Delete error records with a record source of VINAHEXT
.
          CALL      DSED0000                   * Delete error records
.
          IF        ALHDSRCE=1
            PACK      KEY42,ALHDSTAT,ALHDURNO,ALHDVISN,ALHDCONT:
                            ALHDDTTM,ALHDRTYP,ALHDACTN,SP70
            CALL      DEALHDT1
            GOTO      RESE0000
          ENDIF
.
          PACK      SAVKEY42,ALHDSTAT,ALHDURNO,ALHDVISN,ALHDCONT:
                             ALHDDTTM,ALHDRTYP,ALHDACTN,SP70
.
          MOVE      " 0",ALHDSTAT              * Update status to waiting
          PACK      KEY42,ALHDSTAT,ALHDURNO,ALHDVISN,ALHDCONT:
                          ALHDDTTM,ALHDRTYP,ALHDACTN,SP70
          CALL      RAALHDT1                   * Check for a duplicate
          IF        OVRCD<>1
            CALL      DEALHDT1                 * Delete duplicate waiting
          ENDIF                                * record as it will re created
.
          PACK      KEY42,SAVKEY42,SP70
          CALL      RDALHDT1                   * Restore orginal record
          BRANCH    OVRCD,RESE0000
.
          MOVE      " 0",ALHDSTAT              * Update status to waiting
          CALL      UPALHDT1
.
          GOTO      RESE0000
.
RESE9999  RETURN
.
.******************************************************************************
.      write a record to the Referral Audit Table
.******************************************************************************
WRTRAU00  CALL      CLALLAUD                     * clear allaudaf variables
.
          MOVE      ALREVISN,ALAUVISN
          PACK      ALAUADAT,CCC,CYY,CMM,CDD
          REP       " 0",ALAUADAT
          CLOCK     TIME,ALAUATIM
          MOVE      "U",ALAUUPDT            * Updated
          MOVE      WBSEUID,ALAUAUID
.
          PACK      AUDITKEY,ALAUVISN,ALAUADAT,ALAUATIM,SP70
          PACK      KEY24,ALAUVISN,ALAUADAT,ALAUATIM,SP70
          CALL      RDALAUD1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            CALL      WRALAUD1                * write to the file
            TRAPCLR   IO
            BRANCH    OVRCD,WRTRAU99
          ENDIF
.
WRTRAU99  RETURN
.
.******************************************************************************
.  Display error detail for a VINAH allhdtaf record 
.******************************************************************************
ETAB0000  MOVE      SP70,SAVERRID
          PACK      SAVEDESC,SP70,SP70
.
          PACK      KEY57,ALHDURNO,ALHDVISN,ALHDCONT,ALHDDTTM,ALHDMTYP,SP3
          CALL      RSALSED1
ETAB1000  CALL      RKALSED1
          BRANCH    OVRCD,ETAB9999
.
          MATCH     ALHDURNO,ALSEURNO
          GOTO      ETAB9999 IF NOT EQUAL
.
          MATCH     ALHDVISN,ALSEVISN
          GOTO      ETAB9999 IF NOT EQUAL
.
          MATCH     ALHDCONT,ALSEENCT
          GOTO      ETAB9999 IF NOT EQUAL
.
          MATCH     ALHDDTTM,ALSEDTTM
          GOTO      ETAB9999 IF NOT EQUAL
.
          MATCH     ALHDMTYP,ALSEMTYP
          GOTO      ETAB9999 IF NOT EQUAL
.
          MATCH     SP70,ALSEERID
          IF        @EQUAL
            WRITE     HTMLFILE;ALSEDESC
          ELSE
            MATCH     SAVERRID,ALSEERID     * Same error id as previous line
            IF        @EQUAL
              MATCH     SAVEDESC,ALSEDESC   * Don't show duplicate errors
              IF        !@EQUAL
                WRITE     HTMLFILE;ALSEDESC
              ENDIF
            ELSE
              STRIP     ALSEERID
              WRITE     HTMLFILE;*+,ALSEERID,*-," - ",ALSEDESC
            ENDIF
          ENDIF
.
          MOVE      ALSEERID,SAVERRID
          MOVE      ALSEDESC,SAVEDESC
          GOTO      ETAB1000
.
ETAB9999  RETURN
.
.------------------------------------------------------------
. General tags
.------------------------------------------------------------
GTAG0000  BRANCH    FLDITMNO,GTAG0010,GTAG0020,GTAG0030,GTAG0040,GTAG0050:
                             GTAG0060,GTAG0070,GTAG0080,GTAG0090,GTAG0100:
                             GTAG0110,GTAG0120,GTAG0130,GTAG0140,GTAG0150:
                             GTAG0160,GTAG0170,GTAG0180
.
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      GTAG9999
.
GTAG0010  WRITE     HTMLFILE;ENCOUTKY;
          GOTO      GTAG9999
.
GTAG0020  MOVE      "lF",CATEGORY
          MOVE      ALDEPRGS,CODE
          CALL      CODITM00
          GOTO      GTAG9999
.
GTAG0030  PACK      KEY13,ADMISSNO,ZERO,FOUR,SP1,SP1,ONE,SP70
          CALL      RDALRHL1
          IF        OVRCD=ONE
            MOVE      SP70,ALRHCODE
          ENDIF
.
          MOVE      "zU",CATEGORY
          MOVE      ALRHCODE,CODE
          CALL      CODITM00
          GOTO      GTAG9999
.
GTAG0040  CALL      ALDEDT00            * Other Allied Health Department flags
          GOTO      GTAG9999
.
GTAG0050  CALL      CASS0000            * Check if visit has any assessments
          GOTO      GTAG9999
.
GTAG0060  PACK      SAVMSGKY,ALHDSTAT,ALHDURNO,ALHDVISN,ALHDCONT:
                             ALHDDTTM,ALHDRTYP,ALHDACTN,SP70
          PROC      CRTREFUP
          GOTO      GTAG9999
.
GTAG0070  CALL      EXDEPT00                 * Extra Department tags
          GOTO      GTAG9999
.
GTAG0080  WRITE     HTMLFILE;ALRIOKEY;       * Referral in outcome record key
          GOTO      GTAG9999
.
GTAG0090  WRITE     HTMLFILE;ALRIVISN;       * Visit Number
          GOTO      GTAG9999
.
GTAG0100  MATCH     SP70,ALRIDATE            * Date of Change
          GOTO      GTAG9999 IF EQUAL
.
          UNPACK    ALRIDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      GTAG9999
.
GTAG0110  WRITE     HTMLFILE;ALRITIME;       * Time of Change
          GOTO      GTAG9999
.
GTAG0120  WRITE     HTMLFILE;ALRIOUTC;       * Referral In Outcome
          GOTO      GTAG9999
.
GTAG0130  CALL      REFOUT00                 * Referral in outcome list
          GOTO      GTAG9999
.
GTAG0140  CALL      OUTDSC00                 * Referral in outcome
          WRITE     HTMLFILE;OUTCDESC;
          GOTO      GTAG9999
.
GTAG0150  MOVE      ADMISSNO,VISITNUM        * load referral in visit no.
          CALL      FRSTLKKK                 * Get referral in reason
.
          UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,GTAG0155

          MOVE      "CG",CATEGORY
          MOVE      SAVERIRD,CODE
          CALL      GETCOD00
          WRITE     HTMLFILE;TDESC;           * Ref-In Reason Dep
          GOTO      GTAG9999
.
GTAG0155  WRITE     HTMLFILE;SAVERIRD;         * Ref-In Reason Dep Code
          GOTO      GTAG9999
.
GTAG0160  MOVE      ADMISSNO,VISITNUM          * load referral in visit no.
          CALL      FRSTLKKK                   * Get referral in reason
.
          UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,GTAG0165

          MATCH     SP70,SAVERIRS              * No referral in reason
          GOTO      GTAG9999 IF EQUAL
.
          PACK      KEY12,SAVERIRD,SAVERIRS,SP70
          CALL      RDALPRR1
          BRANCH    OVRCD,GTAG9999
.          
          WRITE     HTMLFILE;ALPRDESC;         * Ref-In Reason 
          GOTO      GTAG9999
.
GTAG0165  WRITE     HTMLFILE;SAVERIRS;         * Ref-In Reason Code
          GOTO      GTAG9999
.
GTAG0170  MOVE      URNUMBER,CONTURNO       * Patient UR number
          MOVE      ALENSDAT,CONTDATE       * Date of Contact
          MOVE      ALENSTIM,CONTTIME       * Time of Contact
          MOVE      ALENUC40,CONTDSET       * Contact Delvery Setting
          CALL      INPF0000                * check if patient was admmitted
          GOTO      GTAG9999
.
GTAG0180  MOVE      URNUMBER,CONTURNO       * Patient UR number
          MOVE      ALENSDAT,CONTDATE       * Date of Contact
          MOVE      ALENSTIM,CONTTIME       * Time of Contact
          MOVE      SP70,CONTDSET           * Ignore Contact Delvery Setting
          CALL      INPF0000                * check if patient was admmitted
          GOTO      GTAG9999
.
GTAG9999  RETURN
.
+
.******************************************************************************
. Extra Allied Health department details
.******************************************************************************
EXDEPT00  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          PACK      KEY3,ALHDDEPT,SP70
          CALL      RDALDEP1
          BRANCH    OVRCD,EXDEPT99
.
          BRANCH    F1,EXDEPT01,EXDEPT02,EXDEPT03,EXDEPT04,EXDEPT05
          GOTO      EXDEPT99
.
EXDEPT01  WRITE     HTMLFILE;ALDESITE;      * OP Site
          GOTO      EXDEPT99
.
EXDEPT02  WRITE     HTMLFILE;ALDECTYP;      * OP Clinic Type
          GOTO      EXDEPT99
.
EXDEPT03  WRITE     HTMLFILE;ALDEUTRS;      * Using Triage Status (VINAH)
          GOTO      EXDEPT99
.
EXDEPT04  WRITE     HTMLFILE;ALDEUPRT;      * Using Priority (VINAH)
          GOTO      EXDEPT99
.
EXDEPT05  MOVE      "lF",CATEGORY           * Episode/Program stream
          MOVE      ALDEPRGS,CODE
          CALL      CODITM00
          GOTO      EXDEPT99
.
EXDEPT99  RETURN
.
.---------------------------------------------------------------------
. Perform edit checks to see if it is ok to update the file status
.---------------------------------------------------------------------
ESTA0000  MATCH     "3",ALHHSTAT                  * Accepted with rejections
          GOTO      ESTA9100 IF EQUAL
.
          MATCH     "5",ALHHSTAT                  * Rejections dealt with
          GOTO      ESTA9100 IF EQUAL
.
ESTA9000  MOVE      ZERO,EXIT
          GOTO      ESTA9999
.
ESTA9100  MOVE      "Invalid File Status Update.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ESTA9999
.
ESTA9999  RETURN
.
.---------------------------------------------------------------------
. Perform edit checks to see if it is ok to update the batch status
.---------------------------------------------------------------------
BEDT0000  MATCH     "3",ALHBSTAT                  * Resubmitted
          GOTO      BEDT9100 IF EQUAL
.
          MATCH     "5",ALHBSTAT                  * Rejections resubmitted
          GOTO      BEDT9100 IF EQUAL
.         
BEDT9000  MOVE      ZERO,EXIT
          GOTO      BEDT9999
.
BEDT9100  MOVE      "Invalid Batch Status Update.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      BEDT9999
.
BEDT9999  RETURN
.
.---------------------------------------------------------------------
. Update the batch record status for all batches in this file
.---------------------------------------------------------------------
UBAT0000  MATCH     "3",ALHHSTAT                 * Accepted with rejections
          GOTO      UBAT9999 IF EQUAL
.
          MATCH     "5",ALHHSTAT                 * Rejections dealt with 
          GOTO      UBAT9999 IF EQUAL
.
          PACK      KEY40,ALHHFNAM,SP70
          CALL      RSALHBT1
UBAT1000  CALL      RKALHBT1
          BRANCH    OVRCD,UBAT9999 
.
          MATCH     ALHHFNAM,ALHBFNAM
          GOTO      UBAT9999 IF NOT EQUAL
.
          MATCH     "0",SAVFSTAT                 * Changing from Extracted
          IF        @EQUAL
            MATCH     "0",ALHBSTAT
            GOTO      UBAT8000 IF EQUAL
          ENDIF
.
          MATCH     "1",SAVFSTAT                 * Changing from Submitted
          IF        @EQUAL
            MATCH     "1",ALHBSTAT
            GOTO      UBAT8000 IF EQUAL
          ENDIF
.
          MATCH     "2",SAVFSTAT                 * Changing from Rejected
          IF        @EQUAL
            MATCH     "2",ALHBSTAT
            GOTO      UBAT8000 IF EQUAL
          ENDIF
.
          MATCH     "4",SAVFSTAT                 * Changing from Accepted
          IF        @EQUAL
            MATCH     "4",ALHBSTAT
            GOTO      UBAT8000 IF EQUAL
          ENDIF
.
          GOTO      UBAT1000
.
UBAT8000  MOVE      ALHBSTAT,SAVBSTAT       * Save the original batch status
          MOVE      ALHHSTAT,ALHBSTAT       * Update batch with file status
.
          CALL      UPALHBT1
.
          CALL      UMES0000                * Update message status for batch
          GOTO      UBAT1000
.
UBAT9999  RETURN
.
.---------------------------------------------------------------------
. Update the message record status for a batch
.---------------------------------------------------------------------
UMES0000   PACK     KEY62,ALHBBNUM,SP70
           CALL     RSALHDT2
UMES1000   CALL     RKALHDT2
           BRANCH   OVRCD,UMES9999
.
           MATCH    ALHBBNUM,ALHDBNUM
           GOTO     UMES9999 IF NOT EQUAL
.
           MATCH    " 1",ALHDSTAT           * Don't change the status of 
           GOTO     UMES1000 IF EQUAL       * records that have an ignore status
.
           MATCH    " 2",ALHDSTAT
           GOTO     UMES1000 IF EQUAL
.
           MATCH    " 3",ALHDSTAT
           GOTO     UMES1000 IF EQUAL
.
           MATCH    " 4",ALHDSTAT
           GOTO     UMES1000 IF EQUAL
.
           MATCH    " 5",ALHDSTAT
           GOTO     UMES1000 IF EQUAL
.
           PACK     SAVKEY62,ALHDBNUM,ALHDSTAT,ALHDURNO,ALHDVISN,ALHDCONT:
                             ALHDDTTM,ALHDRTYP,ALHDACTN,SP70
.
           MATCH    "0",SAVBSTAT            * Changing from Extracted
           IF       @EQUAL
             MATCH    " 6",ALHDSTAT
             GOTO     UMES8000 IF EQUAL
           ENDIF
.
           MATCH    "1",SAVBSTAT            * Changing from Submittted
           IF       @EQUAL
             MATCH    " 7",ALHDSTAT
             GOTO     UMES8000 IF EQUAL
           ENDIF
.
           MATCH    "2",SAVBSTAT            * Changing from Rejected
           IF       @EQUAL
             MATCH    " 8",ALHDSTAT
             GOTO     UMES8000 IF EQUAL
           ENDIF
.
           MATCH    "2",SAVBSTAT            * Changing from Rejected
           IF       @EQUAL
             MATCH    "99",ALHDSTAT         * Message status removed
             GOTO     UMES8000 IF EQUAL
           ENDIF
.
           MATCH    "4",SAVBSTAT            * Changing from Accepted
           IF       @EQUAL
             MATCH    "10",ALHDSTAT 
             GOTO     UMES8000 IF EQUAL
           ENDIF
.
           GOTO     UMES1000
.
UMES8000   MATCH    "0",ALHBSTAT
           IF       @EQUAL
             MOVE     " 6",ALHDSTAT         * Changing to Extracted
           ENDIF
.
           MATCH    "1",ALHBSTAT
           IF       @EQUAL
             MOVE     " 7",ALHDSTAT         * Changing to Submitted
           ENDIF
.
           MATCH    "2",ALHBSTAT
           IF       @EQUAL
             MOVE     " 8",ALHDSTAT         * Changing to Rejected
           ENDIF
.
           MATCH    "4",ALHBSTAT
           IF       @EQUAL
             MOVE     "10",ALHDSTAT         * Changing to Accepted
           ENDIF
.
           CALL     UPALHDT2
. 
           MOVE     SAVKEY62,KEY62
           CALL     RSALHDT2
.
           GOTO     UMES1000
.
UMES9999  RETURN
.
.------------------------------------------------------------
. Clinic Type List
.------------------------------------------------------------
HDTCTY00  PACK      KEY42,WBSESIT,SP70
          CALL      RDSCTYA2
HDTCTY10  CALL      RDKCTYA2
          BRANCH    OVRCD,HDTCTY99
.
          MATCH     OCTSITE,WBSESIT
          GOTO      HDTCTY99 IF NOT EQUAL
.
          MATCH     "1",OCTACT
          GOTO      HDTCTY10 IF EQUAL
.
          MATCH     ALHDCTYP,OCTCTYP
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",OCTCTYP,"#" selected>":
                               OCTDESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"",OCTCTYP,"#">":
                               OCTDESC,"</option>"
          ENDIF
          GOTO      HDTCTY10
.
HDTCTY99  RETURN
.
.******************************************************************************
.  Delete all error detail records for this message
.******************************************************************************
DSED0000  PACK      KEY57,ALHDURNO,ALHDVISN,ALHDCONT,ALHDDTTM,ALHDMTYP,SP70
          CALL      RSALSED1
          CALL      RKALSED1
          BRANCH    OVRCD,DSED9999
.
          MATCH     ALHDURNO,ALSEURNO
          GOTO      DSED9999 IF NOT EQUAL
.
          MATCH     ALHDVISN,ALSEVISN
          GOTO      DSED9999 IF NOT EQUAL
.
          MATCH     ALHDCONT,ALSEENCT
          GOTO      DSED9999 IF NOT EQUAL
.
          MATCH     ALHDDTTM,ALSEDTTM
          GOTO      DSED9999 IF NOT EQUAL
.
          MATCH     ALHDMTYP,ALSEMTYP
          GOTO      DSED9999 IF NOT EQUAL
.
          PACK      KEY57,ALSEURNO,ALSEVISN,ALSEENCT,ALSEDTTM,ALSEMTYP,ALSEERID:
                          ALSEECNT,SP70
          CALL      DEALSED1
          GOTO      DSED0000          
.
DSED9999  RETURN
.
.------------------------------------------------------------
.         REFU0000 - Update allrhl
.------------------------------------------------------------
REFU0000  PACK      KEY13,ADMISSNO,ZERO4,SP1,SP1,ONE,SP70
          CALL      RDALRHL1
          BRANCH    OVRCD,REFU5000
.
          MATCH     SP70,RFDAT001
          IF        !@EQUAL
            PACK      ALRHDATE,RFDAT001
          ENDIF
.
          PACK      ALRHCODE,RFDTR001
          PACK      ALRHCOD2,RFDPL001
.
          CALL      UPALRHL1
          GOTO      REFU9999
.
REFU5000  MATCH     SP70,RFDAT001
          GOTO      REFU6100 IF NOT EQUAL
.
          MATCH     SP70,RFDTR001
          GOTO      REFU6100 IF NOT EQUAL
.
          MATCH     SP70,RFDPL001
          GOTO      REFU6100 IF NOT EQUAL
.
          GOTO      REFU9999

REFU6100  CALL      CLALLRHL
.
          PACK      ALRHVISN,ADMISSNO
          PACK      ALRHTYPE,ZERO4
.
          MOVE      ONE,FORM3
          PACK      ALRHUNIQ,FORM3
          PACK      ALRHCUID,USERID
          PACK      ALRHCDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALRHCDAT
          CLOCK     TIME,ALRHCTIM
.
          PACK      ALRHDATE,RFDAT001
          PACK      ALRHCODE,RFDTR001
          PACK      ALRHCOD2,RFDPL001
.
          PACK      KEY13,ALRHVISN,ALRHTYPE,ALRHUNIQ,SP70
          CALL      WRALRHL1
.
REFU9999  RETURN
.
.******************************************************************************
. Other Allied Health department details
.******************************************************************************
.
ALDEDT00  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          PACK      KEY3,ALREDEPT,SP70
          CALL      RDALDEP1
          BRANCH    OVRCD,ALDEDT99
.
          BRANCH    F1,ALDEDT01,ALDEDT02,ALDEDT03,ALDEDT04,ALDEDT05:
                       ALDEDT06,ALDEDT07,ALDEDT08,ALDEDT09,ALDEDT10:
                       ALDEDT11
.
ALDEDT01  WRITE     HTMLFILE;ALDEUERF;      * Using External Referrals
          GOTO      ALDEDT99
.
ALDEDT02  WRITE     HTMLFILE;ALDEURAD;      * Using Residental Admission
          GOTO      ALDEDT99
.
ALDEDT03  WRITE     HTMLFILE;ALDEUASS;      * Using Assessments
          GOTO      ALDEDT99
.
ALDEDT04  WRITE     HTMLFILE;ALDEURAP;      * Using Request Appointments
          GOTO      ALDEDT99
.
ALDEDT05  WRITE     HTMLFILE;ALDEDLAS;      * Display Last 5 Contacts
          GOTO      ALDEDT99
.
ALDEDT06  WRITE     HTMLFILE;ALDEDCLI;      * Display Clinical Documentation
          GOTO      ALDEDT99
.
ALDEDT07  WRITE     HTMLFILE;ALDEDRAA;      * Display Referral Action Audit
          GOTO      ALDEDT99
.
ALDEDT08  WRITE     HTMLFILE;ALDEDLET;      * Display Letter History
          GOTO      ALDEDT99
.
ALDEDT09  WRITE     HTMLFILE;ALDEUEME;      * Using Encounter Medications
          GOTO      ALDEDT99
.
ALDEDT10  WRITE     HTMLFILE;ALDEUEIN;      * Using Encounter Interventions
          GOTO      ALDEDT99
.
ALDEDT11  WRITE     HTMLFILE;ALDEUESU;      * Using Encounter Supplies
          GOTO      ALDEDT99
.
ALDEDT99  RETURN
.
.
.-----------------------------------------------------------------------------.
. Check if a referral has any assessments
.-----------------------------------------------------------------------------.
CASS0000  PACK      KEY24,ADMISSNO,SP70
          CALL      RSALBIA1
CASS1000  CALL      RKALBIA1               * Bartel
          BRANCH    OVRCD,CASS3000
.
          MATCH     ADMISSNO,ALBAVISN
          GOTO      CASS3000 IF NOT EQUAL
.
          MATCH     "1",ALBADELF           * Deleted
          GOTO      CASS1000 IF EQUAL
.
          GOTO      CASS8000
.
CASS3000  PACK      KEY24,ADMISSNO,SP70
          CALL      RSPTFIM1
CASS4000  CALL      RKPTFIM1               * Bartel
          BRANCH    OVRCD,CASS5000
.
          MATCH     ADMISSNO,PTFIVISN
          GOTO      CASS5000 IF NOT EQUAL
.
          MATCH     "1",PTFIDELT           * Deleted
          GOTO      CASS4000 IF EQUAL
.
          GOTO      CASS8000
.
CASS5000  PACK      KEY24,ADMISSNO,SP70
          CALL      RSALSAS1
CASS6000  CALL      RKALSAS1               * Bartel
          BRANCH    OVRCD,CASS9000
.
          MATCH     ADMISSNO,ALSAVISN
          GOTO      CASS9000 IF NOT EQUAL
.
          MATCH     "1",ALSADELF           * Deleted
          GOTO      CASS6000 IF EQUAL
.
CASS8000  WRITE     HTMLFILE;ONE;           * Yes
          GOTO      CASS9999
.
CASS9000  WRITE     HTMLFILE;ZERO;          * No
          GOTO      CASS9999
.
CASS9999  RETURN
.
.*****************************************************************************
.                 CRTREFUP
. Determine if there is a referral in record to be sent for this U/R
.***************************************************************************
          DEFPROC   CRTREFUP
.
REFIFLAG  DIM       1
.
SAVESTAT  DIM       2
SAVEURNO  DIM       8
SAVEVISN  DIM       8
SAVECONT  DIM       8
SAVEDTTM  DIM       14
SAVERTYP  DIM       1
SAVEACTN  DIM       1
SAVERFIN  DIM       8
.
MESGSTAT  DIM       2   
.
          INC       ALLHDTFD/INC
.
          OPEN      ALLHDTA1,"allhdtaf"
          OPEN      ALLHDTA3,"allhdtaf"
.
          MOVE      ONE,REFIFLAG           * Not allowed to create ref in msg
.
          UNPACK    SAVMSGKY,SAVESTAT,SAVEURNO,SAVEVISN,SAVECONT:
                             SAVEDTTM,SAVERTYP,SAVEACTN
.
          PACK      KEY42,SAVMSGKY,SP70
          CALL      RDALHDT1
          BRANCH    OVRCD,CRTREF90
.
          MOVE      ALHDLINK,SAVERFIN       * Save referral in visit number
          MOVE      " 0",MESGSTAT           * Status Waiting
.
CRTREF05  PACK      KEY42,SAVEURNO,MESGSTAT,SAVERFIN,SP70
          CALL      RSALHDT3
CRTREF10  CALL      RKALHDT3                * Read VINAH messages
          BRANCH    OVRCD,CRTREF30
.
          MATCH     SAVEURNO,ALHDURNO       * Correct U/R
          GOTO      CRTREF30 IF NOT EQUAL
.
          MATCH     MESGSTAT,ALHDSTAT       * Waiting Messages
          GOTO      CRTREF30 IF NOT EQUAL
.
          MATCH     SAVERFIN,ALHDVISN       * Correct Referral In
          GOTO      CRTREF30 IF NOT EQUAL
.
          MATCH     SP8,ALHDCONT            * Contact Id balcnk for referral In
          GOTO      CRTREF30 IF NOT EQUAL
.
          MATCH     "0",ALHDRTYP            * Referral In record type
          GOTO      CRTREF10 IF NOT EQUAL
.
          MATCH     SP70,ALHDBNUM           * Batch number must be blank
          GOTO      CRTREF10 IF NOT EQUAL
.
          GOTO      CRTREF90                * Not allowed to create ref in msg
.
CRTREF30  MATCH     " 0",MESGSTAT           * Status Waiting
          IF        @EQUAL
            MOVE      " 1",MESGSTAT         * Status Error
            GOTO      CRTREF05  
          ENDIF
.
CRTREF80  MOVE      ZERO,REFIFLAG           * Allowed to create ref in msg
.
CRTREF90  WRITE     HTMLFILE;REFIFLAG;
.
          CLOSE     ALLHDTA1
          CLOSE     ALLHDTA3
          GOTO      CRTREF99
.
          INC       ALLHDTIO/INC
          INC       IBAOVRIO/INC
.
CRTREF99  ENDPROC
.
.-----------------------------------------------------------------------------.
. Referral in outcome error correction
.-----------------------------------------------------------------------------.
RFIO0000  RESET     UPDTTYPE
          MATCH     SP70,UPDTTYPE
          GOTO      RFIO8000 IF EQUAL
.
          MATCH     "A",UPDTTYPE            * Add
          GOTO      RFIO2000 IF EQUAL
.
          MATCH     "U",UPDTTYPE            * Update
          GOTO      RFIO3000 IF EQUAL
.
          MATCH     "D",UPDTTYPE            * Delete
          GOTO      RFIO4000 IF EQUAL
.
          GOTO      RFIO9000
.
RFIO2000  CALL      CLALLRIO                * Clear file vars
          CALL      MVALRI00                * Move cgi var to file vars
.
          PACK      KEY27,ALRIVISN,ALRIDATE,ALRITIME,ALRIOUTC,SP70
          CALL      RAALRIO1
          COMPARE   ONE,OVRCD               * Check new record doesn't exist
          GOTO      RFIO9500 IF NOT EQUAL
.
          CALL      WRALRIO1                * Write new record
. 
          MOVE      ZERO,EXIT
          GOTO      RFIO9999
.
RFIO3000  PACK      KEY27,ALRIOKEY,SP70
          CALL      RDALRIO1                * Read Referral In Outcome
          BRANCH    OVRCD,RFIO9400
.
          CALL      MVALRI00                * Move cgi var to file vars
.
          PACK      KEY27,ALRIVISN,ALRIDATE,ALRITIME,ALRIOUTC,SP70
          MATCH     KEY27,ALRIOKEY
          IF        !@EQUAL
            CALL      RAALRIO1
            COMPARE   ONE,OVRCD               * Check new record doesn't exist
            GOTO      RFIO9500 IF NOT EQUAL
.
            PACK      KEY27,ALRIOKEY,SP70
            CALL      RDALRIO1                * Re Read Referral In Outcome
            BRANCH    OVRCD,RFIO9400
.
            CALL      MVALRI00                * Move cgi var to file vars
          ENDIF
.
          CALL      UPALRIO1                * Update Record
.
          MOVE      ZERO,EXIT
          GOTO      RFIO9999
.
RFIO4000  PACK      KEY27,ALRIOKEY,SP70
          CALL      RDALRIO1                * Read Referral In Outcome
          BRANCH    OVRCD,RFIO9400
.
          CALL      DEALRIO1                * Delete
.
          MOVE      ZERO,EXIT
          GOTO      RFIO9999
.
RFIO8000  CALL      CURPER00                * Display Routine
          CALL      CALCDT00                * Calculate Next/Last Period Dates
.
          PACK      KEY8,URNUMBER,SP70      * Patient Referral Details
          CALL      RDMAST1
          BRANCH    OVRCD,RFIO9200
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          BRANCH    OVRCD,RFIO9200
.
          PACK      KEY8,ADMISSNO,SP70      * Patient Referral Details
          CALL      RDALREF1
          BRANCH    OVRCD,RFIO9100
.
          PACK      KEY8,ADMISSNO,SP70      * Patient Referral Details
          CALL      RDVISA1
          BRANCH    OVRCD,RFIO9100
.
          PACK      KEY3,ALREDEPT,SP70
          CALL      RDALDEP1                * Read department table
          BRANCH    OVRCD,RFIO9300
.
          MOVE      ALREDEPT,DEPTCODE
          MOVE      ALREDEPT,ALHDDEPT       * Used for department tags
.
          PACK      KEY27,ALRIOKEY,SP70
          CALL      RDALRIO1                * Read the referral in outcome
          IF        OVRCD=1
            CALL      CLALLRIO              * Clear file vars
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Allied Health Referrals/VINAH Referral In Outcome",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,ALLEVT99
          CALL      WEBBOD00   * Process Web Body (calls PROFLD00)
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      RFIO9999
.
RFIO9000  MOVE      "Invalid Update Type.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RFIO9999
.
RFIO9100  MOVE      "Invalid Referral.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RFIO9999
.
RFIO9200  MOVE      "Invalid U/R Number.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RFIO9999
.
RFIO9300  MOVE      "Invalid Department.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RFIO9999
.
RFIO9400  MOVE      "Invalid Referral In Outcome Record.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RFIO9999
.
RFIO9500  MOVE      "Referral In Outcome Record Already Exists.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RFIO9999
.
RFIO9999  RETURN
.
.-----------------------------------------------------------------------------.
. Move referral in outcome cgi vars to file vars 
.-----------------------------------------------------------------------------.
MVALRI00  MATCH     Z70,ALRIO001
          IF        !@EQUAL
            PACK      ALRIVISN,ALRIO001,SP70
          ENDIF
.
          MATCH     Z70,ALRIO002
          IF        !@EQUAL
            PACK      ALRIDATE,ALRIO002,SP70
          ENDIF
.
          MATCH     Z70,ALRIO003
          IF        !@EQUAL
            PACK      ALRITIME,ALRIO003,SP70
          ENDIF
.
          MATCH     Z70,ALRIO004
          IF        !@EQUAL
            PACK      ALRIOUTC,ALRIO004,SP70
          ENDIF
.
MVALRI99  RETURN
.
.------------------------------------------------------------
. Referral In Outcome History
.------------------------------------------------------------
REFOUT00  PACK      KEY27,ADMISSNO,Z70
          CALL      RSALRIO1                * positional read
REFOUT20  CALL      RPALRIO1                * read a record
          BRANCH    OVRCD,REFOUT99
.
          MATCH     ADMISSNO,ALRIVISN
          GOTO      REFOUT99 IF NOT EQUAL
.
REFOUT15  UNPACK    ALRIDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          CALL      OUTDSC00
          PACK      KEY27,ALRIVISN,ALRIDATE,ALRITIME,ALRIOUTC,SP70
.
          WRITE     HTMLFILE;"<tr><td>":
                             "<img src=../images/MaintenanceIcon.gif ":
                             "class=ListIcon ":
                             "onclick=#"UpdRefInOutcome('",KEY27,"','":
                             URNUMBER,"');#"> ":
                             DISPDAT1," ",ALRITIME,"</td>":
                             "<td>",OUTCDESC,"</td></tr>";
          GOTO      REFOUT20
.
REFOUT99  RETURN
.
.------------------------------------------------------------
. Retrieve the correct referral in outcome description
.------------------------------------------------------------
OUTDSC00  MOVE      SP70,OUTCDESC
          MOVE      ZERO,F2
.
          WHILE     F2 < 20
            ADD       ONE,F2
            PACK      KEY63,OUTCARAY[F2]
            UNPACK    KEY63,KEY3,KEY60
            MATCH     ALRIOUTC,KEY3
            IF        @EQUAL
              MOVE      KEY60,OUTCDESC
              GOTO      OUTDSC99
            ENDIF
          DO
.
OUTDSC99  RETURN
.
.-----------------------------------------------------------------------------
. Set up the description for Referral in outcome description array
.-----------------------------------------------------------------------------
IOUTAR00  MOVE      "010Referral accepted - New appointment",OUTCARAY[1]
          MOVE      "020Referral accepted - Review appointment",OUTCARAY[2]
          MOVE      "1  Referral accepted",OUTCARAY[3]
          MOVE      "3  Referral accepted - Renewed referral",OUTCARAY[4]
          MOVE      "21 Patient/client died",OUTCARAY[5]
          MOVE      "22 Patient/client safety issue",OUTCARAY[6]
          MOVE      "23 Patient/client not medically fit",OUTCARAY[7]
.
          MOVE      SP70,KEY40
          MOVE      SP70,KEY23
          MOVE      "36 Recommended to present to ED for medi",KEY40
          MOVE      "cal reasons",KEY23
          PACK      OUTCARAY[8],KEY40,KEY23,SP70
.
          MOVE      "24 Patient/client not contactable",OUTCARAY[9]
          MOVE      "25 Services declined or not required",OUTCARAY[10]
.
          MOVE      SP70,KEY40
          MOVE      SP70,KEY23
          MOVE      "30 Patient/client out of catchment area ",KEY40
          MOVE      "for program",KEY23
          PACK      OUTCARAY[11],KEY40,KEY23,SP70
.
          MOVE      "31 Clinician safety issue",OUTCARAY[12]
.
          MOVE      SP70,KEY40
          MOVE      SP70,KEY23
          MOVE      "32 More appropriate program/service iden",KEY40
          MOVE      "tified",KEY23
          PACK      OUTCARAY[13],KEY40,KEY23,SP70
.
          MOVE      SP70,KEY40
          MOVE      SP70,KEY23
          MOVE      "33 Patient/client does not meet the prog",KEY40
          MOVE      "ram/service criteria",KEY23
          PACK      OUTCARAY[14],KEY40,KEY23,SP70
.
          MOVE      "34 Required services not available",OUTCARAY[15]
          MOVE      "35 No program/service capacity",OUTCARAY[16]
          MOVE      "40 Other reason for cancellation",OUTCARAY[17]
          MOVE      "41 Referral withdrawn by referrer",OUTCARAY[18]
.
          MOVE      SP70,KEY40
          MOVE      SP70,KEY23
          MOVE      "98 Referral awaiting additional informat",KEY40
          MOVE      "ion from referrer",KEY23
          PACK      OUTCARAY[19],KEY40,KEY23,SP70
.
          MOVE      "99 Referral processing in progress",OUTCARAY[20]
.
IOUTAR99  RETURN
.
.
.------------------------------------------------------------
.  Selection list of Departments
.----------------------------------------------------------------
DEPTSL00  PACK      PTCDKEY2,ANSC,ANSG,SP70
          CALL      RDSCODE2                      * positional read
DEPTSL10  CALL      RDKCODE2                      * read a record
          BRANCH    OVRCD,DEPTSL99
.
          MATCH     "CG",TCODE
          GOTO      DEPTSL99 IF NOT EQUAL
.
          MATCH     ANSI,TCINDC3                  * Skip IP Departments
          GOTO      DEPTSL10 IF EQUAL
.
          PACK      KEY3,ACODE,SP70
          CALL      RDALDEP1                      * Read department table
          BRANCH    OVRCD,DEPTSL10
.
          MATCH     "1",ALDEACTV
          GOTO      DEPTSL10 IF EQUAL
.
DEPTSL20  MATCH     DIM3,ALDEDEPT
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",ALDEDEPT," selected>":
                          TDESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",ALDEDEPT,">":
                             TDESC,"</option>"
          ENDIF
          GOTO      DEPTSL10
.
DEPTSL99  RETURN
.
.------------------------------------------------------------
. Validate VINAH date range data load
.-----------------------------------------------------------
XMLD0000  CALL      XMLHED00
          BRANCH    EXIT,XMLD9999
.
          BRANCH    VALDTYPE,XMLD1000
.
          GOTO      XMLD9100
.
XMLD1000  CALL      CHKL0000      * Get last VINAH data loaded date
          GOTO      XMLD9800
.
XMLD9100  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid action":
                             "</RETURN_VALUE>"
          GOTO      XMLD9800
.
XMLD9800  CALL      XMLEND00
.
XMLD9999  RETURN
.
.*****************************************************************************
.*                               CHKL0000              Called by: XMLD0000   *
.* Check for the last date loaded for any status                             *
.*          STATUS -   0 = Waiting                                           *
.*                     1 = Error on extract validation                       *
.*                     2 = Ignore (non VINAH record)                         *
.*                     3 = Ignore (not required)                             *
.*                     4 = Ignore (later message)                            *
.*                     5 = Ignore (associated deletion)                      *
.*                     6 = Extracted                                         *
.*                     7 = Submitted                                         *
.*                     8 = Rejected                                          *
.*                     9 = Resubmitted                                       *
.*                    10 = Accepted                                          *
.*                    99 = Remove                                            *
.*                                                                           *
.* Returns:  0 | SP1 - New load date is the day after last loaded date       *
.*           1 | DATE -  New load date is NOT the day after last loaded date *
.*****************************************************************************
.
CHKL0000  MOVE      SP70,LOADDATE                * Last date range loaded
          MOVE      ZERO,COUNTER                 * initialise counter
.
CHKL0500  COMPARE   TEN1,COUNTER                 * last status checked ?
          GOTO      CHKL9000 IF NOT LESS         * yes - finished
.
          MOVE      COUNTER,STATUS               * load status to be checked
.
          PACK      KEY42,STATUS,Z70
          CALL      RSALHDT4                     * position on status
          CALL      RPALHDT4                     * read next record
          BRANCH    OVRCD,CHKL8000               * eof - finished
.
          MATCH     STATUS,ALHDSTAT              * same status still ?
          GOTO      CHKL8000 IF NOT EQUAL        * no - finished
.
.         Save last date loaded for given status
.
          MOVE      ALHDDTTM,DIM8                * get record date
.
          MATCH     SP70,LOADDATE
          IF        @EQUAL
            MOVE     DIM8,LOADDATE               * Save last loaded date
            GOTO     CHKL8000
          ENDIF
.
          MATCH     DIM8,LOADDATE
          IF        @LESS
            MOVE     DIM8,LOADDATE               * Save last loaded date
          ENDIF
.
CHKL8000  ADD       ONE,COUNTER                  * increment counter
          GOTO      CHKL0500                     * check next status
.
CHKL9000  MATCH     SP70,LOADDATE                * No VINAH data loaded
          GOTO      CHKL9100 IF EQUAL
.
          MOVE      LOADDATE,NXTDDATE            * Data loaded until
          ADD       ONE,NXTDDATE                 * Add one day 
.
          MATCH     NXTDDATE,VALDDATE            * OK from date less than 
          GOTO      CHKL9100 IF LESS             * last loaded date
.
          MATCH     NXTDDATE,VALDDATE            * OK from date is the next day
          GOTO      CHKL9100 IF EQUAL            * after last loaded date
.
          UNPACK    LOADDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             ONE,"|",DISPDAT1:
                             "</RETURN_VALUE>"
          GOTO      CHKL9999
.
CHKL9100  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             ZERO,"|",SP1:
                             "</RETURN_VALUE>"
.
CHKL9999  RETURN
.
          INC       IBAWEBCD
          INC       WEBDATCD
          INC       CLALLAUD
          INC       CLALLRHL
          INC       DAYOFWEK
          INC       DGCLII13
          INC       DGCLICEU
          INC       PATDOCCD
          INC       PMIGTNID
          INC       NAMSTRCD
          INC       PATDOCTM
.
          INC       ALLAUDIO/INC
          INC       ALLBIAIO/INC
          INC       ALLCASIO/INC
          INC       ALLDEPIO/INC
          INC       ALLDIAIO/INC
          INC       ALLENCIO/INC
          INC       ALLHHDIO/INC 
          INC       ALLHBTIO/INC 
          INC       ALLHDTIO/INC
          INC       ALLITMIO/INC
          INC       ALLMDTIO/INC
          INC       ALLQUEIO/INC
          INC       ALLREFIO/INC
          INC       ALLPROIO/INC
          INC       ALLPRRIO/INC
          INC       ALLRIOIO/INC
          INC       ALLRITIO/INC
          INC       ALLRLNIO/INC
          INC       ALLSASIO/INC
          INC       ALLSEDIO/INC
          INC       ALLSERIO/INC
          INC       PATFIMIO/INC
          INC       PMSHCLIO/INC
          INC       PMSHCPIO/INC
          INC       PMSQPTIO/INC
          INC       PATDO1IO/INC  
.
          INC       ALLREFTM
          INC       ALLENCTM
          INC       BRHLCOMN
          INC       PATMASTM
          INC       CLALLENC
          INC       CLALLRIO
          INC       CLNHIMAS
          INC       CLPMSPX2
          INC       CALCAGE
          INC       PMSPX2TM
          INC       PMSHCGTM
          INC       PATMSXTM
          INC       CLPATMAS
          INC       PMSHCPTM
          INC       ALLRHLTM
          INC       VINAHCOM
.
          INC       APSMASIO/INC
          INC       HL7CISIO/INC
          INC       HL7INBIO/INC
          INC       MLTSECIO/INC
          INC       MLTSITIO/INC
          INC       PATMA1IO/INC
          INC       PATALRIO/INC
          INC       PATVISIO/INC
          INC       PMSVX1IO/INC
          INC       OUTSITIO/INC
          INC       OUTCTYIO/INC
          INC       OUTCLIIO/INC
          INC       PMSUCHIO/INC
          INC       PMSUCDIO/INC
          INC       PATHSPIO/INC
          INC       PMSPX2IO/INC
          INC       PATMI1IO/INC
          INC       PATNIDIO/INC
          INC       PATFN1IO/INC
          INC       PATPR1IO/INC
          INC       PATWR1IO/INC
          INC       PATVADIO/INC
          INC       PRIITMIO/INC
          INC       MRTMASIO/INC
          INC       NHIMASIO/INC
          INC       NHIETHIO/INC
          INC       PATIN1IO/INC
          INC       PMSHCGIO/INC
          INC       PATRE1IO/INC
          INC       PATDSCIO/INC
          INC       PATASFIO/INC
          INC       PATDGWIO/INC
          INC       PATITMIO/INC
          INC       PMSCCDIO/INC            * Concession Card Details
.
          INC       ALLRHLIO/INC
