.---------------------------------------------------------------------
. Program       : PATWEB98
.
. Function      : Patient Enquiries Template Server
.
. Modifications :
.---------------------------------------------------------------------
. V12.00.09  16/09/2025  J.Tan          TSK 0965020
.            Mod to update Date record last changed fields in pattranf,patchcof
. V12.00.08  04/08/2025  Ebon Clements  TSK 0964910
.            Open file limit of 255 reached. Closed unused open files
.            WEBSCHA2, WEBSCHA3, WEBSCHA4, OBSPINA1, MLTCODA2 and MLTHCPA2
. V12.00.07  24/07/2025  Bella Turco    TSK 0963685
.            Right justified TEMPLATE field to fix popup templates having wrong
.            title in GETPAT30
. V12.00.06  01/07/2025  Ebon Clements  TSK 0962009
.            Check previous record if current record is deleted.
.            Discharge management read - OTHS1000
. V12.00.05  23/06/2025  Ebon Clements  TSK 0962009
.            Added deleted status check to discharge management read - OTHS1000
. V12.00.04  13/06/2025  Ebon Clements  TSK 0961623
.            Alphanueric visit number changes. Corrected visit type - REQLST00
. V12.00.03  10/06/2025  Jacob Jackson  TSK 0947378
.            Fixed OTHS1000 and Added OTHS1040 (ported from V11.05.14)
. V12.00.02  05/06/2025  Ebon Clements  TSK 0961310
.            Removed duplicate ICD10 ED 13 go live date parameter read INIT0000
. V12.00.01  22/05/2025  J.Tan          TSK 0955096
.            Added Alphanumeric visit number changes
. V11.05.12  11/04/2025  Jacob/Sunny    TSK 0947378
.            Add Discharge Delay fields
. V11.05.11  20/03/2025  Davin          TSK 0956210
.            Add ICD10 Ed.13 - Go-live Date PTCNGDX3 (Sect.130 Pos.86)
. V11.05.10  06.03.2025 Jacob Jackson   TSK 0945956
.            Fix problem with TABX3000 tag not appearing on templates
. V11.05.09  21.02.2025 Jacob Jackson   TSK 0945956
.            Adding filter for priweb0206001 based on OBASTAT
. V11.05.08  17.01.2025 DA Sarkies      TSK 0954697
.            Recompiled for OBSPALPR
. V11.05.07  14/01/2025 Thanh T         TSK 0884838
.            Added TRNINS00 for supervisor insert bed movement  
. V11.05.06  13.01.2025 DA Sarkies      TSK 0954697
.            Recompiled for OBSPALPR
. V11.05.05  20.12.2024 DA Sarkies      TSK 0954547
.            Commented out <cat> tags to prevent browser incompatibility
. V11.05.04  17.12.2024  DA Sarkies       TSK 0951086
.            Increased size of NBRDAYS
. V11.05.03  26/11/2024  Ebon Clements    TSK 0954547
.            Added <cat-c> start and end tag to category=XX tag
. V11.05.02  26/11/2024  Bella Turco      TSK 0952905
.            Fixed pmshcgaf table read to stop Previous Practice name displaying
.            as blank in DISPRH10
. V11.05.01  18/11/2024  Bella Turco      TSK 0952905
.            Fixed keypack when reading pmshcgaf in DISPRH00
. V11.04.32  17.01.2025  DA Sarkies       TSK 0954697
.            Recompiled for OBSPALPR
. V11.04.31  13.01.2025  DA Sarkies       TSK 0954697
.            Recompiled for OBSPALPR
. V11.04.30  27/11/2024  Ebon Clements    TSK 0954547
.            Added <cat-c> start and end tag to category=XX tag
. V11.04.29  26/11/2024  Bella Turco      TSK 0952905
.            Fixed pmshcgaf table read to stop Previous Practice name displaying
.            as blank in DISPRH10
. V11.04.28  18/11/2024  Bella Turco      TSK 0952905
.            Fixed keypack when reading pmshcgaf in DISPRH00
. V11.04.27  28/10/2024  Ebon Clements    TSK 0948906
.            Recompiled for NSHISWIO - GETMWS AE2034 Unrecoverable read error
. V11.04.26  28.10.2024  DA Sarkies       TSK 0948782
.            Fixed issue where the bed wasn't being displayed correctly in the 
.            full url for the location
. V11.04.25  17.10.2024  DA Sarkies       TSK 0948782
.            Update FHIR so that expected bed/ward is displayed for pre-admitt
.            patients 
. V11.04.24  08/10/2024  Ebon Clements    TSK 0952424
.            Fixed care type display on transfer list - TRNTAB30
.            See V10.02.36 for previous movement list fix - MVDTAB30
. V11.04.23  21/08/2024  Don Nguyen       TSK 0950408
.            Added Email Address in 'Extra Contacts' list (sort table); CEXT0000
. V11.04.22  07/08/2024  Alina Bhari      TSK 0922829                      
.            displayed MRT status description as per the configured hex value
.            color in Cat RS-MRTTAB50                                          
. V11.04.21  22/07/2024  Peter Vela       TSK WEBPAS / ORBIS UI R&D
.            Recompiled for FHRDATCD
. V11.04.20  18/07/2024  Ebon Clements    TSK 0949287
.            Added update of ED visits aaede1af claim code ADACOMP UPCLTY00
. V11.04.19  04.07.2024  DA Sarkies       TSK 0939978
.            Added tag to display whether the patient has been discharged or not
. V11.04.18  02/07/2024  Jacob Jackson    TSK 0911895
.            Add patient booking SMS type dropdown generation
. V11.04.17  27.06.2024  DA Sarkies       TSK 0948535
.            Recompiled for PATMSXTM 
. V11.04.16  25/06/2024  Jacob Jackson    TSK 0948238
.            Clear arrays used for prtform inputs, and add fix to ensure that
.            if only prtform2 is selected, it can be printed
. V11.04.15  21/06/2024  Alina Bhari      TSK 0946963
.            Displayed web user ID if user id is not found -CODUSR05
. V11.04.14  17/06/2024  Bella Turco   TSK 0947689
.            Added func in UPEX0000 to update pmsextaf claim code for Discharged
.            visit Supervisor Claim Type Changes
. V11.04.13  06/05/2024  Thanh T       TSK 0941543
.            Recompiled as PMSPX2TM changes 
. V11.04.12  26/04/2024  Jacob Jackson   TSK 0941762
.            Recompiled for PATECDFD
. V11.04.11  24/04/2024  Jacob Jackson   TSK 0941762
.            Upload and display "Reason for Discharge Delay" input value to 
.            VSXDCOD2
. V11.04.10  04/04/2024  Bella Turco     TSK 0914658
.            Added UPINSU00 routine to auto-update insurance code when MVIT
.            status is Confirmed
. V11.04.09  13/03/2024  DA Sarkies      TSK 0939978
.            Added subroutines to load outpatient appointments as JSON
. V11.04.08  13/03/2024  Ebon Clements   TSK 0914658
.            Only update the claim code of the last transfer file record
.            UPTRAN00
.            06/03/2024 Bella Turco      TSK 0914658
.            Added outbokaf open in UPCLTY00 to fix I*C
.            Update PTMIWEBU when status is Confirmed (UPCLTY40)
.            Added pmsextaf read before UPPMEXT1 in UPCLTY00 to stop error
.            Update PMEXCLAM with Alternate Election when status is Confirmed
.            (UPCLTY00)
.            Fix DB read logic, which would sometimes show "Has this
.            patient been in an accident?" with a "Yes" value
.            Change logic to allow multiple printers to be saved
.            for MV templates
. V11.04.07  21/02/2024  Ebon Clements  TSK 0932689 
.            Reset discharge visits only to no for visit list 
.            CLRPAR00 set DISCFLAG=0
. V11.04.06  19/01/2024  Alina Bhari    TSK 0932545 
.            Displayed comment in demographic template                       
.            -LSTEXC80            
. V11.04.05  17.01.2024 DA Sarkies      TSK 0932689
.            Added checks to see if there are multiple volumens, and at a + 
.            if there is
. V11.04.04  10/01/2024 Thanh T         TSK 0936263
.            Recompiled for DGCLICOB changes
. V11.04.03  14/12/2023 Bella Turco      TSK 0914658
.            Added UPCLTY00 - updates Claim Code if ICWA Status is Confirmed
.            18/12/2023  Thanh T        TSK 0906342
.            Added Clear OTMAPCOD field
. V11.04.02  08/12/2023 Thanh T                TSK 0936282
.            Recompiled for EMRVISFD changes 
. V11.04.01  29/11/2023 Thanh T                TSK 0932689
.            Recompiled for MRTVISFD changes
. V11.03.41  13/03/2024  DA Sarkies      TSK 0939978
.            Added subroutines to load outpatient appointments as JSON
. V11.03.40  13/03/2024  Ebon Clements   TSK 0914658
.            Only update the claim code of the last transfer file record
.            UPTRAN00
. V11.03.39  07/03/2024 Jacob Jackson    TSK 0914658
.            Fix problem with server not reading printer parameters
. V11.03.38  27/02/2024 Bella Turco      TSK 0914658
.            Added outbokaf open in UPCLTY00 to fix I*C
.            Update PTMIWEBU when status is Confirmed (UPCLTY40)
.            Fix DB read logic, which would sometimes show "Has this
.            patient been in an accident?" with a "Yes" value
.            Change logic to allow multiple printers to be saved
.            for MV templates
. V11.03.37  21/02/2024 Bella Turco      TSK 0914658
.            Added pmsextaf read before UPPMEXT1 in UPCLTY00 to stop error
. V11.03.36  16/02/2024 Bella Turco      TSK 0914658
.            Update PMEXCLAM with Alternate Election when status is Confirmed
.            (UPCLTY00)
. V11.03.35  11/01/2024 Ebon Clements    TSK 0941629
.            Recompiled for WEBPRTCD - Inactive printers
. V11.03.34  14/12/2023 Bella Turco      TSK 0914658
.            Added UPCLTY00 - updates Claim Code if ICWA Status is Confirmed
. V11.03.33  06/11/2023   Jacob Jackson  TSK 0914658
.            Add OTHS0600 for access to claim code details
. V11.03.32  25.09.2023   Sunny          TSK 0937587
.            Recompiled for FHRDATDF - Changed FHRWLOCC from DIM20 to DIM21
. V11.03.31  05.09.2023  DA Sarkies      TSK 0935885
.            Added check to skip if MVA date blank. Increased TAC claim number
.            size by 1.
. V11.03.30  01/09/2023  Jacob Jackson   TSK 0935070
.            Recompiled for OBSFHRCD - Make reviewdate/reviewdttm extension
.            value empty if PTALRDTE is not populated
. V11.03.29  31/08/2023  Sunny           TSK 0935067 
.            Recompiled for OBSFHRCD - Changed RESALL00 for Severity description
. V11.03.28  24/08/2023  Peter Vela     TSK 0927262
.            Recompiled for OBSPALPR
.            23/08/2023  Thanh T        TSK 0935069
.            Recompiled for OBSFHRCD changes
. V11.03.27  21/08/2023  Peter Vela     TSK 0927262
.            Recompiled for OBSPALPR
.            Added pmshcpaf direct read validation around RESASS00
. V11.03.26  15/08/2023  Peter Vela     TSK 0927262
.            Added space validation around RESLOC00 for PTALHOSP
. V11.03.25  11/08/2023  Peter Vela     TSK 0927262
.            Fixed comma placement in RESEST00 for partOf object
. V11.03.24  10/08/2023 J.Tan           TSK 0935678
.            Mod CLMLKP00 to replace apostrophe in Accident location (pmsexaloc)
. V11.03.23  08/08/2023 Alina Bhari     TSK 0927794
.            Displayed 70 character long desc in financial letter - SELFLT10
. V11.03.22  04/08/2023 Davin           TSK 0907196
.            Recompiled for PMSPX2TM - Added User Defined Date/Times 1-5
. V11.03.21  01/08/2023 Peter Vela      TSK 0927262
.            Recompiled for OBSPALPR.PBL
.            Added dxc-hc-hcp and dxc-hc-speciality extensions
.            to Practitioner User resource
. V11.03.20  21.07.2023 Jacob Jackson   TSK 0927731
.            Ensure location object is returned for a pre-admission
.            patient
. V11.03.19  11.07.2023 DA Sarkies      TSK 0927398
.            Recompiled for FHRDATCD
. V11.03.18  07/07/2023 Davin           TSK 0934325
.            Don't update PRFA if admissno is blank or zero (UPPRA000/FPRA0000)
. V11.03.17  03/07/2023 Ebon Clements   TSK 0917282
.            Change PMI audit to use PMI created by web user id instead of
.            the passdode PMIAUD70 - PMPXWBID PTMXOPER
. V11.03.16  27/06/2023 Peter Vela      TSK 0927262
.            Recompiled for OBSPALPR 
.            Resource Flag
.            ClinicalAide FHIR API
.            Added Subject include FHRSUBIN functionality
.            Added Participant include FHRPARIN functionality
.            Added Location include  FHRLOCIN functionality
. V11.03.15  22/06/2023 Jacob Jackson   TSK 0927731
.            Add changes so that FHIR Response contains a location object
.            for Ward and an object for Bed
.            14/06/2023 Sunny            TSK 0927398
.            Recompiled for FHRDATCD - Removed lastUpdated (PTMXCTIM)
. V11.03.14  19/06/2023  Alina Bhari    TSK 0932477
.            Correctly added the workcover detail in update workcover detail
.            billing module. - WCOMFLAG,UPDCLM22,UPDCLM24,UPDCLM26,UPDCLM28,
.            CLPATWC1
. V11.03.13  30.05.2023  DA Sarkies     TSK 0927431
.            Added filter for FHIR patient Encounter search based on status.
. V11.03.12  29.05.2023  DA Sarkies     TSK 0928398
.            Recompiled for FHRDATCD
. V11.03.11  26/05/2023  Peter Vela     TSK 0927262
.            ClinicalAide FHIR API
.            Added Patient include FHRPATIN functionality
.            Added Recorder include FHRRECIN functionality
.            Added Asserter include FHRASSIN functionality
. V11.03.10  23/05/2023  Peter Vela     TSK 0927399
.            Recompiled for FHRDATCD - Changed gender validation to
.            Indicator 7
. V11.03.09  17/05/2023  Ebon Clements  TSK 0932616
.            Recompiled for PMSPX2TM - Current IP
. V11.03.08  04/05/2023  Peter Vela     TSK 0927262
.            ClinicalAide FHIR API
.            Added Subject include FHRSUBIN functionality
.            Added Participant include FHRPARIN functionality
.            Added Location include  FHRLOCIN functionality
. V11.03.07  01/05/2023 Don Nguyen      TSK 0932031
.            Added code to process 'noreturn' cgi variable and output; TABX2600
. V11.03.06  24/03/2023 D Sarkies       TSK 0929754
.            Added code to update the discharge table with ward transfers
. V11.03.05  14/03/2023 Bella Turco     TSK 0919538
.            Recompiled for PMSPX2TM
. V11.03.04  06/03/2023 Jacob Jackson   TSK 0918711
.            Recompiled for PATMASTM
. V11.03.03  13/02/2023 Thanh T         TSK 0917555
.            Added TABX2100-TABX2500 for Late Discharge Reason/comments
. V11.03.02  06/02/2023  Ebon Clements  TSK 0924806
.            Added all ICD10 edition go live date tests to summary screen
.            heading - ICDTYP00
. V11.03.01  23/11/2022  Ebon Clements  TSK 0923998
.            Added clear of PTMMEDAT,PTMMRPST,PTMMRPET,PTMMVAID,PTMMAPRA
.            prior to write to patmmbsf - PATMMB14
. V11.02.20  24.03.2023  DA Sarkies     TSK 0929754
.            Added code to update the discharge table with ward transfers
. V11.02.19  06/02/2023  Ebon Clements  TSK 0924806
.            Added all ICD10 edition go live date tests to summary screen
.            heading - ICDTYP00
. V11.02.18  23/11/2022  Ebon Clements  TSK 0923998
.            Added clear of PTMMEDAT,PTMMRPST,PTMMRPET,PTMMVAID,PTMMAPRA
.            prior to write to patmmbsf - PATMMB14
. V11.02.17  01/09/2022  Alina Bhari    TSK 0913316
.            recompiled for ALTROW10 in OBSPALPR to display last update
.            by field as "AutoEndPgm" if record is updated through
.            "Auto-End Selected Alert Code"
. V11.02.16  24/08/2022  Alina Bhari    TSK 0913316
.            recompiled for ALTROW10 in OBSPALPR to display last update
.            by field as "Auto Script" if record is updated through
.            "Auto-End Selected Alert Code"                        
. V11.02.15  09/08/2022  Jacob Jackson  TSK 0893290
.            Add new tag OTHS0500 for generating dropdown of relevant
.            close contact mobile phone information
. V11.02.14  04/08/2022  Ebon Clements  TSK 0920141
.            Read IP/OP letter file by index 2 - OSMS0000 and ISMS0000
. V11.02.l3  28/07/2022  Jill Parkinson Task 09210166
.            Recompiled for CHKHCU00 to look for deceased changes 
. V11.02.12  15/06/2022 Thanh T         TSK 0893159
.            Added STRTRC00 for Recurring Care Specified Admission
. V11.02.11  06/06/2022 Thanh T         TSK 0893159
.            Added RECLST00, PREVRC00 and NEXTRC00 for Recurring Care
.            Specified Admission
. V11.02.10  19/05/2022 J.Tan           TSK 0837128
.            Recompiled for PRFAINSR - to use Cat CL indic 24
. V11.02.09  29/04/2022 J.Tan           TSK 0837128
.            Mod Default PRFA based on Claim type (PRFAINSR)
. V11.02.08  27/04/2022 Thanh T         TSK 0903453
.            Recompiled for PMSPX2TM changes
. V11.02.07  26/04/2022 Alina Bhari     TSK 0912792
.            Display External Visit ID if the "Show the External Visit ID
.            in Patient Search,Banner and Selected Visit Lists" parameter
.            is set to yes
.            - OUTROW00,WATLST20,REQLST00,BOKLST00               
. V11.02.06  01/04/2022 Thanh T         TSK 0903453
.            Changed PMAD0000 to add identifying gender and pronoun
.            and free text fields 
. V11.02.05  31/03/2022  Davin          TSK 0917793
.            Add ICD10 Ed.12 - Go-live Date PTCNGDX2 (Sect.128 Pos.231)
. V11.02.04  29/03/2022 Alina Bhari     TSK 0912792
.            Display External Visit ID if the "Show the External Visit ID
.            in Patient Search,Banner and Selected Visit Lists" parameter
.            is set to yes                                               
.            - ALLREQ10, ALLBOK20, ALLVIS30, ALLWAT20, ALLCAD10,         
.            ALLROW00,VISROW00, WATROW00, BOKROW00, THEROW00, VISROW00,  
.            PATLST30, ALLTAB30,CHKEID00     
. V11.02.03  09/02/2022 Thanh T         TSK 0905641
.            Changed CLRMAS00 to initailize Additional HCP Code (1-4) and
.            various othe fields for outma1af
. V11.02.02  07/02/2022  Thanh T        TSK 0896905
.            Recompiled for ALLDEPFD changes
. V11.02.01  03/02/2022  Thanh T        TSK 0877055
.            Changed PMIAUD80 to write out description for type 009,
.            010 and 011 
. V11.01.16  11/01/2021  Ebon Clements  TSK 0912886
.            Added NWAU 2022 (N22) to WIESVL00
. V11.01.15  23/11/2021  Jacob Jackson  TSK 0882972
.            Recompling for PATMASTM & PMSPX2FD changes
. V11.01.14  19/11/2021  Thanh T        TSK 0905116
.            Added PRDT1000 to return pwdvtype flag 
. V11.01.13  14/10/2021  Ebon Clements  TSK 0897124
.            Added emergency visit number tag - PRDT0900
. V11.01.12  15/09/2021  Thanh T        TSK 0889595
.            Changed PMAD0100 for Consent upload to my health record 
.            description from Category P1             
. V11.01.11  09/09/2021  Davin          TSK 0910121
.            Don't display date/time/userid tags if admissno is not populated
.            (pfnd6400/pfnd6500/pfnd6600)
. V11.01.10  17/08/2021  Don Nguyen     TSK 0875549
.            Modified ACCLST00 for new ACC Claim Status values (FAILED1-5)
. V11.01.09  21/07/2021  Ebon Clements  TSK 0905585
.            When defaulting the latest visit number after a patient search
.            only select ED visits from the users current ED site - FNDCUR40
. V11.01.08  07.07.2021 J.Tan           TSK 0904224 
.            Mod checking PTCNDRSM - variable for reparation mode
. V11.01.07  28.06.2021 DA Sarkies      TSK 0898410 
.            On line 30513 changed wRITE to WRITE.  
. V11.01.06  28/05/2021  Thanh T        TSK 0901851
.            Changed column heading from "Contract" to "Contracted"
. V11.01.05  25/05/2021  Sunny          TSK 0893449
.            Added HOSPFLAG to OVTTEMP1
. V11.01.04  20/05/2021  Thanh T        TSK 0868699
.            Added TABX1600/GTCCRD00 to return the concession card details
.            for NDIS 
. V11.01.03  27/04/2021  Thanh T        TSK 0895165
.            Recompiled for OPRARDFD changes
. V11.01.02  27/04/2021  Thanh T        TSK 0901851
.            Changed DISTAB00 and OPRTAB00 to show contract care flag 
. V11.01.01  22/02/2021  J.Tan           TSK 0888639
.            Changed patmmbs counter record to DIM3
. V11.00.27  19/01/2021  Thanh T        TSK 0872840
.            Recompiled as PATMSXTM changes
. V11.00.26  19/01/2021  Thanh T        TSK 0868699
.            Added TABX1500 to return if indicator 1 of credit card 
.            type (cat ct)   
. V11.00.25  16/12/2020  J.Tan          TSK 0892766
.            Added </b> to MBSTAB90
. V11.00.24  14/12/2020  Thanh T        TSK 0868699
.            Recompiled as PATMSXTM changes
. V11.00.23  09/12/2020  Thanh T        TSK 0872840
.            Recompiled as PATMSXTM and PMSPX2TM changes 
. V11.00.22  12/11/2020  Thanh T        TSK 0878747
.            Changed TABX1400 for multiple birth 
. V11.00.21  11/11/2020  Jill Parkinson Task 0899705
.            Removed some file opens from init0000 including wies 11-18
. V11.00.20  11/11/2020  Thanh T        TSK 0878747
.            Added TABX1300 and TABX1400
. V11.00.19  08/10/2020  Ebon Clements  TSK 0893634
.            Recompiled for WIESCALC - WIES27 Aboriginal and Torres Strait
.            Islander loading
. V11.00.18  08/10/2020  Sunny          TSK 0896481 
.            Added PTCLM082 for Insurance Company Code
. V11.00.17  28/09/2020  Don Nguyen     TSK 0889111
.            Added tag output for PTCNOHCS (Location of OHC-SM Server).
.            Added remote script routine (VALHGE00) to validate a non-empty
.            HCP GUID1/GUID2 value.
. V11.00.16  23/09/2020  Ebon Clements  TSK 0893634
.            Recompiled for WIESCALC - Added WIES27 for 2020/2021
. V11.00.15  24/08/2020  Tracey Nguyen  TSK 0893679
.            Added NZFLAG functionality - LSTEXC00, TABL500, TABX1200 
. V11.00.14  07/07/2020  Davin          TSK 0864683
.            Output description for audit type 012 (NHI MWS Local Edits)
.            in pmi audit changes tag (TABX0600/PMIAUD00)
. V11.00.13  07/07/2020  Tracey Nguyen   TSK 0888423
.            Added check for PTCNIRAI=2 - Display Invoice Raised By and Time
.            Invoice Raised - PATINV00
. V11.00.12  30/06/2020  Jill Parkinson Task 0891932
.            Recompiled for NZHISWIO
. V11.00.11  22/06/2020  Ebon Clements  TSK 0892739
.            Display OP bookings (Not attended) in TAC visits to update
.            claim number list - UTCTAB00
. V11.00.10  22/06/2020  Ebon Clements  TSK 0892739
.            Display all TAC visits to update claim number - UTCTAB00
. V11.00.09  29/05/2020  Ebon Clements  TSK 0890185
.            Added EDWARD trigger writes to supervisor transfer file updates
.            EDWT0000
. V11.00.08  26/05/2020  Davin          TSK 0890603
.            Recompiled for WEBGROUP/WIESCALC - WIES for private facility
. V11.00.07  26/05/2020  Tracey Nguyen  TSK 0864088
.            Added new tags FHIR1900, FHIR2000, FHIR2100
. V11.00.06  15/04/2020  Ebon Clements  TSK 0890104
.            Recompiled for PATMASTM - Preferred name in header display
. V11.00.05  02/04/2020  J.Tan          TSK 0868813
.            Changed PKNAME to DIM80
. V11.00.04  20/03/2020  Peter Vela     TSK 0889143
.            Fixed OUTLET IO calls
.            20/03/2020  Tracey Nguyen   TSK 0887397
.            Recompiled for PATVISTM - Added VISS6600
. V11.00.03  18/03/2020  Peter Vela     TSK 0889143
.            Recompiled for OUTLETFD
. V11.00.02  16/03/2020  Tracey Nguyen   TSK 0889496
.            Recompiled for MRTAUCFD/IO - Added MRACDDNR,MRACOHCP,MRACOCOF,
.            MRACODAT
. V11.00.01  05/03/2020  J.Tan          TSK 0838262
.            Added Effective from and to date to MBS Item file
.            09/03/2020  Davin           TSK 0888568
.            Increased acc summary limit from 100 to 300 (ACCSUM00)
.----------------------------------------------------------------------
. V10.15.10  20/02/2020  Peter Vela      TSK 0887845
.            Recompiled for NZHISWIO
. V10.15.09  03/02/2020  Tracey Nguyen  TSK 0881801
.            Added span id=InsertNoVisitChbx - NOMORE00
. V10.15.08  13/12/2019  Nicole Torrisi TSK 0862107
.            Changed how HOSPFLAG is set in ALLBOK00
. V10.15.07  12/12/2019  Nicole Torrisi TSK 0862107
.            Added WAITFLAG and output of BKRX0000
. V10.15.06  26/11/2019  Don Nguyen     TSK 0880715
.            Added Remote Scripting functions to validate User Id (REMOTE00)
.            25/11/2019  Ebon Clements  TSK 0860142
.            Recompiled for NSHISWIO - GETMWS AE2034 Unrecoverable read error
. V10.15.05  20/11/2019  Thanh T        TSK 0884501
.            Changed THBL0000 to CLEAR VISTLINK instead of RESET VISTLINK 
. V10.15.04  25/10/2019  Richa Phogat   TSK 0865482
.            Updated linkPatient() by adding ALREUYN4 & ALDEPENC under ALLVIS30
. V10.15.03  25/10/2019  Jill Parkinson TSK 0882870
.            Removed check for bkrestat=0 in SELDT900
. V10.15.02  23/10/2019  Jill Parkinson TSK 0882870
.            Removed check for bkrestat=0 in SELDT000 as all patients with or
.            without bookings bkrestat=0
. V10.15.01  11/10/2019  Peter Vela     TSK 0882810
.            Added check for Employment Status parameter in PMDA0100
.            11/10/2019  Tracey Nguyen  TSK 0872408
.            Added DEWCOM00 to set Claim Status to 'Cancel' if only one visit
.            for the Claim Number exists (NZ only) instead of deleting it.
.            Note: this is the missing requirement for original TSK 0853817
. V10.14.24  01/10/2019  Nicole Torrisi TSK 0862107
.            Added setting of HOSPFLAG to all Visit Output routines
.            Added HOSPFLAG to OVTTEMP2
. V10.14.23  19/09/2019  Thanh T        TSK 0873083
.            Added CHKACC00 to check for user hospital access using 
.            centralised coding
. V10.14.22  06/09/2019  Jill Parkinson Task 0880282
.            Added tag for MH Legal status attribute exists      
. V10.14.21  26/08/2019  Davin          TSK 0880255
.            Recompiled for WIESCALC - Added WIES26 for 2019/2020
. V10.14.20  19/08/2019  Richa Phogat    TSK 0876834
.            Updated WCOLNZ00 by replacing colon(') with tilda(`) for DOCFNAME
. V10.14.19  31/07/2019  Richa Phogat    TSK 0876834
.            Updated field length for SAVDATA1,SAVDATA2,SAVDATNZ from 100 to 265
. V10.14.18  07/08/2019  Peter Vela      TSK 0858824
.            Added Additional HCPs functionality
. V10.14.17  31/07/2019  Richa Phogat    TSK 0876834
.            Updated field length for SAVDATA1 & SAVDATNZ from 65 to 100
. V10.14.16  30/07/2019  Peter Vela      TSK 0878294
.            Added VISTLINK in ALLCAD00 
.            Move  DPVIBILL to PVIBILL after the RPTEMP2 in ALLCAN10
. V10.14.15  04/07/2019  Richa Phogat    TSK 0876696
.            Updated WCOLNZ00 by adding PMWXVHCP and DOCFNAME
. V10.14.14  14/06/2019  Ebon Clements   TSK 0859728
.            Added cpmiskey cgi and tag
.            19/06/2019  Nicole Torrisi  TSK 0862107
.            Added HOSPFLAG for new Visits by Type - Enquiry view
. V10.14.13  30/05/2019  Thanh T.        TSK 0872539
.            Recompiled for NZHISWIO changes
. V10.14.12  28/05/2019  Jill Parkinson Task 0875431
.            Recompiled for OBSPALPR - Removed order by end date      
. V10.14.11  27/05/2019  Ebon Clements  TSK 0870183
.            Get rescheduled appointment clinic type from outhedaf  - APPTAB00
. V10.14.10  13/05/2019  Thanh T.       TSK 0874465
.            Changed PATLST30, WATLST20 and OUTROW00 to put in leading
.            spaces for visit number when the table row is written out
.            for sorting  
. V10.14.09  24/04/2019  Richa Phogat   TSK 0869550
.            Updated MVACCMOD by replacing ADMISSNO by DWCADMNO
. V10.14.08  16/04/2019  Jill Parkinson Task 0873397
.            Removed file opens to stop I*H (allprra2,pmsaida2,patletr2,
.            patecda2,patecoa2,obscnca2)
. V10.14.07  10/04/2019  J.Tan          TSK 0873031
.            Commented out checking for Hospital access in MRVTAB00
. V10.14.06  18/03/2019  B.G.Ackland    TSK 0835482
.            Change to Start and End Time for Outpatient Encounter
.            08/03/2019  J.Tan          TSK 0871034
.            Fixed Workers Comp.Contact name with an apostrophe
.            12/03/2019  Richa Phogat   TSK 0869550
.            Added ACCAUDFD/IO, CLACCAUD, TABX0900, MVACCMOD, MVACCREM, 
.            ACCAuditList under ACCSUM00
.            12/03/2019  Tracey Nguyen   TSK 0863060
.            Recompiled for PATVISTM - Added VISS6400 & VISS6500
.            12/03/2019  J.Tan          TSK 0871034
.            Mod MRVTAB00 to check for Hospital access
.            14/03/2019  Don Nguyen     TSK 0869412
.            Added read of ICD10 Ed.11 Go-live Date parameter (PTCNGDX1)
.            21/03/2019  Tracey Nguyen  TSK 0838668
.            Added CHARTREV in APPTAB00 and APPSCH00
. V10.14.05  27/02/2019  Nicole Torrisi TSK 0869561
.            Recompiled for OBSPALPR - Alert End Date display and sort
. V10.14.04  18/02/2019  Ebon Clements  TSK 0829856
.            Recompiled for GETEFDRG - Contract from effective date
. V10.14.03  14/02/2019  Ebon Clements  TSK 0828972
.            Recompiled for PATMASTM - SMR icon
. V10.14.02  11/02/2019  Ken Bell       TSK 0850101
.            THBL0000 changed to DFrameLink to avoid javascript error
. V10.14.01  07/02/2019  Ebon Clements  TSK 0856330
.            Recompiled for NZHISWIO - Alert end date
.---------------------------------------------------------------------
. V10.13.23  30/01/2019  Ebon Clements  TSK 0856330
.            Recompiled for NZHISWIO - Alert end date
. V10.13.22  25.01.2019  B.G.Ackland    TSK 0835482
.            Recompile for change to FHIR Encounter Reason in FHRDATCD
. V10.13.21  10/01/2019  Thanh T.       TSK 0863964
.            Added TABX0800/WTPACM00 
. V10.13.20  05/12/2018  Ania P         TSK 0859769
.            Added GTMX0000 & OTHS0300
. V10.13.19  04/12/2018  Nicole Torrisi TSK 0865955
.            Fixed to escape apostrophe in WBSENAME (APPTAB80)
. V10.13.18  28/11/2018  Don Nguyen     TSK 0864674
.            Corrected WL list output (ALLWAT00) to use Booking Number (WMBOOK)
. V10.13.17  12.11.2017  B.G.Ackland    TSK 0835482
.            FHIR Recompile for change to FHRDATCD
. V10.13.16  08.11.2018  Ebon Clements  TSK 0866235
.            Fixed clear of coder name if no patecdaf records - MRTCOD45
. V10.13.15  06.11.2017  B.G.Ackland    TSK 0835482
.            FHIR Output Change for Boolean values to not have quotes
. V10.13.14  01.11.2018  B.G.Ackland    TSK 0835482
.            Added deceased section to patient FHR resource in FHRDATCD
. V10.13.13  29.10.2018  B.G.Ackland    TSK 0835482
.            Fix telecom FHIR Output for extra comma
. V10.13.12  19/10/2018  J.Tan          TSK 0854372
.            Added selection of Anaesthetic type for Eclipse IHC
. V10.13.11  25/09/2018  Richa Phogat   TSK 0857201
.            Added Key before write and update step in UPEX0000
. V10.13.10  21/09/2018  Don Nguyen     TSK 0853817
.            Modified ACCSUM00 to output 'Claim Status' desc/value for NZ.
.            Modified WCOLST00 & UWCLST00 to exclude Cancelled records for NZ.
.            Modified WCOLKP00 (WCO Lookup Details) to exclude any Cancelled
.            records for NZ only.
. V10.13.09  14/09/2018  Peter McMullen TSK 0853413
.            Clear NHI continuation field NZIBCPTR for each transaction
. V10.13.08  13/09/2018  Thanh T        TSK 0863304
.            Changed CHKMEH00 to exit when MHCNDVIS = zero
. V10.13.07  04/09/2018  Richa Phogat   TSK 0857201
.            Added UPEX0000 to move TRNTOFNS to pattranf & pmsextaf
. V10.13.06  21/08/2018  Davin          TSK 0860935
.            Recompiled for WIESCALC - Added WIES25 for 2018/2019
. V10.13.05  20/08/2018  Ebon Clements  TSK 0861535
.            Recompiled for PATMISTM - Pluratily of baby tag
. V10.13.04  16/08/2018  Richa Phogat   TSK 0851999
.            Recompiled for PMSPX2TM
. V10.13.03  14/08/2018  Peter Vela     Task 0845218
.            Fixed reads to patcodes in PMAD0000
. V10.13.02  26/07/2018  J.Tan            TSK 0848506
.            Changed PP Doctor from DIM6 to DIM10
. V10.13.01  12/07/2018  Ken Bell       TSK 0850101
.            Assign VISTLINK icon for Inpatient Visit with Bookings
. V10.12.14  12/07/2018  Ken Bell       TSK 0850101
.            Added Edit Icon to access Visit Theatre History Enquiry
. V10.12.13  12/07/2018  Peter Vela     TSK 0845218
.            Added PMI Audit Changes
. V10.12.12  11/07/2018  Ebon Clements  TSK 0850366
.            Recompiled for PMSPX2TM
.            12/07/2018  Jill Parkinson TSK 0859770
.            Recompiled for NZHISWIO, DELMED00 to only send A31 if changed
. V10.12.11  05/07/2018  Thanh T        TSK 0857684
.            Recompiled for PATMISTM changes
. V10.12.10  03/07/2018  Ebon Clements  TSK 0859789
.            Removed UNPACK of SP70 into SP70  - GETCCD00              
. V10.12.09  26/06/2018  B.G.Ackland    TSK 0835482
.            Add Email to Contacts Output (JIRA AZH-1057)
. V10.12.08  19/06/2018  Richa Phogat   TSK 0854035
.            Updated OHVIS0000 to OHVIS000
. V10.12.07  30/05/2018  Nicole Torrisi TSK 0857634
.            Changed to not REP " 0" in SELPRINT when spooling
. V10.12.06  18/05/2018  Thanh T.       TSK 0851528
.            Recompiled for PATVISTM changed
. V10.12.05  24/04/2018  Richa Phogat   TSK 0856013
.            Added variable ANSWN, Recompiled for OBSPALPR
. V10.12.04  06/04/2018  Jill Parkinson TSK 0854140
.            Recompiled for orange BMI changed missed from 10.07
. V10.12.03  23/03/2018  Peter Vela      TSK 0853121
.            Added tag for Interpreter Required HEA
. V10.12.02  14/03/2018  Peter Vela      TSK 0843363
.            Added tags for PATQMH for hea in TABX0000
. V10.12.01  16/02/2018  Thanh T.        TSK 0851862
.            Added condition for showing the problem column only when
.            the SHOWPROB flag is set to true for NZ only.
. V10.11.19  27/12/2017  Steve Armstrong  TSK 0850165
.            Recompiled for changes to DGCLICAC.
. V10.11.18  02/11/2017  B.G.Ackland     TSK 0835482 
.            FHIR Additional Attrinbutes for Patient Email and GP 
. V10.11.17  02/11/2017  B.G.Ackland     TSK 0835482 
.            FHIR Additional Attrinbutes for Patient Email and GP 
. V10.11.16  09/11/2017  Ebon Clements   TSK 0843363 
.            Added display comments by type and line tag from VISCMTFD TABL9700
. V10.11.15  02/11/2017  B.G.Ackland     TSK 0835482 
.            Add telecom details for FHIR Output
. V10.11.14  23/10/2017  Ania P          TSK 0846812
.            Recompile for changes to OBSPALPR
. V10.11.13  13/10/2017  J.Tan           TSK 0839794
.            Mod to display 'Invoice Raised By'
. V10.11.12  02/10/2017  Steve Armstrong  TSK 0816814
.            Recompiled for changes to ACCDIAFD
.            03/10/2017  B.G.Ackland     TSK 0835482 
.            Change Output of FHIR Encounter Subject ID to SQUEEZE MRN
.            Change Output of FHIR Patient Include Contact Details
. V10.11.11  14.09.2017  B.G.Ackland     TSK 0835482 
.            FHIR Bundle and Include for Encounter?_id=xxxxx  Query
. V10.11.10  21/09/2017  Thanh T.        TSK 0821710                 
.            Removed PATCMNFD since it is not used                      
. V10.11.09  14.09.2017  B.G.Ackland
.            FHIR Fix Asseter having extra }
. V10.11.08  30/07/2017  Thanh T.        TSK 0821710
.            Audit admission/outpatient/UR comments.
. V10.11.07  18/08/2017  Ania P          TSK 0843179
.            Recompiled for IBAWEBCD
. V10.11.06  15/08/2017  Richa Phogat    TSK 0843534
.            Added condition in ALLVIS00 to fix the misalignment on NMDS Resbmi
. V10.11.05  15/08/2017  Davin           TSK 0842626
.            Recompiled for WIESCALC - Added WIES24 for 2017/2018
. V10.11.04  11/08/2017  Don Nguyen      TSK 0840948
.            Added FHIR1300-FHIR1500 (COREXT00) to output a flag for whether
.            Observation Patient Correspondence exists for the matching type.
. V10.11.03  30/07/2017  Thanh T.        TSK 0821710
.            Audit admission/outpatient/UR comments. changed PATMASTM/PMSPX2TM.
. V10.11.02  26/07/2017  Thanh T.        TSK 0821710
.            Recompiled PASMISTM
. V10.11.01  18/07/2017  Ebon Clements   TSK 0841312
.            Changed LOKCOD00 to call RDPTICD1 using the visit date
.            14/07/2017  Thanh T.        TSK 0821710
.            Audit Amission/outpatient visit comments. PATMISTM changed.
.---------------------------------------------------------------------
. V10.10.27  12.07.2017  Ebon Clements  TSK 0841312 
.            Check emrvcdaf for wahealth discharge diagnosis - WADD0000 
. V10.10.26  11.07.2017  B.G.Ackland    TSK 0835482 
.            FHIR Output Testing for ClinicalAide
. V10.10.25  28/06/2017  Ania P         TSK 840783
.            Added output for DVA Card Colour
. V10.10.24  27/06/2017  J.Tan          TSK 0840153
.            Mod to call SETMED00 if NZIBMWST is blank and NZHISWRN=2
. V10.10.23  23/06/2017  Jill Parkinson TSK 0840931
.            Recompiled for PATMASTM - disability alert issue
. V10.10.22  31/05/2017  Nicole Torrisi TSK 0835656
.            Recompiled for OBSPALPR - displaying all comment text in table
. V10.10.21  29/05/2017  Davin          TSK 0837871
.            MRT Visit List - Clear VISADIAG @ MRTCOD40 if no coding exists
. V10.10.20  22/05/2017  Peter Vela     TSK 0815643
.            Added Problem column to ALLVIS00 for NZ
. V10.10.19  16/05/2017  Nicole Torrisi TSK 0832568
.            Changed to not output merge alert JS for JSON calls
. V10.10.18  09/05/2017  Thanh T.       TSK 0320410
.            Update NMDS flag to '4' from '1' (patmi1af.aelig) for
.            resubmission when claim code is changed
. V10.10.17  10/05/2017  Peter Vela     TSK 0320086
.            Fixed Additional Injury Comments in WCOLKP17
. V10.10.16  09/05/2017  Thanh T.       TSK 0320410
.            Update NMDS flag to '4' from '1' (patmi1af.aelig) for
.            resubmission when claim code is changed
.            Reverse V10.07.37 changes
. V10.10.15  10.05.2017  B.G.Ackland    TSK 0835482 
.            FHIR Output Resolve Testing Issues 
. V10.10.14  09/05/2017  Thanh T.       TSK 0320410
.            Update NMDS flag to '4' from '1' (patmi1af.aelig) for
.            resubmission when claim code is changed
. V10.10.13  09/05/2017  Davin          TSK 0321570 
.            Recompiled for OBSPALPR
. V10.10.12  08.05.2017  B.G.Ackland    TSK 0835482 
.            FHIR Output Resolve Testing Issues Incorporate Version Control
. V10.10.11  05/05/2017  Ebon Clements  TSK 0837902 0835482
.            Changed UNITDESC back to a DIM 20 as it's used in temp files
. V10.10.10  27/04/2017  B.G.Ackland    TSK 0835482
.            Fix FHIR Encounter Resource for Patient Visits
. V10.10.09  21/04/2017  B.G.Ackland    TSK 0835482
.            FHIR Encounter Resource for Patient Visits
. V10.10.09  13/04/2017  B.G.Ackland    TSK 0835482
.            Changes to enable FHIR Interface Processing
. V10.10.08  13/04/2017  B.G.Ackland    TSK 0835482
.            Changes to enable FHIR Interface Processing
. V10.10.07  07/04/2017  Tracey Nguyen  TSK 0835559
.            Fixed GETVIS05 and added GETVIS06 to populate single site
.            Emergency location
. V10.10.06  27/03/2017  B.G.Ackland    TSK 0835482
.            Changes to enable FHIR Interface Processing
.            28/03/2017  Don Nguyen     TSK 0828266
.            Recompiled for NAMSTRCD - Added UPCHYP00
. V10.10.05  29/03/2017  Thanh T.       TSK 0832066
.            Changed DVA PREPAT/PMPXDVAC fields to use the new
.            concession card PMCDCNUM/PMCDDVAC fields
. V10.10.04  24/03/2017  Peter Vela     TSK 0829992
.            Added updates to acccmtaf (type 002), accdiaaf, accrfpaf
.            in UPDCLM50
. V10.10.03  22/03/2017  Peter Vela     TSK 0833050
.            Recompiled for PATVISTM
. V10.10.02  17/03/2017  Davin          TSK 0833093     HDP 2017/2018
.            Add ICD10 Ed.10 - Go-live Date PTCNGDVX (Sect.110 Pos.85)
. V10.10.01  07/03/2017  Peter V        TDK 0833050
.            Recompiled for PATVISTM
.            02/03/2017  Thanh T.       TSK 0322732
.            Added Post Discharge Coding Warning
. V10.09.03  22/02/2017  Don Nguyen     TSK 0833732 & 0323565
.            Modified VISTAB00, VISITS00, PATLST00 & GETVIS00 for SHOWCARE
.            Added SHOWCARE - flag to output Care Type & Discharge Destination
. V10.09.02  13/12/2016  Davin          TSK 0310498
.            Added PTMIPCMX to UPDPLINK (updParentLink) in PATLST00
.            Limit inpatient visit output to 10 if checkcnt=2 (PATLST00)
. V10.09.01  04/12/2016  Ken Bell       TSK 0825816
.            Add new column for Emergency Visit First Seen Date Time
.            29/11/2016  Jill Parkinson TSK 0822329
.            Added output of new ACC fields in WCOLNZ00            
. V10.08.30  23/11/2016  Ebon Clements  TSK 0824258
.            Added test for duplicate transfer record - UPDTRN30
. V10.08.29  21/11/2016  Davin          TSK 0299197
.            Recompiled for OBSPALPR (added Requested By HCP to alert list)
. V10.08.28  18/11/2016  Peter Vela     TSK 0827671
.            Added single space after Parent of <Initial>.
.            before write to patre1af
. V10.08.27  10/11/2016  Davin          TSK 0310498
.            Added UPDPLINK (updParentLink) to PATLST00/BOKLST00 to copy
.            previous details to a booking
. V10.08.26  08/11/2016  Ania P         CAR 0825145
.            Added output of primary diagnosis only in PATLST (#51)
. V10.08.25  03.11.2016  Ken Bell       TSK 0287747
.            Added Anaesthetic Type lookup Function (new tag for PMVXUD15)
. V10.08.24  02.11.2016  Ebon Clements  TSK 0305048
.            Added clinical note enquiry functionality
. V10.08.23  27/10/2016  Ania P         CAR 0825432
.            Added output of PMWXTPRO to WCOLKP40
. V10.08.22  18/10/2016  Davin          TSK 0814504
.            Added output of small buttons to SELDT000 for date select tag
.            Disable date select for bookings and preadmissions
. V10.08.21  11/10/2016  Peter Vela     TSK 0321329
.            Added functionality to view/change icontracted leave movement 
.            details in MVDTAB00
. V10.08.20  27/09/2016  J.Tan          TSK 0824154
.            Mods GETVIS05 to display Hospital name for  Emergency location 
. V10.08.19  23/09/2016  Peter Vela     TSK 0324027
.            Shortened LOOPCNTR validation in ALLOUT00
.            14/09/2016 Ania P          CAR 0825145
.            Added output tag #50 in PATLST00
. V10.08.18  09/09/2016  Peter Vela     TSK 0324027
.            Fixed temp file functionality in ALLOUT00
. V10.08.17  05/09/2016  Don Nguyen    TSK 0323565
.            Increased size of VSTATUS from 45 to 100.
.            Modified PATLST00 - output Discharge Destination & Care Type.
.            Modified GETVIS15 - output Care Type for Current & Discharged pat
. V10.08.16  02/09/2016  Davin         TSK 0825157
.            Recompiled for WIESCALC
. V10.08.15  01/09/2016  Don Nguyen    TSK 0323562
.            Added PROFLD22 to output SUPERLEV value
. V10.08.14  26/08/2016  Don Nguyen    TSK 0312570
.            Recompiled for GETDRG (GTDRG000) - Call GTEDRG00 when PTCNDGED=1
.            Added PMSEDGFD/IO and GETEFDRG
.            25/08/2016 Jill Parkinson TSK 08229514
.            Added in call to SETMED00 for medical warning page
. V10.08.13  22/08/2016 Peter Vela      TSK 0324097
.            Added LOOPCNTR functionality to ALLOUT00
. V10.08.12  15/08/2016 Ebon Clements   TSK 0814574
.            Re read logged in user before opening OP file - VISTAB00 - OUTFIL00
. V10.08.11  28/07/2016  Ebon Clements  TSK 0816935
.            Added NZ W/L intended hospital filter - ALLWAT00
. V10.08.10  27/07/2016  Jill Parksinon TSK 0816210
.            Added branch after OPENHTML in JSON0000
.            Removed square brackets from JSON0000 error messages
. V10.08.09  27/07/2016  Ebon Clements  TSK 0816935
.            Fixed cancelled bookings list hospital filter - CANBOK00
.            Added NZ W/L intended hospital filter - CANWAT00 & WATLST00
. V10.08.08  20/07/2016  Don Nguyen     TSK 0294154
.            Modified SETPAR00 to replace space with zero for SELPRINT
.            19/07/2016  Davin          TSK 0822753
.            Recompiled for WIESCALC - Added WIES23 for 2016/2017
.            Changed ADNODAYS and EPSNOLOS to FORM4 (same as NBRDAYS)
. V10.08.07  08/07/2016  Jill Parkinson TSK 0822002
.            Recompiled for PATMASTM
. V10.08.06  30/06/2016  Jill Parkinson TSK 0821749
.            Added match of sp70 to PMVXUDF7 for Upload to PCEHR
. V10.08.04  15/06/2016  Ebon Clements  TSK 0322380
.            Recompiled for PATVISTM - Inform GP tag
. V10.08.03  20/05/2016  Peter Vela     TSK 0817336
.            Added default printer to free format labels FREEFM00
. V10.08.02  18/04/2016  Peter Vela     CAR 0294177
.            Changed read to prihdb to KEY27
. V10.08.01  12/04/2016  Ania P         CAR 319862
.            Further ANSNAP changes
.            08/04/2016  Don Nguyen     TSK 0815007
.            Added PTPGECRW in CLRGRP00
.            05/04/2016  Nicole Torrisi TSK 0815847
.            Fixed display of NMDS table cells
. V10.07.16  03/03/2016  Ania P         CAR 319862
.            Added TABL9200/9300  for AN-SNAP screens
. V10.07.15  29/02/2016  Peter Vela     TSK 0809143
.            Added tag for External Visit ID
. V10.07.14  22/02/2016  Davin          TSK 0814047
.            Added tag for selected date (no submit) - SELDT000/PRDT0800
. V10.07.13  16/02/2016  Ebon Clements  TSK 0809793
.            Added movements comments to MRT list - MRTTAB00
. V10.07.12  14/01/2016  Ebon Clements  TSK 9294144
.            Added IP SMS selection list - ISMS0000
.            Added OP SMS selection list - OSMS0000
. V10.07.11  13/01/2016  Peter Vela     CAR 0809272
.            Changed LOOPCNTR to FORM 6
. V10.07.10  04/01/2016  Ebon Clements  TSK 0294154
.            Added opt out of SMS functionality to previous address
. V10.07.09  08/12/2015  Davin          CAR 310749
.            Added extra diet details for report option 4 (CCOM0000/catcomaf)
. V10.07.08  16/12/2015  Ebon Clements  CAR 294154 
.            Don't display SMS messages in IP letter list - SELPLT00
. V10.07.07  15/12/2015  Don Nguyen     TSK 0318657
.            Recompiled for PATMSXTM - Added output for PUYN2
. V10.07.06  11/12/2015  Peter Vela     CAR 317276
.            Added new tag for Diet 1 in PRDT0000
. V10.07.05  30/10/2015  Don Nguyen     CAR 320394
.            Recompiled for changes to WATTX1FD/IO
. V10.07.04  28/10/2015  Don Nguyen     CAR 316635
.            Added Visit No. output (WMBOOK) for Waiting List records in
.            WATLST00, ALLWAT00 and ALLCAN00.
. V10.07.03  23/10/2015  Ebon Clements  CAR 320819
.            Added Inactive test to letter selection lists
. V10.07.02  19/10/2015  Don Nguyen     CAR 316625
.            Modified TRNTAB00 and MVDTAB00 to output CASTDESC (Case Team desc)
. V10.07.01  07/10/2015  Don Nguyen     CAR 316635
.            Added FILTVTYP=12 - All cancelled visits (ALLCAN00)
.---------------------------------------------------------------------
. V10.06.26  17/09/2015  Ebon Clements  CAR 321734
.            Fixed OP booking U/R number test - JSON0000
. V10.06.25  07/09/2015  Jill Parkinson CAR 313323
.            Added output of ddate in CCYYMMDD format
. V10.06.24  03/09/2015  Peter Vela     CAR 316627
.            Added Status filter to Allied Health Visit List ALLVIS00
. V10.06.23  02/09/2015  Jill Parkinson CAR 320331
.            Recompiled for PATMASTM - DISALR00 to not include medical,micro or
.            risk alerts
. V10.06.22  26/08/2015  Jill Parkinson CAR 318680
.            Recompiled for NZHISWIO
. V10.06.21  24/08/2015  Jill Parkinson CAR 320905
.            Recompiled for NZHISWIO
. V10.06.20  24/08/2015  Ebon Clements  CAR 319970
.            Fixed record type match in DISPRH10
. V10.06.19  13/08/2015  Don Nguyen     CAR 308621 
.            Recompiled for PATVISTM - Added VISS6100
. V10.06.18  06/08/2015 Jill Parkinson  CAR 313323 
.            Added output of PBDATE and PDECDTE in CCYYMMDD format
. V10.06.17  31/07/2015 Jill Parkinson  CAR 313323 
.            Added 4003 error message in JSON0000
. V10.06.16  24/07/2015  Davin          CAR 308063
.            Recompiled for OBSCNATM
. V10.06.15  14/07/2015  J.Tan             CAR 317921
.            Recompiled for PMSEXTTM - checking for inactive Insurance code
. V10.06.14  14/07/2015  Ania P         CAR 319069
.            Fixed matching of records in DISPRH10 
. V10.06.13  09/07/2015  Jill Parkinson CAR 313321
.            Added call to CHGNZ000 in CURCC000
. V10.06.12  07/07/2015  Jill Parkinson CAR 313321
.            Added updates of AELIG when updating admission details via 
.            supervisor functions
. V10.06.11  03/07/2015  Don Nguyen    CAR 313365
.            Added IADD4 in FPRA0500 and fixed FPRA7250 to correctly map PKADD4
. V10.06.10  25/06/2015  Don Nguyen     CAR 318419
.            Recompiled for OBSPALPR - Added ALTROW04
. V10.06.09  10/06/2015  Peter Vela     CAR 316780
.            Added space after output of ADIADESC in PATLST00, WATLST00,
.            BOKLST, OUTLST00 (OUTROW00)
.            to prevent escape of double quotes in the front end
. V10.06.08  09/06/2015  Jill Parkinson CAR 313323
.            Added JSON outputs for NZ
. V10.06.07  03/06/2015  Patrick Adair  CAR 305377
.            Add Colour Coded Care Type in visit lists
. V10.06.06  31/05/2015  Jill Parkinson CAR 313321
.            Added nmds status for nmds resubmit list
. V10.06.05  15/05/2015  Davin         CAR 310155
.            Recompiled for PATGBCRN - added MOD10V05 for BPAY
.            16/04/2015  Ania P           CAR 261630
.            Recopiled for OBSDIATM  
.            12/04/2015  J.Tan            CAR 304813
.            Changes to handle WIES22
.            10/04/2015  Steve Armstrong  CAR 313849
.            Added external reference for CLPMSWX1
. V10.06.04  17/03/2015  Davin            CAR 311669      HDP 2015/16
.            Add ICD10 Ed.9 - Go-live Date PTCNGDV9 (Sect.110 Pos.77)
. V10.06.03  18/03/2015  Ania P           CAR 306161
.            Recompiled for OBSMED
. V10.06.02  12/03/2015  Steve Armstrong  CAR 314108
.            Removed definition of PTCGDATE as PATCGPFD is no longer
.            in use.
. V10.06.01  12/03/2015  Ania P         CAR 311205
.            Recompiled for PATVISTM
.---------------------------------------------------------------------
. V10.05.24  02/03/2015  Ebon Clements  CAR3118480
.            Fixed display of cancelled appointment hospital if the
.            session has also been cancelled. - CCTY0000 
. V10.05.23  11/02/2015  Patrick Adair  CAR 208170
.            Added Report 11 - Previous HCP/Practice Audit Details
. V10.05.22  19/01/2015  Ania P         CAR 224736
.            Added extra if statement to blocks calling OpenAllRef
. V10.05.21  07/01/2015  J.Tan          CAR 305441
.            Added tag for 'Upload to PCEHR'
. V10.05.20  06/01/2015  Ania P         CAR 224736
.            Reversed changes that were made for CAR 305765
.            and added NZ flag PTCNHDPS
. V10.05.19  17/12/2014  Jill Parkinson CAR 310045
.            Removed SETMED00 fromin TABMWR00 (medical warnings table output)
. V10.05.18  05/12/2014  Peter Vela     CAR 307905
.            Added tag for EMVIDOCT in PFND0000
. V10.05.17  01/12/2014  J.Tan          CAR 309216
.            Added a tag for Patient postcode without trailing spaces
. V10.05.16  17/11/2014  Peter Vela     CAR 308144
.            Recompiled for PATICDIO
. V10.05.15  11/11/2014  Jill Parkinson CAR 306745
.            Recompiled for NZHISWIO - trap around write to patmwsaf
. V10.05.14  10/11/2014  Don Nguyen     CAR 303211
.            Modified FHOS0000 to output hospital code for PTCNWBDS=0
.            Also removed extra hyphen ("-") after hospital name
. V10.05.13  28/10/2014  Ebon Clements  CAR 247293
.            Added SP70 test to ALENLINK for linked MR volume - MRTDES00
. V10.05.12  23/10/2014  Ebon Clements  CAR 306122
.            Added SHOWALLH menu cgi to show all my hospitals visits
.            on the pre admit prev details screen
. V10.05.11  20/10/2014  Ebon Clements  CAR 268970
.            Change to use OUTCLIFD index 1 instead of index 2
. V10.05.10  13/10/2014  Ebon Clements  CAR 300196
.            Added nonxtpat cgi for patient level nutirion update redirect
. V10.05.09  03/10/2014  Patrick Adair  CAR 305765
.            removed OpenAllRef calls as per request from WAHEALTH
. V10.05.08  03/10/2014  Patrick Adair  CAR 305765
.            Corrected SECOPT value in OpenAllRef calls
. V10.05.06  24/09/2014  Peter McMullen CAR 303578
.            Remove redundant CONNECT call in mainline
. V10.05.06  18/09/2014  Davin            CAR 304204
.            Recompiled for GETDRG - get drg vers based on disch date
. V10.05.05  09/09/2014  Davin          CAR 296980
.            Changes to handle WIES21
.            10/09/2014  J.Tan             CAR 274958
.            Added Employer code to pmswx1af file (pmwxecod)
. V10.05.04  21/08/2014  Don Nguyen     CAR 303878
.            Recompiled for changes to PATMASTM
. V10.05.03  19/08/2014  Peter Vela     CAR 304267
.            Added validation in ALLVIS00 for emergency visits, to prevent
.            duplicate display of No More Visits message
. V10.05.02  25/07/2014  Ebon Clements  CAR 301870
.            Added .2 option to only display coder ID if coded - CODUSR00
. V10.05.01  25/07/2014  Ebon Clements  CAR 301582
.            Fixed ED doctor display on visit list for ED visits - GETVIS05
. V10.04.21  14/07/2014  Don Nguyen     CAR 302820
.            Added test for FILTFLAG=2 ('All' hospitals) to HSEL0000 & HHSL0000
. V10.04.20  03/07/2014  Patrick Adair  CAR 301636
.            Change ALLVIS80 to display Case Team Description
. V10.04.19  03/07/2014  Ebon Clements  CAR 301058
.            Only display ICD coding enquiry page patweb9801023 if you
.            are on a valid IP visit - GETPAT00
. V10.04.18  02/07/2014  Ania P         CAR 224736
.            Changed EditIcon layout in VISTTYPE in ALLTAB30/ALLVIS30
. V10.04.17  10/06/2014 Jill Parkinson CAR 301639  
.            Moved call to TFILENAM for CFNAMEO to be in INIT0000         
. V10.04.16  30/05/2014  Jill Parkinson CAR 301613
.            Mods to pack admissno with spaces before WRTEMP1 is called
. V10.04.15  20/05/2014  Ania P         CAR 224736
.            Added EditIcon to VISTTYPE in ALLTAB30/ALLVIS30
. V10.04.14  09/05/2014  Don Nguyen     CAR 300097
.            Fixed SETMWD00 to clear CDAY, CCENT, CYEAR and MTHNAM3 for '0' vals
.            08/05/2014  Ania P         CAR 224736
.            Added EditIcon to VISTTYPE output in PATLST30
. V10.04.13  16/04/2014  Peter Vela     CAR 267987
.            Moved CLER0000 to the end of ALLOUT00
.            Fixed key in CLER0000 
. V10.04.12  16/04/2014  Jill Parkinson CAR 299616 
.            Added re-read of websecaf in CKAL0000
. V10.04.11  07/04/2014  Peter Vela      CAR 286258
.            Recompiled for PATMASTM
. V10.04.10  03/04/2014  J.Tan            CAR 299607
.            Fixed FPRA7250 - removed PACK SP70 with Contact name for WA WComp.
. V10.04.09  31.03.2014  B.G.Ackland  CAR 299363
.            Replace META Tag Redirect with Javascript in Common RDIREC00
.            Routine
. V10.04.08  26/03/2014  Peter Vela       CAR 262987
.            Implemented date/time sorting for all outpatient types
.            in ALLOUT00
. V10.04.07  24/03/2014  Steve Armstrong  CAR 298483
.            Recompiled for changes to DGCLICOB.
. V10.04.06  17/03/2014  Don Nguyen      CAR 295972
.            Modified DISPRA00 to output cell widths
. V10.04.05  28/02/2014  Peter Vela      CAR 218689
.            Added Theatre Requests to VISTAB00
.            Added Theatre Requests to VISITS00
.            26/02/2014  J.Tan           CAR 275810
.            Recompiled for PMSEXTTM - added Defence Approval No and PMIKeys No.
. V10.04.04  24/02/2014  Don Nguyen      CAR 291879
.            Added TABL8400 - paramater value for 'Using NEHTA Identifiers'
.            Added TABL8500 - table rows output (IHI Numbers)
.            10/02/2014  Patrick Adair   CAR 273419
.            updated pteodesc and ptddesc to display 200 characters
. V10.04.03  22/01/2014  Don Nguyen      CAR 295972
.            Added PATPA003 - Time prev address record was changed.
.            Changed KEY16 to KEY24 for IO calls on patpa1af.
.            Modified DISPRA00 for new table row output.
. V10.04.02  16/01/2014  Patrick Adair   CAR 295431
.            Modified CLMLKP00 to replace ' with ` in various output fields
. V10.04.01  13/01/2014  Don Nguyen      CAR 295366
.            Modified WCOLKP40 to also replace ' in employer address lines 3 & 4
.            Modified WCOLNZ00 to use replaced single quote values for employer.
.---------------------------------------------------------------------
. V10.03.107 11/12/2013  Peter Vela      CAR 287763
.            Added NOCANVIS=2 for Inform GP Visit List
.            Added validation for NOCANVIS after GETVIS00 in ALLTAB00 and
.            ALLVIS00
. V10.03.106 03/12/2013  Ebon Clements   CAR 293531
.            Increased TRNRECKY[] array from 50 to 99
. V10.03.105 27/11/2013  Ebon Clements   CAR 277712
.            Added wahealth cgi for redirect to mr merge
. V10.03.104 22/11/2013  Ebon Clements   CAR 293746
.            Added cancelled pre adm display to tags PFND6700 and PFND6800
. V10.03.103 21/11/2013  Peter Vela      CAR 287763
.            Added nocanvis - menu cgi input for do not display cancelled
.            admissions in PATLST00
. V10.03.102 12/11/2013  Don Nguyen      CAR 293943
.            Branch on EXIT after calls to OUTFIL00 (since it calls WEBERR00)
. V10.03.101 24/10/2013  Jill Parkinson  CAR 293138
.            Added check for bkrxpowd in BOKLST10 in case bkreward is blank
. V10.03.100 16/10/2013  Don Nguyen      CAR 289270
.            Replaced " with ' for javascript outputs of PDIADESC
. V10.03.99 08/10/2013  Ebon Clements    CAR 275205
.           Added UR tag to MISC0000
. V10.03.98 26/09/2013  Jill Parkinson   CAR 291691
.           Recompiled for NZHISWIO - over 15 medical warnings looping
. V10.03.97 19/09/2013  Jill Parkinson   CAR 291608   
.           Added clear of CASEKEYS and added pack in WATLST00                
. V10.03.96 12/09/2013  Don Nguyen       CAR 291050
.           Removed test on matching EPSCD001 against Coding Audit episode no.
. V10.03.95 11/09/2013  Don Nguyen       CAR 291050
.           Removed EPSCD001 from key in MRTCOD50 before calling RSMRAUC2
. V10.03.94 10/09/2013  Steve Armstrong  CAR 291089
.           Recompiled for changes to PMSQVIFD.
. V10.03.93 09/09/2013  Don Nguyen       CAR 290775
.           Added SELPLT00 for Patient Letter types (selection list options)
. V10.03.92 02/09/2013  Ania P           CAR 290147
.           Fixed cutting off of VSTATUS by moving TDESC to KEY20, not KEY10
. V10.03.91 08/08/2013  Davin            CAR 284960
.           Changes to handle WIES20
. V10.03.90 06/08/2013  J.Tan            CAR 287534     
.           Fixed PRFA for Defence force claimtype=D
. V10.03.89 31/07/2013  Jill Parkinson   CAR 288314     
.           Fixed delCareType ; at end
. V10.03.88 25/07/2013  Ebon Clements    CAR 228354
.           Fixed selection of highest (latest) coding date & time - CODDAT00
. V10.03.87 23/07/2013  Ania P           CAR 288806
.           Recompile for OBSPALPR
. V10.03.86 23/07/2013  Jill Parkinson   CAR 288982  
.           Fixed MVDTAB00 loop
. V10.03.85 23/07/2013  Davin            CAR 288134
.           Display location desc when ibcnmhos=0 for OP attendances (ocli0000)
. V10.03.84 18/07/2013  Steve Armstrong  CAR 268961
.           Recompiled for changes to PMSQVIFD.
.           19/07/2013  Davin            CAR 288134
.           Only display ED site hospital in vistloc if multihosp (getvis05)
.           Only display ED site in vistloc if > 1 ED site exists (getvis05)
. V10.03.83 18/07/2013  Jill Parkinson CAR 288525
.           Recompiled for NZHISWIO
.           Also, changed visit lists to show 50 instead of 15 visits
. V10.03.82 04/07/2013  Jill Parkinson CAR 287875   
.           Added output of both created by and also updated by/created by
.           user id's for transfer lists.  See CRUPUSER and DISPUSER
. V10.03.81 30/06/2013  Davin             CAR 283202
.           Recompiled for changes to hl7 messaging (pmsqptfd)
. V10.03.80 27/06/2013  J.Tan            CAR 287534
.           Fixed Defence Force (Catg CL Indic1=D) to read/update pmscexaf
. V10.03.79 20/06/2013  Peter Vela       CAR 283202
.           Recompiled for PMXPX2FD
.           20/06/2013  Davin            CAR 287161
.           Recompiled for PATGBCRN - right justify ptcnhbpi
. V10.03.78 13/06/2013  Ebon Clements    CAR 286359
.           Recompiled for PATCODTM - GOTO fixes
. V10.03.77 17/05/2013  J.Tan            CAR 285285
.           Mods to update PRFA for ATD62 Change Claim type
. V10.03.76 10/05/2013  Don Nguyen       CAR 281900
.           Modified UPDTRN70 and UPDTRN71 to validate HCP against entry date
. V10.03.75 02/05/2013  Don Nguyen       CAR 284693
.           Recompiled for changes to IBAWEBCD (TITLESEL & RELATSEL).
.           01/05/2013  Steve Armstrong  CAR 284376
.           Recompiled for changes to DGCLICUP.
. V10.03.74 23/04/2013  Davin           CAR 284420      HDP 2013/14
.           Add ICD10 Ed.8 - Go-live Date PTCNGDV8 (Sect.110 Pos.69)
. V10.03.73 24/04/2013  Ebon Clements   CAR 281942 
.           Fixed removal of temp file after free foramt label print
. V10.03.72 22/04/2013  Jill Parkinson  CAR 281454 
.           Added save of current ptafcsid in UPTRN000 for old audit value
. V10.03.71 19/04/2013  J.Tan            CAR 283608
.           Removed tag for Discharged Status or Destination depends on PTCNDRSM
. V10.03.70 18/04/2013  J.Tan            CAR 283608
.           Added tag for Discharged Status or Destination depends on PTCNDRSM
. V10.03.69 18/04/2013  Jill Parkinson CAR 281454
.           Removed GETCHA00, changed to read existing patasfaf record and vx1af
. V10.03.68 17/04/2013  Don Nguyen     CAR 282342
.           Corrected pos read for PTCNURBP
. V10.03.67 16/04/2013  Ebon Clements     CAR 283938
.           Added OP visit linked to AH referral number tag TABL8200
.           Added AH Referral linked to OP visit number tag TABL8300
. V10.03.66 09/04/2013  Don Nguyen     CAR 282342
.           Mods to use UR for BPAYINVN (if PTCNURBP=1)    
.           09/04/2013  Ania P         CAR 281454
.           Added GETCHA00 to correctly read change record.
. V10.03.65 08/04/2013  Ebon Clements  CAR 279861
.           Fixed OP location display for attended patients - OCLI0000
. V10.03.64 05/04/2013  J.Tan          CAR 283229
.           Changed TRNAUD02 from 'Financial Election' to 'Claim type'
. V10.03.63 05/04/2013  Ania P         CAR 281454
.           Show Contract ID in the "Original Value" or "Changed Value"
.           column if the Patient Type is CED or CNG.
.           Show Financial Election in the "Original Value" or "Changed Value"
.           column if the Claim Type is PUB.
. V10.03.62 03/04/2013  Davin          CAR 270648
.           Recompiled for changes to HL7 messaging includes
. V10.03.62 03/04/2013  Davin          CAR 270648
.           Recompiled for changes to HL7 messaging includes
. V10.03.61 26/03/2013  Don Nguyen     CAR 282342
.           Recompiled for PATGBCRN
. V10.03.60 21/03/2013  Jill Parkinson CAR 283050  
.           Changed HSHL2000 to save the key before looping back to HSHL0100
. V10.03.59 20/03/2013  J.Tan          CAR 281452  
.           Added Funding Source,Off duty to Supervisor Financial Election
. V10.03.58 19/03/2013  Jill Parkinson CAR 282814  
.           Recompiled for PATMASTM - Disability alert DSAL0000 change
. V10.03.57 14/03/2013  Patrick Adair    CAR 240163
.           Recompiled for OBSPALPR - Only display active H1-H9 categories
. V10.03.56 05/03/2013  Patrick Adair   CAR 281898
.           Corrected key for patecda1 and patecoa1 from KEY12 to KEY13
. V10.03.55 04/03/2013  Patrick Adair    CAR 277927
.           Changes to WCOLKP00 to list most recent WC visit first
. V10.03.54 27/02/2013  Ebon Clements   CAR 277862
.           Added FILTVTYP=11 AH waiting and active referral list - ALLVIS00
.           27/02/2013  Peter Vela      CAR 281454
.           Added Type of Change descriptions to TRNAUD00
. V10.03.53 25/02/2013  Ania P          CAR 281021
.           Removed unnecessary modification of constants.
. V10.03.52 20/02/2013  Davin           CAR 281453
.           Output checkboxes before descriptions in TRNSUP00
.           20/02/2013  Jill Parkinson  CAR 281453
.           Added output of pmvxfsrc in MISC1600, removed trailing spaces
.           from CODDESC in TRNSUP55
. V10.03.51 12/02/2013  Jill Parkinson  CAR 269884
.           Added DispDscError() - don't allow dsc.date/time to be changed
. V10.03.50 12/02/2013  Don Nguyen       CAR 270624    
.           Modified GETVIS08 to use EMVIUR02 for doctor code if it exists
. V10.03.49 08/02/2013  Don Nguyen       CAR 269884    
.           Added update of patasfaf with PTAFCSID for Patient Type in UPDTRN00
. V10.03.48 04/02/2013  Jill Parkinson   CAR 269884    
.           Added update of patvisaf with ADOCTA in UPDTRN00 for discharges when
.           changing doctor
.           Added update of trbtyp when changing tward/tbed in UPDTRN00
. V10.03.47 29/01/2013  Nicole Torrisi   CAR 233717    
.           Added Emergency Site to linkPatient() 
.           Added Emergency Site to visit location column
.           29/01/2013  Peter McMullen   CAR 275033    
.           Changed to move RF to VISTTYPE instead of AH      
. V10.03.46 22/01/2013  Jill Parkinson                 
.           Changed BOKLST00 to compare VISTHOSP instead of PMVXMHOS      
. V10.03.45 16/01/2013  Davin            CAR 269884
.           Added DispAdmError() - don't allow adm.date/time to be changed
.           Changed format of supervisor transfer audit fields (trnaud00)
. V10.03.44 18/12/2012  Davin            CAR 269884
.           Added option 10 - Supervisor Transfer Updates
. V10.03.43 23/11/2012  Davin            CAR 269884
.           Added output of team/registrar/resident (gettrn00,trntab00,mvdtab00)
.           29/11/2012  Don Nguyen       CAR 270624
.           Modified GETVIS08 to cater for blank EMVIDOCT (HCP column)
. V10.03.42 16/11/2012  Mike Laming      CAR 228354
.           Changes to CODDAT00 to get latest Disease and Oper dates
.           16/11/2012  Jill Parkinson   CAR 276504
.           Mods to remove tempfiles
. V10.03.41 13/11/2012  Jill Parkinson  CAR 272598
.           Recompiled for OBSPALPR - Added reset of ALRCOMM to fix rep of "
. V10.03.40 29/10/2012  Jill Parkinson  CAR 275362
.           Fixed GOTO's in TABL7600,TABL7700 and TABL7800 to stop after UR
. V10.03.39 25/10/2012  Jill Parkinson  CAR 275362
.           Recompiled for TFILENAM - added open of weberraf
. V10.03.38 12/10/2012  Patrick Adair   CAR 273294
.           Recompiled for PATCLMTM
. V10.03.37 04/10/2012  Davin            CAR 265550
.           Recompiled for PMSNUTTM
. V10.03.36 01/10/2012  J.Tan            CAR 273822
.           Mods to use CAGECOFF for 'Parent of' PRFA
. V10.03.35 23/08/2012  Ebon Clements    CAR 270231
.           Changed wahealth ED discharge doctor to also display
.           the ED attending doctor - EDDISDOC
. V10.03.34 14/08/2012  Ebon Clements    CAR 253592
.           Added SHOWPPRV show my hospital visits on pre adm prev details
. V10.03.33 07/08/2012  Patrick Adair    CAR 257776
.           Check for existence of Admission and Discharge FIM scores
. V10.03.32 03/08/2012  J.Tan            CAR 263723
.           Mods checking CL INDC18 for WA PRFA
.           03/08/2012  Ebon Clements    CAR 261630
.           Removed port number from temp files
.           08/08/2012  Davin             CAR 270114
.           Changes to handle WIES19
. V10.03.31 20/07/2012  Ebon Clements    CAR 217579
.           Recompiled for PATVISTM - Patient BMI tag
. V10.03.30 20/07/2012  Don Nguyen       CAR 264561
.           Recompiled for PATGBCRN
.           Also read in Hospital ID before calling GBCRN000
. V10.03.29 18/07/2012  Ebon Clements    CAR 266290
.           Added display in transit functionality
. V10.03.28 06/07/2012  Mike Laming      CAR 253058
.           Add test for Mental Health Visit (for NZ) in OTHS0000 (also see
.           DRGS0000)
. V10.03.27 05/07/2012  Mike Laming      CAR 267008
.           Change at ALLVIS80 for "Case Team Desc" (not Code) for NZ & added
.           ALLCASFD/IO
. V10.03.26 28/06/2012  Mike Laming      CAR 267797 HDP 2012 DRG 6.2
.           Added DRG062 & WIES for DRG 6.2 in WIESVL00
. V10.03.25 15/06/2012  Don Nguyen       CAR 266261
.           Added code (TABL0000) to output Waiting List Procedure descriptions
. V10.03.24 25/05/2012  Mike Laming      CAR 262001
.           Mods to GETVIS00 to fix Outpatients HCP Column (for Clinic & Doctor)
. V10.03.23 16/05/2012  Steve Armstrong  CAR 265322
.           Recompiled for changes to NZHISWIO.
. V10.03.22 14/05/2012  Mike Laming   CAR 263424
.           Mods to Episode Dates & LOS in CPDATS00 for Episodic Coding
. V10.03.21 16/04/2012 Don Nguyen     CAR 263514
.           Recompiled for OBSPALPR
. V10.03.20 16/03/2012 Ebon Clements  CAR 262013
.           Changed rescheuled appointment alert to use HTMLLMKL - APPTAB80
. V10.03.19 08/03/2012 Jill Parkinson CAR 261232
.           Mods to use INSTANCE and HOSTNAME environment variables
. V10.03.18 29/02/2012 Ebon Clements  CAR 209358
.           Added rescheduled by date and time to reschedule alert - APPTAB76
. V10.03.17 16/02/2012  Peter Vela     CAR 260333
.           Added CLMEHDIA to GETPAT05
. V10.03.16 08/02/2012  J.Tan          CAR 256004
.           Fixed WCO Claim number lookups
. V10.03.15 07/02/2012  Jill Parkinson CAR 254812
.           Recompiled for IBAWEBCD
. V10.03.14 30/01/2012  Mike Laming    CAR 259106
.           Mods to "Red" Hospital (using Cat"TY" from MRCNRCTY) at MRTTAB55
. V10.03.13 16/01/2012  Sandra Barcham  CAR 256563
.           Recompiled for PATMASTM
. V10.03.12 09/01/2012  Peter Vela     CAR 253845
.           Added location description to OUTLST000
.           Added location description to ALLOUT00
.           Added location description to ALLSIT00
. V10.03.11 19/12/2011  Ebon Clements  CAR 257425
.           Recompiled for IBAWEBCD - WINENQ00 to redirect top content
. V10.03.10 12/12/2011  Mike Laming    CAR 255302
.           Recompiled for further changes to PATMISTM
. V10.03.09 12/12/2011  Mike Laming    CAR 255302
.           Recompiled for changes to PATMISTM
. V10.03.08 09/12/2011  Jill Parkinson CAR 249362
.           Recompiled for OBSPALPR - alert list inactive dates
. V10.03.07 07/12/2011  J.Tan          CAR 246468
.           Fixed description for Deceased Estates
. V10.03.06 07/12/2011  Jill Parkinson CAR 245312
.           Added secopt=3 and casekeys for bookings from WL in VISTAB00
. V10.03.05 05/12/2011  Jill Parkinson CAR 249362
.           Recompiled for OBSPALPR
. V10.03.04 02/12/2011  Davin          CAR 251748
.           Recompiled for changes to PATWIS18
. V10.03.03 29/11/2011  Jill Parkinson    CAR 249362
.           Recompiled for PMSALAIO - alert key changes
. V10.03.02 24/11/2011  Jill Parkinson    CAR 249362
.           Recompiled for OBSPALPR - alert key changes
. V10.03.01 09/11/2011  Ebon Clements     CAR 248529
.           Added multiple contacts of the same type functionality
.           04/11/2011  Davin           CAR 249257
.           Added A08 triggers for prfa change - tacc0000 (fpra9000/uppra900)
.           17/11/2011  Davin           CAR 255621
.           Changed definition of TEMPO
. V10.02.55 03/11/2011  Davin             CAR 254556
.           Added tags for mental health disch. details (tabl6700-tabl7500)
. V10.02.54 28/10/2011  Ebon Clements     CAR 251052
.           Added IP visit linked to WL tag TABL6600
. V10.02.53 27/10/2011  Steve Armstrong CAR 251323
.           Recompiled for PMSQVIFD changes
. V10.02.52 26/10/2011  Peter Vela        CAR 249257
.           Added business rules for WAHealth extra compensable details @
.           FPRA0000
.           24/10/2011  Jill Parkinson    CAR 251645
.           Recompiled for PATMISTM
. V10.02.51 20/10/2011  Davin             CAR 252611
.           Recompiled for PATVISTM
. V10.02.50 17/10/2011  Ebon Clements     CAR 251052
.           Added ED visit linked IP admission tag
.           13/10/2011  Peter Vela        CAR 249257
.           Added patre1af for WA Extra Compensable details update
.           @ FPRA0000
. V10.02.49 11/08/2011  Davin             CAR 238236
.           Changes to handle WIES18
. V10.02.48 12/10/2011  Ebon Clements    CAR 250752
.           Added wahealth ED discharge doctor and diagnois to visit list
. V10.02.47 11/10/2011  Mark Coupland    CAR 252429
.           Recompiled for PMSPX2TM and PATMASTM 
. V10.02.46 10/10/2011  Peter Vela     CAR 252439
.           Added tag for latest Legal Status from mehdlsaf
. V10.02.45 07/10/2011  Ebon Clements  CAR 251741
.           Added location display to visit list for ED
. V10.02.44 07/10/2011  Ebon Clements  CAR 251520
.           Added location display to visit list WL and booking
. V10.02.43 05/10/2011  Peter Vela     CAR 252428
.           Added GASF0000 - Read patasfaf special funding arrangement codes
. V10.02.42 04/10/2011  Saroeun Soeur  CAR 208854
.           Recompiled for PATMASTM
. V10.02.41 04/10/2011  Jill Parkinson CAR 248486
.           Added invcasek
. V10.02.40 30/09/2011  Saroeun Soeur  CAR 208854
.           Recomplued for PATMASTM
. V10.02.39 30/09/2011  Jill Parkinson CAR 249963   
.           Recompiled for IBAWEBCD - Restrict visit access
. V10.02.38 26/09/2011  Steve Armstrong  CAR 249584
.           Added read of pmsvx1af record prior to calls to DGCLICEC.
.           Recompiled for changes to DGCLICEC.
. V10.02.37 20/09/2011  Jill Parkinson CAR 248486
.           Added use of PTNCUHSC in FNDCUR00 - only select visit for my hosp
.           20/09/2011  Ebon Clements  CAR 249690
.           Allow access to IP supervisor page if a pre admission - GETPAT00
. V10.02.36 19/09/2011  Peter Vela     CAR 250433
.           Fixed Care Type Description display @ MVDTAB00
. V10.02.35 19/09/2011  Ebon Clements  CAR 250102   
.           Recompiled for PATMISTM - new tag for ward/bed short description
. V10.02.34 16/09/2011  Jill Parkinson CAR 250281   
.           Recompiled for PATVISTM - Inform GP output
.           15/09/2011  Mike Laming      CAR 248696
.           Mods to MRTTAB60 to set Red Hospital Id if not same as Home Hosp
. V10.02.32 14/09/2011 Mike Laming    CAR 240724
.           Mod to MRTTAB00 to send Hospital for requested MR into PATWEB85
. V10.02.31 13/09/2011 Jill Parkinson  CAR 248652
.           Recompiled for PMSPX2TM - Added read of pmsvx1af in GETCURIP
. V10.02.30 12/09/2011  Nicole Torrisi CAR 240560
.           Recompiled for PATMISTM - changed PTMSMGIN to use CODITM00
. V10.02.29 09/09/2011  Mike Laming    CAR 241939    
.           Mods to GEPS0000 to create Coding Date in phantom "patchcof" record
.           12/09/2011  Davin          CAR 258832    
.           Mods to display of contacts columns in demographics (lstexc00)
.           09/09/2011  Davin          CAR 250433    
.           Mods to display of care type changes in mvdtab00 & trntab00
. V10.02.28 07/09/2011  Mike Laming    CAR 241939    
.           Mods to DRGS0000 for Episode Enquiry - added routine CPDATS00
. V10.02.27 06/09/2011  Jill Parkinson CAR 247837    
.           Added GEXC0000 to output contacts in order of assoc number
. V10.02.26 05/09/2011  Davin            CAR 248328 
.           Output claim code desc at trntab50 (field 12 - dim20)
. V10.02.25 25/08/2011  Mike Laming      CAR 241939 
.           Mod to SELEPS00 to correct selection list of Episodes
. V10.02.24 22/08/2011  Ebon Clements    CAR 241939 
.           Mod to GEPS0000 to generate Phantom Episode on Discharge
. V10.02.23 19/08/2011  J.Tan             CAR 235765
.           Mods for SX insurer free text
. V10.02.22 18/08/2011  Jill Parkinson CAR 247832   
.           Recompiled for PATVISTM - ptwdsdes outputs
. V10.02.21 17/08/2011  Mike Laming      CAR 241939 
.           Mod to GEPS0000 to generate Phantom Episode on Discharge
. V10.02.20 16/08/2011  Ebon Clements    CAR 248168
.           Added home hospital and location filter to MRTTAB00
. V10.02.19 16/08/2011  Peter Vela       CAR 248482
.           Initialised KEY6 before call to FWBD0000 @ GETVIS00
. V10.02.18 15/08/2011  Ebon Clements    CAR 241939 
.           Mod to MRTCOD00 to correct Episodic Coding list
. V10.02.17 08/08/2011  Ebon Clements    CAR 241939 
.           Added episode coding functionality 
. V10.02.16 04/08/2011  Jill Parkinson   CAR 247832 
.           Added output of disaster description       
. V10.02.15 04/08/2011  Ebon Clements     CAR 243611
.           Added hospital to MRT visits list MRVTAB00
. V10.02.14 03/08/2011  Peter McMullen    CAR 240725
.           Remove codes from 'location' columns as well            
. V10.02.13 13/07/2011  Ebon Clements  CAR 242246    
.           Added hospital to OP appointment list - APPSCH00
. V10.02.12 12/07/2011  Jill Parkinson CAR 242269    
.           Mods to output PMVXPICD Description
.           Added option 9 - Patient Trust
. V10.02.11 09/07/2011  Peter McMullen    CAR 240725
.           Mods to respond to PTCNWBDS=2 (short description)
. V10.02.10 17/06/2011  Mike Laming       CAR 240724
.           Mods to MRTTAB00, added SUPERLEV & routine to handle Multi Hospital
. V10.02.09 16/06/2011  Ebon Clements     CAR 239530
.           Recompiled for PATMSXTM - demographics confirmed by
. V10.02.08 16/06/2011  Mike Laming       CAR 240724
.           Mods to MRTMASFD, MRTLOSFD & MRTHISFD added fields, changed KEYs
. V10.02.07 07/06/2011  Saroeun Soeur     CAR 243557
.           recompiled for PATWEB98
. ......... 14/06/2011 J.Tan             CAR 239592
.           Mods for print financial election form 
. V10.02.06 02/06/2011  Jill Parkinson    CAR 242416
.           Added Extra Contacts list (pmscexaf)
.           27/05/2011  J.Tan             CAR 239592
.           Mods for capturing extra compensable details
. V10.02.05 16/05/2011  Ebon Clements     CAR 240720
.           Added requested OP appointment functionality
. V10.02.04 06/05/2011  J.Tan             CAR 239592
.           Mods Movement details to display Financial Election/Claim code
.           10/05/2011  J.Tan          CAR 239588
.           Created CLPMSRES - clear patient Residency file
. V10.02.03 04/05/2011  Davin             CAR 239543
.           Recompiled for OBSPALPR - category based alert security
. V10.02.02 07/04/2011  J.Tan             CAR 233148
.           Mods to display new field web user id from transfer file
. V10.02.01 28/03/2011  Mike Laming   CAR 240107                      
.           Mods to PATECDaf & PATECOaf variables & Keys - file change
. V10.01.07 13/01/2011  Ebon Clements     CAR 236087
.           Recompiled for PATCLMTM - Defence force
. V10.01.06 12/01/2011 Jill Parkinson CAR 236436
.           Changed BOKLST00 to use bkreurno instead of pviurno for mrtmasaf
. V10.01.05 30/12/2010  Jill Parkinson CAR 234314   
.           Added showallv - gp access list showing all visits
. V10.01.04 15/12/2010  Jill Parkinson CAR 231658   
.           Recompiled for PATMASTM - CHKLEG00 match for ind 1=I removed  
. V10.01.03 29/11/2010  Davin             CAR 234045
.           Added new flag (usetnot1) and workers comp list (tabl5400) so
.           standard screens still work after nz change
. V10.01.02 26/11/2010  Ebon Clements     CAR 234036
.           Fixed incorrect goto in ACCSUM00 that was going to WCOLST40
. V10.01.01 19/11/2010  Steve Armstrong   CAR 234061
.           Recompiled for changes to PMSNUTFD.
.           Changed CALL's to PMSNUTIO.
.----------------------------------------------------------------------
. V10.00.15 26/10/2010  Jill Parkinson CAR 232197  
.           Changed PFND6700-7000 to check for 1 or 5 patunaaf records
. V10.00.14 06/10/2010  Peter Vela       CAR 230292
.           Removed ALLTAB00 gotos in ALLCOD00
. V10.00.13 21/09/2010  Mike Laming      CAR 223610
.           Added "Decline Date" to ACC Alteration & ACC Enquiry Lists
.           Created new Sort List for "ACC Summary" - ACCSUM00
. V10.00.12 14/09/2010  Jill Parkinson   CAR 230059
.           Added calls to CLPMSWX1
. V10.00.11 06/09/2010  Peter Vela       CAR 226974
.           Removed Eclipse OPV PVM functionality
. V10.00.10 31/08/2010  Jill Parkinson   CAR 500065
.           Added FNDCVS00 - find current admisssion or ed visit for healthviews
. V10.00.09 31/08/2010  Jill Parkinson   CAR 228008
.           Mods to check for wl and bokrc1af in WCOLST00 and UWCLST00
. V10.00.08 24/08/2010  Jill Parkinson   CAR 216702
.           Mods to output patunaaf fields
. V10.00.07 10/08/2010  Ebon Clements    CAR 208819
.           Added OP ref letters to ACC list - WCOLST00 and UWCLST00
.           03/08/2010 Peter Vela        CAR OPV Eclipse
.           Added Eclipse OPV PVM functionality
.           18/08/2010  Davin            CAR 223805
.           Recompiled for PATVISTM
. V10.00.06 07/07/2010 Peter Vela        CAR 223867
.           Added functionality to update acccmtaf @ UPDCLM55
. V10.00.05 18/06/2010 Mike Laming       CAR 221911
.           Re-compiled for PATMASTM - NZ LS Alerts
. V10.00.04 02/06/2010  Ebon Clements  CAR 208220
.           Added comment icon link to APPTAB00
. V10.00.03 08/04/2010  Peter Vela     CAR 219200
.           Added FPRA0000 to UPDCLM20
. V10.00.02 08/04/2010  Jill Parkinson  CAR 207094
.           Recompiled for obsmedaf
. V10.00.01 06/04/2010  Mike Laming     CAR 219246      HDP 2010
.           Add ICD10 Ed.7 - Go-live Date PTCNGDV7 (Sect.110 Pos.61)
. ......... 19/03/2010  Steve Armstrong   CAR 135505
.           Added HL7TRGID & HL7INCLD setting for all broadcast messages
.           24/03/2009  Davin             CAR 216505
.           Changes to handle WIES17
.-------------------------------------------------------------------------------
. V9.12.31  15/01/2010  Mike Laming    CAR 206410
.           Added PTMMOPID & PTMMTMNO to PATMMBFD - add clears here
. V9.12.30  18/12/2009  Ebon Clements  CAR 209263
.           Fixed VISTFLAG ED test in VISTAB00 so it only displays ED visits
. V9.12.29  17/12/2009  Saroeun Soeur  CAR 211862
.           WCOLNZ00 - added REP to replace quote with fake quote
. V9.12.28  07/11/2009  Saroeun Soeur  CAR 209737
.           Recompiled for PATMASTM - post ward / bed
. V9.12.27  26/11/2009  Jill Parkinson CAR 211042 
.           Fixed GETEWB00 and GETCTY00 to not loop if on an OP visit
. V9.12.26  16/11/2009  WeeLee Koo     CAR 209941
.           Removed 'Invalid Doctor' display under Visit list when there is no HCP code
.           against clinic master (GETVIS70)
. V9.12.25  22/10/2009  Jill Parkinson CAR 208479
.           Recompiled for NZHISWIO - setting of PTMXSIN1
. V9.12.24  09/10/2009  Saroeun Soeur  CAR 206745
.           Added tag TABL5200 - Residency Comments
. V9.12.23  28/08/2009  Ebon Clements  CAR 188160
.           Added call to CLPMSVX1 to start of GETPAT00
. V9.12.22  26/08/2009 Ebon Clements CAR 202965
.           Added visit based CDM details APPTAB00,MENTAB00,VISTAB00 &
.           VISITS00
. V9.12.21  20/08/2009  Davin          CAR 202101 SJOG-WA
.           Recompiled for PATMISTM - change to religious visit tag
. V9.12.20  18/08/2009  Ebon Clements CAR 193151
.           Removed Med Rec and day, added contract to AH visit search NZ
. V9.12.19  19/08/2009  Jill Habasque CAR 203656
.           Changed to go to MRTDES99 instead of MRTDES90 after Incomplete Merge
. V9.12.18  19/08/2009  Saroeun Soeur CAR 203785
.           changed FRMD0000 to run off parameter value ALCNCLNF
. V9.12.17  11/08/2009  J.Tan         CAR 203011
.           Mods for Financial Letters
. V9.12.16  04/07/2009  Saroeun Soeur  CAR 202491
.           FRMD0000 - "clinic (hcp)" format for OP visit list
.           added code to ALLOUT18,ALLOUT81, OUTLST18,OUTLST65
.           and GETVIS70
. V9.12.15  31/07/2009  Ebon Clements  CAR 202625
.           Added superlev
. V9.12.14  29/07/2009  Jill Habasque  CAR 145706
.           Addded ALSITE00 to output outpatient bookings
. V9.12.13  22/07/2009  Ebon Clements    CAR
.           Addded visit type and notes icons to APPSCH00
. V9.12.12  01/07/2009  Davin            CAR 199724
.           Changes to handle WIES16
. V9.12.11  14/07/2009  Saroeun Soeur  CAR 187926
.           added Patient Insurance and Insurer to template
. V9.12.10  30/06/2009  Jill Habasque  CAR 199693
.           Moved INFORMGP to be after SHOWFRMT in VISTAB00
. V9.12.09  26/06/2009  Ebon Clements  CAR 199043
.           Changed status description of On W/List referral to "Waiting"
. V9.12.08  24/06/2009  Saroeun Soeur    CAR 191227
.           Removed LineThroughRed to LineThrough
. V9.12.07  23/06/2009  Saroeun Soeur    CAR 191227
.           PATLST30 - added check for emrvistat, if cancel
.           line through on table display
. V9.12.06  19/06/2009  Mike Laming      CAR 197814 HDP 2009 DRG 6.0
.           Added DRG060 & WIES for DRG 6.0
. V9.12.05  27/05/2009  Jill Habasque  CAR 196955
.           Added check for blank expiry date in CONT0000
. V9.12.04  26/05/2009  Peter Vela     CAR 195396
.           Added replace single quotes in WCOLKP00
. V9.12.03  17/05/2009  Jill Habasque  CAR 195396
.           Added or LESS in 035 TEMPLATE match
. V9.12.02  15/05/2009  Jill Habasque  CAR 164873
.           Mods to use PTCNRQCF
. V9.12.01  06/05/2009 Jill Habasque  CAR 145706
.           Added informgp flag for outputting gp visits
. V9.11.15  23/04/2009 Jill Habasque  CAR 145706
.           Added nourselc for gp access               
.           23/04/2009 Jill Habasque  CAR 193525
.           Mods to set secopt for event bookings      
. V9.11.14  15/04/2009 Jill Habasque  CAR 193791
.           Added match to 35 for template in GETPAT00
. V9.11.13  19/03/2009  Davin S       CAR 178015
.           Changed to use invoice number for BPAY CRN (PFND2300)
. V9.11.12  06/03/2009  Peter McMullen CAR 191373
.           Avoid call to SETMED00 if CHKHCU gets a miss
. V9.11.11  18/02/2009  Mike Laming    CAR 189099
.           Add OutPatient Appointment Schedule (& report) - APPSCH00
. ........  18/02/2009  Mike Laming    CAR 167860
.           Mod for changes to ARCVX1FD/IO (add 12 fields, extend length to 916)
. V9.11.10  03/02/2009  Mike Laming    CAR 181194
.           Mod to issue "ACC No. in use" error message at UPDCLM51
. V9.11.09  30/01/2009  Jill Habasque  CAR 171162
.           Mods to output pathspaf details
. V9.11.08  27/01/2009  Jill Habasque  CAR 180939
.           Mods to output case team and linked status for AH
. V9.11.07  23/01/2009  Ebon Clements  CAR 188081
.           Hard coded the ED visit (Event) status to discharged on the visit
.           list when running kids
. V9.11.06  23/01/2009  Jill Habasque  CAR 187966
.           Mods to match "1" to template as well as "001" in getpat00
. V9.11.05  21/01/2009  Jill Habasque  CAR 187966
.           Mods to call setmed00 if NZIBMWST is not spaces (nhi warnings exist)
. V9.11.04  21/01/2009  Ebon Clements  CAR 187200
.           Changed CHKMEH00 to ready security with USERID
. V9.11.03  15/01/2009  Ebon Clements  CAR 175204
.           Recompiled for IBAWEBCD - Standard tag for default label
. V9.11.02  13/01/2009  Jill Habasque  CAR 164873
.           Mods to output mrhireqb in MRTTAB00
. V9.11.01  07/01/2009  Jill Habasque  CAR 164866
.           Mods to output primary diagnosis and procedure
. V9.10.21  12/09/2008  Jill Habasque  CAR 178214
.           Changed completed to receipted and added failed for ACLOSTAT
. V9.10.20  10/09/2008  Peter Vela     CAR 177468
.           Recompiled for PMSNUTTM
. V9.10.19  08/09/2008  Ebon Clements  CAR 164626
.           Fixed display of old AAE visit ED discharge details - GETVIS05
. V9.10.18  01/09/2008  Ebon Clements  CAR 164626
.           Don't show ED discharge details unless patient discharged - GETVIS05
. V9.10.17  25/08/2008  Peter Vela     CAR 176766
.           Modified UWCLST00 - Step through patwc1af in reverse order. From
.           newest to oldest.
.           - Increase display maximum to 30 workers comp records
. V9.10.16  01/08/2008  Mike Laming    CAR 153670
.           Recompiled for ACCEXTRA - changes to Ethnicity & Injury
. V9.10.15  30/07/2008  Mike Laming    CAR 153670
.           Recompiled for ACCEXTRA & ACCNZXML - changes after submission to ACC
.           - added PMSTLEFD/IO (Patients Title table)
. V9.10.14  22/07/2008  Ebon Clements    CAR 174577 
.           Added cgi pmsaltid to auto select the ur from the alt id
. V9.10.13  17/07/2008  Davin            CAR 163993
.           Changes to handle WIES15
. V9.10.12  10/07/2008  Ebon Clements  CAR 171268
.           Ignore cancelled ED visits  - FNDCUR00
. V9.10.11  09/07/2008  Jill Habasque  CAR 172636
.           Mods to display onset types for all states except 0 or 1
. V9.10.10  03/07/2008  Jill Habasque  CAR 172067
.           Added ptcnhdps=9 to display onset types
. V9.10.09  02/07/2008  Mike Laming    CAR 153670
.           Recompiled for ACCEXTRA & ACCNZXML
. V9.10.08  01/07/2008  Mike Laming    CAR 153670
.           Recompiled for ACCEXTRA & ACCNZXML
. V9.10.07  24/06/2008  Davin          CAR 167759
.           Added wies file tags 4 & 5 to WIESVL00
. V9.10.06  19/06/2008  Mike Laming    CAR 168794
.           Recompiled for PATRE1TD/TM - added PTREMOBL (PTRA010) in P.R.A
. V9.10.05  12/06/2008  Mike Laming    CAR 168794
.           Recompiled for PATMASTM & PATMSXTM - added Domicile Description
. V9.10.04  28/05/2008  Ebon Clements CAR 167720
.           Fixed selection of current visit when doing a patient search by ur
. V9.10.03  07/05/2008  Mike Laming   CAR 153670
.           Added ACC Status List ACCTAB00 & ACCLST00              
.           Added Report No. 08 (Hosp.Level list) HOSLST00         
. V9.10.02  05/05/2008  Ebon Clements CAR 167666
.           Added move zero to EVNTFLAG at the start of CKAL0000
. V9.10.01  01/05/2008  Mike Laming   CAR 153670
.           Changed to use new PATCLMTD Include for ptclm0.. cgi vars
. V9.09.19  22/04/2008  Jill Habasque CAR 166203
.           Add output of PTEDOSET for QLD,SA and WA             
. V9.09.18  20/03/2008  Mike Laming   CAR 163918        HDP 2008     
.           Add ICD10 Ed.6 variable PTCNGDV5                     
. V9.09.17  06/03/2008  Jill Habasque CAR 156802
.           Fixed linkpatient for cancelled admissions
. V9.09.16  04/03/2008  Jill Habasque CAR 103007
.           Added CHKPRE00
. V9.09.15  03/01/2008  Jill Habasque CAR 142467 
.           Fixed output of acccmtaf in WCOLKP00
. V9.09.14  06/12/2007  Ebon Clements CAR 153744 
.           Added PVISITE to ALLTAB00 linkPatient()
. V9.09.13  28/11/2007  Jill Habasque CAR 155486
.           Changed to use wmbook instead of dbkreboo in WATLST00
. V9.09.12  21/11/2007  Peter Vela    CAR 132254
.           Fixed Delete Bed Transfers Care Type change table display
.           MVDTAB00
. V9.09.11  12/11/2007  Peter Vela    CAR 151199
.           Added new Emergency Cancellation status
. V9.09.10  18/10/2007  Davin         CAR 151903
.           Recompiled for new standard tags in IBAWEBCD
. V9.09.09  11/10/2007  Ebon Clements CAR 151944
.           Added first 5 concession cards tag - CONT0000
. V9.09.08  24/09/2007  Peter Vela    CAR 148954
.           Added tags for Patient Multiple Regime codes
. V9.09.07  14/09/2007  Ebon Clements CAR 150226
.           Added PTCNUFFR - Using frame friendly
. V9.09.06  13/08/2007  Steve Armstrong    CAR 145650
.           Added call to DGCLICEC when visit is updated with a change in
.           ACC (patwc1af) claim number.
. V9.09.05  02/08/2007  Steve Armstrong  CAR 145161
.           Removed references to WIES 7, 8, 9 & 10 - no longer supported
. V9.09.04  25/07/2007  Jill Habasque CAR 145592                 
.           Added check for PTCNDRSM                          
. V9.09.03  18/07/2007  Mike Laming   CAR 145161                 
.           Added WIES14 (PATW14FD/IO)                        
. V9.09.02  18/07/2007  Jill Habasque CAR 145458                 
.           Recompiled for IBAWEBCD - added websecaf reads    
. V9.09.01  28/06/2007  Ebon Clements CAR 143550                 
.           Recompiled for PATMSXTM - relation file open
.           01/06/2007  Janet George CAR 142467                  
.           Mods to routine WCOLNZ00 to output extra ACC Fields    
.           06/06/2007  J.Tan     CAR 142173
.           Mods to include emergency events
.           15/06/2007  J.Tan     CAR 142173
.           Mods to display Emergency events on visit lists
.           22/06/2007  Ebon Clements CAR 143153       
.           Changed ICD coding user to check the passcode if user id is blank
.----------------------------------------------------------------------
. V9.08.23  06/06/2007  Ebon Clements CAR 121272       
.           Added hospital access test to visit lists
. V9.08.22  30/05/2007  Mike Laming   CAR 140841
.           Fix routine FPRA0000 to use ADMISSNO instead of WCADMNO
. V9.08.21  08/05/2007  Mike Laming  CAR 137125 HDP 2007 DRG 5.2
.           Mods to PATDGWFD - Add field PTDWDRGV (add to Keys)
. V9.08.20  23/04/2007  Peter Vela    CAR 139117
.           Changed validation for TAC Claims @ UPDCLM20 UPDCLM40 UTCLST30
. V9.08.19  20/04/2007  Ebon Clements CAR 132858
.           Recompiled for PMSWORFD file change
. V9.08.18  12/04/2007  Mike Laming      CAR 137125 HDP 2007 DRG 5.2
.           Added PTCNU52G and PTCNC52C for DRG Ver 5.2 
.           16/04/2007  Ebon Clements  CAR 135533
.           Fixed rejected referral status display on the visit list
.           12/04/2007  Peter Vela    CAR 126219
.           Recompiled for PMSPX2TM
. V9.08.17  14/03/2007  Jill Habasque  CAR 127059
.           Added match TRANDATE to SP70 in OPRTAB00
. V9.08.16  07/03/2007  Jill Habasque  CAR 135309
.           Added reads of arcvx1af
. V9.08.15  26/02/2007  Peter Vela     CAR 118225
.           Recompiled for PMSPX2TM PMSPX2TD
. V9.08.14  22/02/2007  Neelkamal Pyla CAR 116167
.           Added code to WIESVL00 to display State DRG Description
. V9.08.13  20/02/2007  Jill Habasque  CAR 120004
.           Added output of primary nzpspraf details
. V9.08.12  31/01/2007  Peter Vela     CAR 127930
.           Recompiled for MRTMASFD
. V9.08.11  18/01/2007  Mike Laming      CAR 131266
.           Add test for numeric prefix on NZ UR at GETPAT90
. V9.08.10  16/01/2007  Neelkamal Pyla   CAR 122068
.           Set Weekday value of OBADATE to DAYNAM3 in APPTAB00
. V9.08.09  28/11/2006  Ebon Clements    CAR 120011
.           Recompiled for PATMISTM - follow-up for implant invoicing
. V9.08.08  20/11/2006  Peter Vela       CAR 124550
.           Added ACODDTE to MRVTAB00. Added code to display coding status and 
.           docing display  MRTTAB11
. V9.08.07  10/11/2006  Peter Vela       CAR 107080
.           Modified display of User Id from PTEDUSER to PTEDUSID at PATLST00
. V9.08.06  26/10/2006  Davin            CAR 121894
.           Added visit expected payors tag (pfnd3600)
. V9.08.05  20/10/2006  Mike Laming      CAR 119915
.           Added V6.14 code to FPRA0000 for Workers Comp. to display Ins.Coy.
. V9.08.04  19/10/2006  J.Tan         CAR 120502
.           Added ManualChange Movement for Cancel Movement list
. V9.08.03  10/10/2006  Peter Vela    CAR 120583
.           Added tags for Coding Enquiry Screen
.           Added Yes/No tags for PTMIUYN1, PTMIUYN2
. V9.08.02  03/10/2006  Ebon Clements CAR 107243
.           Added test for merged on NHI but not local to TABMWR00
. V9.08.01  28/09/2006  Ebon Clements CAR 1072433
.           Recompiled for NZHISWIO - Deleted alerts
.----------------------------------------------------------------------
. V9.07.08  21/09/2006  Ebon Clements CAR 1107243
.           Recompiled for OBSPALPR - deleted alert functionality
. V9.07.07  20/09/2006  Ebon Clements CAR 119436
.           Changed FNDCUR00 to use the admission file index 8
. V9.07.06  11/09/2006  Peter Vela    CAR 118226
.           Recompiled for PATCLMTM
. V9.07.05  10/08/2006  Ebon Clements CAR 116137 103365
.           Changed allied health visit description from AH to RF - VISTALLH
.           Added read of residency details file
. V9.07.04  10/08/2006  Ebon Clements CAR 114565
.           Recompiled for PATMASTM - Last discharge date tag
. V9.07.03  14/07/2006  Peter Vela   CAR 103245
.           Fixed SECOPT value for Allied health redirect CKAL0000
. V9.07.02  11/07/2006  Davin S      CAR 111764
.           Added 2006/2007 WIES13 file (patw13af)
. V9.07.01  11/07/2006  Manjunath N   CAR 110218
.           Added filter on Category for Patient Alerts
.----------------------------------------------------------------------
. V9.06.04  15/06/2006  Ramesh VK   CAR 101964
.           Recompiled for PATMASTM
. V9.06.03  09/06/2006  Manjunath.N   CAR 104812
.           Recompiled for PATMASTM
. V9.06.02  16/05/2006  Mike Laming   CAR 105244           2006 HDP
.           Add ICD10 Ed.5 variable PTCNGDV5 and DRG Ver 5.1
. V9.06.01  08/05/2006  Peter Vela    CAR 104252
.           Renamed DPTCEURN to PTCEURNO
.----------------------------------------------------------------------
. V9.05.04  31/03/2006  Ebon Clements CAR 78527
.           Added visits by type my hospital visit list tag - TABL4400
. V9.05.03  21/03/2006  Jill Habasque CAR 78524
.           Recompiled for PMSPX2TM
. V9.05.02  20/03/2006  Ebon Clements CAR 78527
.           Added hospital filter to visits by type - VISITS00
. V9.05.01  09/03/2006  Ebon Clements CAR 78533
.           Mods for PATCODTM - Hospital specific category codes
. ........  10/03/2006  Mike Laming   CAR 79281
.           Change KEY16 to KEY19 for "patfactf"
. V9.05.B06 20/02/2006  Ebon Clements     CAR 76341  
.           Added referral and encounter file audit    
. V9.05.B05 30/01/2006  Ebon Clements CAR 93186
.           Mods for REDIRECT length change. Recompiled for IBAWEBDF
. V9.05.B04 20/12/2005  Ebon Clements      CAR 76341        
.           Key length changes for encounter number
. V9.05.B03 19/12/2005  J.Tan              CAR 85191
.           Added Iwi fields
. V9.05.B02 15/12/2005  Mike Laming        CAR 86040
.           Add Tag for "Certificates exist" in CHKCER00 (via PFND0000)
.----------------------------------------------------------------------
. V9.04.34  30/11/2005  Mike Laming        CAR 86040
.           Recompiled for PMSVX1FD/IO, PATVISTM for Program Codes
. V9.04.33  21/11/2005  Peter Vela    CAR 68675
.           Recompiled for PATDSCTM
. V9.04.32  21/11/2005 Jill Habasque   CAR 84770
.           Recompiled for NZHISWIO - Update of ptmxsin1
. V9.04.31  11/11/2005 Jill Habasque   CAR 55028
.           Added NMDS list
. V9.04.30  06/10/2005 Ebon Clements   CAR 56976
.           Fixed linked visit display for theatre bookings it was using PVIBILL
.           but should have been using BKREBOOK. Fixed value of ALENLINK for 
.           allied health referral linked medical record volume
. V9.04.29  22/09/2005 Ebon Clements   CAR 56976
.           Added udpate linked medical record fuctionality to VISITS00
. V9.04.28  26/08/2005 Peter Vela      CAR 72751
.           Added tags for PMWOWDI1,PMWOWDI2,PMWOWDI3,PMWOEDAT
. V9.04.27  23/08/2005 Ebon Clements   CAR 72581
.           Changed ALLROW00 and OUTLST00 to print what details it can for
.           outpatient bookings with corrupt data. ie missing sessions/clinics
. V9.04.26  19/08/2005   Jill Habasque CAR 72893
.           Added read of nhimasaf in GETPAT00
. V9.04.25  04/08/2005   J.Tan        CAR 62750 
.           Mods not to use the redefined amount variables
. V9.04.24  03/08/2005 Peter Vela    CAR 68675
.           Recompiled for PATDSCTM
. V9.04.23  22/07/2005 Peter Vela    CAR 66960
.           Added 2005/2006 WIES12 file (patw12bf)
. V9.04.22  20/07/2005 Jill Habasque CAR 68111
.           Added output of bed type from pattranf for movement lists
. V9.04.21  13/07/2005 Davin         CAR 66431
.           Added open of pmshcgaf
. V9.04.20  07/07/2005  Jill Habasque      CAR 66218
.           Recompiled for PATMSXTM
. V9.04.19  04/07/2005  Jill Habasque      CAR 61468
.           Fixed TAC list to display outpatient bookings
. V9.04.18  27/06/2005  Jill Habasque      CAR 64419
.           Added leave type to movement list
. V9.04.17  02/06/2005  Peter Vela         CAR 47802
.           Add volume number column to STV patweb9801250.html Visits by Type
.           ALLTAB00,ALLVIS00,ALLROW00,ALLBOK00,ALLWAT00,ALLCAD00
. V9.04.16  15/03/2005  Guomin Fu          CAR 55923
.           Added testing of hospital state before TAC number format checking
.           because for NSW, there is no specific format required.
. V9.04.15  01/03/2005  Peter Vela    CAR 57547
.           Recompiled for PATVADFD and PATVADIO
. V9.04.14  04/02/2005  Ebon Clements CAR 56056
.           Recompiled for OBSPALPR - alert icon display
.           24/01/2005  Peter Vela   CAR 55331
.           Recompiled for DXPATMAS
. V9.04.13  13/01/2004 Jill Habasque CAR 55508
.           Fixed output in WCOLNZ00
.           05/01/2005 Lina Vo       CAR 55638
.           Move spaces to ptmmdesc in PATMMB00. 
.           22/12/2004 Ebon Clements CAR 56056
.           Recompiled for OBSPALPR - alert icon display 
. V9.04.12  25/11/2004 Lina Vo       CAR 34301
.           Added output of audit date to Patient Visit List
. V9.04.11  17/11/2004 Jill Habasque CAR 54921
.           Added output of decline date
. V9.04.10  09/11/2004 Peter Vela    CAR 53371
.           Recompiled for PATVISTM
.           16/11/2004 Jill Habasque CAR 54921
.           Added output of extra accident fields in WCOLNZ00
. V9.04.09  25/10/2004 Lina Vo       CAR 54514
.           Clear AWARD field to not display ward for outpatients in GETVIS00
. V9.04.08  08/10/2004 Ebon Clements CAR 54066
.           Added a read of the visit extn file in ALLVIS00
.           08/10/2004 Jill Habasque CAR 53819
.           Added output of hospital for theatre bookings and events
. V9.04.07  07/10/2004 Ebon Clements CAR 54111
.           Fixed hospital display for allied health referrals and cancelled
.           admissions if multi hospital
. V9.04.06  29/09/2004 Peter Vela    CAR 49647
.           Added User ID column in Previous Address Template
.           (patweb9801038.html)
. V9.04.05  30/09/2004 Guomin Fu     CAR 40432
.           Mods in GETVIS00 to check SHORFRMT. If for kids(SHORFRMT=1),leave
.           HCP field blank for all visit lists
. V9.04.04  30/08/2004 Peter Vela    CAR 51223
.           Added UNKNFLAG (unknown flag) when updating TAC claim no
.           16/09/2004 Jill Habasque CAR 50611
.           Changed output of NZ ACC search                           
.           27/09/2004 Jill Habasque CAR 53783
.           Recompiled for PATMISTM
. V9.04.03  08/09/2004 Davin         CAR 53139
.           Added output of concession card details to option 1 (getccd00)
. V9.04.02  27/08/2004 Jill Habasque CAR 53046
.           Added output of hospital code if multi hospital site
. V9.04.01  24/08/2004 Jill Habasque CAR 52947
.           Added output of pmwxaloc
.----------------------------------------------------------------------
. V9.03.38  04/08/2004 Henry Son                 CAR 51504
.           RAdd WIES12 (2004/2005 changes)
.           04/08/2004 Jill Habasque CAR 50611
.           Added output of Outpatient bookings for WCOLST00
. V9.03.37  12/07/2004 Jill Habasque             CAR 51060
.           Recompiled for PATMASTM - PPNDTE display
. ........  17/07/2004 Henry Son                 CAR 51634
.           Default to call WIES11.
. ........  26/07/2004 Lina Vo                   CAR 51384
.           Added Report 7 - Maintain Medical Record MBS
. ........  30/07/2004 Peter Vela                CAR 51304
.           Added Reason to Rescheduled pop up box in Table of Appointments
.           APPTAB00
. V9.03.36  29/06/2004 Guomin Fu  CAR 47395
.           Fixed a bug that system allows for 2 spaces to be entered followed
.           by 5 digits in TAC number.
. V9.03.35  24/06/2004 Jill Habasque CAR 44641 
.           Added output of PTCNUALT - Using alternate ID's
. V9.03.34  09/06/2004 Davin          CAR 49341
.           Changed 'delete bed transfers' table to use pttrcdat/pttrctim
.           & pttrcuid rather than trcdate/trctime/pttroper from pattranf
. V9.03.33  07/06/2004 Peter Vela     CAR 49016
.           2004 Statutory Changes - recompiled for PMSPX2TM
. V9.03.32  03/06/2004 Jill Habasque  CAR 50088
.           Added output of CGENRUR
. V9.03.31  27/04/2004  Ebon Clements CAR 48865
.           Added AAE enquiry page for Hawks Bay 
.           20/04/2004  Guomin Fu     CAR 49028
.           Fixed warning message "TAC No is already valid" appears each time 
.           the checkbox is clicked
. V9.03.30  16/04/2004  Ebon Clements CAR 48713
.           Added update civil tort claim details
. V9.03.29  06/04/2004  Peter Vela    CAR 48227
.           Added tag for BPAYREFN - BPAY Reference Number
.           Added tag for PTCNBPAY - BPAY Parameter
. V9.03.28  17/03/2004 Peter Vela      CAR 13038
.           Changed call DOCNAM00 to DOCNM000 (parameter driven doctor name
.           format) for sort lists.
. V9.03.27  09/03/2004  Jill Habasque CAR 41924
.           Added default to all for visits by type
. V9.03.26  23/02/2004  Jill Habasque CAR 47745
.           Recompiled for NZHISWIO - nhi difference warning
. V9.03.25  30/01/2004 Davin        CAR 22654
.           Added write to patpeiaf when updating tac details
. V9.03.24  14/01/2004 Peter Vela   CAR 18122
.           Added Primary Disease Code to Patient Visit Table
.           Added Primary Disease Code Description tp Patient Visit Table
. V9.03.23  10/12/2003 Sylvek Litewka CAR 20222
.           Modified procedures GETICD00, GETICO00 and MRVTAB90 to read ICD
.           files using IO routines RDPTICD1 and RDPTICO1. Removed read of 
.           ICD Disease file from MRTCOD00 - get description from PTEDDESC.
.           Modified procedure ICDTYP00 to use Discharge Date to determine the
.           coding type (ICD9 or ICD10).
. V9.03.22  12/11/2003 Ebon Clements  CAR 43674
.           Fixed outpatient visit list display for multiple sites
. V9.03.21  03/11/2003 Sylvek Litewka CAR 44328
.           Mods to use new Free Format Description fields PTMMDESC, PTEDDESC
.           and PTEODESC when displaying code descriptions for patient MBS 
.           Items, Diagnosis and Procedures.
. V9.03.20  29/10/2003 Sandra Barcham    43783
.           Recompiled for NZHISWIO and NZHISWUP
. V9.03.19  17/10/2003 Jill Habasque CAR 44455
.           Added setting of NZIBNMPI before calling SETMED00
. V9.03.18  10/10/2003 Ebon Clements CAR 42206
.           Fixed cancelled outpatient visit list medical record volume
. V9.03.17  29/09/2003 Ebon Clements CAR 22361
.           Added reads of outhedaf to display the correct session setup details
. V9.03.16  26/09/2003 Jill Habasque CAR 42890
.           Added call to SETMED00
. V9.03.15  23/09/2003 CAR 43526   Henry Son
.           Fix Grouper 4.1 to use WIES8.
. V9.03.14  17/09/2003 Henry Son       CAR 43498
.           Add WIES10 and WIES11
. V9.03.13  09/09/2003 Ebon Clements   CAR 40619
.           Added replace space with a plus in NEXTGR00 and PREVGR00 for the 
.           visit list.
. V9.03.12  13/08/2003 Sylvek Litewka  CAR 41293
.           Modified procedure FREEFM00 to populate SCHEDDSC variable.
. V9.03.12  13/08/2003 Sylvek Litewka  CAR 41293
.           Modified procedure FREEFM00 to populate SCHEDDSC variable.
.           22/07/2003 Jill Habasque CAR 21760
.           Changed reads of bokdiaaf for new key
. V9.03.11  18/07/2003 Ebon Clements CAR 40619
.           Fixed end of visits message in ALLVIS00 for RCH visit list by type
. V9.03.10  02/07/2003 Jill Habasque CAR 40660
.           Recompiled for PATDSCTM
. V9.03.09  16/06/2003 Pat Dirito                CAR 39213
.           Added Coder ID output CODUSR00                    
.           16/06/2003 J.Tan   CAR 39832
.           Added billing compensable screen
. V9.03.08  02/06/2003 J.Tan   CAR 39613/39614
.           Fixed dislaying error for invalid TAC claim number
.           Fixed checking TAC claim number for more than 7 digits
. V9.03.07  27/05/2003 J.Tan
.           Mods validating TAC claim no and Accident date
. V9.03.06  22/05/2003 J.Tan  CAR 39218
.           Added warning for validating TAC claim number
. V9.03.05  20/05/2003 Tonii  CAR 23367
.           Added function to print Free Format labels.
.           New template patweb9806001.html added to handle print.
. V9.03.04  14/05/2003 Ebon Clements SRF 19889
.           Changed outpatient display order for RCH visit list by type
. V9.03.03  13/05/2003 Ebon Clements CAR 39040
.           Fixed infinite loop in MRTTAB00 when a medical record has an
.           invalid home location
. V9.03.02  09/05/2003 Tracey Nguyen CAR 37661
.           Added a new option to visits by type for cancelled admissions.
. V9.03.01  08/05/2003 J.Tan CAR 38769
.           Fixed updating claim accepted by insurance field
.----------------------------------------------------------------------
. V9.02.99  07/05/2003 J.Tan CAR 38781
.           Mods to validate TAC no and accident date
.           Recompiled for PATCLMTM - default for TAC accident date         
. V9.02.98  06/05/2003 J.Tan CAR 38680
.           Mods update TAC/WC Claim to copy all details
. V9.02.97  22/04/2003 J.Tan CAR 20009
.           Recompiled for PATCLMTM - added Civil Tort 
. V9.02.96  14/04/2003 Ebon Clements CAR 37950
.           Created new pre admission list for the emergency map view
. V9.02.95  10/04/2003 Ebon Clements CAR 37904
.           Recompiled for IBAWEBCD - Outpatient site standard tag
. V9.02.94  03/04/2003 J.Tan 
.           Mods to TAC Claim number
. V9.02.93  01/04/2003 J.Tan SRF 37801
.           Fixed validating TAC claim number 5 digits instead of 6
.           Recompiled for PATMISTM - Admitting point
. V9.02.92  20/03/2003 Ebon Clements             SRF 37325         
.           Changed the visit search to be the same format as the visit list
.           20/03/2003 Jill Habasque SRF 36883
.           Added read of PTCNNHTM
. V9.02.91  19/03/2003 Ebon Clements SRF 37270
.           Added udpate TAC & Workers Comp Insurance claim number
.           18/03/2003 J.Tan
.           Added Modify TAC & Workers Comp Insurance claim number
. V9.02.90  13/03/2003 Ebon Clements             SRF 37196 36856
.           Added no more visits message to visit list by type.
.           Added RCH visit list display format to visit list by type.
.           12/03/2003 Pat Dirito                SRF 35988
.           Modified MRTTAB00 to output Home Location  
.           05/03/2003 Jill Habasque             SRF 36883
.           Added connect and disconnect for chkhcu
.           Recompiled for PATMISTM - admitting point
. V9.02.89  26/02/2003 J.Tan                     SRF 20178
.           Mods to update claim details for same claim number
.           25/02/2003  Ebon Clements SRF 
.           Fixed display in ALLWAT00 for waiting list visits
.           24/02/2003  Tonii                    CAR 36032
.           Changes to template patweb9802004.html, mods to default UR number 
.           to uppercase in UR merge.
.           20/02/2003  Lina Vo                  SRF 35799
.           Mods to ALLTAB00 to display different view according to SRCHVIEW
.           Mods to VISITS00 to default All filter if SRCHVIEW=1            
.           19/02/2003  Jill Habasque SRF 36112
.           Fixed output of ShowDetail01
. V9.02.88  07/02/2003  Tonii CAR 35992
.           Recompiled for PATMISTM
.           05/02/2003 Ebon Clements SRF 19889
.           Added tag VISITS00 for the visit list by visit type screen
. V9.02.87  24/01/2003 Jill Habasque SRF 35650
.           Added "COM" for eclipse visits
.           28/01/2003 Ebon Clements SRF 21870
.           Mods to key for the deletion of care type changes in MVDTAB50
. V9.02.86  15/01/2003 Lina Vo                   SRF 2R2698
.           Do not call CHKHCU00 when ur is a temporary number           
. V9.02.85  08/01/2003 Peter Vela                SRF 23145
.           Added tag for event visit type - PMEVEVNT
. V9.02.84  13/12/2002 Pat Dirito                SRF 34063
.           Added further check when displaying Medical record 
.           Validates against U/R after reading mrtvisaf
. V9.02.83  07/12/2002 Peter Vela     SRF 18390/20178
.           Added TACTAB00, TACLST00 - TAC Details Table
.           Added TACLKP00           - TAC Details/MAB reference no lookup table
.           06/12/2002 Lina Vo        SRF 22709
.           Opened outdiagf with site prefix
. V9.02.82  28/11/2002 Jill Habasque  SRF 24136
.           Added read of patdadaf
. V9.02.81  28/11/2002 Jill Habasque  SRF 33946
.           Mods to not display medical warnings if not using NHI
.           Added branch on exit after CHKHCU
. V9.02.80  27/11/2002 Pat Dirito                SRF 22611
.           Now outputing blanks instead of 0 when no Medical Record Volume 
.           is found in VISTAB00 (Visit Lists)
.           26/11/2002 Ebon Clements 		 SRF 33407
.           Removed hard coded visit time of 12:00 in PATLST30 if no visit time
. V9.02.79  22/11/2002 Jill Habasque SRF 33465
.           Added medical warning table, added nhi merge warning
. V9.02.78  25.10.2002 Pat Dirito                SRF 23689
.           Fixed bad programming HPS - PFND0000              
.           24.10.2002 Peter Vela                SRF 22727
.           Added functionality for Mental Health Visit List 
.           (patweb9801054.html)
.           23.10.2002 Sylvek Litewka            SRF 22711
.           Added flag 'BOOKFLAG' - Book Outpatient Referral Letter Flag.
.           When set (value = 1), this flag will cause the 'MakeNewAppointment'
.           screen (outweb0205002.html) to display automatically when loading
.           'Patient Demographics' screen (patweb9801001.html).
. V9.02.77  21.10.2002 Peter Vela                SRF 22685
.           Added functionality for Diet Comment field (patweb9804003.html)
. V9.02.76  12/10/2002  Pat Dirito               SRF 22696
.           Changes for NZPAS - DISTAB00 ICD Coding Enquiry
. V9.02.75  09.10.2002 Peter Vela SRF 17693
.           Recompiled for PATMISTM - Admitting Point
. V9.02.74  03.10.2002 Peter Vela                SRF/MOD 17693
.           Recompiled for PATVISTM - Admitting Point
. V9.02.73  30.09.2002 Peter Vela                SRF/MOD 22514
.           Recompiled for OBSPALPR (View Alert Security Level)
. V9.02.72  24.09.2002 Peter Vela                SRF/MOD 22221
.           Added columns "User ID" and "Last Date and Time" to Cancel 
.           Movements page.
. V9.02.71  10.09.2002 Pat Dirito                SRF 22078
.           Fixed APPTAB00 read on clinic table to get clinic descriptions   
. V9.02.70  21/08/2002  Jill Habasque SRF 20843
.           Changed length of VSTATUS from 32 to 35
. V9.02.69  24/07/2002  Ebon Clements SRF 18642
.           Changed the visit list to display the clinic type in the unit
.           field UNITCODE for outpatients and outpatient events.
. V9.02.68  23/07/2002  J.Tan
.           Recompiled for PATMISTM - added patasfaf file
. V9.02.67  28/06/2002 Jill Habasque SRF 18339               
.           Added cancelled bookings for waiting list records
. V9.02.66  26/06/2002 Pat Dirito                SRF 18511
.           Now checking for Bad Debts in MRTCOD00.
.           13/06/2002  Harvinder                SRF 12797
.           Modified to include two new filters on the basis of
.           Occupational Group and Type of Note ( TABL2000,2100 and TABL2200)
. V9.02.65  31/05/2002  Ebon Clements 18229
.           Added trap if sigpipe
. V9.02.64  24/05/2002  J.Tan
.           Mods for casemix code
. V9.02.63  17.05.2002 Ebon Clements 
.           Added a read of outctyaf in OCLI0000 for unit/clinic type desc.
.           Recompiled for changes to PATMISTM - casemix
. V9.02.62  02.05.2002 Jill Habasque
.           Fixed setpar for viewtype    
. V9.02.61  21.04.2002 B.G.Ackland
.           Recompile for OBSPALPR Change
. V9.02.60  21.04.2002 Bronko  
.           Added a check for EMR on zero UR numbers for Alerts                
. V9.02.59  27.03.2002 Ebon Clements 3494 
.           Call GETSTA00 in PATLST00 to set up outpatient event discharge date
.           27.03.2002 Pat Dirito    
.           Modified MRTTAB00 to output Current location from MRTMASFD
. V9.02.58  26.03.2002 Jill Habasque 2915 & 3447
.           Added option on only display last 15 visits.  Added output of claim
.           code for Allied Health patients               
. V9.02.57  15.03.2002 Ebon Clements 3365
.           Changed OCLI0000 for the visit list to populate UNITDESC with the
.           clinic type description if the unit is blank
. V9.02.56  12.03.2002 Ebon Clements       
.           Fixed APPTAB00 read on clinic table to get clinic descriptions   
. V9.02.55  06.03.2002 Jill Habasque 2960
.           Added output of diagnosis and code for outpatients in visit list
.           06.03.2002 Ebon Clements 2986
.           Changed BOKLST00 to use BKDIDES1 for the procedure description
. V9.02.54  05.03.2002 Jill Habasque 3347
.           Added output of discharge status for emergeny patients in visit list
. V9.02.53  01.03.2002 Ebon Clements 
.           Fixed display of linked medical record for outpatients in visit list
. V9.02.52  28.02.2002 Ebon Clements 
.           Added VISTLOC to OUTLST00 for the location on outpatient visits
. V9.02.51  18.02.2002 Ebon Clements 
.           Added invalid HCP message to visit list for outpatient events 
.           18.02.2002 Jill Habasque 
.           Changed visit type to display PMEVEVNT for patient events 
. V9.02.50  18.02.2002 Jill Habasque 
.           Changed outpatient events to output the clinic ID description
. V9.02.49  11.02.2002 Jill Habasque 
.           Fixed read of patpa1af           
. V9.02.48  06.02.2002 Sandra Barcham
.           Read CTYPLAB from correct sector
. V9.02.47  05.02.2002 Ebon Clements
.           Display clinic type for outpatient events in the visit list not
.           the unit
. V9.02.46  04.02.2002 B.G.Ackland
.           Change Find Current to Return Onleave Patientsn Also
.           04.02.02  Jill Habasque
.           Mods to MVDTAB00 to output admission & discharge records
.           04.02.02  Pat Dirito
.           Changed WIESVL00 to output Low & High Inliner Boundary Point(days) 
. V9.02.45  30/01/2002 Ebon Clements 
.           Mods to display the linked medical record for outpatient bookings
. V9.02.44  29/01/2002 Jill Habasque 
.           Added check of vistflag before output of WL and OP booking
.           29/01/2002 Pat Dirito
.           Added Tags for Low Trim, High Trim & LOS from WIES files.
.           29/01/2002 Ebon Clements 
.           Fixed read on clinic table for outpatient visit list records
. V9.02.43  23/02/2002 Ebon Clements 
.           Fixed visit list to display medical record correctly for A/Health
. V9.02.42  21/02/2002 J.Tan         
.           Mods to read the grouper details file without grouper version if the
.           record for the current grouper version not exist.
. V9.02.41  16.01.2002 Ebon Clements 
.           Changed visit list to display the service provider for allied
.           health visits not the referring hcp
.           Display clinic type for cancelled and rescheduled outpatient visits
. V9.02.40  15.01.2002 Jill Habasque 
.           Added claim code and ward/bed for inpatient event details
. V9.02.39  14.01.2002 Jill Habasque 
.           Fix patient event visit type
. V9.02.38  10.01.2002 B.G.Ackland   
.           Fix Vist Day of Week for Outpatient Visits
. V9.02.37  17.12.2001 Pat Dirito    
.           Recompiled for PATVISTM 
. V9.02.36  12.12.2001 Ebon Clements
.           Display the clinic type in the unit field for outpatient visits
.           on the patient visit list.
. V9.02.35  12.12.2001 Raghunandan Surve - HPS
.           Changed status display for Outpatient Events
. V9.02.34  07.12.2001 Pat Dirito        
.           Changed to Coder ID to Display Description not Code     
. V9.02.33  05.12.2001 Raghu Surve - HPS
.           Changed to display code of Cat EV pertinent to the event
. V9.02.32  04.12.2001 Pat Dirito                
.           Changed DISTAB00 & OPRTAB00 to display the Mapped Disease and 
.           Procedure codes along with the descriptions. 
. V9.02.31  04.12.2001 Raghunandan Surve - HPS
.           Fixed outpatient events display
. V9.02.30  29.11.2001 Raghunandan Surve - HPS
.           Fixed security option for AH visits
. V9.02.29  27.11.2001 Pat Dirito             
.           Changes for DRG Descriptions                    
.           27.11.2001 Jill Habasque          
.           Fixed unit description for waiting list patients
. V9.02.28  19.11.2001 Pat Dirito             
.           Fixed Screwed Up labels in MRTCOD00             
. V9.02.27  19.11.2001 Raghunandan Surve - HPS
.           Changed to display department, HCP for AH visits
. V9.02.26  17.11.2001 Raghunandan Surve - HPS
.           Changes to use time, clinic type and status from events table
.           for outpatient events
. V9.02.25  16.11.2001 Ebon Clements
.           Changed discharged admiss list to not display coder id if not coded
. V9.02.24  16.11.2001 B.G.Ackland
.           Moved Table Opens to INIT0000 Routine.
. V9.02.23  13.11.2001 B.G.Ackland
.           Added Rescheduled Appointments to Visit & Appointment Lists
. V9.02.22  12.11.2001 B.G.Ackland
.           Visit List Coding 
. V9.02.21  09.11.2001 Jill Habasque
.           Added output of OP bookings for the visit history (VISTAB00)
. V9.02.20  07.11.2001 Glenn Saunders
.           Fix URL for timebox patweb9804004.                 
. V9.02.19  05.11.2001 Jill Habasque
.           Added waiting list claim code and diagnosis output
. V9.02.18  03.11.2001 Jill Habasque
.           Mods to TRNTAB00 and MVDTAB00 to output care type changes
. V9.02.17  30.10.2001 G.Saunders
.           Expand Diet pop-ups and associated file updates.
.           Add Report 04 using Fieldset 1 (MASF0000) and Fieldset 2 (Diet flds)
.           Introduce new nutrition file (pmsnutaf)                             
.           30.10.2001 E.Clements 
.           Amend dept security for Aliied Health visit list.                   
. V9.02.16  27.10.2001 Pat Dirito
.           Set EPSCD001 to 1 if Blank. 
. V9.02.15  19.10.2001 J.Habasque
.           Changed VISTAB00 to output the Unit code rather than the description
. V9.02.14  13.10.2001 J.Habasque
.           Removed display of visit time for WL patients
. V9.02.13  11.10.2001 J.Tan
.           Fixed display Waiting list
. V9.02.12  10.10.2001 Jill Habasque
.           Fixed display of outpatient details in the visit list        
. V9.02.11  02.10.2001 J.Tan
.           Mods to display unscheduled W/L patients only for visit table
. V9.02.10  25.09.2001 Bronko Sosic
.           Changed VISTEMER to be EMG                                       
. V9.02.09  19.09.2001 J.Habasque
.           Fixed output of claim code for patient events                    
. V9.02.08  19.09.2001 J.Tan
.           Un-commented ICDTYP00 routine for show swap button on icd enquiry
. V9.02.07  11.09.2001 J.Habasque
.           Added tag for Veterans affairs claim number (VCLMNO)
. V9.02.06  10.09.2001 J.Tan
.           Mods to visit table details
. V9.02.04  07.09.2001 J Habasque
.           Added Transferred To tag and visit file
. V9.02.03  31.08.2001 J.Tan
.           Changed heading from MBS to CMBS
. V9.02.02  29.08.2001 J.Tan
.           Fixed status for visit details
. V9.02.01  28.08.2001 Jill Habasque
.           Added move 2 to SECOPT for patient events                    
.----------------------------------------------------------------------
. V9.01.04  19.08.2001 Jill Habasque
.           Added PMSEVTFD, modified to read this file and output details
.           for events                                                   
. V9.01.03  17.08.2001 Ebon Clements
.           Recompiled for PATMASTM and VISTAB00 visit list HTMLLINK
. V9.01.02  15.08.2001 J.Tan
.           Fixed I*C on outbokaf table
. V9.01.01  14.08.2001 J.Tan
.           Recompiled for PATMASTM
.           Added microfilem       
.----------------------------------------------------------------------
. V9.00.03  13.08.2001 J.Tan         
.           Mods output Outpatient Unit
. V9.00.02  13.08.2001 J.Tan         
.           Mods to Patient visit list (View 1 & 2)
. V9.00.01  06.08.2001 J.Tan         
.           Mods to Patient visit list (View 1 & 2)
. V9.00.B08 13.07.2001 Sandra Barcham
.           Replace GP with HCP
. V9.00.B07 25.06.2001  Ebon Clements
.           Do not display admission and discharge records in   
.           movement list
. V9.00.B06 24.06.01 HPS
.           Changed tag for email.
. V9.00.B05 22.06.2001  Ebon Clements
.           Changed details output for bed transfer list MVDTAB00
. V9.00.B03 06.06.2001  HPS 
.           Modified for Admission Criteria,Intend stay &
.           Mode of Arrival
. V9.00.B02 24/05/2001  Greg Hovrat
.           Added PATVADFD & PATVADIO for PATMISTM
. V9.00.B01 22.5.2000  HPS BLR  
.           Added Field Set Number
. V5.10.B10 03.05.2001 B.G.Ackland
.           Fix Transfer Table Output
. V5.10.B09 11.04.2001 Ebon Clements 
.           Added changes for new PATPA1FD layout
. V5.10.B08 10.04.2001 Ebon Clements 
.           Added output of PMSPX2FD patient master file
. V5.10.B07 05.04.2001 Ebon Clements 
.           Added output of PMSPX2FD patient master file
. V5.10.B06 04.04.2001 Ebon Clements 
.           Recompiled for PATMASTM
. V5.10.B05 22.03.2001 B.G.Ackland
.           Recompile for PATMISTM
. V5.10.B04 19/03/2001 Pat Dirito  
.           Modified OPRTAB00 to output the word Procedure 
. V5.10.B03 19/03/2001 Ebon Clements
.           Recompiled for PATMASTM - PCHGDTE display
. V5.10.B02 05.03.2001 Ebon Clements
.           Changed Alerts table output from user id to user name
.----------------------------------------------------------------------
. V5.09.B06 23.02.2001 Pat Dirito  
.          Modified DRGS0000 - DRG information          
. V5.09.B05 23.02.2001 J.Tan
.          Added routine to check alias
. V5.09.B04 20.02.2001 Pat Dirito 
.          Modification ICD Tables: Added DRG line information
.          Added PROFLD17 for Report 1
. V5.09.04 08.02.2001 Pat Dirito 
.          Modification to Patient Transfer Discharge Table
.          Added Unit
. V5.09.03 08.02.2001 B.G.Ackland
.          LGL Modification for Alternate ID Access to Patient
. V5.09.02 15/01/2001 Bronko Sosic
.          Recompiled for PATMASTM
.          11/01/2001 Pat Dirito   
.          Added Report no 3 Previous Address Details
.          Recompiled for OBSPALPR          
. V5.09.01 09/01/2001 Bronko Sosic
.          Changed VISTAB00 - to display home loc, doc type, vol
.          Changed MRTTAB00 - to be a Sort Table            
.----------------------------------------------------------------------
.                V5.08.06 07.11.2000 B.G.Ackland
.                         Update ICD Coding File to New Structure
.                V5.08.05 21/09/2000 Katie Nelson     
.                         Recompiled for PATMASTM - srf 647308
.                V5.08.04 16/08/2000 Katie Nelson  
.                         509 Changes   
.                V5.08.03 16/08/2000  Caleb Sharman
.                         Changed Health Fund variables to be 8 chars
.                V5.08.02 11.07.2000  B.G.Ackland
.                         Commented Out Waiting List Table. Now in WATWEB01
.                V5.08.01 17.05.2000  B.G.Ackland
.                         Make Waiting List Sort Table
.                         Make Visits Sort Table 
.                V5.07.12 22.03.2000  K.C.Nelson        
.                         Added bookings to table of visits
.                V5.07.11 02.03.2000  B.G.Ackland       
.                         Added Parameter for Bed Transfer Table Format
.                V5.07.10 24.02.2000  Nicole Harrington
.                         Added alert if merged U/R
.                V5.07.09 08.02.2000  B.G.Ackland
.                         Remove Old Download Functions
.                V5.07.08 02.02.2000  B.G.Ackland
.                         Added MR Tracking Table
.                V5.07.07 01.02.2000  K.C.Nelson        
.                         Recompiled for PATMASTM/PATMISTM - Comments           
.                V5.07.06 18.01.2000  B.G.Ackland       
.                         Changed Ward Name Output to Not Title Text 
.                V5.07.05 29/12/1999  B.G.Ackland       
.                         Removed Results Available %PATWEB98.01.600
.                         Changed to new PATMASTM routine
.                V5.07.04 15/12/1999  B.G.Ackland       
.                         Changed Notes Security to be Based on CLIWEB06 Level
.                         Changed Alerts Security to be Based on CLIWEB07 Level
.                V5.07.03 14/12/1999  Katie Nelson      
.                         Added option to find current admiss details if the
.                         U/R number has been passed through patient search
.                         11/10/1999  Nicole Harrington
.                         Added error if no Master Details found GETPAT00
.                V5.07.02 30.09.1999 K.C.Nelson       
.                         Added Master Extension Details - at taranaki
.                         23.09.1999 K.C.Nelson       
.                         Changed open patfn1af to OPPTFNS1
.                         08.07.1999 B.G.Ackland      
.                         Fix ICD9/ICD10 Display           
.                V5.07.00 25/06/1999 Katie Nelson     
.                         Port from 6.06                   
.------------------------------------------------------------
.                V6.06.02 25/06/1999 N. Harrington
.                         Added tag for results available
.                V6.06.01 15/04/1999 B.G.Ackland
.                         Added Invoice Table Options
.                V6.05.02 15/02/1999 Katie Nelson
.                         Added option to Patient Booking Details.
.                         Call to PATNAA00 instead of PATNAM to remove bold
.                         tags from within WEBTITLE.
.                V6.05.01 18/01/1999 Katie Nelson
.                         Recompiled for WEBPRTCD
.
.                V6.04.02 20.01.1998 B.G.Ackland
.                         Recompile for Standard Includes
.
.                V6.04.03 23.03.1998 B.G.Ackland
.                         New Template Body Processing   
.
.------------------------------------------------------------
          INC       IBAWEBDF    
          INC       FHRDATDF    
.
          INC       TMPALIFD/INC
          INC       NZHISIFD/INC
.
          INC       OBSDIATD
          INC       IBALPCFD/INC
          INC       ARCVX1FD/INC                 * archive visit table
          INC       ALLLNKFD/INC
          INC       ALLQUEFD/INC
          INC       ALLPRRFD/INC
          INC       PRIHDBFD/INC                 * holding header file
          INC       PRIHREFD/INC                 * referral file
          INC       APSMASFD/INC
          INC       BOKLETFD/INC
          INC       BOKRC1FD/INC
          INC       BOKRX1FD/INC
          INC       BOKRX1TD/INC
          INC       BOKRQ1FD/INC
          INC       BOKDIAFD/INC
          INC       EMRCONFD/INC
          INC       EMRUNKFD/INC
          INC       EMRLOCFD/INC
          INC       EMRVISFD/INC
          INC       IBADLABS/INC
          INC       HL7CISFD/INC
          INC       HL7INBFD/INC
          INC       OPLBVARS/INC
          INC       PATALRFD/INC
          INC       PATCALAG/INC
          INC       PATCONFD/INC
          INC       PMSCDNFD/INC
          INC       PMSRUGFD/INC
          INC       MEHCONFD/INC
          INC       MEHDLSFD/INC
          INC       MEHLEGFD/INC
          INC       MRTCONFD/INC
          INC       MLTSECFD/INC
          INC       PMSUCHFD/INC
          INC       PMSUCDFD/INC
          INC       PATMASTD/INC
          INC       VISMDTFD/INC
          INC       VISMTXFD/INC
          INC       PATCHCFD/INC
          INC       PATDHEAD/INC
          INC       PATDGWFD/INC
          INC       PATDO1FD/INC
          INC       PATDSCFD/INC
          INC       PATEORFD/INC
          INC       PATFLTFD/INC
          INC       PATONLFD/INC
          INC       PATPEIFD/INC
          INC       PATUNAFD/INC
          INC       PMSCTCFD/INC
          INC       PMSHCPFD/INC
          INC       PMSHCGFD/INC
          INC       PMSHCLFD/INC
          INC       PMSQPTFD/INC
          INC       PMSTLEFD/INC            * Patient Titles table
          INC       PATGSRFD/INC
          INC       PATILTFD/INC            * Patient Letters
          INC       PATFACFD/INC
          INC       PATFIMFD/INC                                    * CAR 257776
          INC       PATICDFD/INC
          INC       PATICOFD/INC
          INC       PATICUFD/INC
          INC       PATITMFD/INC
          INC       PATIN1FD/INC
          INC       PATINVFD/INC
          INC       PATMI1FD/INC
          INC       DISPATFD/INC
          INC       DISMASFD/INC
          INC       DISPTLFD/INC
          INC       EMRSITFD/INC
          INC       OUTPREFD/INC
          INC       PATATRFD/INC
          INC       PATATRTD/INC
.
          INC       PATMA1FD/INC
          INC       PATMMBFD/INC
          INC       PATNIDFD/INC
          INC       PMSDAUFD/INC
          INC       PATPA1FD/INC
          INC       PATPR1FD/INC
          INC       PATRE1FD/INC
          INC       PATRE1TD/INC            * Person Responsible for Acct Cgi's
          INC       PATRGMFD/INC
          INC       PATPGRFD/INC
          INC       PATTRNFD/INC
          INC       PATVADFD/INC
          INC       PATVISFD/INC
          INC       NZPSPRFD/INC
          INC       MEHLERFD/INC
          INC       MEHDIAFD/INC
          INC       MEHDS1FD/INC
          INC       MEHVI1FD/INC
          INC       PATWC1FD/INC
          INC       PATCLMTD/INC   * Claim cgi variables
          INC       PMSADWFD/INC
          INC       PMSCCDFD/INC   * Concession Card Details
          INC       PMSCHAFD/INC
          INC       PMSWTRFD/INC
          INC       PMSWX1FD/INC
          INC       ACCAUDFD/INC   * ACC Audit file
          INC       ACCCMTFD/INC   * ACC (nz) Comments File
          INC       ACCDIAFD/INC
          INC       ACCRFPFD/INC
          INC       ACCLODFD/INC   * ACC Claim Lodgements
          INC       PMSWORFD/INC
          INC       PATCFAFD/INC
          INC       PATWR1FD/INC
          INC       PATWVEFD/INC
          INC       PATFN1FD/INC
          INC       PATFX1FD/INC
          INC       PATWMAFD/INC
          INC       PMSCEXFD/INC
          INC       PMSRELFD/INC
          INC       PMSEVTFD/INC
          INC       MRTAUCFD/INC
          INC       MRTLOCFD/INC
          INC       MRTMASFD/INC
          INC       MRTHISFD/INC
          INC       MRTSTFFD/INC
          INC       MRTPDSFD/INC
          INC       MRTVISFD/INC
          INC       OPRSRGFD/INC
          INC       OPRARDFD/INC
          INC       OUTCONFD/INC
          INC       OUTSITFD/INC
          INC       OUTCLIFD/INC
          INC       OUTBOAFD/INC
          INC       OUTCANFD/INC
          INC       OUTRF1FD/INC
          INC       OUTRSHFD/INC
          INC       OUTBB1FD/INC
          INC       OUTMA1FD/INC
          INC       OUTHEDFD/INC
          INC       OUTCTYFD/INC
          INC       OUTSESFD/INC
.
          INC       PATECDFD/INC
          INC       PATECOFD/INC
          INC       RESLNKFD/INC
          INC       PMSPX2FD/INC
          INC       PMSPX2TD/INC
          INC       NZPSPRTD/INC
          INC       SAVPX2FD/INC
          INC       PATW11FD/INC                                       *I-43498
          INC       PATW12FD/INC            * WIES12                   *I-51504
          INC       PTW12BFD/INC            * WIES12B
          INC       PATW13FD/INC            * WIES13
          INC       PATW14FD/INC            * WIES14                  *I-145161
          INC       PATW15FD/INC            * WIES15
          INC       PATW16FD/INC            * WIES16
          INC       PATW17FD/INC            * WIES17
          INC       PATW18FD/INC            * WIES18
          INC       PATW19FD/INC            * WIES19
          INC       PATW20FD/INC            * WIES20
          INC       PATW21FD/INC            * WIES21
          INC       PATWIEFD/INC            * WIES22
.
.    ****** HPS BLR INCLUDE  STARTS HERE    **********
.
          INC       PATASFFD/INC
          INC       PATSFAFD/INC
          INC       PATDADFD/INC
          INC       PMSVX1FD/INC
          INC       OPRDEAFD/INC
          INC       AAEDI1FD/INC
          INC       AAEDE1FD/INC
          INC       PATHSPFD/INC
          INC       OUTDIAFD/INC
          INC       WATPROFD/INC
          INC       WATTR1FD/INC
          INC       WATTX1FD/INC
          INC       WATPACFD/INC
          INC       ALLCONFD/INC
          INC       ALLREFFD/INC
          INC       ALLRLNFD/INC
          INC       ALLENCFD/INC
          INC       ALLDEPFD/INC
          INC       ALLCASFD/INC                                      *I-267008
          INC       IBAALVFD/INC
.
.   ****** HPS BLR CODE ENDS HERE           **********
.
          INC       PMSAIDFD/INC
          INC       PMSEXTFD/INC
          INC       PATQMHFD/INC
          INC       PATQMHTD/INC
          INC       PMSEXTTD/INC
          INC       PMSHCGTD/INC
          INC       PMSHCPTD/INC
          INC       PMSOOSFD/INC
          INC       PMSRESFD/INC
          INC       PMSTEMFD/INC
          INC       WEBDATDF
          INC       CATCOMFD/INC
          INC       PMSNUTFD/INC
          INC       CATCOMTD/INC
          INC       PMSNUTTD/INC
          INC       NHIDNRFD/INC
          INC       NHIMASFD/INC
          INC       NHIETHFD/INC
          INC       PATCMCFD/INC
          INC       PMSPWAFD/INC
          INC       OBSRESFD/INC
          INC       OBSPHYFD/INC
          INC       OBSCALFD/INC
          INC       OBSDITFD/INC
          INC       OBSMEDFD/INC
          INC       OBSPINFD/INC
          INC       OBSCNCFD/INC
          INC       OBSCNAFD/INC
          INC       OBSCNBFD/INC
          INC       OBSDIAFD/INC
          INC       OBSPROFD/INC
          INC       OBSBHIFD/INC
          INC       OBSBPHFD/INC
          INC       OBSREAFD/INC
          INC       OBSLABFD/INC
          INC       OUTLETFD/INC
          INC       TFILEVAR/INC
          INC       VARGBCRN/INC            
          INC       VISPAYFD/INC
          INC       VISCMTFD/INC
          INC       EMRDCMFD/INC
          INC       EMRICDFD/INC
          INC       EMRVCDFD/INC
.
          INC       MLTHCPFD/INC
          INC       EMRDLAFD/INC            * Emergency EMR Deletion Audit
          INC       PMSEDGFD/INC            * Effective DRG Dates
          INC       OBSPCOFD/INC       * Observation Patient Correspondence
          INC       PATMISTD/INC
          INC       PMSCIDFD/INC
          INC       PMSBRQFD/INC
.
          INC       COMPARFD/INC
          INC       GTCMPATD/INC
          INC       VISXDCFD/INC
          INC       VISXDCTD/INC
.
ACCPORDN  DIM       20
ACTVDESC  DIM       3
ROOMDESC  DIM       25
IFSTDESC  DIM       25
BEDTDES1  DIM       25
ATD62FLG  FORM      1
AAEVFLAG  FORM      1                       * AAE visit flag 0=No 1=Yes
ADATEDIS  DIM       15
ALERT001  DIM       2
ALERT002  DIM       3
ALERT013  DIM       3
CHARTREV  FORM      1        * Chart Review               * T0838668
CHWCURNO  DIM       8  * Check UR Number (Workers Compensation)       *T0872408
CHWCADMN  DIM       8  * Check Admission Number (Workers Compensation)*T0872408
CISMFLAG  FORM      1                       * for HL7 messaging
CLINICAL  DIM       1
CNTRCEFR  FORM      1
CEFFDATE  DIM       8
CONTRCID  DIM       6
CPMISKEY  DIM       25                      * Confirm PMI OP session redirect
CODEDESC  DIM       40
CURPTASF  DIM       5
DDATEDIS  DIM       15
DFLTWARD  DIM       3  * ward to pre-select on ward selection list
EDDISDOC  DIM       50                 * WA health ED discharge doctor
EDDISDIA  DIM       70                 * WA health ED discharge diagnosis
EVNTFLAG  FORM      1
EMREVENT  FORM      1
EMRVSTYP  FORM      1
EMRVFDAT  DIM       8                  * Emergency Visit First Seen Date
EMRVFTIM  DIM       8                  * Emergency Visit First Seen Time
EPISADAT  DIM       8
EPISATIM  DIM       8
EPISDDAT  DIM       8
EPISDTIM  DIM       8
EPCCCODE  DIM       3
EPSTTDAT  DIM       8 
EPSTTDIS  DIM       15
EPENDDAT  DIM       8 
EPENDDIS  DIM       15
ADNODAYS  FORM      4
EPSNOLOS  FORM      4
EPNODAYS  DIM       20
ARCFLAG   FORM      1
AUDITDTE  DIM       12
BEDTDESC  DIM       20
BLNKFLAG  FORM      1
CHCDATA   DIM       30
CHNGREAS  DIM       3
CPPURNO   DIM       8
DISPCLHR  DIM       3
DISPDATE  DIM       11
DISPDVAC  DIM       20
DOCFNAM3  DIM       50
DOCFNAM4  DIM       50
DOCFNAM5  DIM       50
DOCFNAM6  DIM       50
DOCINDIC  DIM       1
MESSAGID  DIM       20
NMDSSTAT  DIM       1
NOCANVIS  DIM       1
NONXTPAT  FORM      1
NZHISMOD  FORM      1         * NZHIS change mode indicator
NBRDAYS   FORM      4
FILNHIAF  FILE      ASCII, FIXED=256       * tmp save file for forking
FILTDEPT  DIM       3
FILTHHOS  DIM       3
FILTHLOC  DIM       4
FIRSTBOK  DIM       1
DEFTFLAG  FORM      1
GENCHCDS  FORM      1
GENITNOW  FORM      1
INTRANST  DIM       26
INVADMNO  DIM       8
INVCASEK  DIM       19
INVVISTP  DIM       2
IBAMFLAG  FORM      1                       * for HL7 messaging
PACAFLAG  DIM       4
REGIDESC  DIM       50
RESIDESC  DIM       50
TEAMDESC  DIM       25
TOTALALI  FORM      3
NEXTPAGE  DIM       1                       * Nextpage parameter CGI parameter
UPDTTYPE  DIM       1                       * Update Type
UPDATETY  FORM      1
UPDPLINK  DIM       127
URCOMFLG  FORM      1
UROUTPUT  DIM       20[50]
UROUTEND  FORM      3
USEINVAD  FORM      1
USETNOT1  FORM      1                       * flag to use tablsort1 or not
WCOMFLAG  FORM      1
WLTEXT    DIM       70
PATALTID  DIM       20
PMSALTID  DIM       20
PMARQ001  DIM       10
PTMIS013  DIM       6           * Admission health fund (afundh)
PTMIS014  DIM       8           * Admission health fund table (afndtb)
PTMIS015  DIM       19          * Admission health fund Membership No (afndmm)
PMSVX142  DIM       40          * Contributor Name
PYAA      INIT      "PYAA"
PYZZ      INIT      "PYZZ"
EXTVSTID  DIM      632          * Vist No + External Visit No + Html Character
CHKEXTVD  DIM       8           * Variable for CHKEID00 proc
.
ATCHAR    INIT      "@"
FSLASH    INIT      "/"
ACCIDATE  DIM       11                      * Accident Date
ACCNUMB   DIM       20[300]
ACCVISN   DIM       8[300]
ACCCOUNT  FORM      3
PDCDATE   DIM       11                      * Patient Declaration Date
DECDATE   DIM       11                      * ACC Decline Date 
ACDNTFLG  FORM      1
PROBLEM   DIM       40
..NRCDAYS   FORM      5
..LSTDAYS   FORM      5
WARNFLAG  FORM      1
WAHEALTH  FORM      1
WIESFILE  DIM       8
WARDBED   DIM       43
HOSPTEXT  DIM       50
TXTCOLOR  DIM       20 
COUNT     FORM      3
COUNTER   FORM      1
TRNTOBED  DIM       3
TRNTOBTY  DIM       3
TRNTOCTY  DIM       3
TRNTOCLM  DIM       3
TRNTOFNS  DIM       3
TRNTODAT  DIM       8
TRNTODOC  DIM       6
TRNTOUNT  DIM       3
TRNTOTEM  DIM       5
TRNTOPAT  DIM       3
TRNTOREG  DIM       10
TRNTORES  DIM       10
TRNTOTIM  DIM       8
TRNTOWRD  DIM       3
TACCOUNT  FORM      3
TRNCOUNT  FORM      3
.
INSBDTYP  DIM       3
INSCHDAT  DIM       8
INSCHTIM  DIM       8
INSMVTYP  DIM       3
.
WCOCOUNT  FORM      3
CRUPUSER  DIM       30   * created by or updated by user
DEFAULTA  DIM       1    * default to all on visit list by type 0=no 1=yes
DIM8      DIM       8
DIM8B     DIM       8
DIM10     DIM       10
DIM13     DIM       13
DIM16     DIM       16
DIM20     DIM       20
DIM22     DIM       22
DIM24     DIM       24
DIM30     DIM       30
DIM37     DIM       37
DIM50     DIM       50
DISWARD   DIM       3
DISUNIT   DIM       3
DISBED    DIM       3
DISPCART  DIM       20
DISPUSER  DIM       30
DISPDATT  DIM       25
DISPFLAG  FORM      1 
DRG041    INIT      "041"
DRG042    INIT      "042"
DRG050    INIT      "050"
DRG051    INIT      "051"
DRG052    INIT      "052"                                             *I-137125
DRG060    INIT      "060"                                             *I-197814
DRG062    INIT      "062"                                             *I-267797
DRG070    INIT      "070"                                             *I-284420
DRG080    INIT      "080"                                             *I-822753
DRG090    INIT      "090"                                             *I-860935
DRG100    INIT      "100"                                             *I-0880255
.
FILTFDAT  DIM       8
FILTTDAT  DIM       8
FREETXT1  DIM       40
FREETXT2  DIM       40
FREETXT3  DIM       40
FREETXT4  DIM       40
FREETXT5  DIM       40
FREETXT6  DIM       40
FREETXT7  DIM       40
.
HIGHDATT  DIM       13      * Highest (latest) date & time for Dis. & Oper Codes
HOUR      FORM      2
HTMLLNK2  DIM       127
.
ENDNAME   DIM       80
JAVSNAME  DIM       30
STRTNAME  DIM       80
.
DISPPCNT  DIM       2
DISPPNAM  DIM       80
DISPPRAC  DIM       10
PRACNAME  DIM       80
PRACADD1  DIM       60
PRACADD2  DIM       60
PRACADD3  DIM       60
PRACADD4  DIM       60
PRACPOST  DIM       8
PRACPEML  DIM       80
PRACPTEL  DIM       20
PRACPFAX  DIM       20
PRACPROV  DIM       10
.
KEY3A     DIM       3
KEY8A     DIM       8
KEYBED    DIM       3
KEYWRD    DIM       3
JSONCALL  DIM       1
.
DISCTRAN  DIM       30
LASTWBED  DIM       6
LASTDOCT  DIM       6
LASTTYPE  DIM       3
LOOPCNTR  FORM      6
LABELTYP  DIM       10
MOVETYPE  DIM       1
.
MIN       DIM       2
MINTIME   FORM      2
MINUTES   FORM      3
NMPNUMB   DIM       20
.
LSTCLIN   DIM       6                        * Phantom "Clinic" for GETVIS00
LSTDOCT   DIM       6                        * Phantom "Doctor" for GETVIS00
TIME      FORM      3
.
BRK1      INIT      "("
BRK2      INIT      ")"
CLAIMFLG  FORM      1
CLMUPDFL  FORM      1
CODERNAM  DIM       35                       * Coder Name
CODEDFLG  FORM      1
CLNOT001  DIM       3                        * Type of Note
CLNOTEID  DIM       4                        * Clinical Note ID
CATct     INIT      "ct"
CATcx     INIT      "cx"
CATBW     INIT      "BW"
CATD1     INIT      "D1"
CATD2     INIT      "D2"
CATD3     INIT      "D3"
CATD4     INIT      "D4"
CATD5     INIT      "D5"
CATOA     INIT      "OA"
CATtc     INIT      "tc"
CATTY     INIT      "TY"                                              *I-259106
CATU6     INIT      "U6"
CATU7     INIT      "U7"
CATUC1    INIT      "wa"                    * Category User Def Code 1
CATUC2    INIT      "wb"                    * Category User Def Code 2
CATUC3    INIT      "wc"                    * Category User Def Code 3
CATUC4    INIT      "wd"                    * Category User Def Code 4
CATUC5    INIT      "we"                    * Category User Def Code 5
CATUC6    INIT      "wf"                    * Category User Def Code 6
CATUC7    INIT      "wg"                    * Category User Def Code 7
CATUC8    INIT      "wh"                    * Category User Def Code 8
CATwi     INIT      "wi"     * Type of Correspondence
DLCHAR    INIT      "$"
NOTESKEY  DIM       12                      * Noteskey
.DIM2A     DIM       2                       * Time in Hours
DIM3      DIM       3
DIM5      DIM       5
DIM2B     DIM       2                       * Time in Minutes
DISPCLSS  DIM       11
LINKTYP   DIM       1                       * 0=Desc 1=Code 2=Select List
LEAVFLAG  DIM       1
NMDSZERO  INIT      "Not Submitted"
NMDSONE   INIT      "Submitted"
NMDSTWO   INIT      "Warning Resubmit"
NMDSTHRE  INIT      "General Resubmit"
NMDSFOUR  INIT      "Visit Changed"
NMDSFIVE  INIT      "Coding Changed"
CATHLV    INIT      "w2"                    * Category Highlight Level
PTSTATUS  FORM      1                       * Patient Status 
SUBSYSKY  DIM       50
SETDFPRG  DIM       8
SETDFREP  DIM       8
SEVRDESC  DIM      20
SELECTIO  DIM       1                       * Select IO Template No.
SHOWCDMI  DIM       1                       * Show Event Level CDM Icons
SHOWALLH  FORM      1                       * Show all my hospitals visits
SHOWTREQ  DIM       1
SHOWCARE  DIM       1                       * Show Care Type
SHOWDSCH  DIM       1                       * Show discharge admission
NOACCDSC  DIM       50                      * No hospital access error desc
SHOWPROB  DIM       1                       * Show Problem (NZ only)
TXTLEN    FORM      3                       * Text Length
VISITTYP  DIM       2
VISTHOSP  DIM       3                       * Visit Hospital Code
VISDHOSP  DIM       50                      * Visit Hospital Description
VISITNUM  DIM       4                       * Visit Number
VISCMFLG  FORM      1
VALDWARD  DIM       3
VALDSPEC  DIM       3
FILENAMA  DIM       8                       * FileName of OBCAxxxx
FILENAMB  DIM       8                       * FileName of OBCBxxxx
OBCA      INIT      "obca"
OBCB      INIT      "obcb"
FAOPEN    DIM       8                       * OBCA File that is Open
FBOPEN    DIM       8                       * OBCB File that is Open
WBSEC008  DIM       3                        * Occupational Group
ALRTFLTR  DIM       2
CASEKEYS  DIM       28
CTYPDESC  DIM       25
CCRDTYPE  DIM       20
CCRDNUMB  DIM       20
CCRDEXDT  DIM       12
CCARDCOL  DIM       20
CCIND1    DIM       1
DELFLAG   FORM      1
FAILCNT   FORM      1
FILTSTAT  DIM       1
FILTFLAG  FORM      1
FILTHOSP  DIM       3
FILTVTYP  FORM      2
FILTVSTA  FORM      1
FOUND     FORM      1
INFORMGP  DIM       1
.
PTCNDPTM  DIM       8
LTDSRESN  DIM       3
LTDSCOM1  DIM       40
LTDSCOM2  DIM       40
TXTFST40  DIM       40
TXTLST40  DIM       40
STRTSTRK  DIM       10
SUBITMNO  DIM       3
SUBITMFO  FORM      3
.
OUTCDESC  DIM       25
SHOWALLV  DIM       1
UNKNFLAG  FORM      1                                                  *I-51223
VISTRCOD  DIM       20
VISTDESC  DIM       25
VTYPDESC  DIM       25
VISTDATE  DIM       11
VISTFLAG  FORM      1
VISTTIME  DIM       10
CODDFLAG  FORM      1
EPSADATT  DIM       25
EPSDDATT  DIM       25
DISCFLAG  FORM      1
DDRGCODE  DIM       4
DMDCCODE  DIM       4
DRGVER    DIM       3
PUBLFLAG  FORM      1
HDPEQUIV  DIM       2
HISTDATE  DIM       8
HISTTIME  DIM       5
HISTREQB  DIM       35
HISTLOCN  DIM       30
HISTCOMM  DIM       50
DESCSNAG  DIM       20
DESCHOME  DIM       30
DESCCLOC  DIM       56
DESCDOCM  DIM       30
DISCHSUM  DIM       100      * Discharge Summary (with Disch Status & Care Type)
DTYPDESC  DIM       25
HOSPFLAG  DIM       1                          * User hospital matches visit hospital 1=Yes, 0=No
WAITFLAG  DIM       1                          * Waiting list visit 1=Yes, 0=No
HWDSOUR   DIM       3                          * S37/P137 - WATCONFD
DISPSUR   DIM       8                          * Display Saved U/R Number
DISPMUR   DIM       8                          * Display Merged U/R Number
.
CHARCR    INIT      0x0D
ERRFLAG   FORM      1
EMRFLAG   FORM      1
CODEFA    INIT      "FA"
IPEVENT   INIT      "EV-IP"
OPEVENT   INIT      "EV-OP"
EMEVENT   INIT      "EV-EM"
PTTRS001  DIM       3
PTTRS002  DIM       12
PTTRS003  DIM       40
PWDVTYPE  DIM       1
SAVCLCD   DIM       100
SAVDATE   DIM       8
SAVEPKEY  DIM       24
SAVTIME   DIM       8
SAVCHDT   DIM       8
SAVCHTM   DIM       8
SAVCHUD   DIM       4
SAVCLMNO  DIM       20
SAVKEY3   DIM       3
SAVETRID  DIM       24
SAVKEY24  DIM       24
SHOWMAP   FORM      1
SHOWSJOG  FORM      1
REASCHNG  DIM       3
VIEWCCFL  FORM      1
CODTYP    FORM      2
DISNAM70  DIM       70
NAME70    DIM       70
STARTNOT  FORM      4
ZERO8     INIT      "0000    "         * for patfundf
ZEROTWO   INIT      "02"
FORM3     FORM      3
FORM8     FORM      8
CATDESC   DIM       25
CODDESC   DIM       25
CODESTAT  FORM      1
EPISODNO  FORM      2                       * Episode No
EPSCD001  FORM      2                       * Episode No (CGI Parameter)
.
FINFLAG   FORM      1
NMDSLIST  DIM       1                       * Show Update Medical Record        
RECCNT    FORM      3
REQUESTK  DIM       32
DRECCNT   DIM       3
CHECKCNT  FORM      1
VISCOUNT  FORM      5
NOURSELC  DIM       1
OUTVISTT  DIM       1
OUTPSITE  DIM       6                       
OUTADMIS  DIM       8
OUTORDER  DIM       1                       * 0 = bookings the visit
.                                           * 1 = visits then bookings
PRNTFORM  DIM       1
REFTDESC  DIM       20
SHOWFRMT  DIM       1                       * Display format for visit list     
SHOWPPRV  DIM       1                  * Display pre adm prev details screen
.                                           * 0 = Standars 1 = kids
SAVADMNO  DIM       8
SHOWMEDL  DIM       1                       * Show Update Medical Record        
.                                           * 0 = No 1 = Yes
SRCHVIEW  FORM      1                       * Show format for visit search
.                                           * 1 = Allied Health Visit Search
SETDEFPN  DIM       10[95]
SCHDPRNT  DIM       6       * Printer
SCHDCOPY  FORM      3       * No of Copies
STATNCOD  DIM       6       * Stationery Code
.
.         HPS BLR Comment Ends Here
MAX17     DIM       17
MBSDESC   DIM       40
MOVEDESC  DIM       25
MRGEFLAG  FORM      1
MOVEADM   INIT      "Admission "
MOVECHG   INIT      "Change    "
MOVEDIS   INIT      "Discharged"
MOVELVE   INIT      "On Leave  "
MOVERET   INIT      "Return    "
MEH01     INIT      "MEHWEB01"
.
ALIASIND  DIM       1
ATYPDESC  DIM       25
BEDTRKEY  DIM       30
TRANSKEY  DIM       30
BTYPDESC  DIM       25
WARDNAME  DIM       25
WARDNAM1  DIM       100
WARDNAM2  DIM       100
TODAY     DIM       8
TRANDATE  DIM       12
TRNSUPTY  FORM      2
ADMNDATE  DIM       12
DISCDATE  DIM       12
DATOFBIR  DIM       11
.
DLINKPRG  DIM       8
DLINKREP  DIM       2
DLINKTEM  DIM       3
.
EMPLNAME  DIM       30
EMPLADD1  DIM       35
EMPLADD2  DIM       35
EMPLADD3  DIM       35
EMPLADD4  DIM       35
.
LINKNUM   DIM       2
EPISODE   DIM       2
DOCTCODE  DIM       6
DSCHFLAG  FORM      1
PMVXFLAG  FORM      1
PMSVX044  DIM       3     * Coder Snags
PRIDISCD  DIM       9     * Primary Disease Code - I CAR 18122
PDIADESC  DIM       200   * Primary Disease Code Description - I CAR 18122
PRIOPRCD  DIM       9     * Primary Operation Code
POPRDESC  DIM       200   * Primary Operation Code Description
.PTVIS067  DIM       50    * Diet Comment - I SRF 22685
BRECFLAG  FORM      1
BOOKFLAG  FORM      1     * Book Referral Letter Flag
.
DOWNLD01  FORM      1
DOWNLD02  FORM      1
DOWNLD03  FORM      1
DOWNLD04  FORM      1
DOWNLD05  FORM      1
DOWNLD06  FORM      1
DOWNLD07  FORM      1
DOWNLD08  FORM      1
.
KEY1A     DIM       1
KEY4A     DIM       4
.DIM4      DIM       4
DIM6      DIM       6
DRGFLAG   FORM      1
DVACFLAG  FORM      1
NZFLAG    FORM      1
TOTOUTS   FORM      12.2
TOTPAID   FORM      12.2
TYPE2     DIM       2
SLOTNUMB  DIM       3
SAVEURNO  DIM       8
SRCHTYPE  FORM      1
NEXTVKEY  DIM       26
PREVVKEY  DIM       26
PREVFLAG  FORM      1  
SAVKEY23  DIM       23
SAVKEY26  DIM       26
SAVKEY44  DIM       44
INPATVIS  INIT      " 3"
OUTPVIS   INIT      " 2"
EMERGVIS  INIT      " 1"
ALLIVIS   INIT      "10"
EVENVIS   INIT      " 9"
SITEDONE  FORM      1
SUMOUTS   FORM      12.2
SUMPAID   FORM      12.2
SUMINV    FORM      12.2
SUMJR     FORM      12.2
SHOWFLAG  FORM      1
.
CFILEPRE  DIM       3
WAITSTAT  FORM      1
STATDESC  DIM       20
STATCODE  DIM       1
CLAIMCOD  DIM       6
CLAIMTYP  DIM       1
UNITCODE  DIM       6
UNITDESC  DIM       20    *** WARNING ****  Used in OVTTEMP1 and OVTTEMP2
PRIODESC  DIM       25
SRCRDESC  DIM       25
PRIOSTAT  DIM       25
PRIOOVER  DIM       8
OVERSTAT  DIM       1
.
PATPA001  DIM       8     * Patient U/R Number
PATPA002  DIM       8     * Date this add was changed (CCYYMMDD)
PATPA003  DIM       8     * Time this add was changed (hh:mm:ss)
.PATPA003  DIM       35    * Previous Address Line 1
.PATPA004  DIM       35    * Previous Address Line 2
.PATPA005  DIM       35    * Previous Suburb
.PATPA006  DIM       35    * Previous Address Line 4
.PATPA007  DIM       8     * Previous Postcode
.PATPA008  DIM       20    * Previous Private Telephone
.PATPA009  DIM       20    * Previous Business Telephone
.PATPA010  DIM       3     * District of Residence
.PATPA011  DIM       20    * Previous Mobile Phone Number
.PATPA012  DIM       10    * Web User ID
.
PMSDA001   DIM       8     * U/R Number
PMSDA002   DIM       8     * Date Audit Created
PMSDA003   DIM       8     * Time Audit Created
PMSDA004   DIM       3     * Type of Audit Record
.
PMDAUKEY   DIM      27 
.
ROWCOUNT   DIM       4
.
SMPOLIC    DIM      20   * POLICE STAT. ACCT REPORTED TO
SMACDAT    DIM       8   * DATE OF ACCIDENT (YYMMDD)
SMSNAME    DIM      30   * SOLICITOR NAME
SMSTELE    DIM      12   * SOLICITOR TELEPHONE
SMCREGO    DIM      36   * CAR REGO NUMBERS INVOLVED
SMACLOC    DIM      40   * ACCIDENT LOCATION
SMDPINDI   FORM      1   * 1= DRIVER, 2= PASSENGER
SMENGAGE   DIM      20   * WHILE ENG IN-FREE FORMAT ENTRY
SMPINJUR   DIM      30   * PATIENT INJURED WHEN
SMMDTRAN   DIM      10   * MODE OF TRANSPORT
SMMECHSE   DIM      30   * MECHANISM OF SEVERIST INJURY
SMREGNSE   DIM      20   * REGION OF SEVERIST INJURY
SMOTHDE1   DIM      30   * OTHER DRIVER DETAILS LINE 1
SMOTHDE2   DIM      30   * "     "      "     LINE 2
SMOTHDE3   DIM      30   * "     "      "     LINE 3
SPTWMTAC   FORM      1   * TAC CLAIM FORM COMPLETED ?
SPTWMTYP   DIM       3   * Role in Accident (CAT RA)
.
SUPERLEV  DIM       1
SWCENAME  DIM      30    * EMPLOYER NAME
SWCEADD1  DIM      35    * EMPLOYER ADDRESS LINE 1
SWCEADD2  DIM      35    * EMPLOYER ADDRESS LINE 2
SWCEADD3  DIM      35    * EMPLOYER ADDRESS LINE 3
SWCEADD4  DIM      35    * EMPLOYER ADDRESS LINE 4
SWCEPOST  DIM       8    * EMPLOYER POSTCODE
SWCETELE  DIM      20    * EMPLOYER TELEPHONE
SWCACDAT  DIM       8    * DATE OF ACCIDENT (YYMMDD)
SWCACCPT  FORM      1    * ACCEPTED BY INSURANCE COMPANY
SWCICODE  DIM       6    * INSURANCE COMPANY CODE
SWCCLMNO  DIM      20    * INSURANCE CLAIM NUMBER 
SWCCOMN1  DIM      40    * COMMENTS
SWCCOMN2  DIM      40    * COMMENTS
SPMWXALO  DIM      50    * Accident Location                  
SPMWXCIN  DIM      3     * Cause of Injury (Cat IK)           
SPMWXICO  DIM      3     * Injury Code (Cat IJ)               
SPMWXCNA  DIM      40    * Contact Name                       
SPMWXECO  DIM      6     * Employer code
.
SCHDPCNT  FORM      2
SCHDPARR  DIM       6[95]
SCHDCARR  FORM      3[95]
STATNARR  DIM       6[95]
PRTFOARR  DIM       1[95]
.
COMMTYPE  DIM       3    * Comment Type
COMMLINO  DIM       3    * Comment Line No
COMMCONT  FORM      3    * Comment Count
SAVDATA1  DIM       265
SAVDATNZ  DIM       265
SAVDATA2  DIM       265 
.
PTASF003  DIM       5    * Contract ID
.
FRWRDTXT  DIM       40
FRBEDTXT  DIM       40
.
PTMMB001  DIM       9             * MBS Code
PTMMB002  DIM       8             * Admission Number
PTMMB003  FORM      3             * Record number for admission
PTMMB004  DIM       8             * Operation Date
PTMMB005  DIM       5             * Operation Start Time
PTMMB006  DIM       5             * Operaton End Time
PTMMB007  DIM       70            * Free Format description
.
ACTVSDAT  DIM       8             * HCP active start date
ACTVEDAT  DIM       8             * HCP active end date
VALDHCPC  DIM       10            * Transfer HCP code
VALDEDAT  DIM       8             * Transfer entry date
VISITNO   DIM       8             * Visit number
.
CASTDESC  DIM       40            * Case Team description
.
CFPAYCOD  DIM       3        * 3M Codefinder PAY Code
MRFDDATE  DIM       8
.
.
.-------------------------------------------------
.    Free format label variables    I-903005
.-------------------------------------------------
DIM40     DIM       40
FNAMER    DIM       8
LASTITEM  FORM      3
LCOPIES   DIM       3
READCNT   FORM      3
TEMP1     FILE      ASCII, FIXED=256   
.------------------------------------------------
CMDLINE   DIM       127
CFNAMEO   DIM       8
TEMPO     IFILE     SQL, FIXED=13, KEY="U1-6,7-9,10-12"
KEYO      INIT      " 13 U1-6,7-9,10-12"
ISBUILD   INIT      "isbuild "
ISERASE   INIT      "iserase "
.
DASH      INIT      "-"
PFFUND    DIM       1     * Program Funding Source
CBOOK     FORM      1     
HBWAIT    FORM      1 
VENQUIRY  FORM      1
.
TAUDTYPE  DIM       30
TRNAUD01  INIT      "Ward/Bed Changed"
TRNAUD02  INIT      "Claim Type"
TRNAUD03  INIT      "Patient Type"
TRNAUD04  INIT      "Clinician/Unit/Team"
TRNAUD05  INIT      "Care Type"
TRNAUD06  INIT      "Bed Type"
TRNAUD07  INIT      "Date/Time of Record"
TRNAUD08  INIT      "Registrar"
TRNAUD09  INIT      "Resident"
.
WAITST01  INIT      "Unscheduled  "
WAITST02  INIT      "Scheduled    "
WAITST03  INIT      "Pre-Admitted "
WAITST04  INIT      "Admitted     "
WAITST05  INIT      "Discharged   "
WAITST06  INIT      "Removed      "
WAITST07  INIT      "Performed    "
WAITST08  INIT      "Not Performed"
ENDDAT    DIM       8
ENDDTIME  DIM       5
EPSSLIST  FORM      1[99]
TACRECKY  DIM       8[50]
TRNRECKY  DIM       30[99]
WCORECKY  DIM       8[50]
ERRORCNT  FORM      3                 * Count of Errors
ERRORLST  DIM       90[50]            * Error Array
.
.   ****** HPS BLR DECLARATION STARTS HERE    ***********
.
.         HPS BLR Code Starts Here
VISADIAG  DIM       12                *Diagnosis Code
ADIADESC  DIM       25
DDIADESC  DIM       25
VISTLOC   DIM       70
VISHOSID  INIT      "01"
SECOPT    DIM       1
VISTDAY   DIM       5
PVISYSN   FORM      2
VISTCOMH  INIT      "COM"
VISTEMER  INIT      "EMG"
VISTOUTP  INIT      "OP"
VISTINPT  INIT      "IP"
VISTALLH  INIT      "RF"
VISTEVNT  INIT      "EV"
VISTTYPE  DIM       5
VSTATUS   DIM       100
VIEWFLAG  FORM      1
VOLNDESC  DIM       16
.
EMGSTAT1  INIT      "Current"
.
INPSTAT1  INIT      "Pre-adm"
INPSTAT2  INIT      "Current IP"
INPSTAT3  INIT      "Discharged"
INPSTA3A  INIT      "Disc-"
INPSTA3B  INIT      "Cancelled"
INPSTAT4  INIT      "Leave"
INPSTAT5  INIT      "Cancel"
.
ALLSTAT0  INIT      "Waiting"
ALLSTAT1  INIT      "Active"
ALLSTAT2  INIT      "Closed"
ALLSTAT3  INIT      "Inactive"
ALLSTAT4  INIT      "Cancelled"
ALLSTAT5  INIT      "Rejected"
.
WLSTAT1   INIT      "Unscheduled"
WLSTAT2   INIT      "Scheduled"
WLSTAT3   INIT      "Pre-Admitted"
WLSTAT4   INIT      "Admitted"
WLSTAT5   INIT      "Discharged"
WLSTAT6   INIT      "Removed from W/L"
WLSTAT7   INIT      "Performed"
WLSTAT8   INIT      "Not Performed"
WLSTAT9   INIT      "Cancelled Booking"
.
OEVSTA0   INIT      "Outpatient-ATTENDED"
OEVSTA1   INIT      "Outpatient-NO ATTENDANCE"
OEVSTA2   INIT      "Outpatient-CANCELLED"
OBRACKET  INIT      "("
CBRACKET  INIT      ")"
.
WCSTDESC  DIM       20            * Workers Comp Claim Status description
WCESTAT0  INIT      "Existing"
WCESTAT1  INIT      "Parked"
WCESTAT2  INIT      "Completed"
WCESTAT3  INIT      "Cancelled"
.
ANSWN     INIT      "wn"
ASTA      INIT      " *"
SUBMITED  INIT      "Submitted"
SENT      INIT      "Sent"
RECEIPTD  INIT      "Receipted"
FAILED    INIT      "Failed"
FAILED1   INIT      "Failed - Bad Request: invalid data"
FAILED2   INIT      "Failed - Unauthorized: authentication error"
FAILED3   INIT      "Failed - Forbidden: authorization error"
FAILED4   INIT      "Failed - Not Found"
FAILED5   INIT      "Failed - Internal Server Error"
SLSH      INIT      "/"
TILDA30   INIT      "~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~"
TILDA35   INIT      "~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~"
STTRED    INIT      "<font color=red>"
ENDRED    INIT      "</font>"
ONCLCLSS  INIT      "CareColour"
.
CCFLAG01  INIT      "B - Care provided by hospital B"
CCFLAG02  INIT      "AB - Care provided by hospital A and hospital"
.
OVTFNAME  INIT      "ovt98a"
UKEY      INIT      " 351 U1-8,9-18,336-343,346-349"
UKEY2     INIT      " 409 U1-8,9-18,336-343,346-348"
UKEY3     INIT      " 30  U1-8,9-16,17-19,20-29"
TEMPFILE  DIM       8
TEMPFIL2  DIM       8
TEMPFIL3  DIM       8
ZERODATE  INIT      "00000000"
ZEROTIME  INIT      "00:00:00"
X1A       INIT      "X"
COUNTERD  DIM        1
.
.         Temporary File Definition
.         -------------------------
.
OVTTEMP1  IFILE SQL, FIXED=351, KEY="U1-8,9-18,336-343,346-349"
.
.NAME     TYPE    LENGTH     PHYSICAL     START     DESCRIPTION
.----     ----    ------     --------     -----     -----------
.PVIDATE  DIM     8          8            1         DATE OF VISIT  CCYYMMDD
.VISTTIME DIM     10         10           9
.OUTVISTT DIM     1          1            19
.URNUMBER DIM     8          8            20
.OUTADMIS DIM     8          8            28
.OUTPSITE DIM     6          6            36
.VISTDAY  DIM     5          5            42
.VISTTYPE DIM     5          5            47
.UNITCODE DIM     6          6            52
.DOCFNAME DIM     50         50           58
.VISTLOC  DIM     70         70           108
.CLAIMCOD DIM     6          6            178
.VSTATUS  DIM     100        100          184
.DOBAOUTN DIM     8          8            284       OUTPATIENT NUMBER
.VOLNDESC DIM     16         16           292
.UNITDESC DIM     20         20           308
.DPVIBILL DIM     8          8            328       A&E NUMBER (ACCIDENT & EMRG)
.ADMISSNO DIM     8          8            336
.PTVITYPE DIM     2          2            344       Replaces PVITYPE and PVISYST
OVTCONTO  DIM     4          4            346       UNIQUE COUNTER
.HOSPFLAG DIM     1          1            350
.
. End of Record                           351
.
.
.         Temporary File Definition
.         -------------------------
.
OVTTEMP2  IFILE SQL, FIXED=409, KEY="U1-8,9-18,336-343,346-348"
.
.NAME     TYPE    LENGTH     PHYSICAL     START     DESCRIPTION
.----     ----    ------     --------     -----     -----------
.PVIDATE  DIM     8          8            1         DATE OF VISIT  CCYYMMDD
.VISTTIME DIM     10         10           9
.OUTVISTT DIM     1          1            19
.URNUMBER DIM     8          8            20
.OUTADMIS DIM     8          8            28
.OUTPSITE DIM     6          6            36
.VISTDAY  DIM     5          5            42
.VISTTYPE DIM     5          5            47
.UNITCODE DIM     6          6            52
.DOCFNAME DIM     50         50           58
.VISTLOC  DIM     70         70           108
.CLAIMCOD DIM     6          6            178
.VSTATUS  DIM     100        100          184
.DOBAOUTN DIM     8          8            284       OUTPATIENT NUMBER
.VOLNDESC DIM     16         16           292
.UNITDESC DIM     20         20           308
.DPVIBILL DIM     8          8            328       A&E NUMBER (ACCIDENT & EMRG)
.ADMISSNO DIM     8          8            336
.PTVITYPE DIM     2          2            344       Replaces PVITYPE and PVISYST
OVTCOUNT DIM     3          3             346       UNIQUE COUNTER
.PVITYPE  FORM    1          1            349
.PVISITE  DIM     6          6            350       Outpatients Site
.SECOPT   DIM     1          1            356
.AAEVFLAG DIM     1          1            357
.EVNTFLAG DIM     1          1            358
.EMVISITE DIM     3          3            359
.BKRQVISN DIM     8          8            362
.BKRQREQN DIM     10         10           370
.CASEKEYS DIM     28         28           380       Casekeys (W/L)
.HOSPFLAG DIM     1          1            408
.
. End of Record                           409
.
PMITEMP1  IFILE SQL, FIXED=30, KEY="U1-8,9-16,17-19,20-29"
.
.NAME     TYPE    LENGTH     PHYSICAL     START     DESCRIPTION
.----     ----    ------     --------     -----     -----------
TMPADATE  DIM     8          8            1         
TMPATIME  DIM     8          8            9
TMPATYPE  DIM     3          3            17
TMPAUSER  DIM     10         10           20
.
. End of Record                           30
.
FHRCONID  DIM       13
FHRCONFL  FORM      1
OPCNDTSV  DIM       1
VISTLINK  DIM       240
VERSTAT1  INIT      "Verified"
VERSTAT2  INIT      "Manual"
STRETURN  FORM      1
TIMEZONE  DIM       6
TZFILE    FILE      ASCII, FIXED=256
FHIRBUND  FORM      1
FHRSUBIN  FORM      1      * _include=Encounter:subject
FHRLOCIN  FORM      1      * _include=Encounter:location
.                          * _include=AllergyIntolerance:location
FHRPARIN  FORM      1      * _include=Encounter:participant
FHRPATIN  FORM      1      * _include=AllergyIntolerance:patient
FHRRECIN  FORM      1      * _include=AllergyIntolerance:recorder
FHRASSIN  FORM      1      * _include=AllergyIntolerance:asserter
.
REMOTENO  FORM      2      * Remote Scripting Number (function ID)
VALDTYPE  FORM      2      * Validation Type (User Id/Password)
VALDGHCP  DIM       10     * Validation HCP Code (check GUID1/GUID2 exists)
NORETURN  DIM       1      * No return (button) flag
.
.------------------------------------------------------------------------
PRGID     INIT      "PATWEB98"
VERSION   INIT      "V12.00.09"
PRGNAM    INIT      "Patient Enquiries Template Server"
.------------------------------------------------------------------------
          CALL      WEBINT00       * Initialise Fifo Etc.
          CALL      INIT0000       * Open Files
.
MAIN1000  CALL      WEBRED00       * Read Fifo WEBPID and USERID
.
          CALL      OUTFIL00       * Check Correct Site Files Are Open
          BRANCH    EXIT,MAIN1000
.
          COMPARE   "999",REPORTNO * End Server Process on Report Option 999
          GOTO      MAIN9999 IF EQUAL
.
          PACK      CURRDATE,CCC,CYY,CMM,CDD       * Current Date
          REP       " 0",CURRDATE
.
          BRANCH    REPORTNO,MAIN1100,MAIN1200,MAIN1300,MAIN1400,MAIN1500:
                             MAIN1600,MAIN1700,MAIN1800,MAIN1900,MAIN2000:
                             MAIN2100,MAIN2200
.
          PACK      WEBTITLE,PRGID,SP1,VERSION,SP1,PRGNAM,SP70
          MOVE      "INVALID OPTION PATWEB98",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          GOTO      MAIN1000
.
MAIN1100  CALL      GETPAT00
          GOTO      MAIN1000
.
MAIN1200  CALL      MEDREC00     * Medical Record Coding
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1300  CALL      PRVADD00     * Previous Address File Maintenance
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1400  CALL      CURPER00
          CALL      CALCDT00
          CALL      GETPAT00
          GOTO      MAIN1000
.
MAIN1500  CALL      UPDCLM00     * Update TAC details with same claim no
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1600  CALL      FREEFM00     * Free format labels *I-903005
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1700  CALL      PATMMB00
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1800  CALL      HOSLST00
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1900  CALL      PATTR000         * Patient Trust
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2000  CALL      UPDTRN00                * supervisor transfer updates
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2100  CALL      PRVHCP00                 * Previous HCP File Maintenance
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2200  CALL      REMOTE00      * Remote Scripting
          GOTO      MAIN1000
.
MAIN9999  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      WEBERR00
          STOP
.------------------------------------------------------------
. Output Next Page Based on CGI Parameter nextpage
.------------------------------------------------------------
NXTPAG00  MOVE      ZERO,F1
          MOVE      NEXTPAGE,F1
          BRANCH    F1,NXTPAG10,NXTPAG20,NXTPAG30,NXTPAG40,NXTPAG50
.
          CALL      WINCLS00
          GOTO      NXTPAG99
.
NXTPAG10  CALL      RDIREC00
          GOTO      NXTPAG99
.
NXTPAG20  CALL      GOBACK00      * Go Back 1 Html page
          GOTO      NXTPAG99
.
NXTPAG30  CALL      DAH20000      * Go Back 2 html pages
          GOTO      NXTPAG99
.
NXTPAG40  CALL      GOBACK00
          GOTO      NXTPAG99
.
NXTPAG50  CALL      PREDIR00
          GOTO      NXTPAG99
.
NXTPAG99  RETURN
.------------------------------------------------------------------------------
.  Redirect Parent URL
.------------------------------------------------------------------------------
PREDIR00  CALL      OPENHTML
          BRANCH    EXIT,PREDIR90
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
.                             " alert(#"",WEBTITLE,"#");":
                             " parent.location.href=#"",REDIRECT,"#";":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      PREDIR99
.
PREDIR90  DISPLAY   "*** Fifo Not Found ***"
.
PREDIR99  RETURN
.
.-------------------------------------------------------------------------------
.  Goes back 1 page
.-------------------------------------------------------------------------------
GOBACK00  CALL      OPENHTML
          BRANCH    EXIT,GOBACK99
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "    alert(#"",WEBTITLE,"#");":
                             "    self.close();":
                             "    opener.history.go(-1);":
                             "}":
                             "</script>"
          CALL      CLOSHTML
GOBACK99  RETURN
.------------------------------------------------------------
. Open Files and Initialize Variables
.------------------------------------------------------------
INIT0000  CALL      INTMAS00   * Open Files Required for PATMASTM
.
          CLOSE     WEBSCHA2           * Close not used files from WEBINT00
          CLOSE     WEBSCHA3           * Close not used files from WEBINT00
          CLOSE     WEBSCHA4           * Close not used files from WEBINT00
.
          CALL      GETTZ000
          OPEN      ALLLNKA1,"alllnkaf"
          OPEN      ALLLNKA2,"alllnkaf"
          OPEN      ALLPRRA1,"allprraf"
....      OPEN      ALLPRRA2,"allprraf"
          OPEN      AAEDE1A1,"aaede1af"
          OPEN      AAEDI1A1,"aaedi1af"
          OPEN      DISPATA1,"dispataf"
          OPEN      DISMASA1,"dismasaf"
          OPEN      DISPTLA1,"disptlaf"
          OPEN      EMRLOCA1,"emrlocaf"
          OPEN      EMRSITA1,"emrsitaf"
          OPEN      EMRVISA3,"emrvisaf"
          OPEN      IBASEQA1,"ibaseqaf"
          OPEN      IBAPRTA1,"ibaprtaf"        * For Printer Selection
          OPEN      IBACODE1,"ibacodef"        * For Printer Selection
          OPEN      IHAPASS1,"ihapassf"        * For Printer Selection
          OPEN      IBAPDFA1,"ibapdfaf"        * For default printer selection
          OPEN      IBATMHA1,"ibatmhaf"
          OPEN      MRTAUCA2,"mrtaucaf"
          OPEN      MRTMASA1,"mrtmasaf"
          OPEN      MRTMASA2,"mrtmasaf"
          OPEN      MRTHISA1,"mrthisaf"
          OPEN      MRTLOCA1,"mrtlocaf"
          OPEN      MRTPDSA1,"mrtpdsaf"
          OPEN      MRTVISA1,"mrtvisaf"
          OPEN      PATDGWA1,"patdgwaf"
          OPEN      PMSCEXA1,"pmscexaf"
          OPEN      PMSRELA1,"pmsrelaf"
          OPEN      PATCODE1,"patcodes"
          OPEN      PATCODE2,"patcodes"
          OPEN      PATDADA1,"patdadaf" 
          OPEN      PATCHCO1,"patchcof"
          OPEN      PATCHCO2,"patchcof"
          OPEN      PATFACT1,"patfactf"
          OPEN      PATFIMA1,"patfimaf"                           * CAR 257776
          OPEN      PATINVR3,"patinvrf"
          OPEN      PATINVR5,"patinvrf"
          OPEN      PATIN1A1,"patin1af"
          OPEN      PATUNAA1,"patunaaf"
          OPEN      PATQMHA1,"patqmhaf"
          OPEN      PMSADWA1,"pmsadwaf"
          OPEN      PMSCCDA1,"pmsccdaf"
          OPEN      PMSCTCA1,"pmsctcaf"
          OPEN      PMSEXTA1,"pmsextaf"
.....     OPEN      PMSEXTA2,"pmsextaf"   * commented out 0899705
          OPEN      PMSEXTA3,"pmsextaf"
          OPEN      PMSHCPA1,"pmshcpaf"
          OPEN      PMSHCGA1,"pmshcgaf"
          OPEN      PMSHCLA1,"pmshclaf"
          OPEN      PMSEVTA1,"pmsevtaf"
          OPEN      PMSTLEA1,"pmstleaf"          * open Patient Titles table
          OPEN      PMSTLEA2,"pmstleaf"          *
          OPEN      PMSDAUA1,"pmsdauaf"
          OPEN      PATPA1A1,"patpa1af"
          OPEN      PATPGRA1,"patpgraf" 
          OPEN      PATGSRN1,"patgsrnf" 
          OPEN      PATICDO1,"paticdof"
          OPEN      PATICUA1,"paticuaf"
          OPEN      PATI10O1,"pati10of"
          OPEN      PATICDD1,"paticddf"
          OPEN      PATI10D1,"pati10df"
.....     OPEN      PATFLET2,"patfltrf"   * commented out 0898168
          OPEN      PMSCDNA1,"pmscdnaf"
          OPEN      PMSRUGA1,"pmsrugaf"
          OPEN      IBALPCA1,"ibalpcaf"
          OPEN      EMRDCMA1,"emrdcmaf"
          OPEN      EMRICDA1,"emricdaf"
          OPEN      EMRVCDA1,"emrvcdaf"
.
          MOVE      ZERO,ARCFLAG
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      ARCVX1A1,"arcvx1af"
          TRAPCLR   IO
          IF        OVRCD=0
            MOVE      ONE,ARCFLAG
          ENDIF
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      CATCOMA1,"catcomaf"
          TRAPCLR   IO
.
          OPEN      PMSVX1A1,"pmsvx1af" 
          OPEN      PATRE1A1,"patre1af"
          OPEN      PATRGMA1,"patrgmaf"
          OPEN      BOKDIAA1,"bokdiaaf"
          OPEN      BOKRC1A1,"bokrc1af"
          OPEN      BOKRX1A1,"bokrx1af"
          OPEN      BOKRC1A6,"bokrc1af"
          OPEN      BOKRQ1A2,"bokrq1af"
          OPEN      BOKLETR2,"bokletrf"
          OPEN      WATPROA1,"watproaf"
          OPEN      WATTR1A1,"wattr1af"
          OPEN      WATTR1A4,"wattr1af"
          OPEN      WATTX1A1,"wattx1af"
          OPEN      WATPACA1,"watpacaf" 
          OPEN      WEBSECA3,"websecaf"
          OPEN      PATFN1A1,"patfn1af"
          OPEN      VISPAYA1,"vispayaf"
          OPEN      VISCMTA1,"viscmtaf"
.
          OPEN      PATDSCH1,"patdschf"
          OPEN      PATPEIO1,"patpeiaf"
          OPEN      PATTRAN2,"pattranf"
          OPEN      PATVADA1,"patvadaf"
          OPEN      PATVISA1,"patvisaf"
          OPEN      PATVISA2,"patvisaf"
          OPEN      PATVISA4,"patvisaf"
          OPEN      PATWR1A1,"patwr1af"
          OPEN      PATWR1A7,"patwr1af"
          OPEN      NZPSPRA1,"nzpspraf"
          OPEN      MEHDIAA1,"mehdiaaf"
          OPEN      MEHDS1A1,"mehds1af"
          OPEN      MEHVI1A1,"mehvi1af"
          OPEN      MEHVI1A4,"mehvi1af"           * I SRF 22727
          OPEN      MEHLEGA1,"mehlegaf"           * I SRF 22727
          OPEN      PATMMBS1,"patmmbsf"
          OPEN      PATMMBS2,"patmmbsf"
          OPEN      PATITEM1,"patitemn"
          OPEN      PMSPX2A1,"pmspx2af"
          OPEN      PATHSPA1,"pathspaf"
.
          OPEN      ALLREFA1,"allrefaf"
          OPEN      ALLRLNA2,"allrlnaf"
          OPEN      ALLDEPA1,"alldepaf"
          OPEN      ALLENCA1,"allencaf"
          OPEN      ALLCASA1,"allcasaf"                               *I-267008
          OPEN      PATDADA1,"patdadaf"
          OPEN      PATNIDA2,"patnidaf"
          OPEN      PATASFA1,"patasfaf"
          OPEN      PATSFAA1,"patsfaaf"
          OPEN      PATWVET1,"patwvetf"
          OPEN      PATWMAB1,"patwmabf"
          OPEN      PATWMAB2,"patwmabf"
          OPEN      PATWMAB3,"patwmabf"
          OPEN      PATWC1A1,"patwc1af"
          OPEN      PATWC1A2,"patwc1af"
          OPEN      PATWC1A3,"patwc1af"
          OPEN      PMSWX1A1,"pmswx1af"
          OPEN      ACCAUDA1,"accaudaf"
          OPEN      ACCCMTA1,"acccmtaf"
          OPEN      ACCDIAA1,"accdiaaf"
          OPEN      ACCRFPA1,"accrfpaf"
          OPEN      PMSRESA1,"pmsresaf"
          OPEN      PMSTEMA1,"pmstemaf"
          OPEN      PMSWORA1,"pmsworaf"
..        OPEN      PATW11A1,"patw11af" 
..        OPEN      PATW12A1,"patw12af"                                *I-51504
..        OPEN      PATW12B1,"patw12bf"
..        OPEN      PATW13A1,"patw13af"
..        OPEN      PATW14A1,"patw14af"                               *I-145161
..        OPEN      PATW15A1,"patw15af"
..        OPEN      PATW16A1,"patw16af"
..        OPEN      PATW17A1,"patw17af"
..        OPEN      PATW18A1,"patw18af"
          OPEN      PATW19A1,"patw19af"
          OPEN      PATW20A1,"patw20af"
          OPEN      PATW21A1,"patw21af"
          OPEN      PATWIEA1,"patwieaf"
...       OPEN      PATLETR1,"patletrf"   * commented out 0899705
          OPEN      VISXDCA1,"visxdcaf"
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      EMRUNKA1,"emrunkaf"
          OPEN      EMRVISA1,"emrvisaf"
          OPEN      EMRDLAA1,"emrdlaaf"
          TRAPCLR   IO
          MOVE      OVRCD,EMRFLAG
.
          OPEN      PATECDA1,"patecdaf"
          OPEN      PATECOA1,"patecoaf"
.
          CALL      OPICD1                      * Open ICD Disease files
          CALL      OPICO1                      * Open ICD Operation files
.
          OPEN      MEHDLSA1,"mehdlsaf"
          OPEN      MLTSECA1,"mltsecaf"
          OPEN      VISMDTA1,"vismdtaf"
          OPEN      VISMTXA1,"vismtxaf"
          OPEN      PMSNUTA1,"pmsnutaf"         * new nutrition file v9.02.17
          OPEN      PMSCHAA1,"pmschaaf"
....      OPEN      OBSPINA1,"obspinaf"
          OPEN      OBSCNAA1,"obscnaaf"
          OPEN      OBSCNBA1,"obscnbaf"
          OPEN      OBSCNCA1,"obscncaf"
          OPEN      OBSDIAA1,"obsdiaaf"
          OPEN      OBSBPHA1,"obsbphaf"
          OPEN      OBSPROA1,"obsproaf"
          OPEN      OBSREAA1,"obsreaaf"
          OPEN      OBSBHIA1,"obsbhiaf"
          OPEN      OBSLABA1,"obslabaf"
          OPEN      OBSMEDA1,"obsmedaf"
          OPEN      OBSRESA1,"obsresaf"
          OPEN      OBSPHYA1,"obsphyaf"
          OPEN      OBSDITA1,"obsditaf"
          OPEN      OBSCALA1,"obscalaf"
          OPEN      PATMI1A8,"patmi1af"
          OPEN      IBASPOL1,"ibaspolf"         * For spool file       
          OPEN      CONTROLF,"controlf"         * For spool file       
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,TEN;*250,CAUDA1
          READ      CONTROLF,TEN9;*212,CFEETYP
          READ      CONTROLF,HUND03;*220,PTCNDEES,*221,PTCNDDES
          READ      CONTROLF,HUND12;*101,PTCNUFFR
          READ      CONTROLF,HUND10;*240,PTCNUALT
          READ      CONTROLF,HUND16;*214,PTCNDCDM
          READ      CONTROLF,HUND18;*138,PTCNNEWC,*154,PTCNUHSC 
          READ      CONTROLF,HUND06;*203,ALCNMDES
          READ      CONTROLF,FIFTY9;*193,PTCNRQCF
          READ      CONTROLF,HUND06;*217,ALCNCLNF
          READ      CONTROLF,HUND13;*62,OPCNDTSV
          READ      CONTROLF,HUND20;*243,PTCNSMSN
          READ      CONTROLF,HUND24;*212,PTCNIRAI,*147,PTCNSUID
          READ      CONTROLF,HUND25;*93,PTCNNSSI
          READ      CONTROLF,HUND28;*105,PTCNUABF
          READ      CONTROLF,HUND28;*230,PTCNALTV
.
          COMPARE   ONE,PTCNRQCF       * Using Free Format Requester
          IF        !@EQUAL
            OPEN      MRTSTFA1,"mrtstfaf"
          ENDIF
.
          IF        CAUDA1<>1
            OPEN      PATAUDAL,"pataudal"
            OPEN      PATAUDA2,"pataudal"
          ENDIF
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
....        OPEN      MLTCODA2,"mltcodaf"
            OPEN      MLTHCPA1,"mlthcpaf"
....        OPEN      MLTHCPA2,"mlthcpaf"
          ENDIF
.
          OPEN      PMSAIDA1,"pmsaidaf"
          OPEN      IBAALVA1,"ibaalvaf"
.
          READ      CONTROLF,EIGHTY;*250,PTCNHDPS
          READ      CONTROLF,TEN;*94,CAGECOFF:
                                 *126,CLABPG,CLABPRT,*235,CMDISP
          READ      CONTROLF,TEN3;*188,CMABINS,CVETINS
          READ      CONTROLF,TWENTY;*223,PTCNLNFF,*224,PTCNCHFF
          READ      CONTROLF,THIRTY7;*137,HWDSOUR
          READ      CONTROLF,FIFTY9;*35,CTYPLAB,*220,PTCNUADT
          READ      CONTROLF,EIGHTY;*249,PTCNEDTE
          READ      CONTROLF,EIGHTY8;*59,PTCNI10D,*237,PTCNEMPL
          READ      CONTROLF,EIGHTY9;*180,EMCNLDAT
          READ      CONTROLF,TWENTY1;*138,PTCNNHII
          READ      CONTROLF,TWENTY1;*45,PTCNDRSM 
          READ      CONTROLF,SIXTY9;*43,MHCNAUDA,*69,MHCNUSE,*82,MHCNDVIS
          READ      CONTROLF,SIXTY;*133,MRCNEPSC
          READ      CONTROLF,SIXTY1;*240,MRCNUNWA,*241,MRCNENWA
          READ      CONTROLF,HUND09;*177,PTCNNHTM
          READ      CONTROLF,TWENTY;*52,PTPCLRES
          READ      CONTROLF,TWENTY1;*237,PTCNPAOF,*238,PTCNAGEC
          READ      CONTROLF,NINTY7;*176,MRCNTREC,*180,MRCNCCOD
          READ      CONTROLF,HUND05;*158,PTCNDGPV,*211,PTCNBPAY: *I-43526I-48227
                                    *217,PTCNGDV4,*227,PTCNGDV5       *C-105244
          READ      CONTROLF,HUND09;*151,PTCNGDV3                      *I-51504
          READ      CONTROLF,HUND12;*96,PTCNH7AC,*239,PTCNGDV6        *C-163918
          READ      CONTROLF,HUND10;*61,PTCNGDV7,*69,PTCNGDV8:        *I-284420
                                    *77,PTCNGDV9,*85,PTCNGDVX         *I-0833093
          READ      CONTROLF,HUND17;*220,PTCNGDX1
          READ      CONTROLF,HUND28;*231,PTCNGDX2                     *I-0917793
          READ      CONTROLF,HUND16;*222,PTCNXCOM
          READ      CONTROLF,HUND12;*104,PTCNWBDS 
.
          OPEN      OUTSITA1,"outsitaf"     * Open the site file
          OPEN      OUTSITA3,"outsitaf"     * Open the site file
          MOVE      "out",CFILEPRE          * Save Current File Prefix
          CALL      OPNOUT00                * Open Outpatient Files 
          OPEN      OUTRF1A1,"outrf1af"
          OPEN      OUTCANA1,"outcanaf"     * Cancelled Booking Details
          OPEN      OUTLETR1,"outletrf"
          OPEN      OUTLETR2,"outletrf"
.
          IF        PTCNNHII=1
            OPEN      PATMWSA1,"patmwsaf"
          ENDIF
          MOVE       ZERO,ATD62FLG
.
          OPEN      OPRSRGA1,"oprsrgaf"
          OPEN      OPRARDA1,"oprardaf"
          OPEN      OPRDETA2,"oprdetaf"     * Open Theatre Operation Details
          OPEN      OPRDETA3,"oprdetaf"     * Open Theatre Operation Details
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,TEMPFILE
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FNAMER
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,CFNAMEO
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,TEMPFIL2
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,TEMPFIL3
.
          OPEN      OBSPCOA1,"obspcoaf"     * Observation Patient Correspondence
.
INIT9999  RETURN
.------------------------------------------------------------
. Get Time Zone
.------------------------------------------------------------
GETTZ000  MOVE      ZERO,OVRCD
          MOVE      "+0000",KEY5
          TRAP      OVERCOND IF IO
          OPEN      TZFILE,"timezone"
          TRAPCLR   IO
          IF        OVRCD=0
            READ      TZFILE,SEQ;KEY5
          ELSE
            EXECUTE   "date +#"%z#">timezone.txt",TASKID
            TRAP      OVERCOND IF IO
            OPEN      TZFILE,"timezone"
            TRAPCLR   IO
            IF        OVRCD=0
              READ      TZFILE,SEQ;KEY5
            ENDIF
          ENDIF
          CLOSE     TZFILE
          UNPACK    KEY5,KEY3,KEY2
          PACK      TIMEZONE,KEY3,COLON,KEY2
          RETURN
.*******************************************************************************
. OUTFIL00 - Check if the user id has an outpatienty site. If they do open
.            the correct outpatient files according to the site. If they do not
.            have a site make sure the default prefix of out is is used to 
.            open the files.
.*******************************************************************************
OUTFIL00  MATCH     SP70,WBSESIT             * Does the user have a site
          GOTO      OUTFIL50 IF NOT EQUAL
.
OUTFIL10  MATCH     "out",CFILEPRE           * Is out currently open
          IF        !@EQUAL
            MOVE      "out",OSTFILE          * open default prefix of out
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open out Outpatient Files
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      OUTFIL99
.
OUTFIL50  MOVE      WBSESIT,KEY6
          CALL      RDSITA1
          BRANCH    OVRCD,OUTFIL90           * error invalid site code
.
          MATCH     OSTFILE,CFILEPRE         * Save Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open prefixed Outpatient Files
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      OUTFIL99
.
OUTFIL90  MOVE      "Outpatient Site Invalid",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
OUTFIL99  RETURN
.*******************************************************************************
. COTFIL00 - Check that the correct outpatient site prefix files are open 
.            according to the visit files site code. If the site is invalid    
.            or blank just open the default site of out.                            
.*******************************************************************************
COTFIL00  MATCH     SP70,PVISITE             * Does the visit have a site
          GOTO      COTFIL50 IF NOT EQUAL
.
COTFIL10  MATCH     "out",CFILEPRE           * Is out currently open
          IF        !@EQUAL
            MOVE      "out",OSTFILE          * open default prefix of out
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open out Outpatient Files
          ENDIF
.
          GOTO      COTFIL99
.
COTFIL50  MOVE      PVISITE,KEY6
          CALL      RDSITA1
          BRANCH    OVRCD,COTFIL10           * error invalid site code
.
          MATCH     OSTFILE,CFILEPRE         * Save Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open prefixed Outpatient Files
          ENDIF
.
          GOTO      COTFIL99
.
COTFIL99  RETURN
.------------------------------------------------------------
. Open Outpatient Files
.------------------------------------------------------------
OPNOUT00  PACK      CFNAME,CFILEPRE,FILBOKA3  * Get the name of the BOKA3 file
          CLOSE     OUTBOKA3
          OPEN      OUTBOKA3,CFNAME           * Open the file
          CLOSE     OUTBOKA2
          OPEN      OUTBOKA2,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILRSHA1
          CLOSE     OUTRSHA1
          OPEN      OUTRSHA1,CFNAME
.
          PACK      CFNAME,CFILEPRE,FILCANA2
          CLOSE     OUTCANA2
          OPEN      OUTCANA2,CFNAME
.
          PACK      CFNAME,CFILEPRE,FILBB1A1  * Get the name of the BOKA3 file
          CLOSE     OUTBB1A1
          OPEN      OUTBB1A1,CFNAME     
.
          PACK      CFNAME,CFILEPRE,FILSESA1  * Get the name of the SESA1 file
          CLOSE     OUTSESA1
          OPEN      OUTSESA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILCLIA1  * Get the name of the CLIA1 file
          CLOSE     OUTCLIA1
          OPEN      OUTCLIA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILCTYA1  * Get the name of the CTYA1 file
          CLOSE     OUTCTYA1
          OPEN      OUTCTYA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILMA1A1
          CLOSE     OUTMA1A1
          OPEN      OUTMA1A1,CFNAME
.
          PACK      CFNAME,CFILEPRE,FILHEDA1
          CLOSE     OUTHEDA1
          OPEN      OUTHEDA1,CFNAME
.
          PACK      CFNAME,CFILEPRE,FILDIAG1
          CLOSE     OUTDIAG1
          OPEN      OUTDIAG1,CFNAME    
.
OPNOUT99  RETURN
.------------------------------------------------------------
. Clear Parameters
.------------------------------------------------------------
CLRPAR00  MOVE      ZERO,REPORTNO
          MOVE      SP70,TEMPLATE
          MOVE      SP70,JSONCALL
          MOVE      SP70,URNUMBER
          MOVE      SP70,PATALTID
          MOVE      SP70,PMSALTID
          MOVE      SP70,UPDTTYPE
          MOVE      SP70,CASEKEYS
          MOVE      ZERO,EPSCD001
          MOVE      SP70,SAVEURNO
          MOVE      SP70,ADMISSNO
          MOVE      ZERO,STARTNOT
          MOVE      SP70,REASCHNG
          MOVE      SP70,NEXTPAGE
          MOVE      SP70,NOURSELC
          PACK      REDIRECT,SP70,SP70,SP70,SP70
          MOVE      ZERO,MRGEFLAG
          MOVE      ZERO,SRCHTYPE
          MOVE      ZERO,DOWNLD01
          MOVE      ZERO,DOWNLD02
          MOVE      ZERO,DOWNLD03
          MOVE      ZERO,DOWNLD04
          MOVE      ZERO,DOWNLD05
          MOVE      ZERO,DOWNLD06
          MOVE      ZERO,DOWNLD07
          MOVE      ZERO,DOWNLD08
          MOVE      SP70,SHOWALLV
          MOVE      SP70,PATPA001
          MOVE      SP70,PATPA002
          MOVE      SP70,PATPA003
          MOVE      SP70,PMSDA001
          MOVE      SP70,PMSDA002
          MOVE      SP70,PMSDA003
          MOVE      SP70,PMSDA004
          MOVE      SP70,INVADMNO
          MOVE      SP70,INVCASEK
          MOVE      ZERO,USEINVAD
          MOVE      SP70,INVVISTP
          MOVE      SP70,PMSVX044      * Coder Snags
          MOVE      Z70,PTTRS001
          MOVE      Z70,PTTRS002
          MOVE      Z70,PTTRS003
          MOVE      ZERO,CODEDFLG
          MOVE      ZERO,VIEWTYPE
          MOVE      SP70,PWDVTYPE
          MOVE      SP70,FRSTDATE
          MOVE      SP70,LASTDATE
          MOVE      SP70,FILTFDAT
          MOVE      SP70,FILTTDAT
          MOVE      SP70,VYEARMTH
          MOVE      ZERO,CHECKCNT
          MOVE      SP70,CLNOT001
          MOVE      SP70,WBSEC008
          MOVE      SP70,ALRTFLTR
          MOVE      ZERO,BOOKFLAG
.          MOVE      Z70,PTVIS067       * I SRF 22685
          MOVE      SP70,FILTSTAT
          MOVE      ZERO,FILTVTYP
          MOVE      ZERO,FILTVSTA
          MOVE      ZERO,FILTFLAG
          MOVE      SP70,FILTHOSP
          MOVE      SP70,NMDSSTAT
          MOVE      ZERO,STARTNUM
          MOVE      ZERO,NORECORD
          MOVE      SP70,NEXTVKEY
          MOVE      SP70,PREVVKEY
          MOVE      ZERO,PREVFLAG
          MOVE      ZERO,UPDATETY
          MOVE      ZERO,EMREVENT
          MOVE      SP70,SUPERLEV
          MOVE      Z70,REQUESTK
          MOVE      SP70,STATNCOD
          MOVE      Z70,PRNTFORM
          MOVE      SP70,SCHDPRNT
          MOVE      ZERO,SCHDCOPY
          MOVE      SP70,VISDHOSP
          MOVE      ZERO,VENQUIRY
          MOVE      Z70,ALERT001
          MOVE      Z70,ALERT002
          MOVE      Z70,ALERT013
          MOVE      SP70,PMARQ001
          MOVE      SP70,CLINICAL
          MOVE      ZERO,WAHEALTH
          MOVE      ZERO,NONXTPAT
          MOVE      SP70,VALDWARD
          MOVE      SP70,VALDSPEC
.
          MOVE     Z70,ACCPORDN
          MOVE     SP70,PTCLM001
          MOVE     SP70,PTCLM002
          MOVE     SP70,PTCLM003
          MOVE     SP70,PTCLM004
          MOVE     SP70,PTCLM005
          MOVE     SP70,PTCLM006
          MOVE     SP70,PTCLM007
          MOVE     SP70,PTCLM008
          MOVE     SP70,PTCLM010
          MOVE     SP70,PTCLM011
          MOVE     SP70,PTCLM012
          MOVE     SP70,PTCLM013
          MOVE     SP70,PTCLM014
          MOVE     SP70,PTCLM015
          MOVE     SP70,PTCLM016
          MOVE     SP70,PTCLM017
          MOVE     SP70,PTCLM018
          MOVE     SP70,PTCLM019
          MOVE     SP70,PTCLM020
          MOVE     SP70,PTCLM021
          MOVE     SP70,PTCLM022
          MOVE     SP70,PTCLM023
          MOVE     SP70,PTCLM024
          MOVE     SP70,PTCLM025
          MOVE     SP70,PTCLM026
          MOVE     SP70,PTCLM027
          MOVE     SP70,PTCLM028
          MOVE     SP70,PTCLM029
          MOVE     SP70,PTCLM030
          MOVE     SP70,PTCLM031
          MOVE     SP70,PTCLM032
          MOVE     SP70,PTCLM033
          MOVE     SP70,PTCLM034
          MOVE     SP70,PTCLM035
          MOVE     SP70,PTCLM036
          MOVE     SP70,PTCLM037
          MOVE     SP70,PTCLM038
          MOVE     SP70,PTCLM039
          MOVE     SP70,PTCLM040
          MOVE     SP70,PTCLM041
          MOVE     SP70,PTCLM042
          MOVE     SP70,PTCLM043
          MOVE     SP70,PTCLM044
          MOVE     SP70,PTCLM045
          MOVE     SP70,PTCLM082
          MOVE     SP70,PTCLM083
          MOVE     SP70,FILTDEPT
          MOVE     ZERO,DEFTFLAG
          MOVE     SP70,FILTHHOS
          MOVE     SP70,FILTHLOC
          MOVE     ZERO,PTSTATUS
.
          CALL      CLPTPRA0                * clear P.R.A cgi variables
.
          MOVE      ONE,TACCOUNT
          WHILE     TACCOUNT <= 50
            MOVE      SP70,TACRECKY[TACCOUNT]
            ADD       ONE,TACCOUNT
          DO
.
          MOVE      ONE,WCOCOUNT
          WHILE     WCOCOUNT <= 50
            MOVE      SP70,WCORECKY[WCOCOUNT]
            ADD       ONE,WCOCOUNT
          DO
.
          MOVE      ONE,TRNCOUNT
          WHILE     TRNCOUNT <= 99
            MOVE      SP70,TRNRECKY[TRNCOUNT]
            ADD       ONE,TRNCOUNT
          DO
.
          MOVE      ZERO,TACCOUNT
          MOVE      ZERO,TRNCOUNT
          MOVE      ZERO,WCOCOUNT
          MOVE      ZERO,ERRORCNT
          MOVE      ZERO,SRCHVIEW
.
          PACK      WLINE1A,SP30,SP30            
          PACK      WLINE2A,SP30,SP30 
          PACK      WLINE3A,SP30,SP30            
          PACK      WLINE4A,SP30,SP30
          PACK      WLINE5A,SP30,SP30
          PACK      WLINE6A,SP30,SP30
          PACK      WLINE7A,SP30,SP30
          PACK      WLINE8A,SP30,SP30
.
.---end *I-903005 ---
.
          MOVE      SP70,PTMMB001
          MOVE      ZEROVISN,PTMMB002
          MOVE      ZERO,PTMMB003
          MOVE      SP70,PTMMB004
          MOVE      SP70,PTMMB005
          MOVE      SP70,PTMMB006
          MOVE      SP70,PTMMB007
.
          CALL      CPPMEX00
.
          MOVE      Z70,PTMIS013
          MOVE      Z70,PTMIS014
          MOVE      Z70,PTMIS015
          MOVE      Z70,PMSVX142
.
          MOVE      ZERO,TRNSUPTY
          MOVE      Z70,TRNTOWRD
          MOVE      Z70,TRNTOBED
          MOVE      Z70,TRNTOBTY
          MOVE      Z70,TRNTOCTY
          MOVE      Z70,TRNTOCLM
          MOVE      Z70,TRNTOFNS
          MOVE      Z70,TRNTODOC
          MOVE      Z70,TRNTOUNT
          MOVE      Z70,TRNTOTEM
          MOVE      Z70,TRNTOPAT
          MOVE      Z70,TRNTOREG
          MOVE      Z70,TRNTORES
          MOVE      Z70,TRNTODAT
          MOVE      Z70,TRNTOTIM
          MOVE      SP70,CHNGREAS
          MOVE      SP70,TRANSKEY
.
          MOVE      Z70,INSBDTYP
          MOVE      Z70,INSCHDAT
          MOVE      Z70,INSCHTIM
          MOVE      Z70,INSMVTYP
.
          MOVE      Z70,PTASF003
          MOVE      SP70,DISCTRAN
.
          MOVE      SP70,NOCANVIS
          MOVE      ZERO,SHOWALLH
.
          MOVE      SP70,SETDFPRG
          MOVE      SP70,SETDFREP
.
          MOVE      SP70,LEAVFLAG
          MOVE      ZERO,FHIRBUND
          MOVE      ZERO,FHRSUBIN
          MOVE      ZERO,FHRLOCIN
          MOVE      ZERO,FHRPARIN
          MOVE      ZERO,FHRPATIN
          MOVE      ZERO,FHRRECIN
          MOVE      ZERO,FHRASSIN
.
          MOVE      SP70,PMDAUKEY
          MOVE      SP70,NZIBCPTR
          MOVE      SP70,CPMISKEY
.
          MOVE      ZERO,REMOTENO
          MOVE      ZERO,VALDTYPE
          MOVE      ZERO,NZFLAG
          MOVE      SP70,VALDGHCP
.
          MOVE      SP70,PTCNDPTM
          MOVE      SP70,LTDSRESN
          MOVE      SP70,LTDSCOM1
          MOVE      SP70,LTDSCOM2
          MOVE      SP70,NORETURN
          MOVE      ZERO,DISCFLAG
.
          MOVE      ONE,F2
          WHILE     F2 < 95
            MOVE      SP70,PRTFOARR[F2]
            MOVE      SP70,SCHDPARR[F2]
            MOVE      ZERO,SCHDCARR[F2]
            MOVE      SP70,STATNARR[F2]
            ADD       ONE,F2
          DO
.
CLRPAR99  RETURN
+
.------------------------------------------------------------
. Set Parameters
.------------------------------------------------------------
SETPAR00  MATCH     "reportno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REPORTNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "template=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TEMPLATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "jsoncall=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,JSONCALL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "urnumber=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,URNUMBER
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nourselc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NOURSELC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updatety=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,UPDATETY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pataltid=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PATALTID
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmsaltid=",QRYNAME
          IF        @EQUAL
            PACK      PMSALTID,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "claimtyp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CLAIMTYP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "invadmno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,INVADMNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "invcasek=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,INVCASEK
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "useinvad=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,USEINVAD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptclm",QRYNAME
          IF        @EQUAL
            CALL      SPCLM000
            COMPARE   ZERO,EXIT
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "admissno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMISSNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "downld",QRYNAME
          IF        @EQUAL
            CALL      DOWNP000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "showallv=",QRYNAME
          IF        @EQUAL
            PACK      SHOWALLV,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmnut",QRYNAME
          IF        @EQUAL
            CALL      SPNUT000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startnot=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,STARTNOT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "redirect=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,REDIRECT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nextpage=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,NEXTPAGE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "bookflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,BOOKFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updttype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDTTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "epscd001=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EPSCD001
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchtype=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,SRCHTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchview=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SRCHVIEW
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "patpa",QRYNAME
          IF        @EQUAL
            CALL      PATPA000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmsda",QRYNAME
          IF        @EQUAL
            CALL      PMSDA000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pttrs001=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PTTRS001
            PACK      PTTRS001,PTTRS001,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pttrs002=",QRYNAME
          IF        @EQUAL
            MATCH     SP70,QRYDATA
            IF        @EQUAL|@EOS
              PACK      PTTRS002,SP70
              GOTO      SETPAR99
            ENDIF
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      PTTRS002,CCENT,CYEAR,CMON,CDAY
            REP       " 0",PTTRS002
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pttrs003=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PTTRS003
            PACK      PTTRS003,PTTRS003,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmsvx044=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PMSVX044
            PACK      PMSVX044,PMSVX044,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmsvx142=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PMSVX142
            PACK      PMSVX142,PMSVX142,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptmis013=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PTMIS013
          ENDIF
.
          MATCH     "ptmis014=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PTMIS014
          ENDIF
.
          MATCH     "ptmis015=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PTMIS015
          ENDIF
.
          MATCH     "codedflg=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CODEDFLG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "viewtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VIEWTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pwdvtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PWDVTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "frstdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FRSTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "lastdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LASTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "lfstdate=",QRYNAME
          IF        @EQUAL
            MOVE      "00000000",FRSTDATE
            MATCH     SP20,QRYDATA
            IF        !@EOS
              UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      FRSTDATE,CCENT,CYEAR,CMON,CDAY
              REP       " 0",FRSTDATE
            ENDIF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "llstdate=",QRYNAME
          IF        @EQUAL
            MOVE      "99999999",LASTDATE
            MATCH     SP20,QRYDATA
            IF        !@EOS
              UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      LASTDATE,CCENT,CYEAR,CMON,CDAY
              REP       " 0",LASTDATE
            ENDIF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "vyearmth=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VYEARMTH
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "alert001=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ALERT001
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "alert002=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ALERT002
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "alert013=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ALERT013
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "reaschng=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REASCHNG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "clnot001",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CLNOT001
            PACK      CLNOT001,CLNOT001,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "wbsec008",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,WBSEC008
            PACK      WBSEC008,WBSEC008,SP70
            GOTO      SETPAR99
          ENDIF
.
.          MATCH     "ptvis067=",QRYNAME            * I SRF 22685
.          IF        @EQUAL
.            MOVE      QRYDATA,PTVIS067             * Populate CGI parameter
.            GOTO      SETPAR99                     * with diet comment
.          ENDIF
.                                                  * end I SRF 22685
          MATCH     "filtstat=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILTSTAT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtvtyp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILTVTYP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtvsta=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILTVSTA
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILTFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filthosp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILTHOSP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nmdsstat=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NMDSSTAT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "alrtfltr=",QRYNAME
          IF        @EQUAL
            MOVE       QRYDATA,ALRTFLTR
            GOTO       SETPAR99
          ENDIF
.
          MATCH     "startnum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTNUM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "norecord=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NORECORD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nextvkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTVKEY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prevvkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PREVVKEY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prevflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PREVFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH      "updtacno",QRYNAME
          IF         @EQUAL
            COMPARE   "50",TACCOUNT
            GOTO      SETPAR99 IF EQUAL
            ADD       ONE,TACCOUNT
            PACK      TACRECKY[TACCOUNT],QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH      "updwcono",QRYNAME
          IF         @EQUAL
            COMPARE   "99",WCOCOUNT
            GOTO      SETPAR99 IF EQUAL
            ADD       ONE,WCOCOUNT
            PACK      WCORECKY[WCOCOUNT],QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH      "updtrnno",QRYNAME
          IF         @EQUAL
            COMPARE   "99",TRNCOUNT
            GOTO      SETPAR99 IF EQUAL
            ADD       ONE,TRNCOUNT
            PACK      TRNRECKY[TRNCOUNT],QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
. *I-903005 ---- start
.
          MATCH     "freelabl=",QRYNAME
          IF        @EQUAL
            CALL      SETFRE00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "selprint=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,SELPRINT
            MATCH     "S",SELPRINT
            IF        !@EQUAL
              REPLACE   " 0",SELPRINT  * pass 01 to PR not  1
            ENDIF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "schdcopy=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,NOLABEL
            GOTO      SETPAR99
          ENDIF
.
. *I-903005 ---- end
.
          MATCH     "schdcop",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MATCH     "schdcop1",QRYNAME
            IF        @EQUAL
              MOVE      QRYDATA,SCHDCARR[1]
            ENDIF
.
            MATCH     "schdcop2",QRYNAME
            IF        @EQUAL
              MOVE      QRYDATA,SCHDCARR[2]
            ENDIF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "schform",QRYNAME
          IF        @EQUAL
            MATCH     "schform1",QRYNAME
            IF        @EQUAL
              PACK      STATNARR[1],QRYDATA,SP70
            ENDIF
.
            MATCH     "schform2",QRYNAME
            IF        @EQUAL
              PACK      STATNARR[2],QRYDATA,SP70
            ENDIF
            GOTO      SETPAR99
          ENDIF
.
          CALL       SPPRA000          * Set parameters for PRFA
.
          MATCH     "ptmmb",QRYNAME
          IF        @EQUAL
            CALL      STMMB000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtfdat=",QRYNAME
          IF        @EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00                *Set CMON from MTHNAM3
            PACK      FILTFDAT,CCENT,CYEAR,CMON,CDAY
          ENDIF
.
          MATCH     "filttdat=",QRYNAME
          IF        @EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00                *Set CMON from MTHNAM3
            PACK      FILTTDAT,CCENT,CYEAR,CMON,CDAY
          ENDIF
.
          MATCH     "superlev=",QRYNAME
          IF        @EQUAL
            PACK      SUPERLEV,QRYDATA,SP70
          ENDIF
.
          MATCH     "filtdept=",QRYNAME
          IF        @EQUAL
            PACK      FILTDEPT,QRYDATA,SP70
          ENDIF
.
          MATCH     "deftflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DEFTFLAG
          ENDIF
.
          MATCH     "pmext",QRYNAME
          IF        @EQUAL
            CALL      SPPME000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "requestk=",QRYNAME
          IF        @EQUAL
            PACK      REQUESTK,QRYDATA,SP70
          ENDIF
.
          MATCH     "prntform=",QRYNAME
          IF        @EQUAL
            PACK      PRNTFORM,QRYDATA,SP70
          ENDIF
.
          MATCH     "prtform",QRYNAME
          IF        @EQUAL
            MATCH     "prtform1",QRYNAME
            IF        @EQUAL
              PACK      PRTFOARR[1],QRYDATA,SP70
            ENDIF
.
            MATCH     "prtform2",QRYNAME
            IF        @EQUAL
              PACK      PRTFOARR[2],QRYDATA,SP70
            ENDIF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "schdprnt",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SCHDPRNT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "schdprt",QRYNAME
          IF        @EQUAL
            MATCH     "schdprt1",QRYNAME
            IF        @EQUAL
              PACK      SCHDPARR[1],QRYDATA,SP70
            ENDIF
.
            MATCH     "schdprt2",QRYNAME
            IF        @EQUAL
              PACK      SCHDPARR[2],QRYDATA,SP70
            ENDIF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "statncod=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STATNCOD
            PACK      STATNCOD,STATNCOD,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filthhos=",QRYNAME
          IF        @EQUAL
            PACK      FILTHHOS,QRYDATA,SP70
          ENDIF
.
          MATCH     "filthloc=",QRYNAME
          IF        @EQUAL
            PACK      FILTHLOC,QRYDATA,SP70
          ENDIF
.
          MATCH     "venquiry=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VENQUIRY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trnsupty=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRNSUPTY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trntowrd=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRNTOWRD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trntobed=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRNTOBED
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trntobty=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRNTOBTY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trntocty=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRNTOCTY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trntoclm=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRNTOCLM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trntofns=",QRYNAME
          IF        @EQUAL
            PACK      TRNTOFNS,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trntodoc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRNTODOC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trntount=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRNTOUNT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trntotem=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRNTOTEM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trntopat=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRNTOPAT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trntoreg=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRNTOREG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trntores=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRNTORES
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "chngreas=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CHNGREAS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "transkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRANSKEY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trntodat=",QRYNAME
          IF        @EQUAL
            MATCH     SP20,QRYDATA
            IF        !@EOS
              UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      TRNTODAT,CCENT,CYEAR,CMON,CDAY
              REP       " 0",TRNTODAT
            ENDIF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trntotim=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRNTOTIM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptasf003=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PTASF003
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmarq001=",QRYNAME
          IF        @EQUAL
            PACK      PMARQ001,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "clinical=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CLINICAL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nocanvis=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NOCANVIS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "wahealth",QRYNAME
          IF        @EQUAL
            MOVE      ZERO,F1
            PACK      KEY1,QRYDATA
            MOVE      KEY1,F1
            MOVE      F1,WAHEALTH
          ENDIF
.
          MATCH     "nonxtpat=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NONXTPAT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "showallh=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SHOWALLH
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "setdfprg=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SETDFPRG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "setdfrep=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SETDFREP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "leavflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LEAVFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fhirbund=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FHIRBUND
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fhrsubin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FHRSUBIN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fhrlocin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FHRLOCIN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fhrparin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FHRPARIN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fhrpatin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FHRPATIN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fhrrecin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FHRRECIN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fhrassin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FHRASSIN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmdaukey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PMDAUKEY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "cpmiskey",QRYNAME
          IF        @EQUAL
            PACK      CPMISKEY,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "remoteno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REMOTENO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdghcp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDGHCP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdward=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDWARD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdspec=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDSPEC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ltdsresn=",QRYNAME
          IF        @EQUAL
            PACK      LTDSRESN,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ltdscom1=",QRYNAME
          IF        @EQUAL
            PACK      LTDSCOM1,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ltdscom2=",QRYNAME
          IF        @EQUAL
            PACK      LTDSCOM2,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "noreturn=",QRYNAME
          IF        @EQUAL
            PACK      NORETURN,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptstatus=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PTSTATUS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "insbdtyp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,INSBDTYP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "inschdat=",QRYNAME
          IF        @EQUAL
            MATCH     SP70,QRYDATA
            IF        !@EOS
              UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      INSCHDAT,CCENT,CYEAR,CMON,CDAY
              REP       " 0",TRNTODAT
            ENDIF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "inschtim=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,INSCHTIM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "insmvtyp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,INSMVTYP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptatr",QRYNAME
          IF        @EQUAL
            CALL      SPTATR00
            GOTO      SETPAR99 IF EQUAL
          ENDIF         
.
SETPAR99  RETURN
+
.------------------------------------------------------------
.   Set Parameters for Medical Records MBS
.------------------------------------------------------------
STMMB000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,STMMB010,STMMB020,STMMB030,STMMB040,STMMB050:
                       STMMB060,STMMB070
.
          MOVE      ONE,EXIT
          GOTO      STMMB999

STMMB010  PACK      PTMMB001,QRYDATA,SP70
          GOTO      STMMB999
.
STMMB020  MOVE      QRYDATA,PTMMB002
          GOTO      STMMB999
.
STMMB030  MOVE      QRYDATA,PTMMB003
          GOTO      STMMB999
.
STMMB040  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                *Set CMON from MTHNAM3
          PACK      PTMMB004,CCENT,CYEAR,CMON,CDAY
          GOTO      STMMB999
.
STMMB050  PACK      PTMMB005,QRYDATA,SP70
          GOTO      STMMB999
.
STMMB060  PACK      PTMMB006,QRYDATA,SP70
          GOTO      STMMB999
.
STMMB070  PACK      PTMMB007,QRYDATA,SP70
          GOTO      STMMB999
.
STMMB999  RETURN
+
.------------------------------------------------------------
.  Set up Free format labels      *I-903005
.------------------------------------------------------------
SETFRE00  PREP      TEMP1,FNAMER
.
          COMPARE   ZERO,PTCNLNFF
          GOTO      SETFRE10 IF NOT EQUAL
          MOVE      FIVE,PTCNLNFF              * Default to five
.
SETFRE10  MOVE      THIRTY8,FORM2
          LOAD      FORM2,PTCNCHFF,THIRTY3
.
          MOVE      ZERO,READCNT
          OPEN      TEMP1,FNAMER
          WRITE     TEMP1,SEQ;QRYDATA
.
SETFRE20  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      SETFRE90 IF OVER
.
          MATCH     SP70,QRYNAME
          GOTO      SETFRE80 IF NOT EQUAL
.
          COMPARE   READCNT,PTCNLNFF
          GOTO      SETFRE80 IF EQUAL
.
          ADD       ONE,READCNT
          WRITE     TEMP1,SEQ;QRYDATA
          GOTO      SETFRE20
.
SETFRE80  MOVE      ONE,TEXTAREA
SETFRE90  MOVE      READCNT,LASTITEM
SETFRE99  RETURN
.------------------------------------------------------------
. Down Load Parameters
.------------------------------------------------------------
DOWNP000  UNPACK    QRYNAME,KEY6,KEY2
          MOVE      KEY2,F2
          SQUEEZE   QRYDATA
          BRANCH    F2,DOWNP010,DOWNP020,DOWNP030,DOWNP040,DOWNP050:
                       DOWNP060,DOWNP070,DOWNP080
          GOTO      DOWNP999
.
DOWNP010  MOVE      QRYDATA,DOWNLD01
          GOTO      DOWNP999
DOWNP020  MOVE      QRYDATA,DOWNLD02
          GOTO      DOWNP999
DOWNP030  MOVE      QRYDATA,DOWNLD03
          GOTO      DOWNP999
DOWNP040  MOVE      QRYDATA,DOWNLD04
          GOTO      DOWNP999
DOWNP050  MOVE      QRYDATA,DOWNLD05
          GOTO      DOWNP999
DOWNP060  MOVE      QRYDATA,DOWNLD06
          GOTO      DOWNP999
DOWNP070  MOVE      QRYDATA,DOWNLD07
          GOTO      DOWNP999
DOWNP080  MOVE      QRYDATA,DOWNLD08
          GOTO      DOWNP999
.
DOWNP999  RETURN
+
.------------------------------------------------------------
.   Set Parameters for Claim Details
.------------------------------------------------------------
SPCLM000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SPCLM010,SPCLM020,SPCLM030,SPCLM040,SPCLM050:
                       SPCLM060,SPCLM070,SPCLM080,SPCLM090,SPCLM100:    * 10
                       SPCLM110,SPCLM120,SPCLM130,SPCLM140,SPCLM150:
                       SPCLM160,SPCLM170,SPCLM180,SPCLM190,SPCLM200:    * 20
                       SPCLM210,SPCLM220,SPCLM230,SPCLM240,SPCLM250:
                       SPCLM260,SPCLM270,SPCLM280,SPCLM290,SPCLM300:    * 30
                       SPCLM310,SPCLM320,SPCLM330,SPCLM340,SPCLM350:
                       SPCLM360,SPCLM370,SPCLM380,SPCLM390,SPCLM400:    * 40
                       SPCLM410,SPCLM420,SPCLM430,SPCLM440,SPCLM450:
                       SPCLM999,SPCLM999,SPCLM999,SPCLM999,SPCLM999:    * 50
                       SPCLM999,SPCLM999,SPCLM999,SPCLM999,SPCLM999:
                       SPCLM999,SPCLM999,SPCLM999,SPCLM999,SPCLM999:    * 60
                       SPCLM999,SPCLM999,SPCLM999,SPCLM999,SPCLM999:
                       SPCLM999,SPCLM999,SPCLM999,SPCLM999,SPCLM999:    * 70
                       SPCLM999,SPCLM999,SPCLM999,SPCLM999,SPCLM999:
                       SPCLM999,SPCLM999,SPCLM999,SPCLM999,SPCLM999:    * 80
                       SPCLM999,SPCLM820,SPCLM830
.                      
          MOVE      ONE,EXIT
          GOTO      SPCLM999

SPCLM010  PACK      PTCLM001,QRYDATA,SP70
          GOTO      SPCLM900
SPCLM020  PACK      PTCLM002,QRYDATA,SP70
          GOTO      SPCLM900
SPCLM030  PACK      PTCLM003,QRYDATA,SP70
          GOTO      SPCLM900
SPCLM040  PACK      PTCLM004,QRYDATA,SP70
          GOTO      SPCLM900
SPCLM050  PACK      PTCLM005,QRYDATA,SP70
          GOTO      SPCLM900
SPCLM060  PACK      PTCLM006,QRYDATA,SP70
          GOTO      SPCLM900
SPCLM070  PACK      PTCLM007,QRYDATA,SP70
          GOTO      SPCLM900
SPCLM080  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                *Set CMON from MTHNAM3
          PACK      PTCLM008,CCENT,CYEAR,CMON,CDAY
          GOTO      SPCLM900
SPCLM090  PACK      PTCLM009,QRYDATA,SP70
          GOTO      SPCLM900
SPCLM100  PACK      PTCLM010,QRYDATA,SP70
          GOTO      SPCLM900
SPCLM110  PACK      PTCLM011,QRYDATA,SP70
          GOTO      SPCLM900
SPCLM120  PACK      PTCLM012,QRYDATA,SP70
          GOTO      SPCLM900
SPCLM130  PACK      PTCLM013,QRYDATA,SP70
          GOTO      SPCLM900
SPCLM140  PACK      PTCLM014,QRYDATA,SP70
          GOTO      SPCLM900
SPCLM150  PACK      PTCLM015,QRYDATA,SP70
          GOTO      SPCLM900
SPCLM160  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                *Set CMON from MTHNAM3
          PACK      PTCLM016,CCENT,CYEAR,CMON,CDAY
          GOTO      SPCLM900
SPCLM170  PACK      PTCLM017,QRYDATA,SP70
          GOTO      SPCLM900
SPCLM180  PACK      PTCLM018,QRYDATA,SP70
          GOTO      SPCLM900
SPCLM190  PACK      PTCLM019,QRYDATA,SP70
          GOTO      SPCLM900
SPCLM200  PACK      PTCLM020,QRYDATA,SP70
          GOTO      SPCLM900
SPCLM210  PACK      PTCLM021,QRYDATA,SP70
          GOTO      SPCLM900
SPCLM220  PACK      PTCLM022,QRYDATA,SP70
          GOTO      SPCLM900
SPCLM230  PACK      PTCLM023,QRYDATA,SP70
          GOTO      SPCLM900
SPCLM240  PACK      PTCLM024,QRYDATA,SP70
          GOTO      SPCLM900
SPCLM250  PACK      PTCLM025,QRYDATA,SP70
          GOTO      SPCLM900
SPCLM260  PACK      PTCLM026,QRYDATA,SP70
          GOTO      SPCLM900
SPCLM270  PACK      PTCLM027,QRYDATA,SP70
          GOTO      SPCLM900
SPCLM280  PACK      PTCLM028,QRYDATA,SP70
          GOTO      SPCLM900
SPCLM290  PACK      PTCLM029,QRYDATA,SP70
          GOTO      SPCLM900
SPCLM300  PACK      PTCLM030,QRYDATA,SP70
          GOTO      SPCLM900
SPCLM310  PACK      PTCLM031,QRYDATA,SP70
          GOTO      SPCLM900
SPCLM320  PACK      PTCLM032,QRYDATA,SP70
          GOTO      SPCLM900
SPCLM330  PACK      PTCLM033,QRYDATA,SP70
          GOTO      SPCLM900
SPCLM340  PACK      PTCLM034,QRYDATA,SP70
          GOTO      SPCLM900
SPCLM350  PACK      PTCLM035,QRYDATA,SP70
          GOTO      SPCLM900
SPCLM360  PACK      PTCLM036,QRYDATA,SP70
          GOTO      SPCLM900
SPCLM370  PACK      PTCLM037,QRYDATA,SP70
          GOTO      SPCLM900
SPCLM380  PACK      PTCLM038,QRYDATA,SP70
          GOTO      SPCLM900
SPCLM390  PACK      PTCLM039,QRYDATA,SP70
          GOTO      SPCLM900
SPCLM400  PACK      PTCLM040,QRYDATA,SP70
          GOTO      SPCLM900
SPCLM410  PACK      PTCLM041,QRYDATA,SP70
          GOTO      SPCLM900
SPCLM420  PACK      PTCLM042,QRYDATA,SP70
          GOTO      SPCLM900
SPCLM430  PACK      PTCLM043,QRYDATA,SP70
          GOTO      SPCLM900
SPCLM440  PACK      PTCLM044,QRYDATA,SP70
          GOTO      SPCLM900
SPCLM450  PACK      PTCLM045,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM820  PACK      PTCLM082,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM830  PACK      PTCLM083,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM900  MOVE      ONE,CLMUPDFL
SPCLM999  RETURN
+
.------------------------------------------------------------
. Previous Address File Parameters
.------------------------------------------------------------
PATPA000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,PATPA010,PATPA020,PATPA030
          GOTO      PATPA999
.
PATPA010  MOVE      QRYDATA,PATPA001
          GOTO      PATPA999
.
PATPA020  MOVE      QRYDATA,KEY11   * Change Date as format is (DD MON CCYY)
          PACK      KEY11,KEY11,SP70
          UNPACK    KEY11,KEY8,KEY3
          MATCH     SP70,KEY3
          IF        !@EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      PATPA002,CCENT,CYEAR,CMON,CDAY
            REP       " 0",PATPA002
          ELSE
            MOVE      QRYDATA,PATPA002
          ENDIF 
          GOTO      PATPA999
.
PATPA030  MOVE      QRYDATA,PATPA003
          GOTO      PATPA999
.
PATPA999  RETURN
.-------------------------------------------------------------------------------
. Previous HCP/Practice File Parameters
.-------------------------------------------------------------------------------
PMSDA000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,PMSDA010,PMSDA020,PMSDA030,PMSDA040
          GOTO      PMSDA999
.
PMSDA010  MOVE      QRYDATA,PMSDA001
          GOTO      PMSDA999
.
PMSDA020  MOVE      QRYDATA,KEY11   * Change Date as format is (DD MON CCYY)
          PACK      KEY11,KEY11,SP70
          UNPACK    KEY11,KEY8,KEY3
          MATCH     SP70,KEY3
          IF        !@EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      PMSDA002,CCENT,CYEAR,CMON,CDAY
            REP       " 0",PMSDA002
          ELSE
            MOVE      QRYDATA,PMSDA002
          ENDIF
          GOTO      PMSDA999
.
PMSDA030  MOVE      QRYDATA,PMSDA003
          GOTO      PMSDA999
.
PMSDA040  MOVE      QRYDATA,PMSDA004
          GOTO      PMSDA999
.
PMSDA999  RETURN
.------------------------------------------------------------
. Medical Record Coding       
.------------------------------------------------------------
MEDREC00  MATCH     SP70,UPDTTYPE
          GOTO      MEDREC30 IF EQUAL
.
          MATCH     "U",UPDTTYPE    * Validate UR Record 
          GOTO      MEDREC10 IF EQUAL
.
          GOTO      MEDREC90
.
.   ************* VALIDATE URNUMBER ************
.
MEDREC10  MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,MEDREC91
          MOVE      ZERO,EXIT
          GOTO      MEDREC99
.
MEDREC30  CLEAR     WEBTITLE
          MOVE      "Medical Record Coding",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,MEDREC99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      MEDREC99
.
MEDREC90  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEDREC99
.
MEDREC91  MOVE      "Can't find patient master details MedRec",WEBTITLE 
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEDREC99
.
MEDREC99  RETURN
.------------------------------------------------------------
. Output Patient Enquiry Page
.------------------------------------------------------------
GETPAT00  MOVE      ZERO,EXIT
          CALL      JSON0000
          BRANCH    EXIT,GETPAT99
          MATCH     SP70,INVADMNO
          IF        !@EQUAL
            CALL      OHVIS000
          ENDIF
.
GETPAT01  MOVE      ZERO,MASTFLAG
          MOVE      ZERO,MISSFLAG
          MOVE      ZERO,RESPFLAG
          MOVE      ZERO,DSCHFLAG
          MOVE      ZERO,PMVXFLAG
          MOVE      SP70,DOCTCODE
          CALL      IBACLOCK
          CALL      CLPATMAS
          CALL      CLPATMIS
          CALL      CLPATDSC
          CALL      CLPMSPX2
          CALL      CLPMSNUT
          CALL      CLRPDS00
          CALL      CLBOKRX1
          CALL      CLRICU00
          CALL      CLNZSP00
          CALL      CLPATHSP
          CALL      CLPMSVX1
          CALL      CLEMRVIS
          CALL      CLRPTQMH
.
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
          MATCH     "1",NOURSELC
          IF        @EQUAL
            GOTO      GETPAT20
          ENDIF
.
          MATCH     SP70,PATALTID
          IF        !@EQUAL
            CALL      GETALT00
            BRANCH    EXIT,GETPAT99
          ENDIF
.
          MATCH     SP70,PMSALTID
          IF        !@EQUAL
            CALL      GETAID00
            BRANCH    EXIT,GETPAT99
          ENDIF
.
          MATCH     "       0",URNUMBER
          IF        @EQUAL
            CALL      FINVIS00
            MOVE      EXIT,MASTFLAG
          ELSE
            MOVE      URNUMBER,KEY8
            CALL      RDMAST1
            MOVE      OVRCD,MASTFLAG
            MOVE      PURNO,KEY8
            CALL      RDPMPX21
            IF        OVRCD=1
              CALL      CLPMSPX2
            ENDIF
          ENDIF
.
          IF        PSTAT=1 | PSTAT=2
            MOVE      PURNO,SAVEURNO
            MOVE      PPSNAME,URNUMBER
            MOVE      ONE,MRGEFLAG
            GOTO      GETPAT00
          ENDIF
.
          IF        MASTFLAG=1
            MOVE      "Can't find patient master details",WEBTITLE
            CALL      WEBERR00
            GOTO      GETPAT99
          ENDIF
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDPMRES1
          IF        OVRCD=1
            CALL      CLPMSRES
          ENDIF
.
          MOVE      ADMISSNO,KEY8
          MATCH     SP70,KEY8
          IF        @EQUAL | @EOS
            MOVE      ONE,MISSFLAG
            MOVE      ONE,RESPFLAG
            MOVE      ONE,DSCHFLAG
            MOVE      ONE,PMVXFLAG
            COMPARE   FOUR,SRCHTYPE         * U/R passed in from pat search
            CALL      FNDCUR00 IF EQUAL     * Find Current Admissin details
            COMPARE   FIVE,SRCHTYPE         * U/R passed in from healthviews
            CALL      FNDCVS00 IF EQUAL     * Find Current Admissin details
          ELSE
            CALL      RDMISS1
            MOVE      OVRCD,MISSFLAG
            CALL      RDPTDAD1
            IF        OVRCD=1
              MOVE      SP70,PTDAADTS
              MOVE      SP70,PTDADCTS
            ENDIF
.
            CALL      RDPTVIS1
            IF        OVRCD=1
              CALL      CLPATVIS
            ENDIF
            CALL      GETNZP00
          ENDIF
.
          IF        REPORTNO=1 & MISSFLAG=1
            MATCH     "023",TEMPLATE          * ICD Coding Enquiry patweb9801023
            IF        @EQUAL
              MOVE      "Invalid admission record",WEBTITLE
              CALL      WEBERR00
              GOTO      GETPAT99
            ENDIF
          ENDIF
.
          MATCH     "035",TEMPLATE          * IP Supervisor Page
          IF        !@EQUAL|@LESS
            MATCH     "35",TEMPLATE
            IF        !@EQUAL|@LESS
              GOTO      GETPAT02
            ENDIF
          ENDIF
          COMPARE   ONE,MISSFLAG
          IF        @EQUAL
            MOVE      "Invalid admission record",WEBTITLE
            CALL      WEBERR00
            GOTO      GETPAT99
          ENDIF
.
....      COMPARE   ONE,ASTAT
....      IF        @EQUAL
....        MOVE      "Patient has not been admitted",WEBTITLE
....        CALL      WEBERR00
....        GOTO      GETPAT99
....      ENDIF
.
GETPAT02  MATCH     "070",TEMPLATE
          IF        @EQUAL
            MOVE      ADMISSNO,KEY8
            CALL      RDDETA1
            IF        OVRCD=1
              CALL      CLAAEDET
            ENDIF
.
            MOVE      ADMISSNO,KEY8
            CALL      RDDISA1
            IF        OVRCD=1
              CALL      CLAAEDIS
            ENDIF
          ENDIF
.
          MOVE      ADMISSNO,KEY8
          CALL      RDPMVX11
          IF        OVRCD=1
            IF        ARCFLAG=1
              MOVE      ADMISSNO,KEY8
              CALL      RDARVX11
              IF        OVRCD<>1
                CALL      MVPMAR00
              ENDIF
            ENDIF
          ENDIF
          MOVE      OVRCD,PMVXFLAG
          COMPARE   ONE,PMVXFLAG
          IF        !@EQUAL
            MATCH     SP70,PMVXMHOS
            IF        !@EQUAL
              PACK      KEY3,PMVXMHOS,SP70
              CALL      RDPTHSP1
              IF        OVRCD=1
                CALL      CLPATHSP
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      ADMISSNO,KEY8
          CALL      RDDSCH1
          MOVE      OVRCD,DSCHFLAG
          IF        OVRCD=0
            MOVE      DDATE,ICDRDDTE   * Needed for RDPTICD1 & RDPTICO1 reads
          ENDIF
.
          MOVE      ADMISSNO,KEY8
          CALL      RDRESP1
          MOVE      OVRCD,RESPFLAG
.
          MOVE      ADMISSNO,KEY8
          CALL      RDBKREC1
          MOVE      OVRCD,BRECFLAG
          IF        OVRCD=1
            CALL      CLBOKRC1
          ENDIF
.
          CALL      RDBKRX11
          IF        OVRCD=1
            CALL      CLBOKRX1
          ENDIF
.
          MOVE      SP70,PMEVEVNT
          MOVE      ADMISSNO,KEY8
          CALL      RDPMEVT1
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDEMVIS1
          IF        OVRCD=1
            CALL      CLEMRVIS
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPTQMH1
          IF        OVRCD=1
            CALL      CLRPTQMH
          ENDIF
.
GETPAT05  CALL      PATNAA00                * format name without bold tags
.
          MATCH     "034",TEMPLATE          * pre-adm from prev.detail option ?
          IF        @EQUAL
            IF        PCEASE=1
              MOVE      "Patient is Deceased",WEBTITLE
              CALL      WEBERR00
              GOTO      GETPAT99
            ENDIF
          ENDIF
.
.                                                 * read nutrition file
          PACK      KEY16,ADMISSNO,LASTDATE       * set key to read nutrition
          CALL      RDPMNUT1                      * if no rec found, vals blank
.                                                 * out already (CLPMSNUT)
.
          CALL      GETCCD00                      * get concession card details
.
          PACK      KEY8,ADMISSNO,SP70            * read pds file
          CALL      RDMRPDS1
.
          PACK      KEY8,ADMISSNO,SP70            * read icu file
          CALL      RDPTICU1
.
          MOVE      ADMISSNO,KEY8
          CALL      RDMHDSC1                      * read meh disch file
          IF        OVRCD=1
            CALL      CLMEHDIS
            CALL      CLMEHDIA
          ELSE
            CALL      MEHDIA00                    * get disch diag details
          ENDIF
.
          MOVE      SP70,PRIDISCD
          PACK      PDIADESC,SP70,SP70,SP70
          PACK      KEY13,ADMISSNO,SP70                               *C-240107
          CALL      RSPTECD1
          CALL      RKPTECD1
          BRANCH    OVRCD,GETPAT10
          MATCH     DPTEDADM,ADMISSNO
          GOTO      GETPAT10 IF NOT EQUAL
.
          MATCH     PTEDTYPE,CMDISP
          GOTO      GETPAT10 IF NOT EQUAL
.
          MATCH     "  1",DPTEDCNT                                    *C-240107
          GOTO      GETPAT10 IF NOT EQUAL
.
          MOVE      PTEDCODE,PRIDISCD
          MOVE      PTEDDESC,PDIADESC
.
GETPAT10  MOVE      SP70,PRIOPRCD
          PACK      POPRDESC,SP70,SP70,SP70
          PACK      KEY13,ADMISSNO,SP70                               *C-240107
          CALL      RSPTECO1
          CALL      RKPTECO1
          BRANCH    OVRCD,GETPAT20
          MATCH     DPTEOADM,ADMISSNO
          GOTO      GETPAT20 IF NOT EQUAL
.
          MATCH     "  1",DPTEOCNT                                     *C-240107
          GOTO      GETPAT20 IF NOT EQUAL
.
          MOVE      PTEOCODE,PRIOPRCD
          MOVE      PTEODESC,POPRDESC
.
.    Webtplaf must be read here to get correct description for WEBTITLE
.
GETPAT20  IF        PTCNNHII=1
            MATCH     "001",TEMPLATE
            IF        @EQUAL
              MOVE      "30",TMOTFRST
              MOVE      "30",TMOTFRST
            ENDIF
            MATCH     "1",TEMPLATE
            IF        @EQUAL
              MOVE      "30",TMOTFRST
              MOVE      "30",TMOTFRST
            ENDIF
          ENDIF
.
          CALL      GASF0000
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDIBALV1
          IF        OVRCD=1
            MOVE      SP70,IBAVVISN
            MOVE      SP70,IBAVAVIS
            MOVE      SP70,IBAVTYPE
          ENDIF
.
GETPAT30  MATCH     SP70,PMDAUKEY
          IF        !@EQUAL
            PACK      KEY27,PMDAUKEY,SP70
            CALL      RDPMDAU1
            IF        OVRCD=1
              CALL      CLPMSDAU
            ENDIF
          ENDIF
.
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
          RJUSTIFY  TEMPLATE
          REP       " 0",TEMPLATE
          PACK      KEY13,PRGID,KEY2,TEMPLATE,SP70
          CALL      RDWBTP1
          CLEAR     WEBTITLE
          APPEND    WBTPDES,WEBTITLE
          APPEND    PATFNAME,WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,GETPAT99
.
          MATCH     "1",NOURSELC
          IF        @EQUAL
            GOTO      GETPAT90
          ENDIF
GETPATXX  IF        PTCNNHII=1
            MOVE      URNUMBER,KEY8
            CALL      RDNHMAS2
            IF        OVRCD=1
              MOVE      "Missing nhimasaf record",WEBTITLE
              CALL      WEBERR00
              GOTO      GETPAT99
            ENDIF
          ENDIF
.
GETPAT90  IF        PTCNNHII=1
            MATCH     "1",NOURSELC
            IF        @EQUAL
              GOTO      GETPAT92
            ENDIF
            MOVE      URNUMBER,KEY8
            CALL      RDNHMAS2
            IF        OVRCD=1
              MOVE      "Missing nhimasaf record",WEBTITLE
              CALL      WEBERR00
              GOTO      GETPAT99
            ENDIF
            MATCH     "001",TEMPLATE
            IF        !@EQUAL
              MATCH     "1",TEMPLATE
              IF        !@EQUAL
                MATCH     "003",TEMPLATE
                IF        !@EQUAL
                  MATCH     "3",TEMPLATE
                  IF        !@EQUAL
                    GOTO      GETPAT92
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
            MOVE      URNUMBER,DIM20                                *I-131266
            SQUEEZE   DIM20
            UNPACK    DIM20,DIM1
            TYPE      DIM1
            GOTO      GETPAT92 IF EQUAL        * numeric prefix on URNUMBER
.
            SCAN      "T-",URNUMBER             * check if temporary number
            IF  !@EQUAL
              RESET     URNUMBER 
              CALL      CONNECT
              BRANCH    EXIT,GETPAT99
              MOVE      SP1,NZIBMWST      * prevent call to SETMED if we miss
              CALL      CHKHCU00
              MATCH     SP70,NZIBMWST
              IF        !@EQUAL
                PROC      SETMED00
              ELSE
                IF        NZHISWRN=2
                  PROC      SETMED00      * Read Ok warning Not Set
                ENDIF
              ENDIF
              CALL      DISCNNCT
              BRANCH    EXIT,GETPAT99
            ENDIF
            RESET     URNUMBER 
          ENDIF
.
GETPAT92  CALL      WEBBOD00   * Output Templated Body of HTML 
          IF        MRGEFLAG=1
            MATCH     JSONCALL,SP70
            IF        @EQUAL
              CALL      MRGALT00
            ENDIF
          ENDIF
          CALL      WEBEND00   * Output End of Web Page
.
.
GETPAT99  RETURN
+
.------------------------------------------------------------
. Check for JSON call errors      
. JSONCALL=1 Requires valid pmi only
. JSONCALL=2 Requires valid pmi and valid admission for that UR
.------------------------------------------------------------
JSON0000  MOVE      ZERO,EXIT
          MATCH     SP70,JSONCALL
          GOTO      JSON9999 IF EQUAL
.
          RJUSTIFY  URNUMBER
          REP       UPPLOW,URNUMBER
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,JSON9100
.
          MATCH     "2",JSONCALL
          GOTO      JSON9999 IF NOT EQUAL
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDVISA1
          BRANCH    OVRCD,JSON0500
.
          MATCH     URNUMBER,PVIURNO     * does ur match admission 
          GOTO      JSON9300 IF NOT EQUAL
.
          GOTO      JSON9999
.
JSON0500  PACK      CFNAME,OSTFILE,FILBOKA6
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      OUTBOKA6,CFNAME              * outbb1af opened ?
          TRAPCLR   IO
          BRANCH    OVRCD,JSON9200
.

.         Get the outbokaf record

          PACK      KEY36,ADMISSNO,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,JSON9200
.
          MATCH     OBAURNO,URNUMBER
          GOTO      JSON9300 IF NOT EQUAL
.
          GOTO      JSON9999
.
JSON9100  CALL      OPENHTML
          BRANCH    EXIT,JSON9800
          WRITE     HTMLFILE;"{ #"success#":#"false#", ":
                             "#"error_number#":#"4001#",":
                             "#"error_message#":#"Invalid NHI#"}"
          CALL      CLOSHTML
          MOVE      ONE,EXIT
          GOTO      JSON9999
.
JSON9200  CALL      OPENHTML
          BRANCH    EXIT,JSON9800
          WRITE     HTMLFILE;"{ #"success#":#"false#", ":
                             "#"error_number#":#"4002#",":
                             "#"error_message#":#"Invalid Visit Number#"}"
          CALL      CLOSHTML
          MOVE      ONE,EXIT
          GOTO      JSON9999
.
JSON9300  CALL      OPENHTML
          BRANCH    EXIT,JSON9800
          WRITE     HTMLFILE;"{ #"success#":#"false#", ":
                             "#"error_number#":#"4003#",":
                          "#"error_message#":#"Invalid NHI/Visit Combination#"}"
          CALL      CLOSHTML
          MOVE      ONE,EXIT
          GOTO      JSON9999
.
JSON9800  MOVE      ONE,EXIT
          GOTO      JSON9999
.
JSON9999  RETURN
+
.------------------------------------------------------------
. Get other hospital visit details
.------------------------------------------------------------
OHVIS000  OPEN      OUTPREA1,"outpreaf"
          PACK      KEY8,INVADMNO,SP70
          CALL      RDVISA1
          BRANCH    OVRCD,OHVIS100
          CALL      RDPMVX11
          BRANCH    OVRCD,OHVIS999
.
          PACK      KEY3,PMVXMHOS,SP70
          CALL      RDPTHSP1
          IF        OVRCD<>1
            PACK      VISDHOSP,PTHSNAME,SP70
          ENDIF
.
          PACK      INVVISTP,PTVITYPE,SP70
          IF        USEINVAD=1
            PACK      ADMISSNO,INVADMNO,SP70
          ENDIF
          GOTO      OHVIS999
.
OHVIS100  PACK      KEY8,INVADMNO,SP70
          CALL      RDBKREC1
          BRANCH    OVRCD,OHVIS200
          CALL      RDBKRX11
          BRANCH    OVRCD,OHVIS999
.
          PACK      KEY6,BKREWARD,SP70
          CALL      RDWARD1
          IF        OVRCD<>1
            PACK      KEY3,PTWDHOSN,SP70
            CALL      RDPTHSP1
            IF        OVRCD<>1
              PACK      VISDHOSP,PTHSNAME,SP70
            ENDIF
          ENDIF
.
          PACK      INVVISTP,SP1,SEVEN,SP70
          PACK      KEY5,ANSB,ANSK,BKRETYPE,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            MATCH     "THE",THCSCOD
            IF        @EQUAL
              PACK      INVVISTP,ONE,SEVEN,SP70
            ENDIF
          ENDIF
          MATCH     SP70,BKREPROC
          IF        !@EQUAL
            PACK      INVVISTP,ONE,EIGHT,SP70
            PACK      INVCASEK,BKREURNO,BKREPROC,DBKRECNT,SP70
          ENDIF
          IF        USEINVAD=1
            PACK      ADMISSNO,INVADMNO,SP70
          ENDIF
          GOTO      OHVIS999
.
OHVIS200  PACK      KEY8,INVADMNO,SP70
          CALL      RDPREA1
          BRANCH    OVRCD,OHVIS999
.
          PACK      INVVISTP,SP1,TWO,SP70
          IF        USEINVAD=1
            PACK      ADMISSNO,INVADMNO,SP70
          ENDIF
          GOTO      OHVIS999
.
OHVIS999  CLOSE     OUTPREA1
          RETURN
+
.------------------------------------------------------------
. Get Concession Card Details if they exist
.------------------------------------------------------------
GETCCD00  UNPACK    SP70,CCRDTYPE,CCRDNUMB,CCRDEXDT,DISPDVAC
          MOVE      SP70,CCIND1
          PACK      KEY19,URNUMBER,SP70
          CALL      RSPMCCD1
          CALL      RKPMCCD1
          BRANCH    OVRCD,GETCCD99
.
          MATCH     URNUMBER,PMCDURNO
          GOTO      GETCCD99 IF NOT EQUAL
.
          MOVE      PMCDCNUM,CCRDNUMB            * card number
.
          PACK      KEY5,CATct,PMCDCTYP,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            MOVE      TDESC,CCRDTYPE             * card type
            MOVE      TCINDC1,CCIND1 
          ENDIF
.
          MOVE      SP70,DISPDVAC
          MATCH     SP70,PMCDDVAC
          IF        !@EQUAL
            PACK      KEY5,ANSD,ANSX,PMCDDVAC,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MOVE      TDESC,DISPDVAC
            ENDIF
          ENDIF

          PACK      CCRDEXDT,PMCDEXDT,SP70       * card expiry date
.
GETCCD99  RETURN
.
.------------------------------------------------------------
. Table of first 5 concession cards 
.------------------------------------------------------------
CONT0000  MOVE      ZERO,F1
          PACK      KEY19,URNUMBER,SP70
          CALL      RSPMCCD1
CONT1000  CALL      RKPMCCD1
          BRANCH    OVRCD,CONT9999
.
          MATCH     URNUMBER,PMCDURNO
          GOTO      CONT9999 IF NOT EQUAL
.
          MOVE      SP70,DISPDVAC
          MATCH     SP70,PMCDDVAC
          IF        !@EQUAL
            PACK      KEY5,ANSD,ANSX,PMCDDVAC,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MOVE      TDESC,DISPDVAC
            ENDIF            
          ENDIF              
.          
          MOVE      SP70,TDESC
          MATCH     SP70,PMCDCTYP
          IF        !@EQUAL
            PACK      KEY5,CATct,PMCDCTYP,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      PMCDCTYP,TDESC
            ENDIF
          ENDIF
.
          PACK      DISPDATE,SP70
          MATCH     SP70,PMCDEXDT
          IF        !@EQUAL
            UNPACK    PMCDEXDT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td>":
                             TDESC,"</td>":
                             "<td>",PMCDCNUM,"</td>";
          WRITE     HTMLFILE;"<td>",DISPDVAC,"</td>";
          WRITE     HTMLFILE;"<td>",DISPDATE,"</td></tr>"
.
          ADD       ONE,F1
          COMPARE   FIVE,F1
          GOTO      CONT9999 IF EQUAL
.
          GOTO      CONT1000
.
CONT9999  RETURN
.------------------------------------------------------------
. Get Alternate ID
.------------------------------------------------------------
GETALT00  
          PACK      KEY30,PATALTID,SP70
          CALL      RSPTNID2
          CALL      RKPTNID2
          BRANCH    OVRCD,GETALT90          * no record on file
          MATCH     PATALTID,PTNINMPI
          GOTO      GETALT90 IF NOT EQUAL   * different National UR
          MOVE      PTNILNUM,URNUMBER
          MOVE      ZERO,EXIT
          GOTO      GETALT99
GETALT90  MOVE      "Can't find patient master details",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
GETALT99  RETURN
.
.------------------------------------------------------------
. Get Alternate ID from PMSAIDFD
.------------------------------------------------------------
GETAID00  COMPARE   ONE,PTCNUALT            * Using Alternate ID
          GOTO      GETAID99 IF NOT EQUAL
          OPEN      PMSAIDA2,"pmsaidaf"
.
          MATCH     SP70,URNUMBER           * Exit if there is a urnumber
          GOTO      GETAID99 IF NOT EQUAL
.
          PACK      KEY31,PMSALTID,SP70
          CALL      RSPMAID2
          CALL      RKPMAID2
          BRANCH    OVRCD,GETAID90          * no record on file
.
          MATCH     PMSALTID,PMAIALID
          GOTO      GETAID90 IF NOT EQUAL   * different alternate ID
.
          MOVE      PMAIURNO,URNUMBER
          MOVE      ZERO,EXIT
          GOTO      GETAID99
.
GETAID90  MOVE      "Can't find patient master details",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
GETAID99  CLOSE     PMSAIDA2
          RETURN
.------------------------------------------------------------
. Hospital Level Lists - ACC Xmit Status
.------------------------------------------------------------
HOSLST00  MOVE      ZERO,EXIT
.
HOSLST10  CLEAR     WEBTITLE
          MOVE      "ACC Transmission Status Update",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,HOSLST99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      HOSLST99
.
HOSLST99  RETURN
+
.------------------------------------------------------------
. Alert that this is a merged U/R
.------------------------------------------------------------
MRGALT00  MATCH     SP70,URNUMBER
          GOTO      MRGALT99 IF EQUAL
.
          MATCH     SP70,SAVEURNO
          GOTO      MRGALT99 IF EQUAL
.
          IF        FHIRTYPE=1
            GOTO      MRGALT99
          ENDIF
.
          MOVE      SAVEURNO,DISPSUR
          SQUEEZE   DISPSUR
          MOVE      URNUMBER,DISPMUR
          SQUEEZE   DISPMUR 
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             " alert('U/R Number ",DISPSUR," is merged with ":
                             DISPMUR," \n Using ",DISPMUR,"');":
                             "}":
                             "</script>"
          GOTO      MRGALT99
.
MRGALT99  RETURN
.------------------------------------------------------------
. Get Name from Visit Based Tables
.------------------------------------------------------------
FINVIS00  MOVE      ADMISSNO,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD,FINVIS80
.
          BRANCH    PVITYPE,FINVIS10,FINVIS20,FINVIS20
          MOVE      ONE,EXIT
          GOTO      FINVIS99
.
FINVIS10  BRANCH    EMRFLAG,FINVIS90
          MOVE      PVIBILL,KEY8
          CALL      RDEMUNK1
          BRANCH    OVRCD,FINVIS90
          MOVE      SP70,PTITL
          MOVE      EMUNSNAM,PSNAME
          MOVE      EMUNGNAM,PGNAME
          MOVE      EMUNBDAT,PBDATE
          MOVE      EMUNSEX,PSEX
          MOVE      EMUNAGE,PSAGE
          MATCH     SP70,PSNAME
          IF        @EQUAL
            MOVE     EMUNDET1,PSNAME
          ENDIF
          MATCH     SP70,PGNAME
          IF        @EQUAL
            MOVE     EMUNDET2,PGNAME
          ENDIF
          MOVE      ZERO,EXIT
          GOTO      FINVIS99
.
FINVIS20  MOVE      PVIBILL,KEY8
          CALL      RDPRAM1
          BRANCH    OVRCD,FINVIS90
          MOVE      ZERO,EXIT
          GOTO      FINVIS99
.
FINVIS30  MOVE      PVIBILL,KEY8
          CALL      RDPRAM1
          BRANCH    OVRCD,FINVIS90
          MOVE      ZERO,EXIT
          GOTO      FINVIS99
.
FINVIS80  MOVE      ADMISSNO,KEY8
          CALL      RDPRAM1
          BRANCH    OVRCD,FINVIS85
          MOVE      URNUMBER,PURNO
          MOVE      ZERO,EXIT
          GOTO      FINVIS99
.
FINVIS85  BRANCH    EMRFLAG,FINVIS90
          MOVE      ADMISSNO,KEY8
          CALL      RDEMUNK1
          BRANCH    OVRCD,FINVIS90
          MOVE      SP70,PTITL
          MOVE      EMUNSNAM,PSNAME
          MOVE      EMUNGNAM,PGNAME
          MOVE      EMUNBDAT,PBDATE
          MOVE      EMUNSEX,PSEX
          MOVE      EMUNAGE,PSAGE
          MATCH     SP70,PSNAME
          IF        @EQUAL
            MOVE     EMUNDET1,PSNAME
          ENDIF
          MATCH     SP70,PGNAME
          IF        @EQUAL
            MOVE     EMUNDET2,PGNAME
          ENDIF
          MOVE      ZERO,EXIT
          GOTO      FINVIS99
.
FINVIS90  MOVE      ONE,EXIT
.
FINVIS99  RETURN
.------------------------------------------------------------
. Previous Address Maintenance (Delete only used at the moment!)
.------------------------------------------------------------
PRVADD00  MATCH     SP70,UPDTTYPE
          GOTO      PRVADD30 IF EQUAL
.
          MATCH     "D",UPDTTYPE    * Delete Record 
          GOTO      PRVADD10 IF EQUAL
.
          GOTO      PRVADD90
.
.   ************* DELETE FORMACTION ************
.
PRVADD10  PACK      KEY24,PATPA001,PATPA002,PATPA003
          CALL      RDAPADD1
          BRANCH    OVRCD,PRVADD91
          PACK      KEY24,PATPA001,PATPA002,PATPA003
          CALL      DEPADD1               * Delete Record
. 
          MOVE      ZERO,EXIT
          GOTO      PRVADD99
.
PRVADD30  PACK      KEY24,PATPA001,PATPA002,PATPA003
          CALL      RDPADD1
          IF        OVRCD=1         
            CALL      CLRADD00     * Clear Previous Address Variables
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Previous Address Details",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,PRVADD99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      PRVADD99
.
PRVADD90  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRVADD99
.
PRVADD91  MOVE      "Can't find Previous Address Details!",WEBTITLE 
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRVADD99
.
PRVADD99  RETURN
.------------------------------------------------------------
. Clear Previous Address Data            
.------------------------------------------------------------
CLRADD00  MOVE      SP70,PAURNO     * Patient U/R Number
          MOVE      SP70,PADATE     * Date this add was changed (CCYYMMDD)
          MOVE      SP70,PAADD1     * Previous Address Line 1
          MOVE      SP70,PAADD2     * Previous Address Line 2
          MOVE      SP70,PASUBR     * Previous Suburb
          MOVE      SP70,PAADD4     * Previous Address Line 4
          MOVE      SP70,PAPOST     * Previous Postcode
          MOVE      SP70,PATELEP    * Previous Private Telephone
          MOVE      SP70,PATELEB    * Previous Business Telephone
          MOVE      SP70,PTPADOR    * District of Residence
          MOVE      SP70,PTPAMOBL   * Previous Mobile Phone Number
          PACK      PTPAEMAL,SP70,SP70 * Email Address
          MOVE      SP70,PTPACDTE   * Date Record Created (ccyymmdd)
          MOVE      SP70,PTPACTIM   * Time Record Created (hh:mm:ss)
          MOVE      SP70,PTPAWEBC   * WEB User Id Creator (websecaf)
          MOVE      SP70,PTPALUPD   * Date Record Last Updated (ccyymmdd)
          MOVE      SP70,PTPALUPT   * Time Record Last Updated (hh:mm:ss)
          MOVE      SP70,PTPAWEBU   * Web User ID
          MOVE      SP70,PTPAOSMS
          MOVE      SP70,PTPASPAR   * Spare Variable
.
CLRADD99  RETURN
.-------------------------------------------------------------------------------
. Previous HCP Maintenance (Delete only)
.-------------------------------------------------------------------------------
PRVHCP00  MATCH     SP70,UPDTTYPE
          GOTO      PRVHCP30 IF EQUAL
.
          MATCH     "D",UPDTTYPE            * Delete Record Record Request
          GOTO      PRVHCP10 IF EQUAL
.
          GOTO      PRVHCP90
.
.   ************* DELETE FORMACTION ************
.
PRVHCP10  PACK      KEY27,PMSDA001,PMSDA002,PMSDA003,PMSDA004
          CALL      RDPMDAU1
          BRANCH    OVRCD,PRVHCP91
.         
          PACK      KEY27,PMSDA001,PMSDA002,PMSDA003,PMSDA004
          CALL      DEPMDAU1                * Delete Record
.
          MOVE      ZERO,EXIT
          GOTO      PRVHCP99
.
PRVHCP30  PACK      KEY27,PMSDA001,PMSDA002,PMSDA003,PMSDA004
          CALL      RDPMDAU1
          IF        OVRCD=1
            CALL      CLRHCP00              * Clear Previous Address Variables
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Previous Address Details",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,PRVHCP99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      PRVHCP99
.
PRVHCP90  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRVHCP99
.
PRVHCP91  MOVE      "Can't find Previous HCP Details!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRVHCP99
.
PRVHCP99  RETURN
.------------------------------------------------------------
. Clear Previous Address Data
.------------------------------------------------------------
CLRHCP00  PACK      PMDEURNO,SP10                * U/R Number
          PACK      PMDECDAT,SP10                * Date Created
          PACK      PMDECTIM,SP10                * Time Created
          PACK      PMDERTYP,SP10                * Type of Record
          PACK      PMDEFL01,SP70,SP70           * Field 1
          PACK      PMDEFL02,SP70,SP70           * Field 2
          PACK      PMDEFL03,SP70,SP70           * Field 3
          PACK      PMDEFL04,SP70,SP70           * Field 4
          PACK      PMDEFL05,SP70,SP70           * Field 5
          PACK      PMDEFL06,SP70,SP70           * Field 6
          PACK      PMDEFL07,SP70,SP70           * Field 7
          PACK      PMDEFL08,SP70,SP70           * Field 8
          PACK      PMDEFL09,SP70,SP70           * Field 9
          PACK      PMDEFL10,SP70,SP70           * Field 10
          PACK      PMDECUID,SP10                * User ID Created
          PACK      PMDESPAR,SP70,SP70,SP70      * Spare variable
.
CLRHCP99  RETURN
+
.------------------------------------------------------------
.  Update Claim variable's
.------------------------------------------------------------
UPCLV000  COMPARE   ONE,CLMUPDFL
          GOTO      UPCLV999 IF NOT EQUAL
.
          MATCH     Z70,PTCLM001
          IF        !@EQUAL
            MOVE      PTCLM001,WCENAME
          ENDIF
.
          MATCH     Z70,PTCLM002
          IF        !@EQUAL
            MOVE      PTCLM002,WCEADD1
          ENDIF
.
          MATCH     Z70,PTCLM003
          IF        !@EQUAL
            MOVE      PTCLM003,WCEADD2
          ENDIF
.
          MATCH     Z70,PTCLM004
          IF        !@EQUAL
            MOVE      PTCLM004,WCEADD3
          ENDIF
.
          MATCH     Z70,PTCLM005
          IF        !@EQUAL
            MOVE      PTCLM005,WCEADD4
          ENDIF
.
          MATCH     Z70,PTCLM006
          IF        !@EQUAL
            MOVE      PTCLM006,WCEPOST
          ENDIF
.
          MATCH     Z70,PTCLM007
          IF        !@EQUAL
            MOVE      PTCLM007,WCETELE
          ENDIF
.
          MATCH     Z70,PTCLM008
          IF        !@EQUAL
            MOVE      PTCLM008,WCACDAT
          ENDIF
.
          MATCH     Z70,PTCLM009
          IF        !@EQUAL
            MOVE      PTCLM009,WCACCPT
          ENDIF
.
          MATCH     Z70,PTCLM010
          IF        !@EQUAL
            MOVE      PTCLM010,WCICODE
          ENDIF
.
          MATCH     Z70,PTCLM011
          IF        !@EQUAL
            MOVE      PTCLM011,WCCLMNO
          ENDIF
.
          MATCH     Z70,PTCLM012
          IF        !@EQUAL
            MOVE      PTCLM012,WCCOMN1
          ENDIF
.
          MATCH     Z70,PTCLM013
          IF        !@EQUAL
            MOVE      PTCLM013,WCCOMN2
          ENDIF
.
          MATCH     Z70,PTCLM014
          IF        !@EQUAL
            MOVE      PTCLM014,VCLMNO
          ENDIF
.
          MATCH     Z70,PTCLM015
          IF        !@EQUAL
            MOVE      PTCLM015,MREFNO
          ENDIF
.
          MATCH     Z70,PTCLM016
          IF        !@EQUAL
            MOVE      PTCLM016,MACDAT
          ENDIF
.
          MATCH     Z70,PTCLM017
          IF        !@EQUAL
            MOVE      PTCLM017,MPOLIC
          ENDIF
.
          MATCH     Z70,PTCLM018
          IF        !@EQUAL
            MOVE      PTCLM018,MCREGO
          ENDIF
.
          MATCH     Z70,PTCLM019
          IF        !@EQUAL
            MOVE      PTCLM019,MOTHDET1
          ENDIF
.
          MATCH     Z70,PTCLM020
          IF        !@EQUAL
            MOVE      PTCLM020,MOTHDET2
          ENDIF
.
          MATCH     Z70,PTCLM021
          IF        !@EQUAL
            MOVE      PTCLM021,MOTHDET3
          ENDIF
.
          MATCH     Z70,PTCLM022
          IF        !@EQUAL
            MOVE      PTCLM022,MMDTRANS
          ENDIF
.
          MATCH     Z70,PTCLM023
          IF        !@EQUAL
            MOVE      PTCLM023,MDPINDIC
          ENDIF
.
          MATCH     Z70,PTCLM024
          IF        !@EQUAL
            MOVE      PTCLM024,MENGAGED
          ENDIF
.
          MATCH     Z70,PTCLM025
          IF        !@EQUAL
            MOVE      PTCLM025,MPINJURE
          ENDIF
.
          MATCH     Z70,PTCLM026
          IF        !@EQUAL
            MOVE      PTCLM026,MMECHSEV
          ENDIF
.
          MATCH     Z70,PTCLM027
          IF        !@EQUAL
            MOVE      PTCLM027,MREGNSEV
          ENDIF
.
          MATCH     Z70,PTCLM028
          IF        !@EQUAL
            MOVE      PTCLM028,MSNAME
          ENDIF
.
          MATCH     Z70,PTCLM029
          IF        !@EQUAL
            MOVE      PTCLM029,MSTELE
          ENDIF
.
          MATCH     Z70,PTCLM030
          IF        !@EQUAL
            MOVE      PTCLM030,MACLOC
          ENDIF
.
          MATCH     Z70,PTCLM031
          IF        !@EQUAL
            MOVE      PTCLM031,PTWMTACF
          ELSE
            MOVE      ZERO,PTWMTACF
          ENDIF
.
          MATCH     Z70,PTCLM032
          IF        !@EQUAL
            MOVE      PTCLM032,PTWMTYPE
          ENDIF
.
          MATCH     Z70,URNUMBER
          IF        !@EQUAL
            MOVE      URNUMBER,PTWMURNO
          ENDIF   
.
          MATCH     Z70,PTCLM033
          IF        !@EQUAL
            MOVE      PTCLM033,PMWXALOC
          ENDIF
.
          MATCH     Z70,PTCLM034
          IF        !@EQUAL
            MOVE      PTCLM034,PMWXCINJ
          ENDIF
.
          MATCH     Z70,PTCLM035
          IF        !@EQUAL
            MOVE      PTCLM035,PMWXICOD
          ENDIF
.
          MATCH     Z70,PTCLM036
          IF        !@EQUAL
            MOVE      PTCLM036,PMWXCNAM
          ENDIF
.
          MATCH     Z70,PTCLM082
          IF        !@EQUAL
            MOVE      PTCLM082,PTWMICDE
          ENDIF
.
          MATCH     Z70,PTCLM083
          IF        !@EQUAL
            MOVE      PTCLM083,PMWXECOD            * employer code
          ENDIF
.
. Move the remaining fields of Extension file
          MOVE      ADMISSNO,PMWXVISN              * Visit No.
          MOVE      PMWXCDTE,PMWXLUPD              * Last Updated Date
          MOVE      PMWXCTIM,PMWXLUPT              * Last Updated Time 
          MOVE      PMWXWEBC,PMWXWEBU              * Last Updated WebID
          CALL      IBACLOCK
          PACK      PMWXCDTE,CCC,CYY,CMM,CDD       * Current Date
          REP       " 0",PMWXCDTE
          MOVE      CTIMEIS,PMWXCTIM               * Current Time
          MOVE      USERID,PMWXWEBC                * Current WebID
.
          MATCH     Z70,PTCLM037
          IF        !@EQUAL
            MOVE      PTCLM037,PMCTSNAM
          ENDIF
.
          MATCH     Z70,PTCLM038
          IF        !@EQUAL
            MOVE      PTCLM038,PMCTSAD1
          ENDIF
.
          MATCH     Z70,PTCLM039
          IF        !@EQUAL
            MOVE      PTCLM039,PMCTSAD2
          ENDIF
.
          MATCH     Z70,PTCLM040
          IF        !@EQUAL
            MOVE      PTCLM040,PMCTSAD3
          ENDIF
.
          MATCH     Z70,PTCLM041
          IF        !@EQUAL
            MOVE      PTCLM041,PMCTSAD4
          ENDIF
.
          MATCH     Z70,PTCLM042
          IF        !@EQUAL
            MOVE      PTCLM042,PMCTSPCO
          ENDIF
.
          MATCH     Z70,PTCLM043
          IF        !@EQUAL
            MOVE      PTCLM043,PMCTSPHN
          ENDIF
.
          MATCH     Z70,PTCLM044
          IF        !@EQUAL
            MOVE      PTCLM044,PMCTCONT
          ENDIF
.
          MATCH     Z70,PTCLM045
          IF        !@EQUAL
            MOVE      PTCLM045,PMCTREFN
          ENDIF
.
UPCLV999  RETURN
+
.------------------------------------------------------------
. Update TAC/WC details with same TAC/WC claim number 
.------------------------------------------------------------
UPDCLM00  MOVE      ZERO,WCOMFLAG
          BRANCH    UPDATETY,UPDCLM02,UPDCLM80,UPDCLM82
.
UPDCLM02  MOVE      ONE,WARNFLAG
          MATCH     "D",CLAIMTYP          * Defence Force for Private Hosp.
          GOTO      UPDCLM05 IF EQUAL
.
          MATCH     "1",PTCNXCOM
          GOTO      UPDCLM04 IF NOT EQUAL * Not Using Extra Compensable table
.
.         The following claim details are from Extra Compensable table
.
          MATCH     "A",CLAIMTYP          * Australian Defence Force
          GOTO      UPDCLM05 IF EQUAL
          MATCH     "O",CLAIMTYP          * Other Compensable
          GOTO      UPDCLM05 IF EQUAL
          MATCH     "F",CLAIMTYP          * Foreign Defence
          GOTO      UPDCLM05 IF EQUAL
          MATCH     "H",CLAIMTYP          * Private
          GOTO      UPDCLM05 IF EQUAL
          MATCH     "S",CLAIMTYP          * Shipping
          GOTO      UPDCLM05 IF EQUAL
          MATCH     "X",CLAIMTYP          * WA - Motor Vehicle
          GOTO      UPDCLM05 IF EQUAL
          MATCH     "Y",CLAIMTYP          * WA - Veterans Affairs
          GOTO      UPDCLM05 IF EQUAL
          MATCH     "Z",CLAIMTYP          * WA - Workers Comp.
          GOTO      UPDCLM05 IF EQUAL
.
          GOTO      UPDCLM99
.
UPDCLM04  MATCH     "T",CLAIMTYP
          GOTO      UPDCLM30 IF EQUAL     * Bulk Modify TAC Claim Number
.
          MATCH     "C",CLAIMTYP
          GOTO      UPDCLM50 IF EQUAL     * Bulk Modify WC Insurance Claim No
.
          MATCH     "W",CLAIMTYP
          GOTO      UPDCLM20 IF EQUAL
.
          MATCH     "M",CLAIMTYP
          GOTO      UPDCLM10 IF EQUAL
.
          MATCH     "V",CLAIMTYP
          GOTO      UPDCLM70 IF EQUAL
.
          MATCH     "I",CLAIMTYP          * Update Civil Tort
          GOTO      UPDCLM75 IF EQUAL
.
          GOTO      UPDCLM99
.
.         Defence Force/Australian Defence Force
.
UPDCLM05  PACK      KEY11,PMEXT001,PMEXT002,SP70
          CALL      RDPMEXT1
          IF        OVRCD=1
            CALL      CLPMSEXT
          ENDIF
          CALL      MVPMEX00
          MATCH     SP70,PMEXCAD1
          IF        @EQUAL
            MOVE      SP70,PMEXCAD2
            MOVE      SP70,PMEXCAD3
            MOVE      SP70,PMEXCAD4
            MOVE      SP70,PMEXCPCD
            MOVE      SP70,PMEXCNAM
            MOVE      SP70,PMEXCPHN
          ENDIF
.
          IF        OVRCD=0
            PACK      PMEXUDAT,CCC,CYY,CMM,CDD
            REP       " 0",PMEXUDAT
            CLOCK     TIME,PMEXUTIM
            MOVE      USERID,PMEXUUID
            CALL      UPPMEXT1
.
            MATCH     "3",PMEXT055
            IF        @EQUAL
              CALL      UPCLTY00 * if ICWA Status Confirmed update Claim Type
            ENDIF
          ELSE
            PACK      PMEXCDAT,CCC,CYY,CMM,CDD
            REP       " 0",PMEXCDAT
            CLOCK     TIME,PMEXCTIM
            MOVE      USERID,PMEXCUID
            CALL      WRPMEXT1
.
            MATCH     "3",PMEXT055
            IF        @EQUAL
              PACK      KEY11,PMEXT001,PMEXT002,SP70
              CALL      RDPMEXT1
              CALL      UPCLTY00   * if ICWA Status Confirmed update Claim Type
            ENDIF
          ENDIF
.
          MATCH     "H",CLAIMTYP
          IF        @EQUAL
            CALL      STAD0000                * Setup admission fields
          ENDIF
.
          MATCH     "D",CLAIMTYP          * Defence Force
          GOTO      UPDCLM82 IF EQUAL
.
.         Check if we are printing Election Form 
.
          MOVE      ZERO,COUNTER
UPDCLM06  ADD       ONE,COUNTER
          COMPARE   THREE,COUNTER
          GOTO      UPDCLM82 IF EQUAL
.
          MATCH     "1",PRTFOARR[COUNTER]
          IF        !@EQUAL
            MATCH     "1",PRNTFORM
            GOTO      UPDCLM06 IF NOT EQUAL
.
            CALL      ADDPRN00              * print form
            MOVE      "ELECTFRM",SETDFPRG
            CALL      UPDEFP00              * Update Default Printer
            GOTO      UPDCLM82
          ENDIF
.
          MOVE      SCHDPARR[COUNTER],SCHDPRNT
          MOVE      SCHDCARR[COUNTER],SCHDCOPY
          MOVE      STATNARR[COUNTER],STATNCOD
          CALL      ADDPRN00              * print form
.
          MOVE      "ELECTFRM",SETDFPRG
          CALL      UPDEFP00
.
          GOTO      UPDCLM06
.
.         Motor Accident
.
UPDCLM10  MOVE      ZERO,ERRORCNT
          PACK      KEY44,PTCLM015,URNUMBER,SP70
          CALL      RDSWMAB3
UPDCLM12  CALL      RDKWMAB3
          BRANCH    OVRCD,UPDCLM60
          MATCH     PTCLM015,MREFNO
          GOTO      UPDCLM60 IF NOT EQUAL
          MATCH     PTWMURNO,URNUMBER
          GOTO      UPDCLM60 IF NOT EQUAL
.
          CALL      UPCLV000
.
.... C CAR 55923
.... For NSW, there is no format requirement for TAC(MREFNO) number. Therefore,
.... no need to do the following checking on TAC number.
          IF        PTCNHDPS=3
            CALL      CLAIMN00
            BRANCH    ERRFLAG,UPDCLM93,UPDCLM93
.
            COMPARE   ZERO,ERRORCNT
            GOTO      UPDCLM14 IF NOT EQUAL     * only display first time
            IF        ERRFLAG=3
              CLEAR     WEBTITLE
              APPEND    "Warning: Accident Date is more than 3 years ",WEBTITLE
              APPEND    "before the Claim date.",WEBTITLE
              APPEND    SP70,WEBTITLE
              RESET     WEBTITLE
              ADD       ONE,ERRORCNT
              MOVE      WEBTITLE,ERRORLST[ERRORCNT]
            ENDIF
          ENDIF
.
UPDCLM14  CALL      UPWMAB3
.
.         Check if we need to write a patpeiaf record for TAC changes
.
          READ      CONTROLF,EIGHTY;*250,PTCNHDPS
.
          MOVE      MADMNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,UPDCLM12          * no adm record
.
          COMPARE   THREE,ASTAT
          GOTO      UPDCLM12 IF NOT EQUAL   * not discharged
.
          MOVE      MADMNO,KEY8
          CALL      RDDSCH1                 * need disch.date
          BRANCH    OVRCD,UPDCLM12
.
          MOVE      "13",HDPEQUIV
          CALL      WPEI0000                * Write patpeiaf record
.
          GOTO      UPDCLM12
.
.         Workers Comp.
.
UPDCLM20  CALL      CLPMSWX1
          ENDSET    PTCLM011
          APPEND    SP70,PTCLM011
          RESET     PTCLM011
          PACK      KEY44,PTCLM011,URNUMBER,SP70
          CALL      RDSWCOM3
UPDCLM22  CALL      RDKWCOM3
          BRANCH    OVRCD,UPDCLM24
          MATCH     PTCLM011,WCCLMNO
          GOTO      UPDCLM24 IF NOT EQUAL
          MATCH     PTWCURNO,URNUMBER
          GOTO      UPDCLM26 IF EQUAL
.
.         No details for the claim details
.
UPDCLM24  BRANCH    WCOMFLAG,UPDCLM99
.
          CALL      CLPATWC1                 * clear variables
          CALL      UPCLV000
          MOVE      ADMISSNO,WCADMNO
          MOVE      URNUMBER,PTWCURNO
          MOVE      ADMISSNO,KEY8
          CALL      RDVISA1
          IF        OVRCD=0
            MOVE      PVIDATE,PTWCVDAT
          ELSE
            MOVE      SP70,PTWCVDAT
            PACK      KEY36,ADMISSNO,SP20,SP20
            CALL      RDSBOKA6
            CALL      RDKBOKA6
            IF        OVRCD=0
              MATCH     ADMISSNO,DOBAOUTN
              IF        @EQUAL
                MOVE      OBADATE,PTWCVDAT
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      ADMISSNO,KEY8
          CALL      RDAWCOM1
          IF        OVRCD=1
            CALL      WRWCOM1
          ENDIF
          GOTO      UPDCLM28
.
.
UPDCLM26  CALL      UPCLV000
          CALL      UPWCOM3
.
UPDCLM28  MOVE      ONE,WCOMFLAG
          MOVE      WCADMNO,PMWXVISN              * Visit No.
          MOVE      WCADMNO,KEY8
          CALL      RAPMWX11                       * extension file
          IF        OVRCD=0
            CALL      UPPMWX11
          ELSE
            CALL      WRPMWX11
          ENDIF
.
          MOVE      ADMISSNO,SAVADMNO
          MOVE      WCADMNO,ADMISSNO
          CALL      FPRA0000
          MOVE      SAVADMNO,ADMISSNO
.
.         If we are sending ACC details in PV1-20, then we need to
.         trigger an A08 message for the visit to reflect that the
.         ACC number has changed.
.
          MATCH     "1",PTCNH7AC
          IF        @EQUAL
            CALL      TACC0000                   * send HL7 message
          ENDIF
          GOTO      UPDCLM22
.
. Bulk update TAC claim number
.
UPDCLM30  MATCH     Z70,PTCLM015
          GOTO      UPDCLM99 IF EQUAL
.
.         Check if it's using existing claim number.
.         If it is, then the detail of existing claim no will be copied,
.         if it is a new claim number, then just update the claim/ref no.
.
          MOVE      ZERO,FORM8                * flag for new claim no.
          CALL      CLRMAB00                  * Clear MAB save variables
          PACK      KEY44,PTCLM015,URNUMBER,SP70
          CALL      RDSWMAB3
          CALL      RDKWMAB3
          BRANCH    OVRCD,UPDCLM35
          MATCH     PTCLM015,MREFNO
          GOTO      UPDCLM35 IF NOT EQUAL
          MATCH     PTWMURNO,URNUMBER
          GOTO      UPDCLM35 IF NOT EQUAL
          CALL      SAVMAB00                  * Save the selected claim details
          MOVE      ONE,FORM8
.
UPDCLM35  MOVE      ONE,TACCOUNT
          MOVE      ZERO,ERRORCNT
UPDCLM40  MATCH     SP70,TACRECKY[TACCOUNT]    * Any more records in to update
          GOTO      UPDCLM60 IF EQUAL
.
          PACK      KEY8,TACRECKY[TACCOUNT],SP70
          CALL      RDWMAB1
          IF        OVRCD=1
            ADD       ONE,TACCOUNT
            GOTO      UPDCLM40
          ENDIF
.
          MATCH     Z70,PTCLM015            * update detail of TAC Claim number
          IF        !@EQUAL
            MOVE      PTCLM015,MREFNO
            IF        FORM8=1
              CALL      COPMAB00            * Copy fields from saved variables
            ENDIF
          ENDIF
.
.... C CAR 55923
.... For NSW, there is no format requirement for TAC(MREFNO) number. Therefore,
.... no need to do the following checking on TAC number.
          IF        PTCNHDPS=3
            CALL      CLAIMN00                  * check claim no
            COMPARE   ZERO,ERRFLAG
            GOTO      UPDCLM45 IF EQUAL
.
            ADD       ONE,ERRORCNT
            IF        ERRORCNT >50
              ADD       ONE,TACCOUNT
              GOTO      UPDCLM40
            ENDIF
.
            CLEAR     WEBTITLE
            IF        ERRFLAG=1 
              APPEND    "Claim number must be 7 digits.",WEBTITLE
              APPEND    "- admission - ",WEBTITLE
              APPEND    DMADMNO,WEBTITLE
              APPEND    SP70,WEBTITLE
              RESET     WEBTITLE
              MOVE      WEBTITLE,ERRORLST[ERRORCNT]
              CALL      WEBERR00
              MOVE      ONE,EXIT
              GOTO      UPDCLM99
            ELSE
              IF        ERRFLAG=2
                APPEND    "Date of Accident must not be ",WEBTITLE
                APPEND    "more than 20",WEBTITLE
                APPEND    " years before the Claim Date.",WEBTITLE
                APPEND    DMADMNO,WEBTITLE
                APPEND    SP70,WEBTITLE
                RESET     WEBTITLE
                ADD       ONE,TACCOUNT
                MOVE      WEBTITLE,ERRORLST[ERRORCNT]
                CALL      WEBERR00
                MOVE      ONE,EXIT
                GOTO      UPDCLM99
              ELSE
                CLEAR     WEBTITLE
                APPEND    "Warning: Accident Date is ",WEBTITLE
                APPEND    "more than 3 years ",WEBTITLE
                APPEND    "before the Claim date.",WEBTITLE
                APPEND    DMADMNO,WEBTITLE
                APPEND    SP70,WEBTITLE
                RESET     WEBTITLE
                MOVE      WEBTITLE,ERRORLST[ERRORCNT]
              ENDIF
            ENDIF
          ENDIF
.
UPDCLM45  CALL      UPWMAB1
          ADD       ONE,TACCOUNT
.
.         Check if we need to write a patpeiaf record for TAC changes
.
          READ      CONTROLF,EIGHTY;*250,PTCNHDPS
.
          MOVE      MADMNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,UPDCLM40          * no adm record
.
          COMPARE   THREE,ASTAT
          GOTO      UPDCLM40 IF NOT EQUAL   * not discharged
.
          MOVE      MADMNO,KEY8
          CALL      RDDSCH1                 * need disch.date
          BRANCH    OVRCD,UPDCLM40
.
          MOVE      "13",HDPEQUIV
          CALL      WPEI0000                * Write patpeiaf record
.
          GOTO      UPDCLM40
.
. Bulk update WC Insurance claim number
.
UPDCLM50  MATCH     Z70,PTCLM011            * Only update WC Claim number
          GOTO      UPDCLM99 IF EQUAL
.
.                                           * check ACC No. not used by other UR
          PACK      KEY44,PTCLM011,SP70
          CALL      RDSWCOM3
UPDCLM51  CALL      RDKWCOM3
          BRANCH    OVRCD,UPDCLM52
          MATCH     PTCLM011,WCCLMNO
          GOTO      UPDCLM52 IF NOT EQUAL
          MATCH     PTWCURNO,URNUMBER
          GOTO      UPDCLM51 IF EQUAL
.
          CLEAR     WEBTITLE                * issue "in use" error message
          STRIP     PTCLM011
          APPEND    "ACC No. ",WEBTITLE
          APPEND    PTCLM011,WEBTITLE
          APPEND    " is in use for UR No. ",WEBTITLE
          APPEND    PTWCURNO,WEBTITLE
          APPEND    SP70,WEBTITLE
          RESET     WEBTITLE
          ADD       ONE,ERRORCNT
          MOVE      WEBTITLE,ERRORLST[ERRORCNT]
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDCLM99
.
UPDCLM52  MOVE      ZERO,FORM8                * flag for new claim no.
          CALL      CLRWCM00                  * Clear MAB save variables
          PACK      KEY44,PTCLM011,URNUMBER,SP70
          CALL      RDSWCOM3
          CALL      RDKWCOM3
          BRANCH    OVRCD,UPDCLM53
          MATCH     PTCLM011,WCCLMNO
          GOTO      UPDCLM53 IF NOT EQUAL
          MATCH     PTWCURNO,URNUMBER
          GOTO      UPDCLM53 IF NOT EQUAL
.
          MOVE      WCADMNO,KEY8
          CALL      RDPMWX11
          IF        OVRCD=1
            CALL      CLPMSWX1
          ENDIF
          CALL      SAVWCM00                  * Save the selected claim details
          MOVE      ONE,FORM8
.
UPDCLM53  MOVE      ONE,WCOCOUNT
          MOVE      ZERO,ERRORCNT
UPDCLM55  MATCH     SP70,WCORECKY[WCOCOUNT]    * Any more records in to update
          GOTO      UPDCLM60 IF EQUAL
.
          PACK      KEY8,WCORECKY[WCOCOUNT],SP70
          CALL      RDWCOM1
          BRANCH    OVRCD,UPDCLM55
          MOVE      WCADMNO,KEY8
          CALL      RDPMWX11                * read extension file
          IF        OVRCD=1
            CALL      CLPMSWX1
          ENDIF
.
          MOVE      WCCLMNO,SAVCLMNO
.
          MATCH     Z70,PTCLM011            * Only update WC Claim number
          IF        !@EQUAL
            MOVE      PTCLM011,WCCLMNO
            IF        FORM8=1
              CALL      COPWCM00            * Copy fields from saved variables
            ENDIF
          ENDIF
          CALL      UPWCOM1
          IF        OVRCD=0
            CALL      UPPMWX11              * update extension file if exist
          ENDIF
.
          PACK      KEY26,SAVCLMNO,SP70
          CALL      RSACCMT1
UPDCLM56  CALL      RKACCMT1
          BRANCH    OVRCD,UPDCLM57
.
          MATCH     SAVCLMNO,ACCMACCN
          GOTO      UPDCLM57 IF NOT EQUAL
.
          MATCH     "001",ACCMTYPE
          GOTO      UPDCLM57 IF NOT EQUAL
.
          PACK      SAVKEY26,ACCMACCN,ACCMTYPE,DACCMLIN,SP70
.
          MOVE      WCCLMNO,ACCMACCN
.
          PACK      KEY26,ACCMACCN,ACCMTYPE,DACCMLIN,SP70
          CALL      RAACCMT1
          IF        OVRCD=1
            CALL      WRACCMT1
          ENDIF
.
          MOVE      SAVKEY26,KEY26
          CALL      RDACCMT1
.
          GOTO      UPDCLM56
.
UPDCLM57  PACK      KEY44,SAVCLMNO,SP70
          CALL      RDSWCOM3
          CALL      RDKWCOM3
          BRANCH    OVRCD,UPDCLM58
.
          MATCH     SAVCLMNO,WCCLMNO
          GOTO      UPDCLM59 IF EQUAL
.
UPDCLM58  PACK      KEY26,SAVCLMNO,ZERO,ZERO,ONE,SP70
          CALL      RSACCMT1
          CALL      RKACCMT1
          BRANCH    OVRCD,UPDCLM59
.
          MATCH     SAVCLMNO,ACCMACCN
          GOTO      UPDCLM59 IF NOT EQUAL
.
          MATCH     "001",ACCMTYPE
          GOTO      UPDCLM59 IF NOT EQUAL
.
          PACK      KEY26,ACCMACCN,ACCMTYPE,DACCMLIN,SP70
          CALL      DEACCMT1
.
          GOTO      UPDCLM58
.
UPDCLM59  CALL      UPACC200
          CALL      UPACDI00
          CALL      UPACRF00
.
          PACK      KEY8,WCORECKY[WCOCOUNT],SP70
          CALL      RDWCOM1
.
.         If we are sending ACC details in PV1-20, then we need to
.         trigger an A08 message for the visit to reflect that this is
.         no longer an ACC patient
.
          MATCH     "1",PTCNH7AC
          IF        @EQUAL
            CALL      TACC0000                   * send HL7 message
          ENDIF
.
          IF        PTCNHDPS=1
            CALL      MVACCMOD
          ENDIF
.
          ADD       ONE,WCOCOUNT
          GOTO      UPDCLM55
.
UPDCLM60  COMPARE   ZERO,ERRORCNT           * Any error to display
          GOTO      UPDCLM99 IF EQUAL
          CALL      ERRLST00                * Display errors
          MOVE      ONE,EXIT             * set exit after warning
          GOTO      UPDCLM99
.
.         Veteran affairs
.
UPDCLM70  PACK      KEY8,ADMISSNO
          CALL      RDWVET1
          BRANCH    OVRCD,UPDCLM99
          MOVE      PTCLM014,VCLMNO      * update claim no.
          CALL      UPWVET1
          GOTO      UPDCLM99
.
.         Veteran affairs
.
UPDCLM75  MOVE      ADMISSNO,KEY8
          CALL      RDPMCTC1
          BRANCH    OVRCD,UPDCLM99
.
          CALL      UPCLV000
          CALL      UPPMCTC1
          GOTO      UPDCLM99
.
.         Update person responsible for account
.
UPDCLM80  CALL      UPDPRA00  * move cgi variables to the fields
          CALL      UPPRA000  * Update person responsbile for account
          GOTO      UPDCLM99
.
.         set default for person responsible for account
.
UPDCLM82  CALL      FPRA0000           * Fixed person responsible for acc.
          GOTO      UPDCLM99
.
UPDCLM93  CLEAR     WEBTITLE
          IF        ERRFLAG=1
            APPEND    "Claim number must be 7 digits.",WEBTITLE
            APPEND    SP70,WEBTITLE
            RESET     WEBTITLE
            ADD       ONE,ERRORCNT
            MOVE      WEBTITLE,ERRORLST[ERRORCNT]
            MOVE      ZERO,WARNFLAG
          ELSE
            APPEND    "Date of Accident must not be > 20",WEBTITLE
            APPEND    " years before Claim or Invalid",WEBTITLE
            APPEND    " Accident Date.",WEBTITLE
            APPEND    SP70,WEBTITLE
            RESET     WEBTITLE
            ADD       ONE,ERRORCNT
            MOVE      WEBTITLE,ERRORLST[ERRORCNT]
            MOVE      ZERO,WARNFLAG
          ENDIF
          CALL       ERRLST00
          MOVE       ONE,EXIT
          GOTO       UPDCLM99
.
UPDCLM99  RETURN
+
.---------------------------------------------------------------
. Update Claim Type to ALternate Election if ICWA Status is Confirmed
.---------------------------------------------------------------
UPCLTY00  PACK      KEY8,PMEXVISN,SP70
          CALL      RDPTVIS1
          BRANCH    OVRCD,UPCLTY99
.
          COMPARE   ONE,PVITYPE
          GOTO      UPCLTY10 IF EQUAL     * Emergency visit
.
          COMPARE   TWO,PVITYPE
          GOTO      UPCLTY20 IF EQUAL     * Outpatient visit
.
          COMPARE   THREE,PVITYPE
          GOTO      UPCLTY30 IF EQUAL     * Inpatient visit
.
          GOTO      UPCLTY99
.
UPCLTY10  PACK      KEY8,PMEXVISN,SP70
          CALL      RDEMVIS1              * read Emergency Visit file
          BRANCH    OVRCD,UPCLTY99
.
          MATCH     "2",DEMVISTA          * EMR Discharged Incomplete
          IF        @EQUAL
            PACK      VISITTYP,ANSE,ANSD,SP70  * Visit Type
            GOTO      UPCLTY40
          ENDIF
.
          MATCH     "3",DEMVISTA          * EMR Discharged Complete
          IF        @EQUAL
            PACK      VISITTYP,ANSE,ANSD,SP70  * Visit Type
            GOTO      UPCLTY40
          ENDIF
.
          GOTO      UPCLTY99
.
UPCLTY20  PACK      CFNAME,OSTFILE,FILBOKA6
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      OUTBOKA6,CFNAME              * outbb1af opened ?
          TRAPCLR   IO
          BRANCH    OVRCD,UPCLTY99
.
          PACK      KEY36,PMEXVISN,SP70
          CALL      RDSBOKA6              * read Outpatients file
UPCLTY25  CALL      RDKBOKA6
          BRANCH    OVRCD,UPCLTY99
.
          MATCH     PMEXVISN,DOBAOUTN
          GOTO      UPCLTY99 IF NOT EQUAL
.
          MATCH     "4",DOBASTAT          * Booking Attended
          IF        @EQUAL
            PACK      VISITTYP,ANSO,ANSP,SP70  * Visit Type
            GOTO      UPCLTY40
          ENDIF
.
          GOTO      UPCLTY25              * read next record
.
UPCLTY30  PACK      KEY8,PMEXVISN,SP70
          CALL      RDPTMIS1              * read Patient Admissions file
          BRANCH    OVRCD,UPCLTY99
.
          MATCH     "2",DASTAT            * Inpatient Current Admission
          IF        @EQUAL
            PACK      VISITTYP,ANSI,ANSP,SP70  * Visit Type
            GOTO      UPCLTY40
          ENDIF
.
          MATCH     "3",DASTAT            * Inpatient Discharged
          IF        @EQUAL
            PACK      VISITTYP,ANSI,ANSP,SP70  * Visit Type
            GOTO      UPCLTY40
          ENDIF
.
          GOTO      UPCLTY99              * read next record
.
UPCLTY40  MATCH     "IP",VISITTYP
          IF        @EQUAL
            PACK      KEY8,PMEXVISN,SP70
            CALL      RDPTMIS1                    * read patmi1af
            BRANCH    OVRCD,UPCLTY45
            PACK      ACLAIM,PMEXALEL,SP70
            PACK      PTMIWEBU,USERID,SP70
            CALL      UPPTMIS1                    * update patmi1af
.
UPCLTY45    CALL      UPINSU00                  * set new insurance company
            PACK      PMEXCLAM,PMEXALEL,SP70
            CALL      UPPMEXT1                  * update pmsextaf
            CALL      UPTRAN00                 * update supervisor claim type
            CALL      UPHMDS00                  * update HMDS extract flag
            CALL      IPMESS00                    * send HL7 message
            GOTO      UPCLTY99
          ENDIF
.
          MATCH     "ED",VISITTYP
          IF        @EQUAL
            PACK      KEY8,PMEXVISN,SP70
            CALL      RDEMVIS1                    * read emrvisaf
            BRANCH    OVRCD,UPCLTY99
            PACK      EMVICOMP,PMEXALEL,SP70
            CALL      UPEMVIS1                    * update emrvisaf
.
            PACK      KEY8,EMVIADMN,SP70
            CALL      RDDETA1
            IF        OVRCD=0
              MOVE      EMVICOMP,ADACOMP
              CALL      UPDETA1                   * upate aaede1af
            ENDIF
.
            CALL      UPINSU00                    * set new insurance company
            PACK      PMEXCLAM,PMEXALEL,SP70
            CALL      UPPMEXT1                    * update pmsextaf
            CALL      EDMESS00                    * send HL7 message
            GOTO      UPCLTY99
          ENDIF
.
          MATCH     "OP",VISITTYP
          IF        @EQUAL
            PACK      KEY8,PMEXVISN,SP70
            CALL      RDBOKB1                     * read outbb1af
            BRANCH    OVRCD,UPCLTY50
            PACK      OBACOMP,PMEXALEL,SP70
            CALL      UPBOKB1                     * update outbb1af
            CALL      UPINSU00                    * set new insurance company
            PACK      PMEXCLAM,PMEXALEL,SP70
            CALL      UPPMEXT1                    * update pmsextaf
            CALL      OPMESS00                    * send HL7 message
.
UPCLTY50    PACK      KEY16,PMEXVISN,SP70
            CALL      RSALLNK2
UPCLTY55    CALL      RKALLNK2                    * read alllnkaf
            BRANCH    OVRCD,UPCLTY99
.
            MATCH     PMEXVISN,ALLNLNKV
            GOTO      UPCLTY99 IF NOT EQUAL
.
            PACK      KEY8,ALLNVISN,SP70
            CALL      RDALREF1                    * read allrefaf
            BRANCH    OVRCD,UPCLTY99
            PACK      ALRECOMP,PMEXALEL,SP70
            CALL      UPALREF1                    * update allrefaf
            CALL      LKMESS00                    * send HL7 message
            GOTO      UPCLTY55                    * next alllnkaf record
          ENDIF
.
UPCLTY99  RETURN
+
.--------------------------------------------------------------------------
. Update Insurance Company when MVIT Status is Confirmed
.--------------------------------------------------------------------------
UPINSU00  PACK      KEY6,SP70
          CALL      RDSINSR1                      * position on first record
UPINSU10  CALL      RDKINSR1                      * read next record
          BRANCH    OVRCD,UPINSU99
.
          MATCH     PTINCLAI,PMEXALEL
          GOTO      UPINSU10 IF NOT EQUAL
.
          PACK      PMEXICOD,ICODE,SP70           * save new insurance code for
          GOTO      UPINSU99                      * alt election ready for when
                                                  * pmsextaf is updated
.
UPINSU99  RETURN
+
.--------------------------------------------------------------------------
. Mimic Supervisor Claim Type Change - update pattranf & write to pmschaaf
.--------------------------------------------------------------------------
UPTRAN00  PACK      KEY30,PMEXVISN,Z70
          CALL      RDSTRAN2
UPTRAN10  CALL      RDPTRAN2                    * read pattranf
          BRANCH    OVRCD,UPTRAN99
.
          MATCH     PMEXVISN,DTADMN             * match visit numbers
          GOTO      UPTRAN99 IF NOT EQUAL
.
          MATCH     PTTRCLTY,PMEXALEL           * is current & new CL different
          GOTO      UPTRAN99 IF EQUAL
.
          PACK      TRCDATE,CCC,CYY,CMM,CDD
          REP       " 0",TRCDATE
          CLOCK     TIME,TRCTIME
          MOVE      WBSEUID,PTTRUUID
.
          PACK      SAVCLCD,PTTRCLTY,SP70       * save old claim type
          PACK      PTTRCLTY,PMEXALEL,SP70
          CALL      UPTRAN2                     * update pattranf
.
          PACK      PMCHADMN,DTADMN,SP70
          PACK      PMCHTDAT,TDATE,SP70
          PACK      PMCHTTIM,TTIME,SP70
          PACK      PMCHTWAR,TWARD,SP70
          PACK      PMCHTBED,TBED,SP70
          PACK      PMCHCDAT,CCC,CYY,CMM,CDD,SP70
          PACK      PMCHCTIM,CTIMEIS,SP70
          MOVE      "002",KEY3
          PACK      PMCHCTYP,KEY3,SP70
          PACK      PMCHREAS,REASCHNG,SP70
          PACK      PMCHOVAL,SAVCLCD,SP70
          PACK      PMCHNVAL,PTTRCLTY,SP70
          PACK      PMCHWEBC,USERID,SP70
          PACK      PMCHDATC,CCC,CYY,CMM,CDD,SP70
          PACK      PMCHTIMC,CTIMEIS,SP70
.
          PACK      KEY46,PMCHADMN,PMCHTDAT,PMCHTTIM,PMCHTWAR,PMCHTBED,PMCHCDAT,PMCHCTIM,SP70
          CALL      RAPMCHA1
          IF        OVRCD=1
            CALL      WRPMCHA1                  * write transfer audit record
          ENDIF
.
          CALL      CLPATTRN                    * clear pattranf variables
.
UPTRAN99  RETURN
+
.--------------------------------------------------------------------------
. Update HMDS Extract Flag for IP events
.--------------------------------------------------------------------------
UPHMDS00  PACK      KEY8,PMEXVISN,SP70
          CALL      RDPTMIS1                    * read patmi1af
          BRANCH    OVRCD,UPHMDS99
.
          COMPARE   ONE,AELIG
          IF        @EQUAL
            MOVE      ZERO,AELIG                  * reset HMDS extract flag
            CALL      UPPTMIS1                    * update patmi1af
          ENDIF
.
UPHMDS99  RETURN
+
.--------------------------------------------------------------------------
. Send A08 HL7 message for IP events
.--------------------------------------------------------------------------
IPMESS00  CALL      IBACLOCK                     * current date/time
.
.         Read the relevant records for the patient and
.         broadcast an HL7 update visit message (A08)
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPTMIS1                     * admission on file ?
          BRANCH    OVRCD,IPMESS99               * no - finish
.
          MOVE      AURNO,KEY8
          CALL      RDMAST1                      * pmi record on file ?
          BRANCH    OVRCD,IPMESS99               * no - finish
.
          MOVE      AURNO,KEY8
          CALL      RDPMPX21                     * get pmi extension record
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPTRES1                     * get PRA record
          IF        OVRCD=1
            CALL      CLPATRE1
          ENDIF
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDDSCH1                      * check for discharge record
          IF        OVRCD=1
            CALL      CLPATDSC
          ENDIF
.
.         Get the last transfer record
.
          PACK      KEY30,AADMNO,TILDA35
          CALL      RDSTRAN2                     * pos'n after last tran record
          CALL      RDPTRAN2                     * read previous record
          BRANCH    OVRCD,IPMESS99               * eof - finish
.
          MATCH     AADMNO,TADMN                 * same admission still ?
          GOTO      IPMESS99 IF NOT EQUAL        * no - finish
.
          CALL      PMIGTNID              * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TWENTY2,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICAC              * broadcast change admission details
.
IPMESS99  RETURN
+
.--------------------------------------------------------------------------
. Send A08 HL7 message for OP events
.--------------------------------------------------------------------------
OPMESS00  MOVE      PMEXURNO,KEY8
          CALL      RDMAST1                    * PMI record found ?
          BRANCH    OVRCD,OPMESS99             * no - don't send message
.
          MOVE      PMEXURNO,KEY8
          CALL      RDPMPX21                   * PMI extension record found ?
          BRANCH    OVRCD,OPMESS99             * no - don't send message
.
          MATCH     PMEXVISN,SP70
          GOTO      OPMESS99 IF EQUAL          * blank visit ?
.
          MOVE      PMEXVISN,D8                * visit number
.
          MOVE      TWENTY3,HL7TRGID
.
          PACK      KEY36,D8,SP20,SP20
          CALL      RDSBOKA6                   * position on visit number
          CALL      RDKBOKA6                   * read next record
          BRANCH    OVRCD,OPMESS99             * eof - finished
.
          MATCH     DOBAOUTN,D8                * same visit number ?
          GOTO      OPMESS99 IF NOT EQUAL      * no - finished
.
.         Get the outbb1af record
.
          MOVE      D8,KEY8
          CALL      RDBOKB1                    * outbb1af record found ?
          BRANCH    OVRCD,OPMESS99             * no
.
          CALL      CLOUTRSH                   * clear unused variables
          CALL      CLOUTCAN
.
.         Set up the message for sending
.
          CALL      PMIGTNID                   * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      SP8,HL7INCLD
          PROC      DGCLICOB                   * send update visit details
.
OPMESS99  RETURN
+
.--------------------------------------------------------------------------
. Send A08 HL7 message for ED events
.--------------------------------------------------------------------------
EDMESS00  MOVE      EMVIURNO,KEY8               * get PMI details
          CALL      RDMAST1
          BRANCH    OVRCD,EDMESS99
.
          MOVE      EMVIURNO,KEY8
          CALL      RDPMPX21
          BRANCH    OVRCD,EDMESS99
.
          MOVE      EMVIADMN,KEY8
          CALL      RDPMVX11
          BRANCH    OVRCD,EDMESS99
.
          CALL      PMIGTNID
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TWENTY5,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICEC                    * send A08
.
EDMESS99  RETURN
+
.--------------------------------------------------------------------------
. Send I13 HL7 message for Linked Referral events
.--------------------------------------------------------------------------
LKMESS00  MOVE      ALLNVISN,KEY8
          CALL      RDALREF1                     * Admission record found ?
          BRANCH    OVRCD,LKMESS99               * no
          MOVE      PMEXURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,LKMESS99
          CALL      RDPMPX21
          BRANCH    OVRCD,LKMESS99
.
.         Set up the message for sending
.
          CALL      PMIGTNID                   * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TWENTY6,HL7TRGID
          MOVE      SP8,HL7INCLD
          CALL      DGCLII13                     * send update referral details
.
LKMESS99  RETURN
+
.------------------------------------------------------------
.  Update ACCAUDFD file for Change ACC Number
.------------------------------------------------------------
MVACCMOD  CALL      CLACCAUD
.
          MATCH     PTCLM011,SP70
          IF        !@EQUAL
            MOVE      PTCLM011,ACAUCLMN
          ENDIF
.
          MATCH     DWCADMNO,SP70
          IF        !@EQUAL
            MOVE      DWCADMNO,ACAUADMN
          ENDIF
.
          CALL      IBACLOCK
          PACK      ACAUDATE,CCC,CYY,CMM,CDD        * Date
          REP       " 0",ACAUDATE
          MOVE      CTIMEIS,ACAUTIME
          MOVE      USERID,ACAUWUID                 * Web UserId
.
          MOVE      "C",ACAUAUTY                    * Audit Type
          MOVE      "A",ACAUTREC                    * ACC Type of Record
.
          MATCH     Z70,SAVCLMNO
          IF        !@EQUAL
            MOVE      SAVCLMNO,ACAUOACC
          ENDIF
.
MVACCM10  PACK      KEY54,ACAUCLMN,ACAUADMN,ACAUDATE,ACAUTIME,ACAUWUID
          CALL      RAACAUD1
          IF        OVRCD=1
            CALL      WRACAUD1
            GOTO      MVACCM99
          ELSE
            CALL      IBACLOCK                    * Set new date and time and
            PACK      ACAUDATE,CCC,CYY,CMM,CDD    * try write again
            REP       " 0",ACAUDATE
            CLOCK     TIME,CTIMEIS
            PACK      ACAUTIME,CTIMEIS      
            REP       " 0",ACAUTIME
            GOTO      MVACCM10
          ENDIF
.
MVACCM99  RETURN
.
.**********************************************************************
.         Set admission fields for Private
.**********************************************************************
STAD0000  MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,STAD2000
.
          MOVE      ONE,OVRCD
          MATCH     PTMIS013,Z70
          IF        !@EQUAL
            MOVE      PTMIS013,AFUNDH          * health fund
            PACK      AFUNDH,AFUNDH,SP70
            MOVE      ZERO,OVRCD
          ENDIF
          MATCH     PTMIS014,Z70
          IF        !@EQUAL
            MOVE      PTMIS014,AFNDTB          * health fund table
            PACK      AFNDTB,AFNDTB,SP70
            MOVE      ZERO,OVRCD
          ENDIF
          MATCH     PTMIS015,Z70
          IF        !@EQUAL
            MOVE      PTMIS015,AFNDMM          * health fund membership
            PACK      AFNDMM,AFNDMM,SP70
            MOVE      ZERO,OVRCD
          ENDIF
          BRANCH    OVRCD,STAD2000
          CALL      UPMISS1
.
.         Check if Contributor name is changed
.
STAD2000  MOVE      ADMISSNO,KEY8
          CALL      RDPMVX11
          BRANCH    OVRCD,STAD9999
.
          MOVE      ONE,OVRCD
          MATCH     PTMIS015,Z70
          IF        !@EQUAL
            MOVE      PTMIS015,PMVXFNDM        * health fund membership
            PACK      PMVXFNDM,PMVXFNDM,SP70
            MOVE      ZERO,OVRCD
          ENDIF
.
          MATCH     PMSVX142,Z70
          IF        !@EQUAL
            MOVE      PMSVX142,PMVXCONM        * Contributor name
            PACK      PMVXCONM,PMVXCONM,SP70
            MOVE      ZERO,OVRCD
          ENDIF
          BRANCH    OVRCD,STAD9999
          CALL      UPPMVX11
STAD9999  RETURN
+
.**********************************************************************
.         Update Default Printer File for User
.**********************************************************************
UPDEFP00  MATCH     "042",TEMPLATE
          IF        @EQUAL
            SUB       ONE,COUNTER
            MOVE      COUNTER,COUNTERD
            PACK      KEY2,COUNTERD,X1A
            ADD       ONE,COUNTER
          ELSE
            PACK      KEY2,ZERO,CLAIMTYP
          ENDIF
          PACK      KEY20,SETDFPRG,KEY2,WBSEUID,SP70
          UNPACK    KEY20,IBPDPID,IBPDREP,IBPDUID
          MOVE      SCHDPRNT,IBPDPRT
          MOVE      NOLABEL,IBPDCOP         * no of copies
          MOVE      STATNCOD,IBPDDOC        * save stat code to document code
          MOVE      SP70,IBPDNUM
          MOVE      SP70,IBPDSPA
          CALL      RAIBPD1
          IF        OVRCD=0
            CALL      UPIBPD1
          ELSE
            CALL      WRIBPD1
          ENDIF
UPDEFP99  RETURN
+
.------------------------------------------------------------
.  Fixed Person responsible for account
.------------------------------------------------------------
FPRA0000 CALL       CLRRES00                * clear person responsible vars 
         CALL       UPCLV000
         MOVE       ZERO,RESPFLAG
         PACK       D8,ADMISSNO,SP70
         REP        "0 ",D8
         MATCH      SP8,D8
         GOTO       FPRA9900 IF EQUAL            * TSK 0934325
.
         MOVE       ADMISSNO,KEY8
         CALL       RDRESP1
         MOVE       OVRCD,RESPFLAG
         MOVE       ADMISSNO,PKADMN
.
         MOVE       PMEXT002,KEY3      * Claim code
         CALL       PRFAINSR           * Copy Claim insurance details to PRFFA
         IF         OVRCD=0
           GOTO       FPRA9000
         ENDIF
.
         MATCH      "D",CLAIMTYP          * Defence Force
         GOTO       FPRA0100 IF EQUAL     * for Private hospitals
.
         MATCH      "1",PTCNXCOM
         GOTO       FPRA0100 IF NOT EQUAL * Not Using Extra Compensable table
.
         BRANCH     ATD62FLG,FPRA0020
.
         PACK       KEY11,PMEXT001,PMEXT002,SP70
         CALL       RDPMEXT1
         BRANCH     OVRCD,FPRA9900
.
FPRA0020 MATCH      SP70,CLAIMTYP
         GOTO       FPRA7500 IF EQUAL       * Use patient details
         MATCH      "A",CLAIMTYP
         GOTO       FPRA7000 IF EQUAL       * Australian Defence Force
         MATCH      "O",CLAIMTYP
         GOTO       FPRA5000 IF EQUAL       * Use Organisation for Other Comp.
         MATCH      "F",CLAIMTYP
         GOTO       FPRA7000 IF EQUAL       * Foreign Defence Force
         MATCH      "S",CLAIMTYP
         GOTO       FPRA6000 IF EQUAL       * Shipping Agent
         MATCH      "E",CLAIMTYP
         GOTO       FPRA7300 IF EQUAL       * Overseas Student
         MATCH      "G",CLAIMTYP
         GOTO       FPRA7300 IF EQUAL       * Overseas Visitor
.
         MATCH      "P",CLAIMTYP
         GOTO       FPRA7500 IF EQUAL       * Public
         MATCH      "H",CLAIMTYP
         GOTO       FPRA6200 IF EQUAL       * Private
         MATCH      "J",CLAIMTYP
         GOTO       FPRA7500 IF EQUAL       * Private Uninsured
         MATCH      SP70,CLAIMTYP
         GOTO       FPRA7500 IF EQUAL       * Bulk Billing/Aff Funding/Unknown
.
         REP        "XMYVZW",CLAIMTYP
         MATCH      "M",CLAIMTYP
         GOTO       FPRA7000 IF EQUAL       * WA - Motor Vehicle
         MATCH      "V",CLAIMTYP
         GOTO       FPRA7500 IF EQUAL       * WA - Veterans Affairs
         MATCH      "W",CLAIMTYP
         GOTO       FPRA7250 IF EQUAL       * WA - Workers Comp - Employer
         GOTO       FPRA9900
.
.        PTPCLRES - 0 use insurance company, 1 use patient details
.                   2 use prfa details 
.
FPRA0100 BRANCH     PTPCLRES,FPRA3000,FPRA9900
.
         MATCH      "D",CLAIMTYP          * Defence Force
         GOTO       FPRA5500 IF EQUAL
.
         MATCH      "M",CLAIMTYP
         GOTO       FPRA1000 IF EQUAL       * TAC
         MATCH      "V",CLAIMTYP
         GOTO       FPRA2000 IF EQUAL       * Veteran affair
         MATCH      "W",CLAIMTYP
         GOTO       FPRA9900 IF NOT EQUAL   * W/C
.
.        Set W/C claim details
.
.                                           * start of code added from V6.14
FPRA0500  COMPARE   THREE,PTPCLRES
          GOTO      FPRA0700 IF NOT EQUAL
.
          COMPARE   ONE,WCACCPT             * Check if accepted by insurance
          GOTO      FPRA0700 IF NOT EQUAL   * no
          MATCH     SP6,WCICODE             * check for insurance code
          GOTO      FPRA0700 IF EQUAL       * no insurance code
          MOVE      WCICODE,KEY6
          CALL      RDINSR1                 * read insurance detail
          BRANCH    OVRCD,FPRA0700
.
          PACK      PKNAME,INAME,SP70,SP10
          MOVE      IADD1,PKADD1
          MOVE      IADD2,PKADD2
          MOVE      IADD3,PKSUBR
          MOVE      IADD4,PKADD4
          MOVE      IPOST,PKPOST
          MOVE      ITELEB,PKTELEB
          MOVE      "EMPL'S INS",PKRELP
          MOVE      SP20,PKTELEP
          MOVE      SP20,PTREMOBL
          MOVE      ADMISSNO,PKADMN          * was WCADMNO            *C-140841
          MOVE      SP70,PTRESNAM
          MOVE      SP70,PTREGNAM
          GOTO      FPRA9000
.                                           * end of code added from V6.14
FPRA0700 PACK       PKNAME,WCENAME,SP70,SP10
         MOVE       WCEADD1,PKADD1
         MOVE       WCEADD2,PKADD2
         MOVE       WCEADD3,PKSUBR
         MOVE       WCEADD4,PKADD4
         MOVE       WCEPOST,PKPOST
         MOVE       WCETELE,PKTELEB
         MOVE       "Employer  ",PKRELP
         MOVE       SP20,PKTELEP
         MOVE       SP20,PTREMOBL
         MOVE       ADMISSNO,PKADMN
         MOVE       SP70,PTRESNAM
         MOVE       SP70,PTREGNAM
         GOTO       FPRA9000
.
.        Set TAC claim details
.
FPRA1000 MOVE       CMABINS,KEY6
         CALL       RDINSR1
         COMPARE    ZERO,OVRCD
         GOTO       FPRA9900 IF NOT EQUAL
.
         PACK       PKNAME,INAME,SP70,SP10
         MOVE       IADD1,PKADD1
         MOVE       IADD2,PKADD2
         MOVE       IADD3,PKSUBR
         MOVE       IADD4,PKADD4
         MOVE       IPOST,PKPOST
         MOVE       ITELEB,PKTELEB
         MOVE       "T.A.C.    ",PKRELP
         MOVE       SP20,PKTELEP
         MOVE       SP20,PTREMOBL
         MOVE       ADMISSNO,PKADMN
         MOVE       SP70,PTRESNAM
         MOVE       SP70,PTREGNAM
         GOTO       FPRA9000
.
.        Set up Veteran affairs claim details
.
FPRA2000 MOVE       CVETINS,KEY6
         CALL       RDINSR1
         COMPARE    ZERO,OVRCD
         GOTO       FPRA9900 IF NOT EQUAL
.
         PACK       PKNAME,INAME,SP70,SP10
         MOVE       IADD1,PKADD1
         MOVE       IADD2,PKADD2
         MOVE       IADD3,PKSUBR
         MOVE       IADD4,PKADD4
         MOVE       IPOST,PKPOST
         MOVE       ITELEB,PKTELEB
         MOVE       "Vet.Affair",PKRELP
         MOVE       SP20,PKTELEP
         MOVE       SP20,PTREMOBL
         MOVE       ADMISSNO,PKADMN
         MOVE       SP70,PTRESNAM
         MOVE       SP70,PTREGNAM
         GOTO       FPRA9000
.
FPRA3000 CALL      CPRT0000                  * Check 'Parent of Option
.
         PACK      PKADD1,PADD1,SP30,SP20
         PACK      PKADD2,PADD2,SP30,SP20
         PACK      PKSUBR,PSUBRB,SP20,SP30
         PACK      PKADD4,PADD4,SP30,SP10
         PACK      PKPOST,PPOST,SP10,SP20
         PACK      PKTELEP,PTELEP,SP20
         PACK      PKTELEB,PTELEB,SP20
         PACK      PTREMOBL,PTMXCELL,SP20
         MOVE      ADMISSNO,PKADMN
         MOVE      PGNAME,PTREGNAM
         MOVE      PTMASNAM,PTRESNAM
         GOTO      FPRA9000
.
.        Use Organisation details for PRFA
.
FPRA5000 MATCH     SP70,PMEXPOLC
         GOTO      FPRA5500 IF EQUAL
         GOTO      FPRA5500 IF EOS
.
         MATCH     SP70,PMEXSCHL
         GOTO      FPRA5500 IF EQUAL
         GOTO      FPRA5500 IF EOS
.
         OPEN      PATEORA1,"pateoraf"
         MOVE      "O",KEY1
         PACK      KEY7,KEY1,PMEXSCHL,SP70
         CALL      RDPTEOR1
         BRANCH    OVRCD,FPRA5500
.
         PACK      PKNAME,PTERNAME,SP70,SP10
         MOVE      PTERADD1,PKADD1
         MOVE      PTERADD2,PKADD2
         MOVE      PTERADD3,PKSUBR
         MOVE      PTERADD4,PKADD4
         MOVE      PTERPOST,PKPOST
         MOVE      PTERTELP,PKTELEB
         MOVE      SP70,PKRELP
         MOVE      SP20,PKTELEP
         MOVE      SP20,PTREMOBL
         MOVE      PMEXT001,PKADMN
         PACK      PTRESNAM,PTERCONT,SP70
         MOVE      SP70,PTREGNAM
         GOTO      FPRA9000
.
FPRA5500 MATCH     SP70,PMEXICOD
         GOTO      FPRA5800 IF EQUAL
         GOTO      FPRA5800 IF EOS
.
         PACK      KEY6,PMEXICOD,SP70
         CALL      RDINSR1
         BRANCH    OVRCD,FPRA5800
.
         PACK      PKNAME,INAME,SP70,SP10
         MOVE      IADD1,PKADD1
         MOVE      IADD2,PKADD2
         MOVE      IADD3,PKSUBR
         MOVE      IADD4,PKADD4
         MOVE      IPOST,PKPOST
         MOVE      ITELEB,PKTELEB
         MOVE      SP70,PKRELP
         MOVE      SP70,PKTELEP
         MOVE      SP70,PTREMOBL
         MOVE      PMEXT001,PKADMN
         PACK      PTRESNAM,ICONT,SP70
         MOVE      SP70,PTREGNAM
         GOTO      FPRA9000
.
FPRA5800 MATCH      "D",CLAIMTYP          * Defence Force
         GOTO       FPRA9900 IF EQUAL
.
         MOVE      "2",KEY1                 * Postal Address
         CALL      DADR0000
         IF        EXIT=1
           MOVE      "7",KEY1               * Local Address
           CALL      DADR0000
           BRANCH    EXIT,FPRA3000
         ENDIF
         GOTO      FPRA8800
.
.-------------------------------------------------------------------------------
.        Shipping Agent
.-------------------------------------------------------------------------------
FPRA6000 MATCH     SP70,PMEXCAD1
         GOTO      FPRA8000 IF EQUAL        * blank address line 1
         GOTO      FPRA8000 IF EOS
.
         PACK      PKNAME,PMEXSAGN,SP70,SP10
         MOVE      PMEXCAD1,PKADD1
         MOVE      PMEXCAD2,PKADD2
         MOVE      PMEXCAD3,PKSUBR
         MOVE      PMEXCAD4,PKADD4
         MOVE      PMEXCPCD,PKPOST
         MOVE      PMEXCPHN,PKTELEB
         MOVE      SP70,PKRELP
         MOVE      SP20,PKTELEP
         MOVE      SP20,PTREMOBL
         MOVE      PMEXT001,PKADMN
         PACK      PTRESNAM,PMEXCNAM,SP70
         MOVE      SP70,PTREGNAM
         GOTO      FPRA9000
.
.-------------------------------------------------------------------------------
.        Private
.-------------------------------------------------------------------------------
FPRA6200 MATCH     SP70,AFUNDH
         GOTO      FPRA0100 IF EQUAL
.
         PACK      KEY14,AFUNDH,ZERO8
         CALL      RDFUND1
         BRANCH    OVRCD,FPRA0100
.
         PACK      PKNAME,HFNAME,SP70
         PACK      PKADD1,HFADD1,SP70
         PACK      PKADD2,HFADD2,SP70
         PACK      PKSUBR,HFADD3,SP70
         PACK      PKADD4,HFADD4,SP70
         PACK      PKPOST,HFPCODE,SP70
.
         MOVE      HFTELE,PKTELEB
         MOVE      SP70,PKRELP
         MOVE      SP20,PKTELEP
         MOVE      SP20,PTREMOBL
         MOVE      PMEXT001,PKADMN
         PACK      PTRESNAM,PTHFCNAM,SP70
         MOVE      SP70,PTREGNAM
         GOTO      FPRA9000
.
.-------------------------------------------------------------------------------
.
.        WA Extra Comp Australian Defence Force / Foreign Defence Force / 
.        Workers Comp
.
FPRA7000 MATCH     SP70,PMEXICOD
         GOTO      FPRA7100 IF NOT EQUAL        * insurance company
.
         MATCH     SP70,PMEXCAD1
         GOTO      FPRA7200 IF NOT EQUAL        * insurance company
.
         GOTO      FPRA8000                     * Check Indicator
.
FPRA7100 PACK      KEY6,PMEXICOD,SP70
         CALL      RDINSR1
         BRANCH    OVRCD,FPRA3000
.
         PACK      PKNAME,INAME,SP70,SP10
         MOVE      IADD1,PKADD1
         MOVE      IADD2,PKADD2
         MOVE      IADD3,PKSUBR
         MOVE      IADD4,PKADD4
         MOVE      IPOST,PKPOST
         MOVE      ITELEB,PKTELEB
         MOVE      SP70,PKRELP
         MOVE      SP70,PKTELEP
         MOVE      SP70,PTREMOBL
         MOVE      PMEXT001,PKADMN
         PACK      PTRESNAM,ICONT,SP70
         MOVE      SP70,PTREGNAM 
.
         GOTO      FPRA9000
.
FPRA7200 CALL      CPRT0000                  * Check 'Parent of Option
.
         MOVE      PMEXCAD1,PKADD1
         MOVE      PMEXCAD2,PKADD2
         MOVE      PMEXCAD3,PKSUBR
         MOVE      PMEXCPCD,PKPOST
         MOVE      PMEXCAD4,PKADD4
         MOVE      PMEXCPHN,PKTELEB
         MOVE      SP70,PKRELP
         MOVE      SP70,PKTELEP
         MOVE      SP70,PTREMOBL
         MOVE      PMEXT001,PKADMN
         PACK      PTRESNAM,PMEXCNAM,SP70
         MOVE      SP70,PTREGNAM
.
         GOTO      FPRA9000
.
.-------------------------------------------------------------------------------
.        Workers Comp - default the Employer as PRFA
.-------------------------------------------------------------------------------
FPRA7250 PACK      PKNAME,PMEXNAME,SP70,SP10
         MOVE      PMEXADD1,PKADD1
         MOVE      PMEXADD2,PKADD2
         MOVE      PMEXADD3,PKSUBR
         MOVE      PMEXADD4,PKADD4
         MOVE      PMEXPOST,PKPOST
         MOVE      PMEXEPHN,PKTELEB
         MOVE      "Employer  ",PKRELP
         MOVE      SP70,PKTELEP
         MOVE      SP70,PTREMOBL
         MOVE      ADMISSNO,PKADMN
         PACK      PTRESNAM,PMEXCNAM,SP70
         MOVE      SP70,PTREGNAM
.
         GOTO      FPRA9000
.
.-------------------------------------------------------------------------------
.        Overseas Student or Overseas Visitor
.        Try Local and Overseas/patient Address
.-------------------------------------------------------------------------------
FPRA7300 MOVE      "7",KEY1               * Local Address
         CALL      DADR0000
         BRANCH    EXIT,FPRA3000          * default to patient details
.
         GOTO      FPRA8800
.
.        Try Postal address if no Postal default to patient's address
.
FPRA7500 MOVE      "2",KEY1               * Postal Address
         CALL      DADR0000
         BRANCH    EXIT,FPRA3000          * default to patient details
.
         GOTO      FPRA8800
.
.-------------------------------------------------------------------------------
.        If indicator18=B - Leave PRFA blank
.-------------------------------------------------------------------------------
FPRA8000 PACK      KEY5,ANSC,ANSL,PMEXCLAM,SP70
         CALL      RDCODE1
         IF        OVRCD=0
           MATCH     "B",TCINDC18
           IF        @EQUAL
             CALL      CLPATRE1              * Clear PRFA
             GOTO      FPRA9000
           ENDIF
         ENDIF
         GOTO      FPRA3000                  * Patient details
.
.-------------------------------------------------------------------------------
.        Default PRFA to use the Extra Contract details
.-------------------------------------------------------------------------------
FPRA8800 CALL      CPRT0000                  * Check 'Parent of Option
.
         MOVE      PGNAME,ANS
         PACK      PKNAME,PTITL,SP1,ANS,DOT,PTMASNAM,SP70
         MOVE      PMCEADD1,PKADD1
         MOVE      PMCEADD2,PKADD2
         MOVE      PMCEADD3,PKSUBR
         MOVE      PMCEADD4,PKADD4
         MOVE      PMCEPOST,PKPOST
         MOVE      PMCETELB,PKTELEB
         MOVE      PMCERELP,PKRELP
         MOVE      PMCETELP,PKTELEP
         MOVE      PMCETELM,PTREMOBL
         MOVE      PMEXT001,PKADMN
         MOVE      PGNAME,PTREGNAM
         MOVE      PTMASNAM,PTRESNAM
         GOTO      FPRA9000
.
FPRA9000 IF        RESPFLAG=1
           CALL      WRRESP1
         ELSE
           CALL      UPRESP1
         ENDIF
         MOVE      ADMISSNO,WCADMNO
         CALL      TACC0000                   * send HL7 message
.
FPRA9900 MOVE      ZERO,EXIT
FPRA9999 RETURN
+
.------------------------------------------------------------
.        Check if we are using 'Parent of' Option
.------------------------------------------------------------
CPRT0000 MOVE      URNUMBER,KEY8
         CALL      RDMAST1
         BRANCH    OVRCD,CPRT9999
.
         COMPARE   ONE,PTCNPAOF              * Using 'Parent of' option?
         GOTO      CPRT8000 IF NOT EQUAL     * no
.
         PACK      AGEDATE,CCC,CYY,CMM,CDD
         CALL      CALCAGE                   * CALCAGE uses PBDATE
         COMPARE   PSAGEYRS,CAGECOFF         * Child?
         GOTO      CPRT8000 IF LESS          * No
.
.-------- Setup 'Parent of' as Person Responsible for Account
.
         MOVE      SP1,ANS
         MOVE      PGNAME,ANS
         PACK      PKNAME,SP70,SP10
.
         CLEAR     PKNAME
         APPEND    "Parent of ",PKNAME
         APPEND    ANS,PKNAME
         APPEND    DOT,PKNAME
         APPEND    SP1,PKNAME
         APPEND    PTMASNAM,PKNAME
         APPEND    SP70,PKNAME
         RESET     PKNAME
         MOVE      "Parent    ",PKRELP
         GOTO      CPRT9999
.
.-------- Use self as P.R.A.
CPRT8000 MOVE      SP1,ANS
         MOVE      PGNAME,ANS
         PACK      PKNAME,PTITL,SP1,ANS,DOT,PTMASNAM,SP70
         MOVE      SP70,PKRELP
.        MOVE      "SELF      ",PKRELP
.
CPRT9999 RETURN
+
.------------------------------------------------------------
.        Default Address from Extra Contract file
.------------------------------------------------------------
DADR0000  PACK      KEY14,URNUMBER,SP70
          CALL      RSPMCEX1
DADR1000  CALL      RKPMCEX1
          BRANCH    OVRCD,DADR9000
          MATCH     URNUMBER,PMCEURNO         * Same U/R?
          GOTO      DADR9000 IF NOT EQUAL
.
          MATCH     SP70,PMCETYPE
          GOTO      DADR1000 IF EQUAL
          MOVE      "tc",KEY2
          PACK      KEY5,KEY2,PMCETYPE
          CALL      RDCODE1
          BRANCH    OVRCD,DADR1000
          MATCH     KEY1,TCINDC1
          GOTO      DADR1000 IF NOT EQUAL
          MOVE      ZERO,EXIT
          GOTO      DADR99999
.
DADR9000  MOVE      ONE,EXIT
DADR9999  RETURN
+
.------------------------------------------------------------
.   Update person responsible for account
.------------------------------------------------------------
UPPRA000  PACK      D8,ADMISSNO,SP70
          REP       "0 ",D8
          MATCH     SP8,D8
          GOTO      UPPRA999 IF EQUAL            * TSK 0934325
.
          MOVE      ADMISSNO,PKADMN
          MOVE      PKADMN,KEY8
.
          MATCH     SP70,PKNAME             * If no name don't write a record
          GOTO      UPPRA200 IF EQUAL
.
          CALL      RDARESP1
          BRANCH    OVRCD,UPPRA100
.
          IF        PCEASE=1
            MATCH     "1",PTCNDEES
            IF        @EQUAL
              UNPACK    PKNAME,KEY2
              MATCH     DLCHAR,KEY2
              IF        @EQUAL
                MATCH     SP70,PTCNDDES
                IF        !@EQUAL
                  STRIP     PTCNDDES
                  MOVE      PTCNDDES,KEY20
                  UNPACK    PKNAME,DIM2,KEY78      * ignore "$ "
                  PACK      PKNAME,KEY20,SP1,KEY78,SP70
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          CALL      UPRESP1
          GOTO      UPPRA900
.
UPPRA100  CALL      WRRESP1
          GOTO      UPPRA900
.
UPPRA200  CALL      RDRESP1
          BRANCH    OVRCD,UPPRA900
          CALL      DERESP1
.
UPPRA900  MOVE      ADMISSNO,WCADMNO
          CALL      TACC0000                   * send HL7 message
          CALL      UPRI0000         * Update private practice prfa 
UPPRA999  RETURN
+
.------------------------------------------------------------
.         Check for private practice, get the unique number
.------------------------------------------------------------
UPRI0000  OPEN      PRIHDBT1,"prihdbtf"
          OPEN      PRIHREF1,"prihreff"
.
          PACK      KEY27,URNUMBER,SP70       * Private Practice Holding Header
          CALL      RSPRHD1
          CALL      RKPRHD1 
          BRANCH    OVRCD,UPRI9999
          MATCH     AURNO,PRHDDEBT
          GOTO      UPRI9999 IF NOT EQUAL      * no private practice
.
          PACK      KEY27,PRHDUNIQ,SP70        
          CALL      RSPRHR1
UPRI2000  CALL      RKPRHR1
          BRANCH    OVRCD,UPRI9999
          COMPARE   PRHDUNIQ,PRHRUNIQ         * same unique number ?
          GOTO      UPRI9999 IF NOT EQUAL
.
          COMPARE   ONE,PRHRPINV
          GOTO      UPRI2000 IF NOT EQUAL     * invoice printed already
.
          MOVE      PKNAME,PRHRNAME
          MOVE      PKADD1,PRHRADD1
          MOVE      PKADD2,PRHRADD2
          MOVE      PKSUBR,PRHRADD3
          MOVE      PKPOST,PRHRPOST
          MOVE      PKTELEP,PRHRTELP
          MOVE      PKTELEB,PRHRTELB
          MOVE      PKRELP,PRHRRELP
....      MOVE      PTREMOBL,PRHRMOBL       * field required in PRIHREFD
          CALL      UPPRHR1
          GOTO      UPRI2000
.
UPRI9999  RETURN
+
.------------------------------------------------------------
.  Print Free format labels       *I-903005
.------------------------------------------------------------
FREEFM00  MOVE      ZERO,EXIT
          MATCH     SP70,UPDTTYPE
          GOTO      FREEFM30 IF EQUAL
.
          MATCH     "P",UPDTTYPE
          GOTO      FREEFM10 IF EQUAL
.
          GOTO      FREEFM99
. 
FREEFM10  MOVE      CLABPG,LABCOS
          MOVE      CTYPLAB,LABTYPE
          MOVE      ZERO,READCNT
          TRAP      OVERCOND IF IO
          OPEN      TEMP1,FNAMER
          TRAPCLR   IO
          BRANCH    OVRCD,FREEFM99
.
FREEFM20  READ      TEMP1,SEQ;DIM40
          GOTO      FREEFM25 IF OVER
.
          IF        READCNT >LASTITEM
            GOTO      FREEFM25
          ENDIF
.
          ADD       ONE,READCNT
          STORE     DIM40,READCNT,WLINE1A,WLINE2A,WLINE3A,WLINE4A,WLINE5A:
                                  WLINE6A,WLINE7A,WLINE8A
.
          GOTO      FREEFM20
.
FREEFM25  MATCH     SP70,SETDFPRG
          IF        !@EQUAL
            PACK      KEY20,SETDFPRG,SETDFREP,WBSEUID,SP70
            UNPACK    KEY20,IBPDPID,IBPDREP,IBPDUID
            MOVE      SELPRINT,IBPDPRT   * Printer
            MOVE      SP70,IBPDSPA
            CALL      RAIBPD1
            IF        OVRCD=0
              CALL      UPIBPD1
            ELSE
              CALL      WRIBPD1
            ENDIF
          ENDIF
.
          MOVE      "Free Format Label Printing",SCHEDDSC
          CALL      PATFFLAB
          MOVE      SP70,SCHEDDSC
          GOTO      FREEFM99
.
FREEFM30  CLEAR     WEBTITLE
          MOVE      "Free Format Label Print",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,FREEFM99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      FREEFM99
.
FREEFM99  CLOSE     TEMP1,DELETE
          RETURN
+
.------------------------------------------------------------
. Clear MAB saved variables
.------------------------------------------------------------
CLRMAB00  PACK      SMPOLIC,SP70    * POLICE STAT. ACCT REPORTED TO
          PACK      SMACDAT,SP70    * DATE OF ACCIDENT (YYMMDD)
          PACK      SMSNAME,SP70    * SOLICITOR NAME
          PACK      SMSTELE,SP70    * SOLICITOR TELEPHONE
          PACK      SMCREGO,SP70    * CAR REGO NUMBERS INVOLVED
          PACK      SMACLOC,SP70    * ACCIDENT LOCATION
          MOVE      ZERO,SMDPINDI   * 1= DRIVER, 2= PASSENGER
          PACK      SMENGAGE,SP70   * WHILE ENG IN-FREE FORMAT ENTRY
          PACK      SMPINJUR,SP70   * PATIENT INJURED WHEN
          PACK      SMMDTRAN,SP70   * MODE OF TRANSPORT
          PACK      SMMECHSE,SP70   * MECHANISM OF SEVERIST INJURY
          PACK      SMREGNSE,SP70   * REGION OF SEVERIST INJURY
          PACK      SMOTHDE1,SP70   * OTHER DRIVER DETAILS LINE 1
          PACK      SMOTHDE2,SP70   * "     "      "     LINE 2
          PACK      SMOTHDE3,SP70   * "     "      "     LINE 3
          MOVE      ZERO,SPTWMTAC   * TAC CLAIM FORM COMPLETED ?
          PACK      SPTWMTYP,SP70   * Role in Accident (CAT RA)
CLRMAB99  RETURN
+
.------------------------------------------------------------
. Save MAB variables
.------------------------------------------------------------
SAVMAB00  MOVE      MPOLIC,SMPOLIC      * POLICE STAT. ACCT REPORTED TO
          MOVE      MACDAT,SMACDAT      * DATE OF ACCIDENT (YYMMDD)
          MOVE      MSNAME,SMSNAME      * SOLICITOR NAME
          MOVE      MSTELE,SMSTELE      * SOLICITOR TELEPHONE
          MOVE      MCREGO,SMCREGO      * CAR REGO NUMBERS INVOLVED
          MOVE      MACLOC,SMACLOC      * ACCIDENT LOCATION
          MOVE      MDPINDIC,SMDPINDI   * 1= DRIVER, 2= PASSENGER
          MOVE      MENGAGED,SMENGAGE   * WHILE ENG IN-FREE FORMAT ENTRY
          MOVE      MPINJURE,SMPINJUR   * PATIENT INJURED WHEN
          MOVE      MMDTRANS,SMMDTRAN   * MODE OF TRANSPORT
          MOVE      MMECHSEV,SMMECHSE   * MECHANISM OF SEVERIST INJURY
          MOVE      MREGNSEV,SMREGNSE   * REGION OF SEVERIST INJURY
          MOVE      MOTHDET1,SMOTHDE1   * OTHER DRIVER DETAILS LINE 1
          MOVE      MOTHDET2,SMOTHDE2   * "     "      "     LINE 2
          MOVE      MOTHDET3,SMOTHDE3   * "     "      "     LINE 3
          MOVE      PTWMTACF,SPTWMTAC   * TAC CLAIM FORM COMPLETED ?
          MOVE      PTWMTYPE,SPTWMTYP   * Role in Accident (CAT RA)
SAVMAB99  RETURN
+
.------------------------------------------------------------
. Copy MAB variables from saved variables
.------------------------------------------------------------
COPMAB00  MOVE      SMPOLIC,MPOLIC    * POLICE STAT. ACCT REPORTED TO
          MOVE      SMACDAT,MACDAT    * DATE OF ACCIDENT (YYMMDD)
          MOVE      SMSNAME,MSNAME    * SOLICITOR NAME
          MOVE      SMSTELE,MSTELE    * SOLICITOR TELEPHONE
          MOVE      SMCREGO,MCREGO    * CAR REGO NUMBERS INVOLVED
          MOVE      SMACLOC,MACLOC    * ACCIDENT LOCATION
          MOVE      SMDPINDI,MDPINDIC   * 1= DRIVER, 2= PASSENGER
          MOVE      SMENGAGE,MENGAGED   * WHILE ENG IN-FREE FORMAT ENTRY
          MOVE      SMPINJUR,MPINJURE   * PATIENT INJURED WHEN
          MOVE      SMMDTRAN,MMDTRANS   * MODE OF TRANSPORT
          MOVE      SMMECHSE,MMECHSEV   * MECHANISM OF SEVERIST INJURY
          MOVE      SMREGNSE,MREGNSEV   * REGION OF SEVERIST INJURY
          MOVE      SMOTHDE1,MOTHDET1   * OTHER DRIVER DETAILS LINE 1
          MOVE      SMOTHDE2,MOTHDET2   * "     "      "     LINE 2
          MOVE      SMOTHDE3,MOTHDET3   * "     "      "     LINE 3
          MOVE      SPTWMTAC,PTWMTACF   * TAC CLAIM FORM COMPLETED ?
          MOVE      SPTWMTYP,PTWMTYPE   * Role in Accident (CAT RA)
COPMAB99  RETURN
+
.------------------------------------------------------------
. Clear WC saved variables
.------------------------------------------------------------
CLRWCM00  PACK      SWCENAME,SP70       * EMPLOYER NAME
          PACK      SWCEADD1,SP70       * EMPLOYER ADDRESS LINE 1
          PACK      SWCEADD2,SP70       * EMPLOYER ADDRESS LINE 2
          PACK      SWCEADD3,SP70       * EMPLOYER ADDRESS LINE 3
          PACK      SWCEADD4,SP70       * EMPLOYER ADDRESS LINE 4
          PACK      SWCEPOST,SP70       * EMPLOYER POSTCODE
          PACK      SWCETELE,SP70       * EMPLOYER TELEPHONE
          PACK      SWCACDAT,SP70       * DATE OF ACCIDENT (YYMMDD)
          MOVE      ZERO,SWCACCPT       * ACCEPTED BY INSURANCE COMPANY
          PACK      SWCICODE,SP70       * INSURANCE COMPANY CODE
          PACK      SWCCLMNO,SP70       * INSURANCE CLAIM NUMBER 
          PACK      SWCCOMN1,SP70       * COMMENTS
          PACK      SWCCOMN2,SP70       * COMMENTS
          PACK      SPMWXALO,SP70       * Accident Location                  
          PACK      SPMWXCIN,SP70       * Cause of Injury (Cat IK)           
          PACK      SPMWXICO,SP70       * Injury Code (Cat IJ)               
          PACK      SPMWXCNA,SP70       * Contact Name                       
          PACK      SPMWXECO,SP70       * Employer code
CLRWCM99  RETURN
+
.------------------------------------------------------------
. Save WC  variables
.------------------------------------------------------------
SAVWCM00  MOVE      WCENAME,SWCENAME       * EMPLOYER NAME
          MOVE      WCEADD1,SWCEADD1       * EMPLOYER ADDRESS LINE 1
          MOVE      WCEADD2,SWCEADD2       * EMPLOYER ADDRESS LINE 2
          MOVE      WCEADD3,SWCEADD3       * EMPLOYER ADDRESS LINE 3
          MOVE      WCEADD4,SWCEADD4       * EMPLOYER ADDRESS LINE 4
          MOVE      WCEPOST,SWCEPOST       * EMPLOYER POSTCODE
          MOVE      WCETELE,SWCETELE       * EMPLOYER TELEPHONE
          MOVE      WCACDAT,SWCACDAT       * DATE OF ACCIDENT (YYMMDD)
          MOVE      WCACCPT,SWCACCPT       * ACCEPTED BY INSURANCE COMPANY
          MOVE      WCICODE,SWCICODE       * INSURANCE COMPANY CODE
          MOVE      WCCLMNO,SWCCLMNO       * INSURANCE CLAIM NUMBER 
          MOVE      WCCOMN1,SWCCOMN1       * COMMENTS
          MOVE      WCCOMN2,SWCCOMN2       * COMMENTS
          MOVE      PMWXALOC,SPMWXALO      * Accident Location                  
          MOVE      PMWXCINJ,SPMWXCIN      * Cause of Injury (Cat IK)           
          MOVE      PMWXICOD,SPMWXICO      * Injury Code (Cat IJ)               
          MOVE      PMWXCNAM,SPMWXCNA      * Contact Name                       
          MOVE      PMWXECOD,SPMWXECO      * Employer code
SAVWCM99  RETURN
+
.------------------------------------------------------------
. Copy WC  variables from saved variables
.------------------------------------------------------------
COPWCM00  MOVE      SWCENAME,WCENAME       * EMPLOYER NAME
          MOVE      SWCEADD1,WCEADD1       * EMPLOYER ADDRESS LINE 1
          MOVE      SWCEADD2,WCEADD2       * EMPLOYER ADDRESS LINE 2
          MOVE      SWCEADD3,WCEADD3       * EMPLOYER ADDRESS LINE 3
          MOVE      SWCEADD4,WCEADD4       * EMPLOYER ADDRESS LINE 4
          MOVE      SWCEPOST,WCEPOST       * EMPLOYER POSTCODE
          MOVE      SWCETELE,WCETELE       * EMPLOYER TELEPHONE
          MOVE      SWCACDAT,WCACDAT       * DATE OF ACCIDENT (YYMMDD)
          MOVE      SWCACCPT,WCACCPT       * ACCEPTED BY INSURANCE COMPANY
          MOVE      SWCICODE,WCICODE       * INSURANCE COMPANY CODE
          MOVE      SWCCLMNO,WCCLMNO       * INSURANCE CLAIM NUMBER 
          MOVE      SWCCOMN1,WCCOMN1       * COMMENTS
          MOVE      SWCCOMN2,WCCOMN2       * COMMENTS
          MOVE      SPMWXALO,PMWXALOC      * Accident Location                  
          MOVE      SPMWXCIN,PMWXCINJ      * Cause of Injury (Cat IK)
          MOVE      SPMWXICO,PMWXICOD      * Injury Code (Cat IJ) 
          MOVE      SPMWXCNA,PMWXCNAM      * Contact Name    
          MOVE      SPMWXECO,PMWXECOD      * Employer Code
COPWCM99  RETURN
+
.------------------------------------------------------------
.  Maintain Medical Records MBS                        
.------------------------------------------------------------
PATMMB00  MOVE      ZERO,EXIT
          MATCH     SP70,UPDTTYPE
          GOTO      PATMMB80 IF EQUAL
.
          MATCH     "A",UPDTTYPE
          GOTO      PATMMB10 IF EQUAL
.
          MATCH     "U",UPDTTYPE
          GOTO      PATMMB20 IF EQUAL
.
          MATCH     "D",UPDTTYPE
          GOTO      PATMMB30 IF EQUAL
.
          GOTO      PATMMB90
.
PATMMB10  PACK      KEY11,PTMMB002,Z70
          CALL      RDSMMBS1
          CALL      RDPMMBS1
          BRANCH    OVRCD,PATMMB12
.
          MATCH     MMADMN,PTMMB002
          GOTO      PATMMB12 IF NOT EQUAL
.
          MOVE      MMRECN,PTMMB003
          ADD       ONE,PTMMB003
          GOTO      PATMMB14
.
PATMMB12  MOVE      ONE,PTMMB003
.
PATMMB14  PACK      KEY11,PTMMB002,PTMMB003,SP70
          CALL      RDMMBS1
          COMPARE   ZERO,OVRCD
          GOTO      PATMMB92 IF EQUAL
.
          MOVE      PTMMB001,MMCODE
          MOVE      PTMMB002,MMADMN
          MOVE      PTMMB003,MMRECN
          MOVE      PTMMB004,MMDATE
          MOVE      PTMMB005,MMSTIM
          MOVE      PTMMB006,MMETIM
          MOVE      SP70,PTMMDESC
          UNPACK    SP70,PTMMOPID,PTMMTMNO
          MOVE      SP70,PTMMEDAT
          MOVE      SP70,PTMMRPST
          MOVE      SP70,PTMMRPET
          MOVE      SP70,PTMMVAID
          MOVE      SP70,PTMMAPRA
.
          PACK      KEY11,PTMMB002,PTMMB003,SP70
          CALL      WRMMBS1
          MOVE      ZERO,EXIT
          GOTO      PATMMB99
.
PATMMB20  PACK      KEY11,PTMMB002,PTMMB003,SP70
          CALL      RDMMBS1
          BRANCH    OVRCD,PATMMB93
.
          MOVE      PTMMB004,MMDATE
          MOVE      PTMMB005,MMSTIM
          MOVE      PTMMB006,MMETIM
          CALL      UPMMBS1
          MOVE      ZERO,EXIT
          GOTO      PATMMB99
.
PATMMB30  PACK      KEY11,PTMMB002,PTMMB003,SP70
          CALL      RDMMBS1
          BRANCH    OVRCD,PATMMB93
.
          CALL      DEMMBS1
          MOVE      ZERO,EXIT
          GOTO      PATMMB99
.
PATMMB80  MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,PATMMB90
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF 
.
          PACK      KEY20,PTMMB001,PTMMB002,PTMMB003,SP70
          CALL      RDMMBS2
          IF        OVRCD=1
            CALL      CLMMBS00
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Maintain MBS Coding",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,PATMMB99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      PATMMB99
.
PATMMB90  MOVE     "Cannot find Patient Master Record.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PATMMB99
.
PATMMB91  MOVE     "Cannot find Patient Admission Record.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PATMMB99
.
PATMMB92  MOVE     "MBS Coding Record already exists.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PATMMB99
.
PATMMB93  MOVE     "MBS Coding Record does not exist.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PATMMB99
.
PATMMB99  RETURN
+
.------------------------------------------------------------
. Clear Medical Records MBS                 
.------------------------------------------------------------
CLMMBS00  MOVE      SP70,MMCODE
          MOVE      ZEROVISN,MMADMN
          MOVE      ZERO,MMRECN
          MOVE      SP70,MMDATE
          MOVE      SP70,MMSTIM
          MOVE      SP70,MMETIM
          MOVE      SP70,PTMMDESC
          UNPACK    SP70,PTMMOPID,PTMMTMNO
.
CLMMBS99  RETURN
+
.------------------------------------------------------------
. Process Fields in Body of HTML Template
.------------------------------------------------------------
PROFLD00  BRANCH    REPORTNO,PROFLD10,PROFLD20,PROFLD30,PROFLD40,PROFLD99:
                             PROFLD99,PROFLD70,PROFLD80,PROFLD90,PROFL100:
                             PROFL110
          GOTO      PROFLD99
.
PROFLD10  BRANCH    FLDSETNO,PROFLD11,PROFLD12,PROFLD13,PROFLD14,PROFLD15:
                             PROFLD16,PROFLD17,PROFLD18,PROFLD19,PROFL191
          GOTO      PROFLD99
.
.         ********* PROFLD19 ADDED BY HPS BLR
.
PROFLD11  CALL      MASF0000
          GOTO      PROFLD99
.
PROFLD12  CALL      MISF0000
          GOTO      PROFLD99
.
PROFLD13  CALL      DSCF0000
          GOTO      PROFLD99
.
PROFLD14  CALL      TABL0000     * Table Displays
          GOTO      PROFLD99
.
PROFLD15  CALL      BREC0000     * Patient Bookings Details
          GOTO      PROFLD99
.
PROFLD16  CALL      MSXF0000     * Master Extension Details
          GOTO      PROFLD99
.
.                                * DRG Information & Episodic/Admission dates
PROFLD17  IF        FLDITMNO < 50
            CALL      DRGS0000     * DRG Information
          ELSE
            CALL      OTHS0000     * Other Info (only way I could get it in)
          ENDIF
          GOTO      PROFLD99
.
PROFLD18  CALL      PMIX0000     * Master Extension Details Two
          GOTO      PROFLD99
.
PROFLD19  CALL      PFND0000
          GOTO      PROFLD99
.
PROFL191  CALL      VISF0000
          GOTO      PROFLD99
.
PROFLD20  BRANCH    FLDSETNO,PROFLD21,PROFLD22
          GOTO      PROFLD99
.
PROFLD21  CALL      MISC0000     * Miscellaneous outputs
          GOTO      PROFLD99
.
PROFLD22  CALL      TABL0000     * Table Displays
          GOTO      PROFLD99
.
.
.  Previous Address Details
.
PROFLD30  BRANCH    FLDSETNO,PROFLD31
          GOTO      PROFLD99
.
PROFLD31  CALL      PRVA0000     * Previous Address Details 
          GOTO      PROFLD99
.
.  Diet and Nutrition information
.
PROFLD40  BRANCH    FLDSETNO,PROFLD41,PROFLD42,PROFLD43,PROFLD44,PROFLD45:
                             PROFLD46,PROFLD47
          GOTO      PROFLD99
.
PROFLD41  CALL      MASF0000     * Get PMI master file fields.        
          GOTO      PROFLD99
.
PROFLD42  CALL      MISF0000     * Get Admission master file fieldS   
          GOTO      PROFLD99
.
PROFLD43  CALL      PNUT0000     * Get Nutrition information
          GOTO      PROFLD99
.
PROFLD44  CALL      PRDT0000     * Get Program specific Diet information
          GOTO      PROFLD99
.
PROFLD45  CALL      VISF0000     * Get Diet Comment - I SRF 22685
          GOTO      PROFLD99
.
PROFLD46  CALL      CLMF0000
          GOTO      PROFLD99
.
PROFLD47  CALL      CCOM0000     * Get Extra Diet information
          GOTO      PROFLD99
.
PROFLD70  BRANCH    FLDSETNO,PROFLD71,PROFLD72,PROFLD73
          GOTO      PROFLD99
.
PROFLD71  CALL      MASF0000
          GOTO      PROFLD99
.
PROFLD72  CALL      MISF0000
          GOTO      PROFLD99
.
PROFLD73  CALL      PMMB0000
          GOTO      PROFLD99
.
PROFLD80  BRANCH    FLDITMNO,PROFLD81
...       GOTO      PROFLD99
PROFLD81  CALL      ACCTAB00                * ACC Xmit Status List
          GOTO      PROFLD99
.
PROFLD90  BRANCH    FLDSETNO,PROFLD91,PROFLD92,PROFLD93
          GOTO      PROFLD99
.
PROFLD91  CALL      MASF0000
          GOTO      PROFLD99
.
PROFLD92  CALL      MISF0000
          GOTO      PROFLD99
.
PROFLD93  CALL      VISF0000
          GOTO      PROFLD99
.
PROFL100  BRANCH    FLDSETNO,PROFL101,PROFL102,PROFL103,PROFL104,PROFL105:
                             PROFL106
          GOTO      PROFLD99
.
PROFL101  CALL      MASF0000
          GOTO      PROFLD99
.
PROFL102  CALL      TABL0000     * Table Displays
          GOTO      PROFLD99
.
PROFL103  CALL      MISC0000     * misc fields
          GOTO      PROFLD99
.
PROFL104  CALL      MISF0000     * admission fields
          GOTO      PROFLD99
.
PROFL105  CALL      DSCF0000     * discharge fields
          GOTO      PROFLD99
.
PROFL106  CALL      VISF0000
          GOTO      PROFLD99
.
.  Previous HCP Details
.
PROFL110  BRANCH    FLDSETNO,PROFL111
          GOTO      PROFLD99
.
PROFL111  CALL      PRHC0000     * Previous HCP/Practice Details
          GOTO      PROFLD99
.
PROFLD99  RETURN
+
.------------------------------------------------------------
. Medical Record MBS Fields                    
.------------------------------------------------------------
PMMB0000  BRANCH    FLDITMNO,PMMB0100,PMMB0200,PMMB0300,PMMB0400,PMMB0500:
                             PMMB0600,PMMB0700
          GOTO      PMMB9999
.
PMMB0100  UNPACK    DIM127,D1,KEY1,DIM127     
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,PMMB0110 
.
          PACK      KEY17,MMCODE,SP70
          CALL      PATITMRD          * Read item file
          IF        OVRCD=1
            MOVE      "Invalid Code",IDESC
          ENDIF
.
          WRITE     HTMLFILE;IDESC;
          GOTO      PMMB9999
.
PMMB0110  WRITE     HTMLFILE;MMCODE;
          GOTO      PMMB9999
.
PMMB0200  WRITE     HTMLFILE;MMADMN;
          GOTO      PMMB9999
.
PMMB0300  WRITE     HTMLFILE;MMRECN;
          GOTO      PMMB9999
.
PMMB0400  MATCH     SP70,MMDATE
          GOTO      PMMB9999 IF EQUAL
          UNPACK    MMDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          WRITE     HTMLFILE;KEY11;
          GOTO      PMMB9999
.
PMMB0500  WRITE     HTMLFILE;MMSTIM;
          GOTO      PMMB9999
.
PMMB0600  WRITE     HTMLFILE;MMETIM;
          GOTO      PMMB9999
.
PMMB0700  WRITE     HTMLFILE;PTMMDESC;
          GOTO      PMMB9999
.
PMMB9999  RETURN
+
.------------------------------------------------------------
. Miscellaneous outputs for report option 2 
.------------------------------------------------------------
MISC0000  BRANCH    FLDITMNO,MISC0100,MISC0200,MISC0300,MISC0400,MISC0500:
                             MISC0600,MISC0700,MISC0800,MISC0900,MISC1000:
                             MISC1100,MISC1200,MISC1300,MISC1400,MISC1500:
                             MISC1600,MISC1700,MISC1800,MISC1900,MISC2000:
                             MISC2100
          GOTO      MISC9999
.
MISC0100  READ      CONTROLF,TEN;*196,CGENRUR
          WRITE     HTMLFILE;CGENRUR;
          GOTO      MISC9999
.
MISC0200  READ      CONTROLF,HUND10;*240,PTCNUALT
          WRITE     HTMLFILE;PTCNUALT;
          GOTO      MISC9999
.
MISC0300  CALL      CFAD0000                * Admission FIM Exists    CAR 257776
          GOTO      MISC9999
.
MISC0400  CALL      CFDS0000                * Discharge FIM Exists    CAR 257776
          GOTO      MISC9999
.
MISC0500  MOVE      SP70,DFLTWARD
          CALL      WSEL0000
          GOTO      MISC9999
.
MISC0600  WRITE     HTMLFILE;TRNSUPTY;
          GOTO      MISC9999
.
MISC0700  WRITE     HTMLFILE;WARDBED;
          GOTO      MISC9999
.
MISC0800  WRITE     HTMLFILE;DOCFNAME;
          GOTO      MISC9999
.
MISC0900  WRITE     HTMLFILE;ATYPDESC;
          GOTO      MISC9999
.
MISC1000  WRITE     HTMLFILE;CODDESC;
          GOTO      MISC9999
.
MISC1100  WRITE     HTMLFILE;UNITDESC;
          GOTO      MISC9999
.
MISC1200  WRITE     HTMLFILE;DIM20;
          GOTO      MISC9999
.
MISC1300  MATCH     SP70,TDATE
          GOTO      MISC9999 IF EQUAL
          UNPACK    TDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2

          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          WRITE     HTMLFILE;KEY11;
          GOTO      MISC9999
.
MISC1400  WRITE     HTMLFILE;TTIME;
          GOTO      MISC9999
.
MISC1500  WRITE     HTMLFILE;TRANSKEY;
          GOTO      MISC9999
.
MISC1600  MOVE      "cx",CATEGORY
          PACK      CODE,PMVXFSRC,SP70
          CALL      CODITM00
          GOTO      MISC9999
.
MISC1700  WRITE     HTMLFILE;URNUMBER;
          GOTO      MISC9999
.
MISC1800  WRITE     HTMLFILE;PMARQ001;
          GOTO      MISC9999
.
MISC1900  WRITE     HTMLFILE;CLINICAL;
          GOTO      MISC9999
.
MISC2000  WRITE     HTMLFILE;WAHEALTH;
          GOTO      MISC9999
.
MISC2100  MOVE      "RB",CATEGORY
          PACK      CODE,SP70
          CALL      CODITM00
          GOTO      MISC9999
.
MISC9999  RETURN
+
.------------------------------------------------------------
. Diet and Nutrition program specific items 
.------------------------------------------------------------
PRDT0000  BRANCH    FLDITMNO,PRDT0100,PRDT0200,PRDT0300,PRDT0400,PRDT0500:
                             PRDT0600,PRDT0700,PRDT0800,PRDT0900,PRDT1000
          GOTO      PRDT9999
.
PRDT0100  CALL      NEXT0000                   * Get next date
          GOTO      PRDT9999
.
PRDT0200  CALL      PREV0000                   * Get previous date
          GOTO      PRDT9999
.
PRDT0300  CALL      SELV0000                   * Display current date box
          GOTO      PRDT9999
.
PRDT0400  WRITE     HTMLFILE;VIEWTYPE;         * output viewtype         
          GOTO      PRDT9999
.
PRDT0500  WRITE     HTMLFILE;LASTDATE;         * output selected date    
          GOTO      PRDT9999
.
PRDT0600  WRITE     HTMLFILE;NONXTPAT;         * no next patient redirect
          GOTO      PRDT9999
.
PRDT0700   MATCH     SP70,PMNUDIET
          IF        !@EQUAL
            MOVE      PMNUDIET,CODE
          ELSE
            MOVE      ADIET,CODE
          ENDIF
          MOVE      "DC",CATEGORY              * Diet Code (Cat DC)
          CALL      CODITM00
          GOTO      PRDT9999
.
PRDT0800  CALL      SELDT000                   * current date box (no submit)
          GOTO      PRDT9999
.
PRDT0900  WRITE     HTMLFILE;EMVIADMN;         * ED visit number          
          GOTO      PRDT9999
.
.
PRDT1000  WRITE     HTMLFILE;PWDVTYPE;         * output viewtype         
          GOTO      PRDT9999
PRDT9999  RETURN
.------------------------------------------------------------
. Date selection from Admission Date to Current Date
.------------------------------------------------------------
DATSEL00  MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,DATSEL99
.
          CALL      IBACLOCK
          PACK      TODAY,CCC,CYY,CMM,CDD
          REP       " 0",TODAY
.
          UNPACK    TODAY,CCENT,CYEAR,CMON,CDAY
          MOVE      ZERO,FAILCNT
.
DATSEL10  PACK      KEY8,CCENT,CYEAR,CMON,CDAY
          REP       " 0",KEY8
          MATCH     ADATE,KEY8
          GOTO      DATSEL99 IF LESS
.
          ADD       ONE,FAILCNT
          MATCH     TODAY,KEY8
          IF        @EQUAL
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            WRITE     HTMLFILE;"<option value=#"",KEY8,"#" selected>",CDAY,SP1:
                                MTHNAM3,SP1,CCENT,CYEAR,"</option>";
          ELSE
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            WRITE     HTMLFILE;"<option value=#"",KEY8,"#">",CDAY,SP1:
                                 MTHNAM3,SP1,CCENT,CYEAR,"</option>";
          ENDIF
.
          MOVE      "-1",ADJDAYS
          CALL      ADJDAT00
          IF        FAILCNT<150
            GOTO      DATSEL10
          ENDIF
DATSEL99  RETURN
.------------------------------------------------------------
. Next Day, Week, Month
.------------------------------------------------------------
NEXT0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
.
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
          REP       " +",URNUMBER
          REP       " +",ADMISSNO 
.
          WRITE     HTMLFILE;"patweb98.pbl":
                             "?reportno=",KEY2:
                             "&template=",KEY3:
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO:
                             "&frstdate=",NXTFDATE:
                             "&viewtype=",VIEWTYPE:
                             "&lastdate=",NXTLDATE:
                             "&unitcode=",UNITCODE:
                             "&srchtype=",SRCHTYPE;
.
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO 
.
NEXT9999  RETURN
.------------------------------------------------------------
. Previous Day, Week, Month
.------------------------------------------------------------
PREV0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
.
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
          REP       " +",URNUMBER
          REP       " +",ADMISSNO 
.
          WRITE     HTMLFILE;"patweb98.pbl":
                             "?reportno=",KEY2:
                             "&template=",KEY3:
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO:
                             "&frstdate=",PREFDATE:
                             "&viewtype=",VIEWTYPE:
                             "&lastdate=",PRELDATE:
                             "&unitcode=",UNITCODE:
                             "&srchtype=",SRCHTYPE;
.
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO 
.
PREV9999  RETURN
.------------------------------------------------------------
. Table Outputs (Visit, Transfers, etc)
.------------------------------------------------------------
PRVA0000  BRANCH    FLDITMNO,PRVA0100,PRVA0200,PRVA0300,PRVA0400,PRVA0500:
                             PRVA0600,PRVA0700,PRVA0800,PRVA0900,PRVA1000:
                             PRVA1100,PRVA1200,PRVA1300,PRVA1400,PRVA1500:
                             PRVA1600,PRVA1700,PRVA1800,PRVA1900,PRVA2000
          GOTO      PRVA9999
.
PRVA0100  MATCH     SP70,PAURNO            * UR
          GOTO      PRVA9999 IF EQUAL
          WRITE     HTMLFILE;PAURNO; 
          GOTO      PRVA9999
.
PRVA0200  MATCH     SP70,PADATE            * Date Details Changed
          GOTO      PRVA9999 IF EQUAL
          UNPACK    PADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2

          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          WRITE     HTMLFILE;KEY11; 
          GOTO      PRVA9999
.
PRVA0300  MATCH     SP70,PAADD1            * Previous Address Line 1 
          GOTO      PRVA9999 IF EQUAL
          WRITE     HTMLFILE;PAADD1; 
          GOTO      PRVA9999
.
PRVA0400  MATCH     SP70,PAADD2            * Previous Address Line 2 
          GOTO      PRVA9999 IF EQUAL
          WRITE     HTMLFILE;PAADD2; 
          GOTO      PRVA9999
.
PRVA0500  MATCH     SP70,PASUBR            * Previous Suburb 
          GOTO      PRVA9999 IF EQUAL
          WRITE     HTMLFILE;PASUBR; 
          GOTO      PRVA9999
.
PRVA0600  MATCH     SP70,PAADD4            * Previous Address Line 4
          GOTO      PRVA9999 IF EQUAL
          WRITE     HTMLFILE;PAADD4; 
          GOTO      PRVA9999
.
PRVA0700  MATCH     SP70,PAPOST            * Previous Post Code 
          GOTO      PRVA9999 IF EQUAL
          WRITE     HTMLFILE;PAPOST; 
          GOTO      PRVA9999
.
PRVA0800  MATCH     SP70,PATELEP           * Previous Private Telephone 
          GOTO      PRVA9999 IF EQUAL
          WRITE     HTMLFILE;PATELEP; 
          GOTO      PRVA9999
.
PRVA0900  MATCH     SP70,PATELEB           * Previous Business Telephone 
          GOTO      PRVA9999 IF EQUAL
          WRITE     HTMLFILE;PATELEB; 
          GOTO      PRVA9999
.
PRVA1000  MATCH     SP70,PTPADOR           * Previous District of Residence 
          GOTO      PRVA9999 IF EQUAL
          WRITE     HTMLFILE;PTPADOR; 
          GOTO      PRVA9999
.
PRVA1100  MATCH     SP70,PTPAMOBL          * Previous Cellular Phone 
          GOTO      PRVA9999 IF EQUAL
          WRITE     HTMLFILE;PTPAMOBL; 
          GOTO      PRVA9999
.
PRVA1200  MATCH     SP70,PTPAWEBU          * Web User ID 
          GOTO      PRVA9999 IF EQUAL
          PACK      KEY10,PTPAWEBU
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      PTPAWEBU,WBSENAM
          ENDIF
          WRITE     HTMLFILE;WBSENAM; 
          GOTO      PRVA9999
. 
PRVA1300  MATCH     SP70,PTPAEMAL          * Email Address 
          GOTO      PRVA9999 IF EQUAL
          WRITE     HTMLFILE;PTPAEMAL; 
          GOTO      PRVA9999
. 
PRVA14000 MATCH     SP70,PTPACDTE          * Date Record Created
          GOTO      PRVA9999 IF EQUAL
          UNPACK    PTPACDTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          GOTO      PRVA9999
.
PRVA1500  MATCH     SP70,PTPACTIM          * Time record created
          GOTO      PRVA9999 IF EQUAL
          WRITE     HTMLFILE;PTPACTIM; 
          GOTO      PRVA9999
. 
PRVA1600  MATCH     SP70,PTPAWEBC          * Web User ID creator
          GOTO      PRVA9999 IF EQUAL
          PACK      KEY10,PTPAWEBC
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      PTPAWEBC,WBSENAM
          ENDIF
          WRITE     HTMLFILE;WBSENAM; 
          GOTO      PRVA9999
. 
PRVA17000 MATCH     SP70,PTPALUPD          * Date Last Updated   
          GOTO      PRVA9999 IF EQUAL
          UNPACK    PTPALUPD,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          GOTO      PRVA9999
. 
PRVA1800  MATCH     SP70,PTPALUPT          * Time Last Updated
          GOTO      PRVA9999 IF EQUAL
          WRITE     HTMLFILE;PTPALUPT; 
          GOTO      PRVA9999
. 
PRVA1900  MATCH     SP70,PATIME            * Time Details Changed
          GOTO      PRVA9999 IF EQUAL
          WRITE     HTMLFILE;PATIME; 
          GOTO      PRVA9999
. 
PRVA2000  MATCH     "1",PTPAOSMS           * Opt out of SMS
          IF        @EQUAL
            WRITE     HTMLFILE;DYES;
          ELSE
            WRITE     HTMLFILE;DNO;
          ENDIF
          GOTO      PRVA9999
.
PRVA9999  RETURN
.-------------------------------------------------------------------------------
. Output Previous HCP/Practice Details
.-------------------------------------------------------------------------------
PRHC0000  BRANCH    FLDITMNO,PRHC0100,PRHC0200,PRHC0300,PRHC0400,PRHC0500:
                             PRHC0600,PRHC0700,PRHC0800,PRHC0900,PRHC1000:
                             PRHC1100,PRHC1200,PRHC1300,PRHC1400,PRHC1500
          GOTO      PRHC9999
.
PRHC0100  MATCH     SP70,PMDEURNO            * UR
          GOTO      PRHC9999 IF EQUAL
          WRITE     HTMLFILE;PMDEURNO;
          GOTO      PRHC9999
.
PRHC0200  MATCH     SP70,PMDECDAT            * Date Details Changed
          GOTO      PRHC9999 IF EQUAL
          UNPACK    PMDECDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2

          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          WRITE     HTMLFILE;KEY11;
          GOTO      PRHC9999
.
PRHC0300  MATCH     SP70,PMDECTIM           * Time Details Changed
          GOTO      PRHC9999 IF EQUAL
          WRITE     HTMLFILE;PMDECTIM;
          GOTO      PRHC9999
.
PRHC0400  MATCH     SP70,PMDERTYP           * Type of Record
          GOTO      PRHC9999 IF EQUAL
          WRITE     HTMLFILE;PMDERTYP;
          GOTO      PRHC9999
.
PRHC0500  MATCH     SP70,PMDEFL01           * Previous HCP
          GOTO      PRHC9999 IF EQUAL
          PACK      KEY10,PMDEFL01
          CALL      RDPMHCP1
          IF        OVRCD=1
            MOVE      SP70,DOCFNAME
          ELSE
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
          ENDIF
          WRITE     HTMLFILE;DOCFNAME;
          GOTO      PRHC9999
.
PRHC0600  MATCH     SP70,PMDEFL02           * Previous HCP Practice
          GOTO      PRHC9999 IF EQUAL
          PACK      KEY10,PMDEFL02
          PACK      KEY12,KEY10,PMDEFL03
          CALL      RDPMHCG1
          IF        OVRCD=1
            MOVE      SP70,PMHGPNAM
          ENDIF
          WRITE     HTMLFILE;PMHGPNAM;
          GOTO      PRHC9999
.
PRHC0700  MATCH     SP70,PMDEFL03           * Previous HCP Practice Count
          GOTO      PRHC9999 IF EQUAL
          WRITE     HTMLFILE;PMDEFL03;
          GOTO      PRHC9999
.
PRHC0800  MATCH     SP70,PMDEFL04           * Field 4
          GOTO      PRHC9999 IF EQUAL
          WRITE     HTMLFILE;PMDEFL04;
          GOTO      PRHC9999
.
PRHC0900  MATCH     SP70,PMDEFL05           * Field 5
          GOTO      PRHC9999 IF EQUAL
          WRITE     HTMLFILE;PMDEFL05;
          GOTO      PRHC9999
.
PRHC1000  MATCH     SP70,PMDEFL06           * Field 6
          GOTO      PRHC9999 IF EQUAL
          WRITE     HTMLFILE;PMDEFL06;
          GOTO      PRHC9999
.
PRHC1100  MATCH     SP70,PMDEFL07           * Field 7
          GOTO      PRHC9999 IF EQUAL
          WRITE     HTMLFILE;PMDEFL07;
          GOTO      PRHC9999
.
PRHC1200  MATCH     SP70,PMDEFL08           * Field 8
          GOTO      PRHC9999 IF EQUAL
          WRITE     HTMLFILE;PMDEFL08;
          GOTO      PRHC9999
.
PRHC1300  MATCH     SP70,PMDEFL09           * Field 9
          GOTO      PRHC9999 IF EQUAL
          WRITE     HTMLFILE;PMDEFL09;
          GOTO      PRHC9999
.
PRHC1400  MATCH     SP70,PMDEFL10           * Field 10
          GOTO      PRHC9999 IF EQUAL
          WRITE     HTMLFILE;PMDEFL10;
          GOTO      PRHC9999
.
PRHC1500  MATCH     SP70,PMDECUID           * Web User ID
          GOTO      PRHC9999 IF EQUAL
          PACK      KEY10,PMDECUID
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      PMDECUID,WBSENAM
          ENDIF
          WRITE     HTMLFILE;WBSENAM;
          GOTO      PRHC9999

PRHC9999  RETURN
.---------------------------------------------------------------------
.         ********    HPS BLR  CODE STARTS HERE   ********* 
.         Display of the Following Fields                   
.                   Special Funding Arrangement
.                   Program Funding Source
.                   Hospital Transferred From
.---------------------------------------------------------------------
PFND0000  BRANCH    FLDITMNO,PFND0100,PFND0200,PFND0300,PFND0400,PFND0500:
                             PFND0600,PFND0700,PFND0800,PFND0900,PFND1000:
                             PFND1100,PFND1200,PFND1300,PFND1400,PFND1500:
                             PFND1600,PFND1700,PFND1800,PFND1900,PFND2000:
                             PFND2100,PFND2200,PFND2300,PFND2400,PFND2500:
                             PFND2600,PFND2700,PFND2800,PFND2900,PFND3000:
                             PFND3100,PFND3200,PFND3300,PFND3400,PFND3500:
                             PFND3600,PFND3700,PFND3800,PFND3900,PFND4000:
                             PFND4100,PFND4200,PFND4300,PFND4400,PFND4500:
                             PFND4600,PFND4700,PFND4800,PFND4900,PFND5000:
                             PFND5100,PFND5200,PFND5300,PFND5400,PFND5500:
                             PFND5600,PFND5700,PFND5800,PFND5900,PFND6000:
                             PFND6100,PFND6200,PFND6300,PFND6400,PFND6500:
                             PFND6600,PFND6700,PFND6800,PFND6900,PFND7000:
                             PFND7100,PFND7200,PFND7300,PFND7400,PFND7500:
                             PFND7600,PFND7700,PFND7800,PFND7900,PFND8000:
                             PFND8100,PFND8200,PFND8300,PFND8400,PFND8500:
                             PFND8600,PFND8700,PFND8800,PFND8900,PFND9000:
                             PFND9100,PFND9200,PFND9300,PFND9400,PFND9500:
                             PFND9600,PFND9700,PFND9800,PFND9900
          WRITE     HTMLFILE;"Invalid Tag";
          GOTO      PFND9999
.
PFND0100  PACK      KEY25,ADMISSNO,SP70
          CALL      RSPTASF1
          CALL      RKPTASF1
          BRANCH    OVRCD,PFND9999
.
          MATCH     ADMISSNO,DPTAFADM 
          GOTO      PFND9999 IF NOT EQUAL
.
          PACK      KEY1,PTAFCODE,SP70
          CALL      RDPTSFA1
          BRANCH    OVRCD,PFND9999
.
          WRITE     HTMLFILE;PTSFDESC;   * Special funding arrangement desc
          GOTO      PFND9999
.
PFND0200  PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,PFND9999
.
          MOVE      "CC",KEY2
          PACK      KEY5,KEY2,ACARE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,PFND9999
.
          WRITE     HTMLFILE;TCINDC4;   * Care Class indicator 4.
          GOTO      PFND9999
.
PFND0300  PACK      KEY8,ADMISSNO,SP70
          CALL      RDPTDAD1
          BRANCH    OVRCD,PFND9999
.
          PACK      KEY5,PTDAADTS,SP70
          CALL      RDPTVAD1            
          BRANCH    OVRCD,PFND9999
.    
          WRITE     HTMLFILE;PTVADESC;   * Admission Transfer Source Desc
          GOTO      PFND9999
.
PFND0400  MOVE      "VB",CATEGORY  * Tag should not be used,exists in VISF0000
          MOVE      PMVXCADM,CODE
          CALL      CODITM00
          GOTO      PFND9999
.
PFND0500  MOVE      "VI",CATEGORY  * Tag should not be used,exists in VISF0000
          MOVE      PMVXIDUS,CODE
          CALL      CODITM00
          GOTO      PFND9999
.
.PFND0600  UNPACK    DIM127,D1,KEY1,DIM127      * D SRF 17693
.          MOVE      ZERO,F1
.          MOVE      KEY1,F1
.          BRANCH    F1,PFND0610
.          WRITE     HTMLFILE;PMVXAPWD
.          GOTO      PFND9999
.
.PFND0610  PACK      KEY6,PMVXAPWD,SP70
.          CALL      RDWARD1
.          BRANCH    OVRCD,PFND9999
.          WRITE     HTMLFILE;WBDESC
.          GOTO      PFND9999                   * end D SRF 17693
.
.* Following tag should not be used,exists in VISF0000
.
PFND0600  MOVE      "ap",CATEGORY               * I SRF 17693
          MOVE      PMVXAPWD,CODE               * Set parameter
          CALL      CODITM00                    * Look in patcodes for desc
          GOTO      PFND9999                    * end I SRF 17693 
.
PFND0700  MOVE      "VM",CATEGORY   * Tag should not be used,exists in VISF0000
          MOVE      PMVXMDAV,CODE
          CALL      CODITM00
          GOTO      PFND9999
.
PFND0800  WRITE     HTMLFILE;PMVXVLOC; * should not be used,exists in VISF0000
          GOTO      PFND9999
.
.* Following tag should not be used,exists in VISF0000
.
PFND0900  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,PFND0910
.
          WRITE     HTMLFILE;PMVXCFSG;
          GOTO      PFND9999
.
PFND0910  MATCH     "0",PMVXCFSG
          IF        @EQUAL
            WRITE     HTMLFILE;"NO";
          ELSE
            WRITE     HTMLFILE;"YES";
          ENDIF
          GOTO      PFND9999
.
PFND1000  PACK      KEY3,PTWDHOSN,SP70
          CALL      RDPTHSP1
          BRANCH    OVRCD,PFND9999
.
          WRITE     HTMLFILE;PTHSNAME;
          GOTO      PFND9999
.
PFND1100  WRITE     HTMLFILE;PMVXAPBD; * should not be used,exists in VISF0000
          GOTO      PFND9999        
.
PFND1200  PACK      KEY8,ADMISSNO,SP70
          CALL      RDPTDAD1
          BRANCH    OVRCD,PFND9999
.
          PACK      KEY5,PTDADCTS,SP70
          CALL      RDPTVAD1
          BRANCH    OVRCD,PFND9999
.
          WRITE     HTMLFILE;PTVADESC;    * Discharge Transfer Source Desc
          GOTO      PFND9999
.
PFND1300  CALL      DISWRD00              * discharge ward
          WRITE     HTMLFILE;DISWARD;
          GOTO      PFND9999        
.
PFND1400  CALL      DISWRD00              * discharge unit
          WRITE     HTMLFILE;DISUNIT;
          GOTO      PFND9999
.
PFND1500  IF        CODEDFLG=0
            WRITE     HTMLFILE;"<option value=0 selected>All</option>"
            WRITE     HTMLFILE;"<option value=1>Incomplete Coded</option>"
            WRITE     HTMLFILE;"<option value=2>Complete Coded</option>"
          ELSE
            IF        CODEDFLG=1
              WRITE     HTMLFILE;"<option value=0>All</option>"
              WRITE     HTMLFILE;"<option value=1 selected>":
                                 "Incomplete Coded</option>"
              WRITE     HTMLFILE;"<option value=2>Complete Coded</option>"
            ELSE
              IF        CODEDFLG=2
                WRITE     HTMLFILE;"<option value=0>All</option>"
                WRITE     HTMLFILE;"<option value=1>Incomplete Coded</option>"
                WRITE     HTMLFILE;"<option value=2 selected>":
                                   "Complete Coded</option>"
              ENDIF
            ENDIF
          ENDIF
          GOTO      PFND9999
.
PFND1600  MOVE      "VN",CATEGORY
          PACK      CODE,PMSVX044
          CALL      CODSEL00
          GOTO      PFND9999
.
PFND1700  PACK      KEY8,ADMISSNO,SP70
          CALL      RDWVET1
          BRANCH    OVRCD,PFND9999
.
          MATCH     SP70,VCLMNO
          GOTO      PFND9999 IF EQUAL
          WRITE     HTMLFILE;VCLMNO;
          GOTO      PFND9999
.
PFND1800  CALL      DATSEL00
          GOTO      PFND9999
.
PFND1900  UNPACK    DIM127,D1,FLDPARA,DIM127
.
          REP       "+ ",ADMISSNO
          MOVE      ADMISSNO,KEY8
.
          PACK      KEY30,KEY8,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,PFND9999
.
          MATCH     KEY8,TADMN
          GOTO      PFND9999 IF NOT EQUAL
.
          PACK      BEDTRKEY,TADMN,TDATE,TTIME,TWARD,TBED
.
          WRITE     HTMLFILE;"action=patweb96.pbl>":
                             "<input type=hidden name=reportno value=4>":
                             "<input type=hidden name=template value=":
                             FLDPARA,">":
                             "<input type=hidden name=bedtrkey value=#"":
                             BEDTRKEY,"#">";
.
          GOTO      PFND9999
.
PFND2000  CALL      DISWRD00              * discharge bed
          WRITE     HTMLFILE;DISBED;
          GOTO      PFND9999
.
PFND2100  WRITE     HTMLFILE;BOOKFLAG;
          GOTO      PFND9999        
.
PFND2200  MOVE      "EV",CATEGORY              * I SRF 23145            
          MOVE      PMEVEVNT,CODE              * check indicator 1
          CALL      GETCOD00                   * For Inpatient event visit
.
          WRITE     HTMLFILE;TCINDC1;
          GOTO      PFND9999
.
PFND2300  MOVE      ADMISSNO,AADMNO            * I-48227
          CALL      GETINV00
.
          READ      CONTROLF,HUND18;*249,PTCNURBP  * Use UR number as BPAYINVN?
          MATCH     "1",PTCNURBP
          IF        @EQUAL
            MOVE      PINVUR,BPAYINVN       * use UR number
          ELSE
            MOVE      PINVNO,BPAYINVN
          ENDIF
.
          IF        IBCNMHOS=1
            PACK      KEY8,AADMNO,SP70
            CALL      RDPMVX11
            IF        OVRCD=0
              MOVE      PMVXMHOS,BPAYHOSP
            ENDIF
          ENDIF
.
          CALL      GBCRN000                   * Generate BPAY CRN
          WRITE     HTMLFILE;BPAYREFN;         * Write to html
          GOTO      PFND9999
.
PFND2400  WRITE     HTMLFILE;PTCNBPAY;         * I-48227
          GOTO      PFND9999
.
PFND2500  CALL      GPMWR000
          GOTO      PFND9999
.
PFND2600  PROC      CHKCER00                   * Certificates exist    *I-86040
          WRITE     HTMLFILE;EXIT;             * Certificate indicator
          GOTO      PFND9999
.
PFND2700  MOVE      "C ",CATEGORY
          MOVE      PMRSCONT,CODE              * Country of residence
          CALL      CODITM00
          GOTO      PFND9999
.
PFND2800  MOVE      MRPDSTAT,CODE              * PDT Status
          MOVE      "CP",CATEGORY
          CALL      CODITM00
          GOTO      PFND9999
.
PFND2900  COMPARE   ZERO,PTICUINT
          GOTO      PFND9999 IF EQUAL
          WRITE     HTMLFILE;PTICUINT;  * Hours In Intensive Care
          GOTO      PFND9999
.
PFND3000  COMPARE   ZERO,PTICUCCU
          GOTO      PFND9999 IF EQUAL
          WRITE     HTMLFILE;PTICUCCU;  * Hours In Critical Care
          GOTO      PFND9999
.
PFND3100  COMPARE   ZERO,PTICUMEC
          GOTO      PFND9999 IF EQUAL
          WRITE     HTMLFILE;PTICUMEC;  * Hours In Mechanical Ventilator
          GOTO      PFND9999
.
PFND3200  COMPARE   ZERO,PTICCPAP
          GOTO      PFND9999 IF EQUAL
          WRITE     HTMLFILE;PTICCPAP;  * Hours in Constant Positive Air
          GOTO      PFND9999
.
PFND3300  PACK      KEY18,ADMISSNO,Z70
          CALL      RSMRAUC2
          CALL      RPMRAUC2
          BRANCH    OVRCD,PFND3390
.
          MATCH     ADMISSNO,MRACVISN
          GOTO      PFND3390 IF NOT EQUAL
.
          UNPACK    MRACADTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      PFND9999
.
PFND3390  WRITE     HTMLFILE;"&nbsp;";
          GOTO      PFND9999
.
PFND3400  UNPACK    DIM127,D1,KEY1,DIM127     * .0   User Defined Y/N 1
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,PFND3410
          WRITE     HTMLFILE;PTMIUYN1;
          GOTO      PFND9999
PFND3410  COMPARE   "1",PTMIUYN1              * .1
          IF        @EQUAL
            WRITE     HTMLFILE;"Yes";
          ELSE
            WRITE     HTMLFILE;"No";
          ENDIF
          GOTO      PFND9999
.
PFND3500  UNPACK    DIM127,D1,KEY1,DIM127     * .0   User Defined Y/N 2
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,PFND3510
          WRITE     HTMLFILE;PTMIUYN2;
          GOTO      PFND9999
PFND3510  COMPARE   "1",PTMIUYN2              * .1
          IF        @EQUAL
            WRITE     HTMLFILE;"Yes";
          ELSE
            WRITE     HTMLFILE;"No";
          ENDIF
          GOTO      PFND9999
.
PFND3600  PACK      KEY14,ADMISSNO,SP70
          CALL      RSVSPAY1
          CALL      RKVSPAY1
          BRANCH    OVRCD,PFND9999
.
          MATCH     ADMISSNO,VSPAVISN
          GOTO      PFND9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;ONE;
.
          GOTO      PFND9999
.
PFND3700  PACK      KEY11,ADMISSNO,SP70
          CALL      RSNZSPR1
          CALL      RKNZSPR1
          BRANCH    OVRCD,PFND9999
.
          UNPACK    DIM127,KEY1,FLDITEM,DIM127
          MOVE      FLDITEM,FLDITMNO
.
          MATCH     ADMISSNO,NZSPADMN
          IF        @EQUAL
            CALL      NZSP0000            * Output primary nzpspraf fields
          ELSE
            WRITE     HTMLFILE;SP1;
          ENDIF
.
          GOTO      PFND9999
.
PFND3800  CALL      GETRGM00
          GOTO      PFND9999
.
PFND3900  CALL      GETCAD00
          GOTO      PFND9999
.
PFND4000  CALL      GETCTY00
          GOTO      PFND9999
.
PFND4100  CALL      GETEWB00
          GOTO      PFND9999
.
PFND4200  CALL      CHKPRE00      * check for cancelled preadmissions
          GOTO      PFND9999
.
PFND4300  WRITE     HTMLFILE;PRIDISCD;
          GOTO      PFND9999
.
PFND4400  WRITE     HTMLFILE;PDIADESC;
          GOTO      PFND9999
.
PFND4500  WRITE     HTMLFILE;PRIOPRCD;
          GOTO      PFND9999
.
PFND4600  WRITE     HTMLFILE;POPRDESC;
          GOTO      PFND9999
.
PFND4700  WRITE     HTMLFILE;PTHSNAME;
          GOTO      PFND9999
.
PFND4800  WRITE     HTMLFILE;PTHSADD1;
          GOTO      PFND9999
.
PFND4900  WRITE     HTMLFILE;PTHSADD2;
          GOTO      PFND9999
.
PFND5000  WRITE     HTMLFILE;PTHSADD3;
          GOTO      PFND9999
.
PFND5100  WRITE     HTMLFILE;PTHSADD4;
          GOTO      PFND9999
.
PFND5200  WRITE     HTMLFILE;PTHSPCOD;
          GOTO      PFND9999
.
PFND5300  WRITE     HTMLFILE;PTHSTELE;
          GOTO      PFND9999
.
PFND5400  WRITE     HTMLFILE;PTHSFAXN;
          GOTO      PFND9999
.
PFND5500  CALL      SELFLT00              * Selection of Financial Letter
          GOTO      PFND9999
.
PFND5600  WRITE     HTMLFILE;INVADMNO;
          GOTO      PFND9999
.
PFND5700  WRITE     HTMLFILE;INVVISTP;
          GOTO      PFND9999
.
PFND5800  WRITE     HTMLFILE;VISDHOSP;
          GOTO      PFND9999
.
PFND5900  WRITE     HTMLFILE;INVCASEK;
          GOTO      PFND9999
.
PFND6000  WRITE     HTMLFILE;DDATE;
          GOTO      PFND9999
.
PFND6100  
          GOTO      PFND9999
.
PFND6200  
          GOTO      PFND9999
.
PFND6300  
          GOTO      PFND9999
.
PFND6400  IF        ASTAT=1|ASTAT=5
            GOTO      PFND9999
          ENDIF
.
          PACK      KEY30,ADMISSNO,SP70
          MATCH     SP30,KEY30
          GOTO      PFND9999 IF EQUAL            * TSK 0910121
          CALL      RDSTRAN2
          CALL      RDKTRAN2
          BRANCH    OVRCD,PFND9999
.
          MATCH     ANSA,TMOVE
          IF        !@EQUAL
            GOTO      PFND9999
          ENDIF
.
          MATCH     SP70,PTTRCDAT
          GOTO      PFND9999 IF EQUAL
          UNPACK    PTTRCDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      PFND9999
.
PFND6500  IF        ASTAT=1|ASTAT=5
            GOTO      PFND9999
          ENDIF
.
          PACK      KEY30,ADMISSNO,SP70
          MATCH     SP30,KEY30
          GOTO      PFND9999 IF EQUAL            * TSK 0910121
          CALL      RDSTRAN2
          CALL      RDKTRAN2
          BRANCH    OVRCD,PFND9999
.
          MATCH     ANSA,TMOVE
          IF        !@EQUAL
            GOTO      PFND9999
          ENDIF
.
          WRITE     HTMLFILE;PTTRCTIM;
          GOTO      PFND9999
.
PFND6600  IF        ASTAT=1|ASTAT=5
            GOTO      PFND9999
          ENDIF
.
          PACK      KEY30,ADMISSNO,SP70
          MATCH     SP30,KEY30
          GOTO      PFND9999 IF EQUAL            * TSK 0910121
          CALL      RDSTRAN2
          CALL      RDKTRAN2
          BRANCH    OVRCD,PFND9999
.
          MATCH     ANSA,TMOVE
          IF        !@EQUAL
            GOTO      PFND9999
          ENDIF
.
          MATCH     SP70,PTTRUCID
          IF        @EQUAL
            PACK      KEY14,PTTRCUID,SP70
            CALL      RSWBSE3
            CALL      RKWBSE3
            BRANCH    OVRCD,PFND9999
            MATCH     PTTRCUID,WBSEPCD
            GOTO      PFND9999 IF NOT EQUAL
          ELSE
            MOVE      PTTRUCID,KEY10      * pack key with web userid
            CALL      RDWBSE1
            BRANCH    OVRCD,PFND9999
          ENDIF
.
          WRITE     HTMLFILE;WBSENAM;
          GOTO      PFND9999
.
PFND6700  PACK      KEY25,AADMNO,Z70
          CALL      RDSUNAA1
PFND6750  CALL      RDPUNAA1
          BRANCH    OVRCD,PFND9999
          MATCH     DAADMNO,DPTUNADM
          GOTO      PFND9999 IF NOT EQUAL
.
          MATCH     "1",PTUNTYPE
          IF        !@EQUAL
            MATCH     "5",PTUNTYPE
            IF        !@EQUAL
              GOTO       PFND6750
            ENDIF
          ENDIF
.
          UNPACK    PTUNDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      PFND9999
.
PFND6800  PACK      KEY25,AADMNO,Z70
          CALL      RDSUNAA1
PFND6850  CALL      RDPUNAA1
          BRANCH    OVRCD,PFND9999
          MATCH     DAADMNO,DPTUNADM
.
          GOTO      PFND9999 IF NOT EQUAL
          MATCH     "1",PTUNTYPE
          IF        !@EQUAL
            MATCH     "5",PTUNTYPE
            IF        !@EQUAL
              GOTO       PFND6850
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;PTUNTIME;
.
          GOTO      PFND9999
.
PFND6900  PACK      KEY25,AADMNO,Z70
          CALL      RDSUNAA1
PFND6950  CALL      RDPUNAA1
          BRANCH    OVRCD,PFND9999
          MATCH     DAADMNO,DPTUNADM
          GOTO      PFND9999 IF NOT EQUAL
          MATCH     "1",PTUNTYPE
          IF        !@EQUAL
            MATCH     "5",PTUNTYPE
            IF        !@EQUAL
              GOTO       PFND6950
            ENDIF
          ENDIF
          PACK      KEY10,PTUNAUID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,PFND9999
          WRITE     HTMLFILE;WBSENAM;

          GOTO      PFND9999
.
PFND7000  PACK      KEY25,AADMNO,Z70
          CALL      RDSUNAA1
PFND7050  CALL      RDPUNAA1
          BRANCH    OVRCD,PFND9999
          MATCH     DAADMNO,DPTUNADM
          GOTO      PFND9999 IF NOT EQUAL
          MATCH     "1",PTUNTYPE
          IF        !@EQUAL
            MATCH     "5",PTUNTYPE
            IF        !@EQUAL
              GOTO       PFND7050
            ENDIF
          ENDIF
          PACK      KEY5,ANSP,ANSC,PTUNCANC,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,PFND9999
          WRITE     HTMLFILE;TDESC;
.
          GOTO      PFND9999
.
PFND7100  WRITE     HTMLFILE;REQUESTK; 
          GOTO      PFND9999
.
PFND7200  PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,PFND9999
.
          UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          CALL      DSTN0000              * Get Stationery code for claim code
          GOTO      PFND9999
.
PFND7300  PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,PFND9999
.
          UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          CALL      DFPR0000             * Set default printer for each claim
          GOTO      PFND9999
.
PFND7400  CALL      DISCOD00             * disaster code
          GOTO      PFND9999
.
PFND7500  CALL      DISID000             * disaster ID
          GOTO      PFND9999
.
PFND7600  CALL      SXIN0000           * SX insurer free text
          GOTO      PFND9999
.
PFND7700  MOVE      "SI",CATEGORY
          MOVE      BKRXATRN,CODE
          CALL      CODITM00
          GOTO      PFND9999
.
PFND7800  MOVE      "OA",CATEGORY
          MOVE      BKRXANTY,CODE
          CALL      CODITM00
          GOTO      PFND9999
.
PFND7900  WRITE     HTMLFILE;BKRXESOP;
          GOTO      PFND9999
.
PFND8000  CALL      MDLS0000
          GOTO      PFND9999
.
PFND8100  WRITE     HTMLFILE;ALERT001;
          GOTO      PFND9999
.
PFND8200  WRITE     HTMLFILE;ALERT002;
          GOTO      PFND9999
.
PFND8300  WRITE     HTMLFILE;ALERT013;
          GOTO      PFND9999
.                                                                     CAR 257776
PFND8400  UNPACK    DIM127,D1,KEY3,DIM127
          MOVE      KEY3,FLDITMNO
          CALL      MISC0000
          GOTO      PFND9999
.
PFND8500  CALL      SELPLT00              * Selection of Patient Letter types
          GOTO      PFND9999
.
PFND8600  WRITE     HTMLFILE;NOCANVIS;
          GOTO      PFND9999
.
PFND8700  MATCH     SP70,EMVIDOCT
          GOTO      PFND9999 IF EQUAL
.
          MOVE      EMVIDOCT,DOCTCODE
          CALL      DOCDET00
.
          GOTO      PFND9999
.
PFND8800  IF        PVITYPE=1
            WRITE      HTMLFILE;EMVITIME;    * Visit Time
            GOTO       PFND9999              * EMR
          ENDIF
.
          IF        PVITYPE=3
            WRITE      HTMLFILE;ATIME;   * Visit Time - Inpatient
            GOTO       PFND9999
          ENDIF
.
          CALL      GETOUT00
          BRANCH    EXIT,PFND9999
.
          IF        PVITYPE=2
            WRITE     HTMLFILE;OBATIME;   * Outpatient
          ENDIF
          GOTO      PFND9999
.
PFND8900  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          CALL      GETOUT00             * .0 OP Site Description
          BRANCH    EXIT,PFND9999        * .1 Clinic Type Code
.                                        * .2 Clinic Description
          MOVE      OBASITE,KEY6
          CALL      RDSITA1                      * site found ?
          BRANCH    OVRCD,PFND9999
.
          PACK      KEY12,OBASITE,OBACTYP,SP70
          CALL      RDCTYA1
          BRANCH    OVRCD,PFND9999
.
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          IF        F1=0              
            WRITE     HTMLFILE;OSTDESC;     * .0 OP Site Description 
          ENDIF
          IF        F1=1             
            WRITE     HTMLFILE;OBACTYP;  * .1 OP Clinic Type
          ENDIF
          IF        F1=2           
            WRITE     HTMLFILE;OCTDESC;
          ENDIF                          * .2 Clinic Description
.
          GOTO      PFND9999
.
PFND9000  MOVE      SP70,DIM20
          BRANCH    PVITYPE,PFND9010,PFND9020,PFND9030     * Visit Status
          IF        PVITYPE=9
            PACK      KEY8,ADMISSNO,SP70
            CALL      RDALREF1
            BRANCH    OVRCD,PFND9020
            GOTO      PFND9040
          ENDIF
          GOTO      PFND9020
.
PFND9010  MOVE      "Current EMR",DIM20
          IF        EMVISTAT=2|EMVISTAT=3
            MOVE      "Discharged EMR",DIM20
          ENDIF
          IF        EMVISTAT=4
            MOVE      "Cancelled EMR",DIM20
          ENDIF
          GOTO      PFND9090
.
PFND9020  CALL      GETOUT00
          BRANCH    EXIT,PFND9999
          MOVE      "Booked",DIM20
          IF        OBASTAT=4
            MOVE      "Attended OP",DIM20
          ENDIF
          GOTO      PFND9090
.
PFND9030  MOVE      "Preadmitted",DIM20
          IF        ASTAT=2
            MOVE      "Current IP",DIM20
          ENDIF
          IF        ASTAT=3
            MOVE      "Discharged IP",DIM20
          ENDIF
          IF        ASTAT=4
            MOVE      "On leave IP",DIM20
          ENDIF
          IF        ASTAT=5
            MOVE      "Cancelled IP",DIM20
          ENDIF
          GOTO      PFND9090
.
PFND9040  MOVE      "Waiting",DIM20
          MATCH     "1",ALRESTAT
          IF        @EQUAL
            MOVE      "Active",DIM20
          ENDIF
          MATCH     "2",ALRESTAT
          IF        @EQUAL
            MOVE      "Closed",DIM20
          ENDIF
          MATCH     "3",ALRESTAT
          IF        @EQUAL
            MOVE      "Inactive",DIM20
          ENDIF
          MATCH     "4",ALRESTAT
          IF        @EQUAL
            MOVE      "Cancelled",DIM20
          ENDIF
          MATCH     "5",ALRESTAT
          IF        @EQUAL
            MOVE      "Rejected",DIM20
          ENDIF
.
PFND9090  WRITE     HTMLFILE;DIM20;
          GOTO      PFND9999

PFND9100  BRANCH    PVITYPE,PFND9110,PFND9190,PFND9130     * Completion Code 
          IF        PVITYPE=9
            GOTO      PFND9140
          ENDIF
          GOTO      PFND9190
.
PFND9110  MOVE      EMVIDSTA,CODE
          MOVE      "ED",CATEGORY
          CALL      CODITM00
          GOTO      PFND9999
.
PFND9130  MOVE      DSTAT,CODE
          MOVE      "D ",CATEGORY
          CALL      CODITM00
          GOTO      PFND9999
.
PFND9140  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          PACK      KEY16,PVIBILL,Z70
          CALL      RSALENC1
          CALL      RPALENC1
          IF        OVRCD=0
            MATCH    DPVIBILL,ALENVISN   * Same visit number ?
            IF       @EQUAL
              MATCH    SP8,ALENSDAT
              IF       !@EQUAL
                WRITE    HTMLFILE;ALENSDAT;
              ENDIF
            ENDIF
          ENDIF
          GOTO      PFND9999
.
PFND9190  UNPACK    DIM127,D1,KEY1,DIM127
          GOTO      PFND9999
.
PFND9200  BRANCH    PVITYPE,PFND9210,PFND9220,PFND9230     * Health Purchaser
          IF        PVITYPE=9
            GOTO      PFND9240
          ENDIF
          GOTO      PFND9220
.
PFND9210  MOVE      EMVIPURC,CODE
          GOTO      PFND9290
.
PFND9220  CALL      GETOUT00
          BRANCH    EXIT,PFND9999
.
          MOVE      OTBBPURC,CODE
          GOTO      PFND9290
.
PFND9230  MOVE      PTMIPHPU,CODE
          GOTO      PFND9290
.
PFND9240  MOVE      ALREPURC,CODE
          GOTO      PFND9290
.
PFND9290  MOVE      "HP",CATEGORY
          CALL      CODITM00
          GOTO      PFND9999
.
PFND9300  MOVE      SP70,LSTDOCT
          PACK      LSTDOCT,PVIDOCT
.
          BRANCH    PVITYPE,PFND9310,PFND9320,PFND9330     * HCP Name    
          IF        PVITYPE=9
            PACK      KEY8,ADMISSNO,SP70
            CALL      RDALREF1
            BRANCH    OVRCD,PFND9999
            GOTO      PFND9340
          ENDIF
          GOTO      PFND9320
.
PFND9310  PACK      KEY8,ADMISSNO,SP70
          CALL      RDEMVIS1
          BRANCH    OVRCD,PFND9999
          PACK      LSTDOCT,EMVIDOCT,SP70
          GOTO      PFND9390
.
PFND9320  CALL      GETOUT00
          BRANCH    EXIT,PFND9999
          PACK      LSTDOCT,OBADOCT,SP70
          GOTO      PFND9390
.
PFND9330  PACK      LSTDOCT,ADOCTA,SP70
          GOTO      PFND9390
.
PFND9340  PACK      LSTDOCT,ALRERHCP,SP70
          GOTO      PFND9390
.
PFND9390  MATCH     SP70,LSTDOCT
          GOTO      PFND9999 IF EQUAL
.
          PACK      KEY10,LSTDOCT,SP10  * try "pmshcpaf" for Doctor Name
          CALL      RDPMHCP1
          BRANCH    OVRCD,PFND9999      * leave Clinic Name in DOCFNAME
.
          MOVE      PMHCTITL,FMTTITLE
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000
          WRITE     HTMLFILE;DOCFNAME;
          GOTO      PFND9999
.
PFND9400  WRITE     HTMLFILE;PTMXSIN1;
          GOTO      PFND9999
.
PFND9500  MOVE      VISTOUTP,DIM2
          LOAD      DIM2,PVITYPE,VISTEMER,VISTOUTP,VISTINPT
          COMPARE   "9",PVITYPE
          IF        @EQUAL
            MOVE      VISTALLH,DIM2
          ENDIF
.
          WRITE     HTMLFILE;DIM2;
          GOTO      PFND9999
.
PFND9600  IF        PVITYPE=1|PVITYPE=2|PVITYPE=3|PVITYPE=9
            MATCH     PVIDATE,SP70
            GOTO      PFND9999 IF EQUAL
            UNPACK    PVIDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            IF        FHIRTYPE=0
              WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
            ELSE
              WRITE     HTMLFILE;CCENT,CYEAR,"-",CMON,"-",CDAY;
            ENDIF
            GOTO      PFND9999
          ENDIF
.
          CALL      GETOUT00
          BRANCH    EXIT,PFND9999
.
          MATCH     OBADATE,SP70
          GOTO      PFND9999 IF EQUAL
          UNPACK    OBADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          IF        FHIRTYPE=0
            WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          ELSE
            WRITE     HTMLFILE;CCENT,CYEAR,"-",CMON,"-",CDAY;
          ENDIF
          GOTO      PFND9999
.
PFND9700  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,PFND9710,PFND9720,PFND9730
          GOTO      PFND9999
.
PFND9710  WRITE     HTMLFILE;PBDATE;
          GOTO      PFND9999
.
PFND9720  WRITE     HTMLFILE;PDECDTE;
          GOTO      PFND9999
.
PFND9730  WRITE     HTMLFILE;PTMADCDT;
          GOTO      PFND9999
.
PFND9800  MOVE      SP70,CASTDESC
          MATCH     SP70,PMVXCASE
          IF        !@EQUAL
            MOVE      PMVXCASE,KEY10
            CALL      RDALCAS1
            IF        OVRCD=0
              MOVE      ALCADESC,CASTDESC
            ENDIF
          ENDIF
          WRITE     HTMLFILE;CASTDESC;
          GOTO      PFND9999
.
PFND9900  CALL      FHIR0000
          GOTO      PFND9999
        
PFND9999  RETURN
+
.*******************************************************************************
. Output FHIR Required Fields
.*******************************************************************************
FHIR0000  UNPACK    DIM127,DIM1,KEY3,DIM127
          MOVE      KEY3,FLDITMNO
          BRANCH    FLDITMNO,FHIR0100,FHIR0200,FHIR0300,FHIR0400,FHIR0500:
                             FHIR0600,FHIR0700,FHIR0800,FHIR0900,FHIR1000:
                             FHIR1100,FHIR1200,FHIR1300,FHIR1400,FHIR1500:
                             FHIR1600,FHIR1700,FHIR1800,FHIR1900,FHIR2000:
                             FHIR2100

          WRITE     HTMLFILE;"Invalid Tag";
          GOTO      FHIR9999
.
. FHIR Encounter Status
.----------------------
FHIR0100  CALL      GFRSTA00
          STRIP     FHRSTAT;
          WRITE     HTMLFILE;*+,FHRSTAT;
          GOTO      FHIR9999
.
. FHIR Encounter Class
.----------------------
FHIR0200  CALL      GFRCLS00
          STRIP     FHRCLAS;
          WRITE     HTMLFILE;*+,FHRCLAS;
          GOTO      FHIR9999
.
. FHIR Encounter Start Date
.----------------------------
FHIR0300  CALL      GFRSDT00
          STRIP     FHRSTRDT;
          WRITE     HTMLFILE;*+,FHRSTRDT;
          GOTO      FHIR9999
.
. FHIR Encounter End Date
.--------------------------
FHIR0400  CALL      GFREDT00
          MATCH     SP70,FHRENDDT
          IF        !@EQUAL 
            WRITE       HTMLFILE;*+,", #"end#": #"",FHRENDDT,"#"";
          ENDIF
          GOTO      FHIR9999
.
. FHIR Attending Doctor
.
FHIR0500  IF        PVITYPE=1
            PACK      KEY10,EMVIDOCT,SP70
            GOTO      FHIR0590              * EMR
          ENDIF
.
          IF        PVITYPE=3
            PACK      KEY10,ADOCTA,SP70
            GOTO      FHIR0590
          ENDIF
.
          CALL      GETOUT00
          BRANCH    EXIT,FHIR9999
.
          IF        PVITYPE=2
            PACK      KEY10,OBADOCT,SP70
            GOTO      FHIR0590
          ENDIF
          GOTO      FHIR9999
FHIR0590  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,FHIR0595
          CALL      RDPMHCP1
          BRANCH    OVRCD,FHIR9999
          MOVE      PMHCTITL,FMTTITLE
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000
          WRITE     HTMLFILE;DOCFNAME;
          GOTO      FHIR9999
FHIR0595  WRITE     HTMLFILE;KEY10;
          GOTO      FHIR9999
.
. Location
.
FHIR0600  MOVE      ZERO,STRETURN
          UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          IF        PVITYPE=1
            CALL      EMRLOC00
            GOTO      FHIR9999
          ENDIF
.
          IF        PVITYPE=3
            CALL      INPLOC00
            GOTO      FHIR9999
          ENDIF
.
          CALL      GETOUT00
          BRANCH    EXIT,FHIR9999
          IF        PVITYPE=2
            CALL      OUTLOC00
          ENDIF
          GOTO      FHIR9999
.
. Encounter Reason from Inpatient/Emergency/Outpatient
.
FHIR0700  IF        PVITYPE=1
            STRIP     EMVICOM1
            STRIP     EMVICOM2
            WRITE     HTMLFILE;*+,EMVICOM1,SP1,EMVICOM2;
            GOTO      FHIR9999
          ENDIF
.
          IF        PVITYPE=3
            STRIP     ADIAG1
            STRIP     ADIAG2
            WRITE     HTMLFILE;*+,ADIAG1,SP1,ADIAG2;
            GOTO      FHIR9999
          ENDIF
.
          CALL      GETOUT00
          BRANCH    EXIT,FHIR9999
          IF        PVITYPE=2
            WRITE     HTMLFILE;*+,OBACOMM;   /* Not sure if this is the correct field */
          ENDIF
          GOTO      FHIR9999
.
. FHIR Patient Resource
.
FHIR0800  PACK      FHRPATID,URNUMBER
          SQUEEZE   FHRPATID
          CALL      RESPAT00
          GOTO      FHIR9999
.
. FHIR Encounter Resource
.
FHIR0900  CALL      FHRCLR00
          MOVE      ADMISSNO,PVIBILL
          CALL      FHRVIS00
          IF        FHIRBUND=0
            CALL      RESENC00
          ELSE
            WRITE     HTMLFILE;*+," {":
                                  " #"fullUrl#": #"%BASEURL/Encounter/",FHRENCID,"#",":
                                  " #"resource#": ";
            CALL      RESENC00
            WRITE     HTMLFILE;*+," }";
            IF        FHRSUBIN=1
              WRITE     HTMLFILE;*+,",{":
                                    " #"fullUrl#": #"%BASEURL/Patient/",FHRPATID,"#",":
                                    " #"resource#": ";
              CALL      RESPAT00
              WRITE     HTMLFILE;*+," }";
            ENDIF
.
            IF       FHRPARIN=1
.
              CALL      FHRDO100
.
              MATCH     SP70,FHRDOCC1
              IF        !@EQUAL
.
                WRITE     HTMLFILE;*+,",{ #"fullUrl#" : #"%BASEURL/Practitioner/",FHRDOCC1,"#", ":
                          " #"resource#" : ";
                CALL     RESPRA00         * FHIR Resource Practitioner
                WRITE    HTMLFILE;*+,"}"
.
              ENDIF
.
              CALL      FHRDO200
.
              MATCH     SP70,FHRDOCC2
              IF        !@EQUAL
.
                WRITE     HTMLFILE;*+,",{ #"fullUrl#" : #"%BASEURL/Practitioner/",FHRDOCC2,"#", ":
                          " #"resource#" : ";
                CALL     RESPRA00         * FHIR Resource Practitioner
                WRITE    HTMLFILE;*+,"}"
.
              ENDIF
.
            ENDIF
.
            IF       FHRLOCIN=1
.
              MATCH     "emergency",FHRCLAS
              IF        @EQUAL
.
                MATCH    SP70,EMVILOCN
                IF       !@EQUAL & !@EOS
.
                  PACK      KEY3,EMVILOCN,SP70
                  CALL      RDEMLOC1
                  IF        OVRCD = 0
.
                    MOVE      SP70,DIM3
.
                    PACK      KEY3,EMLOSCOD,SP70
                    CALL      RDEMSIT1
                    IF        OVRCD=0
                      MOVE      EMSTHSNO,DIM3
                    ENDIF
.
                    WRITE     HTMLFILE;*+,",{ #"fullUrl#" : #"%BASEURL/Location/",FHRWLOCC,"#", ":
                              " #"resource#" : ";
                    CALL     RESEST00         * FHIR Resource Location Emergency Loc
                    WRITE    HTMLFILE;*+,"}"
.
                  ENDIF
.
                ENDIF
.
              ELSE
.
                MATCH     SP70,AWARD
                IF        !@EQUAL
                  PACK      KEY6,AWARD,ABED,SP70
                ELSE
                  PACK      KEY6,PTMIXWRD,PTMIEBED,SP70
                ENDIF
                CALL      RDWARD1
                IF        OVRCD=0
.
                  MATCH     SP70,AWARD
                  IF        !@EQUAL
.
                    MATCH     SP70,ABED
                    IF        !@EQUAL
.
                      WRITE     HTMLFILE;*+,",{ #"fullUrl#" :":
                                " #"%BASEURL/Location/",FHRBLOCC,"#", ":
                                " #"resource#" : ";
                      CALL     RESBED00         * FHIR Resource Location Bed
                      WRITE    HTMLFILE;*+,"}"
.
                    ELSE
. 
                      WRITE     HTMLFILE;*+,",{ #"fullUrl#" :":
                                " #"%BASEURL/Location/",FHRWLOCC,"#", ":
                                " #"resource#" : ";
                      CALL     RESWRD00         * FHIR Resource Location Ward
                      WRITE    HTMLFILE;*+,"}"
.
                    ENDIF
.
                  ELSE
                    MATCH     SP70,PTMIXWRD
                    IF        !@EQUAL
.
                      MATCH     SP70,PTMIEBED
                      IF        !@EQUAL
.
                        WRITE     HTMLFILE;*+,",{ #"fullUrl#" :":
                                  " #"%BASEURL/Location/",FHRBLOCC,"#", ":
                                  " #"resource#" : ";
                        CALL     RESBED00         * FHIR Resource Location Bed
                        WRITE    HTMLFILE;*+,"}"
.
                      ELSE
. 
                        WRITE     HTMLFILE;*+,",{ #"fullUrl#" :":
                                  " #"%BASEURL/Location/",FHRWLOCC,"#", ":
                                  " #"resource#" : ";
                        CALL     RESWRD00         * FHIR Resource Location Ward
                        WRITE    HTMLFILE;*+,"}"
.
.
                      ENDIF
.
                    ENDIF
.
                  ENDIF
.
                ENDIF
.
              ENDIF
.
            ENDIF
.UPTOHERE
          ENDIF
          GOTO      FHIR9999
.
. FHIR Encounter Bundle (Next Page)
.
FHIR1000  IF        DISNUMB=NORECORD
            ASSIGN    STARTNUM+NORECORD,F6
            MOVE      F6,KEY6
            SQUEEZE   KEY6
            WRITE     HTMLFILE;*+,"nextpage=&startnum=",KEY6
          ENDIF
          GOTO      FHIR9999
.
. FHIR Encounter Bundle (Previous Page)
.
FHIR1100  IF        STARTNUM>0
            ASSIGN    STARTNUM-NORECORD,F6
            IF        F6>=0
              MOVE      F6,KEY6
              SQUEEZE   KEY6
              WRITE     HTMLFILE;*+,"prevpage=&startnum=",KEY6
            ENDIF
          ENDIF
          GOTO      FHIR9999
.
. FHIR Encounter Bundle (List)
.
FHIR1200  CALL      FHRLST00
          GOTO      FHIR9999
.
FHIR1300  MOVE      "M",DIM1           * Past Medical History (Cat wi) TCINDC2
          CALL      COREXT00           * check for matching TCINDC2 value
          WRITE     HTMLFILE;EXIT;
          GOTO      FHIR9999
.
FHIR1400  MOVE      "C",DIM1           * Consent Form (Cat wi) TCINDC2
          CALL      COREXT00           * check for matching TCINDC2 value
          WRITE     HTMLFILE;EXIT;
          GOTO      FHIR9999
.
FHIR1500  MOVE      "S",DIM1           * Supporting Documents (Cat wi) TCINDC2
          CALL      COREXT00           * check for matching TCINDC2 value
          WRITE     HTMLFILE;EXIT;
          GOTO      FHIR9999
.
FHIR1600  MATCH     " ",PMVXINTR
          IF        @EQUAL
            WRITE     HTMLFILE;"Not Applicable";
          ENDIF
          MATCH     "0",PMVXINTR
          IF        @EQUAL
            WRITE     HTMLFILE;"No";
          ENDIF
          MATCH     "1",PMVXINTR
          IF        @EQUAL
            WRITE     HTMLFILE;"Yes";
          ENDIF
          GOTO      FHIR9999
.
FHIR1700  UNPACK    DIM127,DIM1,KEY3,DIM127
          MOVE      KEY3,FLDITMNO
          CALL      BKRX0000
          GOTO      FHIR9999
.
FHIR1800  MOVE      BKREADOC,KEY6
          CALL      RDDOCT1
          IF        OVRCD=1
            MOVE      SP70,DOCFNAME
          ELSE
.           CALL      DOCNAM00                * Format Doctor Name
            MOVE      DTITL,FMTTITLE            * I CAR 13038
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000                  * end I CAR 13038
          ENDIF
.
          WRITE       HTMLFILE;DOCFNAME;
          GOTO        FHIR9999
.
FHIR1900  COMPARE   THREE,ASTAT             * Discharged status?
          GOTO      FHIR9999 IF NOT EQUAL   * No, exit
.
          PACK      KEY30,ADMISSNO,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,FHIR9999
.
          MATCH     ANSD,TMOVE              * Movement type is Discharge?
          GOTO      FHIR9999 IF NOT EQUAL   * No, exit
.
          MATCH     SP70,PTTRCDAT
          GOTO      FHIR9999 IF EQUAL
          UNPACK    PTTRCDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      FHIR9999
.
FHIR2000  COMPARE   THREE,ASTAT             * Discharged status?
          GOTO      FHIR9999 IF NOT EQUAL   * No, exit
.
          PACK      KEY30,ADMISSNO,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,FHIR9999
.
          MATCH     ANSD,TMOVE              * Movement type is Discharge?
          GOTO      FHIR9999 IF NOT EQUAL   * No, exit
.
          WRITE     HTMLFILE;PTTRCTIM;
          GOTO      FHIR9999
.
FHIR2100  COMPARE   THREE,ASTAT             * Discharged status?
          GOTO      FHIR9999 IF NOT EQUAL   * No, exit
.
          PACK      KEY30,ADMISSNO,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,FHIR9999
.
          MATCH     ANSD,TMOVE              * Movement type is Discharge?
          GOTO      FHIR9999 IF NOT EQUAL   * No, exit
.
          MATCH     SP70,PTTRUCID
          IF        @EQUAL
            PACK      KEY14,PTTRCUID,SP70
            CALL      RSWBSE3
            CALL      RKWBSE3
            BRANCH    OVRCD,FHIR9999
            MATCH     PTTRCUID,WBSEPCD
            GOTO      FHIR9999 IF NOT EQUAL
          ELSE
            MOVE      PTTRUCID,KEY10        * pack key with web userid
            CALL      RDWBSE1
            BRANCH    OVRCD,FHIR9999
          ENDIF
.
          WRITE     HTMLFILE;WBSENAM;
          GOTO      FHIR9999
.
FHIR9999  RETURN
+
.------------------------------------------------------------------------------
.         Checks if Observation Patient Correspondence (obspcoaf) record exists
.         for the matching indicator 2 value passed into DIM1 (Cat wi).
.------------------------------------------------------------------------------
COREXT00  PACK      KEY20,URNUMBER,ADMISSNO,SP20
          CALL      RSOBPC1
COREXT10  CALL      RKOBPC1
          BRANCH    OVRCD,COREXT91
.
          MATCH     OBPCURNO,URNUMBER
          GOTO      COREXT91 IF NOT EQUAL
.
          MATCH     OBPCCVIS,ADMISSNO
          GOTO      COREXT91 IF NOT EQUAL
.
          PACK      KEY5,CATwi,OBPCCTYP,SP10
          CALL      RDCODE1
          BRANCH    OVRCD,COREXT10
.
          MATCH     TCINDC2,DIM1
          GOTO      COREXT90 IF EQUAL
.
          GOTO      COREXT10           * get next correspondence record
.
COREXT90  MOVE      ONE,EXIT           * matching record (Cat wi) exists
          GOTO      COREXT99
.
COREXT91  MOVE      ZERO,EXIT          * no matching record
COREXT99  RETURN
+
.------------------------------------------------------------
. Get Doctors for FHIR Response.
.------------------------------------------------------------
GFRDOC00  MOVE      SP70,FHRDOCC1
          MOVE      SP70,FHRDOCT1
          MOVE      SP70,FHRDOCN1
.
          MOVE      SP70,FHRDOCC2
          MOVE      SP70,FHRDOCT2
          MOVE      SP70,FHRDOCN2
.
.
          MATCH     SP70,LSTDOCT
          IF        !@EQUAL
            MOVE      DOCFNAME,FHRDOCN1
            CLEAR     FHRDOCC1
            APPEND    "HCP-",FHRDOCC1
            APPEND    LSTDOCT,FHRDOCC1
            RESET     FHRDOCC1
            MOVE      "CON",FHRDOCT1 *  Doctor Type
          ENDIF
.
          COMPARE   THREE,PVITYPE
          GOTO      GFRDOC99 IF NOT EQUAL
.
          MOVE      "ADM",FHRDOCT1 *  Doctor Type
.
          MATCH     SP70,PMVXEDC1
          GOTO      GFRDOC99 IF EQUAL
.
          CLEAR     FHRDOCC2
          APPEND    "HCP-",FHRDOCC2
          APPEND    PMVXEDC1,FHRDOCC2
          RESET     FHRDOCC2
          MOVE      "CON",FHRDOCT2
.
          PACK      KEY10,PMVXEDC1
          CALL      RDPMHCP1
          BRANCH    OVRCD,GFRDOC99
.
          SQUEEZE   PMHCTITL
          SQUEEZE   PMHCSNAM
          MOVE      PMHCGNAM,DIM1
          PACK      FHRDOCN2,PMHCTITL,SP1,DIM1,DOT,SP1,PMHCSNAM,SP70
.
GFRDOC99  RETURN
+
.
. Get FHIR Encounter Statis
.
GFRSTA00  BRANCH    PVITYPE,GFRSTA10,GFRSTA20,GFRSTA30
          MOVE      "other",FHRSTAT
          GOTO      GFRSTA99
GFRSTA10  CALL      EMSTA000
          GOTO      GFRSTA99
GFRSTA20  CALL      OPSTA000
          GOTO      GFRSTA99
GFRSTA30  CALL      INSTA000
          GOTO      GFRSTA99
GFRSTA99  RETURN
+
.
. Get FHIR Encounter Class
.
GFRCLS00  BRANCH    PVITYPE,GFRCLS10,GFRCLS20,GFRCLS30     * HCP Name    
          MOVE      "other",FHRCLAS
          GOTO      GFRCLS99
GFRCLS10  MOVE      "emergency",FHRCLAS
          GOTO      FHIR9999
GFRCLS20  MOVE      "ambulatory",FHRCLAS
          GOTO      FHIR9999
GFRCLS30  MOVE      "inpatient",FHRCLAS
GFRCLS99  RETURN
+
.
. Get FHIR Encounter Start Date
.
GFRSDT00  PACK      FHRSTRDT,SP70
          IF        PVITYPE=1
            UNPACK     EMVIDATE,CCENT,CYEAR,CMON,CDAY
            UNPACK     EMVITIME,KEY5
            GOTO       GFRSDT90              * EMR
          ENDIF
.
          IF        PVITYPE=3
            UNPACK     ADATE,CCENT,CYEAR,CMON,CDAY
            UNPACK     ATIME,KEY5
            GOTO       GFRSDT90
          ENDIF
.
          CALL      GETOUT00
          BRANCH    EXIT,GFRSDT99
.
.
          IF        PVITYPE=2
            UNPACK    OBADATE,CCENT,CYEAR,CMON,CDAY
            UNPACK    OBATIME,KEY5
.
            MATCH     SP70,OTBBCITM   * Check In Time Seen
            IF        !@EQUAL
              MOVE     OTBBCITM,KEY5
            ENDIF
.
            MATCH     SP70,OTBBASTM   * Time Seen
            IF        !@EQUAL
              MOVE     OTBBASTM,KEY5
            ENDIF
            GOTO      GFRSDT90
          ENDIF
          GOTO      GFRSDT99
.
GFRSDT90  MOVE      ":00",KEY3
          PACK      FHRSTRDT,CCENT,CYEAR,DASH,CMON,DASH,CDAY,ANST,KEY5,KEY3,TIMEZONE
          GOTO      GFRSDT99
GFRSDT99  RETURN
+
.
. Get FHIR Encounter End Date
.
GFREDT00  MOVE      SP70,FHRENDDT
          MOVE      SP70,KEY5
          IF        PVITYPE=1
            MATCH      SP70,EMVIDDAT
            GOTO       GFREDT99 IF EQUAL
            UNPACK     EMVIDDAT,CCENT,CYEAR,CMON,CDAY
            MOVE       EMVIDTIM,KEY5
            GOTO       GFREDT90              * EMR
          ENDIF
.
          IF        PVITYPE=3
            MATCH      SP70,DDATE
            IF         @EQUAL
              PACK       KEY8,PVIBILL,SP70
              CALL       RDPMWOR1
              BRANCH     OVRCD,GFREDT99
              MATCH      SP70,PMWOEDAT
              GOTO       GFREDT99 IF EQUAL
              UNPACK     PMWOEDAT,CCENT,CYEAR,CMON,CDAY
              MOVE       PMWOEDTM,KEY5
            ELSE
              UNPACK   DDATE,CCENT,CYEAR,CMON,CDAY
              MOVE     DTIME,KEY5
            ENDIF
            GOTO      GFREDT90
          ENDIF
.
          CALL      GETOUT00
          BRANCH    EXIT,GFREDT99
.
          IF        PVITYPE=2
            MATCH     SP70,OTBBDPTM     * Time of Departure
            IF        !@EQUAL
              UNPACK    OBADATE,CCENT,CYEAR,CMON,CDAY
              MOVE      OTBBDPTM,KEY5
              GOTO      GFREDT90
            ENDIF
          ENDIF
          GOTO      GFREDT99
.
GFREDT90  MOVE      ":00",KEY3
          MATCH     SP70,KEY5
          IF        @EQUAL
            PACK      FHRENDDT,CCENT,CYEAR,DASH,CMON,DASH,CDAY
          ELSE
            PACK      FHRENDDT,CCENT,CYEAR,DASH,CMON,DASH,CDAY,ANST,KEY5,KEY3,TIMEZONE
          ENDIF
          GOTO      GFREDT99
.
GFREDT99  RETURN
+
.
. Get FHIR Encounter Location
.
GFRLOC00  MOVE      ONE,STRETURN
          MOVE      ONE,F1
          IF        PVITYPE=1
            CALL      EMRLOC00
            GOTO      GFRLOC99
          ENDIF
.
          IF        PVITYPE=3
            CALL      INPLOC00
            GOTO      GFRLOC99
          ENDIF
.
          CALL      GETOUT00
          BRANCH    EXIT,GFRLOC99
          IF        PVITYPE=2
            CALL      OUTLOC00
          ENDIF
          GOTO      GFRLOC99

GFRLOC99  RETURN
+
.
. Get FHIR Encounter Reason
.
GFRREA00  PACK      FHRREAS,SP70,SP70
          IF        PVITYPE=1
            STRIP     EMVICOM1
            STRIP     EMVICOM2
            PACK      FHRREAS,EMVICOM1,SP1,EMVICOM2
            GOTO      GFRREA99
          ENDIF
.
          IF        PVITYPE=3
            STRIP     ADIAG1
            STRIP     ADIAG2
            PACK      FHRREAS,ADIAG1,SP1,ADIAG2
            GOTO      GFRREA99
          ENDIF
.
          CALL      GETOUT00
          BRANCH    EXIT,GFRREA99
          IF        PVITYPE=2
            PACK      FHRREAS,OBACOMM
          ENDIF
          GOTO      GFRREA99

GFRREA99  RETURN
+
.------------------------------------------------------------
. Format FHIR Ward Display Name
.------------------------------------------------------------
FWDNAM00  CLEAR     FRWRDTXT
          MOVE      SP70,FRWRDTXT
.
          MATCH     SP70,AWARD
          GOTO      FWDNAM10 IF EQUAL
.
          PACK      KEY6,AWARD,SP70
          CALL      RDWARD1
          IF        OVRCD=1
            STRIP     AWARD
            MOVE      AWARD,FRWRDTXT
          ELSE
            STRIP     WBDESC
            MOVE      WBDESC,FRWRDTXT
          ENDIF
.
          IF        STRETURN=0
            WRITE     HTMLFILE;*+,KEY20,"-",WBDESC,KEY9;
          ENDIF
          GOTO      FWDNAM99
.
FWDNAM10  MATCH     SP70,PTMIXWRD
          GOTO      FWDNAM99 IF  EQUAL
.
          PACK      KEY6,PTMIXWRD,SP70
          CALL      RDWARD1
          IF        OVRCD=1
            STRIP     PTMIXWRD
            MOVE      PTMIXWRD,FRWRDTXT
          ELSE
            STRIP     WBDESC
            MOVE      WBDESC,FRWRDTXT
          ENDIF
          GOTO      FWDNAM99
.
FWDNAM99  RETURN
+
.------------------------------------------------------------
. Format FHIR Bed Display Name
.------------------------------------------------------------
FBDNAM00  CLEAR     FRBEDTXT
          MOVE      SP70,FRBEDTXT
.
          MATCH     SP70,ABED
          GOTO      FBDNAM10 IF EQUAL
.
          PACK      KEY6,AWARD,ABED
          CALL      RDWARD1
          IF        OVRCD=1
            STRIP     ABED
            MOVE      ABED,FRBEDTXT
          ELSE
            STRIP     WBDESC
            MOVE      WBDESC,FRBEDTXT
          ENDIF
.
          IF        STRETURN=0
            WRITE     HTMLFILE;*+,KEY20,KEY9;
          ENDIF
          GOTO      FBDNAM99
.
FBDNAM10  MATCH     SP70,PTMIEBED
          GOTO      FBDNAM99 IF EQUAL
.
          PACK      KEY6,PTMIXWRD,PTMIEBED
          CALL      RDWARD1
          IF        OVRCD=1
            STRIP     PTMIEBED
            MOVE      PTMIEBED,FRBEDTXT
          ELSE
            STRIP     WBDESC
            MOVE      WBDESC,FRBEDTXT
          ENDIF
          GOTO      FBDNAM99
.
FBDNAM99  RETURN
+
.------------------------------------------------------------
. Outpatient Location
.------------------------------------------------------------
OUTLOC00  PACK      KEY13,OBASITE,DASH,OBACLIN,SP70
          IF        F1=0
            WRITE     HTMLFILE;*+,"Clinic-",KEY13;
          ELSE 
            PACK      KEY20,OBASITE,OBACLIN,OBADATE,SP70
            CALL      RDCLIA1
            IF        OVRCD=1
              PACK      KEY20,OBASITE,OBACLIN,OBADATE,Z70
              CALL      RDSCLIA1          * Read Clinic Record
              CALL      RDPCLIA1
              BRANCH    OVRCD,OUTLOC99
              MATCH     OBASITE,OCASITE
              GOTO      OUTLOC99 IF NOT EQUAL
              MATCH     OBACLIN,OCACLIN
              GOTO      OUTLOC99 IF NOT EQUAL
              IF        STRETURN=0
                WRITE     HTMLFILE;*+,OCADESC;
              ENDIF
              CLEAR     FHRWLOCC
              APPEND    "Clinic-",FHRWLOCC
              APPEND    OBASITE,FHRWLOCC
              APPEND    OBACLIN,FHRWLOCC
              APPEND    OBADATE,FHRWLOCC
              RESET     FHRWLOCC
              STRIP     FHRWLOCC
              REP       " -",FHRWLOCC
              MOVE      OCADESC,FHRLOCN
            ENDIF
          ENDIF
OUTLOC99  RETURN
+
. Emergency Location 
.
EMRLOC00  PACK      KEY3,EMVILOCN,SP70
          MATCH     SP70,KEY3
          IF        @EQUAL
            PACK      KEY3,EMVISITE,SP70
            PACK      KEY3,EMVISITE,SP70
            CALL      RDEMSIT1
            CLEAR     FHRWLOCC
            APPEND    "EmergencySite-", FHRWLOCC
            APPEND    EMVISITE, FHRWLOCC
            RESET     FHRWLOCC
            MOVE      EMSTDESC,FHRLOCN
          ELSE 
            CLEAR     FHRWLOCC
            APPEND    "EmergencyLocation-",FHRWLOCC
            APPEND    EMVILOCN,FHRWLOCC
            RESET     FHRWLOCC
            MOVE      FHRWLOCC,FHRLOCN
          ENDIF
          BRANCH    STRETURN,EMRLOC99
          IF        F1=0
            WRITE     HTMLFILE;*+,"Emergency-",KEY3;
          ELSE 
            WRITE     HTMLFILE;*+,FHRLOCN;
          ENDIF
          GOTO      EMRLOC99
.
EMRLOC99  RETURN
+
. Inpatient Location
.
INPLOC00  PACK      KEY6,AWARD,SP70
          PACK      KEY3,ABED
          MOVE      SP70,KEY9 
          MATCH     SP70,AWARD
          IF        @EQUAL
            PACK      KEY14,AADMNO,SP70
            CALL      RDSWARD4
            CALL      RDKWARD4
            BRANCH    OVRCD,INPLOC80
            MATCH     WSTBY,AADMNO
            GOTO      INPLOC80 IF NOT EQUAL 
            PACK      KEY6,WWARD,SP70
            PACK      KEY3,WBED 
            MOVE      "(Standby)",KEY9 
          ENDIF
.
          IF        F1=0
            CLEAR     KEY16
            MATCH     SP70,KEY3
            IF        @EQUAL
              APPEND    "WARD-",KEY16
              MOVE      KEY6,WWARD
              APPEND    WWARD,KEY16
            ELSE
              APPEND    "Bed-",KEY16
              MOVE      KEY6,WWARD
              APPEND    WWARD,KEY16
              MOVE      KEY3,WBED
              APPEND    WBED,KEY16
            ENDIF
            APPEND    SP70,KEY16
            RESET     KEY16
            STRIP     KEY16
            REP       " -",KEY16
            WRITE     HTMLFILE;*+,KEY16;
          ELSE
            CLEAR     FHRWLOCC
            CLEAR     FHRBLOCC
            CLEAR     FHRLOCN
            CLEAR     FHRBLOCN
.
            MATCH     SP70,AWARD
            IF        !@EQUAL
              APPEND    "Ward-",FHRWLOCC
              APPEND    AWARD,FHRWLOCC
              
            ENDIF
.
            MATCH     SP70,ABED
            IF        !@EQUAL   
              APPEND    "Bed-",FHRBLOCC
              APPEND    AWARD,FHRBLOCC
              APPEND    ABED,FHRBLOCC
            ENDIF
.
            CALL      FWDNAM00
            CALL      FBDNAM00
.
            APPEND    SP70,FHRWLOCC
            APPEND    SP70,FHRBLOCC
            RESET     FHRWLOCC
            RESET     FHRBLOCC
            STRIP     FHRWLOCC
            STRIP     FHRBLOCC
            REP       " -",FHRWLOCC
            REP       " -",FHRBLOCC
            MOVE      FRWRDTXT,FHRLOCN
            MOVE      FRBEDTXT,FHRBLOCN
.
          ENDIF
          GOTO      INPLOC99
.
INPLOC80  CLEAR     FHRWLOCC
          CLEAR     FHRBLOCC
          CLEAR     FHRLOCN
          CLEAR     FHRBLOCN
.
          MATCH     SP70,PTMIXWRD
          IF        !@EQUAL
            APPEND    "Ward-",FHRWLOCC
            APPEND    PTMIXWRD,FHRWLOCC
            APPEND    SP70,FHRWLOCC
          ELSE
            IF        STRETURN=0
              WRITE     HTMLFILE;*+,"N/A";
            ELSE
              PACK      FHRBLOCC,SP70
              PACK      FHRWLOCC,SP70
              PACK      FHRLOCN,SP70
              PACK      FHRBLOCN,SP70
            ENDIF
            GOTO      INPLOC99
          ENDIF
.
          MATCH     SP70,PTMIEBED
          IF        !@EQUAL   
            APPEND    "Bed-",FHRBLOCC
            APPEND    PTMIXWRD,FHRBLOCC
            APPEND    PTMIEBED,FHRBLOCC
          ENDIF
.
          CALL      FWDNAM00
          CALL      FBDNAM00
.
          RESET     FHRBLOCC
          RESET     FHRWLOCC
          STRIP     FHRBLOCC
          STRIP     FHRWLOCC
          REP       " -",FHRWLOCC
          REP       " -",FHRBLOCC
          MOVE      FRWRDTXT,FHRLOCN
          MOVE      FRBEDTXT,FHRBLOCN
.
          GOTO      INPLOC99
.
INPLOC99  RETURN
+
. Emergency Encounter Status
.
EMSTA000  BRANCH    EMVISTAT,EMSTA110,EMSTA120,EMSTA130,EMSTA140
          GOTO      EMSTA999
EMSTA110  MATCH     SP70,EMVITRIG
          IF        @EQUAL
            MOVE      "arrived",FHRSTAT
          ELSE
            MOVE      "triaged",FHRSTAT
          ENDIF
          GOTO      EMSTA999
EMSTA120  MOVE      "finished",FHRSTAT
          GOTO      EMSTA999
EMSTA130  MOVE      "finished",FHRSTAT
          GOTO      EMSTA999
EMSTA140  MOVE      "cancelled",FHRSTAT
          GOTO      EMSTA999
EMSTA999  RETURN
+
. Outpatient Encounter Status
.
OPSTA000  BRANCH    OBASTAT,OPSTA110,OPSTA110,OPSTA110,OPSTA120,OPSTA130:
                            OPSTA110,OPSTA110,OPSTA110,OPSTA110
          GOTO      OPSTA999
OPSTA110  MOVE      "planned",FHRSTAT
          GOTO      OPSTA999
OPSTA120  MOVE      "finished",FHRSTAT
          GOTO      OPSTA999
OPSTA130  MOVE      "cancelled",FHRSTAT
          GOTO      OPSTA999
OPSTA999  RETURN
+ 
. Inpatient Encounter Status
.
INSTA000  BRANCH    ASTAT,INSTA110,INSTA120,INSTA130,INSTA140,INSTA150
INSTA110  MOVE      "planned",FHRSTAT
          GOTO      INSTA999
INSTA120  MOVE      "arrived",FHRSTAT
          GOTO      INSTA999
INSTA130  MOVE      "finished",FHRSTAT
          GOTO      INSTA999
INSTA140  MOVE      "onleave",FHRSTAT
          GOTO      INSTA999
INSTA150  MOVE      "cancelled",FHRSTAT
          GOTO      INSTA999
INSTA999  RETURN
+
.*******************************************************************************
. Get outpatient info
.*******************************************************************************
GETOUT00  MOVE      ZERO,EXIT
.
          MATCH     SP70,ADMISSNO
          GOTO      GETOUT90 IF EQUAL
.
          MOVE      "out",OSTFILE          * open default prefix of out
.         Get the outbokaf record
.
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDVISA1
          IF        OVRCD<>1
            MOVE      PVISITE,KEY6
            CALL      RDSITA1                      * site found ?
            BRANCH    OVRCD,GETOUT90
          ENDIF
.
          PACK      CFNAME,OSTFILE,FILBOKA6
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      OUTBOKA6,CFNAME              * outbokaf opened ?
          TRAPCLR   IO
          BRANCH    OVRCD,GETOUT90
.
          PACK      KEY36,ADMISSNO,SP70
          CALL      RDSBOKA6                     * position on visit number
          CALL      RDKBOKA6                     * read next record
          BRANCH    OVRCD,GETOUT90               * eof - finished
.
          MATCH     DOBAOUTN,ADMISSNO            * same visit number ?
          GOTO      GETOUT90 IF NOT EQUAL        * no - get next O/P record
.
.         Get the outbb1af record
.
          MOVE      ADMISSNO,KEY8
          CALL      RDBOKB1                      * outbb1af record found ?
          BRANCH    OVRCD,GETOUT90               * no
.
          GOTO      GETOUT99
.
GETOUT90  MOVE      ONE,EXIT
          GOTO      GETOUT99
.
GETOUT99  RETURN
+
.
.*******************************************************************************
. Check if Admission FIM already exists                               CAR 257776
.*******************************************************************************
CFAD0000  PACK      KEY24,ADMISSNO,SP70
          CALL      RDPTFIM1
CFAD1000  CALL      RKPTFIM1
          BRANCH    OVRCD,CFAD9999
.
          MATCH     PTFIVISN,ADMISSNO
          GOTO      CFAD9999 IF NOT EQUAL
.
          MATCH     "1",PTFIDELT
          GOTO      CFAD1000 IF EQUAL
.
          MATCH     ANSA,PTFITYPE
          IF        @EQUAL
            WRITE     HTMLFILE;ONE;
            GOTO      CFAD9999
          ENDIF
.
          GOTO CFAD1000
.
CFAD9999  RETURN
.
.*******************************************************************************
. Check if Discharge FIM already exists                               CAR 257776
.*******************************************************************************
CFDS0000  PACK      KEY24,ADMISSNO,SP70
          CALL      RDPTFIM1
CFDS1000  CALL      RKPTFIM1
          BRANCH    OVRCD,CFDS9999
.
          MATCH     PTFIVISN,ADMISSNO
          GOTO      CFDS9999 IF NOT EQUAL
.
          MATCH     "1",PTFIDELT
          GOTO      CFDS1000 IF EQUAL
.
          MATCH     ANSD,PTFITYPE
          IF        @EQUAL
            WRITE     HTMLFILE;ONE;
            GOTO      CFDS9999
          ENDIF
.
          GOTO CFDS1000
.
CFDS9999  RETURN
.
+
.*****************************************************************************
.         SX Insurer free text field
.*****************************************************************************
SXIN0000  MATCH     SP70,NZSPINSR
          GOTO      SXIN9999 IF EQUAL
.
          MOVE      "I ",KEY2
          PACK      KEY5,KEY2,NZSPINSR,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,SXIN9999
.
          MATCH     "O",TCINDC1
          GOTO      SXIN9999 IF NOT EQUAL    * Not Other Insurer
.
          MOVE      ADMISSNO,VSCTVIST
          MOVE      "006",VSCTTYPE
          MOVE      "  1",VSCTLINE
          PACK      KEY14,VSCTVIST,VSCTTYPE,VSCTLINE,SP70
          CALL      RDVSCMT1
          BRANCH    OVRCD,SXIN9999
.
          UNPACK    VSCTDATA,KEY50
          WRITE     HTMLFILE;KEY50;
SXIN9999  RETURN
+
.------------------------------------------------------------
. DISCOD00 - Get Disaster Code for UR/Visit No
.------------------------------------------------------------
DISCOD00  PACK      KEY25,URNUMBER,SP70
          CALL      RSDSPTL1
DISCOD10  CALL      RKDSPTL1
          BRANCH    OVRCD,DISCOD99
.
          MATCH     URNUMBER,DSPLURNO
          GOTO      DISCOD99 IF NOT EQUAL
.
          MATCH     ADMISSNO,DSPLVISN
          GOTO      DISCOD10 IF NOT EQUAL
.
          MATCH     SP70,DSPLCODE
          IF        !@EQUAL & !@EOS
            PACK      KEY9,DSPLCODE,SP70
            CALL      RDDSMAS1
            IF        OVRCD<>1
              WRITE     HTMLFILE;DSMADESC;
            ENDIF
          ENDIF
.
DISCOD99  RETURN
.------------------------------------------------------------
. DISID000 - Get Disaster ID
.------------------------------------------------------------
DISID000  PACK      KEY25,URNUMBER,SP70
          CALL      RSDSPTL1
DISID010  CALL      RKDSPTL1
          BRANCH    OVRCD,DISID999
.
          MATCH     URNUMBER,DSPLURNO
          GOTO      DISID999 IF NOT EQUAL
.
          MATCH     ADMISSNO,DSPLVISN
          GOTO      DISID010 IF NOT EQUAL
.
          PACK      KEY17,DSPLURNO,DSPLCODE,SP70
          CALL      RDDSPAT1
          BRANCH    OVRCD,DISID999
.
          MATCH     SP70,DSPTDIID
          GOTO      DISID999 IF EQUAL
          GOTO      DISID999 IF EOS
.
          WRITE     HTMLFILE;DSPTDIID;
          GOTO      DISID999
.
DISID999  RETURN
+
.------------------------------------------------------------
.         Get Stationery code for the claim code
.------------------------------------------------------------
DSTN0000  MATCH     SP70,ACLAIM
          GOTO      DSTN9999 IF EQUAL
.
          PACK      KEY5,ANSC,ANSL,ACLAIM
          CALL      RDCODE1
          BRANCH    OVRCD,DSTN9999
.
          UNPACK    SP70,IBTHSCOD,IBTHDESC
          MOVE      PTCDFELC,KEY6
          CALL      RDIBTH1
          BRANCH    OVRCD,DSTN9999
.
          BRANCH    F1,DSTN1000
          WRITE     HTMLFILE;IBTHSCOD;           * Stationery code
          GOTO      DSTN9999
.
DSTN1000  WRITE     HTMLFILE;IBTHDESC;           * Stationery description
DSTN9999  RETURN
+
.------------------------------------------------------------
. Set default printer for each financial election
.------------------------------------------------------------
DFPR0000  PACK      KEY5,ANSC,ANSL,ACLAIM
          CALL      RDCODE1
          BRANCH    OVRCD,DFPR9999
.
          MATCH     "A",TCINDC1
          IF        @EQUAL
            MOVE      "ELECTFRM0A",KEY10         * Australian Defence
            GOTO      DFPR8000
          ENDIF
          MATCH     "O",TCINDC1
          IF        @EQUAL
            MOVE      "ELECTFRM0O",KEY10         * Other Compensable
            GOTO      DFPR8000
          ENDIF
          MATCH     "M",TCINDC1
          IF        @EQUAL
            MOVE      "ELECTFRM0X",KEY10         * Motor Vehicle
            GOTO      DFPR8000
          ENDIF
          MATCH     "F",TCINDC1
          IF        @EQUAL
            MOVE      "ELECTFRM0F",KEY10         * Foreign Defence
            GOTO      DFPR8000
          ENDIF
          MATCH     "P",TCINDC1
          IF        @EQUAL
            MOVE      "ELECTFRM0P",KEY10         * Public
            GOTO      DFPR8000
          ENDIF
          MATCH     "E",TCINDC1
          IF        @EQUAL
            MOVE      "ELECTFRM0E",KEY10         * Overseas Student
            GOTO      DFPR8000
          ENDIF
          MATCH     "G",TCINDC1
          IF        @EQUAL
            MOVE      "ELECTFRM0G",KEY10         * Overseas Visitor
            GOTO      DFPR8000
          ENDIF
          MATCH     "H",TCINDC1
          IF        @EQUAL
            MOVE      "ELECTFRM0H",KEY10         * Private
            GOTO      DFPR8000
          ENDIF
          MATCH     "J",TCINDC1
          IF        @EQUAL
            MOVE      "ELECTFRM0J",KEY10         * Private Uninsured
            GOTO      DFPR8000
          ENDIF
          MATCH     "S",TCINDC1
          IF        @EQUAL
            MOVE      "ELECTFRM0S",KEY10         * Shipping
            GOTO      DFPR8000
          ENDIF
          MATCH     "V",TCINDC1
          IF        @EQUAL
            MOVE      "ELECTFRM0Y",KEY10         * Veterans Affairs
            GOTO      DFPR8000
          ENDIF
          MATCH     "W",TCINDC1
          IF        @EQUAL
            MOVE      "ELECTFRM0Z",KEY10         * Workers Compensation
          ENDIF
.
DFPR8000  BRANCH    F1,DFPR8200
          WRITE     HTMLFILE;KEY10;
          GOTO      DFPR9999
.
DFPR8200  PACK      KEY20,KEY10,WBSEUID,SP70
          CALL      RDIBPD1
          BRANCH    OVRCD,DFPR9999
          WRITE     HTMLFILE;IBPDPRT;
DFPR9999  RETURN
+
.------------------------------------------------------------
. Patient Financial Letters Type
.------------------------------------------------------------
SELFLT00  OPEN      PATFLET2,"patfltrf"
          PACK      KEY6,SP2,ZERO,SP3
          CALL      RSPTFL2
SELFLT10  CALL      RKPTFL2
          BRANCH    OVRCD,SELFLT99

          MATCH     "EW",PTFLTEXT
          GOTO      SELFLT10 IF EQUAL
.
          COMPARE   ZERO,PTFLLINO               * header line ?
          GOTO      SELFLT10 IF NOT EQUAL       * no
.
          MATCH     "1",PTFLACTV                 * Skip Inactive
          GOTO      SELFLT10 IF EQUAL
.
          PACK      KEY70,PTFLTEXT,SP30
          PACK      KEY8,QUOTE,DPTFLLTN,QUOTE
.
          WRITE     HTMLFILE;"<option value=",KEY8,">":
                    "(",DPTFLLTN,") ",KEY70,"</option>"
.
          GOTO      SELFLT10
.
SELFLT99  CLOSE     PATFLET2
          RETURN
+
.------------------------------------------------------------
. Patient Letter Types
.------------------------------------------------------------
SELPLT00  OPEN      PATLETR2,"patletrf"   
          MOVE      ZERO,PTLELINO
          PACK      KEY6,PTLELINO,SP70
          CALL      RSPTLET2
SELPLT10  CALL      RKPTLET2
          BRANCH    OVRCD,SELPLT99
.
          COMPARE   ZERO,PTLELINO
          GOTO      SELPLT99 IF NOT EQUAL
.
          MATCH     "1",PTLEACTV                 * Skip Inactive
          GOTO      SELPLT10 IF EQUAL
.
          MATCH     "1",PTLECOMM                 * Skip if SMS Message
          GOTO      SELPLT10 IF EQUAL
.
          WRITE     HTMLFILE;"<option value=",PTLELTNO,">",PTLETEXT:
                               "</option>";
          GOTO      SELPLT10
.
SELPLT99  CLOSE     PATLETR1
          RETURN
+
.------------------------------------------------------------------------
.  Check if patient has a cancelled preadmission
.------------------------------------------------------------------------
CHKPRE00  PACK      KEY17,URNUMBER,FIVE,SP70
          CALL      RSPTMI18
CHKPRE10  CALL      RKPTMI18
          BRANCH    OVRCD,CHKPRE90
.
          MATCH     URNUMBER,AURNO
          GOTO      CHKPRE90 IF NOT EQUAL
.
CHKPRE80  WRITE     HTMLFILE;ONE;
          GOTO      CHKPRE95
.
CHKPRE90  WRITE     HTMLFILE;ZERO;
.
CHKPRE95  PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
.
CHKPRE99  RETURN
.
.------------------------------------------------------------------------
.  Get last patient transfer record info
.------------------------------------------------------------------------
DISWRD00  PACK      KEY30,ADMISSNO,Z70
          CALL      RDSTRAN2
DISWRD10  CALL      RDPTRAN2
          BRANCH    OVRCD,DISWRD90
.
          MATCH     DTADMN,ADMISSNO
          GOTO      DISWRD90 IF NOT EQUAL
.
          MATCH     ANSD,TMOVE
          GOTO      DISWRD90 IF NOT EQUAL
          MOVE      TWARD,DISWARD
          MOVE      TBED,DISBED
          MOVE      TDEPT,DISUNIT
          GOTO      DISWRD99
.
DISWRD90  MOVE      SP8,DISWARD
          MOVE      SP8,DISBED
          MOVE      SP8,DISUNIT
.
DISWRD99  RETURN
.------------------------------------------------------------------------
.
.         ***************        HPS CODE ENDS HERE    ***************
.
.------------------------------------------------------------
. Table Outputs (Visit, Transfers, etc)
.------------------------------------------------------------
TABL0000  BRANCH    FLDITMNO,TABL0100,TABL0200,TABL0300,TABL0400,TABL0500:
                             TABL0600,TABL0700,TABL0800,TABL0900,TABL1000:
                             TABL1100,TABL1200,TABL1300,TABL1400,TABL1500:
                             TABL1600,TABL1700,TABL1800,TABL1900,TABL2000:
                             TABL2100,TABL2200,TABL2300,TABL2400,TABL2500:
                             TABL2600,TABL2700,TABL2800,TABL2900,TABL3000:
                             TABL3100,TABL3200,TABL3300,TABL3400,TABL3500:
                             TABL3600,TABL3700,TABL3800,TABL3900,TABL4000:
                             TABL4100,TABL4200,TABL4300,TABL4400,TABL4500:
                             TABL4600,TABL4700,TABL4800,TABL4900,TABL5000:
                             TABL5100,TABL5200,TABL5300,TABL5400,TABL5500:
                             TABL5600,TABL5700,TABL5800,TABL5900,TABL6000:
                             TABL6100,TABL6200,TABL6300,TABL6400,TABL6500:
                             TABL6600,TABL6700,TABL6800,TABL6900,TABL7000:
                             TABL7100,TABL7200,TABL7300,TABL7400,TABL7500:
                             TABL7600,TABL7700,TABL7800,TABL7900,TABL8000:
                             TABL8100,TABL8200,TABL8300,TABL8400,TABL8500:
                             TABL8600,TABL8700,TABL8800,TABL8900,TABL9000:
                             TABL9100,TABL9200,TABL9300,TABL9400,TABL9500:
                             TABL9600,TABL9700,TABL9800,TABL9900
          GOTO      TABL9999
.
TABL0100  CALL      VISTAB00
          GOTO      TABL9999
.
TABL0200  CALL      TRNTAB00
          GOTO      TABL9999
.
TABL0300  MOVE      ZERO,DISPFLAG             * Display MBS Only 
          CALL      MBSTAB00
          GOTO      TABL9999
.
TABL0400  CALL      OPRTAB00
          GOTO      TABL9999
.
TABL0500  CALL      DISTAB00
          GOTO      TABL9999
.
TABL0600  PROC      ALTAB000   * Patient Alerts Procedure 
          GOTO      TABL9999   * 1=Table, 2=Alert Category Select List 
.
TABL0700  CALL      DISPRA00                 * Display Previous Address Details
          GOTO      TABL9999 
.
TABL0800  PROC      CLNTAB00                 * Table of Clinical Notes
          GOTO      TABL9999 
.
TABL0900  CALL      NOTNXT00                 * Next Group of Notes
          GOTO      TABL9999                 
.
TABL1000  CALL      NOTPRE00                 * Previous Group of Notes
          GOTO      TABL9999                 
.
TABL1100  CALL      PATINV00                 * Invoice Details
          GOTO      TABL9999                 
.
TABL1200  CALL      PATFAC00                 * Future Action Details
          GOTO      TABL9999                 
.
TABL1300  CALL      BOKTAB00                 * Table of Future Bookings Details
          GOTO      TABL9999                 
.
TABL1400  WRITE     HTMLFILE;"<h1>Option Moved to WATWEB01.02.165</h1>";
          GOTO      TABL9999                 
.
TABL1500  MOVE      ZERO,VIEWFLAG
          CALL      MRTTAB00                 * Table of Medical Records 
          GOTO      TABL9999                 
.
TABL1600  CALL      APPTAB00                 * Table of Appointments
          GOTO      TABL9999                 
.
TABL1700  PROC      CHALI000                 * Check alias indicator
          GOTO      TABL9999                 
. 
TABL1800  CALL      MVDTAB00
          GOTO      TABL9999
.
TABL1900  CALL      MRVTAB00                 * Visits for MRT
          GOTO      TABL9999
.
TABL2000  WRITE     HTMLFILE;CLNOT001;
          GOTO      TABL9999
.
TABL2100  MOVE      WBSEC008,CODE
          MOVE      "w0",CATEGORY
          CALL      CODITM00
          GOTO      TABL9999
.
TABL2200  UNPACK    DIM127,D1,KEY3,DIM127
          MOVE      KEY3,FLDITMNO
          CALL      CLIF0000
          GOTO      TABL9999
.
TABL2300  CALL      MENTAB00                 * I SRF 22727
          GOTO      TABL9999
.
TABL2400  CALL      TABMWR00
          GOTO      TABL9999
.
TABL2500  CALL      TACTAB00                 * I SRF 18390 TAC Details List
          GOTO      TABL9999 
.
TABL2600  CALL      TACLKP00                 * I SRF 18390 TAC Lookup List 
          GOTO      TABL9999
.
TABL2700  CALL      VISITS00                 * Visit list by type
          GOTO      TABL9999
.
TABL2800  CALL      PREVGR00                 * Show previous group of records
          GOTO      TABL9999
.
TABL2900  CALL      NEXTGR00                 * Show next group of records
          GOTO      TABL9999
.
TABL3000  WRITE     HTMLFILE;FILTVTYP;       * Visit Type Filter
          GOTO      TABL9999
.
TABL3100  CALL      WCOLKP00                 * WCO Lookup List 
          GOTO      TABL9999
.
TABL3200  MOVE      ZERO,USETNOT1            * use standard tablesort
          CALL      WCOTAB00                 * I SRF 18390 TAC Details List
          GOTO      TABL9999 
.
TABL3300  CALL      UTCTAB00                 * Modify TAC claim number
          GOTO      TABL9999 
.
TABL3400  CALL      UWCTAB00                 * Modify WC claim number
          GOTO      TABL9999 
.
TABL3500  MOVE      ONE,VIEWFLAG 
          CALL      MRTTAB00                 * Table of Medical Records 
          GOTO      TABL9999                 
.
TABL3600  CALL      EMRTAB00                 * Pre admission list for Emr Map
          GOTO      TABL9999                 * to admit a pre admission
.
TABL3700  UNPACK    DIM127,DIM1,KEY3,DIM127
          MOVE      KEY3,FLDITMNO
          CALL      AAEF0000                 * AAE file details for enquiry
          GOTO      TABL9999
.
TABL3800  MOVE      ONE,DISPFLAG             * Allow update of MBS times
          CALL      MBSTAB00
          GOTO      TABL9999
.
TABL3900  WRITE     HTMLFILE;CCRDNUMB;      * concession card number
          GOTO      TABL9999
.
TABL4000  WRITE     HTMLFILE;CCRDTYPE;      * concession card type
          GOTO      TABL9999
.
TABL4100  MATCH     SP70,CCRDEXDT
          GOTO      TABL9999 IF EQUAL
.
          MATCH     SP70,CCRDEXDT
          GOTO      TABL9999 IF EOS
.
          UNPACK    CCRDEXDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      CCRDEXDT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          WRITE     HTMLFILE;CCRDEXDT;      * concession card expiry date
          GOTO      TABL9999
.
TABL4200  MATCH     SP70,FILTHOSP
          IF        @EQUAL
            IF        FILTFLAG=0
              MOVE      WBSEHOSP,FILTHOSP
            ENDIF
          ENDIF
          CALL      HSEL0000                * Hospital Selection List
          GOTO      TABL9999
.
TABL4300  MATCH     SP70,FILTHOSP
          IF        @EQUAL
            IF        FILTFLAG=0
              MOVE      WBSEHOSP,FILTHOSP
            ENDIF
          ENDIF
.
          CALL      VISITS00                 * Visit list by type
          GOTO      TABL9999
.
TABL4400  MOVE      WBSEHOSP,FILTHOSP
.
          COMPARE   ZERO,FILTVTYP         * Default filter to All visits
          IF        @EQUAL
            MOVE      ONE,FILTVTYP
          ENDIF
.
          CALL      VISITS00                 * Visit list by type
          GOTO      TABL9999
.
TABL4500  MOVE      ZERO,DVACFLAG           * not using DVA card colour
          CALL      CONT0000                 * First 5 consessions cards
          GOTO      TABL9999
.
TABL4600  CALL      ACCTAB00                 * ACC (nz) Accident List/s
          GOTO      TABL9999 
.           
TABL4700  CALL      APPSCH00                 * O/P Appointments Schedule list
          GOTO      TABL9999
.         
TABL4800  MATCH     FILTFDAT,SP70
          GOTO      TABL9999 IF EQUAL
          UNPACK    FILTFDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      TABL9999
.         
TABL4900  MATCH     FILTTDAT,SP70
          GOTO      TABL9999 IF EQUAL        
          UNPACK    FILTTDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      TABL9999
.
TABL5000  WRITE     HTMLFILE;SUPERLEV;
          GOTO      TABL9999
.
TABL5100  IF        DEFTFLAG=0
            MOVE      WBSEDALL,FILTDEPT
          ENDIF
          CALL      ARFD0000                * A/H department selection list
          GOTO      TABL9999
.
TABL5200  PACK      KEY8,URNUMBER,SP70
          CALL      RDPMRES1
          BRANCH    OVRCD,TABL9999
          WRITE     HTMLFILE;PMRSCOMM;
          GOTO      TABL9999
.
TABL5300  CALL      ACCSUM00                * ACC Summary List
          GOTO      TABL9999
.
TABL5400  MOVE      ONE,USETNOT1            * use tablesort1 (nz)
          CALL      WCOTAB00                 * I SRF 18390 TAC Details List
          GOTO      TABL9999 
.
TABL5500  MOVE      ZERO,NZFLAG
          CALL      LSTEXC00                * Extra contacts (not tablesort)
          GOTO      TABL9999
.
TABL5600  CALL      CEXT0000                * Extra contacts (tablesort)
          GOTO      TABL9999
.
TABL5700  WRITE     HTMLFILE;IBCNMHOS;      * MultiHospital flag
          GOTO      TABL9999
.
TABL5800  MOVE      ONE,DVACFLAG            * using DVA card colour
          CALL      CONT0000                 * First 5 consessions cards
          GOTO      TABL9999
.
TABL5900  UNPACK    DIM127,D1,KEY1
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          CALL      CLMLKP00                 * Look up for MVI
          GOTO      TABL9999
.
TABL6000  CALL      PRFAT000        * Person Responsible for account table
          GOTO      TABL9999
.
TABL6100  COMPARE   ONE,IBCNMHOS              * Exit if not multi hospital
          GOTO      TABL9999 IF NOT EQUAL
.
          MATCH     SP70,FILTHHOS
          IF        @EQUAL
            IF        FILTFLAG=0
              MOVE      WBSEHOSP,FILTHHOS       * Default home location hospital
              PACK      KEY3,WBSEHOSP           * filter to logged into 
              CALL      RDPTHSP1                * hospital mr home hospital
              IF        OVRCD<>1
                MATCH     SP70,PTHSHHOS          
                IF        !@EQUAL
                  MOVE      PTHSHHOS,FILTHHOS
                ENDIF
              ENDIF
            ENDIF                      
          ENDIF
          CALL      HHSL0000                 * Home location hospital filter 
          GOTO      TABL9999
.
TABL6200  WRITE     HTMLFILE;FILTHLOC;       * Home location filter
          GOTO      TABL9999
.
TABL6300  WRITE     HTMLFILE;EMVIPADM;       * ED linked IP admision number
          GOTO      TABL9999
.
TABL6400  PACK      KEY16,URNUMBER,Z70
          CALL      RSEMVIS3
TABL6450  CALL      RPEMVIS3
          BRANCH    OVRCD,TABL9999
.
          MATCH     URNUMBER,EMVIURNO        
          GOTO      TABL9999 IF NOT EQUAL
.
          MATCH     EMVIPADM,ADMISSNO
          GOTO      TABL6450 IF NOT EQUAL
.
          WRITE     HTMLFILE;EMVIADMN;      * Linked ED visit for IP
          GOTO      TABL9999
.
TABL6500  WRITE     HTMLFILE;VENQUIRY;
          GOTO      TABL9999
.
TABL6600  PACK      KEY8,ADMISSNO,SP70
          CALL      RDBKREC1
          BRANCH    OVRCD,TABL9999
.
          PACK      KEY19,BKREURNO,BKREPROC,BKRECNT,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,TABL9999
.
          WRITE     HTMLFILE;ONE;           * IP visit linked to WL
          GOTO      TABL9999
.
TABL6700  MOVE      "RE",CATEGORY
          PACK      CODE,MHDSREFT,SP70
          CALL      CODITM00
          GOTO      TABL9999
.
TABL6800  MOVE      "W5",CATEGORY
          PACK      CODE,MHDSUSR1,SP70
          CALL      CODITM00
          GOTO      TABL9999
.
TABL6900  WRITE     HTMLFILE;MHDIICD1;
          GOTO      TABL9999
.
TABL7000  WRITE     HTMLFILE;MHDIDES1;
          GOTO      TABL9999
.
TABL7100  WRITE     HTMLFILE;MHDIICD2;
          GOTO      TABL9999
.
TABL7200  WRITE     HTMLFILE;MHDIDES2;
          GOTO      TABL9999
.
TABL7300  WRITE     HTMLFILE;MHDIICD3;
          GOTO      TABL9999
.
TABL7400  WRITE     HTMLFILE;MHDIDES3;
          GOTO      TABL9999
.
TABL7500  CALL      MHDP0000                * mental health indc
          GOTO      TABL9999
.
TABL7600  PACK      KEY19,URNUMBER,SP20     * Get Waiting List procedure
          CALL      RDSTREA1
TABL7601  CALL      RDKTREA1
          BRANCH    OVRCD,TABL9999          * no procedures
.
          MATCH     URNUMBER,WMURNO         * same UR?
          GOTO      TABL9999 IF NOT EQUAL   * no; get next WL patient procedure
.
          MATCH     AADMNO,WMBOOK           * same booking?
          GOTO      TABL7601 IF NOT EQUAL   * no; get next WL patient procedure
.
          WRITE     HTMLFILE;WMDESC         * Principal Procedure description
          GOTO      TABL9999
.
TABL7700  PACK      KEY19,URNUMBER,SP20     * Get Waiting List procedure 
          CALL      RDSTREA1
TABL7701  CALL      RDKTREA1
          BRANCH    OVRCD,TABL9999          * no procedures
.
          MATCH     URNUMBER,WMURNO         * same UR?
          GOTO      TABL9999 IF NOT EQUAL   * no; get next WL patient procedure
.
          MATCH     AADMNO,WMBOOK           * same booking?
          GOTO      TABL7701 IF NOT EQUAL   * no; get next WL patient procedure
.
          PACK      KEY9,WTWMPRO2,SP20
          CALL      RDPROA1
          BRANCH    OVRCD,TABL9999
.
          WRITE     HTMLFILE;WPDESC
          GOTO      TABL9999
.
TABL7800  PACK      KEY19,URNUMBER,SP20     * Get Waiting List procedure
          CALL      RDSTREA1
TABL7801  CALL      RDKTREA1
          BRANCH    OVRCD,TABL9999          * no procedures
.
          MATCH     URNUMBER,WMURNO         * same UR?
          GOTO      TABL9999 IF NOT EQUAL   * no; get next WL patient procedure
.
          MATCH     AADMNO,WMBOOK           * same booking?
          GOTO      TABL7801 IF NOT EQUAL   * no; get next WL patient procedure
.
          PACK      KEY9,WTWMPRO3,SP20
          CALL      RDPROA1
          BRANCH    OVRCD,TABL9999
.
          WRITE     HTMLFILE;WPDESC
          GOTO      TABL9999
.
TABL7900  CALL      TRNSUP00                * supervisor transfer changes
          GOTO      TABL9999
.
TABL8000  CALL      TRNAUD00                * supervisor transfer audit list
          GOTO      TABL9999
.
TABL8100  CALL      LTRN0000                * Get KEY for Disc.record
          WRITE     HTMLFILE;DISCTRAN;
          GOTO      TABL9999
.
TABL8200  PACK      KEY16,ADMISSNO,SP70
          CALL      RSALLNK2
          CALL      RKALLNK2                * Check if OP visit is linked to 
          BRANCH    OVRCD,TABL9999          * an AH referral
.
          MATCH     ALLNLNKV,ADMISSNO
          GOTO      TABL9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;ALLNVISN;      * Linked AH referral number 
          GOTO      TABL9999
.
TABL8300  PACK      KEY16,ADMISSNO,SP70
          CALL      RSALLNK1
          CALL      RKALLNK1                * Check if AH Referral is linked to 
          BRANCH    OVRCD,TABL9999          * an OP visit
.
          MATCH     ALLNVISN,ADMISSNO
          GOTO      TABL9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;ALLNLNKV;      * Linked OP visit number
          GOTO      TABL9999
.
TABL8400  READ      CONTROLF,HUND20;*158,PTCNUNET  * Using NEHTA Identifiers?
          WRITE     HTMLFILE;PTCNUNET;
          GOTO      TABL9999
.
TABL8500  CALL      IHIN0000                * IHI Numbers
          GOTO      TABL9999
.
TABL8600  MATCH     SP70,PPOST
          GOTO      TABL9999 IF EQUAL
          MOVE      PPOST,KEY4
          SQUEEZE   KEY4
          WRITE     HTMLFILE;KEY4;
          GOTO      TABL9999
.
TABL8700  CALL      DISPRH00                 * Display Previous HCP Details
          GOTO      TABL9999
.
TABL8800  WRITE     HTMLFILE;NMDSSTAT;
          GOTO      TABL9999
.
TABL8900  WRITE     HTMLFILE;FILTSTAT;
          GOTO      TABL9999
.
TABL9000  CALL      ISMS0000                 * IP SMS letter selection list
          GOTO      TABL9999
.
TABL9100  MATCH     "1",PTCNSMSN            * Using SMS Messages
          GOTO      TABL9999 IF NOT EQUAL
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSOOSA1,"pmsoosaf"
          TRAPCLR   IO
          BRANCH    OVRCD,TABL9999
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDPMOOS1                * Check if Opt out of SMS
          BRANCH    OVRCD,TABL9999
.
          WRITE     HTMLFILE;ONE;
          CLOSE     PMSOOSA1
          GOTO      TABL9999
.
TABL9200  CALL      OSMS0000                 * OP SMS letter selection list
          GOTO      TABL9999
.
TABL9300  PACK      KEY24,ADMISSNO,SP70
          CALL      RSPMRUG1
TABL9310  CALL      RKPMRUG1
          IF        OVRCD=1
            GOTO      TABL9399
          ENDIF
.
          MATCH     ADMISSNO,PMRUVISN
          GOTO      TABL9399 IF NOT EQUAL
.
          MATCH     "1",PMRUDELF
          GOTO      TABL9310 IF EQUAL
.
          MATCH     "0",PMRUATYP
          GOTO      TABL9310 IF NOT EQUAL
.
          MATCH     SP8,PMRUPSDT
          IF        @EQUAL
            MOVE      "00000000",PMRUPSDT
          ENDIF
.
          MATCH     SP8,PMRUPEDT
          IF        @EQUAL
            MOVE      "99999999",PMRUPEDT
          ENDIF
.
          WRITE     HTMLFILE;"#"",PMRUPSDT,PMRUPEDT,"#",";
          GOTO      TABL9310
.
TABL9399  WRITE     HTMLFILE;"#" #"";
          GOTO      TABL9999
.
TABL9400  WRITE     HTMLFILE;IBAVAVIS;
          GOTO      TABL9999
.
. Anaesthetic Type, Dropdown List
TABL9500  MOVE      "OA",CATEGORY
          PACK      CODE,PMVXUD15,SP70
          CALL      CODITM00
          GOTO      TABL9999
.
TABL9600  WRITE     HTMLFILE;DISPDVAC;
          GOTO      TABL9999
.
TABL9700  UNPACK    DIM127,D1,KEY3,D1,D3,DIM127
          MOVE      ZERO,F3
          MOVE      D3,F3
          PACK      KEY14,ADMISSNO,KEY3,F3,SP70
          CALL      RDVSCMT1
          IF        OVRCD<>1
            STRIP    VSCTDATA
            MATCH    SP70,VSCTDATA
            IF       !@EQUAL & !@EOS
              WRITE    HTMLFILE;*+,VSCTDATA,SP1;
            ENDIF
          ENDIF
          GOTO      TABL9999
.
TABL9800  UNPACK    DIM127,D1,KEY3,DIM127
          MOVE      KEY3,FLDITMNO
          CALL      QMHD0000                * QLD HDP mental health
          GOTO      TABL9999
.
. Link to next tag set
.
TABL9900  UNPACK    DIM127,D1,KEY3,DIM127
          MOVE      KEY3,FLDITMNO
          CALL      TABX0000
          GOTO      TABL9999
.
TABL9999  RETURN
+
.------------------------------------------------------------------------------
. Extra tags from TABL0000
.------------------------------------------------------------------------------
TABX0000  BRANCH    FLDITMNO,TABX0100,TABX0200,TABX0300,TABX0400,TABX0500:
                             TABX0600,TABX0700,TABX0800,TABX0900,TABX1000:
                             TABX1100,TABX1200,TABX1300,TABX1400,TABX1500:
                             TABX1600,TABX1700,TABX1800,TABX1900,TABX2000:
                             TABX2100,TABX2200,TABX2300,TABX2400,TABX2500:
                             TABX2600,TABX2700,TABX2800,TABX2900,TABX3000
          GOTO      TABX9999
.
TABX0100  PACK      KEY6,ADOCTA,SP6
          CALL      RDDOCT1                 * Read the doctors file
          BRANCH    OVRCD,TABX9999
.
          MATCH     SP3,DRTYPE
          GOTO      TABX9999 IF EQUAL
.
          PACK      KEY5,ANSD,ANST,DRTYPE,SP70
          CALL      RDCODE1                 * Read the codes file
          BRANCH    OVRCD,TABX9999
.
          MATCH     PYAA,THCSCOD
          GOTO      TABX9999 IF LESS        * < PYAA
.
          MATCH     THCSCOD,PYZZ
          GOTO      TABX9999 IF LESS        * PYZZ <
.
          WRITE     HTMLFILE;ONE;           * MH attending doctor
          GOTO      TABX9999
.
TABX0200  UNPACK    DIM127,D1,KEY3,DIM127
          MOVE      KEY3,FLDITMNO
          CALL      HMHD0000                * HEA QLD HDP mental health
          GOTO      TABX9999
.
TABX0300  MOVE      PMVXUD15,CODE        * default code
          CALL      COAIHC00             * Cat OA for IHC
          GOTO      TABX9999
.
TABX0400  
          GOTO      TABX9999
.
TABX0500  
          GOTO      TABX9999
.
TABX0600  CALL      PMIAUD00
          GOTO      TABX9999
.
TABX0700  UNPACK    DIM127,D1,KEY3,DIM127
          MOVE      KEY3,FLDITMNO
          CALL      PMAD0000
          GOTO      TABX9999
.
TABX0800  CALL      WTPACM00
          GOTO      TABX9999
.
TABX0900  PACK      KEY8,ADMISSNO,SP70
          CALL      RDWCOM1
          BRANCH    OVRCD,TABX9999
          MATCH     SP70,WCCLMNO
          GOTO      TABX9999 IF EQUAL
          WRITE     HTMLFILE;WCCLMNO;
          GOTO      TABX9999
.
TABX1000  WRITE     HTMLFILE;CPMISKEY;
          GOTO      TABX9999
.
TABX1100  OPEN      PATATRA3,"patatraf"
          MOVE      ZERO,F1 * output 1 if MH legal status attribute exists
          PACK      KEY35,URNUMBER,ADMISSNO,ZERO,ONE,NINE,SP70
          CALL      RSPTATR3
          CALL      RKPTATR3
          BRANCH    OVRCD,TABX1190
.
          MATCH     URNUMBER,PTARURNO
          GOTO      TABX1190 IF NOT EQUAL
.
          MATCH     ADMISSNO,PTARVISN
          GOTO      TABX1190 IF NOT EQUAL
.
          MATCH     "019",PTARTYPE
          GOTO      TABX1190 IF NOT EQUAL
          MOVE      ONE,F1
.
TABX1190  WRITE     HTMLFILE;F1;
          CLOSE     PATATRA3
          GOTO      TABX9999
.
TABX1200  MOVE      ONE,NZFLAG
          CALL      LSTEXC00
          GOTO      TABX9999
.
.-------------------------------------------------------------------------
. Return a flag to indicate if the multiple birth attribute (022) exists
. for an ur number.
.-------------------------------------------------------------------------
TABX1300  OPEN      PATATRA3,"patatraf"
          MOVE      "0",DIM1
          PACK      KEY8,SP7,ZERO
          PACK      KEY35,URNUMBER,KEY8,ATYPE022,Z70
          CALL      RSPTATR3
TABX1302  CALL      RPPTATR3
          BRANCH    OVRCD,TABX1308
.
          MATCH     URNUMBER,PTARURNO
          GOTO      TABX1308 IF NOT EQUAL
.
          MATCH     KEY8,PTARVISN
          GOTO      TABX1308 IF NOT EQUAL
.
          MATCH     ATYPE022,PTARTYPE
          GOTO      TABX1308 IF NOT EQUAL
.
          MATCH     "1",PTARDELR
          GOTO      TABX1302 IF EQUAL
.
          MATCH     SP70,PTARFDTE
          GOTO      TABX1302 IF NOT EQUAL
.
          MATCH     SP70,PTARFTME
          GOTO      TABX1302 IF NOT EQUAL
.
          MOVE      "1",DIM1
.
TABX1308  WRITE     HTMLFILE;DIM1;
          CLOSE     PATATRA3
          GOTO      TABX9999
.
.-------------------------------------------------------------------------
. Return multiple order details (PTARTYPE = 022)
.-------------------------------------------------------------------------
TABX1400  OPEN      PATATRA3,"patatraf"
          MOVE      "Order Not Stated",DIM16
          PACK      KEY8,SP7,ZERO
          PACK      KEY35,URNUMBER,KEY8,ATYPE022,Z70
          CALL      RSPTATR3
TABX1402  CALL      RPPTATR3
          BRANCH    OVRCD,TABX1408
.
          MATCH     URNUMBER,PTARURNO
          GOTO      TABX1408 IF NOT EQUAL
.
          MATCH     KEY8,PTARVISN
          GOTO      TABX1408 IF NOT EQUAL
.
          MATCH     ATYPE022,PTARTYPE
          GOTO      TABX1408 IF NOT EQUAL
.
          MATCH     "1",PTARDELR
          GOTO      TABX1402 IF EQUAL
.
          MATCH     SP70,PTARFDTE
          GOTO      TABX1402 IF NOT EQUAL
.
          MATCH     SP70,PTARFTME
          GOTO      TABX1402 IF NOT EQUAL
.
          MATCH     SP70,PTARVAL1
          IF        !@EQUAL
            MATCH     "0",PTARVAL1
            IF        !@EQUAL
              MOVE      PTARVAL1,DIM16
            ENDIF
          ENDIF
.
          MOVE      "mX",KEY2
          PACK      KEY5,KEY2,PTARCOD1
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      PTARCOD1,TDESC
          ENDIF
          STRIP     TDESC
.
          CLEAR     DIM37
          APPEND    TDESC,DIM37
          APPEND    SP1,DIM37
          APPEND    DIM16,DIM37 
          RESET     DIM37
.
          WRITE     HTMLFILE;DIM37;
          CLOSE     PATATRA3
          GOTO      TABX9999
.
TABX1408  WRITE     HTMLFILE;"";
          CLOSE     PATATRA3
          GOTO      TABX9999
.
TABX1500  WRITE     HTMLFILE;CCIND1;
          GOTO      TABX9999
.
TABX1600  CALL      GTCCRD00
          GOTO      TABX9999
.
TABX1700  CALL      RECLST00
          GOTO      TABX9999
.
TABX1800  CALL      PREVRC00                 * previous recurriing care list
          GOTO      TABX9999
.
TABX1900  CALL      NEXTRC00                 * next recurriing care lis
          GOTO      TABX9999
.
TABX2000  CALL      STRTRC00
          GOTO      TABX9999
.
TABX2100  CLOSE     PATW19A1
          OPEN      PATATRA2,"patatraf"
          CALL      ATRFC000
          CLOSE     PATATRA2
          OPEN      PATW19A1,"patw19af"
          GOTO      TABX9999 
.
TABX2200  PACK      CMPAVALU,SP70,SP70,SP70,SP70
          MOVE      "PTCNPDTM",CPARPARM
          MOVE      IBCNMHOS,CPARMHOS
          MOVE      USERID,CPARUSER
          CALL      GTCMPA00
          BRANCH    CPARERRO,TABX2209
.
TABX2209  MOVE      CMPAVALU,DIM8
          WRITE     HTMLFILE;DIM8;
          GOTO      TABX9999
.
TABX2300  MOVE      ANSD,MOVETYPE
          CALL      WBDTYI00
          GOTO      TABX9999 
.
TABX2400  MOVE      ANSD,MOVETYPE
          CALL      WRMTYI00
          GOTO      TABX9999 
.
TABX2500  MATCH     SP70,DDEST
          GOTO      TABX2509 IF EQUAL
.
          MOVE      "DD",CATEGORY
          MOVE      DDEST,CODE
          CALL      GETCOD00
          MOVE      TCINDC1,DIM1
.
TABX2509  SQUEEZE   DIM1
          WRITE     HTMLFILE;DIM1;
          GOTO      TABX9999
.
TABX2600  WRITE     HTMLFILE;NORETURN;
          GOTO      TABX9999
.
TABX2700  CALL      DSCH0000
          GOTO      TABX9999
.
TABX2800  CALL      BKMS0000
          GOTO      TABX9999
.
TABX2900  CALL      TRNINS00                * Supervisor Insert Bed Movement
          GOTO      TABX9999
.
TABX3000  MOVE      "GI",CATEGORY
          PACK      KEY5,CATEGORY,SP3
          CALL      RDSCODE1
TABX3010  CALL      RDKCODE1
          BRANCH    OVRCD,TABX9999
.
          MATCH     CATEGORY,TCODE
          GOTO      TABX9999 IF NOT EQUAL
.
          MATCH     ANSB,TCINDC3
          GOTO      TABX3010 IF NOT EQUAL
.
          WRITE     HTMLFILE;TCINDC3;
          GOTO      TABX9999
.
TABX9999  RETURN
.
.-------------------------------------------------------------------------------
. Get latest pattranf for admissno/movement type
.-------------------------------------------------------------------------------
GPTTRN00  PACK      KEY30,ADMISSNO,Z70
          CALL      RDSTRAN2                     * position on admission number
GPTTRN20  CALL      RDPTRAN2                     * read previous record
          BRANCH    OVRCD,GPTTRN80
.
          MATCH     ADMISSNO,DTADMN              * same admission still ?
          GOTO      GPTTRN80 IF NOT EQUAL        * no - finished
.
          MATCH     MOVETYPE,TMOVE
          GOTO      GPTTRN20 IF NOT EQUAL
.
          GOTO      GPTTRN99
.
GPTTRN80  CALL      CLPATTRN
.
GPTTRN99  RETURN
.
.-------------------------------------------------------------------------------
. Write out ward bed type indictator 11
.-------------------------------------------------------------------------------
WBDTYI00  MOVE      SP70,DIM1
          CALL      GPTTRN00
.
          MATCH     SP70,TWARD
          GOTO      WBDTYI08 IF EQUAL
.
          PACK      KEY6,TWARD,TBED,SP70
          MATCH     SP70,KEY6
          GOTO      WBDTYI08 IF EQUAL
.
          CALL      RDWARD1
          BRANCH    OVRCD,WBDTYI08
.
          MATCH     SP70,WEFRBT
          GOTO      WBDTYI08 IF EQUAL
.
          MOVE      "BT",CATEGORY
          MOVE      WEFRBT,CODE
          CALL      GETCOD00
          MOVE      TCINDC11,DIM1
.
WBDTYI08  SQUEEZE   DIM1
          WRITE     HTMLFILE;DIM1;
.
WBDTYI09  RETURN
.
.-------------------------------------------------------------------------------
. Write out ward room type indictator 7
.-------------------------------------------------------------------------------
WRMTYI00  MOVE      SP70,DIM1
          CALL      GPTTRN00
.
          MATCH     SP70,TWARD
          GOTO      WRMTYI08 IF EQUAL
.
          PACK      KEY6,TWARD,TBED,SP70
          MATCH     SP70,KEY6
          GOTO      WRMTYI08 IF EQUAL
.
          CALL      RDWARD1
          BRANCH    OVRCD,WRMTYI08
.
          MATCH     SP70,WRTYPE
          GOTO      WRMTYI08 IF EQUAL
.
          MOVE      "RT",CATEGORY
          MOVE      WRTYPE,CODE
          CALL      GETCOD00
          MOVE      TCINDC7,DIM1
.
WRMTYI08  SQUEEZE   DIM1
          WRITE     HTMLFILE;DIM1;
.
WRMTYI09  RETURN
.
.------------------------------------------------------------------------------
. Get concession card details for NDIS
.------------------------------------------------------------------------------
GTCCRD00  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1 
          PACK      KEY19,URNUMBER,SP70
          CALL      RSPMCCD1
GTCCRD20  CALL      RKPMCCD1
          BRANCH    OVRCD,GTCCRD99
.
          MATCH     URNUMBER,PMCDURNO
          GOTO      GTCCRD99 IF NOT EQUAL
.
          PACK      KEY5,CATct,PMCDCTYP,SP70
          CALL      RDCODE1
          IF        OVRCD<>0
            MOVE      PMCDCTYP,TDESC
            GOTO      GTCCRD22
          ENDIF
.
          MATCH     "7",TCINDC1
          GOTO      GTCCRD20 IF EQUAL
.
GTCCRD22  BRANCH    F1,GTCCRD30,GTCCRD40,GTCCRD50
          GOTO      GTCCRD99
.
GTCCRD30  WRITE     HTMLFILE;TDESC;
          GOTO      TABX9999
.
GTCCRD40  WRITE     HTMLFILE;PMCDCNUM;
          GOTO      TABX9999
.
GTCCRD50  PACK      DISPDATE,SP70
          MATCH     SP70,PMCDEXDT
          IF        !@EQUAL
            UNPACK    PMCDEXDT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF

          WRITE     HTMLFILE;DISPDATE;
          GOTO      TABX9999
.
GTCCRD99  RETURN
+
.------------------------------------------------------------------------------
.         Output codes cat OA for Eclipse IHC
.------------------------------------------------------------------------------
COAIHC00  MOVE      SP70,TDESC
          PACK      KEY5,CATOA,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      CATOA,TCODE
            MOVE      "Invalid Category",TDESC
          ENDIF
          REP       " _",TCODE
          REP       " _",THCSCOD
          WRITE     HTMLFILE;"<!--<cat-c category=#"",TCODE,"#" name=#"",TDESC:
                             "#" map=#"",THCSCOD,"#"></cat-c>-->"
.
          PACK      PTCDKEY2,CATOA,SP70
          CALL      RDSCODE2
COAIHC10  CALL      RDKCODE2
          BRANCH    OVRCD,COAIHC99
          MATCH     CATOA,TCODE
          GOTO      COAIHC99 IF NOT EQUAL
.
          MATCH     SP70,ACODE
          GOTO      COAIHC10 IF EQUAL
.
          PACK      KEY60,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5:
                          TCINDC6,TCINDC7,TCINDC8,TCINDC9,TCINDC10:
                          TCINDC11,THCSCOD,PTCDNHCP,TCFORM6:
                          TCINDC12,TCINDC13,TCINDC14,TCINDC15,TCINDC16:
                          TCINDC17,TCINDC18,TCINDC19,TCINDC20,TCINDC21:
                          PTCOACTV,TCINDC22,TCINDC23,TCINDC24,TCINDC25:
                          TCINDC26,TCINDC27,TCINDC28,TCINDC29,TCINDC30:
                          TCINDC31,TCINDC32,TCINDC33,TCINDC34,TCINDC35:
                          TCINDC36,TCINDC37,TCINDC38,TCINDC39,TCINDC40:
                          TCINDC41
.
          MATCH     CODE,ACODE
          GOTO      COAIHC20 IF NOT EQUAL
.
.         prevent default ACODE from being listed/selected if not available
.         linked to the hospital
.
          IF        IBCNMHOS=1
            MATCH    "1",PTCDHOSS
            IF       @EQUAL
              PACK     KEY8,WBSEHOSP,TCODE,ACODE,SP70
              CALL     RDMLCOD1
              BRANCH   OVRCD,COAIHC10
            ENDIF
          ENDIF
.
          MATCH     "I",PTCOACTV               * Display active only
          GOTO      COAIHC10 IF EQUAL
.
          WRITE     HTMLFILE;"<option value=#"",ACODE,KEY60,"#" selected>":
                             TDESC,"</option>"
          GOTO      COAIHC10
.
COAIHC20  MATCH     "I",PTCOACTV
          GOTO      COAIHC10 IF EQUAL
.
          IF        IBCNMHOS=1
            MATCH    "1",PTCDHOSS
            IF       @EQUAL
              PACK     KEY8,WBSEHOSP,TCODE,ACODE,SP70
              CALL     RDMLCOD1
              BRANCH   OVRCD,COAIHC10
            ENDIF
          ENDIF
.
          MATCH     "1",TCINDC1
          GOTO      COAIHC60 IF EQUAL          * Local
.
          MATCH     "2",TCINDC1
          GOTO      COAIHC60 IF EQUAL          * General
.
          MATCH     "3",TCINDC1
          GOTO      COAIHC60 IF EQUAL          * Regional
.
          MATCH     "4",TCINDC1
          GOTO      COAIHC60 IF EQUAL          * Intravenous Sedation
.
          MATCH     "5",TCINDC1
          GOTO      COAIHC60 IF EQUAL          * No Anaesthetic
.
          GOTO      COAIHC10
.
COAIHC60  WRITE     HTMLFILE;"<option value=#"",ACODE,KEY60,"#">",TDESC:
                             "</option>"
          GOTO      COAIHC10
.
COAIHC99  RETURN
+
.------------------------------------------------------------------------------
.         Output table rows for IHI Numbers (with status & update date)
.------------------------------------------------------------------------------
IHIN0000  PACK      KEY31,URNUMBER,SP70
          CALL      RSPMAID1
IHIN1000  CALL      RKPMAID1
          BRANCH    OVRCD,IHIN9999
.
          MATCH     URNUMBER,PMAIURNO
          GOTO      IHIN9999 IF NOT EQUAL
.
          PACK      KEY5,ANSA,ANSI,PMAITYPE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,IHIN1000          * invalid type (Cat AI)
.
          MATCH     TCINDC2,ANSI
          GOTO      IHIN1000 IF NOT EQUAL   * not a IHI Number
.
          PACK      STATDESC,SP70
          MOVE      ZERO,F1
          MOVE      PMAIVSTA,F1
          LOAD      STATDESC,F1,VERSTAT1,VERSTAT2
.
          PACK      DISPDATE,SP70
          MATCH     SP70,PMAIUPDT
          IF        !@EQUAL
            UNPACK    PMAIUPDT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP10
          ENDIF
.
          LJUSTIFY  PMAIALID
          WRITE     HTMLFILE;"<tr><td><a href='javascript:IHIHistory(":
                             "#"",URNUMBER,"#",":
                             "#"",PMAIALID,"#");'>",PMAIALID:
                             "</a></td>":
                             "<td>&nbsp;&nbsp;",STATDESC,"</td>":
                             "<td>&nbsp;&nbsp;",DISPDATE,"</td></tr>";
          GOTO      IHIN1000
.
IHIN9999  RETURN
+
.-----------------------------------------------------------
.         Get KEY for discharge record
.-----------------------------------------------------------
LTRN0000  PACK      DISCTRAN,SP70
          PACK      KEY30,PVIBILL,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,LTRN9999
.
          MATCH     PVIBILL,TADMN
          GOTO      LTRN9999 IF NOT EQUAL
          CMATCH    "D",TMOVE
          GOTO      LTRN9999 IF NOT EQUAL
          PACK      DISCTRAN,TADMN,TDATE,TTIME,TWARD,TBED
.
LTRN9999  RETURN
+
.-----------------------------------------------------------
. Option 1 - DRG Information and Medical Record Options
. First up read DRG File if OVRCD set flag and continue
. This is done here as not to disrupt the Main Routine
.-----------------------------------------------------------
DRGS0000  MOVE      SP70,KEY3
          CALL      GTDRG000       * Get Grouper Version - returns it in KEY3
          COMPARE   ZERO,EPSCD001
          IF        @EQUAL
            MOVE      ONE,EPSCD001   * Set to default to 1 if blank
          ENDIF
          PACK      KEY13,ADMISSNO,EPSCD001,KEY3,SP70 
          CALL      RDPTPGR1   * Read Grouper Details
          IF        OVRCD=1
            PACK      KEY10,ADMISSNO,EPSCD001
            PACK      KEY13,KEY10,SP70 
            CALL      RSPTPGR1   * Read Grouper Details
            CALL      RKPTPGR1
            IF        OVRCD=0
              PACK      DIM10,PTPGADMN,PTPGEPNO
              MATCH     KEY10,DIM10
              GOTO      DRGS0040 IF EQUAL
            ENDIF
            CALL      CLRGRP00
          ENDIF
.
DRGS0040  CALL      CPDATS00                * establish Admission/Episode Dates
.
.  Now start normal branch on flditmno section
.
DRGS0050  BRANCH    FLDITMNO,DRGS0100,DRGS0200,DRGS0300,DRGS0400,DRGS0500:
                             DRGS0600,DRGS0700,DRGS0800,DRGS0900,DRGS1000:
                             DRGS1100,DRGS1200,DRGS1300,DRGS1400,DRGS1500:
                             DRGS1600,DRGS1700,DRGS1800,DRGS1900,DRGS2000:
                             DRGS2100,DRGS2200,DRGS2300,DRGS2400,DRGS2500:
                             DRGS2600,DRGS2700,DRGS2800,DRGS2900,DRGS3000:
                             DRGS3100,DRGS3200,DRGS3300,DRGS3400,DRGS3500:
                             DRGS3600,DRGS3700,DRGS3800
          GOTO      DRGS9999
.
DRGS0100  CALL      SELEPS00           * Selection List of Episodes
          GOTO      DRGS9999
.
DRGS0200  MOVE      "CC",CATEGORY
          MOVE      EPCCCODE,CODE
          CALL      CODITM00 
          GOTO      DRGS9999
.
DRGS0300  MOVE      "0",KEY1           * default Coding Incomplete
          IF        MRCNEPSC = 1
            MATCH     SP70,CHCODCMP
            IF        !@EQUAL
              MOVE      "1",KEY1       * Episode Coding Complete
            ENDIF
          ELSE
            MATCH     SP70,ACODDTE
            IF        !@EQUAL
              MOVE      "1",KEY1       * Coding Complete
            ENDIF
          ENDIF
          WRITE     HTMLFILE;KEY1;
          GOTO      DRGS9999
.
DRGS0400  CALL      SHWMAP00   * Set URL Routine           
          GOTO      DRGS9999
.
DRGS0500  WRITE     HTMLFILE;DPTPGADM;  * Admissno No            
          GOTO      DRGS9999
.
DRGS0600  WRITE     HTMLFILE;DPTPGEPN;  * Episode No                    
          GOTO      DRGS9999
.
DRGS0700  WRITE     HTMLFILE;PTPGGPVR;  * Grouper Version               
          GOTO      DRGS9999
.
DRGS0800  MOVE      PTPGNDRG,DDRGCODE   * National DRG                  
          CALL      DISDRG00            * DRG Details
          GOTO      DRGS9999
.
DRGS0900  WRITE     HTMLFILE;PTPGNMDC;  * National MDC                  
          GOTO      DRGS9999
.
DRGS1000  WRITE     HTMLFILE;PTPGNWGT;  * National Weight               
          GOTO      DRGS9999
.
DRGS1100  WRITE     HTMLFILE;PTPGNALS;  * National average LOS              
          GOTO      DRGS9999
.
DRGS1200  MOVE      PTPGSDRG,DDRGCODE   * State DRG                     
          CALL      DISDRG00            * DRG Details
          GOTO      DRGS9999
.
DRGS1300  WRITE     HTMLFILE;PTPGSMDC;  * State MDC                     
          GOTO      DRGS9999
.
DRGS1400  WRITE     HTMLFILE;PTPGSWGT;  * State Weight               
          GOTO      DRGS9999
.
DRGS1500  WRITE     HTMLFILE;PTPGSALS;  * State average LOS               
          GOTO      DRGS9999
.
DRGS1600  MOVE      PTPGLDRG,DDRGCODE   * Local DRG                     
          CALL      DISDRG00            * DRG Details
          GOTO      DRGS9999
.
DRGS1700  WRITE     HTMLFILE;PTPGLMDC;  * Local MDC                     
          GOTO      DRGS9999
.
DRGS1800  WRITE     HTMLFILE;PTPGLWGT;  * Local Weight               
          GOTO      DRGS9999
.
DRGS1900  WRITE     HTMLFILE;PTPGLALS;  * Local average LOS             
          GOTO      DRGS9999
.
DRGS2000  WRITE     HTMLFILE;PTPGPCCL;  * Patient CC class level        
          GOTO      DRGS9999
.
DRGS2100  WRITE     HTMLFILE;PTPGWFIX;  * WIES value fixed              
          GOTO      DRGS9999
.
DRGS2200  WRITE     HTMLFILE;PTPGWVAR;  * WIES value variable           
          GOTO      DRGS9999
.
DRGS2300  WRITE     HTMLFILE;PTPGWTOL;  * WIES value total              
          GOTO      DRGS9999
.
DRGS2400  WRITE     HTMLFILE;PTPGWWTU;  * WIES weight used              
          GOTO      DRGS9999
.
DRGS2500  WRITE     HTMLFILE;PTPGWWTD;  * WIES weight description       
          GOTO      DRGS9999
.
DRGS2600  CALL      WRDDIS00      * Output Discharge Ward Description   
          GOTO      DRGS9999
.
DRGS2700  WRITE     HTMLFILE;PTPGNDRG;  * National DRG
          GOTO      DRGS9999
.
DRGS2800  WRITE     HTMLFILE;PTPGSDRG;  * State DRG
          GOTO      DRGS9999
.
DRGS2900  WRITE     HTMLFILE;PTPGLDRG;  * Local DRG
          GOTO      DRGS9999
.
DRGS3000  MOVE      PTPGNDRG,DDRGCODE   * National DRG
          CALL      WIESVL00            * Display Wies Information
          GOTO      DRGS9999
.
DRGS3100  MOVE      PTPGSDRG,DDRGCODE   * State DRG
          CALL      WIESVL00            * Display Wies Information
          GOTO      DRGS9999
.
DRGS3200  MOVE      PTPGLDRG,DDRGCODE   * Local DRG
          CALL      WIESVL00            * Display Wies Information
          GOTO      DRGS9999
.
DRGS3300  CALL      CODUSR00            * Output Coder User ID
          GOTO      DRGS9999
.
DRGS3400  CALL      CODDAT00            * Output Coding Date and Time
          GOTO      DRGS9999
.
DRGS3500  PACK      KEY9,PMVXPICD,SP70
          CALL      RDPTICD1            * Read ICD disease record
          IF        OVRCD<>1
            WRITE     HTMLFILE;PT0DDSC2;
          ENDIF
          GOTO      DRGS9999
.
DRGS3600  WRITE     HTMLFILE;EPNODAYS;  * Episode or Admission LOS
          GOTO      DRGS9999
.
.                                       * Episode start date (or Admn Date)
DRGS3700  WRITE     HTMLFILE;EPSTTDIS;
          GOTO      DRGS9999
.
.                                       * Episode end date (or Disch Date)
DRGS3800  WRITE     HTMLFILE;EPENDDIS;
          GOTO      DRGS9999
.
DRGS9999  RETURN
.
.------------------------------------------------------------
. Other Fields - New way to add more fields than normally available   *I-253058
.------------------------------------------------------------
OTHS0000  ASSIGN    (FLDITMNO-49),FLDITMNO  * change Item nunbers back to 1
          BRANCH    FLDITMNO,OTHS0100,OTHS0200,OTHS0300,OTHS0400,OTHS0500:
                             OTHS0600,OTHS0700,OTHS0800,OTHS0900,OTHS1000
          GOTO      DRGS9999
.
.                                           * Misc stuff for NZ       *I-253058
OTHS0100  MOVE      ZERO,KEY1               * identify if MEH Visit
          PACK      KEY8,ADMISSNO
          CALL      RDMHVIS1                * read MEH visit table
          IF        OVRCD = 0
            MOVE      ONE,KEY1
          ENDIF
          WRITE     HTMLFILE;KEY1;          * 0= not MEH, 1= is MEH
          GOTO      OTHS9999
.
OTHS0200  MATCH     SP70,PMVXUDF7
          GOTO      OTHS9999 IF EQUAL
.
          MATCH     "1",PMVXUDF7
          IF        @EQUAL
            WRITE     HTMLFILE;"Yes";
          ELSE
            WRITE     HTMLFILE;"No";       * Upload to PCEHR
          ENDIF
          GOTO      OTHS9999
.
OTHS0300  PACK      MAX17,ZERODATE,ZEROTIME,ZERO
          READ      CONTROLF,HUND13;*064,KEY2
          MOVE      KEY2,FORM2
.
          IF        FORM2=0 | FORM2>14
            GOTO      OTHS0390
          ENDIF
.
          PACK      KEY31,ADMISSNO,SP70
          CALL      RSOPDEA2
OTHS0310  CALL      RKOPDEA2
          BRANCH    OVRCD,OTHS0390
.
          MATCH     ADMISSNO,OPDAADMN
          GOTO      OTHS0390 IF NOT EQUAL
.
          CALL      GTMX0000
          GOTO      OTHS0310
.
OTHS0390  WRITE     HTMLFILE;MAX17;
          GOTO      OTHS9999
.
OTHS0400  READ      CONTROLF,HUND28;*116,PTCNOHCS
          WRITE     HTMLFILE;PTCNOHCS;
          GOTO      OTHS9999;
.
OTHS0500  PACK      KEY14,URNUMBER,SP70
          CALL      RSPMCEX1
OTHS0510  CALL      RKPMCEX1
          BRANCH    OVRCD,OTHS9999
.
          MATCH     URNUMBER,PMCEURNO
          GOTO      OTHS9999 IF NOT EQUAL
.
          MATCH     SP70,PMCETELM
          IF        !@EQUAL
            MATCH     "1",PMCESSMS
            IF        @EQUAL
              PACK      KEY5,CATTC,PMCETYPE
              CALL      RDCODE1
              BRANCH    OVRCD,OTHS0510
.
              PACK      KEY10,PMCERELP,SP70
              CALL      RDPMREL1
              BRANCH    OVRCD,OTHS0510
.
              SQUEEZE   PMCEGNAM
              SQUEEZE   PMCESNAM
.
              WRITE     HTMLFILE;"<option value='",PMCETELM,"'>":
                                 PMCEGNAM," ",PMCESNAM," - ",PMRLDESC:
                                 "</option>";
              GOTO      OTHS0510
            ELSE
              GOTO      OTHS0510
            ENDIF
          ELSE
            GOTO      OTHS0510
          ENDIF
.
OTHS0600  PACK      KEY11,DAADMNO,ACLAIM
          CALL      RDPMEXT1
          BRANCH    OVRCD,OTHS0610
.
          UNPACK    DIM127,D1,KEY3,DIM127
          MOVE      ZERO,FLDITMNO
          MOVE      KEY3,FLDITMNO
          CALL      PMEX0000
          GOTO      OTHS9999
.
OTHS0610  UNPACK    DIM127,DIM8,DIM127
          WRITE     HTMLFILE;"No";
          GOTO      OTHS9999
.
OTHS0700  MOVE      ADMISSNO,VSXDC001       * Visit Number
          MOVE      TWO,VSTYPIND            * Type of Data
          MOVE      ONE,VSDATIND            * Date Field index (1-10)
          CALL      GETVDT00
          MATCH     SP70,VSDATVAL
          IF        !@EQUAL
            UNPACK    VSDATVAL,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          ENDIF
          GOTO      OTHS9999
.
OTHS0800  MOVE      ADMISSNO,VSXDC001       * Visit Number
          MOVE      TWO,VSTYPIND            * Type of Data
          MOVE      TWO,VSCODIND            * Code Field index (1-10)
          CALL      GETVCV00
.
          MATCH     SP70,VSCODVAL
          IF        !@EQUAL
            WRITE     HTMLFILE;VSCODVAL;
          ENDIF
          GOTO      OTHS9999
.
OTHS0900  IF        EMVISTAT = 2 | EMVISTAT = 3
            WRITE     HTMLFILE;"X";
          ELSE
            WRITE     HTMLFILE;"";
          ENDIF
          GOTO      OTHS9999
.
OTHS1000  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      KEY1,F1
.
          MOVE      "028",KEY3
          PACK      KEY35,URNUMBER,ADMISSNO,KEY3,Z70
          CLOSE     PATW19A1
          OPEN      PATATRA3,"patatraf"
          CALL      RSPTATR3
OTHS1005  CALL      RPPTATR3
          BRANCH    OVRCD,OTHS1050
.
          MATCH     URNUMBER,PTARURNO
          GOTO      OTHS1050 IF NOT EQUAL
.
          MATCH     ADMISSNO,PTARVISN
          GOTO      OTHS1050 IF NOT EQUAL
.
          MATCH     "028",PTARTYPE
          GOTO      OTHS1050 IF NOT EQUAL
.
          MATCH     "1",PTARDELR            * Deleted
          GOTO      OTHS1005 IF EQUAL
.
          BRANCH    F1,OTHS1010,OTHS1020,OTHS1030,OTHS1040
          GOTO      OTHS1050
.
OTHS1010  MATCH     SP70,PTARTXT1
          GOTO      OTHS1050 IF EQUAL
.
          UNPACK    PTARTXT1,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
.
          GOTO      OTHS1050
.
OTHS1020  MOVE      "z1",CATEGORY
          PACK      KEY5,CATEGORY,PTARCOD1
          MATCH     SP70,PTARCOD1
          GOTO      OTHS1050 IF EQUAL
.
          CALL      RDCODE1
.
          WRITE     HTMLFILE;TDESC;
          GOTO      OTHS1050
.
OTHS1030  MOVE      "z1",CATEGORY
          PACK      KEY5,CATEGORY,PTARCOD2
          MATCH     SP70,PTARCOD2
          GOTO      OTHS1050 IF EQUAL
.          
          CALL      RDCODE1
.
          WRITE     HTMLFILE;TDESC;
          GOTO      OTHS1050
.
OTHS1040  WRITE     HTMLFILE;PTARTXT2;
          GOTO      OTHS1050 
.
OTHS1050  CLOSE     PATATRA3
          OPEN      PATW19A1,"patw19af"
          GOTO      OTHS9999
.
OTHS9999  RETURN
.
.-------------------------------------------------------------------------------
. GTMX0000 - Returns maximum time from various fields/records
.-------------------------------------------------------------------------------
GTMX0000  BRANCH    FORM2,GTMX0100,GTMX0200,GTMX0300,GTMX0400,GTMX0500:
                          GTMX0600,GTMX0700,GTMX0800,GTMX0900,GTMX1000:
                          GTMX1100,GTMX1200,GTMX1300,GTMX1400
.
          GOTO      GTMX9999
.
GTMX0100  PACK      KEY10,OPDAUNIQ
          CALL      RDOPARD1
          BRANCH    OVRCD,GTMX9999
.
          MATCH     OPARTCAL,MAX17
          IF        @LESS
            PACK      MAX17,OPDADATE,OPARTCAL,ZERO
          ENDIF
.
          GOTO      GTMX9999
.
GTMX0200  PACK      KEY10,OPDAUNIQ
          CALL      RDOPARD1
          BRANCH    OVRCD,GTMX9999
.
          MATCH     OPARATIM,MAX17
          IF        @LESS
            PACK      MAX17,OPDADATE,OPARATIM,ZERO
          ENDIF
.
          GOTO      GTMX9999
.
GTMX0300  PACK      KEY10,OPDAUNIQ
          CALL      RDOPARD1
          BRANCH    OVRCD,GTMX9999
.
          MATCH     OPARANAP,MAX17
          IF        @LESS
            PACK      MAX17,OPDADATE,OPARANAP,ZERO
          ENDIF
.
          GOTO      GTMX9999
.
GTMX0400  PACK      KEY10,OPDAUNIQ
          CALL      RDOPARD1
          BRANCH    OVRCD,GTMX9999
.
          MATCH     OPARANAS,MAX17
          IF        @LESS
            PACK      MAX17,OPDADATE,OPARANAS,ZERO
          ENDIF
.
          GOTO      GTMX9999
.
GTMX0500  PACK      KEY11,OPDAUNIQ
          CALL      RSOPSRG1
GTMX0501  CALL      RKOPSRG1
          BRANCH    OVRCD,GTMX9999
.
          MATCH     OPDAUNIQ,OPSGUNID
          GOTO      GTMX9999 IF NOT EQUAL
.
          MATCH     OPSGTIPS,MAX17
          IF        @LESS
            REP       " 0",OPSGUY02
            PACK      MAX17,OPDADATE,OPSGTIPS,OPSGUY02
          ENDIF
.
          GOTO      GTMX0501
.
GTMX0600  PACK      KEY11,OPDAUNIQ
          CALL      RSOPSRG1
GTMX0601  CALL      RKOPSRG1
          BRANCH    OVRCD,GTMX9999
.
          MATCH     OPDAUNIQ,OPSGUNID
          GOTO      GTMX9999 IF NOT EQUAL
.
          MATCH     OPSGTISS,MAX17
          IF        @LESS
            REP       " 0",OPSGUY02
            PACK      MAX17,OPDADATE,OPSGTISS,OPSGUY02
          ENDIF
.
          GOTO      GTMX0601
.
GTMX0700  PACK      KEY11,OPDAUNIQ
          CALL      RSOPSRG1
GTMX0701  CALL      RKOPSRG1
          BRANCH    OVRCD,GTMX9999
.
          MATCH     OPDAUNIQ,OPSGUNID
          GOTO      GTMX9999 IF NOT EQUAL
.
          MATCH     OPSGTISE,MAX17
          IF        @LESS
            REP       " 0",OPSGUY02
            PACK      MAX17,OPDADATE,OPSGTISE,OPSGUY02
          ENDIF
.
          GOTO      GTMX0701
.
GTMX0800  PACK      KEY10,OPDAUNIQ
          CALL      RDOPARD1
          BRANCH    OVRCD,GTMX9999
.
          MATCH     OPARANAE,MAX17
          IF        @LESS
            PACK      MAX17,OPDADATE,OPARANAE,ZERO
          ENDIF
.
          GOTO      GTMX9999
.
GTMX0900  PACK      KEY11,OPDAUNIQ
          CALL      RSOPSRG1
GTMX0901  CALL      RKOPSRG1
          BRANCH    OVRCD,GTMX9999
.
          MATCH     OPDAUNIQ,OPSGUNID
          GOTO      GTMX9999 IF NOT EQUAL
.
          MATCH     OPSGTIDR,MAX17
          IF        @LESS
            REP       " 0",OPSGUY02
            PACK      MAX17,OPDADATE,OPSGTIDR,OPSGUY02
          ENDIF
.
          GOTO      GTMX0901
.

GTMX1000  PACK      KEY10,OPDAUNIQ
          CALL      RDOPARD1
          BRANCH    OVRCD,GTMX9999
.
          MATCH     OPARTIRF,MAX17
          IF        @LESS
            PACK      MAX17,OPDADATE,OPARTIRF,ZERO
          ENDIF
.
          GOTO      GTMX9999
.
GTMX1100  PACK      KEY10,OPDAUNIQ
          CALL      RDOPARD1
          BRANCH    OVRCD,GTMX9999
.
          MATCH     OPARTIRB,MAX17
          IF        @LESS
            PACK      MAX17,OPDADATE,OPARTIRB,ZERO
          ENDIF
.
          GOTO      GTMX9999
.
GTMX1200  PACK      KEY10,OPDAUNIQ
          CALL      RDOPARD1
          BRANCH    OVRCD,GTMX9999
.
          MATCH     OPARTIRD,MAX17
          IF        @LESS
            PACK      MAX17,OPDADATE,OPARTIRD,ZERO
          ENDIF
.
          GOTO      GTMX9999
.
GTMX1300  PACK      KEY10,OPDAUNIQ
          CALL      RDOPARD1
          BRANCH    OVRCD,GTMX9999
.
          MATCH     OPARTIDP,MAX17
          IF        @LESS
            PACK      MAX17,OPDADATE,OPARTIDP,ZERO
          ENDIF
.
          GOTO      GTMX9999
.
GTMX1400  PACK      KEY10,OPDAUNIQ
          CALL      RDOPARD1
          BRANCH    OVRCD,GTMX9999
.
          MATCH     OPARTETC,MAX17
          IF        @LESS
            PACK      MAX17,OPDADATE,OPARTETC,ZERO
          ENDIF
.
          GOTO      GTMX9999
.
GTMX9999  RETURN
.------------------------------------------------------------
. Codding Date & Time      
. 0.Date 1.Time  
.------------------------------------------------------------
CODDAT00  UNPACK    DIM127,DIM1,KEY1,DIM127
          MOVE      KEY1,F1
          MOVE      ZERO,ECDFLAG   * Diagnosis Episode Flag
          UNPACK    SP70,HIGHDATT,KEY20
.                                                         ( start )   *C-228354
          PACK      KEY13,ADMISSNO,EPSCD001,SP20
          CALL      RSPTECD1
CODDAT05  CALL      RKPTECD1
          BRANCH    OVRCD,CODDAT10
.
          MATCH     ADMISSNO,DPTEDADM       * same Admission ?
          GOTO      CODDAT10 IF NOT EQUAL
          COMPARE   EPSCD001,PTEDEPNO       * same Episode ?
          GOTO      CODDAT10 IF NOT EQUAL
.
          PACK      DIM13,PTEDDTCD,PTEDTIME,SP70
.
          MATCH     DIM13,HIGHDATT
          IF        @LESS
            PACK      HIGHDATT,PTEDDTCD,PTEDTIME,SP70
            PACK      KEY20,DPTEDADM,DPTEDEPN,DPTEDCNT,SP20
          ENDIF
          GOTO      CODDAT05
.
CODDAT10  MATCH     SP8,HIGHDATT
          IF        @EQUAL
            MOVE      ONE,ECDFLAG
            UNPACK    SP70,PTEDDTCD,PTEDCODE,DPTEDCNT,PTEDTIME
          ELSE
            PACK      KEY13,KEY20
            CALL      RDPTECD1              * read Disease with highest date
          ENDIF
.
.         Check episode operation coding
.
CODDAT20  UNPACK    SP70,HIGHDATT,KEY20
          PACK      KEY13,ADMISSNO,EPSCD001,SP70
          CALL      RSPTECO1
CODDAT25  CALL      RKPTECO1
          BRANCH    OVRCD,CODDAT30
.
          MATCH     ADMISSNO,DPTEOADM       * same Admission ?
          GOTO      CODDAT30 IF NOT EQUAL
          COMPARE   EPSCD001,PTEOEPNO       * same Episode ?
          GOTO      CODDAT30 IF NOT EQUAL
.
          PACK      DIM13,PTEODTCD,PTEOTIME,SP70
.
          MATCH     DIM13,HIGHDATT
          IF        @LESS
            PACK      HIGHDATT,PTEODTCD,PTEOTIME,SP70
            PACK      KEY20,DPTEOADM,DPTEOEPN,DPTEOCNT,SP20
          ENDIF
          GOTO      CODDAT25
.
CODDAT30  MATCH     SP8,HIGHDATT
          IF        @EQUAL
            UNPACK    SP70,PTEODTCD,PTEOCODE,DPTEOCNT,PTEOTIME
            IF        ECDFLAG=1
              GOTO      CODDAT60
            ELSE
              MOVE      PTEDDTCD,F8         * Set Disease Date
              MOVE      PTEDTIME,KEY5       * Set Disease Time
              GOTO      CODDAT45
            ENDIF
          ELSE
            PACK      KEY13,KEY20
            CALL      RDPTECO1              * read Procedure with highest date
          ENDIF
.                                           * end of changes for      *C-228354
.
CODDAT40  MATCH     PTEDDTCD,PTEODTCD
          IF        @EQUAL
            MATCH     PTEDTIME,PTEOTIME
            IF        @LESS          
              MOVE      PTEDDTCD,F8       * Set Disease Date
              MOVE      PTEDTIME,KEY5     * Set Disease Time
              GOTO      CODDAT45
            ELSE
              MOVE      PTEODTCD,F8       * Set Procedure Date
              MOVE      PTEOTIME,KEY5     * Set Procedure Time
              GOTO      CODDAT45
            ENDIF
          ENDIF
.
          MATCH     PTEDDTCD,PTEODTCD
          IF        @LESS          
            MOVE      PTEDDTCD,F8       * Set Disease Date
            MOVE      PTEDTIME,KEY5     * Set Disease Time
          ELSE         
            MOVE      PTEODTCD,F8       * Set Procedure Date
            MOVE      PTEOTIME,KEY5     * Set Procedure Time
          ENDIF
.
CODDAT45  COMPARE   ZERO,F8       * Check if F8 has anything init?
          GOTO      CODDAT60 IF EQUAL  
.
          MOVE      F8,KEY8      * Set Date as Dim variable
.
          BRANCH    F1,CODDAT50
.
          REP       " 0",KEY8    
          UNPACK    KEY8,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      CODDAT99
.
CODDAT50  WRITE     HTMLFILE;KEY5;
          GOTO      CODDAT99

.       if operation/disease coding record doesn't exist, use current date/time
.
CODDAT60  BRANCH    F1,CODDAT70
          MOVE      CMM,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY4,CCC,CYY
          REP       " 0",KEY4
          MOVE      CDD,KEY2
          REP       " 0",KEY2
          WRITE     HTMLFILE;KEY2,SP1,MTHNAM3,SP1,KEY4;
          GOTO      CODDAT99
.
CODDAT70  WRITE     HTMLFILE;CTIMEIS;
          GOTO      CODDAT99
.
CODDAT99  RETURN
.*************************************************************************
.    Set Coding Period Dates for either Episode Coding or Admission Coding
.*************************************************************************
CPDATS00  IF        MRCNEPSC <> 1
            DAYSEP    ADATE,CURRDATE,ADNODAYS
            PACK      EPSTTDAT,ADATE,SP10
            MOVE      CURRDATE,EPENDDAT
            IF        ASTAT = 3
              PACK      EPENDDAT,DDATE,SP10
              DAYSEP    ADATE,DDATE,ADNODAYS
            ENDIF
            MOVE      ACARE,EPCCCODE
.                                           * format StartDate and EndDate
            UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      EPSTTDIS,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP10
.           
            MOVE      SP20,EPENDDIS
            IF        ASTAT = 3
              UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
              MOVE      CMON,F2
              LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP:
                               OCT,NOV,DEC
              PACK      EPENDDIS,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP10
            ENDIF
.
            GOTO      CPDAT500
          ENDIF
.
.                                       * Read Patient Change table to get start
.                                       * & end dates for Episodic coding
          IF        ASTAT = 3
            DAYSEP    ADATE,DDATE,ADNODAYS
          ELSE
            DAYSEP    ADATE,CURRDATE,ADNODAYS
          ENDIF
          UNPACK    KEY10,DIM8,DIM2
          PACK      EPENDDAT,ADATE,SP10
          PACK      KEY26,ADMISSNO,SP20
          CALL      RDSCHCO2
CPDAT100  CALL      RDKCHCO2
          IF        OVRCD = 1
            MOVE      "99999999",DCHADMN
          ENDIF
          MATCH     ADMISSNO,DCHADMN
          IF        !@EQUAL
            IF        ASTAT = 3
              MOVE      "CC",CHCATG                 * build phantom patchcof
              MOVE      ACARE,CHCODE
              MOVE      ADMISSNO,DCHADMN
              MOVE      DDATE,CHDATE
              MOVE      DTIME,CHTIME
              UNPACK    SP70,CHCRDATE,CHCRTIME,CHCRUSID
              UNPACK    SP70,CHUPDATE,CHUPTIME,CHUPUSID
              MOVE      EPSCD001,CHEPISNO
              MOVE      ACODDTE,CHCODCMP
            ELSE
              CALL      CLPATCHC
              GOTO      CPDAT999
            ENDIF
          ENDIF

          MOVE      EPENDDAT,EPSTTDAT       * move previous date down
          PACK      EPENDDAT,CHDATE,SP10    * save this end date
.
          MOVE      EPSCD001,DIM2
          MATCH     DIM2,CHEPISNO
          GOTO      CPDAT100 IF LESS
.
.                                           * format data fields
          MOVE      CHCODE,EPCCCODE
.
CPDAT500  MOVE      ZERO,EPSNOLOS           * calculate Length of Stay
          MOVE      " Days",KEY5
          PACK      EPNODAYS,ADNODAYS,KEY5
          DAYSEP    EPSTTDAT,EPENDDAT,EPSNOLOS
          IF        MRCNEPSC = 1
            MOVE      "of",KEY2
            PACK      EPNODAYS,EPSNOLOS,KEY5,SP1,BRK1,KEY2,ADNODAYS,BRK2,SP20
          ENDIF
.                                           * format StartDate and EndDate
          MOVE      SP2,KEY2
          MATCH     EPSTTDAT,ADATE
          IF        !@EQUAL
            MOVE      " *",KEY2
          ENDIF
          UNPACK    EPSTTDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      EPSTTDIS,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,KEY2,SP10
.
          MOVE      SP2,KEY2
          MATCH     EPENDDAT,DDATE
          IF        !@EQUAL
            MOVE      " *",KEY2
          ENDIF
          UNPACK    EPENDDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      EPENDDIS,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,KEY2,SP10
.
CPDAT999  RETURN
.*************************************************************************
.  Out put Coder ID:  0.Desc 1.Code 2.Desc only if coded
.*************************************************************************
CODUSR00  UNPACK    DIM127,DIM1,KEY1,DIM127
          MOVE      KEY1,F1
.
          MOVE      ONE,PTEDEPNO
          MOVE      ONE,PTEDCNT
          PACK      KEY13,ADMISSNO,PTEDEPNO,PTEDCNT,SP70              *C-240107
          CALL      RDPTECD1
          BRANCH    OVRCD,CODUSR20
.
          MATCH     SP70,PTEDUSID         * Web user id
          GOTO      CODUSR05 IF NOT EQUAL 
.         
          MATCH     SP70,PTEDOPER         * user passcode
          GOTO      CODUSR20 IF EQUAL     
.         
          PACK      KEY14,PTEDOPER,SP70
          CALL      RSWBSE3
          CALL      RKWBSE3
          BRANCH    OVRCD,CODUSR20
.         
          MATCH     PTEDOPER,WBSEPCD
          GOTO      CODUSR20 IF NOT EQUAL
.         
          MOVE      WBSEUID,PTEDUSID
.
CODUSR05  PACK      KEY10,PTEDUSID,SP70   * Read Security File
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      PTEDUSID,WBSENAM
          ENDIF
.
          BRANCH    F1,CODUSR10
.
          WRITE     HTMLFILE;WBSENAM;
          GOTO      CODUSR99
.
CODUSR10  WRITE     HTMLFILE;WBSEUID;
          GOTO      CODUSR99
.
.         Check episode operation coding
.
CODUSR20  CALL      RDPTECO1
          BRANCH    OVRCD,CODUSR40
.
          MATCH     SP70,PTEOUSID         * Web user id
          GOTO      CODUSR25 IF NOT EQUAL
.
          MATCH     SP70,PTEOOPER         * user passcode
          GOTO      CODUSR40 IF EQUAL
.         
          PACK      KEY14,PTEOOPER,SP70
          CALL      RSWBSE3
          CALL      RKWBSE3
          BRANCH    OVRCD,CODUSR40
.         
          MATCH     PTEOOPER,WBSEPCD
          GOTO      CODUSR40 IF NOT EQUAL
.
          MOVE      WBSEUID,PTEOUSID
.
CODUSR25  PACK      KEY10,PTEOUSID,SP70  * Read Security File
          CALL      RDWBSE1
          BRANCH    OVRCD,CODUSR40
.
          BRANCH    F1,CODUSR30
.
          WRITE     HTMLFILE;WBSENAM;
          GOTO      CODUSR99
.
CODUSR30  WRITE     HTMLFILE;WBSEUID;
          GOTO      CODUSR99
.
.   if operation/disease coding record doesn't exist, use current Web User 
.   if not a .2 tag
CODUSR40  PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          BRANCH    F1,CODUSR50,CODUSR99    * Exit if .2 tag
.
          WRITE     HTMLFILE;WBSENAM;
          GOTO      CODUSR99
.
CODUSR50  WRITE     HTMLFILE;WBSEUID;
          GOTO      CODUSR99
.
CODUSR99  RETURN
.--------------------------------------------------------------------
...         **** WIES Details by discharge date ****
...
...       If using 10.0 Grouper then:
...          If Discharge date >= 2019/07/01 use WIES26
...       If using 9.0 Grouper then:
...          If Discharge date >= 2019/07/01 use WIES26
...          If Discharge date >= 2018/07/01 use WIES25
...       If using 8.0 Grouper then:
...          If Discharge date >= 2017/07/01 use WIES24
...          If Discharge date >= 2016/07/01 use WIES23
...       If using 7.0 Grouper then:
...          If Discharge date >= 2015/07/01 use WIES22
...          If Discharge date >= 2014/07/01 use WIES21
...       If using 6.0 Grouper then:
...          If Discharge date >= 2013/07/01 use WIES20
...          If Discharge date >= 2012/07/01 use WIES19
...          If Discharge date >= 2011/07/01 use WIES18
...          If Discharge date >= 2010/07/01 use WIES17
...          If Discharge date >= 2009/07/01 use WIES16
...          If Discharge date >= 2008/07/01 use WIES15
...       If using 5.2 Grouper then:
...          If Discharge date >= 2008/07/01 use WIES15
...          If Discharge date >= 2007/07/01 use WIES14
...       If using 5.1 Grouper then:
...          If Discharge date >= 2006/07/01 use WIES13.
...       If using 5.0 Grouper then:
...          If Discharge date >= 2004/07/01 use WIES12.
...          else If Discharge date >= ICD10v4 Cutover use WIES12
...                                    ( go-live earlier than 2004/07/01)
...            else use WIES11.
...
...       If using 4.2 Grouper then:
...            use WIES11.
...
...       Anything other use WIES12
...
... 0.LOS, 1.Low Trim, 2.High Trim, 3.Description, 4.Multiday Weight
... 5.Same Day Weight
... INPUT PARAMETER : DDRGCODE
.------------------------------------------------------------
WIESVL00  UNPACK    DIM127,DIM1,KEY1,DIM127   
          MOVE      ZERO,VIEWFLAG 
          MOVE      KEY1,VIEWFLAG
.
          PACK      KEY8,ADMISSNO,SP70  * Patient must be discharged!
          CALL      RDDSCH1
          BRANCH    OVRCD,WIESVL96
.
.
          MATCH     SP70,DDRGCODE
          IF        @EQUAL
            WRITE     HTMLFILE;"&nbsp;";
            GOTO      WIESVL99
          ENDIF
.
          MATCH     "1",PTCNUABF             * Check if using ABF
          IF        @EQUAL
            CALL      LCNT0000               * Check for a valid contract id
.
            MATCH     SP70,CONTRCID          * Valid contract
            IF        !@EQUAL
              CALL      ABFB2200
              GOTO      WIESVL99
            ENDIF
          ELSE
.         Using NWAU and discharge after go live date use NWAU 2022 - N22
            MATCH     "1",MRCNUNWA       * Grouping Products to return NWAU
            IF        @EQUAL
              MATCH     MRCNENWA,DDATE   * Use NWAU for discharges after date
              IF        !@LESS
                CALL      NWAU2200
                GOTO      WIESVL99
              ENDIF
            ENDIF
          ENDIF
.
.   * Check DRG version. For 10.0 WIES 27,26,25,24,23,22,21,20,19,18,17,16,15,14
          MATCH     DRG100,PTCNDGPV         * 10.0 DRG
          GOTO      WIESVL03 IF EQUAL
.
.   * Check DRG version. For 9.0  WIES 26,25,24,23,22,21,20,19,18,17,16,15,14
          MATCH     DRG090,PTCNDGPV         * 9.0 DRG
          GOTO      WIESVL03 IF EQUAL
.
.      * Check DRG version. For 8.0  WIES 24,23,22,21,20,19,18,17,16,15,14,13,12
          MATCH     DRG080,PTCNDGPV         * 8.0 DRG
          GOTO      WIESVL04 IF EQUAL
.                                                                     *I-284420
.      * Check DRG version. For 7.0  WIES 22,21,20,19,18,17,16,15,14,13,12,11,10
          MATCH     DRG070,PTCNDGPV         * 7.0 DRG
          GOTO      WIESVL05 IF EQUAL
.                                                                     *I-267797
.         * Check DRG version. For 6.2  WIES 19,18,17,16,15,14,13,12,11,10
          MATCH     DRG062,PTCNDGPV         * 6.2 DRG
          GOTO      WIESVL05 IF EQUAL
.                                                                     *I-197814
.         * Check DRG version. For 6.0  WIES 19,18,17,16,15,14,13,12,11,10
          MATCH     DRG060,PTCNDGPV         * 6.0 DRG
          GOTO      WIESVL05 IF EQUAL
.                                                                     *I-137125
.         * Check DRG version. For 5.2      support WIES 15,14,13,12,11,10
          MATCH     DRG052,PTCNDGPV         * 5.2 DRG
          GOTO      WIESVL06 IF EQUAL
.
.         * Check DRG version. For 5.1 only support WIES 13,12,11,10    *I-51504
          MATCH     DRG051,PTCNDGPV         * 5.1 DRG
          GOTO      WIESVL07 IF EQUAL
.
.         * Check DRG version. For 5.0 only support WIES 12,11,10      *I-51504
          MATCH     DRG050,PTCNDGPV         * 5.0 DRG
          GOTO      WIESVL08 IF EQUAL
.
.         * Check DRG version. For 4.2 only support WIES 11,10.9       *I-51504
          MATCH     DRG042,PTCNDGPV         * 4.2 DRG
          GOTO      WIESVL09 IF EQUAL
.
          GOTO      WIESVL60                * default to WIES 12
.
.
.             ------------- Check WIES 27,26,25,24,23,22,21,20,19,18,17,16,15,14
.
WIESVL03  MATCH     "20200701",DDATE      * 20/21 Fin year (DRG 10.0)
          IF        !@LESS
            CALL      WIES2700            * using WIES27
            GOTO      WIESVL99
          ENDIF
.
          MATCH     "20190701",DDATE      * 19/20 Fin year (DRG 10.0 9.0)
          IF        !@LESS
            CALL      WIES2600            * using WIES26
            GOTO      WIESVL99
          ENDIF
.
          MATCH     "20180701",DDATE      * 18/19 Fin year (DRG 9.0)
          IF        !@LESS
            CALL      WIES2500            * using WIES25
            GOTO      WIESVL99
          ENDIF
.
.                ------------- Check WIES 24,23,22,21,20,19,18,17,16,15,14,13,12
.
WIESVL04  MATCH     "20170701",DDATE      * 17/18 Fin year (DRG 8.0)
          IF        !@LESS
            CALL      WIES2400            * using WIES24
            GOTO      WIESVL99
          ENDIF
          MATCH     "20160701",DDATE      * 16/17 Fin year (DRG 8.0)
          IF        !@LESS
            CALL      WIES2300            * using WIES23
            GOTO      WIESVL99
          ENDIF
.
.                ------------- Check WIES 22,21,20,19,18,17,16,15,14,13,12,11,10
.
WIESVL05  MATCH     "20150701",DDATE      * 15/16 Fin year (DRG 7.0)
          IF        !@LESS
            CALL      WIES2200            * using WIES22
            GOTO      WIESVL99
          ENDIF
          MATCH     "20140701",DDATE      * 14/15 Fin year (DRG 7.0)
          IF        !@LESS
            CALL      WIES2100            * using WIES21
            GOTO      WIESVL99
          ENDIF
          MATCH     "20130701",DDATE      * 13/14 Fin year (DRG 7.0)
          IF        !@LESS
            CALL      WIES2000            * using WIES20
            GOTO      WIESVL99
          ENDIF
          MATCH     "20120701",DDATE      * 12/13 Fin year (DRG 6.0 6.2)
          IF        !@LESS
            GOTO      WIESVL90            * using WIES19
          ENDIF
          MATCH     "20110701",DDATE      * 11/12 Fin year (DRG 6.0 6.2)
          IF        !@LESS
            GOTO      WIESVL40            * using WIES18
          ENDIF
          MATCH     "20100701",DDATE      * 10/11 Fin year
          IF        !@LESS
            GOTO      WIESVL30            * using WIES17
          ENDIF
          MATCH     "20090701",DDATE      * 09/10 Fin year
          IF        !@LESS
            GOTO      WIESVL20            * using WIES16
          ENDIF
.
WIESVL06  MATCH     "20080701",DDATE      * 08/09 Fin year (DRG 5.2)
          IF        !@LESS
            GOTO      WIESVL10            * using WIES15
          ENDIF
          MATCH     "20070701",DDATE      * 07/08 Fin year
          IF        !@LESS
            GOTO      WIESVL80            * using WIES14
          ENDIF 
.
WIESVL07  MATCH     "20060701",DDATE      * 06/07 Fin year (DRG 5.1)
          IF        !@LESS
            GOTO      WIESVL70            * using WIES13
          ENDIF
          MATCH     "20040701",DDATE      * 04/05 Fin year
          IF        !@LESS
            GOTO      WIESVL60            * using WIES12
          ENDIF
          MATCH     PTCNGDV5,DDATE        * 05/06 ICD10 Ed.5
          IF        !@LESS
            GOTO      WIESVL60            * using WIES12
          ENDIF
          MATCH     PTCNGDV4,DDATE        * 04/05 ICD10 Ed.4 cutover early
          IF        !@LESS
            GOTO      WIESVL60            * using WIES12
          ENDIF
          GOTO      WIESVL50              * default to WIES11
.
.                                                  * Older stuff
WIESVL08  MATCH     "20040701",DDATE      * 04/05 Fin year
          IF        !@LESS
            GOTO      WIESVL60            * using WIES12 (5.0 DRG)
          ENDIF
          MATCH     PTCNGDV4,DDATE        * 04/05 ICD10 cutover early
          IF        !@LESS
            GOTO      WIESVL60            * using WIES12 (5.0 DRG)
          ENDIF
          GOTO      WIESVL50              * default to WIES11 (5.0 DRG)
.
.
WIESVL09  MATCH     "20030701",DDATE      * 03/04 Fin year
          IF        !@LESS
            GOTO      WIESVL50            * using WIES11 (4.2 DRG)
          ENDIF
.
          GOTO      WIESVL60                * default to WIES 12
.
.     ***** WIES 15 *****
.         
WIESVL10  PACK      KEY4,DDRGCODE,SP70
          MOVE      "patw15af",WIESFILE 
          OPEN      PATW15A1,"patw15af"
          CALL      RDPT151
          CLOSE     PATW15A1
          BRANCH    OVRCD,WIESVL98
.
          BRANCH    VIEWFLAG,WIESVL11,WIESVL12,WIESVL13,WIESVL14,WIESVL15
.
          WRITE     HTMLFILE;PT15ILOS;  * LOS
          GOTO      WIESVL99
.
WIESVL11  WRITE     HTMLFILE;PT15LIBP;  * Low Inliner Boundary Point(days)
          GOTO      WIESVL99
.
WIESVL12  WRITE     HTMLFILE;PT15HIBP;  * High Inliner Boundary Point(days)
          GOTO      WIESVL99
.
WIESVL13  WRITE     HTMLFILE;PT15DRGD;  * DRG Description
          GOTO      WIESVL99
.
WIESVL14  WRITE     HTMLFILE;PT15TIMW;  * Total Inlier Multiday Weight
          GOTO      WIESVL99
.
WIESVL15  WRITE     HTMLFILE;PT15TSDW;  * Total Same Day Weight
          GOTO      WIESVL99
.
.     ***** WIES 16 *****
.
WIESVL20  PACK      KEY4,DDRGCODE,SP70
          MOVE      "patw16af",WIESFILE
          OPEN      PATW16A1,"patw16af"
          CALL      RDPT161
          CLOSE     PATW16A1
          BRANCH    OVRCD,WIESVL98
.
          BRANCH    VIEWFLAG,WIESVL21,WIESVL22,WIESVL23,WIESVL24,WIESVL25
.
          WRITE     HTMLFILE;PT16ILOS;  * LOS
          GOTO      WIESVL99
.
WIESVL21  WRITE     HTMLFILE;PT16LIBP;  * Low Inliner Boundary Point(days)
          GOTO      WIESVL99
.
WIESVL22  WRITE     HTMLFILE;PT16HIBP;  * High Inliner Boundary Point(days)
          GOTO      WIESVL99
.
WIESVL23  WRITE     HTMLFILE;PT16DRGD;  * DRG Description
          GOTO      WIESVL99
.
WIESVL24  WRITE     HTMLFILE;PT16TIMW;  * Total Inlier Multiday Weight
          GOTO      WIESVL99
.
WIESVL25  WRITE     HTMLFILE;PT16TSDW;  * Total Same Day Weight
          GOTO      WIESVL99
.
.     ***** WIES 17 *****
.
WIESVL30  PACK      KEY4,DDRGCODE,SP70
          MOVE      "patw17af",WIESFILE
          OPEN      PATW17A1,"patw17af"
          CALL      RDPT171
          CLOSE     PATW17A1
          BRANCH    OVRCD,WIESVL98
.
          BRANCH    VIEWFLAG,WIESVL31,WIESVL32,WIESVL33,WIESVL34,WIESVL35
.
          WRITE     HTMLFILE;PT17ILOS;  * LOS
          GOTO      WIESVL99
.
WIESVL31  WRITE     HTMLFILE;PT17LIBP;  * Low Inliner Boundary Point(days)
          GOTO      WIESVL99
.
WIESVL32  WRITE     HTMLFILE;PT17HIBP;  * High Inliner Boundary Point(days)
          GOTO      WIESVL99
.
WIESVL33  WRITE     HTMLFILE;PT17DRGD;  * DRG Description
          GOTO      WIESVL99
.
WIESVL34  WRITE     HTMLFILE;PT17TIMW;  * Total Inlier Multiday Weight
          GOTO      WIESVL99
.
WIESVL35  WRITE     HTMLFILE;PT17TSDW;  * Total Same Day Weight
          GOTO      WIESVL99
.
.     ***** WIES 18 *****
.
WIESVL40  PACK      KEY4,DDRGCODE,SP70
          MOVE      "patw18af",WIESFILE
          OPEN      PATW18A1,"patw18af"
          CALL      RDPT181
          CLOSE     PATW18A1
          BRANCH    OVRCD,WIESVL98
.
          BRANCH    VIEWFLAG,WIESVL41,WIESVL42,WIESVL43,WIESVL44,WIESVL45
.
          WRITE     HTMLFILE;PT18ILOS;  * LOS
          GOTO      WIESVL99
.
WIESVL41  WRITE     HTMLFILE;PT18LIBP;  * Low Inliner Boundary Point(days)
          GOTO      WIESVL99
.
WIESVL42  WRITE     HTMLFILE;PT18HIBP;  * High Inliner Boundary Point(days)
          GOTO      WIESVL99
.
WIESVL43  WRITE     HTMLFILE;PT18DRGD;  * DRG Description
          GOTO      WIESVL99
.
WIESVL44  WRITE     HTMLFILE;PT18TIMW;  * Total Inlier Multiday Weight
          GOTO      WIESVL99
.
WIESVL45  WRITE     HTMLFILE;PT18TSDW;  * Total Same Day Weight
          GOTO      WIESVL99
.
.     ***** WIES 11 *****                                              *I-43498
.
WIESVL50  PACK      KEY4,DDRGCODE,SP70
          MOVE      "patw11af",WIESFILE
          OPEN      PATW11A1,"patw11af" 
          CALL      RDPT111
          CLOSE     PATW11A1
          BRANCH    OVRCD,WIESVL98
.
          BRANCH    VIEWFLAG,WIESVL51,WIESVL52,WIESVL53
.
          WRITE     HTMLFILE;PT11ILOS;  * LOS
          GOTO      WIESVL99
.
WIESVL51  WRITE     HTMLFILE;PT11LIBP;  * Low Inliner Boundary Point(days)
          GOTO      WIESVL99
.
WIESVL52  WRITE     HTMLFILE;PT11HIBP;  * High Inliner Boundary Point(days)
          GOTO      WIESVL99
.
WIESVL53  WRITE     HTMLFILE;PT11DRGD;  * DRG Description
          GOTO      WIESVL99
.
.     ***** WIES 12 *****                                              *I-51504
.
WIESVL60  PACK      KEY4,DDRGCODE,SP70
          MATCH     "20050701",DDATE
          IF        !@LESS
            MOVE      "patw12bf",WIESFILE
            OPEN      PATW12B1,"patw12bf" 
            CALL      RDPT12B1
            CLOSE     PATW12B1
            BRANCH    OVRCD,WIESVL98
          ELSE
            MOVE      "patw12af",WIESFILE
            OPEN      PATW12A1,"patw12af" 
            CALL      RDPT121
            CLOSE     PATW12A1
            BRANCH    OVRCD,WIESVL98
          ENDIF
.
          BRANCH    VIEWFLAG,WIESVL61,WIESVL62,WIESVL63,WIESVL64,WIESVL65
.
          WRITE     HTMLFILE;PT12ILOS;  * LOS
          GOTO      WIESVL99
.
WIESVL61  WRITE     HTMLFILE;PT12LIBP;  * Low Inliner Boundary Point(days)
          GOTO      WIESVL99
.
WIESVL62  WRITE     HTMLFILE;PT12HIBP;  * High Inliner Boundary Point(days)
          GOTO      WIESVL99
.
WIESVL63  WRITE     HTMLFILE;PT12DRGD;  * DRG Description
          GOTO      WIESVL99
.
WIESVL64  WRITE     HTMLFILE;PT12TIMW;  * Total Inlier Multiday Weight
          GOTO      WIESVL99
.
WIESVL65  WRITE     HTMLFILE;PT12TSDW;  * Total Same Day Weight
          GOTO      WIESVL99
.
.     ***** WIES 13 *****
.
WIESVL70  PACK      KEY4,DDRGCODE,SP70
          MOVE      "patw13af",WIESFILE
          OPEN      PATW13A1,"patw13af"
          CALL      RDPT131
          CLOSE     PATW13A1
          BRANCH    OVRCD,WIESVL98
.
          BRANCH    VIEWFLAG,WIESVL71,WIESVL72,WIESVL73,WIESVL74,WIESVL75
.
          WRITE     HTMLFILE;PT13ILOS;  * LOS
          GOTO      WIESVL99
.
WIESVL71  WRITE     HTMLFILE;PT13LIBP;  * Low Inliner Boundary Point(days)
          GOTO      WIESVL99
.
WIESVL72  WRITE     HTMLFILE;PT13HIBP;  * High Inliner Boundary Point(days)
          GOTO      WIESVL99
.
WIESVL73  WRITE     HTMLFILE;PT13DRGD;  * DRG Description
          GOTO      WIESVL99
.
WIESVL74  WRITE     HTMLFILE;PT13TIMW;  * Total Inlier Multiday Weight
          GOTO      WIESVL99
.
WIESVL75  WRITE     HTMLFILE;PT13TSDW;  * Total Same Day Weight
          GOTO      WIESVL99
.
.     ***** WIES 14 *****                                             *I-145161
.
WIESVL80  PACK      KEY4,DDRGCODE,SP70
          MOVE      "patw14af",WIESFILE
          OPEN      PATW14A1,"patw14af"
          CALL      RDPT141
          CLOSE     PATW14A1
          BRANCH    OVRCD,WIESVL98
.
          BRANCH    VIEWFLAG,WIESVL81,WIESVL82,WIESVL83,WIESVL84,WIESVL85
.
          WRITE     HTMLFILE;PT14ILOS;  * LOS
          GOTO      WIESVL99
.
WIESVL81  WRITE     HTMLFILE;PT14LIBP;  * Low Inliner Boundary Point(days)
          GOTO      WIESVL99
.
WIESVL82  WRITE     HTMLFILE;PT14HIBP;  * High Inliner Boundary Point(days)
          GOTO      WIESVL99
.
WIESVL83  WRITE     HTMLFILE;PT14DRGD;  * DRG Description
          GOTO      WIESVL99
.
WIESVL84  WRITE     HTMLFILE;PT14TIMW;  * Total Inlier Multiday Weight
          GOTO      WIESVL99
.
WIESVL85  WRITE     HTMLFILE;PT14TSDW;  * Total Same Day Weight
          GOTO      WIESVL99
.
.     ***** WIES 19 *****
.
WIESVL90  PACK      KEY4,DDRGCODE,SP70
          MOVE      "patw19af",WIESFILE
          CALL      RDPT191
          BRANCH    OVRCD,WIESVL98
.
          BRANCH    VIEWFLAG,WIESVL91,WIESVL92,WIESVL93,WIESVL94,WIESVL95
.
          WRITE     HTMLFILE;PT19ILOS;  * LOS
          GOTO      WIESVL99
.
WIESVL91  WRITE     HTMLFILE;PT19LIBP;  * Low Inliner Boundary Point(days)
          GOTO      WIESVL99
.
WIESVL92  WRITE     HTMLFILE;PT19HIBP;  * High Inliner Boundary Point(days)
          GOTO      WIESVL99
.
WIESVL93  WRITE     HTMLFILE;PT19DRGD;  * DRG Description
          GOTO      WIESVL99
.
WIESVL94  WRITE     HTMLFILE;PT19TIMW;  * Total Inlier Multiday Weight
          GOTO      WIESVL99
.
WIESVL95  WRITE     HTMLFILE;PT19TSDW;  * Total Same Day Weight
          GOTO      WIESVL99
.
.
WIESVL96  WRITE     HTMLFILE;"Patient is not Discharged!";
          GOTO      WIESVL99
.
WIESVL97  WRITE     HTMLFILE;"Discharge Date out of WIES Range!";
          GOTO      WIESVL99
.
WIESVL98  MOVE      "DRG Code not found on ",DIM22
          PACK      DIM30,DIM22,WIESFILE
          WRITE     HTMLFILE;DIM30;
          GOTO      WIESVL99
.
.
WIESVL99  RETURN
+
.------------------------
.     ***** WIES 20 *****
.------------------------
WIES2000  PACK      KEY4,DDRGCODE,SP70
          MOVE      "patw20af",WIESFILE
          CALL      RDPT201
          BRANCH    OVRCD,WIES2098
.
          BRANCH    VIEWFLAG,WIES2001,WIES2002,WIES2003,WIES2004,WIES2005
.
          WRITE     HTMLFILE;PT20ILOS;  * LOS
          GOTO      WIES2099
.
WIES2001  WRITE     HTMLFILE;PT20LIBP;  * Low Inliner Boundary Point(days)
          GOTO      WIES2099
.
WIES2002  WRITE     HTMLFILE;PT20HIBP;  * High Inliner Boundary Point(days)
          GOTO      WIES2099
.
WIES2003  WRITE     HTMLFILE;PT20DRGD;  * DRG Description
          GOTO      WIES2099
.
WIES2004  WRITE     HTMLFILE;PT20TIMW;  * Total Inlier Multiday Weight
          GOTO      WIES2099
.
WIES2005  WRITE     HTMLFILE;PT20TSDW;  * Total Same Day Weight
          GOTO      WIES2099
.
WIES2098  MOVE      "DRG Code not found on ",DIM22
          PACK      DIM30,DIM22,WIESFILE
          WRITE     HTMLFILE;DIM30;
          GOTO      WIES2099
.
WIES2099  RETURN
+
.------------------------
.     ***** WIES 21 *****
.------------------------
WIES2100  PACK      KEY4,DDRGCODE,SP70
          MOVE      "patw21af",WIESFILE
          CALL      RDPT211
          BRANCH    OVRCD,WIES2198
.
          BRANCH    VIEWFLAG,WIES2101,WIES2102,WIES2103,WIES2104,WIES2105
.
          WRITE     HTMLFILE;PT21ILOS;  * LOS
          GOTO      WIES2199
.
WIES2101  WRITE     HTMLFILE;PT21LIBP;  * Low Inliner Boundary Point(days)
          GOTO      WIES2199
.
WIES2102  WRITE     HTMLFILE;PT21HIBP;  * High Inliner Boundary Point(days)
          GOTO      WIES2199
.
WIES2103  WRITE     HTMLFILE;PT21DRGD;  * DRG Description
          GOTO      WIES2199
.
WIES2104  WRITE     HTMLFILE;PT21TIMW;  * Total Inlier Multiday Weight
          GOTO      WIES2199
.
WIES2105  WRITE     HTMLFILE;PT21TSDW;  * Total Same Day Weight
          GOTO      WIES2199
.
WIES2198  MOVE      "DRG Code not found on ",DIM22
          PACK      DIM30,DIM22,WIESFILE
          WRITE     HTMLFILE;DIM30;
          GOTO      WIES2199
.
WIES2199  RETURN
+
.------------------------
.     ***** WIES 22 *****
.------------------------
WIES2200  MOVE      "022",PTWIVRSN
          PACK      KEY7,DDRGCODE,PTWIVRSN,SP70
          MOVE      "patwieaf",WIESFILE
          CALL      RDPTWIE1
          BRANCH    OVRCD,WIES2298
.
          BRANCH    VIEWFLAG,WIES2201,WIES2202,WIES2203,WIES2204,WIES2205
.
          WRITE     HTMLFILE;PTWIILOS;  * LOS
          GOTO      WIES2299
.
WIES2201  WRITE     HTMLFILE;PTWILIBP;  * Low Inliner Boundary Point(days)
          GOTO      WIES2299
.
WIES2202  WRITE     HTMLFILE;PTWIHIBP;  * High Inliner Boundary Point(days)
          GOTO      WIES2299
.
WIES2203  WRITE     HTMLFILE;PTWIDRGD;  * DRG Description
          GOTO      WIES2299
.
WIES2204  WRITE     HTMLFILE;PTWITIMW;  * Total Inlier Multiday Weight
          GOTO      WIES2299
.
WIES2205  WRITE     HTMLFILE;PTWITDSW;  * Total Same Day Weight
          GOTO      WIES2299
.
WIES2298  MOVE      "DRG Code not found on ",DIM22
          PACK      DIM30,DIM22,WIESFILE
          WRITE     HTMLFILE;DIM30;
          GOTO      WIES2299
.
WIES2299  RETURN
+
.------------------------
.     ***** WIES 23 *****
.------------------------
WIES2300  MOVE      "023",PTWIVRSN
          PACK      KEY7,DDRGCODE,PTWIVRSN,SP70
          MOVE      "patwieaf",WIESFILE
          CALL      RDPTWIE1
          BRANCH    OVRCD,WIES2398
.
          BRANCH    VIEWFLAG,WIES2301,WIES2302,WIES2303,WIES2304,WIES2305
.
          WRITE     HTMLFILE;PTWIILOS;  * LOS
          GOTO      WIES2399
.
WIES2301  WRITE     HTMLFILE;PTWILIBP;  * Low Inliner Boundary Point(days)
          GOTO      WIES2399
.
WIES2302  WRITE     HTMLFILE;PTWIHIBP;  * High Inliner Boundary Point(days)
          GOTO      WIES2399
.
WIES2303  WRITE     HTMLFILE;PTWIDRGD;  * DRG Description
          GOTO      WIES2399
.
WIES2304  WRITE     HTMLFILE;PTWITIMW;  * Total Inlier Multiday Weight
          GOTO      WIES2399
.
WIES2305  WRITE     HTMLFILE;PTWITDSW;  * Total Same Day Weight
          GOTO      WIES2399
.
WIES2398  MOVE      "DRG Code not found for WIES23 ",DIM30
          WRITE     HTMLFILE;DIM30;
          GOTO      WIES2399
.
WIES2399  RETURN
+
.------------------------
.     ***** WIES 24 *****
.------------------------
WIES2400  MOVE      "024",PTWIVRSN
          PACK      KEY7,DDRGCODE,PTWIVRSN,SP70
          MOVE      "patwieaf",WIESFILE
          CALL      RDPTWIE1
          BRANCH    OVRCD,WIES2498
.
          BRANCH    VIEWFLAG,WIES2401,WIES2402,WIES2403,WIES2404,WIES2405
.
          WRITE     HTMLFILE;PTWIILOS;  * LOS
          GOTO      WIES2499
.
WIES2401  WRITE     HTMLFILE;PTWILIBP;  * Low Inliner Boundary Point(days)
          GOTO      WIES2499
.
WIES2402  WRITE     HTMLFILE;PTWIHIBP;  * High Inliner Boundary Point(days)
          GOTO      WIES2499
.
WIES2403  WRITE     HTMLFILE;PTWIDRGD;  * DRG Description
          GOTO      WIES2499
.
WIES2404  WRITE     HTMLFILE;PTWITIMW;  * Total Inlier Multiday Weight
          GOTO      WIES2499
.
WIES2405  WRITE     HTMLFILE;PTWITDSW;  * Total Same Day Weight
          GOTO      WIES2499
.
WIES2498  MOVE      "DRG Code not found for WIES24 ",DIM30
          WRITE     HTMLFILE;DIM30;
          GOTO      WIES2499
.
WIES2499  RETURN
+
.------------------------
.     ***** WIES 25 *****
.------------------------
WIES2500  MOVE      "025",PTWIVRSN
          PACK      KEY7,DDRGCODE,PTWIVRSN,SP70
          MOVE      "patwieaf",WIESFILE
          CALL      RDPTWIE1
          BRANCH    OVRCD,WIES2598
.
          BRANCH    VIEWFLAG,WIES2501,WIES2502,WIES2503,WIES2504,WIES2505
.
          WRITE     HTMLFILE;PTWIILOS;  * LOS
          GOTO      WIES2599
.
WIES2501  WRITE     HTMLFILE;PTWILIBP;  * Low Inliner Boundary Point(days)
          GOTO      WIES2599
.
WIES2502  WRITE     HTMLFILE;PTWIHIBP;  * High Inliner Boundary Point(days)
          GOTO      WIES2599
.
WIES2503  WRITE     HTMLFILE;PTWIDRGD;  * DRG Description
          GOTO      WIES2599
.
WIES2504  WRITE     HTMLFILE;PTWITIMW;  * Total Inlier Multiday Weight
          GOTO      WIES2599
.
WIES2505  WRITE     HTMLFILE;PTWITDSW;  * Total Same Day Weight
          GOTO      WIES2599
.
WIES2598  MOVE      "DRG Code not found for WIES25 ",DIM30
          WRITE     HTMLFILE;DIM30;
          GOTO      WIES2599
.
WIES2599  RETURN
+
.------------------------
.     ***** WIES 26 *****
.------------------------
WIES2600  MOVE      "026",PTWIVRSN
          PACK      KEY7,DDRGCODE,PTWIVRSN,SP70
          MOVE      "patwieaf",WIESFILE
          CALL      RDPTWIE1
          BRANCH    OVRCD,WIES2698
.
          BRANCH    VIEWFLAG,WIES2601,WIES2602,WIES2603,WIES2604,WIES2605
.
          WRITE     HTMLFILE;PTWIILOS;  * LOS
          GOTO      WIES2699
.
WIES2601  WRITE     HTMLFILE;PTWILIBP;  * Low Inliner Boundary Point(days)
          GOTO      WIES2699
.
WIES2602  WRITE     HTMLFILE;PTWIHIBP;  * High Inliner Boundary Point(days)
          GOTO      WIES2699
.
WIES2603  WRITE     HTMLFILE;PTWIDRGD;  * DRG Description
          GOTO      WIES2699
.
WIES2604  WRITE     HTMLFILE;PTWITIMW;  * Total Inlier Multiday Weight
          GOTO      WIES2699
.
WIES2605  WRITE     HTMLFILE;PTWITDSW;  * Total Same Day Weight
          GOTO      WIES2699
.
WIES2698  MOVE      "DRG Code not found for WIES26 ",DIM30
          WRITE     HTMLFILE;DIM30;
          GOTO      WIES2699
.
WIES2699  RETURN
+
.------------------------
.     ***** WIES 27 *****
.------------------------
WIES2700  MOVE      "027",PTWIVRSN
          PACK      KEY7,DDRGCODE,PTWIVRSN,SP70
          MOVE      "patwieaf",WIESFILE
          CALL      RDPTWIE1
          BRANCH    OVRCD,WIES2798
.
          BRANCH    VIEWFLAG,WIES2701,WIES2702,WIES2703,WIES2704,WIES2705
.
          WRITE     HTMLFILE;PTWIILOS;  * LOS
          GOTO      WIES2799
.
WIES2701  WRITE     HTMLFILE;PTWILIBP;  * Low Inliner Boundary Point(days)
          GOTO      WIES2799
.
WIES2702  WRITE     HTMLFILE;PTWIHIBP;  * High Inliner Boundary Point(days)
          GOTO      WIES2799
.
WIES2703  WRITE     HTMLFILE;PTWIDRGD;  * DRG Description
          GOTO      WIES2799
.
WIES2704  WRITE     HTMLFILE;PTWITIMW;  * Total Inlier Multiday Weight
          GOTO      WIES2799
.
WIES2705  WRITE     HTMLFILE;PTWITDSW;  * Total Same Day Weight
          GOTO      WIES2799
.
WIES2798  MOVE      "DRG Code not found for WIES27 ",DIM30
          WRITE     HTMLFILE;DIM30;
          GOTO      WIES2799
.
WIES2799  RETURN
+
.------------------------
.     ***** NWAU 2022 *****
.------------------------
NWAU2200  MOVE      "N22",PTWIVRSN
          PACK      KEY7,DDRGCODE,PTWIVRSN,SP70
          MOVE      "patwieaf",WIESFILE
          CALL      RDPTWIE1
          BRANCH    OVRCD,NWAU2298
.
          BRANCH    VIEWFLAG,NWAU2201,NWAU2202,NWAU2203,NWAU2204,NWAU2205
.
          WRITE     HTMLFILE;PTWIILOS;  * LOS
          GOTO      NWAU2299
.
NWAU2201  WRITE     HTMLFILE;PTWILIBP;  * Low Inliner Boundary Point(days)
          GOTO      NWAU2299
.
NWAU2202  WRITE     HTMLFILE;PTWIHIBP;  * High Inliner Boundary Point(days)
          GOTO      NWAU2299
.
NWAU2203  WRITE     HTMLFILE;PTWIDRGD;  * DRG Description
          GOTO      NWAU2299
.
NWAU2204  WRITE     HTMLFILE;PTWITIMW;  * Total Inlier Multiday Weight
          GOTO      NWAU2299
.
NWAU2205  WRITE     HTMLFILE;PTWITDSW;  * Total Same Day Weight
          GOTO      NWAU2299
.
NWAU2298  MOVE      "DRG Code not found for NWAU 2022",DIM30
          WRITE     HTMLFILE;DIM30;
          GOTO      NWAU2299
.
NWAU2299  RETURN
+
.------------------------
.     ***** ABF 2022 *****
.------------------------
ABFB2200  PACK      KEY10,CONTRCID,DDRGCODE,SP70
          CALL      RSPMPWA1 
          BRANCH    OVRCD,ABFB2298
.
          BRANCH    VIEWFLAG,ABFB2201,ABFB2202,ABFB2203,ABFB2204,ABFB2205
.
          WRITE     HTMLFILE;PMPWALOS;  * LOS
          GOTO      ABFB2299
.
ABFB2201  WRITE     HTMLFILE;PMPWLOWB;  * Low Inliner Boundary Point(days)
          GOTO      ABFB2299
.
ABFB2202  WRITE     HTMLFILE;PMPWUPPB;  * High Inliner Boundary Point(days)
          GOTO      ABFB2299
.
ABFB2203  WRITE     HTMLFILE;PMPWDRGD;  * DRG Description
          GOTO      ABFB2299
.
ABFB2204                                * Total Inlier Multiday Weight
          GOTO      NWAU2299
.
ABFB2205                                * Total Same Day Weight
          GOTO      ABFB2299
.
ABFB2298  MOVE      "DRG Code not found for ABF contract",DIM30
          WRITE     HTMLFILE;DIM30;
          GOTO      ABFB2299
.
ABFB2299  RETURN
+
.-------------------------------------------------------------------------------
.                        ****** CLRGRP00 ******
.-------------------------------------------------------------------------------
CLRGRP00  MOVE      SP70,DPTPGADM   * Admission no
          MOVE      SP70,DPTPGEPN   * Episode no
          MOVE      SP70,PTPGGPVR   * Grouper version
          MOVE      SP70,PTPGNDRG   * National DRG
          MOVE      SP70,PTPGNMDC   * National MDC
          MOVE      ZERO,PTPGNWGT   * National weight
          MOVE      ZERO,PTPGNALS   * National average LOS
          MOVE      SP70,PTPGSDRG   * State DRG
          MOVE      SP70,PTPGSMDC   * State MDC
          MOVE      ZERO,PTPGSWGT   * State weight
          MOVE      ZERO,PTPGSALS   * State average LOS
          MOVE      SP70,PTPGLDRG   * Local DRG
          MOVE      SP70,PTPGLMDC   * Local MDC
          MOVE      ZERO,PTPGLWGT   * Local weight
          MOVE      ZERO,PTPGLALS   * Local average LOS
          MOVE      SP70,PTPGPCCL   * Patient CC class level
          MOVE      ZERO,PTPGWFIX   * WIES value fixed
          MOVE      ZERO,PTPGWVAR   * WIES value variable
          MOVE      ZERO,PTPGWTOL   * WIES value total
          MOVE      ZERO,PTPGWWTU   * WIES weight used
          MOVE      SP70,PTPGWWTD   * WIES weight description
          MOVE      SP70,PTPGECRW   * ECCS RAW Format
          MOVE      SP70,PTPGSPAR   * Spare variable
.
CLRGRP99  RETURN
.**********************************************************************
.                 ****** WRDDIS00 ******
. Output Ward description
.**********************************************************************
WRDDIS00  IF        ASTAT <> 3
            WRITE     HTMLFILE;"Patient is not Discharged!";
            GOTO      WRDDIS99
          ENDIF
.
          PACK      KEY6,PTDSDWRD,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,WRDDIS90
.
          WRITE     HTMLFILE;WBDESC;    * description
          GOTO      WRDDIS99
.
WRDDIS90  WRITE     HTMLFILE;"Invalid Ward Code";
WRDDIS99  RETURN
.----------------------------------------------------------------
.                      SHWMAP00
.  Set url with its associated Episode No.
.----------------------------------------------------------------
SHWMAP00  REP       " +",URNUMBER
          REP       " +",ADMISSNO
          MOVE      EPSCD001,EPISODE
          REP       " +",EPISODE 
          UNPACK    DIM127,D1,KEY8,DIM127
          UNPACK    DIM127,D1,KEY2,DIM127
          UNPACK    DIM127,D1,FLDPARA,DIM127
          WRITE     HTMLFILE;KEY8,".pbl?reportno=",KEY2:
                                 "&template=",FLDPARA:
                                 "&urnumber=",URNUMBER:
                                 "&admissno=",ADMISSNO:
                                 "&epscd001=",EPISODE;
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
SHWMAP99  RETURN
.----------------------------------------------------------------
.  Outputs a selection list of Episode numbers for a given Admission
.                   ******** SELEPS00 ********
.----------------------------------------------------------------
SELEPS00  MOVE      ZERO,F2
          REPEAT
            ADD       ONE,F2
            MOVE      ZERO,EPSSLIST[F2]
          UNTIL     F2 = 99
.
          MOVE      " 1",DIM2               * Check Disease Coding file
          PACK      KEY13,ADMISSNO,DIM2,SP70
          CALL      RSPTECD1
SELEPS10  CALL      RKPTECD1
          BRANCH    OVRCD,SELEPS20
.
          MATCH     ADMISSNO,DPTEDADM       * Check for Admission No
          GOTO      SELEPS20 IF NOT EQUAL
.
          MATCH     SP70,PTEDCODE
          IF        !@EQUAL
            MOVE      ONE,EPSSLIST[PTEDEPNO]
          ENDIF
          GOTO      SELEPS10
.
.
SELEPS20  MOVE      " 1",DIM2               * Check Oper Coding File  *C-240107
          PACK      KEY13,ADMISSNO,DIM2,SP70
          CALL      RSPTECO1
SELEPS30  CALL      RKPTECO1
          BRANCH    OVRCD,SELEPS50
.
          MATCH     ADMISSNO,DPTEOADM    * Check for Admission No
          GOTO      SELEPS50 IF NOT EQUAL
.
          MATCH     SP70,PTEOCODE
          IF        !@EQUAL
            MOVE      ONE,EPSSLIST[PTEOEPNO]
          ENDIF
          GOTO      SELEPS30
.
.
SELEPS50  MOVE      ZERO,F2
          REPEAT
            ADD       ONE,F2
            IF        EPSSLIST[F2] = 1
              MOVE      F2,KEY2
              IF        F2 = EPSCD001
                WRITE     HTMLFILE;"<option value=#"",KEY2,"#" selected>":
                                    KEY2,"</option>"
              ELSE
                WRITE     HTMLFILE;"<option value=#"",KEY2,"#">":
                                    KEY2,"</option>"
              ENDIF
            ENDIF
          UNTIL     F2 = 99
.
SELEPS99  RETURN
.------------------------------------------------------------
.                     DRG Details
.      0.Description, 1.Code, 2.Low Trim, 3.High Trim
.      INPUT PARAMETER : DDRGCODE - DRG Code 
.------------------------------------------------------------
DISDRG00  UNPACK    DIM127,DIM1,KEY1,DIM127
          MOVE      KEY1,F1
.
          MATCH     SP70,DDRGCODE
          IF        @EQUAL
            WRITE     HTMLFILE;"&nbsp;";
            GOTO      DISDRG99
          ENDIF
.
          MOVE      DDRGCODE,KEY4
          MOVE      "999",KEY3
          PACK      KEY7,KEY4,KEY3,SP10   * last DRG version          *I-137125
          CALL      RSPTDGW1
          CALL      RPPTDGW1
          BRANCH    OVRCD,DISDRG90
          MATCH     PTDWDRGC,KEY4           * same DRG code ?         *I-137125
          GOTO      DISDRG90 IF NOT EQUAL                             *I-137125
.
          BRANCH    F1,DISDRG10,DISDRG20,DISDRG30
          WRITE     HTMLFILE;PTDWDESC; * Description
          GOTO      DISDRG99
.
DISDRG10  WRITE     HTMLFILE;PTDWDRGC;  * Code
          GOTO      DISDRG99
.
DISDRG20  WRITE     HTMLFILE;PTDWLOWT;  * Low Trim
          GOTO      DISDRG99
.
DISDRG30  WRITE     HTMLFILE;PTDWHIGH;  * High Trim
          GOTO      DISDRG99
.
DISDRG90  IF        F1 = ZERO
            WRITE     HTMLFILE;"DRG description not found";
          ENDIF
          IF        F1 = ONE
            WRITE     HTMLFILE;"DRG code not found";
          ENDIF
          IF        F1 > ONE
            WRITE     HTMLFILE;"DRG weightings record not found";
          ENDIF    
          GOTO      DISDRG99
.
DISDRG99  RETURN
.------------------------------------------------------------
. Output Future Action Table Details
.------------------------------------------------------------
PATFAC00  WRITE     HTMLFILE;"<tr><td class=HeadingCell>Date</td>":
                             "<td class=HeadingCell>Future Action</td>":
                             "<td class=HeadingCell>Comment</td></tr>"
          MATCH     SP70,ADMISSNO
          GOTO      PATFAC99 IF EQUAL
          PACK      KEY19,ADMISSNO,Z70
          CALL      RDSFACT1
PATFAC10  CALL      RDPFACT1
          BRANCH    OVRCD,PATFAC99
          MATCH     ADMISSNO,DFADMNO 
          GOTO      PATFAC99 IF NOT EQUAL
.
          PACK      KEY5,CODEFA,FACODE
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      SP70,TDESC
          ENDIF
          UNPACK    FADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;"<tr><td><a href='javascript:linkAction(#"":
                                URNUMBER,"#",#"",ADMISSNO,"#",#"":
                                CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"#")'>":
                             CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</a></td>":
                             "<td>",TDESC,"&nbsp;</td>":
                             "<td>",FACOMM,"&nbsp;</td></tr>"
          GOTO      PATFAC10
.
PATFAC99  RETURN
.------------------------------------------------------------
. Output Table of Future Bookings Details
.------------------------------------------------------------
BOKTAB00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          PACK      ENDDAT,CCC,CYY,CMM,CDD
          REP       " 0",ENDDAT
          MOVE      ZERO,VISCOUNT
          PACK      KEY36,URNUMBER,Z70
          CALL      RDSBOKA2
BOKTAB10  CALL      RDPBOKA2
          BRANCH    OVRCD,BOKTAB90
          MATCH     URNUMBER,OBAURNO
          GOTO      BOKTAB90 IF NOT EQUAL
          MATCH     ENDDAT,OBADATE
          GOTO      BOKTAB90 IF LESS
          ADD       ONE,VISCOUNT
          IF        VISCOUNT=1
            WRITE     HTMLFILE;"<tr><td class=HeadingCell>Booking No.</td>":
                               "<td class=HeadingCell align=center>Date</td>":
                               "<td class=HeadingCell>Clinic</td>":
                               "<td class=HeadingCell>Clinic Type</td></tr>"
          ENDIF
          UNPACK    OBADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          PACK      KEY12,OBASITE,OBACTYP,SP70
          CALL      RDCTYA1
.
          PACK      KEY20,OBASITE,OBACLIN,OBADATE,SP70
          CALL      RDCLIA1
          IF        OVRCD=1
            PACK      KEY20,OBASITE,OBACLIN,OBADATE,Z70
            CALL      RDSCLIA1          * Read Clinic Record
            CALL      RDPCLIA1
            BRANCH    OVRCD,BOKTAB10
.
            MATCH     OBASITE,OCASITE
            GOTO      BOKTAB10 IF NOT EQUAL
.
            MATCH     OBACLIN,OCACLIN
            GOTO      BOKTAB10 IF NOT EQUAL
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td><a href='javascript:linkPatient(#"":
                                URNUMBER,"#",#"",OBAOUTNO,"#",#"2#")'>":
                                OBAOUTNO,"</a></td>":
                             "<td>",CDAY,SP1,MTHNAM3,SP1,CYEAR,CCENT:
                             " at ",OBATIME,"</td>":
                             "<td>",OCTDESC,"&nbsp;</td>":
                             "<td>",OCADESC,"&nbsp;</td></tr>"
          GOTO      BOKTAB10
.
BOKTAB90
.
BOKTAB99  RETURN
.------------------------------------------------------------
. Table of Invoice Details
.------------------------------------------------------------
PATINV00  WRITE     HTMLFILE;"<tr><td class=HeadingCell>Invoice No.</td>";
.
          MATCH     "2",PTCNIRAI
          IF        @EQUAL
            WRITE     HTMLFILE;"<td class=HeadingCell>Invoice Date/Time</td>";
            WRITE     HTMLFILE;"<td class=HeadingCell>Raised By</td>";
          ELSE
            WRITE     HTMLFILE;"<td class=HeadingCell>Date</td>";
.
            MATCH     "1",PTCNIRAI
            IF        @EQUAL
              WRITE     HTMLFILE;"<td class=HeadingCell>Raised By</td>";
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"<td class=HeadingCell align=right>Total</td>":
                      "<td class=HeadingCell align=right>Paid</td>":
                      "<td class=HeadingCell align=right>Journals</td>":
                      "<td class=HeadingCell align=right>Outstanding</td></tr>"
          MOVE      ZERO,SUMINV
          MOVE      ZERO,SUMPAID
          MOVE      ZERO,SUMJR
          MOVE      ZERO,SUMOUTS
          MATCH     SP70,ADMISSNO
          GOTO      PATINV99 IF EQUAL
          PACK      KEY16,ADMISSNO,SP70
          CALL      RDSINV3
PATINV10  CALL      RDKINV3
          BRANCH    OVRCD,PATINV90
          MOVE      PINVADM,KEY8
          MATCH     KEY8,ADMISSNO
          GOTO      PATINV90 IF NOT EQUAL
.
          MOVE      PINVPATA,TOTPAID     * Total Paid
          ADD       PINVHFDA,TOTPAID
          ADD       PINVOTHA,TOTPAID
          MULT      SEQ,TOTPAID
          MULT      SEQ,PINVJOUR
.
          MOVE      PINVAMT,TOTOUTS      * Total Outstanding
          SUB       TOTPAID,TOTOUTS
          SUB       PINVJOUR,TOTOUTS
          MULT      SEQ,PINVJOUR
.
.         Accumulate totals
.
          ADD       PINVAMT,SUMINV
          ADD       TOTPAID,SUMPAID
          ADD       PINVJOUR,SUMJR
          ADD       TOTOUTS,SUMOUTS
.
          UNPACK    PINVDTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;"<tr><td><a href='javascript:linkInvoice(#"":
                                PINVNO,"#")'>":
                                PINVNO,"</a></td>";
.
          MATCH     "2",PTCNIRAI
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                               " at ",PTINCTIM,"</td>";
            GOTO      PATINV30
          ELSE
            WRITE     HTMLFILE;"<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>";
.
            MATCH     "1",PTCNIRAI
            GOTO      PATINV30 IF EQUAL
          ENDIF
.
          GOTO      PATINV40 IF NOT EQUAL
.
.-------- Raised By
PATINV30  PACK      KEY10,PTINCUID,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      SP70,WBSENAM
          ENDIF
          WRITE     HTMLFILE;"<td>&nbsp;",WBSENAM,"</td>";
.
PATINV40  WRITE     HTMLFILE;"<td align=right>",PINVAMT,"</td>":
                             "<td align=right>",TOTPAID,"</td>":
                             "<td align=right>",PINVJOUR,"</td>":
                             "<td align=right>",TOTOUTS,"</td></tr>"
          GOTO      PATINV10
.
PATINV90  WRITE     HTMLFILE;"<tr><td><b>Total</b>":
                             "<td>&nbsp;</td>";
.
          MATCH     "1",PTCNIRAI
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          MATCH     "2",PTCNIRAI
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td align=right><b>",SUMINV,"</b></td>":
                             "<td align=right><b>",SUMPAID,"</b></td>":
                             "<td align=right><b>",SUMJR,"</b></td>":
                             "<td align=right><b>",SUMOUTS,"</b></td></tr>"
.
PATINV99  RETURN
.------------------------------------------------------------
. Link to Next List of Notes
.------------------------------------------------------------
NOTNXT00  REP       " +",URNUMBER 
          REP       " +",ADMISSNO
          MOVE      LINKNUM,F2
          ASSIGN    F2+STARTNOT,F4
          MOVE      F4,KEY4
          REP       " +",KEY4
          WRITE     HTMLFILE;"patweb98.pbl?reportno=01":
                                     "&template=",TEMPLATE:
                                     "&urnumber=",URNUMBER:
                                     "&admissno=",ADMISSNO:
                                     "&startnot=",KEY4:
                                     "&clnot001=",CLNOT001:
                                     "&wbsec008=",WBSEC008;
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
          RETURN
.------------------------------------------------------------
. Link to Previous List of Notes
.------------------------------------------------------------
NOTPRE00  REP       " +",URNUMBER 
          REP       " +",ADMISSNO
          MOVE      LINKNUM,F2
          ASSIGN    STARTNOT-F2,F4
          IF        F4<1
            MOVE      ONE,F4
          ENDIF
          MOVE      F4,KEY4
          REP       " +",KEY4
          WRITE     HTMLFILE;"patweb98.pbl?reportno=01":
                                     "&template=",TEMPLATE:
                                     "&urnumber=",URNUMBER:
                                     "&admissno=",ADMISSNO:
                                     "&startnot=",KEY4:
                                     "&clnot001=",CLNOT001:
                                     "&wbsec008=",WBSEC008;
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
          RETURN
.------------------------------------------------------------
. Output Mental Health Table Details          * I SRF 22727
.------------------------------------------------------------
MENTAB00  MOVE      ZERO,DIM1
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,ANS,DIM127      * Visit Type Flag
          UNPACK    DIM127,D1,KEY1,DIM127     * Admission Status Flag
          UNPACK    DIM127,D1,DIM1,DIM127     * Check number of records
.
          MOVE      ZERO,VISTFLAG
          MOVE      ANS,VISTFLAG              * visit type
          MOVE      ZERO,DISCFLAG
          MOVE      KEY1,DISCFLAG             * admission status (astat)
          MOVE      ZERO,VISCOUNT
          MOVE      ZERO,RECCNT
          MOVE      ZERO,FINFLAG
          MOVE      ZERO,CHECKCNT
          MOVE      DIM1,CHECKCNT
.
          MATCH     "       0",URNUMBER
          GOTO      MENTAB99 IF EQUAL
.
          CALL      MENLST00                  * Mental Health Table
.
MENTAB99  RETURN                              * end I SRF 22727
.------------------------------------------------------------
. Output TAC Table Details          * I SRF 18390
.------------------------------------------------------------
TACTAB00  MOVE      ZERO,DIM1
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,ANS,DIM127      * Visit Type Flag
          UNPACK    DIM127,D1,KEY1,DIM127     * Admission Status Flag
          UNPACK    DIM127,D1,DIM1,DIM127     * Check number of records
.
          MOVE      ZERO,VISTFLAG
          MOVE      ANS,VISTFLAG              * visit type
          MOVE      ZERO,DISCFLAG
          MOVE      KEY1,DISCFLAG             * admission status (astat)
          MOVE      ZERO,VISCOUNT
          MOVE      ZERO,RECCNT
          MOVE      ZERO,FINFLAG
          MOVE      ZERO,CHECKCNT
          MOVE      DIM1,CHECKCNT
.
          MATCH     "       0",URNUMBER
          GOTO      TACTAB99 IF EQUAL
.
          CALL      TACLST00                  * TAC Details Table
.
TACTAB99  RETURN                              * end I SRF 18390               
.------------------------------------------------------------
. TACLKP00  : TAC Lookup Details              * I SRF 18390
.------------------------------------------------------------
TACLKP00  PACK      KEY16,URNUMBER,SP70
          CALL      RDSWMAB2
TACLKP10  CALL      RDKWMAB2
          BRANCH    OVRCD,TACLKP99
.
          MATCH     URNUMBER,PTWMURNO
          GOTO      TACLKP99 IF NOT EQUAL
.
          MOVE      SP70,ACCIDATE
          MATCH     SP70,MACDAT                    * Format Accident Date
          GOTO      TACLKP20 IF EQUAL
          UNPACK    MACDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      ACCIDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
TACLKP20  PACK      KEY8,DMADMNO,SP70
          CALL      RDPTVIS1
          BRANCH    OVRCD,TACLKP10
.
          BRANCH    PVITYPE,TACLKP21:              * Emergency           
                            TACLKP22:              * Outpatient
                            TACLKP23               * Inpatient
.
.         MOVE      NINE,DIM1
          COMPARE   NINE,PVITYPE
          GOTO      TACLKP24 IF EQUAL              * Allied Health
.
          MOVE      "Unkwn",VISTTYPE
          GOTO      TACLKP30
.
TACLKP21  MOVE      "EMG",VISTTYPE
          GOTO      TACLKP30
.
TACLKP22  MOVE      "OP",VISTTYPE
          GOTO      TACLKP30
.
TACLKP23  MOVE      "IP",VISTTYPE
          GOTO      TACLKP30
.
TACLKP24  MOVE      "2RF",VISTTYPE
          GOTO      TACLKP30
.
TACLKP30  MOVE      SP70,VISTDATE
          MATCH     SP70,PTWMVDAT                  * Format Visit Date
          GOTO      TACLKP40 IF EQUAL
          UNPACK    PTWMVDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      VISTDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.          
TACLKP40  WRITE     HTMLFILE;"<tr><td>":
                              "<img src=../images/MaintenanceIcon.gif ":
                              " class=ListIcon onclick='updateParent(#"":
                              MREFNO,"#",#"",ACCIDATE,"#",#"":
                              MACLOC,"#",#"",MOTHDET1,"#",#"":
                              MPOLIC,"#",#"",MOTHDET2,"#",#"":
                              MCREGO,"#",#"",MOTHDET3,"#",#"":
                              PTWMTYPE,"#",#"",MMDTRANS,"#",#"":
                              MENGAGED,"#",#"",MPINJURE,"#",#"":
                              MMECHSEV,"#",#"",MREGNSEV,"#",#"":
                              MSNAME,"#",#"",MSTELE,"#",#"":
                              MDPINDIC,"#");'> ":
                              MREFNO,"</td><td>&nbsp",ACCIDATE,"</td>":
                              "<td>&nbsp",MACLOC,"</td>":
                              "<td>&nbsp",VISTTYPE,"</td>":
                              "<td>&nbsp",VISTDATE,"</td>":
                              "<td>&nbsp",DMADMNO,"</td>":
                              "</tr>"
 
.         WRITE     HTMLFILE;"<tr><td>":
.                            "<img src=../images/MaintenanceIcon.gif ":
.                            " class=ListIcon onclick='updateParent(#"":
.                            MREFNO,"#",#"",MACDAT,"#",#"":
.                            MACLOC,"#");'> ":
.                            MREFNO,"</td><td>",MACDAT,"</td>":
.                            "</tr>"
.
          GOTO      TACLKP10  
.
TACLKP99  RETURN                           * end I SRF 18390
+
.------------------------------------------------------------
. WCOLKP00  : WCO Lookup Details  
.------------------------------------------------------------
WCOLKP00  MOVE      ZERO,UROUTEND
          PACK      KEY16,URNUMBER,Z70
          CALL      RDSWCOM2
WCOLKP10  CALL      RDPWCOM2
          BRANCH    OVRCD,WCOLKP99
.
          MATCH     URNUMBER,PTWCURNO
          GOTO      WCOLKP99 IF NOT EQUAL
.
          IF        PTCNHDPS=1
            CALL      CHOUT000
            BRANCH    EXIT,WCOLKP10
          ENDIF
.
          MOVE      DWCADMNO,KEY8
          CALL      RDPMWX11                * extension file
          IF        OVRCD=1
            CALL      CLPMSWX1
          ENDIF
.
          IF        PTCNHDPS=1
            MATCH     "3",PMWXCSTA          * Claim Status - Cancelled?
            GOTO      WCOLKP10 IF EQUAL
          ENDIF
.
WCOLKP15  MOVE      "001",COMMTYPE
          MOVE      "  1",COMMLINO
          PACK      SAVDATA1,SP70,SP70,SP70,SP70
          PACK      SAVDATNZ,SP70,SP70,SP70,SP70
.
          PACK      KEY26,WCCLMNO,COMMTYPE,COMMLINO,SP70
          CALL      RDACCMT1
          BRANCH    OVRCD,WCOLKP19
.
          MATCH     WCCLMNO,ACCMACCN
          GOTO      WCOLKP19 IF NOT EQUAL
          STRIP     ACCMDATA
          CLEAR     SAVDATA1
          CLEAR     SAVDATNZ
          APPEND    ACCMDATA,SAVDATA1
          APPEND    ACCMDATA,SAVDATNZ
          APPEND    "\n",SAVDATA1
WCOLKP16  CALL      RKACCMT1
          BRANCH    OVRCD,WCOLKP17
          MATCH     WCCLMNO,ACCMACCN
          GOTO      WCOLKP17 IF NOT EQUAL
          MATCH     "001",ACCMTYPE
          GOTO      WCOLKP17 IF NOT EQUAL
          ENDSET    SAVDATA1
          ENDSET    SAVDATNZ
.          APPEND    SP1,SAVDATA1
          APPEND    SP1,SAVDATNZ
          STRIP     ACCMDATA
          ENDSET    SAVDATA1
          ENDSET    SAVDATNZ
          APPEND    ACCMDATA,SAVDATA1
          APPEND    ACCMDATA,SAVDATNZ
          APPEND    "\n",SAVDATA1
.
          GOTO      WCOLKP16
.
WCOLKP17  RESET     SAVDATA1
          RESET     SAVDATNZ
          STRIP     SAVDATA1
          RESET     SAVDATNZ
.
WCOLKP18  MOVE      "002",COMMTYPE
          MOVE      "  1",COMMLINO
          PACK      SAVDATA2,SP70,SP70,SP70,SP70
.
          PACK      KEY26,WCCLMNO,COMMTYPE,COMMLINO,SP70
          CALL      RDACCMT1
          BRANCH    OVRCD,WCOLKP19
.         
          MATCH     WCCLMNO,ACCMACCN
          GOTO      WCOLK19A IF NOT EQUAL
          STRIP     ACCMDATA
          CLEAR     SAVDATA2
          APPEND    ACCMDATA,SAVDATA2
          APPEND    "\n",SAVDATA2
WCOLK18A  CALL      RKACCMT1
          BRANCH    OVRCD,WCOLKP19
          MATCH     WCCLMNO,ACCMACCN
          GOTO      WCOLKP19 IF NOT EQUAL
          MATCH     "002",ACCMTYPE
          GOTO      WCOLKP19 IF NOT EQUAL
          ENDSET    SAVDATA2
.          APPEND    SP1,SAVDATA2
          STRIP     ACCMDATA
          ENDSET    SAVDATA2
          APPEND    ACCMDATA,SAVDATA2
          APPEND    "\n",SAVDATA2
.
          GOTO      WCOLK18A
.
WCOLKP19  RESET     SAVDATA2
          STRIP     SAVDATA2
.
WCOLK19A  MOVE      SP70,ACCIDATE
          MATCH     SP70,WCACDAT                   * Format Accident Date
          GOTO      WCOLKP20 IF EQUAL
          UNPACK    WCACDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      ACCIDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
WCOLKP20  PACK      KEY8,DWCADMNO,SP70
          CALL      RDPTVIS1
          IF        OVRCD=1
            MOVE      "2",PVITYPE
          ENDIF
.
          BRANCH    PVITYPE,WCOLKP21:              * Emergency           
                            WCOLKP22:              * Outpatient
                            WCOLKP23               * Inpatient
.
.         MOVE      NINE,DIM1
          COMPARE   NINE,PVITYPE
          GOTO      WCOLKP24 IF EQUAL              * Allied Health
.
          MOVE      "Unkwn",VISTTYPE
          GOTO      WCOLKP30
.
WCOLKP21  MOVE      "EMG",VISTTYPE
          GOTO      WCOLKP30
.
WCOLKP22  MOVE      "OP",VISTTYPE
          GOTO      WCOLKP30
.
WCOLKP23  MOVE      "IP",VISTTYPE
          GOTO      WCOLKP30
.
WCOLKP24  MOVE      "3RF",VISTTYPE
          GOTO      WCOLKP30
.
WCOLKP30  MOVE      SP70,VISTDATE
          MATCH     SP70,PTWCVDAT                  * Format Visit Date
          GOTO      WCOLKP40 IF EQUAL
          UNPACK    PTWCVDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      VISTDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.          
WCOLKP40  MOVE      WCENAME,EMPLNAME
          REP       "'`",EMPLNAME
          MOVE      WCEADD1,EMPLADD1
          REP       "'`",EMPLADD1
          MOVE      WCEADD2,EMPLADD2
          REP       "'`",EMPLADD2
          MOVE      WCEADD3,EMPLADD3
          REP       "'`",EMPLADD3
          MOVE      WCEADD4,EMPLADD4
          REP       "'`",EMPLADD4
.
          IF        PTCNHDPS=1
            CALL      WCOLNZ00
            GOTO      WCOLKP10
          ENDIF
.
          MOVE      PMWXCNAM,JAVSNAME   * String to Convert
          CALL      JAVDES00         * Remove "'" replace with "%60"
          REP       "#" ",JAVSNAME        * format the name for display
.
          WRITE     HTMLFILE;"<tr><td>":
                              "<img src=../images/MaintenanceIcon.gif ":
                              " class=ListIcon onclick='updateParent(#"":
                              EMPLNAME,"#",#"",EMPLADD1,"#",#"":
                              EMPLADD2,"#",#"",EMPLADD3,"#",#"":
                              EMPLADD4,"#",#"",WCEPOST,"#",#"":
                              WCETELE,"#",#"",ACCIDATE,"#",#"":
                              WCACCPT,"#",#"",WCICODE,"#",#"":
                              WCCLMNO,"#",#"",WCCOMN1,"#",#"":
                              WCCOMN2,"#",#"",PMWXALOC,"#",#"":
                              PMWXCINJ,"#",#"",PMWXICOD,"#",#"":
                              JAVSNAME,"#");'> ":
                              EMPLNAME,"</td>":
                              "<td><img src=../images/DocumentIcon.gif ":
                              " class=ListIcon onclick='linkForm(#"":
                              WCICODE,"#",#"":
                              ANSV,"#");'> ":
                              WCCLMNO,"</td>":
                              "<td>&nbsp;",ACCIDATE,"</td>":
                              "<td>&nbsp;",VISTTYPE,"</td>":
                              "<td>&nbsp;",VISTDATE,"</td>":
                              "<td>&nbsp;",DWCADMNO,"</td>":
                              "</tr>"
          GOTO      WCOLKP10  
.
WCOLKP99  RETURN
+
.------------------------------------------------------------
. Check if this claim number is already output 
.------------------------------------------------------------
CHOUT000  MOVE       ZERO,F3
          MOVE       ZERO,EXIT
CHOUT100  ADD        ONE,F3
          IF         F3>UROUTEND
            IF         F3>50
              GOTO       CHOUT999
            ENDIF
            MOVE       F3,UROUTEND
            MOVE       WCCLMNO,UROUTPUT[F3]
            GOTO       CHOUT999
          ENDIF
          MATCH      WCCLMNO,UROUTPUT[F3]
          GOTO       CHOUT100 IF NOT EQUAL
.         GOTO       CHOUT100
          MOVE       ONE,EXIT
CHOUT999  RETURN
.------------------------------------------------------------
. Output WC Table Details 
.------------------------------------------------------------
WCOLNZ00  MOVE      SP70,PDCDATE                   * Format Patient Dec Date
          MATCH     SP70,PMWXPDDT
          IF        !@EQUAL & !@EOS
            UNPACK    PMWXPDDT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      PDCDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          REP       "'`",SAVDATA1
          REP       "'`",SAVDATNZ
          REP       "'`",SAVDATA2
.
          PACK      DOCFNAME,SP70
          MATCH     SP70,PMWXVHCP
          IF        !@EQUAL
            PACK      KEY6,PMWXVHCP,SP6
            CALL      RDDOCT1
            BRANCH    OVRCD,WCOLNZ20
            MOVE      DTITL,FMTTITLE
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000
            REP       "'`",DOCFNAME
          ENDIF
.
WCOLNZ20  MOVE      SP70,DECDATE
          MATCH     SP70,PMWXADTE                  * Format Accident Date
          GOTO      WCOLNZ30 IF EQUAL
          UNPACK    PMWXADTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DECDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
WCOLNZ30  WRITE     HTMLFILE;"<tr><td>":
                              "<img src=../images/MaintenanceIcon.gif ":
                              " class=ListIcon onclick='updateParent(#"":
                              EMPLNAME,"#",#"",EMPLADD1,"#",#"":
                              EMPLADD2,"#",#"",EMPLADD3,"#",#"":
                              EMPLADD4,"#",#"",WCEPOST,"#",#"":
                              WCETELE,"#",#"",ACCIDATE,"#",#"":
                              WCACCPT,"#",#"",WCICODE,"#",#"":
                              WCCLMNO,"#",#"",WCCOMN1,"#",#"":
                              WCCOMN2,"#",#"",PMWXALOC,"#",#"":
                              PMWXCINJ,"#",#"",PMWXICOD,"#",#"":
                              PMWXATME,"#",#"",PMWXACLC,"#",#"":
                              PMWXAINZ,"#",#"",PMWXMOVV,"#",#"":
                              PMWXSPTI,"#",#"",PMWXSPRT,"#",#"":
                              PMWXRECI,"#",#"",PMWXTRIC,"#",#"":
                              PMWXESTA,"#",#"",PDCDATE,"#",#"":
                              PMWXARG1,"#",#"",PMWXARG2,"#",#"":
                              PMWXARSN,"#",#"",PMWXARTL,"#",#"":
                              PMWXARRP,"#",#"",PMWXTWRK,"#",#"":
                              PMWXOEST,"#",#"",PMWXCSTA,"#",#"":
                              PMWXCNAM,"#",#"",PMWXACCF,"#",#"":
                              PMWXPLIN,"#",#"",PMWXACTI,"#",#"":
                              DECDATE,"#",#"",SAVDATA1,"#",#"":
                              SAVDATA2,"#",#"",PMWXTPRO,"#",#"":
                              PMWXGRAD,"#",#"",PMWXAHOS,"#",#"":
                              PMWXVCON,"#",#"",PMWXAPPR,"#",#"":
                              PMWXPORD,"#",#"",PMWXVHCP,"#",#"":
                              DOCFNAME,"#");'> ":
                              WCCLMNO,"</td>":
                              "<td id=textOutput>&nbsp;",SAVDATNZ,"</td>":
                              "<td>&nbsp;",ACCIDATE,"</td>":
                              "</tr>"
WCOLNZ99  RETURN
.------------------------------------------------------------
. Output WC Table Details 
.------------------------------------------------------------
WCOTAB00  MOVE      ZERO,DIM1
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,ANS,DIM127      * Visit Type Flag
          UNPACK    DIM127,D1,KEY1,DIM127     * Admission Status Flag
          UNPACK    DIM127,D1,DIM1,DIM127     * Check number of records
.
          MOVE      ZERO,RECCNT
          MOVE      ZERO,CHECKCNT
          MOVE      DIM1,CHECKCNT
          MATCH     "       0",URNUMBER
          GOTO      WCOTAB99 IF EQUAL
.
          CALL      WCOLST00                  * TAC Details Table
WCOTAB99  RETURN
+
.------------------------------------------------------------
. Output WC Table Details
.------------------------------------------------------------
WCOLST00  PACK      KEY16,URNUMBER,SP70
          CALL      RDSWCOM2
WCOLST10  CALL      RDKWCOM2
          BRANCH    OVRCD,WCOLST99
.
          MATCH     URNUMBER,PTWCURNO         * Match UR numbers
          GOTO      WCOLST99 IF NOT EQUAL
.
          PACK      KEY8,DWCADMNO,SP70
          CALL      RDPMWX11
          IF        OVRCD=1
            CALL      CLPMSWX1
          ENDIF
.
          PACK      KEY8,DWCADMNO,SP70         * Read for corresponding
          CALL      RDVISA1                   * admission file
          IF        OVRCD<>1
            GOTO      WCOLST15
          ENDIF
          PACK      KEY8,DWCADMNO,SP70
          CALL      RDBKREC1
          IF        OVRCD<>1
            PACK      DPVIBILL,DWCADMNO,SP70
            MOVE      DWCADMNO,PVIBILL
            MOVE      THREE,PVITYPE
            PACK      PVIDATE,BKREADAT,SP70
            PACK      PVIURNO,BKREURNO,SP70
            GOTO      WCOLST15
          ENDIF
          PACK      KEY19,URNUMBER,SP70
          CALL      RDSTREA1
WCOLST12  CALL      RDKTREA1
          BRANCH    OVRCD,WCOLST14
.
          MATCH     URNUMBER,WMURNO
          GOTO      WCOLST14 IF NOT EQUAL
.
          MATCH     WMBOOK,WCADMNO
          GOTO      WCOLST12 IF NOT EQUAL
.
          PACK      DPVIBILL,DWCADMNO,SP70
          MOVE      DWCADMNO,PVIBILL
          MOVE      FOUR,PVITYPE
          MOVE      ANSW,PTVITYPE
          PACK      PVIDATE,WMDATE1,SP70
          PACK      PVIURNO,WMURNO,SP70
          GOTO      WCOLST15
.
WCOLST14  CALL      OUTFIL00
          BRANCH    EXIT,WCOLST99
.
          MOVE      DWCADMNO,KEY8
          CALL      RDBOKB1
          IF        OVRCD=0
            PACK      DPVIBILL,DWCADMNO,SP70
            MOVE      DWCADMNO,PVIBILL
            MOVE      TWO,PVITYPE
            PACK      PVIDATE,OBADATE,SP70
            PACK      PVIURNO,PTWCURNO,SP70
            GOTO      WCOLST15
          ENDIF
.
          MOVE      DWCADMNO,KEY8
          CALL      RDOTRFL1
          IF        OVRCD=0
            PACK      DPVIBILL,DWCADMNO,SP70
            MOVE      DWCADMNO,PVIBILL
            MOVE      TWO,PVITYPE
            PACK      PVIDATE,OTRLDATE,SP70
            PACK      PVIURNO,OTRLURNO,SP70
            GOTO      WCOLST15
          ENDIF
.
          GOTO      WCOLST10
.
WCOLST15  BRANCH    PVITYPE,WCOLST21:
                            WCOLST22:
                            WCOLST23
.
          MATCH     ANSW,PTVITYPE
          GOTO      WCOLST25 IF EQUAL
.
.         MOVE      NINE,DIM1
          COMPARE   NINE,PVITYPE
          GOTO      WCOLST24 IF EQUAL
.
          MOVE      "Unkwn",VISTTYPE
          GOTO      WCOLST30
.
WCOLST21  MOVE      "EMG",VISTTYPE
          GOTO      WCOLST30
.
WCOLST22  MOVE      "OP",VISTTYPE
          GOTO      WCOLST30
.
WCOLST23  MOVE      "IP",VISTTYPE
          GOTO      WCOLST30
.
WCOLST24  MOVE      "4RF",VISTTYPE
          GOTO      WCOLST30
.
WCOLST25  MOVE      "WL",VISTTYPE
          GOTO      WCOLST30
.
WCOLST30  MOVE      SP1,SECOPT                * Initialise SECOPT
          MOVE      SP1,PVITYPE               * Initialise PVITYPE
.
          PACK      SAVDATA1,SP70,SP70,SP70,SP70
.         
          PACK      KEY26,WCCLMNO,ZERO,ZERO,ONE,SP1,SP1,ONE,SP70
          CALL      RDACCMT1
          BRANCH    OVRCD,WCOLST40
.
          MATCH     WCCLMNO,ACCMACCN
          GOTO      WCOLST40 IF NOT EQUAL
          STRIP     ACCMDATA
          CLEAR     SAVDATA1
          APPEND    ACCMDATA,SAVDATA1
          CALL      RKACCMT1
          BRANCH    OVRCD,WCOLST40
          MATCH     WCCLMNO,ACCMACCN
          GOTO      WCOLST40 IF NOT EQUAL
          MATCH     "001",ACCMTYPE
          GOTO      WCOLST40 IF NOT EQUAL
          ENDSET    SAVDATA1
          APPEND    SP1,SAVDATA1
          STRIP     ACCMDATA
          ENDSET    SAVDATA1
          APPEND    ACCMDATA,SAVDATA1
.
WCOLST40  COMPARE   ONE,PTCNHDPS            * NZ only?
          GOTO      WCOLST50 IF NOT EQUAL
.
          MATCH     "3",PMWXCSTA            * Cancelled Claim Status?
          GOTO      WCOLST10 IF EQUAL       * Don't output row data
.
WCOLST50  RESET     SAVDATA1
          CLEAR     HTMLLINK
          STRIP     SAVDATA1
          APPEND    "javascript:linkPatient('",HTMLLINK
          APPEND    URNUMBER,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    DPVIBILL,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PVITYPE,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    SECOPT,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          IF        USETNOT1=1
            WRITE     HTMLFILE;"t1.addRow(#"",HTMLLINK,"#",":       * 0
                               "#"",WCENAME,"#",";                  * 1
          ELSE
            WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":        * 0
                               "#"",WCENAME,"#",";                  * 1
          ENDIF
          CLEAR     HTMLLINK
          APPEND    "javascript:linkInsurance('",HTMLLINK
          APPEND    WCICODE,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    ANSV,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"#"",HTMLLINK,"#",":                 * 2
                             "#"",WCCLMNO,"#",":                  * 3
                             "#"",WCACDAT,"#",":                  * 4
                             "#"",VISTTYPE,"#",":                 * 5
                             "#"",PVIDATE,"#",":                  * 6
                             "#"",PVIBILL,"#",":                  * 7
                             "#"",PMWXALOC,"#",":                 * 8
                             "#"",SP1,"#",":                      * 9
                             "#"",SAVDATA1,"#",":                 * 10
                             "#"",PMWXADTE,"#")"                  * 11
.
          IF        CHECKCNT=0
            GOTO      WCOLST10
          ENDIF
.
          ADD       ONE,RECCNT
          COMPARE   FIFTY,RECCNT
          IF        @EQUAL
            MOVE      ONE,FINFLAG
            WRITE     HTMLFILE;"alert('Too Many Visits to View');"
            GOTO      WCOLST99
          ENDIF
.
          GOTO      WCOLST10
.
WCOLST99  RETURN
+
.------------------------------------------------------------
. CLMLKP00  : Claim Number Lookup Details
.------------------------------------------------------------
CLMLKP00  PACK      KEY27,URNUMBER,Z70
          CALL      RSPMEXT3
CLMLKP10  CALL      RPPMEXT3
          BRANCH    OVRCD,CLMLKP99
.
          MATCH     URNUMBER,PMEXURNO
          GOTO      CLMLKP99 IF NOT EQUAL
.
          MOVE      SP70,ACCIDATE
          MATCH     SP70,PMEXADAT                  * Format Accident Date
          IF        !@EQUAL
            UNPACK    PMEXADAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      ACCIDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          REP       "'`",PMEXUCM1              * Replace apostrophe in fields to
          REP       "'`",PMEXUCM2              * prevent Javascript errors!
          REP       "'`",PMEXUCM3
          REP       "'`",PMEXALOC
          REP       "'`",PMEXSAD1
          REP       "'`",PMEXSAD2
          REP       "'`",PMEXSAD3
          REP       "'`",PMEXSAD4
          REP       "'`",PMEXCAD1
          REP       "'`",PMEXCAD2
          REP       "'`",PMEXCAD3
          REP       "'`",PMEXCAD4
          REP       "'`",PMEXSCNM
          REP       "'`",PMEXNAME
          REP       "'`",PMEXADD1
          REP       "'`",PMEXADD2
          REP       "'`",PMEXADD3
          REP       "'`",PMEXCNAM
.
          PACK      KEY5,ANSC,ANSL,PMEXCLAM
          CALL      RDCODE1
          BRANCH    OVRCD,CLMLKP10
.
          MATCH     "079",TEMPLATE
          GOTO      CLMLKP20 IF EQUAL        * Workers Compensation
.
.         Motor vehicle claim details
.
          MATCH     "M",TCINDC1
          GOTO      CLMLKP10 IF NOT EQUAL
.
          WRITE     HTMLFILE;"<tr><td>":
                              "<img src=../images/MaintenanceIcon.gif ":
                              " class=ListIcon onclick='updateParent(#"":
                              PMEXCLMN,"#",#"",PMEXALEL,"#",#"":
                              PMEXTCLM,"#",#"",ACCIDATE,"#",#"":
                              PMEXMTYP,"#",#"",PMEXALOC,"#",#"":
                              PMEXICOD,"#",#"",PMEXSAD1,"#",#"":
                              PMEXSAD2,"#",#"",PMEXSAD3,"#",#"":
                              PMEXSAD4,"#",#"",PMEXSPOS,"#",#"":
                              PMEXSCNM,"#",#"",PMEXSTEL,"#",#"":
                              PMEXUCM1,"#",#"",PMEXUCM2,"#",#"":
                              PMEXUCM3,"#");'> ":
                              PMEXCLMN,"</td><td>&nbsp",ACCIDATE,"</td>":
                              "<td>&nbsp",PMEXVISN,"</td>":
                              "</tr>"
          GOTO      CLMLKP10
.
.         Workers Compensation claim details
.
CLMLKP20  MATCH     "W",TCINDC1
          GOTO      CLMLKP10 IF NOT EQUAL
.
          WRITE     HTMLFILE;"<tr><td>":
                              "<img src=../images/MaintenanceIcon.gif ":
                              " class=ListIcon onclick='updateParent(#"":
                              PMEXCLMN,"#",#"",PMEXALEL,"#",#"":
                              PMEXTCLM,"#",#"",ACCIDATE,"#",#"":
                              PMEXMOVV,"#",#"",PMEXALOC,"#",#"":
                              PMEXICOD,"#",#"",PMEXADD1,"#",#"":
                              PMEXADD2,"#",#"",PMEXADD3,"#",#"":
                              PMEXADD4,"#",#"",PMEXPOST,"#",#"":
                              PMEXSAD1,"#",#"",PMEXSAD2,"#",#"":
                              PMEXSAD3,"#",#"",PMEXSAD4,"#",#"":
                              PMEXSPOS,"#",#"",PMEXSTEL,"#",#"":
                              PMEXSCNM,"#",#"",PMEXECON,"#",#"":
                              PMEXEPHN,"#",#"",PMEXCAD1,"#",#"":
                              PMEXCAD2,"#",#"",PMEXCAD3,"#",#"":
                              PMEXCAD4,"#",#"",PMEXCPCD,"#",#"":
                              PMEXCNAM,"#",#"",PMEXCPHN,"#",#"":
                              PMEXUCM1,"#",#"",PMEXUCM2,"#",#"":
                              PMEXUCM3,"#",#"",PMEXNAME,"#",#"":
                              PMEXSLNM,"#");'> ":
                              PMEXCLMN,"</td><td>&nbsp",ACCIDATE,"</td>":
                              "<td>&nbsp",PMEXVISN,"</td>":
                              "</tr>"
          GOTO      CLMLKP10
.
CLMLKP99  RETURN
+
.------------------------------------------------------------
. Table of Medical Warning Details
.------------------------------------------------------------
TABMWR00  PACK      KEY14,URNUMBER,SP70
          CALL      RSPTMWS1
          CALL      RKPTMWS1
          BRANCH    OVRCD,TABMWR99
          MATCH     PTMWURNO,URNUMBER
          GOTO      TABMWR99 IF NOT EQUAL
.
          WRITE     HTMLFILE;"<tr><td class=HeadingCell>Severity</td>":
                                "<td class=HeadingCell>Date</td>":
                                "<td class=HeadingCell>Description</td></tr>"
          PACK      KEY14,URNUMBER,SP70
          CALL      RSPTMWS1
TABMWR10  CALL      RKPTMWS1
          BRANCH    OVRCD,TABMWR99
          MATCH     PTMWURNO,URNUMBER
          GOTO      TABMWR99 IF NOT EQUAL
.
          MOVE      PTMWCLSS,ANS
          MOVE      "Danger",SEVRDESC
          MATCH     ANSD,ANS
          GOTO      TABMWR20 IF EQUAL
          MOVE      "Warning",SEVRDESC
          MATCH     ANSW,ANS
          GOTO      TABMWR20 IF EQUAL
          MOVE      "Other",SEVRDESC
.
TABMWR20  CALL      SETMWD00
          PACK      KEY14,PTMWURNO,PTMWCLSS,PTMWCNT,SP70
          WRITE     HTMLFILE;"<tr><td><img src=../images/MWSIcon.gif border=0 ":
                              "hspace=4 align=absmiddle ":
                              "onclick='UpdateMWS(#"",KEY14,"#")'>":
                              SEVRDESC,"</td>":
                              "<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>":
                              "<td>",PTMWTEXT,"</td></tr>"
.
          GOTO      TABMWR10
.
TABMWR99  RETURN
.------------------------------------------------------------
. Set Medical Warning Date
.------------------------------------------------------------
SETMWD00  REP       " 0",PTMWDATE 
          UNPACK    PTMWDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          MATCH     "00",CDAY
          IF        @EQUAL
            MOVE      SP70,CDAY
          ENDIF
          MATCH     "00",CMON
          IF        @EQUAL
            MOVE      SP70,MTHNAM3
          ENDIF
          PACK      KEY4,CCENT,CYEAR
          MATCH     "0000",KEY4
          IF        @EQUAL
            MOVE      SP70,CCENT
            MOVE      SP70,CYEAR
          ENDIF
          RETURN
.
.------------------------------------------------------------
. Output Visit Table Details
.------------------------------------------------------------
VISTAB00  MOVE      ZERO,DIM1
          MOVE      ZERO,INFORMGP
          MOVE      ZERO,SHOWFRMT           * Show Format (0)Standard or(1)Kids
          MOVE      ZERO,SHOWPPRV
          MOVE      ZERO,SHOWCARE
          MOVE      ZERO,SHOWDSCH
.
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,ANS,DIM127      * Visit Type Flag 
          UNPACK    DIM127,D1,KEY1,DIM127     * Admission Status Flag
          UNPACK    DIM127,D1,DIM1,DIM127     * Check number of records
          UNPACK    DIM127,D1,SHOWFRMT,DIM127
          UNPACK    DIM127,D1,INFORMGP,DIM127 * Inform GP records only 
          UNPACK    DIM127,D1,SHOWPPRV,DIM127 * Show pre adm prev details
          UNPACK    DIM127,D1,SHOWCARE,DIM127 * Show Care Type
          UNPACK    DIM127,D1,SHOWDSCH,DIM127 * Show discharge admission
.
          MATCH     "1",SHOWALLV
          IF        @EQUAL
            MOVE      ZERO,INFORMGP
          ENDIF
.
          MATCH     "1",NOCANVIS
          IF        @EQUAL
            MOVE      ZERO,INFORMGP
          ENDIF
.
          MOVE      ZERO,VISTFLAG
          MOVE      ANS,VISTFLAG              * visit type
          MOVE      ZERO,DISCFLAG
          MOVE      KEY1,DISCFLAG             * admission status (astat)
          MOVE      ZERO,VISCOUNT
          MOVE      ZERO,RECCNT
          MOVE      ZERO,FINFLAG
          MOVE      ZERO,CHECKCNT
          MOVE      DIM1,CHECKCNT
.
          MATCH     "       0",URNUMBER
          GOTO      VISTAB99 IF EQUAL
.
          CALL      PATLST00                  * Visit Table
.
          COMPARE   ZERO,DISCFLAG
          GOTO      VISTAB99 IF NOT EQUAL
.
          IF        VISTFLAG<>1
            CALL      BOKLST00                  * Inpatient Bookings
            CALL      REQLST00                  * Theatre Requests
          ENDIF
.
          IF        VISTFLAG=3 | VISTFLAG=1
            GOTO      VISTAB99
          ENDIF
          CALL      WATLST00                  * Waiting List Procedures
.
          MATCH     "1",INFORMGP
          IF        @EQUAL
            CALL      ALSITE00
          ELSE
            PACK      KEY10,USERID,SP70        * Re read logged in user to
            CALL      RDWBSE1                  * get op site
            BRANCH    OVRCD,VISTAB99
.
            CALL      OUTFIL00              * Check user id site files are
            BRANCH    EXIT,VISTAB99
.
            CALL      OUTLST00                  * Outpatient Bookings
          ENDIF
.         
VISTAB99  RETURN
.
.------------------------------------------------------------
. Output Mental Health Table Details          * I SRF 22727
.------------------------------------------------------------
MENLST00  PACK      KEY16,URNUMBER,SP70
          CALL      RSMHVIS4
MENLST10  CALL      RKMHVIS4
          BRANCH    OVRCD,MENLST99
.
          MATCH     URNUMBER,MHVIURNO         * Match UR numbers
          GOTO      MENLST99 IF NOT EQUAL
.
          PACK      KEY8,DMHVIADM,SP70        * Read for corresponding 
          CALL      RDMISS1                   * admission file
          BRANCH    OVRCD,MENLST10
.
          MOVE      ADOCTA,KEY6               * Search for doctor's full name
          CALL      RDDOCT1                   * in doctor file
          IF        OVRCD=1
            MOVE      SP70,DOCFNAME           * If not found then output spaces
          ELSE
.           CALL      DOCNAM00                * Format Doctor Name
            MOVE      DTITL,FMTTITLE            * I CAR 13038
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000                  * end I CAR 13038
          ENDIF
.
          MOVE      SP70,DDATE                * Read for corresponding
          MOVE      SP70,DTIME                * discharge file (if existing)
          PACK      KEY8,DMHVIADM,SP70
          CALL      RDDSCH1                   * If no discharge file is found 
.                                             * discharge time and date will 
.                                             * stay spaces
          MOVE      SP70,MHLESTAT
          PACK      KEY21,DMHVIADM,SP70
          CALL      RSMHLEG1                  * Read the first mental health
          CALL      RKMHLEG1                  * legal status for the admission
          MATCH     DMHVIADM,DMHLEADM         * Check if still the same adm    
          IF        !@EQUAL
            MOVE      SP70,MHLESTAT           * If not then move spaces back in
          ENDIF
.
          MOVE      SP70,TDESC                * Initialise LS description
          MOVE      "LS",CATEGORY             * Category is Legal Status
          MOVE      MHLESTAT,CODE             * Pass in legal status code
          CALL      GETCOD00                  * If legal status does not exist
.                                             * then decription stays as spaces
          MOVE      SP1,SECOPT                * Initialise SECOPT
          MOVE      DMHVIADM,PVIBILL
          MOVE      THREE,PVITYPE             * Initialise PVITYPE
          MOVE      " 3",PTVITYPE
          MOVE      ADATE,PVIDATE
. 
          CLEAR     HTMLLINK
          APPEND    "javascript:linkPatient('",HTMLLINK
          APPEND    URNUMBER,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    DMHVIADM,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PVITYPE,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    SECOPT,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",DAADMNO,"#",":
                             "#"",ADATE,ATIME,"#",":
                             "#"",DDATE,DTIME,"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",TDESC,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"";
.
          CALL      VCDM0000                * Visit based CDM
.
          WRITE     HTMLFILE;"#")"
          IF        CHECKCNT=0
            GOTO      MENLST10
          ENDIF
.
          ADD       ONE,RECCNT
          COMPARE   FIFTY,RECCNT
          IF        @EQUAL
            MOVE      ONE,FINFLAG
            WRITE     HTMLFILE;"alert('Too Many Visits to View');"
            GOTO      MENLST99
          ENDIF
.
          GOTO      MENLST10
.
MENLST99  RETURN
+                                           * end I SRF 22727
.------------------------------------------------------------
. Output TAC Table Details 
.------------------------------------------------------------
TACLST00  PACK      KEY16,URNUMBER,SP70
          CALL      RDSWMAB2
TACLST10  CALL      RDKWMAB2
          BRANCH    OVRCD,TACLST99
.
          MATCH     URNUMBER,PTWMURNO         * Match UR numbers
          GOTO      TACLST99 IF NOT EQUAL
.
          MOVE      DMADMNO,KEY8
          CALL      RDVISA1
          IF        OVRCD=1
            CALL      OUTFIL00
            BRANCH    EXIT,TACLST99
.
            PACK      KEY8,DMADMNO,SP70
            CALL      RDBOKB1
            BRANCH    OVRCD,TACLST10
            MOVE      OBAOUTNO,DPVIBILL
            MOVE      TWO,PVITYPE
            MOVE      OBADATE,PVIDATE
            GOTO      TACLST22
          ENDIF
.
          BRANCH    PVITYPE,TACLST21:
                            TACLST22:
                            TACLST23
.
.         MOVE      NINE,DIM1
          COMPARE   NINE,PVITYPE
          GOTO      TACLST24 IF EQUAL
.
          MOVE      "Unkwn",VISTTYPE
          GOTO      TACLST30
.
TACLST21  MOVE      "EMG",VISTTYPE
          GOTO      TACLST30
.
TACLST22  MOVE      "OP",VISTTYPE
          GOTO      TACLST30
.
TACLST23  MOVE      "IP",VISTTYPE
          GOTO      TACLST30
.
TACLST24  MOVE      "5RF",VISTTYPE
          GOTO      TACLST30
.
TACLST30  MOVE      SP1,SECOPT                * Initialise SECOPT
          MOVE      SP1,PVITYPE               * Initialise PVITYPE
.
          CLEAR     HTMLLINK
          APPEND    "javascript:linkPatient('",HTMLLINK
          APPEND    URNUMBER,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    DPVIBILL,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PVITYPE,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    SECOPT,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",MREFNO,"#",":
                             "#"",MACDAT,"#",":
                             "#"",MACLOC,"#",":
                             "#"",VISTTYPE,"#",":
                             "#"",PVIDATE,"#",":
                             "#"",DMADMNO,"#",":
                             "#"",SP1,"#")"
          IF        CHECKCNT=0
            GOTO      TACLST10
          ENDIF
.
          ADD       ONE,RECCNT
          COMPARE   FIFTY,RECCNT
          IF        @EQUAL
            MOVE      ONE,FINFLAG
            WRITE     HTMLFILE;"alert('Too Many Visits to View');"
            GOTO      TACLST99
          ENDIF
.
          GOTO      TACLST10
.
TACLST99  RETURN
+
.------------------------------------------------------------
. Output Visit Table Details
.------------------------------------------------------------
PATLST00  PACK      KEY24,URNUMBER,Z70
          CALL      RDSVISA2
PATLST10  CALL      RDPVISA2
          BRANCH    OVRCD,PATLST99
.
          MATCH     URNUMBER,PVIURNO
          GOTO      PATLST99 IF NOT EQUAL
.
          MOVE      SP70,DOCINDIC
.
          PACK      KEY8,PVIBILL,SP70
          CALL      RDPMVX11
          IF        OVRCD=1
            IF        ARCFLAG=1
              MOVE      PVIBILL,KEY8
              CALL      RDARVX11
              IF        OVRCD<>1
                CALL      MVPMAR00
              ENDIF
            ENDIF
          ENDIF
          BRANCH    OVRCD,PATLST10
.
          MOVE      PVIBILL,KEY8
          CALL      RDMISS1
          IF        OVRCD=1
            CALL      CLPATMIS
          ENDIF
.
          CALL      RDDSCH1
          IF        OVRCD=1
            CALL      CLPATDSC
          ENDIF
.
          MATCH     "1",NOCANVIS
          IF        @EQUAL
            COMPARE   FIVE,ASTAT
            GOTO      PATLST10 IF EQUAL
          ELSE
            MATCH     "2",NOCANVIS
            IF        @EQUAL
              COMPARE   FIVE,ASTAT
              GOTO      PATLST10 IF EQUAL
            ENDIF
          ENDIF
.
          MOVE      PMVXMHOS,VISTHOSP
.
          MATCH     "1",INFORMGP
          IF        @EQUAL
            MATCH     "1",PMVXINGP
            IF        !@EQUAL
              GOTO      PATLST10
            ENDIF
          ENDIF
.
          MOVE      SP70,NOACCDSC
          MATCH     "1",SHOWDSCH
          IF        @EQUAL
            IF        IBCNMHOS=1
              CALL      CHKACC00
            ENDIF
            GOTO      PATLST14
          ENDIF
.
          IF        IBCNMHOS=1
            MATCH    "1",SHOWPPRV
            IF       @EQUAL
              IF       SHOWALLH=1
                PACK      KEY13,USERID,SP70              * All hospital access
                CALL      RDMLSEC1
                IF        OVRCD=1
                  PACK      KEY13,USERID,PMVXMHOS,SP70   * This hospital access
                  CALL      RDMLSEC1
                  BRANCH    OVRCD,PATLST10
                ENDIF
              ELSE
                PACK     KEY10,USERID,SP70        * Re read logged in user to
                CALL     RDWBSE1                  * get hospital
                BRANCH   OVRCD,PATLST10
.
                MATCH    WBSEHOSP,PMVXMHOS        * Only show visits for logged
                GOTO     PATLST10 IF NOT EQUAL    * in hospital if pre adm from
              ENDIF
            ENDIF                               * prev details screen
          ENDIF
.
PATLST14  ADD       ONE,VISCOUNT
          MOVE      SP70,DESCSNAG
.
          IF        VISTFLAG<>0
            COMPARE   VISTFLAG,PVITYPE      * Match For Visit Type
            GOTO      PATLST10 IF NOT EQUAL
          ENDIF
.
          MOVE      ONE,EPSCD001         * Episode number?
          MOVE      SP70,SAVEPKEY        * Clear save episode key
          MOVE      ZERO,GENCHCDS        * flag to generate a phantom patchcof
          MOVE      ZERO,GENITNOW        * don't generate a patchcof yet
          IF        ASTAT = 3 & MRCNEPSC = 1
            MOVE      ONE,GENCHCDS       * set "Generate Discharge patchcof"
          ENDIF
          MOVE      " 0",KEY2
          PACK      CHCDATA,PVIBILL,ADATE,ATIME,KEY2,ACARE,SP30 
.
          PACK      DISPCLSS,SP70
          MATCH     SP70,ACARE
          IF        !@EQUAL
            PACK      DIM1,SP20
            PACK      DISPCLSS,SP20
            PACK      KEY5,ANSC,ANSC,ACARE,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              UNPACK      TCINDC21,DIM1
            ENDIF
            MATCH     DIM1,SP70
            IF        !@EQUAL
              PACK      DISPCLSS,ONCLCLSS,DIM1,SP70
            ENDIF
            SQUEEZE   DISPCLSS
          ENDIF
.
PATLST15  CALL      MRTCOD00             * Medical Record Coding Details
          BRANCH    EXIT,PATLST10
.
          COMPARE   ZERO,CODESTAT        * Do not display Coder id if not coded
          IF        @EQUAL
            MOVE      SP70,CODERNAM
          ELSE
            MOVE      SP70,CODERNAM
            PACK      KEY10,PTEDUSID,SP70
            CALL      RDWBSE1
            IF        OVRCD=0
              MOVE      WBSENAM,CODERNAM
            ELSE
              PACK      KEY14,PTEDOPER,SP70
              CALL      RSWBSE3
              CALL      RKWBSE3
              IF        OVRCD=0
                MATCH     PTEDOPER,WBSEPCD
                IF        @EQUAL
                  MOVE      WBSENAM,CODERNAM
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          CALL      GETVIS00             * Get Visit Details
          BRANCH    EXIT,PATLST10
.
          PACK      KEY8,PVIBILL         * Outpatient event details
          CALL      RDPMEVT1
          BRANCH    OVRCD,PATLST30
.
          MOVE      "EV",CATEGORY
          MOVE      PMEVEVNT,CODE
          CALL      GETCOD00
.
          MATCH     "E",TCINDC1          * emergency events
          GOTO      PATLST18 IF EQUAL
.
          MATCH     "I",TCINDC1          * inpatient event
          IF        @EQUAL
            PACK      KEY6,PMEVPWRD,PMEVPBED
            CALL      FWBD0000
            PACK      VISTLOC,WARDBED,SP70
            IF        IBCNMHOS=1
              PACK      KEY3,PMVXMHOS
              CALL      FHOS0000
              PACK      VISTLOC,HOSPTEXT,DASH,WARDBED,SP70
            ENDIF
            MOVE      PMEVCCOD,CLAIMCOD
            CALL      GETSTA00
            GOTO      PATLST30
          ENDIF
.
          MATCH     "O",TCINDC1
          IF        !@EQUAL
            CALL      GETSTA00
            GOTO      PATLST30
          ENDIF
.
          CALL      GETSTA00
          MOVE      ZERO,FORM1
          MOVE      PMEVASTT,FORM1
          LOAD      VSTATUS,FORM1,OEVSTA1,OEVSTA2
          IF        FORM1=0
            MOVE      OEVSTA0,VSTATUS 
          ENDIF 
.
PATLST18  MOVE      PMEVATIM,VISTTIME
          MOVE      PMEVCCOD,CLAIMCOD
          MOVE      PMEVCTYP,UNITCODE
.
PATLST20  MATCH     SP70,PMEVCTYP
          GOTO      PATLST30 IF EQUAL
.
          PACK      KEY12,PMEVSITE,PMEVCTYP,SP70
          CALL      RDCTYA1
          BRANCH    OVRCD,PATLST30
.
          MOVE      OCTDESC,UNITDESC
          MOVE      PMEVCTYP,UNITCODE
.
PATLST30  CALL      CKAL0000             * Check Allied Health
          BRANCH    EXIT,PATLST10        * don't display
.
          MOVE      SP70,MRVSXKY1
          CALL      MRTDES00             * Medical Record Location Details
.
          CLEAR     HTMLLINK
          APPEND    "javascript:linkPatient('",HTMLLINK
          APPEND    URNUMBER,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PVIBILL,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PVITYPE,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    SECOPT,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PVISITE,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    AAEVFLAG,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    EVNTFLAG,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    EPSCD001,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    EMVISITE,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    NOACCDSC,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          CLEAR     UPDPLINK
          APPEND    "javascript:updParentLink('",UPDPLINK
          APPEND    URNUMBER,UPDPLINK
          APPEND    "','",UPDPLINK
          APPEND    PVIBILL,UPDPLINK
          APPEND    "','",UPDPLINK
          APPEND    ACLSS,UPDPLINK
          APPEND    "','",UPDPLINK
          APPEND    PTMIPDRG,UPDPLINK
          APPEND    "','",UPDPLINK
          APPEND    PTMICMXP,UPDPLINK
          APPEND    "','",UPDPLINK
          APPEND    PMVXIDUS,UPDPLINK
          APPEND    "','",UPDPLINK
          APPEND    PMVXUDIN,UPDPLINK
          APPEND    "','",UPDPLINK
          APPEND    PMVXPACC,UPDPLINK
          APPEND    "','",UPDPLINK
          APPEND    PMVXCADM,UPDPLINK
          APPEND    "','",UPDPLINK
          APPEND    PMVXRHC1,UPDPLINK
          APPEND    "','",UPDPLINK
          APPEND    PMVXINGP,UPDPLINK
          APPEND    "','",UPDPLINK
          APPEND    PTMIPCMX,UPDPLINK
          APPEND    "')",UPDPLINK
          RESET     UPDPLINK
.
          REP       " 0",PVIDATE
.
          MOVE      SP70,KEY15
          COMPARE     FOUR,EMVISTAT
          IF        @EQUAL
            MOVE      "LineThrough",KEY15
          ENDIF
.
          IF        MRCNEPSC=1
            MOVE      CHCODCMP,ACODDTE
          ENDIF
.
          MOVE      PVIBILL,VISITNO
          RJUSTIFY  VISITNO
.
          CLEAR     EXTVSTID
          CLEAR     CHKEXTVD
          PACK      CHKEXTVD,VISITNO,SP70
          PROC      CHKEID00
          MATCH     KEY20,SP70
          IF        @EQUAL
            PACK      EXTVSTID,VISITNO
          ELSE  
            APPEND    VISITNO,EXTVSTID
            APPEND    SP2,EXTVSTID
            APPEND    "<span class='TextBlue'>(",EXTVSTID
            APPEND    KEY20,EXTVSTID
            APPEND    ")</span>",EXTVSTID
          ENDIF
.
          REP       "#"'",PDIADESC
          WRITE     HTMLFILE;*+,"t.addRow(#"",HTMLLINK,"#",":
                             "#"",EXTVSTID,"#",":
                             "#"",PVIDATE,VISTTIME,"#",":
                             "#"",DDATE,"#",":                       * 3
                             "#"",VISTDESC,"#",":
                             "#"",WARDNAME,"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",ATYPDESC,"#",":
                             "#"",CTYPDESC,"#",":
                             "#"",CODESTAT,"#",":
                             "#"",DTYPDESC,"#",":                    * 10
                             "#"",DESCDOCM,"#",":
                             "#"",DESCHOME,"#"," 
         MATCH      SP70,MRVSXKY1
         IF         !@EQUAL
           WRITE      HTMLFILE;"#"",VOLNDESC," +#"," 
         ELSE
           WRITE      HTMLFILE;"#"",VOLNDESC,"#"," 
         ENDIF
         WRITE      HTMLFILE;"#"",UNITDESC,"#",":
                             "#"",VISTDAY,"#",";                     * 15
.
          CALL      THBL0000      * Assign VISTLINK icon for Inpatient Visit with Bookings
.
          IF        PTCNHDPS=1
            MATCH     "RF",VISTTYPE
            IF        @EQUAL
              MATCH "0",ALDESECU
              IF        @EQUAL
                REP       " +",URNUMBER
                MOVE      PVIBILL,DIM8
                REP       " +",DIM8
                MOVE      SECOPT,DIM1
                REP       " +",DIM1
                WRITE     HTMLFILE;"#"",VISTTYPE,"&nbsp;<a href=#javascript:OpenAllRef('":
                                   "allweb03.pbl?reportno=01&template=014&urnumber=":
                                   URNUMBER,"&admissno=",DIM8,"','",DIM1,"');>":
                                   "<img src='../images/EditIcon.gif'></a>#"",",";
                REP       "+ ",URNUMBER
                REP       "+ ",DIM8
              ELSE
                WRITE     HTMLFILE;"#"",VISTLINK,"#",";
              ENDIF
            ELSE
              WRITE     HTMLFILE;"#"",VISTLINK,"#",";
            ENDIF
          ELSE
            WRITE     HTMLFILE;"#"",VISTLINK,"#",";
          ENDIF
.
          WRITE     HTMLFILE;"#"",VISADIAG,"#",":
                             "#"",VISTLOC,"#",":
                             "#"",VSTATUS,"#",":
                             "#"",SLOTNUMB,"#",":                    * 20
                             "#"",ADIADESC," #",":
                             "#"",VISTRCOD,"#",":
                             "#"",DDIADESC,"#",":
                             "#"",DESCSNAG,"#",":
                             "#"",ACODDTE,"#",":                     * 25
                             "#"",VOLNDESC,"#",":
                             "#"",CODERNAM,"#",":
                             "#"",UNITCODE,"#",":
                             "#"",CLAIMCOD,"#",":
                             "#"",PRIDISCD,"#",":                    * 30
                             "#"",PDIADESC,"#",":           * I CAR 18122
                             "#"",AUDITDTE,"#",":         * 33 coding audit date
                             "#"",KEY15,"#",#"";
.
          CALL      VCDM0000                * Visit based CDM
.
          WRITE     HTMLFILE;"#",": 
                             "#"",VISTHOSP,"#",":
                             "#"",DDATE,DTIME,"#",":
                             "#"",EPSADATT,"#",":
                             "#"",EPISADAT,EPISATIM,"#",":
                             "#"",EPSDDATT,"#",":
                             "#"",EPISDDAT,EPISDTIM,"#",":
                             "#"",PVIBILL," /",EPSCD001,"#",":
                             "#"",DISPCART,"#",":
                             "#"",EDDISDIA,"#",":
                             "#"",EDDISDOC,"#",";
.
          IF        PMVXPWGT=0
            WRITE     HTMLFILE;"#"",SP1,"#",";                       * 45
          ELSE
            MOVE      PMVXPWGT,F6P2
            DIV       "100",F6P2
            IF        F6P2>150
              WRITE     HTMLFILE;"#"",STTRED,F6P2,ENDRED,"#",";      * 45
            ELSE
              WRITE     HTMLFILE;"#"",F6P2,"#",";                    * 45
            ENDIF
          ENDIF
.
          IF        PMVXPHGT=0
            WRITE     HTMLFILE;"#"",SP1,"#",";                       * 46
          ELSE
            WRITE     HTMLFILE;"#"",PMVXPHGT,"#","                   * 46
          ENDIF
.
          MOVE      ZERO,F6P2
          SQUEEZE   PMVXPBMI
          MOVE      PMVXPBMI,F6P2
          IF        F6P2>35
            WRITE     HTMLFILE;"#"",STTRED,PMVXPBMI,ENDRED,"#","    * 47
          ELSE
            WRITE     HTMLFILE;"#"",PMVXPBMI,"#","                  * 47
          ENDIF
.
          WRITE     HTMLFILE;"#"",DISPCLSS,"#","                    * 48 
.
          PACK      DISCHSUM,SP70,SP70
.
          UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          REP       " 0",CPCDATE
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          
          PACK      DISCHSUM,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDSET    DISCHSUM
          APPEND    " at ",DISCHSUM
          APPEND    DTIME,DISCHSUM
.
          MATCH     "1",SHOWCARE
          GOTO      PATLST31 IF NOT EQUAL
.
          IF        PTCNDRSM=1
            PACK      KEY5,ANSD,SP1,DSTAT,SP70
            MOVE      DSTAT,KEY3
          ELSE
            PACK      KEY5,ANSD,ANSD,DDEST,SP70
            MOVE      DDEST,KEY3
          ENDIF
          CALL      RDCODE1
          IF        OVRCD=0
            APPEND    "<BR>",DISCHSUM
            APPEND    INPSTA3A,DISCHSUM
            APPEND    KEY3,DISCHSUM
            APPEND    " - ",DISCHSUM
            APPEND    TDESC,DISCHSUM
          ENDIF
.
          PACK      KEY5,ANSC,ANSC,ACARE,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            APPEND    "<BR>Care Type - ",DISCHSUM
            APPEND    TDESC,DISCHSUM
          ENDIF
.
PATLST31  RESET     DISCHSUM
.
          WRITE     HTMLFILE;"#"",DISCHSUM,"#","                    * 49
.
          PACK      KEY8,PVIBILL,SP70
          CALL      RDEMDCM1
          IF        OVRCD=0
            WRITE     HTMLFILE;"#"";
            MATCH     SP70,EMDCTXT1
            IF        !@EQUAL
              WRITE     HTMLFILE;EMDCTXT1,"<br>";
            ENDIF
            MATCH     SP70,EMDCTXT2
            IF        !@EQUAL
              WRITE     HTMLFILE;EMDCTXT2,"<br>";
            ENDIF
            MATCH     SP70,EMDCTXT3
            IF        !@EQUAL
              WRITE     HTMLFILE;EMDCTXT3,"<br>";
            ENDIF
            MATCH     SP70,EMDCTXT4
            IF        !@EQUAL
              WRITE     HTMLFILE;EMDCTXT4,"<br>";
            ENDIF
            MATCH     SP70,EMDCTXT5
            IF        !@EQUAL
              WRITE     HTMLFILE;EMDCTXT5,"<br>";
            ENDIF
            MATCH     SP70,EMDCTXT6
            IF        !@EQUAL
              WRITE     HTMLFILE;EMDCTXT6,"<br>";
            ENDIF
            WRITE     HTMLFILE;"#",";
          ELSE
            WRITE     HTMLFILE;"#"#",";
          ENDIF
.
          IF        PTCNHDPS=1
            PACK      KEY14,EMVIADMN,ZERO,ZERO,FIVE,SP70
            CALL      RSEMVCD1
PATLST40    CALL      RKEMVCD1
            BRANCH    OVRCD,PATLST41
.
            MATCH     DEMVIADM,EMVCVIST
            GOTO      PATLST41 IF NOT EQUAL
.
            MATCH     "005",EMVCTYPE          * Emergency diagnosis ?
            GOTO      PATLST41 IF NOT EQUAL
.
            MATCH     "000",EMVCSEQU          * Primary diagnosis
            GOTO      PATLST40 IF NOT EQUAL
.
            MOVE      EMVCMNCD,KEY9
            CALL      RDEMICD1
            BRANCH    OVRCD,PATLST40
.
            WRITE     HTMLFILE;"#"",EMICDESC,"#",";
          ELSE
PATLST41    WRITE     HTMLFILE;"#"#",";
          ENDIF
.
          WRITE     HTMLFILE;"#"",UPDPLINK,"#",";     * 52
.
. Emergency First Seen Date and Time for NZ only
          IF        PTCNHDPS=1
            WRITE     HTMLFILE;"#"",EMRVFDAT,EMRVFTIM,"#","
          ELSE
            WRITE     HTMLFILE;"#"#","
          ENDIF
.
          CALL      WARCOL00
          WRITE     HTMLFILE;"#"",TXTCOLOR,"#");";
. 
          IF        CHECKCNT=0
            IF        MRCNEPSC=1 & DISCFLAG=3
              GOTO      PATLST15           * Get next episode for this visit
            ENDIF
            GOTO      PATLST10
          ENDIF
.
          ADD       ONE,RECCNT
          IF        CHECKCNT=2
            COMPARE   TEN,RECCNT                 * TSK 0310498
            GOTO      PATLST99 IF EQUAL
          ENDIF
          COMPARE   FIFTY,RECCNT
          IF        @EQUAL
            MOVE      ONE,FINFLAG
            WRITE     HTMLFILE;"alert('Too Many Visits to View');"
            GOTO      PATLST99
          ENDIF
.
          IF        MRCNEPSC=1 & DISCFLAG=3
            GOTO      PATLST15              * Get next episode for this visit
          ENDIF
          GOTO      PATLST10
.
PATLST99  RETURN
.
.-----------------------------------------------------------------------
. Centralised coding user access checking. If Centralised coding flag is 
. off, the log on user hospital must match the vsisit hospital. If
. it is on, the user must have access to the visit hospital     
.-----------------------------------------------------------------------
CHKACC00  MATCH     "1",MRCNCCOD               * Using centralise coding
          GOTO      CHKACC50 IF EQUAL
.
          PACK      KEY10,USERID,SP70       
          CALL      RDWBSE1                 
          BRANCH    OVRCD,CHKACC90
.
          MATCH     WBSEHOSP,PMVXMHOS          * visit hospital same as
          GOTO      CHKACC90 IF NOT EQUAL      * user log on hospital
          GOTO      CHKACC99
.
CHKACC50  PACK      KEY13,USERID,SP70              * All hospital access
          CALL      RDMLSEC1
          IF        OVRCD=1
            PACK      KEY13,USERID,PMVXMHOS,SP70   * This hospital access
            CALL      RDMLSEC1
            BRANCH    OVRCD,CHKACC90
          ENDIF
          GOTO      CHKACC99
.
CHKACC90  MOVE      "Invalid Hospital Security for Coding",NOACCDSC
          GOTO      CHKACC99
.
CHKACC99  RETURN
.
.------------------------------------------------------------
. Get warning background color for Coding
.------------------------------------------------------------
WARCOL00  MOVE      SP70,TXTCOLOR
          PACK      KEY5,ANSP,SP1,ACLSS
          CALL      RDCODE1
          BRANCH    OVRCD,WARCOL99
.
          MATCH     ANSR,TCINDC7
          GOTO      WARCOL99 IF NOT EQUAL        * No warning is needed
.
          MOVE      "LeaveCell",TXTCOLOR         * set warning color 
.
WARCOL99  RETURN
+
.------------------------------------------------------------
. Get status for patient event record
.------------------------------------------------------------
GETSTA00  MATCH     SP70,PMEVDDTE
          GOTO      GETSTA99 IF EQUAL
.
          MOVE      PMEVDDTE,DDATE
          UNPACK    PMEVDDTE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          REP       " 0",CPCDATE
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISCDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MATCH     SP70,DISCDATE
          GOTO      GETSTA99 IF EQUAL
.
          PACK      VSTATUS,SP70
          CLEAR     VSTATUS
          APPEND    INPSTA3A,VSTATUS
.
          MATCH     SP70,PMEVDSTT
          IF        !@EQUAL
            PACK      KEY5,ANSD,ANSD,PMEVDSTT,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MOVE      TDESC,KEY10
              APPEND    KEY10,VSTATUS
            ENDIF
          ENDIF
.
          APPEND    SP1,VSTATUS
          APPEND    CPCDATE,VSTATUS
          APPEND    SP1,VSTATUS
          APPEND    PMEVDTIM,VSTATUS
          APPEND    SP70,VSTATUS
          RESET     VSTATUS
.
GETSTA99  RETURN
+
.------------------------------------------------------------
. Get Medical Record Coding Details
.------------------------------------------------------------
MRTCOD00  MOVE      ZERO,CODESTAT
.
          MATCH     "00000000",PVIDATE    * Bad Debt? If so Ignore!
          GOTO      MRTCOD90 IF EQUAL
.
          COMPARE   ZERO,DISCFLAG
          GOTO      MRTCOD20 IF EQUAL     * Doing all visits 
.
          MOVE      PVIBILL,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,MRTCOD90
.
          MOVE      "CC",CATEGORY
          MOVE      ACARE,CODE
          CALL      GETCOD00
          MOVE      TDESC,DISPCART
.
          COMPARE   ONE,MRCNEPSC          * Using Episode Coding
          GOTO      MRTCOD10 IF NOT EQUAL
.
          COMPARE   THREE,DISCFLAG
          GOTO      MRTCOD10 IF NOT EQUAL   * not doing discharges
.
          COMPARE   TWO,ASTAT
          IF        !@EQUAL
            COMPARE   THREE,ASTAT           * Discharges and current adm with
            GOTO      MRTCOD90 IF NOT EQUAL * at least one episode
          ENDIF
.
MRTCOD05  CALL      GEPS0000                * Get episode dates
          BRANCH    EXIT,MRTCOD90
          GOTO      MRTCOD11
.
MRTCOD10  COMPARE   DISCFLAG,ASTAT          * Match For Admission Status
          GOTO      MRTCOD90 IF NOT EQUAL
.
          COMPARE   THREE,DISCFLAG
          GOTO      MRTCOD20 IF NOT EQUAL   * not doing discharges
.
MRTCOD11  MOVE      PVIBILL,KEY8
          CALL      RDPMVX11
          IF        OVRCD=1
            IF        ARCFLAG=1
              MOVE      PVIBILL,KEY8
              CALL      RDARVX11
              IF        OVRCD<>1
                CALL      MVPMAR00
              ENDIF
            ENDIF
          ENDIF
          BRANCH    OVRCD,MRTCOD90
.
          MATCH     SP3,PMSVX044
          IF        !@EQUAL
            MATCH     PMSVX044,PMVXCSNG   * Match for coder snags
            GOTO      MRTCOD90 IF NOT EQUAL
          ENDIF
.
          MOVE      "VN",CATEGORY
          MOVE      PMVXCSNG,CODE
          CALL      GETCOD00
          MOVE      TDESC,DESCSNAG
.
          PACK      KEY13,PVIBILL,EPSCD001                            *C-240107
          CALL      RSPTECD1
          CALL      RKPTECD1
          IF        OVRCD=0
            MATCH     PVIBILL,PTEDADMN
            IF        !@EQUAL
              MOVE      SP70,PTEDOPER   * No coder id
              MOVE      SP70,PTEDUSID   * No coder web user id
            ENDIF
          ENDIF
.
.       Codedflg = 0 for All, 1 for incomplete coding, 2 for complete coding
.
MRTCOD15  IF        CODEDFLG=1
            IF        MRCNEPSC=1
              MATCH     SP8,CHCODCMP
              GOTO      MRTCOD05 IF NOT EQUAL   * Coding completed
            ELSE
              MATCH     SP8,ACODDTE
              GOTO      MRTCOD90 IF NOT EQUAL   * Coding completed
            ENDIF
          ENDIF
.
          IF        CODEDFLG=2
            IF        MRCNEPSC=1
              MATCH     SP8,CHCODCMP
              GOTO      MRTCOD05 IF EQUAL     * Coding not completed
            ELSE
              MATCH     SP8,ACODDTE
              GOTO      MRTCOD90 IF EQUAL     * Coding not completed
            ENDIF
          ENDIF
.
MRTCOD20  MOVE      ZERO,CODESTAT
          IF        MRCNEPSC=1
            MATCH     SP8,CHCODCMP
            IF        !@EQUAL
              MOVE      ONE,CODESTAT       * coded
            ENDIF
          ELSE
            MATCH     SP8,ACODDTE
            IF        !@EQUAL
              MOVE      ONE,CODESTAT       * coded
            ENDIF
          ENDIF
.
          MOVE      SP70,PRIDISCD        * I CAR 18122
          PACK      PDIADESC,SP70,SP70,SP70
          PACK      KEY13,PVIBILL,EPSCD001,SP70                       *C-240107
          CALL      RSPTECD1
MRTCOD30  CALL      RKPTECD1
          BRANCH    OVRCD,MRTCOD40                         * TSK 0837871
          MATCH     PTEDADMN,PVIBILL
          GOTO      MRTCOD40 IF NOT EQUAL
.
          COMPARE   PTEDEPNO,EPSCD001
          GOTO      MRTCOD40 IF NOT EQUAL
.
          MATCH     PTEDTYPE,CMDISP
          GOTO      MRTCOD30 IF NOT EQUAL
.
          MATCH     "  1",DPTEDCNT                                    *C-240107
          GOTO      MRTCOD30 IF NOT EQUAL
.
          MOVE      PTEDCODE,PRIDISCD
.
          MOVE      PTEDDESC,PDIADESC    * end I CAR 18122
.
MRTCOD40  IF        PVITYPE<>2
            MOVE      SP70,VISADIAG
            MOVE      SP70,ADIADESC
          ENDIF
.
          PACK      KEY13,PVIBILL,EPSCD001,SP70                       *C-240107
          CALL      RSPTECD1
          CALL      RKPTECD1
          BRANCH    OVRCD,MRTCOD45
          MATCH     PTEDADMN,PVIBILL
          GOTO      MRTCOD45 IF NOT EQUAL
.
          COMPARE   PTEDEPNO,EPSCD001
          GOTO      MRTCOD45 IF NOT EQUAL
.
          MOVE      PTEDCODE,VISADIAG
          MOVE      PTEDDESC,ADIADESC          * disease description
          GOTO      MRTCOD50
.
MRTCOD45  MOVE      SP70,PTEDOPER   * No coder id
          MOVE      SP70,PTEDUSID   * No coder web user id
.
MRTCOD50  MOVE      SP70,AUDITDTE
          PACK      KEY18,PVIBILL,Z70
          CALL      RSMRAUC2             * get last coding Audit Date
          CALL      RPMRAUC2
          BRANCH    OVRCD,MRTCOD80
.
          MOVE      PVIBILL,KEY8
          MATCH     KEY8,MRACVISN
          GOTO      MRTCOD80 IF NOT EQUAL
.
.         MOVE      EPSCD001,KEY2
.         MATCH     KEY2,MRACEPSN
.         GOTO      MRTCOD80 IF NOT EQUAL
.
          MOVE      MRACADTE,AUDITDTE
.
MRTCOD80  MOVE      ZERO,EXIT
          GOTO      MRTCOD99
.
MRTCOD90  MOVE      ONE,EXIT
.
MRTCOD99  RETURN
.
.------------------------------------------------------------
. Get the episode start and end date/times append * if
. not same as admission/discharge date/time
.------------------------------------------------------------
GEPS0000  MATCH     SP70,SAVEPKEY
          IF        @EQUAL
            PACK      SAVEPKEY,PVIBILL,SP70   
            MOVE      ADATE,EPISADAT
            MOVE      ATIME,EPISATIM
          ELSE
            UNPACK    SAVEPKEY,KEY8,EPISADAT,EPISATIM
          ENDIF 
.
. Find this episose end date/time
.
          PACK      KEY24,SAVEPKEY,SP70
          CALL      RDCHCO1
          CALL      RDKCHCO1
          IF        OVRCD = 1 & GENCHCDS = 1
            MOVE      ONE,GENITNOW
            GOTO      GEPS1000
          ENDIF
          BRANCH    OVRCD,GEPS9000               * Check for care type changes
.                                                * to get episode number
          UNPACK    SAVEPKEY,KEY8
          MATCH     DCHADMN,KEY8                 * Correct admission number ?
          IF        !@EQUAL
            MOVE      ONE,GENITNOW
            BRANCH    GENCHCDS,GEPS1000
            GOTO      GEPS9000
          ENDIF
.
GEPS1000  IF        GENCHCDS = 1
            IF        GENITNOW <> 1
              PACK      CHCDATA,CHADMN,CHDATE,CHTIME,CHEPISNO,CHCODE,SP30
            ELSE
.                                           * build a dummy patchcof record
              UNPACK    CHCDATA,KEY8A,EPISADAT,EPISATIM,KEY2,KEY3
              MOVE      KEY8A,CHADMN
              MOVE      KEY8A,DCHADMN
              MOVE      DDATE,CHDATE
              MOVE      DTIME,CHTIME
              UNPACK    SP70,CHCRDATE,CHCRTIME,CHCRUSID
              UNPACK    SP70,CHUPDATE,CHUPTIME,CHUPUSID
              MOVE      "CC",CHCATG
              MOVE      ACARE,CHCODE
              MOVE      KEY2,F2
              ADD       ONE,F2
              MOVE      F2,CHEPISNO
.....         MOVE      ACODDTE,CHCODCMP
              MOVE      SP8,CHCODCMP       
.                                           * get an Oper Date if code/s exists
              PACK      KEY13,DCHADMN,CHEPISNO,SP20
              CALL      RSPTECD1
GEPS1100      CALL      RKPTECD1
              BRANCH    OVRCD,GEPS1200
.
              MATCH     DCHADMN,DPTEDADM
              GOTO      GEPS1200 IF NOT EQUAL
.
              COMPARE   F2,PTEDEPNO
              GOTO      GEPS1100 IF NOT EQUAL
.
              MATCH     PTEDDTCD,CHCODCMP
              IF        @LESS
                MOVE      PTEDDTCD,CHCODCMP
              ENDIF
              GOTO      GEPS1100
.
GEPS1200      PACK      KEY13,DCHADMN,CHEPISNO,SP20
              CALL      RSPTECO1
GEPS1300      CALL      RKPTECO1
              BRANCH    OVRCD,GEPS1500
.
              MATCH     DCHADMN,DPTEOADM
              GOTO      GEPS1500 IF NOT EQUAL
.
              COMPARE   F2,PTEOEPNO
              GOTO      GEPS1300 IF NOT EQUAL
.
              MATCH     PTEODTCD,CHCODCMP
              IF        @LESS
                MOVE      PTEODTCD,CHCODCMP
              ENDIF
              GOTO      GEPS1300

GEPS1500      MOVE      ZERO,GENCHCDS
              MOVE      ZERO,GENITNOW
            ENDIF
          ENDIF
.
GEPS2000  MOVE      CHEPISNO,EPSCD001                  * Save current episode
          PACK      SAVEPKEY,CHADMN,CHDATE,CHTIME,SP70 * number and key
.
          MOVE      CHDATE,EPISDDAT              * Episode discharge date
          MOVE      CHTIME,EPISDTIM              * Episde discharge time
.
          MOVE      "CC",CATEGORY
          MOVE      CHCODE,CODE                  * Get care type description
          CALL      GETCOD00
          MOVE      TDESC,DISPCART
.
GEPS4000  MOVE      SP70,EPSADATT                * Episode start date & time 
          UNPACK    EPISADAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      EPSADATT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          ENDSET    EPSADATT
          APPEND    " at ",EPSADATT
          APPEND    EPISATIM,EPSADATT
.
          MATCH     ADATE,EPISADAT 
          IF        @EQUAL
            MATCH    ATIME,EPISATIM
            IF       @EQUAL              
              RESET    EPSADATT
              GOTO     GEPS5000
            ENDIF
          ENDIF
.
          APPEND    " *",EPSADATT
          RESET     EPSADATT
.
GEPS5000  MOVE      SP70,EPSDDATT                * Episode end date & time
          UNPACK    EPISDDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      EPSDDATT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          ENDSET    EPSDDATT
          APPEND    " at ",EPSDDATT
          APPEND    EPISDTIM,EPSDDATT
.
          MATCH     DDATE,EPISDDAT
          IF        @EQUAL
            MATCH    DTIME,EPISDTIM
            IF       @EQUAL
              RESET    EPSDDATT
              GOTO     GEPS8000
            ENDIF
          ENDIF
.
          APPEND    " *",EPSDDATT
          RESET     EPSDDATT
.
GEPS8000  MOVE      ZERO,EXIT
          GOTO      GEPS9999
.
GEPS9000  MOVE      ONE,EXIT
          GOTO      GEPS9999
.
GEPS9999  RETURN
.
.------------------------------------------------------------
. Get Medical Record Details
.------------------------------------------------------------
MRTDES00  PACK      DESCHOME,SP70
          PACK      DESCDOCM,SP70
          MOVE      SP70,VOLNDESC
. 
          COMPARE   NINE,PVITYPE                 * If Allied Health display
          GOTO      MRTDES40 IF NOT EQUAL.       * the medical record for the
.                                                * Allied health linked visit
          MATCH     " 2",PVISYST
          GOTO      MRTDES40 IF NOT EQUAL.
.
          MATCH     SP70,ALENLINK                * Any linked visit
          GOTO      MRTDES99 IF EQUAL
.
          PACK      KEY8,ALENLINK,SP70
          GOTO      MRTDES45
.
MRTDES40  PACK      KEY8,PVIBILL,SP70
MRTDES45  CALL      RDMRVS1       * Gets the Unique key for the medical record 
          BRANCH    OVRCD,MRTDES99
.
          PACK      KEY10,MRVSMKEY,SP70
          CALL      RDMRMAS2      * reads the MRT master file for associated rec
          BRANCH    OVRCD,MRTDES99
.
          MATCH     PVIURNO,MRMAURNO  * Match U/R as might be a merged?
          IF        !@EQUAL
            MOVE      "Incomplete Merge",VOLNDESC
            GOTO      MRTDES99 
          ENDIF
.
          MOVE      DMRMAVOL,VOLNDESC  * Set Volume
.
          MOVE      "TY",CATEGORY
          MOVE      MRMADOTY,CODE
          CALL      GETCOD00
          MOVE      TDESC,DESCDOCM
.
          PACK      KEY7,MRMAHHOS,MRMAHLOC,SP10                       *C-240724
          CALL      RDMRLOC1
          MOVE      MRLODESC,DESCHOME
.
          GOTO      MRTDES99
.
MRTDES90  PACK      DESCHOME,SP70
          PACK      DESCDOCM,SP70
          MOVE      SP70,VOLNDESC
.
MRTDES99  RETURN
.
.------------------------------------------------------------
. Output ACC Accident Table Details
.------------------------------------------------------------
ACCTAB00  MOVE      ZERO,DIM1
          UNPACK    DIM127,D1,KEY1,DIM127     * Template level        
.
          MOVE      ZERO,RECCNT
          MOVE      ZERO,CHECKCNT
          MOVE      DIM1,CHECKCNT
.
          OPEN      ACCLODA2,"acclodaf"
.
          CALL      ACCLST00                * ACC Details Table
ACCTAB99  RETURN
+
.------------------------------------------------------------
. Output  Table Details
.------------------------------------------------------------
ACCLST00  PACK      KEY28,URNUMBER,SP70
          CALL      RSACLOD2
ACCLST10  CALL      RKACLOD2
          BRANCH    OVRCD,ACCLST99
.
          MATCH     "0",KEY1     
          IF        @EQUAL        
            MATCH     URNUMBER,ACLOURNO     * Match UR numbers for Patient view
            GOTO      ACCLST99 IF NOT EQUAL
          ELSE                              * or do Hospital level checks
            MATCH     FRSTDATE,ACLOUDAT
            GOTO      ACCLST10 IF LESS
            MATCH     ACLOUDAT,LASTDATE
            GOTO      ACCLST10 IF LESS
            IF        SRCHTYPE < 9
              MOVE      SRCHTYPE,DIM1
              MATCH     DIM1,ACLOSTAT
              GOTO      ACCLST10 IF NOT EQUAL
            ENDIF
          ENDIF
.
          PACK      KEY44,ACLOACCN,ACLOURNO,TILDA30
          CALL      RDSWCOM3
ACCLST20  CALL      RDPWCOM3                * read latest record for Admiss.No
.
          MATCH     ACLOACCN,WCCLMNO        * check for ACC No. & UR No.
          GOTO      ACCLST10 IF NOT EQUAL
          MATCH     ACLOURNO,PTWCURNO      
          GOTO      ACCLST10 IF NOT EQUAL
.
ACCLST40  MOVE      SP1,SECOPT                * Initialise SECOPT
          MOVE      SP1,PVITYPE               * Initialise PVITYPE
.
ACCLST50  PACK      SAVDATA1,SP70,SP70,SP70,SP70
.
          PACK      KEY26,WCCLMNO,ZERO,ZERO,ONE,SP1,SP1,ONE,SP70
          CALL      RDACCMT1
          BRANCH    OVRCD,ACCLST60
.
          MATCH     WCCLMNO,ACCMACCN
          GOTO      ACCLST60 IF NOT EQUAL
.
          STRIP     ACCMDATA                * description of accident
          CLEAR     SAVDATA1
          APPEND    ACCMDATA,SAVDATA1
          CALL      RKACCMT1
          BRANCH    OVRCD,ACCLST60
          MATCH     WCCLMNO,ACCMACCN
          GOTO      ACCLST60 IF NOT EQUAL
          MATCH     "001",ACCMTYPE
          GOTO      ACCLST60 IF NOT EQUAL
          ENDSET    SAVDATA1
          APPEND    SP1,SAVDATA1
          STRIP     ACCMDATA
          ENDSET    SAVDATA1
          APPEND    ACCMDATA,SAVDATA1
.
ACCLST60  RESET     SAVDATA1
          CLEAR     HTMLLINK
          STRIP     SAVDATA1
.
          APPEND    "javascript:linkPatient('",HTMLLINK
          APPEND    ACLOURNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    DWCADMNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PVITYPE,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    SECOPT,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    CASEKEYS,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",WCCLMNO,"#",";
          CLEAR     HTMLLINK
.
          CLEAR     HTMLLINK
          APPEND    "javascript:linkStatus('",HTMLLINK
          APPEND    ACLOURNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    DWCADMNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    WCCLMNO,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          UNPACK    ACLOUDAT,DIM4,DIM2A,DIM2B
          PACK      DIM10,DIM2B,SLSH,DIM2A,SLSH,DIM4
          REP       " 0",DIM10
          MOVE      " at ",DIM4
          PACK      DIM30,DIM10,DIM4,ACLOUTIM
.
          MOVE      ZERO,F2
          MOVE      SP10,DIM10
          MOVE      ACLOSTAT,F2             * values 0, 1 & 2
          ADD       ONE,F2                  * make it 1, 2 & 3
          PACK      KEY50,SP70
          LOAD      KEY50,F2,SUBMITED,SENT,RECEIPTD,FAILED,FAILED1:
                             FAILED2,FAILED3,FAILED4,SP70,FAILED5
.
          WRITE     HTMLFILE;"#"",HTMLLINK,"#",":
                             "#"",KEY50,"#",":
                             "#"",PTWCURNO,"#",":
                             "#"",WCACDAT,"#",":
                             "#"",DIM30,"#",":
                             "#"",ACLOWUID,"#",":
                             "#"",SAVDATA1,"#")"
          IF        CHECKCNT=0
            GOTO      ACCLST10
          ENDIF
.
          ADD       ONE,RECCNT
          COMPARE   FIFTY,RECCNT
          IF        @EQUAL
            MOVE      ONE,FINFLAG
            WRITE     HTMLFILE;"alert('Too Many Visits to View');"
            GOTO      ACCLST99
          ENDIF
.
          GOTO      ACCLST10
.
ACCLST99  RETURN
+
.------------------------------------------------------------
. Bookings Visit List
.------------------------------------------------------------
BOKLST00  PACK      KEY16,URNUMBER,SP70
          CALL      RSBKREC6
BOKLST10  CALL      RKBKREC6
          BRANCH    OVRCD,BOKLST99 
          MATCH     URNUMBER,BKREURNO
          GOTO      BOKLST99 IF NOT EQUAL
          COMPARE   ZERO,BKRESTAT
          GOTO      BOKLST10 IF NOT EQUAL
.
          PACK      KEY8,BKREBOOK,SP70
          CALL      RDBKRX11
          BRANCH    OVRCD,BOKLST10
.
          MOVE      SP70,KEY6
          MOVE      SP70,VISTHOSP
          MATCH     SP70,BKREWARD
          IF        !@EQUAL
            PACK      KEY6,BKREWARD,SP70
          ELSE 
            MATCH     SP70,BKRXPOWD
            IF        !@EQUAL
              PACK      KEY6,BKRXPOWD,SP70
            ENDIF
          ENDIF
          MATCH     SP70,KEY6
          IF        !@EQUAL
            CALL      RDWARD1
            IF        OVRCD<>1
              MOVE      PTWDHOSN,VISTHOSP
            ENDIF
          ENDIF
.
          IF        IBCNMHOS=1
            MATCH    "1",SHOWPPRV
            IF       @EQUAL
              IF       SHOWALLH=1
                PACK      KEY13,USERID,SP70              * All hospital access
                CALL      RDMLSEC1
                IF        OVRCD=1
                  PACK      KEY13,USERID,VISTHOSP,SP70   * This hospital access
                  CALL      RDMLSEC1
                  BRANCH    OVRCD,BOKLST10
                ENDIF
              ELSE
                PACK     KEY10,USERID,SP70        * Re read logged in user to
                CALL     RDWBSE1                  * get hospital
                BRANCH   OVRCD,BOKLST10
.
                MATCH    WBSEHOSP,VISTHOSP        * Only show visits for logged
                GOTO     BOKLST10 IF NOT EQUAL    * in hospital if pre adm from
              ENDIF
            ENDIF                               * prev details screen
          ENDIF
.
          MOVE      SP70,VISTLOC
          MOVE      SP70,UNITDESC
          MOVE      SP70,UNITCODE
          MOVE      SP70,DTYPDESC
          MOVE      SP70,CTYPDESC
          MOVE      SP70,CLAIMCOD
          MOVE      SP70,VISADIAG
          MOVE      SP70,ADIADESC
          MOVE      SP70,DDIADESC
          MOVE      SP70,SLOTNUMB
          PACK      VISTTYPE,SP70
          PACK      VSTATUS,SP70
          PACK      VISTLOC,SP70
          MOVE      SP70,PRIDISCD             * I CAR 18122
          PACK      PDIADESC,SP70,SP70,SP70   * I CAR 18122
.
          MOVE      SP70,VISTDAY
          UNPACK    BKREEDAT,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
          LOAD      DAYNAM3,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
          PACK      VISTDAY,DAYNAM3,SP70
.
          MOVE      BKREEDAT,PVIDATE
          MOVE      BKREATIM,VISTTIME
.
          ADD       ONE,VISCOUNT
          MOVE      "Book",VISTTYPE
          MOVE      "Booking",VSTATUS
          MOVE      "Booking",VISTDESC
.
          MOVE      BKREPROC,VISADIAG         * Procedure
          PACK      KEY18,BKREBOOK,SP70
          CALL      RSBKDIA1
          CALL      RKBKDIA1
          IF        OVRCD=0
            MATCH     BKREBOOK,BKDIBOOK
            IF        @EQUAL
              MOVE      BKDICODE,VISADIAG
              MOVE      BKDIDES1,ADIADESC       * Procedure description
            ENDIF
          ENDIF
.
          MOVE      BKREADOC,KEY6    
          CALL      RDDOCT1 
          IF        OVRCD=1
            MOVE      SP70,DOCFNAME
          ELSE
.           CALL      DOCNAM00                * Format Doctor Name  
            MOVE      DTITL,FMTTITLE            * I CAR 13038
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000                  * end I CAR 13038
          ENDIF
.
          PACK      KEY8,BKREBOOK,SP70
          CALL      RDBKRX11
          MATCH     SP70,BKRXPOWD
          IF        !@EQUAL
            PACK      KEY6,BKRXPOWD,SP70
            CALL      RDWARD1
            IF        OVRCD<>1
              PACK      KEY6,BKRXPOWD,BKRXPOBD,SP70
              PACK      KEY3,BKRXPOWD,SP70
              CALL      FWBD0000
              PACK      VISTLOC,WARDBED,SP70
              COMPARE   ONE,IBCNMHOS
              IF        @EQUAL
                PACK      KEY3,PTWDHOSN,SP70
                CALL      FHOS0000
                PACK      VISTLOC,HOSPTEXT,DASH,WARDBED,SP70
              ENDIF
            ENDIF
          ENDIF
.
          PACK      DESCHOME,SP70
          PACK      DESCDOCM,SP70
          MOVE      SP70,MRVSXKY1
          MOVE      SP70,VOLNDESC
.
          PACK      KEY8,BKREBOOK,SP70
          CALL      RDMRVS1       * Gets the Unique key for the medical record
          BRANCH    OVRCD,BOKLST20
. 
          PACK      KEY10,MRVSMKEY,SP70
          CALL      RDMRMAS2      * reads the MRT master file for associated rec
          BRANCH    OVRCD,BOKLST20
. 
          MATCH     BKREURNO,MRMAURNO  * Match U/R as might be a merged?
          IF        !@EQUAL
            PACK      DESCHOME,SP70
            PACK      DESCDOCM,SP70
            MOVE      SP70,VOLNDESC
            MOVE      "Incomplete Merge",VOLNDESC
            GOTO      BOKLST20 
          ENDIF
. 
          MOVE      DMRMAVOL,VOLNDESC  * Set Volume
. 
          MOVE      "TY",KEY2
          PACK      KEY5,KEY2,MRMADOTY
          CALL      RDCODE1
          MOVE      TDESC,DESCDOCM
. 
          PACK      KEY7,MRMAHHOS,MRMAHLOC,SP10                       *C-240724
          CALL      RDMRLOC1
          MOVE      MRLODESC,DESCHOME
.
BOKLST20  MOVE      SP70,SECOPT
          PACK      KEY5,ANSB,ANSK,BKRETYPE,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            MATCH     ANSI,TCINDC4
            IF        @EQUAL
              MOVE      "1",SECOPT
            ENDIF
            MATCH     ANSO,TCINDC4
            IF        @EQUAL
              MOVE      "2",SECOPT
            ENDIF
          ENDIF
          MOVE      SP70,CASEKEYS
.
          MATCH     SP70,BKREPROC
          GOTO      BOKLST25 IF EQUAL
.
          PACK      KEY19,BKREURNO,BKREPROC,DBKRECNT,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,BOKLST25
.
          MOVE      "3",SECOPT
          PACK      CASEKEYS,WMURNO,WMCODE,WMCNT,SP70
.
BOKLST25  CLEAR     HTMLLINK
          APPEND    "javascript:linkPatient('",HTMLLINK
          APPEND    URNUMBER,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    DBKREBOO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    SEVEN,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    SECOPT,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    CASEKEYS,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          CLEAR     UPDPLINK
          APPEND    "javascript:updParentLink('",UPDPLINK
          APPEND    URNUMBER,UPDPLINK
          APPEND    "','",UPDPLINK
          APPEND    DBKREBOO,UPDPLINK
          APPEND    "','",UPDPLINK
          APPEND    BKRECLSS,UPDPLINK
          APPEND    "','",UPDPLINK
          APPEND    SP1,UPDPLINK
          APPEND    "','",UPDPLINK
          APPEND    SP1,UPDPLINK
          APPEND    "','",UPDPLINK
          APPEND    SP1,UPDPLINK
          APPEND    "','",UPDPLINK
          APPEND    SP1,UPDPLINK
          APPEND    "','",UPDPLINK
          APPEND    BKREACCM,UPDPLINK
          APPEND    "','",UPDPLINK
          APPEND    SP1,UPDPLINK
          APPEND    "','",UPDPLINK
          APPEND    BKRERFGP,UPDPLINK
          APPEND    "','",UPDPLINK
          APPEND    SP1,UPDPLINK
          APPEND    "','",UPDPLINK
          APPEND    SP1,UPDPLINK
          APPEND    "')",UPDPLINK
          RESET     UPDPLINK
.
          MOVE      "CL",CATEGORY
          MOVE      BKRECLMT,CODE
          CALL      GETCOD00
          MOVE      TDESC,CTYPDESC
          MOVE      ACODE,CLAIMCOD
.
          MOVE      "A ",CATEGORY
          MOVE      BKREATYP,CODE
          CALL      GETCOD00
          MOVE      TDESC,ATYPDESC
.
          MOVE      "AC",CATEGORY
          MOVE      BKREDEPT,CODE
          CALL      GETCOD00
          MOVE      TDESC,DTYPDESC
          MOVE      TDESC,UNITDESC
          MOVE      CODE,UNITCODE
.
          REP       " 0",BKREEDAT
          MATCH     SP70,BKREATIM
          IF        @EQUAL
            MOVE      "12:00:00",BKREATIM
          ENDIF
.
          MOVE      SP70,AUDITDTE
.
          MATCH     SP70,VISTLOC
          GOTO      BOKLST50 IF NOT EQUAL
.
          MATCH     SP70,BKREPROC
          GOTO      BOKLST50 IF EQUAL
.
          PACK      KEY19,BKREURNO,BKREPROC,DBKRECNT,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,BOKLST50
.
          PACK      KEY19,WMURNO,WMCODE,WMCNT,SP70
          CALL      RDWTTX11
          BRANCH    OVRCD,BOKLST50
.
          PACK      KEY6,WTTXWARD,SP70
          PACK      KEY3,WTTXWARD,SP70
          CALL      FWBD0000
          PACK      VISTLOC,WARDBED,SP70
          COMPARE   ONE,IBCNMHOS
          IF        @EQUAL
            PACK      KEY3,WTWMIHSP,SP70
            CALL      FHOS0000
            PACK      VISTLOC,HOSPTEXT,DASH,WARDBED,SP70
          ENDIF
.
BOKLST50  CLEAR     EXTVSTID
          CLEAR     CHKEXTVD
          PACK      CHKEXTVD,DBKREBOO,SP70
          PROC      CHKEID00
          MATCH     KEY20,SP70
          IF        @EQUAL
            PACK      EXTVSTID,DBKREBOO
          ELSE
            APPEND    DBKREBOO,EXTVSTID
            APPEND    SP2,EXTVSTID
            APPEND    "<span class='TextBlue'>(",EXTVSTID
            APPEND    KEY20,EXTVSTID
            APPEND    ")</span>",EXTVSTID
          ENDIF
.
          REP       "#"'",PDIADESC
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",EXTVSTID,"#",":
                             "#"",BKREEDAT,BKREATIM,"#",":
                             "#"",SP1,"#",":
                             "#"",VISTDESC,"#",":
                             "#"",SP1,"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",ATYPDESC,"#",":
                             "#"",CTYPDESC,"#",":
                             "#"",ZERO,"#",":
                             "#"",DTYPDESC,"#",":         * 10            
                             "#"",DESCDOCM,"#",":
                             "#"",DESCHOME,"#"," 
          MATCH     SP70,MRVSXKY1
          IF        !@EQUAL
            WRITE     HTMLFILE;"#"",VOLNDESC," +#","
          ELSE
            WRITE     HTMLFILE;"#"",VOLNDESC,"#"," 
          ENDIF
          WRITE     HTMLFILE;"#"",UNITDESC,"#",":
                             "#"",VISTDAY,"#",":
                             "#"",VISTTYPE,"#",":
                             "#"",VISADIAG,"#",":
                             "#"",VISTLOC,"#",":
                             "#"",VSTATUS,"#",":
                             "#"",SP1,"#",":              * 20               
                             "#"",ADIADESC," #",":
                             "#"",SP1,"#",":
                             "#"",DDIADESC,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",VOLNDESC,"#",":
                             "#"",SP1,"#",":
                             "#"",UNITCODE,"#",":
                             "#"",CLAIMCOD,"#",":
                             "#"",PRIDISCD,"#",":           * I CAR 18122 * 30
                             "#"",PDIADESC,"#",":           * I CAR 18122
                             "#"",AUDITDTE,"#",":      * Coding Audit Date
                             "#"",SP1,"#",":                              
                             "#"",SP1,"#",":                *CDM           
                             "#"",VISTHOSP,"#",": 
                             "#"",SP1,"#",": 
                             "#"",SP1,"#",": 
                             "#"",SP1,"#",": 
                             "#"",SP1,"#",": 
                             "#"",SP1,"#",":              * 40 
                             "#"",SP1,"#",": 
                             "#"",SP1,"#",": 
                             "#"",SP1,"#",": 
                             "#"",SP1,"#",": 
                             "#"",SP1,"#",": 
                             "#"",SP1,"#",": 
                             "#"",SP1,"#",": 
                             "#"",SP1,"#",": 
                             "#"",SP1,"#",": 
                             "#"",SP1,"#",": 
                             "#"",SP1,"#",": 
                             "#"",UPDPLINK,"#",":      * 52
                             "#"",SP1,"#",": 
                             "#"",SP1,"#")" 
          GOTO      BOKLST10
.
BOKLST99  RETURN
.------------------------------------------------------------
. Waiting List Details
.------------------------------------------------------------
WATLST00  MOVE      SP70,VISTLOC
          MOVE      SP70,DTYPDESC
          MOVE      SP70,UNITCODE
          MOVE      SP70,UNITDESC
          MOVE      SP70,CTYPDESC
          MOVE      SP70,CLAIMCOD
          MOVE      SP70,VISADIAG
          MOVE      SP70,ADIADESC
          MOVE      SP70,DDIADESC
          MOVE      SP70,SLOTNUMB
          PACK      VISTTYPE,SP70
          PACK      VSTATUS,SP70
          MOVE      SP70,PRIDISCD            * I CAR 18122
          PACK      PDIADESC,SP70,SP70,SP70  * I CAR 18122
.
          PACK      KEY19,URNUMBER,SP20
          CALL      RDSTREA1
WATLST10  CALL      RDKTREA1
          BRANCH    OVRCD,WATLST99
          MATCH     URNUMBER,WMURNO      * Same U/R ?
          GOTO      WATLST90 IF NOT EQUAL
.
          IF        PTCNHDPS=1
            MATCH     SP70,WTWMIHSP
            IF        !@EQUAL
              MATCH     SP70,FILTHOSP
              IF        !@EQUAL
                MATCH     FILTHOSP,WTWMIHSP
                GOTO      WATLST10 IF NOT EQUAL
              ELSE
                PACK      KEY13,USERID,SP70              * All hospital access
                CALL      RDMLSEC1
                IF        OVRCD=1
                  PACK      KEY13,USERID,WTWMIHSP,SP70   * This hospital access
                  CALL      RDMLSEC1
                  BRANCH    OVRCD,WATLST10
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      WTWMIHSP,VISTHOSP
.
          PACK      KEY19,WMURNO,WMCODE,WMCNT,SP70
          CALL      RDWTTX11
          MOVE      SP70,VISTDAY
          UNPACK    WMDATE1,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
          LOAD      DAYNAM3,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
          PACK      VISTDAY,DAYNAM3,SP70
.
          MOVE      WMDATE1,PVIDATE
          MOVE      SP70,VISTTIME
.
          MOVE      "W/L",VISTTYPE
          COMPARE   ONE,WMSTAT
          IF        @EQUAL
            MOVE      WLSTAT1,VSTATUS
            GOTO      WATLST20            * unscheduled status
          ENDIF
.
          COMPARE   NINE,WMSTAT
          IF        @EQUAL
            MOVE      WLSTAT9,VSTATUS
            GOTO      WATLST20            * unscheduled status
          ENDIF
          GOTO      WATLST10 
.
WATLST20  MOVE      "P ",CATEGORY
          MOVE      WTWMCLSS,CODE
          CALL      GETCOD00
          MOVE      TDESC,CTYPDESC       * Admission CLass
          MOVE      ACODE,CLAIMCOD
.
          MOVE      "WU",CATEGORY
          MOVE      WMUNIT,CODE
          CALL      GETCOD00
          MOVE      TDESC,DTYPDESC
          MOVE      CODE,UNITCODE
          MOVE      TDESC,UNITDESC
.
          MOVE      WMDOCTOR,KEY6    
          CALL      RDDOCT1 
          IF        OVRCD=1
            MOVE      SP70,DOCFNAME
          ELSE
.           CALL      DOCNAM00                * Format Doctor Name  
            MOVE      DTITL,FMTTITLE            * I CAR 13038
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000                  * end I CAR 13038
          ENDIF
.
          MOVE      WMCODE,VISADIAG
          MOVE      WMREASON,ADIADESC
.
          MOVE      "CL",CATEGORY
          MOVE      WTTXCTYP,CODE
          CALL      GETCOD00
          MOVE      TDESC,CTYPDESC
          MOVE      ACODE,CLAIMCOD
.
          PACK      CASEKEYS,WMURNO,WMCODE,WMCNT,SP70
.         REP       " +",CASEKEYS
          CLEAR     HTMLLINK
          APPEND    "javascript:linkPatient('",HTMLLINK
          APPEND    URNUMBER,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    WMBOOK,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    EIGHT,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    SECOPT,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    CASEKEYS,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          MOVE      SP70,AUDITDTE
          MOVE      SP10,VISTTIME
          REP       " 0",PVIDATE
.
          PACK      KEY6,WTTXWARD,SP70
          PACK      KEY3,WTTXWARD,SP70
          CALL      FWBD0000
          PACK      VISTLOC,WARDBED,SP70
          COMPARE   ONE,IBCNMHOS
          IF        @EQUAL
            PACK      KEY3,WTWMIHSP,SP70
            CALL      FHOS0000
            PACK      VISTLOC,HOSPTEXT,DASH,WARDBED,SP70
          ENDIF
.
          MOVE      WMBOOK,VISITNO
          RJUSTIFY  VISITNO
.
          CLEAR     EXTVSTID
          CLEAR     CHKEXTVD
          PACK      CHKEXTVD,VISITNO,SP70
          PROC      CHKEID00
          MATCH     KEY20,SP70
          IF        @EQUAL
            PACK      EXTVSTID,VISITNO
          ELSE
            APPEND    VISITNO,EXTVSTID
            APPEND    SP2,EXTVSTID
            APPEND    "<span class='TextBlue'>(",EXTVSTID
            APPEND    KEY20,EXTVSTID
            APPEND    ")</span>",EXTVSTID
          ENDIF
.
          REP       "#"'",PDIADESC
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",EXTVSTID,"#",":
                             "#"",PVIDATE,VISTTIME,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",SP1,"#",":
                             "#"",CTYPDESC,"#",":
                             "#"",SP1,"#",":
                             "#"",DTYPDESC,"#",":         * 10
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",UNITDESC,"#",":
                             "#"",VISTDAY,"#",":
                             "#"",VISTTYPE,"#",":
                             "#"",VISADIAG,"#",":
                             "#"",VISTLOC,"#",":
                             "#"",VSTATUS,"#",":
                             "#"",SP1,"#",":              * 20
                             "#"",ADIADESC," #",":
                             "#"",SP1,"#",":
                             "#"",DDIADESC,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",UNITCODE,"#",":
                             "#"",CLAIMCOD,"#",":
                             "#"",PRIDISCD,"#",":            * I CAR 18122  * 30  
                             "#"",PDIADESC,"#",":            * I CAR 18122
                             "#"",AUDITDTE,"#",":  * Coding Audit Date8122
                             "#"",SP1,"#",": 
                             "#"",SP1,"#",":            * CDM
                             "#"",VISTHOSP,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":              * 40
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":              * 50
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#")"       
.
          GOTO      WATLST10
.
WATLST90  
WATLST99  RETURN
.------------------------------------------------------------
. Output Outpatient Bookings
.------------------------------------------------------------
OUTLST00  MOVE      SP70,VISTLOC
          MOVE      SP70,DTYPDESC
          MOVE      SP70,UNITCODE
          MOVE      SP70,UNITDESC
          MOVE      SP70,CTYPDESC
          MOVE      SP70,CLAIMCOD
          MOVE      SP70,VISADIAG
          MOVE      SP70,ADIADESC
          MOVE      SP70,DDIADESC
          MOVE      SP70,SLOTNUMB
          PACK      VISTTYPE,SP70
          PACK      VSTATUS,SP70
          MOVE      "OP",VISTTYPE
          MOVE      SP70,PRIDISCD              * I CAR 18122
          PACK      PDIADESC,SP70,SP70,SP70    * I CAR 18122
          MOVE      SP70,DOCFNAME
          MOVE      SP70,DESCDOCM
          MOVE      SP70,DESCHOME
          MOVE      SP70,MRVSXKY1
          MOVE      SP70,VOLNDESC
          MOVE      SP70,VISTDAY 
          MOVE      SP70,AUDITDTE
.
          PACK      KEY36,URNUMBER,SP70
          CALL      RDSBOKA3
OUTLST10  CALL      RDKBOKA3
          BRANCH    OVRCD,OUTLST70
          MOVE      URNUMBER,KEY8
          MATCH     OBAURNO,KEY8         * Check if same U/R
          GOTO      OUTLST70 IF NOT EQUAL
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          IF        OVRCD=0
            MOVE      "AC",CATEGORY
            MOVE      OTBBDEPT,CODE
            CALL      GETCOD00
            MOVE      TDESC,DTYPDESC
.            MOVE      TDESC,UNITDESC
            MOVE      CODE,UNITCODE
          ENDIF
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDPMVX11
          IF        OVRCD=1
            CALL      CLPMSVX1
          ENDIF
          MOVE      PMVXMHOS,VISTHOSP
.
          MATCH     "1",INFORMGP
          IF        @EQUAL
            MATCH     "1",PMVXINGP
            IF        !@EQUAL
              GOTO      OUTLST10
            ENDIF
          ENDIF
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDDIAG1
          IF        OVRCD=0
            MOVE      OPDIDESC,ADIADESC
            MOVE      OPDICODE,VISADIAG
          ENDIF
.
          PACK      KEY12,OBASITE,OBACTYP,SP70
          CALL      RDCTYA1
          IF        OVRCD = 0
            MOVE     OCTDESC,UNITDESC
            MOVE     OBACTYP,UNITCODE
          ENDIF
.
          MOVE      OBAOUTNO,PVIBILL
          MOVE      OBADATE,PVIDATE
          MOVE      "2",PVITYPE
          MOVE      " 2",PTVITYPE
          MOVE      OBATIME,VISTTIME
          MOVE      OBASLOT,SLOTNUMB
          MOVE      OBACOMP,ACLAIM
          MOVE      SP70,VSTATUS
          IF        OBASTAT=1|OBASTAT=5
            IF        OBASTAT=1
              MOVE      "Booked",VSTATUS
            ELSE
              MOVE      "DNA",VSTATUS
            ENDIF
          ELSE 
            GOTO        OUTLST10
          ENDIF
.
OUTLST12  PACK      KEY18,OBASITE,OBACLIN,OBADAY,OBASTRT,SP70
          CALL      RDMASA1
          IF        OVRCD=1
            CALL      CLRMAS00
          ENDIF
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RDSESA1
          IF        OVRCD=1
            CALL      CLRSES00 
          ENDIF
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          IF        OVRCD=1
            CALL     CLOUTHED
          ENDIF
.
          PACK      VISTLOC,OTHELTYP,SP70
.
          MOVE      "CT",CATEGORY
          MOVE      OTHELTYP,CODE
          CALL      GETCOD00
          MATCH     SP70,TDESC
          IF        !@EQUAL
            PACK      VISTLOC,TDESC,SP70
          ENDIF
.
          COMPARE   ONE,IBCNMHOS
          IF        @EQUAL
            PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
            CALL      RDMASA1
            IF        OVRCD<>1
              PACK      KEY3,OTHEHOSP
              CALL      FHOS0000
              PACK      VISTLOC,HOSPTEXT,DASH,OTHELTYP,SP70
.
              MOVE      "CT",CATEGORY
              MOVE      OTHELTYP,CODE
              CALL      GETCOD00
              MATCH     SP70,TDESC
              IF        !@EQUAL
                PACK      VISTLOC,HOSPTEXT,DASH,TDESC,SP70
              ENDIF 
.
            ENDIF
          ENDIF
.
          MOVE      "CL",CATEGORY
          MOVE      OBACOMP,CODE
          CALL      GETCOD00
          MOVE      TDESC,CTYPDESC
          MOVE      ACODE,CLAIMCOD
.
          PACK      DESCHOME,SP70
          PACK      DESCDOCM,SP70
          MOVE      SP70,VOLNDESC
          PACK      KEY8,DOBAOUTN,SP70
          CALL      RDMRVS1       * Gets the Unique key for the medical record
          BRANCH    OVRCD,OUTLST15

          PACK      KEY10,MRVSMKEY,SP70
          CALL      RDMRMAS2      * reads the MRT master file for associated rec
          BRANCH    OVRCD,OUTLST15
.
          MATCH     OBAURNO,MRMAURNO  * Match U/R as might be a merged?
          IF        !@EQUAL
            MOVE      "Incomplete Merge",VOLNDESC
            GOTO      OUTLST15 
          ENDIF
.
          MOVE      DMRMAVOL,VOLNDESC  * Set Volume
.
          MOVE      "TY",KEY2
          PACK      KEY5,KEY2,MRMADOTY
          CALL      RDCODE1
          BRANCH    OVRCD,OUTLST15
          MOVE      TDESC,DESCDOCM
.
          PACK      KEY7,MRMAHHOS,MRMAHLOC,SP10                       *C-240724
          CALL      RDMRLOC1
          BRANCH    OVRCD,OUTLST15
          MOVE      MRLODESC,DESCHOME
.
.
.------Outpatient - Read clinic file to get either doctors name, or doctor code
.
OUTLST15  MATCH     SP6,OBACLIN
          GOTO      OUTLST60 IF EQUAL
.
          PACK      KEY20,OBASITE,OBACLIN,OBADATE,SP70
          CALL      RDCLIA1
          IF        OVRCD = 0
            GOTO      OUTLST18
          ENDIF
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          BRANCH    OVRCD,OUTLST20
.
          MATCH     OBASITE,OCASITE
          GOTO      OUTLST20 IF NOT EQUAL
.
          MATCH     OBACLIN,OCACLIN
          GOTO      OUTLST20 IF NOT EQUAL
.
OUTLST18  MOVE      OCADESC,DOCFNAME     * If no Doctor Use Clinic Name
          MATCH     SP6,OCADOCT
          GOTO      OUTLST60 IF EQUAL
          MOVE      OCADOCT,OBADOCT      * Use the doctor's code from the clinic
.
          MOVE      OCADOCT,KEY6         * I CAR 13038
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000
          ELSE                                                        *I-262001
            PACK      KEY10,OCADOCT,SP10  * try "pmshcpaf" for Doctor Name
            CALL      RDPMHCP1
            IF        OVRCD=0
              MOVE      PMHCTITL,FMTTITLE
              MOVE      PMHCGNAM,FMTGNAME
              MOVE      PMHCSNAM,FMTSNAME
              CALL      DOCNM000
            ENDIF
          ENDIF
.                                        * end I CAR 13038
          CALL      FRMD0000             * CAR 202491 - format outpatient clinic(hcp) 
.
          GOTO      OUTLST60
.
OUTLST20  CLEAR     DOCFNAME
          APPEND    "Invalid Clinic - ",DOCFNAME
          APPEND    PVIDOCT,DOCFNAME
          RESET     DOCFNAME
...        GOTO      GETVIS60
.
OUTLST60  CLEAR     HTMLLINK
          APPEND    "javascript:linkPatient('",HTMLLINK
          APPEND    URNUMBER,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    DOBAOUTN,HTMLLINK 
          APPEND    "','",HTMLLINK
          APPEND    TWO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    OBASITE,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          CALL      OUTROW00
.
. ---  get rescheduled outpatient bookings ---
.
          PACK      KEY11,OBAOUTNO,SP70
          CALL      RDSRSHA1
OUTLST65  CALL      RDKRSHA1
          BRANCH    OVRCD,OUTLST10
          MATCH     OBAOUTNO,OPRSOUTN
          GOTO      OUTLST10 IF NOT EQUAL
.
          CALL      RCTY0000                   * Get clinic type description
.
          PACK      VISTLOC,OTMALTYP,SP70
.
          MOVE      "CT",CATEGORY
          MOVE      OTMALTYP,CODE
          CALL      GETCOD00
          MATCH     SP70,TDESC
          IF        !@EQUAL
            PACK      VISTLOC,TDESC,SP70
          ENDIF
.
          COMPARE   ONE,IBCNMHOS
          IF        @EQUAL
            PACK      KEY3,OTHEHOSP
            CALL      FHOS0000
.
            PACK      VISTLOC,HOSPTEXT,DASH,OTMALTYP,SP70
.
            MOVE      "CT",CATEGORY
            MOVE      OTMALTYP,CODE
            CALL      GETCOD00
            MATCH     SP70,TDESC
            IF        !@EQUAL
              PACK      VISTLOC,HOSPTEXT,DASH,TDESC,SP70
            ENDIF
.
          ENDIF
.
          PACK      KEY20,OPRSSITE,OPRSCLIN,OPRSDATE,SP70
          CALL      RDCLIA1
          IF        OVRCD = 0
            MOVE      OCADESC,DOCFNAME     * If no Doctor Use Clinic Name
.
            MATCH     SP6,OCADOCT          * I CAR 13038
            GOTO      OUTLST68 IF EQUAL
.
            MOVE      OCADOCT,KEY6
            CALL      RDDOCT1
            IF        OVRCD=0
              MOVE      DTITL,FMTTITLE
              MOVE      DGNAME,FMTGNAME
              MOVE      DSNAME,FMTSNAME
              CALL      DOCNM000
            ELSE                                                      *I-262001
              PACK      KEY10,OCADOCT,SP10  * try "pmshcpaf" for Doctor Name
              CALL      RDPMHCP1
              IF        OVRCD=0
                MOVE      PMHCTITL,FMTTITLE
                MOVE      PMHCGNAM,FMTGNAME
                MOVE      PMHCSNAM,FMTSNAME
                CALL      DOCNM000
              ENDIF
            ENDIF
.
            CALL      FRMD0000           
. 
            GOTO      OUTLST68 
          ENDIF
.
          PACK      KEY20,OPRSSITE,OPRSCLIN,OPRSDATE,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          BRANCH    OVRCD,OUTLST67
.
          MATCH     OPRSSITE,OCASITE
          GOTO      OUTLST67 IF NOT EQUAL
.
          MATCH     OPRSCLIN,OCACLIN
          GOTO      OUTLST67 IF NOT EQUAL
.
          MOVE      OCADESC,DOCFNAME     * If no Doctor Use Clinic Name
.
          MATCH     SP6,OCADOCT          * I CAR 13038
          GOTO      OUTLST68 IF EQUAL
.
          MOVE      OCADOCT,KEY6
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000
          ELSE                                                        *I-262001
            PACK      KEY10,OCADOCT,SP10  * try "pmshcpaf" for Doctor Name
            CALL      RDPMHCP1
            IF        OVRCD=0
              MOVE      PMHCTITL,FMTTITLE
              MOVE      PMHCGNAM,FMTGNAME
              MOVE      PMHCSNAM,FMTSNAME
              CALL      DOCNM000
            ENDIF
          ENDIF
.
          CALL      FRMD0000
. 
          GOTO      OUTLST68 
.
OUTLST67  MOVE      "Invalid Clinic",DOCFNAME     * If no Doctor Use Clinic Name
.
OUTLST68  MOVE      OPRSDATE,PVIDATE
          MOVE      OPRSTIME,VISTTIME
          MOVE      OPRSSLOT,OBASLOT
          REP       " 0",PVIDATE
          MOVE      SP70,DESCDOCM
          MOVE      SP70,DESCHOME
          MOVE      SP70,VOLNDESC
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDMRVS1       * Gets the Unique key for the medical record
          BRANCH    OVRCD,OUTLST69

          PACK      KEY10,MRVSMKEY,SP70
          CALL      RDMRMAS2      * reads the MRT master file for associated rec
          BRANCH    OVRCD,OUTLST69
.
          MATCH     OBAURNO,MRMAURNO  * Match U/R as might be a merged?
          IF        !@EQUAL
            MOVE      "Incomplete Merge",VOLNDESC
            GOTO      OUTLST69 
          ENDIF
.
          MOVE      DMRMAVOL,VOLNDESC  * Set Volume
.
          MOVE      "TY",KEY2
          PACK      KEY5,KEY2,MRMADOTY
          CALL      RDCODE1
          BRANCH    OVRCD,OUTLST69
          MOVE      TDESC,DESCDOCM
.
          PACK      KEY7,MRMAHHOS,MRMAHLOC,SP10                       *C-240724
          CALL      RDMRLOC1
          BRANCH    OVRCD,OUTLST69
          MOVE      MRLODESC,DESCHOME
.
OUTLST69  MOVE      "Rescheduled",VSTATUS
          MOVE      "javascript:alert('Rescheduled')",HTMLLINK
.
          CALL      OUTROW00
.
          GOTO      OUTLST65
.
. ---  get cancelled outpatient bookings ---
.
OUTLST70  MOVE      SP70,VISTLOC
          MOVE      SP70,DTYPDESC
          MOVE      SP70,UNITDESC
          MOVE      SP70,UNITCODE
          MOVE      SP70,CTYPDESC
          MOVE      SP70,CLAIMCOD
          MOVE      SP70,VISADIAG
          MOVE      SP70,ADIADESC
          MOVE      SP70,DDIADESC
          MOVE      SP70,SLOTNUMB
          MOVE      SP70,VISTLOC
          PACK      VISTTYPE,SP70
          PACK      VSTATUS,SP70
          MOVE      "OP",VISTTYPE
.
          PACK      KEY24,URNUMBER,SP70
          CALL      RSOTCAN2
OUTLST75  CALL      RKOTCAN2
          BRANCH    OVRCD,OUTLST99
.
          MATCH     URNUMBER,OPCNURNO
          GOTO      OUTLST99 IF NOT EQUAL
.
          CALL      CCTY0000                   * Get clinic type description
          MOVE      OTHEHOSP,VISTHOSP
.
          PACK      VISTLOC,OTMALTYP,SP70
.
          MOVE      "CT",CATEGORY
          MOVE      OTMALTYP,CODE
          CALL      GETCOD00
          MATCH     SP70,TDESC
          IF        !@EQUAL
            PACK      VISTLOC,TDESC,SP70
          ENDIF
.
          COMPARE   ONE,IBCNMHOS
          IF        @EQUAL
            PACK      KEY3,OTHEHOSP
            CALL      FHOS0000
            PACK      VISTLOC,HOSPTEXT,DASH,OTMALTYP,SP70
.
            MOVE      "CT",CATEGORY
            MOVE      OTMALTYP,CODE
            CALL      GETCOD00
            MATCH     SP70,TDESC
            IF        !@EQUAL
              PACK      VISTLOC,HOSPTEXT,DASH,TDESC,SP70
            ENDIF
.
          ENDIF
.
.
          PACK      KEY36,DOPCNOUT,OPCNDATE,OPCNSTRT,DOPCNSLO,OPCNSITE,OPCNCLIN
          CALL      RDBOKA3
          BRANCH    OVRCD,OUTLST80
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,OUTLST77
.
          PACK      KEY12,OBASITE,OBACTYP,SP70
          CALL      RDCTYA1
          IF        OVRCD = 0
            MOVE     OCTDESC,UNITDESC
            MOVE     OBACTYP,UNITCODE
          ENDIF
.
OUTLST77  MATCH     OBAURNO,URNUMBER
          GOTO      OUTLST75 IF EQUAL
.
OUTLST80  MOVE      OPCNDATE,PVIDATE
          MOVE      "2",PVITYPE
          MOVE      " 2",PTVITYPE
          MOVE      OBAOUTNO,PVIBILL
          MOVE      OPCNTIME,VISTTIME
          MOVE      DOPCNOUT,SLOTNUMB
          MOVE      SP70,VSTATUS
          MOVE      "Cancelled",VSTATUS
          MATCH     SP70,OPCNCLIN
          GOTO      OUTLST85 IF EQUAL
.
          PACK      KEY20,OPCNSITE,OPCNCLIN,OPCNDATE,SP70
          CALL      RDCLIA1
          IF        OVRCD = 0
            GOTO      OUTLST81
          ENDIF
.
          PACK      KEY20,OPCNSITE,OPCNCLIN,OPCNDATE,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          BRANCH    OVRCD,OUTLST82
.
          MATCH     OPCNSITE,OCASITE
          GOTO      OUTLST82 IF NOT EQUAL
.
          MATCH     OPCNCLIN,OCACLIN
          GOTO      OUTLST82 IF NOT EQUAL
.
OUTLST81  MOVE      OCADESC,DOCFNAME     * If no Doctor Use Clinic Name
          MATCH     SP6,OCADOCT
          GOTO      OUTLST85 IF EQUAL
          MOVE      OCADOCT,OPCNCLIN     * Use the doctor's code from the clinic
.
          MOVE      OCADOCT,KEY6         * I CAR 13038
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000
          ELSE                                                        *I-262001
            PACK      KEY10,OCADOCT,SP10  * try "pmshcpaf" for Doctor Name
            CALL      RDPMHCP1
            IF        OVRCD=0
              MOVE      PMHCTITL,FMTTITLE
              MOVE      PMHCGNAM,FMTGNAME
              MOVE      PMHCSNAM,FMTSNAME
              CALL      DOCNM000
            ENDIF
          ENDIF
.                                        * end I CAR 13038
          CALL      FRMD0000
.
          GOTO      OUTLST85
.
OUTLST82  CLEAR     DOCFNAME
          APPEND    "Invalid Clinic - ",DOCFNAME
          APPEND    PVIDOCT,DOCFNAME
          RESET     DOCFNAME
.
OUTLST85  CLEAR     HTMLLINK
          APPEND    "javascript:linkPatient('",HTMLLINK
          APPEND    URNUMBER,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    DOPCNOUT,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    FOUR,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    OPCNSITE,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          MOVE      OPCNOUTN,OBAOUTNO
          MOVE      OPCNURNO,OBAURNO
          MOVE      OPCNSLOT,OBASLOT
          REP       " 0",PVIDATE
          MOVE      SP70,DESCDOCM
          MOVE      SP70,DESCHOME
          MOVE      SP70,VOLNDESC
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDMRVS1       * Gets the Unique key for the medical record
          BRANCH    OVRCD,OUTLST87
.
          PACK      KEY10,MRVSMKEY,SP70
          CALL      RDMRMAS2      * reads the MRT master file for associated rec
          BRANCH    OVRCD,OUTLST87
.
          MATCH     OBAURNO,MRMAURNO  * Match U/R as might be a merged?
          IF        !@EQUAL
            MOVE      "Incomplete Merge",VOLNDESC
            GOTO      OUTLST87 
          ENDIF
.
          MOVE      DMRMAVOL,VOLNDESC  * Set Volume
.
          MOVE      "TY",KEY2
          PACK      KEY5,KEY2,MRMADOTY
          CALL      RDCODE1
          BRANCH    OVRCD,OUTLST87
          MOVE      TDESC,DESCDOCM
.
          PACK      KEY7,MRMAHHOS,MRMAHLOC,SP10                       *C-240724
          CALL      RDMRLOC1
          BRANCH    OVRCD,OUTLST87
          MOVE      MRLODESC,DESCHOME
.
OUTLST87  CALL      OUTROW00
          GOTO      OUTLST75
.
OUTLST99  RETURN
.
OUTROW00  REP       " 0",PVIDATE
          MOVE      SP70,AUDITDTE
          MOVE      SP70,VISTDAY
          UNPACK    PVIDATE,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
          LOAD      DAYNAM3,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
          PACK      VISTDAY,DAYNAM3,SP70
.
          MOVE      OBAOUTNO,VISITNO
          CLEAR     EXTVSTID
          CLEAR     CHKEXTVD
          PACK      CHKEXTVD,VISITNO,SP70
          PROC      CHKEID00
          MATCH     KEY20,SP70
          IF        @EQUAL
            PACK      EXTVSTID,VISITNO
          ELSE
            APPEND    VISITNO,EXTVSTID
            APPEND    SP2,EXTVSTID
            APPEND    "<span class='TextBlue'>(",EXTVSTID
            APPEND    KEY20,EXTVSTID
            APPEND    ")</span>",EXTVSTID
          ENDIF
          RJUSTIFY  EXTVSTID
          RJUSTIFY  VISITNO
.
          REP       "#"'",PDIADESC
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",EXTVSTID,"#",":
                             "#"",PVIDATE,VISTTIME,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",SP1,"#",":
                             "#"",CTYPDESC,"#",":
                             "#"",SP1,"#",":
                             "#"",DTYPDESC,"#",":         * 10
                             "#"",DESCDOCM,"#",":
                             "#"",DESCHOME,"#"," 
          MATCH     SP70,MRVSXKY1
          IF        !@EQUAL
            WRITE     HTMLFILE;"#"",VOLNDESC," +#","
          ELSE
            WRITE     HTMLFILE;"#"",VOLNDESC,"#","
          ENDIF              
          WRITE     HTMLFILE;"#"",UNITDESC,"#",":
                             "#"",VISTDAY,"#",":
                             "#"",VISTTYPE,"#",":
                             "#"",VISADIAG,"#",":
                             "#"",VISTLOC,"#",":                   * Location
                             "#"",VSTATUS,"#",":
                             "#"",OBASLOT,"#",":          * 20
                             "#"",ADIADESC," #",":
                             "#"",SP1,"#",":
                             "#"",DDIADESC,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",VOLNDESC,"#",":
                             "#"",SP1,"#",":
                             "#"",UNITCODE,"#",":
                             "#"",CLAIMCOD,"#",":
                             "#"",PRIDISCD,"#",":          * 30    * I CAR 18122
                             "#"",PDIADESC,"#",":                  * I CAR 18122
                             "#"",AUDITDTE,"#",":                  * I CAR 18122
                             "#"",SP1,"#",#"";                                  
.
          CALL      VCDM0000                * Visit based CDM
.
          WRITE     HTMLFILE;"#",":
                             "#"",VISTHOSP,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":              * 40
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":              * 50
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#")"
          RETURN
.------------------------------------------------------------
. Output Visit Table Details for MRT
.------------------------------------------------------------
MRVTAB00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,ANS,DIM127      * Visit Type Flag 
          UNPACK    DIM127,D1,KEY1,DIM127     * Admission Status Flag
          UNPACK    DIM127,D1,KEY1A,DIM127    * Coded only Flag
.
          MOVE      ZERO,VISTFLAG
          MOVE      ANS,VISTFLAG
          MOVE      ZERO,DISCFLAG
          MOVE      KEY1,DISCFLAG
          MOVE      ZERO,VISCOUNT
          MOVE      ZERO,CODDFLAG
          MOVE      KEY1A,CODDFLAG
.
          MATCH     "       0",URNUMBER
          GOTO      MRVTAB90 IF EQUAL
          PACK      KEY24,URNUMBER,Z70
          CALL      RDSVISA2
MRVTAB10  CALL      RDPVISA2
          BRANCH    OVRCD,MRVTAB90
          MATCH     URNUMBER,PVIURNO
          GOTO      MRVTAB90 IF NOT EQUAL
          ADD       ONE,VISCOUNT
          IF        VISTFLAG<>0
            COMPARE   VISTFLAG,PVITYPE      * Match For Visit Type
            GOTO      MRVTAB10 IF NOT EQUAL
          ENDIF
.
          MOVE      PVIBILL,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,MRVTAB10
.
          MOVE      PVIBILL,KEY8
          CALL      RDPMVX11
          BRANCH    OVRCD,MRVTAB10
.
.         IF        IBCNMHOS=1
.           PACK      KEY13,USERID,SP70        * All hospital access
.           CALL      RDMLSEC1
.           IF        OVRCD=1
.             PACK      KEY13,USERID,PMVXMHOS,SP70   * This hospital access
.             CALL      RDMLSEC1
.             BRANCH    OVRCD,MRVTAB10
.           ENDIF
.         ENDIF
.
          MOVE      PMVXMHOS,VISTHOSP      * Hospital code display
.
          IF        DISCFLAG<>0
            COMPARE   DISCFLAG,ASTAT       * Check Admission Status 
            GOTO      MRVTAB10 IF NOT EQUAL
          ENDIF
.
          IF        CODDFLAG<>0
            MATCH     SP70,ACODDTE
            GOTO      MRVTAB10 IF EQUAL
            GOTO      MRVTAB10 IF EOS
          ENDIF
.
MRVTAB11  CALL      GETVIS00      * Get Visit Details
.         CALL      CODSTA00      * Get Coding Status of a patient
.
          MOVE      ONE,EPSCD001         * Episode number?
          MOVE      SP70,SAVEPKEY        * Clear save episode key
          MOVE      ZERO,GENCHCDS
          IF        ASTAT = 3 & MRCNEPSC = 1
            MOVE      ONE,GENCHCDS       * set "Generate Discharge patchcof"
          ENDIF
.
          CALL      MRTCOD00             * Medical Record Coding Details
          BRANCH    EXIT,MRVTAB10
.
          COMPARE   ZERO,CODESTAT        * Do not display Coder id if not coded
          IF        @EQUAL
            MOVE      SP70,CODERNAM
          ELSE
            PACK      KEY10,PTEDUSID,SP70
            CALL      RDWBSE1
            IF        OVRCD=0
              MOVE      WBSENAM,CODERNAM
            ELSE
              PACK      KEY14,PTEDOPER,SP70
              CALL      RSWBSE3
              CALL      RKWBSE3
              IF        OVRCD=0
                MATCH     PTEDOPER,WBSEPCD
                IF        @EQUAL
                  MOVE      WBSENAM,CODERNAM
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          PACK      DESCHOME,SP70
          PACK      DESCDOCM,SP70
          MOVE      SP70,VOLNDESC
          PACK      KEY8,DPVIBILL,SP70
          CALL      RDMRVS1       * Gets the Unique key for the medical record 
          BRANCH    OVRCD,MRVTAB20

          PACK      KEY10,MRVSMKEY,SP70
          CALL      RDMRMAS2      * reads the MRT master file for associated rec
          BRANCH    OVRCD,MRVTAB20
.
          MATCH     PVIURNO,MRMAURNO  * Match U/R as might be a merged?
          IF        !@EQUAL
            MOVE      "Incomplete Merge",VOLNDESC
            GOTO      MRVTAB20 
          ENDIF
.
          MOVE      DMRMAVOL,VOLNDESC  * Set Volume
.
          MOVE      "TY",KEY2
          PACK      KEY5,KEY2,MRMADOTY
          CALL      RDCODE1
          MOVE      TDESC,DESCDOCM
          MOVE      "&nbsp;",UNITDESC
          MOVE      "AC",KEY2
          MATCH     SP3,ACLSSFT
          GOTO      MRVTAB15 IF EQUAL
.
          PACK      KEY5,KEY2,ACLSSFT
          CALL      RDCODE1
          IF        OVRCD=0
            CLEAR     DISPNAME
            PACK      NAME35,TDESC,SP70
            CALL      NAMSTR00
            APPEND    SP70,DISPNAME
            RESET     DISPNAME
            MOVE      DISPNAME,UNITDESC
            STRIP     UNITDESC
          ENDIF
.
MRVTAB15  PACK      KEY7,MRMAHHOS,MRMAHLOC,SP10                       *C-240724
          CALL      RDMRLOC1
          MOVE      MRLODESC,DESCHOME
.
MRVTAB20  CLEAR     HTMLLINK
          APPEND    "javascript:linkPatient('",HTMLLINK
          APPEND    URNUMBER,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PVIBILL,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PVITYPE,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    SECOPT,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          CALL      THBL0000        * Assign VISTLINK icon for Inpatient Visit with Bookings
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",PVIBILL,"#",":
                             "#"",PVIDATE,VISTTIME,"#",":
                             "#"",DDATE,"#",":
                             "#"",VISTDESC,"#",":
                             "#"",WARDNAME,"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",ATYPDESC,"#",":
                             "#"",CTYPDESC,"#",":
                             "#"",CODESTAT,"#",":
                             "#"",DTYPDESC,"#",":
                             "#"",DESCDOCM,"#",":
                             "#"",DESCHOME,"#",":
                             "#"",VOLNDESC,"#",":
                             "#"",UNITDESC,"#",":
                             "#"",VISTDAY,"#",":
                             "#"",VISTLINK,"#",":
                             "#"",VISADIAG,"#",":
                             "#"",VISTLOC,"#",":
                             "#"",VSTATUS,"#",":
                             "#"",SLOTNUMB,"#",":
                             "#"",ADIADESC,"#",":
                             "#"",VISTRCOD,"#",":
                             "#"",DDIADESC,"#",":
                             "#"",ACODDTE,"#",":
                             "#"",VISTHOSP,"#")"
          GOTO      MRVTAB10
.
.         Check for any bookings
.
MRVTAB90  COMPARE   ZERO,DISCFLAG
          GOTO      MRVTAB99 IF NOT EQUAL
.
          MOVE      SP70,VISTLOC
          MOVE      SP70,UNITDESC
          MOVE      SP70,DTYPDESC
          MOVE      SP70,CTYPDESC
          MOVE      SP70,VISADIAG
          MOVE      SP70,ADIADESC
          MOVE      SP70,DDIADESC
          MOVE      SP70,SLOTNUMB
          PACK      VISTTYPE,SP70
          PACK      VSTATUS,SP70
.
          PACK      KEY16,URNUMBER,SP70
          CALL      RSBKREC6
MRVTAB91  CALL      RKBKREC6
          BRANCH    OVRCD,MRVTAB98 
          MATCH     URNUMBER,BKREURNO
          GOTO      MRVTAB98 IF NOT EQUAL
          COMPARE   ZERO,BKRESTAT
          GOTO      MRVTAB91 IF NOT EQUAL
.
          MOVE      SP70,VISTDAY
          UNPACK    BKREEDAT,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
          LOAD      DAYNAM3,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
          PACK      VISTDAY,DAYNAM3,SP70
.
          MOVE      BKREEDAT,PVIDATE
          MOVE      BKREATIM,VISTTIME
.
          ADD       ONE,VISCOUNT
          MOVE      "Book",VISTTYPE
          MOVE      "Booking",VSTATUS
.
          MOVE      BKREADAT,ICDRDDTE         * Use booking date to read ICD
          MOVE      BKREPROC,VISADIAG         * Procedure
          MOVE      BKREPROC,KEY9
          CALL      RDPTICO1
          IF        OVRCD=0
            MOVE      PT0ODSC2,ADIADESC          * Procedure description
          ENDIF
.
          MOVE      BKREADOC,KEY6    
          CALL      RDDOCT1 
          IF        OVRCD=1
            MOVE      SP70,DOCFNAME
          ELSE
.           CALL      DOCNAM00                * Format Doctor Name  
            MOVE      DTITL,FMTTITLE            * I CAR 13038
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000                  * end I CAR 13038
          ENDIF
.
          PACK      DESCHOME,SP70
          PACK      DESCDOCM,SP70
          MOVE      SP70,VOLNDESC
. 
          PACK      KEY8,BKREBOOK,SP70
          CALL      RDMRVS1       * Gets the Unique key for the medical record
          BRANCH    OVRCD,MRVTAB92
. 
          PACK      KEY10,MRVSMKEY,SP70
          CALL      RDMRMAS2      * reads the MRT master file for associated rec
          BRANCH    OVRCD,MRVTAB92
. 
          MATCH     PVIURNO,MRMAURNO  * Match U/R as might be a merged?
          IF        !@EQUAL
            MOVE      "Incomplete Merge",VOLNDESC
            GOTO      MRVTAB92 
          ENDIF
. 
          MOVE      DMRMAVOL,VOLNDESC  * Set Volume
. 
          MOVE      "TY",KEY2
          PACK      KEY5,KEY2,MRMADOTY
          CALL      RDCODE1
          MOVE      TDESC,DESCDOCM
. 
          PACK      KEY7,MRMAHHOS,MRMAHLOC,SP10                       *C-240724
          CALL      RDMRLOC1
          MOVE      MRLODESC,DESCHOME
.
MRVTAB92  CLEAR     HTMLLINK
          APPEND    "javascript:linkPatient('",HTMLLINK
          APPEND    URNUMBER,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    DBKREBOO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    SEVEN,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          MOVE      "CL",CATEGORY
          MOVE      BKRECLMT,CODE
          CALL      GETCOD00
          MOVE      TDESC,CTYPDESC
.
          MOVE      "A ",CATEGORY
          MOVE      BKREATYP,CODE
          CALL      GETCOD00
          MOVE      TDESC,ATYPDESC
.
          MOVE      "AC",CATEGORY
          MOVE      BKREDEPT,CODE
          CALL      GETCOD00
          MOVE      TDESC,DTYPDESC
.
          MOVE      SP70,VISTHOSP
          PACK      KEY6,BKREWARD,SP70
          CALL      RDWARD1
          IF        OVRCD<>1
            MOVE      PTWDHOSN,VISTHOSP
          ENDIF
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",DBKREBOO,"#",":
                             "#"",BKREEDAT,VISTTIME,"#",":
                             "#"",SP1,"#",":
                             "#"",VISTDESC,"#",":
                             "#"",SP1,"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",ATYPDESC,"#",":
                             "#"",CTYPDESC,"#",":
                             "#"",ZERO,"#",":
                             "#"",DTYPDESC,"#",":
                             "#"",DESCDOCM,"#",":
                             "#"",DESCHOME,"#",":
                             "#"",VOLNDESC,"#",":
                             "#"",UNITDESC,"#",":
                             "#"",VISTDAY,"#",":
                             "#"",VISTTYPE,"#",":
                             "#"",VISADIAG,"#",":
                             "#"",SP1,"#",":
                             "#"",VSTATUS,"#",":
                             "#"",SP1,"#",":
                             "#"",ADIADESC,"#",":
                             "#"",SP1,"#",":
                             "#"",DDIADESC,"#",":
                             "#"",SP1,"#",":
                             "#"",VISTHOSP,"#")"
.
          GOTO      MRVTAB91
MRVTAB98  
MRVTAB99  RETURN
.-----------------------------------------------------------------------
.                             CODSTA00                                         
.                  Get coding status of a patient   
.           Function pulled from IBAMRT06???????                         
.-----------------------------------------------------------------------
CODSTA00  MOVE      ZERO,CODESTAT           * Initialise to 'no coding'
          PACK      KEY8,PVIBILL,SP70
          CALL      RDMRPDS1                * Check post discharge header file
          BRANCH    OVRCD,CODSTA99
.
          MOVE      SP70,TCINDC1
          PACK      KEY5,ANSC,ANSP,MRPDSTAT
          CALL      RDCODE1
.
.          MATCH     ANSP,TCINDC1            * partial coding
.          IF        @EQUAL
.            MOVE      ANSP,CODESTAT
.          ENDIF
.
          MATCH     ANSC,TCINDC1            * completed coding
          IF        @EQUAL
            MOVE      ONE,CODESTAT
          ENDIF
.
CODSTA99  RETURN
.------------------------------------------------------------
. Get Visit Details
.------------------------------------------------------------
GETVIS00  MOVE      ZERO,EXIT
          MOVE      SP1,SECOPT
          UNPACK    PVIDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      SP70,VISTDAY
          MOVE      SP70,VISTLOC
          MOVE      SP70,ACLAIM
          MOVE      SP70,DDATE
          MOVE      SP70,UNITCODE
          MOVE      SP70,UNITDESC
          MOVE      SP70,DTYPDESC
          MOVE      SP70,ATYPDESC
          MOVE      SP70,CTYPDESC
          MOVE      SP70,CLAIMCOD
          MOVE      SP70,VISADIAG
          MOVE      SP70,ADIADESC
          MOVE      SP70,DDIADESC
          MOVE      SP70,SLOTNUMB
          MOVE      SP70,WARDNAME
          MOVE      SP70,REFTDESC
          PACK      VISTTYPE,SP70
          PACK      VSTATUS,SP70
          MOVE      SP70,DISCDATE
          MOVE      SP10,VISTTIME
          MOVE      "&nbsp;",DISCDATE
          MOVE      SP70,VISTRCOD
          MOVE      ZERO,AAEVFLAG
          MOVE      SP70,EMVISITE
.
. Emergency Visit First Seen Date and Time
          MOVE      SP70,EMRVFDAT
          MOVE      SP70,EMRVFTIM
.
          MOVE      SP10,AWARD
          MOVE      SP10,ACLAIM
          MOVE      ZERO,ASTAT
.
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      ADMNDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          UNPACK    PVIDATE,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
          LOAD      DAYNAM3,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
          PACK      DOCFNAME,SP70
          RESET     DOCFNAME
          UNPACK    SP70,LSTDOCT,LSTCLIN    * work fields for Doct & Clin
          MOVE      PVIDOCT,LSTDOCT         * setup work Doctor code
          MOVE      SP70,EDDISDOC
          MOVE      SP70,EDDISDIA
.
.                            Emerg    Outpat   Inpat
          BRANCH    PVITYPE,GETVIS05,GETVIS10,GETVIS15
          MOVE      PVIDOCT,LSTDOCT         * setup work Doctor code
          GOTO      GETVIS60
.
.------------------------------------------------------------------------------
.       Emergency   
.------------------------------------------------------------------------------
.
GETVIS05  MOVE      PVIBILL,KEY8
          CALL      RDDETA1
          BRANCH    OVRCD,GETVIS60
          MOVE      ADACOMP,ACLAIM
          MOVE      ADADOCT,PVIDOCT
          MOVE      ADADIAG,ADIADESC       * Diagnosis
          MOVE      ADADATE,PVIDATE
          MOVE      ADATIME,VISTTIME
.
          MATCH     EMCNLDAT,ADADATE
          IF        @LESS
            MOVE      ONE,AAEVFLAG          * Link to AAE Enquiry page
          ENDIF
.
          CALL      RDDISA1
          IF        OVRCD=0
            MOVE      ADSDIAG,DDIADESC
            MOVE      ADSDATE,DDATE
            MOVE      ADSDATE,EMVIDATE
            MOVE      ADSTIME,EMVIDTIM
            MOVE      ADSDISC,EMVIDSTA
          ENDIF
.
          MOVE      ZERO,EMVISTAT
          BRANCH    EMRFLAG,GETVIS08
          MOVE      SP70,PTVADESC
          MOVE      PVIBILL,KEY8
          CALL      RDEMVIS1
          BRANCH    OVRCD,GETVIS08         * EMR visit not found
.
          PACK      KEY5,EMVIDEST
          CALL      RDPTVAD1
          IF        OVRCD=0
            PACK      VSTATUS,PTVADESC,SP70
          ENDIF
          MOVE      EMVIDATE,PVIDATE
          MOVE      EMVITIME,VISTTIME
          MOVE      EMVIDRDT,EMRVFDAT      * Emergency Visit First Seen Date
          MOVE      EMVIDRTM,EMRVFTIM      * Emergency Visit First Seen Time
.
          MOVE      EMVIDOCT,PVIDOCT
          MOVE      PVIDOCT,LSTDOCT        * setup work Doctor code
.
          MATCH     "1",SHOWFRMT
          IF        @EQUAL
            MOVE      THREE,EMVISTAT       * Kids ED visits(events) hard coded
          ENDIF                            * to discharged
.
          IF        EMVISTAT=2 | EMVISTAT=3
            MOVE      EMVIDDAT,DDATE
          ENDIF
.
          PACK      KEY5,ANSA,ANSA,EMVITRIG
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,VISTRCOD        * Triage Code
          ENDIF
.
          PACK      VISTLOC,SP70
          MATCH     EMVISITE,SP70
          GOTO      GETVIS08 IF EQUAL       * No EMR site code
.
          PACK      KEY3,SP70
          CALL      RSEMSIT1
          CALL      RKEMSIT1
          BRANCH    OVRCD,GETVIS08          * emrsitaf file is empty
          CALL      RKEMSIT1                * check more than 1 site exists
          BRANCH    OVRCD,GETVIS06          * No, it's a single EMR site
.
.         Multi EMR site
.
          PACK      KEY3,EMVISITE,SP70
          CALL      RDEMSIT1
          BRANCH    OVRCD,GETVIS08          * EMR site code not found
.
          PACK      VISTLOC,EMSTHSNO,DASH,EMVISITE
          PACK      KEY3,EMSTHSNO,SP70
          CALL      RDPTHSP1                * Hospital name
          IF        OVRCD=0
            PACK      VISTLOC,PTHSNAME,SP70
            STRIP     VISTLOC
            ENDSET    VISTLOC
            APPEND    DASH,VISTLOC
            APPEND    EMVISITE,VISTLOC
            APPEND    SP70,VISTLOC
            RESET     VISTLOC
          ENDIF
          COMPARE   ONE,IBCNMHOS
          IF        !@EQUAL
            PACK      VISTLOC,EMVISITE,SP70     * CAR 288134
          ENDIF
          GOTO      GETVIS08
.
.         Single EMR site
.
GETVIS06  PACK      KEY3,EMVISITE,SP70
          CALL      RDEMSIT1
          BRANCH    OVRCD,GETVIS08          * EMR site code not found

          PACK      VISTLOC,EMSTDESC,SP70   * Single Hospital
          COMPARE   ONE,IBCNMHOS            * If Multi Hosp - include Hosp name
          IF        @EQUAL
            PACK      KEY3,EMSTHSNO,SP70
            CALL      FHOS0000
            PACK      VISTLOC,HOSPTEXT,DASH,EMSTDESC,SP70
          ENDIF
          GOTO      GETVIS08
.
GETVIS08  UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          REP       " 0",CPCDATE
.
          MATCH     SP70,DDATE
          IF        !@EQUAL
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISCDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          PACK      VSTATUS,SP70
          CLEAR     VSTATUS
          IF        EMVISTAT=FOUR
            APPEND    INPSTA3B,VSTATUS
            GOTO      GETVIS60
          ELSE
            IF        EMVISTAT=2 | EMVISTAT=3 | EMVISTAT=0
              APPEND    INPSTA3A,VSTATUS
            ELSE
              APPEND    EMGSTAT1,VSTATUS
            ENDIF
          ENDIF
.
          MATCH     SP70,DDATE
          GOTO      GETVIS60 IF EQUAL
.
          MATCH     SP70,PTVADESC
          IF        !@EQUAL
            MOVE      PTVADESC,KEY10
            APPEND    KEY10,VSTATUS
          ELSE
            MATCH     SP70,EMVIDSTA
            IF        !@EQUAL
              PACK      KEY5,ANSE,ANSD,EMVIDSTA,SP70
              CALL      RDCODE1
              IF        OVRCD<>1
                MOVE      TDESC,KEY20
                APPEND    KEY20,VSTATUS
              ENDIF
            ENDIF
          ENDIF
.
          APPEND    SP1,VSTATUS
          APPEND    CPCDATE,VSTATUS
          APPEND    SP1,VSTATUS
          APPEND    EMVIDTIM,VSTATUS
          APPEND    SP70,VSTATUS
          RESET     VSTATUS
.
          MATCH     SP70,EMVIUR02
          IF        !@EQUAL
            PACK      KEY6,EMVIUR02,SP70 
          ELSE
            PACK      KEY6,EMVIDOCT,SP70 
          ENDIF
          CALL      RDDOCT1
          IF        OVRCD<>1
.           CALL      DOCNAM00           
            MOVE      DTITL,FMTTITLE         
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000              
            MOVE      DOCFNAME,EDDISDOC     * WA health ED disharge doctor
          ENDIF
.
          CALL      WADD0000                * WA health ED discharge diagnosis
.
          MOVE      SP70,DOCFNAME
          MATCH     SP70,EMVIDOCT
          GOTO      GETVIS81 IF NOT EQUAL
.
          MATCH     SP70,EMVIUR02
          GOTO      GETVIS09 IF EQUAL
.
          MOVE      EMVIUR02,EMVIDOCT
.
GETVIS81  MOVE      EMVIDOCT,KEY6           * Read the doctor's file to get name
          CALL      RDDOCT1
          IF        OVRCD=1
            CLEAR     DOCFNAME
            APPEND    "Invalid Doctor - ",DOCFNAME
            APPEND    PVIDOCT,DOCFNAME
            RESET     DOCFNAME
            GOTO      GETVIS70
          ENDIF
.                                           * format doctors name
GETVIS09  MOVE      PVIDOCT,LSTDOCT
          MATCH     SP6,EMVIDOCT
          IF        !@EQUAL
            MOVE      EMVIDOCT,LSTDOCT      * set doctor code for GETVIS60
          ENDIF
.
          MATCH     "1",SHOWFRMT            * moved from GETVIS60     *M-262001
          GOTO      GETVIS70 IF EQUAL
.
          GOTO      GETVIS60
.
.-----------------------------------------------------------------------------
.------ Outpatient - Read clinic file using PVIDOCT - contains "Clinic" or "DOC"
.-----------------------------------------------------------------------------
.
GETVIS10  CALL      COTFIL00              * Open correct outpatient files
.
          MOVE      SP6,LSTCLIN           * create phantom "LSTCLIN" for Visit
          CALL      OCLI0000              * Get Outpatient details
.
          MOVE      PVIBILL,KEY8
          CALL      RDDIAG1
          IF        OVRCD=0
            MOVE      OPDICODE,VISADIAG   * Diagnosis code
            MOVE      OPDIDESC,ADIADESC   * Diagnosis description
          ENDIF
.
          MATCH     SP6,PVIDOCT
          GOTO      GETVIS60 IF EQUAL
.
.                                         * Is PVIDOCT "Clinic" or "Doctor" ?
GETVIS11  PACK      KEY20,PVISITE,PVIDOCT,PVIDATE,SP70
          CALL      RDCLIA1
          IF        OVRCD = 1
            PACK      KEY20,PVISITE,PVIDOCT,PVIDATE,Z70
            CALL      RDSCLIA1
            CALL      RDPCLIA1
            BRANCH    OVRCD,GETVIS12      * (then PVIDOCT is not a Clinic)
.
            MATCH     PVISITE,OCASITE
            GOTO      GETVIS12 IF NOT EQUAL
.
            MATCH     PVIDOCT,OCACLIN
            GOTO      GETVIS12 IF NOT EQUAL
          ENDIF
.
          MATCH     PVIDOCT,OCACLIN
          GOTO      GETVIS12 IF NOT EQUAL * (then PVIDOCT is not a Clinic)
.
          MOVE      OCACLIN,LSTCLIN       * reposition "Clinic" and "Doctor"
          MOVE      OCADOCT,LSTDOCT       * set doctor code for GETVIS60
          MOVE      OCADESC,DOCFNAME      * default - use "Clinic Name"
.
          GOTO      GETVIS60
.
GETVIS12  UNPACK    SP70,OCADOCT,OCACLIN,OCADESC
          CLEAR     DOCFNAME              * setup default message
          APPEND    "Invalid Clinic - ",DOCFNAME
          APPEND    PVIDOCT,DOCFNAME
          RESET     DOCFNAME
.
          GOTO      GETVIS70
.
.------------------------------------------------------------------------------
.         Inpatient
.------------------------------------------------------------------------------
GETVIS15  MOVE      PVIBILL,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,GETVIS60
          LOAD      VSTATUS,ASTAT,INPSTAT1,INPSTAT2,INPSTAT3,INPSTAT4:
                                   INPSTAT5
.
          MATCH     "1",SHOWCARE
          GOTO      GETVIS16 IF NOT EQUAL
.
          IF        ASTAT=2
            CLEAR     VSTATUS
            APPEND    INPSTAT2,VSTATUS
            PACK      KEY5,ANSC,ANSC,ACARE,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              APPEND    "<BR>Care Type - ",VSTATUS
              APPEND    TDESC,VSTATUS
            ENDIF
            APPEND    SP70,VSTATUS
            RESET   VSTATUS
          ENDIF
.
GETVIS16  MOVE      AMBS,VISADIAG
          MOVE      ADIAG1,ADIADESC
          MOVE      ATIME,VISTTIME
.
          PACK      DISPCLSS,SP70
          MATCH     SP70,ACARE
          IF        !@EQUAL
            PACK      DIM1,SP20
            PACK      DISPCLSS,SP20
            PACK      KEY5,ANSC,ANSC,ACARE,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              UNPACK      TCINDC21,DIM1
            ENDIF
            MATCH     DIM1,SP70
            IF        !@EQUAL
              PACK      DISPCLSS,ONCLCLSS,DIM1,SP70
            ENDIF
            SQUEEZE   DISPCLSS
          ENDIF
.
          CALL      CHKMEH00
.
          MOVE      SP70,DDATE
          CALL      GETLTR00             * Get last transfer record
          MOVE      "AC",CATEGORY
          MOVE      TDEPT,CODE
          CALL      GETCOD00
          MOVE      TDESC,UNITDESC       * Unit Description
.
          MOVE      "A ",CATEGORY
          MOVE      TATYPE,CODE
          CALL      GETCOD00
          MOVE      TDESC,ATYPDESC
.
          MOVE      "AC",CATEGORY
          MOVE      TDEPT,CODE
          CALL      GETCOD00
          MOVE      TDESC,DTYPDESC
          MOVE      CODE,UNITCODE
.
          MOVE      PVIBILL,KEY8
          CALL      RDDSCH1
          BRANCH    OVRCD,GETVIS40
.
          UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          REP       " 0",CPCDATE
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISCDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          MOVE      DDIAG,DDIADESC         * Discharged Diagnosis
.
          MOVE      SP20,KEY20
          IF        PTCNUADT<>1
            GOTO      GETVIS30
          ENDIF
.
          MOVE      PVIBILL,KEY8
          CALL      RDPTDAD1
          BRANCH    OVRCD,GETVIS30
          MATCH     SP70,PTDADCTS
          GOTO      GETVIS30 IF EQUAL
.
          MOVE      SP20,KEY20
          MOVE      PTDADCTS,KEY5            * transfer destination
          CALL      RDPTVAD1
          IF        OVRCD=0
            MOVE      PTVADESC,KEY20     * Destination desc.
          ENDIF
          GOTO      GETVIS35
.
GETVIS30  IF        PTCNDRSM=1
            PACK      KEY5,ANSD,SP1,DSTAT,SP70
          ELSE
            PACK      KEY5,ANSD,ANSD,DDEST,SP70
          ENDIF
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,KEY20
          ENDIF
.
GETVIS35  PACK      VSTATUS,SP70
          CLEAR     VSTATUS
          APPEND    INPSTA3A,VSTATUS
          IF        PTCNDRSM=1
            APPEND    DSTAT,VSTATUS
          ELSE
            APPEND    DDEST,VSTATUS
          ENDIF
          APPEND    " - ",VSTATUS
          APPEND    SP1,VSTATUS
.
          MATCH     SP20,KEY20
          IF        !@EQUAL
            APPEND    KEY20,VSTATUS
          ENDIF
.
          APPEND    SP1,VSTATUS
          APPEND    CPCDATE,VSTATUS
          APPEND    SP1,VSTATUS
          APPEND    DTIME,VSTATUS
.
          MATCH     "1",SHOWCARE
          GOTO      GETVIS39 IF NOT EQUAL
.
          IF        ASTAT=3
            PACK      KEY5,ANSC,ANSC,ACARE,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              APPEND    "<BR>Care Type - ",VSTATUS
              APPEND    TDESC,VSTATUS
            ENDIF
          ENDIF
.
GETVIS39  APPEND    SP70,VSTATUS
          RESET     VSTATUS
.
GETVIS40  PACK      KEY6,AWARD,ABED
          PACK      KEY3,AWARD,SP70
          CALL      FWBD0000
          PACK      VISTLOC,WARDBED,SP70
          COMPARE   ONE,IBCNMHOS
          IF        @EQUAL
            PACK      KEY3,PMVXMHOS
            CALL      FHOS0000
            PACK      VISTLOC,HOSPTEXT,DASH,WARDBED,SP70
          ENDIF
          PACK      KEY6,AWARD,ABED 
          CALL      FWBD0000
          MOVE      WARDBED,WARDNAME
          STRIP     WARDNAME
.         
          GOTO      GETVIS60
.
.------------------------------------------------------------------------------
.                                 Format HCP Column                   *C-262001
.
GETVIS60  MATCH     SP6,LSTDOCT
          GOTO      GETVIS70 IF EQUAL
.
          MOVE      LSTDOCT,KEY6            * Read "patdo1af" for Doctor name
          CALL      RDDOCT1
          IF        OVRCD=1
            IF        PVITYPE = 2
              PACK      KEY10,LSTDOCT,SP10  * try "pmshcpaf" for Doctor Name
              CALL      RDPMHCP1
              BRANCH    OVRCD,GETVIS70      * leave Clinic Name in DOCFNAME
.
              MOVE      PMHCTITL,FMTTITLE
              MOVE      PMHCGNAM,FMTGNAME
              MOVE      PMHCSNAM,FMTSNAME
              CALL      DOCNM000
            ELSE
              CLEAR     DOCFNAME
              APPEND    "Invalid Doctor - ",DOCFNAME
              APPEND    LSTDOCT,DOCFNAME
              RESET     DOCFNAME
            ENDIF
          ELSE                              * Doctor Name found - format it
            MOVE      DTITL,FMTTITLE
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000
          ENDIF
.
          IF        PVITYPE = 2
            CALL      FRMD0000              * Parameter for "clinic (doc name)"
          ENDIF
.
.----------------------------------------------------------------------------
.                                 Format the rest                     *C-262001
.
GETVIS70  MOVE      "&nbsp;",VISTDESC
          MOVE      "&nbsp;",WARDNAME
          LOAD      VISTDESC,PVITYPE,VISTEMER,VISTOUTP,VISTINPT
.
          COMPARE   SIX,PVITYPE
          IF        @EQUAL
            MOVE      VISTCOMH,VISTDESC
          ENDIF
          IF        PVITYPE=3
            LOAD      VISTDESC,ASTAT,INPSTAT1,INPSTAT2,INPSTAT3,INPSTAT4:
                                     INPSTAT5
          ENDIF
.
          MOVE      "CL",CATEGORY
          MOVE      ACLAIM,CODE
          CALL      GETCOD00
          MOVE      TDESC,CTYPDESC       * Insurance Class
          MOVE      ACODE,CLAIMCOD
.
          PACK      KEY6,AWARD,SP70

          CALL      RDWARD1
          IF        OVRCD=0
            CLEAR     WARDNAME
            APPEND    WBDESC,WARDNAME
            MATCH     SP3,ABED
            IF        !@EQUAL
              APPEND    SLASH,WARDNAME
              APPEND    ABED,WARDNAME
            ENDIF
            RESET     WARDNAME
            STRIP     WARDNAME
          ENDIF
.
          LOAD      VISTTYPE,PVITYPE,VISTEMER,VISTOUTP,VISTINPT
          COMPARE   SIX,PVITYPE
          IF        @EQUAL
            MOVE      VISTCOMH,VISTTYPE
          ENDIF
.
          UNPACK    PVIDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          REP       " 0",CPCDATE
          PACK      VISTDAY,DAYNAM3,SP70
.
GETVIS99  RETURN
.
.------------------------------------------------------------
. Wahealth ED discharge diaganosis ED full and lite
.------------------------------------------------------------
WADD0000  MOVE      EMVITXT2,EDDISDIA       * WA health ED discharge diagnosis
          MOVE      EMVIDATE,ICDRDDTE
          PACK      KEY9,PMVXPICD,SP70       * Validate ICD10
          CALL      RDPTICD1
          IF        OVRCD<>1
            MOVE      PT0DDSC2,EDDISDIA
          ENDIF
.
          PACK      KEY14,EMVIADMN,SP70
          CALL      RSEMVCD1
WADD1000  CALL      RKEMVCD1
          BRANCH    OVRCD,WADD9999
.
          MATCH     DEMVIADM,EMVCVIST
          GOTO      WADD9999 IF NOT EQUAL
.
          COMPARE   EMVCCSYS,ONE
          GOTO      WADD2000 IF EQUAL
.
          COMPARE   EMVCCSYS,FIVE
          GOTO      WADD1000 IF NOT EQUAL
.
WADD2000  MATCH     "000",EMVCSEQU
          GOTO      WADD1000 IF NOT EQUAL
.
          MOVE      EMVIDATE,ICDRDDTE
          CALL      LOKCOD00
.
          MATCH     SP70,EMVCFTXT
          IF        @EQUAL
            MOVE      CODEDESC,EDDISDIA       * diagnosis
          ELSE
            MOVE      EMVCFTXT,EDDISDIA       * Free format diagnosis
          ENDIF
.
WADD9999  RETURN
.
.
.------------------------------------------------------------
.  Lookup Code to get description
.------------------------------------------------------------
LOKCOD00  PACK      CODEDESC,SP70
          BRANCH    EMVCCSYS,LOKCOD10,LOKCOD99,LOKCOD99,LOKCOD99,LOKCOD50
.
.   User Defined
.
          GOTO      LOKCOD99
.
LOKCOD10  PACK      KEY9,EMVCMNCD,SP70
          CALL      RDPTICD1
          IF        OVRCD=1
            MOVE      "Invalid Diagnosis Code ",CODEDESC
            GOTO      LOKCOD99
          ENDIF
.
          MOVE      DDESC,CODEDESC
          GOTO      LOKCOD99
.
LOKCOD50  PACK      KEY9,EMVCMNCD,SP70
          CALL      RDEMICD1
          IF        OVRCD=1
            MOVE      "Invalid Emergency Diagnosis Code",CODEDESC
            GOTO      LOKCOD99
          ENDIF
.
          MOVE      EMICDESC,CODEDESC
          GOTO      LOKCOD99
.
LOKCOD99  RETURN
.
.------------------------------------------------------------
.         Check for Mental Health visit
.------------------------------------------------------------
CHKMEH00  MOVE      ZERO,EXIT
          COMPARE   ONE,MHCNUSE
          GOTO      CHKMEH99 IF NOT EQUAL
.
          COMPARE   ZERO,MHCNDVIS
          GOTO      CHKMEH99 IF EQUAL
.
          PACK      KEY8,PVIBILL,SP70
          CALL      RDMHVIS1
          BRANCH    OVRCD,CHKMEH99
.
          PACK      KEY18,USERID,MEH01,SP70
          CALL      RDWBST1
          BRANCH    OVRCD,CHKMEH98
.
          COMPARE   MHCNDVIS,WBSTLEV
          GOTO      CHKMEH98 IF LESS
.
          PACK      KEY35,ANSM,ANSH,SP1,VSTATUS
          PACK      VSTATUS,KEY35,SP70
          GOTO      CHKMEH99
.
CHKMEH98  MOVE      ONE,EXIT
.
CHKMEH99  RETURN
+
.------------------------------------------------------------
.         Check for Allied Health
.------------------------------------------------------------
CKAL0000  MOVE      ZERO,EXIT
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      SP70,WBSEDALL
          ENDIF
.
          MOVE      ZERO,EVNTFLAG
          COMPARE   "9",PVITYPE
          GOTO      CKAL9999 IF NOT EQUAL
          MATCH     " 1",PVISYST
          GOTO      CKAL1000 IF NOT EQUAL
.
. Event Type Visit
.------------------
.          PACK      VISTTYPE,VISTEVNT,SP10  * Event
          PACK      VISTTYPE,PMEVEVNT,SP10  * Event
          PACK      KEY8,PVIBILL,SP70
          CALL      RDPMEVT1
          BRANCH    OVRCD,CKAL9999
          MOVE      TWO,SECOPT
          MOVE      PMEVATIM,VISTTIME 
.
          MOVE      "EV",CATEGORY
          MOVE      PMEVEVNT,CODE
          CALL      GETCOD00
.
          MOVE      ZERO,EVNTFLAG
          MATCH     "E",TCINDC1
          IF        @EQUAL
            MOVE      EMEVENT,VISTTYPE
            MOVE      "1",EVNTFLAG         * Emergency event
          ELSE
            MATCH     "O",TCINDC1
            IF        @EQUAL
              MOVE      "2",EVNTFLAG       * Outpatient event
            ELSE
              MATCH     "I",TCINDC1
              IF        @EQUAL
                MOVE      "3",EVNTFLAG     * Inpatient event
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     "O",TCINDC1
          IF        !@EQUAL
            MOVE      "AC",CATEGORY
            MOVE      PMEVUNIT,CODE
            CALL      GETCOD00
            MOVE      PMEVUNIT,UNITCODE
            MOVE      TDESC,UNITDESC
          ENDIF
.
          PACK      VISTTYPE,PMEVEVNT,SP70
.         MATCH     "I",TCINDC1
.         IF        @EQUAL
.           MOVE      IPEVENT,VISTTYPE
.         ENDIF
.
          MATCH     "O",TCINDC1
          IF        @EQUAL
.           MOVE      OPEVENT,VISTTYPE
            MOVE      "AC",CATEGORY
            MOVE      PMEVUNIT,CODE
            CALL      GETCOD00
            MOVE      TDESC,DTYPDESC
....         MOVE      TDESC,UNITDESC      * Display clinic type for outpatients
            MOVE      PMEVCTYP,UNITCODE
            PACK      VISTLOC,PMEVPLOC,SP70
            COMPARE   ONE,IBCNMHOS
            IF        @EQUAL
              PACK      KEY3,PMVXMHOS
              CALL      FHOS0000
              PACK      VISTLOC,HOSPTEXT,DASH,PMEVPLOC,SP70
            ENDIF
          ENDIF
          MOVE      "CL",CATEGORY
          MOVE      PMEVCCOD,CODE
          CALL      GETCOD00
          MOVE      TDESC,CTYPDESC
          MOVE      ACODE,CLAIMCOD
.
          MOVE      SP70,DOCFNAME
          MATCH     SP70,PMEVACON
          GOTO      CKAL0500 IF EQUAL
.
          PACK      KEY10,PMEVACON,SP70
          CALL      RDPMHCP1
          IF        OVRCD=1
            MOVE      "Invalid HCP - ",DOCFNAME
            ENDSET    DOCFNAME
            APPEND    PMEVACON,DOCFNAME
            RESET     DOCFNAME
          ELSE
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
          ENDIF
.
CKAL0500  MATCH     SP70,PMEVCLID
          GOTO      CKAL9999 IF EQUAL
.
          PACK      KEY20,PMEVSITE,PMEVCLID,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          BRANCH    OVRCD,CKAL9999
.
          MATCH     PMEVSITE,OCASITE
          GOTO      CKAL9999 IF NOT EQUAL
.
          MATCH     PMEVCLID,OCACLIN
          GOTO      CKAL9999 IF NOT EQUAL
.
          MOVE      OCADESC,DOCFNAME     * If no Doctor Use Clinic Name
          MATCH     SP6,OCADOCT
          GOTO      CKAL9999 IF EQUAL
          MOVE      OCADOCT,OBADOCT      * Use the doctor's code from the clinic
          GOTO      CKAL9999
.
CKAL1000  MATCH    " 2",PVISYST
          GOTO     CKAL9999 IF NOT EQUAL
.
. Allied Heath Type Visit
.-------------------------
          PACK     VISTTYPE,VISTALLH,SP10      * Allied Health
          MOVE     PVIBILL,KEY8
          CALL     RDALREF1              *TO GET DEPT OF THE REFERRAL TABLE
          BRANCH   OVRCD,CKAL9999
.
          CALL     INDHCP00
.
          MATCH     SP70,FILTDEPT              * Department Filter
          IF        !@EQUAL
            MATCH     ALREDEPT,FILTDEPT
            GOTO      CKAL9000 IF NOT EQUAL
          ENDIF
.
          MOVE      "CL",CATEGORY
          MOVE      ALRECOMP,CODE
          CALL      GETCOD00
          MOVE      TDESC,CTYPDESC
          MOVE      ACODE,CLAIMCOD
.
          PACK     KEY3,ALREDEPT,SP70
          CALL     RDALDEP1
          BRANCH   OVRCD,CKAL9000
          MOVE     ALDESECU,SECOPT
.
          MOVE      SP70,REFTDESC
          MATCH     "1",ALREUYN4
          IF        @EQUAL
            MOVE      ALCNMDES,REFTDESC     * SACS referral
          ENDIF
.
          PACK      KEY16,ALREVISN,SP70
          CALL      RSALRLN2
          CALL      RKALRLN2
          BRANCH    OVRCD,CKAL5000
.
          MATCH     ALREVISN,ALRLLNKV       * Linked referrals
          GOTO      CKAL5000 IF NOT EQUAL
.
          APPEND    "Linked",REFTDESC
          GOTO      CKAL5000
.
CKAL5000  MOVE     SP70,ALENLINK           * Used to display linked mr volume
.
          MATCH    "2",ALDESECU
          IF       @EQUAL
            MATCH    WBSEDALL,ALREDEPT     * Check department
            GOTO     CKAL9000 IF NOT EQUAL * don't display
            REP      "20",SECOPT
          ENDIF
.
          MOVE     ALLSTAT0,VSTATUS
          MOVE     ZERO,FORM1
          MOVE     ALRESTAT,FORM1
          LOAD     VSTATUS,FORM1,ALLSTAT1,ALLSTAT2,ALLSTAT3,ALLSTAT4:
                                 ALLSTAT5
.
          PACK     KEY16,PVIBILL,Z70
          CALL     RSALENC1
          CALL     RPALENC1
          IF       OVRCD=0
            MATCH    DPVIBILL,ALENVISN   * Same visit number ?
            IF       @EQUAL
              MATCH    SP8,ALENSDAT
              IF       !@EQUAL
                UNPACK   ALENSDAT,CCENT,CYEAR,CMON,CDAY
                CALL     PACDATE
                REP      " 0",CPCDATE
                ENDSET   VSTATUS
                APPEND   "(Last Enc.",VSTATUS
                APPEND   CPDATE,VSTATUS
                APPEND   ")",VSTATUS
                RESET    VSTATUS
              ENDIF
            ELSE
              MOVE     SP70,ALENLINK         * Used to display linked mr volume
            ENDIF
          ENDIF
.
          MOVE      ALREDEPT,UNITCODE            * To get department  
          MOVE      ALREDEPT,CODE
          MOVE      "CG",CATEGORY
          CALL      GETCOD00
          MOVE      TDESC,UNITDESC
.
          CALL      ADDHCP00
.
          PACK      KEY10,ALREHCP,SP70          * To get service provider name
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
          ELSE
            MOVE      "&nbsp;",DOCFNAME
          ENDIF
.
          COMPARE   ONE,IBCNMHOS
          IF        @EQUAL
            PACK      KEY3,PMVXMHOS
            CALL      FHOS0000
            PACK      VISTLOC,HOSPTEXT,SP70
          ENDIF
.
          GOTO      CKAL9999
.
CKAL9000  MOVE      ONE,EXIT
CKAL9999  RETURN
.------------------------------------------------------------
. Get Outpatient details
.------------------------------------------------------------
OCLI0000  PACK      KEY36,PVIURNO,PVIDATE,SP70
          CALL      RDSBOKA3
OCLI1000  CALL      RDKBOKA3
          BRANCH    OVRCD,OCLI9999
          MOVE      PVIURNO,KEY8
          MATCH     OBAURNO,KEY8         * Check if same U/R
          GOTO      OCLI9999 IF NOT EQUAL
.
          MATCH     OBADATE,PVIDATE
          GOTO      OCLI9999 IF NOT EQUAL
.
          MATCH     OBAOUTNO,PVIBILL     * Check if same Admission
          GOTO      OCLI1000 IF NOT EQUAL
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          IF        OVRCD=0
            MOVE      "AC",CATEGORY
            MOVE      OTBBDEPT,CODE
            CALL      GETCOD00
            MOVE      TDESC,DTYPDESC
            MOVE      TDESC,UNITDESC
            MOVE      CODE,UNITCODE
          ENDIF
.
          MOVE      OBATIME,VISTTIME
          MOVE      OBASLOT,SLOTNUMB
          MOVE      OBACOMP,ACLAIM
          IF        OBASTAT=4
            MOVE      "Attended",VSTATUS
          ENDIF
          PACK      KEY18,OBASITE,OBACLIN,OBADAY,OBASTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,OCLI9999
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,OCLI9999
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,OCLI9999
.
          PACK      VISTLOC,OTHELTYP,SP70
.
          MOVE      "CT",CATEGORY
          MOVE      OTHELTYP,CODE
          CALL      GETCOD00
          MATCH     SP70,TDESC
          IF        !@EQUAL
            PACK      VISTLOC,TDESC,SP70         * CAR 288134
          ENDIF
.
          COMPARE   ONE,IBCNMHOS
          IF        @EQUAL
            PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
            CALL      RDMASA1
            IF        OVRCD<>1
              PACK      KEY3,OTHEHOSP
              CALL      FHOS0000
              PACK      VISTLOC,HOSPTEXT,DASH,OTHELTYP,SP70
            ENDIF
.
            MOVE      "CT",CATEGORY
            MOVE      OTHELTYP,CODE
            CALL      GETCOD00
            MATCH     SP70,TDESC
            IF        !@EQUAL
              PACK      VISTLOC,HOSPTEXT,DASH,TDESC,SP70
            ENDIF
.
          ENDIF
.
          PACK      KEY12,OTHESITE,OTHECTYP,SP70
          CALL      RDCTYA1
          IF        OVRCD = 1
            UNPACK    SP70,OCTSITE,OCTCTYP,OCTGRP,OCTDESC,OCTXBOK,OCTXATT
            UNPACK    SP70,OCTBKT,OCTATT,OCTACT,OCTVACS
          ENDIF
.
          MOVE      OTHECTYP,UNITCODE
.
          MATCH     SP70,UNITDESC
          IF        @EQUAL
            MOVE      OCTDESC,UNITDESC 
          ENDIF
.
OCLI9999  RETURN
+
.------------------------------------------------------------
. Get Last Transfer Record
.------------------------------------------------------------
GETLTR00  PACK      KEY30,PVIBILL,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,GETLTR10
          MATCH     PVIBILL,TADMN
          GOTO      GETLTR10 IF NOT EQUAL
          MOVE      TADOCT,PVIDOCT          * Clinician
.
          MATCH     "D",TMOVE
          GOTO      GETLTR99 IF NOT EQUAL
.
          MOVE      TWARD,AWARD
          MOVE      TBED,ABED
          PACK      KEY6,TWARD,SP70
          CALL      FWBD0000
          PACK      VISTLOC,WARDBED,SP70
          COMPARE   ONE,IBCNMHOS
          IF        @EQUAL
            PACK      KEY3,PMVXMHOS
            CALL      FHOS00000
            PACK      VISTLOC,HOSPTEXT,DASH,WARDBED,SP70
          ENDIF
          GOTO      GETLTR99
.
GETLTR10  MOVE      ADOCTA,PVIDOCT
          MOVE      ACLSSFT,TDEPT
          MOVE      ATYPE,TATYPE
.
GETLTR99  RETURN
.------------------------------------------------------------
. Output Bed Transfer Table Details
.------------------------------------------------------------
TRNTAB00  UNPACK    DIM127,D1,ANS,DIM127
          MOVE      ZERO,PUBLFLAG
          MOVE      ANS,PUBLFLAG
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          MOVE      "CC",KEY2
          PACK      KEY5,KEY2,ACARE,SP70
          CALL      RDCODE1
          MOVE      TDESC,CODDESC
          MOVE      SP70,LASTWBED
          MOVE      SP70,LASTDOCT
          MOVE      SP70,LASTTYPE
          PACK      KEY30,ADMISSNO,SP70
          CALL      RDSTRAN2
TRNTAB10  CALL      RDKTRAN2
          BRANCH    OVRCD,TRNTAB20
          MATCH     ADMISSNO,DTADMN  
          GOTO      TRNTAB20 IF NOT EQUAL
          CALL      GETTRN00
          CALL      GETCAR00              * get care type
.
          PACK      HTMLLINK,SP70,SP70
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",TDATE,TTIME,"#",":
                             "#"",WARDNAME,"#",":
                             "#"",TBED,"#",":
                             "#"",WARDBED,"#",":
                             "#"",TRATEF,"#",":            * 5
                             "#"",ATYPDESC,"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",CODDESC,"#",":
                             "#"",MOVEDESC,"#",":
                             "#"",UNITDESC,"#",":          * 10
                             "#"",BEDTDESC,"#",":
                             "#"",DIM20,"#",":
                             "#"",TEAMDESC,"#",":
                             "#"",REGIDESC,"#",":
                             "#"",RESIDESC,"#",":          * 15
                             "#"",CRUPUSER,"#",":
                             "#"",DISPUSER,"#",":
                             "#"",CASTDESC,"#")"
          GOTO      TRNTAB10
.
TRNTAB20  PACK      KEY24,ADMISSNO,SP70
          CALL      RDSCHCO1
TRNTAB30  CALL      RDKCHCO1
          BRANCH    OVRCD,TRNTAB99
          MATCH     ADMISSNO,DCHADMN  
          GOTO      TRNTAB99 IF NOT EQUAL
          PACK      KEY5,CHCATG,SP70
          CALL      RDCODE1
          MOVE      CHDATE,SAVDATE
          MOVE      CHTIME,SAVTIME
.
          PACK      KEY30,DCHADMN,CHDATE,CHTIME,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          MATCH     TADMN,CHADMN
          IF        @EQUAL
            CALL      GETTRN00
          ENDIF
.
.>>>>     CLEAR     MOVEDESC
.>>>>     APPEND    "Change",MOVEDESC
.>>>>     APPEND    SP70,MOVEDESC
.>>>>     RESET     MOVEDESC
.
          CLEAR     MOVEDESC
          APPEND    "CareType Change",MOVEDESC
          APPEND    SP70,MOVEDESC
          RESET     MOVEDESC
.
          PACK      SAVKEY24,CHADMN,CHDATE,CHTIME,SP70
          CALL      RDKCHCO1                * check if this is the last record
          BRANCH    OVRCD,TRNTAB40
          MATCH     ADMISSNO,DCHADMN
          GOTO      TRNTAB40 IF NOT EQUAL
.
          PACK      KEY5,CHCATG,CHCODE,SP70
          CALL      RDCODE1
          MOVE      TDESC,CODDESC
.
          MOVE      SAVKEY24,KEY24
          CALL      RDCHCO1                 * if not, re-read previous record
          BRANCH    OVRCD,TRNTAB30
.
          GOTO      TRNTAB50
.
TRNTAB40  PACK      KEY5,ANSC,ANSC,ACARE
          CALL      RDCODE1
          MOVE      TDESC,CODDESC
.
TRNTAB50  PACK      HTMLLINK,SP70,SP70
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",SAVDATE,SAVTIME,"#",":
                             "#"",WARDNAME,"#",":
                             "#"",TBED,"#",":
                             "#"",WARDBED,"#",":
                             "#"",TRATEF,"#",":
                             "#"",ATYPDESC,"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",CODDESC,"#",":
                             "#"",MOVEDESC,"#",":
                             "#"",UNITDESC,"#",":          * 10
                             "#"",BEDTDESC,"#",":
                             "#"",DIM20,"#",":
                             "#"",TEAMDESC,"#",":
                             "#"",REGIDESC,"#",":
                             "#"",RESIDESC,"#",":
                             "#"",DISPUSER,"#")"
          GOTO      TRNTAB30
.
TRNTAB99  RETURN
+
.------------------------------------------------------------
. Supervisor Bed Transfer Table Details
.------------------------------------------------------------
TRNSUP00  UNPACK    DIM127,D1,ANS,DIM127
          MOVE      ZERO,PUBLFLAG
          MOVE      ANS,PUBLFLAG
          MOVE      ZERO,RECCNT
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          MOVE      "CC",KEY2
          PACK      KEY5,KEY2,ACARE,SP70
          CALL      RDCODE1
          MOVE      TDESC,CODDESC
          MOVE      SP70,LASTWBED
          MOVE      SP70,LASTDOCT
          MOVE      SP70,LASTTYPE
.
          COMPARE   FIVE,TRNSUPTY           * display care type changes only
          GOTO      TRNSUP20 IF EQUAL
.
          PACK      KEY30,ADMISSNO,Z70
          CALL      RDSTRAN2
TRNSUP10  CALL      RDPTRAN2
          BRANCH    OVRCD,TRNSUP99
          MATCH     ADMISSNO,DTADMN
          GOTO      TRNSUP99 IF NOT EQUAL
          CALL      GETTRN00
          CALL      GETCAR00              * get care type
.
          ADD       ONE,RECCNT
          MOVE      RECCNT,DRECCNT
          REP       " 0",DRECCNT
          PACK      BEDTRKEY,TADMN,TDATE,TTIME,TWARD,TBED
          MOVE      ZERO,F1
          MATCH     ANSD,TMOVE
          IF        @EQUAL
            MOVE      ONE,F1                * show checkbox for discharges
          ENDIF
.
          CLEAR     HTMLLINK
          MATCH     ANSA,TMOVE
          IF        @EQUAL
            APPEND    "javascript:DispAdmError()",HTMLLINK
            GOTO      TRNSUP15
          ENDIF
.
          MATCH     ANSD,TMOVE
          IF        @EQUAL
            APPEND    "javascript:DispDscError()",HTMLLINK
            GOTO      TRNSUP15
          ENDIF
.
          APPEND    "javascript:ChangeTranDateTime('",HTMLLINK
          APPEND    BEDTRKEY,HTMLLINK
          APPEND    "')",HTMLLINK
.
TRNSUP15  RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",": * 0
                             "#"",TDATE,TTIME,"#",":       * 1
                             "#"",WARDNAME,"#",":          * 2
                             "#"",TBED,"#",":              * 3
                             "#"";
          IF        TRNSUPTY=1
            IF        RECCNT<>1 | F1=1
            WRITE     HTMLFILE;"<input type=checkbox name=uptrn",DRECCNT:
                      " onClick=UpdateArray(this.value); value='",BEDTRKEY,"'>";
            ENDIF
          ENDIF
          WRITE     HTMLFILE;WARDBED;                      * 4
          WRITE     HTMLFILE;"#",":
                             "#"",TRATEF,"#",":            * 5
                             "#"";
          IF        TRNSUPTY=3
            IF        RECCNT<>1 | F1=1
            WRITE     HTMLFILE;"<input type=checkbox name=uptrn",DRECCNT:
                      " onClick=UpdateArray(this.value); value='",BEDTRKEY,"'>";
            ENDIF
          ENDIF
          WRITE     HTMLFILE;ATYPDESC;                     * 6
          WRITE     HTMLFILE;"#",":
                             "#"";
          IF        TRNSUPTY=4
            IF        RECCNT<>1 | F1=1
            WRITE     HTMLFILE;"<input type=checkbox name=uptrn",DRECCNT:
                      " onClick=UpdateArray(this.value); value='",BEDTRKEY,"'>";
            ENDIF
          ENDIF
          WRITE     HTMLFILE;DOCFNAME;                     * 7
          WRITE     HTMLFILE;"#",";
          WRITE     HTMLFILE;"#"";
          IF        TRNSUPTY=5
            IF        RECCNT<>1 | F1=1
            WRITE     HTMLFILE;"<input type=checkbox name=uptrn",DRECCNT:
                      " onClick=UpdateArray(this.value); value='",BEDTRKEY,"'>";
            ENDIF
          ENDIF
          STRIP     CODDESC
          WRITE     HTMLFILE;*+,CODDESC;                   * 8
          WRITE     HTMLFILE;"#",":
                             "#"",MOVEDESC,"#",":          * 9
                             "#"",UNITDESC,"#",":          * 10
                             "#"";
          IF        TRNSUPTY=6
            IF        RECCNT<>1 | F1=1
            WRITE     HTMLFILE;"<input type=checkbox name=uptrn",DRECCNT:
                      " onClick=UpdateArray(this.value); value='",BEDTRKEY,"'>";
            ENDIF
          ENDIF
          WRITE     HTMLFILE;BEDTDESC;                     * 11
          WRITE     HTMLFILE;"#",":
                             "#"";
          IF        TRNSUPTY=2
            IF        RECCNT<>1 | F1=1
              IF        F1=1
                WRITE     HTMLFILE;"<input type=checkbox name=uptrn",DRECCNT:
                          " onClick=showFundingSrc(this.checked);":
                          "UpdateArray(this.value);":
                          " value='",BEDTRKEY,"'>";
              ELSE
                WRITE     HTMLFILE;"<input type=checkbox name=uptrn",DRECCNT:
                          " onClick=UpdateArray(this.value);":
                          " value='",BEDTRKEY,"'>";
              ENDIF
            ENDIF
          ENDIF
          WRITE     HTMLFILE;PTTRCLTY;                     * 12
          WRITE     HTMLFILE;"#",":
                             "#"",TEAMDESC,"#",":          * 13
                             "#"";
          IF        TRNSUPTY=8
            IF        RECCNT<>1 | F1=1
            WRITE     HTMLFILE;"<input type=checkbox name=uptrn",DRECCNT:
                      " onClick=UpdateArray(this.value); value='",BEDTRKEY,"'>";
            ENDIF
          ENDIF
          WRITE     HTMLFILE;REGIDESC;                     * 14
          WRITE     HTMLFILE;"#",":
                             "#"";
          IF        TRNSUPTY=9
            IF        RECCNT<>1 | F1=1
            WRITE     HTMLFILE;"<input type=checkbox name=uptrn",DRECCNT:
                      " onClick=UpdateArray(this.value); value='",BEDTRKEY,"'>";
            ENDIF
          ENDIF
          WRITE     HTMLFILE;RESIDESC;                     * 15
          WRITE     HTMLFILE;"#",":
                             "#"",DISPUSER,"#")"
          GOTO      TRNSUP10
.
TRNSUP20  MOVE      ZERO,RECCNT             * first display admission record
          PACK      KEY30,ADMISSNO,SP70
          CALL      RDSTRAN2
          CALL      RDKTRAN2
          BRANCH    OVRCD,TRNSUP99
          MATCH     ADMISSNO,DTADMN
          GOTO      TRNSUP99 IF NOT EQUAL
          CALL      GETTRN00
          CALL      GETCAR00              * get care type for admission
          ADD       ONE,RECCNT
          MOVE      RECCNT,DRECCNT
          REP       " 0",DRECCNT
          PACK      BEDTRKEY,TADMN,TDATE,TTIME,TWARD,TBED
.
          UNPACK    BEDTRKEY,DIM24,D6
          MOVE      "ADMISS",D6                  * admission care type
          PACK      BEDTRKEY,DIM24,D6,SP70
.
          MOVE      TDATE,SAVDATE
          MOVE      TTIME,SAVTIME
          PACK      KEY24,ADMISSNO,SP70
          CALL      RDSCHCO1
          GOTO      TRNSUP35
.
TRNSUP25  PACK      KEY24,ADMISSNO,SP70
          CALL      RDSCHCO1
TRNSUP30  CALL      RDKCHCO1
          BRANCH    OVRCD,TRNSUP99
          MATCH     ADMISSNO,DCHADMN
          GOTO      TRNSUP99 IF NOT EQUAL
          PACK      KEY5,CHCATG,SP70
          CALL      RDCODE1
          MOVE      CHDATE,SAVDATE
          MOVE      CHTIME,SAVTIME
.
          ADD       ONE,RECCNT
          MOVE      RECCNT,DRECCNT
          REP       " 0",DRECCNT
          MOVE      SP6,D6
          PACK      BEDTRKEY,DCHADMN,CHDATE,CHTIME,SP70
.
          PACK      KEY30,DCHADMN,CHDATE,CHTIME,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          MATCH     TADMN,CHADMN
          IF        @EQUAL
            CALL      GETTRN00
          ENDIF
.
          CLEAR     MOVEDESC
          APPEND    "CareType Change",MOVEDESC
          APPEND    SP70,MOVEDESC
          RESET     MOVEDESC
.
          MOVE      SP70,CODDESC
.
TRNSUP35  PACK      SAVKEY24,CHADMN,CHDATE,CHTIME,SP70
          CALL      RDKCHCO1                * check if this is the last record
          BRANCH    OVRCD,TRNSUP40
          MATCH     ADMISSNO,DCHADMN
          GOTO      TRNSUP40 IF NOT EQUAL
.
          PACK      KEY5,CHCATG,CHCODE,SP70
          CALL      RDCODE1
          MOVE      TDESC,CODDESC           * display care type change TO
.
          MOVE      SAVKEY24,KEY24
          CALL      RDCHCO1                 * if not, re-read previous record
          BRANCH    OVRCD,TRNSUP30
.
          MATCH     "ADMISS",D6
          IF        @EQUAL
            PACK      KEY5,CHCATG,CHCODE,SP70
            CALL      RDCODE1
            MOVE      TDESC,CODDESC         * display first care type change TO
          ENDIF
.
          MATCH     SP70,CHCODE
          GOTO      TRNSUP50 IF EQUAL
          GOTO      TRNSUP50 IF EOS
.
          GOTO      TRNSUP50
.
TRNSUP40  MOVE      SP70,CODDESC
          MATCH     SP70,ACARE
          GOTO      TRNSUP50 IF EQUAL
          GOTO      TRNSUP50 IF EOS
.
          PACK      KEY5,ANSC,ANSC,ACARE,SP70
          CALL      RDCODE1
          MOVE      TDESC,CODDESC
.
          UNPACK    BEDTRKEY,DIM24,D6
          MOVE      "CURRNT",D6
          PACK      BEDTRKEY,DIM24,D6,SP70
.
TRNSUP50  CLEAR     HTMLLINK
          MATCH     "ADMISS",D6
          IF        @EQUAL
            APPEND    "javascript:DispAdmError()",HTMLLINK
            GOTO      TRNSUP55
          ENDIF
.
          APPEND    "javascript:ChangeCareDateTime('",HTMLLINK
          APPEND    BEDTRKEY,HTMLLINK
          APPEND    "')",HTMLLINK
.
TRNSUP55  RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",SAVDATE,SAVTIME,"#",":
                             "#"",WARDNAME,"#",":
                             "#"",TBED,"#",":
                             "#"",WARDBED,"#",":
                             "#"",TRATEF,"#",":
                             "#"",ATYPDESC,"#",":
                             "#"",DOCFNAME,"#",";
          WRITE     HTMLFILE;"#"";
          IF        TRNSUPTY=5
.davvy      IF        RECCNT<>1 | F1=1
            WRITE     HTMLFILE;"<input type=checkbox name=uptrn",DRECCNT:
                      " onClick=UpdateArray(this.value); value='",BEDTRKEY,"'>";
.davvy      ENDIF
          ENDIF
          STRIP     CODDESC
          WRITE     HTMLFILE;*+,CODDESC; 
          WRITE     HTMLFILE;"#",":
                             "#"",MOVEDESC,"#",":
                             "#"",UNITDESC,"#",":          * 10
                             "#"",BEDTDESC,"#",":
                             "#"",PTTRCLTY,"#",":
                             "#"",TEAMDESC,"#",":
                             "#"",REGIDESC,"#",":
                             "#"",RESIDESC,"#",":
                             "#"",DISPUSER,"#")"
          IF        RECCNT=1
            GOTO      TRNSUP25
          ELSE
            GOTO      TRNSUP30
          ENDIF
.
TRNSUP99  RETURN
+
.------------------------------------------------------------
. Supervisor Insert Bed Movement Table Details
.------------------------------------------------------------
TRNINS00  MOVE      ZERO,RECCNT
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          MOVE      "CC",KEY2
          PACK      KEY5,KEY2,ACARE,SP70
          CALL      RDCODE1
          MOVE      TDESC,CODDESC
          MOVE      SP70,LASTWBED
          MOVE      SP70,LASTDOCT
          MOVE      SP70,LASTTYPE
.
          PACK      KEY30,ADMISSNO,Z70
          CALL      RDSTRAN2
TRNINS10  CALL      RDPTRAN2
          BRANCH    OVRCD,TRNINS99
          MATCH     ADMISSNO,DTADMN
          GOTO      TRNINS99 IF NOT EQUAL
          CALL      GETTRN00
          CALL      GETCAR00              * get care type
.
          ADD       ONE,RECCNT
          MOVE      RECCNT,DRECCNT
          REP       " 0",DRECCNT
          PACK      BEDTRKEY,TADMN,TDATE,TTIME,TWARD,TBED
          MOVE      ZERO,F1
          MATCH     ANSD,TMOVE
          IF        @EQUAL
            MOVE      ONE,F1                * show checkbox for discharges
          ENDIF
.
          CLEAR     HTMLLINK
.
TRNINS15  RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"","","#",": * 0
                             "#"",TDATE,TTIME,"#",":       * 1
                             "#"",WARDNAME,"#",":          * 2
                             "#"",TBED,"#",":              * 3
                             "#"";
.
.          IF        RECCNT<>1 | F1=1
.            WRITE     HTMLFILE;"<input type=checkbox name=uptrn",DRECCNT:
.                      " onClick=UpdateArray(this.value); value='",BEDTRKEY,"'>";
.          ENDIF
.
          WRITE     HTMLFILE;WARDBED;                      * 4
          WRITE     HTMLFILE;"#",":
                             "#"",TRATEF,"#",":            * 5
                             "#"";
.
          WRITE     HTMLFILE;ATYPDESC;                     * 6
          WRITE     HTMLFILE;"#",":
                             "#"";
.
          WRITE     HTMLFILE;DOCFNAME;                     * 7
          WRITE     HTMLFILE;"#",";
          WRITE     HTMLFILE;"#"";
.
          STRIP     CODDESC
          WRITE     HTMLFILE;*+,CODDESC;                   * 8
          WRITE     HTMLFILE;"#",":
                             "#"",MOVEDESC,"#",":          * 9
                             "#"",UNITDESC,"#",":          * 10
                             "#"";
.
          WRITE     HTMLFILE;BEDTDESC;                     * 11
          WRITE     HTMLFILE;"#",":
                             "#"";
.
          WRITE     HTMLFILE;PTTRCLTY;                     * 12
          WRITE     HTMLFILE;"#",":
                             "#"",TEAMDESC,"#",":          * 13
                             "#"";
.
          WRITE     HTMLFILE;REGIDESC;                     * 14
          WRITE     HTMLFILE;"#",":
                             "#"";
.
          WRITE     HTMLFILE;RESIDESC;                     * 15
          WRITE     HTMLFILE;"#",":
                             "#"",DISPUSER,"#")"
          GOTO      TRNINS10
.
TRNINS99  RETURN
+
.------------------------------------------------------------
. Supervisor Transfer Audit List
.------------------------------------------------------------
TRNAUD00  PACK      KEY46,ADMISSNO,SP70
          CALL      RSPMCHA1
TRNAUD10  CALL      RKPMCHA1
          BRANCH    OVRCD,TRNAUD99
.
          MATCH     ADMISSNO,PMCHADMN
          GOTO      TRNAUD99 IF NOT EQUAL
.
          MOVE      PMCHCTYP,FORM3
          LOAD      TAUDTYPE,FORM3,TRNAUD01,TRNAUD02,TRNAUD03,TRNAUD04,TRNAUD05:
                                   TRNAUD06,TRNAUD07,TRNAUD08,TRNAUD09
.
          PACK      WARDNAM1,PMCHOVAL,SP70       * depends on type (form3)
          PACK      WARDNAM2,PMCHNVAL,SP70       * depends on type (form3)
.
          IF        FORM3=1                      
            PACK      KEY3,PMCHOVAL,SP70         * Ward/Bed
            PACK      KEY6,KEY3,SP70
            CALL      RDWARD1
            IF        OVRCD=0
              PACK      WARDNAM1,PTWDSDES,SP70,SP70
            ENDIF
            PACK      KEY6,PMCHOVAL,SP70
            CALL      RDWARD1
            IF        OVRCD=0
              STRIP     WARDNAM1
              ENDSET    WARDNAM1
              APPEND    "/",WARDNAM1
              APPEND    PTWDSDES,WARDNAM1        * old ward/bed
            ENDIF
.
            PACK      KEY3,PMCHNVAL,SP70
            PACK      KEY6,KEY3,SP70
            CALL      RDWARD1
            IF        OVRCD=0
              PACK      WARDNAM2,PTWDSDES,SP70,SP70
            ENDIF
            PACK      KEY6,PMCHNVAL,SP70
            CALL      RDWARD1
            IF        OVRCD=0
              STRIP     WARDNAM2
              ENDSET    WARDNAM2
              APPEND    "/",WARDNAM2
              APPEND    PTWDSDES,WARDNAM2        * new ward/bed
            ENDIF
          ENDIF
.
TRNAUD20  IF        FORM3=2                       
            UNPACK    PMCHOVAL,DIM3,DIM1,D3
            MATCH     SP70,DIM3
            IF        @EQUAL
.             PACK      KEY30,PMCHADMN,PMCHTDAT,PMCHTTIM,PMCHTWAR,PMCHTBED
.             CALL      RDTRAN2
.             PACK      DIM3,PTTRCLTY,SP70
              PACK      WARDNAM1,SP70,SP70
              GOTO      TRNAUD30
            ENDIF 
.
            PACK      KEY5,ANSC,ANSL,DIM3,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,DIM20
              MATCH     SP70,D3
              IF        !@EQUAL
                PACK      KEY5,CATcx,D3,SP70
                CALL      RDCODE1
                IF        OVRCD=0
                  PACK      WARDNAM1,DIM20,SP1,FSLASH,TDESC,SP70,SP70    * Old Val
                ENDIF
              ELSE
                PACK      WARDNAM1,DIM20,SP70,SP70
              ENDIF
            ENDIF
.
TRNAUD30    UNPACK    PMCHNVAL,DIM3,DIM1,D3
            MATCH     SP70,DIM3
            IF        @EQUAL
.             PACK      KEY30,PMCHADMN,PMCHTDAT,PMCHTTIM,PMCHTWAR,PMCHTBED
.             CALL      RDTRAN2 
.             PACK      DIM3,PTTRCLTY,SP70
              PACK      WARDNAM2,SP70,SP70
              GOTO      TRNAUD40
            ENDIF
.
            PACK      KEY5,ANSC,ANSL,DIM3,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,DIM20
              MATCH     SP70,D3
              IF        !@EQUAL
                PACK      KEY5,CATcx,D3,SP70
                CALL      RDCODE1
                IF        OVRCD=0
                  PACK      WARDNAM2,DIM20,SP1,FSLASH,TDESC,SP70,SP70    * New Val
                ENDIF
              ELSE
                PACK      WARDNAM2,DIM20,SP70,SP70
              ENDIF
            ENDIF
          ENDIF
.
TRNAUD40  IF        FORM3=3                               
            UNPACK    PMCHOVAL,DIM3,DIM1,DIM5                * Patient Type
            MATCH     SP70,DIM3
            IF        @EQUAL
.             PACK      KEY30,PMCHADMN,PMCHTDAT,PMCHTTIM,PMCHTWAR,PMCHTBED
.             CALL      RDTRAN2 
.             PACK      DIM3,TATYPE,SP70
              PACK      WARDNAM1,SP70,SP70
              GOTO      TRNAUD50
            ENDIF
.
            PACK      KEY5,ANSA,SP1,DIM3,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              PACK      KEY5,DIM5,SP70
              CALL      RDPTVAD1
              IF        OVRCD=0
                PACK      WARDNAM1,TDESC,SP1,FSLASH,PTVADESC,SP70,SP70  * Old Value
              ELSE
                PACK      WARDNAM1,TDESC,SP70,SP70
              ENDIF
            ENDIF
.
TRNAUD50    UNPACK    PMCHNVAL,DIM3,DIM1,DIM5
            MATCH     SP70,DIM3
            IF        @EQUAL
.             PACK      KEY30,PMCHADMN,PMCHTDAT,PMCHTTIM,PMCHTWAR,PMCHTBED
.             CALL      RDTRAN2 
.             PACK      DIM3,TATYPE,SP70
              PACK      WARDNAM2,SP70,SP70
              GOTO      TRNAUD60
            ENDIF
.
            PACK      KEY5,ANSA,SP1,DIM3,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              PACK      KEY5,DIM5,SP70
              CALL      RDPTVAD1
              IF        OVRCD=0
                PACK      WARDNAM2,TDESC,SP1,FSLASH,PTVADESC,SP70,SP70  * New Value
              ELSE
                PACK      WARDNAM2,TDESC,SP70,SP70
              ENDIF
            ENDIF
          ENDIF
.
TRNAUD60  IF        FORM3=4
            UNPACK    PMCHOVAL,D6,D3,D5          * clinician/unit/team
            PACK      WARDNAM1,D6,SP70,SP70
.
            PACK      KEY10,D6,SP70  * try "pmshcpaf" for Doctor Name
            CALL      RDPMHCP1
            IF        OVRCD=0
              MOVE      PMHCTITL,FMTTITLE
              MOVE      PMHCGNAM,FMTGNAME
              MOVE      PMHCSNAM,FMTSNAME
              CALL      DOCNM000 
              PACK      WARDNAM1,DOCFNAME,SP70,SP70
            ENDIF
.
            STRIP     WARDNAM1
            ENDSET    WARDNAM1
            APPEND    "&nbsp;/",WARDNAM1
.
            PACK      KEY5,ANSA,ANSC,D3,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              APPEND    TDESC,WARDNAM1
            ELSE
              APPEND    D3,WARDNAM1
            ENDIF
.
            APPEND    "&nbsp;/",WARDNAM1
.
            PACK      KEY5,D5,SP70
            CALL      RDPMTEM1
            IF        OVRCD=0
              APPEND    PMTMDESC,WARDNAM1
            ELSE
              APPEND    D5,WARDNAM1
            ENDIF
.
            UNPACK    PMCHNVAL,D6,D3,D5          * clinician/unit/team
            PACK      WARDNAM2,D6,SP70,SP70
.
            PACK      KEY10,D6,SP70  * try "pmshcpaf" for Doctor Name
            CALL      RDPMHCP1
            IF        OVRCD=0
              MOVE      PMHCTITL,FMTTITLE
              MOVE      PMHCGNAM,FMTGNAME
              MOVE      PMHCSNAM,FMTSNAME
              CALL      DOCNM000
              PACK      WARDNAM2,DOCFNAME,SP70,SP70
            ENDIF

.
            STRIP     WARDNAM2
            ENDSET    WARDNAM2
            APPEND    "&nbsp;/",WARDNAM2
.
            PACK      KEY5,ANSA,ANSC,D3,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              APPEND    TDESC,WARDNAM2
            ELSE
              APPEND    D3,WARDNAM2
            ENDIF
.
            APPEND    "&nbsp;/",WARDNAM2
.
            PACK      KEY5,D5,SP70
            CALL      RDPMTEM1
            IF        OVRCD=0
              APPEND    PMTMDESC,WARDNAM2
            ELSE
              APPEND    D5,WARDNAM2
            ENDIF
.
          ENDIF
.
          IF        FORM3=6
            PACK      KEY5,ANSB,ANST,PMCHOVAL,SP70           * Patient Type
            CALL      RDCODE1
            IF        OVRCD=0
              PACK      WARDNAM1,TDESC,SP70,SP70
            ENDIF
.
            PACK      KEY5,ANSB,ANST,PMCHNVAL,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              PACK      WARDNAM2,TDESC,SP70,SP70
            ENDIF
          ENDIF
.
          IF        FORM3=7
            UNPACK    PMCHOVAL,D8,KEY16          * key16 = date/time
            UNPACK    KEY16,KEY8,D8
            UNPACK    KEY8,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      WARDNAM1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP70,SP70
            STRIP     WARDNAM1
            ENDSET    WARDNAM1
            APPEND    " at ",WARDNAM1
            APPEND    D8,WARDNAM1                * time
.
            UNPACK    PMCHNVAL,D8,KEY16          * key16 = date/time
            UNPACK    KEY16,KEY8,D8
            UNPACK    KEY8,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      WARDNAM2,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP70,SP70
            STRIP     WARDNAM2
            ENDSET    WARDNAM2
            APPEND    " at ",WARDNAM2
            APPEND    D8,WARDNAM2                * time
          ENDIF
.
          IF        FORM3=5
            PACK      KEY5,ANSC,ANSC,PMCHOVAL,SP70           * Care Type
            CALL      RDCODE1
            IF        OVRCD=0
              PACK      WARDNAM1,TDESC,SP70,SP70
            ENDIF
.
            PACK      KEY5,ANSC,ANSC,PMCHNVAL,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              PACK      WARDNAM2,TDESC,SP70,SP70
            ENDIF
          ENDIF 
.
          IF        FORM3=8
            PACK      KEY10,PMCHOVAL,SP70   
            CALL      RDPMHCP1
            IF        OVRCD=0
              MOVE      PMHCTITL,FMTTITLE
              MOVE      PMHCGNAM,FMTGNAME
              MOVE      PMHCSNAM,FMTSNAME
              CALL      DOCNM000
              PACK      WARDNAM1,DOCFNAME,SP70,SP70
            ENDIF

.
            PACK      KEY10,PMCHNVAL,SP70
            CALL      RDPMHCP1
            IF        OVRCD=0
              MOVE      PMHCTITL,FMTTITLE
              MOVE      PMHCGNAM,FMTGNAME
              MOVE      PMHCSNAM,FMTSNAME
              CALL      DOCNM000
              PACK      WARDNAM2,DOCFNAME,SP70,SP70
            ENDIF
          ENDIF
.
          IF        FORM3=9
            PACK      KEY10,PMCHOVAL,SP70
            CALL      RDPMHCP1
            IF        OVRCD=0
              MOVE      PMHCTITL,FMTTITLE
              MOVE      PMHCGNAM,FMTGNAME
              MOVE      PMHCSNAM,FMTSNAME
              CALL      DOCNM000
              PACK      WARDNAM1,DOCFNAME,SP70,SP70
            ENDIF

.
            PACK      KEY10,PMCHNVAL,SP70
            CALL      RDPMHCP1
            IF        OVRCD=0
              MOVE      PMHCTITL,FMTTITLE
              MOVE      PMHCGNAM,FMTGNAME
              MOVE      PMHCSNAM,FMTSNAME
              CALL      DOCNM000
              PACK      WARDNAM2,DOCFNAME,SP70,SP70
            ENDIF
          ENDIF
.
          PACK      KEY5,ANSI,ANSZ,PMCHREAS,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      PMCHREAS,TDESC
          ENDIF
.
          MOVE      PMCHWEBC,KEY10
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      PMCHWEBC,DISPUSER
          ENDIF
          MOVE      WBSENAM,DISPUSER
.
          PACK      HTMLLINK,SP70,SP70
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",": * 0
                             "#"",PMCHCDAT,PMCHCTIM,"#",": * 1
                             "#"",PMCHTDAT,PMCHTTIM,"#",": * 2
                             "#"",TAUDTYPE,"#",":          * 3
                             "#"",WARDNAM1,"#",":          * 4
                             "#"",WARDNAM2,"#",":          * 5
                             "#"",DISPUSER,"#",":          * 6
                             "#"",TDESC,"#")"              * 7
          GOTO      TRNAUD10
.
TRNAUD99  RETURN
+
.                                           * HPS BLR Code Starts Here
.------------------------------------------------------------
. Get the care type
.------------------------------------------------------------
GETCAR00  PACK      KEY24,TADMN,TDATE,TTIME,Z70
          CALL      RDSCHCO1
          CALL      RDKCHCO1
          BRANCH    OVRCD,GETCAR90
.
          MATCH     TADMN,CHADMN
          GOTO      GETCAR90 IF NOT EQUAL
.
          PACK      KEY5,ANSC,ANSC,CHCODE
          CALL      RDCODE1
          MOVE      TDESC,CODDESC
          GOTO      GETCAR99
.
GETCAR90  PACK      KEY5,ANSC,ANSC,ACARE
          CALL      RDCODE1
          MOVE      TDESC,CODDESC
.
GETCAR99  RETURN
+
.------------------------------------------------------------
. Output Of  Movement Details Table
.------------------------------------------------------------
MVDTAB00  UNPACK    DIM127,D1,ANS,DIM127
          MOVE      ZERO,PUBLFLAG
          MOVE      ANS,PUBLFLAG
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          MOVE      "CC",KEY2
          PACK      KEY5,KEY2,ACARE,SP70
          CALL      RDCODE1
          MOVE      TDESC,CODDESC
          MOVE      SP70,LASTWBED
          MOVE      SP70,LASTDOCT
          MOVE      SP70,LASTTYPE
          PACK      KEY30,ADMISSNO,SP70
          CALL      RDSTRAN2
MVDTAB10  CALL      RDKTRAN2
          BRANCH    OVRCD,MVDTAB20
          MATCH     ADMISSNO,DTADMN
          GOTO      MVDTAB20 IF NOT EQUAL
.
          MOVE      ONE,DELFLAG
          MATCH     ANSA,TMOVE                   * Cannot delete Admissions
          IF        @EQUAL
            MOVE      ZERO,DELFLAG
          ENDIF
.
          MATCH     ANSD,TMOVE                   * Cannot delete Discharges
          IF        @EQUAL
            MOVE      ZERO,DELFLAG
          ENDIF
.
          CALL      GETTRN00
          CALL      GETCAR00
          CLEAR     HTMLLINK
.
          APPEND    "javascript:linkPatient('",HTMLLINK
          APPEND    TDATE,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    TTIME,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    TWARD,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    TBED,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    TMOVE,HTMLLINK
          APPEND    "')",HTMLLINK
.                                             * I SRF 22221
          MATCH     SP70,DISPUSER
          IF        @EQUAL
            PACK      DISPUSER,PTTRUCID,SP70  * create user
          ENDIF
          MATCH     SP70,DISPUSER
          IF        @EQUAL
            PACK      KEY14,PTTRCUID,SP70     * pack key with passcode
            CALL      RSWBSE3                 * positional read to that userid
            CALL      RKWBSE3                 * read the next record
            BRANCH    OVRCD,MVDTAB15          * fall through if record not found
.
            MATCH     PTTRCUID,WBSEPCD        * match the userids
            GOTO      MVDTAB15 IF NOT EQUAL   * fall through if userids !equal
          ELSE
            MOVE      DISPUSER,KEY10          * pack key with web userid
            CALL      RDWBSE1
            BRANCH    OVRCD,MVDTAB15          * fall through if record not found
          ENDIF
	  MOVE      WBSENAM,DISPUSER          * user name to display on table
.                                             * end I SRF 22221
.
MVDTAB15  PACK      CRUPUSER,PTTRUUID,SP70    **** created or updated user *****
          MATCH     SP70,CRUPUSER
          IF        @EQUAL
            PACK      CRUPUSER,PTTRUCID,SP70  * create user
          ENDIF
          MATCH     SP70,CRUPUSER
          IF        @EQUAL
            PACK      KEY14,PTTRCUID,SP70     * pack key with passcode
            CALL      RSWBSE3                 * positional read to that userid
            CALL      RKWBSE3                 * read the next record
            BRANCH    OVRCD,MVDTAB16          * fall through if record not found
.
            MATCH     PTTRCUID,WBSEPCD        * match the userids
            GOTO      MVDTAB16 IF NOT EQUAL   * fall through if userids !equal
          ELSE
            MOVE      CRUPUSER,KEY10          * pack key with web userid
            CALL      RDWBSE1
            BRANCH    OVRCD,MVDTAB16          * fall through if record not found
          ENDIF
          MOVE      WBSENAM,CRUPUSER
.                                  
MVDTAB16  RESET     HTMLLINK
.
          IF        PTTREPSD=1
            CLEAR     MOVEDESC
            APPEND    "ManualChange",MOVEDESC   * force stepdown
            APPEND    SP70,MOVEDESC
            RESET     MOVEDESC
          ENDIF
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                            "#"",TDATE,TTIME,"#",":
                            "#"",WARDNAME,"#",":
                            "#"",TBED,"#",":
                            "#"",WARDBED,"#",":
                            "#"",TRATEF,"#",":             * 5
                            "#"",ATYPDESC,"#",":
                            "#"",DOCFNAME,"#",":
                            "#"",CODDESC,"#",";
.
          MATCH     ANSL,TMOVE            
          IF        @EQUAL
.
            COMPARE   ONE,PTCNHDPS
            GOTO      MVDTAB18 IF EQUAL
.
            MATCH     "1",LEAVFLAG
            IF        @EQUAL
.
              PACK      KEY30,TWARD,TBED,TDATE,TTIME,DTADMN,SP70
              REP       " +",KEY30
.
              WRITE     HTMLFILE;"#"",MOVEDESC:
                       "&nbsp; <img src=../images/EditIcon.gif ":
                       "onclick=updateLeave('",KEY30,"'); ":
                       "class=ListIcon>#",";
.
            ELSE
              MATCH     SP70,PTTRLTYP
              GOTO      MVDTAB18 IF EQUAL
.
              MOVE      "TL",CATEGORY
              MOVE      PTTRLTYP,CODE
              CALL      GETCOD00
.
              MATCH     ANSC,THCSCOD
              GOTO      MVDTAB18 IF NOT EQUAL
.
              PACK      KEY30,TWARD,TBED,TDATE,TTIME,DTADMN,SP70
              REP       " +",KEY30
.
              WRITE     HTMLFILE;"#"",MOVEDESC:
                       "&nbsp; <img src=../images/EditIcon.gif ":
                       "onclick=viewLeave('",KEY30,"'); ":
                       "class=ListIcon>#",";
            ENDIF
.
          ELSE
MVDTAB18    WRITE     HTMLFILE;"#"",MOVEDESC,"#",";
          ENDIF
.
          WRITE     HTMLFILE;"#"",UNITDESC,"#",":           * 10
                            "#"",DELFLAG,"#",":
                            "#"",CRUPUSER,"#",":
                            "#"",PTTRCDAT,PTTRCTIM,"#",":
                            "#"",BEDTDESC,"#",":
                            "#"",DIM20,"#",":              * 15
                            "#"",TEAMDESC,"#",":
                            "#"",REGIDESC,"#",":
                            "#"",RESIDESC,"#",":
                            "#"",DISPUSER,"#",":
                            "#"",CASTDESC,"#")"            * 20
.
.
          GOTO      MVDTAB10
.
MVDTAB20  PACK      KEY24,ADMISSNO,SP70
          CALL      RDSCHCO1
MVDTAB30  CALL      RDKCHCO1
          BRANCH    OVRCD,MVDTAB99
          MOVE      ONE,DELFLAG
          MATCH     ADMISSNO,DCHADMN
          GOTO      MVDTAB99 IF NOT EQUAL
          PACK      KEY5,CHCATG,SP70
          CALL      RDCODE1
          MOVE      CHDATE,SAVDATE
          MOVE      CHTIME,SAVTIME
.
          PACK      KEY30,DCHADMN,CHDATE,CHTIME,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          MATCH     TADMN,CHADMN
          IF        @EQUAL
            CALL      GETTRN00
          ENDIF
.
          CLEAR     MOVEDESC
          APPEND    "CareType Change",MOVEDESC
          APPEND    SP70,MOVEDESC
          RESET     MOVEDESC
.
          MOVE      SP70,SAVCHDT
          MOVE      SP70,SAVCHTM
          MOVE      SP70,SAVCHUD
          MOVE      CHCRDATE,SAVCHDT
          MOVE      CHCRTIME,SAVCHTM
          MOVE      CHCRUSID,SAVCHUD
          MOVE      SP70,CODDESC
. 
          PACK      SAVKEY24,CHADMN,CHDATE,CHTIME,SP70
          CALL      RDKCHCO1                * check if this is the last record
          BRANCH    OVRCD,MVDTAB40
          MATCH     ADMISSNO,DCHADMN
          GOTO      MVDTAB40 IF NOT EQUAL
.
          PACK      KEY5,CHCATG,CHCODE,SP70
          CALL      RDCODE1
          MOVE      TDESC,CODDESC
.
          MOVE      SAVKEY24,KEY24
          CALL      RDCHCO1                 * if not, re-read previous record
          BRANCH    OVRCD,MVDTAB30
.
.>>>>     CLEAR     MOVEDESC
.>>>>     APPEND    "Change",MOVEDESC
.>>>>     APPEND    SP70,MOVEDESC
.>>>>     RESET     MOVEDESC
.
          MATCH     SP70,CHCODE
          GOTO      MVDTAB50 IF EQUAL
          GOTO      MVDTAB50 IF EOS
.
          GOTO      MVDTAB50
.
MVDTAB40  MOVE      SP70,CODDESC
          MATCH     SP70,ACARE
          GOTO      MVDTAB50 IF EQUAL
          GOTO      MVDTAB50 IF EOS
.
          PACK      KEY5,ANSC,ANSC,ACARE,SP70
          CALL      RDCODE1
          MOVE      TDESC,CODDESC
.
MVDTAB50  MOVE      SP70,DISPUSER
          PACK      KEY14,SAVCHUD,SP70
          CALL      RSWBSE3
          CALL      RKWBSE3
          BRANCH    OVRCD,MVDTAB60
.
          MATCH     SAVCHUD,WBSEPCD
          GOTO      MVDTAB60 IF NOT EQUAL
.         
          MOVE      WBSENAM,DISPUSER
.
MVDTAB60  PACK      HTMLLINK,SP70,SP70
.
          APPEND    "javascript:delCareType('",HTMLLINK
          APPEND    ADMISSNO,HTMLLINK
          APPEND    SAVDATE,HTMLLINK
          APPEND    SAVTIME,HTMLLINK
          APPEND    "')",HTMLLINK
.                                        
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",SAVDATE,SAVTIME,"#",":
                             "#"",WARDNAME,"#",":
                             "#"",TBED,"#",":
                             "#"",WARDBED,"#",":
                             "#"",TRATEF,"#",":
                             "#"",ATYPDESC,"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",CODDESC,"#",":
                             "#"",MOVEDESC,"#",":
                             "#"",UNITDESC,"#",":     * 10
                             "#"",DELFLAG,"#",":
                             "#"",CRUPUSER,"#",":
                             "#"",SAVCHDT,SAVCHTM,"#",":
                             "#"",BEDTDESC,"#",":
                             "#"",DIM20,"#",":
                             "#"",TEAMDESC,"#",":
                             "#"",REGIDESC,"#",":
                             "#"",RESIDESC,"#",":
                             "#"",DISPUSER,"#");"

          GOTO      MVDTAB30
.
MVDTAB99  RETURN
.                                           * HPS BLR Code Ends Here
.------------------------------------------------------------
. Get Transfer Details
.------------------------------------------------------------
GETTRN00  MOVE      "&nbsp;",WARDNAME
          PACK      KEY6,TWARD,SP70
          CALL      RDWARD1
          IF        OVRCD=0
            CLEAR     WARDNAME
            APPEND    WBDESC,WARDNAME
            MATCH     SP3,ABED
            IF        !@EQUAL
              APPEND    SLASH,WARDNAME
              APPEND    ABED,WARDNAME
            ENDIF
            RESET     WARDNAME
            STRIP     WARDNAME
          ENDIF
.
          PACK      KEY10,PTTRRSTR,SP10
          MATCH     SP70,KEY10
          IF        @EQUAL
            MOVE      SP70,REGIDESC
          ELSE
            CALL      RDPMHCP1
            IF        OVRCD=0
              MOVE      PMHCTITL,FMTTITLE
              MOVE      PMHCGNAM,FMTGNAME
              MOVE      PMHCSNAM,FMTSNAME
              CALL      DOCNM000
              MOVE      DOCFNAME,REGIDESC          * registrar
            ELSE
              APPEND    "Invalid Registrar - ",PTTRRSTR
            ENDIF
          ENDIF
.
          PACK      KEY10,PTTRRESI,SP10
          MATCH     SP70,KEY10
          IF        @EQUAL
            MOVE      SP70,RESIDESC
          ELSE
            CALL      RDPMHCP1
            IF        OVRCD=0
              MOVE      PMHCTITL,FMTTITLE
              MOVE      PMHCGNAM,FMTGNAME
              MOVE      PMHCSNAM,FMTSNAME
              CALL      DOCNM000
              MOVE      DOCFNAME,RESIDESC          * resident
            ELSE
              APPEND    "Invalid Resident - ",PTTRRESI
            ENDIF
          ENDIF
.
          MOVE      SP70,DOCFNAME
          MATCH     SP70,TADOCT
          GOTO      GETTRN05 IF EQUAL
. 
          MOVE      TADOCT,KEY6
          CALL      RDDOCT1
          IF        OVRCD=0
.           CALL      DOCNAM00             * format doctors name
            MOVE      DTITL,FMTTITLE            * I CAR 13038
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000                  * end I CAR 13038
          ELSE
            CLEAR     DOCFNAME
            APPEND    "Invalid Doctor - ",DOCFNAME
            APPEND    PVIDOCT,DOCFNAME
            RESET     DOCFNAME
          ENDIF
.
GETTRN05  ADD       TRATEH,TRATEF
          ADD       TEXTRA,TRATEF
          SUB       TDISC,TRATEF
          SUB       TALLW,TRATEF
.
          MOVE      TMOVE,ANS
          REP       "A1D2C3L4R5",ANS
          MOVE      ZERO,F1
          MOVE      ANS,F1
          MOVE      "&nbsp;",MOVEDESC
          LOAD      MOVEDESC,F1,MOVEADM,MOVEDIS,MOVECHG,MOVELVE,MOVERET
          IF        F1=4
            MATCH     SP70,PTTRLTYP
            GOTO      GETTRN10 IF EQUAL
            PACK      KEY5,ANST,ANSL,PTTRLTYP,SP70
            CALL      RDCODE1
            BRANCH    OVRCD,GETTRN10
            PACK      MOVEDESC,MOVELVE,SP1,TDESC,SP70
          ENDIF
.
GETTRN10  MOVE      "A ",CATEGORY
          MOVE      TATYPE,CODE
          CALL      GETCOD00
          MOVE      TDESC,ATYPDESC
.
          MOVE      "AC",CATEGORY
          MOVE      TDEPT,CODE
          CALL      GETCOD00
          MOVE      TDESC,UNITDESC
.
          MOVE      SP70,BEDTDESC
          MOVE      "BT",CATEGORY
          MOVE      TRBTYP,CODE
          CALL      GETCOD00
          MOVE      TDESC,BEDTDESC
.
.          PACK      WARDBED,TWARD,SLASH,TBED  
          PACK      KEY6,TWARD,TBED    * format WARD/BED
          CALL      FWBD0000
        
          PACK      KEY6,TWARD,TBED
          MATCH     LASTWBED,KEY6
          IF        @EQUAL
.            PACK      WARDBED,SP70
.            MOVE      SP70,WARDNAME
.            MOVE      SP70,TWARD
.            MOVE      SP70,TBED
          ENDIF
          MOVE      KEY6,LASTWBED
.
          MATCH     TADOCT,LASTDOCT
          IF        @EQUAL
...jh...    MOVE      SP70,DOCFNAME
          ENDIF
          MOVE      TADOCT,LASTDOCT
.
          MATCH     TATYPE,LASTTYPE
          IF        @EQUAL
...jh...    MOVE      SP70,ATYPDESC
          ENDIF
          MOVE      TATYPE,LASTTYPE
.
          MOVE      "&nbsp;",DIM20
          MATCH     SP70,PTTRCLTY
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSL,PTTRCLTY,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,DIM20
            ENDIF
          ENDIF
.
          MOVE      SP70,TEAMDESC
          PACK      KEY5,PTTRTEAM,SP70
          MATCH     SP70,KEY5
          IF        !@EQUAL
            CALL      RDPMTEM1
            IF        OVRCD<>1
              MOVE      PMTMDESC,TEAMDESC        * team
            ENDIF
          ENDIF
.
          MOVE      SP70,DISPUSER
          MOVE      SP70,CRUPUSER
          PACK      CRUPUSER,PTTRUUID,SP70    * update user
          MATCH     SP70,CRUPUSER
          IF        @EQUAL
            PACK      CRUPUSER,PTTRUCID,SP70  * create user
          ENDIF
          MATCH     SP70,CRUPUSER
          IF        @EQUAL
            PACK      KEY14,PTTRCUID,SP70     * pack key with passcode
            CALL      RSWBSE3                 * positional read to that userid
            CALL      RKWBSE3                 * read the next record
            BRANCH    OVRCD,GETTRN20          * fall through if record not found
.
            MATCH     PTTRCUID,WBSEPCD        * match the userids
            GOTO      GETTRN20 IF NOT EQUAL   * fall through if userids !equal
          ELSE
            MOVE      CRUPUSER,KEY10          * pack key with web userid
            CALL      RDWBSE1
            BRANCH    OVRCD,GETTRN20          * fall through if record not found
          ENDIF
          MOVE      WBSENAM,CRUPUSER          * user name to display on table
.
GETTRN20  MATCH     SP70,DISPUSER
          IF        @EQUAL
            PACK      DISPUSER,PTTRUCID,SP70  * create user
          ENDIF
          MATCH     SP70,DISPUSER
          IF        @EQUAL
            PACK      KEY14,PTTRCUID,SP70     * pack key with passcode
            CALL      RSWBSE3                 * positional read to that userid
            CALL      RKWBSE3                 * read the next record
            BRANCH    OVRCD,GETTRN99          * fall through if record not found
.
            MATCH     PTTRCUID,WBSEPCD        * match the userids
            GOTO      GETTRN99 IF NOT EQUAL   * fall through if userids !equal
          ELSE
            MOVE      DISPUSER,KEY10          * pack key with web userid
            CALL      RDWBSE1
            BRANCH    OVRCD,GETTRN99          * fall through if record not found
          ENDIF
          MOVE      WBSENAM,DISPUSER          * user name to display on table
.
          MOVE      SP70,CASTDESC             * Case Team description
          MATCH     SP70,PTTRCASE
          IF        !@EQUAL
            MOVE      PTTRCASE,KEY10
            CALL      RDALCAS1
            IF        OVRCD=0
              MOVE      ALCADESC,CASTDESC
            ENDIF
          ENDIF
.
GETTRN99  RETURN
+
.------------------------------------------------------------------------
.  Format 'ward/bed'  line in field WARDBED according to the
.  PTCNWBDS parameter (code, long name,short name)
.------------------------------------------------------------------------
FWBD0000 MOVE      PTCNWBDS,F1  * ward bed name option none,long,short
         CLEAR     WARDBED
         UNPACK    KEY6,KEYWRD,KEYBED

         IF        F1 = 0
           GOTO      FWBD8000
         ENDIF
.
         PACK       KEY6,KEYWRD,SP70
         CALL       RDWARD1
         BRANCH     OVRCD,FWBD8000
.
         IF         F1 = 2
           APPEND     PTWDSDES,WARDBED
         ELSE
           APPEND     WBDESC,WARDBED
         ENDIF
.
         MATCH      SP3,KEYBED
         GOTO       FWBD9999 IF EQUAL
.
         APPEND     "/",WARDBED
         PACK       KEY6,KEYWRD,KEYBED
         CALL       RDWARD1
         IF         OVRCD = 1
           APPEND     KEYBED,WARDBED
           GOTO       FWBD9999
         ENDIF
.
         IF        F1 = 2
           APPEND     PTWDSDES,WARDBED
         ELSE
           APPEND     WBDESC,WARDBED
         ENDIF
         GOTO       FWBD9999
.
FWBD8000 APPEND     KEYWRD,WARDBED
         MATCH      SP3,KEY3
         IF         !@EQUAL
           APPEND     "/",WARDBED
           APPEND     KEYBED,WARDBED 
         ENDIF
         GOTO       FWBD99999
.
FWBD9999 RESET    WARDBED
         RETURN
+
.------------------------------------------------------------------------
.  Format hospital text  HOSPTEXT According to the
.  PTCNWBDS parameter (code, long name,short name)
.------------------------------------------------------------------------
FHOS0000  PACK      HOSPTEXT,SP70
          CLEAR     HOSPTEXT
          MATCH     KEY3,SP3
          GOTO      FHOS9999 IF EQUAL
          IF        IBCNMHOS <> 1
                 GOTO      FHOS9999
          ENDIF 
          MOVE      PTCNWBDS,F1  * name option none,long,short
          CALL      RDPTHSP1
          IF        OVRCD = 1 | F1 = 0
            APPEND    KEY3,HOSPTEXT         * Hospital code
.           APPEND    DASH,HOSPTEXT
          ELSE
            IF       F1 = 2
              STRIP    PTHSSNAM
              APPEND   PTHSSNAM,HOSPTEXT    * Hospital short name
            ELSE
              STRIP    PTHSNAME
              APPEND   PTHSNAME,HOSPTEXT    * Hospital long name
            ENDIF
          ENDIF
          RESET      HOSPTEXT
          STRIP      HOSPTEXT         
FHOS9999  RETURN
+           
.------------------------------------------------------------
. Output MBS Coding Table Details
.------------------------------------------------------------
MBSTAB00  WRITE     HTMLFILE;"<tr>":
                    "<td class=HeadingCell>CMBS Code</td>":
                    "<td class=HeadingCell>CMBS Name</td>":
                    "<td class=HeadingCell align=center>Date</td>":
                    "<td class=HeadingCell align=center>Start Time</td>":
                    "<td class=HeadingCell align=center>End Time</td></tr>"
          MOVE      ZERO,VISCOUNT
          PACK      KEY11,ADMISSNO,SP70
          CALL      RDSMMBS1
MBSTAB10  CALL      RDKMMBS1
          BRANCH    OVRCD,MBSTAB90
          MATCH     ADMISSNO,DMMADMN  
          GOTO      MBSTAB90 IF NOT EQUAL
          ADD       ONE,VISCOUNT
.
          PACK      KEY17,MMCODE,SP70
          CALL      PATITMRD          * Read item file
          IF        OVRCD=1
            MOVE      "Invalid Code",IDESC
          ENDIF
.
          MATCH     SP70,PTMMDESC           * Is Free Format Description blank?
          IF        @EQUAL
            PACK      PTMMDESC,IDESC,SP70   * Yes, use default description
          ENDIF
.
          UNPACK    MMDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      TRANDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          MOVE      TTIME,KEY5
.
          BRANCH    DISPFLAG,MBSTAB50
.
          WRITE     HTMLFILE;"<tr><td>",MMCODE,"</a></td>":
                             "<td>",PTMMDESC,"</td>":
                             "<td align=center>",TRANDATE,"</td>":
                             "<td align=center>",MMSTIM,"</td>":
                             "<td align=center>",MMETIM,"</td></tr>"
          GOTO      MBSTAB10
.
MBSTAB50  WRITE     HTMLFILE;"<tr><td nowrap><A HREF='javascript:UpdMbsTime(#"":
                             MMCODE,"#",#"",MMADMN,"#",#"",MMRECN,"#")'>":
                             "<img src=../images/EditIcon.gif ":
                             "class=ListIcon></a>":
                             MMCODE,"</td>":
                             "<td>",PTMMDESC,"</td>":
                             "<td align=center>",TRANDATE,"</td>":
                             "<td align=center>",MMSTIM,"</td>":
                             "<td align=center>",MMETIM,"</td></tr>"
          GOTO      MBSTAB10
.
MBSTAB90  IF        VISCOUNT=0
            WRITE     HTMLFILE;"<tr><td align=center colspan=5>":
                               "<b>No CMBS Coding Records Found</b></td></tr>"
          ENDIF
.
MBSTAB99  RETURN
.------------------------------------------------------------
. Output Operation ICD9/10 Coding Table Details
.------------------------------------------------------------
OPRTAB00  UNPACK    DIM127,D1,ANS,DIM127
          UNPACK    DIM127,D1,KEY1,DIM127
          UNPACK    DIM127,D1,DIM1,DIM127
          MOVE      ZERO,SHOWMAP
          MOVE      ANS,SHOWMAP
          MOVE      ZERO,SHOWSJOG
          MOVE      KEY1,SHOWSJOG
          MOVE      ZERO,VIEWCCFL
          MOVE      DIM1,VIEWCCFL       * Displaying Contract care flag
.
          COMPARE   ONE,SHOWSJOG
          IF        @EQUAL
            COMPARE   ONE,VIEWCCFL
            IF        @EQUAL
              WRITE     HTMLFILE;"<tr>":
                        "<td class=HeadingCell colspan=7 align=center>";
            ELSE
              WRITE     HTMLFILE;"<tr>":
                        "<td class=HeadingCell colspan=6 align=center>";
            ENDIF
          ELSE
            COMPARE   ONE,VIEWCCFL
            IF        @EQUAL
              WRITE     HTMLFILE;"<tr>":
                        "<td class=HeadingCell colspan=6 align=center>";
            ELSE
              WRITE     HTMLFILE;"<tr>":
                        "<td class=HeadingCell colspan=5 align=center>";
            ENDIF
          ENDIF 
          CALL      ICDTYP00    * Determine Default ICD9 or 10 and Show Heading
          WRITE     HTMLFILE;"Procedure Coding";
          WRITE     HTMLFILE;"</td></tr>"
.
          COMPARE   ONE,VIEWCCFL
          IF        @EQUAL
            WRITE     HTMLFILE;"<tr>":
                      "<td class=HeadingCell width=10%>Procedure Code</td>":
                      "<td class=HeadingCell width=35%>Description</td>":
                      "<td class=HeadingCell width=15%>":
                      "Contracted Care Flag</td>"
          ELSE
            WRITE     HTMLFILE;"<tr>":
                      "<td class=HeadingCell width=10%>Procedure Code</td>":
                      "<td class=HeadingCell width=50%>Description</td>"
          ENDIF
.
          WRITE     HTMLFILE;"<td class=HeadingCell align=center width=10%>":
                    "Date</td>":
                    "<td class=HeadingCell align=center width=10%>":
                    "Start Time</td>":
                    "<td class=HeadingCell align=center width=10%>":
                    "End Time</td>"
.
          COMPARE   ONE,SHOWSJOG
          IF        @EQUAL
            WRITE     HTMLFILE;"<td class=HeadingCell align=center width=10%>":
                      "Block</td>"
          ENDIF
.
          WRITE     HTMLFILE;"</tr>"
.
          MOVE      ZERO,VISCOUNT
          COMPARE   ZERO,EPSCD001
          IF        @EQUAL
            MOVE      ONE,EPSCD001
            PACK      KEY13,ADMISSNO,EPSCD001                         *C-240107
          ELSE
            PACK      KEY13,ADMISSNO,EPSCD001                         *C-240107
          ENDIF
          CALL      RSPTECO1
OPRTAB10  CALL      RKPTECO1
          BRANCH    OVRCD,OPRTAB90
.
          MATCH     ADMISSNO,DPTEOADM  
          GOTO      OPRTAB90 IF NOT EQUAL
.
          COMPARE   EPSCD001,PTEOEPNO
          GOTO      OPRTAB90 IF NOT EQUAL
.
          ADD       ONE,VISCOUNT
          CALL      GETICO00
          BRANCH    OVRCD,OPRTAB10
.
          COMPARE   ZERO,SHOWMAP            * Are actual codes being displayed?
          GOTO      OPRTAB20 IF NOT EQUAL   * No display mapped codes
.         
          MATCH     SP70,PTEODESC           * Is Free Format Description blank?
          IF        !@EQUAL
            MOVE      PTEODESC,PT0ODSC2     * No, use Free Format Description
          ENDIF
.
OPRTAB20  PACK      TRANDATE,SP70
          MATCH     SP70,PTEODATE
          IF        !@EQUAL
            UNPACK    PTEODATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      TRANDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
          MOVE      TTIME,KEY5
.
          MOVE      PTEOCCFL,DIM2
          CALL      GTCCFL00
.
          WRITE     HTMLFILE;"<tr><td>",PTEOTYPE,SP1,OPCODE,"</a></td>":
                             "<td>",PT0ODSC2,"</td>"
.
          COMPARE   ONE,VIEWCCFL
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>",DIM50,"</td>"
          ENDIF
.
          WRITE     HTMLFILE;"<td align=center>",TRANDATE,"</td>":
                             "<td align=center>",PTEOSTTM,"</td>":
                             "<td align=center>",PTEOEDTM,"</td>"
.
          COMPARE   ONE,SHOWSJOG
          IF        @EQUAL
           WRITE     HTMLFILE;"<td align=center>",PT0OBLKN,"</td>"
          ENDIF
.
          WRITE     HTMLFILE;"</tr>"
.
          GOTO      OPRTAB10
.
OPRTAB90  IF        VISCOUNT=0
            WRITE     HTMLFILE;"<tr><td align=center colspan=5>":
                               "<b>No Procedure Coding Records Found</td></tr>"
          ENDIF
.
OPRTAB99  RETURN
.
.------------------------------------------------------------
. Output Disease ICD9/10 Coding Table Details
.------------------------------------------------------------
DISTAB00  UNPACK    DIM127,D1,ANS,DIM127
          UNPACK    DIM127,D1,KEY1,DIM127
          UNPACK    DIM127,D1,DIM1,DIM127
          MOVE      ZERO,SHOWMAP
          MOVE      ANS,SHOWMAP
          MOVE      ZERO,SHOWSJOG
          MOVE      KEY1,SHOWSJOG
          MOVE      ZERO,VIEWCCFL
          MOVE      DIM1,VIEWCCFL       * Displaying Contract care flag
.
          WRITE     HTMLFILE;"<tr>":
                             "<td class=HeadingCell colspan=6 align=center>";
.
          CALL      ICDTYP00     * Determine if ICD9 or ICD10 and Add Heading
          WRITE     HTMLFILE;"Diagnosis Coding";
.
          WRITE     HTMLFILE;"</td></tr>"
.
          BRANCH    SHOWMAP,DISTAB10  * 0=ICD10
.
          COMPARE   ONE,VIEWCCFL
          IF        @EQUAL
            WRITE     HTMLFILE;"<tr>":
                      "<td class=HeadingCell width=10%>Diagnosis Code</td>":
                      "<td class=HeadingCell width=35%>Description</td>":
                      "<td class=HeadingCell width=15%>":
                      "Contracted Care Flag</td>"
          ELSE
            WRITE     HTMLFILE;"<tr>":
                      "<td class=HeadingCell width=10%>Diagnosis Code</td>":
                      "<td class=HeadingCell width=50%>Description</td>"
          ENDIF
.
          COMPARE   ONE,PTCNEDTE      * Displaying Accident Dates
          IF        @EQUAL
            WRITE     HTMLFILE;"<td class=HeadingCell width=10%>":
                      "Accident Date</td>"
          ENDIF
.
          COMPARE   ONE,SHOWSJOG
          IF        @EQUAL
            WRITE     HTMLFILE;"<td class=HeadingCell width=10%>CCL</td>"
          ENDIF
.
          IF        PTCNHDPS>1
            WRITE     HTMLFILE;"<td class=HeadingCell width=10%>Onset Type</td>"
          ENDIF
          WRITE     HTMLFILE;"</tr>"
.
          GOTO      DISTAB20
.
DISTAB10  WRITE     HTMLFILE;"<tr>":
                    "<td class=HeadingCell width=15%>Diagnosis Code</td>":
                    "<td class=HeadingCell>Description</td></tr>"
.
DISTAB20  MOVE      ZERO,VISCOUNT
          COMPARE   ZERO,EPSCD001
          IF        @EQUAL
            MOVE      ONE,EPSCD001
          ENDIF
          PACK      KEY13,ADMISSNO,EPSCD001                           *C-240107
          CALL      RSPTECD1
DISTAB30  CALL      RKPTECD1
          BRANCH    OVRCD,DISTAB90
.
          MATCH     ADMISSNO,DPTEDADM  
          GOTO      DISTAB90 IF NOT EQUAL
.
          COMPARE   EPSCD001,PTEDEPNO
          GOTO      DISTAB90 IF NOT EQUAL
.
          ADD       ONE,VISCOUNT
          CALL      GETICD00
          BRANCH    OVRCD,DISTAB30
.
          COMPARE   ZERO,SHOWMAP            * Are actual codes being displayed?
          GOTO      DISTAB35 IF NOT EQUAL   * No display mapped codes
.
          MATCH     SP70,PTEDDESC           * Is Free Format Description blank?
          IF        !@EQUAL
            MOVE      PTEDDESC,PT0DDSC2     * No, use Free Format Description.
          ENDIF
.
DISTAB35  BRANCH    SHOWMAP,DISTAB40  * ICD10?
.
          CALL      CHCKA000       * Check if Displaying Accident Dates
.
          WRITE     HTMLFILE;"<tr><td>",PTEDTYPE,SP1,DPCODE,"</a></td>":
                             "<td>",PT0DDSC2,"</td>"
.
          MOVE      PTEDCCFL,DIM2
          CALL      GTCCFL00
.
          COMPARE   ONE,VIEWCCFL
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>",DIM50,"</td>"
          ENDIF
.
          COMPARE   ONE,PTCNEDTE     * Displaying Accident Dates
          IF        @EQUAL
            COMPARE   ONE,ACDNTFLG   * Outputing Accident Date
            IF        @EQUAL
              WRITE     HTMLFILE;"<td>",ACCIDATE,"</td>"
            ELSE
              WRITE     HTMLFILE;"<td>&nbsp;</td>"
            ENDIF
          ENDIF
.
          COMPARE   ONE,SHOWSJOG
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>",PTEDCCCL,"</td>"
          ENDIF
.
          IF        PTCNHDPS>1
            WRITE     HTMLFILE;"<td>",PTEDOSET,"</td>"
          ENDIF
          WRITE     HTMLFILE;"</tr>"
.
          GOTO      DISTAB30
.
DISTAB40  WRITE     HTMLFILE;"<tr><td>",PTEDTYPE,SP1,DPCODE,"</a></td>":
                             "<td>",PT0DDSC2,"</td></tr>"
.
          GOTO      DISTAB30
.
DISTAB90  IF        VISCOUNT=0
            WRITE     HTMLFILE;"<tr><td align=center colspan=2>":
                               "<b>No Diagnosis Coding Records Found</td></tr>"
          ENDIF
.
DISTAB99  RETURN
.
.-----------------------------------------------------------------------------
. Getthe contract acre flag description
.-----------------------------------------------------------------------------
GTCCFL00  MOVE      DIM2,DIM50
          MATCH     "01",DIM2
          IF        @EQUAL
            MOVE      CCFLAG01,DIM50
          ELSE
            MATCH     "02",DIM2
            IF        @EQUAL
              MOVE      CCFLAG02,DIM50
            ENDIF
          ENDIF
.
GTCCFL99  RETURN
.-----------------------------------------------------------------------------
. Displaying Accident Dates for E codes?
.-----------------------------------------------------------------------------
CHCKA000  MOVE      ZERO,ACDNTFLG  * Displaying Accident Date Flag

          COMPARE   ONE,PTCNEDTE   * Displaying Accident Dates for E codes?
          GOTO      CHCKA999 IF NOT EQUAL
.
          MOVE      PT0DACRQ,FORM1
          IF        FORM1=2 | FORM1=6 | FORM1=7 | FORM1=8
            MOVE      ONE,ACDNTFLG
            GOTO      CHCKA900
          ENDIF
.
          MATCH     "P",PT0DACRQ
          IF        @EQUAL
            MOVE      ONE,ACDNTFLG
            GOTO      CHCKA900
          ENDIF
.
          MATCH     "A",PT0DACRQ
          IF        @EQUAL
            MOVE      ONE,ACDNTFLG
            GOTO      CHCKA900
          ENDIF
          GOTO      CHCKA999
.
CHCKA900  MOVE      SP70,ACCIDATE
          MATCH     SP70,PTEDACDT
          IF        !@EQUAL
            UNPACK    PTEDACDT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      ACCIDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
CHCKA999  RETURN
.-------------------------------------------------
. Format Long Description
.-------------------------------------------------
LONGNM00  CMATCH    SP1,NAME70               * Remove Leading Blanks
          IF        @EQUAL
            BUMP      NAME70
            GOTO      LONGNM00 IF NOT EOS
            GOTO      LONGNM99               * entire name if blank
          ENDIF
          PACK      KEY70,NAME70,SP30        * reset form pointer
          MOVE      KEY70,NAME70
.
          SCAN      SP1,NAME70             * Locate the blank
          GOTO      LONGNM20 IF NOT EQUAL
          BUMP      NAME70,-1              * go back 1 to end of name
          MOVEFPTR  NAME70,CCITEM          * another handly form field
          RESET     NAME70                 * reset the form pointer
          SETLPTR   NAME70,CCITEM          * set logical length to end of name
.
.         Save this name
.
          UNPACK    NAME70,KEY1,KEY80
          REP       DOWNCASE,KEY80
          APPEND    KEY1,DISNAM70
          STRIP     KEY80
          APPEND    KEY80,DISNAM70
          APPEND    SP1,DISNAM70
.
.         Check for any more names
.
          SETLPTR   NAME70,70              * reset logical length
          ADD       ONE,CCITEM             * position of 1st blank
          RESET     NAME70,CCITEM          * reset to this point
          PACK      KEY70,NAME70,SP70      * reset form pointer
          MOVE      KEY70,NAME70
          GOTO      LONGNM00
.
.         Rest of the string is one name
.
LONGNM20  UNPACK    NAME70,KEY1,KEY80
          REP       DOWNCASE,KEY80
          APPEND    KEY1,DISNAM70
          STRIP     KEY80
          APPEND    KEY80,DISNAM70
          APPEND    SP1,DISNAM70
.
LONGNM99  RETURN
.------------------------------------------------------------
. Get ICD Disease Details 
.------------------------------------------------------------
GETICD00  MOVE      PTEDCODE,KEY9
          CALL      RDPTICD1              * Read ICD disease record
.
          COMPARE   ZERO,SHOWMAP
          GOTO      GETICD99 IF EQUAL
.
          IF        CODTYP=9
            PACK      KEY9,DICD10CD
            CALL      RDPT10D1            * Read ICD10 disease record
          ELSE
            PACK      KEY9,PT0DMI9C
            CALL      RD10T9D1            * Read ICD9 disease record
          ENDIF
.
GETICD99  RETURN
.------------------------------------------------------------
. Get ICD Operation Details 
.------------------------------------------------------------
GETICO00  MOVE      PTEOCODE,KEY9
          CALL      RDPTICO1             * Read ICD10 disease record
.
          COMPARE   ZERO,SHOWMAP
          GOTO      GETICO99 IF EQUAL
.
          IF        CODTYP=9
            PACK      KEY9,OICD10CD
            CALL      RDPT10O1            * Read ICD10 disease record
          ELSE
            PACK      KEY9,PT0OMI9C
            CALL      RD10T9O1            * Read ICD9 disease record
          ENDIF
.
GETICO99  RETURN
.------------------------------------------------------------
. Get Coding Type
.------------------------------------------------------------
ICDTYP00  MOVE      ICDRDDTE,KEY8
          MATCH     SP70,KEY8
          IF        @EQUAL
            PACK      KEY8,CCC,CYY,CMM,CDD
            REP       " 0",KEY8
          ENDIF
.
          MOVE       "10",CODTYP            * Defalut using ICD10 codes
.
          MATCH     PTCNGDX3,KEY8           * Is Date >= ICD10 Ed13 Go-Live Date
          GOTO      ICDTYP20 IF NOT LESS
.
          MATCH     PTCNGDX2,KEY8           * Is Date >= ICD10 Ed12 Go-Live Date
          GOTO      ICDTYP20 IF NOT LESS
.
          MATCH     PTCNGDX1,KEY8           * Is Date >= ICD10 Ed11 Go-Live Date
          GOTO      ICDTYP20 IF NOT LESS
.
          MATCH     PTCNGDVX,KEY8           * Is Date >= ICD10 Ed10 Go-Live Date
          GOTO      ICDTYP20 IF NOT LESS
.
          MATCH     PTCNGDV9,KEY8           * Is Date >= ICD10 Ed9 Go-Live Date
          GOTO      ICDTYP20 IF NOT LESS
.
          MATCH     PTCNGDV8,KEY8           * Is Date >= ICD10 Ed8 Go-Live Date
          GOTO      ICDTYP20 IF NOT LESS
.
          MATCH     PTCNGDV7,KEY8           * Is Date >= ICD10 Ed7 Go-Live Date
          GOTO      ICDTYP20 IF NOT LESS
.
          MATCH     PTCNGDV6,KEY8           * Is Date >= ICD10 Ed6 Go-Live Date
          GOTO      ICDTYP20 IF NOT LESS
.
          MATCH     PTCNGDV5,KEY8           * Is Date >= ICD10 Ed5 Go-Live Date
          GOTO      ICDTYP20 IF NOT LESS
.
          MATCH     PTCNGDV4,KEY8           * Is Date >= ICD10 V4 Go-Live Date
          GOTO      ICDTYP20 IF NOT LESS
.
          MATCH     PTCNGDV3,KEY8           * Is Date >= ICD10 V3 Go-Live Date?
          GOTO      ICDTYP20 IF NOT LESS
.
          MATCH     PTCNI10D,KEY8           * Is Date >= ICD10 Go-Live Date?
          GOTO      ICDTYP20 IF NOT LESS
.
          MOVE       "9",CODTYP             * Using ICD9 codes
.
ICDTYP20  IF        CODTYP=9
            IF        SHOWMAP=1
              WRITE     HTMLFILE;"ICD10 Coding (Mapped from ICD9) ";
            ELSE
              WRITE     HTMLFILE;"ICD9 Coding ";
            ENDIF
          ELSE
            IF        SHOWMAP=1
              WRITE     HTMLFILE;"ICD9 Coding (Mapped from ICD10) ";
            ELSE
              WRITE     HTMLFILE;"ICD10 Coding ";
            ENDIF
          ENDIF
.
ICDTYP99  RETURN
.
.-----------------------------------------------------------------
. Find the Current visit details when doing a patient search by ur
.-----------------------------------------------------------------
FNDCUR00  BRANCH    PCEASE,FNDCUR90
.
          READ      CONTROLF,HUND18;*154,PTCNUHSC    * using hospital security?
.
          PACK      KEY24,URNUMBER,Z70
          CALL      RDSVISA2
FNDCUR10  CALL      RDPVISA2
          BRANCH    OVRCD,FNDCUR90
.         
          MATCH     URNUMBER,PVIURNO
          GOTO      FNDCUR90 IF NOT EQUAL
.         
          PACK      KEY8,DPVIBILL,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,FNDCUR10
.
          MATCH     "1",PTCNUHSC
          IF        @EQUAL
            MATCH     PMVXMHOS,WBSEHOSP
            GOTO      FNDCUR10 IF NOT EQUAL
          ENDIF
          BRANCH    PVITYPE,FNDCUR40,FNDCUR50,FNDCUR50
.
          GOTO      FNDCUR10
.
FNDCUR40  PACK      KEY8,PVIBILL,SP70
          CALL      RDEMVIS1
          BRANCH    OVRCD,FNDCUR10
.
          COMPARE   FOUR,EMVISTAT                * Cancelled visit
          GOTO      FNDCUR10 IF EQUAL
.
          MATCH     EMVISITE,WBSEESC             * Current ED site
          GOTO      FNDCUR10 IF NOT EQUAL
.
          MOVE      PVIBILL,ADMISSNO
          GOTO      FNDCUR99
.
FNDCUR50  MOVE      PVIBILL,ADMISSNO
          GOTO      FNDCUR99

FNDCUR90  MOVE      SP70,ADMISSNO
.
FNDCUR99  RETURN
.
.-----------------------------------------------------------------
. Find the Current visit details (from healthviews to add observations)
.-----------------------------------------------------------------
FNDCVS00  BRANCH    PCEASE,FNDCVS90
.
          PACK      KEY24,URNUMBER,Z70
          CALL      RDSVISA2
FNDCVS10  CALL      RDPVISA2
          BRANCH    OVRCD,FNDCVS90
.
          MATCH     URNUMBER,PVIURNO
          GOTO      FNDCVS90 IF NOT EQUAL
.
          BRANCH    PVITYPE,FNDCVS40,FNDCVS10,FNDCVS50
.
          GOTO      FNDCVS10
.
FNDCVS40  PACK      KEY8,PVIBILL,SP70
          CALL      RDEMVIS1
          BRANCH    OVRCD,FNDCVS10
.
          COMPARE   FOUR,EMVISTAT                * Cancelled visit
          GOTO      FNDCVS10 IF EQUAL
.
          MOVE      PVIBILL,ADMISSNO
          GOTO      FNDCVS99
.
FNDCVS50  MOVE      PVIBILL,ADMISSNO
          PACK      KEY8,PVIBILL,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,FNDCVS10
          IF        ASTAT=1|ASTAT=5
            GOTO      FNDCVS10
          ENDIF
          GOTO      FNDCVS99

FNDCVS90  MOVE      SP70,ADMISSNO
.
FNDCVS99  RETURN
.
.------------------------------------------------------------
. Table of Medical Records Details
.------------------------------------------------------------
MRTTAB00  MOVE      SP10,WBSEHOSP                                     *I-240724
          IF        IBCNMHOS = 1
            PACK      KEY10,USERID,SP10
            CALL      RDWBSE1
          ENDIF
.
          PACK      KEY20,URNUMBER,SP70                               *C-240724
          CALL      RSMRMAS1
MRTTAB10  CALL      RKMRMAS1
          BRANCH    OVRCD,MRTTAB99
.
          MATCH     MRMAURNO,URNUMBER
          GOTO      MRTTAB99 IF NOT EQUAL
.
          IF        IBCNMHOS = 1
            MATCH     SP70,FILTHHOS
            IF        !@EQUAL
              MATCH     FILTHHOS,MRMAHHOS
              IF        !@EQUAL
                MATCH     FILTHHOS,MRMACHOS
                GOTO      MRTTAB10 IF NOT EQUAL
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     SP70,FILTHLOC
          IF        !@EQUAL
            MATCH     FILTHLOC,MRMAHLOC
            GOTO      MRTTAB10 IF NOT EQUAL
          ENDIF
.
          MOVE      SP70,DESCDOCM  * Document Type Description
          MOVE      SP70,DESCCLOC  * Current Location
          MOVE      SP70,DESCHOME  * Home Location
.
          MATCH     SP70,MRMADOTY           * Get Document Type
          GOTO      MRTTAB30 IF EQUAL
.
          MOVE      "TY",KEY2
          PACK      KEY5,KEY2,MRMADOTY
          CALL      RDCODE1
          BRANCH    OVRCD,MRTTAB30
.
          MOVE      TDESC,DESCDOCM
.
MRTTAB30  MATCH     SP70,MRMACLOC           * Get Current Location
          GOTO      MRTTAB40 IF EQUAL
.
          PACK      KEY7,MRMACHOS,MRMACLOC,SP10                       *C-240724
          CALL      RDMRLOC1
          BRANCH    OVRCD,MRTTAB40
.
          CALL      ITRN0000                * Check if in transit
.
          MATCH     SP70,INTRANST                * Set by ITRN0000
          IF        !@EQUAL
            PACK      DESCCLOC,INTRANST,MRLODESC
          ELSE
            MOVE      MRLODESC,DESCCLOC    
          ENDIF
.
MRTTAB40  MATCH     SP70,MRMAHLOC           * Get Home Location
          GOTO      MRTTAB45 IF EQUAL
.
          PACK      KEY7,MRMAHHOS,MRMAHLOC,SP10                       *C-240724
          CALL      RDMRLOC1
          BRANCH    OVRCD,MRTTAB45
.
          MOVE      MRLODESC,DESCHOME    
.
MRTTAB45  MOVE      SP70,HISTDATE
          MOVE      SP70,HISTTIME
          MOVE      SP70,HISTREQB
          MOVE      SP70,HISTCOMM
.
          PACK      KEY26,MRMAKEY,Z70
          CALL      RSMRHIS1
          CALL      RPMRHIS1                      * read tracking history file
          BRANCH    OVRCD,MRTTAB50 
.
          MATCH     MRMAKEY,MRHIKEY
          GOTO      MRTTAB50 IF NOT EQUAL
.
          MOVE      MRHIDATE,HISTDATE
          MOVE      MRHITIME,HISTTIME
          MOVE      MRHICOMM,HISTCOMM
.
          COMPARE   ONE,PTCNRQCF       * Using Free Format Requester
          IF        @EQUAL
            MOVE      MRHIREQB,HISTREQB
          ELSE
            PACK      KEY6,MRHIRECV,SP70  * Requested By (Using Staff Code)
            CALL      RDMRSTF1
            IF        OVRCD=0
              PACK      HISTREQB,MRSTGNAM,SP1,MRSTSNAM,SP70
            ENDIF
          ENDIF
.
MRTTAB50  MOVE      SP70,MTHNAM3
          UNPACK    HISTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      ZERO,F2
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          MOVE      "RS",CATEGORY
          MOVE      MRMASTAT,CODE
          CALL      GETCOD00
          MOVE      TDESC,STATDESC
.
          CLEAR     HTMLLINK
          APPEND    "javascript:RequestReport('",HTMLLINK
          APPEND    MRMAURNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    MRMADOTY,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    MRMAKEY,HTMLLINK
          APPEND    "','",HTMLLINK                                    *I-240724
          APPEND    SUPERLEV,HTMLLINK                                 *I-240724
          APPEND    "','",HTMLLINK                                    *I-240724
          APPEND    MRMAHHOS,HTMLLINK                                 *I-240724
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
          STRIP     HTMLLINK
.
          BRANCH    VIEWFLAG,MRTTAB60
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":              * 0
                             "#"",DESCDOCM,"#",":                       * 1
                             "#"",MRMAVOLN,"#",":                       * 2
                             "#"",DESCCLOC,"#",":                       * 3
                             "#"","<span style=color:",PTCDUDF3,">":    * 4  
                             STATDESC,"</span>","#",":                       
                             "#"",MRMACOMM,"#",":                       * 5
                             "#"",HISTDATE,"#",":                       * 6
                             "#"",MRMAFILM,"#",":                       * 7
                             "#"",DESCHOME,"#",":                       * 8
                             "#"",HISTREQB,"#",":                       * 9
                             "#"",MRMAHHOS,"#",";                       * 10
MRTTAB55  MATCH     MRMAHHOS,MRMACHOS
          IF        @EQUAL
            WRITE     HTMLFILE;"#"",MRMACHOS,"#",";                     * 11
          ELSE
....        WRITE     HTMLFILE;"#"",STTRED,MRMACHOS,ENDRED,"#")"        * 11
            PACK      KEY30,MRMACHOS,SP30      * default to black     *I-259106
            MOVE      SP3,PTHSHHOS
            PACK      KEY3,MRMACHOS            * current hosp
            CALL      RDPTHSP1
            MATCH     PTHSHHOS,MRMAHHOS        * same as the home hospital?
            IF        !@EQUAL
              PACK      KEY30,STTRED,MRMACHOS,ENDRED    * red
            ELSE
              UNPACK    SP20,TCINDC1,TCINDC2,TCINDC3,TCINDC4
....          PACK      KEY5,CATTY,MRCNRCTY
              PACK      KEY5,CATTY,PTHSRCTY
              CALL      RDCODE1
              MATCH     "B",TCINDC1
              IF        !@EQUAL
                PACK      KEY30,STTRED,MRMACHOS,ENDRED  * red
              ENDIF
            ENDIF
            WRITE     HTMLFILE;"#"",KEY30,"#",";                        * 11
          ENDIF
.
          WRITE     HTMLFILE;"#"",HISTCOMM,"#")"                        * 12
.
          GOTO      MRTTAB10
.
MRTTAB60  MOVE    "1",KEY1
          WRITE   HTMLFILE;*+,"<data><documentLink>",HTMLLINK,"</documentLink>":
                             "<documentType>",DESCDOCM,"</documentType>":
                             "<volume>",MRMAVOLN,"</volume>":
                             "<currentLocation>",DESCCLOC,"</currentLocation>":
                             "<status>",STATDESC,"</status>":
                             "<comments>",MRMACOMM,"</comments>":
                             "<movementDate>",HISTDATE,"</movementDate>":
                             "<microfilm>",MRMAFILM,"</microfilm>":
                             "<homeLocation>",DESCHOME,"</homeLocation>":
                             "</data>"
.
          GOTO      MRTTAB10
.
MRTTAB99  RETURN
.------------------------------------------------------------
. Display Previous Address Details
.------------------------------------------------------------
DISPRA00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          PACK      KEY24,URNUMBER,Z70
          CALL      RDSPADD1
DISPRA10  CALL      RDPPADD1
          BRANCH    OVRCD,DISPRA99
.
          MATCH     URNUMBER,PAURNO
          GOTO      DISPRA99 IF NOT EQUAL
.
          UNPACK    PADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          PACK      KEY10,PTPAWEBU                                     *I-49647
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      PTPAWEBU,WBSENAM
          ENDIF
.
          MOVE      URNUMBER,KEY8
          REP       " +",KEY8 
.
          WRITE     HTMLFILE;"<tr><td width=93 nowrap>":
                       "<A HREF='javascript:ShowDetail01(#"",LINKPRG,"#.pbl":
                       "?reportno=",LINKREP:
                       "&template=",LINKTEM:
                       "&patpa001=",KEY8:
                       "&patpa002=",PADATE:
                       "&patpa003=",PATIME,"#")'>":
                       "<img src=../images/MaintenanceIcon.gif hspace=4":
                       " border=0 align=absmiddle></a>":
                       CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>":
                       "<td width=340>&nbsp;",PAADD1,SP1,PAADD2,SP1,PASUBR:
                       SP1,PAADD4,SP1,PAPOST,"</td>":
                       "<td width=120>&nbsp;",PATELEP,"</td>":
                       "<td width=200>&nbsp;",PTPAMOBL,"</td>":
                       "<td>&nbsp;",WBSENAM,"</td></tr>":
                       "<tr>":
                       "<td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;":
                       "&nbsp;",PATIME,"</td><td>&nbsp;</td>":
                       "<td>&nbsp;",PATELEB,"</td>":
                       "<td>&nbsp;",PTPAEMAL,"</td>":
                       "<td>&nbsp;</td></tr>"
          GOTO      DISPRA10
.     
DISPRA99  RETURN
.-------------------------------------------------------------------------------
. Display Previous Address Details
.-------------------------------------------------------------------------------
DISPRH00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          PACK      KEY27,URNUMBER,Z70
          CALL      RSPMDAU1
DISPRH10  CALL      RPPMDAU1
          BRANCH    OVRCD,DISPRH99
.
          MATCH     URNUMBER,PMDEURNO
          GOTO      DISPRH99 IF NOT EQUAL
.
          MATCH     "002",PMDERTYP
          GOTO      DISPRH10 IF NOT EQUAL
.
          UNPACK    PMDECDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          PACK      KEY10,PMDEFL01
          CALL      RDPMHCP1
          IF        OVRCD=1
            MOVE      SP70,DOCFNAME
          ELSE
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
          ENDIF
.
          PACK      KEY10,PMDEFL02
          MATCH     SP70,PMDEFL03
          GOTO      DISPRH20 IF EQUAL
.
          PACK      KEY12,KEY10,PMDEFL03
          CALL      RDPMHCG1
          BRANCH    OVRCD,DISPRH20
.
DISPRH20  PACK      KEY12,KEY10,Z70
          CALL      RSPMHCG1
          CALL      RPPMHCG1
          BRANCH    OVRCD,DISPRH30
          MATCH     PMDEFL02,PMHGPRAC
          GOTO      DISPRH40 IF EQUAL
.
DISPRH30  MOVE      "Not Found",PMHGPNAM
.
DISPRH40  PACK      KEY10,PMDECUID
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      PMDECUID,WBSENAM
          ENDIF
.
          MOVE      URNUMBER,KEY8
          REP       " +",KEY8
.
          WRITE     HTMLFILE;"<tr><td width=140 nowrap>":
                       "<a href='javascript:ShowDetail01(#"",LINKPRG,"#.pbl":
                       "?reportno=",LINKREP:
                       "&template=",LINKTEM:
                       "&pmsda001=",KEY8:
                       "&pmsda002=",PMDECDAT:
                       "&pmsda003=",PMDECTIM:
                       "&pmsda004=",PMDERTYP,"#")'>":
                       "<img src=../images/MaintenanceIcon.gif hspace=4":
                       " border=0 align=absmiddle></a>":
                       CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP1,PMDECTIM,"</td>":
                       "<td width=220>&nbsp;",DOCFNAME,"</td>":
                       "<td width=240>&nbsp;",PMHGPNAM,"</td>":
                       "<td>&nbsp;",WBSENAM,"</td></tr>"
          GOTO      DISPRH10
.
DISPRH99  RETURN
.------------------------------------------------------------
. Table of Appointments
.------------------------------------------------------------
APPTAB00  PACK      KEY36,URNUMBER,SP70    * Clinic Session Booking Table A
          CALL      RDSBOKA3
APPTAB10  CALL      RDKBOKA3
          BRANCH    OVRCD,APPTAB90
.
          MATCH     OBAURNO,URNUMBER
          GOTO      APPTAB90 IF NOT EQUAL
.
          MATCH     SP8,FILTFDAT
          GOTO      APPTAB12 IF EQUAL
.
          MATCH     FILTFDAT,OBADATE
          GOTO      APPTAB10 IF LESS        * bypass Bookings before "Start date
.
APPTAB12  MATCH     SP8,FILTTDAT
          GOTO      APPTAB15 IF EQUAL
.
          MATCH     OBADATE,FILTTDAT
          GOTO      APPTAB10 IF LESS        * bypass Bookings after "To date"
.
APPTAB15  COMPARE   THREE,OBASTAT
          GOTO      APPTAB10 IF EQUAL
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1               * Clinic Session Booking Table B
          BRANCH    OVRCD,APPTAB10
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDPMVX11              * Clinic Session Booking Table B
          IF        OVRCD=1
            CALL      CLPMSVX1
          ENDIF
.
          MOVE      SP70,DISPCLHR
          MATCH     "1",OTBBCLHR
          IF        @EQUAL
            MOVE      "Yes",DISPCLHR      * Clinical Hight Risk
          ENDIF
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDPTVIS1
          IF        OVRCD=1
            CALL      CLPATVIS
            MOVE      OBAOUTNO,PVIBILL
            MOVE      OBADATE,PVIDATE
            MOVE      "2",PVITYPE
            MOVE      " 2",PTVITYPE
          ENDIF
.
          PACK      KEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
          CLEAR     HTMLLINK
          APPEND    "javascript:AppointLink('",HTMLLINK
          APPEND    KEY28,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          PACK      KEY12,OBASITE,OBACTYP,SP70
          CALL      RDCTYA1             * Clinic Type Table
          IF        OVRCD=1
            MOVE      SP70,OCTDESC
          ENDIF
.
          PACK      KEY20,OBASITE,OBACLIN,OBADATE,SP70
          CALL      RDCLIA1             * Clinic Table
          IF        OVRCD=0
            GOTO      APPTAB20
          ENDIF
.
          PACK      KEY20,OBASITE,OBACLIN,OBADATE,Z70
          CALL      RDSCLIA1          * Read Clinic Record
          CALL      RDPCLIA1          * Read Clinic Record
          BRANCH    OVRCD,APPTAB10
.
          MATCH     OBASITE,OCASITE
          GOTO      APPTAB10 IF NOT EQUAL
.
          MATCH     OBACLIN,OCACLIN
          GOTO      APPTAB10 IF NOT EQUAL
.
APPTAB20  MOVE      "OZ",CATEGORY
          MOVE      OTBBOUTC,CODE
          CALL      GETCOD00
          MOVE      TDESC,OUTCDESC
.
          MOVE      "CV",CATEGORY
          MOVE      OBAVISIT,CODE
          CALL      GETCOD00
          MOVE      TDESC,VTYPDESC
.
          MOVE      ZERO,CHARTREV        * No                 *T0838668-start
          MATCH     ANSC,TCINDC8         * Chart Review Slot
          IF        @EQUAL
            MOVE     ONE,CHARTREV        * Yes
          ENDIF                                               *T0838668-end
.
          UNPACK    OBADATE,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
          LOAD      DAYNAM3,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
.
          MOVE      ZERO,VISCMFLG
          PACK      HTMLLNK2,SP70,SP70
.
          MOVE      OBAOUTNO,KEY8
          PACK      KEY17,KEY8,VSCMTTYP,Z70
.
          CALL      RSVSMDT1
APPTAB22  CALL      RPVSMDT1
          BRANCH    OVRCD,APPTAB24
.
          MATCH     KEY8,VSMDVISN
          GOTO      APPTAB24 IF NOT EQUAL
.
          MATCH     VSCMTTYP,VSMDTYPE
          GOTO      APPTAB24 IF NOT EQUAL
.
          MATCH     "1",VSMDDELT          * is comment deleted
          GOTO      APPTAB22 IF EQUAL
.
          MOVE      ONE,VISCMFLG
          CLEAR     HTMLLNK2
          APPEND    "javascript:ViewBookNotes('",HTMLLNK2
          APPEND    OBAURNO,HTMLLNK2
          APPEND    "','",HTMLLNK2
          APPEND    OBAOUTNO,HTMLLNK2
          APPEND    "')",HTMLLNK2
          RESET     HTMLLNK2
.
APPTAB24  WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",DAYNAM3,"#",":
                             "#"",OBADATE,OBATIME,"#",":
                             "#"",OCTDESC,"#",":
                             "#"",OCADESC,"#",":
                             "#"",OUTCDESC,"#",":
                             "#"",VTYPDESC,"#",";
          BRANCH    OBASTAT,APPTAB51,APPTAB52,APPTAB53,APPTAB54,APPTAB55:
                            APPTAB56
          WRITE     HTMLFILE;"#" #",#"";
          GOTO      APPTAB60
.
APPTAB51  WRITE     HTMLFILE;"#"Booked#",#"";
          GOTO      APPTAB60
APPTAB52  WRITE     HTMLFILE;"#"Not Used#",#"";
          GOTO      APPTAB60
APPTAB53  WRITE     HTMLFILE;"#"Extended Slot#",#"";
          GOTO      APPTAB60
APPTAB54  WRITE     HTMLFILE;"#"Attended#",#"";
          GOTO      APPTAB60
APPTAB55  WRITE     HTMLFILE;"#"DNA#",#"";
          GOTO      APPTAB60
APPTAB56  WRITE     HTMLFILE;"#"Suspended#",#"";
          GOTO      APPTAB60
.
APPTAB60  CALL      VCDM0000                * Visit based CDM
          WRITE     HTMLFILE;"#",#"",VISCMFLG,"#",":
                             "#"",HTMLLNK2,"#",":
                             "#"",PMVXMHOS,"#",":
                             "#"",DISPCLHR,"#",":
                             "#"",CHARTREV,"#");"          *T0838668
.
          PACK      KEY11,OBAOUTNO,SP70
          CALL      RDSRSHA1         * Rescheduled Bookings Table
APPTAB70  CALL      RDKRSHA1
          BRANCH    OVRCD,APPTAB10
.
          MATCH     OBAOUTNO,OPRSOUTN
          GOTO      APPTAB10 IF NOT EQUAL
.
          PACK      KEY20,OPRSSITE,OPRSCLIN,OPRSDATE,SP70
          CALL      RDCLIA1         * Clinic Table
          IF        OVRCD = 0
            GOTO      APPTAB76
          ENDIF
.
          PACK      KEY20,OPRSSITE,OPRSCLIN,OPRSDATE,Z70
          CALL      RDSCLIA1          * Read Clinic Record
          CALL      RDPCLIA1          * Read Clinic Record
          BRANCH    OVRCD,APPTAB75
.
          MATCH     OPRSSITE,OCASITE
          GOTO      APPTAB76 IF EQUAL
.
          MATCH     OPRSCLIN,OCACLIN
          GOTO      APPTAB76 IF EQUAL
.
APPTAB75  MOVE      "No Valid Clinic at Date",OCADESC
.
APPTAB76  MOVE      "RR",CATEGORY                                      *I-51304
          MOVE      OPRSREAS,CODE
          CALL      GETCOD00                                       *end I-51304
.
          PACK      KEY14,OPRSOPER,SP70
          CALL      RSWBSE3
          CALL      RKWBSE3                 * get rescheduled by user name
          BRANCH    OVRCD,APPTAB79
.
          MATCH     OPRSOPER,WBSEPCD
          GOTO      APPTAB80 IF EQUAL
.
APPTAB79  MOVE      OPRSOPER,WBSENAM

APPTAB80  CLEAR     HTMLLNKL
          APPEND    "javascript:alert('Appointment Rescheduled to ",HTMLLNKL
          UNPACK    OPRSNDAT,CCENT,CYEAR,CMON,CDAY
          APPEND    OPRSNTIM,HTMLLNKL
          APPEND    SP1,HTMLLNKL
          APPEND    CDAY,HTMLLNKL
          APPEND    "/",HTMLLNKL
          APPEND    CMON,HTMLLNKL
          APPEND    "/",HTMLLNKL
          APPEND    CCENT,HTMLLNKL
          APPEND    CYEAR,HTMLLNKL
          APPEND    "\\nReason: ",HTMLLNKL                            *I-51304
          APPEND    TDESC,HTMLLNKL                                     *I-51304
.
          MOVE      WBSENAM,JAVSNAME
          CALL      JAVDES00
          APPEND    "\\nOperator: ",HTMLLNKL
          APPEND    JAVSNAME,HTMLLNKL
.
          APPEND    "\\nRescheduled Date: ",HTMLLNKL
          UNPACK    OPRSRDTE,CCENT,CYEAR,CMON,CDAY
          APPEND    SP1,HTMLLNKL
          APPEND    CDAY,HTMLLNKL
          APPEND    "/",HTMLLNKL
          APPEND    CMON,HTMLLNKL
          APPEND    "/",HTMLLNKL
          APPEND    CCENT,HTMLLNKL
          APPEND    CYEAR,HTMLLNKL
          APPEND    " at ",HTMLLNKL
          APPEND    OPRSRTIM,HTMLLNKL
          APPEND    "')",HTMLLNKL
          RESET     HTMLLNKL
.
          UNPACK    OPRSDATE,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
          LOAD      DAYNAM3,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
.
          PACK      KEY18,OPRSSITE,OPRSCLIN,WEEKDAY,OPRSSTRT,SP70
          CALL      RDMASA1          * Clinic Master Table A
          BRANCH    OVRCD,APPTAB10
.
          MOVE      OMATYP,OTHECTYP
          MOVE      OTMALTYP,OTHELTYP
.
          PACK      KEY25,OPRSSITE,OPRSCLIN,OPRSDATE,OPRSSTRT,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,APPTAB85

          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,APPTAB85
.
APPTAB85  PACK      KEY12,OTHESITE,OTHECTYP,SP70
          CALL      RDCTYA1          * Clinic Type Table
          IF        OVRCD=1
            MOVE      SP70,OCTDESC
          ENDIF
.
          MOVE      ZERO,VISCMFLG           
          PACK      HTMLLNK2,SP70,SP70
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLNKL,"#",":
                             "#"",DAYNAM3,"#",":
                             "#"",OPRSDATE,OPRSTIME,"#",":
                             "#"",OCTDESC,"#",":
                             "#"",OCADESC,"#",":
                             "#"",OUTCDESC,"#",":
                             "#"",VTYPDESC,"#",":
                             "#"Rescheduled#",#"";
.
          CALL      VCDM0000                * Visit based CDM
          WRITE     HTMLFILE;"#",#"",VISCMFLG,"#",":
                             "#"",HTMLLNK2,"#",":
                             "#"",PMVXMHOS,"#",":
                             "#"",DISPCLHR,"#",":
                             "#"",CHARTREV,"#");"          *T0838668
.
          GOTO      APPTAB70
.
APPTAB90  
APPTAB99  RETURN
.
.------------------------------------------------------------
. Format Doctors Name (for Javascript)
.*** format the surname and given name by changing any ' to %60
.---------------------------------------------------------------
JAVDES00  SCAN      "'",JAVSNAME             * find any apostrophies
          GOTO      JAVDES99 IF NOT EQUAL
.
          MOVE      JAVSNAME,ENDNAME
          REP       "' ",ENDNAME             * remove the apostrophy
.
          LENSET    JAVSNAME
          RESET     JAVSNAME                 * get all characters before '
          MOVE      JAVSNAME,STRTNAME
.
          REP       "'%",STRTNAME
          STRIP     STRTNAME
          PACK      JAVSNAME,STRTNAME,SIXTY,ENDNAME,SP70 * formatted surname
.
JAVDES99  RETURN
.------------------------------------------------------------
. Outpatient Appointment Schedule list
.------------------------------------------------------------
APPSCH00  CALL      IBACLOCK
          PACK      TODAY,CCC,CYY,CMM,CDD
          REP       " 0",TODAY
.
          PACK      KEY36,URNUMBER,SP70    * Clinic Session Booking Table A
          CALL      RDSBOKA3
APPSCH10  CALL      RDKBOKA3
          BRANCH    OVRCD,APPSCH99
.
          MATCH     OBAURNO,URNUMBER
          GOTO      APPSCH99 IF NOT EQUAL
.
          MATCH     SP8,FILTFDAT
          GOTO      APPSCH12 IF EQUAL
          MATCH     FILTFDAT,OBADATE
          GOTO      APPSCH10 IF LESS        * bypass Bookings before "Start date
APPSCH12  MATCH     SP8,FILTTDAT
          GOTO      APPSCH15 IF EQUAL
          MATCH     OBADATE,FILTTDAT
          GOTO      APPSCH10 IF LESS        * bypass Bookings after "To date"
.
.                    Status  Booked   N/Used   Ex.Slot  Attended
APPSCH15  BRANCH    OBASTAT,APPSCH30,APPSCH10,APPSCH10,APPSCH20
          GOTO      APPSCH10
.
APPSCH20  MATCH     OBADATE,TODAY
          GOTO      APPSCH10 IF LESS        * "attended" in the future (??)
.
APPSCH30  MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1               * Clinic Session Booking Table B
          BRANCH    OVRCD,APPSCH10
.
          MOVE      SP70,DISPCLHR
          MATCH     "1",OTBBCLHR
          IF        @EQUAL
            MOVE      "Yes",DISPCLHR      * Clinical Hight Risk
          ENDIF
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDPMVX11              * Read visit extn to get hospital
          BRANCH    OVRCD,APPSCH10
.
          MOVE      SP70,OCTDESC
          PACK      KEY12,OBASITE,OBACTYP,SP70
          CALL      RDCTYA1             * Clinic Type Table
.
          PACK      KEY20,OBASITE,OBACLIN,OBADATE,SP70
          CALL      RDCLIA1
          IF        OVRCD=1
            PACK      KEY20,OBASITE,OBACLIN,OBADATE,Z70
            CALL      RDSCLIA1          * Read Clinic Record
            CALL      RDPCLIA1          * Read Clinic Record
            BRANCH    OVRCD,APPSCH10
.
            MATCH     OBASITE,OCASITE
            GOTO      APPSCH10 IF NOT EQUAL
.
            MATCH     OBACLIN,OCACLIN
            GOTO      APPSCH10 IF NOT EQUAL
          ENDIF
.
APPSCH45  UNPACK    OBADATE,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
          LOAD      DAYNAM3,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
.
          MOVE      ZERO,VISCMFLG
          MOVE      ZERO,URCOMFLG
          PACK      HTMLLINK,SP70,SP70
.
          MOVE      OBAOUTNO,KEY8    
          PACK      KEY17,KEY8,VSCMTTYP,Z70
.
          CALL      RSVSMDT1
APPSCH46  CALL      RPVSMDT1
          BRANCH    OVRCD,APPSCH47
.
          MATCH     KEY8,VSMDVISN
          GOTO      APPSCH47 IF NOT EQUAL
.
          MATCH     VSCMTTYP,VSMDTYPE
          GOTO      APPSCH47 IF NOT EQUAL
.
          MATCH     "1",VSMDDELT          * is comment deleted
          GOTO      APPSCH46 IF EQUAL
.
          MOVE      ONE,VISCMFLG
          CLEAR     HTMLLINK
          APPEND    "javascript:ViewBookNotes('",HTMLLINK
          APPEND    OBAURNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    OBAOUTNO,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
APPSCH47  MOVE      OBAURNO,KEY8
          PACK      KEY17,KEY8,URCMTTYP,Z70
.
          CALL      RSPMUCH1
APPSCH48  CALL      RPPMUCH1
          BRANCH    OVRCD,APPSCH49
.
          MATCH     KEY8,PMUHURNO
          GOTO      APPSCH49 IF NOT EQUAL
.
          MATCH     URCMTTYP,PMUHCTYP
          GOTO      APPSCH49 IF NOT EQUAL
.
          MATCH     "1",PMUHDELT            * is comment deleted
          GOTO      APPSCH48 IF EQUAL
.
          MOVE      ONE,URCOMFLG
          CLEAR     HTMLLNK2
          APPEND    "javascript:ViewURNotes('",HTMLLNK2
          APPEND    OBAURNO,HTMLLNK2
          APPEND    "','",HTMLLNK2
          APPEND    OBAOUTNO,HTMLLNK2
          APPEND    "')",HTMLLNK2
          RESET     HTMLLNK2
.
APPSCH49  CALL      STDUR000                * Calculate booking end time
.
          UNPACK    OBADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          CLEAR     KEY29
          APPEND    KEY11,KEY29
          APPEND    " at ",KEY29
          APPEND    OBATIME,KEY29
          APPEND    " to ",KEY29
          APPEND    ENDDTIME,KEY29
          RESET     KEY29
.
          MOVE      "CV",CATEGORY
          MOVE      OBAVISIT,CODE
          CALL      GETCOD00
.
          MOVE      ZERO,CHARTREV        * No                 *T0838668-start
          MATCH     ANSC,TCINDC8         * Chart Review Slot
          IF        @EQUAL
            MOVE     ONE,CHARTREV        * Yes
          ENDIF                                               *T0838668-end
.
          WRITE     HTMLFILE;"t.addRow(#"",SP1,"#",":
                             "#"",DAYNAM3,"#",":
                             "#"",OBADATE,OBATIME,"#",":
                             "#"",OCTDESC,"#",":
                             "#"",OCADESC,"#",":
                             "#"",VISCMFLG,"#",":
                             "#"",TDESC,"#",";
.
          BRANCH    OBASTAT,APPSCH51,APPSCH50,APPSCH50,APPSCH54
.
APPSCH50  WRITE     HTMLFILE;"#" #",";
          GOTO      APPSCH60
.
APPSCH51  WRITE     HTMLFILE;"#"Booked#",";
          GOTO      APPSCH60
APPSCH54  WRITE     HTMLFILE;"#"Attended#",";
          GOTO      APPSCH60
.
APPSCH60  WRITE     HTMLFILE;"#"",URCOMFLG,"#",":
                             "#"",HTMLLINK,"#",":
                             "#"",HTMLLNK2,"#",":
                             "#"",KEY29,"#",":
                             "#"",PMVXMHOS,"#",":
                             "#"",DISPCLHR,"#",":
                             "#"",CHARTREV,"#");"           *T0838668
          GOTO      APPSCH10
.
APPSCH99  RETURN
.
.------------------------------------------------------------
.                         STDUR000    called by: PRDT0000
.              Calculate booking end time
.------------------------------------------------------------
STDUR000  PACK      KEY5,ANSC,ANSV,OBAVISIT,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      ONE,TCFORM6
          ENDIF
          MOVE      ZERO,LOOPCNTR
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RDSESA1
          IF        OVRCD=1
            CALL      CLRSES00
          ENDIF
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          IF        OVRCD=1
            CALL     CLOUTHED
          ENDIF
.
          UNPACK    OBATIME,KEY2,KEY1,MIN   * HH:MM
STDUR100  MOVE      KEY2,HOUR               * HH to Form
          MOVE      MIN,MINUTES             * MM to Form
.
          ADD       OTHEDURN,MINUTES   * Add Duration time to minutes
          ASSIGN    MINUTES-SIXTY,TIME
          IF        TIME >= 0
            IF        TIME >= 60
              MOVE      TIME,MINUTES
              ASSIGN    MINUTES-SIXTY,TIME
              MOVE      TIME,MINTIME
              MOVE      MINTIME,MIN
              ADD       TWO,HOUR                 * Add Two Hours
            ELSE
              MOVE      TIME,MINTIME
              MOVE      MINTIME,MIN
              ADD       ONE,HOUR                 * Add One Hour
            ENDIF
          ELSE
            MOVE      MINUTES,MINTIME            * No Hour Change
            MOVE      MINTIME,MIN
          ENDIF
.
          PACK      ENDDTIME,HOUR,COLON,MIN  * pack time save variable (HH:MM)
          REPLACE   " 0",ENDDTIME            * replace spaces with zero
.
          ADD       ONE,LOOPCNTR
.
          COMPARE   TCFORM6,LOOPCNTR
          IF        @LESS
            UNPACK    ENDDTIME,KEY2,KEY1,MIN   * HH:MM
            GOTO      STDUR1000
          ENDIF
.
STDUR999  RETURN
.------------------------------------------------------------
. Get clinic type description for re-scheduled bookings
.------------------------------------------------------------
RCTY0000  MOVE      SP70,UNITDESC
.
          PACK      KEY25,OPRSSITE,OPRSCLIN,OPRSDATE,OPRSSTRT,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,RCTY9999
.
          PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,RCTY9999          
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,RCTY9999
.
          PACK      KEY12,OTHESITE,OTHECTYP,SP70
          CALL      RDCTYA1
          BRANCH    OVRCD,RCTY9999          
.
          MOVE      OCTDESC,UNITDESC
          MOVE      OTHECTYP,UNITCODE
.          
RCTY9999  RETURN
.   
.------------------------------------------------------------
. Get clinic type description for cancelled bookings
.------------------------------------------------------------
CCTY0000  MOVE      SP70,UNITDESC
.
          PACK      KEY25,OPCNSITE,OPCNCLIN,OPCNDATE,OPCNSTRT,SP70
          CALL      RDSESA1
          IF        OVRCD=1
            UNPACK    OPCNDATE,CCENT,CYEAR,CMON,CDAY
            CALL      DAYOFWEK
.
            PACK      KEY18,OPCNSITE,OPCNCLIN,WEEKDAY,OPCNSTRT,SP70
            CALL      RDMASA1
            BRANCH    OVRCD,CCTY9999
.
            MOVE      OMASITE,OTHESITE      * Use clinic master site
            MOVE      OTMAHOSP,OTHEHOSP     * Use clinic master hospital
            MOVE      OMATYP,OTHECTYP       * Use clinic master clinic type
            GOTO      CCTY2000
          ENDIF
.
          PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,CCTY9999
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,CCTY9999
.
CCTY2000  PACK      KEY12,OTHESITE,OTHECTYP,SP70
          CALL      RDCTYA1
          BRANCH    OVRCD,CCTY9999
.
          MOVE      OCTDESC,UNITDESC
          MOVE      OTHECTYP,UNITCODE
.
CCTY9999  RETURN
.
.------------------------------------------------------------
. Display visit details according to the visit type
.------------------------------------------------------------
VISITS00  MOVE      ZERO,SHOWFRMT           * Show Format (0)Standard or(1)Kids 
          MOVE      ZERO,OUTORDER           * OUtpatient display order
          MOVE      ZERO,DEFAULTA           * Default to all
          MOVE      ZERO,SHOWMEDL           * Show update medical record 0=No
          MOVE      ZERO,NMDSLIST           * Show NMDS list
          MOVE      ZERO,EMREVENT
          MOVE      ZERO,EMRVSTYP
          MOVE      ZERO,SHOWCDMI           * Show event level CDM Icons
          MOVE      ZERO,SHOWTREQ           * Show theatre requests
          MOVE      ZERO,SHOWCARE           * Show Care Type
          MOVE      ZERO,SHOWPROB           * Show Problem
.
          MOVE      ONE,SHOWFLAG            * Show no more visits message
          UNPACK    DIM127,D1,SHOWFRMT,DIM127
          UNPACK    DIM127,D1,OUTORDER,DIM127
          UNPACK    DIM127,D1,DEFAULTA,DIM127
          UNPACK    DIM127,D1,SHOWMEDL,DIM127
          UNPACK    DIM127,D1,NMDSLIST,DIM127
          UNPACK    DIM127,D1,SHOWCDMI,DIM127
          UNPACK    DIM127,D1,SHOWTREQ,DIM127
          UNPACK    DIM127,D1,SHOWCARE,DIM127
          UNPACK    DIM127,D1,SHOWPROB,DIM127
.
          MATCH     "1",PTCNDCDM
          IF        !@EQUAL
            MOVE      ZERO,SHOWCDMI
          ENDIF
.
          MATCH     "1",NMDSLIST
          IF        @EQUAL
            MOVE      TWO,FILTVTYP
          ENDIF
.
          MATCH     "1",NOCANVIS
          IF        @EQUAL
            MOVE      ONE,FILTVTYP
          ENDIF
.
          IF        NORECORD=0
            MOVE    "10",NORECORD           * Numb of records=0 Default to 10
          ENDIF
          MOVE      ZERO,RECNUMB            * Init Number of records Read
          MOVE      ZERO,DISNUMB            * Init number of records output
. 
          COMPARE   "1",SRCHVIEW            * Allied Health Visit Search
          IF        @EQUAL
            COMPARE   ZERO,FILTVTYP         * Default filter to All visits
            IF        @EQUAL
              MOVE      ONE,FILTVTYP
              MOVE      "9",NORECORD        * Numb of records=0 Default to 9
            ENDIF
          ENDIF
.
          MATCH     "1",DEFAULTA            * Default to all ?
          IF        @EQUAL
            COMPARE   ZERO,FILTVTYP         * Default filter to All visits
            IF        @EQUAL
              MOVE      ONE,FILTVTYP
            ENDIF
          ENDIF
.
          COMPARE   ONE,FILTVTYP
          IF        @EQUAL
            CALL     ALLTAB00               * All visit file visits
            GOTO     VISITS99
          ENDIF
.       
          COMPARE   TWO,FILTVTYP
          IF        @EQUAL
            CALL     ALLVIS00               * Inpatient Visits by key4
            GOTO     VISITS99
          ENDIF
.
          COMPARE   THREE,FILTVTYP
          IF        @EQUAL
            CALL      ALLOUT00
          ENDIF
.
          COMPARE   FOUR,FILTVTYP
          IF        @EQUAL
            MOVE     ONE,EMRVSTYP
            CALL     ALLVIS00               * Emergency Visits by key4
            MOVE     ZERO,EMRVSTYP
.
            MOVE     ONE,EMREVENT           * display Emergency events
            MOVE     " 9",D2
            PACK     KEY26,URNUMBER,D2,Z70
            CALL     ALLVIS00               * Emergency events
            MOVE     ZERO,EMREVENT
.
            GOTO     VISITS99
          ENDIF
.
          COMPARE   FIVE,FILTVTYP
          IF        @EQUAL
            MATCH     "1",SHOWTREQ
            IF        @EQUAL
              CALL      ALLREQ00               * Theatre Bookings
              COMPARE   DISNUMB,NORECORD      * correct site open in main1000
              GOTO      VISITS99 IF EQUAL
            ENDIF
            CALL      ALLBOK00
            GOTO      VISITS99
          ENDIF
.
          COMPARE   SIX,FILTVTYP
          IF        @EQUAL
            CALL     ALLVIS00               * Allied Health Visits by key4
            GOTO     VISITS99
          ENDIF
.
          COMPARE   SEVEN,FILTVTYP
          IF        @EQUAL
            CALL     ALLVIS00               * Event Visits by key4
            GOTO     VISITS99
          ENDIF
.
          COMPARE   EIGHT,FILTVTYP
          IF        @EQUAL
            CALL     ALLWAT00               * Waiting List
            GOTO     VISITS99
          ENDIF
.
          COMPARE   NINE,FILTVTYP
          IF        @EQUAL
            CALL      ALLCAD00              * Cancelled Admissions
            GOTO      VISITS99
          ENDIF
.
          COMPARE   TEN,FILTVTYP
          IF        @EQUAL
            CALL      CHKSIT00              * Outpatient bookings all sites
            GOTO      VISITS99
          ENDIF
.
          COMPARE   TEN1,FILTVTYP
          IF        @EQUAL
            CALL     ALLVIS00               * Allied Health Visits by key4
            GOTO     VISITS99               * Waiting and Active
          ENDIF
.
          COMPARE   TEN2,FILTVTYP
          IF        @EQUAL
            CALL     ALLCAN00               * All Cancelled Visits
            GOTO     VISITS99
          ENDIF
.
VISITS99  RETURN
+
.------------------------------------------------------------
. Output all visit file related visit in a table
.------------------------------------------------------------
ALLTAB00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          MATCH     "       0",URNUMBER
          GOTO      ALLTAB99 IF EQUAL
.
          COMPARE   ZERO,FILTVTYP
          GOTO      ALLTAB99 IF EQUAL
.
          PACK      KEY24,URNUMBER,Z70
          CALL      RDSVISA2
ALLTAB10  CALL      RDPVISA2
          BRANCH    OVRCD,ALLTAB95
.
          MATCH     URNUMBER,PVIURNO
          GOTO      ALLTAB95 IF NOT EQUAL
.
          MOVE      SP70,DOCINDIC
.
          PACK      KEY8,PVIBILL,SP70
          CALL      RDPMVX11
          IF        OVRCD=1
            IF        ARCFLAG=1
              MOVE      PVIBILL,KEY8
              CALL      RDARVX11
              IF        OVRCD<>1
                CALL      MVPMAR00
              ENDIF
            ENDIF
          ENDIF
          BRANCH    OVRCD,ALLTAB10
.
          MOVE      ONE,HOSPFLAG
          IF        IBCNMHOS=1
            MATCH     SP70,FILTHOSP
            IF        !@EQUAL
              MATCH     FILTHOSP,PMVXMHOS
              GOTO      ALLTAB10 IF NOT EQUAL
            ELSE
              PACK      KEY13,USERID,SP70              * All hospital access
              CALL      RDMLSEC1
              IF        OVRCD=1
                PACK      KEY13,USERID,PMVXMHOS,SP70   * This hospital access
                CALL      RDMLSEC1
                BRANCH    OVRCD,ALLTAB10
              ENDIF
            ENDIF
            MATCH    WBSEHOSP,PMVXMHOS
            IF       !@EQUAL
              MOVE      ZERO,HOSPFLAG
            ENDIF
          ENDIF
.
          ADD       ONE,VISCOUNT
          MOVE      SP70,DESCSNAG
.
ALLTAB20  ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      ALLTAB10
          ENDIF
.
          MOVE      ONE,EPSCD001         * Episode number?
          MOVE      SP70,SAVEPKEY        * Clear save episode key
          MOVE      ZERO,GENCHCDS
          IF        ASTAT = 3 & MRCNEPSC = 1
            MOVE      ONE,GENCHCDS       * set "Generate Discharge patchcof"
          ENDIF
.
          CALL      MRTCOD00             * Medical Record Coding Details
          BRANCH    EXIT,ALLTAB10
.
          COMPARE   ZERO,CODESTAT        * Do not display Coder id if not coded
          IF        @EQUAL
            MOVE      SP70,CODERNAM
          ELSE
            MOVE      SP70,CODERNAM
            PACK      KEY10,PTEDUSID,SP70
            CALL      RDWBSE1
            IF        OVRCD=0
              MOVE      WBSENAM,CODERNAM
            ELSE
              PACK      KEY14,PTEDOPER,SP70
              CALL      RSWBSE3
              CALL      RKWBSE3
              IF        OVRCD=0
                MATCH     PTEDOPER,WBSEPCD
                IF        @EQUAL
                  MOVE      WBSENAM,CODERNAM
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          CALL      GETVIS00             * Get Visit Details
          BRANCH    EXIT,ALLTAB10
.
          MATCH     "1",NOCANVIS
          IF        @EQUAL
            COMPARE   FIVE,ASTAT
            GOTO      ALLTAB10 IF EQUAL
          ELSE
            MATCH       "2",NOCANVIS 
            IF          @EQUAL
              COMPARE   FIVE,ASTAT
              GOTO      ALLTAB10 IF EQUAL
            ENDIF
          ENDIF
.
          PACK      KEY8,PVIBILL         * Outpatient event details
          CALL      RDPMEVT1
          BRANCH    OVRCD,ALLTAB30
.
          MOVE      "EV",CATEGORY
          MOVE      PMEVEVNT,CODE
          CALL      GETCOD00
.
          MATCH     "E",TCINDC1          * emergency events
          GOTO      ALLTAB26 IF EQUAL
.
          MATCH     "I",TCINDC1          * inpatient event
          IF        @EQUAL
            PACK      KEY6,PMEVPWRD,PMEVPBED
            CALL      FWBD0000
            IF        IBCNMHOS = 1
              PACK      KEY3,PMVXMHOS
              CALL      FHOS0000
              PACK      VISTLOC,HOSPTEXT,DASH,WARDBED,SP70
            ELSE
              PACK      VISTLOC,WARDBED,SP70
            ENDIF
..          PACK      VISTLOC,PMEVPWRD,SLASH,PMEVPBED,SP70
..          IF        IBCNMHOS=1
..            PACK      VISTLOC,PMVXMHOS,DASH,PMEVPWRD,SLASH,PMEVPBED,SP70
..          ENDIF
            MOVE      PMEVCCOD,CLAIMCOD
            CALL      GETSTA00
            GOTO      ALLTAB30
          ENDIF
.
          MATCH     "O",TCINDC1
          IF        !@EQUAL
            CALL      GETSTA00
            GOTO      ALLTAB30
          ENDIF
.
          CALL      GETSTA00
          MOVE      ZERO,FORM1
          MOVE      PMEVASTT,FORM1
          LOAD      VSTATUS,FORM1,OEVSTA1,OEVSTA2
          IF        FORM1=0
            MOVE      OEVSTA0,VSTATUS
          ENDIF
.
ALLTAB26  MOVE      PMEVATIM,VISTTIME
          MOVE      PMEVCCOD,CLAIMCOD
          MOVE      PMEVCTYP,UNITCODE
.
          MATCH     SP70,PMEVCTYP
          GOTO      ALLTAB30 IF EQUAL
.
          PACK      KEY12,PMEVSITE,PMEVCTYP,SP70
          CALL      RDCTYA1
          BRANCH    OVRCD,ALLTAB30
.
          MOVE      OCTDESC,UNITDESC
          MOVE      PMEVCTYP,UNITCODE
.
ALLTAB30  CALL      CKAL0000             * Check Allied Health
          BRANCH    EXIT,ALLTAB10        * don't display
.
          CALL      MRTDES00             * Medical Record Location Details
.
          UNPACK    PVIDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          MATCH     SP70,VISTTIME
          IF        !@EQUAL
            ENDSET    DISPDATT
            APPEND    " at ",DISPDATT
            APPEND    VISTTIME,DISPDATT
            RESET     DISPDATT
          ENDIF
.
          IF        (DISNUMB%2) = 0
            MATCH     SP70,DISPCLSS
            IF        @EQUAL
              WRITE     HTMLFILE;"<tr class=TableRowOdd><td nowrap>"
            ELSE
              WRITE     HTMLFILE;"<tr class=TableRowOdd><td nowrap class=":
                                  DISPCLSS,">"
            ENDIF
          ELSE
            MATCH     SP70,DISPCLSS
            IF        @EQUAL
              WRITE     HTMLFILE;"<tr class=TableRowEven><td nowrap>"
            ELSE
              WRITE     HTMLFILE;"<tr class=TableRowEven><td nowrap class=":
                                   DISPCLSS,">"
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"<img src=../images/AppointmentIcon.gif":
                             " class=ListIcon ":
                             " onclick='linkPatient(#"":
                               URNUMBER,"#",#"":
                               PVIBILL,"#",#"":
                               PVITYPE,"#",#"":
                               SECOPT,"#",#"":
                               "#",#"":
                               PVISITE,"#",#"":
                               AAEVFLAG,"#",#"":
                               EVNTFLAG,"#",#"":
                               EMVISITE,"#",#"":
                               SP1,"#",#"":
                               SP1,"#",#"":
                               HOSPFLAG,"#");'>":
                               DISPDATT,"</td>"
.
          CLEAR     EXTVSTID
          CLEAR     CHKEXTVD
          PACK      CHKEXTVD,PVIBILL,SP70
          PROC      CHKEID00
          MATCH     KEY20,SP70
          IF        @EQUAL
            PACK      EXTVSTID,PVIBILL
          ELSE
            APPEND    PVIBILL,EXTVSTID
            APPEND    SP2,EXTVSTID
            APPEND    "<span class='TextBlue'>(",EXTVSTID
            APPEND    KEY20,EXTVSTID
            APPEND    ")</span>",EXTVSTID
          ENDIF
.          
          MATCH     "0",SHOWFRMT               * Standard
          IF        @EQUAL
            WRITE     HTMLFILE;*+,"<td>&nbsp;",VISTDAY,"</td>";
.
            CALL      THBL0000                 * Assign VISTLINK icon for Inpatient Visit with Bookings
.
            IF        PTCNHDPS=1
              MATCH     "RF",VISTTYPE
              IF        @EQUAL
                REP       " +",URNUMBER
                MOVE      PVIBILL,DIM8
                REP       " +",DIM8
                MOVE      SECOPT,DIM1
                REP       " +",DIM1
                WRITE     HTMLFILE;"<td>",VISTTYPE,"&nbsp;<img src='../images/EditIcon.gif' ":
                                   "onmouseover='this.style.cursor=#"hand#"' ":
                                   "onClick=javascript:OpenAllRef('allweb03.pbl?":
                                   "reportno=01&template=014&urnumber=",URNUMBER:
                                   "&admissno=",DIM8,"','",DIM1,"')></td>";
                REP       "+ ",URNUMBER
                REP       "+ ",DIM8
              ELSE
                WRITE     HTMLFILE;"<td>",VISTLINK,"</td>";
              ENDIF
            ELSE
              WRITE     HTMLFILE;"<td>",VISTLINK,"</td>";
            ENDIF
.
            WRITE     HTMLFILE;"<td>&nbsp;",UNITCODE,"</td>";
.
            MATCH     "1",DOCINDIC
            IF        @EQUAL
              WRITE     HTMLFILE;"<td>&nbsp;",DOCFNAME,"<br><font color=blue>&nbsp;",DOCFNAM3,"<br>&nbsp;",DOCFNAM4,"<br>&nbsp;",DOCFNAM5,"<br>&nbsp;",DOCFNAM6,"</font></td>";
            ELSE
              WRITE     HTMLFILE;"<td>&nbsp;",DOCFNAME,"</td>";
            ENDIF
.
            WRITE     HTMLFILE;"<td>&nbsp;",VISTLOC,"</td>":
                               "<td>&nbsp;",CLAIMCOD,"</td>":
                               "<td>",VSTATUS,"</td>":
                               "<td>&nbsp;",EXTVSTID,"</td>";
.
            MATCH      "1",SHOWMEDL
            IF         @EQUAL
              MATCH      SP70,VOLNDESC
              IF         @EQUAL
                WRITE      HTMLFILE;"<td>":
                                    "<input type=checkbox name=lnkadmis":
                                    " value='",PVIBILL,"'></td>"
              ELSE
                WRITE      HTMLFILE;"<td>&nbsp;":
                                    "<img src=../images/EditIcon.gif":
                                    " class=ListIcon":
                                    " onclick='LinkMedicalRec(#"":
                                    PVIBILL,"#",#"",URNUMBER,"#");'>":
                                    VOLNDESC," "
                MATCH      SP70,MRVSXKY1
                IF         @EQUAL
                  WRITE      HTMLFILE;"</td>"
                ELSE
                  WRITE      HTMLFILE;"+ </td>"
                ENDIF
              ENDIF
            ELSE
              WRITE      HTMLFILE;"<td>&nbsp;",VOLNDESC," "
              MATCH      SP70,MRVSXKY1
              IF         @EQUAL
                WRITE      HTMLFILE;"</td>"
              ELSE
                WRITE      HTMLFILE;"+ </td>"
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     "1",SHOWFRMT               * Kids
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;",VISTDAY,"</td>":
                               "<td>&nbsp;",VISTTYPE,"</td>":
                               "<td>&nbsp;",UNITDESC,"</td>":
                               "<td>&nbsp;",DOCFNAME,"</td>":
                               "<td>&nbsp;",VISTLOC,"</td>":
                               "<td>&nbsp;",CLAIMCOD,"</td>":
                               "<td>",VSTATUS,"</td>":
                               "<td>&nbsp;",EXTVSTID,"</td>"
          ENDIF
.
          MATCH     "2",SHOWFRMT               * STV
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;",VISTDAY,"</td>":
                               "<td>&nbsp;",VISTTYPE,"</td>":
                               "<td>&nbsp;",UNITDESC,"</td>":
                               "<td>&nbsp;",DOCFNAME,"</td>":
                               "<td>&nbsp;",VISTLOC,"</td>":
                               "<td>&nbsp;",CLAIMCOD,"</td>":
                               "<td>",VSTATUS,"</td>":
                               "<td>&nbsp;",EXTVSTID,"</td>";
.
            MATCH      "1",SHOWMEDL
            IF         @EQUAL
              MATCH      "10",PTVITYPE      * Can not update allied health
              IF         @EQUAL
                WRITE      HTMLFILE;"<td>&nbsp;",VOLNDESC
                MATCH      SP70,MRVSXKY1
                IF         @EQUAL 
                  WRITE      HTMLFILE;"</td>"
                ELSE
                  WRITE      HTMLFILE;"+ </td>"
                ENDIF
                GOTO       ALLTAB90
              ENDIF
.
              MATCH      SP70,VOLNDESC
              IF         @EQUAL
                WRITE      HTMLFILE;"<td>":
                                    "<input type=checkbox name=lnkadmis":
                                    " value='",PVIBILL,"'></td>"
              ELSE
                WRITE      HTMLFILE;"<td>&nbsp;":
                                    "<img src=../images/EditIcon.gif":
                                    " class=ListIcon":  
                                    " onclick='LinkMedicalRec(#"":
                                    PVIBILL,"#",#"",URNUMBER,"#");'>":
                                    VOLNDESC
              ENDIF
              MATCH        SP70,MRVSXKY1
              IF           @EQUAL
                WRITE        HTMLFILE;"</td>"
              ELSE
                WRITE        HTMLFILE;"+ </td>"
              ENDIF
            ELSE
              WRITE      HTMLFILE;"<td>&nbsp;",VOLNDESC
              MATCH      SP70,MRVSXKY1
              IF         @EQUAL
                WRITE      HTMLFILE;"</td>"
              ELSE
                WRITE      HTMLFILE;"+ </td>"
              ENDIF
            ENDIF
          ENDIF
.
ALLTAB90  MATCH     "1",SHOWCDMI
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;";
            CALL      VCDM0000                   * Visit based CDM
            WRITE     HTMLFILE;"</td>";
          ENDIF
.
          WRITE     HTMLFILE;"</tr>"

.
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      ALLTAB10 IF NOT EQUAL
          MOVE      ZERO,SHOWFLAG
.
ALLTAB95  CALL      NOMORE00                * Show no more visit message
.
ALLTAB99  RETURN
+
.------------------------------------------------------------
. Output all visit file related visit in a table by key4
. The inpatient option uses a start key for the next and prev buttons.
. All the other options use a standard record coutn next and prev.
.------------------------------------------------------------
ALLVIS00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          MATCH     "       0",URNUMBER
          GOTO      ALLVIS99 IF EQUAL
.
          COMPARE   ZERO,FILTVTYP
          GOTO      ALLVIS99 IF EQUAL
.
          BRANCH    EMREVENT,ALLVIS05       * Emergency events
.
          MOVE      ZERO,F2
          MOVE      FILTVTYP,F2
          LOAD      D2,F2,SP2,INPATVIS,OUTPVIS,EMERGVIS,SP2,ALLIVIS:
                          EVENVIS
.
          IF        F2=11
            MOVE      ALLIVIS,D2
          ENDIF
.
          PACK      KEY26,URNUMBER,D2,Z70
.
          COMPARE   TWO,FILTVTYP            * Inpatient visits
          GOTO      ALLVIS05 IF NOT EQUAL
.
          IF        PREVFLAG = 1
            MATCH     SP70,PREVVKEY
            IF        !@EQUAL
              CALL      GETPVS00            * Get previous visit key 
              MOVE      ZERO,STARTNUM       * Reset counters to zero
              MOVE      ZERO,RECNUMB
              MOVE      ZERO,DISNUMB
              MOVE      SP70,PREVVKEY
              GOTO      ALLVIS05
            ENDIF
            PACK      KEY26,URNUMBER,SP1,THREE,Z70 * Go back to start if at
            MOVE      ZERO,STARTNUM                * the end of the visit list
            MOVE      ZERO,RECNUMB
            MOVE      ZERO,DISNUMB
            GOTO      ALLVIS05
          ENDIF
.
          MATCH     SP70,NEXTVKEY
          IF        !@EQUAL
            CALL      LASTVS00              * Check to see if it the last visit
            PACK      KEY26,NEXTVKEY,SP70
            MOVE      ZERO,STARTNUM         * Reset counters
            MOVE      ZERO,RECNUMB
            MOVE      ZERO,DISNUMB
            MOVE      SP70,NEXTVKEY
            GOTO      ALLVIS05
          ENDIF
.
          PACK      KEY26,URNUMBER,SP1,THREE,Z70
ALLVIS05  CALL      RDSVISA4
ALLVIS10  CALL      RDPVISA4
          BRANCH    OVRCD,ALLVIS95
.
          MATCH     URNUMBER,PVIURNO
          GOTO      ALLVIS95 IF NOT EQUAL
.
          MOVE      SP70,DOCINDIC
          MOVE      SP70,PROBLEM
.
          PACK      KEY8,PVIBILL,SP70
          CALL      RDPMVX11
          IF        OVRCD=1
            IF        ARCFLAG=1
              MOVE      PVIBILL,KEY8
              CALL      RDARVX11
              IF        OVRCD<>1
                CALL      MVPMAR00
              ENDIF
            ENDIF
          ENDIF
          BRANCH    OVRCD,ALLVIS10
.
          MOVE      ONE,HOSPFLAG
          IF        IBCNMHOS=1
            MATCH     SP70,FILTHOSP
            IF        !@EQUAL
              MATCH     FILTHOSP,PMVXMHOS
              GOTO      ALLVIS10 IF NOT EQUAL
            ELSE
              PACK      KEY13,USERID,SP70              * All hospital access
              CALL      RDMLSEC1
              IF        OVRCD=1
                PACK      KEY13,USERID,PMVXMHOS,SP70   * This hospital access
                CALL      RDMLSEC1
                BRANCH    OVRCD,ALLVIS10
              ENDIF
            ENDIF
            MATCH    WBSEHOSP,PMVXMHOS
            IF       !@EQUAL
              MOVE      ZERO,HOSPFLAG
            ENDIF
          ENDIF
.
          ADD       ONE,VISCOUNT
          MOVE      SP70,DESCSNAG
.
          IF        EMREVENT=1
            MATCH     " 9",PTVITYPE
            GOTO      ALLVIS95 IF NOT EQUAL
            MATCH     " 1",PVISYST
            GOTO      ALLVIS95 IF NOT EQUAL
            PACK      KEY8,PVIBILL         * Emergency event details
            CALL      RDPMEVT1
            BRANCH    OVRCD,ALLVIS95
.
            MOVE      "EV",CATEGORY
            MOVE      PMEVEVNT,CODE
            CALL      GETCOD00
            MATCH     "E",TCINDC1          * emergency events
            GOTO      ALLVIS95 IF NOT EQUAL
            GOTO      ALLVIS20
          ENDIF
.
          COMPARE   ONE,FILTVTYP            * All Visit Types
          GOTO      ALLVIS20 IF EQUAL
.
          COMPARE   TWO,FILTVTYP            * Inpatient Visit Types
          IF        @EQUAL
            MATCH     " 3",PTVITYPE
            GOTO      ALLVIS95 IF NOT EQUAL
          ENDIF
.
          COMPARE   THREE,FILTVTYP          * Outpatient Visit Types
          IF        @EQUAL
            MATCH     " 2",PTVITYPE
            GOTO      ALLVIS95 IF NOT EQUAL
          ENDIF
.
          COMPARE   FOUR,FILTVTYP            * Emergency Visit Types
          IF        @EQUAL
            MATCH     " 1",PTVITYPE
            GOTO      ALLVIS95 IF NOT EQUAL
          ENDIF
.
          COMPARE   SIX,FILTVTYP             * Allied Health Visit Types
          IF        @EQUAL
ALLVIS11    MATCH     "10",PTVITYPE
            GOTO      ALLVIS95 IF NOT EQUAL
.
            MATCH     SP70,FILTSTAT
            IF        !@EQUAL & !@EOS
.
              PACK     KEY8,PVIBILL,SP70
              CALL     RDALREF1
              BRANCH   OVRCD,ALLVIS10
.
              CALL     INDHCP00
.
              MATCH    FILTSTAT,ALRESTAT
              IF       !@EQUAL
.
                MATCH     "7",FILTSTAT                      * Waiting & Active
                IF        @EQUAL
                  MATCH     "0",ALRESTAT
                  GOTO      ALLVIS15 IF EQUAL
                  MATCH     "1",ALRESTAT
                  GOTO      ALLVIS15 IF EQUAL
                  GOTO      ALLVIS10
                ENDIF 
.
                MATCH     "8",FILTSTAT                      * Waiting & Active
                IF        @EQUAL
                  MATCH     "2",ALRESTAT
                  GOTO      ALLVIS15 IF EQUAL
                  MATCH     "5",ALRESTAT
                  GOTO      ALLVIS15 IF EQUAL
                  GOTO      ALLVIS10
                ENDIF
.
                MATCH     "9",FILTSTAT                  * Inactive & Cancelled
                IF        @EQUAL
                  MATCH     "3",ALRESTAT
                  GOTO      ALLVIS15 IF EQUAL
                  MATCH     "4",ALRESTAT
                  GOTO      ALLVIS15 IF EQUAL
                  GOTO      ALLVIS10
                ENDIF
.
                GOTO      ALLVIS10
.
              ENDIF
.
            ENDIF
.
            IF        PTCNHDPS=1
              PACK     KEY8,PVIBILL,SP70
              CALL     RDALREF1
              IF       OVRCD=0
.
                 CALL     INDHCP00
.
                 MOVE      SP70,PROBLEM
                 PACK      KEY12,ALREDEPT,ALREPRO1,SP70
                 CALL      RDALPRR1                * Read the allprraf table
                 IF        OVRCD=0
                   MOVE      ALPRDESC,PROBLEM
                 ENDIF    
              ENDIF
            ENDIF
.
          ENDIF
.
ALLVIS15  COMPARE   SEVEN,FILTVTYP           * Event Visit Types
          IF        @EQUAL
            MATCH     " 9",PTVITYPE
            GOTO      ALLVIS95 IF NOT EQUAL
          ENDIF
.
          COMPARE   TEN1,FILTVTYP             * Allied Health Visit Types
          IF        @EQUAL
            MATCH     "10",PTVITYPE 
            GOTO      ALLVIS95 IF NOT EQUAL
.
            PACK     KEY8,PVIBILL,SP70       * Waiting and Active Referrals
            CALL     RDALREF1
            BRANCH   OVRCD,ALLVIS10
.
            CALL     INDHCP00
.
            MATCH    "0",ALRESTAT
            IF       !@EQUAL
              MATCH    "1",ALRESTAT          
              GOTO      ALLVIS10 IF NOT EQUAL
            ENDIF
          ENDIF
.
ALLVIS20  PACK      NEXTVKEY,URNUMBER,PTVITYPE,PVIDATE,DPVIBILL,SP70
          MATCH     SP70,PREVVKEY
          IF        @EQUAL
            PACK      PREVVKEY,URNUMBER,PTVITYPE,PVIDATE,DPVIBILL,SP70
          ENDIF
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      ALLVIS10
          ENDIF
.
          MOVE      ONE,EPSCD001         * Episode number?
          MOVE      SP70,SAVEPKEY        * Clear save episode key
          MOVE      ZERO,GENCHCDS
          IF        ASTAT = 3 & MRCNEPSC = 1
            MOVE      ONE,GENCHCDS       * set "Generate Discharge patchcof"
          ENDIF
.
          CALL      MRTCOD00             * Medical Record Coding Details
          BRANCH    EXIT,ALLVIS10
.
          COMPARE   ZERO,CODESTAT        * Do not display Coder id if not coded
          IF        @EQUAL
            MOVE      SP70,CODERNAM
          ELSE
            MOVE      SP70,CODERNAM
            PACK      KEY10,PTEDUSID,SP70
            CALL      RDWBSE1
            IF        OVRCD=0
              MOVE      WBSENAM,CODERNAM
            ELSE
              PACK      KEY14,PTEDOPER,SP70
              CALL      RSWBSE3
              CALL      RKWBSE3
              IF        OVRCD=0
                MATCH     PTEDOPER,WBSEPCD
                IF        @EQUAL
                  MOVE      WBSENAM,CODERNAM
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          CALL      GETVIS00             * Get Visit Details
          BRANCH    EXIT,ALLVIS10
.
          MATCH     "1",NOCANVIS
          IF        @EQUAL
            COMPARE   FIVE,ASTAT
            GOTO      ALLVIS10 IF EQUAL
          ELSE
            MATCH       "2",NOCANVIS
            IF          @EQUAL
              COMPARE   FIVE,ASTAT
              GOTO      ALLVIS10 IF EQUAL
            ENDIF
          ENDIF
.
          PACK      KEY8,PVIBILL         * Outpatient event details
          CALL      RDPMEVT1
          BRANCH    OVRCD,ALLVIS30
.
          MOVE      "EV",CATEGORY
          MOVE      PMEVEVNT,CODE
          CALL      GETCOD00
.
          MATCH     "E",TCINDC1          * emergency events
          GOTO      ALLVIS26 IF EQUAL
.
          MATCH     "I",TCINDC1          * inpatient event
          IF        @EQUAL
            PACK      VISTLOC,PMEVPWRD,SLASH,PMEVPBED,SP70
            IF        IBCNMHOS=1
              PACK      VISTLOC,PMVXMHOS,DASH,PMEVPWRD,SLASH,PMEVPBED,SP70
            ENDIF
            MOVE      PMEVCCOD,CLAIMCOD
            CALL      GETSTA00
            GOTO      ALLVIS30
          ENDIF
.
          MATCH     "O",TCINDC1
          IF        !@EQUAL
            CALL      GETSTA00
            GOTO      ALLVIS30
          ENDIF
.
          CALL      GETSTA00
          MOVE      ZERO,FORM1
          MOVE      PMEVASTT,FORM1
          LOAD      VSTATUS,FORM1,OEVSTA1,OEVSTA2
          IF        FORM1=0
            MOVE      OEVSTA0,VSTATUS
          ENDIF
.
ALLVIS26  MOVE      PMEVATIM,VISTTIME
          MOVE      PMEVCCOD,CLAIMCOD
          MOVE      PMEVCTYP,UNITCODE
.
          MATCH     SP70,PMEVCTYP
          GOTO      ALLVIS30 IF EQUAL
.
          PACK      KEY12,PMEVSITE,PMEVCTYP,SP70
          CALL      RDCTYA1
          BRANCH    OVRCD,ALLVIS30
.
          MOVE      OCTDESC,UNITDESC
          MOVE      PMEVCTYP,UNITCODE
.
ALLVIS30  CALL      CKAL0000             * Check Allied Health
          BRANCH    EXIT,ALLVIS10        * don't display
.
          MATCH     "1",NMDSLIST
          IF        @EQUAL
...         COMPARE   ONE,AELIG
            COMPARE   THREE,ASTAT
            GOTO      ALLVIS10 IF NOT EQUAL
            MATCH     SP70,NMDSSTAT
            IF        !@EQUAL
              MOVE      AELIG,DIM1
              MATCH     NMDSSTAT,DIM1
              GOTO      ALLVIS10 IF NOT EQUAL
            ENDIF
          ENDIF
.
          CALL      MRTDES00             * Medical Record Location Details
.
          IF        PTCNHDPS=1
            MOVE     SP70,ALDEPENC
            PACK     KEY8,PVIBILL,SP70
            CALL     RDALREF1
            IF       OVRCD=1
              CALL     CLALLREF
            ELSE
              PACK     KEY3,ALREDEPT,SP70
              CALL     RDALDEP1
            ENDIF
          ENDIF
.
          MOVE      SP70,DISPDATT
          UNPACK    PVIDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          MATCH     SP70,VISTTIME
          IF        !@EQUAL
            ENDSET    DISPDATT
            APPEND    " at ",DISPDATT
            APPEND    VISTTIME,DISPDATT
            RESET     DISPDATT
          ENDIF
.
          IF        (DISNUMB%2) = 0
            MATCH     SP70,DISPCLSS
            IF        @EQUAL
              WRITE     HTMLFILE;"<tr class=TableRowOdd><td nowrap>"
            ELSE
              WRITE     HTMLFILE;"<tr class=TableRowOdd><td nowrap class=":
                                  DISPCLSS,">"
            ENDIF
          ELSE
            MATCH     SP70,DISPCLSS
            IF        @EQUAL
              WRITE     HTMLFILE;"<tr class=TableRowEven><td nowrap>"
            ELSE
              WRITE     HTMLFILE;"<tr class=TableRowEven><td nowrap class=":
                                   DISPCLSS,">"
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"<img src=../images/AppointmentIcon.gif":
                             " class=ListIcon ":
                             " onclick='linkPatient(#"":
                               URNUMBER,"#",#"":
                               PVIBILL,"#",#"":
                               PVITYPE,"#",#"":
                               SECOPT,"#",#"":
                               "#",#"":
                               PVISITE,"#",#"":
                               AAEVFLAG,"#",#"":
                               EVNTFLAG,"#",#"":
                               EMVISITE,"#",#"":
                               SP1,"#",#"":
                               SP1,"#",#"":
                               HOSPFLAG,"#",#"":
                               ALREUYN4,"#",#"":
                               ALDEPENC,"#");'>":
                               DISPDATT,"</td>"
.
          CLEAR     EXTVSTID
          CLEAR     CHKEXTVD
          PACK      CHKEXTVD,PVIBILL,SP70
          PROC      CHKEID00
          MATCH     KEY20,SP70
          IF        @EQUAL
            PACK      EXTVSTID,PVIBILL
          ELSE
            APPEND    PVIBILL,EXTVSTID
            APPEND    SP2,EXTVSTID
            APPEND    "<span class='TextBlue'>(",EXTVSTID
            APPEND    KEY20,EXTVSTID
            APPEND    ")</span>",EXTVSTID
          ENDIF
.
          MATCH     "0",SHOWFRMT               * Standard
          IF        @EQUAL
            MATCH     "2",DEFAULTA
            IF        !@EQUAL
              WRITE     HTMLFILE;"<td>&nbsp;",VISTDAY,"</td>";
            ENDIF
.
            CALL      THBL0000                 * Assign VISTLINK icon for Inpatient Visit with Bookings
.
            IF        PTCNHDPS=1
              MATCH     "RF",VISTTYPE
              IF        @EQUAL
                REP       " +",URNUMBER
                MOVE      PVIBILL,DIM8
                REP       " +",DIM8
                MOVE      SECOPT,DIM1
                REP       " +",DIM1
                WRITE     HTMLFILE;"<td>",VISTTYPE,"&nbsp;<img src='../images/EditIcon.gif' ":
                                   "onmouseover='this.style.cursor=#"hand#"' ":
                                   "onClick=javascript:OpenAllRef('allweb03.pbl?":
                                   "reportno=01&template=014&urnumber=",URNUMBER:
                                   "&admissno=",DIM8,"','",DIM1,"')></td>";
                REP       "+ ",URNUMBER
                REP       "+ ",DIM8
              ELSE
                WRITE     HTMLFILE;"<td>",VISTLINK,"</td>";
              ENDIF
            ELSE
              WRITE     HTMLFILE;"<td>",VISTLINK,"</td>";
            ENDIF
.
            WRITE     HTMLFILE;"<td>&nbsp;",UNITCODE,"</td>";
.
            IF        PTCNHDPS=1
              MATCH      "1",SHOWPROB
              IF         @EQUAL
                WRITE      HTMLFILE;"<td>&nbsp;",PROBLEM,"</td>";
              ENDIF
            ENDIF
.
            MATCH     "1",DOCINDIC
            IF        @EQUAL
              WRITE     HTMLFILE;"<td>&nbsp;",DOCFNAME,"<br><font color=blue>&nbsp;",DOCFNAM3,"<br>&nbsp;",DOCFNAM4,"<br>&nbsp;",DOCFNAM5,"<br>&nbsp;",DOCFNAM6,"</font></td>";
            ELSE
              WRITE     HTMLFILE;"<td>&nbsp;",DOCFNAME,"</td>";
            ENDIF
.
            WRITE     HTMLFILE;"<td>&nbsp;",VISTLOC,"</td>":
                               "<td>&nbsp;",CLAIMCOD,"</td>":
                               "<td>",VSTATUS,"</td>":
                               "<td>&nbsp;",EXTVSTID,"</td>";
.
            MATCH      "1",SHOWMEDL
            IF         @EQUAL
              MATCH      SP70,VOLNDESC
              IF         @EQUAL
                WRITE      HTMLFILE;"<td>":
                                    "<input type=checkbox name=lnkadmis":
                                    " value='",PVIBILL,"'></td>"
              ELSE
                WRITE      HTMLFILE;"<td>&nbsp;":
                                    "<img src=../images/EditIcon.gif":
                                    " class=ListIcon":  
                                    " onclick='LinkMedicalRec(#"":
                                    PVIBILL,"#",#"",URNUMBER,"#");'>":
                                    VOLNDESC," "
                MATCH      SP70,MRVSXKY1
                IF         @EQUAL
                  WRITE      HTMLFILE;"</td>"
                ELSE
                  WRITE      HTMLFILE;"+ </td>"
                ENDIF
              ENDIF
            ELSE
              MATCH     "2",DEFAULTA
              IF        !@EQUAL
                WRITE      HTMLFILE;"<td>&nbsp;",VOLNDESC," "
                MATCH      SP70,MRVSXKY1
                IF         @EQUAL
                  WRITE      HTMLFILE;"</td>"
                ELSE
                  WRITE      HTMLFILE;"+ </td>"
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     "1",NMDSLIST
          IF        @EQUAL
            MOVE       NMDSZERO,DIM20
            LOAD       DIM20,AELIG,NMDSONE,NMDSTWO,NMDSTHRE,NMDSFOUR,NMDSFIVE
            WRITE      HTMLFILE;"<td>&nbsp;",DIM20:
                                "</td><td>":
                                "<img src=../images/EditIcon.gif":
                                " class=ListIcon":
                                " onclick='EditNMDS(#"":
                                PVIBILL,"#",#"",URNUMBER,"#");'></td>"
          ENDIF
.
          MATCH     "1",SHOWFRMT               * Kids      
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;",VISTDAY,"</td>":
                               "<td>&nbsp;",VISTTYPE,"</td>":
                               "<td>&nbsp;",UNITDESC,"</td>":
                               "<td>&nbsp;",DOCFNAME,"</td>":
                               "<td>&nbsp;",VISTLOC,"</td>":
                               "<td>&nbsp;",CLAIMCOD,"</td>":
                               "<td>",VSTATUS,"</td>":
                               "<td>&nbsp;",EXTVSTID,"</td>"
          ENDIF
.
          MATCH     "2",SHOWFRMT               * STV
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;",VISTDAY,"</td>":
                               "<td>&nbsp;",VISTTYPE,"</td>":
                               "<td>&nbsp;",UNITDESC,"</td>":
                               "<td>&nbsp;",DOCFNAME,"</td>":
                               "<td>&nbsp;",VISTLOC,"</td>":
                               "<td>&nbsp;",CLAIMCOD,"</td>":
                               "<td>",VSTATUS,"</td>":
                               "<td>&nbsp;",EXTVSTID,"</td>";
.
            MATCH      "1",SHOWMEDL
            IF         @EQUAL
              MATCH      "10",PTVITYPE      * Can not update allied health
              IF         @EQUAL
                WRITE      HTMLFILE;"<td>&nbsp;",VOLNDESC
                MATCH      SP70,MRVSXKY1
                IF         @EQUAL
                  WRITE      HTMLFILE;"</td>"
                ELSE
                  WRITE      HTMLFILE;"+ </td>"
                ENDIF
                GOTO       ALLVIS90
              ENDIF
.
              MATCH      SP70,VOLNDESC
              IF         @EQUAL
                WRITE      HTMLFILE;"<td>":
                                    "<input type=checkbox name=lnkadmis":
                                    " value='",PVIBILL,"'></td>"
              ELSE
                WRITE      HTMLFILE;"<td>&nbsp;":
                                    "<img src=../images/EditIcon.gif":
                                    " class=ListIcon":  
                                    " onclick='LinkMedicalRec(#"":
                                    PVIBILL,"#",#"",URNUMBER,"#");'>":
                                    VOLNDESC
                MATCH      SP70,MRVSXKY1
                IF         @EQUAL
                  WRITE      HTMLFILE;"</td>"
                ELSE
                  WRITE      HTMLFILE;"+ </td>"
                ENDIF
              ENDIF
            ELSE
              WRITE      HTMLFILE;"<td>&nbsp;",VOLNDESC
              MATCH      SP70,MRVSXKY1
              IF         @EQUAL
                WRITE      HTMLFILE;"</td>"
              ELSE
                WRITE      HTMLFILE;"+ </td>"
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     "2",DEFAULTA
ALLVIS80  IF        @EQUAL
.                                                          * start    *I-267008
            MOVE      ALREUHC4,ALCADESC
            PACK      KEY10,ALREUHC4,SP10
            CALL      RDALCAS1              * read Case Team Description
.                                                          * end      *I-267008
            MOVE      "gb",CATEGORY
            MOVE      ALRECONT,CODE         * Contract
            CALL      GETCOD00
.
            WRITE     HTMLFILE;"<td>&nbsp;",REFTDESC,"</td>":
                               "<td>&nbsp;",ALCADESC,"</td>":
                               "<td>&nbsp;",TDESC,"</td>"
          ENDIF
.
ALLVIS90  MATCH     "1",SHOWCDMI
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;";
            CALL      VCDM0000                   * Visit based CDM
            WRITE     HTMLFILE;"</td>";
          ENDIF
.
          WRITE     HTMLFILE;"</tr>"
.
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      ALLVIS10 IF NOT EQUAL
          MOVE      ZERO,SHOWFLAG
.
ALLVIS95  MATCH     "1",OUTORDER            * Allied Health Search Order 1
          IF        @EQUAL
            IF        FILTVTYP=3
              MOVE      ZERO,SHOWFLAG
            ENDIF
          ENDIF
.
          COMPARE   ONE,EMRVSTYP
          GOTO      ALLVIS99 IF EQUAL
.
          CALL      NOMORE00                * Show no more visits message
.
ALLVIS99  RETURN
.
.----------------------------------------------------------------------------
. Output recurring care visit list for an U/R
.----------------------------------------------------------------------------
RECLST00  MOVE      ZERO,RECNUMB            * Init Number of records Read
          MOVE      ZERO,DISNUMB            * Init number of records output
          IF        NORECORD=0
            MOVE    "10",NORECORD           * Numb of records=0 Default to 10
          ENDIF
.
          MATCH     SP70,URNUMBER
          GOTO      RECLST99 IF EQUAL
.
          MATCH     "       0",URNUMBER
          GOTO      RECLST99 IF EQUAL
.
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1             
          IF        OVRCD=1
            CALL      CLWEBSEC
          ENDIF
.
          PACK      TYPE2,SP1,THREE
          PACK      KEY26,URNUMBER,TYPE2,Z70
RECLST05  CALL      RDSVISA4
RECLST10  CALL      RDPVISA4
          BRANCH    OVRCD,RECLST95
.
          MATCH     URNUMBER,PVIURNO
          GOTO      RECLST95 IF NOT EQUAL
.
          MATCH     TYPE2,PTVITYPE
          GOTO      RECLST95 IF NOT EQUAL
.
          COMPARE   "3",PVITYPE
          GOTO      RECLST10 IF NOT EQUAL
.
          PACK      KEY8,DPVIBILL,SP70 
          CALL      RDMISS1
          BRANCH    OVRCD,RECLST10
.
          COMPARE   "3",ASTAT
          GOTO      RECLST10 IF NOT EQUAL
.
          PACK      KEY8,DPVIBILL,SP70
          CALL      RDPMVX11
          IF        OVRCD=1
            CALL      CLPMSVX1
          ENDIF
.
          MATCH     "1",PTCNUHSC
          IF        @EQUAL
            MATCH     PMVXMHOS,WBSEHOSP
            GOTO      RECLST10 IF NOT EQUAL
          ENDIF
.
          CALL      MVIS0000        * check if match for recurring care
          BRANCH    EXIT,RECLST10
.
RECLST20  ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      RECLST10
          ENDIF
.
          CALL      GETVIS00             * Get Visit Details
          BRANCH    EXIT,RECLST10
.
          MOVE      SP70,DISPDATT
          UNPACK    PVIDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          MATCH     SP70,VISTTIME
          IF        !@EQUAL
            ENDSET    DISPDATT
            APPEND    " at ",DISPDATT
            APPEND    VISTTIME,DISPDATT
            RESET     DISPDATT
          ENDIF
.
          MOVE      "AC",CATEGORY
          MOVE      UNITCODE,CODE
          CALL      GETCOD00
          MOVE      TDESC,UNITDESC
.
          IF        (DISNUMB%2) = 0
            MATCH     SP70,DISPCLSS
            IF        @EQUAL
              WRITE     HTMLFILE;"<tr class=TableRowOdd><td nowrap>"
            ELSE
              WRITE     HTMLFILE;"<tr class=TableRowOdd><td nowrap class=":
                                  DISPCLSS,">"
            ENDIF
          ELSE
            MATCH     SP70,DISPCLSS
            IF        @EQUAL
              WRITE     HTMLFILE;"<tr class=TableRowEven><td nowrap>"
            ELSE
              WRITE     HTMLFILE;"<tr class=TableRowEven><td nowrap class=":
                                   DISPCLSS,">"
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"<img src=../images/AppointmentIcon.gif":
                             " class=ListIcon ":
                             " onclick='linkPatient(#"":
                               URNUMBER,"#",#"":
                               PVIBILL,"#");'>":
                               DISPDATT,"</td>"
.
          CLEAR     EXTVSTID
          CLEAR     CHKEXTVD
          PACK      CHKEXTVD,PVIBILL,SP70
          PROC      CHKEID00
          MATCH     KEY20,SP70
          IF        @EQUAL
            PACK      EXTVSTID,PVIBILL
          ELSE
            APPEND    PVIBILL,EXTVSTID
            APPEND    SP2,EXTVSTID
            APPEND    "<span class='TextBlue'>(",EXTVSTID
            APPEND    KEY20,EXTVSTID
            APPEND    ")</span>",EXTVSTID
          ENDIF
.
          WRITE     HTMLFILE;"<td>&nbsp;",UNITDESC,"</td>";         * 2
          WRITE     HTMLFILE;"<td>&nbsp;",DOCFNAME,"</td>";         * 3
          WRITE     HTMLFILE;"<td>&nbsp;",VISTLOC,"</td>":          * 4
                             "<td>&nbsp;",CLAIMCOD,"</td>":         * 5 
                             "<td>",VSTATUS,"</td>":                * 6
                             "<td>&nbsp;",EXTVSTID,"</td>";         * 7
.
          WRITE     HTMLFILE;"</tr>"
.
RECLST80  ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      RECLST10 IF NOT EQUAL
          MOVE      ZERO,SHOWFLAG
.
RECLST95  CALL      NOMORE00                * Show no more visits message
.
RECLST99  RETURN
.
.------------------------------------------------------------
. Matching visit to use for recurring care
.------------------------------------------------------------
MVIS0000  MOVE      ZERO,EXIT
          MATCH     SP70,PMVXIDUS
          GOTO      MVIS9000 IF EQUAL
.
          PACK      KEY5,ANSV,ANSI,PMVXIDUS,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,MVIS9000
.
          MATCH     "2",TCINDC1
          GOTO      MVIS9000 IF NOT EQUAL
.
          PACK      KEY30,AADMNO,SP70
          CALL      RDSTRAN2
          CALL      RDKTRAN2
          BRANCH    OVRCD,MVIS9000
.
          MATCH     TADMN,AADMNO
          GOTO      MVIS9000 IF NOT EQUAL
.
          MATCH     TWARD,VALDWARD
          GOTO      MVIS9000 IF NOT EQUAL
.
          MATCH     TDEPT,VALDSPEC
          GOTO      MVIS9000 IF NOT EQUAL
.
          GOTO      MVIS9999
.
MVIS9000  MOVE      ONE,EXIT
.
MVIS9999  RETURN
.
.-------------------------------------------------------------
. Link to Prev Group
.-------------------------------------------------------------
PREVGR00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM-NORECORD,F3
          IF        F3<0
            MOVE      ZERO,F3
          ENDIF
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
.
          REP       " +",ADMISSNO    
          REP       " +",URNUMBER    
          REP       " +",PREVVKEY
          REP       " +",FILTDEPT
          REP       " +",FILTSTAT
.
          WRITE     HTMLFILE;"patweb98.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&filtvtyp=",FILTVTYP:
                                 "&prevflag=",ONE:
                                 "&prevvkey=",PREVVKEY:
                                 "&urnumber=",URNUMBER:
                                 "&admissno=",ADMISSNO:
                                 "&srchview=",SRCHVIEW:
                                 "&filthosp=",FILTHOSP:
                                 "&filtflag=",FILTFLAG:
                                 "&filtdept=",FILTDEPT:
                                 "&deftflag=",DEFTFLAG:
                                 "&filtstat=",FILTSTAT:
                                 "&filtvsta=",FILTVSTA;
.
          REP       "+ ",ADMISSNO    
          REP       "+ ",URNUMBER    
          REP       "+ ",PREVVKEY
          REP       "+ ",FILTDEPT
          REP       "+ ",FILTSTAT
.
PREVGR99  RETURN
.-----------------------------------------------------------
. Link to Next Group
.-----------------------------------------------------------
NEXTGR00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
.
          REP       " +",ADMISSNO    
          REP       " +",URNUMBER    
          REP       " +",NEXTVKEY
          REP       " +",FILTDEPT
          REP       " +",FILTSTAT
.
          WRITE     HTMLFILE;"patweb98.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&filtvtyp=",FILTVTYP:
                                 "&nextvkey=",NEXTVKEY:
                                 "&urnumber=",URNUMBER:
                                 "&admissno=",ADMISSNO:
                                 "&srchview=",SRCHVIEW:
                                 "&filthosp=",FILTHOSP:
                                 "&filtflag=",FILTFLAG:
                                 "&filtdept=",FILTDEPT:
                                 "&deftflag=",DEFTFLAG:
                                 "&filtstat=",FILTSTAT:
                                 "&filtvsta=",FILTVSTA;
.         
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
          REP       "+ ",NEXTVKEY
          REP       "+ ",FILTDEPT
          REP       "+ ",FILTSTAT
.
NEXTGR99  RETURN
.
.-------------------------------------------------------------
. Link to prev recurring care group
.-------------------------------------------------------------
PREVRC00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM-NORECORD,F3
          IF        F3<0
            MOVE      ZERO,F3
          ENDIF
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
.
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
.
          WRITE     HTMLFILE;"patweb98.pbl":
                             "?reportno=",F1:
                             "&template=",FLDPARA:
                             "&startnum=",KEY3:
                             "&norecord=",KEY2:
                             "&urnumber=",URNUMBER:
                             "&valdward=",VALDWARD:
                             "&valdspec=",VALDSPEC;
.
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
PREVRC99  RETURN
.
.-----------------------------------------------------------
. Link to Next recurring care group
.-----------------------------------------------------------
NEXTRC00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
.
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
.
          WRITE     HTMLFILE;"patweb98.pbl":
                             "?reportno=",F1:
                             "&template=",FLDPARA:
                             "&startnum=",KEY3:
                             "&norecord=",KEY2:
                             "&urnumber=",URNUMBER:
                             "&valdward=",VALDWARD:
                             "&valdspec=",VALDSPEC;
.
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
NEXTRC99  RETURN
.
.-----------------------------------------------------------
. Link to Start recurring care group
.-----------------------------------------------------------
STRTRC00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
.
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
.
          WRITE     HTMLFILE;"patweb98.pbl":
                             "?reportno=",F1:
                             "&template=",FLDPARA:
                             "&startnum=0":
                             "&norecord=",KEY2:
                             "&urnumber=",URNUMBER:
                             "&valdward=",VALDWARD:
                             "&valdspec=",VALDSPEC;
.
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
STRTRC99  RETURN
.
.------------------------------------------------------------
. Bookings Visit List
.------------------------------------------------------------
ALLBOK00  PACK      KEY16,URNUMBER,SP70
          CALL      RSBKREC6
ALLBOK10  CALL      RKBKREC6
          BRANCH    OVRCD,ALLBOK95
          MATCH     URNUMBER,BKREURNO
          GOTO      ALLBOK95 IF NOT EQUAL
          COMPARE   ZERO,BKRESTAT
          GOTO      ALLBOK10 IF NOT EQUAL
.
          MOVE      SP70,VISTLOC
          MOVE      SP70,UNITDESC
          MOVE      SP70,UNITCODE
          MOVE      SP70,DTYPDESC
          MOVE      SP70,CTYPDESC
          MOVE      SP70,CLAIMCOD
          MOVE      SP70,VISADIAG
          MOVE      SP70,ADIADESC
          MOVE      SP70,DDIADESC
          MOVE      SP70,SLOTNUMB
          PACK      VISTTYPE,SP70
          PACK      VSTATUS,SP70
          PACK      VISTLOC,SP70
.
          MOVE      SP70,VISTDAY
          UNPACK    BKREEDAT,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
          LOAD      DAYNAM3,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
          PACK      VISTDAY,DAYNAM3,SP70
.
          MOVE      BKREEDAT,PVIDATE
          MOVE      BKREATIM,VISTTIME
.
          ADD       ONE,VISCOUNT
          MOVE      "Book",VISTTYPE
          MOVE      "Booking",VSTATUS
          MOVE      "Booking",VISTDESC
.
          MOVE      BKREPROC,VISADIAG         * Procedure
          PACK      KEY18,BKREBOOK,SP70
          CALL      RSBKDIA1
          CALL      RKBKDIA1
          IF        OVRCD=0
            MATCH     BKREBOOK,BKDIBOOK
            IF        @EQUAL
              MOVE      BKDICODE,VISADIAG
              MOVE      BKDIDES1,ADIADESC       * Procedure description
            ENDIF
          ENDIF
.
          MOVE      BKREADOC,KEY6
          CALL      RDDOCT1
          IF        OVRCD=1
            MOVE      SP70,DOCFNAME
          ELSE
.           CALL      DOCNAM00                * Format Doctor Name
            MOVE      DTITL,FMTTITLE            * I CAR 13038
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000                  * end I CAR 13038
          ENDIF
.
          MOVE      SP70,PTWDHOSN
          PACK      KEY8,BKREBOOK,SP70
          CALL      RDBKRX11
          MATCH     SP70,BKRXPOWD
          IF        !@EQUAL
            PACK      KEY6,BKRXPOWD,SP70
            CALL      RDWARD1
            IF        OVRCD<>1
              IF        IBCNMHOS=1
                PACK      VISTLOC,PTWDHOSN,SP70
              ENDIF
            ENDIF
          ENDIF
.
          MOVE     ZERO,WAITFLAG
          PACK     KEY19,URNUMBER,SP70
          CALL     RDSTREA1
ALLBOK15  CALL     RDKTREA1
          IF       OVRCD=0
            MATCH    URNUMBER,WMURNO
            IF       @EQUAL
              MATCH    WMBOOK,BKREBOOK
              IF       @EQUAL
                MOVE     ONE,WAITFLAG
                PACK      CASEKEYS,WMURNO,WMCODE,DWMCNT,SP70
              ELSE
                GOTO      ALLBOK15
              ENDIF
            ENDIF
          ENDIF
.
          MOVE     ONE,HOSPFLAG
          IF        IBCNMHOS=1
            MATCH     SP70,FILTHOSP
            IF        !@EQUAL
              MATCH     FILTHOSP,PTWDHOSN
              GOTO      ALLBOK10 IF NOT EQUAL
            ELSE
              PACK      KEY13,USERID,SP70              * All hospital access
              CALL      RDMLSEC1
              IF        OVRCD=1
                PACK      KEY13,USERID,PTWDHOSN,SP70   * This hospital access
                CALL      RDMLSEC1
                BRANCH    OVRCD,ALLBOK10
              ENDIF
            ENDIF
            MATCH    "1",WAITFLAG
            IF       @EQUAL
              MATCH    WBSEHOSP,WTWMIHSP
              IF       !@EQUAL
                MOVE     ZERO,HOSPFLAG
              ENDIF
            ELSE
              MATCH    WBSEHOSP,PTWDHOSN
              IF       !@EQUAL
                MOVE      ZERO,HOSPFLAG
              ENDIF
            ENDIF
          ENDIF
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      ALLBOK10
          ENDIF
.
          PACK      DESCHOME,SP70
          PACK      DESCDOCM,SP70
          MOVE      SP70,VOLNDESC
. 
          PACK      KEY8,BKREBOOK,SP70
          CALL      RDMRVS1       * Gets the Unique key for the medical record
          BRANCH    OVRCD,ALLBOK20
. 
          PACK      KEY10,MRVSMKEY,SP70
          CALL      RDMRMAS2      * reads the MRT master file for associated rec
          BRANCH    OVRCD,ALLBOK20
. 
          MATCH     PVIURNO,MRMAURNO  * Match U/R as might be a merged?
          IF        !@EQUAL
            PACK      DESCHOME,SP70
            PACK      DESCDOCM,SP70
            MOVE      SP70,VOLNDESC
            MOVE      "Incomplete Merge",VOLNDESC
            GOTO      ALLBOK20
          ENDIF
. 
          MOVE      DMRMAVOL,VOLNDESC  * Set Volume
. 
          MOVE      "TY",KEY2
          PACK      KEY5,KEY2,MRMADOTY
          CALL      RDCODE1
          MOVE      TDESC,DESCDOCM
. 
          PACK      KEY7,MRMAHHOS,MRMAHLOC,SP10                       *C-240724
          CALL      RDMRLOC1
          MOVE      MRLODESC,DESCHOME
.
ALLBOK20  MOVE      "CL",CATEGORY
          MOVE      BKRECLMT,CODE
          CALL      GETCOD00
          MOVE      TDESC,CTYPDESC
          MOVE      ACODE,CLAIMCOD
.
          MOVE      "A ",CATEGORY
          MOVE      BKREATYP,CODE
          CALL      GETCOD00
          MOVE      TDESC,ATYPDESC
.
          MOVE      "AC",CATEGORY
          MOVE      BKREDEPT,CODE
          CALL      GETCOD00
          MOVE      TDESC,DTYPDESC
          MOVE      TDESC,UNITDESC
          MOVE      CODE,UNITCODE
.
          REP       " 0",BKREEDAT
.
          UNPACK    BKREEDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          MATCH     SP70,BKREATIM
          IF        !@EQUAL
            ENDSET    DISPDATT
            APPEND    " at ",DISPDATT
            APPEND    BKREATIM,DISPDATT
            RESET     DISPDATT
          ENDIF
.
          IF        (DISNUMB%2) = 0
            WRITE     HTMLFILE;"<tr class=TableRowOdd><td nowrap>"
          ELSE
            WRITE     HTMLFILE;"<tr class=TableRowEven><td nowrap>"
          ENDIF
.
          WRITE     HTMLFILE;"<img src=../images/AppointmentIcon.gif":
                             " class=ListIcon ":
                             " onclick='linkPatient(#"":
                               URNUMBER,"#",#"":
                               DBKREBOO,"#",#"":
                               SEVEN,"#",#"":
                               SECOPT,"#",#"":
                               CASEKEYS,"#",#"":
                               SP1,"#",#"":
                               SP1,"#",#"":
                               SP1,"#",#"":
                               SP1,"#",#"":
                               SP1,"#",#"":
                               SP1,"#",#"":
                               HOSPFLAG,"#",#"":
                               WAITFLAG,"#");'>":
                               DISPDATT,"</td>"
.
          CLEAR     EXTVSTID
          CLEAR     CHKEXTVD
          PACK      CHKEXTVD,DBKREBOO,SP70
          PROC      CHKEID00
          MATCH     KEY20,SP70
          IF        @EQUAL
            PACK      EXTVSTID,DBKREBOO
          ELSE
            APPEND    DBKREBOO,EXTVSTID
            APPEND    SP2,EXTVSTID
            APPEND    "<span class='TextBlue'>(",EXTVSTID
            APPEND    KEY20,EXTVSTID
            APPEND    ")</span>",EXTVSTID
          ENDIF
.
          MATCH     "0",SHOWFRMT                 * Standard
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;",VISTDAY,"</td>":
                               "<td>&nbsp;",VISTTYPE,"</td>":
                               "<td>&nbsp;",UNITCODE,"</td>":
                               "<td>&nbsp;",DOCFNAME,"</td>":
                               "<td>&nbsp;",VISTLOC,"</td>":
                               "<td>&nbsp;",CLAIMCOD,"</td>":
                               "<td>",VSTATUS,"</td>":
                               "<td>&nbsp;",EXTVSTID,"</td>";
.
            MATCH      "1",SHOWMEDL
            IF         @EQUAL
              MATCH      SP70,VOLNDESC
              IF         @EQUAL
                WRITE      HTMLFILE;"<td>":
                                    "<input type=checkbox name=lnkadmis":
                                    " value='",DBKREBOO,"'></td>"
              ELSE
                WRITE      HTMLFILE;"<td>&nbsp;":
                                    "<img src=../images/EditIcon.gif":
                                    " class=ListIcon":  
                                    " onclick='LinkMedicalRec(#"":
                                    DBKREBOO,"#",#"",URNUMBER,"#");'>":
                                    VOLNDESC
                MATCH      SP70,MRVSXKY1
                IF         !@EQUAL
                  WRITE      HTMLFILE;"+"
                ENDIF
                WRITE      HTMLFILE;"</td>"
              ENDIF
            ELSE    
              WRITE      HTMLFILE;"<td>&nbsp;",VOLNDESC
              MATCH      SP70,MRVSXKY1
              IF         !@EQUAL
                WRITE      HTMLFILE;"+"
              ENDIF
              WRITE      HTMLFILE;"</td>"
            ENDIF 
          ENDIF
.
          MATCH     "1",SHOWFRMT                 * Kids      
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;",VISTDAY,"</td>":
                               "<td>&nbsp;",VISTTYPE,"</td>":
                               "<td>&nbsp;",UNITDESC,"</td>":
                               "<td>&nbsp;",DOCFNAME,"</td>":
                               "<td>&nbsp;",VISTLOC,"</td>":
                               "<td>&nbsp;",CLAIMCOD,"</td>":
                               "<td>",VSTATUS,"</td>":
                               "<td>&nbsp;",EXTVSTID,"</td>"
          ENDIF
.
          MATCH     "2",SHOWFRMT                 * STV
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;",VISTDAY,"</td>":
                               "<td>&nbsp;",VISTTYPE,"</td>":
                               "<td>&nbsp;",UNITDESC,"</td>":
                               "<td>&nbsp;",DOCFNAME,"</td>":
                               "<td>&nbsp;",SP1,"</td>":
                               "<td>&nbsp;",CLAIMCOD,"</td>":
                               "<td>",VSTATUS,"</td>":
                               "<td>&nbsp;",EXTVSTID,"</td>";
.
            MATCH      "1",SHOWMEDL
            IF         @EQUAL
              MATCH      SP70,VOLNDESC
              IF         @EQUAL
                WRITE      HTMLFILE;"<td>":
                                    "<input type=checkbox name=lnkadmis":
                                    " value='",DBKREBOO,"'></td>"
              ELSE
                WRITE      HTMLFILE;"<td>&nbsp;":
                                    "<img src=../images/EditIcon.gif":
                                    " class=ListIcon":  
                                    " onclick='LinkMedicalRec(#"":
                                    DBKREBOO,"#",#"",URNUMBER,"#");'>":
                                    VOLNDESC 
                MATCH      SP70,MRVSXKY1 
                IF         !@EQUAL
                  WRITE      HTMLFILE;"+"
                ENDIF
                WRITE      HTMLFILE;"</td>"
              ENDIF
            ELSE    
              WRITE      HTMLFILE;"<td>&nbsp;",VOLNDESC,
              MATCH      SP70,MRVSXKY1 
              IF         !@EQUAL
                WRITE      HTMLFILE;"+"
              ENDIF
              WRITE      HTMLFILE;"</td>"
            ENDIF 
          ENDIF
.
          MATCH     "1",SHOWCDMI
          IF        @EQUAL
            WRITE      HTMLFILE;"<td>&nbsp;</td>"
          ENDIF
.
          WRITE     HTMLFILE;"</tr>"
.
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      ALLBOK10 IF NOT EQUAL
          MOVE      ZERO,SHOWFLAG
.
ALLBOK95  CALL      NOMORE00                * Show no more visits message
.
ALLBOK99  RETURN
.
.------------------------------------------------------------
. Waiting List Details
.------------------------------------------------------------
ALLWAT00  MOVE      SP70,VISTLOC
          MOVE      SP70,DTYPDESC
          MOVE      SP70,UNITCODE
          MOVE      SP70,UNITDESC
          MOVE      SP70,CTYPDESC
          MOVE      SP70,CLAIMCOD
          MOVE      SP70,VISADIAG
          MOVE      SP70,ADIADESC
          MOVE      SP70,DDIADESC
          MOVE      SP70,SLOTNUMB
          PACK      VISTTYPE,SP70
          PACK      VSTATUS,SP70
.
          PACK      KEY19,URNUMBER,SP20
          CALL      RDSTREA1
ALLWAT10  CALL      RDKTREA1
          BRANCH    OVRCD,ALLWAT95
          MATCH     URNUMBER,WMURNO      * Same U/R ?
          GOTO      ALLWAT95 IF NOT EQUAL
.
          IF        PTCNHDPS=1
            MATCH     SP70,WTWMIHSP
            IF        !@EQUAL
              MATCH     SP70,FILTHOSP
              IF        !@EQUAL
                MATCH     FILTHOSP,WTWMIHSP
                GOTO      ALLWAT10 IF NOT EQUAL
              ELSE
                PACK      KEY13,USERID,SP70              * All hospital access
                CALL      RDMLSEC1
                IF        OVRCD=1
                  PACK      KEY13,USERID,WTWMIHSP,SP70   * This hospital access
                  CALL      RDMLSEC1
                  BRANCH    OVRCD,ALLWAT10
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          MOVE     ONE,HOSPFLAG
          IF        IBCNMHOS=1
            MATCH    WBSEHOSP,WTWMIHSP
            IF       !@EQUAL
              MOVE      ZERO,HOSPFLAG
            ENDIF
          ENDIF
.
          PACK      KEY19,WMURNO,WMCODE,WMCNT,SP70
          CALL      RDWTTX11
          MOVE      SP70,VISTDAY
          UNPACK    WMDATE1,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
          LOAD      DAYNAM3,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
          PACK      VISTDAY,DAYNAM3,SP70
.
          PACK      CASEKEYS,WMURNO,WMCODE,DWMCNT,SP70
.
          MOVE      WMDATE1,PVIDATE
          MOVE      SP70,VISTTIME
.
          MOVE      "W/L",VISTTYPE
          COMPARE   ONE,WMSTAT
          IF        @EQUAL
            MOVE      WLSTAT1,VSTATUS
            GOTO      ALLWAT20            * unscheduled status
          ENDIF
.
          COMPARE   SIX,WMSTAT
          IF        @EQUAL
            MOVE      WLSTAT6,VSTATUS
            GOTO      ALLWAT20            * removed status
          ENDIF
.
          COMPARE   NINE,WMSTAT
          IF        @EQUAL
            MOVE      WLSTAT9,VSTATUS
            GOTO      ALLWAT20            * removed status
          ENDIF
.
          GOTO      ALLWAT10
.
ALLWAT20  ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      ALLWAT10
          ENDIF
. 
          MOVE      "P ",CATEGORY
          MOVE      WTWMCLSS,CODE
          CALL      GETCOD00
          MOVE      TDESC,CTYPDESC       * Admission CLass
          MOVE      ACODE,CLAIMCOD
.
          MOVE      "WU",CATEGORY
          MOVE      WMUNIT,CODE
          CALL      GETCOD00
          MOVE      TDESC,DTYPDESC
          MOVE      CODE,UNITCODE
          MOVE      TDESC,UNITDESC
.
          MOVE      WMDOCTOR,KEY6
          CALL      RDDOCT1
          IF        OVRCD=1
            MOVE      SP70,DOCFNAME
          ELSE
.           CALL      DOCNAM00                * Format Doctor Name
            MOVE      DTITL,FMTTITLE            * I CAR 13038
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000                  * end I CAR 13038
          ENDIF
.
          MOVE      WMCODE,VISADIAG
          MOVE      WMREASON,ADIADESC
.
          MOVE      "CL",CATEGORY
          MOVE      WTTXCTYP,CODE
          CALL      GETCOD00
          MOVE      TDESC,CTYPDESC
          MOVE      ACODE,CLAIMCOD
.
          MOVE      SP10,VISTTIME
          REP       " 0",PVIDATE
.
          UNPACK    PVIDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          MATCH     SP70,VISTTIME
          IF        !@EQUAL
            ENDSET    DISPDATT
            APPEND    " at ",DISPDATT
            APPEND    VISTTIME,DISPDATT
            RESET     DISPDATT
          ENDIF
.
          IF        (DISNUMB%2) = 0
            WRITE     HTMLFILE;"<tr class=TableRowOdd><td nowrap>"
          ELSE
            WRITE     HTMLFILE;"<tr class=TableRowEven><td nowrap>"
          ENDIF
          WRITE     HTMLFILE;"<img src=../images/AppointmentIcon.gif":
                             " class=ListIcon ":
                             " onclick='linkPatient(#"":
                               URNUMBER,"#",#"":
                               WMBOOK,"#",#"":
                               EIGHT,"#",#"":
                               SECOPT,"#",#"":
                               CASEKEYS,"#",#"":
                               SP1,"#",#"":
                               SP1,"#",#"":
                               SP1,"#",#"":
                               SP1,"#",#"":
                               SP1,"#",#"":
                               SP1,"#",#"":
                               HOSPFLAG,"#");'>":
                               DISPDATT,"</td>"
.
          CLEAR     EXTVSTID
          CLEAR     CHKEXTVD
          PACK      CHKEXTVD,WMBOOK,SP70
          PROC      CHKEID00
          MATCH     KEY20,SP70
          IF        @EQUAL
            PACK      EXTVSTID,WMBOOK
          ELSE
            APPEND    WMBOOK,EXTVSTID
            APPEND    SP2,EXTVSTID
            APPEND    "<span class='TextBlue'>(",EXTVSTID
            APPEND    KEY20,EXTVSTID
            APPEND    ")</span>",EXTVSTID
          ENDIF
.
          MATCH     "0",SHOWFRMT                 * Standard
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;",VISTDAY,"</td>":
                               "<td>&nbsp;",VISTTYPE,"</td>":
                               "<td>&nbsp;",UNITCODE,"</td>":
                               "<td>&nbsp;",DOCFNAME,"</td>":
                               "<td>&nbsp;",SP1,"</td>":
                               "<td>&nbsp;",CLAIMCOD,"</td>":
                               "<td>",VSTATUS,"</td>":
                               "<td>&nbsp;",EXTVSTID,"</td>":
                               "<td>&nbsp;",SP1,"</td>"
          ENDIF
.
          MATCH     "1",SHOWFRMT                 * Kids      
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;",VISTDAY,"</td>":
                               "<td>&nbsp;",VISTTYPE,"</td>":
                               "<td>&nbsp;",UNITDESC,"</td>":
                               "<td>&nbsp;",DOCFNAME,"</td>":
                               "<td>&nbsp;",SP1,"</td>":
                               "<td>&nbsp;",CLAIMCOD,"</td>":
                               "<td>",VSTATUS,"</td>":
                               "<td>&nbsp;",EXTVSTID,"</td>"
          ENDIF
.
          MATCH     "2",SHOWFRMT                 * STV
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;",VISTDAY,"</td>":
                               "<td>&nbsp;",VISTTYPE,"</td>":
                               "<td>&nbsp;",UNITDESC,"</td>":
                               "<td>&nbsp;",DOCFNAME,"</td>":
                               "<td>&nbsp;",SP1,"</td>":
                               "<td>&nbsp;",CLAIMCOD,"</td>":
                               "<td>",VSTATUS,"</td>":
                               "<td>&nbsp;",EXTVSTID,"</td>":
                               "<td>&nbsp;",SP1,"</td>"
          ENDIF
.
          MATCH     "1",SHOWCDMI
          IF        @EQUAL
            WRITE      HTMLFILE;"<td>&nbsp;</td>"
          ENDIF
.
          WRITE     HTMLFILE;"</tr>"
.
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      ALLWAT10 IF NOT EQUAL
          MOVE      ZERO,SHOWFLAG
.
ALLWAT95  CALL      NOMORE00               * Show no more visits message 
.
ALLWAT99  RETURN
.
.------------------------------------------------------------
. Output Outpatient Bookings
.------------------------------------------------------------
ALLOUT00  CALL      CREA0000
.
          MOVE      SP70,VISTLOC
          MOVE      SP70,DTYPDESC
          MOVE      SP70,UNITCODE
          MOVE      SP70,UNITDESC
          MOVE      SP70,CTYPDESC
          MOVE      SP70,CLAIMCOD
          MOVE      SP70,VISADIAG
          MOVE      SP70,ADIADESC
          MOVE      SP70,DDIADESC
          MOVE      SP70,SLOTNUMB
          PACK      VISTTYPE,SP70
          PACK      VSTATUS,SP70
          MOVE      "OP",VISTTYPE
          MOVE      ONE,SHOWFLAG
          MOVE      SP70,DOCFNAME
          MOVE      SP70,DESCDOCM
          MOVE      SP70,DESCHOME
          MOVE      SP70,VOLNDESC
          MOVE      SP70,VISTDAY 
          MOVE      SP70,AUDITDTE
          MOVE      ZERO,LOOPCNTR
.
          PACK      KEY36,URNUMBER,Z70
          CALL      RDSBOKA3
ALLOUT10  CALL      RDPBOKA3
          BRANCH    OVRCD,ALLOUT70
.
.         COMPARE   FOUR,FILTVSTA
.         IF        @EQUAL
.           COMPARE   FOUR,OBASTAT
.           GOTO      ALLOUT10 IF NOT EQUAL
.         ENDIF
.
          MOVE      URNUMBER,KEY8
          MATCH     OBAURNO,KEY8         * Check if same U/R
          GOTO      ALLOUT70 IF NOT EQUAL
.
          COMPARE   FOUR,FILTVSTA
          IF        @EQUAL
            COMPARE   FOUR,OBASTAT
            GOTO      ALLOUT10 IF NOT EQUAL
          ENDIF
.
.------------------------------------------------------
. Loop counter to prevent timeout internal server error
.
          ADD       ONE,LOOPCNTR
.
          IF        (LOOPCNTR = 50)
            WRITE     HTMLFILE;"<!-- ",LOOPCNTR," -->"
            MOVE      ZERO,LOOPCNTR
          ENDIF
.
. -----------------------------------------------------
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          IF        OVRCD=0
            MOVE      "AC",CATEGORY
            MOVE      OTBBDEPT,CODE
            CALL      GETCOD00
            MOVE      TDESC,DTYPDESC
.            MOVE      TDESC,UNITDESC
            MOVE      CODE,UNITCODE
          ENDIF
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDPMVX11
          IF        OVRCD=1
            IF        ARCFLAG=1
              MOVE      OBAOUTNO,KEY8
              CALL      RDARVX11
              IF        OVRCD<>1
                CALL      MVPMAR00
              ENDIF
            ENDIF
          ENDIF
          BRANCH    OVRCD,ALLOUT10
.
          MOVE      ONE,HOSPFLAG
          IF        IBCNMHOS=1
            MATCH     SP70,FILTHOSP
            IF        !@EQUAL
              MATCH     FILTHOSP,PMVXMHOS
              GOTO      ALLOUT10 IF NOT EQUAL
            ELSE
              PACK      KEY13,USERID,SP70              * All hospital access
              CALL      RDMLSEC1
              IF        OVRCD=1
                PACK      KEY13,USERID,PMVXMHOS,SP70   * This hospital access
                CALL      RDMLSEC1
                BRANCH    OVRCD,ALLOUT10
              ENDIF
            ENDIF 
            MATCH    WBSEHOSP,PMVXMHOS
            IF       !@EQUAL
              MOVE      ZERO,HOSPFLAG
            ENDIF

          ENDIF 
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDDIAG1
          IF        OVRCD=0
            MOVE      OPDIDESC,ADIADESC
            MOVE      OPDICODE,VISADIAG
          ENDIF
.
          PACK      KEY12,OBASITE,OBACTYP,SP70
          CALL      RDCTYA1
          IF        OVRCD = 0
            MOVE     OCTDESC,UNITDESC
            MOVE     OBACTYP,UNITCODE
          ENDIF
.
          MOVE      OBAOUTNO,PVIBILL
          MOVE      OBADATE,PVIDATE
          MOVE      "2",PVITYPE
          MOVE      " 2",PTVITYPE
          MOVE      OBATIME,VISTTIME
          MOVE      OBASLOT,SLOTNUMB
          MOVE      OBACOMP,ACLAIM
          MOVE      SP70,VSTATUS
          IF        OBASTAT=1|OBASTAT=5|OBASTAT=4
            IF        OBASTAT=1
              MOVE      "Booked",VSTATUS
            ELSE
              IF        OBASTAT=5
                MOVE      "DNA",VSTATUS
              ELSE
                MOVE      "Attended",VSTATUS
              ENDIF
            ENDIF
          ELSE
            GOTO        ALLOUT10
          ENDIF
.
ALLOUT12  PACK      KEY18,OBASITE,OBACLIN,OBADAY,OBASTRT,SP70
          CALL      RDMASA1
          IF        OVRCD=1
            CALL      CLRMAS00
          ENDIF
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RDSESA1
          IF        OVRCD=1
            CALL      CLRSES00
          ENDIF
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          IF        OVRCD=1
            CALL     CLOUTHED
          ENDIF
.
          PACK      VISTLOC,OTHELTYP,SP70
.
          MOVE      "CT",CATEGORY
          MOVE      OTHELTYP,CODE
          CALL      GETCOD00
          MATCH     SP70,TDESC
          IF        !@EQUAL
            PACK      VISTLOC,TDESC,SP70
          ENDIF         
.
          COMPARE   ONE,IBCNMHOS
          IF        @EQUAL
            PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
            CALL      RDMASA1
            IF        OVRCD<>1
              PACK      KEY3,OTHEHOSP
              CALL      FHOS0000
              PACK      VISTLOC,HOSPTEXT,DASH,OTHELTYP,SP70
.
              MOVE      "CT",CATEGORY
              MOVE      OTHELTYP,CODE
              CALL      GETCOD00
              MATCH     SP70,TDESC
              IF        !@EQUAL
                PACK      VISTLOC,HOSPTEXT,DASH,TDESC,SP70
              ENDIF
.
            ENDIF
          ENDIF
.
          MOVE      "CL",CATEGORY
          MOVE      OBACOMP,CODE
          CALL      GETCOD00
          MOVE      TDESC,CTYPDESC
          MOVE      ACODE,CLAIMCOD
.
          PACK      DESCHOME,SP70
          PACK      DESCDOCM,SP70
          MOVE      SP70,VOLNDESC
          PACK      KEY8,DOBAOUTN,SP70
          CALL      RDMRVS1       * Gets the Unique key for the medical record
          BRANCH    OVRCD,ALLOUT15

          PACK      KEY10,MRVSMKEY,SP70
          CALL      RDMRMAS2      * reads the MRT master file for associated rec
          BRANCH    OVRCD,ALLOUT15
.
          MATCH     OBAURNO,MRMAURNO  * Match U/R as might be a merged?
          IF        !@EQUAL
            MOVE      "Incomplete Merge",VOLNDESC
            GOTO      ALLOUT15
          ENDIF
.
          MOVE      DMRMAVOL,VOLNDESC  * Set Volume
.
          MOVE      "TY",KEY2
          PACK      KEY5,KEY2,MRMADOTY
          CALL      RDCODE1
          BRANCH    OVRCD,ALLOUT15
          MOVE      TDESC,DESCDOCM
.
          PACK      KEY7,MRMAHHOS,MRMAHLOC,SP10                       *C-240724
          CALL      RDMRLOC1
          BRANCH    OVRCD,ALLOUT15
          MOVE      MRLODESC,DESCHOME
.
.
.------Outpatient - Read clinic file to get either doctors name, or doctor code
.
ALLOUT15  MATCH     SP6,OBACLIN
          GOTO      ALLOUT60 IF EQUAL
.
          PACK      KEY20,OBASITE,OBACLIN,OBADATE,SP70
          CALL      RDCLIA1
          IF        OVRCD = 0
            GOTO      ALLOUT18
          ENDIF
.
          PACK      KEY20,OBASITE,OBACLIN,OBADATE,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          BRANCH    OVRCD,ALLOUT20
.
          MATCH     OBASITE,OCASITE
          GOTO      ALLOUT20 IF NOT EQUAL
.
          MATCH     OBACLIN,OCACLIN
          GOTO      ALLOUT20 IF NOT EQUAL
.
ALLOUT18  MOVE      OCADESC,DOCFNAME     * If no Doctor Use Clinic Name
          MATCH     SP6,OCADOCT
          GOTO      ALLOUT60 IF EQUAL
          MOVE      OCADOCT,OBADOCT
.
          MOVE      OCADOCT,KEY6         * I CAR 13038
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000
          ENDIF
.                                        * end I CAR 13038
          CALL      FRMD0000
. 
          GOTO      ALLOUT60
.
ALLOUT20  CLEAR     DOCFNAME
          APPEND    "Invalid Clinic - ",DOCFNAME
          APPEND    PVIDOCT,DOCFNAME
          RESET     DOCFNAME
.
ALLOUT60  
.         ADD       ONE,RECNUMB
.         IF        STARTNUM>=RECNUMB
.           GOTO      ALLOUT62
.         ENDIF
.
          MOVE      TWO,OUTVISTT
          MOVE      DOBAOUTN,OUTADMIS
          MOVE      OBASITE,OUTPSITE
.
.         CALL      ALLROW00
.
          CALL      ALLWRT00
.
.         ADD       ONE,DISNUMB
.         COMPARE   DISNUMB,NORECORD
.         IF        @EQUAL
.           MOVE      ZERO,SHOWFLAG
.           GOTO      ALLOUT95
.         ENDIF
.
.
. ---  get rescheduled outpatient bookings ---
.
ALLOUT62  PACK      KEY11,OBAOUTNO,Z70
          CALL      RDSRSHA1
ALLOUT65  CALL      RDPRSHA1
          BRANCH    OVRCD,ALLOUT10
          MATCH     OBAOUTNO,OPRSOUTN
          GOTO      ALLOUT10 IF NOT EQUAL
.
.------------------------------------------------------
. Loop counter to prevent timeout internal server error
.
          ADD       ONE,LOOPCNTR
.
          IF        (LOOPCNTR = 50)
            WRITE     HTMLFILE;"<!-- ",LOOPCNTR," -->"
            MOVE      ZERO,LOOPCNTR
          ENDIF
.
. -----------------------------------------------------
.
          CALL      RCTY0000                   * Get clinic type description
          PACK      VISTLOC,OTMALTYP,SP70
.
          MOVE      "CT",CATEGORY
          MOVE      OTMALTYP,CODE
          CALL      GETCOD00
          MATCH     SP70,TDESC
          IF        !@EQUAL
            PACK      VISTLOC,TDESC,SP70
          ENDIF
.
          COMPARE   ONE,IBCNMHOS
          IF        @EQUAL
            PACK      KEY3,OTHEHOSP
            CALL      FHOS0000
            PACK      VISTLOC,HOSPTEXT,DASH,OTMALTYP,SP70
.
            MOVE      "CT",CATEGORY
            MOVE      OTMALTYP,CODE
            CALL      GETCOD00
            MATCH     SP70,TDESC
            IF        !@EQUAL
              PACK      VISTLOC,HOSPTEXT,DASH,TDESC,SP70
            ENDIF
.
          ENDIF
.
.
          PACK      KEY20,OPRSSITE,OPRSCLIN,OPRSDATE,SP70
          CALL      RDCLIA1
          IF        OVRCD = 0
            MOVE      OCADESC,DOCFNAME     * If no Doctor Use Clinic Name
            GOTO      ALLOUT68
          ENDIF
.
          PACK      KEY20,OPRSSITE,OPRSCLIN,OPRSDATE,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          BRANCH    OVRCD,ALLOUT67
.
          MATCH     OPRSSITE,OCASITE
          GOTO      ALLOUT67 IF NOT EQUAL
.
          MATCH     OPRSCLIN,OCACLIN
          GOTO      ALLOUT67 IF NOT EQUAL
.
          MOVE      OCADESC,DOCFNAME     * If no Doctor Use Clinic Name
.
          MOVE      OCADOCT,KEY6         * I CAR 13038
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000
          ENDIF
.                                        * end I CAR 13038
          CALL      FRMD0000

.
          GOTO      ALLOUT68
.
ALLOUT67  MOVE      "Invalid Clinic",DOCFNAME     * If no Doctor Use Clinic Name
.
ALLOUT68  MOVE      OPRSDATE,PVIDATE
          MOVE      OPRSTIME,VISTTIME
          MOVE      OPRSSLOT,OBASLOT
          REP       " 0",PVIDATE
          MOVE      SP70,DESCDOCM
          MOVE      SP70,DESCHOME
          MOVE      SP70,VOLNDESC
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDMRVS1       * Gets the Unique key for the medical record
          BRANCH    OVRCD,ALLOUT69

          PACK      KEY10,MRVSMKEY,SP70
          CALL      RDMRMAS2      * reads the MRT master file for associated rec
          BRANCH    OVRCD,ALLOUT69
.
          MATCH     OBAURNO,MRMAURNO  * Match U/R as might be a merged?
          IF        !@EQUAL
            MOVE      "Incomplete Merge",VOLNDESC
            GOTO      ALLOUT69
          ENDIF
.
          MOVE      DMRMAVOL,VOLNDESC  * Set Volume
.
          MOVE      "TY",KEY2
          PACK      KEY5,KEY2,MRMADOTY
          CALL      RDCODE1
          BRANCH    OVRCD,ALLOUT69
          MOVE      TDESC,DESCDOCM
.
          PACK      KEY7,MRMAHHOS,MRMAHLOC,SP10                       *C-240724
          CALL      RDMRLOC1
          BRANCH    OVRCD,ALLOUT69
          MOVE      MRLODESC,DESCHOME
.
ALLOUT69  MOVE      "Rescheduled",VSTATUS
          MOVE      "javascript:alert('Rescheduled')",HTMLLINK
.
.         ADD       ONE,RECNUMB
.         IF        STARTNUM>=RECNUMB
.           GOTO      ALLOUT65
.         ENDIF
.
          MOVE      ANSR,OUTVISTT
.         CALL      ALLROW00
.
          CALL      ALLWRT00
.
.         ADD       ONE,DISNUMB
.         COMPARE   DISNUMB,NORECORD
.         IF        @EQUAL
.           MOVE      ZERO,SHOWFLAG
.           GOTO      ALLOUT95
.         ENDIF
.
          GOTO      ALLOUT65
.
. ---  get cancelled outpatient bookings ---
.
ALLOUT70  MOVE      SP70,VISTLOC
          MOVE      SP70,DTYPDESC
          MOVE      SP70,UNITDESC
          MOVE      SP70,UNITCODE
          MOVE      SP70,CTYPDESC
          MOVE      SP70,CLAIMCOD
          MOVE      SP70,VISADIAG
          MOVE      SP70,ADIADESC
          MOVE      SP70,DDIADESC
          MOVE      SP70,SLOTNUMB
          MOVE      SP70,VISTLOC
          PACK      VISTTYPE,SP70
          PACK      VSTATUS,SP70
          MOVE      "OP",VISTTYPE
.
          COMPARE   FOUR,FILTVSTA
          GOTO      ALLOUT95 IF EQUAL
.
          PACK      KEY24,URNUMBER,Z70
          CALL      RSOTCAN2
ALLOUT75  CALL      RPOTCAN2
          BRANCH    OVRCD,ALLOUT95
.
          MATCH     URNUMBER,OPCNURNO
          GOTO      ALLOUT95 IF NOT EQUAL
.
.------------------------------------------------------
. Loop counter to prevent timeout internal server error
.
          ADD       ONE,LOOPCNTR
.
          IF        (LOOPCNTR = 50)
            WRITE     HTMLFILE;"<!-- ",LOOPCNTR," -->"
            MOVE      ZERO,LOOPCNTR
          ENDIF
.
. -----------------------------------------------------
.
          CALL      CCTY0000                   * Get clinic type description
.
          IF        IBCNMHOS=1
            MATCH     SP70,FILTHOSP
            IF        !@EQUAL
              MATCH     FILTHOSP,OTHEHOSP
              GOTO      ALLOUT75 IF NOT EQUAL
            ELSE
              PACK      KEY13,USERID,SP70              * All hospital access
              CALL      RDMLSEC1
              IF        OVRCD=1
                PACK      KEY13,USERID,OTHEHOSP,SP70   * This hospital access
                CALL      RDMLSEC1
                BRANCH    OVRCD,ALLOUT75
              ENDIF
            ENDIF
          ENDIF
.
          PACK      VISTLOC,OTMALTYP,SP70
.
          MOVE      "CT",CATEGORY
          MOVE      OTMALTYP,CODE
          CALL      GETCOD00
          MATCH     SP70,TDESC
          IF        !@EQUAL
            PACK      VISTLOC,TDESC,SP70
          ENDIF
.
          COMPARE   ONE,IBCNMHOS
          IF        @EQUAL
            PACK      KEY3,OTHEHOSP
            CALL      FHOS0000
            PACK      VISTLOC,HOSPTEXT,DASH,OTMALTYP,SP70
.
            MOVE      "CT",CATEGORY
            MOVE      OTMALTYP,CODE
            CALL      GETCOD00
            MATCH     SP70,TDESC
            IF        !@EQUAL
              PACK      VISTLOC,HOSPTEXT,DASH,TDESC,SP70
            ENDIF
.
          ENDIF
.
          PACK      KEY36,DOPCNOUT,OPCNDATE,OPCNSTRT,DOPCNSLO,OPCNSITE,OPCNCLIN
          CALL      RDBOKA3
          BRANCH    OVRCD,ALLOUT80
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,ALLOUT77
.
          PACK      KEY12,OBASITE,OBACTYP,SP70
          CALL      RDCTYA1
          IF        OVRCD = 0
            MOVE     OCTDESC,UNITDESC
            MOVE     OBACTYP,UNITCODE
          ENDIF
.
ALLOUT77  MATCH     OBAURNO,URNUMBER
          GOTO      ALLOUT75 IF EQUAL
.
ALLOUT80  MOVE      OPCNDATE,PVIDATE
          MOVE      OPCNOUTN,PVIBILL
          MOVE      "2",PVITYPE
          MOVE      " 2",PTVITYPE
          MOVE      OPCNTIME,VISTTIME
          MOVE      DOPCNOUT,SLOTNUMB
          MOVE      SP70,VSTATUS
          MOVE      "Cancelled",VSTATUS
          MATCH     SP70,OPCNCLIN
          GOTO      ALLOUT85 IF EQUAL
.
          PACK      KEY20,OPCNSITE,OPCNCLIN,OPCNDATE,SP70
          CALL      RDCLIA1
          IF        OVRCD = 0
            GOTO      ALLOUT81
          ENDIF
.
          PACK      KEY20,OPCNSITE,OPCNCLIN,OPCNDATE,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          BRANCH    OVRCD,ALLOUT82
.
          MATCH     OPCNSITE,OCASITE
          GOTO      ALLOUT82 IF NOT EQUAL
.
          MATCH     OPCNCLIN,OCACLIN
          GOTO      ALLOUT82 IF NOT EQUAL
.
ALLOUT81  MOVE      OCADESC,DOCFNAME     * If no Doctor Use Clinic Name
          MATCH     SP6,OCADOCT
          GOTO      ALLOUT85 IF EQUAL
          MOVE      OCADOCT,OPCNCLIN     * Use the doctor's code from the clinic
.
          MOVE      OCADOCT,KEY6         * I CAR 13038
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000
          ENDIF
.                                        * end I CAR 13038
          CALL      FRMD0000
.
          GOTO      ALLOUT85
.
ALLOUT82  CLEAR     DOCFNAME
          APPEND    "Invalid Clinic - ",DOCFNAME
          APPEND    PVIDOCT,DOCFNAME
          RESET     DOCFNAME
.
ALLOUT85  MOVE      OPCNOUTN,OBAOUTNO
          MOVE      OPCNURNO,OBAURNO
          MOVE      OPCNSLOT,OBASLOT
          REP       " 0",PVIDATE
          MOVE      SP70,DESCDOCM
          MOVE      SP70,DESCHOME
          MOVE      SP70,VOLNDESC
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDMRVS1       * Gets the Unique key for the medical record
          BRANCH    OVRCD,ALLOUT87
.
          PACK      KEY10,MRVSMKEY,SP70
          CALL      RDMRMAS2      * reads the MRT master file for associated rec
          BRANCH    OVRCD,ALLOUT87
.
          MATCH     OBAURNO,MRMAURNO  * Match U/R as might be a merged?
          IF        !@EQUAL
            MOVE      "Incomplete Merge",VOLNDESC
            GOTO      ALLOUT87
          ENDIF
.
          MOVE      DMRMAVOL,VOLNDESC  * Set Volume
.
          MOVE      "TY",KEY2
          PACK      KEY5,KEY2,MRMADOTY
          CALL      RDCODE1
          BRANCH    OVRCD,ALLOUT87
          MOVE      TDESC,DESCDOCM
.
          PACK      KEY7,MRMAHHOS,MRMAHLOC,SP10                       *C-240724
          CALL      RDMRLOC1
          BRANCH    OVRCD,ALLOUT87
          MOVE      MRLODESC,DESCHOME
.
ALLOUT87  
.         ADD       ONE,RECNUMB
.         IF        STARTNUM>=RECNUMB
.           GOTO      ALLOUT75
.         ENDIF
. 
          MOVE      FOUR,OUTVISTT
          MOVE      DOPCNOUT,OUTADMIS
          MOVE      OPCNSITE,OUTPSITE
.
.         CALL      ALLROW00
.
          CALL      ALLWRT00
.
.         ADD       ONE,DISNUMB
.         COMPARE   DISNUMB,NORECORD
.         IF        @EQUAL
.           MOVE     ZERO,SHOWFLAG
.           GOTO      ALLOUT95
.         ENDIF
.
          GOTO      ALLOUT75
.
ALLOUT95  MOVE      NINE,LOOPCNTR
.
          PACK      KEY30,Z70
          CALL      RSTEMP1
ALLOUT96  CALL      RPTEMP1
          BRANCH    OVRCD,ALLOUT98
.
.------------------------------------------------------
. Loop counter to prevent timeout internal server error
.
          ADD       ONE,LOOPCNTR
.
          IF        (LOOPCNTR = 10)
            WRITE     HTMLFILE;"<!-- ",LOOPCNTR," -->"
            MOVE      ZERO,LOOPCNTR
          ENDIF
.
. ----------------------------------------------------
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      ALLOUT96
          ENDIF
.
          CALL      ALLROW00
.
          ADD       ONE,DISNUMB
          COMPARE   DISNUMB,NORECORD
          IF        @EQUAL
            MOVE      ZERO,SHOWFLAG
            GOTO      ALLOUT98
          ENDIF
.
          GOTO      ALLOUT96
.
.         MATCH     "1",OUTORDER
.         GOTO      ALLOUT99 IF NOT EQUAL
.
ALLOUT98  CALL      NOMORE00                * Show no more visits message
.
          CALL      CLER0000
          CALL      KILL0000
.
ALLOUT99  RETURN
.------------------------------------------------------------
.     Reservation Expiry Processing by site
.------------------------------------------------------------
.------------------------------------------------------------
CHKSIT00  MOVE      ZERO,SITEDONE           * This site prefix done = No
          PACK      KEY9,SP70
          CALL      RDSSITA3
CHKSIT10  CALL      RDKSITA3
          BRANCH    OVRCD,CHKSIT95
.
          MATCH     OSTFILE,CFILEPRE        * Same as Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE      * Save Current File Prefix
            CALL      OPNOUT00              * Open Files
            MOVE      ZERO,SITEDONE         * This site prefix done = No
          ENDIF
.
          BRANCH    SITEDONE,CHKSIT10       * Skip if this site prefix is done
.
          CALL      ALLSIT00                * Check reservation expiry
          MOVE      ONE,SITEDONE            * This site prefix done = yes
.
          GOTO      CHKSIT10
.
CHKSIT95  CALL      NOMORE00                * Show no more visits message
.
CHKSIT99  RETURN
.
.------------------------------------------------------------
.     Inform GP outpatient bookings           
.------------------------------------------------------------
ALSITE00  MOVE      ZERO,SITEDONE           * This site prefix done = No
          PACK      KEY9,SP70
          CALL      RDSSITA3
ALSITE10  CALL      RDKSITA3
          BRANCH    OVRCD,ALSITE95
.         
          MATCH     OSTFILE,CFILEPRE        * Same as Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE      * Save Current File Prefix
            CALL      OPNOUT00              * Open Files
            MOVE      ZERO,SITEDONE         * This site prefix done = No
          ENDIF
.
          BRANCH    SITEDONE,ALSITE10       * Skip if this site prefix is done
.
          CALL      OUTLST00                * Output outpatient bookings
          MOVE      ONE,SITEDONE            * This site prefix done = yes
.
          GOTO      ALSITE10
.
ALSITE95
.
ALSITE99  RETURN
.------------------------------------------------------------
. Output Outpatient Bookings
.------------------------------------------------------------
ALLSIT00  MOVE      SP70,VISTLOC
          MOVE      SP70,DTYPDESC
          MOVE      SP70,UNITCODE
          MOVE      SP70,UNITDESC
          MOVE      SP70,CTYPDESC
          MOVE      SP70,CLAIMCOD
          MOVE      SP70,VISADIAG
          MOVE      SP70,ADIADESC
          MOVE      SP70,DDIADESC
          MOVE      SP70,SLOTNUMB
          PACK      VISTTYPE,SP70
          PACK      VSTATUS,SP70
          MOVE      "OP",VISTTYPE
          MOVE      ONE,SHOWFLAG
.
          PACK      KEY36,URNUMBER,Z70
          CALL      RDSBOKA3
ALLSIT10  CALL      RDPBOKA3
          BRANCH    OVRCD,ALLSIT99
          MOVE      URNUMBER,KEY8
          MATCH     OBAURNO,KEY8         * Check if same U/R
          GOTO      ALLSIT99 IF NOT EQUAL
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          IF        OVRCD=0
            MOVE      "AC",CATEGORY
            MOVE      OTBBDEPT,CODE
            CALL      GETCOD00
            MOVE      TDESC,DTYPDESC
.            MOVE      TDESC,UNITDESC
            MOVE      CODE,UNITCODE
          ENDIF
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDPMVX11
          IF        OVRCD=1
            IF        ARCFLAG=1
              MOVE      OBAOUTNO,KEY8
              CALL      RDARVX11
              IF        OVRCD<>1
                CALL      MVPMAR00
              ENDIF
            ENDIF
          ENDIF
          BRANCH    OVRCD,ALLSIT10
.
          MOVE     ONE,HOSPFLAG
          IF        IBCNMHOS=1
            MATCH     SP70,FILTHOSP
            IF        !@EQUAL
              MATCH     FILTHOSP,PMVXMHOS
              GOTO      ALLSIT10 IF NOT EQUAL
            ELSE
              PACK      KEY13,USERID,SP70              * All hospital access
              CALL      RDMLSEC1
              IF        OVRCD=1
                PACK      KEY13,USERID,PMVXMHOS,SP70   * This hospital access
                CALL      RDMLSEC1
                BRANCH    OVRCD,ALLSIT10
              ENDIF
            ENDIF
            MATCH    WBSEHOSP,PMVXMHOS
            IF       !@EQUAL
              MOVE      ZERO,HOSPFLAG
            ENDIF
          ENDIF
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDDIAG1
          IF        OVRCD=0
            MOVE      OPDIDESC,ADIADESC
            MOVE      OPDICODE,VISADIAG
          ENDIF
.
          PACK      KEY12,OBASITE,OBACTYP,SP70
          CALL      RDCTYA1
          IF        OVRCD = 0
            MOVE     OCTDESC,UNITDESC
            MOVE     OBACTYP,UNITCODE
          ENDIF
.
          MOVE      OBADATE,PVIDATE
          MOVE      OBAOUTNO,PVIBILL
          MOVE      "2",PVITYPE
          MOVE      " 2",PTVITYPE
          MOVE      OBATIME,VISTTIME
          MOVE      OBASLOT,SLOTNUMB
          MOVE      OBACOMP,ACLAIM
          MOVE      SP70,VSTATUS
          IF        OBASTAT=1|OBASTAT=5
            IF        OBASTAT=1
              MOVE      "Booked",VSTATUS
            ELSE
              MOVE      "DNA",VSTATUS
            ENDIF
          ELSE
            GOTO        ALLSIT10
          ENDIF
.
ALLSIT12  PACK      KEY18,OBASITE,OBACLIN,OBADAY,OBASTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,ALLSIT99
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,ALLSIT99
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,ALLSIT99
.
          PACK      VISTLOC,OTHELTYP,SP70
.
          MOVE      "CT",CATEGORY
          MOVE      OTHELTYP,CODE
          CALL      GETCOD00
          MATCH     SP70,TDESC
          IF        !@EQUAL
            PACK      VISTLOC,TDESC,SP70
          ENDIF
.
          COMPARE   ONE,IBCNMHOS
          IF        @EQUAL
            PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
            CALL      RDMASA1
            IF        OVRCD<>1
              PACK      KEY3,OTHEHOSP
              CALL      FHOS0000
.
              PACK      VISTLOC,HOSPTEXT,DASH,OTHELTYP,SP70
              MOVE      "CT",CATEGORY
              MOVE      OTHELTYP,CODE
              CALL      GETCOD00
              MATCH     SP70,TDESC
              IF        !@EQUAL
                PACK      VISTLOC,HOSPTEXT,DASH,TDESC,SP70
              ENDIF      
. 
            ENDIF
          ENDIF
.
          MOVE      "CL",CATEGORY
          MOVE      OBACOMP,CODE
          CALL      GETCOD00
          MOVE      TDESC,CTYPDESC
          MOVE      ACODE,CLAIMCOD
.
          PACK      DESCHOME,SP70
          PACK      DESCDOCM,SP70
          MOVE      SP70,VOLNDESC
          PACK      KEY8,DOBAOUTN,SP70
          CALL      RDMRVS1       * Gets the Unique key for the medical record
          BRANCH    OVRCD,ALLSIT15

          PACK      KEY10,MRVSMKEY,SP70
          CALL      RDMRMAS2      * reads the MRT master file for associated rec
          BRANCH    OVRCD,ALLSIT15
.
          MATCH     OBAURNO,MRMAURNO  * Match U/R as might be a merged?
          IF        !@EQUAL
            MOVE      "Incomplete Merge",VOLNDESC
            GOTO      ALLSIT15
          ENDIF
.
          MOVE      DMRMAVOL,VOLNDESC  * Set Volume
.
          MOVE      "TY",KEY2
          PACK      KEY5,KEY2,MRMADOTY
          CALL      RDCODE1
          BRANCH    OVRCD,ALLSIT15
          MOVE      TDESC,DESCDOCM
.
          PACK      KEY7,MRMAHHOS,MRMAHLOC,SP10                       *C-240724
          CALL      RDMRLOC1
          BRANCH    OVRCD,ALLSIT15
          MOVE      MRLODESC,DESCHOME
.
.
.------Outpatient - Read clinic file to get either doctors name, or doctor code
.
ALLSIT15
          MOVE      PVIBILL,KEY8
          CALL      RDDIAG1
          IF        OVRCD=0
            MOVE      OPDICODE,VISADIAG   * Diagnosis code
            MOVE      OPDIDESC,ADIADESC   * Diagnosis description
          ENDIF
.
          MATCH     SP6,OBACLIN
          GOTO      ALLSIT60 IF EQUAL
.
          PACK      KEY20,OBASITE,OBACLIN,OBADATE,SP70
          CALL      RDCLIA1
          IF        OVRCD = 0
            GOTO      ALLSIT18
          ENDIF
.
          PACK      KEY20,OBASITE,OBACLIN,OBADATE,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          BRANCH    OVRCD,ALLSIT20
.
          MATCH     OBASITE,OCASITE
          GOTO      ALLSIT20 IF NOT EQUAL
.
          MATCH     OBACLIN,OCACLIN
          GOTO      ALLSIT20 IF NOT EQUAL
.
ALLSIT18  MOVE      OCADESC,DOCFNAME     * If no Doctor Use Clinic Name
          MATCH     SP6,OCADOCT
          GOTO      ALLSIT60 IF EQUAL
          MOVE      OCADOCT,OBADOCT      * Use the doctor's code from the clinic
          GOTO      ALLSIT60
.
ALLSIT20  CLEAR     DOCFNAME
          APPEND    "Invalid Clinic - ",DOCFNAME
          APPEND    PVIDOCT,DOCFNAME
          RESET     DOCFNAME
.
ALLSIT60  ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      ALLSIT10
          ENDIF
.
          MOVE      TWO,OUTVISTT
          MOVE      DOBAOUTN,OUTADMIS
          MOVE      OBASITE,OUTPSITE
.
          CALL      ALLROW00
          ADD       ONE,DISNUMB
          COMPARE   DISNUMB,NORECORD
          IF        @EQUAL
            MOVE      ZERO,SHOWFLAG
            GOTO      ALLSIT99
          ENDIF
.
          GOTO      ALLSIT10
.
ALLSIT99  RETURN
.
.------------------------------------------------------------
. Cancelled Admissions 
.------------------------------------------------------------
ALLCAD00  MOVE      SP70,VISTLOC
          MOVE      SP70,DTYPDESC
          MOVE      SP70,UNITCODE
          MOVE      SP70,UNITDESC
          MOVE      SP70,CTYPDESC
          MOVE      SP70,CLAIMCOD
          MOVE      SP70,VISADIAG
          MOVE      SP70,ADIADESC
          MOVE      SP70,DDIADESC
          MOVE      SP70,SLOTNUMB
          PACK      VISTTYPE,SP70
          PACK      VSTATUS,SP70
          MOVE      SP70,VISTLOC
.
          PACK      KEY17,URNUMBER,FIVE,SP20
          CALL      RSPTMI18 
ALLCAD10  CALL      RKPTMI18
          BRANCH    OVRCD,ALLCAD95
.
          MATCH     URNUMBER,AURNO          * Same U/R ?
          GOTO      ALLCAD95 IF NOT EQUAL
. 
          COMPARE   FIVE,ASTAT              * Same admission status?
          GOTO      ALLCAD95 IF NOT EQUAL  
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      ALLCAD10
          ENDIF
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDVISA1
          BRANCH    OVRCD,ALLCAD10
.
          MOVE      ATIME,VISTTIME
.
          MOVE      SP70,DISPDATT
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          MATCH     SP70,VISTTIME
          IF        !@EQUAL
            ENDSET    DISPDATT
            APPEND    " at ",DISPDATT
            APPEND    VISTTIME,DISPDATT
            RESET     DISPDATT
          ENDIF

          MOVE      SP70,VISTDAY            * Format Day
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
          LOAD      DAYNAM3,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
          PACK      VISTDAY,DAYNAM3,SP70
.
          MOVE      "IP",VISTTYPE           * Visit Type
.
          MOVE      "AC",CATEGORY
          MOVE      ACLSSFT,CODE
          CALL      GETCOD00
          MOVE      TDESC,UNITDESC          * Unit Description
          MOVE      CODE,UNITCODE
.
          MOVE      ADOCTA,KEY6
          CALL      RDDOCT1
          IF        OVRCD=1
            MOVE      SP70,DOCFNAME
          ELSE
.           CALL      DOCNAM00              * Format HCP/Doctor Name
            MOVE      DTITL,FMTTITLE            * I CAR 13038
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000                  * end I CAR 13038
          ENDIF
.
          MOVE     ONE,HOSPFLAG
          IF        IBCNMHOS=1
            MOVE      SP70,PTWDHOSN
            PACK      KEY6,PTMIXWRD,SP70
            CALL      RDWARD1
            IF        OVRCD=0
              PACK      KEY3,PTWDHOSN
              CALL      FHOS0000
              PACK      VISTLOC,HOSPTEXT,SP70
            ENDIF
            MATCH     SP70,FILTHOSP
            IF        !@EQUAL
              MATCH     FILTHOSP,PTWDHOSN
              GOTO      ALLCAD10 IF NOT EQUAL
            ELSE
              PACK      KEY13,USERID,SP70              * All hospital access
              CALL      RDMLSEC1
              IF        OVRCD=1
                PACK      KEY13,USERID,PTWDHOSN,SP70   * This hospital access
                CALL      RDMLSEC1
                BRANCH    OVRCD,ALLCAD10
              ENDIF
            ENDIF
            MATCH    WBSEHOSP,PTWDHOSN
            IF       !@EQUAL
              MOVE      ZERO,HOSPFLAG
            ENDIF
          ENDIF
.
          MOVE      "CL",CATEGORY
          MOVE      ACLAIM,CODE
          CALL      GETCOD00
          MOVE      TDESC,CTYPDESC          * Insurance class description
          MOVE      ACODE,CLAIMCOD
.
          MOVE      "Cancelled",VSTATUS     * Visit Status
.
          ADD       ONE,VISCOUNT

          IF        (DISNUMB%2) = 0
            WRITE     HTMLFILE;"<tr class=TableRowOdd><td nowrap>"
          ELSE
            WRITE     HTMLFILE;"<tr class=TableRowEven><td nowrap>"
          ENDIF
          WRITE     HTMLFILE;"<img src=../images/AppointmentIcon.gif":
                             " class=ListIcon ":
                             " onclick='linkPatient(#"":
                               URNUMBER,"#",#"":
                               DAADMNO,"#",#"":
                               THREE,"#",#"":
                               SECOPT,"#",#"":
                               CASEKEYS,"#",#"":
                               SP1,"#",#"":
                               SP1,"#",#"":
                               SP1,"#",#"":
                               SP1,"#",#"":
                               SP1,"#",#"":
                               SP1,"#",#"":
                               HOSPFLAG,"#");'>":
                               DISPDATT,"</td>"
.
          CLEAR     EXTVSTID
          CLEAR     CHKEXTVD
          PACK      CHKEXTVD,AADMNO,SP70
          PROC      CHKEID00
          MATCH     KEY20,SP70
          IF        @EQUAL
            PACK      EXTVSTID,AADMNO
          ELSE
            APPEND    AADMNO,EXTVSTID
            APPEND    SP2,EXTVSTID
            APPEND    "<span class='TextBlue'>(",EXTVSTID
            APPEND    KEY20,EXTVSTID
            APPEND    ")</span>",EXTVSTID
          ENDIF
.
          MATCH     "0",SHOWFRMT                 * Standard
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;",VISTDAY,"</td>";
.                              "<td>&nbsp;",VISTTYPE,"</td>":
.
            CALL      THBL0000
.
            WRITE     HTMLFILE;"<td>&nbsp;",VISTLINK,"</td>":
                               "<td>&nbsp;",UNITCODE,"</td>":
                               "<td>&nbsp;",DOCFNAME,"</td>":
                               "<td>&nbsp;",VISTLOC,"</td>":
                               "<td>&nbsp;",CLAIMCOD,"</td>":
                               "<td>",VSTATUS,"</td>":
                               "<td>&nbsp;",EXTVSTID,"</td>":
                               "<td>&nbsp;",SP1,"</td>"
          ENDIF
.
          MATCH     "1",SHOWFRMT                 * Kids      
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;",VISTDAY,"</td>":
                               "<td>&nbsp;",VISTTYPE,"</td>":
                               "<td>&nbsp;",UNITDESC,"</td>":
                               "<td>&nbsp;",DOCFNAME,"</td>":
                               "<td>&nbsp;",SP1,"</td>":
                               "<td>&nbsp;",CLAIMCOD,"</td>":
                               "<td>",VSTATUS,"</td>":
                               "<td>&nbsp;",SP1,"</td>"
          ENDIF
.
          MATCH     "2",SHOWFRMT                 * STV
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;",VISTDAY,"</td>":
                               "<td>&nbsp;",VISTTYPE,"</td>":
                               "<td>&nbsp;",UNITDESC,"</td>":
                               "<td>&nbsp;",DOCFNAME,"</td>":
                               "<td>&nbsp;",SP1,"</td>":
                               "<td>&nbsp;",CLAIMCOD,"</td>":
                               "<td>",VSTATUS,"</td>":
                               "<td>&nbsp;",SP1,"</td>":
                               "<td>&nbsp;",SP1,"</td>"
          ENDIF
.
          MATCH     "1",SHOWCDMI
          IF        @EQUAL
            WRITE      HTMLFILE;"<td>&nbsp;</td>"
          ENDIF
.
          WRITE     HTMLFILE;"</tr>"
.
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      ALLCAD10 IF NOT EQUAL
          MOVE      ZERO,SHOWFLAG
.
ALLCAD95  CALL      NOMORE00               * Show no more visits message 
.
ALLCAD99  RETURN
.
.------------------------------------------------------------
. Output row details
.------------------------------------------------------------
ALLROW00  REP       " 0",PVIDATE
          MOVE      SP70,VISTDAY
          UNPACK    PVIDATE,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
          LOAD      DAYNAM3,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
          PACK      VISTDAY,DAYNAM3,SP70
.
          UNPACK    PVIDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          MATCH     SP70,VISTTIME
          IF        !@EQUAL
            ENDSET    DISPDATT
            APPEND    " at ",DISPDATT
            APPEND    VISTTIME,DISPDATT
            RESET     DISPDATT
          ENDIF
.
          CALL      MRTDES00
.
          IF        (DISNUMB%2) = 0
            WRITE     HTMLFILE;"<tr class=TableRowOdd><td nowrap>"
          ELSE
            WRITE     HTMLFILE;"<tr class=TableRowEven><td nowrap>"
          ENDIF
.
          MATCH     ANSR,OUTVISTT
          IF        @EQUAL
            WRITE     HTMLFILE;"<img src=../images/AppointmentIcon.gif":
                               " class=ListIcon ":
                               " onclick='alert(#"":
                                 "Rescheduled#");'>":
                                 DISPDATT,"</td>"
          ELSE
            WRITE     HTMLFILE;"<img src=../images/AppointmentIcon.gif":
                               " class=ListIcon ":
                               " onclick='linkPatient(#"":
                                 URNUMBER,"#",#"":
                                 OUTADMIS,"#",#"":
                                 OUTVISTT,"#",#"":
                                 "#",#"":
                                 "#",#"":
                                 OUTPSITE,"#",#"":
                                 "#",#"":
                                 "#",#"":
                                 "#",#"":
                                 "#",#"":
                                 "#",#"":
                                 HOSPFLAG,"#");'>":
                                 DISPDATT,"</td>"
          ENDIF
.
          CLEAR     EXTVSTID
          CLEAR     CHKEXTVD
          PACK      CHKEXTVD,OBAOUTNO,SP70
          PROC      CHKEID00
          MATCH     KEY20,SP70
          IF        @EQUAL
            PACK      EXTVSTID,OBAOUTNO
          ELSE
            APPEND    OBAOUTNO,EXTVSTID
            APPEND    SP2,EXTVSTID
            APPEND    "<span class='TextBlue'>(",EXTVSTID
            APPEND    KEY20,EXTVSTID
            APPEND    ")</span>",EXTVSTID
          ENDIF
.
          MATCH     "0",SHOWFRMT                 * Standard
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;",VISTDAY,"</td>":
                               "<td>&nbsp;",VISTTYPE,"</td>":
                               "<td>&nbsp;",UNITCODE,"</td>":
                               "<td>&nbsp;",DOCFNAME,"</td>":
                               "<td>&nbsp;",VISTLOC,"</td>":
                               "<td>&nbsp;",CLAIMCOD,"</td>":
                               "<td>",VSTATUS,"</td>":
                               "<td>&nbsp;",EXTVSTID,"</td>";
.
            MATCH      "1",SHOWMEDL
            IF         @EQUAL
              MATCH      SP70,VOLNDESC
              IF         @EQUAL
                WRITE      HTMLFILE;"<td>":
                                    "<input type=checkbox name=lnkadmis":
                                    " value='",OUTADMIS,"'></td>"
              ELSE
                WRITE      HTMLFILE;"<td>&nbsp;":
                                    "<img src=../images/EditIcon.gif":
                                    " class=ListIcon":  
                                    " onclick='LinkMedicalRec(#"":
                                    OUTADMIS,"#",#"",URNUMBER,"#");'>":
                                    VOLNDESC," "
                MATCH      SP70,MRVSXKY1
                IF         @EQUAL
                  WRITE      HTMLFILE;"</td>"
                ELSE
                  WRITE      HTMLFILE;"+ </td>"
                ENDIF
              ENDIF
            ELSE    
              WRITE      HTMLFILE;"<td>&nbsp;",VOLNDESC," "
              MATCH      SP70,MRVSXKY1
              IF         @EQUAL
                WRITE      HTMLFILE;"</td>"
              ELSE
                WRITE      HTMLFILE;"+ </td>"
              ENDIF
            ENDIF  
          ENDIF
.
          MATCH     "1",SHOWFRMT                 * Kids      
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;",VISTDAY,"</td>":
                               "<td>&nbsp;",VISTTYPE,"</td>":
                               "<td>&nbsp;",UNITDESC,"</td>":
                               "<td>&nbsp;",DOCFNAME,"</td>":
                               "<td>&nbsp;",VISTLOC,"</td>":
                               "<td>&nbsp;",CLAIMCOD,"</td>":
                               "<td>",VSTATUS,"</td>":
                               "<td>&nbsp;",EXTVSTID,"</td>"
          ENDIF
.
          MATCH     "2",SHOWFRMT                 * STV
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;",VISTDAY,"</td>":
                               "<td>&nbsp;",VISTTYPE,"</td>":
                               "<td>&nbsp;",UNITDESC,"</td>":
                               "<td>&nbsp;",DOCFNAME,"</td>":
                               "<td>&nbsp;",VISTLOC,"</td>":
                               "<td>&nbsp;",CLAIMCOD,"</td>":
                               "<td>",VSTATUS,"</td>":
                               "<td>&nbsp;",EXTVSTID,"</td>";
.
            MATCH      "1",SHOWMEDL
            IF         @EQUAL
              MATCH      SP70,VOLNDESC
              IF         @EQUAL
                WRITE      HTMLFILE;"<td>":
                                    "<input type=checkbox name=lnkadmis":
                                    " value='",OUTADMIS,"'></td>"
              ELSE
                WRITE      HTMLFILE;"<td>&nbsp;":
                                    "<img src=../images/EditIcon.gif":
                                    " class=ListIcon":  
                                    " onclick='LinkMedicalRec(#"":
                                    OUTADMIS,"#",#"",URNUMBER,"#");'>":
                                    VOLNDESC
                MATCH      SP70,MRVSXKY1
                IF         @EQUAL
                  WRITE      HTMLFILE;"</td>"
                ELSE
                  WRITE      HTMLFILE;"+ </td>"
                ENDIF
              ENDIF
            ELSE    
              WRITE      HTMLFILE;"<td>&nbsp;",VOLNDESC,"</td>"
              MATCH      SP70,MRVSXKY1
              IF         @EQUAL
                WRITE      HTMLFILE;"</td>"
              ELSE
                WRITE      HTMLFILE;"+ </td>"
              ENDIF
            ENDIF 
          ENDIF
.
ALLROW90  MATCH     "1",SHOWCDMI
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;";
            CALL      VCDM0000                   * Visit based CDM
            WRITE     HTMLFILE;"</td>";
          ENDIF
.
          WRITE     HTMLFILE;"</tr>"
.
ALLROW99  RETURN
.
.------------------------------------------------------------
. NOMORE00 - Display "No more visits" at end of visit list by type
.------------------------------------------------------------
NOMORE00  COMPARE    ONE,SHOWFLAG
          GOTO       NOMORE99 IF NOT EQUAL
.
          MATCH     "1",NMDSLIST
          IF        @EQUAL
             WRITE      HTMLFILE;"<tr bgcolor=#FF0000>":
                                 "<td colspan=12 align=center>":
                                 "No more visits</td>"
             GOTO       NOMORE99
          ENDIF
.
          MATCH     "2",DEFAULTA
          IF        @EQUAL
             WRITE      HTMLFILE;"<tr bgcolor=#FF0000>":
                                 "<td colspan=12 align=center>":
                                 "No more visits</td>"
             GOTO       NOMORE99
          ENDIF
.
          MATCH     "0",SHOWFRMT
          IF        @EQUAL
            MATCH      "1",SHOWCDMI
            IF         @EQUAL
              WRITE      HTMLFILE;"<tr bgcolor=#FF0000>":
                                  "<td colspan=11 align=center>":
                                  "No more visits</td>"
            ELSE
              WRITE      HTMLFILE;"<tr bgcolor=#FF0000>":
                                  "<td colspan=10 align=center>":
                      "<span style='float:left' id=InsertNoVisitChbx></span>":
                                  "No more visits</td>"
            ENDIF
          ELSE
             MATCH     "2",SHOWFRMT
             IF        @EQUAL
               WRITE      HTMLFILE;"<tr bgcolor=#FF0000>":
                                   "<td colspan=10 align=center>":
                                   "No more visits</td>"
             ELSE
               WRITE      HTMLFILE;"<tr bgcolor=#FF0000>":
                                   "<td colspan=9 align=center>":
                                   "No more visits</td>"
             ENDIF
          ENDIF
.
NOMORE99  RETURN
.
.------------------------------------------------------------
. GETPVS00 - Read back one page full of record to get the
.            previous visit button visit file start key.
.            This is only for the inpatient visit type display
.------------------------------------------------------------
GETPVS00  PACK      KEY26,PREVVKEY,Z70
          PACK      SAVKEY26,SP70
          MOVE      ZERO,F2
          ADD       ONE,NORECORD
.
          CALL      RDSVISA4
GETPVS10  CALL      RDKVISA4
          BRANCH    OVRCD,GETPVS91
.
          MATCH     URNUMBER,PVIURNO
          GOTO      GETPVS91 IF NOT EQUAL
.
          MATCH     " 3",PTVITYPE
          GOTO      GETPVS91 IF NOT EQUAL
.
          PACK      SAVKEY26,URNUMBER,PTVITYPE,PVIDATE,DPVIBILL,SP70
          ADD       ONE,F2
          COMPARE   F2,NORECORD
          GOTO      GETPVS90 IF EQUAL
.
          GOTO      GETPVS10
.
GETPVS90  MOVE      SAVKEY26,KEY26          * New start key for display
          SUB       ONE,NORECORD
          GOTO      GETPVS99
.
GETPVS91  PACK      KEY26,URNUMBER,SP1,THREE,Z70
          SUB       ONE,NORECORD
          GOTO      GETPVS99
.
GETPVS99  RETURN
.------------------------------------------------------------
. LASTVS00 - Check to see if this is the last visit number
.            displayed. If so the next button will go back to the start.
.------------------------------------------------------------
LASTVS00  PACK      KEY26,NEXTVKEY,SP70
          CALL      RDSVISA4
LASTVS10  CALL      RDPVISA4
          BRANCH    OVRCD,LASTVS90
.
          MATCH     URNUMBER,PVIURNO
          GOTO      LASTVS90 IF NOT EQUAL
.
          MATCH     " 3",PTVITYPE
          GOTO      LASTVS90 IF NOT EQUAL
.
          GOTO      LASTVS99
.
LASTVS90  PACK      NEXTVKEY,URNUMBER,SP1,THREE,Z70
          GOTO      LASTVS99                * No more record goto firt visit
.
LASTVS99  RETURN
.
.------------------------------------------------------------
. Output TAC Table Details  
.------------------------------------------------------------
UTCTAB00  MOVE      ZERO,DIM1
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,ANS,DIM127      * Visit Type Flag
          UNPACK    DIM127,D1,KEY1,DIM127     * Admission Status Flag
          UNPACK    DIM127,D1,DIM1,DIM127     * Check number of records
.
          MOVE      ZERO,VISTFLAG
          MOVE      ANS,VISTFLAG              * visit type
          MOVE      ZERO,DISCFLAG
          MOVE      KEY1,DISCFLAG             * admission status (astat)
          MOVE      ZERO,VISCOUNT
          MOVE      ZERO,RECCNT
          MOVE      ZERO,FINFLAG
          MOVE      ZERO,CHECKCNT
          MOVE      DIM1,CHECKCNT
.
          MATCH     "       0",URNUMBER
          GOTO      UTCTAB99 IF EQUAL
.
          CALL      UTCLST00                  * TAC Details Table
.
UTCTAB99  RETURN 
.
.------------------------------------------------------------
. Output TAC Table Details      
.------------------------------------------------------------
UTCLST00  PACK      KEY16,URNUMBER,SP70
          CALL      RDSWMAB2
UTCLST10  CALL      RDKWMAB2
          BRANCH    OVRCD,UTCLST99
.
          MATCH     URNUMBER,PTWMURNO         * Match UR numbers
          GOTO      UTCLST99 IF NOT EQUAL
.
          MOVE      DMADMNO,KEY8
          CALL      RDVISA1
          IF        OVRCD=1
            CALL      OUTFIL00
            BRANCH    EXIT,UTCLST99
.
            PACK      KEY8,DMADMNO,SP70
            CALL      RDBOKB1
            BRANCH    OVRCD,UTCLST10
            MOVE      OBAOUTNO,DPVIBILL
            MOVE      TWO,PVITYPE
            MOVE      OBADATE,PVIDATE
            GOTO      UTCLST22
          ENDIF
.
          BRANCH    PVITYPE,UTCLST21:
                            UTCLST22:
                            UTCLST23
.
.         MOVE      NINE,DIM1
          COMPARE   NINE,PVITYPE
          GOTO      UTCLST24 IF EQUAL
.
          MOVE      "Unkwn",VISTTYPE
          GOTO      UTCLST30
.
UTCLST21  MOVE      "EMG",VISTTYPE
          GOTO      UTCLST30
.
UTCLST22  MOVE      "OP",VISTTYPE
          GOTO      UTCLST30
.
UTCLST23  MOVE      "IP",VISTTYPE
          GOTO      UTCLST30
.
UTCLST24  MOVE      "6RF",VISTTYPE
          GOTO      UTCLST30
.
UTCLST30  MOVE      ZERO,CLAIMFLG             * default to valid claim no
.... C CAR 55923
.... For NSW, there is no format requirement for TAC(MREFNO) number. Therefore,
.... no need to do the following checking on TAC number.
          IF        PTCNHDPS=3
            CALL      CLAIMN00                  * check claim no
... CAR 49028
            IF        ERRFLAG=0                              
              MOVE      ONE,CLAIMFLG            * claim no already valid
            ENDIF
          ENDIF
.
          MOVE      SP1,SECOPT                * Initialise SECOPT
          MOVE      SP1,PVITYPE               * Initialise PVITYPE
.
          CLEAR     HTMLLINK
          APPEND    "javascript:linkPatient('",HTMLLINK
          APPEND    URNUMBER,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    DPVIBILL,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PVITYPE,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    SECOPT,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",MREFNO,"#",":
                             "#"",MACDAT,"#",":
                             "#"",MACLOC,"#",":
                             "#"",VISTTYPE,"#",":
                             "#"",PVIDATE,"#",":
                             "#"",DMADMNO,"#",";
.
          ADD       ONE,RECCNT
          MOVE      RECCNT,DRECCNT
          REP       " 0",DRECCNT
.
.... CAR 49028
          WRITE     HTMLFILE;"#"<input type=checkbox name=uptac",DRECCNT:
                    " onClick=UpdateArray(this.value,",CLAIMFLG:
                    ",this.checked,",UNKNFLAG,"); value='":            *C-51223
                    DMADMNO,"'>":
                    "#")"
.
          IF        CHECKCNT=0
            GOTO      UTCLST10
          ENDIF
.
          IF        RECCNT=998
            MOVE      ONE,FINFLAG
            WRITE     HTMLFILE;"alert('Too Many Visits to View');"
            GOTO      UTCLST99
          ENDIF
.
          GOTO      UTCLST10
.
UTCLST99  RETURN
+
.-----------------------------------------------------------------------------
. CLAIMN00   : Check claim number
.              If claim number is not blank, then must be in format YYNNNNN
.              where YY is year of the accident date and NNNNN is numeric or
.              C-U if the claim number is unknown
.-----------------------------------------------------------------------------
CLAIMN00  MOVE      ZERO,ERRFLAG
          MOVE      ZERO,UNKNFLAG                                      *I-51223
.
          MATCH     SP70,MACDAT
          GOTO      CLAIMN99 IF EQUAL
.
          UNPACK    MACDAT,XCENT,XYEAR,XMON,XDAY
          ENDSET    MREFNO
          APPEND    SP70,MREFNO
          RESET     MREFNO
.
          MATCH     SP8,MREFNO
          IF        @EQUAL
            MOVE      "C-U     ",MREFNO
          ENDIF
.
          MATCH     "C-U     ",MREFNO
          IF        !@EQUAL
            UNPACK    SP70,KEY2,KEY6,KEY20
            UNPACK    MREFNO,KEY2,KEY6,KEY20
            TYPE      KEY2                          * I CAR 47395
            GOTO      CLAIMN10 IF NOT EQUAL         * I CAR 47395
            MATCH     "19010101",MACDAT
            IF        !@EQUAL
              MATCH     SP20,KEY20
              GOTO      CLAIMN10 IF NOT EQUAL
              CALL      CYER0000           * Check year of Acc.date/TAC no
            ENDIF
.
            SQUEEZE   KEY6
            TYPE      KEY6
            GOTO      CLAIMN10 IF NOT EQUAL
          ELSE
            MOVE      ONE,UNKNFLAG                                     *I-51223
          ENDIF
          GOTO      CLAIMN99
.
CLAIMN10  MOVE      ONE,ERRFLAG
CLAIMN99  RETURN
+
.------------------------------------------------------------
. CYER0000  : Check TAC year against TAC number
.------------------------------------------------------------
CYER0000  
.         Work out the financial year of claim using fist two digit of TAC no
.
          MOVE      ZERO,FORM2
          MOVE      KEY2,FORM2         * First two digit of TAC claim no
          IF        FORM2>50
            MOVE      "19",CCENT       * if year > 50, make century = 19
          ELSE
            MOVE      "20",CCENT       * if year < 50, make century = 20
          ENDIF
          PACK      KEY4A,CCENT,KEY2
          REP       " 0",KEY4A          * Financial year of claim
.
.         Get the financial year of the accident date
.
          UNPACK    MACDAT,XCENT,XYEAR,XMON,XDAY   * Accident date
          MOVE      ZERO,FORM2
          MOVE      XMON,FORM2
          IF        FORM2>=7
            PACK      KEY4,XCENT,XYEAR
            REP       " 0",KEY4
          ELSE
            PACK      DIM4,XCENT,XYEAR
            REP       " 0",DIM4
            MOVE      ZERO,FORM4
            MOVE      DIM4,FORM4
            SUB       ONE,FORM4
            MOVE      FORM4,KEY4      * Financial year of accident date
            REP       " 0",KEY4
          ENDIF
.
.         Get the number of years difference b/w financial year of
.         accident date and claim (ie the first two digits of TAC claim no)
.
          MOVE      ZERO,FORM4
          MOVE      ZERO,FORM4A
.
          MOVE      KEY4,FORM4         * year from Accident date
          MOVE      KEY4A,FORM4A       * financial year from TAC Claim no
          SUB       FORM4,FORM4A
          IF        FORM4A<0
            MOVE      TWO,ERRFLAG      * Reject accident date must be b/f claim
          ENDIF
.
.         Reject if date difference b/w accident date and claim date is more
.         than 20 years, Warning if more than 3 years.
.
          IF        FORM4A>20
            MOVE      TWO,ERRFLAG          * Reject
            GOTO      CYER9999
          ENDIF
.
          IF        FORM4A>3
            MOVE      THREE,ERRFLAG      * Warning
          ENDIF
CYER9999  RETURN
+
.------------------------------------------------------------
. Output WC Table Details       
.------------------------------------------------------------
UWCTAB00  MOVE      ZERO,DIM1
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,ANS,DIM127      * Visit Type Flag
          UNPACK    DIM127,D1,KEY1,DIM127     * Admission Status Flag
          UNPACK    DIM127,D1,DIM1,DIM127     * Check number of records
.
          MOVE      ZERO,VISTFLAG
          MOVE      ANS,VISTFLAG              * visit type
          MOVE      ZERO,DISCFLAG
          MOVE      KEY1,DISCFLAG             * admission status (astat)
          MOVE      ZERO,VISCOUNT
          MOVE      ZERO,RECCNT
          MOVE      ZERO,FINFLAG
          MOVE      ZERO,CHECKCNT
          MOVE      DIM1,CHECKCNT
.
          MATCH     "       0",URNUMBER
          GOTO      UWCTAB99 IF EQUAL
.
          CALL      UWCLST00                  * WC Details Table
.
UWCTAB99  RETURN  
.
.------------------------------------------------------------
. Output WC Table Details 
.------------------------------------------------------------
UWCLST00  PACK      KEY16,URNUMBER,Z70
          CALL      RDSWCOM2
UWCLST10  CALL      RDPWCOM2
          BRANCH    OVRCD,UWCLST99
.
          MATCH     URNUMBER,PTWCURNO         * Match UR numbers
          GOTO      UWCLST99 IF NOT EQUAL
.
          PACK      KEY8,DWCADMNO,SP70         * Read for corresponding
          CALL      RDVISA1                   * admission file
          IF        OVRCD<>1
            GOTO      UWCLST15
          ENDIF
.
          PACK      KEY8,DWCADMNO,SP70
          CALL      RDBKREC1
          IF        OVRCD<>1
            PACK      DPVIBILL,DWCADMNO,SP70
            MOVE      DWCADMNO,PVIBILL
            MOVE      THREE,PVITYPE
            PACK      PVIDATE,BKREADAT,SP70
            PACK      PVIURNO,BKREURNO,SP70
            GOTO      UWCLST15
          ENDIF
          PACK      KEY19,URNUMBER,SP70
          CALL      RDSTREA1
UWCLST12  CALL      RDKTREA1
          BRANCH    OVRCD,UWCLST14
.
          MATCH     URNUMBER,WMURNO
          GOTO      UWCLST14 IF NOT EQUAL
.
          MATCH     WMBOOK,WCADMNO
          GOTO      UWCLST12 IF NOT EQUAL
.
          PACK      DPVIBILL,DWCADMNO,SP70
          MOVE      DWCADMNO,PVIBILL
          MOVE      FOUR,PVITYPE
          MOVE      ANSW,PTVITYPE
          PACK      PVIDATE,WMDATE1,SP70
          PACK      PVIURNO,WMURNO,SP70
          GOTO      UWCLST15
.
UWCLST14  CALL      OUTFIL00
          BRANCH    EXIT,UWCLST99
.
          PACK      KEY8,DWCADMNO,SP70         * Read for corresponding
          CALL      RDBOKB1
          IF        OVRCD=0
            PACK      DPVIBILL,DWCADMNO,SP70
            MOVE      DWCADMNO,PVIBILL
            MOVE      TWO,PVITYPE
            PACK      PVIDATE,OBADATE,SP70
            PACK      PVIURNO,PTWCURNO,SP70
            GOTO      UWCLST15
          ENDIF
.
          MOVE      DWCADMNO,KEY8
          CALL      RDOTRFL1
          IF        OVRCD=0
            PACK      DPVIBILL,DWCADMNO,SP70
            MOVE      DWCADMNO,PVIBILL
            MOVE      TWO,PVITYPE
            PACK      PVIDATE,OTRLDATE,SP70
            PACK      PVIURNO,OTRLURNO,SP70
            GOTO      UWCLST15
          ENDIF
.
          GOTO      UWCLST10
.
UWCLST15  BRANCH    PVITYPE,UWCLST21:
                            UWCLST22:
                            UWCLST23
.
          MATCH     ANSW,PTVITYPE
          GOTO      UWCLST25 IF EQUAL
.
.         MOVE      NINE,DIM1
          COMPARE   NINE,PVITYPE
          GOTO      UWCLST24 IF EQUAL
.
          MOVE      "Unkwn",VISTTYPE
          GOTO      UWCLST30
.
UWCLST21  MOVE      "EMG",VISTTYPE
          GOTO      UWCLST30
.
UWCLST22  MOVE      "OP",VISTTYPE
          GOTO      UWCLST30
.
UWCLST23  MOVE      "IP",VISTTYPE
          GOTO      UWCLST30
.
UWCLST24  MOVE      "7RF",VISTTYPE
          GOTO      UWCLST30
.
UWCLST25  MOVE      "WL",VISTTYPE
          GOTO      UWCLST30
.
UWCLST30  COMPARE   ONE,PTCNHDPS            * NZ only?
          GOTO      UWCLST40 IF NOT EQUAL
.
          PACK      KEY8,DWCADMNO,SP70
          CALL      RDPMWX11
          IF        OVRCD=1
            CALL      CLPMSWX1
          ENDIF
.
          MATCH     "3",PMWXCSTA            * Cancelled Claim Status?
          GOTO      UWCLST10 IF EQUAL       * Don't output row data
.
UWCLST40  MOVE      SP1,SECOPT                * Initialise SECOPT
          MOVE      SP1,PVITYPE               * Initialise PVITYPE
.
          CLEAR     HTMLLINK
          APPEND    "javascript:linkPatient('",HTMLLINK
          APPEND    URNUMBER,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    DPVIBILL,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PVITYPE,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    SECOPT,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",WCCLMNO,"#",":
                             "#"",WCACDAT,"#",":
                             "#"",VISTTYPE,"#",":
                             "#"",PVIDATE,"#",":
                             "#"",DWCADMNO,"#",";
.
          ADD       ONE,RECCNT
          MOVE      RECCNT,DRECCNT
          REP       " 0",DRECCNT
.
          WRITE     HTMLFILE;"#"<input type=checkbox name=upwco",DRECCNT:
                      " onClick=UpdateArray(this.value); value='",DWCADMNO,"'>":
                      "#")"
.
          IF        CHECKCNT=0
            GOTO      UWCLST10
          ENDIF
.
          COMPARE   FIFTY,RECCNT
          IF        @EQUAL
            MOVE      ONE,FINFLAG
            WRITE     HTMLFILE;"alert('Too Many Visits to View');"
            GOTO      UWCLST99
          ENDIF
.
          GOTO      UWCLST10
.
UWCLST99  RETURN
+
.----------------------------------------------------------------------
. Output Javascript List of Error for Processing Range of U/R or MR Keys
.----------------------------------------------------------------------
ERRLST00  CALL      OPENHTML
          BRANCH    EXIT,ERRLST95
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {"
          MOVE      ZERO,F3
ERRLST10  ADD       ONE,F3
          IF        F3>ERRORCNT | F3>50
            WRITE     HTMLFILE;"}":
                               "</script>"
            IF        WARNFLAG=1
              MATCH     "1",PTCNUFFR
              IF        @EQUAL
                WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                                   "src=#"../js/Standard.js#"></script>":
                                   "<script type=#"text/javascript#"> {":
                            " getTop().content.location.href=#"",REDIRECT,"#";":
                               "}":
                               "</script>"
              ELSE
                WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                                 " top.content.location.href=#"",REDIRECT,"#";":
                               "}":
                               "</script>"
              ENDIF
            ENDIF
            CALL      CLOSHTML
            GOTO      ERRLST99
          ENDIF
.
          WRITE     HTMLFILE;"    alert(#"",ERRORLST[F3],"\n#");"
          GOTO      ERRLST10
.
ERRLST95  DISPLAY   "*** Fifo Not Found ***"
.
ERRLST99  RETURN
.
.------------------------------------------------------------
. Output Visit Table Details
.------------------------------------------------------------
EMRTAB00  MOVE      ZERO,DIM1
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,ANS,DIM127      * Visit Type Flag
          UNPACK    DIM127,D1,KEY1,DIM127     * Admission Status Flag
          UNPACK    DIM127,D1,DIM1,DIM127     * Check number of records
.
          MOVE      ZERO,VISTFLAG
          MOVE      ANS,VISTFLAG              * visit type
          MOVE      ZERO,DISCFLAG
          MOVE      KEY1,DISCFLAG             * admission status (astat)
          MOVE      ZERO,VISCOUNT
          MOVE      ZERO,RECCNT
          MOVE      ZERO,FINFLAG
          MOVE      ZERO,CHECKCNT
          MOVE      DIM1,CHECKCNT
          MOVE      ZERO,SHOWPPRV             * Show pre adm prev details 
          MOVE      ZERO,INFORMGP
.
          MATCH     "       0",URNUMBER
          GOTO      EMRTAB99 IF EQUAL
.
          CALL      PATLST00                  * Visit Table
.
EMRTAB99  RETURN
+
.******************************************************************************
.*                                 WPEI0000                                   *
.*                        Write A Record To patpeiaf                          *
.******************************************************************************
WPEI0000  READ      CONTROLF,EIGHTY8;*116,CHCSDTE,*124,CHCSST,*132,CHCSED
.
          COMPARE   THREE,PTCNHDPS
          GOTO      WPEI9999 IF NOT EQUAL   * Not in Victoria
.
          COMPARE   THREE,ASTAT
          GOTO      WPEI9000 IF NOT EQUAL   * Not discharged
.
          MATCH     CHCSDTE,DDATE
          GOTO      WPEI9000 IF LESS        * Discharge date < start HDP date
.
          MATCH     CHCSST,ADATE
          GOTO      WPEI9000 IF NOT LESS    * Adm date >= PRS2 extract start dte
.
          PACK      KEY16,SP8,AADMNO
          CALL      RDPTPEI1                * Read a PRS2 inc/exc file record
          COMPARE   ONE,OVRCD
          GOTO      WPEI9000 IF NOT EQUAL   * Record exists, dont write
.
          PACK      KEY16,CHCSST,AADMNO
          CALL      RDPTPEI1                * Read a PRS2 inc/exc file record
          COMPARE   ONE,OVRCD
          GOTO      WPEI9000 IF NOT EQUAL   * Record exists, dont write
.
          MOVE      SP8,PTPESTDT
          MOVE      AADMNO,PTPEADMN
          MOVE      TWO,PTPESTAT
          CALL      IBACLOCK                * Get the current date
          PACK      PTPEDATE,CCC,CYY,CMM,CDD
          REP       " 0",PTPEDATE
          MOVE      USERID,PTPEOPER
.
          MOVE      SP3,PTPERESN
          PACK      KEY5,ANSR,ANSN,SP3
          CALL      RDSCODE1                * Position on & read a codes file
WPEI1000  CALL      RDKCODE1                  record
          BRANCH    OVRCD,WPEI2000
.
          MATCH     "RN",TCODE
          GOTO      WPEI2000 IF NOT EQUAL   * Different category
.
          MATCH     HDPEQUIV,THCSCOD
          GOTO      WPEI1000 IF NOT EQUAL   * Different HDP equivalent
.
          MOVE      ACODE,PTPERESN
.
WPEI2000  MOVE      PASSCODE,PTPEOPER
          PACK      KEY16,PTPESTDT,PTPEADMN,SP70
          CALL      WRPTPEI1                * Write a PRS2 inc/exc file record
.
WPEI9000  MOVE      ZERO,EXIT
WPEI9999  RETURN
.
.-----------------------------------------------------------
. Initialize's file data
.-----------------------------------------------------------
CLRSES00  MOVE      SP70,OSESITE       * SITE CODE
          MOVE      SP70,OSECLIN       * CLINIC ID
          MOVE      SP70,OSEDATE       * USAGE DATE (CCYYMMDD)
          MOVE      SP70,OSESTRT       * SESSION START TIME (HH:MM)
          MOVE      SP70,DOSEDAY       * DAY INDICATOR e.g. 1 = MON
          MOVE      ZERO,OSESLOTS      * TOTAL SLOTS SCHEDULED
          MOVE      ZERO,OSESLOTB      * TOTAL SLOTS BOOKED
          MOVE      SP70,OSETIMES      * TOTAL TIME SCHEDULED (HH:MM)
          MOVE      SP70,OSETIMEU      * TOTAL TIME USED      (HH:MM)
          MOVE      ZERO,OSEBNEW       * NUMBER OF NEW PATIENTS
          MOVE      ZERO,OSEBRV        * NUMBER OF RE-VISITING PATIENTS
          MOVE      ZERO,OSEBSPC       * NUMBER OF SPECIAL PATIENTS
          MOVE      ZERO,OSEANEW       * NUMBER OF NEW PATIENTS
          MOVE      ZERO,OSEARV        * NUMBER OF RE-VISITING PATIENTS
          MOVE      ZERO,OSEASPC       * NUMBER OF SPECIAL PATIENTS
          MOVE      ZERO,OSESSLTR      * REVIEW SLOTS SCHEDULED
          MOVE      ZERO,OSESSLTN      * NEW SLOTS SCHEDULED
          MOVE      ZERO,OSESSLTS      * SPECIAL SLOTS SCHEDULED
          MOVE      SP70,OSESCSTT      * CLINIC STATUS
          MOVE      SP70,OSESCOMM 
          MOVE      SP70,OSESCTYP      * CLINIC TYPE
          MOVE      SP70,OSESSHNO      * SCHEDULE NUMBER
          MOVE      SP70,OSESSDAT      * SCHEDULE DATE (CCYYMMDD)
          MOVE      SP70,OSESPARE      * SPARE
.
CLRSES99  RETURN
.
.-----------------------------------------------------------
. Initialize's file data : Clinic Master File A
.-----------------------------------------------------------
CLRMAS00  MOVE      SP70,OMASITE
          MOVE      SP70,OMACLIN
          MOVE      SP70,OMATYP
          MOVE      SP70,DOMADAY
          MOVE      SP70,OMASTART
          MOVE      SP70,OMAFIN
          MOVE      SP70,OMAEND
          MOVE      SP70,OMACIND
          MOVE      SP70,OMAREG
          MOVE      SP70,OMAKDOC
          MOVE      SP70,OMACOM1
          MOVE      SP70,OMACOM2
          MOVE      ZERO,OMADURN
          MOVE      ZERO,OMANEWSL
          MOVE      ZERO,OMASPCSL
          MOVE      ZERO,OMASTAT
          MOVE      SP70,OMAFREQM
          MOVE      SP70,DOMASEQ
          MOVE      SP70,OMALOCK
          MOVE      ZERO,OMAFREQF
          MOVE      SP70,OMAFREQY
          MOVE      SP70,OMADATE
          MOVE      SP70,OTMAAVIS
          MOVE      SP70,OTMASTVT
          MOVE      SP70,OTMASUPX
          MOVE      SP70,OTMARUSE
          MOVE      SP70,OTMADCMB
          MOVE      SP70,OTMAIXTA
          MOVE      SP70,OTMADEFD
          MOVE      SP70,OTMAUATR
          MOVE      ZERO,OTMADDNA
          MOVE      ZERO,OTMANDRP
          MOVE      ZERO,OTMALPTR
          MOVE      ZERO,OTMALGPD
          MOVE      ZERO,OTMALPTD
          MOVE      ZERO,OTMABKLT
          MOVE      ZERO,OTMARALT
          MOVE      ZERO,OTMARSLT
          MOVE      SP70,OTMACLSE
          MOVE      SP70,OTMAHOSP
          MOVE      SP70,OTMACLOC
          MOVE      SP70,OTMAWDCL
          MOVE      SP70,OTMAWARD
          MOVE      SP70,OTMALTYP
          MOVE      SP70,OTMADFSL
          MOVE      SP70,OTMADFGN
          MOVE      SP70,OTMAGRPS
          MOVE      SP70,DOTMASOV
          MOVE      SP70,DOTMANOO
          MOVE      SP70,DOTMASLF
          MOVE      SP70,DOTMASLR
          MOVE      SP70,OTMASBKL
          MOVE      SP70,OTMASAPL
          MOVE      SP70,OTMASPMM
          MOVE      SP70,OTMASGPM
          MOVE      SP70,DOTMALPP
          MOVE      SP70,DOTMASRL
          MOVE      SP70,DOTMANCO
          MOVE      SP70,OTMALOCN
          MOVE      SP70,OTMADTCO
          MOVE      SP70,OTMADTCC
          MOVE      SP70,OTMAINS1
          MOVE      SP70,OTMAINS2
          MOVE      SP70,OTMAINS3
          MOVE      SP70,OTMALSER
          MOVE      SP70,OTMAUMCI
          MOVE      SP70,OTMAPROV
          MOVE      SP70,OTMAMBST
          MOVE      SP70,OTMAROOM
          MOVE      SP70,OTMALEDG
          MOVE      SP70,OTMACCTR
          MOVE      SP70,OTMAMPRC
          MOVE      SP70,OTMAMBSA
          MOVE      SP70,OTMALDNA
          MOVE      SP70,OTMAADEP
          MOVE      SP70,OTMACENC
          MOVE      SP70,OTMACCAR
          MOVE      SP70,OTMACTRN
          MOVE      SP70,OTMADPSL
          MOVE      SP70,OTMACPMI
          MOVE      SP70,OTMACPAG
          MOVE      SP70,OTMACTEL
          MOVE      SP70,OTMANMDS
          MOVE      SP70,OTMACART
          MOVE      SP70,OTMASRVD
          MOVE      SP70,OTMACLHR
          MOVE      SP70,OTMAMLTD
          MOVE      SP70,OTMAXPUL
          MOVE      SP70,OTMAMREF
          MOVE      SP70,OTMATCOD
          MOVE      SP70,OTMAHCLI
          MOVE      SP70,OTMAHCAI
          MOVE      SP70,OTMAAOPN
          MOVE      SP70,OTMAAOFR
          MOVE      SP70,OTMAAOWM
          MOVE      SP70,OTMAAOWA
          MOVE      SP70,OTMAHCP1
          MOVE      SP70,OTMAHCP2
          MOVE      SP70,OTMAHCP3
          MOVE      SP70,OTMAHCP4
          MOVE      SP70,OTMAPCOD
          MOVE      SP70,OTMASPAR
.
CLRMAS99  RETURN
.
+
.-----------------------------------------------------------
. Get variables from pmsworaf
.-----------------------------------------------------------
GPMWR000  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          REP       "+ ",ADMISSNO
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMWOR1
          IF        OVRCD=1
            COMPARE   F1,FOUR
            GOTO      GPMWR025 IF EQUAL
            GOTO      GPMWR999
          ENDIF
.
          BRANCH    F1,GPMWR005,GPMWR010,GPMWR015,GPMWR020
.
          GOTO      GPMWR999
.
GPMWR005  WRITE     HTMLFILE;PMWOWDI1
          GOTO      GPMWR999
.
GPMWR010  WRITE     HTMLFILE;PMWOWDI2
          GOTO      GPMWR999
.
GPMWR015  WRITE     HTMLFILE;PMWOWDI3
          GOTO      GPMWR999
.
GPMWR020  MATCH     PMWOEDAT,SP70
          GOTO      GPMWR025 IF EQUAL
.
          UNPACK    PMWOEDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          GOTO      GPMWR999
.
GPMWR025  PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,GPMWR999
.
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      ASTAY,ADJDAYS
          CALL      ADJDAT00
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          GOTO      GPMWR999
.
GPMWR999  RETURN  
+
.*****************************************************************************
.*  CHKEID00
.*  Procedure to get an alternate Visit ID
.*  KEY20 - External Visit Number
.*****************************************************************************
          DEFPROC   CHKEID00
.
          INC       IBAALVFD/INC
.
          PACK      KEY20,SP70
          OPEN      IBAALVA1,"ibaalvaf"
.
          MATCH     "0",PTCNALTV
          GOTO      CHKEID99 IF EQUAL          
.
          MATCH     "       0",CHKEXTVD
          GOTO      CHKEID99 IF EQUAL
.
          PACK      KEY8,CHKEXTVD,SP70
          CALL      RDIBALV1
          BRANCH    OVRCD,CHKEID99
.
          PACK      KEY20,IBAVAVIS,SP70
          GOTO      CHKEID99
.
          INC       IBAALVIO/INC
          INC       IBAOVRIO/INC
.
CHKEID99  CLEAR     CHKEXTVD
          CLOSE     IBAALVA1
.
          ENDPROC
+
.*****************************************************************************
.*  CHKCER00
.*  Procedure to check if a patient has Certificates
.*  Exit=0  No Certificates exist
.*      =1  Certificates do exist
.*****************************************************************************
          DEFPROC   CHKCER00
.
          INC       PATCERFD/INC
.
          MOVE      ZERO,EXIT               * default to no certificates
.                                           * Get Admission Date & Disch. Date
          MATCH     ADMISSNO,DAADMNO
          IF        !@EQUAL
            PACK      KEY8,ADMISSNO,SP10
            CALL      RDMISS1
          ENDIF
.
          MOVE      "99991231",DIM8
          COMPARE   THREE,ASTAT
          GOTO      CHKCER10 IF NOT EQUAL   * not discharged
.
          MATCH     ADMISSNO,DDADMNO
          IF        !@EQUAL
            PACK      DDATE,SP20
            PACK      KEY8,ADMISSNO,SP10
            CALL      RDDSCH1
          ENDIF
.
          MATCH     SP8,DDATE
          GOTO      CHKCER10 IF EQUAL
          MOVE      DDATE,DIM8
.
CHKCER10  OPEN      PATCERA1,"patceraf"
.
          PACK      KEY19,PURNO,SP70
          CALL      RSPTCER1                * read certificates
CHKCER20  CALL      RKPTCER1
          BRANCH    OVRCD,CHKCER99
.
          MATCH     PURNO,PTCEURNO          * Check same UR
          GOTO      CHKCER99 IF NOT EQUAL
.
.                                           * check From & To dates for extremes
          MATCH     ADATE,PTCETDAT
          GOTO      CHKCER20 IF LESS
          MATCH     PTCEFDAT,DIM8
          GOTO      CHKCER20 IF LESS
.
.                                           * now check Certificate type
          MOVE      "cr",DIM2
          PACK      KEY5,DIM2,PTCETYPE,SP10
          CALL      RDCODE1
          BRANCH    OVRCD,CHKCER20
.
          MATCH     "U",TCINDC1
          GOTO      CHKCER30 IF EQUAL       * Accept any UR based Certificates
.
.                                           * now check if dates in Admiss range
          MATCH     ADATE,PTCEFDAT
          GOTO      CHKCER20 IF LESS
          MATCH     PTCETDAT,DIM8
          GOTO      CHKCER20 IF LESS
.
CHKCER30  MOVE      ONE,EXIT                * Certificate/s exist
          GOTO      CHKCER99
.
          INC       PATCERIO/INC
          INC       IBAOVRIO/INC
.
CHKCER99  CLOSE     PATCERA1
.
          ENDPROC
.
.------------------------------------------------------------
. Hospital Selection
.------------------------------------------------------------
HSEL0000  IF        FILTFLAG=2
            MOVE      SP70,FILTHOSP         * filter on 'All' hospitals
          ENDIF
.
          PACK      KEY3,SP70
          CALL      RSPTHSP1
HSEL0100  CALL      RKPTHSP1
          BRANCH    OVRCD,HSEL9999
.
          PACK      KEY13,USERID,SP70                * All hospital access
          CALL      RDMLSEC1
          IF        OVRCD=1
            PACK      KEY13,USERID,PTHSHOSP,SP70     * This hospital access
            CALL      RDMLSEC1
            BRANCH    OVRCD,HSEL0100
          ENDIF
.
          MOVE      PTHSNAME,KEY50
          PACK      KEY5,QUOTE,PTHSHOSP,QUOTE
          MATCH     FILTHOSP,PTHSHOSP
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY5," selected>":
                               KEY50,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY5,">",KEY50,"</option>"
          ENDIF
          GOTO      HSEL0100
.
HSEL9999  RETURN
.
.------------------------------------------------------------
. Hospital Selection - Display hospitals that a user is
. allowed to see. If supervisor display all records in the
. hospital file.
.------------------------------------------------------------
HHSL0000  IF        FILTFLAG=2
            MOVE      SP70,FILTHHOS         * filter on 'All' hospitals
          ENDIF
.
          PACK      KEY3,SP70
          CALL      RSPTHSP1
HHSL0100  CALL      RKPTHSP1
          BRANCH    OVRCD,HHSL9999
.
          MATCH     "1",SUPERLEV
          IF        !@EQUAL
            PACK      KEY13,USERID,SP70                * All hospital access
            CALL      RDMLSEC1
            IF        OVRCD=1
              PACK      KEY13,USERID,PTHSHOSP,SP70     * This hospital access
              CALL      RDMLSEC1
              BRANCH    OVRCD,HHSL0100
            ENDIF
          ENDIF
.
          MOVE      PTHSNAME,KEY50
          PACK      KEY5,QUOTE,PTHSHOSP,QUOTE
          MATCH     FILTHHOS,PTHSHOSP
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY5," selected>":
                               KEY50,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY5,">",KEY50,"</option>"
          ENDIF
.
          MATCH     "1",SUPERLEV                 * Supervisor
          GOTO      HHSL0100 IF EQUAL
.
          MATCH     SP70,PTHSHHOS                * Any default MR home hospital
          GOTO      HHSL0100 IF EQUAL
.
          MATCH     PTHSHOSP,PTHSHHOS            * MR home hospital different to
          GOTO      HHSL0100 IF EQUAL            * current hosptial
.
          PACK      KEY13,USERID,SP70                * All hospital access
          CALL      RDMLSEC1
          IF        OVRCD = 1
            PACK      KEY13,USERID,PTHSHHOS,SP70     * This hospital access
            CALL      RDMLSEC1
            BRANCH    OVRCD,HHSL2000
          ENDIF
          GOTO       HHSL0100
.
HHSL2000  PACK      SAVKEY3,PTHSHOSP,SP70
          PACK      KEY3,PTHSHHOS,SP70           * Output associated MR home
          CALL      RDPTHSP1                     * hospital the user doesn't
          BRANCH    OVRCD,HHSL3000               * have direct access to.
.
          MOVE      PTHSNAME,KEY50
          PACK      KEY5,QUOTE,PTHSHOSP,QUOTE
          MATCH     FILTHHOS,PTHSHOSP
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY5," selected>":
                               KEY50,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY5,">",KEY50,"</option>"
          ENDIF
. 
HHSL3000  PACK      KEY3,SAVKEY3
          CALL      RDPTHSP1
          GOTO      HHSL0100
.
HHSL9999  RETURN

.
.******************************************************************************
.*  Get NZ Procedure details if required                                      *
.******************************************************************************
GETNZP00  COMPARE   FIVE,CFEETYP            * NZ Private only
          GOTO      GETNZP90 IF NOT EQUAL
.
          CALL      CLNZSP00
          PACK      KEY11,ADMISSNO,SP70
          CALL      RSNZSPR1
GETNZP10  CALL      RKNZSPR1
          BRANCH    OVRCD,GETNZP90
.
          MATCH     ADMISSNO,NZSPADMN
          GOTO      GETNZP90 IF NOT EQUAL
.
          COMPARE   "1",NZSPPRIM
          GOTO      GETNZP10 IF NOT EQUAL
          GOTO      GETNZP999
.
GETNZP90  CALL      CLNZSP00
.
GETNZP99  RETURN
+
.**********************************************************************
.  Clear PDS DATA
.**********************************************************************
CLRPDS00  MOVE      SP70,MRPDSTAT
          RETURN
.         
.**********************************************************************
.  Clear ICU DATA   
.**********************************************************************
CLRICU00  MOVE      ZERO,PTICUINT
          MOVE      ZERO,PTICUMEC
          MOVE      ZERO,PTICUCCU
          MOVE      SP70,PTICAMBN
          MOVE      ZERO,PTICCPAP
          MOVE      ZERO,PTICHNCU
.
CLRICU99  RETURN
+
.******************************************************************************
MVPMAR00  PACK      PMVXVISN,ARVXVISN,SP70
          PACK      PMVXVSDT,ARVXVSDT,SP70
          PACK      PMVXDOCA,ARVXDOCA,SP70
          PACK      PMVXDOCT,ARVXDOCT,SP70
          PACK      PMVXCSNR,ARVXCSNR,SP70
          PACK      PMVXPOST,ARVXPOST,SP70
          PACK      PMVXPIND,ARVXPIND,SP70
          PACK      PMVXVLOC,ARVXVLOC,SP70
          PACK      PMVXCFSG,ARVXCFSG,SP70
          PACK      PMVXINGP,ARVXINGP,SP70
          PACK      PMVXCPTH,ARVXCPTH,SP70
          PACK      PMVXHCP1,ARVXHCP1,SP70
          PACK      PMVXHCP2,ARVXHCP2,SP70
          PACK      PMVXHCP3,ARVXHCP3,SP70
          PACK      PMVXHCP4,ARVXHCP4,SP70
          PACK      PMVXRHC1,ARVXRHC1,SP70
          PACK      PMVXRH1G,ARVXRH1G,SP70
          PACK      PMVXRH1C,ARVXRH1G,SP70
          PACK      PMVXRHC2,ARVXRHC2,SP70
          PACK      PMVXRH2G,ARVXRH2G,SP70
          PACK      PMVXRH2C,ARVXRH2C,SP70
          PACK      PMVXRHC3,ARVXRHC2,SP70
          PACK      PMVXRH3G,ARVXRH3G,SP70
          PACK      PMVXRH3C,ARVXRH3C,SP70
          PACK      PMVXRHC4,ARVXRHC4,SP70
          PACK      PMVXRH4G,ARVXRH4G,SP70
          PACK      PMVXRH4C,ARVXRH4C,SP70
          PACK      PMVXABRG,ARVXABRG,SP70
          PACK      PMVXCADM,ARVXCADM,SP70
          PACK      PMVXIRAD,ARVXIRAD,SP70
          PACK      PMVXIDUS,ARVXIDUS,SP70
          PACK      PMVXCRAV,ARVXCRAV,SP70
          PACK      PMVXRCCT,ARVXRCCT,SP70
          PACK      PMVXAPWD,ARVXAPWD,SP70
          PACK      PMVXAPBD,ARVXAPBD,SP70
          PACK      PMVXPOWD,ARVXPOWD,SP70
          PACK      PMVXPOBD,ARVXPOBD,SP70
          PACK      PMVXPSTY,ARVXPSTY,SP70
          PACK      PMVXVALW,ARVXVALW,SP70
          PACK      PMVXPALW,ARVXPALW,SP70
          PACK      PMVXINDC,ARVXINDC,SP70
          PACK      PMVXMDAV,ARVXMDAV,SP70
          PACK      PMVXFRMS,ARVXFRMS,SP70
          PACK      PMVXCSNG,ARVXCSNG,SP70
          MOVE      PMVXPWGT,ARVXPWGT
          MOVE      PMVXPHGT,ARVXPHGT
          PACK      PMVXDHWR,ARVXDHWR,SP70
          PACK      PMVXEDC1,ARVXEDC1,SP70
          PACK      PMVXEDC2,ARVXEDC2,SP70
          PACK      PMVXEDC3,ARVXEDC3,SP70
          PACK      PMVXHOME,ARVXHOME,SP70
          PACK      PMVXUDF1,ARVXUDF1,SP70
          PACK      PMVXUDF2,ARVXUDF2,SP70
          PACK      PMVXUDF3,ARVXUDF3,SP70
          PACK      PMVXUDF4,ARVXUDF4,SP70
          PACK      PMVXUDT1,ARVXUDT1,SP70
          PACK      PMVXUDT2,ARVXUDT2,SP70
          PACK      PMVXUDT3,ARVXUDT3,SP70
          PACK      PMVXUDT4,ARVXUDT4,SP70
          PACK      PMVXUDT5,ARVXUDT5,SP70
          PACK      PMVXUDT6,ARVXUDT6,SP70
          PACK      PMVXCDTE,ARVXCDTE,SP70
          PACK      PMVXCTIM,ARVXCTIM,SP70
          PACK      PMVXWEBC,ARVXWEBC,SP70
          PACK      PMVXLUPD,ARVXLUPD,SP70
          PACK      PMVXLUPT,ARVXLUPT,SP70
          PACK      PMVXWEBU,ARVXWEBU,SP70
          PACK      PMVXMHLS,ARVXMHLS,SP70
          PACK      PMVXPICD,ARVXPICD,SP70
          PACK      PMVXRMOR,ARVXRMOR,SP70
          PACK      PMVXASUT,ARVXASUT,SP70
          PACK      PMVXELPS,ARVXELPS,SP70
          PACK      PMVXEMPL,ARVXEMPL,SP70
          PACK      PMVXFINP,ARVXFINP,SP70
          PACK      PMVXOCCP,ARVXOCCP,SP70
          PACK      PMVXPALC,ARVXPALC,SP70
          PACK      PMVXPPAL,ARVXPPAL,SP70
          PACK      PMVXPPPT,ARVXPPPT,SP70
          PACK      PMVXPSOS,ARVXPSOS,SP70
          PACK      PMVXPYSP,ARVXPYSP,SP70
          PACK      PMVXQLDB,ARVXQLDB,SP70
          PACK      PMVXREAD,ARVXREAD,SP70
          PACK      PMVXUDIN,ARVXUDIN,SP70
          PACK      PMVXUREA,ARVXUREA,SP70
          PACK      PMVXUSAC,ARVXUSAC,SP70
          PACK      PMVXUVTH,ARVXUVTH,SP70
          PACK      PMVXINTR,ARVXINTR,SP70
          PACK      PMVXLNG1,ARVXLNG1,SP70
          PACK      PMVXASGC,ARVXASGC,SP70
          PACK      PMVXMHOS,ARVXMHOS,SP70
          PACK      PMVXDSPD,ARVXDSPD,SP70
          PACK      PMVXDSIF,ARVXDSIF,SP70
          PACK      PMVXPRMI,ARVXPRMI,SP70
          PACK      PMVXPRAI,ARVXPRAI,SP70
          PACK      PMVXPRES,ARVXPRES,SP70
          PACK      PMVXUITR,ARVXUITR,SP70
          PACK      PMVXRPOA,ARVXRPOA,SP70
          PACK      PMVXRCN1,ARVXRCN1,SP70
          PACK      PMVXRCN2,ARVXRCN2,SP70
          PACK      PMVXRHFU,ARVXRHFU,SP70
          PACK      PMVXRDVA,ARVXRDVA,SP70
          PACK      PMVXRSLO,ARVXRSLO,SP70
          PACK      PMVXMLOC,ARVXMLOC,SP70
          PACK      PMVXPACC,ARVXPACC,SP70
          PACK      PMVXEDU1,ARVXEDU1,SP70
          PACK      PMVXEDU2,ARVXEDU2,SP70
          PACK      PMVXEDU3,ARVXEDU3,SP70
          PACK      PMVXPRGM,ARVXPRGM,SP70
          PACK      PMVXCONF,ARVXCONF,SP70
          PACK      PMVXEOCL,ARVXEOCL,SP70
          PACK      PMVXSLOC,ARVXSLOC,SP70
          PACK      PMVXSCLI,ARVXSCLI,SP70
          PACK      PMVXSTRA,ARVXSTRA,SP70
          PACK      PMVXQASN,ARVXQASN,SP70
          PACK      PMVXATCP,ARVXATCP,SP70
          PACK      PMVXATIM,ARVXATIM,SP70
          PACK      PMVXITIM,ARVXITIM,SP70
          PACK      PMVXHFGN,ARVXHFGN,SP70
          PACK      PMVXHFSN,ARVXHFSN,SP70
          PACK      PMVXFUPI,ARVXFUPI,SP70
          PACK      PMVXPOEC,ARVXPOEC,SP70
          PACK      PMVXSPAR,ARVXSPAR,SP70
.
          RETURN
+
.*****************************************************************************
.*                              TACC0000           Called by: UPDCLM00       *
.*        Trigger a broadcast message where an ACC record has changed.       *
.*        Read all the relevant visit records for the visit type, so that    *
.*        the holding table data will be populated with the relevant visit   *
.*        data when sending the broadcast message.                           *
.*        message.                                                           *
.* Requires: WCADMNO - visit number                                          *
.*           URNUMBER - U/R number                                           *
.*****************************************************************************
.
TACC0000  MOVE      URNUMBER,KEY8
          CALL      RDMAST1                    * PMI record found ?
          BRANCH    OVRCD,TACC9999             * no - don't send message
.
          MOVE      URNUMBER,KEY8
          CALL      RDPMPX21                   * PMI extension record found ?
          BRANCH    OVRCD,TACC9999             * no - don't send message
.
          MOVE      WCADMNO,KEY8
          CALL      RDVISA1                    * visit record found ?
          BRANCH    OVRCD,TACC9999             * no - don't send message
.
          BRANCH    PVITYPE,TACC1000:            * Emergency
                            TACC2000:            * Outpatient
                            TACC3000             * Inpatient
.
          GOTO      TACC9999                     * visit type not relevant
.
.         Emergency visit
.
TACC1000  MOVE      PVIBILL,KEY8
          CALL      RDEMVIS1                     * Emergency visit record found?
          BRANCH    OVRCD,TACC9999               * no
.
          COMPARE   FOUR,EMVISTAT
          GOTO      TACC9999 IF EQUAL
.
          MOVE      EMVIADMN,KEY8
          CALL      RDPMVX11
          BRANCH    OVRCD,TACC9999
.
.         Set up the message for sending
.
          CALL      PMIGTNID                   * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      ONE,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICEC                     * send update visit details
.
          GOTO      TACC9999                     * finished
.
.         Outpatient visit
.
TACC2000  MATCH     SP6,PVISITE                  * blank site ?
          GOTO      TACC9999 IF EQUAL            * yes - don't send message
.
          MOVE      PVISITE,KEY6                 
          CALL      RDSITA1                      * site found ?
          BRANCH    OVRCD,TACC9999               * no - don't send message
.
          MATCH     SP3,OSTFILE                  * site prefix blank ?
          GOTO      TACC9999 IF EQUAL            * yes - don't send message
.         
          PACK      CFNAME,OSTFILE,FILBOKA6
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      OUTBOKA6,CFNAME              * outbokaf opened ? 
          TRAPCLR   IO
          BRANCH    OVRCD,TACC9999               * no - don't send message
.
          PACK      CFNAME,OSTFILE,FILBB1A1      
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      OUTBB1A1,CFNAME              * outbb1af opened ?
          TRAPCLR   IO
          BRANCH    OVRCD,TACC9999               * no - don't send message
.
.         Get the outbokaf record
.
          PACK      KEY36,PVIBILL,SP20,SP20
          CALL      RDSBOKA6                     * position on visit number
          CALL      RDKBOKA6                     * read next record
          BRANCH    OVRCD,TACC9999               * eof - finished
.
          MATCH     OBAOUTNO,PVIBILL             * same visit number ?
          GOTO      TACC9999 IF NOT EQUAL        * no - get next O/P record
.
.         Get the outbb1af record
.
          MOVE      PVIBILL,KEY8
          CALL      RDBOKB1                      * outbb1af record found ?
          BRANCH    OVRCD,TACC9999               * no
.
.         Set up the message for sending
.         
          CALL      PMIGTNID                   * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI             
          MOVE      TWO,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICOB                     * send update visit details
.         
          GOTO      TACC9999
.         
.         Inpatient visit
.         
TACC3000  MOVE      PVIBILL,KEY8
          CALL      RDMISS1                      * Admission record found ?
          BRANCH    OVRCD,TACC9999               * no
.         
          MOVE      PVIBILL,KEY8
          CALL      RDPMVX11                     * visit extension found ?
          BRANCH    OVRCD,TACC9999               * no
.         
          IF        ASTAT = 3                    
            MOVE      PVIBILL,KEY8               
            CALL      RDDSCH1                    * discharge record found ?
            BRANCH    OVRCD,TACC9999             * no
          ENDIF
.
.         Get the last transfer record for the admission
.
          PACK      KEY30,PVIBILL,TILDA30
          CALL      RDSTRAN2                     * position on admission number
          CALL      RDPTRAN2                     * read previous record
          BRANCH    OVRCD,TACC9999               * eof - finished
.
          MATCH     TADMN,PVIBILL                * same admission still ?
          GOTO      TACC9999 IF NOT EQUAL        * no - finished
.
.         Set up the message for sending
.
          CALL      PMIGTNID                   * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      THREE,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICAC                     * send update visit details
.
TACC9999  RETURN
+
.-------------------------------------------------------------------------
. GETRGM00 - Get Multiple Regime Code for Admission Number
.-------------------------------------------------------------------------
GETRGM00  UNPACK    DIM127,D1,KEY2,DIM127
.
          PACK      KEY10,ADMISSNO,KEY2,DIM127
          CALL      RDPTRGM1
          BRANCH    OVRCD,GETRGM99
.
          WRITE     HTMLFILE;PTRGREGM;
.
GETRGM99  RETURN
.
.-------------------------------------------------------------------------
. GETCAD00 - Get Current Inpatient Admission Number         
.-------------------------------------------------------------------------
GETCAD00  PACK      KEY17,URNUMBER,TWO,SP70
          CALL      RSPTMI18
          CALL      RKPTMI18                      * Current admission
          BRANCH    OVRCD,GETCAD99
.
          MATCH     URNUMBER,AURNO
          GOTO      GETCAD99 IF NOT EQUAL
.
          MATCH     "2",DASTAT
          GOTO      GETCAD99 IF NOT EQUAL
.
          WRITE     HTMLFILE;AADMNO;
.
GETCAD99  RETURN
.
.-------------------------------------------------------------------------
. GETCTY00 - Get Care Type
.-------------------------------------------------------------------------
GETCTY00  MATCH     SP70,ADMISSNO
          GOTO      GETCTY99 IF EQUAL
          GOTO      GETCTY99 IF EOS
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPTMIS1
          BRANCH    OVRCD,GETCTY50
.
          IF        FIVE=ASTAT
            GOTO      GETCTY50
          ENDIF
.
          MATCH     SP70,ACARE
          GOTO      GETCTY99 IF EQUAL
          GOTO      GETCTY99 IF EOS
.
          MOVE      "CC",CATEGORY
          MOVE      ACARE,CODE
          CALL      CODITM00
.
          GOTO      GETCTY99
.
GETCTY50  PACK      KEY8,ADMISSNO,SP70
          CALL      RDBKREC1
          BRANCH    OVRCD,GETCTY99  
          CALL      RDBKRX11
          BRANCH    OVRCD,GETCTY99  
.
          MATCH     SP70,BKREEATY
          GOTO      GETCTY99 IF EQUAL
          GOTO      GETCTY99 IF EOS
.         
          MOVE      "CC",CATEGORY
          MOVE      BKREEATY,CODE
          CALL      CODITM00
.
GETCTY99  RETURN
.
.-------------------------------------------------------------------------
. GETEWB00 - Get Expected Ward and Bed
.-------------------------------------------------------------------------
GETEWB00  UNPACK    DIM127,D1,KEY1,DIM127
.
          MATCH     SP70,ADMISSNO
          GOTO      GETCTY99 IF EQUAL
          GOTO      GETCTY99 IF EOS
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPTMIS1
          BRANCH    OVRCD,GETEWB50
.         
          IF        FIVE=ASTAT
            GOTO      GETEWB50
          ENDIF
.         
          MATCH     "0",KEY1
          IF        @EQUAL
            WRITE     HTMLFILE;PTMIXWRD;
          ENDIF
.
          MATCH     "1",KEY1
          IF        @EQUAL
            WRITE     HTMLFILE;PTMIEBED;
          ENDIF
.
          MATCH     "2",KEY1
          IF        @EQUAL
            MATCH     SP70,PTMIXWRD
            GOTO      GETEWB99 IF EQUAL
            GOTO      GETEWB99 IF EOS
.
            PACK      KEY6,PTMIXWRD,SP70
            CALL      RDWARD1
            BRANCH    OVRCD,GETEWB99

            WRITE     HTMLFILE;WBDESC;              * expected ward description
          ENDIF
.
          MATCH     "3",KEY1
          IF        @EQUAL
            MATCH     SP70,PTMIXWRD
            GOTO      GETEWB99 IF EQUAL
            GOTO      GETEWB99 IF EOS
.
            MATCH     SP70,PTMIEBED
            GOTO      GETEWB99 IF EQUAL
            GOTO      GETEWB99 IF EOS
.
            PACK      KEY6,PTMIXWRD,PTMIEBED,SP70
            CALL      RDWARD1
            BRANCH    OVRCD,GETEWB99
.
            WRITE     HTMLFILE;WBDESC;              * expected ward description
          ENDIF
.
          GOTO      GETEWB99
.
GETEWB50  PACK      KEY8,ADMISSNO,SP70
          CALL      RDBKREC1
          BRANCH    OVRCD,GETEWB99
          CALL      RDBKREC1
          BRANCH    OVRCD,GETEWB99  
.
          MATCH     "0",KEY1
          IF        @EQUAL
            WRITE     HTMLFILE;BKREWARD;
          ENDIF
.
          MATCH     "1",KEY1
          IF        @EQUAL
            WRITE     HTMLFILE;BKREEBED;
          ENDIF
.
          MATCH     "2",KEY1
          IF        @EQUAL
            MATCH     SP70,BKREWARD
            GOTO      GETEWB99 IF EQUAL
            GOTO      GETEWB99 IF EOS
.           
            PACK      KEY6,BKREWARD,SP70
            CALL      RDWARD1
            BRANCH    OVRCD,GETEWB99
            
            WRITE     HTMLFILE;WBDESC;              * expected ward description
          ENDIF
.         
          MATCH     "3",KEY1
          IF        @EQUAL
            MATCH     SP70,BKREWARD
            GOTO      GETEWB99 IF EQUAL
            GOTO      GETEWB99 IF EOS
.           
            MATCH     SP70,BKREEBED
            GOTO      GETEWB99 IF EQUAL
            GOTO      GETEWB99 IF EOS
.
            PACK      KEY6,BKREWARD,BKREEBED,SP70
            CALL      RDWARD1
            BRANCH    OVRCD,GETEWB99
.
            WRITE     HTMLFILE;WBDESC;              * expected ward description
          ENDIF
.
GETEWB99  RETURN
+
.------------------------------------------------------------------------
.  Get last invoice number for selected visit
.------------------------------------------------------------------------
GETINV00  PACK      KEY32,URNUMBER,ADMISSNO,Z70
          CALL      RDSINV5
GETINV10  CALL      RDPINV5
          BRANCH    OVRCD,GETINV90
.
          MATCH     URNUMBER,PINVUR
          GOTO      GETINV90 IF NOT EQUAL
.
          MATCH     ADMISSNO,DPINVADM
          GOTO      GETINV90 IF NOT EQUAL
.
          GOTO      GETINV99
.
GETINV90  MOVE      SP70,PINVNO
GETINV99  RETURN
+
.------------------------------------------------------------------------
. format HCP column - clinic (hcp)
.------------------------------------------------------------------------
.
FRMD0000  MOVE      ALCNCLNF,FORM1
          BRANCH    FORM1,FRMD1000,FRMD2000
.
.         Clinic Description ( HCP )
.
          PACK      KEY50,SP20,SP20,SP20
          MATCH     SP6,OCADESC
          IF        !@EQUAL
           STRIP     DOCFNAME
           STRIP     OCADESC
.
           APPEND    OCADESC,KEY50
           APPEND    SP1,KEY50
           APPEND    OBRACKET,KEY50
           APPEND    DOCFNAME,KEY50
           APPEND    CBRACKET,KEY50
.
           RESET     KEY50
           STRIP     KEY50
           CLEAR     DOCFNAME
           PACK      DOCFNAME,KEY50
           RESET     DOCFNAME
          ENDIF
.
          GOTO      FRMD9999
.
.         HCP
.
FRMD1000  GOTO      FRMD9999
.

.
.         Clinic Description
.
FRMD2000  PACK      KEY50,SP20,SP20,SP20
          MATCH     SP6,OCADESC
          IF        !@EQUAL
            PACK      DOCFNAME,OCADESC
          ELSE
            PACK      DOCFNAME,SP70
          ENDIF
.
          GOTO      FRMD9999
.
FRMD9999  RETURN
.
.------------------------------------------------------------
. Routine to display the Allied Health Departments List
.------------------------------------------------------------
ARFD0000  PACK      PTCDKEY2,ANSC,ANSG,SP70
          CALL      RDSCODE2                      * positional read
ARFD0100  CALL      RDKCODE2                      * read a record
          BRANCH    OVRCD,ARFD9999                
.         
          MATCH     "CG",TCODE
          GOTO      ARFD9999 IF NOT EQUAL
.
          PACK      KEY3,ACODE,SP70
          CALL      RDALDEP1                      * Read department table
          BRANCH    OVRCD,ARFD0100
.
          MATCH     "1",ALDEACTV
          GOTO      ARFD0100 IF EQUAL       * Skip Inactive

          MATCH     FILTDEPT,ALDEDEPT
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",ALDEDEPT," selected>":
                             TDESC:
                             "</option>"
          ELSE
            IF        IBCNMHOS=1
              MATCH     SP70,ALDEHOSP
              IF        !@EQUAL
                PACK      KEY13,USERID,SP70              * All hospital access
                CALL      RDMLSEC1
                IF        OVRCD=1
                  PACK      KEY13,USERID,ALDEHOSP,SP70   * This hospital access
                  CALL      RDMLSEC1
                  IF        OVRCD=1
                    MATCH     WBSEHOSP,ALDEHOSP
                    GOTO      ARFD0100 IF NOT EQUAL
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
            WRITE     HTMLFILE;"<option value=",ALDEDEPT,">":
                             TDESC:
                             "</option>"
          ENDIF
          GOTO      ARFD0100
.
ARFD9999  RETURN
+
.------------------------------------------------------------
. Routine to display the ACC Summary List               
.------------------------------------------------------------
ACCSUM00  MOVE      ZERO,F3                 * clear ACC Num. array
          REPEAT
            ADD       ONE,F3
            MOVE      SP20,ACCNUMB[F3]
            MOVE      SP8,ACCVISN[F3]
          UNTIL     F3 = 300
.
          MOVE      ZERO,F3
          MOVE      ZERO,ACCCOUNT
.
          PACK      KEY16,URNUMBER,SP70
          CALL      RDSWCOM2
ACCSUM10  CALL      RDKWCOM2
          BRANCH    OVRCD,ACCSUM50
.
          MATCH     URNUMBER,PTWCURNO         * Match UR numbers
          GOTO      ACCSUM50 IF NOT EQUAL
.
          MOVE      ZERO,FOUND
          IF        ACCCOUNT > 0
            MOVE      ZERO,F3
            REPEAT
              ADD       ONE,F3
              MATCH     ACCNUMB[F3],WCCLMNO
              IF        @EQUAL
                MOVE      ONE,FOUND
                MOVE      ACCCOUNT,F3
              ENDIF
            UNTIL     F3 = ACCCOUNT
          ENDIF
          BRANCH    FOUND,ACCSUM10          * if already saved
.
          ADD       ONE,ACCCOUNT            * new ACC Number found - save it
          MOVE      WCCLMNO,ACCNUMB[ACCCOUNT]
          MOVE      DWCADMNO,ACCVISN[ACCCOUNT]
          COMPARE   "300",ACCCOUNT
          GOTO      ACCSUM50 IF EQUAL
.
          GOTO      ACCSUM10
.
ACCSUM50  COMPARE   ZERO,ACCCOUNT
          GOTO      ACCSUM99 IF EQUAL       * if no records found, end
.
          MOVE      ZERO,F3                 * read through saved ACC Numbers
          REPEAT
            ADD       ONE,F3
            PACK      KEY8,ACCVISN[F3],SP8
            CALL      RDWCOM1
            BRANCH    OVRCD,ACCSUM59        * overkill
.
            PACK      KEY8,DWCADMNO,SP70
            CALL      RDPMWX11
            IF        OVRCD=1
              CALL      CLPMSWX1
            ENDIF
.
            PACK      SAVDATA1,SP70,SP70,SP70,SP70
            UNPACK    SP70,ACCMACCN,ACCMTYPE,DACCMLIN
            PACK      ACCMDATA,SP70,SP70
            MOVE      "001  1",KEY6
            PACK      KEY26,WCCLMNO,KEY6,SP70
            CALL      RDACCMT1
            BRANCH    OVRCD,ACCSUM55
.
            STRIP     ACCMDATA
            CLEAR     SAVDATA1
            APPEND    ACCMDATA,SAVDATA1
.
            CALL      RKACCMT1
            BRANCH    OVRCD,ACCSUM55
            MATCH     WCCLMNO,ACCMACCN
            GOTO      ACCSUM55 IF NOT EQUAL
            MATCH     "001",ACCMTYPE
            GOTO      ACCSUM55 IF NOT EQUAL
            ENDSET    SAVDATA1
            APPEND    SP1,SAVDATA1
            STRIP     ACCMDATA
            ENDSET    SAVDATA1
            APPEND    ACCMDATA,SAVDATA1
ACCSUM55    RESET     SAVDATA1
.
            IF        PTCNHDPS=1
.
.             NZ only...
.
              CLEAR     HTMLLINK
              APPEND    "javascript:EditStatus('",HTMLLINK
              APPEND    PTWCURNO,HTMLLINK
              APPEND    "','",HTMLLINK
              APPEND    WCADMNO,HTMLLINK
              APPEND    "')",HTMLLINK
              RESET     HTMLLINK
.
              CLEAR     HTMLLNK2
              APPEND    "javascript:ACCAuditList('",HTMLLNK2
              APPEND    PTWCURNO,HTMLLNK2
              APPEND    "','",HTMLLNK2
              APPEND    WCADMNO,HTMLLNK2
              APPEND    "','",HTMLLNK2
              APPEND    ACCNUMB[F3],HTMLLNK2
              APPEND    "')",HTMLLNK2
              RESET     HTMLLNK2
.
              MOVE      ZERO,F1
              MOVE      WCESTAT0,WCSTDESC
.
              MOVE      PMWXCSTA,F1
              LOAD      WCSTDESC,F1,WCESTAT1,WCESTAT2,WCESTAT3
.
              WRITE     HTMLFILE;"t.addRow(#"",ACCNUMB[F3],"#",":         * 0
                                 "#"",SAVDATA1,"#",":                     * 1
                                 "#"",WCACDAT,"#",":                      * 2
                                 "#"",PMWXADTE,"#",":                     * 3
                                 "#"",WCSTDESC,"#",":                     * 4
                                 "#"",PMWXCSTA,"#",":                     * 5
                                 "#"",HTMLLINK,"#",":                     * 6
                                 "#"",HTMLLNK2,"#")"                      * 7
            ELSE
              WRITE     HTMLFILE;"t.addRow(#"",ACCNUMB[F3],"#",":         * 0
                                 "#"",SAVDATA1,"#",":                     * 1
                                 "#"",WCACDAT,"#",":                      * 2
                                 "#"",PMWXADTE,"#")"                      * 3
            ENDIF
.
ACCSUM59    MOVE      SP1,KEY1
          UNTIL     F3 = ACCCOUNT
.
ACCSUM99  RETURN
.
.------------------------------------------------------------
. Extra Contact list (sort table)
.------------------------------------------------------------
CEXT0000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          PACK      KEY14,URNUMBER,SP20
          CALL      RSPMCEX1
CEXT0010  CALL      RKPMCEX1
          BRANCH    OVRCD,CEXT0099
.
          MATCH     URNUMBER,PMCEURNO
          GOTO      CEXT0099 IF NOT EQUAL
.
          PACK      KEY5,CATTC,PMCETYPE
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      PMCETYPE,TDESC
          ENDIF
.
          PACK      KEY4,PMCETITL
          CALL      RDPMTLE1
          IF        OVRCD=1
            MOVE      PMCETITL,PMTLDESC
          ENDIF
.
          PACK      KEY10,PMCERELP,SP70
          CALL      RDPMREL1
          IF        OVRCD=1
            MOVE      PMCERELP,PMRLDESC
          ENDIF
.
CEXT0080  CLEAR     HTMLLINK
          APPEND    "javascript:ShowContact('",HTMLLINK
          APPEND    PMCEURNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMCETYPE,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMCECNTR,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          MOVE      "No",DIM3
          MATCH     "1",PMCESLET
          IF        @EQUAL
            MOVE      "Yes",DIM3
          ENDIF
.
          MOVE      "No",D3
          MATCH     "1",PMCEACTV
          IF        @EQUAL
            MOVE      "Yes",D3
          ENDIF
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":              *0
                                      "#"",TDESC,"#",":                 *1
                                      "#"",PMRLDESC,"#",":              *2
                                      "#"",PMCEGNAM," ",PMCESNAM,"#",": *3
                                      "#"",PMCETELP,"#",":              *4
                                      "#"",PMCETELB,"#",":              *5
                                      "#"",PMCETELM,"#",":              *6
                                      "#"",PMCEADD1," ",PMCEADD2:
                                      " ",PMCEADD3," ",PMCEADD4:
                                      " ",PMCEPOST,"#",":               *7
                                      "#"",DIM3,"#",":                  *8
                                      "#"",D3,"#",":                    *9
                                      "#"",TCFORM6,"#",":               *10
                                      "#"",PMCEEMAI,"#");"              *11
.
          GOTO      CEXT0010
.
CEXT0099  RETURN
.
.------------------------------------------------------------
. List Extra Contacts (not tablesort)
.------------------------------------------------------------
LSTEXC00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          CALL      GEXC0000
.
.         loop over temp file to output in associated number order
.
LSTEXC05  PACK      KEY12,SP70
          READ      TEMPO,KEY12;;
.
LSTEXC10  READKS    TEMPO;KEY12
          GOTO      LSTEXC99 IF OVER        * end of file
.
          UNPACK    KEY12,KEY6,KEY3,KEY3A
          PACK      KEY14,URNUMBER,KEY3,KEY3A,SP70
          CALL      RDPMCEX1
          BRANCH    OVRCD,LSTEXC10
.
          PACK      KEY5,CATTC,PMCETYPE
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      PMCETYPE,TDESC
          ENDIF
.
          PACK      KEY4,PMCETITL
          CALL      RDPMTLE1
          IF        OVRCD=1
            MOVE      PMCETITL,PMTLDESC
          ENDIF
.
          PACK      KEY10,PMCERELP,SP70
          CALL      RDPMREL1
          IF        OVRCD=1
            MOVE      PMCERELP,PMRLDESC
          ENDIF
.
          IF        NZFLAG=1
            GOTO      LSTEXC81
          ELSE
            GOTO      LSTEXC80
          ENDIF

LSTEXC80  WRITE     HTMLFILE;"<tr><td nowrap>":
                             TDESC,"</td>";
.
          WRITE     HTMLFILE;"<td>",PMRLDESC,"</td>":
                             "<td>",PMCEGNAM,SP1,PMCEGNM2,SP1,PMCESNAM,"</td>":
                             "<td>",PMCETELP,"</td>":
                             "<td>",PMCETELB,"</td>":
                             "<td>",PMCETELM,"</td>":
                             "<td>",PMCEADD1,PMCEADD2,PMCEADD3:
                                    PMCEADD4,PMCEPOST,"</td>":
                             "<td>",PMCEFTXT,"</td>":
                             "</tr>";
          GOTO      LSTEXC10
.
.------- NZ FORMAT
LSTEXC81  WRITE     HTMLFILE;"<tr><td nowrap>":
                             TDESC,"</td>";
.
          WRITE     HTMLFILE;"<td>",PMRLDESC,"</td>":
                             "<td>",PMCEGNAM,SP1,PMCEGNM2,SP1,PMCESNAM,"</td>":
                             "<td>",PMCETELP,"</td>":
                             "<td>",PMCETELB,"</td>":
                             "<td>",PMCETELM,"</td>":
                             "<td>",PMCEEMAI,"</td>":
                             "<td>",PMCEADD1,PMCEADD2,PMCEADD3:
                                    PMCEADD4,PMCEPOST,"</td>":
                             "</tr>";
          GOTO      LSTEXC10
.
LSTEXC99  CALL      DTMPO000
          RETURN
.
.
.*********************************************************************
.         get the extra contacts output order
.*********************************************************************
GEXC0000  CALL      CTMPO000                * create temp file
.
          PACK      KEY14,URNUMBER,SP70
          CALL      RSPMCEX1
GEXC1000  CALL      RKPMCEX1
          BRANCH    OVRCD,GEXC9999          * end of file
.
          MATCH     URNUMBER,PMCEURNO
          GOTO      GEXC9999 IF NOT EQUAL
.
          MATCH     "1",PMCEACTV
          GOTO      GEXC1000 IF EQUAL
.
          PACK      KEY5,CATTC,PMCETYPE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,GEXC1000
.
          PACK      KEY12,TCFORM6,ACODE,PMCECNTR,SP70
          READ      TEMPO,KEY12;ANS
          GOTO      GEXC1000 IF NOT OVER    * already on temp file
.
          WRITE     TEMPO,KEY12;KEY12
          GOTO      GEXC1000
.
GEXC9999  RETURN
+
.*********************************************************************
.*                  CTMPO000                    Called by : GFOB0000 *
.*        Create a temp file                                         *
.*********************************************************************
CTMPO000  CALL      DTMPO000                * delete temp file
.
          CLEAR     CMDLINE                 * clear command line
          PACK      CMDLINE,ISBUILD,CFNAMEO,KEYO,SP30      * set command
          RESET     CMDLINE                 * reset FP
          EXECUTE   CMDLINE,TASKID          * build the temp file
          OPEN      TEMPO,CFNAMEO           * open the temp file
.
CTMPO999  RETURN
+
.*********************************************************************
.*                  DTMPO000                    Called by : GFOB0000 *
.*        Delete temp file O                                         *
.*********************************************************************
DTMPO000  CLOSE     TEMPO                   * close temp file
          CLEAR     CMDLINE                 * clear command line
          PACK      CMDLINE,ISERASE,CFNAMEO * set command line for erase
          RESET     CMDLINE                 * reset FP
          EXECUTE   CMDLINE,TASKID          * delete the temp file
.
DTMPO999  RETURN
+
.------------------------------------------------------------
. Person Responsible for Account table
.------------------------------------------------------------
PRFAT000  PACK      KEY8,ADMISSNO,SP20
          CALL      RDRESP1
          BRANCH    OVRCD,PRFAT900
.
          PACK      KEY10,PMCERELP,SP70
          CALL      RDPMREL1
          IF        OVRCD=1
            MOVE      PMCERELP,PMRLDESC
          ENDIF
.
PRFAT100  WRITE     HTMLFILE;"<tr><td nowrap>":
.<A HREF='javascript:":
.                            "UpdatePRFA":
.                            "(#"patweb89.pbl":
.                            "?reportno=01":
.                            "&template=037":
.                            "&urnumber=",URNUMBER:
.                            "&admissno=",ADMISSNO,"#")'>":
.                            "<img src=../images/MaintenanceIcon.gif hspace=4":
.                            " border=0 align=absmiddle></a>":
                             PKNAME,"</td>":
                             "<td>",PKADD1,SP1,PKADD2,SP1,PKSUBR:
                             SP1,PKADD4,SP1,PKPOST,"</td>":
                             "<td>&nbsp;",PKTELEP,"</td>":
                             "<td>&nbsp;",PKTELEB,"</td>":
                             "<td>&nbsp;",PTREMOBL,"</td>":
                             "</tr>";
          GOTO      PRFAT999
.
PRFAT900  WRITE     HTMLFILE;"<tr><td nowrap>":
                             "No Visit Person Responsible Selected</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "</tr>";
PRFAT999  RETURN
.
.------------------------------------------------------------
. Patient Trust Details
.------------------------------------------------------------
PATTR000  MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,PATTR900
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MOVE      ADMISSNO,KEY8
          CALL      RDPMVX11
          IF        OVRCD=1
            CALL      CLPATMIS
            BRANCH    OVRCD,PATTR920
          ENDIF
.
          RESET     UPDTTYPE
          MATCH     SP70,UPDTTYPE
          GOTO      PATTR800 IF EQUAL
.
          MATCH     "U",UPDTTYPE    * Update formaction
          GOTO      PATTR100 IF EQUAL
.
          GOTO      PATTR999
.
PATTR100  CALL      UPTRS000       * Update Patient Trust fields
          GOTO      PATTR999
.  
PATTR800  CLEAR     WEBTITLE
          MOVE      "Patient Trust",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,PATTR999
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      PATTR999
.
PATTR900  MOVE      "Invalid UR Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
PATTR920  MOVE      "Invalid Visit Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
PATTR999  RETURN 
+
.------------------------------------------------------------
. Update Patient Trust Details
.------------------------------------------------------------
UPTRS000  MOVE      ADMISSNO,KEY8
          CALL      RDPMVX11
          BRANCH    OVRCD,UPTRS900
.
          MATCH     Z70,PTTRS001
          IF        !@EQUAL
            PACK      PMVXPHLD,PTTRS001,SP70
          ENDIF
.
          MATCH     Z70,PTTRS002
          IF        !@EQUAL
            PACK      PMVXDTRT,PTTRS002,SP70
          ENDIF
.
          MATCH     Z70,PTTRS003
          IF        !@EQUAL
            PACK      PMVXVLOC,PTTRS003,SP70
          ENDIF
.
          CALL      UPPMVX11
          GOTO      UPTRS999
.
UPTRS900  MOVE      "Invalid Visit Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
UPTRS999  RETURN
+
.------------------------------------------------------------
. GASF0000 - Get admission SFA file stuff - From PATPRG31
.------------------------------------------------------------
.
GASF0000  MOVE      ADMISSNO,AADMNO
          PACK      KEY25,ADMISSNO,ANSA,SP70
          CALL      RDPTASF1                * Read an admin SFA file record
          BRANCH    OVRCD,GASF1000
.
          MATCH     AADMNO,PTAFADMN
          GOTO      GASF1000 IF NOT EQUAL   * Different admin no
.
          MATCH     ANSA,PTAFTYPE
          GOTO      GASF9999 IF EQUAL       * An admin SFA type
.
GASF1000  MOVE      ZEROVISN,PTAFADMN
          UNPACK    SP70,PTAFTYPE,PTAFDATE,PTAFTIME,PTAFCODE,PTAFCTYP
          UNPACK    SP70,PTAFCROL,PTAFCSID,PTAFSPAR
.
GASF9999  RETURN
+
.-------------------------------------------------------------
. MDLS0000 - Get latest Mental Health Legal Status from mehdls
.-------------------------------------------------------------
MDLS0000  PACK      KEY32,URNUMBER,Z70
          CALL      RSMHDLS1
          CALL      RPMHDLS1
          BRANCH    OVRCD,MDLS9999
.
          MATCH     URNUMBER,MHDLURNO
          GOTO      MDLS9999 IF NOT EQUAL
.
          MATCH     SP70,MHDLEDAT
          GOTO      MDLS5000 IF EQUAL
          GOTO      MDLS5000 IF EOS
.
          CALL      IBACLOCK
          PACK      TODAY,CCC,CYY,CMM,CDD
          REP       " 0",TODAY 
.
          MATCH     TODAY,MHDLEDAT
          GOTO      MDLS9999 IF LESS
.
MDLS5000  MATCH     SP70,MHDLSCOD
          GOTO      MDLS9999 IF EQUAL
          GOTO      MDLS9999 IF EOS
.
          PACK      KEY5,ANSL,ANSS,MHDLSCOD,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            WRITE     HTMLFILE;MHDLSCOD;
          ELSE
            WRITE     HTMLFILE;TDESC;
          ENDIF
.
MDLS9999  RETURN
+
.------------------------------------------------------------
. Get MEH Discharge Diagnosis details (last record)
.------------------------------------------------------------
MEHDIA00  PACK      KEY16,ADMISSNO,Z70
          CALL      RSMHDIA1
          CALL      RPMHDIA1
          BRANCH    OVRCD,MEHDIA90
.         
          MATCH     ADMISSNO,DMHDIADM
          GOTO      MEHDIA90 IF NOT EQUAL
.
          GOTO      MEHDIA99
.
MEHDIA90  CALL      CLMEHDIA                * clear vars
MEHDIA99  RETURN
+
.--------------------------------------------------------------
. MHDP0000          Mental Health Patient         * I SRF 22731
.--------------------------------------------------------------
.
MHDP0000  COMPARE   ONE,MHCNUSE
          GOTO      MHDP0150 IF NOT EQUAL
          PACK      KEY8,AADMNO
          CALL      RAMHVIS1
          BRANCH    OVRCD,MHDP0150
          WRITE     HTMLFILE;ONE;
          GOTO      MHDP9999
.
MHDP0150  WRITE     HTMLFILE;ZERO;
          GOTO      MHDP9999
.
MHDP9999  RETURN
+
.
.---------------------------------------------------------------------------
. Check if this MR is in transit to the current location
.---------------------------------------------------------------------------
ITRN0000  MOVE      SP70,INTRANST
.
          MATCH     "1",MRCNTREC                 * System Using Tracking Receipt
          GOTO      ITRN9999 IF NOT EQUAL
.
          PACK      KEY26,MRMAKEY,Z70
          CALL      RSMRHIS1
          CALL      RPMRHIS1                     * Read last history record
          BRANCH    OVRCD,ITRN9999
.
          MATCH     MRMAKEY,MRHIKEY              * Correct MR history record
          GOTO      ITRN9999 IF NOT EQUAL
.
          MATCH     MRMACHOS,MRHIDHOS            * Check last history record matches
          GOTO      ITRN9999 IF NOT EQUAL        * the current hospital
.
          MATCH     MRMACLOC,MRHILOC             * Check last history record matches
          GOTO      ITRN9999 IF NOT EQUAL        * the current location
.
          MATCH     "1",MRHIRCST                 * In Transit
          GOTO      ITRN9999 IF NOT EQUAL
.
          MOVE      "<font color=red>(T)</font>",INTRANST
.
ITRN9999  RETURN
+                                                 * end I SRF 22731
.------------------------------------------------------------
. Ward selection - Ward Only (use Ward/Bed search for Bed Wards)
.------------------------------------------------------------
.
WSEL0000  PACK      KEY29,SP70
          IF        IBCNMHOS = 1
            PACK      KEY29,SP3,PMVXMHOS,SP70    * patients current hospital
          ENDIF
          CALL      RDSWARD7
WSEL0100  CALL      RDKWARD7
          BRANCH    OVRCD,WSEL9999
.
.                         if we have a bed number we have passed all the ward
.                         master records, so exit
          MATCH     SP70,WBED
          GOTO      WSEL9999 IF NOT EQUAL
.
          COMPARE   WACTIVE,ZERO                 *List only active wards
          GOTO      WSEL0100 IF NOT EQUAL
.
          IF        IBCNMHOS = 1
            MATCH      SP3,PMVXMHOS
            IF        !@EQUAL
              MATCH     PMVXMHOS,PTWDHOSN
              GOTO      WSEL9999 IF NOT EQUAL
            ENDIF
          ENDIF
.
.                       write the select option.
          WRITE     HTMLFILE;"<option value=#"",WWARD,"#"";
          MATCH     DFLTWARD,WWARD
          IF        @EQUAL
            WRITE     HTMLFILE;" selected";
          ENDIF
          WRITE     HTMLFILE;">",WBDESC;
.
          IF        IBCNMHOS = 1
            MATCH      SP3,PMVXMHOS
            IF        @EQUAL
              WRITE     HTMLFILE;" - ",PTWDHOSN;
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"</option>"
          GOTO      WSEL0100
.
WSEL9999  RETURN
+
.-----------------------------------------------
. Supervisor Bulk Update Transfer Change Records
.-----------------------------------------------
UPDTRN00  MOVE      ZERO,F1
          MOVE      SP70,CURPTASF
.
          MATCH     "I",UPDTTYPE
          IF        @EQUAL
            CALL      INSTRN00
            GOTO      UPDTRN99
          ENDIF           
.
          MATCH     "U",UPDTTYPE
          IF        @EQUAL
            IF        TRNSUPTY=5
              GOTO      UPDTRN40               * care type update (005)
            ELSE
              PACK      KEY25,ADMISSNO,ANSA,SP70
              CALL      RDPTASF1               * Read an admin SFA file record
              IF        OVRCD=1
                PACK      CURPTASF,SP70
              ELSE
                PACK      CURPTASF,PTAFCSID,SP70
              ENDIF
              GOTO      UPDTRN50               * transfer update
            ENDIF
          ENDIF
.
          MATCH     "T",UPDTTYPE
          GOTO      UPDTRN30 IF EQUAL          * update transfer date/time (007)
.
          MATCH     SP70,TRANSKEY
          GOTO      UPDTRN20 IF EQUAL          * get/display details only
.
.         Display change date/time screen (either tran or care type record)
.
          UNPACK    TRANSKEY,KEY24,D6
          MATCH     SP6,D6
          IF        !@EQUAL
            MATCH     "CURRNT",D6
            IF        !@EQUAL
              MATCH     "ADMISS",D6
              IF        !@EQUAL
                GOTO      UPDTRN15             * transfer record update
              ENDIF
            ENDIF
          ENDIF
          PACK      KEY30,KEY24,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2                   * get tran record for care type
          BRANCH    OVRCD,UPDTRN90
          MATCH     KEY24,DTADMN
          GOTO      UPDTRN90 IF NOT EQUAL
.
          PACK      TRANSKEY,TADMN,TDATE,TTIME,TWARD,TBED
.
UPDTRN15  PACK      KEY30,TRANSKEY,SP70
          CALL      RDTRAN2                    * get specific tran record
          IF        OVRCD=1
            CALL      CLPATTRN
          ENDIF
.
          CALL      GETTRN00              * get transfer details
          CALL      GETCAR00              * get care type
.
          PACK      KEY8,TADMN,SP70
          CALL      RDMISS1
          IF        OVRCD=1
            CALL      CLPATMIS
          ENDIF
          PACK      KEY8,TADMN,SP70
          CALL      RDDSCH1
          IF        OVRCD=1
            CALL      CLPATDSC
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Supervisor Transfer Change",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,UPDTRN99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      UPDTRN99
.
UPDTRN20  CALL      GETPAT00                   * get/display transfer details
          GOTO      UPDTRN98
.
UPDTRN30  PACK      KEY30,TRANSKEY,SP70        * transfer date/time update
          CALL      RDTRAN2
          BRANCH    OVRCD,UPDTRN95
.
          COMPARE   SEVENTY2,TRNSUPTY
          GOTO      UPDTRN35 IF EQUAL          * care type date/time update
.
          MATCH     Z70,TRNTODAT               * update date/time
          IF        !@EQUAL
            PACK      KEY30,TADMN,TRNTODAT,TRNTOTIM,TWARD,TBED,SP70
            MATCH     TRANSKEY,KEY30                  * Date/Time change
            IF        !@EQUAL
              CALL      RDATRAN2                      * Check for duplicate
              IF        OVRCD<>1
                GOTO      UPDTRN89                 
              ENDIF
              PACK      KEY30,TRANSKEY,SP70
              CALL      RDTRAN2                       * Re read original record
              BRANCH    OVRCD,UPDTRN95
            ENDIF
.
            PACK      PMCHOVAL,TRANSKEY,SP70,SP70     * old value
            PACK      TDATE,TRNTODAT,SP70
            PACK      TTIME,TRNTOTIM,SP70
            PACK      PMCHNVAL,TADMN,TDATE,TTIME,TWARD,TBED,SP70,SP70     * new
            MOVE      "007",PMCHCTYP                    * change type
          ENDIF
.
          PACK      TRCDATE,CCC,CYY,CMM,CDD
          REP       " 0",TRCDATE
          CLOCK     TIME,TRCTIME
          MOVE      WBSEUID,PTTRUUID
          CALL      UPTRAN2
.
          CALL      WSTA0000                * Write a transfer audit record
          MATCH     ANSD,TMOVE
          IF        @EQUAL
            MOVE      ONE,F1                * discharge record has been updated
          ENDIF
          GOTO      UPDTRN95
.
UPDTRN35  PACK      KEY24,TRANSKEY,SP70
          CALL      RDCHCO1                 * read care type change record
          IF        OVRCD=1
            CALL      RDKCHCO1              * read next care type change record
            BRANCH    OVRCD,UPDTRN95
          ENDIF
.
          MATCH     TRANSKEY,DCHADMN
          GOTO      UPDTRN95 IF NOT EQUAL
.
          MATCH     Z70,TRNTODAT               * update date/time
          IF        !@EQUAL
            PACK      PMCHOVAL,KEY24,SP70,SP70     * old value
            PACK      CHDATE,TRNTODAT,SP70
            PACK      CHTIME,TRNTOTIM,SP70
            PACK      PMCHNVAL,CHADMN,CHDATE,CHTIME,SP70,SP70     * new
            MOVE      "007",PMCHCTYP                    * change type
          ENDIF
.
          PACK      CHUPDATE,CCC,CYY,CMM,CDD
          REP       " 0",CHUPDATE
          CLOCK     TIME,CHUPTIME
          MOVE      WBSEPCD,CHUPUSID
          CALL      UPCHCO1
.
          PACK      KEY8,TADMN,SP70
          CALL      RDMISS1
          IF        OVRCD<>1
            IF        ASTAT=3
              MOVE      SP8,ACODDTE
              CALL      UPMISS1
            ENDIF
          ELSE
            CALL      CLPATMIS
          ENDIF
          CALL      WSTA0000                * Write a transfer audit record
          GOTO      UPDTRN95
.
UPDTRN40  MOVE      ONE,TRNCOUNT              * care type update (005)
UPDTRN45  MATCH     SP70,TRNRECKY[TRNCOUNT]   * Any more records to update
          GOTO      UPDTRN95 IF EQUAL         * end of records
.
          UNPACK    TRNRECKY[TRNCOUNT],KEY24,D6
          MATCH     "CURRNT",D6
          IF        @EQUAL
            CALL      CURCC000              * current care type change
            GOTO      UPDTRN48
          ENDIF
.
          CALL      RDSCHCO1                * read care type change record
          CALL      RDKCHCO1                * read care type change record
          BRANCH    OVRCD,UPDTRN48
.
          MATCH     TRNRECKY[TRNCOUNT],DCHADMN
          GOTO      UPDTRN48 IF NOT EQUAL
.
          MATCH     Z70,TRNTOCTY            * update care type (not current)
          IF        !@EQUAL
            PACK      PMCHOVAL,CHCODE,SP70,SP70     * old value
            MOVE      TRNTOCTY,CHCODE
            PACK      PMCHNVAL,CHCODE,SP70,SP70     * new value
            MOVE      "005",PMCHCTYP                * change type
          ENDIF
.
          PACK      CHUPDATE,CCC,CYY,CMM,CDD
          REP       " 0",CHUPDATE
          CLOCK     TIME,CHUPTIME
          MOVE      WBSEPCD,CHUPUSID
.
          CALL      UPCHCO1
          CALL      WSTA0000                * Write a transfer audit record
UPDTRN48  ADD       ONE,TRNCOUNT
          GOTO      UPDTRN45
.
UPDTRN50  MOVE      ONE,TRNCOUNT               * transfer record update
UPDTRN55  MATCH     SP70,TRNRECKY[TRNCOUNT]    * Any more records to update
          GOTO      UPDTRN95 IF EQUAL
.
          PACK      KEY30,TRNRECKY[TRNCOUNT],SP70
          CALL      RDTRAN2
          BRANCH    OVRCD,UPDTRN80
.
          MATCH     Z70,TRNTOWRD               * update ward/bed
          IF        !@EQUAL
            PACK      PMCHOVAL,TWARD,TBED,SP70,SP70          * old value
            PACK      TWARD,TRNTOWRD,SP70
            PACK      TBED,TRNTOBED,SP70
            PACK      KEY6,TWARD,TBED,SP70
            CALL      RDWARD1
            IF        OVRCD<>1
              PACK      TRBTYP,WEFRBT,SP70
            ENDIF
            PACK      PMCHNVAL,TWARD,TBED,SP70,SP70          * new value
            MOVE      "001",PMCHCTYP                         * change type
          ENDIF
.
          MATCH     Z70,TRNTOCLM               * update claim type
          IF        !@EQUAL
            PACK      PMCHOVAL,PTTRCLTY,SP70,SP70     * old value
.
. if indictor 1 on Cat CL=P, then store old funding source value
. if indictor 1 on Cat CL=W, then add a record to acc audit file(only for NZ)
.
            PACK      KEY5,ANSC,ANSL,PTTRCLTY,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MATCH     ANSP,TCINDC1
              IF        @EQUAL
                PACK      KEY8,DTADMN,SP70
                CALL      RDMISS1
                IF        OVRCD<>1
                  PACK      PMCHOVAL,PTTRCLTY,SP1,PMVXFSRC,SP70,SP70 * old value
                ENDIF
              ENDIF
.
              IF        PTCNHDPS=1
                IF        TRNSUPTY=2
                  CALL      DEWCOM00             *T0872408
                ELSE
                  CALL      MVACCREM
                ENDIF
              ENDIF
            ENDIF
            MOVE      TRNTOCLM,PTTRCLTY
.
            MATCH     Z70,TRNTOFNS                    * update funding Source
            IF        !@EQUAL
              PACK      PMCHNVAL,PTTRCLTY,SP1,TRNTOFNS,SP70,SP70 * new value
            ELSE
              PACK      PMCHNVAL,PTTRCLTY,SP70,SP70   * new value
            ENDIF
            MOVE      "002",PMCHCTYP                  * change type
            PACK      PTTRFSRC,TRNTOFNS,SP70
            CALL      UPEX0000                        * Update Extra compensable
          ENDIF
.
          MATCH     Z70,TRNTOPAT                      * update patient type
          IF        !@EQUAL
            PACK      PMCHOVAL,TATYPE,SP70,SP70       * old value
            PACK      PMCHNVAL,TRNTOPAT,SP70,SP70     * new value
            MOVE      "003",PMCHCTYP                  * change type
.
            PACK      KEY5,ANSA,SP1,TATYPE,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MOVE      ONE,F4
              SQUEEZE   THCSCOD
              MOVE      THCSCOD,F4
              IF        F4 = 0 | F4 = 5
                PACK      PMCHOVAL,TATYPE,SP1,CURPTASF,SP70,SP70   * old value
              ENDIF
            ENDIF
.
            MOVE      TRNTOPAT,TATYPE
.
            PACK      KEY5,ANSA,SP1,TATYPE,SP70
            CALL      RDCODE1
            BRANCH    OVRCD,UPDTRN60
.
            MOVE      ONE,F4
            SQUEEZE   THCSCOD
            MOVE      THCSCOD,F4
            IF        F4 = 0 | F4 = 5
              PACK      PMCHNVAL,TRNTOPAT,SP1,PTASF003,SP70,SP70 * new value
              MOVE      DTADMN,PTAFADMN
              MOVE      "A",PTAFTYPE
              MOVE      SP8,PTAFDATE
              MOVE      SP8,PTAFTIME
              MOVE      SP70,PTAFSPAR
              PACK      PTAFCSID,PTASF003,SP70
              PACK      KEY25,PTAFADMN,PTAFTYPE,PTAFDATE,PTAFTIME
              CALL      RAPTASF1               * Read an admin SFA file record
              IF        OVRCD=1
	        CALL      WRPTASF1             * Write an admin SFA file record
              ELSE
	        CALL      UPPTASF1             * Update an admin SFA file record
              ENDIF
           ENDIF
          ENDIF
.
UPDTRN60  MATCH     Z70,TRNTODOC               * update doctor/unit/team
          IF        !@EQUAL
            PACK      PMCHOVAL,TADOCT,TDEPT,PTTRTEAM,SP70,SP70  * old value
            PACK      TADOCT,TRNTODOC,SP70
            PACK      TDEPT,TRNTOUNT,SP70
            PACK      PTTRTEAM,TRNTOTEM,SP70
            PACK      PMCHNVAL,TADOCT,TDEPT,PTTRTEAM,SP70,SP70  * new value
            MOVE      "004",PMCHCTYP                  * change type
          ENDIF
.
          MATCH     Z70,TRNTOBTY               * update bed type
          IF        !@EQUAL
            PACK      PMCHOVAL,TRBTYP,SP70,SP70     * old value
            MOVE      TRNTOBTY,TRBTYP
            PACK      PMCHNVAL,TRBTYP,SP70,SP70     * new value
            MOVE      "006",PMCHCTYP                  * change type
          ENDIF
.
UPDTRN70  MATCH     Z70,TRNTOREG               * update registrar
          IF        !@EQUAL
            MOVE      TRNTOREG,VALDHCPC
            MOVE      TDATE,VALDEDAT
            CALL      VALHCP00
            BRANCH    EXIT,UPDTRN91,UPDTRN92,UPDTRN93,UPDTRN94
.
            PACK      PMCHOVAL,PTTRRSTR,SP70,SP70     * old value
            MOVE      TRNTOREG,PTTRRSTR
            PACK      PMCHNVAL,PTTRRSTR,SP70,SP70     * new value
            MOVE      "008",PMCHCTYP                  * change type
          ENDIF
.
UPDTRN71  MATCH     Z70,TRNTORES               * update resident
          IF        !@EQUAL
            MOVE      TRNTORES,VALDHCPC
            MOVE      TDATE,VALDEDAT
            CALL      VALHCP00
            BRANCH    EXIT,UPDTRN91,UPDTRN92,UPDTRN93,UPDTRN94
.
            PACK      PMCHOVAL,PTTRRESI,SP70,SP70     * old value
            MOVE      TRNTORES,PTTRRESI
            PACK      PMCHNVAL,PTTRRESI,SP70,SP70     * new value
            MOVE      "009",PMCHCTYP                  * change type
          ENDIF
.
          PACK      TRCDATE,CCC,CYY,CMM,CDD
          REP       " 0",TRCDATE
          CLOCK     TIME,TRCTIME
          MOVE      WBSEUID,PTTRUUID
          CALL      UPTRAN2
.
          CALL      WSTA0000                * Write a transfer audit record
          CALL      EDWT0000                * Write EDWARD triggers
.
          MATCH     ANSD,TMOVE
          IF        @EQUAL
.
            MATCH     Z70,TRNTOWRD
            IF        !@EQUAL
              PACK      KEY8,ADMISSNO
              CALL      RDDSCH1
              IF        OVRCD=0
                MOVE      TWARD,PTDSDWRD
                CALL      UPDSCH1
              ENDIF
            ENDIF
.
            MOVE      ONE,F1                * discharge record has been updated
          ENDIF
.
UPDTRN80  ADD       ONE,TRNCOUNT
          GOTO      UPDTRN55
.
UPDTRN89  MOVE     "Transfer record already exists for this date/time.",WEBTITLE
          CALL      WEBERR00
          GOTO      UPDTRN98
.
UPDTRN90  MOVE     "Cannot update transfer file.",WEBTITLE
          CALL      WEBERR00
          GOTO      UPDTRN98
.
UPDTRN91  CLEAR     WEBTITLE
          STRIP     VALDHCPC
          APPEND    "Invalid HCP Code - ",WEBTITLE
          APPEND    VALDHCPC,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          GOTO      UPDTRN98
.
UPDTRN92  CLEAR     WEBTITLE
          APPEND    "Invalid User Id - ",WEBTITLE
          APPEND    USERID,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          GOTO      UPDTRN98
.
UPDTRN93  PACK      KEY3,WBSEHOSP
          CALL      RDPTHSP1
          IF        OVRCD=1
            MOVE      SP70,PTHSNAME
          ENDIF
.
          CLEAR     WEBTITLE
          STRIP     VALDHCPC
          STRIP     PTHSNAME
          APPEND    "HCP Code '",WEBTITLE
          APPEND    VALDHCPC,WEBTITLE
          APPEND    "' not active in Hospital '",WEBTITLE
          APPEND    PTHSNAME,WEBTITLE
          APPEND    "'",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          GOTO      UPDTRN98
.
UPDTRN94  PACK      KEY3,WBSEHOSP
          CALL      RDPTHSP1
          IF        OVRCD=1
            MOVE      SP70,PTHSNAME
          ENDIF
.
          CLEAR     WEBTITLE
          STRIP     VALDHCPC
          STRIP     PTHSNAME
          APPEND    "HCP Code '",WEBTITLE
          APPEND    VALDHCPC,WEBTITLE
          APPEND    "' not active in Hospital '",WEBTITLE
          APPEND    PTHSNAME,WEBTITLE
          APPEND    "' on this date.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          GOTO      UPDTRN98
.
UPDTRN95  MOVE      ZERO,EXIT
.
.         If updating a discharge transfer record, F1=1
.
          IF        F1=1
            PACK      KEY8,TURNO,SP70
            CALL      RDMAST1
            BRANCH    OVRCD,UPDTRN99
.
            PACK      KEY8,TURNO,SP70
            CALL      RDPMPX21
            BRANCH    OVRCD,UPDTRN99
.
            PACK      KEY8,TADMN,SP70
            CALL      RDMISS1
            BRANCH    OVRCD,UPDTRN99
.
.         If claim type changed, update patmi1af
.
            MATCH     Z70,TRNTOCLM
            IF        !@EQUAL
              MOVE      TRNTOCLM,ACLAIM
              CALL      UPMISS1
              CALL      CHGNZ000
              MATCH     Z70,TRNTOFNS
              IF        !@EQUAL
                MOVE      TRNTOFNS,PMVXFSRC
                CALL      UPPMVX11
              ENDIF
              CALL       CPRA0000             * Check PRFA
            ENDIF
.
.         If patient type changed, update patmi1af
.
            MATCH     Z70,TRNTOPAT
            IF        !@EQUAL
              MOVE      TRNTOPAT,ATYPE
              CALL      UPMISS1
              CALL      CHGNZ000
            ENDIF
.
.         If doctor/unit changed, update patmi1af and patvisaf
.
            MATCH     Z70,TRNTODOC
            IF        !@EQUAL
              MOVE      TRNTODOC,ADOCTA
              MATCH     Z70,TRNTOUNT
              IF        !@EQUAL
                MOVE      TRNTOUNT,ACLSSFT
              ENDIF
              CALL      UPMISS1
              CALL      CHGNZ000
              PACK      KEY8,TADMN,SP70
              CALL      RDVISA1
              IF        OVRCD=0
                MOVE      ADOCTA,PVIDOCT
                CALL      UPVISA1
              ENDIF
            ENDIF
.
.         If team changed, update pmsvx1af
.
            MATCH     Z70,TRNTOTEM
            IF        !@EQUAL
              MOVE      TRNTOTEM,PMVXTEAM
              CALL      UPPMVX11
            ENDIF
.
.         If registrar changed, update pmsvx1af
.
            MATCH     Z70,TRNTOREG
            IF        !@EQUAL
              MOVE      TRNTOREG,PMVXEDC3
              CALL      UPPMVX11
            ENDIF
.
.         If resident changed, update pmsvx1af
.
            MATCH     Z70,TRNTORES
            IF        !@EQUAL
              MOVE      TRNTORES,PMVXEDC2
              CALL      UPPMVX11
            ENDIF
.
            PACK      KEY8,TADMN,SP70
            CALL      RDDSCH1
            IF        OVRCD=1
              CALL      CLPATDSC
            ENDIF
.
            PACK      KEY8,TADMN,SP70
            CALL      RDRESP1
            IF        OVRCD=1
              CALL       CLRRES00
            ENDIF
.
.         If state = WA, write a trigger for HMDS
.
            COMPARE   SIX,PTCNHDPS           * If not WA - exit
            GOTO      UPDTRN97 IF NOT EQUAL
.
            OPEN      PMSWTRA1,"pmswtraf"
.
            PACK      PMWTCDAT,CCC,CYY,CMM,CDD
            REP       " 0",PMWTCDAT
            MOVE      CTIMEIS,PMWTCTIM
.
            PACK      PMWTHOSP,PMVXMHOS,SP70
            PACK      PMWTVISN,TADMN,SP70
            PACK      PMWTSDAT,SP70
            PACK      PMWTMDAT,SP70
            PACK      PMWTWEBC,WBSEUID,SP70
.
            PACK      KEY19,PMWTHOSP,PMWTVISN,PMWTSDAT,SP70
            CALL      RAPMWTR1
            IF        OVRCD=1
              CALL      WRPMWTR1               * write HMDS trigger
            ENDIF
.
.         If updating a discharge transfer record, trigger an A08 message
.
UPDTRN97    CALL      PMIGTNID                 * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      FOUR,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICAC                 * send update visit details
.
          ENDIF
.
.         If not updating a discharge transfer record, F1 <> 0
.
          IF        F1 <> 1
            CALL      NDMSFL00
          ENDIF
.
          MOVE      ZERO,F1
.
          GOTO      UPDTRN99
.
UPDTRN98  MOVE      ONE,EXIT
UPDTRN99  RETURN
+
.-----------------------------------------------
. Supervisor Insert Bed Movement Records
.-----------------------------------------------
INSTRN00  PACK      KEY30,ADMISSNO,Z70
          CALL      RDSTRAN2                     * pos'n after last tran record
INSTRN20  CALL      RDPTRAN2                     * read previous record
          BRANCH    OVRCD,INSTRN40               * eof - finish
.
          MATCH     ADMISSNO,DTADMN              * same admission still ?
          GOTO      INSTRN40 IF NOT EQUAL        * no - finish
.
          MATCH     ANSA,TMOVE
          GOTO      INSTRN20 IF NOT EQUAL
.            
          GOTO      INSTRN60
.
. No admission type found for an admission 
. 
INSTRN40  CALL      CLPATTRN
.
INSTRN60  MOVE      TRNTOWRD,TWARD
          MOVE      TRNTOBED,TBED
          MOVE      INSCHDAT,TDATE
          MOVE      INSCHTIM,TTIME
          MOVE      INSMVTYP,TMOVE
          MOVE      URNUMBER,TURNO
          MOVE      ADMISSNO,TADMN
          MOVE      INSBDTYP,TRBTYP
.  
          CALL      IBACLOCK                * Get the current date
          PACK      PTTRCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTTRCDAT
          MOVE      CTIMEIS,PTTRCTIM
          MOVE      USERID,PTTRUCID
.
          CALL      WRTRAN2
.
          CALL      CLPMSCHA
.
          MOVE      ADMISSNO,PMCHADMN  
          MOVE      TDATE,PMCHTDAT
          MOVE      TTIME,PMCHTTIM
          MOVE      TWARD,PMCHTWAR
          MOVE      TBED,PMCHTBED
          MOVE      PTTRCDAT,PMCHCDAT
          MOVE      PTTRCTIM,PMCHCTIM
          MOVE      "001",PMCHCTYP
          MOVE      CHNGREAS,PMCHREAS
          PACK      PMCHOVAL,SP70,SP70
          PACK      PMCHNVAL,SP70,SP70
          MOVE      PTTRUCID,PMCHWEBC
          MOVE      PTTRCDAT,PMCHDATC
          MOVE      PTTRCTIM,PMCHTIMC
.
          CALL      WRPMCHA1
.
          MOVE      ZERO,EXIT
.
INSTRN99  RETURN
+
.-----------------------------------------------------------------------------
. If using EDWARD write trigger records to pmswadaf
.-----------------------------------------------------------------------------
EDWT0000  MATCH     SP70,PTCNNSSI           * no edward source system
          GOTO      EDWT9999 IF EQUAL
.
          MATCH     "00000000000000000000",PTCNNSSI  * no edward source system
          GOTO      EDWT9999 IF EQUAL
.
          IF        TRNSUPTY=1
            MATCH     Z70,TRNTOWRD
            IF        !@EQUAL
              MOVE      "18 ",PMAWTYPE      * Bed Movement changed/deleted
              GOTO      EDWT1000
            ENDIF
          ENDIF
.
          IF        TRNSUPTY=3
            MATCH     Z70,TRNTOPAT
            IF        !@EQUAL
              MOVE      "14 ",PMAWTYPE      * Admission Details Update
              GOTO      EDWT1000            * Admission type
            ENDIF
          ENDIF
.
          IF        TRNSUPTY=4
            MATCH     Z70,TRNTODOC
            IF        !@EQUAL
              MOVE      "19 ",PMAWTYPE      * Att Doctor on adm updated
              GOTO      EDWT1000          
            ENDIF
          ENDIF
.
          IF        TRNSUPTY=6
            MATCH     Z70,TRNTOBTY
            IF        !@EQUAL
              MOVE      "14 ",PMAWTYPE      * Admission Details Updated
              GOTO      EDWT1000            * Bed Type
            ENDIF
          ENDIF
.
          GOTO      EDWT9999
.
EDWT1000  MOVE      TADMN,PMAWVISN
          PACK      PMAWOLDV,SP70,SP70,SP70,SP70
          PACK      PMAWNEWV,SP70,SP70,SP70,SP70
.
          CALL      IBACLOCK
          PACK      PMAWCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMAWCDAT
          MOVE      "00:00:00",PMAWCTIM
          PACK      PMAWCUID,USERID
          PACK      PMAWSPAR,SP70,SP70
.
          PACK      KEY27,PMAWCDAT,PMAWCTIM,PMAWVISN,PMAWTYPE,SP70
          CALL      RAPMADW1
          IF        OVRCD=1
            CALL      WRPMADW1
          ENDIF
.
EDWT9999  RETURN
+
.-----------------------------------------------------------------------------
. Add record to ACC Audit file when patient changed to non-comp. claim
.-----------------------------------------------------------------------------
MVACCREM  MATCH     TRNTOCLM,PTTRCLTY
          IF        !@EQUAL
            MATCH     ANSW,TCINDC1
            IF        @EQUAL
              PACK      KEY8,ADMISSNO,SP70
              CALL      RDWCOM1
              BRANCH    OVRCD,MVACCR99
.
              CALL      CLACCAUD
              MATCH     WCCLMNO,Z70
              IF        !@EQUAL
                MOVE      WCCLMNO,ACAUCLMN              * Claim Number
              ENDIF
.
              CALL      IBACLOCK
              PACK      ACAUDATE,CCC,CYY,CMM,CDD        * Date
              REP       " 0",ACAUDATE
              MOVE      CTIMEIS,ACAUTIME
              MOVE      USERID,ACAUWUID                 * Web UserId
.
              MATCH     ADMISSNO,Z70
              IF        !@EQUAL
                MOVE      ADMISSNO,ACAUADMN             * Admission No
              ENDIF
.
              MOVE      "D",ACAUAUTY                    * Audit Type
              MOVE      "A",ACAUTREC                    * ACC Type of Record
.
MVACCR10      PACK      KEY54,ACAUCLMN,ACAUADMN,ACAUDATE,ACAUTIME,ACAUWUID
              CALL      RAACAUD1
              IF        OVRCD=1
                CALL      WRACAUD1
                GOTO      MVACCR99
              ELSE
                CALL      IBACLOCK                * Set new date and time and
                PACK      ACAUDATE,CCC,CYY,CMM,CDD    * try write again
                REP       " 0",ACAUDATE
                CLOCK     TIME,CTIMEIS
                PACK      ACAUTIME,CTIMEIS
                REP       " 0",ACAUTIME
                GOTO      MVACCR10
              ENDIF
            ENDIF
          ENDIF
.
MVACCR99  RETURN                   
+
.-----------------------------------------------------------------------------
.         Delete Workers comp. details                           *T0872408
.-----------------------------------------------------------------------------
.
DEWCOM00  COMPARE   ONE,PTCNHDPS           * Is it for NZ?
          GOTO      DEWCOM10 IF NOT EQUAL  * Not NZ; proceed to delete WC record
.
          MOVE      URNUMBER,CHWCURNO
          MOVE      ADMISSNO,CHWCADMN
          PROC      CHKWCCLM           * check for multiple WC claims records
          BRANCH    EXIT,DEWCOM10
.
.         Only one record with the ACC number, so we just update the
.         Claim Status to "Cancelled" instead of deleting the patwc1af record.
.
          COMPARE   ONE,FORM1            * one record found in CHKWCCLM
          IF        @EQUAL
            MOVE      ADMISSNO,KEY8
            CALL      RDPMWX11
            BRANCH    OVRCD,DEWCOM99
.
            MOVE      THREE,PMWXCSTA     * set Claim Status to "Cancelled"
            CALL      UPPMWX11
          ENDIF
.
          CALL      MVACCREM           * Add record ACC Audit file
          GOTO      DEWCOM99
.
DEWCOM10  MOVE      ADMISSNO,KEY8
          CALL      RDWCOM1
          COMPARE   ZERO,OVRCD
          IF        @EQUAL
            IF        PTCNHDPS=1
              CALL      MVACCREM           * Add record ACC Audit file
            ENDIF
            CALL      DEWCOM1
.
.           If we are sending ACC details in PV1-20, then we need to
.           trigger an A08 message for the visit to reflect that this is
.           no longer an ACC patient
.
            MATCH     "1",PTCNH7AC
            IF        @EQUAL
              CALL      PMIGTNID               * get national id for dgate write
              MOVE      NMPNUMB,PTNINMPI
              MOVE      TWENTY1,HL7TRGID
              MOVE      SP8,HL7INCLD
              PROC      DGCLICOB                 * send update O/P details
            ENDIF
          ENDIF
.
          MOVE      ADMISSNO,KEY8
          CALL      RDPMWX11
          COMPARE   ZERO,OVRCD
          CALL      DEPMWX11 IF EQUAL
.
DEWCOM99  RETURN
+
.------------------------------------------------------------------------------
.      Update Extension compensable file
.      If state = WA, movement type = A, Using Extra Comensable = Yes, write
.      TRNTOFNS to pattranf & pmsextaf
.------------------------------------------------------------------------------
UPEX0000  COMPARE   SIX,PTCNHDPS                 * Don't update if not WA
          GOTO      UPEX9999 IF NOT EQUAL
.
          MATCH     "1",PTCNXCOM                 * Using Extra Compensable?
          GOTO      UPEX9999 IF NOT EQUAL
.
          MATCH     ANSD,TMOVE                   * movement type Discharged
          GOTO      UPEX1000 IF EQUAL             
.
UPEX0050  CALL      CLPMSEXT 
          PACK      PMEXCLAM,PTTRCLTY,SP70
          PACK      KEY11,ADMISSNO,PMEXCLAM,SP70
          CALL      RDPMEXT1
          IF        OVRCD=0
            MATCH     Z70,TRNTOFNS
            IF        !@EQUAL
              PACK      PMEXFSRC,TRNTOFNS,SP70
            ENDIF
            PACK      PMEXUDAT,CCC,CYY,CMM,CDD
            REP       " 0",PMEXUDAT
            CLOCK     TIME,PMEXUTIM
            MOVE      USERID,PMEXUUID
            PACK      KEY11,ADMISSNO,PMEXCLAM,SP70
            CALL      UPPMEXT1
          ELSE
            CALL      CLPMSEXT                    * Clear file vars
            MOVE      TADMN,PMEXVISN
            MOVE      TURNO,PMEXURNO
            PACK      PMEXCLAM,PTTRCLTY,SP70
            MATCH     Z70,TRNTOFNS
            IF        !@EQUAL
              PACK      PMEXFSRC,TRNTOFNS,SP70
            ENDIF
            PACK      PMEXCDAT,CCC,CYY,CMM,CDD
            REP       " 0",PMEXCDAT
            CLOCK     TIME,PMEXCTIM
            MOVE      USERID,PMEXCUID
.
            PACK      KEY11,ADMISSNO,PMEXCLAM,SP70
            CALL      WRPMEXT1
          ENDIF
          GOTO      UPEX9999 
.
UPEX1000  PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,UPEX0050 
.
          CALL      CLPMSEXT
          PACK      KEY11,ADMISSNO,ACLAIM,SP70
          CALL      RDPMEXT1
          BRANCH    OVRCD,UPEX0050
.
          MATCH     "1",PMEXUYN1
          GOTO      UPEX0050 IF NOT EQUAL
.
          PACK      PMEXCLAM,PTTRCLTY,SP70    * update MV CL to new primary CL
          PACK      PMEXUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMEXUDAT
          CLOCK     TIME,PMEXUTIM
          MOVE      USERID,PMEXUUID
.
          CALL      UPPMEXT1                * update pmsextaf
.          
UPEX9999  RETURN
+
.------------------------------------------------------------------------------
.         For NZ, when the claim code is changed, update the patmi1af.aelig = 4
.         for resubmission
.------------------------------------------------------------------------------
NDMSFL00  COMPARE   ONE,PTCNHDPS
          GOTO      NDMSFL99 IF NOT EQUAL       * NZ
.
          MATCH     Z70,TRNTOCLM
          GOTO      NDMSFL99 IF EQUAL
.
          PACK      KEY8,TADMN,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,NDMSFL99
.
          COMPARE   ONE,AELIG               * has this record been submitted?
          GOTO      NDMSFL99 IF NOT EQUAL
.
          MATCH     TRNTOCLM,ACLAIM
          GOTO      NDMSFL99 IF EQUAL
.
          MOVE      TRNTOCLM,ACLAIM
          CALL      UPMISS1
          CALL      CHGNZ000
.
NDMSFL99  RETURN
+
.------------------------------------------------------------------------------
.         Check PRFA
.------------------------------------------------------------------------------
CPRA0000  MATCH      "1",PTCNXCOM
          GOTO       CPRA9999 IF NOT EQUAL
.
          PACK       KEY5,ANSC,ANSL,TRNTOCLM
          CALL       RDCODE1
          BRANCH     OVRCD,CPRA9999
          MOVE       TCINDC1,CLAIMTYP
.
          PACK       KEY11,ADMISSNO,TRNTOCLM,SP70
          CALL       RDPMEXT1
          IF         OVRCD=1
            MOVE       SP70,CLAIMTYP      * Default to Public/Uninsured
          ENDIF
          MOVE       ONE,ATD62FLG
          CALL       FPRA0000            * Update PRFA
          MOVE       ZERO,ATD62FLG
.
CPRA9999  RETURN
+
.------------------------------------------------------------------------------
.                   VALHCP00
.         Validates HCP active status against transfer entry date
.
.         Params  : VALDHCPC    HCP code
.                   VALDEDAT    Entry date
.
.         Returns : EXIT = 0   HCP active on entry date
.                   EXIT = 1   Invalid HCP code
.                   EXIT = 2   Invalid Web User Id
.                   EXIT = 3   HCP not active in hospital
.                   EXIT = 4   HCP not active in hospital on date specified
.------------------------------------------------------------------------------
VALHCP00  PACK      KEY10,VALDHCPC,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,VALHCP91
.
          IF        IBCNMHOS=1
            PACK      KEY10,USERID,SP70
            CALL      RDWBSE1
            BRANCH    OVRCD,VALHCP92
.
            MATCH    "1",PMHCHOSS           * is Doctor "Hospital specific"?
            IF       @EQUAL
              PACK      KEY13,WBSEHOSP,PMHCHCPC,SP70
              CALL      RDMLHCP1
              BRANCH    OVRCD,VALHCP93              * not active in hospital
.
              MOVE      MLHCSDAT,ACTVSDAT
              MOVE      MLHCEDAT,ACTVEDAT
            ELSE
              MOVE      PMHCSDAT,ACTVSDAT
              MOVE      PMHCEDAT,ACTVEDAT
            ENDIF
          ELSE
            MOVE      PMHCSDAT,ACTVSDAT
            MOVE      PMHCEDAT,ACTVEDAT
          ENDIF
.
          MATCH     ACTVSDAT,VALDEDAT
          GOTO      VALHCP94 IF LESS
.
          MATCH     SP70,ACTVEDAT
          GOTO      VALHCP90 IF EQUAL
.
          MATCH     VALDEDAT,ACTVEDAT
          GOTO      VALHCP94 IF LESS
.
VALHCP90  MOVE      ZERO,EXIT
          GOTO      VALHCP99
.
VALHCP91  MOVE      ONE,EXIT
          GOTO      VALHCP99
.
VALHCP92  MOVE      TWO,EXIT
          GOTO      VALHCP99
.
VALHCP93  MOVE      THREE,EXIT
          GOTO      VALHCP99
.
VALHCP94  MOVE      FOUR,EXIT
          GOTO      VALHCP99
.
VALHCP99  RETURN
+
.-----------------------------------------------
. Write Supervisor Update Transfer Change Audit
.-----------------------------------------------
WSTA0000  CALL      IBACLOCK                * Get the current date
          PACK      PMCHDATC,CCC,CYY,CMM,CDD
          REP       " 0",PMCHDATC
          MOVE      CTIMEIS,PMCHTIMC
          MOVE      PMCHDATC,PMCHCDAT
          MOVE      PMCHTIMC,PMCHCTIM
          PACK      PMCHWEBC,WBSEUID,SP70
.
          IF        TRNSUPTY=5 | TRNSUPTY=72
            MOVE      CHADMN,PMCHADMN       * care type change
            MOVE      CHDATE,PMCHTDAT
            MOVE      CHTIME,PMCHTTIM
            MOVE      SP70,PMCHTWAR
            MOVE      SP70,PMCHTBED
          ELSE
            MOVE      TADMN,PMCHADMN        * transfer change
            MOVE      TDATE,PMCHTDAT
            MOVE      TTIME,PMCHTTIM
            MOVE      TWARD,PMCHTWAR
            MOVE      TBED,PMCHTBED
          ENDIF
          MOVE      CHNGREAS,PMCHREAS
.
          PACK      PMCHSPAR,SP70,SP70
.
          PACK      KEY46,PMCHADMN,PMCHTDAT,PMCHTTIM,PMCHTWAR,PMCHTBED,PMCHCDAT,PMCHCTIM,SP70
          CALL      RAPMCHA1
          IF        OVRCD=1
            CALL      WRPMCHA1              * write transfer audit record
          ENDIF
.
WSTA9999  RETURN
+
.-----------------------------------------------
. Supervisor Transfer - Change Current Care Type
.-----------------------------------------------
CURCC000  PACK      KEY8,TRNRECKY[TRNCOUNT],SP70
          CALL      RDMISS1
          BRANCH    OVRCD,CURCC999
.
          MATCH     Z70,TRNTOCTY            * update care type
          GOTO      CURCC999 IF EQUAL
.
          PACK      PMCHOVAL,ACARE,SP70,SP70     * old value
          MOVE      TRNTOCTY,ACARE
          PACK      PMCHNVAL,ACARE,SP70,SP70     * new value
          MOVE      "005",PMCHCTYP               * change type
.
          CALL      UPMISS1
          CALL      CHGNZ000
.
          PACK      KEY30,AADMNO,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2                * get current tran record
          BRANCH    OVRCD,CURCC999
          MATCH     AADMNO,TADMN
          GOTO      CURCC999 IF NOT EQUAL
.
          MOVE      TADMN,CHADMN
          MOVE      TDATE,CHDATE         
          MOVE      TTIME,CHTIME         
          MOVE      TWARD,PMCHTWAR
          MOVE      TBED,PMCHTBED
.
          CALL      WSTA0000                * Write a transfer audit record
.
          MOVE      ONE,F1                  * trigger for HMDS & HL7
.
CURCC999  RETURN
+
.------------------------------------------------------------------------------
.         Theatre Requests List
.------------------------------------------------------------------------------
REQLST00  PACK      KEY18,URNUMBER,SP70
          CALL      RSBKRQ12
REQLST10  CALL      RKBKRQ12
          BRANCH    OVRCD,REQLST99
.
          MATCH     URNUMBER,BKRQURNO
          GOTO      REQLST99 IF NOT EQUAL
.
          MATCH     "0",BKRQSTAT
          GOTO      REQLST10 IF NOT EQUAL
.
          MOVE      SP70,VOLNDESC
          MOVE      SP70,MRVSXKY1
.
          MATCH     SP70,BKRQVISN
          IF        !@EQUAL & !@EOS
            PACK      KEY8,BKRQVISN,SP70
            CALL      RDMRVS1       * Gets the Unique key for the medical record
            IF        OVRCD=0
             PACK      KEY10,MRVSMKEY,SP70
              CALL      RDMRMAS2   
              IF        OVRCD=0
                MATCH     BKRQURNO,MRMAURNO  * Match U/R as might be a merged?
                IF        !@EQUAL
                  MOVE      "Incomplete Merge",VOLNDESC
                ELSE
                  MOVE      DMRMAVOL,VOLNDESC  * Set Volume
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      "Unscheduled",VSTATUS
.
          MOVE      BKRQCTYP,CLAIMCOD
          MOVE      "CL",CATEGORY
          MOVE      BKRQCTYP,CODE
          CALL      GETCOD00
          MOVE      TDESC,CLAIMCOD
.
          MOVE      SP70,VISTLOC
          MOVE      BKRQLOCN,VISTLOC
          MATCH     SP70,BKRQVISN
          IF        !@EQUAL & !@EOS
            PACK      KEY8,BKRQVISN,SP70
            CALL      RDMISS1
            IF        OVRCD=0
              IF        ASTAT=2
                PACK      VISTLOC,AWARD,SP1,SLASH,SP1,ABED
                PACK      KEY6,AWARD,SP70
                CALL      RDWARD1
                IF        OVRCD=0
                  PACK      VISTLOC,PTWDSDES,SP1,SLASH,SP1,ABED
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      BKRQRDOC,DOCFNAME
          MATCH     SP70,BKRQRDOC
          IF        !@EQUAL & !@EOS
            PACK      KEY10,BKRQRDOC,SP70 
            CALL      RDPMHCP1
            IF        OVRCD=0
              MOVE      PMHCTITL,FMTTITLE
              MOVE      PMHCGNAM,FMTGNAME
              MOVE      PMHCSNAM,FMTSNAME
              CALL      DOCNM000
            ENDIF
          ENDIF
.
          MOVE      BKRQUNIT,UNITDESC
          MOVE      "WU",CATEGORY
          MOVE      BKRQUNIT,CODE
          CALL      GETCOD00
          MOVE      TDESC,UNITDESC
.
          MOVE      "Book",VISTTYPE
.
          MOVE      SP70,VISTDAY
          UNPACK    BKRQCDAT,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
          LOAD      DAYNAM3,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
          PACK      VISTDAY,DAYNAM3,SP70
.
          MOVE      SP70,SECOPT
.
          CLEAR     HTMLLINK
          APPEND    "javascript:linkPatient('",HTMLLINK
          APPEND    URNUMBER,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    BKRQVISN,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    TEN,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    SECOPT,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    SP1,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    SP1,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    SP1,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    SP1,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    SP1,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    SP1,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    BKRQREQN,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          CLEAR     EXTVSTID
          CLEAR     CHKEXTVD
          PACK      CHKEXTVD,BKRQVISN,SP70
          PROC      CHKEID00
          MATCH     KEY20,SP70
          IF        @EQUAL
            PACK      EXTVSTID,BKRQVISN
          ELSE
            APPEND    BKRQVISN,EXTVSTID
            APPEND    SP2,EXTVSTID
            APPEND    "<span class='TextBlue'>(",EXTVSTID
            APPEND    KEY20,EXTVSTID
            APPEND    ")</span>",EXTVSTID
          ENDIF
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",EXTVSTID,"#",":
                             "#"",BKRQCDAT,BKRQCTIM,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",ZERO,"#",":
                             "#"",SP1,"#",":              * 10
                             "#"",SP1,"#",":
                             "#"",SP1,"#"," 
          MATCH     SP70,MRVSXKY1
          IF        !@EQUAL
            WRITE     HTMLFILE;"#"",VOLNDESC," +#","
          ELSE
            WRITE     HTMLFILE;"#"",VOLNDESC,"#"," 
          ENDIF
          WRITE     HTMLFILE;"#"",UNITDESC,"#",":
                             "#"",VISTDAY,"#",":
                             "#"",VISTTYPE,"#",":
                             "#"",SP1,"#",":
                             "#"",VISTLOC,"#",":
                             "#"",VSTATUS,"#",":
                             "#"",SP1,"#",":              * 20
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",CLAIMCOD,"#",": 
                             "#"",SP1,"#",":              * 30 
                             "#"",SP1,"#",":   
                             "#"",SP1,"#",":    
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":     
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":              * 40
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":              * 50
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#",":
                             "#"",SP1,"#")"

.
          GOTO      REQLST10
.
REQLST99  RETURN
.------------------------------------------------------------------------------
.         Theatre Requests List
.------------------------------------------------------------------------------
ALLREQ00  PACK      KEY18,URNUMBER,SP70
          CALL      RSBKRQ12
ALLREQ10  CALL      RKBKRQ12
          BRANCH    OVRCD,ALLREQ95
.
          MATCH     URNUMBER,BKRQURNO
          GOTO      ALLREQ95 IF NOT EQUAL
.
          MATCH     "0",BKRQSTAT
          GOTO      ALLREQ10 IF NOT EQUAL
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      ALLREQ10
          ENDIF
.
          IF        (DISNUMB%2) = 0
            WRITE     HTMLFILE;"<tr class=TableRowOdd>"
          ELSE
            WRITE     HTMLFILE;"<tr class=TableRowEven>"
          ENDIF
.
          MOVE      SP70,SECOPT
.
          MOVE     ONE,HOSPFLAG
          IF        IBCNMHOS=1
            MATCH    WBSEHOSP,BKRQHOSP
            IF       !@EQUAL
              MOVE      ZERO,HOSPFLAG
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"<td>";
          WRITE     HTMLFILE;"<img src=../images/AppointmentIcon.gif":
                             " class=ListIcon ":
                             " onclick='linkPatient(#"":
                               URNUMBER,"#",#"":
                               BKRQVISN,"#",#"":
                               TEN,"#",#"":
                               SECOPT,"#",#"":
                               SP1,"#",#"":
                               SP1,"#",#"":
                               SP1,"#",#"":
                               SP1,"#",#"":
                               SP1,"#",#"":
                               SP1,"#",#"":
                               BKRQREQN,"#",#"":
                               HOSPFLAG,"#");'>";
.
          MATCH     SP70,BKRQCDAT
          IF        !@EQUAL & !@EOS
            UNPACK    BKRQCDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP1,BKRQCTIM 
          ENDIF
          WRITE     HTMLFILE;"&nbsp;</td>";
.
          WRITE     HTMLFILE;"<td>";
          MATCH     SP70,BKRQCDAT
          IF        !@EQUAL & !@EOS
            UNPACK    BKRQCDAT,CCENT,CYEAR,CMON,CDAY
            CALL      DAYOFWEK
            LOAD      DAYNAM3,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
            WRITE     HTMLFILE;DAYNAM3;
          ENDIF
          WRITE     HTMLFILE;"&nbsp;</td>";
.
          WRITE     HTMLFILE;"<td>";
          WRITE     HTMLFILE;"&nbsp;Book";
          WRITE     HTMLFILE;"&nbsp;</td>";
.
          WRITE     HTMLFILE;"<td>";
          MOVE      BKRQUNIT,UNITDESC
          MOVE      "WU",CATEGORY
          MOVE      BKRQUNIT,CODE
          CALL      GETCOD00
          MOVE      TDESC,UNITDESC
          WRITE     HTMLFILE;UNITDESC;
          WRITE     HTMLFILE;"&nbsp;</td>";
.
          WRITE     HTMLFILE;"<td>";
          MOVE      BKRQRDOC,DOCFNAME
          MATCH     SP70,BKRQRDOC
          IF        !@EQUAL & !@EOS
            PACK      KEY10,BKRQRDOC,SP70
            CALL      RDPMHCP1
            IF        OVRCD=0
              MOVE      PMHCTITL,FMTTITLE
              MOVE      PMHCGNAM,FMTGNAME
              MOVE      PMHCSNAM,FMTSNAME
              CALL      DOCNM000
            ENDIF
          ENDIF
          WRITE     HTMLFILE;DOCFNAME;
          WRITE     HTMLFILE;"&nbsp;</td>";
.
          WRITE     HTMLFILE;"<td>";
          MOVE      SP70,VISTLOC
          MOVE      BKRQLOCN,VISTLOC
          MATCH     SP70,BKRQVISN
          IF        !@EQUAL & !@EOS
            PACK      KEY8,BKRQVISN,SP70
            CALL      RDMISS1
            IF        OVRCD=0
              IF        ASTAT=2
                PACK      VISTLOC,AWARD,SP1,SLASH,SP1,ABED
                PACK      KEY6,AWARD,SP70
                CALL      RDWARD1
                IF        OVRCD=0
                  PACK      VISTLOC,PTWDSDES,SP1,SLASH,SP1,ABED
                ENDIF
              ENDIF
            ENDIF
          ENDIF
          WRITE     HTMLFILE;VISTLOC;
          WRITE     HTMLFILE;"&nbsp;</td>";
.
          WRITE     HTMLFILE;"<td>";
          MOVE      BKRQCTYP,CLAIMCOD
          MOVE      "CL",CATEGORY
          MOVE      BKRQCTYP,CODE
          CALL      GETCOD00
          MOVE      TDESC,CLAIMCOD
          WRITE     HTMLFILE;CLAIMCOD;
          WRITE     HTMLFILE;"&nbsp;</td>";

          WRITE     HTMLFILE;"<td>";
          WRITE     HTMLFILE;"Unscheduled";
          WRITE     HTMLFILE;"&nbsp;</td>";
.
          CLEAR     EXTVSTID
          CLEAR     CHKEXTVD
          PACK      CHKEXTVD,BKRQVISN,SP70
          PROC      CHKEID00
          MATCH     KEY20,SP70
          IF        @EQUAL
            PACK      EXTVSTID,BKRQVISN
          ELSE
            APPEND    BKRQVISN,EXTVSTID
            APPEND    SP2,EXTVSTID
            APPEND    "<span class='TextBlue'>(",EXTVSTID
            APPEND    KEY20,EXTVSTID
            APPEND    ")</span>",EXTVSTID
          ENDIF
.
          WRITE     HTMLFILE;"<td>";
          WRITE     HTMLFILE;EXTVSTID;
          WRITE     HTMLFILE;"&nbsp;</td>";

          WRITE     HTMLFILE;"<td>";
          MOVE      SP70,VOLNDESC
.
          MATCH     SP70,BKRQVISN
          IF        !@EQUAL & !@EOS
            PACK      KEY8,BKRQVISN,SP70
            CALL      RDMRVS1       * Gets the Unique key for the medical record
            IF        OVRCD=0
             PACK      KEY10,MRVSMKEY,SP70
              CALL      RDMRMAS2
              IF        OVRCD=0
                MATCH     BKRQURNO,MRMAURNO  * Match U/R as might be a merged?
                IF        !@EQUAL
                  MOVE      "Incomplete Merge",VOLNDESC
                ELSE
                  MOVE      DMRMAVOL,VOLNDESC  * Set Volume
                ENDIF
              ENDIF
            ENDIF
          ENDIF
          WRITE     HTMLFILE;VOLNDESC;
          MATCH     SP70,MRVSXKY1
          IF        @EQUAL
            WRITE     HTMLFILE;"&nbsp;" 
          ELSE
            WRITE     HTMLFILE;"+"
          ENDIF
          WRITE     HTMLFILE;"</td>";
.
          WRITE     HTMLFILE;"</tr>"
.
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      ALLREQ10 IF NOT EQUAL
          MOVE      ZERO,SHOWFLAG
.
ALLREQ95  
.
ALLREQ99  RETURN
+
.*****************************************************************************
.*                              CREA0000               Called by: MAIN0000   *
.*             Create a new temporary file                                   *
.*****************************************************************************
.
CREA0000  CALL      KILL0000                     * remove existing file
.
          CLEAR     CMDLINE
          PACK      CMDLINE,ISBUILD,TEMPFILE,UKEY
          EXECUTE   CMDLINE,TASKID               * create temporary index file
.
          OPEN      OVTTEMP1,TEMPFILE            * open temp index 1
.
CREA9999  RETURN
+
.****************************************************************************
.*                              KILL0000               Called by: MAIN0000  *
.*               Close and erase the temporary file                         *
.****************************************************************************
.
KILL0000  CLOSE     OVTTEMP1                     * close file
.
          CLEAR     CMDLINE
          PACK      CMDLINE,ISERASE,TEMPFILE     * set file erase command
          EXECUTE   CMDLINE,TASKID               * erase temp file
.
KILL9999 RETURN
+
.****************************************************************************
.*                              CLER0000               Called by: MAIN0000  *
.*               Close and erase the temporary file                         *
.****************************************************************************
.
CLER0000  MOVE      SP30,KEY30
          CALL      RSTEMP1                      * position at start of file
          CALL      RKTEMP1                      * read next record
          BRANCH    OVRCD,CLER9999               * eof - finished
.
          PACK      KEY30,PVIDATE,VISTTIME,ADMISSNO,OVTCONTO,SP70
          CALL      DETEMP1                      * delete current record
          GOTO      CLER0000                     * get next record
.
CLER9999  RETURN
+
.****************************************************************************
.*                              ALLWRT00                                    *
.****************************************************************************
ALLWRT00  MOVE      "   1",OVTCONTO
          MOVE      VISTTIME,DIM10
          PACK      DIM10,DIM10,SP70
          PACK      ADMISSNO,ADMISSNO,SP70
.
ALLWRT10  PACK      KEY30,PVIDATE,DIM10,ADMISSNO,OVTCONTO,SP70
          CALL      RATEMP1
          IF        OVRCD=1
            CALL      WRTEMP1
          ELSE
            MOVE      OVTCONTO,FORM4
            ADD       ONE,FORM4
            MOVE      FORM4,OVTCONTO
            GOTO      ALLWRT10
          ENDIF
.
ALLWRT99  RETURN
.
.
+
.------------------------------------------------------------
. CHGNZ000 - Change NZ NMDS if fields have changed, and require resubmission
.------------------------------------------------------------
CHGNZ000  COMPARE   ONE,PTCNHDPS
          GOTO      CHGNZ999 IF NOT EQUAL   * NZ
.
          MOVE      ADMISSNO,KEY8           * Read in current admission
          CALL      RDMISS1
          BRANCH    OVRCD,CHGNZ999
.
          COMPARE   ONE,AELIG               * has this record been submitted?
          GOTO      CHGNZ999 IF NOT EQUAL
.
          MOVE      "4",AELIG               * update resubmit flag
          CALL      UPMISS1
.
          OPEN      PMSWTRA1,"pmswtraf"
.
          PACK      KEY19,PMVXMHOS,AADMNO,SP70
          CALL      RDPMWTR1
          IF        OVRCD<>1
            GOTO      CHGNZ999    * record is already on file to be resent
          ENDIF
.
.
          CALL      IBACLOCK                * Get the current date
          PACK      PMWTCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMWTCDAT
          MOVE      CTIMEIS,PMWTCTIM
.
          PACK      PMWTHOSP,PMVXMHOS,SP70
          PACK      PMWTVISN,AADMNO,SP70
          PACK      PMWTSDAT,SP70
          PACK      PMWTMDAT,SP70
          PACK      PMWTWEBC,WBSEUID,SP70
.
          PACK      KEY19,PMWTHOSP,PMWTVISN,PMWTSDAT,SP70
          CALL      RAPMWTR1
          IF        OVRCD=1
            CALL      WRPMWTR1
          ENDIF
.
CHGNZ999  CLOSE      PMSWTRA1
          RETURN
+
.****************************************************************************
.*        IO ROUTINES FOR TEMPORARY FILE                                    *
.****************************************************************************
.
.         Index 1
.
RSTEMP1   READ      OVTTEMP1,KEY30;;
          RETURN
.
RATEMP1   RESET     KEY30
          MOVE      ZERO,OVRCD
          READ      OVTTEMP1,KEY30;ANS
          GOTO      OVERCOND IF OVER
          RETURN
.
RDTEMP1   MOVE      ZERO,OVRCD
          READ      OVTTEMP1,KEY30;PVIDATE,VISTTIME,OUTVISTT,URNUMBER,OUTADMIS:
                                   OUTPSITE,VISTDAY,VISTTYPE,UNITCODE,DOCFNAME:
                                   VISTLOC,CLAIMCOD,VSTATUS,DOBAOUTN,VOLNDESC:
                                   UNITDESC,DPVIBILL,ADMISSNO,PTVITYPE,OVTCONTO:
                                   HOSPFLAG
          GOTO      OVERCOND IF OVER
          MOVE      DOBAOUTN,OBAOUTNO
          MOVE      DPVIBILL,PVIBILL
          RETURN
.
RKTEMP1   MOVE      ZERO,OVRCD
          READKS    OVTTEMP1;PVIDATE,VISTTIME,OUTVISTT,URNUMBER,OUTADMIS:
                             OUTPSITE,VISTDAY,VISTTYPE,UNITCODE,DOCFNAME:
                             VISTLOC,CLAIMCOD,VSTATUS,DOBAOUTN,VOLNDESC:
                             UNITDESC,DPVIBILL,ADMISSNO,PTVITYPE,OVTCONTO:
                             HOSPFLAG
          GOTO      OVERCOND IF OVER
          MOVE      DOBAOUTN,OBAOUTNO
          MOVE      DPVIBILL,PVIBILL
          RETURN
.
RPTEMP1   MOVE      ZERO,OVRCD
          READKP    OVTTEMP1;PVIDATE,VISTTIME,OUTVISTT,URNUMBER,OUTADMIS:
                             OUTPSITE,VISTDAY,VISTTYPE,UNITCODE,DOCFNAME:
                             VISTLOC,CLAIMCOD,VSTATUS,DOBAOUTN,VOLNDESC:
                             UNITDESC,DPVIBILL,ADMISSNO,PTVITYPE,OVTCONTO:
                             HOSPFLAG
          GOTO      OVERCOND IF OVER
          MOVE      DOBAOUTN,OBAOUTNO
          MOVE      DPVIBILL,PVIBILL
          RETURN
.
WRTEMP1   MOVE      OBAOUTNO,DOBAOUTN
          MOVE      PVIBILL,DPVIBILL
          WRITE     OVTTEMP1,KEY30;PVIDATE,VISTTIME,OUTVISTT,URNUMBER,OUTADMIS:
                             OUTPSITE,VISTDAY,VISTTYPE,UNITCODE,DOCFNAME:
                             VISTLOC,CLAIMCOD,VSTATUS,DOBAOUTN,VOLNDESC:
                             UNITDESC,DPVIBILL,ADMISSNO,PTVITYPE,OVTCONTO:
                             HOSPFLAG
          RETURN
.
UPTEMP1   UPDATE    OVTTEMP1;PVIDATE,VISTTIME,OUTVISTT,URNUMBER,OUTADMIS:
                             OUTPSITE,VISTDAY,VISTTYPE,UNITCODE,DOCFNAME:
                             VISTLOC,CLAIMCOD,VSTATUS,DOBAOUTN,VOLNDESC:
                             UNITDESC,DPVIBILL,ADMISSNO,PTVITYPE,OVTCONTO:
                             HOSPFLAG
          RETURN
.
DETEMP1   DELETE    OVTTEMP1,KEY30
          RETURN
+
.------------------------------------------------------------------------------
. Output all cancelled visits with cancellation reason in the status column
.------------------------------------------------------------------------------
ALLCAN00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          MATCH     "       0",URNUMBER
          GOTO      ALLCAN99 IF EQUAL
.
          COMPARE   ZERO,FILTVTYP
          GOTO      ALLCAN99 IF EQUAL
.
          MOVE      ONE,SHOWFLAG       * Show 'No more visits' message
.
          CALL      CRETMP00           * Create new temp file
          MOVE      "  1",OVTCOUNT     * Init temp file unique counter
.
.         Get all cancelled visits and write to our temp file...
.
          MOVE      ZERO,EMRVSTYP
          MOVE      ZERO,EMREVENT
          MOVE      " 3",D2            * Inpatient visits
          CALL      CANVIS00
.
          MOVE      ONE,EMRVSTYP
          MOVE      " 1",D2            * Emergency visits
          CALL      CANVIS00
          MOVE      ZERO,EMRVSTYP
.
          MOVE      ONE,EMREVENT
          MOVE      " 9",D2
          CALL      CANVIS00           * Events (Emergency)
          MOVE      ZERO,EMREVENT
.
          MOVE      "10",D2
          CALL      CANVIS00           * Allied Health (Referrals)
.
          CALL      CANOUT00           * Outpatient visits
.
          CALL      CANWAT00           * Waiting List
.
          CALL      CANTHE00           * Theatre Bookings
.
          CALL      CANBOK00           * Theatre Bookings
.
.
.         Now we loop out temp file in visit date/time order and output row
.
          PACK      KEY29,Z70
          CALL      RSTEMP2
ALLCAN10  CALL      RPTEMP2
          BRANCH    OVRCD,ALLCAN95
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      ALLCAN10
          ENDIF
.
          MOVE      DPVIBILL,PVIBILL
.
          CALL      CANROW00           * Output cancelled row details
.
          ADD       ONE,DISNUMB
          COMPARE   DISNUMB,NORECORD
          IF        @EQUAL
            MOVE      ZERO,SHOWFLAG
            GOTO      ALLCAN95
          ENDIF
.
          GOTO      ALLCAN10
.
ALLCAN95  CALL      NOMORE00           * Show no more visit message
.
          CALL      CLRTMP00           * Clear temp file
          CALL      KILTMP00           * Remove temp file
.
ALLCAN99  RETURN
+
.------------------------------------------------------------
.         Output cancelled visit row details
.------------------------------------------------------------
CANROW00  MOVE      ZERO,FORM1
          MOVE      PVITYPE,FORM1
.
.                         Emerg    Outpat   Inpat
          BRANCH    FORM1,CANROW10,CANROW20,CANROW10
          GOTO      CANROW40           * Other
.
CANROW10  CALL      VISROW00           * Inpatient, Emergency, Events
          GOTO      CANROW99
.
CANROW20  CALL      ALLROW00           * Outpatient
          GOTO      CANROW99
.
CANROW40  MATCH     "RF",VISTTYPE
          IF        @EQUAL
            CALL      VISROW00         * Allied Health (Referrals)
          ENDIF
.
          MATCH     "W/L",VISTTYPE
          IF        @EQUAL
            CALL      WATROW00         * Waiting List
          ENDIF
.
          MATCH     "Book",VISTTYPE
          GOTO      CANROW99 IF NOT EQUAL
.
          MATCH     SP70,BKRQREQN
          IF        @EQUAL
            CALL      BOKROW00         * Outpatient and Medical Bookings
          ELSE
            CALL      THEROW00         * Theatre Request Bookings
          ENDIF
.
          GOTO      CANROW99
.
CANROW99  RETURN
+
.------------------------------------------------------------
.         Output visit row details (using temp file vars)
.------------------------------------------------------------
VISROW00  MOVE      SP70,DISPDATT
          UNPACK    PVIDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          MATCH     SP70,VISTTIME
          IF        !@EQUAL
            ENDSET    DISPDATT
            APPEND    " at ",DISPDATT
            APPEND    VISTTIME,DISPDATT
            RESET     DISPDATT
          ENDIF
.
          IF        (DISNUMB%2) = 0
            MATCH     SP70,DISPCLSS
            IF        @EQUAL
              WRITE     HTMLFILE;"<tr class=TableRowOdd><td nowrap>"
            ELSE
              WRITE     HTMLFILE;"<tr class=TableRowOdd><td nowrap class=":
                                  DISPCLSS,">"
            ENDIF
          ELSE
            MATCH     SP70,DISPCLSS
            IF        @EQUAL
              WRITE     HTMLFILE;"<tr class=TableRowEven><td nowrap>"
            ELSE
              WRITE     HTMLFILE;"<tr class=TableRowEven><td nowrap class=":
                                   DISPCLSS,">"
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"<img src=../images/AppointmentIcon.gif":
                               " class=ListIcon ":
                               " onclick='linkPatient(#"":
                               URNUMBER,"#",#"":
                               DPVIBILL,"#",#"":
                               PVITYPE,"#",#"":
                               SECOPT,"#",#"":
                               "#",#"":
                               PVISITE,"#",#"":
                               AAEVFLAG,"#",#"":
                               EVNTFLAG,"#",#"":
                               EMVISITE,"#",#"":
                               "#",#"":
                               "#",#"":
                               HOSPFLAG,"#");'>":
                               DISPDATT,"</td>"
.
          CLEAR     EXTVSTID
          CLEAR     CHKEXTVD
          PACK      CHKEXTVD,DPVIBILL,SP70
          PROC      CHKEID00
          MATCH     KEY20,SP70
          IF        @EQUAL
            PACK      EXTVSTID,DPVIBILL
          ELSE
            APPEND    DPVIBILL,EXTVSTID
            APPEND    SP2,EXTVSTID
            APPEND    "<span class='TextBlue'>(",EXTVSTID
            APPEND    KEY20,EXTVSTID
            APPEND    ")</span>",EXTVSTID
          ENDIF
.
          MATCH     "0",SHOWFRMT               * Standard
          IF        @EQUAL
            MATCH     "2",DEFAULTA
            IF        !@EQUAL
              WRITE     HTMLFILE;"<td>&nbsp;",VISTDAY,"</td>";
            ENDIF
.
            CALL      THBL0000                 * Assign VISTLINK icon for Inpatient Visit with Bookings
.
            IF        PTCNHDPS=1
              MATCH     "RF",VISTTYPE
              IF        @EQUAL
                REP       " +",URNUMBER
                MOVE      DPVIBILL,DIM8
                REP       " +",DIM8
                MOVE      SECOPT,DIM1
                REP       " +",DIM1
                WRITE     HTMLFILE;"<td>&nbsp;",VISTTYPE,"<img src='../images/EditIcon.gif' ":
                                   "onmouseover='this.style.cursor=#"hand#"' ":
                                   "onClick=javascript:OpenAllRef('allweb03.pbl?":
                                   "reportno=01&template=014&urnumber=",URNUMBER:
                                   "&admissno=",DIM8,"','",DIM1,"')></td>";
                REP       "+ ",URNUMBER
                REP       "+ ",DIM8
              ELSE
                WRITE     HTMLFILE;"<td>&nbsp;",VISTLINK,"</td>";
              ENDIF
            ELSE
              WRITE     HTMLFILE;"<td>&nbsp;",VISTLINK,"</td>";
            ENDIF
.
            WRITE     HTMLFILE;"<td>&nbsp;",UNITCODE,"</td>":
                               "<td>&nbsp;",DOCFNAME,"</td>":
                               "<td>&nbsp;",VISTLOC,"</td>":
                               "<td>&nbsp;",CLAIMCOD,"</td>":
                               "<td>",VSTATUS,"</td>":
                               "<td>&nbsp;",EXTVSTID,"</td>";
.
            MATCH      "1",SHOWMEDL
            IF         @EQUAL
              MATCH      SP70,VOLNDESC
              IF         @EQUAL
                WRITE      HTMLFILE;"<td>":
                                    "<input type=checkbox name=lnkadmis":
                                    " value='",DPVIBILL,"'></td>"
              ELSE
                WRITE      HTMLFILE;"<td>&nbsp;":
                                    "<img src=../images/EditIcon.gif":
                                    " class=ListIcon":
                                    " onclick='LinkMedicalRec(#"":
                                    DPVIBILL,"#",#"",URNUMBER,"#");'>":
                                    VOLNDESC
                MATCH      SP70,MRVSXKY1
                IF         !@EQUAL
                  WRITE        HTMLFILE;"+" 
                ENDIF
                WRITE      HTMLFILE;"</td>"
              ENDIF
            ELSE
              MATCH     "2",DEFAULTA
              IF        !@EQUAL
                WRITE      HTMLFILE;"<td>&nbsp;",VOLNDESC
                MATCH      SP70,MRVSXKY1
                IF         !@EQUAL
                  WRITE        HTMLFILE;"+" 
                ENDIF
                WRITE      HTMLFILE;"</td>"
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     "1",NMDSLIST
          IF        @EQUAL
            MOVE       NMDSZERO,DIM20
            LOAD       DIM20,AELIG,NMDSONE,NMDSTWO,NMDSTHRE,NMDSFOUR,NMDSFIVE
            WRITE      HTMLFILE;"<td>&nbsp;",DIM20:
                                "</td><td>":
                                "<img src=../images/EditIcon.gif":
                                " class=ListIcon":
                                " onclick='EditNMDS(#"":
                                DPVIBILL,"#",#"",URNUMBER,"#");'></td>"
          ENDIF
.
          MATCH     "1",SHOWFRMT               * Kids
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;",VISTDAY,"</td>":
                               "<td>&nbsp;",VISTTYPE,"</td>":
                               "<td>&nbsp;",UNITDESC,"</td>":
                               "<td>&nbsp;",DOCFNAME,"</td>":
                               "<td>&nbsp;",VISTLOC,"</td>":
                               "<td>&nbsp;",CLAIMCOD,"</td>":
                               "<td>",VSTATUS,"</td>":
                               "<td>&nbsp;",EXTVSTID,"</td>"
          ENDIF
.
          MATCH     "2",SHOWFRMT               * STV
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;",VISTDAY,"</td>":
                               "<td>&nbsp;",VISTTYPE,"</td>":
                               "<td>&nbsp;",UNITDESC,"</td>":
                               "<td>&nbsp;",DOCFNAME,"</td>":
                               "<td>&nbsp;",VISTLOC,"</td>":
                               "<td>&nbsp;",CLAIMCOD,"</td>":
                               "<td>",VSTATUS,"</td>":
                               "<td>&nbsp;",EXTVSTID,"</td>";
.
            MATCH      "1",SHOWMEDL
            IF         @EQUAL
              MATCH      "10",PTVITYPE      * Can not update allied health
              IF         @EQUAL
                WRITE      HTMLFILE;"<td>&nbsp;",VOLNDESC,"</td>"
                GOTO       VISROW90
              ENDIF
.
              MATCH      SP70,VOLNDESC
              IF         @EQUAL
                WRITE      HTMLFILE;"<td>":
                                    "<input type=checkbox name=lnkadmis":
                                    " value='",DPVIBILL,"'></td>"
              ELSE
                WRITE      HTMLFILE;"<td>&nbsp;":
                                    "<img src=../images/EditIcon.gif":
                                    " class=ListIcon":
                                    " onclick='LinkMedicalRec(#"":
                                    DPVIBILL,"#",#"",URNUMBER,"#");'>":
                                    VOLNDESC,"</td>"
              ENDIF
            ELSE
              WRITE      HTMLFILE;"<td>&nbsp;",VOLNDESC,"</td>"
            ENDIF
          ENDIF
.
          MATCH     "2",DEFAULTA
          IF        @EQUAL
.                                                          * start    *I-267008
            MOVE      ALREUHC4,ALCADESC
            PACK      KEY10,ALREUHC4,SP10
            CALL      RDALCAS1              * read Case Team Description
.                                                          * end      *I-267008
            MOVE      "gb",CATEGORY
            MOVE      ALRECONT,CODE         * Contract
            CALL      GETCOD00
.
            WRITE     HTMLFILE;"<td>&nbsp;",REFTDESC,"</td>":
                               "<td>&nbsp;",ALCADESC,"</td>":
                               "<td>&nbsp;",TDESC,"</td>"
          ENDIF
.
VISROW90  MATCH     "1",SHOWCDMI
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;";
            CALL      VCDM0000                   * Visit based CDM
            WRITE     HTMLFILE;"</td>";
          ENDIF
.
          WRITE     HTMLFILE;"</tr>"
.
VISROW99  RETURN
+
.------------------------------------------------------------
.         Output Waiting List row details (using temp file vars)
.------------------------------------------------------------
WATROW00  UNPACK    PVIDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          MATCH     SP70,VISTTIME
          IF        !@EQUAL
            ENDSET    DISPDATT
            APPEND    " at ",DISPDATT
            APPEND    VISTTIME,DISPDATT
            RESET     DISPDATT
          ENDIF
.
          IF        (DISNUMB%2) = 0
            WRITE     HTMLFILE;"<tr class=TableRowOdd><td nowrap>"
          ELSE
            WRITE     HTMLFILE;"<tr class=TableRowEven><td nowrap>"
          ENDIF
.
          WRITE     HTMLFILE;"<img src=../images/AppointmentIcon.gif":
                             " class=ListIcon ":
                             " onclick='linkPatient(#"":
                               URNUMBER,"#",#"":
                               DPVIBILL,"#",#"":
                               EIGHT,"#",#"":
                               SECOPT,"#",#"":
                               CASEKEYS,"#",#"":
                               SP1,"#",#"":
                               SP1,"#",#"":
                               SP1,"#",#"":
                               SP1,"#",#"":
                               SP1,"#",#"":
                               SP1,"#",#"":
                               HOSPFLAG,"#");'>":
                               DISPDATT,"</td>"
.
          CLEAR     EXTVSTID
          CLEAR     CHKEXTVD
          PACK      CHKEXTVD,DPVIBILL,SP70
          PROC      CHKEID00
          MATCH     KEY20,SP70
          IF        @EQUAL
            PACK      EXTVSTID,DPVIBILL
          ELSE
            APPEND    DPVIBILL,EXTVSTID
            APPEND    SP2,EXTVSTID
            APPEND    "<span class='TextBlue'>(",EXTVSTID
            APPEND    KEY20,EXTVSTID
            APPEND    ")</span>",EXTVSTID
          ENDIF
.
          MATCH     "0",SHOWFRMT                 * Standard
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;",VISTDAY,"</td>":
                               "<td>&nbsp;",VISTTYPE,"</td>":
                               "<td>&nbsp;",UNITCODE,"</td>":
                               "<td>&nbsp;",DOCFNAME,"</td>":
                               "<td>&nbsp;",SP1,"</td>":
                               "<td>&nbsp;",CLAIMCOD,"</td>":
                               "<td>",VSTATUS,"</td>":
                               "<td>&nbsp;",EXTVSTID,"</td>":
                               "<td>&nbsp;",SP1,"</td>"
          ENDIF
.
          MATCH     "1",SHOWFRMT                 * Kids      
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;",VISTDAY,"</td>":
                               "<td>&nbsp;",VISTTYPE,"</td>":
                               "<td>&nbsp;",UNITDESC,"</td>":
                               "<td>&nbsp;",DOCFNAME,"</td>":
                               "<td>&nbsp;",SP1,"</td>":
                               "<td>&nbsp;",CLAIMCOD,"</td>":
                               "<td>",VSTATUS,"</td>":
                               "<td>&nbsp;",EXTVSTID,"</td>"
          ENDIF
.
          MATCH     "2",SHOWFRMT                 * STV
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;",VISTDAY,"</td>":
                               "<td>&nbsp;",VISTTYPE,"</td>":
                               "<td>&nbsp;",UNITDESC,"</td>":
                               "<td>&nbsp;",DOCFNAME,"</td>":
                               "<td>&nbsp;",SP1,"</td>":
                               "<td>&nbsp;",CLAIMCOD,"</td>":
                               "<td>",VSTATUS,"</td>":
                               "<td>&nbsp;",EXTVSTID,"</td>":
                               "<td>&nbsp;",SP1,"</td>"
          ENDIF
.
          MATCH     "1",SHOWCDMI
          IF        @EQUAL
            WRITE      HTMLFILE;"<td>&nbsp;</td>"
          ENDIF
.
          WRITE     HTMLFILE;"</tr>"
.
WATROW99  RETURN
+
.------------------------------------------------------------
.         Output Outpatient Booking row details (using temp file vars)
.------------------------------------------------------------
BOKROW00  UNPACK    PVIDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          MATCH     SP70,VISTTIME
          IF        !@EQUAL
            ENDSET    DISPDATT
            APPEND    " at ",DISPDATT
            APPEND    VISTTIME,DISPDATT
            RESET     DISPDATT
          ENDIF
.
          IF        (DISNUMB%2) = 0
            WRITE     HTMLFILE;"<tr class=TableRowOdd><td nowrap>"
          ELSE
            WRITE     HTMLFILE;"<tr class=TableRowEven><td nowrap>"
          ENDIF
.
          WRITE     HTMLFILE;"<img src=../images/AppointmentIcon.gif":
                             " class=ListIcon ":
                             " onclick='linkPatient(#"":
                               URNUMBER,"#",#"":
                               DPVIBILL,"#",#"":
                               SEVEN,"#",#"":
                               SECOPT,"#",#"":
                               CASEKEYS,"#",#"":
                               SP1,"#",#"":
                               SP1,"#",#"":
                               SP1,"#",#"":
                               SP1,"#",#"":
                               SP1,"#",#"":
                               SP1,"#",#"":
                               HOSPFLAG,"#");'>":
                               DISPDATT,"</td>"
.
          CLEAR     EXTVSTID
          CLEAR     CHKEXTVD
          PACK      CHKEXTVD,DPVIBILL,SP70
          PROC      CHKEID00
          MATCH     KEY20,SP70
          IF        @EQUAL
            PACK      EXTVSTID,DPVIBILL
          ELSE
            APPEND    DPVIBILL,EXTVSTID
            APPEND    SP2,EXTVSTID
            APPEND    "<span class='TextBlue'>(",EXTVSTID
            APPEND    KEY20,EXTVSTID
            APPEND    ")</span>",EXTVSTID
          ENDIF
.
          MATCH     "0",SHOWFRMT                 * Standard
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;",VISTDAY,"</td>":
                               "<td>&nbsp;",VISTTYPE,"</td>":
                               "<td>&nbsp;",UNITCODE,"</td>":
                               "<td>&nbsp;",DOCFNAME,"</td>":
                               "<td>&nbsp;",VISTLOC,"</td>":
                               "<td>&nbsp;",CLAIMCOD,"</td>":
                               "<td>",VSTATUS,"</td>":
                               "<td>&nbsp;",EXTVSTID,"</td>";
.
            MATCH      "1",SHOWMEDL
            IF         @EQUAL
              MATCH      SP70,VOLNDESC
              IF         @EQUAL
                WRITE      HTMLFILE;"<td>":
                                    "<input type=checkbox name=lnkadmis":
                                    " value='",DPVIBILL,"'></td>"
              ELSE
                WRITE      HTMLFILE;"<td>&nbsp;":
                                    "<img src=../images/EditIcon.gif":
                                    " class=ListIcon":  
                                    " onclick='LinkMedicalRec(#"":
                                    DPVIBILL,"#",#"",URNUMBER,"#");'>":
                                    VOLNDESC," "
                MATCH        SP70,MRVSXKY1
                IF           @EQUAL
                  WRITE        HTMLFILE;"</td>"
                ELSE
                  WRITE        HTMLFILE;"+ </td>"
                ENDIF
              ENDIF
            ELSE    
              WRITE      HTMLFILE;"<td>&nbsp;",VOLNDESC," "
              MATCH      SP70,MRVSXKY1
              IF         @EQUAL
                WRITE      HTMLFILE;"</td>"
              ELSE
                WRITE      HTMLFILE;"+ </td>"
              ENDIF
            ENDIF 
          ENDIF
.
          MATCH     "1",SHOWFRMT                 * Kids      
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;",VISTDAY,"</td>":
                               "<td>&nbsp;",VISTTYPE,"</td>":
                               "<td>&nbsp;",UNITDESC,"</td>":
                               "<td>&nbsp;",DOCFNAME,"</td>":
                               "<td>&nbsp;",VISTLOC,"</td>":
                               "<td>&nbsp;",CLAIMCOD,"</td>":
                               "<td>",VSTATUS,"</td>":
                               "<td>&nbsp;",EXTVSTID,"</td>"
          ENDIF
.
          MATCH     "2",SHOWFRMT                 * STV
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;",VISTDAY,"</td>":
                               "<td>&nbsp;",VISTTYPE,"</td>":
                               "<td>&nbsp;",UNITDESC,"</td>":
                               "<td>&nbsp;",DOCFNAME,"</td>":
                               "<td>&nbsp;",SP1,"</td>":
                               "<td>&nbsp;",CLAIMCOD,"</td>":
                               "<td>",VSTATUS,"</td>":
                               "<td>&nbsp;",EXTVSTID,"</td>";
.
            MATCH      "1",SHOWMEDL
            IF         @EQUAL
              MATCH      SP70,VOLNDESC
              IF         @EQUAL
                WRITE      HTMLFILE;"<td>":
                                    "<input type=checkbox name=lnkadmis":
                                    " value='",DPVIBILL,"'></td>"
              ELSE
                WRITE      HTMLFILE;"<td>&nbsp;":
                                    "<img src=../images/EditIcon.gif":
                                    " class=ListIcon":  
                                    " onclick='LinkMedicalRec(#"":
                                    DPVIBILL,"#",#"",URNUMBER,"#");'>":
                                    VOLNDESC
                MATCH      SP70,MRVSXKY1
                IF         !@EQUAL
                  WRITE      HTMLFILE;"+"
                ENDIF
                WRITE      HTMLFILE;"</td>"
              ENDIF
            ELSE    
              WRITE      HTMLFILE;"<td>&nbsp;",VOLNDESC
              MATCH      SP70,MRVSXKY1
              IF         !@EQUAL
                WRITE      HTMLFILE;"+"
              ENDIF
              WRITE      HTMLFILE;"</td>"
            ENDIF 
          ENDIF
.
          MATCH     "1",SHOWCDMI
          IF        @EQUAL
            WRITE      HTMLFILE;"<td>&nbsp;</td>"
          ENDIF
.
          WRITE     HTMLFILE;"</tr>"
.
BOKROW99  RETURN
+
.------------------------------------------------------------
.         Output Theatre Booking row details (using temp file vars)
.------------------------------------------------------------
THEROW00  UNPACK    PVIDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          MATCH     SP70,VISTTIME
          IF        !@EQUAL
            ENDSET    DISPDATT
            APPEND    " at ",DISPDATT
            APPEND    VISTTIME,DISPDATT
            RESET     DISPDATT
          ENDIF
.
          IF        (DISNUMB%2) = 0
            WRITE     HTMLFILE;"<tr class=TableRowOdd>"
          ELSE
            WRITE     HTMLFILE;"<tr class=TableRowEven>"
          ENDIF
.
          MOVE      SP70,SECOPT
.
          WRITE     HTMLFILE;"<td>";
          WRITE     HTMLFILE;"<img src=../images/AppointmentIcon.gif":
                             " class=ListIcon ":
                             " onclick='linkPatient(#"":
                               URNUMBER,"#",#"":
                               BKRQVISN,"#",#"":
                               TEN,"#",#"":
                               SECOPT,"#",#"":
                               SP1,"#",#"":
                               SP1,"#",#"":
                               SP1,"#",#"":
                               SP1,"#",#"":
                               SP1,"#",#"":
                               SP1,"#",#"":
                               BKRQREQN,"#",#"":
                               HOSPFLAG,"#");'>":
                               DISPDATT,"</td>"
.
          CLEAR     EXTVSTID
          CLEAR     CHKEXTVD
          PACK      CHKEXTVD,BKRQVISN,SP70
          PROC      CHKEID00
          MATCH     KEY20,SP70
          IF        @EQUAL
            PACK      EXTVSTID,BKRQVISN
          ELSE
            APPEND    BKRQVISN,EXTVSTID
            APPEND    SP2,EXTVSTID
            APPEND    "<span class='TextBlue'>(",EXTVSTID
            APPEND    KEY20,EXTVSTID
            APPEND    ")</span>",EXTVSTID
          ENDIF
.
          MATCH     "0",SHOWFRMT                 * Standard
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;",VISTDAY,"</td>":
                               "<td>&nbsp;",VISTTYPE,"</td>":
                               "<td>&nbsp;",UNITCODE,"</td>":
                               "<td>&nbsp;",DOCFNAME,"</td>":
                               "<td>&nbsp;",VISTLOC,"</td>":
                               "<td>&nbsp;",CLAIMCOD,"</td>":
                               "<td>",VSTATUS,"</td>":
                               "<td>&nbsp;",EXTVSTID,"</td>";
.
            MATCH      "1",SHOWMEDL
            IF         @EQUAL
              MATCH      SP70,VOLNDESC
              IF         @EQUAL
                WRITE      HTMLFILE;"<td>":
                                    "<input type=checkbox name=lnkadmis":
                                    " value='",BKRQVISN,"'></td>"
              ELSE
                WRITE      HTMLFILE;"<td>&nbsp;":
                                    "<img src=../images/EditIcon.gif":
                                    " class=ListIcon":  
                                    " onclick='LinkMedicalRec(#"":
                                    BKRQVISN,"#",#"",URNUMBER,"#");'>":
                                    VOLNDESC
                MATCH      SP70,MRVSXKY1
                IF         !@EQUAL
                  WRITE      HTMLFILE;"+"
                ENDIF
                WRITE      HTMLFILE;"</td>"
              ENDIF
            ELSE    
              WRITE      HTMLFILE;"<td>&nbsp;",VOLNDESC,"</td>"
              MATCH      SP70,MRVSXKY1
              IF         !@EQUAL
                WRITE      HTMLFILE;"+"
              ENDIF
              WRITE      HTMLFILE;"</td>"
            ENDIF 
          ENDIF
.
          MATCH     "1",SHOWCDMI
          IF        @EQUAL
            WRITE      HTMLFILE;"<td>&nbsp;</td>"
          ENDIF
.
          WRITE     HTMLFILE;"</tr>"
.
THEROW99  RETURN
+
.------------------------------------------------------------------------------
.         Get all cancelled visits (Inpatient, Emergency or Outpatient Events).
.         Write each record to our temp file.
.------------------------------------------------------------------------------
CANVIS00  MOVE      SP70,DPVIBILL
          MOVE      ZERO,PVITYPE
          MOVE      SP70,PTVITYPE
          MOVE      SP70,VISTTIME
          MOVE      ZEROVISN,OBAOUTNO
          MOVE      SP70,DOBAOUTN
          MOVE      SP70,BKRQVISN
          MOVE      SP70,BKRQREQN
.
          PACK      KEY26,URNUMBER,D2,Z70
.
          CALL      RDSVISA4
CANVIS10  CALL      RDPVISA4
          BRANCH    OVRCD,CANVIS95
.
          MATCH     URNUMBER,PVIURNO
          GOTO      CANVIS95 IF NOT EQUAL
.
          MOVE      SP70,DOCINDIC
.
          MATCH     D2,PTVITYPE
          GOTO      CANVIS10 IF NOT EQUAL
.
          PACK      KEY8,PVIBILL,SP70
          CALL      RDPMVX11
          IF        OVRCD=1
            IF        ARCFLAG=1
              MOVE      PVIBILL,KEY8
              CALL      RDARVX11
              IF        OVRCD<>1
                CALL      MVPMAR00
              ENDIF
            ENDIF
          ENDIF
          BRANCH    OVRCD,CANVIS10
.
          MOVE     ONE,HOSPFLAG
          IF        IBCNMHOS=1
            MATCH     SP70,FILTHOSP
            IF        !@EQUAL
              MATCH     FILTHOSP,PMVXMHOS
              GOTO      CANVIS10 IF NOT EQUAL
            ELSE
              PACK      KEY13,USERID,SP70              * All hospital access
              CALL      RDMLSEC1
              IF        OVRCD=1
                PACK      KEY13,USERID,PMVXMHOS,SP70   * This hospital access
                CALL      RDMLSEC1
                BRANCH    OVRCD,CANVIS10
              ENDIF
            ENDIF
            MATCH    WBSEHOSP,PMVXMHOS
            IF       !@EQUAL
              MOVE      ZERO,HOSPFLAG
            ENDIF
          ENDIF
.
          CALL      CLTMPV00                * Clear temp vars
.
          IF        EMREVENT=1
            MATCH     " 9",PTVITYPE
            GOTO      CANVIS95 IF NOT EQUAL
            MATCH     " 1",PVISYST
            GOTO      CANVIS95 IF NOT EQUAL
            PACK      KEY8,PVIBILL
            CALL      RDPMEVT1              * Get Event details
            BRANCH    OVRCD,CANVIS95
.
            MOVE      "EV",CATEGORY
            MOVE      PMEVEVNT,CODE
            CALL      GETCOD00
            MATCH     "E",TCINDC1           * Emergency events
            GOTO      CANVIS95 IF NOT EQUAL
            GOTO      CANVIS25
          ENDIF
.
.                           Emerg    Outpat   Inpat
CANVIS20  BRANCH    PVITYPE,CANVIS21,CANVIS10,CANVIS22
          GOTO      CANVIS23                * Other (Event or Allied Health)
.
CANVIS21  MOVE      PVIBILL,KEY8
          CALL      RDEMVIS1
          BRANCH    OVRCD,CANVIS10
.
          MATCH     "4",DEMVISTA            * Cancelled Emergency visit?
          GOTO      CANVIS10 IF NOT EQUAL
          GOTO      CANVIS30
.
CANVIS22  MOVE      PVIBILL,KEY8
          CALL      RDMISS1                 * Admission record found?
          BRANCH    OVRCD,CANVIS10
.
          MATCH     "5",DASTAT              * Cancelled Inpatient?
          GOTO      CANVIS10 IF NOT EQUAL
          GOTO      CANVIS30
.
CANVIS23  MATCH     "10",PTVITYPE           * Allied Health?
          GOTO      CANVIS24 IF NOT EQUAL
.
          MATCH     " 2",PVISYST            * Allied Health Visit Type?
          GOTO      CANVIS24 IF NOT EQUAL
.
          MOVE      PVIBILL,KEY8
          CALL      RDALREF1
          BRANCH    OVRCD,CANVIS10
.
          MATCH     "4",ALRESTAT            * Cancelled Referral?
          GOTO      CANVIS10 IF NOT EQUAL   * skip if not         
          GOTO      CANVIS30
.
.
CANVIS24  PACK      KEY8,PVIBILL
          CALL      RDPMEVT1                * Read Event details
          BRANCH    OVRCD,CANVIS30
.
CANVIS25  MATCH     "2",PMEVASTT            * Cancelled Event?
          GOTO      CANVIS10 IF NOT EQUAL
.
          MOVE      "EV",CATEGORY
          MOVE      PMEVEVNT,CODE
          CALL      GETCOD00
.
          MATCH     "E",TCINDC1             * Emergency event
          GOTO      CANVIS26 IF EQUAL
.
          MATCH     "I",TCINDC1             * Inpatient event
          IF        @EQUAL
            PACK      VISTLOC,PMEVPWRD,SLASH,PMEVPBED,SP70
            IF        IBCNMHOS=1
              PACK      VISTLOC,PMVXMHOS,DASH,PMEVPWRD,SLASH,PMEVPBED,SP70
            ENDIF
            MOVE      PMEVCCOD,CLAIMCOD
            GOTO      CANVIS30
          ENDIF
.
CANVIS26  MOVE      PMEVATIM,VISTTIME
          MOVE      PMEVCCOD,CLAIMCOD
          MOVE      PMEVCTYP,UNITCODE
.
.         Get Outpatient Clinic details if applicable
.
          MATCH     SP70,PMEVCTYP      * Clinic Type?
          GOTO      CANVIS30 IF EQUAL
.
          PACK      KEY12,PMEVSITE,PMEVCTYP,SP70
          CALL      RDCTYA1
          BRANCH    OVRCD,CANVIS30
.
          MOVE      OCTDESC,UNITDESC
          MOVE      PMEVCTYP,UNITCODE
.
CANVIS30  CALL      GETVIS00           * Get Visit Details
          BRANCH    EXIT,CANVIS10
.
          CALL      CKAL0000           * Check Allied Health (Outpat Event)
          BRANCH    EXIT,CANVIS10      * skip; different AH department
.
          CALL      MRTDES00           * Medical Record Location Details
.
          CALL      CANRES00           * Get cancel reason
.
          CALL      TMPWRT00           * Write to temp file
.
          GOTO      CANVIS10
.
CANVIS95  COMPARE   ONE,EMRVSTYP
          GOTO      CANVIS99 IF EQUAL
.
CANVIS99  RETURN
+
.------------------------------------------------------------------------------
.         Get all cancelled Outpatient visits.
.         Write each record to our temp file.
.------------------------------------------------------------------------------
CANOUT00  MOVE      SP70,DPVIBILL
          MOVE      ZERO,PVITYPE
          MOVE      SP70,PTVITYPE
          MOVE      SP70,VISTTIME
          MOVE      SP70,DOBAOUTN
          MOVE      SP70,BKRQVISN
          MOVE      SP70,BKRQREQN
.
          PACK      VISTTYPE,VISTOUTP
.
          PACK      KEY24,URNUMBER,Z70
          CALL      RSOTCAN2
CANOUT10  CALL      RPOTCAN2
          BRANCH    OVRCD,CANOUT99
.
          MATCH     URNUMBER,OPCNURNO
          GOTO      CANOUT99 IF NOT EQUAL
.
          CALL      CCTY0000                   * Get clinic type description
.
          MOVE     ONE,HOSPFLAG
          IF        IBCNMHOS=1
            MATCH     SP70,FILTHOSP
            IF        !@EQUAL
              MATCH     FILTHOSP,OTHEHOSP
              GOTO      CANOUT10 IF NOT EQUAL
            ELSE
              PACK      KEY13,USERID,SP70              * All hospital access
              CALL      RDMLSEC1
              IF        OVRCD=1
                PACK      KEY13,USERID,OTHEHOSP,SP70   * This hospital access
                CALL      RDMLSEC1
                BRANCH    OVRCD,CANOUT10
              ENDIF
            ENDIF
            MATCH    WBSEHOSP,OTHEHOSP
            IF       !@EQUAL
              MOVE      ZERO,HOSPFLAG
            ENDIF
          ENDIF
.
          CALL      CLTMPV00                * Clear temp vars
.
          PACK      VISTLOC,OTMALTYP,SP70
.
          MOVE      "CT",CATEGORY
          MOVE      OTMALTYP,CODE
          CALL      GETCOD00
          MATCH     SP70,TDESC
          IF        !@EQUAL
            PACK      VISTLOC,TDESC,SP70
          ENDIF
.
          COMPARE   ONE,IBCNMHOS
          IF        @EQUAL
            PACK      KEY3,OTHEHOSP
            CALL      FHOS0000
            PACK      VISTLOC,HOSPTEXT,DASH,OTMALTYP,SP70
.
            MOVE      "CT",CATEGORY
            MOVE      OTMALTYP,CODE
            CALL      GETCOD00
            MATCH     SP70,TDESC
            IF        !@EQUAL
              PACK      VISTLOC,HOSPTEXT,DASH,TDESC,SP70
            ENDIF
.
          ENDIF
.
          PACK      KEY36,DOPCNOUT,OPCNDATE,OPCNSTRT,DOPCNSLO,OPCNSITE,OPCNCLIN
          CALL      RDBOKA3
          BRANCH    OVRCD,CANOUT30
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,CANOUT20
.
          PACK      KEY12,OBASITE,OBACTYP,SP70
          CALL      RDCTYA1
          IF        OVRCD = 0
            MOVE     OCTDESC,UNITDESC
            MOVE     OBACTYP,UNITCODE
          ENDIF
.
CANOUT20  MATCH     OBAURNO,URNUMBER
          GOTO      CANOUT10 IF EQUAL
.
CANOUT30  MOVE      OPCNDATE,PVIDATE
          MOVE      OPCNOUTN,PVIBILL
          MOVE      "2",PVITYPE
          MOVE      " 2",PTVITYPE
          MOVE      OPCNTIME,VISTTIME
          MOVE      DOPCNOUT,SLOTNUMB
.
.         Get cancellation reason (outcanaf)
.
          MOVE      SP70,VSTATUS
          CLEAR     VSTATUS
          APPEND    ALLSTAT4,VSTATUS        * "Cancelled - "
          APPEND    SP1,VSTATUS
          APPEND    DASH,VSTATUS
          APPEND    SP1,VSTATUS
.
          MOVE      OPCNOUTN,KEY8
          CALL      RDOTCAN1
          BRANCH    OVRCD,CANOUT31
.
          MOVE      "CB",KEY2
          PACK      KEY5,KEY2,OPCNREAS
          CALL      RDCODE1
          BRANCH    OVRCD,CANOUT31
.
          APPEND    TDESC,VSTATUS
.
CANOUT31  RESET     VSTATUS
          MATCH     SP70,OPCNCLIN
          GOTO      CANOUT60 IF EQUAL
.
          PACK      KEY20,OPCNSITE,OPCNCLIN,OPCNDATE,SP70
          CALL      RDCLIA1
          IF        OVRCD = 0
            GOTO      CANOUT40
          ENDIF
.
          PACK      KEY20,OPCNSITE,OPCNCLIN,OPCNDATE,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          BRANCH    OVRCD,CANOUT50
.
          MATCH     OPCNSITE,OCASITE
          GOTO      CANOUT50 IF NOT EQUAL
.
          MATCH     OPCNCLIN,OCACLIN
          GOTO      CANOUT50 IF NOT EQUAL
.
CANOUT40  MOVE      OCADESC,DOCFNAME     * If no Doctor Use Clinic Name
          MATCH     SP6,OCADOCT
          GOTO      CANOUT60 IF EQUAL
          MOVE      OCADOCT,OPCNCLIN     * Use the doctor's code from the clinic
.
          MOVE      OCADOCT,KEY6
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000
          ENDIF
.
          CALL      FRMD0000
.
          GOTO      CANOUT60
.
CANOUT50  CLEAR     DOCFNAME
          APPEND    "Invalid Clinic - ",DOCFNAME
          APPEND    PVIDOCT,DOCFNAME
          RESET     DOCFNAME
.
CANOUT60  MOVE      OPCNOUTN,OBAOUTNO
          MOVE      OPCNURNO,OBAURNO
          MOVE      OPCNSLOT,OBASLOT
          REP       " 0",PVIDATE
          MOVE      SP70,DESCDOCM
          MOVE      SP70,DESCHOME
          MOVE      SP70,VOLNDESC
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDMRVS1       * Gets the Unique key for the medical record
          BRANCH    OVRCD,CANOUT70
.
          PACK      KEY10,MRVSMKEY,SP70
          CALL      RDMRMAS2      * reads the MRT master file for associated rec
          BRANCH    OVRCD,CANOUT70
.
          MATCH     OBAURNO,MRMAURNO  * Match U/R as might be a merged?
          IF        !@EQUAL
            MOVE      "Incomplete Merge",VOLNDESC
            GOTO      CANOUT70
          ENDIF
.
          MOVE      DMRMAVOL,VOLNDESC  * Set Volume
.
          MOVE      "TY",KEY2
          PACK      KEY5,KEY2,MRMADOTY
          CALL      RDCODE1
          BRANCH    OVRCD,CANOUT70
          MOVE      TDESC,DESCDOCM
.
          PACK      KEY7,MRMAHHOS,MRMAHLOC,SP10                       *C-240724
          CALL      RDMRLOC1
          BRANCH    OVRCD,CANOUT70
          MOVE      MRLODESC,DESCHOME
.
CANOUT70  MOVE      FOUR,OUTVISTT
          MOVE      DOPCNOUT,OUTADMIS
          MOVE      OPCNSITE,OUTPSITE
.
          CALL      TMPWRT00           * Write to temp file
.
          GOTO      CANOUT10

CANOUT99  RETURN
+
.------------------------------------------------------------------------------
.         Get all cancelled Waiting List visits.
.         Write each record to our temp file.
.------------------------------------------------------------------------------
CANWAT00  MOVE      SP70,DPVIBILL
          MOVE      ZERO,PVITYPE
          MOVE      SP70,PTVITYPE
          MOVE      SP70,VISTTIME
          MOVE      SP70,DOBAOUTN
          MOVE      SP70,BKRQVISN
          MOVE      SP70,BKRQREQN
.
          MOVE      SP70,VISTLOC
          MOVE      SP70,DTYPDESC
          MOVE      SP70,UNITCODE
          MOVE      SP70,UNITDESC
          MOVE      SP70,CTYPDESC
          MOVE      SP70,CLAIMCOD
          MOVE      SP70,VISADIAG
          MOVE      SP70,ADIADESC
          MOVE      SP70,VISTTYPE
          MOVE      SP70,VSTATUS
.
          PACK      KEY27,URNUMBER,Z70
          CALL      RDSTREA4
CANWAT10  CALL      RDPTREA4
          BRANCH    OVRCD,CANWAT99
.
          MATCH     URNUMBER,WMURNO      * Same U/R ?
          GOTO      CANWAT99 IF NOT EQUAL
.
          MATCH     "6",DWMSTAT             * Removed from W/L?
          GOTO      CANWAT10 IF NOT EQUAL   * skip if not removed
.
          IF        PTCNHDPS=1
            MATCH     SP70,WTWMIHSP
            IF        !@EQUAL
              MATCH     SP70,FILTHOSP
              IF        !@EQUAL
                MATCH     FILTHOSP,WTWMIHSP
                GOTO      CANWAT10 IF NOT EQUAL
              ELSE
                PACK      KEY13,USERID,SP70              * All hospital access
                CALL      RDMLSEC1
                IF        OVRCD=1
                  PACK      KEY13,USERID,WTWMIHSP,SP70   * This hospital access
                  CALL      RDMLSEC1
                  BRANCH    OVRCD,CANWAT10
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          MOVE     ONE,HOSPFLAG
          IF        IBCNMHOS=1
            MATCH    WBSEHOSP,WTWMIHSP
            IF       !@EQUAL
              MOVE      ZERO,HOSPFLAG
            ENDIF
          ENDIF
.
          CALL      CLTMPV00                * Clear temp vars
.
          PACK      KEY19,WMURNO,WMCODE,WMCNT,SP70
          CALL      RDWTTX11
          MOVE      SP70,VISTDAY
          UNPACK    WMDATE1,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
          LOAD      DAYNAM3,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
          PACK      VISTDAY,DAYNAM3,SP70
.
          PACK      CASEKEYS,WMURNO,WMCODE,DWMCNT,SP70
.
          MOVE      WMDATE1,PVIDATE
.
          MOVE      "W/L",VISTTYPE
.
          MOVE      "P ",CATEGORY
          MOVE      WTWMCLSS,CODE
          CALL      GETCOD00
          MOVE      TDESC,CTYPDESC       * Admission CLass
          MOVE      ACODE,CLAIMCOD
.
          MOVE      "WU",CATEGORY
          MOVE      WMUNIT,CODE
          CALL      GETCOD00
          MOVE      TDESC,DTYPDESC
          MOVE      CODE,UNITCODE
          MOVE      TDESC,UNITDESC
.
          MOVE      WMDOCTOR,KEY6
          CALL      RDDOCT1
          IF        OVRCD=1
            MOVE      SP70,DOCFNAME
          ELSE
            MOVE      DTITL,FMTTITLE
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000
          ENDIF
.
          MOVE      WMCODE,VISADIAG
          MOVE      WMREASON,ADIADESC
.
          MOVE      SP70,VSTATUS
          CLEAR     VSTATUS
          APPEND    ALLSTAT4,VSTATUS        * "Cancelled - "
          APPEND    SP1,VSTATUS
          APPEND    DASH,VSTATUS
          APPEND    SP1,VSTATUS
.
          MOVE      "WR",KEY2
          PACK      KEY5,KEY2,WMREMOVE
          CALL      RDCODE1
          BRANCH    OVRCD,CANWAT20
.
          APPEND    TDESC,VSTATUS
.
CANWAT20  RESET     VSTATUS
.
          MOVE      "CL",CATEGORY
          MOVE      WTTXCTYP,CODE
          MOVE      WMBOOK,DPVIBILL
          CALL      GETCOD00
          MOVE      TDESC,CTYPDESC
          MOVE      ACODE,CLAIMCOD
.
          CALL      TMPWRT00           * Write to temp file
.
          GOTO      CANWAT10
.
CANWAT99  RETURN
+
.------------------------------------------------------------------------------
.         Get all cancelled Theatre Bookings.
.         Write each record to our temp file.
.------------------------------------------------------------------------------
CANTHE00  MOVE      SP70,DPVIBILL
          MOVE      ZERO,PVITYPE
          MOVE      SP70,PTVITYPE
          MOVE      SP70,VISTTIME
          MOVE      ZEROVISN,OBAOUTNO
          MOVE      SP70,DOBAOUTN
          MOVE      SP70,BKRQVISN
          MOVE      SP70,BKRQREQN
.
          MOVE      SP70,VISTLOC
          MOVE      SP70,DTYPDESC
          MOVE      SP70,UNITCODE
          MOVE      SP70,UNITDESC
          MOVE      SP70,CTYPDESC
          MOVE      SP70,CLAIMCOD
          MOVE      SP70,VISADIAG
          MOVE      SP70,ADIADESC
          MOVE      SP70,VISTTYPE
          MOVE      SP70,VSTATUS
.
          PACK      KEY18,URNUMBER,SP70
          CALL      RSBKRQ12
CANTHE10  CALL      RKBKRQ12
          BRANCH    OVRCD,CANTHE99
.
          MATCH     URNUMBER,BKRQURNO
          GOTO      CANTHE99 IF NOT EQUAL
.
          MATCH     "2",BKRQSTAT            * Cancelled?
          GOTO      CANTHE10 IF NOT EQUAL   * skip if not
.
          CALL      CLTMPV00                * Clear temp vars
.
          MOVE      SP70,SECOPT
          MOVE      BKRQCDAT,PVIDATE
          MOVE      BKRQCTIM,VISTTIME
          MOVE      "Book",VISTTYPE
.
          MOVE      SP70,VISTDAY
          UNPACK    BKRQCDAT,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
          LOAD      DAYNAM3,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
          PACK      VISTDAY,DAYNAM3,SP70
.
          MOVE      DBKREBOO,DPVIBILL
          MOVE      BKRQUNIT,UNITDESC
          MOVE      "WU",CATEGORY
          MOVE      BKRQUNIT,CODE
          CALL      GETCOD00
          MOVE      TDESC,UNITDESC
.
          MOVE      BKRQRDOC,DOCFNAME
          MATCH     SP70,BKRQRDOC
          IF        !@EQUAL & !@EOS
            PACK      KEY10,BKRQRDOC,SP70
            CALL      RDPMHCP1
            IF        OVRCD=0
              MOVE      PMHCTITL,FMTTITLE
              MOVE      PMHCGNAM,FMTGNAME
              MOVE      PMHCSNAM,FMTSNAME
              CALL      DOCNM000
            ENDIF
          ENDIF
.
          MOVE      SP70,VISTLOC
          MOVE      BKRQLOCN,VISTLOC
          MATCH     SP70,BKRQVISN
          IF        !@EQUAL & !@EOS
            PACK      KEY8,BKRQVISN,SP70
            CALL      RDMISS1
            IF        OVRCD=0
              IF        ASTAT=2
                PACK      VISTLOC,AWARD,SP1,SLASH,SP1,ABED
                PACK      KEY6,AWARD,SP70
                CALL      RDWARD1
                IF        OVRCD=0
                  PACK      VISTLOC,PTWDSDES,SP1,SLASH,SP1,ABED
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      BKRQCTYP,CLAIMCOD
          MOVE      "CL",CATEGORY
          MOVE      BKRQCTYP,CODE
          CALL      GETCOD00
          MOVE      TDESC,CLAIMCOD
.
          MOVE      SP70,VOLNDESC
.
          MATCH     SP70,BKRQVISN
          IF        !@EQUAL & !@EOS
            PACK      KEY8,BKRQVISN,SP70
            CALL      RDMRVS1       * Gets the Unique key for the medical record
            IF        OVRCD=0
             PACK      KEY10,MRVSMKEY,SP70
              CALL      RDMRMAS2
              If        OVRCD=0
                MATCH     BKRQURNO,MRMAURNO  * Match U/R as might be a merged?
                IF        !@EQUAL
                  MOVE      "Incomplete Merge",VOLNDESC
                ELSE
                  MOVE      DMRMAVOL,VOLNDESC  * Set Volume
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          MOVE     ONE,HOSPFLAG
          IF        IBCNMHOS=1
            MATCH    WBSEHOSP,BKRQHOSP
            IF       !@EQUAL
              MOVE      ZERO,HOSPFLAG
            ENDIF
          ENDIF
.
          MOVE      SP70,VSTATUS
          CLEAR     VSTATUS
          APPEND    ALLSTAT4,VSTATUS        * "Cancelled - "
          APPEND    SP1,VSTATUS
          APPEND    DASH,VSTATUS
          APPEND    SP1,VSTATUS
.
          MOVE      "BC",KEY2
          PACK      KEY5,KEY2,BKRQCNCD
          CALL      RDCODE1
          BRANCH    OVRCD,CANTHE20
.
          APPEND    TDESC,VSTATUS
.
CANTHE20  RESET     VSTATUS
.
          CALL      TMPWRT00           * Write to temp file
.
          GOTO      CANTHE10
.
CANTHE99  RETURN
+
.------------------------------------------------------------------------------
.         Get all cancelled Outpatient Bookings.
.         Write each record to our temp file.
.------------------------------------------------------------------------------
CANBOK00  MOVE      SP70,DPVIBILL
          MOVE      ZERO,PVITYPE
          MOVE      SP70,PTVITYPE
          MOVE      SP70,VISTTIME
          MOVE      ZEROVISN,OBAOUTNO
          MOVE      SP70,DOBAOUTN
          MOVE      SP70,BKRQVISN
          MOVE      SP70,BKRQREQN
.
          MOVE      SP70,VISTLOC
          MOVE      SP70,DTYPDESC
          MOVE      SP70,UNITCODE
          MOVE      SP70,UNITDESC
          MOVE      SP70,CTYPDESC
          MOVE      SP70,CLAIMCOD
          MOVE      SP70,VISADIAG
          MOVE      SP70,ADIADESC
          MOVE      SP70,VISTTYPE
          MOVE      SP70,VSTATUS
.
          PACK      KEY16,URNUMBER,SP70
          CALL      RSBKREC6
CANBOK10  CALL      RKBKREC6
          BRANCH    OVRCD,CANBOK99
.
          MATCH     URNUMBER,BKREURNO
          GOTO      CANBOK99 IF NOT EQUAL
.
          COMPARE   TWO,BKRESTAT            * Cancelled?
          GOTO      CANBOK10 IF NOT EQUAL   * skip if not
.
          CALL      CLTMPV00                * Clear temp vars
.
          MOVE      BKREADOC,KEY6
          CALL      RDDOCT1
          IF        OVRCD=1
            MOVE      SP70,DOCFNAME
          ELSE
            MOVE      DTITL,FMTTITLE
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000
          ENDIF
.
          MOVE      SP70,PTWDHOSN
          PACK      KEY8,BKREBOOK,SP70
          CALL      RDBKRX11
          BRANCH    OVRCD,CANBOK10
.
          MATCH     SP70,BKREWARD
          IF        !@EQUAL
            PACK      KEY6,BKREWARD,SP70
          ELSE
            PACK      KEY6,BKRXPOWD,SP70
          ENDIF
.
          MATCH     SP70,KEY6
          IF        !@EQUAL
            CALL      RDWARD1
            IF        OVRCD<>1
              IF        IBCNMHOS=1
                PACK      VISTLOC,PTWDHOSN,SP70
              ENDIF
            ENDIF
          ENDIF
.
          MOVE     ONE,HOSPFLAG
          IF        IBCNMHOS=1
            MATCH     SP70,FILTHOSP
            IF        !@EQUAL
              MATCH     FILTHOSP,PTWDHOSN
              GOTO      CANBOK10 IF NOT EQUAL
            ELSE
              PACK      KEY13,USERID,SP70              * All hospital access
              CALL      RDMLSEC1
              IF        OVRCD=1
                PACK      KEY13,USERID,PTWDHOSN,SP70   * This hospital access
                CALL      RDMLSEC1
                BRANCH    OVRCD,CANBOK10
              ENDIF
            ENDIF
            MATCH    WBSEHOSP,PTWDHOSN
            IF       !@EQUAL
              MOVE      ZERO,HOSPFLAG
            ENDIF
          ENDIF
.
          MOVE      SP70,VISTDAY
          UNPACK    BKREEDAT,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
          LOAD      DAYNAM3,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
          PACK      VISTDAY,DAYNAM3,SP70
.
          MOVE      DBKREBOO,DPVIBILL
          MOVE      BKREEDAT,PVIDATE
          MOVE      BKREATIM,VISTTIME
.
          MOVE      "Book",VISTTYPE
.
          MOVE      SP70,VOLNDESC
. 
          PACK      KEY8,BKREBOOK,SP70
          CALL      RDMRVS1       * Gets the Unique key for the medical record
          BRANCH    OVRCD,CANBOK20
. 
          PACK      KEY10,MRVSMKEY,SP70
          CALL      RDMRMAS2      * reads the MRT master file for associated rec
          BRANCH    OVRCD,CANBOK20
. 
          MATCH     PVIURNO,MRMAURNO  * Match U/R as might be a merged?
          IF        !@EQUAL
            MOVE      SP70,VOLNDESC
            MOVE      "Incomplete Merge",VOLNDESC
            GOTO      CANBOK20
          ENDIF
. 
          MOVE      DMRMAVOL,VOLNDESC  * Set Volume
. 
CANBOK20  MOVE      "CL",CATEGORY
          MOVE      BKRECLMT,CODE
          CALL      GETCOD00
          MOVE      ACODE,CLAIMCOD
.
          MOVE      "AC",CATEGORY
          MOVE      BKREDEPT,CODE
          CALL      GETCOD00
          MOVE      TDESC,UNITDESC
          MOVE      CODE,UNITCODE
.
.         Get cancelled reason...
.
          MOVE      SP70,VSTATUS
          CLEAR     VSTATUS
          APPEND    ALLSTAT4,VSTATUS        * "Cancelled - "
          APPEND    SP1,VSTATUS
          APPEND    DASH,VSTATUS
          APPEND    SP1,VSTATUS
.
          MOVE      "BC",KEY2
          PACK      KEY5,KEY2,BKRECANC
          CALL      RDCODE1
          BRANCH    OVRCD,CANBOK30
.
          APPEND    TDESC,VSTATUS
.
CANBOK30  RESET     VSTATUS
.
          CALL      TMPWRT00           * Write to temp file
.
          GOTO      CANBOK10
.
CANBOK99  RETURN
+
.------------------------------------------------------------------------------
.         Get the cancellation reason and assign to VSTATUS
.------------------------------------------------------------------------------
CANRES00  PACK      VSTATUS,SP70
          CLEAR     VSTATUS
          APPEND    ALLSTAT4,VSTATUS   * Cancelled
          APPEND    SP1,VSTATUS
          APPEND    DASH,VSTATUS
          APPEND    SP1,VSTATUS
.
.                           Emerg    Outpat   Inpat
          BRANCH    PVITYPE,CANRES10,CANRES20,CANRES30
          GOTO      CANRES40                * Other
.
CANRES10  MOVE      PVIBILL,KEY8
          CALL      RDEMDA1
          BRANCH    OVRCD,CANRES90
.
          MOVE      "EC",KEY2
          PACK      KEY5,KEY2,EMDARECD
          CALL      RDCODE1
          BRANCH    OVRCD,CANRES90
.
          APPEND    TDESC,VSTATUS
          GOTO      CANRES90
.
CANRES20            
          GOTO      CANRES90
.
CANRES30  MOVE      "PC",KEY2               * Pre-adm cancel reason
          PACK      KEY5,KEY2,ACANCEL
          CALL      RDCODE1
          BRANCH    OVRCD,CANRES90
.
          APPEND    TDESC,VSTATUS
          GOTO      CANRES90
.
CANRES40  MATCH     "10",PTVITYPE           * Allied Health visit type
          GOTO      CANRES90 IF NOT EQUAL
.
          MATCH     " 2",PVISYST            * Allied Health Extra Visit Type
          GOTO      CANRES90 IF NOT EQUAL
.
          MOVE      PVIBILL,KEY8
          CALL      RDALREF1
          BRANCH    OVRCD,CANRES90
.
          MOVE      "LN",KEY2
          PACK      KEY5,KEY2,ALRERCAN
          CALL      RDCODE1
          BRANCH    OVRCD,CANRES90
.
          APPEND    TDESC,VSTATUS
          GOTO      CANRES90
.
CANRES90  RESET     VSTATUS
.
CANRES99  RETURN
+
.------------------------------------------------------------
. Selects Day from daily Viewtype (taken from selv0000)
.------------------------------------------------------------
SELDT000  WRITE     HTMLFILE;"<input type=button value='<<' class=SmallButton"
          WRITE     HTMLFILE;" onClick='location.href=#"";
          CALL      PREV0000
          IF        ASTAT = 1 
            WRITE     HTMLFILE;"#"' disabled tabindex=1>"
            WRITE     HTMLFILE;"<select name=lastdate id=lastdate":
                               " class=DaySelect onchange='ChangeDate();'":
                               " disabled>";
          ELSE
            WRITE     HTMLFILE;"#"' tabindex=1>"
            WRITE     HTMLFILE;"<select name=lastdate id=lastdate":
                               " class=DaySelect onchange='ChangeDate();'>";
          ENDIF
          UNPACK    FRSTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      "8",ADJDAYS
          CALL      ADJDAT00
          PACK      ENDDATE,CCENT,CYEAR,CMON,CDAY
.
          MOVE      "-7",ADJDAYS
          UNPACK    FRSTDATE,CCENT,CYEAR,CMON,CDAY
          CALL      ADJDAT00
          PACK      STRTDATE,CCENT,CYEAR,CMON,CDAY
.
SELDT100  UNPACK    STRTDATE,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
          LOAD      DAYNAM3,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          MATCH     STRTDATE,FRSTDATE
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",STRTDATE," selected>":
                               DAYNAM3,SP1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                               "</option>";
          ELSE
            WRITE     HTMLFILE;"<option value=",STRTDATE,">":
                               DAYNAM3,SP1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                               "</option>";
          ENDIF
          MOVE      "1",ADJDAYS
          CALL      ADJDAT00
          PACK      STRTDATE,CCENT,CYEAR,CMON,CDAY
          MATCH     ENDDATE,STRTDATE
          GOTO      SELDT100 IF NOT EQUAL
.
          WRITE     HTMLFILE;"</select>"
          WRITE     HTMLFILE;"<input type=button value='>>' class=SmallButton"
          WRITE     HTMLFILE;" onClick='location.href=#"";
          CALL      NEXT0000
          IF        ASTAT = 1
            WRITE     HTMLFILE;"#"' disabled tabindex=1>";
          ELSE
            WRITE     HTMLFILE;"#"' tabindex=1>";
          ENDIF
SELDT999  RETURN
+
.******************************************************************************
.*                              CRETMP00               Called by: ALLCAN00    *
.*             Create a new temporary file (cancelled visits)                 *
.******************************************************************************
.
CRETMP00  CALL      KILTMP00                     * remove existing file
.
          CLEAR     CMDLINE
          PACK      CMDLINE,ISBUILD,TEMPFIL2,UKEY2
          EXECUTE   CMDLINE,TASKID               * create temporary index file
.
          OPEN      OVTTEMP2,TEMPFIL2            * open temp index 1
.
CRETMP99  RETURN
+
.******************************************************************************
.*                              KILTMP00               Called by: ALLCAN00    *
.*               Close and erase the temporary file                           *
.******************************************************************************
.
KILTMP00  CLOSE     OVTTEMP2                     * close file
.
          CLEAR     CMDLINE
          PACK      CMDLINE,ISERASE,TEMPFIL2     * set file erase command
          EXECUTE   CMDLINE,TASKID               * erase temp file
.
KILTMP99 RETURN
+
.******************************************************************************
.*                              CLER0000               Called by: MAIN0000    *
.*               Close and erase the temporary file                           *
.******************************************************************************
.
CLRTMP00  MOVE      SP30,KEY29
          CALL      RSTEMP2                      * position at start of file
          CALL      RKTEMP2                      * read next record
          BRANCH    OVRCD,CLRTMP99               * eof - finished
.
          PACK      KEY29,PVIDATE,VISTTIME,ADMISSNO,OVTCOUNT,SP70
          CALL      DETEMP2                      * delete current record
          GOTO      CLRTMP00                     * get next record
.
CLRTMP99  RETURN
+
.******************************************************************************
.*                              TMPWRT00                                      *
.******************************************************************************
TMPWRT00  MOVE      "  1",OVTCOUNT
          MOVE      VISTTIME,DIM10
          PACK      DIM10,DIM10,SP70
          PACK      ADMISSNO,ADMISSNO,SP70
.
TMPWRT10  PACK      KEY29,PVIDATE,DIM10,ADMISSNO,OVTCOUNT,SP70
          CALL      RATEMP2
          IF        OVRCD=1
            CALL      WRTEMP2
          ELSE
            MOVE      OVTCOUNT,FORM3
            ADD       ONE,FORM3
            MOVE      FORM3,OVTCOUNT
            GOTO      TMPWRT10
          ENDIF
.
TMPWRT99  RETURN
+
.******************************************************************************
.*        Clear temp vars                                                     *
.******************************************************************************
CLTMPV00  UNPACK    SP70,VISTTIME,OUTVISTT,OUTADMIS,OUTPSITE,VISTDAY
          UNPACK    SP70,DOCFNAME
          UNPACK    SP70,VISTLOC
          UNPACK    SP70,CLAIMCOD,VSTATUS
          UNPACK    SP70,VOLNDESC,UNITDESC
          UNPACK    SP70,CASEKEYS
          MOVE      ZERO,AAEVFLAG,EVNTFLAG,EMVISITE
          MOVE      ZERO,EVNTFLAG
.
CLTMPV99  RETURN
+
.------------------------------------------------------------
. Patient IP SMS Types
.------------------------------------------------------------
ISMS0000  OPEN      PATLETR2,"patletrf"
          MOVE      ZERO,PTLELINO
          PACK      KEY6,PTLELINO,SP70
          CALL      RSPTLET2
ISMS1000  CALL      RKPTLET2
          BRANCH    OVRCD,ISMS9999
.
          COMPARE   ZERO,PTLELINO
          GOTO      ISMS9999 IF NOT EQUAL
.
          MATCH     "1",PTLEACTV                 * Skip Inactive
          GOTO      ISMS1000 IF EQUAL
.
          MATCH     "1",PTLECOMM                 * Skip if NOT a SMS Message
          GOTO      ISMS1000 IF NOT EQUAL
.
          WRITE     HTMLFILE;"<option value=",PTLELTNO,">",PTLETEXT:
                               "</option>";
          GOTO      ISMS1000
.
ISMS9999  CLOSE     PATLETR2
          RETURN
+
.------------------------------------------------------------
. Patient OP SMS Types
.------------------------------------------------------------
OSMS0000  MOVE      ZERO,OTLTLINO
          PACK      KEY6,OTLTLINO,SP70
          CALL      RSOTLET2
OSMS1000  CALL      RKOTLET2
          BRANCH    OVRCD,OSMS9999
.
          COMPARE   ZERO,OTLTLINO
          GOTO      OSMS9999 IF NOT EQUAL
.
          MATCH     "1",OTLTACTV                 * Skip Inactive
          GOTO      OSMS1000 IF EQUAL
.
          MATCH     "1",OTLTCOMM                 * Skip if NOT a SMS Message
          GOTO      OSMS1000 IF NOT EQUAL
.
          WRITE     HTMLFILE;"<option value=",OTLTLTNO,">",OTLTTEXT:
                               "</option>";
          GOTO      OSMS1000
.
OSMS9999  RETURN
+
.------------------------------------------------------------
. Patient Booking SMS Types
.------------------------------------------------------------
BKMS0000  MOVE      ZERO,BLINNO
          PACK      KEY6,BLINNO,SP70
          CALL      RDSLET2
BKMS1000  CALL      RDKLET2
          BRANCH    OVRCD,BKMS9999
.
          COMPARE   ZERO,BLINNO
          GOTO      BKMS9999 IF NOT EQUAL
.
          MATCH     "1",BLETACTV                * Skip Inactive
          GOTO      BKMS1000 IF EQUAL
.
          MATCH     "1",BLETCOMM                * Skip if NOT a SMS Message
          GOTO      BKMS1000 IF NOT EQUAL
.
          WRITE     HTMLFILE;"<option value=",BLETNO,">",BLTEXT:
                               "</option>";
          GOTO      BKMS1000
.
BKMS9999  RETURN
+
.------------------------------------------------------------
. Update ACC NUMBER acccmtaf.accmtype = "002"
.------------------------------------------------------------
UPACC200  PACK      KEY26,SAVCLMNO,ZERO,ZERO,TWO,SP70
          CALL      RSACCMT1
UPACC210  CALL      RKACCMT1
          BRANCH    OVRCD,UPACC250
.
          MATCH     SAVCLMNO,ACCMACCN
          GOTO      UPACC250 IF NOT EQUAL
.
          MATCH     "002",ACCMTYPE
          GOTO      UPACC250 IF NOT EQUAL
.
          PACK      SAVKEY26,ACCMACCN,ACCMTYPE,DACCMLIN,SP70
.
          MOVE      PTCLM011,ACCMACCN
.
          PACK      KEY26,ACCMACCN,ACCMTYPE,DACCMLIN,SP70
          CALL      RAACCMT1
          IF        OVRCD=1
            CALL      WRACCMT1
          ENDIF
.
          MOVE      SAVKEY26,KEY26
          CALL      RDACCMT1
.
          GOTO      UPACC210
.
UPACC250  PACK      KEY44,SAVCLMNO,SP70
          CALL      RDSWCOM3
          CALL      RDKWCOM3
          BRANCH    OVRCD,UPACC260
.
          MATCH     SAVCLMNO,WCCLMNO
          GOTO      UPACC299 IF EQUAL
.
UPACC260  PACK      KEY26,SAVCLMNO,ZERO,ZERO,TWO,SP70
          CALL      RSACCMT1
          CALL      RKACCMT1
          BRANCH    OVRCD,UPACC299
.
          MATCH     SAVCLMNO,ACCMACCN
          GOTO      UPACC299 IF NOT EQUAL
.
          MATCH     "002",ACCMTYPE
          GOTO      UPACC299 IF NOT EQUAL
.
          PACK      KEY26,ACCMACCN,ACCMTYPE,DACCMLIN,SP70
          CALL      DEACCMT1
.
          GOTO      UPACC260
.
UPACC299  RETURN
+
.------------------------------------------------------------
. Update ACC NUMBER accdiaaf
.------------------------------------------------------------
UPACDI00  PACK      KEY23,SAVCLMNO,SP70
          CALL      RSACDIA1
UPACDI10  CALL      RKACDIA1
          BRANCH    OVRCD,UPACDI50
.
          MATCH     SAVCLMNO,ACDIACCN
          GOTO      UPACDI50 IF NOT EQUAL
.
          PACK      SAVKEY23,ACDIACCN,ACDICONT,SP70
.
          MOVE      PTCLM011,ACDIACCN
.
          PACK      KEY23,ACDIACCN,ACDICONT,SP70
          CALL      RAACDIA1
          IF        OVRCD=1
            CALL      WRACDIA1
          ENDIF
.
          MOVE      SAVKEY23,KEY23
          CALL      RDACDIA1
.
          GOTO      UPACDI10
.
UPACDI50  PACK      KEY44,SAVCLMNO,SP70
          CALL      RDSWCOM3
          CALL      RDKWCOM3
          BRANCH    OVRCD,UPACDI60
.
          MATCH     SAVCLMNO,WCCLMNO
          GOTO      UPACDI99 IF EQUAL
.
UPACDI60  PACK      KEY23,SAVCLMNO,SP70
          CALL      RSACDIA1
          CALL      RKACDIA1
          BRANCH    OVRCD,UPACDI99
.
          MATCH     SAVCLMNO,ACDIACCN
          GOTO      UPACDI99 IF NOT EQUAL
.
          PACK      KEY23,ACDIACCN,ACDICONT,SP70
          CALL      DEACDIA1
.
          GOTO      UPACDI60
.
UPACDI99  RETURN
+
.------------------------------------------------------------
. Update ACC NUMBER accrfpaf
.------------------------------------------------------------
UPACRF00  PACK      KEY23,SAVCLMNO,SP70
          CALL      RSACRFP1
UPACRF10  CALL      RKACRFP1
          BRANCH    OVRCD,UPACRF50
.
          MATCH     SAVCLMNO,ACRFACCN
          GOTO      UPACRF50 IF NOT EQUAL
.
          PACK      SAVKEY23,ACRFACCN,ACRFCONT,SP70
.
          MOVE      PTCLM011,ACRFACCN
.
          PACK      KEY23,ACRFACCN,ACRFCONT,SP70
          CALL      RAACRFP1
          IF        OVRCD=1
            CALL      WRACRFP1
          ENDIF
.
          MOVE      SAVKEY23,KEY23
          CALL      RDACRFP1
.
          GOTO      UPACRF10
.
UPACRF50  PACK      KEY44,SAVCLMNO,SP70
          CALL      RDSWCOM3
          CALL      RDKWCOM3
          BRANCH    OVRCD,UPACRF60
.
          MATCH     SAVCLMNO,WCCLMNO
          GOTO      UPACRF99 IF EQUAL
.
UPACRF60  PACK      KEY23,SAVCLMNO,SP70
          CALL      RSACRFP1
          CALL      RKACRFP1
          BRANCH    OVRCD,UPACRF99
.
          MATCH     SAVCLMNO,ACRFACCN
          GOTO      UPACRF99 IF NOT EQUAL
.
          PACK      KEY23,ACRFACCN,ACRFCONT,SP70
          CALL      DEACRFP1
.
          GOTO      UPACRF60
.
UPACRF99  RETURN
+
.******************************************************************************
.*        IO ROUTINES FOR TEMPORARY FILE 2 (Cancelled Visists)                *
.******************************************************************************
.
.         Index 1
.
RSTEMP2   READ      OVTTEMP2,KEY29;;
          RETURN
.
RATEMP2   RESET     KEY29
          MOVE      ZERO,OVRCD
          READ      OVTTEMP2,KEY29;ANS
          GOTO      OVERCOND IF OVER
          RETURN
.
RDTEMP2   MOVE      ZERO,OVRCD
          READ      OVTTEMP2,KEY29;PVIDATE,VISTTIME,OUTVISTT,URNUMBER,OUTADMIS:
                                   OUTPSITE,VISTDAY,VISTTYPE,UNITCODE,DOCFNAME:
                                   VISTLOC,CLAIMCOD,VSTATUS,DOBAOUTN,VOLNDESC:
                                   UNITDESC,DPVIBILL,ADMISSNO,PTVITYPE,OVTCOUNT:
                                   PVITYPE,PVISITE,SECOPT,AAEVFLAG,EVNTFLAG:
                                   EMVISITE,BKRQVISN,BKRQREQN,CASEKEYS,HOSPFLAG
          GOTO      OVERCOND IF OVER
          MOVE      DOBAOUTN,OBAOUTNO
          RETURN
.
RKTEMP2   MOVE      ZERO,OVRCD
          READKS    OVTTEMP2;PVIDATE,VISTTIME,OUTVISTT,URNUMBER,OUTADMIS:
                             OUTPSITE,VISTDAY,VISTTYPE,UNITCODE,DOCFNAME:
                             VISTLOC,CLAIMCOD,VSTATUS,DOBAOUTN,VOLNDESC:
                             UNITDESC,DPVIBILL,ADMISSNO,PTVITYPE,OVTCOUNT:
                             PVITYPE,PVISITE,SECOPT,AAEVFLAG,EVNTFLAG:
                             EMVISITE,BKRQVISN,BKRQREQN,CASEKEYS,HOSPFLAG
          GOTO      OVERCOND IF OVER
          MOVE      DOBAOUTN,OBAOUTNO
          RETURN
.
RPTEMP2   MOVE      ZERO,OVRCD
          READKP    OVTTEMP2;PVIDATE,VISTTIME,OUTVISTT,URNUMBER,OUTADMIS:
                             OUTPSITE,VISTDAY,VISTTYPE,UNITCODE,DOCFNAME:
                             VISTLOC,CLAIMCOD,VSTATUS,DOBAOUTN,VOLNDESC:
                             UNITDESC,DPVIBILL,ADMISSNO,PTVITYPE,OVTCOUNT:
                             PVITYPE,PVISITE,SECOPT,AAEVFLAG,EVNTFLAG:
                             EMVISITE,BKRQVISN,BKRQREQN,CASEKEYS,HOSPFLAG
          GOTO      OVERCOND IF OVER
          MOVE      DOBAOUTN,OBAOUTNO
          RETURN
.
WRTEMP2   MOVE      OBAOUTNO,DOBAOUTN
          WRITE     OVTTEMP2,KEY29;PVIDATE,VISTTIME,OUTVISTT,URNUMBER,OUTADMIS:
                             OUTPSITE,VISTDAY,VISTTYPE,UNITCODE,DOCFNAME:
                             VISTLOC,CLAIMCOD,VSTATUS,DOBAOUTN,VOLNDESC:
                             UNITDESC,DPVIBILL,ADMISSNO,PTVITYPE,OVTCOUNT:
                             PVITYPE,PVISITE,SECOPT,AAEVFLAG,EVNTFLAG:
                             EMVISITE,BKRQVISN,BKRQREQN,CASEKEYS,HOSPFLAG
          RETURN
.
UPTEMP2   UPDATE    OVTTEMP2;PVIDATE,VISTTIME,OUTVISTT,URNUMBER,OUTADMIS:
                             OUTPSITE,VISTDAY,VISTTYPE,UNITCODE,DOCFNAME:
                             VISTLOC,CLAIMCOD,VSTATUS,DOBAOUTN,VOLNDESC:
                             UNITDESC,DPVIBILL,ADMISSNO,PTVITYPE,OVTCOUNT:
                             PVITYPE,PVISITE,SECOPT,AAEVFLAG,EVNTFLAG:
                             EMVISITE,BKRQVISN,BKRQREQN,CASEKEYS,HOSPFLAG
          RETURN
.
DETEMP2   DELETE    OVTTEMP2,KEY29
          RETURN
+
.------------------------------------------------------------
. Output Visit Table Details
.------------------------------------------------------------
FHRLST00  IF        NORECORD=0
            MOVE    "99",NORECORD           * Numb of records=0 Default to 10
          ENDIF
          MOVE      ZERO,RECNUMB            * Init Number of records Read
          MOVE      ZERO,DISNUMB            * Init number of records output
          PACK      KEY24,URNUMBER,Z70
          CALL      RDSVISA2
FHRLST10  CALL      RDPVISA2
          BRANCH    OVRCD,FHRLST99
          MATCH     URNUMBER,PVIURNO
          GOTO      FHRLST99 IF NOT EQUAL
.
          MOVE      SP70,DOCINDIC
.
          COMPARE   NINE,PVITYPE           * Ignore Referrals
          GOTO      FHRLST10 IF EQUAL
          COMPARE   FOUR,PVITYPE           * Ignore Referrals
          GOTO      FHRLST10 IF EQUAL
.
          CALL      FHRCLR00
          CALL      FHRVIS00
          BRANCH    OVRCD,FHRLST10
.
          COMPARE   ZERO,PTSTATUS          * Is there a status filter
          IF        !@EQUAL
            COMPARE   PTSTATUS,ASTAT       * Is the status selected
            IF        !@EQUAL
              GOTO      FHRLST10
            ENDIF
          ENDIF
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      FHRLST10
          ENDIF
          IF        DISNUMB>0
            WRITE     HTMLFILE;*+,",";
          ENDIF
          WRITE     HTMLFILE;*+," {":
                                " #"fullUrl#": #"%BASEURL/Encounter/",FHRENCID,"#",":
                                " #"resource#": ";
          CALL      RESENC00
          WRITE     HTMLFILE;*+," }";
.
          IF       FHRSUBIN=1
            WRITE     HTMLFILE;*+,",{ #"fullUrl#" : #"%BASEURL/Patient/",FHRPATID,"#", ":
                      " #"resource#" : ";
            CALL     RESPAT00            * FHIR Resource Patient
            WRITE    HTMLFILE;*+,"}"
          ENDIF
.
          IF       FHRPARIN=1
.
            CALL      FHRDO100
.
            MATCH     SP70,FHRDOCC1
            IF        !@EQUAL
.
              WRITE     HTMLFILE;*+,",{ #"fullUrl#" : #"%BASEURL/Practitioner/",FHRDOCC1,"#", ":
                        " #"resource#" : ";
              CALL     RESPRA00         * FHIR Resource Practitioner
              WRITE    HTMLFILE;*+,"}"
.
            ENDIF
.
            CALL      FHRDO200
.
            MATCH     SP70,FHRDOCC2
            IF        !@EQUAL
.
              WRITE     HTMLFILE;*+,",{ #"fullUrl#" : #"%BASEURL/Practitioner/",FHRDOCC2,"#", ":
                        " #"resource#" : ";
              CALL     RESPRA00         * FHIR Resource Practitioner
              WRITE    HTMLFILE;*+,"}"
.
            ENDIF
.
          ENDIF
.
          IF       FHRLOCIN=1
.
            MATCH     "emergency",FHRCLAS
            IF        @EQUAL 
.
              MATCH    SP70,EMVILOCN
              IF       !@EQUAL & !@EOS
.
                PACK      KEY3,EMVILOCN,SP70
                CALL      RDEMLOC1
                IF        OVRCD = 0
.
                  MOVE      SP70,DIM3
.
                  PACK      KEY3,EMLOSCOD,SP70
                  CALL      RDEMSIT1
                  IF        OVRCD=0
                    MOVE      EMSTHSNO,DIM3
                  ENDIF
.
                  WRITE     HTMLFILE;*+,",{ #"fullUrl#" : #"%BASEURL/Location/",FHRWLOCC,"#", ":
                            " #"resource#" : ";
                  CALL     RESEST00         * FHIR Resource Location Emergency Loc
                  WRITE    HTMLFILE;*+,"}"
.
                ENDIF
.
              ENDIF
.
            ELSE
.
              MATCH     SP70,AWARD
              IF        !@EQUAL
                PACK      KEY6,AWARD,ABED,SP70
              ELSE
                PACK      KEY6,PTMIXWRD,PTMIEBED,SP70
              ENDIF
              CALL      RDWARD1
              IF        OVRCD=0
.
                MATCH     SP70,AWARD
                IF        !@EQUAL
.
                  MATCH     SP70,ABED
                  IF        !@EQUAL
.
                    WRITE    HTMLFILE;*+,",{ #"fullUrl#" :":
                             " #"%BASEURL/Location/",FHRBLOCC,"#", ":
                             " #"resource#" : ";
                    CALL     RESBED00         * FHIR Resource Location Bed
                    WRITE    HTMLFILE;*+,"}"
.
                  ELSE
.
                    WRITE    HTMLFILE;*+,",{ #"fullUrl#" :":
                             " #"%BASEURL/Location/",FHRWLOCC,"#", ":
                             " #"resource#" : ";
                    CALL     RESWRD00         * FHIR Resource Location Ward
                    WRITE    HTMLFILE;*+,"}"
.
                  ENDIF
.
                ELSE      
.
                  MATCH      SP70,PTMIXWRD
                  IF        !@EQUAL
.
                    MATCH     SP70,PTMIEBED
                    IF        !@EQUAL
.
                      WRITE    HTMLFILE;*+,",{ #"fullUrl#" :":
                               " #"%BASEURL/Location/",FHRBLOCC,"#", ":
                               " #"resource#" : ";
                      CALL     RESBED00         * FHIR Resource Location Bed
                      WRITE    HTMLFILE;*+,"}"
.
                    ELSE
.
                      WRITE    HTMLFILE;*+,",{ #"fullUrl#" :":
                               " #"%BASEURL/Location/",FHRWLOCC,"#", ":
                               " #"resource#" : ";
                      CALL     RESWRD00         * FHIR Resource Location Ward
                      WRITE    HTMLFILE;*+,"}"
.
                    ENDIF
.
                  ENDIF
.
                ENDIF
.
              ENDIF
.
            ENDIF
.
          ENDIF
.
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      FHRLST10 IF NOT EQUAL

FHRLST99  RETURN
.
FHRVIS00  PACK      KEY8,PVIBILL,SP70
          CALL      RDPMVX11
          IF        OVRCD=1
            IF        ARCFLAG=1
              MOVE      PVIBILL,KEY8
              CALL      RDARVX11
              IF        OVRCD<>1
                CALL      MVPMAR00
              ENDIF
            ENDIF
          ENDIF
          BRANCH    OVRCD,FHRVIS90
.
          MOVE      PVIBILL,KEY8
          CALL      RDMISS1
          IF        OVRCD=1
            CALL      CLPATMIS
          ENDIF
.
          MATCH     "1",NOCANVIS
          IF        @EQUAL
            COMPARE   FIVE,ASTAT
            GOTO      FHRVIS90 IF EQUAL
          ELSE
            MATCH     "2",NOCANVIS
            IF        @EQUAL
              COMPARE   FIVE,ASTAT
              GOTO      FHRVIS90 IF EQUAL
            ENDIF
          ENDIF
.
          MOVE      PMVXMHOS,VISTHOSP
.
          MATCH     "1",INFORMGP
          IF        @EQUAL
            MATCH     "1",PMVXINGP
            IF        !@EQUAL
              GOTO      FHRVIS90
            ENDIF
          ENDIF
.
          IF        IBCNMHOS=1
            MATCH    "1",SHOWPPRV
            IF       @EQUAL
              IF       SHOWALLH=1
                PACK      KEY13,USERID,SP70              * All hospital access
                CALL      RDMLSEC1
                IF        OVRCD=1
                  PACK      KEY13,USERID,PMVXMHOS,SP70   * This hospital access
                  CALL      RDMLSEC1
                  BRANCH    OVRCD,FHRVIS90
                ENDIF
              ELSE
                PACK     KEY10,USERID,SP70        * Re read logged in user to
                CALL     RDWBSE1                  * get hospital
                BRANCH   OVRCD,FHRVIS90
.
                MATCH    WBSEHOSP,PMVXMHOS        * Only show visits for logged
                GOTO     FHRVIS90 IF NOT EQUAL    * in hospital if pre adm from
              ENDIF
            ENDIF                               * prev details screen
          ENDIF
.
          ADD       ONE,VISCOUNT
          MOVE      SP70,DESCSNAG
.
          IF        VISTFLAG<>0
            COMPARE   VISTFLAG,PVITYPE      * Match For Visit Type
            GOTO      FHRVIS90 IF NOT EQUAL
          ENDIF
.
          MOVE      ONE,EPSCD001         * Episode number?
          MOVE      SP70,SAVEPKEY        * Clear save episode key
          MOVE      ZERO,GENCHCDS        * flag to generate a phantom patchcof
          MOVE      ZERO,GENITNOW        * don't generate a patchcof yet
          IF        ASTAT = 3 & MRCNEPSC = 1
            MOVE      ONE,GENCHCDS       * set "Generate Discharge patchcof"
          ENDIF
          MOVE      " 0",KEY2
          PACK      CHCDATA,PVIBILL,ADATE,ATIME,KEY2,ACARE,SP30 
.
          PACK      DISPCLSS,SP70
          MATCH     SP70,ACARE
          IF        !@EQUAL
            PACK      DIM1,SP20
            PACK      DISPCLSS,SP20
            PACK      KEY5,ANSC,ANSC,ACARE,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              UNPACK      TCINDC21,DIM1
            ENDIF
            MATCH     DIM1,SP70
            IF        !@EQUAL
              PACK      DISPCLSS,ONCLCLSS,DIM1,SP70
            ENDIF
            SQUEEZE   DISPCLSS
          ENDIF
.
          CALL      MRTCOD00             * Medical Record Coding Details
          BRANCH    EXIT,FHRVIS90
.
          COMPARE   ZERO,CODESTAT        * Do not display Coder id if not coded
          IF        @EQUAL
            MOVE      SP70,CODERNAM
          ELSE
            MOVE      SP70,CODERNAM
            PACK      KEY10,PTEDUSID,SP70
            CALL      RDWBSE1
            IF        OVRCD=0
              MOVE      WBSENAM,CODERNAM
            ELSE
              PACK      KEY14,PTEDOPER,SP70
              CALL      RSWBSE3
              CALL      RKWBSE3
              IF        OVRCD=0
                MATCH     PTEDOPER,WBSEPCD
                IF        @EQUAL
                  MOVE      WBSENAM,CODERNAM
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          CALL      GETVIS00             * Get Visit Details
          BRANCH    EXIT,FHRVIS90
.
          PACK      KEY8,PVIBILL         * Outpatient event details
          CALL      RDPMEVT1
          BRANCH    OVRCD,FHRVIS30
.
          MOVE      "EV",CATEGORY
          MOVE      PMEVEVNT,CODE
          CALL      GETCOD00
.
          MATCH     "E",TCINDC1          * emergency events
          GOTO      FHRVIS10 IF EQUAL
.
          MATCH     "I",TCINDC1          * inpatient event
          IF        @EQUAL
            PACK      KEY6,PMEVPWRD,PMEVPBED
            CALL      FWBD0000
            PACK      VISTLOC,WARDBED,SP70
            IF        IBCNMHOS=1
              PACK      KEY3,PMVXMHOS
              CALL      FHOS0000
              PACK      VISTLOC,HOSPTEXT,DASH,WARDBED,SP70
            ENDIF
            MOVE      PMEVCCOD,CLAIMCOD
            CALL      GETSTA00
            GOTO      FHRVIS30
          ENDIF
.
          MATCH     "O",TCINDC1
          IF        !@EQUAL
            CALL      GETSTA00
            GOTO      FHRVIS30
          ENDIF
.
          CALL      GETSTA00
          MOVE      ZERO,FORM1
          MOVE      PMEVASTT,FORM1
          LOAD      VSTATUS,FORM1,OEVSTA1,OEVSTA2
          IF        FORM1=0
            MOVE      OEVSTA0,VSTATUS 
          ENDIF 
.
FHRVIS10  MOVE      PMEVATIM,VISTTIME
          MOVE      PMEVCCOD,CLAIMCOD
          MOVE      PMEVCTYP,UNITCODE
.
          MATCH     SP70,PMEVCTYP
          GOTO      FHRVIS30 IF EQUAL
.
          PACK      KEY12,PMEVSITE,PMEVCTYP,SP70
          CALL      RDCTYA1
          BRANCH    OVRCD,FHRVIS30
.
          MOVE      OCTDESC,UNITDESC
          MOVE      PMEVCTYP,UNITCODE
.
FHRVIS30  CALL      CKAL0000             * Check Allied Health
          BRANCH    EXIT,FHRVIS90        * don't display
.
          CALL      MRTDES00             * Medical Record Location Details
.
.
          PACK      ADMISSNO,PVIBILL,SP70
          CALL      GFRSTA00 *  Encounter Status
          CALL      GFRCLS00 *  Encounter Class
          CALL      GFRSDT00 *  Encounter Start Date
          CALL      GFREDT00 *  Encounter End Date
          CALL      GFRLOC00 *  Encounter Location
          CALL      GFRREA00 *  Encounter Reason
          CALL      GFRDOC00 *  Encounter Doctor
.
          PACK      FHRPATID,URNUMBER,SP70
          PACK      FHRENCID,URNUMBER,ADMISSNO,SP70
          REP       " -",FHRENCID
          SQUEEZE   FHRPATID
          MOVE      PATFNAME,FHRPATN
          MOVE      ZERO,OVRCD
          GOTO      FHRVIS99
FHRVIS90  MOVE      ONE,OVRCD
FHRVIS99  RETURN
.
.------------------------------------------------------------
. FHIR Diagnosis and Procedures Related to Encounter
.------------------------------------------------------------
RESDIA00  MOVE      ZERO,FHRCONFL
          PACK      KEY13,ADMISSNO,SP70
          CALL      RSPTECD1
RESDIA10  CALL      RKPTECD1
          BRANCH    OVRCD,RESDIA20
          MATCH     DPTEDADM,ADMISSNO
          GOTO      RESDIA20 IF NOT EQUAL
.
          PACK      FHRCONID,DPTEDADM,DPTEDEPN,DPTEDCNT,SP70
          REP       " -",FHRCONID
.
          IF        FHRCONFL=0
            MOVE      ONE,FHRCONFL
            WRITE     HTMLFILE;*+,",#"diagnosis#" : [  ";
          ELSE
            WRITE     HTMLFILE;*+,", ";
          ENDIF
.
          WRITE     HTMLFILE;*+,"{ #"rank#": ",DPTEDCNT," ":
                     ",#"role#": [ { #"coding#": [ {":
                     "   #"system#": #"http://hl7.org/fhir/diagnosis-role#",":
                     "   #"code#": #"DD#" } ] } ]":
                     ",#"condition#" : ":
                     "   { #"reference#" : #"Condition/ECD-",FHRCONID,"#",":
                     "     #"display#" : #"",PTEDDESC,"#" } }  ";
          GOTO      RESDIA10 
.
RESDIA20  PACK      KEY13,ADMISSNO,SP70
          CALL      RSPTECO1
RESDIA30  CALL      RKPTECO1
          BRANCH    OVRCD,RESDIA40
          MATCH     DPTEOADM,ADMISSNO
          GOTO      RESDIA40 IF NOT EQUAL
.
          IF        FHRCONFL=0
            MOVE      ONE,FHRCONFL
            WRITE     HTMLFILE;*+,",#"diagnosis#" : [ ";
          ELSE
            WRITE     HTMLFILE;*+,", ";
          ENDIF
.
          PACK      FHRCONID,DPTEOADM,DPTEOEPN,DPTEOCNT,SP70
          REP       " -",FHRCONID
          WRITE     HTMLFILE;*+,"{ #"rank#": ",DPTEOCNT," ":
                     ",#"procedure#" : ":
                     "   { #"reference#" : #"Condition/ECO-",FHRCONID,"#",":
                     "     #"display#" : #"",PTEODESC,"#" } } ";
.
          GOTO      RESDIA30 
.
RESDIA40  
RESDIA99  IF        FHRCONFL=1
            WRITE     HTMLFILE;*+,"]";
          ENDIF
          RETURN
.
.--------------------------------------------------------------------------------
. FHIR Encounter Resource Extra Type Related Data
.--------------------------------------------------------------------------------
RESEXT00
RESEXT99  RETURN
.--------------------------------------------
. Add Contacts to FHIR Patient Resource
.--------------------------------------------
FHRCON00  MOVE      ZERO,F3
          PACK      KEY14,URNUMBER,SP20
          CALL      RSPMCEX1
FHRCON10  CALL      RKPMCEX1
          BRANCH    OVRCD,FHRCON99
          MATCH     URNUMBER,PMCEURNO
          GOTO      FHRCON99 IF NOT EQUAL
          MATCH     "0",PMCEACTV
          GOTO      FHRCON10 IF NOT EQUAL
.
          PACK      KEY5,CATTC,PMCETYPE
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      PMCETYPE,TDESC
          ENDIF
.
          PACK      KEY4,PMCETITL
          CALL      RDPMTLE1
          IF        OVRCD=1
            MOVE      PMCETITL,PMTLDESC
          ENDIF
.
          PACK      KEY10,PMCERELP,SP70
          CALL      RDPMREL1
          IF        OVRCD=1
            MOVE      PMCERELP,PMRLDESC
          ENDIF
.
          IF        F3>0
            WRITE     HTMLFILE;*+,",";
          ELSE
            ADD       ONE,F3
            WRITE     HTMLFILE;*+,",#"contact#" : [ ";
          ENDIF
          WRITE     HTMLFILE;*+,"{#"relationship#": [ {":
                                "  #"coding#":  [ {":
                                "   #"code#": #"",PMCERELP,"#",":
                                "   #"display#": #"",PMRLDESC,"#" } ] } ],":
                                " #"name#" : {":
                                "  #"use#" : #"usual#",":
                                "  #"family#": #"",PMCESNAM,"#",":
                                "  #"given#" : [#"",PMCEGNAM,"#"";
          MATCH     SP70,PMCEGNM2
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",#"",PMCEGNM2,"#"";
          ENDIF
          WRITE     HTMLFILE;*+,"],":
                      "      #"prefix#" : [#"",PMTLDESC,"#"]":
                      "     }, ";
.
          WRITE     HTMLFILE;*+," #"address#": [ {":
                                " #"use#": #"home#",":
                                " #"line#": [#"",PMCEADD1,"#"";
          MATCH     SP70,PMCEADD2
          IF        !@EQUAL
            STRIP     PMCEADD2
            WRITE     HTMLFILE;*+,",#"",PMCEADD2,"#"";
          ENDIF
          WRITE     HTMLFILE;*+,"],":
                                " #"city#": #"",PMCEADD3,"#",":
                                " #"state#": #"",PMCEADD4,"#",":
                                " #"postalCode#": #"",PMCEPOST,"#"":
                                " } ],":
                                "#"telecom#": [ ":
                                "{#"system#": #"email#",":
                                " #"value#": #"",PMCEEMAI,"#"},":
                                "{#"system#": #"phone#",":
                                " #"use#": #"home#",":
                                " #"value#": #"",PMCETELP,"#"},":
                                "{#"system#": #"phone#",":
                                " #"use#": #"work#",":
                                " #"value#": #"",PMCETELB,"#"},":
                                "{#"system#": #"phone#",":
                                " #"use#": #"mobile#",":
                                " #"value#": #"",PMCETELM,"#"} ] }";
          GOTO      FHRCON10

FHRCON99  IF        F3>0
            WRITE     HTMLFILE;*+,"  ]";
          ENDIF
          MATCH     PMPXRHC1,SP70
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",#"generalPractitioner#": [ { #"reference#": #"Practitioner/HCP-",PMPXRHC1,"#" }";
            MATCH     PMPXVGPC,SP70
            IF        !@EQUAL
              WRITE     HTMLFILE;*+,", { #"reference#": #"Practitioner/HCP-",PMPXVGPC,"#" }";
            ENDIF
            WRITE     HTMLFILE;*+," ]";
          ENDIF
          WRITE     HTMLFILE;*+,",#"telecom#": [ ";
          WRITE     HTMLFILE;*+,"{#"system#": #"phone#",":
                                " #"use#": #"home#",":
                                " #"value#": #"",PTELEP,"#"}";
          MATCH     SP70,PMPXPEML
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",{#"system#": #"email#",":
                                  " #"value#": #"",PMPXPEML,"#"}";
          ENDIF
          MATCH     SP70,PTELEB
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",{#"system#": #"phone#",":
                                  " #"use#": #"work#",":
                                  " #"value#": #"",PTELEB,"#"}";
          ENDIF
          MATCH     SP70,PTMXCELL
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",{#"system#": #"phone#",":
                                  " #"use#": #"mobile#",":
                                  " #"value#": #"",PTMXCELL,"#"} ";
          ENDIF
          WRITE     HTMLFILE;*+,"]";
          RETURN
+
.------------------------------------------------------------
. Output HEA QLD MH file
.------------------------------------------------------------
HMHD0000  BRANCH    FLDITMNO,HMHD0010,HMHD0020,HMHD0030,HMHD0040,HMHD0050:
                             HMHD0060,HMHD0070,HMHD0080
.
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      HMHD9999
.
HMHD0010  WRITE     HTMLFILE;PTQMADMN;
          GOTO      HMHD9999
.
HMHD0020  MATCH     "1",PTQMTOUA
          IF        @EQUAL
            WRITE     HTMLFILE;"House or Flat";
            GOTO      HMHD9999
          ENDIF
.
          MATCH     "2",PTQMTOUA
          IF        @EQUAL
            WRITE     HTMLFILE;"Independant Unit as part of retirement village or similar";
            GOTO      HMHD9999
          ENDIF
.
          MATCH     "3",PTQMTOUA
          IF        @EQUAL
            WRITE     HTMLFILE;"Hostel or Hostel Accommodation";
            GOTO      HMHD9999
          ENDIF
.
          MATCH     "4",PTQMTOUA
          IF        @EQUAL
            WRITE     HTMLFILE;"Psychiatric Hospital";
            GOTO      HMHD9999
          ENDIF
.
          MATCH     "5",PTQMTOUA
          IF        @EQUAL
            WRITE     HTMLFILE;"Acute Hospital";
            GOTO      HMHD9999
          ENDIF
.
          MATCH     "7",PTQMTOUA
          IF        @EQUAL
            WRITE     HTMLFILE;"Other Accommodation";
            GOTO      HMHD9999
          ENDIF
.
          MATCH     "8",PTQMTOUA
          IF        @EQUAL
            WRITE     HTMLFILE;"No Usual Residence";
            GOTO      HMHD9999
          ENDIF
.
          WRITE     HTMLFILE;PTQMTOUA;
          GOTO      HMHD9999
.
HMHD0030  MATCH     "1",PTQMEMPS
          IF        @EQUAL
            WRITE     HTMLFILE;"Child Not At School";
            GOTO      HMHD9999
          ENDIF
.
          MATCH     "2",PTQMEMPS
          IF        @EQUAL
            WRITE     HTMLFILE;"Student";
            GOTO      HMHD9999
          ENDIF
.
          MATCH     "3",PTQMEMPS
          IF        @EQUAL
            WRITE     HTMLFILE;"Employed";
            GOTO      HMHD9999
          ENDIF
.
          MATCH     "4",PTQMEMPS
          IF        @EQUAL
            WRITE     HTMLFILE;"Unemployed";
            GOTO      HMHD9999
          ENDIF
.
          MATCH     "5",PTQMEMPS
          IF        @EQUAL
            WRITE     HTMLFILE;"Home Duties";
            GOTO      HMHD9999
          ENDIF
.
          MATCH     "6",PTQMEMPS
          IF        @EQUAL
            WRITE     HTMLFILE;"Pensioner";
            GOTO      HMHD9999
          ENDIF
.
          MATCH     "8",PTQMEMPS
          IF        @EQUAL
            WRITE     HTMLFILE;"Other";
            GOTO      HMHD9999
          ENDIF
.
          WRITE     HTMLFILE;PTQMEMPS;
          GOTO      HMHD9999
.
HMHD0040  MATCH     "1",PTQMPSNS
          IF        @EQUAL
            WRITE     HTMLFILE;"Age";
            GOTO      HMHD9999
          ENDIF
.
          MATCH     "2",PTQMPSNS
          IF        @EQUAL
            WRITE     HTMLFILE;"Repatriation";
            GOTO      HMHD9999
          ENDIF
.
          MATCH     "3",PTQMPSNS
          IF        @EQUAL
            WRITE     HTMLFILE;"Invalid";
            GOTO      HMHD9999
          ENDIF
.
          MATCH     "4",PTQMPSNS
          IF        @EQUAL
            WRITE     HTMLFILE;"Unemployment Benefit";
            GOTO      HMHD9999
          ENDIF
.
          MATCH     "5",PTQMPSNS
          IF        @EQUAL
            WRITE     HTMLFILE;"Sickness Benefit";
            GOTO      HMHD9999
          ENDIF
.
          MATCH     "6",PTQMPSNS
          IF        @EQUAL
            WRITE     HTMLFILE;"Other";
            GOTO      HMHD9999
          ENDIF
.
          MATCH     "8",PTQMPSNS
          IF        @EQUAL
            WRITE     HTMLFILE;"No Pension/Benefit";
            GOTO      HMHD9999
          ENDIF
.
          WRITE     HTMLFILE;PTQMPSNS;
          GOTO      HMHD9999
.
HMHD0050  MATCH     "1",PTQMPRMS
          IF        @EQUAL
            WRITE     HTMLFILE;"No Previous Admission for Psychiatric Treatment";
            GOTO      HMHD9999
          ENDIF
.
          MATCH     "2",PTQMPRMS
          IF        @EQUAL
            WRITE     HTMLFILE;"Previous Admission for Psychiatric Treatment";
            GOTO      HMHD9999
          ENDIF
.
          WRITE     HTMLFILE;PTQMPRMS;
          GOTO      HMHD9999
.
HMHD0060  MATCH     "01",PTQMRTFC
          IF        @EQUAL
            WRITE     HTMLFILE;"Not Referred";
            GOTO      HMHD9999
          ENDIF
.
          MATCH     "02",PTQMRTFC
          IF        @EQUAL
            WRITE     HTMLFILE;"Private Psychiatrist";
            GOTO      HMHD9999
          ENDIF
.
          MATCH     "03",PTQMRTFC
          IF        @EQUAL
            WRITE     HTMLFILE;"Other Private Medical Practitioner";
            GOTO      HMHD9999
          ENDIF
.
          MATCH     "04",PTQMRTFC
          IF        @EQUAL
            WRITE     HTMLFILE;"Mental Health/Alcohol and Drug Facility - Admitted";
            GOTO      HMHD9999
          ENDIF
.
          MATCH     "05",PTQMRTFC
          IF        @EQUAL
            WRITE     HTMLFILE;"Mental Health/Alcohol and Drug Facility - Non Admitted";
            GOTO      HMHD9999
          ENDIF
.
          MATCH     "06",PTQMRTFC
          IF        @EQUAL
            WRITE     HTMLFILE;"Acute Hospital - Admitted";
            GOTO      HMHD9999
          ENDIF
.
          MATCH     "07",PTQMRTFC
          IF        @EQUAL
            WRITE     HTMLFILE;"Acute Hospital - Non Admitted";
            GOTO      HMHD9999
          ENDIF
.
          MATCH     "08",PTQMRTFC
          IF        @EQUAL
            WRITE     HTMLFILE;"Community Health Program";
            GOTO      HMHD9999
          ENDIF
.
          MATCH     "29",PTQMRTFC
          IF        @EQUAL
            WRITE     HTMLFILE;"Other";
            GOTO      HMHD9999
          ENDIF
.
          WRITE     HTMLFILE;PTQMRTFC;
          GOTO      HMHD9999
.
HMHD0070  MATCH     "1",PTQMMLSI
          IF        @EQUAL
            WRITE     HTMLFILE;"Involuntary Patient for Any Part Of The Episode";
            GOTO      HMHD9999
          ENDIF
.
          MATCH     "2",PTQMMLSI
          IF        @EQUAL
            WRITE     HTMLFILE;"Voluntary Patient for All Of The Episode";
            GOTO      HMHD9999
          ENDIF
.
          WRITE     HTMLFILE;PTQMMLSI;
          GOTO      HMHD9999
.
HMHD0080  MATCH     "1",PTQMPSNT
          IF        @EQUAL
            WRITE     HTMLFILE;"No Prev Non-Admitted Service Contacts For Psych";
            GOTO      HMHD9999
          ENDIF
.
          MATCH     "2",PTQMPSNT
          IF        @EQUAL
            WRITE     HTMLFILE;"Prev Non-Admitted Service Contacts For Psych";
            GOTO      HMHD9999
          ENDIF
.
          WRITE     HTMLFILE;PTQMPSNT;
          GOTO      HMHD9999
.
HMHD9999  RETURN
.------------------------------------------------------------
. PMI Audit Changes
.------------------------------------------------------------
PMIAUD00  CALL      CREC0000
.
          IF        NORECORD=0
            MOVE    "14",NORECORD           * Numb of records=0 Default to 10
          ENDIF
          MOVE      ZERO,RECNUMB            * Init Number of records Read
          MOVE      ZERO,DISNUMB            * Init number of records output
.
          PACK      KEY27,URNUMBER,SP70
          CALL      RSPMDAU1 
PMIAUD10  CALL      RKPMDAU1
          BRANCH    OVRCD,PMIAUD40
.
          MATCH     URNUMBER,PMDEURNO
          GOTO      PMIAUD40 IF NOT EQUAL
.
          MATCH     "001",PMDERTYP
          GOTO      PMIAUD10 IF EQUAL
.
          MATCH     "003",PMDERTYP
          GOTO      PMIAUD10 IF EQUAL
.
          MATCH     "004",PMDERTYP
          GOTO      PMIAUD10 IF EQUAL
.
          MOVE      PMDECDAT,TMPADATE
          MOVE      PMDECTIM,TMPATIME
          MOVE      PMDERTYP,TMPATYPE
          MOVE      PMDECUID,TMPAUSER 
.
          PACK      KEY29,TMPADATE,TMPATIME,TMPATYPE,TMPAUSER,SP70
          CALL      RATEMP3
          IF        OVRCD=ONE
            CALL      WRTEMP3
          ENDIF
.
          GOTO      PMIAUD10
.
PMIAUD40  PACK      KEY24,URNUMBER,SP70
          CALL      RDSPADD1
PMIAUD50  CALL      RDKPADD1
          BRANCH    OVRCD,PMIAUD70
.
          MATCH     URNUMBER,PAURNO
          GOTO      PMIAUD70 IF NOT EQUAL
.
          MOVE      PADATE,TMPADATE
          MOVE      PATIME,TMPATIME
          MOVE      "ADU",TMPATYPE
          MOVE      PTPAWEBC,TMPAUSER
.
          PACK      KEY29,TMPADATE,TMPATIME,TMPATYPE,TMPAUSER,SP70
          CALL      RATEMP3
          IF        OVRCD=ONE
            CALL      WRTEMP3
          ENDIF
.
          GOTO      PMIAUD50
.
PMIAUD70  PACK      TMPADATE,PTMXRDAT,SP70
          PACK      TMPATIME,SP70
.
          MATCH     SP70,PMPXWBID
          IF        @EQUAL
            PACK      TMPATYPE,ANSR,ANSE,ANSG,SP70
            PACK      TMPAUSER,PTMXOPER,SP70
          ELSE
            PACK      TMPATYPE,ANSR,ANSG,ANSG,SP70
            PACK      TMPAUSER,PMPXWBID,SP70
          ENDIF
.
          PACK      KEY29,TMPADATE,TMPATIME,TMPATYPE,TMPAUSER,SP70
          CALL      RATEMP3
          IF        OVRCD=ONE
            CALL      WRTEMP3
          ENDIF
.
PMIAUD78  PACK      KEY29,Z70
          CALL      RSTEMP3
PMIAUD80  CALL      RPTEMP3
          BRANCH    OVRCD,PMIAUD98
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      PMIAUD80
          ENDIF
.
          PACK      DISPDATE,SP70
          MATCH     SP70,TMPADATE
          IF        !@EQUAL
            UNPACK    TMPADATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF 
.
          PACK      KEY35,SP70
          MATCH     SP70,TMPAUSER
          IF        !@EQUAL
            MATCH     "REG",TMPATYPE
            IF        @EQUAL
              CALL      OPPASS1
              MOVE      TMPAUSER,KEY4
              CALL      RDPASS1
              IF        OVRCD=0
                PACK      KEY35,SECUSER,SP70
              ELSE
                PACK      KEY35,TMPAUSER,SP70
              ENDIF
            ELSE  
              PACK      KEY10,TMPAUSER,SP70
              CALL      RDWBSE1
              IF        OVRCD=0
                PACK      KEY35,WBSENAM,SP70
              ELSE
                PACK      KEY35,TMPAUSER,SP70
              ENDIF
            ENDIF
          ENDIF
.
          PACK      KEY50,SP70
          MATCH     "002",TMPATYPE
          IF        @EQUAL
            MOVE      "GP/Practice Update",KEY50
            PACK      KEY50,KEY50,SP70
          ENDIF
.
          MATCH     "005",TMPATYPE
          IF        @EQUAL
            MOVE      "Name Changes",KEY50
            PACK      KEY50,KEY50,SP70
          ENDIF
.
          MATCH     "006",TMPATYPE
          IF        @EQUAL
            MOVE      "Demographics Confirmed",KEY50
            PACK      KEY50,KEY50,SP70
          ENDIF
.
          MATCH     "007",TMPATYPE
          IF        @EQUAL
            MOVE      "PMI Details Changes 1",KEY50
            PACK      KEY50,KEY50,SP70
          ENDIF
.
          MATCH     "008",TMPATYPE
          IF        @EQUAL
            MOVE      "PMI Details Changes 2",KEY50
            PACK      KEY50,KEY50,SP70
          ENDIF
.
          MATCH     "009",TMPATYPE
          IF        @EQUAL
            MOVE      "NHI Ethnicity Changes",KEY50
            PACK      KEY50,KEY50,SP70
          ENDIF
.
          MATCH     "010",TMPATYPE
          IF        @EQUAL
            MOVE      "NHI Residency Details Changes",KEY50
            PACK      KEY50,KEY50,SP70
          ENDIF
.
          MATCH     "011",TMPATYPE
          IF        @EQUAL
            MOVE      "PMI Postal Address Changes",KEY50
            PACK      KEY50,KEY50,SP70
          ENDIF
.
          MATCH     "012",TMPATYPE
          IF        @EQUAL
            MOVE      "NHI MWS Local Edits",KEY50
            PACK      KEY50,KEY50,SP70
          ENDIF
.
          MATCH     "ADU",TMPATYPE
          IF        @EQUAL
            MOVE      "Address Update",KEY50
            PACK      KEY50,KEY50,SP70
          ENDIF
.
          MATCH     "REG",TMPATYPE
          IF        @EQUAL
            MOVE      "Registration",KEY50
            PACK      KEY50,KEY50,SP70
          ENDIF
.
          MATCH     "RGG",TMPATYPE
          IF        @EQUAL
            MOVE      "Registration",KEY50
            PACK      KEY50,KEY50,SP70
          ENDIF
.
          WRITE     HTMLFILE;"<tr>";
.
          MATCH     "005",TMPATYPE
          IF        @EQUAL
            PACK      KEY29,URNUMBER,TMPADATE,TMPATIME,TMPATYPE,SP70
            REP       " +",KEY29
            WRITE     HTMLFILE;"<td width=30%>";
            WRITE     HTMLFILE;"<a href=#javascript:disPmiAud('":
                          "patweb98.pbl?reportno=01&template=331&pmdaukey=":
                          KEY29,"');>":
                          "<img src='../images/MaintenanceIcon1.gif'></a> &nbsp;&nbsp;";
            WRITE     HTMLFILE;DISPDATE," at ",TMPATIME,"</td>";
            GOTO      PMIAUD85
          ENDIF
.
          MATCH     "007",TMPATYPE
          IF        @EQUAL
            PACK      KEY29,URNUMBER,TMPADATE,TMPATIME,TMPATYPE,SP70
            REP       " +",KEY29
            WRITE     HTMLFILE;"<td width=30%>";
            WRITE     HTMLFILE;"<a href=#javascript:disPmiAud('":
                          "patweb98.pbl?reportno=01&template=332&pmdaukey=":
                          KEY29,"');>":
                          "<img src='../images/MaintenanceIcon1.gif'></a> &nbsp;&nbsp;";
            WRITE     HTMLFILE;DISPDATE," at ",TMPATIME,"</td>";
            GOTO      PMIAUD85
          ENDIF
.
          MATCH     "008",TMPATYPE
          IF        @EQUAL
            PACK      KEY29,URNUMBER,TMPADATE,TMPATIME,TMPATYPE,SP70
            REP       " +",KEY29
            WRITE     HTMLFILE;"<td width=30%>";
            WRITE     HTMLFILE;"<a href=#javascript:disPmiAud('":
                          "patweb98.pbl?reportno=01&template=333&pmdaukey=":
                          KEY29,"');>":
                          "<img src='../images/MaintenanceIcon1.gif'></a> &nbsp;&nbsp;";
            WRITE     HTMLFILE;DISPDATE," at ",TMPATIME,"</td>";
            GOTO      PMIAUD85
          ENDIF
.
          MATCH     "009",TMPATYPE
          IF        @EQUAL
            PACK      KEY29,URNUMBER,TMPADATE,TMPATIME,TMPATYPE,SP70
            REP       " +",KEY29
            WRITE     HTMLFILE;"<td width=30%>";
            WRITE     HTMLFILE;"<a href=#javascript:disPmiAud('":
                          "patweb98.pbl?reportno=01&template=335&pmdaukey=":
                          KEY29,"');>":
                          "<img src='../images/MaintenanceIcon1.gif'></a> &nbsp;&nbsp;";
            WRITE     HTMLFILE;DISPDATE," at ",TMPATIME,"</td>";
            GOTO      PMIAUD85
          ENDIF
.
          MATCH     "010",TMPATYPE
          IF        @EQUAL
            PACK      KEY29,URNUMBER,TMPADATE,TMPATIME,TMPATYPE,SP70
            REP       " +",KEY29
            WRITE     HTMLFILE;"<td width=30%>";
            WRITE     HTMLFILE;"<a href=#javascript:disPmiAud('":
                          "patweb98.pbl?reportno=01&template=336&pmdaukey=":
                          KEY29,"');>":
                          "<img src='../images/MaintenanceIcon1.gif'></a> &nbsp;&nbsp;";
            WRITE     HTMLFILE;DISPDATE," at ",TMPATIME,"</td>";
            GOTO      PMIAUD85
          ENDIF
.
          MATCH     "011",TMPATYPE
          IF        @EQUAL
            PACK      KEY29,URNUMBER,TMPADATE,TMPATIME,TMPATYPE,SP70
            REP       " +",KEY29
            WRITE     HTMLFILE;"<td width=30%>";
            WRITE     HTMLFILE;"<a href=#javascript:disPmiAud('":
                          "patweb98.pbl?reportno=01&template=337&pmdaukey=":
                          KEY29,"');>":
                          "<img src='../images/MaintenanceIcon1.gif'></a> &nbsp;&nbsp;";
            WRITE     HTMLFILE;DISPDATE," at ",TMPATIME,"</td>";
            GOTO      PMIAUD85
          ENDIF
.
          MATCH     "012",TMPATYPE
          IF        @EQUAL
            PACK      KEY29,URNUMBER,TMPADATE,TMPATIME,TMPATYPE,SP70
            REP       " +",KEY29
            WRITE     HTMLFILE;"<td width=30%>";
            WRITE     HTMLFILE;"<a href=#javascript:disPmiAud('":
                          "patweb98.pbl?reportno=01&template=334&pmdaukey=":
                          KEY29,"');>":
                          "<img src='../images/MaintenanceIcon1.gif'></a> &nbsp;&nbsp;";
            WRITE     HTMLFILE;DISPDATE," at ",TMPATIME,"</td>";
            GOTO      PMIAUD85
          ENDIF
.
          MATCH     "REG",TMPATYPE
          IF        @EQUAL
            WRITE     HTMLFILE;"<td width=30%>",DISPDATE;
            GOTO      PMIAUD85
          ENDIF
.
          WRITE     HTMLFILE;"<td width=30%>",DISPDATE," at ",TMPATIME,"</td>";
.
PMIAUD85  WRITE     HTMLFILE;"<td width=30%>",KEY50,"</td>";
          WRITE     HTMLFILE;"<td width=30%>",KEY35,"</td>";
          WRITE     HTMLFILE;"</tr>";
.
.         GOTO      PMIAUD80
.
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      PMIAUD80 IF NOT EQUAL
.
PMIAUD98  CALL      CLEC0000
          CALL      KILC0000
.
PMIAUD99  RETURN
.
.****************************************************************************
.*        IO ROUTINES FOR TEMPORARY FILE                                    *
.****************************************************************************
.
.         Index 1
.
RSTEMP3   READ      PMITEMP1,KEY29;;
          RETURN
.
RATEMP3   RESET     KEY29
          MOVE      ZERO,OVRCD
          READ      PMITEMP1,KEY29;ANS
          GOTO      OVERCOND IF OVER
          RETURN
.
RDTEMP3   MOVE      ZERO,OVRCD
          READ      PMITEMP1,KEY29;TMPADATE,TMPATIME,TMPATYPE,TMPAUSER
          GOTO      OVERCOND IF OVER
          RETURN
.
RKTEMP3   MOVE      ZERO,OVRCD
          READKS    PMITEMP1;TMPADATE,TMPATIME,TMPATYPE,TMPAUSER
          GOTO      OVERCOND IF OVER
          RETURN
.
RPTEMP3   MOVE      ZERO,OVRCD
          READKP    PMITEMP1;TMPADATE,TMPATIME,TMPATYPE,TMPAUSER
          GOTO      OVERCOND IF OVER
          RETURN
.
WRTEMP3   WRITE     PMITEMP1,KEY29;TMPADATE,TMPATIME,TMPATYPE,TMPAUSER
          RETURN
.
UPTEMP3   UPDATE    PMITEMP1;TMPADATE,TMPATIME,TMPATYPE,TMPAUSER
          RETURN
.
DETEMP3   DELETE    PMITEMP1,KEY29
          RETURN
+
.*****************************************************************************
.*                              CREC0000               Called by: MAIN0000   *
.*             Create a new temporary file                                   *
.*****************************************************************************
.
CREC0000  CALL      KILC0000                     * remove existing file
.
          CLEAR     CMDLINE
          PACK      CMDLINE,ISBUILD,TEMPFIL3,UKEY3
          EXECUTE   CMDLINE,TASKID               * create temporary index file
.
          OPEN      PMITEMP1,TEMPFIL3            * open temp index 1
.
CREC9999  RETURN
+
.****************************************************************************
.*                              KILC0000               Called by: MAIN0000  *
.*               Close and erase the temporary file                         *
.****************************************************************************
.
KILC0000  CLOSE     PMITEMP1                     * close file
.
          CLEAR     CMDLINE
          PACK      CMDLINE,ISERASE,TEMPFIL3     * set file erase command
          EXECUTE   CMDLINE,TASKID               * erase temp file
.
KILC9999 RETURN
+
.****************************************************************************
.*                              CLEC0000               Called by: MAIN0000  *
.*               Close and erase the temporary file                         *
.****************************************************************************
.
CLEC0000  MOVE      SP70,KEY29
          CALL      RSTEMP3                      * position at start of file
          CALL      RKTEMP3                      * read next record
          BRANCH    OVRCD,CLEC9999               * eof - finished
.
          PACK      KEY29,TMPADATE,TMPATIME,TMPATYPE,TMPAUSER,SP70
          CALL      DETEMP3                      * delete current record
          GOTO      CLEC0000                     * get next record
.
CLEC9999  RETURN
+
.****************************************************************************
.*                              PMAD0000                                    *
.****************************************************************************
.
PMAD0000  BRANCH    FLDITMNO,PMAD0010,PMAD0020,PMAD0030,PMAD0040,PMAD0050:
                             PMAD0060,PMAD0070,PMAD0080,PMAD0090,PMAD0100:
                             PMAD0110,PMAD0120,PMAD0130,PMAD0140,PMAD0150
.
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      PMAD9999
.
PMAD0010  WRITE     HTMLFILE;PMDEURNO;
          GOTO      PMAD9999
.
PMAD0020  MATCH     SP70,PMDECDAT
          GOTO      PMAD9999 IF EQUAL
          UNPACK    PMDECDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          WRITE     HTMLFILE;KEY11;
          GOTO      PMAD9999
.
PMAD0030  WRITE     HTMLFILE;PMDECTIM;
          GOTO      PMAD9999
.
PMAD0040  WRITE     HTMLFILE;PMDERTYP;
          GOTO      PMAD9999
.
PMAD0050  MATCH     "005",PMDERTYP
          IF        @EQUAL
            WRITE     HTMLFILE;PMDEFL01;
          ENDIF
.
          MATCH     "007",PMDERTYP
          IF        @EQUAL
            MATCH     SP70,PMDEFL01
            IF        !@EQUAL
              MOVE      "M ",CATEGORY
              MOVE      PMDEFL01,CODE
.
              PACK      KEY5,CATEGORY,CODE,SP70
              CALL      RDCODE1
              IF        OVRCD=0
                WRITE     HTMLFILE;ACODE," - ",TDESC;
              ELSE
                WRITE     HTMLFILE;CODE," - Description not found";
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     "008",PMDERTYP
          IF        @EQUAL
            WRITE     HTMLFILE;PMDEFL01;
          ENDIF
.
          MATCH     "009",PMDERTYP
          IF        @EQUAL
            MATCH     SP70,PMDEFL01
            IF        !@EQUAL
              MOVE      PMDEFL01,KEY5
              CALL      RDNHETH1
              IF        OVRCD = 0
                WRITE     HTMLFILE;KEY5," - ",NHETDES;
              ELSE
                WRITE     HTMLFILE;KEY5," - Description not found";
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     "010",PMDERTYP
          IF        @EQUAL
            MATCH     SP70,PMDEFL01
            IF        !@EQUAL
              MOVE      "T ",CATEGORY
              MOVE      PMDEFL01,CODE
              PACK      KEY5,CATEGORY,CODE,SP70
              CALL      RDCODE1
              IF        OVRCD=0
                WRITE     HTMLFILE;ACODE," - ",TDESC;
              ELSE
                WRITE     HTMLFILE;CODE," - Description not found";
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     "011",PMDERTYP
          IF        @EQUAL
            WRITE     HTMLFILE;PMDEFL01;
          ENDIF
.
          MATCH     "012",PMDERTYP
          IF        @EQUAL
            WRITE     HTMLFILE;PMDEFL01;
          ENDIF
.
          GOTO      PMAD9999
.
PMAD0060  MATCH     "005",PMDERTYP
          IF        @EQUAL
            WRITE     HTMLFILE;PMDEFL02;
          ENDIF
.
          MATCH     "007",PMDERTYP
          IF        @EQUAL
            MATCH     SP70,PMDEFL02
            IF        !@EQUAL
              MOVE      "R ",CATEGORY
              MOVE      PMDEFL02,CODE
.
              PACK      KEY5,CATEGORY,CODE,SP70
              CALL      RDCODE1
              IF        OVRCD=0
                WRITE     HTMLFILE;ACODE," - ",TDESC;
              ELSE
                WRITE     HTMLFILE;CODE," - Description not found";
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     "008",PMDERTYP
          IF        @EQUAL
            MATCH     SP70,PMDEFL02
            IF        !@EQUAL
              MOVE      "LA",CATEGORY
              MOVE      PMDEFL02,CODE
.
              PACK      KEY5,CATEGORY,CODE,SP70
              CALL      RDCODE1
              IF        OVRCD=0
                WRITE     HTMLFILE;ACODE," - ",TDESC;
              ELSE
                WRITE     HTMLFILE;CODE," - Description not found";
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     "009",PMDERTYP
          IF        @EQUAL
            MATCH     SP70,PMDEFL02
            IF        !@EQUAL
              MOVE      PMDEFL02,KEY5
              CALL      RDNHETH1
              IF        OVRCD = 0
                WRITE     HTMLFILE;KEY5," - ",NHETDES;
              ELSE
                WRITE     HTMLFILE;KEY5," - Description not found";
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     "010",PMDERTYP
          IF        @EQUAL
            MATCH     SP70,PMDEFL02
            IF        !@EQUAL
              MOVE      "C ",CATEGORY
              MOVE      PMDEFL02,CODE
.
              PACK      KEY5,CATEGORY,CODE,SP70
              CALL      RDCODE1
              IF        OVRCD=0
                WRITE     HTMLFILE;ACODE," - ",TDESC;
              ELSE
                WRITE     HTMLFILE;CODE," - Description not found";
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     "011",PMDERTYP
          IF        @EQUAL
            WRITE     HTMLFILE;PMDEFL02;
          ENDIF
.
          MATCH     "012",PMDERTYP
          IF        @EQUAL
            WRITE     HTMLFILE;PMDEFL02;
          ENDIF
.
          GOTO      PMAD9999
.
PMAD0070  MATCH     "005",PMDERTYP
          IF        @EQUAL
            WRITE     HTMLFILE;PMDEFL03;
          ENDIF
.
          MATCH     "007",PMDERTYP
          IF        @EQUAL
            MATCH     SP70,PMDEFL03
            IF        !@EQUAL
              MOVE      "C ",CATEGORY
              MOVE      PMDEFL03,CODE
.
              PACK      KEY5,CATEGORY,CODE,SP70
              CALL      RDCODE1
              IF        OVRCD=0
                WRITE     HTMLFILE;ACODE," - ",TDESC;
              ELSE
                WRITE     HTMLFILE;CODE," - Description not found";
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     "008",PMDERTYP
          IF        @EQUAL
            MATCH     SP70,PMDEFL03
            IF        !@EQUAL
              MOVE      "PV",CATEGORY
              MOVE      PMDEFL03,CODE
.
              PACK      KEY5,CATEGORY,CODE,SP70
              CALL      RDCODE1
              IF        OVRCD=0
                WRITE     HTMLFILE;ACODE," - ",TDESC;
              ELSE
                WRITE     HTMLFILE;CODE," - Description not found";
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     "009",PMDERTYP
          IF        @EQUAL
            MATCH     SP70,PMDEFL03
            IF        !@EQUAL
              MOVE      PMDEFL03,KEY5
              CALL      RDNHETH1
              IF        OVRCD = 0
                WRITE     HTMLFILE;KEY5," - ",NHETDES;
              ELSE
                WRITE     HTMLFILE;KEY5," - Description not found";
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     "010",PMDERTYP
          IF        @EQUAL
            MATCH     SP70,PMDEFL03
            GOTO      PMAD9999 IF EQUAL
            UNPACK    PMDEFL03,CCENT,CYEAR,CMON,CDAY
            WRITE     HTMLFILE;CDAY,SLASH,CMON,SLASH,CCENT,CYEAR
          ENDIF
.
          MATCH     "011",PMDERTYP
          IF        @EQUAL
            WRITE     HTMLFILE;PMDEFL03;
          ENDIF
.
          MATCH     "012",PMDERTYP
          IF        @EQUAL
            WRITE     HTMLFILE;PMDEFL03;
          ENDIF
.
          GOTO      PMAD9999
.
PMAD0080  MATCH     "005",PMDERTYP
          IF        @EQUAL
            WRITE     HTMLFILE;PMDEFL04;
          ENDIF
.
          MATCH     "007",PMDERTYP
          IF        @EQUAL
            MATCH     SP70,PMDEFL04
            IF        !@EQUAL
              MOVE      "T ",CATEGORY
              MOVE      PMDEFL04,CODE
.
              PACK      KEY5,CATEGORY,CODE,SP70
              CALL      RDCODE1
              IF        OVRCD=0
                WRITE     HTMLFILE;ACODE," - ",TDESC;
              ELSE
                WRITE     HTMLFILE;CODE," - Description not found";
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     "008",PMDERTYP
          IF        @EQUAL
            WRITE     HTMLFILE;PMDEFL04;
          ENDIF
.
          MATCH     "009",PMDERTYP
          IF        @EQUAL
            MATCH     SP70,PMDEFL04
            IF        !@EQUAL
              MOVE      PMDEFL04,KEY5
              CALL      RDNHETH1
              IF        OVRCD = 0
                WRITE     HTMLFILE;KEY5," - ",NHETDES;
              ELSE
                WRITE     HTMLFILE;KEY5," - Description not found";
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     "010",PMDERTYP
          IF        @EQUAL
            WRITE     HTMLFILE;PMDEFL04;
          ENDIF
.
          MATCH     "011",PMDERTYP
          IF        @EQUAL
            WRITE     HTMLFILE;PMDEFL04;
          ENDIF
.
          GOTO      PMAD9999
.
PMAD0090  MATCH     "005",PMDERTYP
          IF        @EQUAL
            WRITE     HTMLFILE;PMDEFL05;
          ENDIF
.
          MATCH     "007",PMDERTYP
          IF        @EQUAL
            MATCH     SP70,PMDEFL05
            IF        !@EQUAL
              MOVE      "VA",CATEGORY
              MOVE      PMDEFL05,CODE
.
              PACK      KEY5,CATEGORY,CODE,SP70
              CALL      RDCODE1
              IF        OVRCD=0
                WRITE     HTMLFILE;ACODE," - ",TDESC;
              ELSE
                WRITE     HTMLFILE;CODE," - Description not found";
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     "008",PMDERTYP
          IF        @EQUAL
            WRITE     HTMLFILE;PMDEFL05;
          ENDIF
.
          MATCH     "009",PMDERTYP
          IF        @EQUAL
            MATCH     SP70,PMDEFL05
            IF        !@EQUAL
              MOVE      PMDEFL05,KEY5
              CALL      RDNHETH1
              IF        OVRCD = 0
                WRITE     HTMLFILE;KEY5," - ",NHETDES;
              ELSE
                WRITE     HTMLFILE;KEY5," - Description not found";
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     "010",PMDERTYP
          IF        @EQUAL
            WRITE     HTMLFILE;PMDEFL05;
          ENDIF
.
          MATCH     "011",PMDERTYP
          IF        @EQUAL
            WRITE     HTMLFILE;PMDEFL05;
          ENDIF
.
          GOTO      PMAD9999
.
PMAD0100  MATCH     "005",PMDERTYP
          IF        @EQUAL
            MATCH     SP70,PMDEFL06
            GOTO      PMAD9999 IF EQUAL
            UNPACK    PMDEFL06,CCENT,CYEAR,CMON,CDAY
.           MOVE      CMON,F2
.           LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.           PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.           WRITE     HTMLFILE;KEY11;
            WRITE     HTMLFILE;CDAY,SLASH,CMON,SLASH,CCENT,CYEAR
          ENDIF
.
          MATCH     "007",PMDERTYP
          IF        @EQUAL
            MATCH     SP70,PMDEFL06
            IF        !@EQUAL
.             MOVE      "U7",CATEGORY
              PACK      PTCNEMPL,PTCNEMPL,SP70
              MOVE      PTCNEMPL,CATEGORY
              MOVE      PMDEFL06,CODE
.
              PACK      KEY5,CATEGORY,CODE,SP70
              CALL      RDCODE1
              IF        OVRCD=0
                WRITE     HTMLFILE;ACODE," - ",TDESC;
              ELSE
                WRITE     HTMLFILE;CODE," - Description not found";
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     "008",PMDERTYP
          IF        @EQUAL
            MATCH     SP70,PMDEFL06
            IF        !@EQUAL
              PACK      CATEGORY,ANSP,ONE,SP70
              MOVE      PMDEFL06,CODE
              PACK      KEY5,CATEGORY,CODE,SP70
              CALL      RDCODE1
              IF        OVRCD=0
                WRITE     HTMLFILE;ACODE," - ",TDESC;
              ELSE
                WRITE     HTMLFILE;CODE," - Description not found";
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     "009",PMDERTYP
          IF        @EQUAL
            MATCH     SP70,PMDEFL06
            IF        !@EQUAL
              MOVE      PMDEFL06,KEY5
              CALL      RDNHETH1
              IF        OVRCD = 0
                WRITE     HTMLFILE;KEY5," - ",NHETDES;
              ELSE
                WRITE     HTMLFILE;KEY5," - Description not found";
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     "010",PMDERTYP
          IF        @EQUAL
            WRITE     HTMLFILE;PMDEFL06;
          ENDIF
.
          GOTO      PMAD9999
.
PMAD0110  MATCH     "005",PMDERTYP
          IF        @EQUAL
            WRITE     HTMLFILE;PMDEFL07;
          ENDIF
.
          MATCH     "007",PMDERTYP
          IF        @EQUAL
            WRITE     HTMLFILE;PMDEFL07;
          ENDIF
.
          MATCH     "008",PMDERTYP
          IF        @EQUAL
            MATCH     SP70,PMDEFL07
            IF        !@EQUAL
              MOVE      "Gi",CATEGORY   
              MOVE      PMDEFL07,CODE
              PACK      KEY5,CATEGORY,CODE,SP70
              CALL      RDCODE1
              IF        OVRCD=0
                WRITE     HTMLFILE;ACODE," - ",TDESC;
              ELSE
                WRITE     HTMLFILE;CODE," - Description not found";
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     "010",PMDERTYP
          IF        @EQUAL
            WRITE     HTMLFILE;PMDEFL07;
          ENDIF
.
          GOTO      PMAD9999
.
PMAD0120  MATCH     "005",PMDERTYP
          IF        @EQUAL
            WRITE     HTMLFILE;PMDEFL08;
          ENDIF
.
          MATCH     "007",PMDERTYP
          IF        @EQUAL
            WRITE     HTMLFILE;PMDEFL08;
          ENDIF
.
          MATCH     "008",PMDERTYP
          IF        @EQUAL
            WRITE     HTMLFILE;PMDEFL08;
          ENDIF
          GOTO      PMAD9999
.
PMAD0130  MATCH     "005",PMDERTYP
          IF        @EQUAL
            WRITE     HTMLFILE;PMDEFL09;
          ENDIF
.
          MATCH     "007",PMDERTYP
          IF        @EQUAL
            MATCH     SP70,PMDEFL09
            GOTO      PMAD9999 IF EQUAL
            UNPACK    PMDEFL09,CCENT,CYEAR,CMON,CDAY
.           MOVE      CMON,F2
.           LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.           PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.           WRITE     HTMLFILE;KEY11;
            WRITE     HTMLFILE;CDAY,SLASH,CMON,SLASH,CCENT,CYEAR
          ENDIF
.
          MATCH     "008",PMDERTYP
          IF        @EQUAL
            MATCH     SP70,PMDEFL09
            IF        !@EQUAL
              MOVE      "Gp",CATEGORY
              MOVE      PMDEFL09,CODE
              PACK      KEY5,CATEGORY,CODE,SP70
              CALL      RDCODE1
              IF        OVRCD=0
                WRITE     HTMLFILE;ACODE," - ",TDESC;
              ELSE
                WRITE     HTMLFILE;CODE," - Description not found";
              ENDIF
            ENDIF
          ENDIF
          GOTO      PMAD9999
.
PMAD0140  MATCH     "005",PMDERTYP
          IF        @EQUAL
            WRITE     HTMLFILE;PMDEFL10;
          ENDIF
.
          MATCH     "007",PMDERTYP
          IF        @EQUAL
            MATCH     "1",PTCNNEWC
            IF        @EQUAL
              MATCH     SP70,PMDEFL10
              IF        !@EQUAL
                MOVE      "tc",CATEGORY
                MOVE      PMDEFL10,CODE
.
                PACK      KEY5,CATEGORY,CODE,SP70
                CALL      RDCODE1
                IF        OVRCD=0
                  WRITE     HTMLFILE;ACODE," - ",TDESC;
                ELSE
                  WRITE     HTMLFILE;CODE," - Description not found";
                ENDIF
              ELSE
                WRITE     HTMLFILE;PMDEFL10;
              ENDIF
            ELSE
              WRITE     HTMLFILE;PMDEFL10;
            ENDIF
          ENDIF
.
          MATCH     "008",PMDERTYP
          IF        @EQUAL
            WRITE     HTMLFILE;PMDEFL10;
          ENDIF
          GOTO      PMAD9999
.
PMAD0150  PACK      KEY10,PMDECUID,SP70
          CALL      RDWBSE1
          IF        OVRCD=0
            WRITE     HTMLFILE;WBSENAM;
          ENDIF
          GOTO      PMAD9999
.
PMAD9999  RETURN
.
.****************************************************************************
.*                              THBL0000       Called by: PATLST00,MRVTAB00 *
.*                                                        ALLTAB00,ALLVIS00 *
.*                                                        VISROW00          *
.*               Assign Theatre Booking Icon if required for Inpatient      *
.****************************************************************************
.
THBL0000  MOVE      "",VISTLINK
          CLEAR     VISTLINK
          APPEND    VISTTYPE,VISTLINK
.
.         Only required for Inpatient if enabled
          MATCH     "IP",VISTTYPE
          IF        !@EQUAL
            GOTO      THBL9999
          ENDIF
          MATCH     "1",OPCNDTSV
          IF        !@EQUAL
            GOTO      THBL9999
          ENDIF
.
          PACK      KEY8,PVIBILL,SP70
          CALL      RDBKREC1
          BRANCH    OVRCD,THBL9999
.
.         Confirm an operation exist for booking
          PACK      KEY31,BKREBOOK,SP70
          CALL      RSOPDEA2
          CALL      RKOPDEA2
          BRANCH    OVRCD,THBL9999
          MATCH     KEY8,OPDAADMN
          GOTO      THBL9999 IF NOT EQUAL
.
          REP       " +",URNUMBER
          MOVE      PVIBILL,DIM8
          REP       " +",DIM8
.
.         Append Dframe and icon after VISTTYPE
          APPEND    "&nbsp;<a href=#javascript:DFrameLink('",VISTLINK
          APPEND    "oprweb06.pbl?reportno=11&template=008",VISTLINK
          APPEND    "&urnumber=",VISTLINK
          APPEND    URNUMBER,VISTLINK
          APPEND    "&admissno=",VISTLINK
          APPEND    DIM8,VISTLINK
.
.         Dframe Top,Left,Width,Height
          APPEND    "',0,((document.body.clientWidth-1000)/2),1000,700);>",VISTLINK
.
          APPEND    "<img src='../images/EditIcon.gif'></a>",VISTLINK
          RESET     VISTLINK
.
          REP       "+ ",URNUMBER
          REP       "+ ",DIM8
THBL9999  RETURN
.
.------------------------------------------------------------
. Display Preadmission Notes
.------------------------------------------------------------
WTPACM00  COMPARE   ONE,BRECFLAG
          GOTO      WTPACM99 IF EQUAL
          PACK      KEY21,BKREURNO,BKREPROC,DBKRECNT,SP70
          CALL      RSWTPAC1
WTPACM10  CALL      RKWTPAC1
          BRANCH    OVRCD,WTPACM99
          MATCH     BKREURNO,WTPCURNO
          GOTO      WTPACM99 IF NOT EQUAL
          MATCH     BKREPROC,WTPCPCOD
          GOTO      WTPACM99 IF NOT EQUAL
          MATCH     DBKRECNT,WTPCPCNT
          GOTO      WTPACM10 IF NOT EQUAL
          STRIP     WTPCCOMM
          MOVELPTR  WTPCCOMM,F3
          IF        F3>0
            SFORMAT   VAR,F3
          ELSE
            SFORMAT   VAR,1
          ENDIF
          MOVE      WTPCCOMM,VAR
          WRITE     HTMLFILE;VAR
          SFORMAT   VAR,127
.
          GOTO      WTPACM10
.
WTPACM99  RETURN
+
.------------------------------------------------------------
. Additional HCPs Indicator for ALREDEPT
.------------------------------------------------------------
INDHCP00  MOVE      SP70,DOCINDIC
.
          MATCH     SP70,ALREDEPT
          GOTO      INDHCP99 IF EQUAL
          GOTO      INDHCP99 IF EOS
.
          MOVE      ALREDEPT,CODE
          MOVE      "CG",CATEGORY
          CALL      GETCOD00
.
          MATCH     "A",TCINDC22
          GOTO      INDHCP99 IF NOT EQUAL
.
          MOVE      "1",DOCINDIC
.
INDHCP99  RETURN
.
.
.------------------------------------------------------------
. Additional HCPs
.------------------------------------------------------------
ADDHCP00  MOVE      SP70,DOCFNAM3
          MOVE      SP70,DOCFNAM4
          MOVE      SP70,DOCFNAM5
          MOVE      SP70,DOCFNAM6
.         MOVE      SP70,DOCINDIC
.
.         MOVE      ALREDEPT,CODE
.         MOVE      "CG",CATEGORY
.         CALL      GETCOD00
.
.         MATCH     "A",TCINDC22
.         GOTO      ADDHCP99 IF NOT EQUAL
.
.         MOVE      "1",DOCINDIC
.
          MATCH     "1",DOCINDIC
          GOTO      ADDHCP99 IF NOT EQUAL
.
          MATCH     SP70,ALREUHC2
          IF        !@EQUAL
            PACK      KEY10,ALREUHC2,SP70
            CALL      RDPMHCP1
            IF        OVRCD=0
              MOVE      PMHCTITL,FMTTITLE
              MOVE      PMHCGNAM,FMTGNAME
              MOVE      PMHCSNAM,FMTSNAME
              CALL      DOCNM000
              MOVE      DOCFNAME,DOCFNAM3
            ENDIF
          ENDIF
.
          MATCH     SP70,ALREUHC3
          IF        !@EQUAL
            PACK      KEY10,ALREUHC3,SP70
            CALL      RDPMHCP1
            IF        OVRCD=0
              MOVE      PMHCTITL,FMTTITLE
              MOVE      PMHCGNAM,FMTGNAME
              MOVE      PMHCSNAM,FMTSNAME
              CALL      DOCNM000
              MOVE      DOCFNAME,DOCFNAM4
            ENDIF
          ENDIF
.
          MATCH     SP70,ALREUHC5
          IF        !@EQUAL
            PACK      KEY10,ALREUHC5,SP70
            CALL      RDPMHCP1
            IF        OVRCD=0
              MOVE      PMHCTITL,FMTTITLE
              MOVE      PMHCGNAM,FMTGNAME
              MOVE      PMHCSNAM,FMTSNAME
              CALL      DOCNM000
              MOVE      DOCFNAME,DOCFNAM5
            ENDIF
          ENDIF
.
          MATCH     SP70,ALREUHC6
          IF        !@EQUAL
            PACK      KEY10,ALREUHC6,SP70
            CALL      RDPMHCP1
            IF        OVRCD=0
              MOVE      PMHCTITL,FMTTITLE
              MOVE      PMHCGNAM,FMTGNAME
              MOVE      PMHCSNAM,FMTSNAME
              CALL      DOCNM000
              MOVE      DOCFNAME,DOCFNAM6
            ENDIF
          ENDIF
.
ADDHCP99  RETURN
+
.------------------------------------------------------------------------------
.         Remote Scripting Functions (REMOTENO)
.------------------------------------------------------------------------------
REMOTE00  CALL      XMLHED00
          BRANCH    EXIT,REMOTE99
.
          BRANCH    REMOTENO,REMOTE10,REMOTE20
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    " INVALID REMOTE NUMBER ":
                    "</RETURN_VALUE>"
          GOTO      REMOTE98
.
REMOTE10  CALL      VALDSR00           * Validate Diagnostic Service Request
          GOTO      REMOTE98
.
REMOTE20  CALL      VALHGE00           * Validate HCP GUID1 / GUID2 exists
          GOTO      REMOTE98
.
REMOTE98  CALL      XMLEND00
REMOTE99  RETURN
+
.------------------------------------------------------------------------------
.         Validate Diagnostic Service Request 
.
.         1. Verify User Id & Password
.         2. Verify Linked Doctor Code
.------------------------------------------------------------------------------
VALDSR00  MOVE      ZERO,EXIT
.
          MATCH     "1",PTCNSUID
          IF        @EQUAL
            PACK      KEY10,SECUREID,SP70   * Using web user id for application
            CALL      RDWBSE1               * authentication
            BRANCH    OVRCD,VALDSR91
.
            PACK      SECUREID,WBSELOGN,SP256    * re set to login name
          ELSE
            PACK      KEY80,SECUREID,SP256
            CALL      RDWBSE7
            IF        OVRCD=1
              REP       LOWUPP,KEY80
              CALL      RDWBSE7
              BRANCH    OVRCD,VALDSR91
            ENDIF
          ENDIF
.
          CALL      VFYUSR00
          BRANCH    EXIT,VALDSR91
.
          IF        VALDTYPE=1
            MATCH     "1",WBSEGENR
            GOTO      VALDSR92 IF EQUAL     * Generic User ID
          ENDIF
.
          MATCH     SP70,WBSEDOC
          GOTO      VALDSR93 IF EQUAL
.
          PACK      KEY10,WBSEDOC,SP10
          CALL      RDPMHCP1
          BRANCH    OVRCD,VALDSR94
.
          MATCH     SP70,PMHCPRV1
          GOTO      VALDSR95 IF EQUAL
.
          MATCH     SP70,PMHCDEAC
          GOTO      VALDSR90 IF EQUAL  * No Accreditation Expiry Date
.
          CALL      IBACLOCK
          PACK      TODAY,CCC,CYY,CMM,CDD
          REP       " 0",TODAY 
.
          MATCH     TODAY,PMHCDEAC     * Accreditation Expiry Date before today
          GOTO      VALDSR96 IF LESS
.
VALDSR90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>",ZERO,"</RETURN_VALUE>"
          GOTO      VALDSR99           * Validation PASSED
.
VALDSR91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>",ONE,"</RETURN_VALUE>"
          GOTO      VALDSR99           * Invalid User Id & Password
.
VALDSR92  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>",TWO,"</RETURN_VALUE>"
          GOTO      VALDSR99           * Username must not be a Generic User ID
.
VALDSR93  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>",THREE,"</RETURN_VALUE>"
          GOTO      VALDSR99           * No Linked Doctor Code
.
VALDSR94  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>",FOUR,"</RETURN_VALUE>"
          GOTO      VALDSR99           * Doctor Code not found
.
VALDSR95  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>",FIVE,"</RETURN_VALUE>"
          GOTO      VALDSR99           * No Provider Number for Doctor Code
.
VALDSR96  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>",SIX,"</RETURN_VALUE>"
          GOTO      VALDSR99           * Accreditation Expiry Date in the past
.
VALDSR99  RETURN
+
.------------------------------------------------------------------------------
.         Validate GUID1/GUID2 exists for HCP / Practice (non-empty value)
.------------------------------------------------------------------------------
VALHGE00  MATCH     SP70,VALDGHCP
          GOTO      VALHGE90 IF EQUAL
          GOTO      VALHGE90 IF EOS
.
          PACK      KEY10,VALDGHCP,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,VALHGE91
.
          MATCH     SP70,PMHCSMD1           * SMD GUID value 1
          GOTO      VALHGE90 IF NOT EQUAL
.
          MATCH     SP70,PMHCSMD2           * SMD GUID value 2
          GOTO      VALHGE90 IF NOT EQUAL
.
.
.         Now check Linked Practices ...
.
          PACK      KEY20,KEY10,SP70
          CALL      RSPMHCL1
VALHGE10  CALL      RKPMHCL1
          BRANCH    OVRCD,VALHGE91
.
          MATCH     PMHCHCPC,PMHLHCPC       * Same Linked HCP?
          GOTO      VALHGE91 IF NOT EQUAL
.
          PACK      KEY12,PMHLHCPR,SP70
          CALL      RSPMHCG1
VALHGE20  CALL      RKPMHCG1
          BRANCH    OVRCD,VALHGE10
.
          MATCH     PMHLHCPR,PMHGPRAC       * Same Linked Practice?
          GOTO      VALHGE10 IF NOT EQUAL
.
          MATCH     SP70,PMHGSMD1           * SMD GUID value 1
          GOTO      VALHGE90 IF NOT EQUAL
.
          MATCH     SP70,PMHGSMD2           * SMD GUID value 2
          GOTO      VALHGE90 IF NOT EQUAL
.
          GOTO      VALHGE20
.
VALHGE90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>",ZERO,"</RETURN_VALUE>"
          GOTO      VALHGE99           * Validation PASSED
.
VALHGE91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>",ONE,"</RETURN_VALUE>"
          GOTO      VALHGE99           * Validation FAILED
.
VALHGE99  RETURN
.
.*******************************************************************************
.         Look for a Contract ID for the DRG Code
.*******************************************************************************
LCNT0000  PACK      KEY5,ANSC,ANSL,ACLAIM,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,LCNT9000
.
          MATCH     "A",TCINDC2
          GOTO      LCNT9000 IF NOT EQUAL
.
          PACK      KEY9,ACLAIM,AFUNDH,SP70
          CALL      GETCNEFF               * Get Contract Effective From
          BRANCH    EXIT,LCNT9000
.
          MOVE      ADATE,CEFFDATE         * default to admission date
          IF        ASTAT=3
            MOVE      DDATE,KEY8           * Discharged date
          ELSE
            PACK      KEY8,CCC,CYY,CMM,CDD * Use Current date
            REP       " 0",KEY8
          ENDIF
          LOAD      CEFFDATE,CNTRCEFR,ADATE,KEY8
.
          OPEN      PMSPWAA1,"pmspwaaf"
          OPEN      PMSPWAA2,"pmspwaaf"
.
          PACK      KEY10,DDRGCODE,SP70
          CALL      RSPMPWA2
LCNT1000  CALL      RKPMPWA2
          BRANCH    OVRCD,LCNT9000
.
          MATCH     PMPWDRGC,DDRGCODE
          GOTO      LCNT9000 IF NOT EQUAL     * Different DRG Code
.
          MOVE      PMPWCNTR,KEY6
          CALL      VALCONTR                 * Validate Contract ID
          BRANCH    EXIT,LCNT1000
.
          MOVE      PMPWCNTR,CONTRCID        * Yes found a valid contract
.
          GOTO      LCNT9999
.
LCNT9000  MOVE      SP70,CONTRCID            * No valid contract
.
LCNT9999  RETURN
+
.------------------------------------------------------------
. Get HCP 1 for FHIR Response.
.------------------------------------------------------------
FHRDO100  MOVE      SP70,FHRDOCC1
          MOVE      SP70,FHRDOCT1
          MOVE      SP70,FHRDOCN1
.
          MATCH     "emergency",FHRCLAS
          GOTO      FHRDO150 IF EQUAL
.
          MATCH     SP70,ADOCTA
          GOTO      FHRDO199 IF EQUAL
.
          PACK      KEY10,ADOCTA,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,GFRDOC99
.
          CLEAR     FHRDOCC1
          APPEND    "HCP-",FHRDOCC1
          APPEND    ADOCTA,FHRDOCC1
          RESET     FHRDOCC1
          MOVE      "ADM",FHRDOCT1 *  Doctor Type
          SQUEEZE   PMHCTITL
          SQUEEZE   PMHCSNAM
          MOVE      PMHCGNAM,DIM1
          PACK      FHRDOCN1,PMHCTITL,SP1,DIM1,DOT,SP1,PMHCSNAM,SP70
.
          GOTO      FHRDO199
.
FHRDO150  MATCH     SP70,EMVIDOCT
          GOTO      FHRDO199 IF EQUAL
.
          PACK      KEY10,EMVIDOCT,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,GFRDOC99
.
          CLEAR     FHRDOCC1
          APPEND    "HCP-",FHRDOCC1
          APPEND    EMVIDOCT,FHRDOCC1
          RESET     FHRDOCC1
          MOVE      "ADM",FHRDOCT1 *  Doctor Type
          SQUEEZE   PMHCTITL
          SQUEEZE   PMHCSNAM
          MOVE      PMHCGNAM,DIM1
          PACK      FHRDOCN1,PMHCTITL,SP1,DIM1,DOT,SP1,PMHCSNAM,SP70
.
FHRDO199  RETURN
+
.------------------------------------------------------------
. Get HCP 2 for FHIR Response.
.------------------------------------------------------------
FHRDO200  MOVE      SP70,FHRDOCC2
          MOVE      SP70,FHRDOCT2
          MOVE      SP70,FHRDOCN2
.
          MATCH     SP70,PMVXEDC1
          GOTO      FHRDO299 IF EQUAL
.
          PACK      KEY10,PMVXEDC1
          CALL      RDPMHCP1
          BRANCH    OVRCD,GFRDOC99
.
          CLEAR     FHRDOCC2
          APPEND    "HCP-",FHRDOCC2
          APPEND    PMVXEDC1,FHRDOCC2
          RESET     FHRDOCC2
          MOVE      "CON",FHRDOCT2
          SQUEEZE   PMHCTITL
          SQUEEZE   PMHCSNAM
          MOVE      PMHCGNAM,DIM1
          PACK      FHRDOCN2,PMHCTITL,SP1,DIM1,DOT,SP1,PMHCSNAM,SP70
.
FHRDO299  RETURN
+
.------------------------------------------------------------------------------
. FHIR Encounter Resource
.------------------------------------------------------------------------------
RESPRA00  MOVE      PMHCADR1,PRACNAME       * use hcp details
          MOVE      PMHCADR2,PRACADD1
          MOVE      SP70,PRACADD2
          MOVE      PMHCADR3,PRACADD3
          MOVE      PMHCADR4,PRACADD4
          MOVE      PMHCPOST,PRACPOST
          MOVE      PMHCSEML,PRACPEML
          MOVE      PMHCSTEL,PRACPTEL
          MOVE      PMHCFAXN,PRACPFAX
          MOVE      PMHCPRV1,PRACPROV
          PACK      DISPPRAC,SP70
          PACK      DISPPNAM,SP70,SP70
          PACK      DISPPCNT,SP70
.
          MOVE      "DT",TCODE
          PACK      KEY5,TCODE,PMHCSPC1,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      SP70,TDESC
          ENDIF
          CALL      HCPNAME0
          WRITE     HTMLFILE;*+," { #"resourceType#": #"Practitioner#",":
                    "   #"id#": #"HCP-",PMHCHCPC,"#",":
                    " #"extension#": [":
                    " { #"url#":#"%BASEURL/extension/webPASService#"":
                        " ,#"valueString#":#"",PRGID,SP1,PRGNAM,SP1,VERSION,"#"},":
                    " { #"url#":#"%BASEURL/extension/webPASTemplate#"":
                        " ,#"valueString#":#"%TEMPLATEHOME/",WBTPFIL," %TEMPLATEVERSION#"},":
                    " { #"url#":#"%BASEURL/extension/dxc-hc-speciality#"":
                        " ,#"valueString#":#"",TDESC,"#"}":
                    " ],":
                    " #"identifier#": [ ":
                    "  {#"type#": { #"text#" : #"HCP ID#" },":
                    "   #"value#": #"",PMHCHCPC,"#" },":
                    "  {#"type#": { #"text#" : #"Provider Number#" },":
                    "   #"value#": #"",PRACPROV,"#" }":
                    "    ] ,":
                    " #"name#": [ { ":
                    "  #"use#": #"usual#",":
                    "  #"text#": #"",DOCFNAME,"#" ,":
                    "  #"prefix#":[ #"",PMHCTITL,"#" ],":
                    "  #"given#": [ #"",PMHCGNAM,"#" ],":
                    "  #"family#": #"",PMHCSNAM,"#" } ],":
                    "  #"telecom#": [ ":
                    "   { #"system#": #"phone#", #"use#": #"work#", ":
                    "     #"value#": #"",PRACPTEL,"#" },":
                    "   { #"system#": #"email#", #"use#": #"work#", ":
                    "     #"value#": #"",PRACPEML,"#" },":
                    "   { #"system#": #"phone#", #"use#": #"mobile#", ":
                    "     #"value#": #"",PMHCMOBN,"#" },":
                    "   { #"system#": #"fax#",   #"use#": #"work#", ":
                    "     #"value#": #"",PRACPFAX,"#" } ],":
                    " #"address#": [ {":
                    "  #"use#": #"work#",":
                    "  #"line#": [#"",PRACNAME,"#"":
                    ",#"",PRACADD1,"#"";
          MATCH     SP70,PRACADD2
          IF        !@EQUAL
            STRIP     PRACADD2
            WRITE     HTMLFILE;*+,",#"",PRACADD2,"#"";
          ENDIF
          WRITE     HTMLFILE;*+,"],":
                      "       #"city#": #"",PRACADD3,"#",":
                      "       #"state#": #"",PRACADD4,"#",":
                      "       #"postalCode#": #"",PRACPOST,"#"":
                      "      }":
                      "    ]";
          WRITE     HTMLFILE;*+,"  }";
          RETURN
+
.------------------------------------------------------------------------------
. Format HCP Name in Title Text
.------------------------------------------------------------------------------
HCPNAME0  MOVE      PMHCTITL,FMTTITLE
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000
          RETURN
.
.------------------------------------------------------------------------------
. FHIR Location Resource for Ward.
.------------------------------------------------------------------------------
RESWRD00  STRIP     WBDESC
          STRIP     PTHSHOSP
          CLEAR     KEY16
          APPEND    "Ward-",KEY16
          APPEND    WWARD,KEY16
          APPEND    SP70,KEY16
          RESET     KEY16
          STRIP     WBTPFIL
          WRITE     HTMLFILE;*+," { #"resourceType#": #"Location#",":
                    " #"id#": #"",KEY16,"#",":
                    " #"extension#": [":
                    " { #"url#":#"%BASEURL/extension/webPASService#"":
                        " ,#"valueString#":#"",PRGID,SP1,PRGNAM,SP1,VERSION,"#"},":
                    " { #"url#":#"%BASEURL/extension/webPASTemplate#"":
                        " ,#"valueString#":#"%TEMPLATEHOME/",WBTPFIL," %TEMPLATEVERSION#"}":
                    " ],":
                    " #"identifier#": { #"value#": #"",KEY16,"#"},":
                    " #"name#": #"",WBDESC,"#",":
                    " #"physicalType#": {":
                    "  #"coding#": [ {":
                    "   #"system#": #"http://hl7.org/fhir/location-physical-type#",":
                    "   #"code#": #"wa#",":
                    "   #"display#": #"Ward#"  } ] },";
          MATCH     SP70,WEXTN
          IF        !@EQUAL
             WRITE     HTMLFILE;*+," #"telecom#": [":
                       "{ #"system#": #"phone#",":
                       "  #"value#": #"",WEXTN,"#" } ],";
          ENDIF
          WRITE     HTMLFILE;*+," #"partOf#": { ":
                    "  #"reference#": #"Location/Hospital-",PTWDHOSN,"#"":
                    " } } ";
          RETURN
+
.------------------------------------------------------------------------------
. FHIR Location Resource for Bed
.------------------------------------------------------------------------------
RESBED00  MOVE      "BT",CATEGORY
          MOVE      WEFRBT,CODE
          CALL      GETCOD00
          MOVE      TDESC,BEDTDES1
.
          MOVE      "RT",CATEGORY
          MOVE      WRTYPE,CODE
          CALL      GETCOD00
          MOVE      TDESC,ROOMDESC
.
          MOVE      CATBW,CATEGORY
          MOVE      PTWDIFST,CODE
          CALL      GETCOD00
          MOVE      TDESC,IFSTDESC
.
          COMPARE   ZERO,WACTIVE
          IF        @EQUAL
            MOVE      "true",ACTVDESC
          ELSE
            MOVE      "false",ACTVDESC
          ENDIF
          STRIP     PTHSHOSP
          STRIP     WBTPFIL
.
          CLEAR     KEY16
          APPEND    "Bed-",KEY16
          PACK      WWARD,WWARD,SP70
          APPEND    WWARD,KEY16
          APPEND    WBED,KEY16
          APPEND    SP70,KEY16
          RESET     KEY16
          STRIP     KEY16
          REP       " -",KEY16
          STRIP     WWARD
.
          WRITE     HTMLFILE;*+,"{#"resourceType#": #"Location#",":
                    " #"id#": #"",KEY16,"#",":
                    " #"extension#": [":
                    " { #"url#":#"%BASEURL/extension/webPASService#"":
                        " ,#"valueString#":#"",PRGID,SP1,PRGNAM,SP1,VERSION,"#"},":
                    " { #"url#":#"%BASEURL/extension/webPASTemplate#"":
                        " ,#"valueString#":#"%TEMPLATEHOME/",WBTPFIL," %TEMPLATEVERSION#"}":
                    " ],":
                    " #"identifier#": { #"value#": #"",KEY16,"#"},":
                    " #"name#": #"",WBDESC,"#",":
                    " #"physicalType#": {":
                    "  #"coding#": [ {":
                    "   #"system#": #"http://hl7.org/fhir/location-physical-type#",":
                    "   #"code#": #"bd#",":
                    "   #"display#": #"Bed#"  } ] },";
.
          MATCH     SP70,WEXTN
          IF        !@EQUAL
             WRITE     HTMLFILE;*+," #"telecom#": [":
                       "{ #"system#": #"phone#",":
                       "  #"value#": #"",WEXTN,"#" } ],";
          ENDIF
          WRITE     HTMLFILE;*+," #"partOf#": { ":
                    "       #"reference#": #"Location/Ward-",WWARD,"#"":
                    " } } "
.
          RETURN
+
.------------------------------------------------------------------------------
. FHIR Location Resource for EmergencyLocation.
.------------------------------------------------------------------------------
RESEST00  STRIP     EMLODESC
          STRIP     DIM3
          CLEAR     KEY25
          APPEND    "EmergencyLocation-",KEY25
          APPEND    EMVILOCN,KEY25
          APPEND    SP70,KEY25
          RESET     KEY25
          STRIP     WBTPFIL
          WRITE     HTMLFILE;*+," { #"resourceType#": #"Location#",":
                    " #"id#": #"",KEY25,"#",":
                    " #"extension#": [":
                    " { #"url#":#"%BASEURL/extension/webPASService#"":
                        " ,#"valueString#":#"",PRGID,SP1,PRGNAM,SP1,VERSION,"#"},":
                    " { #"url#":#"%BASEURL/extension/webPASTemplate#"":
                        " ,#"valueString#":#"%TEMPLATEHOME/",WBTPFIL," %TEMPLATEVERSION#"}":
                    " ],":
                    " #"identifier#": { #"value#": #"",KEY25,"#"},":
                    " #"name#": #"",EMLODESC,"#",":
                    " #"physicalType#": {":
                    "  #"coding#": [ {":
                    "   #"system#": #"http://hl7.org/fhir/location-physical-type#",":
                    "   #"code#": #"ro#",":
                    "   #"display#": #"Room#"  } ] } ";
.          MATCH     SP70,WEXTN
.          IF        !@EQUAL
.             WRITE     HTMLFILE;*+," #"telecom#": [":
.                       "{ #"system#": #"phone#",":
.                       "  #"value#": #"",WEXTN,"#" } ],";
.          ENDIF
.
          MATCH     SP70,DIM3
          IF        !@EQUAL & !@EOS
            WRITE     HTMLFILE;*+,",#"partOf#": { ":
                      "  #"reference#": #"Location/Hospital-",DIM3,"#"":
                      " } } ";
          ELSE
            WRITE     HTMLFILE;*+,"} ";
          ENDIF
.
          RETURN
+
.******************************************************************************
. JSON Outpatient Appointments
.------------------------------------------------------------------------------
.
DSCH0000  UNPACK    DIM127,D1,KEY3,DIM127
          MOVE      KEY3,FLDITMNO
.
          BRANCH    FLDITMNO,DSCH0100
          GOTO      DSCH9999
.
DSCH0100  CALL      OTRF0000
          GOTO      DSCH9999
.
DSCH9999  RETURN
+
.******************************************************************************
. JSON Outpatient Appointments
.------------------------------------------------------------------------------
.
OTRF0000  IF        FHIRTYPE=0
            WRITE     HTMLFILE;"function AddAppointmentRows() {"
          ENDIF
OTRF0100  MOVE      ZERO,ROWCOUNT
          MOVE      ZERO,DISNUMB
          PACK      KEY36,URNUMBER,SP70
          CALL      RDSBOKA3
OTRF0150  CALL      RDKBOKA3
          BRANCH    OVRCD,OTRF9000
.
          MATCH     OBAURNO,URNUMBER
          GOTO      OTRF9000 IF NOT EQUAL
.
          MATCH     CURRDATE,OBADATE
          GOTO      OTRF0150 IF LESS
.
          PACK      KEY12,OBASITE,OBACTYP,SP70
          CALL      RDCTYA1
          IF        OVRCD=1
            MOVE      SP70,OCTDESC
          ENDIF
.
          PACK      KEY20,OBASITE,OBACLIN,OBADATE,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          BRANCH    OVRCD,OTRF0150
.
          MOVE      "CV",CATEGORY
          MOVE      OBAVISIT,CODE
          CALL      GETCOD00
          MOVE      TDESC,VTYPDESC
.
          WRITE     HTMLFILE;"t.addRow(",QUOTE,OBATIME,QUOTE,COMMA,QUOTE;
          UNPACK    OBADATE,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEEK
          MOVE      CMON,F2
          LOAD      DAYNAM3,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;DAYNAM3," ",CDAY," ",MTHNAM3," ",CCENT,CYEAR,QUOTE:
                             COMMA,QUOTE,OCTDESC,QUOTE:
                             COMMA,QUOTE,OCADESC,QUOTE:
                             COMMA,QUOTE,OBADATE,OBATIME,QUOTE:
                             COMMA,QUOTE,VTYPDESC,QUOTE,");"
          GOTO      OTRF0150
.
OTRF9000  IF        FHIRTYPE=0
            WRITE     HTMLFILE;" }"
          ENDIF
          GOTO      OTRF9999
.
OTRF9999  RETURN
+
.******************************************************************************
.
          INC       ALLLNKIO/INC
          INC       APSMASIO/INC
          INC       ARCVX1IO/INC
          INC       BOKDIAIO/INC
          INC       BOKLETIO/INC
          INC       BOKRC1IO/INC
          INC       CLBOKRC1
          INC       CLACCAUD                    * Clear ACC Audit file variables
          INC       BOKRX1IO/INC
          INC       BOKRQ1IO/INC
          INC       EMRLOCIO/INC
          INC       EMRUNKIO/INC
          INC       EMRVISIO/INC
          INC       MLTSECIO/INC
          INC       PMSUCHIO/INC
          INC       PMSUCDIO/INC
          INC       PATDGWIO/INC
          INC       PATCHCIO/INC
          INC       VISMDTIO/INC
          INC       VISMTXIO/INC
          INC       PATDO1IO/INC
          INC       PATEORIO/INC
          INC       PATFACIO/INC
          INC       PATDSCIO/INC
          INC       PATFLTIO/INC
          INC       PATPEIIO/INC
          INC       PATIN1IO/INC
          INC       PATITMIO/INC
          INC       DISPATIO/INC
          INC       DISMASIO/INC
          INC       DISPTLIO/INC
          INC       OUTPREIO/INC
          INC       PATATRIO/INC
          INC       PATMA1IO/INC
          INC       PATMMBIO/INC
          INC       PMSDAUIO/INC
          INC       PATPA1IO/INC
          INC       PATPR1IO/INC
          INC       PATMI1IO/INC
          INC       PATRE1IO/INC
          INC       PATRGMIO/INC
          INC       PATTRNIO/INC
          INC       PATVISIO/INC
          INC       NZPSPRIO/INC
          INC       MEHDIAIO/INC
          INC       MEHDS1IO/INC
          INC       MEHVI1IO/INC
          INC       MEHLEGIO/INC
          INC       PATWR1IO/INC
          INC       PATWC1IO/INC
          INC       PMSCHAIO/INC
          INC       PMSWTRIO/INC
          INC       PMSWX1IO/INC
          INC       ACCAUDIO/INC
          INC       ACCCMTIO/INC   * ACC Comments File
          INC       ACCDIAIO/INC
          INC       ACCRFPIO/INC
          INC       ACCLODIO/INC   * ACC Claim Lodgements
          INC       PMSADWIO/INC
          INC       PMSTLEIO/INC            * Patient Titles table
          INC       PMSWORIO/INC
          INC       PATWVEIO/INC
          INC       PMSCEXIO/INC
          INC       PMSRELIO/INC
          INC       PMSEVTIO/INC
          INC       PATFN1IO/INC
          INC       OPRSRGIO/INC
          INC       OPRARDIO/INC
          INC       OUTBOAIO/INC
          INC       OUTCANIO/INC
          INC       OUTRSHIO/INC
          INC       OUTBB1IO/INC
          INC       OUTMA1IO/INC
          INC       OUTHEDIO/INC
          INC       OUTSITIO/INC
          INC       OUTSESIO/INC
          INC       OUTCLIIO/INC
          INC       OUTCTYIO/INC
          INC       MRTAUCIO/INC
          INC       MRTLOCIO/INC
          INC       MRTMASIO/INC
          INC       MRTHISIO/INC
          INC       MRTSTFIO/INC
          INC       MRTPDSIO/INC
          INC       MRTVISIO/INC 
          INC       PATECOIO/INC
          INC       PATECDIO/INC
          INC       PATFIMIO/INC                                    * CAR 257776
          INC       PATGSRIO/INC
          INC       PATICDIO/INC
          INC       PATICOIO/INC
          INC       PATICUIO/INC
          INC       PATINVIO/INC
          INC       PATNIDIO/INC
          INC       PATONLIO/INC
          INC       PATALRIO/INC
          INC       PATPGRIO/INC
          INC       PATVADIO/INC
          INC       RESLNKIO/INC
          INC       PATW11IO/INC                                       *I-43498
          INC       PATW12IO/INC            * WIES12                   *I-51504
          INC       PTW12BIO/INC            * WIES12B
          INC       PATW13IO/INC            * WIES13
          INC       PATW14IO/INC            * WIES14                  *I-145161
          INC       PATW15IO/INC            * WIES15
          INC       PATW16IO/INC            * WIES16
          INC       PATW17IO/INC            * WIES17
          INC       PATW18IO/INC            * WIES18
          INC       PATW19IO/INC            * WIES19
          INC       PATW20IO/INC            * WIES20
          INC       PATW21IO/INC            * WIES21
          INC       PATWIEIO/INC            * WIES22
          INC       PATWMAIO/INC
          INC       PMSCDNIO/INC
          INC       PMSRUGIO/INC
          INC       PMSCTCIO/INC
          INC       PMSPX2IO/INC
          INC       BOKRECTM
          INC       BOKRX1TM
          INC       CLPMSVX1
          INC       DGCLICAC
          INC       DGCLICEC
          INC       DGCLICOB
          INC       DGCLICUP
          INC       NZPSPRTM
          INC       PATDOCTM
          INC       PMIGTNID
          INC       PMSEXTTM
          INC       PMSHCGTM
          INC       PMSHCPTM
          INC       PATMASTM
          INC       CLPMSPX2
          INC       CLPMSRES
          INC       PMSPX2TM
          INC       PATMSXTM
          INC       PATMISTM
          INC       PATCLMTM
          INC       PATRE1TM                * Person Responsible for Account
          INC       PATVISTM
          INC       PATDSCTM
          INC       OBSCNATM
          INC       OBSDIATM
          INC       NAMSTRCD
          INC       IBAWEBCD
          INC       GETDRG
          INC       CALCAGE
          INC       OBSCNAPR
          INC       OBSPALPR
          INC       CLBOKRQ1
          INC       CLPATMAS
          INC       CLPATMIS
          INC       CLPATDSC
          INC       CLPATDOC
          INC       CLPATVIS
          INC       CLALLREF
          INC       CLWEBSEC
          INC       DAYOFWEK
          INC       PMSCDNDS
          INC       CLPMSEXT
          INC       CLPATWC1
          INC       CLPMSWX1
          INC       IBALPCCD
.
          INC       IBALPCIO/INC
          INC       PATASFIO/INC
          INC       PATCFAIO/INC
          INC       PATSFAIO/INC
          INC       PATDADIO/INC
          INC       PATFX1IO/INC
          INC       PMSAIDIO/INC
          INC       PMSCCDIO/INC   * Concession Card Details
          INC       PMSEXTIO/INC
          INC       PMSOOSIO/INC
          INC       PMSVX1IO/INC
          INC       AAEDI1IO/INC
          INC       AAEDE1IO/INC
          INC       EMRSITIO/INC
          INC       PATHSPIO/INC
          INC       OUTDIAIO/INC
          INC       OUTRF1IO/INC
          INC       ALLREFIO/INC
          INC       ALLRLNIO/INC
          INC       ALLENCIO/INC
          INC       ALLPRRIO/INC
          INC       ALLCASIO/INC                                      *I-267008
          INC       ALLQUEIO/INC
          INC       WATPROIO/INC
          INC       WATTR1IO/INC
          INC       WATTX1IO/INC
          INC       WATPACIO/INC
          INC       ALLDEPIO/INC
          INC       OPRDEAIO/INC
          INC       PATCMCIO/INC
          INC       PATUNAIO/INC
          INC       PATQMHIO/INC
          INC       PRIHDBIO/INC                 * holding header file
          INC       PRIHREIO/INC                 * holding referral file
          INC       IBAALVIO/INC
.
          INC       WEBDATCD
          INC       CLCATCOM
          INC       CLPMSNUT
          INC       CLPATATR
          INC       CLPATCHC
          INC       PATFFLAB
          INC       PATGBCRN 
          INC       PATQMHTM
          INC       PATILTIO/INC
          INC       CATCOMIO/INC
          INC       PMSCIDIO/INC
          INC       PMSNUTIO/INC
          INC       PMSRESIO/INC
          INC       PMSTEMIO/INC
          INC       CATCOMTM
          INC       PMSNUTTM     
          INC       NHIMASIO/INC
          INC       NHIETHIO/INC
          INC       CLNHIMAS
          INC       MEHDLSIO/INC
          INC       OBSRESIO/INC
          INC       OBSPHYIO/INC
          INC       OBSCALIO/INC
          INC       OBSDITIO/INC
          INC       OBSMEDIO/INC
          INC       OBSPINIO/INC
          INC       OBSCNCIO/INC
          INC       OBSCNAIO/INC
          INC       OBSCNBIO/INC
          INC       OBSDIAIO/INC
          INC       OBSBPHIO/INC
          INC       OBSBHIIO/INC
          INC       OBSLABIO/INC
          INC       OBSPROIO/INC
          INC       OBSREAIO/INC
          INC       OUTLETIO/INC
          INC       PMSPWAIO/INC
          INC       VISPAYIO/INC
          INC       VISCMTIO/INC
          INC       EMRDCMIO/INC
          INC       EMRICDIO/INC
          INC       EMRVCDIO/INC
          INC       PMSQPTIO/INC
          INC       HL7INBIO/INC
          INC       HL7CISIO/INC
          INC       VISXDCIO/INC
.
          INC       NZHISWIO
          INC       TMPALIIO/INC
          INC       AAEMASTM
          INC       CHKWCCLM        *Check Multiple Workers comp    T0872408
          INC       CLPATRE1
          INC       CLOUTHED
          INC       CLOUTCAN
          INC       CLOUTRSH
          INC       CLBOKRX1
          INC       CLEMRVIS
          INC       CLPATFIM 
          INC       CLPATHSP
          INC       CLPATTRN
          INC       CLMEHDIA                * Clear mental health diag vars
          INC       CLMEHDIS                * Clear mental health disch vars
          INC       CLPMSDAU
          INC       CLPMSCHA 
          INC       TFILENAM
          INC       GETEFDRG
          INC       FHRDATCD    
          INC       VALCONTR
          INC       GETCNEFF
          INC       PRFAINSR
          INC       VISXDCTM
          INC       PATATRTM
.
          INC       MLTHCPIO/INC            * Multi Hospital HCP Codes
          INC       EMRDLAIO/INC            * Emergency EMR Deletion Audit
          INC       PMSEDGIO/INC       * Effective DRG Dates
          INC       OBSPCOIO/INC       * Observation Patient Correspondence
.
          INC       ATRFC000
          INC       COMPARIO/INC
          INC       BRHLCOMN
          INC       CLCOMPAR
          INC       GTCMPA00
          INC       DGCLII13
.
