.***************************************************************************
.* System    :   Emergencys                                                *
.* Program   :   FIXAEIPE                                                  *
.* Desc      :   Program to fix up Invoice pending (patipenf)              *
.***************************************************************************
.* Date      :   31/05/2022                                                *
.* Author    :   J.Tan       TSK 0915626                                   *
.* Function  :   This program will delete record from patipenf file if     *
.*               ABF Invoice raised and No to be invoiced amount           *
.* Modification:                                                           *
.*               V11.03.01 05/04/2023 Bella Turco     TSK 0911166          *
.*               Recompiled for PATIPERH - Hold Invoice Audit              *
.*               V11.02.01 29/06/2022 J.Tan           TSK 0920712          *
.*               Recompiled for ABFAECCL - I*D on emrvcdaf file            *
.*                                                                         *
.*-------------------------------------------------------------------------*
.
. FILE DESCRIPTION INCLUDES
. -------------------------
.
          INC       STD001FD
          INC       PATCOMM/INC
          INC       IBASEQFD/INC                 * Sequential Numbers File
          INC       TFILEVAR/INC                 * Generate Temp File Name
          INC       WEBERRFD/INC                 * Web Server Error Logging
.
          INC       AAEDE1FD/INC
          INC       AAEDEBFD/INC
          INC       AAEDTRFD/INC
          INC       IBASECFD/INC
          INC       IBAPASFD/INC
          INC       IBAGEDFD/INC
          INC       IBAGSTFD/INC
          INC       IBACONFD/INC
          INC       IBATMDFD/INC
          INC       IBATMHFD/INC
.
          INC       PATCALAG/INC
          INC       PATCFAFD/INC
          INC       PATCODFD/INC
          INC       PATCONFD/INC
.
          INC       PATDHEAD/INC
          INC       PATDINVS/INC
          INC       PATONHFD/INC
.
          INC       PATDGWFD/INC
          INC       PATDO1FD/INC
          INC       PATDRGFD/INC
          INC       PATDTRFD/INC
          INC       PATFINFD/INC
.
          INC       PATFX1FD/INC
          INC       PATFHIFD/INC
          INC       PATFN1FD/INC
          INC       PATFN2FD/INC
          INC       PATHSPFD/INC
          INC       PATINVFD/INC
          INC       PATIPEFD/INC
          INC       PATITMFD/INC
          INC       PATMA1FD/INC
          INC       PATMCHFD/INC
          INC       PATMI1FD/INC
          INC       PATRE1FD/INC
          INC       PATTRNFD/INC
          INC       PATVISFD/INC
          INC       PATWR1FD/INC
          INC       PMSEVTFD/INC
          INC       PMSHCPFD/INC
          INC       PMSMTIFD/INC
          INC       PMSVX1FD/INC
          INC       PRIITMFD/INC
.
          INC       EMRHTRFD/INC
          INC       EMRSITFD/INC
          INC       EMRHISFD/INC
          INC       EMRVISFD/INC
          INC       COMDEPFD/INC
          INC       RCPBNKFD/INC
          INC       RCPDTEFD/INC
          INC       RCPBDTFD/INC
          INC       RCPCONFD/INC
.

. LOCAL VARIABLE DEFINITION
. -------------------------
COUNTER   FORM      8
.
AECNFTYP  FORM      1
AECNCHRS  FORM      1
.
CURRDATE  DIM       8
CMDLINE   DIM       80
DIM4      DIM       4
.
EMCNGINV  DIM       1
EMCNDPOC  DIM       1
EMCNOPOC  DIM       15
.
FORM3A    FORM      3
FMTGNAME  DIM       35
FMTTITLE  DIM       10
FMTSNAME  DIM       35
HESYST    FORM      1
.
KEYFLAG   FORM      1
.
OPOCFLAG  FORM      1
RECNUMB   FORM      8
RECDELE   FORM      8
SERVDOCT  DIM       10
SAVAMNT   FORM      12.2
WBSEUID   DIM       10
.         Web Variables (only the include files use these variables)
.
NJAN      INIT      "January"
NFEB      INIT      "February"
NMAR      INIT      "March"
NAPR      INIT      "April"
NMAY      INIT      "May"
NJUN      INIT      "June"
NJUL      INIT      "July"
NAUG      INIT      "August"
NSEP      INIT      "September"
NOCT      INIT      "October"
NNOV      INIT      "November"
NDEC      INIT      "December"
.
HTMLFILE  FIFO      ASCII, FIXED=250
MTHNAM3   DIM       3
.
PRGID     INIT      "FIXAEIPE"
PRGNAM    INIT      "Fix EMR Invoice Pending file"
VERSION   INIT      "V12.00.00"
+
.**************************************************************************
.*                              ML0000                                    *
.*                      Controlling Logic (Mainline code)                 *
.**************************************************************************
.
ML0000    CALL      INIT0000               * initialisation and open files
.
ML0100    CALL      OPTN0000               * select options
          BRANCH    EXIT,ML9999            * EXIT = 1 if 0 chosen in menu
.
          CALL      CONTQST                * Ok to continue ?
          BRANCH    CEXIT,ML2000:          * yes
                          ML0100:          * no
                          ML0100           * cancel
.
ML2000    CALL      PROC0000               * process
.
ML9999    CHAIN     PGM                    * chain back to program
+
.****************************************************************************
.*                                INIT0000             Called by: ML0000    *
.*                             initialisation                               *
.*  The initialisation routine is used to display headings and open files.  *
.****************************************************************************
.
INIT0000  CALL      DISPHEAD                  * display heading
.
          DISPLAY   *P56:24,"Opening controlf";
          OPEN      CONTROLF,"controlf"
.
          READ      CONTROLF,ZERO;*43,IBCNMHOS,*85,IBCNUGST
.
          OPEN      PATVISA1,"patvisaf"
          OPEN      AAEDE1A1,"aaede1af"
          OPEN      PATMA1A1,"patma1af"
          OPEN      PATMX1A1,"patmx1af"
          OPEN      EMRVISA1,"emrvisaf"
          OPEN      PATCODE1,"patcodes"
.
          OPEN      PMSMTIA1,"pmsmtiaf"
          OPEN      PMSMTIA2,"pmsmtiaf"
          OPEN      PMSMTIA4,"pmsmtiaf"
          OPEN      PATTRAN2,"pattranf"
          OPEN      PATITEM1,"patitemn"
          OPEN      AAEDE1A1,"aaede1af"
          OPEN      AAEDTRE1,"aaedtref"
          OPEN      PATVISA1,"patvisaf"
          OPEN      PMSVX1A1,"pmsvx1af"
          OPEN      PATIPEN1,"patipenf"
.
...  used in ABFAECCL
          CALL      TFILENAM                * Get file name calculating Exponent
          MOVE      TFILNAME,FNAMEN
.
INIT9999  RETURN
+
.****************************************************************************
.*                                OPTN0000             Called by: ML0000    *
.*                        get user options or exit                          *
.*                                                                          *
.*    Returns:  EXIT    = FALSE (0)  Run clean up                           *
.*                        TRUE  (1)  Exit option selected                   *
.****************************************************************************
.
OPTN0000  DISPLAY   *P1:3,*EF,*P1:4,*V2LON,ZERO,*HOFF,". Exit":
                    *P1:5,*V2LON,ONE,*HOFF,". Run":
                    *P1:6,*V2LON,TWO,*HOFF,". Run and Update"
.
OPTN0500  KEYIN     *P1:8,*EL,"Select Option : ",*DV,UNDLN1:
                    *P17:8,*V2LON,XOPTION
.
          COMPARE   ZERO,XOPTION                 * exit selected ?
          GOTO      OPTN9500 IF EQUAL            * yes
.
          BRANCH    XOPTION,OPTN9000,OPTN9000    * run clean-up
.
          BEEP
          GOTO      OPTN0500
.
OPTN9000  MOVE      ZERO,EXIT
          GOTO      OPTN9999
.
OPTN9500  MOVE      ONE,EXIT
.
OPTN9999  RETURN
+
.**************************************************************************
.*                               PROC0000              Called by: ML0000  *
.*                                                                        *
.**************************************************************************
.
PROC0000  MOVE      ZERO,COUNTER
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,RECDELE
.
          PRINT     *1,"Admission No.",*15,"Visit Date"
.
          CALL      IBACLOCK
          REP       " 0",CDATE
          DISPLAY   *P1:18,"Started  : ",CDATE,SP1,CTIMEIS
.
          DISPLAY   *P1:21,*EL,"Admiss.No: ";
.
          PACK      KEY8,SP70
          CALL      RDSIPEN1
PROC1000  CALL      RDKIPEN1
          BRANCH    OVRCD OF PROC9000
.
          COMPARE   ONE,IPSYSTM
          GOTO      PROC1000 IF NOT EQUAL     * Not EMR
.
          CALL      CTBI0000                * Calculate to be invoiced
          GOTO      PROC1000
.
PROC9000  IF        XOPTION=2
            PRINT     *N,*1,"No of Records : ",RECNUMB:
                      *N,*1,"Deleted: ",RECDELE
          ELSE
            PRINT     *N,*1,"No of Records : ",RECNUMB
          ENDIF
.
          DISPLAY   *P1:20,*EF," No of Records: ",RECNUMB:
                    *P1:21,*EL," Delete : ",RECDELE
.
          CALL      IBACLOCK
          REP       " 0",CDATE
          DISPLAY   *P1:23,"Ended    : ",CDATE,SP1,CTIMEIS
          DISPLAY   *P1:24,*EL,"Finished processsing. ";
.
          CALL      HITENTER
.
PROC9999  RETURN
+
. =========================================================================
.         Calculate to be invoiced
. =========================================================================
CTBI0000  MOVE      IPADMNO,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD OF CTBI9999
.
          MOVE      PVIBILL,KEY8
          CALL      RDEMVIS1
          BRANCH    OVRCD OF CTBI9999
.
          CALL      RDDETA1
          BRANCH    OVRCD OF CTBI9999
          MOVE      AEDAFUND,AFUNDH
.
          MOVE      ADAURNO,PURNO
          MOVE      PURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD OF CTBI9999
.
          DISPLAY   *P30:21,*EL,IPADMNO;
.
          ADD       ONE,COUNTER
          IF        (COUNTER%100) = 0
            DISPLAY   *P15:21,*V2LON,COUNTER
          ENDIF
.
          MOVE      ONE,PROGFLAG
          MOVE      CPAGENO,FORM3A
          MOVE      ZERO,IBCNUGST         * set no GST for pending report
          MOVE      ZERO,NETTOT
          MOVE      ZERO,PRABFINV
          CALL      AAETBI
          MOVE      FORM3A,CPAGENO
.
.       If the invoice is for zero amount, and zero bed days, then ignore it
.
          COMPARE   ZERO,NETTOT
          GOTO      CTBI9999 IF NOT EQUAL
.
          ADD       ONE,RECNUMB
.
          COMPARE   TWO,XOPTION
          GOTO      CTBI1000 IF NOT EQUAL
.
          MOVE      IPADMNO,KEY8
          CALL      DEIPEN1
          ADD       ONE,RECDELE
.
CTBI1000  UNPACK    EMVIDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          PRINT     *1,IPADMNO,*15,CPCDATE
          GOTO      CTBI9999
.
CTBI9999  RETURN
+
. =========================================================================
.         I/O Includes
. =========================================================================
          INC       STD001IO
          INC       AAECATBI
          INC       AAEDE1IO/INC
          INC       AAEDTRIO/INC
          INC       CALCAGE
          INC       IBAGEDIO/INC
          INC       IBAGSTIO/INC
          INC       IBAPASIO/INC
          INC       IBASECIO/INC
          INC       IBATMDIO/INC
.
          INC       PATMCHRD
          INC       PATITMRD
          INC       CLPATINP
          INC       PATIPERH
.
          INC       PATHSPIO/INC
          INC       PATFHIIO/INC
          INC       PATFN1IO/INC
          INC       PRIITMIO/INC
          INC       PATCFAIO/INC
          INC       COMDEPIO/INC
          INC       PATFX1IO/INC
          INC       PATCODIO/INC
          INC       PATINPIO/INC
          INC       RCPDTEIO/INC
          INC       PMSEVTIO/INC
          INC       PATINVIO/INC
          INC       PATIPEIO/INC
          INC       PATITMIO/INC
          INC       PATMA1IO/INC
          INC       PATMCHIO/INC
          INC       PATVISIO/INC
          INC       PATONHIO/INC
          INC       PATWR1IO/INC
          INC       PMSHCPIO/INC
          INC       PMSMTIIO/INC
          INC       PMSVX1IO/INC
          INC       RCPBNKIO/INC
          INC       RCPBDTIO/INC
          INC       TFILENAM                     * Generate Temp File Name
.
          INC       IBASEQIO/INC                 * Sequential Numbers File
          INC       WEBERRIO/INC                 * Web Server Error Logging
.
          INC       EMRHTRIO/INC
          INC       EMRSITIO/INC
          INC       EMRHISIO/INC
          INC       EMRVISIO/INC
.
PATCALF
PRTEOL
NXTTRAN1
PEOL0000
PRLN0000
ENDPRT00
DOCNM000
ENDPRT    RETURN
.
