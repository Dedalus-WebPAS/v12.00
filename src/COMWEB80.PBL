.------------------------------------------------------------------------------
. Program       : COMWEB80
.
. Function      : Common XML Remote Scripting Code Validation Service
.
. Modifications : 
.------------------------------------------------------------------------------
.V12.00.02  24/07/2025  J.Tan          TSK 0962500
.           Mod TPAY0000 to check for U/R number
.V12.00.01  26/05/2025  PJ Le Febour     TSK 0955096 AlphaNum VisitNum
.           amend  COMPARE  ZERO,WADMNO  to MATCH ZEROVISN,WADMNO
.V11.05.06  14/04/2025  Davin            TSK 0951723
.           Recompiled for WEBGROUP - send 'I' procedures to grouper
.V11.05.05  27/03/2025  Davin            TSK 0956210
.           Recompiled for WEBGROUP - DRG Version 12.0
.V11.05.04  20/03/2025  Davin            TSK 0956210
.           Add ICD10 Ed.13 - Go-live Date PTCNGDX3 (Sect.130 Pos.86)
.V11.05.03  07/03/2025  Ebon Clements    TSK 0944729
.           Recompiled for WEBGROUP - Load Codefinder QLD complication prefix
.V11.05.02  04/02/2025  Ebon Clements    TSK 0951861
.           Recompiled for WEBGROUP - Added OPRTSMFD
.V11.05.01  15/11/2024  Davin            TSK 0950787
.           Recompiled for WEBGROUP - Send CTYPE Tag to Codefinder (MRCNSCTC)
.V11.04.08  18/10/2024  Davin            TSK 0922271
.           Recompiled for WEBGROUP - allow grouper to handle up to 100 codes
.V11.04.07  05/07/2024  Ebon Clements  TSK 0948817
.           Recompiled for WEBGROUP - CGS/Codefinder Separation mode
.V11.04.06  17/06/2024  PJ Le Febour   TSK 0937495
.           Recompiled for WEBGROUP - get DCLs from new position in grouper v11
.V11.04.05  01/05/2024  Alina Bhari    TSK 0945737
.           Allowed space on second poistion of DVA card -VADVAC10   
.V11.04.04  22/02/2024  Ebon Clements  TSK 0943354
.           Recompiled for WEBGROUP - TG export separation mode
.V11.04.03  25/01/2024  Davin          TSK 0928468
.           Recompiled for WEBGROUP - Added AMHCC Grouper
.V11.04.02 18/12/2023 Thanh T        TSK 0932089
.           Recompiled for PRIPRAFD and PRIDOCFD changes
.V11.04.01 18/12/2023 Thanh T        TSK 0932089
.           Recompiled for PRIHREFD changes
.V11.03.09  16/11/2023  Thanh T        TSK 0936867
.           Changed VACTYP00 to valiadte for care type 32 and 33 
.V11.03.08  26/09/2023  Ebon Clements  TSK 0934837
.           Recompiled for WEBGROUP - Load Codefinder default clinician
.V11.03.07  04/09/2023  Ebon Clements  TSK 0936661
.           Recompiled for WEBGROUP - TurboGrouper QLD condition onset type
.V11.03.06  21/08/2023  Davin          TSK 0935074
.           Recompiled for WEBGROUP - loading operation codes from codefinder
.V11.03.05  05/07/2023  Ebon Clements    TSK 0934723
.           Recompiled for WEBGROUP - DRG 11 - 2 character separation mode
.           if discharged post DRG 11 go live
.V11.03.04  26/06/2023  Ebon Clements    TSK 0932535
.           Recompiled for WEBGROUP - DRG 11 - 2 character separation mode
.V11.03.03  21/03/2023  Ebon Clements    TSK 0909393
.           Added hospital to oprsesaf(1-6) and oprdetfa(1&5) indexes
.V11.03.02  31/01/2023  Thanh T.         TSK 0919770
.           Changed VALEQP00, VALTRA00 to cater for adding Hospital field
.           changes
.V11.03.01  23/12/2022  Davin         TSK 0926029
.           Recompiled for WEBGROUP - Use pateco code/desc for non-hosp ops
.V11.02.11  23/08/2022  Ebon Clements TSK 0922315
.           Validate full 10 character HCP/practice - VALDMP00
.V11.02.10  23/06/2022  J.Tan         TSK 0914045
.           Mod CCFN0000 - full read on Contract funding file
.V11.02.09  21/06/2022  J.Tan         TSK 0914045
.           Mod CCFN0000 to check for next valid Contract funding
.V11.02.08  14/06/2022  Ebon Clements TSK 0906596
.           Recompiled for WEBGROUP - Charlson score
.V11.02.07  02/06/2022 Ebon Clements  TSK 0902519
.           Recompiled for WEBGROUP - Aboriginality to use cat VA indicator 4
.V11.02.06  21/04/2022  Davin         TSK 0917793
.           Recompiled for WEBGROUP - DRG Version 11.0
.V11.02.05  31/03/2022  Davin         TSK 0917793
.           Add ICD10 Ed.12 - Go-live Date PTCNGDX2 (Sect.128 Pos.231)
.V11.02.04  11/02/2022  Ebon Clements TSK 0915238
.           Recompiled for WEBGROUP - TG export/import operation times
.V11.02.03  10/02/2022  Thanh T          TSK 0889899
.           Recompiled as WATTR1FD changes
.V11.02.02  08/02/2022  Ebon Clements TSK 0915238
.           Recompiled for WEBGROUP - TG operation times
.V11.02.01  07/02/2022  Thanh T       TSK 0896905
.           Recompiled for ALLDEPFD changes
.V11.01.18  19/11/2021  Ebon Clements TSK 0911383
.           Recompiled for WEBGROUP - CGS Condition onset flag for NWAU
.V11.01.17  18/11/2021  Ebon Clements TSK 0911851
.           Recompiled for WEBGROUP - Codefinder/CGS - ICU NICU hrs
.V11.01.16  17/11/2021  Ebon Clements TSK 0911414
.           Recompiled for WEBGROUP - Export additional fields to TG
.V11.01.15  15/09/2021  Ebon Clements TSK 0902389
.           Recompiled for WEBGROUP - Urgency of Admission
.V11.01.14  14/09/2021  Ebon Clements TSK 0897701
.           Recompiled for WEBGROUP - Gender
.V11.01.13  20/08/2021  Ebon Clements TSK 0909624
.           Recompiled for WEBGROUP - LOS
.V11.01.12  13/07/2021  Ebon Clements TSK 0902615
.           Recompiled for WEBGROUP - Not using NWAU test
.V11.01.11  07/07/2021  Ebon Clements TSK 0908708
.           Recompiled for WEBGROUP - ICU Hours
.V11.01.10  06/07/2021  Ebon Clements TSK 0908709
.           Recompiled for WEBGROUP - Use cat S admission mode
.V11.01.09  30/06/2021  Ebon Clements TSK 0902615
.           Recompiled for WEBGROUP - Export Care Type to TG
.V11.01.08  30/06/2021  Ebon Clements TSK 0902615
.           Recompiled for WEBGROUP - Don't restrict codes for NWAU
.V11.01.07  29/06/2021  Ebon Clements TSK 0902615
.           Recompiled for WEBGROUP - NWAU unix grouper changes
.V11.01.06  22/06/2021  Ebon Clements TSK 0907810
.           Recompiled for WEBGROUP - Contract care type flag
.V11.01.05  18/06/2021  Ebon Clements TSK 0902615
.           Recompiled for WEBGROUP - NWAU unix grouper changes
.V11.01.04  04/06/2021  Ebon Clements TSK 0907214
.           Don't display category master record - GTCATL00
.V11.01.03  05/05/2021  Ebon Clements TSK 0902615
.           Added read of NWAU parameters MRCNUNWA and MRCNENWA
.V11.01.02  19/04/2021  Thanh T       TSK 0901851
.           Changed VACTYP20 and QUNQ0000 to check for Cat A HDP Default = "9"
.           and "10" 
.V11.01.01  31/03/2021  Ebon Clements TSK 0902602
.           Changed key length for ALLDIAA2
.V11.00.10  08/10/2020  Ebon Clements  TSK 0892694
.           Recompiled for WEBGROUP - Export 6.2 DRG as 6.0x to TurboGrouper
.V11.00.09  08/10/2020  Ebon Clements  TSK 0892694
.           Recompiled for WEBGROUP - Send health fund defails to TG 
.V11.00.08  08/10/2020  Ebon Clements  TSK 0893634
.           Recompiled for WIESCALC - WIES27 Aboriginal and Torres Strait
.           Islander loading
.V11.00.07  30/09/2020  Ebon Clements  TSK 0896140
.           Display code codes in description order - GTCATL00
.V11.00.06  23/09/2020  Ebon Clements  TSK 0893634
.           Recompiled for WIESCALC - Added WIES27 for 2020/2021
.           24/09/2020  Thanh T        TSK 0878035  
.           Changed SELCOD00 to show all Inactive category code when
.           SHOWIACT = "Y" and long description when SHOWLDSC = "Y"
.V11.00.05  10/07/2020  Ebon Clements  TSK 0894249
.           Recompiled for WEBGROUP - TurboGrouper load DRG version 10
.V11.00.04  08/07/2020  Ebon Clements  TSK 0894249
.           Recompiled for WEBGROUP - TurboGrouper load DRG versions
.V11.00.03  25/05/2020  Davin          TSK 0890603
.           Recompiled for WEBGROUP/WIESCALC - WIES for private facility
.V11.00.02  15/05/2020  Ebon Clements  TSK 0891590
.           Recompiled for WEBGROUP - TurboGrouper DRG version 6.2
.V11.00.01  06/03/2020  J.Tan          TSK 0838262
.           Added Effective from and to date to MBS Item file
.V10.15.05  17/02/2020  Davin          TSK 0881493
.           Recompiled for WEBGROUP - restrict diag codes to grouper
.V10.15.04  16/01/2020  Tracey Nguyen  TSK 0885107
.           Added DVA warcode WARCD107="V"
.V10.15.03  12/11/2019  Nicole Torrisi TSK 0881409
.           Recompiled for WEBGROUP - Added HMV
.V10.15.02  23/10/2019  Ebon Clements  TSK 0308709
.           Recompiled for OUTBOATM - Clinic type linked visit types
.V10.15.01  09/10/2019  Ebon Clements  TSK 0877429
.           Added channel and job to TurbGrouper import/export file
. ------------------------------------------------------------------------------
.V10.14.17  03/10/2019  Thanh T        TSK 0882260
.           Recompiled for WEBGRPVA - DRG Version 11.0
.V10.14.16  02/10/2019  Ebon Clements  TSK 0877430
.           Populate TurboGrouper coded by user date and time
.V10.14.15  30/09/2019  Ebon Clements  TSK 0877428
.           Populate TurboGrouper campus code
.V10.14.14  26/08/2019  Davin          TSK 0880255
.           Recompiled for WIESCALC - Added WIES26 for 2019/2020
.V10.14.13  19/08/2019  Richa Phogat   TSK 0876834
.           Added PMWXVHCP under VALACC70
.V10.14.12  04/06/2019  Ebon Clements  TSK 0875790
.           Recompiled for WEBGROUP - TurboGrouper operation prefix
.V10.14.11  31/05/2019  Ebon Clements  TSK 0875696
.           Recompiled for WEBGROUP - TurboGrouper coder id
.V10.14.10  21/05/2019  Davin          TSK 0870480
.           Recompiled for WEBGROUP - Changed eccsraw codefinder tag
.V10.14.09  14/05/2019  Ebon Clements  TSK 0874778
.           Recompiled for WEBGROUP - TurboGrouper diagnosis codes 
.V10.14.08  02/05/2019  Ebon Clements  TSK 0874135
.           Recompiled for WEBGROUP - TurboGrouper theatre date/time defaults
.V10.14.07  01/05/2019  Ebon Clements  TSK 0872200
.           Recompiled for WEBGROUP - Added TURBOSAV - Retain previous details
.V10.14.06  08/04/2019  Ebon Clements  TSK 0872901
.           Recompiled for WEBGROUP -  Auto Coding user id
.V10.14.05  04/04/2019  Ania P         TSK 0870267
.           Added OPENONLY
.V10.14.04  27/03/2019  Ebon Clements  TSK 0872200
.           Recompiled for WEBGROUP -  Export leave days
.V10.14.03 20/03/2019  J.Tan            TSK 0857392
.           Changed RCP Transaction count from DIM3 to DIM5
.V10.14.02  14/03/2019  Don Nguyen     TSK 0869412
.           Added read of ICD10 Ed.11 Go-live Date parameter (PTCNGDX1)
.           04/03/2019  Ebon Clements  TSK 0870711
.           Recompiled for WEBGROUP - TurboGrouper
.           27/02/2019  Richa Phogat   TSK 0870439
.           Recompiled for WEBGROUP - DRG Version 10.0
.V10.14.01  25/02/2019  Ebon Clements  TSK 0870711
.           Recompiled for WEBGROUP - TurboGrouper
.V10.13.05  20/12/2018  Don Nguyen     TSK 0837732
.           Recompiled for WEBGROUP - Modified GODTM000 to get the first
.           matching MBS Item time values (if operation date exists).
.V10.13.04  01/11/2018  Davin          TSK 0852820
.           Recompiled for WEBGROUP - Use "TOTWT:" tag for nz wies
.V10.13.03  11/09/2018  Tracey Nguyen  TSK 0862471
.           Added check for alcaactv=2 (active - exclude from PRIMHD) in
.           VALTEA10
.V10.13.02 06/09/2018  Richa Phogat   TSK 0862786
.           Recompiled for WEBGROUP - Removed bypass Morphology
.V10.13.01  21/08/2018  Davin          TSK 0860935
.           Recompiled for WIESCALC - Added WIES25 for 2018/2019
.           31/07/2018  J.Tan            TSK 0848506
.           Changed PP Doctor from DIM6 to DIM10
.V10.12.06  05/06/2018  Ebon Clements  TSK 0845772
.           Recompiled for WEBGROUP - TurboGrouper diagnosis
.V10.12.05  04/06/2018  Don Nguyen     TSK 0844889
.           Modified MULTAD00 to output Current Visit & Web User Hospital Code
.V10.12.04  04/05/2018  Ebon Clements  TSK 0845772
.           Recompiled for WEBGROUP - TurboGrouper
.V10.12.03  26/03/2018  Tracey Nguyen  TSK 0852793
.           Recompiled for WEBGROUP - DRG Version 9.0
.V10.12.02  14/02/2018  Jill Parkinson TSK 0852299
.           Added use of users logged in hospital if no visit available in
.           GPCEHR00
.V10.12.01  29/01/2018  Ania P           TSK 0851398
.           Recompiled for WEBGROUP
.V10.11.07  27/12/2017  Steve Armstrong  TSK 0850165
.           Recompiled for changes to DGCLICAC.
.V10.11.06  15/12/2017  Peter Vela       TSK 0847747
.           Recompiled for WEBGROUP
.V10.11.05  11/12/2017  Don Nguyen       TSK 0848767
.           Recompiled for WEBGROUP - Modified GDSPX300 to include ACT
.V10.11.04  28/11/2017  Peter McMullen   TSK 0848857
.           remove assumed protocol in CPCEHR00 (it will be inserted by 
.           Standard.js function getPCEHR (js knows the current protocol) 
.V10.11.03  27/09/2017  Davin            TSK 0845070
.           Recompiled for WEBGROUP - fixed codefinder tag BWIES
.V10.11.02  18/08/2017  Richa Phogat     TSK 0820753
.           Added EMSTACTV in SELSIT00 to display warning message when inactive
.           Site Code is selected
.V10.11.01  15/08/2017  Davin            TSK 0842626
.           Recompiled for WIESCALC - Added WIES24 for 2017/2018
.V10.10.08  21/06/2017  Davin          TSK 0836775
.           Recompiled for WEBGROUP - mental health legal status
.V10.10.07  07/06/2017  Jill Parkinson TSK 0832750
.           Recompiled for WIESCALC - R64Z issues
.V10.10.06  01/06/2017  Don Nguyen     TSK 0838360
.           Recompiled for WEBGROUP - Fixed RLTAGS00
.           01/06/2017  Don Nguyen     TSK 0838196
.           Added WCFINPFN & WCFOUTFN. Recompiled for WEBGROUP.
.V10.10.05  25/05/2017  Jill Parkinson   TSK 0832750
.           Recompiled for wiescalc - use drg code position 2-3 to
.           decide if surgical                                   
.V10.10.04  10/05/2017  Peter Vela     TSK 0820086
.           Removed trailing spaces from each line for Additional Injury
.           Comments VALACC00
.V10.10.03  03/05/2017  Thanh T.       TSK 0837331
.           Fixed the Array out of bound issue. Changed the array size of
.           MPROCCOD from 99 to 500
.V10.10.02  Peter Vela                TSK 0820086
.           Added following items to VALACC00:
.           - Gradual Process injury
.           - Purchase order number
.           - Admitted to hospital
.           - Verbal consent gained
.V10.10.01  17/03/2015  Davin            TSK 0833093     HDP 2017/2018
.           Add ICD10 Ed.10 - Go-live Date PTCNGDVX (Sect.110 Pos.85)
.V10.09.04  Ken Bell                  TSK 0818838
.           Added VALDINDC to Validate Cards specifying indicator directly
.V10.09.03 18/01/2017  Jill Parkinson TSK 0831665
.           Recompiled for WEBGROUP
.V10.09.02  09/01/2017  Jill Parkinson TSK 0831665
.           Recompiled for WEBGROUP
.V10.09.01  03/12/2016  Ania P           CAR 814741
.           Recompiled for PATCRCFD/IO
.V10.08.11  24/11/2016  Peter Vela       TSK 0820086
.           Fixed Additional Injury Comments and HCP Treatment Provider in
.           VALACC00
.V10.08.11  24/11/2016  Jill Parkinson TSK 0817492  
.           Recompiled for WIESCALC - Added check for surgical procs
.V10.08.10  08/11/2016  Don Nguyen       TSK 0828544
.           Recompiled for WEBGROUP - Modified RLTAGS00
.V10.08.09  05/10/2016  Davin            TSK 0826104
.           Recompiled for WEBGROUP - importing codefinder procedure date
.V10.08.08  02/09/2016  Davin            TSK 0825157
.           Recompiled for WIESCALC
.V10.08.07  30/08/2016  Don Nguyen       TSK 0814947
.           Recompiled for WEBGROUP - Modified COPRS000 to check PT0ODTMN
.V10.08.06  26/08/2016  Don Nguyen       TSK 0312570
.           Recompiled for GETDRG (GTDRG000) - Call GTEDRG00 when PTCNDGED=1
.           Added PMSEDGFD/IO and GETEFDRG
.V10.08.05  19/07/2016  Davin            TSK 0822753
.           Recompiled for WIESCALC - Added WIES23 for 2016/2017
.V10.08.04  27/04/2016  Don Nguyen       TSK 0815007
.           Recompiled for WEBGROUP - Modified RDUNIX1 & RDCME1
.V10.08.03  18/04/2016  Peter Vela       TSK 0294177
.           Changed read to prihdb to KEY27
.V10.08.02  13/04/2016  Don Nguyen       TSK 0321353
.           Recompiled for WEBGROUP - Modified WRENC000 to use GETDRG
.V10.08.01  12/04/2016  Don Nguyen       TSK 0815007
.           Recompiled for WEBGROUP - process "I10ECCSRAW:" & "HNIV:"
. ------------------------------------------------------------------------------
.V10.06.16  30/07/2015  Don Nguyen       CAR 318792
.           Recompiled for WEBGROUP - Modified RLTAGS00 to use KEY200
.V10.06.15  15/07/2015  Peter Vela       CAR 309599
.           Added blank doctor read in OPRAV100
.V10.06.14  01/07/2015  Peter Vela       CAR 317968
.           Added BKRQTHET to VTRQRC00
.V10.06.13  18/06/2015  Don Nguyen       CAR 314792
.           Recompiled for WEBGROUP - Modified ENCDT000; output PTEDACDT
.V10.06.12  11/06/2015  Patrick Adair    CAR 313223
.           Recompiled for WEBGROUP - admission weight check
.V10.06.11  21/05/2015  Patrick Adair    CAR 313318
.           Get Length of Service Default - NZ
.V10.06.10  21/05/2015  Ania P           CAR 315212
.           Changed GPCEHR00 URL Output for Hospital Link
.V10.06.09  14/05/2015  Ania P           CAR 315212
.           Fixed GPCEHR00 URL Link
.V10.06.08  08/05/2015  Ania P           CAR 315212
.           Added GPCEHR00
.V10.06.07  13/04/2015  Peter Vela       CAR 303891
.           Added output for TCINDC3 in MULTAD00
.V10.06.06  09/04/2015  Peter Vela       CAR 303889
.           Added HCP / Specialty Validation
.           10/04/2015  J.Tan            CAR 304813
.           Added WIESCALC
.V10.06.05  31/03/2015  Peter Vela       CAR 298921
.           Added Validate Service doctor for a Medical Practice through
.           pmshcpaf linked doctor code VALDMP00
.V10.06.04  25/03/2015  Don Nguyen       CAR 312700
.           Modified VACTYP00 - added validation for Care Type HDP Equiv 32
.V10.06.03  24/03/2015  Don Nguyen       CAR 314100
.           Recompiled for WEBGROUP - modified output for mrtweb02.us1/us2
.V10.06.02  17/03/2015  Davin            CAR 311669      HDP 2015/2016
.           Add ICD10 Ed.9 - Go-live Date PTCNGDV9 (Sect.110 Pos.77)
.V10.06.01  12/03/2015  Steve Armstrong   CAR 314108
.           Removed definition of PTCGDATE as PATCGPFD is no longer in use
. ------------------------------------------------------------------------------
.V10.05.13  29/01/2014  Ebon Clements    CAR 306399
.           Don't report updated by error if date and time are equal - CHKUPD00
.V10.05.12  09/12/2014  Peter Vela       CAR 307865
.           Added remote script for deceased patients
.V10.05.11  03/12/2014  Peter Vela       CAR 308859
.           Added remote script for Theatre Request record
.V10.05.10  28/11/2014  Peter Vela       CAR 308113
.           Added remote script for Theatre Request comments
.V10.05.09  06/11/2014  Don Nguyen       CAR 304059
.           Recompiled for changes to OPRSESIO - added Default Team Completed 
.           fields.
.V10.05.08  22/10/2014  Patrick Adair    CAR 306223
.           Admit a patient who is 10 days old or over - VACTYP20
.V10.05.07  16/10/2014  Peter Vela       CAR 302629
.           Added Validate Bulk Journal remote script
.V10.05.06  13/10/2014  Peter Vela       CAR 301518
.           Added View remote script for OBSAUD clinical document view
.V10.05.05  10/10/2014  Ebon Clements    CAR 305470
.           Changed AH service types to list in description order - DEPSRV00
.V10.05.04  18/09/2014  Davin            CAR 304204
.           Recompiled for GETDRG - get drg vers based on disch date
.V10.05.03  09/09/2014  Davin            CAR 296980
.           Changes to handle WIES21
.V10.05.02  08/09/2014  J.Tan            CAR 305649
.           Mods Check Matrix (NZMX0000) to Check Eff.date of Proc.fee(CPFE0000)
.V10.05.01  01/08/2014  Peter Vela    CAR 299131
.           Added remote script for drug orders
.V10.04.10  03/07/2014  Ebon Clements CAR 302036
.           Recompiled for WEBGROUP - Urgency of admission tag
.V10.04.09  30/01/2014  Peter Vela    CAR 301127
.           Added VDBMST00 - Validation Date of Birth / Marital Status
.V10.04.08  03/04/2014  Patrick Adair CAR 292976
.           Allow all hospital theatres to be displayed SELOPR00 - ibaopr66002
.V10.04.07  24/03/2014  Peter Vela       CAR 287404
.           Added remote script for HCP Practice, Fax DS and Electronic DS    
.           indicators
.V10.04.06  14/03/2014  Don Nguyen       CAR 285773
.           Modified DEPSRV00 to exclude Non U/R Related services
.V10.04.05  13/03/2014  Don Nguyen       CAR 294888
.           Recompiled for changes to WEBGROUP
.V10.04.04  04/03/2014  J.Tan            CAR 297922
.           Added List of PP Service doctors for a given U/R & Medical Practice
.V10.04.03  09/02/2014  Ania P           CAR 267230
.           Added active check to VALEQP00 
.V10.04.02  22/01/2014  Ebon Clements    CAR 291120
.           Exclude other factors from AH problem list - SELAPR00
.V10.04.01  20/12/2013  Don Nguyen       CAR 210806
.           Added MAIN9600 (report 86) - check for Cross Consultations
.V10.03.71  12/12/2013  Patrick Adair    CAR 289374
.           Added MAIN9500 (report 85) to check if UR is a current inpatient
.V10.03.70  10/12/2013  J.Tan            CAR 294414
.           Mods TPAY0000 Total payments to check type of Registers
.V10.03.69  14/10/2013  Don Nguyen       CAR 282453
.           Recompiled for WEBGROUP
.V10.03.68  09/10/2013  Peter Vela       CAR 292070
.           Recompiled for WEBGROUP
.V10.03.67  04/10/2013  Peter Vela       CAR 284261
.           Recompiled for PATWIS19 PATWIS20
.V10.03.66  02/10/2013  Ania P           CAR 292081
.           Recompiled for WEBGROUP
.V10.03.65  30/09/2013  Peter Vela       CAR 291974
.           Added Start/End date validations to HCPHOS00
.V10.03.64  09/09/2013  Ania P           CAR 290324
.           Added DIM3 and recompiled for WEBGROUP
.V10.03.63  10/09/2013  Steve Armstrong  CAR 291089
.           recompiled for changes to PMSQVIIO
.V10.03.62  05/09/2013  Peter Vela       CAR 289350
.           Added MAIN9400 (report 84) - Validate DRG with version
.V10.03.61  04/09/2013  Peter Vela       CAR 289901
.           Added MAIN9300 (report 83) - ICD10 remote script including
.           non existent header records
.           04/09/2013  Don Nguyen       CAR 285773
.           Added MAIN9200 (report 82) - Referral Department Services 
.           selection list (DEPSRV00).
.V10.03.60  29/08/2013  Ania P           CAR 290324
.           Recompiled for WEBGROUP
.           02/09/2013  Davin            CAR 290919
.           Recompiled for PATWIS18/19/20
.V10.03.59  26/08/2013  Ebon             CAR 275205
.           Added report 81 - HCP hospital access selection list - HCPHOS00
.V10.03.58  08/08/2013  Davin            CAR 284960
.           Changes to handle WIES20
.V10.03.57  31/07/2013  Ebon Clements    CAR 286034
.           Fixed department list when not multi hospital - LUHSDP00
.V10.03.56  23/07/2013  Patrick Adair    CAR 287758
.           Corrected Check Digit Calculation for Concession Cards
.V10.03.55  18/07/2013  Steve Armstrong  CAR 268961
.           Recompiled for changes to PMSQVIFD.
.V10.03.54  12/07/2013  Davin            CAR 288236
.           Combine Centrelink/pension/seniors validation if cat.ct indc9 = 'E'
.V10.03.53  09/07/2013  Davin            CAR 287960
.           Added cat.ct indicator 9 = 'E' (using centrelink edits - vaccty15)
.V10.03.52  22/05/2013  Don Nguyen       CAR 283702
.           Modified CHKUPD00 to format web username output (no trailing spaces)
.V10.03.51  10/05/2013  Don Nguyen       CAR 283211
.           Modified VADVAC60 to test for "." in digits scan
.V10.03.50  23/04/2013  Davin            CAR 284420      HDP 2013/2014
.           Add ICD10 Ed.8 - Go-live Date PTCNGDV8 (Sect.110 Pos.69)
.V10.03.49  12/04/2013  J.Tan            CAR 283721
.           Added report 80 - calculate total invoice amt after input journal
.V10.03.48  04/04/2013  J.Tan            CAR 282659
.           Changed VAREHB00 to use HIH instead of HITH
.V10.03.47  20/03/2013  Ania P           CAR 282826
.           Modified warning message in VANEWB90.
.V10.03.46  19/03/2013  Peter Vela       CAR 279686
.           Added Select option for AH diagnosis by department
.V10.03.45  28/02/2013  Jill Parkinson   CAR 257831
.           Added option 78 - check last Demographics updated date/time
.V10.03.44  25/02/2013  Ania P           CAR 281021
.           RECOMPILED for WEBGROUP
.V10.03.43  14/02/2013  Davin            CAR 270408
.           Added option 76 - Validate Concession Card Types (vaccty00)
.           Added option 77 - Validate Age / Marital Status (vaamar00)
.V10.03.42  15/02/2013  Davin            CAR 270409
.           Mods to validate pthsappr against ptvacode not ptvaprov (vathsp00)
.V10.03.41  14/02/2013  Davin            CAR 270409
.           Mods to HITH/Rehab validation (varehb10) - allow blank bed
.V10.03.40  30/01/2013  Davin            CAR 270409
.           Added TRANSFER to Cat CL and Amb Ward validation (vaclwd00)
.           Added options 74 - 75 for wahealth
.V10.03.39  30/01/2013  Davin            CAR 270409
.           Added options 69 - 73 for wahealth
.V10.03.38  30/11/2012  Jill Parkinson CAR 274404  
.           Fixed branch to 99 in SELPLN00
.V10.03.37  20/11/2012  Jill Parkinson CAR 274404  
.           Fixed branch to 99 in SELCOD00
.V10.03.36  12/11/2012  Ania P           CAR 270328
.           Added Rept 68 (LUHSDP00) - List all departments for a given hospital
.V10.03.35  08/11/2012  Peter Vela       CAR 268452
.           Added extra check for HDP Equiv = 6 @ CEMRBT00
.V10.03.34  31/10/2012  Peter Vela       CAR 256548/256994
.           Fixed Operation Averages
.V10.03.33  29/10/2012  Peter Vela       CAR 256548/256994
.           Added option 67 - Operation Averages
.V10.03.32  15/10/2012  Davin            CAR 268452
.           Added option 66 - Check if EMR bed type for inp episode (main7600)
.V10.03.31  20/09/2012  Davin            CAR 273279
.           Recompiled for PATWIS19
.V10.03.30  11/09/2012  Peter Vela       CAR 270712
.           Fixed hospital validation for Cat CT
.           10/09/2012  Davin            CAR 270329
.           Added Selection list for EMR sites for specific hospital (selsit00)
.           Added Selection list for printer depts for specific hosp (seldep00)
.           Added default ward/site/dept for user id/hospital (gtdwsd00)
.V10.03.29  06/09/2012  Peter Vela       CAR 270712
.           Added hospital specific validation to remote script for Category CT
.V10.03.28  06/09/2012  Peter Vela       CAR 270712
.           Added remote script for Category CT Clinic Location hospital links
.           display
.V10.03.27  28/08/2012  Saroeun Soeur    CAR 261981
.           created GTCATL00 - json of patcodes  
.V10.03.26  23/08/2012  Davin            CAR 271916
.           Recompiled for WEBGROUP
.V10.03.25  08/08/2012  Davin        CAR 270114
.           Changes to handle WIES19
.V10.03.24  12/07/2012  Jill Parkinson CAR 268967
.           Added read of websecaf in 
.V10.03.23  26/06/2012  Mike Laming  CAR 267797 HDP 2012 DRG 6.2
.           Re-compiled for WEBGRPVA & WEBGROUP - DRG 6.2 changes
.V10.03.22  14/06/2012  Ebon Clements CAR 267092
.           Added report 59 & 60 AH reasons for referral by department
.V10.03.21  07/06/2012  Mike Laming    CAR 266421
.           Recompiled for WEBGROUP updates - added PATCHCof for Episode Coding
.V10.03.20  01/06/2012  Jill Parkinson CAR 245775
.           Added report 58 - output visit type for a visit number
.V10.03.19  28/02/2012  Ebon Clements CAR 251689
.           Added report 57 calculate number of financial periods
.V10.03.18  16/02/2012  J.Tan     car 256376
.           Changed to check for intended hospital
.V10.03.17  15/02/2012  Peter Vela     CAR 254058
.           Changed Mental Health Team Selection to loop through PMSTMD
.V10.03.16  14/02/2012  Peter Vela     CAR 254058
.           Added Mental Health Team selection list for a given doctor
.V10.03.15  08/02/2012  Ebon Clements  CAR 252358
.           Added category code selection list for a given hospital
.V10.03.14  18/01/2012  Ebon Clements  CAR 244332
.           Added extract last run date remote script
.V10.03.13  16/01/2012  Peter Vela     CAR 258380
.           Validate duplicate alerts on update DUPAD000
.V10.03.12  16/01/2012  Peter Vela     CAR 254141
.           Fixed Current on leave indicator @ MULTAD00
.V10.03.11  13/12/2011  Jill Parkinson CAR           
.           Removed option - not required
.V10.03.10  08/12/211  J.Tan          CAR 254377
.           Mods checking for Referral End date
.V10.03.09  08/12/211  Jill Parkinson CAR 249362
.           Added equal checks to dates in DUPAL000
.V10.03.08  07/12/211  J.Tan          CAR 256090
.           Fixed checking for Existing LS
.V10.03.07  05/12/211  Jill Parkinson CAR 249362
.           Fixed output of tdesc for inactive alerts
.V10.03.06  02/12/2011  Davin        CAR 251748
.           Recompiled for changes to PATWIS18
.V10.03.05  02/12/2011  Ebon ClementsCAR  CAR 253370
.           Check for multiple births - MULTBY00
.V10.03.04  24/11/2011  Jill Parkinson    CAR 249362
.           Added duplicate alert remote script
.V10.03.03  22/11/2011  Ebon Clements     CAR 255738
.           Changed bed selection list to be in desc order - WARDBD00 & SELWBD00
.V10.03.02  21/11/2011  Peter Vela   CAR 255636
.           Added inactive mehdls records to MHDLVL00 validation
.V10.03.01  10/11/2011  Peter Vela   CAR 252442
.           Added remote script to check for open legal status records
.V10.02.14  11/08/2011  Davin        CAR 238236
.           Changes to handle WIES18
.V10.02.13  05/10/2011  Ebon Clements     CAR 251564
.           Added already admitted to this hospital flag to MULTAD00
.V10.02.12  16/09/2011  Ebon Clements     CAR 250102
.           Added report 49 - Selection list of beds for a ward - WARDBD00
.V10.02.11  01/09/2011  Steve Armstrong   CAR 248500
.           Recompiled for changes to WEBGROUP
.V10.02.10  05/08/2011  Davin             CAR 240723
.           Fixed validation of valdcod2/unit in seltem00 (added key3)
.V10.02.09  04/08/2011  Jill Parkinson    CAR 247823
.           Fixed match to HDP equivalent of catgory A in QUNQ0000
.V10.02.08  02/08/2011  Jill Parkinson    CAR 242269
.           Fixed output of Category A in QUNQ0000
.V10.02.07  24/07/2011  Jill Parkinson    CAR 242269
.           Added Remote Script for unqualified/qualified category A
.           27/07/2011  Davin             CAR 240723
.           Added SELROL00 - Selection List for HCP/Hosp/Role
.V10.02.06  18/07/2011  Peter Vela        CAR 242439
.           Added Remote Script for Disater Code Date Validation
.           20/07/2011  Davin             CAR 240723
.           Added SELUNT00 & SELTEM00 - Selection Lists for HCP/Hosp/Units/Team
.V10.02.05  13/07/2011  Steve Armstrong   CAR 240722
.           Further mods to cater for second given name as part of
.           PATGSRFD keys
.V10.02.04  22/06/2011  Steve Armstrong   CAR 240722
.           Mods to cater for changes to PATGSRFD:
.             - GSRSNAM & GSRGNAM extended to 30 chars.
.             - PTGSGNM2 added.
.             - all indexes changed in length.
.V10.02.03  27/06/2011  Peter McMullen CAR 240725
.           change sort order of ward list                      
.V10.02.02  10/06/2011  Jill Parkinson CAR 242672
.           Added AVLWBD00 - Available bed selection list
.           07/06/2011  Jill Parkinson   CAR 240713
.           Added Report 42 - Check for multiple admissions
.           26/05/2011  Peter Vela       CAR 239581
.           Added Report 41 - Link Unlink Patient Disaster disptlaf
.V10.01.05  20/05/2011  Ebon Clements    CAR 240720
.           Added report 40 - Source of referral selection list for OP site
.V10.01.04  17/03/2011  J.Tan            CAR 233267
.           Added report 39 - validate ward/bed
.V10.01.03  16/03/2011  Mike Laming      CAR 233901
.           Added Report 38 - Validate Receipt Number (RCPNO000)         
.V10.01.02  14/12/2010  Mike Laming      CAR 233046
.           Mods to Misc.Charges PATMCHFD - incl. new routine PATMCHRD
.V10.01.01  28/10/2010  Ebon Clements    CAR 219699
.           Added Security group login url cookie - SECURL00
.V10.00.04  10/08/2010  Davin        CAR 227937
.           Recompiled for changes to PATWIS17
.V10.00.03  08/07/2010  Peter Vela   CAR 223248
.           Fixed VALDCODE comparison @ VALACC00
.V10.00.02  30/04/2010  J.Tan        CAR 220887
.           Mods checking for Active/Inactive of Misc.charge
.V10.00.01  06/04/2010  Mike Laming     CAR 219246      HDP 2010
.           Add ICD10 Ed.7 - Go-live Date PTCNGDV7 (Sect.110 Pos.61)
..........  24/03/2010  Davin            CAR 216505
.           Changes to handle WIES17
. V9.12.09  03/02/2010  Jill Parkinson   CAR 207721
.           Added read of pmsmtiaf in ECTC0000
. V9.12.08  05/01/2010  J.Tan            CAR 174079
.           Added selection option of action plan
.           21/01/2010  Jill Parkinson  CAR 204527 
.           Added CHKWB000
. V9.12.07  04/09/2009  Ebon Clements    CAR 190945
.           Added user test to SEGGRP00
. V9.12.06  21/08/2009  Saroeun Soeur    CAR 202409
.           changed error msg for duplicate registration - VALDUP00 
. V9.12.05  20/08/2009  Jill Habasque    CAR 199583
.           Added ECTD0000 - get ECT details
. V9.12.04  13/08/2009  Saroeun Soeur    CAR 203648
.           VALACK00 - move valdcode into key20 and packed it with sp20
.           to match whole string of WCCLMNO
. V9.12.03  01/07/2009  Davin            CAR 199724
.           Changes to handle WIES16
. V9.12.02  19/06/2009  Mike Laming  CAR 197814 HDP 2009 DRG 6.0
.           Re-compiled for WEBGRPVA & WEBGROUP - DRG 6.0 changes
. V9.12.01  29/04/2009  Ebon Clements    CAR 190940
.           Added SELWEK00 - Added return week selection list
. V9.11.03  20/03/2009  Ebon Clements    CAR 190945
.           Added SEGGRP00 - Return web security groups url string
. V9.11.02  25/11/2008  Ebon Clements    CAR 174077
.           Added SELWBD00 - Output a selection list of active beds for a ward
. V9.11.01  15/10/2008  J.Tan            CAR 180771
.           Added GFYEAR00 - get the financial year of a date
. V9.10.03  25/09/2008  Davin            CAR 178428
.           Recompiled for PATWIS15 - radiotherapy drg modification
. V9.10.02  17/07/2008  Davin            CAR 163993
.           Changes to handle WIES15
. V9.10.01  03/06/2008  Jill Habasque CAR 169088
.           Changed error to warning in VALEXT00
. V9.09.09  20/03/2008  Mike Laming   CAR 163918     HDP 2008 
.           Add PTCNGDV6 for ICD10 Ed.6 Go-live date
. V9.09.08  04/12/2007  Jill Habasque    CAR 153381
.           Added VALADC00 - Validate adverse outcome code
. V9.09.07  15/10/2007  Peter Vela       CAR 148954
.           Recompiled for PMSREGFD
. V9.09.06  05/09/2007  Peter Vela       CAR 148954
.           Recompiled for PMSREGFD
. V9.09.05  28/07/2007  Steve Armstrong  CAR 148718
.           Recompiled for changes to PAT41GRP.
. V9.09.04  02/08/2007  Steve Armstrong    CAR 145161
.           Removed all reference to WIES 7, 8, 9 & 10 - no longer supported.
.           Recompiled for changes to PAT41GRP & VARWIS14.
. V9.09.03  20/07/2007  Ebon Clements CAR 145544
.           Allow theatres with no hospital to be used by all hospitals/users
.           SELOPR00
. V9.09.02  18/07/2007  Mike Laming  CAR 145161
.           Mods for WIES 14 
. V9.09.01  01/06/2007  Janet George CAR 142467                           
.           Added VALACC00 to validate for ACC Number(Report 26)           
.           Added VALACK00 to validate if ACC Exists (Report 27) 
.           Added VALINC00 to increment Next ACC Number parameter(Report 28)
.------------------------------------------------------------------------------
. V9.08.11  08/05/2007  Mike Laming  CAR 137125 HDP 2007 DRG 5.2
.           Mods to PATDGWFD - Add field PTDWDRGV (add to Keys) 
. V9.08.10  19/04/2007  Jill Habasque CAR 138875
.           Added saving of PROCCNTR when checking nzpcmtaf
. V9.08.09  12/04/2007  Mike Laming   CAR 137125 HDP 2007 DRG 5.2 
.           Added DRGO52FN - recompiled for PAT41GRP & VAR41GRP
.           Added routine DCLM0000 (Get default claim code) to make it work
. V9.08.08  19/02/2007 Peter Vela     CAR 135241  
.           Recompiled for WEBDINVS - St. John of God invoice layout
. V9.08.07  13/02/2007  Jill Habasque CAR 120004
.           Added default checking in CCFN0000
.           Added VALNZM00
. V9.08.06  09/02/2007  Janet George  CAR 130263
.           Added reports for RS Validations of Item No, Admission No
.           and Extract File
. V9.08.05  31/01/2007  Peter Vela    CAR 127930
.           Recompled for MRTCONFD
. V9.08.04  05/12/2006  Peter Vela    CAR 126013
.           Recompiled for PMSREGFD
.           02/01/2007  Jill Habasque CAR 120004
.           Added PROCWARD for nz matrix check
. V9.08.03  28/11/2006  Jill Habasque CAR 120004
.           Added check for NZ contract match  
. V9.08.02  25/10/2006  Davin S       CAR 121542
.           Added parameter reads for pat41grp
. V9.08.01  27/09/2006  Ebon Clements CAR 119991
.           Added report 20 - select options for theatre selection list
.------------------------------------------------------------------------------
. V9.07.04  09/08/2006  Ebon Clements CAR 103367
.           Added report 19 validate fee estimate regime code
. V9.07.03  11/07/2006  Davin S       CAR 111764
.           Added 2006/2007 WIES13 file (patw13af)
. V9.07.02  10/07/2006  Peter Vela    CAR 111913
.           Recompiled for PAT41GRP
. V9.07.01  10/07/2006  Peter Vela    CAR 111913
.           Recompiled for PAT41GRP
.------------------------------------------------------------------------------
. V9.06.01  15/05/2006  Mike Laming   CAR 105244      2006 HDP
.           ADD PTCNGDV5 for ICD10 Ed.5 Go-live 
.------------------------------------------------------------------------------
. V9.05.02  05/04/2006  Jill Habasque CAR 99867
.           Added remote script to return pmsprdaf details      
. V9.05.01  09/03/2006  Ebon Clements CAR 78533
.           Mods for PATCODTM - Hospital specific category codes
. V9.05.B01 07/02/2006  Peter Vela    CAR 92244
.           Recompiled for PAT41GRP
.------------------------------------------------------------------------------
. V9.04.17  20/09/2005  Ebon Clements CAR 76986
.           Changed to use XMLRED00 
. V9.04.16  19/09/2005  Jill Habasque CAR 75952
.           Added VALSUS00 - validate patient suspension
. V9.04.15  22/07/2005  Peter Vela    CAR 66960
.           Added 2005/2006 WIES12 file (patw12bf)
. V9.04.14  24/05/2005  Mike Laming   CAR 61562
.           July 2005 mods for DRG 5.1 - Recomp for PAT41GRP & VAR41GRP
. V9.04.13  29/04/2005  Peter Vela       CAR 55214
.           Recompiled for MRTCONFD
. V9.04.13  29/04/2005  Peter Vela       CAR 55214
.           Recompiled for MRTCONFD
. V9.04.12  15/03/2005  Lina Vo          CAR 56404
.           Added Report 16 - Validate Equipment                
. V9.04.11  23/02/2005  Lina Vo          CAR 56404
.           Added Report 15 - Validate Tray                
. V9.04.10  17/02/2005  Lina Vo          CAR 56406
.           Changed GETCCA00 to allow All Cost Centre Security
. V9.04.09  28/01/2005  Lina Vo          CAR 56406
.           Added Report 9  - Get Originator                
.           Added Report 10 - Get Catalog                
.           Added Report 11 - Get GST                    
.           Added Report 12 - Get Cost Centre            
.           Added Report 13 - Get Catalog Supply Unit    
.           Added Report 14 - Add NUMBDAYS to VALDDATE   
. V9.04.08  13/12/2004  Henry Son        CAR 55406
.           Change CME to read new output format.
.           Re-compile PAT41GRP.
. V9.04.07  09/12/2004 Henry Son                      CAR 54882
.           Populate operation times from patmmbsf.
.           Add PATMMBFD for PAT41GRP Compile.
. V9.04.06  23/11/2004 Lina Vo                        CAR 34301
.           Added Report 8 - Get DRG WIES
. V9.04.05  22/11/2004 Ebon Clements                  CAR 55239
.           Added Report 7 - Validate HCP Case Team
. V9.04.04  09/11/2004 Lina Vo                        CAR 54900
.           Added Report 6 - Validate Adjust Theatre Start times
. V9.04.03  20/10/2004 Jill Habasque                  CAR 54412
.           Added check for duplicate registrations                      
. V9.04.02  06/10/2004 Lina Vo                        CAR 53798
.           Added Report 4 - Validate Item/Misc Charge                   
. V9.04.01  18/08/2004 Lina Vo                        CAR 52746
.           Added Report 3 - Output Select Options for Ward depending on 
.           Hospital ID
. V9.03.00  05/07/2004 Ebon Clements                  CAR 51065
.           Created Program
.----------------------------------------------------------------------
          INC       IBAWEBDF    
          INC       WEBDATDF
.
          INC       ALLCASFD/INC
          INC       ALLPRRFD/INC
          INC       ALLDIAFD/INC
          INC       ALLCTMFD/INC
          INC       ALLDEPFD/INC
          INC       ALLCONFD/INC
          INC       ALLSERFD/INC            * Service Types for Each Department
.
          INC       IBAGEDFD/INC
.
          INC       MRTCONFD/INC
.
          INC       DISMASFD/INC
          INC       DISPTLFD/INC
          INC       BOKRC1FD/INC
          INC       BOKRQ1FD/INC
          INC       BOKRX1FD/INC
          INC       EMRSITFD/INC
          INC       IBADPTFD/INC
          INC       MLTHCPFD/INC
          INC       WATTR1FD/INC
          INC       MEHLERFD/INC
          INC       MEHDLSFD/INC
          INC       MEHHONFD/INC
          INC       NHIMASFD/INC
          INC       OUTSITFD/INC
          INC       PATALRFD/INC
          INC       PATASFFD/INC
          INC       PATBFEFD/INC
          INC       PATCALAG/INC
          INC       PATCFAFD/INC
          INC       PATCMPFD/INC
          INC       PATCMXFD/INC
          INC       PATCONFD/INC
          INC       PATDRGFD/INC
          INC       PATDSCFD/INC
          INC       PATDGWFD/INC
          INC       PATECDFD/INC
          INC       PATECMFD/INC            * Episode Morbidity Changes
          INC       PATECOFD/INC
          INC       PATFN1FD/INC
          INC       PATFX1FD/INC
          INC       PATHLFFD/INC
          INC       PATLINFD/INC
          INC       PATCMCFD/INC
          INC       PATICDFD/INC
          INC       PATICOFD/INC
          INC       PATICUFD/INC
          INC       PATITMFD/INC
          INC       PATFAPFD/INC
          INC       PATINVFD/INC
          INC       PATGSRFD/INC
          INC       PATHSPFD/INC
          INC       PATMA1FD/INC
          INC       PATMCHFD/INC
          INC       PATMI1FD/INC
          INC       PATNIDFD/INC
          INC       PATPGRFD/INC
          INC       PATRE1FD/INC
          INC       PATSUSFD/INC
          INC       PATTRNFD/INC
          INC       PATWR1FD/INC
          INC       PATSAIFD/INC
          INC       PATVADFD/INC
          INC       PATWC1FD/INC
          INC       PMSADCFD/INC
          INC       PMSBRQFD/INC
          INC       PMSCCDFD/INC
          INC       PMSCIDFD/INC
          INC       PMSHCPFD/INC
          INC       PMSHCGFD/INC
          INC       PMSSPEFD/INC
          INC       PMSTEMFD/INC
          INC       PMSRLDFD/INC
          INC       PMSTMDFD/INC
          INC       PMSUPDFD/INC
          INC       PMSWX1FD/INC
          INC       PMSWAEFD/INC
          INC       ACCCMTFD/INC
.
          INC       PATDTRFD/INC
          INC       PMSMTIFD/INC
          INC       PATVISFD/INC
          INC       PMSREGFD/INC
          INC       PMSPRDFD/INC
          INC       PMSPX2FD/INC
          INC       PMSVX1FD/INC
          INC       NZPCMTFD/INC
          INC       NZPCFNFD/INC
          INC       MLTCFNFD/INC
          INC       NZPPFEFD/INC
.
          INC       OBSAUDFD/INC
          INC       OPRAVEFD/INC
          INC       OPRCONFD/INC
          INC       OPRCSUFD/INC
          INC       OPRDEAFD/INC
          INC       OPRDEDFD/INC
          INC       OPREQPFD/INC
          INC       OPRSESFD/INC
          INC       OPRTRAFD/INC
          INC       OPRTSMFD/INC
          INC       OPROPRFD/INC
.
          INC       OUTBB1FD/INC
          INC       OUTBOAFD/INC
          INC       OUTCVTFD/INC
          INC       PATMMBFD/INC
          INC       PATONLFD/INC
          INC       PRIALSFD/INC
          INC       PRIDOCFD/INC
          INC       PRISECFD/INC
          INC       PRIHDBFD/INC
          INC       PRIHREFD/INC
          INC       PRIPRAFD/INC
.
          INC       RCPBNKFD/INC
          INC       RCPDTEFD/INC
          INC       RCPREGFD/INC
.
          INC       SINCCAFD/INC
          INC       SINCIAFD/INC
          INC       SINCICFD/INC
          INC       SINCIEFD/INC
          INC       SINCSEFD/INC
          INC       SINFACFD/INC
          INC       SINORIFD/INC
          INC       SINPOAFD/INC
          INC       SINPOCFD/INC
          INC       SINSCDFD/INC
          INC       SINSCMFD/INC
          INC       VISXDCFD/INC
.
          INC       TMPJRNFD/INC
.
          INC       WEBHSPFD/INC
.
          INC       WEBDINVS/INC
.
.  For Grouper
.
          INC       WEBGRPVA/INC          * Variables for WEBGROUP    *I-190768
          INC       VARWISCM/INC          * Common variables for WIES
          INC       VARWIS11/INC          * Variables for PATWIS11
          INC       VARWIS12/INC          * Variables for PATWIS12
          INC       VARWIS13/INC          * Variables for PATWIS13
          INC       VARWIS14/INC          * Variables for PATWIS14    *I-145161
          INC       VARWIS15/INC          * Variables for PATWIS15
          INC       VARWIS16/INC          * Variables for PATWIS16
          INC       VARWIS17/INC          * Variables for PATWIS17
          INC       VARWIS18/INC          * Variables for PATWIS18
          INC       VARWIS19/INC          * Variables for PATWIS19
          INC       VARWIS20/INC          * Variables for PATWIS20
          INC       VARWIS21/INC          * Variables for PATWIS21
          INC       PATW11FD/INC          * WIES11 File
          INC       PATW12FD/INC          * WIES12 File
          INC       PTW12BFD/INC
          INC       PATW13FD/INC
          INC       PATW14FD/INC          * Cost Weights for WIES14   *I-145161
          INC       PATW15FD/INC          * Cost Weights for WIES15
          INC       PATW16FD/INC          * Cost Weights for WIES16
          INC       PATW17FD/INC          * Cost Weights for WIES17
          INC       PATW18FD/INC          * Cost Weights for WIES18
          INC       PATW19FD/INC          * Cost Weights for WIES19
          INC       PATW20FD/INC          * Cost Weights for WIES20
          INC       PATW21FD/INC          * Cost Weights for WIES21
          INC       PATWIEFD/INC          * Cost Weights
          INC       PATRDCFD/INC
          INC       PATCHCFD/INC
          INC       PATCRCFD/INC          * Cross Consultations
          INC       WEBGRPFD/INC
          INC       WEBSGPFD/INC
          INC       PMSEDGFD/INC       * Effective DRG Dates
          INC       TFILEVAR/INC
.
.Acc Variables
.
ADMNUMBR  DIM       8
ADMTHOSP  FORM      1
BKFLAG    FORM      1
CFILEPRE  DIM       3                       * Site Prefix
CHKDIGIT  DIM       1                            * check digit
CHKPRDTO  FORM      6                            * check digit product total
CHKPRDCT  FORM      6                            * check digit product
CHKREMAN  FORM      2                            * check digit remainder
CHRCOUNT  FORM      1
CLAIMNUM  DIM       7                      * Claim Number
CURRENTA  FORM      1
DIM1A     DIM       1
DIM3      DIM       3
DIM3A     DIM       3
DIM7      DIM       7
DIM9      DIM       9
DIM11     DIM       11
DIM18     DIM       18
DIM18A    DIM       18
DIM20A    DIM       20
FORM5     FORM      5
FORM10    FORM      10
FORM61    FORM      6
DIMV2     DIM       2
COMMTYPE  DIM       3                      * Comment Type
COMMLINO  DIM       3    * Comment Line No
SAVDATA1  DIM       200
SAVDATA2  DIM       200
COMMCONT  FORM      3  
FORM31    FORM      3
.
CALDAYS   FORM      8
CATAHDP   DIM       1
CATAHDP2  DIM       2
CATBTHDP  DIM       4
CATCCHDP  DIM       2
CATCGI12  DIM       1
CATDDI01  DIM       1
CATDDI05  DIM       1
CATCLHDP  DIM       4
CATKDHDP  DIM       4
CATMIND1  DIM       1
CMDLINE   DIM       227
CMPCNT    FORM      1
CODETYPE  DIM       1       * Type of code, O - operation
.                                           D - disease
COD1CNT   FORM      3
COD9CNT   FORM      2
COUNTER   FORM      3
COUNTFL   FORM      1
CONTPROC  DIM       9
CPROCNUM  FORM      3
CPROCODE  DIM       9
CURRCASE  FORM      3
CURRDATE  DIM       8
CURSESS   DIM       22       * Current session (HospitalID,Date/Time/Clinic)
.
DATEFROM  DIM       12
DATETO    DIM       12
DATESTR   DIM       12
DAYCOL    FORM      4
DDRGCODE  DIM       4
DEFFLAG   FORM      1
DIGCOUNT  FORM      1
DIM4      DIM       4
DIM30     DIM       30
DIM32     DIM       32
DISECODE  DIM       5
DISCOUNT  FORM      2       * Diagnosis Code Counter
DISPDATE  DIM       11                                  
DISPDAT2  DIM       11                                  
DISTYPE   DIM       1       * Disease type
.DMDCCODE  DIM       4
DRGCODE   DIM       3                       * DRG code
DRGOUTFN  DIM       12
.DRGVER    DIM       3
DSSCODE   DIM       9       * Disease/operation code
DURATION  FORM      4
.
EMRBFLAG  FORM      1       * flag to indicate EMR bed type
EOSFLAG   FORM      1             * end of string flag
.                                     0 = not end of string
.                                     1 = end of string
ENCDSP    DIM       2
ENCODERF  DIM       1
ENCOUTFN  DIM       12
ENDDATE1  DATE      8
EPSCD001  FORM      2       * Episode No
EXPDURA   FORM      5       * Expected duration : Recalculate durations
EXPSTART  DIM       5       * Expected start time : Use to Recalculate starts
.
FILENAM1  DIM       8
FILENAM2  DIM       8
FILENAM3  DIM       8
FILENAM4  DIM       8
FNPERIOD  DIM       6
FORM8     FORM      8
.
HOSPNAME  DIM       50
ICDCODE   DIM       9       * Disease/operation code
ICD10DAT  DIM       8
IND3DIM1  DIM       1
.
INVOICEN  FORM      12
JOURITEM  DIM       3
JOURPATT  FORM      12.2
JTYPE     DIM       1
.
KEY21A    DIM       21
KEY26A    DIM       26
.
LASTDIAG  FORM      3       * Last Item of Diagnosis array
LASTPROC  FORM      3       * Last Item of Procedure array
LEAVTYPE  DIM       35
LINKVTYP  FORM      1
LOADNAME  DIM       8
LOADCNT   FORM      3
LOOPFLAG  FORM      2
.
MAXCOUNT  FORM      1
MEDIPRAC  DIM       6
MDCCODE   DIM       3                       * MDC code
.
NMPNUMB   DIM       20
NOOFCODE  FORM      2
NUMBPERD  FORM      2
NXTALPHA  FORM      1
.
OPENONLY  DIM       1       * Only open beds output in ward selection
OPERCLIN  DIM       10
OPERTYPE  DIM       1       * Operation type
OPERDATE  DIM       8       * Operation date (CCYYMMDD)
OPERSTME  DIM       5       * Operation start time
OPERETME  DIM       5       * Operation finish time
OPRCODE   DIM       9       * Operation code
.
ORDQTY    FORM      12.2
.
PERIODFR  DIM       6       * From period
PERIODTO  DIM       6       * To period
PRDSTAT   DIM       1
PREAFLAG  FORM      1
ACCDECDT  DIM       11      * ACC Decline Date
ACCDCDTE  DIM       11      * Patient Declaration Date
ACCIDATE  DIM       11      * Accident Date
STRTALTD  DIM       11      * Start Date of Alternative Work
FLLINCSD  DIM       11      * Full incapacity Start Date
RETURNFM  FORM      1
RTNWDATE  DIM       11      * Return to Normal Work Date
PRDFRDTE  DIM       11
PRDTODTE  DIM       11
PRDCNUMB  DIM       2
PRDCYEAR  DIM       4
PROCADAT  DIM       8
PROCCODE  DIM       7
PROCCLMC  DIM       3
PROCCNTR  DIM       6
PROCHOSP  DIM       3
PROCWARD  DIM       3
PROCSURG  DIM      10
PSAGECON  DIM       3
PSAGETYP  DIM       3
.
RECEIPTN  DIM      12
RTDAYS    FORM      4
.
SAVADMNO  DIM       8
SVEOCLIN  DIM       10
SAVPCNTR  DIM       6
SKEY12    DIM      12
SKEY20    DIM      20
SUPPLIER  DIM       5
SUPPUNIT  DIM       15
.
TEMPDATE  DIM       6
TRANDATE  DIM       8
TRANTIME  DIM       8
TYPOFCOD  DIM       2
.
MPROCCOD  DIM       9[500]
TAGCODE   DIM       4       * Tag Code                                 *I-????
.
UPDTTYPE  DIM       1
USNGICD9  FORM      1
.
VALDCODE  DIM       70
VALDCOD2  DIM       70
VALDCOD3  DIM       70
VALDCOD4  DIM       70
VALDPERD  DIM       2
VALDCTYP  DIM       6
VALDYEAR  DIM       4
VALDSITE  DIM       6
VALDTYPE  DIM       70
VALDSURN  DIM       30
VALDGIVE  DIM       30
VALDGIV1  DIM       30
VALDGIV2  DIM       30
VALDDOBE  DIM       8
VALDDATE  DIM       8
VALDTIME  DIM       8
VALDHOSP  DIM       3
VALDWARD  DIM       3
VALDABED  DIM       3
VALDBTCH  DIM       8
VALDURNO  DIM       8
VALDVISN  DIM       8
VALDINVN  DIM       8
VALDJTYP  DIM       3
VALDINDC  DIM       1
VISTTYPE  DIM       3
.
SHOWIACT  DIM       1
SHOWLDSC  DIM       1
. 
WAHPDATE  FORM      1         * WA Health procedure date test
WARCHECK  DIM       3
WARCODE   DIM       3
WDATE1    DIM       8
WDATE2    DIM       8
WARNMESG  DIM       50
WARNMES2  DIM       50
WARNMES3  DIM       50
WARNMES4  DIM       60
WCFINPFN  DIM       22       * Web Codefinder input filename
WCFOUTFN  DIM       22       * Web Codefinder output filename
WLFLAG    FORM      1
CLNKARAY  DIM       3[9]
SNETARAY  INIT      "13791379"
.
ALPHABET  INIT      "ABCDEFGHIJKLMNOPQRSTUVWXYZ"
CATU1     INIT      "U1"
CATU2     INIT      "U2"
CATU3     INIT      "U3"
CATU4     INIT      "U4"
CATU5     INIT      "U5"
CATU6     INIT      "U6"
CATU7     INIT      "U7"
CATVI     INIT      "VI"
CATct     INIT      "ct"
CATrm     INIT      "rm"
CODED     INIT      "D "
CODEDD    INIT      "DD"
CODEJ     INIT      "J "
CPNZNXTC  INIT      "ABBCCDDEEFFGGHHJJKKLLMMNNPPQQRRSSTTUUVVWWXXYYZZA"
CBB       INIT      ")"
OBB       INIT      "("
DVACHAR1  INIT      "QNVTSW"
DRGINP    INIT      "drginp"
ENCINP    INIT      "encinp"
ENCERR01  INIT      "Backup at Key Word Prompt               "
ENCERR02  INIT      "Abort at Key Word Prompt                "
ENCERR03  INIT      "No Entry at Key Word Prompt             "
ENCERR04  INIT      "Next at Key Word Prompt                 "
ENCERR05  INIT      "Invalid File Format                     "
ENCERR06  INIT      "Bad Command or Command Unauthorised     "
ENCERR07  INIT      "Error Opening Interface Input File      "
ENCERR08  INIT      "Error Opening Interface Output File     "
ENCERR09  INIT      "Output File Already Exists              "
ENCERR10  INIT      "Invalid DRG / Fiscal Year               "
ENCERR12  INIT      "Invalid Codes Passed to Application     "
ENCERR34  INIT      "Not Authorised                          "
ENCERR37  INIT      "Invalid or No Age in Input File         "
ENCERR38  INIT      "Invalid or No Gender in Input File      "
ENCERR39  INIT      "Invalid or Not Integrated in Input File "
ENCERR40  INIT      "Invalid or No State in Input File       "
ENCERR41  INIT      "Invalid or No Payor in Input File       "
ENCERR42  INIT      "Invalid Discharge Date in Input File    "
ESC       INIT      27                      * ESC char
.
WARCD101  INIT      " "
WARCD102  INIT      "A"
WARCD103  INIT      "N"
WARCD104  INIT      "P"
WARCD105  INIT      "Q"
WARCD106  INIT      "X"
WARCD107  INIT      "V"
WARCD201  INIT      "BW"
WARCD202  INIT      "CN"
WARCD203  INIT      "GW"
WARCD204  INIT      "IV"
WARCD205  INIT      "KM"
WARCD206  INIT      "NF"
WARCD207  INIT      "NG"
WARCD208  INIT      "NK"
WARCD209  INIT      "NX"
WARCD210  INIT      "PK"
WARCD211  INIT      "PX"
WARCD212  INIT      "RD"
WARCD213  INIT      "SA"
WARCD214  INIT      "SL"
WARCD215  INIT      "SM"
WARCD216  INIT      "SR"
WARCD217  INIT      "SS"
WARCD301  INIT      "AGX"
WARCD302  INIT      "BUR"
WARCD303  INIT      "CGW"
WARCD304  INIT      "CNK"
WARCD305  INIT      "CNX"
WARCD306  INIT      "CNS"
WARCD307  INIT      "FIJ"
WARCD308  INIT      "GHA"
WARCD309  INIT      "HKS"
WARCD310  INIT      "HKX"
WARCD311  INIT      "IND"
WARCD312  INIT      "KYA"
WARCD313  INIT      "MAL"
WARCD314  INIT      "MAU"
WARCD315  INIT      "MLS"
WARCD316  INIT      "MTX"
WARCD317  INIT      "MWI"
WARCD318  INIT      "NGR"
WARCD319  INIT      "NRD"
WARCD320  INIT      "NSM"
WARCD321  INIT      "NSS"
WARCD322  INIT      "NSW"
WARCD323  INIT      "PAD"
WARCD324  INIT      "PAM"
WARCD325  INIT      "PCA"
WARCD326  INIT      "PCR"
WARCD327  INIT      "PCV"
WARCD328  INIT      "PMS"
WARCD329  INIT      "PSM"
WARCD330  INIT      "PSW"
WARCD331  INIT      "PWO"
WARCD332  INIT      "RDX"
WARCD333  INIT      "SAX"
WARCD334  INIT      "SUD"
WARCD335  INIT      "SWP"
WARCD336  INIT      "TZA"
.
ENCFILEF  FILE      ASCII,FIXED=256
ENCOUTAF  FILE      ASCII,FIXED=256
LOADFILE  FILE      ASCII,FIXED=200
TEMP1     FILE      ASCII,FIXED=660
.------------------------------------------------------------
PRGID     INIT      "COMWEB80"
VERSION   INIT      "V12.00.02"
PRGNAM    INIT      "Common XML Remote Code Validation Service"
.------------------------------------------------------------
.
          CALL      WEBINT00                * Initialise Fifo Etc.
          CALL      INIT0000                * Open Files
.
MAIN1000  CALL      XMLRED00       * Read Fifo WEBPID and USERID
.
          CALL      OUTFIL00                * Check Correct Site Files Are Open
          BRANCH    EXIT,MAIN1000
.
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          BRANCH    REPORTNO,MAIN1100,MAIN1200,MAIN1300,MAIN1400,MAIN1500:
                             MAIN1600,MAIN1700,MAIN1800,MAIN1900,MAIN2000:
                             MAIN2100,MAIN2200,MAIN2300,MAIN2400,MAIN2500:
                             MAIN2600,MAIN2700,MAIN2800,MAIN2900,MAIN3000:
                             MAIN3100,MAIN3200,MAIN3300,MAIN3400,MAIN3500:
                             MAIN3600,MAIN3700,MAIN3800,MAIN3900,MAIN4000:
                             MAIN4100,MAIN4200,MAIN4300,MAIN4400,MAIN4500:
                             MAIN4600,MAIN4700,MAIN4800,MAIN4900,MAIN5000:
                             MAIN5100,MAIN5200,MAIN5300,MAIN5400,MAIN5500:
                             MAIN5600,MAIN5700,MAIN5800,MAIN5900,MAIN6000:
                             MAIN6100,MAIN6200,MAIN6300,MAIN6400,MAIN6500:
                             MAIN6600,MAIN6700,MAIN6800,MAIN6900,MAIN7000:
                             MAIN7100,MAIN7200,MAIN7300,MAIN7400,MAIN7500:
                             MAIN7600,MAIN7700,MAIN7800,MAIN7900,MAIN8000:
                             MAIN8100,MAIN8200,MAIN8300,MAIN8400,MAIN8500:
                             MAIN8600,MAIN8700,MAIN8800,MAIN8900,MAIN9000:
                             MAIN9100,MAIN9200,MAIN9300,MAIN9400,MAIN9500:
                             MAIN9600,MAIN9700,MAIN9800,MAIN9900,MAIN99A0:
                             MAIN99B0,MAIN99C0,MAIN99D0,MAIN99E0,MAIN99F0:
                             MAIN99G0,MAIN99H0,MAIN99I0,MAIN99J0
.
          PACK      WEBTITLE,PRGID,SP1,VERSION,SP1,PRGNAM,SP70
          MOVE      "INVALID OPTION",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          GOTO      MAIN1000
.
MAIN1100  CALL      VALPRD00           * Validate Financial Period
          GOTO      MAIN1000
.
MAIN1200  CALL      CHKPRD00           * Validate Financial Period IBAOPR92
          GOTO      MAIN1000
.
MAIN1300  CALL      SELWRD00           * Output Ward depending on Hospital 
          GOTO      MAIN1000
.
MAIN1400  CALL      VALITM00           * Validate Item/Misc Charge
          GOTO      MAIN1000
.
MAIN1500  CALL      VALDUP00           * Validate for Duplicate Registration
          GOTO      MAIN1000
.
MAIN1600  CALL      VALTST00           * Validate Adjust theatre Start times
          GOTO      MAIN1000
.
MAIN1700  CALL      VALTEA00           * Validate HCP Case Team Code
          GOTO      MAIN1000
.
MAIN1800  CALL      GETWIE00           * Get DRG WEIS
          GOTO      MAIN1000
.
MAIN1900  CALL      GETORI00           * Get Purchase Order Originator 
          GOTO      MAIN1000
.
MAIN2000  CALL      GETCIA00           * Get Purchase Order Catalog 
          GOTO      MAIN1000
.
MAIN2100  CALL      GETGST00           * Get GST Rate 
          GOTO      MAIN1000
.
MAIN2200  CALL      GETCCA00           * Get Cost Centre
          GOTO      MAIN1000
.
MAIN2300  CALL      GETCIC00           * Get Catalog Supply Unit
          GOTO      MAIN1000
.
MAIN2400  CALL      GETDAT00           * Get Date - Add NUMBDAYS to VALDDATE
          GOTO      MAIN1000
.
MAIN2500  CALL      VALTRA00           * Validate Operating Room Tray       
          GOTO      MAIN1000
.
MAIN2600  CALL      VALEQP00           * Validate Operating Room Equipment 
          GOTO      MAIN1000
.
MAIN2700  CALL      VALSUS00           * Validate Suspension Dates
          GOTO      MAIN1000
.
MAIN2800  CALL      GETPRS00           * Get PRS2 details for a hospital code
          GOTO      MAIN1000
.
MAIN2900  CALL      VALREG00           * Validate Fee Estimate Regime Code
          GOTO      MAIN1000
.
MAIN3000  CALL      SELOPR00           * Theatre selection list options    
          GOTO      MAIN1000
.
MAIN3100  CALL      NZMX0000           * Check nz private matrix            
          GOTO      MAIN1000
.
MAIN3200  CALL      VALEXT00           * Validate if Extract File exists
          GOTO      MAIN1000
.
MAIN3300  CALL      VALITN00           * Validate if Item Code Exists
          GOTO      MAIN1000
.
MAIN3400  CALL      VALADM00           * Validate if Admssion No Exists
          GOTO      MAIN1000
.
MAIN3500  CALL      VALNZM00           * Validate if nz private matrix 
          GOTO      MAIN1000
.
MAIN3600  CALL      VALACC00           * Validate ACC Number
          GOTO      MAIN1000
.
MAIN3700  CALL      VALACK00           * ACC Number Exists ? 
          GOTO      MAIN1000
.
MAIN3800  CALL      VALINC00           * Increment ACC Number
          GOTO      MAIN1000
.
MAIN3900  CALL      VALADC00           * Validate adverse outcome
          GOTO      MAIN1000
.
MAIN4000  CALL      GFYEAR00           * Get Financial year
          GOTO      MAIN1000
.
MAIN4100  CALL      SELWBD00           * Selection list of beds for a ward
          GOTO      MAIN1000
.
MAIN4200  CALL      SECGRP00           * Web security groups
          GOTO      MAIN1000
.
MAIN4300  CALL      SELWEK00           * Output Week selection list 
          GOTO      MAIN1000
.
MAIN4400  CALL      ECTC0000           * Output ECT Counts
          GOTO      MAIN1000
.
MAIN4500  CALL      SELPLN00           * Selection list of Act.Plan for a Claim
          GOTO      MAIN1000
.
MAIN4600  CALL      CHKWB000           * Check for WL or booking or preadmit
          GOTO      MAIN1000
.
MAIN4700  CALL      SECURL00           * Web security groups login URL
          GOTO      MAIN1000
.
MAIN4800  CALL      RCPNO000           * Validate Receipt Number       
          GOTO      MAIN1000
.
MAIN4900  CALL      GETWR000           * Get Ward/Bed details
          GOTO      MAIN1000
.
MAIN5000  CALL      GETSRF00           * Source of Referral Selection List based
          GOTO      MAIN1000           * on OP site cat for source of referral
.
MAIN5100  CALL      VALDPL00           * Link Unlink Patient Disaster disptlaf
          GOTO      MAIN1000           
.
MAIN5200  CALL      MULTAD00           * Check for multiple admissions
          GOTO      MAIN1000           
.
MAIN5300  CALL      AVLWBD00           * Selection list of beds for a ward
          GOTO      MAIN1000           * (empty only)
.
MAIN5400  CALL      DISDAT00           * Disaster Code Date Validation
          GOTO      MAIN1000
.
MAIN5500  CALL      SELUNT00           * output valid units for HCP/hosp
          GOTO      MAIN1000
.
MAIN5600  CALL      SELTEM00           * output valid teams for HCP/hosp/unit
          GOTO      MAIN1000
.
MAIN5700  CALL      QUNQ0000           * output qualified/unqualified cat A
          GOTO      MAIN1000
.
MAIN5800  CALL      SELROL00           * output valid roles for HCP/hosp
          GOTO      MAIN1000
.
MAIN5900  CALL      WARDBD00           * Selection list of beds for a ward
          GOTO      MAIN1000           * with ward type and mandatory bed test
.
MAIN6000  CALL      MHDLVL00           * Check for open legal status records
          GOTO      MAIN1000
.
MAIN6100  CALL      DUPAL000           * Validate duplicate alerts
          GOTO      MAIN1000
.
MAIN6200  CALL      MULTYB00           * Check for multiple births
          GOTO      MAIN1000
.
MAIN6300  CALL      DUPAD000           * Validate duplicate alerts on update
          GOTO      MAIN1000
.
MAIN6400  CALL      EXTDAT00           * Get Extract Last Run Date           
          GOTO      MAIN1000
.
MAIN6500  CALL      SELCOD00           * Cat code selections for a give
          GOTO      MAIN1000           * hospital
.
MAIN6600  CALL      SELMHT00           * Mental Health Team Selection List for 
          GOTO      MAIN1000           * a given Doc
.
MAIN6700  CALL      CALPRD00           * Calculate number of financial periods 
          GOTO      MAIN1000          
.
MAIN6800  CALL      OUTVTD00           * Output visit type for a visit number 
          GOTO      MAIN1000          
.
MAIN6900  CALL      SELAPR00           * Select option for AH problems by department
          GOTO      MAIN1000
.
MAIN7000  CALL      DEFAPR00           * Default AH problem code by department
          GOTO      MAIN1000
.
MAIN7100  CALL      GTCATL00
          GOTO      MAIN1000
.
MAIN7200  CALL      SELCCT00
          GOTO      MAIN1000
.
MAIN7300  CALL      SELSIT00           * Output EMR Sites depending on Hospital
          GOTO      MAIN1000
.
MAIN7400  CALL      SELDEP00           * Output printer depts depending on Hosp
          GOTO      MAIN1000
.
MAIN7500  CALL      GTDWSD00           * Get deflt ward/site/dept for user/hosp
          GOTO      MAIN1000
.
MAIN7600  CALL      CEMRBT00           * Check if EMR bed type for inp episode
          GOTO      MAIN1000
.
MAIN7700  CALL      OPRAV100           * Operation Averages - Calculate Minutes
          GOTO      MAIN1000
.
MAIN7800  CALL      LUHSDP00           * List User's Dept for a given hospital
          GOTO      MAIN1000
.
MAIN7900  CALL      VACTYP00           * Validate Cat A / Cat CC combo for WA
          GOTO      MAIN1000
.
MAIN8000  CALL      VAREHB00           * Validate Cat BT / Cat CG combo for WA
          GOTO      MAIN1000
.
MAIN8100  CALL      VAEMPL00           * Validate Cat KD / Age combo for WA
          GOTO      MAIN1000
.
MAIN8200  CALL      VACLWD00           * Validate Cat CL and Amb Ward for WA
          GOTO      MAIN1000
.
MAIN8300  CALL      VATHSP00           * Validate transfer src/current hosp WA
          GOTO      MAIN1000
.
MAIN8400  CALL      VANEWB00           * Validate Age of Parent for WAHealth
          GOTO      MAIN1000
.
MAIN8500  CALL      VAMBLN00           * Validate Mother/Baby link for WAHealth
          GOTO      MAIN1000
.
MAIN8600  CALL      VACCTY00           * Validate Concession Card Types
          GOTO      MAIN1000
.
MAIN8700  CALL      VAAMAR00           * Validate Age / Marital Status
          GOTO      MAIN1000
.
MAIN8800  CALL      CHKUPD00          * Check last demographics update date/time
          GOTO      MAIN1000
.
MAIN8900  CALL      SELDIA00           * Select option for AH diagnosis by 
          GOTO      MAIN1000           * department
.
MAIN9000  CALL      CBAL0000           * Current balance invoice amt after Jrnl
          GOTO      MAIN1000
.
MAIN9100  CALL      HCPHOS00           * HCP hospital access selection list  
          GOTO      MAIN1000
.
MAIN9200  CALL      DEPSRV00           * Referral Department Services list
          GOTO      MAIN1000
.
MAIN9300  CALL      VALICH00           * Validate ICD10 codes including
          GOTO      MAIN1000           * non existent header records
.
MAIN9400  CALL      VALDRV00
          GOTO      MAIN1000
.
MAIN9500  CALL      CHKINP00           * Check if U/R is current inpatient 
          GOTO      MAIN1000
.
MAIN9600  CALL      CRSCON00           * Report 86: Check for Cross Consultation
          GOTO      MAIN1000
.
MAIN9700  CALL      MPSDOC00           * List of Serviced Doctor for a U/R & MP
          GOTO      MAIN1000
.
MAIN9800  CALL      VHCGDS00           * Validate HCP Practice DS fields
          GOTO      MAIN1000
.
MAIN9900  CALL      VDBMST00           * Validate DOB / Marital Status  
          GOTO      MAIN1000
.
MAIN99A0  CALL      VLDRUG00           * Validate drug orders bokrx1af
          GOTO      MAIN1000
.
MAIN99B0  CALL      VWOBAD00           * Write view record to clinical documents
          GOTO      MAIN1000           * OBSAUD
.
MAIN99C0  CALL      VBULJR00           * Validate Bulk Journal
          GOTO      MAIN1000
.
MAIN99D0  CALL      VTRQCM00           * Validate Theatre Request Comments
          GOTO      MAIN1000
.
MAIN99E0  CALL      VTRQRC00           * Validate Theatre Request Record
          GOTO      MAIN1000
.
MAIN99F0  CALL      CHKDEC00           * Check if patient is deceased
          GOTO      MAIN1000
.
MAIN99G0  CALL      VALDMP00           * Validate Doctor for a Medical Prac
          GOTO      MAIN1000
.
MAIN99H0  CALL      VALSPE00           * Validate HCP / Specialty
          GOTO      MAIN1000
.
MAIN99I0  CALL      GPCEHR00           * Get PCEHR Variables
          GOTO      MAIN1000
.
MAIN99J0  CALL      GETLOS00           * Get Length of Stay Default - NZ
          GOTO      MAIN1000
.
.-------------------------------------------------------------------------------
.-------------------------------------------------------------------------------
. Open Files and Initialize Variables
.-------------------------------------------------------------------------------
INIT0000  OPEN      CONTROLF,"controlf"
.
          OPEN      ALLCASA1,"allcasaf"
          OPEN      ALLPRRA2,"allprraf"
          OPEN      ALLDIAA1,"alldiaaf"
          OPEN      ALLDIAA2,"alldiaaf"
          OPEN      ALLCTMA1,"allctmaf"
          OPEN      ALLCTMA2,"allctmaf"
          OPEN      ALLDEPA2,"alldepaf"
          OPEN      ALLSERA1,"allseraf"
          OPEN      ALLSERA2,"allseraf"
.
          OPEN      IBAGEDA1,"ibagedaf"
.
          OPEN      BOKRC1A1,"bokrc1af"
          OPEN      BOKRQ1A1,"bokrq1af"
          OPEN      BOKRX1A1,"bokrx1af"
          OPEN      DISMASA1,"dismasaf"
          OPEN      DISPTLA1,"disptlaf"
          OPEN      EMRSITA1,"emrsitaf"
          OPEN      IBADPTA1,"ibadptaf"
          OPEN      MLTHCPA2,"mlthcpaf"
          OPEN      OUTSITA1,"outsitaf"
          OPEN      PATMA1A1,"patma1af"
          OPEN      PATMX1A1,"patmx1af"
          OPEN      PATALRT1,"patalrtf"
          OPEN      PATASFA1,"patasfaf"
          OPEN      PATCODE1,"patcodes"
          OPEN      PATCODE2,"patcodes"
          OPEN      PATCMCA1,"patcmcaf"
          OPEN      PATDSCH1,"patdschf"
          OPEN      PATDRGA1,"patdrgaf"
          OPEN      PATDRGA2,"patdrgaf"
          OPEN      PATDRGA3,"patdrgaf"
          OPEN      PATDGWA1,"patdgwaf"
          OPEN      PATECDA1,"patecdaf"
          OPEN      PATECDA2,"patecdaf"
          OPEN      PATECDA3,"patecdaf"
          OPEN      PATECDA5,"patecdaf"
          OPEN      PATECDA1,"patecdaf"
          OPEN      PATECOA1,"patecoaf"
          OPEN      PATECOA2,"patecoaf"
          OPEN      PATECOA3,"patecoaf"
          OPEN      PATICDD1,"paticddf"
          OPEN      PATICDO1,"paticdof"
          OPEN      PATICUA1,"paticuaf"
          OPEN      PATITEM1,"patitemn"
          OPEN      PATHSPA1,"pathspaf"
          OPEN      PATFN1A1,"patfn1af"
          OPEN      PATGSRN2,"patgsrnf"
          OPEN      PATINVR1,"patinvrf"
          OPEN      PATMCHG1,"patmchgf"
          OPEN      PATMI1A1,"patmi1af"
          OPEN      PATMI1A8,"patmi1af"
          OPEN      PATLINK1,"patlinkf"
          OPEN      PATPGRA1,"patpgraf"
          OPEN      PATTRAN1,"pattranf"
          OPEN      PATTRAN2,"pattranf"
          OPEN      PATWR1A1,"patwr1af"
          OPEN      PATWR1A7,"patwr1af"
          OPEN      PATWR1A8,"patwr1af"
          OPEN      PMSPRDA1,"pmsprdaf"
          OPEN      PATVADA1,"patvadaf"
          OPEN      PATVISA1,"patvisaf"
          OPEN      PATVISA2,"patvisaf"
          OPEN      PATDTRA3,"patdtraf"
          OPEN      PMSMTIA1,"pmsmtiaf"
          OPEN      PMSREGA1,"pmsregaf"
          OPEN      PMSHCPA1,"pmshcpaf"
          OPEN      PMSHCGA1,"pmshcgaf"
          OPEN      PMSSPEA1,"pmsspeaf"
          OPEN      PMSTEMA1,"pmstemaf"
          OPEN      PMSRLDA1,"pmsrldaf"
          OPEN      PMSTMDA1,"pmstmdaf"
          OPEN      PMSVX1A1,"pmsvx1af"
          OPEN      PATMMBS1,"patmmbsf"
          OPEN      PATSUSA1,"patsusaf"
          OPEN      PATSAIA1,"patsaiaf"
          OPEN      NZPCMTA1,"nzpcmtaf"
          OPEN      NZPCMTA3,"nzpcmtaf"
          OPEN      NZPPFEA1,"nzppfeaf"
          OPEN      NZPCFNA1,"nzpcfnaf"
          OPEN      MLTCFNA1,"mltcfnaf"
          OPEN      MEHDLSA1,"mehdlsaf"
          OPEN      PATWC1A1,"patwc1af"
          OPEN      PATWC1A3,"patwc1af"
          OPEN      PMSADCA1,"pmsadcaf"
          OPEN      PMSCCDA1,"pmsccdaf"
          OPEN      PMSUPDA1,"pmsupdaf"
          OPEN      PMSWAEA1,"pmswaeaf"
          OPEN      PMSWX1A1,"pmswx1af"
.
          OPEN      PRIALSA1,"prialsaf"
          OPEN      PRISECA1,"prisecaf"
          OPEN      PRIPRAC1,"pripracf"
          OPEN      PRIHDBT1,"prihdbtf"
          OPEN      PRIHREF1,"prihreff"
          OPEN      ACCCMTA1,"acccmtaf"
.
          OPEN      OBSAUDA1,"obsaudaf"
          OPEN      OPRAVEA1,"opraveaf"
          OPEN      OPRCSUA1,"oprcsuaf"
          OPEN      OPRDETA3,"oprdetaf"
          OPEN      OPRDETA2,"oprdetaf"
          OPEN      OPRDETA1,"oprdetaf"
          OPEN      OPRDETA5,"oprdetaf"
          OPEN      OPRDEDA1,"oprdedaf"
          OPEN      OPREQPA1,"opreqpaf"
          OPEN      OPRSESA1,"oprsesaf"
          OPEN      OPRTRYA1,"oprtryaf"
          OPEN      OPRTSMA1,"oprtsmaf"
          OPEN      OPROPRA1,"opropraf"
          OPEN      WEBGRPA1,"webgrpaf"
          OPEN      WEBSGPA1,"websgpaf"
          OPEN      WEBHSPA1,"webhspaf"
.
          OPEN      RCPBNKA1,"rcpbnkaf"
          OPEN      RCPDTEA3,"rcpdteaf"
          OPEN      RCPREGA1,"rcpregaf"
.
          OPEN      SINCCAA1,"sinccaaf"
          OPEN      SINCIAA1,"sinciaaf"
          OPEN      SINCICA1,"sincicaf"
          OPEN      SINCIEA1,"sincieaf"
          OPEN      SINCSEA1,"sincseaf"
          OPEN      SINFACA1,"sinfacaf"
          OPEN      SINORIA1,"sinoriaf"
          OPEN      SINPOAA1,"sinpoaaf"
          OPEN      SINPOCA6,"sinpocaf"
          OPEN      SINSCDA2,"sinscdaf"
          OPEN      SINSCMA1,"sinscmaf"
.
          OPEN      TMPJRNA1,"tmpjrnaf"
.
.  For Grouper
.
          OPEN      PATW11A1,"patw11af"                                *I-902B1
          OPEN      PATW12A1,"patw12af"                                *I-51504
          OPEN      PATW12B1,"patw12bf"
          OPEN      PATW13A1,"patw13af"
          OPEN      PATW14A1,"patw14af"                               *I-145161
          OPEN      PATW15A1,"patw15af"
          OPEN      PATW16A1,"patw16af"
          OPEN      PATW17A1,"patw17af"
          OPEN      PATW18A1,"patw18af"
          OPEN      PATW19A1,"patw19af"
          OPEN      PATW20A1,"patw20af"
          OPEN      PATW21A1,"patw21af"
          OPEN      PATWIEA1,"patwieaf"
          OPEN      PATRDCA1,"patrdcaf"
          OPEN      PATCRCA1,"patcrcaf"
.
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,TEN;*36,CMDISD,CMOPRT,*94,CAGECOFF:
                                 *235,CMDISP,CMDISS,CMDISC,CMDISA
          READ      CONTROLF,TWENTY;*193,PTCNDCLM
          READ      CONTROLF,TWENTY1;*45,PTCNDRSM
          READ      CONTROLF,FORTY2;*242,OPCNWHCD
          READ      CONTROLF,SIXTY;*248,MRCN3MCD,*249,MRCN3MCG
          READ      CONTROLF,SIXTY1;*240,MRCNUNWA,*241,MRCNENWA
          READ      CONTROLF,SEVENTY7;*195,PTCNDLKR
          READ      CONTROLF,EIGHTY;*250,PTCNHDPS
          READ      CONTROLF,NINTY7;*174,MRCNCLIN,*245,MRCNDFPR:
                                    *248,MRCNEACA,*251,MRCNSCTC
          READ      CONTROLF,HUND05;*147,CMDISM:
                                    *158,PTCNDGPV,*217,PTCNGDV4,*227,PTCNGDV5
          READ      CONTROLF,HUND06;*224,ALCNDHOS
          READ      CONTROLF,HUND09;*151,PTCNGDV3
          READ      CONTROLF,HUND12;*104,PTCNWBDS,*239,PTCNGDV6       *I-163918
          READ      CONTROLF,HUND10;*61,PTCNGDV7,*69,PTCNGDV8:        *I-284420
                                    *77,PTCNGDV9,*85,PTCNGDVX         *I-0833093
          READ      CONTROLF,HUND17;*220,PTCNGDX1
          READ      CONTROLF,HUND24;*121,PTCNDGED
          READ      CONTROLF,HUND28;*231,PTCNGDX2;*239,PTCNE110       *I-0917793
          READ      CONTROLF,HUND30;*86,PTCNGDX3                      *I-0956210
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
          ENDIF
.
          CALL      OPICD1                  * Open ICD Disease files
          CALL      OPICO1
.
          MOVE      "512",CLNKARAY[1]            * weights for centrelink card
          MOVE      "256",CLNKARAY[2]
          MOVE      "128",CLNKARAY[3]
          MOVE      " 64",CLNKARAY[4]
          MOVE      " 32",CLNKARAY[5]
          MOVE      " 16",CLNKARAY[6]
          MOVE      "  8",CLNKARAY[7]
          MOVE      "  4",CLNKARAY[8]
          MOVE      "  2",CLNKARAY[9]
.
          OPEN      OUTSITA1,"outsitaf"
          MOVE      "out",CFILEPRE
          CALL      OPNOUT00
.
INIT9999  RETURN
.
. Note Following Labels Not Used in Service
.
PROFLD00  RETURN 
.------------------------------------------------------------
. Clear Parameters
.------------------------------------------------------------
CLRPAR00  MOVE      SP70,VALDCODE
          MOVE      SP70,VALDCOD2
          MOVE      SP70,VALDCOD3
          MOVE      SP70,VALDCOD4
          MOVE      SP70,VALDTYPE
          MOVE      SP70,VALDPERD
          MOVE      SP70,VALDYEAR
          MOVE      SP70,PRDCYEAR
          MOVE      SP70,PRDCNUMB
          MOVE      SP70,VALDSURN
          MOVE      SP70,VALDGIV1
          MOVE      SP70,VALDGIV2
          MOVE      SP70,VALDDOBE
          MOVE      SP70,VALDDATE
          MOVE      SP70,VALDTIME
          MOVE      SP70,VALDHOSP
          MOVE      ZERO,DURATION
          MOVE      ZERO,NUMBDAYS
          MOVE      ZERO,CURRCASE
          MOVE      SP70,ADMISSNO
          MOVE      SP70,SUPPLIER
          MOVE      SP70,SUPPUNIT
          MOVE      SP70,CPROCODE
          MOVE      SP70,PROCCLMC
          MOVE      SP70,CONTPROC
          MOVE      SP70,PROCCNTR
          MOVE      SP70,PROCSURG
          MOVE      SP70,PROCADAT
          MOVE      SP70,TRANDATE
          MOVE      SP70,TRANTIME
          MOVE      SP70,PROCHOSP
          MOVE      SP70,PROCWARD
          MOVE      SP70,FRSTDATE
          MOVE      SP70,LASTDATE
          MOVE      SP70,VYEARMTH
          MOVE      SP70,RECEIPTN
          MOVE      ZERO,RETURNFM
          MOVE      SP70,VALDWARD
          MOVE      SP70,VALDABED
          MOVE      SP70,PERIODFR
          MOVE      SP70,PERIODTO
          MOVE      ZERO,INVOICEN
          MOVE      SP70,JOURITEM
          MOVE      ZERO,JOURPATT
          MOVE      ZERO,USNGICD9
          MOVE      SP70,ICD10DAT
          MOVE      SP70,VALDBTCH
          MOVE      SP70,VALDURNO
          MOVE      SP70,VALDVISN
          MOVE      SP70,VALDINVN
          MOVE      SP70,VALDJTYP
          MOVE      SP1,VALDINDC
          MOVE      SP70,MEDIPRAC
          MOVE      SP70,OPENONLY
          MOVE      SP70,VALDSITE
          MOVE      SP70,VALDCTYP
          MOVE      SP70,SHOWIACT
          MOVE      SP70,SHOWLDSC
          MOVE      ZERO,UNIXNWAU
.
CLRPAR99  RETURN
.------------------------------------------------------------
. Set Parameters
.------------------------------------------------------------
SETPAR00  MATCH     "valdcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDCODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdcod2=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDCOD2
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdcod3=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDCOD3
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdcod4=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDCOD4
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdperd=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDPERD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdyear=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDYEAR
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prdcyear=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRDCYEAR
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prdcnumb=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRDCNUMB
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdsurn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDSURN
            PACK      VALDSURN,VALDSURN,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdgive=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDGIVE
            PACK      VALDGIVE,VALDGIVE,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdgiv1=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDGIV1
            PACK      VALDGIV1,VALDGIV1,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdgiv2=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDGIV2
            PACK      VALDGIV2,VALDGIV2,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valddobe=",QRYNAME
          IF        @EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00            * Set CMON from MTHNAM3
            PACK      VALDDOBE,CCENT,CYEAR,CMON,CDAY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valddate=",QRYNAME
          IF        @EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00            * Set CMON from MTHNAM3
            PACK      VALDDATE,CCENT,CYEAR,CMON,CDAY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdtime=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDTIME
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdhosp=",QRYNAME
          IF        @EQUAL
            PACK      VALDHOSP,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "numbdays=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NUMBDAYS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "duration=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DURATION
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "currcase=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CURRCASE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admissno=",QRYNAME
          IF        @EQUAL
            PACK      ADMISSNO,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "supplier=",QRYNAME
          IF        @EQUAL
            PACK      SUPPLIER,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "suppunit=",QRYNAME
          IF        @EQUAL
            PACK      SUPPUNIT,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "cprocode=",QRYNAME
          IF        @EQUAL
            PACK      CPROCODE,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "procclmc=",QRYNAME
          IF        @EQUAL
            PACK      PROCCLMC,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prochosp=",QRYNAME
          IF        @EQUAL
            PACK      PROCHOSP,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "procward=",QRYNAME
          IF        @EQUAL
            PACK      PROCWARD,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "contproc=",QRYNAME
          IF        @EQUAL
            PACK      CONTPROC,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "proccntr=",QRYNAME
          IF        @EQUAL
            PACK      PROCCNTR,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "procsurg=",QRYNAME
          IF        @EQUAL
            PACK      PROCSURG,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "procadat=",QRYNAME
          IF        @EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00            * Set CMON from MTHNAM3
            PACK      PROCADAT,CCENT,CYEAR,CMON,CDAY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "frstdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FRSTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "frstdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FRSTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "vyearmth=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VYEARMTH
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "receiptn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RECEIPTN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "returnfm=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RETURNFM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trandate=",QRYNAME
          IF        @EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00            * Set CMON from MTHNAM3
            PACK      TRANDATE,CCENT,CYEAR,CMON,CDAY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trantime=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRANTIME
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdward=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDWARD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdabed=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDABED
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "periodfr=",QRYNAME
          IF        @EQUAL
            PACK      PERIODFR,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "periodto=",QRYNAME
          IF        @EQUAL
            PACK      PERIODTO,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "invoicen=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,INVOICEN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "jouritem=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,JOURITEM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "jourpatt=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,JOURPATT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "usngicd9=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,USNGICD9
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "icd10dat=",QRYNAME
          IF        @EQUAL
            MATCH     SP70,QRYDATA
            GOTO      SETPAR99 IF EQUAL
            GOTO      SETPAR99 IF EOS
.
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00              * Set CMON from MTHNAM3
            PACK      ICD10DAT,CCENT,CYEAR,CMON,CDAY,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdbtch=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDBTCH
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdurno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDURNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdvisn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDVISN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdinvn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDINVN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdjtyp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDJTYP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdindc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDINDC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mediprac=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MEDIPRAC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "urnumber=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,URNUMBER
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "openonly=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPENONLY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdsite=",QRYNAME
          IF        @EQUAL
            PACK      VALDSITE,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdctyp=",QRYNAME
          IF        @EQUAL
            PACK      VALDCTYP,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "showiact=",QRYNAME
          IF        @EQUAL
            PACK      SHOWIACT,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "showldsc=",QRYNAME
          IF        @EQUAL
            PACK      SHOWLDSC,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
SETPAR99  RETURN
.
.------------------------------------------------------------
. Check Financial Period (PATDRGFD)
.------------------------------------------------------------
VALPRD00  CALL      XMLHED00
          BRANCH    EXIT,VALPRD99
.
          PACK      KEY6,VALDYEAR,VALDPERD,SP70
          CALL      RDDRGA3
          BRANCH    OVRCD,VALPRD90
.
VALPRD50  MOVE      SP70,PRDFRDTE
          MOVE      SP70,PRDTODTE
          UNPACK    DRGFDTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      PRDFRDTE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          UNPACK    DRGTDTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      PRDTODTE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
VALPRD60  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             DRGSDSC,"|",PRDFRDTE,"|",PRDTODTE:
                             "</RETURN_VALUE>"
          GOTO      VALPRD98
.
VALPRD90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid period - ",VALDPERD,"-",VALDYEAR:
                             "</RETURN_VALUE>"
          GOTO      VALPRD98
.
VALPRD98  CALL      XMLEND00
VALPRD99  RETURN
.
.-------------------------------------------------------------------------------
. Get URL for the PCEHR Flag Patient Header icon
.-------------------------------------------------------------------------------
GPCEHR00  CALL      XMLHED00
          BRANCH    EXIT,GPCEHR99
.
          READ      CONTROLF,HUND23;*147,PTCNPCEH            * PCEHR URL
          LJUSTIFY  PTCNPCEH
          STRIP     PTCNPCEH
.
          MOVE      URNUMBER,DIM9                            * 9 Digit UR Number
          RJUSTIFY  DIM9
          REP       " 0",DIM9
.
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            PACK      WBSEHOSP,SP70
          ENDIF
.
          COMPARE   ONE,IBCNMHOS                             * Multi Hospital
          IF        @EQUAL
            MATCH     SP70,ADMISSNO
            IF        @EQUAL
              PACK      KEY3,WBSEHOSP,SP70
            ELSE
              PACK      KEY8,ADMISSNO,SP70
              CALL      RDPMVX11
              BRANCH    OVRCD,GPCEHR90
              PACK      KEY3,PMVXMHOS,SP70
            ENDIF
            CALL      RDPTHSP1
            BRANCH    OVRCD,GPCEHR91
.
            LJUSTIFY  PTHSAPPR
            STRIP     PTHSAPPR
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                      *+,PTCNPCEH,"/":             * Output full URL
                      "EmbeddedPcehrView/Hospitals/":
                      *+,PTHSAPPR,"/Patients/",DIM9:
                      "/PatientSummary","</RETURN_VALUE>"
          ELSE
            READ      CONTROLF,TEN;*79,CAPPRVNO
            LJUSTIFY  CAPPRVNO
            STRIP     CAPPRVNO
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                      *+,PTCNPCEH,"/":             * Output full URL
                      "EmbeddedPcehrView/Hospitals/":
                      *+,CAPPRVNO,"/Patients/",DIM9:
                      "/PatientSummary","</RETURN_VALUE>"
          ENDIF
.
          GOTO      GPCEHR99
.
GPCEHR90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Admission Number not found":
                             "</RETURN_VALUE>"
.
GPCEHR91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Hospital Code not found":
                             "</RETURN_VALUE>"
.
GPCEHR99  CALL      XMLEND00
          RETURN
.------------------------------------------------------------
. Get default Length of Stay
.------------------------------------------------------------
GETLOS00  CALL      XMLHED00
          BRANCH    EXIT,GETLOS99
.
          MOVE      SP70,KEY6
          PACK      KEY3,VALDCODE,SP70
          MOVE      "P ",KEY2
          PACK      KEY5,KEY2,KEY3,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      PTCDASC1,KEY6
            SQUEEZE   KEY6
          ENDIF
.
GETLOS90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             *+,KEY6,"|":
                             "</RETURN_VALUE>"
          GOTO      GETLOS98
.
GETLOS98  CALL      XMLEND00
GETLOS99  RETURN
.
.-------------------------------------------------------------------------------
. Check Financial Period (PATDRGFD)
.-------------------------------------------------------------------------------
CHKPRD00  CALL      XMLHED00
.
          PACK      FNPERIOD,PRDCYEAR,PRDCNUMB,SP70
          PACK      KEY6,FNPERIOD,SP70
          CALL      RDDRGA3
          BRANCH    OVRCD,CHKPRD90
.
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          REP       " 0",DRGTDTE
          MATCH     CURRDATE,DRGTDTE        * Is period keyed in < current prd
          GOTO      CHKPRD50 IF LESS        * Yes, period is OK
.
          MATCH     DRGFDTE,CURRDATE        * Is period keyed in = current prd
          GOTO      CHKPRD91 IF LESS
          GOTO      CHKPRD92 IF EQUAL
.
CHKPRD50  UNPACK    DRGFDTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      PRDFRDTE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          UNPACK    DRGTDTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      PRDTODTE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          PACK      KEY16,FNPERIOD,SP70
          CALL      RSOPCSU1
          CALL      RKOPCSU1
          IF        OVRCD=1
            MOVE      ZERO,PRDSTAT          * First run for this period
            GOTO      CHKPRD60
          ENDIF
.
          MATCH     FNPERIOD,OPCSDATE
          IF        @EQUAL
            MOVE      ONE,PRDSTAT           * Not a First run for this period
          ELSE
            MOVE      ZERO,PRDSTAT          * First run for this period
          ENDIF
.
CHKPRD60  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PRDSTAT,"|",DRGSDSC,"|",PRDFRDTE,"|",PRDTODTE:
                             "</RETURN_VALUE>"
          GOTO      CHKPRD98
.
CHKPRD90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid period.":
                             "</RETURN_VALUE>"
          GOTO      CHKPRD98
.
CHKPRD91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Period entered is in the future.":
                             "</RETURN_VALUE>"
          GOTO      CHKPRD98
.
CHKPRD92  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Cannot do update for 1st day of period.":
                             "</RETURN_VALUE>"
          GOTO      CHKPRD98
.
CHKPRD98  CALL      XMLEND00
CHKPRD99  RETURN
.------------------------------------------------------------
. Output Select Options for Ward depending on Hospital ID
.------------------------------------------------------------
SELWRD00  CALL      XMLHED00
          BRANCH    EXIT,SELWRD99
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
.
          PACK      KEY3,VALDCODE,SP70          * get the hosp code 
          PACK      KEY29,SP3,KEY3,SP70         * pack start key (may contain hosp)
.
.         List Wards for only one Hospital ID
.
          CALL      RDSWARD7
SELWRD10  CALL      RDKWARD7
          BRANCH    OVRCD,SELWRD80

          MATCH     SP70,WBED                  * non-blank bed is end of wards  
          GOTO      SELWRD80 IF NOT EQUAL
          COMPARE   WACTIVE,ZERO                 * List only active wards
          GOTO      SELWRD10 IF NOT EQUAL
.
          MATCH     KEY3,SP3                   * if hospital specified 
          IF        !@EQUAL
            MATCH     KEY3,PTWDHOSN
            GOTO      SELWRD80 IF NOT EQUAL
          ENDIF
.  
SELWRD20  STRIP     WBDESC
          CLEAR     KEY35
          APPEND    WBDESC,KEY35
.         APPEND    " (",KEY35
.         APPEND    WWARD,KEY35
.         APPEND    ") ",KEY35
.
          IF        IBCNMHOS = 1
            MATCH     SP3,KEY3
            GOTO      SELWRD30 IF NOT EQUAL
          ELSE
            GOTO      SELWRD30
          ENDIF
.
          APPEND    " - ",KEY35
          APPEND    PTWDHOSN,KEY35
.
SELWRD30  APPEND    SP70,KEY35
          RESET     KEY35
          REP       ", ",KEY35                   * replace separator
          REP       "| ",KEY35                   * replace separator
          WRITE     HTMLFILE;WWARD,",",KEY35,"|";
.          
          GOTO      SELWRD10
.
SELWRD80  WRITE     HTMLFILE;"</RETURN_VALUE>"
          GOTO      SELWRD98
.
SELWRD98  CALL      XMLEND00
SELWRD99  RETURN
+
.------------------------------------------------------------
. Output Select Options for Ward depending on Hospital ID
.------------------------------------------------------------
SELWBD00  CALL      XMLHED00
          BRANCH    EXIT,SELWBD99
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
.
          MATCH     SP70,VALDCODE                * Ward is a mandatory field
          GOTO      SELWBD80 IF EQUAL
.
.         List Wards for only one Hospital ID
.
          PACK      KEY16,VALDCODE,SP70
          CALL      RDSWARD8
SELWBD10  CALL      RDKWARD8
          BRANCH    OVRCD,SELWBD80
.
          MATCH     VALDCODE,WWARD
          GOTO      SELWBD80 IF NOT EQUAL
.
          MATCH     SP70,WBED
          GOTO      SELWBD10 IF EQUAL
.
          MATCH     "1",OPENONLY
          IF        @EQUAL
            MATCH     "0",PTWDBDST
            GOTO      SELWBD10 IF NOT EQUAL
          ENDIF
.
          BRANCH    WACTIVE,SELWBD10             * Active beds only
. 
          MOVE      ZERO,F1
          MOVE      PTCNWBDS,F1
          IF        F1=2
            WRITE     HTMLFILE;WBED,",",PTWDSDES,"|";
          ELSE
            WRITE     HTMLFILE;WBED,",",WBED,"|";
          ENDIF
          GOTO      SELWBD10
.
SELWBD80  WRITE     HTMLFILE;"</RETURN_VALUE>"
          GOTO      SELWBD98
.
SELWBD98  CALL      XMLEND00
SELWBD99  RETURN
+
.------------------------------------------------------------
. Output Select Options for Ward depending on Hospital ID (empty only)
.------------------------------------------------------------
AVLWBD00  CALL      XMLHED00
          BRANCH    EXIT,AVLWBD99
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
.
          MATCH     SP70,VALDCODE                * Ward is a mandatory field
          GOTO      AVLWBD80 IF EQUAL
.
.         List Wards for only one Hospital ID
.
          PACK      KEY6,VALDCODE,SP70
          CALL      RDSWARD1
AVLWBD10  CALL      RDKWARD1
          BRANCH    OVRCD,AVLWBD80
.
          MATCH     VALDCODE,WWARD
          GOTO      AVLWBD80 IF NOT EQUAL
.
          BRANCH    WACTIVE,AVLWBD10             * Active beds only
.
          MATCH     ZEROVISN,WADMNO
          GOTO      AVLWBD10 IF NOT EQUAL    * Only add empty beds to selection
.
          WRITE     HTMLFILE;WBED,",",WBED,"|";
          GOTO      AVLWBD10
.
AVLWBD80  WRITE     HTMLFILE;"</RETURN_VALUE>"
          GOTO      AVLWBD98
.
AVLWBD98  CALL      XMLEND00
AVLWBD99  RETURN
+
.----------------------------------------------------------------------------
. Output Select Options for Action plan depending on a claim from an invoice
.----------------------------------------------------------------------------
SELPLN00  CALL      XMLHED00
          BRANCH    EXIT,SELPLN99
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
.
          OPEN      PATFAPA1,"patfapaf"
.
          MOVE      ZERO,FORM8
          SQUEEZE   VALDCODE
          MOVE      VALDCODE,FORM8
          MOVE      FORM8,KEY8
          CALL      RDINV1
          BRANCH    OVRCD,SELPLN19
          MATCH     SP70,PINVCLM
          GOTO      SELPLN19 IF EQUAL
.
          PACK      KEY6,PINVCLM,SP70
          CALL      RSPTFAP1
SELPLN10  CALL      RKPTFAP1
          BRANCH    OVRCD,SELPLN19

          MATCH     PINVCLM,PTFPCLAI
          GOTO      SELPLN19 IF NOT EQUAL
.
          MOVE      "AK",KEY2
          PACK      KEY5,KEY2,PTFPACPL,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,SELPLN19
.
          MATCH     "I",PTCOACTV
          GOTO      SELPLN10 IF EQUAL
.
          WRITE     HTMLFILE;PTFPACPL,",",TDESC,"|";
          GOTO      SELPLN10
.
SELPLN19  WRITE     HTMLFILE;"</RETURN_VALUE>"
          GOTO      SELPLN98
.
SELPLN98  CALL      XMLEND00
SELPLN99  RETURN
+
.------------------------------------------------------------
. Validate Item/Misc Charge
.------------------------------------------------------------
VALITM00  CALL      XMLHED00
          BRANCH    EXIT,VALITM99
.
          MOVE      VALDCODE,KEY9
          PACK      KEY17,VALDCODE,VALDDATE,SP70
          CALL      PATITMRD
          BRANCH    OVRCD,VALITM10    * check if it's a valid drg or misc.item
.
          MATCH     "I",PTITACTV
          GOTO      VALITM10 IF EQUAL        * item is inactive
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             IDESC:
                             "</RETURN_VALUE>"
          GOTO      VALITM98
.
VALITM10  PACK      MCHARGE,VALDCODE,SP70
.
.         Checking for miscellaneous item code
.
          CALL      GETMSC00                 * get misc.charge
          BRANCH    EXIT,VALITM92,VALITM93
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             MDESC:
                             "</RETURN_VALUE>"
          GOTO      VALITM98
.
VALITM90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid MBS Item Code - ":
                              KEY9,"</RETURN_VALUE>"
          GOTO      VALITM98
.
VALITM92  IF        IBCNMHOS=1
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                               "Misc.Item ",KEY9," Not Setup for Claim code ":
                                PTHSDCLM,"</RETURN_VALUE>"
          ELSE
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                               "Misc.Item ",KEY9," Not Setup for Claim code ":
                                PTCNDCLM,"</RETURN_VALUE>"
          ENDIF
          GOTO      VALITM98
.
VALITM93  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Cannot find Hospital Default Claim Code.  ":
                              "</RETURN_VALUE>"
          GOTO      VALITM98
.
VALITM98  CALL      XMLEND00
VALITM99  RETURN
+
.------------------------------------------------------------
. Validate Theatre fees
.------------------------------------------------------------
GETMSC00  MOVE      ZERO,EXIT
          MOVE      MCHARGE,KEY9            * (MCHARGE re-use in PATMCHRD)
.
          IF        IBCNMHOS=1
            MOVE      SP10,PTHSDCLM
            PACK      KEY3,SP10
            CALL      RDPTHSP1
            CALL      RKPTHSP1
            BRANCH    OVRCD,GETMSC91
            PACK      KEY29,PTHSDCLM,SP6,SP3,KEY9,CURRDATE,SP10
          ELSE
            PACK      KEY29,PTCNDCLM,SP6,SP3,KEY9,CURRDATE,SP10
          ENDIF
.
GETMSC10  CALL      PATMCHRD                * read Misc.Charges file
          COMPARE   ZERO,EXIT
          GOTO      GETMSC50 IF EQUAL
.
          IF        IBCNMHOS=1
            CALL      RKPTHSP1
            BRANCH    OVRCD,GETMSC90
            PACK      KEY29,PTHSDCLM,SP6,SP3,KEY9,CURRDATE,SP10
            GOTO      GETMSC10
          ENDIF
          GOTO      GETMSC90
.
GETMSC50  MOVE      ZERO,EXIT
          GOTO      GETMSC99
.
GETMSC90  MOVE      ONE,EXIT
          GOTO      GETMSC99
.
GETMSC91  MOVE      TWO,EXIT
          GOTO      GETMSC99
.
GETMSC99  RETURN
+
.------------------------------------------------------------
. Check for Duplicate Registration
.------------------------------------------------------------
VALDUP00  CALL      XMLHED00
          BRANCH    EXIT,VALDUP99
.
          PACK      KEY98,VALDSURN,VALDGIV1,VALDGIV2,VALDDOBE,SP70,SP70
          CALL      RDPTGSR2
          IF        OVRCD=1
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                               VALDSURN:
                               "</RETURN_VALUE>"
            GOTO      VALDUP98
          ENDIF
.
VALDUP90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=WARNING>":
                             "Duplicate Registration Found. ":
                             "Click OK to Generate New UR ":
                             "for this Patient or Cancel to ":
                             "Go Back":
                    "</RETURN_VALUE>"
          GOTO      VALDUP98
.
VALDUP98  CALL      XMLEND00
VALDUP99  RETURN
+
.------------------------------------------------------------
. Validate adjust theatre start times
.------------------------------------------------------------
VALTST00  CALL      XMLHED00
          BRANCH    EXIT,VALTST99
.
          PACK      CURSESS,VALDCODE,SP70
          PACK      KEY22,CURSESS,SP70
          CALL      RDOPSES1
          BRANCH    OVRCD,VALTST92
.
          COMPARE   DURATION,ZERO
          GOTO      VALTST90 IF EQUAL       * Zero entered or Enter hit
          GOTO      VALTST50 IF NOT LESS    * Negative adjustment entered
.
.         A Positive adjustment time has been entered
.
.         check that all adjustments wont go over end of session
.         by calculating the end time of the last booking, KEY5
.
          PACK      KEY26,CURSESS,Z70
          CALL      RSOPDEA5
VALTST05  CALL      RPOPDEA5                * get the last case
          BRANCH    OVRCD,VALTST10          * different session
.
          COMPARE   THREE,OPDASTAT
          GOTO      VALTST05 IF EQUAL
.
          PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN
          MATCH     KEY22,CURSESS
          GOTO      VALTST10 IF NOT EQUAL   * different session
.
          MOVE      ZERO,EXPDURA            * clear duration to add
          ADD       OPDAEXPD,EXPDURA        * add exp duration
          ADD       OPSEPREP,EXPDURA        * add pat prep time
          ADD       DURATION,EXPDURA        * add adjustment
          CALL      CLDUR000                * get KEY5, end time of last book.
.
          MATCH     KEY5,OPSEENDT
          GOTO      VALTST10 IF NOT LESS    * end time is >= calc time
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             ONE,"|This adjustment time will make the last ":
                             "booking end at ",KEY5:
                             "</RETURN_VALUE>"
          GOTO      VALTST98
.
VALTST10  MOVE      DURATION,EXPDURA         * time to add
          PACK      KEY26,CURSESS,CURRCASE,SP70
          CALL      RSOPDEA5                * get the valid patient details
VALTST15  CALL      RKOPDEA5                * get the valid patient details
          BRANCH    OVRCD,VALTST91          * invalid details
.
          COMPARE   THREE,OPDASTAT
          GOTO      VALTST15 IF EQUAL
.
          PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN
          MATCH     KEY22,CURSESS
          GOTO      VALTST91 IF NOT EQUAL   * invalid details
.
          CALL      CLDUR000                * get adjusted time, KEY5
.
          MATCH     KEY5,OPSEENDT
          GOTO      VALTST90 IF NOT LESS    * before end time so OK
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             ONE,"|This adjustment time will make this ":
                             "booking end at ",KEY5:
                             "</RETURN_VALUE>"
          GOTO      VALTST98
.
.         negative adjustment
.
VALTST50  MOVE      DURATION,EXPDURA         * the adjustment
          PACK      KEY26,CURSESS,CURRCASE,SP10
          CALL      RSOPDEA5                * get the valid patient details
VALTST55  CALL      RKOPDEA5                * get the valid patient details
          BRANCH    OVRCD,VALTST91          * invalid details
.
          COMPARE   THREE,OPDASTAT
          GOTO      VALTST55 IF EQUAL
.
          PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN
          MATCH     KEY22,CURSESS
          GOTO      VALTST91 IF NOT EQUAL   * invalid details
.
          CALL      CLDUR000                * get adjusted start time
          MOVE      KEY5,EXPSTART           * the work variable
.
          MATCH     "  1",OPDACASE
          GOTO      VALTST60 IF NOT EQUAL   * not the first case
.
          MATCH     OPSETIME,EXPSTART
          GOTO      VALTST90 IF NOT LESS    * not before start time
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             ONE,"|This adjustment time will make this ":
                             "booking start at ",EXPSTART:
                             "</RETURN_VALUE>"
          GOTO      VALTST98
.
.
.         in the middle check booking wont overlap with previous booking
.
VALTST60  CALL      RPOPDEA5
          BRANCH    OVRCD,VALTST90          * the only booking in the session
.
          COMPARE   THREE,OPDASTAT
          GOTO      VALTST60 IF EQUAL
.
          PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN
          MATCH     KEY22,CURSESS
          GOTO      VALTST90 IF NOT EQUAL   * different session
.
          MOVE      ZERO,EXPDURA
          ADD       OPDAEXPD,EXPDURA
          ADD       OPSEPREP,EXPDURA
          CALL      CLDUR000                * get KEY5, end time of prev book.
.
          MATCH     KEY5,EXPSTART
          GOTO      VALTST90 IF NOT LESS    * alterd time >= end time of prev
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             ONE,"|This will overlap the previous booking.":
                             "</RETURN_VALUE>"
          GOTO      VALTST98
.
.         OK. No warning message
.
VALTST90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             ZERO,"|",ZERO:
                             "</RETURN_VALUE>"
          GOTO      VALTST98
.
VALTST91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Cannot find theatre case. ":
                             "</RETURN_VALUE>"
          GOTO      VALTST98
.
VALTST92  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Cannot find theatre session. ":
                             "</RETURN_VALUE>"
          GOTO      VALTST98
.
VALTST98  CALL      XMLEND00
VALTST99  RETURN
+
.*********************************************************************
.*                  CLDUR000                                         *
.*        Get an end time, given start time and duration             *
.*        Para's  : EXPDURA       the total duration                 *
.*                  OPDAEXPS      the start time                     *
.*        Returns : KEY5          the end time                       *
.*********************************************************************
.
CLDUR000  UNPACK    OPDAEXPS,CHOUR,ANS,CMIN * unpack the start time
          MOVE      CMIN,FORM2              * minutes as a form2
          MOVE      FORM2,FORM4A            * set up work variable
          ADD       EXPDURA,FORM4A          * the total minutes to add
.
CLDUR200  COMPARE   ZERO,FORM4A
          GOTO      CLDUR300 IF NOT LESS    * positve amount
.
          ADD       "60",FORM4A             * make it positive
          MOVE      CHOUR,OPTION
          SUB       ONE,OPTION
          MOVE      OPTION,CHOUR            * sub 1 hour off time
          GOTO      CLDUR200
.
CLDUR300  MOVE      FORM4A,FORM4B           * save the minutes
.
          DIV       "60",FORM4A             * the total hours to add
          MOVE      CHOUR,FORM2             * hours as a form
          ADD       FORM4A,FORM2            * add the hours
.
CLDUR400  COMPARE   "24",FORM2
          GOTO      CLDUR500 IF LESS        * below 24 hours
.
          SUB       "24",FORM2              * get back to 24 hour time
          GOTO      CLDUR400
.
CLDUR500  MOVE      FORM2,CHOUR             * set up the hours
.
          MULT      "60",FORM4A             * the total minutes added
          SUB       FORM4A,FORM4B           * the minutes to add
          MOVE      FORM4B,FORM2            * get minutes as form2
.
          COMPARE   ZERO,FORM2
          GOTO      CLDUR800 IF NOT LESS    * not negative
.
          ADD       "60",FORM2              * make it positive
          MOVE      CHOUR,OPTION
          SUB       ONE,OPTION
          MOVE      OPTION,CHOUR            * sub 1 hour off time
.
CLDUR800  MOVE      FORM2,CMIN              * the minutes
.
          PACK      KEY5,CHOUR,COLON,CMIN * the end time
          REP       " 0",KEY5
.
CLDUR999  RETURN
+
.------------------------------------------------------------
. Validate Case Teram Code
.------------------------------------------------------------
VALTEA00  CALL      XMLHED00
          BRANCH    EXIT,VALTEA99
.
VALTEA10  PACK      KEY10,VALDCODE,SP70
          CALL      RDALCAS1
          BRANCH    OVRCD,VALTEA90    * check if it's a valid drg or misc.item
.
          MATCH     "2",ALCAACTV            * Check for active - exclude from
          GOTO      VALTEA20 IF EQUAL       * PRIMHD (NZ only)
.
          MATCH     "1",ALCAACTV            * Check for active/inactive
          GOTO      VALTEA92 IF NOT EQUAL
.
VALTEA20  IF        IBCNMHOS=1
            PACK      KEY10,USERID,SP70
            CALL      RDWBSE1
            IF        OVRCD=1 
              MOVE      SP70,WBSEHOSP
            ENDIF
.
            MATCH     WBSEHOSP,ALCAHOSP     * Hosp id must equal user id hosp
            GOTO      VALTEA91 IF NOT EQUAL
          ENDIF
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             ALCADESC:
                             "</RETURN_VALUE>"
          GOTO      VALTEA98
.
VALTEA90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Case Team Code - ":
                              KEY10,"</RETURN_VALUE>"
          GOTO      VALTEA98
.
VALTEA91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Case Team Code For Hospital ID - ":
                              WBSEHOSP,"</RETURN_VALUE>"
          GOTO      VALTEA98
.
VALTEA92  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Case Team Code is Inactive - ":
                              KEY10,"</RETURN_VALUE>"
          GOTO      VALTEA98
.
VALTEA98  CALL      XMLEND00
VALTEA99  RETURN
+
.------------------------------------------------------------
. Validate Receipt No. remote script
.------------------------------------------------------------
RCPNO000  CALL      XMLHED00
          BRANCH    EXIT,RCPNO999
.
RCPNO100  MOVE      ZERO,FORM12
          MOVE      RECEIPTN,FORM12
          MOVE      FORM12,RECEIPTN
          PACK      KEY12,RECEIPTN,SP70
          CALL      RDRCBNK1
          BRANCH    OVRCD,RCPNO900
.
          MATCH     SP70,RCBNRDAT           * check reconciliation date
....      GOTO      RCPNO920 IF NOT EQUAL
....      MATCH     SP70,RCBNRTIM           * check reconciliation time
....      GOTO      RCPNO920 IF NOT EQUAL
          MATCH     "1",RCBNSTAT
          GOTO      RCPNO940 IF EQUAL       * Already cancelled
.
.                                           * found a valid Receipt No.
RCPNO500  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             RCBNTDAT,"|":
                             "</RETURN_VALUE>"
          GOTO      RCPNO980
.
.         ************ DISPLAY ERROR MESSAGE **********
.
RCPNO900  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Receipt Number is invalid.":
                             "</RETURN_VALUE>"
          GOTO      RCPNO980
.
RCPNO920  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Receipt has been Reconciled.":
                             "</RETURN_VALUE>"
          GOTO      RCPNO980
.
RCPNO940  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Receipt has been Cancelled.":
                             "</RETURN_VALUE>"
          GOTO      RCPNO980
.
.
RCPNO980  CALL      XMLEND00
.
RCPNO999  RETURN
+
.----------------------------------------------------------------------
.         Get the ward/bed details
.----------------------------------------------------------------------
GETWR000  CALL      XMLHED00
          BRANCH    EXIT,GETWR999
.
          PACK      KEY6,VALDWARD,VALDABED,SP70
          MATCH     SP70,KEY6
          GOTO      GETWR800 IF EQUAL
.
          CALL      RDWARD1             * Read ward/bed file
          BRANCH    OVRCD,GETWR600      * No record found in file
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             WEFRBT,"|":
                             WACTIVE,"|":
                             WBDESC,"|":
                             WRTYPE,"|":
                             WCLASS,"|":
                             "</RETURN_VALUE>"
          GOTO      GETWR800
.
.         The requested date wasn't in the file
.
GETWR600  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Ward/Bed":
                             "</RETURN_VALUE>"
          GOTO      GETWR800
.
GETWR800  CALL      XMLEND00
GETWR999  RETURN
+
.
.------------------------------------------------------------
. Get patient's DRG WIES
.------------------------------------------------------------
GETWIE00  CALL      XMLHED00
          BRANCH    EXIT,GETWIE99
.
          PACK      KEY8,ADMISSNO,SP70  * Read Admission File
          CALL      RDMISS1
          BRANCH    OVRCD,GETWIE91
.
          PACK      KEY8,ADMISSNO,SP70  * Read for Discharge Date
          CALL      RDDSCH1
          BRANCH    OVRCD,GETWIE92
.
          MOVE      SP10,KEY3
          CALL      GTDRG000       * Get Grouper Version - returns it in KEY3
.
          MOVE      VALDCODE,KEY4           * (moved from above)      *I-137125
          PACK      KEY7,KEY4,KEY3,SP10
          CALL      RDPTDGW1
          BRANCH    OVRCD,GETWIE90
.
          CALL      CLR41000
          MOVE      ZERO,PTPGWTOL
          MOVE      KEY3,XDRGGRP
          MOVE      VALDCODE,XDRGDRG
          MOVE      ZERO,MRCNGRUP           * set MRCNGRUP for Unix Grouper
          CALL      STDRG000                * setup Unix Grouper variables
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PTDWDESC,"|",PTPGWTOL:
                             "</RETURN_VALUE>"
          GOTO      GETWIE98
.
GETWIE90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid DRG - ":
                              KEY4,"</RETURN_VALUE>"
          GOTO      GETWIE98
.
GETWIE91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Cannot find patient Admission record. ":
                             "</RETURN_VALUE>"
          GOTO      GETWIE98
.
GETWIE92  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Patient has not been discharged. ":
                             "</RETURN_VALUE>"
          GOTO      GETWIE98
.
GETWIE98  CALL      XMLEND00
GETWIE99  RETURN
+
.------------------------------------------------------------
. Get Originator Defaults    
.------------------------------------------------------------
GETORI00  CALL      XMLHED00
          BRANCH    EXIT,GETORI99
.
          PACK      KEY3,VALDCODE,SP70
          CALL      RDSIOR1
          BRANCH    OVRCD,GETORI90   
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             SIORNAME,"|",SIORMESS,"|",SIORCON,"|",SIORHOSP:
                             "</RETURN_VALUE>"
          GOTO      GETORI98
.
GETORI90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Origintor Code - ":
                              KEY3,"</RETURN_VALUE>"
          GOTO      GETORI98
.
GETORI98  CALL      XMLEND00
GETORI99  RETURN
+
.------------------------------------------------------------
. Get Catalog Defaults
.------------------------------------------------------------
GETCIA00  CALL      XMLHED00
          BRANCH    EXIT,GETCIA99
.
          MOVE      SP70,WARNMESG
          MOVE      SP70,WARNMES2
          MOVE      SP70,WARNMES3
          MOVE      SP70,WARNMES4
.
.         Validate Catalog Master
.
          PACK      KEY7,VALDCODE,SP70
          CALL      RDSIIA1
          BRANCH    OVRCD,GETCIA90
.
          MATCH     SUPPLIER,SIIAPSC
          IF        !@EQUAL
            CLEAR     WARNMESG
            APPEND    "WARNING: Preferred Supplier Code : ",WARNMESG
            APPEND    SIIAPSC,WARNMESG
            RESET     WARNMESG
          ENDIF
.
          BRANCH    SIIANON,GETCIA20   * Non Stock
.
.         Validate Catalog exist for default Warehouse
.
          PACK      KEY12,KEY7,OPCNWHCD
          CALL      RDSIIE1
          BRANCH    OVRCD,GETCIA91
.
          COMPARE   TWO,SIIESUS             * Catalog Warehouse suspended
          GOTO      GETCIA92 IF EQUAL
          COMPARE   THREE,SIIESUS
          GOTO      GETCIA92 IF EQUAL
.
          IF        SIIESOO>0
            MOVE      SIIESOO,KEY15
            SQUEEZE   KEY15
            CLEAR     WARNMES2
            APPEND    "WARNING: ",WARNMES2
            APPEND    KEY15,WARNMES2
            APPEND    " Already on Order for this W/h. ",WARNMES2
            RESET     WARNMES2
          ENDIF
.
.         Validate Supplier Contract
.
GETCIA20  COMPARE   TWO,SIIASUS             * Catalog suspended
          GOTO      GETCIA93 IF EQUAL
          COMPARE   THREE,SIIASUS
          GOTO      GETCIA93 IF EQUAL
.
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          PACK      KEY45,SIIACAT,CURRDATE,Z70
          CALL      RSSISD2                 * Check for Contract Price
          CALL      RPSISD2                 * Lastest Price
          BRANCH    OVRCD,GETCIA30          * No Contract
.
          MATCH     SISDCAT,SIIACAT         * Correct Catalog
          GOTO      GETCIA30 IF NOT EQUAL   * No Contract
.
          MOVE      SISDCON,KEY10
          CALL      RDSISC1
          BRANCH    OVRCD,GETCIA30          * No Contract
.
          MATCH     CURRDATE,SISCEDT        * Check for Completed Contract
          GOTO      GETCIA30 IF LESS        * Contract Out of Date
.
          UNPACK    SISCSDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MATCH     SUPPLIER,SISDCON
          IF        !@EQUAL
            CLEAR     WARNMES3
            APPEND    "WARNING: Contracted on Supplier/Contract : ",WARNMES3
            APPEND    SISDSUP,WARNMES3
            APPEND    "/",WARNMES3
            APPEND    SISDCON,WARNMES3
            RESET     WARNMES3
          ENDIF
          GOTO      GETCIA40
.
GETCIA30  UNPACK    SP70,SISCCON,SISCSDT,SISDSUT,SISDSUP,DISPDATE
.
.         Check Catalog exists for this Supplier
.
GETCIA40  PACK      KEY27,KEY7,SUPPLIER,SP70
          CALL      RSSIIC1
GETCIA45  CALL      RKSIIC1
          BRANCH    OVRCD,GETCIA55
          MATCH     KEY7,SIICCAT
          GOTO      GETCIA55 IF NOT EQUAL
          MATCH     SUPPLIER,SIICSUP
          GOTO      GETCIA55 IF NOT EQUAL
          COMPARE   ZERO,SIICAPO
          GOTO      GETCIA45 IF EQUAL
.
.         Default Supply unit from Catalog Supplier if only one exists
.
          MOVE      SIICSUT,KEY15
.
          CALL      RKSIIC1
          BRANCH    OVRCD,GETCIA50
          MATCH     KEY7,SIICCAT
          GOTO      GETCIA50 IF NOT EQUAL
          MATCH     SUPPLIER,SIICSUP
          GOTO      GETCIA50 IF NOT EQUAL  * more than one supply unit
          GOTO      GETCIA80
.
GETCIA50  MOVE      KEY15,SISDSUT
          GOTO      GETCIA80
.
GETCIA55  CLEAR     WARNMES4
          APPEND    "WARNING: Supplier Not Available for this ",WARNMES4
          APPEND    "Catalog. Add New?",WARNMES4
          RESET     WARNMES4
.
GETCIA80  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             SIIADES,"|",SIIASUB,"|",SIIAGST:
                             "|",SIIANON,"|",SISCCON,"|",DISPDATE:
                             "|",SISDSUT,"|",WARNMESG,"|",WARNMES2:
                             "|",WARNMES3,"|",WARNMES4:
                             "</RETURN_VALUE>"
          GOTO      GETCIA98
.
GETCIA90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Catalog Code - ":
                              KEY7,"</RETURN_VALUE>"
          GOTO      GETCIA98
.
GETCIA91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Catalog Not Available in Warehouse - ":
                              KEY7,"</RETURN_VALUE>"
          GOTO      GETCIA98
.
GETCIA92  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Warehouse/Catalog has been Suspended - ":
                              KEY7,"</RETURN_VALUE>"
          GOTO      GETCIA98
.
GETCIA93  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Catalog has been Suspended - ":
                              KEY7,"</RETURN_VALUE>"
          GOTO      GETCIA98
.
GETCIA98  CALL      XMLEND00
GETCIA99  RETURN
+
.------------------------------------------------------------
. Get Expected delivery date
.------------------------------------------------------------
CALEDD00  MOVE      CCC,CC
          MOVE      CYY,YY
          MOVE      CMM,MM
          MOVE      CDD,DD              * Todays Date
          CALL      DMYCON              * Convert to Jul Date
          ADD       SIICLTM,JULDAY      * Add Lead Time
          MOVE      JULDAY,JWKDAY
          MOVE      JULYR,JWKYER
          MOVE      JULCC,JWKCC
          CALL      JULCON              * Convert Date Back
          PACK      WDATE1,CC,YY,MM,DD
          REP       " 0",WDATE1
.
          UNPACK    WDATE1,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
CALEDD99  RETURN
+
.------------------------------------------------------------
. Get GST
.------------------------------------------------------------
GETGST00  CALL      XMLHED00
          BRANCH    EXIT,GETGST99
.
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          PACK      KEY6,VALDCODE,SP10
.
          PACK      KEY14,KEY6,CURRDATE,SP70
          CALL      RDIBGE1
          COMPARE   ZERO,OVRCD
          GOTO      GETGST80 IF EQUAL
. 
          CALL      RPIBGE1
          BRANCH    OVRCD,GETGST90
.
          MATCH     KEY6,IBGECODE
          GOTO      GETGST90 IF NOT EQUAL
.
GETGST80  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             IBGEAMNT:
                             "</RETURN_VALUE>"
          GOTO      GETGST98
.
GETGST90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Cannot find GST Rate - ":
                              KEY6,"</RETURN_VALUE>"
          GOTO      GETGST98
.
GETGST98  CALL      XMLEND00
GETGST99  RETURN
+
.------------------------------------------------------------
. Get Cost Centre
.------------------------------------------------------------
GETCCA00  CALL      XMLHED00
          BRANCH    EXIT,GETCCA99
.
          PACK      KEY5,VALDCODE,SP70
          CALL      RDSICA1
          BRANCH    OVRCD,GETCCA90
.
          BRANCH    SICALOC,GETCCA91
.
          PACK      KEY10,USERID,SP10
          CALL      RDWBSE1
          BRANCH    OVRCD,GETCCA92
.
          PACK      KEY9,WBSEPCD,SP70      * check if All Warehouse
          CALL      RDSICS1
          IF        OVRCD=1
            PACK      KEY9,WBSEPCD,SICACODE,SP70 * check specific WH security
            CALL      RDSICS1
            BRANCH    OVRCD,GETCCA92
          ENDIF
.
          MOVE      SP70,WARNMESG
          PACK      KEY7,VALDCOD2,SP70
          CALL      RDSIIA1
          IF        OVRCD=0
            CALL      CHKNCT00
          ENDIF
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             SICADESC,"|",WARNMESG:
                             "</RETURN_VALUE>"
          GOTO      GETCCA98
.
GETCCA90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Cost Centre Code - ":
                              KEY5,"</RETURN_VALUE>"
          GOTO      GETCCA98
.
GETCCA91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Cost Centre Not Available for Purchases - ":
                              KEY5,"</RETURN_VALUE>"
          GOTO      GETCCA98
.
GETCCA92  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid User Security for Cost Centre Code - ":
                              KEY5,"</RETURN_VALUE>"
          GOTO      GETCCA98
.
GETCCA98  CALL      XMLEND00
GETCCA99  RETURN
+
.----------------------------------------------------------------------
. Check if catalog already on an order for this cost centre
.----------------------------------------------------------------------
CHKNCT00  MOVE      ZERO,EXIT
          MOVE      ZERO,ORDQTY
          MOVE      SP70,WARNMESG
          PACK      KEY25,SIIACAT,Z70
          CALL      RSSIPC6
.
CHKNCT10  CALL      RPSIPC6
          BRANCH    OVRCD,CHKNCT80
          MATCH     SIIACAT,SIPCCAT
          GOTO      CHKNCT80 IF NOT EQUAL
          MATCH     SP8,SIPCEDD
          GOTO      CHKNCT80 IF EQUAL
          MATCH     SIPCCST,SICACODE
          GOTO      CHKNCT10 IF NOT EQUAL
.
          PACK      KEY7,SIPCPON
          CALL      RDSIPA1
          BRANCH    OVRCD,CHKNCT10
          MATCH     SP70,SIPADCN
          GOTO      CHKNCT10 IF NOT EQUAL
          MATCH     SP70,SIPADCM
          GOTO      CHKNCT10 IF NOT EQUAL
.
          MOVE      ONE,SIFACTOR
          PACK      KEY30,SIIAISS,SIPCSUT,SP70
          CALL      RDSIFA1
.
          ASSIGN    ORDQTY+((SIPCOQT*SIFACTOR)-SIPCRQT),ORDQTY
          GOTO      CHKNCT10
.
CHKNCT80  IF        ORDQTY > 0
            CLEAR     WARNMESG
            APPEND    "WARNING:",WARNMESG
            APPEND    ORDQTY,WARNMESG
            APPEND    " on Order for Cost Centre ",WARNMESG
            APPEND    SICACODE,WARNMESG
            RESET     WARNMESG
          ENDIF
.
CHKNCT99  RETURN
.------------------------------------------------------------
. Get Supplier Supply Unit
.------------------------------------------------------------
GETCIC00  CALL      XMLHED00
          BRANCH    EXIT,GETCIC99
.
          PACK      KEY7,VALDCODE,SP70
          PACK      KEY27,KEY7,SUPPLIER,SUPPUNIT
          CALL      RDSIIC1
          BRANCH    OVRCD,GETCIC90
.
          COMPARE   ZERO,SIICAPO
          GOTO      GETCIC91 IF EQUAL
.
          CALL      CALEDD00  * Calculate Expected Delivery date
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             SIICPNO,"|",SIICPD1,"|":
                             DISPDATE,"|",SIICLCT:
                             "</RETURN_VALUE>"
          GOTO      GETCIC98
.
GETCIC90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Supply Unit - ":
                              SUPPUNIT,"</RETURN_VALUE>"
          GOTO      GETCIC98
.
GETCIC91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Purchase Orders Not Allowed for Supply Unit - ":
                              SUPPUNIT,"</RETURN_VALUE>"
          GOTO      GETCIC98
.
GETCIC98  CALL      XMLEND00
GETCIC99  RETURN
+
.------------------------------------------------------------
. Get Date - Add NUMBDAYS to VALDDATE
.------------------------------------------------------------
GETDAT00  CALL      XMLHED00
          BRANCH    EXIT,GETDAT99
.
          UNPACK    SP70,WDATE1,DISPDATE
.
          UNPACK    VALDDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CCENT,CC
          MOVE      CYEAR,YY
          MOVE      CMON,MM
          MOVE      CDAY,DD
          CALL      DMYCON              * Convert to Jul Date
          ADD       NUMBDAYS,JULDAY     * Add Number of Days
          MOVE      JULDAY,JWKDAY
          MOVE      JULYR,JWKYER
          MOVE      JULCC,JWKCC
          CALL      JULCON              * Convert Date Back
          PACK      WDATE1,CC,YY,MM,DD
          REP       " 0",WDATE1
.
          UNPACK    WDATE1,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             DISPDATE:
                             "</RETURN_VALUE>"
          GOTO      GETDAT98
.
GETDAT90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Error ":
                              SUPPUNIT,"</RETURN_VALUE>"
          GOTO      GETDAT98
.
GETDAT98  CALL      XMLEND00
GETDAT99  RETURN
+
.------------------------------------------------------------
. Validate Operating Room Tray
.------------------------------------------------------------
VALTRA00  CALL      XMLHED00
          BRANCH    EXIT,VALTRA99
.
          PACK      KEY18,VALDCODE,SP70
          CALL      RDOPTRA1
          BRANCH    OVRCD,VALTRA90
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             OPTHDESC:
                             "</RETURN_VALUE>"
          GOTO      VALTRA98
.
VALTRA90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Tray Code - ":
                              KEY15,"</RETURN_VALUE>"
          GOTO      VALTRA98
.
VALTRA98  CALL      XMLEND00
VALTRA99  RETURN
+
.------------------------------------------------------------
. Validate Operating Room Tray
.------------------------------------------------------------
VALEQP00  CALL      XMLHED00
          BRANCH    EXIT,VALEQP99
.
          PACK      KEY18,VALDCODE,SP70
          CALL      RDOPEQP1
          BRANCH    OVRCD,VALEQP90
.
          MATCH     "1",OPEQACTV
          GOTO      VALEQP90 IF EQUAL
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             OPEQDESC:
                             "</RETURN_VALUE>"
          GOTO      VALEQP98
.
VALEQP90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Equipment Code - ":
                              KEY15,"</RETURN_VALUE>"
          GOTO      VALEQP98
.
VALEQP98  CALL      XMLEND00
VALEQP99  RETURN
+
.------------------------------------------------------------
. Validate Suspension dates   
.------------------------------------------------------------
VALSUS00  MOVE      SP70,DATEFROM
          MOVE      SP70,DATETO
          CALL      XMLHED00
          BRANCH    EXIT,VALSUS99
.
          PACK      KEY16,VALDCODE,VALDDATE,Z70
          CALL      RDPTSUS1           * Read suspension table
          BRANCH    OVRCD,VALSUS10
          GOTO      VALSUS95
.
VALSUS10  PACK      KEY16,VALDCODE,VALDDATE,Z70
          CALL      RSPTSUS1           * Read suspension table
          CALL      RPPTSUS1
          BRANCH    OVRCD,VALSUS90
.
          MATCH     VALDCODE,PTSSURNO
          GOTO      VALSUS90 IF NOT EQUAL
.
          MATCH     PTSSFDAT,VALDDATE
          GOTO      VALSUS90 IF LESS
.
          MATCH     SP70,PTSSTDAT
          GOTO      VALSUS95 IF EQUAL
.
          MATCH     PTSSTDAT,VALDDATE
          GOTO      VALSUS95 IF LESS
          GOTO      VALSUS95 IF EQUAL
.
VALSUS90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             ZERO,SP70:
                             "</RETURN_VALUE>"
          GOTO      VALSUS98
.
VALSUS95  UNPACK    PTSSFDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DATEFROM,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          MATCH     SP70,PTSSTDAT
          IF        !@EQUAL
            UNPACK    PTSSTDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DATETO,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ELSE
            MOVE      SP70,DATETO
          ENDIF
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                              DATEFROM,"|",DATETO,"</RETURN_VALUE>"
          GOTO      VALSUS98
.
VALSUS98  CALL      XMLEND00
VALSUS99  RETURN
+
.------------------------------------------------------------
. Get PRS2 details for a hospital code
.------------------------------------------------------------
GETPRS00  CALL      XMLHED00
          BRANCH    EXIT,GETPRS99
.
          PACK      KEY3,VALDHOSP,SP70
          CALL      RDPMPRD1
          BRANCH    OVRCD,GETPRS90
.
          UNPACK    PMPRSDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DATEFROM,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          MATCH     SP70,PMPREDAT
          IF        !@EQUAL
            UNPACK    PMPREDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DATETO,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ELSE
            MOVE      SP70,DATETO
          ENDIF
          PACK      ENDDATE1,PMPREDAT
          ADD       ONE,ENDDATE1
          UNPACK    ENDDATE1,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DATESTR,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             DATEFROM,"|":
                             DATETO,"|":
                             PMPRERRF,"|":
                             DATESTR,"|":
                             "</RETURN_VALUE>"
          GOTO      GETPRS98
.
GETPRS90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Hospital Code - ":
                              VALDHOSP,"</RETURN_VALUE>"
          GOTO      GETPRS98
.
GETPRS98  CALL      XMLEND00
GETPRS99  RETURN
.------------------------------------------------------------
. Validate Fee Estimate Regime Code
.------------------------------------------------------------
VALREG00  CALL      XMLHED00
          BRANCH    EXIT,VALREG99
.
VALREG10  PACK      KEY10,VALDCODE,SP70
.
          PACK      KEY13,KEY10,SP1,SP1,ZERO,SP70
          CALL      RDPMREG1
          BRANCH    OVRCD,VALREG90
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PMREDESC:
                             "</RETURN_VALUE>"
          GOTO      VALREG98
.
VALREG90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Regime Code - ":
                              KEY13,"</RETURN_VALUE>"
          GOTO      VALREG98
.
VALREG98  CALL      XMLEND00
VALREG99  RETURN
+
.------------------------------------------------------------
. Validate if Extraction File Exists
.------------------------------------------------------------
VALEXT00  CALL      XMLHED00
          BRANCH    EXIT,VALEXT99
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      TEMP1,VALDCODE
          TRAPCLR   IO
          BRANCH    OVRCD,VALEXT90
          CLOSE     TEMP1
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             "File Exists - ":
                             VALDCODE,"</RETURN_VALUE>"
          GOTO      VALEXT98
.
VALEXT90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             "File Does Not Exist":
                             "</RETURN_VALUE>"
          GOTO      VALEXT98
.
VALEXT98  CALL      XMLEND00
VALEXT99  RETURN
.------------------------------------------------------------
. Validate if Item Number Exists
.------------------------------------------------------------
VALITN00  CALL      XMLHED00
          BRANCH    EXIT,VALITN99
.
          MOVE      VALDCODE,KEY3
          RJUSTIFY  KEY3
          CALL      RDPASAI1
          BRANCH    OVRCD,VALITN90
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PTSADESC:
                             "</RETURN_VALUE>"
          GOTO      VALITN98
.
VALITN90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Item Number":
                             "</RETURN_VALUE>"
          GOTO      VALITN98
.
VALITN98  CALL      XMLEND00
VALITN99  RETURN
.------------------------------------------------------------
. Validate if Admission Number Exists
.------------------------------------------------------------
VALADM00  CALL      XMLHED00
          BRANCH    EXIT,VALADM99
.
          MOVE      VALDCODE,KEY8
          RJUSTIFY  KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,VALADM90
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             "Admission No":
                             "</RETURN_VALUE>"
          GOTO      VALADM98
.
VALADM90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Missing Admission Record":
                             "</RETURN_VALUE>"
          GOTO      VALADM98
.         
VALADM98  CALL      XMLEND00
VALADM99  RETURN
+
.----------------------------------------------------------------------------
. VALINC00 -              Increment ACC Number
.                        Get Next ACC Parameter
.----------------------------------------------------------------------------
VALINC00  CALL      XMLHED00
          BRANCH    EXIT,VALINC99
.
.         Increment ACC Number
.
          READ      CONTROLF,HUND12;*20,PTCNACCL,*27,PTCNACCN     
.
          UNPACK    PTCNACCN,DIM1,DIM1A,DIM5
          TYPE      DIM1A
          GOTO      VALINC20 IF NOT EQUAL
.
.  **** format is A999999 *****
.
          UNPACK    PTCNACCN,DIM1,DIM6
.
          MOVE      DIM6,FORM6
          ADD       ONE,FORM6
          COMPARE   ZERO,FORM6
          GOTO      VALINC10 IF EQUAL
.
          PACK      PTCNACCN,DIM1,FORM6
          REP       " 0",PTCNACCN
          GOTO      VALINC50
.
. **** increment first letter ****
VALINC10  REP       CPNZNXTC,DIM1     * Go to the next letter
          CMATCH    DIM1,ANSA         * Have we gone past all the letters ?
          GOTO      VALINC60 IF EQUAL
.
          PACK      PTCNACCN,DIM1,FORM6
          REP       " 0",PTCNACCN
          GOTO      VALINC50
.
.
.  **** format is AA99999 *****
VALINC20  UNPACK    PTCNACCN,DIM1,DIM1A,DIM5
.
          MOVE      DIM5,FORM5
          ADD       ONE,FORM5
          COMPARE   ZERO,FORM5
          GOTO      VALINC30 IF EQUAL
.
          PACK      PTCNACCN,DIM1,DIM1A,FORM5
          REP       " 0",PTCNACCN
          GOTO      VALINC50
.
. **** increment the second letter ****
VALINC30  REP       CPNZNXTC,DIM1A    * Go to the next letter
          CMATCH    DIM1A,ANSA        * Have we gone past all the letters ?
          GOTO      VALINC40 IF EQUAL
.
          PACK      PTCNACCN,DIM1,DIM1A,FORM5
          REP       " 0",PTCNACCN
          GOTO      VALINC50
.         
VALINC40  REP       CPNZNXTC,DIM1     * Go to the next letter
          CMATCH    DIM1,ANSA         * Have we gone past all the letters ?
          GOTO      VALINC60 IF EQUAL
.
          PACK      PTCNACCN,DIM1,DIM1,FORM5
          REP       " 0",PTCNACCN
          GOTO      VALINC50
.
VALINC50  MATCH     PTCNACCN,PTCNACCL
          GOTO      VALINC60 IF LESS
.
          WRITAB    CONTROLF,HUND12;*27,PTCNACCN     
          PACK      KEY44,PTCNACCN,SP70
          CALL      RDSWCOM1
          CALL      RDKWCOM1
          BRANCH    OVRCD,VALINC55
.
          MATCH     PTCNACCN,WCCLMNO
          GOTO      VALINC99 IF EQUAL       * already used
.
VALINC55  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                              PTCNACCN:
                             "</RETURN_VALUE>"
          GOTO      VALINC98
.         
VALINC60  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "No more valid ACC numbers can be generated":
                             "</RETURN_VALUE>"
          GOTO      VALACK98
.         
VALINC98  CALL      XMLEND00
.
VALINC99  RETURN
.----------------------------------------------------------------------------
. VALACK00 -     Validate if ACC Number Exists
.                 Ok if ACC No does not exist
.                  Error if ACC No exists                                     
.----------------------------------------------------------------------------
VALACK00  CALL      XMLHED00
          BRANCH    EXIT,VALACK99
.
          PACK      KEY44,VALDCODE,SP70
          CALL      RDSWCOM3
VALACK10  CALL      RDKWCOM3
          BRANCH    OVRCD,VALACK20
.
          PACK      KEY20,VALDCODE,SP20
.
          MATCH     KEY20,WCCLMNO                * Same ACC Claim No? 
          IF        @EQUAL
            GOTO      VALACK15                      * Use ACC No
          ELSE
            GOTO      VALACK20                      * ACC No does not exist
          ENDIF
. 
VALACK15  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             "ACC No":
                             "</RETURN_VALUE>"
          GOTO      VALACK98
.
VALACK20  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "ACC Claim Number does not exist":
                             "</RETURN_VALUE>"
          GOTO      VALACK98
.
VALACK98  CALL      XMLEND00
.
VALACK99  RETURN
.----------------------------------------------------------------------------
.                Validate if ACC Number Exists
. Ok if ACC Number does not exist
. Error if ACC is already entered for some other patient
. Ok and display corresponding ACC details if ACC No belongs to that patient
.----------------------------------------------------------------------------
VALACC00  CALL      XMLHED00
          BRANCH    EXIT,VALACC99
.
          MOVE      VALDCODE,DIM20
          PACK      DIM20,DIM20,SP70
.
          PACK      KEY44,DIM20,SP70
          CALL      RDSWCOM3
VALACC10  CALL      RDKWCOM3
          BRANCH    OVRCD,VALACC20
.
          MATCH     DIM20,WCCLMNO
          IF        @EQUAL
            GOTO      VALACC15
          ELSE
            GOTO      VALACC20               * Acc No can be used
          ENDIF
.
VALACC15  MATCH     VALDCOD2,PTWCURNO
          IF        @EQUAL
            GOTO      VALACC40               * Acc No used by that patient
          ELSE
            GOTO      VALACC30               * Acc No used by another patient
          ENDIF
.
VALACC20  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             "ACC No":
                             "</RETURN_VALUE>"
          GOTO      VALACC98
.
VALACC30  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "ACC Claim Number already in use":
                             "</RETURN_VALUE>"
          GOTO      VALACC98
.
VALACC40  PACK      KEY8,DWCADMNO,SP70
          CALL      RDPMWX11
          BRANCH    OVRCD,VALACC98
. 
          PACK      KEY8,PMWXVISN,SP70
          CALL      RDWCOM1
          BRANCH    OVRCD,VALACC98
.
.         Format Patient Declaration Date 
.
VALACC44  PACK      ACCDCDTE,SP70
          UNPACK    PMWXPDDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      ACCDCDTE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
.         Format Accident Date
.
          MOVE      SP70,ACCIDATE
          UNPACK    WCACDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      ACCIDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
.         Format Alternative Start Date
.
          MOVE      SP70,STRTALTD
          MATCH     SP70,PMWXSALT
          GOTO      VALACC45 IF EQUAL
          UNPACK    PMWXSALT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      STRTALTD,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
.         Format Full Incapacity Start Date
. 
VALACC45  MOVE      SP70,FLLINCSD
          MATCH     SP70,PMWXFISD
          GOTO      VALACC46 IF EQUAL
          UNPACK    PMWXFISD,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      FLLINCSD,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
.         Format Return to Work Date
.
VALACC46  MOVE      SP70,RTNWDATE
          MATCH     SP70,PMWXRNWD
          GOTO      VALACC47 IF EQUAL
          UNPACK    PMWXRNWD,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      RTNWDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
.         Format Accident Decline Date
.
VALACC47  MOVE      SP70,ACCDECDT
          MATCH     SP70,PMWXADTE
          GOTO      VALACC50 IF EQUAL
          UNPACK    PMWXADTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      ACCDECDT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
.         Get ACC Details for the claim number
.
VALACC50  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>": 
                             "ACC Details already recorded for this patient ":
                             "|",VALDCODE,"|",PMWXCNAM,"|",PMWXACCF,"|":
                             PMWXPLIN,"|",PMWXACTI,"|",ACCDECDT,"|":
                             PMWXATME,"|",PMWXACLC,"|",PMWXAINZ,"|":
                             PMWXMOVV,"|",PMWXSPTI,"|",PMWXSPRT,"|":
                             PMWXRECI,"|",PMWXTRIC,"|",PMWXESTA,"|":
                             ACCDCDTE,"|",PMWXARG1,"|",PMWXARG2,"|":
                             PMWXARSN,"|",PMWXARTL,"|",PMWXARRP,"|":
                             PMWXCSTA,"|",PMWXTWRK,"|",PMWXOEST,"|":
                             WCENAME,"|",WCEADD1,"|",WCEADD2,"|",WCEADD3,"|":
                             WCEADD4,"|",WCEPOST,"|",WCETELE,"|",ACCIDATE,"|":
                             PMWXASST,"|",PMWXNEED,"|",PMWXCONT,"|",PMWXALTW:
                             "|",PMWXTYPA,"|",STRTALTD,"|",PMWXHPDA,"|":
                             PMWXUNFD,"|",PMWXUNFT,"|",FLLINCSD,"|",RTNWDATE:
                             "|";
.
          MOVE      "001",COMMTYPE
          PACK      KEY26,WCCLMNO,COMMTYPE,SP70
          CALL      RSACCMT1
VALACC55  CALL      RKACCMT1
          BRANCH    OVRCD,VALACC60
.
          MATCH     WCCLMNO,ACCMACCN
          GOTO      VALACC60 IF NOT EQUAL
.
          MATCH     COMMTYPE,ACCMTYPE
          GOTO      VALACC60 IF NOT EQUAL
.
          STRIP     ACCMDATA
          WRITE     HTMLFILE;*+,ACCMDATA
          GOTO      VALACC55
.
VALACC60  WRITE     HTMLFILE;"|";
          MOVE      "002",COMMTYPE
          PACK      KEY26,WCCLMNO,COMMTYPE,SP70
          CALL      RSACCMT1
VALACC65  CALL      RKACCMT1
          BRANCH    OVRCD,VALACC70
.                            
          MATCH     WCCLMNO,ACCMACCN
          GOTO      VALACC70 IF NOT EQUAL
.
          MATCH     COMMTYPE,ACCMTYPE
          GOTO      VALACC70 IF NOT EQUAL
.         
          STRIP     ACCMDATA
          WRITE     HTMLFILE;*+,ACCMDATA
          GOTO      VALACC65
.                            
VALACC70  WRITE     HTMLFILE;"|",PMWXTPRO:                   * 46
                             "|",PMWXGRAD:                   * 47
                             "|",PMWXPORD:                   * 48
                             "|",PMWXAHOS:                   * 49 
                             "|",PMWXVCON;                   * 50
.
          IF        PTCNHDPS=1
            WRITE     HTMLFILE;"|",PMWXVHCP;                 * 51
          ENDIF
.
          WRITE     HTMLFILE;"</RETURN_VALUE>"
          GOTO      VALACC98
.
VALACC98  CALL      XMLEND00
.
VALACC99  RETURN
.------------------------------------------------------------
. Validate if Adverse Outcome Code Exists
.------------------------------------------------------------
VALADC00  CALL      XMLHED00
          BRANCH    EXIT,VALADC99
.
          PACK      KEY6,VALDCODE,SP70
          CALL      RDPMADC1
          BRANCH    OVRCD,VALADC90
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PMACDESC:
                             "</RETURN_VALUE>"
          GOTO      VALADC98
.
VALADC90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Outcome Code":
                             "</RETURN_VALUE>"
          GOTO      VALADC98
.
VALADC98  CALL      XMLEND00
VALADC99  RETURN
+
.----------------------------------------------------------------------
.         Get the financial year of a date
.----------------------------------------------------------------------
GFYEAR00  CALL      XMLHED00
          BRANCH    EXIT,GFYEAR99
.
          PACK      KEY14,VALDDATE,SP70
          CALL      RDSDRGA2            * Position in Date range file
          CALL      RDKDRGA2            * Get the first record from given date
          BRANCH    OVRCD,GFYEAR90      * No record found in file
.
          MATCH     DRGFDTE,VALDDATE    * Is the given date before this period
          GOTO      GFYEAR90 IF LESS    * Yes. Date not in file
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             DRGYR,"|":
                             DRGNUM,"|":
                             DRGCYR,"|":
                             DRGCNUM,"|":
                             "</RETURN_VALUE>"
          GOTO      GFYEAR98
.
.         The requested date wasn't in the file
.
GFYEAR90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Date is not in Period Date Range":
                             "</RETURN_VALUE>"
          GOTO      GFYEAR98
.
GFYEAR98  CALL      XMLEND00
GFYEAR99  RETURN
+
.----------------------------------------------------------------------
.         Get the ECT counts
.----------------------------------------------------------------------
ECTC0000  MOVE      ZERO,COUNTER
          MOVE      ZERO,F2
          CALL      XMLHED00
          BRANCH    EXIT,ECTC9999
.
          MATCH     SP70,VALDDATE
          GOTO      ECTC8000 IF EQUAL
.
          MATCH     SP70,VALDCODE
          GOTO      ECTC8000 IF EQUAL
.
          PACK      KEY8,VALDCODE,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,ECTC9000
.
          PACK      DIM4,VALDDATE,SP70
          PACK      KEY24,VALDCODE,DIM4,ZERO,ONE,ZERO,ONE,SP70
          CALL      RDSVISA2            * Position in Date range file
ECTC1000  CALL      RDKVISA2            * Get the first record from given date
          BRANCH    OVRCD,ECTC8000      * No record found in file
.
          MATCH     VALDCODE,PVIURNO
          GOTO      ECTC8000 IF NOT EQUAL
.
          PACK      D4,PVIDATE
          MATCH     DIM4,D4             * same year?
          GOTO      ECTC8000 IF NOT EQUAL
.
          PACK      KEY18,DPVIBILL,TWO,SP70
          CALL      RDSDTRN3
ECTC2000  CALL      RDKDTRN3
          BRANCH    OVRCD,ECTC3000
.
          MATCH     DPVIBILL,DTADMNO
          GOTO      ECTC3000 IF NOT EQUAL
.
          MATCH     "14224",TITEMNO
          GOTO      ECTC2100 IF EQUAL
.
          MATCH     "93341",TITEMNO
          GOTO      ECTC2000 IF NOT EQUAL
.
ECTC2100  ADD       ONE,COUNTER
          GOTO      ECTC2000
.
ECTC3000  PACK      KEY14,DPVIBILL,SP70
          CALL      RSPMMTI1
ECTC3100  CALL      RKPMMTI1
          BRANCH    OVRCD,ECTC1000
.
          MATCH     DPVIBILL,PMMIVISN
          GOTO      ECTC1000 IF NOT EQUAL
.
          MATCH     "14224",PMMIITEM
          GOTO      ECTC4000 IF EQUAL
.
          MATCH     "93341",PMMIITEM
          GOTO      ECTC3100 IF NOT EQUAL
.
ECTC4000  ADD       ONE,COUNTER
          GOTO      ECTC3100
.
ECTC8000  MOVE      ZERO,FORM2
          SQUEEZE   PTMXLGA
          MOVE      PTMXLGA,FORM2
          ADD       COUNTER,FORM2
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PTMXLGA,"|":
                             COUNTER,"|":
                             FORM2,"|":
                             "</RETURN_VALUE>"
          GOTO      ECTC9800
.
.
ECTC9000  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid UR Number":
                             "</RETURN_VALUE>"
          GOTO      ECTC9800
.
ECTC9800  CALL      XMLEND00
ECTC9999  RETURN
+
.----------------------------------------------------------------------
. Output Select Options for theatre operating rooms with multi hospital
.----------------------------------------------------------------------
SELOPR00  CALL      XMLHED00
          BRANCH    EXIT,SELOPR99
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
          PACK      KEY6,SP70
          CALL      RSOPOPR1
SELOPR10  CALL      RKOPOPR1
          BRANCH    OVRCD,SELOPR19
.
          MATCH     "~~~",VALDCODE                * allow all hospitals ibaopr66002
          GOTO      SELOPR15 IF EQUAL
.
          IF        IBCNMHOS=1
            MATCH     SP70,OPRMHOSP
            IF        !@EQUAL
              MATCH     VALDCODE,OPRMHOSP
              GOTO      SELOPR10 IF NOT EQUAL
            ENDIF
          ENDIF
.
SELOPR15  BRANCH     OPRMSTAT,SELOPR10           * Inactive
.
          WRITE     HTMLFILE;OPRMROOM,",",OPRMDESC,"|";
          GOTO      SELOPR10
.
SELOPR19  WRITE     HTMLFILE;"</RETURN_VALUE>"
          GOTO      SELOPR98
.
SELOPR98  CALL      XMLEND00
SELOPR99  RETURN
+
.----------------------------------------------------------------------
. Check for a valid record on nzpcmtaf - nz private matrix
.* Requires       : CPROCODE -Procedure Code                                  *
.*                : PROCSURG -Surgeon                                         *
.*                : PROCCNTR -Contract                                        *
.*                : PROCCLMC -Claim code                                      *
.*                : PROCADAT -Admission Date                                  *
.*                : PROCHOSP -Hospital Code                                   *
.*                : PROCWARD -Ward Code                                       *
.*                : MSGFLAG  -0 error message to be displayed                 *
.*                            1 No display error message flag                 *
.*                            2 display matrix screen                         *
.*                                                                            *
.* Returns        : Valid Contract Procedure Codes                            *
.*                  EXIT     0=No matrix record found                         *
.*                           1=1 matrix record found, check on patcmxaf       *
.*                           2=more than 1 matrix record found                *
.----------------------------------------------------------------------
NZMX0000  CALL      XMLHED00
          BRANCH    EXIT,NZMX9999
.         
          MOVE      ZERO,CPROCNUM
          MOVE      ZERO,LOOPFLAG
          PACK      SAVPCNTR,PROCCNTR,SP70
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
NZMX1000  MOVE      "E",NZCMRTYP         * Either
          MOVE      "0",NZCMITYP         * set record flag to 0 for Procedure
          PACK      SKEY20,PROCCLMC,PROCCNTR,NZCMRTYP,NZCMITYP,CPROCODE,SP70
.
          PACK      KEY35,SKEY20,SP70
          CALL      RSNZCMT3
NZMX2000  CALL      RKNZCMT3
          BRANCH    OVRCD,NZMX6000
.
          PACK      KEY20,NZCMCLMC,NZCMCNTR,NZCMRTYP,NZCMITYP,NZCMPROC,SP70
          MATCH     SKEY20,KEY20
          GOTO      NZMX6000 IF NOT EQUAL
.
          PACK      PROCCNTR,SAVPCNTR,SP70
          CALL      CCFN0000             * Check Contract funding
          BRANCH    EXIT,NZMX2000        * Not valid
.
          CALL      CPFE0000             * check Effec.date Contract Proc.fee
          BRANCH    EXIT,NZMX2000        * Not valid
.
          PACK      KEY9,NZCMCPRC,SP70
          CALL      RDPTCMC1
          BRANCH    OVRCD,NZMX2000
.
          ADD       ONE,CPROCNUM
          PACK      MPROCCOD[CPROCNUM],NZCMCPRC
          GOTO      NZMX2000
.
.         Using default if no match found
.
NZMX6000  COMPARE   ZERO,CPROCNUM
          GOTO      NZMX9800 IF NOT EQUAL  * found a matching record
.
          ADD       ONE,LOOPFLAG
          BRANCH    LOOPFLAG,NZMX7000    * try with the default
.
          GOTO      NZMX9800
.
.         Try with blank contract/health fund
.
NZMX7000  MOVE      SP70,PROCCNTR        * blank contract
          GOTO      NZMX1000
.
NZMX9800  WRITE     HTMLFILE;CPROCNUM,"|";
          COMPARE   ONE,CPROCNUM
          IF        @EQUAL
            WRITE     HTMLFILE;MPROCCOD[CPROCNUM],"|",PTCADES1,"|";
          ELSE
            WRITE     HTMLFILE;SP10,"|",SP10,"|";
          ENDIF
.
          WRITE     HTMLFILE;"</RETURN_VALUE>"
          GOTO      NZMX9900
.
NZMX9900  CALL      XMLEND00
NZMX9999  RETURN
+
.******************************************************************************
. ----- Check the Contract Funding file ------
.******************************************************************************
CCFN0000  MOVE      ZERO,EXIT
          PACK      KEY3,PROCHOSP,SP70
          MATCH     SP70,PROCHOSP
          GOTO      CCFN1000 IF NOT EQUAL
.
          MATCH     SP70,PROCWARD
          GOTO      CCFN1000 IF EQUAL
.
          PACK      KEY6,PROCWARD,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,CCFN1000
          PACK      PROCHOSP,PTWDHOSN,SP70
          PACK      KEY3,PROCHOSP,SP70
.
CCFN1000  MOVE      ZERO,FORM1
          PACK      SKEY21,KEY3,PROCCLMC,PROCCNTR,NZCMCPRC,SP70
.
CCFN2000  MOVE      ONE,NZCFSTYP           * default start type
          PACK      KEY30,SKEY21,ONE,PROCADAT,SP70
          CALL      RDNZCFN1
          COMPARE   ZERO,OVRCD
          GOTO      CCFN5000 IF EQUAL
.
CCFN2100  CALL      RPNZCFN1
          BRANCH    OVRCD,CCFN2200
          PACK      KEY21,NZCFHOSP,NZCFCLMC,NZCFCNTR,NZCFCPRC,SP70
.
          MATCH     KEY21,SKEY21
          GOTO      CCFN5000 IF EQUAL        * check the start and enddate
.
.         Try with Claim code,blank Health fund and Contract procedure code
.
CCFN2200  IF        FORM1=3
            MATCH     SP70,KEY3
            IF        !@EQUAL
              MOVE      SP70,KEY3               * try with a blank hosp.code
              GOTO      CCFN1000
            ENDIF
          ENDIF
          BRANCH    FORM1,CCFN2300,CCFN2400,CCFN9000
.
.         Try with blank contract proc code
.
          PACK      SKEY21,KEY3,PROCCLMC,PROCCNTR,SP70
          ADD       ONE,FORM1
          GOTO      CCFN2000
.
.         Try with blank Health fund
.
CCFN2300  PACK      SKEY21,KEY3,PROCCLMC,SP6,NZCMCPRC,SP70
          ADD       ONE,FORM1
          GOTO      CCFN2000
.
.         Try with blank health fund and blank contract proc.code
.
CCFN2400  PACK      SKEY21,KEY3,PROCCLMC,SP70
          ADD       ONE,FORM1
          GOTO      CCFN2000
.
.         Check the admission date
.
CCFN5000  REP       " 0",PROCADAT
.
.         If patient admitted before the start date, No Contract
.
          MATCH     NZCFSDAT,PROCADAT       * Admit./disc.before start date?
          GOTO      CCFN2100 IF LESS        * Yes, invalid
.
          MATCH     SP70,NZCFEDAT
          GOTO      CCFN7000 IF EQUAL       * No end date, so it's valid
.
          MATCH     PROCADAT,NZCFEDAT       * Check End date
          GOTO      CCFN2100 IF LESS        * Date is after end date, invalid
.
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          COMPARE   ONE,IBCNMHOS
          GOTO      CCFN8000 IF NOT EQUAL
.
.         Check if this is for a specific Doctor
.
CCFN7000  MATCH     "1",NZCFDOCS
          GOTO      CCFN8000 IF NOT EQUAL   * Not for a specific doctor
.
          PACK      KEY40,NZCFHOSP,NZCFCLMC,NZCFCNTR,NZCFCPRC,NZCFSTYP:
                          NZCFSDAT,PROCSURG
          CALL      RDMLCFN1
          BRANCH    OVRCD,CCFN2100          * not valid for this hospital
.
CCFN8000  MOVE      ZERO,EXIT
          GOTO      CCFN9999
.
CCFN9000  MOVE      ONE,EXIT
CCFN9999  RETURN
.
+
.----------------------------------------------------------------------
.         Check Effec.date Contract Proc.fee
.----------------------------------------------------------------------
CPFE0000  MOVE      ZERO,F1
          REP       " 0",PROCADAT
          PACK      KEY29 WITH PROCHOSP,PROCCLMC,PROCCNTR,SP8,NZCMCPRC,SP70
.
CPFE1000  PACK      KEY37,KEY29,PROCADAT,SP70
          CALL      RDNZPFE1
          COMPARE   ZERO,OVRCD
          GOTO      CPFE8000 IF EQUAL
.
          CALL      RPNZPFE1                  * check for previous record
          BRANCH    OVRCD,CPFE2000
.
          PACK      DIM29 WITH NZPFHOSP,NZPFCLMC,NZPFCNTR,NZPFFTAB,NZPFCPRC:
                               SP70
          MATCH     DIM29,KEY29
          GOTO      CPFE2000 IF NOT EQUAL
          GOTO      CPFE8000
.
CPFE2000  ADD       ONE,F1
          BRANCH    F1,CPFE3000,CPFE4000,CPFE5000
          GOTO      CPFE9000
.
CPFE3000  PACK      KEY29 WITH PROCHOSP,PROCCLMC,SP6,SP8,NZCMCPRC,SP70
          GOTO      CPFE1000
.
CPFE4000  IF        IBCNMHOS=1
            OPEN      PATHSPA1,"pathspaf"
            MOVE      PROCHOSP,KEY3
            CALL      RDPTHSP1
            BRANCH    OVRCD,CPFE2000
            PACK      KEY29 WITH PROCHOSP,PTHSDCLM,PROCCNTR,SP8,NZCMCPRC,SP70
            GOTO      CPFE1000
          ENDIF
          GOTO      CPFE2000
.
CPFE5000  PACK      KEY29 WITH PROCHOSP,PTCNDCLM,PROCCNTR,SP8,NZCMCPRC,SP70
          GOTO      CPFE1000
.
CPFE8000  MOVE      ZERO,EXIT
          GOTO      CPFE9999
.
CPFE9000  MOVE      ONE,EXIT
CPFE9999  RETURN
+
.----------------------------------------------------------------------
. Check for a valid record on nzpcmtaf - nz private matrix
.* Requires       : CPROCODE -Procedure Code                                  *
.*                : PROCSURG -Surgeon                                         *
.*                : PROCCNTR -Contract                                        *
.*                : PROCCLMC -Claim code                                      *
.*                : PROCADAT -Admission Date                                  *
.*                : PROCHOSP -Hospital Code                                   *
.*                : PROCWARD -Ward Code                                       *
.*                : CONTPROC -Contract Procedure Code                         *
.*                                                                            *
.* Returns        : EXIT     0=No matrix record found                         *
.*                           1=Valid contract procedure code assigned         *
.----------------------------------------------------------------------
VALNZM00  CALL      XMLHED00
          BRANCH    EXIT,VALNZM99
.
          MOVE      ZERO,CPROCNUM
          MOVE      ZERO,LOOPFLAG
          PACK      SAVPCNTR,PROCCNTR,SP70
VALNZM10  MOVE      "E",NZCMRTYP         * Either
          MOVE      "0",NZCMITYP         * set record flag to 0 for Procedure
          PACK      SKEY20,PROCCLMC,PROCCNTR,NZCMRTYP,NZCMITYP,CPROCODE,SP70
.
          PACK      KEY35,SKEY20,SP70
          CALL      RSNZCMT3
VALNZM20  CALL      RKNZCMT3
          BRANCH    OVRCD,VALNZM60
.
          PACK      KEY20,NZCMCLMC,NZCMCNTR,NZCMRTYP,NZCMITYP,NZCMPROC,SP70
          MATCH     SKEY20,KEY20
          GOTO      VALNZM60 IF NOT EQUAL
.
          PACK      PROCCNTR,SAVPCNTR,SP70
          CALL      CCFN0000             * Check Contract funding
          BRANCH    EXIT,VALNZM20        * Not valid
.
          PACK      KEY9,NZCMCPRC,SP70
          CALL      RDPTCMC1
          BRANCH    OVRCD,VALNZM20
.
          MATCH     CONTPROC,NZCMCPRC      * is this the selected code?
          GOTO      VALNZM20 IF NOT EQUAL
          GOTO      VALNZM95
.
.         Using default if no match found
.
VALNZM60  COMPARE   ZERO,CPROCNUM
          GOTO      VALNZM95 IF NOT EQUAL  * found a matching record
.
          ADD       ONE,LOOPFLAG
          BRANCH    LOOPFLAG,VALNZM70    * try with the default
.
          GOTO      VALNZM90
.
.         Try with blank contract/health fund
.
VALNZM70  MOVE      SP70,PROCCNTR        * blank contract
          GOTO      VALNZM10
.
VALNZM90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Contract Procedure Code Assigned":
                             "</RETURN_VALUE>"
          GOTO      VALADM98
.
VALNZM95  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             CONTPROC,"|":
                             "</RETURN_VALUE>"
          GOTO      VALNZM98
.
VALNZM98  CALL      XMLEND00
VALNZM99  RETURN
+
.----------------------------------------------------------------------
. Output userid group security url
.----------------------------------------------------------------------
SECGRP00  CALL      XMLHED00
          BRANCH    EXIT,SECGRP99
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
.
          PACK      KEY20,USERID,SP70
          CALL      RDWBSGP1
          BRANCH    OVRCD,SECGRP05
.
          WRITE     HTMLFILE;SP1;
          GOTO      SECGRP90
.
SECGRP05  PACK      KEY20,USERID,SP70
          CALL      RSWBSGP1
SECGRP10  CALL      RKWBSGP1
          BRANCH    OVRCD,SECGRP90
.
          MATCH     USERID,WBSGUSID
          GOTO      SECGRP90 IF NOT EQUAL
.
          PACK      KEY10,WBSGGRPC,SP70
          CALL      RDWBGRP1
          BRANCH    OVRCD,SECGRP10
.
          MATCH     "1",WBGRACTV                 * Inactive
          GOTO      SECGRP10 IF EQUAL
.
          STRIP     WBGRSURL 
.
          WRITE     HTMLFILE;*+,WBGRSURL,"|";
          GOTO      SECGRP10
.
SECGRP90  WRITE     HTMLFILE;"</RETURN_VALUE>"
          GOTO      SECGRP98
.
SECGRP98  CALL      XMLEND00
SECGRP99  RETURN
+
.----------------------------------------------------------------------
. Output the users login url for the securty group IBALoginURL cookie
.----------------------------------------------------------------------
SECURL00  CALL      XMLHED00
          BRANCH    EXIT,SECURL99
.
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      SP70,WBSEDIR
          ENDIF

          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
.
          STRIP     WBSEDIR
          WRITE     HTMLFILE;*+,WBSEDIR;
.
          WRITE     HTMLFILE;"</RETURN_VALUE>"
          GOTO      SECURL98
.
SECURL98  CALL      XMLEND00
SECURL99  RETURN
+
.------------------------------------------------------------
. Dummy routines
.------------------------------------------------------------
DELECD00  RETURN
DELECO00  RETURN
DISSQE00  RETURN
PROSQE00  RETURN
.
.------------------------------------------------------------
. Output Select Options for Ward depending on Hospital ID
.------------------------------------------------------------
SELWEK00  CALL      XMLHED00
          BRANCH    EXIT,SELWEK99
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
.
SELWEK10  PACK      FRSTDATE,VALDCODE,SP70
          MOVE      ONE,VIEWTYPE
          CALL      CURPER00
.
          UNPACK    FRSTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      "42",ADJDAYS
          CALL      ADJDAT00
          PACK      ENDDATE,CCENT,CYEAR,CMON,CDAY
          REP       " 0",ENDDATE
.         
          UNPACK    FRSTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      "-42",ADJDAYS
          CALL      ADJDAT00   
          PACK      STRTDATE,CCENT,CYEAR,CMON,CDAY
          REP       " 0",STRTDATE
          REP       " 0",FRSTDATE
.         
SELWEK30  UNPACK    STRTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          WRITE     HTMLFILE;STRTDATE,",Week of ":
                             CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"|";
.
          MOVE      "7",ADJDAYS
          CALL      ADJDAT00
          PACK      STRTDATE,CCENT,CYEAR,CMON,CDAY
          REP       " 0",STRTDATE
          MATCH     ENDDATE,STRTDATE
          GOTO      SELWEK30 IF NOT EQUAL
.
SELWEK80  WRITE     HTMLFILE;"</RETURN_VALUE>"
          GOTO      SELWEK98
.
SELWEK98  CALL      XMLEND00
SELWEK99  RETURN
.
.----------------------------------------------------------------
. CHKWB000 - Check if this patient has a WL procedure or booking
.----------------------------------------------------------------
.
CHKWB000  CALL      XMLHED00
          BRANCH    EXIT,CHKWB999
.
          MOVE      ZERO,WLFLAG
          MOVE      ZERO,BKFLAG
          MOVE      ZERO,PREAFLAG
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
.
          PACK      KEY19,VALDCODE,SP20
          OPEN      WATTR1A1,"wattr1af"
          CALL      RDSTREA1
CHKWB100  CALL      RDKTREA1
          BRANCH    OVRCD,CHKWB500          * no procedures
.
          MATCH     VALDCODE,WMURNO
          GOTO      CHKWB500 IF NOT EQUAL   * no procedures
.
          COMPARE   "3",WMSTAT
          GOTO      CHKWB100 IF NOT LESS    * not a valid status
          MOVE      ONE,WLFLAG
.
CHKWB500  OPEN      BOKRC1A6,"bokrc1af"
          PACK      KEY16,VALDCODE,SP20
          CALL      RSBKREC6
CHKWB600  CALL      RKBKREC6
          BRANCH    OVRCD,CHKWB700
.
          MATCH     VALDCODE,BKREURNO
          GOTO      CHKWB700 IF NOT EQUAL
.
          COMPARE   ONE,BKRESTAT
          GOTO      CHKWB600 IF NOT LESS
.
          MOVE      ONE,BKFLAG
          GOTO      CHKWB700
.
CHKWB700  PACK      KEY17,VALDCODE,ONE,SP20
          CALL      RSPTMI18
CHKWB800  CALL      RKPTMI18
          BRANCH    OVRCD,CHKWB900          * not on file
.
          MATCH     VALDCODE,AURNO          * same U/R Number?
          GOTO      CHKWB900 IF NOT EQUAL   * No
.
          COMPARE   ONE,ASTAT
          GOTO      CHKWB900 IF NOT EQUAL
.
          MOVE      ONE,PREAFLAG
.
CHKWB900  WRITE     HTMLFILE;WLFLAG,"|",BKFLAG,"|",PREAFLAG,"|":
                             "</RETURN_VALUE>"
.
          GOTO      CHKWB980
.
CHKWB980  CALL      XMLEND00
CHKWB999  RETURN
+
.------------------------------------------------------------
. Output select options for source of referral based on the
. category for source of referral from the OP site
.------------------------------------------------------------
GETSRF00  CALL      XMLHED00
          BRANCH    EXIT,GETSRF99
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
.
          PACK      KEY6,VALDCODE,SP70
          CALL      RDSITA1
          BRANCH    OVRCD,GETSRF90
.
          PACK      KEY2,OSTCATG,SP70
.
          PACK      PTCDKEY2,KEY2,SP70
          CALL      RDSCODE2
GETSRF10  CALL      RDKCODE2
          BRANCH    OVRCD,GETSRF99
.
          MATCH     KEY2,TCODE
          GOTO      GETSRF19 IF NOT EQUAL
.
          MATCH     ACODE,SP70
          GOTO      GETSRF10 IF EQUAL
.
          MATCH     "I",PTCOACTV
          GOTO      GETSRF10 IF EQUAL
.
          IF        IBCNMHOS=1
            MATCH    "1",PTCDHOSS
            IF       @EQUAL
              PACK     KEY8,VALDCOD2,TCODE,ACODE,SP70
              CALL     RDMLCOD1
              BRANCH   OVRCD,GETSRF10
            ENDIF
          ENDIF
.
          PACK      KEY15,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5:
                          TCINDC6,TCINDC7,TCINDC8,TCINDC9,TCINDC10:
                          TCINDC11,THCSCOD
.
          PACK      KEY20,ACODE,KEY15,SP70
.
          WRITE     HTMLFILE;KEY20,",",TDESC,"|";
          GOTO      GETSRF10
.
GETSRF19  WRITE     HTMLFILE;"</RETURN_VALUE>"
          GOTO      GETSRF98
.
GETSRF90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Site Code - ":
                             VALDCODE,"</RETURN_VALUE>"
          GOTO      GETSRF98
.
GETSRF98  CALL      XMLEND00
GETSRF99  RETURN
+
.------------------------------------------------------------
. Link Unlink Patient Disaster
.------------------------------------------------------------
VALDPL00  CALL      XMLHED00
          BRANCH    EXIT,VALDPL99
.
          PACK      KEY25,VALDCODE,SP70
          CALL      RDDSPTL1
          BRANCH    OVRCD,VALDPL90
.
          CALL      DEDSPTL1
.
          GOTO      VALDPL98
.
VALDPL90  UNPACK    VALDCODE,DSPLURNO,DSPLCODE,DSPLVISN
          MOVE      WBSEUID,DSPLCUSR
          CALL      IBACLOCK
          PACK      DSPLCDAT,CCC,CYY,CMM,CDD
          REP       " 0",DSPLCDAT
          MOVE      CTIMEIS,DSPLCTIM
          MOVE      SP70,DSPLUUSR
          MOVE      SP70,DSPLUDAT
          MOVE      SP70,DSPLUTIM
          PACK      DSPLSPAR,SP70,SP70
.
          CALL      WRDSPTL1
.
          GOTO      VALITN98
.
VALDPL98  CALL      XMLEND00
VALDPL99  RETURN
.------------------------------------------------------------
. Check if patient has multiple admissions
.------------------------------------------------------------
MULTAD00  CALL      XMLHED00
          BRANCH    EXIT,MULTAD99
.
          MOVE      ZERO,F1
          MOVE      ZERO,CURRENTA
          PACK      HOSPNAME,SP70
          PACK      ADMNUMBR,SP70
          PACK      LEAVTYPE,SP70
          MOVE      ZERO,ADMTHOSP
          MOVE      SP10,DIM3
.
          IF        IBCNMHOS=1
            PACK      KEY10,USERID,SP70
            CALL      RDWBSE1
            IF        OVRCD=1
              PACK      WBSEHOSP,SP70
            ENDIF
          ENDIF
.
          PACK      DIM8,VALDCODE,SP70
          PACK      KEY17,DIM8,TWO,SP70  * Read Admission File
          CALL      RSPTMI18
MULTAD10  CALL      RKPTMI18
          BRANCH    OVRCD,MULTAD15
.
          MATCH     AURNO,VALDCODE
          GOTO      MULTAD15 IF NOT EQUAL
.
          MATCH     "2",DASTAT
          GOTO      MULTAD15 IF NOT EQUAL
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,MULTAD10
.
          MOVE      PMVXMHOS,DIM3 
          IF        IBCNMHOS=1
            MATCH     WBSEHOSP,PMVXMHOS
            IF        @EQUAL
              MOVE      ONE,ADMTHOSP             * Already admitted this hosp
            ENDIF
          ENDIF
.
          ADD       ONE,F1
          MOVE      ONE,CURRENTA
          PACK      KEY3,PMVXMHOS,SP70
          CALL      RDPTHSP1
          IF        OVRCD<>1
            PACK      HOSPNAME,PTHSNAME,SP70
          ENDIF
          PACK      ADMNUMBR,AADMNO,SP70
          GOTO      MULTAD10
.
MULTAD15  MOVE      SP70,IND3DIM1
          PACK      DIM8,VALDCODE,SP70
          PACK      KEY17,DIM8,FOUR,SP70  * Read Admission File
          CALL      RSPTMI18
MULTAD20  CALL      RKPTMI18
          BRANCH    OVRCD,MULTAD90
.
          MATCH     AURNO,VALDCODE
          GOTO      MULTAD90 IF NOT EQUAL
.
          MATCH     "4",DASTAT
          GOTO      MULTAD90 IF NOT EQUAL
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,MULTAD20
.
          MOVE      PMVXMHOS,DIM3 
          IF        IBCNMHOS=1
            MATCH     WBSEHOSP,PMVXMHOS
            IF        @EQUAL
              MOVE      ONE,ADMTHOSP             * Already admitted this hosp
            ENDIF
          ENDIF
.
          ADD       ONE,F1
.         MOVE      ONE,CURRENTA
          PACK      KEY3,PMVXMHOS,SP70
          CALL      RDPTHSP1
          IF        OVRCD<>1
            PACK      HOSPNAME,PTHSNAME,SP70
          ENDIF
          PACK      ADMNUMBR,AADMNO,SP70
          PACK      KEY30,AADMNO,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,MULTAD20
.
          MATCH     DAADMNO,DTADMN
          GOTO      MULTAD20 IF NOT EQUAL
.
          MATCH     ANSL,TMOVE
          IF        @EQUAL
            MATCH     SP70,PTTRLTYP
            GOTO      MULTAD20 IF EQUAL
            PACK      KEY5,ANST,ANSL,PTTRLTYP,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MATCH     ANSM,TCINDC3
              IF        @EQUAL
                PACK      LEAVTYPE,TDESC,LBRACK,TCINDC3,RBRACK,SP70
              ELSE
                PACK      LEAVTYPE,TDESC,SP70
              ENDIF
              MOVE    TCINDC3,IND3DIM1
            ENDIF
          ENDIF
          GOTO      MULTAD20
.
MULTAD90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                               CURRENTA,"|",F1,"|",HOSPNAME,"|":
                               ADMNUMBR,"|",LEAVTYPE,"|",ADMTHOSP,"|":
                               IND3DIM1,"|",DIM3,"|",WBSEHOSP:
                               "</RETURN_VALUE>"
          GOTO      MULTAD98
.
MULTAD98  CALL      XMLEND00
MULTAD99  RETURN
+
.----------------------------------------------------------------------
.         Validate Disaster Date              
.----------------------------------------------------------------------
DISDAT00  CALL      XMLHED00
          BRANCH    EXIT,DISDAT99
.
DISDAT10  UNPACK    SP70,DIM9,DIM11,DIM8
          UNPACK    VALDCODE,DIM9,DIM11
.
          UNPACK    DIM11,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00
          PACK      DIM8,CCENT,CYEAR,CMON,CDAY
          REP       " 0",DIM8
.
          PACK      KEY9,DIM9,SP70
          CALL      RDDSMAS1
          BRANCH    OVRCD,DISDAT90      * No record found in file
.
          MATCH     SP70,DSMASDAT
          IF        !@EQUAL & !@EOS
            MATCH     DSMASDAT,DIM8
            GOTO      DISDAT91 IF LESS 
          ENDIF
.
          MATCH     SP70,DSMAEDAT
          IF        !@EQUAL & !@EOS
            MATCH     DIM8,DSMAEDAT
            GOTO      DISDAT91 IF LESS
          ENDIF 
.
          GOTO      DISDAT98
.
.
DISDAT90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Disaster Master Record Not Found.":
                             "</RETURN_VALUE>"
          GOTO      DISDAT98
.
DISDAT91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                            "Arrival Date not within Disaster Date range.":
                             "</RETURN_VALUE>"
          GOTO      DISDAT98
.
DISDAT98  CALL      XMLEND00
DISDAT99  RETURN
+
.----------------------------------------------------------
. Selection list for Units attached to a HCP/Hospital combo
.----------------------------------------------------------
SELUNT00  CALL      XMLHED00
          BRANCH    EXIT,SELUNT99
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
.         
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,SELUNT90               
.         
          PACK      KEY10,VALDCODE,SP70
          MATCH     SP70,KEY10
          GOTO      SELUNT90 IF EQUAL
.         
          PACK      KEY21,KEY10,WBSEHOSP,SP70    * hcp/hosp
          MATCH     "1",VALDTYPE
          IF        @EQUAL
            PACK      KEY21,KEY10,VALDCOD2,SP70    * hcp/hosp
          ENDIF
          CALL      RSPMTMD1
SELUNT25  CALL      RKPMTMD1
          BRANCH    OVRCD,SELUNT90
.
          MATCH     VALDCODE,PMTDDOCT
          GOTO      SELUNT90 IF NOT EQUAL        * same hcp?
.
          MATCH     "1",VALDTYPE
          IF        @EQUAL
            MATCH     VALDCOD2,PMTDHOSP
            GOTO      SELUNT90 IF NOT EQUAL        * same hosp?
          ELSE
            MATCH     WBSEHOSP,PMTDHOSP
            GOTO      SELUNT90 IF NOT EQUAL        * same hosp?
          ENDIF
.
          MATCH     "0",PMTDACTV
          GOTO      SELUNT25 IF NOT EQUAL        * only want active records
.
          MATCH     SP70,PMTDTEAM
          GOTO      SELUNT25 IF NOT EQUAL        * only want header records
.
          PACK      KEY5,ANSA,ANSC,PMTDUNIT,SP70
          CALL      RDCODE1                      * category AC
          BRANCH    OVRCD,SELUNT90
.
          MATCH     ACODE,SP70
          GOTO      SELUNT25 IF EQUAL
          MATCH     "I",PTCOACTV
          GOTO      SELUNT25 IF EQUAL
          PACK      KEY15,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5:
                          TCINDC6,TCINDC7,TCINDC8,TCINDC9,TCINDC10:
                          TCINDC11,THCSCOD
          PACK      KEY18,ACODE,KEY15
          WRITE     HTMLFILE;KEY18,",",TDESC,"|";
          GOTO      SELUNT25
.
SELUNT90  WRITE     HTMLFILE;"</RETURN_VALUE>"
          GOTO      SELUNT98
.
SELUNT98  CALL      XMLEND00
SELUNT99  RETURN
+
.---------------------------------------------------------------
. Selection list for Teams attached to a HCP/Hospital/Unit combo
.---------------------------------------------------------------
SELTEM00  CALL      XMLHED00
          BRANCH    EXIT,SELTEM99
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
.
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,SELTEM90
.
          PACK      KEY10,VALDCODE,SP70
          MATCH     SP70,KEY10
          GOTO      SELTEM90 IF EQUAL
.
          PACK      KEY3,VALDCOD2,SP70
          MATCH     SP70,KEY3
          GOTO      SELTEM90 IF EQUAL
.
          PACK      KEY21,KEY10,WBSEHOSP,KEY3,SP70  * hcp/hosp/unit
          MATCH     "1",VALDTYPE
          IF        @EQUAL
            MATCH     SP70,VALDCOD3
            IF        !@EQUAL
              UNPACK    VALDCOD3,DIM3
              PACK      KEY21,KEY10,DIM3,KEY3,SP70  * hcp/hosp/unit
            ENDIF
          ENDIF
.
          CALL      RSPMTMD1
SELTEM25  CALL      RKPMTMD1
          BRANCH    OVRCD,SELTEM90
.
          MATCH     VALDCODE,PMTDDOCT
          GOTO      SELTEM90 IF NOT EQUAL   * same hcp?
.
          MATCH     "1",VALDTYPE
          IF        @EQUAL
            MATCH     DIM3,PMTDHOSP
            GOTO      SELTEM90 IF NOT EQUAL   * same hosp?
          ELSE
            MATCH     WBSEHOSP,PMTDHOSP
            GOTO      SELTEM90 IF NOT EQUAL   * same hosp?
          ENDIF
. 
          MATCH     KEY3,PMTDUNIT
          GOTO      SELTEM90 IF NOT EQUAL   * same unit?
.         
          MATCH     "1",PMTDACTV
          GOTO      SELTEM25 IF EQUAL       * team link inactive?
.
          PACK      KEY5,PMTDTEAM,SP70
          CALL      RDPMTEM1                * read team table for desc
          BRANCH    OVRCD,SELTEM25
.
          MATCH     "1",PMTMACTV
          GOTO      SELTEM25 IF EQUAL       * team inactive?
.
          WRITE     HTMLFILE;PMTMTEAM,",",PMTMDESC,"|";
          GOTO      SELTEM25
.
SELTEM90  WRITE     HTMLFILE;"</RETURN_VALUE>"
          GOTO      SELTEM98
.
SELTEM98  CALL      XMLEND00
SELTEM99  RETURN
+
.----------------------------------------------------------------------
. Output Select Options for category A 
.----------------------------------------------------------------------
QUNQ0000  CALL      XMLHED00
          BRANCH    EXIT,QUNQ9999
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
          PACK      KEY5,ANSA,SP70
          CALL      RDSCODE1
QUNQ1000  CALL      RDKCODE1
          BRANCH    OVRCD,QUNQ9000
.
          PACK      DIM2,ANSA,SP1
          MATCH     TCODE,DIM2
          GOTO      QUNQ9000 IF NOT EQUAL
.
          MATCH     ANSI,PTCOACTV
          GOTO      QUNQ1000 IF EQUAL
.
          MATCH     "1",THCSCOD
          GOTO      QUNQ1500 IF EQUAL
.
          MATCH     "2",THCSCOD
          GOTO      QUNQ1500 IF EQUAL
.
          MATCH     "9",THCSCOD
          GOTO      QUNQ1500 IF EQUAL
.
          MATCH     "10",THCSCOD
          GOTO      QUNQ1500 IF EQUAL
.
          GOTO      QUNQ1000 IF NOT EQUAL
.
QUNQ1500  PACK      KEY15,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5:
                          TCINDC6,TCINDC7,TCINDC8,TCINDC9,TCINDC10:
                          TCINDC11,THCSCOD
.
          PACK      KEY20,ACODE,KEY15,SP70
.
          WRITE     HTMLFILE;KEY20,",",TDESC,"|";
          GOTO      QUNQ1000
.
QUNQ9000  WRITE     HTMLFILE;"</RETURN_VALUE>"
          GOTO      QUNQ9800
.
QUNQ9800  CALL      XMLEND00
QUNQ9999  RETURN
+
.----------------------------------------------------------
. Selection list for Roles attached to a HCP/Hospital combo
.----------------------------------------------------------
SELROL00  CALL      XMLHED00
          BRANCH    EXIT,SELROL99
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
.
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,SELROL90
.
          PACK      KEY10,VALDCODE,SP70
          MATCH     SP70,KEY10
          GOTO      SELROL90 IF EQUAL
.
          PACK      KEY16,KEY10,WBSEHOSP,SP70    * hcp/hosp
          CALL      RSPMRLD1
SELROL25  CALL      RKPMRLD1
          BRANCH    OVRCD,SELROL90
.
          MATCH     VALDCODE,PMRDDOCT
          GOTO      SELROL90 IF NOT EQUAL        * same hcp?
.
          MATCH     WBSEHOSP,PMRDHOSP
          GOTO      SELROL90 IF NOT EQUAL        * same hosp?
.
          MATCH     "1",PMRDACTV
          GOTO      SELROL25 IF EQUAL            * inactive?
.
          PACK      KEY5,CATrm,PMRDROLE,SP70
          CALL      RDCODE1                      * category rm
          BRANCH    OVRCD,SELROL90
.
          MATCH     ACODE,SP70
          GOTO      SELROL25 IF EQUAL
          MATCH     "I",PTCOACTV
          GOTO      SELROL25 IF EQUAL
          PACK      KEY15,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5:
                          TCINDC6,TCINDC7,TCINDC8,TCINDC9,TCINDC10:
                          TCINDC11,THCSCOD
          PACK      KEY18,ACODE,KEY15
          WRITE     HTMLFILE;KEY18,",",TDESC,"|";
          GOTO      SELROL25
.
SELROL90  WRITE     HTMLFILE;"</RETURN_VALUE>"
          GOTO      SELROL98
.
SELROL98  CALL      XMLEND00
SELROL99  RETURN
+
.------------------------------------------------------------
. Output Select Options of beds for a given ward                        
. VALDCODE = Ward
. VALDTYPE = "E"mpty beds only (Active)
.            "A"ll beds        (Active)
.            "L"ist all beds for a ward 
.------------------------------------------------------------
WARDBD00  CALL      XMLHED00
          BRANCH    EXIT,WARDBD99
.
          MATCH     SP70,VALDCODE                * Ward is a mandatory field
          GOTO      WARDBD80 IF EQUAL
.
.         List beds for the ward
.
          PACK      KEY6,VALDCODE,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,WARDBD90
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
.
          WRITE     HTMLFILE;WINPUT,"|";         * Output ward type
.
          PACK      KEY16,VALDCODE,SP70
          CALL      RDSWARD8
WARDBD10  CALL      RDKWARD8
          BRANCH    OVRCD,WARDBD80
.
          MATCH     VALDCODE,WWARD
          GOTO      WARDBD80 IF NOT EQUAL
.
          MATCH     SP70,WBED                    * Skip ward master record
          GOTO      WARDBD10 IF EQUAL
.
          MATCH     "L",VALDTYPE                 * All beds for a ward
          GOTO      WARDBD70 IF EQUAL
.
          MATCH     "A",VALDTYPE
          IF        @EQUAL
            BRANCH    WACTIVE,WARDBD10           * All active beds
            GOTO      WARDBD70             
          ENDIF
.
          MATCH     "E",VALDTYPE
          IF        @EQUAL
            BRANCH    WACTIVE,WARDBD10     
            MATCH     ZEROVISN,WADMNO
            GOTO      WARDBD70 IF EQUAL          * Empty active beds only
          ENDIF
.
          GOTO      WARDBD10
.
WARDBD70  MOVE      ZERO,F1
          MOVE      PTCNWBDS,F1
          IF        F1=2
            WRITE     HTMLFILE;WBED,",",PTWDSDES,"|";
          ELSE
            WRITE     HTMLFILE;WBED,",",WBED,"|";
          ENDIF
          GOTO      WARDBD10
.
WARDBD80  WRITE     HTMLFILE;"</RETURN_VALUE>"
          GOTO      WARDBD98
.
WARDBD90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Ward Code - ",VALDCODE:
                             "</RETURN_VALUE>"
          GOTO      WARDBD98
.
WARDBD98  CALL      XMLEND00
WARDBD99  RETURN
.----------------------------------------------------------
. MHDLVL00 - Check for open legal status records
.----------------------------------------------------------
MHDLVL00  CALL      XMLHED00
          BRANCH    EXIT,MHDLVL99
.
          UNPACK    VALDCODE,DIM8,KEY8
.
          PACK      KEY32,VALDCODE,Z70
          CALL      RSMHDLS1
MHDLVL10  CALL      RPMHDLS1
          BRANCH    OVRCD,MHDLVL95
.
          MATCH     DIM8,MHDLURNO
          GOTO      MHDLVL95 IF NOT EQUAL
          MATCH     KEY8,MHDLUNIQ
          GOTO      MHDLVL95 IF NOT EQUAL
.
          MATCH     "1",MHDLACTV
          GOTO      MHDLVL10 IF EQUAL
.
          MATCH     SP70,MHDLEDAT
          GOTO      MHDLVL90 IF EQUAL
          GOTO      MHDLVL90 IF EOS
.
          MATCH     SP70,VALDDATE
          GOTO      MHDLVL10 IF EQUAL
.
          MATCH     MHDLEDAT,VALDDATE
          GOTO      MHDLVL92 IF LESS
          GOTO      MHDLVL10 IF NOT EQUAL
.
          MATCH     MHDLETIM,VALDTIME
          GOTO      MHDLVL92 IF LESS
.
          GOTO      MHDLVL10
.
MHDLVL90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Legal Status record is still open.":
                             "</RETURN_VALUE>"
          GOTO      MHDLVL98
.
MHDLVL92  UNPACK    MHDLEDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      PRDFRDTE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Referral End Date must be AFTER LS End Date: ":
                             PRDFRDTE," Time: ",MHDLETIM:
                             "</RETURN_VALUE>"
          GOTO      MHDLVL98
.
MHDLVL95  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             ONE:
                             "</RETURN_VALUE>"
          GOTO      MHDLVL98
.
MHDLVL98  CALL      XMLEND00
MHDLVL99  RETURN
.
.----------------------------------------------------------
. MULTYB00 - Check for multiple births
.----------------------------------------------------------
MULTYB00  CALL      XMLHED00
          BRANCH    EXIT,MULTYB99
.
MULTBY05  PACK      KEY8,VALDCODE,SP70
          CALL      RDMISS1                        * Mothers admission
          BRANCH    OVRCD,MULTBY60
.
          PACK      KEY16,AURNO,SP70
          CALL      RDSLINK1
MULTBY10  CALL      RDKLINK1
          BRANCH    OVRCD,MULTBY60
.
          MATCH     AURNO,LINKFUR                  * Mothers U/R
          GOTO      MULTBY60 IF NOT EQUAL
.
          MATCH     PTCNDLKR,LINKREA               * Mother baby link
          GOTO      MULTBY10 IF NOT EQUAL
.
          MATCH     ADATE,LINKDAT                  * Linked after mother
          GOTO      MULTBY10 IF LESS               * was admitted
.
MULTYB50  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>": * At least one baby
                             ONE:
                             "</RETURN_VALUE>"
          GOTO      MULTYB98
.
MULTBY60  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>": * No baby
                             ZERO:
                             "</RETURN_VALUE>"
          GOTO      MULTYB98
.
MULTYB98  CALL      XMLEND00
MULTYB99  RETURN
.
.----------------------------------------------------------
. DUPAL000 - Check if a duplicate alert will be created and is valid
.
. RETURNS F1 Value :  0 - No Active alert exists
.            1 - Active alert already exists and may be added if confirmed
.            2 - Active alert already exists but code does not allow duplicates
.            3 - No active alert, only inactive alert exists
.
.----------------------------------------------------------
DUPAL000  CALL      XMLHED00
          BRANCH    EXIT,DUPAL999
.
          MOVE      ZERO,F1
          MOVE      SP70,TDESC
          UNPACK    VALDCODE,URNUMBER
          UNPACK    VALDCOD2,DIM2
          UNPACK    VALDCOD3,DIM3
.
          PACK      KEY16,URNUMBER,DIM2,DIM3,Z70
          CALL      RSPTALR1
DUPAL100  CALL      RPPTALR1
          BRANCH    OVRCD,DUPAL950
.
          MATCH     URNUMBER,PTALURNO
          GOTO      DUPAL950 IF NOT EQUAL
.
          MATCH     DIM2,PTALCATG
          GOTO      DUPAL950 IF NOT EQUAL
.
          MATCH     DIM3,PTALCODE
          GOTO      DUPAL950 IF NOT EQUAL
.
          MATCH     SP70,PTALDTIN
          GOTO      DUPAL150 IF EQUAL
.
          MATCH     VALDDATE,PTALDTIN
          IF        @LESS|@EQUAL
            MOVE      THREE,F1
            MOVE      SP70,TDESC
            PACK      KEY5,PTALCATG,PTALCODE,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      SP70,TDESC
            ENDIF
            GOTO      DUPAL100
          ENDIF
.
DUPAL150  MATCH     SP70,PTALEDAT
          GOTO      DUPAL200 IF EQUAL
.
          MATCH     VALDDATE,PTALEDAT
          IF        @LESS|@EQUAL
            MOVE      THREE,F1
            MOVE      SP70,TDESC
            PACK      KEY5,PTALCATG,PTALCODE,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      SP70,TDESC
            ENDIF
            GOTO      DUPAL100
          ENDIF
.
          GOTO      DUPAL200
.
DUPAL200  MOVE      TWO,F1
          MOVE      SP70,TDESC
          PACK      KEY5,PTALCATG,PTALCODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,DUPAL950
          MATCH     ANSD,TCINDC7
          IF        @EQUAL
            MOVE      ONE,F1
          ENDIF
          GOTO      DUPAL950
.
DUPAL950  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             F1,"|",TDESC:
                             "</RETURN_VALUE>"
          GOTO      DUPAL998
.
DUPAL998  CALL      XMLEND00
DUPAL999  RETURN
+
.----------------------------------------------------------
. DUPAD000 - Check for a duplicate alert on update
.
. RETURNS F1 Value :  0 - No Active alert exists
.            1 - Active alert already exists and may be added if confirmed
.            2 - Active alert already exists but code does not allow duplicates
.            3 - No active alert, only inactive alert exists
.
.----------------------------------------------------------
DUPAD000  CALL      XMLHED00
          BRANCH    EXIT,DUPAD999
.
          MOVE      ZERO,F1
          MOVE      SP70,TDESC
          UNPACK    VALDCODE,URNUMBER
          UNPACK    VALDCOD2,DIM2
          UNPACK    VALDCOD3,DIM3
          UNPACK    VALDCOD4,DIM3A
.
          PACK      KEY16,URNUMBER,DIM2,DIM3,Z70
          CALL      RSPTALR1
DUPAD100  CALL      RPPTALR1
          BRANCH    OVRCD,DUPAD950
.
          MATCH     URNUMBER,PTALURNO
          GOTO      DUPAD950 IF NOT EQUAL
.
          MATCH     DIM2,PTALCATG
          GOTO      DUPAD950 IF NOT EQUAL
.
          MATCH     DIM3,PTALCODE
          GOTO      DUPAD950 IF NOT EQUAL
.
          MATCH     DIM3A,PTALCNTR
          GOTO      DUPAD100 IF EQUAL
.
          MATCH     SP70,PTALDTIN
          GOTO      DUPAD150 IF EQUAL
.
          MATCH     VALDDATE,PTALDTIN
          IF        @LESS|@EQUAL
            MOVE      THREE,F1
            MOVE      SP70,TDESC
            PACK      KEY5,PTALCATG,PTALCODE,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      SP70,TDESC
            ENDIF
            GOTO      DUPAD100
          ENDIF
.
DUPAD150  MATCH     SP70,PTALEDAT
          GOTO      DUPAD200 IF EQUAL
.
          MATCH     VALDDATE,PTALEDAT
          IF        @LESS|@EQUAL
            MOVE      THREE,F1
            MOVE      SP70,TDESC
            PACK      KEY5,PTALCATG,PTALCODE,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      SP70,TDESC
            ENDIF
            GOTO      DUPAD100
          ENDIF
.
          GOTO      DUPAD200
.
DUPAD200  MOVE      TWO,F1
          MOVE      SP70,TDESC
          PACK      KEY5,PTALCATG,PTALCODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,DUPAD950
          MATCH     ANSD,TCINDC7
          IF        @EQUAL
            MOVE      ONE,F1
          ENDIF
          GOTO      DUPAD950
.
DUPAD950  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             F1,"|",TDESC:
                             "</RETURN_VALUE>"
          GOTO      DUPAD998
.
DUPAD998  CALL      XMLEND00
DUPAD999  RETURN
.
.------------------------------------------------------------
. Get Extract Last Run Date
.------------------------------------------------------------
EXTDAT00  CALL      XMLHED00
          BRANCH    EXIT,EXTDAT99
.
EXTDAT10  MOVE      SP70,DISPDATE
          MOVE      SP70,DISPDAT2
          MOVE      VALDCODE,KEY8                * Program Name
.
          PACK      KEY27,VALDHOSP,KEY8,Z70
          CALL      RSPMWAE1
          CALL      RPPMWAE1
          BRANCH    OVRCD,EXTDAT80
.
          MATCH     VALDHOSP,PMWAHOSP
          GOTO      EXTDAT80 IF NOT EQUAL
.
          MATCH     KEY8,PMWAPROG
          GOTO      EXTDAT80 IF NOT EQUAL
.
          UNPACK    PMWASDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          UNPACK    PMWAEDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDAT2,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
EXTDAT80  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             DISPDATE,"|",DISPDAT2,"|":
                             "</RETURN_VALUE>"
.
EXTDAT98  CALL      XMLEND00
EXTDAT99  RETURN
.
.------------------------------------------------------------
. Output select options for selected category code for a 
. given hospital
.------------------------------------------------------------
SELCOD00  CALL      XMLHED00
          BRANCH    EXIT,SELCOD99
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";

          PACK      KEY2,VALDCODE,SP70
          PACK      PTCDKEY2,KEY2,SP70
          CALL      RDSCODE2
SELCOD10  CALL      RDKCODE2
          BRANCH    OVRCD,SELCOD19
          MATCH     KEY2,TCODE
          GOTO      SELCOD19 IF NOT EQUAL
          MATCH     ACODE,SP70
          GOTO      SELCOD10 IF EQUAL
.
          MATCH     "Y",SHOWIACT
          GOTO      SELCOD12 IF EQUAL
. 
          MATCH     "I",PTCOACTV
          GOTO      SELCOD10 IF EQUAL
.
SELCOD12  MATCH     SP70,VALDHOSP
          IF        !@EQUAL
            MATCH    "1",PTCDHOSS
            IF       @EQUAL
              PACK      KEY8,VALDHOSP,TCODE,ACODE,SP70
              CALL      RDMLCOD1
              BRANCH    OVRCD,SELCOD10
            ENDIF
          ENDIF
.
          PACK      KEY15,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5:
                          TCINDC6,TCINDC7,TCINDC8,TCINDC9,TCINDC10:
                          TCINDC11,THCSCOD
.
          IF        RETURNFM=1
            PACK      KEY20,ACODE,KEY15,SP70
          ELSE
            PACK      KEY20,QUOTE,ACODE,KEY15,QUOTE
          ENDIF
.
          MATCH     "Y",SHOWLDSC
          IF        @EQUAL
            WRITE     HTMLFILE;KEY20,",",PTCDLDES,"|";
          ELSE  
            WRITE     HTMLFILE;KEY20,",",TDESC,"|";
          ENDIF
          GOTO      SELCOD10
.
SELCOD19  WRITE     HTMLFILE;"</RETURN_VALUE>"
          GOTO      SELCOD98
.
SELCOD90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid ??? - ":
                             VALDCODE,"</RETURN_VALUE>"
          GOTO      SELCOD98
.
SELCOD91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid User Id - ":
                             USERID,"</RETURN_VALUE>"
          GOTO      SELCOD98
.
SELCOD98  CALL      XMLEND00
SELCOD99  RETURN
+
..------------------------------------------------------------
.. Output select options for mental health doctor
..------------------------------------------------------------
.SELMHT00  CALL      XMLHED00
.          BRANCH    EXIT,SELMHT99
..
.          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
..
.          MOVE      VALDCODE,DIM10
.          PACK      KEY20,DIM10,SP70
.          CALL      RSALCTM2
.SELMHT10  CALL      RKALCTM2             
.          BRANCH    OVRCD,SELMHT50
..
.          MATCH     DIM10,ALCTHCPC          * same hcp?
.          GOTO      SELMHT50 IF NOT EQUAL
..
.          PACK      KEY10,ALCTTEAM,SP70
.          CALL      RDALCAS1
.          BRANCH    OVRCD,SELMHT10
..
.          IF        IBCNMHOS=1
.            PACK      KEY10,USERID,SP70
.            CALL      RDWBSE1
.            IF        OVRCD=1
.              MOVE      SP70,WBSEHOSP
.            ENDIF
..
.            MATCH     WBSEHOSP,ALCAHOSP
.            GOTO      SELMHT10 IF NOT EQUAL
..
.          ENDIF
..
.          PACK      KEY20,ALCADESC,SP70
.          PACK      KEY10,ALCATEAM,SP70
..
.          WRITE     HTMLFILE;KEY10,",",KEY20,"|";
.          GOTO      SELMHT10
..
.SELMHT50  WRITE     HTMLFILE;"</RETURN_VALUE>"
.          GOTO      SELMHT98
..
.SELMHT90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
.                             "Invalid ??? - ":
.                             VALDCODE,"</RETURN_VALUE>"
.          GOTO      SELMHT98
..
.SELMHT98  CALL      XMLEND00
.SELMHT99  RETURN
+
.---------------------------------------------------------------
. Selection list for Teams attached to a mental health doctor
.---------------------------------------------------------------
SELMHT00  CALL      XMLHED00
          BRANCH    EXIT,SELMHT99
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
.
          IF        IBCNMHOS=1
            PACK      KEY10,USERID,SP70
            CALL      RDWBSE1
            IF        OVRCD=1
              MOVE      SP70,WBSEHOSP
            ENDIF
          ENDIF
.
          PACK      KEY10,VALDCODE,SP70
          MATCH     SP70,KEY10
          GOTO      SELMHT90 IF EQUAL
.
          PACK      KEY21,KEY10,WBSEHOSP,SP70
          CALL      RSPMTMD1
SELMHT25  CALL      RKPMTMD1
          BRANCH    OVRCD,SELMHT90
.
          MATCH     VALDCODE,PMTDDOCT
          GOTO      SELMHT90 IF NOT EQUAL   * same hcp?
.
          IF        IBCNMHOS=1 
            MATCH     WBSEHOSP,PMTDHOSP
            GOTO      SELMHT90 IF NOT EQUAL   * same hosp?
          ENDIF
.
          MATCH     "1",PMTDACTV
          GOTO      SELMHT25 IF EQUAL       * team link inactive?
.
          PACK      KEY5,PMTDTEAM,SP70
          CALL      RDPMTEM1                * read team table for desc
          BRANCH    OVRCD,SELMHT25
.
          MATCH     "1",PMTMACTV
          GOTO      SELMHT25 IF EQUAL       * team inactive?
.
          WRITE     HTMLFILE;PMTMTEAM,",",PMTMDESC,"|";
          GOTO      SELMHT25
.
SELMHT90  WRITE     HTMLFILE;"</RETURN_VALUE>"
          GOTO      SELMHT98
.
SELMHT98  CALL      XMLEND00
SELMHT99  RETURN
+
.------------------------------------------------------------
. Calculate the number of financial periods between 
. from and to date (PATDRGFD)
.------------------------------------------------------------
CALPRD00  CALL      XMLHED00
          BRANCH    EXIT,CALPRD99
.
          MOVE      ZERO,NUMBPERD
.
          PACK      KEY6,PERIODFR,SP70
          CALL      RDSDRGA1
CALPRD10  CALL      RDKDRGA1
          BRANCH    OVRCD,CALPRD70
.
          PACK      TEMPDATE,DRGYR,DRGNUM
          REP       " 0",TEMPDATE
.
          ADD       ONE,NUMBPERD
.
          MATCH     TEMPDATE,PERIODTO
          GOTO      CALPRD80 IF LESS
          GOTO      CALPRD10
.
CALPRD70  ADD       ONE,NUMBPERD
.
CALPRD80  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             NUMBPERD:
                             "</RETURN_VALUE>"
          GOTO      CALPRD98
.
CALPRD98  CALL      XMLEND00
CALPRD99  RETURN
+
.------------------------------------------------------------
. Output type of visit based on a visit number
.------------------------------------------------------------
OUTVTD00  CALL      XMLHED00
          BRANCH    EXIT,OUTVTD99
.
          MOVE      SP70,VISTTYPE
          PACK      KEY8,VALDCODE,SP70
          CALL      RDVISA1
          BRANCH    OVRCD,OUTVTD10
.
          MATCH     " 1",PTVITYPE
          IF        @EQUAL
            MOVE      "EMR",VISTTYPE
            GOTO      OUTVTD80
          ENDIF
          MATCH     " 2",PTVITYPE
          IF        @EQUAL
            MOVE      "OUT",VISTTYPE
            GOTO      OUTVTD80
          ENDIF
          MATCH     " 3",PTVITYPE
          IF        @EQUAL
            MOVE      "INP",VISTTYPE
            GOTO      OUTVTD80
          ENDIF
          MATCH     "10",PTVITYPE
          IF        @EQUAL
            MOVE      "AH ",VISTTYPE
            GOTO      OUTVTD80
          ENDIF
          GOTO      OUTVTD80
.
OUTVTD10  PACK      KEY8,VALDCODE,SP70
          CALL      RDBKREC1
          BRANCH    OVRCD,OUTVTD20
.
          MOVE      "BOK",VISTTYPE
          GOTO      OUTVTD80
.
OUTVTD20  PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      SP70,WBSESIT
          ENDIF
.
          MOVE      WBSESIT,KEY6
          CALL      RDSITA1
          BRANCH    OVRCD,OUTVTD80
.
          PACK      CFNAME,OSTFILE,FILBOKA6  * Get the name of the BOKA3 file
          CLOSE     OUTBOKA6
          OPEN      OUTBOKA6,CFNAME
.
          PACK      KEY36,VALDCODE,SP70
          CALL      RDSBOKA6                     * position on visit number
          CALL      RDKBOKA6                     * read next record
          BRANCH    OVRCD,OUTVTD80               * eof - finished
.
          MATCH     DOBAOUTN,VALDCODE            * same visit number ?
          GOTO      OUTVTD80 IF NOT EQUAL        * no - get next O/P record
.
          MOVE      "OUT",VISTTYPE
          GOTO      OUTVTD80
.
OUTVTD80  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             VISTTYPE:
                             "</RETURN_VALUE>"
          GOTO      OUTVTD98
.
OUTVTD98  CALL      XMLEND00
OUTVTD99  RETURN
+
.------------------------------------------------------------
. Output Allied Health Problems by department
.------------------------------------------------------------
SELAPR00  CALL      XMLHED00
          BRANCH    EXIT,SELAPR99
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
.
          PACK      VALDCODE,VALDCODE,SP70
.
          PACK      KEY52,VALDCODE,SP70
          CALL      RSALPRR2                * positional read
SELAPR10  CALL      RKALPRR2                * read a record
          BRANCH    OVRCD,SELAPR90
.
          MATCH     ALPRDEPT,VALDCODE
          GOTO      SELAPR90 IF NOT EQUAL
.
          MATCH     "1",ALPRACTV            * Only display active codes
          GOTO      SELAPR10 IF NOT EQUAL
.
          MATCH     "2",ALPROTHR            * Don't display other factors
          GOTO      SELAPR10 IF EQUAL
.
          WRITE     HTMLFILE;ALPRPROB,",",ALPRDESC,"|";
.
          GOTO      SELAPR10
.
SELAPR90  WRITE     HTMLFILE;"</RETURN_VALUE>"
          CALL      XMLEND00
.
SELAPR99  RETURN
+
.------------------------------------------------------------
. Output Allied Health Default Problem by department
.------------------------------------------------------------
DEFAPR00  CALL      XMLHED00
          BRANCH    EXIT,DEFAPR99
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
.
          PACK      VALDCODE,VALDCODE,SP70
.
          PACK      KEY52,VALDCODE,SP70
          CALL      RSALPRR2                * positional read
DEFAPR10  CALL      RKALPRR2                * read a record
          BRANCH    OVRCD,DEFAPR90
.
          MATCH     ALPRDEPT,VALDCODE
          GOTO      DEFAPR90 IF NOT EQUAL
.
          MATCH     "1",ALPRACTV            * Only display active codes
          GOTO      DEFAPR10 IF NOT EQUAL
.
          MATCH     "1",ALPRDFCD            * default code
          GOTO      DEFAPR10 IF NOT EQUAL
.
          WRITE     HTMLFILE;ALPRPROB,"|";
.
DEFAPR90  WRITE     HTMLFILE;"</RETURN_VALUE>"
          CALL      XMLEND00
.
DEFAPR99  RETURN
+
.------------------------------------------------------------------------------
. gets a list of patcodes based on valdcode 
.------------------------------------------------------------------------------
.
GTCATL00  CALL      XMLHED00
          BRANCH    EXIT,GTCATL99
.
          MOVE      ZERO,LINKVTYP           * Display all visit types (Cat CV)
.
          MATCH     SP70,VALDSITE           * Outpatients cat CV only
          GOTO      GTCATL05 IF EQUAL
.
          MATCH     SP70,VALDCTYP           * Outpatients cat CV only
          GOTO      GTCATL05 IF EQUAL
.
          PACK      KEY15,VALDSITE,VALDCTYP,SP70
          CALL      RSOTCVT1
          CALL      RKOTCVT1                * Check the clinic type for
          BRANCH    OVRCD,GTCATL05          * linked visit types
.
          MATCH     VALDSITE,OCVTSITE       * Same Site
          GOTO      GTCATL05 IF NOT EQUAL
.
          MATCH     VALDCTYP,OCVTCTYP       * Same Clinic Type
          GOTO      GTCATL05 IF NOT EQUAL
.
          MOVE      ONE,LINKVTYP            * Only display linked visit types 
.
GTCATL05  IF        IBCNMHOS=1
            PACK      KEY10,USERID,SP70
            CALL      RDWBSE1
            BRANCH    OVRCD,GTCATL90
          ENDIF   
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
          WRITE     HTMLFILE;"["
.
          PACK      PTCDKEY2,VALDCODE,SP70
          CALL      RDSCODE2
GTCATL10  CALL      RDKCODE2 
          BRANCH    OVRCD,GTCATL98
.
          MATCH     TCODE,VALDCODE
          GOTO      GTCATL98 IF NOT EQUAL
.
          MATCH     SP70,ACODE              * Skip category master record
          GOTO      GTCATL10 IF EQUAL
.
          MATCH     "I",PTCOACTV
          GOTO      GTCATL10 IF EQUAL
.
          IF        LINKVTYP=1
            PACK      KEY15,VALDSITE,VALDCTYP,ACODE,SP70
            CALL      RDOTCVT1          * Only display linked visit types
            BRANCH    OVRCD,GTCATL10
          ENDIF
.
          IF        IBCNMHOS=1
            MATCH    "1",PTCDHOSS
            IF       @EQUAL  
              MATCH    SP70,ACODE
              IF       !@EQUAL 
                PACK     KEY8,WBSEHOSP,TCODE,ACODE,SP70
                CALL     RDMLCOD1
                BRANCH   OVRCD,GTCATL10
              ENDIF
            ENDIF
          ENDIF
.
          PACK      KEY11,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5:
                          TCINDC6,TCINDC7,TCINDC8,TCINDC9,TCINDC10:
                          TCINDC11
.
          WRITE     HTMLFILE;"{tdesc:#"",TDESC,"#",":
                             "acode:#"",ACODE,"#",":
                             "indicators:#"",KEY11,"#",":
                             "thcsod:#"",THCSCOD,"#",":
                             "tcform6:#"",TCFORM6,"#"},"
.
          GOTO      GTCATL10
.
GTCATL90  WRITE     HTMLFILE;"{error:":
                             "#"Invalid User Id - ":
                             USERID,"#"}"
          GOTO      GTCATL98
.
GTCATL98  WRITE     HTMLFILE;"]</RETURN_VALUE>"
          CALL      XMLEND00
.
GTCATL99  RETURN
+
.------------------------------------------------------------
. Select Category CT options with valid hospital links
.------------------------------------------------------------
.SELCCT00  CALL      XMLHED00
.          BRANCH    EXIT,SELCCT99
.
.          PACK      VALDCODE,VALDCODE,SP70
.
.          MATCH     SP70,VALDCODE
.          GOTO      SELCCT80 IF EQUAL
.          GOTO      SELCCT80 IF EOS
.
.          PACK      KEY5,ANSC,ANST,VALDCODE,SP70
.          CALL      RDCODE1
.          BRANCH    OVRCD,SELCCT90
.
.          MATCH     "1",PTCDHOSS
.          GOTO      SELCCT80 IF NOT EQUAL
.
.SELCCT10  COMPARE   ONE,IBCNMHOS
.          GOTO      SELCCT80 IF NOT EQUAL
.
.          PACK      KEY10,USERID,SP70
.          CALL      RDWBSE1
.          BRANCH    OVRCD,SELCCT80
.
.          PACK      KEY8,WBSEHOSP,ANSC,ANST,VALDCODE,SP70
.          CALL      RDMLCOD1          
.          BRANCH    OVRCD,SELCCT90
.
.SELCCT80  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
.                             ONE:
.                             "</RETURN_VALUE>"
.          GOTO      SELCCT98
.
.SELCCT90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
.                             ZERO:
.                             "</RETURN_VALUE>"
.          GOTO      SELCCT98
.
.SELCCT98  CALL      XMLEND00
.SELCCT99  RETURN
+
.------------------------------------------------------------
. Select Category CT options with valid hospital links
.------------------------------------------------------------
SELCCT00  CALL      XMLHED00
          BRANCH    EXIT,SELCCT99
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
.
          COMPARE   ONE,IBCNMHOS
          GOTO      SELCCT90 IF NOT EQUAL          
.
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,SELCCT90
.
          PACK      KEY5,ANSC,ANST,SP70
          CALL      RDSCODE1
SELCCT25  CALL      RDKCODE1
          BRANCH    OVRCD,SELCCT90
.
          MATCH     "CT",TCODE
          GOTO      SELCCT90 IF NOT EQUAL
.
          MATCH     "1",PTCDHOSS
          GOTO      SELCCT50 IF NOT EQUAL
.
          PACK      KEY8,WBSEHOSP,ANSC,ANST,ACODE,SP70
          CALL      RDMLCOD1
          BRANCH    OVRCD,SELCCT25          
.
SELCCT50  WRITE     HTMLFILE;ACODE,"|"; 
.
          GOTO      SELCCT25
.
SELCCT90  WRITE     HTMLFILE;"</RETURN_VALUE>"
          GOTO      SELCCT98
.
SELCCT98  CALL      XMLEND00
SELCCT99  RETURN
+
.----------------------------------------------------------
. Selection list for EMR sites for specific hospital
.----------------------------------------------------------
SELSIT00  CALL      XMLHED00
          BRANCH    EXIT,SELSIT99
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
.
          PACK      KEY3,SP70
          CALL      RSEMSIT1
SELSIT25  CALL      RKEMSIT1
          BRANCH    OVRCD,SELSIT90
.
          MATCH     SP3,VALDCODE
          IF        !@EQUAL
            MATCH     VALDCODE,EMSTHSNO
            GOTO      SELSIT25 IF NOT EQUAL        * same hosp?
          ENDIF
.
          WRITE     HTMLFILE;EMSTSCOD,EMSTACTV,",",EMSTDESC,"|";
          GOTO      SELSIT25
.
SELSIT90  WRITE     HTMLFILE;"</RETURN_VALUE>"
          GOTO      SELSIT98
.
SELSIT98  CALL      XMLEND00
SELSIT99  RETURN
+
.----------------------------------------------------------
. Selection list for printer departments for specific hospital
.----------------------------------------------------------
SELDEP00  CALL      XMLHED00
          BRANCH    EXIT,SELDEP99
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
.
          PACK      KEY6,SP70
          CALL      RSIBDPT1
SELDEP25  CALL      RKIBDPT1
          BRANCH    OVRCD,SELDEP90
.
          MATCH     SP3,VALDCODE
          IF        !@EQUAL
            MATCH     VALDCODE,IBDPHOSP
            GOTO      SELDEP25 IF NOT EQUAL        * same hosp?
          ENDIF
.
          WRITE     HTMLFILE;IBDPDEPT,",",IBDPDESC,"|";
          GOTO      SELDEP25
.
SELDEP90  WRITE     HTMLFILE;"</RETURN_VALUE>"
          GOTO      SELDEP98
.
SELDEP98  CALL      XMLEND00
SELDEP99  RETURN
+
.----------------------------------------------------------
. Get default ward/site/dept for specific user id/hospital
.----------------------------------------------------------
GTDWSD00  CALL      XMLHED00
          BRANCH    EXIT,GTDWSD99
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
.
          MATCH     SP3,VALDCODE
          GOTO      GTDWSD90 IF EQUAL
.
          PACK      KEY13,USERID,VALDCODE,SP70
          CALL      RDWBHSP1
          BRANCH    OVRCD,GTDWSD90
.
          WRITE     HTMLFILE;WBHOWARD,"|",WBHOSITE,"|",WBHOPRIN,"|";
.
GTDWSD90  WRITE     HTMLFILE;"</RETURN_VALUE>"
          GOTO      GTDWSD98
.
GTDWSD98  CALL      XMLEND00
GTDWSD99  RETURN
+
.------------------------------------------------------------
. Check if emergency bed type for entire inpatient episode
.------------------------------------------------------------
CEMRBT00  CALL      XMLHED00
          BRANCH    EXIT,CEMRBT99
.
          MOVE      ZERO,EMRBFLAG           * default to EMR bed type = no
          PACK      KEY30,ADMISSNO,SP70
          CALL      RDSTRAN2
CEMRBT10  CALL      RDKTRAN2
          BRANCH    OVRCD,CEMRBT90
.
          MATCH     ADMISSNO,DTADMN
          GOTO      CEMRBT90 IF NOT EQUAL
.
          MATCH     SP70,TRBTYP
          GOTO      CEMRBT90 IF EQUAL
.
          PACK      KEY5,ANSB,ANST,TRBTYP,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CEMRBT90
.
.         MATCH     ANSE,TCINDC11
.         IF        @EQUAL
.           MOVE      ONE,EMRBFLAG          * EMR bed type = yes, so continue
.           GOTO      CEMRBT10
.         ELSE
.           MOVE      ZERO,EMRBFLAG         * EMR bed type = no, so exit
.           GOTO      CEMRBT90
.         ENDIF
.
          MATCH     ANSE,TCINDC11
          IF        @EQUAL
            MATCH    "6",THCSCOD
            IF       @EQUAL
              MOVE      ONE,EMRBFLAG          * EMR bed type = yes, so continue
              GOTO      CEMRBT10
            ELSE
              GOTO      CEMRBT80
            ENDIF
          ELSE
CEMRBT80    MOVE      ZERO,EMRBFLAG         * EMR bed type = no, so exit
            GOTO      CEMRBT90
          ENDIF
.
CEMRBT90  COMPARE   ONE,EMRBFLAG
          GOTO      CEMRBT98 IF NOT EQUAL
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Please cancel admission. ":
                             "Patient has been in an Emergency Bed Type Only. ":
                             "</RETURN_VALUE>"
.
CEMRBT98  CALL      XMLEND00
CEMRBT99  RETURN
+
.------------------------------------------------------------
. Operation Averages - Calculate Minutes
.------------------------------------------------------------
OPRAV100  CALL      XMLHED00
          BRANCH    EXIT,OPRAV199
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
.
          PACK      VALDCODE,VALDCODE,SP70
          PACK      VALDCOD2,VALDCOD2,SP70
          PACK      VALDCOD3,VALDCOD3,SP70
.
          MOVE      SP70,KEY1
          MOVE      SP70,KEY6
          MOVE      SP70,KEY9
.
          MOVE      ZERO,FORM10
          MOVE      SP70,DIM10
.
          MATCH     SP70,VALDCODE
          GOTO      OPRAV180 IF EQUAL
          GOTO      OPRAV180 IF EOS
.
          PACK      KEY9,VALDCODE,SP70
          PACK      KEY6,VALDCOD2,SP70
          PACK      KEY1,VALDCOD3,SP70
.
          PACK      KEY15,KEY9,KEY6,SP70
          CALL      RDOPAVE1
          BRANCH    OVRCD,OPRAV140
.
          GOTO      OPRAV150
.
OPRAV140  PACK      KEY15,KEY9,SP70
          CALL      RDOPAVE1
          BRANCH    OVRCD,OPRAV180
.
.         MATCH     "1",KEY1
.         IF        @EQUAL
OPRAV150    MOVE      OPAVAVER,FORM10
.         ENDIF
.
.         MATCH     "2",KEY1
.         IF        @EQUAL
.           ASSIGN    OPAVAVER*0.5,FORM10
.         ENDIF
.
.         MATCH     "3",KEY1
.         IF        @EQUAL
.           ASSIGN    OPAVAVER*0.25,FORM10
.         ENDIF
.
OPRAV180  MOVE      FORM10,DIM10
          LJUSTIFY  DIM10
          WRITE     HTMLFILE;DIM10;
.
OPRAV190  WRITE     HTMLFILE;"</RETURN_VALUE>"
          CALL      XMLEND00
.
OPRAV199  RETURN
.
.------------------------------------------------------------------------------
.  For each department in the given hospital code (VALDCODE): get the 
.  department name from patcodes (Cat CG).
.------------------------------------------------------------------------------
LUHSDP00  CALL      XMLHED00
          BRANCH    EXIT,LUHSDP99
.   
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
.
          MATCH     "1",ALCNDHOS                   * Hosp and dept not linked
          IF        @EQUAL
            MOVE      SP70,VALDCODE                * Hospital irrelevant
          ENDIF
.
          PACK      KEY6,VALDCODE,SP70
          CALL      RSALDEP2                   
LUHSDP10  CALL      RKALDEP2                       * Get next department
          BRANCH    OVRCD,LUHSDP90
.
          IF        IBCNMHOS=1
            MATCH     "1",ALCNDHOS                   
            IF        !@EQUAL
              MATCH     VALDCODE,ALDEHOSP
              GOTO      LUHSDP90 IF NOT EQUAL
            ENDIF
          ENDIF
.
          MATCH     "1",ALDEACTV
          GOTO      LUHSDP10 IF EQUAL              * Skip Inactive
.
          PACK      KEY5,ANSC,ANSG,ALDEDEPT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,LUHSDP10                 * Next deaprtment
.
          WRITE     HTMLFILE;ACODE,",",TDESC,"|";
          GOTO      LUHSDP10
.
LUHSDP90  WRITE     HTMLFILE;"</RETURN_VALUE>"
          CALL      XMLEND00
.
LUHSDP99  RETURN
.
.------------------------------------------------------------
. Validate Category A / Category CC / Age for WAHealth
.------------------------------------------------------------
VACTYP00  CALL      XMLHED00
          BRANCH    EXIT,VACTYP99
.
          MOVE      SP9,D9
.
VACTYP10  PACK      VALDCODE,VALDCODE,SP70       * Cat.CC
          MATCH     SP70,VALDCODE
          GOTO      VACTYP98 IF EQUAL
.
          MATCH     "DISCHARGE",VALDCODE
          GOTO      VACTYP20 IF EQUAL
.
          PACK      KEY5,ANSC,ANSC,VALDCODE,SP70      * Cat.CC
          CALL      RDCODE1
          BRANCH    OVRCD,VACTYP90
.
          MOVE      THCSCOD,CATCCHDP             * Cat.CC HDP
.
VACTYP20  PACK      VALDCOD2,VALDCOD2,SP70       * Cat.A
          MATCH     SP70,VALDCOD2
          GOTO      VACTYP98 IF EQUAL
.
          PACK      KEY5,ANSA,SP1,VALDCOD2,SP70       * Cat.A
          CALL      RDCODE1
          BRANCH    OVRCD,VACTYP90
.
          MOVE      THCSCOD,CATAHDP              * Cat.A HDP
          MOVE      THCSCOD,CATAHDP2             * Cat.A HDP
.
          PACK      VALDCOD3,VALDCOD3,SP70       * UR Number
          MATCH     SP70,VALDCOD3
          IF        !@EQUAL
            PACK      KEY8,VALDCOD3,SP70
            CALL      RDMAST1                    * get birth date
            BRANCH    OVRCD,VACTYP91
.
            PACK      VALDDATE,VALDDATE,SP70     * admission/disch date
            MATCH     SP70,VALDDATE
            IF        !@EQUAL
              MOVE      VALDDATE,AGEDATE
              CALL      CALCAGE                  * get age at adm/disch date
              IF        PSAGEDAY > 9
                MATCH     "DISCHARGE",VALDCODE
                GOTO      VACTYP92 IF EQUAL      * discharge edit
                MATCH     "10",CATAHDP2
                GOTO      VACTYP91 IF EQUAL
                MATCH     "1",CATAHDP
                GOTO      VACTYP91 IF EQUAL
                MATCH     "2",CATAHDP
                GOTO      VACTYP91 IF EQUAL
                MATCH     "9",CATAHDP
                GOTO      VACTYP91 IF EQUAL
                MATCH     "26",CATCCHDP
                GOTO      VACTYP91 IF EQUAL
              ELSE
                MATCH     "DISCHARGE",VALDCODE
                GOTO      VACTYP98 IF EQUAL      * no discharge edit
                MATCH     "10",CATAHDP2
                GOTO      VACTYP38 IF EQUAL
                MATCH     "1",CATAHDP
                GOTO      VACTYP38 IF EQUAL
                MATCH     "2",CATAHDP
                GOTO      VACTYP38 IF EQUAL
                MATCH     "9",CATAHDP
                GOTO      VACTYP38 IF EQUAL
                GOTO      VACTYP91 IF NOT EQUAL
.
VACTYP38        MATCH     "26",CATCCHDP
                GOTO      VACTYP91 IF NOT EQUAL
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     "21",CATCCHDP
          IF        @EQUAL
            MOVE      "056",D9              * Cat.A options
            SCAN      CATAHDP,D9
            GOTO      VACTYP98 IF EQUAL
          ENDIF
          MATCH     "22",CATCCHDP
          IF        @EQUAL
            MOVE      "056",D9              * Cat.A options
            SCAN      CATAHDP,D9
            GOTO      VACTYP98 IF EQUAL
          ENDIF
          MATCH     "23",CATCCHDP
          IF        @EQUAL
            MOVE      "056",D9              * Cat.A options
            SCAN      CATAHDP,D9
            GOTO      VACTYP98 IF EQUAL
          ENDIF
          MATCH     "24",CATCCHDP
          IF        @EQUAL
            MOVE      "056",D9              * Cat.A options
            SCAN      CATAHDP,D9
            GOTO      VACTYP98 IF EQUAL
          ENDIF
          MATCH     "25",CATCCHDP
          IF        @EQUAL
            MOVE      "0456",D9             * Cat.A options
            SCAN      CATAHDP,D9
            GOTO      VACTYP98 IF EQUAL
          ENDIF
          MATCH     "26",CATCCHDP
          IF        @EQUAL
            MATCH     "10",CATAHDP2
            GOTO      VACTYP98 IF EQUAL
            MOVE      "0129",D9             * Cat.A options
            SCAN      CATAHDP,D9
            GOTO      VACTYP98 IF EQUAL
          ENDIF
          MATCH     "27",CATCCHDP
          IF        @EQUAL
            MOVE      "7",D9                * Cat.A options
            SCAN      CATAHDP,D9
            GOTO      VACTYP98 IF EQUAL
          ENDIF
          MATCH     "28",CATCCHDP
          IF        @EQUAL
            MOVE      "3",D9                * Cat.A options
            SCAN      CATAHDP,D9
            GOTO      VACTYP98 IF EQUAL
          ENDIF
          MATCH     "29",CATCCHDP
          IF        @EQUAL
            MOVE      "056",D9              * Cat.A options
            SCAN      CATAHDP,D9
            GOTO      VACTYP98 IF EQUAL
          ENDIF
          MATCH     "30",CATCCHDP
          IF        @EQUAL
            MOVE      "8",D9                * Cat.A options
            SCAN      CATAHDP,D9
            GOTO      VACTYP98 IF EQUAL
          ENDIF
          MATCH     "31",CATCCHDP
          IF        @EQUAL
            MOVE      "8",D9                * Cat.A options
            SCAN      CATAHDP,D9
            GOTO      VACTYP98 IF EQUAL
          ENDIF
.          MATCH     "32",CATCCHDP
.          IF        @EQUAL
.            MOVE      "6",D9                * Cat.A options
.            SCAN      CATAHDP,D9
.            GOTO      VACTYP98 IF EQUAL
.          ENDIF
          MATCH     "32",CATCCHDP
          IF        @EQUAL
            MOVE      "056",D9              * Cat.A options
            SCAN      CATAHDP,D9
            GOTO      VACTYP98 IF EQUAL
          ENDIF
          MATCH     "33",CATCCHDP
          IF        @EQUAL
            MOVE      "056",D9              * Cat.A options
            SCAN      CATAHDP,D9
            GOTO      VACTYP98 IF EQUAL
          ENDIF
.
VACTYP90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Care Type / Patient Type combination.":
                             "</RETURN_VALUE>"
          GOTO      VACTYP98
.
VACTYP91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Patient Type or Care Type is invalid for age ":
                             "of patient. Please update.":
                             "</RETURN_VALUE>"
          GOTO      VACTYP98
.
VACTYP92  MATCH     "2",CATAHDP
          GOTO      VACTYP98 IF NOT EQUAL        * cannot be unqualified baby
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Newborn is greater than 9 days of age. ":
                             "Please update to Qualified Newborn or Boarder.":
                             "</RETURN_VALUE>"
.
VACTYP98  CALL      XMLEND00
VACTYP99  RETURN
+
.------------------------------------------------------------
. Validate Category BT / Category CG for WAHealth rehab
.------------------------------------------------------------
VAREHB00  CALL      XMLHED00
          BRANCH    EXIT,VAREHB99
.
VAREHB10  PACK      VALDCODE,VALDCODE,SP70       * Cat.CC
          MATCH     SP70,VALDCODE
          GOTO      VAREHB98 IF EQUAL
.
          PACK      KEY5,ANSC,ANSC,VALDCODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,VAREHB98
.
          MOVE      THCSCOD,CATCCHDP             * Cat.CC HDP
.
          PACK      VALDCOD2,VALDCOD2,SP70       * Ward
          MATCH     SP70,VALDCOD2
          GOTO      VAREHB98 IF EQUAL
.
          PACK      KEY6,VALDCOD2,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,VAREHB98
.
          MATCH     SP70,WCLASS
          GOTO      VAREHB98 IF EQUAL
.
          PACK      KEY5,ANSC,ANSG,WCLASS,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,VAREHB98
.
          MOVE      TCINDC12,CATCGI12            * Cat.CG INDC12
.
          PACK      VALDCOD3,VALDCOD3,SP70       * Bed
.davvy    MATCH     SP70,VALDCOD3
.davvy    GOTO      VAREHB98 IF EQUAL
.
          MOVE      VALDCOD2,KEY3
          PACK      KEY6,KEY3,VALDCOD3,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,VAREHB98
.
          MATCH     SP70,WEFRBT
          GOTO      VAREHB98 IF EQUAL
.
          PACK      KEY5,ANSB,ANST,WEFRBT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,VAREHB98
.
          MOVE      THCSCOD,CATBTHDP            * Cat.BT HDP
.
          MATCH     "R",CATCGI12
          GOTO      VAREHB98 IF NOT EQUAL
.
          MATCH     "HIH",CATBTHDP
          GOTO      VAREHB98 IF NOT EQUAL
.
          MATCH     "22",CATCCHDP                * Care type should be 22
          GOTO      VAREHB98 IF EQUAL
.
VAREHB90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=WARNING>":
                             "Care Type should be Rehabilitation when in RITH ":
                             "ward. Select OK to progress admission, select ":
                             "Cancel to return to admission screen to update ":
                             "Care Type/Ward.":
                             "</RETURN_VALUE>"
          GOTO      VAREHB98
.
VAREHB98  CALL      XMLEND00
VAREHB99  RETURN
+
.------------------------------------------------------------
. Validate Category KD for WAHealth
.------------------------------------------------------------
VAEMPL00  CALL      XMLHED00
          BRANCH    EXIT,VAEMPL99
.
VAEMPL10  PACK      VALDCODE,VALDCODE,SP70       * Cat.KD
          MATCH     SP70,VALDCODE
          GOTO      VAEMPL98 IF EQUAL
.
          PACK      KEY5,ANSK,ANSD,VALDCODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,VAEMPL98
.
          MOVE      THCSCOD,CATKDHDP             * Cat.KD HDP
.
          PACK      VALDCOD2,VALDCOD2,SP70       * UR Number
          MATCH     SP70,VALDCOD2
          GOTO      VAEMPL98 IF EQUAL
.
          PACK      KEY8,VALDCOD2,SP70
          CALL      RDMAST1                      * get birth date
          BRANCH    OVRCD,VAEMPL98
.
          PACK      VALDDATE,VALDDATE,SP70       * admission date
          MATCH     SP70,VALDDATE
          GOTO      VAEMPL98 IF EQUAL
.
          MOVE      VALDDATE,AGEDATE
          CALL      CALCAGE                      * get age at admission date
          IF        PSAGEYRS < 6
            MATCH     "1",CATKDHDP
            GOTO      VAEMPL90 IF NOT EQUAL
          ENDIF
          IF        PSAGEYRS < 15
            MATCH     "1",CATKDHDP
            GOTO      VAEMPL98 IF EQUAL
            MATCH     "2",CATKDHDP
            GOTO      VAEMPL91 IF NOT EQUAL
          ENDIF
.
          GOTO      VAEMPL98
.
VAEMPL90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=WARNING>":
                             "Invalid Employment Status for child < 6 years, ":
                             "please review.":
                             "</RETURN_VALUE>"
          GOTO      VAEMPL98
.
VAEMPL91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=WARNING>":
                             "Invalid Employment Status for child < 15 years, ":
                             "please review.":
                             "</RETURN_VALUE>"
          GOTO      VAEMPL98
.
VAEMPL98  CALL      XMLEND00
VAEMPL99  RETURN
+
.-------------------------------------------------------------
. Validate Cat CL and Wait List / Ambulatory Ward for WAHealth
.-------------------------------------------------------------
VACLWD00  CALL      XMLHED00
          BRANCH    EXIT,VACLWD99
.
VACLWD10  PACK      VALDCODE,VALDCODE,SP70       * Ward
          MATCH     SP70,VALDCODE
          GOTO      VACLWD98 IF EQUAL
.
          MATCH     "ONLEAVE",VALDCODE           * check for onleave transfer
          GOTO      VACLWD30 IF EQUAL
.
          MATCH     "DISCHARGE",VALDCODE         * check for discharge
          GOTO      VACLWD30 IF EQUAL
.
          PACK      KEY6,VALDCODE,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,VACLWD98
.
          PACK      KEY5,ANSB,ANST,WEFRBT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,VACLWD98
.
          MOVE      THCSCOD,CATBTHDP             * Cat.BT HDP
.
          MATCH     "AMB",CATBTHDP
          GOTO      VACLWD30 IF NOT EQUAL
.
VACLWD20  PACK      VALDCOD2,VALDCOD2,SP70       * Admissno
          MATCH     SP70,VALDCOD2
          GOTO      VACLWD92 IF EQUAL
.
          MATCH     "TRANSFER",VALDCOD2
          GOTO      VACLWD30 IF EQUAL            * this is a bed transfer
.
          PACK      KEY8,VALDCOD2,SP70
          CALL      RDBKREC1                     * AMB ward must have a WL proc
          BRANCH    OVRCD,VACLWD92
.
          MATCH     SP70,BKREPROC
          GOTO      VACLWD92 IF EQUAL
.
          MATCH     SP70,DBKRECNT
          GOTO      VACLWD92 IF EQUAL
.
VACLWD30  PACK      VALDCOD3,VALDCOD3,SP70       * Cat.CL
          MATCH     SP70,VALDCOD3
          GOTO      VACLWD98 IF EQUAL
.
          PACK      KEY5,ANSC,ANSL,VALDCOD3,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,VACLWD98
.
          MOVE      THCSCOD,CATCLHDP             * Cat.CL HDP
.
          MATCH     "DISCHARGE",VALDCODE
          GOTO      VACLWD40 IF EQUAL            * discharge validations
.
          MATCH     "33",CATCLHDP
          IF        @EQUAL
            MATCH     "ONLEAVE",VALDCODE
            GOTO      VACLWD93 IF EQUAL          * AMB patient cannot go onleave
            MATCH     "AMB",CATBTHDP
            GOTO      VACLWD90 IF NOT EQUAL
          ELSE
            MATCH     "AMB",CATBTHDP
            GOTO      VACLWD91 IF EQUAL
          ENDIF
          GOTO      VACLWD98
.
VACLWD40  PACK      VALDCOD2,VALDCOD2,SP70       * Admissno
          MATCH     SP70,VALDCOD2
          GOTO      VACLWD98 IF EQUAL
.
          PACK      VALDDATE,VALDDATE,SP70       * discharge date
          MATCH     SP70,VALDDATE
          GOTO      VACLWD98 IF EQUAL
.
          PACK      VALDCOD4,VALDCOD4,SP70       * discharge dest
          MATCH     SP70,VALDCOD4
          GOTO      VACLWD98 IF EQUAL
.
          PACK      KEY5,ANSD,ANSD,VALDCOD4,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,VACLWD98
.
          MOVE      TCINDC1,CATDDI01             * Cat.DD indc.1
          MOVE      TCINDC5,CATDDI05             * Cat.DD indc.5
.
          MATCH     "D",CATDDI01
          GOTO      VACLWD96 IF EQUAL            * warn for deceased
.
          PACK      KEY8,VALDCOD2,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,VACLWD98
.
          MATCH     "33",CATCLHDP
          IF        @EQUAL
            MATCH     ADATE,VALDDATE
            GOTO      VACLWD94 IF NOT EQUAL      * must be sameday patient
            MATCH     "5",CATDDI05
            GOTO      VACLWD95 IF EQUAL          * cannot be statistical disch
          ENDIF
          GOTO      VACLWD98
.
VACLWD90  MATCH     "TRANSFER",VALDCOD2
          IF        @EQUAL
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Ward is invalid for Ambulatory Patient. ":
                             "Please amend.":
                             "</RETURN_VALUE>"
          ELSE
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Claim Type is invalid for Non-Ambulatory Ward. ":
                             "Please amend.":
                             "</RETURN_VALUE>"
          ENDIF
          GOTO      VACLWD98
.
VACLWD91  MATCH     "TRANSFER",VALDCOD2
          IF        @EQUAL
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Ward is invalid for Non-Ambulatory Patient. ":
                             "Please amend.":
                             "</RETURN_VALUE>"
          ELSE
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Claim Type is invalid for Ambulatory Ward. ":
                             "Please amend.":
                             "</RETURN_VALUE>"
          ENDIF
          GOTO      VACLWD98
.
VACLWD92  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Ambulatory patient cannot be directly admitted. ":
                             "If this is an ambulatory patient please admit ":
                             "from the waiting list. If this is not an ":
                             "ambulatory patient please amend ward details.":
                             "</RETURN_VALUE>"
          GOTO      VACLWD98
.
VACLWD93  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "On Leave is not allowed for Ambulatory Care ":
                             "patient.":
                             "</RETURN_VALUE>"
          GOTO      VACLWD98
.
VACLWD94  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Ambulatory Patients must be Same Day ":
                             "admissions. Please amend discharge date.":
                             "</RETURN_VALUE>"
          GOTO      VACLWD98
.
VACLWD95  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "An Ambulatory patient cannot be ":
                             "Statistical Discharged.":
                             "</RETURN_VALUE>"
          GOTO      VACLWD98
.
VACLWD96  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=WARNING>":
                             "Patient is being discharged as 'Deceased'. ":
                             "Please select OK to confirm or Cancel to change ":
                             "the Discharge Destination.":
                             "</RETURN_VALUE>"
          GOTO      VACLWD98
.
VACLWD98  CALL      XMLEND00
VACLWD99  RETURN
+
.-----------------------------------------------------------
. Validate transfer hospital / current hospital for WAHealth
.-----------------------------------------------------------
VATHSP00  CALL      XMLHED00
          BRANCH    EXIT,VATHSP99
.
VATHSP10  PACK      VALDCODE,VALDCODE,SP70       * Ward / hospital (disch)
          MATCH     SP70,VALDCODE
          GOTO      VATHSP98 IF EQUAL
.
          PACK      VALDCOD3,VALDCOD3,SP70       * Discharge ?
          MATCH     "DISCHARGE",VALDCOD3
          IF        @EQUAL
            PACK      KEY3,VALDCODE,SP70         * already have hosp
            GOTO      VATHSP15
          ENDIF
.
          PACK      KEY6,VALDCODE,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,VATHSP98
.
          PACK      KEY3,PTWDHOSN,SP70
VATHSP15  CALL      RDPTHSP1
          BRANCH    OVRCD,VATHSP98
.
          MATCH     SP70,PTHSAPPR
          GOTO      VATHSP98 IF EQUAL
.
VATHSP20  PACK      VALDCOD2,VALDCOD2,SP70       * Transfer Source Hospital
          MATCH     SP70,VALDCOD2
          GOTO      VATHSP98 IF EQUAL
.
          PACK      KEY5,VALDCOD2,SP70
          CALL      RDPTVAD1
          BRANCH    OVRCD,VATHSP98
.
          MATCH     PTVACODE,PTHSAPPR
          GOTO      VATHSP98 IF NOT EQUAL
.
VATHSP90  MATCH     "DISCHARGE",VALDCOD3
          IF        @EQUAL
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                               "Discharge To Hospital is the same as the ":
                               "current Hospital. Please review.":
                               "</RETURN_VALUE>"
          ELSE
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                               "Transferring Hospital cannot be the same as ":
                               "current Hospital. Please review.":
                               "</RETURN_VALUE>"
          ENDIF
          GOTO      VATHSP98
.
VATHSP98  CALL      XMLEND00
VATHSP99  RETURN
+
.------------------------------------------------------------
. Validate Age of Parent for WAHealth
.------------------------------------------------------------
VANEWB00  CALL      XMLHED00
          BRANCH    EXIT,VANEWB99
.
VANEWB10  PACK      VALDCODE,VALDCODE,SP70       * UR Number
          MATCH     SP70,VALDCODE
          GOTO      VANEWB98 IF EQUAL
.
          PACK      KEY8,VALDCODE,SP70
          CALL      RDMAST1                      * get birth date
          BRANCH    OVRCD,VANEWB98
.
          PACK      VALDDATE,VALDDATE,SP70       * admission date
          MATCH     SP70,VALDDATE
          GOTO      VANEWB98 IF EQUAL
.
          MOVE      VALDDATE,AGEDATE
          CALL      CALCAGE                      * get age at admission date
          IF        PSAGEYRS < 12
            GOTO      VANEWB90
          ENDIF
.
          GOTO      VANEWB98
.
VANEWB90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=WARNING>":
                             "Patient is less than 12 years old. Do you wish ":
                             "to Input Newborn from this patient? Select OK ":
                             "to admit newborn from this patient or ":
                             "Cancel":
                             "</RETURN_VALUE>"
          GOTO      VANEWB98
.
VANEWB98  CALL      XMLEND00
VANEWB99  RETURN
+
.------------------------------------------------------------
. Validate Mother/Baby link on discharge
.------------------------------------------------------------
VAMBLN00  CALL      XMLHED00
          BRANCH    EXIT,VAMBLN99
.
VAMBLN10  PACK      VALDCODE,VALDCODE,SP70       * Mother's UR Number
          MATCH     SP70,VALDCODE
          GOTO      VAMBLN98 IF EQUAL
.
          PACK      VALDCOD2,VALDCOD2,SP70       * Mother's hospital
          MATCH     SP70,VALDCOD2
          GOTO      VAMBLN98 IF EQUAL
.
          PACK      KEY16,VALDCODE,SP70
          CALL      RDSLINK1
VAMBLN20  CALL      RDKLINK1
          BRANCH    OVRCD,VAMBLN98
.
          MATCH     VALDCODE,LINKFUR             * Mothers U/R
          GOTO      VAMBLN98 IF NOT EQUAL
.
          PACK      KEY5,ANSL,ANSU,LINKREA,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,VAMBLN98
.
          MATCH     "M",TCINDC1                  * Mother baby link ?
          GOTO      VAMBLN20 IF NOT EQUAL
.
          PACK      KEY17,LINKTUR,TWO,SP70
          CALL      RSPTMI18
VAMBLN30  CALL      RKPTMI18
          BRANCH    OVRCD,VAMBLN20
.
          MATCH     LINKTUR,AURNO                * Linked U/R has current adm ?
          GOTO      VAMBLN20 IF NOT EQUAL
.
          MATCH     "2",DASTAT                   * Linked U/R has current adm ?
          GOTO      VAMBLN20 IF NOT EQUAL
.
          MATCH     VALDCOD2,PMVXMHOS
          GOTO      VAMBLN90 IF EQUAL            * same hospital ?
.
          GOTO      VAMBLN30
.
VAMBLN90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=WARNING>":
                             "This discharged patient has a mother child link":
                             " admission. Press OK to continue discharge or ":
                             "Cancel to check that both patients are ":
                             "discharged if they have left the hospital.":
                             "</RETURN_VALUE>"
          GOTO      VAMBLN98
.
VAMBLN98  CALL      XMLEND00
VAMBLN99  RETURN
+
.------------------------------------------------------------
. Validate Concession Card Types
.------------------------------------------------------------
VACCTY00  MATCH     "2",VALDINDC
          GOTO      VACCTY40 IF EQUAL
          MATCH     "3",VALDINDC
          GOTO      VACCTY40 IF EQUAL
.
          CALL      XMLHED00
          BRANCH    EXIT,VACCTY99
.
VACCTY10  PACK      VALDCODE,VALDCODE,SP70       * Concession Card Type (Cat ct)
          MATCH     SP70,VALDCODE
          GOTO      VACCTY98 IF EQUAL
.
          PACK      VALDCOD2,VALDCOD2,SP70       * Concession Card Number
          MATCH     SP70,VALDCOD2
          GOTO      VACCTY98 IF EQUAL
.
          PACK      KEY5,CATct,VALDCODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,VACCTY98
.
          MATCH     "E",TCINDC9  *Combined Centrelink/pension/seniors validation
          GOTO      VACCTY15 IF EQUAL
.
          MOVE      ZERO,FORM1
          MOVE      TCINDC1,FORM1
          BRANCH    FORM1,VACCTY15:              * Centrelink
                          VACCTY20:              * Safety Net
                          VACCTY30:              * DVA
                          VACCTY98:              * Pension
                          VACCTY98               * Seniors Concession Card
.
          GOTO      VACCTY98
.
VACCTY15  TYPE      TCINDC2
          GOTO      VACCTY98 IF NOT EQUAL
.
          MOVE      TCINDC2,D1
          REP       "1~4~5~",D1
          MATCH     "~",D1
          CALL      VACLNK00 IF EQUAL            * validate Centrelink card no.
          GOTO      VACCTY98
.
VACCTY20  CALL      VASNET00                     * validate Safety Net card no.
          GOTO      VACCTY98
.
VACCTY30  CALL      VADVAC00                     * validate DVA card number
          GOTO      VACCTY98
.
.         Validation by directly specifying the Indicator for 2 or 3 only
VACCTY40  CALL      XMLHED00
          BRANCH    EXIT,VACCTY99

          PACK      VALDCOD2,VALDCOD2,SP70       * Concession Card Number
          MATCH     SP70,VALDCOD2
          GOTO      VACCTY98 IF EQUAL
.
          MOVE      ZERO,FORM1
          MOVE      VALDINDC,FORM1
          BRANCH    FORM1,VACCTY98:              * Centrelink (N/A)
                          VACCTY42:              * Safety Net
                          VACCTY44               * DVA
          GOTO      VACCTY98
.
VACCTY42  CALL      VASNET00                     * validate Safety Net card no.
          GOTO      VACCTY98
.
VACCTY44  CALL      VADVAC00                     * validate DVA card number
          GOTO      VACCTY98
.
VACCTY95  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Indicator not set up for Concession Card Type. ":
                             "</RETURN_VALUE>"
          GOTO      VACCTY98
.
VACCTY98  CALL      XMLEND00
VACCTY99  RETURN
+
.------------------------------------------------------------
. Validate Centrelink card no.
.------------------------------------------------------------
VACLNK00  UNPACK    VALDCOD2,KEY9,KEY1,D1,D9     * centrelink card number
          TYPE      KEY9
          GOTO      VACLNK90 IF NOT EQUAL        * first 9 chars must be numeric
.
          MATCH     "0",KEY9
          GOTO      VACLNK91 IF EQUAL            * first char cannot be zero
.
. Calculate check digit
.
          MOVE      ZERO,FORM1
          MOVE      ZERO,FORM3
          MOVE      SP1,CHKDIGIT
          MOVE      ZERO,CHKPRDCT
          MOVE      ZERO,CHKPRDTO
          MOVE      ZERO,CHKREMAN
          MOVE      ONE,COUNTER
          WHILE     COUNTER <= 9
            CMOVE     KEY9,ANS                   * get char
            MOVE      ANS,FORM1                  * get char
            MOVE      CLNKARAY[COUNTER],KEY3     * get weight value
            MOVE      KEY3,FORM3                 * get weight number
            ASSIGN    (FORM3*FORM1),CHKPRDCT     * product of weight & digit
            ADD       CHKPRDCT,CHKPRDTO          * add all the products together
            BUMP      KEY9
            ADD       ONE,COUNTER
          DO
          ASSIGN    (CHKPRDTO%11),CHKREMAN       * get "remainder"
          IF        CHKREMAN=TEN
            MOVE      "A",CHKDIGIT
            GOTO      VACLNK20
          ENDIF
.
          MOVE      CHKREMAN,D2
          SQUEEZE   D2
          MOVE      D2,CHKDIGIT
          REP       "9B8C7H6J5K4L3S2T1V0X",CHKDIGIT
.         ENDIF
VACLNK20  MATCH     KEY1,CHKDIGIT
          GOTO      VACLNK92 IF NOT EQUAL      * validate check digit (char 10)
.
          MATCH     SP1,D1
          IF        !@EQUAL
            RESET     ALPHABET                 * reset from previous SCAN
            SCAN      D1,ALPHABET
            GOTO      VACLNK93 IF NOT EQUAL    * 11th char must be blank or A-Z
          ENDIF
.
          GOTO      VACLNK99
.
VACLNK90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "First 9 characters must be numeric. ":
                             "</RETURN_VALUE>"
          GOTO      VACLNK99
.
VACLNK91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "First character of card number cannot be 0. ":
                             "</RETURN_VALUE>"
          GOTO      VACLNK99
.
VACLNK92  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Check digit calculation failed. Please check ":
                             "card number. ":
                             "</RETURN_VALUE>"
          GOTO      VACLNK99
.
VACLNK93  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid 11th character. Please check ":
                             "card number. ":
                             "</RETURN_VALUE>"
          GOTO      VACLNK99
.
VACLNK99  RETURN
+
.------------------------------------------------------------
. Validate Safety Net card no.
.------------------------------------------------------------
VASNET00  UNPACK    VALDCOD2,KEY2,KEY9,DIM9      * Safety Net card number
          MATCH     SP70,DIM9
          GOTO      VASNET90 IF NOT EQUAL
.
          MATCH     "SN",KEY2
          IF        !@EQUAL
            MATCH     "CN",KEY2
            GOTO      VASNET91 IF NOT EQUAL
          ENDIF
.
          TYPE      KEY9
          GOTO      VASNET92 IF NOT EQUAL
.
          UNPACK    KEY9,KEY8,KEY1
.
. Calculate check digit (based on chars 3-10)
.
          MOVE      ZERO,FORM1
          MOVE      ZERO,FORM3
          MOVE      SP1,CHKDIGIT
          MOVE      ZERO,CHKPRDCT
          MOVE      ZERO,CHKPRDTO
          MOVE      ZERO,CHKREMAN
          RESET     SNETARAY
          MOVE      ONE,COUNTER
          WHILE     COUNTER <= 8
            CMOVE     KEY8,ANS                   * get char
            MOVE      ANS,FORM1                  * get char
            CMOVE     SNETARAY,ANS               * get weight value
            MOVE      ANS,FORM3                  * get weight number
            ASSIGN    (FORM3*FORM1),CHKPRDCT     * product of weight & digit
            ADD       CHKPRDCT,CHKPRDTO          * add all the products together
            BUMP      KEY8                       * next char
            BUMP      SNETARAY                   * next weight
            ADD       ONE,COUNTER
          DO
          ASSIGN    (CHKPRDTO%10),CHKREMAN       * get "remainder"
          MOVE      CHKREMAN,FORM1
          MOVE      FORM1,CHKDIGIT
          MATCH     KEY1,CHKDIGIT
          GOTO      VASNET93 IF NOT EQUAL      * validate check digit (char 11)
.
          GOTO      VASNET99
.
VASNET90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Incorrect card number length. ":
                             "Should be 11 characters. ":
                             "</RETURN_VALUE>"
          GOTO      VASNET99
.
VASNET91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid first two characters. ":
                             "Should be CN or SN. ":
                             "</RETURN_VALUE>"
          GOTO      VASNET99
.
VASNET92  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid card number. Last 9 characters ":
                             "should be numeric. ":
                             "</RETURN_VALUE>"
          GOTO      VASNET99
.
VASNET93  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Check digit calculation failed. Please check ":
                             "card number. ":
                             "</RETURN_VALUE>"
          GOTO      VASNET99
.
VASNET99  RETURN
+
.------------------------------------------------------------
. Validate DVA card no.
.------------------------------------------------------------
.     DVA Number format:
.       - A valid state indicator
.       - A valid war code (one only).  War codes are between 1 and 3
.                          characters (A-Z). A one character war code can
.                          also be a space.
.       - A valid numeric number (up to 6 digits for a one character war code,
.                                 up to 5 digits for a 2 character war code,
.                                 or up to 4 digits for a 3 character war code).
.       - A valid dependent indicator ('space' or 'A' through 'Z')
.
.     In addition:
.       - The war code can be a single space but the space can be omitted in the
.         received number - either format is valid. Eg. 'N 123456A' is
.         equivalent to 'N123456A' and both are considered valid.
.       - The length of the war code component plus the numeric component
.         should be 7 characters.  However, the numeric component can be
.         padded out with leading zeros which may or may not be present
.         in the received DVA number - either format is valid. Eg. VSS00151A is
.         equivalent to VSS151A and both are considered valid.
.
VADVAC00  RESET     DVACHAR1                     * DVA card number
          REP       UPPLOW,VALDCOD2
          STRIP     VALDCOD2
          UNPACK    VALDCOD2,KEY1,KEY8,DIM11
.
          MOVELPTR  VALDCOD2,FORM3
          IF        FORM3 > 9
            GOTO      VADVAC92
          ENDIF
.
.         First character - State Identifier (Q,N,V,T,S or W)
.
          SCAN      KEY1,DVACHAR1           * validate char 1
          GOTO      VADVAC90 IF NOT EQUAL
.
.         Check to see if character 2 is an alpha (A-Z), a space or a numeric.
.         Note: CHRCOUNT is initialised to "1" given that if a war code
.               is not present, we are assuming that it is actually a single
.               space.
.               Also, there is no need to check if a space is present, as
.               the field has already been SQUEEZEd
.
VADVAC10  MOVE      ONE,CHRCOUNT                 * initialise character count
          MOVE      ZERO,DIGCOUNT                * initialise digit count
          MOVE      ZERO,EOSFLAG                 * initialise eos flag
.
          MOVE      KEY8,ANS                     * load character 2
          MOVE      ANS,WARCODE                  * add char to war code
.
          RESET     ALPHABET                     * reset from previous SCAN
          SCAN      ANS,ALPHABET                 * A-Z or space ?
          GOTO      VADVAC20 IF EQUAL            * yes
.
          TYPE      ANS                          * no - numeric ?
          IF        @EQUAL
            MOVE      SP1,WARCODE                * war code is blank
            GOTO      VADVAC50                   * yes
          ENDIF
.
.        Allow second character to be space
          MATCH     SP70,ANS
          IF        @EQUAL
            GOTO      VADVAC20
          ENDIF
.
          GOTO      VADVAC95
.
.         We have a war code present
.
VADVAC20  BUMP      KEY8                         * move to next character
          IF        @EOS
            GOTO      VADVAC94
          ENDIF
.
          MOVE      KEY8,ANS                     * load next character
          TYPE      ANS                          * digit ?
          GOTO      VADVAC50 IF EQUAL            * yes
.
          RESET     ALPHABET                     * reset after previous SCAN
          SCAN      ANS,ALPHABET                 * A-Z ?
          IF        @EQUAL
            ADD       ONE,CHRCOUNT               * yes - incr. character count
            APPEND    ANS,WARCODE                * add char to war code
            GOTO      VADVAC20
          ENDIF
.
          GOTO      VADVAC95
.
.
.         We have processed the war code, so check the character count
.         for the code
.
VADVAC50  ADD       ONE,DIGCOUNT
.
          IF        CHRCOUNT > 3
            GOTO      VADVAC96
          ENDIF
.
          RESET     WARCODE            * now validate the war code
          MOVE      ONE,COUNTER
          BRANCH    CHRCOUNT,VADVAC52,VADVAC54,VADVAC56
          GOTO      VADVAC91
.
VADVAC52  LOAD      WARCHECK,COUNTER,WARCD101,WARCD102,WARCD103,WARCD104:
                                     WARCD105,WARCD106,WARCD107,Z70
          MATCH     WARCODE,WARCHECK
          GOTO      VADVAC60 IF EQUAL  * valid
.
          MATCH     Z70,WARCHECK
          GOTO      VADVAC91 IF EQUAL  * invalid
.
          ADD       ONE,COUNTER
          GOTO      VADVAC52
.
VADVAC54  LOAD      WARCHECK,COUNTER,WARCD201,WARCD202,WARCD203,WARCD204:
                                     WARCD205,WARCD206,WARCD207,WARCD208:
                                     WARCD209,WARCD210,WARCD211,WARCD212:
                                     WARCD213,WARCD214,WARCD215,WARCD216:
                                     WARCD217,Z70
          MATCH     WARCODE,WARCHECK
          GOTO      VADVAC60 IF EQUAL  * valid
.
          MATCH     Z70,WARCHECK
          GOTO      VADVAC91 IF EQUAL  * invalid
.
          ADD       ONE,COUNTER
          GOTO      VADVAC54
.
VADVAC56  LOAD      WARCHECK,COUNTER,WARCD301,WARCD302,WARCD303,WARCD304:
                                     WARCD305,WARCD306,WARCD307,WARCD308:
                                     WARCD309,WARCD310,WARCD311,WARCD312:
                                     WARCD313,WARCD314,WARCD315,WARCD316:
                                     WARCD317,WARCD318,WARCD319,WARCD320:
                                     WARCD321,WARCD322,WARCD323,WARCD324:
                                     WARCD325,WARCD326,WARCD327,WARCD328:
                                     WARCD329,WARCD330,WARCD331,WARCD332:
                                     WARCD333,WARCD334,WARCD335,WARCD336:
                                     Z70
          MATCH     WARCODE,WARCHECK
          GOTO      VADVAC60 IF EQUAL  * valid
.
          MATCH     Z70,WARCHECK
          GOTO      VADVAC91 IF EQUAL  * invalid
.
          ADD       ONE,COUNTER
          GOTO      VADVAC56
.
.
.         We now need to process the numeric component of the DVA number.
.
VADVAC60  BUMP      KEY8                         * move to next character
          IF        @EOS
            MOVE      ONE,EOSFLAG                * eos - set eos flag
            GOTO      VADVAC75
          ENDIF
.
          MOVE      KEY8,ANS                     * load next character
.
          MATCH     ".",ANS
          GOTO      VADVAC75 IF EQUAL            * not a valid digit
.
          TYPE      ANS                          * digit ?
          GOTO      VADVAC75 IF NOT EQUAL        * no
.
          ADD       ONE,DIGCOUNT                 * increment digit count
          GOTO      VADVAC60
.
.         Make sure that the number of digits is valid for the size of
.         the war code
.
VADVAC75  LOAD      MAXCOUNT,CHRCOUNT,SIX,FIVE,FOUR
.
          COMPARE   DIGCOUNT,MAXCOUNT
          IF        @LESS
            GOTO      VADVAC97
          ENDIF
.
.         Check this is the last character and it is a space or A-Z and that
.         there are no further characters
.
          BRANCH    EOSFLAG,VADVAC99             * no last character
.
          RESET     ALPHABET                     * reset after previous SCAN
          SCAN      ANS,ALPHABET                 * A-Z ?
          IF        @EQUAL
            BUMP      KEY8                       * eos ?
            GOTO      VADVAC99 IF EOS            * yes - finished
          ENDIF
.
          GOTO      VADVAC93
.
VADVAC90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid State Code (1st character). ":
                             "</RETURN_VALUE>"
          GOTO      VADVAC99
.
VADVAC91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid War Code (2nd to 4th characters). ":
                             "</RETURN_VALUE>"
          GOTO      VADVAC99
.
VADVAC92  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid DVA card number length. ":
                             "</RETURN_VALUE>"
          GOTO      VADVAC99
.
VADVAC93  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid final character (Dependant Indicator). ":
                             "</RETURN_VALUE>"
          GOTO      VADVAC99
.
VADVAC94  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "DVA Number has no numeric component. ":
                             "</RETURN_VALUE>"
          GOTO      VADVAC99
.
VADVAC95  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "DVA Number contains invalid character. ":
                             "</RETURN_VALUE>"
          GOTO      VADVAC99
.
VADVAC96  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "DVA Number war code too long. ":
                             "</RETURN_VALUE>"
          GOTO      VADVAC99
.
VADVAC97  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "DVA Number has too many digits. ":
                             "</RETURN_VALUE>"
          GOTO      VADVAC99
.
VADVAC99  RETURN
+
.------------------------------------------------------------
. Validate Age / Marital Status for WAHealth
.------------------------------------------------------------
VAAMAR00  CALL      XMLHED00
          BRANCH    EXIT,VAAMAR99
.
VAAMAR10  PACK      VALDDOBE,VALDDOBE,SP70       * Date of Birth
          MATCH     SP70,VALDDOBE
          GOTO      VAAMAR98 IF EQUAL
.
          PACK      PBDATE,VALDDOBE,SP70
.
VAAMAR20  PACK      VALDCOD2,VALDCOD2,SP70       * Cat.M
          MATCH     SP70,VALDCOD2
          GOTO      VAAMAR98 IF EQUAL
.
          MATCH     "DEFAULT",VALDCOD2
          GOTO      VAAMAR30 IF EQUAL            * default cat.M
.
          PACK      KEY5,ANSM,SP1,VALDCOD2,SP70  * Cat.M
          CALL      RDCODE1
          BRANCH    OVRCD,VAAMAR98
.
          MOVE      TCINDC1,CATMIND1             * Cat.M indicator 1
.
VAAMAR30  PACK      VALDDATE,VALDDATE,SP70       * current date
          MATCH     SP70,VALDDATE
          GOTO      VAAMAR98 IF EQUAL
.
          MOVE      VALDDATE,AGEDATE
          CALL      CALCAGE                      * check if age is <= cutoff
.
VAAMAR90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PSAGEYRS,"|",CAGECOFF,"|",CATMIND1:
                             "</RETURN_VALUE>"
          GOTO      VAAMAR98
.
VAAMAR98  CALL      XMLEND00
VAAMAR99  RETURN
+
.------------------------------------------------------------
. Check last demographics update date/time  
.------------------------------------------------------------
CHKUPD00  CALL      XMLHED00
          BRANCH    EXIT,CHKUPD99
.
          PACK      VALDCODE,VALDCODE,SP70       * Urnumber
          MATCH     SP70,VALDCODE
          GOTO      CHKUPD90 IF EQUAL
.
          PACK      VALDDATE,VALDDATE,SP70       * paged opened date
          MATCH     SP70,VALDDATE
          GOTO      CHKUPD90 IF EQUAL
.
          PACK      VALDTIME,VALDTIME,SP70       * paged opened time
          MATCH     SP70,VALDTIME
          GOTO      CHKUPD90 IF EQUAL
.
          PACK      KEY8,VALDCODE,SP70
          CALL      RDPMUPD1
          BRANCH    OVRCD,CHKUPD90
.
          MATCH     VALDDATE,PMUDDATE
          GOTO      CHKUPD90 IF LESS
.
          MATCH     PMUDDATE,VALDDATE
          GOTO      CHKUPD10 IF LESS
.
          MATCH     PMUDTIME,VALDTIME
          GOTO      CHKUPD10 IF LESS
......    GOTO      CHKUPD10 IF EQUAL
.
          GOTO      CHKUPD90
.
CHKUPD10  PACK      KEY10,PMUDUSER,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      "Invalid User Id",WBSENAM
          ENDIF
.
          MOVE      SP70,PRDFRDTE
          UNPACK    PMUDDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      PRDFRDTE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          STRIP     WBSENAM
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Demographic details have since been updated ":
                             "by ",*+,WBSENAM,*-," at ",PRDFRDTE," ",PMUDTIME:
                             "</RETURN_VALUE>"
          GOTO      CHKUPD98
.
CHKUPD90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             "1":
                             "</RETURN_VALUE>"
          GOTO      CHKUPD98
.
CHKUPD98  CALL      XMLEND00
CHKUPD99  RETURN
+
.------------------------------------------------------------
. Output Allied Health Diagnosis by department
.------------------------------------------------------------
SELDIA00  CALL      XMLHED00
          BRANCH    EXIT,SELDIA99
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
.
          PACK      VALDCODE,VALDCODE,SP70
.
          PACK      KEY92,VALDCODE,SP70
          CALL      RSALDIA2                * positional read
SELDIA10  CALL      RKALDIA2                * read a record
          BRANCH    OVRCD,SELDIA90
.
          MATCH     ALDIDEPT,VALDCODE
          GOTO      SELDIA90 IF NOT EQUAL
.
          MATCH     "1",ALDIACTV            * Only display active codes
          GOTO      SELDIA10 IF NOT EQUAL
.
          WRITE     HTMLFILE;ALDIDIAG,",",ALDIDESC,"|";
.
          GOTO      SELDIA10
.
SELDIA90  WRITE     HTMLFILE;"</RETURN_VALUE>"
          CALL      XMLEND00
.
SELDIA99  RETURN
+
.------------------------------------------------------------
. Outstanding balance after entering a new journal amount
.------------------------------------------------------------
CBAL0000 CALL      XMLHED00
         BRANCH    EXIT,CBAL9999
.
         MOVE      ZERO,FORM12P2
         MOVE      ZERO,FORM8
         MOVE      INVOICEN,FORM8
         MOVE      FORM8,KEY8
         CALL      RDINV1
         BRANCH    OVRCD,CBAL9000
.
         CALL      TPAY0000
         ADD       PINVAMT,FORM12P2
         ADD       PINVJOUR,FORM12P2
         ADD       PTINCRTT,FORM12P2
         ADD       PTINGSTJ,FORM12P2
         CALL      JTYP0000               * Check Journal type
.
CBAL9000 MOVE      FORM12P2,KEY15
         MOVE      "$",KEY1
         PACK      KEY16,KEY1,KEY15
         WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             KEY16:
                             "</RETURN_VALUE>"
         CALL      XMLEND00
CBAL9999 RETURN
+
.------------------------------------------------------------
.        Total payments
.------------------------------------------------------------
TPAY0000 MOVE      INVOICEN,SKEY12
         PACK      KEY29,SKEY12,SP70
         CALL      RSRCDTE3
TPAY1000 CALL      RKRCDTE3
         BRANCH    OVRCD,TPAY9000
.
         MATCH     SKEY12,RCDTINVN       * Same invoice number?
         GOTO      TPAY9000 IF NOT EQUAL
.
         MATCH     PINVUR,RCDTURNO       * Same U/R?
         GOTO      TPAY1000 IF NOT EQUAL
.
         PACK      KEY12,RCDTRECN,SP70
         CALL      RDRCBNK1
         BRANCH    OVRCD,TPAY1000
         MATCH     "1",RCBNSTAT
         GOTO      TPAY1000 IF EQUAL       * Receipt cancelled
.
.        Check for Deposit register
.
         PACK      KEY3,RCDTREGI,SP70
         CALL      RDREGA1
         BRANCH    OVRCD,TPAY1000
.
         COMPARE   "2",REGIBACD
         GOTO      TPAY1000 IF EQUAL       * Private Practice
         COMPARE   "96",REGIBACD
         GOTO      TPAY1000 IF EQUAL       * PRI Deposit
.
         ADD       RCDTAMNT,FORM12P2
         GOTO      TPAY1000
.
TPAY9000 MULT      "-1",FORM12P2
TPAY9999 RETURN
.
.------------------------------------------------------------
.         Check type of Journal
.------------------------------------------------------------
JTYP0000 MOVE      JOURITEM,TTYPE
         PACK      KEY5,CODEJ,JOURITEM
         CALL      RDCODE1
         BRANCH    OVRCD,JTYP9999
.
         MOVE      THCSCOD,JTYPE
         MATCH     SP1,JTYPE
         GOTO      JTYP1000 IF NOT EQUAL
.
         MATCH     "R",TCINDC5
         GOTO      JTYP3000 IF EQUAL       * Self Insured Refund Journal
         MATCH     "F",TCINDC5
         GOTO      JTYP3000 IF EQUAL       * Deposit OFF Journal
         GOTO      JTYP2000
.
JTYP1000 MATCH     "A",JTYPE
         GOTO      JTYP3000 IF EQUAL
.
JTYP2000 SUB       JOURPATT,FORM12P2
         GOTO      JTYP9999
.
JTYP3000 ADD       JOURPATT,FORM12P2
         GOTO      JTYP9999
.
JTYP9999 RETURN
.
+
.------------------------------------------------------------
. Select list of linked hospital for a HCP
.------------------------------------------------------------
HCPHOS00  CALL      XMLHED00
          BRANCH    EXIT,HCPHOS99
.
          CALL      IBACLOCK
          PACK      DIM8,CCC,CYY,CMM,CDD
          REP       " 0",DIM8
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
.
          PACK      KEY10,VALDCODE,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,HCPHOS80
.
          MATCH     "1",PMHCHOSS            * Hospital Specific HCP
          GOTO      HCPHOS50 IF NOT EQUAL
.
          PACK      KEY13,VALDCODE,SP70
          CALL      RSMLHCP2                * positional read
HCPHOS10  CALL      RKMLHCP2                * read a record
          BRANCH    OVRCD,HCPHOS90
.
          MATCH     MLHCHCPC,VALDCODE
          GOTO      HCPHOS90 IF NOT EQUAL
.
          MATCH     "1",MLHCACTV            * skip inactive codes
          GOTO      HCPHOS10 IF EQUAL
.
          MATCH     MLHCSDAT,DIM8
          GOTO      HCPHOS10 IF LESS
.
          MATCH     SP70,MLHCEDAT
          IF        !@EQUAL & !@EOS
            MATCH     DIM8,MLHCEDAT
            GOTO      HCPHOS10 IF LESS
          ENDIF
.
          PACK      KEY3,MLHCHOSP,SP70
          CALL      RDPTHSP1
          BRANCH    OVRCD,HCPHOS10
.
          WRITE     HTMLFILE;PTHSHOSP,",",PTHSNAME,"|";
.
          GOTO      HCPHOS10
.
HCPHOS50  PACK      KEY3,SP70
          CALL      RSPTHSP1                * positional read
HCPHOS60  CALL      RKPTHSP1                * read a record
          BRANCH    OVRCD,HCPHOS90
.
          WRITE     HTMLFILE;PTHSHOSP,",",PTHSNAME,"|";
.
          GOTO      HCPHOS60
.
HCPHOS80  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid HCP Code - ",VALDCODE:
                             "</RETURN_VALUE>"
          GOTO      VALPRD98
.

HCPHOS90  WRITE     HTMLFILE;"</RETURN_VALUE>"
          CALL      XMLEND00
.
HCPHOS99  RETURN
+
.----------------------------------------------------------
. Selection list for Referral Department Services
.----------------------------------------------------------
DEPSRV00  CALL      XMLHED00
          BRANCH    EXIT,DEPSRV99
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
.         
          PACK      KEY3,VALDCODE,SP70          * get the department code 
.
          PACK      KEY49,KEY3,SP70
          CALL      RSALSER2
DEPSRV10  CALL      RKALSER2
          BRANCH    OVRCD,DEPSRV90
.
          MATCH     ALSRDEPT,VALDCODE
          GOTO      DEPSRV90 IF NOT EQUAL
.
          MATCH     "1",ALSRACTV                 * Active?
          GOTO      DEPSRV10 IF NOT EQUAL        * No; get next service
.
          MATCH     "1",ALSRNURA                 * Non U/R Related Service?
          GOTO      DEPSRV10 IF EQUAL            * Yes; skip
.
          WRITE     HTMLFILE;ALSRSERV,",",ALSRDESC,"|";
          GOTO      DEPSRV10
.
DEPSRV90  WRITE     HTMLFILE;"</RETURN_VALUE>"
          GOTO      DEPSRV98
.
DEPSRV98  CALL      XMLEND00
DEPSRV99  RETURN
+
.------------------------------------------------------------
. Validate ICD Disease including non existent header record
. Parameter -USNGICD9 : Validate ICD9 Disease Code
.------------------------------------------------------------
VALICH00  CALL      XMLHED00
          BRANCH    EXIT,VALICH99
.
VALICH05  BRANCH    USNGICD9,VALICH10      * Validate ICD9?
.
          MOVE      SP70,ICDRDDTE          * Set ICD10 date   * start *I-226826
.
          MATCH     SP70,ICD10DAT
          IF        !@EQUAL
            MOVE      ICD10DAT,ICDRDDTE    * Set ICD10 date
          ENDIF                                               * end   *I-226826
.
          MOVE      VALDCODE,KEY9          * Validate ICD10
          CALL      RDPTICD1
.         BRANCH    OVRCD,VALICH90
          IF        OVRCD=1
            CALL      RKPTICD1
            BRANCH    OVRCD,VALICH90
.
            MOVE      VALDCODE,DIM3
.     
            MATCH     DIM3,DPCODE
            GOTO      VALICH90 IF NOT EQUAL
.
            MOVE      SP70,DDESC
          ENDIF
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             DDESC:
                             "</RETURN_VALUE>"
          GOTO      VALICH98
.
VALICH10  MOVE      VALDCODE,KEY9     * Validate ICD9
          CALL      RD10T9D1
          BRANCH    OVRCD,VALICH91
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             DDESC:
                             "</RETURN_VALUE>"
          GOTO      VALICH98
.
VALICH90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid ICD10 Disease Code - ":
                             KEY9,"</RETURN_VALUE>"
          GOTO      VALICH98
.
VALICH91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid ICD9 Disease Code - ":
                             KEY9,"</RETURN_VALUE>"
          GOTO      VALICH98
.
VALICH98  CALL      XMLEND00
VALICH99  RETURN
.------------------------------------------------------------
. Validate DRG - with version
.------------------------------------------------------------
VALDRV00  CALL      XMLHED00
          BRANCH    EXIT,VALDRV99
          MOVE      VALDCODE,KEY4
.
          MATCH     SP70,VALDCOD2
          GOTO      VALDRV70 IF NOT EQUAL
.
          MOVE      "999",KEY3
          PACK      KEY7,KEY4,KEY3,SP10   * last DRG version          
          CALL      RSPTDGW1
          CALL      RPPTDGW1
          BRANCH    OVRCD,VALDRV90
          MATCH     PTDWDRGC,KEY4           * same DRG code ?         
          GOTO      VALDRV90 IF NOT EQUAL                            
          GOTO      VALDRV80
.
VALDRV70  MOVE      VALDCOD2,KEY3
          PACK      KEY7,KEY4,KEY3,SP70
          CALL      RDPTDGW1
          BRANCH    OVRCD,VALDRV90
.
VALDRV80  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PTDWDESC:
                             "</RETURN_VALUE>"
          GOTO      VALDRV98
.
VALDRV90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid DRG - ":
                              KEY4,"</RETURN_VALUE>"
          GOTO      VALDRV98
.
VALDRV98  CALL      XMLEND00
VALDRV99  RETURN
.
.-------------------------------------------------------------------------------
. Check if selected UR is a current inpatient
.-------------------------------------------------------------------------------
CHKINP00  CALL      XMLHED00
          BRANCH    EXIT,CHKINP99
.
          MATCH     SP70,VALDCODE
          GOTO      CHKINP95 IF EQUAL
.
          PACK      KEY17,VALDCODE,TWO,SP20
          CALL      RSPTMI18
CHKINP50  CALL      RKPTMI18
          BRANCH    OVRCD,CHKINP91          * no current admission
.
          MATCH     AURNO,VALDCODE          * check same U/R Number
          GOTO      CHKINP91 IF NOT EQUAL
.
          COMPARE   TWO,ASTAT               * Current Inpatient
          GOTO      CHKINP90 IF EQUAL
.
          PACK      KEY17,VALDCODE,FOUR,SP70
          CALL      RSPTMI18
          CALL      RKPTMI18
          BRANCH    OVRCD,CHKINP91          * not on file
.
          MATCH     AURNO,VALDCODE          * check same U/R Number
          GOTO      CHKINP91 IF NOT EQUAL
.
          COMPARE   FOUR,ASTAT              * Patient on leave (still Inpatient)
          GOTO      CHKINP90 IF EQUAL
.
          GOTO      CHKINP91
.                                           * Current Inpatient
CHKINP90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             ONE:
                             "</RETURN_VALUE>"
          GOTO      CHKINP95
.                                           * Not a Current Inpatient
CHKINP91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             ZERO:
                             "</RETURN_VALUE>"
          GOTO      CHKINP95
.
CHKINP95  CALL      XMLEND00
.
CHKINP99  RETURN
+
.-------------------------------------------------------------------------------
.         Check if Cross Consultation exists for admission
.-------------------------------------------------------------------------------
CRSCON00  CALL      XMLHED00
          BRANCH    EXIT,CRSCON99
.
          MATCH     SP70,VALDCODE
          GOTO      CRSCON95 IF EQUAL
.
          PACK      KEY31,VALDCODE,SP70
          CALL      RSPTCRC1
CRSCON10  CALL      RKPTCRC1
          BRANCH    OVRCD,CRSCON91          * No cross consultation
.
          MATCH     DPTCRBIL,VALDCODE       * Same visit number?
          GOTO      CRSCON91 IF NOT EQUAL
.
CRSCON90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             ONE:
                             "</RETURN_VALUE>"
          GOTO      CRSCON95
.
CRSCON91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             ZERO:
                             "</RETURN_VALUE>"
          GOTO      CRSCON95
.
CRSCON95  CALL      XMLEND00
.
CRSCON99  RETURN
.
.-------------------------------------------------------------
. Selection of Service doctor for the U/R and Medical Practice
.-------------------------------------------------------------
MPSDOC00  CALL      XMLHED00
          BRANCH    EXIT,MPSDOC99
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
          PACK      KEY27,VALDCODE,SP70
          CALL      RSPRHD1
MPSDOC10  CALL      RKPRHD1
          BRANCH    OVRCD,MPSDOC80
.
          MATCH     VALDCODE,PRHDDEBT
          GOTO      MPSDOC80 IF NOT EQUAL
.
          PACK      KEY27,PRHDUNIQ,SP70
          CALL      RSPRHR1
MPSDOC20  CALL      RKPRHR1
          BRANCH    OVRCD,MPSDOC10
.
          COMPARE   PRHRUNIQ,PRHDUNIQ
          GOTO      MPSDOC10 IF NOT EQUAL
.
.         Check for the selected Medical practice
.
          PACK      VALDCOD2,VALDCOD2,SP70
          MATCH     SP70,VALDCOD2
          IF        !@EQUAL
            MATCH      PRHRPRAC,VALDCOD2
            GOTO       MPSDOC20 IF NOT EQUAL
          ENDIF
.
          PACK      KEY6,PRHRPRAC
          CALL      RDPRPR1
          BRANCH    OVRCD,MPSDOC20
.
          COMPARE   ONE,PRPRSTAT
          GOTO      MPSDOC20 IF EQUAL       * Not active
.
          PACK      KEY10,USERID,SP70
          CALL      RDPRALS1
          COMPARE   ZERO,OVRCD
          GOTO      MPSDOC40 IF EQUAL       * User has access to all Med.Prac.
.
          PACK      KEY16,PRHRPRAC,USERID,SP70
          CALL      RDPRSEC1
          BRANCH    OVRCD,MPSDOC20
.
MPSDOC40  PACK      PACFNAME,SP70
          PACK      KEY10,PRHRDOCT,SP10
          CALL      RDPMHCP1                * read the doctors file
          IF        OVRCD=0
            MOVE      PMHCSNAM,PACSNAME
            MOVE      PMHCGNAM,PACGNAME
            MOVE      PMHCTITL,PACTITLE
            MOVE      ONE,PACFRMT
            CALL      PACNAME                 * pack the doctors name
            PACK      KEY25,PACFNAME
          ENDIF
          MOVE      " (",DIM2
          MOVE      " )",KEY2
          PACK      KEY40,PRHRDOCT,DIM2,KEY25,KEY2,SP70
.
          WRITE     HTMLFILE;PRHRDOCT,",",KEY40,"|";
          GOTO      MPSDOC20
.
MPSDOC80  WRITE     HTMLFILE;"</RETURN_VALUE>"
          GOTO      MPSDOC98
.
MPSDOC98  CALL      XMLEND00
MPSDOC99  RETURN
+
.-------------------------------------------------------------
. VHCGDS00 - Validate HCP Practice DS fields
.-------------------------------------------------------------
VHCGDS00  PACK      VALDCODE,VALDCODE,SP70
          PACK      VALDCOD2,VALDCOD2,SP70
          CALL      XMLHED00
          BRANCH    EXIT,VHCGDS99
.
          MOVE      VALDCODE,DIM10
          MOVE      VALDCOD2,DIM2
.
          PACK      KEY12,DIM10,DIM2,SP70
          CALL      RDPMHCG1
          BRANCH    OVRCD,VHCGDS90
.
          MATCH     "0",PMHGSTTS                      * active practice ?
          GOTO      VHCGDS91 IF NOT EQUAL
.
VHCGDS80  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PMHGFXDS,"|",PMHGELDS,"|",PMHGPSCI:
                             "</RETURN_VALUE>"
.
          GOTO      VHCGDS98
.
VHCGDS90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Practice Code - ",VALDCODE:
                             "</RETURN_VALUE>"
          GOTO      VHCGDS98
.
VHCGDS91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Inactive Practice Code - ":
                              VALDCODE,"</RETURN_VALUE>"
          GOTO      VHCGDS98
.
VHCGDS98  CALL      XMLEND00
VHCGDS99  RETURN
.-------------------------------------------------------------------------------
.         Validate Date of Birth / Marital Status          
.-------------------------------------------------------------------------------
VDBMST00  CALL      XMLHED00
          BRANCH    EXIT,VDBMST99
.
VDBMST01  COMPARE   THREE,PTCNHDPS
          GOTO      VDBMST95 IF NOT EQUAL   * Not in Victoria
.
          PACK      VALDDATE,VALDDATE,SP70
          PACK      VALDCOD2,VALDCOD2,SP70
.
          MATCH     SP70,VALDDATE
          GOTO      VDBMST95 IF EQUAL
.
          MATCH     SP70,VALDCOD2
          GOTO      VDBMST95 IF EQUAL
.
          MOVE      VALDDATE,PBDATE
          UNPACK    PBDATE,CCENT,CYEAR,CMON,CDAY
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          CALL      CALCAGE
          COMPARE   TEN4,PSAGEYRS
          GOTO      VDBMST95 IF NOT LESS
.
          PACK      KEY5,ANSM,SP1,VALDCOD2,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,VDBMST91
.
          UNPACK    THCSCOD,DIM1A,DIM1
          TYPE      DIM1                         * is HPD Equiv numeric ?
          GOTO      VDBMST91 IF NOT EQUAL        * no
          MATCH     "1",DIM1
          GOTO      VDBMST91 IF NOT EQUAL
.
          GOTO      VDBMST95
.
VDBMST91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Marital status":
                             "</RETURN_VALUE>"
          GOTO      VDBMST95
.
VDBMST95  CALL      XMLEND00
.
VDBMST99  RETURN
.-------------------------------------------------------------------------------
.         Validate Drug Order bokrx1af             
.-------------------------------------------------------------------------------
VLDRUG00  CALL      XMLHED00
          BRANCH    EXIT,VLDRUG99
.
          PACK      VALDCODE,VALDCODE,SP70
          PACK      VALDCOD2,VALDCOD2,SP70
.
          MATCH     SP70,VALDCOD2
          GOTO      VLDRUG95 IF EQUAL
          GOTO      VLDRUG95 IF EOS
.
          PACK      KEY8,VALDCOD2,SP70
          CALL      RDBKRX11
          BRANCH    OVRCD,VLDRUG91
.
          MOVE      VALDCODE,BKRXDROR
.
          CALL      IBACLOCK
          PACK      BKRXLUPD,CCC,CYY,CMM,CDD 
          REP       " 0",BKRXLUPD          
          MOVE      CTIMEIS,BKRXLUPT
          MOVE      WBSEUID,BKRXWEBU
.
          CALL      UPBKRX11
.
          GOTO      VLDRUG95
.
VLDRUG91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Booking Extension Record":
                             "</RETURN_VALUE>"
          GOTO      VLDRUG95
.
VLDRUG95  CALL      XMLEND00
VLDRUG99  RETURN
.-------------------------------------------------------------------------------
.         Write View Record to clinical document audit OBSAUD
.-------------------------------------------------------------------------------
VWOBAD00  CALL      XMLHED00
          BRANCH    EXIT,VWOBAD99
.
          PACK      VALDCODE,VALDCODE,SP70
.
          UNPACK    VALDCODE,OBAUURNO,OBAUVISN,OBAUCORR
          CALL      IBACLOCK
          PACK      OBAUDATE,CCC,CYY,CMM,CDD
          REP       " 0",OBAUDATE
          PACK      OBAUTIME,CTIMEIS
          MOVE      USERID,OBAUWEBU
          MOVE      SP70,OBAUREAS
          PACK      OBAUSPAR,SP70
          MOVE      ANSV,OBAUTYPE
.
          PACK      KEY47,OBAUURNO,OBAUVISN,OBAUCORR,OBAUDATE:
                          OBAUTIME,OBAUWEBU,OBAUTYPE,SP70
          CALL      RAOBAUD1
          IF        OVRCD=1
            CALL      WROBAUD1
          ENDIF
.
VWOBAD95  CALL      XMLEND00
VWOBAD99  RETURN
+
.-------------------------------------------------------------------------------
.         Validate Bulk Journal
.-------------------------------------------------------------------------------
VBULJR00  CALL      XMLHED00
          BRANCH    EXIT,VBULJR99
.
          PACK      VALDBTCH,VALDBTCH,SP70
          PACK      VALDURNO,VALDURNO,SP70
          PACK      VALDVISN,VALDVISN,SP70
          PACK      VALDINVN,VALDINVN,SP70
          PACK      VALDJTYP,VALDJTYP,SP70
.
          MATCH     SP70,VALDBTCH
          GOTO      VBULJR95 IF EQUAL
.
          MATCH     SP70,VALDURNO
          GOTO      VBULJR95 IF EQUAL
.
          MATCH     SP70,VALDVISN
          GOTO      VBULJR95 IF EQUAL
.
          MATCH     SP70,VALDINVN
          GOTO      VBULJR95 IF EQUAL
.
          MATCH     SP70,VALDJTYP
          GOTO      VBULJR95 IF EQUAL
.
          REP       " 0",VALDINVN
.
          PACK      KEY35,VALDBTCH,VALDURNO,VALDVISN,VALDINVN,VALDJTYP,SP70
          CALL      RATMJRN1
          BRANCH    OVRCD,VBULJR95
.
          GOTO      VBULJR91
.
VBULJR91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Journal Record already exists for this invoice.":
                             "</RETURN_VALUE>"
          GOTO      VBULJR95
.
VBULJR95  CALL      XMLEND00
.
VBULJR99  RETURN
+
.-------------------------------------------------------------------------------
.         Validate Theatre Request Comments
.-------------------------------------------------------------------------------
VTRQCM00  CALL      XMLHED00
          BRANCH    EXIT,VTRQCM99
.
          PACK      VALDCODE,VALDCODE,SP70
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
.
          PACK      KEY16,VALDCODE,SP70
          CALL      RSOPDED1
VTRQCM10  CALL      RKOPDED1
          BRANCH    OVRCD,VTRQCM80
.
          MOVE      VALDCODE,DIM10
          MATCH     DIM10,OPDDUNIQ
          GOTO      VTRQCM80 IF NOT EQUAL
.
          MATCH     "012",OPDDTYPE
          GOTO      VTRQCM10 IF NOT EQUAL
.
          STRIP     OPDDDATA
          WRITE     HTMLFILE;OPDDDATA
.
          GOTO      VTRQCM10
.
VTRQCM80  WRITE     HTMLFILE;"</RETURN_VALUE>"
          GOTO      VTRQCM95
.
VTRQCM95  CALL      XMLEND00
.
VTRQCM99  RETURN
+
.-------------------------------------------------------------
. VTRQRC00 - Validate Theatre Request Record
.-------------------------------------------------------------
VTRQRC00  PACK      VALDCODE,VALDCODE,SP70
          CALL      XMLHED00
          BRANCH    EXIT,VTRQRC99
.
          MOVE      VALDCODE,DIM10
.
          PACK      KEY10,DIM10,SP70
          CALL      RDBKRQ11
          BRANCH    OVRCD,VTRQRC98
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                            BKRQADPT,"|",BKRQEPOW,"|",BKRQANAE,"|",BKRQMBS1,"|":
                            BKRQMBS2,"|",BKRQMBS3,"|",BKRQMBD1,"|",BKRQMBD2,"|":
                            BKRQMBD3,"|",BKRQPROR,"|",BKRQINFC,"|",BKRQEQU1,"|":
                            BKRQEQU2,"|",BKRQEQU3,"|",BKRQCSNT,"|",BKRQCCDT,"|":
                            BKRQTHET:
                             "</RETURN_VALUE>"
.
          GOTO      VTRQRC98
.
VTRQRC98  CALL      XMLEND00
VTRQRC99  RETURN
+
.-------------------------------------------------------------
. CHKDEC00 - Check for Deceased Patient
.-------------------------------------------------------------
CHKDEC00  PACK      VALDCODE,VALDCODE,SP70
          CALL      XMLHED00
          BRANCH    EXIT,CHKDEC99
.
          MOVE      VALDCODE,DIM8
.
          PACK      KEY8,DIM8,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,CHKDEC98
.
          IF        PCEASE=ONE
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                               ONE:
                               "</RETURN_VALUE>"
          ENDIF
.
          GOTO      CHKDEC98
.
CHKDEC98  CALL      XMLEND00
CHKDEC99  RETURN
+
.------------------------------------------------------------
. Validate Service doctor for a Medical Practice
.------------------------------------------------------------
VALDMP00  CALL      XMLHED00
          BRANCH    EXIT,VALDMP99
.
          PACK      VALDCODE,VALDCODE,SP70    * Pack to full length before match
          PACK      MEDIPRAC,MEDIPRAC,SP70    * Pack to full length before match
.
          MOVE      VALDCODE,DIM10
          BRANCH    RETURNFM,VALDMP10         * don't check hcp file
.
          PACK      KEY10,VALDCODE,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,VALDMP90
.
VALDMP10  MATCH     SP70,MEDIPRAC
          GOTO      VALDMP91 IF EQUAL         * Medical practice is not entered
.
          PACK      PRDOPRAC,MEDIPRAC,SP70
          MOVE      PRDOPRAC,MEDIPRAC
          PACK      PRDODOCT,VALDCODE,SP70
          MOVE      PRDODOCT,DIM10
.
          OPEN      PRIDOCT1,"pridoctf"
          PACK      KEY22,MEDIPRAC,PRDODOCT,SP70
          CALL      RSPRDO1
          CALL      RKPRDO1
          BRANCH    OVRCD,VALDMP92
.
          MATCH     MEDIPRAC,PRDOPRAC
          GOTO      VALDMP92 IF NOT EQUAL     * different medical practice
          MATCH     VALDCODE,PRDODOCT
          GOTO      VALDMP92 IF NOT EQUAL     * different doctor
.
          BRANCH    RETURNFM,VALDMP80         * don't want doctor name
.
          MOVE      PMHCTITL,FMTTITLE
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             DOCFNAME,"|",PRDOSTAT:
                             "</RETURN_VALUE>"
          GOTO      VALDMP98
.
VALDMP80  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PRDOSTAT,"|",PRDOPROV:
                             "</RETURN_VALUE>"
          GOTO      VALDMP98
.
VALDMP90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Doctor Code":
                             "</RETURN_VALUE>"
          GOTO      VALDMP98
.
VALDMP91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Medical Practice must be entered first.":
                             "</RETURN_VALUE>"
          GOTO      VALDMP98
.
VALDMP92  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Doctor ",DIM10," Not Setup for Medical ":
                             "Practice - ",MEDIPRAC,"</RETURN_VALUE>"
          GOTO      VALDMP98
.
VALDMP93  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Doctor is Inactive for Medical Practice - ":
                             MEDIPRAC,"</RETURN_VALUE>"
          GOTO      VALDMP98
.
VALDMP94  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Linked Doctor Code - ":
                             PMHCLDOC,"</RETURN_VALUE>"
          GOTO      VALDMP98
.
VALDMP98  CALL      XMLEND00
VALDMP99  RETURN
.-------------------------------------------------------------------------------
.         Validate HCP / Specialty
.-------------------------------------------------------------------------------
VALSPE00  CALL      XMLHED00
          BRANCH    EXIT,VALSPE99
.
          PACK      VALDCODE,VALDCODE,SP70
          PACK      VALDDATE,VALDDATE,SP70
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
.
          PACK      KEY21,VALDCODE,SP70
          CALL      RSPMSPE1
VALSPE10  CALL      RKPMSPE1
          BRANCH    OVRCD,VALSPE80
.
          MOVE      VALDCODE,DIM10
          MATCH     DIM10,PMSEHCPC
          GOTO      VALSPE80 IF NOT EQUAL
.
          MATCH     PMSESDAT,VALDDATE
          GOTO      VALSPE10 IF LESS
.
          MATCH     SP70,PMSEEDAT
          IF        !@EQUAL
            MATCH     VALDDATE,PMSEEDAT
            GOTO      VALSPE10 IF LESS
          ENDIF 
.
          WRITE     HTMLFILE;PMSESPEC,"|";
.
          GOTO      VALSPE10
.
VALSPE80  WRITE     HTMLFILE;"</RETURN_VALUE>"
          GOTO      VALSPE95
.
VALSPE95  CALL      XMLEND00
.
VALSPE99  RETURN
+
.*******************************************************************************
. OUTFIL00 - Check if the user id has an outpatienty site. If they do open
.            the correct outpatient files according to the site. If they do not
.            have a site make sure the default prefix of out is is used to
.            open the files.
.*******************************************************************************
OUTFIL00  PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,OUTFIL10
          MATCH     SP70,WBSESIT             * Does the user have a site
          GOTO      OUTFIL50 IF NOT EQUAL
.
OUTFIL10  MATCH     "out",CFILEPRE           * Is out currently open
          IF        !@EQUAL
            MOVE      "out",OSTFILE          * open default prefix of out
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open out Outpatient Files
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      OUTFIL99
.
OUTFIL50  MOVE      WBSESIT,KEY6
          CALL      RDSITA1
          BRANCH    OVRCD,OUTFIL90           * error invalid site code
.
          MATCH     OSTFILE,CFILEPRE         * Save Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open prefixed Outpatient Files
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      OUTFIL99
.
OUTFIL90  MOVE      "Outpatient Site Invalid",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
OUTFIL99  RETURN
.
.------------------------------------------------------------
. Open Outpatient Files
.------------------------------------------------------------
OPNOUT00  PACK      CFNAME,CFILEPRE,FILCVTA1  * Get the name of the CVTA1 file
          CLOSE     OUTCVTA1
          OPEN      OUTCVTA1,CFNAME           * Open the file
.
OPNOUT99  RETURN
+
*******************************************************************************
.
          INC       IBAWEBCD
          INC       CLPATICU
          INC       DGCLICAC
          INC       GETCNEFF
          INC       PATDEFCL                * routine DCLM0000
          INC       PMIGTNID
          INC       WEBDATCD
          INC       DAYOFWEK
          INC       VALCMXFN
          INC       VALCONTR
.
          INC       ALLCASIO/INC
          INC       ALLPRRIO/INC 
          INC       ALLDIAIO/INC
          INC       ALLCTMIO/INC
          INC       ALLDEPIO/INC
          INC       ALLSERIO/INC            * Service Types for Each Department
.
          INC       IBAGEDIO/INC
.
          INC       DISMASIO/INC
          INC       DISPTLIO/INC
          INC       MLTHCPIO/INC
          INC       NHIMASIO/INC
          INC       OUTSITIO/INC
          INC       PATALRIO/INC
          INC       PATASFIO/INC
          INC       PATBFEIO/INC
          INC       PATCFAIO/INC
          INC       PATCMPIO/INC
          INC       PATCMXIO/INC
          INC       PATCMCIO/INC
          INC       PATDSCIO/INC
          INC       PATDRGIO/INC
          INC       PATDGWIO/INC
          INC       PATECDIO/INC
          INC       PATECOIO/INC
          INC       PATFN1IO/INC
          INC       PATFX1IO/INC
          INC       PATHLFIO/INC
          INC       PATLINIO/INC
          INC       PATICDIO/INC
          INC       PATICOIO/INC
          INC       PATICUIO/INC
          INC       PATITMIO/INC
          INC       PATFAPIO/INC
          INC       PATINVIO/INC
          INC       PATHSPIO/INC
          INC       PATGSRIO/INC
          INC       PATMA1IO/INC
          INC       PATMCHIO/INC
          INC       PATMI1IO/INC
          INC       PATNIDIO/INC
          INC       PATPGRIO/INC
          INC       PATTRNIO/INC
          INC       PATWR1IO/INC
          INC       PATMMBIO/INC
          INC       PRIALSIO/INC
          INC       PRIDOCIO/INC
          INC       PRISECIO/INC
          INC       PRIHDBIO/INC
          INC       PRIHREIO/INC
          INC       PRIPRAIO/INC
.
          INC       PATSUSIO/INC
          INC       PATSAIIO/INC
          INC       PATVADIO/INC
          INC       PATWC1IO/INC
          INC       PMSADCIO/INC
          INC       PMSCCDIO/INC
          INC       PMSCIDIO/INC
          INC       PATECMIO/INC
          INC       PMSHCPIO/INC
          INC       PMSHCGIO/INC
          INC       PMSSPEIO/INC
          INC       PMSTEMIO/INC
          INC       PMSRLDIO/INC
          INC       PMSTMDIO/INC
          INC       PMSUPDIO/INC
          INC       PMSWAEIO/INC
          INC       PMSWX1IO/INC
          INC       ACCCMTIO/INC
.
          INC       PATVISIO/INC
          INC       PATDTRIO/INC
          INC       PMSMTIIO/INC
          INC       PMSREGIO/INC
          INC       PMSPRDIO/INC
          INC       PMSPX2IO/INC
          INC       PMSVX1IO/INC
          INC       NZPCMTIO/INC
          INC       NZPCFNIO/INC
          INC       MLTCFNIO/INC
          INC       MEHDLSIO/INC
          INC       MEHHONIO/INC
          INC       NZPPFEIO/INC
.
          INC       OBSAUDIO/INC
          INC       OPRAVEIO/INC
          INC       OPRCSUIO/INC
          INC       OPRDEAIO/INC
          INC       OPRDEDIO/INC
          INC       OPREQPIO/INC
          INC       OPRSESIO/INC
          INC       OPRTRAIO/INC
          INC       OPRTSMIO/INC
          INC       OPROPRIO/INC
.
          INC       OUTBOAIO/INC
          INC       OUTBB1IO/INC
          INC       OUTCVTIO/INC
          INC       RCPBNKIO/INC
          INC       RCPDTEIO/INC
          INC       RCPREGIO/INC
.
          INC       SINCCAIO/INC
          INC       SINCIAIO/INC
          INC       SINCICIO/INC
          INC       SINCIEIO/INC
          INC       SINCSEIO/INC
          INC       SINFACIO/INC
          INC       SINORIIO/INC
          INC       SINPOAIO/INC
          INC       SINPOCIO/INC
          INC       SINSCDIO/INC
          INC       SINSCMIO/INC
.
          INC       TMPJRNIO/INC
.
          INC       WEBGRPIO/INC
          INC       WEBSGPIO/INC
          INC       BOKRC1IO/INC
          INC       BOKRQ1IO/INC
          INC       BOKRX1IO/INC
          INC       EMRSITIO/INC
          INC       IBADPTIO/INC
          INC       WATTR1IO/INC
          INC       WEBHSPIO/INC
.
          INC       CALCAGE
          INC       NHOSPDAY
          INC       PATGNFEE
          INC       PATGILOS
          INC       PATM10T9                * Map ICD10 to ICD9 codes
          INC       RTIODAYS
          INC       RHIHDAYS                * Calc. Hosp In Home Days  *I-902B1
          INC       PATMCHRD                * Miscellaneous Charges read routine
          INC       PATITMRD                * MBS item read routine
.
.  For Grouper
.
          INC       PATW11IO/INC
          INC       PATW12IO/INC
          INC       PTW12BIO/INC
          INC       PATW13IO/INC
          INC       PATW14IO/INC            * Cost Weights for WIES14 *I-145161
          INC       PATW15IO/INC            * Cost Weights for WIES15
          INC       PATW16IO/INC            * Cost Weights for WIES16
          INC       PATW17IO/INC            * Cost Weights for WIES17
          INC       PATW18IO/INC            * Cost Weights for WIES18
          INC       PATW19IO/INC            * Cost Weights for WIES19
          INC       PATW20IO/INC            * Cost Weights for WIES20
          INC       PATW21IO/INC            * Cost Weights for WIES21
          INC       PATWIEIO/INC            * Cost Weights
          INC       PATRDCIO/INC
          INC       PATCHCIO/INC
          INC       PATCRCIO/INC            * Cross Consultations
          INC       PMSEDGIO/INC       * Effective DRG Dates
.
          INC       GETDRG
          INC       CLPATCHC
          INC       CLBOKRX1
          INC       WEBGROUP                * Grouper Routines        *I-190768
          INC       PATDOCCD
          INC       NAMSTRCD
          INC       PATWIS11                * WIES11
          INC       PATWIS12                * WIES12
          INC       PATWIS13                * WIES13
          INC       PATWIS14                * WIES14                  *I-145161
          INC       PATWIS15                * WIES15
          INC       PATWIS16                * WIES16
          INC       PATWIS17                * WIES17
          INC       PATWIS18                * WIES18
          INC       PATWIS19                * WIES19
          INC       PATWIS20                * WIES20
          INC       PATWIS21                * WIES21
          INC       WIESCALC                * WIES
          INC       GETEFDRG
          INC       TFILENAM 
          INC       PATADTYP
