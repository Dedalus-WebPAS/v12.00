.----------------------------------------------------------------------
.
. Program       : ECLWEB25
.
. Function      : WebServices ERAW/BPYW/DVYW Enquiry/Reciepting Release 
.                 Server
.
. Modifications : 
.
.-------------------------------------------------------------------------
. V12.00.03 19/08/2025  Peter Vela     TSK 0939466
.           Added functionality for Eclipse WebServices 
.           Payement DVAW
. V12.00.02 30/06/2025  Peter Vela     TSK 0939466
.           Added functionality for Eclipse WebServices DVAW
. V12.00.01 30/05/2025  Don Nguyen     TSK 0955096
.                       Alphanumeric visit number changes
. V11.04.03 11/09/2024  Alina Bhari    Task 0949453
.           Added Close ERA functionality - ECRM7000
. V11.04.02 26/07/2024  Peter Vela     Task 0949702
.           Recompiled for FHRDATCD 
. V11.04.01 15/03/2024  J.Tan          Task 0919335
.           Mod to check HF History file for HF Group
. V11.03.03 24/07/2023 Thanh T        TSK 0930508
.           Recompiled as PMSVX1TM changes 
. V11.03.02 05/05/2023  J.Tan          TSK 0847250
.           Recompiled for PRIUPURE - fixed payment amount
. V11.03.01 28/02/2023 J.Tan          TSK 0847250
.                      Mod Updating PP Unreconciled invoice(PRIUPURE)
.                      J.Tan          TSK 0909393
.                      Added Hospital id to key opses1
.                      Peter Vela         0929194
.                      Shortened keepalive loopcntr in LTMP0000 and RPAY0000
.                      Peter Vela         0929194
.                      Added Unlock to Partial functionality in ECRT0000
. V11.02.07 15/07/2022 Peter Vela         0922182
.                      Added loop in ECRT0000 and ERTM0000 to check for existing
.                      IHCW / IMCW records
. V11.02.06 07/07/2022 Peter Vela         0918312
.                      Allow display of different ERAW Hospital and Invoice
.                      Hospital in ECRD0000, ERDM0000, ERDD0000
. V11.02.05 06/07/2022 Peter Vela         0918312
.                      Commented out multihospital validation in RPAY0000
.                      RPAM0000 RPAB0000
. V11.02.04 29/06/2022 Peter Vela         0921585
.                      Initialised FORM7P2C with ZERO in ECRT0000 and ERTM0000
. V11.02.03 05/05/2022 Peter Vela     TSK 0918312
.                      Added functionality to ECRE0000 -> RPAY0000
.                      to keep fifo alive at submit
.                      Fixed assignment of WBICAMTP
. V11.02.02 10/02/2022  Thanh T          TSK 0889899
.           Recompiled as WATTR1FD changes
. V11.02.01 09/02/2022 Peter Vela     TSK 0915794
.                      Added invoice number validation for RCBNRCOD in RPAY6100
. V11.01.09 28/10/2021 Peter Vela  Task 0902857
.                      Fixed literals for _erawrtvw_response and
.                      _erawrtvw_errors
. V11.01.08 11/10/2021 Peter Vela  Task 0898361
.                      Added mutiple and date range transaction types in 
.                      ATRN0000
. V11.01.07 29/09/2021 Peter Vela  Task 0898361
.                      Validate "Services Australia" when releasing ERAWs
. V11.01.06 16/09/2021 Peter Vela  Task 0909175
.                      Added BBSW BPYW functionality
. V11.01.05 15/09/2021 Peter Vela  Task 0909175
.                      Added transaction type to the webetraf validation in
.                      TJSN0000
. V11.01.04 08/09/2021 Peter Vela  Task 0909175
.                      Added BPRW/BPYW transaction request viewing
.                      functionality
. V11.01.03 13/05/2021 Peter Vela  Task 0902857
.                      Added Transaction Requests JSON dashboard
. V11.01.02 04/05/2021 Peter Vela  Task 0902857
.                      Added IHCW ERAW RTVW functionality
. V11.01.01 27/04/2021 Thanh T        TSK 0895165
.           Recompiled for OPRARDFD changes
.           02/02/2021 Peter Vela  Task 0898361
.                      Created server.
.----------------------------------------------------------------------
          INC       IBAWEBDF    
          INC       WEBDATDF    
          INC       RSHWEBDF
.
          INC       FHRDATDF
          INC       TFILEVAR/INC
          INC       APSMASFD/INC
          INC       AAEDE1FD/INC
          INC       BOKDIAFD/INC
          INC       BOKRX1FD/INC
          INC       FMSCSAFD/INC
          INC       FMSLMAFD/INC      * Ledger Master Details
          INC       EMRVISFD/INC
          INC       IBAPOSFD/INC
          INC       IBALPCFD/INC
          INC       BOKRC1FD/INC     
          INC       MEHLERFD/INC
          INC       MLTSECFD/INC
          INC       OPRARDFD/INC
          INC       OPRSRGFD/INC  
          INC       OPRCONFD/INC
          INC       OPRDEAFD/INC
          INC       OPROPRFD/INC
          INC       OPRSESFD/INC            * Theatre Sessions Table
          INC       OPRSEMFD/INC            * Theatre Session Master
          INC       OUTSITFD/INC
          INC       OUTBOAFD/INC
          INC       OUTBB1FD/INC
.
          INC       WEBBBSFD/INC
          INC       WEBBRHFD/INC
          INC       WEBBRDFD/INC
          INC       WEBBBAFD/INC
          INC       WEBBBDFD/INC
.
          INC       WEBDVWFD/INC
          INC       WEBDVHFD/INC
          INC       WEBDVIFD/INC
          INC       WEBDVAFD/INC
          INC       WEBDVDFD/INC
.
          INC       PATBMDFD/INC
          INC       PATRE1FD/INC
          INC       PATRE1TD/INC
          INC       PATREMFD/INC
          INC       PATRGMFD/INC
          INC       PATPARFD/INC 
.
          INC       PMSCCDFD/INC   * Concession Card Details
          INC       PMSBDCFD/INC
          INC       PMSBRQFD/INC
          INC       PMSDTCFD/INC
.         INC       PMSEAHFD/INC
.         INC       PRIEAHFD/INC
.         INC       PMSEADFD/INC
.         INC       PRIEADFD/INC
.         INC       PMSEBHFD/INC
.         INC       PRIIBHFD/INC
.         INC       PMSERDFD/INC
.         INC       PMSERHFD/INC
.         INC       PMSECAFD/INC
.         INC       PRIECAFD/INC
.         INC       PMSECOFD/INC
.         INC       PMSETRFD/INC
.         INC       PMSECTFD/INC
          INC       PRIPRAFD/INC
.         INC       PRIECTFD/INC
          INC       PRIINVFD/INC
.         INC       PMSESHFD/INC
.         INC       PRIESHFD/INC
.         INC       PMSESDFD/INC
.         INC       PRIESDFD/INC
          INC       PMSREGFD/INC
          INC       PMSUCHFD/INC
          INC       PMSUCDFD/INC
          INC       PATMASTD/INC
          INC       PATALRFD/INC
          INC       PATASFFD/INC
          INC       PATATRFD/INC
          INC       PATATRTD/INC
          INC       PATBRDFD/INC
          INC       PATBRDTD/INC
          INC       PATDADFD/INC
          INC       PATDGWFD/INC
          INC       PATDSCFD/INC
          INC       PATDTRFD/INC
          INC       PRIDTRFD/INC
          INC       PRIHDBFD/INC
          INC       PRIHREFD/INC
          INC       PATHSPFD/INC
          INC       PATNIDFD/INC
          INC       PATHFRFD/INC
          INC       PATTRNFD/INC
          INC       PATELGFD/INC
....          INC       HL7BMTFD/INC
          INC       PATMA1FD/INC
          INC       PATNURFD/INC
          INC       PMSHCGFD/INC
          INC       PMSHCPFD/INC
          INC       PMSPX2FD/INC
          INC       PMSPX2TD/INC
          INC       PATMI1FD/INC
          INC       PATDHEAD/INC
          INC       PATNOBFD/INC
          INC       PATDO1FD/INC
          INC       PATIN1FD/INC
          INC       PATINVFD/INC
          INC       PATITMFD/INC
          INC       PATVADFD/INC
          INC       PATVENFD/INC
          INC       PATVISFD/INC
          INC       VISCMTFD/INC
          INC       PATUREFD/INC
          INC       PATWR1FD/INC
          INC       PATLOCFD/INC
          INC       PATONLFD/INC
          INC       PATCALAG/INC
          INC       PATCONFD/INC
          INC       PATCMCFD/INC
          INC       VISMDTFD/INC
          INC       VISMTXFD/INC
          INC       PATMISTD/INC 
          INC       PATPR1FD/INC
          INC       PMSRCBFD/INC
          INC       MRTLOCFD/INC
          INC       RESLNKFD/INC
          INC       PATFN1FD/INC
          INC       PATFX1FD/INC
          INC       MRTMASFD/INC
          INC       PATDAYFD/INC            * HPS Code Starts Here 
          INC       PATDDHFD/INC
          INC       PMSEVTFD/INC
          INC       PMSPDPFD/INC            * HPS Code Ends Here
          INC       PMSWORFD/INC
          INC       PMSWORTD/INC
.
          INC       PMSHCGTD/INC
          INC       PMSHCPTD/INC
          INC       PMSVX1TD/INC
          INC       PMSQPTFD/INC
          INC       PMSQVIFD/INC
          INC       PMSVX1FD/INC
          INC       PMSNUTFD/INC            * v9.02.08
          INC       PMSNUTTD/INC            * v9.02.08
          INC       CATCOMFD/INC
          INC       CATCOMTD/INC
          INC       RCPBDTFD/INC
          INC       RCPBNKFD/INC
          INC       RCPDTEFD/INC
          INC       RCPCONFD/INC
          INC       RCPREGFD/INC
          INC       NHIMASFD/INC
          INC       NHIETHFD/INC
          INC       WATTR1FD/INC
.
          INC       WEBIMBFD/INC
          INC       WEBIHBFD/INC
          INC       WEBERDFD/INC
          INC       WEBERHFD/INC
          INC       WEBIMAFD/INC
          INC       WEBIHAFD/INC
          INC       WEBECOFD/INC
          INC       WEBETRFD/INC
          INC       WEBIMCFD/INC
          INC       WEBIHCFD/INC
          INC       WEBB2BFD/INC
          INC       WEBIMDFD/INC
          INC       WEBIHDFD/INC
          INC       WEBPARFD/INC
.
          INC       OBSDETFD/INC      * Observations on Ward Map
          INC       PMSCURFD/INC
.
ACCNO     DIM       12
ADJTIME   FORM      5
ADMSTAT   FORM      1
ALTVIEW1  FORM      1                       * 0=No, 1=Yes
ALLHFLAG  FORM      1       * 'All' hospital flag
ANATCODE  DIM       6       
ANATNAME  DIM       50      
ANAESTFL  DIM       1       
ANATFLAG  FORM      1
ANATDES1  DIM       50    
ANATDES2  DIM       50   
ANATDES3  DIM       50  
ANATTHET  DIM       25
ANATTYPE  DIM       25
ANATTRAN  DIM       25
ANATANAE  DIM       25
ANATDATE  DIM       8
ANATTIME  DIM       5
ANATEXPS  DIM       5
ANATEXPD  DIM       4
ALRTCODE  DIM       20[99]           * Array of alert codes
POSTOPFL  FORM      1
POSTWBED  DIM       50
BMIINDIC  DIM       1
CREATEDB  DIM       65
CURSTATS  DIM       25
CURSTATT  DIM       40
CURSTATB  DIM       5                * Current status recovery bay
CURSTATC  DIM       5                * Current status recovery bay no ()
DUPNMFLG  FORM      1
SAVCLASS  DIM       3
STAPRFIX  INIT      "RIP - " * Prefix for Patient Status
SKEY31    DIM       31
SAVDIM35  DIM       35                                                *I-174468
SAVTXWRD  DIM       3
ASESDESC  DIM       7
BORDICIN  FORM      1
BODMASIN  DIM       5
BODMASRN  DIM       60
BODMASUW  INIT      "<font color=purple>"
BODMASHE  INIT      "<font color=black>"
BODMASFT  INIT      "<font color=red>"
BOLD      INIT      "<b>"
EDITFLAG  FORM      1
ENDBOLD   INIT      "</b>"
ENDFONT   INIT      "</font>"
BMCMDIM8  DIM       8
BULKDSCH  FORM      1
BTSCHOSP  DIM       3
CNOTFLAG  FORM      1                            * display clinical notes flag
DISPUDF4  FORM      1                            * display pmvxudf4 (1=no)
DISPLUPD  DIM       12
DISPLUTM  DIM       8
DISPTHET  FORM      1
DISPMV    FORM      1
EXDTBLNK  FORM      1
EXTRDIET  FORM      1
CLAIMSTA  DIM       2
CLAMTOTL  FORM      7.2
PROCSTAT  DIM       1
VALDTYPE  FORM      1
BATCHNUM  DIM       8
EXCLCLOS  FORM      1
EXCLWAIT  FORM      1
EXPTTYPE  FORM      1
FASTVIEW  FORM      5
SJOGVIEW  FORM      1
STVVIEW   DIM       1                                               * Car 262343
HEAVIEW   FORM      1
FONTRSTR  INIT      "<font color=red>"
FONTREND  INIT      "</font>"
FORM8A    FORM      8
FORM7P2C  FORM      7.2
FORM10P2  FORM      10.2
FORM12P2  FORM      12.2
FORM12    FORM      12
FORMTYPE  FORM      1
FILTURNO  DIM       8
FILTADMN  DIM       8
FILTHOSP  DIM       3
CODN      INIT      "n"
CODS      INIT      "s"
CMDLINE   DIM       200
CLBDINDC  FORM      1
DEBDINDC  DIM       1
DEFTVIEW  FORM      1
LSFLAG    DIM       1
DESCML01  DIM       20
DESCML02  DIM       20
DESCML03  DIM       20
DESCML04  DIM       20
DESCML05  DIM       20
DESCML06  DIM       20
DESCML07  DIM       20
DESCDPST  DIM       20
ECCLSTRD  DIM       24
ECCLTYPE  DIM       2
ECCLHOSP  DIM       3
TDAYMON   DIM       4                       * HPS Code Starts Here
TOGGLEXP  FORM      1
DATE8     DATE      8
DFLTWARD  DIM       3  * ward to be pre-selected on ward selection list 
DIFCINDC  DIM       1
DIETDESC  DIM       25
DIETDSC2  DIM       25
DIETDSC3  DIM       25
DIETDSC4  DIM       25
DIETDSC5  DIM       25
DIM1A     DIM       1
DIM1B     DIM       1
DIM1C     DIM       1
DIM10     DIM       10
DIM10A    DIM       10
DIM10B    DIM       10
DIM20     DIM       20
DIM11     DIM       11
DIM15     DIM       15
DIM4      DIM       4
DIM40     DIM       40
DIM40A    DIM       40
DIM40B    DIM       40
DIM40C    DIM       40
DIM5      DIM       5
DIM5A     DIM       5
DIM7      DIM       7
DIM9      DIM       9
DIM12     DIM       12
DIM50     DIM       50
DIM127A   DIM       127
DISCATDD  FORM      1
D3A       DIM       3
DAYKEY    DIM       4
DEFTFLAG  DIM       1
DIM3      DIM       3
DOCTORC   DIM       10
EMRGVIEW  FORM      1
EMVIFLAG  FORM      1
FULLSTOP  INIT      "."
FOLDRNAM  DIM       40
FOLDRTYP  FORM      1
FORM1A    FORM      1
.FOLDER2   INIT      "PatientFolder.gif"
.FOLDER1   INIT      "FolderAlert.gif"
FOLDER0   INIT      "PatientFolder.gif"
FOLDER1   INIT      "FolderAlert.gif"
FOLDER2   INIT      "FolderAlertBlack.gif"
FOLDER3   INIT      "FolderAlertDelete.gif"
FOLDER4   INIT      "FolderAlertGreen.gif"
FOLDER5   INIT      "FolderAlertBlue.gif"
FOLDER6   INIT      "FolderAlertYellow.gif"
FOLDER7   INIT      "FolderAlertOrange.gif"
FOLDER8   INIT      "FolderAlertPurple.gif"
FOLDER9   INIT      "FolderAlertRed.gif"
CSPAN     DIM       2
CLOSEDEP  FORM      1
CONLINK   DIM       127
CONDINDC  DIM       1
CSPANUM   FORM      2
CELLCOLR  DIM       20
CRSRTCNT  FORM      3
DISPPREP  DIM       20
DISPUSR2  DIM       20
DISPBBDT  DIM       11
DISPBSDT  DIM       11
EXPDSTME  DIM       5        * Calculated Expected Discharge Time
ERDCOUNT  FORM      8
PRLCOUNT  FORM      8
RELCOUNT  FORM      8
BATCHTOT  FORM      12.2
FORM2P1   FORM      2.1
FORM2P1A  FORM      2.1
FORM2P2   FORM      2.2
FORM2P2A  FORM      2.2
FORM4P2   FORM      4.2
FORM3     FORM      3
FORM4B    FORM      4
FORM6     FORM      6
FORM6A    FORM      6
FORM6P1   FORM      6.1
FORM6P1A  FORM      6.1
FILTDPST  DIM       3
FILTCLAI  DIM       3
FLAGID    DIM       1
FLGITMNO  FORM      1
FREETXT1  DIM       40
FREETXT2  DIM       40
FREETXT3  DIM       40
FREETXT4  DIM       40
FREETXT5  DIM       40
FREETXT6  DIM       40
FREETXT7  DIM       40
FRMCOD01  DIM       6       * Stationery Code for Form 1
FRMCOD02  DIM       6       * Stationery Code for Form 2
FRMCOD03  DIM       6       * Stationery Code for Form 3
FRMPNO01  DIM       3       * Number of Labels for Form 1
FRMPNO02  DIM       3       * Number of Labels for Form 2
FRMPNO03  DIM       3       * Number of Labels for Form 3
FRMPRT01  DIM       1       * Print Indicator - Form 1
FRMPRT02  DIM       1       * Print Indicator - Form 2
FRMPRT03  DIM       1       * Print Indicator - Form 3
FRMPSL01  DIM       6       * Printer Selected for Form 1
FRMPSL02  DIM       6       * Printer Selected for Form 2
FRMPSL03  DIM       6       * Printer Selected for Form 3
INPLABAR  DIM       8[100]           * Array of inpatient records
HYPHEN    INIT      "-"
HLTHFUND  DIM       6
HLFDCLTY  DIM       1
INVNUMBR  DIM       8
KEY8A     DIM       8
KEY16A    DIM       16
LABELTYP  DIM       10
LABPRT01  DIM       1       * Print Indicator - Address Label
LABPRT02  DIM       1       * Print Indicator - PMI Label
LABPRT03  DIM       1       * Print Indicator - INP Label
LABPRT04  DIM       1       * Print Indicator - GP Mailing Label
LABPNO01  DIM       3       * Number of Labels for Address Label
LABPNO02  DIM       3       * Number of Labels for PMI Label
LABPNO03  DIM       3       * Number of Labels for Inpatient Label
LABPNO04  DIM       3       * Number of Labels for GP Mailing Label
LABPSL01  DIM       6       * Printer Selected - Address Label
LABPSL02  DIM       6       * Printer Selected - PMI Label
LABPSL03  DIM       6       * Printer Selected - Inpatient Label
LABPSL04  DIM       6       * Printer Selected - GP Mailing Label
LOOPCNTR  FORM      8
NURSTCOD  DIM       3       * Nursing Station code
NURSTNUM  DIM       20      * Nursing Station extension number
OUTLTYPE  DIM       3       * Outlier booking type
BEDMSGID  FORM      1
BDMSGCLS  DIM       23
BDMSGTXT  DIM       16
RYEAR     DIM       4
MEALDATE  DIM       16
MULTHOSP  DIM       50
NBSP      INIT      "&nbsp;"
PATNLOCN  DIM       3
PTMIS038  DIM       3
PRNTLABL  DIM       1
PTKEYCNT  FORM      3
PTCOUNT   FORM      3
NEXTPATF  DIM       1
SERVDATE  DIM       8 
SERVDAT1  DIM       8 
SECDOCDE  DIM       40                      * Secondary Doctor
PARTCODE  DIM       3
PARTNUMB  DIM       4
PSAGEDIM  DIM       3
PMSPD001  DIM       10
PMSPD002  DIM       1 
PMHFILAF  FILE      ASCII, FIXED=127
WDIFILAF  FILE      ASCII, FIXED=127
CLNFILAF  FILE      ASCII, FIXED=127
PMHFILNM  DIM       8
WDIFILNM  DIM       8
CLNFILNM  DIM       8
LASTITEM  FORM      3
LASTITM2  FORM      3
LASTITM3  FORM      3
PTDSC002  DIM       8
DEFTALLH  FORM      1
SHIFTNUM  DIM       1                       * HPS Code Ends Here
SERDIM50  DIM       50
FOLDERSF  DIM       3                       * Folder Icon Suffix
ADMITDAY  FORM      5
FILETYPE  FORM      1
TCOLSPAN  FORM      1
RECFOUND  FORM      1
RECPTIND  DIM       1
SAVTDATE  DIM       8
SAVKEY12  DIM       12
SAVKEY24  DIM       24
SAVETRID  DIM       24
SAVEVISN  DIM       8
CALCEXLS  DIM       1
CLMUNIID  DIM       6
ECCLFBID  DIM       3
ECCLARID  DIM       20
ECCLFRID  DIM       12
ECCLRPTC  DIM       3
ECCLSCOD  DIM       11
ECCLSRVC  DIM       3
ECOTFUND  DIM       6
ECOTTYPE  DIM       1
ECOTTRID  DIM       24
FUNDTRID  DIM       24
ECREPYPN  DIM       8
ECREPRUN  DIM       4
ECREPDAT  DIM       8
ECRERKEY  DIM       24
ECRECLID  DIM       6
.ECREPYRN  DIM       4
.ECREPYRD  DIM       8
.ECRERRKY  DIM       24
ECREADVC  DIM       30
ECREPTNO  DIM       4
ECRETRID  DIM       24
ECRECLAM  DIM       6
ECREFTID  DIM       24
ECRERADV  DIM       30
ECREPNUM  DIM       4
FMTPATAG  DIM       10
HOSPCODE  DIM       3  
HOSPNAME  DIM       50
LENPTR    FORM      2
COUNT     FORM      2
TRANOUT   FORM      1
NOCATCOM  FORM      1
NOATTRIB  FORM      1
.
EXPDSDTE  DIM       8        * Calculated Expected Discharge Date
FORM3A    FORM      3
LOSDINDC  FORM      1
PAYEEPNO  DIM       8
PAYMTRUN  DIM       4
PAYMRUND  DIM       8
RETRVKEY  DIM       24
PAYRUNNO  DIM       4
PAYRUNDT  DIM       8
REPRETKY  DIM       24
PROVNUMB  DIM       8
PTRGM001  DIM       10
PTRGM002  DIM       10
PTRGM003  DIM       10
SAVKEY9   DIM       9
SAVEADMO  DIM       8
SAVEBRQN  DIM       8
SAVEDATE  DIM       8
SAVELOSD  DIM       3
SAVELOSM  DIM       5
SAVETIME  DIM       5
STAYDAYS  FORM      5
LOOPDAYS  FORM      5
CNTREADS  FORM      8
STVCVIEW  FORM      1
TRANDATE  DIM       8
TRANTIME  DIM       8
TRNTOBED  DIM       3
TRNTOWRD  DIM       3
TTYPEARG  DIM       2
PWDVTYPE  DIM       1
.
MAVBATCH  DIM       8
MAVINVCE  DIM       8
MBSDESC   DIM       40
MOVEDESC  DIM       35
MOVETYPE  FORM      1
MOVEADM   INIT      "Admission"
MOVEBED   INIT      "Transfer Bed"
MOVEDSC   INIT      "Discharge"
MOVETIN   INIT      "Transfer In"
MOVELVO   INIT      "Sent On Leave"
MOVELVI   INIT      "Return from Leave"
MOVETOT   INIT      "Transfer Out"
MOVESPC   INIT      "Doctor/Specialty Change"
MULTLT01  DIM       1
NEXTPAGE  DIM       1
NULL      EQU      000
OVERRIND  FORM      1
OVFLDESC  DIM       40                                               *C-0837181
PAYMTKEY  DIM       47
REMITKEY  DIM       61
SAVEADMN  DIM       8
SAVELOCN  DIM       8
SAVEREGM  DIM       10
STRTTIME  DIM       8
SAVETYPE  DIM       3
SAVEDOCT  DIM       6
SAVEWARD  DIM       3
SAVEBED   DIM       3
SAVKEY30  DIM       30
SAVPSNAM  DIM       20                      * Save PSNAME
SETDFPRG  DIM       8
SETDFRPT  FORM      2
SAVHDSEC  FORM      5
SAVREPTN  FORM      2
SAVPRGID  DIM       8
SHRTNAME  DIM       25
STATNCOD  DIM       6   
SUBSYSKY  DIM       50
TEMPDATE  DIM       8
TEMPSTAT  DIM       1
TEMPTIME  DIM       8
TEMPURNO  DIM       8
TESTDAT1  DIM       14
TESTDAT2  DIM       14
TEMPFILE  DIM       8
UPDATETY  DIM       1
UPDATET2  FORM      1
UPDATEDB  DIM       65
UNRELREM  DIM       1
UNRELINQ  DIM       1
ERASTATS  DIM       1
UNLKFLAG  FORM      1
VIEWONLY  FORM      1
VISITNUM  DIM       8                                                *C-0837181
WSDEINDC  DIM       1
.
FORM7P2O  FORM      7.2
FORM8     FORM      8
NUMOFPAT  FORM      3
NOBEDWRD  FORM      1
SDOCFNAM  DIM       50
DIM8      DIM       8
DIM8A     DIM       8
DIM8B     DIM       8
DIM8C     DIM       8
DIM8D     DIM       8
DIM8E     DIM       8
DIM16     DIM       16
DIM24     DIM       24
DIM32     DIM       32
DIETCODE  DIM       3
DIETTYPE  DIM       3                       * Diet Type (used for filter)
DIETCOMM  DIM       40
DIETFILT  FORM      1                       * Flag - are Diet filters being used
DIETNCDE  DIM       10                      * Dietitian code (used for filter)
DIETNNAM  DIM       35                      * Dietitian name (disp for filter)
DIM35     DIM       35 
DOSASTAT  DIM       3                       * DOSA status Yes/No/Unkown
PATCONCD  DIM       3
PATCONDS  DIM       35
PATCONVA  DIM       1
PATCONPA  DIM       1
PATCONAM  DIM       3
PATCONTL  DIM       50                      * Pat Condition - Temporary Location
PTVIS067  DIM       50                      * Diet Comment - I SRF 22685
CODEA     INIT      "A "
CODEAM    INIT      "AM"                    * Category for Ambulatory status 
CODECO    INIT      "CO"
CONTDESC  DIM       16
CONTDES1  INIT      "Not in series   "
CONTDES2  INIT      "First in series "
CONTDES3  INIT      "Last in series  "
CONTDES4  INIT      "Middle in series"
COLRFLAG  DIM       15
CURRDATE  DIM       8                       * current date in format CCYYMMDD
CURRTIME  DIM       8
EXPCDATE  DIM       8                       * expc discharge date in CCYYMMDD
EXPLRETN  DIM       43                      * Exp return from leave date/time
IMGSRC    DIM       20
CAT       INIT      "BK"                    * category from BKRETYPE
CATCL     INIT      "CL"
CATDC     INIT      "DC"
CATME     INIT      "ME"                    * category ME for Diet Meal Code
CATMJ     INIT      "MJ"                    * category MJ for Diet Type
CATMK     INIT      "MK"                    * category MK for Diet Assistnce lv
CATMM     INIT      "MM"                    * category MM for Diet Other Detail
CATSN     INIT      "sn"                    * category sn Special Needs Code
CATVI     INIT      "VI"                    * category VI for Intended Stay
CATLVI    INIT      "vi"                    * category vi Discharge Prep Status
DTOTHDTL  DIM       20                      * Diet - other details description
DTDTTYPE  DIM       20                      * Diet - diet type description
DTMENUCD  DIM       20                      * Diet - menu code description
DTASSLEV  DIM       20                      * Diet - assistance level desc
DTDTNNAM  DIM       20                      * Diet - Dietitians name
DTFASTNG  DIM       6                       * Diet - Fasting indicator
CONDESC   DIM       25
CONDESC1  DIM       20
DATESTR   DIM       12
DATEEND   DIM       12
THREE6    FORM      "36"
THETODAY  FORM      1                 * Theatre today
FORM5     FORM      5
FORM5A    FORM      5
FOUR8     FORM      "48"      
INCMACCT  DIM       14                * Saved Income Accont
ROWHEAD   DIM       40
LEDNO     DIM       2
LOCNCODE  DIM       4
FIRSTONL  FORM      1
FIRSTCEL  FORM      2
STBYFLAG  FORM      1
DLINKPRG  DIM       8
DLINKREP  DIM       2
DLINKTEM  DIM       3
REMITADV  DIM       30
RECCNT    FORM      4
DRECCNT   DIM       4
FLAG      FORM      1
EXDIFLAG  DIM       1                       * I CAR 38459
SAVKEY6   DIM       6
SAVKEY27  DIM       27
SAVKEY45  DIM       45
SAVKEY47  DIM       47
LASTWARD  DIM       3 
NEXTPATN  DIM       127
NEXTPATM  DIM       1
KIDSONLY  FORM      1
KIDSVEW2  FORM      1
WARDCODE  DIM       3
WARDNAME  DIM       20
WBEDDESC  FORM      1
WARDKEY   DIM       3                       * Ward Code                         
WARDTEXT  DIM       20                                                          
BEDKEY    DIM       3                       * Ward Code                         
BEDTEXT   DIM       20                                                          
WBEDTEXT  DIM       43                                                          
WATCOUNT  DIM       2
RECCOUNT  FORM      4
DISPNUMB  FORM      4
EMPTONLY  FORM      1               
ADMNOF6   FORM      6               
FORMACTN  DIM       5               
DOCTCODE  DIM       6
DIETDRCD  DIM       6
DIM27     DIM       27
DOCGNAME  DIM       25
DOCSNAME  DIM       20              
DOCTITLE  DIM       9              
PDIAGNOS  DIM       50
PWARD     DIM       3 
PBED      DIM       3 
BEDSTAT   FORM      1
MALE      INIT       "M"               
PATCOUNT  FORM      8
FILWIDTH  DIM       10
FILHIGHT  DIM       12
FILHIGH   FORM      3 
PERCENT   FORM      3.1
EXPCTDSC  DIM       20
ADMISDAT  DIM       12
BOOKNDAT  DIM       12 
BOOKSTAT  DIM       12 
ERASUSIN  FORM      1
PATBNAME  DIM       40
DIM30     DIM       30 
DIM80     DIM       80 
OPTIONZ   DIM       1
ONLVFLAG  FORM      1
MVFLAG    FORM      1
MEHLSFLG  FORM      1
STATUS    DIM       1
STATDESC  DIM       11
BED       DIM       7
TFLAG     FORM      1         * indicator flag, uses booking time or TH time 
TIME      DIM       5          
TMBDARRY  DIM       38[48]
TIMEARRY  DIM       11[48]     * Time array 30 minute slots
TMARRCNT  FORM      3
DATEARRY  DIM       11[7]     * Date array
DMBDARRY  DIM       40[7]
DMARRCNT  FORM      3
ATTIME    DIM       3 
AT        INIT      "at "     * display html between date and time 
PATLINK   DIM       127                     * Link to the next patient info
DESTDESC  DIM       20
DISPDATE  DIM       13        * display variable for patient condition date
WBEDTYPE  FORM      1         * CGI variable for ward bed type selection
.                             0 = All , 1 = Open Beds, 2 = Empty Beds Only
NMPNUMB   DIM       20
NUMNOBED  FORM      5         * Number of patients not allocated a bed
NUMEMBED  FORM      5         * Number of empty beds
NUMBPATS  FORM      5         * Number of Patients
NUMBREXP  FORM      5         * Number of expected patients
SAVNOBED  FORM      5         * Number of patients not allocated a bed
SAVEMBED  FORM      5         * Number of empty beds
SAVBPATS  FORM      5         * Number of Patients
SAVEPART  DIM       3
SKIPDIET  DIM       1         * Skip Diet Text
SUPERECL  FORM      1         * Eclipse Supervisor flag (1=yes/0=no)
.
TEMPINVN  DIM       8         * Invoice Number
TEMPBATN  DIM       8         * Batch Number
TEMPADMN  DIM       8         * Admission Number
.TEMPURNO  DIM       8         * U/R Number
TEMPHFND  DIM       6         * Health Fund
TEMPPBAT  DIM       8         * Previous Batch Number
TEMPHOSP  DIM       3         * Hospital Code
TYPEDESC  DIM       20
TYPOFREQ  FORM      2             * Eclipse type of request
.
UPDLINK   DIM       127
UPDLNKP   DIM       127
.
CLOSEFLG  DIM       1         * Bed Closed Flag, 0 = Not Closed, 1 = Closed
.
LEAVFLAG  DIM       1
MHLSFLAG  DIM       1
VIEWINDI  FORM      1
RSUBINDI  FORM      1
VISPHONE  DIM       32
.
WORCOMAF  FILE      ASCII, FIXED=127        * For Presenting Complaint
WORCOMNM  DIM       8
.
WORCOMFL  FORM      1
WORKDFLG  FORM      1
WORKFLAG  DIM       1
WORKDESC  DIM       280
.
ATTMPFAF  FILE      ASCII, FIXED=127        * For Attribute Notes temp file
ATTMPFIL  DIM       8        * Patient Attribute notes temp file name
ATWDIAFN  DIM       8        * Patient Attribute Working Diagnosis filename
ATMHISFN  DIM       8        * Patient Attribute Medical History filename
ATBDISFN  DIM       8        * Patient Attirbute Barriers to Discharge
.
MINSDIFF  DIM       6        * Minutes difference between 2 dates
PATATURN  DIM       8        * Patient Attribute UR no.
PATATVIS  DIM       8        * Patient Attribute Visit no.
PATATNOT  DIM       3        * Patient Attribute Note Type
ATTRNOTE  DIM       250      * Patient Attribute Notes (PTARTXT1-PTARTXT3)
.
WDBDSRCH  DIM       1        * Ward/Bed Search View flag (readonly output)
.
PIPE      INIT      "|"
.
UKEY      INIT      " 86 U1-24 U83-85,1-24"
.
.         Temporary File Definition
.         -------------------------
.
.         Filename : pms07axx.dat          (xx = port id)
.
ECLTEMP1  IFILE SQL, FIXED=86, KEY="U1-24"
ECLTEMP2  IFILE SQL, FIXED=86, KEY="U83-85,1-24"
.
.NAME     TYPE    LENGTH     PHYSICAL     START     DESCRIPTION
.----     ----    ------     --------     -----     -----------
.WBEJTRID DIM       24         24           1       Transaction ID
.WBEJFTID DIM       24         24          25       Fund Transaction ID
.WBEJRADV DIM       30         30          49       Remittance Advice ID
.WBEJPNUM DIM       4           4          79       Part Number
PARTPANT  DIM       3           3          83       Participant
.         
.End of Record                             86
.
ASESDES1  INIT      "Accept."
ASESDES2  INIT      "Reject."
ASESDES3  INIT      "Warning"
ASESDES4  INIT      "Compl. "
ASESDES5  INIT      "I-Acc. "
.
ERASE     INIT      "iserase "
ISBUILD   INIT      "isbuild "
.
LBRACKT   INIT      "("
RBRACKT   INIT      ")"
CATD      INIT      "D "
CATDD     INIT      "DD"
CATH3     INIT      "H3"              * Food Allergy
CATH6     INIT      "H6"              * Food Allergy
BOOKED    INIT      "Booked"
PREADM    INIT      "Pre-admitted"
CANCEL    INIT      "Cancelled"
ADMITT    INIT      "Admitted"
DISCHR    INIT      "Discharged" 
LABELINP  INIT      "LABELINP"
LABELPMI  INIT      "LABELPMI"
LABELADD  INIT      "LABELADD"
HTMLBR    INIT      "<br />"
LABREQST  INIT      "Req : "
.
SEC1      FORM      "00001"
.
STATUS00  INIT      "Waiting    "
STATUS01  INIT      "Ext. Error "
STATUS02  INIT      "Extracted  "
STATUS03  INIT      "SA Error   "
STATUS04  INIT      "Received   "
STATUS05  INIT      "Unverified "
STATUS06  INIT      "Verified   "
STATUS07  INIT      "Assessing  "
STATUS08  INIT      "Int. Ready "
STATUS09  INIT      "Int. Report"
STATUS10  INIT      "Ready Rej. "
STATUS11  INIT      "Ready Comp."
STATUS12  INIT      "Rej. Report"
STATUS13  INIT      "Com. Report"
STATUS14  INIT      "Rem. Report"
STATUS15  INIT      "Closed     "
.
TYPEDES1  INIT      "Status Request      "
TYPEDES2  INIT      "Status Req. Response"
TYPEDES3  INIT      "Report Request      "
TYPEDES4  INIT      "Report Req. Response"
TYPEDES5  INIT      "Viewed              "
TYPEDES6  INIT      "Data Error          "
TYPEDES7  INIT      "Trans. Error        "
ZERO4     INIT      "0000"
Z20       INIT      "zzzzzzzzzzzzzzzzzzzz"
FRBRACK   INIT      " / "
.
SPECDESC  DIM       25
FUNDDESC  DIM       50
RGMCOD01  DIM       10
RGMCOD02  DIM       10
RGMCOD03  DIM       10
RGMNAM01  DIM       40
RGMNAM02  DIM       40
RGMNAM03  DIM       40
RGMSTA01  DIM       1
RGMSTA02  DIM       1
RGMSTA03  DIM       1
ONLEAVE   FORM      1
RTTDESC  DIM       25
BVTDESC  DIM       25
BWTDESC  DIM       25
CATVA     INIT      "va"
CATVB     INIT      "vb"
CATVC     INIT      "vc"
CATVD     INIT      "vd"
CATVE     INIT      "ve"
CATVF     INIT      "vf"
CATVG     INIT      "vg"
CATVH     INIT      "vh"
NAMECTVA  DIM       25
NAMECTVB  DIM       25
NAMECTVC  DIM       25
NAMECTVD  DIM       25
NAMECTVE  DIM       25
NAMECTVF  DIM       25
NAMECTVG  DIM       25
NAMECTVH  DIM       25
USERDF01  DIM       100
USERDF02  DIM       100
USERDF03  DIM       100
USERDF04  DIM       100
USERDF05  DIM       100
USERDF06  DIM       100
USERDF07  DIM       100
USERDF08  DIM       100
USERDF09  DIM       100
USERDF10  DIM       100
BOARDERS  FORM      2
DIETCNT   FORM      2
BPRNT     DIM       1[999]
BADMN     DIM       8[999]
.
DISPDNAM  FORM      1        * Display duplicate surname icons
ID        DIM       8
WDBEDTXT  DIM       40
ATNSECDC  DIM       40     * Attending Doc and Secondary Doc
ENSTATUS  DIM       20
LCSTATUS  DIM       20
FHRSUBIN  FORM      1
TIMEZONE  DIM       6
TZFILE    FILE      ASCII, FIXED=256
.
PROPFLNM  DIM       35
PROPFILE  FILE      ASCII,FIXED=256
PROPLITR  INIT      ".properties"
PROPLINE  DIM       150
.
ERAWFLNM  DIM       33
ERAWFILE  FILE      ASCII,FIXED=256
ERAWLITR  INIT      "_erawrtvw"
ERAWLINE  DIM       150
.
ERARFLNM  DIM       38
ERARFILE  FILE      ASCII,FIXED=500
ERARLITR  INIT      "_erawrtvw_response"
ERARLINE  DIM       150
.
ERAEFLNM  DIM       36
ERAEFILE  FILE      ASCII,FIXED=500
ERAELITR  INIT      "_erawrtvw_errors"
ERAELINE  DIM       150
.
TRNWFLNM  DIM       33
TRNWFILE  FILE      ASCII,FIXED=256
TRNWLINE  DIM       150
.
TRNRFLNM  DIM       38
TRNRFILE  FILE      ASCII,FIXED=500
TRNRLINE  DIM       150
.
TRNEFLNM  DIM       36
TRNEFILE  FILE      ASCII,FIXED=500
TRNELINE  DIM       150
.
BPYWFLNM  DIM       29
BPYWFILE  FILE      ASCII,FIXED=256
BPYWLITR  INIT      "_bpyw"
BPYWLINE  DIM       150
.
BPYRFLNM  DIM       38
BPYRFILE  FILE      ASCII,FIXED=500
BPYRLITR  INIT      "_bpyw_response"
BPYRLINE  DIM       150
.
BPYEFLNM  DIM       36
BPYEFILE  FILE      ASCII,FIXED=500
BPYELITR  INIT      "_bpyw_errors"
BPYELINE  DIM       150
.
DVYWFLNM  DIM       29
DVYWFILE  FILE      ASCII,FIXED=256
DVYWLITR  INIT      "_dvyw"
DVYWLINE  DIM       150
.
DVYRFLNM  DIM       38
DVYRFILE  FILE      ASCII,FIXED=500
DVYRLITR  INIT      "_dvyw_response"
DVYRLINE  DIM       150
.
DVYEFLNM  DIM       36
DVYEFILE  FILE      ASCII,FIXED=500
DVYELITR  INIT      "_dvyw_errors"
DVYELINE  DIM       150
.
RPYERRIN  DIM       1
.
.------------------------------------------------------------------------------
PRGID     INIT      "ECLWEB25"
VERSION   INIT      "V12.00.03"
PRGNAM    INIT      "WebServices ERAW/BPYW Enquiry/Reciepting Release Server"
.------------------------------------------------------------------------------
.
          CALL      WEBINT00       * Initialise Fifo Etc.
          CALL      INIT0000       * Open Files
.
MAIN1000  CALL      WEBRED00       * Read Fifo WEBPID and USERID
.
          COMPARE   "999",REPORTNO * End Server Process on Report Option 999
          GOTO      MAIN9999 IF EQUAL
.
          BRANCH    REPORTNO,MAIN1100,MAIN1200,MAIN1300,MAIN1400,MAIN1500:
                             MAIN1600
.
          PACK      WEBTITLE,PRGID,SP1,VERSION,SP1,PRGNAM,SP70
          MOVE      "INVALID OPTION",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          GOTO      MAIN1000
.
MAIN1100  CALL      ECRM0000   * WebServices ERAW Remittance Advice Enquiry
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1200  CALL      EJSN0000   * WebServices ERAW JSON Full Details
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1300  CALL      ECRE0000   * Webservices Remittance Advice Enquiry
          BRANCH    EXIT,MAIN1000
.
          MATCH     "1",RPYERRIN
          IF        @EQUAL
            CALL      RPYPAG00
          ELSE
            CALL      NXTPAG00
          ENDIF
.
          GOTO      MAIN1000
.
MAIN1400  CALL      TJSN0000   * WebServices Status and Report JSON Full Details
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1500  CALL      ECRB0000   * WebServices Payment Report Enquiry BBSW BPYW
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1600  CALL      ECRV0000   * Webservices Payment Report Enquiry DVAW DVYW
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN9999  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      WEBERR00
          STOP
.------------------------------------------------------------
. Update Visit Extension file                                 * I SRF 22685
.------------------------------------------------------------
UPVEXT00  PACK      KEY8,ADMISSNO,SP10
          CALL      RDVISA1
          IF        OVRCD=1 
            MOVE    SP70,PSUBRB
            MOVE    SP10,PPOST
            MOVE    SP10,PVIDATE
            GOTO    UPVEXT10
          ENDIF
.
          PACK      KEY8,PVIURNO,SP10
          CALL      RDMAST1
          IF        OVRCD=1 
            MOVE    SP70,PSUBRB
            MOVE    SP10,PPOST
            GOTO    UPVEXT10
          ENDIF
.
UPVEXT10  PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMVX11
          IF        OVRCD=1
            CALL      CLRVXS00
          ENDIF
.
          MATCH     PTVIS067,Z70                     
          IF        !@EQUAL
            MOVE      PTVIS067,PMVXUDF4             
          ENDIF
.
          MATCH     SP10,PVIDATE
          IF        !@EQUAL
            MOVE      PVIDATE,PMVXVSDT
          ENDIF
          MOVE      PPOST,PMVXPOST
          MOVE      PPOST,D8
          SQUEEZE   D8
          MOVE      D8,F4
          MOVE      F4,D4
          REP       " 0",D4
          PACK      PPOST,D4,SP10
          PACK      KEY56,PPOST,PSUBRB,SP10,PADD4,SP70                *C-240184
          CALL      RDIBPOS1
          IF        OVRCD=0
            MOVE      IBPOASGC,PMVXASGC
          ELSE                                                        *I-240184
            PACK      KEY56,PPOST,PSUBRB,SP70
            CALL      RSIBPOS1                                    
            CALL      RKIBPOS1                                    
            BRANCH    OVRCD,UPVEXT20
            MATCH     PPOST,IBPOPCOD
            IF        @EQUAL
              MATCH     PSUBRB,IBPOSUBR
              IF        @EQUAL
                MOVE      IBPOASGC,PMVXASGC
              ENDIF
            ENDIF
          ENDIF
.
UPVEXT20  PACK      KEY8,ADMISSNO,SP70
          CALL      RAPMVX11
          BRANCH    OVRCD,UPVEXT90
.
          CALL      UPPMVX11
          GOTO      UPVEXT99
.
UPVEXT90  MOVE      ADMISSNO,PMVXVISN
          PACK      KEY8,PMVXVISN
          CALL      WRPMVX11
          GOTO      UPVEXT99
.
UPVEXT99  RETURN
.------------------------------------------------------------
. Clear Visit Extension
.------------------------------------------------------------
CLRVXS00  MOVE      SP70,PMVXDOCA
          MOVE      SP70,PMVXDOCT
          MOVE      SP70,PMVXCSNR
          MOVE      SP70,PMVXPOST
          MOVE      SP70,PMVXPIND
          MOVE      SP70,PMVXVLOC
          MOVE      SP70,PMVXCFSG
          MOVE      SP70,PMVXINGP
          MOVE      SP70,PMVXCPTH
          MOVE      SP70,PMVXHCP1
          MOVE      SP70,PMVXHCP2
          MOVE      SP70,PMVXHCP3
          MOVE      SP70,PMVXHCP4
          MOVE      SP70,PMVXRHC1
          MOVE      SP70,PMVXRH1G
          MOVE      SP70,PMVXRH1C
          MOVE      SP70,PMVXRHC2
          MOVE      SP70,PMVXRH2G
          MOVE      SP70,PMVXRH2C
          MOVE      SP70,PMVXRHC3
          MOVE      SP70,PMVXRH3G
          MOVE      SP70,PMVXRH3C
          MOVE      SP70,PMVXRHC4
          MOVE      SP70,PMVXRH4G
          MOVE      SP70,PMVXRH4C
          MOVE      SP70,PMVXABRG
          MOVE      SP70,PMVXCADM
          MOVE      SP70,PMVXIRAD
          MOVE      SP70,PMVXIDUS
          MOVE      SP70,PMVXCRAV
          MOVE      SP70,PMVXRCCT
          MOVE      SP70,PMVXAPWD
          MOVE      SP70,PMVXAPBD
          MOVE      SP70,PMVXPOWD
          MOVE      SP70,PMVXPOBD
          MOVE      SP70,PMVXPSTY
          MOVE      SP70,PMVXVALW
          MOVE      SP70,PMVXPALW
          MOVE      SP70,PMVXINDC
          MOVE      SP70,PMVXMDAV
          MOVE      SP70,PMVXFRMS
          MOVE      SP70,PMVXCSNG
          MOVE      SP70,PMVXPWGT
          MOVE      SP70,PMVXPHGT
          MOVE      SP70,PMVXDHWR
          MOVE      SP70,PMVXEDC1
          MOVE      SP70,PMVXEDC2
          MOVE      SP70,PMVXEDC3
          MOVE      SP70,PMVXHOME
          MOVE      SP70,PMVXUDF1
          MOVE      SP70,PMVXUDF2
          MOVE      SP70,PMVXUDF3
          MOVE      SP70,PMVXUDF4
          MOVE      SP70,PMVXUDT1
          MOVE      SP70,PMVXUDT2
          MOVE      SP70,PMVXUDT3
          MOVE      SP70,PMVXUDT4
          MOVE      SP70,PMVXUDT5
          MOVE      SP70,PMVXUDT6
          MOVE      SP70,PMVXCDTE
          MOVE      SP70,PMVXCTIM
          MOVE      SP70,PMVXWEBC
          MOVE      SP70,PMVXLUPD
          MOVE      SP70,PMVXLUPT
          MOVE      SP70,PMVXWEBU
          MOVE      SP70,PMVXMHLS
          MOVE      SP70,PMVXPICD
          MOVE      SP70,PMVXRMOR
          MOVE      SP70,PMVXASUT
          MOVE      SP70,PMVXELPS
          MOVE      SP70,PMVXEMPL
          MOVE      SP70,PMVXFINP
          MOVE      SP70,PMVXOCCP
          MOVE      SP70,PMVXPALC
          MOVE      SP70,PMVXPPAL
          MOVE      SP70,PMVXELPS
          MOVE      SP70,PMVXPPPT
          MOVE      SP70,PMVXPSOS
          MOVE      SP70,PMVXPYSP
          MOVE      SP70,PMVXQLDB
          MOVE      SP70,PMVXREAD
          MOVE      SP70,PMVXUDIN
          MOVE      SP70,PMVXUREA
          MOVE      SP70,PMVXUSAC
          MOVE      SP70,PMVXUVTH
          MOVE      SP70,PMVXINTR
          MOVE      SP70,PMVXLNG1
          MOVE      SP70,PMVXASGC
          MOVE      SP70,PMVXPOEC
          MOVE      SP70,PMVXSPAR
          RETURN
.                                             * end I SRF 22685
.------------------------------------------------------------
. Update Diet Code
.------------------------------------------------------------
UPDIET00  MOVE      URNUMBER,KEY8             
          CALL      RLPTMAS1                  * Get PMI master file rec
          BRANCH    OVRCD,UPDIET90,UPDIET95   * Rec is either absent or locked
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          BRANCH    OVRCD,UPDIET91
.
          CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          COMPARE   ONE,UPDATET2
          GOTO      UPDIET01 IF NOT EQUAL
.
          MATCH     "1",PTCNUTOM
          IF        @EQUAL
            PACK      DIETCODE,CTCOB001,SP70  * take diet code from catcomaf
          ENDIF
.
UPDIET01  MOVE      ADMISSNO,KEY8             
          CALL      RDMISS1                   * Get Admission file rec 
          BRANCH    OVRCD,UPDIET10            * Rec is absent
.
          MATCH     SP70,LASTDATE
          GOTO      UPDIET02 IF EQUAL
.
          COMPARE   ONE,UPDATET2
          GOTO      UPDIET02 IF NOT EQUAL
.
          IF        ASTAT = 2
            MATCH     LASTDATE,CURRDATE
            GOTO      UPDIET05 IF NOT EQUAL   * only update for current date
          ELSE
            MATCH     LASTDATE,ADATE
            GOTO      UPDIET05 IF NOT EQUAL   * only update for adm.date
          ENDIF
.
UPDIET02  MATCH     Z70,DIETCODE
          IF        !@EQUAL
            MOVE      DIETCODE,ADIET          * Update diet code on Admission
            MOVE      DIETCODE,PDIET          * Update diet code on PMI master
          ENDIF
UPDIET05  CALL      UPMISS1
          CALL      UPMAST1
          CALL      UUPTMAS1
.
.         Get the last transfer record for the admission prior to
.         sending an A08
.
          PACK      KEY30,AADMNO,Z70
          CALL      RDSTRAN2                  * position on admission
          CALL      RDPTRAN2                  * read previous record
          BRANCH    OVRCD,UPDIET10            * eof - shouldn't happen
.
          MATCH     AADMNO,TADMN              * same admission still ?
          GOTO      UPDIET10 IF NOT EQUAL     * no - shouldn't happen
.
.         Get the visit extension record for the admission prior to
.         sending an A08
.
          CALL      CLPMSVX1                  * clear visit ext. variables
          MOVE      AADMNO,KEY8
          CALL      RDPMVX11                  * get visit ext. record
.
.         Get the PRA record for the admission prior to sending an A08
.
          CALL      CLPATRE1                  * clear PRA variables
          MOVE      AADMNO,KEY8
          CALL      RDPTRES1                  * get PRA record
.
.         Get the discharge record for the admission prior to
.         sending an A08
.
          CALL      CLPATDSC                  * clear discharge variables
          IF        ASTAT = 3
            MOVE      AADMNO,KEY8
            CALL      RDDSCH1                 * get discharge record
          ENDIF
.
          CALL      PMIGTNID                  * get national id
          MOVE      NMPNUMB,PTNINMPI
          MOVE      ONE,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICAC                  * broadcast admission update
.
UPDIET10  PACK      KEY16,ADMISSNO,PMNUT002,SP70
          CALL      RDPMNUT1
          IF        OVRCD=1
            CALL      CLRNUT00
          ENDIF
          CALL      MVNUT000                  * Move CGIs into record vars.
.
          MATCH     Z70,DIETCODE              * Update diet code on PMI master
          IF        !@EQUAL
            MOVE      DIETCODE,PMNUDIET
          ENDIF
.
          CLOCK     TIME,CTIMEIS              * Set update timestamp and userid
          PACK      PMNUUPDU,WBSEUID,SP70     
          PACK      PMNUUPDD,CURRDATE,CTIMEIS
.
UPDIET20  PACK      KEY16,PMNUADMN,PMNUDATE,SP70
          CALL      RAPMNUT1                  * Is nutrition record there ?
          BRANCH    OVRCD,UPDIET25                                   
          CALL      UPPMNUT1                  * Yes - just update it       
          GOTO      UPDIET30
.
UPDIET25  MOVE      PMNUUPDU,PMNUCRTU         * No - set up create t/stamp
          MOVE      PMNUUPDD,PMNUCRTD         *      and userid
          CALL      WRPMNUT1                  *      then write record
.
UPDIET30  IF        NOCATCOM=0
            CALL      UPCAT000                * update catcomaf (extra diet)
          ENDIF
.
UPDIET50  MOVE      URNUMBER,KEY8
          CALL      UUPTMAS1
          MATCH     SP70,NEXTPATN
          IF        @EQUAL
            CALL      WINCLS00                * Refresh Parent & Close Window
          ELSE
            CALL      NXTPAT00
          ENDIF
          GOTO      UPDIET99
.
UPDIET90  MOVE      "Invalid U/R Number",WEBTITLE
          CALL      WEBERR00
          GOTO      UPDIET99
.
UPDIET91  MOVE      "PMI Extension record missing",WEBTITLE
          CALL      WEBERR00
          GOTO      UPDIET99
.
UPDIET95  MOVE      "Error U/R Locked",WEBTITLE
          CALL      WEBERR00
          GOTO      UPDIET99
.
UPDIET99  RETURN
+
.------------------------------------------------------------
. Update Extra Diet Details (catcomaf)
.------------------------------------------------------------
UPCAT000  MATCH     "1",PTCNUTOM
          GOTO      UPCAT999 IF NOT EQUAL
.
          MOVE      ONE,F1
          WHILE     F1 <= 5
            PACK      KEY17,ADMISSNO,LASTDATE,F1
            CALL      RDCTCOM1
            IF        OVRCD = 1
              CALL      CLCATCOM
            ENDIF
.
.davvy      CALL      MVCOM000                  * Move CGIs into record vars.
            MOVE      PMNUADMN,CTCOADMN
            MOVE      PMNUDATE,CTCODATE
            MOVE      F1,CTCOMEAL
            IF        F1=1
              CALL      MVCOB000                * Move breakfast cgis
            ENDIF
            IF        F1=3
              CALL      MVCOL000                * Move lunch cgis
            ENDIF
            IF        F1=5
              CALL      MVCOD000                * Move dinner cgis
            ENDIF
.
            PACK        KEY17,CTCOADMN,CTCODATE,CTCOMEAL,SP70
            CALL        RACTCOM1
            IF          OVRCD=1
              CALL        WRCTCOM1
            ELSE
              CALL        UPCTCOM1
            ENDIF
.
            ADD         TWO,F1
          DO
.
          CALL      PMIGTNID                  * get national id
          MOVE      NMPNUMB,PTNINMPI
          MOVE      FOUR,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICAC                  * broadcast admission update
.
UPCAT999  RETURN
+
.------------------------------------------------------------
. Remote scripting for Status               * HPS Code Starts Here
.------------------------------------------------------------
XMLSCR00  CALL      XMLHED00
          BRANCH    EXIT,XMLSCR99
.
          PACK      KEY17,ADMISSNO,SERVDAT1,SHIFTNUM,SP70
          CALL      RDPMPDP1
          IF        OVRCD = 1
            CALL      CLRPDP00              * Clear Patient Dependency Filevar
            CALL      MOVPDP00
            IF        PMPDSCOR<>0
              CALL      WRPMPDP1
            ENDIF
          ELSE
            CALL      MOVPDP00
            IF        PMPDSCOR=0
              CALL      DEPMPDP1
            ELSE
              CALL      UPPMPDP1
            ENDIF
          ENDIF
.
          GOTO      XMLSCR80
.
XMLSCR80  MOVE      PMPDSCOR,DIM3
          MATCH     "  0",DIM3
          IF        @EQUAL
            MOVE      SP70,DIM3
          ENDIF
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                            DIM3:
                             "</RETURN_VALUE>";
          GOTO      XMLSCR95     
.
XMLSCR95  CALL      XMLEND00
.
XMLSCR99  RETURN
.--------------------------------------------------------------------------
. Clear file variables of Patient dependency File
.--------------------------------------------------------------------------
CLRPDP00  MOVE      SP70,PMPDADMN
          MOVE      SP70,PMPDDATE
          MOVE      SP70,PMPDSHIF
          MOVE      SP70,PMPDWARD
          MOVE      ZERO,PMPDSCOR
          MOVE      SP70,PMPDCATE
          MOVE      SP70,PMPDCLOS
CLRPDP99  RETURN
.--------------------------------------------------------------------------
. Clear file variables of Patient Nutrition File
.--------------------------------------------------------------------------
CLRNUT00  MOVE      SP70,PMNUADMN
          MOVE      SP70,PMNUDATE
          MOVE      SP70,PMNUCRTD
          MOVE      SP70,PMNUUPDD
          MOVE      SP70,PMNUCRTU
          MOVE      SP70,PMNUUPDU
          MOVE      SP70,PMNUDTYP
          MOVE      SP70,PMNUWARD
          MOVE      SP70,PMNUSIZE
          MOVE      SP70,PMNUDCDE
          MOVE      SP70,PMNUPAGN
          MOVE      SP70,PMNUALVL
          MOVE      SP70,PMNUFLUI
          MOVE      SP70,PMNUTEAT
          MOVE      SP70,PMNUADTV
          MOVE      SP70,PMNUVOLU
          MOVE      SP70,PMNUML01
          MOVE      SP70,PMNUML02
          MOVE      SP70,PMNUML03
          MOVE      SP70,PMNUML04
          MOVE      SP70,PMNUML05
          MOVE      SP70,PMNUML06
          MOVE      SP70,PMNUML07
          MOVE      SP70,PMNUML08
          MOVE      SP70,PMNUML09
          MOVE      SP70,PMNUML10
          MOVE      SP70,PMNUSTAT
          MOVE      SP70,PMNUBELT
          MOVE      SP70,PMNUMTYP
          MOVE      SP70,PMNUPRNT
          MOVE      SP70,PMNUCOM1
          MOVE      SP70,PMNUCOM2
          MOVE      SP70,PMNUCOM3
          MOVE      SP70,PMNUCOM4
          MOVE      SP70,PMNUCOM5
          MOVE      SP70,PMNUUDF1
          MOVE      SP70,PMNUUDF2
          MOVE      SP70,PMNUUDF3
          MOVE      SP70,PMNUUDF4
          MOVE      SP70,PMNUUDF5
          MOVE      SP70,PMNUFAST
          MOVE      SP70,PMNUBSUP
          MOVE      SP70,PMNUMSUP
          MOVE      SP70,PMNULSUP
          MOVE      SP70,PMNUASUP
          MOVE      SP70,PMNUDSUP
          MOVE      SP70,PMNUSSUP
          MOVE      SP70,PMNUDIET
CLRNUT99  RETURN
.------------------------------------------------------------------------
. Move file variables to Patient Dependency File
.------------------------------------------------------------------------
MOVPDP00  MOVE      PMSPD001,F3
          MOVELPTR  PMSPD001,F2
.
          IF        F3=0 & F2>1 
            GOTO      MOVPDP20
          ENDIF
.
          IF        F3 >= 0 & F3 <= 24
            MOVE      ONE,PMSPD002
          ENDIF
          IF        F3 >= 25 & F3 <= 48
            MOVE      TWO,PMSPD002
          ENDIF
          IF        F3 >= 49 & F3 <= 120
            MOVE      THREE,PMSPD002
          ENDIF
          IF        F3 >= 121 & F3 <= 223
            MOVE      FOUR,PMSPD002
          ENDIF
          IF        F3 >= 224
            MOVE      FIVE,PMSPD002
          ENDIF
.
MOVPDP10  MOVE      ADMISSNO,PMPDADMN
          MOVE      SERVDAT1,PMPDDATE
          MOVE      SHIFTNUM,PMPDSHIF
          MOVE      WARDCODE,PMPDWARD
          MOVE      PMSPD001,PMPDSCOR
          MOVE      PMSPD002,PMPDCATE
          GOTO      MOVPDP99
.
MOVPDP20  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                            PMPDSCOR:
                             "</RETURN_VALUE>";
          GOTO      MOVPDP99     
.
MOVPDP99  RETURN
.------------------------------------------------------------
. Find the next patient in the ward
.------------------------------------------------------------
NXTPAT00  MATCH     "1",NEXTPATF            * HPS Code Starts Here
          IF        @EQUAL
            CALL      NXTEVT00
            BRANCH    EXIT,NXTPAT90
            GOTO      NXTPAT85
          ENDIF                             * HPS Code Ends Here
.
.         V9.02.18 - change this code to be consistent with the way ward/bed
.                    displays.  ie. NoBeds first, then WardBeds, then On leave
.                    So first see if current patient is in no bed file.       
.
          MOVE      SP70,SAVEWARD
NXTPAT10  PACK      KEY13,ADMISSNO,SP70         * Set admission as key
          CALL      RDSNOBE3                    * Position on file
          CALL      RDKNOBE3                    * Get next record
          BRANCH    OVRCD,NXTPAT20              * If EOF, go to Ward file  
          MATCH     ADMISSNO,DNBADMNO           * Check patient admission no.
          GOTO      NXTPAT20 IF NOT EQUAL       * No, try the ward file.        
.
          PACK      KEY13,NBWARD,DNBADMNO,DNBPLUR
          CALL      RDSNOBE1                    * Get patient on Index 1
.
NXTPAT15  CALL      RDKNOBE1                    * Get next patient 
          BRANCH    OVRCD,NXTPAT19              * - no more no bed recs
          MATCH     AWARD,NBWARD                * - still correct ward ?
          GOTO      NXTPAT19 IF NOT EQUAL       
          MATCH     ZEROVISN,NBADMNO            * - non-zero admission ?
          GOTO      NXTPAT15 IF EQUAL
          MOVE      NBADMNO,ADMISSNO            * Upd admission to new patient
          GOTO      NXTPAT80
.
NXTPAT19  PACK      KEY6,AWARD,SP70             * Set key to start of ward
          CALL      RDSWARD1                    * position on file 
          MOVE      AWARD,SAVEWARD
          GOTO      NXTPAT35                    * go get first rec this ward
.
NXTPAT20  PACK      KEY14,ADMISSNO,SP70         * Is patient in ward file
          CALL      RDSWARD2
          CALL      RDKWARD2 
          BRANCH    OVRCD,NXTPAT30              * If EOF, try Ward Standby      
          MATCH     ADMISSNO,DWADMNO
          GOTO      NXTPAT30 IF NOT EQUAL
.
          PACK      KEY6,WWARD,WBED,SP70        * Set key up       
          CALL      RDSWARD1                    * - position on Index 1
          MOVE      WWARD,SAVEWARD
          GOTO      NXTPAT45 
.
NXTPAT30  PACK      KEY14,ADMISSNO,SP70         * Is patient in ward (standby)
          CALL      RDSWARD4
          CALL      RDKWARD4 
          BRANCH    OVRCD,NXTPAT50              * If EOF, try On-Leave file
          MATCH     ADMISSNO,DWSTBY  
          GOTO      NXTPAT50 IF NOT EQUAL
.
          PACK      KEY6,WWARD,WBED,SP70        
          CALL      RDSWARD1                    * Get crnt patient on Index 1
          MOVE      WWARD,SAVEWARD
.
NXTPAT35  CALL      RDKWARD1                    * Get next bed in ward.      
          BRANCH    OVRCD,NXTPAT49              * - no more no bed recs
          MATCH     SAVEWARD,WWARD              * - still correct ward ?
          GOTO      NXTPAT49 IF NOT EQUAL       
          MATCH     SP3,WBED                    * - ignore ward header   
          GOTO      NXTPAT35 IF EQUAL       
.
NXTPAT40  MATCH     ZEROVISN,WADMNO                 * First check main admno
          GOTO      NXTPAT45 IF EQUAL           * - no good - try standby
          MOVE      DWADMNO,ADMISSNO            * Upd admission to new patient
          GOTO      NXTPAT80
.
NXTPAT45  MATCH     ZEROVISN,WSTBY              * Now check standby admno
          GOTO      NXTPAT35 IF EQUAL           * - no good, try next bed
          MOVE      DWSTBY,ADMISSNO             * Upd admission to new patient
          GOTO      NXTPAT80
.
NXTPAT49  PACK      KEY14,AWARD,SP70            * Set key to start of ward
          CALL      RDSONLV1                    * position on On-leave file
          GOTO      NXTPAT55
.
NXTPAT50  PACK      KEY14,ADMISSNO,SP70         * Is patient On-leave        
          CALL      RDSONLV2
          CALL      RDKONLV2 
          BRANCH    OVRCD,NXTPAT90              * If EOF, no more pats (close)  
          MATCH     ADMISSNO,DOADMNO
          GOTO      NXTPAT90 IF NOT EQUAL
          MATCH     AWARD,OWARD                 * - correct ward ?
          GOTO      NXTPAT90 IF NOT EQUAL
.
          PACK      KEY14,OWARD,OBED,DOADMNO     
          CALL      RDSONLV1                    * Get patient on Index 1
.
NXTPAT55  CALL      RDKONLV1                    * Get next patient 
          BRANCH    OVRCD,NXTPAT90              * - no more no bed recs
          MATCH     AWARD,OWARD                 * - still correct ward ?
          GOTO      NXTPAT90 IF NOT EQUAL       
          MATCH     ZEROVISN,OADMNO             * - non-zero admission ?
          GOTO      NXTPAT55 IF EQUAL
          MOVE      DOADMNO,ADMISSNO            * Upd admission to new patient
          GOTO      NXTPAT80
.
NXTPAT80  MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,NXTPAT90
.
          MATCH     "1",NEXTPATM          
          IF        @EQUAL
            BRANCH    ASTAT,NXTPAT95,NXTPAT83,NXTPAT95,NXTPAT83,NXTPAT95
          ENDIF
.
NXTPAT83  MOVE      AURNO,URNUMBER
.
NXTPAT85  REP       " +",URNUMBER
          REP       " +",ADMISSNO
          PACK      VAR,NEXTPATN,SP70,SP70 
          STRIP     VAR
          CLEAR     REDIRECT
          APPEND    VAR,REDIRECT
          APPEND    "&urnumber=",REDIRECT
          APPEND    URNUMBER,REDIRECT
          APPEND    "&admissno=",REDIRECT
          APPEND    ADMISSNO,REDIRECT
          RESET     REDIRECT
          CALL      RDIREC00
          GOTO      NXTPAT99
.
NXTPAT90  CALL      WINCLS00
          GOTO      NXTPAT99
.
NXTPAT95  MOVE      "ADMISSION IS NOT CURRENT",WEBTITLE
          CALL      WINCLE00
          GOTO      NXTPAT99
.
NXTPAT99  RETURN
.------------------------------------------------------------
.    Next Event                             * HPS Code Starts Here
.------------------------------------------------------------
NXTEVT00  MOVE      ZERO,EXIT
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMEVT1
          BRANCH    OVRCD,NXTEVT99
.
          MOVE      PMEVPWRD,PATNLOCN
.
          PACK      KEY14,PMEVPWRD,PMEVPBED,PMEVVISN,SP70
          CALL      RSPMEVT5
NXTEVT10  CALL      RKPMEVT5
          BRANCH    OVRCD,NXTEVT98
.
          MATCH     PATNLOCN,PMEVPWRD
          IF        @EQUAL
            MATCH     SP70,PMEVDDTE
            GOTO      NXTEVT10 IF NOT EQUAL
            MOVE      PMEVVISN,ADMISSNO
            PACK      KEY8,ADMISSNO
            CALL      RDVISA1
            BRANCH    OVRCD,NXTEVT99
            MOVE      PVIURNO,URNUMBER
          ELSE
            GOTO      NXTEVT10
          ENDIF
.
          GOTO      NXTEVT99
.
NXTEVT98  MOVE      ONE,EXIT
.
NXTEVT99  RETURN
.                                           * HPS Code Ends Here
.------------------------------------------------------------
. Open Files and Initialize Variables
.------------------------------------------------------------
INIT0000  CALL      INTMAS00  
          CALL      GETTZ000
          OPEN      BOKRC1A7,"bokrc1af"
          OPEN      BOKRC1A1,"bokrc1af"
          OPEN      BOKRC1A4,"bokrc1af"
          OPEN      FMSCSAA1,"fmscsaaf"
          OPEN      FMSLMAA1,"fmslmaaf"
          OPEN      IBALPCA1,"ibalpcaf"
          OPEN      IBAPDFA1,"ibapdfaf"
          OPEN      IBAPOST1,"ibapostf"
.
          OPEN      OBSDETA1,"obsdetaf" * Ward Map
.
          OPEN      PATASFA1,"patasfaf"
          OPEN      PATBRDA1,"patbrdaf"
          OPEN      PATBRDA2,"patbrdaf"
          OPEN      PATBRDA3,"patbrdaf"
          OPEN      PATBRDA4,"patbrdaf"
          OPEN      PATMI1A1,"patmi1af"
          OPEN      PATMI1A2,"patmi1af"
          OPEN      PATMI1A6,"patmi1af"
          OPEN      PATMI1A8,"patmi1af"
          OPEN      PATWR1A1,"patwr1af"
          OPEN      PATWR1A2,"patwr1af"
          OPEN      PATWR1A7,"patwr1af"
          OPEN      PATWR1A8,"patwr1af"
          OPEN      BOKDIAA1,"bokdiaaf"
          OPEN      BOKRX1A1,"bokrx1af"
          OPEN      OPRDETA2,"oprdetaf" 
          OPEN      OPRSESA1,"oprsesaf"                               *I-174468
          OPEN      OPRARDA1,"oprardaf"
          OPEN      OPRSRGA1,"oprsrgaf"
          OPEN      OPROPRA1,"opropraf"
          OPEN      OPRSEMA1,"oprsemaf"                               *I-174468
          OPEN      PATBMDA1,"patbmdaf"
          OPEN      PATBMDA2,"patbmdaf"
          OPEN      PATBMDA3,"patbmdaf"
          OPEN      PATBMDA4,"patbmdaf"
          OPEN      PATDADA1,"patdadaf"
          OPEN      PATDGWA1,"patdgwaf"
          OPEN      PATDSCH1,"patdschf"
          OPEN      PATDSCH2,"patdschf"
          OPEN      PATDSCH3,"patdschf"
          OPEN      PATDTRA1,"patdtraf"
          OPEN      PATDTRA5,"patdtraf"
          OPEN      PRIDTRA1,"pridtraf"
          OPEN      PRIDTRA4,"pridtraf"
          OPEN      PRIHDBT2,"prihdbtf"
          OPEN      PRIHREF1,"prihreff"
          OPEN      PATHSPA1,"pathspaf"
          OPEN      PATHFRE1,"pathfrec"
          OPEN      PATTRAN1,"pattranf"
          OPEN      PATTRAN2,"pattranf"
          OPEN      PATTRAN4,"pattranf"
          OPEN      VISMDTA1,"vismdtaf"
          OPEN      VISMTXA1,"vismtxaf"
          OPEN      PATCODE1,"patcodes"
          OPEN      PATCODE2,"patcodes"
          OPEN      PATFX1A1,"patfx1af"
          OPEN      PATONLV1,"patonlvf"
          OPEN      PATONLV2,"patonlvf"
          OPEN      PATINVR1,"patinvrf"
          OPEN      PATITEM1,"patitemn"
          OPEN      PATLOCA1,"patlocaf"
          OPEN      PATNOBE1,"patnobef"
          OPEN      PATNOBE3,"patnobef"
          OPEN      PATRE1A1,"patre1af"
          OPEN      PATREMD1,"patremdf"
          OPEN      PATRGMA1,"patrgmaf"
          OPEN      PMSBDCA1,"pmsbdcaf"
          OPEN      PMSBRQA3,"pmsbrqaf"
          OPEN      PMSDTCA1,"pmsdtcaf"
          OPEN      PMSREGA1,"pmsregaf"
          OPEN      MRTLOCA1,"mrtlocaf"
          OPEN      MLTSECA1,"mltsecaf"
          OPEN      PATPARA1,"patparaf"
.         OPEN      PMSEADA1,"pmseadaf"
.         OPEN      PMSEAHA2,"pmseahaf"
.         OPEN      PMSEBHA1,"pmsebhaf"
.         OPEN      PMSEBHA2,"pmsebhaf"
.         OPEN      PMSERDA1,"pmserdaf"
.         OPEN      PMSERHA1,"pmserhaf"
.         OPEN      PMSERHA2,"pmserhaf"
.         OPEN      PMSERHA3,"pmserhaf"
.         OPEN      PMSECAA1,"pmsecaaf"
.         OPEN      PMSECAA2,"pmsecaaf"
.         OPEN      PMSECAA3,"pmsecaaf"
.         OPEN      PMSECOA1,"pmsecoaf"
.         OPEN      PMSETRA1,"pmsetraf"
.         OPEN      PMSECTA1,"pmsectaf"
.         OPEN      PMSECTA2,"pmsectaf"
.         OPEN      PMSECTA3,"pmsectaf"
.         OPEN      PMSECTA4,"pmsectaf"
.         OPEN      PMSECTA5,"pmsectaf"
.         OPEN      PMSECTA6,"pmsectaf"
          OPEN      PRIINVO1,"priinvof"
          OPEN      PRIPRAC1,"pripracf"
.         OPEN      PMSESHA1,"pmseshaf"
.         OPEN      PMSESDA1,"pmsesdaf"
          OPEN      PMSEVTA1,"pmsevtaf" 
          OPEN      PMSEVTA2,"pmsevtaf"
          OPEN      PMSEVTA3,"pmsevtaf"
          OPEN      PMSEVTA5,"pmsevtaf" 
          OPEN      PMSPDPA1,"pmspdpaf"     * HPS Code Ends Here
          OPEN      PMSPDPA2,"pmspdpaf"
          OPEN      PMSVX1A1,"pmsvx1af"     * V9.02.05 Open Visit xtension file
          OPEN      PMSNUTA1,"pmsnutaf"     * new nutrition file v9.02.08
          OPEN      PMSHCPA1,"pmshcpaf"     * HCP reference file v9.02.09
          OPEN      PMSHCPA3,"pmshcpaf"
          OPEN      PMSRCBA2,"pmsrcbaf"
          OPEN      PMSWORA1,"pmsworaf"
          OPEN      PMSWORA1,"pmsworaf"
          OPEN      PMSWORA2,"pmsworaf"
          OPEN      PATVADA1,"patvadaf"
          OPEN      PATVENA1,"patvenaf"
          OPEN      RCPBDTA1,"rcpbdtaf"
          OPEN      RCPDTEA1,"rcpdteaf"
          OPEN      RCPDTEA6,"rcpdteaf"
          OPEN      RCPDTEA3,"rcpdteaf"
          OPEN      RCPREGA1,"rcpregaf"
          OPEN      RCPBNKA1,"rcpbnkaf"
          OPEN      EMRVISA1,"emrvisaf"
          OPEN      EMRVISA3,"emrvisaf"
          OPEN      WEBSECA3,"websecaf"
          OPEN      PATUREA1,"patureaf"
          OPEN      VISCMTA1,"viscmtaf"
          OPEN      PATNURS1,"patnursm"
          OPEN      PMSCURA2,"pmscuraf"
          OPEN      PMSCURA6,"pmscuraf"
.
          MOVE      ZERO,NOCATCOM
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      CATCOMA1,"catcomaf"
          TRAPCLR   IO
          IF        OVRCD=1
            MOVE      ONE,NOCATCOM
          ENDIF
.
          OPEN      CONTROLF,"controlf"                   * I CAR 48029
          READ      CONTROLF,EIGHTY;*250,PTCNHDPS        * HDP State Par.C-48209
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,TWENTY1;*45,PTCNDRSM                     *I-140164
          READ      CONTROLF,HUND13;*67,OPCNTHED
          READ      CONTROLF,THIRTY6;*86,HSYS1

          READ      CONTROLF,HUND20;*172,PTCNHLEA
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
          ENDIF
.
          READ      CONTROLF,HUND12;*104,PTCNWBDS,*107,PTCNBMAN,*114,PTCNDOST:
                                    *116,PTCNDOET
          MOVE      PTCNWBDS,WBEDDESC            * CAR 151896
          READ      CONTROLF,HUND14;*81,PTCNDONP
          READ      CONTROLF,TEN;*244,CHOSPNUM
          READ      CONTROLF,THIRTY6;*229,RCCNERRE,*232,RCCNERCD,*239,RCCNERRS
          READ      CONTROLF,HUND08;*81,RCCNERCA
          READ      CONTROLF,HUND20;*132,PTCNUNDW,*137,PTCNHEFR:
                                    *142,PTCNHETO,*147,PTCNOVRW,*152,PTCNOBES:
                                    *159,PTCNDFAL
          READ      CONTROLF,HUND23;*209,PTCNUTOM,*210,PTCNUESD
          READ      CONTROLF,TEN3;*194,CVETINS
          READ      CONTROLF,TEN9;*212,CFEETYP
          READ      CONTROLF,HUND24;*111,PTCNUIMC
          READ      CONTROLF,HUND25;*173,PTCNBTRE,*174,PTCNBTOD     *C-0837181 
          READ      CONTROLF,HUND27;*122,PTCNUEBB
          READ      CONTROLF,HUND29;*1,PTCNWSDR,*61,PTCNWSIN,*73,PTCNIMCW:
                                    *88,PTCNIHCW,*193,PTCNBBSW,*249,PTCNDVAW
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,TEMPFILE
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,PMHFILNM
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,WDIFILNM
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,CLNFILNM
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,WORCOMNM
.
          MOVE      ZERO,NOATTRIB
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PATATRA1,"patatraf"
          OPEN      PATATRA2,"patatraf"
          OPEN      PATATRA3,"patatraf"
          TRAPCLR   IO
          IF        OVRCD=1
            MOVE      ONE,NOATTRIB
          ENDIF
.
          OPEN      IBATMHA1,"ibatmhaf"
          OPEN      PATELGA1,"patelgaf"
.
.         MATCH     "1",PTCNUIMC
.         IF        @EQUAL
.           OPEN      PRIEADA1,"prieadaf"
.           OPEN      PRIEAHA2,"prieahaf"
.           OPEN      PRIIBHA1,"priibhaf"
.           OPEN      PRIIBHA2,"priibhaf"
.           OPEN      PRIECAA1,"priecaaf"
.           OPEN      PRIECAA2,"priecaaf"
.           OPEN      PRIECAA3,"priecaaf"
.           OPEN      PRIECTA1,"priectaf"
.           OPEN      PRIECTA2,"priectaf"
.           OPEN      PRIECTA3,"priectaf"
.           OPEN      PRIECTA5,"priectaf"
.           OPEN      PRIECTA6,"priectaf"
.           OPEN      PRIESHA1,"prieshaf"
.           OPEN      PRIESDA1,"priesdaf"
.         ENDIF
. 
          MATCH     "1",PTCNWSIN
          IF        @EQUAL
             OPEN      WEBECOA1,"webecoaf"
             OPEN      WEBECOA2,"webecoaf"
             OPEN      WEBETRA1,"webetraf"
             OPEN      WEBETRA4,"webetraf"
             OPEN      WEBETRA5,"webetraf"
             OPEN      WEBB2BA1,"webb2baf"
             OPEN      WEBB2BA2,"webb2baf"
             OPEN      WEBB2BA3,"webb2baf"
             OPEN      WEBERDA1,"weberdaf"
             OPEN      WEBERHA1,"weberhaf"
             OPEN      WEBERHA2,"weberhaf"
             OPEN      WEBERHA3,"weberhaf"
             OPEN      WEBPARA1,"webparaf"
             OPEN      WEBB2BA1,"webb2baf"
             OPEN      WEBB2BA2,"webb2baf"
             OPEN      WEBB2BA3,"webb2baf"
.
             MATCH    "1",PTCNIHCW
             IF        @EQUAL
               OPEN      WEBIHCA1,"webihcaf"
               OPEN      WEBIHCA2,"webihcaf"
               OPEN      WEBIHCA3,"webihcaf"
               OPEN      WEBIHCA4,"webihcaf"
               OPEN      WEBIHCA5,"webihcaf"
               OPEN      WEBIHCA6,"webihcaf"
               OPEN      WEBIHAA1,"webihaaf"
               OPEN      WEBIHAA2,"webihaaf"
               OPEN      WEBIHAA3,"webihaaf"
               OPEN      WEBIHBA1,"webihbaf"
               OPEN      WEBIHBA2,"webihbaf"
               OPEN      WEBIHDA1,"webihdaf"
               OPEN      WEBIHDA2,"webihdaf"
             ENDIF
.
             MATCH    "1",PTCNIMCW
             IF        @EQUAL
               OPEN      WEBIMCA1,"webimcaf"
               OPEN      WEBIMCA2,"webimcaf"
               OPEN      WEBIMCA3,"webimcaf"
               OPEN      WEBIMCA5,"webimcaf"
               OPEN      WEBIMCA6,"webimcaf"
               OPEN      WEBIMAA1,"webimaaf"
               OPEN      WEBIMAA2,"webimaaf"
               OPEN      WEBIMAA3,"webimaaf"
               OPEN      WEBIMBA1,"webimbaf"
               OPEN      WEBIMBA2,"webimbaf"
               OPEN      WEBIMDA1,"webimdaf"
               OPEN      WEBIMDA2,"webimdaf"
             ENDIF
.
             MATCH     "1",PTCNBBSW
             IF        @EQUAL
               OPEN      WEBBBAA1,"webbbaaf"
               OPEN      WEBBBAA2,"webbbaaf"
               OPEN      WEBBBAA3,"webbbaaf"
               OPEN      WEBBBSA1,"webbbsaf"
               OPEN      WEBBBSA2,"webbbsaf"
               OPEN      WEBBBSA3,"webbbsaf"
               OPEN      WEBBBSA4,"webbbsaf"
               OPEN      WEBBBSA5,"webbbsaf"
               OPEN      WEBBBSA6,"webbbsaf"
               OPEN      WEBBRHA1,"webbrhaf"
               OPEN      WEBBBDA1,"webbbdaf"
               OPEN      WEBBBDA2,"webbbdaf"
               OPEN      WEBBRHA2,"webbrhaf"
               OPEN      WEBBRHA3,"webbrhaf"
               OPEN      WEBBRHA4,"webbrhaf"
               OPEN      WEBBRDA1,"webbrdaf"
               OPEN      WEBBRDA2,"webbrdaf"
               OPEN      WEBBRDA3,"webbrdaf"
             ENDIF
.
             MATCH     "1",PTCNDVAW
             IF        @EQUAL
               OPEN      WEBDVAA1,"webdvaaf"
               OPEN      WEBDVAA2,"webdvaaf"
               OPEN      WEBDVAA3,"webdvaaf"
               OPEN      WEBDVWA1,"webdvwaf"
               OPEN      WEBDVWA2,"webdvwaf"
               OPEN      WEBDVWA3,"webdvwaf"
               OPEN      WEBDVWA4,"webdvwaf"
               OPEN      WEBDVWA5,"webdvwaf"
               OPEN      WEBDVWA6,"webdvwaf"
               OPEN      WEBDVHA1,"webdvhaf"
               OPEN      WEBDVDA1,"webdvdaf"
               OPEN      WEBDVDA2,"webdvdaf"
               OPEN      WEBDVHA2,"webdvhaf"
               OPEN      WEBDVHA3,"webdvhaf"
               OPEN      WEBDVHA4,"webdvhaf"
               OPEN      WEBDVIA1,"webdviaf"
               OPEN      WEBDVIA2,"webdviaf"
               OPEN      WEBDVIA3,"webdviaf"
             ENDIF
.
          ENDIF
.
INIT9999  RETURN
.------------------------------------------------------------
. Get Time Zone
.------------------------------------------------------------
GETTZ000  MOVE      ZERO,OVRCD
          MOVE      "+0000",KEY5
          TRAP      OVERCOND IF IO
          OPEN      TZFILE,"timezone"
          TRAPCLR   IO
          IF        OVRCD=0
            READ      TZFILE,SEQ;KEY5
          ELSE
            EXECUTE   "date +#"%z#">timezone.txt",TASKID
            TRAP      OVERCOND IF IO
            OPEN      TZFILE,"timezone"
            TRAPCLR   IO
            IF        OVRCD=0
              READ      TZFILE,SEQ;KEY5
            ENDIF
          ENDIF
          CLOSE     TZFILE
          UNPACK    KEY5,KEY3,KEY2
          PACK      TIMEZONE,KEY3,COLON,KEY2
          RETURN
.------------------------------------------------------------
. Clear Parameters
.------------------------------------------------------------
CLRPAR00  MOVE      ZERO,REPORTNO
          PACK      REDIRECT,SP70,SP70,SP70,SP70
          MOVE      SP70,TEMPLATE
          MOVE      SP70,UPDATETY
          MOVE      ZERO,UPDATET2
          MOVE      SP70,REDIRECT
          MOVE      SP70,NEXTPATN
          MOVE      SP70,NEXTPATM
          MOVE      SP70,WARDCODE
          MOVE      SP70,OUTLTYPE
          MOVE      SP70,PWDVTYPE
          MOVE      ZERO,CLOSEDEP
          MOVE      ZERO,VIEWONLY
          MOVE      SP70,URNUMBER
          MOVE      SP70,ADMISSNO
          MOVE      SP70,VIEWTYPE
          MOVE      SP70,DIETNCDE
          MOVE      SP70,DIETTYPE
          MOVE      SP70,DOCTCODE
          MOVE      ZERO,BULKDSCH
          MOVE      ZERO,KIDSONLY
          MOVE      ZERO,KIDSVEW2
          MOVE      ZERO,ALTVIEW1
          MOVE      ZERO,FASTVIEW
          MOVE      ZERO,SJOGVIEW
          MOVE      ZERO,STVVIEW                                    *Car 262343
          MOVE      ZERO,HEAVIEW
          MOVE      ZERO,PRNTLABL
          MOVE      SP70,FRSTDATE
          MOVE      SP70,HOSPCODE 
          MOVE      ZERO,ALLHFLAG
          MOVE      SP70,PARTCODE
          MOVE      SP70,FUNDTRID
          MOVE      SP70,REMITADV
          MOVE      SP70,REMITKEY
          MOVE      SP70,PAYMTKEY
          MOVE      SP70,SELPRINT 
          MOVE      SP70,PARTNUMB
          MOVE      SP70,PROCSTAT
          MOVE      SP70,BTSCHOSP
          MOVE      SP70,NEXTPAGE
          MOVE      SP70,MAVBATCH
          MOVE      SP70,MAVINVCE
          MOVE      SP70,CLMUNIID
          MOVE      SP70,PAYRUNNO
          MOVE      SP70,PAYRUNDT
          MOVE      SP70,REPRETKY
          MOVE      SP70,PROVNUMB
          MOVE      SP70,ECCLFBID
          MOVE      SP70,ECCLARID
          MOVE      SP70,ECCLFRID
          MOVE      SP70,ECCLRPTC
          MOVE      SP70,ECCLSCOD
          MOVE      SP70,ECCLSRVC
          MOVE      SP70,ECOTFUND
          MOVE      SP70,ECOTTYPE
          MOVE      SP70,ECOTTRID
          MOVE      SP70,FUNDTRID
          MOVE      SP70,ECREPYPN
          MOVE      SP70,ECREPRUN
          MOVE      SP70,ECREPDAT
          MOVE      SP70,ECRERKEY
          MOVE      SP70,ECRECLID
.         MOVE      SP70,ECREPYRN
.         MOVE      SP70,ECREPYRD
.         MOVE      SP70,ECRERRKY
          MOVE      SP70,ECREADVC
          MOVE      SP70,ECREPTNO
          MOVE      SP70,ECRETRID
          MOVE      SP70,ECREFTID
          MOVE      SP70,ECRERADV
          MOVE      SP70,ECREPNUM
          MOVE      SP70,ECRECLAM
          MOVE      SP70,FILTURNO
          MOVE      SP70,FILTADMN
          MOVE      ZERO,STARTNUM
          MOVE      ZERO,NORECORD
          MOVE      ZERO,EXDTBLNK
          MOVE      SP70,INVNUMBR
          MOVE      SP70,CLAIMSTA
          MOVE      ZERO,VALDTYPE
          MOVE      SP70,BATCHNUM
          MOVE      ZERO,EXCLCLOS
          MOVE      ZERO,EXCLWAIT
          MOVE      SP70,HLFDCLTY
          MOVE      SP70,HLTHFUND
          MOVE      SP70,LASTDATE
          MOVE      ZERO,LASTITEM
          MOVE      ZERO,LASTITM2
          MOVE      ZERO,LASTITM3
          MOVE      SP70,VYEARMTH
          MOVE      SP70,PATCONCD
          MOVE      SP70,PATCONDS
          MOVE      SP70,PATCONVA
          MOVE      SP70,PATCONPA
          MOVE      SP70,PATCONAM
          MOVE      SP70,PATCONTL
          MOVE      SP70,PTDSC002
          MOVE      Z70,DIETCODE
          MOVE      SP70,OPTIONZ
          MOVE      SP70,DOSASTAT
          MOVE      ZERO,WBEDTYPE
          MOVE      SP70,SERVDATE           * HPS Code Starts Here
          MOVE      SP70,SERVDAT1
          MOVE      SP70,PMSPD001
          MOVE      SP70,PMSPD002
          MOVE      SP70,NEXTPATF
          MOVE      SP70,SHIFTNUM           * HPS Code Ends Here
          MOVE      Z70,PTVIS067            * I SRF 22685
          MOVE      SP70,DEFTFLAG
          MOVE      SP70,FILTDPST
          MOVE      SP70,FILTCLAI
          MOVE      SP70,CALCEXLS
          CALL      CLPNUT00                * Clear Nutrition CGIs v9.02.08
          CALL      CPPMWO00                * Working diagnosis file
          CALL      CPVXTF00
          MOVE      ZERO,PTKEYCNT
          MOVE      Z70,PTMIS038
          MOVE      ZERO,STVCVIEW
          MOVE      ZERO,DEFTVIEW
          MOVE      SP70,SAVCLASS
          MOVE      ZERO,TOGGLEXP
          MOVE      ZERO,TOGGLEXP
          MOVE      ZERO,NUMBREXP
.
          MOVE      ZERO,WORCOMFL
          MOVE      ZERO,WORKFLAG
          MOVE      ZERO,LEAVFLAG
          MOVE      ZERO,MHLSFLAG
          MOVE      ZERO,SKIPDIET
.
          MOVE      Z70,LABPRT01
          MOVE      Z70,LABPRT02
          MOVE      Z70,LABPRT03
          MOVE      Z70,LABPRT04
          MOVE      Z70,LABPNO01
          MOVE      Z70,LABPNO02
          MOVE      Z70,LABPNO03
          MOVE      Z70,LABPNO04
          MOVE      Z70,LABPSL01
          MOVE      Z70,LABPSL02
          MOVE      Z70,LABPSL03
          MOVE      Z70,LABPSL04
          MOVE      ZERO,EMPTONLY
          MOVE      ZERO,DISCATDD
          MOVE      SP70,PTRGM001
          MOVE      SP70,PTRGM002
          MOVE      SP70,PTRGM003
          MOVE      SP70,MULTLT01
          MOVE      SP70,DEBDINDC
          MOVE      ZERO,EXTRDIET
          MOVE      ZERO,DISPUDF4
.
          PACK      USERDF01,SP70,SP70
          PACK      USERDF02,SP70,SP70
          PACK      USERDF03,SP70,SP70
          PACK      USERDF04,SP70,SP70
          PACK      USERDF05,SP70,SP70
          PACK      USERDF06,SP70,SP70
          PACK      USERDF07,SP70,SP70
          PACK      USERDF08,SP70,SP70
          PACK      USERDF09,SP70,SP70
          PACK      USERDF10,SP70,SP70
.
          MOVE      ZERO,DISPDNAM      * Display duplicate surname icons
          MOVE      ZERO,ONLVFLAG
          MOVE      ZERO,MEHLSFLG
          MOVE      ZERO,DISPTHET
          MOVE      ZERO,DISPMV
          MOVE      ZERO,MVFLAG
.
          MOVE      ZERO,FORMTYPE
          MOVE      SP70,FRMCOD01
          MOVE      SP70,FRMCOD02
          MOVE      SP70,FRMCOD03
          MOVE      SP70,FRMPNO01
          MOVE      SP70,FRMPNO02
          MOVE      SP70,FRMPNO03
          MOVE      SP70,FRMPRT01
          MOVE      SP70,FRMPRT02
          MOVE      SP70,FRMPRT03
          MOVE      SP70,FRMPSL01
          MOVE      SP70,FRMPSL02
          MOVE      SP70,FRMPSL03
.
          MOVE      ONE,F3
          WHILE     F3 <= 100
            MOVE      SP70,BPRNT[F3]
            MOVE      SP70,BADMN[F3]
            ADD       ONE,F3
          DO
.
          CALL      CLCTCM00           * Clear Menus Table CGIs
.
          MOVE      SP70,ATCODVAL
          MOVE      Z70,ATWDIAFN       * Working Diagnosis notes filename
          MOVE      Z70,ATMHISFN       * Relevant Medical History notes filename
          MOVE      Z70,ATBDISFN       * Barriers to Discharge notes filename
.
          MOVE      SP70,PATATURN
          MOVE      SP70,PATATVIS
          MOVE      SP70,PATATNOT
          PACK      ATTRNOTE,SP70,SP70,SP70,SP70
.
          MOVE      ZERO,WDBDSRCH
          MOVE      ZERO,FHRSUBIN
.
          CALL      IALR0000            * Initialize Alert Code array
          MOVE      SP70,FILTHOSP
          MOVE      ZERO,DEFTALLH
.
          MOVE      SP70,PAYEEPNO
          MOVE      SP70,PAYMTRUN
          MOVE      SP70,PAYMRUND
          MOVE      SP70,RETRVKEY
.
          MOVE      SP70,ECCLSTRD
          MOVE      SP70,ECCLHOSP
          MOVE      SP70,ECCLTYPE
.
CLRPAR99  RETURN
+
.------------------------------------------------------------
. Set Parameters
.------------------------------------------------------------
SETPAR00  MATCH     "reportno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REPORTNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "template=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TEMPLATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updatety=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDATETY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updatet2=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDATET2
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dietncde=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DIETNCDE                                         
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "outltype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OUTLTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pwdvtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PWDVTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "closedep=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CLOSEDEP                                         
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "redirect=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REDIRECT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nextpatn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTPATN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nextpatm=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTPATM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dietcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DIETCODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptvis067=",QRYNAME            * I SRF 22685
          IF        @EQUAL
            MOVE      QRYDATA,PTVIS067             * Populate CGI parameter
            GOTO      SETPAR99                     * with diet comment
          ENDIF
.
                                                   * end I SRF 22685
          MATCH     "pmsvx052",QRYNAME
          IF        @EQUAL
            MOVE    QRYDATA,PMSVX052
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmsvx053",QRYNAME
          IF        @EQUAL
            MOVE    QRYDATA,PMSVX053
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmsvx054",QRYNAME
          IF        @EQUAL
            MOVE    QRYDATA,PMSVX054
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmsvx055",QRYNAME
          IF        @EQUAL
            MOVE    QRYDATA,PMSVX055
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "urnumber=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,URNUMBER
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admissno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMISSNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "wardcode=",QRYNAME
          IF        @EQUAL
            PACK      WARDCODE,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "inplabar=",QRYNAME
          IF        @EQUAL
            COMPARE   "99",PTKEYCNT
            GOTO      SETPAR99 IF EQUAL
            ADD       ONE,PTKEYCNT
            PACK      INPLABAR[PTKEYCNT],QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ctcob",QRYNAME
          IF        @EQUAL
            CALL      SCCOB000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ctcol",QRYNAME
          IF        @EQUAL
            CALL      SCCOL000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ctcod",QRYNAME
          IF        @EQUAL
            CALL      SCCOD000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ctcom",QRYNAME
          IF        @EQUAL
            CALL      SCCOM000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmnut",QRYNAME
          IF        @EQUAL
            CALL      SPNUT000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "viewtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VIEWTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "doctcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DOCTCODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "frstdate=",QRYNAME 
          IF        @EQUAL
            MOVE      QRYDATA,FRSTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "lastdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LASTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "vyearmth=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VYEARMTH
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "patconcd=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PATCONCD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "patconds=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PATCONDS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "patconva=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PATCONVA
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "diettype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DIETTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "patconpa=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PATCONPA
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "patconam=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PATCONAM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "patcontl=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PATCONTL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "wbedtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,WBEDTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "servdate=",QRYNAME     * HPS Code Starts Here
          IF        @EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00              * Set CMON from MTHNAM3
            PACK      SERVDATE,CCENT,CYEAR,CMON,CDAY
            REP       " 0",SERVDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptdsc002=",QRYNAME
          IF        @EQUAL
            MATCH     SP70,QRYDATA
            IF        !@EQUAL & !@EOS
              PACK      PTDSC002,QRYDATA,SP70
              REP       " 0",PTDSC002
            ENDIF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "servdat1=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SERVDAT1
            GOTO      SETPAR99
          ENDIF
.
.
          MATCH     "nextpatf=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTPATF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "shiftnum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SHIFTNUM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmspd001=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PMSPD001
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmspd002=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PMSPD002
            GOTO      SETPAR99
          ENDIF
.                                           * HPS Code Ends Here
          MATCH     "deftflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DEFTFLAG
            GOTO      SETPAR99
          ENDIF
. 
          MATCH     "filtdpst=",QRYNAME
          IF        @EQUAL
            PACK      FILTDPST,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "filtclai=",QRYNAME
          IF        @EQUAL
            PACK      FILTCLAI,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "pmswo",QRYNAME
          IF        @EQUAL
            CALL      SPPMWO00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "wdcom001=",QRYNAME     * Working diagnosis comments
          IF        @EQUAL
            CALL      GETWOR00
            GOTO      SETPAR99
          ENDIF
.
          MATCH    "labpno",QRYNAME
          IF        @EQUAL
            CALL     STPNO000
            GOTO     SETPAR99
          ENDIF
.
          MATCH    "labpsl",QRYNAME
          IF        @EQUAL
            CALL     STLSL000
            GOTO     SETPAR99
          ENDIF
.
          MATCH    "labprt",QRYNAME
          IF        @EQUAL
            CALL     STLAB000
            GOTO     SETPAR99
          ENDIF
.
          MATCH     "ptmis038=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PTMIS038
            GOTO      SETPAR99
          ENDIF
. 
          MATCH     "emptonly=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EMPTONLY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "discatdd=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DISCATDD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "calcexls=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CALCEXLS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "hospcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,HOSPCODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "allhflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ALLHFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "btschosp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,BTSCHOSP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nextpage=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTPAGE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtadmn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILTADMN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filturno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILTURNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "norecord=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NORECORD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startnum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTNUM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "exdtblnk=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EXDTBLNK
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "invnumbr=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,INVNUMBR
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "claimsta=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CLAIMSTA
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "batchnum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,BATCHNUM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "exclwait=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EXCLWAIT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "exclclos=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EXCLCLOS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "hlthfund=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,HLTHFUND
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "hlfdclty=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,HLFDCLTY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mavbatch=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MAVBATCH
            GOTO      SETPAR99
          ENDIF
.         
          MATCH     "mavinvce=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MAVINVCE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ecclfbid=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ECCLFBID
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ecclarid=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ECCLARID
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ecclfrid=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ECCLFRID
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ecclrptc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ECCLRPTC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ecclscod=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ECCLSCOD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ecclsrvc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ECCLSRVC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ecotfund=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ECOTFUND
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ecottype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ECOTTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ecottrid=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ECOTTRID
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "procstat=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PROCSTAT
            GOTO      SETPAR99
          ENDIF  
.
          MATCH     "fundtrid=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FUNDTRID
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "clmuniid=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CLMUNIID
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "payrunno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PAYRUNNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "payrundt=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PAYRUNDT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "repretky=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REPRETKY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "provnumb=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PROVNUMB
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ecrepypn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ECREPYPN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ecreprun=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ECREPRUN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ecrepdat=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ECREPDAT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ecrerkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ECRERKEY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ecreclid=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ECRECLID
            GOTO      SETPAR99
          ENDIF
.
.         MATCH     "ecrepyrn=",QRYNAME
.         IF        @EQUAL
.           MOVE      QRYDATA,ECREPYRN
.           GOTO      SETPAR99
.         ENDIF
.
.         MATCH     "ecrepyrd=",QRYNAME
.         IF        @EQUAL
.           MOVE      QRYDATA,ECREPYRD
.           GOTO      SETPAR99
.         ENDIF
.
.         MATCH     "ecrerrky=",QRYNAME
.         IF        @EQUAL
.           MOVE      QRYDATA,ECRERRKY
.           GOTO      SETPAR99
.         ENDIF
.
          MATCH     "ecreadvc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ECREADVC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ecreptno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ECREPTNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ecretrid=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ECRETRID
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ecreftid=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ECREFTID
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ecreradv=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ECRERADV
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ecrepnum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ECREPNUM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ecreclam=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ECRECLAM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "partcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PARTCODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fundtrid=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FUNDTRID
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "remitadv=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REMITADV
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "partnumb=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PARTNUMB
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "selprint=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SELPRINT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "remitkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REMITKEY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "paymtkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PAYMTKEY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptrgm",QRYNAME
          IF        @EQUAL
            CALL      SPRGM000
            COMPARE   ZERO,EXIT
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "multlt01=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MULTLT01
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "debdindc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DEBDINDC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "extrdiet=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EXTRDIET
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mhcommnt=",QRYNAME
          IF        @EQUAL
            CALL      GETPMH00           * Get patient medical history comments
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "wdcommnt=",QRYNAME
          IF        @EQUAL
            CALL      GETWDI00           * Get working diagnosis comments
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "clcommnt=",QRYNAME
          IF        @EQUAL
            CALL      GETCLN00           * Get clinical notes comments
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "vsc18",QRYNAME
          IF        @EQUAL
            UNPACK    QRYNAME,KEY5,KEY3
            MOVE      KEY3,F3
            STORE     QRYDATA,F3,USERDF01,USERDF02,USERDF03,USERDF04,USERDF05:
                                 USERDF06,USERDF07,USERDF08,USERDF09,USERDF10
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "deftview=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DEFTVIEW
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "formtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FORMTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH    "frmprt",QRYNAME
          IF        @EQUAL
            CALL     STFRM000
            GOTO     SETPAR99
          ENDIF
.
          MATCH    "frmpno",QRYNAME
          IF        @EQUAL
            CALL     STFPN000
            GOTO     SETPAR99
          ENDIF
.
          MATCH    "frmpsl",QRYNAME
          IF        @EQUAL
            CALL     STFPS000
            GOTO     SETPAR99
          ENDIF
.
          MATCH    "frmcod",QRYNAME
          IF        @EQUAL
            CALL     STFSC000
            GOTO     SETPAR99
          ENDIF
.
          MATCH     "prt00",QRYNAME
          IF        @EQUAL
            CALL      STPRT000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "acval",QRYNAME
          IF        @EQUAL
            CALL      UPCVAL00         * Update Attribute Coded Field value
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "attxt",QRYNAME
          IF        @EQUAL
            CALL      SAVATF00         * Save Attribute Text to temp file
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "atexpdsc=",QRYNAME     * Attribute Expected Discharge Dest
          IF        @EQUAL
            MOVE      "9",ATTYPIND          * Attribute Type 009
            MOVE      "1",ATTXTIND          * Text Field 1
            MOVE      QRYDATA,ATTXTVAL
            MOVE      URNUMBER,PTATR001
            MOVE      ADMISSNO,PTATR002
            CALL      UPDATV00              * Update Attribute Text Field value
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pataturn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PATATURN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "patatvis=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PATATVIS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "patatnot=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PATATNOT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "togglexp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TOGGLEXP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "wdbdsrch=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,WDBDSRCH
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fhrsubin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FHRSUBIN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filthosp=",QRYNAME
          IF        @EQUAL
            PACK      FILTHOSP,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "deftallh=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DEFTALLH
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "payeepno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PAYEEPNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "paymtrun=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PAYMTRUN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "paymrund=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PAYMRUND
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "retrvkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RETRVKEY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ecclstrd=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ECCLSTRD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ecclhosp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ECCLHOSP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "eccltype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ECCLTYPE
            GOTO      SETPAR99
          ENDIF
.
SETPAR99  RETURN
+
.------------------------------------------------------------
. Set parameters for print billing statement
.------------------------------------------------------------
STPRT000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STPRT999 IF EQUAL
          MOVE      QRYDATA,BPRNT[F3]
STPRT999  RETURN
+
.*******************************************************************************
.                   SET LABPRT PARAMETERS
.*******************************************************************************
STLAB000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY6,KEY2
          MOVE      KEY2,F2
          BRANCH    F2,STLAB001,STLAB002,STLAB003,STLAB004
.
          MOVE      ONE,EXIT
          GOTO      STLAB999
.
STLAB001  MOVE      QRYDATA,LABPRT01
          GOTO      STLAB999
.
STLAB002  MOVE      QRYDATA,LABPRT02
          GOTO      STLAB999
.
STLAB003  MOVE      QRYDATA,LABPRT03
          GOTO      STLAB999
.
STLAB004  MOVE      QRYDATA,LABPRT04
          GOTO      STLAB999
.
STLAB999  RETURN
+
.*******************************************************************************
.                   SET FRMPRT PARAMETERS
.*******************************************************************************
STFRM000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY6,KEY2
          MOVE      KEY2,F2
          BRANCH    F2,STFRM001,STFRM002,STFRM003
.
          MOVE      ONE,EXIT
          GOTO      STFRM999
.
STFRM001  MOVE      QRYDATA,FRMPRT01
          GOTO      STFRM999
.
STFRM002  MOVE      QRYDATA,FRMPRT02
          GOTO      STFRM999
.
STFRM003  MOVE      QRYDATA,FRMPRT03
          GOTO      STFRM999
.
STFRM999  RETURN
+
.*******************************************************************************
.                   SET LABPNO PARAMETERS
.*******************************************************************************
STPNO000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY6,KEY2
          MOVE      KEY2,F2
          BRANCH    F2,STPNO001,STPNO002,STPNO003,STPNO004
.
          MOVE      ONE,EXIT
          GOTO      STPNO999
.
STPNO001  MOVE      QRYDATA,LABPNO01
          GOTO      STPNO999
.
STPNO002  MOVE      QRYDATA,LABPNO02
          GOTO      STPNO999
.
STPNO003  MOVE      QRYDATA,LABPNO03
          GOTO      STPNO999
.
STPNO004  MOVE      QRYDATA,LABPNO04
          GOTO      STPNO999
.
STPNO999  RETURN
+
.*******************************************************************************
.                   SET FRMPNO PARAMETERS
.*******************************************************************************
STFPN000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY6,KEY2
          MOVE      KEY2,F2
          BRANCH    F2,STFPN001,STFPN002,STFPN003
.
          MOVE      ONE,EXIT
          GOTO      STFPN999
.
STFPN001  MOVE      QRYDATA,FRMPNO01
          GOTO      STFPN999
.
STFPN002  MOVE      QRYDATA,FRMPNO02
          GOTO      STFPN999
.
STFPN003  MOVE      QRYDATA,FRMPNO03
          GOTO      STFPN999
.
STFPN999  RETURN
+
.******************************************************************************
.                   SET LABPSL PARAMETERS
.******************************************************************************
STLSL000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY6,KEY2
          MOVE      KEY2,F2
          BRANCH    F2,STLSL001,STLSL002,STLSL003,STLSL004
.
          MOVE      ONE,EXIT
          GOTO      STLSL999
.
STLSL001  MOVE      QRYDATA,LABPSL01
          GOTO      STLSL999
.
STLSL002  MOVE      QRYDATA,LABPSL02
          GOTO      STLSL999
.
STLSL003  MOVE      QRYDATA,LABPSL03
          GOTO      STLSL999
.
STLSL004  MOVE      QRYDATA,LABPSL04
          GOTO      STLSL999
.
STLSL999  RETURN
+
.******************************************************************************
.                   SET FRMPSL PARAMETERS
.******************************************************************************
STFPS000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY6,KEY2
          MOVE      KEY2,F2
          BRANCH    F2,STFPS001,STFPS002,STFPS003
.
          MOVE      ONE,EXIT
          GOTO      STFPS999
.
STFPS001  MOVE      QRYDATA,FRMPSL01
          GOTO      STFPS999
.
STFPS002  MOVE      QRYDATA,FRMPSL02
          GOTO      STFPS999
.
STFPS003  MOVE      QRYDATA,FRMPSL03
          GOTO      STFPS999
.
STFPS999  RETURN
+
.******************************************************************************
.                   SET FRMCOD PARAMETERS
.******************************************************************************
STFSC000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY6,KEY2
          MOVE      KEY2,F2
          BRANCH    F2,STFSC001,STFSC002,STFSC003
.
          MOVE      ONE,EXIT
          GOTO      STFSC999
.
STFSC001  MOVE      QRYDATA,FRMCOD01
          GOTO      STFSC999
.
STFSC002  MOVE      QRYDATA,FRMCOD02
          GOTO      STFSC999
.
STFSC003  MOVE      QRYDATA,FRMCOD03
          GOTO      STFSC999
.
STFSC999  RETURN
+
.------------------------------------------------------------
. Called from WEBBOD00
.------------------------------------------------------------
PROFLD00  BRANCH  REPORTNO,PROFLD10,PROFLD20,PROFLD30,PROFLD40,PROFLD50:
                           PROFLD60
          GOTO    PROFLD99
.
PROFLD10  BRANCH  FLDSETNO,PROFLD11
          GOTO    PROFLD99
.
PROFLD11  CALL    ERLM0000
          GOTO    PROFLD99
.
PROFLD20  BRANCH  FLDSETNO,PROFLD21
          GOTO    PROFLD99
.
PROFLD21  CALL    EJST0000
          GOTO    PROFLD99
.
PROFLD30  BRANCH  FLDSETNO,PROFL131
          GOTO    PROFLD99
.
PROFL131  CALL    ECRL0000
          GOTO    PROFLD99
.
PROFLD40  BRANCH  FLDSETNO,PROFLD41
          GOTO    PROFLD99
.
PROFLD41  CALL    TJST0000
          GOTO    PROFLD99
.
PROFLD50  BRANCH  FLDSETNO,PROFLD51
          GOTO    PROFLD99
.
PROFLD51  CALL    ERLB0000
          GOTO    PROFLD99
.
PROFLD60  BRANCH  FLDSETNO,PROFLD61
          GOTO    PROFLD99
.
PROFLD61  CALL    ERLV0000
          GOTO    PROFLD99
.
PROFLD99  RETURN
.------------------------------------------------------------
. Ward Current Admissions
.------------------------------------------------------------
CURADM00  MATCH     SP70,WARDCODE
          IF        @EQUAL
            MOVE      WBSEWRD,WARDCODE
          ENDIF
          PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,CURADM90
.
          MATCH     "7",TEMPLATE           * dependancy list
          IF        !@EQUAL
            MATCH     "9",TEMPLATE
            GOTO      CURADM20 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,SHIFTNUM
          IF        @EQUAL
            MOVE      ONE,SHIFTNUM
          ENDIF
.
          COMPARE   ONE,CLOSEDEP
          IF        @EQUAL
            CALL      CLDEP000
          ENDIF
.
          MATCH     SP70,LASTDATE
          IF        @EQUAL
            CALL       IBACLOCK        * default to yesterdays date
            CALL       DMYCON
            SUB        ONE,JULDAY      
            MOVE       JULDAY,JWKDAY
            MOVE       JULYR,JWKYER
            MOVE       JULCC,JWKCC
            CALL       JULCON
            PACK       LASTDATE,CC,YY,MM,DD
            REP        " 0",LASTDATE
          ENDIF
CURADM20  CALL      CURPER00
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.
          CALL      WARDET00           * Calculate  ward statistics
.
          CLEAR     WEBTITLE
          MOVE      WBDESC,KEY20       * EC changes
          APPEND    KEY20,WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00
          BRANCH    EXIT,CURADM99
.
          CALL      WEBBOD00
.
          CALL      WEBEND00
.
          GOTO      CURADM99
.
CURADM90  MOVE      "INVALID WARDCODE SPECIFIED",WEBTITLE
          CALL      WEBERR00
.
CURADM99  RETURN
.------------------------------------------------------------
. Ward Discharges
.------------------------------------------------------------
PATDSC00  MATCH     SP70,WARDCODE
          IF        @EQUAL
            MOVE      WBSEWRD,WARDCODE
          ENDIF
          PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,PATDSC90
.
          CALL      CURPER00 
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.
          MOVE      WBDESC,KEY20           * EC changes
          CLEAR     WEBTITLE
          APPEND    KEY20,WEBTITLE
.
          APPEND    "(Patient Discharges)",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,PATDSC99
.
          CALL      WEBBOD00
.
          CALL      WEBEND00
.
          GOTO      PATDSC99
.
PATDSC90  MOVE      "INVALID WARDCODE SPECIFIED",WEBTITLE
          CALL      WEBERR00
.
PATDSC99  RETURN
.------------------------------------------------------------
. Ward Admissions 
.------------------------------------------------------------
PATADM00  MATCH     SP70,WARDCODE
          IF        @EQUAL
            MOVE      WBSEWRD,WARDCODE
          ENDIF
          PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,PATADM90
.
          CALL      CURPER00 
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.
          MOVE      WBDESC,KEY20           * EC changes
          CLEAR     WEBTITLE
          APPEND    KEY20,WEBTITLE
.
          APPEND    "(Patient Admissions)",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,PATADM99
.
          CALL      WEBBOD00
.
          CALL      WEBEND00
.
          GOTO      PATADM99
.
PATADM90  MOVE      "INVALID WARDCODE SPECIFIED",WEBTITLE
          CALL      WEBERR00
.
PATADM99  RETURN

.------------------------------------------------------------
. Ward Pre Admissions 
.------------------------------------------------------------
PATPRE00  MATCH     SP70,WARDCODE
          IF        @EQUAL
            MOVE      WBSEWRD,WARDCODE
          ENDIF
          PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,PATPRE90
.
          CALL      CURPER00
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.
          MOVE      WBDESC,KEY20               * EC changes
          CLEAR     WEBTITLE
          APPEND    KEY20,WEBTITLE
.
          APPEND    "(Patient Pre-Admissions)",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,PATPRE99
.
          CALL      WEBBOD00
.
          CALL      WEBEND00
.
          GOTO      PATPRE99
.
PATPRE90  MOVE      "INVALID WARDCODE SPECIFIED",WEBTITLE
          CALL      WEBERR00
.
PATPRE99  RETURN
.------------------------------------------------------------
. Ward Bookings 
.------------------------------------------------------------
PATBOK00  MATCH     SP70,WARDCODE
          IF        @EQUAL
            MOVE      WBSEWRD,WARDCODE
          ENDIF
          PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,PATBOK90
.
          CALL      CURPER00 
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.
          MOVE      WBDESC,KEY20         * EC changes
          CLEAR     WEBTITLE
          APPEND    KEY20,WEBTITLE
          APPEND    "(Patient Bookings)",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,PATBOK99
.
          CALL      WEBBOD00
.
          CALL      WEBEND00
.
          GOTO      PATBOK99
.
PATBOK90  MOVE      "INVALID WARDCODE SPECIFIED",WEBTITLE
          CALL      WEBERR00
.
PATBOK99  RETURN
.
.------------------------------------------------------------------------------
.                            All Wards Lists
. This report number allows for lists where WARDCODE does not need to 
. be known (i.e. passed from template or specified on user security).
.------------------------------------------------------------------------------
ALLWRD00  MOVE      WBDESC,KEY20         * EC changes
          CLEAR     WEBTITLE
          APPEND    KEY20,WEBTITLE
          APPEND    "(Unallocated Patients List)",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,ALLWRD99
.
          CALL      WEBBOD00
.
          CALL      WEBEND00
.
ALLWRD99  RETURN
.
.------------------------------------------------------------------------------
. All Wards Lists
.------------------------------------------------------------------------------
AWRL0000  BRANCH    FLDITMNO,AWRL0100,AWRL0200,AWRL0300
.
          GOTO      AWRL9999 
.
AWRL0100  CALL      WONSEL00           * Ward-Only wards selection list
          GOTO      AWRL9999
.
AWRL0200  CALL      UNALPT00           * Unallocated Patients List
          GOTO      AWRL9999
.
AWRL0300  WRITE     HTMLFILE;NUMNOBED; * Number of unallocated patients
          GOTO      AWRL9999
.
AWRL9999  RETURN
.
.------------------------------------------------------------
. Ward-Only Wards Selection List
.------------------------------------------------------------
WONSEL00  PACK      KEY29,SP70
          IF        IBCNMHOS = 1
            PACK      KEY29,SP3,WBSEHOSP,SP70
          ENDIF
          CALL      RDSWARD7
WONSEL10  CALL      RDKWARD7
          BRANCH    OVRCD,WONSEL99
.
.                         if we have a bed number we have passed all the ward
.                         master records, so exit
          MATCH     SP70,WBED
          GOTO      WONSEL99 IF NOT EQUAL
.
          COMPARE   WACTIVE,ZERO                 *List only active wards
          GOTO      WONSEL10 IF NOT EQUAL
.
          COMPARE   TWO,WINPUT              * List only Ward/Bed+Ward-Only wards
          GOTO      WONSEL10 IF NOT EQUAL
.
          IF        IBCNMHOS = 1
            MATCH      SP3,WBSEHOSP
            IF        !@EQUAL
              MATCH     WBSEHOSP,PTWDHOSN
              GOTO      WONSEL99 IF NOT EQUAL
            ENDIF
          ENDIF
.
.                       write the select option.
          WRITE     HTMLFILE;"<option value=#"",WWARD,"#"";
          MATCH     WARDCODE,WWARD
          IF        @EQUAL
            WRITE     HTMLFILE;" selected";
          ENDIF
          WRITE     HTMLFILE;">",WBDESC;
.
          IF        IBCNMHOS = 1
            MATCH      SP3,WBSEHOSP
            IF        @EQUAL
              WRITE     HTMLFILE;" - ",PTWDHOSN;
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"</option>"
          GOTO      WONSEL10
.
WONSEL99  RETURN
.
.------------------------------------------------------------------------------
.                       Unallocated Patients List
. This procedure produces a list of all patients without a bed allocation
. It lists patients across all Ward/Bed + Ward-Only wards (default) or for 
. a given Ward/Bed + Ward-Only ward. 
.------------------------------------------------------------------------------
UNALPT00  MOVE      ZERO,WSDEINDC
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,WSDEINDC,DIM127
.
          MOVE      ZERO,NUMNOBED           * Initialize number of patients
.
          PACK      KEY13,SP70
          CALL      RDSNOBE1
UNALPT10  CALL      RDKNOBE1
          BRANCH    OVRCD,UNALPT99
.
          MATCH     WARDCODE,SP70           * Include all wards?
          GOTO      UNALPT20 IF EQUAL       * Yes, skip check for given ward.
.
          MATCH     WARDCODE,NBWARD         * Specified ward?
          GOTO      UNALPT10 IF NOT EQUAL   * No, get next record.
.
UNALPT20  PACK      KEY6,NBWARD,SP70        * Read Ward/Bed file to check if
          CALL      RDWARD1                 * record found is for a Ward/Bed +
          BRANCH    OVRCD,UNALPT10          * Ward-Only ward.
.
          COMPARE   TWO,WINPUT              * Is this a Ward/Bed+Ward-Only ward?
          GOTO      UNALPT10 IF NOT EQUAL   * No, get next record
.
          IF        IBCNMHOS<>1
            GOTO      UNALPT30
          ENDIF
.
          MATCH     SP70,WBSEHOSP
          GOTO      UNALPT30 IF EQUAL
.
          MATCH     PTWDHOSN,WBSEHOSP
          GOTO      UNALPT10 IF NOT EQUAL
.
UNALPT30  PACK      ADMISSNO,NBADMNO
          MOVE      NBROOM,WBED
          CALL      DSPUNA00                * Display unallocated patient row
.
          ADD       ONE,NUMNOBED            * Increment number of patients
          GOTO      UNALPT10                * Get next record.
.
UNALPT99  RETURN
.
.------------------------------------------------------------------------------
.                      Display Unallocated Patient Row
.------------------------------------------------------------------------------
DSPUNA00  CALL      GETPAT00
          CALL      PATLN000
          CALL      PATFLD00                * Use standard Patient Folder sub
          MOVE      KEY3,FOLDERSF           * and store suffix
          MOVE      ADOCTA,DOCTCODE
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
.
          MATCH       "1",WSDEINDC
          IF          @EQUAL
            WRITE     HTMLFILE;"<tr><td align=center>",PTWDSDES,"&nbsp;":
                               "<img src=#"../images/EditIcon.gif#"":
                               " class=ListIcon onclick='BedAllocation(#"":
                               URNUMBER,"#",#"",ADMISSNO,"#");'></td>";
          ELSE
            WRITE     HTMLFILE;"<tr><td align=center>",NBWARD,"&nbsp;":
                               "<img src=#"../images/EditIcon.gif#"":
                               " class=ListIcon onclick='BedAllocation(#"":
                               URNUMBER,"#",#"",ADMISSNO,"#");'></td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td nowrap>":
                             "<img src=../images/PatientFolder",FOLDERSF,".gif":
                             " class=ListIcon ":
                             " onclick='location.href=#"",LINKPRG,".pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO,"#";'>":
                             FORMATNM,"</td>";
.
          REP       "+ ",URNUMBER
.
          WRITE     HTMLFILE;"<td nowrap align=center>",URNUMBER,"</td>";
.
          MOVE      SP70,TDESC
          REP       "+ ",ADMISSNO
          PACK      KEY30,ADMISSNO,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          IF        OVRCD = 0
            MATCH     ADMISSNO,DTADMN
            IF        @EQUAL
              MOVE      "AC",CATEGORY
              MOVE      TDEPT,CODE
              CALL      GETCOD00
             ENDIF
          ENDIF
.
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MATCH     TDESC,SP70
          IF        @EQUAL
            WRITE     HTMLFILE;"<td nowrap>&nbsp;</td>";
          ELSE
            WRITE     HTMLFILE;"<td nowrap>",TDESC,"</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td nowrap><a href='":
                             "javascript:DoctorViewFrame(#"",DOCTCODE,"#")'>":
                              SDOCFNAM,"</a></td>":
                             "<td nowrap>",DISPDATE,ATIME,"</td></tr>";
. 
DSPUNA99  RETURN
.
.------------------------------------------------------------
. Ward Current Admissions
.------------------------------------------------------------
CADM0000  BRANCH    FLDITMNO,CADM0100,CADM0200,CADM0300,CADM0400,CADM0500:
                             CADM0600,CADM0700,CADM0800,CADM0900,CADM1000:
                             CADM1100,CADM1200,CADM1300,CADM1400,CADM1500:
                             CADM1600,CADM1700,CADM1800,CADM1900,CADM2000:
                             CADM2100,CADM2200,CADM2300,CADM2400,CADM2500:
                             CADM2600,CADM2700,CADM2800,CADM2900,CADM3000:
                             CADM3100,CADM3200,CADM3300,CADM3400,CADM3500:
                             CADM3600,CADM3700,CADM3800,CADM3900,CADM4000:
                             CADM4100,CADM4200,CADM4300,CADM4400,CADM4500:
                             CADM4600,CADM4700,CADM4800,CADM4900,CADM5000:
                             CADM5100,CADM5200,CADM5300,CADM5400,CADM5500:
                             CADM5600,CADM5700,CADM5800,CADM5900,CADM6000:
                             CADM6100,CADM6200,CADM6300,CADM6400,CADM6500:
                             CADM6600,CADM6700,CADM6800,CADM6900,CADM7000:
                             CADM7100,CADM7200,CADM7300
.                                           * HPS CODE ADDED 14,15,16
          GOTO      CADM9999
.
CADM0100  PACK      DFLTWARD,WARDCODE
          CALL      WSEL0000      * Ward Select Options
          GOTO      CADM9999
.
CADM0200  CALL      CTABA000      * Table of Current Admissions
          GOTO      CADM9999
.
CADM0300  CALL      CTABB000      * Table of Current Admissions with Condition
          GOTO      CADM9999
.
CADM0400  CALL      CTABC000      * Table of Current Admissions with Condition
          GOTO      CADM9999      * & Diet
.
CADM0500  CALL      CTABD000      * Table of Current Admissions with Condition
          GOTO      CADM9999      * & Diet (No Expected Discharge + Prov. DRG)
.
CADM0600  WRITE     HTMLFILE;NUMOFPAT;                          
          GOTO      CADM9999      
.
CADM0700  CALL      CTABE000      * Table of Current Admissions 
          GOTO      CADM9999    
.
CADM0800  MOVE      ZERO,KIDSONLY       * Table of patient ward list (standard)
          CALL      CTABF000            * - chaplin view
          GOTO      CADM9999    
.
CADM0900  MOVE      ZERO,KIDSONLY       * Table of patient ward list (standard)
          MOVE      ZERO,KIDSVEW2       * kids view 1
          MOVE      ZERO,ALTVIEW1       * Alternate view - with diagnosis
          MOVE      ZERO,EMRGVIEW       * Emergency View - No
          MOVE      ONE,FASTVIEW
          MOVE      ZERO,SJOGVIEW
          MOVE      ZERO,STVVIEW        * Stv flag                    Car 262343
          MOVE      ZERO,CNOTFLAG       * display clinical notes icon = no
          MOVE      ZERO,DISPDNAM       * display duplicate surname icons = no
          MOVE      ZERO,HEAVIEW
          MOVE      ZERO,DISPTHET       * display theatre status - no
          MOVE      ZERO,DISPMV         * display Mechanical Ventilation - no
          CALL      CTABG000            * - public version
          GOTO      CADM9999    
.
CADM1000  WRITE     HTMLFILE;NUMNOBED;  * Number of patients not allocated a bed
          GOTO      CADM9999      
.
CADM1100  WRITE     HTMLFILE;NUMEMBED;  * Number of empty beds
          GOTO      CADM9999      
.
CADM1200  WRITE     HTMLFILE;NUMBPATS;  * Number of patients
          GOTO      CADM9999      
.
CADM1300  WRITE     HTMLFILE;WBEDTYPE;  * Ward Bed Type
          GOTO      CADM9999      
.
CADM1400  CALL      DEPLST00            * Dependency List
          GOTO      CADM9999
.
CADM1500  CALL      SHFSEL00            * Shift Combo Display
          GOTO      CADM9999
.
CADM1600  MATCH     SP70,SERVDATE
          GOTO      CADM9999 IF EQUAL
          UNPACK    SERVDATE,CCENT,CYEAR,CMON,CDAY  * Service Date 
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      CADM9999
.
CADM1700  MOVE      ZERO,KIDSONLY       * Table of patient ward list (standard)
          MOVE      ZERO,STVVIEW        * STV flag                    Car 262343
          CALL      CTABN000            * - nutrition view                     
          GOTO      CADM9999
.
CADM1800  MOVE      CATMJ,CATEGORY     
          MOVE      DIETTYPE,CODE
          CALL      CODITM00
          GOTO      CADM9999
.
CADM1900  WRITE     HTMLFILE;DIETNCDE;  * Dietitian - doctor code
          GOTO      CADM9999      
.
CADM2000  CALL      DIETTN00            * Dietitian - doctor name 
          GOTO      CADM9999      
.
CADM2100  MOVE      ONE,KIDSONLY        * Table of patient ward list (rch)     
          MOVE      ZERO,KIDSVEW2       *   kids view 1
          MOVE      ZERO,ALTVIEW1       * Alternate view - with diagnosis
          MOVE      ZERO,EMRGVIEW       * Emergency View - No
          MOVE      ZERO,FASTVIEW
          MOVE      ZERO,SJOGVIEW
          MOVE      ZERO,STVVIEW        * STV flag                   Car 262343
          MOVE      ZERO,CNOTFLAG       * display clinical notes icon = no
          MOVE      ZERO,DISPDNAM       * display duplicate surname icons = no
          MOVE      ZERO,HEAVIEW
          MOVE      ZERO,DISPTHET       * display theatre status - no
          MOVE      ZERO,DISPMV         * display Mechanical Ventilation - no
          CALL      CTABG000            * - public version
          GOTO      CADM9999    
.
CADM2200  MOVE      ONE,KIDSONLY        * Table of patient ward list (rch)     
          MOVE      ZERO,STVVIEW        * STV flag                   Car 262343
          CALL      CTABN000            * - nutrition view                     
          GOTO      CADM9999
.
CADM2300  MOVE      ONE,KIDSONLY        * Table of patient ward list (rch)     
          CALL      CTABF000            * - chaplin view
          GOTO      CADM9999    
.
CADM2400  MOVE      ONE,KIDSONLY        * Table of patient ward list (rch)     
          MOVE      ONE,KIDSVEW2        * Kids view Two
          MOVE      ZERO,ALTVIEW1       * Alternate view - with diagnosis
          MOVE      ZERO,EMRGVIEW       * Emergency View - No
          MOVE      ZERO,FASTVIEW
          MOVE      ZERO,SJOGVIEW
          MOVE      ZERO,STVVIEW        * STV flag                   Car 262343
          MOVE      ZERO,CNOTFLAG       * display clinical notes icon = no
          MOVE      ZERO,DISPDNAM       * display duplicate surname icons = no
          MOVE      ZERO,HEAVIEW
          MOVE      ZERO,DISPTHET       * display theatre status - no
          MOVE      ZERO,DISPMV         * display Mechanical Ventilation - no
          CALL      CTABG000            * - public version
          GOTO      CADM9999    
.
CADM2500  MOVE      ZERO,KIDSONLY       * Table of patient ward list (standard)
          MOVE      ZERO,KIDSVEW2       * kids view 1
          MOVE      ONE,ALTVIEW1        * Alternate view - with diagnosis
          MOVE      ZERO,EMRGVIEW       * Emergency View - No
          MOVE      ZERO,FASTVIEW
          MOVE      ZERO,SJOGVIEW
          MOVE      ZERO,STVVIEW        * STV flag                   Car 262343
          MOVE      ZERO,CNOTFLAG       * display clinical notes icon = no
          MOVE      ZERO,DISPDNAM       * display duplicate surname icons = no
          MOVE      ZERO,HEAVIEW
          MOVE      ZERO,DISPTHET       * display theatre status - no
          MOVE      ZERO,DISPMV         * display Mechanical Ventilation - no
          CALL      CTABG000            * - public version
          GOTO      CADM9999
.
CADM2600  MOVE      ZERO,KIDSONLY       * Table of patient ward list (standard)
          MOVE      ZERO,KIDSVEW2       * kids view 1
          MOVE      ZERO,ALTVIEW1       * Alternate view - with diagnosis
          MOVE      ONE,EMRGVIEW        * Emergency View - Yes
          MOVE      ZERO,FASTVIEW
          MOVE      ZERO,SJOGVIEW
          MOVE      ZERO,STVVIEW        * STV flag                   Car 262343
          MOVE      ZERO,CNOTFLAG       * display clinical notes icon = no
          MOVE      ZERO,DISPDNAM       * display duplicate surname icons = no
          MOVE      ZERO,HEAVIEW
          MOVE      ZERO,DISPTHET       * display theatre status - no
          MOVE      ZERO,DISPMV         * display Mechanical Ventilation - no
          CALL      CTABG000            * - public version
.
          PACK      KEY6,WARDCODE,SP70  * Re Read correct ward
          CALL      RDWARD1
          BRANCH    OVRCD,CADM9999
.
          GOTO      CADM9999    
.
CADM2700  CALL      EMUW0000            * Ward Select Options with default
          GOTO      CADM9999            * tofirst EOU ward
.
CADM2800  CALL      BDMN0000            * Bed Management Ward View
          GOTO      CADM9999
.
CADM2900  CALL      BDBD0000            * Bed Board View
          GOTO      CADM9999
.
CADM3000  WRITE     HTMLFILE;EMPTONLY;
          GOTO      CADM9999
.
CADM3100  CALL      CNPBMV00
          GOTO      CADM9999
.
CADM3200  MATCH     SP70,PTCNDONP
          GOTO      CADM9999 IF EQUAL
          GOTO      CADM9999 IF EOS
.
          MOVE      ZERO,FORM5
          SQUEEZE   PTCNDONP
          MOVE      PTCNDONP,FORM5
.
          COMPARE   ZERO,FORM5
          GOTO      CADM9999 IF EQUAL
.
          WRITE     HTMLFILE;"Max No. of Patients: ",PTCNDONP;
          GOTO      CADM9999
.
CADM3300  CALL      CATD0000                * Return Cat sn long description
          GOTO      CADM9999
.
CADM3400  CALL      DOUT0000                * Day oncology outlier list
          GOTO      CADM9999
.
CADM3500  WRITE     HTMLFILE;OUTLTYPE;
          GOTO      CADM9999
.
CADM3600  MOVE      ONE,VIEWONLY
          CALL      BDMN0000            * Bed Management Ward View
          GOTO      CADM9999
.
CADM3700  MOVE      ZERO,KIDSONLY       * Table of patient ward list (standard)
          MOVE      ZERO,KIDSVEW2       * kids view 1
          MOVE      ZERO,ALTVIEW1        * Alternate view - with diagnosis
          MOVE      ZERO,EMRGVIEW       * Emergency View - No
          MOVE      ZERO,FASTVIEW
          MOVE      ONE,SJOGVIEW
          MOVE      ZERO,STVVIEW        * STV flag                   Car 262343
          MOVE      ZERO,CNOTFLAG       * display clinical notes icon = no
          MOVE      ZERO,DISPDNAM       * display duplicate surname icons = no
          MOVE      ZERO,HEAVIEW
          MOVE      ZERO,DISPTHET       * display theatre status - no
          MOVE      ZERO,DISPMV         * display Mechanical Ventilation - no
          CALL      CTABG000            * - public version
          GOTO      CADM9999
.
CADM3800  MOVE      ZERO,KIDSONLY       * Table of patient ward list (standard)
          MOVE      ONE,SJOGVIEW
          MOVE      ZERO,STVVIEW        * STV flag                    Car 262343
          CALL      CTABN000            * - nutrition view
          GOTO      CADM9999
.
CADM3900  MOVE      ONE,STVCVIEW
          CALL      BDMN0000            * Bed Management Ward View
          GOTO      CADM9999
.
CADM4000  MOVE      ONE,STVCVIEW
          CALL      DOUT0000                * Day oncology outlier list
          GOTO      CADM9999
.
CADM4100  MOVE      ZERO,KIDSONLY       * Table of patient ward list (standard)
          MOVE      ZERO,KIDSVEW2       * kids view 1
          MOVE      ZERO,ALTVIEW1       * Alternate view - with diagnosis
          MOVE      ZERO,EMRGVIEW       * Emergency View - No
          MOVE      ONE,FASTVIEW
          MOVE      ZERO,SJOGVIEW
          MOVE      ONE,BULKDSCH
          MOVE      ZERO,STVVIEW        * Stv flag                    Car 262343
          MOVE      ZERO,CNOTFLAG       * display clinical notes icon = no
          MOVE      ZERO,DISPDNAM       * display duplicate surname icons = no
          MOVE      ZERO,HEAVIEW
          MOVE      ZERO,DISPTHET       * display theatre status - no
          MOVE      ZERO,DISPMV         * display Mechanical Ventilation - no
          CALL      CTABG000            * - public version
          GOTO      CADM9999    
.
CADM4200  MATCH     SP70,PTDSC002
          GOTO      CADM9999 IF EQUAL
          WRITE     HTMLFILE;PTDSC002;
          GOTO      CADM9999
.
CADM4300  CALL      CTABH000
          GOTO      CADM9999
.
CADM4400  MOVE      WARDCODE,KEY3
          REP       " _",KEY3
          WRITE     HTMLFILE;KEY3;
          GOTO      CADM9999
.
CADM4500  CALL      BEDMV000
          GOTO      CADM9999
.
CADM4600  CALL      BEDLO000
          GOTO      CADM9999
.
CADM4700  CALL      SNLD0000
          GOTO      CADM9999
.
CADM4800  CALL      LOCAT000
          GOTO      CADM9999
.
CADM4900  MOVE      ONE,DISPMV
          CALL      CMAPH000
          GOTO      CADM9999
.
CADM5000  MOVE      ZERO,KIDSONLY       * Table of patient ward list (standard)
          MOVE      ZERO,KIDSVEW2       * kids view 1
          MOVE      ZERO,ALTVIEW1       * Alternate view - with diagnosis
          MOVE      ZERO,EMRGVIEW       * Emergency View - No
          MOVE      ZERO,DISPDNAM       * display duplicate surname icons = no
          CALL      CTABI000            * WAHealth Sort Table view
          GOTO      CADM9999
.
CADM5100  WRITE     HTMLFILE;DEBDINDC;
          GOTO      CADM9999
.
CADM5200  MOVE      CATDC,CATEGORY
          MOVE      DIETTYPE,CODE
          CALL      CODITM00
          GOTO      CADM9999
.
CADM5300  MOVE      ZERO,KIDSONLY       * Table of patient ward list (standard)
          MOVE      ZERO,KIDSVEW2       * kids view 1
          MOVE      ZERO,ALTVIEW1       * Alternate view - with diagnosis
          MOVE      ZERO,EMRGVIEW       * Emergency View - No
          MOVE      ONE,FASTVIEW
          MOVE      ZERO,SJOGVIEW
          MOVE      ZERO,STVVIEW        * Stv flag                    Car 262343
          MOVE      ONE,CNOTFLAG        * display clinical notes icon = yes
          MOVE      ZERO,DISPDNAM       * display duplicate surname icons = no
          MOVE      ZERO,HEAVIEW
          MOVE      ZERO,DISPTHET       * display theatre status - no
          MOVE      ZERO,DISPMV         * display Mechanical Ventilation - no
          CALL      CTABG000            * - public version
          GOTO      CADM9999
.
CADM5400  WRITE     HTMLFILE;EXTRDIET;
          GOTO      CADM9999
.
CADM5500  MOVE      ZERO,KIDSONLY       * Table of patient ward list (standard)
          MOVE      ZERO,STVVIEW        * STV flag                    Car 262343
          MOVE      ONE,DISPUDF4        * don't display pmvxudf4 (CAR 305129)
          CALL      CTABN000            * - nutrition view
          GOTO      CADM9999
.
CADM5600  MOVE      ZERO,KIDSONLY       * Table of patient ward list (standard)
          MOVE      ZERO,STVVIEW        * STV flag                    Car 262343
          MOVE      ONE,HEAVIEW         * Healthscope view
          MOVE      ZERO,DISPTHET       * display theatre status - no
          CALL      CTABN000            * - nutrition view                     
          GOTO      CADM9999
.
CADM5700  WRITE     HTMLFILE;PWDVTYPE;
          GOTO      CADM9999
.
CADM5800  MOVE      ZERO,KIDSONLY       * Table of patient ward list (hea)
          MOVE      ZERO,KIDSVEW2       * kids view 1
          MOVE      ZERO,ALTVIEW1       * Alternate view - with diagnosis
          MOVE      ZERO,EMRGVIEW       * Emergency View - No
          MOVE      ONE,FASTVIEW
          MOVE      ZERO,SJOGVIEW
          MOVE      ZERO,STVVIEW        * Stv flag                    Car 262343
          MOVE      ONE,CNOTFLAG        * display clinical notes icon = yes
          MOVE      ONE,DISPDNAM        * display duplicate surname icons = yes
          MOVE      ZERO,HEAVIEW
          MOVE      ZERO,DISPTHET       * display theatre status - no
          MOVE      ZERO,DISPMV         * display Mechanical Ventilation - no
          CALL      CTABG000            * - public version
          GOTO      CADM9999
.
CADM5900  MOVE      ZERO,KIDSONLY       * Table of patient ward list (standard)
          MOVE      ZERO,KIDSVEW2       * kids view 1
          MOVE      ZERO,ALTVIEW1       * Alternate view - with diagnosis
          MOVE      ZERO,EMRGVIEW       * Emergency View - No
          MOVE      ONE,DISPDNAM        * display duplicate surname icons = yes
          CALL      CTABI000            * WAHealth Sort Table view
          GOTO      CADM9999
.
CADM6000  MOVE      ZERO,KIDSONLY       * Table of patient ward list (standard)
          MOVE      ZERO,KIDSVEW2       * kids view 1
          MOVE      ONE,ALTVIEW1        * Alternate view - with diagnosis
          MOVE      ZERO,EMRGVIEW       * Emergency View - No
          MOVE      ZERO,FASTVIEW
          MOVE      ZERO,SJOGVIEW
          MOVE      ZERO,STVVIEW        * STV flag                   Car 262343
          MOVE      ZERO,CNOTFLAG       * display clinical notes icon = no
          MOVE      ONE,DISPDNAM       * display duplicate surname icons = no
          MOVE      ZERO,HEAVIEW
          MOVE      ZERO,DISPTHET       * display theatre status - no
          MOVE      ZERO,DISPMV         * display Mechanical Ventilation - no
          CALL      CTABG000            * - public version
          GOTO      CADM9999
.
CADM6100  WRITE     HTMLFILE;FORMTYPE;
          GOTO      CADM9999
.
CADM6200  MOVE      ZERO,KIDSONLY       * Table of patient ward list (hea)
          MOVE      ZERO,KIDSVEW2       * kids view 1
          MOVE      ZERO,ALTVIEW1       * Alternate view - with diagnosis
          MOVE      ZERO,EMRGVIEW       * Emergency View - No
          MOVE      ONE,FASTVIEW
          MOVE      ZERO,SJOGVIEW
          MOVE      ZERO,STVVIEW        * Stv flag                    Car 262343
          MOVE      ONE,CNOTFLAG        * display clinical notes icon = yes
          MOVE      ONE,DISPDNAM        * display duplicate surname icons = yes
          MOVE      ONE,HEAVIEW
          MOVE      ZERO,DISPTHET       * display theatre status - no
          MOVE      ZERO,DISPMV         * display Mechanical Ventilation - no
          CALL      CTABG000            * - public version
          GOTO      CADM9999
.
CADM6300  MOVE      ZERO,KIDSONLY       * Table of patient ward list (hea)
          MOVE      ZERO,KIDSVEW2       * kids view 1
          MOVE      ZERO,ALTVIEW1       * Alternate view - with diagnosis
          MOVE      ZERO,EMRGVIEW       * Emergency View - No
          MOVE      ONE,FASTVIEW
          MOVE      ZERO,SJOGVIEW
          MOVE      ZERO,STVVIEW        * Stv flag                    Car 262343
          MOVE      ONE,CNOTFLAG        * display clinical notes icon = yes
          MOVE      ONE,DISPDNAM        * display duplicate surname icons = yes
          MOVE      ZERO,HEAVIEW
          MOVE      ONE,DISPTHET        * display theatre status - yes
          MOVE      ONE,DISPMV          * display Mechanical Ventilation - yes
          CALL      CTABG000            * - public version
          GOTO      CADM9999
.
CADM6400  MOVE      ZERO,KIDSONLY       * Table of patient ward list (standard)
          MOVE      ZERO,KIDSVEW2       * kids view 1
          MOVE      ZERO,ALTVIEW1       * Alternate view - with diagnosis
          MOVE      ZERO,EMRGVIEW       * Emergency View - No
          MOVE      ONE,FASTVIEW
          MOVE      ZERO,SJOGVIEW
          MOVE      ZERO,STVVIEW        * Stv flag                    Car 262343
          MOVE      ZERO,CNOTFLAG       * display clinical notes icon = no
          MOVE      ZERO,DISPDNAM       * display duplicate surname icons = no
          MOVE      ZERO,HEAVIEW
          MOVE      ONE,DISPTHET        * display theatre status - yes
          MOVE      ONE,DISPMV          * display Mechanical Ventilation - yes
          CALL      CTABG000            * - public version
          GOTO      CADM9999
.
CADM6500  MOVE      ZERO,KIDSONLY       * Table of patient ward list (hea)
          MOVE      ZERO,KIDSVEW2       * kids view 1
          MOVE      ZERO,ALTVIEW1       * Alternate view - with diagnosis
          MOVE      ZERO,EMRGVIEW       * Emergency View - No
          MOVE      ONE,FASTVIEW
          MOVE      ZERO,SJOGVIEW
          MOVE      ZERO,STVVIEW        * Stv flag                    Car 262343
          MOVE      ONE,CNOTFLAG        * display clinical notes icon = yes
          MOVE      ONE,DISPDNAM        * display duplicate surname icons = yes
          MOVE      ONE,HEAVIEW
          MOVE      ONE,DISPTHET        * display theatre status - yes
          MOVE      ONE,DISPMV          * display Mechanical Ventilation - yes
          CALL      CTABG000            * - public version
          GOTO      CADM9999
.
CADM6600  WRITE     HTMLFILE;TOGGLEXP;  * Show expected patients
          GOTO      CADM9999
.
CADM6700  CALL      EXPT0000            * Expected patients list for ward view
          GOTO      CADM9999
.
CADM6800  WRITE     HTMLFILE;NUMBREXP;  * Number of expected patients
          GOTO      CADM9999      
.
CADM6900  WRITE     HTMLFILE;WDBDSRCH;  * Ward/Bed Search View
          GOTO      CADM9999      
.
CADM7000  CALL      MEXP0000            * Map view expected patients
          GOTO      CADM9999      
.
CADM7100  CALL      BEDCL000
          GOTO      CADM9999
.
CADM7200  MOVE      ONE,HEAVIEW         * Hea view
          MOVE      ZERO,KIDSONLY       * Table of patient ward list (standard)
          MOVE      ZERO,KIDSVEW2       * kids view 1
          MOVE      ZERO,ALTVIEW1       * Alternate view - with diagnosis
          MOVE      ZERO,EMRGVIEW       * Emergency View - No
          MOVE      ONE,DISPDNAM        * display duplicate surname icons = yes
          CALL      CTABI000            * WAHealth Sort Table view
          GOTO      CADM9999
.
CADM7300  MOVE      ZERO,KIDSONLY       * Table of patient ward list (standard)
          MOVE      ZERO,KIDSVEW2       * kids view 1
          MOVE      ZERO,ALTVIEW1       * Alternate view - with diagnosis
          MOVE      ZERO,EMRGVIEW       * Emergency View - No
          MOVE      ONE,FASTVIEW
          MOVE      ZERO,SJOGVIEW
          MOVE      ZERO,STVVIEW        * Stv flag                    Car 262343
          MOVE      ZERO,CNOTFLAG       * display clinical notes icon = no
          MOVE      ZERO,DISPDNAM       * display duplicate surname icons = no
          MOVE      ZERO,HEAVIEW
          MOVE      ONE,DISPTHET       * display theatre status - no
          MOVE      ZERO,DISPMV         * display Mechanical Ventilation - no
          CALL      CTABG000            * - public version
          GOTO      CADM9999

.
CADM9999  RETURN
+
.------------------------------------------------------------
. Ward Bed Locations
.------------------------------------------------------------
LOCAT000  PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
LOCAT100  CALL      RDKWARD1
          BRANCH    OVRCD,LOCAT999
          MATCH     WARDCODE,WWARD
          GOTO      LOCAT999 IF NOT EQUAL
          COMPARE   ONE,WACTIVE
          GOTO      LOCAT100 IF EQUAL
.
          MOVE      "BV",CATEGORY
          MOVE      PTWDHKST,CODE
          CALL      GETCOD00
          MOVE      TDESC,BVTDESC
.
          MOVE      "BW",CATEGORY
          MOVE      PTWDIFST,CODE
          CALL      GETCOD00
          MOVE      TDESC,BWTDESC
.
          MOVE      "RT",CATEGORY
          MOVE      WRTYPE,CODE
          CALL      GETCOD00
          MOVE      TDESC,RTTDESC
.
          MOVE      ZERO,ONLEAVE
          PACK      KEY14,WWARD,WBED,SP70
          CALL      RDSONLV1
          CALL      RDKONLV1         * Try to find correct Ward/Bed
          BRANCH    OVRCD,LOCAT110
          MATCH     OWARD,WWARD
          GOTO      LOCAT110 IF NOT EQUAL
          MATCH     OBED,WBED
          GOTO      LOCAT110 IF NOT EQUAL
          MOVE      ONE,ONLEAVE
.
LOCAT110  WRITE     HTMLFILE;"obj.AddBed(#"",WWARD,"#",":
                             "#"",WBED,"#",":
                             "#"",WBDESC,"#",":
                             "#"",WEXTN,"#",":
                             "#"",PTWDCOMM,"#",":
                             "#"",WACTIVE,"#",":
                             "#"",RTTDESC,"#",":
                             "#"",WEFRBT,"#",":
                             "#"",WPLUR,"#",":
                             "#"",PTWDDNIN,"#",":
                             "#"",PTWDIAGE,"#",":
                             "#"",PTWDICRE,"#",":
                             "#"",PTWDSEX,"#",":
                             "#"",PTWDNSTA,"#",":
                             "#"",PTWDDOSA,"#",":
                             "#"",PTWDFVDW,"#",":
                             "#"",PTWDBDST,"#",":
                             "#"",BVTDESC,"#",":
                             "#"",BWTDESC,"#",":
                             "#"",ONLEAVE,"#",":
                             "#"",PTWDCOMM,"#");"
          GOTO     LOCAT100
.
LOCAT999  RETURN

.------------------------------------------------------------
. Display the selected Dietitian name      
.------------------------------------------------------------
DIETTN00  MOVE      SP70,DIETNNAM
          MATCH     SP70,DIETNCDE
          GOTO      DIETTN90 IF EQUAL
          
          PACK      KEY6,DIETNCDE
          CALL      RDDOCT1
          IF        OVRCD=0
            CALL      SDOCNM00
            MOVE      SDOCFNAM,DIETNNAM
          ENDIF
.
DIETTN90  WRITE     HTMLFILE;DIETNNAM;  * Dietitian - doctor name 
.
DIETTN99  RETURN
.------------------------------------------------------------
. Displays Transfers in/out for a Ward
.------------------------------------------------------------
DEPLST00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    LASTDATE,D4,DAYKEY
.
          MATCH     SP70,LASTDATE
          GOTO      DEPLST99 IF EQUAL
.
          UNPACK    LASTDATE,CCENT,CYEAR,TDAYMON
          PACK      RYEAR,CCENT,CYEAR
          REP       " 0",RYEAR
.
          CLOSE     PATDAYA1
          PACK      CFNAME,FILDAYA1,RYEAR
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO           * trap if file does not exist
          OPEN      PATDAYA1,CFNAME
          TRAPCLR   IO
          BRANCH    OVRCD,DEPLST99 
.
          PACK      KEY12,DAYKEY,SP70
          CALL      RSPTDAY1
DEPLST20  CALL      RKPTDAY1
          BRANCH    OVRCD,DEPLST99
          MATCH     DAYKEY,PTDYDATE
          GOTO      DEPLST99 IF NOT EQUAL
          MOVE      ZERO,RECFOUND
          MOVE      SP70,SAVTDATE
.
          PACK      KEY30,DPTDYADM,LASTDATE,Z70
          CALL      RDSTRAN2
DEPLST30  CALL      RDPTRAN2
          BRANCH    OVRCD,DEPLST20
          MATCH     DPTDYADM,DTADMN
          GOTO      DEPLST20 IF NOT EQUAL
          IF        RECFOUND=1
            MATCH     SAVTDATE,LASTDATE
            GOTO      DEPLST20 IF NOT EQUAL
          ENDIF
.
          MATCH     "A",TMOVE
          GOTO      DEPLST40 IF EQUAL
          MATCH     TDATE,LASTDATE
          GOTO      DEPLST40 IF NOT EQUAL
.
DEPLST40  MATCH     SP70,WARDCODE
          IF        !@EQUAL
            MOVE      ONE,RECFOUND
            MOVE      TDATE,SAVTDATE
            MATCH     TWARD,WARDCODE
            GOTO      DEPLST30 IF NOT EQUAL
          ENDIF
.
          PACK      KEY8,TURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,DEPLST20
.
          PACK      KEY17,DPTDYADM,LASTDATE,SHIFTNUM,SP70
          CALL      RDPMPDP1
          IF        OVRCD = 1
            CALL      CLRPDP00
            MOVE      SP70,KEY3
            MOVE      ANSN,PMPDCLOS
          ELSE
            MOVE      PMPDSCOR,KEY3
          ENDIF
.
          UNPACK    PBDATE,CDAY,CMON,CYEAR,CCENT
          CALL      IBACLOCK
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
          CALL      PATLN000
.       
          CLEAR     PATLINK
          APPEND    LINKPRG,PATLINK
          APPEND    ".pbl?reportno=",PATLINK
          APPEND    LINKREP,PATLINK
          APPEND    "&template=",PATLINK
          APPEND    LINKTEM,PATLINK
          APPEND    "&urnumber=",PATLINK
          APPEND    PURNO,PATLINK
          APPEND    "&admissno=",PATLINK
          APPEND    DPTDYADM,PATLINK
          RESET     PATLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",PATLINK,"#",":
                             "#"",PURNO,"#",":
                             "#"",FORMATNM,"#",":
                             "#"",KEY3,"#",":
                             "#"",DPTDYADM,"#",":
                             "#"",LASTDATE,"#",":
                             "#"",SHIFTNUM,"#",":
                             "#"",WARDCODE,"#",":
                             "#"",PMPDCATE,"#",":
                             "#"",PMPDWARD,"#",":
                             "#"",PMPDCLOS,"#");";
.         
          GOTO      DEPLST20
.
DEPLST99  RETURN
.******************************************************************************
.*                       List Combo Display                                   *
.******************************************************************************
SHFSEL00  MATCH     "1",SHIFTNUM
          GOTO      SHFSEL10 IF EQUAL
          MATCH     "2",SHIFTNUM
          GOTO      SHFSEL20 IF EQUAL
          MATCH     "3",SHIFTNUM
          GOTO      SHFSEL30 IF EQUAL
.
SHFSEL10  WRITE     HTMLFILE;"<option value=1 selected>Shift 1 </option>":
                             "<option value=2>Shift 2 </option>":
                             "<option value=3>Shift 3 </option>";
.
          GOTO      SHFSEL99
.
SHFSEL20  WRITE     HTMLFILE;"<option value=1>Shift 1 </option>":
                             "<option value=2 selected>Shift 2 </option>":
                             "<option value=3>Shift 3 </option>";
.
          GOTO      SHFSEL99
.
SHFSEL30  WRITE     HTMLFILE;"<option value=1>Shift 1 </option>":
                             "<option value=2>Shift 2 </option>":
                             "<option value=3 selected>Shift 3 </option>";
.
SHFSEL99  RETURN
.------------------------------------------------------------
.Dependency List
.------------------------------------------------------------
PDEP0000  BRANCH    FLDITMNO,PDEP0100,PDEP0200,PDEP0300,PDEP0400,PDEP0500:
                             PDEP0600,PDEP0700,PDEP0800,PDEP0900,PDEP1000:
                             PDEP1100

          GOTO      PDEP9999
.
PDEP0100  CALL      NEXT0000
          GOTO      PDEP9999
.
PDEP0200  CALL      PREV0000
          GOTO      PDEP9999
.
PDEP0300  CALL      CURSTD00
          GOTO      PDEP9999
.
PDEP0400  CALL      CUREND00
          GOTO      PDEP9999
.
PDEP0500  CALL      CURYR000
          GOTO      PDEP9999
.
PDEP0600  CALL      CURMON00
          GOTO      PDEP9999
.
PDEP0700  CALL      SELV0000
          GOTO      PDEP9999
.
PDEP0800  CALL      DEPLST00
          GOTO      PDEP9999 
.
PDEP0900  WRITE     HTMLFILE;TEMPLATE;
          GOTO      PDEP9999
.
PDEP1000  WRITE     HTMLFILE;REPORTNO;
          GOTO      PDEP9999
.
PDEP1100  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      PDEP9999
.
PDEP9999  RETURN
.------------------------------------------------------------
. Ward discharges
.------------------------------------------------------------
PDSC0000  BRANCH    FLDITMNO,PDSC0100,PDSC0200,PDSC0300,PDSC0400,PDSC0500:
                             PDSC0600,PDSC0700,PDSC0800,PDSC0900,PDSC1000:
                             PDSC1100,PDSC1200,PDSC1300,PDSC1400
          GOTO      PDSC9999
.
PDSC0100  CALL      NEXT0000
          GOTO      PDSC9999
.
PDSC0200  CALL      PREV0000
          GOTO      PDSC9999
.
PDSC0300  CALL      CURSTD00
          GOTO      PDSC9999
.
PDSC0400  CALL      CUREND00
          GOTO      PDSC9999
.
PDSC0500  CALL      CURYR000
          GOTO      PDSC9999
.
PDSC0600  CALL      CURMON00
          GOTO      PDSC9999
.
PDSC0700  CALL      SELV0000
          GOTO      PDSC9999
.
PDSC0800  CALL      DTABA000        * Table of Discharges    
          GOTO      PDSC9999
.
PDSC0900  WRITE     HTMLFILE;TEMPLATE;
          GOTO      PDSC9999
.
PDSC1000  WRITE     HTMLFILE;REPORTNO;
          GOTO      PDSC9999
.
PDSC1100  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      PDSC9999
.
PDSC1200  PACK      DFLTWARD,WARDCODE
          CALL      WSEL0000        * Ward Select Options
          GOTO      PDSC9999
.
PDSC1300  CALL      TTABA000      * Table of Transfers
          GOTO      PDSC9999
.
PDSC1400  WRITE     HTMLFILE;DISCATDD;
          GOTO      PDSC9999
.
PDSC9999  RETURN
.------------------------------------------------------------
. Ward Admissions
.------------------------------------------------------------
PADM0000  BRANCH    FLDITMNO,PADM0100,PADM0200,PADM0300,PADM0400,PADM0500:
                             PADM0600,PADM0700,PADM0800,PADM0900,PADM1000:
                             PADM1100,PADM1200
          GOTO      PADM9999
.
PADM0100  CALL      NEXT0000
          GOTO      PADM9999
.
PADM0200  CALL      PREV0000
          GOTO      PADM9999
.
PADM0300  CALL      CURSTD00
          GOTO      PADM9999
.
PADM0400  CALL      CUREND00
          GOTO      PADM9999
.
PADM0500  CALL      CURYR000
          GOTO      PADM9999
.
PADM0600  CALL      CURMON00
          GOTO      PADM9999
.
PADM0700  CALL      SELV0000
          GOTO      PADM9999
.
PADM0800  CALL      ATABA000        * Table of Admissions    
          GOTO      PADM9999
.
PADM0900  WRITE     HTMLFILE;TEMPLATE;
          GOTO      PADM9999
.
PADM1000  WRITE     HTMLFILE;REPORTNO;
          GOTO      PADM9999
.
PADM1100  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      PADM9999
.
PADM1200  PACK      DFLTWARD,WARDCODE
          CALL      WSEL0000        * Ward Select Options
          GOTO      PADM9999
.
PADM9999  RETURN
.------------------------------------------------------------
. Ward selection
.------------------------------------------------------------
WSEL0000  PACK      KEY29,SP70
          IF        IBCNMHOS = 1
            PACK      KEY29,SP3,WBSEHOSP,SP70   
          ENDIF
          CALL      RDSWARD7
WSEL0100  CALL      RDKWARD7
          BRANCH    OVRCD,WSEL9999
.
.                         if we have a bed number we have passed all the ward 
.                         master records, so exit 
          MATCH     SP70,WBED
          GOTO      WSEL9999 IF NOT EQUAL  
.
          COMPARE   WACTIVE,ZERO                 *List only active wards
          GOTO      WSEL0100 IF NOT EQUAL 
.
          IF        IBCNMHOS = 1
            MATCH      SP3,WBSEHOSP
            IF        !@EQUAL
              MATCH     WBSEHOSP,PTWDHOSN
              GOTO      WSEL9999 IF NOT EQUAL
            ENDIF 
          ENDIF
.
.                       write the select option. 
          WRITE     HTMLFILE;"<option value=#"",WWARD,"#""; 
          MATCH     DFLTWARD,WWARD
          IF        @EQUAL
            WRITE     HTMLFILE;" selected"; 
          ENDIF
          WRITE     HTMLFILE;">",WBDESC;
.
          IF        IBCNMHOS = 1 
            MATCH      SP3,WBSEHOSP
            IF        @EQUAL
              WRITE     HTMLFILE;" - ",PTWDHOSN;
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"</option>"
          GOTO      WSEL0100 
.
WSEL9999  RETURN
.
.------------------------------------------------------------
. Displays Current Patient ward/bed details
.------------------------------------------------------------
CTABA000  MOVE      ZERO,RECNUMB
          IF        FHIRTYPE=0
            UNPACK    DIM127,D1,LINKPRG,DIM127
            UNPACK    DIM127,D1,LINKREP,DIM127
            UNPACK    DIM127,D1,LINKTEM,DIM127
            UNPACK    DIM127,D1,DLINKPRG,DIM127
            UNPACK    DIM127,D1,DLINKREP,DIM127
            UNPACK    DIM127,D1,DLINKTEM,DIM127
            CALL      CHEDA000      * Output Table Heading
          ENDIF
.
          CALL      IBACLOCK            * Calculate expected discharge date
          PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
          BRANCH    WINPUT,CTABA500
.
CTABA100  CALL      RDKWARD1
          BRANCH    OVRCD,CTABA700
          MATCH     WARDCODE,WWARD
          GOTO      CTABA700 IF NOT EQUAL
          BRANCH    WACTIVE,CTABA100     *Do not display inactive bed
.
          CALL      WRDROW00
          GOTO      CTABA100
.
. No Bed Ward
.------------------------------------------------------------
CTABA500  PACK      KEY13,WARDCODE,SP20
          CALL      RDSNOBE1
CTABA600  CALL      RDKNOBE1                * read next record
          BRANCH    OVRCD,CTABA700
          MATCH     WARDCODE,NBWARD         * same ward?
          GOTO      CTABA700 IF NOT EQUAL
.
          PACK      ADMISSNO,NBADMNO
          MOVE      NBROOM,WBED
          MOVE      ZERO,STBYFLAG
          CALL      CBEDA000         * Output Row Details
          GOTO      CTABA600
.
. On Leave Patients
.------------------------------------------------------------
CTABA700  MOVE      ONE,FIRSTONL
          PACK      KEY14,WARDCODE,SP70
          CALL      RDSONLV1
CTABA800  CALL      RDKONLV1
          BRANCH    OVRCD,CTABA950
          MATCH     OWARD,WARDCODE
          GOTO      CTABA950 IF NOT EQUAL
          MATCH     ZEROVISN,OADMNO
          GOTO      CTABA800 IF EQUAL
          IF        FIRSTONL=1
            MOVE      ZERO,FIRSTONL
            MOVE      "Patients On Leave",ROWHEAD
            CALL      CRHDA000       * Output Heading Row for On-Leave
          ENDIF
          PACK      ADMISSNO,OADMNO
          MOVE      OBED,WBED
          MOVE      ZERO,STBYFLAG
          CALL      CBEDA000         * Output Row Details
          GOTO      CTABA800
.
CTABA950  CALL      CENDA000         * Output End of Table
.
CTABA999  RETURN
.------------------------------------------------------------
. Current Admission Table Heading
.------------------------------------------------------------
CHEDA000  MOVE      WBDESC,KEY20 
          WRITE     HTMLFILE;"<tr>":
                               "<td colspan=5 align=center class=HeadingCell>":
                               "Current Admission for ":
                               KEY20,"</td>":
                             "</tr>":
                             "<tr>":
                               "<td class=HeadingCell>Bed</td>":
                               "<td class=HeadingCell>Patient</td>":
                               "<td class=HeadingCell>Diagnoses</td>":
                               "<td class=HeadingCell>Att. Doct.</td>":
                               "<td class=HeadingCell>Exp. Disch.</td>":
                             "</tr>"
          RETURN
.------------------------------------------------------------
. End of Table
.------------------------------------------------------------
CENDA000  BRANCH    FHIRTYPE,CENDA999
          WRITE     HTMLFILE;"<tr><td colspan=5>":
                             "<table border=0 align=center":
                             " width=100%>":
                             "<tr align=center><td width=40%></td>":
                             "<td class=AvailableCell align=center":
                             " width=10%>":
                             "Available Bed</td>":
                             "<td width=10% align=center class=StandbyCell>":
                             "Standby Patient":
                             "</td><td width=40%></td></tr>":
                             "</table></td></tr>"
CENDA999  RETURN
.------------------------------------------------------------
. Heading Row
.------------------------------------------------------------
CRHDA000  BRANCH    FHIRTYPE,CRHDA999
          WRITE     HTMLFILE;"<tr><td colspan=5 align=center ":
                               "class=HeadingCell>",ROWHEAD,"</td></tr>"
CRHDA999  RETURN
.------------------------------------------------------------
. Current Admissions Empty Bed Row
.------------------------------------------------------------
CEMPA000  BRANCH    FHIRTYPE,CEMPA999
          WRITE     HTMLFILE;"<tr height=35 align=top>":
                    "<td align=center class=AvailableCell>":
                    WBED,"</td>":
                    "<td align=center>*** Empty ***</td>":
                    "<td>&nbsp;</td>":
                    "<td>&nbsp;</td>":
                    "<td>&nbsp;</td>":
                    "</tr>";
CEMPA999  RETURN
.------------------------------------------------------------
. Current Admissions Patient Details
.------------------------------------------------------------
CBEDA000  CALL      FHRCLR00                * Clear FHIR Encounter Variable
          CALL      GETPAT00 
          CALL      PATLN000
          CALL      PATFLD00                * Use standard Patient Folder sub
          IF        FHIRTYPE=1
            CALL      FHRENC00
            GOTO      CBEDA999
          ENDIF
          MOVE      KEY3,FOLDERSF           * and store suffix
          MOVE      ADOCTA,DOCTCODE
          REP       " +",DOCTCODE
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
          IF        STBYFLAG=0
            WRITE     HTMLFILE;"<tr height=35>":
                               "<td align=center>",WBED,"&nbsp;</td>"
          ELSE
            WRITE     HTMLFILE;"<tr height=35>":
                               "<td align=center class=StandbyCell>":
                               WBED,"&nbsp;</td>"
          ENDIF
.
          WRITE     HTMLFILE;"<td nowrap>":
                             "<img src=../images/PatientFolder",FOLDERSF,".gif":
                             " class=ListIcon ":
                             " onclick='location.href=#"",LINKPRG,".pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO,"#";'>":
                             FORMATNM,"</td>":
                             "<td>",ADIAG1,ADIAG2,"&nbsp;</td>":
                             "<td nowrap><A HREF=",DLINKPRG,".pbl":
                             "?reportno=",DLINKREP:
                             "&template=",DLINKTEM:
                             "&doctcode=",DOCTCODE,">":
                             DOCFNAME,"</a></td>":
                             "<td nowrap align=center>",EXPCTDSC,"</td>":
                             "</tr>";
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
          REP       "+ ",DOCTCODE
CBEDA999  RETURN
.------------------------------------------------------------
. Output Ward/Bed Row
.------------------------------------------------------------
WRDROW00  MATCH     ZEROVISN,WADMNO
          GOTO      WRDROW90 IF EQUAL
.
          PACK      ADMISSNO,WADMNO
          MOVE      ZERO,STBYFLAG
          CALL      CBEDA000         * Output Row Details
.------------------------------------------------------------
.
          MATCH     ZEROVISN,WSTBY
          GOTO      WRDROW99 IF EQUAL
.
          PACK      ADMISSNO,WSTBY
          MOVE      ONE,STBYFLAG
          CALL      CBEDA000         * Output Row Details
.
          GOTO      WRDROW99
.
WRDROW90  CALL      CEMPA000         * Current Admissions Empty Bed Row
.
WRDROW99  RETURN
.---------------------------------------------------------------------------
. Patient Details from master file to display in table c
.   Requires ADMISSNO & URNUMBER to be set.
.   URNUMBER can be blank if a Valid Admission Record is Expected.
.---------------------------------------------------------------------------
GETPAT00  MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
          IF        OVRCD=0
            MOVE      AURNO,URNUMBER
          ENDIF
          MOVE      OVRCD,MISSFLAG
.
          MATCH     "       0",URNUMBER
          IF        @EQUAL
            MOVE      ADMISSNO,KEY8    
            CALL      RDPRAM1
            BRANCH    OVRCD,GETPAT95
          ELSE
            PACK      KEY8,URNUMBER
            CALL      RDMAST1
            BRANCH    OVRCD,GETPAT95
            PACK      KEY8,URNUMBER
            CALL      RDPMPX21
            BRANCH    OVRCD,GETPAT95
          ENDIF
.
          CALL      PATINT00                * Format Patient Name with Initial
.
          IF        PCEASE=1
            MOVE      PDECDTE,AGEDATE            * Date of Death
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
          MOVE      SP70,DOCFNAME
          PACK      KEY6,ADOCTA
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE            * I CAR 13038
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000                  * end I CAR 13038
            PACK      SDOCFNAM,DOCFNAME
...         CALL      SDOCNM00
          ENDIF
.
GETPAT10  MOVE      SP70,DESCDPST
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMWOR1
          IF        OVRCD=1
            CALL      CLPMWO00
          ENDIF
.
          MATCH     SP70,PMWODPST
          IF        !@EQUAL
            PACK      KEY5,CATLVI,PMWODPST,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      PMWODPST,TDESC
            ENDIF
            MOVE     TDESC,DESCDPST
          ENDIF
.
          COMPARE   "999",ASTAY
          IF        @EQUAL
            PACK      EXPCTDSC,HYPHEN,SP70
            GOTO      GETPAT20
          ENDIF
.
          MATCH     SP70,PMWOEDAT 
          IF        !@EQUAL
            UNPACK    PMWOEDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      EXPCTDSC,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP1,PMWOEDTM
            MATCH     SP70,PMWOEDTM
            IF        @EQUAL
              PACK      FHRENDDT,CCENT,CYEAR,FHRDASH,CMON,FHRDASH,CDAY
            ELSE
              PACK      FHRENDDT,CCENT,CYEAR,FHRDASH,CMON,FHRDASH,CDAY,ANST,PMWOEDTM,TIMEZONE,SP70
            ENDIF
            GOTO      GETPAT20
          ENDIF
.
          MOVE      CCC,CCENT
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY  
          MOVE      ASTAY,ADJDAYS
          CALL      ADJDAT00
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      EXPCTDSC,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          PACK      FHRENDDT,CCENT,CYEAR,FHRDASH,CMON,FHRDASH,CDAY
.
. Find if expected disch date is =,<, or > current date and set bgcolor flag
.
GETPAT20  MOVE      SP70,COLRFLAG
          PACK      EXPCDATE,CCENT,CYEAR,CMON,CDAY
          CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          MATCH     CURRDATE,EXPCDATE
          IF        @EQUAL
            MOVE      "CurrDischDate",COLRFLAG        * Set bgcolor to Current  
          ENDIF
          IF        @LESS 
            MOVE      "PastDischDate",COLRFLAG          * set bgcolor to past
          ENDIF
.
          PACK      KEY3,SP70
          PACK      KEY8,URNUMBER
          CALL      RDPMPX21
          BRANCH    OVRCD,GETPAT95
 
          MOVE      AADMNO,PMVXVISN            * Find Visit extension record
          PACK      KEY8,PMVXVISN,SP70
          CALL      RDPMVX11
          IF        OVRCD=1
            MOVE      SP70,PMVXVALW
            MOVE      SP70,PMVXPALW
            MOVE      SP70,PMVXUDF2
            MOVE      SP70,PMVXPOWD
            MOVE      SP70,PMVXPOBD
          ENDIF
.
          GOTO      GETPAT99  
.
GETPAT95  MOVE      "Invalid Record",PSNAME 
          MOVE      SP70,PGNAME 
          MOVE      SP70,PTITL
          CALL      PATNAM00
.
GETPAT99  RETURN
.---------------------------------------------------------------------------
. Get Diet detailS from CATCOM record, using most recent record (not future)
.---------------------------------------------------------------------------
GTDIET00  MOVE      NBSP,DTDTTYPE
          MOVE      NBSP,DTASSLEV
          MOVE      NBSP,DTDTNNAM
          MOVE      NBSP,DTFASTNG
          CALL      CLPMSNUT                      * Clear record variables
          CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          PACK      KEY16,ADMISSNO,CURRDATE,SP70  * set key to Admno + date
GTDIET10  CALL      RDPMNUT1 
          BRANCH    OVRCD,GTDIET99                * no data found - exit   
.
GTDIET20  MATCH     PMNUDTYP,SP3                  * is there a diet type
          GOTO      GTDIET30 IF EQUAL             * n - try next category code
          MOVE      CATMJ,CATEGORY                * y - translate the MJ cat.
          MOVE      PMNUDTYP,CODE
          CALL      GETCOD00
          MOVE      TDESC,DTDTTYPE                *   - store diet type desc
.
GTDIET30  MATCH     PMNUALVL,SP3                  * is there an assitance level
          GOTO      GTDIET40 IF EQUAL             * n - try next category code
          MOVE      CATMK,CATEGORY                * y - translate the MK cat.
          MOVE      PMNUALVL,CODE
          CALL      GETCOD00
          MOVE      TDESC,DTASSLEV                *   - store assistance level
.
GTDIET40  MATCH     PMNUDCDE,SP10                 * is there a Dietitian ?     
          GOTO      GTDIET50 IF EQUAL
          PACK      KEY10,PMNUDCDE                * Yes get them from HCP file
          CALL      RDPMHCP1
          BRANCH    OVRCD,GTDIET50                
          MOVE      PMHCTITL,FMTTITLE             * Got them - set up name flds
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000                      * Format name
          MOVE      DOCFNAME,DTDTNNAM             * Save name in work field
.
GTDIET50  MATCH     "1",PMNUFAST       
          GOTO      GTDIET99 IF NOT EQUAL
          MOVE      "Yes",DTFASTNG                * Patient is Fasting
.
GTDIET99  RETURN
.------------------------------------------------------------
. Get Anaesthetist info from Theatre tables                           *I-174468
.------------------------------------------------------------
GETAN000  UNPACK    SP70,ANATCODE,ANATNAME
          MOVE      ZERO,ANATFLAG
          CALL      IBACLOCK
          PACK      DIM8,CCC,CYY,CMM,CDD
          REP       " 0",DIM8
.
          MOVE      "2",KEY1
          PACK      KEY31,DAADMNO,KEY1,DIM8,Z20
          CALL      RSOPDEA2
GETAN100  CALL      RPOPDEA2                     * read Theatre Booking
          BRANCH    OVRCD,GETAN999
.
          MATCH     OPDAADMN,DAADMNO
          GOTO      GETAN999 IF NOT EQUAL
.
          COMPARE   TWO,OPDASTAT
          GOTO      GETAN999 IF NOT EQUAL
.
          COMPARE   PTCNHDPS,ONE
          IF        !@EQUAL
            MATCH     DIM8,OPDADATE
            GOTO      GETAN999 IF NOT EQUAL
          ENDIF
.
          MOVE      ONE,ANATFLAG
.                                                * read Theatre Session for Ana.
          PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,SP20
          CALL      RDOPSES1
          BRANCH    OVRCD,GETAN200
.
          MATCH     SP6,OPSEANAE                 * check Anaesthetist not blank
          GOTO      GETAN200 IF EQUAL
.
          MOVE      OPSEANAE,ANATCODE            * save "Anaesthetist" code
          GOTO      GETAN500
.                                                * if Anaesthetist was blank
GETAN200  MATCH     SP3,OPSEHOSP                 * read the Theatre Master for
.                                                * "Usual Anaesthetist"
          PACK      KEY21,OPSEHOSP,OPDACLIN,OPSEDAY,OPDATIME,OPSETHET,SP20
          CALL      RSOPSEM1
          CALL      RKOPSEM1
          BRANCH    OVRCD,GETAN999
.
          MATCH     OPSEHOSP,OPSMHOSP
          GOTO      GETAN999 IF NOT EQUAL
.
          MATCH     OPDACLIN,OPSMCLIN
          GOTO      GETAN999 IF NOT EQUAL
.
          MOVE      OPSEDAY,D1
          MATCH     D1,DOPSMDAY
          GOTO      GETAN999 IF NOT EQUAL
.
          MATCH     OPDATIME,OPSMTIME 
          GOTO      GETAN999 IF NOT EQUAL
.
          MATCH     SP6,OPSMANAE
          GOTO      GETAN999 IF EQUAL
.
          MOVE      OPSMANAE,ANATCODE            * save "Usual Anaesthetist" 
.
.
GETAN500  PACK      KEY6,ANATCODE,SP10 
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000                   * format Doctor's name
            MOVE      DOCFNAME,ANATNAME
....        MOVE      SDOCFNAM,SAVDIM35          * save old data
....        CALL      SDOCNM00                   * format Short Doctor's name
....        MOVE      SDOCFNAM,ANATNAME
....        MOVE      SAVDIM35,SDOCFNAM          * restore old data
            STRIP     ANATNAME
          ENDIF
.
GETAN999  RETURN
.------------------------------------------------------------
. Displays Discharges for a Ward
.------------------------------------------------------------
DTABA000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,DLINKPRG,DIM127
          UNPACK    DIM127,D1,DLINKREP,DIM127
          UNPACK    DIM127,D1,DLINKTEM,DIM127
.
          CALL      IBACLOCK            * Calculate expected discharge date
          PACK      KEY30,WARDCODE,FRSTDATE,SP70
          CALL      RDSTRAN4
DTABA100  CALL      RDKTRAN4
          BRANCH    OVRCD,DTABA900
          MATCH     WARDCODE,TWARD
          GOTO      DTABA900 IF NOT EQUAL
          MATCH     TDATE,LASTDATE
          GOTO      DTABA900 IF LESS
          MATCH     "D",TMOVE
          GOTO      DTABA100 IF NOT EQUAL
.
          CALL      DROWA000
          GOTO      DTABA100
DTABA900  
DTABA999  RETURN
.------------------------------------------------------------
. Discharges     Patient Details
.------------------------------------------------------------
DROWA000  PACK      ADMISSNO,TADMN
          PACK      URNUMBER,TURNO
          CALL      GETPAT00 
          CALL      PATLN000
          MOVE      ADMISSNO,KEY8
          CALL      RDDSCH1
.
          MOVE      ADOCTA,DOCTCODE
          REP       " +",DOCTCODE
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
.
          UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      EXPCTDSC,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          PACK      FHRENDDT,CCENT,CYEAR,FHRDASH,CMON,FHRDASH,CDAY
.
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CCC,CCENT
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      ADMISDAT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          CLEAR     PATLINK
          APPEND    LINKPRG,PATLINK
          APPEND    ".pbl?reportno=",PATLINK
          APPEND    LINKREP,PATLINK
          APPEND    "&template=",PATLINK
          APPEND    LINKTEM,PATLINK
          APPEND    "&urnumber=",PATLINK
          APPEND    URNUMBER,PATLINK
          APPEND    "&admissno=",PATLINK
          APPEND    ADMISSNO,PATLINK
          APPEND    "&discatdd=",PATLINK
          APPEND    DISCATDD,PATLINK
          RESET     PATLINK
.
          IF        DISCATDD=1
            MOVE      CATDD,CATEGORY          * Hard code to use cat.DD
            MOVE      DDEST,CODE
            GOTO      DROWA100
          ENDIF
.                                                                     *C-140164
          IF        PTCNDRSM=1
            MOVE      CATD,CATEGORY
            MOVE      DSTAT,CODE
          ELSE
            MOVE      CATDD,CATEGORY          * Get Discharge Dest. Descrip.
            MOVE      DDEST,CODE
          ENDIF
.
DROWA100  CALL      GETCOD00
          MOVE      TDESC,DESTDESC
.
          WRITE     HTMLFILE;"t.addRow(#"",FORMATNM,"#",":
                             "#"",PSEX,"#",":
                             "#"";
          CALL      WRTAGE00
          REP       "#" ",ADIAG1
          REP       "#" ",ADIAG2
          WRITE     HTMLFILE;"#",":
                             "#"",DDIAG,DDIAG2,"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",ADATE,"#",":
                             "#"",DESTDESC,"#",":
                             "#"",DDATE,"#",":
                             "#"",PATLINK,"#",":
                             "#"",ADIAG1,ADIAG2,"#");"
.
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
          REP       "+ ",DOCTCODE
          RETURN
.------------------------------------------------------------
. Next Day, Week, Month
.------------------------------------------------------------
NEXT0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
          REP       " +",FILTCLAI
          REP       " +",WARDCODE
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
          WRITE     HTMLFILE;"patweb93.pbl":
                             "?reportno=",KEY2:
                             "&template=",KEY3:
                             "&wardcode=",WARDCODE:
                             "&frstdate=",NXTFDATE:
                             "&lastdate=",NXTLDATE:
                             "&viewtype=",VIEWTYPE:
                             "&discatdd=",DISCATDD:
                             "&filtdpst=",FILTDPST:
                             "&deftview=",DEFTVIEW:
                             "&selprint=",SELPRINT:
                             "&filtclai=",FILTCLAI;
          REP       "+ ",FILTCLAI
          REP       "+ ",WARDCODE
.
NEXT9999  RETURN
.------------------------------------------------------------
. Previous Day, Week, Month
.------------------------------------------------------------
PREV0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
          REP       " +",FILTCLAI
          REP       " +",WARDCODE
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
          WRITE     HTMLFILE;"patweb93.pbl":
                             "?reportno=",KEY2:
                             "&template=",KEY3:
                             "&wardcode=",WARDCODE:
                             "&frstdate=",PREFDATE:
                             "&lastdate=",PRELDATE:
                             "&viewtype=",VIEWTYPE:
                             "&discatdd=",DISCATDD:
                             "&filtdpst=",FILTDPST:
                             "&deftview=",DEFTVIEW:
                             "&selprint=",SELPRINT:
                             "&filtclai=",FILTCLAI;
          REP       "+ ",FILTCLAI
          REP       "+ ",WARDCODE
.
PREV9999  RETURN
.-----------------------------------------------------------
. Select Date From
.-----------------------------------------------------------
SELDAT00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          MOVE      DOCTCODE,KEY6
          MOVE      VIEWTYPE,KEY1
          WRITE     HTMLFILE;"<form name=SelectPeriod ":
                         "action=",LINKPRG,".pbl ":
                         "method=POST >":
                         "<input type=hidden name=reportno value=",LINKREP,">":
                         "<input type=hidden name=template value=",LINKTEM,">":
                         "<input type=hidden name=wardcode value=",WARDCODE,">":
                         "<input type=hidden name=viewtype value=",KEY1,">";
.
          CALL      SELV0000
.
          WRITE     HTMLFILE;"<input type=submit value=View>":
                             "</form>"
.
SELDAT99  RETURN
.------------------------------------------------------------
. Displays Admissions for a Ward
.------------------------------------------------------------
ATABA000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,DLINKPRG,DIM127
          UNPACK    DIM127,D1,DLINKREP,DIM127
          UNPACK    DIM127,D1,DLINKTEM,DIM127
.
...          CALL      AHEDA000      * Output Table Heading
.
          CALL      IBACLOCK            * Calculate expected discharge date
          PACK      KEY30,WARDCODE,FRSTDATE,SP70
          CALL      RDSTRAN4
ATABA100  CALL      RDKTRAN4
          BRANCH    OVRCD,ATABA900
          MATCH     WARDCODE,TWARD
          GOTO      ATABA900 IF NOT EQUAL
          MATCH     TDATE,LASTDATE
          GOTO      ATABA900 IF LESS
          MATCH     "A",TMOVE
          GOTO      ATABA100 IF NOT EQUAL
.
          CALL      AROWA000
          GOTO      ATABA100
ATABA900  
ATABA999  RETURN
.------------------------------------------------------------
. Current Discharge Table Heading
.------------------------------------------------------------
AHEDA000  MOVE      WBDESC,KEY20 
.
          UNPACK    FRSTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DATESTR,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          UNPACK    LASTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DATEEND,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          WRITE     HTMLFILE;"<tr>":
                             "<td colspan=5 align=center class=HeadingCell>":
                             "Admissions for ",KEY20,"<br>":
                              DATESTR," to ",DATEEND,"</td>":
                             "</tr>":
                             "<tr>":
                             "<td class=HeadingCell>Patient</td>":
                             "<td class=HeadingCell>Diagnoses</td>":
                             "<td class=HeadingCell>Att. Doct.</td>":
                             "<td class=HeadingCell>Admission Date</td>":
                             "<td class=HeadingCell>Discharge Date</td>":
                             "</tr>"
          RETURN
.------------------------------------------------------------
. Discharges     Patient Details
.------------------------------------------------------------
AROWA000  PACK      ADMISSNO,TADMN
          PACK      URNUMBER,TURNO
          CALL      GETPAT00 
          CALL      PATLN000
          UNPACK    ADMISSNO,KEY2,KEY6
          MOVE      ADMISSNO,KEY8
          CALL      RDDSCH1
          IF        OVRCD=1
            CALL      CLPATDSC
          ENDIF
.
.            MATCH     SP70,DDATE
.            IF        !@EQUAL
.              UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
.              MOVE      CMON,F2
.              LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG:
.                                   SEP,OCT,NOV,DEC
.              PACK      EXPCTDSC,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.            ENDIF
.          ENDIF
.
          MOVE      ADOCTA,DOCTCODE
          REP       " +",DOCTCODE
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
.
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CCC,CCENT
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      ADMISDAT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          CLEAR     PATLINK
          APPEND    LINKPRG,PATLINK
          APPEND    ".pbl?reportno=",PATLINK
          APPEND    LINKREP,PATLINK
          APPEND    "&template=",PATLINK
          APPEND    LINKTEM,PATLINK
          APPEND    "&urnumber=",PATLINK
          APPEND    URNUMBER,PATLINK
          APPEND    "&admissno=",PATLINK
          APPEND    ADMISSNO,PATLINK
          RESET     PATLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",FORMATNM,"#",":
                             "#"",PSEX,"#",":
                             "#"";
          CALL      WRTAGE00
          REP       "#" ",ADIAG1
          REP       "#" ",ADIAG2
          WRITE     HTMLFILE;"#",":
                             "#"",ADIAG1,ADIAG2,"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",ADATE,"#",":
                             "#"",DDATE,"#",":
                             "#"",DESTDESC,"#",":
                             "#"",PATLINK,"#");"
.
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
          REP       "+ ",DOCTCODE
          RETURN
.
.------------------------------------------------------------
. Ward Pre-Admissions
.------------------------------------------------------------
PPRE0000  BRANCH    FLDITMNO,PPRE0100,PPRE0200,PPRE0300,PPRE0400,PPRE0500:
                             PPRE0600,PPRE0700,PPRE0800,PPRE0900,PPRE1000:
                             PPRE1100,PPRE1200
          GOTO      PPRE9999
.
PPRE0100  CALL      NEXT0000
          GOTO      PPRE9999
.
PPRE0200  CALL      PREV0000
          GOTO      PPRE9999
.
PPRE0300  CALL      CURSTD00
          GOTO      PPRE9999
.
PPRE0400  CALL      CUREND00
          GOTO      PPRE9999
.
PPRE0500  CALL      CURYR000
          GOTO      PPRE9999
.
PPRE0600  CALL      CURMON00
          GOTO      PPRE9999
.
PPRE0700  CALL      SELV0000
          GOTO      PPRE9999
.
PPRE0800  CALL      PTABA000        * Table 
          GOTO      PPRE9999
.
PPRE0900  WRITE     HTMLFILE;TEMPLATE;
          GOTO      PPRE9999
.
PPRE1000  WRITE     HTMLFILE;REPORTNO;
          GOTO      PPRE9999
.
PPRE1100  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      PPRE9999
.
PPRE1200  PACK      DFLTWARD,WARDCODE
          CALL      WSEL0000        * Ward Select Options
          GOTO      PPRE9999
.
PPRE9999  RETURN
.------------------------------------------------------------
. Displays Pre-Admissions for a Ward
.------------------------------------------------------------
PTABA000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,DLINKPRG,DIM127
          UNPACK    DIM127,D1,DLINKREP,DIM127
          UNPACK    DIM127,D1,DLINKTEM,DIM127
.
...          CALL      PHEDA000      * Output Table Heading
.
          CALL      IBACLOCK            * Calculate expected discharge date
          PACK      KEY20,ONE,SP70
          CALL      RDSMISS6
PTABA100  CALL      RDKMISS6
          BRANCH    OVRCD,PTABA900
          COMPARE   ONE,ASTAT
          GOTO      PTABA900 IF NOT EQUAL
          MATCH     WARDCODE,PTMIXWRD
          GOTO      PTABA100 IF NOT EQUAL
          MATCH     FRSTDATE,ADATE
          GOTO      PTABA100 IF LESS
          MATCH     ADATE,LASTDATE
          GOTO      PTABA100 IF LESS
.
          CALL      PROWA000
          GOTO      PTABA100
.
PTABA900  
PTABA999  RETURN
.------------------------------------------------------------
. Current Discharge Table Heading
.------------------------------------------------------------
PHEDA000  MOVE      WBDESC,KEY20 
.
          UNPACK    FRSTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DATESTR,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          UNPACK    LASTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DATEEND,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          WRITE     HTMLFILE;"<tr>":
                             "<td colspan=5 align=center class=HeadingCell>":
                             "Pre-Admissions for ",KEY20,"<br>":
                              DATESTR," to ",DATEEND,"</td>":
                             "</tr>":
                             "<tr>":
                             "<td class=HeadingCell>Patient</td>":
                             "<td class=HeadingCell>Diagnoses</td>":
                             "<td class=HeadingCell>Att. Doct.</td>":
                             "<td class=HeadingCell>Admission Date</td>":
                             "<td class=HeadingCell>Discharge Date</td>":
                             "</tr>"
          RETURN
.------------------------------------------------------------
. Pre Admissions     Patient Details
.------------------------------------------------------------
PROWA000  PACK      ADMISSNO,AADMNO
          PACK      URNUMBER,AURNO
          CALL      GETPAT00 
          CALL      PATLN000
          UNPACK    ADMISSNO,KEY2,KEY6
          MOVE      ADMISSNO,KEY8
          CALL      RDDSCH1
          IF        OVRCD=1
            CALL      CLPATDSC
          ENDIF
.
          MOVE      ADOCTA,DOCTCODE
          REP       " +",DOCTCODE
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
.
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CCC,CCENT
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      ADMISDAT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          CLEAR     PATLINK
          APPEND    LINKPRG,PATLINK
          APPEND    ".pbl?reportno=",PATLINK
          APPEND    LINKREP,PATLINK
          APPEND    "&template=",PATLINK
          APPEND    LINKTEM,PATLINK
          APPEND    "&urnumber=",PATLINK
          APPEND    URNUMBER,PATLINK
          APPEND    "&admissno=",PATLINK
          APPEND    ADMISSNO,PATLINK
          RESET     PATLINK          
.
          WRITE     HTMLFILE;"t.addRow(#"",FORMATNM,"#",":
                             "#"",PSEX,"#",":
                             "#"";
          CALL      WRTAGE00
          WRITE     HTMLFILE;"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",ADATE,"#",":
                             "#"",PATLINK,"#");"
.
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
          REP       "+ ",DOCTCODE
          RETURN
.------------------------------------------------------------
. Displays Current Patient ward/bed details
.------------------------------------------------------------
CTABB000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,DLINKPRG,DIM127
          UNPACK    DIM127,D1,DLINKREP,DIM127
          UNPACK    DIM127,D1,DLINKTEM,DIM127
.
          CALL      CHEDB000      * Output Table Heading
.
          CALL      IBACLOCK            * Calculate expected discharge date
          PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
          BRANCH    WINPUT,CTABB500
.
          PACK      KEY16,WARDCODE,SP70
          CALL      RDSWARD8
CTABB100  CALL      RDKWARD8
          BRANCH    OVRCD,CTABB700
.
          MATCH     WARDCODE,WWARD
          GOTO      CTABB700 IF NOT EQUAL
.
          MATCH     SP70,WBED
          GOTO      CTABB100 IF EQUAL
.
          BRANCH    WACTIVE,CTABB100     *Do not display inactive bed
.
          CALL      CROWB000
          GOTO      CTABB100
.
. No Bed Ward
.------------------------------------------------------------
CTABB500  PACK      KEY13,WARDCODE,SP20
          CALL      RDSNOBE1
CTABB600  CALL      RDKNOBE1                * read next record
          BRANCH    OVRCD,CTABB700
          MATCH     WARDCODE,NBWARD         * same ward?
          GOTO      CTABB700 IF NOT EQUAL
.
          PACK      ADMISSNO,NBADMNO
          MOVE      NBROOM,WBED
          MOVE      ZERO,STBYFLAG
          CALL      CBEDB000         * Output Row Details
          GOTO      CTABB600
.
. On Leave Patients
.------------------------------------------------------------
CTABB700  MOVE      ONE,FIRSTONL
          PACK      KEY14,WARDCODE,SP70
          CALL      RDSONLV1
CTABB800  CALL      RDKONLV1
          BRANCH    OVRCD,CTABB950
          MATCH     OWARD,WARDCODE
          GOTO      CTABB950 IF NOT EQUAL
          MATCH     ZEROVISN,OADMNO
          GOTO      CTABB800 IF EQUAL
          IF        FIRSTONL=1
            MOVE      ZERO,FIRSTONL
            MOVE      "Patients On Leave",ROWHEAD
            CALL      CRHDB000       * Output Heading Row for On-Leave
          ENDIF
          PACK      ADMISSNO,OADMNO
          MOVE      OBED,WBED
          MOVE      ZERO,STBYFLAG
          CALL      CBEDB000         * Output Row Details
          GOTO      CTABB800
CTABB950  CALL      CENDB000
CTABB999  RETURN
.------------------------------------------------------------
. Current Admission Table Heading
.------------------------------------------------------------
CHEDB000  PACK      KEY5,CODECO,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,KEY20
          ELSE
            MOVE      SP70,KEY20
          ENDIF
          WRITE     HTMLFILE;"<tr>":
                               "<td colspan=5 align=center class=HeadingCell>":
                               "Current Admission for ":
                               WBDESC,"</td>":
                             "</tr>":
                             "<tr>":
                               "<td class=HeadingCell>Bed</td>":
                               "<td class=HeadingCell>Patient</td>":
                               "<td class=HeadingCell>",KEY20,"</td>":
                               "<td class=HeadingCell>Att. Doct.</td>":
                               "<td class=HeadingCell>Exp. Disch.</td>":
                             "</tr>"
          RETURN
.------------------------------------------------------------
. End of Table
.------------------------------------------------------------
CENDB000  BRANCH    FHIRTYPE,CENDB999
          WRITE     HTMLFILE;"<tr><td colspan=5>":
                             "<table border=0 align=center":
                             " width=100%>":
                             "<tr align=center><td width=40%></td>":
                             "<td class=AvailableCell align=center":
                             " width=10%>":
                             "Available Bed</td>":
                             "<td width=10% align=center class=StandbyCell>":
                             "Standby Patient":
                             "</td><td width=40%></td></tr>":
                             "</table></td></tr>"
CENDB999  RETURN
.------------------------------------------------------------
. Heading Row
.------------------------------------------------------------
CRHDB000  BRANCH    FHIRTYPE,CRHDB999
          WRITE     HTMLFILE;"<tr height=35><td colspan=5 align=center ":
                               "class=HeadingCell>",ROWHEAD,"</td></tr>"
CRHDB999  RETURN
.------------------------------------------------------------
. Current Admissions Empty Bed Row
.------------------------------------------------------------
CEMPB000  BRANCH    FHIRTYPE,CEMPB999
          WRITE     HTMLFILE;"<tr height=35 align=top>":
                    "<td align=center class=AvailableCell>":
                    WBED,"</td>":
                    "<td align=center>*** Available ***</td>":
                    "<td>&nbsp;</td>":
                    "<td>&nbsp;</td>":
                    "<td>&nbsp;</td>":
                    "</tr>";
CEMPB999  RETURN
.------------------------------------------------------------
. Current Admissions Patient Details
.------------------------------------------------------------
CBEDB000  CALL      GETPAT00 
          CALL      PATLN000
          CALL      PATFLD00                * Use standard Patient Folder sub
          MOVE      KEY3,FOLDERSF           * and store suffix
          MOVE      ADOCTA,DOCTCODE
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
          IF        STBYFLAG=0
            WRITE     HTMLFILE;"<tr height=35>":
                               "<td align=center>",WBED,"&nbsp;</td>"
          ELSE
            WRITE     HTMLFILE;"<tr height=35>":
                               "<td align=center class=StandbyCell>":
                               WBED,"&nbsp;</td>"
          ENDIF
          WRITE     HTMLFILE;"<td nowrap>":
                             "<img src=../images/PatientFolder",FOLDERSF,".gif":
                             " class=ListIcon ":
                             " onclick='location.href=#"",LINKPRG,".pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO,"#";'>":
                             FORMATNM,"</td>";
.
          CALL      GETCON00 * Get Patient Condition Details
          MATCH     SP70,CONDESC
          IF        !@EQUAL
            UNPACK    LPCDATE,CCENT,CYEAR,CMON,CDAY
            PACK      DISPDATE,LBRACKT,CDAY,SLASH,CMON,SP1,LPCTIME,RBRACKT 
          ELSE
            CLEAR     DISPDATE
          ENDIF
.
          WRITE     HTMLFILE;"<td>":
                             "<img src=../images/",IMGSRC," class=ListIcon ":
                             " onclick='UpdateCondition(#"":
                             URNUMBER,"#",#"",ADMISSNO,"#");'>":
                             CONDESC,DISPDATE,SP1:
                             LPCONDD,"</TD>";
.
          WRITE     HTMLFILE;"<td nowrap><a href='":
                             "javascript:DoctorViewFrame(#"",DOCTCODE,"#")'>":
                             DOCFNAME,"</a></td>":
                             "<td nowrap align=center class=",COLRFLAG,">":
                             EXPCTDSC,"</td>":
                             "</tr>";
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
CBEDB999  RETURN
+
.------------------------------------------------------------
.         Get Patient Condition Details
.------------------------------------------------------------
GETCON00  MOVE      SP70,CONDESC1
          MOVE      SP70,SAVKEY27
.
          PACK      KEY88,PTMASNAM,PMPXFNAM,AADMNO
          CALL      RDLOCA1
          BRANCH    OVRCD,GETCON10
.
          MATCH     SP70,LPCONDC
          GOTO      GETCON15 IF EQUAL
.
          PACK      KEY5,CODECO,LPCONDC
          CALL      RDCODE1
          BRANCH    OVRCD,GETCON15
          MOVE      TDESC,CONDESC
          MOVE      TDESC,CONDESC1
          MATCH     SP70,TCINDC1
          IF        @EQUAL
            MOVE      ZERO,TCINDC1
          ENDIF
          GOTO      GETCON20
.
GETCON10  MOVE      SP70,LPCONDD
          MOVE      SP70,LPCONDC
          MOVE      SP70,LPCDATE
          MOVE      SP70,LPCTIME
          MOVE      SP70,LPCONAM
GETCON15  MOVE      SP70,CONDESC
          MOVE      ZERO,TCINDC1
.
GETCON20  CLEAR     IMGSRC
          APPEND    "ConditionIcon_",IMGSRC
          IF        PCEASE=1
            APPEND    "D",IMGSRC
            MOVE      "Deceased",CONDESC
          ELSE
            APPEND    TCINDC1,IMGSRC
          ENDIF
          APPEND    ".gif",IMGSRC
          RESET     IMGSRC
.
GETCON50  PACK      KEY8,AADMNO,SP70
          CALL      RDPMWOR1
          IF        OVRCD=1
            CALL      CLPMWO00
            PACK      WORKDESC,SP70,SP70,SP70,SP70
            GOTO      GETCON80
          ENDIF
.
          PACK      WORKDESC,SP70,SP70,SP70,SP70
.
          MATCH     "1",STVVIEW
          GOTO      GETCON60 IF EQUAL
.
          CLEAR     WORKDESC
.
          MATCH     SP70,PMWOWDI1
          IF        !@EQUAL
            APPEND    "<br>",WORKDESC
            APPEND    PMWOWDI1,WORKDESC
          ENDIF
.
          MATCH     SP70,PMWOWDI2
          IF        !@EQUAL
            APPEND    "<br>",WORKDESC
            APPEND    PMWOWDI2,WORKDESC
          ENDIF
.
          MATCH     SP70,PMWOWDI3
          IF        !@EQUAL
            APPEND    "<br>",WORKDESC
            APPEND    PMWOWDI3,WORKDESC
          ENDIF
.
          APPEND    "&nbsp;",WORKDESC
          RESET     WORKDESC
          GOTO      GETCON80
.
GETCON60  MOVE      AURNO,PTATR001
          MOVE      AADMNO,PTATR002
          MOVE      "002",PTATR005     * Stored Working Diagnosis
          CALL      GETPAN00           * Get Patient Attribute Notes
.
GETCON80  MOVE      ZERO,MVFLAG
          COMPARE   ONE,DISPMV
          GOTO      GETCON99 IF NOT EQUAL   * Not displaying Mechanical Vent.
.
          PACK      KEY27,DAADMNO,SP70
          CALL      RSPTVEN1
GETCON82  CALL      RKPTVEN1
          BRANCH    OVRCD,GETCON99
.
          MATCH     DAADMNO,PTVEVISN
          GOTO      GETCON99 IF NOT EQUAL
.
          MATCH     SP70,PTVEEDAT
          GOTO      GETCON88 IF EQUAL
.
          MATCH     SP70,PTVEETIM
          GOTO      GETCON82 IF NOT EQUAL    * completed
.
GETCON88  MOVE      ONE,MVFLAG
          PACK      SAVKEY27,PTVEVISN,PTVEVTYP,PTVESDAT,PTVESTIM,SP70
.
GETCON99  RETURN
+
.------------------------------------------------------------------------------
.         Get Patient Attribute Notes (Patient Condition Details list output)
.------------------------------------------------------------------------------
GETPAN00  CLEAR     WORKDESC
          MOVE      ZERO,F1
          PACK      KEY35,PTATR001,PTATR002,PTATR005,SP70
          CALL      RSPTATR3
GETPAN10  CALL      RKPTATR3
          BRANCH    OVRCD,GETPAN90
.
          MATCH     PTATR001,PTARURNO
          GOTO      GETPAN90 IF NOT EQUAL
.
          MATCH     PTATR002,PTARVISN
          GOTO      GETPAN90 IF NOT EQUAL
.
          MATCH     PTATR005,PTARTYPE
          GOTO      GETPAN10 IF NOT EQUAL
.
          MATCH     SP70,PTARTXT1
          IF        !@EQUAL
            APPEND    "<br>",WORKDESC
            APPEND    PTARTXT1,WORKDESC
            MOVE      ONE,F1
          ENDIF
.
          MATCH     SP70,PTARTXT2
          IF        !@EQUAL
            APPEND    "<br>",WORKDESC
            APPEND    PTARTXT2,WORKDESC
            MOVE      ONE,F1
          ENDIF
.
          MATCH     SP70,PTARTXT3
          IF        !@EQUAL
            APPEND    "<br>",WORKDESC
            APPEND    PTARTXT3,WORKDESC
            MOVE      ONE,F1
          ENDIF
.
          IF        F1=1
            APPEND    "<br>",WORKDESC
          ENDIF
.
GETPAN90  RESET     WORKDESC
          GOTO      GETPAN99
.
GETPAN99  RETURN
+
.------------------------------------------------------------
. Output Ward/Bed Row
.------------------------------------------------------------
CROWB000  MATCH     ZEROVISN,WADMNO
          GOTO      CROWB900 IF EQUAL
.
          PACK      ADMISSNO,WADMNO
          MOVE      ZERO,STBYFLAG
          CALL      CBEDB000         * Output Row Details
.
          MATCH     ZEROVISN,WSTBY
          GOTO      CROWB999 IF EQUAL
.
          PACK      ADMISSNO,WSTBY
          MOVE      ONE,STBYFLAG
          CALL      CBEDB000         * Output Row Details
.
          GOTO      CROWB999
.
CROWB900  CALL      CEMPB000         * Current Admissions Empty Bed Row
.
CROWB999  RETURN
.------------------------------------------------------------
. Update Patient Condition
.------------------------------------------------------------
UPDCON00  MATCH     "1",CALCEXLS
          IF        @EQUAL
            UNPACK    ADMISSNO,KEY8
            CALL      RDMISS1
            BRANCH    OVRCD,UPDCON99
.
            MATCH     SP70,PMSWO005
            IF        	!@EQUAL & !@EOS
              MATCH       SP70,ADATE
              IF          !@EQUAL & !@EOS
                MOVE        ADATE,CDYSFDTE
                MOVE        PMSWO005,CDYSTDTE
                CALL        CALCDAYS
                SUB         ONE,CDYSDAYS
                MOVE        CDYSDAYS,ASTAY
                CALL        UPMISS1
              ENDIF
            ENDIF 
          ENDIF
.
          MATCH     "1",NEXTPATF
          IF        !@EQUAL
            UNPACK    ADMISSNO,KEY8
            CALL      RDMISS1
            BRANCH    OVRCD,UPDCON99
            MOVE      AURNO,KEY8
.
            MATCH     Z70,PTMIS038
            IF        !@EQUAL
              MOVE      PTMIS038,AUSR2
              CALL      UPMISS1    
            ENDIF
.
          ELSE
            MOVE      URNUMBER,KEY8
            MOVE      ADMISSNO,AADMNO
            MOVE      SP10,ADATE
          ENDIF
          CALL      RDMAST1
          CALL      RDPMPX21
.
          MOVE      SP70,LPCONDC
          MOVE      SP70,LPCONDD
          MOVE      SP70,LPCDATE
          MOVE      SP70,LPCTIME
          CALL      IBACLOCK
.
          PACK      KEY88,PTMASNAM,PMPXFNAM,AADMNO
          CALL      RDLOCA1
          IF        OVRCD=0
            MOVE      PATCONCD,LPCONDC
            MOVE      PATCONDS,LPCONDD
            MOVE      PATCONAM,LPCONAM         * Ambulatory status
            PACK      LPCDATE,CCC,CYY,CMM,CDD
            REP       " 0",LPCDATE
            MOVE      CTIMEIS,LPCTIME
            CALL      UPLOCA1
          ENDIF
.
          CALL      UPUDF000                * Update User Defined Comments
.
          COMPARE   ZERO,WDIGFLAG           * Do not update PMSWORFD
          GOTO      UPDCON30 IF EQUAL
.
          CALL      ADDWOR00                * Set working diagnosis comments
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPMWOR1
          IF        OVRCD=1
            CALL      CLPMWO00
            MOVE      AADMNO,PMWOADMN
            CALL      MVPMWO00
            PACK      PMWOCDAT,CCC,CYY,CMM,CDD
            REP       " 0",PMWOCDAT
            CLOCK     TIME,PMWOCTIM
            MOVE      USERID,PMWOCUID
            CALL      WRPMWOR1
          ELSE
            CALL      MVPMWO00
            PACK      PMWOUDAT,CCC,CYY,CMM,CDD
            REP       " 0",PMWOUDAT
            CLOCK     TIME,PMWOUTIM
            MOVE      USERID,PMWOUUID
            CALL      UPPMWOR1
          ENDIF
.
          MATCH     "1",PTCNBMAN            * update patbmdaf if in use
          IF        @EQUAL
            PACK      KEY30,AADMNO,SP70
            CALL      RDSTRAN2
            CALL      RDKTRAN2
            BRANCH    OVRCD,UPDCON30
.
            MATCH     DAADMNO,DTADMN
            GOTO      UPDCON30 IF NOT EQUAL
.
            MATCH     "A",TMOVE
            GOTO      UPDCON30 IF NOT EQUAL
.
            MOVE      TDATE,TRANDATE
            MOVE      TTIME,TRANTIME
            MOVE      TWARD,TRNTOWRD
            MOVE      TBED,TRNTOBED
.
            UNPACK    ADMISSNO,KEY8
            CALL      RDMISS1
            BRANCH    OVRCD,UPDCON30
.
            MATCH     SP70,PMWOEDAT
            IF        @EQUAL
              MOVE      ASTAY,STAYDAYS
            ELSE
              DAYSEP    TDATE,PMWOEDAT,STAYDAYS
            ENDIF
            CALL      UPPBMN00              * Write to bed management table
          ENDIF
.
UPDCON30  MOVE      SP70,PMVXVALW
          MOVE      SP70,PMVXPALW
          MOVE      SP70,PMVXUDF2
          MOVE      AADMNO,PMVXVISN            * Find Visit extension record
          PACK      KEY8,PMVXVISN,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,UPDCON99
.
          MATCH     SP10,ADATE
          IF        !@EQUAL 
            MOVE      ADATE,PMVXVSDT
          ENDIF
          MOVE      PPOST,PMVXPOST
          MOVE      PPOST,D8
          SQUEEZE   D8
          MOVE      D8,F4
          MOVE      F4,D4
          REP       " 0",D4
          PACK      PPOST,D4,SP10
          PACK      KEY56,PPOST,PSUBRB,SP10,PADD4,SP70                *C-240184
          CALL      RDIBPOS1
          IF        OVRCD=0
            MOVE      IBPOASGC,PMVXASGC
          ELSE                                                        *I-240184
            PACK      KEY56,PPOST,PSUBRB,SP70
            CALL      RSIBPOS1
            CALL      RKIBPOS1
            BRANCH    OVRCD,UPDCON40
            MATCH     PPOST,IBPOPCOD
            IF        @EQUAL
              MATCH     PSUBRB,IBPOSUBR
              IF        @EQUAL
                MOVE      IBPOASGC,PMVXASGC
              ENDIF
            ENDIF
          ENDIF
.
UPDCON40  MOVE      PATCONVA,PMVXVALW
          MOVE      PATCONPA,PMVXPALW
          MOVE      PATCONTL,PMVXUDF2
          CALL      MVVXTF00

          CALL      UPPMVX11
.
.         Get the discharge details (if available) prior to sending an A08
.
          CALL      CLPATDSC                     * clear discharge variables
          MOVE      AADMNO,KEY8
          CALL      RDDSCH1
.
.         Get the last transfer record for the admission prior to
.         sending an A08
.
          PACK      KEY30,AADMNO,Z70
          CALL      RDSTRAN2                  * position on admission
          CALL      RDPTRAN2                  * read previous record
          BRANCH    OVRCD,UPDCON99            * eof - shouldn't happen
.
          MATCH     AADMNO,TADMN              * same admission still ?
          GOTO      UPDCON99 IF NOT EQUAL     * no - shouldn't happen
.
.         Get the PRA details prior to sending an A08
.
          CALL      CLRRES00
          MOVE      AADMNO,KEY8
          CALL      RDPTRES1
.
          CALL      PMIGTNID                  * get national id
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TWO,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICAC                  * broadcast admission update
.
          CALL      VBCMN000
.
.         Update Patient Attribute notes (Working Diag, Relevant Med History,
.         Barriers to Discharge)
.
          MATCH     Z70,ATWDIAFN
          IF        !@EQUAL
            MOVE      ATWDIAFN,ATTMPFIL     * Working Diagnosis
            CALL      MOVATF00              * Read notes from temp file
            MOVE      URNUMBER,PTATR001
            MOVE      ADMISSNO,PTATR002
            MOVE      "002",PTATR005
            CALL      UPDNOT00              * Update Attribute Text Fields 1-3
            CLOSE     ATTMPFAF,DELETE
          ENDIF
.
          MATCH     Z70,ATMHISFN
          IF        !@EQUAL
            MOVE      ATMHISFN,ATTMPFIL     * Relevant Medical History
            CALL      MOVATF00              * Read notes from temp file
            MOVE      URNUMBER,PTATR001
            MOVE      ADMISSNO,PTATR002
            MOVE      "003",PTATR005
            CALL      UPDNOT00              * Update Attribute Text Fields 1-3
            CLOSE     ATTMPFAF,DELETE
          ENDIF
.
          MATCH     Z70,ATBDISFN
          IF        !@EQUAL
            MOVE      ATBDISFN,ATTMPFIL     * Barriers to Discharge
            CALL      MOVATF00              * Read notes from temp file
            MOVE      URNUMBER,PTATR001
            MOVE      ADMISSNO,PTATR002
            MOVE      "004",PTATR005
            CALL      UPDNOT00              * Update Attribute Text Fields 1-3
            CLOSE     ATTMPFAF,DELETE
          ENDIF
.
UPDCON99  CLOSE     PMHFILAF,DELETE
          CLOSE     WDIFILAF,DELETE
          CLOSE     CLNFILAF,DELETE
          CLOSE     WORCOMAF,DELETE
          RETURN
.------------------------------------------------------------
. Update User Defined Comments
.------------------------------------------------------------
UPUDF000  MOVE      ZERO,F3
          CALL      IBACLOCK
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8

UPUDF100  ADD       ONE,F3
          LOAD      KEY100,F3,USERDF01,USERDF02,USERDF03,USERDF04,USERDF05:
                              USERDF06,USERDF07,USERDF08,USERDF09,USERDF10
          MOVE      "018",VSCTTYPE
          MOVE      F3,KEY3
          PACK      KEY14,ADMISSNO,VSCTTYPE,KEY3,SP70
          CALL      RDVSCMT1
          IF        OVRCD=0
            MOVE      KEY100,VSCTDATA
            PACK      VSCTUKEY,KEY8,CTIMEIS,WBSEUID,SP70
            CALL      UPVSCMT1
          ELSE
            PACK      VSCTDATA,SP70,SP70
            MATCH     VSCTDATA,KEY100
            IF        !@EQUAL
              UNPACK    KEY14,VSCTVIST,VSCTTYPE,VSCTLINE
              MOVE      KEY100,VSCTDATA
              MOVE      SP70,VSCTSPAR
              CALL      WRVSCMT1
            ENDIF
          ENDIF
          IF       F3<10
            GOTO     UPUDF100
          ENDIF
.
UPUDF999  RETURN
.------------------------------------------------------------
. Output Patient Condition Form
.------------------------------------------------------------
PATCON00  MOVE      ZERO,MASTFLAG
          MOVE      ZERO,MISSFLAG
          MOVE      SP70,DOCTCODE
          UNPACK    URNUMBER,KEY2,KEY6
          MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,PATCON90
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MOVE      ADMISSNO,KEY8
          CALL      RDPMVX11
          IF        OVRCD=1
           CALL       CPVXTF00
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMWOR1
          IF        OVRCD=1
            CALL      CPPMWO00
          ENDIF
.
          UNPACK    ADMISSNO,KEY2,KEY6
          MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,PATCON95
          BRANCH    ASTAT,PATCON96,PATCON10,PATCON96,PATCON10,PATCON96
.
PATCON10  CALL      RGMCOD00   * Get Regime Codes
          CALL      GETCON00   * Get Patients Current Condition
          CALL      PATNAA00   * Format Patient Name without bold
.
          CLEAR     WEBTITLE
          APPEND    "Update Patient Condition - ",WEBTITLE
          APPEND    SP1,WEBTITLE
          APPEND    PATFNAME,WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,PATCON99
.
          CALL      WEBBOD00   * Output Templated Body of HTML 
.
          CALL      WEBEND00   * Output End of Web Page
          GOTO      PATCON99
.
PATCON90  MOVE      "INVALID U/R NO",WEBTITLE
          CALL      WEBERR00
          GOTO      PATCON99
.
PATCON95  MOVE      "INVALID ADMISSION NO",WEBTITLE
          CALL      WEBERR00
          GOTO      PATCON99
.
PATCON96  MOVE      "ADMISSION IS NOT CURRENT",WEBTITLE
          CALL      WEBERR00
          GOTO      PATCON99
.
PATCON99  RETURN
+
.------------------------------------------------------------
. Patient Condition Form
.------------------------------------------------------------
CONF0000  BRANCH    FLDITMNO,CONF0100,CONF0200,CONF0300,CONF0400,CONF0500:
                             CONF0600,CONF0700,CONF0800,CONF0900,CONF1000:
                             CONF1100,CONF1200,CONF1300,CONF1400,CONF1500:
                             CONF1600,CONF1700,CONF1800,CONF1900,CONF2000:
                             CONF2100,CONF2200,CONF2300,CONF2400,CONF2500:
                             CONF2600,CONF2700,CONF2800,CONF2900
.
          WRITE     HTMLFILE;"Invalid Tag in HTML";
          GOTO      CONF9999
.
CONF0100  WRITE     HTMLFILE;"action=#"patweb93.pbl#">":
                             "<input type=hidden name=reportno value=6>":
                             "<input type=hidden name=template ":
                             "value=",KEY3,">":
                             "<input type=hidden name=urnumber ":
                             "value=#"",URNUMBER,"#">":
                             "<input type=hidden name=admissno ":
                             "value=#"",ADMISSNO,"#">"
          GOTO      CONF9999
.
CONF0200  MOVE      CODECO,CATEGORY
          MOVE      LPCONDC,CODE
          CALL      CODSEL00
          GOTO      CONF9999
.
CONF0300  MATCH     SP70,LPCONDD
          GOTO      CONF9999 IF EQUAL 
          WRITE     HTMLFILE;LPCONDD;
          GOTO      CONF9999
.
CONF0400  WRITE     HTMLFILE;LPCONDC;
          GOTO      CONF9999
.
CONF0500  WRITE     HTMLFILE;CONDESC;
          GOTO      CONF9999
.
CONF0600  CALL      VISFLG00
          GOTO      CONF9999
.
CONF0700  MOVE      CODEAM,CATEGORY
          MOVE      LPCONAM,CODE
          CALL      CODSEL00
          GOTO      CONF9999
.
CONF0800  PACK      KEY16,LPCDATE,LPCTIME,SP10 * move t/stamp into parm
          CALL      TSTMP000                   * reformat t/stamp
          WRITE     HTMLFILE;KEY20;            * Output last update datetime
          GOTO      CONF9999
.
CONF0900  MOVE      "U2",CATEGORY
          MOVE      AUSR2,CODE
          CALL      CODITM00
          GOTO      CONF9999
.
CONF1000  CALL      MCMN0000
          GOTO      CONF9999
.
CONF1100  CALL      WCMN0000
          GOTO      CONF9999
.
CONF1200  CALL      CCMN0000
          GOTO      CONF9999
.
CONF1300  CALL      USDEF000
          GOTO      CONF9999
.
CONF1400  WRITE     HTMLFILE;RGMCOD01;  
          GOTO      CONF9999
.
CONF1500  WRITE     HTMLFILE;RGMCOD02;
          GOTO      CONF9999
.
CONF1600  WRITE     HTMLFILE;RGMCOD03;
          GOTO      CONF9999
.
CONF1700  MOVE      URNUMBER,PTATR001
          MOVE      ADMISSNO,PTATR002
          MOVE      "5",ATTYPIND       * Attribute Type 5 ('Falls Risk')
          MOVE      "1",ATCODIND       * Attribute Coded Field 1
          CALL      GETACV00           * Get Attribute Coded Field value
          WRITE     HTMLFILE;ATCODVAL;
          GOTO      CONF9999
.
CONF1800  MOVE      URNUMBER,PTATR001
          MOVE      ADMISSNO,PTATR002
          MOVE      "6",ATTYPIND       * Attr Type 6 ('Pressure Injury Risk')
          MOVE      "1",ATCODIND       * Attribute Coded Field 1
          CALL      GETACV00           * Get Attribute Coded Field value
          WRITE     HTMLFILE;ATCODVAL;
          GOTO      CONF9999
.
CONF1900  MOVE      URNUMBER,PTATR001
          MOVE      ADMISSNO,PTATR002
          MOVE      "7",ATTYPIND       * Attr Type 7 ('Abscond Risk')
          MOVE      "1",ATCODIND       * Attribute Coded Field 1
          CALL      GETACV00           * Get Attribute Coded Field value
          WRITE     HTMLFILE;ATCODVAL;
          GOTO      CONF9999
.
CONF2000  MOVE      URNUMBER,PTATR001
          MOVE      ADMISSNO,PTATR002
          MOVE      "8",ATTYPIND       * Attr Type 8 ('Malnutrition Risk')
          MOVE      "1",ATCODIND       * Attribute Coded Field 1
          CALL      GETACV00           * Get Attribute Coded Field value
          WRITE     HTMLFILE;ATCODVAL;
          GOTO      CONF9999
.
CONF2100  MOVE      URNUMBER,PTATR001
          MOVE      ADMISSNO,PTATR002
          MOVE      "9",ATTYPIND       * Attr Type 9 ('Exp disch dest')
          MOVE      "1",ATCODIND       * Attribute Coded Field 1
          CALL      GETACV00           * Get Attribute Coded Field value
          WRITE     HTMLFILE;ATCODVAL;
          GOTO      CONF9999
.
CONF2200  MOVE      URNUMBER,PTATR001
          MOVE      ADMISSNO,PTATR002
          MOVE      "10",ATTYPIND      * Attr Type 10 ('Non Weight Bearing')
          MOVE      "1",ATCODIND       * Attribute Coded Field 1
          CALL      GETACV00           * Get Attribute Coded Field value
          WRITE     HTMLFILE;ATCODVAL;
          GOTO      CONF9999
.
CONF2300  MOVE      URNUMBER,PTATR001
          MOVE      ADMISSNO,PTATR002
          MOVE      "9",ATTYPIND       * Attr Type 9 ('Expected Discharge Dest')
          MOVE      "1",ATCODIND       * Attribute Text Field 1
          CALL      GETTFV00           * Get Attribute Text Field value
          WRITE     HTMLFILE;ATTXTVAL;
          GOTO      CONF9999
.
CONF2400  MOVE      URNUMBER,PTATR001
          MOVE      ADMISSNO,PTATR002
          MOVE      "002",PTATR005
          CALL      GETNTE00
          GOTO      CONF9999
.
CONF2500  MOVE      URNUMBER,PTATR001
          MOVE      ADMISSNO,PTATR002
          MOVE      "003",PTATR005
          CALL      GETNTE00
          GOTO      CONF9999
.
CONF2600  MOVE      URNUMBER,PTATR001
          MOVE      ADMISSNO,PTATR002
          MOVE      "004",PTATR005
          CALL      GETNTE00
          GOTO      CONF9999
.
CONF2700  CALL      PAEXST00
          GOTO      CONF9999
.
CONF2800  CALL      GETATD00      * Get time diff (mins) adm to last disch
          GOTO      CONF9999
.
CONF2900  CALL      LSTADM00      * Get last discharge admno
          GOTO      CONF9999
.
CONF9999  RETURN
+
.------------------------------------------------------------------------------
.         Check if Patient Attribute record exists for UR/Admno
.------------------------------------------------------------------------------
PAEXST00  PACK      KEY35,URNUMBER,SP70
          CALL      RSPTATR3
PAEXST10  CALL      RKPTATR3
          BRANCH    OVRCD,PAEXST91
.
          MATCH     PTARURNO,URNUMBER
          GOTO      PAEXST91 IF NOT EQUAL
.
          MATCH     PTARVISN,ADMISSNO
          GOTO      PAEXST10 IF NOT EQUAL
.
          WRITE     HTMLFILE;ONE;
          GOTO      PAEXST99
.
PAEXST91  WRITE     HTMLFILE;ZERO;
PAEXST99  RETURN
+
.------------------------------------------------------------------------------
.         Get the last discharge admission no.
.------------------------------------------------------------------------------
LSTADM00  PACK      KEY24,URNUMBER,Z70
          CALL      RDSDSCH3
LSTADM10  CALL      RDPDSCH3
          BRANCH    OVRCD,LSTADM99
.
          MATCH     DURNO,URNUMBER
          GOTO      LSTADM99 IF NOT EQUAL
.
          WRITE     HTMLFILE;DDADMNO;
.
LSTADM99  RETURN
+
.------------------------------------------------------------------------------
.         Get time difference (in minutes) between the current Admission and
.         last Discharge date/time.
.------------------------------------------------------------------------------
GETATD00  MOVE      ZERO,FORM4
          MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,GETATD99
.
          MATCH     "2",DASTAT
          GOTO      GETATD99 IF NOT EQUAL
.
          PACK      KEY24,URNUMBER,Z70
          CALL      RDSDSCH3
GETATD10  CALL      RDPDSCH3
          BRANCH    OVRCD,GETATD99
.
          MATCH     DURNO,URNUMBER
          GOTO      GETATD99 IF NOT EQUAL
.
          MOVE      DDATE,FIRSTDAT
          UNPACK    DTIME,DIM5
          REP       ": ",DIM5
          SQUEEZE   DIM5
          MOVE      DIM5,FIRSTIME
.
          MOVE      ADATE,LASTDATE
          MOVE      ATIME,DIM5
          REP       ": ",DIM5
          SQUEEZE   DIM5
          MOVE      DIM5,LASTTIME
.
          CALL      TIMEDIFF
          MOVE      CALCTIME,MINSDIFF
          LJUSTIFY  MINSDIFF
          STRIP     MINSDIFF
          MOVELPTR  MINSDIFF,FORM6
          SFORMAT   VAR,FORM6
          MOVE      MINSDIFF,VAR
          WRITE     HTMLFILE;VAR;
.
GETATD99  RETURN
+
.------------------------------------------------------------
. Get User Defined Fields from Visit Comments
.------------------------------------------------------------
USDEF000  UNPACK    DIM127,D1,KEY3,DIM127
          MOVE      KEY3,F3
          MOVE      F3,KEY3
          MOVE      "018",VSCTTYPE
          PACK      KEY14,ADMISSNO,VSCTTYPE,KEY3,SP70
          CALL      RDVSCMT1
          IF        OVRCD=0
            WRITE     HTMLFILE;VSCTDATA;
          ENDIF
USDEF999  RETURN
.------------------------------------------------------------
. Get Visit Extension file flags.
.------------------------------------------------------------
VISFLG00  UNPACK    DIM127,D1,FLAGID,DIM127
          MATCH     SP1,FLAGID
          GOTO      VISFLG99 IF EQUAL
          MOVE      FLAGID,FLGITMNO
.
          MOVE      AADMNO,PMVXVISN            * Find Visit extension record
          PACK      KEY8,PMVXVISN,SP70
          CALL      RDPMVX11
          IF        OVRCD=1
            MOVE      SP70,PMVXVALW
            MOVE      SP70,PMVXPALW
            MOVE      SP70,PMVXUDF2
            GOTO      VISFLG99
          ENDIF
.
          BRANCH    FLGITMNO,VISFLG01,VISFLG02,VISFLG03
.
VISFLG01  WRITE     HTMLFILE;PMVXVALW;
          GOTO      VISFLG99
.
VISFLG02  WRITE     HTMLFILE;PMVXPALW;
          GOTO      VISFLG99
.
VISFLG03  WRITE     HTMLFILE;PMVXUDF2;
          GOTO      VISFLG99
.
VISFLG99  RETURN
.------------------------------------------------------------
. Ward Bookings 
.------------------------------------------------------------
PBOK0000  BRANCH    FLDITMNO,PBOK0100,PBOK0200,PBOK0300,PBOK0400,PBOK0500:
                             PBOK0600,PBOK0700,PBOK0800,PBOK0900,PBOK1000:
                             PBOK1100,PBOK1200,PBOK1300
          GOTO      PBOK9999
.
PBOK0100  CALL      NEXT0000
          GOTO      PBOK9999
.
PBOK0200  CALL      PREV0000
          GOTO      PBOK9999
.
PBOK0300  CALL      CURSTD00
          GOTO      PBOK9999
.
PBOK0400  CALL      CUREND00
          GOTO      PBOK9999
.
PBOK0500  CALL      CURYR000
          GOTO      PBOK9999
.
PBOK0600  CALL      CURMON00
          GOTO      PBOK9999
.
PBOK0700  CALL      SELV0000
          GOTO      PBOK9999
.
PBOK0800  CALL      BTABA000        * Table of Bookings Expected Discharge    
          GOTO      PBOK9999
.
PBOK0900  WRITE     HTMLFILE;TEMPLATE;
          GOTO      PBOK9999
.
PBOK1000  WRITE     HTMLFILE;REPORTNO;
          GOTO      PBOK9999
.
PBOK1100  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      PBOK9999
.
PBOK1200  PACK      DFLTWARD,WARDCODE
          CALL      WSEL0000        * Ward Select Options
          GOTO      PBOK9999
.
PBOK1300  CALL      BTABB000        * Bookings Consultant and Diagnosis
          GOTO      PBOK9999
.
PBOK9999  RETURN
.------------------------------------------------------------
. Displays Bookings for a Ward with Expected Discharge
.------------------------------------------------------------
BTABA000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,OPTIONZ,DIM127
.
          CALL      BHEDA000      * Output Table  Heading
.
          CALL      IBACLOCK           
.          
          PACK      KEY19,WARDCODE,FRSTDATE,SP70
          CALL      RSBKREC7
BTABA100  CALL      RKBKREC7
          BRANCH    OVRCD,BTABA900
          MATCH     WARDCODE,BKREWARD
          GOTO      BTABA900 IF NOT EQUAL
          MATCH     BKREEDAT,LASTDATE
          GOTO      BTABA900 IF LESS
.
          MOVE      BKRESTAT,STATUS
.          
          PACK      BOOKSTAT,BOOKED,SP6
          MOVE      BKRESTAT,F1
          LOAD      BOOKSTAT,F1,PREADM,CANCEL,ADMITT,DISCHR
.
          REP       "aA",OPTIONZ 
          MATCH     "A",OPTIONZ
          GOTO      BTABA200 IF EQUAL 
.                
          MATCH     STATUS,OPTIONZ
          GOTO      BTABA100 IF NOT EQUAL  
.
BTABA200  PACK      KEY5,CAT,BKRETYPE
          CALL      RDCODE1
          BRANCH    OVRCD,BTABA300
          MATCH     TCODE,CAT
          GOTO      BTABA300 IF NOT EQUAL
          MATCH     ACODE,BKRETYPE 
          GOTO      BTABA300 IF NOT EQUAL               
          MATCH     "THE ",THCSCOD
          IF        @EQUAL
            PACK      KEY31,BKREBOOK,SP70
            CALL      RSOPDEA2
            CALL      RKOPDEA2 
            BRANCH    OVRCD,BTABA300
            MOVE      BKREBOOK,DIM8
            MATCH     DIM8,OPDAADMN
            GOTO      BTABA300 IF NOT EQUAL
          ENDIF 
          MOVE      ZERO,TFLAG
          GOTO      BTABA400  
.
BTABA300  MOVE      ONE,TFLAG
.
BTABA400  CALL      BROWA000   * expected Bookings output 
          GOTO      BTABA100
.
BTABA900  
BTABA999  RETURN
.------------------------------------------------------------
. Displays Bookings for a Ward with Consultant and Diagnosis
.------------------------------------------------------------
BTABB000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,OPTIONZ,DIM127
.
          CALL      IBACLOCK           
.          
          PACK      KEY16,FRSTDATE,SP70
          CALL      RSBKREC4
BTABB100  CALL      RKBKREC4
          BRANCH    OVRCD,BTABB900
.
          MATCH     BKREEDAT,LASTDATE
          GOTO      BTABB900 IF LESS
.
          PACK      KEY8,BKREBOOK,SP70
          CALL      RDBKRX11
          BRANCH    OVRCD,BTABB100
.
          MATCH     SP70,BKREWARD
          IF        @EQUAL
            MATCH     WARDCODE,BKRXPOWD
            GOTO      BTABB100 IF NOT EQUAL
          ELSE
            MATCH     WARDCODE,BKREWARD
            GOTO      BTABB100 IF NOT EQUAL
          ENDIF
.
          MOVE      BKRESTAT,STATUS
.          
          PACK      BOOKSTAT,BOOKED,SP6
          MOVE      BKRESTAT,F1
          LOAD      BOOKSTAT,F1,PREADM,CANCEL,ADMITT,DISCHR
.
          REP       "aA",OPTIONZ 
          MATCH     "A",OPTIONZ
          GOTO      BTABB200 IF EQUAL 
.                
          MATCH     STATUS,OPTIONZ
          GOTO      BTABB100 IF NOT EQUAL  
.
BTABB200  PACK      KEY5,CAT,BKRETYPE
          CALL      RDCODE1
          BRANCH    OVRCD,BTABB300
          MATCH     TCODE,CAT
          GOTO      BTABB300 IF NOT EQUAL
          MATCH     ACODE,BKRETYPE 
          GOTO      BTABB300 IF NOT EQUAL               
          MATCH     "THE ",THCSCOD
          GOTO       BTABB300 IF NOT EQUAL
.
          PACK      KEY31,BKREBOOK,SP70
          CALL      RSOPDEA2
          CALL      RKOPDEA2 
          BRANCH    OVRCD,BTABB300
          MOVE      BKREBOOK,DIM8
          MATCH     DIM8,OPDAADMN
          GOTO      BTABB300 IF NOT EQUAL
.
          MOVE      ZERO,TFLAG
          GOTO      BTABB400  
.
BTABB300  MOVE      ONE,TFLAG
.
BTABB400  CALL      BROWB000   * consultant/diagnosis Bookings output 
          GOTO      BTABB100
.
BTABB900  
BTABB999  RETURN
.------------------------------------------------------------
. Current Booking Table Heading with Expected Dishcarge Date
.------------------------------------------------------------
BHEDA000  MOVE      WBDESC,KEY20 
.
          UNPACK    FRSTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DATESTR,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          UNPACK    LASTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DATEEND,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          WRITE     HTMLFILE;"<tr>":
                             "<td colspan=5 align=center class=HeadingCell>":
                             "Bookings for ",KEY20,"<br>":
                              DATESTR," to ",DATEEND,"</td>":
                             "</tr>":
                             "<tr>":
                             "<td class=HeadingCell>Bed</td>":
                             "<td class=HeadingCell>Patient</td>":
                             "<td class=HeadingCell>Booking Date/Time</td>":
                             "<td class=HeadingCell>Status></td>":
                             "<td class=HeadingCell>Exp.Discharge Date</td>":
                             "</tr>"
.         
BHEDA999  RETURN
.------------------------------------------------------------
. Current Booking Table Heading with Consultant and Diagnosis
.------------------------------------------------------------
BHEDB000  MOVE      WBDESC,KEY20 
.
          UNPACK    FRSTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DATESTR,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          UNPACK    LASTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DATEEND,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          WRITE     HTMLFILE;"<tr>":
                             "<td colspan=6 align=center class=HeadingCell>":
                             "Bookings for ",KEY20,"<br>":
                              DATESTR," to ",DATEEND,"</td></tr>":
                             "<tr><td class=HeadingCell>Bed</td>":
                                 "<td class=HeadingCell>Patient</td>":
                                 "<td class=HeadingCell>Booking Date/Time</td>":
                                 "<td class=HeadingCell>Status</td>":
                                 "<td class=HeadingCell>Consultant</td>":
                                 "<td class=HeadingCell>Diagnosis</td>":
                                 "</tr>"
.         
BHEDB999  RETURN
.------------------------------------------------------------
. Bookings Patient Details
.------------------------------------------------------------
BROWA000  PACK      ADMISSNO,BKREBOOK
          PACK      URNUMBER,BKREURNO
          CALL      GETPAT00 
          CALL      PATLN000
          CALL      PATFLD00                * Use standard Patient Folder sub
          MOVE      KEY3,FOLDERSF           * and store suffix
          MOVE      ABED,BED
.
          IF        BKRESTAT=4
            PACK      ADMISSNO,BKREBOOK
            CALL      RDDSCH1        
            BRANCH    OVRCD,BROWA200
            UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      EXPCTDSC,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
            PACK      FHRENDDT,CCENT,CYEAR,FHRDASH,CMON,FHRDASH,CDAY
          ENDIF
. 
BROWA200  IF        BKRESTAT=2
            MOVE      "&nbsp;",EXPCTDSC         
            PACK      FHRENDDT,SP70
          ENDIF           
. 
          IF        TFLAG=1          
            PACK     TIME,BKREATIM    
          ELSE
            PACK     TIME,OPDAEXPS
          ENDIF                
.
          MATCH      TIME,SP5
          IF         @EQUAL
            MOVE       SP2,ATTIME
          ELSE
            MOVE       AT,ATTIME       
          ENDIF   
.
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
.
          UNPACK    BKREEDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      BOOKNDAT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          WRITE     HTMLFILE;"<tr height=35><td align=center>":
                             BED,"&nbsp;</td>":
                             "<td nowrap>":
                             "<img src=../images/PatientFolder",FOLDERSF,".gif":
                             " class=ListIcon ":
                             " onclick='location.href=#"",LINKPRG,".pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO,"#";'>":
                             FORMATNM,"</td>":
                             "<td nowrap align=center>",BOOKNDAT,ATTIME:
                             TIME,"</td>":
                             "<td nowrap align=center>",BOOKSTAT,"</td>":
                             "<td nowrap align=center>",EXPCTDSC,"</td>":
                             "</tr>"
.
BROWA900  REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
BROWA999 RETURN
.------------------------------------------------------------
. Bookings Patient Details with Consultant/Diagnosis
.------------------------------------------------------------
BROWB000  PACK      ADMISSNO,BKREBOOK
          PACK      URNUMBER,BKREURNO
          CALL      GETPAT00 
          CALL      PATLN000 
          MOVE      ABED,BED
.
          IF        BKRESTAT=4
            PACK      ADMISSNO,BKREBOOK
            CALL      RDDSCH1        
            BRANCH    OVRCD,BROWB200
            UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      EXPCTDSC,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
. 
BROWB200  IF        BKRESTAT=2
            MOVE      "&nbsp;",EXPCTDSC         
          ENDIF           
. 
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
.
          UNPACK    BKREEDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      BOOKNDAT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          PACK      KEY6,BKREADOC
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE          * I CAR 13038
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000                * end I CAR 13038            
          ENDIF
.
          PACK      KEY18,BKREBOOK,SP70      * Read the diagnosis file
          CALL      RSBKDIA1
          CALL      RKBKDIA1
          IF        OVRCD=1
            MOVE      SP70,BKDIDES1
            MOVE      SP70,BKDIDES2
          ELSE
            MATCH     BKREBOOK,BKDIBOOK
            IF        !@EQUAL
              MOVE      SP70,BKDIDES1
              MOVE      SP70,BKDIDES2
            ENDIF
          ENDIF
.
          CALL      DOSA0000                * Determine DOSA Status
.
          CLEAR     PATLINK
          APPEND    "javascript:patientLink('",PATLINK
          APPEND    URNUMBER,PATLINK
          APPEND    "','",PATLINK
          APPEND    ADMISSNO,PATLINK
          APPEND    "','",PATLINK
          APPEND    BKRESTAT,PATLINK
          APPEND    "')",PATLINK
          RESET     PATLINK
.
          REP       "+ ",URNUMBER
          WRITE     HTMLFILE;"t.addRow(#"",FORMATNM,"#",":
                             "#"",PSEX,"#",":
                             "#"";
          CALL      WRTAGE00
          REP       "#" ",BKDIDES1
          REP       "#" ",BKDIDES2
          WRITE     HTMLFILE;"#",":
                             "#"",BKDIDES1,BKDIDES2,"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",BOOKSTAT,"#",":
                             "#"",BKREEDAT,BKREATIM,"#",":
                             "#"",BKREEBED,"#",":
                             "#"",DOSASTAT,"#",":
                             "#"",URNUMBER,"#",":
                             "#"",PATLINK,"#");"
.
BROWB900  REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
BROWB999 RETURN
.------------------------------------------------------------
. Determine DOSA Status
.------------------------------------------------------------
DOSA0000  MATCH     CANCEL,BOOKSTAT
          GOTO      DOSA9000 IF EQUAL
.
          COMPARE   ONE,TFLAG               * No theatre record
          GOTO      DOSA9000 IF EQUAL
.
          MATCH     "Y  ",OPDAUSR2
          GOTO      DOSA9000 IF NOT EQUAL
.
          MOVE      OPDAUSR2,DOSASTAT     * only show DOSA for non cancelled
          GOTO      DOSA9999
.
DOSA9000  MOVE      SP70,DOSASTAT
.
DOSA9999  RETURN
.------------------------------------------------------------
. Displays Current Patient ward/bed details
.------------------------------------------------------------
CTABC000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,DLINKPRG,DIM127
          UNPACK    DIM127,D1,DLINKREP,DIM127
          UNPACK    DIM127,D1,DLINKTEM,DIM127
          MOVE      ZERO,NUMOFPAT                * Number of patients in ward
.
          CALL      CHEDC000      * Output Table Heading
.
          CALL      IBACLOCK            * Calculate expected discharge date
          PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
          BRANCH    WINPUT,CTABC500
.
          PACK      KEY16,WARDCODE,SP70
          CALL      RDSWARD8
CTABC100  CALL      RDKWARD8
          BRANCH    OVRCD,CTABC700
.
          MATCH     WARDCODE,WWARD
          GOTO      CTABC700 IF NOT EQUAL
.
          MATCH     SP70,WBED
          GOTO      CTABC100 IF EQUAL
.
          BRANCH    WACTIVE,CTABC100     *Do not display inactive bed
.
          CALL      CROWC000
          GOTO      CTABC100
.
. No Bed Ward
.------------------------------------------------------------
CTABC500  PACK      KEY13,WARDCODE,SP20
          CALL      RDSNOBE1
CTABC600  CALL      RDKNOBE1                * read next record
          BRANCH    OVRCD,CTABC700
          MATCH     WARDCODE,NBWARD         * same ward?
          GOTO      CTABC700 IF NOT EQUAL
.
          PACK      ADMISSNO,NBADMNO
          MOVE      NBROOM,WBED
          MOVE      ZERO,STBYFLAG
          CALL      CBEDC000         * Output Row Details
          ADD       ONE,NUMOFPAT
          GOTO      CTABC600
.
. On Leave Patients
.------------------------------------------------------------
CTABC700  MOVE      ONE,FIRSTONL
          PACK      KEY14,WARDCODE,SP70
          CALL      RDSONLV1
CTABC800  CALL      RDKONLV1
          BRANCH    OVRCD,CTABC950
          MATCH     OWARD,WARDCODE
          GOTO      CTABC950 IF NOT EQUAL
          MATCH     ZEROVISN,OADMNO
          GOTO      CTABC800 IF EQUAL
          IF        FIRSTONL=1
            MOVE      ZERO,FIRSTONL
            MOVE      "Patients On Leave",ROWHEAD
            CALL      CRHDC000       * Output Heading Row for On-Leave
          ENDIF
          PACK      ADMISSNO,OADMNO
          MOVE      OBED,WBED
          MOVE      ZERO,STBYFLAG
          CALL      CBEDC000         * Output Row Details
          GOTO      CTABC800
CTABC950  CALL      CENDC000
CTABC999  RETURN
.------------------------------------------------------------
. Current Admission Table Heading
.------------------------------------------------------------
CHEDC000  PACK      KEY5,CODECO,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,KEY20
          ELSE
            MOVE      SP70,KEY20
          ENDIF
          WRITE     HTMLFILE;"<tr>":
                             "<td colspan=6 align=center class=HeadingCell>":
                             "Current Admission for ":
                              WBDESC,"</td></tr>":
                             "<tr align=center>":
                             "<td colspan=6 align=center class=HeadingCell>":
                             "Number of Patients : <input type=text readonly ":
                             "name=numofpat size=3 maxlength=3 value=",NUMOFPAT:
                             " class=TextCell></td></tr>":
                             "<tr><td class=HeadingCell>Bed</td>":
                                 "<td class=HeadingCell>Patient</td>":
                                 "<td class=HeadingCell>",KEY20,"</td>":
                                 "<td class=HeadingCell>Diet</td>":
                                 "<td class=HeadingCell>Att. Doct.</td>":
                                 "<td class=HeadingCell>Exp. Disch.</td></tr>"
                  RETURN
.------------------------------------------------------------
. End of Table
.------------------------------------------------------------
CENDC000  WRITE     HTMLFILE;"<tr><td colspan=6>":
                             "<table border=0 align=center":
                             " width=100%>":
                             "<tr align=center><td width=30%></td>":
                             "<td width=10% class=AvailableCell align=center>":
                             "Available Bed</td>":
                             "<td width=10% class=StandbyCell align=center>":
                             "Standby Patient":
                             "<td width=10% class=PastDischDate align=center>":
                             " Past Date </td>":
                             "<td width=10% class=CurrDischDate align=center>":
                             " Current Date </td>":
                             "</td><td width=30%></td></tr>":
                             "</table></td></tr>"
          RETURN
.------------------------------------------------------------
. Heading Row
.------------------------------------------------------------
CRHDC000  WRITE     HTMLFILE;"<tr><td colspan=6 align=center ":
                               "class=HeadingCell><b>",ROWHEAD,"</td></tr>"
          RETURN
.------------------------------------------------------------
. Current Admissions Empty Bed Row
.------------------------------------------------------------
CEMPC000  WRITE     HTMLFILE;"<tr height=35 align=top>":
                    "<td align=center class=AvailableCell>":
                    WBED,"</td>":
                    "<td align=center>*** Available ***</td>":
                    "<td>&nbsp;</td>":
                    "<td>&nbsp;</td>":
                    "<td>&nbsp;</td>":
                    "<td>&nbsp;</td>":
                    "</tr>";
          RETURN
.------------------------------------------------------------
. Current Admissions Patient Details
.------------------------------------------------------------
CBEDC000  CALL      GETPAT00 
          CALL      PATLN000
          CALL      PATFLD00                * Use standard Patient Folder sub
          MOVE      KEY3,FOLDERSF           * and store suffix
          MOVE      ADOCTA,DOCTCODE
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
          IF        STBYFLAG=0
            WRITE     HTMLFILE;"<tr height=35>":
                               "<td align=center>",WBED,"&nbsp;</td>"
          ELSE
            WRITE     HTMLFILE;"<tr height=35>":
                               "<td align=center class=StandbyCell>":
                               WBED,"&nbsp;</td>"
          ENDIF
          WRITE     HTMLFILE;"<td nowrap>":
                             "<img src=../images/PatientFolder",FOLDERSF,".gif":
                             " class=ListIcon ":
                             " onclick='location.href=#"",LINKPRG,".pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO,"#";'>":
                             FORMATNM,"</td>";
.          CALL      WRTAGE00
.          WRITE     HTMLFILE;")</td>";
.
          CALL      GETCON00 * Get Patient Condition Details
          MOVE      "DC",CATEGORY
          MOVE      ADIET,CODE
          CALL      GETCOD00
.
          MATCH     SP70,CONDESC
          IF        !@EQUAL
            UNPACK    LPCDATE,CCENT,CYEAR,CMON,CDAY
            PACK      DISPDATE,LBRACKT,CDAY,SLASH,CMON,SP1,LPCTIME,RBRACKT 
          ELSE
            CLEAR     DISPDATE
          ENDIF
.
          WRITE     HTMLFILE;"<td>":
                             "<img src=../images/",IMGSRC," class=ListIcon ":
                             " onclick='UpdateCondition(#"":
                             URNUMBER,"#",#"",ADMISSNO,"#");'>":
                             CONDESC,DISPDATE,SP1:
                             LPCONDD,"</TD>":
                             "<td><img src=../images/DietIcon.gif ":
                             " class=ListIcon ":
                             " onclick='UpdateDiet(#"":
                             URNUMBER,"#",#"",ADMISSNO,"#")'>":
                             TDESC,"</td>";
.
          WRITE     HTMLFILE;"<td nowrap><a href='":
                             "javascript:DoctorViewFrame(#"",DOCTCODE,"#")'>":
                             SDOCFNAM,"</a></td>":
                             "<td nowrap align=center class=",COLRFLAG,">":
                             EXPCTDSC,"</td>":
                             "</tr>"
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
          RETURN
.------------------------------------------------------------
. Output Ward/Bed Row
.------------------------------------------------------------
CROWC000  MATCH     ZEROVISN,WADMNO
          GOTO      CROWC900 IF EQUAL
.
          PACK      ADMISSNO,WADMNO
          MOVE      ZERO,STBYFLAG
          CALL      CBEDC000         * Output Row Details
          ADD       ONE,NUMOFPAT     * count number of patients in ward
.
          MATCH     ZEROVISN,WSTBY
          GOTO      CROWC999 IF EQUAL
.
          PACK      ADMISSNO,WSTBY
          MOVE      ONE,STBYFLAG
          CALL      CBEDC000         * Output Row Details
          ADD       ONE,NUMOFPAT     * count number of patients in ward
.
          GOTO      CROWC999
.
CROWC900  CALL      CEMPC000         * Current Admissions Empty Bed Row
.
CROWC999  RETURN
.
.------------------------------------------------------------
. Displays Current Patient ward/bed details
.------------------------------------------------------------
CTABD000  MOVE      SP70,EXDIFLAG                * I CAR 38459
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,DLINKPRG,DIM127
          UNPACK    DIM127,D1,DLINKREP,DIM127
          UNPACK    DIM127,D1,DLINKTEM,DIM127
          UNPACK    DIM127,D1,EXDIFLAG,DIM127    * I CAR 38459
          UNPACK    DIM127,D1,WORKFLAG,DIM127    * Display working diagnosis
          UNPACK    DIM127,D1,LEAVFLAG,DIM127    * On Leave Flag
          UNPACK    DIM127,D1,MHLSFLAG,DIM127    * MH Legal Status Flag
          UNPACK    DIM127,D1,STVVIEW,DIM127     * STV View
.
          MOVE      WORKFLAG,WORKDFLG            * Display working diagnosis
          MOVE      LEAVFLAG,ONLVFLAG            * Display type of onleave
          MOVE      MHLSFLAG,MEHLSFLG            * Display MH Legal Status
.
          MOVE      ZERO,NUMOFPAT                * Number of patients in ward
.
          PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
          MOVE      WINPUT,NOBEDWRD
          MOVE      WCLASS,SAVCLASS
          IF        NOBEDWRD=1
            IF PTCNHDPS = ONE
              MOVE      "5",TCOLSPAN
            ELSE
              MOVE      "6",TCOLSPAN
            ENDIF
          ELSE
            MATCH     "1",EXDIFLAG               * I CAR 38459
            IF        @EQUAL
              IF PTCNHDPS = ONE
                MOVE      "5",TCOLSPAN
              ELSE
                MOVE      "6",TCOLSPAN
              ENDIF
            ELSE
              IF PTCNHDPS = ONE
                MOVE      "6",TCOLSPAN
              ELSE
                MOVE      "7",TCOLSPAN             * end I CAR 38459
              ENDIF
            ENDIF
          ENDIF
.
          CALL      CHEDD000      * Output Table Heading
.
          MOVE      "1",FILETYPE
          BRANCH    NOBEDWRD,CTABD500,CTABD500
.
          PACK      KEY16,WARDCODE,SP70
          CALL      RDSWARD8
CTABD100  CALL      RDKWARD8
          BRANCH    OVRCD,CTABD700
.
          MATCH     WARDCODE,WWARD
          GOTO      CTABD700 IF NOT EQUAL
.
          MATCH     SP70,WBED
          GOTO      CTABD100 IF EQUAL
.
          BRANCH    WACTIVE,CTABD100     *Do not display inactive bed
.
          MOVE      PTWDBDST,CLOSEFLG    * Set Bed Closed flag (1 = Closed)
          CALL      CROWD000
          GOTO      CTABD100
.
. No Bed Ward
.------------------------------------------------------------
CTABD500  MOVE      ZERO,CLOSEFLG
          MOVE      "2",FILETYPE
          PACK      KEY13,WARDCODE,SP20
          CALL      RDSNOBE1
CTABD600  CALL      RDKNOBE1                * read next record
          BRANCH    OVRCD,CTABD650
          MATCH     WARDCODE,NBWARD         * same ward?
          GOTO      CTABD650 IF NOT EQUAL
.
          PACK      ADMISSNO,NBADMNO
          MOVE      NBROOM,WBED
          MOVE      ZERO,STBYFLAG
          CALL      CBEDD000                * Output Row Details
          ADD       ONE,NUMOFPAT
          GOTO      CTABD600
.
CTABD650  COMPARE   TWO,NOBEDWRD
          IF        @EQUAL
            PACK      KEY16,WARDCODE,SP70   * Display beds if this is a ward/bed
            CALL      RDSWARD8              * and ward only ward
            GOTO      CTABD100
          ENDIF
.
. On Leave Patients
.------------------------------------------------------------
CTABD700  MOVE      ONE,FIRSTONL
          MOVE      "3",FILETYPE
          PACK      KEY14,WARDCODE,SP70
          CALL      RDSONLV1
CTABD800  CALL      RDKONLV1
          BRANCH    OVRCD,CTABD950
          MATCH     OWARD,WARDCODE
          GOTO      CTABD950 IF NOT EQUAL
          MATCH     ZEROVISN,OADMNO
          GOTO      CTABD800 IF EQUAL
          IF        FIRSTONL=1
            MOVE      ZERO,FIRSTONL
            MOVE      "Patients On Leave",ROWHEAD
            CALL      CRHDD000       * Output Heading Row for On-Leave
          ENDIF
          PACK      ADMISSNO,OADMNO
          MOVE      OBED,WBED
          MOVE      ZERO,STBYFLAG
.
          MOVE      ZERO,CLOSEFLG                * Reset 'Closed Bed' flag
          PACK      KEY6,WARDCODE,WBED,SP70      * Read Ward/Bed file
          CALL      RDWARD1
          BRANCH    OVRCD,CTABD850
          MOVE      PTWDBDST,CLOSEFLG            * Set 'Closed Bed' flag
.
CTABD850  CALL      CBEDD000         * Output Row Details
          GOTO      CTABD800
CTABD950  CALL      CENDD000
CTABD999  RETURN
.------------------------------------------------------------
. Current Admission Table Heading
.------------------------------------------------------------
CHEDD000  PACK      KEY5,CODECO,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,KEY20
          ELSE
            MOVE      SP70,KEY20
          ENDIF
.
          WRITE     HTMLFILE;"<table width=100% style=#"table-layout:fixed#"":
                             " cellpadding=1 cellspacing=0 border=1><tr>"
          IF        NOBEDWRD<>1
            WRITE     HTMLFILE;"<td class=HeadingCell width=5%>Bed</td>";
          ENDIF
          MATCH     "1",EXDIFLAG                   * I CAR 38459
          IF        @EQUAL
            WRITE     HTMLFILE;"<td class=HeadingCell width=28%>Patient</td>":
                               "<td class=HeadingCell width=20%>",KEY20,"</td>":
                               "<td class=HeadingCell width=10%>Diet</td>";
.                                                                   * Car 235588
            IF        PTCNHDPS=ONE
              WRITE     HTMLFILE;"<td class=HeadingCell width=10%>Health ":
                                 "Speciality</td>";
            ENDIF
.
            WRITE     HTMLFILE;"<td class=HeadingCell width=15%>Att. Doct.</td>":
                               "<td class=HeadingCell width=8%>Prov. DRG</td>":
                               "</tr>"               * end I CAR 38459
          ELSE
            WRITE     HTMLFILE;"<td class=HeadingCell width=28%>Patient</td>":
                               "<td class=HeadingCell width=20%>",KEY20,"</td>":
                               "<td class=HeadingCell width=7%>Diet</td>";
.                                                                   * Car 235588
            IF        PTCNHDPS=ONE
              WRITE     HTMLFILE;"<td class=HeadingCell width=9%>Health ":
                                 "Speciality</td>";
            ENDIF
            WRITE     HTMLFILE;"<td class=HeadingCell width=14%>Att. Doct.</td>":
                               "<td class=HeadingCell width=8%>Prov. DRG</td>":
                               "<td class=HeadingCell width=9%>Exp. Disch</td>":
                               "</tr>"
          ENDIF
          RETURN
.------------------------------------------------------------
. End of Table
.------------------------------------------------------------
CENDD000  BRANCH    NOBEDWRD,CENDD900
          WRITE     HTMLFILE;"</table>":
                             "<table border=0 align=center width=100%>":
                             "<tr align=center height=35><td width=35%></td>":
                             "<td class=AvailableCell align=center width=10%>":
                             "Available Bed</td>":
                             "<td class=ClosedCell bgcolor=gray align=center ":
                             "width=10%>Closed Bed</td>":
                             "<td width=10% align=center class=StandbyCell>":
                             "Standby Patient":
                             "</td><td width=35%></td></tr>"
CENDD900  WRITE     HTMLFILE;"</table>"
CENDD999  RETURN
.------------------------------------------------------------
. Heading Row
.------------------------------------------------------------
CRHDD000  WRITE     HTMLFILE;"<tr><td colspan=",TCOLSPAN," align=center ":
                               "class=HeadingCell><b>",ROWHEAD,"</td></tr>"
          RETURN
.------------------------------------------------------------
. Current Admissions Empty Bed Row
.------------------------------------------------------------
CEMPD000  WRITE     HTMLFILE;"<tr align=top height=35>";
          IF        NOBEDWRD<>1
            CALL      FBED0000
            WRITE     HTMLFILE;"<td align=center class=AvailableCell>":
                               *+,BEDTEXT,"</td>";
          ENDIF
          MATCH     "1",EXDIFLAG                  
          IF        @EQUAL
            WRITE     HTMLFILE;"<td align=center>":
                               "*** Empty ***</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>";
.
            COMPARE   "1",PTCNHDPS
            IF        @EQUAL
              WRITE     HTMLFILE;"<td>&nbsp;</td>";
            ENDIF
.
            WRITE     HTMLFILE;"</tr>";
.
          ELSE
            WRITE     HTMLFILE;"<td align=center>":
                               "*** Empty ***</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>";
.
            COMPARE   "1",PTCNHDPS
            IF        @EQUAL
              WRITE     HTMLFILE;"<td>&nbsp;</td>";
            ENDIF
.
            WRITE     HTMLFILE;"</tr>";
.   
          ENDIF
.
          RETURN
.------------------------------------------------------------
. Current Admissions Closed Bed Row
.------------------------------------------------------------
CCLSD000  WRITE     HTMLFILE;"<tr align=top height=35>";
          IF        NOBEDWRD<>1
            CALL      FBED0000
            WRITE     HTMLFILE;"<td align=center class=ClosedCell ":
                               "bgcolor=gray>",*+,BEDTEXT,"</td>";
          ENDIF
          MATCH     "1",EXDIFLAG                   * I CAR 38459
          IF        @EQUAL
            WRITE     HTMLFILE;"<td align=center>":
                               "*** Closed ***</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>";
.
            COMPARE   "1",PTCNHDPS
            IF        @EQUAL
              WRITE     HTMLFILE;"<td>&nbsp;</td>";
            ENDIF
.
            WRITE     HTMLFILE;"</tr>";
.
          ELSE
            WRITE     HTMLFILE;"<td align=center>":
                               "*** Closed ***</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>";
            COMPARE   "1",PTCNHDPS
            IF        @EQUAL
              WRITE     HTMLFILE;"<td>&nbsp;</td>";
            ENDIF
.
            WRITE     HTMLFILE;"</tr>";
.
          ENDIF
.
          RETURN
.------------------------------------------------------------
. Current Admissions Patient Details
.------------------------------------------------------------
CBEDD000  CALL      GETPAT00
          CALL      PATLN000
          CALL      PATFLD00                * Use standard Patient Folder sub
          MOVE      KEY3,FOLDERSF           * and store suffix
          MOVE      ADOCTA,DOCTCODE
          IF        NOBEDWRD<>1
            CALL      FBED0000
            IF        STBYFLAG=0
              MATCH     "1",CLOSEFLG        * Is this Bed Closed
              IF        @EQUAL
                WRITE     HTMLFILE;"<tr valign=top>":
                                   "<td align=center class=ClosedCell ":
                                   "bgcolor=gray>",*+,BEDTEXT,"&nbsp;</td>";
              ELSE
                WRITE     HTMLFILE;"<tr valign=top>":
                                  "<td align=center>",*+,BEDTEXT,"&nbsp;</td>";
              ENDIF
            ELSE
              WRITE     HTMLFILE;"<tr valign=top>":
                                "<td align=center class=StandbyCell>":
                                *+,BEDTEXT,"&nbsp;</td>";
            ENDIF
          ELSE
            WRITE     HTMLFILE;"<tr valign=top>"
          ENDIF
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
.
          WRITE     HTMLFILE;"<td nowrap>":
                             "<img src=../images/PatientFolder",FOLDERSF,".gif":
                             " class=ListIcon ":
                             " onclick='location.href=#"",LINKPRG,".pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO,"#";'>";
.
          COMPARE   ONE,ONLVFLAG
          GOTO      CBEDD020 IF NOT EQUAL
          COMPARE   THREE,FILETYPE
          GOTO      CBEDD020 IF NOT EQUAL
.
          MATCH     "1",PTCNHLEA             * Check Parameter Disp.On Leave
          GOTO      CBEDD020 IF NOT EQUAL
.
          MOVE      ADMISSNO,KEY8
          REP       "+ ",KEY8
          SQUEEZE   KEY8
          MOVE      KEY8,PVIBILL
          PROC      TLEA0000
.
          MOVE      "TL",CATEGORY            * Output Type of Leave
          CALL      GETCOD00
          MOVE      "On Leave - ",KEY11
          PACK      KEY31,KEY11,TDESC,SP70
          WRITE     HTMLFILE;FORMATNM,"<br>",KEY31;
          GOTO      CBEDD040
.
CBEDD020  WRITE     HTMLFILE;FORMATNM,"</td>";
.
CBEDD040  REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
          CALL      GETCON00      * Get Patient Condition Details
.
          WRITE     HTMLFILE;"<td>"

          MATCH     "1",STVVIEW
          IF        @EQUAL
            WRITE     HTMLFILE;"<table width=100% border=0":
                      " style='table-layout:fixed;'>":
                      "<tr><td style='overflow:hidden;text-overflow:ellipsis;":
                      "white-space:nowrap'>"
          ENDIF
.
          MATCH     "1",PTMXSIN1
          IF        @EQUAL
            WRITE     HTMLFILE;"<img src='../images/AlertIcon.gif'":
                               " alt='Alerts'":
                               " class=ListIcon onclick='PatientAlerts(#"":
                               URNUMBER,"#",#"",ADMISSNO,"#");'>"
            GOTO      CBEDD100
          ENDIF
          MATCH     "2",PTMXSIN1
          IF        @EQUAL
            WRITE     HTMLFILE;"<img src='../images/AlertIconBlack.gif'":
                               " alt='Alerts'":
                               " class=ListIcon onclick='PatientAlerts(#"":
                               URNUMBER,"#",#"",ADMISSNO,"#");'>"
            GOTO      CBEDD100
          ENDIF
.
          MATCH     "3",PTMXSIN1
          IF        @EQUAL
            WRITE     HTMLFILE;"<img src='../images/AlertIconDelete.gif'":
                               " alt='Alerts'":
                               " class=ListIcon onclick='PatientAlerts(#"":
                               URNUMBER,"#",#"",ADMISSNO,"#");'>"
            GOTO      CBEDD100
          ENDIF
.
          MATCH     SP70,PTMXSIN1
          IF        !@EQUAL
            WRITE     HTMLFILE;"<img src='../images/AlertIcon":
                               PTMXSIN1,".gif'":
                               " alt='Alerts'":
                               " class=ListIcon onclick='PatientAlerts(#"":
                               URNUMBER,"#",#"",ADMISSNO,"#");'>"
          ENDIF
.
.
CBEDD100  IF        MEHLSFLG=1
            CALL      CMHL0000              * Check for MH legal status icon
          ENDIF
.
          MATCH     SP70,CONDESC
          IF        !@EQUAL
            UNPACK    LPCDATE,CCENT,CYEAR,CMON,CDAY
            PACK      DISPDATE,LBRACKT,CDAY,SLASH,CMON,SP1,LPCTIME,RBRACKT
          ELSE
            CLEAR     DISPDATE
          ENDIF
.
          IF        WORKDFLG=1
            MATCH     SP70,PMVXUDF2
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src=../images/",IMGSRC:
                                 " class=ListIcon ":
                                 " onclick='UpdateCondition(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#");'>":
                                 CONDESC,DISPDATE,WORKDESC;
            ELSE
              WRITE     HTMLFILE;"<img src=../images/",IMGSRC:
                                 " class=ListIcon ":
                                 " onclick='UpdateCondition(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#");'>":
                                 CONDESC,DISPDATE,"<br><span class='pathis'>",PMVXUDF2,"</span>":
                                 WORKDESC;
            ENDIF
            GOTO      CBEDD200
          ENDIF
.
          MATCH     SP70,LPCONDD
          IF        @EQUAL
            MATCH     SP70,PMVXUDF2
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src=../images/",IMGSRC:
                                 " class=ListIcon ":
                                 " onclick='UpdateCondition(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#");'>":
                                 CONDESC,DISPDATE;                 * C CAR 48209
            ELSE
              WRITE     HTMLFILE;"<img src=../images/",IMGSRC:
                                 " class=ListIcon ":
                                 " onclick='UpdateCondition(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#");'>":
                                 CONDESC,DISPDATE,"<br><span class='pathis'>",PMVXUDF2,"</span>"; * C CAR 48209
            ENDIF
          ELSE
            MATCH     SP70,PMVXUDF2
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src=../images/",IMGSRC:
                                 " class=ListIcon ":
                                 " onclick='UpdateCondition(#"":
                                  URNUMBER,"#",#"",ADMISSNO,"#")'>":
                                  CONDESC,DISPDATE,"<br>":
                                  LPCONDD;                       * C CAR 48209
            ELSE
              WRITE     HTMLFILE;"<img src=../images/",IMGSRC:
                                 " class=ListIcon ":
                                 " onclick='UpdateCondition(#"":
                                  URNUMBER,"#",#"",ADMISSNO,"#")'>":
                                  CONDESC,DISPDATE,"<br>":
                                  LPCONDD,"<br><span class='pathis'>",PMVXUDF2,"</span>";       * C CAR 48209
            ENDIF
          ENDIF
.
CBEDD200  MATCH     "1",STVVIEW
          IF        @EQUAL
            CALL      GETRIC00         * Get Risk icons
          ENDIF
.
          IF PTCNHDPS = ONE
            MOVE      ANSR,DIM1                                  * I CAR 48209
            MATCH     "1",PMVXVALW
            IF        @EQUAL
              MOVE ANSV,DIM1
            ENDIF
            WRITE     HTMLFILE;"<br>[",DIM1,COMMA,NBSP;
.
            MOVE      ANSN,DIM1
            MATCH     "1",PMVXPALW
            IF        @EQUAL
              MOVE ANSP,DIM1
            ENDIF
            WRITE     HTMLFILE;DIM1,"]";
.
            MATCH     SP3,LPCONAM
            IF        !@EQUAL
              MOVE      "AM",CATEGORY
              MOVE      LPCONAM,CODE
              CALL      GETCOD00
              WRITE     HTMLFILE;NBSP,NBSP,TDESC;
            ENDIF
          ENDIF
.
CBEDD500  MATCH     SP3,PMWODPST
          IF        !@EQUAL
            MOVE      "vi",CATEGORY
            MOVE      PMWODPST,CODE
            CALL      GETCOD00
            WRITE     HTMLFILE;NBSP,TDESC;
          ENDIF
.
          MATCH     "1",STVVIEW
          IF        @EQUAL
            WRITE     HTMLFILE;"</td></tr></table>"
          ENDIF
          WRITE     HTMLFILE;"</td>";
.
          MOVE      "DC",CATEGORY
          MOVE      ADIET,CODE
          CALL      GETCOD00
.
          IF PTCNHDPS = ONE
              WRITE     HTMLFILE;"<td><img src=../images/DietIcon.gif ":
                                 " class=ListIcon ":
                                 " onclick='UpdateDiet(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#")'>":
                                 TDESC,"<br><span class='pathis'>",PMVXUDF4,"</span></td>"; * end I C 48209
          ELSE
            MATCH     SP70,ACOMM1
            IF        @EQUAL
              WRITE     HTMLFILE;"<td><img src=../images/DietIcon.gif ":
                                 " class=ListIcon ":
                                 " onclick='UpdateDiet(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#")'>":
                                 TDESC,"</td>"
            ELSE
              WRITE     HTMLFILE;"<td><img src=../images/DietIcon.gif ":
                                 " class=ListIcon ":
                                 " onclick='UpdateDiet(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#")'>":
                                 TDESC,"<br>":
                                 ACOMM1,"</td>"
            ENDIF
          ENDIF
.                                                                   * Car 235588
          IF        PTCNHDPS=ONE
            MOVE      "A ",CATEGORY
            MOVE      ATYPE,CODE
            CALL      GETCOD00
.
            MATCH     SP70,TDESC
            IF        @EQUAL
              WRITE     HTMLFILE;"<td>&nbsp;</td>";
            ELSE
              WRITE     HTMLFILE;"<td>",TDESC,"</td>";
            ENDIF
          ENDIF
.
          COMPARE   "999",ASTAY
          IF        @EQUAL
            PACK      EXPCTDSC,HYPHEN,SP70
            GOTO      CBEDD600
          ENDIF
.
          MATCH     SP70,PMWOEDAT                                      *I-23312
          IF        !@EQUAL
            UNPACK    PMWOEDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      EXPCTDSC,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP1,PMWOEDTM
            GOTO      CBEDD600
          ENDIF
.                                                                  *end I-23312
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      ASTAY,ADJDAYS
          CALL      ADJDAT00
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      EXPCTDSC,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR          *I-23312
.
CBEDD600  MATCH     "1",EXDIFLAG                   * I CAR 38459
          IF        @EQUAL
            WRITE     HTMLFILE;"<td nowrap><a href='":
                               "javascript:DoctorViewFrame(#"",DOCTCODE,"#")'>":
                               SDOCFNAM,"</a></td>":
                               "<td align=center>":
                               "<a href='javascript:DrgViewFrame(#"":
                               PTMIPDRG,"#")'>":
                               PTMIPDRG,"&nbsp;</a></td>":
                               "</tr>"             * end I CAR 38459
          ELSE
            WRITE     HTMLFILE;"<td nowrap><a href='":
                               "javascript:DoctorViewFrame(#"",DOCTCODE,"#")'>":
                               SDOCFNAM,"</a></td>":
                               "<td align=center>":
                               "<a href='javascript:DrgViewFrame(#"":
                               PTMIPDRG,"#")'>":
                               PTMIPDRG,"&nbsp;</a></td>":
                               "<td nowrap align=center>",EXPCTDSC:    *C-23312
                               "&nbsp;</td>":                          *C-23312
                               "</tr>"
          ENDIF
.
CBEDD999  RETURN
+
.------------------------------------------------------------
. Output Ward/Bed Row
.------------------------------------------------------------
CROWD000  MATCH     ZEROVISN,WADMNO
          GOTO      CROWD900 IF EQUAL
.
          PACK      ADMISSNO,WADMNO
          MOVE      ZERO,STBYFLAG
          CALL      CBEDD000         * Output Row Details
          ADD       ONE,NUMOFPAT     * count number of patients in ward
.
          MATCH     ZEROVISN,WSTBY
          GOTO      CROWD999 IF EQUAL
.
          PACK      ADMISSNO,WSTBY
          MOVE      ONE,STBYFLAG
          CALL      CBEDD000         * Output Row Details
          ADD       ONE,NUMOFPAT     * count number of patients in ward
.
          GOTO      CROWD999
.
CROWD900  MATCH     "1",PTWDBDST       * Is this Bed Closed?
          IF        @EQUAL
            CALL      CCLSD000         * Closed Bed Row
          ELSE
            CALL      CEMPD000         * Current Admissions Empty Bed Row
          ENDIF
.
CROWD999  RETURN
.------------------------------------------------------------
.         SDOCNM00  Short Doctor Name (Title Initial. Surname)
.------------------------------------------------------------
SDOCNM00  CLEAR     DISPNAME
          MOVE      SP70,SDOCFNAM
.          PACK      NAME35,DTITL,SP70
.          CALL      NAMSTR00
.          PACK      NAME35,DGNAME,SP70
.          SQUEEZE   NAME35
.          MOVE      NAME35,KEY1
.          APPEND    KEY1,DISPNAME
.          APPEND    ". ",DISPNAME
.          PACK      NAME35,DSNAME,SP70
.          CALL      NAMSTR00
.          RESET     DISPNAME
          MOVE      DTITL,FMTTITLE
          MOVE      DGNAME,FMTGNAME
          MOVE      DSNAME,FMTSNAME
          MOVE      DISPNAME,SDOCFNAM
          STRIP     SDOCFNAM
.
SDOCNM99  RETURN
.------------------------------------------------------------
. Displays Current Patient ward/bed details
.------------------------------------------------------------
CTABE000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,DLINKPRG,DIM127
          UNPACK    DIM127,D1,DLINKREP,DIM127
          UNPACK    DIM127,D1,DLINKTEM,DIM127
          MOVE      ZERO,NUMOFPAT                * Number of patients in ward
.
          PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
          MOVE      WINPUT,NOBEDWRD
.
          CALL      CHEDE000      * Output Table Heading
.
          BRANCH    NOBEDWRD,CTABE500
.
          PACK      KEY16,WARDCODE,SP70
          CALL      RDSWARD8
CTABE100  CALL      RDKWARD8
          BRANCH    OVRCD,CTABE700
.
          MATCH     WARDCODE,WWARD
          GOTO      CTABE700 IF NOT EQUAL
.
          MATCH     SP70,WBED
          GOTO      CTABE100 IF EQUAL
.
          BRANCH    WACTIVE,CTABE100     *Do not display inactive bed
.
          CALL      CROWE000
          GOTO      CTABE100
.
. No Bed Ward
.------------------------------------------------------------
CTABE500  PACK      KEY13,WARDCODE,SP20
          CALL      RDSNOBE1
CTABE600  CALL      RDKNOBE1                * read next record
          BRANCH    OVRCD,CTABE700
          MATCH     WARDCODE,NBWARD         * same ward?
          GOTO      CTABE700 IF NOT EQUAL
.
          PACK      ADMISSNO,NBADMNO
          MOVE      NBROOM,WBED
          MOVE      ZERO,STBYFLAG
          CALL      CBEDE000         * Output Row Details
          ADD       ONE,NUMOFPAT
          GOTO      CTABE600
.
CTABE700
CTABE999  RETURN
.------------------------------------------------------------
. Current Admission Table Heading
.------------------------------------------------------------
CHEDE000  WRITE     HTMLFILE;"<tr>":
                             "<td>Patient</td>":
                             "<td>Sex/Age</td>":
                             "<td>Att. Doct.</td>":
                             "</tr>"
          RETURN
.------------------------------------------------------------
. Current Admissions Patient Details
.------------------------------------------------------------
CBEDE000  CALL      GETPAT00 
          MOVE      ADOCTA,DOCTCODE
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
          CALL      PATNAA00
          STRIP     PATFNAME
          MOVELPTR  PATFNAME,LENGTH
          SFORMAT   VAR,LENGTH
          MOVE      PATFNAME,VAR   
          WRITE     HTMLFILE;"<tr>":
                             "<td nowrap><A HREF=",LINKPRG,".pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO,">":
                             VAR,"</a></td><td nowrap>",PSEX,",";
          SFORMAT   VAR,127
          CALL      WRTAGE00
          WRITE     HTMLFILE;"</td>";
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
          REP       " +",DOCTCODE
          STRIP     SDOCFNAM
          MOVELPTR  SDOCFNAM,LENGTH
          SFORMAT   VAR,LENGTH
          MOVE      SDOCFNAM,VAR   
          WRITE     HTMLFILE;"<td nowrap><A HREF=",DLINKPRG,".pbl":
                             "?reportno=",DLINKREP:
                             "&template=",DLINKTEM:
                             "&doctcode=",DOCTCODE,">":
                             VAR,"</a></td>":
                             "</tr>"
          SFORMAT   VAR,127
          REP       "+ ",DOCTCODE
          RETURN
.------------------------------------------------------------
. Output Ward/Bed Row
.------------------------------------------------------------
CROWE000  MATCH     ZEROVISN,WADMNO
          GOTO      CROWE999 IF EQUAL
.
          PACK      ADMISSNO,WADMNO
          MOVE      ZERO,STBYFLAG
          CALL      CBEDE000         * Output Row Details
          ADD       ONE,NUMOFPAT     * count number of patients in ward
.
          MATCH     ZEROVISN,WSTBY
          GOTO      CROWE999 IF EQUAL
.
          PACK      ADMISSNO,WSTBY
          MOVE      ONE,STBYFLAG
          CALL      CBEDE000         * Output Row Details
          ADD       ONE,NUMOFPAT     * count number of patients in ward
.
CROWE999  RETURN
.
.------------------------------------------------------------
. Displays Transfers in/out for a Ward using Index on Date/Time
.------------------------------------------------------------
TTABA000  OPEN      PATTRAN5,"pattranf"
.
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          CALL      IBACLOCK            * Current Date
.
          PACK      KEY31,FRSTDATE,SP70
          CALL      RSPTTRN5
TTABA100  CALL      RKPTTRN5                                            * read by date
          BRANCH    OVRCD,TTABA900
.
          MOVE      ZERO,TRANOUT
.
          MATCH     WARDCODE,TWARD
          IF        !@EQUAL
            MOVE      TADMN,SAVEADMN
            PACK      SAVKEY30,TWARD,TBED,TDATE,TTIME,DTADMN,SP70
            PACK      KEY30,TADMN,TDATE,TTIME,TWARD,TBED,SP70
            CALL      RDSTRAN2
            CALL      RDPTRAN2                                          * read previous record to see if it's a transfer from
            BRANCH    OVRCD,TTABA100
.
            MATCH     SAVEADMN,TADMN
            GOTO      TTABA100 IF NOT EQUAL
.
            MATCH     TWARD,WARDCODE                                    * the previous ward matches the current ward
            IF        @EQUAL
              MOVE      SAVKEY30,KEY30                                   * re-read the transfer record
              CALL      RDTRAN1
              MOVE      ONE,TRANOUT                                     * is a transfer out
              GOTO      TTABA200                                        * continue to output
            ENDIF
.
            GOTO      TTABA100                                          * not related to this ward, get the next record
          ENDIF
.
TTABA200  MATCH     TDATE,LASTDATE
          GOTO      TTABA900 IF LESS
.
          CALL      TROWA000
          GOTO      TTABA100
.
TTABA900
TTABA999  RETURN
.
.------------------------------------------------------------
. Movement Patient Details
.------------------------------------------------------------
TROWA000  PACK      ADMISSNO,TADMN
          PACK      URNUMBER,TURNO
          CALL      GETPAT00 
          CALL      PATLN000
.
          MOVE      TADOCT,DOCTCODE
          MOVE      SP70,DOCFNAME
          PACK      KEY6,TADOCT
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE            * I CAR 13038
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000                  * end I CAR 13038
            CALL      SDOCNM00
          ENDIF
.
          REP       " +",DOCTCODE
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
.
          CLEAR     PATLINK
          APPEND    LINKPRG,PATLINK
          APPEND    ".pbl?reportno=",PATLINK
          APPEND    LINKREP,PATLINK
          APPEND    "&template=",PATLINK
          APPEND    LINKTEM,PATLINK
          APPEND    "&urnumber=",PATLINK
          APPEND    URNUMBER,PATLINK
          APPEND    "&admissno=",PATLINK
          APPEND    ADMISSNO,PATLINK
          RESET     PATLINK
.
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
          REP       "+ ",DOCTCODE
.
          CALL      GETMOV00
          BRANCH    EXIT,TROWA999
.
          MOVE      SP70,TDESC
          MATCH     SP70,TATYPE
          IF        !@EQUAL
            PACK      KEY5,CODEA,TATYPE
            CALL      RDCODE1
          ENDIF
.
          REP       "#" ",ADIAG1
          REP       "#" ",ADIAG2
          WRITE     HTMLFILE;"t.addRow(#"",FORMATNM,"#",":
                             "#"",TDATE,TTIME,"#",":
                             "#"",MOVEDESC,"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",PATLINK,"#",":
                             "#"",TDESC,"#",":
                             "#"",URNUMBER,"#",":
                             "#"",ADMISSNO,"#",":
                             "#"",ADIAG1,SP1,ADIAG2,"#");"
.
TROWA999  RETURN
.------------------------------------------------------------
. Get Movement Type Description
.------------------------------------------------------------
GETMOV00  MOVE      TMOVE,ANS
          MOVE      ZERO,EXIT
          REP       "A1D2C3L4R5",ANS
          MOVE      SP70,MOVEDESC
          MOVE      ZERO,MOVETYPE
          MOVE      ANS,MOVETYPE
          LOAD      MOVEDESC,MOVETYPE,MOVEADM,MOVEDSC,MOVETIN,MOVELVO,MOVELVI
          COMPARE   "2",MOVETYPE
          GOTO      GETMOV60 IF EQUAL
          COMPARE   "3",MOVETYPE
          GOTO      GETMOV99 IF NOT EQUAL
          COMPARE   "1",TRANOUT
          GOTO      GETMOV50 IF EQUAL
.
          PACK      SAVKEY30,TADMN,TDATE,TTIME,TWARD,TBED,SP70
          PACK      KEY30,TADMN,TDATE,TTIME,TWARD,TBED,SP70
          MOVE      TADMN,SAVEADMN
          MOVE      TWARD,SAVEWARD
          MOVE      TBED,SAVEBED
          MOVE      TADOCT,SAVEDOCT
          MOVE      TATYPE,SAVETYPE
          CALL      RDTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,GETMOV40
          MATCH     TADMN,SAVEADMN
          GOTO      GETMOV40 IF NOT EQUAL
.
          MATCH     TWARD,SAVEWARD
          GOTO      GETMOV30 IF NOT EQUAL
          MATCH     TBED,SAVEBED
          GOTO      GETMOV35 IF NOT EQUAL
          MATCH     TADOCT,SAVEDOCT
          GOTO      GETMOV20 IF NOT EQUAL
          MATCH     TATYPE,SAVETYPE
          GOTO      GETMOV90 IF EQUAL
.
GETMOV20  MOVE      MOVESPC,MOVEDESC
          MOVE      SAVKEY30,KEY30
          CALL      RDTRAN2
          GOTO      GETMOV99 
.
. Moved from Another Ward
.
GETMOV30  CLEAR     MOVEDESC
          PACK      KEY6,TWARD,TBED
          CALL      FWBD0000
          APPEND    MOVETIN,MOVEDESC
          APPEND    " (",MOVEDESC
.         APPEND    TWARD,MOVEDESC
.         MATCH     SP70,TBED
.         IF        !@EQUAL
.           APPEND    "/",MOVEDESC
.           APPEND    TBED,MOVEDESC
.         ENDIF
          STRIP     WBEDTEXT
          APPEND    WBEDTEXT,MOVEDESC
          APPEND    ")",MOVEDESC
          RESET     MOVEDESC
          MOVE      SAVKEY30,KEY30
          CALL      RDTRAN2
          GOTO      GETMOV99 
.
. Move Bed Only
.
GETMOV35  CLEAR     MOVEDESC
          PACK      KEY6,TWARD,TBED
          CALL      FWBD0000
          APPEND    MOVEBED,MOVEDESC
          APPEND    " (",MOVEDESC
.          APPEND    TBED,MOVEDESC
          STRIP     BEDTEXT
          APPEND    BEDTEXT,MOVEDESC
          APPEND    ")",MOVEDESC
          RESET     MOVEDESC
          MOVE      SAVKEY30,KEY30
          CALL      RDTRAN2
          GOTO      GETMOV99 
.
. Problem can't find previous Transfer Record
.
GETMOV40  CLEAR     MOVEDESC
          APPEND    MOVETIN,MOVEDESC
          APPEND    " (Transfer Error)",MOVEDESC
          RESET     MOVEDESC
          GOTO      GETMOV99 
.   
. Transfer Out to Another Ward/Bed
.
GETMOV50  CLEAR     MOVEDESC
          PACK      KEY6,TWARD,TBED
          CALL      FWBD0000
          APPEND    MOVETOT,MOVEDESC
          APPEND    " (",MOVEDESC
.          APPEND    TWARD,MOVEDESC
.          MATCH     SP70,TBED
.          IF        !@EQUAL
.            APPEND    "/",MOVEDESC
.            APPEND    TBED,MOVEDESC
.          ENDIF
          STRIP     WBEDTEXT
          APPEND    WBEDTEXT,MOVEDESC
          APPEND    ")",MOVEDESC
          RESET     MOVEDESC
          GOTO      GETMOV99 
.   
. Discharge
.
GETMOV60  MOVE      ADMISSNO,KEY8
          CALL      RDDSCH1
          BRANCH    OVRCD,GETMOV99
.                                                                     *C-140164
          IF        PTCNDRSM=1
            PACK      KEY3,DSTAT
            PACK      KEY5,CATD,DSTAT,SP5
          ELSE
            PACK      KEY3,DDEST
            PACK      KEY5,CATDD,DDEST,SP5
          ENDIF
.
          MATCH     SP3,KEY3
          GOTO      GETMOV99 IF EQUAL
          CALL      RDCODE1
          BRANCH    OVRCD,GETMOV99
.
          CLEAR     MOVEDESC
          APPEND    MOVEDSC,MOVEDESC
          APPEND    " (",MOVEDESC
          STRIP     TDESC
          MOVELPTR  TDESC,LENGTH
          SFORMAT   VAR,LENGTH
          MOVE      TDESC,VAR   
          APPEND    VAR,MOVEDESC
          SFORMAT   VAR,127
          APPEND    ")",MOVEDESC
          RESET     MOVEDESC
          GOTO      GETMOV99 
.
GETMOV90  MOVE      ONE,EXIT
GETMOV99  RETURN
.------------------------------------------------------------------------
. Format Patient Name with Second Name Initial
.------------------------------------------------------------------------
PATINT00  CLEAR     DISPNAME
          MOVE      PSNAME,SAVPSNAM
.
..        REP       "' ",PSNAME
          REP       "#" ",PSNAME
..        REP       "' ",PGNAME
          REP       "#" ",PGNAME
          MOVE      SP70,PATFNAME
          REP       UPPLOW,PSNAME
          APPEND    "<b>",DISPNAME
          APPEND    PSNAME,DISPNAME
          APPEND    "</b>",DISPNAME
          PACK      NAME35,PTITL,SP70
          CALL      NAMSTR00
.
          MOVELPTR  PGNAME,LENPTR
          MOVE      ONE,COUNT
PATINT10  BUMP      PGNAME
          GOTO      PATINT80 IF EOS
          ADD       ONE,COUNT
          MATCH     SP1,PGNAME
          GOTO      PATINT10 IF NOT EQUAL
          BUMP      PGNAME
          ADD       ONE,COUNT
PATINT80  RESET     PGNAME
          SETLPTR   PGNAME,COUNT
          PACK      NAME35,PGNAME,SP70
          CALL      NAMSTR00
          RESET     PGNAME,LENPTR
.
          APPEND    SP70,DISPNAME
          RESET     DISPNAME
          MOVE      DISPNAME,PATFNAME
          STRIP     PATFNAME
.
          MOVE      SAVPSNAM,PSNAME         * Original value with quotes etc
.
PATINT90  RESET     PGNAME
.
PATINT99  RETURN 
.
.------------------------------------------------------------
. Displays Chaplains Current Patient ward/bed details
.------------------------------------------------------------
CTABF000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,DLINKPRG,DIM127
          UNPACK    DIM127,D1,DLINKREP,DIM127
          UNPACK    DIM127,D1,DLINKTEM,DIM127
          MOVE      ZERO,NUMOFPAT                * Number of patients in ward
.
          CALL      IBACLOCK                     * Calc expected discharge date
          PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
          MOVE      WINPUT,NOBEDWRD              * Save Ward Hdr WO/BO status
.
          CALL      CHEADF00                     * Output headings         
.
. No Bed 
.
          PACK      KEY13,WARDCODE,SP20
          MOVE      "1",FILETYPE
          CALL      RDSNOBE1
CTABF100  CALL      RDKNOBE1                     * read next record
          BRANCH    OVRCD,CTABF190
          MATCH     WARDCODE,NBWARD              * same ward?
          GOTO      CTABF190 IF NOT EQUAL
          PACK      ADMISSNO,NBADMNO
          MOVE      NBROOM,WBED
          MOVE      ZERO,STBYFLAG
          CALL      CBEDF000         * Output Row Details
          GOTO      CTABF100
.
. Ward/Bed Details
.
CTABF190  PACK      KEY16,WARDCODE,SP70
          MOVE      "2",FILETYPE
          CALL      RDSWARD8
CTABF200  CALL      RDKWARD8
          BRANCH    OVRCD,CTABF290
.
          MATCH     WARDCODE,WWARD
          GOTO      CTABF290 IF NOT EQUAL
.
          MATCH     SP70,WBED
          GOTO      CTABF200 IF EQUAL
.
          IF        WBEDTYPE=3
            MATCH     ZEROVISN,WADMNO
            GOTO      CTABF220 IF NOT EQUAL
            PACK      KEY14,WWARD,WBED,SP70
            CALL      RDSONLV1
            CALL      RDKONLV1
            BRANCH    OVRCD,CTABF200
            MATCH     OWARD,WWARD
            GOTO      CTABF200 IF NOT EQUAL
            MATCH     OBED,WBED
            GOTO      CTABF200 IF NOT EQUAL
          ENDIF
           
CTABF220  BRANCH    WACTIVE,CTABF200     *Do not display inactive bed
          CALL      CROWF000
          GOTO      CTABF200
.
CTABF250  MOVE      "2",BEDMSGID      
          CALL      CBDMSF00
          GOTO      CTABF200
.
. On Leave Patients
.------------------
CTABF290  BRANCH    WBEDTYPE,CTABF300,CTABF9999
. 
CTABF300  MOVE      ONE,FIRSTONL
          MOVE      "3",FILETYPE
          PACK      KEY14,WARDCODE,SP70
          CALL      RDSONLV1
CTABF800  CALL      RDKONLV1
          BRANCH    OVRCD,CTABF999
          MATCH     OWARD,WARDCODE
          GOTO      CTABF999 IF NOT EQUAL
          MATCH     ZEROVISN,OADMNO
          GOTO      CTABF800 IF EQUAL
          IF        FIRSTONL=1
            MOVE      ZERO,FIRSTONL
            MOVE      "Patients On Leave",ROWHEAD
            CALL      CRHDF000             * Output Heading Row for On-Leave
          ENDIF
          PACK      ADMISSNO,OADMNO
          MOVE      OBED,WBED
          MOVE      ZERO,STBYFLAG
          CALL      CBEDF000               * Output Row Details
          GOTO      CTABF800
.
CTABF999  RETURN
.------------------------------------------------------------
. Current Admissions (Chaplain view) - Output Table heading row.
.------------------------------------------------------------
CHEADF00  WRITE     HTMLFILE;"<tr>";
          IF        NOBEDWRD<>1
            WRITE     HTMLFILE;"<td class=HeadingCell ":
                                   "align=center>Bed</td>";
          ENDIF
. 
          WRITE     HTMLFILE;"<td class=HeadingCell>Patient</td>";
.
          BRANCH    KIDSONLY,CHEADF50
.                                              * St. Vincents (standard)
          WRITE     HTMLFILE;"<td class=HeadingCell>Patient Condition</td>":
                             "<td class=HeadingCell>Religion</td>":
                             "<td class=HeadingCell>Baptised</td>";
          GOTO      CHEADF90
.                                              * Royal Childrens (kids) 
.
CHEADF50  WRITE     HTMLFILE;"<td class=HeadingCell align=center>U/R</td>":
                             "<td class=HeadingCell>Patient Condition<br>":
                                                   "Diagnosis</td>":
                             "<td class=HeadingCell>Religion</td>":
                             "<td class=HeadingCell>Baptised</td>";
.
CHEADF90  WRITE     HTMLFILE;"<td class=HeadingCell>Days</td>":
                             "<td class=HeadingCell>Adm.Date Time<br>":
                                                   "Exp.Discharge</td>":
                             "</tr>";
CHEADF99  RETURN             
.
.------------------------------------------------------------
. Output Ward/Bed Row
.------------------------------------------------------------
CROWF000  MATCH     ZEROVISN,WADMNO
          GOTO      CROWF800 IF EQUAL
.
. WBEDTYPE 0= All,1 = OPEN (INGNORE),2 = Empty 
.
          BRANCH    WBEDTYPE,CROWF100,CROWF999
.
CROWF100  PACK      ADMISSNO,WADMNO
          MOVE      ZERO,STBYFLAG
          CALL      CBEDF000                     * Output Row Details
          ADD       ONE,NUMOFPAT                 * count no. of patients in ward
.
          MATCH     ZEROVISN,WSTBY
          GOTO      CROWF999 IF EQUAL
.
          PACK      ADMISSNO,WSTBY
          MOVE      ONE,STBYFLAG
          CALL      CBEDF000                     * Output Row Details
          ADD       ONE,NUMOFPAT                 * count no. of patients in ward
.
          GOTO      CROWF999
.
CROWF800  MOVE      ONE,BEDMSGID                 * Assume Empty Bed
.
          PACK      KEY14,WWARD,WBED,SP70
          CALL      RDSONLV1
CROWF810  CALL      RDKONLV1                     * Try to find correct Ward/Bed
          BRANCH    OVRCD,CROWF850
          MATCH     OWARD,WWARD
          GOTO      CROWF850 IF NOT EQUAL
          MATCH     OBED,WBED
          GOTO      CROWF850 IF NOT EQUAL
          MOVE      ZERO,BEDMSGID                * Bed has patient on leave
.
CROWF850  CALL      CBDMSF00       
.
CROWF999  RETURN
.
.------------------------------------------------------------
. Current Admissions Patient Details
.------------------------------------------------------------
CBEDF000  CALL      GETPAT00 
          CALL      PATLN000
          CALL      PATFLD00                * Use standard Patient Folder sub
          MOVE      KEY3,FOLDERSF           * and store suffix
          MOVE      ADOCTA,DOCTCODE
          REP       " +",ADMISSNO
          REP       " +",URNUMBER 
.
CBEDF050  WRITE     HTMLFILE;"<tr height=35>"
.
          IF        NOBEDWRD=1
            GOTO      CBEDF090                * Bypass bed col for Wardonly Ward
          ENDIF
.
          BRANCH    FILETYPE,CBEDF060,CBEDF070,CBEDF080
.
CBEDF060  WRITE     HTMLFILE;"<td align=center class=UnallocatedCell>":
                             " &nbsp;</td>";
          GOTO      CBEDF090
.
CBEDF070  CALL      FBED0000
          IF        STBYFLAG=0
            WRITE     HTMLFILE;"<td align=center>";
          ELSE
            WRITE     HTMLFILE;"<td align=center class=StandbyCell>";
          ENDIF
          WRITE     HTMLFILE;*+,BEDTEXT,"&nbsp;</td>";
          GOTO      CBEDF090
.
CBEDF080  CALL      FBED0000
          WRITE     HTMLFILE;"<td align=center class=LeaveCell>";
          WRITE     HTMLFILE;*+,BEDTEXT,"&nbsp;</td>";
.
CBEDF090  WRITE     HTMLFILE;"<td nowrap>":
                             "<img src=../images/PatientFolder",FOLDERSF,".gif":
                             " class=ListIcon ":
                             " onclick='location.href=#"",LINKPRG,".pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO,"#";'>":
                             FORMATNM,"</td>";
.  
                                        * Don't use URno col for St.Vincents
          IF        KIDSONLY=ONE 
            REP       "+ ",URNUMBER
            WRITE     HTMLFILE;"<td nowrap align=center>":
                                URNUMBER,"</td>";
            REP       " +",URNUMBER
          ENDIF
.
CBEDF100  CALL      GETCON00               * Get Patient Condition Details
          MOVE      "DC",CATEGORY
          MOVE      ADIET,CODE
          CALL      GETCOD00
.
          MATCH     SP70,CONDESC
          IF        !@EQUAL
            UNPACK    LPCDATE,CCENT,CYEAR,CMON,CDAY
            PACK      DISPDATE,LBRACKT,CDAY,SLASH,CMON,SP1,LPCTIME,RBRACKT
          ELSE
            CLEAR     DISPDATE
          ENDIF
.
.                                            * St. Vincents (standard)
          WRITE     HTMLFILE;"<td nowrap>":
                               CONDESC,DISPDATE,"<br>",LPCONDD;
          IF        KIDSONLY=1
            WRITE     HTMLFILE;"<br />",ADIAG1;
          ENDIF
.
          MATCH     SP3,PMWODPST
          IF        !@EQUAL
            MOVE      "vi",CATEGORY
            MOVE      PMWODPST,CODE
            CALL      GETCOD00
            WRITE     HTMLFILE;NBSP,TDESC;
          ENDIF
.
          WRITE     HTMLFILE;"</td>";
. 
          MOVE      SP70,TDESC               * Get religion
          MOVE      "R ",CATEGORY
          MOVE      PREG,CODE
          CALL      GETCOD00
.
          MOVE      DNO,YESNO                * Set baptised status 
          IF        PUYN1 = 1
            MOVE      DYES,YESNO
          ENDIF
.
          WRITE     HTMLFILE;"<td nowrap>",TDESC,"&nbsp;</td>":      
                             "<td nowrap align=center>",YESNO,"</td>";
.
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          CALL      IBACLOCK
          PACK      CURRDATE,CC,YY,MM,DD
          REP       " 0",CURRDATE
          DAYSEP    ADATE,CURRDATE,ADMITDAY
.
          WRITE     HTMLFILE;"<td nowrap align=right>",ADMITDAY,"</td>";
.
          WRITE     HTMLFILE;"<td nowrap class=",COLRFLAG,">":
                                  DISPDATE,ATIME,"<br>":
                                  EXPCTDSC,"</td>":
                             "</tr>"
.
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
CBEDF999  RETURN
.------------------------------------------------------------
. Heading Row
.------------------------------------------------------------
CRHDF000  MOVE      SEVEN,CSPANUM           * RCH (kids)   
          BRANCH    KIDSONLY,CRHDF010       * Default View
          MOVE      SEVEN,CSPANUM           * RCH (kids)   
.
CRHDF010  IF        NOBEDWRD=1
            SUBTRACT  ONE,CSPANUM           * Remove 'bed' col for WardOnly Ward
          ENDIF
          MOVE      CSPANUM,CSPAN
          SQUEEZE   CSPAN
.
          WRITE     HTMLFILE;"<tr><td colspan=",CSPAN," align=center ":
                               "class=HeadingCell><b>",ROWHEAD,"</td></tr>"
.
CRHDF999  RETURN
.------------------------------------------------------------
. Current Admissions Bed Row message.
.------------------------------------------------------------
CBDMSF00  BRANCH    BEDMSGID,CBDMSF01,CBDMSF02
.
          MOVE      "LeaveCell",BDMSGCLS
          MOVE      "*** On Leave ***",BDMSGTXT
          GOTO      CBDMSF10
.
CBDMSF01  MOVE      "AvailableCell",BDMSGCLS
          MOVE      "*** Empty ***",BDMSGTXT
          GOTO      CBDMSF10
.
CBDMSF02  BRANCH    WBEDTYPE,CBDMSF99 
          MOVE      "ClosedCell bgcolor=gray",BDMSGCLS
          MOVE      "*** Closed ***",BDMSGTXT
.
CBDMSF10  CALL      FBED0000
          WRITE     HTMLFILE;"<tr height=35 align=top>":
                             "<td align=center class=",BDMSGCLS,">":
                             *+,BEDTEXT:
                             "</td><td align=center>",BDMSGTXT,"</td>";
.
.                                           **** Default View ****
          WRITE     HTMLFILE;"<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "</tr>";
CBDMSF99  RETURN
.
.------------------------------------------------------------
. Displays Current Patient ward/bed details
.------------------------------------------------------------
CTABG000  MOVE      ZERO,RECNUMB
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,DLINKPRG,DIM127
          UNPACK    DIM127,D1,DLINKREP,DIM127
          UNPACK    DIM127,D1,DLINKTEM,DIM127
          UNPACK    DIM127,D1,WORKFLAG,DIM127    * Working Diag.Flag 
          UNPACK    DIM127,D1,PRNTLABL,DIM127    * Print Labels Flag
          UNPACK    DIM127,D1,ANAESTFL,DIM127    * Anaesthetist Flag
          UNPACK    DIM127,D1,STVVIEW,DIM127     * Stv Flag         Car 262343
          UNPACK    DIM127,D1,LEAVFLAG,DIM127    * On Leave Flag
          UNPACK    DIM127,D1,MHLSFLAG,DIM127    * MH Legal Status Flag
          UNPACK    DIM127,D1,SKIPDIET,DIM127    * Skip DIet Text
.
          RESET     STVVIEW
          MATCH     STVVIEW,SP70
          IF        @EQUAL
            MOVE      ZERO,STVVIEW
          ENDIF
.
          MOVE      WORKFLAG,WORKDFLG            * Display working diagnosis
          MOVE      LEAVFLAG,ONLVFLAG            * Display type of onleave
          MOVE      MHLSFLAG,MEHLSFLG            * Display MH Legal Status
.
          MOVE      ZERO,NUMOFPAT                * Number of patients in ward
.
          CALL      IBACLOCK                     * Calc expected discharge date
          PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
          MOVE      WCLASS,SAVCLASS
.
          IF        EMRGVIEW=1
            MOVE      ZERO,EMVIFLAG              * redirect supervisor clinical
            PACK      KEY5,ANSB,ANST,WEFRBT,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MATCH     "S",THCSCOD              * EOU Unit
              IF        @EQUAL
                MATCH     ANSO,TCINDC8           * Display EOU on map
                IF        @EQUAL
                  MOVE      ONE,EMVIFLAG         * redirect supervisor clinical
                ENDIF
              ENDIF
            ENDIF
            CALL      WARDET00                   * Calculate  ward statistics
          ENDIF
.
          MOVE      WINPUT,NOBEDWRD              * Save Ward Hdr WO/BO status
.
          CALL      CHEADG00                     * Output headings         
.
. No Bed 
.
          MOVE      ZERO,CLOSEFLG
          PACK      KEY13,WARDCODE,SP20
          MOVE      "1",FILETYPE
          CALL      RDSNOBE1
CTABG100  CALL      RDKNOBE1                * read next record
          BRANCH    OVRCD,CTABG190
          MATCH     WARDCODE,NBWARD         * same ward?
          GOTO      CTABG190 IF NOT EQUAL
          PACK      ADMISSNO,NBADMNO
          MOVE      NBROOM,WBED
          MOVE      ZERO,STBYFLAG
          CALL      CBEDG000         * Output Row Details
          GOTO      CTABG100
.
. Ward/Bed Details
.
CTABG190  PACK      KEY16,WARDCODE,SP70
          MOVE      "2",FILETYPE
          CALL      RDSWARD8
CTABG200  CALL      RDKWARD8
          BRANCH    OVRCD,CTABG290
.
          MATCH     WARDCODE,WWARD
          GOTO      CTABG290 IF NOT EQUAL
.
          MATCH     SP70,WBED
          GOTO      CTABG200 IF EQUAL
.
          IF        WBEDTYPE=3
            MATCH     ZEROVISN,WADMNO
            GOTO      CTABG220 IF NOT EQUAL
            PACK      KEY14,WWARD,WBED,SP70
            CALL      RDSONLV1
            CALL      RDKONLV1
            BRANCH    OVRCD,CTABG200
            MATCH     OWARD,WWARD
            GOTO      CTABG200 IF NOT EQUAL
            MATCH     OBED,WBED
            GOTO      CTABG200 IF NOT EQUAL
          ENDIF
CTABG220  BRANCH    WACTIVE,CTABG200       * Do not display Inactive Beds
          CALL      CROWG000
          GOTO      CTABG200
.
. On Leave Patients
.------------------
CTABG290  BRANCH    WBEDTYPE,CTABG300,CTABG999
. 
CTABG300  MOVE      ONE,FIRSTONL
          MOVE      "3",FILETYPE
          PACK      KEY14,WARDCODE,SP70
          CALL      RDSONLV1
CTABG800  CALL      RDKONLV1
          BRANCH    OVRCD,CTABG999
          MATCH     OWARD,WARDCODE
          GOTO      CTABG999 IF NOT EQUAL
          MATCH     ZEROVISN,OADMNO
          GOTO      CTABG800 IF EQUAL
          IF        FIRSTONL=1
            MOVE      ZERO,FIRSTONL
            MOVE      "Patients On Leave",ROWHEAD
            CALL      CRHDG000       * Output Heading Row for On-Leave
          ENDIF
          PACK      ADMISSNO,OADMNO
          MOVE      OBED,WBED
          MOVE      ZERO,STBYFLAG
.
          MOVE      ZERO,CLOSEFLG                * Reset 'Closed Bed' flag
          PACK      KEY6,WARDCODE,WBED,SP70      * Read Ward/Bed file
          CALL      RDWARD1
          BRANCH    OVRCD,CTABG850
          MOVE      PTWDBDST,CLOSEFLG            * Set 'Closed Bed' flag
.
CTABG850  CALL      CBEDG000         * Output Row Details
          GOTO      CTABG800
.
CTABG999  RETURN
.
.------------------------------------------------------------
. Current Admissions - Output Table heading row.
.------------------------------------------------------------
CHEADG00  BRANCH    FHIRTYPE,CHEADG99
          IF        NOBEDWRD<>1
            WRITE     HTMLFILE;"<td class=HeadingCell ":
                                   "align=center>Bed</td>";
          ENDIF
. 
          WRITE     HTMLFILE;"<td class=HeadingCell>Patient</td>";
.
          IF        KIDSONLY=ONE
            WRITE     HTMLFILE;"<td class=HeadingCell align=center>U/R</td>";
          ENDIF
.
          IF        KIDSVEW2 = 1
            WRITE     HTMLFILE;"<td class=HeadingCell>Diagnosis</td>":
                               "<td class=HeadingCell>Procedure</td>":
                               "<td class=HeadingCell>Unit<br> Doctor</td>":
                               "<td class=HeadingCell>Ins <br> Class</td>":
                               "<td class=HeadingCell>Adm.Date Time<br>":
                                                     "Exp.Discharge":
                                                     "Exp.Return From Leave":
                                                     "</td>";
            COMPARE   "1",BULKDSCH
            IF        @EQUAL
              WRITE     HTMLFILE;"<td class=HeadingCell>Discharge<br>";
            ENDIF
            MATCH     "1",PRNTLABL
            IF        @EQUAL
              WRITE     HTMLFILE;"<td class=HeadingCell>Print Label<br>";
            ENDIF
            WRITE     HTMLFILE;"</tr>";
          ELSE
            IF        ALTVIEW1 = 1
              WRITE     HTMLFILE;"<td class=HeadingCell>Diagnosis</td>":
                                 "<td class=HeadingCell>Unit<br> Doctor</td>":
                                 "<td class=HeadingCell>Adm.Date Time<br>":
                                                       "Exp.Discharge":
                                                       "Exp.Return From Leave":
                                                       "</td>";
              COMPARE   "1",BULKDSCH
              IF        @EQUAL
                WRITE     HTMLFILE;"<td class=HeadingCell>Discharge<br>";
              ENDIF
              MATCH     "1",PRNTLABL
              IF        @EQUAL
                WRITE     HTMLFILE;"<td class=HeadingCell>Print Label<br>";
              ENDIF
              WRITE     HTMLFILE;"</tr>";
            ELSE
              MATCH     "1",STVVIEW
              IF        @EQUAL
                WRITE     HTMLFILE;"<td class=HeadingCell width='20%'>Patient Condition</td>";
              ELSE
                WRITE     HTMLFILE;"<td class=HeadingCell>Patient Condition</td>";
              ENDIF
.
              IF        DISPTHET=1 
                WRITE     HTMLFILE;"<td class=HeadingCell>":
                                   "Theatre <br> Status</td>";
              ENDIF
.
              IF        SJOGVIEW=1
                WRITE     HTMLFILE;"<td class=HeadingCell>Admission Diet</td>";
              ELSE
                WRITE     HTMLFILE;"<td class=HeadingCell>Diet</td>";
              ENDIF
.
              IF        FASTVIEW=ONE
.                                              * Stv Specific Heading Car 262343
                MATCH     "1",STVVIEW
                IF        @EQUAL
                  WRITE     HTMLFILE;"<td class=HeadingCell>":
                                     "Feeding<br />Assistance</td>";
                ELSE
                  WRITE     HTMLFILE;"<td class=HeadingCell>Fasting</td>";
                ENDIF
.
              ENDIF
.                                                                   * Car 235588
              IF        PTCNHDPS=ONE
                WRITE     HTMLFILE;"<td class=HeadingCell>Health Speciality</td>";
              ENDIF
.
              IF        SJOGVIEW=ONE
                MOVE      SP70,TDESC
                PACK      KEY5,ANSU,NINE,SP70
                CALL      RDCODE1
                WRITE     HTMLFILE;"<td class=HeadingCell>",TDESC,"</td>";
              ENDIF
.
              WRITE     HTMLFILE;"<td class=HeadingCell>Unit<br> Doctor</td>";
              MATCH     "1",ANAESTFL                                  *I-174468
              IF        @EQUAL
                WRITE     HTMLFILE;"<td class=HeadingCell>Anaesthetist</td>";
              ENDIF
              WRITE     HTMLFILE;"<td class=HeadingCell>Adm.Date Time<br>":
                                                       "Exp.Discharge<br>":
                                                       "Exp.Return From Leave":
                                                       "</td>";
.
              IF         SJOGVIEW=ONE
                WRITE     HTMLFILE;"<td class=HeadingCell>Post Op Ward/Bed</td>":
                                   "<td class=HeadingCell>Intended Stay</td>";
              ENDIF
.
              COMPARE   "1",BULKDSCH
              IF        @EQUAL
                WRITE     HTMLFILE;"<td class=HeadingCell>Discharge<br>";
              ENDIF
              MATCH     "1",PRNTLABL
              IF        @EQUAL
                WRITE     HTMLFILE;"<td class=HeadingCell>Print Label<br>";
              ENDIF
              WRITE     HTMLFILE;"</tr>";
            ENDIF

          ENDIF
.
CHEADG99  RETURN             
.
.------------------------------------------------------------
. Output Ward/Bed Row
.------------------------------------------------------------
CROWG000  MATCH     ZEROVISN,WADMNO
          GOTO      CROWG800 IF EQUAL
.
. WBEDTYPE 0= All,1 = OPEN (IGNORE),2 = Empty 
.
          BRANCH    WBEDTYPE,CROWG100,CROWG999
.
CROWG100  PACK      ADMISSNO,WADMNO
          MOVE      ZERO,STBYFLAG
          MOVE      PTWDBDST,CLOSEFLG
          CALL      CBEDG000         * Output Row Details
          ADD       ONE,NUMOFPAT     * count number of patients in ward
.
          MATCH     ZEROVISN,WSTBY
          GOTO      CROWG999 IF EQUAL
.
          PACK      ADMISSNO,WSTBY
          MOVE      ONE,STBYFLAG
          CALL      CBEDG000         * Output Row Details
          ADD       ONE,NUMOFPAT     * count number of patients in ward
.
          GOTO      CROWG999
.
CROWG800  MATCH     "1",PTWDBDST     * Is this bed closed?
          IF        @EQUAL
            MOVE      TWO,BEDMSGID   * Yes, bed is closed
            GOTO      CROWG850
          ELSE
            MOVE      ONE,BEDMSGID   * Assume Empty Bed
          ENDIF
.
          PACK      KEY14,WWARD,WBED,SP70
          CALL      RDSONLV1
CROWG810  CALL      RDKONLV1         * Try to find correct Ward/Bed
          BRANCH    OVRCD,CROWG850
          MATCH     OWARD,WWARD
          GOTO      CROWG850 IF NOT EQUAL
          MATCH     OBED,WBED
          GOTO      CROWG850 IF NOT EQUAL
          MOVE      ZERO,BEDMSGID     * Bed has patient on leave
.
CROWG850  BRANCH    FHIRTYPE,CROWG999
          CALL      CBDMSG00
.
CROWG999  RETURN
.
.------------------------------------------------------------
. Current Admissions Patient Details
.------------------------------------------------------------
CBEDG000  CALL      FHRCLR00                * Clear FHIR Encounter Variable
          PACK      SECDOCDE,SP70
          CALL      GETPAT00
          CALL      PATLN000
          CALL      PATFLD00                * Use standard Patient Folder sub
          MOVE      KEY3,FOLDERSF           * and store suffix
          CALL      GTDIET00
          MOVE      ADOCTA,DOCTCODE
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,CBEDG010
.
          PACK      KEY10,PMVXEDC1
          CALL      RDPMHCP1
          BRANCH    OVRCD,CBEDG010
.
          SQUEEZE   PMHCTITL
          SQUEEZE   PMHCSNAM
          MOVE      PMHCGNAM,DIM1
.
          CLEAR     SECDOCDE
          APPEND    PMHCTITL,SECDOCDE
          APPEND    SP1,SECDOCDE
          APPEND    DIM1,SECDOCDE
          APPEND    DOT,SECDOCDE
          APPEND    SP1,SECDOCDE
          APPEND    PMHCSNAM,SECDOCDE
          RESET     SECDOCDE

.
CBEDG010  CALL      GETAN000              * get Anaesthetist
          MOVE      SP70,CURSTATS
          MOVE      SP70,CURSTATB
          MOVE      SP70,CURSTATC
          MOVE      SP70,CURSTATT
.
          IF        ANATFLAG = 1
            CALL      PATSTS00                * get theatre status      
          ENDIF
.
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
.
          CALL      XRET0000                * Exp return from leave date/time 
.
          MATCH     SP70,PTWDCOMM
          IF        @EQUAL
            CLEAR     PTWDCOMM
            APPEND    "Bed ",PTWDCOMM
            APPEND    WBED,PTWDCOMM
            RESET     PTWDCOMM
          ENDIF
.
          IF        FHIRTYPE=1
            CALL      FHRENC00
            GOTO      CBEDG999
          ENDIF
.
CBEDG050  WRITE     HTMLFILE;"<tr height=35>"
.
          IF        NOBEDWRD=1
            GOTO      CBEDG090                * Bypass bed col for Wardonly Ward
          ENDIF
.
          BRANCH    FILETYPE,CBEDG060,CBEDG070,CBEDG080
.
CBEDG060  WRITE     HTMLFILE;"<td align=center class=UnallocatedCell>":
                             "<img src='../images/EditIcon.gif'":
                             " class=ListIcon onclick='BedAllocation(#"":
                             URNUMBER,"#",#"",ADMISSNO,"#");'>":
                             "</td>"
          GOTO      CBEDG090
.
CBEDG070  IF        STBYFLAG=0
            MATCH     "1",CLOSEFLG     * Is this Bed Closed?
            IF        @EQUAL
              WRITE     HTMLFILE;"<td align=center class=ClosedCell ":
                                 "title=#"",PTWDCOMM,"#" ":
                                 "bgcolor=gray>";
            ELSE
              WRITE     HTMLFILE;"<td align=center ":
                                 "title=#"",PTWDCOMM,"#">";
            ENDIF
          ELSE
            WRITE     HTMLFILE;"<td align=center class=StandbyCell ":
                               "title=#"",PTWDCOMM,"#">";
          ENDIF
.
          CALL      FBED0000
          WRITE     HTMLFILE;*+,BEDTEXT,"&nbsp;</td>"
          GOTO      CBEDG090
.
CBEDG080  MATCH     "1",CLOSEFLG     * Is this Bed Closed?
          IF        @EQUAL
            WRITE     HTMLFILE;"<td align=center class=ClosedCell ":
                               "title=#"",PTWDCOMM,"#" ":
                               "bgcolor=gray>";
          ELSE
            WRITE     HTMLFILE;"<td align=center class=LeaveCell ":
                               "title=#"",PTWDCOMM,"#">";
          ENDIF
.
          CALL      FBED0000
          WRITE     HTMLFILE;*+,BEDTEXT,"&nbsp;</td>"
.
.
CBEDG090  WRITE     HTMLFILE;"<td nowrap>":
                             "<img src=../images/PatientFolder",FOLDERSF,".gif":
                             " class=ListIcon ":
                             " onclick='location.href=#"",LINKPRG,".pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO,"#";'>";
.
         IF        DISPDNAM=1
            REP       "+ ",ADMISSNO
            REP       "+ ",URNUMBER
            CALL      CHKD0000           * Duplicate Surnames?
            IF        DUPNMFLG=1
              WRITE     HTMLFILE;"<img src='../images/samename.gif'":
                                 " alt='Patient Name Conflict'":
                                 " class=ListIcon>";
            ENDIF
            REP       " +",ADMISSNO
            REP       " +",URNUMBER
         ENDIF
.
          COMPARE   ONE,ONLVFLAG
          GOTO      CBEDG092 IF NOT EQUAL
          COMPARE   THREE,FILETYPE
          GOTO      CBEDG092 IF NOT EQUAL
.
          MATCH     "1",PTCNHLEA             * Check Parameter Disp.On Leave
          GOTO      CBEDG092 IF NOT EQUAL
.
          MOVE      ADMISSNO,KEY8
          REP       "+ ",KEY8
          SQUEEZE   KEY8
.
          MOVE      KEY8,PVIBILL
          PROC      TLEA0000
.
          MOVE      "TL",CATEGORY            * Output Type of Leave
          CALL      GETCOD00
          MOVE      "On Leave - ",KEY11
          PACK      KEY31,KEY11,TDESC,SP70
          WRITE     HTMLFILE;FORMATNM,"<br>",KEY31,"</td>";
          GOTO      CBEDG094
.
CBEDG092  WRITE     HTMLFILE;FORMATNM,"</td>";
.
                                        * Don't use URno col for St.Vincents
CBEDG094  IF        KIDSONLY=ONE
            REP       "+ ",URNUMBER
            WRITE     HTMLFILE;"<td nowrap align=center>":
                                URNUMBER,"</td>";
            REP       " +",URNUMBER
          ENDIF
.
          IF       KIDSVEW2 = 1
            MOVE      ADIAG1,DIM15
            WRITE     HTMLFILE;"<td nowrap align=left>":
                                DIM15,"&nbsp;</td>";
            MOVE      PMVXUDF1,DIM15
            WRITE     HTMLFILE;"<td nowrap align=left>":
                                DIM15,"&nbsp;</td>";
            GOTO     CBEDG154
          ENDIF
.
          IF       ALTVIEW1 = 1
            WRITE     HTMLFILE;"<td nowrap align=left>":
                                ADIAG1,"&nbsp;</td>";
            GOTO     CBEDG154
          ENDIF
.
CBEDG100  CALL      GETCON00               * Get Patient Condition Details
.
          MATCH     SP70,CONDESC
          IF        !@EQUAL
            UNPACK    LPCDATE,CCENT,CYEAR,CMON,CDAY
            PACK      DISPDATE,LBRACKT,CDAY,SLASH,CMON,SP1,LPCTIME,RBRACKT
          ELSE
            CLEAR     DISPDATE
          ENDIF
.
          WRITE     HTMLFILE;"<td>"
.
          MATCH     "1",STVVIEW
          IF        @EQUAL
            WRITE     HTMLFILE;"<table width=100% border=0":
                      " style='table-layout:fixed;'>":
                      "<tr><td style='overflow:hidden;text-overflow:ellipsis;":
                      "white-space:nowrap'>"
          ELSE
            WRITE     HTMLFILE;"<table border=0 width=100%><tr><td>"
          ENDIF
.
          MOVE      ZERO,EXIT
          PROC      DISPALRT                * check for Disability Alerts
.          
CBEDG110  MATCH     "1",PMPXSIN7
          IF        @EQUAL
            WRITE     HTMLFILE;"<img src='../images/AlertIconM.gif'":
                               " alt='Medical Alerts'":
                               " class=ListIcon onclick='PatientAlerts(#"":
                               URNUMBER,"#",#"",ADMISSNO,"#");'>"
          ENDIF
.
          MATCH     "1",PMPXSIN8
          IF        @EQUAL
            WRITE     HTMLFILE;"<img src='../images/AlertIconB.gif'":
                               " alt='Micro Alerts'":
                               " class=ListIcon onclick='PatientAlerts(#"":
                               URNUMBER,"#",#"",ADMISSNO,"#");'>"
          ENDIF
.
          MATCH     "1",PMPXSIN9
          IF        @EQUAL
            WRITE     HTMLFILE;"<img src='../images/AlertIconR.gif'":
                               " alt='Risk Alerts'":
                               " class=ListIcon onclick='PatientAlerts(#"":
                               URNUMBER,"#",#"",ADMISSNO,"#");'>"
          ENDIF
.
          MATCH     "1",PMPXSN11
          IF        @EQUAL
            WRITE     HTMLFILE;"<img src='../images/AlertIconC.gif'":
                               " alt='Chronic Alerts'":
                               " class=ListIcon onclick='PatientAlerts(#"":
                               URNUMBER,"#",#"",ADMISSNO,"#");'>"
          ENDIF
.
          IF        EXIT=0 | EXIT=2 
            MATCH     "1",PTMXSIN1
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIcon.gif'":
                                 " alt='Alerts'":
                                 " class=ListIcon onclick='PatientAlerts(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#");'>"
              GOTO      CBEDG120
            ENDIF
.
            MATCH     "2",PTMXSIN1
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIconBlack.gif'":
                                 " alt='Alerts'":
                                 " class=ListIcon onclick='PatientAlerts(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#");'>"
              GOTO      CBEDG120
            ENDIF
.
            MATCH     "3",PTMXSIN1
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIconDelete.gif'":
                                 " alt='Alerts'":
                                 " class=ListIcon onclick='PatientAlerts(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#");'>"
              GOTO      CBEDG120
            ENDIF
.
            MATCH     SP70,PTMXSIN1
            IF        !@EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIcon":
                                 PTMXSIN1,".gif'":
                                 " alt='Alerts'":
                                 " class=ListIcon onclick='PatientAlerts(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#");'>"
            ENDIF
          ENDIF
.
CBEDG120  IF        EXIT=1 | EXIT=2
            WRITE     HTMLFILE;"<img src='../images/AlertIconDIS.gif'":
                               " alt='Disability Alerts'":
                               " class=ListIcon onclick='PatientAlerts(#"":
                               URNUMBER,"#",#"",ADMISSNO,"#");'>"
          ENDIF
.
          IF        MEHLSFLG=1
            CALL      CMHL0000              * Check for MH legal status icon
          ENDIF
.
          MATCH     "1",PTMXSIN2
          IF        @EQUAL
.            WRITE     HTMLFILE;"<img src=#"../images/ResultIcon.gif#"":
.                               " class=ListIcon onclick='PatientResults(#"":
.                               URNUMBER,"#",#"",ADMISSNO,"#");'>"
          ENDIF
.
          IF        EMRGVIEW=1
            CALL      GETE0000
            MATCH     ZEROVISN,EMVIADMN
            IF        !@EQUAL
              WRITE     HTMLFILE;"<img src='../images/DocumentIcon.gif'":
                                 " class=ListIcon ":
                                 " alt=#"Update emergency clinic notes#"" :
                                 " onclick='UpdateEMR(#"":
                             URNUMBER,"#",#"",EMVIADMN,"#",#"",EMVIFLAG,"#");'>"
            ENDIF
          ENDIF
.
          IF        CNOTFLAG=1
            MATCH     SP70,PTMXSIN3
            IF        !@EQUAL
              WRITE     HTMLFILE;"<img src='../images/NotesIcon.gif'":
                                 " class=ListIcon ":
                                 " onclick='PatientNotes(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#");'>"
            ENDIF
          ENDIF
.
.-------- Get Over flow description --------                         *C-0837181
          MOVE      SP70,OVFLDESC                               
          IF        HEAVIEW=1
            CALL      OVFDS000                         * Get OVFLDESC          
          ENDIF
.
          IF        WORKDFLG=1
            WRITE     HTMLFILE;"<img src=../images/",IMGSRC:
                               " class=ListIcon onclick='UpdateCondition(#"":
                               URNUMBER,"#",#"",ADMISSNO,"#")'>":
                               CONDESC,DISPDATE,WORKDESC,OVFLDESC;
            GOTO      CBEDG130
          ENDIF
.
          MATCH     SP70,LPCONDD
          IF        @EQUAL
            MATCH     SP70,PMVXUDF2
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src=../images/",IMGSRC:
                                 " class=ListIcon onclick='UpdateCondition(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#")'>":
                                 CONDESC,DISPDATE,OVFLDESC;
            ELSE
              WRITE     HTMLFILE;"<img src=../images/",IMGSRC:
                                 " class=ListIcon onclick='UpdateCondition(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#")'>":
                                 CONDESC,DISPDATE,OVFLDESC,"<br>",PMVXUDF2;
            ENDIF
          ELSE
            MATCH     SP70,PMVXUDF2
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src=../images/",IMGSRC:
                                 " class=ListIcon onclick='UpdateCondition(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#")'>":
                                 CONDESC,DISPDATE,OVFLDESC,"<br>",LPCONDD;
            ELSE
              WRITE     HTMLFILE;"<img src=../images/",IMGSRC:
                                 " class=ListIcon onclick='UpdateCondition(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#")'>":
                                 CONDESC,DISPDATE,OVFLDESC,"<br>",LPCONDD:
                                 "<br>",PMVXUDF2;
            ENDIF
          ENDIF
.
CBEDG130  MATCH     "1",STVVIEW
          IF        @EQUAL
            CALL      GETRIC00         * Get Risk icons
          ENDIF
.
          MOVE      ANSR,DIM1
          MATCH     "1",PMVXVALW
          IF        @EQUAL
            MOVE ANSV,DIM1
          ENDIF
          WRITE     HTMLFILE;"<br>[",DIM1,COMMA,NBSP;
.
          MOVE      ANSN,DIM1
          MATCH     "1",PMVXPALW
          IF        @EQUAL
            MOVE      ANSP,DIM1
          ENDIF
          WRITE     HTMLFILE;DIM1;
.
          MATCH     "1",PMVXPALW            * Phone Calls Allowed?
          GOTO      CBEDG131 IF  NOT EQUAL  * no; close off output
.
          IF        FILETYPE=1
.
.           No Bed...
.
            PACK      KEY6,NBWARD,NBROOM,SP20
            CALL      RDWARD1
            BRANCH    OVRCD,CBEDG131
          ENDIF
.
          IF        FILETYPE=1 | FILETYPE=3
.
.           No Bed/On Leave
.
            MATCH     SP70,PTWDNSTA
            IF        !@EQUAL
.
.             Has a linked Nursing Station
.
              MOVE      PTWDNSTA,NURSTCOD
              CALL      WNURN000            * get Nursing Station number
              MATCH     SP70,NURSTNUM
              IF        !@EQUAL
                STRIP     NURSTNUM
                WRITE     HTMLFILE;" - ",*+,NURSTNUM,*-;
              ELSE
                MATCH     SP70,WEXTN
                IF        !@EQUAL
                  STRIP     WEXTN
                  WRITE     HTMLFILE;" - ",*+,WEXTN,*-;
                ENDIF
              ENDIF
            ELSE
.
.             No linked Nursing Station
.
              MATCH     SP70,WEXTN
              IF        !@EQUAL
                STRIP     WEXTN
                WRITE     HTMLFILE;" - ",*+,WEXTN,*-;
              ENDIF
            ENDIF
          ELSE
.
.           Bed/Ward...
.
            MATCH     SP70,WEXTN
            IF        !@EQUAL
              STRIP     WEXTN
              WRITE     HTMLFILE;" - ",*+,WEXTN,*-;   * default ward/bed ext. no
            ELSE
              MOVE      PTWDNSTA,NURSTCOD
              CALL      WNURN000            * get Nursing Station number
              MATCH     SP70,NURSTNUM
              IF        !@EQUAL
                STRIP     NURSTNUM
                WRITE     HTMLFILE;" - ",*+,NURSTNUM,*-;
              ENDIF
            ENDIF
          ENDIF
.
CBEDG131  WRITE     HTMLFILE;"]";
.
          BRANCH    KIDSONLY,CBEDG140
          MATCH     SP3,LPCONAM
          IF        !@EQUAL
            MOVE      "AM",CATEGORY
            MOVE      LPCONAM,CODE
            CALL      GETCOD00
            WRITE     HTMLFILE;NBSP,NBSP,TDESC;
          ENDIF
.
CBEDG140  MATCH     SP3,PMWODPST
          IF        !@EQUAL
            MOVE      "vi",CATEGORY
            MOVE      PMWODPST,CODE
            CALL      GETCOD00
            WRITE     HTMLFILE;NBSP,TDESC;
          ENDIF
.
          MATCH     "1",STVVIEW
          IF        @EQUAL
            WRITE     HTMLFILE;"</td><td width=20 align=right valign=top>"
          ELSE
            WRITE     HTMLFILE;"</td><td align=right valign=top>"
          ENDIF
.
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO 
.
          UNPACK    SAVKEY27,PTVEVISN,PTVEVTYP,PTVESDAT,PTVESTIM
          WRITE     HTMLFILE;"<img src=../images/mv_",MVFLAG:
                             ".png class=ListIcon onclick='gotoMV(#"":
                             URNUMBER,"#",#"",PTVEVISN,"#",#"":
                             PTVEVTYP,"#",#"",PTVESDAT,"#",#"":
                             PTVESTIM,"#")'>";
.
          MOVE      ZERO,BORDICIN
          PACK      KEY26,ADMISSNO,SP70
          CALL      RSPTBRD3
CBEDG142  CALL      RKPTBRD3
          IF        OVRCD=0
            MATCH     ADMISSNO,PTBRVISN
            IF        @EQUAL
              MATCH     SP70,PTBREDAT
              IF        !@EQUAL & !@EOS
                MATCH     TODAYDAT,PTBREDAT
                GOTO      CBEDG142 IF LESS            * CAR 304926
                GOTO      CBEDG143 IF NOT EQUAL       * CAR 304926
.
                MATCH     SP70,PTBRETIM
                IF        !@EQUAL & !@EOS
                  MATCH     CTIMEIS,PTBRETIM
                  GOTO      CBEDG142 IF LESS          * CAR 304926
                ENDIF
              ENDIF
CBEDG143      ADD       ONE,BORDICIN 
              COMPARE   TWO,BORDICIN
              GOTO      CBEDG144 IF EQUAL
              GOTO      CBEDG142
            ENDIF
          ENDIF
.
CBEDG144  PACK      KEY26,ADMISSNO,SP70
          CALL      RSPTBRD3
CBEDG145  CALL      RKPTBRD3
          IF        OVRCD=0
            MATCH     ADMISSNO,PTBRVISN
            IF        @EQUAL 
              MATCH     SP70,PTBREDAT
              IF        !@EQUAL & !@EOS
                MATCH     TODAYDAT,PTBREDAT
                GOTO      CBEDG145 IF LESS            * CAR 304926
                GOTO      CBEDG146 IF NOT EQUAL       * CAR 304926
.
                MATCH     SP70,PTBRETIM
                IF        !@EQUAL & !@EOS
                  MATCH     CTIMEIS,PTBRETIM
                  GOTO      CBEDG145 IF LESS          * CAR 304926
                ENDIF
              ENDIF
.
CBEDG146        MOVE      SP70,DISPBBDT
                MATCH     SP70,PTBRBDAT
                IF        !@EQUAL & !@EOS
                  UNPACK    PTBRBDAT,CCENT,CYEAR,CMON,CDAY
                  MOVE      CMON,F2
                  LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN:
                                       JUL,AUG,SEP,OCT,NOV,DEC
                  PACK      DISPBBDT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR 
.
                  CALL      IBACLOCK
                  PACK      AGEDATE,CCC,CYY,CMM,CDD
                  PACK      PBDATE,PTBRBDAT
                  CALL      CALCAGE
                  MOVE      PSAGEYRS,PSAGEDIM
                ELSE
                  MOVE      SP70,PSAGEDIM
                ENDIF
.
                MOVE      SP70,DISPBSDT
                MATCH     SP70,PTBRSDAT
                IF        !@EQUAL & !@EOS
                  UNPACK    PTBRSDAT,CCENT,CYEAR,CMON,CDAY
                  MOVE      CMON,F2
                  LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN:
                                       JUL,AUG,SEP,OCT,NOV,DEC
                  PACK      DISPBSDT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
                ENDIF
.
                IF        BORDICIN=2
                  MATCH     SP70,PTBRADR1
                  IF        @EQUAL | @EOS
                    MATCH     SP70,PTBRADR2
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDG147
                    ENDIF
.
                    MATCH     SP70,PTBRADR3
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDG147
                    ENDIF
.
                    MATCH     SP70,PTBRADR4
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDG147
                    ENDIF
.
                    MATCH     SP70,PTBRPOST
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDG147
                    ENDIF
.
                    MATCH     SP70,PTBRHPHN
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDG147
                    ENDIF
.
                    MATCH     SP70,PTBRWPHN
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDG147
                    ENDIF
.
                    MATCH     SP70,PTBRMPHN
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDG147
                    ENDIF
.
                    MATCH     SP70,PTBREMAL
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDG147
                    ENDIF
.
                    MATCH     SP70,PTBRLURN
                    IF        @EQUAL | @EOS
                      GOTO      CBEDG147
                    ENDIF
.
                    PACK      KEY8,PTBRLURN,SP70
                    CALL      RDMAST1
                    IF        OVRCD
                      PACK      KEY8,URNUMBER,SP70
                      CALL      RDMAST1
.
                      GOTO      CBEDG147
                    ENDIF
.
                    CALL      RDPMPX21
.
                    REP       "'`",PTBRSNAM
                    REP       "'`",PTBRGNAM
                    REP       "'`",PADD1
                    REP       "'`",PADD2
                    REP       "'`",PSUBRB
                    REP       "'`",PADD4
                    REP       "'`",PTELEP
                    REP       "'`",PTELEB
.
                  WRITE     HTMLFILE;"<img src='../images/PatientLink4.gif' class=ListIcon":
                           " onclick=#"gotoBoarder('",URNUMBER,"','",ADMISSNO:
                           "','",PTBRBRDN,"');#"":
                           " onmouseover=#"showit('",PTBRSNAM,"'":
                                                  ",'",PTBRGNAM,"'":
                                                  ",'",PTBRGEND,"'":
                                                  ",'",DISPBBDT,"'":
                                                  ",'",PSAGEDIM,"'":
                                                  ",'",PADD1,"'":
                                                  ",'",PADD2,"'":
                                                  ",'",PSUBRB,"'":
                                                  ",'",PADD4,"'":
                                                  ",'",PPOST,"'":
                                                  ",'",PTELEP,"'":
                                                  ",'",PTELEB,"'":
                                                  ",'",PTMXCELL,"'":
                                                  ",'",PMPXPEML,"'":
                                                  ",'",DISPBSDT,"'":
                                                  ",'",PTBRSTIM,"'";
                    PACK      KEY8,URNUMBER,SP70
                    CALL      RDMAST1
                    CALL      RDPMPX21
.
                  ELSE
CBEDG147            REP       "'`",PTBRSNAM
                    REP       "'`",PTBRGNAM
                    REP       "'`",PTBRADR1
                    REP       "'`",PTBRADR2
                    REP       "'`",PTBRADR3
                    REP       "'`",PTBRADR4
.
                WRITE     HTMLFILE;"<img src='../images/PatientLink4.gif' class=ListIcon":
                           " onclick=#"gotoBoarder('",URNUMBER,"','",ADMISSNO:
                           "','",PTBRBRDN,"');#"":
                           " onmouseover=#"showit('",PTBRSNAM,"'":
                                                  ",'",PTBRGNAM,"'":
                                                  ",'",PTBRGEND,"'": 
                                                  ",'",DISPBBDT,"'":
                                                  ",'",PSAGEDIM,"'":
                                                  ",'",PTBRADR1,"'":
                                                  ",'",PTBRADR2,"'":
                                                  ",'",PTBRADR3,"'":
                                                  ",'",PTBRADR4,"'":
                                                  ",'",PTBRPOST,"'":
                                                  ",'",PTBRHPHN,"'":
                                                  ",'",PTBRWPHN,"'":
                                                  ",'",PTBRMPHN,"'":
                                                  ",'",PTBREMAL,"'":
                                                  ",'",DISPBSDT,"'":
                                                  ",'",PTBRSTIM,"'";
                  ENDIF
.
.       MATCH     SP70,PTBRLURN
.       IF        @EQUAL | @EOS
.         WRITE     HTMLFILE;",'",PTBRURNO,"'";
.       ELSE
          WRITE     HTMLFILE;",'",PTBRLURN,"'";
.       ENDIF
.
        WRITE     HTMLFILE;",'",PTBRTITL,"'":
                           ",'",PTITL,"'":
                           ",'",PSNAME,"'":
                           ",'",PGNAME,"'":
                           ");#"":
                           " onmouseout=#"hideit();#">"
                ELSE
                  MATCH     SP70,PTBRADR1
                  IF        @EQUAL | @EOS
                    MATCH     SP70,PTBRADR2
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDG149
                    ENDIF
.
                    MATCH     SP70,PTBRADR3
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDG149
                    ENDIF
.
                    MATCH     SP70,PTBRADR4
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDG149
                    ENDIF
.
                    MATCH     SP70,PTBRPOST
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDG149
                    ENDIF
.
                    MATCH     SP70,PTBRHPHN
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDG149
                    ENDIF
.
                    MATCH     SP70,PTBRWPHN
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDG149
                    ENDIF
.
                    MATCH     SP70,PTBRMPHN
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDG149
                    ENDIF
.
                    MATCH     SP70,PTBREMAL
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDG149
                    ENDIF
.
                    MATCH     SP70,PTBRLURN
                    IF        @EQUAL | @EOS
                      GOTO      CBEDG149
                    ENDIF
.
                    PACK      KEY8,PTBRLURN,SP70
                    CALL      RDMAST1
                    IF        OVRCD
                      PACK      KEY8,URNUMBER,SP70
                      CALL      RDMAST1
.
                      GOTO      CBEDG149
                    ENDIF
.
                    CALL      RDPMPX21
.
                    REP       "'`",PTBRSNAM
                    REP       "'`",PTBRGNAM
                    REP       "'`",PADD1
                    REP       "'`",PADD2
                    REP       "'`",PSUBRB
                    REP       "'`",PADD4
                    REP       "'`",PTELEP
                    REP       "'`",PTELEB
.
                  WRITE     HTMLFILE;"<img src='../images/PatientLink1.gif' class=ListIcon":
                           " onclick=#"gotoBoarder('",URNUMBER,"','",ADMISSNO:
                           "','",PTBRBRDN,"');#"":
                           " onmouseover=#"showit('",PTBRSNAM,"'":
                                                  ",'",PTBRGNAM,"'":
                                                  ",'",PTBRGEND,"'":
                                                  ",'",DISPBBDT,"'":
                                                  ",'",PSAGEDIM,"'":
                                                  ",'",PADD1,"'":
                                                  ",'",PADD2,"'":
                                                  ",'",PSUBRB,"'":
                                                  ",'",PADD4,"'":
                                                  ",'",PPOST,"'":
                                                  ",'",PTELEP,"'":
                                                  ",'",PTELEB,"'":
                                                  ",'",PTMXCELL,"'":
                                                  ",'",PMPXPEML,"'":
                                                  ",'",DISPBSDT,"'":
                                                  ",'",PTBRSTIM,"'";
                    PACK      KEY8,URNUMBER,SP70
                    CALL      RDMAST1
                    CALL      RDPMPX21
.
                  ELSE
CBEDG149            REP       "'`",PTBRSNAM
                    REP       "'`",PTBRGNAM
                    REP       "'`",PTBRADR1
                    REP       "'`",PTBRADR2
                    REP       "'`",PTBRADR3
                    REP       "'`",PTBRADR4
.
                WRITE     HTMLFILE;"<img src='../images/PatientLink1.gif' class=ListIcon":
                           " onclick=#"gotoBoarder('",URNUMBER,"','",ADMISSNO:
                           "','",PTBRBRDN,"');#"":
                           " onmouseover=#"showit('",PTBRSNAM,"'":
                                                  ",'",PTBRGNAM,"'":
                                                  ",'",PTBRGEND,"'":
                                                  ",'",DISPBBDT,"'":
                                                  ",'",PSAGEDIM,"'":
                                                  ",'",PTBRADR1,"'":
                                                  ",'",PTBRADR2,"'":
                                                  ",'",PTBRADR3,"'":
                                                  ",'",PTBRADR4,"'":
                                                  ",'",PTBRPOST,"'":
                                                  ",'",PTBRHPHN,"'":
                                                  ",'",PTBRWPHN,"'":
                                                  ",'",PTBRMPHN,"'":
                                                  ",'",PTBREMAL,"'":
                                                  ",'",DISPBSDT,"'":
                                                  ",'",PTBRSTIM,"'";
                  ENDIF
.
.       MATCH     SP70,PTBRLURN
.       IF        @EQUAL | @EOS
.         WRITE     HTMLFILE;",'",PTBRURNO,"'";
.       ELSE
          WRITE     HTMLFILE;",'",PTBRLURN,"'";
.       ENDIF
.
        WRITE     HTMLFILE;",'",PTBRTITL,"'":
                           ",'",PTITL,"'":
                           ",'",PSNAME,"'":
                           ",'",PGNAME,"'":
                           ");#"":
                           " onmouseout=#"hideit();#">"
                ENDIF
            ENDIF
          ENDIF
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
.
          WRITE     HTMLFILE;"</td></tr></table>"
          WRITE     HTMLFILE;"</td>";
.
          IF       DISPTHET=1
            MATCH     "1",OPCNTHED
            IF        @EQUAL
              WRITE     HTMLFILE;"<td nowrap align=center>",CURSTATS;
              MATCH     SP70,CURSTATT
              IF        !@EQUAL & !@EOS
                WRITE      HTMLFILE;*+,"<br>",CURSTATT;
              ENDIF
              WRITE     HTMLFILE;"<br>",CURSTATB,"&nbsp;</td>";
            ELSE
              WRITE     HTMLFILE;"<td nowrap align=center>":
                                  CURSTATS,"<br>",CURSTATB,"&nbsp;</td>";
            ENDIF
          ENDIF
.
          IF        HEAVIEW=1
            MOVE      "DC",CATEGORY
            MOVE      PMNUDIET,CODE
            CALL      GETCOD00
            MOVE      TDESC,DIETDESC
          ELSE
            MOVE      "DC",CATEGORY
            MOVE      ADIET,CODE
            CALL      GETCOD00
            MOVE      TDESC,DIETDESC
          ENDIF
.                                          * I CAR 48029
          IF        PTCNHDPS = ONE
            WRITE     HTMLFILE;"<td><img src='../images/DietIcon.gif' ":
                               " class=ListIcon onclick='UpdateDiet(#"":
                               URNUMBER,"#",#"",ADMISSNO,"#")'>",DIETDESC,"<br> ";
.
            MATCH     "1",SKIPDIET
            IF        @EQUAL  
              WRITE     HTMLFILE;"</td>";
            ELSE
              WRITE     HTMLFILE;PMVXUDF4,"</td>";
            ENDIF
.
          ELSE
            IF        EXTRDIET = 1
              MOVE      "MJ",CATEGORY
              MOVE      PMNUML01,CODE
              CALL      GETCOD00
              MOVE      TDESC,DIETDSC2
              STRIP     DIETDSC2
.
              MOVE      "MJ",CATEGORY
              MOVE      PMNUML03,CODE
              CALL      GETCOD00
              MOVE      TDESC,DIETDSC3
              STRIP     DIETDSC3
.
              MOVE      "MJ",CATEGORY
              MOVE      PMNUML05,CODE
              CALL      GETCOD00
              MOVE      TDESC,DIETDSC4
              STRIP     DIETDSC4
.
              MOVE      "MJ",CATEGORY
              MOVE      PMNUML07,CODE
              CALL      GETCOD00
              MOVE      TDESC,DIETDSC5
              STRIP     DIETDSC5
.
              WRITE     HTMLFILE;"<td><img src='../images/DietIcon.gif' ":
                                 " class=ListIcon onclick='UpdateDiet(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#")'>";
.
              MATCH     "1",SKIPDIET
                IF        @EQUAL
                  WRITE     HTMLFILE;"</td>";
                ELSE
                  WRITE     HTMLFILE;DIETDESC,"<br>",DIETDSC2,"<br>",DIETDSC3,"<br>":
                            DIETDSC4,"<br>",DIETDSC5,"</td>";
                ENDIF
            ELSE
              WRITE     HTMLFILE;"<td><img src='../images/DietIcon.gif' ":
                                 " class=ListIcon onclick='UpdateDiet(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#")'>";
.
              MATCH     "1",SKIPDIET
              IF        @EQUAL
                WRITE     HTMLFILE;"</td>";
              ELSE
                WRITE     HTMLFILE;DIETDESC,"</td>";
              ENDIF
            ENDIF
          ENDIF
.
          IF        FASTVIEW=ONE
            WRITE     HTMLFILE;"<td>",DTFASTNG,"</td>";
          ENDIF
.                                                                   * Car 235588
          IF        PTCNHDPS=ONE
            MOVE      "A ",CATEGORY
            MOVE      ATYPE,CODE
            CALL      GETCOD00
.
            MATCH     SP70,TDESC
            IF        @EQUAL
              WRITE     HTMLFILE;"<td>&nbsp;</td>";
            ELSE
              WRITE     HTMLFILE;"<td>",TDESC,"</td>";
            ENDIF
          ENDIF
.
          IF        SJOGVIEW<>1
            GOTO      CBEDG154
          ENDIF
.
          MATCH     "1",PTCNDFAL            * Display Food Allergy
          IF        !@EQUAL
            MATCH     SP70,PTMIUSR9
            IF        @EQUAL
              WRITE     HTMLFILE;"<td>&nbsp;</td>";
            ELSE
              PACK      KEY5,ANSU,NINE,PTMIUSR9,SP70
              CALL      RDCODE1
              IF        OVRCD<>1
                WRITE     HTMLFILE;"<td>",TDESC,"</td>";
              ELSE
                WRITE     HTMLFILE;"<td>&nbsp;</td>";
              ENDIF
            ENDIF
            GOTO       CBEDG154
          ENDIF
.
.
          WRITE     HTMLFILE;"<td>";
          REPLACE   "+ ",URNUMBER
          PACK      KEY16,URNUMBER,CATH3,SP70
          CALL      RSPTALR1
          CALL      RKPTALR1                * Check if any H3 Alerts Exist?
          IF        OVRCD=1
            WRITE     HTMLFILE;"&nbsp;&nbsp;&nbsp; ";
            GOTO      CBEDG152
          ENDIF
.
          MATCH     URNUMBER,PTALURNO
          IF        !@EQUAL  
            WRITE     HTMLFILE;"&nbsp;&nbsp;&nbsp; ";
            GOTO      CBEDG152
          ENDIF 
.
          MATCH     CATH3,PTALCATG
          IF        @EQUAL
            WRITE     HTMLFILE;"Yes ";
          ELSE  
            WRITE     HTMLFILE;"&nbsp;&nbsp;&nbsp; ";
          ENDIF
.
CBEDG152  MATCH     SP70,PTMIUSR9
          IF        !@EQUAL
            PACK      KEY5,ANSU,NINE,PTMIUSR9,SP70  * Food Allergy flag at patient level?
            CALL      RDCODE1
            IF        OVRCD<>1
              WRITE     HTMLFILE;" (",TDESC,")";
            ELSE
              WRITE     HTMLFILE;" (Unknown)";
            ENDIF
          ELSE
            WRITE     HTMLFILE;" (Unknown)";
          ENDIF
.
          REPLACE   " +",URNUMBER
          WRITE     HTMLFILE;"</td>"
.
CBEDG154  MOVE      SP70,TDESC
          REP       "+ ",ADMISSNO
          PACK      KEY30,ADMISSNO,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          IF        OVRCD = 0
            MATCH     ADMISSNO,DTADMN
            IF        @EQUAL
              MOVE      "AC",CATEGORY
              MOVE      TDEPT,CODE
              CALL      GETCOD00
             ENDIF
          ENDIF
          REP       " +",ADMISSNO
.
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
CBEDG155  WRITE     HTMLFILE;"<td nowrap>",TDESC,"<br>":
                             " <a href='":
                             "javascript:DoctorViewFrame(#"",DOCTCODE,"#")'>":
                              SDOCFNAM,"</a>";
. 
          REP       "+ ",ADMISSNO
          MATCH     SP70,PMVXEDC1
          GOTO      CBEDG158 IF EQUAL
.
          PACK     KEY24,ADMISSNO,Z70
          CALL     RSPMDTC1
CBEDG156  CALL     RPPMDTC1
          BRANCH   OVRCD,CBEDG157
.
          MATCH    ADMISSNO,PMDTVISN
          GOTO     CBEDG157 IF NOT EQUAL
.
          MATCH    PMDTDOCT,PMVXEDC1
          GOTO     CBEDG156 IF NOT EQUAL
.
          MATCH    PMDTUNIT,PMVXEDU1
          GOTO     CBEDG156 IF NOT EQUAL
.
          MATCH    SP70,PMDTEDAT
          GOTO     CBEDG157 IF EQUAL
.
          MOVE     SP70,KEY8A
          MOVE     PMDTETIM,KEY8A
          MATCH    SP70,KEY8A
          IF       @EQUAL
            PACK     KEY8A,ZERO,ZERO,COLON,ZERO,ZERO,COLON,ZERO,ZERO
          ENDIF
.
          PACK     KEY16,PMDTEDAT,KEY8A,SP70
.
          CALL     IBACLOCK
          PACK     KEY8,CCC,CYY,CMM,CDD
          REP      " 0",KEY8
          PACK     KEY16A,KEY8,CTIMEIS,SP70
.
          MATCH    KEY16A,KEY16
          GOTO     CBEDG158 IF LESS
.
CBEDG157  WRITE     HTMLFILE;SP1,SLASH,SP1,"<a href='":
                             "javascript:DoctorViewFrame(#"",PMVXEDC1,"#")'>":
                              SECDOCDE,"</a></td>";
.
CBEDG158  REP       " +",ADMISSNO
          MATCH     "1",ANAESTFL                                      *I-174468
          IF        @EQUAL
            MATCH     SP6,ANATNAME
            IF        @EQUAL
              WRITE     HTMLFILE;"<td>&nbsp;</td>";
            ELSE 
              WRITE     HTMLFILE;"<td nowrap> <a href='":
                               "javascript:DoctorViewFrame(#"",ANATCODE,"#")'>":
                                ANATNAME,"</a></td>";
            ENDIF
          ENDIF
.
          IF        KIDSVEW2 = 1
            WRITE     HTMLFILE;"<td nowrap align=left>":
                                ACLAIM,"&nbsp;</td>";
          ENDIF
.
CBEDG160  WRITE     HTMLFILE;"<td nowrap class=",COLRFLAG,">":
                               DISPDATE,ATIME,"<br>":
                               EXPCTDSC,"<br>";

          CALL      CHKMUL000
          IF        EXIT=0
            WRITE     HTMLFILE;"Current IP - ",MULTHOSP,"<br>";
          ENDIF 
.
          IF        FILETYPE=3
            WRITE     HTMLFILE;EXPLRETN;
          ENDIF
.
          WRITE     HTMLFILE;"&nbsp;</td>";
.
          COMPARE   "1",BULKDSCH
          GOTO      CBEDG300 IF NOT EQUAL
.
          PACK      KEY16,AADMNO,SP70
          CALL      RSPMRCB2
          CALL      RKPMRCB2
          BRANCH    OVRCD,CBEDG200
.
          MATCH     DAADMNO,PMRCADMN
          GOTO      CBEDG200 IF NOT EQUAL
.
          REP       " +",DAADMNO
          REP       " +",EXPCTDSC
.
          WRITE     HTMLFILE;"<td><input type=button name=discharg id=discharg value=":
         "'Discharge' onclick='dischargeAdm(this,#"",DAADMNO,"#",#"",EXPCTDSC,"#");'":
                             "></td>";
.
          REP       "+ ",DAADMNO
          REP       "+ ",EXPCTDSC
.
          GOTO      CBEDG300
.
CBEDG200  WRITE     HTMLFILE;"<td>&nbsp;</td>";
.
CBEDG300  MATCH     "1",PRNTLABL
          IF        @EQUAL
            WRITE     HTMLFILE;"<td><input type=checkbox name=inplabar ":
                               "value='",AADMNO,"' ></td>";
          ENDIF
.
          IF     SJOGVIEW=ONE
            MOVE    SP70,DIM20
            MATCH     "1",PTCNWBDS
            IF        @EQUAL
              PACK      SAVKEY6,WWARD,WBED
              PACK      KEY6,PMVXPOWD,PMVXPOBD,SP70
              CALL      RDWARD1
              IF        OVRCD=1
                MOVE      "&nbsp;",WBDESC
              ELSE
               PACK    DIM20,PMVXPOWD,FRBRACK,WBDESC
               MOVE    DIM20,WBDESC
               MOVE    SP70,DIM20
              ENDIF
.
            ELSE
               MOVE    "&nbsp;",WBDESC

               MATCH   SP70,PMVXPOWD
               IF        !@EQUAL
                 MATCH   SP70,PMVXPOBD
                 IF        !@EQUAL
                   PACK    WBDESC,PMVXPOWD,FRBRACK,PMVXPOBD
                 ELSE
                   PACK    WBDESC,PMVXPOWD
                 ENDIF
               ELSE
                  MATCH   SP70,PMVXPOBD
                  IF        !@EQUAL
                    PACK      WBDESC,WBDESC,PMVXPOBD
                  ENDIF
               ENDIF
            ENDIF
.
            MATCH   SP70,PMVXIDUS
            IF      @EQUAL
              MOVE    "&nbsp;",DIM20
            ELSE
              PACK    KEY5,CATVI,PMVXIDUS
              CALL    RDCODE1
              IF      OVRCD=1
                MOVE    "&nbsp;",DIM20
              ENDIF
              MOVE    TDESC,DIM20
            ENDIF
.
            WRITE     HTMLFILE;"<td>",WBDESC,"</td>":
                               "<td>",DIM20,"</td>";
.
            MATCH     "1",PTCNWBDS
            IF      @EQUAL
              MOVE     SAVKEY6,KEY6
              CALL     RDWARD1
            ENDIF

          ENDIF

.
CBEDG900  WRITE     HTMLFILE;"</tr>"
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
CBEDG999  RETURN
+
.------------------------------------------------------------------------------
.         Get Risk icons (Patient Attributes)
.------------------------------------------------------------------------------
GETRIC00  MOVE      URNUMBER,PTATR001
          MOVE      ADMISSNO,PTATR002
          REP       "+ ",PTATR001
          REP       "+ ",PTATR002
.
          MOVE      "5",ATTYPIND       * Attribute Type 5 ('Falls Risk')
          MOVE      "1",ATCODIND       * Attribute Coded Field 1
          CALL      GETACV00           * Get Attribute Coded Field value
          MOVE      ZERO,F1
          MOVE      ATCODVAL,F1
          IF        F1=1
            WRITE     HTMLFILE;"<a title='Falls Risk'>":
                               "<img class=ListIcon src='../images/risk_f.png'":
                               " alt='Falls Risk'></a>"
          ENDIF
.
          MOVE      "6",ATTYPIND       * Attr Type 6 ('Pressure Injury Risk')
          MOVE      "1",ATCODIND       * Attribute Coded Field 1
          CALL      GETACV00           * Get Attribute Coded Field value
          MOVE      ZERO,F1
          MOVE      ATCODVAL,F1
          IF        F1=1
            WRITE     HTMLFILE;"<a title='Pressure Injury Risk'>":
                               "<img class=ListIcon src='../images/risk_p.png'":
                               " alt='Pressure Injury Risk'></a>"
          ENDIF
.
          MOVE      "7",ATTYPIND       * Attr Type 7 ('Abscond Risk')
          MOVE      "1",ATCODIND       * Attribute Coded Field 1
          CALL      GETACV00           * Get Attribute Coded Field value
          MOVE      ZERO,F1
          MOVE      ATCODVAL,F1
          IF        F1=1
            WRITE     HTMLFILE;"<a title='Abscond Risk'>":
                               "<img class=ListIcon src='../images/risk_a.png'":
                               " alt='Abscond Risk'></a>"
          ENDIF
.
          MOVE      "8",ATTYPIND       * Attr Type 8 ('Malnutrition Risk')
          MOVE      "1",ATCODIND       * Attribute Coded Field 1
          CALL      GETACV00           * Get Attribute Coded Field value
          MOVE      ZERO,F1
          MOVE      ATCODVAL,F1
          IF        F1=1
            WRITE     HTMLFILE;"<a title='Malnutrition Risk'>":
                               "<img class=ListIcon src='../images/risk_m.png'":
                               " alt='Malnutrition Risk'></a>"
          ENDIF
.
GETRIC99  RETURN
+
.------------------------------------------------------------------------------
.         Check if MH Legal status icon to be displayed
.------------------------------------------------------------------------------
CMHL0000  MATCH     SP70,SAVCLASS
          GOTO      CMHL9999 IF EQUAL         * blank ward classification
.
          PACK      KEY5,ANSC,ANSG,SAVCLASS
          CALL      RDCODE1
          BRANCH    OVRCD,CMHL9999
.
          MATCH     "M",TCINDC2
          GOTO      CMHL9999 IF NOT EQUAL
.
          REP       "+ ",URNUMBER
          PROC      CHKLEGST
          REP       " +",URNUMBER
          IF        EXIT=1
            WRITE     HTMLFILE;"<img src=../images/target1.gif":
                                   " alt='Legal Status'":
                                   " class=ListIcon onclick='MHLegStat(#"":
                                   URNUMBER,"#",#"",ADMISSNO,"#");'>"
          ENDIF
.
CMHL9999  RETURN
+
.------------------------------------------------------------------------------
.         Check if MH Legal status icon to be displayed for ward map
.------------------------------------------------------------------------------
CMHLM000  MATCH     SP70,SAVCLASS
          GOTO      CMHLM999 IF EQUAL         * blank ward classification
.
          PACK      KEY5,ANSC,ANSG,SAVCLASS
          CALL      RDCODE1
          BRANCH    OVRCD,CMHLM999
.
          MATCH     "M",TCINDC2
          GOTO      CMHLM999 IF NOT EQUAL
.
          REP       "+ ",URNUMBER
          PROC      CHKLEGST
          REP       " +",URNUMBER
          IF        EXIT=1
              WRITE     HTMLFILE;"<img src='../images/target1.gif'":
                                 "' class=ListIcon onclick=MHLegStat('":
                                 URNUMBER,"','",ADMISSNO,"')>";
          ENDIF
.
CMHLM999  RETURN
+
.------------------------------------------------------------------------------
.         Get the Nursing Station extension number (for a Nursing Station code)
.
.         Parameters:
.           NURSTCOD - Nursing Station code
.
.         Returns:
.           NURSTNUM - Nursing Station extension number
.------------------------------------------------------------------------------
WNURN000  MOVE      SP70,NURSTNUM

          MATCH     SP70,NURSTCOD         * Nursing Station code specified?
          GOTO      WNURN999 IF EQUAL
.
          PACK      KEY6,NURSTCOD,SP70    * we don't use the ward number
                                          * therefore just pack with space
          CALL      RDNURS1
          IF        OVRCD=0
            MATCH     NSTAT,NURSTCOD
            IF        @EQUAL
              MATCH     SP70,NSEXTN
              IF        !@EQUAL
                MOVE      NSEXTN,NURSTNUM
              ENDIF
            ENDIF
          ENDIF
.
WNURN999  RETURN
+
.---------------------------------------------------------------------
.      Check if this admission is currently admitted at another hospital
.---------------------------------------------------------------------
CHKMUL00  MOVE      ZERO,EXIT
          PACK      MULTHOSP,SP70
          PACK      DIM8,AURNO,SP70
          PACK      DIM3,PMVXMHOS,SP70
          PACK      SAVKEY9,ASTAT,DAADMNO,SP70
          MOVE      "2",DIM1
          PACK      KEY17,AURNO,TWO,SP70
          CALL      RSPTMI18
CHKMUL10  CALL      RKPTMI18
          BRANCH    OVRCD,CHKMUL90
.
          MATCH     AURNO,DIM8
          GOTO      CHKMUL90 IF NOT EQUAL
.
          MATCH     DIM1,DASTAT
          GOTO      CHKMUL90 IF NOT EQUAL
.
          MATCH     PMVXMHOS,DIM3
          GOTO      CHKMUL10 IF EQUAL
.
          MOVE      AURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,CHKMUL90
          CALL      RDPMPX21
.
          PACK      KEY3,PMVXMHOS
          CALL      RDPTHSP1
          IF        OVRCD<>1
            PACK      MULTHOSP,PTHSNAME,SP70
          ENDIF
          GOTO      CHKMUL99
.
CHKMUL90  MOVE      ONE,EXIT
          MATCH     "2",DIM1
          IF        @EQUAL
            MOVE      "4",DIM1
            PACK      KEY17,AURNO,FOUR,SP70
            CALL      RSPTMI18
            GOTO      CHKMUL10
          ENDIF

.
CHKMUL99  PACK      KEY9,SAVKEY9,SP70
          CALL      RDMISS2
          RETURN
+
.------------------------------------------------------------
. Heading Row
.------------------------------------------------------------
CRHDG000  BRANCH    FHIRTYPE,CRHDG999
          MOVE      NINE,CSPANUM            * Default View
.         
          IF        NOBEDWRD=1
            SUBTRACT  ONE,CSPANUM           * Remove 'bed' col for WardOnly Ward
          ENDIF
          MOVE      CSPANUM,CSPAN
          SQUEEZE   CSPAN
.
          WRITE     HTMLFILE;"<tr><td colspan=",CSPAN," align=center ":
                               "class=HeadingCell><b>",ROWHEAD,"</td></tr>"
CRHDG999  RETURN
.------------------------------------------------------------
. Current Admissions Bed Row message.
.------------------------------------------------------------
CBDMSG00  BRANCH    BEDMSGID,CBDMSG01,CBDMSG02
.
          MOVE      "LeaveCell",BDMSGCLS
          MOVE      "*** On Leave ***",BDMSGTXT
          GOTO      CBDMSG10
.
CBDMSG01  MOVE      "AvailableCell",BDMSGCLS
          MOVE      "*** Empty ***",BDMSGTXT
          GOTO      CBDMSG10
.
CBDMSG02  BRANCH    WBEDTYPE,CBDMSG99
          MOVE      "ClosedCell bgcolor=gray",BDMSGCLS
          MOVE      "*** Closed ***",BDMSGTXT
.
CBDMSG10  MATCH     SP70,PTWDCOMM
          IF        @EQUAL
            CLEAR     PTWDCOMM
            APPEND    "Bed ",PTWDCOMM
            APPEND    WBED,PTWDCOMM
            RESET     PTWDCOMM
          ENDIF
.
          WRITE     HTMLFILE;"<tr height=35 align=top>":
                             "<td align=center class=",BDMSGCLS,"":
                             " title=#"",PTWDCOMM,"#">";
          CALL      FBED0000
          WRITE     HTMLFILE;*+,BEDTEXT;
          WRITE     HTMLFILE;"</td><td align=center>",BDMSGTXT,"</td>";
.
.                                           **** Default View ****
CBDMSG20  MATCH     "1",ANAESTFL                                      *I-212073
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF

          IF        KIDSONLY=ONE
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF

          IF        KIDSVEW2 = 1
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          IF        ALTVIEW1 = 1
            WRITE     HTMLFILE;"<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>";
          ELSE
            WRITE     HTMLFILE;"<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>";
          ENDIF
.
          IF        DISPTHET = 1 
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          IF        FASTVIEW = 1
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.                                                                   * Car 235588
          IF        PTCNHDPS=ONE
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          IF        SJOGVIEW = 1
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          COMPARE   "1",BULKDSCH
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
          MATCH     "1",PRNTLABL
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
          WRITE     HTMLFILE;"</tr>";
.
CBDMSG99  RETURN
.------------------------------------------------------------
. Displays Current Patient ward/bed details (Nutrition)
.------------------------------------------------------------
CTABN000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,DLINKPRG,DIM127
          UNPACK    DIM127,D1,DLINKREP,DIM127
          UNPACK    DIM127,D1,DLINKTEM,DIM127
          UNPACK    DIM127,D1,STVVIEW,DIM127     * STV flag           Car 262343
          UNPACK    DIM127,D1,LEAVFLAG,DIM127    * On Leave Flag
.
          RESET     STVVIEW
          MATCH     STVVIEW,SP70
          IF        @EQUAL
            MOVE      ZERO,STVVIEW
          ENDIF
          MOVE      LEAVFLAG,ONLVFLAG            * Display type of onleave
.
          MOVE      ZERO,NUMOFPAT                * Number of patients in ward
.
          CALL      IBACLOCK                     * Calc expected discharge date
          PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
          MOVE      WINPUT,NOBEDWRD              * Save Ward Header WO/BO status
.
          MATCH     "1",PTCNUTOM
          IF        @EQUAL
            CALL      CHEADH00                     * Output headings (hea diet)
          ELSE
            CALL      CHEADN00                     * Output headings
          ENDIF
.
          MOVE      ONE,DIETFILT                 * Assume no filtering (1=no)
          PACK      KEY30,DIETTYPE,DIETNCDE,SP70 * Inspect filter fields
          MATCH     SP30,KEY30                   * Anything in filter fields ?
          GOTO      CTABN050 IF EQUAL            * N - bypass
          MOVE      ZERO,DIETFILT                * Y - set filtering on (0=yes)
.
. No Bed 
.
CTABN050  PACK      KEY13,WARDCODE,SP20
          MOVE      "1",FILETYPE
          CALL      RDSNOBE1
CTABN100  CALL      RDKNOBE1                * read next record
          BRANCH    OVRCD,CTABN190
          MATCH     WARDCODE,NBWARD         * same ward?
          GOTO      CTABN190 IF NOT EQUAL
          PACK      ADMISSNO,NBADMNO
          MOVE      NBROOM,WBED
          MOVE      ZERO,STBYFLAG
          MATCH     "1",PTCNUTOM
          IF        @EQUAL
            CALL      CBEDP000                * Output Row Details (hea diet)
          ELSE
            CALL      CBEDN000                * Output Row Details
          ENDIF
          GOTO      CTABN100
.
. Ward/Bed Details
.
CTABN190  PACK      KEY16,WARDCODE,SP70
          MOVE      "2",FILETYPE
          CALL      RDSWARD8
CTABN200  CALL      RDKWARD8
          BRANCH    OVRCD,CTABN290
.
          MATCH     WARDCODE,WWARD
          GOTO      CTABN290 IF NOT EQUAL
.
          MATCH     SP70,WBED
          GOTO      CTABN200 IF EQUAL
.
          BRANCH    WACTIVE,CTABN200       * Display Closed Bed Row PR 172
          CALL      CROWN000
          GOTO      CTABN200
.
CTABN250  MOVE      "2",BEDMSGID
          CALL      CBDMSN00
          GOTO      CTABN200
.
. On Leave Patients
.------------------
CTABN290  BRANCH    WBEDTYPE,CTABN300,CTABN999
. 
CTABN300  MOVE      ONE,FIRSTONL
          MOVE      "3",FILETYPE
          PACK      KEY14,WARDCODE,SP70
          CALL      RDSONLV1
CTABN800  CALL      RDKONLV1
          BRANCH    OVRCD,CTABN999
          MATCH     OWARD,WARDCODE
          GOTO      CTABN999 IF NOT EQUAL
          MATCH     ZEROVISN,OADMNO
          GOTO      CTABN800 IF EQUAL
          IF        FIRSTONL=1
            MOVE      ZERO,FIRSTONL
            MOVE      "Patients On Leave",ROWHEAD
            CALL      CRHDN000       * Output Heading Row for On-Leave
          ENDIF
          PACK      ADMISSNO,OADMNO
          MOVE      OBED,WBED 
          MOVE      ZERO,STBYFLAG
.
          MOVE      ZERO,CLOSEFLG                * Reset 'Closed Bed' flag
          PACK      KEY6,WARDCODE,WBED,SP70      * Read Ward/Bed file
          CALL      RDWARD1
          BRANCH    OVRCD,CTABN850
          MOVE      PTWDBDST,CLOSEFLG            * Set 'Closed Bed' flag
.
CTABN850  MATCH     "1",PTCNUTOM
          IF        @EQUAL
            CALL      CBEDP000                * Output Row Details (hea diet)
          ELSE
            CALL      CBEDN000                * Output Row Details
          ENDIF
.
          GOTO      CTABN800
.
CTABN999  RETURN
.------------------------------------------------------------
. Current Admissions - Nutrition View - output heading row.
.------------------------------------------------------------
CHEADN00  IF        NOBEDWRD<>1
            WRITE     HTMLFILE;"<td class=HeadingCell ":
                                   "align=center>Bed</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td class=HeadingCell>Patient</td>";
.
          BRANCH    KIDSONLY,CHEADN50
.
.
.                                                * St. Vincents (standard)
          IF        SJOGVIEW=1
            WRITE     HTMLFILE;"<td class=HeadingCell>Admission Diet</td>":
                               "<td class=HeadingCell>Food Allergy</td>":
                               "<td class=HeadingCell>Ward Diet</td>";
          ELSE
            MATCH     "0",STVVIEW
            IF        @EQUAL
              WRITE     HTMLFILE;"<td class=HeadingCell>Alerts</td>";
            ENDIF
.
            WRITE     HTMLFILE;"<td class=HeadingCell>Diet</td>";
.                                              * Stv Specific Heading Car 262343
            MATCH     "1",STVVIEW
            IF        @EQUAL
              WRITE     HTMLFILE;"<td class=HeadingCell>Feeding Assistance</td>";
            ELSE
              WRITE     HTMLFILE;"<td class=HeadingCell>Fasting</td>";
            ENDIF
.
            WRITE     HTMLFILE;"<td class=HeadingCell>BMI</td>";
            IF        HEAVIEW=1
              WRITE     HTMLFILE;"<td class=HeadingCell>Supplements</td>";
            ELSE
              WRITE     HTMLFILE;"<td class=HeadingCell>Diet Type</td>";
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"<td class=HeadingCell width=#"180#">Comment</td>":
                             "<td class=HeadingCell>Menu/<br>":
                                                   "Assistance<br></td>";
          MATCH     "1",PWDVTYPE
          IF        @EQUAL
            WRITE     HTMLFILE;"<td class=HeadingCell>Post Op Ward";
          ELSE
            WRITE     HTMLFILE;"<td class=HeadingCell>Dietitian Name<br>":
                                                     "& Pager no.";
          ENDIF
.
          WRITE     HTMLFILE;"<td class=HeadingCell>Last Update<br>":
                                                   "Date Time</td>":
                             "<td class=HeadingCell>Adm.Date Time<br>":
                                                   "Exp.Discharge</td>";
          WRITE     HTMLFILE;"</tr>";
          GOTO      CHEADN99
.
.                                                * RCH (kids) 
CHEADN50  WRITE     HTMLFILE;"<td class=HeadingCell align=center>U/R</td>":
                             "<td class=HeadingCell>Patient Condition</td>":
                             "<td class=HeadingCell>Diet</td>":
                             "<td class=HeadingCell>Fasting</td>":
                             "<td class=HeadingCell>Diet Type</td>":
                             "<td class=HeadingCell>Other Diet<br>Details</td>":
                             "<td class=HeadingCell>Comment</td>":
                             "<td class=HeadingCell>Unit</td>":
                             "<td class=HeadingCell>Unit<br> Doctor</td>":
                             "<td class=HeadingCell>Adm.Date Time<br>":
                                                   "Exp.Discharge</td>":
                             "</tr>";
CHEADN99  RETURN
+
.------------------------------------------------------------
. Current Admissions - Nutrition View - output heading row. (hea - ptcnutom=1)
.------------------------------------------------------------
CHEADH00  IF        NOBEDWRD<>1
            WRITE     HTMLFILE;"<td class=HeadingCell ":
                                   "align=center>Bed</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td class=HeadingCell>Patient</td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell>Alerts</td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell>BMI</td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell>Fasting</td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell>Breakfast Diet</td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell>Lunch Diet</td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell>Dinner Diet</td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell>Supplements</td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell width=#"180#">Comment</td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell>Menu/<br>":
                                                   "Assistance<br></td>";
          MATCH     "1",PWDVTYPE
          IF        @EQUAL
            WRITE     HTMLFILE;"<td class=HeadingCell>Post Op Ward</td>";
          ELSE
            WRITE     HTMLFILE;"<td class=HeadingCell>Dietitian Name<br>":
                                                     "& Pager no.</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td class=HeadingCell>Adm.Date Time<br>":
                                                   "Exp.Discharge<br>":
                                                   "Last Update Time</td>";
          WRITE     HTMLFILE;"</tr>";
.
CHEADH99  RETURN
+
.------------------------------------------------------------
. Output Ward/Bed Row (Nutrition)
.------------------------------------------------------------
CROWN000  MATCH     ZEROVISN,WADMNO
          GOTO      CROWN800 IF EQUAL
.
. WBEDTYPE 0= All,1 = OPEN (INGNORE),2 = Empty 
.
          BRANCH    WBEDTYPE,CROWN100,CROWN999
.
CROWN100  PACK      ADMISSNO,WADMNO
          MOVE      ZERO,STBYFLAG
          MOVE      PTWDBDST,CLOSEFLG                                 *I-273956
          MATCH     "1",PTCNUTOM
          IF        @EQUAL
            CALL      CBEDP000                * Output Row Details (hea diet)
          ELSE
            CALL      CBEDN000                * Output Row Details
          ENDIF
          ADD       ONE,NUMOFPAT     * count number of patients in ward
.
          MATCH     ZEROVISN,WSTBY
          GOTO      CROWN999 IF EQUAL
.
          PACK      ADMISSNO,WSTBY
          MOVE      ONE,STBYFLAG
          MATCH     "1",PTCNUTOM
          IF        @EQUAL
            CALL      CBEDP000                * Output Row Details (hea diet)
          ELSE
            CALL      CBEDN000                * Output Row Details
          ENDIF
          ADD       ONE,NUMOFPAT     * count number of patients in ward
.
          GOTO      CROWN999
.
CROWN800  MATCH     "1",PTWDBDST     * Is this bed closed?
          IF        @EQUAL
            MOVE      TWO,BEDMSGID   * Yes, bed is closed
            GOTO      CROWN850
          ELSE
            MOVE      ONE,BEDMSGID   * Assume Empty Bed
          ENDIF
.
          PACK      KEY14,WWARD,WBED,SP70
          CALL      RDSONLV1
CROWN810  CALL      RDKONLV1         * Try to find correct Ward/Bed
          BRANCH    OVRCD,CROWN850
          MATCH     OWARD,WWARD
          GOTO      CROWN850 IF NOT EQUAL
          MATCH     OBED,WBED
          GOTO      CROWN850 IF NOT EQUAL
          MOVE      ZERO,BEDMSGID     * Bed has patient on leave
.
CROWN850  CALL      CBDMSN00
.
CROWN999  RETURN
.------------------------------------------------------------
. Current Admissions Patient Details (Nutrition)
.------------------------------------------------------------
CBEDN000  CALL      GETPAT00 
          CALL      PATLN000
          CALL      PATFLD00                * Use standard Patient Folder sub
          MOVE      KEY3,FOLDERSF           * and store suffix
          CALL      GTDIET00
          MOVE      ADOCTA,DOCTCODE
          REP       " +",ADMISSNO
          REP       " +",URNUMBER 
.                                           * Perform filtering if applicable
          BRANCH    DIETFILT,CBEDN400       * 1=no filtering
          MATCH     SP30,DIETTYPE           *   Diet Type filtering requested ?
          GOTO      CBEDN300 IF EQUAL       *   N - bypass (try Nutritionist)
          IF        EXTRDIET=1
            MATCH     DIETTYPE,ADIET          *   Y - correct diet type
          ELSE
            MATCH     DIETTYPE,PMNUDTYP       *   Y - correct diet type
          ENDIF
          GOTO      CBEDN900 IF NOT EQUAL   *       N - ignore this record
.
CBEDN300  MATCH     SP30,DIETNCDE           *   Nutritionist filtering reqstd ?
          GOTO      CBEDN400 IF EQUAL       *   N - bypass (process the row)  
          MATCH     DIETNCDE,PMNUDCDE       *   Y - correct doctor name ?
          GOTO      CBEDN900 IF NOT EQUAL   *       N - ignore this record
.
CBEDN400  WRITE     HTMLFILE;"<tr height=35>"
.
          IF        NOBEDWRD=1
            GOTO      CBEDN500                * Bypass bed col for Wardonly Ward
          ENDIF
.
          BRANCH    FILETYPE,CBEDN410,CBEDN420,CBEDN430
.
CBEDN410  WRITE     HTMLFILE;"<td align=center class=UnallocatedCell>":
                             "<img src=#"../images/EditIcon.gif#"":
                             " class=ListIcon onclick='BedAllocation(#"":
                             URNUMBER,"#",#"",ADMISSNO,"#");'>":
                             "</td>"
          GOTO      CBEDN500
.
CBEDN420  IF        STBYFLAG=0
            MATCH     "1",CLOSEFLG     * Is this Bed Closed?
            IF        @EQUAL
              WRITE     HTMLFILE;"<td align=center class=ClosedCell ":
                                 "title=#"",PTWDCOMM,"#" ":
                                 "bgcolor=gray>";
            ELSE
              WRITE     HTMLFILE;"<td align=center ":
                                 "title=#"",PTWDCOMM,"#">";
            ENDIF
          ELSE
            WRITE     HTMLFILE;"<td align=center class=StandbyCell>";
          ENDIF
.
          CALL      FBED0000       
          WRITE     HTMLFILE;*+,BEDTEXT,"&nbsp;</td>"
          GOTO      CBEDN500
.
CBEDN430  MATCH     "1",CLOSEFLG     * Is this Bed Closed?
          IF        @EQUAL
            WRITE     HTMLFILE;"<td align=center class=ClosedCell ":
                               "title=#"",PTWDCOMM,"#" ":
                               "bgcolor=gray>";
          ELSE
            WRITE     HTMLFILE;"<td align=center class=LeaveCell>";
          ENDIF
.
          CALL      FBED0000       
          WRITE     HTMLFILE;*+,BEDTEXT,"&nbsp;</td>"
.
CBEDN500  WRITE     HTMLFILE;"<td nowrap>":
                             "<img src=../images/PatientFolder",FOLDERSF,".gif":
                             " class=ListIcon ":
                             " onclick='location.href=#"",LINKPRG,".pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO,"#";'>";
.
          COMPARE   ONE,ONLVFLAG
          GOTO      CBEDN520 IF NOT EQUAL
          COMPARE   THREE,FILETYPE
          GOTO      CBEDN520 IF NOT EQUAL
.
          MATCH     "1",PTCNHLEA             * Check Parameter Disp.On Leave
          GOTO      CBEDN520 IF NOT EQUAL
.
          MOVE      ADMISSNO,KEY8
          REP       "+ ",KEY8
          SQUEEZE   KEY8
          MOVE      KEY8,PVIBILL
          PROC      TLEA0000
.
          MOVE      "TL",CATEGORY            * Output Type of Leave
          CALL      GETCOD00
          MOVE      "On Leave - ",KEY11
          PACK      KEY31,KEY11,TDESC,SP70
          WRITE     HTMLFILE;FORMATNM,"<br>",KEY31,"</td>";
          GOTO      CBEDN540
.
CBEDN520  WRITE     HTMLFILE;FORMATNM,"</td>";
.
CBEDN540  IF        KIDSONLY=ONE
            REP       "+ ",URNUMBER
            WRITE     HTMLFILE;"<td nowrap align=center>":
                                    URNUMBER,NBSP,"</td>";
            REP       " +",URNUMBER
          ENDIF
.
CBEDN575  IF        HEAVIEW=1
            CALL      H6ALR000             * Get H6 alert Code description
          ENDIF
.
          CALL      GETCON00               * Get Patient Condition Details
          MOVE      "DC",CATEGORY
          MOVE      ADIET,CODE
          CALL      GETCOD00
.
          MATCH     SP70,CONDESC
          IF        !@EQUAL
            UNPACK    LPCDATE,CCENT,CYEAR,CMON,CDAY
            PACK      DISPDATE,LBRACKT,CDAY,SLASH,CMON,SP1,LPCTIME,RBRACKT 
          ELSE
            CLEAR     DISPDATE
          ENDIF
.
          BRANCH    KIDSONLY,CBEDN650
.
          CALL      CBDNSV00                   * St Vincent's specifics (stnd)
          GOTO      CBEDN700
.
CBEDN650  CALL      CBDNRC00                   * Royal Children's (kids)
.
CBEDN700  MOVE      SP70,TDESC
          REP       "+ ",ADMISSNO
          PACK      KEY30,ADMISSNO,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          IF        OVRCD = 0
            MATCH     ADMISSNO,DTADMN
            IF        @EQUAL
              MOVE      "AC",CATEGORY
              MOVE      TDEPT,CODE
              CALL      GETCOD00
             ENDIF
          ENDIF
          REP       " +",ADMISSNO
.
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
.                                                * no doctor col for St.V's
          IF        KIDSONLY=ONE 
            WRITE     HTMLFILE;"<td nowrap>",TDESC,NBSP,"</td>":
                               "<td><a href='":
                               "javascript:DoctorViewFrame(#"",DOCTCODE,"#")'>":
                                SDOCFNAM,NBSP,"</a></td>";
          ENDIF
.
CBEDN850  WRITE     HTMLFILE;"<td nowrap class=",COLRFLAG,">":
                                 DISPDATE,ATIME,"<br>":
                                 EXPCTDSC,"</td>";
          WRITE     HTMLFILE;"</tr>"
CBEDN900  REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
CBEDN999  RETURN
+
.------------------------------------------------------------
. Current Admissions Patient Details (Nutrition) hea diet (ptcnutom=1)
.------------------------------------------------------------
CBEDP000  CALL      GETPAT00
          CALL      PATLN000
          CALL      PATFLD00                * Use standard Patient Folder sub
          MOVE      KEY3,FOLDERSF           * and store suffix
          CALL      GTDIET00
          MOVE      ADOCTA,DOCTCODE
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
.                                           * Perform filtering if applicable
          BRANCH    DIETFILT,CBEDP400       * 1=no filtering
          MATCH     SP30,DIETTYPE           *   Diet Type filtering requested ?
          GOTO      CBEDP300 IF EQUAL       *   N - bypass (try Nutritionist)
          IF        EXTRDIET=1
            MATCH     DIETTYPE,ADIET          *   Y - correct diet type
          ELSE
            MATCH     DIETTYPE,PMNUDTYP       *   Y - correct diet type
          ENDIF
          GOTO      CBEDP900 IF NOT EQUAL   *       N - ignore this record
.
CBEDP300  MATCH     SP30,DIETNCDE           *   Nutritionist filtering reqstd ?
          GOTO      CBEDP400 IF EQUAL       *   N - bypass (process the row)
          MATCH     DIETNCDE,PMNUDCDE       *   Y - correct doctor name ?
          GOTO      CBEDP900 IF NOT EQUAL   *       N - ignore this record
.
CBEDP400  WRITE     HTMLFILE;"<tr height=35>"
.
          IF        NOBEDWRD=1
            GOTO      CBEDP500                * Bypass bed col for Wardonly Ward
          ENDIF
.
          BRANCH    FILETYPE,CBEDP410,CBEDP420,CBEDP430
.
CBEDP410  WRITE     HTMLFILE;"<td align=center class=UnallocatedCell>":
                             "<img src=#"../images/EditIcon.gif#"":
                             " class=ListIcon onclick='BedAllocation(#"":
                             URNUMBER,"#",#"",ADMISSNO,"#");'>":
                             "</td>"
          GOTO      CBEDP500
.
CBEDP420  IF        STBYFLAG=0
            MATCH     "1",CLOSEFLG     * Is this Bed Closed?
            IF        @EQUAL
              WRITE     HTMLFILE;"<td align=center class=ClosedCell ":
                                 "title=#"",PTWDCOMM,"#" ":
                                 "bgcolor=gray>";
            ELSE
              WRITE     HTMLFILE;"<td align=center ":
                                 "title=#"",PTWDCOMM,"#">";
            ENDIF
          ELSE
            WRITE     HTMLFILE;"<td align=center class=StandbyCell>";
          ENDIF
.
          CALL      FBED0000
          WRITE     HTMLFILE;*+,BEDTEXT,"&nbsp;</td>"
          GOTO      CBEDP500
.
CBEDP430  MATCH     "1",CLOSEFLG     * Is this Bed Closed?
          IF        @EQUAL
            WRITE     HTMLFILE;"<td align=center class=ClosedCell ":
                               "title=#"",PTWDCOMM,"#" ":
                               "bgcolor=gray>";
          ELSE
            WRITE     HTMLFILE;"<td align=center class=LeaveCell>";
          ENDIF
.
          CALL      FBED0000
          WRITE     HTMLFILE;*+,BEDTEXT,"&nbsp;</td>"
.
CBEDP500  WRITE     HTMLFILE;"<td nowrap>":
                             "<img src=../images/PatientFolder",FOLDERSF,".gif":
                             " class=ListIcon ":
                             " onclick='location.href=#"",LINKPRG,".pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO,"#";'>";
.
          COMPARE   ONE,ONLVFLAG
          GOTO      CBEDP520 IF NOT EQUAL
          COMPARE   THREE,FILETYPE
          GOTO      CBEDP520 IF NOT EQUAL
.
          MATCH     "1",PTCNHLEA             * Check Parameter Disp.On Leave
          GOTO      CBEDP520 IF NOT EQUAL
.
          MOVE      ADMISSNO,KEY8
          REP       "+ ",KEY8
          SQUEEZE   KEY8
          MOVE      KEY8,PVIBILL
          PROC      TLEA0000
.
          MOVE      "TL",CATEGORY            * Output Type of Leave
          CALL      GETCOD00
          MOVE      "On Leave - ",KEY11
          PACK      KEY31,KEY11,TDESC,SP70
          WRITE     HTMLFILE;FORMATNM,"<br>",KEY31,"</td>";
          GOTO      CBEDP540
.
CBEDP520  WRITE     HTMLFILE;FORMATNM,"</td>";
.
CBEDP540
.
CBEDP575  IF        HEAVIEW=1
            CALL      H6ALR000             * Get H6 alert Code description
          ENDIF
.
          CALL      GETCON00               * Get Patient Condition Details
          MOVE      "DC",CATEGORY
          MOVE      ADIET,CODE
          CALL      GETCOD00
.
          MATCH     SP70,CONDESC
          IF        !@EQUAL
            UNPACK    LPCDATE,CCENT,CYEAR,CMON,CDAY
            PACK      DISPDATE,LBRACKT,CDAY,SLASH,CMON,SP1,LPCTIME,RBRACKT
          ELSE
            CLEAR     DISPDATE
          ENDIF
.
          CALL      CBDHEA00                   * HEA Extra Diet (ptcnutom=1)
.
CBEDP700  MOVE      SP70,TDESC
          REP       "+ ",ADMISSNO
          PACK      KEY30,ADMISSNO,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          IF        OVRCD = 0
            MATCH     ADMISSNO,DTADMN
            IF        @EQUAL
              MOVE      "AC",CATEGORY
              MOVE      TDEPT,CODE
              CALL      GETCOD00
             ENDIF
          ENDIF
          REP       " +",ADMISSNO
.
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
CBEDP850  WRITE     HTMLFILE;"<td nowrap class=",COLRFLAG,">":
                                 DISPDATE,ATIME,"<br>":
                                 EXPCTDSC,"<br>":
                                 DISPLUPD,DISPLUTM,"</td>";
          WRITE     HTMLFILE;"</tr>"
CBEDP900  REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
CBEDP999  RETURN
+
.---------------------------------------------------------------------
.         Output Patient Alert icons
.---------------------------------------------------------------------
ALERTI00  MOVE      ZERO,EXIT
          PROC      DISPALRT                * check for Disability Alerts
          IF        EXIT=0 | EXIT=2
            MATCH     "1",PMPXSIN7
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIconM.gif'":
                                 " alt='Medical Alerts'":
                                 " class=ListIcon onclick=PatientAlerts('":
                                 URNUMBER,"','",ADMISSNO,"')>";
            ENDIF
.
            MATCH     "1",PMPXSIN8
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIconB.gif'":
                                 " alt='Micro Alerts'":
                                 " class=ListIcon onclick=PatientAlerts('":
                                 URNUMBER,"','",ADMISSNO,"')>";
            ENDIF
.
            MATCH     "1",PMPXSIN9
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIconR.gif'":
                                 " alt='Risk Alerts'":
                                 " class=ListIcon onclick=PatientAlerts('":
                                 URNUMBER,"','",ADMISSNO,"')>";
            ENDIF
.
            MATCH     "1",PMPXSN11
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIconC.gif'":
                                 " alt='Chronic Alerts'":
                                 " class=ListIcon onclick=PatientAlerts('":
                                 URNUMBER,"','",ADMISSNO,"')>";
            ENDIF
.
            MATCH     "1",PTMXSIN1
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIcon.gif'":
                                 " alt='Alerts'":
                                 " class=ListIcon onclick='PatientAlerts(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#");'>"
              GOTO      ALERTI90
            ENDIF
.
            MATCH     "2",PTMXSIN1
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIconBlack.gif'":
                                 " alt='Alerts'":
                                 " class=ListIcon onclick='PatientAlerts(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#");'>"
              GOTO      ALERTI90
            ENDIF
.
            MATCH     "3",PTMXSIN1
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIconDelete.gif'":
                                 " alt='Alerts'":
                                 " class=ListIcon onclick='PatientAlerts(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#");'>"
              GOTO      ALERTI90
            ENDIF
.
            MATCH     SP70,PTMXSIN1
            IF        !@EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIcon":
                                 PTMXSIN1,".gif'":
                                 " alt='Alerts'":
                                 " class=ListIcon onclick='PatientAlerts(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#");'>"
            ENDIF
          ENDIF
.
ALERTI90  IF        EXIT=1 | EXIT=2
            WRITE     HTMLFILE;"<img src='../images/AlertIconDIS.gif'":
                               " alt='Disability Alerts'":
                               " class=ListIcon onclick='PatientAlerts(#"":
                               URNUMBER,"#",#"",ADMISSNO,"#");'>"
          ENDIF
.
          IF        DISPDNAM=1
            REP       "+ ",ADMISSNO
            REP       "+ ",URNUMBER
            CALL      CHKD0000           * Duplicate Surnames?
            IF        DUPNMFLG=1
              WRITE     HTMLFILE;"<img src='../images/samename.gif'":
                                 " alt='Patient Name Conflict'":
                                 " class=ListIcon>";
            ENDIF
            REP       " +",ADMISSNO
            REP       " +",URNUMBER
          ENDIF
.
ALERTI99  RETURN
+
.------------------------------------------------------------------------------
.         Checks to see if there are other patients with the same Surname
.         in the same hospital/ward as us; using Current Patient Location
.         table (pmscuraf).
.------------------------------------------------------------------------------
CHKD0000  BRANCH    IBCNMHOS,CHKD3000
.
          PACK      KEY96,PTMASNAM,SP70,SP70
          CALL      RSPMCUR2
CHKD1000  CALL      RKPMCUR2
          BRANCH    OVRCD,CHKD9000
.
          MATCH     PTMASNAM,PMCUSURN       * same surname ?
          GOTO      CHKD9000 IF NOT EQUAL   * no; we're finished here
.
          MATCH     "0       ",PMCUURNO
          GOTO      CHKD1200 IF EQUAL
.
          MATCH     URNUMBER,PMCUURNO       * same UR as ours ?
          GOTO      CHKD1000 IF EQUAL       * yes; skip
.
CHKD1200  MATCH     ADMISSNO,PMCUVISN       * same admission no. as ours ?
          GOTO      CHKD1000 IF EQUAL       * yes; skip
.
          PACK      KEY30,PMCUVISN,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,CHKD1000
.
          MATCH     PMCUVISN,DTADMN
          GOTO      CHKD1000 IF NOT EQUAL
.
.  Task  0840055 - only show conflict if currently admitted
.
          MATCH     ANSD,TMOVE
          GOTO      CHKD1000 IF EQUAL
.
          MATCH     ANSL,TMOVE
          GOTO      CHKD1000 IF EQUAL
.
          MATCH     WARDCODE,TWARD          * same ward ?
          GOTO      CHKD1000 IF NOT EQUAL
.
          MATCH     PTMASNAM,PMCUSURN       * same surname ?
          GOTO      CHKD9100 IF EQUAL
.
          GOTO      CHKD9000
.
.
.         Multi Hospital...
.
CHKD3000  PACK      KEY99,PTWDHOSN,PTMASNAM,SP70,SP70
          CALL      RSPMCUR6
CHKD3100  CALL      RKPMCUR6
          BRANCH    OVRCD,CHKD9000
.
          MATCH     PTWDHOSN,PMCUHOSP       * same hospital ?
          GOTO      CHKD9000 IF NOT EQUAL   * no; we're finished here
.
          MATCH     PTMASNAM,PMCUSURN       * same surname ?
          GOTO      CHKD9000 IF NOT EQUAL   * no; we're finished here
.
          MATCH     "0       ",PMCUURNO
          GOTO      CHKD3200 IF EQUAL
.
          MATCH     URNUMBER,PMCUURNO       * same UR as ours ?
          GOTO      CHKD3100 IF EQUAL       * yes; skip
.
CHKD3200  MATCH     ADMISSNO,PMCUVISN       * same admission no. as ours ?
          GOTO      CHKD3100 IF EQUAL       * yes; skip
.
          PACK      KEY30,PMCUVISN,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,CHKD3100
.
          MATCH     PMCUVISN,DTADMN
          GOTO      CHKD3100 IF NOT EQUAL
.
.  Task  0840055 - only show conflict if currently admitted
.
          MATCH     ANSD,TMOVE
          GOTO      CHKD3100 IF EQUAL
.
          MATCH     ANSL,TMOVE
          GOTO      CHKD3100 IF EQUAL
.
          MATCH     WARDCODE,TWARD          * same ward ?
          GOTO      CHKD3100 IF NOT EQUAL
.
          MATCH     PTMASNAM,PMCUSURN       * same surname ?
          GOTO      CHKD9100 IF EQUAL
.
          GOTO      CHKD9000
.
CHKD9000  MOVE      ZERO,DUPNMFLG
          GOTO      CHKD9999
.
CHKD9100  MOVE      ONE,DUPNMFLG
          GOTO      CHKD9999
.
CHKD9999  RETURN
+
.------------------------------------------------------------------------------
. Check if MH Legal status icon to be displayed
.------------------------------------------------------------------------------
CHKLST00  MOVE      "0",LSFLAG
          MATCH     SP70,SAVCLASS
          GOTO      CHKLST99 IF EQUAL   
.
CHKLST20  PACK      KEY5,ANSC,ANSG,SAVCLASS
          CALL      RDCODE1
          BRANCH    OVRCD,CHKLST99
.
          MATCH     "M",TCINDC2
          GOTO      CHKLST99 IF NOT EQUAL
.
          REP       "+ ",URNUMBER
          PROC      CHKLEGST
          REP       " +",URNUMBER
CHKLST80  IF        EXIT=1
            MOVE      "1",LSFLAG
          ENDIF
.
CHKLST99  RETURN
.
.---------------------------------------------------------------------
.         Output Row details (Nutrition) specific St. Vincents (stnd)      
.---------------------------------------------------------------------
CBDNSV00  MATCH     "0",STVVIEW
          IF        @EQUAL
            IF        SJOGVIEW<>1
              WRITE     HTMLFILE;"<td>&nbsp;";
              CALL      ALERTI00
              IF        HEAVIEW=1
                CALL      DALR0000             * Display alerts
              ENDIF
              WRITE     HTMLFILE;"</td>";
            ENDIF
          ENDIF
          WRITE     HTMLFILE;"<td><table><tr><td>":
                             "<img src=../images/DietIcon.gif ":
                             " class=ListIcon onclick='UpdateNutrition(#"":
                             URNUMBER,"#",#"",ADMISSNO,"#")'></td>";
.
          IF        HEAVIEW=1
            MOVE      "DC",CATEGORY
            MATCH     SP70,PMNUDIET
            IF        !@EQUAL
              MOVE      PMNUDIET,CODE
            ELSE
              MOVE      ADIET,CODE
            ENDIF
            CALL      GETCOD00
            WRITE     HTMLFILE;"<td>",TDESC;
            CALL      DDIET000            * Healthscope Diet column
          ELSE
            MOVE      "DC",CATEGORY
            MOVE      ADIET,CODE
            CALL      GETCOD00
            WRITE     HTMLFILE;"<td>",TDESC;
          ENDIF
.
          COMPARE   ONE,DISPUDF4          * don't display pmvxudf4 (CAR 305129)
          GOTO      CBDNSV05 IF EQUAL
.
          MATCH     "2",STVVIEW
          IF        @EQUAL
            WRITE     HTMLFILE;"&nbsp;";
          ELSE
            WRITE     HTMLFILE;"<br>",PMVXUDF4;
          ENDIF
.
CBDNSV05  WRITE     HTMLFILE;"</td></tr></table></td>";
.
          IF        SJOGVIEW<>1
            GOTO      CBDNSV20
          ENDIF
.
          MATCH     "1",PTCNDFAL            * Display Food Allergy
          IF        !@EQUAL
            MATCH     SP70,PTMIUSR9
            IF        @EQUAL
              WRITE     HTMLFILE;"<td>&nbsp;";
            ELSE
              PACK      KEY5,ANSU,NINE,PTMIUSR9,SP70
              CALL      RDCODE1
              IF        OVRCD<>1
                WRITE     HTMLFILE;"<td>",TDESC;
              ELSE
                WRITE     HTMLFILE;"<td>&nbsp;";
              ENDIF
            ENDIF
            GOTO    CBDNSV16
          ENDIF
.
          WRITE     HTMLFILE;"<td>";
          REPLACE   "+ ",URNUMBER
          PACK      KEY16,URNUMBER,CATH3,SP70
          CALL      RSPTALR1
CBDNSV10  CALL      RKPTALR1                * Check if any H3 Alerts Exist?
          IF        OVRCD=1
            WRITE     HTMLFILE;"&nbsp;&nbsp;&nbsp; ";
            GOTO      CBDNSV15
          ENDIF
.
          MATCH     URNUMBER,PTALURNO
          GOTO      CBDNSV15 IF NOT EQUAL
.
          MATCH     CATH3,PTALCATG
          GOTO      CBDNSV15 IF NOT EQUAL
.
          WRITE     HTMLFILE;"Yes"; 
.
CBDNSV15  MATCH     SP70,PTMIUSR9
          IF        !@EQUAL
            PACK      KEY5,ANSU,NINE,PTMIUSR9,SP70  * Food Allergy flag at patient level?
            CALL      RDCODE1
            IF        OVRCD<>1
              WRITE     HTMLFILE;" (",TDESC,")";
            ELSE
              WRITE     HTMLFILE;" (Unknown)";
            ENDIF
          ELSE
            WRITE     HTMLFILE;" (Unknown)";
          ENDIF
.
          REPLACE   " +",URNUMBER
.
CBDNSV16  CALL      ALERTI00
          WRITE     HTMLFILE;"</td>";
          GOTO      CBDNSV25
.
CBDNSV20  WRITE     HTMLFILE;"<td>",DTFASTNG,"</td>";
CBDNSV25  IF        SJOGVIEW<>1
            REP       "+ ",URNUMBER
            REP       "+ ",ADMISSNO
            CALL      PATATR00
.
            MATCH     SP70,PTARVAL3
            IF        @EQUAL
              CALL      CLCBMI00
            ELSE
              PACK      BODMASIN,PTARVAL3,SP70
            ENDIF
.
            CALL      RNGBMI00
            WRITE     HTMLFILE;"<td>";
            WRITE     HTMLFILE;"<img src=#"../images/MaintenanceIcon.gif#"":
                               " class=ListIcon onclick='PatientAttribute(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#");'>";
            WRITE     HTMLFILE;BODMASRN,"</td>";
            REP       " +",URNUMBER
            REP       " +",ADMISSNO
          ENDIF
.
          IF        HEAVIEW=1
            CALL      DSUP0000             * HEA - Display Supplements
            GOTO      CBDNSV26
          ENDIF
.
          IF        EXTRDIET=1
            MOVE      "MJ",CATEGORY
            MOVE      PMNUML01,CODE
            CALL      GETCOD00
            MOVE      TDESC,DIETDSC2
.
            MOVE      "MJ",CATEGORY
            MOVE      PMNUML03,CODE
            CALL      GETCOD00
            MOVE      TDESC,DIETDSC3
.
            MOVE      "MJ",CATEGORY
            MOVE      PMNUML05,CODE
            CALL      GETCOD00
            MOVE      TDESC,DIETDSC4
.
            MOVE      "MJ",CATEGORY
            MOVE      PMNUML07,CODE
            CALL      GETCOD00
            MOVE      TDESC,DIETDSC5
.
            WRITE     HTMLFILE;"<td>",DIETDSC2,"<br>":
                                 DIETDSC3,"<br>":
                                 DIETDSC4,"<br>":
                                 DIETDSC5,"</td>";
          ELSE
            WRITE     HTMLFILE;"<td>",DTDTTYPE,"</td>";
          ENDIF
.
CBDNSV26  WRITE     HTMLFILE;"<td>";
.
.         * removed the following two lines for 0321554
.         MATCH     "1",STVVIEW
.         GOTO      CBDNSV28 IF EQUAL
.
          MATCH     SP70,PMNUCOM5
          IF        !@EQUAL
            WRITE     HTMLFILE;PMNUCOM1;
            WRITE     HTMLFILE;"<br>",PMNUCOM2;
            WRITE     HTMLFILE;"<br>",PMNUCOM3;
            WRITE     HTMLFILE;"<br>",PMNUCOM4;
            WRITE     HTMLFILE;"<br>",PMNUCOM5;
            GOTO      CBDNSV29
          ENDIF
.
          MATCH     SP70,PMNUCOM4
          IF        !@EQUAL
            WRITE     HTMLFILE;PMNUCOM1;
            WRITE     HTMLFILE;"<br>",PMNUCOM2;
            WRITE     HTMLFILE;"<br>",PMNUCOM3;
            WRITE     HTMLFILE;"<br>",PMNUCOM4;
            GOTO      CBDNSV29
          ENDIF
.
          MATCH     SP70,PMNUCOM3
          IF        !@EQUAL
            WRITE     HTMLFILE;PMNUCOM1;
            WRITE     HTMLFILE;"<br>",PMNUCOM2;
            WRITE     HTMLFILE;"<br>",PMNUCOM3;
            GOTO      CBDNSV29
          ENDIF
.
          MATCH     SP70,PMNUCOM2
          IF        !@EQUAL
            WRITE     HTMLFILE;PMNUCOM1;
            WRITE     HTMLFILE;"<br>",PMNUCOM2;
            GOTO      CBDNSV29
          ENDIF
.
CBDNSV28  MATCH     SP70,PMNUCOM1
          IF        @EQUAL
            WRITE     HTMLFILE;NBSP;
          ELSE
            WRITE     HTMLFILE;PMNUCOM1;
          ENDIF
.
CBDNSV29  WRITE     HTMLFILE;"</td>";
.
CBDNSV30  WRITE     HTMLFILE;"<td>",DTASSLEV,"</td>";
.
          MOVE      SP70,KEY30
          MATCH     "1",PWDVTYPE
          IF        @EQUAL
            PACK      KEY30,PMVXPOWD,PMVXPOBD
            MATCH     SP70,KEY30
            GOTO      CBDNSV32 IF NOT EQUAL
            WRITE     HTMLFILE;"<td>",NBSP,"</td>";
            GOTO      CBDNSV40
CBDNSV32    PACK      KEY30,PMVXPOWD,NBSP,SLASH,NBSP,PMVXPOBD
            WRITE     HTMLFILE;"<td nowrap>",KEY30,"</td>";
          ELSE
            PACK      KEY30,PMNUDCDE,PMNUPAGN
            MATCH     KEY30,SP70
            GOTO      CBDNSV35 IF NOT EQUAL
            WRITE     HTMLFILE;"<td>",NBSP,"</td>";
            GOTO      CBDNSV40
CBDNSV35    WRITE     HTMLFILE;"<td nowrap>":
                               "<a href='javascript:HCPViewFrame(#"":
                               PMNUDCDE,"#")'>",DTDTNNAM,"</a>":
                               "<br>",PMNUPAGN,"</td>";
          ENDIF
.
CBDNSV40  MATCH     SP70,PMNUUPDD
          GOTO      CBDNSV45 IF EQUAL
          MOVE      PMNUUPDD,KEY16
          CALL      TSTMP000
          UNPACK    KEY20,KEY12,KEY8
          WRITE     HTMLFILE;"<td nowrap>",KEY12,"<br>",KEY8,"</td>"
          GOTO      CBDNSV99
CBDNSV45  WRITE     HTMLFILE;"<td>",NBSP,"</td>"; 
.
CBDNSV99  RETURN
.
.---------------------------------------------------------------------
.         Output Row details (Nutrition) hea diet (ptcnutom=1)
.---------------------------------------------------------------------
CBDHEA00  WRITE     HTMLFILE;"<td>&nbsp;";
          CALL      ALERTI00
          CALL      DALR0000             * Display alerts
          WRITE     HTMLFILE;"</td>";
.
.----  BMI
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
          CALL      PATATR00
.
          MATCH     SP70,PTARVAL3
          IF        @EQUAL
            CALL      CLCBMI00
          ELSE
            PACK      BODMASIN,PTARVAL3,SP70
          ENDIF
.
          CALL      RNGBMI00
          WRITE     HTMLFILE;"<td>";
          WRITE     HTMLFILE;"<img src=#"../images/MaintenanceIcon.gif#"":
                             " class=ListIcon onclick='PatientAttribute(#"":
                               URNUMBER,"#",#"",ADMISSNO,"#");'>";
          WRITE     HTMLFILE;BODMASRN,"</td>";
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
.
.----  Fasting
          MATCH     "Yes",DTFASTNG
          IF        @EQUAL
            WRITE     HTMLFILE;"<td class='PastDischDate'>",DTFASTNG,"<br>";
          ELSE
            WRITE     HTMLFILE;"<td>",DTFASTNG,"<br>";
          ENDIF
          WRITE     HTMLFILE;"<img src=../images/DietIcon.gif ":
                             " class=ListIcon onclick='UpdateNutrition(#"":
                               URNUMBER,"#",#"",ADMISSNO,"#")'></td>";
.
          MOVE      ONE,F1
          WHILE     F1 <= 5
            PACK      KEY17,AADMNO,CURRDATE,F1
            CALL      RDCTCOM1
            IF        OVRCD=1
              CALL      CLCATCOM
            ENDIF
            MOVE      CATDC,CATEGORY               // Diet 1
            MOVE      CTCODIET,CODE
            CALL      GETCOD00
            MOVE      TDESC,DESCML01
.
            MOVE      CATMJ,CATEGORY               // Diet 2
            MOVE      CTCOIT02,CODE
            CALL      GETCOD00
            MOVE      TDESC,DESCML02
.
            MOVE      CATMJ,CATEGORY               // Diet 3
            MOVE      CTCOIT03,CODE
            CALL      GETCOD00
            MOVE      TDESC,DESCML03
.
            MOVE      CATMJ,CATEGORY               // Diet 4
            MOVE      CTCOIT04,CODE
            CALL      GETCOD00
            MOVE      TDESC,DESCML04
.
            MOVE      CATMJ,CATEGORY               // Diet 5
            MOVE      CTCOIT05,CODE
            CALL      GETCOD00
            MOVE      TDESC,DESCML05
.
.----  Breakfast/Lunch/Dinner
            WRITE     HTMLFILE;"<td nowrap>",DESCML01,"&nbsp;<br>":
                                      DESCML02,"&nbsp;<br>":
                                      DESCML03,"&nbsp;<br>":
                                      DESCML04,"&nbsp;<br>":
                                      DESCML05,"&nbsp;</td>";
            ADD         TWO,F1
          DO
.
.----  Supplements
CBDHEA15  CALL      DSUP0000             * HEA - Display Supplements
.
.----  Comments
          WRITE     HTMLFILE;"<td>";
.
          MATCH     SP70,PMNUCOM5
          IF        !@EQUAL
            WRITE     HTMLFILE;PMNUCOM1;
            WRITE     HTMLFILE;"<br>",PMNUCOM2;
            WRITE     HTMLFILE;"<br>",PMNUCOM3;
            WRITE     HTMLFILE;"<br>",PMNUCOM4;
            WRITE     HTMLFILE;"<br>",PMNUCOM5;
            GOTO      CBDHEA29
          ENDIF
.
          MATCH     SP70,PMNUCOM4
          IF        !@EQUAL
            WRITE     HTMLFILE;PMNUCOM1;
            WRITE     HTMLFILE;"<br>",PMNUCOM2;
            WRITE     HTMLFILE;"<br>",PMNUCOM3;
            WRITE     HTMLFILE;"<br>",PMNUCOM4;
            GOTO      CBDHEA29
          ENDIF
.
          MATCH     SP70,PMNUCOM3
          IF        !@EQUAL
            WRITE     HTMLFILE;PMNUCOM1;
            WRITE     HTMLFILE;"<br>",PMNUCOM2;
            WRITE     HTMLFILE;"<br>",PMNUCOM3;
            GOTO      CBDHEA29
          ENDIF
.
          MATCH     SP70,PMNUCOM2
          IF        !@EQUAL
            WRITE     HTMLFILE;PMNUCOM1;
            WRITE     HTMLFILE;"<br>",PMNUCOM2;
            GOTO      CBDHEA29
          ENDIF
.
          MATCH     SP70,PMNUCOM1
          IF        @EQUAL
            WRITE     HTMLFILE;NBSP;
          ELSE
            WRITE     HTMLFILE;PMNUCOM1;
          ENDIF
.
CBDHEA29  WRITE     HTMLFILE;"</td>";
.
CBDHEA30  WRITE     HTMLFILE;"<td>",DTASSLEV,"</td>";
.
          MOVE      SP70,KEY30
          MATCH     "1",PWDVTYPE
          IF        @EQUAL
            PACK      KEY30,PMVXPOWD,PMVXPOBD
            MATCH     SP70,KEY30
            GOTO      CBDHEA32 IF NOT EQUAL
            WRITE     HTMLFILE;"<td>",NBSP,"</td>";
            GOTO      CBDHEA40
CBDHEA32    PACK      KEY30,PMVXPOWD,NBSP,SLASH,NBSP,PMVXPOBD
            WRITE     HTMLFILE;"<td nowrap>",KEY30,"</td>";
          ELSE
            PACK      KEY30,PMNUDCDE,PMNUPAGN
            MATCH     KEY30,SP70
            GOTO      CBDHEA35 IF NOT EQUAL
            WRITE     HTMLFILE;"<td>",NBSP,"</td>";
            GOTO      CBDHEA40
CBDHEA35    WRITE     HTMLFILE;"<td nowrap>":
                               "<a href='javascript:HCPViewFrame(#"":
                               PMNUDCDE,"#")'>",DTDTNNAM,"</a>":
                               "<br>",PMNUPAGN,"</td>";
          ENDIF
.
CBDHEA40  MOVE      SP70,DISPLUPD
          MOVE      SP70,DISPLUTM
          MATCH     SP70,PMNUUPDD
          GOTO      CBDHEA99 IF EQUAL
          MOVE      PMNUUPDD,KEY16
          CALL      TSTMP000
          UNPACK    KEY20,KEY12,KEY8
          MOVE      KEY12,DISPLUPD
          MOVE      KEY8,DISPLUTM
.
CBDHEA99  RETURN
+
.*******************************************************************************
.         Initialise Alert code array
.*******************************************************************************
IALR0000  MOVE      ZERO,FORM2
          WHILE     FORM2 < 99
            ADD       ONE,FORM2
            MOVE      SP70,ALRTCODE[FORM2]
          DO
IALR9999  RETURN
+
.------------------------------------------------------------
.         Display H6 alert Code description
.------------------------------------------------------------
H6ALR000  CALL      IALR0000                * Initialise variables
          MOVE      ZERO,FORM2
          REPLACE   "+ ",URNUMBER
          PACK      KEY16,URNUMBER,CATH6,SP70
          CALL      RSPTALR1
H6ALR100  CALL      RKPTALR1                * Check if any H6 Alerts Exist?
          BRANCH    OVRCD,H6ALR900
.
          MATCH     URNUMBER,PTALURNO
          GOTO      H6ALR900 IF NOT EQUAL
.
          MATCH     CATH6,PTALCATG
          GOTO      H6ALR900 IF NOT EQUAL
.
          MATCH     SP70,PTALCODE
          GOTO      H6ALR100 IF EQUAL
.
          PACK      KEY5,CATH6,PTALCODE
          CALL      RDCODE1
          BRANCH    OVRCD,H6ALR100
.
          COMPARE   "99",FORM2
          GOTO      H6ALR900 IF NOT LESS
.
          ADD       ONE,FORM2
          MOVE      TDESC,ALRTCODE[FORM2]
          GOTO      H6ALR100
.
H6ALR900  REPLACE   " +",URNUMBER
.
H6ALR999  RETURN
+
.------------------------------------------------------------
.         Display Alert for Healthscope
.------------------------------------------------------------
DALR0000  MOVE      ZERO,FORM2
DALR1000  COMPARE   "99",FORM2
          GOTO      DALR9999 IF NOT LESS
.
          ADD       ONE,FORM2
          MATCH     SP70,ALRTCODE[FORM2]
          GOTO      DALR9999 IF EQUAL
.
          WRITE     HTMLFILE;"<br>",ALRTCODE[FORM2],NBSP;
          GOTO      DALR1000
DALR9999  RETURN
+
.------------------------------------------------------------
.         Display Diet types for Healthscope
.------------------------------------------------------------
DDIET000  
.         COMPARE   ONE,EXTRDIET
.         GOTO      DDIET2000 IF NOT EQUAL
.
          MATCH     SP70,PMNUML01
          IF        !@EQUAL
            PACK      KEY5,ANSM,ANSJ,PMNUML01
            CALL      RDCODE1
            IF        OVRCD=0
              WRITE     HTMLFILE;"<br>",TDESC,NBSP;
            ENDIF
          ENDIF
.
          MATCH     SP70,PMNUML03
          IF        !@EQUAL
            PACK      KEY5,ANSM,ANSJ,PMNUML03
            CALL      RDCODE1
            IF        OVRCD=0
              WRITE     HTMLFILE;"<br>",TDESC,NBSP;
            ENDIF
          ENDIF
.
          MATCH     SP70,PMNUML05
          IF        !@EQUAL
            PACK      KEY5,ANSM,ANSJ,PMNUML05
            CALL      RDCODE1
            IF        OVRCD=0
              WRITE     HTMLFILE;"<br>",TDESC,NBSP;
            ENDIF
          ENDIF
.
          MATCH     SP70,PMNUML07
          IF        !@EQUAL
            PACK      KEY5,ANSM,ANSJ,PMNUML07
            CALL      RDCODE1
            IF        OVRCD=0
              WRITE     HTMLFILE;"<br>",TDESC,NBSP;
            ENDIF
          ENDIF
          GOTO      DDIET9999
.
DDIET2000 WRITE     HTMLFILE;"<br>",DTDTTYPE,NBSP;
.
DDIET999  RETURN
.
.------------------------------------------------------------
.         Display Supplements for Healthscope
.------------------------------------------------------------
DSUP0000  MATCH     "1",PTCNUESD
          IF        @EQUAL
            REP       "+ ",URNUMBER
            WRITE     HTMLFILE;"<td><input class='button' type=button value='Supplements' onClick='SupplementLink(#"":
                   URNUMBER,"#");'></td>";
            REP       " +",URNUMBER
          ELSE
            WRITE     HTMLFILE;"<td><br>B-",PMNUBSUP,NBSP;
            WRITE     HTMLFILE;"<br>M-",PMNUMSUP,NBSP;
            WRITE     HTMLFILE;"<br>L-",PMNULSUP,NBSP;
            WRITE     HTMLFILE;"<br>A-",PMNUASUP,NBSP;
            WRITE     HTMLFILE;"<br>D-",PMNUDSUP,NBSP;
            WRITE     HTMLFILE;"<br>S-",PMNUSSUP,NBSP,"</td>";
          ENDIF
.
DSUP9999  RETURN
+
.------------------------------------------------------------
.         Output Row details (Nutrition) specific RCH (kids)      
.------------------------------------------------------------
CBDNRC00  WRITE     HTMLFILE;"<td>"
.
          MATCH     "1",PTMXSIN1
          IF        @EQUAL
            WRITE     HTMLFILE;"<img src='../images/AlertIcon.gif'":
                               " alt='Alerts'":
                               " class=ListIcon onclick='PatientAlerts(#"":
                               URNUMBER,"#",#"",ADMISSNO,"#");'>"
            GOTO      CBDNRC05
          ENDIF
          MATCH     "2",PTMXSIN1
          IF        @EQUAL
            WRITE     HTMLFILE;"<img src='../images/AlertIconBlack.gif'":
                               " alt='Alerts'":
                               " class=ListIcon onclick='PatientAlerts(#"":
                               URNUMBER,"#",#"",ADMISSNO,"#");'>"
            GOTO      CBDNRC05
          ENDIF
.
          MATCH     "3",PTMXSIN1
          IF        @EQUAL
            WRITE     HTMLFILE;"<img src='../images/AlertIconDelete.gif'":
                               " alt='Alerts'":
                               " class=ListIcon onclick='PatientAlerts(#"":
                               URNUMBER,"#",#"",ADMISSNO,"#");'>"
            GOTO      CBDNRC05
          ENDIF
.
          MATCH     SP70,PTMXSIN1
          IF        !@EQUAL
            WRITE     HTMLFILE;"<img src='../images/AlertIcon":
                               PTMXSIN1,".gif'":
                               " alt='Alerts'":
                               " class=ListIcon onclick='PatientAlerts(#"":
                               URNUMBER,"#",#"",ADMISSNO,"#");'>"
          ENDIF
.
CBDNRC05  MATCH     "1",PTMXSIN2
          IF        @EQUAL
.            WRITE     HTMLFILE;"<img src=#"../images/ResultIcon.gif#"":
.                               " class=ListIcon onclick='PatientResults(#"":
.                               URNUMBER,"#",#"",ADMISSNO,"#");'>"
          ENDIF
          WRITE     HTMLFILE;"<img src=../images/",IMGSRC:
                             " class=ListIcon onclick='UpdateCondition(#"":
                             URNUMBER,"#",#"",ADMISSNO,"#")'>":
                             CONDESC,DISPDATE,"<br>",LPCONDD,"</td>";
.
CBDNRC10  WRITE     HTMLFILE;"<td><img src=../images/DietIcon.gif ":
                             " class=ListIcon onclick='UpdateNutrition(#"":
                             URNUMBER,"#",#"",ADMISSNO,"#")'>":
                             TDESC,"</td>";
.
CBDNRC20  WRITE     HTMLFILE;"<td>",DTFASTNG,"</td>";
          WRITE     HTMLFILE;"<td>",DTDTTYPE,"</td>";
          WRITE     HTMLFILE;"<td>","Other Details","</td>";
CBDNRC25  WRITE     HTMLFILE;"<td>",PMNUCOM1,NBSP,"</td>";
.
....CBDNRC40  WRITE     HTMLFILE;"<td>",ACLSSFT,"</td>":
....                             "<td nowrap>":
....                               DISPDATE,ATIME,"<br>":
....                               EXPCTDSC,"</td>";
.
CBDNRC99  RETURN
.------------------------------------------------------------
. Heading Row (nutrition view)
.------------------------------------------------------------
CRHDN000  MOVE      TEN1,CSPANUM             * St. Vincents (stnd)
          IF        KIDSONLY=ONE         
            MOVE      TEN2,CSPANUM          * RCH (kids)      
          ENDIF
          MATCH     "1",PTCNUTOM
          IF        @EQUAL
            MOVE      TEN3,CSPANUM          * HEA diet
          ENDIF
.
CRHDN500  IF        NOBEDWRD=1
            SUBTRACT  ONE,CSPANUM           * Remove 'bed' col for WardOnly Ward
          ENDIF
          MOVE      CSPANUM,CSPAN
          SQUEEZE   CSPAN
          WRITE     HTMLFILE;"<tr><td colspan=",CSPAN," align=center ":
                               "class=HeadingCell><b>",ROWHEAD,"</td></tr>"
CRHDN999  RETURN
.------------------------------------------------------------
. Current AdmissIons (nutrition) Bed Row message.
.------------------------------------------------------------
CBDMSN00  BRANCH    BEDMSGID,CBDMSN01,CBDMSN02
.
          MOVE      "LeaveCell",BDMSGCLS
          MOVE      "*** On Leave ***",BDMSGTXT
          GOTO      CBDMSN10
.
CBDMSN01  MOVE      "AvailableCell",BDMSGCLS
          MOVE      "*** Empty ***",BDMSGTXT
          GOTO      CBDMSN10
.
CBDMSN02  BRANCH    WBEDTYPE,CBDMSN99                                 *I-273956
          MOVE      "ClosedCell bgcolor=gray",BDMSGCLS
          MOVE      "*** Closed ***",BDMSGTXT
.
CBDMSN10
          WRITE     HTMLFILE;"<tr height=35 align=top>":
                             "<td align=center class=",BDMSGCLS,">";
.
          CALL      FBED0000
          WRITE     HTMLFILE;*+,BEDTEXT;

          WRITE     HTMLFILE;"</td><td align=center>",BDMSGTXT,"</td>";
.
                                                 * RCH (kids) has extra 2 cols
CBDMSN40  IF        KIDSONLY=ONE
            WRITE     HTMLFILE;"<td>&nbsp;</td>":
                               "<td>&nbsp;</td>";
          ENDIF
.
          MATCH     "1",PTCNUTOM
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;</td>";     * hea diet has extra col
          ENDIF
CBDMSN60
          WRITE     HTMLFILE;"<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>";
.
          IF        SJOGVIEW<>1
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          WRITE     HTMLFILE;"</tr>";
CBDMSN99  RETURN
.-------------------------------------------------------------------------
. Calculate number of patients,empty beds and patients not allocated a bed
.-------------------------------------------------------------------------
WARDET00  BRANCH    WINPUT,WARDET50,WARDET70
.
WARDET20  COMPARE   ZERO,WINPUT 
          GOTO      WARDET99 IF NOT EQUAL
.
          CALL      WARBED00           * Details for ward/bed
          GOTO      WARDET99
.
WARDET50  CALL      WARONL00           * Details for ward only
          GOTO      WARDET99
.
WARDET70  CALL      WARBED00           * Details for ward only and ward/bed
.
          MOVE      NUMBPATS,SAVBPATS  * Save Ward/bed details
          MOVE      NUMEMBED,SAVEMBED
          MOVE      NUMNOBED,SAVNOBED
.
          CALL      WARONL00
.
          ADD       SAVBPATS,NUMBPATS  * Add ward bedtotals to ward only 
          ADD       SAVEMBED,NUMEMBED
          ADD       SAVNOBED,NUMNOBED 
          GOTO      WARDET99

WARDET99  RETURN
+
.-------------------------------------------------------------------------
. Calculate ward/bed details
.-------------------------------------------------------------------------
WARBED00  MOVE      ZERO,NUMBPATS
          MOVE      ZERO,NUMEMBED
          MOVE      ZERO,NUMNOBED
WARBED10  CALL      RDKWARD1
          BRANCH    OVRCD,WARBED90
          MATCH     WARDCODE,WWARD
          GOTO      WARBED90 IF NOT EQUAL
          BRANCH    WACTIVE,WARBED10     * Do not include inactive bed
.
          MATCH     ZEROVISN,WADMNO
          IF        !@EQUAL
            ADD       ONE,NUMBPATS
          ENDIF
.
          MATCH     ZEROVISN,WSTBY
          IF        !@EQUAL
            ADD       ONE,NUMBPATS
          ENDIF
.
          MATCH     ZEROVISN,WADMNO
          IF        @EQUAL
            ADD       ONE,NUMEMBED
          ENDIF
.
          GOTO      WARBED10
.
WARBED90  PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,WARBED99
          GOTO      WARBED99
.
WARBED99  RETURN
.
.-------------------------------------------------------------------------
. Calculate ward only details
.-------------------------------------------------------------------------
WARONL00  MOVE      ZERO,NUMBPATS
          MOVE      ZERO,NUMEMBED
          MOVE      ZERO,NUMNOBED
          PACK      KEY13,WARDCODE,SP70
          CALL      RDSNOBE1
WARONL10  CALL      RDKNOBE1
          BRANCH    OVRCD,WARONL90
          MATCH     WARDCODE,NBWARD
          GOTO      WARONL90 IF NOT EQUAL
.
          ADD       ONE,NUMBPATS
          ADD       ONE,NUMNOBED
          GOTO      WARONL10
.
WARONL90  PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,WARONL99 
          ASSIGN    (WOCCBED - NUMBPATS),NUMEMBED

WARONL99  RETURN
.-------------------------------------------------------------------------
. Close patient dependency list
.-------------------------------------------------------------------------
CLDEP000  MATCH     SP70,WARDCODE
          GOTO      CLDEP999 IF EQUAL
.
          MATCH     SP70,SHIFTNUM
          GOTO      CLDEP999 IF EQUAL
.
          PACK      KEY20,WARDCODE,LASTDATE,SHIFTNUM,SP70
          CALL      RSPMPDP2
CLDEP100  CALL      RKPMPDP2
          BRANCH    OVRCD,CLDEP999
.
          MATCH     WARDCODE,PMPDWARD
          GOTO      CLDEP999 IF NOT EQUAL 
.
          MATCH     LASTDATE,PMPDDATE
          GOTO      CLDEP999 IF NOT EQUAL 
.
          MATCH     SHIFTNUM,PMPDSHIF
          GOTO      CLDEP999 IF NOT EQUAL 
.
          MOVE      ANSY,PMPDCLOS
          CALL      UPPMPDP2
          GOTO      CLDEP100
.
CLDEP999  RETURN
+
.*******************************************************************************
. Get working diagnosis Comments
.*******************************************************************************
GETWOR00  PREP      WORCOMAF,WORCOMNM
          MOVE      ONE,F3
          WRITE     WORCOMAF,SEQ;QRYDATA
          MOVE      ONE,WORCOMFL
          MOVE      ONE,WDIGFLAG       * Set update file flag to yes
.
GETWOR10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETWOR90 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETWOR80 IF NOT EQUAL
          MATCH     SP70,QRYDATA
          GOTO      GETWOR10 IF EQUAL
          GOTO      GETWOR10 IF EOS
          ADD       ONE,F3
          WRITE     WORCOMAF,SEQ;QRYDATA
.
          GOTO      GETWOR10
.
GETWOR80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETWOR90  OPEN      WORCOMAF,WORCOMNM
GETWOR99  RETURN
+
.-------------------------------------------------------------------
.   Add working diagnosis text
.------------------------------------------------------------------
ADDWOR00  COMPARE   ZERO,WORCOMFL     * No Comments in Update Ignore
          GOTO      ADDWOR99 IF EQUAL
          MOVE      ZERO,F3
          MOVE      SP70,PMSWO002
          MOVE      SP70,PMSWO003
          MOVE      SP70,PMSWO004
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      WORCOMAF,WORCOMNM
          TRAPCLR   IO
          BRANCH    OVRCD,ADDWOR99
.
ADDWOR10  ADD       ONE,F3
          COMPARE   F3,THREE
          GOTO      ADDWOR99 IF LESS
.
          READ      WORCOMAF,SEQ;DIM35
          GOTO      ADDWOR99 IF OVER
          STORE     DIM35,F3,PMSWO002,PMSWO003,PMSWO004
.
          GOTO      ADDWOR10
.
ADDWOR99  RETURN
+
.-------------------------------------------------------------------
.   Get emergency visit number for this admission
.------------------------------------------------------------------
GETE0000  PACK      KEY16,AURNO,Z70
          CALL      RSEMVIS3
GETE1000  CALL      RPEMVIS3
          BRANCH    OVRCD,GETE9000
.
          MATCH     AURNO,EMVIURNO
          GOTO      GETE9000 IF NOT EQUAL
.
          MATCH     DAADMNO,EMVIPADM       * Check for matching linked visit
          GOTO      GETE1000 IF NOT EQUAL
.
          GOTO      GETE9999
.
GETE9000  CALL      CLEMRVIS
.
GETE9999  RETURN
.
.------------------------------------------------------------
. Ward selection
.------------------------------------------------------------
EMUW0000  MATCH     "1",DEFTFLAG
          IF        !@EQUAL
            MOVE      SP3,WARDCODE
          ENDIF
.
          PACK      KEY29,SP70
          IF        IBCNMHOS = 1
            PACK      KEY29,SP3,WBSEHOSP,SP70
          ENDIF
          CALL      RDSWARD7
EMUW0100  CALL      RDKWARD7
          BRANCH    OVRCD,EMUW9999
.
.                         if we have a bed number we have passed all the ward
.                         master records, so exit
          MATCH     SP70,WBED
          GOTO      EMUW9999 IF NOT EQUAL
.
          COMPARE   WACTIVE,ZERO                 *List only active wards
          GOTO      EMUW0100 IF NOT EQUAL
.
          IF        IBCNMHOS = 1
            MATCH      SP3,WBSEHOSP
            IF        !@EQUAL
              MATCH     WBSEHOSP,PTWDHOSN
              GOTO      EMUW9999 IF NOT EQUAL
            ENDIF
          ENDIF
.
.      * if no default ward, set it as the first EOU ward 
          MATCH     SP70,WARDCODE
          IF        @EQUAL
            PACK      KEY5,ANSB,ANST,WEFRBT,SP70
            CALL      RDCODE1
            IF        OVRCD=0.
              MATCH     "S",THCSCOD             * EOU Unit
              IF        @EQUAL
                MATCH     ANSO,TCINDC8
                IF        @EQUAL
                  MOVE      WWARD,WARDCODE      * Set wardcode cgi
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
.                       write the select option.
          WRITE     HTMLFILE;"<option value=#"",WWARD,"#"";
          MATCH     WARDCODE,WWARD
          IF        @EQUAL
            WRITE     HTMLFILE;" selected";
          ENDIF
          WRITE     HTMLFILE;">",WBDESC;
.
          IF        IBCNMHOS = 1
            MATCH      SP3,WBSEHOSP
            IF        @EQUAL
              WRITE     HTMLFILE;" - ",PTWDHOSN;
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"</option>"
          GOTO      EMUW0100
.
EMUW9999  RETURN
.
.------------------------------------------------------------
. Expected Discharges
.------------------------------------------------------------
EXPDIS00  CALL      CURPER00
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.
          MOVE      "Expected Discharges",WEBTITLE 
.
          CALL      WEBHED00
          BRANCH    EXIT,EXPDIS99
.
          CALL      WEBBOD00
.
          CALL      WEBEND00
.
          GOTO      EXPDIS99
.
EXPDIS99  RETURN
.
.------------------------------------------------------------
. Ward Admissions
.------------------------------------------------------------
EXPD0000  BRANCH    FLDITMNO,EXPD0100,EXPD0200,EXPD0300,EXPD0400,EXPD0500:
                             EXPD0600,EXPD0700,EXPD0800,EXPD0900,EXPD1000:
                             EXPD1100,EXPD1200,EXPD1300,EXPD1400,EXPD1500:
                             EXPD1600,EXPD1700,EXPD1800
          GOTO      EXPD9999
.
EXPD0100  CALL      NEXT0000
          GOTO      EXPD9999
.
EXPD0200  CALL      PREV0000
          GOTO      EXPD9999
.
EXPD0300  CALL      CURSTD00
          GOTO      EXPD9999
.
EXPD0400  CALL      CUREND00
          GOTO      EXPD9999
.
EXPD0500  CALL      CURYR000
          GOTO      EXPD9999
.
EXPD0600  CALL      CURMON00
          GOTO      EXPD9999
.
EXPD0700  CALL      SELV0000
          GOTO      EXPD9999
.
EXPD0800  CALL      ETABD000        * Table of Expected Discharges
          GOTO      EXPD9999
.
EXPD0900  WRITE     HTMLFILE;TEMPLATE;
          GOTO      EXPD9999
.
EXPD1000  WRITE     HTMLFILE;REPORTNO;
          GOTO      EXPD9999
.
EXPD1100  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      EXPD9999
.
EXPD1200  PACK      DFLTWARD,WARDCODE
          CALL      WSEL0000        * Ward Select Options
          GOTO      EXPD9999
.
EXPD1300  MOVE      "vi",CATEGORY
          MOVE      FILTDPST,CODE
          CALL      CODITM00
          GOTO      EXPD9999
.
EXPD1400  MOVE      "CL",CATEGORY
          MOVE      FILTCLAI,CODE
          CALL      CODITM00
          GOTO      EXPD9999
.
EXPD1500  MATCH     SP70,WARDCODE
          IF        @EQUAL
            MATCH     "1",DEFTFLAG
            IF        @EQUAL
              MOVE      WBSEWRD,WARDCODE    * default to user id ward
            ENDIF
          ENDIF
          PACK      DFLTWARD,WARDCODE
          CALL      WSEL0000                * Ward selection list
          GOTO      EXPD9999
.
EXPD1600  WRITE     HTMLFILE;DEFTVIEW;
          GOTO      EXPD9999
.
EXPD1700  WRITE     HTMLFILE;SELPRINT;
          GOTO      EXPD9999
.
EXPD1800  CALL      EXABD000    * Table of Expected Discharges blank exp date
          GOTO      EXPD9999
.
EXPD9999  RETURN
.
.------------------------------------------------------------
. Displays Expected discharges from the working diagnosis
. expected discharge date.
.------------------------------------------------------------
ETABD000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          MOVE      ZERO,DISNUMB
          PACK      KEY16,FRSTDATE,SP70
          CALL      RSPMWOR2
ETABD100  CALL      RKPMWOR2
          BRANCH    OVRCD,ETABD900
.
          MATCH     PMWOEDAT,LASTDATE
          GOTO      ETABD900 IF LESS
.
          COMPARE   ONE,IBCNMHOS
          GOTO      ETABD150 IF NOT EQUAL
.
          MOVE      PMWOADMN,KEY8
          CALL      RDPMVX11                  * Check hosital
          BRANCH    OVRCD,ETABD100
.
          MATCH     WBSEHOSP,PMVXMHOS
          GOTO      ETABD100 IF NOT EQUAL
.
ETABD150  MOVE      PMWOADMN,KEY8
          CALL      RDMISS1                   * Get Admission file rec
          BRANCH    OVRCD,ETABD100
.
          COMPARE   TWO,ASTAT                 * Current Adm
          GOTO      ETABD200 IF EQUAL
.
          COMPARE   FOUR,ASTAT                * On Leave
          GOTO      ETABD200 IF EQUAL
.
          GOTO      ETABD100
.
ETABD200  CALL      EROWD000
          GOTO      ETABD100
ETABD900
ETABD999  RETURN
.
.------------------------------------------------------------
. Displays Expected discharges from the working diagnosis
. expected discharge date.
.------------------------------------------------------------
EXABD000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          PACK      KEY16,SP70
          CALL      RSPMWOR2
EXABD100  CALL      RKPMWOR2
          BRANCH    OVRCD,EXABD900
.
          MATCH     SP70,PMWOEDAT
          GOTO      EXABD999 IF NOT EQUAL
.
          MOVE      PMWOADMN,KEY8
          CALL      RDMISS1                   * Get Admission file rec
          BRANCH    OVRCD,EXABD100
.
          COMPARE   "999",ASTAY
          GOTO      EXABD100 IF NOT EQUAL
.
EXABD120  COMPARE   ONE,IBCNMHOS
          GOTO      EXABD150 IF NOT EQUAL
.         
          MOVE      PMWOADMN,KEY8           
          CALL      RDPMVX11                  * Check hosital
          BRANCH    OVRCD,EXABD100
.
          MATCH     WBSEHOSP,PMVXMHOS
          GOTO      EXABD100 IF NOT EQUAL
.
EXABD150  COMPARE   TWO,ASTAT                 * Current Adm
          GOTO      EXABD200 IF EQUAL
.
          COMPARE   FOUR,ASTAT                * On Leave
          GOTO      EXABD200 IF EQUAL
.
          GOTO      EXABD100
.
EXABD200  CALL      EROWD000
          GOTO      EXABD100
EXABD900
EXABD999  RETURN
.
.------------------------------------------------------------
. Expected Discharge row
.------------------------------------------------------------
EROWD000  MOVE      PMWOADMN,ADMISSNO       * set admission number
.
          CALL      GETPAT00
          CALL      PATLN000
          CALL      PATFLD00                * Use standard Patient Folder sub
          MOVE      KEY3,FOLDERSF           * and store suffix
.
          CALL      GETCON00                * Get Patients Current Condition
          MATCH     SP70,CONDESC
          IF        !@EQUAL
            UNPACK    LPCDATE,CCENT,CYEAR,CMON,CDAY
            PACK      DISPDATE,LBRACKT,CDAY,SLASH,CMON,SP1,LPCTIME,RBRACKT 
          ELSE
            CLEAR     DISPDATE
          ENDIF
.
.
          MATCH     SP70,FILTDPST           * Preparation status filter
          IF        !@EQUAL
            MATCH     FILTDPST,PMWODPST
            GOTO      EROWD999 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTCLAI           * Claim code filter
          IF        !@EQUAL
            MATCH     FILTCLAI,ACLAIM
            GOTO      EROWD999 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,WARDCODE           * Ward filter
          IF        !@EQUAL
            MATCH     WARDCODE,AWARD
            GOTO      EROWD999 IF NOT EQUAL
          ENDIF
.
EROWD100  ADD       ONE,DISNUMB
          MOVE      SP70,DIM5
          MOVE      ZERO,FORM5
          MOVE      DISNUMB,FORM5
          MOVE      FORM5,DIM5
          REP       " 0",DIM5
.
          MOVE      "U2",CATEGORY
          MOVE      AUSR2,CODE
          CALL      GETCOD00
          MOVE      TDESC,DISPUSR2
.
          MOVE      "vi",CATEGORY
          MOVE      PMWODPST,CODE
          CALL      GETCOD00
          MOVE      TDESC,DISPPREP
.
          MOVE      SP70,VISPHONE
          CLEAR     VISPHONE
.
          MOVE      ANSR,DIM1
          MATCH     "1",PMVXVALW
          IF        @EQUAL
            MOVE ANSV,DIM1
          ENDIF
          APPEND    LBRACKT,VISPHONE
          APPEND    DIM1,VISPHONE
          APPEND    COMMA,VISPHONE
.
          MOVE      ANSN,DIM1
          MATCH     "1",PMVXPALW
          IF        @EQUAL
            MOVE ANSP,DIM1
          ENDIF
          APPEND    DIM1,VISPHONE
          APPEND    RBRACKT,VISPHONE
          RESET     VISPHONE
.
          CLEAR     CONLINK                 * Link for Patient Condition
          APPEND    "javascript:UpdateCondition('",CONLINK
          APPEND    URNUMBER,CONLINK
          APPEND    "','",CONLINK
          APPEND    ADMISSNO,CONLINK
          APPEND    "','",CONLINK
          APPEND    "')",CONLINK
          RESET     CONLINK
.
          UNPACK    ADMISSNO,KEY2,KEY6
          MOVE      ADMISSNO,KEY8
          CALL      RDDSCH1
          IF        OVRCD=1
            CALL      CLPATDSC
          ENDIF
.
          MOVE      ADOCTA,DOCTCODE
          REP       " +",DOCTCODE
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
.
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CCC,CCENT
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      ADMISDAT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MOVE      SP70,COLRFLAG
          MATCH     SP70,PMWOEDAT
          IF        @EQUAL
            PACK      PMWOEDAT,HYPHEN,SP70
            PACK      PMWOEDTM,SP70
            GOTO      EROWD200
          ENDIF
.
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          MATCH     CURRDATE,PMWOEDAT
          IF        @LESS
            MOVE      "PastDischDate",COLRFLAG          * set bgcolor to past
          ENDIF
.
EROWD200  CLEAR     PATLINK
          APPEND    LINKPRG,PATLINK
          APPEND    ".pbl?reportno=",PATLINK
          APPEND    LINKREP,PATLINK
          APPEND    "&template=",PATLINK
          APPEND    LINKTEM,PATLINK
          APPEND    "&urnumber=",PATLINK
          APPEND    URNUMBER,PATLINK
          APPEND    "&admissno=",PATLINK
          APPEND    ADMISSNO,PATLINK
          RESET     PATLINK
. 
          PACK      KEY6,AWARD,ABED
          CALL      FWBD0000
.
          MOVE      SP70,KEY15
          MATCH     SP70,AFUNDH
          IF        !@EQUAL
            PACK      KEY15,AFUNDH,SLASH,AFNDTB,SP70
          ENDIF
.
          REP       "+ ",ADMISSNO
          CALL      GPAY0000              * Get any payment received
          MOVE      ADMISSNO,KEY8
          CALL      RDPTELG1
          IF        OVRCD=1
            MOVE      ZERO,PTELTOOP         * Total OOPS
          ENDIF
          REP       " +",ADMISSNO
.
          WRITE     HTMLFILE;"t.addRow(#"",FORMATNM,"#",":
                             "#"",PSEX,"#",":
                             "#"";

          CALL      WRTAGE00
          REP       "#" ",ADIAG1
          REP       "#" ",ADIAG2
          WRITE     HTMLFILE;"#",":
                             "#"",ADIAG1,ADIAG2,"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",ADATE,"#",":
                             "#"",DDATE,"#",":
                             "#"",DESTDESC,"#",":
                             "#"",PATLINK,"#",":
                             "#"",PMWOEDAT,PMWOEDTM,"#",":
                             "#"",PURNO,"#",":           * 10
                             "#"",WBEDTEXT,"#",":
                             "#"",CONLINK,"#",":
                           "#"",CONDESC,DISPDATE,SP1,LPCONDD,SP1,VISPHONE,"#",":
                           "#"",IMGSRC,"#",":
                           "#"",FOLDERSF,"#",":
                           "#"",COLRFLAG,"#",":
                           "#"",DISPPREP,"#",":          * 17
                           "#"",DISPUSR2,"#",":          * 18
                           "#"",ACLAIM,"#",":            * 19
                           "#"",KEY15,"#",":             * 20
                           "#"",PTELTOOP,"#",":          * 21
                           "#"",FORM12P2,"#",";          * 22
.
          MOVE      "prt",KEY3
          PACK      KEY8,KEY3,DIM5
          WRITE     HTMLFILE;"#"<input type=checkbox name=prt",DIM5:
                      " value='",PMWOADMN,"' onclick=NotPrintAll();>";
.
          WRITE     HTMLFILE;"#");"
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
          REP       "+ ",DOCTCODE
          GOTO      EROWD999
.
EROWD999  RETURN
+
.----------------------------------------------------------------------
.         Get payment recieved
.----------------------------------------------------------------------
GPAY0000  MOVE      ZERO,FORM12P2
          PACK      KEY25,ADMISSNO,SP70
          CALL      RSRCDTE6
GPAY1000  CALL      RKRCDTE6
          BRANCH    OVRCD,GPAY9999
.
          MATCH     ADMISSNO,RCDTVIST
          GOTO      GPAY9999 IF NOT EQUAL
.
          PACK      KEY12,RCDTRECN,SP70
          CALL      RDRCBNK1
          BRANCH    OVRCD,GPAY2000
.
          MATCH     "1",RCBNSTAT
          GOTO      GPAY1000 IF EQUAL            * Already cancelled
.
GPAY2000  ADD       RCDTAMNT,FORM12P2
          GOTO      GPAY1000
.
GPAY9999  RETURN
+
.------------------------------------------------------------------------------
. Schedule Group Label Printing
.------------------------------------------------------------------------------
PRTGPL00  MATCH     SP70,UPDATETY
          GOTO      PRTGPL70 IF EQUAL
.
          MATCH     "1",UPDATETY
          GOTO      PRTGPL20 IF EQUAL
.
          GOTO      PRTGPL90
.
.         ************ Schedule Print Labels **********
.
PRTGPL20  CALL      SGPL0000                * Schedule group label printing
          MOVE      "Printing Complete",WEBTITLE
          CALL      PREDIR00
          GOTO      PRTGPL99
.
.         ************ DISPLAY FORMACTION **********
.
PRTGPL70  CLEAR     WEBTITLE
          MOVE      "Group Label Printing",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,PRTGPL99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      PRTGPL99
.
PRTGPL90  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRTGPL99
.
PRTGPL99  RETURN
+
.------------------------------------------------------------------------------
.  Redirect Parent URL
.------------------------------------------------------------------------------
PREDIR00  CALL      OPENHTML
          BRANCH    EXIT,PREDIR90
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             " alert(#"",WEBTITLE,"#");":
                             " location.href=#"",REDIRECT,"#";":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      PREDIR99
.
PREDIR90  DISPLAY   "*** Fifo Not Found ***"
.
PREDIR99  RETURN
.------------------------------------------------------------------------------
. Schedule Group Label Printing
.------------------------------------------------------------------------------
SGPL0000  MOVE      ZERO,PTCOUNT
          MOVE      ZERO,COUNT
.
SGPL0100  ADD       ONE,PTCOUNT
          ADD       ONE,COUNT
          IF        PTCOUNT>PTKEYCNT
            GOTO       SGPL9999
          ENDIF
.
          MATCH     SP70,INPLABAR[PTCOUNT]
          GOTO      SGPL0100 IF EQUAL
.
          CALL      PRNT0000
.
          GOTO      SGPL0100
.
SGPL9999  RETURN
+
.*******************************************************************************
.                        Print Request Processing
.*******************************************************************************
PRNT0000  CALL      CLRPRT00
          PACK      KEY8,INPLABAR[PTCOUNT],SP70
          CALL      RDMISS1
          IF        OVRCD=1
            MOVE      "Invalid admission ",WEBTITLE
            GOTO      PRNT9000
          ENDIF
          PACK      KEY8,AURNO,SP70
          CALL      RDMAST1
          IF        OVRCD=1
            MOVE      "Invalid patient ",WEBTITLE
            GOTO      PRNT9000
          ENDIF
.
          MOVE      PURNO,URNUMBER
          MOVE      AADMNO,ADMISSNO
          MOVE      SP70,SUBSYSKY
          MOVE      SP70,STATNCOD
          MOVE      SP70,FREETXT1
          MOVE      SP70,FREETXT2
          MOVE      SP70,FREETXT3
          MOVE      SP70,FREETXT4
          MOVE      SP70,FREETXT5
          MOVE      SP70,FREETXT6
          MOVE      SP70,FREETXT7
.
          MATCH     "1",LABPRT01
          GOTO      PRNT0010 IF NOT EQUAL
          MOVE      LABPSL01,SCHDPRNT
          MOVE      LABPNO01,SCHDCOPY
          PACK      LABELTYP,LABELADD,ZERO,ONE,SP70
.
          MOVE      LABELADD,SETDFPRG
          MOVE      "1",SETDFRPT
          CALL      SETDEF00
.
          CALL      ADDPRN00
.
PRNT0010  MATCH     "1",LABPRT02
          GOTO      PRNT0020 IF NOT EQUAL
          MOVE      LABPSL02,SCHDPRNT
          MOVE      LABPNO02,SCHDCOPY
          PACK      LABELTYP,LABELPMI,ZERO,ONE,SP70
.
          MOVE      LABELPMI,SETDFPRG
          MOVE      "1",SETDFRPT
          CALL      SETDEF00
.
          CALL      ADDPRN00
.
PRNT0020  MATCH     "1",LABPRT03
          GOTO      PRNT0030 IF NOT EQUAL
          MOVE      LABPSL03,SCHDPRNT
          MOVE      LABPNO03,SCHDCOPY
          PACK      LABELTYP,LABELINP,ZERO,ONE,SP70
.
          MOVE      LABELINP,SETDFPRG
          MOVE      "1",SETDFRPT
          CALL      SETDEF00
.
          CALL      ADDPRN00
.
PRNT0030  MATCH     "1",FRMPRT01
          GOTO      PRNT0040 IF NOT EQUAL
          MOVE      FRMPSL01,SCHDPRNT
          MOVE      FRMPNO01,SCHDCOPY
          MOVE      FRMCOD01,STATNCOD
          PACK      LABELTYP,SP70
.
.         MOVE      "PATWEB70",SETDFPRG
.         MOVE      "1",SETDFRPT
.         CALL      SETDEF00           * set default printer
.
          CALL      ADDPRN00
.
PRNT0040  MATCH     "1",FRMPRT02
          GOTO      PRNT0050 IF NOT EQUAL
          MOVE      FRMPSL02,SCHDPRNT
          MOVE      FRMPNO02,SCHDCOPY
          MOVE      FRMCOD02,STATNCOD
          PACK      LABELTYP,SP70
.
.         MOVE      "PATWEB70",SETDFPRG
.         MOVE      "1",SETDFRPT
.         CALL      SETDEF00           * set default printer
.
          CALL      ADDPRN00
.
PRNT0050  MATCH     "1",FRMPRT03
          GOTO      PRNT0700 IF NOT EQUAL
          MOVE      FRMPSL03,SCHDPRNT
          MOVE      FRMPNO03,SCHDCOPY
          MOVE      FRMCOD03,STATNCOD
          PACK      LABELTYP,SP70
.
.         MOVE      "PATWEB70",SETDFPRG
.         MOVE      "1",SETDFRPT
.         CALL      SETDEF00           * set default printer
.
          CALL      ADDPRN00
.
PRNT0700  MOVE      ZERO,EXIT
          GOTO      PRNT9999
.
PRNT9000  
....      CALL      WEBERR00              * removed for CAR 290467
....      MOVE      ONE,EXIT
          GOTO      PRNT9999
.
PRNT9999  RETURN
+
.*******************************************************************************
.                 Clear Variables for Printing Control Table
.*******************************************************************************
CLRPRT00  MOVE      Z70,IBLPSCHE
          MOVE      Z70,IBLPURNO
          MOVE      Z70,IBLPVISN
          MOVE      Z70,IBLPSKEY
          MOVE      Z70,IBLPPRNT
          MOVE      ZERO,IBLPCOPY
          MOVE      Z70,IBLPSTAT
          MOVE      Z70,IBLPLAPR
          MOVE      Z70,IBLPLASC
          MOVE      Z70,IBLPFRE1
          MOVE      Z70,IBLPFRE2
          MOVE      Z70,IBLPFRE3
          MOVE      Z70,IBLPFRE4
          MOVE      Z70,IBLPFRE5
          MOVE      Z70,IBLPFRE6
          MOVE      Z70,IBLPFRE7
          MOVE      Z70,IBLPRUID
          MOVE      Z70,IBLPRDAT
          MOVE      Z70,IBLPRTIM
.
CLRPRT99  RETURN
.
.------------------------------------------------------------
. Set Default Printer
.------------------------------------------------------------
SETDEF00  MOVE      PRGID,SAVPRGID
          MOVE      REPORTNO,SAVREPTN
.
          MOVE      SCHDPRNT,SELPRINT
          MOVE      SETDFPRG,PRGID
          MOVE      SETDFRPT,REPORTNO
          CALL      UPDFPT00
.
          MOVE      SAVPRGID,PRGID
          MOVE      SAVREPTN,REPORTNO
          RETURN
.
.------------------------------------------------------------
. Displays Current Patient ward/bed details
.------------------------------------------------------------
BDMN0000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          CALL      BMAR0000                     * Set values in time array 
          CALL      BDMH0000                     * Output headings
.
. Ward/Bed Details
.
BDMN1000  PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
BDMN2000  CALL      RDKWARD1
          BRANCH    OVRCD,BDMN9999
          MATCH     WARDCODE,WWARD
          GOTO      BDMN9999 IF NOT EQUAL
.
          BRANCH    WACTIVE,BDMN2000       * Do not display Inactive Beds
.
          IF        STVCVIEW=1
            WRITE   HTMLFILE;"<tr>";
          ELSE
            WRITE   HTMLFILE;"<tr><td nowrap class=HeadingCell>",WBDESC,"</td>";
          ENDIF
          CALL      BDMR0000
          WRITE     HTMLFILE;"</tr>";
.
          GOTO      BDMN2000
.
BDMN9999  RETURN
.
.------------------------------------------------------------
. Displays Day oncology Outliers
.------------------------------------------------------------
DOUT0000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          WRITE     HTMLFILE;"<tr><td class=HeadingCell>Patient</td>":
                             "<td class=HeadingCell>Extn.</td>":
                             "<td class=HeadingCell>Ward</td>":
                             "<td class=HeadingCell>Adm Date</td>":
                             "<td class=HeadingCell>Attending Doctor</td>":
.                            "<td class=HeadingCell>Health Fund</td>":
                             "<td class=HeadingCell>Regime Code 1</td>":
                             "<td class=HeadingCell>Regime Code 2</td>":
                             "<td class=HeadingCell>Regime Code 3</td>":
                             "</tr>";
.
          MATCH     SP70,OUTLTYPE
          GOTO      DOUT0500 IF NOT EQUAL
.
          PACK      KEY5,ANSB,ANSK,SP70
          CALL      RDSCODE1
DOUT0200  CALL      RDKCODE1
          BRANCH    OVRCD,DOUT9999
.
          MATCH     "BK",TCODE
          GOTO      DOUT9999 IF NOT EQUAL
.
          MATCH     ANSO,TCINDC1
          GOTO      DOUT0200 IF NOT EQUAL
.
          PACK      OUTLTYPE,ACODE,SP70
.
DOUT0500  PACK      KEY16,LASTDATE,SP70
          CALL      RSBKREC4
DOUT1000  CALL      RKBKREC4
          BRANCH    OVRCD,DOUT0200
.
          MATCH     BKREEDAT,LASTDATE       * mathing date?
          GOTO      DOUT0200 IF NOT EQUAL   * no; get next booking
.
          MATCH     BKRETYPE,OUTLTYPE       * same booking type?
          GOTO      DOUT1000 IF NOT EQUAL   * no; get next booking
.
. ***** STV use this tag to show bookings IN this ward on oncology view *****
.
. ***** Standard uses this as an outlier list - and shows patients NOT  *****
. ***** in this ward  *****
          IF        STVCVIEW=1
            MATCH     WARDCODE,BKREWARD       * NOT the same ward?
            GOTO      DOUT1000 IF NOT EQUAL   * no; get next booking
.
            MATCH    SP70,BKREEBED
            GOTO     DOUT1000 IF NOT EQUAL
          ELSE
            MATCH     WARDCODE,BKREWARD       * IS the same ward?
            GOTO      DOUT1000 IF EQUAL      * no; get next booking
          ENDIF
.
          COMPARE   TWO,BKRESTAT            * cancelled?
          GOTO      DOUT1000 IF EQUAL       * yes; get next booking
.
          COMPARE   FOUR,BKRESTAT           * discharged?
          GOTO      DOUT1000 IF EQUAL       * yes; get next booking
.
          PACK      KEY8,BKREURNO
          CALL      RDMAST1
          CALL      RDPMPX21
          BRANCH    OVRCD,DOUT1000
          PACK      URNUMBER,BKREURNO,SP70
          PACK      ADMISSNO,BKREBOOK,SP70
          CALL      GETPAT00
          CALL      PATLN000
          CALL      PATFLD00
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          IF        OVRCD<>1
            IF        ASTAT=1
              PACK      BKREWARD,PTMIXWRD
              PACK      BKREEBED,PTMIEBED
            ELSE
              PACK      BKREWARD,AWARD
              PACK      BKREEBED,ABED
            ENDIF
            PACK      BKREEDAT,ADATE
            PACK      BKREADOC,ADOCTA
            PACK      PFUNDH,AFUNDH
            PACK      PFNDTB,AFNDTB
          ENDIF
.
          UNPACK    BKREEDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MOVE      SP70,WEXTN
          PACK      KEY6,BKREWARD,BKREEBED,SP70
          CALL      RDWARD1
.
          PACK      KEY6,BKREADOC
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE          * I CAR 13038
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000                * end I CAR 13038
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td nowrap>";
          IF        STVCVIEW=1
            WRITE     HTMLFILE;"<img src=../images/EditIcon.gif":
                             " class=ListIcon ":
                             " onclick='javascript:updateBed(#"",URNUMBER:
                             "#",#"",ADMISSNO,"#");'>";
          ENDIF
          WRITE     HTMLFILE;"<img src=../images/PatientFolder",KEY3,".gif":
                             " class=ListIcon ":
                             " onclick='location.href=#"",LINKPRG,".pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO,"#";'>":
                             FORMATNM,"</td>":
                             "<td>",WEXTN,"&nbsp;</td>";
          IF        BKRESTAT<2
            WRITE     HTMLFILE;"<td><font color=Red>",BKREWARD,SLASH:
                               BKREEBED,"</td>":
                               "<td><font color=Red>",DISPDATE,"</td>";
          ELSE
            WRITE     HTMLFILE;"<td>",BKREWARD,SLASH:
                               BKREEBED,"</td>":
                               "<td>",DISPDATE,"</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td>",DOCFNAME,"&nbsp;</td>";
.                             "<td>",PFUNDH,SLASH,PFNDTB,"&nbsp;</td>";
.
          PACK      KEY10,ADMISSNO,SP1,ONE,DIM127
          CALL      RDPTRGM1
          IF        OVRCD<>1
            WRITE     HTMLFILE;"<td>",PTRGREGM,"&nbsp;</td>";
          ELSE
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          PACK      KEY10,ADMISSNO,SP1,TWO,DIM127
          CALL      RDPTRGM1
          IF        OVRCD<>1
            WRITE     HTMLFILE;"<td>",PTRGREGM,"&nbsp;</td>";
          ELSE
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          PACK      KEY10,ADMISSNO,SP1,THREE,DIM127
          CALL      RDPTRGM1
          IF        OVRCD<>1
            WRITE     HTMLFILE;"<td>",PTRGREGM,"&nbsp;</td>";
          ELSE
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          GOTO      DOUT1000
.
DOUT9999  RETURN
+
.------------------------------------------------------------
. Displays Bed Management Ward View Heading
.------------------------------------------------------------
BDMH0000  WRITE     HTMLFILE;"<tr>";
          MOVE      ZERO,FORM3
.
          IF        STVCVIEW<>1
            WRITE     HTMLFILE;"<td class=HeadingCell>Time</td>";
          ENDIF
.
.         MOVE      TEN7,TMARRCNT
          MATCH     SP70,PTCNDOST
          IF        @EQUAL|@EOS
            MOVE      ONE,TMARRCNT
          ELSE
            MATCH     "00",PTCNDOST
            IF        @EQUAL
              MOVE      ONE,TMARRCNT
            ELSE
              SQUEEZE   PTCNDOST
              MOVE      PTCNDOST,TMARRCNT
            ENDIF
          ENDIF  
.
BDMH1000  UNPACK    TIMEARRY[TMARRCNT],DIM5
          WRITE   HTMLFILE;"<td class=HeadingCell>",DIM5,"</td>";
.
          IF        STVCVIEW=1
            IF        TMARRCNT=25
              WRITE     HTMLFILE;"<td class=HeadingCell>&nbsp;</td>";
            ENDIF
          ENDIF
            
 
.         COMPARE   THREE6,TMARRCNT
          MATCH     SP70,PTCNDOET
          IF        @EQUAL|@EOS
            COMPARE   FOUR8,TMARRCNT
          ELSE
            MATCH     "00",PTCNDOET
            IF        @EQUAL
              COMPARE   FOUR8,TMARRCNT
            ELSE
              SQUEEZE   PTCNDOET
              MOVE      PTCNDOET,FORM3
              COMPARE   FORM3,TMARRCNT
            ENDIF
          ENDIF
          GOTO      BDMH5000 IF EQUAL
.
          ADD       ONE,TMARRCNT
          GOTO      BDMH1000
.
BDMH5000  WRITE     HTMLFILE;"</tr>";
.
BDMH9999  RETURN
.
.------------------------------------------------------------
. Displays Bed Management Ward View Rows
.------------------------------------------------------------
BDMR0000  CALL      CLBM0000                   * Clear Bed Management Array
          MOVE      ZERO,FORM3
.
          MOVE      ZERO,OVERRIND
          CALL      BDAR0000                   * Populate Bed Management Array
.
          MOVE      ONE,OVERRIND
          CALL      BDAR0000                   * Populate Bed Management Array
.
          MOVE      TWO,OVERRIND
          CALL      BDAR0000                   * Populate Bed Management Array
.
.         MOVE      TEN7,TMARRCNT
          MATCH     SP70,PTCNDOST
          IF        @EQUAL|@EOS
            MOVE      ONE,TMARRCNT
          ELSE
            MATCH     "00",PTCNDOST
            IF        @EQUAL
              MOVE      ONE,TMARRCNT
            ELSE
              SQUEEZE   PTCNDOST
              MOVE      PTCNDOST,TMARRCNT
            ENDIF
          ENDIF
.
BDMR1000  CALL      CLBD0000                      * Find out if bed is closed
          CALL      BMRW0000
.
          IF        STVCVIEW=1
            COMPARE   TWENTY5,TMARRCNT
            IF        @EQUAL
            WRITE   HTMLFILE;"<td nowrap class=HeadingCell>",WBDESC,"</td>";
            ENDIF
          ENDIF
.         COMPARE   THREE6,TMARRCNT
          MATCH     SP70,PTCNDOET
          IF        @EQUAL|@EOS
            COMPARE   FOUR8,TMARRCNT
          ELSE      
            MATCH     "00",PTCNDOET
            IF        @EQUAL
              COMPARE   FOUR8,TMARRCNT
            ELSE
              SQUEEZE   PTCNDOET
              MOVE      PTCNDOET,FORM3
              COMPARE   FORM3,TMARRCNT
            ENDIF
          ENDIF
          GOTO      BDMR9999 IF EQUAL
.
          ADD       ONE,TMARRCNT
          GOTO      BDMR1000                     
.
BDMR9999  RETURN
.
.------------------------------------------------------------
. Set time array fields for appointment time classes
.------------------------------------------------------------
BMAR0000  MOVE      "00:00-00:29",TIMEARRY[1]
          MOVE      "00:30-00:59",TIMEARRY[2]
          MOVE      "01:00-01:59",TIMEARRY[3]
          MOVE      "01:30-01:59",TIMEARRY[4]
          MOVE      "02:00-02:29",TIMEARRY[5]
          MOVE      "02:30-02:59",TIMEARRY[6]
          MOVE      "03:00-03:29",TIMEARRY[7]
          MOVE      "03:30-03:59",TIMEARRY[8]
          MOVE      "04:00-04:29",TIMEARRY[9]
          MOVE      "04:30-04:59",TIMEARRY[10]
          MOVE      "05:00-05:29",TIMEARRY[11]
          MOVE      "05:30-05:59",TIMEARRY[12]
          MOVE      "06:00-06:29",TIMEARRY[13]
          MOVE      "06:30-06:59",TIMEARRY[14]
          MOVE      "07:00-07:29",TIMEARRY[15]
          MOVE      "07:30-07:59",TIMEARRY[16]
          MOVE      "08:00-08:29",TIMEARRY[17]
          MOVE      "08:30-08:59",TIMEARRY[18]
          MOVE      "09:00-09:29",TIMEARRY[19]
          MOVE      "09:30-09:59",TIMEARRY[20]
          MOVE      "10:00-10:29",TIMEARRY[21]
          MOVE      "10:30-10:59",TIMEARRY[22]
          MOVE      "11:00-11:29",TIMEARRY[23]
          MOVE      "11:30-11:59",TIMEARRY[24]
          MOVE      "12:00-12:29",TIMEARRY[25]
          MOVE      "12:30-12:59",TIMEARRY[26]
          MOVE      "13:00-13:29",TIMEARRY[27]
          MOVE      "13:30-13:59",TIMEARRY[28]
          MOVE      "14:00-14:29",TIMEARRY[29]
          MOVE      "14:30-14:59",TIMEARRY[30]
          MOVE      "15:00-15:29",TIMEARRY[31]
          MOVE      "15:30-15:59",TIMEARRY[32]
          MOVE      "16:00-16:29",TIMEARRY[33]
          MOVE      "16:30-16:59",TIMEARRY[34]
          MOVE      "17:00-17:29",TIMEARRY[35]
          MOVE      "17:30-17:59",TIMEARRY[36]
          MOVE      "18:00-18:29",TIMEARRY[37]
          MOVE      "18:30-18:59",TIMEARRY[38]
          MOVE      "19:00-19:29",TIMEARRY[39]
          MOVE      "19:30-19:59",TIMEARRY[40]
          MOVE      "20:00-20:29",TIMEARRY[41]
          MOVE      "20:30-20:59",TIMEARRY[42]
          MOVE      "21:00-21:29",TIMEARRY[43]
          MOVE      "21:30-21:59",TIMEARRY[44]
          MOVE      "22:00-22:29",TIMEARRY[45]
          MOVE      "22:30-22:59",TIMEARRY[46]
          MOVE      "23:00-23:29",TIMEARRY[47]
          MOVE      "23:30-23:59",TIMEARRY[48]
.
BMAR9999  RETURN
.
.------------------------------------------------------------
. Clear the Bed Management Array
.------------------------------------------------------------
CLBM0000  MOVE      ONE,TMARRCNT
.
CLBM1000  MOVE      SP70,TMBDARRY[TMARRCNT]
.
          COMPARE   FOUR8,TMARRCNT
          GOTO      CLBM9999 IF EQUAL
.
          ADD       ONE,TMARRCNT
.
          GOTO      CLBM1000
.
CLBM9999  RETURN
.
.------------------------------------------------------------
. Populate Bed Management Array
.------------------------------------------------------------
BDAR0000  PACK      KEY30,WWARD,WBED,LASTDATE,SP70
          CALL      RSPTBMD1
BDAR1000  CALL      RKPTBMD1
          BRANCH    OVRCD,BDAR9999
.
          MATCH     WWARD,PTBDWARD
          GOTO      BDAR9999 IF NOT EQUAL
.
          MATCH     WBED,PTBDWBED
          GOTO      BDAR9999 IF NOT EQUAL
.
          MATCH     PTBDDATE,LASTDATE
          GOTO      BDAR9999 IF NOT EQUAL
.
.         MATCH     "4",PTBDSTAT
.         GOTO      BDAR1000 IF EQUAL
.
          MOVE      SP70,TEMPURNO
          MATCH     "1",PTBDSTAT
          IF        @EQUAL
            PACK      KEY8,PTBDADMN,SP70
            CALL      RDBKREC1
            IF        OVRCD=0
              COMPARE   TWO,BKRESTAT
              GOTO      BDAR1000 IF EQUAL
              MOVE      BKREURNO,TEMPURNO
            ENDIF
          ELSE
            PACK      KEY8,PTBDADMN,SP70
            CALL      RDMISS1
            IF        OVRCD=0
              MATCH     "5",DASTAT
              GOTO      BDAR1000 IF EQUAL
              MOVE      AURNO,TEMPURNO
            ENDIF
          ENDIF 
.
          CALL      GETRGM00
.
          IF        OVERRIND=1
            MATCH     "0",PTBDOVER
            GOTO      BDAR1000 IF NOT EQUAL
          ENDIF
.
          IF        OVERRIND=2
            PACK      KEY10,PTBDADMN,SP70
            CALL      RSPTRGM1
BDAR2000    CALL      RKPTRGM1 
            BRANCH    OVRCD,BDAR1000
.
            MATCH     PTBDADMN,PTRGADMN
            GOTO      BDAR1000 IF NOT EQUAL
.
            MATCH     SP70,PTRGREGM
            GOTO      BDAR2000 IF EQUAL
            GOTO      BDAR2000 IF EOS
.
            PACK      KEY13,PTRGREGM,SP1,SP1,ZERO,SP70
            CALL      RDPMREG1
            BRANCH    OVRCD,BDAR2000
.
            MATCH     SP70,PMRESNCD
            GOTO      BDAR2000 IF EQUAL
            GOTO      BDAR2000 IF EOS
.
            PACK      KEY5,CODS,CODN,PMRESNCD,SP70
            CALL      RDCODE1
            BRANCH    OVRCD,BDAR2000            
.
            MATCH     "M",TCINDC1
            IF        @EQUAL
              MOVE      "5",TEMPSTAT
              GOTO      BDAR3000
            ENDIF
.
            MATCH     "B",TCINDC1
            IF        @EQUAL
              MOVE      "6",TEMPSTAT
              GOTO      BDAR3000
            ENDIF
.
            MATCH     "A",TCINDC1
            IF        @EQUAL
              MOVE      "7",TEMPSTAT
              GOTO      BDAR3000
            ENDIF
.
          ENDIF
.
          MOVE      PTBDSTAT,TEMPSTAT
.
BDAR3000  MATCH     "00:00",PTBDADTM
          IF        @EQUAL
            GOTO      BDAR1000
          ELSE
            MATCH     SP70,PTBDLOSM
            IF        !@EQUAL & !@EOS
              MOVE      ZERO,FORM5
              MOVE      PTBDLOSM,FORM5
.
              IF        FORM5=0
                GOTO      BDAR1000
              ENDIF
            ELSE
              GOTO      BDAR1000
            ENDIF
          ENDIF
.
          CALL      GEND0000
.
          CALL      BARY0000
.
          GOTO      BDAR1000
.
BDAR9999  RETURN 
.
.------------------------------------------------------------
. Populate Bed Management Array Detail
.------------------------------------------------------------
BARY0000  MOVE      ONE,TMARRCNT
          MOVE      ZERO,FIRSTCEL
.
BARY1000  UNPACK    TIMEARRY[TMARRCNT],DIM5,DIM1,DIM5A
.
          MATCH     DIM5,PTBDADTM
          GOTO      BARY1100 IF LESS
.
          MATCH     PTBDADTM,DIM5A
          GOTO      BARY3000 IF LESS
.
          GOTO      BARY2000
.
BARY1100  MATCH     DIM5,EXPDSTME
          GOTO      BARY3000 IF LESS
.
BARY2000  MOVE      FIRSTCEL,DIM2
          REP       " 0",DIM2
      PACK      TMBDARRY[TMARRCNT],PTBDADMN,TEMPSTAT,DIM2,TEMPURNO,PTBDSTAT,SAVEREGM,PTBDBRQN,SP70
          ADD       ONE,FIRSTCEL
.
BARY3000  COMPARE   FOUR8,TMARRCNT
          GOTO      BARY9999 IF EQUAL
.
          ADD       ONE,TMARRCNT
          GOTO      BARY1000
.
BARY9999  RETURN
.
.------------------------------------------------------------
. Get end time
.------------------------------------------------------------
GEND0000  MATCH     SP70,PTBDLOSM
          IF        !@EQUAL & !@EOS
            MOVE      ZERO,FORM5
            MOVE      PTBDLOSM,FORM5
.
            IF        FORM5>0
              GOTO      GEND5000
            ENDIF
          ENDIF
.
          MATCH     SP70,PTBDLOSD
          IF        !@EQUAL|!@EOS
            MATCH     "  0",PTBDLOSD
            IF        !@EQUAL
              MOVE      "23:59",EXPDSTME
              GOTO      GEND9999
            ENDIF
          ENDIF
.
GEND5000  MOVE      PTBDADTM,STRTTIME
          MOVE      PTBDLOSM,ADJTIME
          CALL      CLDUR000
          MOVE      KEY5,EXPDSTME
.
GEND9999  RETURN
.
.-----------------------------------------------------------------------------
. CLDUR000 - Calculate Expected Discharge Time
.-----------------------------------------------------------------------------
.
CLDUR000  UNPACK    STRTTIME,CHOUR,ANS,CMIN * unpack the start time
          MOVE      CMIN,FORM2              * minutes as a form2
          MOVE      FORM2,FORM4A            * set up work variable
          ADD       ADJTIME,FORM4A          * the total minutes to add
.
CLDUR200  COMPARE   ZERO,FORM4A
          GOTO      CLDUR300 IF NOT LESS    * positve amount
.
          ADD       "60",FORM4A             * make it positive
          MOVE      CHOUR,OPTION
          SUB       ONE,OPTION
          MOVE      OPTION,CHOUR            * sub 1 hour off time
          GOTO      CLDUR200
.
CLDUR300  MOVE      FORM4A,FORM4B           * save the minutes
.
          DIV       "60",FORM4A             * the total hours to add
          MOVE      CHOUR,FORM2             * hours as a form
          ADD       FORM4A,FORM2            * add the hours
.
CLDUR400  COMPARE   "24",FORM2
          GOTO      CLDUR500 IF LESS        * below 24 hours
.
          SUB       "24",FORM2              * get back to 24 hour time
          GOTO      CLDUR400
.
CLDUR500  MOVE      FORM2,CHOUR             * set up the hours
.
          MULT      "60",FORM4A             * the total minutes added
          SUB       FORM4A,FORM4B           * the minutes to add
          MOVE      FORM4B,FORM2            * get minutes as form2
.
          COMPARE   ZERO,FORM2
          GOTO      CLDUR800 IF NOT LESS    * not negative
.
          ADD       "60",FORM2              * make it positive
          MOVE      CHOUR,OPTION
          SUB       ONE,OPTION
          MOVE      OPTION,CHOUR            * sub 1 hour off time
.
CLDUR800  MOVE      FORM2,CMIN              * the minutes
.
          PACK      KEY5,CHOUR,COLON,CMIN * the end time
          REP       " 0",KEY5
.
CLDUR999  RETURN
.
.-----------------------------------------------------------------------------
. BMRW0000 - Display Bed Management Row
.-----------------------------------------------------------------------------
BMRW0000  UNPACK  SP70,DIM8,DIM1,DIM2,TEMPURNO,CELLCOLR,DIM1B,DIM10,DIM8A
          UNPACK  TMBDARRY[TMARRCNT],DIM8,DIM1,DIM2,TEMPURNO,DIM1B,DIM10,DIM8A
.
          MOVE      "WhiteCell",CELLCOLR
.
          PACK    KEY8,TEMPURNO,SP70
          CALL    RDMAST1
          IF      OVRCD=0
            MOVE    PGNAME,DIM1A
            PACK    DIM30,DIM1A,FULLSTOP,PSNAME
            REP     "'`@ * / : \ $ % & # ",DIM30
            UNPACK  PBDATE,CCENT,CYEAR,CMON,CDAY
            PACK    AGEDATE,CCC,CYY,CMM,CDD    * Today's date
            REP       " 0",AGEDATE
            CALL    CALCAGE
            CALL    FMTA0000
          ENDIF
.
          PACK    KEY8,DIM8,SP70
          CALL    RDBKREC1
          IF      OVRCD=1
            CALL    CLBOKRC1
          ENDIF
          CALL    RDMISS1
          IF      OVRCD=1
            CALL    CLPATMIS
            PACK    ADATE,BKREEDAT
            PACK    ATIME,BKREATIM
            PACK    ACLSSFT,BKREDEPT
            PACK    ADOCTA,BKREADOC
            PACK    AFUNDH,PFUNDH
            PACK    AFNDTB,PFNDTB
          ENDIF
.
          PACK      KEY18,DIM8,SP70
          CALL      RABKDIA1
          CALL      RKBKDIA1
          IF        OVRCD<>1
            MATCH   DIM8,DBKDIBOO
            IF      @EQUAL
              MOVE    BKDIDES1,ADIAG1
            ENDIF
          ENDIF
.
          MOVE    ONE,FORM1
          MOVE    SP70,DIM40A
          CALL    GRGM0000
          MOVE    DIM40,DIM40A
.
          MOVE    TWO,FORM1
          MOVE    SP70,DIM40B
          CALL    GRGM0000
          MOVE    DIM40,DIM40B
.
          MOVE    THREE,FORM1
          MOVE    SP70,DIM40C
          CALL    GRGM0000
          MOVE    DIM40,DIM40C
.
BMRW0100  MATCH   "1",DIM1
          IF      @EQUAL
            MOVE    "ExpectedCell",CELLCOLR
          ENDIF
.
          MATCH   "2",DIM1
          IF      @EQUAL
            MOVE    "ExpectedCell",CELLCOLR
          ENDIF
.
          MATCH   "3",DIM1
          IF      @EQUAL
            MOVE    "AdmittedCell",CELLCOLR
          ENDIF
.
          MATCH   SP70,DIM8A
          IF      !@EQUAL & !@EOS
            MOVE    "BedReqCell",CELLCOLR
          ENDIF
.
          MATCH   "5",DIM1
          IF      @EQUAL
            MOVE    "BoneMarCell",CELLCOLR
          ENDIF
.
          MATCH   "6",DIM1
          IF      @EQUAL
            MOVE    "BladderCell",CELLCOLR
          ENDIF
.
          MATCH   "7",DIM1
          IF      @EQUAL
            MOVE    "AutoVenCell",CELLCOLR
          ENDIF
.
          MOVE      PURNO,URNUMBER
          REP       " +",URNUMBER
.
.------------------------------------------------------------------------------
. Patient's 00 Cell: Demographics Folder and Edit Icon
.------------------------------------------------------------------------------
          MATCH     "00",DIM2
          IF        @EQUAL
.
            CALL    FLDR0000              * set foldrnam - with icon filename
.
            WRITE   HTMLFILE;"<td nowrap class=",CELLCOLR,">":
                             "<img src=../images/",FOLDRNAM:
                             " class=ListIcon ":
                             " onmouseover='status=#"Patient Name: ",DIM30:
                             "    UR Number:",PURNO:
                             "    Vis Number: ",DIM8," ";
.
            MATCH   SP70,DIM8A
            IF      !@EQUAL & !@EOS
              WRITE   HTMLFILE;" Linked Admno: ",DIM8A;
            ELSE
              WRITE   HTMLFILE;"    Age/Gender: ",FMTPATAG,COMMA,PSEX," ";
            ENDIF
.
            WRITE   HTMLFILE;"    Admission Date:";
.
            MATCH     SP70,ADATE
            IF        !@EQUAL
              UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
              MOVE      CMON,F2
              LOAD    MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
              PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
              WRITE     HTMLFILE;DISPDATE;
            ENDIF
.
            WRITE     HTMLFILE;"Exp.Discharge Date: ";
            PACK      KEY8,DIM8,SP70
            CALL      RDPMWOR1
            IF        OVRCD<>1
              MATCH     SP70,PMWOEDAT
              IF        !@EQUAL
                UNPACK    PMWOEDAT,CCENT,CYEAR,CMON,CDAY
                MOVE      CMON,F2
                LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG:
                                     SEP,OCT,NOV,DEC
                WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
              ENDIF
            ENDIF
.
            REP       "#" ",ADIAG1
            REP       "#' ",ADIAG1
.
            WRITE     HTMLFILE;"Diagnosis: ",ADIAG1;
.
            WRITE     HTMLFILE;"Speciality: ";
            MATCH     SP70,ACLSSFT
            IF        !@EQUAL
              PACK      KEY5,ANSA,ANSC,ACLSSFT,SP70
              CALL      RDCODE1
              IF        OVRCD<>1
                WRITE     HTMLFILE;TDESC;
              ENDIF
            ENDIF
.
            WRITE     HTMLFILE;"Doctor: ";
            MATCH     SP70,ADOCTA
            IF        !@EQUAL
              MOVE      SP70,DOCFNAME
              PACK      KEY10,ADOCTA,SP70
              CALL      RDPMHCP1
              IF        OVRCD<>1
                MOVE      PMHCTITL,FMTTITLE
                MOVE      PMHCGNAM,FMTGNAME
                MOVE      PMHCSNAM,FMTSNAME
                CALL      DOCNM000
                REP       "'`",DOCFNAME
                WRITE     HTMLFILE;DOCFNAME;
              ENDIF
            ENDIF
.
            WRITE    HTMLFILE;"Health Fund: ";
.
            MATCH     SP70,AFUNDH
            IF        !@EQUAL
              PACK      KEY14,AFUNDH,ZERO,ZERO,ZERO,ZERO,SP70
              CALL      RDFUND1
              IF        OVRCD<>1
                WRITE     HTMLFILE;HFNAME;
              ENDIF
              PACK      KEY14,AFUNDH,AFNDTB,SP70
              CALL      RDFUND1
              IF        OVRCD<>1
                WRITE     HTMLFILE;HFNAME;
              ENDIF
            ENDIF
.
            WRITE   HTMLFILE;"#";show_it(#"Patient Name: <b>",DIM30,"</b>":
                             " <br>UR Number: <b>",PURNO,"</b>":
                             " <br>Vis Number: ",DIM8;
.
            MATCH   SP70,DIM8A
            IF      !@EQUAL & !@EOS
              WRITE   HTMLFILE;" <br>Linked Admno: ",DIM8A;
            ELSE
              WRITE   HTMLFILE;" <br>Age/Gender: ",FMTPATAG,COMMA,PSEX," ";
            ENDIF
.
            WRITE   HTMLFILE;"<br>Admission Date:";
.
            MATCH     SP70,ADATE
            IF        !@EQUAL
              UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
              MOVE      CMON,F2
              LOAD    MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
              PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
              WRITE     HTMLFILE;DISPDATE;
            ENDIF
.
            WRITE     HTMLFILE;"<br>Exp.Discharge Date: ";
            PACK      KEY8,DIM8,SP70
            CALL      RDPMWOR1
            IF        OVRCD<>1
              MATCH     SP70,PMWOEDAT
              IF        !@EQUAL
                UNPACK    PMWOEDAT,CCENT,CYEAR,CMON,CDAY
                MOVE      CMON,F2
                LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG:
                                     SEP,OCT,NOV,DEC
                WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
              ENDIF
            ENDIF
            REP       "#" ",ADIAG1
            REP       "#' ",ADIAG1
.
            WRITE     HTMLFILE;"<br>Diagnosis: ",ADIAG1;
.
            WRITE     HTMLFILE;"<br>Speciality: ";
            MATCH     SP70,ACLSSFT
            IF        !@EQUAL
              PACK      KEY5,ANSA,ANSC,ACLSSFT,SP70
              CALL      RDCODE1
              IF        OVRCD<>1
                WRITE     HTMLFILE;TDESC;
              ENDIF
            ENDIF
.
            WRITE     HTMLFILE;"<br>Doctor: <b>";
            MATCH     SP70,ADOCTA
            IF        !@EQUAL
              MOVE      SP70,DOCFNAME
              PACK      KEY10,ADOCTA,SP70
              CALL      RDPMHCP1
              IF        OVRCD<>1
                MOVE      PMHCTITL,FMTTITLE
                MOVE      PMHCGNAM,FMTGNAME
                MOVE      PMHCSNAM,FMTSNAME
                CALL      DOCNM000
                REP       "'`",DOCFNAME
                WRITE     HTMLFILE;DOCFNAME;
              ENDIF
            ENDIF
.
            WRITE    HTMLFILE;"</b>";
.           WRITE    HTMLFILE;"</b><br>Health Fund: ";
.
.           MATCH     SP70,AFUNDH
.           IF        !@EQUAL
.             PACK      KEY14,AFUNDH,ZERO,ZERO,ZERO,ZERO,SP70
.             CALL      RDFUND1
.             IF        OVRCD<>1
.               WRITE     HTMLFILE;HFNAME;
.             ENDIF
.             PACK      KEY14,AFUNDH,AFNDTB,SP70
.             CALL      RDFUND1
.             IF        OVRCD<>1
.               WRITE     HTMLFILE;HFNAME;
.             ENDIF
.           ENDIF
.
            WRITE   HTMLFILE;"<br>Patient Tel: ";
.
            MATCH   SP70,PTELEP
            IF      !@EQUAL
              REP       "'`",PTELEP
              WRITE   HTMLFILE;PTELEP;
            ENDIF
.
            WRITE   HTMLFILE;"<br>Regime 1: ";
.
            MATCH   SP70,DIM40A
            IF      !@EQUAL
              WRITE   HTMLFILE;DIM40A;
            ENDIF
.
            WRITE   HTMLFILE;"<br>Regime 2: ";
.
            MATCH   SP70,DIM40B
            IF      !@EQUAL
              WRITE   HTMLFILE;DIM40B;
            ENDIF
.
            WRITE   HTMLFILE;"<br>Regime 3: ";
.
            MATCH   SP70,DIM40C
            IF      !@EQUAL
              WRITE   HTMLFILE;DIM40C;
            ENDIF
.
            MOVE    DIM8,BMCMDIM8
            CALL    BMCM0000
.
            WRITE   HTMLFILE;"#");'" :
                             " onmouseout='hide_it(); status=#" #"'":
                             " onclick='status=#"#";location.href=#"",LINKPRG,".pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&urnumber=",URNUMBER:
                             "&admissno=",DIM8:
                             "#";'>";
            BRANCH    VIEWONLY,BMRW9999
.
            WRITE     HTMLFILE;"<img src=../images/EditIcon.gif":
                             " class=ListIcon ":
                       " onmouseover='show_it(#"Patient Name: <b>",DIM30,"</b>":
                             " <br>UR Number: <b>",PURNO,"</b>":
                             " <br>Vis Number: ",DIM8;
.
            MATCH   SP70,DIM8A
            IF      !@EQUAL & !@EOS
              WRITE   HTMLFILE;" <br>Linked Admno: ",DIM8A;
            ELSE
              WRITE   HTMLFILE;" <br>Age/Gender: ",FMTPATAG,COMMA,PSEX," ";
            ENDIF
            WRITE   HTMLFILE;" <br>   Admission Date:";
.
            MATCH     SP70,ADATE
            IF        !@EQUAL
              UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
              MOVE      CMON,F2
              LOAD    MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
              PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
              WRITE     HTMLFILE;DISPDATE;
            ENDIF
.
            WRITE     HTMLFILE;"<br>Exp.Discharge Date: ";
            PACK      KEY8,DIM8,SP70
            CALL      RDPMWOR1
            IF        OVRCD<>1
              MATCH     SP70,PMWOEDAT
              IF        !@EQUAL
                UNPACK    PMWOEDAT,CCENT,CYEAR,CMON,CDAY
                MOVE      CMON,F2
                LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG:
                                     SEP,OCT,NOV,DEC
                WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
              ENDIF
            ENDIF
.
            REP       "#" ",ADIAG1
            REP       "#' ",ADIAG1
.
            WRITE     HTMLFILE;"<br>Diagnosis: ",ADIAG1;
.
            WRITE     HTMLFILE;"<br>Speciality: ";
            MATCH     SP70,ACLSSFT
            IF        !@EQUAL
              PACK      KEY5,ANSA,ANSC,ACLSSFT,SP70
              CALL      RDCODE1
              IF        OVRCD<>1
                WRITE     HTMLFILE;TDESC;
              ENDIF
            ENDIF
.
            WRITE     HTMLFILE;"<br>Doctor: <b>";
            MATCH     SP70,ADOCTA
            IF        !@EQUAL
              MOVE      SP70,DOCFNAME
              PACK      KEY10,ADOCTA,SP70
              CALL      RDPMHCP1
              IF        OVRCD<>1
                MOVE      PMHCTITL,FMTTITLE
                MOVE      PMHCGNAM,FMTGNAME
                MOVE      PMHCSNAM,FMTSNAME
                CALL      DOCNM000
                REP       "'`",DOCFNAME
                WRITE     HTMLFILE;DOCFNAME;
              ENDIF
            ENDIF
.
            WRITE    HTMLFILE;"</b>";
.           WRITE    HTMLFILE;"</b><br>Health Fund: ";
.
.           MATCH     SP70,AFUNDH
.           IF        !@EQUAL
.             PACK      KEY14,AFUNDH,ZERO,ZERO,ZERO,ZERO,SP70
.             CALL      RDFUND1
.             IF        OVRCD<>1
.               WRITE     HTMLFILE;HFNAME;
.             ENDIF
.             PACK      KEY14,AFUNDH,AFNDTB,SP70
.             CALL      RDFUND1
.             IF        OVRCD<>1
.               WRITE     HTMLFILE;HFNAME;
.             ENDIF
.           ENDIF
.
            WRITE   HTMLFILE;"<br>Patient Tel: ";
.
            MATCH   SP70,PTELEP
            IF      !@EQUAL
              REP       "'`",PTELEP
              WRITE   HTMLFILE;PTELEP;
            ENDIF
.
            WRITE   HTMLFILE;"<br>Regime 1: ";
.
            MATCH   SP70,DIM40A
            IF      !@EQUAL
              WRITE   HTMLFILE;DIM40A;
            ENDIF
.
            WRITE   HTMLFILE;"<br>Regime 2: ";
.
            MATCH   SP70,DIM40B
            IF      !@EQUAL
              WRITE   HTMLFILE;DIM40B;
            ENDIF
.
            WRITE   HTMLFILE;"<br>Regime 3: ";
.
            MATCH   SP70,DIM40C
            IF      !@EQUAL
              WRITE   HTMLFILE;DIM40C;
            ENDIF
.
            MOVE    DIM8,BMCMDIM8
            CALL    BMCM0000
.
            WRITE   HTMLFILE;"#"); status=#"Patient Name: ",DIM30,"":
                             "    UR Number: ",PURNO,"":
                             "    Vis Number: ",DIM8," ";
.
            MATCH   SP70,DIM8A
            IF      !@EQUAL & !@EOS
              WRITE   HTMLFILE;" Linked Admno: ",DIM8A;
            ELSE
              WRITE   HTMLFILE;"     Age/Gender: ",FMTPATAG,COMMA,PSEX," ";
            ENDIF
.
            WRITE   HTMLFILE;"    Admission Date:";
.
            MATCH     SP70,ADATE
            IF        !@EQUAL
              UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
              MOVE      CMON,F2
              LOAD    MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
              PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
              WRITE     HTMLFILE;DISPDATE;
            ENDIF
.
            WRITE     HTMLFILE;"Exp.Discharge Date: ";
            PACK      KEY8,DIM8,SP70
            CALL      RDPMWOR1
            IF        OVRCD<>1
              MATCH     SP70,PMWOEDAT
              IF        !@EQUAL
                UNPACK    PMWOEDAT,CCENT,CYEAR,CMON,CDAY
                MOVE      CMON,F2
                LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG:
                                     SEP,OCT,NOV,DEC
                WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
              ENDIF
            ENDIF
.
            REP       "#" ",ADIAG1
            REP       "#' ",ADIAG1
.
            WRITE     HTMLFILE;"Diagnosis: ",ADIAG1;
.
            WRITE     HTMLFILE;"Speciality: ";
            MATCH     SP70,ACLSSFT
            IF        !@EQUAL
              PACK      KEY5,ANSA,ANSC,ACLSSFT,SP70
              CALL      RDCODE1
              IF        OVRCD<>1
                WRITE     HTMLFILE;TDESC;
              ENDIF
            ENDIF
.
            WRITE     HTMLFILE;"Doctor: ";
            MATCH     SP70,ADOCTA
            IF        !@EQUAL
              MOVE      SP70,DOCFNAME
              PACK      KEY10,ADOCTA,SP70
              CALL      RDPMHCP1
              IF        OVRCD<>1
                MOVE      PMHCTITL,FMTTITLE
                MOVE      PMHCGNAM,FMTGNAME
                MOVE      PMHCSNAM,FMTSNAME
                CALL      DOCNM000
                REP       "'`",DOCFNAME
                WRITE     HTMLFILE;DOCFNAME;
              ENDIF
            ENDIF
.
            WRITE    HTMLFILE;"Health Fund: ";
.
            MATCH     SP70,AFUNDH
            IF        !@EQUAL
              PACK      KEY14,AFUNDH,ZERO,ZERO,ZERO,ZERO,SP70
              CALL      RDFUND1
              IF        OVRCD<>1
                WRITE     HTMLFILE;HFNAME;
              ENDIF
              PACK      KEY14,AFUNDH,AFNDTB,SP70
              CALL      RDFUND1
              IF        OVRCD<>1
                WRITE     HTMLFILE;HFNAME;
              ENDIF
            ENDIF
.
            WRITE   HTMLFILE;"#"'" :
                             " onmouseout='hide_it();status=#" #"'";
.
            MATCH   "1",DIM1B
            IF      @EQUAL
              WRITE   HTMLFILE;" onclick='status=#"#";":
                               " SetCookie(#"BMRDCookie#",location.href);":
                               " location.href=#"oprweb01.pbl":
                               "?reportno=07":
                               "&template=001":
                               "&urnumber=",URNUMBER:
                               "&admissno=",DIM8:
                               "#";'>":
                               "</td>";
              GOTO    BMRW9999
            ENDIF
.
            MATCH   "2",DIM1B
            IF      @EQUAL
              WRITE   HTMLFILE;" onclick='location.href=#"patweb89.pbl":
                               "?reportno=01":
                               "&template=032":
                               "&urnumber=",URNUMBER:
                               "&admissno=",DIM8:
                               "#";'>":
                               "</td>";
              GOTO    BMRW9999
            ENDIF
.
            MATCH   "3",DIM1B
            IF      @EQUAL
              WRITE   HTMLFILE;" onclick='location.href=#"patweb89.pbl":
                               "?reportno=01":
                               "&template=030":
                               "&urnumber=",URNUMBER:
                               "&admissno=",DIM8:
                               "#";'>":
                               "</td>";
              GOTO    BMRW9999
            ENDIF
.
            WRITE   HTMLFILE;" onclick='location.href=#"patweb98.pbl":
                             "?reportno=01":
                             "&template=001":
                             "&urnumber=",URNUMBER:
                             "&admissno=",DIM8:
                             "#";'>":
                             "</td>";
            GOTO    BMRW9999
          ENDIF
.
.------------------------------------------------------------------------------
. Patient's 02 Cell: UR Number
.------------------------------------------------------------------------------
.
          MATCH     "02",DIM2
          IF        @EQUAL
            WRITE   HTMLFILE;"<td class=",CELLCOLR:
                     " onmouseover='show_it(#"Patient Name: <b>",DIM30,"</b>":
                             " <br>UR Number: <b>",PURNO,"</b>":
                             " <br>Vis Number: ",DIM8;
.
            MATCH   SP70,DIM8A
            IF      !@EQUAL & !@EOS
              WRITE   HTMLFILE;" <br>Linked Admno: ",DIM8A;
            ELSE
              WRITE   HTMLFILE;" <br>Age/Gender: ",FMTPATAG,COMMA,PSEX," ";
            ENDIF
            WRITE   HTMLFILE;"<br> Admission Date:";
.
            MATCH     SP70,ADATE
            IF        !@EQUAL
              UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
              MOVE      CMON,F2
              LOAD    MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
              PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
              WRITE     HTMLFILE;DISPDATE;
            ENDIF
.
            WRITE     HTMLFILE;"<br>Exp.Discharge Date: ";
            PACK      KEY8,DIM8,SP70
            CALL      RDPMWOR1
            IF        OVRCD<>1
              MATCH     SP70,PMWOEDAT
              IF        !@EQUAL
                UNPACK    PMWOEDAT,CCENT,CYEAR,CMON,CDAY
                MOVE      CMON,F2
                LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG:
                                     SEP,OCT,NOV,DEC
                WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
              ENDIF
            ENDIF
.
            REP       "#" ",ADIAG1
            REP       "#' ",ADIAG1
.
            WRITE     HTMLFILE;"<br>Diagnosis: ",ADIAG1;
.
            WRITE     HTMLFILE;"<br>Speciality: ";
            MATCH     SP70,ACLSSFT
            IF        !@EQUAL
              PACK      KEY5,ANSA,ANSC,ACLSSFT,SP70
              CALL      RDCODE1
              IF        OVRCD<>1
                WRITE     HTMLFILE;TDESC;
              ENDIF
            ENDIF
.
            WRITE     HTMLFILE;"<br>Doctor: <b>";
            MATCH     SP70,ADOCTA
            IF        !@EQUAL
              MOVE      SP70,DOCFNAME
              PACK      KEY10,ADOCTA,SP70
              CALL      RDPMHCP1
              IF        OVRCD<>1
                MOVE      PMHCTITL,FMTTITLE
                MOVE      PMHCGNAM,FMTGNAME
                MOVE      PMHCSNAM,FMTSNAME
                CALL      DOCNM000
                REP       "'`",DOCFNAME
                WRITE     HTMLFILE;DOCFNAME;
              ENDIF
            ENDIF
.
            WRITE    HTMLFILE;"</b>";
.           WRITE    HTMLFILE;"</b><br>Health Fund: ";
.
.           MATCH     SP70,AFUNDH
.           IF        !@EQUAL
.             PACK      KEY14,AFUNDH,ZERO,ZERO,ZERO,ZERO,SP70
.             CALL      RDFUND1
.             IF        OVRCD<>1
.               WRITE     HTMLFILE;HFNAME;
.             ENDIF
.             PACK      KEY14,AFUNDH,AFNDTB,SP70
.             CALL      RDFUND1
.             IF        OVRCD<>1
.               WRITE     HTMLFILE;HFNAME;
.             ENDIF
.           ENDIF
.
            WRITE   HTMLFILE;"<br>Patient Tel: ";
.
            MATCH   SP70,PTELEP
            IF      !@EQUAL  
              REP       "'`",PTELEP
              WRITE   HTMLFILE;PTELEP;
            ENDIF
.
            WRITE   HTMLFILE;"<br>Regime 1: ";
.
            MATCH   SP70,DIM40A
            IF      !@EQUAL
              WRITE   HTMLFILE;DIM40A;
            ENDIF
.
            WRITE   HTMLFILE;"<br>Regime 2: ";
.
            MATCH   SP70,DIM40B
            IF      !@EQUAL
              WRITE   HTMLFILE;DIM40B;
            ENDIF
.
            WRITE   HTMLFILE;"<br>Regime 3: ";
.
            MATCH   SP70,DIM40C
            IF      !@EQUAL
              WRITE   HTMLFILE;DIM40C;
            ENDIF
.
            MOVE    DIM8,BMCMDIM8
            CALL    BMCM0000
.
            WRITE   HTMLFILE;"#"); status=#"Patient Name: ",DIM30,"":
                     "    UR Number: ",PURNO,"":
                     "    Vis Number: ",DIM8," ";
.
            MATCH   SP70,DIM8A
            IF      !@EQUAL & !@EOS
              WRITE   HTMLFILE;" Linked Admno: ",DIM8A;
            ELSE
              WRITE   HTMLFILE;" Age/Gender: ",FMTPATAG,COMMA,PSEX," ";
            ENDIF
            WRITE   HTMLFILE;"    Admission Date:";
.
            REP       "#" ",ADIAG1
            REP       "#' ",ADIAG1
.
            WRITE     HTMLFILE;"Diagnosis: ",ADIAG1;
.
            WRITE     HTMLFILE;"Speciality: ";
            MATCH     SP70,ACLSSFT
            IF        !@EQUAL
              PACK      KEY5,ANSA,ANSC,ACLSSFT,SP70
              CALL      RDCODE1
              IF        OVRCD<>1
                WRITE     HTMLFILE;TDESC;
              ENDIF
            ENDIF
.
            WRITE     HTMLFILE;"Doctor: ";
            MATCH     SP70,ADOCTA
            IF        !@EQUAL
              MOVE      SP70,DOCFNAME
              PACK      KEY10,ADOCTA,SP70
              CALL      RDPMHCP1
              IF        OVRCD<>1
                MOVE      PMHCTITL,FMTTITLE
                MOVE      PMHCGNAM,FMTGNAME
                MOVE      PMHCSNAM,FMTSNAME
                CALL      DOCNM000
                REP       "'`",DOCFNAME
                WRITE     HTMLFILE;DOCFNAME;
              ENDIF
            ENDIF
.
            WRITE    HTMLFILE;"Health Fund: ";
.
            MATCH     SP70,AFUNDH
            IF        !@EQUAL
              PACK      KEY14,AFUNDH,ZERO,ZERO,ZERO,ZERO,SP70
              CALL      RDFUND1
              IF        OVRCD<>1
                WRITE     HTMLFILE;HFNAME;
              ENDIF
              PACK      KEY14,AFUNDH,AFNDTB,SP70
              CALL      RDFUND1
              IF        OVRCD<>1
                WRITE     HTMLFILE;HFNAME;
              ENDIF
            ENDIF
.
            MATCH     SP70,ADATE
            IF        !@EQUAL
              UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
              MOVE      CMON,F2
              LOAD    MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
              PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
              WRITE     HTMLFILE;DISPDATE;
            ENDIF
.
            WRITE     HTMLFILE;"Exp.Discharge Date: ";
            PACK      KEY8,DIM8,SP70
            CALL      RDPMWOR1
            IF        OVRCD<>1
              MATCH     SP70,PMWOEDAT
              IF        !@EQUAL
                UNPACK    PMWOEDAT,CCENT,CYEAR,CMON,CDAY
                MOVE      CMON,F2
                LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG:
                                     SEP,OCT,NOV,DEC
                WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
              ENDIF
            ENDIF
.
            REP       "#" ",ADIAG1
            REP       "#' ",ADIAG1
.
            WRITE     HTMLFILE;"Diagnosis: ",ADIAG1;
.
            WRITE     HTMLFILE;"Speciality: ";
            MATCH     SP70,ACLSSFT
            IF        !@EQUAL
              PACK      KEY5,ANSA,ANSC,ACLSSFT,SP70
              CALL      RDCODE1
              IF        OVRCD<>1
                WRITE     HTMLFILE;TDESC;
              ENDIF
            ENDIF
.
            WRITE     HTMLFILE;"Doctor: ";
            MATCH     SP70,ADOCTA
            IF        !@EQUAL
              MOVE      SP70,DOCFNAME
              PACK      KEY10,ADOCTA,SP70
              CALL      RDPMHCP1
              IF        OVRCD<>1
                MOVE      PMHCTITL,FMTTITLE
                MOVE      PMHCGNAM,FMTGNAME
                MOVE      PMHCSNAM,FMTSNAME
                CALL      DOCNM000
                REP       "'`",DOCFNAME
                WRITE     HTMLFILE;DOCFNAME;
              ENDIF
            ENDIF
.
            WRITE    HTMLFILE;"Health Fund: ";
.
            MATCH     SP70,AFUNDH
            IF        !@EQUAL
              PACK      KEY14,AFUNDH,ZERO,ZERO,ZERO,ZERO,SP70
              CALL      RDFUND1
              IF        OVRCD<>1
                WRITE     HTMLFILE;HFNAME;
              ENDIF
              PACK      KEY14,AFUNDH,AFNDTB,SP70
              CALL      RDFUND1
              IF        OVRCD<>1
                WRITE     HTMLFILE;HFNAME;
              ENDIF
            ENDIF
.
.
            WRITE   HTMLFILE;"#"'" :
                     " onmouseout='hide_it();status=#" #"'";

           MATCH   "1",DIM1B
           IF      @EQUAL
             IF      VIEWONLY<>1
             WRITE   HTMLFILE;" onclick='status=#"#";":
                              " SetCookie(#"BMRDCookie#",location.href);":
                              " location.href=#"oprweb01.pbl":
                              "?reportno=07":
                              "&template=001":
                              "&urnumber=",URNUMBER:
                              "&admissno=",DIM8:
                              "#";'";
             GOTO    BMRW0500
             ENDIF
           ENDIF
.
           MATCH   "2",DIM1B
           IF      @EQUAL
             IF      VIEWONLY<>1
             WRITE   HTMLFILE;" onclick='location.href=#"patweb89.pbl":
                              "?reportno=01":
                              "&template=032":
                              "&urnumber=",URNUMBER:
                              "&admissno=",DIM8:
                              "#";'";
             GOTO    BMRW0500
             ENDIF
           ENDIF
.
           MATCH   "3",DIM1B
           IF      @EQUAL
             IF      VIEWONLY<>1
             WRITE   HTMLFILE;" onclick='location.href=#"patweb89.pbl":
                              "?reportno=01":
                              "&template=030":
                              "&urnumber=",URNUMBER:
                              "&admissno=",DIM8:
                              "#";'";
             GOTO    BMRW0500
             ENDIF
           ENDIF
.
           WRITE   HTMLFILE;" onclick='location.href=#"patweb98.pbl":
                            "?reportno=01":
                            "&template=001":
                            "&urnumber=",URNUMBER:
                            "&admissno=",DIM8:
                            "#";'";

BMRW0500             MATCH   "1",DIM1B
                     IF      @EQUAL
                       WRITE   HTMLFILE;"><b>",DIM10,"&nbsp;</b></td>";
                     ELSE
                       WRITE   HTMLFILE;">",DIM10,"&nbsp;</td>";
                     ENDIF
            GOTO    BMRW9999
          ENDIF
.
.------------------------------------------------------------------------------
. Patient's 01 Cell: Patient Name
.------------------------------------------------------------------------------
.
          MATCH     "01",DIM2
          IF        @EQUAL
            WRITE   HTMLFILE;"<td class=",CELLCOLR:
                       " onmouseover='show_it(#"Patient Name: <b>",DIM30,"</b>":
                             " <br>UR Number: <b>",PURNO,"</b>":
                             " <br>Vis Number: ",DIM8;
.
            MATCH   SP70,DIM8A
            IF      !@EQUAL & !@EOS
              WRITE   HTMLFILE;" <br>Linked Admno: ",DIM8A;
            ELSE
              WRITE   HTMLFILE;" <br>Age/Gender: ",FMTPATAG,COMMA,PSEX," ";
            ENDIF
            WRITE   HTMLFILE;"  <br>  Admission Date:";
.
            MATCH     SP70,ADATE
            IF        !@EQUAL
              UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
              MOVE      CMON,F2
              LOAD    MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
              PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
              WRITE     HTMLFILE;DISPDATE;
            ENDIF
.
            WRITE     HTMLFILE;"<br>Exp.Discharge Date: ";
            PACK      KEY8,DIM8,SP70
            CALL      RDPMWOR1
            IF        OVRCD<>1
              MATCH     SP70,PMWOEDAT
              IF        !@EQUAL
                UNPACK    PMWOEDAT,CCENT,CYEAR,CMON,CDAY
                MOVE      CMON,F2
                LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG:
                                     SEP,OCT,NOV,DEC
                WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
              ENDIF
            ENDIF
.
            REP       "#" ",ADIAG1
            REP       "#' ",ADIAG1
.
            WRITE     HTMLFILE;"<br>Diagnosis: ",ADIAG1;
.
            WRITE     HTMLFILE;"<br>Speciality: ";
            MATCH     SP70,ACLSSFT
            IF        !@EQUAL
              PACK      KEY5,ANSA,ANSC,ACLSSFT,SP70
              CALL      RDCODE1
              IF        OVRCD<>1
                WRITE     HTMLFILE;TDESC;
              ENDIF
            ENDIF
.
            WRITE     HTMLFILE;"<br>Doctor: <b>";
            MATCH     SP70,ADOCTA
            IF        !@EQUAL
              MOVE      SP70,DOCFNAME
              PACK      KEY10,ADOCTA,SP70
              CALL      RDPMHCP1
              IF        OVRCD<>1
                MOVE      PMHCTITL,FMTTITLE
                MOVE      PMHCGNAM,FMTGNAME
                MOVE      PMHCSNAM,FMTSNAME
                CALL      DOCNM000
                REP       "'`",DOCFNAME
                WRITE     HTMLFILE;DOCFNAME;
              ENDIF
            ENDIF
.
            WRITE    HTMLFILE;"</b>";
.           WRITE    HTMLFILE;"</b><br>Health Fund: ";
.
.           MATCH     SP70,AFUNDH
.           IF        !@EQUAL
.             PACK      KEY14,AFUNDH,ZERO,ZERO,ZERO,ZERO,SP70
.             CALL      RDFUND1
.             IF        OVRCD<>1
.               WRITE     HTMLFILE;HFNAME;
.             ENDIF
.             PACK      KEY14,AFUNDH,AFNDTB,SP70
.             CALL      RDFUND1
.             IF        OVRCD<>1
.               WRITE     HTMLFILE;HFNAME;
.             ENDIF
.           ENDIF
.
            WRITE   HTMLFILE;"<br>Patient Tel: ";
.
            MATCH   SP70,PTELEP
            IF      !@EQUAL  
              REP       "'`",PTELEP
              WRITE   HTMLFILE;PTELEP;
            ENDIF
.
            WRITE   HTMLFILE;"<br>Regime 1: ";
.
            MATCH   SP70,DIM40A
            IF      !@EQUAL
              WRITE   HTMLFILE;DIM40A;
            ENDIF
.
            WRITE   HTMLFILE;"<br>Regime 2: ";
.
            MATCH   SP70,DIM40B
            IF      !@EQUAL
              WRITE   HTMLFILE;DIM40B;
            ENDIF
.
            WRITE   HTMLFILE;"<br>Regime 3: ";
.
            MATCH   SP70,DIM40C
            IF      !@EQUAL
              WRITE   HTMLFILE;DIM40C;
            ENDIF
.
            MOVE    DIM8,BMCMDIM8
            CALL    BMCM0000
.
            WRITE   HTMLFILE;"#"); status=#"Patient Name: ",DIM30,"":
                             "    UR Number: ",PURNO,"":
                             "    Vis Number: ",DIM8," ";
.
            MATCH   SP70,DIM8A
            IF      !@EQUAL & !@EOS
              WRITE   HTMLFILE;" Linked Admno: ",DIM8A;
            ELSE
              WRITE   HTMLFILE;" Age/Gender: ",FMTPATAG,COMMA,PSEX," ";
            ENDIF
.
            WRITE   HTMLFILE;"    Admission Date:";
.
            MATCH     SP70,ADATE
            IF        !@EQUAL
              UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
              MOVE      CMON,F2
              LOAD    MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
              PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
              WRITE     HTMLFILE;DISPDATE;
            ENDIF
.
            WRITE     HTMLFILE;"Exp.Discharge Date: ";
            PACK      KEY8,DIM8,SP70
            CALL      RDPMWOR1
            IF        OVRCD<>1
              MATCH     SP70,PMWOEDAT
              IF        !@EQUAL
                UNPACK    PMWOEDAT,CCENT,CYEAR,CMON,CDAY
                MOVE      CMON,F2
                LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG:
                                     SEP,OCT,NOV,DEC
                WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
              ENDIF
            ENDIF
.
            REP       "#" ",ADIAG1
            REP       "#' ",ADIAG1
.
            WRITE     HTMLFILE;"Diagnosis: ",ADIAG1;
.
            WRITE     HTMLFILE;"Speciality: ";
            MATCH     SP70,ACLSSFT
            IF        !@EQUAL
              PACK      KEY5,ANSA,ANSC,ACLSSFT,SP70
              CALL      RDCODE1
              IF        OVRCD<>1
                WRITE     HTMLFILE;TDESC;
              ENDIF
            ENDIF
.
            WRITE     HTMLFILE;"Doctor: ";
            MATCH     SP70,ADOCTA
            IF        !@EQUAL
              MOVE      SP70,DOCFNAME
              PACK      KEY10,ADOCTA,SP70
              CALL      RDPMHCP1
              IF        OVRCD<>1
                MOVE      PMHCTITL,FMTTITLE
                MOVE      PMHCGNAM,FMTGNAME
                MOVE      PMHCSNAM,FMTSNAME
                CALL      DOCNM000
                REP       "'`",DOCFNAME
                WRITE     HTMLFILE;DOCFNAME;
              ENDIF
            ENDIF
.
            WRITE    HTMLFILE;"Health Fund: ";
.
            MATCH     SP70,AFUNDH
            IF        !@EQUAL
              PACK      KEY14,AFUNDH,ZERO,ZERO,ZERO,ZERO,SP70
              CALL      RDFUND1
              IF        OVRCD<>1
                WRITE     HTMLFILE;HFNAME;
              ENDIF
              PACK      KEY14,AFUNDH,AFNDTB,SP70
              CALL      RDFUND1
              IF        OVRCD<>1
                WRITE     HTMLFILE;HFNAME;
              ENDIF
            ENDIF
.
            WRITE   HTMLFILE;"#"'" :
                             " onmouseout='hide_it();status=#" #"'";

             MATCH   "1",DIM1B
             IF      @EQUAL
               IF      VIEWONLY<>1
               WRITE   HTMLFILE;" onclick='status=#"#";":
                                " SetCookie(#"BMRDCookie#",location.href);":
                                " location.href=#"oprweb01.pbl":
                                "?reportno=07":
                                "&template=001":
                                "&urnumber=",URNUMBER:
                                "&admissno=",DIM8:
                                "#";'";
               GOTO    BMRW1000
               ENDIF
             ENDIF
.
             MATCH   "2",DIM1B
             IF      @EQUAL
               IF      VIEWONLY<>1
               WRITE   HTMLFILE;" onclick='location.href=#"patweb89.pbl":
                                "?reportno=01":
                                "&template=032":
                                "&urnumber=",URNUMBER:
                                "&admissno=",DIM8:
                                "#";'";
               GOTO    BMRW1000
               ENDIF
             ENDIF
.
             MATCH   "3",DIM1B
             IF      @EQUAL
               IF      VIEWONLY<>1
               WRITE   HTMLFILE;" onclick='location.href=#"patweb89.pbl":
                                "?reportno=01":
                                "&template=030":
                                "&urnumber=",URNUMBER:
                                "&admissno=",DIM8:
                                "#";'";
               GOTO    BMRW1000
               ENDIF
             ENDIF
.
             WRITE   HTMLFILE;" onclick='location.href=#"patweb98.pbl":
                              "?reportno=01":
                              "&template=001":
                              "&urnumber=",URNUMBER:
                              "&admissno=",DIM8:
                              "#";'";
.
BMRW1000    MATCH   "1",DIM1B
            IF      @EQUAL
              WRITE   HTMLFILE;"><b>",DIM30,"&nbsp;</b></td>";
            ELSE
              WRITE   HTMLFILE;">",DIM30,"&nbsp;</td>";
            ENDIF
            GOTO    BMRW9999
          ENDIF
.
.------------------------------------------------------------------------------
. Empty cells and patient's subsequent cells
.------------------------------------------------------------------------------
.
BMRW1300  MATCH     "WhiteCell",CELLCOLR
          IF        @EQUAL
            IF      CLBDINDC=1
              MOVE    "ClosedCell",CELLCOLR
              WRITE   HTMLFILE;"<td class=",CELLCOLR:
                               "><font color=white>CLOSED</font></td>";
            ELSE
               WRITE   HTMLFILE;"<td class=",CELLCOLR:
                       " onmouseover='show_it(#"Bed: <b>",WBED,"</b>":
                               " <br>Time: <b>",TIMEARRY[TMARRCNT],"</b>":
                               "#")'; status=#"Patient Name: ",DIM30,"#"":
                               " onmouseout='hide_it();status=#" #"'":
                           " onclick='status=#"#";location.href=#"watweb01.pbl":
                               "?reportno=02":
                               "&template=023":
                               "&bookward=",WWARD:
                               "&bookebed=",WBED:
                               "&bookdate=",LASTDATE:
                               "&booktime=",TIMEARRY[TMARRCNT]:
                               "#";'":
                               ">&nbsp;</td>";
            ENDIF
          ELSE
            WRITE   HTMLFILE;"<td class=",CELLCOLR:
                       " onmouseover='show_it(#"Patient Name: <b>",DIM30,"</b>":
                             " <br>UR Number: <b>",PURNO,"</b>":
                             " <br>Vis Number: ",DIM8;
.
            MATCH   SP70,DIM8A
            IF      !@EQUAL & !@EOS
              WRITE   HTMLFILE;" <br>Linked Admno: ",DIM8A;
            ELSE
              WRITE   HTMLFILE;" <br>Age/Gender: ",FMTPATAG,COMMA,PSEX," ";
            ENDIF
            WRITE   HTMLFILE;"<br>Admission Date:";
.
            MATCH     SP70,ADATE
            IF        !@EQUAL
              UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
              MOVE      CMON,F2
              LOAD    MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
              PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
              WRITE     HTMLFILE;DISPDATE;
            ENDIF
.
            WRITE     HTMLFILE;"<br>Exp.Discharge Date: ";
            PACK      KEY8,DIM8,SP70
            CALL      RDPMWOR1
            IF        OVRCD<>1
              MATCH     SP70,PMWOEDAT
              IF        !@EQUAL
                UNPACK    PMWOEDAT,CCENT,CYEAR,CMON,CDAY
                MOVE      CMON,F2
                LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG:
                                     SEP,OCT,NOV,DEC
                WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
              ENDIF
            ENDIF
.
            REP       "#" ",ADIAG1
            REP       "#' ",ADIAG1
.
            WRITE     HTMLFILE;"<br>Diagnosis: ",ADIAG1;
.
            WRITE     HTMLFILE;"<br>Speciality: ";
            MATCH     SP70,ACLSSFT
            IF        !@EQUAL
              PACK      KEY5,ANSA,ANSC,ACLSSFT,SP70
              CALL      RDCODE1
              IF        OVRCD<>1
                WRITE     HTMLFILE;TDESC;
              ENDIF
            ENDIF
.
            WRITE     HTMLFILE;"<br>Doctor: <b>";
            MATCH     SP70,ADOCTA
            IF        !@EQUAL
              MOVE      SP70,DOCFNAME
              PACK      KEY10,ADOCTA,SP70
              CALL      RDPMHCP1
              IF        OVRCD<>1
                MOVE      PMHCTITL,FMTTITLE
                MOVE      PMHCGNAM,FMTGNAME
                MOVE      PMHCSNAM,FMTSNAME
                CALL      DOCNM000
                REP       "'`",DOCFNAME
                WRITE     HTMLFILE;DOCFNAME;
              ENDIF
            ENDIF
.
            WRITE    HTMLFILE;"</b>";
.           WRITE    HTMLFILE;"</b><br>Health Fund: ";
.
.           MATCH     SP70,AFUNDH
.           IF        !@EQUAL
.             PACK      KEY14,AFUNDH,ZERO,ZERO,ZERO,ZERO,SP70
.             CALL      RDFUND1
.             IF        OVRCD<>1
.               WRITE     HTMLFILE;HFNAME;
.             ENDIF
.             PACK      KEY14,AFUNDH,AFNDTB,SP70
.             CALL      RDFUND1
.             IF        OVRCD<>1
.               WRITE     HTMLFILE;HFNAME;
.             ENDIF
.           ENDIF
.
            WRITE   HTMLFILE;"<br>Patient Tel: ";
.
            MATCH   SP70,PTELEP
            IF      !@EQUAL  
              REP       "'`",PTELEP
              WRITE   HTMLFILE;PTELEP;
            ENDIF
.
            WRITE   HTMLFILE;"<br>Regime 1: ";
.
            MATCH   SP70,DIM40A
            IF      !@EQUAL
              WRITE   HTMLFILE;DIM40A;
            ENDIF
.
            WRITE   HTMLFILE;"<br>Regime 2: ";
.
            MATCH   SP70,DIM40B
            IF      !@EQUAL
              WRITE   HTMLFILE;DIM40B;
            ENDIF
.
            WRITE   HTMLFILE;"<br>Regime 3: ";
.
            MATCH   SP70,DIM40C
            IF      !@EQUAL
              WRITE   HTMLFILE;DIM40C;
            ENDIF
.
            MOVE    DIM8,BMCMDIM8
            CALL    BMCM0000
.
            WRITE   HTMLFILE;"#"); status=#"Patient Name: ",DIM30,"":
                             "    UR Number: ",PURNO,"":
                             "    Vis Number: ",DIM8," ";
.
            MATCH   SP70,DIM8A
            IF      !@EQUAL & !@EOS
              WRITE   HTMLFILE;" Linked Admno: ",DIM8A;
            ELSE
              WRITE   HTMLFILE;" Age/Gender: ",FMTPATAG,COMMA,PSEX," ";
            ENDIF
.
            WRITE   HTMLFILE;"    Admission Date:";
.
            MATCH     SP70,ADATE
            IF        !@EQUAL
              UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
              MOVE      CMON,F2
              LOAD    MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
              PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
              WRITE     HTMLFILE;DISPDATE;
            ENDIF
.
            WRITE     HTMLFILE;"Exp.Discharge Date: ";
            PACK      KEY8,DIM8,SP70
            CALL      RDPMWOR1
            IF        OVRCD<>1
              MATCH     SP70,PMWOEDAT
              IF        !@EQUAL
                UNPACK    PMWOEDAT,CCENT,CYEAR,CMON,CDAY
                MOVE      CMON,F2
                LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG:
                                     SEP,OCT,NOV,DEC
                WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
              ENDIF
            ENDIF
.
            REP       "#" ",ADIAG1
            REP       "#' ",ADIAG1
.
            WRITE     HTMLFILE;"Diagnosis: ",ADIAG1;
.
            WRITE     HTMLFILE;"Speciality: ";
            MATCH     SP70,ACLSSFT
            IF        !@EQUAL
              PACK      KEY5,ANSA,ANSC,ACLSSFT,SP70
              CALL      RDCODE1
              IF        OVRCD<>1
                WRITE     HTMLFILE;TDESC;
              ENDIF
            ENDIF
.
            WRITE     HTMLFILE;"Doctor: ";
            MATCH     SP70,ADOCTA
            IF        !@EQUAL
              MOVE      SP70,DOCFNAME
              PACK      KEY10,ADOCTA,SP70
              CALL      RDPMHCP1
              IF        OVRCD<>1
                MOVE      PMHCTITL,FMTTITLE
                MOVE      PMHCGNAM,FMTGNAME
                MOVE      PMHCSNAM,FMTSNAME
                CALL      DOCNM000
                REP       "'`",DOCFNAME
                WRITE     HTMLFILE;DOCFNAME;
              ENDIF
            ENDIF
.
            WRITE    HTMLFILE;"Health Fund: ";
.
            MATCH     SP70,AFUNDH
            IF        !@EQUAL
              PACK      KEY14,AFUNDH,ZERO,ZERO,ZERO,ZERO,SP70
              CALL      RDFUND1
              IF        OVRCD<>1
                WRITE     HTMLFILE;HFNAME;
              ENDIF
              PACK      KEY14,AFUNDH,AFNDTB,SP70
              CALL      RDFUND1
              IF        OVRCD<>1
                WRITE     HTMLFILE;HFNAME;
              ENDIF
            ENDIF
.
            WRITE   HTMLFILE;"#"'" :
                             " onmouseout='hide_it();status=#" #"'";
.
            MATCH   "1",DIM1B
            IF      @EQUAL
              IF      VIEWONLY<>1
              WRITE   HTMLFILE;" onclick='status=#"#";":
                               " SetCookie(#"BMRDCookie#",location.href);":
                               " location.href=#"oprweb01.pbl":
                               "?reportno=07":
                               "&template=001":
                               "&urnumber=",URNUMBER:
                               "&admissno=",DIM8:
                               "#";'";
              GOTO    BMRW1500
              ENDIF
            ENDIF
.
            MATCH   "2",DIM1B
            IF      @EQUAL
              IF      VIEWONLY<>1
              WRITE   HTMLFILE;" onclick='location.href=#"patweb89.pbl":
                               "?reportno=01":
                               "&template=032":
                               "&urnumber=",URNUMBER:
                               "&admissno=",DIM8:
                               "#";'";
              GOTO    BMRW1500
              ENDIF
            ENDIF
.
            MATCH   "3",DIM1B
            IF      @EQUAL
              IF      VIEWONLY<>1
              WRITE   HTMLFILE;" onclick='location.href=#"patweb89.pbl":
                               "?reportno=01":
                               "&template=030":
                               "&urnumber=",URNUMBER:
                               "&admissno=",DIM8:
                               "#";'";
              GOTO    BMRW1500
              ENDIF
            ENDIF
.
            WRITE   HTMLFILE;" onclick='location.href=#"patweb98.pbl":
                             "?reportno=01":
                             "&template=001":
                             "&urnumber=",URNUMBER:
                             "&admissno=",DIM8:
                             "#";'";
.
BMRW1500    WRITE   HTMLFILE;">&nbsp;</td>";
          ENDIF
.
          MOVE      "WhiteCell",CELLCOLR
.
BMRW9999  RETURN
.
.------------------------------------------------------------
. Bed Management
.------------------------------------------------------------
BEDMAN00  MATCH     SP70,WARDCODE
          IF        @EQUAL
            MOVE      WBSEWRD,WARDCODE
          ENDIF
          PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,BEDMAN90
.
          MATCH     SP70,LASTDATE
          IF        @EQUAL | @EOS
            CALL      IBACLOCK
            PACK      LASTDATE,CCC,CYY,CMM,CDD
            REP       " 0",LASTDATE
          ENDIF
.
          CALL      CURPER00
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.
          CLEAR     WEBTITLE
          MOVE      WBDESC,KEY20       * EC changes
          APPEND    KEY20,WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00
          BRANCH    EXIT,BEDMAN99
.
          CALL      WEBBOD00
.
          CALL      WEBEND00
.
          GOTO      BEDMAN99
.
BEDMAN90  MOVE      "INVALID WARDCODE SPECIFIED",WEBTITLE
          CALL      WEBERR00
.
BEDMAN99  RETURN
.------------------------------------------------------------
. Get First available regime code
.------------------------------------------------------------
GETRGM00    MOVE      SP70,SAVEREGM
. 
            PACK      KEY10,PTBDADMN,SP70
            CALL      RSPTRGM1
GETRGM10    CALL      RKPTRGM1
            BRANCH    OVRCD,GETRGM99
.
            MATCH     PTBDADMN,PTRGADMN
            GOTO      GETRGM99 IF NOT EQUAL
.
            MATCH     SP70,PTRGREGM
            GOTO      GETRGM10 IF EQUAL
            GOTO      GETRGM10 IF EOS
.
            MOVE      PTRGREGM,SAVEREGM
.
GETRGM99  RETURN
.
.------------------------------------------------------------
. Displays Current Patient ward/bed details
.------------------------------------------------------------
BDBD0000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          CALL      BDDR0000                     * Set values in date array
          CALL      BDBH0000                     * Output headings
.
. Ward/Bed Details
.
BDBD1000  PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
BDBD2000  CALL      RDKWARD1
          BRANCH    OVRCD,BDBD9999
          MATCH     WARDCODE,WWARD
          GOTO      BDBD9999 IF NOT EQUAL
.
          BRANCH    WACTIVE,BDBD2000       * Do not display Inactive Beds
          MATCH     "1",PTWDBDST           * Do not display closed beds
          GOTO      BDBD2000 IF EQUAL
.
          WRITE     HTMLFILE;"<tr><td nowrap class=HeadingCell>",WBDESC,"</td>";
          CALL      BBRW0000
          WRITE     HTMLFILE;"</tr>";
.
          GOTO      BDBD2000
.
BDBD9999  RETURN
.
.------------------------------------------------------------
. Displays Bed Board View Heading
.------------------------------------------------------------
BDBH0000  WRITE     HTMLFILE;"<tr>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell>Date</td>";
.
          MOVE      ONE,DMARRCNT
.
BDBH1000  UNPACK    DATEARRY[DMARRCNT],DIM8
          UNPACK    DIM8,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          WRITE     HTMLFILE;"<td class=HeadingCell>",DISPDATE,"</td>";
.
          COMPARE   SEVEN,DMARRCNT
          GOTO      BDBH5000 IF EQUAL
.
          ADD       ONE,DMARRCNT
          GOTO      BDBH1000
.
BDBH5000  WRITE     HTMLFILE;"</tr>";
.
BDBH9999  RETURN
.
.------------------------------------------------------------
. Displays Bed Board Rows
.------------------------------------------------------------
BBRW0000  CALL      CLBB0000                   * Clear Bed Management Array
.
          CALL      BBAR0000                   * Populate Bed Management Array
.
          MOVE      ONE,DMARRCNT
.
BBRW1000  CALL      WMRW0000
.
          COMPARE   SEVEN,DMARRCNT
          GOTO      BBRW9999 IF EQUAL
.
          ADD       ONE,DMARRCNT
          GOTO      BBRW1000
.
BBRW9999  RETURN
.
.------------------------------------------------------------
. Set date array fields for classes
.------------------------------------------------------------
BDDR0000  MOVE      FRSTDATE,DATE8
          MOVE      DATE8,DATEARRY[1]
          ADD       ONE,DATE8
          MOVE      DATE8,DATEARRY[2]
          ADD       ONE,DATE8
          MOVE      DATE8,DATEARRY[3]
          ADD       ONE,DATE8
          MOVE      DATE8,DATEARRY[4]
          ADD       ONE,DATE8
          MOVE      DATE8,DATEARRY[5]
          ADD       ONE,DATE8
          MOVE      DATE8,DATEARRY[6]
          ADD       ONE,DATE8
          MOVE      DATE8,DATEARRY[7]
.
BDDR9999  RETURN
.
.------------------------------------------------------------
. Clear the Bed Board Array
.------------------------------------------------------------
CLBB0000  MOVE      ONE,DMARRCNT
.
CLBB1000  MOVE      SP70,DMBDARRY[DMARRCNT]
.
          COMPARE   SEVEN,DMARRCNT
          GOTO      CLBB9999 IF EQUAL
.
          ADD       ONE,DMARRCNT
.
          GOTO      CLBB1000
.
CLBB9999  RETURN
.
.------------------------------------------------------------
. Populate Bed Board Array
.------------------------------------------------------------
BBAR0000  PACK      KEY30,WWARD,WBED,FRSTDATE,SP70
          CALL      RSPTBMD1
BBAR1000  CALL      RKPTBMD1
          BRANCH    OVRCD,BBAR9999
.
          MATCH     WWARD,PTBDWARD
          GOTO      BBAR9999 IF NOT EQUAL
.
          MATCH     WBED,PTBDWBED
          GOTO      BBAR9999 IF NOT EQUAL
.
          MATCH     PTBDDATE,LASTDATE
          GOTO      BBAR9999 IF LESS
.
          MATCH     "4",PTBDSTAT                  * Discharged
          GOTO      BBAR1000 IF EQUAL
.
          MOVE      SP70,TEMPURNO
          MATCH     "1",PTBDSTAT                  * Booked
          IF        @EQUAL
            PACK      KEY8,PTBDADMN,SP70
            CALL      RDBKREC1
            IF        OVRCD=0
              COMPARE   TWO,BKRESTAT              * Cancelled
              GOTO      BBAR1000 IF EQUAL
              MOVE      BKREURNO,TEMPURNO
              MOVE      BKREADOC,DOCTORC
            ENDIF
          ELSE
            PACK      KEY8,PTBDADMN,SP70
            CALL      RDMISS1
            IF        OVRCD=0
              MATCH     "5",DASTAT                * Cancelled
              GOTO      BBAR1000 IF EQUAL
              MOVE      AURNO,TEMPURNO
              MOVE      ADOCTA,DOCTORC
            ENDIF
          ENDIF
.
BBAR3000  CALL      DARY0000
.
          GOTO      BBAR1000
.
BBAR9999  RETURN
.
.------------------------------------------------------------
. Populate Bed Board Array Detail
.------------------------------------------------------------
DARY0000  DAYSEP    FRSTDATE,PTBDDATE,F1
          MOVE      ONE,DMARRCNT
          LOAD      DMARRCNT,F1,TWO,THREE,FOUR,FIVE,SIX,SEVEN
.
          UNPACK    DMBDARRY[DMARRCNT],DIM8
          MATCH     SP70,DIM8
          IF        @EQUAL
            PACK      DMBDARRY[DMARRCNT],PTBDADMN,SP70
            GOTO      DARY9999
          ENDIF
          UNPACK    DMBDARRY[DMARRCNT],DIM8,DIM8A
          MATCH     SP70,DIM8A
          IF        @EQUAL
            PACK      DMBDARRY[DMARRCNT],DIM8,PTBDADMN,SP70
            GOTO      DARY9999
          ENDIF
.
          UNPACK    DMBDARRY[DMARRCNT],DIM16,DIM8A
          MATCH     SP70,DIM8A
          IF        @EQUAL
            PACK      DMBDARRY[DMARRCNT],DIM16,PTBDADMN,SP70
            GOTO      DARY9999
          ENDIF
.
          UNPACK    DMBDARRY[DMARRCNT],DIM24,DIM8A
          MATCH     SP70,DIM8A
          IF        @EQUAL
            PACK      DMBDARRY[DMARRCNT],DIM24,PTBDADMN,SP70
            GOTO      DARY9999
          ENDIF
.
          UNPACK    DMBDARRY[DMARRCNT],DIM32,DIM8A
          MATCH     SP70,DIM8A
          IF        @EQUAL
            PACK      DMBDARRY[DMARRCNT],DIM32,PTBDADMN,SP70
            GOTO      DARY9999
          ENDIF
.
DARY9999  RETURN
.
.-----------------------------------------------------------------------------
. WMRW0000 - Display Bed Board Row
.-----------------------------------------------------------------------------
WMRW0000  UNPACK    SP70,DIM8,DIM8A,DIM8B,DIM8C,DIM8D,DOCTORC
          UNPACK    DMBDARRY[DMARRCNT],DIM8,DIM8A,DIM8B,DIM8C,DIM8D
          MOVE      ZERO,F1
.
          MOVE      "AvailableCell",CELLCOLR
.
WMRW1000  MOVE      SP70,TEMPURNO
          MOVE      SP70,DOCTORC
          MOVE      ZERO,ADMSTAT
          MOVE      SP70,DIM30
          MATCH     SP70,DIM8
          GOTO      WMRW1300 IF EQUAL
.
          IF        EMPTONLY=1
            MOVE     "WhiteCell",CELLCOLR
            WRITE     HTMLFILE;"<td class=",CELLCOLR:
                               ">&nbsp;</td>";
            GOTO      WMRW9999
          ENDIF
.
          PACK      KEY8,DIM8,SP70
          CALL      RDBKREC1
          IF        OVRCD=0
            MOVE      BKREURNO,TEMPURNO
            MOVE      BKREADOC,DOCTORC
          ENDIF
          PACK      KEY8,DIM8,SP70
          CALL      RDMISS1
          IF        OVRCD=0
            MOVE      AURNO,TEMPURNO
            MOVE      ADOCTA,DOCTORC
            IF        ASTAT=2
              MOVE      ONE,ADMSTAT
            ENDIF
          ENDIF
.
          PACK    KEY8,TEMPURNO,SP70
          CALL    RDMAST1
          IF      OVRCD=0
            MOVE    PGNAME,DIM1A
            PACK    DIM30,DIM1A,FULLSTOP,PSNAME
            REP     "'`@ * / : \ $ % & # ",DIM30
            UNPACK  PBDATE,CCENT,CYEAR,CMON,CDAY
            MOVE    "WhiteCell",CELLCOLR
          ENDIF
.
          MOVE      PURNO,URNUMBER
          REP       " +",URNUMBER
.
          MATCH     SP70,DIM8A
          IF        !@EQUAL
            MOVE      "OverlapCell",CELLCOLR
          ELSE
            MOVE      "WhiteCell",CELLCOLR
            GOTO      WMRW1100
          ENDIF
.
          PACK      KEY8,DIM8,SP70
          CALL      RDPMWOR1
          IF        OVRCD<>1
            MATCH     SP70,PMWOEDTM
            IF        !@EQUAL
              MOVE      "OverlapExpDisCell",CELLCOLR
              GOTO      WMRW1100
            ENDIF
          ENDIF
          PACK      KEY8,DIM8A,SP70
          CALL      RDPMWOR1
          IF        OVRCD<>1
            MATCH     SP70,PMWOEDTM
            IF        !@EQUAL
              MOVE      "OverlapExpDisCell",CELLCOLR
              GOTO      WMRW1100
            ENDIF
          ENDIF
          PACK      KEY8,DIM8B,SP70
          CALL      RDPMWOR1
          IF        OVRCD<>1
            MATCH     SP70,PMWOEDTM
            IF        !@EQUAL
              MOVE      "OverlapExpDisCell",CELLCOLR
              GOTO      WMRW1100
            ENDIF
          ENDIF
          PACK      KEY8,DIM8C,SP70
          CALL      RDPMWOR1
          IF        OVRCD<>1
            MATCH     SP70,PMWOEDTM
            IF        !@EQUAL
              MOVE      "OverlapExpDisCell",CELLCOLR
              GOTO      WMRW1100
            ENDIF
          ENDIF
          PACK      KEY8,DIM8D,SP70
          CALL      RDPMWOR1
          IF        OVRCD<>1
            MATCH     SP70,PMWOEDTM
            IF        !@EQUAL
              MOVE      "OverlapExpDisCell",CELLCOLR
              GOTO      WMRW1100
            ENDIF
          ENDIF
.------------------------------------------------------------------------------
. Patient's 00 Cell: Demographics Folder and Edit Icon
.------------------------------------------------------------------------------
.
WMRW1100  IF      F1=0
            WRITE   HTMLFILE;"<td nowrap class=",CELLCOLR,">";
          ELSE
            WRITE   HTMLFILE;"<br>";
          ENDIF
          WRITE   HTMLFILE;"<img src=../images/PatientFolder.gif":
                           " class=ListIcon ":
                           " onmouseover='status=#" Patient Name: ",DIM30:
                           "    UR Number: ",PURNO," ":
                           "    Vis Number: ",DIM8," ":
                           "    Gender: ",PSEX," ":
                           "    DOB: ",CDAY,"/",CMON,"/",CCENT,CYEAR:
                           "    Doctor: ",DOCTORC:
                           "#";show_it(#"Patient Name: ",DIM30:
                           " <br>UR Number:",PURNO:
                           " <br>Vis Number: ",DIM8:
                           " <br>Gender: ",PSEX," ":
                           " <br>DOB: ",CDAY,"/",CMON,"/",CCENT,CYEAR:
                           " <br>Doctor: ",DOCTORC:
                           "#");'" :
                           " onmouseout='hide_it();status=#" #"'":
                           " onclick='status=#"#";location.href=#"",LINKPRG,".pbl":
                           "?reportno=",LINKREP:
                           "&template=",LINKTEM:
                           "&urnumber=",URNUMBER:
                           "&admissno=",DIM8:
                           "#";'>":
                           "<img src=../images/EditIcon.gif":
                           " class=ListIcon ":
                           " onmouseover='show_it(#"Patient Name: ",DIM30:
                           " <br>UR Number: ",PURNO:
                           " <br>Vis Number: ",DIM8:
                           " <br>Gender: ",PSEX," ":
                           " <br>DOB: ",CDAY,"/",CMON,"/",CCENT,CYEAR:
                           " <br>Doctor: ",DOCTORC:
                           "#");status=#"Patient Name: ",DIM30:
                           "    UR Number: ",PURNO," ":
                           "    Vis Number: ",DIM8," ":
                           "    Gender: ",PSEX," ":
                           "    DOB: ",CDAY,"/",CMON,"/",CCENT,CYEAR:
                           "    Doctor: ",DOCTORC:
                           "#"'" :
                           " onmouseout='hide_it();status=#" #"'";
.
          WRITE   HTMLFILE;" onclick='status=#"#";location.href=#"patweb89.pbl":
                           "?reportno=01":
                           "&template=032":
                           "&urnumber=",URNUMBER:
                           "&admissno=",DIM8:
                           "#";'>";
          IF       ADMSTAT<>1
            WRITE    HTMLFILE;"<b>";
          ENDIF
          WRITE    HTMLFILE;DIM30,DOCTORC;
          IF       ADMSTAT<>1
            WRITE    HTMLFILE;"</b>";
          ENDIF
.
          ADD       ONE,F1
          COMPARE   F1,FOUR
          GOTO      WMRW1300 IF LESS
          LOAD      DIM8,F1,DIM8A,DIM8B,DIM8C,DIM8D
          GOTO      WMRW1000
.------------------------------------------------------------------------------
. Empty cells and patient's subsequent cells
.------------------------------------------------------------------------------
.
WMRW1300  MATCH     "AvailableCell",CELLCOLR
          IF        @EQUAL
            WRITE   HTMLFILE;"<td class=",CELLCOLR:
                             ">&nbsp;</td>";
            GOTO    WMRW9999
          ENDIF
.
          COMPARE   ZERO,F1
          GOTO      WMRW9000 IF NOT EQUAL
          WRITE     HTMLFILE;">&nbsp;</td>";
          GOTO      WMRW9999
.
.
WMRW9000  WRITE     HTMLFILE;"</td>";
WMRW9999  RETURN
.
.------------------------------------------------------------------------------
. Count the Number of patients for the Day Oncology Ward View
.------------------------------------------------------------------------------
CNPBMV00  MOVE      ZERO,FORM5A
          PACK      KEY30,WARDCODE,LASTDATE,SP70
          CALL      RSPTBMD4
CNPBMV10  CALL      RKPTBMD4
          BRANCH    OVRCD,CNPBMV90
.
          MATCH     WARDCODE,PTBDWARD
          GOTO      CNPBMV90 IF NOT EQUAL
.
          MATCH     LASTDATE,PTBDDATE
          GOTO      CNPBMV90 IF NOT EQUAL
.
          MATCH     SP70,PTBDWBED
          GOTO      CNPBMV10 IF EQUAL
          GOTO      CNPBMV10 IF EOS
.
          MATCH     "00:00",PTBDADTM
          IF        @EQUAL
            GOTO      CNPBMV10
          ELSE
            MATCH     SP70,PTBDLOSM
            IF        !@EQUAL & !@EOS
              MOVE      ZERO,FORM5
              MOVE      PTBDLOSM,FORM5
.
              IF        FORM5=0
                GOTO      CNPBMV10
              ENDIF
            ELSE
              GOTO      CNPBMV10
            ENDIF
          ENDIF
.
          ADD       ONE,FORM5A
          GOTO      CNPBMV10
.
CNPBMV90  WRITE     HTMLFILE;FORM5A;
.
CNPBMV99  RETURN
.
.------------------------------------------------------------------------------
. Find out if the bed is closed Day Oncology Ward View
.------------------------------------------------------------------------------
.------------------------------------------------------------------------------
. Find out if the bed is closed Day Oncology Ward View
.------------------------------------------------------------------------------
CLBD0000  MOVE      SP70,DIM5
          MOVE      ZERO,CLBDINDC
          UNPACK    TIMEARRY[TMARRCNT],DIM5,DIM1,DIM5A
.
          PACK      KEY22,WWARD,WBED,LASTDATE,DIM5A,SP70
          CALL      RDPMBDC1
          IF        OVRCD<>1
            GOTO     CLBD1200
          ENDIF
.
CLBD1000  CALL      RPPMBDC1
          BRANCH    OVRCD,CLBD9999
.
CLBD1200  MATCH     PMBCWARD,WWARD
          GOTO      CLBD9999 IF NOT EQUAL
.
          MATCH     PMBCBED,WBED
          GOTO      CLBD9999 IF NOT EQUAL
.
          MATCH     LASTDATE,PMBCTODT
          GOTO      CLBD9999 IF LESS
.
          IF        @EQUAL
            MATCH     DIM5,PMBCTOTM
            GOTO      CLBD9999 IF LESS
          ENDIF
.
          MOVE      ONE,CLBDINDC
.
CLBD9999  RETURN
.
.------------------------------------------------------------------------------
. Return the category code long description for the first code in cat sn
. where indicator 1 = KEY1
.------------------------------------------------------------------------------
CATD0000  UNPACK    DIM127,D1,KEY1,DIM127
.
          PACK      KEY5,CATSN,SP70
          CALL      RDSCODE1
CATD1000  CALL      RDKCODE1
          BRANCH    OVRCD,CATD9999
.
          MATCH    TCODE,CATSN
          GOTO     CATD9999 IF NOT EQUAL
.
          MATCH    KEY1,TCINDC1
          GOTO     CATD1000 IF NOT EQUAL
.
          WRITE    HTMLFILE;PTCDLDES;
.
CATD9999  RETURN
+
.------------------------------------------------------------
. Hospital ID
.------------------------------------------------------------
HOSPID00  PACK      KEY3,SP10
          CALL      RSPTHSP1
HOSPID10  CALL      RKPTHSP1
          BRANCH    OVRCD,HOSPID90
.
          PACK      KEY5,QUOTE,PTHSHOSP,QUOTE
          BRANCH    IBCNMHOS,HOSPID20
          WRITE     HTMLFILE;"<option value=",KEY5,">":
                             PTHSNAME,"</option>"
          GOTO      HOSPID10
.
.         Mult-Hospital
.
HOSPID20  BRANCH    ALLHFLAG,HOSPID30            * don't default to user's hosp
          MATCH     SP70,HOSPCODE                                      *C-125462
          IF        @EQUAL
            MOVE      WBSEHOSP,HOSPCODE          * default to user's Hosp code
          ENDIF
HOSPID30  MATCH     HOSPCODE,PTHSHOSP
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY5," selected>":
                               PTHSNAME,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY5,">":
                               PTHSNAME,"</option>"
          ENDIF
          GOTO      HOSPID10
.
HOSPID90
HOSPID99  RETURN
+
.------------------------------------------------------------
. Health fund Selection
.------------------------------------------------------------
SELHFN00  PACK      KEY14,SP70
          CALL      RDSFUND1
SELHFN10  CALL      RDKFUND1
          BRANCH    OVRCD,SELHFN99
.
          MATCH     SP8,HFTABL           * Check health fund table
          GOTO      SELHFN10 IF EQUAL
.
          MATCH     "0000    ",HFTABL
          GOTO      SELHFN10 IF NOT EQUAL
.
          BRANCH    PHFTACT,SELHFN10     * ignore inactive HF
.
          PACK      KEY8,QUOTE,HCODE,QUOTE
          MATCH     HLTHFUND,HCODE
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY8," selected>":
                               HFNAME,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY8,">":
                               HFNAME,"</option>"
          ENDIF
          GOTO      SELHFN10
.
SELHFN99  RETURN
.
.--------------------------------------------------------------------------
. Remote Scripting 
.               1. Validate Batch Number
.               2. Get Patient Attribute flags (Falls/Pressure Injury/Abscond/
.                  Malnutrition Risk and Non Weight Bearing)
.               3. Get Patient Attribute text value
.               4. Get Patient Attribute notes (specify type)
.--------------------------------------------------------------------------
REMOTE00  BRANCH    VALDTYPE,REMOTE10,REMOTE20,REMOTE30,REMOTE40
          GOTO      REMOTE90
.
REMOTE10  CALL      VALBAT00     * Validate Batch Number
          GOTO      REMOTE99
.
REMOTE20  CALL      GETPAF00     * Get Patient Attributes flags
          GOTO      REMOTE99
.
REMOTE30  CALL      GETATV00     * Get Patient Attributes text value
          GOTO      REMOTE99
.
REMOTE40  CALL      GETANT00     * Get Patient Attributes notes (specify type)
          GOTO      REMOTE99
.
REMOTE90  CALL      XMLHED00
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Validation Type":
                             "</RETURN_VALUE>"
          CALL      XMLEND00
          GOTO      REMOTE99
.
REMOTE99  RETURN
+
.------------------------------------------------------------
. Validate Batch Number
. INPUTS: BATCHNUM - Batch Number
.------------------------------------------------------------
VALBAT00  CALL      XMLHED00
          BRANCH    EXIT,VALBAT99
.
          PACK      KEY24,BATCHNUM,SP70
          CALL      RSWBIHC3
          CALL      RKWBIHC3
          BRANCH    OVRCD,VALBAT90
.
          MATCH     WBICBATN,BATCHNUM         
          GOTO      VALBAT90 IF NOT EQUAL
.
.  Dummy ouput for valid Code
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                              ONE:
                             "</RETURN_VALUE>"
.
          GOTO      VALBAT98
.
VALBAT90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Batch number not on file. ":
                             "</RETURN_VALUE>"
          GOTO      VALBAT98
.
VALBAT98  CALL      XMLEND00
VALBAT99  RETURN
+
.------------------------------------------------------------------------------
.         Remote call to return Patient Attributes flags 
.         (Falls/Pressure Injury/Abscond/Malnutrition Risk and
.         Non Weight Bearing).
.------------------------------------------------------------------------------
GETPAF00  CALL      XMLHED00
          BRANCH    EXIT,GETPAF99
.
          CLEAR     DIM10
.
          REP       "+ ",PATATURN
          REP       "+ ",PATATVIS
          MOVE      PATATURN,PTATR001
          MOVE      PATATVIS,PTATR002
.
          MOVE      "5",ATTYPIND       * Attribute Type 5 ('Falls Risk')
          MOVE      "1",ATCODIND       * Attribute Coded Field 1
          CALL      GETACV00           * Get Attribute Coded Field value
          IF        EXIT=1
            APPEND    ZERO,DIM10
          ELSE
            SQUEEZE   ATCODVAL
            APPEND    ATCODVAL,DIM10
          ENDIF
          APPEND    PIPE,DIM10
.
          MOVE      "6",ATTYPIND       * Attribute Type 6 ('Pressure Injury')
          MOVE      "1",ATCODIND       * Attribute Coded Field 1
          CALL      GETACV00           * Get Attribute Coded Field value
          IF        EXIT=1
            APPEND    ZERO,DIM10
          ELSE
            SQUEEZE   ATCODVAL
            APPEND    ATCODVAL,DIM10
          ENDIF
          APPEND    PIPE,DIM10
.
          MOVE      "7",ATTYPIND       * Attribute Type 7 ('Abscond Risk')
          MOVE      "1",ATCODIND       * Attribute Coded Field 1
          CALL      GETACV00           * Get Attribute Coded Field value
          IF        EXIT=1
            APPEND    ZERO,DIM10
          ELSE
            SQUEEZE   ATCODVAL
            APPEND    ATCODVAL,DIM10
          ENDIF
          APPEND    PIPE,DIM10
.
          MOVE      "8",ATTYPIND       * Attribute Type 8 ('Malnutrition Risk')
          MOVE      "1",ATCODIND       * Attribute Coded Field 1
          CALL      GETACV00           * Get Attribute Coded Field value
          IF        EXIT=1
            APPEND    ZERO,DIM10
          ELSE
            SQUEEZE   ATCODVAL
            APPEND    ATCODVAL,DIM10
          ENDIF
          APPEND    PIPE,DIM10
.
          MOVE      "10",ATTYPIND      * Attr Type 10 ('Non Weight Bearing')
          MOVE      "1",ATCODIND       * Attribute Coded Field 1
          CALL      GETACV00           * Get Attribute Coded Field value
          IF        EXIT=1
            APPEND    ZERO,DIM10
          ELSE
            SQUEEZE   ATCODVAL
            APPEND    ATCODVAL,DIM10
          ENDIF
.
          RESET     DIM10
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             DIM10:
                             "</RETURN_VALUE>"
.
          GOTO      GETPAF98
.
GETPAF91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "No Patient Attribute records for visist. ":
                             "</RETURN_VALUE>"
          GOTO      GETPAF98
.
GETPAF98  CALL      XMLEND00
GETPAF99  RETURN
+
.------------------------------------------------------------------------------
.         Remote call to return Patient Attribute Text value for Expected
.         Discharge Destination.
.------------------------------------------------------------------------------
GETATV00  CALL      XMLHED00
          BRANCH    EXIT,GETATV99
.
          CLEAR     DIM127
.
          REP       "+ ",PATATURN
          REP       "+ ",PATATVIS
          MOVE      PATATURN,PTATR001
          MOVE      PATATVIS,PTATR002
.
          MOVE      "9",ATTYPIND       * Attr Type 9 ('Expected Discharge Dest')
          MOVE      "1",ATCODIND       * Attribute Text Field 1
          CALL      GETTFV00           * Get Attribute Text Field value
          IF        EXIT=1
            APPEND    SP1,DIM127
            SQUEEZE   DIM127
          ELSE
            MOVELPTR  ATTXTVAL,FORM2
            SFORMAT   DIM127,FORM2
            APPEND    ATTXTVAL,DIM127
          ENDIF
.
          RESET     DIM127
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             DIM127:
                             "</RETURN_VALUE>"
.
          GOTO      GETATV98
.
GETATV98  CALL      XMLEND00
GETATV99  RETURN
+
.------------------------------------------------------------------------------
.         Remote call to return Patient Attribute Notes (specify Type)
.------------------------------------------------------------------------------
GETANT00  CALL      XMLHED00
          BRANCH    EXIT,GETANT99
.
          CLEAR     ATTRNOTE
.
          REP       "+ ",PATATURN
          REP       "+ ",PATATVIS
          MOVE      PATATURN,PTATR001
          MOVE      PATATVIS,PTATR002
          MOVE      PATATNOT,PTATR005
.
          PACK      KEY35,PTATR001,PTATR002,PTATR005,SP70
          CALL      RSPTATR3
GETANT10  CALL      RKPTATR3
          BRANCH    OVRCD,GETANT91
.
          MATCH     PTATR001,PTARURNO
          GOTO      GETANT91 IF NOT EQUAL
.
          MATCH     PTATR002,PTARVISN
          GOTO      GETANT91 IF NOT EQUAL
.
          MATCH     PTATR005,PTARTYPE
          GOTO      GETANT10 IF NOT EQUAL
.
          STRIP     PTARTXT1
          MOVELPTR  PTARTXT1,LENGTH
          IF        LENGTH > 0
            APPEND    PTARTXT1,ATTRNOTE
          ENDIF
          APPEND    "\n",ATTRNOTE
.          
          STRIP     PTARTXT2
          MOVELPTR  PTARTXT2,LENGTH
          IF        LENGTH > 0
            APPEND    PTARTXT2,ATTRNOTE
          ENDIF
          APPEND    "\n",ATTRNOTE
.          
          STRIP     PTARTXT3
          MOVELPTR  PTARTXT3,LENGTH
          IF        LENGTH > 0
            APPEND    PTARTXT3,ATTRNOTE
          ENDIF
.          
GETANT91  RESET     ATTRNOTE
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             ATTRNOTE:
                             "</RETURN_VALUE>"
.
          GOTO      GETANT98
.
GETANT98  CALL      XMLEND00
GETANT99  RETURN
+
.------------------------------------------------------------
. Selects Day, Week or Month from Viewtype
.------------------------------------------------------------
.
SELP0000  MATCH     "1",VIEWTYPE
          GOTO      SELP2000 IF EQUAL
          MATCH     "2",VIEWTYPE
          GOTO      SELP4000 IF EQUAL
.
.Defaults to Daily Viewtype
.--------------------------
.
          WRITE     HTMLFILE;"<select name=lastdate class=DaySelect":
                             " onchange='exdtblankchange();FilterSubmit();'>";
          UNPACK    FRSTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      "8",ADJDAYS
          CALL      ADJDAT00
          PACK      ENDDATE,CCENT,CYEAR,CMON,CDAY
.
          MOVE      "-7",ADJDAYS
          UNPACK    FRSTDATE,CCENT,CYEAR,CMON,CDAY
          CALL      ADJDAT00
          PACK      STRTDATE,CCENT,CYEAR,CMON,CDAY
.
          IF        EXDTBLNK=1
            WRITE     HTMLFILE;"<option value='",SP8,"' selected>":
                               "</option>";
          ELSE
            WRITE     HTMLFILE;"<option value='",SP8,"'>":
                               "</option>";
          ENDIF
.
SELP1000  UNPACK    STRTDATE,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
          LOAD      DAYNAM3,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          IF        EXDTBLNK=1
              WRITE     HTMLFILE;"<option value=",STRTDATE,">":
                                 DAYNAM3,SP1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                                 "</option>";
          ELSE
            MATCH     STRTDATE,FRSTDATE
            IF        @EQUAL
              WRITE     HTMLFILE;"<option value=",STRTDATE," selected>":
                                 DAYNAM3,SP1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                                 "</option>";
            ELSE
              WRITE     HTMLFILE;"<option value=",STRTDATE,">":
                                 DAYNAM3,SP1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                                 "</option>";
            ENDIF
          ENDIF
.
          MOVE      "1",ADJDAYS
          CALL      ADJDAT00
          PACK      STRTDATE,CCENT,CYEAR,CMON,CDAY
          MATCH     ENDDATE,STRTDATE
          GOTO      SELP1000 IF NOT EQUAL
          GOTO      SELP9000
.
.Select Weekly Viewtype
.--------------------------
SELP2000  WRITE     HTMLFILE;"<select name=lastdate class=WeekSelect":
                             " onchange='exdtblankchange();FilterSubmit();'>";
          UNPACK    FRSTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      "42",ADJDAYS
          CALL      ADJDAT00
          PACK      ENDDATE,CCENT,CYEAR,CMON,CDAY
          REP       " 0",ENDDATE
.
          UNPACK    FRSTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      "-42",ADJDAYS
          CALL      ADJDAT00
          PACK      STRTDATE,CCENT,CYEAR,CMON,CDAY
          REP       " 0",STRTDATE
          REP       " 0",FRSTDATE
.
          IF        EXDTBLNK=1
            WRITE     HTMLFILE;"<option value='",SP8,"' selected>":
                               "</option>";
          ELSE
            WRITE     HTMLFILE;"<option value='",SP8,"'>":
                               "</option>";
          ENDIF
.
SELP3000  UNPACK    STRTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          IF        EXDTBLNK=1
            WRITE     HTMLFILE;"<option value=",STRTDATE,">Week of ":
                               CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</option>";
          ELSE
            MATCH     STRTDATE,FRSTDATE
            IF        @EQUAL
              WRITE     HTMLFILE;"<option value=",STRTDATE," selected>Week of ":
                                 CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</option>";
            ELSE
              WRITE     HTMLFILE;"<option value=",STRTDATE,">Week of ":
                                 CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</option>";
            ENDIF
          ENDIF
.
          MOVE      "7",ADJDAYS
          CALL      ADJDAT00
          PACK      STRTDATE,CCENT,CYEAR,CMON,CDAY
          REP       " 0",STRTDATE
          MATCH     ENDDATE,STRTDATE
          GOTO      SELP3000 IF NOT EQUAL
          GOTO      SELP9000
.
.
.Select Monthly Viewtype
.------------------------
.
SELP4000  WRITE     HTMLFILE;"<select name=vyearmth class=MonthSelect":
                             " onchange='exdtblankchange();FilterSubmit();'>";
          UNPACK    FRSTDATE,KEY4,CMON,CDAY
          MOVE      KEY4,F4
          MOVE      CMON,F2
          MOVE      CMON,ENDMTH
          ADD       SIX,ENDMTH
          IF        ENDMTH>12
            SUB       "12",ENDMTH
          ENDIF
          SUB       SIX,F2
          IF        F2<0
            SUB       ONE,F4
            ADD       "12",F2
          ENDIF
.
          IF        EXDTBLNK=1
            WRITE     HTMLFILE;"<option value='",SP6,"' selected>":
                               "</option>";
          ELSE
            WRITE     HTMLFILE;"<option value='",SP6,"'>":
                               "</option>";
          ENDIF   
.
SELP5000  LOAD      MTHNAM,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY6,F4,F2
          REP       " 0",KEY6
.
          IF        EXDTBLNK=1
            WRITE     HTMLFILE;"<option value=",KEY6,">":
                               MTHNAM,SP1,F4,"</option>";
          ELSE
            MATCH     KEY6,FRSTDATE
            IF        @EQUAL
              WRITE     HTMLFILE;"<option value=",KEY6," selected>":
                                 MTHNAM,SP1,F4,"</option>";
            ELSE
              WRITE     HTMLFILE;"<option value=",KEY6,">":
                                 MTHNAM,SP1,F4,"</option>";
            ENDIF
          ENDIF
.
          ADD       ONE,F2
          IF        F2>12
            ADD      ONE,F4
            SUB      "12",F2
          ENDIF
          COMPARE   ENDMTH,F2
          GOTO      SELP5000 IF NOT EQUAL
.
SELP9000  WRITE     HTMLFILE;"</select>"
          RETURN
.
.------------------------------------------------------------
. Next Day, Week, Month      
.------------------------------------------------------------
NXTE0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
.
          REP       " +",HLTHFUND
          REP       " +",HLFDCLTY
          REP       " +",BATCHNUM
          REP       " +",INVNUMBR
          REP       " +",CLAIMSTA
          REP       " +",HOSPCODE
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
.         
          WRITE     HTMLFILE;"patweb93.pbl":
                             "?reportno=",KEY2:
                             "&template=",KEY3:
                             "&viewtype=",VIEWTYPE:
                             "&frstdate=",NXTFDATE:
                             "&lastdate=",NXTLDATE:
                             "&allhflag=",ALLHFLAG:
                             "&hlthfund=",HLTHFUND:
                             "&exclwait=",EXCLWAIT:
                             "&exdtblnk=",EXDTBLNK:
                             "&hlfdclty=",HLFDCLTY:
                             "&batchnum=",BATCHNUM:
                             "&invnumbr=",INVNUMBR:
                             "&claimsta=",CLAIMSTA:
                             "&hospcode=",HOSPCODE:
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO:
                             "&exclclos=",EXCLCLOS;
.
          REP       "+ ",HLTHFUND
          REP       "+ ",HLFDCLTY
          REP       "+ ",BATCHNUM
          REP       "+ ",INVNUMBR
          REP       "+ ",CLAIMSTA
          REP       "+ ",HOSPCODE
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
NXTE9999  RETURN
.
.--------------------------------------------------------
.
PRVE0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
.
          REP       " +",HLTHFUND
          REP       " +",HLFDCLTY
          REP       " +",BATCHNUM
          REP       " +",INVNUMBR
          REP       " +",CLAIMSTA
          REP       " +",HOSPCODE
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
.                            
          WRITE     HTMLFILE;"patweb93.pbl":
                             "?reportno=",KEY2:
                             "&template=",KEY3:
                             "&viewtype=",VIEWTYPE:
                             "&frstdate=",PREFDATE:
                             "&lastdate=",PRELDATE:
                             "&allhflag=",ALLHFLAG:
                             "&hlthfund=",HLTHFUND:
                             "&exclwait=",EXCLWAIT:
                             "&exdtblnk=",EXDTBLNK:
                             "&hlfdclty=",HLFDCLTY:
                             "&batchnum=",BATCHNUM:
                             "&invnumbr=",INVNUMBR:
                             "&claimsta=",CLAIMSTA:
                             "&hospcode=",HOSPCODE:
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO:
                             "&exclclos=",EXCLCLOS;
.
          REP       "+ ",HLTHFUND
          REP       "+ ",HLFDCLTY
          REP       "+ ",BATCHNUM
          REP       "+ ",INVNUMBR
          REP       "+ ",CLAIMSTA
          REP       "+ ",HOSPCODE
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
PRVE9999  RETURN
+
.-------------------------------------------------------------
. Link to Prev Group
.-------------------------------------------------------------
PREVBT00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM-NORECORD,F3
          IF        F3<0
            MOVE      ZERO,F3
          ENDIF
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F2
.
          WRITE     HTMLFILE;"patweb93.pbl":
                             "?reportno=",F2:
                             "&template=",FLDPARA:
                             "&startnum=",KEY3:
                             "&norecord=",KEY2:
                             "&btschosp=",BTSCHOSP;
.
PREVBT99  RETURN
.-----------------------------------------------------------
. Link to Next Group
.-----------------------------------------------------------
NEXTBT00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F2
.
          WRITE     HTMLFILE;"patweb93.pbl":
                             "?reportno=",F2:
                             "&template=",FLDPARA:
                             "&startnum=",KEY3:
                             "&norecord=",KEY2:
                             "&btschosp=",BTSCHOSP;
.
NEXTBT99  RETURN
.------------------------------------------------------------
. Output Next Page Based on CGI Parameter nextpage
.------------------------------------------------------------
NXTPAG00  MOVE      ZERO,F1
          MOVE      NEXTPAGE,F1
          BRANCH    F1,NXTPAG10,NXTPAG20,NXTPAG30,NXTPAG40,NXTPAG50:
                       NXTPAG60,NXTPAG70,NXTPAG80,NXTPAG90
.  
          CALL      WINCLS00
          GOTO      NXTPAG99
.         
NXTPAG10  CALL      RDIREC00
          GOTO      NXTPAG99
.                            
NXTPAG20  CALL      GOBACK00      * Go Back 1 Html page
          GOTO      NXTPAG99 
.         
NXTPAG30  CALL      DAH20000      * Go Back 2 html pages
          GOTO      NXTPAG99
.
NXTPAG40  CALL      GOBACK00
          GOTO      NXTPAG99
.
NXTPAG50  CALL      PREDIR00
          GOTO      NXTPAG99
.
NXTPAG60  CALL      RELOAD00
          GOTO      NXTPAG99
.
NXTPAG70  CALL      WINEXT00
          GOTO      NXTPAG99
.
NXTPAG80  CALL      RELSKC00
          GOTO      NXTPAG99
.
NXTPAG90  CALL      PAREDR00
          GOTO      NXTPAG99
.
NXTPAG99  RETURN
.
.------------------------------------------------------------
. Output Next Page Based on CGI Parameter nextpage (RPAY0000)
.------------------------------------------------------------
RPYPAG00  MOVE      ZERO,F1
          MOVE      NEXTPAGE,F1
          BRANCH    F1,RPYPAG10,RPYPAG20,RPYPAG30,RPYPAG40,RPYPAG50:
                       RPYPAG60,RPYPAG70,RPYPAG80,RPYPAG90
.
          CALL      RPYCLS00
          GOTO      RPYPAG99
.
RPYPAG10  
          GOTO      RPYPAG99
.
RPYPAG20  
          GOTO      RPYPAG99
.
RPYPAG30  
          GOTO      RPYPAG99
.
RPYPAG40  
          GOTO      RPYPAG99
.
RPYPAG50  CALL      RPYDIR00
          GOTO      RPYPAG99
.
RPYPAG60  
          GOTO      RPYPAG99
.
RPYPAG70  
          GOTO      RPYPAG99
.
RPYPAG80  
          GOTO      RPYPAG99
.
RPYPAG90  
          GOTO      RPYPAG99
.
RPYPAG99  RETURN
.
.-------------------------------------------------------------------------------
.  Goes back 1 page
.-------------------------------------------------------------------------------
GOBACK00  CALL      OPENHTML
          BRANCH    EXIT,GOBACK99
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "    alert(#"",WEBTITLE,"#");":
                             "    self.close();":
                             "    opener.history.go(-1);":
                             "}":
                             "</script>"
          CALL      CLOSHTML
GOBACK99  RETURN
+
.*******************************************************************************
.                         Goes back 1 page
.*******************************************************************************
RELOAD00  CALL      OPENHTML
          BRANCH    EXIT,RELOAD99
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
.                            "    alert(#"",WEBTITLE,"#");":
                             "    history.go(-1);":
.                            "    location.reload();":
                             "}":
                             "</script>"
          CALL      CLOSHTML
RELOAD99  RETURN
+
.------------------------------------------------------------
. WebServices IHCW ERAW Remittance Advice Enquiries
.------------------------------------------------------------
ECRE0000  MOVE      SP70,RPYERRIN
.
          RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      ECRE5000 IF EQUAL
.
          MATCH     "R",UPDATETY
          GOTO      ECRE4000 IF EQUAL
.
          MATCH     "D",UPDATETY
          GOTO      ECRE3000 IF EQUAL
.
          MATCH     "L",UPDATETY
          GOTO      ECRE2000 IF EQUAL
.
          MATCH     "P",UPDATETY
          GOTO      ECRE1000 IF EQUAL
.
          MATCH     "C",UPDATETY
          GOTO      ECRE7000 IF EQUAL
.
          GOTO      ECRE9000 
.
ECRE1000  MOVE      "1",DIM1C
          CALL      PRNREM00
          MOVE      "Print Remittance Report scheduled.",WEBTITLE 
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ECRE9999
.
ECRE2000  CALL      CREA0000
          CALL      RPAY0000
          CALL      KILL0000
          GOTO      ECRE9999
.
ECRE3000  PACK      KEY61,HOSPCODE,FUNDTRID,ECREADVC,ECREPTNO,SP70
          CALL      RDWBERH1
          BRANCH    OVRCD,ECRE9100
.
          PACK      KEY82,FUNDTRID,ECREADVC,ECREPTNO,ECRETRID,SP70
          CALL      RDWBERD1
          BRANCH    OVRCD,ECRE9200
.
          GOTO      ECRE6000
.
ECRE4000  PACK      KEY61,HOSPCODE,FUNDTRID,ECREADVC,ECREPTNO,SP70
          CALL      RDWBERH1
          BRANCH    OVRCD,ECRE9100
.
          GOTO      ECRE6000
.
ECRE5000  MOVE      TEMPLATE,KEY3
          RJUSTIFY  KEY3
          REP       " 0",KEY3
.
          IF        DEFTALLH=0 & IBCNMHOS=1
            MATCH     SP70,FILTHOSP        
            IF        @EQUAL
              MOVE      WBSEHOSP,FILTHOSP   * Default hospital filter to users
              MOVE      ONE,DEFTALLH        * logged in hospital if this is the
            ENDIF                           * first time opening the page from 
          ENDIF                             * a menu
.
          MATCH     "001",KEY3
          IF        @EQUAL
.
            CALL      CURPER00
            CALL      CALCDT00
.
            CLEAR     WEBTITLE
            MOVE      "Unreleased Remittance Advice Enquiry",WEBTITLE
            RESET     WEBTITLE
          ENDIF
.
          MATCH     "005",KEY3
          IF        @EQUAL
.
            CALL      CURPER00
            CALL      CALCDT00
.
            CLEAR     WEBTITLE
            MOVE      "Released Remittance Advice Enquiry",WEBTITLE
            RESET     WEBTITLE
          ENDIF
.
          MATCH     "007",KEY3
          IF        @EQUAL
.
            CALL      CURPER00
            CALL      CALCDT00
.
            CLEAR     WEBTITLE
            MOVE      "Unreleased Remittance Advice Enquiry Only",WEBTITLE
            RESET     WEBTITLE
          ENDIF
.
ECRE6000  CALL      WEBHED00
          BRANCH    EXIT,ECRE9999
.
          CALL      WEBBOD00
.
          CALL      WEBEND00
.
          MOVE      ONE,EXIT
          GOTO      ECRE9999
.
ECRE7000  MATCH     SP70,REMITKEY
          GOTO      ECRE9100 IF EQUAL
          GOTO      ECRE9100 IF EOS
.
          PACK      KEY61,REMITKEY,SP70
          CALL      RDWBERH1
          BRANCH    OVRCD,ECRE9100
.
          MOVE      "2",WBEISTAT
.
          CALL      UPWBERH1
.       
          MOVE      "ERAW Closed without Releasing",WEBTITLE
.         CALL      WEBERR00
          MOVE      ZERO,EXIT
          GOTO      ECRE9999
.
ECRE9000  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ECRE9999
.
ECRE9100  MOVE      "Can't find ERAW Header details.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ECRE9999 
.
ECRE9200  MOVE      "Can't find ERAW Payment details.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ECRE9999 
.
ECRE9999  RETURN
.
.------------------------------------------------------------
. WebServices IHCW ERAW Remittance Advice Enquiry tags
.------------------------------------------------------------
ECRL0000  BRANCH    FLDITMNO,ECRL0100,ECRL0200,ECRL0300,ECRL0400,ECRL0500:
                             ECRL0600,ECRL0700,ECRL0800,ECRL0900,ECRL1000:
                             ECRL1100,ECRL1200,ECRL1300,ECRL1400,ECRL1500:
                             ECRL1600,ECRL1700,ECRL1800,ECRL1900,ECRL2000:
                             ECRL2100,ECRL2200,ECRL2300,ECRL2400,ECRL2500:
                             ECRL2600,ECRL2700,ECRL2800,ECRL2900,ECRL3000:
                             ECRL3100,ECRL3200,ECRL3300,ECRL3400,ECRL3500
.
          GOTO      ECRL9999
.
ECRL0100  UNPACK    DIM127,D1,UNRELREM,DIM127
          UNPACK    DIM127,D1,UNRELINQ,DIM127
          UNPACK    DIM127,D1,ERASTATS,DIM127
.
          CALL      ECRH0000           * Set hospital filter and call ECRT0000
          GOTO      ECRL9999
.
ECRL0200  CALL      ECRD0000
          GOTO      ECRL9999
.
ECRL0300  WRITE     HTMLFILE;WBEIRADV;
          GOTO      ECRL9999
.
ECRL0400  WRITE     HTMLFILE;WBEIPNUM;
          GOTO      ECRL9999
.
ECRL0500  WRITE     HTMLFILE;WBEIPTOT;
          GOTO      ECRL9999
.
ECRL0600  MATCH     SP70,WBEIDATE
          GOTO      ECRL9999 IF EQUAL
          UNPACK    WBEIDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      ECRL9999
.
ECRL0700  WRITE     HTMLFILE;WBEINAME;
          GOTO      ECRL9999
.
ECRL0800  WRITE     HTMLFILE;WBEIPLID;
          GOTO      ECRL9999
.
ECRL0900  WRITE     HTMLFILE;WBEIBNUM;
          GOTO      ECRL9999
.
ECRL1000  WRITE     HTMLFILE;WBEIBNAM;
          GOTO      ECRL9999
.
ECRL1100  WRITE     HTMLFILE;WBEIBBSB;
          GOTO      ECRL9999
.
ECRL1200  WRITE     HTMLFILE;WBEIPREF;
          GOTO      ECRL9999
.
ECRL1300  RJUSTIFY  WBEIDAMT
          UNPACK    WBEIDAMT,DIM7,DIM2
          PACK      DIM10,DIM7,FULLSTOP,DIM2
          MOVE      DIM10,FORM7P2C
          WRITE     HTMLFILE;FORM7P2C;
          GOTO      ECRL9999
.
ECRL1400  WRITE     HTMLFILE;WBEIFTID;
          GOTO      ECRL9999
.
ECRL1500  MATCH     "0",WBEISTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Received";
            GOTO      ECRL9999
          ENDIF
.
          MATCH     "1",WBEISTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Partial";
            GOTO      ECRL9999
          ENDIF
.
          MATCH     "2",WBEISTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Released";
            GOTO      ECRL9999
          ENDIF
.
          MATCH     "3",WBEISTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Processing";
            GOTO      ECRL9999
          ENDIF
.
          WRITE     HTMLFILE;"Unknown";
.
          GOTO      ECRL9999
.
ECRL1600  CALL      GCLM0000
          WRITE     HTMLFILE;CLAMTOTL;
          GOTO      ECRL9999
.
ECRL1700  CALL      GCLD0000
          WRITE     HTMLFILE;CLAMTOTL;
          GOTO      ECRL9999
.
ECRL1800  WRITE     HTMLFILE;WBEJRADV;
          GOTO      ECRL9999
.
ECRL1900  WRITE     HTMLFILE;WBEJPNUM;
          GOTO      ECRL9999
.
ECRL2000  WRITE     HTMLFILE;WBEJTRID;
          GOTO      ECRL9999
.
ECRL2100  WRITE     HTMLFILE;WBEJARID;
          GOTO      ECRL9999
.
ECRL2200  RJUSTIFY  WBEJBAMT
          UNPACK    WBEJBAMT,DIM7,DIM2
          PACK      DIM10,DIM7,FULLSTOP,DIM2
.         MOVE      DIM10,FORM7P2C
          MOVE      ZERO,FORM7P2C
          SCAN      "-",DIM10
          IF        @EQUAL
            REP        "-0",DIM10
            MOVE       DIM10,FORM7P2C
            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
          ELSE
            MOVE      DIM10,FORM7P2C
          ENDIF
          WRITE     HTMLFILE;FORM7P2C;
          GOTO      ECRL9999
.
ECRL2300  WRITE     HTMLFILE;WBEJCCOD;
          GOTO      ECRL9999
.
ECRL2400  MATCH     SP70,WBEJLDAT
          GOTO      ECRL9999 IF EQUAL
          UNPACK    WBEJLDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      ECRL9999
.
ECRL2500  WRITE     HTMLFILE;WBEJPARI;
          GOTO      ECRL9999
.
ECRL2600  WRITE     HTMLFILE;WBEJPTID;
          GOTO      ECRL9999
.
ECRL2700  MATCH     "0",WBEJSTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Received";
            GOTO      ECRL9999
          ENDIF     
.
          MATCH     "1",WBEJSTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Locked";
            GOTO      ECRL9999
          ENDIF     
.
          MATCH     "2",WBEJSTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Released";
            GOTO      ECRL9999
          ENDIF    
.
          MATCH     "3",WBEJSTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Released - Suspense";
            GOTO      ECRL9999
          ENDIF
.
          WRITE     HTMLFILE;"Unknown";
.
          GOTO      ECRL9999
.
ECRL2800  UNPACK    DIM127,D1,DIM1,DIM127
          MOVE      ZERO,FORM1
          MOVE      DIM1,FORM1
          BRANCH    FORM1,ECRL2810
.
          WRITE     HTMLFILE;PARTCODE;
          GOTO      ECRL9999
.
ECRL2810  PACK      KEY3,PARTCODE,SP70
          CALL      RDWBPAR1
          BRANCH    OVRCD,ECRL9999
.
          WRITE     HTMLFILE;WBPRNAME;
          GOTO      ECRL9999
.
ECRL2900  WRITE     HTMLFILE;HOSPCODE,FUNDTRID,ECREADVC,ECREPTNO;
          GOTO      ECRL9999
.
ECRL3000  CALL      SELP0000
          GOTO      ECRL9999
.
ECRL3100  CALL      PRVR0000
          GOTO      ECRL9999
.
ECRL3200  CALL      NXTR0000
          GOTO      ECRL9999
.
ECRL3300  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      ECRL9999
.
ECRL3400  WRITE     HTMLFILE;EXDTBLNK;
          GOTO      ECRL9999
.
ECRL3500  CALL      HSPSEL00
          GOTO      ECRL9999
.
ECRL9999  RETURN
.***************************************************************************
.*                             ECRH0000                                    *
.*   Set the hospital filter and call ECRT0000                             *
.*   If multi hospital call ECRT0000 for each of the users hositals        *
.***************************************************************************
.
ECRH0000  IF        IBCNMHOS<>1
            MOVE      SP70,FILTHOSP         * Not multi hospital so blank
            CALL      ECRT0000              
            GOTO      ECRH9999
          ENDIF
.
.   Multi Hospital
.
          MATCH     SP70,FILTHOSP           * User has selected a hospital
          IF        !@EQUAL
            CALL      ECRT0000             
            GOTO      ECRH9999
          ENDIF
.
          PACK      KEY3,SP70               * Show all users available
          CALL      RSPTHSP1                * hospitals
ECRH5000  CALL      RKPTHSP1
          BRANCH    OVRCD,ECRH9000
.
          PACK      KEY13,USERID,SP70                * All hospital access
          CALL      RDMLSEC1
          IF        OVRCD=1
            PACK      KEY13,USERID,PTHSHOSP,SP70     * This hospital access
            CALL      RDMLSEC1
            BRANCH    OVRCD,ECRH5000
          ENDIF
.
          MOVE      PTHSHOSP,FILTHOSP
          CALL      ECRT0000
.
          PACK      KEY3,FILTHOSP,SP70               * reposition
          CALL      RSPTHSP1
          GOTO      ECRH5000
.
ECRH9000  MOVE      SP70,FILTHOSP           * Restore all hospitals filter
.
ECRH9999  RETURN
+
.***************************************************************************
.*                             ECRT0000                                    *
.*   Display all the remittance batches received from a given participant  *
.***************************************************************************
.
ECRT0000  MATCH     "1",PTCNWSIN
          GOTO      ERTM9999 IF NOT EQUAL
.
          MATCH     "1",PTCNIHCW
          GOTO      ERTM9999 IF NOT EQUAL
.
          MOVE      ZERO,LOOPCNTR
.
          PACK      KEY70,FILTHOSP,ERASTATS,Z70
          CALL      RSWBERH3
ECRT1000  CALL      RPWBERH3
          BRANCH    OVRCD,ECRT9999               * end of file 
.
          MATCH     FILTHOSP,WBEIHOSP
          GOTO      ECRT9999 IF NOT EQUAL
.
          MATCH     ERASTATS,WBEISTAT
          GOTO      ECRT9999 IF NOT EQUAL
. 
.------------------------------------------------------
. Loop counter to prevent timeout internal server error
.
           ADD       ONE,LOOPCNTR
 
           IF        (LOOPCNTR > 250)
             WRITE     HTMLFILE;"// ",LOOPCNTR
             MOVE      ZERO,LOOPCNTR
           ENDIF
.
. -----------------------------------------------------
.
          MATCH     "1",PTCNIMCW
          IF        @EQUAL
.
            PACK      KEY82,WBEIFTID,WBEIRADV,WBEIPNUM,SP70
            CALL      RSWBERD1                     
ECRT1500    CALL      RKWBERD1                     
            BRANCH    OVRCD,ECRT1000               
.
            MATCH     WBEIFTID,WBEJFTID
            GOTO      ECRT1000 IF NOT EQUAL
.
            MATCH     WBEIRADV,WBEJRADV
            GOTO      ECRT1000 IF NOT EQUAL
.
            MATCH     WBEIPNUM,WBEJPNUM
            GOTO      ECRT1000 IF NOT EQUAL
.
.           A payment for the ERAW has been found, so now if it belongs
.           to webihcaf
.
            PACK      KEY40,WBEJTRID,SP30,SP10
            CALL      RSWBIHC6     
            CALL      RKWBIHC6     
            BRANCH    OVRCD,ECRT1500        
.
            MATCH     WBEJTRID,WBICTRID            * if its not in pmsectaf
            GOTO      ECRT1500 IF NOT EQUAL        * then its probably an imc 
.                                                  * claim
          ENDIF
.
          MATCH     "1",UNRELREM
          IF        @EQUAL
            MATCH     "2",WBEISTAT
            GOTO      ECRT1000 IF NOT EQUAL
.
            IF        EXDTBLNK=0
              MATCH     FRSTDATE,WBEIDATE
              GOTO      ECRT1000 IF LESS
.
              MATCH     WBEIDATE,LASTDATE
              GOTO      ECRT1000 IF LESS
            ENDIF
.
          ELSE
            MATCH     "2",WBEISTAT
            GOTO      ECRT1000 IF EQUAL
.
            IF        EXDTBLNK=0
              MATCH     FRSTDATE,WBEIDATE
              GOTO      ECRT1000 IF LESS
.         
              MATCH     WBEIDATE,LASTDATE
              GOTO      ECRT1000 IF LESS
            ENDIF
.
          ENDIF
.
          MOVE      SP70,DIM11
          MATCH     SP70,WBEIDATE
          IF        !@EQUAL & !@EOS
            UNPACK    WBEIDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DIM11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MOVE      "Unknown  ",DIM9
          MATCH     "0",WBEISTAT
          IF        @EQUAL
            MOVE      "Received ",DIM9
          ENDIF
.
          MATCH     "1",WBEISTAT
          IF        @EQUAL
            MOVE      "Partial  ",DIM9
          ENDIF
.
          MATCH     "2",WBEISTAT
          IF        @EQUAL
            MOVE      "Released ",DIM9
          ENDIF
.
          MATCH     "3",WBEISTAT
          IF        @EQUAL
            MOVE      "Processng ",DIM9
          ENDIF
.
          MOVE      ZERO,FORM7P2C
          RJUSTIFY  WBEIDAMT
          UNPACK    WBEIDAMT,DIM7,DIM2
          PACK      DIM10,DIM7,DOT,DIM2
          MOVE      DIM10,FORM7P2C
.
          CALL      GCLM0000
.
          REP       " +",WBEIFTID
          REP       " +",WBEIRADV
          REP       " +",WBEIPNUM
          REP       " +",WBEIHOSP
.
          MOVE      ZERO,LOOPCNTR
.
          IF        IBCNMHOS=1
.
            MATCH     "+++",WBEIHOSP
            IF        @EQUAL | @EOS
              WRITE     HTMLFILE;"t.addRow(#"",DIM11,"#",";
            ELSE
        WRITE     HTMLFILE;"t.addRow(#"","<img src='../images/CommentIcon.gif'":
                         " class=ListIcon onclick=displayRemH('",WBEIDATE,"','":
      WBEIFTID,"','",WBEIRADV,"','",WBEIPNUM,"','",WBEIHOSP,"','002');> ",DIM11," ",WBEINAME,"#",";
            ENDIF
.
          ELSE
.
        WRITE     HTMLFILE;"t.addRow(#"","<img src='../images/CommentIcon.gif'":
                         " class=ListIcon onclick=displayRemH('",WBEIDATE,"','":
      WBEIFTID,"','",WBEIRADV,"','",WBEIPNUM,"','",WBEIHOSP,"','002');> ",DIM11," ",WBEINAME,"#",";
          ENDIF
.
          REP       "+ ",WBEIFTID
          REP       "+ ",WBEIRADV
          REP       "+ ",WBEIPNUM
          REP       "+ ",WBEIHOSP
.
          WRITE     HTMLFILE;"#"",WBEIPNUM," of ",WBEIPTOT,"#",":
                             "#"",DIM9,"#",":
                             "#"",FORM7P2C,"#",":
                             "#"",CLAMTOTL,"#",";
.
          REP       " +",WBEIFTID
          REP       " +",WBEIRADV
          REP       " +",WBEIPNUM
          REP       " +",WBEIHOSP
          MOVE      WBEIPREF,DIM30
          MOVE      WBEIDAMT,DIM9
          REP       " +",DIM30
          REP       " +",DIM9
.
          MOVE      FORM7P2C,DIM10A
          MOVE      CLAMTOTL,DIM10B
          REP       " +",DIM10A
          REP       " +",DIM10B
.
          MATCH     "1",UNRELREM
          IF        @EQUAL
.
            IF        IBCNMHOS=1
.
              MATCH     "+++",WBEIHOSP
              IF        @EQUAL | @EOS
                WRITE     HTMLFILE;"#"",WBEIPREF;
              ELSE
            WRITE     HTMLFILE;"#"","<img src='../images/AppointmentIcon.gif'":
                         " class=ListIcon onclick=displayRemH('",WBEIDATE,"','":
              WBEIFTID,"','",WBEIRADV,"','",WBEIPNUM,"','",WBEIHOSP,"','003');>&nbsp;":
                               WBEIPREF;
              ENDIF
.
            ELSE
.
            WRITE     HTMLFILE;"#"","<img src='../images/AppointmentIcon.gif'":
                         " class=ListIcon onclick=displayRemH('",WBEIDATE,"','":
              WBEIFTID,"','",WBEIRADV,"','",WBEIPNUM,"','",WBEIHOSP,"','003');>&nbsp;":
                               WBEIPREF;
            ENDIF
          ELSE
.
            IF        IBCNMHOS=1
.
              MATCH     "+++",WBEIHOSP
              IF        @EQUAL | @EOS
                WRITE     HTMLFILE;"#"",WBEIPREF;
              ELSE
                MATCH     "3",WBEISTAT
                IF        @EQUAL
                  WRITE     HTMLFILE;"#"","<img src='../images/AppointmentIcon.gif'":
                            " class=ListIcon onclick=displayRemH('",WBEIDATE,"','":
                            WBEIFTID,"','",WBEIRADV,"','",WBEIPNUM,"','",WBEIHOSP,"','003');>&nbsp;":
                            WBEIPREF,"&nbsp;<input type=button value='Processing' class='orangebutton' disabled>";
                  MATCH     "1",UNRELINQ
                  IF        !@EQUAL
                    WRITE     HTMLFILE;"&nbsp;<input type=button value='Unlock to Partial' class='button' onclick=unlockToPartial('",WBEIHOSP,"','",WBEIFTID,"','",WBEIRADV,"','",WBEIPNUM,"');>";
                  ENDIF
                ELSE
                  MATCH     "1",UNRELINQ
                  IF        @EQUAL
                    WRITE     HTMLFILE;"#"","<img src='../images/AppointmentIcon.gif'":
                              " class=ListIcon onclick=displayRemH('",WBEIDATE,"','":
                              WBEIFTID,"','",WBEIRADV,"','",WBEIPNUM,"','",WBEIHOSP,"','003');>&nbsp;":
                              WBEIPREF;
                  ELSE
                    WRITE     HTMLFILE;"#"","<img src='../images/AppointmentIcon.gif'":
                              " class=ListIcon onclick=displayRemH('",WBEIDATE,"','":
                              WBEIFTID,"','",WBEIRADV,"','",WBEIPNUM,"','",WBEIHOSP,"','003');>&nbsp;":
                              WBEIPREF,"&nbsp;<input type=button value='Release' class='button' onclick=releaseRem('",WBEIFTID,"','",WBEIRADV,"','",WBEIPNUM,"','",WBEIHOSP,"','",DIM30,"','",DIM9,"',this,'",DIM10A,"','",DIM10B,"');>";
                  ENDIF
                ENDIF
              ENDIF
.
            ELSE
              MATCH     "3",WBEISTAT
              IF        @EQUAL
                WRITE     HTMLFILE;"#"","<img src='../images/AppointmentIcon.gif'":
                          " class=ListIcon onclick=displayRemH('",WBEIDATE,"','":
                          WBEIFTID,"','",WBEIRADV,"','",WBEIPNUM,"','",WBEIHOSP,"','003');>&nbsp;":
                          WBEIPREF,"&nbsp;<input type=button value='Processing' class='orangebutton' disabled>";
                MATCH     "1",UNRELINQ
                IF        !@EQUAL
                  WRITE     HTMLFILE;"&nbsp;<input type=button value='Unlock to Partial' class='button' onclick=unlockToPartial('",WBEIHOSP,"','",WBEIFTID,"','",WBEIRADV,"','",WBEIPNUM,"');>";
                ENDIF
              ELSE
                MATCH     "1",UNRELINQ
                IF        @EQUAL
                  WRITE     HTMLFILE;"#"","<img src='../images/AppointmentIcon.gif'":
                            " class=ListIcon onclick=displayRemH('",WBEIDATE,"','":
                            WBEIFTID,"','",WBEIRADV,"','",WBEIPNUM,"','",WBEIHOSP,"','003');>&nbsp;":
                            WBEIPREF;
                ELSE
                  WRITE     HTMLFILE;"#"","<img src='../images/AppointmentIcon.gif'":
                            " class=ListIcon onclick=displayRemH('",WBEIDATE,"','":
                            WBEIFTID,"','",WBEIRADV,"','",WBEIPNUM,"','",WBEIHOSP,"','003');>&nbsp;":
                            WBEIPREF,"&nbsp;<input type=button value='Release' class='button' onclick=releaseRem('",WBEIFTID,"','",WBEIRADV,"','",WBEIPNUM,"','",WBEIHOSP,"','",DIM30,"','",DIM9,"',this,'",DIM10A,"','",DIM10B,"');>";
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"#",#"",WBEINAME;
          MOVE      WBEIRADV,DIM30
          REP       "+ ",WBEIRADV
          WRITE     HTMLFILE;"#",#"","<img src='../images/CommentIcon.gif'":
                         " class=ListIcon onclick=displayRemH('",WBEIDATE,"','":
      WBEIFTID,"','",DIM30,"','",WBEIPNUM,"','",WBEIHOSP,"','002');> ",WBEIRADV;
.
          REP       "+ ",WBEIHOSP
.
          WRITE     HTMLFILE;"#",#"",WBEIFTID;
          WRITE     HTMLFILE;"#",#"",DIM11;
.
          MOVE      SP70,DIM50
          MATCH     SP70,WBEIHOSP
          IF        !@EQUAL & !@EOS
            PACK      KEY3,WBEIHOSP,SP70
            CALL      RDPTHSP1 
            IF        OVRCD=0
              MOVE      PTHSNAME,DIM50
            ELSE
              MOVE      WBEIHOSP,DIM50
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"#",#"",DIM50;
.
          WRITE     HTMLFILE;"#",#"","<img src='../images/CommentIcon.gif'":
                    "class=ListIcon onclick=displayJSON('",WBEIFTID,"');>";
.
          WRITE     HTMLFILE;"#");"
.
          REP       "+ ",WBEIFTID
          REP       "+ ",WBEIRADV
          REP       "+ ",WBEIPNUM
.
          GOTO      ECRT1000
.
ECRT9999  RETURN
+
.*****************************************************************************
.*                            GCLM0000                                       *
.*              Get the claimed amount total for the ERA                     *
.* Requires:  Valid read on pmserhaf record (ERA Header)                     *
.* Returns:   CLAMTOTL - total claimed amount for the ERA batch              *
.*****************************************************************************
.
GCLM0000  MOVE      ZERO,CLAMTOTL                * initialise total amount
.
.         Loop through weberdaf looking for payments from the selected ERAW
.
          PACK      KEY82,WBEIFTID,WBEIRADV,WBEIPNUM,SP30,SP30,SP1
          CALL      RSWBERD1                     * position in file
GCLM1000  CALL      RKWBERD1                     * read next record
          BRANCH    OVRCD,GCLM9999               * end of file
.
          MATCH     WBEIFTID,WBEJFTID            * same participant still ?
          GOTO      GCLM9999 IF NOT EQUAL        * no - finished ERA
.
          MATCH     WBEIRADV,WBEJRADV            * same remittance advice still?
          GOTO      GCLM9999 IF NOT EQUAL        * no - finished ERA
.
          MATCH     WBEIPNUM,WBEJPNUM            * same part number still ?
          GOTO      GCLM9999 IF NOT EQUAL        * no - finished ERA
.
.         A payment for the ERAW has been found, so now get the claimed amount
.         from webihcaf
.
          PACK      KEY40,WBEJTRID,SP30,SP10
          CALL      RSWBIHC6                     * position on trans. id
          CALL      RKWBIHC6                     * read next record
          BRANCH    OVRCD,GCLM1000               * eof - not found
.
          MATCH     WBEJTRID,WBICTRID            * same transaction id still ?
          GOTO      GCLM1000 IF NOT EQUAL        * no - not found
.
          ADD       WBICAMTC,CLAMTOTL            * update ERA claim total
          GOTO      GCLM1000                     * get next payment
.
GCLM9999  RETURN
+
.------------------------------------------------------------
. WebServices IHCW ERAW Remittance Payment Details
.------------------------------------------------------------
ECRD0000  CALL      ECRDH000
.
          PACK      KEY82,WBEIFTID,WBEIRADV,WBEIPNUM,SP70
          CALL      RSWBERD1
ECRD1000  CALL      RKWBERD1
          BRANCH    OVRCD,ECRD9999
.
          MATCH     WBEIFTID,WBEJFTID
          GOTO      ECRD9999 IF NOT EQUAL
.
          MATCH     WBEIRADV,WBEJRADV
          GOTO      ECRD9999 IF NOT EQUAL
.
          MATCH     WBEIPNUM,WBEJPNUM
          GOTO      ECRD9999 IF NOT EQUAL
.
          MOVE      SP70,DIFCINDC
          IF        IBCNMHOS=1
            PACK      KEY40,WBEJTRID,SP70
            CALL      RSWBIHC6
            CALL      RKWBIHC6
            BRANCH    OVRCD,ECRD5000
.
            MATCH     WBEJTRID,WBICTRID
            GOTO      ECRD5000 IF NOT EQUAL
.
            MATCH     SP70,WBICHOSP
            IF        !@EQUAL & !@EOS
              MATCH     WBICHOSP,WBSEHOSP
              IF        !@EQUAL
                PACK      KEY3,WBICHOSP,SP70
                CALL      RDPTHSP1
                IF        OVRCD=0
                  MOVE      PTHSLOCN,SAVELOCN
                ELSE
                  MOVE      SP70,SAVELOCN
                ENDIF
.
                PACK      KEY3,WBSEHOSP,SP70
                CALL      RDPTHSP1
                IF        OVRCD=0
.
                  MATCH     SAVELOCN,PTHSLOCN
.                  GOTO      ECRD1000 IF NOT EQUAL
                  IF        @EQUAL
                    MOVE      "1",DIFCINDC
                  ENDIF
.
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
ECRD5000  CALL      ECRDR000
.
          GOTO      ECRD1000
.
ECRD9999  RETURN
.
.------------------------------------------------------------
. ERA Payment Details (TABLE HEADING)
.------------------------------------------------------------
ECRDH000  WRITE     HTMLFILE;"<tr>":
                             "<td class=HeadingCell width=30%>":
                             "Invoice<br>Number</td>";
.                            
          WRITE     HTMLFILE;"<td class=HeadingCell width=10%>":
                             "Benefit<br>Amount</td>";
.                            
          WRITE     HTMLFILE;"<td class=HeadingCell width=10%>":
                             "Claimed<br>Amount</td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell width=10%>":
                             "Batch<br>Number</td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell width=10%>":
                             "Status</td>":
                             "<td class=HeadingCell width=10%>":
                             "Claim<br>Channel<br>Code</td>":
                             "<td class=HeadingCell width=15% align=center>":
                             "Lodgement<br>Date</td>":
                             "<td class=HeadingCell width=15%>":
                             "Transaction ID<br>&nbsp;</td>":
                             "</tr>"
.
ECRDH999  RETURN
.------------------------------------------------------------
. Eclipse Payment Details (Detail Row)
.------------------------------------------------------------
ECRDR000  REP       " +",HOSPCODE
          REP       " +",WBEJFTID
          REP       " +",WBEJRADV
          REP       " +",WBEJPNUM
          REP       " +",WBEJTRID
          WRITE     HTMLFILE;"<tr><td><img src='../images/CommentIcon.gif'":
                             " class=ListIcon onclick=displayRemD('":
  HOSPCODE,"','",WBEJFTID,"','",WBEJRADV,"','",WBEJPNUM,"','",WBEJTRID,"','D');>&nbsp;";
          REP       "+ ",HOSPCODE
          REP       "+ ",WBEJFTID
          REP       "+ ",WBEJRADV
          REP       "+ ",WBEJPNUM
          REP       "+ ",WBEJTRID
.
          MATCH     "1",DIFCINDC
          IF        @EQUAL
            WRITE     HTMLFILE;"<font color=red>";
          ENDIF
.
          WRITE     HTMLFILE;WBEJARID;
.
          CALL      CLWEBIHC
          PACK      KEY40,WBEJTRID,SP70
          CALL      RSWBIHC6
          CALL      RKWBIHC6
          IF        OVRCD=0        
.
            MATCH     WBEJTRID,WBICTRID
            IF        !@EQUAL
              CALL      CLWEBIHC
            ENDIF
.
          ENDIF
.
          WRITE     HTMLFILE;"&nbsp;",WBICHOSP;
.
          MATCH     "1",DIFCINDC
          IF        @EQUAL
            WRITE     HTMLFILE;"</font>";
          ENDIF
.
          WRITE     HTMLFILE;"</td>";
.
          RJUSTIFY  WBEJBAMT
          UNPACK    WBEJBAMT,DIM7,DIM2
          PACK      DIM10,DIM7,DOT,DIM2
.         MOVE      DIM10,FORM7P2C
          MOVE      ZERO,FORM7P2C
          SCAN      "-",DIM10
          IF        @EQUAL
            REP        "-0",DIM10
            MOVE       DIM10,FORM7P2C
            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
          ELSE
            MOVE      DIM10,FORM7P2C
          ENDIF
.
          MATCH     "1",DIFCINDC
          IF        @EQUAL
            WRITE     HTMLFILE;"<td><font color=red>",FORM7P2C,"</font></td>";
          ELSE
            WRITE     HTMLFILE;"<td>",FORM7P2C,"</td>";
          ENDIF
.
          MOVE      ZERO,CLAMTOTL
          PACK      KEY40,WBEJTRID,SP30,SP10     
          CALL      RSWBIHC6                     * position on trans. id
          CALL      RKWBIHC6                     * read next record
          BRANCH    OVRCD,ECRDR100                * eof - not found
.         
          MATCH     WBEJTRID,WBICTRID            * same transaction id still ?
          GOTO      ECRDR100 IF NOT EQUAL        * no - not found
.         
          MOVE      WBICAMTC,CLAMTOTL            * update ERA claim total
.
ECRDR100  MATCH     "1",DIFCINDC
          IF        @EQUAL
            WRITE     HTMLFILE;"<td><font color=red>",CLAMTOTL,"</font></td>";
.         
            WRITE     HTMLFILE;"<td><font color=red>",WBICBATN,"</font></td>";
          ELSE
            WRITE     HTMLFILE;"<td>",CLAMTOTL,"</td>";
.           
            WRITE     HTMLFILE;"<td>",WBICBATN,"</td>";
          ENDIF
.
          MOVE      "Unknown  ",DIM9
          MATCH     "0",WBEJSTAT
          IF        @EQUAL
            MOVE      "Received ",DIM9
          ENDIF     
.
          MATCH     "1",WBEJSTAT
          IF        @EQUAL 
            MOVE      "Locked   ",DIM9
          ENDIF
.
          MATCH     "2",WBEJSTAT
          IF        @EQUAL
            MOVE      "Released",DIM9
          ENDIF
.
          MATCH     "3",WBEJSTAT
          IF        @EQUAL
            MOVE      "Released*",DIM9
          ENDIF
.
          MATCH     "1",DIFCINDC
          IF        @EQUAL
            WRITE     HTMLFILE;"<td><font color=red>",DIM9,"</font></td>";
.
            WRITE     HTMLFILE;"<td><font color=red>",WBEJCCOD,"</font></td>";
          ELSE
            WRITE     HTMLFILE;"<td>",DIM9,"</td>";
.
            WRITE     HTMLFILE;"<td>",WBEJCCOD,"</td>";
          ENDIF
.
          MOVE      SP70,DIM11
          MATCH     SP70,WBEJLDAT
          IF        !@EQUAL & !@EOS
            UNPACK    WBEJLDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DIM11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MATCH     "1",DIFCINDC
          IF        @EQUAL
            WRITE     HTMLFILE;"<td><font color=red>",DIM11,"</font></td>";
.
            WRITE     HTMLFILE;"<td><font color=red>",WBEJTRID,"</font></td>";
          ELSE
            WRITE     HTMLFILE;"<td>",DIM11,"</td>";
.
            WRITE     HTMLFILE;"<td>",WBEJTRID,"</td>";
          ENDIF
.
          WRITE     HTMLFILE;"</tr>";
.
ECRDR999  RETURN
+
.------------------------------------------------------------
. Get claim amount for a specific transactiom id
.------------------------------------------------------------
GCLD0000  MOVE      ZERO,CLAMTOTL
          PACK      KEY40,WBEJTRID,SP30,SP10
          CALL      RSWBIHC6                     * position on trans. id
          CALL      RKWBIHC6                     * read next record
          BRANCH    OVRCD,GCLD9999                * eof - not found
. 
          MATCH     WBEJTRID,WBICTRID            * same transaction id still ?
          GOTO      GCLD9999 IF NOT EQUAL        * no - not found
.
          MOVE      WBICAMTC,CLAMTOTL            * update ERA claim total
.
GCLD9999  RETURN
+
.*****************************************************************************
.*                              RPAY0000           Called by: KEYA0000       *
.*           Release all payments for the selected ERA batch                 *
.*****************************************************************************
.
.         Initialise counters
.         ERDCOUNT - is the total number of pmserdaf records associated
.                    with the selected ERAW batch.
.         PRLCOUNT - is the number of weberdaf records associated with the
.                    selected ERAW batch, which have previously been "released".
.         RELCOUNT - is the number of weberdaf records associated with the
.                    selected ERAW batch for which payments have been released
.                    in this session.
.
RPAY0000  CALL      CLER0000
          MOVE      SP3,SAVEPART
.
          MOVE      ZERO,EXIT
          MOVE      ZERO,ERDCOUNT
          MOVE      ZERO,PRLCOUNT
          MOVE      ZERO,RELCOUNT
.
          MOVE      ONE,RPYERRIN
.
          CALL      OPENHTML
          BRANCH    EXIT,RPAY9970
.
.         Start releasing payments for the ERAW
.
RPAY0500  REP       "+ ",FUNDTRID
          REP       "+ ",REMITADV
          REP       "+ ",PARTNUMB
          REP       "+ ",HOSPCODE
.
          PACK      KEY61,HOSPCODE,FUNDTRID,REMITADV,PARTNUMB,SP70
          CALL      RDWBERH1
          BRANCH    OVRCD,RPAY9960
.
          MATCH     "3",WBEISTAT
          GOTO      RPAY9950 IF EQUAL
.
          MOVE      "3",WBEISTAT
          CALL      UPWBERH1
.
          CALL      LTMP0000
.
          MOVE      ZERO,LOOPCNTR
.
.         Start releasing payments for the ERA
.
          MOVE      SP30,KEY27
          CALL      RSTEMP2                      * position in file
RPAY1000  CALL      RKTEMP2                      * read next record
          BRANCH    OVRCD,RPAY9000               * end of file
.
.------------------------------------------------------
. Loop counter to prevent timeout internal server error
.
          ADD       ONE,LOOPCNTR
.
          IF        (LOOPCNTR > 5)
            WRITE     HTMLFILE;"<script type=#"text/javascript#"></script>"
            MOVE      ZERO,LOOPCNTR
          ENDIF
.
. -----------------------------------------------------
.
.         Read the weberdaf record as the record status will need to be
.         updated later
.
          PACK      KEY82,WBEJFTID,WBEJRADV,WBEJPNUM,WBEJTRID
          CALL      RDWBERD1                     * record found ?
          BRANCH    OVRCD,RPAY1000               * no - shouldn't happen
.
          RJUSTIFY  WBEJBAMT
          UNPACK    WBEJBAMT,DIM7,DIM2           * set amount paid
          PACK      DIM10,DIM7,DOT,DIM2
          MOVE      ZERO,FORM7P2C
.
          SCAN      "-",DIM10
          IF        @EQUAL
            REP        "-0",DIM10
            MOVE       ZERO,FORM7P2C
            MOVE       DIM10,FORM7P2C
            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
          ELSE
            MOVE       DIM10,FORM7P2C
          ENDIF
.
.         IF        FORM7P2C = 0 | FORM7P2C < 0
          IF        FORM7P2C = 0
            ADD       ONE,RELCOUNT
            MOVE      TWO,WBEJSTAT                 * set as released
            CALL      UPWBERD1
            GOTO      RPAY1000
          ENDIF
.
.         A payment for the ERAW has been found, so check if it needs releasing
.
.         ADD       ONE,ERDCOUNT                 * increment pmserdaf count
          MATCH     "2",WBEJSTAT                 * releasing ?
          IF        @EQUAL
            ADD       ONE,PRLCOUNT               * yes - incr. prev. rel. count
            GOTO      RPAY1000                   * get next payment
          ENDIF
.
          MATCH     "3",WBEJSTAT                 * releasing ?
          IF        @EQUAL
            ADD       ONE,PRLCOUNT               * yes - incr. prev. rel. count
            GOTO      RPAY1000                   * get next payment
          ENDIF
.
.         A claim requiring payment releasing has been found, so
.         get the corresponding webihcaf record and check if same hospital
.         
          MOVE      ZERO,ERASUSIN
          PACK      KEY40,WBEJTRID,SP70     
          CALL      RSWBIHC6                     * position on trans. id/invoice
          CALL      RKWBIHC6                     * read next record
.         BRANCH    OVRCD,RPAY6000               * eof
          IF        OVRCD=ONE
            CLEAR     SERDIM50
            APPEND    WBEJARID,SERDIM50
            APPEND    " - webihcaf record not found",SERDIM50
            RESET     SERDIM50
            GOTO      RPAY6000
          ENDIF
.
          MATCH     WBEJTRID,WBICTRID            * same transaction id still ?
.         GOTO      RPAY6000 IF NOT EQUAL        * no 
          IF        !@EQUAL
            CLEAR     SERDIM50
            APPEND    WBEJARID,SERDIM50
            APPEND    " - tran id not found webihcaf",SERDIM50
            RESET     SERDIM50
            GOTO      RPAY6000
          ENDIF

.
          MOVE      SP70,SAVELOCN
.          IF        IBCNMHOS=1
.            MATCH     WBEIHOSP,WBICHOSP
.            IF        !@EQUAL
.              PACK      KEY3,WBICHOSP,SP70       
.              CALL      RDPTHSP1
.              IF        OVRCD=0
.                MOVE      PTHSLOCN,SAVELOCN      
.              ELSE
.                  SUB       ONE,ERDCOUNT
.                  GOTO      RPAY1000
.              ENDIF
..
.              PACK      KEY3,WBEIHOSP,SP70
.              CALL      RDPTHSP1
.              IF        OVRCD=0
.                MATCH     SAVELOCN,PTHSLOCN
.                IF        !@EQUAL
.                  SUB       ONE,ERDCOUNT
.                  GOTO      RPAY1000
.                ENDIF
.              ELSE
.                  SUB       ONE,ERDCOUNT
.                  GOTO      RPAY1000
.              ENDIF
.            ENDIF
.          ENDIF
.
          PACK      KEY8,WBEJARID,SP70
          RJUSTIFY  KEY8
          CALL      RDPTINV1
.         IF        OVRCD = 1
.           GOTO      RPAY6000
.         ENDIF
          IF        OVRCD=ONE
            CLEAR     SERDIM50
            APPEND    WBEJARID,SERDIM50
            APPEND    " - patinvrf record not found",SERDIM50
            RESET     SERDIM50
            GOTO      RPAY6000
          ENDIF

.
          MATCH     "1",PTINCRST
.         GOTO      RPAY6000 IF EQUAL
          IF        @EQUAL
            CLEAR     SERDIM50
            APPEND    WBEJARID,SERDIM50
            APPEND    "invoice is fully credited patinvrf",SERDIM50
            RESET     SERDIM50
            GOTO      RPAY6000
          ENDIF
.
          UNPACK    SP70,KEY8,KEY12
          UNPACK    WBEJARID,KEY8,KEY12
          MATCH     SP70,KEY12
          GOTO      RPAY6000 IF NOT EQUAL
.
.         Validate  for adjusted claims
.
          PACK      SAVKEY24,WBICADMN,WBICINVN,WBICBATN,SP70
          MOVE      WBICADMN,SAVEVISN
          MOVE      WBICTRID,SAVETRID
.
          PACK      KEY24,WBICADMN,SP70
          CALL      RSWBIHC4
RPAY1400  CALL      RKWBIHC4
          BRANCH    OVRCD,RPAY1490
.
          MATCH     SAVEVISN,WBICADMN
          GOTO      RPAY1490 IF NOT EQUAL
.
          MATCH     SAVETRID,WBICPCTI
          GOTO      RPAY1400 IF NOT EQUAL
.
          PACK      KEY24,SAVKEY24,SP70
          CALL      RDWBIHC4
.
          GOTO      RPAY6000
.
RPAY1490  PACK      KEY24,SAVKEY24,SP70
          CALL      RDWBIHC4
.
.         Now lock all the relevant records prior to releasing the payment.
.         Check that we can lock the Health Fund receipts record.
.
RPAY1500  MOVE      "HFR",PRXCODE   * System Lock Audits
          CALL      GETSLK00        * Get System Lock Audits
.
          PACK      KEY8,WBICINVN,SP70
          CALL      RDHFRE1                      * lock record found ?
          IF        OVRCD = 1
            MOVE      ONE,HFRSTAT                * no - write one with lock
            MOVE      WBICINVN,HFRINVR
            CALL      WRHFRE1
          ELSE
            COMPARE   ZERO,HFRSTAT               * yes - is it already locked ?
            IF        @EQUAL
              MOVE      ONE,HFRSTAT              * no - lock now
              CALL      UPHFRE1
            ELSE
              CALL      RELSLK00                 * Release System Lock Audits
              GOTO      RPAY8000                 * record already locked
            ENDIF
          ENDIF
          CALL      RELSLK00        * Release System Lock Audits
.
.         Now check the we can lock the invoice record
.
          MOVE      WBICINVN,KEY8
          CALL      RLPTINV1
          IF        OVRCD = 1
.           MOVE      THREE,UNLKFLAG
.           CALL      UNLK0000                   * unlock any locked records
.           GOTO      RPAY8000
            GOTO      RPAY6100
          ELSE
            IF        OVRCD = 2
              MOVE      THREE,UNLKFLAG
              CALL      UNLK0000                 * unlock any locked records
              GOTO      RPAY8000
            ENDIF
          ENDIF
.
.         Check that we can lock the visit record
.             
          PACK      KEY8,WBICADMN,SP70
          CALL      RLPTVIS1
          IF        OVRCD = 1
            MOVE      TWO,UNLKFLAG
            CALL      UNLK0000                   * unlock any locked records
            GOTO      RPAY8000
          ELSE      
            IF        OVRCD = 2
              MOVE      TWO,UNLKFLAG
              CALL      UNLK0000                 * unlock any locked records
              GOTO      RPAY8000
            ENDIF
          ENDIF
.
.         All the relevant records have been locked.
.         As there may be payments in this remittance for more than one
.         participant, check if the participant code has changed.  If it
.         has, then we need to get a new receipt number.
.
          MATCH     SAVEPART,PARTPANT            * same participant still ?
          IF        !@EQUAL
            CALL      ALLCRC00
.
            MOVE      PARTPANT,SAVEPART          * save new participant code
          ENDIF
.
.         Process the payment
.
          RJUSTIFY  WBEJBAMT
          UNPACK    WBEJBAMT,DIM7,DIM2           * set amount paid
          PACK      DIM10,DIM7,DOT,DIM2
          MOVE      ZERO,FORM7P2C
.
          SCAN      "-",DIM10
          IF        @EQUAL
            REP        "-0",DIM10
            MOVE       ZERO,FORM7P2C
            MOVE       DIM10,FORM7P2C
            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
          ELSE
            MOVE       DIM10,FORM7P2C
          ENDIF
.
          MOVE      FORM7P2C,WBICAMTP
.         ADD       FORM7P2C,WBICAMTP
          ASSIGN    (PINVHFDA-WBICAMTP),PINVHFDA
.         
          CALL      IBACLOCK                     * get current date
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          MOVE      CTIMEIS,CURRTIME
.
.         Check if the invoice now balances
.
          MOVE      PINVAMT,FORM10P2             * Invoice amount +
          ADD       PINVPATA,FORM10P2            * Patient payments +
          ADD       PINVHFDA,FORM10P2            * H.F payments +
          ADD       PINVOTHA,FORM10P2            * Other payments +
          ADD       PINVJOUR,FORM10P2            * Journals +
          ADD       PTINGSTJ,FORM10P2            * Journal GST = amt outstanding
.
          MOVE      "99999999",PINVBLCD          * default to not balancing
.
          COMPARE   ZERO,FORM10P2                * Does invoice balance ?
          IF        @EQUAL
            MOVE      CURRDATE,PINVBLCD          * yes - record balanced date
.           MOVE      TWO,PTDTAPAY               * set A/P flag - balanced
          ELSE
.           MOVE      ZERO,PTDTAPAY              * set A/P flag - not balanced
          ENDIF
          MOVE      FORM10P2,PINVPCSH
.         CALL      UPINV1                       * update/unlock invoice record
.
.         PROC      FLAGDEBT
.
.         Create the patdtraf cash receipt record.
.
          MOVE      WBICADMN,TADMNO              * load admission number
.         
.         Get the next transaction number.  As we have already locked
.         the visit record, there should be no problem getting the
.         next transaction number.
.         
.RPAY3000  MOVE      WBICADMN,KEY8                * get next transaction number
.          CALL      TRVISA1
.         
.          PACK      KEY22,WBICADMN,WBICINVN,PVITRAN
.          CALL      RDADTRN1                     * patdtraf record on file ?
.          COMPARE   ZERO,OVRCD
.          GOTO      RPAY3000 IF EQUAL            * yes
.
.          MOVE      PVITRAN,TTRANSN1             * load transaction number
.          MOVE      ANSH,TTYPEDEB                * set to "patient" type of debt
.          MOVE      WBICHFND,TDCODE
.
.          ASSIGN    (WBICAMTP*SEQ),TPATAMTT
.          MOVE      TPATAMTT,TREBATE
.
.          MOVE      ZERO,TPATAMTG                * set $ amounts
.          MOVE      ZERO,TPATAMTH
.          MOVE      ZERO,TPATAMTI
.          MOVE      ZERO,TPATAMTP
.
.          MOVE      CCC,TFCENT                   * set payment date
.          MOVE      CYY,TFYEAR
.          MOVE      CMM,TFMONTH
.          MOVE      CDD,TFDAY
.
.          MOVE      ZERO,TTCENT                  * initialise accomm. to dates
.          MOVE      ZERO,TTYEAR
.          MOVE      ZERO,TTMONTH
.          MOVE      ZERO,TTDAY
.
.          PACK      TTYPE,ANSP,ANSY              * set for payment
.          MOVE      SP9,TITEMNO
.          MOVE      WBICINVN,TREF                * load invoice no.
.          MOVE      SIX,TPAYTYPE                 * direct deposit
.
          MOVE      HRECPT,TRECEIPT
.
.          IF        WBICEETP = 0
.            MOVE      "Unknown Health Fund           ",HFNAME
.            PACK      KEY14,WBICHFND,ZERO4,SP20
.            CALL      RDFUND1                    * HF on file ?
.            MOVE      HFNAME,TDDESC              * load HF description
.          ELSE
.            MOVE      "Unknown Claim Code  ",TDESC
.            PACK      KEY5,ANSC,ANSL,PINVCLM
.            CALL      RDCODE1
.            MOVE      TDESC,TDDESC               * load claim code description
.          ENDIF
.
.          MOVE      ONE,TINVPRT                  * invoice printed
.          MOVE      FIVE,TRECTYPE                * cash receipt
.          MOVE      ZERO,TNODAYS
.          MOVE      ZERO,TCLAIM
..         MOVE      ZERO,PTDTREBT
.          MOVE      SP6,TDOCTA
.          MOVE      ZERO,TSERVS
.          MOVE      SP6,TDOCTO
.          MOVE      SP2,TSESSION
.          MOVE      SP3,TMISGRP
.          MOVE      SP3,TDEPTYP
.          MOVE      SP3,TDWARD
.          MOVE      SP3,TCLMTYP
.          MOVE      SP3,TADMTYP
.          MOVE      WBICBATN,TBATCHN             * load batch number
.          MOVE      ZERO,TNINVS
.          MOVE      SP3,PTDTBTYP
.          MOVE      ZERO,PTDTLSPT
.          MOVE      ZERO,PTDTLSRB
.          MOVE      ZERO,PTDTDTYP
.          PACK      PTDTDES2,SP20,SP20
.          MOVE      ZERO,PTDTEPSD
.          MOVE      ZERO,PTDTCCU
..         MOVE      SP6,PTDTSURG
..         MOVE      SP1,PTDTDEPS
.
.          MOVE      CURRDATE,PTDTEFFD            * load payment date
.
.          MOVE      ZERO,PTDTGSTA
.          MOVE      SP6,PTDTGSTC
.          MOVE      ZERO,PTDTGSTM
.          MOVE      ZERO,PTDTADPT
.          MOVE      ZERO,PTDTADRB
.          MOVE      ZERO,PTDTGSTL
.          MOVE      SP70,PTDTTIME
.          MOVE      SP70,PTDTCRST
.          MOVE      SP70,PTDTUNIQ
.          MOVE      SP70,PTDTCNTR
.          MOVE      SP70,PTDTCPRC
.          MOVE      SP70,PTDTCONT
.          MOVE      SP70,PTDTSUNQ
.          MOVE      SP70,PTDTBTCH
..         MOVE      ANSN,PTDTSSAP
..         MOVE      ZERO,PTDTMVBR
.          MOVE      ZERO,PTDTEPSD
..         MOVE      SP1,PTDTMHDP
.          PACK      TSPARE,SP30,SP30
.
.          CALL      WRDTRN1                     * write patdtraf journal record
.
          ADD       ONE,RELCOUNT
.
.         Write to rcpbnkaf
.
          PACK      KEY12,HRECPT,SP70
          CALL      RDRCBNK1
          IF        OVRCD=1
.
            MOVE      HRECPT,RCBNRECN
            CALL      IBACLOCK
            PACK      RCBNTDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBNTDAT
            RJUSTIFY  WBEJBAMT
            UNPACK    WBEJBAMT,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.         
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       ZERO,FORM7P2C           
              MOVE       DIM10,FORM7P2C          
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE    
              MOVE       DIM10,FORM7P2C
            ENDIF
.
            MOVE      FORM7P2C,RCBNTOTP
            MOVE      RCCNERCD,RCBNCDRW
            MOVE      RCCNERCA,RCBNCHQA
            MOVE      WBEIHOSP,RCBNMHOS
.
            IF        IBCNMHOS=1
              MATCH     SP70,RCBNMHOS
              IF        !@EQUAL & !@EOS
                PACK      KEY3,RCBNMHOS,SP70
                CALL      RDPTHSP1
                IF        OVRCD=0
                  MATCH     SP70,PTHSERCD
                  IF        !@EQUAL & !@EOS
                    MOVE      PTHSERCD,RCBNCDRW
                  ENDIF
                  MATCH     SP70,PTHSERCA
                  IF        !@EQUAL & !@EOS
                    MOVE      PTHSERCA,RCBNCHQA
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
.
            MOVE      CHOSPNUM,RCBNMDHS
            MOVE      "1",RCBNTTYP               * CAR 227986
            MOVE      WBICHFND,RCBNRCOD
            MOVE      ZERO,RCBNSTAT
            MOVE      SP70,RCBNBDAT
            MOVE      SP70,RCBNBTIM
            MOVE      SP70,RCBNRDAT
            MOVE      SP70,RCBNRTIM
            PACK      RCBNCDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBNCDAT
            CLOCK     TIME,RCBNCTIM
            MOVE      WBSEUID,RCBNCUID
            MOVE      SP70,RCBNUDAT
              MOVE      SP70,RCBNUTIM
            MOVE      SP70,RCBNUUID
            MOVE      SP70,RCBNSPAR
.
            PACK      KEY12,HRECPT,SP70
            CALL      WRRCBNK1
.
          ELSE
.
            RJUSTIFY  WBEJBAMT
            UNPACK    WBEJBAMT,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       DIM10,FORM7P2C
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE
              MOVE      DIM10,FORM7P2C
            ENDIF
.
            ADD       FORM7P2C,RCBNTOTP
            CALL      UPRCBNK1
.
          ENDIF
.
.         Write to rcpbdtaf
.
          PACK      KEY15,HRECPT,SP1,SP1,ONE,SP70
          CALL      RDRCBDT1
          IF        OVRCD = 1
.
            CALL      IBACLOCK
            PACK      RCBDTDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBDTDAT
            MOVE      HRECPT,RCBDRECN
            MOVE      "  1",RCBDUNIQ
            MOVE      WBEIHOSP,RCBDMHOS
            MOVE      CHOSPNUM,RCBDMDHS
            MOVE      "4",RCBDPTYP
            CALL      DDEP0000            * Get payment code for Direct Deposit
.
            RJUSTIFY  WBEJBAMT
            UNPACK    WBEJBAMT,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       DIM10,FORM7P2C
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE
              MOVE      DIM10,FORM7P2C
            ENDIF
            MOVE      FORM7P2C,RCBDPAMT
.
            MOVE      PARTPANT,RCBDPAYD
            MOVE      SP70,RCBDCHQN
            MOVE      WBEINAME,RCBDDRAW
            MOVE      WBEIBNAM,RCBDBANK
            MOVE      WBEIBBSB,RCBDBRCH
            MOVE      SP70,RCBDCRDT
            MOVE      WBEIPREF,RCBDSTRF
....        MOVE      SP70,RCBDMONM                                   *D-187485
            MOVE      SP70,RCBDEFTT
            CALL      IBACLOCK
            PACK      RCBDCDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBDCDAT
            CLOCK     TIME,RCBDCTIM
            MOVE      WBSEUID,RCBDCUID
            MOVE      SP70,RCBDUDAT
            MOVE      SP70,RCBDUTIM
            MOVE      SP70,RCBDUUID
            MOVE      SP70,RCBDSPAR
.
            PACK      KEY15,HRECPT,RCBDUNIQ,SP70
            CALL      WRRCBDT1
.
          ELSE
.
            RJUSTIFY  WBEJBAMT
            UNPACK    WBEJBAMT,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       DIM10,FORM7P2C
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE
              MOVE      DIM10,FORM7P2C
            ENDIF
.
            ADD       FORM7P2C,RCBDPAMT
            CALL      UPRCBDT1
.
          ENDIF
.
.         Write to rcpdteaf
.
RPAY3500  PACK      KEY17,HRECPT,Z70
          CALL      RSRCDTE1
          CALL      RPRCDTE1
          IF        OVRCD = 1
            MOVE      "    1",RCDTTCNT
            CALL      WRRDTE00
          ELSE
            MOVE      HRECPT,DIM12
            MATCH     DIM12,RCDTRECN
            IF        !@EQUAL
              MOVE      "    1",RCDTTCNT
              CALL      WRRDTE00
            ELSE
              MOVE      RCDTTCNT,DIM5
              SQUEEZE   DIM5
              MOVE      ZERO,FORM5
              MOVE      DIM5,FORM5
              ADD       ONE,FORM5
              MOVE      FORM5,RCDTTCNT
.
              PACK      KEY17,HRECPT,RCDTTCNT,SP70
              CALL      RARCDTE1
              IF        OVRCD = 1
                CALL      WRRDTE00
              ELSE
                GOTO      RPAY3500
              ENDIF
            ENDIF
          ENDIF
.
.         Now "close" the current claim (providing that a processing report
.         has been received) and update the payment amount and
.         the payment date
.
          MOVE      WBEJARID,DIM20               * CAR 227986
          SQUEEZE   DIM20
.         
          PACK      KEY65,WBICTRID,PARTPANT,DIM20,Z70
          CALL      RSWBIHD2                     * position on trans. id
RPAY4000  CALL      RPWBIHD2                     * read previous record
          BRANCH    OVRCD,RPAY4500               * eof - no proc. report
.         
          MATCH     WBICTRID,WBIKFTID            * same claim trans. id ?
          GOTO      RPAY4500 IF NOT EQUAL        * no - no proc. report 
.         
          MATCH     PARTPANT,WBIKFBID            * same fund brand. id ?
          GOTO      RPAY4500 IF NOT EQUAL        * no - no proc. report
.         
          MATCH     DIM20,WBIKARID               * same invoice number ?
          GOTO      RPAY4500 IF NOT EQUAL        * no - no proc. report
.
          MATCH     ANSA,WBIKCFAC                * assessment code "A" ?
          GOTO      RPAY4000 IF NOT EQUAL        * no - get next report
.
.         A processing report was found
.
          MOVE      TEN6,WBICFLAG                * set status to closed
.
RPAY4500  PACK      WBICSTAT,SP1,TWO             * set closed with payment
          MOVE      WBEJLDAT,WBICPDAT            * set payment date
.
          RJUSTIFY  WBEJBAMT
          UNPACK    WBEJBAMT,DIM7,DIM2           * set amount paid
          PACK      DIM10,DIM7,DOT,DIM2
          MOVE      ZERO,FORM7P2C
.
          SCAN      "-",DIM10
          IF        @EQUAL
            REP        "-0",DIM10
            MOVE       ZERO,FORM7P2C
            MOVE       DIM10,FORM7P2C
            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
          ELSE
            MOVE       DIM10,FORM7P2C
          ENDIF
.
          MOVE      FORM7P2C,WBICAMTP
.         ADD       FORM7P2C,WBICAMTP
          CALL      UPWBIHC6                     * update claim
.
.         Finally, write an IHCW History record (webihaaf)
.
          MOVE      WBICINVN,WBIIINVN
          CALL      IBACLOCK
          PACK      WBIIDATE,CCC,CYY,CMM,CDD    
          REP       " 0",WBIIDATE
          MOVE      CTIMEIS,WBIITIME
          MOVE      WBICBATN,WBIIBATN
          MOVE      WBICFLAG,WBIISTAT
          MOVE      " 5",WBIITYPE
          MOVE      WBSEUID,WBIIOPER
          MOVE      WBICTRID,WBIITRID
          MOVE      SP4,WBIIEROR
          MOVE      "Released",WBIIEROT
          PACK      WBIIEROT,WBIIEROT,SP70
          MOVE      WBICMSID,WBIIMSID
          MOVE      SP30,WBIISPAR
.
RPAY5000  PACK      KEY26,WBIIINVN,WBIIDATE,WBIITIME,WBIITYPE,SP70
          CALL      RAWBIHA1
          IF        OVRCD = 1
            CALL      WRWBIHA1
          ELSE
            CALL      IBACLOCK
            PACK      WBIIDATE,CCC,CYY,CMM,CDD
            REP       " 0",WBIIDATE
            MOVE      CTIMEIS,WBIITIME
            GOTO      RPAY5000
          ENDIF
.
.         Update the remittance table (weberdaf) to indicate that
.         the claim payment has been released to the relevant ibaPAS tables
.
          MOVE      TWO,WBEJSTAT                 * set as released
          CALL      UPWBERD1
.
          MOVE      ONE,UNLKFLAG
          CALL      UNLK0000                     * unlock all locked records
.
          MOVE      WBICINVN,KEY8
          CALL      CREC0000              * Update Un-reconciled inv.file
.
          MOVE      SP70,TTYPEARG
          MOVE      " 1",TTYPEARG
          CALL      DELET200
.
          MOVE      " 3",TTYPEARG
          CALL      DELET200
.
          MOVE      " 4",TTYPEARG
          CALL      DELET200
.
          MOVE      " 5",TTYPEARG
          CALL      DELET200
.
          GOTO      RPAY1000
.
.*******************************************************************************
.         Now lock all the relevant records prior to releasing the payment.
.         Check that we can lock the Health Fund receipts record.
.
RPAY6000  MOVE      "HFR",PRXCODE   * System Lock Audits
          CALL      GETSLK00        * Get System Lock Audits
.           
          MOVE      WBEJARID,DIM8
          RJUSTIFY  DIM8
.
          PACK      KEY8,DIM8,SP70
          CALL      RDHFRE1                      * lock record found ?
          IF        OVRCD = 1
            MOVE      ONE,HFRSTAT                * no - write one with lock
            MOVE      DIM8,HFRINVR
            CALL      WRHFRE1
          ELSE
            COMPARE   ZERO,HFRSTAT               * yes - is it already locked ?
            IF        @EQUAL
              MOVE      ONE,HFRSTAT              * no - lock now
              CALL      UPHFRE1
            ELSE
              CALL      RELSLK00                 * Release System Lock Audits
              GOTO      RPAY8000                 * record already locked
            ENDIF
          ENDIF
          CALL      RELSLK00        * Release System Lock Audits
.
.         All the relevant records have been locked.
.         As there may be payments in this remittance for more than one
.         participant, check if the participant code has changed.  If it
.         has, then we need to get a new receipt number. 
.         
RPAY6100  MATCH     SAVEPART,PARTPANT            * same participant still ?
          IF        !@EQUAL
            CALL      ALLCRC00
.
            MOVE      PARTPANT,SAVEPART          * save new participant code
          ENDIF
.
          MOVE      HRECPT,TRECEIPT
.
          ADD       ONE,RELCOUNT
.
.         MOVE      ONE,WBICEETP
.         MATCH     "DVA",WBEJPART
.         IF        !@EQUAL
.           MOVE      ZERO,WBICEETP
.         ENDIF
.
          RJUSTIFY  WBEJBAMT
          UNPACK    WBEJBAMT,DIM7,DIM2           * set amount paid
          PACK      DIM10,DIM7,DOT,DIM2
          MOVE      ZERO,FORM7P2C
.
          SCAN      "-",DIM10
          IF        @EQUAL
            REP        "-0",DIM10
            MOVE       ZERO,FORM7P2C
            MOVE       DIM10,FORM7P2C
            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
          ELSE
            MOVE       DIM10,FORM7P2C
          ENDIF
.
.         MOVE      FORM7P2C,WBICAMTP
.
.         Write to rcpbnkaf
.
          PACK      KEY12,HRECPT,SP70
          CALL      RDRCBNK1
          IF        OVRCD=1
.
            MOVE      HRECPT,RCBNRECN
            CALL      IBACLOCK
            PACK      RCBNTDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBNTDAT
            RJUSTIFY  WBEJBAMT
            UNPACK    WBEJBAMT,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       ZERO,FORM7P2C
              MOVE       DIM10,FORM7P2C
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE
              MOVE       DIM10,FORM7P2C
            ENDIF
.
            MOVE      FORM7P2C,RCBNTOTP
            MOVE      RCCNERCD,RCBNCDRW
            MOVE      RCCNERCA,RCBNCHQA
            MOVE      WBEIHOSP,RCBNMHOS
.
            IF        IBCNMHOS=1
              MATCH     SP70,RCBNMHOS
              IF        !@EQUAL & !@EOS
                PACK      KEY3,RCBNMHOS,SP70
                CALL      RDPTHSP1
                IF        OVRCD=0
                  MATCH     SP70,PTHSERCD
                  IF        !@EQUAL & !@EOS
                    MOVE      PTHSERCD,RCBNCDRW
                  ENDIF
                  MATCH     SP70,PTHSERCA
                  IF        !@EQUAL & !@EOS
                    MOVE      PTHSERCA,RCBNCHQA
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
.
            MOVE      CHOSPNUM,RCBNMDHS
            MOVE      "1",RCBNTTYP               * CAR 227986
.
.           MOVE      WBICHFND,RCBNRCOD
.
            MOVE      SP70,RCBNRCOD
            MOVE      WBEJARID,DIM8
            RJUSTIFY  DIM8
.
            PACK      KEY16,DIM8,SP70
            CALL      RSWBIHC2
            CALL      RKWBIHC2
            BRANCH    OVRCD,RPAY6200
.
            MATCH     DIM8,WBICINVN
            GOTO      RPAY6200 IF NOT EQUAL
.
            MOVE      WBICHFND,RCBNRCOD
.
            GOTO      RPAY6300
.
RPAY6200    PACK      KEY23,DIM8,SP70
            CALL      RDSDTRN5
            CALL      RDKDTRN5
            IF        OVRCD=0
              MATCH     DIM8,TREF
              IF        @EQUAL
                PACK      KEY8,DTADMNO,SP70
                CALL      RDMISS1
                IF        OVRCD=0
                  MOVE      AFUNDH,RCBNRCOD
                ENDIF
              ENDIF
            ENDIF 
.
RPAY6300    MOVE      ZERO,RCBNSTAT
            MOVE      SP70,RCBNBDAT
            MOVE      SP70,RCBNBTIM
            MOVE      SP70,RCBNRDAT
            MOVE      SP70,RCBNRTIM
            PACK      RCBNCDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBNCDAT
            CLOCK     TIME,RCBNCTIM
            MOVE      WBSEUID,RCBNCUID
            MOVE      SP70,RCBNUDAT
              MOVE      SP70,RCBNUTIM
            MOVE      SP70,RCBNUUID
            MOVE      SP70,RCBNSPAR
.
            PACK      KEY12,HRECPT,SP70
            CALL      WRRCBNK1
.
          ELSE
.
            RJUSTIFY  WBEJBAMT
            UNPACK    WBEJBAMT,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       DIM10,FORM7P2C
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE
              MOVE      DIM10,FORM7P2C
            ENDIF
.
            ADD       FORM7P2C,RCBNTOTP
            CALL      UPRCBNK1
.
          ENDIF
.
.         Write to rcpbdtaf
.
          PACK      KEY15,HRECPT,SP1,SP1,ONE,SP70
          CALL      RDRCBDT1
          IF        OVRCD = 1
.
            CALL      IBACLOCK
            PACK      RCBDTDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBDTDAT
            MOVE      HRECPT,RCBDRECN
            MOVE      "  1",RCBDUNIQ
            MOVE      WBEIHOSP,RCBDMHOS
            MOVE      CHOSPNUM,RCBDMDHS
            MOVE      "4",RCBDPTYP
            CALL      DDEP0000            * Get payment code for Direct Deposit
.
            RJUSTIFY  WBEJBAMT
            UNPACK    WBEJBAMT,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       DIM10,FORM7P2C
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE
              MOVE      DIM10,FORM7P2C
            ENDIF
            MOVE      FORM7P2C,RCBDPAMT
.
            MOVE      PARTPANT,RCBDPAYD
            MOVE      SP70,RCBDCHQN
            MOVE      WBEINAME,RCBDDRAW
            MOVE      WBEIBNAM,RCBDBANK
            MOVE      WBEIBBSB,RCBDBRCH
            MOVE      SP70,RCBDCRDT
            MOVE      WBEIPREF,RCBDSTRF
....        MOVE      SP70,RCBDMONM                                   *D-187485
            MOVE      SP70,RCBDEFTT
            CALL      IBACLOCK
            PACK      RCBDCDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBDCDAT
            CLOCK     TIME,RCBDCTIM
            MOVE      WBSEUID,RCBDCUID
            MOVE      SP70,RCBDUDAT
            MOVE      SP70,RCBDUTIM
            MOVE      SP70,RCBDUUID
            MOVE      SP70,RCBDSPAR
.
            PACK      KEY15,HRECPT,RCBDUNIQ,SP70
            CALL      WRRCBDT1
.
          ELSE
.
            RJUSTIFY  WBEJBAMT
            UNPACK    WBEJBAMT,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       DIM10,FORM7P2C
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE
              MOVE      DIM10,FORM7P2C
            ENDIF
.
            ADD       FORM7P2C,RCBDPAMT
            CALL      UPRCBDT1
.
          ENDIF
.
.         Write to rcpdteaf
.
RPAY6500  PACK      KEY17,HRECPT,Z70
          CALL      RSRCDTE1
          CALL      RPRCDTE1
          IF        OVRCD = 1
            MOVE      "    1",RCDTTCNT
            CALL      WRRDTS00
          ELSE
            MOVE      HRECPT,DIM12
            MATCH     DIM12,RCDTRECN
            IF        !@EQUAL
              MOVE      "    1",RCDTTCNT
              CALL      WRRDTS00
            ELSE
              MOVE      RCDTTCNT,DIM5
              SQUEEZE   DIM5
              MOVE      ZERO,FORM5
              MOVE      DIM5,FORM5
              ADD       ONE,FORM5
              MOVE      FORM5,RCDTTCNT
.
              PACK      KEY17,HRECPT,RCDTTCNT,SP70
              CALL      RARCDTE1
              IF        OVRCD = 1
                CALL      WRRDTS00
              ELSE
                GOTO      RPAY6500
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      THREE,WBEJSTAT          * set as released to suspense acc
          CALL      UPWBERD1
.
          MOVE      THREE,UNLKFLAG
          CALL      UNLS0000
.
          MOVE      SP70,TTYPEARG
          MOVE      " 1",TTYPEARG
          CALL      DELET200
.
          MOVE      " 3",TTYPEARG
          CALL      DELET200
.
          MOVE      " 4",TTYPEARG
          CALL      DELET200
.
          MOVE      " 5",TTYPEARG
          CALL      DELET200
.
          GOTO      RPAY1000
.*******************************************************************************
.
.         A record was locked for this claim, so set the status to "locked"
.
RPAY8000  MOVE      "1",WBEJSTAT
          CALL      UPWBERD1
          GOTO      RPAY1000
.
.         Check if all the payment records for the ERAW were released and
.         update the ERAW header status accordingly.
.
RPAY9000  IF        ERDCOUNT = (PRLCOUNT+RELCOUNT)
            MOVE      "2",WBEISTAT               * set to "released"
          ELSE
            MOVE      "1",WBEISTAT               * set to "partial"
          ENDIF
          CALL      UPWBERH1
.
          IF        IBCNMHOS=1
            MATCH     "2",WBEISTAT
            IF        @EQUAL
              CALL      CDERA000
            ENDIF
          ENDIF
.
.         Unlock general records.
.
          MATCH     "1",MULTLT01
          IF        @EQUAL
            MOVE      "2",DIM1C
            PACK      REMITKEY,WBEIHOSP,WBEIFTID,WBEIRADV,WBEIPNUM,SP70
            CALL      PRNREM00
          ENDIF
.
          MATCH     "1",WBEISTAT
          IF        @EQUAL
            MOVE      "Payment record partially released.",WEBTITLE
          ELSE 
            MOVE      "Payment record released.",WEBTITLE
          ENDIF
.         CALL      RPYERR00
.         MOVE      ONE,EXIT
          MOVE      ZERO,EXIT
          GOTO      RPAY9999  
.
RPAY9950  MOVE      "Remittance Currently being processed.",WEBTITLE
          CALL      RPYERR00
          MOVE      ONE,EXIT
          GOTO      RPAY9999
.
RPAY9960  MOVE      "Cannot find weberhaf record",WEBTITLE
          CALL      RPYERR00
          MOVE      ONE,EXIT
          GOTO      RPAY9999
.
RPAY9970  DISPLAY   "*** Fifo Not Found - ",FILNAM," ***"
          MOVE      ONE,EXIT
          GOTO      RPAY9999
.
RPAY9999  RETURN
.
.*****************************************************************************
.         Get payment type for Direct deposit
.*****************************************************************************
.
DDEP0000  MOVE      "Py",KEY2
          PACK      KEY5,KEY2,SP70
          CALL      RDSCODE1
DDEP1000  CALL      RDKCODE1
          BRANCH    OVRCD,DDEP9000
.
          MATCH     "Py",TCODE
          GOTO      DDEP9000 IF NOT EQUAL
.
          MATCH     "I",PTCOACTV
          GOTO      DDEP1000 IF EQUAL       * Inactive
.
          MOVE      ZERO,F2
          SQUEEZE   PTCDNHCP
          MOVE      PTCDNHCP,F2
          COMPARE   FOUR,F2
          GOTO      DDEP1000 IF NOT EQUAL
.
          MOVE      ACODE,RCBDPCOD           * Payment code for Direct Deposit
          GOTO      DDEP9999
.
DDEP9000  MOVE      SP70,RCBDPCOD
DDEP9999  RETURN
+
.*****************************************************************************
.*                                UNLK0000         Called by: RPAY0000       *
.*               Unlock claim related records after releasing payments       *
.* Requires: UNLKFLAG - unlock flag                                          *
.*                      1 = patvisaf, patinvrf & pathfrec                    *
.*                      2 = patinvrf & pathfrec                              *
.*                      3 = pathfrec                                         *
.*****************************************************************************
.
UNLK0000  BRANCH    UNLKFLAG,UNLK1000:
                             UNLK2000:
                             UNLK3000
.
UNLK1000  CALL      UUPTVIS1                     * unlock visit record
.
UNLK2000  CALL      UUPTINV1                     * unlock invoice record
.
.         Unlock the pathfrec record
.
UNLK3000  MOVE      WBICINVN,KEY8
          CALL      RDHFRE1                      * HF receipts record found ?
          BRANCH    OVRCD,UNLK9999               * no
.
          MOVE      ZERO,HFRSTAT                 * set the status to 'free'
          CALL      UPHFRE1
.
UNLK9999  RETURN
+
.------------------------------------------------------------------------------
. Allocate New Receipt Number
.------------------------------------------------------------------------------
.
ALLCRC00  READ      CONTROLF,THIRTY6;*193,HRECPT
          ADD       ONE,HRECPT
          WRITAB    CONTROLF,THIRTY6;*193,HRECPT
          SUB       ONE,HRECPT
.
          MOVE      HRECPT,KEY12
          CALL      RDRCBNK1
          COMPARE   ZERO,OVRCD
          GOTO      ALLCRC00 IF EQUAL
.
ALLCRC99  RETURN
+
.------------------------------------------------------------------------------
.  Get Income account and Control Account
.------------------------------------------------------------------------------
.
GTACCT00  PACK      KEY3,RCDTREGI,SP70
          CALL      RDREGA1
          BRANCH    OVRCD,GTACCT80
.         MOVE      REGHOSP,RCDTMHOS       * Hospital id
          MOVE      REGGST,RCDTGSTC        * GST Code
.
          COMPARE   FIVE,HSYS1
          GOTO      GTACCT20 IF EQUAL      * Using Integra Extended
          COMPARE   FOUR,HSYS1
          GOTO      GTACCT20 IF EQUAL      * Using Comma Delimeted
          COMPARE   TWO,HSYS1
          GOTO      GTACCT20 IF EQUAL      * Using Other FMS - get Acc.from Reg.
          COMPARE   THREE,HSYS1
          GOTO      GTACCT20 IF EQUAL      * Using Other FMS - for Integra
.
          MATCH     SP20,REGGENLD
          GOTO      GTACCT80 IF EQUAL
          GOTO      GTACCT80 IF EOS
.
          MOVE      REGGENLD,RCDTINCA
          MOVE      REGGENLD,INCMACCT
          CALL      GETC0000              * Get Control Account Details
          PACK      RCDTBNKA,FMLALEDG,FMCSBNK
          GOTO      GTACCT99
.
.         Get Credit and Bank Account from Register record
.
GTACCT20  MOVE      REGGENDB,RCDTINCA       * Debtors Control account as Crd.Acc
          MOVE      REGGENBK,RCDTBNKA       * Debit account
          GOTO      GTACCT99
.
GTACCT80  MOVE      SP70,RCDTINCA
          MOVE      WBEIBNUM,RCDTBNKA
          GOTO      GTACCT99
.
GTACCT99 RETURN
+
.------------------------------------------------------------------------
. Get Control Account Details
.------------------------------------------------------------------------
GETC0000  UNPACK    INCMACCT,LEDNO,ACCNO
          PACK      KEY2,LEDNO
          CALL      RDFMLA1              * Ledger Master Details
          MOVE      FMLABNK,FMCSBNK
          MOVE      FMLADEB,FMCSDEB
          MOVE      FMLAAGST,FMCSAGST
.
          PACK      KEY14,INCMACCT,SP70
          CALL      RDFMCS1              * Selected Control Accounts
          BRANCH    OVRCD,GETC9000
.
          MATCH     SP70,FMCSBNK
          GOTO      GETC0010 IF NOT EQUAL
.
          MOVE      FMLABNK,FMCSBNK
.
GETC0010  MATCH     SP70,FMCSDEB
          GOTO      GETC0020 IF NOT EQUAL
.
          MOVE      FMLADEB,FMCSDEB
.
GETC0020  MATCH     SP70,FMCSAGST
          GOTO      GETC9999 IF NOT EQUAL
.
          MOVE      FMLAAGST,FMCSAGST
.
          GOTO      GETC9999
.
GETC9000  MOVE      FMLABNK,FMCSBNK
          MOVE      FMLADEB,FMCSDEB
          MOVE      FMLAAGST,FMCSAGST
.
GETC9999  RETURN
+
.--------------------------------------------------------------------------
.*                             PRNREM00                                   *
.*               Schedule Eclipse Remittance Report (IBAWEB12)            *
.--------------------------------------------------------------------------
.
PRNREM00  MOVE      "IBAWEB12",SCHDPGID
          MOVE      "WebServices IHCW ERAW Remittance Report",SCHDDESC
          CALL      IBACLOCK
          PACK      SCHDDATE,CCC,CYY,CMM,CDD
          REP       " 0",SCHDDATE
          CLOCK     TIME,SCHDTIME
          MOVE      ONE,SCHDCOPY
          MOVE      "S  ",SCHDPRNT           * initialise to spool
          MATCH     SP70,SELPRINT
          IF        !@EQUAL
            MOVE      SELPRINT,SCHDPRNT      * printer code
          ENDIF
          MOVE      "IBAWEB12",SETDFPRG
          MOVE      "1",SETDFRPT
          CALL      SETDEF00                 * save default printer
.
.         Write Keyin parameters
.
          UNPACK    REMITKEY,KEY3,KEY24,KEY30,KEY4
          MOVE      KEY3,KEYSTARR[1]        * key for pmserhaf
          MOVE      KEY24,KEYSTARR[2] 
          MOVE      KEY30,KEYSTARR[3]
          MOVE      KEY4,KEYSTARR[4]
          MOVE      USERID,KEYSTARR[5]
          MOVE      DIM1C,KEYSTARR[6]
          MOVE      SIX,KEYSTCNT            * Number of Keyins
.
          CALL      SCHPRO00   * Schedule Extract
.
PRNREM99  RETURN
+
.---------------------------------------------------------------------------
.         FLDR0000 - loads the patient folder icon base on alert active
.---------------------------------------------------------------------------
.
.FLDR0000  MOVE       TWO,FOLDRTYP                 * set to default folder
.          PACK       KEY13,PURNO,SP70
.          CALL       RSPTALR1
.          CALL       RKPTALR1
.          BRANCH     OVRCD,FLDR1000
.          MATCH      PTALURNO,PURNO               * alert exist?
.          GOTO       FLDR1000 IF NOT EQUAL
.
.          MOVE       ONE,FOLDRTYP
.
.          GOTO       FLDR2000
.
.FLDR1000  MOVE       TWO,FOLDRTYP
.
.FLDR2000  LOAD       FOLDRNAM,FOLDRTYP,FOLDER1:   * alert folder
.                                       FOLDER2    * normal folder
.
.FLDR9999  RETURN
.
FLDR0000  MOVE       FOLDER0,FOLDRNAM
          MOVE       ZERO,FOLDRTYP
          RESET      PTMXSIN1
          MOVE       PTMXSIN1,FOLDRTYP
.
          LOAD       FOLDRNAM,FOLDRTYP,FOLDER1:
                                       FOLDER2:
                                       FOLDER3:
                                       FOLDER4:
                                       FOLDER5:
                                       FOLDER6:
                                       FOLDER7:
                                       FOLDER8:
                                       FOLDER9
.
FLDR9999  RETURN
+
.---------------------------------------------------------------------------
.         WRRDTE00 - Write to rcpdteaf
.---------------------------------------------------------------------------
.
WRRDTE00  CALL      IBACLOCK
          PACK      RCDTTDAT,CCC,CYY,CMM,CDD
          REP       " 0",RCDTTDAT
          MOVE      HRECPT,RCDTRECN
.         MOVE      "    1",RCDTTCNT
.         MOVE      WBEJARID,RCDTINVN
          PACK      RCDTINVN,WBEJARID,SP70
          RJUSTIFY  RCDTINVN
          MOVE      WBICADMN,RCDTVIST
          MOVE      WBICURNO,RCDTURNO
          MOVE      WBICURNO,KEY8
          CALL      RDMAST1
          IF        OVRCD = 0
            MOVE      PSNAME,PACSNAME
            MOVE      PGNAME,PACGNAME
            MOVE      PTITL,PACTITLE
            MOVE      TWO,PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,RCDTNAME
            MOVE      PADD1,RCDTADD1
            MOVE      PADD2,RCDTADD2
            MOVE      PSUBRB,RCDTADD3
            MOVE      PADD4,RCDTADD4
            MOVE      PPOST,RCDTPOST
          ELSE
            MOVE      SP70,RCDTNAME
            MOVE      SP70,RCDTADD1
            MOVE      SP70,RCDTADD2
            MOVE      SP70,RCDTADD3
            MOVE      SP70,RCDTADD4
            MOVE      SP70,RCDTPOST
          ENDIF
          MOVE      SP70,RCDTSFLG
          MOVE      WBEIPREF,RCDTREFR
          MOVE      WBEIHOSP,RCDTMHOS
.
          MOVE      RCCNERRE,RCDTREGI
          IF        IBCNMHOS=1
.
            MATCH     SP70,RCDTMHOS
            IF        !@EQUAL & !@EOS
              PACK      KEY3,RCDTMHOS,SP70
              CALL      RDPTHSP1
              IF        OVRCD=0
                MATCH     SP70,PTHSERRE
                IF        !@EQUAL & !@EOS
                  MOVE      PTHSERRE,RCDTREGI
                ENDIF
              ENDIF
            ENDIF
.
            PACK      KEY8,WBICADMN,SP70
            CALL      RDPMVX11
            IF        OVRCD=0
              MATCH     SP70,PMVXMHOS
              IF        !@EQUAL & !@EOS
                PACK      KEY3,PMVXMHOS,SP70
                CALL      RDPTHSP1
                IF        OVRCD=0
                  MATCH     SP70,PTHSERRE
                  IF        !@EQUAL & !@EOS
                    MOVE      PTHSERRE,RCDTREGI
                    MOVE      PMVXMHOS,RCDTMHOS
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
.
          ENDIF
.
          MOVE      SP70,RCDTGSTC
          CALL      GTACCT00
.
          RJUSTIFY  WBEJBAMT
          UNPACK    WBEJBAMT,DIM7,DIM2
          PACK      DIM10,DIM7,FULLSTOP,DIM2
          MOVE      ZERO,FORM7P2C
.
          SCAN      "-",DIM10
          IF        @EQUAL
            REP        "-0",DIM10
            MOVE       DIM10,FORM7P2C
            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
          ELSE
            MOVE      DIM10,FORM7P2C
          ENDIF
          MOVE      FORM7P2C,RCDTAMNT
.
          MOVE      ZERO,RCDTDISC
          MOVE      CHOSPNUM,RCDTMDHS
          MOVE      SP70,RCDTGSTA
          MOVE      SP70,RCDTALLO
          CALL      IBACLOCK
.         PACK      RCDTRELD,CCC,CYY,CMM,CDD
.         REP       " 0",RCDTRELD
.         MOVE      CTIMEIS,RCDTRELT
          MOVE      SP70,RCDTRELD
          MOVE      SP70,RCDTRELT
          PACK      RCDTCDAT,CCC,CYY,CMM,CDD
          REP       " 0",RCDTCDAT
          MOVE      SP70,RCDTPRAC
          MOVE      CTIMEIS,RCDTCTIM
          MOVE      WBSEUID,RCDTCUID
          MOVE      SP70,RCDTUDAT
          MOVE      SP70,RCDTUTIM
          MOVE      SP70,RCDTUUID
          MOVE      SP70,RCDTDPTY
          MOVE      SP70,RCDTGLEX
          MOVE      WBICBATN,RCDTBATN
          MOVE      SP70,RCDTSPAR
.
          PACK      KEY17,RCDTRECN,RCDTTCNT,SP70
          CALL      WRRCDTE1
.
WRRDTE99  RETURN
+
.------------------------------------------------------------
. Format Patient Age in Y,M,W or D -
.------------------------------------------------------------
FMTA0000  MOVE      SP70,FMTPATAG
.
          MATCH     "y",PSAGETYP
          GOTO      FMTA1000 IF NOT EQUAL
.
          CLEAR     FMTPATAG
          APPEND    PSAGEYRS,FMTPATAG
          APPEND    " yrs",FMTPATAG
          RESET     FMTPATAG
          GOTO      FMTA9999
.
FMTA1000  MATCH     "d",PSAGETYP
          GOTO      FMTA2000 IF NOT EQUAL
.
          CLEAR     FMTPATAG
          APPEND    PSAGEDAY,FMTPATAG
          APPEND    " days",FMTPATAG
          RESET     FMTPATAG
          GOTO      FMTA9999
.
FMTA2000  MATCH     "m",PSAGETYP
          GOTO      FMTA3000 IF NOT EQUAL
.
          CLEAR     FMTPATAG
          APPEND    PSAGEMNT,FMTPATAG
          APPEND    " mths",FMTPATAG
          RESET     FMTPATAG
          GOTO      FMTA9999
.
FMTA3000  MATCH     "w",PSAGETYP
          GOTO      FMTA9999 IF NOT EQUAL
.
          CLEAR     FMTPATAG
          APPEND    PSAGEWKS,FMTPATAG
          APPEND    " wks",FMTPATAG
          RESET     FMTPATAG
.
FMTA9999  RETURN
.
.------------------------------------------------------------
. Next Day, Week, Month       
.------------------------------------------------------------                
NXTR0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3  
          REP       " 0",KEY3
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2  
          REP       " 0",KEY2
.
          REP       " +",FILTHOSP
.                            
          WRITE     HTMLFILE;"eclweb25.pbl":
                             "?reportno=",KEY2:
                             "&template=",KEY3:  
                             "&viewtype=",VIEWTYPE:
                             "&frstdate=",NXTFDATE:
                             "&lastdate=",NXTLDATE:
                             "&exdtblnk=",EXDTBLNK:
                             "&filthosp=",FILTHOSP:
                             "&deftallh=",DEFTALLH;
.
          REP       "+ ",FILTHOSP
.
NXTR9999  RETURN
.
.--------------------------------------------------------
.
PRVR0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
.
          REP       " +",FILTHOSP
.                            
          WRITE     HTMLFILE;"eclweb25.pbl":
                             "?reportno=",KEY2:
                             "&template=",KEY3:
                             "&viewtype=",VIEWTYPE:
                             "&frstdate=",PREFDATE:
                             "&lastdate=",PRELDATE:
                             "&exdtblnk=",EXDTBLNK:
                             "&filthosp=",FILTHOSP:
                             "&deftallh=",DEFTALLH;
.
          REP       "+ ",FILTHOSP
.
PRVR9999  RETURN
.
.--------------------------------------------------------------------
. Set the expected return date/time value and the font to red
. if the patient is overdue from the expected return date/time
.--------------------------------------------------------------------
XRET0000  MOVE      SP70,EXPLRETN           * Exp return from leave date/time
.
          COMPARE   THREE,FILETYPE          * Leave
          GOTO      XRET9999 IF NOT EQUAL
.
          MATCH     SP70,OERDATE            * Expected return from leave
          GOTO      XRET9999 IF EQUAL
.
          PACK      KEY8,CTIMEIS
          REP       ": ",KEY8
          SQUEEZE   KEY8
          PACK      TESTDAT1,CCC,CYY,CMM,CDD,KEY8
          REP       " 0",TESTDAT1
.
          MATCH     SP70,OERTIME
          IF        @EQUAL
            MOVE      "99:99:99",KEY8
          ELSE
            MOVE      OERTIME,KEY8
          ENDIF
          REP       ": ",KEY8
          SQUEEZE   KEY8
.
          PACK      TESTDAT2,OERDATE,KEY8
          REP       " 0",TESTDAT2
.
          MATCH     TESTDAT2,TESTDAT1
          GOTO      XRET8000 IF LESS
.
          UNPACK    OERDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT:
                                NOV,DEC
          PACK      EXPLRETN,FONTRSTR,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP1:
                             OERTIME,FONTREND,SP70
          GOTO      XRET9999
.
XRET8000  UNPACK    OERDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT:
                                NOV,DEC
          PACK      EXPLRETN,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP1:
                             OERTIME,SP70
.
XRET9999  RETURN
+
.-------------------------------------------------------------------
.Check for duplicate remittance in multi hospital remittance release
.-------------------------------------------------------------------
CDERA000  PACK      KEY61,SP3,WBEIFTID,WBEIRADV,WBEIPNUM,SP70
          CALL      RDWBERH1
          BRANCH    OVRCD,CDERA999
.         
          MOVE      "2",WBEISTAT
.         
          CALL      UPWBERH1
.         
CDERA999  RETURN
.---------------------------------------------------------------------------
.         WRRDTS00 - Write to rcpdteaf suspense account
.---------------------------------------------------------------------------
.
WRRDTS00  CALL      IBACLOCK
          PACK      RCDTTDAT,CCC,CYY,CMM,CDD
          REP       " 0",RCDTTDAT
          MOVE      HRECPT,RCDTRECN
.         MOVE      "    1",RCDTTCNT
.         MOVE      WBEJARID,RCDTINVN
.         PACK      RCDTINVN,WBEJARID,SP70
.         RJUSTIFY  RCDTINVN
          MOVE      SP70,RCDTINVN
          MOVE      SP70,RCDTVIST
          MOVE      SP70,RCDTURNO
.         MOVE      WBIMURNO,KEY8
.         CALL      RDMAST1
.         IF        OVRCD = 0
.           MOVE      PSNAME,PACSNAME
.           MOVE      PGNAME,PACGNAME
.           MOVE      PTITL,PACTITLE
.           MOVE      TWO,PACFRMT
.           CALL      PACNAME
.           MOVE      PACFNAME,RCDTNAME
.           MOVE      PADD1,RCDTADD1
.           MOVE      PADD2,RCDTADD2
.           MOVE      PSUBRB,RCDTADD3
.           MOVE      PADD4,RCDTADD4
.           MOVE      PPOST,RCDTPOST
.         ELSE
            REP       "#" ",SERDIM50
            MOVE      SERDIM50,RCDTNAME
            MOVE      SP70,RCDTADD1
            MOVE      SP70,RCDTADD2
            MOVE      SP70,RCDTADD3
            MOVE      SP70,RCDTADD4
            MOVE      SP70,RCDTPOST
.         ENDIF
          MOVE      SP70,RCDTSFLG
          MOVE      WBEIPREF,RCDTREFR
          MOVE      WBEIHOSP,RCDTMHOS
.
          MOVE      RCCNERRS,RCDTREGI
.         IF        IBCNMHOS=1
.           MATCH     SP70,RCDTMHOS
.           IF        !@EQUAL & !@EOS
.             PACK      KEY3,RCDTMHOS,SP70
.             CALL      RDPTHSP1
.             IF        OVRCD=0
.               MATCH     SP70,PTHSERRE
.               IF        !@EQUAL & !@EOS
.                 MOVE      PTHSERRE,RCDTREGI
.               ENDIF
.             ENDIF
.           ENDIF
.         ENDIF
.
          MOVE      SP70,RCDTGSTC
          CALL      GTACCT00
.
          MOVE      SP70,DIM2
          MOVE      SP70,DIM7
          MOVE      SP70,DIM10
.
          RJUSTIFY  WBEJBAMT
          UNPACK    WBEJBAMT,DIM7,DIM2
          PACK      DIM10,DIM7,FULLSTOP,DIM2
          MOVE      ZERO,FORM7P2C
.
          SCAN      "-",DIM10
          IF        @EQUAL
            REP        "-0",DIM10
            MOVE       DIM10,FORM7P2C
            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
          ELSE
            MOVE      DIM10,FORM7P2C
          ENDIF
          MOVE      FORM7P2C,RCDTAMNT
.
          MOVE      ZERO,RCDTDISC
          MOVE      CHOSPNUM,RCDTMDHS
          MOVE      SP70,RCDTGSTA
          MOVE      "2",RCDTALLO
          CALL      IBACLOCK
.         PACK      RCDTRELD,CCC,CYY,CMM,CDD
.         REP       " 0",RCDTRELD
.         MOVE      CTIMEIS,RCDTRELT
          MOVE      SP70,RCDTRELD
          MOVE      SP70,RCDTRELT
          PACK      RCDTCDAT,CCC,CYY,CMM,CDD
          REP       " 0",RCDTCDAT
          MOVE      SP70,RCDTPRAC
          MOVE      CTIMEIS,RCDTCTIM
          MOVE      WBSEUID,RCDTCUID
          MOVE      SP70,RCDTUDAT
          MOVE      SP70,RCDTUTIM
          MOVE      SP70,RCDTUUID
          MOVE      SP70,RCDTDPTY
          MOVE      SP70,RCDTGLEX
          MOVE      SP70,RCDTBATN
          MOVE      SP70,RCDTSPAR
.
          PACK      KEY17,RCDTRECN,RCDTTCNT,SP70
          CALL      WRRCDTE1
.
WRRDTS99  RETURN
.
.*****************************************************************************
.*                                UNLS0000         Called by: RPAY0000       *
.*               Unlock claim related records after releasing payments       *
.* Requires: UNLKFLAG - unlock flag                                          *
.*                      1 = patvisaf, patinvrf & pathfrec                    *
.*                      2 = patinvrf & pathfrec                              *
.*                      3 = pathfrec                                         *
.*****************************************************************************
.
UNLS0000  BRANCH    UNLKFLAG,UNLS1000:
                             UNLS2000:
                             UNLS3000
.
UNLS1000  CALL      UUPTVIS1                     * unlock visit record
.
UNLS2000  CALL      UUPTINV1                     * unlock invoice record
.
.         Unlock the pathfrec record
.
UNLS3000  MOVE      WBEJARID,DIM8
          RJUSTIFY  DIM8
          MOVE      DIM8,KEY8
          CALL      RDHFRE1                      * HF receipts record found ?
          BRANCH    OVRCD,UNLS9999               * no
.
          MOVE      ZERO,HFRSTAT                 * set the status to 'free'
          CALL      UPHFRE1
.
UNLS9999  RETURN
+
.*****************************************************************************
.*                              CREA0000               Called by: MAIN0000   *
.*             Create a new temporary file                                   *
.*****************************************************************************
.
CREA0000  CALL      KILL0000                     * remove existing file
.
          CLEAR     CMDLINE
          PACK      CMDLINE,ISBUILD,TEMPFILE,UKEY
          EXECUTE   CMDLINE,TASKID               * create temporary index file
.
          OPEN      ECLTEMP1,TEMPFILE            * open temp index 1
          OPEN      ECLTEMP2,TEMPFILE            * open temp index 2
.
CREA9999  RETURN
+
.****************************************************************************
.*                              KILL0000               Called by: MAIN0000  *
.*               Close and erase the temporary file                         *
.****************************************************************************
.
KILL0000  CLOSE     ECLTEMP1                     * close file
          CLOSE     ECLTEMP2
.
          CLEAR     CMDLINE
          PACK      CMDLINE,ERASE,TEMPFILE       * set file erase command
          EXECUTE   CMDLINE,TASKID               * erase temp file
.
KILL9999 RETURN
+
.****************************************************************************
.*                              CLER0000               Called by: MAIN0000  *
.*               Close and erase the temporary file                         *
.****************************************************************************
.
CLER0000  MOVE      SP30,KEY24
          CALL      RSTEMP1                      * position at start of file
          CALL      RKTEMP1                      * read next record
          BRANCH    OVRCD,CLER9999               * eof - finished
.
          MOVE      WBEJTRID,KEY24
          CALL      DETEMP1                      * delete current record
          GOTO      CLER0000                     * get next record
.
CLER9999  RETURN
+
.*****************************************************************************
.*                                 LTMP0000        Called by: RPAY0000       *
.*    Load the temp file with the weberdaf records which correspond to the   *
.*    selected weberhaf record.                                              *
.*    We need to use the temp file so that we can sort by participant code.  *
.*    Some health fund groups (e.g. BUPA), may send payments in a single     *
.*    remittance, relating to more than one participant (e.g HBA & MBF).     *
.*    When processing the payments, a receipt number needs to be generated   *
.*    for each participant.                                                  *
.* Requires:  Valid read on weberhaf record                                  *
.*            ERDCOUNT - initialised to zero                                 *
.* Returns:   ERDCOUNT - total number of weberdaf records related to the     *
.*                       selected remittance.                                *
.*****************************************************************************
.
LTMP0000  MOVE      ZERO,LOOPCNTR
.
          PACK      KEY82,WBEIFTID,WBEIRADV,WBEIPNUM,SP30,SP30,SP30
          CALL      RSWBERD1                     * position in file
LTMP0500  CALL      RKWBERD1                     * read next record
          BRANCH    OVRCD,LTMP9999               * end of file
.
.------------------------------------------------------
. Loop counter to prevent timeout internal server error
.
          ADD       ONE,LOOPCNTR
.
          IF        (LOOPCNTR > 5)
            WRITE     HTMLFILE;"<script type=#"text/javascript#"></script>"
            MOVE      ZERO,LOOPCNTR
          ENDIF
.
. -----------------------------------------------------
.
          MATCH     WBEIFTID,WBEJFTID            * same fund trans. id still ?
          GOTO      LTMP9999 IF NOT EQUAL        * no - finished ERA
.
          MATCH     WBEIRADV,WBEJRADV            * same remittance advice still?
          GOTO      LTMP9999 IF NOT EQUAL        * no - finished ERA
.
          MATCH     WBEIPNUM,WBEJPNUM            * same part number still ?
          GOTO      LTMP9999 IF NOT EQUAL        * no - finished ERA
.
          ADD       ONE,ERDCOUNT                 * increment pmserdaf count
.
.         A payment requiring releasing has been found, so get the
.         corresponding webihcaf record.
.
          PACK      KEY40,WBEJTRID,SP30,SP10
          CALL      RSWBIHC6                     * position on trans. id/invoice
          CALL      RKWBIHC6                     * read next record
          BRANCH    OVRCD,LTMP1100               * eof
.
          MATCH     WBEJTRID,WBICTRID            * same transaction id still ?
          GOTO      LTMP1500 IF EQUAL            * yes
.
LTMP1100  
.         DISPLAY   *P1:24,*EL,*B,"Missing webihcaf record for ":
.                   *V2LON,WBEJTRID,*HOFF,".  ";
.         CALL      HITENTER
          GOTO      LTMP3000
.
.         Get the participant code for the claim
.
LTMP1500  MOVE      CVETINS,PARTPANT             * default part. to DVA
          BRANCH    WBICEETP,LTMP5000            * DVA claim
.
.         This is a Health Fund claim
.
          PACK      KEY14,WBICHFND,ZERO,ZERO,ZERO,ZERO,SP20
          CALL      RDFUND1
          IF        OVRCD = 1
.           DISPLAY   *P1:24,*EL,*B,"Missing patfundf record for ":
.                     *V2LON,WBICHFND,*HOFF,".  ";
.           CALL      HITENTER
            GOTO      LTMP8000
          ENDIF
.
          PACK      KEY6,WBICHFND,SP70
          CALL      RDPTFX11
          IF        OVRCD=1
            GOTO      LTMP2000
          ENDIF
.
          MOVE      "02",KEY2               * check HF history for HF Group
          PACK      KEY17,WBICHFND,KEY2,SP70
          PACK      KEY8,WBICADMN
          CALL      PATDDHRD
.
          MATCH     SP3,PTFXECLP
          GOTO      LTMP2000 IF EQUAL
          GOTO      LTMP2000 IF EOS
.
          MOVE      PTFXECLP,PARTPANT
          GOTO      LTMP5000
.
.         The health fund group equates to the participant
.
LTMP2000  MATCH     SP3,PTHFHGRP
          IF        @EQUAL
.           DISPLAY   *P1:24,*EL,*B,"Participant code blank for ":
.                     *V2LON,WBICHFND,*HOFF,".  ";
.           CALL      HITENTER
            GOTO      LTMP8000
          ENDIF
          MOVE      PTHFHGRP,PARTPANT            * load participant code
          GOTO      LTMP5000
.
LTMP3000  MOVE      WBEJARID,KEY8
          RJUSTIFY  KEY8
          PACK      KEY8,KEY8,SP70
          CALL      RDPTINV1
          COMPARE   OVRCD,ONE
          GOTO      LTMP3500 IF EQUAL
.
          MATCH     SP70,DPINVADM
          GOTO      LTMP8000 IF EQUAL
          GOTO      LTMP8000 IF EOS
.
          PACK      KEY8,DPINVADM,SP70
          CALL      RDPTMIS1
          IF        OVRCD=1
            GOTO      LTMP8000
          ENDIF
.
.         Get the participant code for the claim
.
LTMP3500  MOVE      CVETINS,PARTPANT
          PACK      KEY5,ANSC,ANSL,ACLAIM
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      ZERO,FORM1
            WHILE     FORM1 < 5
              ADD       ONE,FORM1
              LOAD      ANS,FORM1,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
              MATCH     ANSV,ANS
              IF        @EQUAL
                GOTO      LTMP5000
              ENDIF
            DO
          ENDIF
.
          MATCH     SP70,AFUNDH
          GOTO      LTMP8000 IF EQUAL
          GOTO      LTMP8000 IF EOS
.
.         This is a health fund claim
.
          PACK      KEY14,AFUNDH,ZERO,ZERO,ZERO,ZERO,SP20
          CALL      RDFUND1
          IF        OVRCD=1
            GOTO      LTMP8000
          ENDIF
.
          PACK      KEY6,AFUNDH,SP70
          CALL      RDPTFX11
          IF        OVRCD=1
            GOTO      LTMP4000
          ENDIF
.
          MOVE      "02",KEY2               * check HF history for HF Group
          PACK      KEY17,AFUNDH,KEY2,SP70
          CALL      PATDDHRD
.
          MATCH     SP3,PTFXECLP
          GOTO      LTMP4000 IF EQUAL
          GOTO      LTMP4000 IF EOS
.
          MOVE      PTFXECLP,PARTPANT
          GOTO      LTMP5000
.
.         The health fund group equates to the participant
.
LTMP4000  MATCH     SP3,PTHFHGRP
          IF        @EQUAL
            GOTO      LTMP8000
          ENDIF
.
          MOVE      PTHFHGRP,PARTPANT
          GOTO      LTMP5000
.
.         Write the pmserdaf details to the temp file
.
LTMP5000  CALL      WRTEMP1
          GOTO      LTMP0500                     * get next payment
.
.         There was a problem processing this record, so set the weberdaf
.         payment status to "locked"
.
LTMP8000  MOVE      "1",WBEJSTAT
          CALL      UPWBERD1
          GOTO      LTMP0500
.
LTMP9999  RETURN
+
.-------------------------------------------------------------------------------
.         Check if invoice is reconciled after input journal
.-------------------------------------------------------------------------------
CREC0000  MOVE      ZERO,FORM10P2
          CALL      RDPTINV1
          BRANCH    OVRCD,CREC9999
.
          MOVE      PINVNO,FORM12
          MOVE      FORM12,SAVKEY12
          PACK      KEY29,SAVKEY12,SP70
          CALL      RSRCDTE3
CREC1000  CALL      RKRCDTE3
          BRANCH    OVRCD,CREC2000
.
          MATCH     SAVKEY12,RCDTINVN       * Same invoice number?
          GOTO      CREC2000 IF NOT EQUAL
.
          MOVE      RCDTREGI,KEY3
          CALL      RDREGA1
          BRANCH    OVRCD,CREC1000
.
          BRANCH    REGIBACD,CREC1200      * Patient billing
          COMPARE   "97",REGIBACD
          GOTO      CREC1000 IF NOT EQUAL  * NOT IP Deposits
.
CREC1200  PACK      KEY12,RCDTRECN,SP70
          CALL      RDRCBNK1
          BRANCH    OVRCD,CREC1000
          MATCH     "1",RCBNSTAT
          GOTO      CREC1000 IF EQUAL       * Receipt cancelled
.
          ADD       RCDTAMNT,FORM10P2       * payment
          GOTO      CREC1000
.
CREC2000  MOVE      PINVAMT,FORM12P2      * Invoice amount +
          SUB       FORM10P2,FORM12P2     * Payments
          ADD       PTINCRTT,FORM12P2     * Credit Notes +
          ADD       PINVJOUR,FORM12P2     * Journals = amount outstanding
          ADD       PTINGSTJ,FORM12P2     * Journal GST = amount outstanding
.
          CALL      GDET0000              * Get patient's Claim and Health Fund
          CALL      RECN0000              * Update Unreconciled invoice
.
CREC9999  RETURN
+
.-------------------------------------------------------------------------------
.         Get patient's Claim and Health fund
.-------------------------------------------------------------------------------
.
GDET0000  MOVE      PINVUR,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,GDET9999

          BRANCH    PINVSYS OF GDET1000,GDET2000,GDET3000
          GOTO      GDET9999
.
.         Emergency invoice
.
GDET1000  OPEN      AAEDE1A1,"aaede1af"
          MOVE      PINVADM,KEY8
          CALL      RDEMVIS1
          BRANCH    OVRCD,GDET9999
.
          CALL      RDDETA1
          BRANCH    OVRCD,GDET9999
.
          MOVE      EMVICOMP,ACLAIM
          MOVE      PFUNDH,AFUNDH
          MOVE      PFNDTB,AFNDTB
          GOTO      GDET9999
.
.         Outpatient invoice
.
GDET2000  MOVE      "out",OSTFILE
          MOVE      PINVSITE,KEY6
          CALL      RDSITA1                 * Get the file header for this site
.
          PACK      CFNAME WITH OSTFILE,FILBB1A1
          CALL      OPOTBB11
.
          MOVE      PINVADM,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,GDET9999
.
          MOVE      OBACOMP,ACLAIM
          MOVE      OTBBFUND,AFUNDH
          MOVE      OTBBTBLE,AFNDTB
          GOTO      GDET9999

GDET3000  MOVE      PINVADM,KEY8
          CALL      RDPTMIS1
.
GDET9999  RETURN
+
.-------------------------------------------------------------------------------
.         If invoice balanced, removed record from Unreconciled invoice file
.         if invoice not balanced, write or update the Unreconciled invoice file
.-------------------------------------------------------------------------------
.
RECN0000  PACK      KEY8,PINVNO
          CALL      RDPTURE1
.
          CALL      IBACLOCK
          IF        FORM12P2=0
            IF        OVRCD=0
              CALL      DEPTURE1              * Delete Un-reconciled record
            ENDIF
          ELSE
            IF        OVRCD=0
              MOVE      PTINCRTT,PTURJRNL     * Credit Notes +
              ADD       PINVJOUR,PTURJRNL     * Journals = amount outstanding
              ADD       PTINGSTJ,PTURJRNL     * Journal GST = amount outstanding
              MOVE      FORM12P2,PTUROSTD     * Outstanding amount
.
.          Update PTURCDAT/PTURCTIME when updating intead of PTURUDAT/PTURUTIM
.
              PACK      PTURCDAT,CCC,CYY,CMM,CDD
              REP       " 0",PTURCDAT
              MOVE      CTIMEIS,PTURCTIM
              MOVE      WBSEUID,PTURCUID        * WEB user id
              CALL      UPPTURE1              * Update outstanding amount
            ELSE
              CALL      SETU0000              * Setup Unreconciled inv.fields
              CALL      WRPTURE1
            ENDIF
          ENDIF
.
RECN9999  RETURN
+
.------------------------------------------------------------
.         Setup fields for the Unreconciled invoices file
.------------------------------------------------------------
SETU0000  MOVE      PINVNO,PTURINVN
          MOVE      PINVADM,PTURVISN
          MOVE      "0",PTURSTAT                * New status
          MOVE      PINVSYS,PTURSYST
          MOVE      ACLAIM,PTURCLMN
          MOVE      AFUNDH,PTURHFND
          MOVE      AFNDTB,PTURHTAB
.
          MOVE      PINVAMT,PTURINVT     * Invoice total
          MOVE      PINVPATA,PTURPAYM    * Patient payments +
          ADD       PINVHFDA,PTURPAYM    * H.F payments +
          ADD       PINVOTHA,PTURPAYM    * Other payments +
.
          MOVE      PTINCRTT,PTURJRNL    * Credit Notes +
          ADD       PINVJOUR,PTURJRNL    * Journals = amount outstanding
          ADD       PTINGSTJ,PTURJRNL    * Journal GST = amount outstanding
          MOVE      FORM12P2,PTUROSTD    * Outstanding amount
.
          CALL      IBACLOCK
          PACK      PTURCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTURCDAT
          MOVE      CTIMEIS,PTURCTIM
          MOVE      WBSEUID,PTURCUID        * WEB user id
.
          PACK      PTURUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTURUDAT
          MOVE      CTIMEIS,PTURUTIM
          MOVE      WBSEUID,PTURUUID        * WEB user id
.
SETU9999  RETURN
+
.-------------------------------------------------------------------------
.UPPBMN00 - Write/update the bed management table
.-------------------------------------------------------------------------
UPPBMN00  MOVE      ZERO,CNTREADS            * Counter for Debug Performance Issue
          PACK      TRNTOWRD,TRNTOWRD,SP70
          PACK      TRNTOBED,TRNTOBED,SP70
          MATCH     SP70,TRNTOWRD
          GOTO      UPPBMN99 IF EQUAL
          GOTO      UPPBMN99 IF EOS
          MOVE      SP70,SAVEBRQN
          CALL      DELBMD00                   * Delete Existing Bed Manageemnt Records
.
          MOVE      ZERO,LOSDINDC              * Write/update patbmdaf
          MOVE      TRANDATE,SAVEDATE          * Bed management Detail Tab
          MOVE      TRANTIME,SAVETIME          * Length of Stay days
.
          MOVE      ZERO,LOOPDAYS
          MOVE      STAYDAYS,LOOPDAYS
.
. Restrict to latest 12 weeks to avoid timeout error from old admissions etc.
.
          IF        LOOPDAYS>84    
            UNPACK    SAVEDATE,CCENT,CYEAR,CMON,CDAY
            ASSIGN    LOOPDAYS-84,ADJDAYS
            CALL      ADJDAT00
            PACK      SAVEDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      84,LOOPDAYS
          ENDIF
.
UPPBMN30  COMPARE   ZERO,LOOPDAYS
          GOTO      UPPBMN50 IF EQUAL
          MOVE      TWO,LOSDINDC
.
          PACK      KEY30,AADMNO,SAVEDATE,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,UPPBMN35
.
          MATCH     DAADMNO,DTADMN
          GOTO      UPPBMN35 IF NOT EQUAL
.
          MOVE      TWARD,PTBDWARD
          MOVE      TBED,PTBDWBED
          GOTO      UPPBMN38
.
UPPBMN35  MOVE      TRNTOWRD,PTBDWARD
          MOVE      TRNTOBED,PTBDWBED
.
UPPBMN38  MOVE      SAVEDATE,PTBDDATE
          MOVE      SAVETIME,PTBDADTM
          MOVE      LOOPDAYS,PTBDLOSD
.
          CALL      GTTOTM00
          MOVE      ADJTIME,PTBDLOSM
.
          MOVE      SP70,PTBDOPPE
          MOVE      AADMNO,PTBDADMN
          MOVE      "3",PTBDSTAT
          MOVE      "0",PTBDOVER
          MOVE      SAVEBRQN,PTBDBRQN
          MOVE      SP70,PTBDSPAR
.
          PACK      KEY30,PTBDWARD,PTBDWBED,PTBDDATE,PTBDADTM,SP3,PTBDADMN,SP70
          CALL      RAPTBMD1
          IF        OVRCD=1
            TRAP      OVERCOND IF IO
            CALL      WRPTBMD1
            TRAPCLR   IO
          ELSE
            CALL      UPPTBMD1
          ENDIF
.
          SUB       ONE,LOOPDAYS
          UNPACK    SAVEDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      "1",ADJDAYS
          CALL      ADJDAT00
          PACK      SAVEDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      "00:00",SAVETIME
          ADD       ONE,CNTREADS
          GOTO      UPPBMN30
.
UPPBMN50  CALL      GTTOTM00                       * Write/update patbmdaf
          MOVE      ZERO,CNTREADS
          COMPARE   TWO,LOSDINDC
          IF        @EQUAL
            MOVE      SAVEDATE,PTBDDATE
            MOVE      SAVETIME,PTBDADTM
          ELSE
            MOVE      TRANDATE,PTBDDATE
            MOVE      TRANTIME,PTBDADTM
            MOVE      ONE,LOSDINDC
          ENDIF
.
.
          PACK      KEY30,AADMNO,PTBDDATE,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,UPPBMN55
.
          MATCH     DAADMNO,DTADMN
          GOTO      UPPBMN55 IF NOT EQUAL
.
          MOVE      TWARD,PTBDWARD
          MOVE      TBED,PTBDWBED
          GOTO      UPPBMN58
.
UPPBMN55  MOVE      TRNTOWRD,PTBDWARD
          MOVE      TRNTOBED,PTBDWBED
.
UPPBMN58  MOVE      ADJTIME,PTBDLOSM
          MOVE      "  0",PTBDLOSD
          MOVE      SP70,PTBDOPPE
          MOVE      AADMNO,PTBDADMN
.
          MOVE      "3",PTBDSTAT
.
          MOVE      "0",PTBDOVER
          MOVE      SAVEBRQN,PTBDBRQN
          MOVE      SP70,PTBDSPAR
.
          PACK      KEY30,PTBDWARD,PTBDWBED,PTBDDATE,PTBDADTM,SP3,PTBDADMN,SP70
          CALL      RAPTBMD1
          IF        OVRCD=1
            TRAP      OVERCOND IF IO
            CALL      WRPTBMD1
            TRAPCLR   IO
          ELSE
            CALL      UPPTBMD1
          ENDIF
.
          MOVE      PTBDDATE,SAVEDATE
.
UPPBMN70  COMPARE   ZERO,LOSDINDC                         * Override previous
          GOTO      UPPBMN99 IF EQUAL                     * Records in patbmdaf
.
          MATCH     SP70,TRNTOBED
          GOTO      UPPBMN99 IF EQUAL
          GOTO      UPPBMN99 IF EOS
.
          MOVE      TRANTIME,DIM5
          PACK      KEY30,TRNTOWRD,TRNTOBED,TRANDATE,DIM5,SP3,AADMNO,SP70
          CALL      RDPTBMD1
          BRANCH    OVRCD,UPPBMN99
.
          MOVE      PTBDDATE,SAVEDATE
          MOVE      PTBDADTM,SAVETIME
          MOVE      PTBDLOSD,SAVELOSD
          MOVE      PTBDLOSM,SAVELOSM
.
UPPBMN73  CALL      RPPTBMD1
          BRANCH    OVRCD,UPPBMN80
          ADD       ONE,CNTREADS
.
          MATCH     TRNTOWRD,PTBDWARD
          GOTO      UPPBMN80 IF NOT EQUAL
.
          MATCH     TRNTOBED,PTBDWBED
          GOTO      UPPBMN80 IF NOT EQUAL
.
          MATCH     SAVEDATE,PTBDDATE
          GOTO      UPPBMN80 IF NOT EQUAL
.
          MOVE      PTBDDATE,STRTDATE
          MOVE      PTBDADTM,STRTTIME
          MOVE      PTBDLOSM,ADJTIME
          MOVE      PTBDLOSD,ADJDAYS
          CALL      GETEDT00
.
          MATCH     EXPDSDTE,SAVEDATE
          IF        @LESS
            GOTO      UPPBMN78
          ENDIF
          GOTO      UPPBMN73 IF NOT EQUAL
.
          MATCH     EXPDSTME,SAVETIME
          IF        @EQUAL | @LESS
            GOTO      UPPBMN78
          ENDIF
.
          GOTO      UPPBMN73
.
UPPBMN78  MOVE      ONE,PTBDOVER
          CALL      UPPTBMD1
          GOTO      UPPBMN73
.
.-------------------------------------------------------------------------
.
UPPBMN80  PACK      KEY30,TRNTOWRD,TRNTOBED,AADMNO,Z70    * Override following
          CALL      RSPTBMD3                              * Records in patbmdaf
          CALL      RPPTBMD3
          BRANCH    OVRCD,UPPBMN99
          MATCH     DAADMNO,PTBDADMN
          GOTO      UPPBMN99 IF NOT EQUAL
.
          MOVE      ZERO,CNTREADS
          MOVE      SAVEDATE,STRTDATE
          MOVE      SAVETIME,STRTTIME
          MOVE      PTBDLOSM,ADJTIME
          MOVE      SAVELOSD,ADJDAYS
          CALL      GETEDT00
.
          PACK      KEY30,TRNTOWRD,TRNTOBED,SAVEDATE,SAVETIME,SP3,DAADMNO,SP70
          CALL      RDPTBMD1
          BRANCH    OVRCD,UPPBMN99
UPPBMN85  CALL      RKPTBMD1
          BRANCH    OVRCD,UPPBMN99
          ADD       ONE,CNTREADS
          MATCH     TRNTOWRD,PTBDWARD
          GOTO      UPPBMN99 IF NOT EQUAL
          MATCH     TRNTOBED,PTBDWBED
          GOTO      UPPBMN99 IF NOT EQUAL
.
          MATCH     DAADMNO,PTBDADMN
          GOTO      UPPBMN85 IF EQUAL
.
          MATCH     EXPDSDTE,PTBDDATE
          IF        @LESS
            GOTO      UPPBMN88
          ENDIF
          GOTO      UPPBMN85 IF NOT EQUAL
.
          MATCH     EXPDSTME,PTBDADTM
          IF        @EQUAL | @LESS
            GOTO      UPPBMN88
          ENDIF
.
          GOTO      UPPBMN85
.
UPPBMN88  MOVE      "1",PTBDOVER
          CALL      UPPTBMD1
          GOTO      UPPBMN85
.
UPPBMN99  RETURN
.
.-------------------------------------------------------------------------
.DELBMN00 - Delete old patbmdaf records
.-------------------------------------------------------------------------
DELBMD00  MOVE      SP70,SAVEBRQN
DELBMD05  PACK      KEY30,AADMNO,SP70
          CALL      RSPTBMD2
          CALL      RKPTBMD2
          BRANCH    OVRCD,DELBMD99
          MATCH     DAADMNO,PTBDADMN
          GOTO      DELBMD99 IF NOT EQUAL
.
          MOVE      PTBDBRQN,SAVEBRQN
          PACK      KEY30,PTBDADMN,PTBDDATE,PTBDADTM,PTBDWARD,PTBDWBED,PTBDOPPE,SP70
          CALL      DEPTBMD2
          GOTO      DELBMD05
.
DELBMD99  RETURN
.-------------------------------------------------------------------------
.GETEDT00 - Get Expected Discharge Date and Time
.-------------------------------------------------------------------------
GETEDT00  COMPARE   ZERO,ADJDAYS
          IF        @EQUAL
            MOVE      STRTDATE,EXPDSDTE
            GOTO      GETEDT50
          ENDIF
.
          UNPACK    STRTDATE,CCENT,CYEAR,CMON,CDAY
          CALL      ADJDAT00
          PACK      EXPDSDTE,CCENT,CYEAR,CMON,CDAY
.
GETEDT50  COMPARE   ZERO,ADJTIME
          IF        @EQUAL
            MOVE      STRTTIME,EXPDSTME
            GOTO      GETEDT99
          ENDIF
.
          CALL      CLDUR000
          MOVE      KEY5,EXPDSTME
.
GETEDT99  RETURN
.
.-------------------------------------------------------------------------
.GTTOTM00 - Get total time for regime codes
.-------------------------------------------------------------------------
GTTOTM00  MOVE      ZERO,ADJTIME
          MOVE      ONE,F1
          MOVE      SP70,DIM10
GTTOTM10  COMPARE   F1,FOUR
          GOTO      GTTOTM99 IF EQUAL
          LOAD      DIM10,F1,PTRGM001,PTRGM002,PTRGM003
.
          PACK      DIM10,DIM10,SP70
          MATCH     SP70,DIM10
          IF        @EQUAL|@EOS
            ADD       ONE,F1
            GOTO      GTTOTM10
          ENDIF
.
          PACK      KEY13,DIM10,SP1,SP1,ZERO,SP70
          CALL      RDPMREG1
          IF        OVRCD=1
            ADD       ONE,F1
            GOTO      GTTOTM10
          ENDIF
.
          MOVE      ZERO,FORM3
          SQUEEZE   PMREELOS
          MOVE      PMREELOS,FORM3
          ADD       FORM3,ADJTIME
          ADD       ONE,F1
          GOTO      GTTOTM10
.
GTTOTM99  RETURN
.
.-------------------------------------------------------------------------
. SPRGM000 - Set Parameters for Admission Multiple Regime Codes
. Returns:    EXIT   0
.                    1
.-------------------------------------------------------------------------
.
SPRGM000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SPRGM010,SPRGM020,SPRGM030
.
          GOTO      SPRGM910
.
SPRGM010  MOVE      QRYDATA,PTRGM001
          GOTO      SPRGM900
.
SPRGM020  MOVE      QRYDATA,PTRGM002
          GOTO      SPRGM900
.
SPRGM030  MOVE      QRYDATA,PTRGM003
          GOTO      SPRGM900
.
SPRGM900  MOVE      ZERO,EXIT
          GOTO      SPRGM999
.
SPRGM910  MOVE      ONE,EXIT
.
SPRGM999  RETURN
+
.-------------------------------------------------------------------------
. GRGM0000 - Get regime code description
. Parameters: FORM1 - Regime code description to be retrieved
. Returns:    DIM40 - Regime code description
.-------------------------------------------------------------------------
GRGM0000  MOVE      ZERO,FORM1A
          MOVE      SP70,DIM40
.
          PACK      KEY10,DIM8,SP70
          CALL      RSPTRGM1
GRGM0010  CALL      RKPTRGM1
          BRANCH    OVRCD,GRGM9999
.
          MATCH     DIM8,PTRGADMN
          GOTO      GRGM9999 IF NOT EQUAL
.
          ADD       ONE,FORM1A
.
          COMPARE   FORM1,FORM1A
          GOTO      GRGM0010 IF NOT EQUAL 
.
          PACK      KEY13,PTRGREGM,SP1,SP1,ZERO,SP70
          CALL      RDPMREG1 
          BRANCH    OVRCD,GRGM9999
.
          MOVE      PMREDESC,DIM40
.
GRGM9999  RETURN
+
.-------------------------------------------------------------------------
. FWBD0000 - Format ward/bed text                
.-------------------------------------------------------------------------
FWBD0000  MOVE      SP70,WBEDTEXT                                               
          MOVE      SP70,WARDTEXT                                               
          MOVE      SP70,BEDTEXT                                                
          MATCH     SP70,KEY6                                                   
          GOTO      FWBD9999 IF EQUAL                                           
.                                                                               
          PACK      KEY8,WWARD,WBED,SP70   * save current patwr1af key          
          UNPACK    KEY6,WARDKEY,BEDKEY                                         
.                                                                               
          IF        WBEDDESC = 0                                                
            GOTO      FWBD5000                                                  
          ENDIF                                                                 
.                                                                               
          PACK      KEY6,WARDKEY,SP70                                           
          CALL      RDWARD1                                                     
          BRANCH    OVRCD,FWBD5000                                              
.                                                                               
          IF        WBEDDESC = 2                                                
            PACK      WARDTEXT,PTWDSDES,SP70                                    
          ELSE                                                                  
            PACK      WARDTEXT,WBDESC,SP70                                      
          ENDIF                                                                 
.                                                                               
          MATCH     SP70,BEDKEY                                                 
          GOTO      FWBD8000 IF EQUAL                                           
          PACK      KEY6,WARDKEY,BEDKEY                                         
          CALL      RDWARD1                                                     
          IF        OVRCD<>0                                                    
            APPEND    BEDKEY,BEDTEXT                                            
            GOTO      FWBD8000                                                  
          ENDIF                                                                 
          IF        WBEDDESC = 2                                                
            PACK      BEDTEXT,PTWDSDES,SP70                                   
          ELSE                                                                  
            PACK      BEDTEXT,WBDESC,SP70                                            
          ENDIF                                                                 
          GOTO      FWBD8000                                                    
.                                                                               
FWBD5000  MOVE      WARDKEY,WARDTEXT                                            
.         MATCH     SP70,BEDKEY                                                 
.         GOTO      FWBD9999 IF EQUAL                                           
          MOVE      BEDKEY,BEDTEXT                                              
          GOTO      FWBD9000                                                    
.                                                                               
FWBD8000  PACK      KEY6,KEY8                                                   
          CALL      RDWARD1           * reset Ward file just in case            
.                                                                               
FWBD9000  CLEAR     WBEDTEXT                                                    
          STRIP     WARDTEXT                                                    
          APPEND    WARDTEXT,WBEDTEXT                                           
.                                                                               
          MATCH     SP3,BEDKEY                                                  
          IF        !@EQUAL                                                      
            APPEND    "/",WBEDTEXT                                              
            APPEND    BEDTEXT,WBEDTEXT                                          
          ENDIF                                                                 
          RESET     WBEDTEXT                                                    
.                                                                               
FWBD9999  RETURN                                                                
+ 
.-------------------------------------------------------------------------
. FBED0000 - Format bed text                
.            Assumes we are postioned on correct patwr1af row
.-------------------------------------------------------------------------
FBED0000  MOVE      SP70,BEDTEXT  
          CLEAR     BEDTEXT
          MATCH     SP70,WBED
          GOTO      FBED9000 IF EQUAL
.
          IF        WBEDDESC > 0
            IF        WBEDDESC = 2                                                
              APPEND    PTWDSDES,BEDTEXT                                          
            ELSE                                                                  
              APPEND    WBDESC,BEDTEXT                                            
            ENDIF
          ELSE
            APPEND    WBED,BEDTEXT
          ENDIF
.
FBED9000  RESET     BEDTEXT
          STRIP     BEDTEXT
FBED9999  RETURN
+                                                                
.****************************************************************************
.*        IO ROUTINES FOR TEMPORARY FILE                                    *
.****************************************************************************
.
.         Index 1
.
RSTEMP1   READ      ECLTEMP1,KEY24;;
          RETURN
.
RDTEMP1   MOVE      ZERO,OVRCD
          READ      ECLTEMP1,KEY24;WBEJTRID,WBEJFTID,WBEJRADV,WBEJPNUM,PARTPANT
          GOTO      OVERCOND IF OVER
          RETURN
.
RKTEMP1   MOVE      ZERO,OVRCD
          READKS    ECLTEMP1;WBEJTRID,WBEJFTID,WBEJRADV,WBEJPNUM,PARTPANT
          GOTO      OVERCOND IF OVER
          RETURN
.
RPTEMP1   MOVE      ZERO,OVRCD
          READKP    ECLTEMP1;WBEJTRID,WBEJFTID,WBEJRADV,WBEJPNUM,PARTPANT
          GOTO      OVERCOND IF OVER
          RETURN
.
WRTEMP1   WRITE     ECLTEMP1,KEY24;WBEJTRID,WBEJFTID,WBEJRADV,WBEJPNUM,PARTPANT
          RETURN
.
UPTEMP1   UPDATE    ECLTEMP1;WBEJTRID,WBEJFTID,WBEJRADV,WBEJPNUM,PARTPANT
          RETURN
.
DETEMP1   DELETE    ECLTEMP1,KEY24
          RETURN
.
.         Index 2
.
RSTEMP2   READ      ECLTEMP2,KEY27;;
          RETURN
.
RKTEMP2   MOVE      ZERO,OVRCD
          READKS    ECLTEMP2;WBEJTRID,WBEJFTID,WBEJRADV,WBEJPNUM,PARTPANT
          GOTO      OVERCOND IF OVER
          RETURN
+
.------------------------------------------------------------
. Displays Current Patient ward/bed details
.------------------------------------------------------------
CTABH000  MOVE      ZERO,NUMOFPAT                * Number of patients in ward
          CALL      IBACLOCK                     * Calc expected discharge date
          PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
.
          MOVE      WINPUT,NOBEDWRD              * Save Ward Hdr WO/BO status
.
. No Bed 
.
          MOVE      ZERO,CLOSEFLG
          PACK      KEY13,WARDCODE,SP20
          MOVE      "1",FILETYPE
          CALL      RDSNOBE1
CTABH100  CALL      RDKNOBE1                * read next record
          BRANCH    OVRCD,CTABH190
          MATCH     WARDCODE,NBWARD         * same ward?
          GOTO      CTABH190 IF NOT EQUAL
          PACK      ADMISSNO,NBADMNO
          MOVE      NBROOM,WBED
          MOVE      ZERO,STBYFLAG
          CALL      CBEDH000         * Output Row Details
          GOTO      CTABH100
.
. Ward/Bed Details
.
CTABH190  PACK      KEY16,WARDCODE,SP70
          MOVE      "2",FILETYPE
          CALL      RDSWARD8
CTABH200  CALL      RDKWARD8
          BRANCH    OVRCD,CTABH290
.
          MATCH     WARDCODE,WWARD
          GOTO      CTABH290 IF NOT EQUAL
.
          MATCH     SP70,WBED
          GOTO      CTABH200 IF EQUAL
.
          IF        WBEDTYPE=3
            MATCH     ZEROVISN,WADMNO
            GOTO      CTABH220 IF NOT EQUAL
            PACK      KEY14,WWARD,WBED,SP70
            CALL      RDSONLV1
            CALL      RDKONLV1
            BRANCH    OVRCD,CTABH200
            MATCH     OWARD,WWARD
            GOTO      CTABH200 IF NOT EQUAL
            MATCH     OBED,WBED
            GOTO      CTABH200 IF NOT EQUAL
          ENDIF
CTABH220  BRANCH    WACTIVE,CTABH200       * Do not display Inactive Beds
          CALL      CROWH000
          GOTO      CTABH200
.
. On Leave Patients
.------------------
CTABH290  BRANCH    WBEDTYPE,CTABH300,CTABH999
. 
CTABH300  MOVE      "3",FILETYPE
          PACK      KEY14,WARDCODE,SP70
          CALL      RDSONLV1
CTABH800  CALL      RDKONLV1
          BRANCH    OVRCD,CTABH999
          MATCH     OWARD,WARDCODE
          GOTO      CTABH999 IF NOT EQUAL
          MATCH     ZEROVISN,OADMNO
          GOTO      CTABH800 IF EQUAL
          PACK      ADMISSNO,OADMNO
          MOVE      OBED,WBED
          MOVE      ZERO,STBYFLAG
.
          MOVE      ZERO,CLOSEFLG                * Reset 'Closed Bed' flag
          PACK      KEY6,WARDCODE,WBED,SP70      * Read Ward/Bed file
          CALL      RDWARD1
          BRANCH    OVRCD,CTABH850
          MOVE      PTWDBDST,CLOSEFLG            * Set 'Closed Bed' flag
.
CTABH850  CALL      CBEDH000         * Output Row Details
          GOTO      CTABH800
.
CTABH999  RETURN
.------------------------------------------------------------
. Output Ward/Bed Row
.------------------------------------------------------------
CROWH000  MATCH     ZEROVISN,WADMNO
          GOTO      CROWH800 IF EQUAL
.
. WBEDTYPE 0= All,1 = OPEN (IGNORE),2 = Empty 
.
          BRANCH    WBEDTYPE,CROWH100,CROWH999
.
CROWH100  PACK      ADMISSNO,WADMNO
          MOVE      ZERO,STBYFLAG
          MOVE      PTWDBDST,CLOSEFLG
          CALL      CBEDH000         * Output Row Details
          ADD       ONE,NUMOFPAT     * count number of patients in ward
.
          MATCH     ZEROVISN,WSTBY
          GOTO      CROWH999 IF EQUAL
.
          PACK      ADMISSNO,WSTBY
          MOVE      ONE,STBYFLAG
          CALL      CBEDH000         * Output Row Details
          ADD       ONE,NUMOFPAT     * count number of patients in ward
.
          GOTO      CROWH999
.
CROWH800  MOVE      SP70,PATFNAME
          MATCH     "1",PTWDBDST     * Is this bed closed?
          IF        @EQUAL
            MOVE      "Bed Closed",PATFNAME
            GOTO      CROWH850
          ELSE
            MOVE      "Empty Bed",PATFNAME
          ENDIF
.
          PACK      KEY14,WWARD,WBED,SP70
          CALL      RDSONLV1
CROWH810  CALL      RDKONLV1         * Try to find correct Ward/Bed
          BRANCH    OVRCD,CROWH850
          MATCH     OWARD,WWARD
          GOTO      CROWH850 IF NOT EQUAL
          MATCH     OBED,WBED
          GOTO      CROWH850 IF NOT EQUAL
          MOVE      ZERO,BEDMSGID     * Bed has patient on leave
          MOVE      "Patient On Leave",PATFNAME
.
CROWH850  WRITE     HTMLFILE;"t.addRow(#"",WWARD,"#",":
                             "#"",WBED,"#",":
                             "#"#",":
                             "#"#",":
                             "#"",PATFNAME,"#",":
                             "#"#",":
                             "#"#",":
                             "#"#",":
                             "#"#",":
                             "#"#",":
                             "#"#",":
                             "#"#",":
                             "#"#",":
                             "#"#",":
                             "#"#",":
                             "#"#",":
                             "#"#",":
                             "#"#",":
                             "#"#",":
                             "#"#",":
                             "#"#",":
                             "#"#",":
                             "#"#",":
                             "#"#",":
                             "#"#",":
                             "#"#");"

CROWH999  RETURN
.
.------------------------------------------------------------
. Current Admissions Patient Details
.------------------------------------------------------------
CBEDH000  PACK      SECDOCDE,SP70
.
          CALL      GETPAT00
          CALL      PATLN000
          CALL      PATFLD00                * Use standard Patient Folder sub
          MOVE      KEY3,FOLDERSF           * and store suffix
          CALL      GTDIET00
          MOVE      ADOCTA,DOCTCODE
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,CBEDH010
.
          PACK      KEY10,PMVXEDC1
          CALL      RDPMHCP1
          BRANCH    OVRCD,CBEDH010
.
          SQUEEZE   PMHCTITL
          SQUEEZE   PMHCSNAM
          MOVE      PMHCGNAM,DIM1
.
          MOVE      PMHCTITL,SECDOCDE
          APPEND    SP1,SECDOCDE
          APPEND    DIM1,SECDOCDE
          APPEND    DOT,SECDOCDE
          APPEND    SP1,SECDOCDE
          APPEND    PMHCSNAM,SECDOCDE
.
CBEDH010  MATCH     "1",ANAESTFL                                      *I-174468
          IF        @EQUAL
            CALL      GETAN000              * get Anaesthetist
          ENDIF
.
          CALL      XRET0000                * Exp return from leave date/time 
.
          MATCH     SP70,PTWDCOMM
          IF        @EQUAL
            CLEAR     PTWDCOMM
            APPEND    "Bed ",PTWDCOMM
            APPEND    WBED,PTWDCOMM
            RESET     PTWDCOMM
          ENDIF
.
          MOVE      "DC",CATEGORY
          MOVE      ADIET,CODE
          CALL      GETCOD00
          MOVE      TDESC,DIETDESC
.
          CALL      GETCON00               * Get Patient Condition Details
          REP       "#" ",ADIAG1
          REP       "#" ",ADIAG2
          UNPACK    IMGSRC,KEY10,CONDINDC
.
          WRITE     HTMLFILE;"t.addRow(#"",WWARD,"#",":
                             "#"",WBED,"#",":
                             "#"",PURNO,"#",":
                             "#"",ADMISSNO,"#",":
                             "#"",PATFNAME,"#",":
                             "#"",PSEX,"#",":
                             "#"";
          CALL      WRTAGE00
          WRITE     HTMLFILE;"#",":
                             "#"",ADIAG1,ADIAG2,"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",ADATE,"#",":
                             "#"",DDATE,"#",":
                             "#"",DESTDESC,"#",":
                             "#"",ADIET,"#",":
                             "#"",DIETDESC,"#",":
                             "#"",PATLINK,"#",":
                             "#"",PMWOEDAT,PMWOEDTM,"#",":
                             "#"",CONLINK,"#",":
                             "#"",CONDESC,DISPDATE,SP1,LPCONDD,SP1,VISPHONE,"#",":
                             "#"",CONDINDC,"#",":
                             "#"",FOLDERSF,"#",":
                             "#"",COLRFLAG,"#",":
                             "#"",CLOSEFLG,"#",":
                             "#"",STBYFLAG,"#",":
                             "#"",PTWDCOMM,"#",":
                             "#"",PTMXSIN1,PTMXSIN2,PTMXSIN3,PTMXSIN4,PTMXSIN5,"#",":
                             "#"",FILETYPE,"#");"

.
CBEDH999  RETURN
.------------------------------------------------------------
. Output Bed Management View
.------------------------------------------------------------
BEDMV000  PACK      KEY30,WARDCODE,LASTDATE,SP70
          CALL      RSPTBMD4
BEDMV100  CALL      RKPTBMD4
          BRANCH    OVRCD,BEDMV999
          MATCH     WARDCODE,PTBDWARD
          GOTO      BEDMV999 IF NOT EQUAL
          MATCH     PTBDDATE,LASTDATE
          GOTO      BEDMV999 IF NOT EQUAL
.
          PACK    KEY8,PTBDADMN,SP70
          CALL    RDBKREC1
          IF      OVRCD=0
            COMPARE   TWO,BKRESTAT
            GOTO      BEDMV100 IF EQUAL
            MOVE      BKREURNO,TEMPURNO
          ELSE
            CALL    CLBOKRC1
          ENDIF
.
          PACK    KEY8,PTBDADMN,SP70
          CALL    RDBKRX11
          IF      OVRCD=1
            CALL    CLBOKRX1
          ENDIF
.
          CALL    RDMISS1
          IF      OVRCD=0
            MATCH     "5",DASTAT
            GOTO      BEDMV100 IF EQUAL
            MOVE      AURNO,TEMPURNO
          ELSE
            CALL    CLPATMIS
            PACK    ADATE,BKREEDAT
            PACK    ATIME,BKREATIM
            PACK    ACLSSFT,BKREDEPT
            PACK    ADOCTA,BKREADOC
            PACK    AFUNDH,SP70
            PACK    AFNDTB,SP70
            PACK    KEY8,TEMPURNO,SP70
            CALL    RDMAST1
            IF      OVRCD=0
              PACK    AFUNDH,PFUNDH
              PACK    AFNDTB,PFNDTB
            ENDIF
          ENDIF
.
          PACK      KEY18,DIM8,SP70
          CALL      RABKDIA1
          CALL      RKBKDIA1
          IF        OVRCD<>1
            MATCH   DIM8,DBKDIBOO
            IF      @EQUAL
              MOVE    BKDIDES1,ADIAG1
            ENDIF
          ENDIF
.
          MOVE      TEMPURNO,URNUMBER
          PACK      ADMISSNO,PTBDADMN
.
          PACK      KEY6,PTBDWARD,PTBDWBED,SP70  * Read Ward/Bed file
          CALL      RDWARD1
          BRANCH    OVRCD,BEDMV100
.
          MOVE      PTWDBDST,CLOSEFLG            * Set 'Closed Bed' flag
          CALL      GETPAT00
          CALL      PATLN000
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,BEDMV110
.
BEDMV110  
          CALL      RGMCOD00                     * Get 3 Reg Codes
          CALL      GETSP000                     * Get Speciality
          CALL      GETAD000                     * Get Attending Doctor
          CALL      GETHF000                     * Get Health Fund
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMWOR1
          IF        OVRCD=1
            MOVE      SP70,PMWOEDAT
            MOVE      SP70,PMWOEDTM
          ENDIF
          REP       "#" ",ADIAG1
          REP       "#' ",ADIAG1
          WRITE     HTMLFILE;"mapView.addEvent(#"",PTBDWARD,"#",":
                             "#"",PTBDWBED,"#",":  *1
                             "#"",PURNO,"#",":     *2
                             "#"",ADMISSNO,"#",":  *3
                             "#"",PATFNAME,"#",":  *4
                             "#"",PSEX,"#",":      *5
                             "#"";
          CALL      WRTAGE00                       *6
          WRITE     HTMLFILE;"#",":
                             "#"",PTBDADTM,"#",":  *7
                             "#"",PTBDLOSM,"#",":  *8
                             "#"",PTBDLOSD,"#",":  *9
                             "#"",PTBDOPPE,"#",":  *10
                             "#"",PTBDSTAT,"#",":  *11
                             "#"",PTBDOVER,"#",":  *12
                             "#"",PTBDBRQN,"#",":  *13
                             "#"",ADIAG1,"#",":  *14
                             "#"",DOCFNAME,"#",":  *15
                             "#"",ADATE,"#",":     *16
                             "#"",DDATE,"#",":     *17
                             "#"",PMWOEDAT,PMWOEDTM,"#",":   *18
                             "#"",SPECDESC,"#",":  *19
                             "#"",FUNDDESC,"#",":  *20
                             "#"",RGMNAM01,"#",":  *21
                             "#"",RGMNAM02,"#",":  *22
                             "#"",RGMNAM03,"#",":  *23
                             "#"",RGMSTA01,"#",":  *24
                             "#"",RGMSTA02,"#",":  *25
                             "#"",RGMSTA03,"#",":  *26
                             "#"",PTELEP,"#",":  *27
                             "#"",PTBDWARD,PTBDWBED,PTBDADTM,"#",":  *28 Sort Order
                             "#"",RGMCOD01,"#",":  *29
                             "#"",RGMCOD02,"#",":  *30
                             "#"",RGMCOD03,"#",":  *31
                             "#"";
.
          MOVE      ADMISSNO,KEY8                    *32 3xComment Lines
          CALL      VSCMNT00                    
.
BEDMV290  MOVE      SP70,TDESC
          MATCH     SP70,BKRXDROR
          IF        !@EQUAL
            MOVE      BKRXDROR,TDESC
            MOVE      "Ba",CATEGORY
            MOVE      BKRXDROR,CODE
            CALL      GETCOD00
          ENDIF
          WRITE     HTMLFILE;"#",":
                             "#"",TDESC;  *33
.
          WRITE     HTMLFILE;"#");"
          GOTO      BEDMV100
.
BEDMV999  RETURN
.
.----------------------------------------------------------------------
. Retrieve the 1st 3 comment text lines of the latest active visit
. comment details
.----------------------------------------------------------------------
.
VSCMNT00  PACK      KEY17,KEY8,VSCMTTYP,Z70      * Key for start of comment
          CALL      RSVSMDT1
VSCMNT20  CALL      RPVSMDT1
          BRANCH    OVRCD,VSCMNT99
.
          MATCH     KEY8,VSMDVISN
          GOTO      VSCMNT99 IF NOT EQUAL
.
          MATCH     VSCMTTYP,VSMDTYPE
          GOTO      VSCMNT99 IF NOT EQUAL
.
          MATCH     "1",VSMDDELT          * is comment deleted
          GOTO      VSCMNT20 IF EQUAL
.
. Retrieve the comment text line details
.
          MOVE      ZERO,F1
          PACK      KEY20,VSMDVISN,VSMDTYPE,VSMDNOTE,SP70
          CALL      RSVSMTX1
VSCMNT60  CALL      RKVSMTX1
          BRANCH    OVRCD,VSCMNT99
.
          MATCH     VSMDVISN,VSMTVISN
          GOTO      VSCMNT99 IF NOT EQUAL
.
          MATCH     VSMDTYPE,VSMTTYPE
          GOTO      VSCMNT99 IF NOT EQUAL
.
          MATCH     VSMDNOTE,VSMTNOTE
          GOTO      VSCMNT99 IF NOT EQUAL
.
          ADD       ONE,F1
          REP       "#" ",VSMTCMNT
          REP       "#' ",VSMTCMNT
          WRITE     HTMLFILE;VSMTCMNT;
          COMPARE   THREE,F1               * only 3 comment text is  used     
          GOTO      VSCMNT60 IF NOT EQUAL 
.
VSCMNT99  RETURN
.
.----------------------------------------------------------------------
BEDLO000  PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
BEDLO100  CALL      RDKWARD1
          BRANCH    OVRCD,BEDLO999
          MATCH     WARDCODE,WWARD
          GOTO      BEDLO999 IF NOT EQUAL
.
          BRANCH    WACTIVE,BEDLO100       * Do not display Inactive Beds
.
          WRITE     HTMLFILE;"mapView.addBed(#"",WWARD,"#",":
                             "#"",WBED,"#",":
                             "#"",WBDESC,"#",":
                             "#"",WEXTN,"#",":
                             "#"",WACTIVE,"#",":
                             "#"",PTWDBDST,"#",":
                             "#"",PTWDHKST,"#");"
          GOTO     BEDLO100
.
BEDLO999  RETURN
.
BEDCL000  PACK     KEY22,WARDCODE,SP70
          CALL     RSPMBDC1
BEDCL010  CALL     RKPMBDC1
          BRANCH   OVRCD,BEDCL999
.
          MATCH    WARDCODE,PMBCWARD
          GOTO     BEDCL999 IF NOT EQUAL
.
          MATCH    PMBCFRDT,LASTDATE
          GOTO     BEDCL010 IF LESS
.
          MATCH    LASTDATE,PMBCTODT
          GOTO     BEDCL010 IF LESS
.
          WRITE     HTMLFILE;"mapView.addClosure(#"",PMBCWARD,"#",":
                             "#"",PMBCBED,"#",":
                             "#"",PMBCFRDT,"#",":
                             "#"",PMBCFRTM,"#",":
                             "#"",PMBCTODT,"#",":
                             "#"",PMBCTOTM,"#");"
.
          GOTO     BEDCL010
.
BEDCL999  RETURN
.
GETSP000  MOVE      SP70,SPECDESC
          MATCH     SP70,ACLSSFT
          IF        !@EQUAL
            PACK      KEY5,ANSA,ANSC,ACLSSFT,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MOVE      TDESC,SPECDESC
            ENDIF
          ENDIF
          RETURN
.
GETAD000  MOVE      SP70,DOCFNAME
          MATCH     SP70,ADOCTA
          IF        !@EQUAL
            MOVE      SP70,DOCFNAME
            PACK      KEY10,ADOCTA,SP70
            CALL      RDPMHCP1
            IF        OVRCD<>1
              MOVE      PMHCTITL,FMTTITLE
              MOVE      PMHCGNAM,FMTGNAME
              MOVE      PMHCSNAM,FMTSNAME
              CALL      DOCNM000
              REP       "'`",DOCFNAME
            ENDIF
          ENDIF
          RETURN
.
GETHF000  CLEAR     FUNDDESC
          MATCH     SP70,AFUNDH
          IF        !@EQUAL
            PACK      KEY14,AFUNDH,ZERO,ZERO,ZERO,ZERO,SP70
            CALL      RDFUND1
            IF        OVRCD<>1
              APPEND    HFNAME,FUNDDESC
            ENDIF
            PACK      KEY14,AFUNDH,AFNDTB,SP70
            CALL      RDFUND1
            IF        OVRCD<>1
              APPEND    " - ",FUNDDESC
              APPEND    HFNAME,FUNDDESC
            ENDIF
         ENDIF
         APPEND   SP1,FUNDDESC
         RESET    FUNDDESC
         RETURN
.
RGMCOD00  MOVE      ZERO,FORM1A 
          MOVE      SP70,RGMCOD01
          MOVE      SP70,RGMCOD02
          MOVE      SP70,RGMCOD03
          MOVE      SP70,RGMNAM01
          MOVE      SP70,RGMNAM02
          MOVE      SP70,RGMNAM03
          MOVE      SP70,RGMSTA01
          MOVE      SP70,RGMSTA02
          MOVE      SP70,RGMSTA03
.    
          PACK      KEY10,ADMISSNO,SP70
          CALL      RSPTRGM1
RGMCOD10  CALL      RKPTRGM1
          BRANCH    OVRCD,RGMCOD99
          MATCH     ADMISSNO,PTRGADMN
          GOTO      RGMCOD99 IF NOT EQUAL
.
          PACK      KEY13,PTRGREGM,SP1,SP1,ZERO,SP70
          CALL      RDPMREG1 
          BRANCH    OVRCD,RGMCOD10
.
          ADD       ONE,FORM1A
          STORE     PMREREGM,FORM1A,RGMCOD01,RGMCOD02,RGMCOD03
          STORE     PMREDESC,FORM1A,RGMNAM01,RGMNAM02,RGMNAM03
          PACK      KEY5,CODS,CODN,PMRESNCD,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            STORE     TCINDC1,FORM1A,RGMSTA01,RGMSTA02,RGMSTA03
          ENDIF
.
          COMPARE   THREE,FORM1A
          GOTO      RGMCOD10 IF NOT EQUAL
.
RGMCOD99  RETURN
.------------------------------------------------------------------------------
. Special Needs Ledgend
.------------------------------------------------------------------------------
SNLD0000  PACK      KEY50,SP70
          PACK      KEY5,CATSN,SP70
          CALL      RDSCODE1
SNLD1000  CALL      RDKCODE1
          BRANCH    OVRCD,SNLD9999
          MATCH     TCODE,CATSN
          GOTO      SNLD9999 IF NOT EQUAL
          MATCH     "I",PTCOACTV
          GOTO      SNLD1000 IF EQUAL
          MATCH     SP70,TCINDC1
          GOTO      SNLD1000 IF EQUAL
          SCAN      TCINDC1,KEY50
          GOTO      SNLD1000 IF EQUAL
          STRIP     KEY50
          PACK      KEY50,KEY50,TCINDC1,SP70
.
          WRITE     HTMLFILE;"mapView.addRegime(#"",TCINDC1,"#",":
                             "#"",TDESC,"#",":
                             "#"",PTCDLDES,"#");"
          GOTO      SNLD1000
.
SNLD9999  RETURN
.
.------------------------------------------------------------
. Displays Current Patient ward/bed details
.------------------------------------------------------------
CTABI000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,DLINKPRG,DIM127
          UNPACK    DIM127,D1,DLINKREP,DIM127
          UNPACK    DIM127,D1,DLINKTEM,DIM127
          UNPACK    DIM127,D1,WORKFLAG,DIM127    * Working Diag Flag
          UNPACK    DIM127,D1,PRNTLABL,DIM127    * Print Labels Flag
          UNPACK    DIM127,D1,ANAESTFL,DIM127    * Anaesthetist Flag
          UNPACK    DIM127,D1,SKIPDIET,DIM127    * Skip DIet Text
          UNPACK    DIM127,D1,MHLSFLAG,DIM127    * MH Legal Status Flag
.
          MOVE      WORKFLAG,WORKDFLG            * Display working diagnosis
          MOVE      MHLSFLAG,MEHLSFLG            * Display MH Legal Status 
.
          PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
          MOVE      WCLASS,SAVCLASS
.
          MOVE      ZERO,NUMOFPAT                * Number of patients in ward
          MOVE      ZERO,CRSRTCNT
.
          CALL      IBACLOCK                     * Calc expected discharge date
          PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
.
          IF        EMRGVIEW=1
            MOVE      ZERO,EMVIFLAG              * redirect supervisor clinical
            PACK      KEY5,ANSB,ANST,WEFRBT,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MATCH     "S",THCSCOD              * EOU Unit
              IF        @EQUAL
                MATCH     ANSO,TCINDC8           * Display EOU on map
                IF        @EQUAL
                  MOVE      ONE,EMVIFLAG         * redirect supervisor clinical
                ENDIF
              ENDIF
            ENDIF
            CALL      WARDET00                   * Calculate  ward statistics
          ENDIF
.
. No Bed
.
          MOVE      ZERO,CLOSEFLG
          PACK      KEY13,WARDCODE,SP20
          MOVE      "1",FILETYPE
          CALL      RDSNOBE1
CTABI100  CALL      RDKNOBE1                * read next record
          BRANCH    OVRCD,CTABI190
          MATCH     WARDCODE,NBWARD         * same ward?
          GOTO      CTABI190 IF NOT EQUAL
          PACK      ADMISSNO,NBADMNO
          MOVE      NBROOM,WBED
          MOVE      ZERO,STBYFLAG
          CALL      CBEDI000         * Output Row Details
          GOTO      CTABI100
.
. Ward/Bed Details
.
CTABI190  PACK      KEY16,WARDCODE,SP70
          MOVE      "2",FILETYPE
          CALL      RDSWARD8
CTABI200  CALL      RDKWARD8
          BRANCH    OVRCD,CTABI290
.
          MATCH     WARDCODE,WWARD
          GOTO      CTABI290 IF NOT EQUAL
.
          MATCH     SP70,WBED
          GOTO      CTABI200 IF EQUAL
.
          IF        WBEDTYPE=3
            MATCH     ZEROVISN,WADMNO
            GOTO      CTABI220 IF NOT EQUAL
            PACK      KEY14,WWARD,WBED,SP70
            CALL      RDSONLV1
            CALL      RDKONLV1
            BRANCH    OVRCD,CTABI200
            MATCH     OWARD,WWARD
            GOTO      CTABI200 IF NOT EQUAL
            MATCH     OBED,WBED
            GOTO      CTABI200 IF NOT EQUAL
          ENDIF
CTABI220  BRANCH    WACTIVE,CTABI200       * Do not display Inactive Beds
          CALL      CROWI000
          GOTO      CTABI200
.
. On Leave Patients
.------------------
CTABI290  BRANCH    WBEDTYPE,CTABI300,CTABI999
.
CTABI300  MOVE      "3",FILETYPE
          PACK      KEY14,WARDCODE,SP70
          CALL      RDSONLV1
CTABI800  CALL      RDKONLV1
          BRANCH    OVRCD,CTABI999
.
          MATCH     OWARD,WARDCODE
          GOTO      CTABI999 IF NOT EQUAL
.
          MATCH     ZEROVISN,OADMNO
          GOTO      CTABI800 IF EQUAL
.
          PACK      ADMISSNO,OADMNO
          MOVE      OBED,WBED
          MOVE      ZERO,STBYFLAG
.
          MOVE      ZERO,CLOSEFLG                * Reset 'Closed Bed' flag
          PACK      KEY6,WARDCODE,WBED,SP70      * Read Ward/Bed file
          CALL      RDWARD1
          BRANCH    OVRCD,CTABI850
          MOVE      PTWDBDST,CLOSEFLG            * Set 'Closed Bed' flag
.
CTABI850  CALL      CBEDI000         * Output Row Details
          GOTO      CTABI800
.
CTABI999  RETURN
.
.------------------------------------------------------------
. Current Admissions Patient Details
.------------------------------------------------------------
CBEDI000  PACK      SECDOCDE,SP70
.
          CALL      GETPAT00
          CALL      PATLN000
          CALL      PATFLD00                * Use standard Patient Folder sub
          MOVE      KEY3,FOLDERSF           * and store suffix
          CALL      GTDIET00
          MOVE      ADOCTA,DOCTCODE
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,CBEDI010
.
          PACK      KEY10,PMVXEDC1
          CALL      RDPMHCP1
          BRANCH    OVRCD,CBEDI010
.
          SQUEEZE   PMHCTITL
          SQUEEZE   PMHCSNAM
          MOVE      PMHCGNAM,DIM1
.
          MOVE      PMHCTITL,SECDOCDE
          APPEND    SP1,SECDOCDE
          APPEND    DIM1,SECDOCDE
          APPEND    DOT,SECDOCDE
          APPEND    SP1,SECDOCDE
          APPEND    PMHCSNAM,SECDOCDE
.
CBEDI010  MATCH     "1",ANAESTFL                                      *I-174468
          IF        @EQUAL
            CALL      GETAN000              * get Anaesthetist
          ENDIF
.
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
.
          CALL      XRET0000                * Exp return from leave date/time
.
          MATCH     SP70,PTWDCOMM
          IF        @EQUAL
            CLEAR     PTWDCOMM
            APPEND    "Bed ",PTWDCOMM
            APPEND    WBED,PTWDCOMM
            RESET     PTWDCOMM
          ENDIF
.
.
CBEDI050  CALL      FBED0000
          ADD       ONE,CRSRTCNT
          MOVE      SP70,DIM3
          MOVE      CRSRTCNT,DIM3
          REP       " +",DIM3
.
          BRANCH    FILETYPE,CBEDI060,CBEDI070,CBEDI080
.
CBEDI060  WRITE     HTMLFILE;"t.addRow(#"UnallocatedCell":
                             "#",#"":
                             "<input type=hidden name='",DIM3,"'> ":
                             "<img src='../images/EditIcon.gif'":
                             " class=ListIcon onclick=BedAllocation('":
                             URNUMBER,"','",ADMISSNO,"')> ",BEDTEXT,"#",";
.
          GOTO      CBEDI090
.
CBEDI070  IF        STBYFLAG=0
            MATCH     "1",CLOSEFLG     * Is this Bed Closed?
            IF        @EQUAL
              WRITE     HTMLFILE;"t.addRow(#"ClosedCell":
                                 "#",#"":
                                 "<input type=hidden name='",DIM3,"'> ":
                                 BEDTEXT,"#",";
            ELSE
              WRITE     HTMLFILE;"t.addRow(#"":
                                 "#",#"":
                                 "<input type=hidden name='",DIM3,"'> ":
                                 BEDTEXT,"#",";
            ENDIF
          ELSE
            WRITE     HTMLFILE;"t.addRow(#"StandbyCell":
                               "#",#"":
                               "<input type=hidden name='",DIM3,"'> ":
                               BEDTEXT,"#",";
          ENDIF
.
          GOTO      CBEDI090
.
CBEDI080  MATCH     "1",CLOSEFLG     * Is this Bed Closed?
          IF        @EQUAL
            WRITE     HTMLFILE;"t.addRow(#"ClosedCell":
                               "#",#"":
                               "<input type=hidden name='",DIM3,"'> ":
                               BEDTEXT,"#",";
          ELSE
            WRITE     HTMLFILE;"t.addRow(#"LeaveCell":
                               "#",#"":
                               "<input type=hidden name='",DIM3,"'> ":
                               BEDTEXT,"#",";
          ENDIF
.
CBEDI090  PACK      DIM127A,SP70,SP70
          MOVE      FORMATNM,DIM127A
          REPLACE   "' ",DIM127A
.
          WRITE     HTMLFILE;"#"":
                "<input type=hidden value='",DIM127A,"' name='",ADMISSNO,"'> ":
                           "<img src='../images/PatientFolder",FOLDERSF,".gif'":
                             " class=ListIcon ":
                             " onclick=PatFolLink('",LINKPRG,".pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO,"');>";
.
          IF        DISPDNAM=1
            REP       "+ ",ADMISSNO
            REP       "+ ",URNUMBER
            CALL      CHKD0000           * Duplicate Surnames?
            IF        DUPNMFLG=1
              WRITE     HTMLFILE;"<img src='../images/samename.gif'":
                                 " alt='Patient Name Conflict'":
                                 " class=ListIcon>";
            ENDIF
            REP       " +",ADMISSNO
            REP       " +",URNUMBER
.
          ENDIF
.
          WRITE     HTMLFILE;FORMATNM,"#",";
.
CBEDI100  CALL      GETCON00               * Get Patient Condition Details
.
          MATCH     SP70,CONDESC
          IF        !@EQUAL
            UNPACK    LPCDATE,CCENT,CYEAR,CMON,CDAY
            PACK      DISPDATE,LBRACKT,CDAY,SLASH,CMON,SP1,LPCTIME,RBRACKT
          ELSE
            CLEAR     DISPDATE
          ENDIF
.
          WRITE     HTMLFILE;"#"";
.
          REP       " +",CONDESC1
          WRITE     HTMLFILE;"<input type=hidden name='",CONDESC1,"'>";
          REP       "+ ",CONDESC1
.
.
.
          MOVE      ZERO,EXIT
          PROC      DISPALRT                * check for Disability Alerts
          IF        EXIT=0 | EXIT=2
            MATCH     "1",PMPXSIN7
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIconM.gif'":
                                 " alt='Medical Alerts'":
                                 " class=ListIcon onclick=PatientAlerts('":
                                 URNUMBER,"','",ADMISSNO,"')>";
            ENDIF
.
            MATCH     "1",PMPXSIN8
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIconB.gif'":
                                 " alt='Micro Alerts'":
                                 " class=ListIcon onclick=PatientAlerts('":
                                 URNUMBER,"','",ADMISSNO,"')>";
            ENDIF
.
            MATCH     "1",PMPXSIN9
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIconR.gif'":
                                 " alt='Risk Alerts'":
                                 " class=ListIcon onclick=PatientAlerts('":
                                 URNUMBER,"','",ADMISSNO,"')>";
            ENDIF
.
            MATCH     "1",PMPXSN11
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIconC.gif'":
                                 " alt='Chronic Alerts'":
                                 " class=ListIcon onclick=PatientAlerts('":
                                 URNUMBER,"','",ADMISSNO,"')>";
            ENDIF
.
            MATCH     "1",PTMXSIN1
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIcon.gif'":
                                 " alt='Alerts'":
                                 " class=ListIcon onclick=PatientAlerts('":
                                 URNUMBER,"','",ADMISSNO,"')>";
              GOTO      CBEDI120
            ENDIF
.
            MATCH     "2",PTMXSIN1
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIconBlack.gif'":
                                 " alt='Alerts'":
                                 " class=ListIcon onclick=PatientAlerts('":
                                 URNUMBER,"','",ADMISSNO,"')>";
              GOTO      CBEDI120
            ENDIF
.
            MATCH     "3",PTMXSIN1
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIconDelete.gif'":
                                 " alt='Alerts'":
                                 " class=ListIcon onclick=PatientAlerts('":
                                 URNUMBER,"','",ADMISSNO,"')>";
              GOTO      CBEDI120
            ENDIF
.
            MATCH     SP70,PTMXSIN1
            IF        !@EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIcon":
                                 PTMXSIN1,".gif'":
                                 " alt='Alerts'":
                                 " class=ListIcon onclick=PatientAlerts('":
                                 URNUMBER,"','",ADMISSNO,"')>";
            ENDIF
          ENDIF
.
CBEDI120  IF        EXIT=1 | EXIT=2
            WRITE     HTMLFILE;"<img src='../images/AlertIconDIS.gif'":
                               " alt='Disability Alerts'":
                               " class=ListIcon onclick=PatientAlerts('":
                               URNUMBER,"','",ADMISSNO,"')>";
          ENDIF
.
          MATCH     "1",PTMXSIN2
          IF        @EQUAL
.            WRITE     HTMLFILE;"<img src='../images/ResultIcon.gif'":
.                               " class=ListIcon onclick=PatientResults('":
.                               URNUMBER,"','",ADMISSNO,"')>";
          ENDIF
.
          IF        EMRGVIEW=1
            CALL      GETE0000
            MATCH     ZEROVISN,EMVIADMN
            IF        !@EQUAL
              WRITE     HTMLFILE;"<img src='../images/DocumentIcon.gif'":
                                 " class=ListIcon ":
                                 " alt='Update emergency clinic notes'" :
                                 " onclick=UpdateEMR('":
                             URNUMBER,"','",EMVIADMN,"','",EMVIFLAG,"')>";
            ENDIF
          ENDIF
.
.-------- Get Over flow description --------                         *C-0837181
          MOVE      SP70,OVFLDESC
          IF        HEAVIEW=1
            CALL      OVFDS000                         * Get OVFLDESC
          ENDIF
.
CBEDI122  IF        MEHLSFLG=1
            CALL      CMHLM000              * Check for MH legal status icon
          ENDIF
.
          IF        WORKDFLG=1
            MATCH     SP70,PMVXUDF2
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/",IMGSRC:
                                 "' class=ListIcon onclick=UpdateCondition('":
                                 URNUMBER,"','",ADMISSNO,"')>":
                                 CONDESC,DISPDATE,WORKDESC,OVFLDESC; 
            ELSE
              WRITE     HTMLFILE;"<img src='../images/",IMGSRC:
                                 "' class=ListIcon onclick=UpdateCondition('":
                                 URNUMBER,"','",ADMISSNO,"')>":
                                 CONDESC,DISPDATE,OVFLDESC,"<br>",PMVXUDF2:
                                 WORKDESC; 
            ENDIF
            GOTO      CBEDI130
          ENDIF
.
          MATCH     SP70,LPCONDD
          IF        @EQUAL
            MATCH     SP70,PMVXUDF2
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/",IMGSRC:
                                 "' class=ListIcon onclick=UpdateCondition('":
                                 URNUMBER,"','",ADMISSNO,"')>":
                                 CONDESC,DISPDATE,OVFLDESC; 
            ELSE
              WRITE     HTMLFILE;"<img src='../images/",IMGSRC:
                                 "' class=ListIcon onclick=UpdateCondition('":
                                 URNUMBER,"','",ADMISSNO,"')>":
                                 CONDESC,DISPDATE,OVFLDESC,"<br>",PMVXUDF2;  
            ENDIF
          ELSE
            MATCH     SP70,PMVXUDF2
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/",IMGSRC:
                                 "' class=ListIcon onclick=UpdateCondition('":
                                 URNUMBER,"','",ADMISSNO,"')>":
                                 CONDESC,DISPDATE,OVFLDESC,"<br>",LPCONDD; 
            ELSE
              WRITE     HTMLFILE;"<img src='../images/",IMGSRC:
                                 "' class=ListIcon onclick=UpdateCondition('":
                                 URNUMBER,"','",ADMISSNO,"')>":
                                 CONDESC,DISPDATE,OVFLDESC,"<br>",LPCONDD:
                                 "<br>",PMVXUDF2; 
            ENDIF
          ENDIF
.
CBEDI130  MOVE      ANSR,DIM1
          MATCH     "1",PMVXVALW
          IF        @EQUAL
            MOVE ANSV,DIM1
          ENDIF
          WRITE     HTMLFILE;"<br>[",DIM1,COMMA,NBSP;
.
          MOVE      ANSN,DIM1
          MATCH     "1",PMVXPALW
          IF        @EQUAL
            MOVE ANSP,DIM1
          ENDIF
          WRITE     HTMLFILE;DIM1,"]";
.
          BRANCH    KIDSONLY,CBEDI140
          MATCH     SP3,LPCONAM
          IF        !@EQUAL
            MOVE      "AM",CATEGORY
            MOVE      LPCONAM,CODE
            CALL      GETCOD00
            WRITE     HTMLFILE;NBSP,NBSP,TDESC;
          ENDIF
.
CBEDI140  MATCH     SP3,PMWODPST
          IF        !@EQUAL
            MOVE      "vi",CATEGORY
            MOVE      PMWODPST,CODE
            CALL      GETCOD00
            WRITE     HTMLFILE;NBSP,TDESC;
          ENDIF
.
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
          MOVE      ZERO,BORDICIN
          PACK      KEY26,ADMISSNO,SP70
          CALL      RSPTBRD3
CBEDI142  CALL      RKPTBRD3
          IF        OVRCD=0
            MATCH     ADMISSNO,PTBRVISN
            IF        @EQUAL
              MATCH     SP70,PTBREDAT
              IF        !@EQUAL & !@EOS
                MATCH     TODAYDAT,PTBREDAT
                GOTO      CBEDI142 IF LESS            * CAR 304926
                GOTO      CBEDI143 IF NOT EQUAL       * CAR 304926
.
                MATCH     SP70,PTBRETIM
                IF        !@EQUAL & !@EOS
                  MATCH     CTIMEIS,PTBRETIM
                  GOTO      CBEDI142 IF LESS          * CAR 304926
                ENDIF
              ENDIF
CBEDI143      ADD       ONE,BORDICIN
              COMPARE   TWO,BORDICIN
              GOTO      CBEDI144 IF EQUAL
              GOTO      CBEDI142
            ENDIF
          ENDIF
.
CBEDI144  PACK      KEY26,ADMISSNO,SP70
          CALL      RSPTBRD3
CBEDI145  CALL      RKPTBRD3
          IF        OVRCD=0
            MATCH     ADMISSNO,PTBRVISN
            IF        @EQUAL
              MATCH     SP70,PTBREDAT
              IF        !@EQUAL & !@EOS
                MATCH     TODAYDAT,PTBREDAT
                GOTO      CBEDI145 IF LESS            * CAR 304926
                GOTO      CBEDI146 IF NOT EQUAL       * CAR 304926
.
                MATCH     SP70,PTBRETIM
                IF        !@EQUAL & !@EOS
                  MATCH     CTIMEIS,PTBRETIM
                  GOTO      CBEDI145 IF LESS          * CAR 304926
                ENDIF
              ENDIF
.
CBEDI146        MOVE      SP70,DISPBBDT
                MATCH     SP70,PTBRBDAT
                IF        !@EQUAL & !@EOS
                  UNPACK    PTBRBDAT,CCENT,CYEAR,CMON,CDAY
                  MOVE      CMON,F2
                  LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN:
                                       JUL,AUG,SEP,OCT,NOV,DEC
                  PACK      DISPBBDT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
                  CALL      IBACLOCK
                  PACK      AGEDATE,CCC,CYY,CMM,CDD
                  PACK      PBDATE,PTBRBDAT
                  CALL      CALCAGE
                  MOVE      PSAGEYRS,PSAGEDIM
                ELSE
                  MOVE      SP70,PSAGEDIM
                ENDIF
.
                MOVE      SP70,DISPBSDT
                MATCH     SP70,PTBRSDAT
                IF        !@EQUAL & !@EOS
                  UNPACK    PTBRSDAT,CCENT,CYEAR,CMON,CDAY
                  MOVE      CMON,F2
                  LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN:
                                       JUL,AUG,SEP,OCT,NOV,DEC
                  PACK      DISPBSDT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
                ENDIF
.
                IF        BORDICIN=2
                  MATCH     SP70,PTBRADR1
                  IF        @EQUAL | @EOS
                    MATCH     SP70,PTBRADR2
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDI147
                    ENDIF
.
                    MATCH     SP70,PTBRADR3
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDI147
                    ENDIF
.
                    MATCH     SP70,PTBRADR4
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDI147
                    ENDIF
.
                    MATCH     SP70,PTBRPOST
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDI147
                    ENDIF
.
                    MATCH     SP70,PTBRHPHN
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDI147
                    ENDIF
.
                    MATCH     SP70,PTBRWPHN
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDI147
                    ENDIF
.
                    MATCH     SP70,PTBRMPHN
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDI147
                    ENDIF
.
                    MATCH     SP70,PTBREMAL
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDI147
                    ENDIF
.
                    MATCH     SP70,PTBRLURN
                    IF        @EQUAL | @EOS
                      GOTO      CBEDI147
                    ENDIF
.
                    PACK      KEY8,PTBRLURN,SP70
                    CALL      RDMAST1
                    IF        OVRCD
                      PACK      KEY8,URNUMBER,SP70
                      CALL      RDMAST1
.
                      GOTO      CBEDI147
                    ENDIF
.
                    CALL      RDPMPX21
.
                    REP       " +",URNUMBER
                    REP       " +",ADMISSNO
                    REP       " +",PTBRBRDN
.
                    WRITE     HTMLFILE;"&nbsp;&nbsp;<img src='../images/PatientLink4.gif' class=ListIcon":
                           " onclick=gotoBoarder('",URNUMBER,"','",ADMISSNO:
                           "','",PTBRBRDN,"');";
.
                    REP       "+ ",URNUMBER
                    REP       "+ ",ADMISSNO
                    REP       "+ ",PTBRBRDN
.
                    REP       "'` +",PTBRSNAM
                    REP       "'` +",PTBRGNAM
                    REP       " +",PTBRGEND
                    REP       " +",DISPBBDT
                    REP       " +",PSAGEDIM
                    REP       "'` +",PADD1
                    REP       "'` +",PADD2
                    REP       "'` +",PSUBRB
                    REP       "'` +",PADD4
                    REP       " +",PPOST
                    REP       " +",PTELEP
                    REP       " +",PTELEB
                    REP       " +",PTMXCELL
                    REP       " +",PMPXPEML
                    REP       " +",DISPBSDT
                    REP       " +",PTBRSTIM
                    REP       "'`",PTELEP
                    REP       "'`",PTELEB
.
                    WRITE     HTMLFILE;" onmouseover=showit('",PTBRSNAM,"'":
                                                  ",'",PTBRGNAM,"'":
                                                  ",'",PTBRGEND,"'":
                                                  ",'",DISPBBDT,"'":
                                                  ",'",PSAGEDIM,"'":
                                                  ",'",PADD1,"'":
                                                  ",'",PADD2,"'":
                                                  ",'",PSUBRB,"'":
                                                  ",'",PADD4,"'":
                                                  ",'",PPOST,"'":
                                                  ",'",PTELEP,"'":
                                                  ",'",PTELEB,"'":
                                                  ",'",PTMXCELL,"'":
                                                  ",'",PMPXPEML,"'":
                                                  ",'",DISPBSDT,"'":
                                                  ",'",PTBRSTIM,"'";
.
                    REP       "`'+ ",PTBRSNAM
                    REP       "`'+ ",PTBRGNAM
                    REP       "+ ",PTBRGEND
                    REP       "+ ",DISPBBDT
                    REP       "+ ",PSAGEDIM
                    REP       "`'+ ",PADD1
                    REP       "`'+ ",PADD2
                    REP       "`'+ ",PSUBRB
                    REP       "`'+ ",PADD4
                    REP       "+ ",PPOST
                    REP       "+ ",PTELEP
                    REP       "+ ",PTELEB
                    REP       "+ ",PTMXCELL
                    REP       "+ ",PMPXPEML
                    REP       "+ ",DISPBSDT
                    REP       "+ ",PTBRSTIM
                    REP       "'`",PTELEP
                    REP       "'`",PTELEB
.
                    PACK      KEY8,URNUMBER,SP70
                    CALL      RDMAST1
                    CALL      RDPMPX21
.
                  ELSE
.
CBEDI147            REP       " +",URNUMBER
                    REP       " +",ADMISSNO 
                    REP       " +",PTBRBRDN
.                   
                    WRITE     HTMLFILE;"&nbsp;&nbsp;<img src='../images/PatientLink4.gif' class=ListIcon":
                           " onclick=gotoBoarder('",URNUMBER,"','",ADMISSNO:
                           "','",PTBRBRDN,"');";
.
                    REP       "+ ",URNUMBER
                    REP       "+ ",ADMISSNO
                    REP       "+ ",PTBRBRDN
.
                    REP       "'` +",PTBRSNAM
                    REP       "'` +",PTBRGNAM
                    REP       " +",PTBRGEND
                    REP       " +",DISPBBDT
                    REP       " +",PSAGEDIM
                    REP       "'` +",PTBRADR1
                    REP       "'` +",PTBRADR2
                    REP       "'` +",PTBRADR3
                    REP       "'` +",PTBRADR4
                    REP       " +",PTBRPOST
                    REP       " +",PTBRHPHN
                    REP       " +",PTBRWPHN
                    REP       " +",PTBRMPHN
                    REP       " +",PTBREMAL
                    REP       " +",DISPBSDT
                    REP       " +",PTBRSTIM
.
                    WRITE     HTMLFILE;" onmouseover=showit('",PTBRSNAM,"'":
                                                  ",'",PTBRGNAM,"'":
                                                  ",'",PTBRGEND,"'":
                                                  ",'",DISPBBDT,"'":
                                                  ",'",PSAGEDIM,"'":
                                                  ",'",PTBRADR1,"'":
                                                  ",'",PTBRADR2,"'":
                                                  ",'",PTBRADR3,"'":
                                                  ",'",PTBRADR4,"'":
                                                  ",'",PTBRPOST,"'":
                                                  ",'",PTBRHPHN,"'":
                                                  ",'",PTBRWPHN,"'":
                                                  ",'",PTBRMPHN,"'":
                                                  ",'",PTBREMAL,"'":
                                                  ",'",DISPBSDT,"'":
                                                  ",'",PTBRSTIM,"'";
.
                    REP       "`'+ ",PTBRSNAM
                    REP       "`'+ ",PTBRGNAM
                    REP       "+ ",PTBRGEND
                    REP       "+ ",DISPBBDT
                    REP       "+ ",PSAGEDIM
                    REP       "`'+ ",PTBRADR1
                    REP       "`'+ ",PTBRADR2
                    REP       "`'+ ",PTBRADR3
                    REP       "`'+ ",PTBRADR4
                    REP       "+ ",PTBRPOST
                    REP       "+ ",PTBRHPHN
                    REP       "+ ",PTBRWPHN
                    REP       "+ ",PTBRMPHN
                    REP       "+ ",PTBREMAL
                    REP       "+ ",DISPBSDT
                    REP       "+ ",PTBRSTIM
.
                  ENDIF
.
        REP       " +",PTBRLURN
        REP       " +",PTBRTITL
        REP       " +",PTITL   
        REP       " +",PSNAME  
        REP       " +",PGNAME  
.
        WRITE     HTMLFILE;",'",PTBRLURN,"'";
.
        WRITE     HTMLFILE;",'",PTBRTITL,"'":
                           ",'",PTITL,"'":
                           ",'",PSNAME,"'":
                           ",'",PGNAME,"'":
                           ");";
.
        REP       "+ ",PTBRLURN
        REP       "+ ",PTBRTITL
        REP       "+ ",PTITL
        REP       "+ ",PSNAME
        REP       "+ ",PGNAME
.
        WRITE     HTMLFILE;" onmouseout=hideit();>";
                ELSE
                  MATCH     SP70,PTBRADR1
                  IF        @EQUAL | @EOS
                    MATCH     SP70,PTBRADR2
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDI149
                    ENDIF
.
                    MATCH     SP70,PTBRADR3
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDI149
                    ENDIF
.
                    MATCH     SP70,PTBRADR4
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDI149
                    ENDIF
.
                    MATCH     SP70,PTBRPOST
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDI149
                    ENDIF
.
                    MATCH     SP70,PTBRHPHN
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDI149
                    ENDIF
.
                    MATCH     SP70,PTBRWPHN
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDI149
                    ENDIF
.
                    MATCH     SP70,PTBRMPHN
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDI149
                    ENDIF
.
                    MATCH     SP70,PTBREMAL
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDI149
                    ENDIF
.
                    MATCH     SP70,PTBRLURN
                    IF        @EQUAL | @EOS
                      GOTO      CBEDI149
                    ENDIF
.
                    PACK      KEY8,PTBRLURN,SP70
                    CALL      RDMAST1
                    IF        OVRCD
                      PACK      KEY8,URNUMBER,SP70
                      CALL      RDMAST1
.
                      GOTO      CBEDI149
                    ENDIF
.
                    CALL      RDPMPX21
.
                    REP       " +",URNUMBER
                    REP       " +",ADMISSNO
                    REP       " +",PTBRBRDN
.
                  WRITE     HTMLFILE;"&nbsp;&nbsp;<img src='../images/PatientLink1.gif' class=ListIcon":
                           " onclick=gotoBoarder('",URNUMBER,"','",ADMISSNO:
                           "','",PTBRBRDN,"');";
.
                    REP       "+ ",URNUMBER
                    REP       "+ ",ADMISSNO
                    REP       "+ ",PTBRBRDN
.
                    REP       "'` +",PTBRSNAM
                    REP       "'` +",PTBRGNAM
                    REP       " +",PTBRGEND
                    REP       " +",DISPBBDT
                    REP       " +",PSAGEDIM
                    REP       "'` +",PADD1
                    REP       "'` +",PADD2
                    REP       "'` +",PSUBRB
                    REP       "'` +",PADD4
                    REP       " +",PPOST
                    REP       " +",PTELEP
                    REP       " +",PTELEB
                    REP       " +",PTMXCELL
                    REP       " +",PMPXPEML
                    REP       " +",DISPBSDT
                    REP       " +",PTBRSTIM
                    REP       "'`",PTELEP
                    REP       "'`",PTELEB
.
                    WRITE     HTMLFILE;" onmouseover=showit('",PTBRSNAM,"'":
                                                  ",'",PTBRGNAM,"'":
                                                  ",'",PTBRGEND,"'":
                                                  ",'",DISPBBDT,"'":
                                                  ",'",PSAGEDIM,"'":
                                                  ",'",PADD1,"'":
                                                  ",'",PADD2,"'":
                                                  ",'",PSUBRB,"'":
                                                  ",'",PADD4,"'":
                                                  ",'",PPOST,"'":
                                                  ",'",PTELEP,"'":
                                                  ",'",PTELEB,"'":
                                                  ",'",PTMXCELL,"'":
                                                  ",'",PMPXPEML,"'":
                                                  ",'",DISPBSDT,"'":
                                                  ",'",PTBRSTIM,"'";
.
                    REP       "`'+ ",PTBRSNAM
                    REP       "`'+ ",PTBRGNAM
                    REP       "+ ",PTBRGEND
                    REP       "+ ",DISPBBDT
                    REP       "+ ",PSAGEDIM
                    REP       "`'+ ",PADD1
                    REP       "`'+ ",PADD2
                    REP       "`'+ ",PSUBRB
                    REP       "`'+ ",PADD4
                    REP       "+ ",PPOST
                    REP       "+ ",PTELEP
                    REP       "+ ",PTELEB
                    REP       "+ ",PTMXCELL
                    REP       "+ ",PMPXPEML
                    REP       "+ ",DISPBSDT
                    REP       "+ ",PTBRSTIM
                    REP       "'`",PTELEP
                    REP       "'`",PTELEB
.
                    PACK      KEY8,URNUMBER,SP70
                    CALL      RDMAST1
                    CALL      RDPMPX21
.
                  ELSE
.
CBEDI149        REP       " +",URNUMBER
                REP       " +",ADMISSNO 
                REP       " +",PTBRBRDN
.
                WRITE     HTMLFILE;"&nbsp;&nbsp;<img src='../images/PatientLink1.gif' class=ListIcon":
                           " onclick=gotoBoarder('",URNUMBER,"','",ADMISSNO:
                           "','",PTBRBRDN,"');";
.
                REP       "+ ",URNUMBER
                REP       "+ ",ADMISSNO
                REP       "+ ",PTBRBRDN
.
                REP       "'` +",PTBRSNAM
                REP       "'` +",PTBRGNAM
                REP       " +",PTBRGEND
                REP       " +",DISPBBDT
                REP       " +",PSAGEDIM
                REP       "'` +",PTBRADR1
                REP       "'` +",PTBRADR2
                REP       "'` +",PTBRADR3
                REP       "'` +",PTBRADR4
                REP       " +",PTBRPOST
                REP       " +",PTBRHPHN
                REP       " +",PTBRWPHN
                REP       " +",PTBRMPHN
                REP       " +",PTBREMAL
                REP       " +",DISPBSDT
                REP       " +",PTBRSTIM

.
                WRITE     HTMLFILE;" onmouseover=showit('",PTBRSNAM,"'":
                                                  ",'",PTBRGNAM,"'":
                                                  ",'",PTBRGEND,"'":
                                                  ",'",DISPBBDT,"'":
                                                  ",'",PSAGEDIM,"'":
                                                  ",'",PTBRADR1,"'":
                                                  ",'",PTBRADR2,"'":
                                                  ",'",PTBRADR3,"'":
                                                  ",'",PTBRADR4,"'":
                                                  ",'",PTBRPOST,"'":
                                                  ",'",PTBRHPHN,"'":
                                                  ",'",PTBRWPHN,"'":
                                                  ",'",PTBRMPHN,"'":
                                                  ",'",PTBREMAL,"'":
                                                  ",'",DISPBSDT,"'":
                                                  ",'",PTBRSTIM,"'";
.
                REP       "`'+ ",PTBRSNAM
                REP       "`'+ ",PTBRGNAM
                REP       "+ ",PTBRGEND
                REP       "+ ",DISPBBDT
                REP       "+ ",PSAGEDIM
                REP       "`'+ ",PTBRADR1
                REP       "`'+ ",PTBRADR2
                REP       "`'+ ",PTBRADR3
                REP       "`'+ ",PTBRADR4
                REP       "+ ",PTBRPOST
                REP       "+ ",PTBRHPHN
                REP       "+ ",PTBRWPHN
                REP       "+ ",PTBRMPHN
                REP       "+ ",PTBREMAL
                REP       "+ ",DISPBSDT
                REP       "+ ",PTBRSTIM
.
                  ENDIF
.
        REP       " +",PTBRLURN
        REP       " +",PTBRTITL
        REP       " +",PTITL
        REP       " +",PSNAME
        REP       " +",PGNAME
.
        WRITE     HTMLFILE;",'",PTBRLURN,"'";
.
        WRITE     HTMLFILE;",'",PTBRTITL,"'":
                           ",'",PTITL,"'":
                           ",'",PSNAME,"'":
                           ",'",PGNAME,"'":
                           ");":
                           " onmouseout=hideit();>";
.
        REP       "+ ",PTBRLURN
        REP       "+ ",PTBRTITL
        REP       "+ ",PTITL
        REP       "+ ",PSNAME
        REP       "+ ",PGNAME
.
                ENDIF
            ENDIF
          ENDIF
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
.
          WRITE     HTMLFILE;"#",";
.
.------------------------------------------------------------------------------
.
          MOVE      "DC",CATEGORY
          MOVE      ADIET,CODE
          CALL      GETCOD00
.
          WRITE     HTMLFILE;"#"";
.
          REP       " +",TDESC
          WRITE     HTMLFILE;"<input type=hidden name='",TDESC,"'>";
          REP       "+ ",TDESC
.
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
.                                          * I CAR 48029
          IF        PTCNHDPS = ONE
            WRITE     HTMLFILE;"<img src=../images/DietIcon.gif ":
                               " class=ListIcon onclick=UpdateDiet('":
                               URNUMBER,"','",ADMISSNO,"')>";
. 
            MATCH     "1",SKIPDIET
            IF        !@EQUAL
              WRITE     HTMLFILE;TDESC,"<br> ",PMVXUDF4;
            ENDIF
.
          ELSE
            WRITE     HTMLFILE;"<img src=../images/DietIcon.gif ":
                               " class=ListIcon onclick=UpdateDiet('":
                               URNUMBER,"','",ADMISSNO,"')>";

            MATCH     "1",SKIPDIET
            IF        !@EQUAL
              WRITE     HTMLFILE;TDESC;
            ENDIF
          ENDIF
.
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
          WRITE     HTMLFILE;"#",";
.
.------------------------------------------------------------------------------
.
          WRITE     HTMLFILE;"#"";
          WRITE     HTMLFILE;DTFASTNG;
          WRITE     HTMLFILE;"#",";
.          
.------------------------------------------------------------------------------
.
CBEDI150  MOVE      SP70,TDESC
          REP       "+ ",ADMISSNO
          PACK      KEY30,ADMISSNO,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          IF        OVRCD = 0
            MATCH     ADMISSNO,DTADMN
            IF        @EQUAL
              MOVE      "AC",CATEGORY
              MOVE      TDEPT,CODE
              CALL      GETCOD00
             ENDIF
          ENDIF
          REP       " +",ADMISSNO
.
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
.-------------------------------------------------------------------------------
.
CBEDI155  WRITE     HTMLFILE;"#"";
.
          REP       " +",DOCTCODE
.
          WRITE     HTMLFILE;TDESC;
          WRITE     HTMLFILE;"#",";
.
.------------------------------------------------------------------------------
.
          WRITE     HTMLFILE;"#"";
          WRITE     HTMLFILE;" <a href=":
                             "javascript:funcDoctorViewFrame('",DOCTCODE,"')>":
                              SDOCFNAM,"</a>";
.
          REP       "+ ",DOCTCODE
.
          MATCH     SP70,PMVXEDC1
          GOTO      CBEDI158 IF EQUAL
.
          REP       " +",PMVXEDC1
.
          WRITE     HTMLFILE;SP1,SLASH,SP1,"<a href=":
                             "javascript:funcDoctorViewFrame('",PMVXEDC1,"')>":
                              SECDOCDE,"</a>";
.
          REP       "+ ",PMVXEDC1
.
CBEDI158  MATCH     "1",ANAESTFL                                      *I-174468
          IF        @EQUAL
            MATCH     SP6,ANATNAME
            IF        @EQUAL
              WRITE     HTMLFILE;"&nbsp;";
            ELSE
.
              REP       " +",ANATCODE
.
              WRITE     HTMLFILE;"<a href=":
                              "javascript:funcDoctorViewFrame('",ANATCODE,"')>":
                                ANATNAME,"</a>";
.
              REP       "+ ",ANATCODE
.
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"#",";
.
.
.-------------------------------------------------------------------------------
.
CBEDI160  WRITE     HTMLFILE;"#"":
                             ADATE,ATIME:
                             "#",";
.
.-------------------------------------------------------------------------------
.         
          MOVE      SP70,DIM8
          MOVE      SP70,DIM8A
          UNPACK    EXPCTDSC,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR,KEY1,DIM8A
          CALL      SETMTH00
          PACK      DIM8,CCENT,CYEAR,CMON,CDAY
          REP       " 0",DIM8
.
          WRITE     HTMLFILE;"#"":
                             DIM8,DIM8A:
                             "#",";
.
.-------------------------------------------------------------------------------
.
          WRITE     HTMLFILE;"#"";
.
          REP       " +",OERDATE
          WRITE     HTMLFILE;"&nbsp;<input type=hidden name='",OERDATE,"'>";
          REP       "+ ",OERDATE
.
          CALL      CHKMUL000
          IF        EXIT=0
            WRITE     HTMLFILE;"Current IP - ",MULTHOSP,"<br>";
          ENDIF
.
          IF        FILETYPE=3
            WRITE     HTMLFILE;EXPLRETN;
          ENDIF
.
          WRITE     HTMLFILE;"#",";
.
.-------------------------------------------------------------------------------
.
CBEDI900  WRITE     HTMLFILE;"#"",COLRFLAG,"#");"
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
CBEDI999  RETURN
+
.------------------------------------------------------------
. Output Ward/Bed Row
.------------------------------------------------------------
CROWI000  MATCH     ZEROVISN,WADMNO
          GOTO      CROWI800 IF EQUAL
.
. WBEDTYPE 0= All,1 = OPEN (IGNORE),2 = Empty
.
          BRANCH    WBEDTYPE,CROWI100,CROWI999
.
CROWI100  PACK      ADMISSNO,WADMNO
          MOVE      ZERO,STBYFLAG
          MOVE      PTWDBDST,CLOSEFLG
          CALL      CBEDI000         * Output Row Details
          ADD       ONE,NUMOFPAT     * count number of patients in ward
.
          MATCH     ZEROVISN,WSTBY
          GOTO      CROWI999 IF EQUAL
.
          PACK      ADMISSNO,WSTBY
          MOVE      ONE,STBYFLAG
          CALL      CBEDI000         * Output Row Details
          ADD       ONE,NUMOFPAT     * count number of patients in ward
.
          GOTO      CROWI999
.
CROWI800  MATCH     "1",PTWDBDST     * Is this bed closed?
          IF        @EQUAL
            MOVE      TWO,BEDMSGID   * Yes, bed is closed
            GOTO      CROWI850
          ELSE
            MOVE      ONE,BEDMSGID   * Assume Empty Bed
          ENDIF
.
          PACK      KEY14,WWARD,WBED,SP70
          CALL      RDSONLV1
CROWI810  CALL      RDKONLV1         * Try to find correct Ward/Bed
          BRANCH    OVRCD,CROWI850
          MATCH     OWARD,WWARD
          GOTO      CROWI850 IF NOT EQUAL
          MATCH     OBED,WBED
          GOTO      CROWI850 IF NOT EQUAL
          MOVE      ZERO,BEDMSGID     * Bed has patient on leave
.
CROWI850  CALL      CBDMSI00
.
CROWI999  RETURN
+
.------------------------------------------------------------
. Current Admissions Bed Row message.
.------------------------------------------------------------
CBDMSI00  BRANCH    BEDMSGID,CBDMSI01,CBDMSI02
.
          MOVE      "LeaveCell",BDMSGCLS
          MOVE      "*** On Leave ***",BDMSGTXT
          GOTO      CBDMSI10
.
CBDMSI01  MOVE      "AvailableCell",BDMSGCLS
          MOVE      "*** Empty ***",BDMSGTXT
          GOTO      CBDMSI10
.
CBDMSI02  BRANCH    WBEDTYPE,CBDMSI99
          MOVE      "ClosedCell bgcolor=gray",BDMSGCLS
          MOVE      "*** Closed ***",BDMSGTXT
.
CBDMSI10  MATCH     SP70,PTWDCOMM
          IF        @EQUAL
            CLEAR     PTWDCOMM
            APPEND    "Bed ",PTWDCOMM
            APPEND    WBED,PTWDCOMM
            RESET     PTWDCOMM
          ENDIF
.
.         WRITE     HTMLFILE;"<tr height=35 align=top>":
.                            "<td align=center class=",BDMSGCLS,"":
.                            " title=#"",PTWDCOMM,"#">";
.
          ADD       ONE,CRSRTCNT
          MOVE      SP70,DIM3
          MOVE      CRSRTCNT,DIM3
          REP       " +",DIM3
.
          MATCH     "1",DEBDINDC
          GOTO      CBDMSI99 IF NOT EQUAL
.
          WRITE     HTMLFILE;"t.addRow(#"",BDMSGCLS:
                             "#",#"";
.
          WRITE     HTMLFILE;"<input type=hidden name='",DIM3,"'> ";
.
CBDMSI25  CALL      FBED0000
          WRITE     HTMLFILE;BEDTEXT;
          WRITE     HTMLFILE;"#",";                    
.
          WRITE     HTMLFILE;"#"": 
                             BDMSGTXT:
                             "#",";
.
CBDMSI20  WRITE     HTMLFILE;"#"#",":
                             "#"#",":
                             "#"#",": 
                             "#"#",":
                             "#"#",":
                             "#"#",":
                             "#"#",":
                             "#"#",";
.
          WRITE     HTMLFILE;"#"","","#");"
.
CBDMSI99  RETURN
+
.------------------------------------------------------------
. Displays Current Patient ward/bed details for Map View
.------------------------------------------------------------
CMAPH000  MOVE      ZERO,NUMOFPAT                * Number of patients in ward
          CALL      IBACLOCK                     * Calc expected discharge date
          PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
          MOVE      WCLASS,SAVCLASS
.
          MOVE      WINPUT,NOBEDWRD              * Save Ward Hdr WO/BO status
.
. No Bed 
.
          MOVE      ZERO,CLOSEFLG
          PACK      KEY13,WARDCODE,SP20
          MOVE      "1",FILETYPE
          CALL      RDSNOBE1
CMAPH100  CALL      RDKNOBE1                * read next record
          BRANCH    OVRCD,CMAPH190
          MATCH     WARDCODE,NBWARD         * same ward?
          GOTO      CMAPH190 IF NOT EQUAL
          PACK      ADMISSNO,NBADMNO
          MOVE      NBROOM,WBED
          MOVE      ZERO,STBYFLAG
.
          CALL      MBEDH000         * Output Row Details
          GOTO      CMAPH100
.
. Ward/Bed Details
.
CMAPH190  PACK      KEY16,WARDCODE,SP70
          MOVE      "2",FILETYPE
          CALL      RDSWARD8
CMAPH200  CALL      RDKWARD8
          BRANCH    OVRCD,CMAPH290
.
          MATCH     WARDCODE,WWARD
          GOTO      CMAPH290 IF NOT EQUAL
.
          MATCH     SP70,WBED
          GOTO      CMAPH200 IF EQUAL
.
          IF        WBEDTYPE=3
            MATCH     ZEROVISN,WADMNO
            GOTO      CMAPH220 IF NOT EQUAL
            PACK      KEY14,WWARD,WBED,SP70
            CALL      RDSONLV1
            CALL      RDKONLV1
            BRANCH    OVRCD,CMAPH200
            MATCH     OWARD,WWARD
            GOTO      CMAPH200 IF NOT EQUAL
            MATCH     OBED,WBED
            GOTO      CMAPH200 IF NOT EQUAL
          ENDIF
CMAPH220  BRANCH    WACTIVE,CMAPH200       * Do not display Inactive Beds
          CALL      MROWH000
          GOTO      CMAPH200
.
. On Leave Patients
.------------------
CMAPH290  BRANCH    WBEDTYPE,CMAPH300,CMAPH999
. 
CMAPH300  MOVE      "3",FILETYPE
          PACK      KEY14,WARDCODE,SP70
          CALL      RDSONLV1
CMAPH800  CALL      RDKONLV1
          BRANCH    OVRCD,CMAPH999
          MATCH     OWARD,WARDCODE
          GOTO      CMAPH999 IF NOT EQUAL
          MATCH     ZEROVISN,OADMNO
          GOTO      CMAPH800 IF EQUAL
          PACK      ADMISSNO,OADMNO
          MOVE      OBED,WBED
          MOVE      ZERO,STBYFLAG
.
          MOVE      ZERO,CLOSEFLG                * Reset 'Closed Bed' flag
          PACK      KEY6,WARDCODE,WBED,SP70      * Read Ward/Bed file
          CALL      RDWARD1
          BRANCH    OVRCD,CMAPH850
          MOVE      PTWDBDST,CLOSEFLG            * Set 'Closed Bed' flag
.
CMAPH850  CALL      MBEDH000         * Output Row Details
          GOTO      CMAPH800
.
CMAPH999  RETURN
.------------------------------------------------------------
. Output Ward/Bed Row
.------------------------------------------------------------
MROWH000  MATCH     ZEROVISN,WADMNO
          GOTO      MROWH800 IF EQUAL
.
. WBEDTYPE 0= All,1 = OPEN (IGNORE),2 = Empty 
.
          BRANCH    WBEDTYPE,MROWH100,MROWH999
.
MROWH100  PACK      ADMISSNO,WADMNO
          MOVE      ZERO,STBYFLAG
          MOVE      PTWDBDST,CLOSEFLG
          CALL      MBEDH000         * Output Row Details
          ADD       ONE,NUMOFPAT     * count number of patients in ward
.
          MATCH     ZEROVISN,WSTBY
          GOTO      MROWH999 IF EQUAL
.
          PACK      ADMISSNO,WSTBY
          MOVE      ONE,STBYFLAG
          CALL      MBEDH000         * Output Row Details
          ADD       ONE,NUMOFPAT     * count number of patients in ward
.
          GOTO      MROWH999
.
MROWH800  
MROWH999  RETURN
.
.------------------------------------------------------------
. Get Boarder Count
.------------------------------------------------------------
GETBRD00  MOVE      ZERO,BOARDERS
          PACK      KEY26,ADMISSNO,SP70
          CALL      RSPTBRD3
GETBRD10  CALL      RKPTBRD3
          BRANCH    OVRCD,GETBRD99
          MATCH     ADMISSNO,PTBRVISN
          GOTO      GETBRD99 IF NOT EQUAL
          ADD       ONE,BOARDERS
          GOTO      GETBRD10 
GETBRD99  RETURN
+
.------------------------------------------------------------
. Current Admissions Patient Details
.------------------------------------------------------------
MBEDH000  PACK      SECDOCDE,SP70
          CALL      GETPAT00
          CALL      PATLN000
          CALL      PATFLD00           * Use standard Patient Folder sub
          MOVE      KEY3,FOLDERSF      * and store suffix
          CALL      GETSP000           * Get Speciality
          MOVE      ADOCTA,DOCTCODE
          CALL      GETDS000           * Get Doctor Short Name
          CALL      GTDIET00
          CALL      GETVX000
          CALL      GETAN000           * get Anaesthetist
          CALL      GETANN00           * get Anaesthetist Name
          CALL      XRET0000           * Exp return from leave date/time
          CALL      GETOBS00           * Get Last Basic Observation Set
          CALL      GETCFL00           * Get Condition and Diet Flags
          CALL      GETUDC00           * Get Condition User Defined
          CALL      GETBRD00           * Get Boarder Flag
          CALL      CHKD0000           * Get surname conflict/duplicate flag
          CALL      CHKLST00
.
          REP       "\|'`",ANATDES1
          WRITE     HTMLFILE;"anatdes1='",ANATDES1,"';"
          WRITE     HTMLFILE;"anatdes1=anatdes1.replace(/\|/g,'\\');"
.
          REP       "\|'`",ANATDES2
          WRITE     HTMLFILE;"anatdes2='",ANATDES2,"';"
          WRITE     HTMLFILE;"anatdes2=anatdes2.replace(/\|/g,'\\');"
.
          REP       "\|'`",ANATDES3
          WRITE     HTMLFILE;"anatdes3='",ANATDES3,"';"
          WRITE     HTMLFILE;"anatdes3=anatdes3.replace(/\|/g,'\\');"
.
          WRITE     HTMLFILE;*+,"t.addRow(#"",WWARD,"#",":
                             "#"",WBED,"#",":
                             "#"",PURNO,"#",":
                             "#"",ADMISSNO,"#",":
                             "#"",PATFNAME,"#",":
                             "#"",PSEX,"#",":
                             "#"";
          CALL      WRTAGE00
          STRIP     PMWOWDI1
          STRIP     PMWOWDI2
          STRIP     PMWOWDI3
          STRIP     DESTDESC
          STRIP     CONDESC
          STRIP     DIETDESC
          STRIP     SPECDESC
          STRIP     PSNAME
          STRIP     PGNAME
          STRIP     PTITL
.
MBEDH100  MOVE      SP70,KEY1
          PACK      KEY5,PTMXSIN1,PMPXSIN7,PMPXSIN8,PMPXSIN9,PMPXSN11,SP70
          MATCH     SP70,KEY5
          IF        !@EQUAL
            MOVE      "1",KEY1              * Display alert on Ward Whiteboard
          ENDIF
          WRITE     HTMLFILE;*+,"#",":
                             "#"",ADIAG1,ADIAG2,"#",":
                             "#"",SDOCFNAM,"#",":
                             "#"",ADATE,"#",":
                             "#"",DDATE,"#",":                             * 10
                             "#"",DESTDESC,"#",":
                             "#"",ADIET,"#",":
                             "#"",DIETDESC,"#",":
                             "#"",PATLINK,"#",":
                             "#"",PMWOEDAT,PMWOEDTM,"#",":
                             "#"",CONLINK,"#",":
                             "#"",CONDESC,"#",":
                             "#"",CONDINDC,"#",":
                             "#"",LPCDATE,LPCTIME,"#",":
                             "#"",LPCONDD,"#",":                           * 20
                             "#"",VISPHONE,"#",":
                             "#"",FOLDERSF,"#",":
                             "#"",COLRFLAG,"#",":
                             "#"",CLOSEFLG,"#",":
                             "#"",STBYFLAG,"#",":
                             "#"",PTWDCOMM,"#",":
                             "#"",PTMXSIN1,PTMXSIN2,PTMXSIN3,PTMXSIN4:
                             PTMXSIN5,KEY1,"#",":
                             "#"",DOCTCODE,"#",":
                             "#"",PMVXEDC1,"#",":
                             "#"",SECDOCDE,"#",":                          * 30
                             "#"",EXPLRETN,"#",":
                             "#"",SPECDESC,"#",":
                             "#"",FILETYPE,"#",":
                             "#"",PMWOWDI1,"#",":
                             "#"",PMWOWDI2,"#",":
                             "#"",PMWOWDI3,"#",":
                             "#"",OBDEDATE,OBDETIME,"#",":
                             "#"",OBDEPULS,"#",":
                             "#"",OBDETEMP,"#",":
                             "#"",OBDERESP,"#",":                          * 40
                             "#"",OBDEBPSY,"#",":
                             "#"",OBDEBPDI,"#",":
                             "#"",OBDEPOX,"#",":
                             "#"",OBDECOM1,"#",":
                             "#"",ANATDATE,ANATEXPS,"#",":
                             "#"",ANATEXPD,"#",":
                             "#"",ANATCODE,"#",":
                             "#"",ANATNAME,"#",":
                             "#"",ANATTHET,"#",":
                             "#"",ANATANAE,"#",":                          * 50
                             "#"",ANATTYPE,"#",":
                             "#"",ANATTRAN,"#",":
                             "anatdes1,":
                             "anatdes2,":
                             "anatdes3,":
                             "#"",BKRXPOWD,"#",":
                             "#"",BKRXPOBD,"#",":
                             "#"",CURSTATS,"#",":
                             "#"",NAMECTVA,"#",":
                             "#"",NAMECTVB,"#",":                          * 60
                             "#"",NAMECTVC,"#",":
                             "#"",NAMECTVD,"#",":
                             "#"",NAMECTVE,"#",":
                             "#"",NAMECTVF,"#",":
                             "#"",NAMECTVG,"#",":
                             "#"",NAMECTVH,"#",":
                             "#"",USERDF01,"#",":
                             "#"",USERDF02,"#",":
                             "#"",USERDF03,"#",":
                             "#"",USERDF04,"#",":                          * 70
                             "#"",USERDF05,"#",":
                             "#"",USERDF06,"#",":
                             "#"",USERDF07,"#",":
                             "#"",USERDF08,"#",":
                             "#"",USERDF09,"#",":
                             "#"",USERDF10,"#",":
                             "#"",PTITL,"#",":
                             "#"",PGNAME,"#",":
                             "#"",PSNAME,"#",":
                             "#"",BOARDERS,"#",":                          * 80
                             "#"",PMNUFAST,"#",":
                             "#"",DUPNMFLG,"#",":
                             "#"",ASTAY,"#",":
                             "#"",ACLAIM,"#",":
                             "#"",AFUNDH,"#",":                            * 85
                             "#"",CURSTATS,CURSTATB,"#",":    
                             "#"",WEXTN,"#",":    
                             "#"",DESCDPST,"#",";  
.
          CALL      THET0000                          * Check Theatre Today
.
          UNPACK    SAVKEY27,PTVEVISN,PTVEVTYP,PTVESDAT,PTVESTIM
          WRITE     HTMLFILE;"#"",THETODAY,"#",":
                             "#"",MVFLAG,"#",":                            * 90
                             "#"",PTVEVTYP,"#",":
                             "#"",PTVESDAT,"#",":
                             "#"",PTVESTIM,"#",";              
.
          CALL      OVFDS000                           * Get OVFLDESC *C-0837181
          WRITE     HTMLFILE;"#"",OVFLDESC,"#",":                   
                             "#"",LSFLAG,"#");"        * Legal status flag
.
MBEDH999  RETURN
+
.------------------------------------------------------------
. Check if patient has any theatre bookings for today
. with a status of booked
.------------------------------------------------------------
THET0000  MOVE      ZERO,THETODAY
.
          CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          PACK      KEY31,ADMISSNO,TWO,CURRDATE,SP70
          CALL      RSOPDEA2
          CALL      RKOPDEA2
          BRANCH    OVRCD,THET9999
.
          MATCH     ADMISSNO,OPDAADMN
          GOTO      THET9999 IF NOT EQUAL
.
          COMPARE   TWO,OPDASTAT
          GOTO      THET9999 IF NOT EQUAL
.
          MATCH     CURRDATE,OPDADATE
          GOTO      THET9999 IF NOT EQUAL
.
          MOVE      ONE,THETODAY
.
THET9999  RETURN
.------------------------------------------------------------
. Get Condition User Defined
.------------------------------------------------------------
GETUDC00  MOVE      ZERO,F1
GETUDC10  ADD       ONE,F1
          STORE     SP70,F1,NAMECTVA,NAMECTVB,NAMECTVC,NAMECTVD,NAMECTVE,NAMECTVF,NAMECTVG,NAMECTVH
          LOAD      KEY2,F1,CATVA,CATVB,CATVC,CATVD,CATVE,CATVF,CATVG,CATVH
          LOAD      KEY3,F1,PMWOUDF1,PMWOUDF2,PMWOUDF3,PMWOUDF4,PMWOUDF5,PMWOUDF6,PMWOUDF7,PMWOUDF8
          MATCH     SP70,KEY3
          GOTO      GETUDC19 IF EQUAL
.
          PACK      KEY5,KEY2,KEY3
          CALL      RDCODE1
          IF        OVRCD=0
            STORE     TDESC,F1,NAMECTVA,NAMECTVB,NAMECTVC,NAMECTVD,NAMECTVE,NAMECTVF,NAMECTVG,NAMECTVH
          ENDIF
GETUDC19  IF        F1<8
            GOTO      GETUDC10
          ENDIF
          STRIP     NAMECTVA
          STRIP     NAMECTVB
          STRIP     NAMECTVC
          STRIP     NAMECTVD
          STRIP     NAMECTVE
          STRIP     NAMECTVF
          STRIP     NAMECTVG
          STRIP     NAMECTVH
.
          PACK      USERDF01,SP70,SP70
          PACK      USERDF02,SP70,SP70
          PACK      USERDF03,SP70,SP70
          PACK      USERDF04,SP70,SP70
          PACK      USERDF05,SP70,SP70
          PACK      USERDF06,SP70,SP70
          PACK      USERDF07,SP70,SP70
          PACK      USERDF08,SP70,SP70
          PACK      USERDF09,SP70,SP70
          PACK      USERDF10,SP70,SP70
          MOVE      "018",VSCTTYPE
          PACK      KEY14,ADMISSNO,VSCTTYPE,SP70
          CALL      RSVSCMT1
GETUDC40  CALL      RKVSCMT1
          BRANCH    OVRCD,GETUDC49
          MATCH     ADMISSNO,VSCTVIST
          GOTO      GETUDC49 IF NOT EQUAL
          MATCH     "018",VSCTTYPE
          GOTO      GETUDC49 IF NOT EQUAL
          MOVE      VSCTLINE,F3
          STORE     VSCTDATA,F3,USERDF01,USERDF02,USERDF03,USERDF04,USERDF05:
                                USERDF06,USERDF07,USERDF08,USERDF09,USERDF10
          GOTO      GETUDC40
GETUDC49  STRIP     USERDF01
          STRIP     USERDF02
          STRIP     USERDF03
          STRIP     USERDF04
          STRIP     USERDF05
          STRIP     USERDF06
          STRIP     USERDF07
          STRIP     USERDF08
          STRIP     USERDF09
          STRIP     USERDF10
GETUDC99  RETURN
.
GETDS000  PACK      KEY6,DOCTCODE
          CALL      RDDOCT1
          IF        OVRCD=0
            CALL      SDOCNM00
            CLEAR     SDOCFNAM
            SQUEEZE   DTITL
            SQUEEZE   DSNAME
            MOVE      DGNAME,DIM1
            APPEND    DTITL,SDOCFNAM
            APPEND    SP1,SDOCFNAM
            APPEND    DIM1,SDOCFNAM
            APPEND    DOT,SDOCFNAM
            APPEND    SP1,SDOCFNAM
            APPEND    DSNAME,SDOCFNAM
            RESET     SDOCFNAM
            STRIP     SDOCFNAM
          ENDIF
          RETURN
.
GETVX000  PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,GETVX999
.
          PACK      KEY10,PMVXEDC1
          CALL      RDPMHCP1
          BRANCH    OVRCD,GETVX999
.
          SQUEEZE   PMHCTITL
          SQUEEZE   PMHCSNAM
          MOVE      PMHCGNAM,DIM1
.
          CLEAR     SECDOCDE
          APPEND    PMHCTITL,SECDOCDE
          APPEND    SP1,SECDOCDE
          APPEND    DIM1,SECDOCDE
          APPEND    DOT,SECDOCDE
          APPEND    SP1,SECDOCDE
          APPEND    PMHCSNAM,SECDOCDE
          RESET     SECDOCDE
.
GETVX999  RETURN
.
GETANN00  COMPARE   ONE,ANATFLAG
          IF        @EQUAL
            CALL      PATSTS00
            CLEAR     ANATNAME
            SQUEEZE   DTITL
            SQUEEZE   DSNAME
            MOVE      DGNAME,DIM1
            APPEND    DTITL,ANATNAME
            APPEND    SP1,ANATNAME
            APPEND    DIM1,ANATNAME
            APPEND    DOT,ANATNAME
            APPEND    SP1,ANATNAME
            APPEND    DSNAME,ANATNAME
            RESET     ANATNAME
            STRIP     ANATNAME

            MOVE      OPDADATE,ANATDATE
            MOVE      OPDATIME,ANATTIME
            MOVE      OPDAEXPS,ANATEXPS
            MOVE      OPDAEXPD,ANATEXPD
            MOVE      OPDADES1,ANATDES1
            MOVE      OPDADES2,ANATDES2
            MOVE      OPDADES3,ANATDES3
            MOVE      OPDATHET,ANATTHET
.
            MOVE      "OA",CATEGORY
            MOVE      OPDAANAE,CODE
            CALL      GETCOD00
            MOVE      TDESC,ANATANAE
.
            MOVE      "OY",CATEGORY
            MOVE      OPDATYPE,CODE
            CALL      GETCOD00
            MOVE      TDESC,ANATTYPE
.
            MOVE      "OR",CATEGORY
            MOVE      OPDATRAN,CODE
            CALL      GETCOD00
            MOVE      TDESC,ANATTRAN
            PACK      KEY8,BKREBOOK,SP70
.
            CALL      RDBKRX11
            IF        OVRCD=1
              MOVE      SP70,BKRXPOWD
              MOVE      SP70,BKRXPOBD
            ENDIF
.
          ELSE
            MOVE      SP70,CURSTATS
            MOVE      SP70,CURSTATB
            MOVE      SP70,CURSTATC
            MOVE      SP70,CURSTATT
            MOVE      SP70,ANATDATE
            MOVE      SP70,ANATTIME
            MOVE      SP70,ANATEXPS
            MOVE      SP70,ANATEXPD
            MOVE      SP70,ANATTHET
            MOVE      SP70,ANATTYPE
            MOVE      SP70,ANATANAE
            MOVE      SP70,ANATTRAN
            MOVE      SP70,ANATDES1
            MOVE      SP70,ANATDES2
            MOVE      SP70,ANATDES3
            MOVE      SP70,BKRXPOWD
            MOVE      SP70,BKRXPOBD
          ENDIF
          STRIP    CURSTATS
          STRIP    CURSTATB
          STRIP    CURSTATC
          STRIP    CURSTATT
          STRIP    ANATDATE
          STRIP    ANATTIME
          STRIP    ANATEXPS
          STRIP    ANATEXPD
          STRIP    ANATTHET
          STRIP    ANATTYPE
          STRIP    ANATANAE
          STRIP    ANATTRAN
          STRIP    ANATDES1
          STRIP    ANATDES2
          STRIP    ANATDES3
          STRIP    BKRXPOWD
          STRIP    BKRXPOBD
          RETURN
.--------------------------------------------------
. Get Condition and Diet Flags
.--------------------------------------------------
GETCFL00  MATCH     SP70,ADIET
          IF        @EQUAL
            MOVE      "DC",CATEGORY
            MOVE      PMNUDIET,CODE
            CALL      GETCOD00
            MOVE      TDESC,DIETDESC
          ELSE
            MOVE      "DC",CATEGORY
            MOVE      ADIET,CODE
            CALL      GETCOD00
            MOVE      TDESC,DIETDESC
          ENDIF
.
          CALL      GETCON00                * Get Patients Current Condition
          UNPACK    IMGSRC,KEY14,CONDINDC
          MOVE      SP70,VISPHONE
          CLEAR     VISPHONE
.
          MOVE      ANSR,DIM1
          MATCH     "1",PMVXVALW
          IF        @EQUAL
            MOVE      ANSV,DIM1
          ENDIF
          APPEND    LBRACKT,VISPHONE
          APPEND    DIM1,VISPHONE
          APPEND    COMMA,VISPHONE
.
          MOVE      ANSN,DIM1
          MATCH     "1",PMVXPALW
          IF        @EQUAL
            MOVE ANSP,DIM1
          ENDIF
          APPEND    DIM1,VISPHONE
          APPEND    RBRACKT,VISPHONE
          RESET     VISPHONE
.
          CLEAR     CONLINK                 * Link for Patient Condition
          APPEND    "javascript:UpdateCondition('",CONLINK
          APPEND    URNUMBER,CONLINK
          APPEND    "','",CONLINK
          APPEND    ADMISSNO,CONLINK
          APPEND    "','",CONLINK
          APPEND    "')",CONLINK
          RESET     CONLINK
.
          REP       "#" ",ADIAG1
          REP       "#" ",ADIAG2
.
GETCFL99  RETURN
.--------------------------------------------------
. Get Last Observation
.--------------------------------------------------
GETOBS00  PACK      KEY24,ADMISSNO,Z70
          CALL      RSOBDE1
GETOBS10  CALL      RPOBDE1
          BRANCH    OVRCD,GETOBS90
          MATCH     ADMISSNO,OBDEVIST
          GOTO      GETOBS90 IF NOT EQUAL
          COMPARE   ZERO,OBDEPULS
          GOTO      GETOBS99 IF NOT EQUAL
          COMPARE   ZERO,OBDETEMP
          GOTO      GETOBS99 IF NOT EQUAL
          COMPARE   ZERO,OBDERESP
          GOTO      GETOBS99 IF NOT EQUAL
          GOTO      GETOBS10
GETOBS90  CALL      CLOBSDET
GETOBS99  RETURN
.------------------------------------------------------------
. Clear Basic Observation Details
.------------------------------------------------------------
CLOBSDET  MOVE      SP70,OBDEDATE
          MOVE      SP70,OBDETIME
          MOVE      SP70,OBDEVIST
          MOVE      SP70,OBDETYP
          MOVE      ZERO,OBDEPULS
          MOVE      ZERO,OBDETEMP
          MOVE      ZERO,OBDEBPSY
          MOVE      ZERO,OBDEBPDI
          MOVE      ZERO,OBDERESP
          MOVE      ZERO,OBDEPOX   * Pulse / Oximeter Sa O2
          MOVE      ZERO,OBDEO2F   * Oxygen Flow Litres per Min
          MOVE      ZERO,OBDEPFL   * Peak Flow
          MOVE      SP70,OBDEFOC   * Fluid Output Type (Cat wq)
          MOVE      SP70,OBDEFIC   * Fluid Intake Type (Cat wr)
          MOVE      ZERO,OBDEFOT   * Fluids Output
          MOVE      ZERO,OBDEFIN   * Fluid Intake
          MOVE      SP70,OBDEEYEO  * Eyes Open
          MOVE      SP70,OBDEVERB  * Best Verbal Response
          MOVE      SP70,OBDEMOTO  * Best Motor Response
          MOVE      SP70,OBDEPSL   * Pupil Size Left
          MOVE      SP70,OBDEPSR   * Pupil Size Right
          MOVE      SP70,OBDEPRL   * Pupil Reaction Left
          MOVE      SP70,OBDEPRR   * Pupil Reaction Right
          MOVE      SP70,OBDELMLA  * Limb Movement Left Arm
          MOVE      SP70,OBDELMRM  * Limb Movement Right Arm
          MOVE      SP70,OBDELMLL  * Limb Movement Left Leg
          MOVE      SP70,OBDELMRL  * Limb Movement Right Leg
          MOVE      SP70,OBDEACT   * Action/Comment Code (ws)
          MOVE      SP70,OBDEUY1   * User Def Y/N 1
          MOVE      SP70,OBDEUY2   * User Def Y/N 2
          MOVE      SP70,OBDEUY3   * User Def Y/N 3
          MOVE      SP70,OBDEUY4   * User Def Y/N 4
          MOVE      SP70,OBDEUC1   * User Def Code 1 (wt)
          MOVE      SP70,OBDEUC2   * User Def Code 2 (wu)
          MOVE      ZERO,OBDEUN1   * User Def Num 1
          MOVE      ZERO,OBDEUN2   * User Def Bum 2
          MOVE      ZERO,OBDEUN3   * User Def Num 3
          MOVE      ZERO,OBDEUN4   * User Def Num 4
          MOVE      SP70,OBDEUID   * Web User ID
          MOVE      SP70,OBDEMDAT  * Last Modified Date
          MOVE      SP70,OBDEMTIM  * Last Modified Time
          MOVE      SP70,OBDECOM1  * Comment 1
          MOVE      SP70,OBDECOM2  * Comment 2
          MOVE      SP70,OBDECOM3  * Comment 3
          MOVE      SP70,OBDEPNSC  * Pain Score (0-10)       * I CAR 10484
          MOVE      SP70,OBDECVPS  * CVP (1-8)               * I CAR 10485
          MOVE      SP70,OBDESPA   * Spare
.
          RETURN
+
.------------------------------------------------------------
. Display Past Medical History Comments
.------------------------------------------------------------
MCMN0000  MOVE      "015",KEY3
          PACK      KEY14,ADMISSNO,KEY3,SP70
          CALL      RSVSCMT1
MCMN1000  CALL      RKVSCMT1
          BRANCH    OVRCD,MCMN9999          * end of file
          MATCH     VSCTVIST,ADMISSNO       * same Admission Number?
          GOTO      MCMN9999 IF NOT EQUAL
          MATCH     VSCTTYPE,KEY3
          GOTO      MCMN9999 IF NOT EQUAL
          WRITE     HTMLFILE;VSCTDATA
          GOTO      MCMN1000
.
MCMN9999  RETURN
+
.------------------------------------------------------------
. Display Working Diagnosis Comments
.------------------------------------------------------------
WCMN0000  MOVE      "016",KEY3
          PACK      KEY14,ADMISSNO,KEY3,SP70
          CALL      RSVSCMT1
WCMN1000  CALL      RKVSCMT1
          BRANCH    OVRCD,WCMN9999          * end of file
          MATCH     VSCTVIST,ADMISSNO       * same Admission Number?
          GOTO      WCMN9999 IF NOT EQUAL
          MATCH     VSCTTYPE,KEY3
          GOTO      WCMN9999 IF NOT EQUAL
          WRITE     HTMLFILE;VSCTDATA
          GOTO      WCMN1000
.
WCMN9999  RETURN
+
.------------------------------------------------------------
. Display Clinical Notes Comments
.------------------------------------------------------------
CCMN0000  MOVE      "017",KEY3
          PACK      KEY14,ADMISSNO,KEY3,SP70
          CALL      RSVSCMT1
CCMN1000  CALL      RKVSCMT1
          BRANCH    OVRCD,CCMN9999          * end of file
          MATCH     VSCTVIST,ADMISSNO       * same Admission Number?
          GOTO      CCMN9999 IF NOT EQUAL
          MATCH     VSCTTYPE,KEY3
          GOTO      CCMN9999 IF NOT EQUAL
          WRITE     HTMLFILE;VSCTDATA
          GOTO      CCMN1000
.
CCMN9999  RETURN
+
.------------------------------------------------------------
. GETPMH00 - Get patient medical history
.------------------------------------------------------------
GETPMH00  PREP      PMHFILAF,PMHFILNM
          MOVE      ONE,F3
          WRITE     PMHFILAF,SEQ;QRYDATA
.
GETPMH10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETPMH90 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETPMH80 IF NOT EQUAL
          ADD       ONE,F3
          WRITE     PMHFILAF,SEQ;QRYDATA
          GOTO      GETPMH10
.
GETPMH80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETPMH90  MOVE      F3,LASTITEM
          OPEN      PMHFILAF,PMHFILNM
GETPMH99  RETURN
+
.------------------------------------------------------------
. GETWDI00 - Get working diagnosis
.------------------------------------------------------------
GETWDI00  PREP      WDIFILAF,WDIFILNM
          MOVE      ONE,F3
          WRITE     WDIFILAF,SEQ;QRYDATA
.
GETWDI10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETWDI90 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETWDI80 IF NOT EQUAL
          ADD       ONE,F3
          WRITE     WDIFILAF,SEQ;QRYDATA
          GOTO      GETWDI10
.
GETWDI80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETWDI90  MOVE      F3,LASTITM2
          OPEN      WDIFILAF,WDIFILNM
GETWDI99  RETURN
+
.------------------------------------------------------------
. GETCLN00 - Get clinical notes
.------------------------------------------------------------
GETCLN00  PREP      CLNFILAF,CLNFILNM
          MOVE      ONE,F3
          WRITE     CLNFILAF,SEQ;QRYDATA
.
GETCLN10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETCLN90 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETCLN80 IF NOT EQUAL
          ADD       ONE,F3
          WRITE     CLNFILAF,SEQ;QRYDATA
          GOTO      GETCLN10
.
GETCLN80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETCLN90  MOVE      F3,LASTITM3
          OPEN      CLNFILAF,CLNFILNM
GETCLN99  RETURN
+
.------------------------------------------------------------
.  Visit based comments
.------------------------------------------------------------
.         copy the comments back to file
.         first delete existing comments
.
VBCMN000  REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
.         Past Medical History
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMHFILAF,PMHFILNM
          TRAPCLR   IO
          BRANCH    OVRCD,VBCMN700
.
          MOVE      "015",KEY3
          PACK      KEY14,ADMISSNO,KEY3,SP70
VBCMN400  CALL      RSVSCMT1
          CALL      RKVSCMT1
          BRANCH    OVRCD,VBCMN500          * end of file
          MATCH     VSCTVIST,ADMISSNO       * same Admission Number?
          GOTO      VBCMN500 IF NOT EQUAL
          MATCH     VSCTTYPE,KEY3
          GOTO      VBCMN500 IF NOT EQUAL
.
          PACK      KEY14,VSCTVIST,VSCTTYPE,VSCTLINE
          CALL      DEVSCMT1
          GOTO      VBCMN400
.
.         now write the new comments back
.
VBCMN500  MOVE      ADMISSNO,VSCTVIST          * set Admission Number
          MOVE      KEY3,VSCTTYPE
          MOVE      ZERO,F3
.
VBCMN510  ADD       ONE,F3
          READ      PMHFILAF,SEQ;VSCTDATA
.
          MATCH     SP70,VSCTDATA
          GOTO      VBCMN600 IF NOT EQUAL
.
          IF        F3=1
            IF        F3>=LASTITEM
              GOTO      VBCMN700
            ENDIF
.
            BRANCH    F3,VBCMN510             * If first line blank ignore
          ENDIF
.
          IF        F3>=LASTITEM
            GOTO      VBCMN700
          ELSE
            GOTO      VBCMN510
          ENDIF
.
VBCMN600  MOVE      F3,VSCTLINE
          PACK      KEY14,VSCTVIST,VSCTTYPE,VSCTLINE
          CALL      WRVSCMT1
          IF        F3>=LASTITEM
            GOTO      VBCMN700
          ENDIF
          GOTO      VBCMN510
.
.         Working Diagnosis
.
VBCMN700  MOVE      "016",KEY3
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      WDIFILAF,WDIFILNM
          TRAPCLR   IO
          BRANCH    OVRCD,VBCMN800
.
          PACK      KEY14,ADMISSNO,KEY3,SP70
VBCMN710  CALL      RSVSCMT1
          CALL      RKVSCMT1
          BRANCH    OVRCD,VBCMN720          * end of file
          MATCH     VSCTVIST,ADMISSNO       * same Admission Number?
          GOTO      VBCMN720 IF NOT EQUAL
          MATCH     VSCTTYPE,KEY3
          GOTO      VBCMN720 IF NOT EQUAL
.
          PACK      KEY14,VSCTVIST,VSCTTYPE,VSCTLINE
          CALL      DEVSCMT1
          GOTO      VBCMN710
.
.         now write the new comments back
.
VBCMN720  MOVE      ADMISSNO,VSCTVIST          * set Admission Number
          MOVE      KEY3,VSCTTYPE
          MOVE      ZERO,F3
.
VBCMN730  ADD       ONE,F3
          READ      WDIFILAF,SEQ;VSCTDATA
.
          MATCH     SP70,VSCTDATA
          GOTO      VBCMN750 IF NOT EQUAL
.
          IF        F3=1
            IF        F3>=LASTITM2
              GOTO      VBCMN800
            ENDIF
.
            BRANCH    F3,VBCMN730             * If first line blank ignore
          ENDIF
.
          IF        F3>=LASTITM2
            GOTO      VBCMN800
          ELSE
            GOTO      VBCMN730
          ENDIF
.
VBCMN750  MOVE      F3,VSCTLINE
          PACK      KEY14,VSCTVIST,VSCTTYPE,VSCTLINE
          CALL      WRVSCMT1
          IF        F3>=LASTITM2
            GOTO      VBCMN800
          ENDIF
          GOTO      VBCMN730
.
.         Clinical Notes
.
VBCMN800  MOVE      "017",KEY3
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      CLNFILAF,CLNFILNM
          TRAPCLR   IO
          BRANCH    OVRCD,VBCMN999
.
          PACK      KEY14,ADMISSNO,KEY3,SP70
VBCMN810  CALL      RSVSCMT1
          CALL      RKVSCMT1
          BRANCH    OVRCD,VBCMN820          * end of file
          MATCH     VSCTVIST,ADMISSNO       * same Admission Number?
          GOTO      VBCMN820 IF NOT EQUAL
          MATCH     VSCTTYPE,KEY3
          GOTO      VBCMN820 IF NOT EQUAL
.
          PACK      KEY14,VSCTVIST,VSCTTYPE,VSCTLINE
          CALL      DEVSCMT1
          GOTO      VBCMN810
.
.         now write the new comments back
.
VBCMN820  MOVE      ADMISSNO,VSCTVIST          * set Admission Number
          MOVE      KEY3,VSCTTYPE
          MOVE      ZERO,F3
.
VBCMN830  ADD       ONE,F3
          READ      CLNFILAF,SEQ;VSCTDATA
.
          MATCH     SP70,VSCTDATA
          GOTO      VBCMN850 IF NOT EQUAL
.
          IF        F3=1
            IF        F3>=LASTITM3
              GOTO      VBCMN999
            ENDIF
.
            BRANCH    F3,VBCMN830             * If first line blank ignore
          ENDIF
.
          IF        F3>=LASTITM3
            GOTO      VBCMN999
          ELSE
            GOTO      VBCMN830
          ENDIF
.
VBCMN850  MOVE      F3,VSCTLINE
          PACK      KEY14,VSCTVIST,VSCTTYPE,VSCTLINE
          CALL      WRVSCMT1
          IF        F3>=LASTITM3
            GOTO      VBCMN999
          ENDIF
          GOTO      VBCMN830
.
VBCMN999  RETURN
+
.------------------------------------------------------------
. Display Error Message, Refresh Parent and Close Window
.------------------------------------------------------------
WINCLE00  CALL      OPENHTML
          BRANCH    EXIT,WINCLE99
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             "src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             "src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#">  ":
                             "  alert(#"",WEBTITLE,"#");":
                             " if (self.name.match(/PopUpFrame/)) {":
                             " reloadParentFrame();}":
                             " else { ":
                             "  opener.history.go(0);":
                             "  self.close(); }":
                             "</script>"
          CALL      CLOSHTML     * End of Document
WINCLE99  RETURN
.
.-----------------------------------------------------------
.        Get Patient Attributes (BMI indicator & PTARVAL3)
.-----------------------------------------------------------
PATATR00  MOVE      SP70,BMIINDIC
.
          COMPARE   ONE,NOATTRIB
          GOTO      PATATR99 IF EQUAL
.
          MATCH     SP70,URNUMBER
          GOTO      PATATR99 IF EQUAL
          GOTO      PATATR99 IF EOS
.
.         MATCH     SP70,ADMISSNO
.         GOTO      PATATR99 IF EQUAL
.         GOTO      PATATR99 IF EOS
.
          PACK      KEY35,URNUMBER,Z70
          CALL      RSPTATR1
PATATR10  CALL      RPPTATR1
          BRANCH    OVRCD,PATATR90
.
          MATCH     URNUMBER,PTARURNO
          GOTO      PATATR90 IF NOT EQUAL
.
.         MATCH     ADMISSNO,PTARVISN
.         GOTO      PATATR90 IF NOT EQUAL
.
          MATCH     "1",PTARDELR
          GOTO      PATATR10 IF EQUAL
.
          MATCH     "001",PTARTYPE
          GOTO      PATATR10 IF NOT EQUAL
.
          MOVE      "1",BMIINDIC
.
          GOTO      PATATR99
.
PATATR90  CALL      CLPATATR
PATATR99  RETURN
.
.-----------------------------------------------------------
.        Bed Management Comments
.-----------------------------------------------------------
.
BMCM0000    WRITE   HTMLFILE;"<br>Comments: ";
.
            PACK      KEY18,BMCMDIM8,SP70
            CALL      RSBKDIA1
            CALL      RKBKDIA1
            BRANCH    OVRCD,BMCM0050
.
            MATCH     BMCMDIM8,DBKDIBOO
            GOTO      BMCM0050 IF NOT EQUAL
.
            MATCH     SP70,BKDICOMM
            GOTO      BMCM0050 IF EQUAL
.
            WRITE     HTMLFILE;"<br>",BKDICOMM;
.
BMCM0050    MOVE      BMCMDIM8,KEY8                  *32 3xComment Lines
            CALL      VSCMNT00 
.
BMCM9999    RETURN
.-----------------------------------------------------------------------------
. Current Status of Patient
.-----------------------------------------------------------------------------
PATSTS00  MOVE      SP70,CURSTATS
          MOVE      SP70,CURSTATB
          MOVE      SP70,CURSTATC
          MOVE      SP70,CURSTATT
.
          COMPARE   THREE,OPDASTAT
          GOTO      PATSTS05 IF NOT EQUAL
.
          MOVE      "SC",CATEGORY
          MOVE      OPDACANC,CODE
          CALL      GETCOD00
          MATCH     ANST,TCINDC3
          IF        @EQUAL
            MOVE      "Transferred",CURSTATS
          ELSE
            MOVE      "Cancelled",CURSTATS
          ENDIF
          GOTO      PATSTS90
.
PATSTS05  CALL      CLOPRARD
          PACK      KEY10,OPDAUNIQ,SP70
          CALL      RDOPARD1
          BRANCH    OVRCD,PATSTS90
.
          PACK      KEY11,OPDAUNIQ,ONE,SP70
          CALL      RDOPSRG1
          IF        OVRCD=1
            CALL      CLOPRSRG
          ENDIF
.
          MATCH     SP70,OPARATIM
          IF        !@EQUAL
            MATCH     "1",OPSGUY05
            IF        @EQUAL
              MOVE      "Abandoned",CURSTATS
            ELSE
              MOVE      "Holding",CURSTATS
            ENDIF
          ENDIF
.
          MATCH     SP70,OPARANAS
          IF        !@EQUAL
            MATCH     "1",OPSGUY05
            IF        @EQUAL
              MOVE      "Abandoned",CURSTATS
            ELSE
              MOVE      "Anaes",CURSTATS
            ENDIF
          ENDIF
.
          PACK      CURSTATC,OPARUC03,SP70
.
          MATCH     SP70,OPARUC03
          IF        !@EQUAL
            SQUEEZE   OPARUC03
            PACK      CURSTATB,LBRACK,OPARUC03,RBRACK,SP70
            RESET     OPARUC03
          ENDIF
.
PATSTS10  CALL      CLOPRSRG
          PACK      KEY11,OPDAUNIQ,ONE,SP70
          CALL      RDOPSRG1
          BRANCH    OVRCD,PATSTS90
.
          MATCH     SP70,OPSGTIPS
          IF        !@EQUAL
            MATCH     "1",OPSGUY05
            IF        @EQUAL
              MOVE      "Abandoned",CURSTATS
            ELSE
              MOVE      "Theatre",CURSTATS
            ENDIF
          ENDIF
.
          MATCH     SP70,OPARTIRF
          IF        !@EQUAL
            MOVE      "Recovery-Front",CURSTATS
          ENDIF
.
          MATCH     SP70,OPARTIRB
          IF        !@EQUAL
            MOVE      "Recovery-Back",CURSTATS
          ENDIF
.
          MATCH     SP70,OPARTIRD
          IF        !@EQUAL
            MOVE      "Recovery-Day",CURSTATS
          ENDIF
.
          MATCH     SP70,OPARTIDP 
          IF        !@EQUAL
            MOVE      "Ready To Depart",CURSTATS
          ENDIF
.
          MATCH     SP70,OPARTETC
          IF        !@EQUAL
            MOVE      "Exit",CURSTATS
          ENDIF
.
          MATCH     SP70,OPARTICU
          IF        !@EQUAL
            MOVE      "ICU",CURSTATS
          ENDIF
.
PATSTS90  MATCH     SP70,OPARTEXP
          IF        !@EQUAL
            MATCH     SP70,CURSTATS              * Is current status blank?
            IF        @EQUAL
              MOVE      "Deceased",CURSTATS      * Yes, set status to "Deceased"
            ELSE
              MOVE      CURSTATS,DIM15           * No, save current status
              PACK      CURSTATS,STAPRFIX,DIM15  * Build new status with prefix
            ENDIF
          ENDIF
.
          MATCH     SP70,CURSTATS           * Theatre status blank?
          GOTO      PATSTS99 IF EQUAL
.
          MATCH     "1",OPCNTHED            * Display theatre location/banner
          IF        @EQUAL
            PACK      KEY6,OPDATHET,SP70
            CALL      RDOPOPR1
            IF         OVRCD<>1
              MOVE      OPRMDESC,CURSTATT
              STRIP     CURSTATT
            ENDIF
          ENDIF
.
PATSTS99  RETURN
.
.------------------------------------------------------------
. Patient Level Nutrition Maintenance
.------------------------------------------------------------
.
NUTR0000  PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,NUTR9100
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          BRANCH    OVRCD,NUTR9100
.
          MATCH     SP70,UPDATETY
          GOTO      NUTR8000 IF EQUAL
.
          MATCH     "A",UPDATETY
          GOTO      NUTR1000 IF EQUAL
.
          GOTO      NUTR9000
.
NUTR1000  PACK      KEY16,PMNUT001,PMNUT002,SP70
          CALL      RDPMNUT1                  * Read nutrition record
          IF        OVRCD=1
            CALL      CLRNUT00
          ENDIF
.
          CALL      MVNUT000                  * Move CGIs into record vars.
.
          CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          CLOCK     TIME,CTIMEIS              * Set update timestamp and userid
          PACK      PMNUUPDU,WBSEUID,SP70
          PACK      PMNUUPDD,CURRDATE,CTIMEIS
.
          PACK      KEY16,PMNUADMN,PMNUDATE,SP70
          CALL      RAPMNUT1                  * Is nutrition record there ?
          BRANCH    OVRCD,NUTR1100
.
          CALL      UPPMNUT1 
          GOTO      NUTR1500
.
NUTR1100  MOVE      PMNUUPDU,PMNUCRTU         * No - set up create t/stamp
          MOVE      PMNUUPDD,PMNUCRTD         *      and userid
          CALL      WRPMNUT1                  *      then write record
.
NUTR1500  PACK      KEY8,PMNUADMN,SP70
          CALL      RDBKREC1                  * Read booking
          BRANCH    OVRCD,NUTR1700
.
          COMPARE   ZERO,OBASTAT              * Booked only
          GOTO      NUTR1700 IF NOT EQUAL
.
          PACK      KEY8,PMNUADMN,SP70
          CALL      RDBKRX11
          BRANCH    OVRCD,NUTR1700
.
          MOVE      PMNUDIET,BKRXDIET         * Update booking diet
.
          CALL      UPBKRX11
          GOTO      NUTR1950
.
NUTR1700  PACK      KEY8,PMNUADMN,SP70
          CALL      RDMISS1  
          BRANCH    OVRCD,NUTR1950
.
          COMPARE   ONE,ASTAT                 * Pre admission only
          GOTO      NUTR1950 IF NOT EQUAL
.
          MOVE      PMNUDIET,ADIET            * Update pre admission diet
.
          CALL      UPMISS1
.
          CALL      PMIGTNID                  * get national id
          MOVE      NMPNUMB,PTNINMPI
          MOVE      THREE,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICCP                  * broadcast pre adm update
          GOTO      NUTR1950
.
NUTR1950  MOVE      ZERO,EXIT
          GOTO      NUTR9999
.
NUTR8000  CALL      CURPER00
          CALL      CALCDT00
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDVISA1                 * Read visit
          IF        OVRCD=1
            CALL      RDBKREC1
            BRANCH    OVRCD,NUTR9200
.
            COMPARE   ZERO,BKRESTAT          * Booking with a status booked
            GOTO      NUTR9500 IF NOT EQUAL
.
            GOTO      NUTR8500
          ENDIF
.
          COMPARE   THREE,PVITYPE           * IP visits only
          GOTO      NUTR9300 IF NOT EQUAL     
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1                 * Read admission
          BRANCH    OVRCD,NUTR9200
.
          COMPARE   "5",ASTAT               * Cancelled admission
          GOTO      NUTR9400 IF EQUAL 
.
NUTR8500  PACK      KEY16,PMNUT001,PMNUT002,SP70
          CALL      RDPMNUT1                     * Read nutrition table
          IF        OVRCD=1
            CALL      CLPMSNUT
          ENDIF
.
          MOVE      "Visit Nutrition Details", WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,NUTR9999
.
          CALL      WEBBOD00   * Output Templated Body of HTML
          CALL      WEBEND00   * Output End of Web Page
          MOVE      ONE,EXIT
          GOTO      NUTR9999
.
NUTR9000  MOVE      "Invalid Update Type",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NUTR9999
.
NUTR9100  MOVE      "Invalid U/R Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NUTR9999
.
NUTR9200  MOVE      "Invalid Visit Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NUTR9999
.
NUTR9300  CLEAR     WEBTITLE
          APPEND    "Nutrition details only available for ",WEBTITLE
          APPEND    "inpatient visits",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NUTR9999
.
NUTR9400  MOVE      "Visit is cancelled, no nutrition data available",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NUTR9999
.
NUTR9500  MOVE      "Invalid booking status - Booked only",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NUTR9999
.
NUTR9999  RETURN
.
.------------------------------------------------------------
. Nutrition list for an IP visit
.------------------------------------------------------------
NUTL0000  CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD     * Current date
          REP       " 0",CURRDATE
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1                      * Read admission
          MOVE      OVRCD,MISSFLAG
          COMPARE   ONE,OVRCD     
          GOTO      NUTL0500 IF NOT EQUAL
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDBKREC1
          BRANCH    OVRCD,NUTL9999
.
NUTL0500  PACK      KEY16,ADMISSNO,Z70
          CALL      RSPMNUT1
NUTL1000  CALL      RPPMNUT1
          BRANCH    OVRCD,NUTL9999
.
          MATCH     ADMISSNO,PMNUADMN
          GOTO      NUTL9999 IF NOT EQUAL
.
          MOVE      ZERO,EDITFLAG                // No Maintenance icon
          MOVE      SP70,DISPDATE                // Clear date 
          MOVE      SP70,MEALDATE                // Clear meal date
.
          IF        BKRESTAT=0 & MISSFLAG=1
            MATCH     SP70,PMNUDATE              // Booking
            GOTO      NUTL1000 IF NOT EQUAL
.
            MOVE      ONE,EDITFLAG               // Show Maintenance icon
            MOVE      "Booked",MEALDATE
          ENDIF
.
          IF        ASTAT=1 & MISSFLAG<>1
            MATCH     SP70,PMNUDATE              // Pre admission
            GOTO      NUTL1000 IF NOT EQUAL
.
            MOVE      ONE,EDITFLAG               // Show Maintenance icon
            MOVE      "Preadmission",MEALDATE
          ENDIF
.
          IF        ASTAT=2 & MISSFLAG<>1
            MATCH     CURRDATE,PMNUDATE          // Current admission
            IF        !@LESS
              MOVE      ONE,EDITFLAG             // Show Maintenance icon
            ENDIF                                // for current date only
          ENDIF
.
          IF        ASTAT=3 & MISSFLAG<>1
            MOVE     ZERO,EDITFLAG               // No Maintenance icon
          ENDIF                                  // when discharged
.
          MATCH     SP70,PMNUDATE
          IF        !@EQUAL
            UNPACK    PMNUDATE,CCENT,CYEAR,CMON,CDAY
            CALL      DAYOFWEK
            LOAD      DAYNAM3,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      MEALDATE,DAYNAM3,SP1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ELSE
            IF        MISSFLAG<>1
              MOVE      "Preadmission",MEALDATE
            ELSE
              MOVE      "Booked",MEALDATE
            ENDIF
          ENDIF
.
          MOVE      "DC",CATEGORY                // Diet
          MOVE      PMNUDIET,CODE
          CALL      GETCOD00
          MOVE      TDESC,DIETDESC
.
          MOVE      SP70,DTFASTNG                // Fasting
          MATCH     "1",PMNUFAST
          IF        @EQUAL
            MOVE      "Yes",DTFASTNG       
          ENDIF
.
          MOVE      CATMJ,CATEGORY               // Diet Type
          MOVE      PMNUDTYP,CODE
          CALL      GETCOD00
          MOVE      TDESC,DTDTTYPE
.
          MOVE      SP70,DOCFNAME               // Dietician
          MATCH     PMNUDCDE,SP10
          IF        !@EQUAL 
            PACK      KEY10,PMNUDCDE
            CALL      RDPMHCP1
            IF        OVRCD<>1        
              MOVE      PMHCTITL,FMTTITLE
              MOVE      PMHCGNAM,FMTGNAME
              MOVE      PMHCSNAM,FMTSNAME
              CALL      DOCNM000
            ENDIF
          ENDIF
.
          MOVE      CATMJ,CATEGORY               // Meal 1
          MOVE      PMNUML01,CODE
          CALL      GETCOD00
          MOVE      TDESC,DESCML01
.
          MOVE      CATMM,CATEGORY               // Meal 2
          MOVE      PMNUML02,CODE
          CALL      GETCOD00
          MOVE      TDESC,DESCML02
.
          MOVE      CATMJ,CATEGORY               // Meal 3
          MOVE      PMNUML03,CODE
          CALL      GETCOD00
          MOVE      TDESC,DESCML03
.
          MOVE      CATMM,CATEGORY               // Meal 4
          MOVE      PMNUML04,CODE
          CALL      GETCOD00
          MOVE      TDESC,DESCML04
.
          MOVE      CATMJ,CATEGORY               // Meal 5
          MOVE      PMNUML05,CODE
          CALL      GETCOD00
          MOVE      TDESC,DESCML05
.
          MOVE      CATMM,CATEGORY               // Meal 6
          MOVE      PMNUML06,CODE
          CALL      GETCOD00
          MOVE      TDESC,DESCML06
.
          MOVE      CATMJ,CATEGORY               // Meal 7
          MOVE      PMNUML07,CODE
          CALL      GETCOD00
          MOVE      TDESC,DESCML07
.
          PACK      CREATEDB,SP70,SP70
          MATCH     SP70,PMNUCRTU                // Created By
          GOTO      NUTL2000 IF EQUAL
.
          MATCH     SP70,PMNUCRTD                // Created date and time
          GOTO      NUTL2000 IF EQUAL
.
          PACK      KEY10,PMNUCRTU,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      PMNUCRTU,WBSENAM
          ENDIF
.
          UNPACK    PMNUCRTD,TEMPDATE,TEMPTIME   // Created date and time
.
          UNPACK    TEMPDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          CLEAR     CREATEDB
          APPEND    "Created ",CREATEDB
          APPEND    DISPDATE,CREATEDB
          APPEND    " @ ",CREATEDB
          APPEND    TEMPTIME,CREATEDB
          APPEND    " by ",CREATEDB
          APPEND    WBSENAM,CREATEDB
          RESET     CREATEDB
.
NUTL2000  PACK      UPDATEDB,SP70,SP70
          MATCH     SP70,PMNUUPDU                // Updated By
          GOTO      NUTL3000 IF EQUAL
.
          MATCH     SP70,PMNUUPDD                // Updated date and time
          GOTO      NUTL3000 IF EQUAL
.
          PACK      KEY10,PMNUUPDU,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      PMNUUPDU,WBSENAM
          ENDIF
.
          UNPACK    PMNUUPDD,TEMPDATE,TEMPTIME   // Created date and time
.
          UNPACK    TEMPDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          CLEAR     UPDATEDB
          APPEND    "Updated ",UPDATEDB
          APPEND    DISPDATE,UPDATEDB
          APPEND    " @ ",UPDATEDB
          APPEND    TEMPTIME,UPDATEDB
          APPEND    " by ",UPDATEDB
          APPEND    WBSENAM,UPDATEDB
          RESET     UPDATEDB
.         
NUTL3000  CLEAR     HTMLLINK
          APPEND    "javascript:UpdateNutrition('",HTMLLINK
          APPEND    URNUMBER,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMNUADMN,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMNUDATE,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":           * 0
                             "#"",EDITFLAG,"#",":                    * 1
                             "#"",MEALDATE,"#",":                    * 2
                             "#"",DIETDESC,"#",":                    * 3
                             "#"",DTFASTNG,"#",":                    * 4
                             "#"",DTDTTYPE,"#",":                    * 5
                             "#"",DOCFNAME,"#",":                    * 6
                             "#"",PMNUCOM1,"<br>":                   * 7
                                  PMNUCOM2,"<br>":
                                  PMNUCOM3,"<br>":
                                  PMNUCOM4,"<br>":
                                  PMNUCOM5,"#",":
                             "#"",DESCML01,"<br>":                   * 8
                                  DESCML02,"<br>":
                                  DESCML03,"<br>":
                                  DESCML04,"<br>":
                                  DESCML05,"<br>":
                                  DESCML06,"<br>":
                                  DESCML07,"#",":                    
                             "#"",CREATEDB,"<br>",UPDATEDB,"#",":    *9
                             "#"",DIETDESC,"<br>":                   *10
                                  DESCML01,"<br>":
                                  DESCML03,"<br>":
                                  DESCML05,"<br>":
                                  DESCML07,"#",": 
                             "#"","B-",PMNUBSUP,"<br>":                     *11
                                  "M-",PMNUMSUP,"<br>":
                                  "L-",PMNULSUP,"<br>":
                                  "A-",PMNUASUP,"<br>":
                                  "D-",PMNUDSUP,"<br>":
                                  "S-",PMNUSSUP,"#",":
                             "#"",PMNUDATE,"#"":
                             ");"
.
          GOTO      NUTL1000

.
NUTL9999  RETURN
.------------------------------------------------------------
. General tags
.------------------------------------------------------------
GTAG0000  BRANCH    FLDITMNO,GTAG0010,GTAG0020
.
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      GTAG9999
.
GTAG0010  CALL      NUTL0000          * Nutrition list for an IP visit
          GOTO      GTAG9999
.
GTAG0020  WRITE     HTMLFILE;DEFTVIEW;      * Default table sort view
          GOTO      GTAG9999
.
GTAG9999  RETURN
+
.------------------------------------------------------------------------------
. Update Patient Attribute Coded Field value
.------------------------------------------------------------------------------
UPCVAL00  MOVE      QRYDATA,ATCODVAL
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,ATTYPIND
          MOVE      "1",ATCODIND       * Coded Field 1
.
          MOVE      URNUMBER,PTATR001
          MOVE      ADMISSNO,PTATR002
          CALL      UPDACV00
.
UPCVAL99  RETURN
+
.------------------------------------------------------------------------------
. Save Patient Attribute text into temp file; KEY3 determines Attribute Type
.------------------------------------------------------------------------------
SAVATF00  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,ATTYPIND
.
          BRANCH    ATTYPIND,SAVATF99,SAVATF20,SAVATF30,SAVATF40
          GOTO      SAVATF99
.
SAVATF20  CALL      TFILENAM           * Get temp file name
          MOVE      TFILNAME,ATWDIAFN  * Save as 'Working Diagnosis' filename
          MOVE      ATWDIAFN,ATTMPFIL
          GOTO      SAVATF90
.
SAVATF30  CALL      TFILENAM           * Get temp file name
          MOVE      TFILNAME,ATMHISFN  * Save as 'Relevant Medical History'
          MOVE      ATMHISFN,ATTMPFIL
          GOTO      SAVATF90
.
SAVATF40  CALL      TFILENAM           * Get temp file name
          MOVE      TFILNAME,ATBDISFN  * Save as 'Barriers to Discharge'
          MOVE      ATBDISFN,ATTMPFIL
          GOTO      SAVATF90
.
SAVATF90  CALL      GETATN00           * Write notes to temp file
          GOTO      SAVATF99
.
SAVATF99  RETURN
+
.*******************************************************************************
. Get Attribute Notes from Text Area (cgi) and write to temp file
.*******************************************************************************
GETATN00  PREP      ATTMPFAF,ATTMPFIL
          MOVE      ONE,F3
          WRITE     ATTMPFAF,SEQ;QRYDATA
.
GETATN10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETATN90 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETATN80 IF NOT EQUAL
.
          MATCH     SP70,QRYDATA
          GOTO      GETATN11 IF NOT EQUAL
          GOTO      GETATN11 IF NOT EOS
.
          PACK      DIM80,SP70,SP70
          MOVE      DIM80,QRYDATA                * write blank line to file
.
GETATN11  ADD       ONE,F3
          WRITE     ATTMPFAF,SEQ;QRYDATA
.
          GOTO      GETATN10
.
GETATN80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETATN90  OPEN      ATTMPFAF,ATTMPFIL
GETATN99  RETURN
+
.------------------------------------------------------------------------------
.   Read Patient Attribute notes (max 3 lines) from temp file and move them to
.   corresponding Patient Attribute work vars.
.------------------------------------------------------------------------------
MOVATF00  MOVE      ZERO,F3
          MOVE      SP70,PTATR014
          MOVE      SP70,PTATR015
          MOVE      SP70,PTATR016
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      ATTMPFAF,ATTMPFIL
          TRAPCLR   IO
          BRANCH    OVRCD,MOVATF99
.
MOVATF10  ADD       ONE,F3
          COMPARE   F3,THREE
          GOTO      MOVATF99 IF LESS
.
          READ      ATTMPFAF,SEQ;DIM80
          GOTO      MOVATF99 IF OVER
          STORE     DIM80,F3,PTATR014,PTATR015,PTATR016
.
          GOTO      MOVATF10
.
MOVATF99  RETURN
+
.------------------------------------------------------------------------------
. Show expected post op patients and bed requests for the selected ward view
.------------------------------------------------------------------------------
EXPT0000  PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,EXPT9999
. 
          CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          COMPARE   ONE,TOGGLEXP            * Displaying expected patients
          GOTO      EXPT0500 IF NOT EQUAL

          WRITE     HTMLFILE;"<tr><td class=HeadingCell>Patient</td>":
                             "<td class=HeadingCell>":
                             "Post Op/Bed Request Ward/Bed</td>":
                             "<td class=HeadingCell>Adm Date</td>":
                             "<td class=HeadingCell>Exp Los</td>":
                             "<td class=HeadingCell>Attending Doctor</td>":
                             "<td class=HeadingCell>Theatre Status</td>":
                             "<td class=HeadingCell>Recovery Bay</td>":
                             "</tr>"
.
EXPT0500  PACK      KEY9,TWO,SP70
          CALL      RDSMISS2
EXPT1000  CALL      RDKMISS2                * Check admissions for post op ward
          BRANCH    OVRCD,EXPT5000
.
          COMPARE   TWO,ASTAT               * Admitted only
          GOTO      EXPT5000 IF NOT EQUAL
.
          MATCH     AWARD,WARDCODE          * Already admitted to this ward
          GOTO      EXPT1000 IF EQUAL
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDVISA1                 * Read visit
          BRANCH    OVRCD,EXPT1000
.
          MOVE      ONE,EXPTTYPE            * Admission
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPMVX11                * read visit extn
          BRANCH    OVRCD,EXPT1000
.
          MATCH     PMVXPOWD,WARDCODE       * Correct post op ward
          GOTO      EXPT2000 IF EQUAL
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDBKRX11                * read booking extn
          BRANCH    OVRCD,EXPT1000
.
          MATCH     BKRXPOWD,WARDCODE       * Correct post op ward
          GOTO      EXPT1000 IF NOT EQUAL
.
          MOVE      THREE,EXPTTYPE          * Admission/Booking
.
EXPT2000  MOVE      "2",KEY1
          PACK      KEY31,DAADMNO,KEY1,CURRDATE,Z70
          CALL      RSOPDEA2
          CALL      RPOPDEA2                     * read Theatre Booking
          BRANCH    OVRCD,EXPT1000
.
          MATCH     OPDAADMN,DAADMNO
          GOTO      EXPT1000 IF NOT EQUAL
.
          COMPARE   TWO,OPDASTAT                 * Theatre status admitted
          GOTO      EXPT1000 IF NOT EQUAL
.
          MATCH     CURRDATE,OPDADATE            * Skip if not theatre today
          GOTO      EXPT1000 IF NOT EQUAL
.
          MOVE      AURNO,URNUMBER          * Populate U/R
          MOVE      AADMNO,ADMISSNO         * Populate Visit
.
          CALL      EXPR0000                * Display row
          GOTO      EXPT1000
.
EXPT5000  PACK      KEY24,CURRDATE,SP70
          CALL      RSPMBRQ3                * Todays bed requests
EXPT6000  CALL      RKPMBRQ3
          BRANCH    OVRCD,EXPT9999
.
          MATCH     CURRDATE,PMBRREQD
          GOTO      EXPT9999 IF NOT EQUAL
.
          MATCH     "1",PMBRRSTA              * Requested
          IF        !@EQUAL
            MATCH     "2",PMBRRSTA            * Allocated
            GOTO      EXPT6000 IF NOT EQUAL
          ENDIF
.
          MATCH     PMBREWRD,WARDCODE         * Expected ward
          GOTO      EXPT6000 IF NOT EQUAL
.
          PACK      KEY8,PMBRVISN,SP70
          CALL      RDMISS1                   * Read admission
          BRANCH    OVRCD,EXPT6000
.
          PACK      KEY8,PMBRVISN,SP70
          CALL      RDVISA1                   * Read visit
          BRANCH    OVRCD,EXPT6000
.
          PACK      KEY8,PMBRVISN,SP70
          CALL      RDPMVX11                  * Read visit extn
          BRANCH    OVRCD,EXPT6000
.
          MOVE      PVIURNO,URNUMBER        * Populate U/R
          MOVE      PVIBILL,ADMISSNO        * Populate Visit
.
          MOVE      TWO,EXPTTYPE            * Bed Request
          CALL      EXPR0000                * Display row
          GOTO      EXPT6000
.
EXPT9999  RETURN
+
.------------------------------------------------------------------------------
. Show expected post op patients and bed requests row
.------------------------------------------------------------------------------
EXPR0000  ADD       ONE,NUMBREXP            * Number of expected patients count
.
          COMPARE   ONE,TOGGLEXP            * Displaying expected patients
          GOTO      EXPR9999 IF NOT EQUAL
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,EXPR9999
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,EXPR9999
.
          CALL      PATINT00
.
          IF        PCEASE=1
            MOVE      PDECDTE,AGEDATE            * Date of Death
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE
          CALL      PATLN000

          CALL      PATFLD00                * Use standard Patient Folder sub
          MOVE      KEY3,FOLDERSF           * and store suffix
.
          CALL      GETAN000                * get Anaesthetist
          MOVE      SP70,CURSTATS
          MOVE      SP70,CURSTATB
          MOVE      SP70,CURSTATC
.
          IF        ANATFLAG = 1
            CALL      PATSTS00                * get theatre status
          ENDIF
.
          UNPACK    PVIDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MOVE      SP70,DOCFNAME
          PACK      KEY6,PVIDOCT,SP70
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000
            PACK      SDOCFNAM,DOCFNAME
          ENDIF
.
          MOVE      SP70,POSTWBED
          IF        EXPTTYPE=2
            MOVE      PMBREWRD,PMVXPOWD
            MOVE      PMBREBED,PMVXPOBD
          ENDIF
.
          IF        EXPTTYPE=3
            MOVE      BKRXPOWD,PMVXPOWD       * Use post OP ward/bed from
            MOVE      BKRXPOBD,PMVXPOBD       * booking
            MOVE      ONE,EXPTTYPE
          ENDIF
.
          MATCH     SP70,PMVXPOWD
          IF        !@EQUAL
            PACK      KEY6,PMVXPOWD,PMVXPOBD,SP70
            CALL      RDWARD1
            BRANCH    OVRCD,EXPR2000
.
            CLEAR     POSTWBED
            MATCH     ZEROVISN,WADMNO
            IF        !@EQUAL
              APPEND    BODMASFT,POSTWBED
            ENDIF
.
            IF        EXPTTYPE=2
              APPEND    LABREQST,POSTWBED
            ENDIF
.
            APPEND    PMVXPOWD,POSTWBED
.
            MATCH     SP70,PMVXPOBD
            IF        !@EQUAL
              APPEND    FRBRACK,POSTWBED
              APPEND    PMVXPOBD,POSTWBED
            ENDIF
.
            MATCH     ZEROVISN,WADMNO
            IF        !@EQUAL
              APPEND    ENDFONT,POSTWBED
            ENDIF
.
            RESET     POSTWBED
          ENDIF
.
EXPR2000  WRITE     HTMLFILE;"<tr><td height=25>":
                             "<img src=../images/PatientFolder",FOLDERSF,".gif":
                             " class=ListIcon ":
                             " onclick='location.href=#"patweb98.pbl":
                             "?reportno=01&template=001":
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO,"#";'>":
                             FORMATNM,"</td>":
                             "<td>",POSTWBED,"</td>":
                             "<td>",DISPDATE,"</td>":
                             "<td>",ASTAY,"</td>":
                             "<td>",DOCFNAME,"</td>":
                             "<td>",CURSTATS,"</td>":
                             "<td>",CURSTATC,"</td>":
                             "</tr>"
.
EXPR9999  RETURN
.
+
.------------------------------------------------------------------------------
. Show expected post op patients and bed requests for the map view
.------------------------------------------------------------------------------
MEXP0000  MATCH     SP70,WARDCODE           * Exit if no ward code
          GOTO      MEXP9999 IF EQUAL
.
          CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,MEXP9999
.
          PACK      KEY9,TWO,SP70
          CALL      RDSMISS2
MEXP1000  CALL      RDKMISS2                * Check admissions for post op ward
          BRANCH    OVRCD,MEXP5000
.
          COMPARE   TWO,ASTAT               * Admitted only
          GOTO      MEXP5000 IF NOT EQUAL
.
          MATCH     AWARD,WARDCODE          * Already admitted to this ward
          GOTO      MEXP1000 IF EQUAL
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDVISA1                 * Read visit
          BRANCH    OVRCD,MEXP1000
.
          MOVE      ONE,EXPTTYPE            * Admission
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPMVX11                * read visit extn
          BRANCH    OVRCD,MEXP1000
.
          MATCH     PMVXPOWD,WARDCODE       * Correct post op ward
          GOTO      MEXP2000 IF EQUAL
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDBKRX11                * read booking extn
          BRANCH    OVRCD,MEXP1000
.
          MATCH     BKRXPOWD,WARDCODE       * Correct post op ward
          GOTO      MEXP1000 IF NOT EQUAL
.
          MOVE      THREE,EXPTTYPE            * Admission/booking
.
MEXP2000  MOVE      "2",KEY1
          PACK      KEY31,DAADMNO,KEY1,CURRDATE,Z70
          CALL      RSOPDEA2
          CALL      RPOPDEA2                     * read Theatre Booking
          BRANCH    OVRCD,MEXP1000
.
          MATCH     OPDAADMN,DAADMNO
          GOTO      MEXP1000 IF NOT EQUAL
.
          COMPARE   TWO,OPDASTAT                 * Theatre status admitted
          GOTO      MEXP1000 IF NOT EQUAL
.
          MATCH     CURRDATE,OPDADATE            * Skip if not theatre today
          GOTO      MEXP1000 IF NOT EQUAL
.
          MOVE      AURNO,URNUMBER          * Populate U/R
          MOVE      AADMNO,ADMISSNO         * Populate Visit
.
          CALL      MEXR0000                * Display row
          GOTO      MEXP1000
.
MEXP5000  PACK      KEY24,CURRDATE,SP70
          CALL      RSPMBRQ3                * Todays bed requests
MEXP6000  CALL      RKPMBRQ3
          BRANCH    OVRCD,MEXP9999
.
          MATCH     CURRDATE,PMBRREQD
          GOTO      MEXP9999 IF NOT EQUAL
.
          MATCH     "1",PMBRRSTA              * Requested
          IF        !@EQUAL
            MATCH     "2",PMBRRSTA            * Allocated
            GOTO      MEXP6000 IF NOT EQUAL
          ENDIF
.
          MATCH     PMBREWRD,WARDCODE         * Expected ward
          GOTO      MEXP6000 IF NOT EQUAL
.
          PACK      KEY8,PMBRVISN,SP70
          CALL      RDMISS1                   * Read admission
          BRANCH    OVRCD,MEXP6000
.
          PACK      KEY8,PMBRVISN,SP70
          CALL      RDVISA1                   * Read visit
          BRANCH    OVRCD,MEXP6000
.
          PACK      KEY8,PMBRVISN,SP70
          CALL      RDPMVX11                  * Read visit extn
          BRANCH    OVRCD,MEXP6000
.
          MOVE      PVIURNO,URNUMBER        * Populate U/R
          MOVE      PVIBILL,ADMISSNO        * Populate Visit
.
          MOVE      TWO,EXPTTYPE            * Bed Request
          CALL      MEXR0000                * Display row
          GOTO      MEXP6000
.
MEXP9999  RETURN
+
.------------------------------------------------------------------------------
. Show expected post op patient and bed request rows for map view
.------------------------------------------------------------------------------
MEXR0000  PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,MEXR9999
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,MEXR9999
.
          CALL      PATINT00
.
          IF        PCEASE=1
            MOVE      PDECDTE,AGEDATE            * Date of Death
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE
          CALL      PATLN000

          CALL      PATFLD00                * Use standard Patient Folder sub
          MOVE      KEY3,FOLDERSF           * and store suffix
.
          CALL      GETAN000                * get Anaesthetist
          MOVE      SP70,CURSTATS
          MOVE      SP70,CURSTATB
          MOVE      SP70,CURSTATC
.
          IF        ANATFLAG = 1
            CALL      PATSTS00                * get theatre status
          ENDIF
.
          UNPACK    PVIDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MOVE      SP70,DOCFNAME
          PACK      KEY6,PVIDOCT,SP70
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000
            PACK      SDOCFNAM,DOCFNAME
          ENDIF
.
          MOVE      SP70,POSTWBED
          IF        EXPTTYPE=2
            MOVE      PMBREWRD,PMVXPOWD
            MOVE      PMBREBED,PMVXPOBD
          ENDIF
.
          IF        EXPTTYPE=3
            MOVE      BKRXPOWD,PMVXPOWD       * Use post OP ward/bed from
            MOVE      BKRXPOBD,PMVXPOBD       * booking
            MOVE      ONE,EXPTTYPE
          ENDIF
.
          MATCH     SP70,PMVXPOWD
          IF        !@EQUAL
            PACK      KEY6,PMVXPOWD,PMVXPOBD,SP70
            CALL      RDWARD1
            BRANCH    OVRCD,MEXR2000
.
            CLEAR     POSTWBED
.
            APPEND    PMVXPOWD,POSTWBED
.
            MATCH     SP70,PMVXPOBD
            IF        !@EQUAL
              APPEND    FRBRACK,POSTWBED
              APPEND    PMVXPOBD,POSTWBED
            ENDIF
.
            RESET     POSTWBED
          ENDIF
.
          MOVE      "DC",CATEGORY
          MOVE      ADIET,CODE
          CALL      GETCOD00
          MOVE      TDESC,DIETDESC
.
          CALL      GETCON00               * Get Patient Condition Details
          UNPACK    IMGSRC,KEY10,CONDINDC
.
MEXR2000  WRITE     HTMLFILE;*+,"t.AddExpected(#"",URNUMBER,"#",":        * 0
                             "#"",ADMISSNO,"#",":
                             "#"",FORMATNM,"#",":
                             "#"",PSEX,"#",":
                             "#"";
          CALL      WRTAGE00
.
          WRITE     HTMLFILE;*+,"#",":
                             "#"",FOLDERSF,"#",":                         * 5 
                             "#"",PTMXSIN1,PTMXSIN2,PTMXSIN3,PTMXSIN4:
                                  PTMXSIN5,"#",":
                             "#"",LPCONDD,"#",":
                             "#"",CONDINDC,"#",":
                             "#"",CONDESC,"#",":
                             "#"",LPCDATE,LPCTIME,"#",":                  * 10
                             "#"",DIETDESC,"#",":
                             "#"",POSTWBED,"#",":
                             "#"",PMVXPOWD,"#",":
                             "#"",PMVXPOBD,"#",":
                             "#"",DISPDATE,"#",":                         * 15
                             "#"",ADOCTA,"#",":
                             "#"",EXPTTYPE,"#",":
                             "#"",ASTAY,"#",":
                             "#"",AWARD,"#",":
                             "#"",DOCFNAME,"#",":                         * 20
                             "#"",CURSTATS,"#",":                         
                             "#"",CURSTATC,"#");"
.
MEXR9999  RETURN
+
.------------------------------------------------------------
. Eclipse IMC Remittance Advice Enquiries
.------------------------------------------------------------
ECRM0000  MATCH     "1",PTCNWSIN
          GOTO      ECRM9300 IF NOT EQUAL
.
          MATCH     "1",PTCNIMCW
          GOTO      ECRM9300 IF NOT EQUAL
.
          RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      ECRM5000 IF EQUAL
.
          MATCH     "R",UPDATETY
          GOTO      ECRM4000 IF EQUAL
.
          MATCH     "D",UPDATETY
          GOTO      ECRM3000 IF EQUAL
.
          MATCH     "L",UPDATETY
          GOTO      ECRM2000 IF EQUAL
.
          MATCH     "P",UPDATETY
          GOTO      ECRM1000 IF EQUAL
.
          MATCH     "C",UPDATETY
          GOTO      ECRM7000 IF EQUAL
.
          GOTO      ECRM9000
.
ECRM1000  MOVE      "1",DIM1C
          CALL      PRNRMM00
          MOVE      "Print ERAW Remittance Report scheduled.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ECRM9999
.
ECRM2000  CALL      CREA0000
          CALL      RPAM0000
          CALL      KILL0000
          GOTO      ECRM9999
.
ECRM3000  PACK      KEY61,HOSPCODE,FUNDTRID,ECREADVC,ECREPTNO,SP70
          CALL      RDWBERH1
          BRANCH    OVRCD,ECRM9100
.
          PACK      KEY82,FUNDTRID,ECREADVC,ECREPTNO,ECRETRID,SP70
          CALL      RDWBERD1
          BRANCH    OVRCD,ECRM9200
.
          GOTO      ECRM6000
.
ECRM4000  PACK      KEY61,HOSPCODE,FUNDTRID,ECREADVC,ECREPTNO,SP70
          CALL      RDWBERH1
          BRANCH    OVRCD,ECRM9100
.
          GOTO      ECRM6000
.
ECRM5000  MOVE      TEMPLATE,KEY3
          RJUSTIFY  KEY3
          REP       " 0",KEY3
.
          IF        DEFTALLH=0 & IBCNMHOS=1
            MATCH     SP70,FILTHOSP
            IF        @EQUAL
              MOVE      WBSEHOSP,FILTHOSP   * Default hospital filter to users
              MOVE      ONE,DEFTALLH        * logged in hospital if this is the
            ENDIF                           * first time opening the page from
          ENDIF                             * a menu
.
          MATCH     "001",KEY3
          IF        @EQUAL
.
            CALL      CURPER00
            CALL      CALCDT00
.
            CLEAR     WEBTITLE
            MOVE      "Unreleased IMCW ERAW Remittance Advice Enquiry",WEBTITLE
            RESET     WEBTITLE
          ENDIF
.
          MATCH     "005",KEY3
          IF        @EQUAL
.
            CALL      CURPER00
            CALL      CALCDT00
.
            CLEAR     WEBTITLE
            MOVE      "Released IMCW ERAW Remittance Advice Enquiry",WEBTITLE
            RESET     WEBTITLE
          ENDIF
.
          MATCH     "007",KEY3
          IF        @EQUAL
.
            CALL      CURPER00
            CALL      CALCDT00
.
            CLEAR     WEBTITLE
            MOVE      "Unreleased IMCW ERAW Remittance Advice Enquiry Only",WEBTITLE
            RESET     WEBTITLE
          ENDIF
.
ECRM6000  CALL      WEBHED00
          BRANCH    EXIT,ECRM9999
.
          CALL      WEBBOD00
.
          CALL      WEBEND00
.
          MOVE      ONE,EXIT
          GOTO      ECRM9999
.
ECRM7000  MATCH     SP70,REMITKEY
          GOTO      ECRM9100 IF EQUAL
          GOTO      ECRM9100 IF EOS
.
          PACK      KEY61,REMITKEY,SP70
          CALL      RDWBERH1
          BRANCH    OVRCD,ECRM9100
.
          MOVE      "2",WBEISTAT
.
          CALL      UPWBERH1
.
          MOVE      "ERAW Closed without Releasing",WEBTITLE
.         CALL      WEBERR00
          MOVE      ZERO,EXIT
          GOTO      ECRM9999
.
ECRM9000  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ECRM9999
.
ECRM9100  MOVE      "Can't find ERAW Header details.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ECRM9999
.
ECRM9200  MOVE      "Can't find ERAW Payment details.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ECRM9999
.
ECRM9300  MOVE      "Not using WebServices IMCW Module.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ECRM9999
.
ECRM9999  RETURN
.
.--------------------------------------------------------------------------
.*                             PRNRMM00                                   *
.*               Schedule WebServices IMCW ERAW Remittance Report         *
.--------------------------------------------------------------------------
PRNRMM00  MOVE      "IBAWEB11",SCHDPGID
          MOVE      "WebServices IMCW ERAW Remittance Report",SCHDDESC
          CALL      IBACLOCK
          PACK      SCHDDATE,CCC,CYY,CMM,CDD
          REP       " 0",SCHDDATE
          CLOCK     TIME,SCHDTIME
          MOVE      ONE,SCHDCOPY
          MOVE      "S  ",SCHDPRNT           * initialise to spool
          MATCH     SP70,SELPRINT
          IF        !@EQUAL
            MOVE      SELPRINT,SCHDPRNT      * printer code
          ENDIF
          MOVE      "IBAWEB11",SETDFPRG
          MOVE      "1",SETDFRPT
          CALL      SETDEF00                 * save default printer
.
.         Write Keyin parameters
.
          UNPACK    REMITKEY,KEY3,KEY24,KEY30,KEY4
          MOVE      KEY3,KEYSTARR[1]        * key for weberhaf
          MOVE      KEY24,KEYSTARR[2]
          MOVE      KEY30,KEYSTARR[3]
          MOVE      KEY4,KEYSTARR[4]
          MOVE      USERID,KEYSTARR[5]
          MOVE      DIM1C,KEYSTARR[6]
          MOVE      SIX,KEYSTCNT            * Number of Keyins
.
          CALL      SCHPRO00   * Schedule Extract
.
PRNRMM99  RETURN
+
.------------------------------------------------------------
. WebServices IMCW Remittance Advice Enquiry tags
.------------------------------------------------------------
.
ERLM0000  BRANCH    FLDITMNO,ERLM0100,ERLM0200,ERLM0300,ERLM0400,ERLM0500:
                             ERLM0600,ERLM0700,ERLM0800,ERLM0900,ERLM1000:
                             ERLM1100,ERLM1200,ERLM1300,ERLM1400,ERLM1500:
                             ERLM1600,ERLM1700,ERLM1800,ERLM1900,ERLM2000:
                             ERLM2100,ERLM2200,ERLM2300,ERLM2400,ERLM2500:
                             ERLM2600,ERLM2700,ERLM2800,ERLM2900,ERLM3000:
                             ERLM3100,ERLM3200,ERLM3300,ERLM3400,ERLM3500
.
          GOTO      ERLM9999
.
ERLM0100  UNPACK    DIM127,D1,UNRELREM,DIM127
          UNPACK    DIM127,D1,UNRELINQ,DIM127
          UNPACK    DIM127,D1,ERASTATS,DIM127
.
          CALL      ERTH0000           * Set hospital filter and call ERTM0000
          GOTO      ERLM9999
.
ERLM0200  CALL      ERDM0000
          GOTO      ERLM9999
.
ERLM0300  WRITE     HTMLFILE;WBEIRADV;
          GOTO      ERLM9999
.
ERLM0400  WRITE     HTMLFILE;WBEIPNUM;
          GOTO      ERLM9999
.
ERLM0500  WRITE     HTMLFILE;WBEIPTOT;
          GOTO      ERLM9999
.
ERLM0600  MATCH     SP70,WBEIDATE
          GOTO      ERLM9999 IF EQUAL
          UNPACK    WBEIDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      ERLM9999
.
ERLM0700  WRITE     HTMLFILE;WBEINAME;
          GOTO      ERLM9999
.
ERLM0800  WRITE     HTMLFILE;WBEIPLID;
          GOTO      ERLM9999
.
ERLM0900  WRITE     HTMLFILE;WBEIBNUM;
          GOTO      ERLM9999
.
ERLM1000  WRITE     HTMLFILE;WBEIBNAM;
          GOTO      ERLM9999
.
ERLM1100  WRITE     HTMLFILE;WBEIBBSB;
          GOTO      ERLM9999
.
ERLM1200  WRITE     HTMLFILE;WBEIPREF;
          GOTO      ERLM9999
.
ERLM1300  RJUSTIFY  WBEIDAMT
          UNPACK    WBEIDAMT,DIM7,DIM2
          PACK      DIM10,DIM7,FULLSTOP,DIM2
          MOVE      DIM10,FORM7P2C
          WRITE     HTMLFILE;FORM7P2C;
          GOTO      ERLM9999
.
ERLM1400  WRITE     HTMLFILE;WBEIFTID;
          GOTO      ERLM9999
.
ERLM1500  MATCH     "0",WBEISTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Received";
            GOTO      ERLM9999
          ENDIF
.
          MATCH     "1",WBEISTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Partial";
            GOTO      ERLM9999
          ENDIF
.
          MATCH     "2",WBEISTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Released";
            GOTO      ERLM9999
          ENDIF
.
          MATCH     "3",WBEISTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Processing";
            GOTO      ERLM9999
          ENDIF
.
          WRITE     HTMLFILE;"Unknown";
.
          GOTO      ERLM9999
.
ERLM1600  CALL      GCMM0000
          WRITE     HTMLFILE;CLAMTOTL;
          GOTO      ERLM9999
.
ERLM1700  CALL      GCMD0000
          WRITE     HTMLFILE;CLAMTOTL;
          GOTO      ERLM9999
.
ERLM1800  WRITE     HTMLFILE;WBEJRADV;
          GOTO      ERLM9999
.
ERLM1900  WRITE     HTMLFILE;WBEJPNUM;
          GOTO      ERLM9999
.
ERLM2000  WRITE     HTMLFILE;WBEJTRID;
          GOTO      ERLM9999
.
ERLM2100  WRITE     HTMLFILE;WBEJARID;
          GOTO      ERLM9999
.
ERLM2200  RJUSTIFY  WBEJBAMT
          UNPACK    WBEJBAMT,DIM7,DIM2
          PACK      DIM10,DIM7,FULLSTOP,DIM2
.         MOVE      DIM10,FORM7P2C
          MOVE      ZERO,FORM7P2C
          SCAN      "-",DIM10
          IF        @EQUAL
            REP        "-0",DIM10
            MOVE       DIM10,FORM7P2C
            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
          ELSE
            MOVE      DIM10,FORM7P2C
          ENDIF
          WRITE     HTMLFILE;FORM7P2C;
          GOTO      ERLM9999
.
ERLM2300  WRITE     HTMLFILE;WBEJCCOD;
          GOTO      ERLM9999
.
ERLM2400  MATCH     SP70,WBEJLDAT
          GOTO      ERLM9999 IF EQUAL
          UNPACK    WBEJLDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      ERLM9999
.
ERLM2500  WRITE     HTMLFILE;WBEJPARI;
          GOTO      ERLM9999
.
ERLM2600  WRITE     HTMLFILE;WBEJPTID;
          GOTO      ERLM9999
.
ERLM2700  MATCH     "0",WBEJSTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Received";
            GOTO      ERLM9999
          ENDIF
.
          MATCH     "1",WBEJSTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Locked";
            GOTO      ERLM9999
          ENDIF
.
          MATCH     "2",WBEJSTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Released";
            GOTO      ERLM9999
          ENDIF
.
          MATCH     "3",WBEJSTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Released - Suspense";
            GOTO      ERLM9999
          ENDIF
.
          WRITE     HTMLFILE;"Unknown";
.
          GOTO      ERLM9999
.
ERLM2800  UNPACK    DIM127,D1,DIM1,DIM127
          MOVE      ZERO,FORM1
          MOVE      DIM1,FORM1
          BRANCH    FORM1,ERLM2810
.
          WRITE     HTMLFILE;PARTCODE;
          GOTO      ERLM9999
.
ERLM2810  PACK      KEY3,PARTCODE,SP70
          CALL      RDWBPAR1
          BRANCH    OVRCD,ERLM9999
.
          WRITE     HTMLFILE;WBPRNAME;
          GOTO      ERLM9999
.
ERLM2900  WRITE     HTMLFILE;HOSPCODE,FUNDTRID,ECREADVC,ECREPTNO;
          GOTO      ERLM9999
.
ERLM3000  CALL      SELP0000
          GOTO      ERLM9999
.
ERLM3100  CALL      PRVR0000
          GOTO      ERLM9999
.
ERLM3200  CALL      NXTR0000
          GOTO      ERLM9999
.
ERLM3300  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      ERLM9999
.
ERLM3400  WRITE     HTMLFILE;EXDTBLNK;
          GOTO      ERLM9999
.
ERLM3500  CALL      HSPSEL00
          GOTO      ECRL9999
.
ERLM9999  RETURN
+
.***************************************************************************
.*                             ERTM0000                                    *
.*   Display all the remittance batches received from a given participant  *
.***************************************************************************
.
ERTM0000  MATCH     "1",PTCNWSIN
          GOTO      ERTM9999 IF NOT EQUAL
.
          MATCH     "1",PTCNIMCW
          GOTO      ERTM9999 IF NOT EQUAL
.
          MOVE      ZERO,LOOPCNTR
.
          PACK      KEY70,FILTHOSP,ERASTATS,Z70
          CALL      RSWBERH3
ERTM1000  CALL      RPWBERH3
          BRANCH    OVRCD,ERTM9999               * end of file
.
          MATCH     FILTHOSP,WBEIHOSP
          GOTO      ERTM9999 IF NOT EQUAL
.
          MATCH     ERASTATS,WBEISTAT
          GOTO      ERTM9999 IF NOT EQUAL
.
.------------------------------------------------------
. Loop counter to prevent timeout internal server error
.
           ADD       ONE,LOOPCNTR
.
           IF        (LOOPCNTR = 500)
             WRITE     HTMLFILE;"// ",LOOPCNTR
             MOVE      ZERO,LOOPCNTR
           ENDIF
.
. -----------------------------------------------------
.
          PACK      KEY82,WBEIFTID,WBEIRADV,WBEIPNUM,SP70
          CALL      RSWBERD1
ERTM1500  CALL      RKWBERD1
          BRANCH    OVRCD,ERTM1000
.
          MATCH     WBEIFTID,WBEJFTID
          GOTO      ERTM1000 IF NOT EQUAL
.
          MATCH     WBEIRADV,WBEJRADV
          GOTO      ERTM1000 IF NOT EQUAL
.
          MATCH     WBEIPNUM,WBEJPNUM
          GOTO      ERTM1000 IF NOT EQUAL
.
.         A payment for the ERAW has been found, so now if it belongs
.         to webimcaf
.
          PACK      KEY40,WBEJTRID,SP30,SP10
          CALL      RSWBIMC6
          CALL      RKWBIMC6
          BRANCH    OVRCD,ERTM1500
.
          MATCH     WBEJTRID,WBIMTRID            * if its not in webimcaf
          GOTO      ERTM1500 IF NOT EQUAL        * then its probably an imc
.                                                * claim
.
.
          MATCH     "1",UNRELREM
          IF        @EQUAL
            MATCH     "2",WBEISTAT
            GOTO      ERTM1000 IF NOT EQUAL
.
            IF        EXDTBLNK=0
              MATCH     FRSTDATE,WBEIDATE
              GOTO      ERTM1000 IF LESS
.
              MATCH     WBEIDATE,LASTDATE
              GOTO      ERTM1000 IF LESS
            ENDIF
.
          ELSE
            MATCH     "2",WBEISTAT
            GOTO      ERTM1000 IF EQUAL
.
            IF        EXDTBLNK=0
              MATCH     FRSTDATE,WBEIDATE
              GOTO      ERTM1000 IF LESS
.
              MATCH     WBEIDATE,LASTDATE
              GOTO      ERTM1000 IF LESS
            ENDIF
.
          ENDIF
.
          MOVE      SP70,DIM11
          MATCH     SP70,WBEIDATE
          IF        !@EQUAL & !@EOS
            UNPACK    WBEIDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DIM11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MOVE      "Unknown  ",DIM9
          MATCH     "0",WBEISTAT
          IF        @EQUAL
            MOVE      "Received ",DIM9
          ENDIF
.
          MATCH     "1",WBEISTAT
          IF        @EQUAL
            MOVE      "Partial  ",DIM9
          ENDIF
.
          MATCH     "2",WBEISTAT
          IF        @EQUAL
            MOVE      "Released ",DIM9
          ENDIF
.
          MATCH     "3",WBEISTAT
          IF        @EQUAL
            MOVE      "Processng ",DIM9
          ENDIF
.
          MOVE      ZERO,FORM7P2C
          RJUSTIFY  WBEIDAMT
          UNPACK    WBEIDAMT,DIM7,DIM2
          PACK      DIM10,DIM7,DOT,DIM2
          MOVE      DIM10,FORM7P2C
.
          CALL      GCMM0000
.
          REP       " +",WBEIFTID
          REP       " +",WBEIRADV
          REP       " +",WBEIPNUM
          REP       " +",WBEIHOSP
.
          MOVE      ZERO,LOOPCNTR
.
          IF        IBCNMHOS=1
.
            MATCH     "+++",WBEIHOSP
            IF        @EQUAL | @EOS
              WRITE     HTMLFILE;"t.addRow(#"",DIM11,"#",";
            ELSE
        WRITE     HTMLFILE;"t.addRow(#"","<img src='../images/CommentIcon.gif'":
                         " class=ListIcon onclick=displayRemH('",WBEIDATE,"','":
      WBEIFTID,"','",WBEIRADV,"','",WBEIPNUM,"','",WBEIHOSP,"','002');> ",DIM11," ",WBEINAME,"#",";
            ENDIF
.
          ELSE
.
        WRITE     HTMLFILE;"t.addRow(#"","<img src='../images/CommentIcon.gif'":
                         " class=ListIcon onclick=displayRemH('",WBEIDATE,"','":
      WBEIFTID,"','",WBEIRADV,"','",WBEIPNUM,"','",WBEIHOSP,"','002');> ",DIM11," ",WBEINAME,"#",";
          ENDIF
.
          REP       "+ ",WBEIFTID
          REP       "+ ",WBEIRADV
          REP       "+ ",WBEIPNUM
          REP       "+ ",WBEIHOSP
.
          WRITE     HTMLFILE;"#"",WBEIPNUM," of ",WBEIPTOT,"#",":
                             "#"",DIM9,"#",":
                             "#"",FORM7P2C,"#",":
                             "#"",CLAMTOTL,"#",";
.
          REP       " +",WBEIFTID
          REP       " +",WBEIRADV
          REP       " +",WBEIPNUM
          REP       " +",WBEIHOSP
          MOVE      WBEIPREF,DIM30
          RJUSTIFY WBEIDAMT
          MOVE      WBEIDAMT,DIM9
          REP       " +",DIM30
          REP       " +",DIM9
.
          MOVE      FORM7P2C,DIM10A
          MOVE      CLAMTOTL,DIM10B
          REP       " +",DIM10A
          REP       " +",DIM10B
.
          MATCH     "1",UNRELREM
          IF        @EQUAL
.
            IF        IBCNMHOS=1
.
              MATCH     "+++",WBEIHOSP
              IF        @EQUAL | @EOS
                WRITE     HTMLFILE;"#"",WBEIPREF;
              ELSE
            WRITE     HTMLFILE;"#"","<img src='../images/AppointmentIcon.gif'":
                         " class=ListIcon onclick=displayRemH('",WBEIDATE,"','":
              WBEIFTID,"','",WBEIRADV,"','",WBEIPNUM,"','",WBEIHOSP,"','003');>&nbsp;":
                               WBEIPREF;
              ENDIF
.
            ELSE
.
            WRITE     HTMLFILE;"#"","<img src='../images/AppointmentIcon.gif'":
                         " class=ListIcon onclick=displayRemH('",WBEIDATE,"','":
              WBEIFTID,"','",WBEIRADV,"','",WBEIPNUM,"','",WBEIHOSP,"','003');>&nbsp;":
                               WBEIPREF;
            ENDIF
          ELSE
.
            IF        IBCNMHOS=1
.
              MATCH     "+++",WBEIHOSP
              IF        @EQUAL | @EOS
                WRITE     HTMLFILE;"#"",WBEIPREF;
              ELSE
                MATCH     "3",WBEISTAT
                IF        @EQUAL
                  WRITE     HTMLFILE;"#"","<img src='../images/AppointmentIcon.gif'":
                            " class=ListIcon onclick=displayRemH('",WBEIDATE,"','":
                            WBEIFTID,"','",WBEIRADV,"','",WBEIPNUM,"','",WBEIHOSP,"','003');>&nbsp;":
                            WBEIPREF,"&nbsp;<input type=button value='Processing' class='orangebutton' disabled>";
                ELSE
                  MATCH     "1",UNRELINQ
                  IF        @EQUAL
                    WRITE     HTMLFILE;"#"","<img src='../images/AppointmentIcon.gif'":
                              " class=ListIcon onclick=displayRemH('",WBEIDATE,"','":
                              WBEIFTID,"','",WBEIRADV,"','",WBEIPNUM,"','",WBEIHOSP,"','003');>&nbsp;":
                              WBEIPREF;
                  ELSE
                    WRITE     HTMLFILE;"#"","<img src='../images/AppointmentIcon.gif'":
                              " class=ListIcon onclick=displayRemH('",WBEIDATE,"','":
                              WBEIFTID,"','",WBEIRADV,"','",WBEIPNUM,"','",WBEIHOSP,"','003');>&nbsp;":
                              WBEIPREF,"&nbsp;<input type=button value='Release' class='button' onclick=releaseRem('",WBEIFTID,"','",WBEIRADV,"','",WBEIPNUM,"','",WBEIHOSP,"','",DIM30,"','",DIM9,"',this,'",DIM10A,"','",DIM10B,"');>";
                  ENDIF
                ENDIF
              ENDIF
.
            ELSE
              MATCH     "3",WBEISTAT
              IF        @EQUAL
                WRITE     HTMLFILE;"#"","<img src='../images/AppointmentIcon.gif'":
                          " class=ListIcon onclick=displayRemH('",WBEIDATE,"','":
                          WBEIFTID,"','",WBEIRADV,"','",WBEIPNUM,"','",WBEIHOSP,"','003');>&nbsp;":
                          WBEIPREF,"&nbsp;<input type=button value='Processing' class='orangebutton' disabled>";
              ELSE
                MATCH     "1",UNRELINQ
                IF        @EQUAL
                  WRITE     HTMLFILE;"#"","<img src='../images/AppointmentIcon.gif'":
                            " class=ListIcon onclick=displayRemH('",WBEIDATE,"','":
                            WBEIFTID,"','",WBEIRADV,"','",WBEIPNUM,"','",WBEIHOSP,"','003');>&nbsp;":
                            WBEIPREF;
                ELSE
                  WRITE     HTMLFILE;"#"","<img src='../images/AppointmentIcon.gif'":
                            " class=ListIcon onclick=displayRemH('",WBEIDATE,"','":
                            WBEIFTID,"','",WBEIRADV,"','",WBEIPNUM,"','",WBEIHOSP,"','003');>&nbsp;":
                            WBEIPREF,"&nbsp;<input type=button value='Release' class='button' onclick=releaseRem('",WBEIFTID,"','",WBEIRADV,"','",WBEIPNUM,"','",WBEIHOSP,"','",DIM30,"','",DIM9,"',this,'",DIM10A,"','",DIM10B,"');>";
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"#",#"",WBEINAME;
          MOVE      WBEIRADV,DIM30
          REP       "+ ",WBEIRADV
          WRITE     HTMLFILE;"#",#"","<img src='../images/CommentIcon.gif'":
                         " class=ListIcon onclick=displayRemH('",WBEIDATE,"','":
      WBEIFTID,"','",DIM30,"','",WBEIPNUM,"','",WBEIHOSP,"','002');> ",WBEIRADV;
.
          REP       "+ ",WBEIHOSP
.
          WRITE     HTMLFILE;"#",#"",WBEIFTID;
          WRITE     HTMLFILE;"#",#"",DIM11;
.
          MOVE      SP70,DIM50
          MATCH     SP70,WBEIHOSP
          IF        !@EQUAL & !@EOS
            PACK      KEY3,WBEIHOSP,SP70
            CALL      RDPTHSP1
            IF        OVRCD=0
              MOVE      PTHSNAME,DIM50
            ELSE
              MOVE      WBEIHOSP,DIM50
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"#",#"",DIM50;
.
          WRITE     HTMLFILE;"#",#"","<img src='../images/CommentIcon.gif'":
                    "class=ListIcon onclick=displayJSON('",WBEIFTID,"');>";
.
          WRITE     HTMLFILE;"#");"
.
          REP       "+ ",WBEIFTID
          REP       "+ ",WBEIRADV
          REP       "+ ",WBEIPNUM
.
          GOTO      ERTM1000
.
ERTM9999  RETURN
+
.*****************************************************************************
.*                            GCMM0000                                       *
.*              Get the claimed amount total for the ERAW                    *
.* Requires:  Valid read on weberhaf record (ERAW Header)                    *
.* Returns:   CLAMTOTL - total claimed amount for the ERAW batch             *
.*****************************************************************************
.
GCMM0000  MOVE      ZERO,CLAMTOTL                * initialise total amount
.
          MATCH     "1",PTCNWSIN
          GOTO      GCMM9999 IF NOT EQUAL
.
          MATCH     "1",PTCNIMCW
          GOTO      GCMM9999 IF NOT EQUAL
.
.         Loop through pmserdaf looking for payments from the selected ERA
.
          PACK      KEY82,WBEIFTID,WBEIRADV,WBEIPNUM,SP30,SP30,SP1
          CALL      RSWBERD1                     * position in file
GCMM1000  CALL      RKWBERD1                     * read next record
          BRANCH    OVRCD,GCMM9999               * end of file
.
          MATCH     WBEIFTID,WBEJFTID            * same participant still ?
          GOTO      GCMM9999 IF NOT EQUAL        * no - finished ERA
.
          MATCH     WBEIRADV,WBEJRADV            * same remittance advice still?
          GOTO      GCMM9999 IF NOT EQUAL        * no - finished ERA
.
          MATCH     WBEIPNUM,WBEJPNUM            * same part number still ?
          GOTO      GCMM9999 IF NOT EQUAL        * no - finished ERA
.
.         A payment for the ERAW has been found, so now get the claimed amount
.         from webimcaf
.
          PACK      KEY40,WBEJTRID,SP30,SP10
          CALL      RSWBIMC6                     * position on trans. id
          CALL      RKWBIMC6                     * read next record
          BRANCH    OVRCD,GCMM1000               * eof - not found
.
          MATCH     WBEJTRID,WBIMTRID            * same transaction id still ?
          GOTO      GCMM1000 IF NOT EQUAL        * no - not found
.
          ADD       WBIMAMTC,CLAMTOTL            * update ERA claim total
          GOTO      GCMM1000                     * get next payment
.
GCMM9999  RETURN
+
.------------------------------------------------------------
. Eclipse IMCW Remittance Payment Details
.------------------------------------------------------------
.
ERDM0000  MATCH     "1",PTCNWSIN
          GOTO      ERDM9999 IF NOT EQUAL
.
          MATCH     "1",PTCNIMCW
          GOTO      ERDM9999 IF NOT EQUAL
.
          CALL      ECRDH000
.
          PACK      KEY82,WBEIFTID,WBEIRADV,WBEIPNUM,SP70
          CALL      RSWBERD1
ERDM1000  CALL      RKWBERD1
          BRANCH    OVRCD,ERDM9999
.
          MATCH     WBEIFTID,WBEJFTID
          GOTO      ERDM9999 IF NOT EQUAL
.
          MATCH     WBEIRADV,WBEJRADV
          GOTO      ERDM9999 IF NOT EQUAL
.
          MATCH     WBEIPNUM,WBEJPNUM
          GOTO      ERDM9999 IF NOT EQUAL
.
          MOVE      SP70,DIFCINDC
          IF        IBCNMHOS=1
            PACK      KEY40,WBEJTRID,SP70
            CALL      RSWBIMC6
            CALL      RKWBIMC6
            BRANCH    OVRCD,ERDM5000
.
            MATCH     WBEJTRID,WBIMTRID
            GOTO      ERDM5000 IF NOT EQUAL
.
            MATCH     SP70,WBIMHOSP
            IF        !@EQUAL & !@EOS
              MATCH     WBIMHOSP,WBSEHOSP
              IF        !@EQUAL
                PACK      KEY3,WBIMHOSP,SP70
                CALL      RDPTHSP1
                IF        OVRCD=0
                  MOVE      PTHSLOCN,SAVELOCN
                ELSE
                  MOVE      SP70,SAVELOCN
                ENDIF
.
                PACK      KEY3,WBSEHOSP,SP70
                CALL      RDPTHSP1
                IF        OVRCD=0
.
                  MATCH     SAVELOCN,PTHSLOCN
.                  GOTO      ERDM1000 IF NOT EQUAL
                  IF        @EQUAL
                    MOVE      "1",DIFCINDC
                  ENDIF
.
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
ERDM5000  CALL      ERDMR000
.
          GOTO      ERDM1000
.
ERDM9999  RETURN
+
.------------------------------------------------------------
. WebServices IMCW Payment Details (Detail Row)
.------------------------------------------------------------
.
ERDMR000  REP       " +",HOSPCODE
          REP       " +",WBEJFTID
          REP       " +",WBEJRADV
          REP       " +",WBEJPNUM
          REP       " +",WBEJTRID
          WRITE     HTMLFILE;"<tr><td><img src='../images/CommentIcon.gif'":
                             " class=ListIcon onclick=displayRemD('":
  HOSPCODE,"','",WBEJFTID,"','",WBEJRADV,"','",WBEJPNUM,"','",WBEJTRID,"','D');>&nbsp;";
          REP       "+ ",HOSPCODE
          REP       "+ ",WBEJFTID
          REP       "+ ",WBEJRADV
          REP       "+ ",WBEJPNUM
          REP       "+ ",WBEJPNUM
.
          MATCH     "1",DIFCINDC
          IF        @EQUAL
            WRITE     HTMLFILE;"<font color=red>";
          ENDIF
.
          WRITE     HTMLFILE;WBEJARID;
.
          CALL      CLWEBIMC
          PACK      KEY40,WBEJTRID,SP70
          CALL      RSWBIMC6
          CALL      RKWBIMC6
          IF        OVRCD=0
.
            MATCH     WBEJTRID,WBIMTRID
            IF        !@EQUAL
              CALL      CLWEBIMC
            ENDIF
.
          ENDIF
.
          WRITE     HTMLFILE;"&nbsp;",WBIMHOSP;
.
          MATCH     "1",DIFCINDC
          IF        @EQUAL
            WRITE     HTMLFILE;"</font>";
          ENDIF
.
          WRITE     HTMLFILE;"</td>";
.
          RJUSTIFY  WBEJBAMT
          UNPACK    WBEJBAMT,DIM7,DIM2
          PACK      DIM10,DIM7,DOT,DIM2
.         MOVE      DIM10,FORM7P2C
          MOVE      ZERO,FORM7P2C
          SCAN      "-",DIM10
          IF        @EQUAL
            REP        "-0",DIM10
            MOVE       DIM10,FORM7P2C
            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
          ELSE
            MOVE      DIM10,FORM7P2C
          ENDIF
.
          MATCH     "1",DIFCINDC
          IF        @EQUAL
            WRITE     HTMLFILE;"<td><font color=red>",FORM7P2C,"</font></td>";
          ELSE
            WRITE     HTMLFILE;"<td>",FORM7P2C,"</td>";
          ENDIF
.
          MOVE      ZERO,CLAMTOTL
          PACK      KEY40,WBEJTRID,SP30,SP10
          CALL      RSWBIMC6                     * position on trans. id
          CALL      RKWBIMC6                     * read next record
          BRANCH    OVRCD,ERDMR100                * eof - not found
.
          MATCH     WBEJTRID,WBIMTRID            * same transaction id still ?
          GOTO      ERDMR100 IF NOT EQUAL        * no - not found
.
          MOVE      WBIMAMTC,CLAMTOTL            * update ERA claim total
.
ERDMR100  MATCH     "1",DIFCINDC
          IF        @EQUAL
            WRITE     HTMLFILE;"<td><font color=red>",CLAMTOTL,"</font></td>";
.
            WRITE     HTMLFILE;"<td><font color=red>",WBIMBATN,"</font></td>";
          ELSE
            WRITE     HTMLFILE;"<td>",CLAMTOTL,"</td>";
.
            WRITE     HTMLFILE;"<td>",WBIMBATN,"</td>";
          ENDIF
.
          MOVE      "Unknown  ",DIM9
          MATCH     "0",WBEJSTAT
          IF        @EQUAL
            MOVE      "Received ",DIM9
          ENDIF
.
          MATCH     "1",WBEJSTAT
          IF        @EQUAL
            MOVE      "Locked   ",DIM9
          ENDIF
.
          MATCH     "2",WBEJSTAT
          IF        @EQUAL
            MOVE      "Released",DIM9
          ENDIF
.
          MATCH     "3",WBEJSTAT
          IF        @EQUAL
            MOVE      "Released*",DIM9
          ENDIF
.
          MATCH     "1",DIFCINDC
          IF        @EQUAL
            WRITE     HTMLFILE;"<td><font color=red>",DIM9,"</font></td>";
.
            WRITE     HTMLFILE;"<td><font color=red>",WBEJCCOD,"</font></td>";
          ELSE
            WRITE     HTMLFILE;"<td>",DIM9,"</td>";
.
            WRITE     HTMLFILE;"<td>",WBEJCCOD,"</td>";
          ENDIF
.
          MOVE      SP70,DIM11
          MATCH     SP70,WBEJLDAT
          IF        !@EQUAL & !@EOS
            UNPACK    WBEJLDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DIM11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MATCH     "1",DIFCINDC
          IF        @EQUAL
            WRITE     HTMLFILE;"<td><font color=red>",DIM11,"</font></td>";
.
            WRITE     HTMLFILE;"<td><font color=red>",WBEJTRID,"</font></td>";
          ELSE
            WRITE     HTMLFILE;"<td>",DIM11,"</td>";
.
            WRITE     HTMLFILE;"<td>",WBEJTRID,"</td>";
          ENDIF
.
          WRITE     HTMLFILE;"</tr>";
.
ERDMR999  RETURN
+
.------------------------------------------------------------
. Get claim amount for a specific transactiom id
.------------------------------------------------------------
.
GCMD0000  MOVE      ZERO,CLAMTOTL
.
          MATCH     "1",PTCNWSIN
          GOTO      GCMD9999 IF NOT EQUAL
.
          MATCH     "1",PTCNIMCW
          GOTO      GCMD9999 IF NOT EQUAL
.
          PACK      KEY40,WBEJTRID,SP30,SP10
          CALL      RSWBIMC6                     * position on trans. id
          CALL      RKWBIMC6                     * read next record
          BRANCH    OVRCD,GCMD9999                * eof - not found
.
          MATCH     WBEJTRID,WBIMTRID            * same transaction id still ?
          GOTO      GCMD9999 IF NOT EQUAL        * no - not found
.
          MOVE      WBIMAMTC,CLAMTOTL            * update ERA claim total
.
GCMD9999  RETURN
+
.*****************************************************************************
.*                              RPAM0000           Called by: KEYA0000       *
.*           Release all payments for the selected ERAW batch                *
.*****************************************************************************
.
.         Initialise counters
.         ERDCOUNT - is the total number of weberdaf records associated
.                    with the selected ERAW batch.
.         PRLCOUNT - is the number of weberdaf records associated with the
.                    selected ERAW batch, which have previously been "released".
.         RELCOUNT - is the number of weberdaf records associated with the
.                    selected ERAW batch for which payments have been released
.                    in this session.
.
RPAM0000  CALL      CLER0000
          MOVE      SP3,SAVEPART
.
          MOVE      ZERO,EXIT
          MOVE      ZERO,ERDCOUNT
          MOVE      ZERO,PRLCOUNT
          MOVE      ZERO,RELCOUNT
.
.         Start releasing payments for the ERA
.
RPAM0500  REP       "+ ",FUNDTRID
          REP       "+ ",REMITADV
          REP       "+ ",PARTNUMB
          REP       "+ ",HOSPCODE
.
          PACK      KEY61,HOSPCODE,FUNDTRID,REMITADV,PARTNUMB,SP70
          CALL      RDWBERH1
          BRANCH    OVRCD,RPAM9960
.
          MATCH     "3",WBEISTAT
          GOTO      RPAM9950 IF EQUAL
.
          MOVE      "3",WBEISTAT
          CALL      UPWBERH1
.
          CALL      LTMM0000
.
.         Start releasing payments for the ERA
.
          MOVE      SP30,KEY27
          CALL      RSTEMP2                      * position in file
RPAM1000  CALL      RKTEMP2                      * read next record
          BRANCH    OVRCD,RPAM9000               * end of file
.
.         Read the weberdaf record as the record status will need to be
.         updated later
.
          PACK      KEY82,WBEJFTID,WBEJRADV,WBEJPNUM,WBEJTRID,SP70
          CALL      RDWBERD1                     * record found ?
          BRANCH    OVRCD,RPAM1000               * no - shouldn't happen
.
          RJUSTIFY  WBEJBAMT
          UNPACK    WBEJBAMT,DIM7,DIM2           * set amount paid
          PACK      DIM10,DIM7,DOT,DIM2
          MOVE      ZERO,FORM7P2C
.
          SCAN      "-",DIM10
          IF        @EQUAL
            REP        "-0",DIM10
            MOVE       ZERO,FORM7P2C
            MOVE       DIM10,FORM7P2C
            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
          ELSE
            MOVE       DIM10,FORM7P2C
          ENDIF
.
.         IF        FORM7P2C = 0 | FORM7P2C < 0
          IF        FORM7P2C = 0
            ADD       ONE,RELCOUNT
            MOVE      TWO,WBEJSTAT                 * set as released
            CALL      UPWBERD1
            GOTO      RPAM1000
          ENDIF
.
.         A payment for the ERA has been found, so check if it needs releasing
.
.         ADD       ONE,ERDCOUNT                 * increment pmserdaf count
          MATCH     "2",WBEJSTAT                 * releasing ?
          IF        @EQUAL
            ADD       ONE,PRLCOUNT               * yes - incr. prev. rel. count
            GOTO      RPAM1000                   * get next payment
          ENDIF
.
          MATCH     "3",WBEJSTAT                 * releasing ?
          IF        @EQUAL
            ADD       ONE,PRLCOUNT               * yes - incr. prev. rel. count
            GOTO      RPAM1000                   * get next payment
          ENDIF
.
.         A claim requiring payment releasing has been found, so
.         get the corresponding priectaf record and check if same hospital
.
          MOVE      ZERO,ERASUSIN
          PACK      KEY40,WBEJTRID,SP70
          CALL      RSWBIMC6                     * position on trans. id/invoice
          CALL      RKWBIMC6                     * read next record
.         BRANCH    OVRCD,RPAM6000               * eof
          IF        OVRCD=ONE
            CLEAR     SERDIM50
            APPEND    WBEJARID,SERDIM50
            APPEND    " - webimcaf record not found",SERDIM50
            RESET     SERDIM50
            GOTO      RPAM6000
          ENDIF
.
          MATCH     WBEJTRID,WBIMTRID            * same transaction id still ?
.         GOTO      RPAM6000 IF NOT EQUAL        * no
          IF        !@EQUAL
            CLEAR     SERDIM50
            APPEND    WBEJTRID,SERDIM50
            APPEND    " - tran id not found",SERDIM50
            RESET     SERDIM50
            GOTO      RPAM6000
          ENDIF

.
          MOVE      SP70,SAVELOCN
.          IF        IBCNMHOS=1
.            MATCH     WBEIHOSP,WBIMHOSP
.            IF        !@EQUAL
.              PACK      KEY3,WBIMHOSP,SP70
.              CALL      RDPTHSP1
.              IF        OVRCD=0
.                MOVE      PTHSLOCN,SAVELOCN
.              ELSE
.                  SUB       ONE,ERDCOUNT
.                  GOTO      RPAM1000
.              ENDIF
..
.              PACK      KEY3,WBEIHOSP,SP70
.              CALL      RDPTHSP1
.              IF        OVRCD=0
.                MATCH     SAVELOCN,PTHSLOCN
.                IF        !@EQUAL
.                  SUB       ONE,ERDCOUNT
.                  GOTO      RPAM1000
.                ENDIF
.              ELSE
.                  SUB       ONE,ERDCOUNT
.                  GOTO      RPAM1000
.              ENDIF
.            ENDIF
.          ENDIF
.
          PACK      KEY8,WBEJARID,SP70
          RJUSTIFY  KEY8
          CALL      RDPRIN1
.         IF        OVRCD = 1
.           GOTO      RPAM6000
.         ENDIF
          IF        OVRCD=ONE
            CLEAR     SERDIM50
            APPEND    WBEJARID,SERDIM50
            APPEND    " - priinvof record not found",SERDIM50
            RESET     SERDIM50
            GOTO      RPAM6000
          ENDIF

.
          MATCH     "1",PRINCNST
.         GOTO      RPAM6000 IF EQUAL
          IF        @EQUAL
            CLEAR     SERDIM50
            APPEND    WBEJARID,SERDIM50
            APPEND    "invoice is fully credited",SERDIM50
            RESET     SERDIM50
            GOTO      RPAM6000
          ENDIF
.
.         Now lock all the relevant records prior to releasing the payment.
.         Check that we can lock the Health Fund receipts record.
.
RPAM1500  
.         MOVE      "HFR",PRXCODE   * System Lock Audits
.         CALL      GETSLK00        * Get System Lock Audits
.
.         PACK      KEY8,PMECINVN,SP70
.         CALL      RDHFRE1                      * lock record found ?
.         IF        OVRCD = 1
.           MOVE      ONE,HFRSTAT                * no - write one with lock
.           MOVE      PMECINVN,HFRINVR
.           CALL      WRHFRE1
.         ELSE
.           COMPARE   ZERO,HFRSTAT               * yes - is it already locked ?
.           IF        @EQUAL
.             MOVE      ONE,HFRSTAT              * no - lock now
.             CALL      UPHFRE1
.           ELSE
.             CALL      RELSLK00                 * Release System Lock Audits
.             GOTO      RPAM8000                 * record already locked
.           ENDIF
.         ENDIF
.         CALL      RELSLK00        * Release System Lock Audits
.
.         Now check the we can lock the invoice record
.
.         MOVE      PMECINVN,KEY8
.         CALL      RLPTINV1
.         IF        OVRCD = 1
..           MOVE      THREE,UNLKFLAG
..           CALL      UNLK0000                   * unlock any locked records
..           GOTO      RPAM8000
.           GOTO      RPAM6100
.         ELSE
.           IF        OVRCD = 2
.             MOVE      THREE,UNLKFLAG
.             CALL      UNLK0000                 * unlock any locked records
.             GOTO      RPAM8000
.           ENDIF
.         ENDIF
.
.         Check that we can lock the visit record
.
.         PACK      KEY8,PMECADMN,SP70
.         CALL      RLPTVIS1
.         IF        OVRCD = 1
.           MOVE      TWO,UNLKFLAG
.           CALL      UNLK0000                   * unlock any locked records
.           GOTO      RPAM8000
.         ELSE
.           IF        OVRCD = 2
.             MOVE      TWO,UNLKFLAG
.             CALL      UNLK0000                 * unlock any locked records
.             GOTO      RPAM8000
.           ENDIF
.         ENDIF
.
.         All the relevant records have been locked.
.         As there may be payments in this remittance for more than one
.         participant, check if the participant code has changed.  If it
.         has, then we need to get a new receipt number.
.
          MATCH     SAVEPART,PARTPANT            * same participant still ?
          IF        !@EQUAL
            CALL      ALLCRC00
.
            MOVE      PARTPANT,SAVEPART          * save new participant code
          ENDIF
.
.         Process the payment
.
          RJUSTIFY  WBEJBAMT
          UNPACK    WBEJBAMT,DIM7,DIM2           * set amount paid
          PACK      DIM10,DIM7,DOT,DIM2
          MOVE      ZERO,FORM7P2C
.
          SCAN      "-",DIM10
          IF        @EQUAL
            REP        "-0",DIM10
            MOVE       ZERO,FORM7P2C
            MOVE       DIM10,FORM7P2C
            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
          ELSE
            MOVE       DIM10,FORM7P2C
          ENDIF
.        
          MATCH     "HIC",WBEINAME
          IF        @EQUAL
            MOVE      FORM7P2C,WBIMAMMP
            ASSIGN    (PRINMAMT-WBIMAMMP),PRINMAMT
          ELSE
            MATCH     "Services Australia",WBEINAME
            IF        @EQUAL
              MOVE      FORM7P2C,WBIMAMMP
              ASSIGN    (PRINMAMT-WBIMAMMP),PRINMAMT
            ELSE
              MOVE      FORM7P2C,WBIMAMFP
              ASSIGN    (PRINHAMT-WBIMAMFP),PRINHAMT
            ENDIF
          ENDIF
.
          CALL      IBACLOCK                     * get current date
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          MOVE      CTIMEIS,CURRTIME
.
.         Check if the invoice now balances
.      
          MOVE      PRINITOT,FORM10P2             * Invoice amount +
          ADD       PRINPAMT,FORM10P2            * Patient payments +
          ADD       PRINHAMT,FORM10P2            * H.F payments +
          ADD       PRINOTHA,FORM10P2            * Other payments +
          ADD       PRINJAMT,FORM10P2            * Journals +
          ADD       PRINGSTJ,FORM10P2            * Journal GST = amt outstanding
.
.         MOVE      "99999999",PINVBLCD          * default to not balancing
.
.         COMPARE   ZERO,FORM10P2                * Does invoice balance ?
.         IF        @EQUAL
.           MOVE      CURRDATE,PINVBLCD          * yes - record balanced date
..          MOVE      TWO,PTDTAPAY               * set A/P flag - balanced
.         ELSE
..          MOVE      ZERO,PTDTAPAY              * set A/P flag - not balanced
.         ENDIF
          MOVE      FORM10P2,PRINPEND
.         CALL      UPINV1                       * update/unlock invoice record
.
.         PROC      FLAGDEBT
.
.         Create the patdtraf cash receipt record.
.              
          MOVE      WBIMUNIQ,PRDTUNIQ            * load unique number
.
.         Get the next transaction number.  As we have already locked
.         the visit record, there should be no problem getting the
.         next transaction number.
.
.RPAM3000  MOVE      PMECADMN,KEY8                * get next transaction number
.          CALL      TRVISA1
.
.          PACK      KEY22,PMECADMN,PMECINVN,PVITRAN
.          CALL      RDADTRN1                     * patdtraf record on file ?
.          COMPARE   ZERO,OVRCD
.          GOTO      RPAM3000 IF EQUAL            * yes
.
.          MOVE      PVITRAN,TTRANSN1             * load transaction number
.          MOVE      ANSH,TTYPEDEB                * set to "patient" type of debt
.          MOVE      PMECHFND,TDCODE
.
.          ASSIGN    (PMECAMTP*SEQ),TPATAMTT
.          MOVE      TPATAMTT,TREBATE
.
.          MOVE      ZERO,TPATAMTG                * set $ amounts
.          MOVE      ZERO,TPATAMTH
.          MOVE      ZERO,TPATAMTI
.          MOVE      ZERO,TPATAMTP
.
.          MOVE      CCC,TFCENT                   * set payment date
.          MOVE      CYY,TFYEAR
.          MOVE      CMM,TFMONTH
.          MOVE      CDD,TFDAY
.
.          MOVE      ZERO,TTCENT                  * initialise accomm. to dates
.          MOVE      ZERO,TTYEAR
.          MOVE      ZERO,TTMONTH
.          MOVE      ZERO,TTDAY
.
.          PACK      TTYPE,ANSP,ANSY              * set for payment
.          MOVE      SP9,TITEMNO
.          MOVE      PMECINVN,TREF                * load invoice no.
.          MOVE      SIX,TPAYTYPE                 * direct deposit
.
          MOVE      HRECPT,PRDTRECN
.
.          IF        PMECEETP = 0
.            MOVE      "Unknown Health Fund           ",HFNAME
.            PACK      KEY14,PMECHFND,ZERO4,SP20
.            CALL      RDFUND1                    * HF on file ?
.            MOVE      HFNAME,TDDESC              * load HF description
.          ELSE
.            MOVE      "Unknown Claim Code  ",TDESC
.            PACK      KEY5,ANSC,ANSL,PINVCLM
.            CALL      RDCODE1
.            MOVE      TDESC,TDDESC               * load claim code description
.          ENDIF
.
.          MOVE      ONE,TINVPRT                  * invoice printed
.          MOVE      FIVE,TRECTYPE                * cash receipt
.          MOVE      ZERO,TNODAYS
.          MOVE      ZERO,TCLAIM
..         MOVE      ZERO,PTDTREBT
.          MOVE      SP6,TDOCTA
.          MOVE      ZERO,TSERVS
.          MOVE      SP6,TDOCTO
.          MOVE      SP2,TSESSION
.          MOVE      SP3,TMISGRP
.          MOVE      SP3,TDEPTYP
.          MOVE      SP3,TDWARD
.          MOVE      SP3,TCLMTYP
.          MOVE      SP3,TADMTYP
.          MOVE      PMECBATN,TBATCHN             * load batch number
.          MOVE      ZERO,TNINVS
.          MOVE      SP3,PTDTBTYP
.          MOVE      ZERO,PTDTLSPT
.          MOVE      ZERO,PTDTLSRB
.          MOVE      ZERO,PTDTDTYP
.          PACK      PTDTDES2,SP20,SP20
.          MOVE      ZERO,PTDTEPSD
.          MOVE      ZERO,PTDTCCU
..         MOVE      SP6,PTDTSURG
..         MOVE      SP1,PTDTDEPS
.
.          MOVE      CURRDATE,PTDTEFFD            * load payment date
.
.          MOVE      ZERO,PTDTGSTA
.          MOVE      SP6,PTDTGSTC
.          MOVE      ZERO,PTDTGSTM
.          MOVE      ZERO,PTDTADPT
.          MOVE      ZERO,PTDTADRB
.          MOVE      ZERO,PTDTGSTL
.          MOVE      SP70,PTDTTIME
.          MOVE      SP70,PTDTCRST
.          MOVE      SP70,PTDTUNIQ
.          MOVE      SP70,PTDTCNTR
.          MOVE      SP70,PTDTCPRC
.          MOVE      SP70,PTDTCONT
.          MOVE      SP70,PTDTSUNQ
.          MOVE      SP70,PTDTBTCH
..         MOVE      ANSN,PTDTSSAP
..         MOVE      ZERO,PTDTMVBR
.          MOVE      ZERO,PTDTEPSD
..         MOVE      SP1,PTDTMHDP
.          PACK      TSPARE,SP30,SP30
.
.          CALL      WRDTRN1                     * write patdtraf journal record
.
          ADD       ONE,RELCOUNT
.
. Write to rcpbnkaf
.
          PACK      KEY12,HRECPT,SP70
          CALL      RDRCBNK1
          IF        OVRCD=1
.
            MOVE      HRECPT,RCBNRECN
            CALL      IBACLOCK
            PACK      RCBNTDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBNTDAT
.
            RJUSTIFY  WBEJBAMT
            UNPACK    WBEJBAMT,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       ZERO,FORM7P2C
              MOVE       DIM10,FORM7P2C
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE
              MOVE       DIM10,FORM7P2C
            ENDIF
.
            MOVE      FORM7P2C,RCBNTOTP
            MOVE      RCCNERCD,RCBNCDRW
            MOVE      RCCNERCA,RCBNCHQA
            MOVE      WBEIHOSP,RCBNMHOS
.
            IF        IBCNMHOS=1
              MATCH     SP70,RCBNMHOS
              IF        !@EQUAL & !@EOS
                PACK      KEY3,RCBNMHOS,SP70
                CALL      RDPTHSP1
                IF        OVRCD=0
                  MATCH     SP70,PTHSERCD
                  IF        !@EQUAL & !@EOS
                    MOVE      PTHSERCD,RCBNCDRW
                  ENDIF
                  MATCH     SP70,PTHSERCA
                  IF        !@EQUAL & !@EOS
                    MOVE      PTHSERCA,RCBNCHQA
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
.
            MOVE      CHOSPNUM,RCBNMDHS
.
            MATCH     "HIC",WBEINAME
            IF        @EQUAL
              MOVE      "3",RCBNTTYP
              MOVE      SP70,RCBNRCOD
            ELSE
              MATCH     "Services Australia",WBEINAME
              IF        @EQUAL
                MOVE      "3",RCBNTTYP
                MOVE      SP70,RCBNRCOD
              ELSE
                MOVE      "1",RCBNTTYP               * CAR 227986
                MOVE      WBIMHFND,RCBNRCOD
              ENDIF
            ENDIF
.
.           MOVE      WBIMHFND,RCBNRCOD
            MOVE      ZERO,RCBNSTAT
            MOVE      SP70,RCBNBDAT
            MOVE      SP70,RCBNBTIM
            MOVE      SP70,RCBNRDAT
            MOVE      SP70,RCBNRTIM
            PACK      RCBNCDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBNCDAT
            CLOCK     TIME,RCBNCTIM
            MOVE      WBSEUID,RCBNCUID
            MOVE      SP70,RCBNUDAT
              MOVE      SP70,RCBNUTIM
            MOVE      SP70,RCBNUUID
            MOVE      SP70,RCBNSPAR
.
            PACK      KEY12,HRECPT,SP70
            CALL      WRRCBNK1
.
          ELSE
.
            RJUSTIFY  WBEJBAMT
            UNPACK    WBEJBAMT,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       DIM10,FORM7P2C
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE
              MOVE      DIM10,FORM7P2C
            ENDIF
.
            ADD       FORM7P2C,RCBNTOTP
            CALL      UPRCBNK1
.
          ENDIF
.
. Write to rcpbdtaf
.
          PACK      KEY15,HRECPT,SP1,SP1,ONE,SP70
          CALL      RDRCBDT1
          IF        OVRCD = 1
.
            CALL      IBACLOCK
            PACK      RCBDTDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBDTDAT
            MOVE      HRECPT,RCBDRECN
            MOVE      "  1",RCBDUNIQ
            MOVE      WBEIHOSP,RCBDMHOS
            MOVE      CHOSPNUM,RCBDMDHS
            MOVE      "4",RCBDPTYP
            CALL      DDEP0000            * Get payment code for Direct Deposit
.
            RJUSTIFY  WBEJBAMT
            UNPACK    WBEJBAMT,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       DIM10,FORM7P2C
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE
              MOVE      DIM10,FORM7P2C
            ENDIF
            MOVE      FORM7P2C,RCBDPAMT
.
            MATCH     "HIC",WBEINAME
            IF        @EQUAL
              MOVE      "HIC",RCBDPAYD
            ELSE
              MATCH     "Services Australia",WBEINAME
              IF        @EQUAL
                MOVE      "Services Australia",RCBDPAYD
              ELSE
                MOVE      PARTPANT,RCBDPAYD
              ENDIF
            ENDIF
.
            MOVE      SP70,RCBDCHQN
            MOVE      WBEINAME,RCBDDRAW
            MOVE      WBEIBNAM,RCBDBANK
            MOVE      WBEIBBSB,RCBDBRCH
            MOVE      SP70,RCBDCRDT
            MOVE      WBEIPREF,RCBDSTRF
....        MOVE      SP70,RCBDMONM                                   *D-187485
            MOVE      SP70,RCBDEFTT
            CALL      IBACLOCK
            PACK      RCBDCDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBDCDAT
            CLOCK     TIME,RCBDCTIM
            MOVE      WBSEUID,RCBDCUID
            MOVE      SP70,RCBDUDAT
            MOVE      SP70,RCBDUTIM
            MOVE      SP70,RCBDUUID
            MOVE      SP70,RCBDSPAR
.
            PACK      KEY15,HRECPT,RCBDUNIQ,SP70
            CALL      WRRCBDT1
.
          ELSE
.
            RJUSTIFY  WBEJBAMT
            UNPACK    WBEJBAMT,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       DIM10,FORM7P2C
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE
              MOVE      DIM10,FORM7P2C
            ENDIF
.
            ADD       FORM7P2C,RCBDPAMT
            CALL      UPRCBDT1
.
          ENDIF
.
. Write to rcpdteaf
.
RPAM3500  PACK      KEY17,HRECPT,Z70
          CALL      RSRCDTE1
          CALL      RPRCDTE1
          IF        OVRCD = 1
            MOVE      "    1",RCDTTCNT
            CALL      WRRDTM00
          ELSE
            MOVE      HRECPT,DIM12
            MATCH     DIM12,RCDTRECN
            IF        !@EQUAL
              MOVE      "    1",RCDTTCNT
              CALL      WRRDTM00
            ELSE
              MOVE      RCDTTCNT,DIM5
              SQUEEZE   DIM5
              MOVE      ZERO,FORM5
              MOVE      DIM5,FORM5
              ADD       ONE,FORM5
              MOVE      FORM5,RCDTTCNT
.
              PACK      KEY17,HRECPT,RCDTTCNT,SP70
              CALL      RARCDTE1
              IF        OVRCD = 1
                CALL      WRRDTM00
              ELSE
                GOTO      RPAM3500
              ENDIF
            ENDIF
          ENDIF
.
.         Now "close" the current claim (providing that a processing report
.         has been received) and update the payment amount and
.         the payment date
.
          MOVE      WBEJARID,DIM20               * CAR 227986
          SQUEEZE   DIM20
.
          PACK      KEY56,WBIMTRID,PARTPANT,DIM20,Z70
          CALL      RSWBIMD2                     * position on trans. id
RPAM4000  CALL      RPWBIMD2                     * read previous record
          BRANCH    OVRCD,RPAM4500               * eof - no proc. report
.
          MATCH     WBIMTRID,WBIDTRID            * same claim trans. id ?
          GOTO      RPAM4500 IF NOT EQUAL        * no - no proc. report
.
          MATCH     PARTPANT,WBIDFBID            * same fund brand. id ?
          GOTO      RPAM4500 IF NOT EQUAL        * no - no proc. report
.
          MATCH     DIM20,WBIDARID               * same invoice number ?
          GOTO      RPAM4500 IF NOT EQUAL        * no - no proc. report
.
.         MATCH     ANSA,PRAHCFAC                * assessment code "A" ?
.         GOTO      RPAM4000 IF NOT EQUAL        * no - get next report
.
.         A processing report was found
.
          RJUSTIFY  WBEJBAMT
          UNPACK    WBEJBAMT,DIM7,DIM2           * set amount paid
          PACK      DIM10,DIM7,DOT,DIM2
          MOVE      ZERO,FORM7P2C
.
          SCAN      "-",DIM10
          IF        @EQUAL
            REP        "-0",DIM10
            MOVE       ZERO,FORM7P2C
            MOVE       DIM10,FORM7P2C
            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
          ELSE
            MOVE       DIM10,FORM7P2C
          ENDIF
.......
          MOVE      WBEJARID,DIM8
          RJUSTIFY  DIM8
.
          PACK      KEY22,DIM8,SP70
          CALL      RSPRDT4
          CALL      RKPRDT4
          BRANCH    OVRCD,RPAM4100
.
          MATCH     DIM8,PRDTINVN
          GOTO      RPAM4100 IF NOT EQUAL
.
          PACK      KEY27,DPRDTUNQ,PRDTPRAC,PRDTDOCT,PRDTCODE,SP70
          CALL      RDPRHR1
          BRANCH    OVRCD,RPAM4100
.
          MATCH     SP70,PRHRTACC
          GOTO      RPAM4100 IF EQUAL
.
          MOVE      "ta",CATEGORY
          MOVE      PRHRTACC,CODE
          CALL      GETCOD00     
.
          MATCH     "1",TCINDC1
          GOTO      RPAM4100 IF EQUAL
.
          MATCH     "2",TCINDC1
          GOTO      RPAM4100 IF EQUAL
.
          MATCH     "7",TCINDC1
          GOTO      RPAM4150 IF EQUAL
.
          MATCH     "6",TCINDC1
          IF        @EQUAL
            MATCH     "HIC",WBEINAME
            IF        @EQUAL          
              MOVE      FORM7P2C,WBIMAMMP
              COMPARE   ZERO,WBIMAMFP
              GOTO      RPAM4300 IF EQUAL
              GOTO      RPAM4200
            ELSE
              MATCH     "Services Australia",WBEINAME
              IF        @EQUAL
                MOVE      FORM7P2C,WBIMAMMP
                COMPARE   ZERO,WBIMAMFP
                GOTO      RPAM4300 IF EQUAL
                GOTO      RPAM4200
              ELSE
                MOVE      FORM7P2C,WBIMAMFP
                COMPARE   ZERO,WBIMAMMP
                GOTO      RPAM4300 IF EQUAL
                GOTO      RPAM4200
              ENDIF
            ENDIF
          ENDIF
......
RPAM4100  MOVE      FORM7P2C,WBIMAMFP
          GOTO      RPAM4200
.
RPAM4150  MOVE      FORM7P2C,WBIMAMMP
          GOTO      RPAM4200
.
RPAM4200  MOVE      TWENTY1,WBIMFLAG                * set status to closed
.
RPAM4300  PACK      WBIMSTAT,SP1,TWO             * set closed with payment
          MOVE      WBEJLDAT,WBIMPDAT            * set payment date 
.
          GOTO      RPAM4600
.
RPAM4500  RJUSTIFY  WBEJBAMT
          UNPACK    WBEJBAMT,DIM7,DIM2           * set amount paid
          PACK      DIM10,DIM7,DOT,DIM2
          MOVE      ZERO,FORM7P2C
.
          SCAN      "-",DIM10
          IF        @EQUAL
            REP        "-0",DIM10
            MOVE       ZERO,FORM7P2C
            MOVE       DIM10,FORM7P2C
            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
          ELSE
            MOVE       DIM10,FORM7P2C
          ENDIF
.....
          MOVE      WBEJARID,DIM8
          RJUSTIFY  DIM8
.
          PACK      KEY22,DIM8,SP70
          CALL      RSPRDT4
          CALL      RKPRDT4
          BRANCH    OVRCD,RPAM4550
.
          MATCH     DIM8,PRDTINVN
          GOTO      RPAM4550 IF NOT EQUAL
.
          PACK      KEY27,DPRDTUNQ,PRDTPRAC,PRDTDOCT,PRDTCODE,SP70
          CALL      RDPRHR1
          BRANCH    OVRCD,RPAM4550
.
          MATCH     SP70,PRHRTACC
          GOTO      RPAM4550 IF EQUAL
.
          MATCH     "1",TCINDC1
          GOTO      RPAM4550 IF EQUAL
.
          MATCH     "2",TCINDC1
          GOTO      RPAM4550 IF EQUAL
.
          MATCH     "7",TCINDC1
          GOTO      RPAM4560 IF EQUAL
.
          MATCH     "6",TCINDC1
          IF        @EQUAL
            MATCH     "HIC",WBEINAME
            IF        @EQUAL
              MOVE      FORM7P2C,WBIMAMMP
.             COMPARE   ZERO,WBIMAMFP
.             GOTO      RPAM4600 IF EQUAL
              GOTO      RPAM4570
            ELSE
              MATCH     "Services Australia",WBEINAME
              IF        @EQUAL
                MOVE      FORM7P2C,WBIMAMMP
.               COMPARE   ZERO,WBIMAMFP
.               GOTO      RPAM4600 IF EQUAL
                GOTO      RPAM4570
              ELSE
                MOVE      FORM7P2C,WBIMAMFP
.               COMPARE   ZERO,WBIMAMMP
.               GOTO      RPAM4600 IF EQUAL
                GOTO      RPAM4570
              ENDIF
            ENDIF
          ENDIF
.
RPAM4550  MOVE      FORM7P2C,WBIMAMFP
          GOTO      RPAM4570
.
RPAM4560  MOVE      FORM7P2C,WBIMAMMP
          GOTO      RPAM4570
.....
RPAM4570  PACK      WBIMSTAT,SP1,TWO             * set closed with payment
          MOVE      WBEJLDAT,WBIMPDAT            * set payment date
.
RPAM4600  CALL      UPWBIMC6                     * update claim
.
.         Finally, write an EDI History record (webimaaf)
.
          MOVE      WBIMINVN,WBIAINVN
          CALL      IBACLOCK
          PACK      WBIADATE,CCC,CYY,CMM,CDD
          REP       " 0",WBIADATE
          MOVE      CTIMEIS,WBIATIME
          MOVE      WBIMBATN,WBIABATN
          MOVE      WBIMFLAG,WBIASTAT
          MOVE      " 5",WBIATYPE
          MOVE      WBSEUID,WBIAOPER
          MOVE      WBIMTRID,WBIATRID
          MOVE      SP4,WBIAEROR
          MOVE      "Released",WBIAEROT
          PACK      WBIAEROT,WBIAEROT,SP70
          MOVE      SP70,WBIASPAR
.
RPAM5000  PACK      KEY26,WBIAINVN,WBIADATE,WBIATIME,WBIATYPE,SP70
          CALL      RAWBIMA1
          IF        OVRCD = 1
            CALL      WRWBIMA1
          ELSE
            CALL      IBACLOCK
            PACK      WBIADATE,CCC,CYY,CMM,CDD
            REP       " 0",WBIADATE
            MOVE      CTIMEIS,WBIATIME
            GOTO      RPAM5000
          ENDIF
.
.         Update the remittance table (weberdaf) to indicate that
.         the claim payment has been released to the relevant ibaPAS tables
.
          MOVE      TWO,WBEJSTAT                 * set as released
          CALL      UPWBERD1
.
.         MOVE      ONE,UNLKFLAG
.         CALL      UNLK0000                     * unlock all locked records
.
          MOVE      WBIMINVN,KEY8
          PROC      PRIUPURE              * Update Un-reconciled inv.file
.
          GOTO      RPAM1000
.
.*******************************************************************************
.         Now lock all the relevant records prior to releasing the payment.
.         Check that we can lock the Health Fund receipts record.
.
RPAM6000  
.         MOVE      "HFR",PRXCODE   * System Lock Audits
.         CALL      GETSLK00        * Get System Lock Audits
.
.         MOVE      PMEDARID,DIM8
.         RJUSTIFY  DIM8
.
.         PACK      KEY8,DIM8,SP70
.         CALL      RDHFRE1                      * lock record found ?
.         IF        OVRCD = 1
.           MOVE      ONE,HFRSTAT                * no - write one with lock
.           MOVE      DIM8,HFRINVR
.           CALL      WRHFRE1
.         ELSE
.           COMPARE   ZERO,HFRSTAT               * yes - is it already locked ?
.           IF        @EQUAL
.             MOVE      ONE,HFRSTAT              * no - lock now
.             CALL      UPHFRE1
.           ELSE
.             CALL      RELSLK00                 * Release System Lock Audits
.             GOTO      RPAM8000                 * record already locked
.           ENDIF
.         ENDIF
.         CALL      RELSLK00        * Release System Lock Audits
.
.         All the relevant records have been locked.
.         As there may be payments in this remittance for more than one
.         participant, check if the participant code has changed.  If it
.         has, then we need to get a new receipt number.
.
RPAM6100  MATCH     SAVEPART,PARTPANT            * same participant still ?
          IF        !@EQUAL
            CALL      ALLCRC00
.
            MOVE      PARTPANT,SAVEPART          * save new participant code
          ENDIF
.
          MOVE      HRECPT,TRECEIPT
.
          ADD       ONE,RELCOUNT
.
.         MOVE      ONE,PMECEETP
.         MATCH     "DVA",PMEDPART
.         IF        !@EQUAL
.           MOVE      ZERO,PMECEETP
.         ENDIF
.
          RJUSTIFY  WBEJBAMT
          UNPACK    WBEJBAMT,DIM7,DIM2           * set amount paid
          PACK      DIM10,DIM7,DOT,DIM2
          MOVE      ZERO,FORM7P2C
.
          SCAN      "-",DIM10
          IF        @EQUAL
            REP        "-0",DIM10
            MOVE       ZERO,FORM7P2C
            MOVE       DIM10,FORM7P2C
            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
          ELSE
            MOVE       DIM10,FORM7P2C
          ENDIF
.      
          MATCH     "HIC",WBEINAME
          IF        @EQUAL
            MOVE      FORM7P2C,WBIMAMMP
            ASSIGN    (PRINMAMT-WBIMAMMP),PRINMAMT
          ELSE
            MATCH     "Services Australia",WBEINAME
            IF        @EQUAL
              MOVE      FORM7P2C,WBIMAMMP
              ASSIGN    (PRINMAMT-WBIMAMMP),PRINMAMT
            ELSE
              MOVE      FORM7P2C,WBIMAMFP
              ASSIGN    (PRINHAMT-WBIMAMFP),PRINHAMT
            ENDIF
          ENDIF
.
. Write to rcpbnkaf
.
          PACK      KEY12,HRECPT,SP70
          CALL      RDRCBNK1
          IF        OVRCD=1
.
            MOVE      HRECPT,RCBNRECN
            CALL      IBACLOCK
            PACK      RCBNTDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBNTDAT
.
            RJUSTIFY  WBEJBAMT
            UNPACK    WBEJBAMT,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       ZERO,FORM7P2C
              MOVE       DIM10,FORM7P2C
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE
              MOVE       DIM10,FORM7P2C
            ENDIF
.
            MOVE      FORM7P2C,RCBNTOTP
            MOVE      RCCNERCD,RCBNCDRW
            MOVE      RCCNERCA,RCBNCHQA
            MOVE      WBEIHOSP,RCBNMHOS
.
            IF        IBCNMHOS=1
              MATCH     SP70,RCBNMHOS
              IF        !@EQUAL & !@EOS
                PACK      KEY3,RCBNMHOS,SP70
                CALL      RDPTHSP1
                IF        OVRCD=0
                  MATCH     SP70,PTHSERCD
                  IF        !@EQUAL & !@EOS
                    MOVE      PTHSERCD,RCBNCDRW
                  ENDIF
                  MATCH     SP70,PTHSERCA
                  IF        !@EQUAL & !@EOS
                    MOVE      PTHSERCA,RCBNCHQA
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
.
            MOVE      CHOSPNUM,RCBNMDHS
            MOVE      "1",RCBNTTYP               * CAR 227986
.
.           MOVE      PMECHFND,RCBNRCOD
.
            MOVE      SP70,RCBNRCOD
            MOVE      WBEJARID,DIM8
            RJUSTIFY  DIM8
.
            PACK      KEY22,DIM8,SP70
            CALL      RSPRDT4
            CALL      RKPRDT4
            IF        OVRCD=0
              MATCH     DIM8,PRDTINVN
              IF        @EQUAL
                PACK      KEY8,DPRDTUNQ,SP70
                CALL      RDPRHD2
                IF        OVRCD=0
                  MOVE      PRHDHFND,RCBNRCOD
                ENDIF
              ENDIF
            ENDIF
.        
            MOVE      ZERO,RCBNSTAT
            MOVE      SP70,RCBNBDAT
            MOVE      SP70,RCBNBTIM
            MOVE      SP70,RCBNRDAT
            MOVE      SP70,RCBNRTIM
            PACK      RCBNCDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBNCDAT
            CLOCK     TIME,RCBNCTIM
            MOVE      WBSEUID,RCBNCUID
            MOVE      SP70,RCBNUDAT
              MOVE      SP70,RCBNUTIM
            MOVE      SP70,RCBNUUID
            MOVE      SP70,RCBNSPAR
.
            PACK      KEY12,HRECPT,SP70
            CALL      WRRCBNK1
.
          ELSE
.
            RJUSTIFY  WBEJBAMT
            UNPACK    WBEJBAMT,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       DIM10,FORM7P2C
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE
              MOVE      DIM10,FORM7P2C
            ENDIF
.
            ADD       FORM7P2C,RCBNTOTP
            CALL      UPRCBNK1
.
          ENDIF
.
. Write to rcpbdtaf
.
          PACK      KEY15,HRECPT,SP1,SP1,ONE,SP70
          CALL      RDRCBDT1
          IF        OVRCD = 1
.
            CALL      IBACLOCK
            PACK      RCBDTDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBDTDAT
            MOVE      HRECPT,RCBDRECN
            MOVE      "  1",RCBDUNIQ
            MOVE      WBEIHOSP,RCBDMHOS
            MOVE      CHOSPNUM,RCBDMDHS
            MOVE      "4",RCBDPTYP
            CALL      DDEP0000            * Get payment code for Direct Deposit
.
            RJUSTIFY  WBEJBAMT
            UNPACK    WBEJBAMT,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       DIM10,FORM7P2C
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE
              MOVE      DIM10,FORM7P2C
            ENDIF
            MOVE      FORM7P2C,RCBDPAMT
.
            MATCH     "HIC",WBEINAME
            IF        @EQUAL
              MOVE      "HIC",RCBDPAYD
            ELSE
              MATCH     "Services Australia",WBEINAME
              IF        @EQUAL
                MOVE      "Services Australia",RCBDPAYD
              ELSE
                MOVE      PARTPANT,RCBDPAYD
              ENDIF
            ENDIF
.
            MOVE      SP70,RCBDCHQN
            MOVE      WBEINAME,RCBDDRAW
            MOVE      WBEIBNAM,RCBDBANK
            MOVE      WBEIBBSB,RCBDBRCH
            MOVE      SP70,RCBDCRDT
            MOVE      WBEIPREF,RCBDSTRF
....        MOVE      SP70,RCBDMONM                                   *D-187485
            MOVE      SP70,RCBDEFTT
            CALL      IBACLOCK
            PACK      RCBDCDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBDCDAT
            CLOCK     TIME,RCBDCTIM
            MOVE      WBSEUID,RCBDCUID
            MOVE      SP70,RCBDUDAT
            MOVE      SP70,RCBDUTIM
            MOVE      SP70,RCBDUUID
            MOVE      SP70,RCBDSPAR
.
            PACK      KEY15,HRECPT,RCBDUNIQ,SP70
            CALL      WRRCBDT1
.
          ELSE
.
            RJUSTIFY  WBEJBAMT
            UNPACK    WBEJBAMT,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       DIM10,FORM7P2C
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE
              MOVE      DIM10,FORM7P2C
            ENDIF
.
            ADD       FORM7P2C,RCBDPAMT
            CALL      UPRCBDT1
.
          ENDIF
.
. Write to rcpdteaf
.
RPAM6500  PACK      KEY17,HRECPT,Z70
          CALL      RSRCDTE1
          CALL      RPRCDTE1
          IF        OVRCD = 1
            MOVE      "    1",RCDTTCNT
            CALL      WRRDTS00
          ELSE
            MOVE      HRECPT,DIM12
            MATCH     DIM12,RCDTRECN
            IF        !@EQUAL
              MOVE      "    1",RCDTTCNT
              CALL      WRRDTS00
            ELSE
              MOVE      RCDTTCNT,DIM5
              SQUEEZE   DIM5
              MOVE      ZERO,FORM5
              MOVE      DIM5,FORM5
              ADD       ONE,FORM5
              MOVE      FORM5,RCDTTCNT
.
              PACK      KEY17,HRECPT,RCDTTCNT,SP70
              CALL      RARCDTE1
              IF        OVRCD = 1
                CALL      WRRDTS00
              ELSE
                GOTO      RPAM6500
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      THREE,WBEJSTAT          * set as released to suspense acc
          CALL      UPWBERD1
.
.         MOVE      THREE,UNLKFLAG
.         CALL      UNLS0000
.
          GOTO      RPAM1000
.*******************************************************************************
.
.         A record was locked for this claim, so set the status to "locked"
.
RPAM8000  MOVE      "1",WBEJSTAT
          CALL      UPWBERD1
          GOTO      RPAM1000
.
.         Check if all the payment records for the ERAW were released and
.         update the ERAW header status accordingly.
.
RPAM9000  IF        ERDCOUNT = (PRLCOUNT+RELCOUNT)
            MOVE      "2",WBEISTAT               * set to "released"
          ELSE
            MOVE      "1",WBEISTAT               * set to "partial"

          ENDIF
          CALL      UPWBERH1
.
          IF        IBCNMHOS=1
            MATCH     "2",WBEISTAT
            IF        @EQUAL
              CALL      CDERA000
            ENDIF
          ENDIF
.
.         Unlock general records.
.
          MATCH     "1",MULTLT01
          IF        @EQUAL
            MOVE      "2",DIM1C
            PACK      REMITKEY,WBEIHOSP,WBEIFTID,WBEIRADV,WBEIPNUM,SP70
            CALL      PRNRMM00
          ENDIF
.
          MATCH     "1",WBEISTAT
          IF        @EQUAL
            MOVE      "Payment record partially released.",WEBTITLE
          ELSE
            MOVE      "Payment record released.",WEBTITLE
          ENDIF
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RPAM9999
.
RPAM9950  MOVE      "Remittance Currently being processed.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RPAM9999
.
RPAM9960  MOVE      "Cannot find weberhaf record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RPAM9999
.
RPAM9999  RETURN
+
.*****************************************************************************
.*                                 LTMM0000        Called by: RPAY0000       *
.*    Load the temp file with the weberdaf records which correspond to the   *
.*    selected weberhaf record.                                              *
.*    We need to use the temp file so that we can sort by participant code.  *
.*    Some health fund groups (e.g. BUPA), may send payments in a single     *
.*    remittance, relating to more than one participant (e.g HBA & MBF).     *
.*    When processing the payments, a receipt number needs to be generated   *
.*    for each participant.                                                  *
.* Requires:  Valid read on pmserhaf record                                  *
.*            ERDCOUNT - initialised to zero                                 *
.* Returns:   ERDCOUNT - total number of weberdaf records related to the     *
.*                       selected remittance.                                *
.*****************************************************************************
.
LTMM0000  PACK      KEY82,WBEIFTID,WBEIRADV,WBEIPNUM,SP30,SP30,SP30
          CALL      RSWBERD1                     * position in file
LTMM0500  CALL      RKWBERD1                     * read next record
          BRANCH    OVRCD,LTMM9999               * end of file
.
          MATCH     WBEIFTID,WBEJFTID            * same fund trans. id still ?
          GOTO      LTMM9999 IF NOT EQUAL        * no - finished ERA
.
          MATCH     WBEIRADV,WBEJRADV            * same remittance advice still?
          GOTO      LTMM9999 IF NOT EQUAL        * no - finished ERA
.
          MATCH     WBEIPNUM,WBEJPNUM            * same part number still ?
          GOTO      LTMM9999 IF NOT EQUAL        * no - finished ERA
.
          ADD       ONE,ERDCOUNT                 * increment pmserdaf count
.
.         A payment requiring releasing has been found, so get the
.         corresponding webimcaf record.
.
          PACK      KEY40,WBEJTRID,SP30,SP10
          CALL      RSWBIMC6                     * position on trans. id/invoice
          CALL      RKWBIMC6                     * read next record
          BRANCH    OVRCD,LTMM1100               * eof
.
          MATCH     WBEJTRID,WBIMTRID            * same transaction id still ?
          GOTO      LTMM1500 IF EQUAL            * yes
.
LTMM1100
.         DISPLAY   *P1:24,*EL,*B,"Missing webimcaf record for ":
.                   *V2LON,WBEJTRID,*HOFF,".  ";
.         CALL      HITENTER
          GOTO      LTMM3000
.
.
.         Get the participant code for the claim
.
LTMM1500  MOVE      SP70,PARTPANT             * default part. to DVA
.         BRANCH    WBIMEETP,LTMM5000            * DVA claim
          MATCH     "2",WBIMEETP
          GOTO      LTMM5000 IF EQUAL
.
.         This is a Health Fund claim
.
          PACK      KEY14,WBIMHFND,ZERO,ZERO,ZERO,ZERO,SP20
          CALL      RDFUND1
          IF        OVRCD = 1
.           DISPLAY   *P1:24,*EL,*B,"Missing patfundf record for ":
.                     *V2LON,WBIMHFND,*HOFF,".  ";
.           CALL      HITENTER
            GOTO      LTMM8000
          ENDIF
.
          MOVE      "02",KEY2                  * check HF history for HF Group
          PACK      KEY17,WBIMHFND,KEY2,SP70
          CALL      PATDDHRD
.
          PACK      KEY6,WBIMHFND,SP70
          CALL      RDPTFX11
          IF        OVRCD=1
            GOTO      LTMM2000
          ENDIF
.
          MATCH     SP3,PTFXECLP
          GOTO      LTMM2000 IF EQUAL
          GOTO      LTMM2000 IF EOS
.
          MOVE      PTFXECLP,PARTPANT
          GOTO      LTMM5000
.
.         The health fund group equates to the participant
.
LTMM2000  MATCH     SP3,PTHFHGRP
          IF        @EQUAL
.           DISPLAY   *P1:24,*EL,*B,"Participant code blank for ":
.                     *V2LON,WBIMHFND,*HOFF,".  ";
.           CALL      HITENTER
            GOTO      LTMM8000
          ENDIF
          MOVE      PTHFHGRP,PARTPANT            * load participant code
          GOTO      LTMM5000
.
LTMM3000  MOVE      SP70,PRHDHFND
.
          MOVE      WBEJARID,KEY8
          RJUSTIFY  KEY8
          PACK      KEY8,KEY8,SP70
          CALL      RDPRIN1
          COMPARE   OVRCD,ONE
          GOTO      LTMM3500 IF EQUAL
.
          MATCH     SP70,DPRINUNQ
          GOTO      LTMM8000 IF EQUAL
          GOTO      LTMM8000 IF EOS
.
          PACK      KEY8,DPRINUNQ,SP70
          CALL      RDPRHD2
          IF        OVRCD=1
            GOTO      LTMM8000
          ENDIF
.
.         Get the participant code for the claim
.
LTMM3500  
.         MOVE      CVETINS,PARTPANT
.         PACK      KEY5,ANSC,ANSL,ACLAIM
.         CALL      RDCODE1
.         IF        OVRCD=0
.           MOVE      ZERO,FORM1
.           WHILE     FORM1 < 5
.             ADD       ONE,FORM1
.             LOAD      ANS,FORM1,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
.             MATCH     ANSV,ANS
.             IF        @EQUAL
.               GOTO      LTMM5000
.             ENDIF
.           DO
.         ENDIF
.
          MATCH     SP70,PRHDHFND
          GOTO      LTMM8000 IF EQUAL
          GOTO      LTMM8000 IF EOS
.
.         This is a health fund claim
.
          PACK      KEY14,PRHDHFND,ZERO,ZERO,ZERO,ZERO,SP20
          CALL      RDFUND1
          IF        OVRCD=1
            GOTO      LTMM8000
          ENDIF
.
          MOVE      "02",KEY2                  * check HF history for HF Group
          PACK      KEY17,PRHDHFND,KEY2,SP70
          CALL      PATDDHRD
.
          PACK      KEY6,PRHDHFND,SP70
          CALL      RDPTFX11
          IF        OVRCD=1
            GOTO      LTMM4000
          ENDIF
.
          MATCH     SP3,PTFXECLP
          GOTO      LTMM4000 IF EQUAL
          GOTO      LTMM4000 IF EOS
.
          MOVE      PTFXECLP,PARTPANT
          GOTO      LTMM5000
.
.         The health fund group equates to the participant
.
LTMM4000  MATCH     SP3,PTHFHGRP
          IF        @EQUAL
            GOTO      LTMM8000
          ENDIF
.
          MOVE      PTHFHGRP,PARTPANT
          GOTO      LTMM5000
.
.         Write the weberdaf details to the temp file
.
LTMM5000  CALL      WRTEMP1
          GOTO      LTMM0500                     * get next payment
.
.         There was a problem processing this record, so set the weberdaf
.         payment status to "locked"
.
LTMM8000  MOVE      "1",WBEJSTAT
          CALL      UPWBERD1
          GOTO      LTMM0500
.
LTMM9999  RETURN
+
.---------------------------------------------------------------------------
.         WRRDTM00 - Write to rcpdteaf
.---------------------------------------------------------------------------
.
WRRDTM00  CALL      IBACLOCK
          PACK      RCDTTDAT,CCC,CYY,CMM,CDD
          REP       " 0",RCDTTDAT
          MOVE      HRECPT,RCDTRECN
.         MOVE      "    1",RCDTTCNT
.         MOVE      WBEJARID,RCDTINVN
          PACK      RCDTINVN,WBEJARID,SP70
          RJUSTIFY  RCDTINVN
          MOVE      WBIMUNIQ,RCDTVIST
          MOVE      WBIMURNO,RCDTURNO
          MOVE      WBIMURNO,KEY8
          CALL      RDMAST1
          IF        OVRCD = 0
            MOVE      PSNAME,PACSNAME
            MOVE      PGNAME,PACGNAME
            MOVE      PTITL,PACTITLE
            MOVE      TWO,PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,RCDTNAME
            MOVE      PADD1,RCDTADD1
            MOVE      PADD2,RCDTADD2
            MOVE      PSUBRB,RCDTADD3
            MOVE      PADD4,RCDTADD4
            MOVE      PPOST,RCDTPOST
          ELSE
            MOVE      SP70,RCDTNAME
            MOVE      SP70,RCDTADD1
            MOVE      SP70,RCDTADD2
            MOVE      SP70,RCDTADD3
            MOVE      SP70,RCDTADD4
            MOVE      SP70,RCDTPOST
          ENDIF
          MOVE      SP70,RCDTSFLG
          MOVE      WBEIPREF,RCDTREFR
          MOVE      WBEIHOSP,RCDTMHOS
.
.         MOVE      RCCNERRE,RCDTREGI
.         IF        IBCNMHOS=1
.
.           MATCH     SP70,RCDTMHOS
.           IF        !@EQUAL & !@EOS
.             PACK      KEY3,RCDTMHOS,SP70
.             CALL      RDPTHSP1
.             IF        OVRCD=0
.               MATCH     SP70,PTHSERRE
.               IF        !@EQUAL & !@EOS
.                 MOVE      PTHSERRE,RCDTREGI
.               ENDIF
.             ENDIF
.           ENDIF
.
.           MATCH     SP70,WBIMHOSP
.           IF        !@EQUAL & !@EOS
.             PACK      KEY3,WBIMHOSP,SP70
.             CALL      RDPTHSP1
.             IF        OVRCD=0
.               MATCH     SP70,PTHSERRE
.               IF        !@EQUAL & !@EOS
.                 MOVE      PTHSERRE,RCDTREGI
.                 MOVE      WBIMHOSP,RCDTMHOS
.               ENDIF
.             ENDIF
.           ENDIF
.         ENDIF
.
          MOVE      SP70,RCDTREGI
.
          MOVE      WBEJARID,DIM8
          RJUSTIFY  DIM8
.
          PACK      KEY22,DIM8,SP70
          CALL      RSPRDT4
          CALL      RKPRDT4
          IF        OVRCD=0
            MATCH     DIM8,PRDTINVN
            IF        @EQUAL
              PACK      KEY27,PRDTUNIQ,PRDTPRAC,PRDTDOCT,PRDTCODE,Sp70
              CALL      RDPRHR1
              IF        OVRCD=0
                MATCH     SP70,PRHRPRAC
                IF        !@EQUAL
                  PACK      KEY6,PRHRPRAC,SP70
                  CALL      RDPRPR1   
                  IF        OVRCD=0
                    MOVE      PRPRREGI,RCDTREGI
                    MATCH     SP70,PRPRREGI
                    IF        !@EQUAL
                      PACK      KEY3,PRPRREGI,SP70
                      CALL      RDREGA1
                      IF        OVRCD=0
                        MATCH     SP70,REGHOSP
                        IF        !@EQUAL
                          MOVE      REGHOSP,RCDTMHOS
                        ENDIF
                      ENDIF
                    ENDIF
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      SP70,RCDTGSTC
          CALL      GTACCT00
.
          RJUSTIFY  WBEJBAMT
          UNPACK    WBEJBAMT,DIM7,DIM2
          PACK      DIM10,DIM7,FULLSTOP,DIM2
          MOVE      ZERO,FORM7P2C
.
          SCAN      "-",DIM10
          IF        @EQUAL
            REP        "-0",DIM10
            MOVE       DIM10,FORM7P2C
            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
          ELSE
            MOVE      DIM10,FORM7P2C
          ENDIF
          MOVE      FORM7P2C,RCDTAMNT
.
          MOVE      ZERO,RCDTDISC
          MOVE      CHOSPNUM,RCDTMDHS
          MOVE      SP70,RCDTGSTA
          MOVE      SP70,RCDTALLO
          CALL      IBACLOCK
.         PACK      RCDTRELD,CCC,CYY,CMM,CDD
.         REP       " 0",RCDTRELD
.         MOVE      CTIMEIS,RCDTRELT
          MOVE      SP70,RCDTRELD
          MOVE      SP70,RCDTRELT
          PACK      RCDTCDAT,CCC,CYY,CMM,CDD
          REP       " 0",RCDTCDAT
          MOVE      SP70,RCDTPRAC
          MOVE      CTIMEIS,RCDTCTIM
          MOVE      WBSEUID,RCDTCUID
          MOVE      SP70,RCDTUDAT
          MOVE      SP70,RCDTUTIM
          MOVE      SP70,RCDTUUID
          MOVE      SP70,RCDTDPTY
          MOVE      SP70,RCDTGLEX
          MOVE      WBIMBATN,RCDTBATN
          MOVE      SP70,RCDTSPAR
.
          PACK      KEY17,RCDTRECN,RCDTTCNT,SP70
          CALL      WRRCDTE1
.
WRRDTM99  RETURN
+
.*******************************************************************************
.                         Reload Page Skip Cache
.*******************************************************************************
RELSKC00  CALL      OPENHTML
          BRANCH    EXIT,RELSKC99
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "    alert(#" Hello World",WEBTITLE,"#");":
                             "    location.reload(true);":
                             "}":
                             "</script>"
          CALL      CLOSHTML
RELSKC99  RETURN
+
.------------------------------------------------------------------------------
. Close pmsetraf records called by RPAY0000
.------------------------------------------------------------------------------
DELET200  PACK      KEY51,SP1,TTYPEARG,SP70
          CALL      RSWBETR1
DELET210  CALL      RKWBETR1
          BRANCH    OVRCD,DELET299
.
          MATCH     SP70,WBETSTAT
          GOTO      DELET299 IF NOT EQUAL
.
          MATCH     TTYPEARG,WBETTYPE
          GOTO      DELET299 IF NOT EQUAL
.
          MATCH     WBEJTRID,WBETTRID
          GOTO      DELET210 IF NOT EQUAL
.
          MOVE      "1",WBETSTAT
.
          CALL       UPWBETR1
.
DELET299  RETURN
+
. Output Encounter FHIR JSON Response
.
FHRENC00  MOVE      "active",LCSTATUS
          MOVE      "arrived",ENSTATUS
          IF        ASTAT=4
            MOVE      "onleave",ENSTATUS
          ENDIF
          IF        STBYFLAG=1
            MOVE      "planned",LCSTATUS
          ENDIF
.
          CALL      GETCON00             
.
          MATCH     SP70,CONDESC
          IF        !@EQUAL
            UNPACK    LPCDATE,CCENT,CYEAR,CMON,CDAY
            PACK      DISPDATE,LBRACKT,CDAY,SLASH,CMON,SP1,LPCTIME,RBRACKT 
            STRIP     CONDESC
          ENDIF
.
          PACK      FHRENCID,URNUMBER,ADMISSNO,SP70
          PACK      FHRPATID,URNUMBER,SP70
          REP       "+-",FHRENCID
          REP       " -",FHRENCID
          REP       "+ ",FHRPATID
          SQUEEZE   FHRPATID
.
          CLEAR     FHRLOCC
          MATCH     SP70,WBED
          IF        @EQUAL
            APPEND    "Ward-",FHRLOCC
            APPEND    AWARD,FHRLOCC
          ELSE
            APPEND    "Bed-",FHRLOCC
            APPEND    WWARD,FHRLOCC
            APPEND    WBED,FHRLOCC
          ENDIF
          APPEND    SP70,FHRLOCC
          RESET     FHRLOCC
          STRIP     FHRLOCC
          REP       " -",FHRLOCC
.
          MOVE      SP70,FHRLOCN
          CALL      FBED0000
          MOVE      BEDTEXT,FHRLOCN
.
          MOVE      ENSTATUS,FHRSTAT     *  Encounter Status
          MOVE      "inpatient",FHRCLAS  *  Encounter Class
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MATCH     SP70,ATIME
          IF        @EQUAL
            PACK      FHRSTRDT,CCENT,CYEAR,FHRDASH,CMON,FHRDASH,CDAY
          ELSE
            UNPACK    ATIME,CHOUR,D1,CMIN,D1,KEY2
            REP       " 0",CHOUR
            REP       " 0",CMIN
            REP       " 0",KEY2
            PACK      ATIME,CHOUR,COLON,CMIN,COLON,KEY2
            PACK      FHRSTRDT,CCENT,CYEAR,FHRDASH,CMON,FHRDASH,CDAY,ANST,ATIME,TIMEZONE,SP70
          ENDIF
          MOVE      FORMATNM,FHRPATN  *  Patient Display Name
.
          CALL      GFRDOC00
.
          STRIP     ADIAG1
          STRIP     ADIAG2
          CLEAR     FHRREAS  
          APPEND    ADIAG1,FHRREAS 
          APPEND    SP1,FHRREAS 
          APPEND    ADIAG2,FHRREAS 
          RESET     FHRREAS
.
          MOVE      SP70,FHRUNITC
          MOVE      SP70,FHRUNITD
          MATCH     SP3,ACLSSFT
          IF        !@EQUAL
            MOVE      "AC",KEY2
            PACK      KEY5,KEY2,ACLSSFT
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      KEY5,FHRUNITC
              MOVE      TDESC,FHRUNITD
            ENDIF
          ENDIF
          STRIP     FHRUNITC
          STRIP     FHRUNITD
.
          IF        RECNUMB>0
            WRITE     HTMLFILE;",";
          ENDIF
          ADD       ONE,RECNUMB
.
          MOVE      "false",FHRVISA
          MATCH     "1",PMVXVALW
          IF        @EQUAL
            MOVE      "true",FHRVISA
          ENDIF
.
          MOVE      "false",FHRPHNA
          MATCH     "1",PMVXPALW
          IF        @EQUAL
            MOVE      "true",FHRPHNA
          ENDIF
.
          WRITE     HTMLFILE;*+,"{ #"fullUrl#" : #"%BASEURL/Encounter/",FHRENCID,"#", ":
..                    " #"extension#": [ {":
..                    "  #"url#" : #"%BASEURL/extension/webPASMetaData#",":
..                    "  #"extension#": [ ":
..                    "   {#"url#" : #"PMWOWDI1#", #"valueString#" : #"",PMWOWDI1,"#" },":
..                    "   {#"url#" : #"PMWOWDI2#", #"valueString#" : #"",PMWOWDI2,"#" },":
..                    "   {#"url#" : #"PMWOWDI3#", #"valueString#" : #"",PMWOWDI3,"#" },":
..                    "   {#"url#" : #"DESTDESC#", #"valueString#" : #"",DESTDESC,"#" },":
..                    "   {#"url#" : #"WORKDESC#", #"valueString#" : #"",WORKDESC,"#" },":
..                    "   {#"url#" : #"CONDESC#",  #"valueString#" : #"",CONDESC,DISPDATE,"#" },":
..                    "   {#"url#" : #"CONDESC1#", #"valueString#" : #"",CONDESC1,"#" },":
..                    "   {#"url#" : #"DIETDESC#", #"valueString#" : #"",DIETDESC,"#" },":
..                    "   {#"url#" : #"SPECDESC#", #"valueString#" : #"",SPECDESC,"#" }":
..                    "   ] }":
..                    "  ],":
                    " #"resource#": ";
          CALL     RESENC00            * FHIR Resource Encounter
          WRITE    HTMLFILE;*+,"}" 
.
          IF       FHRSUBIN=1 
            WRITE     HTMLFILE;*+,",{ #"fullUrl#" : #"%BASEURL/Patient/",FHRPATID,"#", ":
                      " #"resource#" : ";
            CALL     RESPAT00            * FHIR Resource Patient
            WRITE    HTMLFILE;*+,"}" 
          ENDIF
.
          RETURN
+
.--------------------------------------------------------------------------------
. Add Diagnosis Coding to Encounter 
. Not provided for the Encounters Resource Search by Location for performance
.--------------------------------------------------------------------------------
RESDIA00  
RESDIA99  RETURN
.--------------------------------------------------------------------------------
. Add Patient Contacts to FHIR Resource (NOT REQUIRED FOR PATWEB90 Patient Search)
. Function included to enable PATWEB90 to compile with FHRDATCD.
.--------------------------------------------------------------------------------
FHRCON00
FHRCON99  RETURN
.
.------------------------------------------------------------
. Get Doctors for FHIR Response.
.------------------------------------------------------------
GFRDOC00  CLEAR     FHRDOCC1
          APPEND    "HCP-",FHRDOCC1
          APPEND    ADOCTA,FHRDOCC1
          RESET     FHRDOCC1
          MOVE      "ADM",FHRDOCT1 *  Doctor Type
          MOVE      SDOCFNAM,FHRDOCN1
.
          MOVE      SP70,FHRDOCC2
          MOVE      SP70,FHRDOCT2
          MOVE      SP70,FHRDOCN2
          REP       "+ ",ADMISSNO
          MATCH     SP70,PMVXEDC1
          GOTO      GFRDOC99 IF EQUAL
.
          PACK     KEY24,ADMISSNO,Z70
          CALL     RSPMDTC1
GFRDOC10  CALL     RPPMDTC1
          BRANCH   OVRCD,GFRDOC20
          MATCH    ADMISSNO,PMDTVISN
          GOTO     GFRDOC20 IF NOT EQUAL
          MATCH    PMDTDOCT,PMVXEDC1
          GOTO     GFRDOC10 IF NOT EQUAL
          MATCH    PMDTUNIT,PMVXEDU1
          GOTO     GFRDOC10 IF NOT EQUAL
          MATCH    SP70,PMDTEDAT
          GOTO     GFRDOC20 IF EQUAL
.
          MOVE     SP70,KEY8A
          MOVE     PMDTETIM,KEY8A
          MATCH    SP70,KEY8A
          IF       @EQUAL
            PACK     KEY8A,ZERO,ZERO,COLON,ZERO,ZERO,COLON,ZERO,ZERO
          ENDIF
          PACK     KEY16,PMDTEDAT,KEY8A,SP70
          CALL     IBACLOCK
          PACK     KEY8,CCC,CYY,CMM,CDD
          REP      " 0",KEY8
          PACK     KEY16A,KEY8,CTIMEIS,SP70
          MATCH    KEY16A,KEY16
          GOTO     GFRDOC99 IF LESS
.
GFRDOC20  CLEAR    FHRDOCC2
          APPEND   "HCP-",FHRDOCC2
          APPEND   PMVXEDC1,FHRDOCC2
          RESET    FHRDOCC2
          MOVE     "CON",FHRDOCT2
          MOVE     SECDOCDE,FHRDOCN2
.
GFRDOC99  RETURN
.
.-----------------------------------------------------------
. Format ward/bed text for output 
.-----------------------------------------------------------
FWDBED00  CLEAR     WDBEDTXT
          CALL      STANDP00
          MATCH     SP70,AWARD
          GOTO      FWDBED99 IF EQUAL
.  
          PACK      KEY6,AWARD,SP70
          CALL      RDWARD1
          IF        OVRCD=1
            STRIP     AWARD
            APPEND    AWARD,WDBEDTXT
          ELSE    
            STRIP     PTWDSDES
            APPEND    PTWDSDES,WDBEDTXT
          ENDIF
          MATCH     SP70,ABED
          GOTO      FWDBED99 IF EQUAL
          APPEND    "/",WDBEDTXT
          PACK      KEY6,AWARD,ABED,SP70
          CALL      RDWARD1        
          BRANCH    OVRCD,FWDBED99
          IF        WBEDDESC > 0
            IF        WBEDDESC = 2 
              STRIP     PTWDSDES
              APPEND    PTWDSDES,WDBEDTXT   * use short bed text
            ELSE
              STRIP     WBDESC
              APPEND    WBDESC,WDBEDTXT      * use bed desc, not bed #
            ENDIF   
          ELSE
            STRIP    ABED
            APPEND   ABED,WDBEDTXT
          ENDIF
          MATCH     DWSTBY,ADMISSNO
          GOTO      FWDBED99 IF NOT EQUAL
          APPEND    " (s)",WDBEDTXT       * add standby ind. ' (s)'
          MOVE      "planned",LCSTATUS     * Location Status 
.
FWDBED99  APPEND    SP70,WDBEDTXT
          RESET     WDBEDTXT
          RETURN
.
.------------------------------------------------------------
. Checks for Patient on standby
.------------------------------------------------------------
STANDP00  PACK     KEY13,ABED,SP70
          PACK     KEY6,AWARD,SP70
          MATCH    SP70,AWARD
          IF       @EQUAL
            PACK      KEY14,AADMNO,SP70
            CALL      RDSWARD4
            CALL      RDKWARD4
            BRANCH    OVRCD,STANDP99
            MATCH     WSTBY,AADMNO
            GOTO      STANDP99 IF NOT EQUAL
            MOVE      WWARD,AWARD
            MOVE      WBED,ABED
            CLEAR     KEY10
            APPEND    SP1,KEY10
            APPEND    "(s)",KEY10
            RESET     KEY10
          ENDIF
          GOTO     STANDP99
.
STANDP99  RETURN
+
.------------------------------------------------------------------------------
. FHIR Encounter Resource Extra Type Related Data
.------------------------------------------------------------------------------
RESEXT00
RESEXT99  RETURN
.
.-----------------------------------------------------------------------------
.                                                                    *C-0837181
. If current Transfer record in pattranf has a Transfer Reason Cat RB code
. with indicator1="O" then display the parameter variable PTCNBTOD in the 
. overflow descrtiption
.-----------------------------------------------------------------------------
OVFDS000  MOVE      SP70,OVFLDESC
.
          MATCH     "1",PTCNBTRE                    * Collect transfer reason?
          GOTO      OVFDS999 IF NOT EQUAL           * No, exit
.
          MOVE      ADMISSNO,VISITNUM
          REP       "+ ",VISITNUM
.
          PACK      KEY30,VISITNUM,Z70
          CALL      RDSTRAN2                            * Positional Read
          CALL      RDPTRAN2                            * Read previous record
          BRANCH    OVRCD,OVFDS999
.
          MATCH     VISITNUM,DTADMN                     * Same visit?
          GOTO      OVFDS999 IF NOT EQUAL
.
          MATCH     SP70,PTTRTRTY                       * Transfer Reason set?
          GOTO      OVFDS999 IF EQUAL | @EOS
.
          PACK      KEY5,ANSR,ANSB,PTTRTRTY,SP70        * Check Category RB
          CALL      RDCODE1
          BRANCH    OVRCD,OVFDS999
.
          MATCH     ANSO,TCINDC1                        * Overflow ind on?
          GOTO      OVFDS999 IF NOT EQUAL
.
          CLEAR     OVFLDESC
          APPEND    BODMASFT,OVFLDESC
          APPEND    PTCNBTOD,OVFLDESC
          APPEND    ENDFONT,OVFLDESC
          RESET     OVFLDESC
.
OVFDS999  RETURN 
.
.------------------------------------------------------------
. Hospital Selection - List of Hospitals allowed to User
.------------------------------------------------------------
HSPSEL00  PACK      KEY3,SP70
          CALL      RSPTHSP1
HSPSEL10  CALL      RKPTHSP1
          BRANCH    OVRCD,HSPSEL99
.
          PACK      KEY13,USERID,SP70                * All hospital access
          CALL      RDMLSEC1
          IF        OVRCD=1
            PACK      KEY13,USERID,PTHSHOSP,SP70     * This hospital access
            CALL      RDMLSEC1
            BRANCH    OVRCD,HSPSEL10
          ENDIF
.
          MOVE      PTHSNAME,KEY50
          PACK      KEY5,QUOTE,PTHSHOSP,QUOTE
          MATCH     FILTHOSP,PTHSHOSP
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY5," selected>":
                               KEY50,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY5,">",KEY50,"</option>"
          ENDIF
          GOTO      HSPSEL10
.
HSPSEL99  RETURN
.
+
.--------------------------------------------------------------------------
.*                             PRNRMB00                                   *
.*               Schedule WebServices BBSW BPYW  Report (IBAWEB28)        *
.--------------------------------------------------------------------------
PRNRMB00  MOVE      "IBAWEB28",SCHDPGID
          MOVE      "WebServices BBSW BPYW Payment Report",SCHDDESC
          CALL      IBACLOCK
          PACK      SCHDDATE,CCC,CYY,CMM,CDD
          REP       " 0",SCHDDATE
          CLOCK     TIME,SCHDTIME
          MOVE      ONE,SCHDCOPY
          MOVE      "S  ",SCHDPRNT           * initialise to spool
          MATCH     SP70,SELPRINT
          IF        !@EQUAL
            MOVE      SELPRINT,SCHDPRNT      * printer code
          ENDIF
          MOVE      "IBAWEB28",SETDFPRG
          MOVE      "1",SETDFRPT
          CALL      SETDEF00                 * save default printer
.
.         Write Keyin parameters
.
          UNPACK    PAYMTKEY,KEY3,KEY8,KEY4,KEY8A,KEY24
          MOVE      KEY3,KEYSTARR[1]        * key for pmserhaf
          MOVE      KEY8,KEYSTARR[2]
          MOVE      KEY4,KEYSTARR[3]
          MOVE      KEY8A,KEYSTARR[4]
          MOVE      KEY24,KEYSTARR[5]
          MOVE      USERID,KEYSTARR[6]
          MOVE      DIM1C,KEYSTARR[7]
          MOVE      SEVEN,KEYSTCNT            * Number of Keyins
.
          CALL      SCHPRO00   * Schedule Extract
.
PRNRMB99  RETURN
+
.***************************************************************************
.*                             ERTH0000                                    *
.*   Set the hospital filter and call ERTM0000                             *
.*   If multi hospital call ERTM0000 for each of the users hositals        *
.***************************************************************************
.
ERTH0000  IF        IBCNMHOS<>1
            MOVE      SP70,FILTHOSP         * Not multi hospital so blank
            CALL      ERTM0000
            GOTO      ERTH9999
          ENDIF
.
.   Multi Hospital
.
          MATCH     SP70,FILTHOSP           * User has selected a hospital
          IF        !@EQUAL
            CALL      ERTM0000
            GOTO      ERTH9999
          ENDIF
.
          PACK      KEY3,SP70               * Show all users available
          CALL      RSPTHSP1                * hospitals
ERTH5000  CALL      RKPTHSP1
          BRANCH    OVRCD,ERTH9000
.
          PACK      KEY13,USERID,SP70                * All hospital access
          CALL      RDMLSEC1
          IF        OVRCD=1
            PACK      KEY13,USERID,PTHSHOSP,SP70     * This hospital access
            CALL      RDMLSEC1
            BRANCH    OVRCD,ERTH5000
          ENDIF
.
          MOVE      PTHSHOSP,FILTHOSP
          CALL      ERTM0000
.
          PACK      KEY3,FILTHOSP,SP70               * reposition
          CALL      RSPTHSP1
          GOTO      ERTH5000
.
ERTH9000  MOVE      SP70,FILTHOSP           * Restore all hospitals filter
.
ERTH9999  RETURN
+
.------------------------------------------------------------------------------
.  Redirect Parent URL
.------------------------------------------------------------------------------
PAREDR00  CALL      OPENHTML
          BRANCH    EXIT,PAREDR90
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             " alert(#"",WEBTITLE,"#");":
                             " parent.location.reload();":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      PAREDR99
.
PAREDR90  DISPLAY   "*** Fifo Not Found ***"
.
PAREDR99  RETURN
+
.------------------------------------------------------------
. WebServices ERAW JSON Details
.------------------------------------------------------------
EJSN0000  MATCH     "1",PTCNWSIN
          GOTO      EJSN9500 IF NOT EQUAL
.
          RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      EJSN5000 IF EQUAL
.
          GOTO      EJSN9000
.
EJSN5000  PACK      KEY51,ECCLSTRD,SP70
          CALL      RSWBETR4
          CALL      RKWBETR4
          BRANCH    OVRCD,EJSN9100
.
          MATCH     ECCLSTRD,WBETTRID
          GOTO      EJSN9100 IF NOT EQUAL
.
          MATCH     SP70,WBETSTRD
          GOTO      EJSN9200 IF EQUAL
.
          MATCH     SP70,WBETLOCN
          GOTO      EJSN9300 IF EQUAL
.
          PACK      KEY71,WBETLOCN,SP70
          CALL      RSWBB2B2
          CALL      RKWBB2B2 
          BRANCH    OVRCD,EJSN9400
.
          MATCH     WBETLOCN,WBB2LOCN
          GOTO      EJSN9400 IF NOT EQUAL
.
          MATCH     SP70,WBB2DPTH
          GOTO      EJSN9400 IF EQUAL
.
          CLEAR     WEBTITLE
          MOVE      "WebServices ERAW Details",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00
          BRANCH    EXIT,EJSN9999
.
          CALL      WEBBOD00
.
          CALL      WEBEND00
.
          MOVE      ONE,EXIT
          GOTO      EJSN9999
.
EJSN9000  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EJSN9999
.
EJSN9100  MOVE      "webetraf record not found.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EJSN9999
.
EJSN9200  MOVE      "webetraf.wbetstrd not found.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EJSN9999
.
EJSN9300  MOVE      "webetraf.wbetlocn not found.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EJSN9999
.
EJSN9400  MOVE      "B2B device path not found.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EJSN9999
.
EJSN9500  MOVE      "Not using WebServices Module.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      EJSN9999
.
EJSN9999  RETURN
+
.------------------------------------------------------------
. WebServices ERAW JSON Tags
.------------------------------------------------------------
.
EJST0000  BRANCH    FLDITMNO,EJST0100,EJST0200,EJST0300,EJST0400,EJST0500:
                             EJST0600,EJST0700,EJST0800,EJST0900,EJST1000:
                             EJST1100,EJST1200,EJST1300,EJST1400,EJST1500:
                             EJST1600,EJST1700,EJST1800,EJST1900,EJST2000:
                             EJST2100,EJST2200,EJST2300,EJST2400
                             
.
          GOTO      EJST9999
.
EJST0100  MATCH     SP70,WBB2DPTH
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"WebServices B2B Device directory not found.";
            GOTO      EJST9999
          ENDIF
.
          MATCH     SP70,WBETSTRD
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"Header properties file not found.";
            GOTO      EJST9999
          ENDIF
.
          CLEAR     CMDLINE
          APPEND    WBB2DPTH,CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    "/webPAS_claims/eraw/",CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    WBETSTRD,CMDLINE
          APPEND    PROPLITR,CMDLINE
          RESET     CMDLINE
.
          WRITE     HTMLFILE;CMDLINE;
          GOTO      EJST9999
.
EJST0200  CALL      ERAHED00
          GOTO      EJST9999
.
EJST0300  MATCH     SP70,WBB2DPTH
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"WebServices B2B Device directory not found.";
            GOTO      EJST9999
          ENDIF
.
          MATCH     SP70,WBETSTRD
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"JSON Request file not found.";
            GOTO      EJST9999
          ENDIF
.
          CLEAR     CMDLINE
          APPEND    WBB2DPTH,CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    "/webPAS_claims/eraw/",CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    WBETSTRD,CMDLINE
          APPEND    ERAWLITR,CMDLINE
          RESET     CMDLINE
.
          WRITE     HTMLFILE;CMDLINE;
          GOTO      EJST9999
.
EJST0400  CALL      ERAJSN00
          GOTO      EJST9999
.
EJST0500  MATCH     SP70,WBB2DPTH
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"WebServices B2B Device directory not found.";
            GOTO      EJST9999
          ENDIF
.
          MATCH     SP70,WBETSTRD
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"JSON Response file not found.";
            GOTO      EJST9999
          ENDIF
.
          CLEAR     CMDLINE
          APPEND    WBB2DPTH,CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    "/webPAS_claims/eraw/",CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    WBETSTRD,CMDLINE
          APPEND    ERARLITR,CMDLINE
          RESET     CMDLINE
.
          WRITE     HTMLFILE;CMDLINE;
          GOTO      EJST9999
.
EJST0600  CALL      ERARSP00
          GOTO      EJST9999
.
EJST0700  MATCH     SP70,WBB2DPTH
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"WebServices B2B Device directory not found.";
            GOTO      EJST9999
          ENDIF
.
          MATCH     SP70,WBETSTRD
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"Transmission log file not found.";
            GOTO      EJST9999
          ENDIF
.
          CLEAR     CMDLINE
          APPEND    WBB2DPTH,CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    "/webPAS_claims/eraw/",CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    WBETSTRD,CMDLINE
          APPEND    ERAELITR,CMDLINE
          RESET     CMDLINE
.
          WRITE     HTMLFILE;CMDLINE;
          GOTO      EJST9999
.
EJST0800  CALL      ERAERR00
          GOTO      EJST9999
.
EJST0900  MATCH     SP70,WBB2DPTH
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"WebServices B2B Device directory not found.";
            GOTO      EJST9999
          ENDIF
.
          MATCH     SP70,WBETSTRD
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"Header properties file not found.";
            GOTO      EJST9999
          ENDIF
.
          CLEAR     CMDLINE
          APPEND    WBB2DPTH,CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    "/webPAS_claims/bpyw/",CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    WBETSTRD,CMDLINE
          APPEND    PROPLITR,CMDLINE
          RESET     CMDLINE
.
          WRITE     HTMLFILE;CMDLINE;
          GOTO      EJST9999
.
EJST1000  CALL      BPYHED00
          GOTO      EJST9999
.
EJST1100  MATCH     SP70,WBB2DPTH
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"WebServices B2B Device directory not found.";
            GOTO      EJST9999
          ENDIF
.
          MATCH     SP70,WBETSTRD
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"JSON Request file not found.";
            GOTO      EJST9999
          ENDIF
.
          CLEAR     CMDLINE
          APPEND    WBB2DPTH,CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    "/webPAS_claims/bpyw/",CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    WBETSTRD,CMDLINE
          APPEND    BPYWLITR,CMDLINE
          RESET     CMDLINE
.
          WRITE     HTMLFILE;CMDLINE;
          GOTO      EJST9999
.
EJST1200  CALL      BPYJSN00
          GOTO      EJST9999
.
EJST1300  MATCH     SP70,WBB2DPTH
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"WebServices B2B Device directory not found.";
            GOTO      EJST9999
          ENDIF
.
          MATCH     SP70,WBETSTRD
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"JSON Response file not found.";
            GOTO      EJST9999
          ENDIF
.
          CLEAR     CMDLINE
          APPEND    WBB2DPTH,CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    "/webPAS_claims/bpyw/",CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    WBETSTRD,CMDLINE
          APPEND    BPYRLITR,CMDLINE
          RESET     CMDLINE
.
          WRITE     HTMLFILE;CMDLINE;
          GOTO      EJST9999
.
EJST1400  CALL      BPYRSP00
          GOTO      EJST9999
.
EJST1500  MATCH     SP70,WBB2DPTH
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"WebServices B2B Device directory not found.";
            GOTO      EJST9999
          ENDIF
.
          MATCH     SP70,WBETSTRD
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"Transmission log file not found.";
            GOTO      EJST9999
          ENDIF
.
          CLEAR     CMDLINE
          APPEND    WBB2DPTH,CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    "/webPAS_claims/bpyw/",CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    WBETSTRD,CMDLINE
          APPEND    BPYELITR,CMDLINE
          RESET     CMDLINE
.
          WRITE     HTMLFILE;CMDLINE;
          GOTO      EJST9999
.
EJST1600  CALL      BPYERR00
          GOTO      EJST9999
.
EJST1700  MATCH     SP70,WBB2DPTH
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"WebServices B2B Device directory not found.";
            GOTO      EJST9999
          ENDIF
.
          MATCH     SP70,WBETSTRD
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"Header properties file not found.";
            GOTO      EJST9999
          ENDIF
.
          CLEAR     CMDLINE
          APPEND    WBB2DPTH,CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    "/webPAS_claims/dvyw/",CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    WBETSTRD,CMDLINE
          APPEND    PROPLITR,CMDLINE
          RESET     CMDLINE
.
          WRITE     HTMLFILE;CMDLINE;
          GOTO      EJST9999
.
EJST1800  CALL      DVYHED00
          GOTO      EJST9999
.
EJST1900  MATCH     SP70,WBB2DPTH
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"WebServices B2B Device directory not found.";
            GOTO      EJST9999
          ENDIF
.
          MATCH     SP70,WBETSTRD
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"JSON Request file not found.";
            GOTO      EJST9999
          ENDIF
.
          CLEAR     CMDLINE
          APPEND    WBB2DPTH,CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    "/webPAS_claims/dvyw/",CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    WBETSTRD,CMDLINE
          APPEND    DVYWLITR,CMDLINE
          RESET     CMDLINE
.
          WRITE     HTMLFILE;CMDLINE;
          GOTO      EJST9999
.
EJST2000  CALL      DVYJSN00
          GOTO      EJST9999
.
EJST2100  MATCH     SP70,WBB2DPTH
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"WebServices B2B Device directory not found.";
            GOTO      EJST9999
          ENDIF
.
          MATCH     SP70,WBETSTRD
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"JSON Response file not found.";
            GOTO      EJST9999
          ENDIF
.
          CLEAR     CMDLINE
          APPEND    WBB2DPTH,CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    "/webPAS_claims/dvyw/",CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    WBETSTRD,CMDLINE
          APPEND    DVYRLITR,CMDLINE
          RESET     CMDLINE
.
          WRITE     HTMLFILE;CMDLINE;
          GOTO      EJST9999
.
EJST2200  CALL      DVYRSP00
          GOTO      EJST9999
.
EJST2300  MATCH     SP70,WBB2DPTH
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"WebServices B2B Device directory not found.";
            GOTO      EJST9999
          ENDIF
.
          MATCH     SP70,WBETSTRD
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"Transmission log file not found.";
            GOTO      EJST9999
          ENDIF
.
          CLEAR     CMDLINE
          APPEND    WBB2DPTH,CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    "/webPAS_claims/dvyw/",CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    WBETSTRD,CMDLINE
          APPEND    DVYELITR,CMDLINE
          RESET     CMDLINE
.
          WRITE     HTMLFILE;CMDLINE;
          GOTO      EJST9999
.
EJST2400  CALL      DVYERR00
          GOTO      EJST9999
.
EJST9999  RETURN
+
.---------------------------------------------------------------
. ERAW RTVW <tran id>.properties tag
.---------------------------------------------------------------
ERAHED00  MATCH     SP70,WBB2DPTH
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"WebServices B2B Device directory not found.";
            GOTO      ERAHED99
          ENDIF
.
          MATCH    SP70,WBETSTRD
          GOTO     ERAHED99 IF EQUAL
          GOTO     ERAHED99 IF EOS
.
          CLEAR     CMDLINE
          APPEND    WBB2DPTH,CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    "/webPAS_claims/eraw/",CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    WBETSTRD,CMDLINE
          APPEND    PROPLITR,CMDLINE
          RESET     CMDLINE
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PROPFILE,CMDLINE
          TRAPCLR   IO
          IF        OVRCD=1
            WRITE     HTMLFILE;"Can't&nbsp;read: ",CMDLINE;
            GOTO      ERAHED99
          ENDIF
.
ERAHED10  READ      PROPFILE,SEQ;PROPLINE
          GOTO      ERAHED99 IF OVER
.
          WRITE     HTMLFILE;PROPLINE
.
          GOTO      ERAHED10
.
ERAHED99  CLOSE     PROPFILE
.
          RETURN
+
.---------------------------------------------------------------
. ERAW RTVW <tran id>_erawrtvw  tag
.---------------------------------------------------------------
ERAJSN00  MATCH     SP70,WBB2DPTH
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"WebServices B2B Device directory not found.";
            GOTO      ERAJSN99
          ENDIF
.
          MATCH    SP70,WBETSTRD
          GOTO     ERAJSN99 IF EQUAL
          GOTO     ERAJSN99 IF EOS
.
          CLEAR     CMDLINE
          APPEND    WBB2DPTH,CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    "/webPAS_claims/eraw/",CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    WBETSTRD,CMDLINE
          APPEND    ERAWLITR,CMDLINE
          RESET     CMDLINE
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      ERAWFILE,CMDLINE
          TRAPCLR   IO
          IF        OVRCD=1
            WRITE     HTMLFILE;"Can't&nbsp;read: ",CMDLINE;
            GOTO      ERAJSN99
          ENDIF
.
ERAJSN10  READ      ERAWFILE,SEQ;ERAWLINE
          GOTO      ERAJSN99 IF OVER
.
          WRITE     HTMLFILE;ERAWLINE
.
          GOTO      ERAJSN10
.
ERAJSN99  CLOSE     ERAWFILE
.
          RETURN
+
.---------------------------------------------------------------
. ERAW RTVW <tran id>_erawrtvw_response  tag
.---------------------------------------------------------------
ERARSP00  MATCH     SP70,WBB2DPTH
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"WebServices B2B Device directory not found.";
            GOTO      ERARSP99
          ENDIF
.
          MATCH    SP70,WBETSTRD
          GOTO     ERARSP99 IF EQUAL
          GOTO     ERARSP99 IF EOS
.
          CLEAR     CMDLINE
          APPEND    WBB2DPTH,CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    "/webPAS_claims/eraw/",CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    WBETSTRD,CMDLINE
          APPEND    ERARLITR,CMDLINE
          RESET     CMDLINE
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      ERARFILE,CMDLINE
          TRAPCLR   IO
          IF        OVRCD=1
            WRITE     HTMLFILE;"Can't&nbsp;read: ",CMDLINE;
            GOTO      ERARSP99
          ENDIF
.
ERARSP10  READ      ERARFILE,SEQ;ERARLINE
          GOTO      ERARSP99 IF OVER
.
          WRITE     HTMLFILE;ERARLINE
.
          GOTO      ERARSP10
.
ERARSP99  CLOSE     ERARFILE
.
          RETURN
+
.---------------------------------------------------------------
. ERAW RTVW <tran id>_erawrtvw_errors  tag
.---------------------------------------------------------------
ERAERR00  MATCH     SP70,WBB2DPTH
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"WebServices B2B Device directory not found.";
            GOTO      ERAERR99
          ENDIF
.
          MATCH    SP70,WBETSTRD
          GOTO     ERAERR99 IF EQUAL
          GOTO     ERAERR99 IF EOS
.
          CLEAR     CMDLINE
          APPEND    WBB2DPTH,CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    "/webPAS_claims/eraw/",CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    WBETSTRD,CMDLINE
          APPEND    ERAELITR,CMDLINE
          RESET     CMDLINE
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      ERAEFILE,CMDLINE
          TRAPCLR   IO
          IF        OVRCD=1
            WRITE     HTMLFILE;"Can't&nbsp;read: ",CMDLINE;
            GOTO      ERAERR99
          ENDIF
.
ERAERR10  READ      ERAEFILE,SEQ;ERAELINE
          GOTO      ERAERR99 IF OVER
.
          WRITE     HTMLFILE;ERAELINE
.
          GOTO      ERAERR10
.
ERAERR99  CLOSE     ERAEFILE
.
          RETURN
+
.------------------------------------------------------------
. WebServices Transaction Requests JSON Details
.------------------------------------------------------------
TJSN0000  MATCH     "1",PTCNWSIN
          GOTO      TJSN9500 IF NOT EQUAL
.
          RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      TJSN5000 IF EQUAL
.
          GOTO      TJSN9000
.
TJSN5000  MATCH     SP70,ECCLSTRD
          GOTO      TJSN9200 IF EQUAL
.
          PACK      KEY75,ECCLSTRD,SP70
          CALL      RSWBETR5
TJSN5100  CALL      RKWBETR5
          BRANCH    OVRCD,TJSN9100
.
          MATCH     ECCLSTRD,WBETSTRD
          GOTO      TJSN9100 IF NOT EQUAL
.
          MATCH     SP70,ECCLTYPE
          IF        !@EQUAL
            MATCH     ECCLTYPE,WBETTYPE
            GOTO      TJSN5100 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,WBETLOCN
          GOTO      TJSN9300 IF EQUAL
.
          PACK      KEY71,WBETLOCN,SP70
          CALL      RSWBB2B2
          CALL      RKWBB2B2
          BRANCH    OVRCD,TJSN9400
.
          MATCH     WBETLOCN,WBB2LOCN
          GOTO      TJSN9400 IF NOT EQUAL
.
          MATCH     SP70,WBB2DPTH
          GOTO      TJSN9400 IF EQUAL
.
          CLEAR     WEBTITLE
          MOVE      "WebServices ERAW Details",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00
          BRANCH    EXIT,TJSN9999
.
          CALL      WEBBOD00
.
          CALL      WEBEND00
.
          MOVE      ONE,EXIT
          GOTO      TJSN9999
.
TJSN9000  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      TJSN9999
.
TJSN9100  MOVE      "webetraf record not found.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      TJSN9999
.
TJSN9200  MOVE      "webetraf.wbetstrd not found.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      TJSN9999
.
TJSN9300  MOVE      "webetraf.wbetlocn not found.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      TJSN9999
.
TJSN9400  MOVE      "B2B device path not found.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      TJSN9999
.
TJSN9500  MOVE      "Not using WebServices Module.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      TJSN9999
.
TJSN9999  RETURN
+
.------------------------------------------------------------
. WebServices Transaction Requests JSON Tags
.------------------------------------------------------------
.
TJST0000  BRANCH    FLDITMNO,TJST0100,TJST0200,TJST0300,TJST0400,TJST0500:
                             TJST0600,TJST0700,TJST0800

.
          GOTO      TJST9999
.
TJST0100  MATCH     SP70,WBB2DPTH
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"WebServices B2B Device directory not found.";
            GOTO      TJST9999
          ENDIF
.
          MATCH     SP70,WBETSTRD
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"Header properties file not found.";
            GOTO      TJST9999
          ENDIF
.
          CLEAR     CMDLINE
          APPEND    WBB2DPTH,CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
.
          CALL      ATRN0000
.
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    WBETSTRD,CMDLINE
          APPEND    PROPLITR,CMDLINE
          RESET     CMDLINE
.
          WRITE     HTMLFILE;CMDLINE;
          GOTO      TJST9999
.
TJST0200  CALL      TRNHED00
          GOTO      TJST9999
.
TJST0300  MATCH     SP70,WBB2DPTH
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"WebServices B2B Device directory not found.";
            GOTO      TJST9999
          ENDIF
.
          MATCH     SP70,WBETSTRD
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"JSON Request file not found.";
            GOTO      TJST9999
          ENDIF
.
          CLEAR     CMDLINE
          APPEND    WBB2DPTH,CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
.
          CALL      ATRN0000
.
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    WBETSTRD,CMDLINE
.
          CALL      ALTR0000
.
          RESET     CMDLINE
.
          WRITE     HTMLFILE;CMDLINE;
          GOTO      TJST9999
.
TJST0400  CALL      TRNJSN00
          GOTO      TJST9999
.
TJST0500  MATCH     SP70,WBB2DPTH
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"WebServices B2B Device directory not found.";
            GOTO      TJST9999
          ENDIF
.
          MATCH     SP70,WBETSTRD
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"JSON Response file not found.";
            GOTO      TJST9999
          ENDIF
.
          CLEAR     CMDLINE
          APPEND    WBB2DPTH,CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
.
          CALL      ATRN0000
.
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    WBETSTRD,CMDLINE
.
          CALL      ALRR0000
.
          RESET     CMDLINE
.
          WRITE     HTMLFILE;CMDLINE;
          GOTO      TJST9999
.
TJST0600  CALL      TRNRSP00
          GOTO      TJST9999
.
TJST0700  MATCH     SP70,WBB2DPTH
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"WebServices B2B Device directory not found.";
            GOTO      TJST9999
          ENDIF
.
          MATCH     SP70,WBETSTRD
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"Transmission log file not found.";
            GOTO      TJST9999
          ENDIF
.
          CLEAR     CMDLINE
          APPEND    WBB2DPTH,CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
.
          CALL      ATRN0000
.
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    WBETSTRD,CMDLINE
.
          CALL      ALER0000
.
          RESET     CMDLINE
.
          WRITE     HTMLFILE;CMDLINE;
          GOTO      TJST9999
.
TJST0800  CALL      TRNERR00
          GOTO      TJST9999
.
TJST9999  RETURN
+
.-----------------------------------------------------------------
. Append transaction request type to CMDLINE according to WBETTYPE
.-----------------------------------------------------------------
ATRN0000  MATCH     " 1",WBETTYPE
          IF        @EQUAL
            APPEND    "/webPAS_claims/ihcw/",CMDLINE
            GOTO      ATRN9999
          ENDIF
.
          MATCH     " 2",WBETTYPE
          IF        @EQUAL
            APPEND    "/webPAS_claims/gprw/",CMDLINE
            GOTO      ATRN9999
          ENDIF
.
          MATCH     " 3",WBETTYPE
          IF        @EQUAL
            APPEND    "/webPAS_claims/ihcw/",CMDLINE
            GOTO      ATRN9999
          ENDIF
.
          MATCH     " 4",WBETTYPE
          IF        @EQUAL
            APPEND    "/webPAS_claims/eraw/",CMDLINE
            GOTO      ATRN9999
          ENDIF
.
          MATCH     " 5",WBETTYPE
          IF        @EQUAL
            APPEND    "/webPAS_claims/eraw/",CMDLINE
            GOTO      ATRN9999
          ENDIF
.
          MATCH     " 9",WBETTYPE
          IF        @EQUAL
            APPEND    "/webPAS_claims/imcw/",CMDLINE
            GOTO      ATRN9999
          ENDIF
.
          MATCH     "10",WBETTYPE
          IF        @EQUAL
            APPEND    "/webPAS_claims/imcw/",CMDLINE
            GOTO      ATRN9999
          ENDIF
.
          MATCH     "11",WBETTYPE
          IF        @EQUAL
            APPEND    "/webPAS_claims/bprw/",CMDLINE
            GOTO      ATRN9999
          ENDIF
.
          MATCH     "12",WBETTYPE
          IF        @EQUAL
            APPEND    "/webPAS_claims/bpyw/",CMDLINE
            GOTO      ATRN9999
          ENDIF
.
          MATCH     "13",WBETTYPE
          IF        @EQUAL
            APPEND    "/webPAS_claims/imcw/",CMDLINE
            GOTO      ATRN9999
          ENDIF
.
          MATCH     "14",WBETTYPE
          IF        @EQUAL
            APPEND    "/webPAS_claims/imcw/",CMDLINE
            GOTO      ATRN9999
          ENDIF
.
          MATCH     "15",WBETTYPE
          IF        @EQUAL
            APPEND    "/webPAS_claims/ihcw/",CMDLINE
            GOTO      ATRN9999
          ENDIF
.
          MATCH     "16",WBETTYPE
          IF        @EQUAL
            APPEND    "/webPAS_claims/ihcw/",CMDLINE
            GOTO      ATRN9999
          ENDIF
.
          MATCH     "17",WBETTYPE
          IF        @EQUAL
            APPEND    "/webPAS_claims/eraw/",CMDLINE
            GOTO      ATRN9999
          ENDIF
.
          MATCH     "18",WBETTYPE
          IF        @EQUAL
            APPEND    "/webPAS_claims/imcw/",CMDLINE
            GOTO      ATRN9999
          ENDIF
.
          MATCH     "19",WBETTYPE
          IF        @EQUAL
            APPEND    "/webPAS_claims/ihcw/",CMDLINE
            GOTO      ATRN9999
          ENDIF
.
          MATCH     "20",WBETTYPE
          IF        @EQUAL
            APPEND    "/webPAS_claims/dvrw/",CMDLINE
            GOTO      ATRN9999
          ENDIF
.
          MATCH     "21",WBETTYPE
          IF        @EQUAL
            APPEND    "/webPAS_claims/dvyw/",CMDLINE
            GOTO      ATRN9999
          ENDIF
.
          APPEND    "/webPAS_claims/",CMDLINE
.
ATRN9999  RETURN
+
.-----------------------------------------------------------------
. Append transaction request keyword to CMDLINE according to WBETTYPE
.-----------------------------------------------------------------
ALTR0000  MATCH     " 1",WBETTYPE
          IF        @EQUAL
            APPEND    "_ihcwstsw",CMDLINE
            GOTO      ALTR9999
          ENDIF
.
          MATCH     " 2",WBETTYPE
          IF        @EQUAL
            APPEND    "_gprw",CMDLINE
            GOTO      ALTR9999
          ENDIF
.
          MATCH     " 3",WBETTYPE
          IF        @EQUAL
            APPEND    "_ihcwrtvw",CMDLINE
            GOTO      ALTR9999
          ENDIF
.
          MATCH     " 4",WBETTYPE
          IF        @EQUAL
            APPEND    "_erawstsw",CMDLINE
            GOTO      ALTR9999
          ENDIF
.
          MATCH     " 5",WBETTYPE
          IF        @EQUAL
            APPEND    "_erawrtvw",CMDLINE
            GOTO      ALTR9999
          ENDIF
.
          MATCH     " 9",WBETTYPE
          IF        @EQUAL
            APPEND    "_imcwstsw",CMDLINE
            GOTO      ALTR9999
          ENDIF
.
          MATCH     "10",WBETTYPE
          IF        @EQUAL
            APPEND    "_imcwrtvw",CMDLINE
            GOTO      ALTR9999
          ENDIF
.
          MATCH     "11",WBETTYPE
          IF        @EQUAL
            APPEND    "_bprw",CMDLINE
            GOTO      ALTR9999
          ENDIF
.
          MATCH     "12",WBETTYPE
          IF        @EQUAL
            APPEND    "_bpyw",CMDLINE
            GOTO      ALTR9999
          ENDIF
.
          MATCH     "13",WBETTYPE
          IF        @EQUAL
            APPEND    "_imcwstsw",CMDLINE
            GOTO      ALTR9999
          ENDIF
.
          MATCH     "14",WBETTYPE
          IF        @EQUAL
            APPEND    "_imcwrtvw",CMDLINE
            GOTO      ALTR9999
          ENDIF
.
          MATCH     "15",WBETTYPE
          IF        @EQUAL
            APPEND    "_ihcwstsw",CMDLINE
            GOTO      ALTR9999
          ENDIF
.
          MATCH     "16",WBETTYPE
          IF        @EQUAL
            APPEND    "_ihcwrtvw",CMDLINE
            GOTO      ALTR9999
          ENDIF
.
          MATCH     "17",WBETTYPE
          IF        @EQUAL
            APPEND    "_erawrtvw",CMDLINE
            GOTO      ALTR9999
          ENDIF
.
          MATCH     "18",WBETTYPE
          IF        @EQUAL
            APPEND    "_imcwstsw",CMDLINE
            GOTO      ALTR9999
          ENDIF
.
          MATCH     "19",WBETTYPE
          IF        @EQUAL
            APPEND    "_ihcwstsw",CMDLINE
            GOTO      ALTR9999
          ENDIF
.
          MATCH     "20",WBETTYPE
          IF        @EQUAL
            APPEND    "_dvrw",CMDLINE
            GOTO      ALTR9999
          ENDIF
.
          MATCH     "21",WBETTYPE
          IF        @EQUAL
            APPEND    "_dvyw",CMDLINE
            GOTO      ALTR9999
          ENDIF
.
ALTR9999  RETURN
+
.-----------------------------------------------------------------
. Append transaction request response to CMDLINE according to WBETTYPE
.-----------------------------------------------------------------
ALRR0000  MATCH     " 1",WBETTYPE
          IF        @EQUAL
            APPEND    "_ihcwstsw_response",CMDLINE
            GOTO      ALRR9999
          ENDIF
.
          MATCH     " 2",WBETTYPE
          IF        @EQUAL
            APPEND    "_gprw_response",CMDLINE
            GOTO      ALRR9999
          ENDIF
.
          MATCH     " 3",WBETTYPE
          IF        @EQUAL
            APPEND    "_ihcwrtvw_response",CMDLINE
            GOTO      ALRR9999
          ENDIF
.
          MATCH     " 4",WBETTYPE
          IF        @EQUAL
            APPEND    "_erawstsw_response",CMDLINE
            GOTO      ALRR9999
          ENDIF
.
          MATCH     " 5",WBETTYPE
          IF        @EQUAL
            APPEND    "_erawrtvw_response",CMDLINE
            GOTO      ALRR9999
          ENDIF
.
          MATCH     " 9",WBETTYPE
          IF        @EQUAL
            APPEND    "_imcwstsw_response",CMDLINE
            GOTO      ALRR9999
          ENDIF
.
          MATCH     "10",WBETTYPE
          IF        @EQUAL
            APPEND    "_imcwrtvw_response",CMDLINE
            GOTO      ALRR9999
          ENDIF
.
          MATCH     "11",WBETTYPE
          IF        @EQUAL
            APPEND    "_bprw_response",CMDLINE
            GOTO      ALRR9999
          ENDIF
.
          MATCH     "12",WBETTYPE
          IF        @EQUAL
            APPEND    "_bpyw_response",CMDLINE
            GOTO      ALRR9999
          ENDIF
.
          MATCH     "13",WBETTYPE
          IF        @EQUAL
            APPEND    "_imcwstsw_response",CMDLINE
            GOTO      ALRR9999
          ENDIF
.
          MATCH     "14",WBETTYPE
          IF        @EQUAL
            APPEND    "_imcwrtvw_response",CMDLINE
            GOTO      ALRR9999
          ENDIF
.
          MATCH     "15",WBETTYPE
          IF        @EQUAL
            APPEND    "_ihcwstsw_response",CMDLINE
            GOTO      ALRR9999
          ENDIF
.
          MATCH     "16",WBETTYPE
          IF        @EQUAL
            APPEND    "_ihcwrtvw_response",CMDLINE
            GOTO      ALRR9999
          ENDIF
.
          MATCH     "17",WBETTYPE
          IF        @EQUAL
            APPEND    "_erawrtvw_response",CMDLINE
            GOTO      ALRR9999
          ENDIF
.
          MATCH     "18",WBETTYPE
          IF        @EQUAL
            APPEND    "_imcwstsw_response",CMDLINE
            GOTO      ALRR9999
          ENDIF
.
          MATCH     "19",WBETTYPE
          IF        @EQUAL
            APPEND    "_ihcwstsw_response",CMDLINE
            GOTO      ALRR9999
          ENDIF
.
          MATCH     "20",WBETTYPE
          IF        @EQUAL
            APPEND    "_dvrw_response",CMDLINE
            GOTO      ALRR9999
          ENDIF
.
          MATCH     "21",WBETTYPE
          IF        @EQUAL
            APPEND    "_dvyw_response",CMDLINE
            GOTO      ALRR9999
          ENDIF
.
ALRR9999  RETURN
+
.-----------------------------------------------------------------
. Append transaction request errors to CMDLINE according to WBETTYPE
.-----------------------------------------------------------------
ALER0000  MATCH     " 1",WBETTYPE
          IF        @EQUAL
            APPEND    "_ihcwstsw_errors",CMDLINE
            GOTO      ALER9999
          ENDIF
.
          MATCH     " 2",WBETTYPE
          IF        @EQUAL
            APPEND    "_gprw_errors",CMDLINE
            GOTO      ALER9999
          ENDIF
.
          MATCH     " 3",WBETTYPE
          IF        @EQUAL
            APPEND    "_ihcwrtvw_errors",CMDLINE
            GOTO      ALER9999
          ENDIF
.
          MATCH     " 4",WBETTYPE
          IF        @EQUAL
            APPEND    "_erawstsw_errors",CMDLINE
            GOTO      ALER9999
          ENDIF
.
          MATCH     " 5",WBETTYPE
          IF        @EQUAL
            APPEND    "_erawrtvw_errors",CMDLINE
            GOTO      ALER9999
          ENDIF
.
          MATCH     " 9",WBETTYPE
          IF        @EQUAL
            APPEND    "_imcwstsw_errors",CMDLINE
            GOTO      ALER9999
          ENDIF
.
          MATCH     "10",WBETTYPE
          IF        @EQUAL
            APPEND    "_imcwrtvw_errors",CMDLINE
            GOTO      ALER9999
          ENDIF
.
          MATCH     "11",WBETTYPE
          IF        @EQUAL
            APPEND    "_bprw_errors",CMDLINE
            GOTO      ALER9999
          ENDIF
.
          MATCH     "12",WBETTYPE
          IF        @EQUAL
            APPEND    "_bpyw_errors",CMDLINE
            GOTO      ALER9999
          ENDIF
.
          MATCH     "13",WBETTYPE
          IF        @EQUAL
            APPEND    "_imcwstsw_errors",CMDLINE
            GOTO      ALER9999
          ENDIF
.
          MATCH     "14",WBETTYPE
          IF        @EQUAL
            APPEND    "_imcwrtvw_errors",CMDLINE
            GOTO      ALER9999
          ENDIF
.
          MATCH     "15",WBETTYPE
          IF        @EQUAL
            APPEND    "_ihcwstsw_errors",CMDLINE
            GOTO      ALER9999
          ENDIF
.
          MATCH     "16",WBETTYPE
          IF        @EQUAL
            APPEND    "_ihcwrtvw_errors",CMDLINE
            GOTO      ALER9999
          ENDIF
.
          MATCH     "17",WBETTYPE
          IF        @EQUAL
            APPEND    "_erawrtvw_errors",CMDLINE
            GOTO      ALER9999
          ENDIF
.
          MATCH     "18",WBETTYPE
          IF        @EQUAL
            APPEND    "_imcwstsw_errors",CMDLINE
            GOTO      ALER9999
          ENDIF
.
          MATCH     "19",WBETTYPE
          IF        @EQUAL
            APPEND    "_ihcwstsw_errors",CMDLINE
            GOTO      ALER9999
          ENDIF
.
          MATCH     "20",WBETTYPE
          IF        @EQUAL
            APPEND    "_dvrw_errors",CMDLINE
            GOTO      ALER9999
          ENDIF
.
          MATCH     "21",WBETTYPE
          IF        @EQUAL
            APPEND    "_dvyw_errors",CMDLINE
            GOTO      ALER9999
          ENDIF
.
ALER9999  RETURN
+
.---------------------------------------------------------------
. Tran RTVW <tran id>.properties tag
.---------------------------------------------------------------
TRNHED00  MATCH     SP70,WBB2DPTH
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"WebServices B2B Device directory not found.";
            GOTO      TRNHED99
          ENDIF
.
          MATCH    SP70,WBETSTRD
          GOTO     TRNHED99 IF EQUAL
          GOTO     TRNHED99 IF EOS
.
          CLEAR     CMDLINE
          APPEND    WBB2DPTH,CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
.
          CALL      ATRN0000
.
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    WBETSTRD,CMDLINE
          APPEND    PROPLITR,CMDLINE
          RESET     CMDLINE
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PROPFILE,CMDLINE
          TRAPCLR   IO
          IF        OVRCD=1
            WRITE     HTMLFILE;"Can't&nbsp;read: ",CMDLINE;
            GOTO      TRNHED99
          ENDIF
.
TRNHED10  READ      PROPFILE,SEQ;PROPLINE
          GOTO      TRNHED99 IF OVER
.
          WRITE     HTMLFILE;PROPLINE
.
          GOTO      TRNHED10
.
TRNHED99  CLOSE     PROPFILE
.
          RETURN
+
.---------------------------------------------------------------
. Tran RTVW <tran id>_xxxxrtvw  tag
.---------------------------------------------------------------
TRNJSN00  MATCH     SP70,WBB2DPTH
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"WebServices B2B Device directory not found.";
            GOTO      TRNJSN99
          ENDIF
.
          MATCH    SP70,WBETSTRD
          GOTO     TRNJSN99 IF EQUAL
          GOTO     TRNJSN99 IF EOS
.
          CLEAR     CMDLINE
          APPEND    WBB2DPTH,CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
.
          CALL      ATRN0000
.
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    WBETSTRD,CMDLINE
.
          CALL      ALTR0000
.
          RESET     CMDLINE
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      TRNWFILE,CMDLINE
          TRAPCLR   IO
          IF        OVRCD=1
            WRITE     HTMLFILE;"Can't&nbsp;read: ",CMDLINE;
            GOTO      TRNJSN99
          ENDIF
.
TRNJSN10  READ      TRNWFILE,SEQ;TRNWLINE
          GOTO      TRNJSN99 IF OVER
.
          WRITE     HTMLFILE;TRNWLINE
.
          GOTO      TRNJSN10
.
TRNJSN99  CLOSE     TRNWFILE
.
          RETURN
+
.---------------------------------------------------------------
. Tran RTVW <tran id>_xxxxrtvw_response  tag
.---------------------------------------------------------------
TRNRSP00  MATCH     SP70,WBB2DPTH
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"WebServices B2B Device directory not found.";
            GOTO      TRNRSP99
          ENDIF
.
          MATCH    SP70,WBETSTRD
          GOTO     TRNRSP99 IF EQUAL
          GOTO     TRNRSP99 IF EOS
.
          CLEAR     CMDLINE
          APPEND    WBB2DPTH,CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
.
          CALL      ATRN0000
.
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    WBETSTRD,CMDLINE
.
          CALL      ALRR0000
.
          RESET     CMDLINE
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      TRNRFILE,CMDLINE
          TRAPCLR   IO
          IF        OVRCD=1
            WRITE     HTMLFILE;"Can't&nbsp;read: ",CMDLINE;
            GOTO      TRNRSP99
          ENDIF
.
TRNRSP10  READ      TRNRFILE,SEQ;TRNRLINE
          GOTO      TRNRSP99 IF OVER
.
          WRITE     HTMLFILE;TRNRLINE
.
          GOTO      TRNRSP10
.
TRNRSP99  CLOSE     TRNRFILE
.
          RETURN
+
.---------------------------------------------------------------
. Tran RTVW <tran id>_xxxxrtvw_errors  tag
.---------------------------------------------------------------
TRNERR00  MATCH     SP70,WBB2DPTH
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"WebServices B2B Device directory not found.";
            GOTO      TRNERR99
          ENDIF
.
          MATCH    SP70,WBETSTRD
          GOTO     TRNERR99 IF EQUAL
          GOTO     TRNERR99 IF EOS
.
          CLEAR     CMDLINE
          APPEND    WBB2DPTH,CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
.
          CALL      ATRN0000
.
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    WBETSTRD,CMDLINE
.
          CALL      ALER0000
.
          RESET     CMDLINE
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      TRNEFILE,CMDLINE
          TRAPCLR   IO
          IF        OVRCD=1
            WRITE     HTMLFILE;"Can't&nbsp;read: ",CMDLINE;
            GOTO      TRNERR99
          ENDIF
.
TRNERR10  READ      TRNEFILE,SEQ;TRNELINE
          GOTO      TRNERR99 IF OVER
.
          WRITE     HTMLFILE;TRNELINE
.
          GOTO      TRNERR10
.
TRNERR99  CLOSE     TRNEFILE
.
          RETURN
+
.------------------------------------------------------------
. WebServices BBSW BPYW Payment Report Enquiries
.------------------------------------------------------------
ECRB0000  MATCH     "1",PTCNBBSW
          GOTO      ECRB9300 IF NOT EQUAL
.
          RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      ECRB5000 IF EQUAL
.
          MATCH     "R",UPDATETY
          GOTO      ECRB4000 IF EQUAL
.
          MATCH     "D",UPDATETY
          GOTO      ECRB3000 IF EQUAL
.
          MATCH     "L",UPDATETY
          GOTO      ECRB2000 IF EQUAL
.
          MATCH     "P",UPDATETY
          GOTO      ECRB1000 IF EQUAL
.
          GOTO      ECRB9000
.
ECRB1000  MOVE      "1",DIM1C
          CALL      PRNRMB00
          MOVE      "Print Payment Report scheduled.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ECRB9999
.
ECRB2000  CALL      RPAB0000
          GOTO      ECRB9999
.
ECRB3000  PACK      KEY53,HOSPCODE,ECREPYPN,ECREPRUN,ECREPDAT,ECRECLID:
                          ECRETRID,SP70
          CALL      RDWBBRD1
          BRANCH    OVRCD,ECRB9100
.
          GOTO      ECRB6000
.
ECRB4000  REP       "`##",ECRERKEY
.
          PACK      KEY47,HOSPCODE,ECREPYPN,ECREPRUN,ECREPDAT,ECRERKEY,SP70
          CALL      RDWBBRH1
          BRANCH    OVRCD,ECRB9100
.
          GOTO      ECRB6000
.
ECRB5000  MOVE      TEMPLATE,KEY3
          RJUSTIFY  KEY3
          REP       " 0",KEY3
.
          MATCH     "001",KEY3
          IF        @EQUAL
.
            CALL      CURPER00
            CALL      CALCDT00
.
            CLEAR     WEBTITLE
            MOVE      "Unreleased BBSW BPYW Payment Report Enquiry",WEBTITLE
            RESET     WEBTITLE
          ENDIF
.
          MATCH     "005",KEY3
          IF        @EQUAL
.
            CALL      CURPER00
            CALL      CALCDT00
.
            CLEAR     WEBTITLE
            MOVE      "Released BBSW BPYW Payment Report Enquiry",WEBTITLE
            RESET     WEBTITLE
          ENDIF
.
          MATCH     "007",KEY3
          IF        @EQUAL
.
            CALL      CURPER00
            CALL      CALCDT00
.
            CLEAR     WEBTITLE
            MOVE      "Unreleased BBSW BPYW Payment Report Enquiry Only",WEBTITLE
            RESET     WEBTITLE
          ENDIF
.
ECRB6000  CALL      WEBHED00
          BRANCH    EXIT,ECRB9999
.
          CALL      WEBBOD00
.
          CALL      WEBEND00
.
          MOVE      ONE,EXIT
          GOTO      ECRB9999
.
ECRB9000  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ECRB9999
.
ECRB9100  MOVE      "Can't find Payment details.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ECRB9999
.
ECRB9300  MOVE      "Not using BBSW Module.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ECRB9999
.
ECRB9999  RETURN
+
.*****************************************************************************
.*                              RPAB0000           Called by: KEYA0000       *
.*           Release all payments for the selected BPYW batch                *
.*****************************************************************************
.
.         Initialise counters
.         ERDCOUNT - is the total number of webbrdaf records associated
.                    with the selected BPYW batch.
.         PRLCOUNT - is the number of webbrdaf records associated with the
.                    selected BPYW batch, which have previously been "released".
.         RELCOUNT - is the number of webbrdaf records associated with the
.                    selected BPYW batch for which payments have been released
.                    in this session.
.
RPAB0000
.          CALL      CLER0000
.          MOVE      SP3,SAVEPART
.
          MOVE      ZERO,EXIT
          MOVE      ZERO,ERDCOUNT
          MOVE      ZERO,PRLCOUNT
          MOVE      ZERO,RELCOUNT
.
.         Start releasing payments for the ERA
.
RPAB0500
.          REP       "+ ",FUNDTRID
.          REP       "+ ",REMITADV
.          REP       "+ ",PARTNUMB
.
          REP       "+ ",HOSPCODE
          REP       "+ ",ECREPYPN
          REP       "+ ",ECREPRUN
          REP       "+ ",ECREPDAT
          REP       "+ ",ECRERKEY
.
          PACK      KEY47,HOSPCODE,ECREPYPN,ECREPRUN,ECREPDAT,ECRERKEY,SP70
          CALL      RDWBBRH1
          BRANCH    OVRCD,RPAB9960
.
          MATCH     "3",WBBHSTAT
          GOTO      RPAB9950 IF EQUAL
.
          MOVE      "3",WBBHSTAT
          CALL      UPWBBRH1
.
          MOVE      SP70,RECPTIND
.
          PACK      KEY53,WBBHRKEY,SP70
          CALL      RSWBBRD3
RPAB1000  CALL      RKWBBRD3
          BRANCH    OVRCD,RPAB9000
.
          MATCH     WBBHRKEY,WBBRRKEY
          GOTO      RPAB9000 IF NOT EQUAL
.
          RJUSTIFY  WBBRCLBP
          UNPACK    WBBRCLBP,DIM7,DIM2           * set amount paid
          PACK      DIM10,DIM7,DOT,DIM2
          MOVE      ZERO,FORM7P2C
.
          SCAN      "-",DIM10
          IF        @EQUAL
            REP        "-0",DIM10
            MOVE       ZERO,FORM7P2C
            MOVE       DIM10,FORM7P2C
            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
          ELSE
            MOVE       DIM10,FORM7P2C
          ENDIF
.
.         IF        FORM7P2C = 0 | FORM7P2C < 0
          IF        FORM7P2C = 0
            ADD       ONE,RELCOUNT
            MOVE      TWO,WBBRSTAT                 * set as released
            CALL      UPWBBRD3
            GOTO      RPAB1000
          ENDIF
.
.         A payment for the BPYW has been found, so check if it needs releasing
.
          ADD       ONE,ERDCOUNT                 * increment webbrdaf count
          MATCH     "2",WBBRSTAT                 * released  ?
          IF        @EQUAL
            ADD       ONE,PRLCOUNT               * yes - incr. prev. rel. count
            GOTO      RPAB1000                   * get next payment
          ENDIF
.
          MATCH     "3",WBBRSTAT                 * released to suspense ?
          IF        @EQUAL
            ADD       ONE,PRLCOUNT               * yes - incr. prev. rel. count
            GOTO      RPAB1000                   * get next payment
          ENDIF
.
.         A claim requiring payment releasing has been found, so
.         get the corresponding webbbsaf record and check if same hospital
.
          MOVE      ZERO,ERASUSIN
          PACK      KEY40,WBBRTRID,SP70
          CALL      RSWBBBS6                     * position on trans. id/invoice
          CALL      RKWBBBS6                     * read next record
.         BRANCH    OVRCD,RPAB6000               * eof
          IF        OVRCD=ONE
            CLEAR     SERDIM50
            APPEND    WBBRTRID,SERDIM50
            APPEND    " - webbbsaf record not found",SERDIM50
            RESET     SERDIM50
            GOTO      RPAB6000
          ENDIF
.
          MATCH     WBBRTRID,WBBSTRID            * same transaction id still ?
.         GOTO      RPAB6000 IF NOT EQUAL        * no
          IF        !@EQUAL
            CLEAR     SERDIM50
            APPEND    WBBRTRID,SERDIM50
            APPEND    " - tran id not found",SERDIM50
            RESET     SERDIM50
            GOTO      RPAB6000
          ENDIF
.
          MOVE      SP70,SAVELOCN
.          IF        IBCNMHOS=1
.            MATCH     WBBHHOSP,WBBSHOSP
.            IF        !@EQUAL
.              PACK      KEY3,WBBSHOSP,SP70
.              CALL      RDPTHSP1
.              IF        OVRCD=0
.                MOVE      PTHSLOCN,SAVELOCN
.              ELSE
.                  SUB       ONE,ERDCOUNT
.                  GOTO      RPAB1000
.              ENDIF
..
.              PACK      KEY3,WBBHHOSP,SP70
.              CALL      RDPTHSP1
.              IF        OVRCD=0
.                MATCH     SAVELOCN,PTHSLOCN
.                IF        !@EQUAL
.                  SUB       ONE,ERDCOUNT
.                  GOTO      RPAB1000
.                ENDIF
.              ELSE
.                  SUB       ONE,ERDCOUNT
.                  GOTO      RPAB1000
.              ENDIF
.            ENDIF
.          ENDIF
.
          MATCH     "2",WBBSMODL
          IF        @EQUAL
.
            PACK      KEY8,WBBSINVN,SP70
            RJUSTIFY  KEY8
            CALL      RDPRIN1
            IF        OVRCD=ONE
              CLEAR     SERDIM50
              APPEND    WBBSINVN,SERDIM50
            APPEND    " - priinvof record not found",SERDIM50
            RESET     SERDIM50
            GOTO      RPAB6000
            ENDIF
.
            MATCH     "1",PRINCNST
            IF        @EQUAL
              CLEAR     SERDIM50
              APPEND    WBBSINVN,SERDIM50
              APPEND    "invoice is fully credited",SERDIM50
              RESET     SERDIM50
              GOTO      RPAB6000
            ENDIF
.
          ELSE
.
            PACK      KEY8,WBBSINVN,SP70
            RJUSTIFY  KEY8
            CALL      RDPTINV1
            IF        OVRCD=ONE
              CLEAR     SERDIM50
              APPEND    WBBSINVN,SERDIM50
              APPEND    " - patinvrf record not found",SERDIM50
              RESET     SERDIM50
              GOTO      RPAB6000
            ENDIF

.
            MATCH     "1",PTINCRST
.           GOTO      RPAY6000 IF EQUAL
            IF        @EQUAL
              CLEAR     SERDIM50
              APPEND    WBBSINVN,SERDIM50
              APPEND    "invoice is fully credited",SERDIM50
              RESET     SERDIM50
              GOTO      RPAB6000
            ENDIF
.
          ENDIF
.
.
.         Now lock all the relevant records prior to releasing the payment.
.         Check that we can lock the Health Fund receipts record.
.
RPAB1500
.         MOVE      "HFR",PRXCODE   * System Lock Audits
.         CALL      GETSLK00        * Get System Lock Audits
.
.         PACK      KEY8,PMECINVN,SP70
.         CALL      RDHFRE1                      * lock record found ?
.         IF        OVRCD = 1
.           MOVE      ONE,HFRSTAT                * no - write one with lock
.           MOVE      PMECINVN,HFRINVR
.           CALL      WRHFRE1
.         ELSE
.           COMPARE   ZERO,HFRSTAT               * yes - is it already locked ?
.           IF        @EQUAL
.             MOVE      ONE,HFRSTAT              * no - lock now
.             CALL      UPHFRE1
.           ELSE
.             CALL      RELSLK00                 * Release System Lock Audits
.             GOTO      RPAB8000                 * record already locked
.           ENDIF
.         ENDIF
.         CALL      RELSLK00        * Release System Lock Audits
.
.         Now check the we can lock the invoice record
.
.         MOVE      PMECINVN,KEY8
.         CALL      RLPTINV1
.         IF        OVRCD = 1
..           MOVE      THREE,UNLKFLAG
..           CALL      UNLK0000                   * unlock any locked records
..           GOTO      RPAB8000
.           GOTO      RPAB6100
.         ELSE
.           IF        OVRCD = 2
.             MOVE      THREE,UNLKFLAG
.             CALL      UNLK0000                 * unlock any locked records
.             GOTO      RPAB8000
.           ENDIF
.         ENDIF
.
.         Check that we can lock the visit record
.
.         PACK      KEY8,PMECADMN,SP70
.         CALL      RLPTVIS1
.         IF        OVRCD = 1
.           MOVE      TWO,UNLKFLAG
.           CALL      UNLK0000                   * unlock any locked records
.           GOTO      RPAB8000
.         ELSE
.           IF        OVRCD = 2
.             MOVE      TWO,UNLKFLAG
.             CALL      UNLK0000                 * unlock any locked records
.             GOTO      RPAB8000
.           ENDIF
.         ENDIF
.
.         All the relevant records have been locked.
.         As there may be payments in this remittance for more than one
.         participant, check if the participant code has changed.  If it
.         has, then we need to get a new receipt number.
.
.         MATCH     SAVEPART,PARTPANT            * same participant still ?
..          IF        !@EQUAL
.
            MATCH     "1",RECPTIND
            IF        !@EQUAL
              CALL      ALLCRC00
              MOVE      "1",RECPTIND
            ENDIF
..
.            MOVE      PARTPANT,SAVEPART          * save new participant code
.          ENDIF
.
.         Process the payment
.
          RJUSTIFY  WBBRCLBP
          UNPACK    WBBRCLBP,DIM7,DIM2           * set amount paid
          PACK      DIM10,DIM7,DOT,DIM2
          MOVE      ZERO,FORM7P2C
.
          SCAN      "-",DIM10
          IF        @EQUAL
            REP        "-0",DIM10
            MOVE       ZERO,FORM7P2C
            MOVE       DIM10,FORM7P2C
            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
          ELSE
            MOVE       DIM10,FORM7P2C
          ENDIF
.
.          MATCH     "HIC",PMEHNAME
.          IF        @EQUAL
.            MOVE      FORM7P2C,PRECAMMP
.            ASSIGN    (PRINMAMT-PRECAMMP),PRINMAMT
.          ELSE
.            MOVE      FORM7P2C,PRECAMFP
.            ASSIGN    (PRINHAMT-PRECAMFP),PRINHAMT
.          ENDIF
.
          MOVE      FORM7P2C,WBBSAMTP
.
          MATCH     "2",WBBSMODL
          IF        @EQUAL
            ASSIGN    (PRINMAMT-WBBSAMTP),PRINMAMT
          ELSE
            ASSIGN    (PINVOTHA-WBBSAMTP),PINVOTHA
          ENDIF
.
          CALL      IBACLOCK                     * get current date
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          MOVE      CTIMEIS,CURRTIME
.
..         Check if the invoice now balances
..
.          MOVE      PRINITOT,FORM10P2             * Invoice amount +
.          ADD       PRINPAMT,FORM10P2            * Patient payments +
.          ADD       PRINHAMT,FORM10P2            * H.F payments +
.          ADD       PRINOTHA,FORM10P2            * Other payments +
.          ADD       PRINJAMT,FORM10P2            * Journals +
.          ADD       PRINGSTJ,FORM10P2            * Journal GST = amt outstanding
..
..         MOVE      "99999999",PINVBLCD          * default to not balancing
..
..         COMPARE   ZERO,FORM10P2                * Does invoice balance ?
..         IF        @EQUAL
..           MOVE      CURRDATE,PINVBLCD          * yes - record balanced date
...          MOVE      TWO,PTDTAPAY               * set A/P flag - balanced
..         ELSE
...          MOVE      ZERO,PTDTAPAY              * set A/P flag - not balanced
..         ENDIF
.          MOVE      FORM10P2,PRINPEND
..         CALL      UPINV1                       * update/unlock invoice record
..
..         PROC      FLAGDEBT
..
..         Create the patdtraf cash receipt record.
..
.          MOVE      PRECUNIQ,PRDTUNIQ            * load unique number
..
..         Get the next transaction number.  As we have already locked
..         the visit record, there should be no problem getting the
..         next transaction number.
..
..RPAB3000  MOVE      PMECADMN,KEY8                * get next transaction number
..          CALL      TRVISA1
..
..          PACK      KEY22,PMECADMN,PMECINVN,PVITRAN
..          CALL      RDADTRN1                     * patdtraf record on file ?
..          COMPARE   ZERO,OVRCD
..          GOTO      RPAB3000 IF EQUAL            * yes
..
..          MOVE      PVITRAN,TTRANSN1             * load transaction number
..          MOVE      ANSH,TTYPEDEB                * set to "patient" type of debt
..          MOVE      PMECHFND,TDCODE
..
..          ASSIGN    (PMECAMTP*SEQ),TPATAMTT
..          MOVE      TPATAMTT,TREBATE
..
..          MOVE      ZERO,TPATAMTG                * set $ amounts
..          MOVE      ZERO,TPATAMTH
..          MOVE      ZERO,TPATAMTI
..          MOVE      ZERO,TPATAMTP
..
..          MOVE      CCC,TFCENT                   * set payment date
..          MOVE      CYY,TFYEAR
..          MOVE      CMM,TFMONTH
..          MOVE      CDD,TFDAY
..
..          MOVE      ZERO,TTCENT                  * initialise accomm. to dates
..          MOVE      ZERO,TTYEAR
..          MOVE      ZERO,TTMONTH
..          MOVE      ZERO,TTDAY
..
..          PACK      TTYPE,ANSP,ANSY              * set for payment
..          MOVE      SP9,TITEMNO
..          MOVE      PMECINVN,TREF                * load invoice no.
..          MOVE      SIX,TPAYTYPE                 * direct deposit
..
.          MOVE      HRECPT,PRDTRECN
..
..          IF        PMECEETP = 0
..            MOVE      "Unknown Health Fund           ",HFNAME
..            PACK      KEY14,PMECHFND,ZERO4,SP20
..            CALL      RDFUND1                    * HF on file ?
..            MOVE      HFNAME,TDDESC              * load HF description
..          ELSE
..            MOVE      "Unknown Claim Code  ",TDESC
..            PACK      KEY5,ANSC,ANSL,PINVCLM
..            CALL      RDCODE1
..            MOVE      TDESC,TDDESC               * load claim code description
..          ENDIF
..
..          MOVE      ONE,TINVPRT                  * invoice printed
..          MOVE      FIVE,TRECTYPE                * cash receipt
..          MOVE      ZERO,TNODAYS
..          MOVE      ZERO,TCLAIM
...         MOVE      ZERO,PTDTREBT
..          MOVE      SP6,TDOCTA
..          MOVE      ZERO,TSERVS
..          MOVE      SP6,TDOCTO
..          MOVE      SP2,TSESSION
..          MOVE      SP3,TMISGRP
..          MOVE      SP3,TDEPTYP
..          MOVE      SP3,TDWARD
..          MOVE      SP3,TCLMTYP
..          MOVE      SP3,TADMTYP
..          MOVE      PMECBATN,TBATCHN             * load batch number
..          MOVE      ZERO,TNINVS
..          MOVE      SP3,PTDTBTYP
..          MOVE      ZERO,PTDTLSPT
..          MOVE      ZERO,PTDTLSRB
..          MOVE      ZERO,PTDTDTYP
..          PACK      PTDTDES2,SP20,SP20
..          MOVE      ZERO,PTDTEPSD
..          MOVE      ZERO,PTDTCCU
...         MOVE      SP6,PTDTSURG
...         MOVE      SP1,PTDTDEPS
..
..          MOVE      CURRDATE,PTDTEFFD            * load payment date
..
..          MOVE      ZERO,PTDTGSTA
..          MOVE      SP6,PTDTGSTC
..          MOVE      ZERO,PTDTGSTM
..          MOVE      ZERO,PTDTADPT
..          MOVE      ZERO,PTDTADRB
..          MOVE      ZERO,PTDTGSTL
..          MOVE      SP70,PTDTTIME
..          MOVE      SP70,PTDTCRST
..          MOVE      SP70,PTDTUNIQ
..          MOVE      SP70,PTDTCNTR
..          MOVE      SP70,PTDTCPRC
..          MOVE      SP70,PTDTCONT
..          MOVE      SP70,PTDTSUNQ
..          MOVE      SP70,PTDTBTCH
...         MOVE      ANSN,PTDTSSAP
...         MOVE      ZERO,PTDTMVBR
..          MOVE      ZERO,PTDTEPSD
...         MOVE      SP1,PTDTMHDP
..          PACK      TSPARE,SP30,SP30
..
..          CALL      WRDTRN1                     * write patdtraf journal record
..
           ADD       ONE,RELCOUNT
.
. Write to rcpbnkaf
.
          PACK      KEY12,HRECPT,SP70
          CALL      RDRCBNK1
          IF        OVRCD=1
.
            MOVE      HRECPT,RCBNRECN
            CALL      IBACLOCK
            PACK      RCBNTDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBNTDAT
.
            RJUSTIFY  WBBRCLBP
            UNPACK    WBBRCLBP,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       ZERO,FORM7P2C
              MOVE       DIM10,FORM7P2C
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE
              MOVE       DIM10,FORM7P2C
            ENDIF
.
            MOVE      FORM7P2C,RCBNTOTP
            MOVE      RCCNERCD,RCBNCDRW
            MOVE      RCCNERCA,RCBNCHQA
            MOVE      WBBHHOSP,RCBNMHOS
.
            IF        IBCNMHOS=1
              MATCH     SP70,RCBNMHOS
              IF        !@EQUAL & !@EOS
                PACK      KEY3,RCBNMHOS,SP70
                CALL      RDPTHSP1
                IF        OVRCD=0
                  MATCH     SP70,PTHSERCD
                  IF        !@EQUAL & !@EOS
                    MOVE      PTHSERCD,RCBNCDRW
                  ENDIF
                  MATCH     SP70,PTHSERCA
                  IF        !@EQUAL & !@EOS
                    MOVE      PTHSERCA,RCBNCHQA
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
.
            MOVE      CHOSPNUM,RCBNMDHS
.
.           MATCH     "HIC",PMEHNAME
.           IF        @EQUAL
              MOVE      "3",RCBNTTYP
              MOVE      SP70,RCBNRCOD
.           ELSE
.             MOVE      "1",RCBNTTYP               * CAR 227986
.             MOVE      PRECHFND,RCBNRCOD
.           ENDIF
.
.           MOVE      PRECHFND,RCBNRCOD
            MOVE      ZERO,RCBNSTAT
            MOVE      SP70,RCBNBDAT
            MOVE      SP70,RCBNBTIM
            MOVE      SP70,RCBNRDAT
            MOVE      SP70,RCBNRTIM
            PACK      RCBNCDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBNCDAT
            CLOCK     TIME,RCBNCTIM
            MOVE      WBSEUID,RCBNCUID
            MOVE      SP70,RCBNUDAT
            MOVE      SP70,RCBNUTIM
            MOVE      SP70,RCBNUUID
            MOVE      SP70,RCBNSPAR
.
            PACK      KEY12,HRECPT,SP70
            CALL      WRRCBNK1
.
          ELSE
.
            RJUSTIFY  WBBRCLBP
            UNPACK    WBBRCLBP,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       DIM10,FORM7P2C
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE
              MOVE      DIM10,FORM7P2C
            ENDIF
.
            ADD       FORM7P2C,RCBNTOTP
            CALL      UPRCBNK1
.
          ENDIF
.
. Write to rcpbdtaf
.
          PACK      KEY15,HRECPT,SP1,SP1,ONE,SP70
          CALL      RDRCBDT1
          IF        OVRCD = 1
.
            CALL      IBACLOCK
            PACK      RCBDTDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBDTDAT
            MOVE      HRECPT,RCBDRECN
            MOVE      "  1",RCBDUNIQ
            MOVE      WBBHHOSP,RCBDMHOS
            MOVE      CHOSPNUM,RCBDMDHS
            MOVE      "4",RCBDPTYP
            CALL      DDEP0000            * Get payment code for Direct Deposit
.
            RJUSTIFY  WBBRCLBP
            UNPACK    WBBRCLBP,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       DIM10,FORM7P2C
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE
              MOVE      DIM10,FORM7P2C
            ENDIF
            MOVE      FORM7P2C,RCBDPAMT
.
.           MATCH     "HIC",PMEHNAME
.           IF        @EQUAL
              MOVE      "HIC",RCBDPAYD
.           ELSE
.             MOVE      PARTPANT,RCBDPAYD
.           ENDIF
.
            MOVE      SP70,RCBDCHQN
            MOVE      "MEDICARE",RCBDDRAW
            MOVE      WBBHACNM,RCBDBANK
            MOVE      WBBHBSBC,RCBDBRCH
            MOVE      SP70,RCBDCRDT
            MOVE      WBBHPRUN,RCBDSTRF
....        MOVE      SP70,RCBDMONM                                   *D-187485
            MOVE      SP70,RCBDEFTT
            CALL      IBACLOCK
            PACK      RCBDCDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBDCDAT
            CLOCK     TIME,RCBDCTIM
            MOVE      WBSEUID,RCBDCUID
            MOVE      SP70,RCBDUDAT
            MOVE      SP70,RCBDUTIM
            MOVE      SP70,RCBDUUID
            MOVE      SP70,RCBDSPAR
.
            PACK      KEY15,HRECPT,RCBDUNIQ,SP70
            CALL      WRRCBDT1
.
          ELSE
.
            RJUSTIFY  WBBRCLBP
            UNPACK    WBBRCLBP,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       DIM10,FORM7P2C
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE
              MOVE      DIM10,FORM7P2C
            ENDIF
.
            ADD       FORM7P2C,RCBDPAMT
            CALL      UPRCBDT1
.
          ENDIF
.
. Write to rcpdteaf
.
RPAB3500  PACK      KEY17,HRECPT,Z70
          CALL      RSRCDTE1
          CALL      RPRCDTE1
          IF        OVRCD = 1
            MOVE      "    1",RCDTTCNT
            CALL      WRRDB100
          ELSE
            MOVE      HRECPT,DIM12
            MATCH     DIM12,RCDTRECN
            IF        !@EQUAL
              MOVE      "    1",RCDTTCNT
              CALL      WRRDB100
            ELSE
              MOVE      RCDTTCNT,DIM5
              SQUEEZE   DIM5
              MOVE      ZERO,FORM5
              MOVE      DIM5,FORM5
              ADD       ONE,FORM5
              MOVE      FORM5,RCDTTCNT
.
              PACK      KEY17,HRECPT,RCDTTCNT,SP70
              CALL      RARCDTE1
              IF        OVRCD = 1
                CALL      WRRDB100
              ELSE
                GOTO      RPAB3500
              ENDIF
            ENDIF
          ENDIF
.
.         Now "close" the current claim (providing that a processing report
.         has been received) and update the payment amount and
.         the payment date
.
.          MOVE      PMEDARID,DIM20               * CAR 227986
.          SQUEEZE   DIM20
.
.          PACK      KEY57,OTESTRID,OTESCLID,Z70
.          CALL      RSOTEAH2                     * position on trans. id
.RPAB4000  CALL      RPOTEAH2                     * read previous record
.          BRANCH    OVRCD,RPAB4500               * eof - no proc. report
..
.          MATCH     OTESTRID,OTEHCTID            * same claim trans. id ?
.          GOTO      RPAB4500 IF NOT EQUAL        * no - no proc. report
..
.          MATCH     OTESCLID,OTEHCLID            * same claim id ?
.          GOTO      RPAB4500 IF NOT EQUAL        * no - no proc. report
.
.         A processing report was found
.
          RJUSTIFY  WBBRCLBP
          UNPACK    WBBRCLBP,DIM7,DIM2           * set amount paid
          PACK      DIM10,DIM7,DOT,DIM2
          MOVE      ZERO,FORM7P2C
.
          SCAN      "-",DIM10
          IF        @EQUAL
            REP        "-0",DIM10
            MOVE       ZERO,FORM7P2C
            MOVE       DIM10,FORM7P2C
            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
          ELSE
            MOVE       DIM10,FORM7P2C
          ENDIF
.
.......
.          MOVE      PMEDARID,DIM8
.          RJUSTIFY  DIM8
..
.          PACK      KEY22,DIM8,SP70
.          CALL      RSPRDT4
.          CALL      RKPRDT4
.          BRANCH    OVRCD,RPAB4100
..
.          MATCH     DIM8,PRDTINVN
.          GOTO      RPAB4100 IF NOT EQUAL
..
.          PACK      KEY27,DPRDTUNQ,PRDTPRAC,PRDTDOCT,PRDTCODE,SP70
.          CALL      RDPRHR1
.          BRANCH    OVRCD,RPAB4100
..
.          MATCH     SP70,PRHRTACC
.          GOTO      RPAB4100 IF EQUAL
..
.          MOVE      "ta",CATEGORY
.          MOVE      PRHRTACC,CODE
.          CALL      GETCOD00
..
.          MATCH     "1",TCINDC1
.          GOTO      RPAB4100 IF EQUAL
..
.          MATCH     "2",TCINDC1
.          GOTO      RPAB4100 IF EQUAL
..
.          MATCH     "7",TCINDC1
.          GOTO      RPAB4150 IF EQUAL
..
.          MATCH     "6",TCINDC1
.          IF        @EQUAL
.            MATCH     "HIC",PMEHNAME
.            IF        @EQUAL
.              MOVE      FORM7P2C,PRECAMMP
.              COMPARE   ZERO,PRECAMFP
.              GOTO      RPAB4300 IF EQUAL
.              GOTO      RPAB4200
.            ELSE
.              MOVE      FORM7P2C,PRECAMFP
.              COMPARE   ZERO,PRECAMMP
.              GOTO      RPAB4300 IF EQUAL
.              GOTO      RPAB4200
.            ENDIF
.          ENDIF
.......
.RPAB4100  MOVE      FORM7P2C,PRECAMFP
.          GOTO      RPAB4200
..
.RPAB4150  MOVE      FORM7P2C,PRECAMMP
.          GOTO      RPAB4200
..
          MOVE      FORM7P2C,WBBSAMTP
          COMPARE   ZERO,WBBSAMTP
          GOTO      RPAB4300 IF EQUAL
.
RPAB4200  MOVE      EIGHT,WBBSFLAG               * set status to closed
.
RPAB4300  PACK      WBBSSTAT,SP1,TWO             * set closed with payment
          MOVE      WBBRPDAT,WBBSPDAT            * set payment date
.
          GOTO      RPAB4600
.
.RPAB4500  UNPACK    OTESCLBP,DIM7,DIM2           * set amount paid
.          PACK      DIM10,DIM7,DOT,DIM2
.          MOVE      ZERO,FORM7P2C
..
.          SCAN      "-",DIM10
.          IF        @EQUAL
.            REP        "-0",DIM10
.            MOVE       ZERO,FORM7P2C
.            MOVE       DIM10,FORM7P2C
.            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
.          ELSE
.            MOVE       DIM10,FORM7P2C
.          ENDIF
......
.          MOVE      PMEDARID,DIM8
.          RJUSTIFY  DIM8
..
.          PACK      KEY22,DIM8,SP70
.          CALL      RSPRDT4
.          CALL      RKPRDT4
.          BRANCH    OVRCD,RPAB4550
..
.          MATCH     DIM8,PRDTINVN
.          GOTO      RPAB4550 IF NOT EQUAL
..
.          PACK      KEY27,DPRDTUNQ,PRDTPRAC,PRDTDOCT,PRDTCODE,SP70
.          CALL      RDPRHR1
.          BRANCH    OVRCD,RPAB4550
..
.          MATCH     SP70,PRHRTACC
.          GOTO      RPAB4550 IF EQUAL
..
.          MATCH     "1",TCINDC1
.          GOTO      RPAB4550 IF EQUAL
..
.          MATCH     "2",TCINDC1
.          GOTO      RPAB4550 IF EQUAL
..
.          MATCH     "7",TCINDC1
.          GOTO      RPAB4560 IF EQUAL
..
.          MATCH     "6",TCINDC1
.          IF        @EQUAL
.            MATCH     "HIC",PMEHNAME
.            IF        @EQUAL
.              MOVE      FORM7P2C,PRECAMMP
..             COMPARE   ZERO,PRECAMFP
..             GOTO      RPAB4600 IF EQUAL
.              GOTO      RPAB4570
.            ELSE
.              MOVE      FORM7P2C,PRECAMFP
..             COMPARE   ZERO,PRECAMMP
..             GOTO      RPAB4600 IF EQUAL
.              GOTO      RPAB4570
.            ENDIF
.          ENDIF
..
.RPAB4550  MOVE      FORM7P2C,PRECAMFP
.          GOTO      RPAB4570
..
.RPAB4560  MOVE      FORM7P2C,PRECAMMP
.          GOTO      RPAB4570
......
.RPAB4570  PACK      PRECSTAT,SP1,TWO             * set closed with payment
.          MOVE      PMEDLDAT,PRECPDAT            * set payment date
..
RPAB4600  CALL      UPWBBBS6                     * update claim
.
.         Finally, write an EDI History record (webbbaaf)
.
          MOVE      WBBSINVN,WBBAINVN
          CALL      IBACLOCK
          PACK      WBBADATE,CCC,CYY,CMM,CDD
          REP       " 0",WBBADATE
          MOVE      CTIMEIS,WBBATIME
          MOVE      WBBSBATN,WBBABATN
          MOVE      WBBSFLAG,WBBASTAT
          MOVE      " 3",WBBATYPE
          MOVE      WBSEUID,WBBAOPER
          MOVE      WBBSTRID,WBBATRID
          MOVE      SP70,WBBAEROR
.
          MOVE      "Released",WBBAEROT
          PACK      WBBAEROT,WBBAEROT,SP70
          MOVE      SP70,WBBASPAR
.
RPAB5000  PACK      KEY27,WBBAINVN,WBBADATE,WBBATIME,WBBATYPE,WBBAMODL,SP70
          CALL      RAWBBBA1
          IF        OVRCD = 1
            CALL      WRWBBBA1
          ELSE
            CALL      IBACLOCK
            PACK      WBBADATE,CCC,CYY,CMM,CDD
            REP       " 0",WBBADATE
            MOVE      CTIMEIS,WBBATIME
            GOTO      RPAB5000
          ENDIF
.
.         Update the payment table (webbrdaf) to indicate that
.         the claim payment has been released to the relevant ibaPAS tables
.
          MOVE      TWO,WBBRSTAT                 * set as released
          CALL      UPWBBRD3
.
.         MOVE      ONE,UNLKFLAG
.         CALL      UNLK0000                     * unlock all locked records
.
          MOVE      WBBAINVN,KEY8
          PROC      PRIUPURE              * Update Un-reconciled inv.file
.
          GOTO      RPAB1000
.
.*******************************************************************************
.         Now lock all the relevant records prior to releasing the payment.
.         Check that we can lock the Health Fund receipts record.
.
RPAB6000
.         MOVE      "HFR",PRXCODE   * System Lock Audits
.         CALL      GETSLK00        * Get System Lock Audits
.
.         MOVE      PMEDARID,DIM8
.         RJUSTIFY  DIM8
.
.         PACK      KEY8,DIM8,SP70
.         CALL      RDHFRE1                      * lock record found ?
.         IF        OVRCD = 1
.           MOVE      ONE,HFRSTAT                * no - write one with lock
.           MOVE      DIM8,HFRINVR
.           CALL      WRHFRE1
.         ELSE
.           COMPARE   ZERO,HFRSTAT               * yes - is it already locked ?
.           IF        @EQUAL
.             MOVE      ONE,HFRSTAT              * no - lock now
.             CALL      UPHFRE1
.           ELSE
.             CALL      RELSLK00                 * Release System Lock Audits
.             GOTO      RPAB8000                 * record already locked
.           ENDIF
.         ENDIF
.         CALL      RELSLK00        * Release System Lock Audits
.
.         All the relevant records have been locked.
.         As there may be payments in this remittance for more than one
.         participant, check if the participant code has changed.  If it
.         has, then we need to get a new receipt number.
.
RPAB6100
.          MATCH     SAVEPART,PARTPANT            * same participant still ?
.          IF        !@EQUAL
.
            MATCH     "1",RECPTIND
            IF        !@EQUAL
              CALL      ALLCRC00
              MOVE      "1",RECPTIND
            ENDIF
..
.            MOVE      PARTPANT,SAVEPART          * save new participant code
.          ENDIF
.
          MOVE      HRECPT,TRECEIPT
.
          ADD       ONE,RELCOUNT
.
.         MOVE      ONE,PMECEETP
.         MATCH     "DVA",PMEDPART
.         IF        !@EQUAL
.           MOVE      ZERO,PMECEETP
.         ENDIF
.
          RJUSTIFY  WBBRCLBP
          UNPACK    WBBRCLBP,DIM7,DIM2           * set amount paid
          PACK      DIM10,DIM7,DOT,DIM2
          MOVE      ZERO,FORM7P2C
.
          SCAN      "-",DIM10
          IF        @EQUAL
            REP        "-0",DIM10
            MOVE       ZERO,FORM7P2C
            MOVE       DIM10,FORM7P2C
            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
          ELSE
            MOVE       DIM10,FORM7P2C
          ENDIF
.
.          MATCH     "HIC",PMEHNAME
.          IF        @EQUAL
.            MOVE      FORM7P2C,PRECAMMP
.            ASSIGN    (PRINMAMT-PRECAMMP),PRINMAMT
.          ELSE
.            MOVE      FORM7P2C,PRECAMFP
.            ASSIGN    (PRINHAMT-PRECAMFP),PRINHAMT
.          ENDIF
.
           MOVE      FORM7P2C,WBBSAMTP
.
. Write to rcpbnkaf
.
          PACK      KEY12,HRECPT,SP70
          CALL      RDRCBNK1
          IF        OVRCD=1
.
            MOVE      HRECPT,RCBNRECN
            CALL      IBACLOCK
            PACK      RCBNTDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBNTDAT
.
            RJUSTIFY  WBBRCLBP
            UNPACK    WBBRCLBP,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       ZERO,FORM7P2C
              MOVE       DIM10,FORM7P2C
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE
              MOVE       DIM10,FORM7P2C
            ENDIF
.
            MOVE      FORM7P2C,RCBNTOTP
            MOVE      RCCNERCD,RCBNCDRW
            MOVE      RCCNERCA,RCBNCHQA
            MOVE      WBBHHOSP,RCBNMHOS
.
            IF        IBCNMHOS=1
              MATCH     SP70,RCBNMHOS
              IF        !@EQUAL & !@EOS
                PACK      KEY3,RCBNMHOS,SP70
                CALL      RDPTHSP1
                IF        OVRCD=0
                  MATCH     SP70,PTHSERCD
                  IF        !@EQUAL & !@EOS
                    MOVE      PTHSERCD,RCBNCDRW
                  ENDIF
                  MATCH     SP70,PTHSERCA
                  IF        !@EQUAL & !@EOS
                    MOVE      PTHSERCA,RCBNCHQA
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
.
            MOVE      CHOSPNUM,RCBNMDHS
            MOVE      "1",RCBNTTYP               * CAR 227986
.
.           MOVE      PMECHFND,RCBNRCOD
.
            MOVE      SP70,RCBNRCOD
.            MOVE      PMEDARID,DIM8
.            RJUSTIFY  DIM8
..
.            PACK      KEY22,DIM8,SP70
.            CALL      RSPRDT4
.            CALL      RKPRDT4
.            IF        OVRCD=0
.              MATCH     DIM8,PRDTINVN
.              IF        @EQUAL
.                PACK      KEY8,DPRDTUNQ,SP70
.                CALL      RDPRHD2
.                IF        OVRCD=0
.                  MOVE      PRHDHFND,RCBNRCOD
.                ENDIF
.              ENDIF
.            ENDIF
.
            MOVE      ZERO,RCBNSTAT
            MOVE      SP70,RCBNBDAT
            MOVE      SP70,RCBNBTIM
            MOVE      SP70,RCBNRDAT
            MOVE      SP70,RCBNRTIM
            PACK      RCBNCDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBNCDAT
            CLOCK     TIME,RCBNCTIM
            MOVE      WBSEUID,RCBNCUID
            MOVE      SP70,RCBNUDAT
            MOVE      SP70,RCBNUTIM
            MOVE      SP70,RCBNUUID
            MOVE      SP70,RCBNSPAR
.
            PACK      KEY12,HRECPT,SP70
            CALL      WRRCBNK1
.
          ELSE
.
            RJUSTIFY  WBBRCLBP
            UNPACK    WBBRCLBP,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       DIM10,FORM7P2C
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE
              MOVE      DIM10,FORM7P2C
            ENDIF
.
            ADD       FORM7P2C,RCBNTOTP
            CALL      UPRCBNK1
.
          ENDIF
.
. Write to rcpbdtaf
.
          PACK      KEY15,HRECPT,SP1,SP1,ONE,SP70
          CALL      RDRCBDT1
          IF        OVRCD = 1
.
            CALL      IBACLOCK
            PACK      RCBDTDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBDTDAT
            MOVE      HRECPT,RCBDRECN
            MOVE      "  1",RCBDUNIQ
            MOVE      WBBHHOSP,RCBDMHOS
            MOVE      CHOSPNUM,RCBDMDHS
            MOVE      "4",RCBDPTYP
            CALL      DDEP0000            * Get payment code for Direct Deposit
.
            RJUSTIFY  WBBRCLBP
            UNPACK    WBBRCLBP,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       DIM10,FORM7P2C
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE
              MOVE      DIM10,FORM7P2C
            ENDIF
            MOVE      FORM7P2C,RCBDPAMT
.
.            MATCH     "HIC",PMEHNAME
.            IF        @EQUAL
              MOVE      "HIC",RCBDPAYD
.            ELSE
.              MOVE      PARTPANT,RCBDPAYD
.            ENDIF
.
            MOVE      SP70,RCBDCHQN
            MOVE      SP70,RCBDDRAW
            MOVE      WBBHACNM,RCBDBANK
            MOVE      WBBHBSBC,RCBDBRCH
            MOVE      SP70,RCBDCRDT
            MOVE      WBBHPRUN,RCBDSTRF
....        MOVE      SP70,RCBDMONM                                   *D-187485
            MOVE      SP70,RCBDEFTT
            CALL      IBACLOCK
            PACK      RCBDCDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBDCDAT
            CLOCK     TIME,RCBDCTIM
            MOVE      WBSEUID,RCBDCUID
            MOVE      SP70,RCBDUDAT
            MOVE      SP70,RCBDUTIM
            MOVE      SP70,RCBDUUID
            MOVE      SP70,RCBDSPAR
.
            PACK      KEY15,HRECPT,RCBDUNIQ,SP70
            CALL      WRRCBDT1
.
          ELSE
.
            RJUSTIFY  WBBRCLBP
            UNPACK    WBBRCLBP,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       DIM10,FORM7P2C
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE
              MOVE      DIM10,FORM7P2C
            ENDIF
.
            ADD       FORM7P2C,RCBDPAMT
            CALL      UPRCBDT1
.
          ENDIF
.
. Write to rcpdteaf
.
RPAB6500  PACK      KEY17,HRECPT,Z70
          CALL      RSRCDTE1
          CALL      RPRCDTE1
          IF        OVRCD = 1
            MOVE      "    1",RCDTTCNT
            CALL      WRRDB200
          ELSE
            MOVE      HRECPT,DIM12
            MATCH     DIM12,RCDTRECN
            IF        !@EQUAL
              MOVE      "    1",RCDTTCNT
              CALL      WRRDB200
            ELSE
              MOVE      RCDTTCNT,DIM5
              SQUEEZE   DIM5
              MOVE      ZERO,FORM5
              MOVE      DIM5,FORM5
              ADD       ONE,FORM5
              MOVE      FORM5,RCDTTCNT
.
              PACK      KEY17,HRECPT,RCDTTCNT,SP70
              CALL      RARCDTE1
              IF        OVRCD = 1
                CALL      WRRDB200
              ELSE
                GOTO      RPAB6500
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      THREE,WBBRSTAT          * set as released to suspense acc
          CALL      UPWBBRD3
.
.         MOVE      THREE,UNLKFLAG
.         CALL      UNLS0000
.
          GOTO      RPAB1000
.*******************************************************************************
.
.         A record was locked for this claim, so set the status to "locked"
.
RPAB8000  MOVE      ONE,WBBRSTAT
          CALL      UPWBBRD3
          GOTO      RPAB1000
.
.         Check if all the payment records for the ERA were released and
.         update the ERA header status accordingly.
.
RPAB9000  IF        ERDCOUNT = (PRLCOUNT+RELCOUNT)
            MOVE      "2",WBBHSTAT               * set to "released"
          ELSE
            MOVE      "1",WBBHSTAT               * set to "partial"
          ENDIF
          CALL      UPWBBRH1
.
          IF        IBCNMHOS=1
            MATCH     "2",WBBHSTAT
            IF        @EQUAL
              CALL      CDERB200
            ENDIF
          ENDIF
.
.         Unlock general records.
.
          MATCH     "1",MULTLT01
          IF        @EQUAL
            MOVE      "2",DIM1C
            PACK      PAYMTKEY,WBBHHOSP,WBBHPYPN,WBBHPRUN,WBBHPDAT:
                               WBBHRKEY,SP70
            CALL      PRNRMB00
          ENDIF
.
          MATCH     "1",WBBHSTAT
          IF        @EQUAL
            MOVE      "Payment record partially released.",WEBTITLE
          ELSE
            MOVE      "Payment record released.",WEBTITLE
          ENDIF
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RPAB9999
.
RPAB9950  MOVE      "Payment Currently being processed.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RPAB9999
.
RPAB9960  MOVE      "Cannot find outerhaf record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RPAB9999
.
RPAB9999  RETURN
+
.-------------------------------------------------------------------
.Check for duplicate remittance in multi hospital remittance release
.-------------------------------------------------------------------
CDERB200  PACK      SAVKEY47,WBBHHOSP,WBBHPYPN,WBBHPRUN,WBBHPDAT,WBBHRKEY,SP70
.
          PACK      KEY47,SP3,WBBHPYPN,WBBHPRUN,WBBHPDAT,WBBHRKEY,SP70
          CALL      RDWBBRH1
          BRANCH    OVRCD,CDERB290
.
          MOVE      "2",WBBHSTAT
.
          CALL      UPWBBRH1
.
CDERB290  MOVE      SAVKEY47,KEY47
          CALL      RDWBBRH1
.
CDERB299  RETURN
+
.---------------------------------------------------------------------------
.         WRRDB100 - Write to rcpdteaf
.---------------------------------------------------------------------------
.
WRRDB100  CALL      IBACLOCK
          PACK      RCDTTDAT,CCC,CYY,CMM,CDD
          REP       " 0",RCDTTDAT
          MOVE      HRECPT,RCDTRECN
.         MOVE      "    1",RCDTTCNT
.
          PACK      RCDTINVN,WBBSINVN,SP70
          RJUSTIFY  RCDTINVN
          MOVE      WBBSUNIQ,RCDTVIST
          MOVE      WBBSURNO,RCDTURNO
          MOVE      WBBSURNO,KEY8
          CALL      RDMAST1
          IF        OVRCD = 0
            MOVE      PSNAME,PACSNAME
            MOVE      PGNAME,PACGNAME
            MOVE      PTITL,PACTITLE
            MOVE      TWO,PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,RCDTNAME
            MOVE      PADD1,RCDTADD1
            MOVE      PADD2,RCDTADD2
            MOVE      PSUBRB,RCDTADD3
            MOVE      PADD4,RCDTADD4
            MOVE      PPOST,RCDTPOST
          ELSE
            MOVE      SP70,RCDTNAME
            MOVE      SP70,RCDTADD1
            MOVE      SP70,RCDTADD2
            MOVE      SP70,RCDTADD3
            MOVE      SP70,RCDTADD4
            MOVE      SP70,RCDTPOST
          ENDIF
          MOVE      SP70,RCDTSFLG
          MOVE      WBBRPRUN,RCDTREFR
          MOVE      WBBSHOSP,RCDTMHOS
.
          MOVE      SP70,RCDTREGI
.
          MATCH     "2",WBBSMODL
          IF        @EQUAL
.
            MOVE      WBBSINVN,DIM8
            RJUSTIFY  DIM8
.
            PACK      KEY22,DIM8,SP70
            CALL      RSPRDT4
            CALL      RKPRDT4
            IF        OVRCD=0
              MATCH     DIM8,PRDTINVN
              IF        @EQUAL
                PACK      KEY27,PRDTUNIQ,PRDTPRAC,PRDTDOCT,PRDTCODE,Sp70
                CALL      RDPRHR1
                IF        OVRCD=0
                  MATCH     SP70,PRHRPRAC
                  IF        !@EQUAL
                    PACK      KEY6,PRHRPRAC,SP70
                    CALL      RDPRPR1
                    IF        OVRCD=0
                      MOVE      PRPRREGI,RCDTREGI
                      MATCH     SP70,PRPRREGI
                      IF        !@EQUAL
                        PACK      KEY3,PRPRREGI,SP70
                        CALL      RDREGA1
                        IF        OVRCD=0
                          MATCH     SP70,REGHOSP
                          IF        !@EQUAL
                            MOVE      REGHOSP,RCDTMHOS
                          ENDIF
                        ENDIF
                      ENDIF
                    ENDIF
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
.
          ELSE
.
            MOVE      RCCNERRE,RCDTREGI
            IF        IBCNMHOS=1
.
              MATCH     SP70,RCDTMHOS
              IF        !@EQUAL & !@EOS
                PACK      KEY3,RCDTMHOS,SP70
                CALL      RDPTHSP1
                IF        OVRCD=0
                  MATCH     SP70,PTHSERRE
                  IF        !@EQUAL & !@EOS
                    MOVE      PTHSERRE,RCDTREGI
                  ENDIF
                ENDIF
              ENDIF
.
              PACK      KEY8,WBBSUNIQ,SP70
              CALL      RDPMVX11
              IF        OVRCD=0
                MATCH     SP70,PMVXMHOS
                IF        !@EQUAL & !@EOS
                  PACK      KEY3,PMVXMHOS,SP70
                  CALL      RDPTHSP1
                  IF        OVRCD=0
                    MATCH     SP70,PTHSERRE
                    IF        !@EQUAL & !@EOS
                      MOVE      PTHSERRE,RCDTREGI
                      MOVE      PMVXMHOS,RCDTMHOS
                    ENDIF
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
.
          ENDIF
.
          MOVE      SP70,RCDTGSTC
          CALL      GTACCB00
.
          RJUSTIFY  WBBRCLBP
          UNPACK    WBBRCLBP,DIM7,DIM2
          PACK      DIM10,DIM7,FULLSTOP,DIM2
          MOVE      ZERO,FORM7P2C
.
          SCAN      "-",DIM10
          IF        @EQUAL
            REP        "-0",DIM10
            MOVE       DIM10,FORM7P2C
            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
          ELSE
            MOVE      DIM10,FORM7P2C
          ENDIF
          MOVE      FORM7P2C,RCDTAMNT
.
          MOVE      ZERO,RCDTDISC
          MOVE      CHOSPNUM,RCDTMDHS
          MOVE      SP70,RCDTGSTA
          MOVE      SP70,RCDTALLO
          CALL      IBACLOCK
.         PACK      RCDTRELD,CCC,CYY,CMM,CDD
.         REP       " 0",RCDTRELD
.         MOVE      CTIMEIS,RCDTRELT
          MOVE      SP70,RCDTRELD
          MOVE      SP70,RCDTRELT
          PACK      RCDTCDAT,CCC,CYY,CMM,CDD
          REP       " 0",RCDTCDAT
          MOVE      SP70,RCDTPRAC
          MOVE      CTIMEIS,RCDTCTIM
          MOVE      WBSEUID,RCDTCUID
          MOVE      SP70,RCDTUDAT
          MOVE      SP70,RCDTUTIM
          MOVE      SP70,RCDTUUID
          MOVE      SP70,RCDTDPTY
          MOVE      SP70,RCDTGLEX
          MOVE      WBBSBATN,RCDTBATN
          MOVE      SP70,RCDTSPAR
.
          PACK      KEY17,RCDTRECN,RCDTTCNT,SP70
          CALL      WRRCDTE1
.
WRRDB199  RETURN
+
.------------------------------------------------------------------------------
.  Get Income account and Control Account
.------------------------------------------------------------------------------
.
GTACCB00  PACK      KEY3,RCDTREGI,SP70
          CALL      RDREGA1
          BRANCH    OVRCD,GTACCB80
.         MOVE      REGHOSP,RCDTMHOS       * Hospital id
          MOVE      REGGST,RCDTGSTC        * GST Code
.
          COMPARE   FIVE,HSYS1
          GOTO      GTACCB20 IF EQUAL      * Using Integra Extended
          COMPARE   FOUR,HSYS1
          GOTO      GTACCB20 IF EQUAL      * Using Comma Delimeted
          COMPARE   TWO,HSYS1
          GOTO      GTACCB20 IF EQUAL      * Using Other FMS - get Acc.from Reg.
          COMPARE   THREE,HSYS1
          GOTO      GTACCB20 IF EQUAL      * Using Other FMS - for Integra
.
          MATCH     SP20,REGGENLD
          GOTO      GTACCB80 IF EQUAL
          GOTO      GTACCB80 IF EOS
.
          MOVE      REGGENLD,RCDTINCA
          MOVE      REGGENLD,INCMACCT
          CALL      GETC0000              * Get Control Account Details
          PACK      RCDTBNKA,FMLALEDG,FMCSBNK
          GOTO      GTACCB99
.
.         Get Credit and Bank Account from Register record
.
GTACCB20  MOVE      REGGENDB,RCDTINCA       * Debtors Control account as Crd.Acc
          MOVE      REGGENBK,RCDTBNKA       * Debit account
          GOTO      GTACCB99
.
GTACCB80  MOVE      SP70,RCDTINCA
          MOVE      WBBHACCN,RCDTBNKA
          GOTO      GTACCB99
.
GTACCB99 RETURN
+
.---------------------------------------------------------------------------
.         WRRDB200 - Write to rcpdteaf suspense account
.---------------------------------------------------------------------------
WRRDB200  CALL      IBACLOCK
          PACK      RCDTTDAT,CCC,CYY,CMM,CDD
          REP       " 0",RCDTTDAT
          MOVE      HRECPT,RCDTRECN
.         MOVE      "    1",RCDTTCNT
.         MOVE      PMEDARID,RCDTINVN
.         PACK      RCDTINVN,PMEDARID,SP70
.         RJUSTIFY  RCDTINVN
          MOVE      SP70,RCDTINVN
          MOVE      SP70,RCDTVIST
          MOVE      SP70,RCDTURNO
.         MOVE      PMECURNO,KEY8
.         CALL      RDMAST1
.         IF        OVRCD = 0
.           MOVE      PSNAME,PACSNAME
.           MOVE      PGNAME,PACGNAME
.           MOVE      PTITL,PACTITLE
.           MOVE      TWO,PACFRMT
.           CALL      PACNAME
.           MOVE      PACFNAME,RCDTNAME
.           MOVE      PADD1,RCDTADD1
.           MOVE      PADD2,RCDTADD2
.           MOVE      PSUBRB,RCDTADD3
.           MOVE      PADD4,RCDTADD4
.           MOVE      PPOST,RCDTPOST
.         ELSE
            REP       "#" ",SERDIM50
            MOVE      SERDIM50,RCDTNAME
            MOVE      SP70,RCDTADD1
            MOVE      SP70,RCDTADD2
            MOVE      SP70,RCDTADD3
            MOVE      SP70,RCDTADD4
            MOVE      SP70,RCDTPOST
.         ENDIF
          MOVE      SP70,RCDTSFLG
          MOVE      WBBHPRUN,RCDTREFR
          MOVE      WBBHHOSP,RCDTMHOS
.
          MOVE      RCCNERRS,RCDTREGI
.         IF        IBCNMHOS=1
.           MATCH     SP70,RCDTMHOS
.           IF        !@EQUAL & !@EOS
.             PACK      KEY3,RCDTMHOS,SP70
.             CALL      RDPTHSP1
.             IF        OVRCD=0
.               MATCH     SP70,PTHSERRE
.               IF        !@EQUAL & !@EOS
.                 MOVE      PTHSERRE,RCDTREGI
.               ENDIF
.             ENDIF
.           ENDIF
.         ENDIF
.
          MOVE      SP70,RCDTGSTC
          CALL      GTACCB00
.
          MOVE      SP70,DIM2
          MOVE      SP70,DIM7
          MOVE      SP70,DIM10
.
          RJUSTIFY  WBBRCLBP
          UNPACK    WBBRCLBP,DIM7,DIM2
          PACK      DIM10,DIM7,FULLSTOP,DIM2
          MOVE      ZERO,FORM7P2C
.
          SCAN      "-",DIM10
          IF        @EQUAL
            REP        "-0",DIM10
            MOVE       DIM10,FORM7P2C
            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
          ELSE
            MOVE      DIM10,FORM7P2C
          ENDIF
          MOVE      FORM7P2C,RCDTAMNT
.
          MOVE      ZERO,RCDTDISC
          MOVE      CHOSPNUM,RCDTMDHS
          MOVE      SP70,RCDTGSTA
          MOVE      "2",RCDTALLO
          CALL      IBACLOCK
.         PACK      RCDTRELD,CCC,CYY,CMM,CDD
.         REP       " 0",RCDTRELD
.         MOVE      CTIMEIS,RCDTRELT
          MOVE      SP70,RCDTRELD
          MOVE      SP70,RCDTRELT
          PACK      RCDTCDAT,CCC,CYY,CMM,CDD
          REP       " 0",RCDTCDAT
          MOVE      SP70,RCDTPRAC
          MOVE      CTIMEIS,RCDTCTIM
          MOVE      WBSEUID,RCDTCUID
          MOVE      SP70,RCDTUDAT
          MOVE      SP70,RCDTUTIM
          MOVE      SP70,RCDTUUID
          MOVE      SP70,RCDTDPTY
          MOVE      SP70,RCDTGLEX
          MOVE      SP70,RCDTBATN
          MOVE      SP70,RCDTSPAR
.
          PACK      KEY17,RCDTRECN,RCDTTCNT,SP70
          CALL      WRRCDTE1
.
WRRDB299  RETURN
+
.------------------------------------------------------------
. WebServices BBSW BPYW Payment Report Enquiry tags
.------------------------------------------------------------
ERLB0000  BRANCH    FLDITMNO,ERLB0100,ERLB0200,ERLB0300,ERLB0400,ERLB0500:
                             ERLB0600,ERLB0700,ERLB0800,ERLB0900,ERLB1000:
                             ERLB1100,ERLB1200,ERLB1300,ERLB1400,ERLB1500:
                             ERLB1600,ERLB1700,ERLB1800,ERLB1900,ERLB2000:
                             ERLB2100,ERLB2200,ERLB2300,ERLB2400,ERLB2500:
                             ERLB2600,ERLB2700,ERLB2800,ERLB2900,ERLB3000:
                             ERLB3100,ERLB3200,ERLB3300,ERLB3400,ERLB3500:
                             ERLB3600,ERLB3700,ERLB3800,ERLB3900,ERLB4000
.
          GOTO      ERLB9999
.
ERLB0100  UNPACK    DIM127,D1,UNRELREM,DIM127
          UNPACK    DIM127,D1,UNRELINQ,DIM127
          UNPACK    DIM127,D1,ERASTATS,DIM127
.
          CALL      ERTB0000
          GOTO      ERLB9999
.
ERLB0200  CALL      ERDD0000
          GOTO      ERLB9999
.
ERLB0300  WRITE     HTMLFILE;WBBHPYPN;
          GOTO      ERLB9999
.
ERLB0400  WRITE     HTMLFILE;WBBHPRUN;
          GOTO      ERLB9999
.
ERLB0500  MATCH     SP70,WBBHPDAT
          GOTO      ERLB9999 IF EQUAL
          UNPACK    WBBHPDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      ERLB9999
.
ERLB0600  RJUSTIFY  WBBHDAMN
          UNPACK    WBBHDAMN,DIM7,DIM2
          PACK      DIM10,DIM7,FULLSTOP,DIM2
          MOVE      DIM10,FORM7P2C
          WRITE     HTMLFILE;FORM7P2C;
          GOTO      ERLB9999
.
ERLB0700  WRITE     HTMLFILE;WBBHBSBC;
          GOTO      ERLB9999
.
ERLB0800  WRITE     HTMLFILE;WBBHACCN;
          GOTO      ERLB9999
.
ERLB0900  WRITE     HTMLFILE;WBBHACNM;
          GOTO      ERLB9999
.
ERLB1000  MATCH     SP70,WBBRLDAT
          GOTO      ERLB9999 IF EQUAL
          UNPACK    WBBRLDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      ERLB9999
.
ERLB1100  RJUSTIFY  WBBRCLBP
          UNPACK    WBBRCLBP,DIM7,DIM2
          PACK      DIM10,DIM7,FULLSTOP,DIM2
          MOVE      DIM10,FORM7P2C
          WRITE     HTMLFILE;FORM7P2C;
          GOTO      ERLB9999
.
ERLB1200  RJUSTIFY  WBBRCLCA
          UNPACK    WBBRCLCA,DIM7,DIM2
          PACK      DIM10,DIM7,FULLSTOP,DIM2
          MOVE      DIM10,FORM7P2C
          WRITE     HTMLFILE;FORM7P2C;
          GOTO      ERLB9999
.
ERLB1300
.         UNPACK    OTERDAMN,DIM7,DIM2
.         PACK      DIM10,DIM7,FULLSTOP,DIM2
.         MOVE      DIM10,FORM7P2C
.         WRITE     HTMLFILE;FORM7P2C;
.         GOTO      ERLB9999
.
ERLB1400  WRITE     HTMLFILE;WBBRTRID;
          GOTO      ERLB9999
.
ERLB1500  MATCH     "0",WBBHSTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Received";
            GOTO      ERLB9999
          ENDIF
.
          MATCH     "1",WBBHSTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Locked";
            GOTO      ERLB9999
          ENDIF
.
          MATCH     "2",WBBHSTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Released";
            GOTO      ERLB9999
          ENDIF
.
          MATCH     "3",WBBHSTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Released - Suspense Register";
            GOTO      ERLB9999
          ENDIF
.
          WRITE     HTMLFILE;"Unknown";
.
          GOTO      ERLB9999
.
ERLB1600  CALL      GCMS0000
          WRITE     HTMLFILE;CLAMTOTL;
          GOTO      ERLB9999
.
ERLB1700  CALL      GCMB0000
          WRITE     HTMLFILE;CLAMTOTL;
          GOTO      ERLB9999
.
ERLB1800
.         WRITE     HTMLFILE;PMEDRADV;
          GOTO      ERLB9999
.
ERLB1900
.         WRITE     HTMLFILE;PMEDPNUM;
          GOTO      ERLB9999
.
ERLB2000
.         WRITE     HTMLFILE;PMEDTRID;
          GOTO      ERLB9999
.
ERLB2100
.         WRITE     HTMLFILE;PMEDARID;
          GOTO      ERLB9999
.
ERLB2200
.         UNPACK    PMEDBAMT,DIM7,DIM2
.         PACK      DIM10,DIM7,FULLSTOP,DIM2
..        MOVE      DIM10,FORM7P2C
.         MOVE      ZERO,FORM7P2C
.         SCAN      "-",DIM10
.         IF        @EQUAL
.           REP        "-0",DIM10
.           MOVE       DIM10,FORM7P2C
.           ASSIGN     (FORM7P2C*SEQ),FORM7P2C
.         ELSE
.           MOVE      DIM10,FORM7P2C
.         ENDIF
.         WRITE     HTMLFILE;FORM7P2C;
          GOTO      ERLB9999
.
ERLB2300
.         WRITE     HTMLFILE;PMEDCCOD;
          GOTO      ERLB9999
.
ERLB2400
.         MATCH     SP70,PMEDLDAT
.         GOTO      ERLB9999 IF EQUAL
.         UNPACK    PMEDLDAT,CCENT,CYEAR,CMON,CDAY
.         MOVE      CMON,F2
.         LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.         WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      ERLB9999
.
ERLB2500
.         WRITE     HTMLFILE;PMEDPARI;
          GOTO      ERLB9999
.
ERLB2600
.         WRITE     HTMLFILE;PMEDPTID;
          GOTO      ERLB9999
.
ERLB2700
.         MATCH     "0",PMEDSTAT
.         IF        @EQUAL
.           WRITE     HTMLFILE;"Received";
.           GOTO      ERLB9999
.         ENDIF
.
.         MATCH     "1",PMEDSTAT
.         IF        @EQUAL
.           WRITE     HTMLFILE;"Locked";
.           GOTO      ERLB9999
.         ENDIF
.
.         MATCH     "2",PMEDSTAT
.         IF        @EQUAL
.           WRITE     HTMLFILE;"Released";
.           GOTO      ERLB9999
.         ENDIF
.
.         MATCH     "3",PMEDSTAT
.         IF        @EQUAL
.           WRITE     HTMLFILE;"Released - Suspense";
.           GOTO      ERLB9999
.         ENDIF
.
.          WRITE     HTMLFILE;"Unknown";
.
          GOTO      ERLB9999
.
ERLB2800
.         UNPACK    DIM127,D1,DIM1,DIM127
.         MOVE      ZERO,FORM1
.         MOVE      DIM1,FORM1
.         BRANCH    FORM1,ERLB2810
.
.         WRITE     HTMLFILE;PARTCODE;
          GOTO      ERLB9999
.
ERLB2810
.         PACK      KEY3,PARTCODE,SP70
.         CALL      RDPTPAR1
.         BRANCH    OVRCD,ERLB9999
.
.         WRITE     HTMLFILE;PTPRNAME;
.         GOTO      ERLB9999
.
ERLB2900  WRITE     HTMLFILE;HOSPCODE,ECREPYPN,ECREPRUN,ECREPDAT,ECRERKEY;
          GOTO      ERLB9999
.
ERLB3000  CALL      SELP0000
          GOTO      ERLB9999
.
ERLB3100  CALL      PRVR0000
          GOTO      ERLB9999
.
ERLB3200  CALL      NXTR0000
          GOTO      ERLB9999
.
ERLB3300  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      ERLB9999
.
ERLB3400  WRITE     HTMLFILE;EXDTBLNK;
          GOTO      ERLB9999
.
ERLB3500  CALL      HSPSEL00
          GOTO      ERLB9999
.
ERLB3600  WRITE     HTMLFILE;WBBHRKEY;
          GOTO      ERLB9999
.
ERLB3700  WRITE     HTMLFILE;WBBRCLID;
          GOTO      ERLB9999
.
ERLB3800  WRITE     HTMLFILE;WBBRRKEY;
          GOTO      ERLB9999
.
ERLB3900  MATCH     "0",WBBRSTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Received";
            GOTO      ERLB9999
          ENDIF
.
          MATCH     "1",WBBRSTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Locked";
            GOTO      ERLB9999
          ENDIF
.
          MATCH     "2",WBBRSTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Released";
            GOTO      ERLB9999
          ENDIF
.
          MATCH     "3",WBBRSTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Released - Suspense Register";
            GOTO      ERLB9999
          ENDIF
.
          WRITE     HTMLFILE;"Unknown";
.
          GOTO      ERLB9999
.
ERLB4000  PACK      KEY20,WBBHPYPN,SP70
          CALL      RSPMHCP3
          CALL      RKPMHCP3
          BRANCH    OVRCD,ERLB4100
.
          PACK      DIM10,WBBHPYPN,SP70
          MATCH     DIM10,PMHCPRV1
          GOTO      ERLB4100 IF NOT EQUAL
.
          MOVE      PMHCTITL,FMTTITLE             * Got them - set up name flds
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000                      * Format name
.
          WRITE     HTMLFILE;DOCFNAME;
          GOTO      ERLB9999
.
ERLB4100  WRITE     HTMLFILE;WBBHPYPN;
          GOTO      ERLB9999
.
ERLB9999  RETURN
+
.------------------------------------------------------------
. Get claim amount for a specific transaction id
.------------------------------------------------------------
GCMB0000  MOVE      ZERO,CLAMTOTL
.
          MATCH     "1",PTCNBBSW
          GOTO      GCMB9999 IF NOT EQUAL
.
          PACK      KEY40,WBBRTRID,SP30,SP10
          CALL      RSWBBBS6                     * position on trans. id
          CALL      RKWBBBS6                     * read next record
          BRANCH    OVRCD,GCMB9999                * eof - not found
.
          MATCH     WBBRTRID,WBBSTRID            * same transaction id still ?
          GOTO      GCMB9999 IF NOT EQUAL        * no - not found
.
          MOVE      WBBSAMTC,CLAMTOTL            * update ERA claim total
.
GCMB9999  RETURN
+
.*****************************************************************************
.*                            GCMS0000                                       *
.*              Get the claimed amount total for the Payment Report          *
.* Requires:  Valid read on webbrhaf record (ERA Header)                     *
.* Returns:   CLAMTOTL - total claimed amount for the payment batch          *
.*****************************************************************************
.
GCMS0000  MOVE      ZERO,CLAMTOTL                * initialise total amount
.
          MATCH     "1",PTCNBBSW
          GOTO      GCMS9999 IF NOT EQUAL
.
.         Loop through outerdaf looking for payments from the selected report
.
          PACK      KEY77,WBBHRKEY,WBBHHOSP,WBBHPYPN,WBBHPRUN,WBBHPDAT,SP70
          CALL      RSWBBRD3                     * position in file
GCMS1000  CALL      RKWBBRD3                     * read next record
          BRANCH    OVRCD,GCMS9999               * end of file
.
          MATCH     WBBHRKEY,WBBRRKEY
          GOTO      GCMS9999 IF NOT EQUAL
.
          MATCH     WBBHHOSP,WBBRHOSP
          GOTO      GCMS9999 IF NOT EQUAL
.
          MATCH     WBBHPYPN,WBBRPYPN
          GOTO      GCMS9999 IF NOT EQUAL
.
          MATCH     WBBHPRUN,WBBRPRUN
          GOTO      GCMS9999 IF NOT EQUAL
.
          MATCH     WBBHPDAT,WBBRPDAT
          GOTO      GCMS9999 IF NOT EQUAL
.
.         A payment has been found, so now get the claimed amount
.         from webbbsaf
.
          PACK      KEY40,WBBRTRID,SP30,SP10
          CALL      RSWBBBS6                     * position on trans. id
          CALL      RKWBBBS6                     * read next record
          BRANCH    OVRCD,GCMS1000               * eof - not found
.
          MATCH     WBBRTRID,WBBSTRID            * same transaction id still ?
          GOTO      GCMS1000 IF NOT EQUAL        * no - not found
.
          ADD       WBBSAMTC,CLAMTOTL            * update ERA claim total
          GOTO      GCMS1000                     * get next payment
.
GCMS9999  RETURN
+
.------------------------------------------------------------
. WebServices BBSW BPYW Payment Details
.------------------------------------------------------------
ERDD0000  MATCH     "1",PTCNBBSW
          GOTO      ERDD9999 IF NOT EQUAL
.
          CALL      ERDDH000
.
          PACK      KEY77,WBBHRKEY,WBBHHOSP,WBBHPYPN,WBBHPRUN,WBBHPDAT,SP70
          CALL      RSWBBRD3
ERDD1000  CALL      RKWBBRD3
          BRANCH    OVRCD,ERDD9999
.
          MATCH     WBBHRKEY,WBBRRKEY
          GOTO      ERDD9999 IF NOT EQUAL
.
          MATCH     WBBHHOSP,WBBRHOSP
          GOTO      ERDD9999 IF NOT EQUAL
.
          MATCH     WBBHPYPN,WBBRPYPN
          GOTO      ERDD9999 IF NOT EQUAL
.
          MATCH     WBBHPRUN,WBBRPRUN
          GOTO      ERDD9999 IF NOT EQUAL
.
          MATCH     WBBHPDAT,WBBRPDAT
          GOTO      ERDD9999 IF NOT EQUAL
.
          MOVE      SP70,DIFCINDC
          IF        IBCNMHOS=1
            PACK      KEY40,WBBRTRID,SP70
            CALL      RSWBBBS6
            CALL      RKWBBBS6
            BRANCH    OVRCD,ERDD5000
.
            MATCH     WBBRCLID,WBBSTRID
            GOTO      ERDD5000 IF NOT EQUAL
.
            MATCH     SP70,WBBSHOSP
            IF        !@EQUAL & !@EOS
              MATCH     WBBSHOSP,WBSEHOSP
              IF        !@EQUAL
                PACK      KEY3,WBBSHOSP,SP70
                CALL      RDPTHSP1
                IF        OVRCD=0
                  MOVE      PTHSLOCN,SAVELOCN
                ELSE
                  MOVE      SP70,SAVELOCN
                ENDIF
.
                PACK      KEY3,WBSEHOSP,SP70
                CALL      RDPTHSP1
                IF        OVRCD=0
.
                  MATCH     SAVELOCN,PTHSLOCN
.                  GOTO      ERDD1000 IF NOT EQUAL
                  IF        @EQUAL
                    MOVE      "1",DIFCINDC
                  ENDIF
.
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
ERDD5000  CALL      ERDDR000
.
          GOTO      ERDD1000
.
ERDD9999  RETURN
+
.------------------------------------------------------------
. WebServices BBSW NPYW Payment Details (TABLE HEADING)
.------------------------------------------------------------
ERDDH000  WRITE     HTMLFILE;"<tr>":
                             "<td class=HeadingCell width=30%>":
                             "Claim Tran ID</td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell width=10%>":
                             "Benefit<br>Amount</td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell width=10%>":
                             "Claimed<br>Amount</td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell width=10%>":
                             "Batch<br>Number</td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell width=10%>":
                             "Status</td>":
                             "<td class=HeadingCell width=10%>":
                             "Claim ID</td>":
                             "<td class=HeadingCell width=15% align=center>":
                             "Lodgement<br>Date</td>":
.                            "<td class=HeadingCell width=15%>":
.                            "Transaction ID<br>&nbsp;</td>":
                             "</tr>"
.
ERDDH999  RETURN
+
.------------------------------------------------------------
. WebServices BBSW BPYW Payment Details (Detail Row)
.------------------------------------------------------------
ERDDR000  REP       " +",HOSPCODE
          REP       " +",WBBRPYPN
          REP       " +",WBBRPRUN
          REP       " +",WBBRPDAT
          REP       " +",WBBRCLID
          REP       " +",WBBRTRID
.
          WRITE     HTMLFILE;"<tr><td><img src='../images/CommentIcon.gif'":
                             " class=ListIcon onclick=displayRemD('":
  HOSPCODE,"','",WBBRPYPN,"','",WBBRPRUN,"','",WBBRPDAT,"','",WBBRCLID,"','",WBBRTRID,"','D');>&nbsp;";
.
          REP       "+ ",HOSPCODE
          REP       "+ ",WBBRPYPN
          REP       "+ ",WBBRPRUN
          REP       "+ ",WBBRPDAT
          REP       "+ ",WBBRCLID
          REP       "+ ",WBBRTRID
.
          MATCH     "1",DIFCINDC
          IF        @EQUAL
            WRITE     HTMLFILE;"<font color=red>";
          ENDIF
.
          WRITE     HTMLFILE;WBBRTRID;
.
          CALL      CLWEBBBS
          PACK      KEY40,WBBRTRID,SP70
          CALL      RSWBBBS6
          CALL      RKWBBBS6
          IF        OVRCD=0
.
            MATCH     WBBRTRID,WBBSTRID
            IF        !@EQUAL
              CALL      CLWEBBBS
            ENDIF
.
          ENDIF
.
          WRITE     HTMLFILE;"&nbsp;",WBBSHOSP;
.
          MATCH     "1",DIFCINDC
          IF        @EQUAL
            WRITE     HTMLFILE;"</font>";
          ENDIF
.
          WRITE     HTMLFILE;"</td>";
.
          RJUSTIFY  WBBRCLBP
          UNPACK    WBBRCLBP,DIM7,DIM2
          PACK      DIM10,DIM7,DOT,DIM2
.         MOVE      DIM10,FORM7P2C
          MOVE      ZERO,FORM7P2C
          SCAN      "-",DIM10
          IF        @EQUAL
            REP        "-0",DIM10
            MOVE       DIM10,FORM7P2C
            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
          ELSE
            MOVE      DIM10,FORM7P2C
          ENDIF
.
          MATCH     "1",DIFCINDC
          IF        @EQUAL
            WRITE     HTMLFILE;"<td><font color=red>",FORM7P2C,"</font></td>";
          ELSE
            WRITE     HTMLFILE;"<td>",FORM7P2C,"</td>";
          ENDIF
.
          MOVE      ZERO,CLAMTOTL
          PACK      KEY40,WBBRTRID,SP30,SP10
          CALL      RSWBBBS6                     * position on trans. id
          CALL      RKWBBBS6                     * read next record
          BRANCH    OVRCD,ERDDR100                * eof - not found
.
          MATCH     WBBRTRID,WBBSTRID            * same transaction id still ?
          GOTO      ERDDR100 IF NOT EQUAL        * no - not found
.
          MOVE      WBBSAMTC,CLAMTOTL            * update ERA claim total
.
ERDDR100  MATCH     "1",DIFCINDC
          IF        @EQUAL
            WRITE     HTMLFILE;"<td><font color=red>",CLAMTOTL,"</font></td>";
.
            WRITE     HTMLFILE;"<td><font color=red>",WBBSBATN,"</font></td>";
          ELSE
            WRITE     HTMLFILE;"<td>",CLAMTOTL,"</td>";
.
            WRITE     HTMLFILE;"<td>",WBBSBATN,"</td>";
          ENDIF
.
          MOVE      "Unknown  ",DIM9
          MATCH     "0",WBBRSTAT
          IF        @EQUAL
            MOVE      "Received ",DIM9
          ENDIF
.
          MATCH     "1",WBBRSTAT
          IF        @EQUAL
            MOVE      "Locked   ",DIM9
          ENDIF
.
          MATCH     "2",WBBRSTAT
          IF        @EQUAL
            MOVE      "Released",DIM9
          ENDIF
.
          MATCH     "3",WBBRSTAT
          IF        @EQUAL
            MOVE      "Released*",DIM9
          ENDIF
.
          MATCH     "1",DIFCINDC
          IF        @EQUAL
            WRITE     HTMLFILE;"<td><font color=red>",DIM9,"</font></td>";
.
            WRITE     HTMLFILE;"<td><font color=red>",WBBRCLID,"</font></td>";
          ELSE
            WRITE     HTMLFILE;"<td>",DIM9,"</td>";
.
            WRITE     HTMLFILE;"<td>",WBBRCLID,"</td>";
          ENDIF
.
          MOVE      SP70,DIM11
          MATCH     SP70,WBBRPDAT
          IF        !@EQUAL & !@EOS
            UNPACK    WBBRPDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DIM11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MATCH     "1",DIFCINDC
          IF        @EQUAL
            WRITE     HTMLFILE;"<td><font color=red>",DIM11,"</font></td>";
.
.           WRITE     HTMLFILE;"<td><font color=red>",WBBRTRID,"</font></td>";
          ELSE
            WRITE     HTMLFILE;"<td>",DIM11,"</td>";
.
.           WRITE     HTMLFILE;"<td>",WBBRTRID,"</td>";
          ENDIF
.
          WRITE     HTMLFILE;"</tr>";
.
ERDDR999  RETURN
+
.***************************************************************************
.*                             ERTB0000                                    *
.*   Set the hospital filter and call ERTD0000                             *
.*   If multi hospital call ERTD0000 for each of the users hositals        *
.***************************************************************************
ERTB0000  IF        IBCNMHOS<>1
            MOVE      SP70,FILTHOSP         * Not multi hospital so blank
            CALL      ERTD0000
            GOTO      ERTB9999
          ENDIF
.
.   Multi Hospital
.
          MATCH     SP70,FILTHOSP           * User has selected a hospital
          IF        !@EQUAL
            CALL      ERTD0000
            GOTO      ERTB9999
          ENDIF
.
          PACK      KEY3,SP70               * Show all users available
          CALL      RSPTHSP1                * hospitals
ERTB5000  CALL      RKPTHSP1
          BRANCH    OVRCD,ERTB9000
.
          PACK      KEY13,USERID,SP70                * All hospital access
          CALL      RDMLSEC1
          IF        OVRCD=1
            PACK      KEY13,USERID,PTHSHOSP,SP70     * This hospital access
            CALL      RDMLSEC1
            BRANCH    OVRCD,ERTB5000
          ENDIF
.
          MOVE      PTHSHOSP,FILTHOSP
          CALL      ERTD0000
.
          PACK      KEY3,FILTHOSP,SP70               * reposition
          CALL      RSPTHSP1
          GOTO      ERTB5000
.
ERTB9000  MOVE      SP70,FILTHOSP           * Restore all hospitals filter
.
ERTB9999  RETURN
+
.***************************************************************************
.*                             ERTD0000                                    *
.*   Display all the remittance batches received from a given participant  *
.***************************************************************************
ERTD0000  MATCH     "1",PTCNBBSW
          GOTO      ERTD9999 IF NOT EQUAL
.
          MOVE      ZERO,LOOPCNTR
.
          PACK      KEY48,FILTHOSP,ERASTATS,Z70
          CALL      RSWBBRH3
ERTD1000  CALL      RPWBBRH3
          BRANCH    OVRCD,ERTD9999               * end of file
.
          MATCH     FILTHOSP,WBBHHOSP
          GOTO      ERTD9999 IF NOT EQUAL
.
          MATCH     ERASTATS,WBBHSTAT
          GOTO      ERTD9999 IF NOT EQUAL
.
.------------------------------------------------------
. Loop counter to prevent timeout internal server error
.
           ADD       ONE,LOOPCNTR
.
           IF        (LOOPCNTR = 500)
             WRITE     HTMLFILE;"// ",LOOPCNTR
             MOVE      ZERO,LOOPCNTR
           ENDIF
.
. -----------------------------------------------------
.
          PACK      KEY77,WBBHRKEY,WBBHHOSP,WBBHPYPN,WBBHPRUN,WBBHPDAT,SP70
          CALL      RSWBBRD3
          CALL      RKWBBRD3
          BRANCH    OVRCD,ERTD1000
.
          MATCH     WBBHRKEY,WBBRRKEY
          GOTO      ERTD1000 IF NOT EQUAL
.
          MATCH     WBBHHOSP,WBBRHOSP
          GOTO      ERTD1000 IF NOT EQUAL
.
          MATCH     WBBHPYPN,WBBRPYPN
          GOTO      ERTD1000 IF NOT EQUAL
.
          MATCH     WBBHPRUN,WBBRPRUN
          GOTO      ERTD1000 IF NOT EQUAL
.
          MATCH     WBBHPDAT,WBBRPDAT
          GOTO      ERTD1000 IF NOT EQUAL
.
.         A payment for the report has been found, so now if it belongs
.         to outectaf
.
          PACK      KEY40,WBBRTRID,SP30,SP10
          CALL      RSWBBBS6
          CALL      RKWBBBS6
          BRANCH    OVRCD,ERTD1000
.
          MATCH     WBBRTRID,WBBSTRID            * if its not in outectaf
          GOTO      ERTD1000 IF NOT EQUAL        * then its probably a dbs
.                                                * claim
.
.
          MATCH     "1",UNRELREM
          IF        @EQUAL
            MATCH     "2",WBBHSTAT
            GOTO      ERTD1000 IF NOT EQUAL
.
            IF        EXDTBLNK=0
              MATCH     FRSTDATE,WBBHPDAT
              GOTO      ERTD1000 IF LESS
.
              MATCH     WBBHPDAT,LASTDATE
              GOTO      ERTD1000 IF LESS
            ENDIF
.
          ELSE
            MATCH     "2",WBBHSTAT
            GOTO      ERTD1000 IF EQUAL
.
            IF        EXDTBLNK=0
              MATCH     FRSTDATE,WBBHPDAT
              GOTO      ERTD1000 IF LESS
.
              MATCH     WBBHPDAT,LASTDATE
              GOTO      ERTD1000 IF LESS
            ENDIF
.
          ENDIF
.
          MOVE      SP70,DIM11
          MATCH     SP70,WBBHPDAT
          IF        !@EQUAL & !@EOS
            UNPACK    WBBHPDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DIM11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MOVE      "Unknown  ",DIM9
          MATCH     "0",WBBHSTAT
          IF        @EQUAL
            MOVE      "Received ",DIM9
          ENDIF
.
          MATCH     "1",WBBHSTAT
          IF        @EQUAL
            MOVE      "Partial  ",DIM9
          ENDIF
.
          MATCH     "2",WBBHSTAT
          IF        @EQUAL
            MOVE      "Released ",DIM9
          ENDIF
.
          MATCH     "3",WBBHSTAT
          IF        @EQUAL
            MOVE      "Processng ",DIM9
          ENDIF
.
          RJUSTIFY  WBBHDAMN
          UNPACK    WBBHDAMN,DIM7,DIM2
          PACK      DIM10,DIM7,DOT,DIM2
          MOVE      DIM10,FORM7P2C
.
          CALL      GCMS0000
.
          REP       " +",WBBHHOSP
          REP       " +",WBBHPYPN
          REP       " +",WBBHPRUN
          REP       " +",WBBHPDAT
          REP       " +",WBBHRKEY
.
          MOVE      ZERO,LOOPCNTR
.
          IF        IBCNMHOS=1
.
            MATCH     "+++",WBBHHOSP
            IF        @EQUAL | @EOS
              WRITE     HTMLFILE;"t.addRow(#"",DIM11,"#",";
            ELSE
        WRITE     HTMLFILE;"t.addRow(#"","<img src='../images/CommentIcon.gif'":
                         " class=ListIcon onclick=displayRemH('",WBBHPDAT,"','":
      WBBHPYPN,"','",WBBHPRUN,"','",WBBHRKEY,"','",WBBHHOSP,"','002');> ",DIM11,"#",";
            ENDIF
.
          ELSE
.
        WRITE     HTMLFILE;"t.addRow(#"","<img src='../images/CommentIcon.gif'":
                         " class=ListIcon onclick=displayRemH('",WBBHPDAT,"','":
      WBBHPYPN,"','",WBBHPRUN,"','",WBBHRKEY,"','",WBBHHOSP,"','002');> ",DIM11,"#",";
          ENDIF
.
          REP       "+ ",WBBHHOSP
          REP       "+ ",WBBHPYPN
          REP       "+ ",WBBHPRUN
          REP       "+ ",WBBHPDAT
          REP       "+ ",WBBHRKEY
.
          WRITE     HTMLFILE;"#"",WBBHPRUN,"#",":
                             "#"",DIM9,"#",";
.
          REP       " +",WBBHHOSP
          REP       " +",WBBHPYPN
          REP       " +",WBBHPRUN
          REP       " +",WBBHPDAT
          REP       " +",WBBHRKEY
          MOVE      WBBHPRUN,DIM30
          PACK      DIM30,DIM30,SP70
          MOVE      WBBHDAMN,DIM9
          REP       " +",DIM30
          REP       " +",DIM9
.
          MOVE      FORM7P2C,DIM10A
          MOVE      CLAMTOTL,DIM10B
          REP       " +",DIM10A
          REP       " +",DIM10B
.
          WRITE     HTMLFILE;"#"",FORM7P2C,"&nbsp;&nbsp;&nbsp;<img src='../images/AppointmentIcon.gif'":
                         " class=ListIcon onclick=displayRemH('",WBBHPDAT,"','":
              WBBHPYPN,"','",WBBHPRUN,"','",WBBHRKEY,"','",WBBHHOSP,"','003');>&nbsp;","#",";
.
          WRITE     HTMLFILE;"#"",CLAMTOTL,"#",";
.
          MATCH     "1",UNRELREM
          IF        @EQUAL
.
            IF        IBCNMHOS=1
.
              MATCH     "+++",WBBHHOSP
              IF        @EQUAL | @EOS
                WRITE     HTMLFILE;"#"",WBBHPRUN;
              ELSE
                MOVE      WBBHPRUN,DIM4
                REP       "+ ",DIM4
                WRITE     HTMLFILE;"#"",DIM4;
              ENDIF
.
            ELSE
              MOVE      WBBHPRUN,DIM4
              REP       "+ ",DIM4
              WRITE     HTMLFILE;"#"",DIM4;
              ENDIF
          ELSE
.
            IF        IBCNMHOS=1
.
              MATCH     "+++",WBBHHOSP
              IF        @EQUAL | @EOS
                WRITE     HTMLFILE;"#"",WBBHPRUN;
              ELSE
                MATCH     "3",WBBHSTAT
                IF        @EQUAL
                  WRITE     HTMLFILE;"#"",WBBHPRUN,"&nbsp;<input type=button value='Processing' class='orangebutton' disabled>";
                ELSE
                  MATCH     "1",UNRELINQ
                  IF        @EQUAL
                    MOVE      WBBHPRUN,DIM4
                    REP       "+ ",DIM4
                    WRITE     HTMLFILE;"#"",DIM4;
                  ELSE
                    MOVE      WBBHPRUN,DIM4
                    REP       "+ ",DIM4
                    WRITE     HTMLFILE;"#"",DIM4,"&nbsp;<input type=button value='Release' class='button' onclick=releaseRem('",WBBHPYPN,"','",WBBHPRUN,"','",WBBHPDAT,"','",WBBHRKEY,"','",WBBHHOSP,"','",DIM9,"',this,'",DIM10A,"','",DIM10B,"');>";
                  ENDIF
                ENDIF
              ENDIF
.
            ELSE
              MATCH     "3",WBBHSTAT
              IF        @EQUAL
                WRITE     HTMLFILE;"#"",WBBHPRUN,"&nbsp;<input type=button value='Processing' class='orangebutton' disabled>";
              ELSE
                MATCH     "1",UNRELINQ
                IF        @EQUAL
                  MOVE      WBBHPRUN,DIM4
                  REP       "+ ",DIM4
                  WRITE     HTMLFILE;"#"",DIM4;
                ELSE
                  MOVE      WBBHPRUN,DIM4
                  REP       "+ ",DIM4
                  WRITE     HTMLFILE;"#"",DIM4,"&nbsp;<input type=button value='Release' class='button' onclick=releaseRem('",WBBHPYPN,"','",WBBHPRUN,"','",WBBHPDAT,"','",WBBHRKEY,"','",WBBHHOSP,"','",DIM9,"',this,'",DIM10A,"','",DIM10B,"');>";
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"#",#"",WBBHPRUN;
          MOVE      WBBHPRUN,DIM30
          PACK      DIM30,DIM30,SP70
          REP       " +",DIM30
          REP       "+ ",WBBHPRUN
          WRITE     HTMLFILE;"#",#"","<img src='../images/CommentIcon.gif'":
                         " class=ListIcon onclick=displayRemH('",WBBHPDAT,"','":
      WBBHPYPN,"','",DIM30,"','",WBBHRKEY,"','",WBBHHOSP,"','002');> ",WBBHPRUN;
.
          REP       "+ ",WBBHHOSP
          REP       "+ ",DIM30
.
          WRITE     HTMLFILE;"#",#"",WBBHRKEY;
          WRITE     HTMLFILE;"#",#"",DIM11;
.
          MOVE      SP70,DIM50
          MATCH     SP70,WBBHHOSP
          IF        !@EQUAL & !@EOS
            PACK      KEY3,WBBHHOSP,SP70
            CALL      RDPTHSP1
            IF        OVRCD=0
              MOVE      PTHSNAME,DIM50
            ELSE
              MOVE      WBBHHOSP,DIM50
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"#",#"",DIM50;
.
          REP       "+ ",WBBHPYPN
          WRITE     HTMLFILE;"#",#"",WBBHPYPN;
.
          PACK      KEY20,WBBHPYPN,SP70
          CALL      RSPMHCP3
          CALL      RKPMHCP3
          BRANCH    OVRCD,ERTD8000
.
          PACK      DIM10,WBBHPYPN,SP70
          MATCH     DIM10,PMHCPRV1
          GOTO      ERTD8000 IF NOT EQUAL
.
          MOVE      PMHCTITL,FMTTITLE             * Got them - set up name flds
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000                      * Format name
.
          WRITE     HTMLFILE;"#",#"",DOCFNAME;
          GOTO      ERTD9000
.
ERTD8000  WRITE     HTMLFILE;"#",#"","Description Not Found";
          GOTO      ERTD9000
.
ERTD9000  WRITE     HTMLFILE;"#",#"","<img src='../images/CommentIcon.gif'":
                    "class=ListIcon onclick=displayJSON('",WBBHRKEY,"');>";
.
          WRITE     HTMLFILE;"#");"
.
          REP       "+ ",WBBHHOSP
          REP       "+ ",WBBHPYPN
          REP       "+ ",WBBHPRUN
          REP       "+ ",WBBHPDAT
          REP       "+ ",WBBHRKEY
.
          GOTO      ERTD1000
.
ERTD9999  RETURN
+
.---------------------------------------------------------------
. BBSW BPYW <tran id>.properties tag
.---------------------------------------------------------------
BPYHED00  MATCH     SP70,WBB2DPTH
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"WebServices B2B Device directory not found.";
            GOTO      BPYHED99
          ENDIF
.
          MATCH    SP70,WBETSTRD
          GOTO     BPYHED99 IF EQUAL
          GOTO     BPYHED99 IF EOS
.
          CLEAR     CMDLINE
          APPEND    WBB2DPTH,CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    "/webPAS_claims/bpyw/",CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    WBETSTRD,CMDLINE
          APPEND    PROPLITR,CMDLINE
          RESET     CMDLINE
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PROPFILE,CMDLINE
          TRAPCLR   IO
          IF        OVRCD=1
            WRITE     HTMLFILE;"Can't&nbsp;read: ",CMDLINE;
            GOTO      BPYHED99
          ENDIF
.
BPYHED10  READ      PROPFILE,SEQ;PROPLINE
          GOTO      BPYHED99 IF OVER
.
          WRITE     HTMLFILE;PROPLINE
.
          GOTO      BPYHED10
.
BPYHED99  CLOSE     PROPFILE
.
          RETURN
+
.---------------------------------------------------------------
. BBSW BPYW <tran id>_bpyw  tag
.---------------------------------------------------------------
BPYJSN00  MATCH     SP70,WBB2DPTH
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"WebServices B2B Device directory not found.";
            GOTO      BPYJSN99
          ENDIF
.
          MATCH    SP70,WBETSTRD
          GOTO     BPYJSN99 IF EQUAL
          GOTO     BPYJSN99 IF EOS
.
          CLEAR     CMDLINE
          APPEND    WBB2DPTH,CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    "/webPAS_claims/bpyw/",CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    WBETSTRD,CMDLINE
          APPEND    BPYWLITR,CMDLINE
          RESET     CMDLINE
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      BPYWFILE,CMDLINE
          TRAPCLR   IO
          IF        OVRCD=1
            WRITE     HTMLFILE;"Can't&nbsp;read: ",CMDLINE;
            GOTO      BPYJSN99
          ENDIF
.
BPYJSN10  READ      BPYWFILE,SEQ;BPYWLINE
          GOTO      BPYJSN99 IF OVER
.
          WRITE     HTMLFILE;BPYWLINE
.
          GOTO      BPYJSN10
.
BPYJSN99  CLOSE     BPYWFILE
.
          RETURN
+
.---------------------------------------------------------------
. BBSW BPYW <tran id>_bpyw_response  tag
.---------------------------------------------------------------
BPYRSP00  MATCH     SP70,WBB2DPTH
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"WebServices B2B Device directory not found.";
            GOTO      BPYRSP99
          ENDIF
.
          MATCH    SP70,WBETSTRD
          GOTO     BPYRSP99 IF EQUAL
          GOTO     BPYRSP99 IF EOS
.
          CLEAR     CMDLINE
          APPEND    WBB2DPTH,CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    "/webPAS_claims/bpyw/",CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    WBETSTRD,CMDLINE
          APPEND    BPYRLITR,CMDLINE
          RESET     CMDLINE
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      BPYRFILE,CMDLINE
          TRAPCLR   IO
          IF        OVRCD=1
            WRITE     HTMLFILE;"Can't&nbsp;read: ",CMDLINE;
            GOTO      BPYRSP99
          ENDIF
.
BPYRSP10  READ      BPYRFILE,SEQ;BPYRLINE
          GOTO      BPYRSP99 IF OVER
.
          WRITE     HTMLFILE;BPYRLINE
.
          GOTO      BPYRSP10
.
BPYRSP99  CLOSE     BPYRFILE
.
          RETURN
+
.---------------------------------------------------------------
. BBSW BPYW <tran id>_bpyw_errors  tag
.---------------------------------------------------------------
BPYERR00  MATCH     SP70,WBB2DPTH
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"WebServices B2B Device directory not found.";
            GOTO      BPYERR99
          ENDIF
.
          MATCH    SP70,WBETSTRD
          GOTO     BPYERR99 IF EQUAL
          GOTO     BPYERR99 IF EOS
.
          CLEAR     CMDLINE
          APPEND    WBB2DPTH,CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    "/webPAS_claims/bpyw/",CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    WBETSTRD,CMDLINE
          APPEND    BPYELITR,CMDLINE
          RESET     CMDLINE
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      BPYEFILE,CMDLINE
          TRAPCLR   IO
          IF        OVRCD=1
            WRITE     HTMLFILE;"Can't&nbsp;read: ",CMDLINE;
            GOTO      BPYERR99
          ENDIF
.
BPYERR10  READ      BPYEFILE,SEQ;BPYELINE
          GOTO      BPYERR99 IF OVER
.
          WRITE     HTMLFILE;BPYELINE
.
          GOTO      BPYERR10
.
BPYERR99  CLOSE     BPYEFILE
.
          RETURN
+
.------------------------------------------------------------
. Refresh Parent and Close Window (RPAY0000)
.------------------------------------------------------------
RPYCLS00  
.         CALL      OPENHTML
.         BRANCH    EXIT,RPYCLS99
          BRANCH    FHIRTYPE,RPYCLS10
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             "src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             "src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#">  ":
                             " if (self.name.match(/PopUpFrame/)) {":
                             " reloadParentFrame();}":
                             " else { ":
                             "  opener.history.go(0);":
                             "  self.close(); }":
                             "</script>"
          CALL      CLOSHTML     * End of Document
          GOTO      RPYCLS99
RPYCLS10  CALL      FHRSUC00  * Return FHIR Success
RPYCLS99  RETURN
+
.------------------------------------------------------------------------

.  Redirect Parent URL (RPAY0000)
.------------------------------------------------------------------------

RPYDIR00  
.          CALL      OPENHTML
.          BRANCH    EXIT,RPYDIR90
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             " alert(#"",WEBTITLE,"#");":
                             " location.href=#"",REDIRECT,"#";":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      RPYDIR99
.
.RPYDIR90  DISPLAY   "*** Fifo Not Found ***"
.
RPYDIR99  RETURN
+
.------------------------------------------------------------
. Output HTML Error File (RPAY0000)
.------------------------------------------------------------
RPYERR00  
.          CALL      OPENHTML
.          BRANCH    EXIT,RPYERR95
          BRANCH    FHIRTYPE,RPYERR10
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> ":
 "  var PopUpScreen = parent.document.getElementById('PopUpScreen');":
                    "  alert(#"",WEBTITLE,"#");":
                    "  if (window.name.substr(0,4)=='Hide') {":
                    "    self.close();} else {":
                    "  if (PopUpScreen) {":
                    "    PopUpScreen.style.display='none'; } else {":
                    "    history.go(-1); }":
                    "}":
                    "</script>",012
.
          CALL      CLOSHTML     * End of Document
          GOTO      RPYERR99
.
. FHIR Error Response.
.
RPYERR10  CALL      FHRERR00
          GOTO      RPYERR99
.
.RPYERR95  DISPLAY   "*** Fifo Not Found - ",FILNAM," ***"
.
RPYERR99  RETURN
+
.------------------------------------------------------------
. WebServices DVAW DVYW Payment Report Enquiries
.------------------------------------------------------------
ECRV0000  MATCH     "1",PTCNDVAW
          GOTO      ECRV9300 IF NOT EQUAL
.
          RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      ECRV5000 IF EQUAL
.
          MATCH     "R",UPDATETY
          GOTO      ECRV4000 IF EQUAL
.
          MATCH     "D",UPDATETY
          GOTO      ECRV3000 IF EQUAL
.
          MATCH     "L",UPDATETY
          GOTO      ECRV2000 IF EQUAL
.
          MATCH     "P",UPDATETY
          GOTO      ECRV1000 IF EQUAL
.
          GOTO      ECRV9000
.
ECRV1000  MOVE      "1",DIM1C
          CALL      PRNRMV00
          MOVE      "Print Payment Report scheduled.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ECRV9999
.
ECRV2000  CALL      RPAV0000
          GOTO      ECRV9999
.
ECRV3000  PACK      KEY53,HOSPCODE,ECREPYPN,ECREPRUN,ECREPDAT,ECRECLID:
                          ECRETRID,SP70
          CALL      RDWBDVI1
          BRANCH    OVRCD,ECRV9100
.
          GOTO      ECRV6000
.
ECRV4000  REP       "`##",ECRERKEY
.
          PACK      KEY47,HOSPCODE,ECREPYPN,ECREPRUN,ECREPDAT,ECRERKEY,SP70
          CALL      RDWBDVH1
          BRANCH    OVRCD,ECRV9100
.
          GOTO      ECRV6000
.
ECRV5000  MOVE      TEMPLATE,KEY3
          RJUSTIFY  KEY3
          REP       " 0",KEY3
.
          MATCH     "001",KEY3
          IF        @EQUAL
.
            CALL      CURPER00
            CALL      CALCDT00
.
            CLEAR     WEBTITLE
            MOVE      "Unreleased DVAW DVYW Payment Report Enquiry",WEBTITLE
            RESET     WEBTITLE
          ENDIF
.
          MATCH     "005",KEY3
          IF        @EQUAL
.
            CALL      CURPER00
            CALL      CALCDT00
.
            CLEAR     WEBTITLE
            MOVE      "Released DVAW DVYW Payment Report Enquiry",WEBTITLE
            RESET     WEBTITLE
          ENDIF
.
          MATCH     "007",KEY3
          IF        @EQUAL
.
            CALL      CURPER00
            CALL      CALCDT00
.
            CLEAR     WEBTITLE
            MOVE      "Unreleased DVAW DVYW Payment Report Enquiry Only",WEBTITLE
            RESET     WEBTITLE
          ENDIF
.
ECRV6000  CALL      WEBHED00
          BRANCH    EXIT,ECRV9999
.
          CALL      WEBBOD00
.
          CALL      WEBEND00
.
          MOVE      ONE,EXIT
          GOTO      ECRV9999
.
ECRV9000  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ECRV9999
.
ECRV9100  MOVE      "Can't find Payment details.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ECRV9999
.
ECRV9300  MOVE      "Not using DVAW Module.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ECRV9999
.
ECRV9999  RETURN
+
.--------------------------------------------------------------------------
.*                             PRNRMV00                                   *
.*               Schedule WebServices BBSW BPYW  Report (IBAWEB28)        *
.--------------------------------------------------------------------------
PRNRMV00  MOVE      "IBAWEB29",SCHDPGID
          MOVE      "WebServices DVAW DVYW Payment Report",SCHDDESC
          CALL      IBACLOCK
          PACK      SCHDDATE,CCC,CYY,CMM,CDD
          REP       " 0",SCHDDATE
          CLOCK     TIME,SCHDTIME
          MOVE      ONE,SCHDCOPY
          MOVE      "S  ",SCHDPRNT           * initialise to spool
          MATCH     SP70,SELPRINT
          IF        !@EQUAL
            MOVE      SELPRINT,SCHDPRNT      * printer code
          ENDIF
          MOVE      "IBAWEB29",SETDFPRG
          MOVE      "1",SETDFRPT
          CALL      SETDEF00                 * save default printer
.
.         Write Keyin parameters
.
          UNPACK    PAYMTKEY,KEY3,KEY8,KEY4,KEY8A,KEY24
          MOVE      KEY3,KEYSTARR[1]        * key for webdvwaf
          MOVE      KEY8,KEYSTARR[2]
          MOVE      KEY4,KEYSTARR[3]
          MOVE      KEY8A,KEYSTARR[4]
          MOVE      KEY24,KEYSTARR[5]
          MOVE      USERID,KEYSTARR[6]
          MOVE      DIM1C,KEYSTARR[7]
          MOVE      SEVEN,KEYSTCNT            * Number of Keyins
.
          CALL      SCHPRO00   * Schedule Extract
.
PRNRMV99  RETURN
+
.*****************************************************************************
.*                              RPAV0000                                     *
.*           Release all payments for the selected DVAW batch                *
.*****************************************************************************
.
.         Initialise counters
.         ERDCOUNT - is the total number of webbrdaf records associated
.                    with the selected DVAW batch.
.         PRLCOUNT - is the number of webdviaf records associated with the
.                    selected DVAW batch, which have previously been "released".
.         RELCOUNT - is the number of webdviaf records associated with the
.                    selected DVAW batch for which payments have been released
.                    in this session.
.
RPAV0000
.          CALL      CLER0000
.          MOVE      SP3,SAVEPART
.
          MOVE      ZERO,EXIT
          MOVE      ZERO,ERDCOUNT
          MOVE      ZERO,PRLCOUNT
          MOVE      ZERO,RELCOUNT
.
.         Start releasing payments for the ERA
.
RPAV0500
.          REP       "+ ",FUNDTRID
.          REP       "+ ",REMITADV
.          REP       "+ ",PARTNUMB
.
          REP       "+ ",HOSPCODE
          REP       "+ ",ECREPYPN
          REP       "+ ",ECREPRUN
          REP       "+ ",ECREPDAT
          REP       "+ ",ECRERKEY
.
          PACK      KEY47,HOSPCODE,ECREPYPN,ECREPRUN,ECREPDAT,ECRERKEY,SP70
          CALL      RDWBDVH1
          BRANCH    OVRCD,RPAV9960
.
          MATCH     "3",WBDHSTAT
          GOTO      RPAV9950 IF EQUAL
.
          MOVE      "3",WBDHSTAT
          CALL      UPWBDVH1
.
          MOVE      SP70,RECPTIND
.
          PACK      KEY53,WBDHRKEY,SP70
          CALL      RSWBDVI3
RPAV1000  CALL      RKWBDVI3
          BRANCH    OVRCD,RPAV9000
.
          MATCH     WBDHRKEY,WBDIRKEY
          GOTO      RPAV9000 IF NOT EQUAL
.
          RJUSTIFY  WBDICLBP
          UNPACK    WBDICLBP,DIM7,DIM2           * set amount paid
          PACK      DIM10,DIM7,DOT,DIM2
          MOVE      ZERO,FORM7P2C
.
          SCAN      "-",DIM10
          IF        @EQUAL
            REP        "-0",DIM10
            MOVE       ZERO,FORM7P2C
            MOVE       DIM10,FORM7P2C
            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
          ELSE
            MOVE       DIM10,FORM7P2C
          ENDIF
.
.         IF        FORM7P2C = 0 | FORM7P2C < 0
          IF        FORM7P2C = 0
            ADD       ONE,RELCOUNT
            MOVE      TWO,WBDISTAT                 * set as released
            CALL      UPWBDVI3
            GOTO      RPAV1000
          ENDIF
.
.         A payment for the DVAW has been found, so check if it needs releasing
.
          ADD       ONE,ERDCOUNT                 * increment webbrdaf count
          MATCH     "2",WBDISTAT                 * released  ?
          IF        @EQUAL
            ADD       ONE,PRLCOUNT               * yes - incr. prev. rel. count
            GOTO      RPAV1000                   * get next payment
          ENDIF
.
          MATCH     "3",WBDISTAT                 * released to suspense ?
          IF        @EQUAL
            ADD       ONE,PRLCOUNT               * yes - incr. prev. rel. count
            GOTO      RPAV1000                   * get next payment
          ENDIF
.
.         A claim requiring payment releasing has been found, so
.         get the corresponding webdvwaf record and check if same hospital
.
          MOVE      ZERO,ERASUSIN
          PACK      KEY40,WBDITRID,SP70
          CALL      RSWBDVW6                     * position on trans. id/invoice
          CALL      RKWBDVW6                     * read next record
.         BRANCH    OVRCD,RPAV6000               * eof
          IF        OVRCD=ONE
            CLEAR     SERDIM50
            APPEND    WBDITRID,SERDIM50
            APPEND    " - webdvwaf record not found",SERDIM50
            RESET     SERDIM50
            GOTO      RPAV6000
          ENDIF
.
          MATCH     WBDITRID,WBDWTRID            * same transaction id still ?
.         GOTO      RPAV6000 IF NOT EQUAL        * no
          IF        !@EQUAL
            CLEAR     SERDIM50
            APPEND    WBDITRID,SERDIM50
            APPEND    " - tran id not found",SERDIM50
            RESET     SERDIM50
            GOTO      RPAV6000
          ENDIF
.
          MOVE      SP70,SAVELOCN
.          IF        IBCNMHOS=1
.            MATCH     WBDHHOSP,WBDWHOSP
.            IF        !@EQUAL
.              PACK      KEY3,WBDWHOSP,SP70
.              CALL      RDPTHSP1
.              IF        OVRCD=0
.                MOVE      PTHSLOCN,SAVELOCN
.              ELSE
.                  SUB       ONE,ERDCOUNT
.                  GOTO      RPAV1000
.              ENDIF
..
.              PACK      KEY3,WBDHHOSP,SP70
.              CALL      RDPTHSP1
.              IF        OVRCD=0
.                MATCH     SAVELOCN,PTHSLOCN
.                IF        !@EQUAL
.                  SUB       ONE,ERDCOUNT
.                  GOTO      RPAV1000
.                ENDIF
.              ELSE
.                  SUB       ONE,ERDCOUNT
.                  GOTO      RPAV1000
.              ENDIF
.            ENDIF
.          ENDIF
.
          MATCH     "2",WBDWMODL
          IF        @EQUAL
.
            PACK      KEY8,WBDWINVN,SP70
            RJUSTIFY  KEY8
            CALL      RDPRIN1
            IF        OVRCD=ONE
              CLEAR     SERDIM50
              APPEND    WBDWINVN,SERDIM50
            APPEND    " - priinvof record not found",SERDIM50
            RESET     SERDIM50
            GOTO      RPAV6000
            ENDIF
.
            MATCH     "1",PRINCNST
            IF        @EQUAL
              CLEAR     SERDIM50
              APPEND    WBDWINVN,SERDIM50
              APPEND    "invoice is fully credited",SERDIM50
              RESET     SERDIM50
              GOTO      RPAV6000
            ENDIF
.
          ELSE
.
            PACK      KEY8,WBDWINVN,SP70
            RJUSTIFY  KEY8
            CALL      RDPTINV1
            IF        OVRCD=ONE
              CLEAR     SERDIM50
              APPEND    WBDWINVN,SERDIM50
              APPEND    " - patinvrf record not found",SERDIM50
              RESET     SERDIM50
              GOTO      RPAV6000
            ENDIF

.
            MATCH     "1",PTINCRST
.           GOTO      RPAY6000 IF EQUAL
            IF        @EQUAL
              CLEAR     SERDIM50
              APPEND    WBDWINVN,SERDIM50
              APPEND    "invoice is fully credited",SERDIM50
              RESET     SERDIM50
              GOTO      RPAV6000
            ENDIF
.
          ENDIF
.
.
.         Now lock all the relevant records prior to releasing the payment.
.         Check that we can lock the Health Fund receipts record.
.
RPAV1500
.         MOVE      "HFR",PRXCODE   * System Lock Audits
.         CALL      GETSLK00        * Get System Lock Audits
.
.         PACK      KEY8,PMECINVN,SP70
.         CALL      RDHFRE1                      * lock record found ?
.         IF        OVRCD = 1
.           MOVE      ONE,HFRSTAT                * no - write one with lock
.           MOVE      PMECINVN,HFRINVR
.           CALL      WRHFRE1
.         ELSE
.           COMPARE   ZERO,HFRSTAT               * yes - is it already locked ?
.           IF        @EQUAL
.             MOVE      ONE,HFRSTAT              * no - lock now
.             CALL      UPHFRE1
.           ELSE
.             CALL      RELSLK00                 * Release System Lock Audits
.             GOTO      RPAV8000                 * record already locked
.           ENDIF
.         ENDIF
.         CALL      RELSLK00        * Release System Lock Audits
.
.         Now check the we can lock the invoice record
.
.         MOVE      PMECINVN,KEY8
.         CALL      RLPTINV1
.         IF        OVRCD = 1
..           MOVE      THREE,UNLKFLAG
..           CALL      UNLK0000                   * unlock any locked records
..           GOTO      RPAV8000
.           GOTO      RPAV6100
.         ELSE
.           IF        OVRCD = 2
.             MOVE      THREE,UNLKFLAG
.             CALL      UNLK0000                 * unlock any locked records
.             GOTO      RPAV8000
.           ENDIF
.         ENDIF
.
.         Check that we can lock the visit record
.
.         PACK      KEY8,PMECADMN,SP70
.         CALL      RLPTVIS1
.         IF        OVRCD = 1
.           MOVE      TWO,UNLKFLAG
.           CALL      UNLK0000                   * unlock any locked records
.           GOTO      RPAV8000
.         ELSE
.           IF        OVRCD = 2
.             MOVE      TWO,UNLKFLAG
.             CALL      UNLK0000                 * unlock any locked records
.             GOTO      RPAV8000
.           ENDIF
.         ENDIF
.
.         All the relevant records have been locked.
.         As there may be payments in this remittance for more than one
.         participant, check if the participant code has changed.  If it
.         has, then we need to get a new receipt number.
.
.         MATCH     SAVEPART,PARTPANT            * same participant still ?
..          IF        !@EQUAL
.
            MATCH     "1",RECPTIND
            IF        !@EQUAL
              CALL      ALLCRC00
              MOVE      "1",RECPTIND
            ENDIF
..
.            MOVE      PARTPANT,SAVEPART          * save new participant code
.          ENDIF
.
.         Process the payment
.
          RJUSTIFY  WBDICLBP
          UNPACK    WBDICLBP,DIM7,DIM2           * set amount paid
          PACK      DIM10,DIM7,DOT,DIM2
          MOVE      ZERO,FORM7P2C
.
          SCAN      "-",DIM10
          IF        @EQUAL
            REP        "-0",DIM10
            MOVE       ZERO,FORM7P2C
            MOVE       DIM10,FORM7P2C
            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
          ELSE
            MOVE       DIM10,FORM7P2C
          ENDIF
.
.          MATCH     "HIC",PMEHNAME
.          IF        @EQUAL
.            MOVE      FORM7P2C,PRECAMMP
.            ASSIGN    (PRINMAMT-PRECAMMP),PRINMAMT
.          ELSE
.            MOVE      FORM7P2C,PRECAMFP
.            ASSIGN    (PRINHAMT-PRECAMFP),PRINHAMT
.          ENDIF
.
          MOVE      FORM7P2C,WBDWAMDP
.
          MATCH     "2",WBDWMODL
          IF        @EQUAL
.            ASSIGN    (PRINMAMT-WBDWAMMP),PRINMAMT
            ASSIGN    (PRINVAMT-WBDWAMDP),PRINVAMT
          ELSE
.            ASSIGN    (PINVOTHA-WBDWAMMP),PINVOTHA
            ASSIGN    (PINVOTHA-WBDWAMDP),PINVOTHA
          ENDIF
.
          CALL      IBACLOCK                     * get current date
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          MOVE      CTIMEIS,CURRTIME
.
..         Check if the invoice now balances
..
.          MOVE      PRINITOT,FORM10P2             * Invoice amount +
.          ADD       PRINPAMT,FORM10P2            * Patient payments +
.          ADD       PRINHAMT,FORM10P2            * H.F payments +
.          ADD       PRINOTHA,FORM10P2            * Other payments +
.          ADD       PRINJAMT,FORM10P2            * Journals +
.          ADD       PRINGSTJ,FORM10P2            * Journal GST = amt outstanding
..
..         MOVE      "99999999",PINVBLCD          * default to not balancing
..
..         COMPARE   ZERO,FORM10P2                * Does invoice balance ?
..         IF        @EQUAL
..           MOVE      CURRDATE,PINVBLCD          * yes - record balanced date
...          MOVE      TWO,PTDTAPAY               * set A/P flag - balanced
..         ELSE
...          MOVE      ZERO,PTDTAPAY              * set A/P flag - not balanced
..         ENDIF
.          MOVE      FORM10P2,PRINPEND
..         CALL      UPINV1                       * update/unlock invoice record
..
..         PROC      FLAGDEBT
..
..         Create the patdtraf cash receipt record.
..
.          MOVE      PRECUNIQ,PRDTUNIQ            * load unique number
..
..         Get the next transaction number.  As we have already locked
..         the visit record, there should be no problem getting the
..         next transaction number.
..
..RPAV3000  MOVE      PMECADMN,KEY8                * get next transaction number
..          CALL      TRVISA1
..
..          PACK      KEY22,PMECADMN,PMECINVN,PVITRAN
..          CALL      RDADTRN1                     * patdtraf record on file ?
..          COMPARE   ZERO,OVRCD
..          GOTO      RPAV3000 IF EQUAL            * yes
..
..          MOVE      PVITRAN,TTRANSN1             * load transaction number
..          MOVE      ANSH,TTYPEDEB                * set to "patient" type of debt
..          MOVE      PMECHFND,TDCODE
..
..          ASSIGN    (PMECAMTP*SEQ),TPATAMTT
..          MOVE      TPATAMTT,TREBATE
..
..          MOVE      ZERO,TPATAMTG                * set $ amounts
..          MOVE      ZERO,TPATAMTH
..          MOVE      ZERO,TPATAMTI
..          MOVE      ZERO,TPATAMTP
..
..          MOVE      CCC,TFCENT                   * set payment date
..          MOVE      CYY,TFYEAR
..          MOVE      CMM,TFMONTH
..          MOVE      CDD,TFDAY
..
..          MOVE      ZERO,TTCENT                  * initialise accomm. to dates
..          MOVE      ZERO,TTYEAR
..          MOVE      ZERO,TTMONTH
..          MOVE      ZERO,TTDAY
..
..          PACK      TTYPE,ANSP,ANSY              * set for payment
..          MOVE      SP9,TITEMNO
..          MOVE      PMECINVN,TREF                * load invoice no.
..          MOVE      SIX,TPAYTYPE                 * direct deposit
..
.          MOVE      HRECPT,PRDTRECN
..
..          IF        PMECEETP = 0
..            MOVE      "Unknown Health Fund           ",HFNAME
..            PACK      KEY14,PMECHFND,ZERO4,SP20
..            CALL      RDFUND1                    * HF on file ?
..            MOVE      HFNAME,TDDESC              * load HF description
..          ELSE
..            MOVE      "Unknown Claim Code  ",TDESC
..            PACK      KEY5,ANSC,ANSL,PINVCLM
..            CALL      RDCODE1
..            MOVE      TDESC,TDDESC               * load claim code description
..          ENDIF
..
..          MOVE      ONE,TINVPRT                  * invoice printed
..          MOVE      FIVE,TRECTYPE                * cash receipt
..          MOVE      ZERO,TNODAYS
..          MOVE      ZERO,TCLAIM
...         MOVE      ZERO,PTDTREBT
..          MOVE      SP6,TDOCTA
..          MOVE      ZERO,TSERVS
..          MOVE      SP6,TDOCTO
..          MOVE      SP2,TSESSION
..          MOVE      SP3,TMISGRP
..          MOVE      SP3,TDEPTYP
..          MOVE      SP3,TDWARD
..          MOVE      SP3,TCLMTYP
..          MOVE      SP3,TADMTYP
..          MOVE      PMECBATN,TBATCHN             * load batch number
..          MOVE      ZERO,TNINVS
..          MOVE      SP3,PTDTBTYP
..          MOVE      ZERO,PTDTLSPT
..          MOVE      ZERO,PTDTLSRB
..          MOVE      ZERO,PTDTDTYP
..          PACK      PTDTDES2,SP20,SP20
..          MOVE      ZERO,PTDTEPSD
..          MOVE      ZERO,PTDTCCU
...         MOVE      SP6,PTDTSURG
...         MOVE      SP1,PTDTDEPS
..
..          MOVE      CURRDATE,PTDTEFFD            * load payment date
..
..          MOVE      ZERO,PTDTGSTA
..          MOVE      SP6,PTDTGSTC
..          MOVE      ZERO,PTDTGSTM
..          MOVE      ZERO,PTDTADPT
..          MOVE      ZERO,PTDTADRB
..          MOVE      ZERO,PTDTGSTL
..          MOVE      SP70,PTDTTIME
..          MOVE      SP70,PTDTCRST
..          MOVE      SP70,PTDTUNIQ
..          MOVE      SP70,PTDTCNTR
..          MOVE      SP70,PTDTCPRC
..          MOVE      SP70,PTDTCONT
..          MOVE      SP70,PTDTSUNQ
..          MOVE      SP70,PTDTBTCH
...         MOVE      ANSN,PTDTSSAP
...         MOVE      ZERO,PTDTMVBR
..          MOVE      ZERO,PTDTEPSD
...         MOVE      SP1,PTDTMHDP
..          PACK      TSPARE,SP30,SP30
..
..          CALL      WRDTRN1                     * write patdtraf journal record
..
           ADD       ONE,RELCOUNT
.
. Write to rcpbnkaf
.
          PACK      KEY12,HRECPT,SP70
          CALL      RDRCBNK1
          IF        OVRCD=1
.
            MOVE      HRECPT,RCBNRECN
            CALL      IBACLOCK
            PACK      RCBNTDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBNTDAT
.
            RJUSTIFY  WBDICLBP
            UNPACK    WBDICLBP,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       ZERO,FORM7P2C
              MOVE       DIM10,FORM7P2C
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE
              MOVE       DIM10,FORM7P2C
            ENDIF
.
            MOVE      FORM7P2C,RCBNTOTP
            MOVE      RCCNERCD,RCBNCDRW
            MOVE      RCCNERCA,RCBNCHQA
            MOVE      WBDHHOSP,RCBNMHOS
.
            IF        IBCNMHOS=1
              MATCH     SP70,RCBNMHOS
              IF        !@EQUAL & !@EOS
                PACK      KEY3,RCBNMHOS,SP70
                CALL      RDPTHSP1
                IF        OVRCD=0
                  MATCH     SP70,PTHSERCD
                  IF        !@EQUAL & !@EOS
                    MOVE      PTHSERCD,RCBNCDRW
                  ENDIF
                  MATCH     SP70,PTHSERCA
                  IF        !@EQUAL & !@EOS
                    MOVE      PTHSERCA,RCBNCHQA
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
.
            MOVE      CHOSPNUM,RCBNMDHS
.
.           MATCH     "HIC",PMEHNAME
.           IF        @EQUAL
              MOVE      "3",RCBNTTYP
              MOVE      SP70,RCBNRCOD
.           ELSE
.             MOVE      "1",RCBNTTYP               * CAR 227986
.             MOVE      PRECHFND,RCBNRCOD
.           ENDIF
.
.           MOVE      PRECHFND,RCBNRCOD
            MOVE      ZERO,RCBNSTAT
            MOVE      SP70,RCBNBDAT
            MOVE      SP70,RCBNBTIM
            MOVE      SP70,RCBNRDAT
            MOVE      SP70,RCBNRTIM
            PACK      RCBNCDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBNCDAT
            CLOCK     TIME,RCBNCTIM
            MOVE      WBSEUID,RCBNCUID
            MOVE      SP70,RCBNUDAT
            MOVE      SP70,RCBNUTIM
            MOVE      SP70,RCBNUUID
            MOVE      SP70,RCBNSPAR
.
            PACK      KEY12,HRECPT,SP70
            CALL      WRRCBNK1
.
          ELSE
.
            RJUSTIFY  WBDICLBP
            UNPACK    WBDICLBP,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       DIM10,FORM7P2C
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE
              MOVE      DIM10,FORM7P2C
            ENDIF
.
            ADD       FORM7P2C,RCBNTOTP
            CALL      UPRCBNK1
.
          ENDIF
.
. Write to rcpbdtaf
.
          PACK      KEY15,HRECPT,SP1,SP1,ONE,SP70
          CALL      RDRCBDT1
          IF        OVRCD = 1
.
            CALL      IBACLOCK
            PACK      RCBDTDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBDTDAT
            MOVE      HRECPT,RCBDRECN
            MOVE      "  1",RCBDUNIQ
            MOVE      WBDHHOSP,RCBDMHOS
            MOVE      CHOSPNUM,RCBDMDHS
            MOVE      "4",RCBDPTYP
            CALL      DDEP0000            * Get payment code for Direct Deposit
.
            RJUSTIFY  WBDICLBP
            UNPACK    WBDICLBP,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       DIM10,FORM7P2C
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE
              MOVE      DIM10,FORM7P2C
            ENDIF
            MOVE      FORM7P2C,RCBDPAMT
.
.           MATCH     "HIC",PMEHNAME
.           IF        @EQUAL
              MOVE      "HIC",RCBDPAYD
.           ELSE
.             MOVE      PARTPANT,RCBDPAYD
.           ENDIF
.
            MOVE      SP70,RCBDCHQN
            MOVE      "MEDICARE",RCBDDRAW
            MOVE      WBDHACNM,RCBDBANK
            MOVE      WBDHBSBC,RCBDBRCH
            MOVE      SP70,RCBDCRDT
            MOVE      WBDHPRUN,RCBDSTRF
....        MOVE      SP70,RCBDMONM                                   *D-187485
            MOVE      SP70,RCBDEFTT
            CALL      IBACLOCK
            PACK      RCBDCDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBDCDAT
            CLOCK     TIME,RCBDCTIM
            MOVE      WBSEUID,RCBDCUID
            MOVE      SP70,RCBDUDAT
            MOVE      SP70,RCBDUTIM
            MOVE      SP70,RCBDUUID
            MOVE      SP70,RCBDSPAR
.
            PACK      KEY15,HRECPT,RCBDUNIQ,SP70
            CALL      WRRCBDT1
.
          ELSE
.
            RJUSTIFY  WBDICLBP
            UNPACK    WBDICLBP,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       DIM10,FORM7P2C
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE
              MOVE      DIM10,FORM7P2C
            ENDIF
.
            ADD       FORM7P2C,RCBDPAMT
            CALL      UPRCBDT1
.
          ENDIF
.
. Write to rcpdteaf
.
RPAV3500  PACK      KEY17,HRECPT,Z70
          CALL      RSRCDTE1
          CALL      RPRCDTE1
          IF        OVRCD = 1
            MOVE      "    1",RCDTTCNT
            CALL      WRRDV100
          ELSE
            MOVE      HRECPT,DIM12
            MATCH     DIM12,RCDTRECN
            IF        !@EQUAL
              MOVE      "    1",RCDTTCNT
              CALL      WRRDV100
            ELSE
              MOVE      RCDTTCNT,DIM5
              SQUEEZE   DIM5
              MOVE      ZERO,FORM5
              MOVE      DIM5,FORM5
              ADD       ONE,FORM5
              MOVE      FORM5,RCDTTCNT
.
              PACK      KEY17,HRECPT,RCDTTCNT,SP70
              CALL      RARCDTE1
              IF        OVRCD = 1
                CALL      WRRDV100
              ELSE
                GOTO      RPAV3500
              ENDIF
            ENDIF
          ENDIF
.
.         Now "close" the current claim (providing that a processing report
.         has been received) and update the payment amount and
.         the payment date
.
.          MOVE      PMEDARID,DIM20               * CAR 227986
.          SQUEEZE   DIM20
.
.          PACK      KEY57,OTESTRID,OTESCLID,Z70
.          CALL      RSOTEAH2                     * position on trans. id
.RPAV4000  CALL      RPOTEAH2                     * read previous record
.          BRANCH    OVRCD,RPAV4500               * eof - no proc. report
..
.          MATCH     OTESTRID,OTEHCTID            * same claim trans. id ?
.          GOTO      RPAV4500 IF NOT EQUAL        * no - no proc. report
..
.          MATCH     OTESCLID,OTEHCLID            * same claim id ?
.          GOTO      RPAV4500 IF NOT EQUAL        * no - no proc. report
.
.         A processing report was found
.
          RJUSTIFY  WBDICLBP
          UNPACK    WBDICLBP,DIM7,DIM2           * set amount paid
          PACK      DIM10,DIM7,DOT,DIM2
          MOVE      ZERO,FORM7P2C
.
          SCAN      "-",DIM10
          IF        @EQUAL
            REP        "-0",DIM10
            MOVE       ZERO,FORM7P2C
            MOVE       DIM10,FORM7P2C
            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
          ELSE
            MOVE       DIM10,FORM7P2C
          ENDIF
.
.......
.          MOVE      PMEDARID,DIM8
.          RJUSTIFY  DIM8
..
.          PACK      KEY22,DIM8,SP70
.          CALL      RSPRDT4
.          CALL      RKPRDT4
.          BRANCH    OVRCD,RPAV4100
..
.          MATCH     DIM8,PRDTINVN
.          GOTO      RPAV4100 IF NOT EQUAL
..
.          PACK      KEY27,DPRDTUNQ,PRDTPRAC,PRDTDOCT,PRDTCODE,SP70
.          CALL      RDPRHR1
.          BRANCH    OVRCD,RPAV4100
..
.          MATCH     SP70,PRHRTACC
.          GOTO      RPAV4100 IF EQUAL
..
.          MOVE      "ta",CATEGORY
.          MOVE      PRHRTACC,CODE
.          CALL      GETCOD00
..
.          MATCH     "1",TCINDC1
.          GOTO      RPAV4100 IF EQUAL
..
.          MATCH     "2",TCINDC1
.          GOTO      RPAV4100 IF EQUAL
..
.          MATCH     "7",TCINDC1
.          GOTO      RPAV4150 IF EQUAL
..
.          MATCH     "6",TCINDC1
.          IF        @EQUAL
.            MATCH     "HIC",PMEHNAME
.            IF        @EQUAL
.              MOVE      FORM7P2C,PRECAMMP
.              COMPARE   ZERO,PRECAMFP
.              GOTO      RPAV4300 IF EQUAL
.              GOTO      RPAV4200
.            ELSE
.              MOVE      FORM7P2C,PRECAMFP
.              COMPARE   ZERO,PRECAMMP
.              GOTO      RPAV4300 IF EQUAL
.              GOTO      RPAV4200
.            ENDIF
.          ENDIF
.......
.RPAV4100  MOVE      FORM7P2C,PRECAMFP
.          GOTO      RPAV4200
..
.RPAV4150  MOVE      FORM7P2C,PRECAMMP
.          GOTO      RPAV4200
..
          MOVE      FORM7P2C,WBDWAMDP
          COMPARE   ZERO,WBDWAMDP
          GOTO      RPAV4300 IF EQUAL
.
RPAV4200  MOVE      EIGHT,WBDWFLAG               * set status to closed
.
RPAV4300  PACK      WBDWSTAT,SP1,TWO             * set closed with payment
          MOVE      WBDIPDAT,WBDWPDAT            * set payment date
.
          GOTO      RPAV4600
.
.RPAV4500  UNPACK    OTESCLBP,DIM7,DIM2           * set amount paid
.          PACK      DIM10,DIM7,DOT,DIM2
.          MOVE      ZERO,FORM7P2C
..
.          SCAN      "-",DIM10
.          IF        @EQUAL
.            REP        "-0",DIM10
.            MOVE       ZERO,FORM7P2C
.            MOVE       DIM10,FORM7P2C
.            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
.          ELSE
.            MOVE       DIM10,FORM7P2C
.          ENDIF
......
.          MOVE      PMEDARID,DIM8
.          RJUSTIFY  DIM8
..
.          PACK      KEY22,DIM8,SP70
.          CALL      RSPRDT4
.          CALL      RKPRDT4
.          BRANCH    OVRCD,RPAV4550
..
.          MATCH     DIM8,PRDTINVN
.          GOTO      RPAV4550 IF NOT EQUAL
..
.          PACK      KEY27,DPRDTUNQ,PRDTPRAC,PRDTDOCT,PRDTCODE,SP70
.          CALL      RDPRHR1
.          BRANCH    OVRCD,RPAV4550
..
.          MATCH     SP70,PRHRTACC
.          GOTO      RPAV4550 IF EQUAL
..
.          MATCH     "1",TCINDC1
.          GOTO      RPAV4550 IF EQUAL
..
.          MATCH     "2",TCINDC1
.          GOTO      RPAV4550 IF EQUAL
..
.          MATCH     "7",TCINDC1
.          GOTO      RPAV4560 IF EQUAL
..
.          MATCH     "6",TCINDC1
.          IF        @EQUAL
.            MATCH     "HIC",PMEHNAME
.            IF        @EQUAL
.              MOVE      FORM7P2C,PRECAMMP
..             COMPARE   ZERO,PRECAMFP
..             GOTO      RPAV4600 IF EQUAL
.              GOTO      RPAV4570
.            ELSE
.              MOVE      FORM7P2C,PRECAMFP
..             COMPARE   ZERO,PRECAMMP
..             GOTO      RPAV4600 IF EQUAL
.              GOTO      RPAV4570
.            ENDIF
.          ENDIF
..
.RPAV4550  MOVE      FORM7P2C,PRECAMFP
.          GOTO      RPAV4570
..
.RPAV4560  MOVE      FORM7P2C,PRECAMMP
.          GOTO      RPAV4570
......
.RPAV4570  PACK      PRECSTAT,SP1,TWO             * set closed with payment
.          MOVE      PMEDLDAT,PRECPDAT            * set payment date
..
RPAV4600  CALL      UPWBDVW6                     * update claim
.
.         Finally, write an EDI History record (webdvaaf)
.
          MOVE      WBDWINVN,WBDAINVN
          CALL      IBACLOCK
          PACK      WBDADATE,CCC,CYY,CMM,CDD
          REP       " 0",WBDADATE
          MOVE      CTIMEIS,WBDATIME
          MOVE      WBDWBATN,WBDABATN
          MOVE      WBDWFLAG,WBDASTAT
          MOVE      " 3",WBDATYPE
          MOVE      WBSEUID,WBDAOPER
          MOVE      WBDWTRID,WBDATRID
          MOVE      SP70,WBDAEROR
.
          MOVE      "Released",WBDAEROT
          PACK      WBDAEROT,WBDAEROT,SP70
          MOVE      SP70,WBDASPAR
.
RPAV5000  PACK      KEY27,WBDAINVN,WBDADATE,WBDATIME,WBDATYPE,WBDAMODL,SP70
          CALL      RAWBDVA1
          IF        OVRCD = 1
            CALL      WRWBDVA1
          ELSE
            CALL      IBACLOCK
            PACK      WBDADATE,CCC,CYY,CMM,CDD
            REP       " 0",WBDADATE
            MOVE      CTIMEIS,WBDATIME
            GOTO      RPAV5000
          ENDIF
.
.         Update the payment table (webdviaf) to indicate that
.         the claim payment has been released to the relevant ibaPAS tables
.
          MOVE      TWO,WBDISTAT                 * set as released
          CALL      UPWBDVI3
.
.         MOVE      ONE,UNLKFLAG
.         CALL      UNLK0000                     * unlock all locked records
.
          MOVE      WBDAINVN,KEY8
          PROC      PRIUPURE              * Update Un-reconciled inv.file
.
          GOTO      RPAV1000
.
.*******************************************************************************
.         Now lock all the relevant records prior to releasing the payment.
.         Check that we can lock the Health Fund receipts record.
.
RPAV6000
.         MOVE      "HFR",PRXCODE   * System Lock Audits
.         CALL      GETSLK00        * Get System Lock Audits
.
.         MOVE      PMEDARID,DIM8
.         RJUSTIFY  DIM8
.
.         PACK      KEY8,DIM8,SP70
.         CALL      RDHFRE1                      * lock record found ?
.         IF        OVRCD = 1
.           MOVE      ONE,HFRSTAT                * no - write one with lock
.           MOVE      DIM8,HFRINVR
.           CALL      WRHFRE1
.         ELSE
.           COMPARE   ZERO,HFRSTAT               * yes - is it already locked ?
.           IF        @EQUAL
.             MOVE      ONE,HFRSTAT              * no - lock now
.             CALL      UPHFRE1
.           ELSE
.             CALL      RELSLK00                 * Release System Lock Audits
.             GOTO      RPAV8000                 * record already locked
.           ENDIF
.         ENDIF
.         CALL      RELSLK00        * Release System Lock Audits
.
.         All the relevant records have been locked.
.         As there may be payments in this remittance for more than one
.         participant, check if the participant code has changed.  If it
.         has, then we need to get a new receipt number.
.
RPAV6100
.          MATCH     SAVEPART,PARTPANT            * same participant still ?
.          IF        !@EQUAL
.
            MATCH     "1",RECPTIND
            IF        !@EQUAL
              CALL      ALLCRC00
              MOVE      "1",RECPTIND
            ENDIF
..
.            MOVE      PARTPANT,SAVEPART          * save new participant code
.          ENDIF
.
          MOVE      HRECPT,TRECEIPT
.
          ADD       ONE,RELCOUNT
.
.         MOVE      ONE,PMECEETP
.         MATCH     "DVA",PMEDPART
.         IF        !@EQUAL
.           MOVE      ZERO,PMECEETP
.         ENDIF
.
          RJUSTIFY  WBDICLBP
          UNPACK    WBDICLBP,DIM7,DIM2           * set amount paid
          PACK      DIM10,DIM7,DOT,DIM2
          MOVE      ZERO,FORM7P2C
.
          SCAN      "-",DIM10
          IF        @EQUAL
            REP        "-0",DIM10
            MOVE       ZERO,FORM7P2C
            MOVE       DIM10,FORM7P2C
            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
          ELSE
            MOVE       DIM10,FORM7P2C
          ENDIF
.
.          MATCH     "HIC",PMEHNAME
.          IF        @EQUAL
.            MOVE      FORM7P2C,PRECAMMP
.            ASSIGN    (PRINMAMT-PRECAMMP),PRINMAMT
.          ELSE
.            MOVE      FORM7P2C,PRECAMFP
.            ASSIGN    (PRINHAMT-PRECAMFP),PRINHAMT
.          ENDIF
.
           MOVE      FORM7P2C,WBDWAMDP
.
. Write to rcpbnkaf
.
          PACK      KEY12,HRECPT,SP70
          CALL      RDRCBNK1
          IF        OVRCD=1
.
            MOVE      HRECPT,RCBNRECN
            CALL      IBACLOCK
            PACK      RCBNTDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBNTDAT
.
            RJUSTIFY  WBDICLBP
            UNPACK    WBDICLBP,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       ZERO,FORM7P2C
              MOVE       DIM10,FORM7P2C
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE
              MOVE       DIM10,FORM7P2C
            ENDIF
.
            MOVE      FORM7P2C,RCBNTOTP
            MOVE      RCCNERCD,RCBNCDRW
            MOVE      RCCNERCA,RCBNCHQA
            MOVE      WBDHHOSP,RCBNMHOS
.
            IF        IBCNMHOS=1
              MATCH     SP70,RCBNMHOS
              IF        !@EQUAL & !@EOS
                PACK      KEY3,RCBNMHOS,SP70
                CALL      RDPTHSP1
                IF        OVRCD=0
                  MATCH     SP70,PTHSERCD
                  IF        !@EQUAL & !@EOS
                    MOVE      PTHSERCD,RCBNCDRW
                  ENDIF
                  MATCH     SP70,PTHSERCA
                  IF        !@EQUAL & !@EOS
                    MOVE      PTHSERCA,RCBNCHQA
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
.
            MOVE      CHOSPNUM,RCBNMDHS
            MOVE      "1",RCBNTTYP               * CAR 227986
.
.           MOVE      PMECHFND,RCBNRCOD
.
            MOVE      SP70,RCBNRCOD
.            MOVE      PMEDARID,DIM8
.            RJUSTIFY  DIM8
..
.            PACK      KEY22,DIM8,SP70
.            CALL      RSPRDT4
.            CALL      RKPRDT4
.            IF        OVRCD=0
.              MATCH     DIM8,PRDTINVN
.              IF        @EQUAL
.                PACK      KEY8,DPRDTUNQ,SP70
.                CALL      RDPRHD2
.                IF        OVRCD=0
.                  MOVE      PRHDHFND,RCBNRCOD
.                ENDIF
.              ENDIF
.            ENDIF
.
            MOVE      ZERO,RCBNSTAT
            MOVE      SP70,RCBNBDAT
            MOVE      SP70,RCBNBTIM
            MOVE      SP70,RCBNRDAT
            MOVE      SP70,RCBNRTIM
            PACK      RCBNCDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBNCDAT
            CLOCK     TIME,RCBNCTIM
            MOVE      WBSEUID,RCBNCUID
            MOVE      SP70,RCBNUDAT
            MOVE      SP70,RCBNUTIM
            MOVE      SP70,RCBNUUID
            MOVE      SP70,RCBNSPAR
.
            PACK      KEY12,HRECPT,SP70
            CALL      WRRCBNK1
.
          ELSE
.
            RJUSTIFY  WBDICLBP
            UNPACK    WBDICLBP,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       DIM10,FORM7P2C
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE
              MOVE      DIM10,FORM7P2C
            ENDIF
.
            ADD       FORM7P2C,RCBNTOTP
            CALL      UPRCBNK1
.
          ENDIF
.
. Write to rcpbdtaf
.
          PACK      KEY15,HRECPT,SP1,SP1,ONE,SP70
          CALL      RDRCBDT1
          IF        OVRCD = 1
.
            CALL      IBACLOCK
            PACK      RCBDTDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBDTDAT
            MOVE      HRECPT,RCBDRECN
            MOVE      "  1",RCBDUNIQ
            MOVE      WBDHHOSP,RCBDMHOS
            MOVE      CHOSPNUM,RCBDMDHS
            MOVE      "4",RCBDPTYP
            CALL      DDEP0000            * Get payment code for Direct Deposit
.
            RJUSTIFY  WBDICLBP
            UNPACK    WBDICLBP,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       DIM10,FORM7P2C
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE
              MOVE      DIM10,FORM7P2C
            ENDIF
            MOVE      FORM7P2C,RCBDPAMT
.
.            MATCH     "HIC",PMEHNAME
.            IF        @EQUAL
              MOVE      "HIC",RCBDPAYD
.            ELSE
.              MOVE      PARTPANT,RCBDPAYD
.            ENDIF
.
            MOVE      SP70,RCBDCHQN
            MOVE      SP70,RCBDDRAW
            MOVE      WBDHACNM,RCBDBANK
            MOVE      WBDHBSBC,RCBDBRCH
            MOVE      SP70,RCBDCRDT
            MOVE      WBDHPRUN,RCBDSTRF
....        MOVE      SP70,RCBDMONM                                   *D-187485
            MOVE      SP70,RCBDEFTT
            CALL      IBACLOCK
            PACK      RCBDCDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBDCDAT
            CLOCK     TIME,RCBDCTIM
            MOVE      WBSEUID,RCBDCUID
            MOVE      SP70,RCBDUDAT
            MOVE      SP70,RCBDUTIM
            MOVE      SP70,RCBDUUID
            MOVE      SP70,RCBDSPAR
.
            PACK      KEY15,HRECPT,RCBDUNIQ,SP70
            CALL      WRRCBDT1
.
          ELSE
.
            RJUSTIFY  WBDICLBP
            UNPACK    WBDICLBP,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       DIM10,FORM7P2C
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE
              MOVE      DIM10,FORM7P2C
            ENDIF
.
            ADD       FORM7P2C,RCBDPAMT
            CALL      UPRCBDT1
.
          ENDIF
.
. Write to rcpdteaf
.
RPAV6500  PACK      KEY17,HRECPT,Z70
          CALL      RSRCDTE1
          CALL      RPRCDTE1
          IF        OVRCD = 1
            MOVE      "    1",RCDTTCNT
            CALL      WRRDV200
          ELSE
            MOVE      HRECPT,DIM12
            MATCH     DIM12,RCDTRECN
            IF        !@EQUAL
              MOVE      "    1",RCDTTCNT
              CALL      WRRDV200
            ELSE
              MOVE      RCDTTCNT,DIM5
              SQUEEZE   DIM5
              MOVE      ZERO,FORM5
              MOVE      DIM5,FORM5
              ADD       ONE,FORM5
              MOVE      FORM5,RCDTTCNT
.
              PACK      KEY17,HRECPT,RCDTTCNT,SP70
              CALL      RARCDTE1
              IF        OVRCD = 1
                CALL      WRRDV200
              ELSE
                GOTO      RPAV6500
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      THREE,WBDISTAT          * set as released to suspense acc
          CALL      UPWBDVI3
.
.         MOVE      THREE,UNLKFLAG
.         CALL      UNLS0000
.
          GOTO      RPAV1000
.*******************************************************************************
.
.         A record was locked for this claim, so set the status to "locked"
.
RPAV8000  MOVE      ONE,WBDISTAT
          CALL      UPWBDVI3
          GOTO      RPAV1000
.
.         Check if all the payment records for the ERA were released and
.         update the ERA header status accordingly.
.
RPAV9000  IF        ERDCOUNT = (PRLCOUNT+RELCOUNT)
            MOVE      "2",WBDHSTAT               * set to "released"
          ELSE
            MOVE      "1",WBDHSTAT               * set to "partial"
          ENDIF
          CALL      UPWBDVH1
.
          IF        IBCNMHOS=1
            MATCH     "2",WBDHSTAT
            IF        @EQUAL
              CALL      CDERV200
            ENDIF
          ENDIF
.
.         Unlock general records.
.
          MATCH     "1",MULTLT01
          IF        @EQUAL
            MOVE      "2",DIM1C
            PACK      PAYMTKEY,WBDHHOSP,WBDHPYPN,WBDHPRUN,WBDHPDAT:
                               WBDHRKEY,SP70
            CALL      PRNRMV00
          ENDIF
.
          MATCH     "1",WBDHSTAT
          IF        @EQUAL
            MOVE      "Payment record partially released.",WEBTITLE
          ELSE
            MOVE      "Payment record released.",WEBTITLE
          ENDIF
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RPAV9999
.
RPAV9950  MOVE      "Payment Currently being processed.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RPAV9999
.
RPAV9960  MOVE      "Cannot find webdvhaf record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RPAV9999
.
RPAV9999  RETURN
+
.---------------------------------------------------------------------------
.         WRRDV100 - Write to rcpdteaf
.---------------------------------------------------------------------------
.
WRRDV100  CALL      IBACLOCK
          PACK      RCDTTDAT,CCC,CYY,CMM,CDD
          REP       " 0",RCDTTDAT
          MOVE      HRECPT,RCDTRECN
.         MOVE      "    1",RCDTTCNT
.
          PACK      RCDTINVN,WBDWINVN,SP70
          RJUSTIFY  RCDTINVN
          MOVE      WBDWUNIQ,RCDTVIST
          MOVE      WBDWURNO,RCDTURNO
          MOVE      WBDWURNO,KEY8
          CALL      RDMAST1
          IF        OVRCD = 0
            MOVE      PSNAME,PACSNAME
            MOVE      PGNAME,PACGNAME
            MOVE      PTITL,PACTITLE
            MOVE      TWO,PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,RCDTNAME
            MOVE      PADD1,RCDTADD1
            MOVE      PADD2,RCDTADD2
            MOVE      PSUBRB,RCDTADD3
            MOVE      PADD4,RCDTADD4
            MOVE      PPOST,RCDTPOST
          ELSE
            MOVE      SP70,RCDTNAME
            MOVE      SP70,RCDTADD1
            MOVE      SP70,RCDTADD2
            MOVE      SP70,RCDTADD3
            MOVE      SP70,RCDTADD4
            MOVE      SP70,RCDTPOST
          ENDIF
          MOVE      SP70,RCDTSFLG
          MOVE      WBDIPRUN,RCDTREFR
          MOVE      WBDWHOSP,RCDTMHOS
.
          MOVE      SP70,RCDTREGI
.
          MATCH     "2",WBDWMODL
          IF        @EQUAL
.
            MOVE      WBDWINVN,DIM8
            RJUSTIFY  DIM8
.
            PACK      KEY22,DIM8,SP70
            CALL      RSPRDT4
            CALL      RKPRDT4
            IF        OVRCD=0
              MATCH     DIM8,PRDTINVN
              IF        @EQUAL
                PACK      KEY27,PRDTUNIQ,PRDTPRAC,PRDTDOCT,PRDTCODE,Sp70
                CALL      RDPRHR1
                IF        OVRCD=0
                  MATCH     SP70,PRHRPRAC
                  IF        !@EQUAL
                    PACK      KEY6,PRHRPRAC,SP70
                    CALL      RDPRPR1
                    IF        OVRCD=0
                      MOVE      PRPRREGI,RCDTREGI
                      MATCH     SP70,PRPRREGI
                      IF        !@EQUAL
                        PACK      KEY3,PRPRREGI,SP70
                        CALL      RDREGA1
                        IF        OVRCD=0
                          MATCH     SP70,REGHOSP
                          IF        !@EQUAL
                            MOVE      REGHOSP,RCDTMHOS
                          ENDIF
                        ENDIF
                      ENDIF
                    ENDIF
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
.
          ELSE
.
            MOVE      RCCNERRE,RCDTREGI
            IF        IBCNMHOS=1
.
              MATCH     SP70,RCDTMHOS
              IF        !@EQUAL & !@EOS
                PACK      KEY3,RCDTMHOS,SP70
                CALL      RDPTHSP1
                IF        OVRCD=0
                  MATCH     SP70,PTHSERRE
                  IF        !@EQUAL & !@EOS
                    MOVE      PTHSERRE,RCDTREGI
                  ENDIF
                ENDIF
              ENDIF
.
              PACK      KEY8,WBDWUNIQ,SP70
              CALL      RDPMVX11
              IF        OVRCD=0
                MATCH     SP70,PMVXMHOS
                IF        !@EQUAL & !@EOS
                  PACK      KEY3,PMVXMHOS,SP70
                  CALL      RDPTHSP1
                  IF        OVRCD=0
                    MATCH     SP70,PTHSERRE
                    IF        !@EQUAL & !@EOS
                      MOVE      PTHSERRE,RCDTREGI
                      MOVE      PMVXMHOS,RCDTMHOS
                    ENDIF
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
.
          ENDIF
.
          MOVE      SP70,RCDTGSTC
          CALL      GTACCV00
.
          RJUSTIFY  WBDICLBP
          UNPACK    WBDICLBP,DIM7,DIM2
          PACK      DIM10,DIM7,FULLSTOP,DIM2
          MOVE      ZERO,FORM7P2C
.
          SCAN      "-",DIM10
          IF        @EQUAL
            REP        "-0",DIM10
            MOVE       DIM10,FORM7P2C
            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
          ELSE
            MOVE      DIM10,FORM7P2C
          ENDIF
          MOVE      FORM7P2C,RCDTAMNT
.
          MOVE      ZERO,RCDTDISC
          MOVE      CHOSPNUM,RCDTMDHS
          MOVE      SP70,RCDTGSTA
          MOVE      SP70,RCDTALLO
          CALL      IBACLOCK
.         PACK      RCDTRELD,CCC,CYY,CMM,CDD
.         REP       " 0",RCDTRELD
.         MOVE      CTIMEIS,RCDTRELT
          MOVE      SP70,RCDTRELD
          MOVE      SP70,RCDTRELT
          PACK      RCDTCDAT,CCC,CYY,CMM,CDD
          REP       " 0",RCDTCDAT
          MOVE      SP70,RCDTPRAC
          MOVE      CTIMEIS,RCDTCTIM
          MOVE      WBSEUID,RCDTCUID
          MOVE      SP70,RCDTUDAT
          MOVE      SP70,RCDTUTIM
          MOVE      SP70,RCDTUUID
          MOVE      SP70,RCDTDPTY
          MOVE      SP70,RCDTGLEX
          MOVE      WBDWBATN,RCDTBATN
          MOVE      SP70,RCDTSPAR
.
          PACK      KEY17,RCDTRECN,RCDTTCNT,SP70
          CALL      WRRCDTE1
.
WRRDV199  RETURN
+
.---------------------------------------------------------------------------
.         WRRDV200 - Write to rcpdteaf suspense account
.---------------------------------------------------------------------------
WRRDV200  CALL      IBACLOCK
          PACK      RCDTTDAT,CCC,CYY,CMM,CDD
          REP       " 0",RCDTTDAT
          MOVE      HRECPT,RCDTRECN
.         MOVE      "    1",RCDTTCNT
.         MOVE      PMEDARID,RCDTINVN
.         PACK      RCDTINVN,PMEDARID,SP70
.         RJUSTIFY  RCDTINVN
          MOVE      SP70,RCDTINVN
          MOVE      SP70,RCDTVIST
          MOVE      SP70,RCDTURNO
.         MOVE      PMECURNO,KEY8
.         CALL      RDMAST1
.         IF        OVRCD = 0
.           MOVE      PSNAME,PACSNAME
.           MOVE      PGNAME,PACGNAME
.           MOVE      PTITL,PACTITLE
.           MOVE      TWO,PACFRMT
.           CALL      PACNAME
.           MOVE      PACFNAME,RCDTNAME
.           MOVE      PADD1,RCDTADD1
.           MOVE      PADD2,RCDTADD2
.           MOVE      PSUBRB,RCDTADD3
.           MOVE      PADD4,RCDTADD4
.           MOVE      PPOST,RCDTPOST
.         ELSE
            REP       "#" ",SERDIM50
            MOVE      SERDIM50,RCDTNAME
            MOVE      SP70,RCDTADD1
            MOVE      SP70,RCDTADD2
            MOVE      SP70,RCDTADD3
            MOVE      SP70,RCDTADD4
            MOVE      SP70,RCDTPOST
.         ENDIF
          MOVE      SP70,RCDTSFLG
          MOVE      WBDHPRUN,RCDTREFR
          MOVE      WBDHHOSP,RCDTMHOS
.
          MOVE      RCCNERRS,RCDTREGI
.         IF        IBCNMHOS=1
.           MATCH     SP70,RCDTMHOS
.           IF        !@EQUAL & !@EOS
.             PACK      KEY3,RCDTMHOS,SP70
.             CALL      RDPTHSP1
.             IF        OVRCD=0
.               MATCH     SP70,PTHSERRE
.               IF        !@EQUAL & !@EOS
.                 MOVE      PTHSERRE,RCDTREGI
.               ENDIF
.             ENDIF
.           ENDIF
.         ENDIF
.
          MOVE      SP70,RCDTGSTC
          CALL      GTACCV00
.
          MOVE      SP70,DIM2
          MOVE      SP70,DIM7
          MOVE      SP70,DIM10
.
          RJUSTIFY  WBDICLBP
          UNPACK    WBDICLBP,DIM7,DIM2
          PACK      DIM10,DIM7,FULLSTOP,DIM2
          MOVE      ZERO,FORM7P2C
.
          SCAN      "-",DIM10
          IF        @EQUAL
            REP        "-0",DIM10
            MOVE       DIM10,FORM7P2C
            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
          ELSE
            MOVE      DIM10,FORM7P2C
          ENDIF
          MOVE      FORM7P2C,RCDTAMNT
.
          MOVE      ZERO,RCDTDISC
          MOVE      CHOSPNUM,RCDTMDHS
          MOVE      SP70,RCDTGSTA
          MOVE      "2",RCDTALLO
          CALL      IBACLOCK
.         PACK      RCDTRELD,CCC,CYY,CMM,CDD
.         REP       " 0",RCDTRELD
.         MOVE      CTIMEIS,RCDTRELT
          MOVE      SP70,RCDTRELD
          MOVE      SP70,RCDTRELT
          PACK      RCDTCDAT,CCC,CYY,CMM,CDD
          REP       " 0",RCDTCDAT
          MOVE      SP70,RCDTPRAC
          MOVE      CTIMEIS,RCDTCTIM
          MOVE      WBSEUID,RCDTCUID
          MOVE      SP70,RCDTUDAT
          MOVE      SP70,RCDTUTIM
          MOVE      SP70,RCDTUUID
          MOVE      SP70,RCDTDPTY
          MOVE      SP70,RCDTGLEX
          MOVE      SP70,RCDTBATN
          MOVE      SP70,RCDTSPAR
.
          PACK      KEY17,RCDTRECN,RCDTTCNT,SP70
          CALL      WRRCDTE1
.
WRRDV299  RETURN
+
.------------------------------------------------------------------------------
.  Get Income account and Control Account
.------------------------------------------------------------------------------
.
GTACCV00  PACK      KEY3,RCDTREGI,SP70
          CALL      RDREGA1
          BRANCH    OVRCD,GTACCV80
.         MOVE      REGHOSP,RCDTMHOS       * Hospital id
          MOVE      REGGST,RCDTGSTC        * GST Code
.
          COMPARE   FIVE,HSYS1
          GOTO      GTACCV20 IF EQUAL      * Using Integra Extended
          COMPARE   FOUR,HSYS1
          GOTO      GTACCV20 IF EQUAL      * Using Comma Delimeted
          COMPARE   TWO,HSYS1
          GOTO      GTACCV20 IF EQUAL      * Using Other FMS - get Acc.from Reg.
          COMPARE   THREE,HSYS1
          GOTO      GTACCV20 IF EQUAL      * Using Other FMS - for Integra
.
          MATCH     SP20,REGGENLD
          GOTO      GTACCV80 IF EQUAL
          GOTO      GTACCV80 IF EOS
.
          MOVE      REGGENLD,RCDTINCA
          MOVE      REGGENLD,INCMACCT
          CALL      GETC0000              * Get Control Account Details
          PACK      RCDTBNKA,FMLALEDG,FMCSBNK
          GOTO      GTACCV99
.
.         Get Credit and Bank Account from Register record
.
GTACCV20  MOVE      REGGENDB,RCDTINCA       * Debtors Control account as Crd.Acc
          MOVE      REGGENBK,RCDTBNKA       * Debit account
          GOTO      GTACCV99
.
GTACCV80  MOVE      SP70,RCDTINCA
          MOVE      WBDHACCN,RCDTBNKA
          GOTO      GTACCV99
.
GTACCV99 RETURN
+
.-------------------------------------------------------------------
.Check for duplicate remittance in multi hospital remittance release
.-------------------------------------------------------------------
CDERV200  PACK      SAVKEY47,WBDHHOSP,WBDHPYPN,WBDHPRUN,WBDHPDAT,WBDHRKEY,SP70
.
          PACK      KEY47,SP3,WBDHPYPN,WBDHPRUN,WBDHPDAT,WBDHRKEY,SP70
          CALL      RDWBDVH1
          BRANCH    OVRCD,CDERV290
.
          MOVE      "2",WBDHSTAT
.
          CALL      UPWBDVH1
.
CDERV290  MOVE      SAVKEY47,KEY47
          CALL      RDWBDVH1
.
CDERV299  RETURN
+
.------------------------------------------------------------
. WebServices DVAW DVYW Payment Report Enquiry tags
.------------------------------------------------------------
ERLV0000  BRANCH    FLDITMNO,ERLV0100,ERLV0200,ERLV0300,ERLV0400,ERLV0500:
                             ERLV0600,ERLV0700,ERLV0800,ERLV0900,ERLV1000:
                             ERLV1100,ERLV1200,ERLV1300,ERLV1400,ERLV1500:
                             ERLV1600,ERLV1700,ERLV1800,ERLV1900,ERLV2000:
                             ERLV2100,ERLV2200,ERLV2300,ERLV2400,ERLV2500:
                             ERLV2600,ERLV2700,ERLV2800,ERLV2900,ERLV3000:
                             ERLV3100,ERLV3200,ERLV3300,ERLV3400,ERLV3500:
                             ERLV3600,ERLV3700,ERLV3800,ERLV3900,ERLV4000
.
          GOTO      ERLV9999
.
ERLV0100  UNPACK    DIM127,D1,UNRELREM,DIM127
          UNPACK    DIM127,D1,UNRELINQ,DIM127
          UNPACK    DIM127,D1,ERASTATS,DIM127
.
          CALL      ERTV0000
          GOTO      ERLV9999
.
ERLV0200  CALL      ERDV0000
          GOTO      ERLV9999
.
ERLV0300  WRITE     HTMLFILE;WBDHPYPN;
          GOTO      ERLV9999
.
ERLV0400  WRITE     HTMLFILE;WBDHPRUN;
          GOTO      ERLV9999
.
ERLV0500  MATCH     SP70,WBDHPDAT
          GOTO      ERLV9999 IF EQUAL
          UNPACK    WBDHPDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      ERLV9999
.
ERLV0600  RJUSTIFY  WBDHDAMN
          UNPACK    WBDHDAMN,DIM7,DIM2
          PACK      DIM10,DIM7,FULLSTOP,DIM2
          MOVE      DIM10,FORM7P2C
          WRITE     HTMLFILE;FORM7P2C;
          GOTO      ERLV9999
.
ERLV0700  WRITE     HTMLFILE;WBDHBSBC;
          GOTO      ERLV9999
.
ERLV0800  WRITE     HTMLFILE;WBDHACCN;
          GOTO      ERLV9999
.
ERLV0900  WRITE     HTMLFILE;WBDHACNM;
          GOTO      ERLV9999
.
ERLV1000  MATCH     SP70,WBDILDAT
          GOTO      ERLV9999 IF EQUAL
          UNPACK    WBDILDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      ERLV9999
.
ERLV1100  RJUSTIFY  WBDICLBP
          UNPACK    WBDICLBP,DIM7,DIM2
          PACK      DIM10,DIM7,FULLSTOP,DIM2
          MOVE      DIM10,FORM7P2C
          WRITE     HTMLFILE;FORM7P2C;
          GOTO      ERLV9999
.
ERLV1200  RJUSTIFY  WBDICLCA
          UNPACK    WBDICLCA,DIM7,DIM2
          PACK      DIM10,DIM7,FULLSTOP,DIM2
          MOVE      DIM10,FORM7P2C
          WRITE     HTMLFILE;FORM7P2C;
          GOTO      ERLV9999
.
ERLV1300
.         UNPACK    OTERDAMN,DIM7,DIM2
.         PACK      DIM10,DIM7,FULLSTOP,DIM2
.         MOVE      DIM10,FORM7P2C
.         WRITE     HTMLFILE;FORM7P2C;
.         GOTO      ERLV9999
.
ERLV1400  WRITE     HTMLFILE;WBDITRID;
          GOTO      ERLV9999
.
ERLV1500  MATCH     "0",WBDHSTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Received";
            GOTO      ERLV9999
          ENDIF
.
          MATCH     "1",WBDHSTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Locked";
            GOTO      ERLV9999
          ENDIF
.
          MATCH     "2",WBDHSTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Released";
            GOTO      ERLV9999
          ENDIF
.
          MATCH     "3",WBDHSTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Released - Suspense Register";
            GOTO      ERLV9999
          ENDIF
.
          WRITE     HTMLFILE;"Unknown";
.
          GOTO      ERLV9999
.
ERLV1600  CALL      GCMV0000
          WRITE     HTMLFILE;CLAMTOTL;
          GOTO      ERLV9999
.
ERLV1700  CALL      GCMA0000
          WRITE     HTMLFILE;CLAMTOTL;
          GOTO      ERLV9999
.
ERLV1800
.         WRITE     HTMLFILE;PMEDRADV;
          GOTO      ERLV9999
.
ERLV1900
.         WRITE     HTMLFILE;PMEDPNUM;
          GOTO      ERLV9999
.
ERLV2000
.         WRITE     HTMLFILE;PMEDTRID;
          GOTO      ERLV9999
.
ERLV2100
.         WRITE     HTMLFILE;PMEDARID;
          GOTO      ERLV9999
.
ERLV2200
.         UNPACK    PMEDBAMT,DIM7,DIM2
.         PACK      DIM10,DIM7,FULLSTOP,DIM2
..        MOVE      DIM10,FORM7P2C
.         MOVE      ZERO,FORM7P2C
.         SCAN      "-",DIM10
.         IF        @EQUAL
.           REP        "-0",DIM10
.           MOVE       DIM10,FORM7P2C
.           ASSIGN     (FORM7P2C*SEQ),FORM7P2C
.         ELSE
.           MOVE      DIM10,FORM7P2C
.         ENDIF
.         WRITE     HTMLFILE;FORM7P2C;
          GOTO      ERLV9999
.
ERLV2300
.         WRITE     HTMLFILE;PMEDCCOD;
          GOTO      ERLV9999
.
ERLV2400
.         MATCH     SP70,PMEDLDAT
.         GOTO      ERLV9999 IF EQUAL
.         UNPACK    PMEDLDAT,CCENT,CYEAR,CMON,CDAY
.         MOVE      CMON,F2
.         LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.         WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      ERLV9999
.
ERLV2500
.         WRITE     HTMLFILE;PMEDPARI;
          GOTO      ERLV9999
.
ERLV2600
.         WRITE     HTMLFILE;PMEDPTID;
          GOTO      ERLV9999
.
ERLV2700
.         MATCH     "0",PMEDSTAT
.         IF        @EQUAL
.           WRITE     HTMLFILE;"Received";
.           GOTO      ERLV9999
.         ENDIF
.
.         MATCH     "1",PMEDSTAT
.         IF        @EQUAL
.           WRITE     HTMLFILE;"Locked";
.           GOTO      ERLV9999
.         ENDIF
.
.         MATCH     "2",PMEDSTAT
.         IF        @EQUAL
.           WRITE     HTMLFILE;"Released";
.           GOTO      ERLV9999
.         ENDIF
.
.         MATCH     "3",PMEDSTAT
.         IF        @EQUAL
.           WRITE     HTMLFILE;"Released - Suspense";
.           GOTO      ERLV9999
.         ENDIF
.
.          WRITE     HTMLFILE;"Unknown";
.
          GOTO      ERLV9999
.
ERLV2800
.         UNPACK    DIM127,D1,DIM1,DIM127
.         MOVE      ZERO,FORM1
.         MOVE      DIM1,FORM1
.         BRANCH    FORM1,ERLV2810
.
.         WRITE     HTMLFILE;PARTCODE;
          GOTO      ERLV9999
.
ERLV2810
.         PACK      KEY3,PARTCODE,SP70
.         CALL      RDPTPAR1
.         BRANCH    OVRCD,ERLV9999
.
.         WRITE     HTMLFILE;PTPRNAME;
.         GOTO      ERLV9999
.
ERLV2900  WRITE     HTMLFILE;HOSPCODE,ECREPYPN,ECREPRUN,ECREPDAT,ECRERKEY;
          GOTO      ERLV9999
.
ERLV3000  CALL      SELP0000
          GOTO      ERLV9999
.
ERLV3100  CALL      PRVR0000
          GOTO      ERLV9999
.
ERLV3200  CALL      NXTR0000
          GOTO      ERLV9999
.
ERLV3300  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      ERLV9999
.
ERLV3400  WRITE     HTMLFILE;EXDTBLNK;
          GOTO      ERLV9999
.
ERLV3500  CALL      HSPSEL00
          GOTO      ERLV9999
.
ERLV3600  WRITE     HTMLFILE;WBDHRKEY;
          GOTO      ERLV9999
.
ERLV3700  WRITE     HTMLFILE;WBDICLID;
          GOTO      ERLV9999
.
ERLV3800  WRITE     HTMLFILE;WBDIRKEY;
          GOTO      ERLV9999
.
ERLV3900  MATCH     "0",WBDISTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Received";
            GOTO      ERLV9999
          ENDIF
.
          MATCH     "1",WBDISTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Locked";
            GOTO      ERLV9999
          ENDIF
.
          MATCH     "2",WBDISTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Released";
            GOTO      ERLV9999
          ENDIF
.
          MATCH     "3",WBDISTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Released - Suspense Register";
            GOTO      ERLV9999
          ENDIF
.
          WRITE     HTMLFILE;"Unknown";
.
          GOTO      ERLV9999
.
ERLV4000  PACK      KEY20,WBDHPYPN,SP70
          CALL      RSPMHCP3
          CALL      RKPMHCP3
          BRANCH    OVRCD,ERLV4100
.
          PACK      DIM10,WBDHPYPN,SP70
          MATCH     DIM10,PMHCPRV1
          GOTO      ERLV4100 IF NOT EQUAL
.
          MOVE      PMHCTITL,FMTTITLE             * Got them - set up name flds
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000                      * Format name
.
          WRITE     HTMLFILE;DOCFNAME;
          GOTO      ERLV9999
.
ERLV4100  WRITE     HTMLFILE;WBDHPYPN;
          GOTO      ERLV9999
.
ERLV9999  RETURN
+
.------------------------------------------------------------
. Get claim amount for a specific transaction id
.------------------------------------------------------------
GCMA0000  MOVE      ZERO,CLAMTOTL
.
          MATCH     "1",PTCNDVAW
          GOTO      GCMA9999 IF NOT EQUAL
.
          PACK      KEY40,WBDITRID,SP30,SP10
          CALL      RSWBDVW6                     * position on trans. id
          CALL      RKWBDVW6                     * read next record
          BRANCH    OVRCD,GCMA9999                * eof - not found
.
          MATCH     WBDITRID,WBDWTRID            * same transaction id still ?
          GOTO      GCMA9999 IF NOT EQUAL        * no - not found
.
          MOVE      WBDWAMTC,CLAMTOTL            * update ERA claim total
.
GCMA9999  RETURN
+
.*****************************************************************************
.*                            GCMV0000                                       *
.*              Get the claimed amount total for the Payment Report          *
.* Requires:  Valid read on webbrhaf record (ERA Header)                     *
.* Returns:   CLAMTOTL - total claimed amount for the payment batch          *
.*****************************************************************************
.
GCMV0000  MOVE      ZERO,CLAMTOTL                * initialise total amount
.
          MATCH     "1",PTCNDVAW
          GOTO      GCMV9999 IF NOT EQUAL
.
.         Loop through outerdaf looking for payments from the selected report
.
          PACK      KEY77,WBDHRKEY,WBDHHOSP,WBDHPYPN,WBDHPRUN,WBDHPDAT,SP70
          CALL      RSWBDVI3                     * position in file
GCMV1000  CALL      RKWBDVI3                     * read next record
          BRANCH    OVRCD,GCMV9999               * end of file
.
          MATCH     WBDHRKEY,WBDIRKEY
          GOTO      GCMV9999 IF NOT EQUAL
.
          MATCH     WBDHHOSP,WBDIHOSP
          GOTO      GCMV9999 IF NOT EQUAL
.
          MATCH     WBDHPYPN,WBDIPYPN
          GOTO      GCMV9999 IF NOT EQUAL
.
          MATCH     WBDHPRUN,WBDIPRUN
          GOTO      GCMV9999 IF NOT EQUAL
.
          MATCH     WBDHPDAT,WBDIPDAT
          GOTO      GCMV9999 IF NOT EQUAL
.
.         A payment has been found, so now get the claimed amount
.         from webbbsaf
.
          PACK      KEY40,WBDITRID,SP30,SP10
          CALL      RSWBDVW6                     * position on trans. id
          CALL      RKWBDVW6                     * read next record
          BRANCH    OVRCD,GCMV1000               * eof - not found
.
          MATCH     WBDITRID,WBDWTRID            * same transaction id still ?
          GOTO      GCMV1000 IF NOT EQUAL        * no - not found
.
          ADD       WBDWAMTC,CLAMTOTL            * update ERA claim total
          GOTO      GCMV1000                     * get next payment
.
GCMV9999  RETURN
+
.------------------------------------------------------------
. WebServices DVAW DVYW Payment Details
.------------------------------------------------------------
ERDV0000  MATCH     "1",PTCNDVAW
          GOTO      ERDV9999 IF NOT EQUAL
.
          CALL      ERDVH000
.
          PACK      KEY77,WBDHRKEY,WBDHHOSP,WBDHPYPN,WBDHPRUN,WBDHPDAT,SP70
          CALL      RSWBDVI3
ERDV1000  CALL      RKWBDVI3
          BRANCH    OVRCD,ERDV9999
.
          MATCH     WBDHRKEY,WBDIRKEY
          GOTO      ERDV9999 IF NOT EQUAL
.
          MATCH     WBDHHOSP,WBDIHOSP
          GOTO      ERDV9999 IF NOT EQUAL
.
          MATCH     WBDHPYPN,WBDIPYPN
          GOTO      ERDV9999 IF NOT EQUAL
.
          MATCH     WBDHPRUN,WBDIPRUN
          GOTO      ERDV9999 IF NOT EQUAL
.
          MATCH     WBDHPDAT,WBDIPDAT
          GOTO      ERDV9999 IF NOT EQUAL
.
          MOVE      SP70,DIFCINDC
          IF        IBCNMHOS=1
            PACK      KEY40,WBDITRID,SP70
            CALL      RSWBDVW6
            CALL      RKWBDVW6
            BRANCH    OVRCD,ERDV5000
.
            MATCH     WBDICLID,WBDWTRID
            GOTO      ERDV5000 IF NOT EQUAL
.
            MATCH     SP70,WBDWHOSP
            IF        !@EQUAL & !@EOS
              MATCH     WBDWHOSP,WBSEHOSP
              IF        !@EQUAL
                PACK      KEY3,WBDWHOSP,SP70
                CALL      RDPTHSP1
                IF        OVRCD=0
                  MOVE      PTHSLOCN,SAVELOCN
                ELSE
                  MOVE      SP70,SAVELOCN
                ENDIF
.
                PACK      KEY3,WBSEHOSP,SP70
                CALL      RDPTHSP1
                IF        OVRCD=0
.
                  MATCH     SAVELOCN,PTHSLOCN
.                  GOTO      ERDV1000 IF NOT EQUAL
                  IF        @EQUAL
                    MOVE      "1",DIFCINDC
                  ENDIF
.
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
ERDV5000  CALL      ERDVR000
.
          GOTO      ERDV1000
.
ERDV9999  RETURN
+
.------------------------------------------------------------
. WebServices DVAW DVYW Payment Details (TABLE HEADING)
.------------------------------------------------------------
ERDVH000  WRITE     HTMLFILE;"<tr>":
                             "<td class=HeadingCell width=30%>":
                             "Claim Tran ID</td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell width=10%>":
                             "Benefit<br>Amount</td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell width=10%>":
                             "Claimed<br>Amount</td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell width=10%>":
                             "Batch<br>Number</td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell width=10%>":
                             "Status</td>":
                             "<td class=HeadingCell width=10%>":
                             "Claim ID</td>":
                             "<td class=HeadingCell width=15% align=center>":
                             "Lodgement<br>Date</td>":
.                            "<td class=HeadingCell width=15%>":
.                            "Transaction ID<br>&nbsp;</td>":
                             "</tr>"
.
ERDVH999  RETURN
+
.------------------------------------------------------------
. WebServices DVAW DVYW Payment Details (Detail Row)
.------------------------------------------------------------
ERDVR000  REP       " +",HOSPCODE
          REP       " +",WBDIPYPN
          REP       " +",WBDIPRUN
          REP       " +",WBDIPDAT
          REP       " +",WBDICLID
          REP       " +",WBDITRID
.
          WRITE     HTMLFILE;"<tr><td><img src='../images/CommentIcon.gif'":
                             " class=ListIcon onclick=displayRemD('":
  HOSPCODE,"','",WBDIPYPN,"','",WBDIPRUN,"','",WBDIPDAT,"','",WBDICLID,"','",WBDITRID,"','D');>&nbsp;";
.
          REP       "+ ",HOSPCODE
          REP       "+ ",WBDIPYPN
          REP       "+ ",WBDIPRUN
          REP       "+ ",WBDIPDAT
          REP       "+ ",WBDICLID
          REP       "+ ",WBDITRID
.
          MATCH     "1",DIFCINDC
          IF        @EQUAL
            WRITE     HTMLFILE;"<font color=red>";
          ENDIF
.
          WRITE     HTMLFILE;WBDITRID;
.
          CALL      CLWEBDVW
          PACK      KEY40,WBDITRID,SP70
          CALL      RSWBDVW6
          CALL      RKWBDVW6
          IF        OVRCD=0
.
            MATCH     WBDITRID,WBDWTRID
            IF        !@EQUAL
              CALL      CLWEBDVW
            ENDIF
.
          ENDIF
.
          WRITE     HTMLFILE;"&nbsp;",WBDWHOSP;
.
          MATCH     "1",DIFCINDC
          IF        @EQUAL
            WRITE     HTMLFILE;"</font>";
          ENDIF
.
          WRITE     HTMLFILE;"</td>";
.
          RJUSTIFY  WBDICLBP
          UNPACK    WBDICLBP,DIM7,DIM2
          PACK      DIM10,DIM7,DOT,DIM2
.         MOVE      DIM10,FORM7P2C
          MOVE      ZERO,FORM7P2C
          SCAN      "-",DIM10
          IF        @EQUAL
            REP        "-0",DIM10
            MOVE       DIM10,FORM7P2C
            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
          ELSE
            MOVE      DIM10,FORM7P2C
          ENDIF
.
          MATCH     "1",DIFCINDC
          IF        @EQUAL
            WRITE     HTMLFILE;"<td><font color=red>",FORM7P2C,"</font></td>";
          ELSE
            WRITE     HTMLFILE;"<td>",FORM7P2C,"</td>";
          ENDIF
.
          MOVE      ZERO,CLAMTOTL
          PACK      KEY40,WBDITRID,SP30,SP10
          CALL      RSWBDVW6                     * position on trans. id
          CALL      RKWBDVW6                     * read next record
          BRANCH    OVRCD,ERDVR100                * eof - not found
.
          MATCH     WBDITRID,WBDWTRID            * same transaction id still ?
          GOTO      ERDVR100 IF NOT EQUAL        * no - not found
.
          MOVE      WBDWAMTC,CLAMTOTL            * update ERA claim total
.
ERDVR100  MATCH     "1",DIFCINDC
          IF        @EQUAL
            WRITE     HTMLFILE;"<td><font color=red>",CLAMTOTL,"</font></td>";
.
            WRITE     HTMLFILE;"<td><font color=red>",WBDWBATN,"</font></td>";
          ELSE
            WRITE     HTMLFILE;"<td>",CLAMTOTL,"</td>";
.
            WRITE     HTMLFILE;"<td>",WBDWBATN,"</td>";
          ENDIF
.
          MOVE      "Unknown  ",DIM9
          MATCH     "0",WBDISTAT
          IF        @EQUAL
            MOVE      "Received ",DIM9
          ENDIF
.
          MATCH     "1",WBDISTAT
          IF        @EQUAL
            MOVE      "Locked   ",DIM9
          ENDIF
.
          MATCH     "2",WBDISTAT
          IF        @EQUAL
            MOVE      "Released",DIM9
          ENDIF
.
          MATCH     "3",WBDISTAT
          IF        @EQUAL
            MOVE      "Released*",DIM9
          ENDIF
.
          MATCH     "1",DIFCINDC
          IF        @EQUAL
            WRITE     HTMLFILE;"<td><font color=red>",DIM9,"</font></td>";
.
            WRITE     HTMLFILE;"<td><font color=red>",WBDICLID,"</font></td>";
          ELSE
            WRITE     HTMLFILE;"<td>",DIM9,"</td>";
.
            WRITE     HTMLFILE;"<td>",WBDICLID,"</td>";
          ENDIF
.
          MOVE      SP70,DIM11
          MATCH     SP70,WBDIPDAT
          IF        !@EQUAL & !@EOS
            UNPACK    WBDIPDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DIM11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MATCH     "1",DIFCINDC
          IF        @EQUAL
            WRITE     HTMLFILE;"<td><font color=red>",DIM11,"</font></td>";
.
.           WRITE     HTMLFILE;"<td><font color=red>",WBDITRID,"</font></td>";
          ELSE
            WRITE     HTMLFILE;"<td>",DIM11,"</td>";
.
.           WRITE     HTMLFILE;"<td>",WBDITRID,"</td>";
          ENDIF
.
          WRITE     HTMLFILE;"</tr>";
.
ERDVR999  RETURN
+
.***************************************************************************
.*                             ERTV0000                                    *
.*   Set the hospital filter and call ERTI0000                             *
.*   If multi hospital call ERTI0000 for each of the users hositals        *
.***************************************************************************
ERTV0000  IF        IBCNMHOS<>1
            MOVE      SP70,FILTHOSP         * Not multi hospital so blank
            CALL      ERTI0000
            GOTO      ERTV9999
          ENDIF
.
.   Multi Hospital
.
          MATCH     SP70,FILTHOSP           * User has selected a hospital
          IF        !@EQUAL
            CALL      ERTI0000
            GOTO      ERTV9999
          ENDIF
.
          PACK      KEY3,SP70               * Show all users available
          CALL      RSPTHSP1                * hospitals
ERTV5000  CALL      RKPTHSP1
          BRANCH    OVRCD,ERTV9000
.
          PACK      KEY13,USERID,SP70                * All hospital access
          CALL      RDMLSEC1
          IF        OVRCD=1
            PACK      KEY13,USERID,PTHSHOSP,SP70     * This hospital access
            CALL      RDMLSEC1
            BRANCH    OVRCD,ERTV5000
          ENDIF
.
          MOVE      PTHSHOSP,FILTHOSP
          CALL      ERTI0000
.
          PACK      KEY3,FILTHOSP,SP70               * reposition
          CALL      RSPTHSP1
          GOTO      ERTV5000
.
ERTV9000  MOVE      SP70,FILTHOSP           * Restore all hospitals filter
.
ERTV9999  RETURN
+
.***************************************************************************
.*                             ERTI0000                                    *
.*   Display all the remittance batches received from a given participant  *
.***************************************************************************
ERTI0000  MATCH     "1",PTCNDVAW
          GOTO      ERTI9999 IF NOT EQUAL
.
          MOVE      ZERO,LOOPCNTR
.
          PACK      KEY48,FILTHOSP,ERASTATS,Z70
          CALL      RSWBDVH3
ERTI1000  CALL      RPWBDVH3
          BRANCH    OVRCD,ERTI9999               * end of file
.
          MATCH     FILTHOSP,WBDHHOSP
          GOTO      ERTI9999 IF NOT EQUAL
.
          MATCH     ERASTATS,WBDHSTAT
          GOTO      ERTI9999 IF NOT EQUAL
.
.------------------------------------------------------
. Loop counter to prevent timeout internal server error
.
           ADD       ONE,LOOPCNTR
.
           IF        (LOOPCNTR = 500)
             WRITE     HTMLFILE;"// ",LOOPCNTR
             MOVE      ZERO,LOOPCNTR
           ENDIF
.
. -----------------------------------------------------
.
          PACK      KEY77,WBDHRKEY,WBDHHOSP,WBDHPYPN,WBDHPRUN,WBDHPDAT,SP70
          CALL      RSWBDVI3
          CALL      RKWBDVI3
          BRANCH    OVRCD,ERTI1000
.
          MATCH     WBDHRKEY,WBDIRKEY
          GOTO      ERTI1000 IF NOT EQUAL
.
          MATCH     WBDHHOSP,WBDIHOSP
          GOTO      ERTI1000 IF NOT EQUAL
.
          MATCH     WBDHPYPN,WBDIPYPN
          GOTO      ERTI1000 IF NOT EQUAL
.
          MATCH     WBDHPRUN,WBDIPRUN
          GOTO      ERTI1000 IF NOT EQUAL
.
          MATCH     WBDHPDAT,WBDIPDAT
          GOTO      ERTI1000 IF NOT EQUAL
.
.         A payment for the report has been found, so now if it belongs
.         to outectaf
.
          PACK      KEY40,WBDITRID,SP30,SP10
          CALL      RSWBDVW6
          CALL      RKWBDVW6
          BRANCH    OVRCD,ERTI1000
.
          MATCH     WBDITRID,WBDWTRID            * if its not in outectaf
          GOTO      ERTI1000 IF NOT EQUAL        * then its probably a dbs
.                                                * claim
.
.
          MATCH     "1",UNRELREM
          IF        @EQUAL
            MATCH     "2",WBDHSTAT
            GOTO      ERTI1000 IF NOT EQUAL
.
            IF        EXDTBLNK=0
              MATCH     FRSTDATE,WBDHPDAT
              GOTO      ERTI1000 IF LESS
.
              MATCH     WBDHPDAT,LASTDATE
              GOTO      ERTI1000 IF LESS
            ENDIF
.
          ELSE
            MATCH     "2",WBDHSTAT
            GOTO      ERTI1000 IF EQUAL
.
            IF        EXDTBLNK=0
              MATCH     FRSTDATE,WBDHPDAT
              GOTO      ERTI1000 IF LESS
.
              MATCH     WBDHPDAT,LASTDATE
              GOTO      ERTI1000 IF LESS
            ENDIF
.
          ENDIF
.
          MOVE      SP70,DIM11
          MATCH     SP70,WBDHPDAT
          IF        !@EQUAL & !@EOS
            UNPACK    WBDHPDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DIM11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MOVE      "Unknown  ",DIM9
          MATCH     "0",WBDHSTAT
          IF        @EQUAL
            MOVE      "Received ",DIM9
          ENDIF
.
          MATCH     "1",WBDHSTAT
          IF        @EQUAL
            MOVE      "Partial  ",DIM9
          ENDIF
.
          MATCH     "2",WBDHSTAT
          IF        @EQUAL
            MOVE      "Released ",DIM9
          ENDIF
.
          MATCH     "3",WBDHSTAT
          IF        @EQUAL
            MOVE      "Processng ",DIM9
          ENDIF
.
          RJUSTIFY  WBDHDAMN
          UNPACK    WBDHDAMN,DIM7,DIM2
          PACK      DIM10,DIM7,DOT,DIM2
          MOVE      DIM10,FORM7P2C
.
          CALL      GCMV0000
.
          REP       " +",WBDHHOSP
          REP       " +",WBDHPYPN
          REP       " +",WBDHPRUN
          REP       " +",WBDHPDAT
          REP       " +",WBDHRKEY
.
          MOVE      ZERO,LOOPCNTR
.
          IF        IBCNMHOS=1
.
            MATCH     "+++",WBDHHOSP
            IF        @EQUAL | @EOS
              WRITE     HTMLFILE;"t.addRow(#"",DIM11,"#",";
            ELSE
        WRITE     HTMLFILE;"t.addRow(#"","<img src='../images/CommentIcon.gif'":
                         " class=ListIcon onclick=displayRemH('",WBDHPDAT,"','":
      WBDHPYPN,"','",WBDHPRUN,"','",WBDHRKEY,"','",WBDHHOSP,"','002');> ",DIM11,"#",";
            ENDIF
.
          ELSE
.
        WRITE     HTMLFILE;"t.addRow(#"","<img src='../images/CommentIcon.gif'":
                         " class=ListIcon onclick=displayRemH('",WBDHPDAT,"','":
      WBDHPYPN,"','",WBDHPRUN,"','",WBDHRKEY,"','",WBDHHOSP,"','002');> ",DIM11,"#",";
          ENDIF
.
          REP       "+ ",WBDHHOSP
          REP       "+ ",WBDHPYPN
          REP       "+ ",WBDHPRUN
          REP       "+ ",WBDHPDAT
          REP       "+ ",WBDHRKEY
.
          WRITE     HTMLFILE;"#"",WBDHPRUN,"#",":
                             "#"",DIM9,"#",";
.
          REP       " +",WBDHHOSP
          REP       " +",WBDHPYPN
          REP       " +",WBDHPRUN
          REP       " +",WBDHPDAT
          REP       " +",WBDHRKEY
          MOVE      WBDHPRUN,DIM30
          PACK      DIM30,DIM30,SP70
          MOVE      WBDHDAMN,DIM9
          REP       " +",DIM30
          REP       " +",DIM9
.
          MOVE      FORM7P2C,DIM10A
          MOVE      CLAMTOTL,DIM10B
          REP       " +",DIM10A
          REP       " +",DIM10B
.
          WRITE     HTMLFILE;"#"",FORM7P2C,"&nbsp;&nbsp;&nbsp;<img src='../images/AppointmentIcon.gif'":
                         " class=ListIcon onclick=displayRemH('",WBDHPDAT,"','":
              WBDHPYPN,"','",WBDHPRUN,"','",WBDHRKEY,"','",WBDHHOSP,"','003');>&nbsp;","#",";
.
          WRITE     HTMLFILE;"#"",CLAMTOTL,"#",";
.
          MATCH     "1",UNRELREM
          IF        @EQUAL
.
            IF        IBCNMHOS=1
.
              MATCH     "+++",WBDHHOSP
              IF        @EQUAL | @EOS
                WRITE     HTMLFILE;"#"",WBDHPRUN;
              ELSE
                MOVE      WBDHPRUN,DIM4
                REP       "+ ",DIM4
                WRITE     HTMLFILE;"#"",DIM4;
              ENDIF
.
            ELSE
              MOVE      WBDHPRUN,DIM4
              REP       "+ ",DIM4
              WRITE     HTMLFILE;"#"",DIM4;
              ENDIF
          ELSE
.
            IF        IBCNMHOS=1
.
              MATCH     "+++",WBDHHOSP
              IF        @EQUAL | @EOS
                WRITE     HTMLFILE;"#"",WBDHPRUN;
              ELSE
                MATCH     "3",WBDHSTAT
                IF        @EQUAL
                  WRITE     HTMLFILE;"#"",WBDHPRUN,"&nbsp;<input type=button value='Processing' class='orangebutton' disabled>";
                ELSE
                  MATCH     "1",UNRELINQ
                  IF        @EQUAL
                    MOVE      WBDHPRUN,DIM4
                    REP       "+ ",DIM4
                    WRITE     HTMLFILE;"#"",DIM4;
                  ELSE
                    MOVE      WBDHPRUN,DIM4
                    REP       "+ ",DIM4
                    WRITE     HTMLFILE;"#"",DIM4,"&nbsp;<input type=button value='Release' class='button' onclick=releaseRem('",WBDHPYPN,"','",WBDHPRUN,"','",WBDHPDAT,"','",WBDHRKEY,"','",WBDHHOSP,"','",DIM9,"',this,'",DIM10A,"','",DIM10B,"');>";
                  ENDIF
                ENDIF
              ENDIF
.
            ELSE
              MATCH     "3",WBDHSTAT
              IF        @EQUAL
                WRITE     HTMLFILE;"#"",WBDHPRUN,"&nbsp;<input type=button value='Processing' class='orangebutton' disabled>";
              ELSE
                MATCH     "1",UNRELINQ
                IF        @EQUAL
                  MOVE      WBDHPRUN,DIM4
                  REP       "+ ",DIM4
                  WRITE     HTMLFILE;"#"",DIM4;
                ELSE
                  MOVE      WBDHPRUN,DIM4
                  REP       "+ ",DIM4
                  WRITE     HTMLFILE;"#"",DIM4,"&nbsp;<input type=button value='Release' class='button' onclick=releaseRem('",WBDHPYPN,"','",WBDHPRUN,"','",WBDHPDAT,"','",WBDHRKEY,"','",WBDHHOSP,"','",DIM9,"',this,'",DIM10A,"','",DIM10B,"');>";
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"#",#"",WBDHPRUN;
          MOVE      WBDHPRUN,DIM30
          PACK      DIM30,DIM30,SP70
          REP       " +",DIM30
          REP       "+ ",WBDHPRUN
          WRITE     HTMLFILE;"#",#"","<img src='../images/CommentIcon.gif'":
                         " class=ListIcon onclick=displayRemH('",WBDHPDAT,"','":
      WBDHPYPN,"','",DIM30,"','",WBDHRKEY,"','",WBDHHOSP,"','002');> ",WBDHPRUN;
.
          REP       "+ ",WBDHHOSP
          REP       "+ ",DIM30
.
          WRITE     HTMLFILE;"#",#"",WBDHRKEY;
          WRITE     HTMLFILE;"#",#"",DIM11;
.
          MOVE      SP70,DIM50
          MATCH     SP70,WBDHHOSP
          IF        !@EQUAL & !@EOS
            PACK      KEY3,WBDHHOSP,SP70
            CALL      RDPTHSP1
            IF        OVRCD=0
              MOVE      PTHSNAME,DIM50
            ELSE
              MOVE      WBDHHOSP,DIM50
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"#",#"",DIM50;
.
          REP       "+ ",WBDHPYPN
          WRITE     HTMLFILE;"#",#"",WBDHPYPN;
.
          PACK      KEY20,WBDHPYPN,SP70
          CALL      RSPMHCP3
          CALL      RKPMHCP3
          BRANCH    OVRCD,ERTI8000
.
          PACK      DIM10,WBDHPYPN,SP70
          MATCH     DIM10,PMHCPRV1
          GOTO      ERTI8000 IF NOT EQUAL
.
          MOVE      PMHCTITL,FMTTITLE             * Got them - set up name flds
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000                      * Format name
.
          WRITE     HTMLFILE;"#",#"",DOCFNAME;
          GOTO      ERTI9000
.
ERTI8000  WRITE     HTMLFILE;"#",#"","Description Not Found";
          GOTO      ERTI9000
.
ERTI9000  WRITE     HTMLFILE;"#",#"","<img src='../images/CommentIcon.gif'":
                    "class=ListIcon onclick=displayJSON('",WBDHRKEY,"');>";
.
          WRITE     HTMLFILE;"#");"
.
          REP       "+ ",WBDHHOSP
          REP       "+ ",WBDHPYPN
          REP       "+ ",WBDHPRUN
          REP       "+ ",WBDHPDAT
          REP       "+ ",WBDHRKEY
.
          GOTO      ERTI1000
.
ERTI9999  RETURN
+
.---------------------------------------------------------------
. DVAW DVYW <tran id>.properties tag
.---------------------------------------------------------------
DVYHED00  MATCH     SP70,WBB2DPTH
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"WebServices B2B Device directory not found.";
            GOTO      DVYHED99
          ENDIF
.
          MATCH    SP70,WBETSTRD
          GOTO     DVYHED99 IF EQUAL
          GOTO     DVYHED99 IF EOS
.
          CLEAR     CMDLINE
          APPEND    WBB2DPTH,CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    "/webPAS_claims/dvyw/",CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    WBETSTRD,CMDLINE
          APPEND    PROPLITR,CMDLINE
          RESET     CMDLINE
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PROPFILE,CMDLINE
          TRAPCLR   IO
          IF        OVRCD=1
            WRITE     HTMLFILE;"Can't&nbsp;read: ",CMDLINE;
            GOTO      DVYHED99
          ENDIF
.
DVYHED10  READ      PROPFILE,SEQ;PROPLINE
          GOTO      DVYHED99 IF OVER
.
          WRITE     HTMLFILE;PROPLINE
.
          GOTO      DVYHED10
.
DVYHED99  CLOSE     PROPFILE
.
          RETURN
+
.---------------------------------------------------------------
. DVAW DVYW <tran id>_dvyw  tag
.---------------------------------------------------------------
DVYJSN00  MATCH     SP70,WBB2DPTH
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"WebServices B2B Device directory not found.";
            GOTO      DVYJSN99
          ENDIF
.
          MATCH    SP70,WBETSTRD
          GOTO     DVYJSN99 IF EQUAL
          GOTO     DVYJSN99 IF EOS
.
          CLEAR     CMDLINE
          APPEND    WBB2DPTH,CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    "/webPAS_claims/dvyw/",CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    WBETSTRD,CMDLINE
          APPEND    DVYWLITR,CMDLINE
          RESET     CMDLINE
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      DVYWFILE,CMDLINE
          TRAPCLR   IO
          IF        OVRCD=1
            WRITE     HTMLFILE;"Can't&nbsp;read: ",CMDLINE;
            GOTO      DVYJSN99
          ENDIF
.
DVYJSN10  READ      DVYWFILE,SEQ;DVYWLINE
          GOTO      DVYJSN99 IF OVER
.
          WRITE     HTMLFILE;DVYWLINE
.
          GOTO      DVYJSN10
.
DVYJSN99  CLOSE     DVYWFILE
.
          RETURN
+
.---------------------------------------------------------------
. DVAW DVYW <tran id>_dvyw_response  tag
.---------------------------------------------------------------
DVYRSP00  MATCH     SP70,WBB2DPTH
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"WebServices B2B Device directory not found.";
            GOTO      DVYRSP99
          ENDIF
.
          MATCH    SP70,WBETSTRD
          GOTO     DVYRSP99 IF EQUAL
          GOTO     DVYRSP99 IF EOS
.
          CLEAR     CMDLINE
          APPEND    WBB2DPTH,CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    "/webPAS_claims/dvyw/",CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    WBETSTRD,CMDLINE
          APPEND    DVYRLITR,CMDLINE
          RESET     CMDLINE
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      DVYRFILE,CMDLINE
          TRAPCLR   IO
          IF        OVRCD=1
            WRITE     HTMLFILE;"Can't&nbsp;read: ",CMDLINE;
            GOTO      DVYRSP99
          ENDIF
.
DVYRSP10  READ      DVYRFILE,SEQ;DVYRLINE
          GOTO      DVYRSP99 IF OVER
.
          WRITE     HTMLFILE;DVYRLINE
.
          GOTO      DVYRSP10
.
DVYRSP99  CLOSE     DVYRFILE
.
          RETURN
+
.---------------------------------------------------------------
. DVAW DVYW <tran id>_dvyw_errors  tag
.---------------------------------------------------------------
DVYERR00  MATCH     SP70,WBB2DPTH
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"WebServices B2B Device directory not found.";
            GOTO      DVYERR99
          ENDIF
.
          MATCH    SP70,WBETSTRD
          GOTO     DVYERR99 IF EQUAL
          GOTO     DVYERR99 IF EOS
.
          CLEAR     CMDLINE
          APPEND    WBB2DPTH,CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    "/webPAS_claims/dvyw/",CMDLINE
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          APPEND    WBETSTRD,CMDLINE
          APPEND    DVYELITR,CMDLINE
          RESET     CMDLINE
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      DVYEFILE,CMDLINE
          TRAPCLR   IO
          IF        OVRCD=1
            WRITE     HTMLFILE;"Can't&nbsp;read: ",CMDLINE;
            GOTO      DVYERR99
          ENDIF
.
DVYERR10  READ      DVYEFILE,SEQ;DVYELINE
          GOTO      DVYERR99 IF OVER
.
          WRITE     HTMLFILE;DVYELINE
.
          GOTO      DVYERR10
.
DVYERR99  CLOSE     DVYEFILE
.
          RETURN
+
.------------------------------------------------------------------------------ 
          INC       IBAWEBCD
          INC       IBALPCCD
          INC       PATRE1TM
          INC       PRIUPURE
.
          INC       OBSDETIO/INC      * Observations on Ward Map
.
          INC       APSMASIO/INC
          INC       AAEDE1IO/INC
          INC       FMSLMAIO/INC      * Ledger Master Details
          INC       FMSCSAIO/INC
          INC       PATIN1IO/INC
          INC       PATINVIO/INC
          INC       PATITMIO/INC
          INC       BOKDIAIO/INC
          INC       BOKRX1IO/INC
          INC       BOKRC1IO/INC
          INC       CATCOMIO/INC
          INC       EMRVISIO/INC
          INC       IBAPOSIO/INC
          INC       IBALPCIO/INC
          INC       MLTSECIO/INC
          INC       OPRARDIO/INC
          INC       OPRSRGIO/INC
          INC       OPRDEAIO/INC
          INC       OPROPRIO/INC
          INC       OPRSESIO/INC            * Theatre Sessions Table
          INC       OPRSEMIO/INC            * Theatre Session Master
.
          INC       WEBBBSIO/INC
          INC       WEBBRHIO/INC
          INC       WEBBRDIO/INC
          INC       WEBBBAIO/INC
          INC       WEBBBDIO/INC
.
          INC       WEBDVWIO/INC
          INC       WEBDVHIO/INC
          INC       WEBDVIIO/INC
          INC       WEBDVAIO/INC
          INC       WEBDVDIO/INC
.
          INC       OUTSITIO/INC
          INC       OUTBB1IO/INC
          INC       PATASFIO/INC
          INC       PATALRIO/INC
          INC       PATATRIO/INC
          INC       PATBMDIO/INC
          INC       PATBRDIO/INC
          INC       PATHSPIO/INC
          INC       PATHFRIO/INC
          INC       PATDGWIO/INC
          INC       PATDADIO/INC
          INC       PATDSCIO/INC
          INC       PATDTRIO/INC
          INC       PRIDTRIO/INC
          INC       PRIHDBIO/INC
          INC       PRIHREIO/INC
          INC       PATNIDIO/INC
          INC       PATTRNIO/INC
          INC       PATELGIO/INC
          INC       PATONLIO/INC
          INC       PATMA1IO/INC
          INC       PATRE1IO/INC
          INC       PATREMIO/INC
          INC       PATRGMIO/INC
.
          INC       PMSCCDIO/INC   * Concession Card Details
          INC       PMSBDCIO/INC
          INC       PMSBRQIO/INC
          INC       PMSDTCIO/INC
          INC       PMSREGIO/INC
          INC       PMSHCGIO/INC
          INC       PMSHCPIO/INC
          INC       PMSPX2IO/INC
          INC       PATCMCIO/INC
          INC       VISMDTIO/INC
          INC       VISMTXIO/INC
          INC       PATMI1IO/INC
          INC       PATVISIO/INC
          INC       PATUREIO/INC
          INC       PATDO1IO/INC
          INC       PATWR1IO/INC
          INC       PATNOBIO/INC
          INC       PATLOCIO/INC
          INC       PATPR1IO/INC
          INC       MRTLOCIO/INC
          INC       RESLNKIO/INC
          INC       PMSUCHIO/INC
          INC       PMSUCDIO/INC
          INC       PATFN1IO/INC
          INC       PATFX1IO/INC
          INC       PATVADIO/INC
          INC       PATVENIO/INC
          INC       PMSRCBIO/INC
          INC       MRTMASIO/INC
          INC       PATDAYIO/INC            * HPS Code Starts Here
          INC       PATDDHIO/INC
          INC       PATNURIO/INC
          INC       PATPARIO/INC
.         INC       PMSEADIO/INC
.         INC       PRIEADIO/INC
.         INC       PMSEAHIO/INC
.         INC       PRIEAHIO/INC
.         INC       PMSEBHIO/INC
.         INC       PRIIBHIO/INC
.         INC       PMSERDIO/INC
.         INC       PMSERHIO/INC
.         INC       PMSECAIO/INC
.         INC       PRIECAIO/INC
.         INC       PMSECOIO/INC
.         INC       PMSETRIO/INC
.         INC       PMSECTIO/INC
.         INC       PRIECTIO/INC
          INC       PRIPRAIO/INC
          INC       PRIINVIO/INC
.         INC       PMSESHIO/INC
.         INC       PRIESHIO/INC
.         INC       PMSESDIO/INC
.         INC       PRIESDIO/INC
          INC       PMSEVTIO/INC
          INC       PMSPDPIO/INC            * HPS Code Ends Here
          INC       PMSWORIO/INC
          INC       RCPBDTIO/INC
          INC       RCPBNKIO/INC
          INC       RCPDTEIO/INC
          INC       RCPREGIO/INC
          INC       NHIMASIO/INC
          INC       NHIETHIO/INC
          INC       VISCMTIO/INC
          INC       WATTR1IO/INC
          INC       WEBIMBIO/INC
          INC       WEBIHBIO/INC
          INC       WEBERDIO/INC
          INC       WEBERHIO/INC
          INC       WEBIMAIO/INC
          INC       WEBIHAIO/INC
          INC       WEBECOIO/INC
          INC       WEBETRIO/INC
          INC       WEBIMCIO/INC
          INC       WEBIHCIO/INC
          INC       WEBB2BIO/INC
          INC       WEBIMDIO/INC
          INC       WEBIHDIO/INC
          INC       WEBPARIO/INC
          INC       PATDDHRD
          INC       CALCBMIN
          INC       CATCOMTM
          INC       PATBRDTM
          INC       PMSOSDTM
          INC       PMSWORTM
          INC       CLNHIMAS                * Clear nhimasaf file variables
          INC       CLPATDSC
          INC       CLPATRE1
          INC       CLPMSPX2
          INC       CLPMSVX1
          INC       CLPATMIS
          INC       CLBOKRC1
          INC       CLPATATR
          INC       CLWEBDVW
          INC       CLWEBBBS
          INC       CLWEBIMC
          INC       CLWEBIHC
          INC       DGCLICAC
          INC       DGCLICCP
          INC       PATNAMCD
          INC       PATDOCTM
          INC       PATDOCCD
          INC       PATMASTM
          INC       PATMISTM
          INC       PATATRTM
          INC       PMIGTNID
          INC       PMSPX2TM
          INC       PMSHCGTM
          INC       PMSHCPTM
          INC       PATMSXTM
          INC       PATWRDTM
          INC       PMSVX1TM
          INC       CALCAGE
          INC       NAMSTRCD
          INC       WEBDATCD
          INC       RSHWEBCD
          INC       DAYOFWEK
          INC       PMSVX1IO/INC
          INC       PMSNUTIO/INC            * v9.02.08
          INC       PMSNUTTM                * v9.02.08
          INC       CLPMSNUT                * v9.02.08
          INC       CLCATCOM
          INC       CLEMRVIS
          INC       CLOPRARD
          INC       CLOPRSRG
          INC       CLBOKRX1
          INC       TFILENAM
          INC       FHRDATCD
          INC       PMSCURIO/INC
.
