.----------------------------------------------------------------------
. Program       : PATWEB96
.
. Function      : Admission Discharge Transfer Server
.
. Modifications :
.----------------------------------------------------------------------
. V12.00.10 05/09/2025 Ebon Clements     TSK 0961623
.           Fixed on leave error message format - LEAVE910 and LEAVE920
. V12.00.09 01/09/2025 J.Tan             TSK 0960675
.           Added Audit for Change Claim code/HF and Adm.type
. V12.00.08 08/08/2025 Ebon Clements     TSK 0964891
.           Fixed wattx1af read for ASA score - WESE0000
. V12.00.07 04/08/2025 Zumin             TSK 0964707
.           Recompiled for PATDISCH - Discharge Date/Time error message
. V12.00.06 02/07/2025 Davin             TSK 0954308
.           Recompiled for PATDISCH - Changed standby hl7 trigger
. V12.00.05 17.06.2025 Davin/DAS         TSK 0954308
.           Added HL7CODE to flag when patient discharged from leave
. V12.00.04 17/06/2025 Ebon Clements     TSK 0961998
.           Added open of wattx1af to WESE0000
. V12.00.03 16/06/2025 J.Tan             TSK 0961932
.           Recompiled for WEBDINVS - Moved back SAVEND to FORM3
. V12.00.02 02/06/2025 Nikitha B       TSK 0955096
.           Alphanumeric error corrections.
. V12.00.01 23/05/2025 Nikitha B       TSK 0955096
.           Alphanumeric changes
. V11.05.07 07/05/2025  Nikitha B      TSK 0959601
.           Recomplied for PATMISTM.
. V11.05.06 15.04.2025  DA Sarkies     TSK 0954308
.           Updated code to call correct function and removed display
. V11.05.05 09.04.2025  DA Sarkies     TSK 0954308
.           Added switch for sending A08/A02 on stanby bed swap
. V11.05.04 24/03/2025  Ebon Clements  TSK 0958460
.           Recompiled for GTCMPATD - user id
. V11.05.03 18.03.2025  DA Sarkies     Task 0955909
.           Updated the ESIS extract to add the ASAS code
. V11.05.02 23/01/2025  Alina Bhari    TSK 0955488
.           Stopped Updating the caretype of linked statistical Admission while
.           updating the discharge date/time -CHGAD150
. V11.05.01 26/11/2024  J.Tan          TSK 0946342
.           Recompiled for PATDISCH - Updating Inv.pending on visxdcaf
. V11.04.14 23/09/2024 J.Tan           TSK 0950577
.           Recompiled for PATIPERH - Fixed issue with Hold Invoice audit
. V11.04.13 15/08/2024  Davin           TSK 0935869
.           Added BVISUP00/STADMFWD/STDSCBAC to CANCL000 to ensure hl7 update
.           messages are broadcast in the correct order when changing
.           statistical admission/discharge dates via supervisor screen
. V11.04.12 01/07/2024  Ebon Clements   TSK 0947663
.           Added clear of standby admission number - SAVWSTBY - SBYPT000
. V11.04.11 17/06/2024  Bella Turco     TSK 0947689
.           New routine UPMVIT00 to update pmsextaf.PMEXCLAM for Bed Transfer
.           Claim Type Change for WAH
. V11.04.10 31/05/2024  Ebon Clements   TSK 0947201
.           Flag leave register records as deleted when they are not the last
.           leave for the patient - DLLLR000 DLLRT000           
. V11.04.09 01/05/2024  Jacob Jackson   TSK 0941762
.           Allow server to receive empty MRFDDATE values to be updated
. V11.04.08 26/04/2024  Jacob Jackson   TSK 0941762
.           Recompiled for PATECDFD
. V11.04.07 24/04/2024 Jacob Jackson   TSK 0941762
.           Upload and display "Reason for Discharge Delay" input value to 
.           VSXDCOD2
. V11.04.06 25/03/2024 Thanh T         TSK 0940239
.           Added ATRFA000 and WRPATR20 for Medically Cleared for Discharge
.           details 
. V11.04.05 13/03/2024 J.Tan           TSK 0910994
.           Recompiled for CMXMATRX-Added Att.Doctor,Concession card & Disc.UDF
.           13/03/2024  J.Tan          TSK 0919335
.           Mod checking for HF history (set Service date - TSRVDATE)
. V11.04.04 29/01/2024  Jacob Jackson  TSK 0919335
.           Add HF History includes
. V11.04.03 29/01/2024  Jacob Jackson  TSK 0919335
.           Add new local variable and recompile for GETTFEES
. V11.04.02 10/01/2024 Thanh T         TSK 0936263
.           Recompiled for DGCLICAD changes
. V11.04.01 30/11/2023 Ebon Clements  TSK 0925492
.           Recompile for BEDBDPRO - Multiple theatre bookings per admission
. V11.03.15 13/11/2023 Alina Bhari    TSK 0916531
.           Updated the discharge record with correct bed and ward when on
.           leave/return record are deleted -UDDLR000,CHMTR650,CHKLVE00,CHMTR560
. V11.03.14 11/10/2023 Thanh T        TSK 0935874
.           Changed UPDF9000 to comment out the codes for PTCNUNET = '1'
.           since it is no longer used
. V11.03.13 23/09/2023  Alina Bhari    TSK 0937651
.           Didn't allow On Leave process to put On Leave field with a future
.           time - UPDBT061                                                  
. V11.03.12 08/09/2023  Davin          TSK 0935183
.           Changed to send the A08 for standby patient (if one exists) after
.           the A12 when cancelling a transfer (DELBTR50/SBYPT000/GENU0000)
. V11.03.11 07/09/2023  Nikitha B     TSK  0936159
.           Packed TRANMEMB with spaces to prevent wrong matching with PMVXFNDM
. V11.03.10 21/08/2023  J.Tan         TASK 0935226
.           Recompiled for PATDISCH - Set PMMRARDT to disc.date
. V11.03.09 24/07/2023 Thanh T        TSK 0930508
.           Recompiled as PMSVX1TM changes           
. V11.03.08 21/06/2023  J.Tan          TSK 0934004
.           Recompiled for PATIPERH - checking Patient Hold invoice 
. V11.03.07 14/06/2023  Don Nguyen     TSK 0928367
.           Recompiled for CALCCODE; Re-worked code to round up ICU & NCU hrs
. V11.03.06 17/05/2023  Don Nguyen     TSK 0928367
.           Recompiled for CALCCODE; Rounded up ICU & NCU hrs for Vic
. V11.03.05 04/04/2023  Bella Turco    TSK 0911166
.           Recompiled for PATIPERH - Hold Invoice Audit
. V11.03.04 08/02/2023  Thanh T        TSK 0917555
.           Added DSCH4800 - Preferred Discharge Time common parameter
.           Added WRPATR10 to write out Late Discharge Reason/comments
. V11.03.03 17/01/2023  Davin          TSK 0916627
.           Send HL7 A08-Update after A22-Return from leave (based on PTCNSRFL)
. V11.03.02 07/12/2022  PJ Le Febour   Task 0918326
.           Added trap around write to pmsadwaf in WEDI0000 WEAL0000
. V11.03.01 18/11/2022  Ebon Clements  Task 0924976
.           Added EDWARD discharged as deceased trigger - EDWD0000
. V11.02.08 10/11/2022  Jill Parkinson Task 0910962
.           Added check for mh leave register in UPDBT991               
. V11.02.07 07/11/2022  Jill Parkinson Task 0925910
.           Added check for aclss ind 4=D to allow overlap in CHKT0000
. V11.02.06 19/05/2022 J.Tan           TSK 0837128
.           Recompiled for PRFAINSR - to use Cat CL indic 24
. V11.02.05 29/04/2022 J.Tan           TSK 0837128
.           Mod Default PRFA based on Claim type (PRFAINSR)
. V11.02.04 07/04/2022  Ebon Clements  TSK 0915984
.           Added medically ready for discharge date - UXDC0000
. V11.02.03 01/04/2022  Thanh T        TSK 0903453
.           Added SPPXUCC4, SPPXUCC5, SPPXATF1 and SPPXATF2 for
.           DEATHAUD changes
. V11.02.02 23/02/2022  Thanh T        TSK 0903847
.           Changed ATRFB000 to write out blank for Invalid tag
. V11.02.01 10/02/2022  Thanh T          TSK 0889899
.           Recompiled as WATTR1FD changes
. V11.01.37 06/01/2022  Jill Parkinson Task 0890901                 
.           Added check for on leave ind 4=A or M to allow undischarge   
. V11.01.36 20/12/2021  Thanh T         TSK 0877055                 
.           Added DEATHATD for common variables to be used in DEATHAUD   
. V11.01.35 08/11/2021  J.Tan          TSK 0880410
.           Recompiled for PATIPERH - added Hospital and System
.           22/11/2021  Thanh T        TSK 0903848
.           Added ATRFB000, WRPATR00, DSCH4400, DSCH4500 and DSCH4600
.           for Bed management enhancement   
. V11.01.34 29/09/2021  J.Tan          TSK 0901515
.           Recompiled for CMXMATRX - Added Primary Proc.to Matrix
. V11.01.33 15/09/2021  Thanh T        TSK 0889595
.           Recompiled for PMSDAUFD/DEATHAUD changes
. V11.01.32 13/09/2021  Ebon Clements  TSK 0910279
.           Recompiled for BEDBDVCD (BEDBDPRO) - Post Op Ward
. V11.01.31 27/08/2021  Jill Parkinson Task 0910463
.           Recopiled for PMSLRDTM - Leave time calculation
. V11.01.30 27/08/2021  Ebon Clements  TSK 0910383
.           Recompiled for BEDBDVCD (BEDBDPRO) - Post Op / Expected Ward
. V11.01.29 18/08/2021  Ebon Clements  TSK 0884918
.           Use the expected dicharge date for the bed management bed board if
.           it's a current admission instead of ADTATE plus ASTAY - UPPBMN00
. V11.01.28 30/07/2021  Jill Parkinson Task 0890901
.           Added check for leave type ind3=A or M in CHKT0000
. V11.01.27 29/07/2021  Jill Parkinson Task 0909683
.           Fixed CHKNUR00 to user userid not secureid
. V11.01.26 27/07/2021  Jill Parkinson Task 0890901
.           Recompiled for CHKDDS00 to allow multiple admissions if on leave
.           with type ind 3=A or M
. V11.01.25 23/07/2021  Jill Parkinson Task 0892115
.           Changed to output cat CL ind 23 instead of ind 1 in DDPS0000
. V11.01.24 22/07/2021  Ebon Clements  TSK 0909330
.           Recompiled for BEDBDPRO - Post op ward 
. V11.01.23 21/07/2021  Jill Parkinson Task 0900650
.           Changed ADMT0500 to output TTIME (8 chars) instead of KEY5
.           Added write to housekeeping for update of leave register  
. V11.01.22 16/07/2021  Jill Parkinson Task 0900650
.           Added leavereg cgi
. V11.01.21 15/07/2021  Jill Parkinson Task 0900650
.           Fixed saving of notes for leave register                 
. V11.01.20 12/07/2021  Jill Parkinson Task 0907928
.           Recompiled for PATDISCH - added pmsvx1af.pmvxemps update
. V11.01.19 07/07/2021  J.Tan           TSK 0908588
.           Recompiled for CMXMATRX - Exclude Unqualified days for Casepayment
. V11.01.18 05/07/2021  Jill Parkinson Task 0900650
.           Added update of leave register from supervisor return/onleave delete
. V11.01.17 02/07/2021  Thanh T        TSK 0905755
.           Recompiled as BEDBDPRO changes
. V11.01.16 28/06/2021  Jill Parkinson Task 0900650                         
.           Recompiled for PMSLRDTM - meds given to ouput no
. V11.01.15 25/06/2021  Jill Parkinson Task 0900650                         
.           Mods to ignore deleted and inactive leave register details on upd 
. V11.01.13 24/06/2021  Jill Parkinson Task 0900650                         
.           Added code to delete movement from leave register delete          
. V11.01.12 22/06/2021  Jill Parkinson Task 0900650                         
.           Added leave register filters to allow return to list with filters
. V11.01.11 18/06/2021  Jill Parkinson Task 0900650                         
.           Added retndate and retntime for leave register returns
. V11.01.10 16/06/2021  Davin          Task 0907416                         
.           Added separation modes J and L (CHKINT00/CTSM0000)
. V11.01.09 12/06/2021  Jill Parkinson Task 0900650                         
.           Added nurse validation for leave register
. V11.01.08 08/06/2021  Jill Parkinson Task 0900650                         
.           Fixed trap around leave register reads 
. V11.01.07 08/06/2021  Jill Parkinson Task 0900650                         
.           Mods to update and delete leave register information            
. V11.01.06 01/06/2021  Jill Parkinson Task 0900650                         
.           Created patient level leave register list                       
. V11.01.05 27/05/2021  Jill Parkinson Task 0900650                         
.           Added write to new leave register details table                 
. V11.01.04 28/04/2021  Thanh T        TSK 0895165                          
.           Recompiled for OPRARDFD changes                                 
. V11.01.03 21/04/2021  Thanh T        TSK 0901851
.           Changed WASF0000 check for HDP Default = "9" and "10" for
.           contract Id
. V11.01.02 07/04/2021  Tracey Nguyen   TSK 0901515
.           Recompiled for PMSCMTFD - Added new fields
.           a) 1 File type for ICD procedure (PMCCIPF)
.           b) 3 new CMBS Field Type (PMCCFTS4/PMCCFT5C/PMCCFT6C)
.           c) 3 new CMBS Codes From (PMCCPC4F,PMCCSC5F,PMCCTC6F)
.           d) 3 new CMBS Codes To   (PMCCPC4T/PMCCSC5T,PMCCTC6T)
. V11.01.01 11/03/2021  Tracey Nguyen   TSK 0901515
.           Recompiled for PMSCMTFD - Added Primary ICD Procedure 1-5
.           (PMCCICP1-5)
.----------------------------------------------------------------------
. V11.00.16 09/12/2020  Thanh T        TSK 0872840
.           Added PMSCCDFD/PMSCCDIO as PMSPX2TM changes
. V11.00.15 24/11/2020  J.Tan           TSK 0899866
.           Fixed Reason for Hold invoice after changing Admission Type
. V11.00.14 10/11/2020  J.Tan           TSK 0899562
.           Recompiled for CMXMATRX - setup date for reading MBS item
. V11.00.13 22/10/2020  J.Tan         TSK 0898866
.           Recompiled for PATIPERH - on hold invoice
. V11.00.12 22/09/2020  J.Tan           TSK 0895330
.           Recompiled for CMXMATRX - reposition read of Matrix table
. V11.00.11 10/09/2020  J.Tan            TSK 0897163
.           Mod checking CFINAN (display finance option) for CMXMATRX
. V11.00.10 05/08/2020  Ebon Clements    TSK 0870994
.           Only select discharged visits that where admitted on the proposed
.           discharge date - RSTATV00
. V11.00.09 05/07/2020  Ebon Clements    TSK 0870994
.           Select all discharges regardless of proposed adm date - RSTATV00
. V11.00.08 23/07/2020  Ebon Clements    TSK 0870994
.           Select all discharges regardless of proposed adm date - RSTATV00
. V11.00.07 13/07/2020  Ebon Clements    TSK 0870994
.           Added statvisn update discharge statistical admission link
.           USTATD00
. V11.00.06 23/06/2020  Peter Vela       TSK 0878550
.           Recompiled for DEATHAUD
. V11.00.05 10/06/2020  Peter Vela       TSK 0878550
.           Recompiled for DEATHAUD
.           01/06/2020  Ebon Clements    TSK 0870994
.           Added remote script to check for visits to stat admit - RSTATV00
. V11.00.04 22/04/2020  Ebon Clements     TSK 0850105
.           Clear PMCUTSTA and PMCUTLOC before write to pmscuraf
. V11.00.03 02/04/2020  J.Tan             TSK 0868813
.           Changed PKNAME to DIM80
. V11.00.02 28/02/2020  J.Tan          TSK 0838262
.           Added Effective from and to date to MBS Item file
. V11.00.01 20/02/2020  Peter Vela       TSK 0879283
.           Changed validation for unqualified public/private newborn in
.           DDPS0450
. V10.15.04 03/02/2020  Ebon Clements    TSK 0887327
.           Added EDWARD delete tranfer record trigger - DELADC00
. V10.15.03 30/01/2020  Peter Vela       TSK 0879283
.           Changed goto in DDPS0000 for qualified newborn
. V10.15.02 11/11/2019  Peter Vela       TSK 0879283
.           Added tag for defaulting Cat KK in DSCH4300
.           Added Admission Criteria functionality in INSUR00
. V10.15.01 09/10/2019  Thanh T          TSK 0860841
.           Get MRCNROUN for CALCCODE
.----------------------------------------------------------------------
. V10.14.13 31/07/2019  Peter Vela       TSK 0874259
.           Validate for existing patwc1af record before update in DEWCOM00
. V10.14.12 23/07/2019  Peter Vela     TSK 0878598
.           Changed CHKINT00 back to what it was before task 0877390
. V10.14.11 17/07/2019  Ebon Clements  TSK 0877986
.           Added EDWARD health fund add/update trigger - EDWH0000
. V10.14.10 17/07/2019  Ebon Clements  TSK 0877986
.           Added 20 zero test to PTCNNSSI using EDWARD
. V10.14.09 08/07/2019  Peter Vela     Task 0877390
.           Changed CHKINT00 to accept CAT DD Transfer to other hosp 
.           and CAT VR Re adm other hosp no booking for 20190701
.           08/07/2019  Jill Parkinson                
.           Added write to pmsadwaf in PADC3000 for att doctor changes
. V10.14.08 13/06/2019  Peter Vela     Task 0871798
.           Recompiled for DEATHAUD
.           14/06/2019  Tracey Nguyen  Task 0856503
.           Recomplied for MEHDIATD/TM - Added Diagnosis type 1 to 6
. V10.14.07 03/06/2019  Jill Parkinson Tsk 0873054
.           Recompiled for patdisch - update mh patatraf on discharge
. V10.14.06 29/04/2019  Peter Vela      TSK 0868836
.           Changed VAED dates back to 20190701
. V10.14.05 19/03/2019  Richa Phoagt    TSK 0869550
.           Added ACCAUDFD/IO, CLACCAUD, MVACCREM
. V10.14.04 18/03/2019  Peter Vela     TSK 0868836
.           2019 Stat Changes CHKINT00
. V10.14.03 12/03/2019  Tracey Nguyen  TSK 0863060
.           Recompiled for PATVISTM - Added VISS6400 & VISS6500
. V10.14.02 27/02/2019  Ken Bell       TSK  0869548
.           Recompiled for PATCLMTM - Added Diagnosis Codes for NZ template
. V10.14.01 15/02/2019  Ebon Clements  TSK  0828972
.           Added set scanned medical record flag on discharge - scannedm
. V10.13.14 17/01/2019  Jill Parkinson Task 0869303
.           Mods to only open pmsadwaf before writing
. V10.13.13 04/10/2018  Jill Parkinson Task 0867688
.           Mods to write to pmsadwaf when discharge details are updated
.           Recompiled for GETEFDRG - Using Effective DRG
. V10.13.12 02/01/2019  J.Tan          Task 0868352
.           Mod Changing Disc.date to check for Care type change
. V10.13.11 04/12/2018  Ebon Clements  Task 0864976
.           Fixed change claim code EDWARD visit alteration writes - WEDI0000
. V10.13.10 27/11/2018  Steve Armstrong  TSK 0866168
.           Mods to handle message triggers where an on-leave is being cancelled
.           and where it's followed by a return from leave which is the last
.           transfer record.
. V10.13.09 27/11/2018  Ania P         TSK 0859769
.           Added ADMT8200 & GTMX0000
. V10.13.08 14/11/2018  Jill Parkinson Task 0863748
.           Added check and warning in MVMED000 if moving to blank location
. V10.13.07 07/11/2018  Don Nguyen     TSK 0853817
.           Modified DEWCOM00 (Delete Workers comp. details) to set
.           Claim Status to 'Cancelled' if only one visit for the Claim Number
.           exists (NZ Only); instead of deleting it.
.           05/11/2018  Ken Bell       Task 0865289
.           Recompile for PATDISCH changes
. V10.13.06 22/10/2018  Ebon Clements  Task 0865146
.           Added EDWARD visit alteration writes - WEDI0000
. V10.13.05 20/10/2018  Jill Parkinson Task 0865161
.           Removed change made for V10.12.11 PADC4000 re-read of patmi1af
. V10.13.04 25/09/2018  Richa Phogat   TSK 0857201
.           Added variable STFUND, LSTFUND to save funding source to PMSVX1FD
. V10.13.03 20/09/2018  Richa Phogat   TSK 0862951
.           Recompiled for PATDISCH
. V10.13.02 11/09/2018  Davin          TSK 0854839
.           When cancelling leave movements, only send HL7 A12s if site is
.           broadcasting HL7 on-leave/return-from-leave messages (DELREC00)
. V10.13.01 13/08/2018  Peter Vela     TSK 0845218
.           Recompiled for DEATHAUD
. V10.12.16 17/07/2018  Ebon Clements    TSK 0849291
.           Recompiled for PATDISCH
.           11/07/2018  Peter Vela     TSK 0845218
.           Recompiled for DEATHAUD
. V10.12.15 03/07/2018  Thanh T          TSK 0858385
.           Recompiled for PATDISCH changes
. V10.12.14 27/06/2018  Thanh T          TSK 0858385
.           Recompiled for PATDISCH changes
. V10.12.13 26/06/2018  Don Nguyen      TSK 0854115
.           Added A11/A01 HL7 Triggers (DGCLICCA/DGCLICAD) in INSUR000
. V10.12.12 18/06/2018  Richa Phogat    TSK 0854035
.           Updated DELNBR00 by moving WMBOOK to WTHIBOOK instead of WTWMUNIQ,
.           Added DELWAD00
. V10.12.11 07/06/2018  Don Nguyen      TSK 0856980
.           Modified PADC4000 to update admission/visit Doctor
. V10.12.10 17/05/2018  Thanh T.         TSK 0851528
.           Added TRNSREAS/PMVXUD12 for Reason for Transfer
.           17/05/2018  Tracey Nguyen    TSK 0837181
.           Cleared PTTRTRTY value in WRBTR000 to fix previous value from  
.           being retained when writing a new record to pattranf
. V10.12.09 04/05/2018  Tracey Nguyen    TSK 0837181
.           Added ADMT8100 for Transfer Type/Reason tag
. V10.12.08 12/04/2018  Ebon Clements    TSK 0849244
.           Update bed board standby patient if no medical record - 9PDBT100
. V10.12.07 09/04/2018  Davin            TSK 0844301
.           Added new organ procurement tag for Cat.A (ADMT8000)
.           Fixed typo in organ procurement tag (ADMT7900)
. V10.12.06 06/04/2018  Jill Parkinson TSK 0848567
.           Added setting of PTUNSENT to zero so value is not from other patient
. V10.12.05 04/04/2018  Davin            TSK 0844301
.           Added Cat.CC and Cat.P default tags for organ procurement on
.           private discharge screen (ADMT7800,ADMT7900)
. V10.12.04 07/03/2018  Tracey Nguyen    TSK 0852995
.           Replaced SAVBTYP with NEWBYTPE to fix incorrect bed type code
.           defaulting in ADMT3300
. V10.12.03 22/02/2018  J.Tan            TSK 0310703
.           Mod for public hospital to update Inv.pending
. V10.12.02 15/01/2018  Davin            TSK 0850984
.           When patient is discharged, only send one WL upd message (I13)
.           - added SAVKEY19 @ THET3000
. V10.12.01 08/01/2018  Davin            TSK 0844301
.           Added tag for qld mental health doctor flag (DSCH4100)
.           Added write/update to QLD HDP mental health file - PTQMH000
.           20/12/2017 Jill Parkinson Task 0844982
.           Added move of wmurno to wteeurno in case UR has been merged since
.----------------------------------------------------------------------
. V10.11.13 04/01/2018  Ania P           TSK 0848567
.           Added write to PTUNSENT before WRUNAA1
. V10.11.12 27/12/2017  Steve Armstrong  TSK 0850165
.           Recompiled for changes to DGCLICAC.
. V10.11.11 04/12/2017  J.Tan          Task 0844301
.           Added GST Applicable to Patient Status Adjustment
.           07/12/2017  Steve Armstrong  TSK 0849526
.           Fixed DGCLIUWL HL7TRGID = 36 to send a message when WMSTAT is:
.           "3" (Pre-admitted) - when patient is unadmitted
.           "4" (Admitted) - when patient is undischarged
.           "5" (Discharged) - when patient is discharged (previously ok)
.           15/12/2017  Davin            TSK 0844301
.           Added read on pmsworaf for discharge prep (cat.vi) @ MAIN1500
. V10.11.10 28/11/2017  J.Tan          Task 0847628
.           Fixed deleting Change record prior Leave record
. V10.11.09 27/11/2017  Thanh Tieu     Task 0821710
.           Recompiled as PATMASTM changed
. V10.11.08 23/11/2017  Ania P        TSK 0261630
.           Moved TFILNAME to CFNAMEDP in INIT0000
. V10.11.07 16/10/2017  Peter Vela    TSK 084650
.           Fixed date and time validation in CHGAD130
. V10.11.06 08/09/2017  Ebon Clements TSK 0818097
.           Added excluded newborn functionality -  EXNB0000
. V10.11.05 07/09/2017  J.Tan         TSK 0837479
.           Recompiled for CMXMATRX - OPCNCONS (Using Consumption type items)
. V10.11.04 24/08/2017  Davin          TSK 0837617
.           Added new I13 message trigger for Update Waiting List (DGCLIUWL)
. V10.11.03 30/07/2017  Thanh T.       TSK 0821710
.           Audit admission/outpatient/UR comments. changed PATMASTM/PMSPX2TM.
. V10.11.02 26/07/2017  Thanh T.       TSK 0821710
.           Recompiled PASMISTM
. V10.11.01 14/07/2017  Thanh T.       TSK 0821710
.           Audit Amission/outpatient visit comments. PATMISTM changed.
.----------------------------------------------------------------------
.V10.10.10 12/07/2017  Jill Parkinson TSK 0840167  
.          Added ptcnhdps<>6 for Stat admission value in ADMT4210 - ind 10=S
.V10.10.09 29/06/2017  Ebon Clements    TSK 0839977
.          Fixed WL history write for cancel admission when not using theatre 
.          CLADM030
.V10.10.08 26/06/2017  Ebon Clements    TSK 0819303
.          Write a delete and exit NBRS record  - UPNBR000
.V10.10.07 15/06/2017  J.Tan          TSK 0820199
.          Added option to update PMI HF details
.          19/06/2017  Tracey Nguyen    TSK 0839864
.          Added SAVADATE and SAVATIME variables to save the original
.          admission date and time to write to Date change audit file-patunaaf
.V10.10.06 13/06/2017  J.Tan          TSK 0839991
.          Recompiled for PATDBTYP (PATCMSTP)
.V10.10.05 10/05/2017  Thanh T.         TSK 0320410
.          Update NMDS flag to '4' from '1' (patmi1af.pelig) for
.          resubmission when claim code is changed
.V10.10.04 09/05/2017  Thanh T.         TSK 0320410
.          Update NMDS flag to '4' from '1' (patmi1af.pelig) for
.          resubmission when claim code is changed
.V10.10.03 5/05/2017  Jill Parkinson TSK 0318865  
.          Mods to allow update of doctor/unit/specialty while on leave
.          if leave type ind5=D
.          Changed date/time cannot be within leave period though.
.V10.10.02 03/05/2017 Nicole Torrisi  TSK 0837335 
.          Added ADMT7600 for SJOG-Vic Statistical Admission
.V10.10.01 12/04/2017 Nicole Torrisi  TSK 0835306 
.          Added check for blank Admission Date in CHGADM00 
.V10.09.05 28/02/2017  Don Nguyen     TSK 0808741 
.          Added CLRVEN00 - Clear Ventilation End Date/Time & Hours
.          Recompiled for PATDISCH - Modified MVEN0000 to call CHRS0000
.          Added FORM5C & FORM5P2
.V10.09.04 15/02/2017  Jill Parkinson TSK 0818236
.          Added match for 2 to indicator 3 in ADMT4300 for statistical adm
.V10.09.03 18/01/2017  J.Tan          TSK 0808741
.          Recompiled for PATDISCH - Checking for Ventilation hours
.V10.09.02 23/12/2016  Jill Parkinson TSK 0833239 
.          Added update of ACC Purchase order number
.V10.09.01 25/11/2016  J.Tan           TSK 0829814
.          Fixed checking for Previous MH visits
.V10.08.26 24/11/2016  Jill Parkinson TSK 0816916
.          Moved DEADST00 to be before A03 message is triggered so deceased
.          date/status is correct
.V10.08.25 18/11/2016  Peter Vela     TSK 0827671
.           Added single space after Parent of <Initial>.
.           before write to patre1af
.V10.08.24 08/11/2016  Peter Vela       TSK 0819303
.          Added UPNBR000
.          02/11/2016  J.Tan           TSK 0308496
.          Mods checking for incomplete MH details for QLD
.V10.08.23 19/10/2016  Ebon Clements   TSK 0817257
.          Don't move MR if it's already in the destination location - MVMED000 
.          18/10/2016  Don Nguyen      TSK 0816597
.          Modified CHKBED00 to skip record if same day and ADMISTME is null
.V10.08.22 17/10/2016  Don Nguyen      TSK 0816597
.          Modified CHKBED00 to check for null ADMISTME
.V10.08.21 12/10/2016  Peter Vela      TSK 0321329
.          Added report number 14: View/Change Transfer Records
.V10.08.20 05/10/2016  Steve Armstrong TSK 0288770
.          Removed HL7 Message Trigger 19 from CHMTR000, so that a cancel
.          transfer message (A12) is only sent where the transfer
.          record being cancelled is the last transfer record for the visit
.          (which is currently sent in CNLBT000 - Trigger 15).
.V10.08.19 21/09/2016  J.Tan           TSK 0826370
.          Recompiled for CMXMATRX - Changed MCHGARR MCHGAMT array to FORM3
.V10.08.18 21/09/2016  Don Nguyen      TSK 0823600
.          Modified UPDF9000 to only call SCHFAX00 if FAXITFLG=1
.V10.08.17 31/08/2016  Don Nguyen      TSK 0823914
.          Modified UPDF9000 to call SCHFAX00 if discharged as deceased.
.          Modified SCHFAX00 to check if PTCNIDFT (Disch Fax template) is blank.
.V10.08.16 26/08/2016  Don Nguyen      TSK 0312570
.          Recompiled for CMXMATRX - Added check for PTCNDGED=1
.          Added PMSEDGFD/IO and GETEFDRG
.V10.08.15 04/08/2016  Steve Armstrong  TSK 0823644
.          Mods to reposition on last transfer record before
.          triggering A08 (HL7TRGID = 27).
.V10.08.14 18/07/2016  Steve Armstrong   TSK 0814288
.          Mods to move HL7TRGID trigger 23 before the transfer and
.          discharge record are deleted (where the trigger was originally
.          placed but had been commented out)
.V10.08.13 14/07/2016  Jill Parkinson    TSK 0820657
.          Added match to previous ward bed record when deleting a transfer 
.          record.  If removing a change record in the middle of other transfer
.          records, we should only send an A12 if it is a ward bed change
.          being removed.
.V10.08.12 08/07/2016  Jill Parkinson    TSK 0822002
.           Recompiled for PATMASTM
.V10.08.11  06/07/2016  Peter Vela     TSK 0821101
.           Commented out date validation for first ward history record found
.           in CHKBHS00
.V10.08.10  05/06/2016  Jill Parkinson TSK 0822144
.           Fixed check for public holiday file for non multi hospital
.V10.08.09  30/06/2016  J.Tan          TSK 0816866
.           Added a tag to check for Mental Health admission
.V10.08.08  15/06/2016  Don Nguyen     TSK 0820820
.           Modified CHKBHS00 (Check Ward Bed History) to remove date from key 
.           pack at CHKBHS11. Added branch on OVRCD for RKPTWBH1 in CHKBHS13.
.V10.08.07  03/06/2016  Don Nguyen     TSK 0291704
.           Modified CHKBHS00 to skip validation if no ward bed history records
.V10.08.06  02/06/2016  Don Nguyen     TSK 0291704
.           Modified CHKBHS00 to skip validation on empty Ward / Admission Date
.V10.08.05  30/05/2016  Don Nguyen     TSK 0291704
.           Modified CHKBED30 and UPDBT061 to use CHKBHS00.
.           Added CHKBHS00 to check admission date/time against the Bed History
.           Last Effective Date/Time.
.V10.08.04  17/05/2016  Peter Vela     TSK 0819159
.           Recompiled for PMSHRDTM
.V10.08.03  02/05/2016  Jill Parkinson TSK 0816120
.           Reinstated commented out DEPMCUR1 in CLADM000                
.V10.08.02  19/04/2016  Nicole Torrisi TSK 0318853
.           Fixed discharging with no legal status CKDSCP85
.V10.08.01  12/04/2016  Peter Vela     CAR 0816166
.           Moved call of DISHCS00 in CLDSC000
.           05/04/2016  Ania P         CAR 319862
.           Further ANSNAP changes
.V10.07.06  03/03/2016  Ania P         CAR 319862
.           Modifications for reading PMSRUGAF table before ADM/DSCH
.V10.07.05  16/02/2016  J.Tan          CAR 0310703
.           Mods Public Hosp to check for to be inv.amnt before write to patipen
.V10.07.04  06/11/2015 Ebon Clements   CAR 322262
.           Added ind 12 test for bed type to not update ED discharge date
.           when IP discharged - UPDEM000
.V10.07.03  26/10/2015  J.Tan          CAR 317554
.           Recompiled for CALCCODE-Calcultes Daycase ICU/CCU/NCU times
.V10.07.02  19/10/2015  Don Nguyen     CAR 316625
.           Added TRNCASET & CHGCASET for change Doctor/Unit Case Team
.           Recompiled for PATTRNFD - PTTRCASE (Case Team)
.V10.07.01  14/10/2015  Ebon Clements  CAR 316629
.           Added hospital to holiday file key  - OUTPHOFD
.V10.06.17  16/09/2015  Don Nguyen     CAR 308621
.           Modified PRTSEL00 - removed check on Hospital ID
.           Recompiled for PATVISTM - Modified GETFAX00
.V10.06.16  10/09/2015  Don Nguyen     CAR 308621
.           Modified PRTSEL00 to output all printers for a hospital
.V10.06.15  13/08/2015  Don Nguyen     CAR 308621
.           Added REMS0130 - Remote scripting option 13; schedule fax
.           Added SCHFAX00 - Schedule Inpatient Discharge Fax
.           Added ADMT5900 - Printer Selections (ALL)
.           Added ADMT6000-ADMT6100 for Referring HCP/Practice Active Status
.           Recompiled for PATVISTM - Added VISS6100
.           06.08.2015  B.G.Ackland    CAR 320470 
.           Remove PATBMHAF table updates
.           Restrict Number of Records Written to PATBMDAF to 12 weeks
.V10.06.14  24/07/2015  Jill Parkinson CAR 319905 
.           Fixed incorrect call to CHCC0000 when no care type change
.V10.06.13  15/07/2015  J.Tan          CAR 319342
.           Recompiled for CMXMATRX - Chg 'Disc.UDF' to 'Care Class'
.V10.06.12  14.07.2015  Jill Parkinson CAR 317209 
.           Fixed CHKAT000 to use either claim code or health fund, not both 
.           when matching to a program
.V10.06.11  07.07.2015  Jill Parkinson CAR 313321 
.           Added call to CHGNZ000 in UPDADM00
.V10.06.10  17.06.2015  Patrick Adair  CAR 317209
.           Added Admission Type Warning message check for rehab patients
.V10.06.09  12/06/2015  Peter Vela     CAR 314162
.           Added GETHRD00
.V10.06.08  09/06/2015  J.Tan          CAR 317346
.           Fixed NZ Private (CFEETYPE) updating Invoice Pending
.V10.06.07  01/06/2015  Jill Parkinson CAR 317467
.           Recompiled for PATVISTM - category YF moved to pmvxudf8
.V10.06.06  29/05/2015  Jill Parkinson CAR 313321
.           Added updates of AELIG to 4
.V10.06.05  27/04/2015  Jill Parkinson CAR 315241
.           Recompiled for PATVISTM - for PMVXUDF7
.V10.06.04  15/04/2015  Peter Vela     CAR 312723
.           Recompiled for DEATHAUD
.           Added post functionality for Clinical Group (PTDSCLGP)
.V10.06.03  20/03/2015  Don Nguyen     CAR 306757
.           Recompiled for MEHVISTM - Modified MHVS5800 to read mehdlsaf
.V10.06.02  19/03/2015  Don Nguyen     CAR 300414
.           Recompiled for CALCCODE - Added check for PTCNICUT
.V10.06.01  16/03/2015  Don Nguyen     CAR 306757
.           Recompiled for MEHDISTM & MEHVISTM
.           12/03/2015  Steve Armstrong  CAR 314108
.           Removed definition of PTCGDATE as PATCGPFD is no longer
.           in use.
.----------------------------------------------------------------------
.V10.05.21  03/03/2015  J.Tan          CAR 311352
.           Recompiled for PATDSBFE
.V10.05.20  19/02/2015  J.Tan          CAR 311352
.           Recompiled for PATDSBFE
.V10.05.19  18/02/2015  Don Nguyen     CAR 306757
.           Added DSCH3300 - TCINDC5 for ACARE (Cat CC)
.V10.05.18  12/02/2015  Patrick Adair  CAR 208170
.           Amended call to Death Audit table and include new variables as
.           SVMAS variables are too small for new fields.
.V10.05.17  06/02/2015  Don Nguyen     CAR 306757
.           Added MHDSC000 and UPDMHDSC
.           Recompiled for MEHVISTM - Added MHVS5800
.V10.05.16  18/12/2014  J.Tan          CAR 309655
.           Recompiled for CALCCODE - fixed ICU hours
.V10.05.15  12/12/2014  J.Tan          CAR 309912
.           Recompiled for AUTOATYP - Getting Primary MBS
.V10.05.14  27/11/2014  Peter Vela     CAR 308906
.           Added read of discharge record in CANCL010
.V10.05.13  26/11/2014  Peter Vela     CAR 308906
.           Recompiled for PATDISCH
.V10.05.12  25/11/2014  Peter Vela     CAR 308067
.           Added input functionality for PTDSUYN1, PTDSUYN2, PTDSUYN3
.V10.05.11  23/10/2014  Peter Vela     CAR 307383
.           Check for NZ PTCNHDPS=1 in CUSG0000
.V10.05.10  16/10/2014  Jill Parkinson CAR 305091
.           Added DAYONCOL cgi to allow redirect back to day oncology page
.           Added GETRG000 to get regimes if not on screen
.V10.05.09  13/10/2014  Don Nguyen    CAR 276546
.           Recompiled for changes to PATDSCTM - Added DSCF3200-DSCF4100
.V10.05.08  22/09/2014 Jill Parkinson CAR 305091
.           Added call to UPPBMN00 in ALLBDT00 - bed allocation
.           Added call to BBUP0000 in ALLBD000 - CAR 305842
.V10.05.07  19/09/2014 J.Tan  CAR 299241
.           Recompiled for CALCCODE - minutes in ICU
.V10.05.06  04/09/2014  Steve Armstrong CAR 305716
.           Mods to re-read discharge transfer record prior to triggering
.           a discharge message (via DGCLICDS).
.V10.05.05  14/08/2014  Peter Vela     CAR 304860
.           Recompiled for PMSVX1TM
.V10.05.04  14/08/2014 J.Tan          CAR 304477
.           Fixed Public hospital updating Inv.pending at discharge
.V10.05.03  11/08/2014  Don Nguyen    CAR 297774
.           Recompiled for changes to PMSBRQFD/IO
.V10.05.02  05/08/2014 Jill Parkinson CAR 304477
.           Fixed invalid care type 10 with disharge dest G in CTSM0100
.V10.05.01  25/06/2014  J.Tan          CAR 303861
.           Mods to check Inv.pending (UBFE0000) at discharge for Public Hosp.
.V10.04.16  25/06/2014  J.Tan          CAR 302233
.           Recompiled for PATDSBFE - bed fees for daycase NHOSP=D
.V10.04.15  19/06/2014 J.Tan           CAR 302452
.           Recompiled for WEBDINVS - Changed MCHGARR/MCHGAMT
.V10.04.14  04/06/2014  J.Tan          CAR 300791
.           Recompiled for PATDISCH - checking Invoice pending
.V10.04.13  12/05/2014  Jill Parkinson CAR 300420
.           Fixed move of pttrteam to stateam in LTRND010
.V10.04.12  05/05/2014  Jill Parkinson CAR 300420
.           Mods to update pmsvx1af.pmvxteam when deleting bed transfers
.V10.04.11  28/04/2014  Steve Armstrong   CAR 261630
.           Removed references to PATAUB FD PATAUEFD and PATAUTFD as files were
.           never updated or written to.
.           Also removed PATAUMFD (No Longer used).
.           29/04/2014  Jill Parkinson CAR 300420
.           Changed CHNGTEAM to get populated even if spaces, to allow clearing
.V10.04.10  10/04/2014  Jill Parkinson CAR 299891
.           Changed CHNGTEAM to get packed with Z70 instead of SP70 in CLRPAR00
.V10.04.09  11/04/2014  J.Tan           CAR 291832
.           Recompiled for PATDISCH - Removed updating Invoice on hold for Disc.
.V10.04.08  07/04/2014  Peter Vela      CAR 286258
.           Recompiled for PATMASTM
.V10.04.07  03/04/2014  Don Nguyen       CAR 296928
.           Added ADMT5700 - Ward Classification (CODITM00) output
.V10.04.06  31.03.2014  B.G.Ackland  CAR 299363
.           Replace META Tag Redirect with Javascript in Common RDIREC00
.           Routine
.V10.04.05  20/03/2014  J.Tan         CAR 279251
.           Mods to write to Death audit file and added generic user
.V10.04.04  18/03/2014  Jill Parkinso CAR 294183
.           New care type validations for July 2014 PRS2
.V10.04.03  27/02/2014  Don Nguyen       CAR 291879
.           Call WIPL0000 for Patient Discharge (UPDF0000)
.V10.04.02  18/02/2014  J.Tan            CAR 296637
.           Mods to UBFE0000 - fixed LINETOT for daycase patients
.V10.04.01  15/01/2014  Don Nguyen       CAR 295067
.           Added IO trap around call to UPOPDEA2
.----------------------------------------------------------------------
.V10.03.113 13/12/2013  J.Tan            CAR 294609
.           Recompiled for CMXMATRX - mods for Default Grouper Version
.V10.03.112 09/12/2013  Don Nguyen       CAR 294703
.           Added PTVIS110 for PMVXPGID - Program Identifier Cat PK
.V10.03.111 04/12/2013  Ebon Clements    CAR 281940
.           Fixed bug in UPPBMN00 where FORM3 wasn't initialised before use.
.           Also fixed same issue in GTTOTM00 and CHKBMN00.
.V10.03.110 03/12/2013  Ebon Clements    CAR 292764
.           Check change of doctor not between leave records - VLVE0000
.V10.03.109 25/11/2013  Don Nguyen       CAR 243982
.           Modified CLDSC000 to update last discharge date (PLDDATE)
.V10.03.108 12/11/2013  Peter Vela       CAR 292689
.           Added check to release Ward/Bed if cancelling leave and return
.V10.03.107 11/11/2013  Peter Vela       CAR 292689
.           Populated OWARD and OBED before WRONLV1 in DELRET00
.V10.03.106 28/10/2013  Patrick Adair    CAR 201234
.           Recompiled for changes to WLHISSUB
.           24/10/2013  Patrick Adair    CAR 252671
.           New Remote script to prevent change of Admission date for Patients
.           booked from a waiting list. (VALDTE00)
.V10.03.105 16/10/2013  Don Nguyen       CAR 292675
.           Recompiled for changes to BRHLCOMN (DGCLICAC)
.V10.03.104 15/10/2013  Peter Vela       CAR 292084
.           Assigned spaces to SAVEBSCD if FORMACTN is Discharge
.           @ THET3000
.V10.03.103 14/10/2013  Ania P           CAR 278232
.           Recompiled
.V10.03.102 11/10/2013  J.Tan            CAR 251004
.           Mods checking Disc.date/time before writing a Change Trans.record
.V10.03.101 02/10/2013  Patrick Adair    CAR 265798
.           Recompiled for MEHDIATM
.V10.03.100 27/09/2013  Peter Vela       CAR 291485
.           Added update to end date/time for boarders @ CANCL021
. V10.03.99 26/09/2013  J.Tan            CAR 291627
.           Recompiled for PATDYCAS - Mods checking Inv.Pending for Public Hosp.
. V10.03.98 17/09/2013  Don Nguyen       CAR 291139
.           Added SKIPAUWR flag to allow the skipping of audit record write for
.           calls to DISHCS00 & ADMHCS00 in DELONL00 & DELRET00 respectively.
. V10.03.97 10/09/2013  Steve Armstrong  CAR 291089
.           Recompiled for changes to PMSQVIFD.
. V10.03.96 21/08/2013  Peter Vela       CAR 288213
.           Added validation for PTCNWFIM in CHOLA000, CHOLD000
. V10.03.95 13/08/2013  Davin            CAR 288770
.           Read prevous transfer record to get the ward the patient was in
.           prior to the transfer (for PV1-03) for A12 HL7 message (chmtr100)
. V10.03.94 09/08/2013  Ebon Clements    CAR 225950
.           Changed ShowPatient() to pass blank admission - DISL0000
.           The default visit will be picked up by patweb9801001
. V10.03.93 05/08/2013  J.Tan            CAR 288060
.           Recompiled for CMXMATRX - fixed Primary/Secondary/Tertiary MBS
. V10.03.92 01/08/2013  Don Nguyen       CAR 288439
.           Removed call to DISHCS00 in DELONL00. Shouldn't be calling it
.           since it's not a discharge so patient does not have a DADMNO.
. V10.03.91 25/07/2013  Davin            CAR 280870
.           Added broadcast A08 message when cancel care type change (ccart000)
. V10.03.90 24/07/2013  Jill Parkinson   CAR 285046
.           Moved CHKDDS00 to PATDISCH include
. V10.03.89 18/07/2013  Steve Armstrong  CAR 268961
.           Recompiled for changes to PMSQVIFD.
. V10.03.88 09/07/2013  Davin            CAR 288154
.           Only update aclaim if using multiple fin. elections (updadm10)
.           09/07/2013  Jill Parkinson   CAR 288154
.           Commented out update of aclaim in UPDADM00
. V10.03.87 01/07/2013  Davin            CAR 286607
.           Recompiled for PATDISCH - save team from pmsvx1af in pattranf
. V10.03.86 30/06/2013  Davin            CAR 279183
.           Recompiled for changes to hl7 messaging (allquefd)
. V10.03.85 12/06/2013 Patrick Adair     CAR 286021
.           Corrected warning message when transferring patient on leave
. V10.03.84 04/06/2013 Jill Parkinson
.           Commented out error for dstat/ddest, template determines mandatory
.           04/06/2013  J.Tan            CAR 286309
.           Mods checking for Outstanding Debts for discharging Supervisor
. V10.03.83 17/05/2013  Peter Vela       CAR 285004
.           Changed to use long description @ CLBTOL92
. V10.03.82 17/05/2013  Peter Vela       CAR 285004
.           Added Ward/Bed description @ CLBTOL92
. V10.03.81 16/05/2013  Davin            CAR 279533
.           Don't call dgclicac if no valid pattranf record found
.           (hl7trgid=4/17/26)
. V10.03.80 09/05/2013  J.Tan            CAR 284289
.           Fixed record status for patipenf file
. V10.03.79 09/05/2013  Jill Parkinson   CAR 285009
.           Changed CLDSC990 to show PTWDSDES instead of tward/tbed
. V10.03.78 01/05/2013  Steve Armstrong  CAR 284376
.           Recompiled for changes to DGCLICUP.
. V10.03.77 01/05/2013  J.Tan            CAR 283505
.           Fixed pmmiamtt to include quantity in FIXT000
. V10.03.76 23/04/2013  J.Tan            CAR 284277
.           Added tag for ASTAT
. V10.03.75 19/04/2013  J.Tan            CAR 283608
.           Mods to update Date of Death when updating Disc.date
. V10.03.74 03/04/2013  Davin          CAR 270648
.           Recompiled for changes to HL7 messaging includes
. V10.03.73 02/04/2013  J.Tan   CAR 282669
.           Added tag for Admission Transfer Source
. V10.03.72 20/03/2013  Steve Armstrong CAR 272419
.           Added A27 trigger for a recurring care admission that's
.           been cancelled.
. V10.03.71 19/03/2013  Jill Parkinson CAR 282814
.           Recompiled for PATMASTM - Disability alert DSAL0000 change
. V10.03.70 12/03/2013  J.Tan          CAR 275549
.           Changing Insur./Adm.Type/Bed Trans to upd Inv.Pending for Public Hos
. V10.03.69 07/03/2013  Steve Armstrong   CAR 282269
.           Mods to HL7 Trigger 16 to only send an A03 message when the
.           FORMACTN is "Discharge".
. V10.03.68 05/03/2013  J.Tan          CAR 211137
.           Fixed Cancel Admission (CLADM000) to check for Theatre Usage
. V10.03.67 05/02/2012  Peter Vela     CAR 268790
.           Added validation for extended leave standby patients @ LEAVE000
. V10.03.66 31/01/2013  Peter Vela     CAR 269490
.           Changed default to Carer Not Needed / Not Applicable in CHKCAR00
. V10.03.65 25/01/2013  Ania P         CAR 262661
.           Removed incorrect additional call to  ADMHCS00 from CHGAD070
. V10.03.64 23/01/2013  Jill Parkinson CAR 279239
.           Moved CHKSTB00 to PATDISCH, added clear of STBYPAT
. V10.03.63 17/01/2013  Jill Parkinson CAR 279239
.           Changed EPTST000 to use ADMISSNO instead of AADMNO
.           21/01/2013  J.Tan          CAR 211300
.           Mods Changing Claim code to update wateseaf file
. V10.03.62 10/01/2013  Jill Parkinson CAR 276103
.           Recompiled for PATDISCH - message trigger 16 sending wrong ward/bed
.           on update discharge
. V10.03.61 05/12/2012  Jill Parkinson CAR 268087
.           Added check of WMBOOK to AADMNO in BOOK0000 and THET3000
. V10.03.60 04/12/2012  J.Tan            CAR 271474
.           Recompiled for CMXMATRX - using index 5 of pmscmtaf
. V10.03.59 04/12/2012  J.Tan            CAR 275549
.           Mods NEWR0000 to check for non zero TRATEH (Health fund portion)
. V10.03.58 28/11/2012  Peter Vela       CAR 276921
.           Added Short Stay validation @ UPDEM00
. V10.03.57 19/11/2012  J.Tan            CAR 275549
.           Fixed changing claim code to check Invoice pending file
. V10.03.56 15/11/2012  Peter Vela       CAR 189848
.           Added validation for Overseas Reciprocal and Asylum Seeker @
.           CHKF0000
. V10.03.55 01/11/2012  Jill Parkinson CAR 275279
.           Added RDATRAN before all transfer file writes
. V10.03.54 16/10/2012  J.Tan            CAR 263723
.           Fixed discharging WA Private Insurance, Not to update PRFA
. V10.03.53 01/10/2012  J.Tan            CAR 273822
.           Mods to use CAGECOFF for 'Parent of' PRFA
. V10.03.52 05/09/2012  J.Tan          CAR 267784
.           Mods Checking for TCINDC19 Claim Code
. V10.03.51 06/09/2012  Patrick Adair    CAR 270065
.           Recompiled to pick up PATDISCH updates
. V10.03.50 31/08/2012  Steve Armstrong  CAR 267360
.           Added GENU0000 routine to generate an A08 message for a standby
.           patient going into a bed.
. V10.03.49 07/08/2012  Patrick Adair    CAR 257776
.           remote scripts to validate FIM overlap on ADM/DSC date change
. V10.03.48 02/08/2012  J.Tan            CAR 263723
.           Mods checking Claim code TCINDC17 for Deceased Estates Desc.
.           18/06/2012  Jill Parkinson   CAR 267045
.           Moved CHKBTR00 to PATDISCH
.           08/06/2012  Peter Vela       CAR 266414
.           Commented out delete of PMSCUR record in CLADM00
.           25/05/2012 Patrick Adair     CAR 257776
.           Warning messages for AN-SNAP processing
.           01/06/2012  Davin            CAR 260600 VAED-2012
.           If disch.dest=G, intention to readmit must be 0 (chkint00)
.           07/08/2012  Jill Parkinson   CAR 254372
.           Put back hospital validation in CHKDDS00 and CHAD0000
. V10.03.47 03/06/2012  Jill Parkinson   CAR 254372
.           Removed hospital validation in CHKDDS00 and CHAD0000
. V10.03.46 24/07/2012  Steve Armstrong  CAR 267360
.           Mods to re-read the current patient's admission record
.           (in DELBTR00) after processing standby patient (using SBYPT000)
. V10.03.45 28/06/2012  Steve Armstrong  CAR 267469
.           Added call to DGCLICDS (HL7 Trigger 16)
.           Moved call to DGCLICCD to after the discharge has been cancelled.
. V10.03.44 04/06/2012  Peter Vela       CAR 266234
.           Match CHNGTEAM to Z70
. V10.03.43 24/05/2012 J.Tan             CAR 243152
.           Fixed PRFA on Undischarge of a deceased patient
. V10.03.42 15/05/2012  Davin            CAR 260777 WA-HMDS Triggers
.           Added calls to proc WRWATR00 for supervisor & upd.disch. functions
. V10.03.41 15/05/2012 J.Tan             CAR 255708
.           Mods checking for Hold Invoices From Date
. V10.03.40 10/05/2012  Peter Vela     CAR 232137
.           Recompiled for BEDBDVCD
. V10.03.39 27/04/2012  Don Nguyen     CAR 254988
.           Added check for value of 'M' in TCINDC11 on discharge update
. V10.03.38 17/04/2012  Davin            CAR 260600 VAED-2012
.           Added care type R1/R2/10 and separation mode G (ctsm0000)
. V10.03.37 04/04/2012  J.Tan          CAR 262655
.           Mods CHKDDS00 - checking for Disc.date Overlaps Adm.Supervisor
. V10.03.36 29/03/2012  Peter Vela     CAR 262683
.           Fixed RDK in CALBFE00
. V10.03.35 23/03/2012  Ebon Clements  CAR 260555
.           Save adm date and time in data integrity audit unadmit - WRCHU000
. V10.03.34 19/03/2012  Ebon Clements  CAR 262014
.           Added hospital test to newborn and border links tags
. V10.03.33 09/03/2012  Ebon Clements  CAR 260555
.           Write cancelled admission record to WL change audit when un admit
. V10.03.32 01/03/2012  Peter Vela     CAR 260225
.           Added delete mental health functionality to cnacel pre adm
.           CLADM000
. V10.03.31 24/02/2012  Peter Vela     CAR 260225
.           Fixed CANMH000
. V10.03.30 21/02/2012  Peter Vela     CAR 260225
.           Added Remove Mental Health Details functionality
. V10.03.29 16/02/2012  Peter Vela     CAR 260223
.           Fixed ADMT4700
. V10.03.28 08/02/2012  Davin          CAR 257767
.           Send 'L' transfer record details in the A21 message when cancelling
.           a return from leave (cantype=4 in updfil00)
.           Use aretdte to populate expected return date in patonlvf (delret00)
. V10.03.27 06/02/2012  Jill Parkinson CAR 259021
.           Changed ADMT4700 Cat AC to use indicator 6 instead of 5
. V10.03.26 06/02/2012  Jill Parkinson CAR 254372
.           Fixed CHKDDS00 to brach to CHKDDS90 instead of CHKDDS99
. V10.03.25 01/02/2012  Jill Parkinson CAR 253987
.           Mods to write to pmswtraf - WA Health triggers
. V10.03.24 23/01/2012  Mike Laming    CAR 242949
.           Mods at DISL0200 to Redirect to a Linked UR (Patient Link)
. V10.03.23 23/01/2012  Peter Vela      CAR 258554
.           Check for mental health speciality @ CKDSCP00
. V10.03.22 21/01/2012  Davin S         CAR 258174
.           Moved A08 broadcast message (dgclicac - trigger 28) from padc0000
.           to pubds000 to cater for care type changes.
. V10.03.21 16/01/2012  Sandra Barcham  CAR 256563
.           Recompiled for PATMASTM
. V10.03.20 21/12/2011  Peter Vela      CAR 254056
.           Added check for active/inactive mh referrals @ LSREF000
. V10.03.19 15/12/2011  Jill Parkinson  CAR 256062
.           Added call to GASF0000 in MAIN1500
. V10.03.18 13/12/2011  Jill Parkinson  CAR 256062
.           Added output of ADMT5400 - default adm type for organ procurement
. V10.03.17 12/12/2011  Mike Laming    CAR 255302
.           Recompiled for changes to PATMISTM (Ward/Bed MISB1700)
. V10.03.16 09/12/2011  Jill Parkinson CAR 251566
.           Added CHKTRN00 and call to CHKDDS00 in UPDF0000
. V10.03.15 08/12/2011  Peter Vela     CAR 254464
.           Changed ADMT5200 to find open Inpatient MH Referral
. V10.03.14 07/12/2011  J.Tan          CAR 246468
.           Fixed description for Deceased Estates
. V10.03.13 01/12/2011  Mike Laming    CAR 250985
.           Added MultiDatabase to DEAPOL00 (DEATHPOL), added variables etc to
.           this for DEATHPOL.PBL
. V10.03.12 25/11/2011  Saroeun Soeur  CAR 255820
.           delivery on admiss DELVISIT
. V10.03.11 23/11/2011  Ebon Clements  CAR 255738
.           Show ward beds in short description order
. V10.03.10 22/11/2011  Peter Vela     CAR 255398
.           Added validation to Bed Transfer UPBT0000. If extra compensable
.           PTCNXCOM = 1 (WAHealth), then do not write to mehvis on mental
.           health bed transfer
. V10.03.09 04/11/2011  Davin           CAR 249257
.           Added A08 triggers for prfa change - hl7trgid 33
. V10.03.08 16/11/2011  Jill Parkinson CAR 255282
.           Added branch on exit after CLADM000
. V10.03.07 15/11/2011  Jill Parkinson CAR 255014
.           Added use of default code at ADMT5100
. V10.03.06 11/11/2011  Peter Vela     CAR 252428
.           Added read to PTCNWAUC
. V10.03.05 09/11/2011  Jill Parkinson CAR 254221
.           Recompiled for PATDISCH
. V10.03.04 09/11/2011 Jill Parkinson CAR 252671
.           Added pack of WTEEEDAT with SP70 in WESE0000
. V10.03.03 08/11/2011  Peter Vela CAR 252443
.           Added tag for latest MH Legal Status record key (MEHDLSFD)
. V10.03.02 07/11/2011  J.Tan CAR 254871
.           Recompiled for CALCCODE - calculating ICU for daycase
. V10.03.01 07/11/2011  Peter Vela      CAR 253499
.           Added mental health redirect for Psychiatry specialty
. V10.02.48 27/10/2011  Steve Armstrong CAR 251323
.           Recompiled for PMSQVIFD changes
. V10.02.47 21/10/2011  Jill Parkinson CAR 251645
.           Added default tags for statistical discharges
. V10.02.46 18/10/2011  Peter Vela       CAR 249257
.           Added update of patre1af on update of claim type FPRA0000
. V10.02.45 17/10/2011  Steve Armstrong  CAR 253036
.           Removed Trigger Id 11 for a cancel transfer HL7 message,
.           as the only trigger required in DELADC00 is an update (A08) message.
. V10.02.44 14/10/2011  Ebon Clements    CAR 251052
.           Don't clear ED linked IP admission on unadmit. Removed UNEMR000
. V10.02.43 12/10/2011  Peter Vela       CAR 252428
.           Added validation in WASF0000 for WAHealth if HDP Equivalent = 0
. V10.02.42 12/10/2011  Steve Armstrong  CAR 251644
.           Recompiled for changes to PMSQVIFD/PMSQVIIO.
. V10.02.41 11/10/2011  Mark Coupland    CAR 252429
.           Recompiled for PATMASTM & PMSPX2TM
. V10.02.40 10/10/2011  Ebon Clements  CAR 252441
.           Don't display leave or standby error if pre admitting - CHKBED00
. V10.02.39 07/10/2011  Jill Parkinson CAR 252167
.           Added check for CHGDOC=1 in VDOC0000
. V10.02.38 07/10/2011  Saroeun Soeur  CAR 234355
.           added PTUNOTTM
. V10.02.37 06/10/2011  Davin            CAR 252266
.           Added routine to validate doctor start/end dates (vdoc0000/actdoc00)
. V10.02.36 05/10/2011  Mike Laming      CAR 252032
.           Added ADMT4100 to determine if Patient has any Medical Records
. V10.02.35 22/09/2011 Ebon Clements   CAR 251675
.           Fixed tracking history location hospital code - MVMED000
. V10.02.34 21/09/2011 J.Tan           CAR 242151
.           Mods for WA Mental Health
. V10.02.33 20/09/2011 Ebon Clements   CAR 251144
.           Fixed save and display of blank linked U/R date - LINK0000
. V10.02.32 13/09/2011 J.Tan  CAR 248658
.           Mods to update Health fund details for WA private Financial Elect.
. V10.02.31 13/09/2011 Jill Parkinson  CAR 249559
.           Added check for updatety=9 at CLADM140 for recurring care
. V10.02.30 13/09/2011 Jill Parkinson  CAR 248652
.           Recompiled for PMSPX2TM - Added read of pmsvx1af in GETCURIP
. V10.02.29 12/09/2011  Nicole Torrisi CAR 240560
.           Recompiled for PATMISTM - changed PTMSMGIN to use CODITM00
. V10.02.28 07/09/2011  Davin         CAR 249683
.           Allow blank registrar/resident on 'change doctor/unit' screen
. V10.02.27 30/08/2011  Davin         CAR 248328
.           Removed update of aclss (on supervisor)
. V10.02.26 25/08/2011  Steve Armstrong   CAR 249085
.           Added DGCLICUP triggers for Mother/Child links
. V10.02.25 22/08/2011  Jill Parkinson CAR 249025
.           Put back call to IBACLOCK in CHKDAT00
.           Recompiled for CALCCODE - not to use TRANDATE TRANTIME
. V10.02.24 17/08/2011  Jill Parkinson CAR 234592
.           Commented out call to DISHCS00 at CHGAD160
.           19/08/2011  Davin          CAR 248341
.           Changed registrar field to use pmvxedc3 not pmvxedc1
. V10.02.23 17/08/2011 Jill Parkinson CAR 248328
.           Mods to update aclss when changing care type(on supervisor)
. V10.02.22 16/08/2011  Jill Parkinson CAR 248315
.           Mods to allow current admissions when undischarging (contmult)
. V10.02.21 11/08/2011  J.Tan             CAR 239592
.           Mods updating funding source for Public financial election
. V10.02.20 09/08/2011  Mike Laming       CAR 241939
.           Added write of final "patchcof" record to Discharge routine UPDF9000
. V10.02.19 09/08/2011  Mike Laming       CAR 241939
.           Added call to EPTST000 in CANCL000 for CHMTR000, CLADM000, CCART000
. V10.02.18 08/08/2011  Mike Laming       CAR 241939
.           Added EPTST000 and mods to CHCC0000 for Episode Coding (patchcof)
. V10.02.17 08/08/2011  Davin             CAR 240723
.           Added registrar (chngrstr) & resident (chngresi).
. V10.02.16 05/08/2011  Davin             CAR 240723
.           Added functionality to change unit/team combo (chngteam).
. V10.02.15 28/07/2011  Ebon Clements     CAR 243582
.           Added using tracking receipt functionality
. V10.02.14 15/07/2011  J.Tan            CAR 239592
.           Mods for change of Financial election
. V10.02.13 12/07/2011  Jil Parkinson    CAR 242269
.           Added PTDSDPMN and TRNTTYPE
. V10.02.12 08/07/2011  Mike Laming      CAR 240724
.           Mods to MRT Tables for Hospital Id. - WA Health changes
. V10.02.11 07/07/2011 Peter Vela         CAR 240705
.           Added update to PATBRDFD Boarder End Date and Time on patient
.           discharge
. V10.02.10 07/07/2011 Peter Vela         CAR 240705
.           Added update to PATBRDFD Boarder End Date and Time on patient
.           discharge
. V10.02.09 05/07/2011 Jill Parkinson     CAR 250712
.           Mods to only unadmit for recurring care current admissions
. V10.02.08 25/06/2011 Steve Armstrong    CAR 240722
.           Mods to cater for changes to PATLOCFD.
.                - LSNAME & LGNAME extended to 40 chars.
.                - PTLCGNM2 added.
.           22/06/2011  Steve Armstrong   CAR 240722
.           Mods to cater for changes to PMSCURFD:
.                - PMCUSURN & PMCUGNAM extended to 40 chars.
.                - PMCUGNM2 added.
.           Also recompiled for changes to PATDISCH.
. V10.02.07 24/06/2011  Peter McMullen CAR 240725
.           Change ward selection list to sort by name, not code
. V10.02.06 09/05/2011  Jill Parkinson CAR 250712
.           Moved common discharge routines into new include PATDISCH
. ......... 11/05/2011  Mike Laming    CAR 240707
.           Mods to use CLMRTHIS - caused by MRTHISFD file change.
. V10.02.05 09/05/2011  J.Tan             CAR 239588
.           Mods changing Financial Election/Claim code for a date/time
. V10.02.04 04/05/2011  Peter Vela        CAR 239557
.           Added Mental Health Redirect in Update Specialty PADC0000
.           Added tag for Specialty Phsychiatry indicator DSCH0000
. V10.02.03 18/04/2011  Peter Vela        CAR 240719
.           Added Mental Health Leave Type and Leave Validation
. V10.02.02 18/04/2011  Saroeun Soeur     CAR 231028
.           copied WASF0000 from PATWEB89
. V10.02.01 23/03/2011  Mike Laming       CAR 240107
.           Remove PTCNUCEP PATMRDFD/IO and PATMROFD/IO
. V10.01.13 22/03/2011  J.Tan          CAR 233267
.           Mods to disp.financial details for bed transfer & Return from Leave
. V10.01.12 16/03/2011  J.Tan          CAR 233924
.           Mods to set claim type to pattranf file
. V10.01.11 16/02/2011  Jill Parkinson CAR 237470
.           Added S to be valid in CTSM0300
. V10.01.10 02/02/2011  Steve Armstrong   CAR 237520
.           Mods to remove Detente interface (PATDETNT)
. V10.01.09 01/02/2011  Jill Parkinson CAR 236722
.           Changed DSCH2300 to use CALCAGE instead of DAYSEP
. V10.01.08 13/01/2011  J.Tan          CAR 233048
.           Mods PATTFEFD to use HF Table Type
.           17/01/2011  J.Tan          CAR 233034
.           Mods PATBFEFD to use HF Table Type
.           25/01/2011  J.Tan          CAR 233038
.           Mods to check for Claim code file for Using matrix
. V10.01.07 11/01/2011  Ebon Clements  CAR 215701
.           Recompiled for BEDBDVCD -  H/F stepdown
. V10.01.06 04/01/2011  Jill Parkinson CAR 235954
.           Changed MVMED000 to use WEBWAR00 instead of WEBERR00
. V10.01.05 21/12/2010  Ebon Clements  CAR 215701
.           Recompiled for BEDBDPRO - H/F stepdown update
. V10.01.04 20/12/2010  Peter Vela     CAR 215697
.           Added remote script to validate Ward/Bed
.           13/12/2010  Jill Parkinson 	  CAR 233088
.           Increased size of membership number and moved to pmvxfndm
.           06/12/2010  Ebon Clements     CAR 233927
.           Added reason for hold update to invoice pending
.           06/12/2010  Mike Laming   CAR 233046
.           Mods for "H/F Table Type" (PTMCHFTT) - replaces H/F Table MHFTAB
. V10.01.03 30/11/2010  Peter Vela     CAR 233148
.           Initialised PTTRUCID and PTTRUUID before write to pattranf
.           and update to pattranf
. V10.01.02 04/11/2010  Jill Parkinson CAR 233008
.           Removed reference to PTCNUUNA - now standard functionality
. V10.01.01 01/11/2010  Jill Parkinson CAR 232426
.           Added ADMNREAS and DSCHREA
. V10.00.20 06/10/2010  Ebon Clements  CAR 231396
.           Recompiled for BEDBDVCD - Post op records expected ward/bed
. V10.00.19 20/09/2010 J.Tan             CAR 217548
.           Mods to recalculate ICU/NCU/CCU after stepdown
. V10.00.18 14/09/2010  Ebon Clements     CAR 228740
.           Fixed bed board update when performing ward bed swap MAIN1400
. V10.00.17 24/08/2010  Mike Laming       CAR 195158
.           Recompiled for PATMASTM - Legal Status Icon changes
. V10.00.16 18/08/2010 J.Tan            CAR 222031
.           Mods to set PMMIDUPD and PMMITUPD
. V10.00.15 18/08/2010  Davin             CAR 223805
.           Recompiled for PATVISTM
. V10.00.14 17/08/2010 J.Tan             CAR 227873
.           Recompiled for PATCATBI- getting the grouper version
. V10.00.13 16/08/2010 J.Tan             CAR 217548
.           Fixed calculating ICU hours for undischarge patients
. V10.00.12 16/08/2010 J.Tan             CAR 228192
.           Recompiled for AUTOATYP - to use MBS amount for getting most exp.itm
.           11/08/2010 J.Tan             CAR 227873
.           Recompiled for PATCATBI-searching for next matrix rules
. V10.00.11 23/07/2010 J.Tan             CAR 226635
.           Fixed to set PTTREPSD to zero for ward/bed transfer
. V10.00.10 16/07/2010 J.Tan             CAR 226322
.           Recompiled for CMXMATRX - search for next rule if Contract not valid
. V10.00.09 22/06/2010 Jill Parkinson    CAR 224594
.           Added R into CHKINT00
. V10.00.08 22/06/2010 Jill Parkinson    CAR 224146
.           Added R as valid separation type for Victoria
. V10.00.07 18/06/2010 Mike Laming       CAR 221911
.           Re-compiled for PATMASTM - NZ LS Alerts
. V10.00.06 03/06/2010  Mike Laming   CAR 218150
.           New mod to check for "no Active Legal Status" record - at CKDSCP85
. V10.00.05 30/04/2010  J.Tan     CAR 220887
.           Mods checking for Active/Inactive of Misc.charge
. V10.00.04 12/04/2010 Steve Armstrong   CAR 219111
.           Recompiled for changes PATUNAFD.
.           Mods for change from KEY17 to KEY25 in PATUNAFD.
. V10.00.03 09/04/2010 Steve Armstrong   CAR 219045
.           Recompiled for changes PATMRGFD.
.           31/03/2010  Mike Laming  CAR 217575
.           Recompiled for changes to MEHDIAFD
. V10.00.02 23/03/2010  J.Tan          CAR 215436
.           Fixed pending file for changing disc.date after invoiced
. V10.00.01 19/03/2010  Steve Armstrong   CAR 135505
.           Added HL7TRGID & HL7INCLD setting for all broadcast messages
.-------------------------------------------------------------------------------
. V9.12.31  09/03/2010  J.Tan          CAR 217017
.           Recompiled for AUTOATYP - Mods to set PTTRAUAT (Auto update Admtyp)
. V9.12.30  26/02/2010  J.Tan          CAR 217017
.           Recompiled for AUTOATYP - Change record after Disc.
. V9.12.29  02/02/2010  Davin          CAR 215234
.           Recompiled for CMXMATRX
. V9.12.28  27/01/2010  J.Tan          CAR 214877
.           Recompiled for CMXMATRX - Checking for range of MBS items
. V9.12.27  22/01/2010  Mike Laming    CAR 210958
.           Mods to check for "no Active Legal Status" record - at CKDSCP85
. V9.12.26  19/01/2010  J.Tan          CAR 166439
.           Recompiled for PATCMSTP - fixed C/P additional charge stepdown
. V9.12.25  12/01/2009  Jill Parkinson CAR 208815
.           Mods to BOOK0000 to set WTWMBSCD=20 only if discharging(not unadmit)
. V9.12.24  03/12/2009  Ebon Clements  CAR 204362
.           Recompiled for BEDBDPRO - Clear post op ward
. V9.12.23  27/11/2009  Jill Parkinson CAR 208160
.           Added B8 into WASF0000
. V9.12.22  26/11/2009  Mike Laming    CAR 205505
.           Mod to fix Patient Folders from defaulting to "Overseas" @ CHKF8500
. V9.12.21  25/11/2009  Peter Vela        CAR 206685
.           Commented out zero validation for ADJTIME in UPPBMN50
. V9.12.20  11/11/2009  Ebon Clements  CAR 208991
.           Recompiled for BEDBDVCD - Post op expected due date
. V9.12.19  05/11/2009  WeeLee Koo      CAR 208305
.           Updated Attending Doctor(pattranf) to reflect on last Doc -- CHKDIS00
. V9.12.18  05/11/2009  Ebon Clements CAR 207604
.           Recompiled for AUTOATYP - determine time in recovery
. V9.12.17  26/10/2009  J.Tan           CAR 206764
.           Recompiled for AUTOATYP - Suggested classification
. V9.12.16  19/10/2009  WeeLee Koo     CAR 207859
.           Updated Bed Type(pattranf) to reflect on New Bed Type --- CHKDIS00
. V9.12.14  16/10/2009  WeeLee Koo     CAR 207859
.           Updated Discharge Ward(patdschf) to reflect on Discharge
.           Ward(pattranf) --- CHKDIS20
. V9.12.13  12/10/2009  J.Tan         CAR 188108
.           Recompiled for CHKCMXPT - I*C on patcmxaf file
. V9.12.12  29/09/2009  Jill Parkinson    CAR 206400
.           Mods to pack DIM30 in RECALC00 before changing TWARD, TBED
. V9.12.11  21/09/2009  J.Tan             CAR 205303
.           Added Contract ID
. V9.12.10  15/09/2009  Davin S           CAR 206063
.           Added read of pmspx2af after reading patma1af (various spots)
. V9.12.09  04/09/2009  Jill Parkinson CAR  205290
.           Mods to not clear pttrepsd if per diem
. V9.12.08  21/08/2009  J.Tan         CAR 183225
.           Fixed the admission type for bed transfer
. V9.12.07  07/08/2009  J.Tan         CAR 202281
.           Fixed not to write to Inv Pending if patient Invoiced and Discharged
. V9.12.06  24/07/2009  J.Tan         CAR 201132 & 202168
.           Recompiled for CMXMATRX - checking for zero MBS amount
. V9.12.05  13/07/2009  Davin S           CAR 200835
.           Changed to read transfer file before cancal adm. broadcast message
.           (CLADM080)
. V9.12.04  24/06/2009  Ebon Clements  CAR 199232
.           Recompiled for BEDBDVCD
. V9.12.03  15/06/2009 Ebon Clements  CAR 159088
.           Added OERTIME - Expected return from leave time
. V9.12.02  05/06/2009  J.Tan         CAR 196010
.           Recompiled for CMXMATRX - ICD10 Secondary/Tertiary
. V9.12.01  13/05/2009  Saroeun Soeur     CAR 195320
.           Added output for newborn also admitted
.****************************************************************************
. V9.11.14  01/04/2009  Jill Habasque     CAR 159753
.           Added output for boarder also admitted
. V9.11.13  01/04/2009  Jill Habasque     CAR 192294
.           Changed caretype 8 to allow all separation modes in CTSM0300
. V9.11.12  28/01/2009  J.Tan             CAR 168838
.           Recompiled for AUTOATYP - calculates daycase duration
. V9.11.11  06/01/2009  Ebon Clements   174080
.           Fixed update of bed board for standby patients
. V9.11.10  10/12/2008  Ebon Clements   174080
.           Fixed update of bed board after missing medical record error
. V9.11.09  09/12/2008  Davin       CAR 175736
.           Added call to dgclicac (A08 trigger) when patient is taken off
.           standby due to bed being vacated by discharged patient (chkstb00)
. V9.11.08  03/12/2008  Ebon Clements CAR 174065
.           Added capture housekeeping functionality
. V9.11.07  28/11/2008  Ebon Clements CAR 174057
.           Added bed board functionality
. V9.11.06  18/11/2008  Peter Vela    CAR 183844
.           Moved Move Medical Record Validation after Bed Management
. V9.11.05  06/11/2008  Peter McMullen CAR 174725
.           convert internal javascript to W3C standards
. V9.11.04  31/10/2008  Jill Habasque CAR 181236
.           Removed call to CHKHIH00
. V9.11.03  20/10/2008  J.Tan       CAR 164196
.           Mods checking if any items to be invoiced after discharged date
.           16/10/2008  Davin       CAR 175736
.           Put patient on standby for ward/bed BEFORE broadcasting transfer
.           message in wrbtr000
.           Added call to dgclicac (A08 trigger) when patient is taken off
.           standby and moved into the bed (upstby00)
. V9.11.02  06/10/2008  J.Tan       CAR 180188
.           Mods to set up CASMXKEY
. V9.11.01  08/10/2008  Ebon Clements  CAR 174074
.           Populate hospital id in morgue management table
. V9.10.09  03/09/2008  J.Tan     CAR 176927
.           Fixed Discharge - not to set pttrepsd to one if it was equal to two
.           (flag for bed fees update)
. V9.10.08  26/08/2008  J.Tan     CAR 176752
.           Fixed daycase rate for SX
. V9.10.07  11/08/2008  J.Tan          CAR 175859
.           Mods to update suggested class.for Daycase Medical Booking
. V9.10.06  21/07/2008  Ebon Clements  CAR 169806
.           Only allow discharge of patients from users current hospital
. V9.10.05  02/07/2008  Mike Laming    CAR 155083
.           Recompiled for PATMISTM - Change PATVADaf select list to use Key 2
. V9.10.04  12/06/2008  Jill Habasque  CAR 170081
.           Mods to pack PTAFDATE and PTAFTIME with TDATE and TTIME for leave
. V9.10.03  10/06/2008  Jill Habasque  CAR 168876
.           Added match for purno in WLNBR000
. V9.10.02  28/05/2008  Jill Habasque  CAR 166273
.           Removed check to only allow 250 days from DATSEL00
. V9.10.01  30/04/2008  Ebon Clements  CAR 166618
.           Added clear of discharge file at the start of WRDS0000
. V9.09.29  15/04/2008  Ebon Clements  CAR 166152
.           Added save and restore of transfer ward/bed and date/time to
.           UPDBT100 at call to UPPBMN00
. V9.09.28  11/04/2008  Ebon Clements  CAR 165984
.           Fixed key when writing to morgue table
. V9.09.27  07/04/2008  Peter Vela     CAR 163822
.           Added DOMP0000 to check max no of patients in Day Oncology view
. V9.09.26  04/04/2008  Peter Vela     CAR 165105
.           Fixed cgi submit for pmsvx039
. V9.09.25  31/03/2008  Peter Vela     CAR 163838
.           Modified CHKBED00 to check closed bed dates and times
. V9.09.24  06/03/2008  J.Tan          CAR 156964
.           Added Legal status to wa Discharge screen
. V9.09.23  05/03/2008  Jill Habasque  CAR 162606
.           Added LASF000 to write contract fields when going on leave
. V9.09.22  29/02/2008  Jill Habasque  CAR 158090
.           Removed check in CDATE000 so all available dates are output
. V9.09.21  26/02/2008  Jill Habasque  CAR 161123
.           Added check for PTCNHOSP in CHKCAR00
. V9.09.20  25/02/2008  Peter Vela     CAR 161881
.           Changed CTBH0000 validater icu hours against los hours
. V9.09.19  22/02/2008  Jill Habasque  CAR 151686
.           Fixed move of 20 to WTWMBSCD in BOOK000
. V9.09.18  22/02/2008 Peter McMullen CAR 161974
.           Update patmi1af PLDDATE on change of discharge date
. V9.09.17  19/02/2008 Jill Habasque CAR 157574
.           Added write to bokunqaf
. V9.09.16  12/02/2008  J.Tan         CAR 135498
.           Mods to set MHINC extract indicator
. V9.09.15  31/01/2008  Jill Habasque CAR 160523
.           Changed CDATE000 to allow up to 365 days
. V9.09.14  23/01/2008  Mike Laming   CAR 156741
.           Added Visit Extension (using PMSVX1TM) for Report 03 Bed Status
.           Added Visit Extension to Report 04 Bed Transfers
. V9.09.13  16/01/2008  Jill Habasque CAR 159151
.           When undischarging, only remove return record if 1s before discharge
. V9.09.12  17/12/2007  Peter Vela    CAR 157569
.           Added remote script to check for closed beds for Day Oncology
.           booking screen
. V9.09.11  21/11/2007  Peter Vela    CAR 132264
.           New variables for Write and Update to patchcof
. V9.09.10  21/11/2007  Jill Habasque CAR 149776
.           Added extra checks for CHGDOC
. V9.09.09  14/11/2007  Peter Vela     CAR 151199
.           Added new Emergency Cancellation status
. V9.09.08  02/11/2007  Ebon Clements  CAR 151800
.           Added retain previous ED location functionality
. V9.09.07  31/10/2007  Peter Vela    CAR 151949
.           Add Morgue Management functionality
. V9.09.06  18/10/2007  Peter Vela    CAR 148954
.           Add Bed Management Details Update on Cancel Movement
. V9.09.05  27/09/2007  Jill Habasque CAR 150934
.           Added care type P validations in CTSM0000
.           11/09/2007  Peter Vela    CAR 148954
.           Added Bed Management remote script validation
.           Added Bed Management Details update on discharge
.           Added Bed Management Details update on transfer
.           Added Bed Management Details update on supervisor
.           Added Bed Management Admission Link to Bed Request
. V9.09.04  05/09/2007  Ebon Clements CAR 95394
.           Added overseas/ineligible to CHKF0000
.           10/08/2007  Steve Armstrong  CAR 145650
.           Added call to DGCLICAC when visit is updated to no longer be
.           an ACC (patwc1af) claim.
.           04/09/2007  J.Tan         CAR 148353
.           Recompiled for PATCMSTP
. V9.09.03  20/07/2007 Sandra Barcham  CAR 145726
.           For PRS2 allow Care Type P AT CTSM0000
. V9.09.02  18/06/2007  J.Tan          CAR 143128
.           Recompiled for AUTOATYP - Using the suggested classification file
. V9.09.01  13/06/2007  Mike Laming   CAR 119158
.           Changes to fix RDMCHG1 for Misc.Charges Effective Date
.----------------------------------------------------------------------
. V9.08.13  15/05/2007  Jill Habasque CAR 137885
.           Added caretype P in CHKCAR00
. V9.08.12  08/05/2007  Mike Laming  CAR 137125 HDP 2007 DRG 5.2
.           Mods to PATDGWFD - Add field PTDWDRGV (add to Keys)
. V9.08.11  20/04/2007  Ebon Clements CAR 132858
.           Recompiled for PMSWORFD file change
. V9.08.10  19/02/2007 Peter Vela     CAR sjog-vic
.           Recompiled for WEBDINVS - St. John of God invoice layout
. V9.08.09  07/02/2007  Mike Laming       CAR 130245
.           Added code to PONC000, PAFC0000 & PDIC0000 to fix Tran Rate fields
. V9.08.08  02/02/2007 Peter Vela     CAR 124547
.           Added tag for PTCNDEES
. V9.08.07  25/01/2007  Peter Vela     CAR 127930
.           Updated MRMADTUP MRMATMUP MRMAUUID before UPMRMAS1
. V9.08.06  30/11/2006  Steve Armstrong   CAR 126162
.           Added CALL to PMIGTNID prior to CALL to DGCLICAC in ALLBD000.
. V9.08.05  27/11/2006  Jill Habasque CAR 125688
.           Mods to allow B for separation type in CTSM0000
. V9.08.04  27/11/2006  Ebon Clements CAR 126035
.           Added delete of working diagnosis on unadmit
. V9.08.03  14/11/2006  Peter Vela    CAR 124547
.           Added reads for PTCNDEES PTCNDDES
.           Added functionality for PRFA of deceased patients
. V9.08.02  08/11/2006  Jill Habasque CAR 122547
.           Mods to call BOOK0000 in THET0000 if it is a medical booking
. V9.08.01  06/10/2006 J.Tan  CAR 119972
.           Mods CFEETYP=5 for NZ Private
.----------------------------------------------------------------------
. V9.07.06  19/09/2006  J.Tan         CAR 103365
.           Fixed JH recalculate bed fee after bed transfer
. V9.07.05  17/08/2006  J.Tan         CAR 103365
.           Mods Johns Hopkins cfeetyp to recalc.bed fee after return from leave
. V9.07.04  08/08/2006  Jill Habasque     CAR 103377
.           Added call to CLRDIS00 for patients not discharged in UPDS0000
. V9.07.03  13/07/2006  Mike Laming       CAR 111521
.           Change all Bed Fee & Theatre Fee work areas to FORM 8.2
. V9.07.02  12/07/2006  J.Tan         CAR 112128
.           Fixed parameter for the old MH legal status
. V9.07.01  11/07/2006  J.Tan         CAR 112128
.           Added parameter for the old MH legal status
.----------------------------------------------------------------------
. V9.06.02  23/05/2006  J.Tan         CAR 90040
.           Discharging MH must have legal status record
. V9.06.01  11/05/2006  J.Tan         CAR 91327
.           Added Discharge status to patunaaf file
.----------------------------------------------------------------------
. V9.05.04  11/04/2006  Mike Laming   CAR 101144
.           Added routine to delete "patchcof" records on Unadmit at CLADM050
. V9.05.03  03/04/2006  Ebon Clements CAR 78527
.           Added hospital to current patients
. V9.05.02  10/03/2006  J.Tan   CAR
.           Mods DATSEL00 to display 250 records instead of 150
. V9.05.01  09/03/2006  Ebon Clements CAR 78533
.           Mods for PATCODTM - Hospital specific category codes
. V9.05.B06 31/01/2006  Peter Vela    CAR 54614
.           Recompiled for PMSQVIFD
.           Added reads to patre1af before call to broadcast subroutines
. V9.05.B05 30/01/2006  Ebon Clements CAR 93186
.           Mods for REDIRECT length change. Recompiled for IBAWEBDF
. V9.05.B04 18/01/2006  Steve Armstrong    CAR 92051
.           Mods to read PMI record prior to sending CCT message in CHMTR000
.           05/01/2006  J.Tan              CAR 84567
.           Mods discharging not to reset pttrepsd for non-casepayment
. V9.05.B03 22/12/2005 Ebon Clements CAR 76341
.           Added write of attending HCP to care team details table
.           when changing doctor
.           14/12/2005  J.Tan         CAR 88861
.           Mods to allow changing discharge time without checking if invoiced.
.           12/12/2005  Steve Armstrong    CAR 88438
.           Fixed A21 & A22 message to read PMI details before sending message
. V9.05.B02 05/12/2005  Peter Vela         CAR 84255
.           Replace +'s with spaces at UPDF0000
.----------------------------------------------------------------------
. V9.04.43  06/12/2005  Davin S       CAR 87531
.           Move visit broadcast message (dgclicac) to end of routine when
.           updating doctor/specialty (padc0000)
. V9.04.42  01/12/2005  J.Tan         CAR 84059
.           Added parameter for discharge/chg disc.date after invoiced
. V9.04.41  29/11/2005  Ebon Clements CAR 86062
.           Set manually added record to no for esis episode file
. V9.04.40  24/11/2005  Ebon Clements CAR 65858
.           Added test for MRCNLINK - Using medical record linked visits
.           in MVMED000
. V9.04.39  24/11/2005  Davin S       CAR 83419
.           Recompiled for dgclicac - write most recent tran record to pmsqviaf
.           Recompiled for dgclicdc - write "D" tran record to pmsqviaf
. V9.04.38  22/11/2005  J.Tan         CAR 84059
.           Allows to un-discharge invoiced patients
. V9.04.37  21/11/2005  Peter Vela    CAR 68675
.           Recompiled for PATDSCTM
. V9.04.36  21/11/2005  Ebon Clements CAR 80002
.           Added update of wattr1af after move of 20 to WTWMBSCD - THET3000
. V9.04.35  04/11/2005  Jill Habasque CAR 71366
.           Added call to SAVHIS00 in WLNBR000
. V9.04.34  25/10/2005  Sandra Barcham    78611
.           Replaced spaces with zero in linkdat before write of wrlink
. V9.04.33  24/10/2005  Ebon Clements CAR 80679
.           Changed UPDEM000 to ensure it selects the correct
.           linked emergency visit
. V9.04.32  20/10/2005  Davin         CAR 80689
.           Changed allbd000 to read patma1 & pmspx2 before sending CAC message
. V9.04.31  13/10/2005  J.Tan         CAR 77165
.           Mods to allow private template patweb9603014 to change doctor/unit
.           for discharged patient
. V9.04.30  29/09/2005  Davin         CAR 78165
.           Changed to read pmspx2 after reading master file (insur000)
. V9.04.29  29/09/2005  Davin         CAR 78165
.           Changed to read last transfer record before sending CAC message
. V9.04.28  26/09/2005  Ebon Clements CAR 56868
.           Recompiled for web user id in DEATHPOL
. V9.04.27  22/09/2005  J.Tan              CAR 66934
.           Mods not allow to Undischarge if invoice printed
. V9.04.26  12/09/2005  Ebon Clements      CAR 61061
.           Added PTCNCOMF - Using compensable details patient folders
. V9.04.25  19/08/2005  Ebon Clements    CAR 71182
.           Added save of operator in onleave transfer file records - WRLBT000
.           11/08/2005  Peter Vela       CAR 67306
.           Added functionality for PTTRLTSC - Leave Transfer Source
.           02/08/2005  Jill Habasque    CAR 69287
.           Fixed update of WL when unadmitting
.           02/08/2005  Davin         CAR 64087
.           Mods for PAS/CIS and proprietary interface changes
.           31/08/2005  J.Tan         CAR 74153
.           Recompiled for CMXMATRX - checking for exclusive
. V9.04.24  18/08/2005  Jill Habasque    CAR 62516
.           Fixed MH redirect
. V9.04.23  12/07/2005  Jill Habasque    CAR 62516
.           Added check for WAITFLAG after calling THET0000
. V9.04.22  06/07/2005  Jill Habasque    CAR        66218
.           Added check for CFEETYP in GETBF000
. V9.04.21  04/07/2005  Jill Habasque    CAR 62516
.           Mods to call THET0000 when unadmitting and undischarging
. V9.04.20  28/06/2005  Jill Habasque    CAR 63400
.           Changed wording of Invalid HIH transfer message
. V9.04.19  30/05/2005  Peter Vela       CAR 60167
.           July 2005 Stat Changes - Modifications to Separation Mode
.           validations
. V9.04.18  29/04/2005  Peter Vela       CAR 55214
.           Recompiled for MRTCONFD
. V9.04.17  21/03/2005  Steve Armstrong   CAR 59812
.           Mods for on-leave, return from leave, & transfer broadcast
.           messages.
. V9.04.16  07/03/2005  Peter Vela         CAR 57547
.           Recompiled for PATVADFD and PATVADIO
.           07/03/2005  Steve Armstrong    CAR 59137
.           Recompiled for changes to CISINADT, HL7CISIN & HL7CISVR
.           07/03/2005  J. Habasque              CAR 56347
.           Fixed delete of return from leave records
. V9.04.15  16/02/2005  J.Tan                    CAR 54754
.           Recompiled for AUTOATYP - updating trans records with new sugg.class
. V9.04.14  17/01/2005  Henry Son                CAR 55106
.           Patient Adjustment Issue. Initialise ADMREC in CLRPAR.
. V9.04.13  13/01/2005  J.Tan  CAR 56548
.           Mods unlocking admission file in CNLBT00 routine
. V9.04.12  11/01/2005  Jill Habasque CAR 55694
.           Fixed CHKHIH00 to return an error
. V9.04.11  17/12/2004  Jill Habasque CAR 55971
.           Recompiled for PATDYCAS - added open of pataudm
. V9.04.10  20/12/2004  Lina Vo       CAR 55660
.           Removed CRED0000 from CLADM000. Credit All function deducts 1
.           from AINVPRT. If all invoices has been credited then AINVPRT should
.           be 0.
.           09/12/2004  Jill Habasque CAR 54731
.           Added write to wateseaf
. V9.04.09  29/11/2004  Mike Laming   CAR 54534
.           Re-comple for PATCMSTP - fix Addit.Charge Description
. V9.04.08  19/11/2004  Jill Habasque CAR 54597
.           Added functionality to change to MH if transferred to MH Ward
. V9.04.07  11/10/2004  Peter Vela    CAR 53371
.           Added functionality to update PMVXPALC - Palliative Care Status
.           Added functionality to update PMVXPYSP - Payment Status on Sep
.           Added functionality to update PMVXFINP - Fincancial Program
. V9.04.06  20/10/2004  J.Tan   CAR 54465
.           Allowed changing admission type for discharged patients
. V9.04.05  20/10/2004  J.Tan   CAR 54465
.           Allowed changing admission type after invoice, if chg date < alacdte
. V9.04.04  20/10/2004  Ebon Clements CAR 54085
.           Changed UPDEM000 to update the emergency discharge date and time
.           if the discharge is from a EMG ward/bed type
. V9.04.03  05/10/2004  J.Tan   CAR 53798
.           Mods default charging claim code for multi hospital
. V9.04.02  27/09/2004  Ebon Clements            CAR 53266
.           Multi hospital changes for ADDVIS00 - does not get used
. V9.04.01  26/08/2004  Jill Habasque CAR 52930
.           Added CHKHOS00 to validate ward is in same hospital on transfer
.           25/08/2004  Ebon Clements CAR 52976
.           Changed UPDEM000 to update the emergency discharge date and time
.           if the bed transfer is to an EOU bed
.----------------------------------------------------------------------
. V9.03.40  22/07/2004  Ebon Clements CAR 51760
.           Changed UPDEM000 to use the transfer date and time not the
.           current date and time for the emergency discharge
.           21/07/2004  Peter Vela   CAR 51246
.           - Added tag for PTCNHDPS in report no 3.
. V9.03.39  14/07/2004  Guomin Fu    CAR 48096
.           - Added read PTCNCHSD and write tag
.           - Added checking on hidden variable CTADMVAR passed in from
.             patweb9603012 to decide whether to update Transfer Admission
.             Recordi when updating Specialty(CMBS class).
.           12/07/2004  Jill Habasque CAR 51060
.           Changed to use PTCNDTRF, added label for CLAMD085
. V9.03.38  30/06/2004  Peter Vela   CAR 51259
.           - Fixed edit for Carer Availablity (CHKCAR00)
. V9.03.37  28/06/2004  Steve Armstrong      CAR 51167
.           Recompiled for changes to HL7CISIN
. V9.03.36  22/06/2004  Peter Vela   CAR 49016
.           - Added edit for Care Type and Separation Referral (CTSF0000)
.           23/06/2004 J.Tan  CAR 42846
.           Mods for manual stepdown
. V9.03.35  21/06/2004  Peter Vela   CAR 49016
.           - Updated edit for Care Type and Separation Mode (CTSM0000)
.           18/06/2004  Mike Laming  CAR 49016 2004 PRS/2
.           - Change CARETYPE to 2 chars & alter edits
. V9.03.34  18/06/2004 J.Tan  CAR 49644
.           Fixed I*C on pathlfaf file
. V9.03.33  07/06/2004 Peter Vela CAR 49016
.           2004 Statutory Changes - recompiled for PMSPX2TM
.           24/05/2004  J.Tan   CAR 42846
.           Reset manual stepdown field (pttrepsd) to zero, when matrix found
.           26/03/2004  Steve Armstrong   PAS-CIS Product Integration
.           Added calls to CISAxxBR routines and included relevant variables
.           for PAS-CIS Interface  CAR   49679
.           Also fixed I*C on WATHISA1 in DELNBR00.
.           03/05/2004  J.Tan  CAR 42846
.           Mods redirect Return function to Bed fee screen
.           28/04/2004  Jill Habasque CAR 49148
.           Added write of delete record to wathisaf when undischarging
. V9.03.32  07/06/2004 J.Tan  CAR 50399
.           Fixed auto update admision type for day surgery patient
. V9.03.31  04/06/2004 J.Tan    CAR 50321
.           Fixed updating theatre fees when changing claim code
. V9.03.30  12/05/2004 J.Tan  CAR 49653
.           Allowed changing MBS Class for discharged patient with no invoice
. V9.03.29  14/04/2004 J.Tan  CAR 48822
.           Fixed updating health fund
. V9.03.28  06/04/2004 Sylvek Litewka CAR 48338
.           Added procedure CHK5DW00 to check for 5 Day Ward during Admission.
.           Added procedure CHKCBD00 to check for Closed Beds when Swapping Beds
. V9.03.27  26/03/2004  Ebon Clements  CAR 18703
.           Added transfer source validation
. V9.03.26  27/02/2004  Jill Habasque CAR 43132
.           Added use of MRCNAMTR - move medical record on bed transfer
.           16/02/2004 Guomin Fu     CAR 47390
.           Removed Updating Attending Doc in BTRAN0000
.           02/02/2004 Davin         CAR 22654
.           Write to patpeiaf when upd.discharge details & cancel movement
.           Write 'delete' to patpeiaf when unadmitting
. V9.03.25  28/01/2004 Jill Habasque CAR 46876
.           Added error "Previous movement at this time"
. V9.03.24  23/01/2004 Ebon Clements CAR 38490 and 46979
.           Recompiled for MRTVISCD - Auto create medical records
. V9.03.23  16/01/2004 Peter Vela      CAR 46325
.           Added error message when trying to transfer to a closed bed without
.           searching
. V9.03.22  18/12/2003 Peter Vela      CAR 43134
.           Recompiled for MRTCONFD
. V9.03.21  15/12/2003 Ebon Clements   CAR 45481
.           Mods for PMSCURFD file change - added outpatient site
. V9.03.20  01/12/2003 J.Tan  CAR 44161
.           Mods for credit notes
. V9.03.19  10/11/2003 Peter Vela CAR 44288
.           Added mods to only update tran records that are on or after tran
.           date and time when changing Doctor/Unit and Specialty
. V9.03.18  12/11/2003  Steve Armstrong   CAR 44952
.           Add call to DGCLICAC in INSUR000
. V9.03.17  21/10/2003 J.Tan   CAR 44172
.           Mods for Misc.theatre item file
. V9.03.16  20/10/2003 Peter Vela      CAR 23608
.           Added Update to Current Patient Search file (pmscuraf) in discharge
.           of patient.
. V9.03.15  06/10/2003 Sylvek Litewka  CAR 43834
.           Modified CHKBED00 to reset WARNINGF variable to ZERO in all cases.
. V9.03.14  02/10/2003 Sylvek Litewka  CAR 43834
.           Modified CHKBED00 to populate STAYDAYS with default value of 1.
. V9.03.13  30/09/2003  J.Tan        CAR 36507
.           Set pttrepsd to zero when writting to pattranf(changing adm.type)
. V9.03.12  29/09/2003  Davin        CAR 41728
.           Send CAC (change admission) message when allocating patient a bed
. V9.03.11  16/09/2003 Sylvek Litewka  CAR 41826
.           Modified CHKBED00 to check for Closed beds and Five Day Wards.
. V9.03.10  11/09/2003 Lina Vo       CAR 40497
.           Changed GMSC000 to read patmchgf with new index - new effective
.           date field.
. V9.03.09  29/08/2003 Peter Vela    CAR 42820
.           Added Rural Patient Initiatives and ESAS to Funding Arrangement
.           26/08/2003  Guomin Fu     CAR 41632
.           Added updating patpeiaf when care type is changed(PRS2)
.           Added updating patpeiaf when discharge destination is changed(PRS2)
. V9.03.08  11/09/2003  Sandra Barcham    43010
.           Recompiled
. V9.03.07  15/08/2003  Jill Habasque CAR 42395
.           Removed update of patnumwf
. V9.03.06  11/08/2003  Jill Habasque CAR 41815
.           Added update of oprdetaf status when discharging
. V9.03.05  26/06/2003  Jill Habasque CAR 39268
.           Removed closes of patyear1
. V9.03.04  30/05/2003 Jill Habasque SRF 38102
.           Added new PRS validation CTSM0000
. V9.03.03  28/05/2003 Davin                     CAR 38714
.           Added broadcast of medical record movements (DGCLICRM)
.           22/05/2003 Ebon Clements CAR 38102
.           Added new cgi agecaras for aged care assessment service
. V9.03.02  15/05/2003 J.Tan  SRF 39078
.           Mods to delete claim details when claim changed to non-compensable
. V9.03.01  09/05/2003 J.Tan  SRF 37318
.           Mods to write to pending (if necessary) when changing claim code
.----------------------------------------------------------------------
. V9.02.117 05/05/2003 J.Tan
.           Mods unadmit to removed claim details
. V9.02.116 02/05/2003 Jill Habasque SRF 35150
.           Added write to patpeiaf
. V9.02.115 14/04/2003 Jill Habasque SRF 37587
.           Commented out delete of patdadaf record when unadmitting
. V9.02.114 19/03/2003 Ebon Clements SRF 37270
.           Added UPFOLD00 to update patient folder details
. V9.02.113 11/03/2003 J.Tan
.           Recompiled for PATMISTM - admitting point
.           13/03/2003 Jill Habasque SRF 21870
.           Added update of patmi1af when deleting care type
. V9.02.112 04/03/2003 Jill Habasque SRF 36990
.           Added check for caretype in CHKCAR00
. V9.02.111 21/02/2003 Jill Habasque SRF 34660
.           Added WTCNBRSR
.           07/02/2003 Tonii CAR 35992
.           Recompiled for PATMISTM - inactive codes in patfundf
. V9.02.110 29/01/2003  S. Barcham    SRF 35840
.           Fixed I * C on patitemn file
.           30/01/2003  Lina Vo       SRF 22693
.           Added read PTCNUEOC and write tag
. V9.02.109 28/01/2003  Ebon Clements SRF 21870
.           Added routine CCART000 to delete care type change records
.           27/01/2003  Ebon Clements SRF 34348
.           Added routine CHKCAR00 for carer available PRS2 edits
. V9.02.108 15/01/2003  Jill Habasque SRF 35181
.           Added output of MHCNKLER
.           Fixed call to DGCLICPR
. V9.02.107 16/12/2002  Jill Habasque
.           Changed WRLBT000 to call DGCLICPO instead of DGCLICTR
. V9.02.106 12/12/2002  Jill Habasque SRF 33874
.           Fixed update of discharge details for MH patients
. V9.02.105 29/11/2002  Jill Habasque SRF 33938
.           Changed to call CODITM00 instead of CODSEL00 in admt0600
. V9.02.104 09/11/2002  Ebon Clements SRF 23307
.           Clear file variables before the write to patlocaf
.           09/11/2002  Jill Habasque SRF 22730
.           Added update of MH visit record when putting on leave and returning
. V9.02.103 01/11/2002  Peter Vela    SRF 22829
.           Added funcionality for Contract Type, Role and Spoke Id for QLD
.           HDP Extract (patweb9603011.html)
.           28/10/2002  Peter Vela    SRF 22731
.           Added functionality for Mental Health Discharge
.           15/10/2002  Jill Habasque SRF 23255
.           Added output of discharge date
.           28/10/2002 J.Tan
.           Added checking for specialty bed (SPBD0000)
. V9.02.102 09/10/2002  Peter Vela     SRF 17693
.           Recompiled for PATMISTM - Admitting Point
. V9.02.101 03/10/2002  Peter Vela     SRF 17693
.           Recompiled for PATVISTM - Admitting Point
. V9.02.100 24/9/2002   Jill Habasque  SRF 20328
.           Fixed loop in CHGAD000 when recalculating length of stay
.           Changed date selection list to display 180 days
. V9.02.99  19/9/2002   Pat Dirito               SRF 22306
.           Added call DSBED000(Recalulate ICU hrs) on Cancel Dicharge and
.           deletion Transfer/Movement.
. V9.02.98  16/09/2002  Jill Habasque SRF 22026
.           Added read of discharge file when changing care type
.           Added UNEMR000 routine if unadmitting an emergency visit SRF 22211
. V9.02.97  04/09/2002  Jill Habasque SRF 17573
.           Changed to use RTIODAYS when calculating PTDSDLOS
. V9.02.96  27/8/2002   Pat Dirito               SRF 19123
.           Now recalculating ICU hrs(DSBED000) when update admission dates and
.           discharge on supervisor screen updates.
.           22/08/2002  J.Tan
.           Recompiled for PATDSBFE
. V9.02.95  07/08/2002  Ebon Clements SRF 20495
.           Fixed seconds in TDET0000 when a patient is discharged when on leave
. V9.02.94  05/08/2002  Ebon Clements SRF 20217
.           Pack keys for the transfer file with SP70
. V9.02.93  30/07/2002  Bronko Sosic SRF 20219
.           Changed tranfer of EMR patinet if patient is being transfered to
.           another EMR unit it stayes on the MAP
. V9.02.92  23/07/2002  J.Tan   SRF 18497
.           Recompiled for PATMISTM - added patasfaf file
. V9.02.91  11/07/2002  Ebon Clements SRF 17676
.           Recompiled for WLHISSUB - write to w/list history
. V9.02.90  06/07/2002  Jill Habasque SRF 19273
.           Recompiled for pmscuraf
. V9.02.89  29/06/2002  Ebon Clements SRF 19105
.           Recompiled for a sigpipe trap
. V9.02.88  25/06/2002  Tonii SVHM Transition II Extract 7
.           Changed format of read and write of cciex7af (****)
. V9.02.87  26/06/2002  Jill Habasque SRF 18925
.           Fixed CHKDIS00 to only update discharge and on leave
. V9.02.86  18/06/2002  Jill Habasque
.           Removed branch after PATGNCMX in RECALC00
. V9.02.85  17/06/2002  J.Tan  SRF 18683
.           Commented out writting to pataudt
. V9.02.84  06/06/2002  J.Tan
.           Removed checking for hospital type (chostyp)
. V9.02.83  04/06/2002  Jill Habasque  SRF 17644
.           Fixed changing of A records to C records when changing doctor
.           at the admission date and time
. V9.02.82  03/06/2002  Jill Habasque SRF 18229
.           Added trap if sigpipe
. V9.02.81  27/05/2002  Jill Habasque SRF 17888
.           Fixed loop in period date range not setup
. V9.02.80  23/05/2002  Jill Habasque SRF 17400 17561
.           Mods for changing details after a patient is discharged
. V9.02.79  14/05/2002  J.Tan
.           Recompiled for PATMISTM - added casemix code
.           14/05/2002  Steve Armstrong  srf 17592
.           Mods to send type "11" message to the Detente interface
.           for all patients, not just booked patients.
. V9.02.78  08/05/2002  Jill Habasque  SRF 17377
.           Added check of updatety before calling CHKBTR00
. V9.02.77  02/05/2002  Jill Habasque  3609
.           Added delete of pmscuraf record when unadmitting a patient
. V9.02.76  30/04/2002  Pat Dirito
.           Recompiled for WBMVMREC
. V9.02.75  26/04/2002  J.Habasque
.           Added check for cancelled booking in BOOK0000
. V9.02.74  24/04/2002  J.Tan
.           Fixed hf and patient bed fees portion to correct fields (RECALC00)
. V9.02.73  21/04/2002  Jill Habasque 3499
.           Added CHKDIS00 to change discharge on onleave ward/bed records
. V9.02.72  19/04/2002  Jill Habasque
.           Added if equal in CHKBTR00 to fix I*D
. V9.02.71  17/04/2002  Jill Habasque  3566
.           Changed CHAD0000 to be a remote script to warn that dates may
.           overlap
. V9.02.70  05/04/2002  Ebon Clements
.           Changed branch in LNKUR300 to go to LNKUR999 not MAIN1000
. V9.02.69  27/03/2002  Jill Habasque
.           Added read of patvisaf and pmsvx1af in UPDF0000
. V9.02.68  21/03/2002  Jill Habasque
.           Removed call to CHKDDT00 in UPDF0000
. V9.02.67  08/03/2002  Jill Habasque 3371 & 3379
.           Commented out checks for current admissions and on leave patients
.           in CHKDDT00
.           Added 3 as valid for "Not applicable" in CHKINT00
. V9.02.66  06/03/2002  Tonii  St V's Transition II
.           Added write to the new Extract 7 table (cciex7af)
.           Program will only write to cciex7af if:
.           - a patient is discharged
.           - visit details corresponding to the extract 7 fields are changed
. V9.02.65  07/02/2002  J.Tan
.           Added warning if claim code changed from international to public
.           and resident status is still set to non-resident.
. V9.02.64  28/02/2002  Jill Habasque
.           Fixed UPDEM000 - emergency transfer/discharge
. V9.02.63  26/02/2002  Jill Habasque   Defect 3292
.           Mods to clear AWARD and ABED if undischarging a patient that will
.           be placed on standby
. V9.02.62  24/02/2002  Ashwin
.           Modify transfer and discharge for emergency patient
. V9.02.61  21/02/2002  Jill Habasque
.           Removed close of wattr1af
. V9.02.60  19/02/2002  Jill Habasque
.           Added open of pattfeef
. V9.02.59  15/02/2002  Jill Habasque
.           Added output of adate
. V9.02.58  13/02/2002  Jill Habasque
.           Added RANOBE1 before calling WRNOBE1
. V9.02.57  13/02/2002  Jill Habasque
.           Changed CHKDDT00 to check discharge date
. V9.02.56  12/02/2002  Davin
.           Recompiled for dgcliadm - don't send CCA if no transfer record
. V9.02.55  10/02/2002  Jill Habasque
.           Changed to pack key8 with admissno in CHGADM50
. V9.02.54  10/02/2002  B.G.Ackland
.           Re Read Admission Number for Change of Admission Date
. V9.02.53  08/02/2002  Pat Dirito
.           Recompiled for MRTVISCD
. V9.02.52  05/02/2002  Jill Habasque
.           Added claim form signed for RCH and MVMED000
. V9.02.51  02/02/2002  Ebon Clements
.           Recompiled for WLHISSUB - WATHI002 cgi effective date set
. V9.02.50  31/01/2002  Jill Habasque
.           Added read of patmi1af,patma1af and pmspx2af in UPDF0000
. V9.02.49  24/01/2002  Ebon Clements
.           Recompiled for WLHISSUB - effective date set
. V9.02.48  23/01/2002  J.Tan
.           Mods to recalculate fees after changing Claim and MBS
. V9.02.47  19/01/2002  Jill Habasque
.           Fixed change of unit when cancelling last movement
. V9.02.46  18/01/2002  Tonii  SRF 13881 & 14184
.           Recompiled for MOVMDREC and MRTMASDS
. V9.02.45  18/01/2002  J.Tan
.           Fixed changing discharged date to recalculat rates
. V9.02.44  17/01/2002  Jill Habasque
.           Recompiled for PATDYCAS
. V9.02.43  11/01/2002  Ebon Clements
.           Recompiled for changes to MRTPDSFD
. V9.02.42  10/01/2002  Ebon Clements
.           Default the post discharge status MRPDSTAT to MRCNPDST when
.           a patient is discharged
. V9.02.41  08/01/2002  Jill Habasque
.           Mods to check for transfers to MH or FC wards and HIH wards
. V9.02.40  07/01/2002  Jill Habasque
.           Mods to check patient is admitted
. V9.02.39  03/01/2002  J.Tan
.           Mods BRATE (generate charges) to use adm.type from trans file
. V9.02.38  20/12/2001  J.Tan
.           Mods to recalculate charged on return from leave
. V9.02.37  19/12/2001  Jill Habasque
.           Added PREDIR00
. V9.02.36  08/12/2001  Jill Habasque
.           Added warning for placing a patient on standby
. V9.02.35  07/12/2001  Tonii
.           Recompiled for PATDYCAS - Casemix changes
. V9.02.34  06/12/2001 J.Habsque
.           Fixed on leave error message
. V9.02.33  03/12/2001 J.Tan
.           Recompiled for PATDYCAS - recalculating theatre fees
. V9.02.32  30/11/2001  Pat Dirito
.           Now rounding up ICU, CCU & NCU hrs in CBEDT000
. V9.02.31  29/11/2001  Greg Horvat      SRF 11738
.           Recompiled for MOVMDREC - Changed to use UPMRMAS2 in WRIT0000
. V9.02.30  28/11/2001  Jill Habasque
.           Mods not to close pending file
. V9.02.29  27/11/2001  Jill Habasque
.           Fixed delete movement if it is the last transfer record
. V9.02.28  26/11/2001  Jill Habasque
.           Added check for on leave beds
. V9.02.27  20/11/2001  Jill Habasque
.           Fixed bed transfer for ward only + ward bed
. V9.02.26  17/11/2001  Jill Habasque
.           Added default of discharge date and time for on leave patients
. V9.02.25  12/11/2001  Jill Habasque
.           Mods to put a patient on standby when undischarging if bed
.           has been taken
. V9.02.24  10/11/2001  Jill Habasque
.           Added move three to option for unadmit option
. V9.02.23  09/11/2001  Steve Armstrong
.           Moved call to UPDOLV00 to be before WRLBT000 so that
.           OERDATE will be set for DGCLICTR message
. V9.02.22  07/11/2001  J Habasque
.           Fixed update of doctor/unit
.           08/11/2001  Mike Laming
.           Rename dgcliupm TO dgclicup
.           Rename dgclicna TO dgclicca
.           Rename dgclicad TO dgclicac
.           Rename dgclicnd TO dgcliccd
.           Rename dgclicds TO dgclicdc
.           Rename dgclidsc TO dgclicds
.           Rename dgclicnt TO dgclicct
.           Rename dgclitrn TO dgclictr
. V9.02.21  05/11/2001  J Habasque
.           Added CHKINT00 to validate intention to readmit
. V9.02.20  03/11/2001  J Habasque
.           Added CHKSEP00 to validate separation referral
. V9.02.19  30/10/2001  J Habasque
.           Fixed saving of Unit when bed transfer is performed
. V9.02.18  25/10/2001  J.Tan
.           Check Claim code if MBS amount is used for charging MBS item
.           Removed episode flag for casemix funding (not used anymore)
. V9.02.17  24/10/2001  Steve Downing  SRF 12218
.           Recompiled for MRTMASDS
. V9.02.16  23/10/2001 Steve Armstrong
.           Replaced and fixed read of controlf prior to calling DGCLICPR
. V9.02.15  19/10/2001 Jill Habasque
.           Removed read of controlf before DGCLICPR
. V9.02.14  15/10/2001 Jill Habasque
.           Fixed update of pmspx2af
. V9.02.13  10/10/2001 B.G.Ackland
.           Read Parameter for Adm Maintenance Audit CAUDA
. V9.02.12  09/10/2001 J.Tan
.           Unlock admission after error message in cancel admission (CLADM000)
. V9.02.11  05/10/2001 Sai-HPS,SRF 12430
.           Changed INIT0200,replacing mehaudvi with mehauvi1
. V9.02.10  03.10.2001 Jill Habasque
.           Fixed so that deceased status does not revert to 0
. V9.02.09  26.09.2001 Jill Habasque
.           Mods for patient status adjustment
. V9.02.08  22.09.2001 Tonii  SRF 13075
.           Recompiled for PATDINVS
. V9.02.07  13.09.2001 J.Tan
.           Fixed inactive transfer source codes from displaying
. V9.02.06  12.09.2001 J.Tan
.           Fixed calculating hrs of ICU/CCU
. V9.02.05  11.09.2001 Jill Habasque
.           Changed unadmit error message
.           Mods to calculate ICU/CCU when discharging
. V9.02.04  06.09.2001 Jill Habasque
.           Fixed saving of the pmsvx1af fields (changed RDPMVX11 to RAPMVX11)
. V9.02.03  30.08.2001 Ashwin - HPS
.           Opened the audit file for MEH
. V9.02.02  23.08.2001 J.Tan
.           Mods to update hrs of ICU and CCU
. V9.02.01  21.08.2001 Ebon Clements
.           Changed undischarge to use DDEST not DSTAT to reverse PCEASE
.           Recompiled for PATWRDTM
.----------------------------------------------------------------------
. V9.01.01  16.08.2001 Mike Laming
.           Add Datagate routines for new transactions DGCLICPO Put Patient
.           On-leave & DGCLICPR Patient Return from Leave.
.----------------------------------------------------------------------
. V9.00.02  14.08.2001 J.Tan
.           Recompiled for PATMASTM
. V9.00.01  10.08.2001 J.Tan
.           Fixed I*A on visit extension file
. V9.00.B08 13.07.2001 Sandra Barcham
.           Replace GP with HCP
. V9.00.B07 22.06.2001  Ebon Clements
.           Work on cancel bed transfers
. V9.00.B04 07.06.2001  Ebon Clements
.           Fix unlock of admission after cancelled admission
. V9.00.B03 06.06.2001  Ebon Clements
.           When checking overlaps with discharge dates ignore
.           pre admissions and cancelled admissions
. V9.00.B02 14.05.2001  Manish Sharma -HPS Bangalore
.           Add Cancel Movement Transfer
.           Update Doctor/Specialty and Care Type
.           Change Cancel Discharge Routine
. V9.00.B01 09.05.2001  Ebon Clements
.           Added bed allocation to UPDBT000 for allocation
.           of a bed from the ward list. This code must
.**** ADD TO INDIA CODE **  be added to PATWEB96(INDIA VERSION WITH PAT)
. V5.10.B09 13.05.2001  Mukund Pande  -HPS Bangalore
.           File Write at CHDS0000
. V5.10.B08 07.05.2001  Pat Dirito
.           Added MEDRTYPE
. V5.10.B07 27.04.2001  Ebon Clements
.           Clear date of death on undischarge of a deceased
.           patient
. V5.10.B06 17.04.2001  Glenn Saunders
.           patsur is now decommissioned (replaced by patgsr)
. V5.10.B05 09.04.2001  Ebon Clements
.           Clear PTMAUKDD and PMPXDETY when discharge
.           indicators are updated
. V5.10.B04 22.03.2001  B.G.Ackland
.           Recompile for PATMISTM
. V5.10.B03 09/03/2001  Ebon Clements
.           Added date check so discharge dates can not
.           overlap another admission
. V5.10.B02 06/03/2001  Ebon Clements
.           Added time to the check that an admission
.           does not overlap a previous discharge date
. V5.10.B01 27/02/2001  Pat Dirito
.           Added functionality to check for Onleave Bed at
.           label UPDBT060
.----------------------------------------------------------------------
.                 V5.09.05 22/02/2001  Pat Dirito
.                          Added Update for Treating Doctor
.                 V5.09.04 09/01/2001  Bronko Sosic
.                          Recompiled for changes to MRTVISCD & added MRTCONFDde
.                 V5.09.04 09/01/2001  Bronko Sosic
.                          Recompiled for changes to MRTVISCD & added MRTCONFD
.                          & PATMASTM
.                 V5.09.03 04/01/2001  Jill Habasque
.                          Casemix Mods - recompiled for WEBDINVS
.                 V5.09.02 04/01/2001  Bronko Sosic
.                          Added include MRTVISCD to write a file to
.                          MRTVISFD when a visit is added
.                          29/12/2000  Pat Dirito
.                          Recompiled for changes to IBAWEBCD & WEBDINVS
.                          XX/XX/2000  Katie Nelson
.                          Added functions for cancel discharge/admit/etc
.                 V5.08.13 12/10/2000  Katie Nelson
.                          Added update of doctor/specialty for public
.                 V5.08.12 12/10/2000  Katie Nelson
.                          Added Read of controlf file variables
.                 V5.08.11 03/10/2000  Steve Downing
.                          Recompiled for dgclidsc & dgclitrn
.                 V5.08.10  16/08/2000  Caleb Sharman
.                          Changed Health Fund variables to be 8 chars
.                 V5.08.09 24/08/2000  Jill Habasque SRF 646985
.                          Recompiled for dgclitrn
.                 V5.08.08 22/08/2000  Jill Habasque
.                          added variables for patdetnt
.                 V5.08.07 08/08/2000  Steve Armstrong
.                          Recompiled for mods to BARCODEL for Sato CX-200
.                          printer
.                 V5.08.05 27.07.2000 Katie Nelson
.                          Recompiled for WLHISSUB
.                 V5.08.04 25.07.2000 Katie Nelson
.                          Changed the redirect routine
.                 V5.08.03 13.07.2000 Katie Nelson
.                          Fixed the functionality of Updating Doctor/Specialty
.                          Added a check on admission status when performing
.                          bed transfers/on-leave/return from leave etc
.                 V5.08.02 12.07.2000 Katie Nelson
.                          Added open for meh audit files if parameter set
.                 V5.08.01 27.06.2000 Katie Nelson
.                          Changed TRANTIME to include seconds.
.                          26.06.2000 Katie Nelson
.                          Added write to WATNBRFD if category A changed when
.                          updating specialty.
.                          09.06.2000 Katie Nelson
.                          Added a check if audit file needs opening.
.                          Finished adding update doctor/specialty from 5.07
.                          Also added update for Care Type when updating the
.                          Doctor/Specialty
.                 V5.08.00 07.06.2000 Katie Nelson
.                          Ported from 5.07
.----------------------------------------------------------------------
.                 V5.07.13 07.06.2000 Katie Nelson
.                          Fixed the format for how TRNSRETN was passed in.
.                          Added update doctor / specialty
.                 V5.07.13 10.04.2000 Nicole Harrington
.                          CSTRTYR Mods
.                 V5.07.12 16.03.2000 K.C Nelson
.                          Change call to open mehvisaf to OPMHVIS1
.                 V5.07.11 02.03.2000 K.C Nelson
.                          Changes to Cancel Last Bed Transfer for cancelling
.                          admission type/attending doctor changes
.                          23/02/2000  Greg Horvat      SRF 637565
.                          Recompiled for PATDYCAS -Changes for 4 character DRGs
.                          10.02.2000 K.C Nelson
.                          Re-Wrote UPDF0000 from IBAPAT34 V5.07.47
.                          Fixed code for putting patient on leave
.                          Added change of specialty when doing a transfer
.                          01.02.2000  K.C Nelson
.                          Changed MASF0000 to be field set 0. (at Taranaki)
.                          Recompiled for PATMASTM
.                 V5.07.10 28.01.2000  B.G.Ackland
.                          Recompile in Work
.                 V5.07.09 29/12/1999  B.G.Ackland
.                          Recompiled for IBAWEBDF/IBAWEBCD/PATMASTM
.                 V5.07.08 20/12/1999  Katie Nelson
.                          Recompiled for IBAWEBDF/IBAWEBCD/PATWRDTM
.                 V5.07.07 19/11/1999  Katie Nelson
.                          Fixed ward and LOS being written to discharge record
.                 V5.07.06 03/11/1999  Katie Nelson
.                          Recompiled for WEBDATCD/DAYOFWEK
.                 V5.07.05 22/10/1999  Katie Nelson
.                          Fixed discharging a patient that has a standby
.                          patient.
.                 V5.07.04 22/09/1999  Katie Nelson
.                          Added Next Page Routine
.                          23/08/1999  Katie Nelson
.                          Fix Date Options to Stop Continuous Loop
.                 V5.07.03 21/07/1999  Katie Nelson
.                          Add option to cancel last bed transfer
.                 V5.07.02 19/07/1999  Nicole Harrington
.                          Fixed problem with no bed ward patients -
.                          TRNTOBED passed as EOS insteasd of spaces
.                 V5.07.01 29.06.1999 Katie Nelson
.                          Port from 5.06 to 5.07
.                          Changed KEY28 to KEY30 for read on tran file
.                 V6.04.00 11.02.1998 B.G.Ackland
.                          Created Skeleton Server Program
.                 V6.04.00 3.04.1998 K.C.Nelson
.                          Changed skeleton to be Admis/Disch Transfer Server
.
.----------------------------------------------------------------------
          INC       IBAWEBDF
          INC       WEBDATDF
          INC       RSHWEBDF
.
          INC       MULTVISV/INC        * PATDPATH variables   
          INC       PATDPTHV/INC        * PATDPATH variables  
.
          INC       ACCAUDFD/INC            * New ACC Audit file
          INC       ACCDIAFD/INC
          INC       ALLCASFD/INC
          INC       ALLPCTFD/INC
          INC       APSMASFD/INC
          INC       BOKRC1FD/INC
          INC       CCICONFD/INC
          INC       CCIEX7FD/INC
          INC       DTTMADVR/INC
          INC       DEATHATD/INC
          INC       EMRVISFD/INC
          INC       EMRCONFD/INC
          INC       EMRCONTD/INC
          INC       EMRICDFD/INC        * AE Diagnos
          INC       IBALPCFD/INC
          INC       MEHCJAFD/INC
          INC       MEHCJRFD/INC
          INC       MEHDIAFD/INC
          INC       MEHDIATD/INC
          INC       MEHHLSFD/INC
          INC       MEHDLSFD/INC
          INC       MEHDL1FD/INC
          INC       MEHDS1FD/INC
          INC       MEHDISTD/INC
          INC       MEHLEGFD/INC
          INC       MEHLERFD/INC
          INC       MEHREVFD/INC
          INC       MEHCONFD/INC
          INC       MEHVISTD/INC            * MH visit file
          INC       MEHVI1FD/INC            * MH visit file
          INC       MLTHCPFD/INC
          INC       MRTCONFD/INC
          INC       MRTHISFD/INC
          INC       MRTLOCFD/INC
          INC       MRTMASFD/INC
          INC       MRTMOVFD/INC
          INC       MRTPDSFD/INC
          INC       MRTVISFD/INC
          INC       NHIETHFD/INC
          INC       NHIMASFD/INC
          INC       OUTCLIFD/INC
          INC       OUTSITFD/INC
          INC       OUTPHOFD/INC
          INC       OUTPREFD/INC
          INC       OPRDEAFD/INC
          INC       OPRSRGFD/INC
          INC       OPRARDFD/INC
          INC       PATAA1FD/INC
          INC       PATACHFD/INC
          INC       PATADBFD/INC
          INC       PATAFEFD/INC
          INC       PATONHFD/INC
          INC       PATALRFD/INC
          INC       PATASDFD/INC
          INC       PATASFFD/INC
          INC       PATAXEFD/INC
          INC       PATBFEFD/INC
          INC       NZPBFEFD/INC
          INC       PATBMDFD/INC
          INC       PMSBRQFD/INC
          INC       PATCFAFD/INC
          INC       PMSCAUFD/INC
          INC       PMSCIDFD/INC
          INC       BOKUNQFD/INC
          INC       PATBRNFD/INC
          INC       PATCALAG/INC
          INC       PATCHCFD/INC
          INC       PATCMCFD/INC
          INC       VISUCMFD/INC
          INC       VISMDTFD/INC
          INC       VISMTXFD/INC
          INC       PATCMXFD/INC
          INC       PATEORFD/INC
          INC       PMSCEXFD/INC
          INC       PATCMTFD/INC
.
          INC       OPRNURFD/INC
          INC       PMSCCDFD/INC   * Concession Card Details
          INC       PMSCMTFD/INC
          INC       PMSDAUFD/INC
          INC       PMSCNOFD/INC
          INC       PMSLRDFD/INC
          INC       PMSLRDTD/INC
          INC       PMSREGFD/INC
          INC       PMSRESFD/INC
          INC       PMSUCHFD/INC
          INC       PMSUCDFD/INC
          INC       PATMASTD/INC
          INC       PATCOMM/INC
          INC       OPRCONFD/INC
          INC       PATCONFD/INC
          INC       PMSCTCFD/INC
          INC       PATATRFD/INC
          INC       PATBRDFD/INC
          INC       PATCTFFD/INC
          INC       PATDADFD/INC
          INC       PATDAYFD/INC
          INC       PATDGWFD/INC
          INC       PATDO1FD/INC
          INC       PATDRGFD/INC
          INC       PATDSCFD/INC
          INC       PATDTHFD/INC
          INC       PATDTRFD/INC
          INC       PATECDFD/INC
          INC       PATECOFD/INC
          INC       PATFEEFD/INC
          INC       PATFIMFD/INC    
          INC       PATFIMTD/INC   
          INC       PATFN1FD/INC
          INC       PATFX1FD/INC
          INC       PATFHIFD/INC
          INC       PATGSRFD/INC
          INC       PATHDFFD/INC
          INC       PATHLFFD/INC
          INC       PATHOSFD/INC   
          INC       PATHSPFD/INC
          INC       PATICOFD/INC
          INC       PATICUFD/INC
          INC       PATINVFD/INC
          INC       PATIN1FD/INC
          INC       PATIPEFD/INC
          INC       PATITMFD/INC
          INC       PATLDFFD/INC
          INC       PATLOCFD/INC
          INC       PATLSDFD/INC
          INC       PATMA1FD/INC
          INC       PATLINFD/INC
          INC       PATMCHFD/INC
          INC       PATMI1FD/INC
          INC       PATMMBFD/INC
          INC       PATMRGFD/INC
          INC       PATNHHFD/INC
          INC       PATNIDFD/INC
          INC       PATNOBFD/INC
          INC       PATNUMFD/INC
          INC       PATNURFD/INC
          INC       PATONLFD/INC
          INC       PATOPTFD/INC
          INC       PATPGRFD/INC
          INC       PATPEIFD/INC
          INC       PATPR1FD/INC
          INC       PATQMHTD/INC
          INC       PATQMHFD/INC
          INC       PATRATFD/INC
          INC       PATRCAUD/INC
          INC       PATRE1FD/INC
          INC       PATRGMFD/INC
          INC       PMSRCBFD/INC
          INC       PATSFAFD/INC
          INC       PATSGCFD/INC
          INC       PATSTAFD/INC
          INC       PATTFEFD/INC
          INC       PATTRDAT/INC
          INC       PATTRNFD/INC
          INC       PATUNAFD/INC
          INC       PATVADFD/INC
          INC       PATVENFD/INC
          INC       PATVISFD/INC
          INC       PATWC1FD/INC
          INC       PATWMAFD/INC
          INC       PATWR1FD/INC
          INC       PATWVEFD/INC
          INC       PMSEXTFD/INC
          INC       PMSADWFD/INC
          INC       PMSBDCFD/INC
          INC       PMSCURFD/INC
          INC       PMSEDWFD/INC
          INC       PMSHCGFD/INC
          INC       PMSHCGTD/INC
          INC       PMSHCLFD/INC
          INC       PMSHCPFD/INC
          INC       PMSHCPTD/INC
          INC       OUTBB1FD/INC 
          INC       OUTBOAFD/INC 
          INC       PMSUPGFD/INC 
          INC       PMSUPOFD/INC 
          INC       PMSHPGFD/INC 
          INC       PMSHPOFD/INC 
          INC       PMSMORFD/INC
          INC       PMSHRDFD/INC
          INC       PMSHRDTD/INC
.          INC       PMSIPLFD/INC
          INC       PMSMTIFD/INC
          INC       PMSPX2FD/INC
          INC       PMSPX2TD/INC
          INC       PMSVX1FD/INC
          INC       PMSVX1TD/INC
          INC       PMSWORFD/INC
          INC       PMSWORTD/INC
          INC       PMSWTRFD/INC
          INC       PMSWX1FD/INC            * Patient Work Compensation Ext
          INC       PRSDTLFD/INC
          INC       RESLNKFD/INC
          INC       SCRMASFD/INC
          INC       WATCATFD/INC
          INC       WATCHAFD/INC
          INC       WATHISFD/INC
          INC       WATPNPFD/INC
          INC       WATPROFD/INC
          INC       WATTR1FD/INC
          INC       WATTX1FD/INC
          INC       WATESEFD/INC
          INC       WEBDINVS/INC     * ---- substitue include for PATDINVS ----
          INC       IBAPOLFD/INC
          INC       PMSRUGFD/INC
          INC       PATWBHFD/INC
          INC       PMSEDGFD/INC       * Effective DRG Dates
          INC       PATMISTD/INC
          INC       TFILEVAR/INC
          INC       VISXDCFD/INC
          INC       VISXDCTD/INC
          INC       COMPARFD/INC
          INC       PATDDHFD/INC
          INC       GTCMPATD/INC
.
.
. LOCAL VARIABLES
. ---------------
ACC       DIM       2
ACTION    DIM       1
ACCPORDN  DIM       20
ADD       DIM       2
ADDFLAG   FORM      1
ADDNEWPG  FORM      1    
ADMFIMEX  FORM      1    
ADMISDTE  DIM       8
ADMISTME  DIM       8
ADMISNO   DIM       8
ADMREC    FORM      1
ADMSDATE  DATE      8
ADMNREAS  DIM       3
ADDWLFLG  FORM      1
ADJTIME   FORM      5
ADMFLG    DIM       1
AGECARAS  DIM       3                       * Aged care assessment service(ACAS)
ALTOLDVL  DIM       200
ALTNEWVL  DIM       200
ALTTYPE   DIM       3
ALWLEAVE  FORM      1
AMM       DIM       2
AYY       DIM       2
AUDIFLAG  FORM      1                       * audit type
.
BDATE     DIM       6
BEDDCODE  DIM       3
BEDTRKEY  DIM       30
BDRQADMN  DIM       8
.
FINANELC  DIM       3
CALDAYS   FORM      4
CANTYPE   FORM      1             * Transfer record Cancellation Type
.                                    2 = Admission Type/Attending Doctor
.                                    3 = Bed Transfer
.                                    4 = Return from leave
.                                    5 = On-leave
CARERAVL  DIM       1
CARECATG  DIM       2                    * category for care type  
CARETYPE  DIM       2                                         * was 1 
CBOOK     FORM      1                      *Booking System (1=yes)
.CEFFDATE  DIM       8
CHGCASET  FORM      1             * Change Case Team flag
CHGCARE   FORM      1
CHGADMCR  FORM      1
CHGCFSG   FORM      1
CHGCL     FORM      1
CHGDOC    FORM      1
CHGFEE    FORM      1
CHGHF     FORM      1
CHGMM     FORM      1
CHGTB     FORM      1
CHGTYP    FORM      1
CHGUNT    FORM      1
CHGTEM    FORM      1
CHGRST    FORM      1
CHGRES    FORM      1
CHGFIN    FORM      1
CHGGST    FORM      1
CHKDATE   DIM       8
CHNGUNIT  DIM       3
CHNGTEAM  DIM       5
CHNGRSTR  DIM       10
CHNGRESI  DIM       10
CHRGFLAG  FORM      1
CHCKDOCT  DIM       8
CHCKDATE  DIM       8
CHCKTYPE  FORM      1
CMDLINE   DIM       80     
CLMFLG    FORM      1
COMFILNM  DIM       8
COMFILAF  FILE      ASCII, FIXED=128        * leave details comments
CONTMULT  FORM      1
COUNTER   FORM      2
.CNTRCEFR  FORM      1
CURSESS   DIM       18
CURRDATE  DIM       8
CSEC      DIM       2
CTADMVAR  FORM      1
.
DAILYCH   FORM      6.2
DATEFIM   FORM      8          
DATECHG   FORM      8    
DAYCOL    FORM      4
DAYONCOL  DIM       1
DAYNUMBR  FORM      5
DCEASE    DIM       3
DDATREAS  DIM       3
DELBTRFL  FORM      1
DELETECT  DIM       24
DELETEMH  DIM       1
DELEPAMH  DIM       1
DELKEY30  DIM       30
DFLTWARD  DIM       3  * ward to pre-select on ward selection list
.
DIM1A     DIM       1
DIM3      DIM       3
DIM3A     DIM       3
DIM3B     DIM       3
DIM4      DIM       4
DIM8B     DIM       8
DIM9      DIM       9
DIM16     DIM       16
DIM18     DIM       18
DIM18A    DIM       18
DIM26A    DIM       26
DIM30     DIM       30
DISFLAG   FORM      1
DISHDEST  DIM       1                       * Discharge destination
DISPDTTM  DIM       18                      * Display Date and Time
DISREC    FORM      1
DOCTCODE  DIM       6
DOYR2014  FORM      1
DSCFIMEX  FORM      1     
DSCHADTT  DIM       6
DSCHADTA  DIM       6
DSCHAUTP  FORM      1
DSCHCOM1  DIM       40
DSCHCOM2  DIM       30
DSCHCRAV  DIM       3
DSCHDEST  DIM       3
DSCHDETY  DIM       3
DSCHDIA1  DIM       50
DSCHDIA2  DIM       50
DSCHDIND  FORM      1
DSCHIRAD  DIM       3
DSCHMBSC  DIM       9
DSCHMHLS  DIM       3
DSCHPALC  DIM       3  
DSCHRTOS  DIM       3
DSCHPYSP  DIM       3   
DSCHFINP  DIM       3    
DSCHREAS  DIM       3
DSCHRCCT  DIM       3                  * HPS Code Ends Here
DSCHSREF  DIM       8
DSCHSTAT  DIM       3
DSCHTRAN  DIM       5
DSCHINGP  DIM       1                  * Inform GP (discharge)
.
DSCHSTDF  DIM       3
.
DSCHUSR1  DIM       3
DSCHUSR2  DIM       3
DSCHUSR3  DIM       3
DSCHUSR4  DIM       3
DSCHUSR5  DIM       3
DSCHDPMN  DIM       3
DSECONDS  DIM       2
DSCHUYN1  DIM       1
DSCHUYN2  DIM       1
DSCHUYN3  DIM       1
DSCHCLGP  DIM       12
.
EDWPCEAS  FORM      1        * Save deceased status for EDWARD trigger
EFTDATE   DIM       8
ENDLEAVE  DIM       3
EPISCTYP  DIM       2     
EPISTYPE  DIM       1
ERR1      DIM       50
ERR2      DIM       50
EXPDSDTE  DIM       8        * Calculated Expected Discharge Date
EXPDSTME  DIM       5        * Calculated Expected Discharge Time
.
FAILCNT   FORM      8
FAXITFLG  DIM       1        * Schedule Discharge Fax flag
FAXPRCOD  DIM       6        * Fax Printer Code
FNDLFLG   FORM      3
FONTRED   DIM       10
ENDRED    DIM       10
FORMACTN  DIM       10
FORM3A    FORM      3
FORM4D    FORM      4
FORM5     FORM      5
FORM5B    FORM      5
FORM5C    FORM      5
FORM5P2   FORM      5.2
FORM6A    FORM      6
FORM10    FORM      10
FILTFDAT  DIM       8
FREETXT1  DIM       40
FREETXT2  DIM       40
FREETXT3  DIM       40
FREETXT4  DIM       40
FREETXT5  DIM       40
FREETXT6  DIM       40
FREETXT7  DIM       40
LABELTYP  DIM       10
LEAVTIME  DIM       10  * leave duration in minutes (from leave to return)
TOTLTIME  DIM       10  * leave duration in minutes (from leave to return)
LEAVETOT  DIM       10  * total leave duration in minutes
LEAVREGR  DIM       1
LVRREDIR  DIM       1
LEAVWARD  DIM       3
LEAVRISK  DIM       3
LEAVSTAT  DIM       1
LEAVCARE  DIM       3
LEAVEREG  DIM       1
HOSPCODE  DIM       4    
HOSPITAL  DIM       25  
.
MVITTYPE  DIM       1
MVITSTAT  DIM       1
.
ORIGADMN  DIM       8
OLDCLTY   DIM       3
SAVERHLD  DIM       3
SAVFRHLD  DIM       80
SAVDSTAT  DIM       3
SAVEBSC1  DIM       1
SAVEDOB   DIM       8
SAVTRKEY  DIM       30
SAVEKEY8  DIM       8
SAVEKEY5  DIM       5
SAVKEY6   DIM       6
SAVKEY9   DIM       9
SAVEURNO  DIM       8
SAVKMH30  DIM       30
SAVSTDM6  DIM       6
SAVLSTD6  DIM       6
SAVEPHCP  DIM       10               * Used for HCP Audit as SVMAS variable
SAVEPRAC  DIM       10               * are too small
SAVEPCTR  DIM       2
SUBSYSKY  DIM       5
.
SAVESNAM  DIM       40
SAVEXFNM  DIM       40
SAVEXSNM  DIM       40
SAVETITL  DIM       4
SAVEPSEX  DIM       1
SAVEPDOB  DIM       8
SAVEPFGN  DIM       25
SAVEPMST  DIM       3
SAVEPREG  DIM       3
SAVEPCNT  DIM       3
SAVEPTYP  DIM       3
SAVEABRG  DIM       3
SAVEUSR7  DIM       3
SAVEMEDI  DIM       10
SAVEMCCD  DIM       2
SAVEMEDC  DIM       8
SAVECONP  DIM       1
SAVEUPRF  DIM       3
SAVEINTR  DIM       1
SAVELNG1  DIM       3
SAVEPRVI  DIM       3
SAVEFLDR  DIM       3
SAVESN16  DIM       1
SPPXUCC4  DIM       3
SPPXUCC5  DIM       3
SPPXATF1  DIM       80
SPPXATF2  DIM       80
SAVECUID  DIM       8
SAVECDAT  DIM       8
SAVECTIM  DIM       8
.
SCANNEDM  DIM       1
SVURNUMB  DIM       8
SVADMISS  DIM       8
SAVADMIS  DIM       8
SAVWSTBY  DIM       8
STATNCOD  DIM       6       * Stationery Code
STATADMN  FORM      1
STATDSCH  FORM      1
STATEAM   DIM       5
STATVTYP  DIM       3
STATVISN  DIM       8
HEAONLYF  DIM       1
PTCNDPTM  DIM       8
LTDSRESN  DIM       3
LTDSCOM1  DIM       40
LTDSCOM2  DIM       40
TXTFST40  DIM       40
TXTLST40  DIM       40
STRTSTRK  DIM       10
SUBITMNO  DIM       3
SUBITMFO  FORM      3
ENDSTRK   DIM       10
FORM8     FORM      8
FORM16    FORM      16
FOLDERTY  DIM       1          * Flag to update PMI folder details
FTYPE     FORM      1
.
GLEXTEN   DIM       4
GLSERVCE  DIM       1
.
HBWAIT    FORM      1
HDPEQUIV  DIM       2
HFPORT    FORM      8.2
HINVDES   DIM       30
HOURS     FORM      2
HSTANDM   FORM      1
HFHIFUND  FORM      2
.
INDEX     FORM      2
INVOICED  FORM      1
ISCODING  FORM      1
.
JWDYER    DIM       2
.
KEY12A    DIM       12
KEY13A    DIM       13
KEY16A    DIM       16
KEY21A    DIM       21
KEYBTYP   DIM       3
KEYCOL    DIM       1
.
LASTFLAG  FORM      1             * last record flag
.                                    0 = not last record in pattranf for visit
.                                    1 = last record in pattranf for visit
LASTTRAN  DIM       1                       * last tran record cancelled
LASTTRNS  DIM       16
LCHGDATE  DIM       8
LCHGTIME  DIM       8
LCHGURNO  DIM       8
LEAVEFLG  FORM      1             * Leave Flag
.                                     1 = Leave record is last transfer record
.                                     2 = Leave record is second last
.                                         transfer record where the Return
.                                         record is the last transfer record
.                                     3 = The last transfer record is not a
.                                         Leave or Return record
LEGLFLAG  FORM      1                       * Legal status change flag
LINKDATE  DIM       8
LINKFMUR  DIM       8
LINKREAS  DIM       3
LINKTOUR  DIM       8
LINKTYPE  DIM       1
LOCNCODE  DIM       4
LOOPFLG   FORM      3
LOSDINDC  FORM      1
LSTADOC   DIM       6
LSTATYP   DIM       3
LSTACLM   DIM       3
LSTBED    DIM       3
LSTDATE   DIM       8
LSTEPNO   FORM      2
LSTTEAM   DIM       5
LSTTIME   DIM       8
LSTUNIT   DIM       3
LSTWARD   DIM       3
LSTFUND   DIM       3
STFUND    DIM       3
.
MAX17     DIM       17
MTIFLAG   FORM      1
MBSDESC   DIM       40
MEHKEY24  DIM       24                      * key for MEHDLVFD record
MNHLSBIN  DIM       1
MNHLLVIN  DIM       1
MNHLREDT  DIM       8
MNHLRETM  DIM       8
MNHLLSWD  DIM       3
MNHLLSBD  DIM       3
MHTRAN    FORM      1
MINADD    FORM      2
MINICH    FORM      6.2
MINUTES   FORM      2
MOVEDAT   DIM       8                       * from MOVEMVAR
MHREDIRC  DIM       127
MVMEDREC  FORM      1
MOVEMREC  FORM      1
MOVETIM   DIM       8                       * from MOVEMVAR
MOVETYPE  DIM       1
MRFDDATE  DIM       8                       * cgi medically ready for discharge
.
NEWBTYPE  DIM       3
NADM      FORM      5
NADOCT    DIM       6
NADOCTA   DIM       6
NATYPE    DIM       3
NTRCLTY   DIM       3
NAUNIT    DIM       3
NATEAM    DIM       5
NARSTR    DIM       10
NARESI    DIM       10
NEWATYP   DIM       3
NEWACLM   DIM       3
NEWDOCT   DIM       6
NEWUNIT   DIM       3
NEWTEAM   DIM       5
NEWRSTR   DIM       10
NEWRESI   DIM       10
NEXTPAGE  FORM      1
NEWLEGFL  FORM      1
NMPNUMB   DIM       20
NOCHANGE  FORM      1
NOLABEL   FORM      3 
NOLEAVRG  FORM      1
NOPROGRM  FORM      1        
NOTIFYHS  DIM       1
NMDSCHGF  FORM      1
.
OADOCTA   DIM       6                       * old doc
OATYPE    DIM       3                       * old type
OACLAIM   DIM       3
OAUNIT    DIM       3                       * old unit
OATEAM    DIM       5                       * old team
OARSTR    DIM       10                      * old registrar
OARESI    DIM       10                      * old resident
OLDADATE  DIM       8                       * original admission date ccyymmdd
OLDDEATH  DIM       30
OLDCEASE  FORM      1
OLKEY30   DIM       30                      * on leave key
ODKEY30   DIM       30                      * on Discharge key
ONAME     DIM       30
ONLVPAT   FORM      1
ONLEAVE   FORM      1
OPERCODE  DIM       4
ORIGLEGL  DIM       3
.
PYAA      INIT      "PYAA"
PYZZ      INIT      "PYZZ"
PACKDATE  DIM       10
PREADMIT  FORM      1
PREVBED   DIM       3
PREVWARD  DIM       3
PREVBTYP  DIM       3        * Bed Type
PREVDOC   DIM       6        * Attending Doctor
PREVUNIT  DIM       3        * Unit
PSAGECON  DIM       3
PSAGETYP  DIM       3
PTASF001  DIM       1
PTASF002  DIM       1
PTASF003  DIM       5
.
PTDSC001  DIM       8
PTDSC002  DIM       8
PTDSC003  DIM       8
PTDSC004  DIM       8
PTDSC005  DIM       3
PTDSC006  DIM       3
.
PTMAS029  DIM       1
PTMIS001  DIM       8
PTMIS002  DIM       8
PTMIS074  DIM       1           * GST Applicable (ptmsgsta)
PTRGM001  DIM       10
PTRGM002  DIM       10
PTRGM003  DIM       10
PRNXINDI  DIM       1
PTVIS041  DIM       3
PTVIS131  DIM       3           * Funding Source
PTVIS110  DIM       3           * Program Identifier Cat PK
.
REMOTENO  FORM      2     
RETNDATE  DIM       8
RETNTIME  DIM       8
RTDAYS    FORM      4
.
ALIASSTS  DIM       1
SAVEUSR1  DIM       3
.
SADMNO    DIM       8
SALACDAT  DIM       8
SAVTRTWR  DIM       3
SAVTRTBD  DIM       3
SAVTRNDT  DIM       8
SAVTRNTM  DIM       8
SAVACARE  DIM       3
SAVADATE  DIM       8           * Save date                          *I-0839864
SAVADMN   DIM       8
SAVADMNO  DIM       8
SAVAEND   FORM      4
SAVALLW   FORM      6.2
SAVATIME  DIM       8           * Save time                          *I-0839864
SAVCARE   DIM       3
SAVDECDT  DIM       8
SAVDEPT   DIM       3
SAVDESC   DIM       20
SAVDISC   FORM      6.2
SAVDOCT   DIM       6
SAVEPNO   FORM      2
SAVEBRQN  DIM       8
SAVEXTR   FORM      8.2
SAVETDAT  DIM       8
SAVETTIM  DIM       8
SAVETBED  DIM       3
SAVIND6   DIM       1
SAVKEY19  DIM       19
SAVKEY21  DIM       21
SAVKEY31  DIM       31
SAVKEY34  DIM       34   
SAVLEGL   DIM       3
SAVMOVE   DIM       1
SAVPCEAS  FORM      1
SAVPAUTO  FORM      1
SAVTMOVE  DIM       1
SAVTTIME  DIM       8
SAVEADMN  DIM       8
SAVEDATE  DIM       8
SAVETIME  DIM       5
SAVELOSM  DIM       5
SAVELOSD  DIM       3
STRTTIME  DIM       8
SBBED     DIM       3
SBWARD    DIM       3
SDCEASE   DIM       3
SECONDS   FORM      2
SFORM4D   FORM      4
SHSYFLAG  FORM      1
SMONDAY   DIM       4
SOURCE    FORM      1
SPECIALT  DIM       3
STAYDAYS  FORM      5
LOOPDAYS  FORM      5
STBYBED   DIM       3
STBYFLAG  FORM      1
STBYPAT   DIM       8
STBYWRD   DIM       3
SAVTDEPT  DIM       3
SAVTINIT  INIT      "&savtdept="
SAVTRGID  FORM      4                            * save HL7 trigger ID
SAVTXWRD  DIM       3
SVCHSTAT  DIM       3
SVTALLW   FORM      6.2
SVTDISC   FORM      6.2
SVTEXTRA  FORM      8.2
SVTRADRB  FORM      8.2
SVTRADPT  FORM      8.2
SVTRATEF  FORM      8.2
SVTRATEG  FORM      8.2
SVTRATEH  FORM      8.2
SVTRAUAT  DIM       1
SVTRLTSC  DIM       5
SVTRLTYP  DIM       3
SVTRRNBT  DIM       3
SWPTOBED  DIM       3
SWPTOWRD  DIM       3
SYEAR     DIM       4
.
TEAMNUMB  DIM       1
TEMPVAR   DIM       20
TESTDAT1  DIM       14
TESTDAT2  DIM       14
TESTDAT3  DIM       14
TESTKEY   DIM       30
TESTTRNS  DIM       13
THCFLG    FORM      2
THETFLAG  FORM      1
THISTRNS  DIM       16
THISYEAR  DIM       4
TMPEPNO   FORM      2
TODAY     DIM       8
TRACLAIM  DIM       3
TRANBEDS  DIM       3
TRANCFSG  FORM      1
TRANDATE  DIM       8                       * HPS Code Starts Here
REAEXPDS  DIM       3                       
DELVISIT  DIM       1
TRANFKEY  DIM       30
TRANFLAG  FORM      1
TRANFROM  DIM       1
TRANFHOS  DIM       3
TRANFUND  DIM       6
TRANMEMB  DIM       19
TRANMOVE  DIM       1
TRANSRCE  DIM       5                       * Contracted Leave Transfer Source
TRANTABL  DIM       8
TRANTIME  DIM       8                       * HPS Code Ends Here
TRANTO    DIM       1
TRANWARD  DIM       3
TRNACARE  DIM       3
NEWACARE  DIM       3
TRNTTYPE  DIM       3
TRNUREAS  DIM       3
TRNCANCP  DIM       1
TRNADOCT  DIM       6
TRNLEAVE  FORM      1
TRNLVTYP  DIM       3
TRNSCODE  DIM       5                       * transfer source code
TRNSDATE  DIM       8                       * transfer source date
TRNSFSRC  DIM       5
TRNSRETN  DIM       8
TRNSRETT  DIM       8
TRNTDEPT  DIM       3
TRNTOBED  DIM       3
TRNTOWRD  DIM       3
TRNWEND   FORM      3
TRNTREAT  DIM       6          * Treating Doctor
TYEARR    DIM       4
TRNCASET  DIM       10                      * transfer Case Team
NTRCASET  DIM       10                      * new transfer Case Team
TRNSREAS  DIM       3
.
UPDTTYPE  DIM       1
UPDATETY  FORM      1
UPDATHRD  DIM       1
UPEMFLAG  FORM      1
UPBMSTAT  FORM      1
USERNAME  DIM       10
UPDHFUND  DIM       1
.
VALDDATE  DIM       8
WAITFLAG  FORM      1
WARCOUNT  FORM      2
WARDCODE  DIM       3
WARNINGF  FORM      1
WATHI002  DIM       8
WBEDNUMB  DIM       3
WBEDSWAP  FORM      1
WEBWARNG  DIM       127[20]
WDATE     DIM       8
WDATE1    DIM       8
WDATE2    DIM       8
WORK      FORM      6
WORKDATE  DIM       8
WRDBEDKY  DIM       6
WTCNBRSR  FORM      1
WTCNI13M  DIM       1
.
SKIPAUWR  FORM      1                       * Skip audit record write
.                                               0=NO   1=YES
.
UPDMHDSC  FORM      1        * Update MH patient discharge details (incl. diag)
.
CHKWRDCD  DIM       3        * Check Ward Code
CHKBEDCD  DIM       3        * Check Bed Code
CHKADMDT  DIM       8        * Check Admission Date
CHKADMTM  DIM       8        * Check Admission Time
.
CFPAYCOD  DIM       3        * 3M Codefinder PAY Code
.
TEMPDATE  DIM       8
TEMPTIME  DIM       8
.
TRIGRA11  DIM       1        * Trigger A11 broadcast flag
TRIGRA01  DIM       1        * Trigger A01 broadcast flag
STADMFWD  FORM      1        * Moving stat admis date/time forward? (0=no/1=yes)
STDSCBAC  FORM      1        * Moving stat disch date/time back? (0=no/1=yes)
.
. PROGRAM CONSTANTS
. -----------------
.
CATD1     INIT      "D1"
CATD2     INIT      "D2"
CATD3     INIT      "D3"
CATD4     INIT      "D4"
CATD5     INIT      "D5"
CATU6     INIT      "U6"
CATU7     INIT      "U7"
CATTC     INIT      "tc"
CATtm     INIT      "tm"
CODEA     INIT      "A "
CODEB     INIT      "B"
CODEBT    INIT      "BT"
CODECC    INIT      "CC"
CODED     INIT      "D"
CODEDT    INIT      "DT"
CODECL    INIT      "CL"
CODELU    INIT      "LU"
CODEUNK   INIT      "UNK"
DLCHAR    INIT      "$"
ONEINIT   INIT      "1"              
NEGONE    FORM      "-1"
SP14      INIT      "              "
Z10       INIT      "zzzzzzzzzz"
Z20       INIT      "ZZZZZZZZZZZZZZZZZZZZ"
ZEDS      INIT      "zzzzzzzzzzzzzzzzzzzzzzzzzzzzzz"
ZERO8     INIT      "0000    "         * for patfundf
ZERODATE  INIT      "00000000"
ZEROTIME  INIT      "00:00:00"
ZERO20    INIT      "00000000000000000000"
.
CHWCURNO  DIM       8        * Check UR Number (Workers Compensation)
CHWCADMN  DIM       8        * Check Admission Number (Workers Compensation)
.
.------------------------------------------------------------------------------
PRGID     INIT      "PATWEB96"
VERSION   INIT      "V12.00.10"
PRGNAM    INIT      "Admission Discharge Transfer Server"
.------------------------------------------------------------------------------
.
MAIN0000  CALL      WEBINT00       * Initialise Fifo Etc.
          CALL      INIT0000       * Open Files
.
MAIN1000  CALL      WEBRED00       * Read Fifo WEBPID and USERID
.
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          COMPARE   "999",REPORTNO * End Server Process on Report Option 999
          GOTO      MAIN9999 IF EQUAL
.
MAIN1020  BRANCH    REPORTNO,MAIN1100,MAIN1200,MAIN1300,MAIN1400,MAIN1500:
                             MAIN1600,MAIN1700,MAIN1800,MAIN1900,MAIN2000:
                             MAIN2100,MAIN2200,MAIN2300,MAIN2400
.
          PACK      WEBTITLE,PRGID,SP1,VERSION,SP1,PRGNAM,SP70
          MOVE      "INVALID OPTION",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          GOTO      MAIN1000
.
MAIN1100  CALL      CANCL000                * Cancel Functions
          BRANCH    EXIT,MAIN1000
          CALL      NXTPG000
          GOTO      MAIN1000
.
MAIN1200  CALL      LNKUR000                * Display Linked U/R's
          BRANCH    EXIT,MAIN1000
          GOTO      MAIN1000
.
MAIN1300  MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,MAIN9500
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,MAIN9600
.
          CALL      GASF0000                * Get admis SFA file stuff
.
          CALL      RDVISA1
          BRANCH    OVRCD,MAIN9710
.
          CALL      RDPMVX11
          BRANCH    OVRCD,MAIN9720
.
          MOVE      ADMISSNO,KEY8
          CALL      RDPMWOR1
          IF        OVRCD=1
            CALL      CLPMWO00
          ENDIF
.
          MATCH     "016",TEMPLATE       * Change CMBS class
          GOTO      MAIN1310 IF EQUAL    * allow changing CMBS class for disc.
.
          MATCH     "023",TEMPLATE       * register list    
          GOTO      MAIN1310 IF EQUAL    
.
          CALL      SUPT0000            * Set updatety
.
          IF        UPDATETY=1 & INVOICED=1
            GOTO      MAIN9705
          ENDIF
.
          BRANCH    UPDATETY,MAIN1310
.
          IF        ASTAT=2|ASTAT=4
            GOTO      MAIN1310
          ENDIF
.
          GOTO      MAIN9700
.
MAIN1310  CALL      PATNAA00                * format patient name without Bold
.
          IF        CHOSTYP=1 & CFEETYP=0
            MOVE      FIVE,PTIPRSTA         * Update bed fees
            CALL      CINVP000              * Check for tobe invoiced
          ENDIF
.
          CALL      CLPMLD00
          IF        NOLEAVRG=1
            GOTO      MAIN1320
          ENDIF
.
          PACK      KEY27,ADMISSNO,Z70
          CALL      RSPMLRD1
MAIN1315  CALL      RPPMLRD1
          BRANCH    OVRCD,MAIN1318
.
          MATCH     ADMISSNO,PMLRVISN
          GOTO      MAIN1318 IF NOT EQUAL
.
.     ignore deleted or inactive records
          MATCH     ANSD,PMLRRECS
          GOTO      MAIN1315 IF EQUAL
.
          MATCH     "1",PMLRACTV
          GOTO      MAIN1315 IF EQUAL
.
          GOTO      MAIN1320
.
MAIN1318  CALL      CLPMLD00
.
MAIN1320  CLEAR     WEBTITLE
          APPEND    PATFNAME,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,MAIN1000
          CALL      WEBBOD00
          CALL      WEBEND00
          GOTO      MAIN1000
.
MAIN1400  PACK      SAVTRKEY,ADMISSNO,TRANDATE,TRANTIME,TRNTOWRD,TRNTOBED,SP20
          CALL      CHKT0000 * check date and time does not overlap other visits
          BRANCH    EXIT,MAIN1000
.
          MOVE      ZERO,NOFEE
          CALL      EPTST000                * Check for existing Episode Coding
          BRANCH    EXIT,MAIN1000
          CALL      UPDBT000                *  Update the bed transfer
          BRANCH    EXIT,MAIN1000
.
          IF        WBEDSWAP=1
            MATCH     "1",PTCNCHOD
            IF        @EQUAL
              MATCH     "1",NOTIFYHS
              IF        @EQUAL
                CALL      HREQ0000          * Housekeeping request
              ENDIF
            ENDIF
.
            CALL      MAKSWP00
            BRANCH    EXIT,MAIN1000
.
            MOVE      TURNO,SVURNUMB        * Save standby beds current ur and
            MOVE      TADMN,SVADMISS        * admissno for bed board update
.
            CALL      UPDBT000
            BRANCH    EXIT,MAIN1000
.
            MOVE      AURNO,URNUMBER
            MOVE      AADMNO,ADMISSNO
            PROC      BBUP0000              * Bed Board
.
            MOVE      SVURNUMB,URNUMBER     * Restore standby beds original
            MOVE      SVADMISS,ADMISSNO     * ur and admission
            PROC      BBUP0000              * Bed Board
.
            MATCH     "1",PTCNCHOD
            IF        @EQUAL
              MATCH     "1",NOTIFYHS
              IF        @EQUAL
                MOVE      SAVWARD,PMHRD002
                MOVE      SAVBED,PMHRD003
                CALL      HREQ0000          * Housekeeping request
              ENDIF
            ENDIF
          ELSE
            PROC      BBUP0000              * Bed Board
            MATCH     "1",PTCNCHOD
            IF        @EQUAL
              MATCH     "1",NOTIFYHS
              IF        @EQUAL
                CALL      HREQ0000          * Housekeeping request
              ENDIF
            ENDIF
          ENDIF
.
.         Check if Bed type has been changed
.
          PACK      NEWBTYPE,NEWBTYPE,SP70
          MATCH     SP70,NEWBTYPE
          GOTO      MAIN1420 IF EQUAL
.
          CALL      UPBTY000                 * Update the new bed type
.
MAIN1420  MOVE      THREE,REPORTNO
          IF        EXIT=2
            CALL      WEBWAR00
          ELSE
            CALL      NXTPG000
            BRANCH    EXIT,MAIN1300
          ENDIF
          GOTO      MAIN1000
.
MAIN1500  CALL      CKDSCP00
          BRANCH    EXIT,MAIN1000
          MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,MAIN9500
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,MAIN9600
.
          MOVE      ADMISSNO,KEY8
          CALL      RDPMVX11
          BRANCH    OVRCD,MAIN9600
.
          MOVE      ADMISSNO,KEY8
          CALL      RDPMWOR1
          IF        OVRCD=1
            MOVE      SP70,PMWODPST
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPTQMH1
          IF        OVRCD=1
            CALL      CLRPTQMH
          ENDIF
.
          CALL      GASF0000
.
          CALL      PATNAA00
          CLEAR     WEBTITLE
          APPEND    PATFNAME,WEBTITLE
          APPEND    SP1,WEBTITLE
          APPEND    "(Patient Discharge)",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,MAIN1000
          CALL      WEBBOD00
.                                   
          CALL      CHKPGM00                 * Chk if FIM exists/prgrm complete
.
          CALL      WEBEND00
          GOTO      MAIN1000
.
MAIN1600  CALL      UPDF0000
          BRANCH    EXIT,MAIN1000
          MOVE      "13",HDPEQUIV
          CALL      WPEI0000                * may need to write patpeiaf record
          MOVE      FIVE,REPORTNO
          CALL      NXTPG000
          BRANCH    EXIT,MAIN1500
          GOTO      MAIN1000
.
MAIN1700  CALL      CNLBT000                * Cancel Last Bed Transfer
          BRANCH    EXIT,MAIN1000
          MOVE      THREE,REPORTNO
          CALL      NXTPG000
          BRANCH    EXIT,MAIN1300
          GOTO      MAIN1000
.
MAIN1800  CALL      EPTST000                * Check for existing Episode Coding
          BRANCH    EXIT,MAIN1000
          CALL      UPDS0000                * Update Doctor and Specialty
          BRANCH    EXIT,MAIN1000
          CALL      NXTPG000
          BRANCH    EXIT,MAIN1300
          GOTO      MAIN1000
.
MAIN1900  CALL      EPTST000                * Check for existing Episode Coding
          BRANCH    EXIT,MAIN1000
          CALL      PUBDS000                * Public Update Doc and Specialty
          BRANCH    EXIT,MAIN1000
          MATCH     SP70,HDPEQUIV
          IF        !@EQUAL
            CALL      WPEI0000
          ENDIF
          CALL      NXTPG000
          BRANCH    EXIT,MAIN1300
          GOTO      MAIN1000
.
MAIN2000  CALL      INSUR000                * Update Insurance Details
          BRANCH    EXIT,MAIN1000
          MATCH     SP70,HDPEQUIV
          IF        !@EQUAL
            CALL      WPEI0000
          ENDIF
          CALL      NXTPG000
          BRANCH    EXIT,MAIN1300
          GOTO      MAIN1000
.
MAIN2100  CALL      MHDSC000                * Get MH Discharge details (diag)
          MOVE      ONE,UPDATETY            * update discharge details
          GOTO      MAIN1500
.
MAIN2200  CALL      REMS0000                * Remote Scripting
          GOTO      MAIN1000
.
MAIN2300  CALL      BDRQ0000                * Bed Request
          BRANCH    EXIT,MAIN1000
          CALL      NXTPG000
          GOTO      MAIN1000
.
MAIN2400  CALL      UPDTRN00                
          BRANCH    EXIT,MAIN1000
          MOVE      "Enquiry Complete",WEBTITLE
          CALL      NXTPG000
          GOTO      MAIN1000
.
MAIN9500  MOVE      "Can't Find U/R",WEBTITLE
          CALL      WEBERR00
          GOTO      MAIN1000
.
MAIN9600  MOVE      "Patient is not Admitted",WEBTITLE
          CALL      WEBERR00
          GOTO      MAIN1000
.
MAIN9700  MOVE      "Patient Is Not Currently Admitted",WEBTITLE
          CALL      WEBERR00
          GOTO      MAIN1000
.
MAIN9705  MOVE      "Patient has been invoiced",WEBTITLE
          CALL      WEBERR00
          GOTO      MAIN1000
.
MAIN9710  MOVE      "Missing Visit file record",WEBTITLE
          CALL      WEBERR00
          GOTO      MAIN1000
.
MAIN9720  MOVE      "Missing Visit extension file record",WEBTITLE
          CALL      WEBERR00
          GOTO      MAIN1000
.
MAIN9730  MOVE      "Patient is not discharged",WEBTITLE
          CALL      WEBERR00
          GOTO      MAIN1000
.
MAIN9999  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      WEBERR00
          STOP
+
.------------------------------------------------------------------------------
.         Get the Mental Health Discharge details (including Diagnosis) for
.         the discharge date.
.------------------------------------------------------------------------------
MHDSC000  MOVE      ADMISSNO,KEY8
          CALL      RDMHDSC1
          BRANCH    OVRCD,MHDSC999
.
.         Read MH Diagnosis record for discharged date
.
          CALL      RDDSCH1
          BRANCH    OVRCD,MHDSC999
.
          PACK      KEY16,ADMISSNO,DDATE
          CALL      RDMHDIA1
          IF        OVRCD=1
            CALL      CLMEHDIA
          ENDIF
.
MHDSC999  RETURN
+
.------------------------------------------------------------
. GOBACK10 - Go Back 2 Pages
.------------------------------------------------------------
.
GOBACK10  CALL      OPENHTML
          BRANCH    EXIT,GOBACK19
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             " if (self.name==#"PopUpFrame#") {":
    "  parent.document.getElementById('PopUpScreen').style.display=#"none#"; ":
                             "  parent.history.go(-1);}":
                             " else { ":
                             "  opener.history.go(-1);":
                             "  self.close(); }":
                             "}":
                             "</script>"
          CALL      CLOSHTML
.
GOBACK19  RETURN
+
.------------------------------------------------------------
. PROFLD00 - Process fields from template body
.------------------------------------------------------------
.
PROFLD00  BRANCH    REPORTNO,PROFLD10,PROFLD20,PROFLD30,PROFLD40,PROFLD50:
                             PROFLD99,PROFLD99,PROFLD99,PROFLD99,PROFLD99:
                             PROFLD50,PROFLD99,PROFLD99,PROFLD70
          GOTO      PROFLD99
.
PROFLD10  BRANCH    FLDSETNO,PROFLD11
          GOTO      PROFLD99
.
PROFLD11  GOTO      PROFLD99
.
PROFLD20  BRANCH    FLDSETNO,PROFLD21,PROFLD22,PROFLD23
          GOTO      PROFLD99
.
PROFLD21  CALL      MASF0000
          GOTO      PROFLD99
.
PROFLD22  CALL      MISF0000
          GOTO      PROFLD99
.
PROFLD23  CALL      LDET0000                * Link Details
          GOTO      PROFLD99
.
PROFLD30  BRANCH    FLDSETNO,PROFLD31,PROFLD32,PROFLD33,PROFLD34,PROFLD35:
                             PROFLD36,PROFLD37,PROFLD38
          GOTO      PROFLD99
.
PROFLD31  CALL      MASF0000
          GOTO      PROFLD99
.
PROFLD32  CALL      MISF0000
          GOTO      PROFLD99
.
PROFLD33  CALL      ADMT0000
          GOTO      PROFLD99
.
PROFLD34  CALL      DSCF0000
          GOTO      PROFLD99
.
PROFLD35  CALL      WRDF0000
          GOTO      PROFLD99
.
PROFLD36  CALL      VXTF0000                * Visit Extension
          GOTO      PROFLD99
.
PROFLD37  CALL      VISF0000
          GOTO      PROFLD99
.
PROFLD38  CALL      PMLR0000
          GOTO      PROFLD99
.
PROFLD40  BRANCH    FLDSETNO,PROFLD41
          GOTO      PROFLD99
.
PROFLD41  GOTO      PROFLD99
.
PROFLD50  BRANCH    FLDSETNO,PROFLD51,PROFLD52,PROFLD53,PROFLD54,PROFLD55:
                             PROFLD56,PROFLD57,PROFLD58,PROFLD59,PROFLD60
          GOTO      PROFLD99
.
PROFLD51  CALL      MASF0000
          GOTO      PROFLD99
.
PROFLD52  CALL      MISF0000
          GOTO      PROFLD99
.
PROFLD53  CALL      DSCH0000
          GOTO      PROFLD99
.
PROFLD54  CALL      DSCF0000
          GOTO      PROFLD99
.
PROFLD55  CALL      VISF0000
          GOTO      PROFLD99
.
PROFLD56  CALL      PMIX0000
          GOTO      PROFLD99
.
PROFLD57  CALL      MHDS0000               * MH Discharge file
          GOTO      PROFLD99
.
PROFLD58  CALL      MHDI0000               * MH Diagnosis file
          GOTO      PROFLD99
.
PROFLD59  CALL      ADMT0000
          GOTO      PROFLD99
.
PROFLD60  CALL      MHVS0000                * MH Visit details
          GOTO      PROFLD99
.
PROFLD70  BRANCH    FLDSETNO,PROFLD71
          GOTO      PROFLD99
.
PROFLD71  CALL      ADMT0000  					
          GOTO      PROFLD99
.
PROFLD99  RETURN
+
.--------------------------------------------------------------
. MHDP0000          Mental Health Patient         * I SRF 22731
.--------------------------------------------------------------
.
MHDP0000  COMPARE   ONE,MHCNUSE
          GOTO      MHDP0150 IF NOT EQUAL
          PACK      KEY8,AADMNO
          CALL      RAMHVIS1
          BRANCH    OVRCD,MHDP0150
          WRITE     HTMLFILE;ONE;
          GOTO      MHDP9999
.
MHDP0150  WRITE     HTMLFILE;ZERO;
          GOTO      MHDP9999
.
MHDP9999  RETURN
+                                                 * end I SRF 22731
.------------------------------------------------------------
. ADMT000
.------------------------------------------------------------
ADMT0000  BRANCH    FLDITMNO,ADMT0100,ADMT0200,ADMT0300,ADMT0400,ADMT0500:
                             ADMT0600,ADMT0700,ADMT0800,ADMT0900,ADMT1000:
                             ADMT1100,ADMT1200,ADMT1300,ADMT1400,ADMT1500:
                             ADMT1600,ADMT1700,ADMT1800,ADMT1900,ADMT2000:
                             ADMT2100,ADMT2200,ADMT2300,ADMT2400,ADMT2500:
                             ADMT2600,ADMT2700,ADMT2800,ADMT2900,ADMT3000:
                             ADMT3100,ADMT3200,ADMT3300,ADMT3400,ADMT3500:
                             ADMT3600,ADMT3700,ADMT3800,ADMT3900,ADMT4000:
                             ADMT4100,ADMT4200,ADMT4300,ADMT4400,ADMT4500:
                             ADMT4600,ADMT4700,ADMT4800,ADMT4900,ADMT5000:
                             ADMT5100,ADMT5200,ADMT5300,ADMT5400,ADMT5500:
                             ADMT5600,ADMT5700,ADMT5800,ADMT5900,ADMT6000:
                             ADMT6100,ADMT6200,ADMT6300,ADMT6400,ADMT6500:
                             ADMT6600,ADMT6700,ADMT6800,ADMT6900,ADMT7000:
                             ADMT7100,ADMT7200,ADMT7300,ADMT7400,ADMT7500:
                             ADMT7600,ADMT7700,ADMT7800,ADMT7900,ADMT8000:
                             ADMT8100,ADMT8200,ADMT8300,ADMT8400,ADMT8500:
                             ADMT8600,ADMT8700,ADMT8800,ADMT8900,ADMT9000:
                             ADMT9100
          GOTO      ADMT9999
.
ADMT0100  UNPACK    DIM127,D1,FLDPARA,DIM127
.
          REP       "+ ",ADMISSNO
          MOVE      ADMISSNO,KEY8
          PACK      KEY30,KEY8,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,ADMT9999
          MATCH     KEY8,TADMN
          GOTO      ADMT9999 IF NOT EQUAL
          PACK      BEDTRKEY,TADMN,TDATE,TTIME,TWARD,TBED
.
          WRITE     HTMLFILE;"action=patweb96.pbl>":
                             "<input type=hidden name=reportno value=4>":
                             "<input type=hidden name=template value=":
                             FLDPARA,">":
                             "<input type=hidden name=bedtrkey value=#"":
                             BEDTRKEY,"#">";
.
          GOTO      ADMT9999
.
ADMT0200  CALL      CDATE000            *Transfer out date
          GOTO      ADMT9999
.
ADMT0300  CALL      CTIME000            *Transfer out time
          GOTO      ADMT9999
.
ADMT0400  CALL      LTRD0000            *Last Transfer Date
          GOTO      ADMT9999
.
ADMT0500  CALL      LTRT0000            *Last Transfer Time
          GOTO      ADMT9999
.
ADMT0600  MOVE      "TL",CATEGORY       *Leave Code Select List Category
          CALL      CODITM00
          GOTO      ADMT9999
.
ADMT0700  CALL      LTRS0000            *Leave Transfer Source Select List
          GOTO      ADMT9999
.
ADMT0800  CALL      SFAS0000            *Special Funding Arrangment Select List
          GOTO      ADMT9999
.
ADMT0900  MOVE      "A ",CATEGORY        * Department Code
          MOVE      ATYPE,CODE
          CALL      CODSEL00
          GOTO      ADMT9999
.
ADMT1000  MOVE      SP70,DFLTWARD
          CALL      WSEL0000
          GOTO      ADMT9999
.
ADMT1100  WRITE     HTMLFILE;CURRDATE;     * Current Date
          GOTO      ADMT9999
.
ADMT1200  CALL      PLWB0000                * Patient's Last Ward/Bed
          GOTO      ADMT9999
.
ADMT1300  CALL      DATSEL00                * Date selection from Admis to Curr
          GOTO      ADMT9999
.
ADMT1400  CALL      TRNK0000                * Transer file key
          GOTO      ADMT9999
.
ADMT1500  CALL      CURBED00                * Current Bed
          GOTO      ADMT9999
.
ADMT1600  WRITE     HTMLFILE;PMVXCFSG;
          GOTO      ADMT9999
.
ADMT1700  WRITE     HTMLFILE;ADATE;
          GOTO      ADMT9999
.
ADMT1800  WRITE     HTMLFILE;DDATE;
          GOTO      ADMT9999
.
ADMT1900  CALL      MHDP0000
          GOTO      ADMT9999
.
ADMT2000  READ      CONTROLF,SIXTY9;*71,MHCNMINH
          WRITE     HTMLFILE;MHCNMINH;
          GOTO      ADMT9999
.
ADMT2100  READ      CONTROLF,SIXTY9;*73,MHCNMINT
          WRITE     HTMLFILE;MHCNMINT;
          GOTO      ADMT9999
.
ADMT2200  CALL      LBTD0000
          MATCH     SP70,PTTRLTYP
          GOTO      ADMT9999 IF EQUAL
.
          PACK      KEY5,ANST,ANSL,PTTRLTYP,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ADMT9999
          WRITE     HTMLFILE;TCINDC1;
          GOTO      ADMT9999
.
ADMT2300  READ      CONTROLF,SIXTY9;*79,MHCNKLER
          WRITE     HTMLFILE;MHCNKLER;
          GOTO      ADMT9999
.
ADMT2400  WRITE     HTMLFILE;PTCNUEOC;          * Using episode of care
          GOTO      ADMT9999
.
ADMT2500  CALL      CMXF0000
          WRITE     HTMLFILE;FORM1;
          GOTO      ADMT9999
.
ADMT2600  WRITE     HTMLFILE;PTCNCHSD;          * Changd Transfer Recs on Day
          GOTO      ADMT9999
.
ADMT2700  WRITE     HTMLFILE;PTCNHDPS;          * State Indicator     * I-51246
          GOTO      ADMT9999
.
ADMT2800  WRITE     HTMLFILE;ALACDTE;
          GOTO      ADMT9999
.
ADMT2900  CALL      GETRGM00
          GOTO      ADMT9999
.
ADMT3000  CALL      CHKBRD00                   * Check if boarder also admitted
          GOTO      ADMT9999
.
ADMT3100  CALL      CHKNBN00                   * check if newborn admitted
          GOTO      ADMT9999
.
ADMT3200  CALL      CCPY0000                * Check for casepayment
          WRITE     HTMLFILE;CMXFLAG;
          GOTO      ADMT9999
.
ADMT3300  MOVE      "BT",CATEGORY           * Bed type
.---------MOVE      SAVBTYP,CODE
          MOVE      NEWBTYPE,CODE                                    *I-0852995
          CALL      CODITM00
          GOTO      ADMT9999
.
ADMT3400  MOVE      SP70,WEFRBT
          PACK      KEY6,TRNTOWRD,TRNTOBED,SP70
          MATCH     SP70,KEY6
          IF        !@EQUAL
            CALL      RDWARD1
          ENDIF
          WRITE     HTMLFILE;WEFRBT;
          GOTO      ADMT9999
.
ADMT3500
.         PACK      KEY14,AWARD,ABED,DAADMNO,SP70
.         CALL      RDONLV1
.         IF        OVRCD=0
.           WRITE     HTMLFILE;ONE;
.         ELSE
.           WRITE     HTMLFILE;ZERO;
.         ENDIF
.         GOTO      ADMT9999
.
          PACK      KEY14,DAADMNO,SP70
          CALL      RDSONLV2
          CALL      RDKONLV2
          BRANCH    OVRCD,ADMT3590
.
          MATCH     DAADMNO,DOADMNO
          GOTO      ADMT3590 IF NOT EQUAL
.
          WRITE     HTMLFILE;ONE;
          GOTO      ADMT9999
.
ADMT3590  WRITE     HTMLFILE;ZERO;
          GOTO      ADMT9999
.
ADMT3600  PACK      KEY30,DAADMNO,Z70
          CALL      RDSTRAN2
ADMT3610  CALL      RDPTRAN2
          BRANCH    OVRCD,ADMT9999
.
          MATCH     DAADMNO,DTADMN
          GOTO      ADMT9999 IF NOT EQUAL
.
          MATCH     ANSL,TMOVE
          GOTO      ADMT3610 IF NOT EQUAL
.
          WRITE     HTMLFILE;PTTRLTYP;
.
          GOTO      ADMT9999
.
ADMT3700  PACK      KEY14,AWARD,ABED,DAADMNO,SP70
          CALL      RDONLV1
          IF        OVRCD=0
            MATCH     SP70,OERDATE
            IF        !@EQUAL & !@EOS
              UNPACK    OERDATE,CCENT,CYEAR,CMON,CDAY
              MOVE      CMON,F2
              LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV:
                                   DEC
              WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
            ENDIF
          ENDIF
          GOTO      ADMT9999
.
ADMT3800  PACK      KEY14,AWARD,ABED,DAADMNO,SP70
          CALL      RDONLV1
          IF        OVRCD=0
            WRITE     HTMLFILE;OERTIME;
          ENDIF
          GOTO      ADMT9999
.
ADMT3900  MOVE      URNUMBER,KEY8
          CALL      RDPMRES1
          BRANCH    OVRCD,ADMT9999
          MOVE      "vt",CATEGORY
          MOVE      PMRSVTYP,CODE           * visa type
          CALL      CODITM00
          GOTO      ADMT9999
.
ADMT4000  PROC      CHKDVA00
          WRITE     HTMLFILE;EXIT;              * Dva concession card exits?
          GOTO      ADMT9999
.
ADMT4100  MOVE      "0",KEY1
          PACK      KEY20,URNUMBER,WBSEHOSP,SP20
          CALL      RSMRMAS1
          CALL      RKMRMAS1
          BRANCH    OVRCD,ADMT4199
          MATCH     URNUMBER,MRMAURNO
          GOTO      ADMT4199 IF NOT EQUAL
          MATCH     WBSEHOSP,MRMAHHOS
          GOTO      ADMT4190 IF EQUAL
.                                           * try for a different Home Hospital
          PACK      KEY3,WBSEHOSP,SP70
          CALL      RDPTHSP1
          MATCH     PTHSHOSP,PTHSHHOS       * MR home hospital different to
          GOTO      ADMT4199 IF EQUAL
          PACK      KEY20,URNUMBER,PTHSHHOS,SP20
          CALL      RSMRMAS1
          CALL      RKMRMAS1
          BRANCH    OVRCD,ADMT4199
          MATCH     URNUMBER,MRMAURNO
          GOTO      ADMT4199 IF NOT EQUAL
          MATCH     PTHSHHOS,MRMAHHOS
          GOTO      ADMT4199 IF NOT EQUAL
.
ADMT4190  MOVE      "1",KEY1
ADMT4199  WRITE     HTMLFILE;KEY1;
          GOTO      ADMT9999
.
ADMT4200  MOVE      "P ",CATEGORY
          PACK      KEY5,ANSP,SP70
          CALL      RDSCODE1
ADMT4210  CALL      RDKCODE1
          BRANCH    OVRCD,ADMT9999
.
          MATCH     CATEGORY,TCODE
          GOTO      ADMT9999 IF NOT EQUAL
.
          IF        PTCNHDPS=6
            MATCH     "4",THCSCOD
            GOTO      ADMT4210 IF NOT EQUAL
          ELSE
            MATCH     "S",TCINDC10
            GOTO      ADMT4210 IF NOT EQUAL
          ENDIF
.
          MATCH     ANSI,PTCOACTV
          GOTO      ADMT4210 IF EQUAL
.
          WRITE     HTMLFILE;ACODE;
          GOTO      ADMT9999
.
ADMT4300  MOVE      "S ",CATEGORY
          PACK      KEY5,ANSS,SP70
          CALL      RDSCODE1
ADMT4310  CALL      RDKCODE1
          BRANCH    OVRCD,ADMT9999
.
          MATCH     CATEGORY,TCODE
          GOTO      ADMT9999 IF NOT EQUAL
.
          IF        PTCNHDPS=6
            UNPACK    THCSCOD,ANS,ANS,DIM2
            MATCH     "07",DIM2
            GOTO      ADMT4310 IF NOT EQUAL
          ELSE
            MATCH     "2",TCINDC3
            GOTO      ADMT4310 IF NOT EQUAL
          ENDIF
.
          MATCH     ANSI,PTCOACTV
          GOTO      ADMT4310 IF EQUAL
.
          WRITE     HTMLFILE;ACODE;
          GOTO      ADMT9999
.
ADMT4400  MOVE      "CC",CATEGORY
          PACK      KEY5,ANSC,ANSC,SP70
          CALL      RDSCODE1
ADMT4410  CALL      RDKCODE1
          BRANCH    OVRCD,ADMT9999
.
          MATCH     CATEGORY,TCODE
          GOTO      ADMT9999 IF NOT EQUAL
.
          MATCH     "27",THCSCOD
          GOTO      ADMT4410 IF NOT EQUAL
.
          MATCH     ANSI,PTCOACTV
          GOTO      ADMT4410 IF EQUAL
.
          WRITE     HTMLFILE;ACODE;
          GOTO      ADMT9999
.
ADMT4500  MOVE      "ap",CATEGORY
          PACK      KEY5,CATEGORY,SP70
          CALL      RDSCODE1
ADMT4510  CALL      RDKCODE1
          BRANCH    OVRCD,ADMT9999
.
          MATCH     CATEGORY,TCODE
          GOTO      ADMT9999 IF NOT EQUAL
.
          MATCH     ANSD,TCINDC1
          GOTO      ADMT4510 IF NOT EQUAL
.
          MATCH     ANSI,PTCOACTV
          GOTO      ADMT4510 IF EQUAL
.
          WRITE     HTMLFILE;ACODE;
          GOTO      ADMT9999
.
ADMT4600  PACK      KEY3,WBSEHOSP,SP70
          CALL      RDPTHSP1
          BRANCH    OVRCD,ADMT9999
.
          WRITE     HTMLFILE;PTHSRCOP;
          GOTO      ADMT9999
.
ADMT4700  MOVE      "AC",CATEGORY
          PACK      KEY5,ANSA,ANSC,SP70
          CALL      RDSCODE1
ADMT4710  CALL      RDKCODE1
          BRANCH    OVRCD,ADMT9999
.
          MATCH     CATEGORY,TCODE
          GOTO      ADMT9999 IF NOT EQUAL
.
          MATCH     "M",TCINDC6
.         GOTO      ADMT9999 IF LESS
          GOTO      ADMT4710 IF NOT EQUAL
.
          MATCH     ANSI,PTCOACTV
          GOTO      ADMT4710 IF EQUAL
.
          WRITE     HTMLFILE;ACODE;
          GOTO      ADMT9999
.
ADMT4800  MOVE      "CL",CATEGORY
          PACK      KEY5,ANSC,ANSL,SP70
          CALL      RDSCODE1
ADMT4810  CALL      RDKCODE1
          BRANCH    OVRCD,ADMT9999
.
          MATCH     CATEGORY,TCODE
          GOTO      ADMT9999 IF NOT EQUAL
.
          MATCH     "P",TCINDC1
          GOTO      ADMT4810 IF NOT EQUAL
.
          MATCH     ANSI,PTCOACTV
          GOTO      ADMT4810 IF EQUAL
.
          WRITE     HTMLFILE;ACODE;
          GOTO      ADMT9999
.
ADMT4900  READ      CONTROLF,HUND18;*156,PTCNICOP
          WRITE     HTMLFILE;PTCNICOP;
          GOTO      ADMT9999
.
ADMT5000  MOVE      "BP",CATEGORY
          MOVE      PMVXPACC,CODE           * Preferred accomodation
          CALL      CODITM00
          GOTO      ADMT9999
.
ADMT5100  MOVE      "cx",CATEGORY
          MOVE      PMVXFSRC,CODE           * Funding Source
          MATCH     SP70,PMVXFSRC
          IF        @EQUAL
            PACK      KEY5,CATEGORY,SP70
            CALL      RDSCODE1
ADMT5150    CALL      RDKCODE1
            BRANCH    OVRCD,ADMT9999
            MATCH     CATEGORY,TCODE
            GOTO      ADMT9999 IF NOT EQUAL
            MATCH     "1",PTCDDEFT
            GOTO      ADMT5150 IF NOT EQUAL
            PACK      CODE,ACODE
          ENDIF
          CALL      CODITM00
          GOTO      ADMT9999
.
ADMT5200  CALL      LSREF000
          GOTO      ADMT9999
.
.         PACK      KEY32,URNUMBER,Z70
.         CALL      RSMHDLS1
.         CALL      RPMHDLS1
.         BRANCH    OVRCD,ADMT9999
.
.         MATCH     URNUMBER,MHDLURNO
.         GOTO      ADMT9999 IF NOT EQUAL
.
.         WRITE     HTMLFILE;MHDLURNO,MHDLUNIQ,MHDLSDAT,MHDLSTIM;
.         GOTO      ADMT9999
.
ADMT5300  MOVE      "A ",CATEGORY
          PACK      KEY5,ANSA,SP1,SP70
          CALL      RDSCODE1
ADMT5310  CALL      RDKCODE1
          BRANCH    OVRCD,ADMT9999
.
          MATCH     CATEGORY,TCODE
          GOTO      ADMT9999 IF NOT EQUAL
.
          MATCH     "7",THCSCOD
          GOTO      ADMT5310 IF NOT EQUAL
.
          MATCH     ANSI,PTCOACTV
          GOTO      ADMT5310 IF EQUAL
.
          WRITE     HTMLFILE;ACODE;
          GOTO      ADMT9999
.
ADMT5400  MOVE      ZERO,F1
          MOVE      "S ",CATEGORY
          PACK      KEY5,CATEGORY,ASRCE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ADMT5480
          MATCH     "00",THCSCOD
          GOTO      ADMT5480 IF NOT EQUAL
.
          MOVE      ADMISSNO,KEY8
          CALL      RDPTDAD1
          BRANCH    OVRCD,ADMT5480
          MATCH     SP70,PTDAADTS
          GOTO      ADMT5480 IF EQUAL
.
          MOVE      PTDAADTS,KEY5
          CALL      RDPTVAD1
          BRANCH    OVRCD,ADMT5480
.
          MATCH     "R",PTVADTYP            * From prison
          GOTO      ADMT5480 IF NOT EQUAL
          MOVE      ONE,F1
.
ADMT5480  WRITE     HTMLFILE;F1;
          GOTO      ADMT9999
.
ADMT5500  WRITE     HTMLFILE;ASTAT;
          GOTO      ADMT9999
.
ADMT5600  WRITE     HTMLFILE;WBSEGENR;
          GOTO      ADMT9999
.
ADMT5700  PACK      KEY6,SP70
          COMPARE   THREE,ASTAT             * Discharged?
          GOTO      ADMT5701 IF EQUAL       * yes
.
          PACK      KEY6,AWARD,SP70
          GOTO      ADMT5702
.
ADMT5701  PACK      KEY30,AADMNO,SP70
          CALL      RDSTRAN2
          CALL      RDKTRAN2
          BRANCH    OVRCD,ADMT5702
.
          MATCH     DTADMN,DAADMNO
          GOTO      ADMT5702 IF NOT EQUAL
.
          PACK      KEY6,TWARD,SP70
ADMT5702  CALL      RDWARD1
          MOVE      "CG",CATEGORY
          PACK      CODE,WCLASS,SP70
          CALL      CODITM00
          GOTO      ADMT9999
.
ADMT5800  WRITE     HTMLFILE;DAYONCOL;
          GOTO      ADMT9999
.
ADMT5900  CALL      PRTSEL00           * Output printer selection
          GOTO      ADMT9999
.
ADMT6000  CALL      HCPACT00           * Referring HCP active status
          GOTO      ADMT9999
.
ADMT6100  CALL      HCGACT00           * Referring Practice (HCG) active status
          GOTO      ADMT9999
.
ADMT6200  PACK      KEY24,ADMISSNO,SP70
          CALL      RSPMRUG1
ADMT6210  CALL      RKPMRUG1
          IF        OVRCD=1
            GOTO      ADMT9999
          ENDIF
.
          MATCH     ADMISSNO,PMRUVISN
          GOTO      ADMT9999 IF NOT EQUAL
.
          MATCH     "1",PMRUDELF
          GOTO      ADMT6210 IF EQUAL
.
          WRITE     HTMLFILE;PMRUPSDT,PMRUPEDT;
.
          PACK      KEY24,ADMISSNO,Z70
          CALL      RSPMRUG1
ADMT6220  CALL      RPPMRUG1
          IF        OVRCD=1
            GOTO      ADMT9999
          ENDIF
          MATCH     ADMISSNO,PMRUVISN
          GOTO      ADMT9999 IF NOT EQUAL
.
          MATCH     "1",PMRUDELF
          GOTO      ADMT6220 IF EQUAL
.
          WRITE     HTMLFILE;PMRUPSDT,PMRUPEDT;
          GOTO      ADMT9999
.
ADMT6300  MOVE      ZERO,F1
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMHVIS1
          BRANCH    OVRCD,ADMT6320
          MOVE      ONE,F1
ADMT6320  WRITE     HTMLFILE;F1;
          GOTO      ADMT9999
.
ADMT6400  MATCH     SP70,TDATE
          IF        !@EQUAL & !@EOS
            UNPACK    TDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          ENDIF
          GOTO      ADMT9999
.
ADMT6500  WRITE     HTMLFILE;TTIME;
          GOTO      ADMT9999
.
ADMT6600  MATCH     SP70,PTTRLTYP
          IF        !@EQUAL & !@EOS
            MOVE      "TL",CATEGORY
            MOVE      PTTRLTYP,CODE
            CALL      GETCOD00
            WRITE     HTMLFILE;TDESC;
          ENDIF
.
ADMT6700  WRITE     HTMLFILE;PTTRLTSC;
          GOTO      ADMT9999
.
ADMT6800  MATCH     SP70,PTTRLTSC
          IF        !@EQUAL & !@EOS
            PACK      KEY5,PTTRLTSC,SP70
            CALL      RDPTVAD1            
            IF        OVRCD=0
              WRITE     HTMLFILE;PTVADESC;
            ENDIF
          ENDIF
          GOTO      ADMT9999
.
ADMT6900  WRITE     HTMLFILE;PTAFCSID;
          GOTO      ADMT9999
.
ADMT7000  MATCH     SP70,PTAFCSID
          IF        !@EQUAL & !@EOS
            PACK      KEY5,PTAFCSID,SP70
            CALL      RDPTVAD1
            IF        OVRCD=0
              WRITE     HTMLFILE;PTVADESC;
            ENDIF
          ENDIF
          GOTO      ADMT9999
.
ADMT7100  WRITE     HTMLFILE;PTAFCTYP;
          GOTO      ADMT9999
.
ADMT7200  WRITE     HTMLFILE;PTAFCROL;
          GOTO      ADMT9999
.
ADMT7300  WRITE     HTMLFILE;TRANFKEY;
          GOTO      ADMT9999
.
ADMT7400  MOVE      "TL",CATEGORY
          PACK      CODE,PTTRLTYP,SP70
          CALL      CODITM00
          GOTO      ADMT9999
.          
ADMT7500  PACK      KEY8,ADMISSNO,SP20      * get ACC purchase order no
          CALL      RDPMWX11
          BRANCH    OVRCD,ADMT9999
.
          WRITE     HTMLFILE;PMWXPORD;
          GOTO      ADMT9999
.
ADMT7600  MOVE      "P ",CATEGORY
          PACK      KEY5,ANSP,SP70
          CALL      RDSCODE1
ADMT7610  CALL      RDKCODE1
          BRANCH    OVRCD,ADMT9999
.
          MATCH     CATEGORY,TCODE
          GOTO      ADMT9999 IF NOT EQUAL
.
          MATCH     "S",THCSCOD
          GOTO      ADMT7610 IF NOT EQUAL
.
          MATCH     ANSI,PTCOACTV
          GOTO      ADMT7610 IF EQUAL
.
          WRITE     HTMLFILE;ACODE;
          GOTO      ADMT9999
.
ADMT7700  MOVE      "vi",CATEGORY
          MOVE      PMWODPST,CODE
          CALL      CODITM00
          GOTO      ADMT9999
.
ADMT7800  MOVE      "P ",CATEGORY           * default for org.p (private disch)
          PACK      KEY5,ANSP,SP70
          CALL      RDSCODE1
ADMT7810  CALL      RDKCODE1
          BRANCH    OVRCD,ADMT9999
.
          MATCH     CATEGORY,TCODE
          GOTO      ADMT9999 IF NOT EQUAL
.
          UNPACK    THCSCOD,D3,D1           * HDP posn4 = 2 ?
          MATCH     "2",D1
          GOTO      ADMT7810 IF NOT EQUAL
.
          MATCH     ANSI,PTCOACTV
          GOTO      ADMT7810 IF EQUAL
.
          WRITE     HTMLFILE;ACODE;
          GOTO      ADMT9999
.
ADMT7900  MOVE      "CC",CATEGORY
          PACK      KEY5,ANSC,ANSC,SP70
          CALL      RDSCODE1
ADMT7910  CALL      RDKCODE1
          BRANCH    OVRCD,ADMT9999
.
          MATCH     CATEGORY,TCODE
          GOTO      ADMT9999 IF NOT EQUAL
.
          UNPACK    THCSCOD,D3,D1           * HDP posn4 = O ?
          MATCH     "O",D1
          GOTO      ADMT7910 IF NOT EQUAL
.
          MATCH     ANSI,PTCOACTV
          GOTO      ADMT7910 IF EQUAL
.
          WRITE     HTMLFILE;ACODE;
          GOTO      ADMT9999
.
ADMT8000  MOVE      "A ",CATEGORY
          PACK      KEY5,ANSA,SP1,SP70
          CALL      RDSCODE1
ADMT8010  CALL      RDKCODE1
          BRANCH    OVRCD,ADMT9999
.
          MATCH     CATEGORY,TCODE
          GOTO      ADMT9999 IF NOT EQUAL
.
          MATCH     "O",TCINDC15                 * set for organ procurement
          GOTO      ADMT8010 IF NOT EQUAL
.
          WRITE     HTMLFILE;ACODE;
          GOTO      ADMT9999
.
ADMT8100  MOVE      "RB",CATEGORY                * Transfer Type/Reason
          MOVE      SP70,CODE
          CALL      CODITM00
          GOTO      ADMT9999
.
ADMT8200  PACK      MAX17,ZERODATE,ZEROTIME,ZERO
          READ      CONTROLF,HUND13;*064,KEY2
          MOVE      KEY2,FORM2
.
          IF        FORM2=0 | FORM2>14
            GOTO      ADMT8290
          ENDIF
.
          PACK      KEY31,ADMISSNO,SP70
          CALL      RSOPDEA2
ADMT8210  CALL      RKOPDEA2
          BRANCH    OVRCD,ADMT8290
.
          MATCH     ADMISSNO,OPDAADMN
          GOTO      ADMT8290 IF NOT EQUAL
.
          CALL      GTMX0000
          GOTO      ADMT8210
.
ADMT8290  WRITE     HTMLFILE;MAX17;
          GOTO      ADMT9999
.
ADMT8300  WRITE     HTMLFILE;NOLEAVRG;
          GOTO      ADMT9999
.
ADMT8400  MOVE      "vd",CATEGORY
          MOVE      PMWOUDF4,CODE
          CALL      CODITM00
          GOTO      ADMT9999
.
ADMT8500  MOVE      "ve",CATEGORY
          MOVE      PMWOUDF5,CODE
          CALL      CODITM00
          GOTO      ADMT9999
.
ADMT8600  WRITE     HTMLFILE;LVRREDIR;
          GOTO      ADMT9999
.
ADMT8700  WRITE     HTMLFILE;LEAVWARD;
          GOTO      ADMT9999
.
ADMT8800  WRITE     HTMLFILE;LEAVRISK;
          GOTO      ADMT9999
.
ADMT8900  WRITE     HTMLFILE;LEAVSTAT;
          GOTO      ADMT9999
.
ADMT9000  WRITE     HTMLFILE;LEAVCARE;
          GOTO      ADMT9999
.
ADMT9100  WRITE     HTMLFILE;LEAVEREG;
          GOTO      ADMT9999
.
ADMT9999  RETURN
+
.-------------------------------------------------------------------------------
. GTMX0000 - Returns maximum time from various fields/records
.-------------------------------------------------------------------------------
GTMX0000  BRANCH    FORM2,GTMX0100,GTMX0200,GTMX0300,GTMX0400,GTMX0500:
                          GTMX0600,GTMX0700,GTMX0800,GTMX0900,GTMX1000:
                          GTMX1100,GTMX1200,GTMX1300,GTMX1400
.
          GOTO      GTMX9999
.
GTMX0100  PACK      KEY10,OPDAUNIQ
          CALL      RDOPARD1
          BRANCH    OVRCD,GTMX9999
.
          MATCH     OPARTCAL,MAX17
          IF        @LESS
            PACK      MAX17,OPDADATE,OPARTCAL,ZERO
          ENDIF
.
          GOTO      GTMX9999
.
GTMX0200  PACK      KEY10,OPDAUNIQ
          CALL      RDOPARD1
          BRANCH    OVRCD,GTMX9999
.
          MATCH     OPARATIM,MAX17
          IF        @LESS
            PACK      MAX17,OPDADATE,OPARATIM,ZERO
          ENDIF
.
          GOTO      GTMX9999
.
GTMX0300  PACK      KEY10,OPDAUNIQ
          CALL      RDOPARD1
          BRANCH    OVRCD,GTMX9999
.
          MATCH     OPARANAP,MAX17
          IF        @LESS
            PACK      MAX17,OPDADATE,OPARANAP,ZERO
          ENDIF
.
          GOTO      GTMX9999
.
GTMX0400  PACK      KEY10,OPDAUNIQ
          CALL      RDOPARD1
          BRANCH    OVRCD,GTMX9999
.
          MATCH     OPARANAS,MAX17
          IF        @LESS
            PACK      MAX17,OPDADATE,OPARANAS,ZERO
          ENDIF
.
          GOTO      GTMX9999
.
GTMX0500  PACK      KEY11,OPDAUNIQ
          CALL      RSOPSRG1
GTMX0501  CALL      RKOPSRG1
          BRANCH    OVRCD,GTMX9999
.
          MATCH     OPDAUNIQ,OPSGUNID
          GOTO      GTMX9999 IF NOT EQUAL
.
          MATCH     OPSGTIPS,MAX17
          IF        @LESS
            REP       " 0",OPSGUY02
            PACK      MAX17,OPDADATE,OPSGTIPS,OPSGUY02
          ENDIF
.
          GOTO      GTMX0501
.
GTMX0600  PACK      KEY11,OPDAUNIQ
          CALL      RSOPSRG1
GTMX0601  CALL      RKOPSRG1
          BRANCH    OVRCD,GTMX9999
.
          MATCH     OPDAUNIQ,OPSGUNID
          GOTO      GTMX9999 IF NOT EQUAL
.
          MATCH     OPSGTISS,MAX17
          IF        @LESS
            REP       " 0",OPSGUY02
            PACK      MAX17,OPDADATE,OPSGTISS,OPSGUY02
          ENDIF
.
          GOTO      GTMX0601
.
GTMX0700  PACK      KEY11,OPDAUNIQ
          CALL      RSOPSRG1
GTMX0701  CALL      RKOPSRG1
          BRANCH    OVRCD,GTMX9999
.
          MATCH     OPDAUNIQ,OPSGUNID
          GOTO      GTMX9999 IF NOT EQUAL
.
          MATCH     OPSGTISE,MAX17
          IF        @LESS
            REP       " 0",OPSGUY02
            PACK      MAX17,OPDADATE,OPSGTISE,OPSGUY02
          ENDIF
.
          GOTO      GTMX0701
.
GTMX0800  PACK      KEY10,OPDAUNIQ
          CALL      RDOPARD1
          BRANCH    OVRCD,GTMX9999
.
          MATCH     OPARANAE,MAX17
          IF        @LESS
            PACK      MAX17,OPDADATE,OPARANAE,ZERO
          ENDIF
.
          GOTO      GTMX9999
.
GTMX0900  PACK      KEY11,OPDAUNIQ
          CALL      RSOPSRG1
GTMX0901  CALL      RKOPSRG1
          BRANCH    OVRCD,GTMX9999
.
          MATCH     OPDAUNIQ,OPSGUNID
          GOTO      GTMX9999 IF NOT EQUAL
.
          MATCH     OPSGTIDR,MAX17
          IF        @LESS
            REP       " 0",OPSGUY02
            PACK      MAX17,OPDADATE,OPSGTIDR,OPSGUY02
          ENDIF
.
          GOTO      GTMX0901
.

GTMX1000  PACK      KEY10,OPDAUNIQ
          CALL      RDOPARD1
          BRANCH    OVRCD,GTMX9999
.
          MATCH     OPARTIRF,MAX17
          IF        @LESS
            PACK      MAX17,OPDADATE,OPARTIRF,ZERO
          ENDIF
.
          GOTO      GTMX9999
.
GTMX1100  PACK      KEY10,OPDAUNIQ
          CALL      RDOPARD1
          BRANCH    OVRCD,GTMX9999
.
          MATCH     OPARTIRB,MAX17
          IF        @LESS
            PACK      MAX17,OPDADATE,OPARTIRB,ZERO
          ENDIF
.
          GOTO      GTMX9999
.
GTMX1200  PACK      KEY10,OPDAUNIQ
          CALL      RDOPARD1
          BRANCH    OVRCD,GTMX9999
.
          MATCH     OPARTIRD,MAX17
          IF        @LESS
            PACK      MAX17,OPDADATE,OPARTIRD,ZERO
          ENDIF
.
          GOTO      GTMX9999
.
GTMX1300  PACK      KEY10,OPDAUNIQ
          CALL      RDOPARD1
          BRANCH    OVRCD,GTMX9999
.
          MATCH     OPARTIDP,MAX17
          IF        @LESS
            PACK      MAX17,OPDADATE,OPARTIDP,ZERO
          ENDIF
.
          GOTO      GTMX9999
.
GTMX1400  PACK      KEY10,OPDAUNIQ
          CALL      RDOPARD1
          BRANCH    OVRCD,GTMX9999
.
          MATCH     OPARTETC,MAX17
          IF        @LESS
            PACK      MAX17,OPDADATE,OPARTETC,ZERO
          ENDIF
.
          GOTO      GTMX9999
.
GTMX9999  RETURN
.------------------------------------------------------------
. Printer selections (ALL for our hospital)
.------------------------------------------------------------
PRTSEL00  PACK      KEY6,SP70               * Read the printer file
          CALL      RDSPRTA1
PRTSEL10  CALL      RDKPRTA1
          BRANCH    OVRCD,PRTSEL99
.
.         MATCH     WBSEHOSP,IBPTHOSP       * Same hospital?
.         GOTO      PRTSEL10 IF NOT EQUAL
.
          PACK      KEY8,QUOTE,QPRTCODE,QUOTE
          WRITE     HTMLFILE;"<option value=",KEY8,">",PRTDESC,"</option>"
          GOTO      PRTSEL10
.
PRTSEL99  RETURN
+
.------------------------------------------------------------
. Output Referring HCP active status
.   (0=active 1=inactive)
.------------------------------------------------------------
HCPACT00  PACK      KEY10,PMVXRHC1,SP10
          CALL      RDPMHCP1
          BRANCH    OVRCD,HCPACT91
.
          MATCH     "1",PMHCSTTS
          GOTO      HCPACT90 IF NOT EQUAL
.
          GOTO      HCPACT91
.
HCPACT90  WRITE     HTMLFILE;ZERO;
          GOTO      HCPACT99
.
HCPACT91  WRITE     HTMLFILE;ONE;
          GOTO      HCPACT99
.
HCPACT99  RETURN
+
.------------------------------------------------------------
. Output Referring Practice (HCG) active status
.   (0=active 1=inactive)
.------------------------------------------------------------
HCGACT00  PACK      KEY12,PMVXRH1G,PMVXRH1C,SP20
          CALL      RDPMHCG1
          BRANCH    OVRCD,HCGACT91
.
          MATCH     "1",PMHGSTTS
          GOTO      HCGACT90 IF NOT EQUAL
.
          GOTO      HCGACT91
.
HCGACT90  WRITE     HTMLFILE;ZERO;
          GOTO      HCGACT99
.
HCGACT91  WRITE     HTMLFILE;ONE;
          GOTO      HCGACT99
.
HCGACT99  RETURN
+
.-----------------------------------------------------------
.         Check for Casepayment patient
.-----------------------------------------------------------
CCPY0000  MOVE      ZERO,CMXFLAG
          MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,CCPY9999
          PACK      KEY9,ACLAIM,AFUNDH
          CALL      GETCNEFF               * Get Contract Effective From
          BRANCH    EXIT,CCPY9999
.
          MOVE      ZERO,LOWFLAG            * initialise low outliers
          MOVE      ADATE,CEFFDATE
          LOAD      CEFFDATE,CNTRCEFR,ADATE,DDATE
          CALL      CDSC0000                * Check for 'Disc.Eff.Date From'
          BRANCH    EXIT,CCPY9999
.
.         Only check for Matrix if CFINAN=1 (Display Financial details is set)
.
          IF        CFINAN=1
            MOVE      TWO,PROGFLAG
            MOVE      ONE,MSGFLAG
            CALL      CMXMATRX                * Check for matrix
          ENDIF
.
.         current patient and no matrix found, use provisional code if entered
.
          COMPARE   ONE,CMXFLAG
          GOTO      CCPY1000 IF NOT EQUAL   * if current patient, check prov.cod
          MATCH     SP70,CONTRCID
          GOTO      CCPY1000 IF EQUAL
.
          PACK      PTMIPCMX,CMCODE,SP70
          GOTO      CCPY6000
.
CCPY1000  COMPARE   THREE,ASTAT
          GOTO      CCPY8000 IF EQUAL
          MATCH     ANSY,PTMICMXP
          GOTO      CCPY8000 IF NOT EQUAL
          MATCH     SP10,PTMIPCMX           * Casemix code entered?
          GOTO      CCPY8000 IF EQUAL
.
.         Use provisional code
.
          PACK      KEY18,ACLAIM,AFUNDH,PTMIPCMX,SP70
          CALL      VALCMXFN              * get the contract ID (CONTRCID)
          BRANCH    EXIT,CCPY9999
          MOVE      PTMIPCMX,CMCODE
.
CCPY6000  CALL      CHKCMXPT
          GOTO      CCPY9999
.
CCPY8000  MOVE      ZERO,CMXFLAG
CCPY9999  RETURN
+
.------------------------------------------------------------
.         Check if fees to be displayed 0 = No display,
.         1- Bed fees display, 2- Casepayment charge display
.------------------------------------------------------------
CMXF0000  MOVE      ZERO,FORM1                  * default to 'No' display bedfee
          COMPARE   ZERO,CFEETYP
          GOTO      CMXF9999 IF NOT EQUAL       * Not using bed fee file
          READ      CONTROLF,TEN8;*206,CFINAN
          COMPARE   ONE,CFINAN                  * display financial details
          GOTO      CMXF9999 IF NOT EQUAL
          MOVE      ONE,FORM1                   * default to display bed fees
          MOVE      "9999",BDAY           * Assume it's an overnight patient
          PACK      CMDRG,PTMIPCMX,SP20   * Set casemix code
.
.         Check if this hfund using matrix
.
          PACK      KEY14,AFUNDH,ZERO8
          CALL      RDFUND1
          BRANCH    OVRCD,CMXF2000
.
          BRANCH    PTHFUCMX,CMXF1000         * Using matrix
.
          OPEN      PATCFAA1,"patcfaaf"
          MOVE      ACLAIM,KEY3
          CALL      RDPTCFA1
          BRANCH    OVRCD,CMXF2000
.
          MATCH     "3",PTCFCEFR              * Not in use?
          GOTO      CMXF2000 IF EQUAL
.
          MATCH     "1",PTCFMCPS
          GOTO      CMXF2000 IF NOT EQUAL     * Using matrix
.
CMXF1000  MOVE      ANSY,PTMICMXP  * set this patient to use casemix
.
CMXF2000  MATCH     ANSY,PTMICMXP
          GOTO      CMXF9999 IF NOT EQUAL  * not a casemix
          MATCH     SP10,PTMIPCMX
          GOTO      CMXF9999 IF EQUAL
.
          PACK      KEY9,ACLAIM,AFUNDH
          CALL      GETCNEFF               * Get Contract Effective From
          PACK      PTMIPCMX,CMCODE,SP70
          PACK      KEY18,ACLAIM,AFUNDH,CMCODE,SP70
          MOVE      ADATE,CEFFDATE
          LOAD      CEFFDATE,CNTRCEFR,ADATE,DDATE
          CALL      CDSC0000                * Check for 'Disc.Eff.Date From'
          CALL      VALCMXFN              * get the contract ID (CONTRCID)
          IF        PTCNCMXF=1
            BRANCH    EXIT,CMXF9999
          ENDIF
.
          MOVE      ONE,ADMFLAG        * Set one to admission flag
          MOVE      ONE,MSGFLAG        * not display error message
          PROC      PATGNCMX           * to generate casemix funding
          BRANCH    NOFEE,CMXF9999     * Use normal charges
          MOVE      TWO,FORM1          * Use casepayment charges
CMXF9999  RETURN
.
.------------------------------------------------------------
. CURBED00 - Output Current Bed
.------------------------------------------------------------
.
CURBED00  MOVE      SP70,DIM16
          MOVE      SP70,DIM10
          PACK      DIM16,ABED,SP70
          MATCH     SP70,ADMISSNO
          GOTO      CURBED99 IF EQUAL
.
          MATCH     ZEROVISN,AADMNO
          GOTO      CURBED99 IF EQUAL
.
          MATCH     SP70,AWARD
          IF        @EQUAL
            PACK      KEY14,AADMNO,SP70
            CALL      RDSWARD4
            CALL      RDKWARD4
            BRANCH    OVRCD,MISF9999
            MATCH     WSTBY,AADMNO
            GOTO      MISF9999 IF NOT EQUAL
            MOVE      "(Standby)",DIM10
            PACK      DIM16,WBED,DIM10
          ENDIF
          COMPARE   FOUR,ASTAT
          IF        !@EQUAL
            WRITE     HTMLFILE;DIM16;
          ENDIF
.
CURBED99  RETURN
+
.------------------------------------------------------------
. DTRS0000 - Discharge Transfer Source Select List
.------------------------------------------------------------
.
DTRS0000  PACK      KEY8,ADMISSNO,SP70
          CALL      RDPTDAD1
          IF        OVRCD<>0
            MOVE      SP5,PTDADCTS
          ENDIF
.
          MOVE      SP5,KEY5
          CALL      RSPTVAD1
DTRS0100  CALL      RKPTVAD1
          BRANCH    OVRCD,DTRS9999
.
          MATCH     ANSI,PTVAACTV       * inactive code?
          GOTO      DTRS0100 IF EQUAL
.
          MATCH     PTVACODE,PTDADCTS
          IF        @EQUAL
            WRITE   HTMLFILE;"<option value=",PTVACODE," selected>",PTVADESC,"</option>";
          ELSE
            WRITE   HTMLFILE;"<option value=",PTVACODE,">",PTVADESC,"</option>";
          ENDIF
          GOTO      DTRS0100
.
DTRS9999  RETURN
+
.------------------------------------------------------------
. CDATE00 - Calculate different option dates for bed transfer date.
.------------------------------------------------------------
.
CDATE000  CALL      LBTD0000
.
          PACK      TODAY,CURRDATE,SP10
.
          UNPACK    TODAY,CCENT,CYEAR,CMON,CDAY
          MOVE      ZERO,FAILCNT
.
CDATE100  PACK      KEY8,CCENT,CYEAR,CMON,CDAY
          REP       " 0",KEY8
          MATCH     TDATE,KEY8
          GOTO      CDATE999 IF LESS
.
          ADD       ONE,FAILCNT
          MATCH     TODAY,KEY8
          IF        @EQUAL
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            WRITE     HTMLFILE;"<option value=#"",KEY8,"#" selected>",CDAY,SP1:
                                MTHNAM3,SP1,CCENT,CYEAR,"</option>";
          ELSE
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            WRITE     HTMLFILE;"<option value=#"",KEY8,"#">",CDAY,SP1:
                                 MTHNAM3,SP1,CCENT,CYEAR,"</option>";
          ENDIF
.
          MOVE      "-1",ADJDAYS
          CALL      ADJDAT00
          GOTO      CDATE100
.....     IF        FAILCNT<365
.....       GOTO      CDATE100
.....     ENDIF
.
CDATE999  RETURN
+
.------------------------------------------------------------
. LBTD0000 - Last bed transfer date
.------------------------------------------------------------
.
LBTD0000  MOVE      ADMISSNO,KEY8
          PACK      KEY30,KEY8,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,LBTD9999
.
          MATCH     ADMISSNO,TADMN
          GOTO      LBTD9999 IF NOT EQUAL
.
LBTD9999  RETURN
+
.------------------------------------------------------------
. CTIME000 - Calculate different option times for bed transfer time.
.------------------------------------------------------------
.
CTIME000  CALL      IBACLOCK
          MOVE      CTIMEIS,TRANTIME
          WRITE     HTMLFILE;TRANTIME;
.
CTIME999  RETURN
+
.------------------------------------------------------------
. LTRD0000 -  Calculate the last bed transfer date
.------------------------------------------------------------
.
LTRD0000  CALL      LBTD0000
.
          UNPACK    TDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
.
LTRD9999  RETURN
+
.------------------------------------------------------------
. LTRT0000 -  Calculate the last bed transfer date
.------------------------------------------------------------
.
LTRT0000  CALL      LBTD0000
          WRITE     HTMLFILE;TTIME;
.
LTRT9999  RETURN
+
.------------------------------------------------------------
. LTRS0000 - Leave Transfer Source Select List
.------------------------------------------------------------
.
LTRS0000  MOVE      SP5,KEY5
          CALL      RSPTVAD1
LTRS0100  CALL      RKPTVAD1
          BRANCH    OVRCD,LTRS9999
.
          WRITE     HTMLFILE;"<option value=",PTVACODE,">",PTVADESC,"</option>";
          GOTO      LTRS0100
.
LTRS9999  RETURN
+
.------------------------------------------------------------
. SFAS0000 - Special Funding Arrangement Select
.------------------------------------------------------------
.
SFAS0000  READ      CONTROLF,EIGHTY;*250,PTCNHDPS
          COMPARE   THREE,PTCNHDPS
          GOTO      SFAS9999 IF NOT EQUAL
          MOVE      SP1,KEY1
          CALL      RSPTSFA1
SFAS0100  CALL      RKPTSFA1
          BRANCH    OVRCD,SFAS9999
.
          WRITE     HTMLFILE;"<option value=",PTSFCODE,">",PTSFDESC,"</option>";
          GOTO      SFAS0100
.
SFAS9999  RETURN
+
.------------------------------------------------------------
. UPDBT000 - Update the bed transfer
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
.
UPDBT000  MATCH     "1",MNHLLVIN
          IF        @EQUAL
            MOVE      TRNTOWRD,SAVTRTWR
            MOVE      TRNTOBED,SAVTRTBD
            MOVE      TRANDATE,SAVTRNDT
            MOVE      TRANTIME,SAVTRNTM
.
            MOVE      "Return",FORMACTN
            MOVE      MNHLLSWD,TRNTOWRD
            MOVE      MNHLLSBD,TRNTOBED
            MOVE      "0",TRNLEAVE
            MOVE      MNHLREDT,TRANDATE
            MOVE      MNHLRETM,TRANTIME
          ENDIF
.
          MATCH     "2",MNHLLVIN
          IF        @EQUAL
            MOVE      "OnLeave",FORMACTN
            MOVE      SAVTRTWR,TRNTOWRD
            MOVE      SAVTRTBD,TRNTOBED
            MOVE      "1",TRNLEAVE
            MOVE      SAVTRNDT,TRANDATE
            MOVE      SAVTRNTM,TRANTIME
.
            PACK      KEY30,ADMISSNO,Z70
            CALL      RDSTRAN2
            CALL      RDPTRAN2
            BRANCH    OVRCD,UPDBT999
            MATCH     ADMISSNO,DTADMN
            GOTO      UPDBT999 IF NOT EQUAL
            PACK      BEDTRKEY,TADMN,TDATE,TTIME,TWARD,TBED
.
          ENDIF
.
          MATCH     "1",LEAVREGR
          IF        @EQUAL
            CALL      CHKNUR00  *if leave register return, validate nurse code
            BRANCH    EXIT,UPDBT999
          ENDIF
.
          MATCH     "Cancel",FORMACTN
          GOTO      UPDBT900 IF EQUAL
          MATCH     "Transfer",FORMACTN
          GOTO      UPDBT050 IF EQUAL
          MATCH     "Return",FORMACTN
          GOTO      UPDBT050 IF EQUAL
          MATCH     "Update",FORMACTN
          GOTO      UPDBT050 IF EQUAL
          MATCH     "OnLeave",FORMACTN
          GOTO      UPDBT060 IF EQUAL
          MATCH     "LRUpdate",FORMACTN
          GOTO      UPDBT250 IF EQUAL
          MATCH     "DeleteLR",FORMACTN

          GOTO      UPDBT260 IF EQUAL
          MATCH     "Allocate",FORMACTN
          GOTO      UPDBT040 IF EQUAL
.
          GOTO      UPDBT989                * invalid action
.
UPDBT040  CALL      ALLBD000
          BRANCH    EXIT,UPDBT990
.
          GOTO      UPDBT900
.
UPDBT050  MOVE      SP3,SAVWARD
          MOVE      SP3,SAVBED
          MOVE      SP8,SAVDATE
          MOVE      SP8,SAVTIME
          MOVE      ZERO,EXIT
          MOVE      ZERO,TRANFLAG
          MOVE      SP3,SAVATYP
          MOVE      SP70,SAVACLM
          MOVE      ZERO,MHTRAN
.
. *if leave register return, use different cgi's for return date/time
          MATCH     "Return",FORMACTN
          IF        @EQUAL
            MATCH     SP70,RETNDATE
            IF        !@EQUAL
              PACK      TRANDATE,RETNDATE
            ENDIF
            MATCH     SP70,RETNTIME
            IF        !@EQUAL
              PACK      TRANTIME,RETNTIME
            ENDIF
          ENDIF
.
          CALL      CHKSTA00              * Check Admission Status
          BRANCH    EXIT,UPDBT990
.
          CALL      CHKDAT00              * check not transferring in the future
          BRANCH    EXIT,UPDBT990
.
          PACK      KEY6,TRNTOWRD,SP70
          CALL      RDWARD1
          IF        OVRCD=1
            COMPARE   ZERO,TRNLEAVE
            GOTO      UPDBT960 IF EQUAL
            GOTO      UPDBT060        * Added this at THL trying something.
          ENDIF
          IF        WINPUT=0
            MATCH     SP70,TRNTOBED
            GOTO      UPDBT970 IF EQUAL
            PACK      KEY6,TRNTOWRD,TRNTOBED,SP70
            CALL      RDWARD1
            BRANCH    OVRCD,UPDBT975
            COMPARE   ZERO,WACTIVE     * I CAR 46325
            GOTO      UPDBT988 IF NOT EQUAL
          ELSE
.           MOVE      SP70,TRNTOBED
            PACK      KEY6,TRNTOWRD,TRNTOBED,SP70
            CALL      RDWARD1
            BRANCH    OVRCD,UPDBT975
            COMPARE   ZERO,WACTIVE     * I CAR 46325
            GOTO      UPDBT988 IF NOT EQUAL
          ENDIF
.
          MATCH     "1",PTCNXCOM
          IF        !@EQUAL
            PACK      KEY5,ANSR,ANST,WRTYPE,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MATCH     ANSM,TCINDC3
              IF        @EQUAL
                IF        MHCNUSE=1
                  MOVE      ONE,MHTRAN
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     "1",PTCNXCOM
          IF        @EQUAL
            IF        MHCNUSE=1
              MATCH     SP70,ACLSSFT
              IF        !@EQUAL
                PACK      KEY5,ANSA,ANSC,ACLSSFT,SP70
                CALL      RDCODE1
                IF        OVRCD=0
                  MATCH     "P",TCINDC5
                  IF        @EQUAL
                    MOVE      ONE,MHTRAN
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          CALL      CHKHOS00           * check for correct hospital
          BRANCH    EXIT,UPDBT963
.
          CALL      CHKVAL00           * check for MH ward or FC ward
          BRANCH    EXIT,UPDBT965
.
...       CALL      CHKHIH00           * check for HIH
...       BRANCH    EXIT,UPDBT955
.
UPDBT060  BRANCH    WINPUT,UPDBT061    * Ward Only yes? bypass this
          MATCH     SP70,TRNTOBED
          GOTO      UPDBT061 IF EQUAL
.
UPDBT061  MOVE      TRNTOWRD,CHKWRDCD
          MOVE      TRNTOBED,CHKBEDCD
          MOVE      TRANDATE,CHKADMDT
          MOVE      TRANTIME,CHKADMTM
.
          CALL      CHKDAT00           * check not transferring in the future
          BRANCH    EXIT,UPDBT990
.
          CALL      CHKBHS00           * Validate against Ward Bed History
          BRANCH    EXIT,UPDBT992      * Error
.
          CALL      WBOL0000           *Check Ward/Bed Type or On Leave code
          BRANCH    EXIT,UPDBT990
.
          CALL      RLABT000           *Read Lock Admission for Bed Transfer
          BRANCH    EXIT,UPDBT990
.
          CALL      CHKBTR00           *Check bed transfer key
          BRANCH    EXIT,UPDBT990

          COMPARE   FOUR,TRANFLAG      * On Leave
          GOTO      UPDBT100 IF NOT EQUAL
.
          CALL      LEAVE000           *Update Patient On Leave
          BRANCH    EXIT,UPDBT990
.
          GOTO      UPDBT900
.
UPDBT100  CALL      BTRAN000          *Update the bed transfer
          BRANCH    EXIT,UPDBT990
.
          MATCH     "1",PTCNBMAN
          IF        @EQUAL
            PACK      KEY30,AADMNO,SP70
            CALL      RDSTRAN2
            CALL      RDKTRAN2
            BRANCH    OVRCD,UPDBT200
.
            MATCH     DAADMNO,DTADMN
            GOTO      UPDBT200 IF NOT EQUAL
.
            MATCH     "A",TMOVE
            GOTO      UPDBT200 IF NOT EQUAL
.
            MOVE      TRNTOWRD,SAVTWARD     * save ward/bed date/time cgi vars
            MOVE      TRNTOBED,SAVETBED
            MOVE      TRANDATE,SAVETDAT
            MOVE      TRANTIME,SAVETTIM
.
            MOVE      TDATE,TRANDATE
            MOVE      TTIME,TRANTIME
.
            MOVE      TWARD,TRNTOWRD
            MOVE      TBED,TRNTOBED
            MOVE      ASTAY,STAYDAYS
.
            IF        ASTAT=2
              PACK      KEY8,AADMNO,SP70
              CALL      RDPMWOR1
              IF        OVRCD=1
                CALL      CLPMWO00               * Use the expected discharge
              ENDIF                              * date if a current admission
.                                                * instead of TRANDATE plus
              MATCH     SP70,PMWOEDAT            * ASTAY
              IF        !@EQUAL
                DAYSEP    TRANDATE,PMWOEDAT,STAYDAYS
              ENDIF
            ENDIF
.
            CALL      UPPBMN00
            MOVE      SAVTWARD,TRNTOWRD     * restore original ward/bed
            MOVE      SAVETBED,TRNTOBED     * date/time cgi var values
            MOVE      SAVETDAT,TRANDATE
            MOVE      SAVETTIM,TRANTIME
.
          ENDIF
.
          IF        MRCNAMTR=1
            CALL      MVMED000          * Move medical record
            IF        EXIT=2
              MATCH     AURNO,URNUMBER        * Process standby
              IF        !@EQUAL
                PROC      BBUP0000            * Bed Board update
              ENDIF
.
              MOVE      AURNO,URNUMBER
              MOVE      AADMNO,ADMISSNO
              PROC      BBUP0000              * Bed Board update
              GOTO      UPDBT991
            ENDIF
          ENDIF
.
UPDBT200  MATCH     PMVXVISN,DAADMNO        * update the Visit Extension ?
          IF        @EQUAL
            MOVE      ZERO,F1
            MATCH     PMSVX039,Z70
            IF        !@EQUAL
              MOVE      PMSVX039,PMVXVALW
              MOVE      ONE,F1
            ENDIF
            MATCH     PMSVX040,Z70
            IF        !@EQUAL
              MOVE      PMSVX040,PMVXPALW
              MOVE      ONE,F1
            ENDIF
            IF        F1 = 1
              CALL      UPPMVX11
            ENDIF
          ENDIF
.
          MOVE      "Update Successful",WEBTITLE
          GOTO      UPDBT900
.
UPDBT250  CALL      LVRG0000    * update leave register
          GOTO      UPDBT999
.
UPDBT260  CALL      DLLR0000    * delete leave register
          GOTO      UPDBT999
.
UPDBT900  MOVE      AADMNO,KEY8
          CALL      UUPTMIS1
.
          IF        CHOSTYP=1 & CFEETYP=0
            MOVE      FIVE,PTIPRSTA               * Update bed fees
            MOVE      TRANDATE,PENDSDAT           * as at date
            CALL      CINVP000                    * Check for tobe invoiced
          ENDIF
.
          MATCH     "1",MNHLLVIN
          IF        @EQUAL
            MOVE      "2",MNHLLVIN
            GOTO      UPDBT000
          ENDIF
.
          MATCH     Z70,PMLRD001
          IF        !@EQUAL
            CALL      LVRG0000
          ENDIF
          MOVE      ZERO,EXIT
          GOTO      UPDBT999
.
UPDBT955  MOVE      "Invalid claim type for HIH Bed Transfer",WEBTITLE
          CALL      WEBERR00
          MOVE      AADMNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      UPDBT999
.
UPDBT960  CLEAR     WEBTITLE
          APPEND    "Invalid Ward Input : ",WEBTITLE
          APPEND    TRNTOWRD,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      AADMNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      UPDBT999
.
UPDBT963  MOVE      "Invalid Transfer - different hospital code",WEBTITLE
          CALL      WEBERR00
          MOVE      AADMNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      UPDBT999
.
UPDBT965  MOVE      "Invalid Ward Type for Transfer",WEBTITLE
          CALL      WEBERR00
          MOVE      AADMNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      UPDBT999
.
UPDBT970  MOVE      "Bed Must be Entered",WEBTITLE
          CALL      WEBERR00
          MOVE      AADMNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      UPDBT999
.
UPDBT975  MOVE      "Invalid Bed Code.",WEBTITLE
          CALL      WEBERR00
          MOVE      AADMNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      UPDBT999
.
UPDBT988  MOVE      "Closed Bed. Select another bed.",WEBTITLE
          CALL      WEBERR00
          MOVE      AADMNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      UPDBT999                        * end I CAR 46325
.
UPDBT989  MOVE      "INVALID FORM ACTION",WEBTITLE
          CALL      WEBERR00
          MOVE      AADMNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      UPDBT999
.
UPDBT990  MOVE      AADMNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      UPDBT999
.
UPDBT991  MOVE      AADMNO,KEY8
          CALL      UUPTMIS1
.
          MATCH     "1",MNHLLVIN
          IF        @EQUAL
            MOVE      "2",MNHLLVIN
            GOTO      UPDBT000
          ENDIF
.
          MATCH     Z70,PMLRD001
          IF        !@EQUAL
            CALL      LVRG0000
          ENDIF
.
          MOVE      TWO,EXIT
          GOTO      UPDBT999
.
UPDBT992  MOVE      "Invalid Ward/Bed - the ward/bed is not active for this date",WEBTITLE
          CALL      WEBERR00
          MOVE      AADMNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      UPDBT999
.
UPDBT999  RETURN
+
.------------------------------------------------------------
.         Change bed type manually
.------------------------------------------------------------
UPBTY000  MOVE      SAVTRKEY,KEY30
          CALL      RDTRAN2
          BRANCH    OVRCD,UPBTY999
.
          MATCH     NEWBTYPE,TRBTYP
          IF        !@EQUAL
            MOVE      NEWBTYPE,TRBTYP
            CALL      UPTRAN2
          ENDIF
.
UPBTY999  RETURN
+
.------------------------------------------------------------
. CHKVAL00 - Check valid bed transfer
. Returns:  EXIT  0 = Ok to continue
.                 1 = Error
.------------------------------------------------------------
.
CHKVAL00  MOVE      SP70,TRANFROM
          PACK      KEY6,AWARD,ABED,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,CHKVAL90
.
          PACK      KEY5,ANSR,ANST,WRTYPE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CHKVAL10
.
          MATCH     ANSM,TCINDC2         * mental health ward
          IF        @EQUAL
            MOVE      ANSM,TRANFROM
          ENDIF
.
          MATCH     ANSF,TCINDC2         * family choice ward
          IF        @EQUAL
            MOVE      ANSF,TRANFROM
          ENDIF
.
CHKVAL10  MOVE      SP70,TRANTO
          PACK      KEY6,TRNTOWRD,TRNTOBED,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,CHKVAL90
.
          PACK      KEY5,ANSR,ANST,WRTYPE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CHKVAL80
.
          MATCH     ANSM,TCINDC2         * mental health ward
          IF        @EQUAL
            MOVE      ANSM,TRANTO
          ENDIF
.
          MATCH     ANSF,TCINDC2         * family choice ward
          IF        @EQUAL
            MOVE      ANSF,TRANTO
          ENDIF
.
CHKVAL80  MATCH     TRANFROM,TRANTO
          GOTO      CHKVAL90 IF EQUAL
.
          MOVE      ONE,EXIT              * invalid transfer
          GOTO      CHKVAL99
.
CHKVAL90  MOVE      ZERO,EXIT
.
CHKVAL99  RETURN
+
.------------------------------------------------------------
. CHKBRD00 - Check if boarder also admitted
. Returns:  EXIT  0 = Ok to continue
.                 1 = Error
.------------------------------------------------------------
CHKBRD00  MOVE      ZERO,EXIT
          PACK      KEY16,URNUMBER,SP70
          CALL      RDSLINK1
CHKBRD10  CALL      RDKLINK1
          BRANCH    OVRCD,CHKBRD99
.
          MATCH     URNUMBER,LINKFUR
          GOTO      CHKBRD99 IF NOT EQUAL
.
          PACK      KEY5,ANSL,ANSU,LINKREA,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CHKBRD99
.
          MATCH     ANSB,TCINDC2
          GOTO      CHKBRD10 IF NOT EQUAL
.
          PACK      KEY17,LINKTUR,TWO,SP70
          CALL      RSPTMI18
CHKBRD20  CALL      RKPTMI18
          BRANCH    OVRCD,CHKBRD10
.
          MATCH     LINKTUR,AURNO
          GOTO      CHKBRD10 IF NOT EQUAL
.
          IF        ASTAT=2 | ASTAT=4
            IF        IBCNMHOS=1
              MATCH     WBSEHOSP,PMVXMHOS
              GOTO      CHKBRD20 IF NOT EQUAL
            ENDIF
.
            MOVE      ONE,EXIT
            GOTO      CHKBRD99
          ENDIF
.
          GOTO      CHKBRD20
.
CHKBRD99  WRITE     HTMLFILE;EXIT;
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          RETURN
+
.------------------------------------------------------------
. CHKNBN00 - Check if newborn admitted
. Returns:  EXIT  0 = Ok to continue
.                 1 = Error
.------------------------------------------------------------
CHKNBN00  MOVE      ZERO,EXIT
          PACK      KEY16,URNUMBER,SP70
          CALL      RDSLINK1
CHKNBN10  CALL      RDKLINK1
          BRANCH    OVRCD,CHKNBN99
.
          MATCH     URNUMBER,LINKFUR          * U/R link exist?
          GOTO      CHKNBN99 IF NOT EQUAL
.
          PACK      KEY5,ANSL,ANSU,LINKREA,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CHKBRD99
.
          MATCH     ANSM,TCINDC1              * is newborn ?
          GOTO      CHKNBN10 IF NOT EQUAL
.
          PACK      KEY17,LINKTUR,TWO,SP70
          CALL      RSPTMI18
CHKNBN20  CALL      RKPTMI18
          BRANCH    OVRCD,CHKNBN10
.
          MATCH     LINKTUR,AURNO             * is admitted ?
          GOTO      CHKNBN10 IF NOT EQUAL
.
          IF        ASTAT=2 | ASTAT=4
            IF        IBCNMHOS=1
              MATCH     WBSEHOSP,PMVXMHOS
              GOTO      CHKNBN20 IF NOT EQUAL
            ENDIF
.
            MOVE      ONE,EXIT
            GOTO      CHKNBN99
          ENDIF
.
          GOTO      CHKNBN20
.
CHKNBN99  WRITE     HTMLFILE;EXIT;
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          RETURN
+
.------------------------------------------------------------
. CHKHOS00 - Check valid bed transfer for multi hospital sites
. Returns:  EXIT  0 = Ok to continue
.                 1 = Error
.------------------------------------------------------------
.
CHKHOS00  MOVE      ZERO,EXIT
          IF        IBCNMHOS<>1
            GOTO      CHKHOS99
          ENDIF
          MOVE      SP70,TRANFHOS
          PACK      KEY6,AWARD,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,CHKHOS90
.
          PACK      TRANFHOS,PTWDHOSN,SP70
.
CHKHOS10  PACK      KEY6,TRNTOWRD,TRNTOBED,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,CHKHOS90
.
          MATCH     PTWDHOSN,TRANFHOS
          GOTO      CHKHOS90 IF EQUAL
.
          MOVE      ONE,EXIT              * invalid transfer
          GOTO      CHKHOS99
.
CHKHOS90  MOVE      ZERO,EXIT
.
CHKHOS99  RETURN
+
.------------------------------------------------------------
. CHKHIH00 - Check for valid HIH bed transfer
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
.
CHKHIH00  COMPARE   THREE,PTCNHDPS
          GOTO      CHKHIH90 IF NOT EQUAL   * Not in Victoria
.
          MOVE      SP70,TRANFROM
          PACK      KEY6,AWARD,ABED,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,CHKHIH90
.
          PACK      KEY5,ANSB,ANST,WEFRBT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CHKHIH10
.
          MATCH     "4",THCSCOD         * HIH ward
          IF        @EQUAL
            MOVE      ONE,TRANFROM
          ENDIF
.
CHKHIH10  MOVE      SP70,TRANTO
          PACK      KEY6,TRNTOWRD,TRNTOBED,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,CHKHIH90
.
          PACK      KEY5,ANSB,ANST,WEFRBT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CHKHIH50
.
          MATCH     "4",THCSCOD         * HIH ward
          IF        @EQUAL
            MOVE      ONE,TRANTO
          ENDIF
.
CHKHIH50  MATCH     TRANFROM,TRANTO
          GOTO      CHKHIH90 IF EQUAL
.
          PACK      KEY5,ANSC,ANSL,ACLAIM,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CHKHIH91
.
          MATCH     "2",TCINDC9           * public claim code
          GOTO      CHKHIH90 IF EQUAL
.
          PACK      KEY5,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
          SCAN      ANSW,KEY5
          GOTO      CHKHIH90 IF EQUAL
.
          SCAN      ANSM,KEY5
          GOTO      CHKHIH90 IF EQUAL
.
          SCAN      ANSV,KEY5
          GOTO      CHKHIH90 IF EQUAL
          GOTO      CHKHIH91
.
CHKHIH90  MOVE      ZERO,EXIT
          GOTO      CHKHIH99
.
CHKHIH91  MOVE      ONE,EXIT              * invalid transfer
.
CHKHIH99  RETURN
+
.------------------------------------------------------------
. CHKNUR00 - for leave register return, validate if a nurse code is required
. Returns:  EXIT  0 = Ok to continue
.                 1 = Error
.------------------------------------------------------------
CHKNUR00  MOVE      ZERO,EXIT
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,CHKNUR99
.
          MATCH     SP70,ACARE
          GOTO      CHKNUR99 IF EQUAL
.
          PACK      KEY5,ANSC,ANSC,ACARE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CHKNUR99
.
          MATCH     ANSN,TCINDC25
          GOTO      CHKNUR99 IF NOT EQUAL
.
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,CHKNUR99
.
          MATCH     SP70,WBSENURS
          GOTO      CHKNUR90 IF EQUAL
.
          READ      CONTROLF,HUND13;*51,OPCNURSE
          MATCH     "1",OPCNURSE
          IF        @EQUAL
            PACK      KEY10,WBSENURS,SP70
            CALL      RDPMHCP1
            BRANCH    OVRCD,CHKNUR90
            MATCH     "1",PMHCSTTS
            GOTO      CHKNUR90 IF EQUAL
            GOTO      CHKNUR99
          ENDIF
.
          PACK      KEY6,WBSENURS,SP70
          CALL      RDOPNUR1
          BRANCH    OVRCD,CHKNUR90
          COMPARE   "1",OPNRSTAT
          GOTO      CHKNUR90 IF EQUAL
          GOTO      CHKNUR99
.
CHKNUR90  MOVE      "Nurse Code is required on Login details to put this patient on leave",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKNUR99
.
CHKNUR99  RETURN
+
.------------------------------------------------------------
. MAKSWP00 - Set up Swap Variables
. Returns:  EXIT  0 = Ok to continue
.                 1 = Error
.------------------------------------------------------------
.
MAKSWP00  PACK      KEY6,TRNTOWRD,TRNTOBED
          CALL      RDWARD1
          BRANCH    OVRCD,MAKSWP91
.
          MATCH     ZEROVISN,WSTBY
          GOTO      MAKSWP92 IF EQUAL
.
          PACK      KEY30,WADMNO,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,MAKSWP93
.
          MOVE      TADMN,ADMISSNO
          MOVE      SAVWARD,TRNTOWRD
          MOVE      SAVBED,TRNTOBED
          PACK      BEDTRKEY,TADMN,TDATE,TTIME,TWARD,TBED
          MOVE      ZERO,EXIT
          GOTO      MAKSWP99
.
MAKSWP91  MOVE      "Invalid Ward/Bed to Swap",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MAKSWP99
.
MAKSWP92  MOVE      "First transfer of Ward/Bed Swap failed",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MAKSWP99
.
MAKSWP93  CLEAR     WEBTITLE
          APPEND    "Transfer record not found for final transfer ",WEBTITLE
          APPEND    "of Ward/Bed Swap",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MAKSWP99
.
MAKSWP99  RETURN
+
.------------------------------------------------------------
.  Check transfer/discharge time is not in the future
. Returns:   EXIT   0 = Ok to continue
.                   1 = Error
.------------------------------------------------------------
.
CHKDAT00  MATCH     SP70,TRANTIME
          GOTO      CHKDAT91 IF EQUAL
          GOTO      CHKDAT91 IF EOS
.
          CALL      IBACLOCK
          PACK      KEY8,CTIMEIS
          REP       ": ",KEY8
          SQUEEZE   KEY8
          PACK      TESTDAT1,CURRDATE,KEY8
          REP       " 0",TESTDAT1
.
          UNPACK    TRANTIME,CHOUR,KEY1,CMIN
          MATCH     ":",KEY1
          GOTO      CHKDAT91 IF NOT EQUAL
.
          MOVE      TRANTIME,KEY8
          REP       ": ",KEY8
          SQUEEZE   KEY8
          PACK      TESTDAT2,TRANDATE,KEY8
          REP       " 0",TESTDAT2
.
          MATCH     TESTDAT2,TESTDAT1
          GOTO      CHKDAT91 IF LESS
.
          IF        TRNLEAVE=1
.           Check the expected return date (and time if populated) is not less
.           then the on leave transfer date
.
            MATCH     SP70,TRNSRETN
            GOTO      CHKDAT90 IF EQUAL
.
            MATCH     TRANDATE,TRNSRETN
            GOTO      CHKDAT92 IF LESS
            GOTO      CHKDAT90 IF NOT EQUAL
.
            MATCH     Z70,TRNSRETT
            GOTO      CHKDAT90 IF EQUAL
.
            MATCH     SP70,TRNSRETT
            GOTO      CHKDAT90 IF EQUAL
.
            MOVE      TRNSRETT,KEY8
            REP       ": ",KEY8
            SQUEEZE   KEY8
            PACK      TESTDAT3,TRNSRETN,KEY8
            REP       " 0",TESTDAT3
.
            MATCH     TESTDAT2,TESTDAT3
            GOTO      CHKDAT93 IF LESS
          ENDIF
.
CHKDAT90  MOVE      ZERO,EXIT
          GOTO      CHKDAT99
.
CHKDAT91  MOVE      "Transfer Date & Time Invalid",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKDAT99
.
CHKDAT92  MOVE      "Expected Return Date Invalid",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKDAT99
.
CHKDAT93  MOVE      "Expected Return Date & Time Invalid",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKDAT99
.
CHKDAT99  RETURN
+
.------------------------------------------------------------
. CHKSEP00 - Check separation referral
. Returns:    EXIT  0 = Ok to continue
.                   1 = Error
.------------------------------------------------------------
.
CHKSEP00  SCAN      ANSF,DSCHSREF
          GOTO      CHKSEP90 IF NOT EQUAL
.
          PACK      AGEDATE,CURRDATE,SP10
          CALL      CALCAGE
.
          IF        PSAGEYRS>11 & PSAGEYRS<54
            GOTO      CHKSEP90
          ENDIF
.
          MOVE      "Invalid separation referral for age.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKSEP99
.
CHKSEP90  MOVE      ZERO,EXIT
.
CHKSEP99  RETURN
+
.------------------------------------------------------------
. CHKINT00 - Check intention to readmit
. Returns:    EXIT  0 = Ok to continue
.                   1 = Error
.------------------------------------------------------------
.
CHKINT00  MOVE      ZERO,FORM1
.
          COMPARE   THREE,PTCNHDPS
          GOTO      CHKINT90 IF NOT EQUAL
.
          MATCH     SP70,DSCHIRAD
          GOTO      CHKINT90 IF EQUAL
          GOTO      CHKINT90 IF EOS
.
          PACK      KEY5,ANSV,ANSR,DSCHIRAD
          CALL      RDCODE1
          BRANCH    OVRCD,CHKINT91
.
          MOVE      THCSCOD,DIM1
          MOVE      DIM1,FORM1
.
          PACK      KEY5,ANSD,ANSD,DSCHDEST
          CALL      RDCODE1
          BRANCH    OVRCD,CHKINT91
.
          MOVE      THCSCOD,DIM1A
          MATCH     "20030701",TRANDATE
          IF        @LESS
            REP       "2131415161718191D1T1Z1N2A2H2K2",DIM1A
          ELSE
            MATCH     "20190701",TRANDATE
            IF        @LESS
              REP       "S1D1T1Z1B2N2A2H2R2G1",DIM1A                   *C-60167
            ELSE 
              REP       "S1D1T2Z1B2N2A2H2G1J2L2",DIM1A
            ENDIF
          ENDIF
.
          IF        FORM1=0
            MATCH     "1",DIM1A
            GOTO      CHKINT90 IF EQUAL
          ENDIF
.
          MATCH     "1",DIM1A
          IF        @EQUAL
            COMPARE   ZERO,FORM1
            GOTO      CHKINT90 IF EQUAL
          ENDIF
.
          IF        FORM1>0 & FORM1<5 | FORM1=9
            MATCH     "2",DIM1A
            GOTO      CHKINT90 IF EQUAL
          ENDIF
.
          MATCH     "2",DIM1A
          GOTO      CHKINT91 IF NOT EQUAL
.
          BRANCH    FORM1,CHKINT90:              * readmit with booking
                          CHKINT90:              * readmit - no booking
                          CHKINT90:              * readmit with booking
                          CHKINT90:              * readmit - no booking
                          CHKINT91:
                          CHKINT91:
                          CHKINT91:
                          CHKINT91:
                          CHKINT90               * no plan to readmit
          GOTO      CHKINT91
.
CHKINT90  MOVE      ZERO,EXIT
          GOTO      CHKINT99
.
CHKINT91  CLEAR     WEBTITLE
          APPEND    "Invalid discharge destination for intention",WEBTITLE
          APPEND    " to readmit.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
CHKINT99  RETURN
+
.------------------------------------------------------------
. CHKT0000 - Check transfer date and time are before the next
.            admission - supervisor
. Returns:  EXIT  0 = Ok to continue
.                 1 = Error
.------------------------------------------------------------
.
CHKT0000  MOVE      ZERO,EXIT
          BRANCH    STATADMN,CHKT9999
          BRANCH    STATDSCH,CHKT9999
.
          MOVE      SP70,DIM3
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,CHKT9999
          CALL      RDPMVX11
          BRANCH    OVRCD,CHKT9999
          MOVE      PMVXMHOS,DIM3
.
. if currently on leave and leave type ind 3=A or M, allow multiple admissions
          COMPARE   FOUR,ASTAT               * On leave - check type of leave
          GOTO      CHKT0005 IF NOT EQUAL
.
          PACK      KEY30,ADMISSNO,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,CHKT0005
.
          MATCH     ADMISSNO,DTADMN
          GOTO      CHKT0005 IF NOT EQUAL
.
          MATCH     ANSL,TMOVE
          IF        @EQUAL
            MATCH     SP70,PTTRLTYP
            IF        !@EQUAL
              PACK      KEY5,ANST,ANSL,PTTRLTYP,SP70
              CALL      RDCODE1
              IF        OVRCD<>1
                MATCH     ANSM,TCINDC3
                GOTO      CHKT9999 IF EQUAL
.
                MATCH     ANSA,TCINDC3
                GOTO      CHKT9999 IF EQUAL
              ENDIF
            ENDIF
          ENDIF
.
CHKT0005  PACK      DIM8,ADATE,SP70
          PACK      KEY24,AURNO,Z70
          CALL      RDSVISA2
CHKT0010  CALL      RDPVISA2
          BRANCH    OVRCD,CHKT0090
.
          MATCH     PVIURNO,AURNO                * Same U/R
          GOTO      CHKT0090 IF NOT EQUAL
.
          MATCH     DPVIBILL,ADMISSNO
          GOTO      CHKT0010 IF EQUAL            * Same admission
.
          COMPARE   THREE,PVITYPE
          GOTO      CHKT0010 IF NOT EQUAL
.
          MATCH     DIM8,PVIDATE          * if previous adm stop
          GOTO      CHKT9999 IF LESS
          GOTO      CHKT9999 IF EQUAL
.
          PACK      KEY8,PVIBILL
          CALL      RDMISS1
          BRANCH    OVRCD,CHKT0010
.
          COMPARE   ONE,ASTAT                    * Ignore pre admissions
          GOTO      CHKT0010 IF EQUAL
.
          COMPARE   FIVE,ASTAT                   * Ignore cancelled admissions
          GOTO      CHKT0010 IF EQUAL
.
          MOVE      PVIBILL,KEY8
          CALL      RDPMVX11
          BRANCH    OVRCD,CHKT0010
          MATCH     SP70,DIM3
          IF        !@EQUAL
            MATCH     DIM3,PMVXMHOS
            GOTO      CHKT0010 IF NOT EQUAL
          ENDIF
.
.   added aclss check for task 0921241 to allow intended day case to overlap
          MATCH     SP70,ACLSS
          IF        !@EQUAL
            PACK      KEY5,ANSP,SP1,ACLSS,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MATCH     ANSD,TCINDC4
              GOTO      CHKT0010 IF EQUAL
            ENDIF
          ENDIF
.
          MATCH     TRANDATE,PVIDATE
          GOTO      CHKT0091 IF LESS
.
          MATCH     PVIDATE,TRANDATE
          IF        @EQUAL
            MATCH     TRANTIME,ATIME
            GOTO      CHKT0091 IF LESS
          ENDIF
.
          GOTO      CHKT0010
.
CHKT0090  PACK      KEY8,ADMISSNO           * Read original admission and visit
          CALL      RDMISS1                 * details
          CALL      RDVISA1
          CALL      RDPMVX11
.
          MOVE      ZERO,EXIT
          GOTO      CHKT9999
.
CHKT0091  CLEAR     WEBTITLE
          APPEND    "Error : This Visit Will Overlap Admission Number ",WEBTITLE
          APPEND    PVIBILL,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
          PACK      KEY8,ADMISSNO           * Read original admission and visit
          CALL      RDMISS1                 * details
          CALL      RDVISA1
.
CHKT9999  RETURN
+
.------------------------------------------------------------
. Patient Bed Transfer Update
. Returns:   EXIT   0 = Ok to continue
.                   1 = Error occurred - finish
.------------------------------------------------------------
.
BTRAN000  MATCH     SP70,SPECIALT
          IF        !@EQUAL
            MOVE      SPECIALT,TATYPE         * Change Admission Type/Specialty
          ENDIF
.
          MOVE      ZERO,SAVTRGID
.
          CMATCH    ANSA,TMOVE
          GOTO      BTRAN100 IF EQUAL
.
.         Check for change in admission type
.
          MATCH     TATYPE,SAVATYP
          GOTO      BTRAN200 IF EQUAL
.
          BRANCH    PTCNCNDY,BTRAN200  *don't reset day count
.
BTRAN100  PACK      FROMDATE,TDATE
.
BTRAN200  CALL      SAVLOVAR           *Save LBT record details into local Vars
.
.         Update ward/bed, ward only, and patient standby transfers.
.
          MOVE      ZERO,ONLVPAT       *Determine for any type transfer
          CALL      DPCWBT00           *Determine Patient Current Ward/Bed Type .
          MOVE      SAVATYP,ATYPE
          MATCH     SP3,SAVBTYP
          GOTO      BTRAN300 IF NOT EQUAL
.
          PACK      KEY6,SAVWARD,SAVBED
          CALL      RDWARD1
          BRANCH    OVRCD,BTRAN910
.
          MOVE      WEFRBT,SAVBTYP
.
BTRAN300  CALL      INIVAR00           *Initialise local variables
.
.         Check what type of charging we are doing
.
BTRAN500  MATCH     SP6,TRNTDEPT
          IF        !@EQUAL
            CALL      UPDDEP00               * Update Department Code
            BRANCH    EXIT,BTRAN920
          ENDIF
.
.         Remove patient from current bed type
.         1=remove from ward/bed
.         2=remove from ward only
.         3=remove from Standby
.         4=remove from On Leave
.
          MOVE      AADMNO,KEY8
          PERFORM   SOURCE,RMPWB000,RMPWO000,RMSTB000,RMPOL000
          BRANCH    EXIT,BTRAN920
.
          IF        SOURCE<>4
            MOVE      "C",MOVETYPE
          ELSE
            MOVE      "R",MOVETYPE
          ENDIF
.
          CALL      RECALC00           * recalculate charges
.
          CALL      WRBTR000           * Write bed transfer record to BTF
          BRANCH    EXIT,BTRAN920      * error - finish
.
          CALL      UPDADM00           * Update Admission record for Bed Trnsfer
.
          MATCH     ANSR,MOVETYPE           * return from leave ?
          GOTO      BTRAN600 IF NOT EQUAL
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPTRES1                * get PRA details for HL7 message(s)
          IF        OVRCD=1
            CALL      CPTRE100
          ENDIF
.
.         The `return from leave' may be into a different ward, so we need
.         to check this to see whether to send a transfer (A02) message
.         as well as the A22.
.
          MATCH     SAVWARD,AWARD           * same ward as before ?
          IF        @EQUAL
            MATCH     SAVBED,ABED           * yes - same bed as before ?
            GOTO      BTRAN550 IF EQUAL     * yes - no need to send A02
          ENDIF
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      ONE,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICTR                * broadcast transfer A02
.
.         Send A08 after A22 based on parameter       (TSK 0916627)
.
BTRAN550  MATCH     "1",PTCNSRFL
          GOTO      BTRAN600 IF NOT EQUAL
.
          IF        SAVTRGID = 2
            MOVE      ZERO,SAVTRGID
            CALL      PMIGTNID              * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      FORTY1,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICAC              * broadcast update A08
          ENDIF
.
BTRAN600  CALL      UPSTBY00           * Update Stby pat in source ward/bed
          BRANCH    EXIT,BTRAN920
.
. Check whether the transfer is from Emergency, if so remove from Emergency Map
.
          MOVE      ZERO,UPEMFLAG       * Flag set to bed transfer
          CALL      UPDEM000
.
          PROC      CALCCODE                * Recalculate hrs of ICU/NCU/CCU
.
          MOVE      ZERO,EXIT
          GOTO      BTRAN999
.
BTRAN910  MOVE      "Ward record not found",WEBTITLE
          CALL      WEBERR00
BTRAN920  MOVE      ONE,EXIT
BTRAN999  RETURN
+
.------------------------------------------------------------
.         Recalculate bed fees
.------------------------------------------------------------
.
RECALC00  MOVE      ZERO,NOFEE
.
          PACK      DIM30,TADMN,TDATE,TTIME,TWARD,TBED
          MOVE      TRNTOWRD,TWARD
          MOVE      TRNTOBED,TBED
          MOVE      TRANDATE,TDATE
.
          PACK      KEY6,TWARD,TBED
          CALL      RDWARD1
          MOVE      WEFRBT,SAVBTYP
.
          COMPARE   NINE,CFEETYP
          GOTO      RECALC10 IF EQUAL        * Johns Hopkins
.
          COMPARE   ZERO,AINVPRT
          GOTO      RECALC99 IF NOT EQUAL    * invoice printed
.
RECALC10  MOVE      ZERO,TOTDAY
          MOVE      ADATE,FROMDATE
          MOVE      TDATE,TODATE
          MATCH     FROMDATE,TODATE
          GOTO      RECALC20 IF EQUAL
.
          CALL      SPBD0000                * Check for specialty bed type
          IF        EXIT=1
            MOVE      TCINDC6,SAVIND6       * Get no of days in the specialty
            PROC      PATSBTYP
          ELSE
            CALL      NHOSPDAY
          ENDIF
          MOVE      NBRDAYS,TOTDAY
          ADD       ONE,TOTDAY
.
          MOVE      DIM30,KEY30        * Reposition
          CALL      RDTRAN2
          MOVE      TRNTOWRD,TWARD
          MOVE      TRNTOBED,TBED
          MOVE      TRANDATE,TDATE
.
.       Get the new TRBEND after stepdown
.
RECALC20  ADD       ADYHOSP,TOTDAY
.
          MATCH     ANSY,PTMICMXP           * check for casemix payment indic.
          GOTO      RECALC30 IF NOT EQUAL
          MATCH     SP10,PTMIPCMX
          GOTO      RECALC30 IF EQUAL
.
          MOVE      TATYPE,SAVATYP
          MOVE      TOTDAY,BDAYS
          MOVE      ZERO,ADMFLAG           * Not admission progam
          MOVE      ZERO,MSGFLAG           * Not displaying error message
          PROC      PATGNCMX
          BRANCH    NOFEE,RECALC50
.
          MOVE      DAYPAT,SVTRATEF
          MOVE      DAYHF,SVTRATEH
          MOVE      DAYEND,STRBEND
          MOVE      ADDPAT,SPTTRADP
          MOVE      ADDHF,SPTTRADR
          MOVE      ADDEND,PTTRAEND
          MOVE      ZERO,EXIT
          GOTO      RECALC99
.
RECALC30  CALL      GETBF000
          IF        DEFLAG=1
            MOVE      ONE,NOFEE              * No bed fees
          ENDIF
          BRANCH    NOFEE,RECALC50
.
          MOVE      SBFENDDY,STRBEND
          MOVE      SBFPAT,SVTRATEF       * New bed fee
          MOVE      SBFHF,SVTRATEH
.
RECALC50  IF        CHOSTYP=1 & CFEETYP=0
            MOVE      FIVE,PTIPRSTA        * Update Bed fees
            MOVE      TRANDATE,PENDSDAT    * as at date
            CALL      CINVP000             * Check for tobe invoiced
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      RECALC99
.
RECALC99  RETURN
+
.------------------------------------------------------------
.         Update the department code
. Returns:   EXIT   0 = Ok to continue
.                   1 = Error - finish
.------------------------------------------------------------
.
UPDDEP00  MOVE      CODEA,CODE              * Cat "A "
          MOVE      TRNTDEPT,ACODE
          PACK      KEY5,CODE,ACODE
          CALL      RDCODE1                 * get the description
          MOVE      ACODE,SAVATYP
          MOVE      TDESC,SAVDESC
.
          REP       "+ ",TRNADOCT
          MOVE      TRNADOCT,ADOCTA
          PACK      KEY6,ADOCTA
          CALL      RDDOCT1
          BRANCH    OVRCD,UPDDEP91          * invlalid doctor code
.
          PACK      KEY5,CODEDT,DRTYPE
          CALL      RDCODE1
          BRANCH    OVRCD,UPDDEP93          * invalid doctor type
.
          MOVE      ADOCTA,SAVADOC
.
          MOVE      ZERO,EXIT
          GOTO      UPDDEP99
.
UPDDEP91  MOVE      "Invalid Doctor Code",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDDEP99
.
UPDDEP93  MOVE      "Invalid Doctor Type",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
UPDDEP99  RETURN
+
.------------------------------------------------------------
. LEAVE000 - Update patient on leave transfer.
. Returns:    EXIT  0 = Ok to continue
.                   1 = Error
.------------------------------------------------------------
.
LEAVE000  CALL      SAVLOVAR           *Save LBT record details into local Vars .
          COMPARE   ASTAT,TWO          *Is patient admitted?
          GOTO      LEAVE910 IF NOT EQUAL
.
          MOVE      SP70,MNHLSBIN
          MATCH     "2",MNHLLVIN
          IF        @EQUAL
            MATCH     SP3,AWARD          * Is patient on standby
            IF        @EQUAL
.
              MOVE      "1",MNHLSBIN
.
              CALL      RMSTB000         * Remove patient from standby
              BRANCH    EXIT,LEAVE990
.
              MOVE      SAVWARD,AWARD    *Update Admission file
              MOVE      SAVBED,ABED
              MOVE      AADMNO,KEY8
              CALL      UPLMISS1
            ENDIF
          ELSE
            MATCH     SP3,AWARD          *Is patient on standby?
            GOTO      LEAVE920 IF EQUAL
          ENDIF
.
          PACK      KEY8,AADMNO
          CALL      RDVISA1            *Read the visit file
.
          MOVE      TDATE,SAVDATE
          MOVE      TTIME,SAVTIME
.
          CALL      UPDOLV00           *Update on leave file
          CALL      WRLBT000           *Write leave record to bed transfer file
          BRANCH    EXIT,LEAVE990
.
          CALL      UPDCFR00           * Update the control file with trns date
.
          MOVE      ONE,ONLVPAT        *Determine for an on leave transfer
          CALL      DPCWBT00           *Determine Patient Current Ward/Bed Type
.
          MATCH     "1",MNHLSBIN
          GOTO      LEAVE100 IF EQUAL
.
          MOVE      AADMNO,KEY8
          PERFORM   SOURCE,RMPWB000,RMPWO000
          BRANCH    EXIT,LEAVE990
.
LEAVE100  MOVE      FOUR,ASTAT        *Update Admission file
          MOVE      AADMNO,KEY8
          CALL      UPLMISS1
.
          CALL      UPSTBY00           * Update Stby pat in source ward/bed
          BRANCH    EXIT,LEAVE990
.
          PROC      CALCCODE                * Recalculate hrs of ICU/NCU/CCU
.
          MOVE      "Patient Successfully On Leave",WEBTITLE
          MOVE      ZERO,EXIT
          GOTO      LEAVE999
.
LEAVE910  CLEAR     WEBTITLE
          APPEND    "Patient is not admitted ",WEBTITLE
          APPEND    KEY8,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      LEAVE999
.
LEAVE920  CLEAR     WEBTITLE
          APPEND    "Standby Patient not allowed On Leave ",WEBTITLE
          APPEND    KEY8,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
LEAVE990  MOVE      ONE,EXIT
          GOTO      LEAVE999
.
LEAVE999  RETURN
+
.------------------------------------------------------------
.         Initialise local variables
.------------------------------------------------------------
.
INIVAR00  MOVE      ZERO,SVTDISC
          MOVE      ZERO,SAVALLW
          MOVE      ZERO,SVTRATEF
          MOVE      ZERO,SVTRATEH
          MOVE      ZERO,SVTRATEG
          MOVE      ZERO,SVTRADPT
          MOVE      ZERO,SVTRADRB
          MOVE      ZERO,SVTEXTRA
          MOVE      ZERO,STRBEND
.
          MOVE      ZERO,SAVPAT
          MOVE      ZERO,SAVHF
          MOVE      ZERO,KEYCOL
          MOVE      ZERO,KEYBTYP
.
INIVAR99  RETURN
+
.------------------------------------------------------------
. Check if this patient has a EMR Visit  1=visit 0=no visit
.------------------------------------------------------------
.
UPDEM000  PACK      KEY16,URNUMBER,Z70
          OPEN      EMRVISA3,"emrvisaf"
          CALL      RSEMVIS3
UPDEM100  CALL      RPEMVIS3
          BRANCH    OVRCD,UPDEM999
.
          MATCH     URNUMBER,EMVIURNO  * See if its the right patient
          GOTO      UPDEM999 IF NOT EQUAL
.
          MATCH     ADMISSNO,EMVIPADM       * Check if correct emr visit
          GOTO      UPDEM999 IF NOT EQUAL
.
          MATCH     EMVILOCN,SP70      * check to see if the patient is still
          GOTO      UPDEM999 IF EQUAL  * In Emergency, Ignore if nothing!
.
          COMPARE   FOUR,EMVISTAT
          GOTO      UPDEM999 IF EQUAL
.
          MOVE      SP70,WEFRBT        * Clear bed type
.
          PACK      KEY30,AADMNO,Z70
          CALL      RDSTRAN2
UPDEM200  CALL      RDPTRAN2               * Get last ward/bed
          BRANCH    OVRCD,UPDEM300
.
          MATCH     TADMN,AADMNO         * Admission No?
          GOTO      UPDEM300 IF NOT EQUAL
.
          PACK      KEY6,TWARD,TBED,SP70   * Get ward/bed type
          CALL      RDWARD1
.
UPDEM300  PACK      KEY5,ANSB,ANST,WEFRBT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,UPDEM999
.
          MATCH     ANSM,TCINDC11
          GOTO      UPDEM999 IF EQUAL   * don't update ED
.
          MATCH     ANSE,TCINDC12
          GOTO      UPDEM999 IF EQUAL   * don't update ED
.
          MATCH     ANSE,TCINDC11       * Emergency ward - leave on map
          IF        @EQUAL
            MATCH     ANSS,THCSCOD
            IF        @EQUAL
.
              CALL      SHSY0000              * determine if there is prev
              BRANCH    SHSYFLAG,UPDEM900     * short stay transfer
.
              MOVE      TRANDATE,EMVIDDAT     * Discharge date/time set to the
              MOVE      TRANTIME,EMVIDTIM     * transfer date and time if the
              GOTO      UPDEM900              * transfer is to EOU
            ELSE
              IF        UPEMFLAG=1
                MOVE      TRANDATE,EMVIDDAT   * Discharge date/time set to the
                MOVE      TRANTIME,EMVIDTIM   * transfer date and time if the
                GOTO      UPDEM900            * discharge is from a EMG ward/bed
              ENDIF
            ENDIF
            GOTO      UPDEM999
          ENDIF
.
          MOVE      SP70,EMVILOCN             * Remove from Emergency
          MOVE      SP70,EMVIPRLO
          MOVE      SP70,EMVIPRTM
.
          MOVE      TRANDATE,EMVIDDAT         * Discharge date/time set to the
          MOVE      TRANTIME,EMVIDTIM         * transfer date and time
.
          MOVE      ONE,EMVIYN09              * Set Flag for all done
UPDEM900  CALL      UPEMVIS3
.
UPDEM999  RETURN
+
.------------------------------------------------------------
.         Public Hospital uses PATRATE file for the bed fee
.------------------------------------------------------------
.
PUBFEE00  MOVE      ZERO,RCGPAT
          MOVE      ZERO,RCGHF
          MOVE      ZERO,REDAYS
          MOVE      ACLSS,RCLSS
          MOVE      SAVCHST,RCHST
.
          PACK      KEY12,ACLAIM,ATYPE,ACLSS,AUSR2
          CALL      RDRATE1
          BRANCH    OVRCD,PUBFEE90                *unlock before exiting
.
          MOVE      SVTRATEF,ROPAT               *save the old rate
          ADD       SVTEXTRA,ROPAT
.
          MOVE      RCPDAY,SVTRATEF
          MOVE      RCEDAY,SVTEXTRA
.
PUBFEE90  MOVE      AADMNO,KEY8
          CALL      UUPTMIS1
.
PUBFEE99  RETURN
+
.------------------------------------------------------------
.     Retrieve bed codes and fees
.------------------------------------------------------------
.
CODFEE00  MOVE      SP20,DANS1
          MOVE      SP20,DANS2
          MOVE      SP20,DANS3
          MOVE      SP20,DANS4
          MOVE      SP20,DANS5
          MOVE      SP20,DANS6
          MOVE      ZERO,NOFEE
          MOVE      ZERO,DEFLAG
.
.         No Bed fees details if type of charge is not bed fee
.
          COMPARE       ZERO,CFEETYP
          RETURN        IF NOT EQUAL
.
          COMPARE       ONE,CFINAN
          GOTO          CODFEE50 IF NOT EQUAL
.
          MOVE          SP20,TDESC
          PACK          KEY5,CODECL,ACLAIM
          CALL          RDCODE1
          BRANCH        OVRCD,CODFEE10
          MOVE          TDESC,DANS1
.
CODFEE10  MOVE          SP20,TDESC
          PACK          KEY5,CODEA,ATYPE
          CALL          RDCODE1
          BRANCH        OVRCD,CODFEE20
          MOVE          TDESC,DANS4
.
CODFEE20  PACK          KEY14,AFUNDH,ZERO8
          CALL          RDFUND1
          BRANCH        OVRCD,CODFEE30
          MOVE          HFNAME,DANS2
.
CODFEE30  PACK          KEY14,AFUNDH,AFNDTB
          CALL          RDFUND1
          BRANCH        OVRCD,CODFEE40
          MOVE          HFNAME,DANS3
.
CODFEE40  MOVE          ZERO,TCFORM6
          PACK          KEY5,CODEBT,SAVBTYP
          CALL          RDCODE1
.
CODFEE50  PACK          DIM23,ACLAIM,AFUNDH,AFNDTB,ATYPE,SAVBTYP
.
CODFEE99  RETURN
+
.------------------------------------------------------------
. RLABT000 -  Read and Lock Admission Record
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
.
RLABT000  UNPACK    BEDTRKEY,KEY8,DIM127          *Find admission number.
          CALL      RLPTMIS1                      * record found ?
          BRANCH    OVRCD,RLABT940:               * no
                          RLABT950                * yes - already locked
.
          CALL      CLRDIS00
          IF        ASTAT=3
            CALL      RDDSCH1
          ENDIF
.
          MOVE      AURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,RLABT960
.
          MOVE      AURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          PACK      KEY8,AADMNO,SP8
          CALL      RDPMVX11
          IF        OVRCD=1
            CALL      CLPMSVX1
          ENDIF
.
RLABT900  MOVE      ZERO,EXIT
          GOTO      RLABT999
.
RLABT940  MOVE      "Invalid Read on Admission File",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RLABT999
.
RLABT950  MOVE      "Admission locked",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RLABT999
.
RLABT960  MOVE      "Invalid Read on Master File",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RLABT999
.
RLABT999  RETURN
+
.------------------------------------------------------------
.         Check if going into ward/bed or leave code
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
.
WBOL0000  MATCH     SP3,TRNTOWRD
          GOTO      WBOL0100 IF EQUAL
          GOTO      WBOL0100 IF EOS
.
          COMPARE   ZERO,TRNLEAVE
          GOTO      WBOL0300 IF EQUAL
          GOTO      WBOL0300 IF EOS
.
          GOTO      WBOL9200                      *Display Error
.
WBOL0100  MATCH     SP3,TRNTOBED
          GOTO      WBOL0200 IF EQUAL
          IF        @EOS
            GOTO      WBOL0200
          ENDIF
.
          GOTO      WBOL9300                      *Display Error
.
WBOL0200  COMPARE   ZERO,TRNLEAVE
          IF        !@EQUAL
            MOVE    "4",TRANFLAG              *On Leave
            GOTO      WBOL0400
          ENDIF
.
          GOTO      WBOL9400                  *Display Error
.
WBOL0300  MATCH     SP3,TRNTOBED              *Check for nobed ward
          IF        !@EQUAL
            MOVE      "1",TRANFLAG            *Ward/bed
.
            PACK      KEY6,TRNTOWRD,TRNTOBED
            CALL      RDWARD1
            BRANCH    OVRCD,WBOL9600
.
            MATCH     ADMISSNO,DWADMNO        * same patient in the bed
            GOTO      WBOL0400 IF EQUAL
.
            MATCH     ZEROVISN,WADMNO             *true=no pat in that bed
            GOTO      WBOL0400 IF EQUAL
.
            MATCH     ZEROVISN,WSTBY
            GOTO      WBOL9500 IF NOT EQUAL
.
            MOVE      "3",TRANFLAG            *On Standy
          ELSE
            MOVE      "2",TRANFLAG            *ward only
            MOVE      SP3,TRNTOBED
          ENDIF
.
WBOL0400  MOVE      ZERO,EXIT
          GOTO      WBOL9999
.
WBOL9200  MOVE      "Can't Transfer & Place on Leave in same operation",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      WBOL9999
.
WBOL9300  MOVE      "A Ward number must be entered with a Bed number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      WBOL9999
.
WBOL9400  MOVE      "Either Ward/Bed or On Leave are mandatory.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      WBOL9999
.
WBOL9500  MOVE      "Patient in bed and standby, select another bed.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      WBOL9999
.
WBOL9600  MOVE      "Can't find selected ward and bed.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      WBOL9999
.
WBOL9700  MOVE      "Please Enter Transfer Time",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      WBOL9999
.
WBOL9999  RETURN
+
.------------------------------------------------------------
.  Save last bed transfer details into local variables
.------------------------------------------------------------
.
SAVLOVAR  MOVE      SP3,SAVWARD
          MOVE      SP3,SAVBED
          MOVE      SP8,SAVDATE
          MOVE      SP8,SAVTIME
          MOVE      SP1,SAVMOVE
          MOVE      SP3,SAVBTYP
          MOVE      SP3,SAVDEPT
.
          MOVE      ZERO,SVTRATEF
          MOVE      SP3,SVCHSTAT
          MOVE      ZERO,SVTRATEG
          MOVE      ZERO,SVTDISC
          MOVE      ZERO,SVTALLW
          MOVE      SP3,SAVATYP
          MOVE      SP70,SAVACLM
          MOVE      SP6,SAVADOC
          MOVE      ZERO,SVTRATEH
          MOVE      ZERO,SVTEXTRA
          MOVE      SP3,SVTRLTYP
          MOVE      ZERO,SVTRADPT
          MOVE      ZERO,SVTRADRB
          MOVE      SP3,SVTRRNBT
          MOVE      SP1,SVTRAUAT
          MOVE      SP5,SVTRLTSC
.
          MOVE      TWARD,SAVWARD
          MOVE      TBED,SAVBED
          PACK      SAVDATE,TDATE
          MOVE      TTIME,SAVTIME
          MOVE      TMOVE,SAVMOVE
          MOVE      TRBTYP,SAVBTYP
          MOVE      TDEPT,SAVDEPT
.
          MOVE      TRATEF,SVTRATEF
          MOVE      TCHSTAT,SVCHSTAT
          MOVE      TRATEG,SVTRATEG
          MOVE      TDISC,SVTDISC
          MOVE      TALLW,SVTALLW
          MOVE      TATYPE,SAVATYP
          MOVE      PTTRCLTY,SAVACLM
          MOVE      TADOCT,SAVADOC
          MOVE      TRATEH,SVTRATEH
          MOVE      TEXTRA,SVTEXTRA
.
          RETURN
+
.------------------------------------------------------------
.         Determine Patient Current Ward/Bed Type
. Returns:  SOURCE  1 = Ward/Bed
.                   2 = Ward
.                   3 = Standby
.                   4 = On-Leave
.------------------------------------------------------------
.
DPCWBT00  MOVE      ZERO,SOURCE
          MATCH     SP3,AWARD
          GOTO      DPCWBT10 IF EQUAL
.
          MATCH     SP3,ABED
          GOTO      DPCWBT20 IF EQUAL
.
          MOVE      ONE,SOURCE         *Ward/Bed
          GOTO      DPCWBT95
.
DPCWBT10  BRANCH    ONLVPAT,DPCWBT99
          MOVE      THREE,SOURCE       *Standby Bed
          GOTO      DPCWBT99
.
DPCWBT20  MOVE      TWO,SOURCE         *Ward Only
          GOTO      DPCWBT95
.
DPCWBT95  BRANCH    ONLVPAT,DPCWBT99
          COMPARE   ASTAT,FOUR
          GOTO      DPCWBT99 IF NOT EQUAL
.
          MOVE      FOUR,SOURCE        *On leave
.
DPCWBT99  RETURN
+
.------------------------------------------------------------
.         Remove patient form ward/bed
. Returns:  EXIT   0 = Ok to continue
.                  1 = Error - finish
.------------------------------------------------------------
.
RMPWB000  PACK      KEY6,SAVWARD,SAVBED
          CALL      RDWARD1
          BRANCH    OVRCD,RMPWB950
.
          MATCH     AADMNO,WADMNO
          GOTO      RMPWB950 IF NOT EQUAL
.
          MATCH     SP3,AWARD
          GOTO      RMPWB950 IF EQUAL
.
          MOVE      WSTBY,STBYPAT
          MOVE      AWARD,STBYWRD
          MOVE      ABED,STBYBED
.
          MOVE      ZEROVISN,WADMNO
          MOVE      WSTBY,WADMNO
          MOVE      ZERO,WPLUR
          MOVE      ZEROVISN,WSTBY
          CALL      UPWARD1
.
          MOVE      ZERO,EXIT
          GOTO      RMPWB999
.
RMPWB950  MOVE      "RMPWB: Ward/Bed Inconsistency, transfer not done.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
RMPWB999  RETURN
+
.------------------------------------------------------------
.  Remove patient from ward only
. Returns:  EXIT   0 = Ok to continue
.                  1 = Error - finish
.------------------------------------------------------------
.
RMPWO000  MOVE      APLUR,NBPLUR
          PACK      KEY13,SAVWARD,AADMNO,NBPLUR
          CALL      RDNOBE1
          BRANCH    OVRCD,RMPWO950
.
          CALL      DENOBE1
          MOVE      ZEROVISN,STBYPAT
.
          MOVE      ZERO,EXIT
          GOTO      RMPWO999
.
RMPWO950  MOVE      "RMPWO: Ward Bed Inconsistency, transfer not done.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
RMPWO999  RETURN
+
.------------------------------------------------------------
.   Remove patient from standby
. Returns:  EXIT   0 = Ok to continue
.                  1 = Error - finish
.------------------------------------------------------------
.
RMSTB000  PACK      KEY6,SAVWARD,SAVBED
          CALL      RDWARD1
          BRANCH    OVRCD,RMSTB950
.
          MATCH     AADMNO,WSTBY
          GOTO      RMSTB950 IF NOT EQUAL
.
          MOVE      ZEROVISN,WSTBY
          MOVE      ZEROVISN,STBYPAT
          CALL      UPWARD1
          MOVE      ZERO,EXIT
          GOTO      RMSTB999
.
RMSTB950  MOVE      "RMSTB: Ward Bed Inconsistency, transfer not done.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
RMSTB999  RETURN
+
.------------------------------------------------------------
.   Remove patient from on leave
. Returns:  EXIT   0 = Ok to continue
.                  1 = Error - finish
.------------------------------------------------------------
.
RMPOL000  PACK      KEY14,SAVWARD,SAVBED,AADMNO
          CALL      DEONLV1
.
          PACK      TESTTRNS,TRANDATE,TRANTIME
          MATCH     LASTTRNS,TESTTRNS
          GOTO      RMPOL990 IF LESS
.
          MOVE      TWO,ASTAT
          CALL      UPLMISS1
          MOVE      ZERO,EXIT
          GOTO      RMPOL999
.
RMPOL990  CLEAR     WEBTITLE
          APPEND    "Return Date/Time must be greater than",WEBTITLE
          APPEND    "Leave Date/Time",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
RMPOL999  RETURN
+
.------------------------------------------------------------
.         Write bed transfer record to Bed Transfer File
. Returns:   EXIT   0 = Ok to continue
.                   1 = Error occurred - finish
.------------------------------------------------------------
.
WRBTR000  UNPACK    BEDTRKEY,KEY8,TDATE,TTIME
          MATCH     TDATE,TRANDATE
          IF        @EQUAL
            PACK      KEY8,TRANTIME,SP70
            REP       " 0",KEY8
            MATCH     TTIME,KEY8
            IF        @EQUAL
              UNPACK    TRANTIME,CHOUR,ANS,CMIN,ANS,CSEC
              MOVE      CSEC,F2
              ADD       ONE,F2
              MOVE      F2,CSEC
              REP       " 0",CSEC
              PACK      TRANTIME,CHOUR,COLON,CMIN,COLON,CSEC
            ENDIF
          ENDIF
.
          MOVE      TRNTOWRD,TWARD
          MOVE      TRNTOBED,TBED
          MOVE      TRANDATE,TDATE
          MOVE      TRANTIME,TTIME
.
          PACK      KEY6,TWARD,TBED
          CALL      RDWARD1
          MOVE      WEFRBT,SAVBTYP
.
          MOVE      SAVBTYP,TRBTYP
          MOVE      SAVDEPT,TDEPT
.
          MOVE      AADMNO,TADMN
          MOVE      AURNO,TURNO
          MOVE      ZERO,SECONDS
          MOVE      MOVETYPE,TMOVE
.
          MOVE      SVTRATEH,TRATEH
          MOVE      SVTRATEG,TRATEG
          MOVE      SVTRATEF,TRATEF
          MOVE      SPTTRADR,PTTRADRB
          MOVE      SPTTRADP,PTTRADPT
          MOVE      SVTDISC,TDISC
          MOVE      SVTALLW,TALLW
          MOVE      ADDEND,PTTRAEND
          MOVE      ZERO,PTTRLSPT
          MOVE      ZERO,PTTRLSRB
.         MOVE      SPTTREPS,PTTREPSD
          MOVE      "0",PTTREPSD
          MOVE      SVTEXTRA,TEXTRA
          MOVE      STRBEND,TRBEND
          MOVE      SAVATYP,TATYPE
          MOVE      SAVACLM,PTTRCLTY
          MOVE      SAVADOC,TADOCT
          MOVE      SAVDEPT,TDEPT            * department
          MOVE      SP3,PTTRLTYP            * clear type of leave value
          MOVE      STEPNO,PTTREPNO         * episode number
          MOVE      AUSR2,TCHSTAT
          MOVE      PASSCODE,PTTROPER       * operator Id
          MOVE      SP70,PTTRAUAT
          PACK      PTTRCDAT,CURRDATE,SP10
          MOVE      CTIMEIS,PTTRCTIM
          MOVE      WBSEUID,PTTRCUID        * WEB user id
          MOVE      SP70,PTTRLTSC           * Leave Transfer source
          PACK      PTTRSPAR,SP20,SP20
          MOVE      SP3,PTTRTRTY        *Clear Transfer Reason value *C-0837181
.
          MATCH     Z70,TRNLVTYP
          IF        !@EQUAL
            MOVE      TRNLVTYP,PTTRLTYP
          ENDIF
.
.         Private Hospital does not use Chargeable Status
.
          IF        CFEETYP = 0
            MOVE      SP3,TCHSTAT
          ENDIF
.
          PACK      KEY30,TADMN,TDATE,TTIME,TWARD,TBED,SP70
          MOVE      KEY30,SAVKEY30
          PACK      PTTRCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTTRCDAT
          CLOCK     TIME,PTTRCTIM
          MOVE      WBSEUID,PTTRUCID
          UNPACK    SP70,TRCDATE,TRCTIME,PTTRUUID
.
          MATCH     Z70,TRNTTYPE
          IF        !@EQUAL
            PACK      PTTRTRTY,TRNTTYPE
          ENDIF
.
          PACK      KEY30,TADMN,TDATE,TTIME,TWARD,TBED,SP70
          CALL      RDATRAN2
          IF        OVRCD=1
            CALL      WRTRAN2
          ELSE
            DISPLAY   "I*D transfer key WRBTR000 ",KEY30
          ENDIF
.
          MOVE      AURNO,KEY8              * get the PMI details for HL7 messg

          CALL      RDMAST1
          BRANCH    OVRCD,WRBTR910
.
          MOVE      AURNO,KEY8
          CALL      RDPMPX21
          BRANCH    OVRCD,WRBTR910
.
          CALL      UPDCFR00           * Update the control file with trns date
.
.         Insert paient into new bed type
.         1=update ward/bed file
.         2=write no bed file
.         3=put patient on stdby for ward/bed
.
          PERFORM   TRANFLAG,UPDWF000,WRNOBF00,UPDSTB00
.
.         Broadcast transaction
.
          MATCH     "R",MOVETYPE            * Check for "R"eturn       *I-90101
          GOTO      WRBTR200 IF NOT EQUAL                              *I-90101
.
          CALL      WRMHLV00                * write to mehleraf if required
.
.         If the `return from leave' broadcast parameter is turned on,
.         then send this broadcast message
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TWO,HL7TRGID
          MOVE      TWO,SAVTRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICPR                * Datagate Return Patient  *I-90101
          GOTO      WRBTR900                                           *I-90101
.
WRBTR200  PACK      KEY8,AADMNO,SP70
          CALL      RDPTRES1
          IF        OVRCD=1
            CALL      CPTRE100
          ENDIF

          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      THREE,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICTR                * broadcast transfer       *C-90222
.
WRBTR900  MOVE      ZERO,EXIT
          GOTO      WRBTR999
.
WRBTR910  MOVE      ONE,EXIT
.
WRBTR999  RETURN
+
.------------------------------------------------------------
.         Write to MEH Leave End file if required
.------------------------------------------------------------
.
WRMHLV00  COMPARE   ONE,MHCNUSE             * not using MH
          GOTO      WRMHLV99 IF NOT EQUAL
.
          MOVE      AADMNO,MHVIADMN
          PACK      KEY8,MHVIADMN
          CALL      RDMHVIS1
          BRANCH    OVRCD,WRMHLV99          * not a MH Visit
.
          MOVE      ONE,MHVISTAT            * update status to admitted
          CALL      UPMHVIS1
.
          MOVE      MHVIADMN,MHLRADMN
          MOVE      TDATE,MHLRDATE
          MOVE      TTIME,MHLRTIME
          MOVE      ENDLEAVE,MHLRCODE
.
          PACK      KEY24,MHLRADMN,MHLRDATE,MHLRTIME,SP70
          CALL      RDMHLER1
          COMPARE   ONE,OVRCD
          GOTO      WRMHLV99 IF NOT EQUAL
          CALL      WRMHLER1
.
WRMHLV99  RETURN
+
.------------------------------------------------------------
.         Update Ward File
.------------------------------------------------------------
.
UPDWF000  PACK      KEY6,TRNTOWRD,TRNTOBED
          CALL      RDWARD1
.
          MOVE      TRNTOWRD,WWARD
          MOVE      TRNTOBED,WBED
          MOVE      AADMNO,WADMNO
          MOVE      ZERO,WPLUR
          CALL      UPWARD1
.
          MOVE      TRNTOWRD,AWARD
          MOVE      TRNTOBED,ABED
.
UPDWF999  RETURN
+
.------------------------------------------------------------
.         Write no bed file
.------------------------------------------------------------
.
WRNOBF00  MOVE      TRNTOWRD,NBWARD
          MOVE      AADMNO,NBADMNO
          MOVE      APLUR,NBPLUR
          MOVE      SP3,NBROOM
          MOVE      SP6,NBSPARE
          PACK      KEY13,NBWARD,NBADMNO,NBPLUR
          CALL      RANOBE1
          IF        OVRCD=1
            CALL      WRNOBE1
          ENDIF
.
          MOVE      TRNTOWRD,AWARD
          MOVE      TRNTOBED,ABED
.
WRNOBF99  RETURN
+
.------------------------------------------------------------
.    Update Patient on standby for ward/bed
.------------------------------------------------------------
.
UPDSTB00  PACK      KEY6,TRNTOWRD,TRNTOBED
          CALL      RDWARD1
.
          MOVE      AADMNO,WSTBY
          CALL      UPWARD1
.
          MOVE      SP3,AWARD
          MOVE      SP3,ABED
.
UPDSTB99  RETURN
+
.------------------------------------------------------------
.   Update patient to on leave
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
.
UPDOLV00  PACK      KEY14,SAVWARD,SAVBED,AADMNO
          CALL      RDONLV1
          IF        OVRCD=0
            GOTO      UPDOLV99
          ENDIF
          MOVE      SAVWARD,OWARD
          MOVE      SAVBED,OBED
          MOVE      AADMNO,OADMNO
          MOVE      TRNSRETN,OERDATE
          MOVE      TRNSRETT,OERTIME
          PACK      KEY14,OWARD,OBED,OADMNO
          CALL      WRONLV1
.
UPDOLV90  MOVE      ZERO,EXIT
          GOTO      UPDOLV99
.
UPDOLV95  MOVE      "On Leave patient exists for Ward/Bed",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
UPDOLV99  RETURN
+
.------------------------------------------------------------
.         Update Admission Record for Bed Trnsfer
.------------------------------------------------------------
.
UPDADM00  MOVE      ACARE,SAVACARE
          COMPARE   ZERO,CHGCARE            * Care Type Changed?
          GOTO      UPDADM10 IF EQUAL       * no
          MOVE      TRNACARE,ACARE          * yes
.
UPDADM10  MOVE      SAVADOC,ADOCTA
          MOVE      SAVATYP,ATYPE
          MATCH     "1",PTCNMFIN
          IF        @EQUAL
            MOVE      SAVACLM,ACLAIM  * CAR 288154
          ENDIF
          MOVE      AADMNO,KEY8
          CALL      UPLMISS1
          CALL      CHGNZ000           * acare changed - update nmds
.
          MATCH     ACARE,SAVACARE          * Is the Care Type Changed?
          GOTO      UPDADM99 IF EQUAL       * no
.
          CALL      CHCC0000                * yes-Update care class changes file
.
UPDADM99  RETURN
+
.------------------------------------------------------------
. UPSTBY00 - Update Stby pat in source ward/bed
. Returns:   EXIT 0 = Ok to continue
.                 1 = Error
.------------------------------------------------------------
.
UPSTBY00  MATCH     ZEROVISN,STBYPAT
          GOTO      UPSTBY90 IF EQUAL
.
          MOVE      STBYPAT,KEY8                     *Retrieve Standby Patient
          CALL      RDMISS1
          BRANCH    OVRCD,UPSTBY91
.
          MATCH     SP3,AWARD                        * Ward Empty?
          GOTO      UPSTBY91 IF NOT EQUAL
.
          COMPARE   ASTAT,TWO                        * Current Admission?
          GOTO      UPSTBY91 IF NOT EQUAL
.
          PACK      KEY6,STBYWRD,STBYBED             * Get Ward Detils
          CALL      RDWARD1
          BRANCH    OVRCD,UPSTBY91
.
          MATCH     AADMNO,WADMNO                    * Is Patient in ward?
          GOTO      UPSTBY10 IF EQUAL
.
          MOVE      AADMNO,WSTBY            * Put the patient on Standby
          CALL      UPWARD1
.
          MOVE      URNUMBER,SAVEURNO    * Populate U/R and admission cgi vars
          MOVE      ADMISSNO,SAVADMIS    * with the standby patient
          MOVE      AURNO,URNUMBER
          MOVE      AADMNO,ADMISSNO
.
          PROC      BBUP0000                * Bed Board
.
          MOVE      SAVEURNO,URNUMBER
          MOVE      SAVADMIS,ADMISSNO
.
          GOTO      UPSTBY90
.
UPSTBY10  MOVE      AADMNO,KEY8             * Update Admission Details
          CALL      RDPTMIS1
          BRANCH    OVRCD,UPSTBY91
.
          MOVE      STBYWRD,AWARD
          MOVE      STBYBED,ABED
          CALL      UPLMISS1
.
.         Reposition on the standby patient's last transfer record for this
.         admission and their PMI record before sending an A08 message
.
          MOVE      PURNO,SAVEKEY8          * save current patient
          MOVE      AURNO,KEY8              * get standby patient's PMI record
          CALL      RDMAST1
          BRANCH    OVRCD,UPSTBY20
.
          MOVE      AURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
          PACK      KEY8,AADMNO,SP70
          CALL      RDPTRES1
          IF        OVRCD=1
            CALL      CPTRE100
          ENDIF
.
UPSTBY20  PACK      KEY30,AADMNO,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,UPSTBY30
.
          MATCH     AADMNO,TADMN
          GOTO      UPSTBY30 IF NOT EQUAL
.
          CALL      PMIGTNID              * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      FIFTY2,HL7TRGID         * flag standby movement 
          MOVE      SP8,HL7INCLD
          MATCH     "1",PTCNABTS
          IF        @EQUAL
            PROC      DGCLICTR              * broadcast chng admis details A02
          ELSE
            PROC      DGCLICAC              * broadcast chng admis details A08
          ENDIF
.
UPSTBY30  MOVE      SAVEKEY8,KEY8           * reposition on original pt PMI
          CALL      RDMAST1
          BRANCH    OVRCD,UPSTBY91
.
          MOVE      SAVEKEY8,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MOVE      URNUMBER,SAVEURNO    * Populate U/R and admission cgi vars
          MOVE      ADMISSNO,SAVADMIS    * with the standby patient
          MOVE      AURNO,URNUMBER
          MOVE      AADMNO,ADMISSNO
.
          PROC      BBUP0000                * Bed Board
.
          MOVE      SAVEURNO,URNUMBER
          MOVE      SAVADMIS,ADMISSNO
.
UPSTBY90  MOVE      ZERO,EXIT
          GOTO      UPSTBY99
.
UPSTBY91  MOVE      "Error in admitting standby patient",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
UPSTBY99  RETURN
+
.------------------------------------------------------------
.         Write on leave record to Bed Transfer File
. Returns:  EXIT  0 = Ok to continue
.                 1 = Error
.------------------------------------------------------------
.
WRLBT000  MOVE      TRANDATE,TDATE
          MOVE      TRANTIME,TTIME
          MOVE      SAVWARD,TWARD
          MOVE      SAVBED,TBED
          MOVE      AADMNO,TADMN
          MOVE      AURNO,TURNO
          MOVE      SVTRATEF,TRATEF
          MOVE      SVTRATEH,TRATEH
          MOVE      ZERO,TRATEG
          MOVE      SVTDISC,TDISC
          MOVE      SVTALLW,TALLW
          MOVE      SAVBTYP,TRBTYP
          MOVE      STRBEND,TRBEND
.
          MOVE      SAVATYP,TATYPE
          MOVE      SAVACLM,PTTRCLTY
          MOVE      SAVADOC,TADOCT
          MOVE      STCHSTAT,TCHSTAT
          MOVE      SVTEXTRA,TEXTRA
.
          MOVE      "L",TMOVE
          MOVE      TRNLVTYP,PTTRLTYP
          MOVE      AADMNO,TADMN
          MOVE      ZERO,SECONDS
          MOVE      PASSCODE,PTTROPER         * operator Id
.
          MOVE      TRANSRCE,PTTRLTSC         *Contracted leave transfer source
          MOVE      ZERO,PTTREPSD
.
          PACK      KEY30,TADMN,TDATE,TTIME,TWARD,TBED,SP70
          PACK      PTTRCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTTRCDAT
          CLOCK     TIME,PTTRCTIM
          MOVE      WBSEUID,PTTRUCID
          UNPACK    SP70,TRCDATE,TRCTIME,PTTRUUID
.
          PACK      KEY30,TADMN,TDATE,TTIME,TWARD,TBED,SP70
          CALL      RDATRAN2
          IF        OVRCD=1
            CALL      WRTRAN2
          ELSE
            DISPLAY   "I*D transfer key WRLBT00 ",KEY30
          ENDIF
.
          CALL      LASF0000
          MOVE      ZERO,EXIT
.
          COMPARE   ONE,MHCNUSE
          GOTO      WRLBT200 IF NOT EQUAL
.
          MOVE      AADMNO,MHVIADMN
          PACK      KEY8,MHVIADMN
          CALL      RDMHVIS1
          BRANCH    OVRCD,WRLBT200
.
          MOVE      TWO,MHVISTAT                 * default to short term
          MATCH     SP70,PTTRLTYP
          GOTO      WRLBT150 IF EQUAL
.
          PACK      KEY5,ANST,ANSL,PTTRLTYP,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,WRLBT150
.
          MATCH     ANST,TCINDC1                  * trial leave
          IF        @EQUAL
            MOVE      THREE,MHVISTAT
          ENDIF
.
          MATCH     ANSH,TCINDC1                  * holiday leave
          IF        @EQUAL
            MOVE      FOUR,MHVISTAT
          ENDIF
.
          MATCH     ANSA,TCINDC1                  * A.W.O.L. leave
          IF        @EQUAL
            MOVE      FIVE,MHVISTAT
          ENDIF
.
WRLBT150  CALL      UPMHVIS1
.
.         Broadcast on-leave transaction
.
WRLBT200  MOVE      AURNO,KEY8              * first - get the PMI details
          CALL      RDMAST1
          BRANCH    OVRCD,WRLBT910
.
          MOVE      AURNO,KEY8
          CALL      RDPMPX21
          BRANCH    OVRCD,WRLBT910
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      FIVE,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICPO                * broadcast transfer mmsg  *C-90222
.
          MOVE      ZERO,EXIT
          GOTO      WRLBT999
.
WRLBT910  MOVE      ONE,EXIT
.
WRLBT999  RETURN
+
.------------------------------------------------------------
. DSCH0000 - Discharge
.------------------------------------------------------------
DSCH0000  BRANCH    FLDITMNO,DSCH0100,DSCH0200,DSCH0300,DSCH0400,DSCH0500:
                             DSCH0600,DSCH0700,DSCH0800,DSCH0900,DSCH1000:  *10
                             DSCH1100,DSCH1200,DSCH1300,DSCH1400,DSCH1500:
                             DSCH1600,DSCH1700,DSCH1800,DSCH1900,DSCH2000:  *20
                             DSCH2100,DSCH2200,DSCH2300,DSCH2400,DSCH2500:
                             DSCH2600,DSCH2700,DSCH2800,DSCH2900,DSCH3000:  *30
                             DSCH3100,DSCH3200,DSCH3300,DSCH3400,DSCH3500:
                             DSCH3600,DSCH3700,DSCH3800,DSCH3900,DSCH4000:  *40
                             DSCH4100,DSCH4200,DSCH4300,DSCH4400,DSCH4500:
                             DSCH4600,DSCH4700,DSCH4800,DSCH4900,DSCH5000:  *50
                             DSCH5100,DSCH5200,DSCH5300,DSCH5400,DSCH5500
.
DSCH0100  UNPACK    DIM127,D1,FLDPARA,DIM127
.
          REP       "+ ",ADMISSNO
          MOVE      ADMISSNO,KEY8
          PACK      KEY30,KEY8,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          IF        OVRCD=1
.           WRITE     HTMLFILE;">"
            GOTO      DSCH9999
          ENDIF
.
          MATCH     KEY8,TADMN
          IF        OVRCD=1
.           WRITE     HTMLFILE;">"
            GOTO      DSCH9999
          ENDIF
.
          PACK      BEDTRKEY,TADMN,TDATE,TTIME,TWARD,TBED
          WRITE     HTMLFILE;"action=patweb96.pbl method=post>":
                    "<input type=hidden name=reportno value=6>":
                    "<input type=hidden name=template value=",FLDPARA,">":
                          "<input type=hidden name=bedtrkey value=#"":
                          BEDTRKEY,"#">";
.
          GOTO      DSCH9999
.
DSCH0200  CALL      CDATE000
          GOTO      DSCH9999
.
DSCH0300  CALL      CTIME000
          GOTO      DSCH9999
.
DSCH0400  MOVE      "D ",CATEGORY
          CALL      CODSEL00
          GOTO      DSCH9999
.
DSCH0500  MOVE      "DD",CATEGORY
          CALL      CODSEL00
          GOTO      DSCH9999
.
DSCH0600  MOVE      "D1",CATEGORY
          CALL      CODSEL00
          GOTO      DSCH9999
.
DSCH0700  MOVE      "D2",CATEGORY
          CALL      CODSEL00
          GOTO      DSCH9999
.
DSCH0800  MOVE      "D3",CATEGORY
          CALL      CODSEL00
          GOTO      DSCH9999
.
DSCH0900  MOVE      "D4",CATEGORY
          CALL      CODSEL00
          GOTO      DSCH9999
.
DSCH1000  MOVE      "D5",CATEGORY
          CALL      CODSEL00
          GOTO      DSCH9999
.
DSCH1100  MOVE      SP5,KEY5
          CALL      RSPTVAD1
DSCH1110  CALL      RKPTVAD1
          BRANCH    OVRCD,DSCH9999
.
          WRITE     HTMLFILE;"<option value=",PTVACODE,">",PTVADESC,"</option>";
          GOTO      DSCH1110
.
DSCH1200  CALL      DTRS0000            *Transfer source selection list
          GOTO      DSCH9999
.
DSCH1300  MOVE      "EA",CATEGORY
          CALL      CODSEL00
          GOTO      DSCH9999
.
DSCH1400  MOVE      "DY",CATEGORY
          CALL      CODSEL00
          GOTO      DSCH9999
.
DSCH1500  MOVE      "VK",CATEGORY
          CALL      CODSEL00
          GOTO      DSCH9999
.
DSCH1600  MOVE      "VR",CATEGORY
          CALL      CODSEL00
          GOTO      DSCH9999
.
DSCH1700  MOVE      "LS",CATEGORY
          CALL      CODSEL00
          GOTO      DSCH9999
.
DSCH1800  MOVE      "VJ",CATEGORY
          CALL      CODSEL00
          GOTO      DSCH9999
.
DSCH1900  COMPARE   FOUR,ASTAT
          IF        @EQUAL
            CALL      DEFDT000
          ENDIF
          MOVE      CMM,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          MOVE      CYY,CYEAR
          REP       " 0",CYEAR
          MOVE      CDD,KEY2
          REP       " 0",KEY2
          WRITE     HTMLFILE;KEY2,SP1,MTHNAM3,SP1,CCC,CYEAR;
          GOTO      DSCH9999
.
DSCH2000  CLOCK     TIME,CTIMEIS
          COMPARE   FOUR,ASTAT
          IF        @EQUAL
            CALL      DEFDT000
          ENDIF
          WRITE     HTMLFILE;CTIMEIS;
          GOTO      DSCH9999
.
DSCH2100  CALL      MHDP0000                * I SRF 22731
          GOTO      DSCH9999
.
DSCH2200  READ      CONTROLF,HUND09;*195,PTCNACAS
          LOAD      CATEGORY,PTCNACAS,CATD1,CATD2,CATD3,CATD4,CATD5:
                                      CATU6,CATU7
.
          LOAD      CODE,PTCNACAS,DUSD1,DUSD2,DUSD3,DUSD4,DUSD5:
                                  AUSR6,AUSR7
          CALL      CODITM00
          GOTO      DSCH9999
.
DSCH2300  PACK      AGEDATE,ADATE
          CALL      CALCAGE                 * Calculate age as of admin date
          IF        PSAGEYRS<50
            WRITE     HTMLFILE;ZERO;             * < than 50 yrs old
          ELSE
            WRITE     HTMLFILE;ONE;              * > than 50 yrs old
          ENDIF
          GOTO      DSCH9999
.
DSCH2400  WRITE     HTMLFILE;PTCNHDPS;
          GOTO      DSCH9999
.
DSCH2500  WRITE     HTMLFILE;PTCNDEES;
          GOTO      DSCH9999
.
DSCH2600  MOVE      "LS",CATEGORY
          PACK      CODE,PMVXMHLS,SP70
          CALL      CODITM00
          GOTO      DSCH9999
.
DSCH2700  CALL      CHKBRD00                   * Check if boarder also admitted
          GOTO      DSCH9999

.
DSCH2800  CALL      CHKNBN00                   * check if newborn admitted
          GOTO      DSCH9999
.
DSCH2900  MATCH     SP70,ACLSSFT
          GOTO      DSCH9999 IF EQUAL
          GOTO      DSCH9999 IF EOS
.
          PACK      KEY5,ANSA,ANSC,ACLSSFT
          CALL      RDCODE1
          BRANCH    OVRCD,DSCH9999
.
          WRITE     HTMLFILE;TCINDC5;
          GOTO      DSCH9999
.
DSCH3000  MOVE      "SI",CATEGORY
          PACK      CODE,PTDSDPMN,SP70
          CALL      CODITM00
          GOTO      DSCH9999
.
DSCH3100  WRITE     HTMLFILE;PTDSLSDN;
          GOTO      DSCH9999
.
DSCH3200  WRITE     HTMLFILE;DDEST;
          GOTO      DSCH9999
.
DSCH3300  MATCH     SP70,ACARE
          GOTO      DSCH9999 IF EQUAL
          GOTO      DSCH9999 IF EOS
.
          PACK      KEY5,ANSC,ANSC,ACARE
          CALL      RDCODE1
          BRANCH    OVRCD,DSCH9999
.
          WRITE     HTMLFILE;TCINDC5;       * Mental Health indicator
          GOTO      DSCH9999
.
DSCH3400  MOVE      "AC",CATEGORY
          PACK      CODE,ACLSSFT,SP70
          CALL      CODITM00
          GOTO      DSCH9999
.
DSCH3500  CALL      GETHRD00
          BRANCH    EXIT,DSCH9999
.
          WRITE     HTMLFILE;ONE;
          GOTO      DSCH9999
.
DSCH3600  CALL      GETHRD00
          BRANCH    EXIT,DSCH9999
.
          WRITE     HTMLFILE;PMHRRSTA;
          GOTO      DSCH9999
.
DSCH3700  CALL      GETHRD00
          BRANCH    EXIT,DSCH9999
.
          WRITE     HTMLFILE;PMHRHOSP;
          GOTO      DSCH9999
.
DSCH3800  CALL      GETHRD00
          BRANCH    EXIT,DSCH9999
.
          WRITE     HTMLFILE;PMHRWARD;
          GOTO      DSCH9999
.
DSCH3900  CALL      GETHRD00
          BRANCH    EXIT,DSCH9999
.
          WRITE     HTMLFILE;PMHRBEDD;
          GOTO      DSCH9999
.
DSCH4000  CALL      CMHF0000           * Check for Incomplete field MH details
          WRITE     HTMLFILE;F1;
          GOTO      DSCH9999
.
DSCH4100  PACK      KEY6,ADOCTA,SP6
          CALL      RDDOCT1                 * Read the doctors file
          BRANCH    OVRCD,DSCH9999
.
          MATCH     SP3,DRTYPE
          GOTO      DSCH9999 IF EQUAL
.
          PACK      KEY5,ANSD,ANST,DRTYPE,SP70
          CALL      RDCODE1                 * Read the codes file
          BRANCH    OVRCD,DSCH9999
.
          MATCH     PYAA,THCSCOD
          GOTO      DSCH9999 IF LESS        * < PYAA
.
          MATCH     THCSCOD,PYZZ
          GOTO      DSCH9999 IF LESS        * PYZZ <
.
          WRITE     HTMLFILE;ONE;           * MH attending doctor

          GOTO      DSCH9999
.
DSCH4200  UNPACK    DIM127,D1,KEY3,DIM127
          MOVE      KEY3,FLDITMNO
          CALL      QMHD0000                * QLD MH Details
          GOTO      DSCH9999
.
DSCH4300  CALL      DDPS0000                * Default functionality for
          GOTO      DSCH9999                * Discharge Payment Status
.
DSCH4400  CALL      ATRFB000
          GOTO      DSCH9999
.
DSCH4500  PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMWOR1
          BRANCH    OVRCD,DSCH9999
.
          MATCH     SP70,PMWOEDAT
          GOTO      DSCH9999 IF EQUAL
.
          UNPACK    PMWOEDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
.
          GOTO      DSCH9999
.
DSCH4600  MOVE      "ZS",CATEGORY
          MOVE      SP70,CODE
          CALL      CODITM00
          GOTO      DSCH9999
.
DSCH4700  MOVE      ADMISSNO,VSXDC001       * Visit Number
          MOVE      TWO,VSTYPIND            * Type of Data
          MOVE      ONE,VSDATIND            * Date Field index (1-10)
          CALL      GETVDT00
          MATCH     SP70,VSDATVAL
          IF        !@EQUAL
            UNPACK    VSDATVAL,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          ENDIF
          GOTO      DSCH9999
.
DSCH4800  PACK      CMPAVALU,SP70,SP70,SP70,SP70
          MOVE      "PTCNPDTM",CPARPARM
          MOVE      IBCNMHOS,CPARMHOS
          MOVE      USERID,CPARUSER
          CALL      GTCMPA00
          BRANCH    CPARERRO,DSCH4809
.
DSCH4809  MOVE      CMPAVALU,DIM8
          WRITE     HTMLFILE;DIM8;
          GOTO      DSCH9999
.
DSCH4900  MOVE      ANSA,MOVETYPE
          CALL      WBDTYI00
          GOTO      DSCH9999
.
DSCH5000  MOVE      ANSA,MOVETYPE
          CALL      WRMTYI00
          GOTO      DSCH9999
.
DSCH5100  MOVE      ANSD,MOVETYPE
          CALL      WBDTYI00
          GOTO      DSCH9999
.
DSCH5200  MOVE      ANSD,MOVETYPE
          CALL      WRMTYI00
          GOTO      DSCH9999
.
DSCH5300  CALL      ATRFC000
          GOTO      DSCH9999
.
DSCH5400  CALL      ATRFA000 
          GOTO      DSCH9999
.
DSCH5500  MOVE      ADMISSNO,VSXDC001       * Visit Number
          MOVE      TWO,VSTYPIND            * Type of Data
          MOVE      TWO,VSCODIND            * Code Field index (1-10)
          CALL      GETVCV00
.
          MATCH     SP70,VSCODVAL
          IF        !@EQUAL
            WRITE     HTMLFILE;VSCODVAL;
          ENDIF
          GOTO      DSCH9999
.
DSCH9999  RETURN
.
.-------------------------------------------------------------------------------
. Get latest pattranf for admissno/movement type
.-------------------------------------------------------------------------------
GPTTRN00  PACK      KEY30,ADMISSNO,Z70
          CALL      RDSTRAN2                     * position on admission number
GPTTRN20  CALL      RDPTRAN2                     * read previous record
          BRANCH    OVRCD,GPTTRN80
.
          MATCH     ADMISSNO,DTADMN              * same admission still ?
          GOTO      GPTTRN80 IF NOT EQUAL        * no - finished
.
          MATCH     MOVETYPE,TMOVE
          GOTO      GPTTRN20 IF NOT EQUAL
.
          GOTO      GPTTRN99
.
GPTTRN80  CALL      CLPATTRN
.
GPTTRN99  RETURN
.
.-------------------------------------------------------------------------------
. Write out ward bed type indictator 11
.-------------------------------------------------------------------------------
WBDTYI00  MOVE      SP70,DIM1 
          CALL      GPTTRN00
.
          MATCH     SP70,TWARD
          GOTO      WBDTYI08 IF EQUAL
.
          PACK      KEY6,TWARD,TBED,SP70
          MATCH     SP70,KEY6
          GOTO      WBDTYI08 IF EQUAL
.
          CALL      RDWARD1
          BRANCH    OVRCD,WBDTYI08
.
          MATCH     SP70,WEFRBT
          GOTO      WBDTYI08 IF EQUAL
.
          MOVE      "BT",CATEGORY
          MOVE      WEFRBT,CODE
          CALL      GETCOD00
          MOVE      TCINDC11,DIM1
.
WBDTYI08  SQUEEZE   DIM1
          WRITE     HTMLFILE;DIM1;
.
WBDTYI09  RETURN
.
.-------------------------------------------------------------------------------
. Write out ward room type indictator 7
.-------------------------------------------------------------------------------
WRMTYI00  MOVE      SP70,DIM1
          CALL      GPTTRN00
.
          MATCH     SP70,TWARD
          GOTO      WRMTYI08 IF EQUAL
.
          PACK      KEY6,TWARD,TBED,SP70
          MATCH     SP70,KEY6
          GOTO      WRMTYI08 IF EQUAL
.
          CALL      RDWARD1
          BRANCH    OVRCD,WRMTYI08
.
          MATCH     SP70,WRTYPE
          GOTO      WRMTYI08 IF EQUAL
.
          MOVE      "RT",CATEGORY
          MOVE      WRTYPE,CODE
          CALL      GETCOD00
          MOVE      TCINDC7,DIM1
.
WRMTYI08  SQUEEZE   DIM1
          WRITE     HTMLFILE;DIM1;
.
WRMTYI09  RETURN
+
.-------------------------------------------------------------------------------
. Check for Incomplete field for this visit
. return : F1 =0 - Not a Current MH Visit
.          F1 =1 - Prev MH Visit exists, but Current adm. has No MH details
.          F1 =2 - No Prev MH Visit exists, but Current adm. has some MH details
.-------------------------------------------------------------------------------
CMHF0000  MOVE      ZERO,F1
          CALL      CKMH0000             * Check for MH Visit
          BRANCH    F2,CMHF9999          * Not a MH visit
.
.         Current MH Visit
.
          CALL      PRMH0000             * Check for previous MH
          COMPARE   ZERO,EXIT
          GOTO      CMHF3000 IF EQUAL    * Prev MH Visit exist
.
          MOVE      TWO,F1               * No Prev.MH Visit for Current MH Visit
          GOTO      CMHF4000
.
CMHF3000  MOVE      ONE,F1               * to display MH visit list
.
CMHF4000  MOVE      ADMISSNO,KEY8
          CALL      RDPTQMH1
          BRANCH    OVRCD,CMHF9999
.
          PACK      KEY7,PTQMTOUA,PTQMEMPS,PTQMPSNS,PTQMPRMS:
                         PTQMRTFC,PTQMMLSI,PTQMPSNT,SP70
          MATCH     SP70,KEY7
          GOTO      CMHF9999 IF EQUAL     * All fields blank/incomplete
.
          MATCH     SP70,PTQMTOUA
          GOTO      CMHF8000 IF EQUAL
          MATCH     SP70,PTQMEMPS
          GOTO      CMHF8000 IF EQUAL
          MATCH     SP70,PTQMPSNS
          GOTO      CMHF8000 IF EQUAL
          MATCH     SP70,PTQMPRMS
          GOTO      CMHF8000 IF EQUAL
          MATCH     SP70,PTQMRTFC
          GOTO      CMHF8000 IF EQUAL
          MATCH     SP70,PTQMMLSI
          GOTO      CMHF8000 IF EQUAL
          MATCH     SP70,PTQMPSNT
          GOTO      CMHF8000 IF EQUAL
.
          MOVE      ZERO,F1              * All fields are Completed
          GOTO      CMHF9999
.
CMHF8000  MOVE      TWO,F1               * Some field incomplete
CMHF9999  RETURN
+
.--------------------------------------------------------------------------
.         Check for previous Mental health visit
. return : EXIT =1 - No Previous MH Visit
.          EXIT =0 - Prev MH Visit exists
.--------------------------------------------------------------------------
PRMH0000  MOVE      ONE,EXIT                * default to No Prev.MH Visit
          MOVE      ADMISSNO,DIM8A          * save admission number
          MOVE      " 3",KEY2               * Inpatient
          PACK      KEY26,URNUMBER,KEY2,SP70
          CALL      RDSVISA4
PRMH1000  CALL      RDKVISA4
          BRANCH    OVRCD,PRMH8000
.
          MATCH     URNUMBER,PVIURNO
          GOTO      PRMH8000 IF NOT EQUAL   * Different U/R
.
          COMPARE   THREE,PVITYPE
          GOTO      PRMH8000 IF NOT EQUAL   * Not an Inpatient visit
.
          MOVE      PVIBILL,KEY8
          MATCH     DIM8A,KEY8
          GOTO      PRMH1000 IF EQUAL       * Skip Current Visit
          CALL      RDMISS1
          BRANCH    OVRCD,PRMH1000          * Invalid admission no
.
          CALL      CKMH0000                * Check for MH Visit
          BRANCH    F2,PRMH1000             * Not a MH visit
.
          MOVE      ZERO,EXIT               * Prev MH Visit exists
          GOTO      PRMH9000
.
PRMH8000  MOVE      ONE,EXIT                * No Pev MH Visit
.
PRMH9000  MOVE      DIM8A,ADMISSNO          * Restore admission no
          CALL      RDVISA1
          CALL      RDMISS1
.
PRMH9999  RETURN
+
.------------------------------------------------------------
.         Check for MH patient
.------------------------------------------------------------
CKMH0000  MOVE      ONE,F2
          PACK      KEY6,ADOCTA,SP6
          CALL      RDDOCT1                 * Read the doctors file
          BRANCH    OVRCD,CKMH9999
.
          MATCH     SP3,DRTYPE
          GOTO      CKMH9999 IF EQUAL
.
          PACK      KEY5,ANSD,ANST,DRTYPE,SP70
          CALL      RDCODE1                 * Read the codes file
          BRANCH    OVRCD,CKMH9999
.
          MATCH     PYAA,THCSCOD
          GOTO      CKMH9999 IF LESS        * < PYAA
.
          MATCH     THCSCOD,PYZZ
          GOTO      CKMH9999 IF LESS        * PYZZ <
.
          MOVE      ZERO,F2                 * MH patient
.
CKMH9999  RETURN
+
.------------------------------------------------------------
. Default to on leave date and time
.------------------------------------------------------------
.
DEFDT000  MOVE         TWO,MINADD
          MOVE         ONE,ADDFLAG
          PACK         KEY30,ADMISSNO,Z70
          CALL         RDSTRAN2
          CALL         RDPTRAN2
          BRANCH       OVRCD,DEFDT999
.
          UNPACK       TTIME,CHOUR,ANS,CMIN
          MOVE         CHOUR,FORM2
          MOVE         FORM2,FORM4D
          MULT         "60",FORM4D
          MOVE         CMIN,FORM2
          ADD          FORM2,FORM4D     *this is now the total time in minutes
          IF           ADDFLAG=1
            ADD          MINADD,FORM4D          *add minutes
          ELSE
            SUB          MINADD,FORM4D          *subtract minutes
          ENDIF
.
          IF           FORM4D>1440
            SUB         "1440",FORM4D     *the time now goes over the next day
            UNPACK       TDATE,CCENT,CYEAR,CMON,CDAY
            MOVE         CCENT,CC
            MOVE         CYEAR,YY
            MOVE         CMON,MM
            MOVE         CDAY,DD
            CALL         DMYCON
            ADD          ONE,JULDAY
            MOVE         JULDAY,JWKDAY
            MOVE         JULYR,JWDYER
            MOVE         JULCC,JWKCC
            CALL         JULCON
            PACK         TDATE,CC,YY,MM,DD
            REP          " 0",TDATE
          ENDIF
          MOVE         FORM4D,SFORM4D           *save the total time
.
          ASSIGN       FORM4D/SIXTY,FORM4D
          MOVE         FORM4D,F2
          MOVE         F2,CHOUR
          REP          " 0",CHOUR
          ASSIGN       FORM4D*SIXTY,FORM4D
          ASSIGN       (SFORM4D-FORM4D),SFORM4D
          MOVE         SFORM4D,F2
          MOVE         F2,CMIN
          REP          " 0",CMIN
          PACK         TTIME,CHOUR,COLON,CMIN
          UNPACK       TDATE,CCENT,CYEAR,CMON,CDAY
          MOVE         CDAY,CDD
          MOVE         CMON,CMM
          MOVE         CYEAR,CYY
          MOVE         CCENT,CCC
          PACK         CTIMEIS,TTIME,COLON,ZERO,ZERO
.
DEFDT999  RETURN
+
.------------------------------------------------------------
. CKDSCP00 - Check Patient is not already discharged
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
.
CKDSCP00  CALL      CLRDIS00
.
          UNPACK    ADMISSNO,KEY8
          CALL      RDDSCH1
          IF        UPDATETY=1
            BRANCH    OVRCD,CKDSCP91
          ENDIF
          BRANCH    OVRCD,CKDSCP80
.
          IF        UPDATETY=1
...         CALL      MHLS0000                * Get MH Legal status if any
            GOTO      CKDSCP90
          ENDIF
.
          GOTO      CKDSCP93
.
CKDSCP80  PACK      KEY8,ADMISSNO
          CALL      RDMISS1
          BRANCH    OVRCD,CKDSCP92
.
          IF        ASTAT<>2 & ASTAT<>4
            GOTO      CKDSCP92
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMHVIS1
          IF        OVRCD=1
            CALL      CLMEHVIS
          ENDIF
.
          MATCH     SP70,ACLSSFT
          IF        !@EQUAL & !@EOS
            PACK      KEY5,ANSA,ANSC,ACLSSFT,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MATCH     ANSP,TCINDC5
              GOTO      CKDSCP90 IF NOT EQUAL
            ENDIF
          ENDIF
.
...       CALL      MHLS0000                * Get MH Legal status if any
.
          BRANCH    PTCNMLEG,CKDSCP90
.
          MOVE      AADMNO,KEY8
          CALL      RDMHVIS1
          BRANCH    OVRCD,CKDSCP90
.
          MOVE      ZERO,F1
          PACK      KEY32,URNUMBER,SP70
          CALL      RSMHDLS1
CKDSCP85  CALL      RKMHDLS1
          BRANCH    OVRCD,CKDSCP94
          MATCH     URNUMBER,MHDLURNO      * Same U/R number ?
          GOTO      CKDSCP94 IF NOT EQUAL  * No
.
          MATCH     "0",MHDLACTV           * is it "active"           *I-210958
          IF        !@EQUAL
            MOVE      ONE,F1
            GOTO      CKDSCP85             * check for another record
          ENDIF                                               * end   *I-210958
.
          MATCH     SP8,MHDLEDAT           * is it "ended"            *I-218150
          GOTO      CKDSCP90 IF EQUAL
.
          CALL      IBACLOCK               * check Date/Time is later than now
          PACK      DIM8A,CCC,CYY,CMM,CDD
          REP       " 0",DIM8A
          CLOCK     TIME,DIM8B
          MATCH     MHDLEDAT,DIM8A
          IF        @LESS
            GOTO      CKDSCP90
          ENDIF
.
          IF        @EQUAL
            MATCH     MHDLETIM,DIM8B
            IF        !@LESS
              MOVE      ONE,F1
              GOTO      CKDSCP85           * check for another record
            ELSE
              GOTO      CKDSCP90
            ENDIF
          ENDIF                                               * end   *I-218150
.
          MOVE      ONE,F1
          GOTO      CKDSCP85
.
CKDSCP90  MOVE      ZERO,EXIT
          GOTO      CKDSCP99
.
CKDSCP91  MOVE      "Patient is not Discharged",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CKDSCP99
.
CKDSCP92  MOVE      "Patient is not currently admitted",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CKDSCP99
.
CKDSCP93  MOVE      "Patient Already Discharged",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CKDSCP99
.
CKDSCP94  IF        F1 = 0
            MOVE     "MH Patient must have Legal Status record.",WEBTITLE
          ELSE
            MOVE     "MH Patient must have active Legal Status record.",WEBTITLE
          ENDIF
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CKDSCP99
.
CKDSCP99  RETURN
+
.------------------------------------------------------------
.         Check for MH Legal status
.------------------------------------------------------------
MHLS0000  PACK      KEY21,ADMISSNO,Z70
          CALL      RSMHLEG1                * position after last record
          CALL      RPMHLEG1                * read previous record
          BRANCH    OVRCD,MHLS9000
.
          MATCH     ADMISSNO,DMHLEADM
          GOTO      MHLS9999 IF EQUAL
.
MHLS9000  CALL      CLMEHLEG
MHLS9999  RETURN
+
.------------------------------------------------------------
. UPDF0000 - Update Patient Discharge
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
.
UPDF0000  REP       "+ ",BEDTRKEY
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
          MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,UPDF9300
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MOVE      PCEASE,EDWPCEAS         * Save deceased status for EDWARD
.
          MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,UPDF9400
.
          CALL      CHKDDS00
          BRANCH    EXIT,UPDF9999
.
          MOVE      ADMISSNO,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD,UPDF9500
.
          MOVE      ADMISSNO,KEY8
          CALL      RDPMVX11
          BRANCH    OVRCD,UPDF9600
.
          PACK      OLDDEATH,PDECDTE,PTMAUKDD,PMPXDETY,PTMADCNO,SP70 *Death det.
.
          MATCH     "Cancel",FORMACTN
          GOTO      UPDF9000 IF EQUAL
          MATCH     "Discharge",FORMACTN
          GOTO       UPDF0010 IF EQUAL
          MATCH     "Update",FORMACTN
          GOTO       UPDF0010 IF EQUAL
.
          GOTO      UPDF9800
.
UPDF0010  CALL      CITM0000                * Check if any item tobe invoiced
          BRANCH    EXIT,UPDF9200
.
          CALL      CDHS0000                * Check discharge hospital
          BRANCH    EXIT,UPDF9900
.
          CALL      CHKMFL00                * Check mandatory fields
          BRANCH    EXIT,UPDF9900
.
          CALL      CHKSEP00                * Check separation referral
          BRANCH    EXIT,UPDF9900
.
          CALL      CTSF0000                * Check Separation Referral and
          BRANCH    EXIT,UPDF9900           * Care Type                 *I-49016
.
          CALL      CHKDAT00                * Check time not in the future
          BRANCH    EXIT,UPDF9900
.
          CALL      CONTUR00
          BRANCH    EXIT,UPDF9900
.
          CALL      CHKCAR00                * Check carer available
          BRANCH    EXIT,UPDF9900
.
          CALL      CTSM0000                * Check care type to Sep Mode
          BRANCH    EXIT,UPDF9900
.
          CALL      CHKINT00                * Check intention to readmit
          BRANCH    EXIT,UPDF9900
.
          COMPARE   ONE,UPDATETY
          IF        !@EQUAL
            CALL      CHKBTR00              * Check bed transfer key
            BRANCH    EXIT,UPDF9900
            CALL      CHKDSC00              * Check not already dishcarged
            BRANCH    EXIT,UPDF9900
          ENDIF
.
          CALL      CTRN0000                * Check transfer source
          BRANCH    EXIT,UPDF9900
.
          CALL      CHKMEH00                * Check mental health patient
          BRANCH    EXIT,UPDF9900
.
          BRANCH    UPDATETY,UPDF0050
.
          CALL      WBMHMS00                * Upd. ward bed file /MHMS adjust
          BRANCH    EXIT,UPDF9900
.
UPDF0050  IF        UPDATETY=1
            CALL     USTATD00                 * Update statistical discharge
.
            PACK       KEY8,ADMISSNO,SP70
            CALL       RDDSCH1
            IF         OVRCD<>1
              PACK       SAVDSTAT,DSTAT,SP70
            ENDIF
          ENDIF
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPMVX11
          IF        OVRCD<>1
            MOVE      TRNSREAS,PMVXUD12
            CALL      UPPMVX11
          ENDIF
.
          MATCH     "1",PTCNEXDD
          IF        @EQUAL
            MATCH     "1",HEAONLYF
            IF        @EQUAL
              CALL      WRPATR00
            ENDIF  
          ENDIF
          CALL      WRPATR10
.
          CALL      WRPATR20                * Write Reason for Discharge delay
.
          CALL      WRDS0000                * Write Discharge Record
          MOVE      "16 ",ALTTYPE
          MOVE      SP70,ALTOLDVL
          MOVE      SP70,ALTNEWVL
          CALL      WEAL0000                * Write EDWARD alteration record
.
          CALL      PTQMH000                * QLD HDP MH
.
          COMPARE   "6",PTCNHDPS            * Special wahealth Assessment stuff
          GOTO      UPDF0060 IF NOT EQUAL
.
          PACK      KEY24,ADMISSNO,Z70
          CALL      RSPMRUG1
UPDF0055  CALL      RPPMRUG1
          BRANCH    OVRCD,UPDF0060

          MATCH     "1",PMRUDELF
          GOTO      UPDF0055 IF EQUAL  
.
          MATCH     ADMISSNO,PMRUVISN
          GOTO      UPDF0060 IF NOT EQUAL
.
          MATCH     SP8,PMRUPEDT
          IF        @EQUAL
            MOVE      DDATE,PMRUPEDT
            CALL      UPPMRUG1
          ENDIF
.
UPDF0060  BRANCH    EXIT,UPDF9900
.
          CALL      GTRNS000                * Generate Discharge Transfer Record
          BRANCH    EXIT,UPDF9900
.
          CALL      UPADMN00                * Update Admission/Master/NHOSDAYS
.
.         Make sure that we have the discharge pattranf record, before
.         triggering a message
.
          PACK      KEY30,ADMISSNO,ZEDS
          CALL      RDSTRAN2                     * position after admission no.
          CALL      RDPTRAN2                     * read previous record
          BRANCH    OVRCD,UPDF9100               * eof - error
.
          MATCH     ADMISSNO,DTADMN              * same admission still ?
          GOTO      UPDF9100 IF NOT EQUAL        * no - error
.
          MATCH     ANSD,TMOVE                   * discharge record ?
          GOTO      UPDF9100 IF NOT EQUAL        * no - error
.
          CALL      DEADST00                * Check for deceased indicators
.
          PACK      KEY30,PDECDTE,PTMAUKDD,PMPXDETY,PTMADCNO,SP70 *Death det.
          MATCH     KEY30,OLDDEATH
          IF        !@EQUAL
            MOVE      "001",D3
            CALL      WDAU0000              * Write to Death details audit file
          ENDIF
.
          CALL      UPLMAST1                * Update Master file
.
          CALL      DEAPOL00                * Update Patient Death Polling Table
.
          IF        EDWPCEAS = 0 & PCEASE = 1
            CALL      EDWD0000              * EDWARD deceased trigger
          ENDIF 
.
.         Broadcast Datagate Message
.
          MATCH     "Discharge",FORMACTN
          IF        @EQUAL
            CALL      PMIGTNID              * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            IF        ONLEAVE=1
              MOVE      FIFTY3,HL7TRGID
            ELSE
              MOVE      TEN6,HL7TRGID
            ENDIF
            MOVE      SP8,HL7INCLD
            PROC      DGCLICDS              * send discharge notif'n
.
            IF        CHOSTYP=1 & CFEETYP=0
              MOVE      "4",PTIPRSTA        * Update Discharge
              MOVE      TDATE,PENDSDAT      * as at date
              CALL      CINVP000            * Check for tobe invoiced
            ENDIF
          ENDIF
.
          MOVE      ONE,UPEMFLAG            * Flag set to discharge
          CALL      UPDEM000                * Update if Emergency patient
.
          COMPARE   ONE,UPDATETY
          IF        !@EQUAL
            CALL      STLMEH00              * Check if still Mental Health
          ENDIF
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPTRES1
          IF        OVRCD=1
            CALL      CPTRE100
          ELSE
            CALL      PRAD0000              * Update PRFA details
          ENDIF
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      SIX,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICUP                * write PMI changes to DG  *C-90222
.
          CALL      UPDCFR00                * Update Control file
.
          CALL      RMPLT000                * Remove Patient Location Record
.
          CALL      CMIX0000                * Check Casemix / MHMS Adjust
.
          CALL      DELPAT00                * Update Current Patient Search
.                                           * I CAR 23608
.
          MOVE      FOUR,UPBMSTAT
          CALL      UPPBMD00                * Update Bed Management file
.
          CALL      CHKSTB00                * Check for Standby Patient
          BRANCH    EXIT,UPDF9900
.
          PROC      BBUP0000                * Bed Board
.
          MATCH     "1",PTCNCHOD
          IF        @EQUAL
            MATCH     "1",NOTIFYHS
            IF        @EQUAL
              CALL      HREQ0000            * Housekeeping request
            ENDIF
          ENDIF
.
UPDF8000  PROC      CALCCODE                * Recalculate hrs of ICU/NCU/CCU
.
          CALL      UPDBRD00                * Update Boarders
.
          PROC      WRWATR00              * write to WA triggers table
.
UPDF9000  MOVE      AADMNO,KEY8
          CALL      UUPTMIS1
          MOVE      AURNO,KEY8
          CALL      UUPTMAS1
.
.          MATCH     "1",PTCNUNET
.          IF        @EQUAL
.            MOVE      "01",KEY2                 * IHI Validation
.            PACK      KEY11,WBSEUID,SP70        * User ID
.            PACK      KEY50,URNUMBER,SP70
.            CALL      WIPL0000                  * Write to polling table
.          ENDIF
.
          IF        UPDATETY=1
            MATCH     SAVDSTAT,DSTAT
            IF        !@EQUAL
              CALL      CHGNZ000            * check if NMDS fields updated
            ENDIF
          ENDIF
.
          MATCH     SP70,DSCHINGP
          IF        !@EQUAL
            MOVE      DSCHINGP,PMVXINGP
            CALL      UPPMVX11
          ENDIF
.
.         MATCH     "Discharge",FORMACTN
.         IF        @EQUAL
.           PACK      KEY5,ANSD,ANSD,DDEST,SP70  * Check Discharge Destination
.           CALL      RDCODE1
.           IF        OVRCD=0
.             MATCH     ANSD,TCINDC1             * Discharged as deceased?
.             IF        @EQUAL
.               CALL      SCHFAX00               * Schedule fax
.               GOTO      UPDF9005
.             ENDIF
.           ENDIF
.         ENDIF
.
          MATCH     "1",FAXITFLG
          CALL      SCHFAX00 IF EQUAL
.
          CALL      UPNBR000
.
          CALL      EXNB0000                  * Excluded newborn
          IF        EXIT=1
            PACK      KEY8,ADMISSNO,SP70
            CALL      DEIPEN1
          ENDIF
.
          CALL      UXDC0000      * Update visxdcaf extra discharge details
.
UPDF9005  MOVE      ZERO,EXIT
          GOTO      UPDF9999
.
UPDF9100  MOVE      "Can't Find Discharge Transfer record",WEBTITLE
          CALL      WEBERR00
          MOVE      ADMISSNO,KEY8
          CALL      UUPTMIS1
          MOVE      AURNO,KEY8
          CALL      UUPTMAS1
          MOVE      ONE,EXIT
          GOTO      UPDF9999
.
UPDF9200  MOVE      "Found Items to be invoiced after Discharge Date",WEBTITLE
          CALL      WEBERR00
          MOVE      AADMNO,KEY8
          CALL      UUPTMIS1
          MOVE      AURNO,KEY8
          CALL      UUPTMAS1
          MOVE      ONE,EXIT
          GOTO      UPDF9999
.
UPDF9300  MOVE      "Can't Find U/R",WEBTITLE
          CALL      WEBERR00
          MOVE      AADMNO,KEY8
          CALL      UUPTMIS1
          MOVE      AURNO,KEY8
          CALL      UUPTMAS1
          MOVE      ONE,EXIT
          GOTO      UPDF9999
.
UPDF9400  MOVE      "Invalid admission",WEBTITLE
          CALL      WEBERR00
          MOVE      AADMNO,KEY8
          CALL      UUPTMIS1
          MOVE      AURNO,KEY8
          CALL      UUPTMAS1
          MOVE      ONE,EXIT
          GOTO      UPDF9999
.
UPDF9500  MOVE      "Invalid visit record",WEBTITLE
          CALL      WEBERR00
          MOVE      AADMNO,KEY8
          CALL      UUPTMIS1
          MOVE      AURNO,KEY8
          CALL      UUPTMAS1
          MOVE      ONE,EXIT
          GOTO      UPDF9999
.
UPDF9600  MOVE      "Missing visit extension record",WEBTITLE
          CALL      WEBERR00
          MOVE      AADMNO,KEY8
          CALL      UUPTMIS1
          MOVE      AURNO,KEY8
          CALL      UUPTMAS1
          MOVE      ONE,EXIT
          GOTO      UPDF9999
.
UPDF9800  MOVE      "INVALID FORM ACTION",WEBTITLE
          CALL      WEBERR00
UPDF9900  MOVE      AADMNO,KEY8
          CALL      UUPTMIS1
          MOVE      AURNO,KEY8
          CALL      UUPTMAS1
          MOVE      ONE,EXIT
          GOTO      UPDF9999
.
UPDF9999  RETURN
.
.------------------------------------------------------------------------------
. Write patatraf for discharge - Healthscope only 
.------------------------------------------------------------------------------
WRPATR00  CALL      CLPATATR
.
          MOVE      URNUMBER,PTARURNO
          MOVE      ADMISSNO,PTARVISN
          MOVE      TRANDATE,PTARDATE
          MOVE      TRANTIME,PTARTIME
          MOVE      "024",PTARTYPE
          MOVE      REAEXPDS,PTARCOD1
.
          MOVE      "0",PTARDELR
          CALL      IBACLOCK
          PACK      PTARCDTE,CCC,CYY,CMM,CDD
          REP       " 0",PTARCDTE
          CLOCK     TIME,PTARCTME
          MOVE      USERID,PTARCUSR
.
          PACK      KEY35,PTARURNO,PTARVISN,PTARDATE,PTARTIME,PTARTYPE,SP70
          CALL      WRPTATR2
.
. Write Edward type 24
.
.          MOVE      "24 ",ALTTYPE
.          MOVE      SP70,ALTOLDVL
.          MOVE      SP70,ALTNEWVL
.          CALL      WEAL0000                * Write EDWARD alteration record
.
WRPATR09  RETURN
.
.------------------------------------------------------------------------------
. Write patatraf for discharge - Late Discharge Reason/comments 
.------------------------------------------------------------------------------
WRPATR10  MATCH     SP70,PTCNDPTM
          GOTO      WRPATR19 IF EQUAL
.
          MATCH     SP70,LTDSRESN
          GOTO      WRPATR19 IF EQUAL
.
          MOVE      "024",DIM3
          PACK      KEY35,URNUMBER,ADMISSNO,TRANDATE,TRANTIME,DIM3,SP70
          CALL      RDPTATR2
          BRANCH    OVRCD,WRPATR15
.
          MOVE      LTDSRESN,PTARCOD2
          PACK      PTARTXT2,LTDSCOM1,LTDSCOM2,SP70
          CALL      UPPTATR2 
.
          GOTO      WRPATR19
.        
WRPATR15  CALL      CLPATATR
.
          MOVE      URNUMBER,PTARURNO
          MOVE      ADMISSNO,PTARVISN
          MOVE      TRANDATE,PTARDATE
          MOVE      TRANTIME,PTARTIME
          MOVE      "024",PTARTYPE
          MOVE      LTDSRESN,PTARCOD2
          PACK      PTARTXT2,LTDSCOM1,LTDSCOM2,SP70
.
          MOVE      "0",PTARDELR
          CALL      IBACLOCK
          PACK      PTARCDTE,CCC,CYY,CMM,CDD
          REP       " 0",PTARCDTE
          CLOCK     TIME,PTARCTME
          MOVE      USERID,PTARCUSR
.
          PACK      KEY35,PTARURNO,PTARVISN,PTARDATE,PTARTIME,PTARTYPE,SP70
          CALL      WRPTATR2
.
WRPATR19  RETURN
.
.------------------------------------------------------------------------------
. Write patatraf for discharge - Reason for discharge delay (028)
.------------------------------------------------------------------------------
WRPATR20  MATCH     SP70,PTDSC003
          GOTO      WRPATR25 IF EQUAL
.
          MOVE      "028",DIM3
          CALL      GPTATR00                   * Get if patatraf exist
          IF        EXIT = 1
            CALL     NWPATR00
            GOTO     WRPATR29 
          ENDIF
.           
WRPATR22  MATCH     PTARCOD1,PTDSC005          * data changes
          GOTO      WRPATR23 IF NOT EQUAL
.
          MATCH     PTARCOD2,PTDSC006
          GOTO      WRPATR23 IF NOT EQUAL
.
          MATCH     PTARTXT1,PTDSC003
          GOTO      WRPATR23 IF NOT EQUAL
.
          MATCH     PTARTXT2,PTDSC004
          GOTO      WRPATR23 IF NOT EQUAL
.
          GOTO      WRPATR29 
.
WRPATR23  CALL      TOPATR00
          CALL      NWPATR00
.
          GOTO      WRPATR29
.
. Reason for discharge delay delete
.
WRPATR25  MOVE      "028",DIM3
          CALL      GPTATR00                   * Get if patatraf exist
          IF        EXIT = 0
            CALL      TOPATR00
          ENDIF
.
WRPATR29  RETURN
.
.------------------------------------------------------------------------------
. Turn off patatraf
.------------------------------------------------------------------------------
TOPATR00  MOVE      ONE,PTARDELR
.
          CALL      IBACLOCK
          PACK      PTARUDTE,CCC,CYY,CMM,CDD
          REP       " 0",PTARUDTE
          CLOCK     TIME,PTARUTME
.
          MOVE      USERID,PTARUUSR
          MOVE      PTARUDTE,PTARFDTE
          MOVE      PTARUTME,PTARFTME
          MOVE      PTARUUSR,PTARFUSR
.
          CALL      UPPTATR3
.
TOPATR99  RETURN
.
.------------------------------------------------------------------------------
. Write out new patatraf
.------------------------------------------------------------------------------
NWPATR00  CALL      CLPATATR
          MOVE      URNUMBER,PTARURNO
          MOVE      ADMISSNO,PTARVISN
.
          CALL      IBACLOCK
          PACK      PTARDATE,CCC,CYY,CMM,CDD
          REP       " 0",PTARDATE
          CLOCK     TIME,PTARTIME
.
          MOVE      "028",PTARTYPE
          MOVE      PTDSC005,PTARCOD1
          MOVE      PTDSC006,PTARCOD2
          MOVE      PTDSC003,PTARTXT1
          MOVE      PTDSC004,PTARTXt2
.
          MOVE      "0",PTARDELR
          MOVE      PTARDATE,PTARCDTE
          MOVE      PTARTIME,PTARCTME
          MOVE      USERID,PTARCUSR
.
          PACK      KEY35,PTARURNO,PTARVISN,PTARDATE,PTARTIME,PTARTYPE,SP70
          CALL      WRPTATR2
.
NWPATR99  RETURN
.
.------------------------------------------------------------------------------
. Get patatraf data for discharge - Reason for discharge delay (028)
. Input  URNUMBER
.        ADMISSNO 
.        DIM3     - Type 
. Return EXIT = 0, patatraf record found  
.        EXIT = 1, No patatraf record found
.------------------------------------------------------------------------------
GPTATR00  MOVE      ZERO,EXIT
          PACK      KEY35,URNUMBER,ADMISSNO,DIM3,Z70
          CALL      RSPTATR3
          CALL      RPPTATR3
          BRANCH    OVRCD,GPTATR98
.
          MATCH     URNUMBER,PTARURNO
          GOTO      GPTATR98 IF NOT EQUAL
.
          MATCH     ADMISSNO,PTARVISN
          GOTO      GPTATR98 IF NOT EQUAL
.
          MATCH     DIM3,PTARTYPE
          GOTO      GPTATR98 IF NOT EQUAL
.
          MATCH     "1",PTARDELR
          GOTO      GPTATR98 IF EQUAL
.
          GOTO      GPTATR99
.
GPTATR98  MOVE      ONE,EXIT
.
GPTATR99  RETURN
+
.------------------------------------------------------------------------------
.                       SCHFAX00
.         Schedule an Inpatient Discharge Fax job via Program Scheduler
.------------------------------------------------------------------------------
SCHFAX00  READ      CONTROLF,HUND20;*175,PTCNIDFT
          MATCH     SP70,PTCNIDFT      * Inpatient Discharge Fax Template?
          GOTO      SCHFAX99 IF EQUAL  * Don't schedule job if blank
.
          MOVE      "PATSCH88",SCHDPGID
          MOVE      "Inpatient Discharge Fax",SCHDDESC
          READ      CONTROLF,EIGHTY9;*244,EMCNEDFP
          MOVE      EMCNEDFP,SCHDPRNT       * ED Fax Printer Code
          MATCH     SP70,FAXPRCOD
          IF        !@EQUAL
            MOVE      FAXPRCOD,SCHDPRNT
          ENDIF
          MOVE      ONE,SCHDCOPY
          PACK      SCHDDATE,CCC,CYY,CMM,CDD
          REP       " 0",SCHDDATE
          CLOCK     TIME,SCHDTIME
          READ      CONTROLF,EIGHTY9;*241,EMCNEDFD    * ED Fax Scheduler Delay
.
          CALL      IBACLOCK
          CALL      DATE2INT
          SQUEEZE   EMCNEDFD
          MOVE      EMCNEDFD,FORM3
          ASSIGN    (INTEGER+(FORM3*60)),INTEGER
          CALL      INT2DATE
          PACK      SCHDDATE,TWENTY,DTTMDATE
          MOVE      CTIMEIS,SCHDTIME
.
.         Keyin Parameters
.
          MOVE      "1",KEYSTARR[1]          * Option
          MOVE      ADMISSNO,KEYSTARR[2]     * Admission No
          MOVE      URNUMBER,KEYSTARR[3]     * UR Number
          MOVE      USERID,KEYSTARR[4]       * User ID
          MOVE      SCHDPRNT,KEYSTARR[5]     * Printer
          MOVE      "Y",KEYSTARR[6]          * Continue Y/N/C
          MOVE      " ",KEYSTARR[7]          * Continue Y/N/C
          MOVE      "7",KEYSTCNT             * Number of Keyins
          CALL      SCHPRO00                 * Schedule Inpatient Discharge Fax
.
SCHFAX99  RETURN
+
.------------------------------------------------------------
.         Update PRFA details
.------------------------------------------------------------
PRAD0000  MATCH     "1",PTCNDEES
          GOTO      PRAD9999 IF NOT EQUAL
.
          COMPARE   ONE,PCEASE
          GOTO      PRAD9999 IF NOT EQUAL
.
          MOVE      SP1,ANS
          MOVE      PGNAME,ANS
.
          MATCH     "1",PTCNXCOM
          GOTO      PRAD6000 IF NOT EQUAL
.
.         If PRFA begins with 'Parent of' - not prefix PRFA
.
          MATCH     "Parent of ",PKNAME
          GOTO      PRAD9999 IF EQUAL          * No prefix
.
          MATCH     SP70,ACLAIM
          GOTO      PRAD6000 IF EQUAL
.
          PACK      KEY5,ANSC,ANSL,ACLAIM
          CALL      RDCODE1
          BRANCH    OVRCD,PRAD6000
.
.         The following Claim codes don't have pmsextaf record
.
          MATCH     "H",TCINDC1
          GOTO      PRAD9999 IF EQUAL          * Private - No prefix
          MATCH     SP70,TCINDC1
          GOTO      PRAD2000 IF EQUAL          * Blank
          MATCH     "J",TCINDC1
          GOTO      PRAD2000 IF EQUAL          * Private Uninsured
          MATCH     "P",TCINDC1
          GOTO      PRAD2000 IF EQUAL          * Public/All Funding Source
.
          OPEN      PMSEXTA1,"pmsextaf"
          PACK      KEY11,ADMISSNO,ACLAIM
          CALL      RDPMEXT1
          BRANCH    OVRCD,PRAD6000
.
.         INDIC1=Blank,O,E,G,J,P & INDIC17=Blank -Proceed with the Estate prefix
.
          MATCH     "O",TCINDC1
          GOTO      PRAD1000 IF EQUAL          * Compsensable
          MATCH     "E",TCINDC1
          GOTO      PRAD1000 IF EQUAL          * Overseas Student
          MATCH     "G",TCINDC1
          GOTO      PRAD1000 IF EQUAL          * Overseas Visitor
          MATCH     "V",TCINDC1
          GOTO      PRAD1000 IF EQUAL          * Veterans Affairs
.
.         INDIC1=A,F,M,H,S,W & INDIC17=D - Ignore the Estate prefix
.
          MATCH     "A",TCINDC1
          GOTO      PRAD3200 IF EQUAL          * ADF
          MATCH     "F",TCINDC1
          GOTO      PRAD3200 IF EQUAL          * Foreign Defence
          MATCH     "M",TCINDC1
          GOTO      PRAD3200 IF EQUAL          * Motor Vehicle
          MATCH     "S",TCINDC1
          GOTO      PRAD9999 IF EQUAL          * Shipping
          MATCH     "W",TCINDC1
          GOTO      PRAD9999 IF EQUAL          * Workers Compensation
          GOTO      PRAD6000
.
.
PRAD1000  MATCH     "O",TCINDC1
          GOTO      PRAD2000 IF NOT EQUAL
.
.         If Billing address is not blank, No Prefix
.
          MATCH     "1",PMEXPOLC
          GOTO      PRAD9999 IF EQUAL         * Police Officer checked(NoPrefix)
.
          MATCH     SP70,PMEXICOD
          GOTO      PRAD9999 IF NOT EQUAL     * Insurance Code entered(NoPrefix)
.
.         TCINDC17 blank - proceed with the Prefix
.
PRAD2000  MATCH     SP70,TCINDC17
          GOTO      PRAD6000 IF EQUAL          * Proceed with the prefix
          GOTO      PRAD5000
.
................................................................................
.
.         ADF,Motor Vehicle,Foreign defence
.
PRAD3200  MATCH     SP70,PMEXICOD
          GOTO      PRAD9999 IF NOT EQUAL      * has Insurance details
          MATCH     SP70,PMEXCAD1
          GOTO      PRAD4200 IF NOT EQUAL
          GOTO      PRAD9999
.
.         TCINDC17=D - to ignore the Prefix
.
PRAD4200  MATCH     "D",TCINDC17
          GOTO      PRAD6000 IF NOT EQUAL      * Proceed with the prefix
.
.         No prefix
.
PRAD5000  PACK      PKNAME,ANS,DOT,PTMASNAM,SP70  * No prefix Deceased pat.
          GOTO      PRAD8000
.
.         Proceed with the prefix
.
PRAD6000  PACK      PKNAME,DLCHAR,SP1,ANS,DOT,PTMASNAM,SP70
          MATCH     SP70,PTCNDDES
          IF        !@EQUAL
            STRIP     PTCNDDES
            MOVE      PTCNDDES,KEY20
            UNPACK    PKNAME,DIM2,KEY78      * ignore "$ "
            PACK      PKNAME,KEY20,SP1,KEY78,SP70
          ENDIF
.
PRAD8000  CALL      UPPTRES1
.
          CALL      PMIGTNID                 * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      THIRTY3,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICDC                     * send A08 update details
.
PRAD9999  RETURN
+
.------------------------------------------------------------
. Check if there is any item to be invoiced after disc.date
.------------------------------------------------------------
CITM0000  PACK      KEY14,ADMISSNO,SP70
          CALL      RSPMMTI1
CITM2000  CALL      RKPMMTI1
          BRANCH    OVRCD,CITM9000
          MATCH     ADMISSNO,PMMIVISN      * Same visit number
          GOTO      CITM9000 IF NOT EQUAL
.
          MATCH     PMMITDAT,TRANDATE      * check item date against disc.date
          GOTO      CITM2000 IF NOT LESS   * item date less than disc.date
.
CITM8000  MOVE      ONE,EXIT
          GOTO      CITM9999
.
CITM9000  MOVE      ZERO,EXIT
CITM9999  RETURN
+
.------------------------------------------------------------
. Check if there is any care type change after disc.date
.------------------------------------------------------------
CCAR0000  PACK      KEY24,ADMISSNO,TRANDATE,TRANTIME,SP70
          CALL      RDCHCO1
          COMPARE   ZERO,OVRCD
          GOTO      CCAR8000 IF EQUAL      * found a change record
.
CCAR2000  CALL      RDKCHCO1
          BRANCH    OVRCD,CCAR9000
.
          MATCH     ADMISSNO,DCHADMN       * Same visit number
          GOTO      CCAR9000 IF NOT EQUAL
.
CCAR8000  MOVE      ONE,EXIT
          GOTO      CCAR9999
.
CCAR9000  MOVE      ZERO,EXIT
CCAR9999  RETURN
+
.------------------------------------------------------------
. Display Warnings
.------------------------------------------------------------
.
WEBWAR00  CALL      OPENHTML
          BRANCH    EXIT,WEBWAR95
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             "src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             "src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#"> "
.
          COMPARE   ZERO,WARCOUNT
          GOTO      WEBWAR20 IF EQUAL
.
          MOVE      ONE,COUNTER
WEBWAR10  WRITE     HTMLFILE;"    alert(#"",WEBWARNG[COUNTER],"#");",012
          COMPARE   COUNTER,WARCOUNT
          GOTO      WEBWAR20 IF EQUAL
          ADD       ONE,COUNTER
          GOTO      WEBWAR10
.
WEBWAR20  WRITE     HTMLFILE;" if (self.name.match(/PopUpFrame/)) {":
                             "  redirectParentFrame(#"",REDIRECT,"#"); }":
                             " else {":
                             "    location.href=#"",REDIRECT,"#"}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      WEBWAR99
.
WEBWAR95  DISPLAY   "*** Fifo Not Found ***"
.
WEBWAR99  RETURN
+
.------------------------------------------------------------
. CONTUR00
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
.
CONTUR00  MOVE      ADMISSNO,DADMNO
          MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,CONTUR90
.
          MOVE      AADMNO,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD,CONTUR90
          MOVE      AURNO,DURNO
          MOVE      AURNO,KEY8
.
          MOVE      "0",PCEASE
          CALL      RDMAST1
          BRANCH    OVRCD,CONTUR91
          MOVE      PCEASE,OLDCEASE
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          COMPARE   ONE,UPDATETY
          IF        !@EQUAL
            CALL      CKST0000                * check patient status
            BRANCH    EXIT,CONTUR90           * illegal status for discharge
          ENDIF
.
.         CHECK TO SEE IF FILE IN USE
.
          MOVE      AADMNO,KEY8
          CALL      RDPTMIS1
          COMPARE   ZERO,OVRCD
          GOTO      CONTUR92 IF NOT EQUAL
.
          MOVE      AURNO,KEY8
          MOVE      "0",PCEASE
          CALL      RDMAST1
          MOVE      PCEASE,OLDCEASE
          COMPARE   ZERO,OVRCD
          GOTO      CONTUR93 IF NOT EQUAL
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      CONTUR99
.
CONTUR90  MOVE      "Patient is not currently Admitted",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CONTUR99
.
CONTUR91  MOVE      "Patient Master File Data Missing",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CONTUR99
.
CONTUR92  CLEAR     WEBTITLE
          APPEND    "Patient Admission Busy on Terminal - ",WEBTITLE
          APPEND    APORT,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CONTUR99
.
CONTUR93  CLEAR     WEBTITLE
          APPEND    "Patient U/R No. ",WEBTITLE
          APPEND    PURNO,WEBTITLE
          APPEND    " Busy on Terminal ",WEBTITLE
          APPEND    PPORT,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CONTUR99
.
CONTUR99  RETURN
+
.------------------------------------------------------------
. CHKDSC00 - Check patient not already discharged
. Returns:   EXIT   0 = Ok to continue
.                   1 = Error
.------------------------------------------------------------
.
CHKDSC00  MOVE      PTMXLS,SAVLEGL          * save original legal status
          MOVE      PTMXLS,ORIGLEGL
          MOVE      ZERO,LEGLFLAG           * set legal status change flag
.
          MOVE      AADMNO,KEY8
          CALL      RDDSCH1
          COMPARE   ZERO,OVRCD
          GOTO      CHKDSC90 IF EQUAL
.
          MOVE      PTCNCFDS,DSTAT
.
          MOVE      ZERO,EXIT
          GOTO      CHKDSC99
.
CHKDSC90  MOVE      "Patient has Already been Discharged.  ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKDSC99
.
CHKDSC99  RETURN
+
.------------------------------------------------------------
. CHKMEH00 - Check mental health patient
. Returns:    EXIT  0 = Ok to continue
.                   1 = Error
.------------------------------------------------------------
.
CHKMEH00  COMPARE   ONE,MHCNUSE
          GOTO      CHKMEH90 IF NOT EQUAL   * not a mental health patient
.
          MOVE      AADMNO,KEY8
          CALL      RDMHVIS1
          BRANCH    OVRCD,CHKMEH90          * not a mental health patient
.
          MOVE      TWO,AUDIFLAG            * before change audit
          CALL      MHAUDVIS                * write audit
.
          CALL      MEHCLDSC                * clear discharge variables
          MOVE      MHVIADD1,MHDSADD1       * default value
          MOVE      MHVIADD2,MHDSADD2       * I SRF 33698
          MOVE      MHVISUBR,MHDSSUBR
          MOVE      MHVIADD4,MHDSADD4       * end I SRF 33698
          MOVE      MHVIACTY,MHDSACTY       * default value
.
          CALL      MVDIS000                * move cgi
.
. if discharged dead, dont keyin 2nd screen
.
          PACK      KEY5,ANSD,SP1,DSTAT
          CALL      RDCODE1
          BRANCH    OVRCD,CHKMEH10
          MATCH     ANSD,TCINDC1
          GOTO      CHKMEH10 IF EQUAL
.
.         write to meh discharge file
.
CHKMEH10  MOVE      AADMNO,KEY8
          MOVE      AADMNO,MHDSADMN         * set admission number
.
          IF        UPDMHDSC=1
            CALL    RDMHDSC1
            BRANCH  OVRCD,CHKMEH20
.
            MOVE    TWO,AUDIFLAG            * before change audit
            CALL    MHAUDDSC                * write audit
.
            CALL    MVDIS000
            CALL    UPMHDSC1
.
            MOVE    THREE,AUDIFLAG          * after change audit
            CALL    MHAUDDSC                * write audit
            GOTO    CHKMEH20
          ENDIF
.
          CALL      RAMHDSC1
          IF        OVRCD=1
            CALL      WRMHDSC1
            MOVE      ONE,AUDIFLAG          * add audit
            CALL      MHAUDDSC              * write audit
          ELSE
            CALL      RDMHDSC1
            CALL      MVDIS000
            CALL      UPMHDSC1
            MOVE      THREE,AUDIFLAG        * after change audit
            CALL      MHAUDDSC              * write audit
          ENDIF
.
CHKMEH20  CALL      MEHDIA00                * Update MH Diagnosis
.
.         update status on visit file
.
          MOVE      SIX,MHVISTAT            * set as discharged
          CALL      UPMHVIS1                * update visit file
          MOVE      THREE,AUDIFLAG          * after change audit
          CALL      MHAUDVIS                * write audit
.
          CALL      UPMAST1                 * update master file
.
          CALL      DEAPOL00                * Update Patient Death Polling Table
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPTRES1
          IF        OVRCD=1
            CALL      CPTRE100
          ENDIF
.
          CALL      PMIGTNID                 * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      SEVEN,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICUP                 * write PMI changes to DG *C-90222
.
CHKMEH90  MOVE      ZERO,EXIT
          GOTO      CHKMEH99
.
CHKMEH91  MOVE      ONE,EXIT
.
CHKMEH99  RETURN
+
.------------------------------------------------------------
.         Update MH Diagnosis file
.------------------------------------------------------------
MEHDIA00  PACK      KEY16,ADMISSNO,Z70
          CALL      RSMHDIA1
MEHDIA10  CALL      RPMHDIA1
          BRANCH    OVRCD,MEHDIA20
.
          MATCH     ADMISSNO,DMHDIADM
          GOTO      MEHDIA20 IF NOT EQUAL
.
          CALL      MVDIA000                * move cgi to file variables
          COMPARE   ZERO,MHDICHNG           * any changes to data ?
          GOTO      MEHDIA99 IF EQUAL       * if no changes, don't update
.
          MATCH     CURRDATE,MHDIDATE
          GOTO      MEHDIA10 IF NOT EQUAL
.                                           * Same date - update record only
          MOVE      "0",MHDIMOHR            * Unsent
          PACK      MHDIUDAT,CCC,CYY,CMM,CDD
          REP       " 0",MHDIUDAT
          CLOCK     TIME,MHDIUTIM
          MOVE      USERID,MHDIUUID
          CALL      UPMHDIA1
          GOTO      MEHDIA99
.                                           * no previous Diag., create new recd
MEHDIA20  CALL      CLMEHDIA
          CALL      MVDIA000                * move cgi to file variables
          COMPARE   ZERO,MHDICHNG           * any changes to data ?
          GOTO      MEHDIA99 IF EQUAL       * if no changes, don't write
.                                           * write new record for Current date
MEHDIA30  PACK      KEY16,ADMISSNO,CURRDATE
          CALL      RAMHDIA1
          COMPARE   ZERO,OVRCD
          GOTO      MEHDIA99 IF EQUAL
.
          MOVE      ADMISSNO,MHDIADMN
          MOVE      CURRDATE,MHDIDATE
          MOVE      "0",MHDIMOHR            * Unsent
          PACK      MHDICDAT,CCC,CYY,CMM,CDD
          REP       " 0",MHDICDAT
          CLOCK     TIME,MHDICTIM
          MOVE      USERID,MHDICUID
          CALL      WRMHDIA1
.
MEHDIA99  RETURN
+
.------------------------------------------------------------
. CHKMFL00 - Check that all mandatory fields are not empty
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
.
CHKMFL00  CALL      IBACLOCK
.
.         Check discharge date is current or previous date.
.
          PACK      CHKDATE,CURRDATE,SP10
          REP       " 0",TRANDATE
          MATCH     TRANDATE,CHKDATE
          GOTO      CHKMFL91 IF LESS
          MATCH     TRANDATE,CHKDATE
          GOTO      CHKMFL10 IF NOT EQUAL
.
.         Check discharge time is less then current time.
.
          MOVE      CTIMEIS,KEY8
          REP       ": ",KEY8
          SQUEEZE   KEY8
          MOVE      KEY8,FORM6
.
          MOVE      TRANTIME,KEY8
          REP       ": ",KEY8
          SQUEEZE   KEY8
          MOVE      KEY8,FORM6A
.
          IF        FORM6A>FORM6
            GOTO      CHKMFL92
          ENDIF
.
.         Check discharge destination is not empty
.
CHKMFL10
....     IF        PTCNDTRF=1
....        GOTO      CHKMFL15
....      ENDIF
....      MATCH     SP3,DSCHDEST                      * change label   *C-48630
....      GOTO      CHKMFL94 IF EQUAL
....      IF        @EOS
....        GOTO      CHKMFL94
....      ENDIF
.
....      MOVE      ZERO,EXIT
....      GOTO      CHKMFL99
.
....CHKMFL15  MATCH     SP3,DSCHSTAT
....      GOTO      CHKMFL93 IF EQUAL
....      IF        @EOS
....        GOTO      CHKMFL93
....      ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      CHKMFL99
.
CHKMFL91  MOVE      "** Cannot discharge into the future **",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          MOVE      ONE,EXIT
          GOTO      CHKMFL99
.
CHKMFL92  MOVE      "Discharge time must be less than current time.",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          MOVE      ONE,EXIT
          GOTO      CHKMFL99
.
CHKMFL93  MOVE      "Discharge Status is a mandatory field.",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          MOVE      ONE,EXIT
          GOTO      CHKMFL99
.
CHKMFL94  MOVE      "Discharge Destination is a mandatory field.",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          MOVE      ONE,EXIT
          GOTO      CHKMFL99
.
CHKMFL95  MOVE      "Financial is a mandatory field.",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          MOVE      ONE,EXIT
          GOTO      CHKMFL99
.
CHKMFL96  MOVE      "Intention to Readmit is a mandatory field.",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          MOVE      ONE,EXIT
.
CHKMFL99  RETURN
+
.------------------------------------------------------------
. CDHS0000 - If mulit hospital only allow discharge of patients
.            in the users current hospital
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
.
CDHS0000  MOVE      ZERO,EXIT
.
          COMPARE   ONE,IBCNMHOS
          GOTO      CDHS9999 IF NOT EQUAL
.
          MATCH     WBSEHOSP,PMVXMHOS
          GOTO      CDHS9000 IF NOT EQUAL
.
          MOVE      ZERO,EXIT
          GOTO      CDHS9999
.
CDHS9000  MOVE      "Invalid Discharge - different hospital code",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CDHS9999
.
CDHS9999  RETURN
+
.------------------------------------------------------------
.         Write the discharge audit
.------------------------------------------------------------
.
WRDSCAUD  MOVE      ANSA,ACTION
          MOVE      TRANTIME,TIMEIS
          MOVE      PASSCODE,OPERCODE
          CALL      ACTBSAV0
          CALL      WRBAUD             *write discharge audit
.
          RETURN
+
.------------------------------------------------------------
. Calculate which month variable and year is to be updated.
.------------------------------------------------------------
.
CALMY000  MOVE      XYEAR,SADYEAR
.
          REP       " 0",XMON
          REP       " 0",XMON1
.
          MATCH     XMON1,XMON
          GOTO      CALMY200 IF NOT LESS
.
          MOVE      SADYEAR,IYEAR
          COMPARE   ZERO,IYEAR
          GOTO      CALMY100 IF NOT EQUAL
.
          MOVE      "99",SADYEAR
          GOTO      CALMY200
.
CALMY100  SUB       ONE,IYEAR
          MOVE      IYEAR,SADYEAR
.
CALMY200  MOVE      XMON,INDEX
          MOVE      XMON1,FORM2
          SUB       FORM2,INDEX
          ADD       ONE,INDEX
          COMPARE   ONE,INDEX
          RETURN    IF NOT LESS
.
          ADD       TEN2,INDEX
.
CALMY999  RETURN
+
.------------------------------------------------------------
. Check if patient should no longer be classified as mental health
.------------------------------------------------------------
.
STLMEH00  COMPARE   ONE,MHCNUSE
          GOTO      STLMEH99 IF NOT EQUAL   * not using mental health
.
          MOVE      AADMNO,KEY8
          CALL      RDMHVIS1
          BRANCH    OVRCD,STLMEH99          * not a mental health patient
.
.         This patient is a MH patient, so check if the original legal
.         status has changed.
.
          MATCH     PTMXLS,ORIGLEGL         * legal status changed ?
          GOTO      STLMEH99 IF EQUAL       * no - ignore
.
.         Legal status has changed, so write a record to the legal status
.         history file.  First, we need to get the last legal status
.         history record to find out what the last review status was
.
          PACK      KEY21,DADMNO,Z70
          CALL      RSMHLEG1                * position after last record
          CALL      RPMHLEG1                * read previous record
          IF        OVRCD = 1
            MOVE      SP3,MHLEREVW          * load review status
          ENDIF
.
          MOVE      PTMXLS,MHLESTAT         * load legal status
          MOVE      ANSN,MHLESENT           * load EDI status
          MOVE      ANSL,MHLEFLAG           * load status flag
          PACK      MHLESPAR,SP10,SP5
.
          MOVE      DADMNO,MHLEADMN         * load admission number
          PACK      MHLEDATE,DDATE          * load discharge date
          REP       " 0",MHLEDATE
          MOVE      MHLEDATE,PTMXLSDT       * load legal status date for pmi
          UNPACK    DTIME,MHLETIME,KEY3     * load discharge time
.
          CALL      WRMHLEG1                * write new legal status history
.
.         Now write a record to the legal status history review file
.
          MOVE      ONE,MHRVDECI            * set review decision
          MOVE      MHLEDATE,MHRVLDAT       * set review date
          MOVE      MHLETIME,MHRVLTIM       * set review time
          MOVE      SP3,MHRVREAS            * set reason
          MOVE      SP8,MHRVNDAT            * set date of next review
          MOVE      SP20,MHRVSPAR
.
          MOVE      MHLEDATE,MHRVDATE       * set review date
          MOVE      MHLETIME,MHRVTIME       * set review time
.
          MOVE      DADMNO,MHRVADMN         * load admission number
          CALL      WRMHREV1                * write review history record
.
STLMEH99  RETURN
+
.------------------------------------------------------------
.         PREVIS00 - Check for previous visits to include the last 12 months
.                    visits from IBAPAT34.PBL
.------------------------------------------------------------
PREVIS00  MOVE      ZERO,PLDAYS
          PACK      DIM4,CCC,CYY     * Current year
          MOVE      DIM4,FORM4
          SUB       ONE,FORM4         * Set up last year
          PACK      DIM8,FORM4,CMM,CDD
          REP       " 0",DIM8         * Set today's date of last year
.
          MOVE      AADMNO,SADMNO     * Save the admission number
          MOVE      AURNO,PVIURNO
          PACK      KEY24,PVIURNO,Z70
          CALL      RDSVISA2
PREVIS10  CALL      RDPVISA2
          BRANCH    OVRCD,PREVIS90
.
          MATCH     AURNO,PVIURNO
          GOTO      PREVIS90 IF NOT EQUAL
.
          MOVE      PVIBILL,FORM8
          MOVE      FORM8,KEY8
          CALL      RDDSCH1
          BRANCH    OVRCD,PREVIS10
.
          CALL      RDMISS1
          BRANCH    OVRCD,PREVIS10
.
.         Check if the discharge date is within the last 12 months
.
          MATCH     DIM8,DDATE
          GOTO      PREVIS90 IF LESS
.
.         Check if the visit date is before the last 12 months
.
          UNPACK    PVIDATE,FROMDATE
          MATCH     DIM8,FROMDATE
          GOTO      PREVIS40 IF NOT LESS * visit within the last 12 months
.
          MOVE      DIM8,FROMDATE       * Set fromdate to today's date last year
.
.         Calculate number of days in hospital
.
PREVIS40  MOVE      DDATE,TODATE
.
          CALL      RTIODAYS
          ADD       NBRDAYS,PLDAYS
          GOTO      PREVIS10
.
PREVIS90  MOVE      SADMNO,KEY8
          CALL      RDDSCH1
          CALL      RDMISS1
.
PREVIS99  RETURN
+
.------------------------------------------------------------
.  Write last Episode Coding "patchaof" record (at Discharge)
.------------------------------------------------------------
EPSEND00

EPSEND99  RETURN
+
.------------------------------------------------------------
.  Open Files and Initialize Variables
.------------------------------------------------------------
.
INIT0000  CALL      INTMAS00
.
          OPEN      IBATMHA1,"ibatmhaf"
          OPEN      IBAPDFA1,"ibapdfaf"
          OPEN      IBALPCA1,"ibalpcaf"
          OPEN      ALLPCTA1,"allpctaf"
          OPEN      MRTPDSA1,"mrtpdsaf"     * HPS code is here
          OPEN      MLTHCPA1,"mlthcpaf"
          OPEN      OUTPHOA1,"outphoaf"
          OPEN      OPRNURA1,"oprnuraf"
          OPEN      PATICUA1,"paticuaf"
          OPEN      PATAXEA1,"pataxeaf"
          OPEN      PATBRNS1,"patbrnsf"
          OPEN      PATEORA1,"pateoraf"
          OPEN      PATATRA2,"patatraf"
          OPEN      PATATRA1,"patatraf"
          OPEN      PATATRA3,"patatraf"
.
          OPEN      BOKUNQA1,"bokunqaf"
          OPEN      PATBMDA1,"patbmdaf"
          OPEN      PATBMDA2,"patbmdaf"
          OPEN      PATBMDA3,"patbmdaf"
          OPEN      PATBMDA4,"patbmdaf"
          OPEN      PATBRDA1,"patbrdaf"
          OPEN      PATBRDA2,"patbrdaf"
          OPEN      PATBRDA3,"patbrdaf"
          OPEN      PATBRDA4,"patbrdaf"
          OPEN      PATACHA1,"patachaf"
          OPEN      PATCFAA1,"patcfaaf"
          OPEN      PATCHCO1,"patchcof"
          OPEN      PATNHHA1,"patnhhaf"
          OPEN      PATDO1A1,"patdo1af"
          OPEN      PATDTHA1,"patdthaf"
          OPEN      PATECDA1,"patecdaf"
          OPEN      PATECOA1,"patecoaf"
          OPEN      PATFIMA1,"patfimaf"        
          OPEN      PATFX1A1,"patfx1af"
          OPEN      PATIPEN1,"patipenf"
          OPEN      PATLINK1,"patlinkf"
          OPEN      PATMCHG1,"patmchgf"
          OPEN      PATWR1A1,"patwr1af"
          OPEN      PATWR1A4,"patwr1af"
          OPEN      PATWR1A7,"patwr1af"
          OPEN      PATWR1A8,"patwr1af"
          OPEN      PATRE1A1,"patre1af"
          OPEN      PATRGMA1,"patrgmaf"
          OPEN      PATRATE1,"patratef"
          OPEN      PMSEDWA2,"pmsedwaf"
          OPEN      PMSWX1A1,"pmswx1af"
          OPEN      PMSRCBA2,"pmsrcbaf"
          OPEN      BOKRC1A1,"bokrc1af"
          OPEN      BOKRC1A6,"bokrc1af"
          OPEN      WATCHAA1,"watchaaf"
          OPEN      WATTR1A1,"wattr1af"
          OPEN      WATTR1A1,"wattr1af"
          OPEN      WATESEA1,"wateseaf"
          OPEN      WATHISA1,"wathisaf"
          OPEN      WATPNPA1,"watpnpaf"
          OPEN      WATPROA1,"watproaf"
          OPEN      MEHCJAA1,"mehcjaaf"
          OPEN      MEHCJRA1,"mehcjraf"
          OPEN      MEHDIAA1,"mehdiaaf"
          OPEN      MEHHLSA1,"mehhlsaf"
          OPEN      MEHHLSA2,"mehhlsaf"
          OPEN      MEHDLSA1,"mehdlsaf"
          OPEN      MEHDL1A1,"mehdl1af"
          OPEN      MEHVI1A1,"mehvi1af"
          OPEN      MEHDS1A1,"mehds1af"
          OPEN      MEHAUDL1,"mehaudl1"
          OPEN      OPRDETA2,"oprdetaf"
          OPEN      OPRSRGA1,"oprsrgaf"
          OPEN      OPRARDA1,"oprardaf"
          CALL      OPICO1
.
          OPEN      PATASFA1,"patasfaf"
          OPEN      PATHSPA1,"pathspaf"
          OPEN      PATUNAA1,"patunaaf"
          OPEN      MEHLERA1,"mehleraf"
          OPEN      MEHLEGA1,"mehlegaf"
          OPEN      MEHREVA1,"mehrevaf"
          OPEN      NHIMASA1,"nhimasaf"
          OPEN      PATFN1A1,"patfn1af"
          OPEN      PATDTRA1,"patdtraf"
          OPEN      PATDRGA1,"patdrgaf"
          OPEN      PATITEM1,"patitemn"
          OPEN      VISUCMA1,"visucmaf"
          OPEN      VISMDTA1,"vismdtaf"
          OPEN      VISMTXA1,"vismtxaf"
          OPEN      PATCODE2,"patcodes"
          OPEN      PATTRAN1,"pattranf"
          OPEN      PATTRAN2,"pattranf"
          OPEN      PATDSCH1,"patdschf"
          OPEN      PATDSCH3,"patdschf"
          OPEN      PMSVX1A1,"pmsvx1af"
          OPEN      PATMI1A1,"patmi1af"
          OPEN      PATMI1A8,"patmi1af"
          OPEN      PATVADA1,"patvadaf"
          OPEN      PATVENA1,"patvenaf"
          OPEN      PATDADA1,"patdadaf"
          OPEN      PMSBDCA1,"pmsbdcaf"
          OPEN      PMSHCPA1,"pmshcpaf"
          OPEN      PMSHCGA1,"pmshcgaf"
          OPEN      PMSHRDA1,"pmshrdaf"
          OPEN      PMSWORA1,"pmsworaf"
          OPEN      PATNIDA1,"patnidaf"
          OPEN      PATNUMW1,"patnumwr"
          OPEN      PATLOCA1,"patlocaf"
          OPEN      PATMRGG1,"patmrgaf"
          OPEN      PATVISA1,"patvisaf"
          OPEN      PATVISA2,"patvisaf"
          OPEN      PATVISA4,"patvisaf"
          OPEN      PATNOBE1,"patnobef"
          OPEN      PATCODE1,"patcodes"
          OPEN      PATSTAD1,"patstads"
          OPEN      PATOPTN1,"patoptnf"
          OPEN      IHAPASS1,"ihapassf"
          OPEN      MRTVISA1,"mrtvisaf"
          OPEN      MRTHISA1,"mrthisaf"
          OPEN      MRTMASA2,"mrtmasaf"
          OPEN      MRTMOVA1,"mrtmovaf"
          OPEN      MRTLOCA1,"mrtlocaf"
          OPEN      PMSPX2A1,"pmspx2af"
          OPEN      PMSCURA1,"pmscuraf"
          OPEN      PMSREGA1,"pmsregaf"
          OPEN      PMSRESA1,"pmsresaf"
          OPEN      PMSMORA1,"pmsmoraf"
          OPEN      PMSMTIA1,"pmsmtiaf"
          OPEN      PATINVR3,"patinvrf"
          OPEN      IBAPDDA3,"ibapddaf"
          OPEN      IBAPRTA1,"ibaprtaf"
          OPEN      PMSRUGA1,"pmsrugaf"
          OPEN      PATQMHA1,"patqmhaf"
.
          IF        PTCNHDPS=3
            OPEN      PATSFAA1,"patsfaaf"
          ENDIF
          OPEN      PATONLV1,"patonlvf"
          OPEN      PATONLV2,"patonlvf"
          OPEN      PATPEIO1,"patpeiaf"
          OPEN      PRSDTLA2,"prsdtlaf"
          OPEN      PATBFEE1,"patbfeef"
          OPEN      NZPBFEA1,"nzpbfeaf"
          OPEN      ALLCASA1,"allcasaf"
          OPEN      PATWBHA1,"patwbhaf"
          OPEN      ACCAUDA1,"accaudaf"
          OPEN      ACCDIAA1,"accdiaaf"
          OPEN      EMRICDA1,"emricdaf"
          OPEN      VISXDCA1,"visxdcaf"
          OPEN      PMSCAUA1,"pmscauaf"
.
          MOVE      ZERO,NOLEAVRG
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSLRDA1,"pmslrdaf"
          IF        OVRCD=1
            MOVE      ONE,NOLEAVRG
          ENDIF
.
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,TEN;*32,PTCNUBRD,*126,CLABPG,*201,CAUDA,CAUDB:
                                 *217,CAUDQ,*244,CHOSPNUM
          READ      CONTROLF,TEN;*43,PTCNMRBT,*94,CAGECOFF
          READ      CONTROLF,TEN3;*154,CUSEMBS,*244,CHCS,CHOSTYP
          READ      CONTROLF,TEN8;*205,CPRINV,*206,CFINAN
          READ      CONTROLF,TEN9;*212,CFEETYP,*213,CDYCASE
          READ      CONTROLF,TWENTY;*50,PTCNADBF,*193,PTCNDCLM
          READ      CONTROLF,TWENTY1;*45,PTCNDRSM
          READ      CONTROLF,TWENTY1;*51,PTCNINVL,*60,PTCNCCRR:
                                     *63,PTCNCLOR,*118,PTCNUCEP,*120,PTCNADDC:
                                     *136,PTCNMITM,*200,PTCNICRA,*210,PTCNHOSP:
                                     *216,PTCNDTRF,*235,PTCNDPL8:
                                     *237,PTCNPAOF,*238,PTCNAGEC
          READ      CONTROLF,TWENTY2;*32,STCNIPDS
          READ      CONTROLF,THIRTY;*132,HSTANDM,HINVDES
          READ      CONTROLF,TWENTY;*164,PTRESDAY,*193,PTCNDCLM,*198,PTCNPIOP:
                                    *199,PTCNBCUT,PTCNBDOM,*211,PTCNCNDY:
                                    *214,PTCNSQD3,*238,PTCNURCO,*239,PTCNMXCH
          READ      CONTROLF,FIFTY9;*34,CTYPEUR,*86,CDETENTE,*92,CDETPATH:
                                   *130,CADDLAB,*132,CALRDESC:
                                   *171,PTCNSTAU,PTCNNUMM,*174,PTCNNDAT:
                                   *208,PTWRDLAB,PTCNDAYF,*220,PTCNUADT
          READ      CONTROLF,SIXTY;*133,MRCNEPSC
          READ      CONTROLF,SIXTY9;*43,MHCNAUDA,MHCNAUDB,*69,MHCNUSE
          READ      CONTROLF,SEVENTY7;*95,PTCNDSHL,*229,PTCNCFDS,*232,PTCNTMIN:
                                      *240,PTCNAXEU
          READ      CONTROLF,SEVENTY9;*68,PTCNMFEE,PTCNJFEE,*120,PTCNUEOC
          READ      CONTROLF,SEVENTY9;*245,PTCNCHSD,*246,PTCNCHAL,*248,PTCNIPEN
          READ      CONTROLF,EIGHTY;*1,PTCNMEAB,*248,PTCNPEFR,*250,PTCNHDPS
          READ      CONTROLF,TWENTY7;*46,HBWAIT
          READ      CONTROLF,TEN5;*187,CBOOK,*189,CTHETR
          READ      CONTROLF,EIGHTY8;*116,CHCSDTE
          READ      CONTROLF,HUND03;*220,PTCNDEES,*221,PTCNDDES,*245,PTCNWAUC
          READ      CONTROLF,HUND05;*99,PTCNNWCM,*165,PTCNONLA:
                                    *190,PTSGCOPT:    * Using suggested class.
                                    *237,PTCNMLEG
          READ      CONTROLF,HUND09;*195,PTCNACAS,*245,PTCNDISI
          READ      CONTROLF,HUND12;*107,PTCNBMAN
          READ      CONTROLF,NINTY7;*102,MRCNPDST        * post discharge status
          READ      CONTROLF,NINTY7;*155,MRCNAMTR:
                                    *163,MRCNLINK,*176,MRCNTREC,*246,MRCNROUN
          READ      CONTROLF,HUND10;*109,PTCNA21M,*110,PTCNA22M,*243,PTCNCOMF
          READ      CONTROLF,HUND12;*96,PTCNH7AC,*105,PTCNMORG
          READ      CONTROLF,HUND14;*81,PTCNDONP,*138,PTCNCHOT,*139,PTCNCHOD
          READ      CONTROLF,HUND16;*222,PTCNXCOM
          READ      CONTROLF,HUND18;*134,PTCNMFIN
.
          READ      CONTROLF,SEVENTY1;*200,CCCNSVHM
          READ      CONTROLF,HUND18;*242,PTCNWFIM
.          READ      CONTROLF,HUND20;*158,PTCNUNET
          READ      CONTROLF,HUND24;*157,PTCNPMHF
          READ      CONTROLF,HUND25;*93,PTCNNSSI,*236,PTCNEXDD,*245,PTCNSRFL
          READ      CONTROLF,HUND30;*114,PTCNABTS
.
.          OPEN      PMSIPLA1,"pmsiplaf"     * Polling table for DHS Medicare
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
          ENDIF
.                                       
          MOVE      ZERO,NOPROGRM
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSHPGA1,"pmshpgaf"
          TRAPCLR   IO
          IF        OVRCD<>1
            OPEN      PMSHPOA1,"pmshpoaf"
            OPEN      PMSUPGA1,"pmsupgaf"
            OPEN      PMSUPOA1,"pmsupoaf"
          ELSE
            MOVE      ONE,NOPROGRM
          ENDIF
.
          CALL      TFILENAM
          MOVE      TFILNAME,CFNAMEDP
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,COMFILNM

.
INIT0100  BRANCH    CAUDQ,INIT0200
          OPEN      PATRCAUD,"patrcaud"
.
INIT0200  BRANCH    MHCNAUDA,INIT0300       * no audits for mehvi1af
          OPEN      MEHAUVI1,"mehauvi1"
.
INIT0300  BRANCH    MHCNAUDB,INIT0400       * no audits for mehds1af
          OPEN      MEHAUDS1,"mehauds1"
.
INIT0400  BRANCH    CAUDB,INIT0500
          OPEN      PATBAUD,"patbaud"
.
INIT0500  BRANCH    CAUDA,INIT9999
          OPEN      PATAUAA1,"pataa1af"
.
INIT9999  RETURN
+
.------------------------------------------------------------
. Clear Parameters
.------------------------------------------------------------
.
CLRPAR00  MOVE      SP70,DELVISIT
          MOVE      ZERO,REPORTNO
          MOVE      SP70,WRDBEDKY
          MOVE      SP70,WARDCODE
          MOVE      SP70,BEDDCODE
          MOVE      SP70,SWPTOWRD
          MOVE      SP70,SWPTOBED
          MOVE      SP70,NEXTPAGE
          MOVE      SP70,BEDTRKEY
          MOVE      ZERO,WBEDSWAP
          MOVE      ZERO,URNUMBER
          MOVE      ZEROVISN,ADMISSNO
          MOVE      SP70,FORMACTN
          MOVE      ZEROVISN,STBYPAT
          MOVE      ZERO,NMDSCHGF
          MOVE      ZERO,LEAVREGR
          MOVE      SP70,RETNDATE
          MOVE      SP70,RETNTIME
          MOVE      SP70,LVRREDIR
          MOVE      SP70,LEAVWARD
          MOVE      SP70,LEAVRISK
          MOVE      SP70,LEAVSTAT
          MOVE      SP70,LEAVCARE
          MOVE      SP70,LEAVEREG
.... CAR 48096
          MOVE      ZERO,CTADMVAR
          MOVE      SP70,DAYONCOL
          MOVE      Z70,ACCPORDN
....
          MOVE      ZERO,ADMREC                                        *I-55106
          MOVE      ZERO,CONTMULT
          MOVE      ZERO,MOVEMREC
          MOVE      ZERO,UPDATETY
          MOVE      ZERO,REMOTENO
          MOVE      SP70,TRNTREAT
          MOVE      ZERO,CHGCFSG
          MOVE      ZERO,CHGADMCR
          MOVE      ZERO,OPTION
          MOVE      ZERO,ADDWLFLG
          MOVE      SP70,NOTIFYHS
          MOVE      ZERO,PREADMIT
          MOVE      ZERO,ALWLEAVE
.
          MOVE      SP70,PTMIS001
          MOVE      SP70,PTMIS002
          MOVE      SP70,PTMIS074
          MOVE      Z70,PTVIS041
          MOVE      Z70,PTVIS110
          MOVE      Z70,PTVIS131
          MOVE      Z70,PTASF001
          MOVE      Z70,PTASF002
          MOVE      Z70,PTASF003
          MOVE      SP70,PTDSC001
          MOVE      SP70,PTDSC002
          MOVE      SP70,PTDSC003
          MOVE      SP70,PTDSC004
          MOVE      SP70,PTDSC005
          MOVE      SP70,PTDSC006
          MOVE      SP70,TRNACARE
          MOVE      Z70,TRNACARE
          MOVE      SP70,TRNUREAS
          MOVE      SP70,TRNCANCP
          MOVE      SP70,TRANDATE
          MOVE      Z70,TRNSRETN
          MOVE      Z70,TRNSRETT
          MOVE      Z70,TRNLVTYP
          MOVE      Z70,ENDLEAVE
          MOVE      SP70,TRANTIME
          MOVE      SP70,LASTTRNS
          MOVE      SP70,TESTTRNS
          MOVE      SP5,TRNTOWRD
          MOVE      SP5,TRNTOBED
          MOVE      SP70,TRACLAIM
          MOVE      SP70,TRANFUND
          MOVE      SP70,TRANTABL
          MOVE      SP70,TRANMEMB
          MOVE      ZERO,TRANCFSG
          MOVE      ZERO,TRNLEAVE
          MOVE      SP6,TRNADOCT
          MOVE      SP6,TRNTDEPT
          MOVE      SP70,TRNSFSRC
          MOVE      SP70,SPECIALT
          MOVE      SP3,DSCHSTAT
          MOVE      SP3,DSCHDEST
          MOVE      SP3,DSCHUSR1
          MOVE      SP3,DSCHUSR2
          MOVE      SP3,DSCHUSR3
          MOVE      SP3,DSCHUSR4
          MOVE      SP3,DSCHUSR5
          MOVE      SP70,DSCHUYN1
          MOVE      SP70,DSCHUYN2
          MOVE      SP70,DSCHUYN3
          MOVE      SP70,DSCHCLGP
          MOVE      SP3,DSCHMBSC
          MOVE      SP70,DSCHDIA1
          MOVE      SP70,DSCHDIA2
          MOVE      ZERO,DSCHAUTP
          MOVE      ZERO,DSCHDIND
          MOVE      SP5,DSCHTRAN
          MOVE      SP70,DSCHDPMN
          MOVE      ZERO,WARCOUNT
          MOVE      SP70,ADMNREAS
          MOVE      SP70,DSCHREAS
          MOVE      SP70,DDATREAS
          MOVE      SP70,FINANELC
          MOVE      Z70,NEWACARE
          MOVE      Z70,TRNTTYPE
          MOVE      ZERO,STATADMN
          MOVE      ZERO,STATDSCH
          MOVE      SP70,SAVDSTAT
.
          MOVE      SP3,DSCHIRAD            * HPS Code Starts Here
          MOVE      SP8,DSCHSREF
          MOVE      SP70,DSCHCOM1
          MOVE      SP30,DSCHCOM2
          MOVE      SP3,DSCHDETY
          MOVE      SP3,DSCHCRAV
          MOVE      SP3,DSCHRCCT
          MOVE      SP6,DSCHADTA
          MOVE      SP6,DSCHADTT
          MOVE      SP3,DSCHMHLS            * HPS Code Ends Here
          MOVE      Z70,DSCHPALC                                       *I-53371
          MOVE      Z70,DSCHPYSP                                       *I-53371
          MOVE      Z70,DSCHRTOS
          MOVE      Z70,DSCHFINP                                       *I-53371
.
          MOVE      ZERO,CHGCASET
          MOVE      ZERO,CHGDOC
          MOVE      ZERO,CHGTYP
          MOVE      ZERO,CHGFIN
          MOVE      ZERO,CHGUNT
          MOVE      ZERO,CHGTEM
          MOVE      ZERO,CHGRST
          MOVE      ZERO,CHGRES
          MOVE      ZERO,CHGCARE
          MOVE      ZERO,CHGFEE
          MOVE      ZERO,CHGCL
          MOVE      ZERO,CHGHF
          MOVE      ZERO,CHGTB
          MOVE      SP70,CHNGUNIT
          MOVE      Z70,CHNGTEAM
          MOVE      Z70,CHNGRSTR
          MOVE      Z70,CHNGRESI
          MOVE      ZERO,DISFLAG
.
          MOVE      ZERO,LINKFMUR
          MOVE      ZERO,LINKTOUR
          MOVE      SP70,LINKDATE
          MOVE      SP70,LINKREAS
          MOVE      SP70,LINKTYPE
          MOVE      SP70,WBEDNUMB
          MOVE      SP3,TRANWARD            * HPS Code starts here
          MOVE      SP3,TRANBEDS
          MOVE      SP1,TRANMOVE
          MOVE      SP8,TRANDATE
          MOVE      SP8,TRANTIME            * Hps Code Ends Here
          MOVE      Z70,WATHI002
          MOVE      SP70,DELETECT
          MOVE      SP70,DELETEMH
          MOVE      SP70,DELEPAMH
          MOVE      Z70,AGECARAS
.
          MOVE      SP70,ADMISDTE
          MOVE      SP70,ADMSDATE
          MOVE      ZERO,STAYDAYS
          MOVE      ZERO,MHTRAN
          PACK      MHREDIRC,SP70,SP70
.
          MOVE      SP70,TRANSRCE           * Contracted Leave Transfer Source
          PACK      REDIRECT,SP70,SP70,SP70,SP70
.
          MOVE      SP70,ADMISTME
          MOVE      SP70,PTRGM001
          MOVE      SP70,PTRGM002
          MOVE      SP70,PTRGM003
          MOVE      SP70,PRNXINDI
          MOVE      ZERO,ADMFIMEX  
          MOVE      ZERO,DSCFIMEX 
.
          MOVE      SP70,BDRQADMN
          MOVE      SP70,NEWBTYPE
          MOVE      SP70,MNHLLVIN
          MOVE      SP70,MNHLREDT
          MOVE      SP70,MNHLRETM
          MOVE      SP70,MNHLLSWD
          MOVE      SP70,MNHLLSBD
          MOVE      SP70,USERNAME
.
          CALL      CPVXTF00                * clear Visit Extension
          CALL      CPPMHR00
          CALL      CLRMDS00                * MH Discharge file
          CALL      CLRMDI00                * MH Diagnosis file
          CALL      CLPMLR00                * Clear leave register detail
.
          MOVE      ZERO,UPDMHDSC           * Update MH patient discharge
          MOVE      SP70,UPDATHRD
          MOVE      SP70,FAXITFLG
          MOVE      SP70,FAXPRCOD
          MOVE      SP70,DSCHINGP
          MOVE      SP70,TRNCASET
          MOVE      SP70,NTRCASET
.
          MOVE      SP70,CHKWRDCD
          MOVE      SP70,CHKBEDCD
          MOVE      SP70,CHKADMDT
          MOVE      SP70,CHKADMTM
.
          MOVE      SP70,TRANFKEY
          MOVE      SP70,UPDTTYPE
.
          MOVE      SP70,DSCHSTDF
          MOVE      SP70,UPDHFUND
          MOVE      SP70,TRNSREAS
.
          MOVE      SP70,TRIGRA11
          MOVE      SP70,TRIGRA01
          MOVE      SP70,SCANNEDM
          MOVE      SP70,VALDDATE
          MOVE      SP70,STATVTYP
          MOVE      SP70,STATVISN
          MOVE      SP70,HEAONLYF
          MOVE      SP70,PTCNDPTM
          MOVE      SP70,LTDSRESN
          MOVE      SP70,LTDSCOM1
          MOVE      SP70,LTDSCOM2
.
          MOVE      SP70,STATNCOD
          MOVE      SP70,SCHDPRNT
          MOVE      ZERO,SCHDCOPY
          CALL      CLRVXD00                * Clear cgi visxdcaf
          MOVE      Z70,MRFDDATE
.
CLRPAR99  RETURN
+
.------------------------------------------------------------
. Set Parameters
.------------------------------------------------------------
.
SETPAR00  MATCH     "reportno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REPORTNO
          GOTO      SETPAR99
          ENDIF
.
          MATCH     "wrdbedky=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,WRDBEDKY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "wardcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,WARDCODE
            PACK      WARDCODE,WARDCODE,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "beddcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,BEDDCODE
            PACK      BEDDCODE,BEDDCODE,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "swptowrd=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SWPTOWRD
            PACK      SWPTOWRD,SWPTOWRD,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "swptobed=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SWPTOBED
            PACK      SWPTOBED,SWPTOBED,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "schdprnt",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SCHDPRNT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "lvrredir",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LVRREDIR
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmsvx079=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PMSVX079
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "leavward",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LEAVWARD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "leavrisk",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LEAVRISK
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "leavstat",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LEAVSTAT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "leavcare",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LEAVCARE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "leavereg",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LEAVEREG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "statncod=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STATNCOD
            PACK      STATNCOD,STATNCOD,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "bedtrkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,BEDTRKEY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "leavregr=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LEAVREGR
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "contmult=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CONTMULT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "bedtrkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,BEDTRKEY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "wbedswap=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,WBEDSWAP
              IF        WBEDSWAP=1
                MOVE      "Transfer",FORMACTN
              ENDIF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admissno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMISSNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trandate=",QRYNAME     *  this is for selection list
          IF        @EQUAL
            MOVE      QRYDATA,TRANDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "retndate=",QRYNAME 
          IF        @EQUAL
            MOVE      QRYDATA,RETNDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "retntime=",QRYNAME 
          IF        @EQUAL
            MOVE      QRYDATA,RETNTIME
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "accpordn",QRYNAME
          IF        @EQUAL
            PACK      ACCPORDN,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschuyn1=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHUYN1
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschuyn2=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHUYN2
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschuyn3=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHUYN3
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschclgp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHCLGP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "leavecom",QRYNAME
          IF        @EQUAL
            CALL      GETEXT00           * Get leave notes
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "delvisit=",QRYNAME     *  this is for selection list
          IF        @EQUAL
            MOVE      QRYDATA,DELVISIT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dayoncol=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DAYONCOL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trandate1=",QRYNAME     * this it for date field
          IF        @EQUAL
            UNPACK    QRYDATA,KEY1,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00              * Set CMON from MTHNAM3
            PACK      QRYDATA,CCENT,CYEAR,CMON,CDAY
            MOVE      QRYDATA,TRANDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trantime=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRANTIME
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "reaexpds=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REAEXPDS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "tranward=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRANWARD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "tranmove=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRANMOVE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "tranbeds=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRANBEDS
            GOTO      SETPAR99
          ENDIF                             * HPS Code Ends Here
.
          MATCH     "urnumber=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,URNUMBER
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "formactn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FORMACTN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "newbtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEWBTYPE
            GOTO      SETPAR99
          ENDIF
.
.... I CAR 48096
          MATCH     "ctadmvar=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CTADMVAR
            GOTO      SETPAR99
          ENDIF
.... End I
          MATCH     "updatety=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDATETY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "remoteno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REMOTENO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "movemrec=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MOVEMREC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trandate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRANDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trantime=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRANTIME
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admnreas=",QRYNAME
          IF        @EQUAL
            PACK      ADMNREAS,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschreas=",QRYNAME
          IF        @EQUAL
            PACK      DSCHREAS,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ddatreas=",QRYNAME
          IF        @EQUAL
            PACK      DDATREAS,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "specialt=",QRYNAME
          IF        @EQUAL
            MATCH     SP70,QRYDATA
            GOTO      SETPAR99 IF EQUAL
            GOTO      SETPAR99 IF EOS
.
            MOVE      QRYDATA,SPECIALT
            MOVE      ONE,CHGTYP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "finanelc=",QRYNAME
          IF        @EQUAL
            MATCH     SP70,QRYDATA
            GOTO      SETPAR99 IF EQUAL
            GOTO      SETPAR99 IF EOS
.
            MOVE      QRYDATA,FINANELC
            MOVE      ONE,CHGFIN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptasf",QRYNAME
          IF        @EQUAL
            CALL      SPASF000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "chngunit=",QRYNAME
          IF        @EQUAL
....        MATCH     SP70,QRYDATA       * Removed for CAR 300420
....        GOTO      SETPAR99 IF EQUAL
....        GOTO      SETPAR99 IF EOS
.
            MOVE      QRYDATA,CHNGUNIT
            MOVE      ONE,CHGUNT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "chngteam=",QRYNAME
          IF        @EQUAL
....        MATCH     SP70,QRYDATA       * Removed for CAR 300420
....        GOTO      SETPAR99 IF EQUAL
....        GOTO      SETPAR99 IF EOS
.
            MOVE      QRYDATA,CHNGTEAM
            MOVE      ONE,CHGTEM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "chngrstr=",QRYNAME
          IF        @EQUAL
            PACK      CHNGRSTR,QRYDATA,SP70
            MOVE      ONE,CHGRST
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "chngresi=",QRYNAME
          IF        @EQUAL
            PACK      CHNGRESI,QRYDATA,SP70
            MOVE      ONE,CHGRES
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trncancp=",QRYNAME
          IF        @EQUAL
            MATCH     SP70,QRYDATA
            GOTO      SETPAR99 IF EQUAL
            GOTO      SETPAR99 IF EOS
.
            MOVE      QRYDATA,TRNCANCP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trnureas=",QRYNAME
          IF        @EQUAL
            MATCH     SP70,QRYDATA
            GOTO      SETPAR99 IF EQUAL
            GOTO      SETPAR99 IF EOS
.
            MOVE      QRYDATA,TRNUREAS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "newacare=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEWACARE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trnttype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRNTTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trnacare=",QRYNAME
          IF        @EQUAL
            MATCH     SP70,QRYDATA
            GOTO      SETPAR99 IF EQUAL
            GOTO      SETPAR99 IF EOS
.
            MOVE      QRYDATA,TRNACARE
            MOVE      ONE,CHGCARE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trnlvtyp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRNLVTYP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "endleave=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ENDLEAVE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trnsretn=",QRYNAME
          IF        @EQUAL
            MATCH     SP70,QRYDATA
            IF        @EQUAL|@EOS
              MOVE      SP70,TRNSRETN
              GOTO      SETPAR99
            ENDIF
.
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00            * Set CMON from MTHNAM3
            PACK      TRNSRETN,CCENT,CYEAR,CMON,CDAY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trnsrett=",QRYNAME
          IF        @EQUAL
            PACK      TRNSRETT,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschstat=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHSTAT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschdest=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHDEST
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschirad=",QRYNAME     * HPS Code Starts Here
          IF        @EQUAL
            MOVE      QRYDATA,DSCHIRAD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschsref=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHSREF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschcom1=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHCOM1
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschcom2=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHCOM2
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschdety=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHDETY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschcrav=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHCRAV
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschadtt=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHADTT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschadta=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHADTA
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschrcct=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHRCCT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschmhls=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHMHLS
            GOTO      SETPAR99
          ENDIF                             * HPS Code Ends Here
.
          MATCH     "dschusr1=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHUSR1
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschusr2=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHUSR2
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschusr3=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHUSR3
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschusr4=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHUSR4
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschusr5=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHUSR5
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschmbsc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHMBSC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschdia1=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHDIA1
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschdia2=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHDIA2
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschautp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHAUTP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschdind=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHDIND
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschpalc=",QRYNAME                                *I-53371
          IF        @EQUAL
            MOVE      QRYDATA,DSCHPALC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschpysp=",QRYNAME                                *I-53371
          IF        @EQUAL
            MOVE      QRYDATA,DSCHPYSP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschrtos=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHRTOS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschfinp=",QRYNAME                                *I-53371
          IF        @EQUAL
            MOVE      QRYDATA,DSCHFINP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschtran=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHTRAN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschdpmn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHDPMN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "notifyhs=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NOTIFYHS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trntowrd=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRNTOWRD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trntobed=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRNTOBED
            PACK      TRNTOBED,TRNTOBED,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trnleave=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRNLEAVE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trnadoct=",QRYNAME
          IF        @EQUAL
            MATCH     SP70,QRYDATA
            GOTO      SETPAR99 IF EQUAL
            GOTO      SETPAR99 IF EOS
.
            MOVE      QRYDATA,TRNADOCT
            MOVE      ONE,CHGDOC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trntdept=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRNTDEPT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trntreat=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRNTREAT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trnsfsrc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRNSFSRC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nextpage=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTPAGE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "redirect=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REDIRECT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mhredirc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MHREDIRC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "linkfmur=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LINKFMUR
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "linktour=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LINKTOUR
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "linkdate=",QRYNAME
          IF        @EQUAL
            MATCH      SP70,QRYDATA
            GOTO       SETPAR99 IF EQUAL
            GOTO       SETPAR99 IF EOS
.
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00            * Set CMON from MTHNAM3
            PACK      LINKDATE,CCENT,CYEAR,CMON,CDAY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "linkreas=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LINKREAS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "linktype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LINKTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptmis001=",QRYNAME
          IF        @EQUAL
            MATCH     SP70,QRYDATA
            GOTO      SETPAR99 IF EQUAL
            GOTO      SETPAR99 IF EOS
.
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00            * Set CMON from MTHNAM3
            PACK      PTMIS001,CCENT,CYEAR,CMON,CDAY
            REP       " 0",PTMIS001
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptmis002=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PTMIS002
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptmis074=",QRYNAME
          IF        @EQUAL
            MATCH     SP70,QRYDATA
            GOTO      SETPAR99 IF EQUAL
            GOTO      SETPAR99 IF EOS
            MOVE      QRYDATA,PTMIS074
            MOVE      ONE,CHGFEE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptvis110=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PTVIS110
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptvis131=",QRYNAME
          IF        @EQUAL
            MATCH     SP70,QRYDATA
            GOTO      SETPAR99 IF EQUAL
            GOTO      SETPAR99 IF EOS
.
            MOVE      QRYDATA,PTVIS131
            MOVE      ONE,CHGFIN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptvis041=",QRYNAME
          IF        @EQUAL
            MATCH     SP70,QRYDATA
            GOTO      SETPAR99 IF EQUAL
            GOTO      SETPAR99 IF EOS
.
            MOVE      QRYDATA,PTVIS041
            MOVE      ONE,CHGADMCR
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptdsc001=",QRYNAME
          IF        @EQUAL
            MATCH     SP70,QRYDATA
            GOTO      SETPAR99 IF EQUAL
            GOTO      SETPAR99 IF EOS
.
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00            * Set CMON from MTHNAM3
            PACK      PTDSC001,CCENT,CYEAR,CMON,CDAY
            REP       " 0",PTDSC001
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptdsc002=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PTDSC002
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptdsc003=",QRYNAME
          IF        @EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00              * Set CMON from MTHNAM3
            PACK      QRYDATA,CCENT,CYEAR,CMON,CDAY
            PACK      PTDSC003,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptdsc004=",QRYNAME
          IF        @EQUAL
            PACK      PTDSC004,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptdsc005=",QRYNAME
          IF        @EQUAL
            PACK      PTDSC005,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptdsc006=",QRYNAME
          IF        @EQUAL
            PACK      PTDSC006,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "wbednumb=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,WBEDNUMB
            PACK      WBEDNUMB,WBEDNUMB,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "traclaim=",QRYNAME
          IF        @EQUAL
            MATCH     SP70,QRYDATA
            GOTO      SETPAR99 IF EQUAL
            GOTO      SETPAR99 IF EOS
            MOVE      QRYDATA,TRACLAIM
            MOVE      ONE,CHGFEE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "tranfund=",QRYNAME
          IF        @EQUAL
            MATCH     SP70,QRYDATA
            GOTO      SETPAR99 IF EQUAL
            GOTO      SETPAR99 IF EOS
            MOVE      QRYDATA,TRANFUND
            MOVE      ONE,CHGFEE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trantabl=",QRYNAME
          IF        @EQUAL
            MATCH     SP70,QRYDATA
            GOTO      SETPAR99 IF EQUAL
            GOTO      SETPAR99 IF EOS
            MOVE      QRYDATA,TRANTABL
            MOVE      ONE,CHGFEE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "tranmemb=",QRYNAME
          IF        @EQUAL
            MATCH     SP70,QRYDATA
            GOTO      SETPAR99 IF EQUAL
            GOTO      SETPAR99 IF EOS
            MOVE      QRYDATA,TRANMEMB
            MOVE      ONE,CHGFEE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trancfsg=",QRYNAME
          IF        @EQUAL
            MATCH     SP70,QRYDATA
            GOTO      SETPAR99 IF EQUAL
            GOTO      SETPAR99 IF EOS
            MOVE      QRYDATA,TRANCFSG
            MOVE      ONE,CHGCFSG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "wathi002=",QRYNAME
          IF        @EQUAL
            MATCH     SP70,QRYDATA
            GOTO      SETPAR99 IF EQUAL
            GOTO      SETPAR99 IF EOS
.
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00              * Set CMON from MTHNAM3
            PACK      WATHI002,CCENT,CYEAR,CMON,CDAY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "deletect=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DELETECT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "deletemh=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DELETEMH
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "delepamh=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DELEPAMH
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "agecaras=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,AGECARAS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admisdte=",QRYNAME
          IF        @EQUAL
            MATCH     SP70,QRYDATA
            GOTO      SETPAR99 IF EQUAL
            GOTO      SETPAR99 IF EOS
.
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00            * Set CMON from MTHNAM3
            PACK      ADMISDTE,CCENT,CYEAR,CMON,CDAY
            REP       " 0",ADMISDTE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "staydays=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STAYDAYS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "transrce=",QRYNAME      * Contracted Leave Transfer Source
          IF        @EQUAL
            MOVE      QRYDATA,TRANSRCE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admistme=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMISTME
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptrgm",QRYNAME
          IF        @EQUAL
            CALL      SPRGM000
            COMPARE   ZERO,EXIT
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "pmhrd",QRYNAME
          IF        @EQUAL
            CALL      SPPMHR00
            COMPARE   ZERO,EXIT
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "prnxindi=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRNXINDI
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "bdrqadmn",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,BDRQADMN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmsvx039=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PMSVX039
            GOTO      SETPAR99
          ENDIF
          MATCH     "pmsvx040=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PMSVX040
            GOTO      SETPAR99
          ENDIF
...       MATCH     "pmsvx",QRYNAME         * only using the 2 fields above
...       IF        @EQUAL
...         CALL      SPVXTF00
...         COMPARE   ZERO,EXIT
...         GOTO      SETPAR99 IF EQUAL
...       ENDIF
.
          MATCH     "mnhllvin",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MNHLLVIN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mnhlredt",QRYNAME
          IF        @EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      QRYDATA,CCENT,CYEAR,CMON,CDAY
            MOVE      QRYDATA,MNHLREDT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mnhlretm",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MNHLRETM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mnhllswd",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MNHLLSWD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mnhllsbd",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MNHLLSBD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mehds",QRYNAME
          IF        @EQUAL
            CALL      SETMDS00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mehdi",QRYNAME
          IF        @EQUAL
            CALL      SETMDI00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmlrd",QRYNAME
          IF        @EQUAL
            CALL      SPLRD000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "preadmit",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PREADMIT
            GOTO      SETPAR99
          ENDIF
. 
          MATCH     "admfimex=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMFIMEX
            GOTO      SETPAR99
          ENDIF
. 
          MATCH     "dscfimex=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCFIMEX
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "username=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,USERNAME
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updmhdsc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDMHDSC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updathrd=",QRYNAME
          IF        @EQUAL
            PACK      UPDATHRD,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "faxitflg=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FAXITFLG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "faxprcod=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FAXPRCOD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschingp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHINGP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trncaset=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRNCASET
            MOVE      ONE,CHGCASET
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "tranfkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRANFKEY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updttype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDTTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschstdf=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHSTDF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updhfund=",QRYNAME
          IF        @EQUAL
            MOVE       QRYDATA,UPDHFUND
            GOTO       SETPAR99
          ENDIF
.
          MATCH     "ptqmh",QRYNAME
          IF        @EQUAL
            CALL      SPQMH000              * Set QLD MH Details
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trnsreas=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRNSREAS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trigra11=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRIGRA11
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trigra01=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRIGRA01
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "scannedm=",QRYNAME
          IF        @EQUAL
            PACK      SCANNEDM,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valddate=",QRYNAME
          IF        @EQUAL
            MATCH     SP70,QRYDATA
            GOTO      SETPAR99 IF EQUAL
            GOTO      SETPAR99 IF EOS
.
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00            * Set CMON from MTHNAM3
            PACK      VALDDATE,CCENT,CYEAR,CMON,CDAY
            REP       " 0",VALDDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "statvtyp=",QRYNAME
          IF        @EQUAL
            PACK      STATVTYP,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "statvisn=",QRYNAME
          IF        @EQUAL
            PACK      STATVISN,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "heaonlyf=",QRYNAME
          IF        @EQUAL
            PACK      HEAONLYF,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mrfddate=",QRYNAME
          IF        @EQUAL
            MATCH     SP70,QRYDATA
            IF        @EQUAL | @EOS
              MOVE      SP70,MRFDDATE
              GOTO      SETPAR99
            ENDIF
.
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00            * Set CMON from MTHNAM3
            PACK      MRFDDATE,CCENT,CYEAR,CMON,CDAY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "vsxdc",QRYNAME
          IF        @EQUAL
            CALL      SVSXDC00              * Visit extra data
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptcndptm=",QRYNAME
          IF        @EQUAL
            PACK      PTCNDPTM,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ltdsresn=",QRYNAME
          IF        @EQUAL
            PACK      LTDSRESN,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ltdscom1=",QRYNAME
          IF        @EQUAL
            PACK      LTDSCOM1,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ltdscom2=",QRYNAME
          IF        @EQUAL
            PACK      LTDSCOM2,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
SETPAR99  RETURN
+
.----------------------------------------------------------------
.   Set Parameters for Admission special funding/contract Details
.----------------------------------------------------------------
.
SPASF000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SPASF010,SPASF020,SPASF030
.
SPASF010  MOVE      QRYDATA,PTASF001
          GOTO      SPASF999
.
SPASF020  MOVE      QRYDATA,PTASF002
          GOTO      SPASF999
.
SPASF030  MOVE      QRYDATA,PTASF003
.
SPASF999  RETURN
+
.------------------------------------------------------------
. Ward selection - Ward Only (use Ward/Bed search for Bed Wards)
.------------------------------------------------------------
.
WSEL0000  PACK      KEY29,SP70
          IF        IBCNMHOS = 1
            PACK      KEY29,SP3,WBSEHOSP,SP70
          ENDIF
          CALL      RDSWARD7
WSEL0100  CALL      RDKWARD7
          BRANCH    OVRCD,WSEL9999
.
.                         if we have a bed number we have passed all the ward
.                         master records, so exit
          MATCH     SP70,WBED
          GOTO      WSEL9999 IF NOT EQUAL
.
          COMPARE   WACTIVE,ZERO                 *List only active wards
          GOTO      WSEL0100 IF NOT EQUAL
.
          IF        IBCNMHOS = 1
            MATCH      SP3,WBSEHOSP
            IF        !@EQUAL
              MATCH     WBSEHOSP,PTWDHOSN
              GOTO      WSEL9999 IF NOT EQUAL
            ENDIF
          ENDIF
.
.                       write the select option.
          WRITE     HTMLFILE;"<option value=#"",WWARD,"#"";
          MATCH     DFLTWARD,WWARD
          IF        @EQUAL
            WRITE     HTMLFILE;" selected";
          ENDIF
          WRITE     HTMLFILE;">",WBDESC;
.
          IF        IBCNMHOS = 1
            MATCH      SP3,WBSEHOSP
            IF        @EQUAL
              WRITE     HTMLFILE;" - ",PTWDHOSN;
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"</option>"
          GOTO      WSEL0100
.
WSEL9999  RETURN
+
.------------------------------------------------------------
. CNLBT000 - Cancel Last Bed Transfer - by Admission number
. Returns:  EXIT  0 = Ok to continue
.                 1 = Error
.------------------------------------------------------------
.
CNLBT000  MOVE      ZERO,CANTYPE
          PACK      KEY8,ADMISSNO
          CALL      RLPTMIS1                     * admission record found ?
          BRANCH    OVRCD,CNLBT990:              * no
                          CNLBT991               * yes - already locked
.
          BRANCH    ASTAT,CNLBT992,CNLBT010,CNLBT993,CNLBT010,CNLBT992
.
CNLBT010  MOVE      SP1,STMOVE
          PACK      KEY30,AADMNO,SP30
          CALL      RDSTRAN2
CNLBT020  CALL      RDKTRAN2
          BRANCH    OVRCD,CNLBT030
.
          MATCH     TADMN,AADMNO
          GOTO      CNLBT030 IF NOT EQUAL
.
          MOVE      TMOVE,STMOVE
          MOVE      TMOVE,LASTTRAN          * save the last tran record
          MOVE      PTTREPNO,STEPNO         * save last episode number
          MOVE      TADOCT,SAVDOCT          * save last doctor
          PACK      MEHKEY24,AADMNO,TDATE,TTIME
          MOVE      TDATE,LCHGDATE          * save last transfer date
          MOVE      TTIME,LCHGTIME          * save last transfer time
          MOVE      TURNO,LCHGURNO          * save U/R No.
          GOTO      CNLBT020
.
CNLBT030  MATCH     SP1,STMOVE
          GOTO      CNLBT994 IF EQUAL
.
          CMATCH    ANSA,STMOVE
          GOTO      CNLBT995 IF EQUAL
.
          PACK      KEY8,AURNO
          CALL      RDMAST1
          BRANCH    OVRCD,CNLBT996
.
          MOVE      AURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          PACK      KEY8,AADMNO
          CALL      RDVISA1
          BRANCH    OVRCD,CNLBT997
.
          CALL      LTRND000                * Find Last two transaction details
.
          MATCH     SP8,LSTDATE
          GOTO      CNLBT994 IF EQUAL
.
          MATCH     ALACDTE,STDATE
          GOTO      CNLBT040 IF NOT LESS
          GOTO      CNLBT998
.
CNLBT040  UNPACK    STDATE,XCENT,XYEAR,XMON,XDAY
.
.         Determine type of record
.
          CMATCH    ANSL,STMOVE
          GOTO      CNLBT060 IF EQUAL
.
          CMATCH    ANSR,STMOVE
          GOTO      CNLBT070 IF EQUAL
.
          CMATCH    ANSC,STMOVE
          GOTO      CNLBT989  IF NOT EQUAL
.
.         Change record - check for a change in ward/bed
.
          MATCH     STWARD,LSTWARD
          GOTO      CNLBT050 IF NOT EQUAL
.
          MATCH     STBED,LSTBED
          GOTO      CNLBT050 IF NOT EQUAL
.
.        Check for a change in doctor/admission type
.
          MATCH     STADOCT,LSTADOC
          GOTO      CNLBT075 IF NOT EQUAL
.
          MATCH     STDEPT,LSTUNIT
          GOTO      CNLBT075 IF NOT EQUAL
.
          MATCH     STATEAM,LSTTEAM
          GOTO      CNLBT075 IF NOT EQUAL
.
          MATCH     STATYPE,LSTATYP
          GOTO      CNLBT075 IF NOT EQUAL
.
          MATCH     STACLM,LSTACLM
          GOTO      CNLBT075 IF NOT EQUAL
.
          MOVE      ZERO,EXIT
          GOTO      CNLBT080
.
CNLBT050  MOVE      THREE,CANTYPE
          MOVE      "Cancelling Bed Transfer",WEBTITLE
          CALL      CLBTOL00                * check if old bed has been taken
          MOVE      ADMISSNO,KEY8
          CALL      UUPTMIS1
          BRANCH    EXIT,CNLBT999
          GOTO      CNLBT080
.
CNLBT060  MOVE      FIVE,CANTYPE
          MOVE      "Cancelling Leave From Bed",WEBTITLE
          CALL      CLBTOL00                * check if old bed has been taken
          MOVE      ADMISSNO,KEY8
          CALL      UUPTMIS1
          BRANCH    EXIT,CNLBT999
          GOTO      CNLBT080
.
CNLBT070  MOVE      "Cancelling Return From Leave",WEBTITLE
          MOVE      FOUR,CANTYPE
          GOTO      CNLBT080
.
CNLBT075  MOVE      TWO,CANTYPE
          MOVE      "Cancelling Admission Type/Attending Doctor",WEBTITLE
.
CNLBT080  CALL      DELTRN00                * Delete appropriate transfer record
.
          IF        CHOSTYP=1 & CFEETYP=0
            MOVE      FIVE,PTIPRSTA         * Update Bed fees
            CALL      CINVP000              * Check for tobe invoiced
          ENDIF
.
          MOVE      ADMISSNO,KEY8
          CALL      UUPTMIS1
          BRANCH    EXIT,CNLBT999
.
          MOVE      ZERO,EXIT
          GOTO      CNLBT999
.
.  Web Error displays
.
CNLBT989  MOVE      "Invalid Transfer Record Found",WEBTITLE
          CALL      WEBERR00
          MOVE      ADMISSNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      CNLBT999
.
CNLBT990  MOVE      "Invalid Admission Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CNLBT999
.
CNLBT991  MOVE      "Patient Locked",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CNLBT999
.
CNLBT992  MOVE      ADMISSNO,KEY8
          CALL      UUPTMIS1
          MOVE      "Admission Not Admitted",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CNLBT999
.
CNLBT993  MOVE      ADMISSNO,KEY8
          CALL      UUPTMIS1
          MOVE      "Admission Is Discharged",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CNLBT999
.
CNLBT994  MOVE      ADMISSNO,KEY8
          CALL      UUPTMIS1
          MOVE      "Admission Transfer Record not found",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CNLBT999
.
CNLBT995  MOVE      ADMISSNO,KEY8
          CALL      UUPTMIS1
          MOVE      "Admission has no Transfers",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CNLBT999
.
CNLBT996  MOVE      ADMISSNO,KEY8
          CALL      UUPTMIS1
          MOVE      "Master File Data Missing",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CNLBT999
.
CNLBT997  MOVE      ADMISSNO,KEY8
          CALL      UUPTMIS1
          MOVE      "Visit File Record Missing",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CNLBT999
.
CNLBT998  MOVE      ADMISSNO,KEY8
          CALL      UUPTMIS1
          MOVE      "Transaction has Already been Invoiced",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CNLBT999
.
CNLBT999  RETURN
+
.------------------------------------------------------------
. CLBTOL00 - Cancelling Bed Transfer / On Leave
. Returns:    EXIT  0 = Ok to continue
.                   1 = Error
.------------------------------------------------------------
.
.         Check if the old bed has been taken
.
CLBTOL00  MATCH     SP3,LSTBED
          GOTO      CLBTOL90 IF EQUAL       * No-Bed wards are always available
.
          MOVE      LSTWARD,TWARD
          MOVE      LSTBED,TBED
.
          PACK      KEY6,TWARD,TBED
          CALL      RDWARD1
          BRANCH    OVRCD,CLBTOL91
.
          MATCH     ZEROVISN,WADMNO
          GOTO      CLBTOL92 IF NOT EQUAL
.
CLBTOL90  MOVE      ZERO,EXIT
          GOTO      CLBTOL99
.
CLBTOL91  CLEAR     WEBTITLE
          APPEND    "Ward/Bed ",WEBTITLE
          APPEND    TWARD,WEBTITLE
          APPEND    SLASH,WEBTITLE
          APPEND    TBED,WEBTITLE
          APPEND    " Not Found",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CLBTOL99
.
CLBTOL92  MOVE      WADMNO,DIM8
.
          CLEAR     WEBTITLE
.         APPEND    "Ward/Bed ",WEBTITLE
.
          PACK      KEY6,TWARD,SP70
          CALL      RDWARD1
          IF        OVRCD=1
            APPEND    TWARD,WEBTITLE
          ELSE
            STRIP     WBDESC
            APPEND    WBDESC,WEBTITLE
          ENDIF
.
          APPEND    SLASH,WEBTITLE
.
          PACK      KEY6,TWARD,TBED,SP70
          CALL      RDWARD1
          IF        OVRCD=1
            APPEND    TBED,WEBTITLE
          ELSE
            STRIP     WBDESC
            APPEND    WBDESC,WEBTITLE
          ENDIF
.
          APPEND    " taken by Adm ",WEBTITLE
          APPEND    DIM8,WEBTITLE
          APPEND    " Please Transfer.",WEBTITLE
.          APPEND    "Cancelling Patient's Transfer ",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
CLBTOL99  RETURN
+
.------------------------------------------------------------
.  Last two transaction details
.------------------------------------------------------------
.
LTRND000  MOVE      SP8,STDATE
          MOVE      SP8,STTIME
          MOVE      SP3,STWARD
          MOVE      SP3,STBED
          MOVE      SP3,STATYPE
          MOVE      SP70,STACLM
          MOVE      SP70,STFUND
          MOVE      SP6,STADOCT
          MOVE      SP6,STATEAM
          MOVE      SP6,STDEPT
          MOVE      SP1,STMOVE
          MOVE      ZERO,STEPNO
          MOVE      ZERO,STRATEF
.
.         Loop over the transfer file
.
          PACK      KEY30,AADMNO,SP30
          CALL      RDSTRAN2
LTRND010  CALL      RDKTRAN2
          BRANCH    OVRCD,LTRND999
.
          MATCH     TADMN,AADMNO
          GOTO      LTRND999 IF NOT EQUAL
.
          MOVE      STDATE,LSTDATE
          MOVE      STTIME,LSTTIME
          MOVE      STWARD,LSTWARD
          MOVE      STBED,LSTBED
          MOVE      STATYPE,LSTATYP
          MOVE      STACLM,LSTACLM
          MOVE      STFUND,LSTFUND
          MOVE      STADOCT,LSTADOC
          MOVE      STATEAM,LSTTEAM
          MOVE      STDEPT,LSTUNIT
          MOVE      STEPNO,LSTEPNO
          MOVE      STRATEF,LSTRATE
.
          MOVE      TDATE,STDATE
          MOVE      TTIME,STTIME
          MOVE      TWARD,STWARD
          MOVE      TBED,STBED
          MOVE      TATYPE,STATYPE
          MOVE      PTTRCLTY,STACLM
          MOVE      PTTRFSRC,STFUND
          MOVE      TADOCT,STADOCT
          MOVE      PTTRTEAM,STATEAM
          MOVE      TDEPT,STDEPT
          MOVE      PTTREPNO,STEPNO
          MOVE      TMOVE,STMOVE
          MOVE      TRBTYP,STRBTYP
          MOVE      TRBEND,STRBEND
          MOVE      PTTRAEND,SPTTRAEN
          MOVE      TCHSTAT,STCHSTAT
.
.         Calculate new rate
.
          MOVE      TRATEF,STRATEF
          ADD       TRATEH,STRATEF
          ADD       PTTRADPT,STRATEF
          ADD       PTTRADRB,STRATEF
          ADD       TEXTRA,STRATEF
          SUB       TDISC,STRATEF
          SUB       TALLW,STRATEF
          GOTO      LTRND010
.
LTRND999  RETURN
+
.------------------------------------------------------------
. DELTRN00 -  Cancel the appropriate type of transfer file record
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
.
DELTRN00  BRANCH    CANTYPE,DELTRN91,DELTRN20,DELTRN30,DELTRN40,DELTRN50
.
DELTRN20  CALL      DELADC00                * delete admission type/doctor chge
          BRANCH    EXIT,DELTRN98
          GOTO      DELTRN90
.
DELTRN30  CALL      DELBTR00                * delete a bed transfer
          BRANCH    EXIT,DELTRN98
          GOTO      DELTRN90
.
DELTRN40  CALL      DELRET00                * delete a return from leave
          BRANCH    EXIT,DELTRN98
          GOTO      DELTRN90
.
DELTRN50  CALL      DELONL00                * delete an on leave
          BRANCH    EXIT,DELTRN98
          GOTO      DELTRN90
.
DELTRN90  MOVE      ZERO,EXIT
          GOTO      DELTRN99
.
DELTRN91  MOVE      "Incorrect Cancellation Type",WEBTITLE
          CALL      WEBERR00
DELTRN98  MOVE      ONE,EXIT
.
DELTRN99  RETURN
+
.------------------------------------------------------------
. DELADC00 - Delete an admission type/attending doctor change
. Returns:  EXIT   0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
.
DELADC00  MOVE      LSTATYP,ATYPE
          MOVE      LSTACLM,ACLAIM
          MOVE      LSTADOC,ADOCTA
          MOVE      LSTUNIT,ACLSSFT
          CALL      UPLMISS1
          CALL      UUPTMIS1
          PACK      KEY8,AADMNO,SP70
          CALL      RDPMVX11
          IF        OVRCD<>1
            MOVE      LSTTEAM,PMVXTEAM
            MOVE      LSTFUND,PMVXFSRC      * in case funding source is chagned
            CALL      UPPMVX11
          ENDIF
.
.        If Doctor has changed update the visit file
.
DELADC10  MATCH     SP6,LSTADOC
          IF        !@EQUAL
            PACK      KEY8,AADMNO
            CALL      RLPTVIS1
            IF        OVRCD = 0
              MOVE      LSTADOC,PVIDOCT
              CALL      UPVISA1
              CALL      UUPTVIS1
            ELSE
              IF        OVRCD = 2
                GOTO      DELADC90          * Error, patient locked
              ENDIF
            ENDIF
          ENDIF
.
.         Note:  Commented this trigger code out as this routine appears
.                to only be for changes to ADOCTA, ACLAIM, ACLSSFT and ATYPE
.                and as such only requires an update message (A08).
.                Any cancel of a ward/bed transfer is handled elsewhere
.                (Trigger id 15).
.         Broadcast transfer cancellation to Datagate BEFORE deleting record
.
.         RESET     KEY30
.         PACK      KEY30,AADMNO,STDATE,STTIME,STWARD,STBED,SP70
.         CALL      RDTRAN2
.
.         PACK      KEY8,AADMNO,SP70
.         CALL      RDPTRES1
.         IF        OVRCD=1
.           CALL      CPTRE100
.         ENDIF
.
.         CALL      PMIGTNID                 * get national id for dgate write
.         MOVE      NMPNUMB,PTNINMPI
.         MOVE      TEN1,HL7TRGID
.         MOVE      SP8,HL7INCLD
.         PROC      DGCLICCT                * b'cast cancel transfer  *C-090222
.
.        Delete transfer file record
.
          PACK      KEY30,AADMNO,STDATE,STTIME,STWARD,STBED,SP70
          CALL      DETRAN2
          MOVE      "18 ",ALTTYPE
          MOVE      SP70,ALTOLDVL
          MOVE      SP70,ALTNEWVL
          CALL      WEAL0000                * Write EDWARD alteration record
.
.         Reposition on the previous transfer record and send an
.         update visit message (A08) if required
.
          PACK      KEY30,AADMNO,STDATE,STTIME,STWARD,STBED
          CALL      RDSTRAN2                * position on deleted record
          CALL      RDPTRAN2                * read previous record
          BRANCH    OVRCD,DELADC98          * record not found - error
.
          MATCH     AADMNO,TADMN            * same admission still ?
          GOTO      DELADC98 IF NOT EQUAL   * no - error
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPTRES1
          IF        OVRCD=1
            CALL      CPTRE100
          ENDIF
.
          CALL      PMIGTNID                 * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TEN2,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICAC                * b'cast update visit
.
.        Update the control file with the transfer date if necessary
.
          CALL      UPDCFR00
.
          CALL      MEHD0000                * update mental health details
.
          MOVE      ZERO,EXIT
          GOTO      DELADC99
.
DELADC90  CLEAR     WEBTITLE
          APPEND    "Visit ",WEBTITLE
          APPEND    PVIBILL,WEBTITLE
          APPEND    " Locked on Port ",WEBTITLE
          APPEND    PVILOCK,WEBTITLE
          CALL      WEBERR00
DELADC98  MOVE      ONE,EXIT
.
DELADC99  RETURN
+
.------------------------------------------------------------
. DELBTR00 - Delete a bed transfer
. Returns:  EXIT  0 = Ok to continue
.                 1 = Error
.------------------------------------------------------------
.
DELBTR00  MOVE      STWARD,AWARD
          MOVE      STBED,ABED
          CALL      RELBED00                * release aadmno in award/abed
          BRANCH    EXIT,DELBTR98
.
          MOVE      LSTWARD,AWARD
          MOVE      LSTBED,ABED
.
.         put the patient into the old bed
.
          MATCH     SP3,LSTBED
          GOTO      DELBTR10 IF EQUAL
.
          PACK      KEY6,LSTWARD,LSTBED,SP70
          CALL      RDWARD1
.
          MATCH     ZEROVISN,WADMNO
          GOTO      DELBTR20 IF NOT EQUAL
.
.         put the patient into this bed
.
          MOVE      AADMNO,WADMNO
          CALL      UPWARD1
          GOTO      DELBTR30
.
DELBTR10  MOVE      APLUR,NBPLUR            * put patient into no-bed ward
          MOVE      SP3,NBROOM
          PACK      KEY13,LSTWARD,AADMNO,NBPLUR
          CALL      RANOBE1
          IF        OVRCD=1
            CALL      WRNOBE1
          ENDIF
          GOTO      DELBTR30
.
DELBTR20  MOVE      AADMNO,WSTBY            * Someone has grabbed this bed -
          CALL      UPWARD1                 * put the patient on standby
          MOVE      SP3,AWARD
          MOVE      SP3,ABED
.
DELBTR30  MOVE      LSTADOC,ADOCTA          * in case doctor also changed
          MOVE      LSTUNIT,ACLSSFT         * in case unit changed
          MOVE      LSTATYP,ATYPE           * Admission type may have changed
          MOVE      LSTACLM,ACLAIM          * Claim type may have changed
          CALL      UPLMISS1
          PACK      KEY8,AADMNO,SP70
          CALL      RDPMVX11
          IF        OVRCD<>1
            MOVE      LSTTEAM,PMVXTEAM      * in case team also changed
            MOVE      LSTFUND,PMVXFSRC      * in case funding source is chagned
            CALL      UPPMVX11
          ENDIF
.
.         Update the Ward Usage Statistics
.
          MATCH     LSTWARD,STWARD          * old ward??
          GOTO      DELBTR50 IF EQUAL
.
          MOVE      LSTDATE,CPTDATE
          REP       " 0",CPTDATE
          CALL      GPERD                   * Get the financial period for date
          BRANCH    EXIT,DELBTR90           * Date not in period file
.
          PACK      KEY9,LSTWARD,DRGYR,DRGNUM
          MOVE      THREE,COUNT             * Number of Transfers out
          MOVE      SEQ,FORM2
.
          MOVE      STDATE,CPTDATE          * new ward??
          REP       " ",CPTDATE
          CALL      GPERD                   * Get the financial period for date
          BRANCH    EXIT,DELBTR90           * Date not in period file
.
          PACK      KEY9,LSTWARD,DRGYR,DRGNUM
          MOVE      THREE,COUNT             * Number of Transfers out
          MOVE      SEQ,FORM2
.
.         Check for a standby patient to be put into the old bed
.
DELBTR50  MOVE      STWARD,LWARD
          MOVE      STBED,LBED
          MOVE      AADMNO,TADMN
          MOVE      ONE,DELBTRFL          * delete bed transfer flag = yes
          CALL      SBYPT000
          BRANCH    EXIT,DELBTR98
.
          MOVE      TADMN,KEY8
          CALL      RDMISS1               * re-read admission record
.
          CALL      UPDFIL00              * Update files used by transfer type
          BRANCH    EXIT,DELBTR98
.
.         Only generate A08 here for standby patient if one exists (TSK 0935183)
.
          IF        DELBTRFL=1
            MATCH     SP70,SAVWSTBY
            IF        !@EQUAL
              MOVE      SAVWSTBY,KEY8
              CALL      RDMISS1             * get standby admission
              IF        OVRCD<>1
                CALL      GENU0000          * Generate HL7 A08 (update) message
                MOVE      SP70,SAVWSTBY
              ENDIF
            ENDIF
          ENDIF
.
          PACK      KEY8,AADMNO
          CALL      UUPTMIS1
          MOVE      ZERO,EXIT
          GOTO      DELBTR99
.
DELBTR90  MOVE      "Date not found in period File",WEBTITLE
          CALL      WEBERR00
.
DELBTR98  PACK      KEY8,AADMNO
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      DELBTR99
.
DELBTR99  MOVE      ZERO,DELBTRFL           * reset delete bed transfer flag
          RETURN
+
.------------------------------------------------------------
.  Update common files used by bed/on-leave/return from leave transfer types
.------------------------------------------------------------
.
.         If doctor has changed update the visit file
.
UPDFIL00  MATCH     SP6,LSTADOC
          IF        !@EQUAL
            CALL      UPDVIS00              * update visit file
            BRANCH    EXIT,UPDFIL91
          ENDIF
.
.         Broadcast transfer cancellation to Datagate BEFORE deleting record
.
          PACK      KEY30,AADMNO,STDATE,STTIME,STWARD,STBED
          CALL      RDTRAN2
.
.         If a leave record is being deleted where there is a corresponding
.         return pattranf record as the last pattranf record for the visit,
.         then we don't want to send any message as the patient will still
.         be "admitted".  Likewise, if a leave record or return from leave
.         record is being deleted where the leave record is not the last
.         pattranf record (ie the patient is discharged), then we don't
.         want to send any message.
.
          MOVE      ZERO,SAVTRGID
.
          IF        LEAVEFLG = 0 & CANTYPE = 0
            GOTO      UPDFIL50
          ENDIF
.
          MOVE      AURNO,KEY8              * first - get the PMI details
          CALL      RDMAST1
          BRANCH    OVRCD,UPDFIL91
.
          MOVE      AURNO,KEY8
          CALL      RDPMPX21
          BRANCH    OVRCD,UPDFIL91
.
.         If we are cancelling an on-leave, then simply send a return
.         from leave message (as there is no cancel on-leave HL7 message).
.         If we are cancelling a return from leave, then simply send an on-leave
.         message (as there is no cancel return from leave HL7 message).
.         If we are cancelling an on-leave and a return from leave where
.         they are the last 2 movements for the visit, then send and on-leave
.         message and a return from leave message where both messages use the
.         on-leave date/time (CANTYPE = 0 and LEAVEFLG = 2).
.
          IF        CANTYPE = 5
            CALL      PMIGTNID              * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      TEN3,HL7TRGID
            MOVE      TEN3,SAVTRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICPR              * broadcast A22/CPR
          ELSE
            IF        CANTYPE = 4 | (CANTYPE = 0 & LEAVEFLG = 2)
              CALL      RDPTRAN2
              BRANCH    OVRCD,UPDFIL50        * record not found - error
.
              MATCH     AADMNO,TADMN          * same admission still ?
              GOTO      UPDFIL50 IF NOT EQUAL * no - error
.
              MATCH     "L",TMOVE
              GOTO      UPDFIL50 IF NOT EQUAL * want leave record only
.
              CALL      PMIGTNID            * get national id for dgate write
              MOVE      NMPNUMB,PTNINMPI
              MOVE      TEN4,HL7TRGID
              MOVE      SP8,HL7INCLD
              PROC      DGCLICPO            * broadcast A21/CPO
.
.             If we are cancelling an on-leave record (which is followed by
.             a return from leave record which is the last movement record
.             for the visit), then we need to generate a return from leave
.             message with the same time as the on-leave message, which
.             signals the effective cancellation of the original leave/return
.             from leave.
.
              IF        CANTYPE = 0 & LEAVEFLG = 2
                CALL      PMIGTNID          * get national id for dgate write
                MOVE      NMPNUMB,PTNINMPI
                MOVE      FORTY2,HL7TRGID
                MOVE      FORTY2,SAVTRGID
                MOVE      SP8,HL7INCLD
                PROC      DGCLICPR          * broadcast A22/CPR
              ENDIF
            ENDIF
          ENDIF
.
.         Delete transfer file record
.
UPDFIL50  PACK      KEY30,AADMNO,STDATE,STTIME,STWARD,STBED
          CALL      DETRAN2
          MOVE      "18 ",ALTTYPE
          MOVE      SP70,ALTOLDVL
          MOVE      SP70,ALTNEWVL
          CALL      WEAL0000                * Write EDWARD alteration record
.
          IF        CANTYPE=5
            MATCH     STDATE,ADATE
            IF        @EQUAL
              CALL      GETREC00            * get record before deleted one
            ENDIF
          ENDIF
.
.         If we are cancelling a transfer, then we need to read the previous
.         transfer record to get the ward the patient was in prior to the
.         transfer (for PV1-03) for the broadcast message
.
          IF        CANTYPE = 3
            PACK      KEY30,AADMNO,STDATE,STTIME,STWARD,STBED
            CALL      RDSTRAN2              * position on deleted record
            CALL      RDPTRAN2              * read previous record
            BRANCH    OVRCD,UPDFIL91        * record not found - error
.
            MATCH     AADMNO,TADMN          * same admission still ?
            GOTO      UPDFIL91 IF NOT EQUAL * no - error
.
            PACK      KEY8,AADMNO,SP70
            CALL      RDPTRES1
            IF        OVRCD=1
              CALL      CPTRE100
            ENDIF
.
            CALL      PMIGTNID              * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      TEN5,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICCT              * b'cast A12/CCT
          ENDIF
.
.         Update the control file with the transfer date if necessary
.
          CALL      UPDCFR00                * Update the control file
.
          CALL      MEHD0000                * update mental health details
.
.         Send A08 after A22 based on parameter       (TSK 0916627)
.
          MATCH     "1",PTCNSRFL
          GOTO      UPDFIL90 IF NOT EQUAL
.
          IF        SAVTRGID = 13 | SAVTRGID = 42
.
            PACK      KEY8,AADMNO,SP70
            CALL      RDPTRES1
            IF        OVRCD=1
              CALL      CPTRE100
            ENDIF
.
            MOVE      ZERO,SAVTRGID
            CALL      PMIGTNID              * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      FORTY3,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICAC              * broadcast update A08
          ENDIF
.
UPDFIL90  MOVE      ZERO,EXIT
          GOTO      UPDFIL99
.
UPDFIL91  MOVE      ONE,EXIT
.
UPDFIL99  RETURN
+
.------------------------------------------------------------
.  Find transfer record before deleted record
.------------------------------------------------------------
.
GETREC00  PACK      KEY30,AADMNO,STDATE,STTIME,STWARD,STBED
          CALL      RDSTRAN2
          CALL      RDPTRAN2            * get record before deleted one
.
          MOVE      ADATE,NEWTDATE
          MOVE      TWARD,NEWTWARD
          MOVE      TATYPE,NEWTATYP
          MOVE      TRBTYP,NEWTBTYP
          MOVE      TCHSTAT,NEWTCHST
          MOVE      TDEPT,NEWTDEPT
          MOVE      PTTRTEAM,NEWTEAM
.
          CALL      BRAT0000
          MOVE      SAVEND,TRBEND
          MOVE      ADDEND,PTTRAEND
          MOVE      SAVPAT,TRATEF
          MOVE      SAVHF,TRATEH
          MOVE      ADISC,TDISC
          MOVE      ZERO,TALLW
          MOVE      SAVEXTR,TEXTRA
          MOVE      AUSR2,TCHSTAT
          PACK      TRCDATE,CCC,CYY,CMM,CDD
          REP       " 0",TRCDATE
          CLOCK     TIME,TRCTIME
          MOVE      WBSEUID,PTTRUUID
.
          CALL      UPTRAN2
.
GETREC99  RETURN
+
.------------------------------------------------------------
. UPDVIS00 - Update Visit File
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
.
UPDVIS00  PACK      KEY8,AADMNO
          CALL      RLPTVIS1                     * visit record found ?
          BRANCH    OVRCD,UPDVIS91:              * no
                          UPDVIS92               * yes - already locked
.
          MOVE      LSTADOC,PVIDOCT
          CALL      UPVISA1
          CALL      UUPTVIS1
.
          MOVE      ZERO,EXIT
          GOTO      UPDVIS99
.
UPDVIS91  MOVE      "Admission record not found",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDVIS99
.
UPDVIS92  MOVE      "Visit Locked",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDVIS99
.
UPDVIS99  RETURN
+
.------------------------------------------------------------
. RELBED00 - Subroutine to release the patient AADMNO in ward/bed AWARD/ABED
. From IBAPAT05 - RELBED.
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
.
RELBED00  PACK      KEY6,AWARD,ABED
          CALL      RDWARD1
          BRANCH    OVRCD,RELBED20
.
.        Check for a No-Bed ward
.
          MATCH     SP3,ABED
          GOTO      RELBED10 IF EQUAL
.
.        Check that this is the correct patient
.
          MATCH     WADMNO,AADMNO
          GOTO      RELBED20 IF NOT EQUAL
.
          MOVE      ZEROVISN,WADMNO
          MOVE      ZERO,WPLUR
          CALL      UPWARD1
          GOTO      RELBED90
.
.        No-Bed ward - just delete the record from the No-Bed file
.
RELBED10  MOVE      APLUR,NBPLUR
          PACK      KEY13,AWARD,AADMNO,NBPLUR
          CALL      RDNOBE1
          BRANCH    OVRCD,RELBED20
.
          CALL      DENOBE1
          GOTO      RELBED90
.
.        Standby Patient - search through the standby index
.
RELBED20  MOVE      AADMNO,WSTBY
          PACK      KEY14,WSTBY,SP70
          CALL      RDSWARD4
          CALL      RDKWARD4
          BRANCH    OVRCD,RELBED91
.
          MATCH     WSTBY,AADMNO
          GOTO      RELBED91 IF NOT EQUAL
.
          PACK      KEY6,WWARD,WBED
          CALL      RDWARD1
          MOVE      ZEROVISN,WSTBY
          CALL      UPWARD1
.
RELBED90  MOVE      ZERO,EXIT
          GOTO      RELBED99
.
RELBED91  MOVE      "Ward Bed Inconsistency",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
RELBED99  RETURN
+
.*********************************************************************
.*                  MEHD0000                    Called by : DELTREC  *
.*               (from IBAPAT05)                                     *
.*        Handles Mental Health data when :                          *
.*        Cancelling last transfer file record.                      *
.*        Para's  : LASTTRAN      last tran record                   *
.*                  MEHKEY24      key for MEHDLVFD record            *
.*********************************************************************
.
MEHD0000  COMPARE   ONE,MHCNUSE
          GOTO      MEHD9999 IF NOT EQUAL   * not using mental health
.
          MATCH     SP3,PTMXLS
          GOTO      MEHD9999 IF EQUAL       * not a mental health patient
.
          PACK      KEY5,ANSL,ANSS,PTMXLS
          CALL      RDCODE1
          BRANCH    OVRCD,MEHD9999          * invalid legal status
.
          MATCH     ANSL,LASTTRAN
          GOTO      MEHD5000 IF EQUAL       * last record a leave record
.
          MATCH     ANSR,LASTTRAN
          GOTO      MEHD9999 IF NOT EQUAL   * not a return record
.
.         last record was a return record
.
          UNPACK    MEHKEY24,KEY8,DIM8A,KEY8
          PACK      KEY30,AADMNO,DIM8A,KEY8,Z10
          CALL      RDSTRAN2
.
MEHD1000  CALL      RDPTRAN2
          BRANCH    OVRCD,MEHD9999          * tran file stuffed
.
          MATCH     AADMNO,TADMN
          GOTO      MEHD9999 IF NOT EQUAL   * tran file stuffed
.
          MATCH     "L",TMOVE
          GOTO      MEHD1000 IF NOT EQUAL   * not the leave record
.
.         have the leave record so get the leave type
.
          MOVE      SP1,TCINDC1
          PACK      KEY5,ANST,ANSL,PTTRLTYP
          CALL      RDCODE1
          BRANCH    OVRCD,MEHD9999          * invalid type of leave
.
.         now update the visit status
.
          MOVE      AADMNO,KEY8
          CALL      RDMHVIS1
          BRANCH    OVRCD,MEHD9999          * no MH visit record
.
          MOVE      TWO,AUDIFLAG            * before change
          CALL      MHAUDVIS                * write audit
          REP       " 2T3H4A5",TCINDC1      * set the leave status
          MOVE      TCINDC1,MHVISTAT        * set status
          CALL      UPMHVIS1
          MOVE      THREE,AUDIFLAG          * after change
          CALL      MHAUDVIS                * write audit
          IF        MHCNKLER = 1
            PACK      KEY24,MEHKEY24
            CALL      RDMHLER1              * See if on file
            BRANCH    OVRCD,MEHD9999
            CALL      DEMHLER1              * delete record
          ENDIF
          GOTO      MEHD9999
.
.         last record was a leave record
.
MEHD5000  MOVE      AADMNO,KEY8             * update status on MEHVISFD
          CALL      RDMHVIS1
          BRANCH    OVRCD,MEHD9999
.
          MOVE      TWO,AUDIFLAG            * before change

          CALL      MHAUDVIS                * write audit
          MOVE      ONE,MHVISTAT            * set to In-hospital
          CALL      UPMHVIS1
          MOVE      THREE,AUDIFLAG          * after change
          CALL      MHAUDVIS                * write audit
.
          MOVE      MEHKEY24,KEY24          * delete MEHDLVFD record
          CALL      DEMHDLV1
          MOVE      FOUR,AUDIFLAG           * delete
          CALL      MHAUDDLV                * write audit
.
MEHD9999  RETURN
+
.------------------------------------------------------------
. SBYPT000 - Subroutine to put a standby patient into ward/bed LWARD/LBED
. From IBAPAT05 - STBYPAT.
. Returns:  EXIT  0 = Ok to continue
.                 1 = Error
.------------------------------------------------------------
.
SBYPT000  MOVE      SP70,SAVWSTBY
.
          PACK      KEY6,LWARD,LBED
          CALL      RDWARD1
          BRANCH    OVRCD,SBYPT900
.
          MATCH     ZEROVISN,WSTBY
          GOTO      SBYPT900 IF EQUAL
.
.        Get the patient details for this standby patient
.
          MOVE      WSTBY,AADMNO
          MOVE      AADMNO,KEY8
          CALL      RLPTMIS1                     * lock record
          BRANCH    OVRCD,SBYPT900:              * not found
                          SBYPT910               * already locked
.
.        Check that this patient is actually on standby
.
          MATCH     SP3,AWARD
          GOTO      SBYPT890 IF NOT EQUAL
.
          COMPARE   TWO,ASTAT
          GOTO      SBYPT890 IF NOT EQUAL
.
.        Check that we can actually put the patient into the bed
.
          MATCH     ZEROVISN,WADMNO
          GOTO      SBYPT890 IF NOT EQUAL
.
.        Put this standby patient into the bed
.
          MOVE      WSTBY,WADMNO
          MOVE      ZERO,WPLUR
          MOVE      ZEROVISN,WSTBY
          CALL      UPWARD1
.
.        Update the admission record with the ward/bed
.
          MOVE      LWARD,AWARD
          MOVE      LBED,ABED
          MOVE      ZERO,APLUR
          CALL      UPMISS1
.
          MOVE      URNUMBER,SAVEURNO    * Populate U/R and admission cgi vars
          MOVE      ADMISSNO,SAVADMIS    * with the standby patient
          MOVE      AURNO,URNUMBER
          MOVE      AADMNO,ADMISSNO
          MOVE      AADMNO,SAVWSTBY      * save standby admission number
.
          PROC      BBUP0000                * Bed Board
.
          MOVE      SAVEURNO,URNUMBER
          MOVE      SAVADMIS,ADMISSNO
.
.         Don't generate A08 here if we are cancelling a transfer (TSK 0935183)
.
          IF        DELBTRFL<>1
            CALL      GENU0000              * Generate HL7 A08 (update) message
          ENDIF
.
SBYPT890  CALL      UUPTMIS1
.
SBYPT900  MOVE      ZERO,EXIT
          GOTO      SBYPT999
.
SBYPT910  MOVE      "Patient Admission Locked ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
SBYPT999  RETURN
+
.*****************************************************************************
.*                            GENU0000             Called by: SBYPT000       *
.*     Generate an A08 (update) message for the patient who was on standby   *
.*     and is now going into the bed.                                        *
.* Requires: SAVEURNO - saved U/R number of original patient                 *
.*           SAVADMIS - saved admission                                      *
.*           Valid read of the standby patient's admission record            *
.*****************************************************************************
.
.         Read all the PMI records for the standby patient
.
GENU0000  MOVE      AURNO,KEY8
          CALL      RDMAST1                      * PMI record found ?
          BRANCH    OVRCD,GENU8000               * no - finished
.
          MOVE      AURNO,KEY8
          CALL      RDPMPX21                     * PMI ext. record found ?
          BRANCH    OVRCD,GENU7000               * no - finished
.
.         Read all the admission related records for the standby patient.
.         Note: The patmi1af record has already been read and as such,
.               so will the pmspx2af record.
.
          CALL      CLPATDSC
          IF        ASTAT = 3
            MOVE      AADMNO,KEY8
            CALL      RDDSCH1                    * discharge record on file ?
            BRANCH    OVRCD,GENU6000             * no - finished
          ENDIF
.
          MOVE      AADMNO,KEY8
          CALL      RDPTRES1                     * PRA record on file ?
          BRANCH    OVRCD,GENU5000               * no - finished
.
          PACK      KEY30,AADMNO,ZEDS
          CALL      RDSTRAN2                     * pos'n after last tran record
          CALL      RDPTRAN2                     * read previous record
          BRANCH    OVRCD,GENU4000               * eof - finished
.
          MATCH     AADMNO,TADMN                 * same admission still ?
          GOTO      GENU4000 IF NOT EQUAL        * no - finished
.
.         We have read all the files relevant to an A08 message, so
.         send the message.
.
          CALL      PMIGTNID                   * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      THIRTY4,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICAC                     * b'cast A08/CCT
.
.         Now we need to read the visit related records for the original
.         patient in the reverse order
.
GENU4000  PACK      KEY30,SAVADMIS,ZEDS
          CALL      RDSTRAN2                     * pos'n after last tran record
          CALL      RDPTRAN2                     * read previous record
          BRANCH    OVRCD,GENU5000               * eof
.
          MATCH     SAVADMIS,TADMN               * same admission still ?
          GOTO      GENU5000 IF NOT EQUAL        * no
.
GENU5000  MOVE      SAVADMIS,KEY8
          CALL      RDPTRES1                     * PRA record on file ?
          BRANCH    OVRCD,GENU6000               * no
.
GENU6000  CALL      CLPATDSC
          IF        ASTAT = 3
            MOVE      SAVADMIS,KEY8
            CALL      RDDSCH1                    * discharge record on file ?
            BRANCH    OVRCD,GENU7000             * no
          ENDIF
.
GENU7000  MOVE      SAVEURNO,KEY8
          CALL      RDPMPX21                     * PMI ext. record found ?
          BRANCH    OVRCD,GENU8000               * no
.
GENU8000  MOVE      SAVEURNO,KEY8
          CALL      RDMAST1                      * PMI record found ?
          BRANCH    OVRCD,GENU9000               * no
.
GENU9000  MOVE      SAVADMIS,KEY8
          CALL      RDMISS1                      * admission on file ?
          BRANCH    OVRCD,GENU9999               * no
.
GENU9999  RETURN
+
.------------------------------------------------------------
. DELONL00 - Delete an on leave record - put the patient back into old bed
. Returns:    EXIT   0 = Ok to continue
.                    1 = Error
.------------------------------------------------------------
.
DELONL00  COMPARE   ONE,LASTFLAG
          GOTO      DELONL40 IF NOT EQUAL
.
          MATCH     SP3,LSTBED
          GOTO      DELONL10 IF EQUAL
.
          PACK      KEY6,LSTWARD,LSTBED
          CALL      RDWARD1
.
          MATCH     ZEROVISN,WADMNO
          IF        !@EQUAL
            MATCH     AADMNO,WADMNO
            GOTO      DELONL20 IF NOT EQUAL
          ENDIF
.
.         Put the patient into this bed
.
          MOVE      AADMNO,WADMNO
          CALL      UPWARD1
          GOTO      DELONL30
.
.         Put the patient into a No-Bed ward
.
DELONL10  MOVE      APLUR,NBPLUR
          MOVE      SP3,NBROOM
          PACK      KEY13,LSTWARD,AADMNO,NBPLUR
          CALL      RANOBE1
          IF        OVRCD=1
            CALL      WRNOBE1
          ENDIF
          GOTO      DELONL30
.
.         Someone has grabbed this bed - put the patient on Standby
.
DELONL20  MOVE      AADMNO,WSTBY
          CALL      UPWARD1
          MOVE      SP3,LSTWARD
          MOVE      SP3,LSTBED
.
.         Update the admisison status
.
DELONL30  MOVE      TWO,ASTAT
          MOVE      LSTWARD,AWARD
          MOVE      LSTBED,ABED
          CALL      UPLMISS1
.
.         Cancel admission special funding arrangement code
.
          IF        PTCNHDPS=3
            CALL      CLAMFN00              * cancel admission funding
          ENDIF
.
.         Delete the On-leave record
.
          PACK      KEY14,STWARD,STBED,AADMNO
          CALL      DEONLV1
.
.         Update the Ward Usage Statistics
.
          MOVE      STDATE,CPTDATE
          REP       " 0",CPTDATE
          CALL      GPERD                   * Get the financial period for date
          BRANCH    EXIT,DELONL90           * Date not in period file
.
          PACK      KEY9,STWARD,DRGYR,DRGNUM
          MOVE      FIVE,COUNT
          MOVE      SEQ,FORM2
.
.         Write a HCS audit record (An Undischarge Record)
.
          MOVE      ONE,SKIPAUWR            * Skip audit record write
          CALL      DISHCS00
.
DELONL40  CALL      UPDFIL00
          BRANCH    EXIT,DELONL91
.
          CALL      DELLR000                * delete leave register
          MOVE      ZERO,EXIT
          GOTO      DELONL99
.
DELONL90  MOVE      "Date not found in period File",WEBTITLE
          CALL      WEBERR00
DELONL91  MOVE      ONE,EXIT
.
DELONL99  RETURN
+
.------------------------------------------------------------
.  Cancel admission special funding arrangement code
.------------------------------------------------------------
.
CLAMFN00  PACK      KEY25,AADMNO,ANSL,STDATE,STTIME
          CALL      RDPTASF1                * Read the admission SFA file
          IF        OVRCD<>1
            PACK      KEY25,PTAFADMN,PTAFTYPE,PTAFDATE,PTAFTIME
            CALL      DEPTASF1              * Delete the admission SFA
          ENDIF
.
CLAMFN99  RETURN
+
.------------------------------------------------------------
.  Delete a return record from leave - Release the current bed
. Returns:  EXIT  0 = Ok to continue
.                 1 = Error
.------------------------------------------------------------
.
DELRET00  MOVE      STWARD,AWARD
          MOVE      STBED,ABED
          COMPARE   ONE,LASTFLAG
.         GOTO      DELRET10 IF NOT EQUAL
          IF        !@EQUAL
            IF        LEAVEFLG=TWO
              PACK      SAVSTDM6,STWARD,STBED,SP70
              PACK      SAVLSTD6,LSTWARD,LSTBED,SP70
              MATCH     SAVSTDM6,SAVLSTD6
              IF        !@EQUAL
                CALL      RELBED00                * release aadmno in award/abed
                BRANCH    EXIT,DELRET91
              ENDIF
            ENDIF
            GOTO      DELRET10
          ENDIF
.
          CALL      RELBED00                * release aadmno in award/abed
          BRANCH    EXIT,DELRET91
.
.         write an on-leave record
.
          MOVE      SP3,OROOM
          PACK      KEY14,LSTWARD,LSTBED,AADMNO
          CALL      RDONLV1
          IF        OVRCD = 1
            MOVE      SP3,OROOM
            MOVE      LSTWARD,OWARD
            MOVE      LSTBED,OBED
            PACK      OERDATE,ARETDTE,SP70  * expected return date
            MOVE      SP8,OERTIME
            CALL      WRONLV1
          ENDIF
.
.         Update HCS Audit File ( An Unadmit record)
.
          MOVE      ONE,SKIPAUWR            * Skip audit record write
          CALL      ADMHCS00
.
.         Update the admission status
.
          PACK      KEY8,AADMNO
          CALL      RDMISS1
.
          MOVE      FOUR,ASTAT
          MOVE      LSTWARD,AWARD
          MOVE      LSTBED,ABED
          CALL      UPLMISS1
.
.         Update the Ward Usage Statistics
.
DELRET10  MOVE      LSTDATE,CPTDATE
          REP       " 0",CPTDATE
          CALL      GPERD                   * Get the financial period for date
          BRANCH    EXIT,DELRET90
.
          PACK      KEY9,LSTWARD,DRGYR,DRGNUM
          MOVE      SIX,COUNT               * Number of Returns
          MOVE      SEQ,FORM2
.
          CALL      UPDFIL00              * Update files used by transfer type
          BRANCH    EXIT,DELRET91
.
          PACK      KEY8,AADMNO
          CALL      UUPTMIS1
.
          CALL      DELRT000                * delete leave register
          MOVE      ZERO,EXIT
          GOTO      DELRET99
.
DELRET90  MOVE      "Date not found in period File",WEBTITLE
          CALL      WEBERR00
DELRET91  MOVE      ONE,EXIT
.
DELRET99  RETURN
+
.------------------------------------------------------------
. ADMHCS00 - Check for HCS Indicator
.         From IBAPAT05 - ADMHCS.
.
.         Params:
.           SKIPAUWR - skip audit record write?
.------------------------------------------------------------
.
ADMHCS00  COMPARE   ONE,CHCS
          GOTO      ADMHCS10 IF NOT EQUAL
.
          COMPARE   THREE,ASTAT
          GOTO      ADMHCS10 IF NOT EQUAL
.
          MOVE      AADMNO,KEY8
          CALL      RDDSCH1
          BRANCH    OVRCD,ADMHCS10
.
          MATCH     CHCSDTE,DDATE
          GOTO      ADMHCS99 IF LESS
.
.       Write to HCS Admission audit file
.

ADMHCS10  MOVE      AADMNO,PTUNADMN
          MOVE      ZERO,PTUNSENT
          CALL      IBACLOCK
          PACK      PTUNDATE,CCC,CYY,CMM,CDD
          REP       " 0",PTUNDATE
          MOVE      CTIMEIS,PTUNTIME
          REP       " 0",PTUNTIME
          MOVE      USERID,PTUNAUID
          PACK      PTUNCANC,SP70
.
          MATCH     "1",PTUNTYPE
          IF        @EQUAL
            PACK      PTUNCANC,TRNUREAS,SP70
          ENDIF
          MATCH     "2",PTUNTYPE
          IF        @EQUAL
            PACK      PTUNCANC,DDATREAS,SP70
          ENDIF
          MATCH     "3",PTUNTYPE
          IF        @EQUAL
            PACK      PTUNCANC,ADMNREAS,SP70
          ENDIF
          MATCH     "4",PTUNTYPE
          IF        @EQUAL
            PACK      PTUNCANC,DSCHREAS,SP70
          ENDIF
          MOVE      SP70,PTUNDTYP           * Discharge status
          MATCH     "2",PTUNTYPE
          GOTO      ADMHCS14 IF EQUAL       * Undischarged
          MATCH     "4",PTUNTYPE
          GOTO      ADMHCS16 IF NOT EQUAL   * Not changing disc.date
.
ADMHCS14  MOVE      DSTAT,PTUNDTYP          * Discharge status
.
.        In the event of the same person being changed twice in one day,
.        ignore the second change
.
ADMHCS16  MATCH     SP1,PTUNTYPE            * Don't write a blank alteration
          GOTO      ADMHCS99 IF EQUAL
.
          COMPARE   ONE,SKIPAUWR            * Skip audit write?
          GOTO      ADMHCS30 IF EQUAL       * Yes
.
          MOVE      PTUNTYPE,FTYPE
          BRANCH    FTYPE,ADMHCS20,ADMHCS20,ADMHCS20,ADMHCS20
          GOTO      ADMHCS99
.
ADMHCS20  PACK      KEY25,PTUNADMN,PTUNDATE,PTUNTIME,PTUNTYPE
          CALL      RDAUNAA1
          COMPARE   ZERO,OVRCD
          GOTO      ADMHCS99 IF EQUAL
.
          COMPARE   TWO,SSASTAT
          IF        @EQUAL
            COMPARE   ZERO,AELIG
            IF        @EQUAL
              COMPARE   ONE,PTCNHDPS
              IF        @EQUAL
                MOVE      ONE,PTUNSENT
              ENDIF
            ENDIF
          ENDIF
.
          CALL      WRUNAA1
.
ADMHCS30  PACK      TRANDATE,ADATE
          PACK      TRANTIME,ATIME
          MOVE      ASTAY,STAYDAYS
.
          IF        ASTAT=2
            PACK      KEY8,AADMNO,SP70
            CALL      RDPMWOR1
            IF        OVRCD=1
              CALL      CLPMWO00               * Use the expected discharge
            ENDIF                              * date if a current admission
.                                              * instead of TRANDATE plus
            MATCH     SP70,PMWOEDAT            * ASTAY
            IF        !@EQUAL
              DAYSEP    TRANDATE,PMWOEDAT,STAYDAYS
            ENDIF
          ENDIF
.
          CALL      UPPBMN00
.
ADMHCS99  MOVE      ZERO,SKIPAUWR           * reset it for future calls
          RETURN
+
.------------------------------------------------------------
. DISHCS00 - Write to HCS Discharge audit file
.         From IBAPAT05 - DISHCS.

.         Params:
.           SKIPAUWR - skip audit record write?
.------------------------------------------------------------
.
DISHCS00  COMPARE   ONE,CHCS
          GOTO      DISHCS10 IF NOT EQUAL
.
          MATCH     CHCSDTE,DDATE
          GOTO      DISHCS99 IF LESS
.
.         Write to the Unadmit/Undischarge/Adm & Dsch change audit file
.
DISHCS10  MOVE      DADMNO,PTUNADMN
          MOVE      ZERO,PTUNSENT
          CALL      IBACLOCK
          PACK      PTUNDATE,CCC,CYY,CMM,CDD
          REP       " 0",PTUNDATE
          MOVE      CTIMEIS,PTUNTIME
          REP       " 0",PTUNTIME
          MOVE      USERID,PTUNAUID
          PACK      PTUNCANC,SP70
.
          MATCH     "1",PTUNTYPE
          IF        @EQUAL
            PACK      PTUNCANC,TRNUREAS,SP70
          ENDIF
          MATCH     "2",PTUNTYPE
          IF        @EQUAL
            PACK      PTUNCANC,DDATREAS,SP70
          ENDIF
          MATCH     "3",PTUNTYPE
          IF        @EQUAL
            PACK      PTUNCANC,ADMNREAS,SP70
          ENDIF
          MATCH     "4",PTUNTYPE
          IF        @EQUAL
            PACK      PTUNCANC,DSCHREAS,SP70
          ENDIF
          MOVE      SP70,PTUNDTYP           * Discharge status
          MATCH     "2",PTUNTYPE
          GOTO      DISHCS14 IF EQUAL       * Undischarged
          MATCH     "4",PTUNTYPE
          GOTO      DISHCS16 IF NOT EQUAL   * Not changing disc.date
.
DISHCS14  MOVE      DSTAT,PTUNDTYP          * Discharge status
.
.        In the event of the same person being changed twice in one day,
.        ignore the second change
.
DISHCS16  MATCH     SP1,PTUNTYPE            * Don't write a blank alteration
          GOTO      DISHCS99 IF EQUAL
.
          COMPARE   ONE,SKIPAUWR            * Skip audit write?
          GOTO      DISHCS40 IF EQUAL       * Yes
.
          MOVE      PTUNTYPE,FTYPE
          BRANCH    FTYPE,DISHCS20,DISHCS20,DISHCS20,DISHCS20
          GOTO      DISHCS99
.
DISHCS20  PACK      KEY25,PTUNADMN,PTUNDATE,PTUNTIME,PTUNTYPE
          CALL      RDAUNAA1
          COMPARE   ZERO,OVRCD
          GOTO      DISHCS99 IF EQUAL
.
.    Get hospital number for EDI extract if using multi hospitals
.
          MOVE      SP4,PTUNHOSP
          IF        IBCNMHOS = 1
            PACK      KEY30,DADMNO,ZEDS
            CALL      RDSTRAN2              * Position after last pat record
            CALL      RDPTRAN2              * read pat previous record
            BRANCH    OVRCD,DISHCS30
.
            MATCH     DADMNO,TADMN
            GOTO      DISHCS30 IF NOT EQUAL

            PACK      KEY6,TWARD,SP10       * Multiple hospitals.
            CALL      RDWARD1               * Get hospital number from
            BRANCH    OVRCD,DISHCS30
.                                             ward file.
            MOVE      PTWDHOSN,PTUNHOSP
          ENDIF

DISHCS30  PACK      KEY25,PTUNADMN,PTUNDATE,PTUNTIME,PTUNTYPE
          CALL      RDAUNAA1
          COMPARE   ZERO,OVRCD
          GOTO      DISHCS99 IF EQUAL
.
          COMPARE   TWO,SSASTAT
          IF        @EQUAL
            COMPARE   ZERO,AELIG
            IF        @EQUAL
              COMPARE   ONE,PTCNHDPS
              IF        @EQUAL
                MOVE      ONE,PTUNSENT
              ENDIF
            ENDIF
          ENDIF
.
          CALL      WRUNAA1
.
DISHCS40  PACK      TRANDATE,ADATE
          PACK      TRANTIME,ATIME
          MOVE      ASTAY,STAYDAYS
.
          IF        ASTAT=2
            PACK      KEY8,AADMNO,SP70
            CALL      RDPMWOR1
            IF        OVRCD=1
              CALL      CLPMWO00               * Use the expected discharge
            ENDIF                              * date if a current admission
.                                              * instead of TRANDATE plus
            MATCH     SP70,PMWOEDAT            * ASTAY
            IF        !@EQUAL
              DAYSEP    TRANDATE,PMWOEDAT,STAYDAYS
            ENDIF
          ENDIF
.
          CALL      UPPBMN00
.
DISHCS99  PROC      WRWATR00
.
          MOVE      ZERO,SKIPAUWR           * reset it for future calls
          RETURN
+
.------------------------------------------------------------
.  Next Page
.------------------------------------------------------------
.
NXTPG000  IF        NEXTPAGE=0
            CALL      WINCLS00              * Refresh parent and close window
          ENDIF
.
          IF        NEXTPAGE=1
            CALL      DISPLY00
          ENDIF
.
          IF        NEXTPAGE=2
            COMPARE   ONE,MHTRAN       * create MH admission details
            CALL      CRMH0000 IF EQUAL
            CALL      RDIREC00
          ENDIF
.
          IF        NEXTPAGE=3
            CALL      GOBACK10
          ENDIF
.
          IF        NEXTPAGE=4
            CALL      GOBACK20
          ENDIF
.
          MOVE      ZERO,EXIT
          IF        NEXTPAGE=5
            MOVE      ONE,EXIT
          ENDIF
.
          IF        NEXTPAGE=6
            CALL      DIVRED00              * Redirect from Divisions
          ENDIF
.
          IF        NEXTPAGE=7
            CALL      PREDIR00
          ENDIF
.
          IF        NEXTPAGE=8
            CALL      CLSPOP00
          ENDIF
.
NXTPG999  RETURN
+
.*******************************************************************************
.  close the popup and direct to a new popup
.*******************************************************************************
CLSPOP00  CALL      OPENHTML
          BRANCH    EXIT,CLSPOP99
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             "src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             "src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#"> ":
                             " redirectTopPopUpFrame(#"",REDIRECT,"#"); ":
                             "</script>";
.
          CALL      CLOSHTML
CLSPOP99  RETURN
.------------------------------------------------------------------------------
.  Redirect Parent URL
.------------------------------------------------------------------------------
.
PREDIR00  CALL      OPENHTML
          BRANCH    EXIT,PREDIR90
.
          COMPARE   ONE,MHTRAN
          GOTO      PREDIR50 IF EQUAL
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             " parent.location.href=#"",REDIRECT,"#";":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      PREDIR99
.
PREDIR50  CALL      CRMH0000    * create MH admission details
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             " parent.location.href=#"",MHREDIRC,"#";":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      PREDIR99
.
PREDIR90  DISPLAY   "*** Fifo Not Found ***"
.
PREDIR99  RETURN
+
.------------------------------------------------------------
.  DIV Redirect URL
.------------------------------------------------------------
.
DIVRED00  CALL      OPENHTML
          BRANCH    EXIT,DIVRED99
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "opener.location.href=#"",REDIRECT,"#";":
                             "self.close();":
                             "}":
                             "</script>"
          CALL      CLOSHTML
DIVRED99  RETURN
+
.------------------------------------------------------------
.  Redisplay Page - Refresh Screen
.------------------------------------------------------------
.
DISPLY00  CALL      OPENHTML
          BRANCH    EXIT,DISPLY99
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "    opener.history.go(0);":
                             "}":
                             "</script>"
          CALL      CLOSHTML
DISPLY99  RETURN
+
.------------------------------------------------------------
.  Go Back 2 Pages
.------------------------------------------------------------
.
GOBACK20  CALL      OPENHTML
          BRANCH    OVRCD,GOBACK29
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             " if (self.name==#"PopUpFrame#") {":
    "  parent.document.getElementById('PopUpScreen').style.display=#"none#"; ":
                             "  parent.history.go(-2);}":
                             " else { ":
                             "  opener.history.go(-2);":
                             "  self.close(); }":
                             "}":
                             "</script>"
          CALL      CLOSHTML
GOBACK29  RETURN
+
.------------------------------------------------------------
. CKST0000   : Check Admission status
. Parameters : ASTAT
. Returns    : EXIT    = 0     - Valid admission status for discharge
.                      = 1     - Illegal admission status for discharge
.              ONLEAVE = 0     - Patient not on leave
.                      = 1     - Patient on leave
. From IBAPAT34.
.------------------------------------------------------------
.
CKST0000  MOVE      ONE,EXIT                 * default as Invalid status
          MOVE      ZERO,ONLEAVE             * patient not on leave
.
          IF        ASTAT=4
            MOVE      ONE,ONLEAVE            * set On Leave flag.
          ENDIF
.
          BRANCH    PTCNDSHL,CKST1000        * Allow discharges while on leave?
.
.-------  Do Not Allow discharges while on leave
.
          LOAD      EXIT,ASTAT,ONE:          * Pre-Admission
                               ZERO:         * Current Admission
                               ONE:          * Discharged
                               ONE:          * On Leave
                               ONE           * Cancelled
          GOTO      CKST9999
.
.-------  Allow discharges while on leave
.
CKST1000  LOAD      EXIT,ASTAT,ONE:          * Pre-Admission
                               ZERO:         * Current Admission
                               ONE:          * Discharged
                               ZERO:         * On Leave
                               ONE           * Cancelled
.
CKST9999  RETURN
+
.------------------------------------------------------------
. MOVO0000 - Move Medical Record Option
.------------------------------------------------------------
.
MOVO0000  BRANCH    MVMEDREC,MOVO9999
.
          PACK      MOVEDAT,DDATE
          MOVE      DTIME,MOVETIM
          CALL      MREC0000
.
MOVO9999  RETURN
+
.------------------------------------------------------------
.         Theatre booking set to DISCHARGE
.------------------------------------------------------------
.
THET0000  MOVE      SP70,SAVEBSC1
          MOVE      ZERO,WAITFLAG
          PACK      SAVKEY19,SP70
          PACK      SAVKEY31,SP70
          MOVE      AADMNO,KEY8             * Booking System
          CALL      RDBKREC1
          BRANCH    OVRCD,THET6000
.
          PACK      KEY5,ANSB,ANSK,BKRETYPE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,THET0500
.
          MATCH     "MED",THCSCOD
          IF        @EQUAL
            CALL      BOOK0000
            GOTO      THET6000
          ENDIF
.
THET0500  COMPARE   TWO,BKRESTAT            * Cancelled booking?
          GOTO      THET1000 IF EQUAL
.
          LOAD      BKRESTAT,ASTAT,ONE,THREE,FOUR,THREE
          CALL      UPBKREC1
.
THET1000  PACK      KEY31,AADMNO,SP70
          CALL      RSOPDEA2
THET2000  CALL      RKOPDEA2
          BRANCH    OVRCD,THET6000
.
          COMPARE   THREE,OPDASTAT            * cancelled?
          GOTO      THET2000 IF EQUAL
.
          MATCH     DAADMNO,OPDAADMN
          GOTO      THET6000 IF NOT EQUAL
.
          PACK    SAVKEY31,OPDAADMN,OPDASTAT,OPDADATE,OPDATIME,OPDACLIN,OPDACASE
          LOAD      OPDASTAT,ASTAT,ONE,TWO,FOUR,TWO
.
          PACK  KEY31,OPDAADMN,OPDASTAT,OPDADATE,OPDATIME,OPDACLIN,OPDACASE,SP70
          CALL      RAOPDEA2
          IF        OVRCD=1
            PACK      KEY31,SAVKEY31,SP70
            CALL      RDOPDEA2
            IF        OVRCD=0
              CALL      IBACLOCK
              PACK      OPDAUDAT,CCC,CYY,CMM,CDD
              REP       " 0",OPDAUDAT
.
              CLOCK     TIME,OPDAUTIM
              MOVE      WBSEUID,OPDAWEBU
.
              LOAD      OPDASTAT,ASTAT,ONE,TWO,FOUR,TWO
.
              TRAP      OVERCOND IF IO
              CALL      UPOPDEA2
              TRAPCLR   IO
            ENDIF
          ENDIF
.
          MATCH     SP70,OPDAPROC
          GOTO      THET3000 IF NOT EQUAL
.
          PACK      KEY31,SAVKEY31,SP70
          CALL      RSOPDEA2
          GOTO      THET2000
.
.         Waiting Lists WMSTAT SET TO 4 AS DISCHARGED
.
THET3000  COMPARE   ONE,HBWAIT
          GOTO      THET4000 IF NOT EQUAL
.
          PACK      KEY19,OPDAURNO,OPDAPROC,OPDACONT
          CALL      RDTREA1
          BRANCH    OVRCD,THET4000
.
          OPEN      WATTX1A1,"wattx1af"
          PACK      KEY19,WMURNO,WMCODE,WMCNT,SP70
          CALL      RDWTTX11
          IF        OVRCD=1
            CALL      CLWATTX1
          ENDIF
          CLOSE     WATTX1A1
.
          MATCH     WMBOOK,AADMNO
          GOTO      THET4000 IF NOT EQUAL     * CAR 268087
.
          MOVE      ONE,WAITFLAG
          CALL      SAVHIS00
.
          IF        WMSTAT <= 6
            LOAD      WMSTAT,ASTAT,THREE,FOUR,FIVE,FOUR
            CALL      UPTREA1
            IF        WMSTAT=5
              MOVE      "20",WTWMBSCD
              CALL      UPTREA1
.
              MATCH     "Discharge",FORMACTN
              IF        @EQUAL
                MATCH     SP70,SAVEBSC1
                IF        @EQUAL
                  MOVE      "1",SAVEBSC1
                  MOVE      SP70,SAVEBSCD
                ENDIF
              ENDIF
.
              MOVE      ONE,NBRFLAG
              CALL      WRTHIS00
            ENDIF
            IF        WMSTAT = 3 | WMSTAT = 4 | WMSTAT = 5
              PACK      KEY19,WMURNO,WMCODE,WMCNT,SP70
              MATCH     KEY19,SAVKEY19
              IF        !@EQUAL
                CALL      PMIGTNID            * get national id for dgate write
                MOVE      NMPNUMB,PTNINMPI
                MOVE      THIRTY6,HL7TRGID
                MOVE      SP8,HL7INCLD
                PROC      DGCLIUWL            * HL7 - Update Waiting List Entry
                PACK      SAVKEY19,WMURNO,WMCODE,WMCNT,SP70
              ENDIF
            ENDIF
          ENDIF
.
THET4000  PACK      KEY31,SAVKEY31,SP70
          CALL      RSOPDEA2
          GOTO      THET2000
.
.         Check for if auto update admission type required for daycase
.
THET6000  MATCH     ADATE,DDATE
          GOTO      THET9999 IF NOT EQUAL
.
          PACK      KEY31,ADMISSNO,FOUR,ADATE,SP70
          CALL      RSOPDEA2
          CALL      RKOPDEA2
          BRANCH    OVRCD,THET8000
          MATCH     ADMISSNO,OPDAADMN
          GOTO      THET8000 IF NOT EQUAL     * Different admission
          MATCH     ADATE,OPDADATE
          GOTO      THET8000 IF NOT EQUAL     * different session
.
          MOVE      "1",TEAMNUMB
          PACK      KEY10,OPDAUNIQ,SP70
          CALL      RDOPARD1                 * arrival/recovery details
          PACK      KEY11,OPDAUNIQ,TEAMNUMB,SP70   * reading surgical table
          CALL      RDOPSRG1
.
          PROC      AUTOATYP
          GOTO      THET9999
.
.         Update for Daycase Medical booking
.
THET8000  MOVE      ADMISSNO,OPDAADMN
          MOVE      ADATE,OPDADATE
          MOVE      ATIME,OPSGTISS
          MOVE       "X",TEAMNUMB
          PROC      AUTOATYP
.
THET9999  RETURN
+
.*************************************************************************
.*                               PATD0000                                *
.*              Update the patdayaf files if neccessary                  *
.*************************************************************************
.
PATD0000  COMPARE   ZERO,PTCNDAYF           * skip if not using patdayaf
          GOTO      PATD9999 IF EQUAL           file for statistics
.
          MATCH     SP8,PTCNNDAT            * Don't update patdayaf files if
          GOTO      PATD9999 IF EQUAL         the update has not been run
.                                             before
          MATCH     "00000000",PTCNNDAT
          GOTO      PATD9999 IF EQUAL
.
          MOVE      PTMIS001,WDATE
          BRANCH    OPTION,PATD1000,PATD1000,PATD2000,PATD2000,PATD5000:
                           PATD6000,PATD9999,PATD9999,PATD9999,PATD9999:
                           PATD9999
.
          GOTO      PATD9999
.
.------ Update the patdayaf files for an undischarged patient ------
.
PATD1000  MOVE      DDATE,STRTDATE
          REP       " 0",STRTDATE
.
          MATCH     ZERO8,STRTDATE
          GOTO      PATD9999 IF EQUAL
.
          UNPACK    PTCNNDAT,CCENT,CYEAR,CMON,CDAY
.
          CALL      SUBD0000            * subtract a day from PTCNNDAT
.
          PACK      ENDDATE,CC,YY,MM,DD
          REP       " 0",ENDDATE
          MOVE      AADMNO,ADMISNO
.
          CALL      PATDAYAD            * add records to the patdayaf files
.
          GOTO      PATD9999
.
.------ Update the patdayaf files for an unadmitted patient ------
.
PATD2000  MOVE      ADATE,STRTDATE
          REP       " 0",STRTDATE
.
          UNPACK    PTCNNDAT,CCENT,CYEAR,CMON,CDAY
.
          CALL      SUBD0000            * subtract a day from PTCNNDAT
.
          PACK      ENDDATE,CC,YY,MM,DD
          REP       " 0",ENDDATE
          MOVE      AADMNO,ADMISNO
.
          CALL      PATDAYDL            * delete records from patdayaf files
.
          GOTO      PATD9999
.
.------ Update the patdayaf files for a change in admission date ------
.
PATD5000  MATCH     WDATE,ADATE         * match new date to admission date
          GOTO      PATD5500 IF LESS
.
          MOVE      WDATE,STRTDATE
          REP       " 0",STRTDATE
.
          MOVE      ADATE,ENDDATE
          REP       " 0",ENDDATE
          MOVE      AADMNO,ADMISNO
.
          CALL      PATDAYAD            * add records to the patdayaf files
.
          GOTO      PATD9999
.
.------ admission date is less than the new date ------
.
PATD5500  MOVE      ADATE,STRTDATE
          REP       " 0",STRTDATE
.
          MOVE      WDATE,ENDDATE
          REP       " 0",ENDDATE
.
          UNPACK    ENDDATE,CCENT,CYEAR,CMON,CDAY
.
          CALL      SUBD0000            * subtract a day from the end date
.
          PACK      ENDDATE,CC,YY,MM,DD
          REP       " 0",ENDDATE
          MOVE      AADMNO,ADMISNO
.
          CALL      PATDAYDL            * delete records from patdayaf files
.
          GOTO      PATD9999
.
.------ Update the patdayaf files for a change in discharge date ------
.
PATD6000  MATCH     WDATE,DDATE         * match new date to discharge date
          GOTO      PATD6500 IF LESS
.
          MOVE      WDATE,STRTDATE
          REP       " 0",STRTDATE
.
          MOVE      DDATE,ENDDATE
          REP       " 0",ENDDATE
.
          UNPACK    STRTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CCENT,CC
          MOVE      CYEAR,YY
          MOVE      CMON,MM
          MOVE      CDAY,DD
.
          CALL      DMYCON              * convert to julian date
.
          ADD       ONE,JULDAY          * add one to the start date
          MOVE      JULDAY,JWKDAY
          MOVE      JULYR,JWKYER
          MOVE      JULCC,JWKCC
.
          CALL      JULCON
.
          PACK      STRTDATE,CC,YY,MM,DD
          REP       " 0",STRTDATE
          MOVE      AADMNO,ADMISNO
.
          CALL      PATDAYDL            * delete records from patdayaf files
.
          GOTO      PATD9999
.
.------ discharge date is less than the new date ------
.
PATD6500  MOVE      DDATE,STRTDATE
          REP       " 0",STRTDATE
.
          MOVE      WDATE,ENDDATE
          REP       " 0",ENDDATE
          MOVE      AADMNO,ADMISNO
.
          CALL      PATDAYAD            * add records to the patdayaf files
.
PATD9999  RETURN
+
.------------------------------------------------------------
. Routine to subtract one from a given date  - From IBAPAT34
. Requires : CCENT, CYEAR, CMON, CDAY
. Returns  : CC,YY, MM, DD
.------------------------------------------------------------
.
SUBD0000  MOVE      CYEAR,YY
          MOVE      CCENT,CC
          MOVE      CMON,MM
          MOVE      CDAY,DD
          CALL      DMYCON           * convert to julian date
.
          SUB       ONE,JULDAY
          MOVE      JULDAY,JWKDAY
          MOVE      JULYR,JWKYER
          MOVE      JULCC,JWKCC
          CALL      JULCON              * convert back to DD,MM,CC,YY format
.
SUBD9999  RETURN
+
.------------------------------------------------------------
PATICOKY  RETURN
.------------------------------------------------------------
. UPDS0000 - Update Doctor and Specialty
. Returns:    EXIT  0 = Ok to continue
.                   1 = Error
.------------------------------------------------------------
.
UPDS0000  MOVE      ADMISSNO,KEY8
          CALL      RLPTMIS1                * Lock admission record
          BRANCH    OVRCD,UPDS9150:         * record not found
                          UPDS9100          * record already locked
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDDSCH1                 * discharge record
          IF        OVRCD=1
            CALL      CLRDIS00
          ENDIF
.
          MOVE      AURNO,KEY8
          CALL      RLPTMAS1                * Lock master record
          BRANCH    OVRCD,UPDS9250:         * record not found
                          UPDS9200          * record already locked
.
          CALL      GASF0000                * Get the admission SFA code
.
          CALL      VALDT000                * Validate Date
          BRANCH    EXIT,UPDS9900
.
          CALL      VALTM000                * Validate Time
          BRANCH    EXIT,UPDS9900
.
          COMPARE   ZERO,CHGCARE            * Care Type Changed?
          GOTO      UPDS0100 IF EQUAL       * no - goto update doc/specialty
.
          MOVE      ACARE,SAVCARE
          MOVE      AADMNO,KEY8
          CALL      RDMISS1
          MOVE      TRNACARE,ACARE
          CALL      UPMISS1
          CALL      UUPTMIS1
.
          MATCH     ACARE,SAVCARE
          IF        !@EQUAL
            PACK      HDPEQUIV,ZERO,FIVE,SP2
            CALL      WPEI0000
            CALL      CHCC0000
            CALL      CHGNZ000           * acare changed - update nmds
          ENDIF
.
          CALL      CHKF0000                * Update PMI folder details
.
UPDS0100  IF        (CHGDOC = 0 & CHGTYP = 0 & CHGFEE=0)
            BRANCH    CHGCARE,UPDS9000      * Care Type Updated Only
            GOTO      UPDS9300              * Do not need to update doc or spec
          ENDIF
.
          CALL      ATDT0000                * Determine Admission Type & Doctor
          CALL      CHINV000                * Check Invoiced
          BRANCH    EXIT,UPDS9900
          CALL      WRTTRN00                * Write Tran Record
          CALL      INVPND00                * Check for Invoice Pending Record
          CALL      CHKCNT00                * Check Control file
          CALL      UPVST000                * Update Visit Record
          BRANCH    EXIT,UPDS9900
.
          IF        CFEETYP <> 0
            GOTO      UPDS9900
          ENDIF
          CALL      VALTRN00                * Validate Tran Records
          GOTO      UPDS9900
.
UPDS9000  MOVE      "Care Type Updated Successfully",WEBTITLE
          MOVE      AURNO,KEY8
          CALL      UUPTMAS1
          MOVE      AADMNO,KEY8
          CALL      UUPTMIS1
          MOVE      ZERO,EXIT
          GOTO      UPDS9999
.
UPDS9100  CLEAR     WEBTITLE
          APPEND    "Patient Admission ",WEBTITLE
          APPEND    AADMNO,WEBTITLE
          APPEND    "Busy on Terminal ",WEBTITLE
          APPEND    APORT,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDS9999
.
UPDS9150  MOVE      "Admission record not found",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDS9999
.
UPDS9200  CLEAR     WEBTITLE
          APPEND    "Patient U/R No. ",WEBTITLE
          APPEND    AURNO,WEBTITLE
          APPEND    "Busy on Terminal ",WEBTITLE
          APPEND    APORT,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      AADMNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      UPDS9999
.
UPDS9250  MOVE      "Patient Master record not found",WEBTITLE
          CALL      WEBERR00
          MOVE      AADMNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      UPDS9999
.
UPDS9300  MOVE      "Update Not Required - Details Not Changed!",WEBTITLE
          CALL      WEBERR00
UPDS9900  MOVE      AURNO,KEY8
          CALL      UUPTMAS1
          MOVE      AADMNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
.
UPDS9999  RETURN
+
.------------------------------------------------------------
. GASF0000 - From IBAHOS03
. Get admission SFA file stuff
.------------------------------------------------------------
.
GASF0000  PACK      KEY25,AADMNO,ANSA,SP30
          CALL      RDPTASF1                * Read an admin SFA file record
          BRANCH    OVRCD,GASF1000
.
          MATCH     AADMNO,PTAFADMN
          GOTO      GASF1000 IF NOT EQUAL   * Different admin no
.
          MATCH     ANSA,PTAFTYPE
          GOTO      GASF8000 IF EQUAL       * An admin SFA type
.
GASF1000  MOVE      ZEROVISN,PTAFADMN
          UNPACK    SP30,PTAFTYPE,PTAFDATE,PTAFTIME,PTAFCODE,PTAFCTYP
          UNPACK    SP30,PTAFCROL,PTAFCSID,PTAFSPAR
.
GASF8000  MOVE      ZERO,ASFFLG             * Admin SFA flag - no
.
GASF9000  MOVE      ZERO,EXIT
.
GASF9999  RETURN
+
.------------------------------------------------------------
.  Check the LOS with the cutoff day
.------------------------------------------------------------
.
OUTL0000  MOVE      ZERO,LOWFLAG          * default to high outliers
          MOVE      ADATE,FROMDATE
          MOVE      DDATE,TODATE
          CALL      NHOSPDAY              * get the length of stay
          ADD       ONE,NBRDAYS
.
          CALL      VLUM0000              * read overnight lumpsum file
          BRANCH    NOFEE,OUTL9999        * to get the cutoff day
.
          IF        NBRDAYS <= PTHLCOFF
            MOVE      ONE,LOWFLAG         * set flag to low outliers
          ENDIF
.
OUTL9999  RETURN
+
.------------------------------------------------------------
. VALDT000 - Validate Date
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
.
VALDT000  REP       " 0",TRANDATE
.
.         Date must be after the admission date
.
          UNPACK    ADATE,XCENT,XYEAR,XMON,XDAY
          PACK      XDATE,XCENT,XYEAR,XMON,XDAY
          REP       " 0",XDATE
.
          MATCH     XDATE,TRANDATE
          GOTO      VALDT910 IF LESS
.
.         Date must be before discharge date (or current date if current)
.
          PACK      XDATE,CURRDATE
.
          COMPARE   THREE,ASTAT
          GOTO      VALDT010 IF NOT EQUAL
.
          UNPACK    DDATE,XCENT,XYEAR,XMON,XDAY
          PACK      XDATE,XCENT,XYEAR,XMON,XDAY
.
VALDT010  MATCH     TRANDATE,XDATE
          GOTO      VALDT900 IF NOT LESS
.
          UNPACK    XDATE,XCENT,XYEAR,XMON,XDAY
          GOTO      VALDT920
.
VALDT900  MOVE      ZERO,EXIT
          GOTO      VALDT999
.
VALDT910  CLEAR     WEBTITLE
          PACK      PACKDATE,XDAY,SLASH,XMON,SLASH,XCENT,XYEAR
          APPEND    "Date must be >= ",WEBTITLE
          APPEND    PACKDATE,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VALDT999
.
VALDT920  CLEAR     WEBTITLE
          PACK      PACKDATE,XDAY,SLASH,XMON,SLASH,XCENT,XYEAR
          APPEND    "Date must be <= ",WEBTITLE
          APPEND    PACKDATE,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VALDT999
.
VALDT999  RETURN
+
.------------------------------------------------------------
. VALTM000 - Validate Time
. Returns:     EXIT  0 = Ok to continue
.                    1 = Error
.------------------------------------------------------------
.
VALTM000  PACK       KEY30,AADMNO,TRANDATE,TRANTIME,SP30
          CALL       RDSTRAN2
          CALL       RDKTRAN2
          BRANCH     OVRCD,VALTM020
.
          MATCH      TADMN,AADMNO
          GOTO       VALTM020 IF NOT EQUAL
.
          MATCH      TRANDATE,TDATE
          GOTO       VALTM010 IF NOT EQUAL
.
          MATCH      TRANTIME,TTIME
          GOTO       VALTM010 IF NOT EQUAL
.
          GOTO       VALTM920
.
.         Check to make sure we are not selecting a period of on-leave
.
VALTM010  MATCH      "R",TMOVE
          GOTO       VALTM940 IF EQUAL
.
VALTM020  UNPACK     ADATE,XCENT,XYEAR,XMON,XDAY
          PACK       XDATE,XCENT,XYEAR,XMON,XDAY
.
          MATCH      XDATE,TRANDATE
          GOTO       VALTM030 IF NOT EQUAL
.
          MATCH      ATIME,TRANTIME
          GOTO       VALTM930 IF LESS
.
VALTM030  PACK       XDATE,CURRDATE
          CLOCK      TIME,TIMEIS
          REP        " 0",TIMEIS
.
          MATCH      SP8,DDATE
          GOTO       VALTM040 IF EQUAL
.
          UNPACK     DDATE,XCENT,XYEAR,XMON,XDAY
          PACK       XDATE,XCENT,XYEAR,XMON,XDAY
.
          MOVE       DTIME,TIMEIS
.
VALTM040  MATCH      XDATE,TRANDATE
          GOTO       VALTM900 IF NOT EQUAL
.
          MATCH      TRANTIME,TIMEIS
          GOTO       VALTM910 IF LESS
.
VALTM900  MOVE       ZERO,EXIT
          GOTO       VALTM999
.
VALTM910  CLEAR      WEBTITLE
          APPEND     "Time Must Be < ",WEBTITLE
          APPEND     TIMEIS,WEBTITLE
          RESET      WEBTITLE
          CALL       WEBERR00
          MOVE       ONE,EXIT
          GOTO       VALTM999
.
VALTM920  MOVE       "Previous Movement at this Time. ",WEBTITLE
          CALL       WEBERR00
          MOVE       ONE,EXIT
          GOTO       VALTM999
.
VALTM930  CLEAR      WEBTITLE
          APPEND     "Time Must Be > ",WEBTITLE
          APPEND     ATIME,WEBTITLE
          RESET      WEBTITLE
          CALL       WEBERR00
          MOVE       ONE,EXIT
          GOTO       VALTM999
.
VALTM940  MOVE       "Patient On-leave at this Time. ",WEBTITLE
          CALL       WEBERR00
          MOVE       ONE,EXIT
          GOTO       VALTM999
.
VALTM999  RETURN
+
.------------------------------------------------------------
. Determine Admission Type & Doctor
.------------------------------------------------------------
.
ATDT0000  PACK          KEY30,AADMNO,SP30
          CALL          RDSTRAN2
ATDT010   CALL          RDKTRAN2
          BRANCH        OVRCD,ATDT030
.
          MATCH         TADMN,AADMNO
          GOTO          ATDT030 IF NOT EQUAL
.
          CMATCH        ANSA,TMOVE
          GOTO          ATDT020 IF EQUAL
.
          MATCH         TDATE,TRANDATE
          GOTO          ATDT030 IF LESS
          GOTO          ATDT020 IF NOT EQUAL
.
          MATCH         TTIME,TRANTIME
          GOTO          ATDT030 IF LESS
.
.         Save this info as it is < change date/time
.
ATDT020   MOVE          TATYPE,STATYPE
          MOVE          PTTRCLTY,STACLM
          MOVE          TADOCT,STADOCT
          MOVE          PTTRTEAM,STATEAM
          MOVE          TDEPT,STDEPT
.
          MOVE          TCHSTAT,STCHSTAT
          GOTO          ATDT010
.
ATDT030   MOVE          STATYPE,SAVATYP
          MOVE          STACLM,SAVACLM
          MOVE          STATYPE,TATYPE
          MOVE          STACLM,PTTRCLTY
          MOVE          STADOCT,TADOCT
          MOVE          STATEAM,PTTRTEAM
          MOVE          STDEPT,TDEPT
.
          IF            CHGTYP=1
            MOVE          SPECIALT,NEWATYP
            MOVE          SPECIALT,NATYPE
          ENDIF
.
          IF            CHGUNT=1
            MOVE          CHNGUNIT,NEWUNIT
            MOVE          CHNGUNIT,NAUNIT
          ENDIF
.
          IF            CHGTEM=1
            MOVE          CHNGTEAM,NEWTEAM
            MOVE          CHNGTEAM,NATEAM
          ENDIF
.
          IF            CHGRST=1
            MOVE          CHNGRSTR,NEWRSTR
            MOVE          CHNGRSTR,NARSTR
          ENDIF
.
          IF            CHGRES=1
            MOVE          CHNGRESI,NEWRESI
            MOVE          CHNGRESI,NARESI
          ENDIF
.
          IF            CHGDOC=1
            MOVE          TRNADOCT,NEWDOCT
            MOVE          TADOCT,NADOCT
          ENDIF
.
          IF            CHGFIN=1
            MOVE          FINANELC,NEWACLM
            MOVE          FINANELC,NTRCLTY
          ENDIF
.
ATDT9999  RETURN
+
.------------------------------------------------------------
. CHINV000 - Check if invoiced has been printed,by checking the invoice number
. Results:    EXIT 0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
.
CHINV000  COMPARE   ZERO,AINVPRT
          GOTO      CHINV020 IF EQUAL
.
          COMPARE   THREE,ASTAT
          GOTO      CHINV010 IF NOT EQUAL
.
.     Check if the patient has already been invoiced upto the discharged date
.
          MATCH     DDATE,ALACDTE
          GOTO      CHINV010 IF NOT EQUAL
.
.       Only allow to change Att.doctor (but not admission type) if patient
.       is discharged and invoice printed
.
          COMPARE   ONE,CHGTYP
          GOTO      CHINV910 IF EQUAL      * Admission type is changed
          GOTO      CHINV020
.
.       Make sure the keyin date is equal or after the invoice date
.
CHINV010  MATCH     ALACDTE,TRANDATE
          GOTO      CHINV020 IF NOT LESS
.
          COMPARE   ONE,CHGTYP
          GOTO      CHINV930 IF EQUAL   * Admission type is not changed
.
.       Admission type is not changed.  Check the rates type
.
CHINV020  CALL      WLNBR000
.
          COMPARE   ZERO,CFEETYP
          GOTO      CHINV900 IF EQUAL   * Using patbfeef,same as priv hosp
.
          MOVE      TRANDATE,BDATE
          CALL      CHKTRN00            * Check each TRANS records
          BRANCH    EXIT,CHINV980
.
.       Public Hospital - we need to read Rates table file
.
          PACK      KEY12,ACLAIM,NEWATYP,ACLSS,STCHSTAT
          CALL      RDRATE1
          BRANCH    OVRCD,CHINV920
.
CHINV900  MOVE      ZERO,EXIT
          GOTO      CHINV999
.
CHINV910  CLEAR     WEBTITLE
          APPEND    "Patient Discharged and ",WEBTITLE
          APPEND    "Invoice Printed for this Date.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHINV999
.
CHINV920  MOVE      "Rate Not Set Up Yet!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHINV999
.
CHINV930  MOVE      "Invoice Printed for This Date.",WEBTITLE
          CALL      WEBERR00
CHINV980  MOVE      ONE,EXIT
          GOTO      CHINV999
.
CHINV999  RETURN
+
.------------------------------------------------------------
. CHKTRN00 - Routine to go through TRANS file, to make sure the new rate exists
.       for each TRANS records - Modified from IBAHOS03
. Returns:      EXIT  0 = Ok to continue
.                     1 = Error
.------------------------------------------------------------
.
CHKTRN00  PACK      KEY30,AADMNO,BDATE,TRANTIME,SP30
          CALL      RDSTRAN2
CHKTRN10  CALL      RDKTRAN2
          COMPARE   ONE,OVRCD
          GOTO      CHKTRN90 IF EQUAL
.
          MATCH     TADMN,AADMNO
          GOTO      CHKTRN90 IF NOT EQUAL
.
.       Option two - admission type changed
.
          PACK      KEY12,ACLAIM,ATYPE,ACLSS,TCHSTAT
          CALL      RDRATE1
          BRANCH    OVRCD,CHKTRN91
          GOTO      CHKTRN10
.
CHKTRN90  MOVE      ZERO,EXIT
          GOTO      CHKTRN99
.
CHKTRN91  CLEAR     WEBTITLE
          APPEND    " ** Rate ( ",WEBTITLE
          APPEND    KEY12,WEBTITLE
          APPEND    " ) Not Setup yet !! ** ",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
CHKTRN99  RETURN
+
.------------------------------------------------------------
. WRTTRN00 - Write Tran Record
. Returns:  EXIT   0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
.
WRTTRN00  PACK      KEY30,AADMNO,TRANDATE,TRANTIME,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,WRTTRN91
.
          MATCH     TADMN,AADMNO
          GOTO      WRTTRN91 IF NOT EQUAL
.
          MOVE      TRBTYP,SAVBTYP
          MOVE      TRANDATE,TDATE
          MOVE      TRANTIME,TTIME
          MOVE      "C",TMOVE
.
          IF        CHGDOC=1
            MOVE      NEWDOCT,TADOCT
            MOVE      NEWDOCT,ADOCTA
          ENDIF
.
          IF        CHGUNT=1
            MOVE      NEWUNIT,TDEPT
            MOVE      NEWUNIT,ACLSSFT
          ENDIF
.
          IF        CHGTEM=1
            MOVE      NEWTEAM,PTTRTEAM
            MOVE      NEWTEAM,PMVXTEAM
          ENDIF
.
          IF        CHGRST=1
            MOVE      NEWRSTR,PTTRRSTR
            MOVE      NEWRSTR,PMVXEDC3
          ENDIF
.
          IF        CHGRES=1
            MOVE      NEWRESI,PTTRRESI
            MOVE      NEWRESI,PMVXEDC2
          ENDIF
.
          IF        CHGTYP=1
            MOVE      NEWATYP,TATYPE
            MOVE      NEWATYP,ATYPE
          ENDIF
.
          IF        CHGFIN=1
            MOVE      NEWACLM,PTTRCLTY
            MOVE      NEWACLM,ACLAIM
          ENDIF
.
          MOVE      ZERO,PTTREPSD
.
          COMPARE   ZERO,CFEETYP
          GOTO      WRTTRN20 IF EQUAL         * Using patbfeef,same as priv hosp
.
.       Public Hospital uses the following fields
.
          MOVE      RCPDAY,TRATEF
          MOVE      RCEDAY,TEXTRA
.
WRTTRN20  PACK      KEY30,TADMN,TDATE,TTIME,TWARD,TBED,SP70
          MOVE      PASSCODE,PTTROPER       * operator Id
          PACK      PTTRSPAR,SP20,SP20,SP20
          MOVE      SP3,PTTRLTYP            * clear type of leave value
          PACK      PTTRCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTTRCDAT
          CLOCK     TIME,PTTRCTIM
          MOVE      WBSEUID,PTTRUCID
          UNPACK    SP70,TRCDATE,TRCTIME,PTTRUUID
.
          PACK      KEY30,TADMN,TDATE,TTIME,TWARD,TBED,SP70
          CALL      RDATRAN2
          IF        OVRCD=1
            CALL      WRTRAN2
          ELSE
            DISPLAY   "I*D transfer key WRTTRN20 ",KEY30
          ENDIF
.
          COMPARE   ONE,CHGTYP
          IF        @EQUAL
            CALL      WASF0000              * Write admin SFA file stuff
            CALL      UBFE0000              * Update bed fees
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      WRTTRN99
.
WRTTRN91  CLEAR     WEBTITLE
          APPEND    "Missing Records From Transfer File for This",WEBTITLE
          APPEND    " Admission Number. ",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
WRTTRN99  RETURN
+
.------------------------------------------------------------
. WASF0000 - Write admission SFA file stuff - From PATPRG31
.------------------------------------------------------------
.
WASF0000  COMPARE   FOUR,PTCNHDPS           * I SRF 22829
          GOTO      WASF0050 IF EQUAL       * Queensland
.
          COMPARE   THREE,PTCNHDPS
          GOTO      WASF0010 IF EQUAL       * Victoria
.
          COMPARE   SIX,PTCNHDPS
          IF        @EQUAL
            MATCH     "1",PTCNWAUC          * WA
            GOTO      WASF9000 IF NOT EQUAL
          ENDIF
.
WASF0010  PACK      KEY5,CODEA,ATYPE
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      "0",ANS
            MOVE      ZERO,FORM1
            UNPACK    THCSCOD,ANS
            UNPACK    THCSCOD,DIM2
            IF        PTCNHDPS=3
              REP       "C1S2H3R5E6P7B8",ANS
            ENDIF
            IF        PTCNHDPS=6
              MATCH     "10",DIM2
              IF @EQUAL
                MOVE      "1",ANS
              ELSE           
                REP       "5191",ANS
              ENDIF
            ENDIF
            MOVE      ANS,PTAFCODE                            * Funding arrmnt
            MOVE      ANS,FORM1
            BRANCH    FORM1,WASF0075,WASF0075,WASF0075:
                            WASF1000,WASF0075,WASF0075:
                            WASF0075,WASF0075
.           GOTO      WASF1000            * remove the reord
.
            MATCH     "1",PTCNWAUC
            IF        @EQUAL
              IF        FORM1=ZERO
                GOTO      WASF0075
              ELSE
                GOTO      WASF1000
              ENDIF
            ELSE
              GOTO      WASF1000
            ENDIF
.
          ENDIF
          GOTO      WASF0075
.
WASF0050  MATCH     "S ",PTCNQCCT           * Using Cat S for contract details?
          GOTO      WASF0060 IF EQUAL       * yes
.
          PACK      KEY5,ANSC,ANSL,ACLAIM      * I SRF 22829
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      "0",ANS
            MOVE      ZERO,FORM1
            UNPACK    TCINDC9,ANS
            REP       "P1",ANS
            MOVE      ANS,FORM1
            BRANCH    FORM1,WASF0100      * valid contract
            GOTO      WASF1000            * remove the reord
          ENDIF                           * end I SRF 22829
.
          GOTO      WASF0100                * I CAR 42820
.
WASF0060  PACK      KEY5,ANSS,SP1,ASRCE
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      "0",ANS
            MOVE      ZERO,FORM1
            UNPACK    TCINDC8,ANS
            REP       "P1",ANS
            MOVE      ANS,FORM1
            BRANCH    FORM1,WASF0100      * valid contract
            GOTO      WASF1000            * remove the reord
          ENDIF                           * end I SRF 22829
.
          GOTO      WASF0100                * I CAR 42820
.
WASF0075  MATCH     "5",PTAFCODE
          GOTO      WASF0080 IF EQUAL
.
          MATCH     "6",PTAFCODE
          GOTO      WASF0080 IF EQUAL
.
          MATCH     "7",PTAFCODE
          GOTO      WASF0080 IF EQUAL
.
          MATCH     "8",PTAFCODE
          GOTO      WASF0080 IF EQUAL
.
          GOTO      WASF0100
.
WASF0080  PACK      PTAFCTYP,SP70
          PACK      PTAFCROL,SP70
          PACK      PTAFCSID,SP70
          GOTO      WASF0200                * end I CAR 42820
.
WASF0100  MATCH     SP1,PTAFCTYP
          GOTO      WASF0200 IF NOT EQUAL   * Blank contract type, delete record
.
          MATCH     SP1,PTAFCROL
          GOTO      WASF0200 IF NOT EQUAL   * Blank contract type, delete record
.
          COMPARE   FOUR,PTCNHDPS           * I SRF 22829
          GOTO      WASF0200 IF EQUAL       * Queensland
.
          MATCH     SP5,PTAFCSID
          GOTO      WASF1000 IF EQUAL
.
WASF0200  MOVE      AADMNO,PTAFADMN
          MOVE      "A",PTAFTYPE
          MOVE      SP8,PTAFDATE
          MOVE      SP8,PTAFTIME
          MOVE      SP70,PTAFSPAR
          PACK      KEY25,PTAFADMN,PTAFTYPE,PTAFDATE,PTAFTIME
          CALL      RAPTASF1                * Read an admin SFA file record
          IF        OVRCD=1
            CALL      WRPTASF1              * Write an admin SFA file record
          ELSE
            CALL      UPPTASF1              * Update an admin SFA file record
          ENDIF
          GOTO      WASF9000
.
WASF1000  PACK      KEY25,AADMNO,ANSA,SP70
          CALL      RDPTASF1                * Read an admin SFA file record
          IF        OVRCD=0
            PACK      KEY25,AADMNO,ANSA,PTAFDATE,PTAFTIME
            CALL      DEPTASF1              * Delete an admin SFA file record
          ENDIF
.
WASF9000  MOVE      ZERO,EXIT
.
WASF9999  RETURN
+
.------------------------------------------------------------
.  Check for Invoice Pending Record
.------------------------------------------------------------
INVPND00  COMPARE   ZERO,PTCNIPEN
          GOTO      INVPND99 IF NOT EQUAL
.
          IF        CHOSTYP=1 & CFEETYP=0
            MOVE      FIVE,PTIPRSTA               * Update Bed fees
            MOVE      TRANDATE,PENDSDAT           * as at date
            CALL      CINVP000                    * Check for tobe invoiced
            GOTO      INVPND99
          ENDIF
.
          COMPARE   ZERO,AINVPRT
          GOTO      INVPND10 IF EQUAL
.
          COMPARE   THREE,ASTAT
          GOTO      INVPND10 IF NOT EQUAL
.
.     Check if the patient has already been invoiced upto the discharged date
.
          MATCH     DDATE,ALACDTE
          GOTO      INVPND99 IF EQUAL
.
INVPND10  MOVE      AADMNO,IPADMNO
          MOVE      THREE,IPSYSTM
          MOVE      SP70,IPSITE
          MOVE      SP70,PENDHOSP
          IF        IBCNMHOS=1
            MOVE      IPADMNO,KEY8
            CALL      RDPMVX11
            IF        OVRCD=0
              MOVE      PMVXMHOS,PENDHOSP         * Hospital ID
            ENDIF
          ENDIF
          MOVE      " 3",PENDSYST                 * Inpatient
.
          MOVE      TRANDATE,PENDSDAT             * as at date
          MOVE      ADATE,PENDADAT                * admission date
          MOVE      SP70,PENDDDAT
          IF        ASTAT=3
            CALL      RDDSCH1
            IF        OVRCD=0
              MOVE      DDATE,PENDDDAT            * discharged date
            ENDIF
          ENDIF
          MOVE      AFUNDH,PENDFUND
          MOVE      ACLAIM,PENDCLAM
          CALL      IPRH0000
.
          MOVE      FIVE,PTIPRSTA           * Update Bed fees
          MOVE      SP70,PTIPSVAR
.
          PACK      KEY8,IPADMNO,SP70
          CALL      RAIPEN1
          IF        OVRCD=1
            CALL      WRIPEN1
          ELSE
            CALL      UPIPEN1
          ENDIF
.
INVPND99  RETURN
+
.------------------------------------------------------------
.  Update the control file with the transfer date if neccessary
.------------------------------------------------------------
.
CHKCNT00  READ      CONTROLF,EIGHTY8;*148,CFRDTE
          MATCH     CFRDTE,TDATE
          GOTO      CHKCNT10 IF NOT LESS
          MOVE      TDATE,CFRDTE
          WRITAB    CONTROLF,EIGHTY8;*148,CFRDTE
.
CHKCNT10  READ      CONTROLF,EIGHTY8;*154,CMMHDT
          MATCH     CMMHDT,TDATE
          GOTO      CHKCNT99 IF NOT LESS
          MOVE      TDATE,CMMHDT
          WRITAB    CONTROLF,EIGHTY8;*154,CMMHDT
.
CHKCNT99  RETURN
+
.------------------------------------------------------------
. UPVST000 - Update Visit Record
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
.
UPVST000  COMPARE   ZERO,CHGDOC         * Check if attending doctor was changed
          GOTO      UPVST030 IF EQUAL
.
          CALL      UPLMISS1
          CALL      CHGNZ000
.
.       Update the visit file with the new attending doctor
.
          MOVE      AADMNO,PVIBILL
          MOVE      AURNO,PVIURNO
          MOVE      ADATE,PVIDATE
          REP       " 0",PVIDATE
.
          MOVE      PVIBILL,KEY8
UPVST010  CALL      RLPTVIS1                     * visit record on file ?
          BRANCH    OVRCD,UPVST060:              * no
                          UPVST910               * yes - already locked
.
          MOVE      NEWDOCT,PVIDOCT
.
          COMPARE   ZERO,CHGTYP
          GOTO      UPVST020 IF EQUAL
.
.       Change the visit status if necessary
.
          CALL      CHKVIS00
.
UPVST020  CALL      UPVISA1
          CALL      UUPTVIS1
          GOTO      UPVST065
.
.       Update the visit status if necessary
.
UPVST030  COMPARE   ZERO,CHGTYP
          GOTO      UPVST900 IF EQUAL
.
          MOVE      AADMNO,PVIBILL
          MOVE      AURNO,PVIURNO
          MOVE      ADATE,PVIDATE
          REP       " 0",PVIDATE
          MOVE      PVIBILL,KEY8
          CALL      RLPTVIS1                     * visit record found ?
          BRANCH    OVRCD,UPVST050:              * no
                          UPVST910               * yes - already locked
.
.       Check if visit status needs to be changed
.
          CALL      CHKVIS00
          CALL      UPVISA1
          CALL      UUPTVIS1
.
          GOTO      UPVST120
.
.       Create  new record in visit file
.
UPVST050  MOVE      THREE,PVITYPE
          MOVE      ADOCTA,PVIDOCT
          MOVE      FORM1,PVISTAT      * Visit status
          MOVE      ONE,PVITRAN
          MOVE      SP2,PVILOCK
          MOVE      SP20,PVISPAR
          CALL      WRVISA1
..        CALL      ADDVIS00
          GOTO      UPVST120
.
.       Create  a new record in VISIT FILE
.
UPVST060  MOVE      THREE,PVITYPE
          MOVE      ADOCTA,PVIDOCT
          MOVE      ONE,PVISTAT
          MOVE      ONE,PVITRAN
          MOVE      SP2,PVILOCK
          MOVE      SP20,PVISPAR
          CALL      WRVISA1
..        CALL      ADDVIS00
.
.       Update the tran file with the new attending doctor
.
UPVST065  PACK      KEY30,AADMNO,TRANDATE,TRANTIME,SP30
          CALL      RDSTRAN2
UPVST070  CALL      RDKTRAN2
          BRANCH    OVRCD,UPVST110
.
          MATCH     AADMNO,TADMN
          GOTO      UPVST110 IF NOT EQUAL
.
          COMPARE   NINE,CFEETYP
          GOTO      UPVST080 IF EQUAL
.
          COMPARE   ZERO,CFEETYP
          GOTO      UPVST100 IF NOT EQUAL    * not using bed fees
.
.       If admission type is not changed, no need to recalculate the rate
.
UPVST080  COMPARE   ZERO,CHGTYP
          GOTO      UPVST100 IF EQUAL
.
.       Get the number of days in hospital
.
          MOVE      ZERO,TOTDAY
          MOVE      ADATE,FROMDATE
          MOVE      TDATE,TODATE
          MATCH     FROMDATE,TODATE
          GOTO      UPVST090 IF EQUAL
.
          PACK      DIM30,TADMN,TDATE,TTIME,TWARD,TBED
          CALL      NHOSPDAY
          MOVE      NBRDAYS,TOTDAY
          ADD       ONE,TOTDAY
.
          MOVE      DIM30,KEY30        * Reposition
          CALL      RDTRAN2
.
.       Get the new TRBEND after stepdown
.
UPVST090  ADD       ADYHOSP,TOTDAY
          MOVE      TRBTYP,SAVBTYP
.
          MATCH     ANSY,PTMICMXP           * check for casemix payment indic.
          GOTO      UPVST092 IF NOT EQUAL
          MATCH     SP10,PTMIPCMX
          GOTO      UPVST092 IF EQUAL
.
          PACK      CMDRG,PTMIPCMX,SP20
          MOVE      TATYPE,SAVATYP
          MOVE      PTTRCLTY,SAVACLM
          MOVE      TOTDAY,BDAYS
          MOVE      ZERO,ADMFLAG           * Not admission progam
          MOVE      ZERO,MSGFLAG           * display error message
          PROC      PATGNCMX
          BRANCH    NOFEE,UPVST920
          MOVE      DAYPAT,TRATEF
          MOVE      ADDPAT,PTTRADPT
          MOVE      DAYHF,TRATEH
          MOVE      ADDHF,PTTRADRB
          MOVE      ADDEND,PTTRAEND
          MOVE      DAYEND,TRBEND
          GOTO      UPVST100
.
UPVST092  CALL      GETBF000
          BRANCH    DEFLAG,UPVST920
          MOVE      SBFENDDY,TRBEND
          MOVE      SBFPAT,TRATEF         * New bed fee
          MOVE      SBFHF,TRATEH
.
UPVST100  MOVE      ADOCTA,TADOCT
          PACK      TRCDATE,CCC,CYY,CMM,CDD
          REP       " 0",TRCDATE
          CLOCK     TIME,TRCTIME
          MOVE      WBSEUID,PTTRUUID
.
          CALL      UPTRAN2
          CALL      CHKCNT00                * Check Control file
          GOTO      UPVST070
.
.       Check if admission type was changed
.
UPVST110  COMPARE   ZERO,CHGTYP
          GOTO      UPVST900 IF EQUAL
.
UPVST120  COMPARE   ZERO,CFEETYP
          GOTO      UPVST130 IF EQUAL     * Using patbfeef, same as priv hosp
.
.       Public Hospital - Process Admission MHMS Adjustments
.       Save the new admission type, and restore the old admission type
.       as PRADJ000 uses the varible to update the MHMS Adjustments file
.
          MOVE      NATYPE,ATYPE      * original admission type
          MOVE      NTRCLTY,ACLAIM
.
          MOVE      NEWATYP,ATYPE
.
.       Update the tran file with the new Admission type
.
UPVST130  PACK      KEY30,AADMNO,TRANDATE,TRANTIME,SP30
          CALL      RDSTRAN2
UPVST140  CALL      RDKTRAN2
          BRANCH    OVRCD,UPVST170
.
          MATCH     AADMNO,TADMN
          GOTO      UPVST170 IF NOT EQUAL
.
          MOVE      ATYPE,TATYPE
.
          MATCH     ANSY,PTMICMXP           * check for casemix payment indic.
          GOTO      UPVST150 IF NOT EQUAL
          MATCH     SP10,PTMIPCMX
          GOTO      UPVST150 IF EQUAL
.
          MOVE      ZERO,PTTREPSD      * episode type
          MATCH     ANSA,TMOVE
          IF        @EQUAL
            MOVE      TRBTYP,SAVBTYP
            PROC      PATGNCMX            * get lumpsum amount
            BRANCH    NOFEE,UPVST920
            MOVE      LUMPAT,PTTRLSPT
            MOVE      LUMHF,PTTRLSRB
          ENDIF
          GOTO      UPVST160                * update trans record
.
UPVST150  COMPARE   ZERO,CFEETYP
          GOTO      UPVST160 IF EQUAL      * Using patbfeef, same as priv hosp
.
.       Public Hospital - update the rate using the new admission type
.
          PACK      KEY12,ACLAIM,ATYPE,ACLSS,TCHSTAT
          CALL      RDRATE1
          BRANCH    OVRCD,UPVST930
.
          MOVE      TRATEF,ROPAT       * old rate
          ADD       TEXTRA,ROPAT
.
          MOVE      RCPDAY,TRATEF
          MOVE      RCEDAY,TEXTRA
          CALL      RCAAUD00
.
UPVST160  PACK      TRCDATE,CCC,CYY,CMM,CDD
          REP       " 0",TRCDATE
          CLOCK     TIME,TRCTIME
          MOVE      WBSEUID,PTTRUUID
.
          CALL      UPTRAN2
          CALL      CHKCNT00                * Check Control file
          GOTO      UPVST140
.
UPVST170  MATCH     ADATE,TRANDATE
          IF        @EQUAL
            CALL      CHSTA000
            BRANCH    EXIT,UPVST980
          ENDIF
.
          COMPARE   ZERO,CHGDOC
          CALL      UPLMISS1 IF EQUAL
.
UPVST900  MOVE      "Doctor/Specialty Successfully Updated",WEBTITLE
          MOVE      ZERO,EXIT
          GOTO      UPVST999
.
.      Visit file locked
.
UPVST910  CLEAR     WEBTITLE
          APPEND    "Visit ",WEBTITLE
          APPEND    PVIBILL,WEBTITLE
          APPEND    " locked on Port ",WEBTITLE
          APPEND    PVILOCK,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPVST999
.
UPVST920  CLEAR     WEBTITLE
          APPEND    "Record has partially been updated, ",WEBTITLE
          APPEND    "Please contact Supervisor",WEBTITLE
          RESET     WEBTITLE
          ADD       ONE,WARCOUNT
          MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
          MOVE      TWO,EXIT
          GOTO      UPVST140
.
UPVST930  MOVE      "Rate Not Setup Yet",WEBTITLE
          ADD       ONE,WARCOUNT
          MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
          MOVE      TWO,EXIT
          GOTO      UPVST140
.
UPVST980  MOVE      ONE,EXIT
          GOTO      UPVST999
.
UPVST999  RETURN
+
.------------------------------------------------------------
.       Pat.class. indicator(ADMFLG ) 1 = public patient; 2 = private patient
.------------------------------------------------------------
.
CHKVIS00  MOVE      ONE,OVRCD
.
          MOVE      TWO,FORM1     * public
          MATCH     "1",ADMFLG
          GOTO      CHKVIS10 IF EQUAL
.
          MOVE      ONE,FORM1     * private
.
.       Check the visit status is equal to the new patient classification
.       Visit status (PVISTAT) 1 = private patient; 2 = public patient
.
CHKVIS10
          COMPARE   FORM1,PVISTAT
          RETURN    IF EQUAL
.
.       Change the visit status to be the same as the new classification
.
          MOVE      FORM1,PVISTAT
          MOVE      ZERO,OVRCD   * Visit status is changed
.
CHKVIS99  RETURN
+
.------------------------------------------------------------
. CHSTA000 - Subroutine to update the Admission statistics file (CHGSTAD)
. Returns:   EXIT   0 = Ok to continue
.                   1 = Error
.------------------------------------------------------------
.
CHSTA000  MOVE      ADATE,CPTDATE
          REP       " 0",ADATE
.
          CALL      GPERD              * Get the year and period for this date
          BRANCH    EXIT,CHSTA910      * Date not in period file
.
          MOVE      DRGYR,SADYEAR
          MOVE      DRGNUM,FORM2
.
          PACK      KEY8,SADYEAR,ANSA,NATYPE
          MATCH     SP3,NATYPE
          IF        @EQUAL
            PACK      KEY8,SADYEAR,ANSA,CODEUNK
          ENDIF
.
          CALL      RDSTAD1
          BRANCH    OVRCD,CHSTA010
.
          MOVE      NEGONE,COUNT
.
          LOAD      NADM,FORM2,SADMTH1,SADMTH2,SADMTH3,SADMTH4:
                               SADMTH5,SADMTH6,SADMTH7,SADMTH8:
                               SADMTH9,SADMTH10,SADMTH11,SADMTH12:
                               SADMTH13
          ADD       COUNT,NADM
          STORE     NADM,FORM2,SADMTH1,SADMTH2,SADMTH3,SADMTH4:
                               SADMTH5,SADMTH6,SADMTH7,SADMTH8:
                               SADMTH9,SADMTH10,SADMTH11,SADMTH12:
                               SADMTH13
          CALL      UPSTAD1
.
.        Add new Admission data to statistics file
.
CHSTA010  MOVE      ADATE,CPTDATE
          REP       " 0",ADATE
.
          CALL      GPERD              * Get the year and period for this date
          BRANCH    EXIT,CHSTA910      * Date not in period file
.
          MOVE      DRGYR,SADYEAR
          MOVE      DRGNUM,FORM2
.
          PACK      KEY8,SADYEAR,ANSA,ATYPE
          MATCH     SP3,ATYPE
          IF        @EQUAL
            PACK      KEY8,SADYEAR,ANSA,CODEUNK
          ENDIF
.
          CALL      RDSTAD1
          BRANCH    OVRCD,CHSTA020
.
          MOVE      ONE,COUNT
          CALL      ADDSTAD
          GOTO      CHSTA900
.
CHSTA020  MOVE      ANSA,SADTYPE
          MOVE      ATYPE,SADCODE
          MATCH     SP3,ATYPE
          GOTO      CHSTA030 IF NOT EQUAL
.
          MOVE      CODEUNK,SADCODE
.
CHSTA030  MOVE      ZERO,SADMTH1
          MOVE      ZERO,SADMTH2
          MOVE      ZERO,SADMTH3
          MOVE      ZERO,SADMTH4
          MOVE      ZERO,SADMTH5
          MOVE      ZERO,SADMTH6
          MOVE      ZERO,SADMTH7
          MOVE      ZERO,SADMTH8
          MOVE      ZERO,SADMTH9
          MOVE      ZERO,SADMTH10
          MOVE      ZERO,SADMTH11
          MOVE      ZERO,SADMTH12
          MOVE      ZERO,SADMTH13
          MOVE      ONE,NADM
          STORE     NADM,FORM2,SADMTH1,SADMTH2,SADMTH3,SADMTH4:
                               SADMTH5,SADMTH6,SADMTH7,SADMTH8:
                               SADMTH9,SADMTH10,SADMTH11,SADMTH12:
                               SADMTH13
          CALL      WRSTAD1
.
CHSTA900  MOVE      ZERO,EXIT
          GOTO      CHSTA999
.
CHSTA910  MOVE      "Date not found in Period file",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHSTA999
.
CHSTA999  RETURN
+
.------------------------------------------------------------
.         Write  to change rate file
.------------------------------------------------------------
.
RCAAUD00  BRANCH    CAUDQ,RCAAUD99            * added for V5.01.15 - SRF 105195
.
RCAAUD10  CALL      RDSRCA
.
          COMPARE   ZERO,RSTATUS
          GOTO      RCAAUD20 IF EQUAL
.
          DISPLAY   "Rate Change Audit in use please wait ",*W5
          GOTO      RCAAUD10
.
RCAAUD20  CALL      WRIRCA
          MOVE      AADMNO,RADMNO
          MOVE      PGNAME,ANS
          PACK      RNAME,ANS,DOT,PSNAME
          MOVE      ACLAIM,RCLAIM
          MOVE      SP6,RFUND
          MOVE      SP4,RHFTAB
          MOVE      SP3,RBTYPE
.
          MOVE      RCPDAY,RNPAT
          ADD       RCEDAY,RNPAT
          MOVE      ZERO,RNFUND
          MOVE      ZERO,RCGPAT
          MOVE      ZERO,RCGHF
.
          MOVE      TDATE,RDATE
          MOVE      TATYPE,RATYPE
          MOVE      ZERO,REDAYS
          MOVE      ACLSS,RCLSS
          MOVE      TCHSTAT,RCHST
          MOVE      PASSCODE,ROPER       * Operator code
          CALL      WRRCA
.
RCAAUD99  RETURN
+
.------------------------------------------------------------
. Routine to get the bed fee rate
. (Modified from GETBF routine in IBAHOS03)
.------------------------------------------------------------
.
GETBF000  MOVE      ZERO,DEFLAG
          COMPARE   NINE,CFEETYP
          GOTO      GETBF02 IF EQUAL        * Johns Hopkins uses bed fees
.
          IF        CFEETYP<>0
            GOTO      GETBF999
          ENDIF
.
.       Get Bed Fee for the above codes
.
          PACK      KEY9,ACLAIM,AFUNDH,SP70
          CALL      GETCNEFF               * Get Contract Effective From
          BRANCH    EXIT,GETBF900
.
          MOVE      TDATE,CEFFDATE         * Set for 'As at' Contact Effective
          LOAD      CEFFDATE,CNTRCEFR,ADATE,DDATE
          CALL      CDSC0000                * Check for 'Disc.Eff.Date From'
.
GETBF02   PACK      KEY27,ACLAIM,AFUNDH,AFNDTB,ATYPE,SAVBTYP
          CALL      GETBFEES
GETBF900  MOVE      EXIT,DEFLAG
.
GETBF999  RETURN
+
.------------------------------------------------------------
. VALTRN00 - Get each record of the trans file and validate it
. Returns:    EXIT   0 = Ok to continue
.                    1 = Error
.------------------------------------------------------------
.
VALTRN00  MOVE      ATYPE,LATYPE
          MOVE      TRANDATE,FROMDATE
          PACK      KEY30,AADMNO,TRANDATE,TRANTIME,SP30
          CALL      RDSTRAN2
VALTRN10  CALL      RDKTRAN2
          BRANCH    OVRCD,VALTRN90
.
          MATCH     TADMN,AADMNO
          GOTO      VALTRN90 IF NOT EQUAL
.
          CMATCH    "D",TMOVE
          GOTO      VALTRN50 IF EQUAL
.
.         Get the new bed fee rate
.
          MOVE      ZERO,PATFEE
          MOVE      ZERO,HFFEE
          MOVE      SP1,COLFEE
.
          MOVE      TWARD,LWARD
          MOVE      TBED,LBED
          MOVE      TRBTYP,LRBTYP
          MOVE      TRBTYP,SAVBTYP
          MOVE      TATYPE,SAVATYP
          MOVE      PTTRCLTY,SAVACLM
.
.        Save the key of trans file
.
          PACK      DIM30,TADMN,TDATE,TTIME,TWARD,TBED
.
.       Get the number no of days in hospital up to this trans date,
.       to work out the bed fees
.
          MOVE      ZERO,TOTDAY
          MATCH     TRANDATE,DDATE
          GOTO      VALTRN20 IF EQUAL
.
          MOVE      TDATE,TODATE
          CALL      SPBD0000                * Check for specialty bed type
          IF        EXIT=1
            MOVE      TCINDC6,SAVIND6       * Get no of days in the specialty
            PROC      PATSBTYP
          ELSE
            CALL      NHOSPDAY
          ENDIF
.
          MOVE      NBRDAYS,TOTDAY
          ADD       ONE,TOTDAY
.
          MATCH     ADATE,FROMDATE
          GOTO      VALTRN30 IF NOT EQUAL
.
VALTRN20  MATCH     ANSY,PTMICMXP           * check for casemix payment indic.
          IF        !@EQUAL
            ADD       ADYHOSP,TOTDAY
          ENDIF
.
.     Reposition to the prior trans record,As the NHOSPDAY uses trans file
.
VALTRN30  MOVE      DIM30,KEY30
          CALL      RDTRAN2
          MOVE      TDISC,SDISC
          MOVE      TALLW,SALLW
.
.       Casemix funding - do not reset on day count
.
          MATCH     ANSY,PTMICMXP           * check for casemix payment indic.
          GOTO      VALTRN34 IF NOT EQUAL
          MATCH     SP10,PTMIPCMX
          GOTO      VALTRN34 IF EQUAL
.
          PACK      CMDRG,PTMIPCMX,SP70
          MOVE      TATYPE,SAVATYP
          MOVE      PTTRCLTY,SAVACLM
          MOVE      TOTDAY,BDAYS
          MOVE      ZERO,ADMFLAG           * Not admission progam
          MOVE      ZERO,MSGFLAG           * display error message
          PROC      PATGNCMX
          BRANCH    NOFEE,VALTRN91
          CALL      SAVR0000               * Save original rates
.
.        Save the computer generated rate for the change rate audit file
.
          MOVE      ONE,COMFLAG
          MOVE      DAYPAT,RCGPAT          * Daily rate
          ADD       ADDPAT,RCGPAT          * Additional rate
          MOVE      DAYHF,RCGHF
          ADD       ADDHF,RCGHF
.
.         get the earliest ending day
.
          IF        DAYEND < ADDEND
            MOVE      DAYEND,REDAYS
          ELSE
            MOVE      ADDEND,REDAYS
          ENDIF
          SUB       TOTDAY,REDAYS
          ADD       ONE,REDAYS      * no of days effective
.
          CALL      REST0000           * Restore variables
          MOVE      ADDEND,SAVAEND
          MOVE      DAYEND,SAVEND
          MOVE      DAYPAT,PATFEE
          ADD       ADDPAT,PATFEE
          MOVE      DAYHF,HFFEE
          ADD       ADDHF,HFFEE
.
          GOTO      VALTRN50
.
.       Check if we have a change in admission type
.
VALTRN34  MATCH     TATYPE,LATYPE
          GOTO      VALTRN40 IF EQUAL
.
          MOVE      TATYPE,LATYPE
          BRANCH    PTCNCNDY,VALTRN40           * don't reset day count
          MOVE      TDATE,FROMDATE
.
VALTRN40  MOVE      TATYPE,ATYPE
          CALL      GETBF000
          BRANCH    DEFLAG,VALTRN91
.
.        Save the computer generated rate for the change rate audit file
.
          MOVE      ONE,COMFLAG
          MOVE      SBFPAT,RCGPAT
          MOVE      SBFHF,RCGHF
          MOVE      SBFENDDY,REDAYS
          SUB       TOTDAY,REDAYS
          ADD       ONE,REDAYS
.
          MOVE      SBFENDDY,SAVEND
          MOVE      ZERO,SAVAEND
          MOVE      SBFPAT,PATFEE
          MOVE      SBFHF,HFFEE
.
.         Updating the new fees
.
VALTRN50  MATCH     ANSY,PTMICMXP           * check for casemix payment indic.
          GOTO      VALTRN54 IF NOT EQUAL
          MATCH     SP10,PTMIPCMX
          GOTO      VALTRN54 IF EQUAL
.
          MOVE      LUMPAT,PTTRLSPT
          MOVE      LUMHF,PTTRLSRB
          MOVE      DAYPAT,TRATEF
          MOVE      ADDPAT,PTTRADPT
          MOVE      DAYHF,TRATEH
          MOVE      ADDHF,PTTRADRB
          MOVE      SAVAEND,PTTRAEND
          MOVE      ZERO,PTTREPSD
          GOTO      VALTRN56
.
VALTRN54  MOVE      PATFEE,TRATEF
          MOVE      ZERO,PTTRADPT
          MOVE      HFFEE,TRATEH
          MOVE      ZERO,PTTRADRB
          MOVE      ZERO,PTTRAEND
          MOVE      ZERO,PTTREPSD
.
.        Fix up Discount/allowance
.
VALTRN56  MOVE      SDISC,NDISC
          MOVE      SALLW,NLWAMT
          MOVE      SP2,AALLOW
          MOVE      LRBTYP,SAVBTYP
.
          MOVE      NDISC,TDISC
          MOVE      NLWAMT,TALLW
          MOVE      SAVBTYP,TRBTYP
          MOVE      SAVEND,TRBEND
          MOVE      SAVEND,REDAYS
          SUB       TOTDAY,REDAYS
          ADD       ONE,REDAYS
          MOVE      ZERO,TEXTRA
.
          PERFORM   PTCNADDC,XTRA0000     * get the extra charge
.
          PACK      TRCDATE,CCC,CYY,CMM,CDD
          REP       " 0",TRCDATE
          CLOCK     TIME,TRCTIME
          MOVE      WBSEUID,PTTRUUID
.
          CALL      UPTRAN2
          PACK      DIM30,TADMN,TDATE,TTIME,TWARD,TBED
.
.       Update the control file with the transfer date if neccessary
.
          CALL      CHKCNT00
.
.        Write  to Rate Change Audit file if system parameter is switched on (0)
.
          BRANCH    CAUDQ,VALTRN80           * added for V5.01.15 - SRF 105195
.
VALTRN60  CALL      RDSRCA
.
          COMPARE   ZERO,RSTATUS
          GOTO      VALTRN70 IF EQUAL
.
          DISPLAY    "Rate Change Audit in use, Waiting........",*W5;
          GOTO      VALTRN60
.
VALTRN70  CALL      WRIRCA
          MOVE      AADMNO,RADMNO
          MOVE      PGNAME,ANS
          PACK      RNAME,ANS,DOT,PSNAME
          MOVE      ACLAIM,RCLAIM
          MOVE      AFUNDH,RFUND
          MOVE      AFNDTB,RHFTAB
          MOVE      SAVBTYP,RBTYPE
.
          MOVE      ZERO,RNPAT        * New rate = rate - disc - allow
          MOVE      PATFEE,RNPAT
          SUB       NDISC,RNPAT
          SUB       NLWAMT,RNPAT
          MOVE      HFFEE,RNFUND     * from  PATDSBFE
          MOVE      TDATE,RDATE
          MOVE      TATYPE,RATYPE
          MOVE      ZERO,ROPAT
          MOVE      SP3,RCLSS
          MOVE      SP3,RCHST
          MOVE      PASSCODE,ROPER       * Operator code
.
          CALL      WRRCA
.
.       Reposition to the previous trans record
.
VALTRN80  MOVE      DIM30,KEY30
          CALL      RDTRAN2
          GOTO      VALTRN10
.
VALTRN90  MOVE      "Doctor/Specialty Successfully Updated",WEBTITLE
          MOVE      ZERO,EXIT
          GOTO      VALTRN99
.
VALTRN91  CLEAR     WEBTITLE
          APPEND    "Default Bed Fee Not Set Up. ",WEBTITLE
          APPEND    "Record partially updated. ",WEBTITLE
          APPEND    "Please contact Supervisor",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VALTRN99
.
VALTRN99  RETURN
+
.------------------------------------------------------------
. SAVR0000 - Save original rates
.------------------------------------------------------------
.
SAVR0000  MOVE      DAYPAT,SDAYPAT
          MOVE      DAYHF,SDAYHF
          MOVE      ADDPAT,SADDPAT
          MOVE      ADDHF,SADDHF
          MOVE      DAYEND,SDAYEND
          MOVE      ADDEND,SADDEND
          MOVE      DAYCOL,DEFDCOL       * Default daily charge column
          MOVE      ADDCOL,DEFACOL       * Default additional charge column
.
SAVR9999  RETURN
+
.------------------------------------------------------------
. REST0000 - Restore original rates
.------------------------------------------------------------
.
REST0000  MOVE      SDAYPAT,DAYPAT
          MOVE      SDAYHF,DAYHF
          MOVE      SADDPAT,ADDPAT
          MOVE      SADDHF,ADDHF
          MOVE      SDAYEND,DAYEND
          MOVE      SADDEND,ADDEND
          MOVE      DEFDCOL,DAYCOL
          MOVE      DEFACOL,ADDCOL
.
REST9999  RETURN
+
.------------------------------------------------------------
. XTRA0000  - From IBAHOS03
.------------------------------------------------------------
.
XTRA0000  PACK      KEY6,ACLAIM,TATYPE
          CALL      RDPTNH1                 * read the NHH additional charging
          BRANCH    OVRCD,XTRA9999            file
.
          PACK      KEY16,AADMNO,TDATE
          CALL      RDPTAH1                 * read additional charging history
          IF        OVRCD = 1
            CALL      RPPTAH1               * get previous additional charging
            BRANCH    OVRCD,XTRA9999          history record
.
            MATCH     AADMNO,PTAHADMN       * compare admission numbers
            GOTO      XTRA9999 IF NOT EQUAL
          ELSE
            CALL      DEPTAH1               * delete the current record from
.                                             the additional charging history
          ENDIF
.
          MOVE      ZERO,TEXTRA
          ASSIGN    TRATEF + TRATEH - TDISC - TALLW,MINICH
          ASSIGN    (PTAHANNI * PTNHPERC)/36500.00,DAILYCH
          IF        DAILYCH > PTNHMAXD
            MOVE      PTNHMAXD,DAILYCH
            ASSIGN    DAILYCH - MINICH,TEXTRA
          ELSE
            IF        DAILYCH < MINICH
              MOVE      MINICH,DAILYCH
              MOVE      ZERO,TEXTRA
            ELSE
              ASSIGN    DAILYCH - MINICH,TEXTRA
            ENDIF
          ENDIF
.
.------ write to the additional charging history file ------
.
XTRA1000  MOVE      TDATE,PTAHDATE
          REP       " 0",PTAHDATE
          PACK      KEY16,AADMNO,PTAHDATE
          MOVE      DAILYCH,PTAHTOTL
          PACK      PTAHSPAR,SP20,SP20,SP10
.
          CALL      WRPTAH1                 * write to additional charging
.                                             history file
.------ delete subsequent records from the additional charging history ------
.------ file ------
.
XTRA2000  CALL      RSPTAH1
          CALL      RKPTAH1
          BRANCH    OVRCD,XTRA9999
.
          MATCH     PTAHADMN,AADMNO         * compare admission numbers
          GOTO      XTRA9999 IF NOT EQUAL
          PACK      KEY16,PTAHADMN,PTAHDATE
          CALL      DEPTAH1                 * delete from the additional
.                                             charging history file
          GOTO      XTRA2000
.
XTRA9999  RETURN
+
.------------------------------------------------------------
. EPTST000 - Check Episode Coding
. Check for Coded Episodes if effected by a "Care Type" change
.------------------------------------------------------------
.
EPTST000  MOVE      ZERO,EXIT
          COMPARE   ONE,MRCNEPSC
          GOTO      EPTST999 IF NOT EQUAL   * not using Episode Coding

          MOVE      ZERO,ISCODING
.                                           * check if there are later records
          PACK      KEY24,ADMISSNO,TRANDATE,TRANTIME,SP70
          CALL      RDCHCO1
EPTST200  CALL      RDKCHCO1
          BRANCH    OVRCD,EPTST999
.
          MATCH     ADMISSNO,DCHADMN
          GOTO      EPTST999 IF NOT EQUAL
.
.                                           * check later Episodes for Coding
          MOVE      CHEPISNO,F2
          MOVE      F2,KEY2
.
          PACK      KEY13,CHADMN,KEY2,SP10  * check Diagnosis coding
          CALL      RSPTECD1
          CALL      RKPTECD1
          BRANCH    OVRCD,EPTST500
.
          MATCH     CHADMN,PTEDADMN
          GOTO      EPTST500 IF NOT EQUAL
.
          MOVE      ONE,ISCODING
          GOTO      EPTST900
.                                           * now check Procedures coding
EPTST500  PACK      KEY13,CHADMN,KEY2,SP10
          CALL      RSPTECO1
          CALL      RKPTECO1
          BRANCH    OVRCD,EPTST999
.
          MATCH     CHADMN,PTEOADMN
          GOTO      EPTST999 IF NOT EQUAL
.
          MOVE      ONE,ISCODING
          GOTO      EPTST900
.
.                                           * "Coding exists" error message
EPTST900  CLEAR     WEBTITLE
          UNPACK    TRANDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY12,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP1
.
          APPEND    "Coding exists for Episodes after ",WEBTITLE
          APPEND    KEY12,WEBTITLE
          APPEND    " - these must be removed",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
EPTST999  RETURN
.
.------------------------------------------------------------
. CHCC0000 - Change Category "CC"
. Update the care class changes file - save the old care class
.------------------------------------------------------------
.
.                                           * Delete all later Episode records
CHCC0000  PACK      KEY24,AADMNO,TRANDATE,TRANTIME,SP70
          CALL      RDCHCO1
CHCC1200  CALL      RDKCHCO1
          BRANCH    OVRCD,CHCC2000
.
          MATCH     AADMNO,CHADMN
          GOTO      CHCC2000 IF NOT EQUAL
.                                           * Remove changes after keyin date
          PACK      KEY24,CHADMN,CHDATE,CHTIME,SP70
          CALL      DECHCO1
          GOTO      CHCC0000
.
.                                           * establish next Episode No.
CHCC2000  MOVE      ZERO,F2
          PACK      KEY24,AADMNO,Z70
          CALL      RDSCHCO1
          CALL      RDPCHCO1
.
          MATCH     AADMNO,CHADMN
          IF        !@EQUAL
            MOVE      ONE,F2
          ELSE
            MOVE      CHEPISNO,F2
            PACK      KEY16,TRANDATE,TRANTIME,SP10
            PACK      KEY16A,CHDATE,CHTIME,SP10
            MATCH     KEY16,KEY16A          * is this record itself?
            IF        !@EQUAL
              ADD       ONE,F2
            ENDIF
          ENDIF
.
.                                           * create/update Episode record
CHCC4000  PACK      KEY24,AADMNO,TRANDATE,TRANTIME,SP70
          CALL      RDCHCO1
          IF        OVRCD <> 1
            MOVE      CODECC,CHCATG
            MOVE      SAVCARE,CHCODE
            MOVE      WBSEPCD,CHUPUSID
            PACK      CHUPDATE,CURRDATE
            MOVE      CTIMEIS,CHUPTIME
            MOVE      F2,CHEPISNO
            MOVE      SP10,CHCODCMP
            CALL      UPCHCO1
          ELSE
            MOVE      CODECC,CHCATG
            MOVE      SAVCARE,CHCODE
            MOVE      AADMNO,CHADMN
            MOVE      TRANDATE,CHDATE
            MOVE      TRANTIME,CHTIME
            MOVE      WBSEPCD,CHCRUSID
            PACK      CHCRDATE,CURRDATE
            MOVE      CTIMEIS,CHCRTIME
            MOVE      SP70,CHUPDATE
            MOVE      SP70,CHUPTIME
            MOVE      SP70,CHUPUSID
            MOVE      F2,CHEPISNO
            UNPACK    SP70,CHCODCMP,CHSPARE
            CALL      WRCHCO1
          ENDIF
          GOTO      CHCC9999
.
CHCC9000
.
CHCC9999  RETURN
+
.------------------------------------------------------------
. Write to watnbraf if waiting list admission type changes
.------------------------------------------------------------
.
WLNBR000  IF         CHGTYP=0
            GOTO       WLNBR999             * admission type change?
          ENDIF
          CALL       SAVHIS00
.
          PACK       KEY19,PURNO,SP30
          CALL       RDSTREA1
WLNBR100  CALL       RDKTREA1
          BRANCH     OVRCD,WLNBR999
.
          MATCH      PURNO,WMURNO
          GOTO       WLNBR999 IF NOT EQUAL
.
          MATCH      WMBOOK,AADMNO
          GOTO       WLNBR100 IF NOT EQUAL
.
          COMPARE    TWO,ASTAT
          GOTO       WLNBR9999 IF NOT EQUAL
.
          CALL       SAVHIS00
          MOVE       ANSC,WTHIRTYP
          MOVE       ANSN,WTHIRECS
          CALL       WRTHIS00
.
WLNBR999  RETURN
+
.------------------------------------------------------------
. CHKSTA00 - Check Admission Status
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
.
CHKSTA00  MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,CHKSTA91
.
          MATCH     "Transfer",FORMACTN
          GOTO      CHKSTA20 IF EQUAL
.
          MATCH     "Return",FORMACTN
          GOTO      CHKSTA10 IF NOT EQUAL
.
          COMPARE   "4",ASTAT
          GOTO      CHKSTA92 IF NOT EQUAL
          GOTO      CHKSTA90
.
CHKSTA10  COMPARE   "2",ASTAT
          GOTO      CHKSTA93 IF NOT EQUAL
          GOTO      CHKSTA90
.
CHKSTA20  COMPARE   "4",ASTAT
          GOTO      CHKSTA94 IF EQUAL
.
CHKSTA90  MOVE      ZERO,EXIT
          GOTO      CHKSTA99
.
CHKSTA91  MOVE      "Invalid Admission Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKSTA99
.
CHKSTA92  MOVE      "Patient is not On-Leave to Return",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKSTA99
.
CHKSTA93  MOVE      "Patient is NOT currently admitted",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKSTA99
.
CHKSTA94  CLEAR     WEBTITLE
          APPEND    "Patient is currently on leave. Return patient ",WEBTITLE
          APPEND    "from leave before transferring.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKSTA99
.
CHKSTA99  RETURN
+
.------------------------------------------------------------
.  Patient's Last Ward/Bed
.------------------------------------------------------------
.
PLWB0000  UNPACK    DIM127,DIM1,KEY1,DIM127
          MOVE      KEY1,F1
.
          PACK      KEY30,ADMISSNO,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,PLWB9999
.
          MATCH     ADMISSNO,DTADMN
          GOTO      PLWB9999 IF NOT EQUAL
.
          BRANCH    F1,PLWB0100,PLWB0200
.
          MOVE      TWARD,DFLTWARD
          CALL      WSEL0000
          GOTO      PLWB9999
.
PLWB0100  WRITE     HTMLFILE;TBED;
          GOTO      PLWB9999
.
PLWB0200  WRITE     HTMLFILE;TWARD;
          GOTO      PLWB9999
.
PLWB9999  RETURN
+
.------------------------------------------------------------
. DATSEL00 - Date selection from Admission Date to Current Date
.------------------------------------------------------------
.
DATSEL00  MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,DATSEL99
.
          CALL      IBACLOCK
          PACK      TODAY,CCC,CYY,CMM,CDD
          REP       " 0",TODAY
.
          UNPACK    TODAY,CCENT,CYEAR,CMON,CDAY
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDDSCH1
          IF        OVRCD<>1
            UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
          ELSE
            CALL      CLRDIS00
          ENDIF
.
DATSEL10  PACK      KEY8,CCENT,CYEAR,CMON,CDAY
          REP       " 0",KEY8
          MATCH     ADATE,KEY8
          GOTO      DATSEL99 IF LESS
.
          MATCH     TODAY,KEY8
          IF        @EQUAL
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            WRITE     HTMLFILE;"<option value=#"",KEY8,"#" selected>",CDAY,SP1:
                                MTHNAM3,SP1,CCENT,CYEAR,"</option>";
          ELSE
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            WRITE     HTMLFILE;"<option value=#"",KEY8,"#">",CDAY,SP1:
                                 MTHNAM3,SP1,CCENT,CYEAR,"</option>";
          ENDIF
.
          MOVE      "-1",ADJDAYS
          CALL      ADJDAT00
          GOTO      DATSEL10
.
DATSEL99  RETURN
+
.------------------------------------------------------------
. Cancel Functions
.------------------------------------------------------------
.
CANCL000  MOVE      ZERO,STATDSCH
          MOVE      ZERO,STATADMN
          MOVE      ZERO,STADMFWD
          MOVE      ZERO,STDSCBAC
          PACK      ORIGADMN,SP70
          BRANCH    UPDATETY,CANCL010,CANCL020,CANCL030,CANCL040,CANCL050:
                    CANCL060,CANCL070,CANCL040,CANCL010
          GOTO      CANCL999
.
CANCL010  CALL      CLDSC000              * Cancel Discharge
          BRANCH    EXIT,CANCL999
.
          MOVE      ADMISSNO,AADMNO       * Set for following routine
          PROC      CALCCODE              * Recalculate hrs of ICU/NCU/CCU
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDDSCH1
          IF        OVRCD=1
            CALL      CLPATDSC
          ENDIF
.
          IF        CHOSTYP=1 & CFEETYP=0
            MOVE      TWO,PTIPRSTA                * Undischarge
            MOVE      ADATE,PENDSDAT              * as at date
            CALL      CINVP000                    * Check for tobe invoiced
          ENDIF
.
          MOVE      THREE,UPBMSTAT
          CALL      UPPBMD00
          PROC      BBUP0000              * Bed Board
          IF        UPDATETY=9
            GOTO      CANCL020
          ENDIF
          GOTO      CANCL999
.
CANCL020  CALL      EPTST000              * Check for existing Episode Coding
          BRANCH    EXIT,CANCL999         * (part of "Unadmit")
.
CANCL021  CALL      CLADM000              * Cancel Admission
          BRANCH    EXIT,CANCL999
.
          MOVE      SP70,ADATE
          CALL      WESE0000
          MOVE      TWO,UPBMSTAT
          CALL      UPPBMD00
          PROC      BBUP0000              * Bed Board
.
          IF        UPDATETY=2
            CALL      ENDBRD00
          ENDIF
.
          IF        UPDATETY=9
            CALL      RMRCB000            * Remove from recurring care batch
          ENDIF
          IF        STATADMN=1
            PACK      ADMISSNO,PTMILSDN
            GOTO      CANCL010
          ENDIF
          GOTO      CANCL999
.
CANCL030  CALL      CLNBN000              * Cancel New Born
          GOTO      CANCL999
.
CANCL040  IF        UPDATETY<>4           
            GOTO      CANCL045            * Not Supervisor Admission Change
          ENDIF
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,CANCL999
.
          BRANCH    STATADMN,CANCL045
.
          MATCH     SP70,PTMILSDN
          IF        !@EQUAL
            PACK      ORIGADMN,ADMISSNO,SP70
            PACK      ADMISSNO,PTMILSDN,SP70
            MOVE      "1",STATADMN
.0935869
            MATCH     PTMIS001,ADATE             * moving adate forward?
            IF        @LESS
              MOVE      ONE,STADMFWD             * yes so use trigger 46 not 18
            ENDIF
            MATCH     PTMIS002,ATIME             * moving atime forward?
            IF        @LESS
              MOVE      ONE,STADMFWD             * yes so use trigger 46 not 18
            ENDIF
.
            GOTO      CANCL050
          ENDIF
.
CANCL045  CALL      CHGADM00              * Change Admission Date/Time
          COMPARE   "6",PTCNHDPS          * Special wahealth Assessment stuff
          GOTO      CANCL047 IF NOT EQUAL
.
          PACK      KEY24,ADMISSNO,SP70
          CALL      RSPMRUG1
CANCL046  CALL      RKPMRUG1
          BRANCH    OVRCD,CANCL047
.
          MATCH     "1",PMRUDELF
          GOTO      CANCL046 IF EQUAL
.
          MATCH     ADMISSNO,PMRUVISN
          GOTO      CANCL047 IF NOT EQUAL

          MOVE      PTMIS001,PMRUPSDT
          CALL      UPPMRUG1
          BRANCH    EXIT,CANCL999
.
CANCL047  IF        CHOSTYP=1 & CFEETYP=0
            MOVE      THREE,PTIPRSTA              * change Adm date
            MOVE      ADATE,PENDSDAT              * as at date
            CALL      CINVP000                    * Check for tobe invoiced
          ENDIF
.
          MATCH     SP70,HDPEQUIV
          IF        !@EQUAL
            CALL      WPEI0000              * write to patpeiaf
          ENDIF
          CALL      WESE0000              * write to wateseaf
.
          MOVE      ADMISSNO,AADMNO       * Set for following routine
          PROC      CALCCODE              * Recalculate hrs of ICU/NCU/CCU
.
          MATCH     "1",PTCNBMAN
          IF        @EQUAL
            PACK      KEY30,AADMNO,SP70
            CALL      RDSTRAN2
            CALL      RDKTRAN2
            BRANCH    OVRCD,CANCL999
.
            MATCH     DAADMNO,DTADMN
            GOTO      CANCL999 IF NOT EQUAL
.
            MATCH     "A",TMOVE
            GOTO      CANCL999 IF NOT EQUAL
.
            MOVE      TDATE,TRANDATE
            MOVE      TTIME,TRANTIME
            MOVE      TWARD,TRNTOWRD
            MOVE      TBED,TRNTOBED
            MOVE      ASTAY,STAYDAYS
.
            IF        ASTAT=2
              PACK      KEY8,AADMNO,SP70
              CALL      RDPMWOR1
              IF        OVRCD=1
                CALL      CLPMWO00               * Use the expected discharge
              ENDIF                              * date if a current admission
.                                                * instead of TRANDATE plus
              MATCH     SP70,PMWOEDAT            * ASTAY
              IF        !@EQUAL
                DAYSEP    TRANDATE,PMWOEDAT,STAYDAYS
              ENDIF
            ENDIF
.
            CALL      UPPBMN00
.
          ENDIF
.
          COMPARE   ONE,STATDSCH
          IF        @EQUAL
            PACK      ADMISSNO,ORIGADMN,SP70
            GOTO      CANCL050
          ENDIF
.0935869
          COMPARE   ONE,STATADMN
          IF        @EQUAL
            IF        STADMFWD=1
              PACK      ORIGADMN,ADMISSNO,SP70
              PACK      ADMISSNO,PTMILSDN,SP70
              CALL      BVISUP00       * Broadcast A08 for stat dsc date change
              PACK      ADMISSNO,ORIGADMN,SP70
            ENDIF
          ENDIF
.
          GOTO      CANCL999
.
CANCL050  IF        UPDATETY<>5
            GOTO      CANCL055
          ENDIF
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDDSCH1
          BRANCH    OVRCD,CANCL999
.
          BRANCH    STATDSCH,CANCL055
.
          MATCH     SP70,PTDSLSDN
          IF        !@EQUAL
            PACK      ORIGADMN,ADMISSNO,SP70
            PACK      ADMISSNO,PTDSLSDN,SP70
            MOVE      "1",STATDSCH
.0935869
            MATCH     DDATE,PTMIS001             * moving ddate back?
            IF        @LESS
              MOVE      ONE,STDSCBAC             * yes so use trigger 45 not 17
            ENDIF
            MATCH     DTIME,PTMIS002             * moving dtime back?
            IF        @LESS
              MOVE      ONE,STDSCBAC             * yes so use trigger 45 not 17
            ENDIF
.
            GOTO      CANCL040
          ENDIF
.
CANCL055  CALL      CHDSC000              * Change Discharge Date/Time
          BRANCH    EXIT,CANCL999
.
          CALL      WRPATR10  
.
          COMPARE   "6",PTCNHDPS            * Special wahealth Assessment stuff
          GOTO      CANCL057 IF NOT EQUAL
.
          PACK      KEY24,ADMISSNO,Z70
          CALL      RSPMRUG1
CANCL056  CALL      RPPMRUG1
          BRANCH    OVRCD,CANCL057

          MATCH     "1",PMRUDELF
          GOTO      CANCL056 IF EQUAL
.
          MATCH     ADMISSNO,PMRUVISN
          GOTO      CANCL057 IF NOT EQUAL
.
          MOVE      DDATE,PMRUPEDT
          CALL      UPPMRUG1
.
CANCL057  MATCH     SP70,HDPEQUIV
          IF        !@EQUAL
            CALL      WPEI0000              * write to patpeiaf
          ENDIF
.
          IF        CHOSTYP=1 & CFEETYP=0
            MOVE      THREE,PTIPRSTA        * change Disc. date
            CALL      CINVP000              * Check for tobe invoiced
          ENDIF
.
          MOVE      ADMISSNO,AADMNO       * Set for following routine
          PROC      CALCCODE              * Recalculate hrs of ICU/NCU/CCU
.
          COMPARE   ONE,STATADMN
          IF        @EQUAL
            PACK      ADMISSNO,ORIGADMN,SP70
            GOTO      CANCL040
          ENDIF
.
          CALL      UXDC0000              * Update visxdcaf details
.0935869
          COMPARE   ONE,STATDSCH
          IF        @EQUAL
            IF        STDSCBAC=1
              PACK      ORIGADMN,ADMISSNO,SP70
              PACK      ADMISSNO,PTDSLSDN,SP70
              CALL      BVISUP00       * Broadcast A08 for stat adm date change
              PACK      ADMISSNO,ORIGADMN,SP70
            ENDIF
          ENDIF
.
          GOTO      CANCL999
.
CANCL060  CALL      GSVDEP00
          CALL      EPTST000              * Check for existing Episode Coding
          BRANCH    EXIT,CANCL999
CANCL061  CALL      CHMTR000              * Cancel transfer/movement
          BRANCH    EXIT,CANCL999
          MATCH     SP70,HDPEQUIV
          IF        !@EQUAL
            CALL      WPEI0000              * write to patpeiaf
          ENDIF
.
          MOVE      ADMISSNO,AADMNO       * Set for following routine
          PROC      CALCCODE              * Recalculate hrs of ICU/NCU/CCU
.
          MATCH     "1",PTCNBMAN
          IF        @EQUAL
            PACK      KEY30,AADMNO,SP70
            CALL      RDSTRAN2
            CALL      RDKTRAN2
            BRANCH    OVRCD,CANCL069
.
            MATCH     DAADMNO,DTADMN
            GOTO      CANCL069 IF NOT EQUAL
.
            MATCH     "A",TMOVE
            GOTO      CANCL069 IF NOT EQUAL
.
            MOVE      TDATE,TRANDATE
            MOVE      TTIME,TRANTIME
            MOVE      TWARD,TRNTOWRD
            MOVE      TBED,TRNTOBED
            MOVE      ASTAY,STAYDAYS
            CALL      GETRG000    *  get regimes if not on screen
.
            IF        ASTAT=2
              PACK      KEY8,AADMNO,SP70
              CALL      RDPMWOR1
              IF        OVRCD=1
                CALL      CLPMWO00               * Use the expected discharge
              ENDIF                              * date if a current admission
.                                                * instead of TRANDATE plus
              MATCH     SP70,PMWOEDAT            * ASTAY
              IF        !@EQUAL
                DAYSEP    TRANDATE,PMWOEDAT,STAYDAYS
              ENDIF
            ENDIF
.
            CALL      UPPBMN00
.
          ENDIF
.
          PROC      BBUP0000                * Bed Board
.
CANCL069  CALL      CANMH000                * Cancel Mental Health records
.
          GOTO      CANCL999
.
CANCL070  CALL      EPTST000              * Check for existing Episode Coding
          BRANCH    EXIT,CANCL999
CANCL071  CALL      CCART000              * Cancel Care type change
          GOTO      CANCL999
.
CANCL999  PROC      WRWATR00              * write to WA triggers table
          RETURN
.
.------------------------------------------------------------
. RMRCB000 - Remove from recurring care batch
.------------------------------------------------------------
RMRCB000  PACK      KEY16,AADMNO,SP70
          CALL      RSPMRCB2
          CALL      RKPMRCB2
          BRANCH    OVRCD,RMRCB999
.
          MATCH     DAADMNO,PMRCADMN
          GOTO      RMRCB999 IF NOT EQUAL
.
          PACK      KEY16,PMRCADMN,PMRCBATC,SP70
          CALL      DEPMRCB2
          GOTO      RMRCB000
.
RMRCB999  RETURN
+
.------------------------------------------------------------
. CHGADM00 - Change Admission Date/Time
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
.
CHGADM00  MOVE      SP70,HDPEQUIV
          MOVE      ADMISSNO,AADMNO
          MOVE      ZERO,DISFLAG             * discharged flag (1=yes)
.
.        Check if some one is accessing this patient
.
          MOVE      AADMNO,KEY8
          CALL      RLPTMIS1                     * admission record found ?
          BRANCH    OVRCD,CHGADM92:              * no
                          CHGADM93               * yes - already locked
.
          COMPARE   ONE,ASTAT
          GOTO      CHGADM94 IF EQUAL
.
          MOVE      AURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,CHGADM95
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MOVE      AADMNO,PVIBILL
          MOVE      PVIBILL,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD,CHGADM96
.
          MOVE      AADMNO,KEY8
          CALL      RDDSCH1
          IF        OVRCD<>1
            MOVE      ONE,DISFLAG
          ELSE
            CALL      CLRDIS00
          ENDIF
.
          MOVE      ADATE,OLDADATE
          REP       " 0",OLDADATE
.
          MATCH     SP70,PTMIS001
          IF        @EQUAL|@EOS
            GOTO      CHGADM90
          ENDIF
.
          MATCH     PBDATE,PTMIS001
          GOTO      CHGADM97 IF LESS
.
          MATCH     SP70,PTMIS002
          IF        @EQUAL|@EOS
            GOTO      CHGADM91
          ENDIF
.
          MATCH     ADATE,PTMIS001
          IF        !@EQUAL
            MOVE      "01",HDPEQUIV
            CALL      IPEN0000              * write a record to pending file
            GOTO      CHGADM50
          ENDIF
.
          MATCH     ATIME,PTMIS002
          IF        !@EQUAL
            MOVE      "02",HDPEQUIV
            GOTO      CHGADM50
          ENDIF
.
.         This code is used to update care type.(refer to patweb9801035.html)
.
          MATCH     ACARE,TRNACARE
          IF        !@EQUAL
            MOVE      "05",HDPEQUIV
            GOTO      CHGADM50
          ENDIF
.
          GOTO      CHGADM99                * No Change
.
CHGADM50  CALL      CHTRNS00
          BRANCH    EXIT,CHGADM98
.
          CALL      DATRAN00                * Check Date Change Range
          BRANCH    EXIT,CHGADM98
.
          MOVE      ADMISSNO,KEY8
          CALL      RDPTMIS1
          BRANCH    OVRCD,CHGADM92,CHGADM93
.
          CALL      CHGAD000                * Change Admission Date
          BRANCH    EXIT,CHGADM98
.
          MOVE      "Admission Date Changed.",WEBTITLE
          MOVE      ADMISSNO,KEY8
          CALL      UUPTMIS1
          MOVE      ZERO,EXIT
          GOTO      CHGADM99
.
CHGADM90  CLEAR     WEBTITLE
          APPEND    "Admission Date cannot be blank ",WEBTITLE
          APPEND    APORT,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ADMISSNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      CHGADM99
.
CHGADM91  CLEAR     WEBTITLE
          APPEND    "Admission Time cannot be blank ",WEBTITLE
          APPEND    APORT,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ADMISSNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      CHGADM99
.
CHGADM92  MOVE      "Invalid Admission Number.  ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHGADM99
.
CHGADM93  CLEAR     WEBTITLE
          APPEND    "Patient Admission Busy on Terminal ",WEBTITLE
          APPEND    APORT,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHGADM99
.
CHGADM94  MOVE      "Admission not Admitted.  ",WEBTITLE
          CALL      WEBERR00
          MOVE      ADMISSNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      CHGADM99
.
CHGADM95  CLEAR     WEBTITLE
          APPEND    "Master File Data Missing",WEBTITLE
          APPEND    " for Patient.  Contact IBA Immediately.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ADMISSNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      CHGADM99
.
CHGADM96  CLEAR     WEBTITLE
          APPEND    "Visit File Record Missing",WEBTITLE
          APPEND    " for Patient.  Contact IBA Immediately.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ADMISSNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      CHGADM99
.
CHGADM97  MOVE      "Birth date cannot be after Admission Date.",WEBTITLE
          CALL      WEBERR00
CHGADM98  MOVE      ADMISSNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      CHGADM99
.
CHGADM99  RETURN
+
.------------------------------------------------------------
. CHTRNS00 - Check that the new admission date is less than the second record
. in the bed transfer file (first record is the old admission record)
. Returns:    EXIT  0 = Ok to proceed
.                   1 = Error
.------------------------------------------------------------
.
CHTRNS00  PACK      KEY30,AADMNO,SP30
          CALL      RDSTRAN2
CHTRNS10  CALL      RDKTRAN2
          BRANCH    OVRCD,CHTRNS90
.
          MATCH     TADMN,AADMNO
          GOTO      CHTRNS90 IF NOT EQUAL
.
          MATCH     "A",TMOVE
          GOTO      CHTRNS10 IF EQUAL
.
          MATCH     TDATE,PTMIS001
          GOTO      CHTRNS90 IF LESS
          GOTO      CHTRNS92 IF NOT EQUAL
.
          MATCH     TTIME,PTMIS002
          GOTO      CHTRNS91 IF NOT LESS
.
CHTRNS90  MOVE      ZERO,EXIT
          GOTO      CHTRNS99
.
CHTRNS91  MOVE      TTIME,DIM5
          UNPACK    TDATE,XCENT,XYEAR,XMON,XDAY
          PACK      DISPDTTM,XDAY,SLASH,XMON,SLASH,XCENT,XYEAR,SP1,DIM5
          CLEAR     WEBTITLE
          APPEND    "Admission Time after first Bed Movement (",WEBTITLE
          APPEND    DISPDTTM,WEBTITLE
          APPEND    ")",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHTRNS99
.
.        The new admission date is later than a bed movement
.
CHTRNS92  UNPACK    TDATE,XCENT,XYEAR,XMON,XDAY
          PACK      DISPDTTM,XDAY,SLASH,XMON,SLASH,XCENT,XYEAR
          CLEAR     WEBTITLE
          APPEND    "Admission date must not be later than previous ",WEBTITLE
          APPEND    "bed movement on ",WEBTITLE
          APPEND    DISPDTTM,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHTRNS99
.
CHTRNS99  RETURN
+
.------------------------------------------------------------
. DATRAN00 - Date is okay as far as the bed transfer file is concerned.
. Check if change is more than CERRDAY days, and if so, check if
. the user is less than CERRSEC security level. If so, not allowed.
.------------------------------------------------------------
.
DATRAN00  MOVE      ADATE,WDATE2
          MOVE      PTMIS002,ATIME
.
          MOVE      PTMIS001,WDATE1
          CALL      DIFFDY00
          MULT      COUNT,NBRDAYS            * To ensure it is positive
.
          COMPARE   NBRDAYS,CERRDAY
          GOTO      DATRAN10 IF LESS
.
.        Check if change being attempted within CERRDAY days of discharge
.
          PACK      WDATE2,CCC,CYY,CMM,CDD
          REP       " 0",WDATE2
          UNPACK    DDATE,XCENT,XYEAR,XMON,XDAY
          PACK      WDATE1,XCENT,XYEAR,XMON,XDAY
          CALL      DIFFDY00
          MULT      COUNT,NBRDAYS            * To ensure it is positive
.
          COMPARE   NBRDAYS,CERRDAY
          GOTO      DATRAN20 IF LESS
.
          GOTO      DATRAN30
.
DATRAN10  COMPARE   CERRSEC,SECLEV
          GOTO      DATRAN30 IF NOT LESS
.
          GOTO      DATRAN91
.
DATRAN20  COMPARE   CERRSEC,SECLEV
          GOTO      DATRAN92 IF LESS
.
.        Print a warning message if new admission date is not the same
.        year/month as the old admission date
.
DATRAN30  MOVE      PTMIS001,DIM6
          MOVE      ADATE,KEY6
.
          MATCH     KEY6,DIM6
          GOTO      DATRAN40 IF NOT LESS
.
          CLEAR     WEBTITLE
          APPEND    "Warning: New Admission Date in a Prior ",WEBTITLE
          APPEND    "Month to Old Admission Date.",WEBTITLE
          RESET     WEBTITLE
          GOTO      DATRAN90
.
.        Check the new Admission Date/Time against the current date/time
.
DATRAN40  PACK      XDATE,CCC,CYY,CMM,CDD
          REP       " 0",XDATE
.
          MATCH     PTMIS001,XDATE
          GOTO      DATRAN93 IF LESS
          IF        @EQUAL
.
.           Current date - so check the admission time against current time
.
            CLOCK     TIME,CTIMEIS
            MATCH     ATIME,CTIMEIS
            GOTO      DATRAN93 IF LESS
          ENDIF
.
DATRAN90  MOVE      ZERO,EXIT
          GOTO      DATRAN99
.
DATRAN91  CLEAR     WEBTITLE
          APPEND    "Change for More than ",WEBTITLE
          APPEND    CERRDAY,WEBTITLE
          APPEND    " Days.  ",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DATRAN99
.
DATRAN92  CLEAR     WEBTITLE
          APPEND    "Change not Within ",WEBTITLE
          APPEND    CERRDAY,WEBTITLE
          APPEND    " Days of Discharge.  ",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DATRAN99
.
DATRAN93  MOVE      "Cannot Admit into the Future.  ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DATRAN99
.
DATRAN99  RETURN
+
.------------------------------------------------------------
. CHGAD000
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
.
CHGAD000  CALL      ACTASAV0          *Save old values for use in the audit file
.
.      Save original adate and atime for insert to patunaaf, sadate and satime
.      get overwritten at CHGAD157
.
          MOVE      ADATE,SAVADATE    *Save for patunaaf.PTUNODTE    *I-0839864
          MOVE      ATIME,SAVATIME    *Save for patunaaf.PTUNOTTM    *I-0939864
.
          CALL      MEHC0000                * update mental health details
.
.         update the patdayaf file if appropriate
.
          MOVE      FIVE,OPTION
          CALL      PATD0000                  * update the patdayaf file
.
.      Update Admission record in Transfer file
.
          PACK      KEY30,AADMNO,SP30
          CALL      RDSTRAN2
          CALL      RDKTRAN2
          BRANCH    OVRCD,CHGAD910
.
          MATCH     TADMN,AADMNO
          GOTO      CHGAD910 IF NOT EQUAL
.
          CMATCH    "A",TMOVE
          GOTO      CHGAD910 IF NOT EQUAL
.
          MOVE      PTMIS001,TDATE
          MOVE      PTMIS002,TTIME
          PACK      TRCDATE,CCC,CYY,CMM,CDD
          REP       " 0",TRCDATE
          CLOCK     TIME,TRCTIME
          MOVE      WBSEUID,PTTRUUID
.
          CALL      UPTRAN2
          MOVE      "19 ",ALTTYPE
          MOVE      SP70,ALTOLDVL
          MOVE      SP70,ALTNEWVL
          CALL      WEAL0000                * Write EDWARD alteration record
.
.        Update the Fee's Raised Indicator - Use the earlier of the two dates
.
          MOVE      ADATE,TDATE
.
          MATCH     PTMIS001,TDATE
          GOTO      CHGAD010 IF LESS
.
          MOVE      PTMIS001,TDATE
.
CHGAD010  CALL      UPDCFR00
.
.        Update the Ward Usage Statistics and Admission/Discharge Statistics
.
CHGAD020  MOVE      ADATE,CPTDATE
          REP       " 0",CPTDATE
          CALL      GPERD                * Get the financial period for date
          BRANCH    EXIT,CHGAD930         * Date not in period file
.
          PACK      KEY9,TWARD,DRGYR,DRGNUM
          MOVE      ONE,COUNT               * Number of Admissions
          MOVE      SEQ,FORM2            * Subtract old date
.
          MOVE      DRGYR,SADYEAR
          MOVE      DRGNUM,FORM2
.
          MATCH     SP3,ASRCE
          GOTO      CHGAD030 IF NOT EQUAL
.
          MOVE      "UNK",ASRCE
.
CHGAD030  PACK      KEY8,SADYEAR,CODEB,ASRCE
          CALL      CANSTA00
.
          MATCH     SP3,ATYPE
          GOTO      CHGAD040 IF NOT EQUAL
.
          MOVE      "UNK",ATYPE
.
CHGAD040  PACK      KEY8,SADYEAR,CODEA,ATYPE
          CALL      CANSTA00
.
.        Now add in data for new date
.
CHGAD050  MOVE      PTMIS001,CPTDATE
          REP       " 0",CPTDATE
          CALL      GPERD                * Get the financial period for date
          BRANCH    EXIT,CHGAD930         * Date not in period file
.
          PACK      KEY9,TWARD,DRGYR,DRGNUM
          MOVE      ONE,FORM2               * Add new date
.
          MOVE      DRGYR,SADYEAR
          MOVE      DRGNUM,FORM2
.
          MATCH     SP3,ASRCE
          GOTO      CHGAD060 IF NOT EQUAL
.
          MOVE      "UNK",ASRCE
.
CHGAD060  PACK      KEY8,SADYEAR,CODEB,ASRCE
          CALL      RDSTAD1
          IF        OVRCD=0
            CALL      ADDSTAD
          ENDIF
.
          MATCH     SP3,ATYPE
          GOTO      CHGAD070 IF NOT EQUAL
.
          MOVE      "UNK",ATYPE
.
CHGAD070  PACK      KEY8,SADYEAR,CODEA,ATYPE
          CALL      RDSTAD1
          IF        OVRCD=0
            CALL      ADDSTAD
          ENDIF
.          CALL      ADMHCS00
.
.        If U/R number is spaces ignore it
.
          MATCH     ZEROUR,AURNO
          GOTO      CHGAD130 IF EQUAL
.
.        Read and Update the new admission date to patient visit file
.
          UNPACK    PTMIS001,XCENT,XYEAR,XMON,XDAY
.
          MOVE      AURNO,PVIURNO
          MOVE      AADMNO,PVIBILL
          MOVE      ADATE,PVIDATE
          REP       " 0",PVIDATE
          MOVE      PVIBILL,KEY8
          CALL      RLPTVIS1                     * visit record found ?
          BRANCH    OVRCD,CHGAD120:              * no
                          CHGAD920               * yes - already locked
.
.        Update the admission date
.
          PACK      PVIDATE,XCENT,XYEAR,XMON,XDAY
          REP       " 0",PVIDATE
          CALL      UPVISA1
          CALL      UUPTVIS1
.
          IF        DISFLAG=1
            PROC      CALCDLOS                     * calc discharge los & ward
            PACK      KEY8,AADMNO
            CALL      RDADSCH1
            BRANCH    OVRCD,CHGAD130
            CALL      UPDSCH1
          ENDIF
.
          GOTO      CHGAD130
.
.        If not exist - Write a new record for Visit file
.
CHGAD120  PACK      PVIDATE,XCENT,XYEAR,XMON,XDAY
          REP       " 0",PVIDATE
          PACK      KEY24,PVIURNO,PVIDATE,PVIBILL
          MOVE      THREE,PVITYPE
          MOVE      ADOCTA,PVIDOCT
          MOVE      ONE,PVISTAT
          MOVE      SP2,PVILOCK
          MOVE      ONE,PVITRAN
          MOVE      SP20,PVISPAR
.
          CALL      WRVISA1
..        CALL      ADDVIS00
.
.        Update Admission record - Check if Last Accom Date (ALACDTE) has
.        to be altered as well (Yes is no invoices printed, Maybe otherwise)
.
CHGAD130  MOVE      ALACDTE,SALACDAT
          MATCH     PTMIS001,ADATE
          IF        !@EQUAL
            MOVE      ONE,NMDSCHGF
          ENDIF
.
          MATCH     PTMIS002,ATIME
          IF        !@EQUAL
            MOVE      ONE,NMDSCHGF
          ENDIF
.
          MOVE      PTMIS001,ADATE
          MOVE      PTMIS002,ATIME
.
          COMPARE   ZERO,AINVPRT
          GOTO      CHGAD140 IF EQUAL
.
.        An invoice has been printed. If the new ADATE is less than ALACDTE
.        then don't alter ALACDTE, otherwise make ALACDTE the same as ADATE
.
          MATCH     ALACDTE,PTMIS001
          GOTO      CHGAD150 IF LESS
.
CHGAD140  MOVE      ADATE,ALACDTE
CHGAD150  IF        UPDATETY<>5
            MOVE      TRNACARE,ACARE          * HPS Code is here
          ENDIF 
          CALL      UPLMISS1
.
          IF        NMDSCHGF=1
            CALL      CHGNZ000           * date/time changed - update nmds
          ENDIF
.
          IF        DISFLAG=1
            PROC      CALCDLOS                     * calc discharge los & ward
            PACK      KEY8,AADMNO
            CALL      RDADSCH1
            BRANCH    OVRCD,CHGAD155
.
            CALL      UPDSCH1
          ENDIF
.
.         Broadcast change of admission details for Datagate
.
CHGAD155  PACK      KEY8,AADMNO,SP70
          CALL      RDPTRES1
          IF        OVRCD=1
            CALL      CPTRE100
          ENDIF
.
          PACK      KEY30,AADMNO,Z70
          CALL      RDSTRAN2                     * position in file
          CALL      RDPTRAN2                     * read previous record
          IF        OVRCD<>0
            CALL      CLPATTRN
            GOTO      CHGAD157
          ENDIF
.
          MATCH     AADMNO,TADMN                 * same admission still ?
          IF        !@EQUAL
            CALL      CLPATTRN
            GOTO      CHGAD157
          ENDIF
.0935869
          COMPARE   ONE,STATDSCH
          IF        @EQUAL
            COMPARE   ONE,STDSCBAC       * send the A08 using trigger 45 not 17
            GOTO      CHGAD157 IF EQUAL
          ENDIF
.
          CALL      PMIGTNID                 * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TEN7,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICAC                * Chng admission details   *C-90222
.
.        Update Audit File if required
.
CHGAD157  BRANCH    CAUDA,CHGAD160
.
          MOVE      "B",ACTION
          CALL      WRAAUD
          MOVE      "C",ACTION
          CALL      ACTASAV0
          CALL      WRAAUD
.
CHGAD160  MOVE      THREE,PTUNTYPE
          MOVE      SAVADATE,PTUNODTE                                *I-0839864
          MOVE      SAVATIME,PTUNOTTM                                *I-0839864
          CALL      ADMHCS00                 * Admission record
.
          COMPARE   THREE,ASTAT
          GOTO      CHGAD170 IF NOT EQUAL
.
...       CALL      DISHCS00               * Discharge record
.
CHGAD170  MOVE      "Admission Changed.  ",WEBTITLE
          MOVE      ZERO,EXIT
          GOTO      CHGAD999
.
CHGAD910  CLEAR     WEBTITLE
          APPEND    "Admission Transfer Record not Found.  Contact ",WEBTITLE
          APPEND    "IBA Immediately.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHGAD999
.
.      Visit file locked
.
CHGAD920  CLEAR     WEBTITLE
          APPEND    "Visit ",WEBTITLE
          APPEND    PVIBILL,WEBTITLE
          APPEND    " Locked on Port ",WEBTITLE
          APPEND    PVILOCK,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHGAD999
.
.        Period record not found in file
.
CHGAD930  UNPACK    CPTDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          CLEAR     WEBTITLE
          APPEND    CPCDATE,WEBTITLE
          APPEND    " not found in period file.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
CHGAD980  MOVE      ONE,EXIT
          GOTO      CHGAD999
.
CHGAD999  RETURN
+
.------------------------------------------------------------
. CHDSC000 - Change Discharge Date
. Returns:  EXIT   0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
.
CHDSC000  MOVE      SP70,HDPEQUIV
          MOVE      ADMISSNO,KEY8   *Check if some one is accessing this patient
          CALL      RDPTMIS1
          BRANCH    OVRCD,CHDSC940,CHDSC945
.
.        Check that this person can have their discharge date changed
.
          MOVE      PTDSC001,TRANDATE
          MOVE      PTDSC002,TRANTIME
          COMPARE   THREE,ASTAT
          GOTO      CHDSC950 IF NOT EQUAL
.
          MOVE      AADMNO,KEY8
          CALL      RDDSCH1
          BRANCH    OVRCD,CHDSC955
.
.        Check if any items tobe invoiced after new disc.date
.
          CALL      CITM0000                * Check if any item tobe invoiced
          BRANCH    EXIT,CHDSC925
.
.        Check if there is any care type change after new disc.date
.
          CALL      CCAR0000               * Check care type
          BRANCH    EXIT,CHDSC926
.
.        Check that this is the right person
.
          MOVE      AURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,CHDSC960
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MOVE      AADMNO,PVIBILL
          MOVE      PVIBILL,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD,CHDSC965
.
          MATCH     SP70,PTDSC002
          IF        @EQUAL|@EOS
            GOTO      CHDSC910
          ENDIF
          PACK      OLDDEATH,PDECDTE,PTMAUKDD,PMPXDETY,PTMADCNO,SP70 *Death det.
.
          MATCH     DDATE,PTDSC001
          IF        @EQUAL
            MATCH     DTIME,PTDSC002
            GOTO      CHDSC850 IF EQUAL
          ENDIF
.
CHDSC020  MATCH     SP70,PTDSLSDN
          CALL      CHKDDS00                * Check discharge date is before
          COMPARE   ONE,EXIT                * the next admision date adn time
          IF        @EQUAL
            MOVE      ADMISSNO,KEY8
            CALL      UUPTMIS1
            GOTO      CHDSC980
          ENDIF
.
.        Check that we are not discharging into the future
.
          PACK      XDATE,CCC,CYY,CMM,CDD
          REP       " 0",XDATE
.
          MATCH     PTDSC001,XDATE
          GOTO      CHDSC050 IF NOT LESS
.
          CLOCK     TIME,CTIMEIS
          MATCH     PTDSC002,CTIMEIS
          GOTO      CHDSC930 IF LESS
.
.        Check that the new discharge date is greater than the second last
.        record in the bed transfer file (last record is the old discharge
.        record)
.
CHDSC050  PACK      KEY30,AADMNO,PTDSC001,PTDSC002,SP30
          CALL      RDSTRAN2
          CALL      RDKTRAN2
          BRANCH    OVRCD,CHDSC100
.
          MATCH     TADMN,AADMNO
          GOTO      CHDSC100 IF NOT EQUAL
.
          MATCH     "D",TMOVE
          GOTO      CHDSC100 IF EQUAL
          GOTO      CHDSC935                * Disc date later than bed movement
.
.        Date is okay as far as the bed transfer file is concerned.
.        Check if change is more than CERRDAY days, and if so, check if
.        the user is less than CERRSEC security level. If so, not allowed.
.
CHDSC100  UNPACK    DDATE,XCENT,XYEAR,XMON,XDAY
          PACK      WDATE2,XCENT,XYEAR,XMON,XDAY
.
          MOVE      PTDSC001,WDATE1
          CALL      DIFFDY00
          MULT      COUNT,NBRDAYS            * To ensure it is positive
.
          COMPARE   NBRDAYS,CERRDAY
          GOTO      CHDSC200 IF LESS
.
.        Check if change being attempted within CERRDAY days of discharge
.
          PACK      WDATE2,CCC,CYY,CMM,CDD
          REP       " 0",WDATE2
          UNPACK    DDATE,XCENT,XYEAR,XMON,XDAY
          PACK      WDATE1,XCENT,XYEAR,XMON,XDAY
          CALL      DIFFDY00
          MULT      COUNT,NBRDAYS            * To ensure it is positive
.
          COMPARE   NBRDAYS,CERRDAY
          GOTO      CHDSC300 IF LESS
          GOTO      CHDSC380
.
CHDSC200  COMPARE   CERRSEC,SECLEV
          GOTO      CHDSC380 IF NOT LESS
          GOTO      CHDSC970
.
CHDSC300  COMPARE   CERRSEC,SECLEV
          GOTO      CHDSC975 IF LESS
.
CHDSC380  BRANCH    PTCNDISI,CHDSC400        * Allow to change disc.date
.
.         Check if invoice had been printed upto discharged.
.
          MATCH     ALACDTE,DDATE
          GOTO      CHDSC400 IF NOT EQUAL    * Not invoiced up to disc.date
.
          MATCH     PTDSC001,DDATE           * Check if disc.date changed?
          GOTO      CHDSC400 IF EQUAL        * no, only disc.time changed
.
          CALL      CINV0000        * Check if the invoice amount is balanced
          BRANCH    EXIT,CHDSC972
.
.        Print a warning message if new discharge date is not the same
.        year/month as the old discharge date
.
CHDSC400  UNPACK    PTDSC001,DIM6
          UNPACK    DDATE,XCENT,XYEAR,XMON,XDAY
          PACK      KEY6,XCENT,XYEAR,XMON
.
          MATCH     DDATE,PTDSC001
          IF        !@EQUAL
            MOVE      "09",HDPEQUIV
            MOVE      ONE,NMDSCHGF
          ELSE
            MATCH     DTIME,PTDSC002
            IF        !@EQUAL
              MOVE      "10",HDPEQUIV
              MOVE      ONE,NMDSCHGF
            ENDIF
          ENDIF
.
          MATCH     DIM6,KEY6
          GOTO      CHDSC500 IF NOT LESS
.
          DISPLAY   "Warning: New Discharge Date in a Later ":
                    "Month to Old Discharge Date.";
.
.        Save old values for use in the audit file
.
CHDSC500  CALL      ACTBSAV0
.
.        Update the patdayaf file if appropriate
.
          MOVE      SIX,OPTION
          CALL      PATD0000                  * update the patdayaf file
.
.        Update the Discharge record in the Transfer file
.
          PACK      KEY30,AADMNO,DDATE,DTIME,SP30
          CALL      RDSTRAN2
          CALL      RDKTRAN2
          BRANCH    OVRCD,CHDSC915
.
          MATCH     TADMN,AADMNO
          GOTO      CHDSC915 IF NOT EQUAL
.
          CMATCH    "D",TMOVE
          GOTO      CHDSC915 IF NOT EQUAL
.
          MOVE      PTDSC001,TDATE
          MOVE      PTDSC002,TTIME
.
          PACK      TRCDATE,CCC,CYY,CMM,CDD
          REP       " 0",TRCDATE
          CLOCK     TIME,TRCTIME
          MOVE      WBSEUID,PTTRUUID
.
          CALL      UPTRAN2
.
.        Update the Fee's Raised Indicator - Use the earlier of the two dates
.
          MOVE      DDATE,TDATE
.
          MATCH     PTDSC001,TDATE
          GOTO      CHDSC600 IF LESS
          MOVE      PTDSC001,TDATE
.
CHDSC600  CALL      UPDCFR00                * Update the Control File
.
.        Update the Ward Usage Statistics and Admission/Discharge Statistics
.
CHDSC650  MOVE      DDATE,CPTDATE
          REP       " 0",CPTDATE
          CALL      GPERD                * Get the financial period for date
          BRANCH    EXIT,CHDSC920        * Date not in period file
.
          PACK      KEY9,TWARD,DRGYR,DRGNUM
          MOVE      FOUR,COUNT              * Number of Discharges
          MOVE      SEQ,FORM2            * Subtract old date
.
          MOVE      DRGYR,SADYEAR
          MOVE      DRGNUM,FORM2
.
          MATCH     SP3,DDEST
          GOTO      CHDSC700 IF NOT EQUAL
.
          MOVE      "UNK",DDEST
.
CHDSC700  PACK      KEY8,SADYEAR,CODED,DDEST
          CALL      CANSTA00
.
.        Now add in data for new date
.
CHDSC750  MOVE      PTDSC001,CPTDATE
          REP       " 0",CPTDATE
          CALL      GPERD                * Get the financial period for date
          BRANCH    EXIT,CHDSC920        * Date not in period file
.
          PACK      KEY9,TWARD,DRGYR,DRGNUM
          MOVE      ONE,FORM2               * Add new date
.
          MOVE      DRGYR,SADYEAR
          MOVE      DRGNUM,FORM2
.
          MATCH     SP3,DDEST
          GOTO      CHDSC800 IF NOT EQUAL
.
          MOVE      "UNK",DDEST
.
CHDSC800  PACK      KEY8,SADYEAR,CODED,DDEST
          CALL      RDSTAD1
          IF        OVRCD=0
            CALL      ADDSTAD
          ENDIF
.
.        Update discharge record
.
          MOVE      PTDSC001,DDATE
          MOVE      PTDSC002,DTIME
.
          PROC      CALCDLOS               * Calculate Discharge Ward & LOS
          CALL      UPDSCH1
.
          IF        NMDSCHGF=1
            CALL      CHGNZ000           * date/time changed - update nmds
          ENDIF
.
          MOVE      FOUR,PTUNTYPE
          MOVE      SDDATE,PTUNODTE
          MOVE      SDTIME,PTUNOTTM
          CALL      DISHCS00
.
          CALL      DELPAT00               * Update Current Patient Search
.                                          * I CAR 23608
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPTRES1
          IF        OVRCD=1
            CALL      CPTRE100
          ENDIF
.
.         Broadcast change of discharge details for Datagate
.0935869
          COMPARE   ONE,STATADMN
          IF        @EQUAL
            COMPARE   ONE,STADMFWD       * send the A08 using trigger 46 not 18
            GOTO      CHDSC840 IF EQUAL
          ENDIF
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TEN8,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICDC                * change discharge details *C-90222
.
.        Update the audit file if required
.
CHDSC840  BRANCH    CAUDB,CHDSC850
.
          MOVE      "B",ACTION
          CALL      WRBAUD
          MOVE      "C",ACTION
          CALL      ACTBSAV0
          CALL      WRBAUD
.
.         Check if invoice fully printed ?
.
CHDSC850  REP       " 0",ALACDTE
          MATCH     ALACDTE,SDDATE       * check with the old disc.date
          GOTO      CHDSC870 IF NOT EQUAL
.
.        Allow for the case where this is a day case not yet invoiced
.
          COMPARE   ZERO,AINVPRT
          GOTO      CHDSC870 IF EQUAL
.
.        Correct last accomodation date in admission record
.
          MOVE      PTDSC001,ALACDTE     * set to the new discharged date
          CALL      UPLMISS1
          GOTO      CHDSC880
.
.        Check if patient has changed from daycase to overnight or
.        from overnight to daycase
.
CHDSC870  CALL      CFEE0000             * recalculate bed fees
.
CHDSC880  CALL      CHKPND00              * Check for Invoice Pending Record
.
          CALL      DEADST00              * Check for deceased indicators
          IF        PCEASE=1
           CALL       UPMAST1
          ENDIF
          PACK      KEY30,PDECDTE,PTMAUKDD,PMPXDETY,PTMADCNO,SP70 *Death det.
          MATCH     KEY30,OLDDEATH
          IF        !@EQUAL
            MOVE      "001",D3
            CALL       WDAU0000           * Write to Death details audit file
          ENDIF
.
          PACK      KEY24,AURNO,Z70      * seach for the last discharge date
          CALL      RDSDSCH3
          CALL      RDPDSCH3             * hunt backwards
          BRANCH    OVRCD,CHDSC900
.
          MATCH     AURNO,DURNO
          IF        @EQUAL
           MOVE       DDATE,PLDDATE      * set max discharge
           CALL       UPMAST1
          ENDIF
.
CHDSC900  MOVE      "Discharge Date Changed.  ",WEBTITLE
          MOVE      ADMISSNO,KEY8
          CALL      UUPTMIS1
          MOVE      ZERO,EXIT
          GOTO      CHDSC999
.
CHDSC910  MOVE      "Cannot have blank discharge time.",WEBTITLE
          CALL      WEBERR00
          MOVE      ADMISSNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      CHDSC999
.
CHDSC915  MOVE      "Discharge Transfer Record not Found.",WEBTITLE
          CALL      WEBERR00
          MOVE      ADMISSNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      CHDSC999
.
CHDSC920  UNPACK    CPTDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          CLEAR     WEBTITLE
          APPEND    CPCDATE,WEBTITLE
          APPEND    " not found in Period File.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ADMISSNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      CHDSC999
.
CHDSC925  MOVE      "Found items to be invoiced after Discharged Date.",WEBTITLE
          CALL      WEBERR00
          MOVE      ADMISSNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      CHDSC999
.
CHDSC926  MOVE      "Last Care Type Change after Discharged Date/Time.",WEBTITLE
          CALL      WEBERR00
          MOVE      ADMISSNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      CHDSC999
.
CHDSC930  MOVE      "Cannot Discharge into the Future.  ",WEBTITLE
          CALL      WEBERR00
          MOVE      ADMISSNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      CHDSC999
.
CHDSC935  UNPACK    TDATE,XCENT,XYEAR,XMON,XDAY
          PACK      DISPDTTM,XDAY,SLASH,XMON,SLASH,XCENT,XYEAR,SP1,TTIME
          CLEAR     WEBTITLE
          APPEND    "Discharge Date/Time Must be >= Bed Movement on ",WEBTITLE
          APPEND    DISPDTTM,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ADMISSNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      CHDSC999
.
CHDSC940  MOVE      "Invalid Admission Number.",WEBTITLE
          CALL      WEBERR00
          MOVE      ADMISSNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      CHDSC999
.
CHDSC945  MOVE      "Patient Admission Busy on Terminal.",WEBTITLE
          CALL      WEBERR00
          MOVE      ADMISSNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      CHDSC999
.
CHDSC950  MOVE      "Admission not Discharged.",WEBTITLE
          CALL      WEBERR00
          MOVE      ADMISSNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      CHDSC999
.
CHDSC955  MOVE      "No Discharged Data Available.",WEBTITLE
          CALL      WEBERR00
          MOVE      ADMISSNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      CHDSC999
.
CHDSC960  MOVE      "Master File Data Missing for Patient",WEBTITLE
          CALL      WEBERR00
          MOVE      ADMISSNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      CHDSC999
.
CHDSC965  MOVE      "Visit File Record Missing for Patient",WEBTITLE
          CALL      WEBERR00
CHDSC967  MOVE      ADMISSNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      CHDSC999
.
CHDSC970  CLEAR     WEBTITLE
          APPEND    "Change for more than ",WEBTITLE
          APPEND    CERRDAY,WEBTITLE
          APPEND    " days.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHDSC999
.
CHDSC972  MOVE      "Invoice had been raised.",WEBTITLE
          CALL      WEBERR00
          MOVE      ADMISSNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      CHDSC999
.
CHDSC975  CLEAR     WEBTITLE
          APPEND    "Change not within ",WEBTITLE
          APPEND    CERRDAY,WEBTITLE
          APPEND    " days of discharge.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
CHDSC980  MOVE      ONE,EXIT
          GOTO      CHDSC999
.
CHDSC999  RETURN
+
.***********************************************************
.         Recalculate bed fees
.***********************************************************
.
CFEE0000  CALL      CKCM0000            * Check if casemix funding patient ?
          IF        CMIXFLAG = 1
.
.           Change overnight/daycase rate for casemix if necessary
.
            MOVE      SP10,PTHFBCAT           * Initialise table type
            MATCH     SP6,AFUNDH
            IF        !@EQUAL
              PACK      KEY14,AFUNDH,AFNDTB
              CALL      RDFUND1                 * read health fund file
            ENDIF
.
            MATCH     DDATE,ADATE
            IF        @EQUAL
              CALL      PATDYCAS           * charge casemix daycase rate
            ELSE
              CALL      CMRT0000           * charge casemix overnight rate
            ENDIF
.
          ELSE
.
.            If this is now a day case, then change all rates to day case rates
.
            MATCH     ADATE,DDATE
            GOTO      CFEE1000 IF NOT EQUAL
.
            COMPARE   ONE,CDYCASE
            GOTO      CFEE1000 IF NOT EQUAL
.
            IF        CFEETYP = 0 | CFEETYP = 4 | CFEETYP=9 | CFEETYP=5
              CALL      PATDYCAS
            ENDIF
          ENDIF
          GOTO      CFEE9999
.
.         Check if patient was a daycase before date was changed
.
CFEE1000  MATCH     ADATE,SDDATE
          GOTO      CFEE9999 IF NOT EQUAL
.
          COMPARE   ONE,CDYCASE
          GOTO      CFEE9999 IF NOT EQUAL  * Not doing day case automatic charge
.
.         Patient was a day case before the discharged date changed,
.         therefore change all rates to Inpatients rates again.
.
          PACK      KEY30,AADMNO,SP20,SP10
          CALL      RDSTRAN2
CFEE2000  CALL      RDKTRAN2
          BRANCH    OVRCD,CFEE9999
.
          MATCH     TADMN,AADMNO
          GOTO      CFEE9999 IF NOT EQUAL
.
          PACK      NEWTDATE,TDATE
          MOVE      TWARD,NEWTWARD
          MOVE      TATYPE,NEWTATYP
          MOVE      TRBTYP,NEWTBTYP
          MOVE      TCHSTAT,NEWTCHST
          MOVE      TDEPT,NEWTDEPT
          CALL      BRAT0000
          MOVE      SAVEND,TRBEND
          MOVE      ADDEND,PTTRAEND
          MOVE      SAVPAT,TRATEF
          MOVE      SAVHF,TRATEH
          PACK      TRCDATE,CCC,CYY,CMM,CDD
          REP       " 0",TRCDATE
          CLOCK     TIME,TRCTIME
          MOVE      WBSEUID,PTTRUUID
.
          CALL      UPTRAN2
          GOTO      CFEE2000
.
CFEE9999  RETURN
+
.***********************************************************
.         CHMTR000 - Cancel Transfer/movement routine      *
.                       WHEN UPDATEY=6                     *
. Returns:    EXIT   0 = Ok to continue                    *
.                    1 = Error                             *
.***********************************************************
.
CHMTR000  MOVE      ZERO,LEAVEFLG
          MOVE      ZERO,CANTYPE
          PACK      HDPEQUIV,SP70
          MOVE      ADMISSNO,AADMNO
.
          MOVE      ZERO,SAVTRGID
.
.         Get the admission record to populate HL7 PV1 fields
.
          MOVE      AADMNO,KEY8
          CALL      RDPTMIS1
          BRANCH    OVRCD,CHMTR930
.
.         CAR 92051 - Read PMI record before sending any broadcast messages
.
          MOVE      AURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,CHMTR920
.
          MOVE      AURNO,KEY8
          CALL      RDPMPX21
          BRANCH    OVRCD,CHMTR920
.
          MOVE      ZERO,LASTFLAG
          MOVE      SP70,OLKEY30
          PACK      KEY30,AADMNO,TRANDATE,TRANTIME,TRANWARD,TRANBEDS,SP70
          CALL      RDSTRAN2
          CALL      RDKTRAN2
          IF        OVRCD=1
            MOVE      ONE,LASTFLAG
            GOTO      CHMTR050
          ENDIF
          MATCH     AADMNO,TADMN
          GOTO      CHMTR050 IF EQUAL
.
          MOVE      ONE,LASTFLAG
.
CHMTR050  IF        LASTFLAG=1
            CALL      CNLBT000
            BRANCH    EXIT,CHMTR980
            GOTO      CHMTR900
          ENDIF
.
          PACK      KEY30,AADMNO,TRANDATE,TRANTIME,TRANWARD,TRANBEDS,SP70
          CALL      RDTRAN2
          BRANCH    OVRCD,CHMTR950
.
          MOVE      TWARD,STWARD            * Save ward
          MOVE      STWARD,LSTWARD
          MOVE      TBED,STBED              * Save Bed
          MOVE      STBED,LSTBED
          MOVE      TDATE,STDATE            * Save date
          MOVE      TTIME,STTIME            * Save time
.
          MATCH     "C",TMOVE               * Cancel change
          GOTO      CHMTR100 IF EQUAL
.
          MATCH     "L",TMOVE               * Cancel leave
          GOTO      CHMTR400 IF EQUAL
.
          MATCH     "R",TMOVE               * Return option
          GOTO      CHMTR600 IF EQUAL
.
          GOTO      CHMTR950
.
.        Change Record
.
CHMTR100  COMPARE   "0",CHGCARE             * Check for change in care class
          IF        !@EQUAL
            PACK      KEY24,CHADMN,CHDATE,CHTIME,SP70
            CALL      DECHCO1
            GOTO      CHMTR900
          ENDIF
.
          PACK      KEY30,TADMN,TDATE,TTIME,TWARD,TBED
          CALL      DETRAN2                 * Removing from transfer file
          MOVE      "18 ",ALTTYPE
          MOVE      SP70,ALTOLDVL
          MOVE      SP70,ALTNEWVL
          CALL      WEAL0000                * Write EDWARD alteration record
.
.         If we are cancelling a transfer, then we need to read the previous
.         transfer record to get the ward the patient was in prior to the
.         transfer (for PV1-03) for the broadcast message
.
          PACK      KEY30,AADMNO,STDATE,STTIME,STWARD,STBED
          CALL      RDSTRAN2              * position on deleted record
          CALL      RDPTRAN2              * read previous record
          BRANCH    OVRCD,CHMTR110        * record not found - error
.
. if we are deleting a transfer record and the previous tran record has the same
. ward/bed, we don't need to send an A12 transfer cancellation (probably a 
. change doctor/unit change not a bed transfer)
          MATCH     AADMNO,TADMN          * same admission still ?
          GOTO      CHMTR110 IF NOT EQUAL * no - error
.
          MATCH     TWARD,STWARD
          GOTO      CHMTR105 IF NOT EQUAL
.
          MATCH     TBED,STBED
          GOTO      CHMTR105 IF NOT EQUAL
          GOTO      CHMTR110
.
CHMTR105  PACK      KEY8,AADMNO,SP70
          CALL      RDPTRES1
          IF        OVRCD=1
            CALL      CPTRE100
          ENDIF
.
.         The following broadcast message was removed as we don't want to
.         send an A12 message unless it is the last bed transfer record that
.         is being cancelled.
.         Left the code here for reference, just in case there are any issues.
.
.         CALL      PMIGTNID              * get national id for dgate write
.         MOVE      NMPNUMB,PTNINMPI
.         MOVE      TEN9,HL7TRGID
.         MOVE      SP8,HL7INCLD
.         PROC      DGCLICCT              * b'cast A12/CCT
.
CHMTR110  CALL      CHKDIS00
.
          PACK      KEY30,AADMNO,SP70
          CALL      RDSTRAN2                * Looping through transfer file
CHMTR120  CALL      RDKTRAN2
          BRANCH    OVRCD,CHMTR150
.
          MATCH     AADMNO,TADMN
          GOTO      CHMTR150 IF NOT EQUAL
.
          CALL      PUBFEE00
.         CALL      UPTRN000                * Updating transfer file
          GOTO      CHMTR120
.
CHMTR150  MOVE      "13",HDPEQUIV
          COMPARE   ZERO,AINVPRT            * Checking for invoice printing
          GOTO      CHMTR940 IF NOT EQUAL
          GOTO      CHMTR900
.
.        End Change Record
.
.        Leave Record
.
CHMTR400  CALL      CHKLVE00
          BRANCH    EXIT,CHMTR950
.
          BRANCH    LEAVEFLG,CHMTR500:      * leave is last transfer rec
                             CHMTR540:      * assoc. return is last tran rec
                             CHMTR560       * last tran rec neither leave or ret
.
.         The leave record to be deleted is the last record in pattranf
.         for this visit
.
CHMTR500  CALL      GETLBT00                * Get last ward and bed before leave
          PACK      KEY30,AADMNO,TRANDATE,TRANTIME,TRANWARD,TRANBEDS
          CALL      RDTRAN2
          BRANCH    OVRCD,CHMTR950
.
.         Broadcast transfer cancellation to Datagate BEFORE deleting record
.
          PACK      KEY30,AADMNO,STDATE,STTIME,STWARD,STBED
          CALL      RDTRAN2
.
          MOVE      AURNO,KEY8              * first - get the PMI details
          CALL      RDMAST1
          BRANCH    OVRCD,CHMTR980
.
          MOVE      AURNO,KEY8
          CALL      RDPMPX21
          BRANCH    OVRCD,CHMTR980
.
.         The Leave to be cancelled is the last tran record, so all we need
.         to send is an A22 (return from leave) as there is no cancel leave
.         message in HL7.
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TWENTY,HL7TRGID
          MOVE      TWENTY,SAVTRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICPR                * broadcast A22/CPR
.
          CALL      DELONL00                * Reverse last leave record
          BRANCH    EXIT,CHMTR980
.
          GOTO      CHMTR590
.
.         The leave record to be deleted is the second last record in pattranf
.         for this visit, with the last pattranf record being the associated
.         return record
.
CHMTR540  CALL      GETLDT00                * Get last bed and ward details
.
          PACK      KEY30,DELKEY30
          CALL      RDTRAN2
          BRANCH    OVRCD,CHMTR950
.
          PACK      STDATE,TDATE,SP70
          PACK      STTIME,TTIME,SP70
          PACK      STWARD,TWARD,SP70
          PACK      STBED,TBED,SP70
.
.         Broadcast transfer cancellation to Datagate BEFORE deleting record
.
          PACK      KEY30,AADMNO,STDATE,STTIME,STWARD,STBED
          CALL      RDTRAN2
.
.         The Leave to be cancelled is the second last tran record, so we
.         only need to send a transfer message (A02) if the patient will
.         be in a different ward after the leave record and its associated
.         return record have been deleted.  If the ward is not going to
.         change, then no message is required to be sent at all.
.
          MATCH     TWARD,LSTWARD
          IF        @EQUAL
            MATCH     TBED,LSTBED
            GOTO      CHMTR550 IF EQUAL
          ENDIF
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPTRES1
          IF        OVRCD=1
            CALL      CPTRE100
          ENDIF
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TWENTY1,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICTR                * broadcast A02/CTR
.
CHMTR550  CALL      DELRET00                * Reverse last return record
          BRANCH    EXIT,CHMTR980
.
          CALL      GETLBT00                * Get last ward and bed before leave
          PACK      KEY30,AADMNO,TRANDATE,TRANTIME,TRANWARD,TRANBEDS
          CALL      RDTRAN2
          BRANCH    OVRCD,CHMTR950
          PACK      STDATE,TDATE,SP70
          PACK      STTIME,TTIME,SP70
          PACK      STWARD,TWARD,SP70
          PACK      STBED,TBED,SP70
          MOVE      ONE,LASTFLAG
          CALL      DELONL00                * Reverse last on leave record
          BRANCH    EXIT,CHMTR980
.
          GOTO      CHMTR590
.
.         The leave (and associated return records) is not the last record
.         in the pattranf file for this visit.
.
CHMTR560  CALL      DELREC00                * Remove leave and return record
          BRANCH    EXIT,CHMTR980
.        Updateing the ward and bed of the discharge record
.
          MATCH     ODKEY30,SP70
          IF        !@EQUAL
            CALL      UDDLR000
            MOVE      SP70,ODKEY30
          ENDIF
.
.
CHMTR590
.         CALL      CALBFE00                * Recalculate all bed fees
          MOVE      "13",HDPEQUIV
          GOTO      CHMTR900
.
.        End Leave Record
.
.        Return From Leave
.
CHMTR600  PACK      SAVKEY30,SP70
          MOVE      ZERO,LOOPFLG
.
          PACK      KEY30,AADMNO,Z70        * Work out what ward and bed the
          CALL      RDSTRAN2                * patient should be on leave from
CHMTR650  CALL      RDPTRAN2                * as we are going to remove the
          BRANCH    OVRCD,CHMTR950          * return from leave record
.
          MATCH     AADMNO,TADMN
          GOTO      CHMTR950 IF NOT EQUAL
.
          MATCH     ANSR,TMOVE
          IF        @EQUAL
            COMPARE   ZERO,LOOPFLG
            IF        @EQUAL
              PACK      SAVKEY30,TADMN,TDATE,TTIME,TWARD,TBED
              MOVE      ONE,LOOPFLG
            ENDIF
          ENDIF
.
          MATCH     ANSD,TMOVE
          IF        @EQUAL
            COMPARE   ZERO,LOOPFLG
            IF        @EQUAL
              PACK      ODKEY30,TADMN,TDATE,TTIME,TWARD,TBED
            ENDIF
          ENDIF
.
          MATCH     ANSL,TMOVE
          GOTO      CHMTR650 IF NOT EQUAL
.
          MOVE      TWARD,LSTWARD
          MOVE      TBED,LSTBED
.
          PACK      OLKEY30,TADMN,TDATE,TTIME,TWARD,TBED,SP70
          PACK      KEY30,AADMNO,TRANDATE,TRANTIME,TRANWARD,TRANBEDS
.
          MATCH     KEY30,SAVKEY30         * Can only reverse last return
          GOTO      CHMTR960 IF NOT EQUAL
          CALL      RDTRAN2
          BRANCH    OVRCD,CHMTR950
.
          CALL      DELRET00                * Deleting return record
.
          UNPACK    OLKEY30,DAADMNO,STDATE,STTIME,STWARD,STBED
          MOVE      DAADMNO,AADMNO
          CALL      DELONL00                * Deleting on leave record
          BRANCH    EXIT,CHMTR980
.         Updating the ward and bed of discharge record
          MATCH     ODKEY30,SP70
          IF        !@EQUAL
            CALL      UDDLR000
            MOVE      SP70,ODKEY30
          ENDIF
.
          MOVE      "13",HDPEQUIV
.
CHMTR900  CALL      IPEN0000              * write a record to pending file
.
.         Send A08 after A22 based on parameter       (TSK 0916627)
.
          MATCH     "1",PTCNSRFL
          GOTO      CHMTR910 IF NOT EQUAL
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPTRES1
          IF        OVRCD=1
            CALL      CPTRE100
          ENDIF
.
          IF        SAVTRGID = 20
            MOVE      ZERO,SAVTRGID
            CALL      PMIGTNID              * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      FORTY4,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICAC              * broadcast update A08
          ENDIF
.
CHMTR910  MOVE      ZERO,EXIT
          GOTO      CHMTR999
.
.        End Return Leave
.
CHMTR920  MOVE      "PMI Record not Found",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHMTR999
.
CHMTR930  MOVE      "Admission Record not Found",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHMTR999
.
CHMTR940  MOVE      "Invoice has been printed,removing movements",ERR1
          MOVE      " will not change the invoice rates",ERR2
          PACK      WEBTITLE,ERR1,ERR2
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHMTR999
.
CHMTR950  MOVE      "Invalid Transfer Record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHMTR999
.
CHMTR960  MOVE      "Invalid option - must be the last return on file",WEBTITLE
          CALL      WEBERR00
CHMTR980  MOVE      ONE,EXIT
          GOTO      CHMTR999
.
CHMTR999  RETURN
+
.--------------------------------------------------------------------------
.         CHKDIS00 - Check if next record is a discharge or on leave record
.--------------------------------------------------------------------------
.
CHKDIS00  MOVE      SP70,PREVWARD
          MOVE      SP70,PREVBED
          MOVE      SP70,PREVBTYP
          MOVE      SP70,PREVDOC
          MOVE      SP70,PREVUNIT
.
          PACK      KEY30,AADMNO,TRANDATE,TRANTIME,TRANWARD,TRANBEDS,SP70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,CHKDIS99
.
          MATCH     AADMNO,TADMN
          GOTO      CHKDIS99 IF NOT EQUAL
.
          MOVE      TWARD,PREVWARD
          MOVE      TBED,PREVBED
          MOVE      TRBTYP,PREVBTYP
          MOVE      TADOCT,PREVDOC
          MOVE      TDEPT,PREVUNIT
.
          PACK      KEY30,AADMNO,TRANDATE,TRANTIME,TRANWARD,TRANBEDS,SP70
          CALL      RDSTRAN2
          CALL      RDKTRAN2
          BRANCH    OVRCD,CHKDIS99
.
          MATCH     AADMNO,TADMN
          GOTO      CHKDIS99 IF NOT EQUAL
.
          MATCH     ANSD,TMOVE
          GOTO      CHKDIS10 IF EQUAL
.
          MATCH     ANSL,TMOVE
          GOTO      CHKDIS05 IF EQUAL
.
          GOTO      CHKDIS99
.
CHKDIS05  CALL      AWBD0000          * deleting a tran record before Leave rec.
.
CHKDIS10  PACK      SAVKEY30,TADMN,TDATE,TTIME,TWARD,TBED,SP70
.
.  if deleting a change record directly before the discharge or on leave
.  record, the record must be updated with the previous records ward and bed
.
.          PACK      KEY30,TADMN,TDATE,TTIME,PREVWARD,PREVBED,SP70
.          CALL      RDATRAN2
.          COMPARE   ZERO,OVRCD
.          GOTO      CHKDIS99 IF EQUAL
.
          PACK      KEY30,SAVKEY30
          CALL      RDTRAN2
          BRANCH    OVRCD,CHKDIS99
.
          MOVE      PREVWARD,TWARD
          MOVE      PREVBED,TBED
          MOVE      PREVBTYP,TRBTYP
          MOVE      PREVDOC,TADOCT
          MOVE      PREVUNIT,TDEPT
.
          PACK      TRCDATE,CCC,CYY,CMM,CDD
          REP       " 0",TRCDATE
          CLOCK     TIME,TRCTIME
          MOVE      WBSEUID,PTTRUUID
.
          CALL      UPTRAN2
.
.
.  update ward type on discharge file
.
CHKDIS20  PACK      KEY8,AADMNO,SP70
          CALL      RDDSCH1
          BRANCH    OVRCD,CHKDIS30
.
          MATCH     AADMNO,DADMNO
          GOTO      CHKDIS30 IF NOT EQUAL
.
          MOVE      TWARD,PTDSDWRD
          CALL      UPDSCH1                 * Updating discharge file
.
.
. update doctor code and unit on admission file
.
CHKDIS30  PACK      KEY8,TADMN,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,CHKDIS40
.
          MATCH     TADMN,AADMNO
          GOTO      CHKDIS40 IF NOT EQUAL
.
          MATCH     PREVUNIT,ACLSSFT
          IF        !@EQUAL
            CALL      CHGNZ000           * acare changed - update nmds
          ENDIF
.
          MATCH     PREVDOC,ADOCTA
          IF        !@EQUAL
            CALL      CHGNZ000           * acare changed - update nmds
          ENDIF
.
          MOVE      PREVDOC,ADOCTA
          MOVE      PREVUNIT,ACLSSFT
          CALL      UPMISS1
.
.
. update doctor code to visit file
.
CHKDIS40  PACK      KEY8,TADMN,SP70
          CALL      RDVISA1
          BRANCH    OVRCD,CHKDIS99
.
          MATCH     TADMN,PVIBILL
          GOTO      CHKDIS99 IF NOT EQUAL
.
          MOVE      PREVDOC,PVIDOCT
          CALL      UPVISA1
.
CHKDIS99  RETURN
+
.--------------------------------------------------------------------------
.  Updating Ward and bed of patient on discharge when on leave/return 
.  patient are deleted 
.--------------------------------------------------------------------------
UDDLR000  MOVE      SP70,PREVWARD
          MOVE      SP70,PREVBED
          MOVE      SP70,PREVBTYP
          MOVE      SP70,PREVDOC
          MOVE      SP70,PREVUNIT
.
          PACK      KEY30,ODKEY30
          CALL      RDSTRAN2 
UDDLR100  CALL      RDPTRAN2
          BRANCH    OVRCD,UDDLR999
.
          MATCH     AADMNO,TADMN
          GOTO      CHKDIS99 IF NOT EQUAL
.        
          MATCH     ANSD,TMOVE
          GOTO      UDDLR100 IF EQUAL
. Updating the record with ward and bed
          MOVE      TWARD,PREVWARD
          MOVE      TBED,PREVBED
          MOVE      TRBTYP,PREVBTYP
          MOVE      TADOCT,PREVDOC
          MOVE      TDEPT,PREVUNIT
.
          PACK      KEY30,ODKEY30
          CALL      RDTRAN2
          BRANCH    OVRCD,CHKDIS99
.
          MOVE      PREVWARD,TWARD
          MOVE      PREVBED,TBED
          MOVE      PREVBTYP,TRBTYP
          MOVE      PREVDOC,TADOCT
          MOVE      PREVUNIT,TDEPT
.
          PACK      TRCDATE,CCC,CYY,CMM,CDD
          REP       " 0",TRCDATE
          CLOCK     TIME,TRCTIME
          MOVE      WBSEUID,PTTRUUID
.
          CALL      UPTRAN2
.
.  update ward type on discharge file
.
UDDLR200  PACK      KEY8,AADMNO,SP70
          CALL      RDDSCH1
          BRANCH    OVRCD,UDDLR300
.
          MATCH     AADMNO,DADMNO
          GOTO      UDDLR300 IF NOT EQUAL
.
          MOVE      TWARD,PTDSDWRD
          CALL      UPDSCH1                 * Updating discharge file
.update doctor code and unit on admission file
UDDLR300  PACK      KEY8,TADMN,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,UDDLR400
.
          MATCH     TADMN,AADMNO
          GOTO      UDDLR400 IF NOT EQUAL
.
          MATCH     PREVUNIT,ACLSSFT
          IF        !@EQUAL
            CALL      CHGNZ000           * acare changed - update nmds
          ENDIF
.
          MATCH     PREVDOC,ADOCTA
          IF        !@EQUAL
            CALL      CHGNZ000           * acare changed - update nmds
          ENDIF
.
          MOVE      PREVDOC,ADOCTA
          MOVE      PREVUNIT,ACLSSFT
          CALL      UPMISS1
. update doctor code to visit file
.
UDDLR400  PACK      KEY8,TADMN,SP70
          CALL      RDVISA1
          BRANCH    OVRCD,UDDLR999
.
          MATCH     TADMN,PVIBILL
          GOTO      UDDLR999 IF NOT EQUAL
.
          MOVE      PREVDOC,PVIDOCT
          CALL      UPVISA1 
.
UDDLR999  RETURN
+
.--------------------------------------------------------------------------
.  deleting a change record before on leave record, admission ward/bed and
.  leave ward/bed must be updated
.--------------------------------------------------------------------------
AWBD0000  PACK      KEY14,TWARD,TBED,AADMNO
          CALL      RDONLV1
          IF        OVRCD=0
            MOVE      PREVWARD,OWARD
            MOVE      PREVBED,OBED
            CALL      UPONLV1
          ENDIF
.
.         Only update admission ward/bed if this is the current leave
.
          PACK      KEY8,TADMN,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,AWBD9999
.
          MATCH     "4",DASTAT
          GOTO      AWBD9999 IF NOT EQUAL     * currently not on leave
.
.         Check if this is the last leave record
.
          PACK      SAVKEY30,TADMN,TDATE,TTIME,TWARD,TBED,SP70
.
          CALL      RDKTRAN2
          BRANCH    OVRCD,AWBD1000
.
          MATCH     AADMNO,TADMN
          GOTO      AWBD8000 IF EQUAL
.
AWBD1000  MOVE      PREVWARD,AWARD
          MOVE      PREVBED,ABED
          CALL      UPMISS1
.
AWBD8000  MOVE      SAVKEY30,KEY30      * reposition
          CALL      RDTRAN2
.
AWBD9999  RETURN
+
.-----------------------------------------------------------
. Check Admission Date Does Not Overlap the Previous Admission.
.-----------------------------------------------------------
.
CHAD0000  BRANCH    STATADMN,CHAD9999
          BRANCH    STATDSCH,CHAD9999
.
          MOVE      SP70,DIM3
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,CHAD9999
          CALL      RDPMVX11
          BRANCH    OVRCD,CHAD9999
          MOVE      PMVXMHOS,DIM3
.
          MOVE      AADMNO,SAVADMNO
          PACK      KEY24,AURNO,Z70
          CALL      RDSVISA2
CHAD1000  CALL      RDPVISA2
          BRANCH    OVRCD,CHAD9800
.
          MATCH     AURNO,PVIURNO             * same ur?
          GOTO      CHAD9800 IF NOT EQUAL     * No
.
          COMPARE   THREE,PVITYPE             * Inpatient?
          GOTO      CHAD1000 IF NOT EQUAL     * No
.
          IF        ASTAT=1|ASTAT=5
            GOTO      CHAD1000
          ENDIF
.
          MATCH     SAVADMNO,DPVIBILL         * same admission no?
          GOTO      CHAD1000 IF EQUAL
.
          MOVE      PVIBILL,KEY8
          CALL      RDPMVX11
          BRANCH    OVRCD,CHAD1000
          MATCH     SP70,DIM3
          IF        !@EQUAL
            MATCH     DIM3,PMVXMHOS
            GOTO      CHAD1000 IF NOT EQUAL
          ENDIF
.
. ------- display a warning message -----------------------------------------
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=WARNING>":
                    "Admission may overlap other visits.":
                    "</RETURN_VALUE>"
.
. ------- reposition/reread data ------------------------------------------
.
CHAD9800  MOVE      SP8,DDATE
          PACK      KEY8,AADMNO,SP10
          CALL      RDDSCH1
.
          MOVE      AADMNO,KEY8
          CALL      RDVISA1
.
CHAD9999  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    " OK ":
                    "</RETURN_VALUE>"
          RETURN
+
.-----------------------------------------------------------
. Subroutine to calculate the difference between WDATE1 and WDATE2
.-----------------------------------------------------------
.
DIFFDY00  MOVE      ONE,COUNT
.
          MATCH     WDATE1,WDATE2
          GOTO      DIFFDY50 IF NOT LESS
.
          MOVE      SEQ,COUNT             * Difference negative
.
          MOVE      WDATE1,XDATE
          MOVE      WDATE2,WDATE1
          MOVE      XDATE,WDATE2
.
DIFFDY50  DAYSEP    WDATE1,WDATE2,NBRDAYS
          MULT      COUNT,NBRDAYS
.
DIFFDY99  RETURN
+
.-----------------------------------------------------------
. CLDSC000 - Cancel Discharge (un-discharge by admission number)
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.-----------------------------------------------------------
.
CLDSC000  MOVE      ZERO,STBYFLAG
          MOVE      ADMISSNO,AADMNO
.
.        Check if some one is accessing this patient
.
          MOVE      AADMNO,KEY8
          CALL      RLPTMIS1                     * admission record found ?
          BRANCH    OVRCD,CLDSC900:              * no
                          CLDSC910               * yes - already locked
.
.        Check that this is the patient desired
.
          COMPARE   THREE,ASTAT
          IF        !@EQUAL
            IF        UPDATETY=9
              GOTO      CLDSC999
            ENDIF
            GOTO      CLDSC920
          ENDIF
.
          MOVE      AADMNO,KEY8
          CALL      RDDSCH1
          BRANCH    OVRCD,CLDSC930
.
          MOVE      DDATE,TRANDATE                                    *I-241939
          MOVE      DTIME,TRANTIME
          MOVE      DDATE,TEMPDATE     * store discharge date for CLRVEN00
          MOVE      DTIME,TEMPTIME     * store discharge time for CLRVEN00
          CALL      EPTST000                * check for Episode Coding
          BRANCH    EXIT,CLDSC999
.
          PACK      KEY8,AURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,CLDSC905
          MOVE      PCEASE,SAVPCEAS       * Save Deceased indicator
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
.        Check if this U/R already has a current admission
.
          MOVE      AADMNO,SAVADMN
          MOVE      AURNO,PURNO
          MOVE      PURNO,PVIURNO
.
          BRANCH    CONTMULT,CLDSC020
.
          PACK      KEY24,PVIURNO,SP20
          CALL      RDSVISA2
CLDSC010  CALL      RDKVISA2
          BRANCH    OVRCD,CLDSC020
.
          MATCH     PURNO,PVIURNO
          GOTO      CLDSC020 IF NOT EQUAL
.
.        Check if INPATIENT
.
          COMPARE   THREE,PVITYPE
          GOTO      CLDSC010 IF NOT EQUAL
.
.        Read the admission file
.
          MOVE      PVIBILL,AADMNO
          MOVE      AADMNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,CLDSC020
.
          BRANCH    ASTAT,CLDSC010,CLDSC940,CLDSC010,CLDSC015,CLDSC010
          GOTO      CLDSC010
.
CLDSC015  CALL      INTL0000
          BRANCH    EXIT,CLDSC020
          GOTO      CLDSC940
.
CLDSC020  MOVE      SAVADMN,KEY8             * restore entered admission no.
          CALL      RDMISS1
.
          MOVE      AADMNO,KEY8
          CALL      RDPMVX11
.
          COMPARE   ZERO,AINVPRT
          GOTO      CLDSC028 IF EQUAL        * Not yet invoiced
.
          BRANCH    PTCNDISI,CLDSC028        * Allow to un-discharge
.
.         Check if invoice had been printed upto discharged.
.
          MATCH     ALACDTE,DDATE
          GOTO      CLDSC028 IF NOT EQUAL    * Not invoiced up to disc.date
.
          CALL      CINV0000        * Check if the invoice amount is balanced
          BRANCH    EXIT,CLDSC902
.
CLDSC028  MOVE      ZERO,F1
....                                        * PTCNUCEP no longer used *D-240107
....C028  COMPARE   ONE,PTCNUCEP            * Using consultant episodes ?
....      GOTO      CLDSC030 IF NOT EQUAL   * No, continue with undischarge
....
....      Check that this episode has not had disease coding
....
....      PACK      KEY30,AADMNO,DDATE,DTIME,SP6
....      CALL      RDSTRAN2
....      CALL      RDKTRAN2
....      BRANCH    OVRCD,CLDSC950
....
....      MATCH     TADMN,AADMNO
....      GOTO      CLDSC950 IF NOT EQUAL
....
....      CMATCH    "D",TMOVE
....      GOTO      CLDSC950 IF NOT EQUAL
....
....      CALL      CEPC0000                * Check current episode for coding
....      BRANCH    EXIT,CLDSC995
.                                           *                   * end *D-240107
.
.        Determine which Ward/Bed this patient is to go into
.
CLDSC030  UNPACK    DDATE,XCENT,XYEAR,XMON,XDAY
          PACK      KEY30,AADMNO,DDATE,DTIME,SP30
          CALL      RDSTRAN2
          CALL      RDKTRAN2
          BRANCH    OVRCD,CLDSC950
.
          MATCH     TADMN,AADMNO
          GOTO      CLDSC950 IF NOT EQUAL
.
          CMATCH    "D",TMOVE
          GOTO      CLDSC950 IF NOT EQUAL
.
. Check if patient was discharged whilst on leave
.
          PACK      SKEY30,TADMN,TDATE,TTIME,TWARD,TBED
          MOVE      ZERO,ONLEAVE
          MOVE      TMOVE,SAVTMOVE           * save variables
          MOVE      TTIME,SAVTTIME
          MOVE      TDATE,SAVTDATE
          CALL      TSET0000                 * set TTIME & TDATE for this record
          MOVE      TTIME,SAVTTIME
          MOVE      TDATE,SAVTDATE
          CALL      RDPTRAN2
          MATCH     "R",TMOVE                * return from leave record?
          GOTO      CLDSC040 IF NOT EQUAL
.
          MATCH     SAVTTIME,TTIME
          GOTO      CLDSC040 IF NOT EQUAL
          MATCH     SAVTDATE,TDATE
          GOTO      CLDSC040 IF NOT EQUAL
          MOVE      ONE,ONLEAVE              * pat. was on leave when discharged
.
CLDSC040  MOVE      SKEY30,KEY30
          CALL      RDTRAN2                  * re-read "D" record
          BRANCH    ONLEAVE,CLDSC050         *branch if on leave when discharged
.
.        Check that Ward and bed have not been taken
.
          PACK      KEY6,TWARD,TBED
          CALL      RDWARD1
          BRANCH    OVRCD,CLDSC980
.
          MATCH     ZEROVISN,WADMNO
          IF        !@EQUAL
            MATCH     ZEROVISN,WSTBY
            GOTO      CLDSC050 IF EQUAL
          ELSE
            GOTO      CLDSC050
          ENDIF
.
          MATCH     AADMNO,WADMNO
          GOTO      CLDSC990 IF NOT EQUAL
.
. check the pataxe file to determine whether the letter of cert. has been run
.
CLDSC050  IF        PTCNAXEU = 1
            PACK      KEY8,AADMNO,SP10
            CALL      RDPTAXE1
            BRANCH    OVRCD,CLDSC970
.
            IF        PTAXDAMI > 2
              GOTO      CLDSC960
            ENDIF
.
            MOVE      ZERO,PTAXDAMI          * not processed
            CALL      UPPTAXE1
          ENDIF
.
          MOVE      AADMNO,KEY8
          CALL      RDDSCH1
          BRANCH    OVRCD,CLDSC060
.
          PACK      KEY5,ANSD,ANSD,DDEST
          CALL      RDCODE1
          BRANCH    OVRCD,CLDSC060
.
.        If discharged as deceased return deceased indicator to alive
.
          MATCH     ANSD,TCINDC1
          IF        @EQUAL
            MOVE      PURNO,KEY8
            CALL      RDMAST1
            IF        OVRCD=0
              MOVE      PURNO,KEY8
              CALL      RDPMPX21
              IF        OVRCD=1
                CALL      CLPMSPX2
              ENDIF
            ENDIF
.
            MOVE      "0",PCEASE
            MOVE      SP70,PDECDTE
            MOVE      SP70,PMPXDETY
            CALL      UPMAST1
            CALL      UUPTMAS1
            CALL      UPPMPX21
.
            PACK      KEY8,AADMNO,SP70
            CALL      RDPTRES1
            IF        OVRCD=1
              CALL      CPTRE100
            ELSE
              IF        SAVPCEAS=1
                CALL      UPRA0000            * Update PRFA if necessary
                CALL      UPPTRES1
              ENDIF
            ENDIF
.
            MATCH     "1",PTCNMORG
            IF        @EQUAL
              PACK     KEY8,AADMNO,SP70       * Delete morgue record if no
              CALL     RDPMMOR1               * collection date
              IF       OVRCD=0
                MATCH    SP70,PMMRACDT
                IF       @EQUAL
                  CALL     DEPMMOR1
                ENDIF
              ENDIF
            ENDIF
.
            CALL      PMIGTNID                 * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      TWENTY2,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICUP                 * write PMI changes     *C-90222
          ENDIF
.
CLDSC060  BRANCH    ONLEAVE,CLDSC090      * Dont do if on leave
.
          MATCH     SP3,TBED
          GOTO      CLDSC080 IF EQUAL
.
          PACK      KEY6,TWARD,TBED
          CALL      RDWARD1
.
          MATCH     ZEROVISN,WADMNO
          GOTO      CLDSC070 IF EQUAL
.
          MATCH     ZEROVISN,WSTBY
          IF        @EQUAL
            MOVE      AADMNO,WSTBY
            MOVE      ONE,STBYFLAG
            GOTO      CLDSC075
          ENDIF
.
          MATCH     AADMNO,WADMNO
          GOTO      CLDSC990 IF NOT EQUAL
.
CLDSC070  MOVE      AADMNO,WADMNO
CLDSC075  MOVE      ZERO,WPLUR
          CALL      UPWARD1
.
          GOTO      CLDSC090
.
.        Add a No-Bed record
.
CLDSC080  MOVE      APLUR,NBPLUR
          MOVE      SP3,NBROOM
          PACK      KEY13,TWARD,AADMNO,NBPLUR
          CALL      RANOBE1
          IF        OVRCD=1
            CALL      WRNOBE1
          ENDIF
.
CLDSC090  PACK      SKEY30,TADMN,TDATE,TTIME,TWARD,TBED
.
.------ update the patdayaf file if appropriate ------
.
          MOVE      ONE,OPTION
          CALL      PATD0000                  * update the patdayaf file
.
.------ update or delete a PATDADFD record if appropriate (29/05/90) -------
.
          BRANCH    PTCNUADT,CLDSC100         * PATDADFD control parameter is on
          GOTO      CLDSC120
.
CLDSC100  PACK      KEY8,AADMNO
          CALL      RDPTDAD1                 * read PATDADFD record
          BRANCH    OVRCD,CLDSC120           * record not found
.
          MATCH     SP5,PTDAADTS             * Adm Transfer Source = spaces ?
          GOTO      CLDSC110 IF EQUAL        * yes
.
          MOVE      SP5,PTDADCTS             * set Dsch Transfer Source to blank
          CALL      UPPTDAD1                 * update the PATDADFD record
          GOTO      CLDSC120
.
CLDSC110  CALL      DEPTDAD1                 * delete PATDADFD record
.
.         Broadcast undischarge to Datagate BEFORE deleting the transfer
.         file record
.
CLDSC120  PACK      KEY8,AADMNO,SP70
          CALL      RDPTRES1
          IF        OVRCD=1
            CALL      CPTRE100
          ENDIF
.
.         Resinstated the code below for TSK 0814288 and commented out
.         the trigger (with the same HL7TRGID value), which had replaced it.
.         The discharge record and the last transfer record need to have been
.         read when the A13 is triggered.
.
          CALL      PMIGTNID                 * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TWENTY3,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICCD                 * send cancel discharge   *C-90222
.                                              to Datagate
.
.        Delete Discharge Transfer file record
.
          MOVE      TWARD,AWARD
          MOVE      TBED,ABED
          MOVE      SKEY30,KEY30
          CALL      DETRAN2
.
.------   check if previous patient was on leave when discharged  ---
.
          IF        ONLEAVE = 1
            MOVE      SKEY30,KEY30
            CALL      RDSTRAN2
            CALL      RDPTRAN2
            PACK      KEY30,TADMN,TDATE,TTIME,TWARD,TBED
            CALL      DETRAN2                  * delete record
.
.  Write on leave record for this patient
.
            MOVE      TWARD,OWARD
            MOVE      TBED,OBED
            MOVE      TADMN,OADMNO
            PACK      KEY14,OWARD,OBED,OADMNO
            CALL      RDONLV1
            IF        OVRCD = 1
              MOVE      SP3,OROOM
              MOVE      SP8,OERDATE
              MOVE      SP8,OERTIME
              CALL      WRONLV1
            ENDIF
          ENDIF
.
.        Fix up the Ward Usage Statistics
.
CLDSC130  MOVE      TDATE,CPTDATE
          REP       " 0",CPTDATE
          CALL      GPERD                * Get the financial period for date
          BRANCH    EXIT,CLDSC901        * Date not in period file
.
          PACK      KEY9,TWARD,DRGYR,DRGNUM
          MOVE      FOUR,COUNT              * Number of Discharges
          MOVE      SEQ,FORM2
.
.        Delete Discharge record
.
          MOVE      DADMNO,KEY8
          CALL      DEDSCH1
.
          MOVE      TWO,PTUNTYPE
          MOVE      DDATE,PTUNODTE
          MOVE      DTIME,PTUNOTTM
          CALL      DISHCS00
.
.         Update last discharge date
.
          MOVE      SP70,PLDDATE
          PACK      KEY24,AURNO,Z70      * seach for the last discharge date
          CALL      RDSDSCH3
          CALL      RDPDSCH3             * hunt backwards
          IF        OVRCD = 0
            MATCH     AURNO,DURNO
            IF        @EQUAL
              MOVE       DDATE,PLDDATE
            ENDIF
          ENDIF
          CALL       UPMAST1
.
.        Update Admission record
.
          IF        STBYFLAG=1
            MOVE      SP70,AWARD
            MOVE      SP70,ABED
          ENDIF
.
          IF        ONLEAVE=1
            MOVE      FOUR,ASTAT
          ELSE
            MOVE      TWO,ASTAT
          ENDIF
          CALL      UPLMISS1
.
          CALL      WRCPAT00                * I CAR 23608
.
          CALL      MEHA0000                * process MEH data
          BRANCH    EXIT,CLDSC995
.
.        Fix the Waiting Lists File if Needed
.
          COMPARE   ONE,CTHETR
          IF        @EQUAL
            CALL      THET0000
            IF        WAITFLAG=1
              CALL      DELNBR00
            ENDIF
            GOTO      CLDSC160
          ENDIF
.
          PACK      KEY8,AADMNO
          CALL      RDBKREC1
          BRANCH    OVRCD,CLDSC160
.
          MOVE      THREE,BKRESTAT
          CALL      UPBKREC1
.
          PACK      KEY19,BKREURNO,BKREPROC,BKRECNT
          CALL      RDTREA1
          BRANCH    OVRCD,CLDSC160
.
          OPEN      WATTX1A1,"wattx1af"
          PACK      KEY19,WMURNO,WMCODE,WMCNT,SP70
          CALL      RDWTTX11
          IF        OVRCD=1
            CALL      CLWATTX1
          ENDIF
          CLOSE     WATTX1A1
.
. if the procedure is not performed, must delete the new W/L record made and
. return the original back to admitted
.
          IF        WMSTAT = 8
            OPEN      WATPNPA1,"watpnpaf";
            MOVE      WMBOOK,KEY8
            CALL      RDWTPNP1
            IF        OVRCD = ZERO
              PACK      KEY19,WMURNO,WMCODE,WTNPNCNT
              CALL      DETREA1
            ENDIF
            CLOSE     WATPNPA1
          ENDIF
.
          MOVE      FOUR,WMSTAT
          CALL      UPTREA1
          CALL      DELNBR00
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      THIRTY7,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLIUWL                * HL7 - Update Waiting List Entry
.
.        Put the patient into the Inpatient Location file
.
CLDSC160  MOVE      PTMASNAM,LSNAME
          MOVE      PMPXFNAM,LGNAME
          MOVE      AADMNO,LADMNO
          MOVE      SP70,LPCONDC
          MOVE      SP70,LPCONDD
          MOVE      SP70,LPCDATE
          MOVE      SP70,LPCTIME
          MOVE      SP70,LPCONAM
          MOVE      AURNO,LURNO
          PACK      KEY88,PTMASNAM,PMPXFNAM,AADMNO
          CALL      RDALOCA1
          IF        OVRCD=1
            CALL      WRLOCA1
          ENDIF
.
.        Update the Fee's Raised Indicator
.
          MOVE      DDATE,TDATE
          CALL      UPDCFR00
.
.        Check if a record exists in PATIPEFD, and if not, add one
.
. If Using the Invoice Pending File
.
          IF        PTCNIPEN = 0
            IF        CHOSTYP=1 & CFEETYP=0
              MOVE      TWO,PTIPRSTA                * Undischarge
              MOVE      SAVTDATE,PENDSDAT           * as at date
              CALL      CINVP000                    * Check for tobe invoiced
              GOTO      CLDSC165
            ENDIF
.
            MOVE      AADMNO,IPADMNO
            MOVE      THREE,IPSYSTM
            MOVE      SP70,IPSITE
.
            MOVE      SP70,PENDHOSP
            IF        IBCNMHOS=1
              MOVE      PMVXMHOS,PENDHOSP           * Hospital ID
            ENDIF
            MOVE      " 3",PENDSYST                 * Inpatient
.
            MOVE      SAVTDATE,PENDSDAT             * as at date
            MOVE      ADATE,PENDADAT                * admission date
            MOVE      SP70,PENDDDAT
            IF        ASTAT=3
              CALL      RDDSCH1
              IF        OVRCD=0
                MOVE      DDATE,PENDDDAT            * discharged date
              ENDIF
            ENDIF
            MOVE      AFUNDH,PENDFUND
            MOVE      ACLAIM,PENDCLAM
            CALL      IPRH0000
.
            MOVE      TWO,PTIPRSTA                  * Undischarge
            MOVE      SP70,PTIPSVAR
.
            PACK      KEY8,IPADMNO,SP70
            CALL      RAIPEN1
            IF        OVRCD=1
              CALL      WRIPEN1
            ELSE
              CALL      UPIPEN1
            ENDIF
          ENDIF
.
.        Remove Discharge FIM details if it exists    
.
CLDSC165  IF        DSCFIMEX <> 1
            GOTO      CLDSC170
          ENDIF
.
          CALL      RMDSC000
.
.        Write a delete record to the Audit File if wanted
.
CLDSC170  BRANCH    CAUDB,CLDSC180
          MOVE      "D",ACTION
          MOVE      DADMNO,SDADMNO               * added for V5.01.125
          CALL      WRBAUD
.
.        Fix up the Admission Discharge statistics
.
CLDSC180  MOVE      DDATE,CPTDATE
          REP       " 0",CPTDATE
          CALL      GPERD                * Get the financial period for date
          BRANCH    EXIT,CLDSC901        * Date not in period file
.
          MOVE      DRGYR,SADYEAR
          MOVE      DRGNUM,FORM2
.
          MATCH     SP3,DDEST
          GOTO      CLDSC190 IF NOT EQUAL
.
          MOVE      "UNK",DDEST
CLDSC190  PACK      KEY8,SADYEAR,CODED,DDEST
          CALL      CANSTA00
.
.        Update the bed management table
.
          PACK      TRANDATE,ADATE
          PACK      TRANTIME,ATIME
          MOVE      ASTAY,STAYDAYS
          PACK      TRNTOWRD,AWARD
          PACK      TRNTOBED,ABED
.
          IF        ASTAT=2
            PACK      KEY8,AADMNO,SP70
            CALL      RDPMWOR1
            IF        OVRCD=1
              CALL      CLPMWO00               * Use the expected discharge
            ENDIF                              * date if a current admission
.                                              * instead of TRANDATE plus
            MATCH     SP70,PMWOEDAT            * ASTAY
            IF        !@EQUAL
              DAYSEP    TRANDATE,PMWOEDAT,STAYDAYS
            ENDIF
          ENDIF
.
          CALL      UPPBMN00
.
.         Get the last transfer record for the patient
.
          PACK      KEY30,AADMNO,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,CLDSC200
.
          MATCH     TADMN,AADMNO
          GOTO      CLDSC200 IF NOT EQUAL
.
.         Check if the patient was a day case (before undischarged)
.
          MATCH     DDATE,ADATE
          GOTO      CLDSC200 IF NOT EQUAL
.
.         Yes. -  Change the fee back to use the inpatient rate
.
          MOVE      ADATE,NEWTDATE
          MOVE      TWARD,NEWTWARD
          MOVE      TATYPE,NEWTATYP
          MOVE      TRBTYP,NEWTBTYP
          MOVE      TCHSTAT,NEWTCHST
          MOVE      TDEPT,NEWTDEPT
          CALL      BRAT0000
          MOVE      SAVEND,TRBEND
          MOVE      ADDEND,PTTRAEND
          MOVE      SAVPAT,TRATEF
          MOVE      SAVHF,TRATEH
          MOVE      ADISC,TDISC
          MOVE      ZERO,TALLW
          MOVE      SAVEXTR,TEXTRA
          MOVE      AUSR2,TCHSTAT
          PACK      TRCDATE,CCC,CYY,CMM,CDD
          REP       " 0",TRCDATE
          CLOCK     TIME,TRCTIME
          MOVE      WBSEUID,PTTRUUID
.
          CALL      UPTRAN2
.
.         Commented out the code below for TSK 0814288.  Not sure
.         why it was moved in the first place, although it looks as though
.         it may have been associated with CAR 267469.  The original trigger
.         has now been reinstated.
.
CLDSC200  
.         CALL      PMIGTNID                 * get national id for dgate write
.         MOVE      NMPNUMB,PTNINMPI
.         MOVE      TWENTY3,HL7TRGID
.         MOVE      SP8,HL7INCLD
.         PROC      DGCLICCD                 * send cancel discharge   *C-90222
.
          MOVE      "Patient Undischarged",WEBTITLE
          OPEN      MRTPDSA1,"mrtpdsaf"
          PACK      KEY8,TADMN,SP70
          CALL      DEMRPDS1
          CLOSE     MRTPDSA1
          CALL      UUPTMIS1
.
          CALL      CLRVEN00      * Clear Ventilation End Date/Time & Hours
.
          MOVE      ZERO,EXIT
          GOTO      CLDSC999
.
CLDSC900  MOVE      "Invalid Admission Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CLDSC999
.
CLDSC901  MOVE      "Date not found in Period file",WEBTITLE
          CALL      WEBERR00
          MOVE      AADMNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      CLDSC999
.
CLDSC902  MOVE      "Invoice had been raised.",WEBTITLE
          CALL      WEBERR00
          MOVE      AADMNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      CLDSC999
.
CLDSC905  MOVE      "Invalid UR Number",WEBTITLE
          CALL      WEBERR00
          MOVE      AADMNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      CLDSC999
.
CLDSC910  MOVE      "Patient Admission Busy on Terminal",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CLDSC999
.
CLDSC920  MOVE      "Admission not Discharged",WEBTITLE
          CALL      WEBERR00
          MOVE      AADMNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      CLDSC999
.
CLDSC930  MOVE      "No Discharge Data Available",WEBTITLE
          CALL      WEBERR00
          MOVE      AADMNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      CLDSC999
.
CLDSC940  MOVE      "Patient Currently Admitted",WEBTITLE
          CALL      WEBERR00
          MOVE      AADMNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      CLDSC999
.
CLDSC950  MOVE      "Discharge Transfer Record not Found",WEBTITLE
          CALL      WEBERR00
          MOVE      AADMNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      CLDSC999
.
CLDSC960  MOVE      "Cannot Undischarge - Certification has been done",WEBTITLE
          CALL      WEBERR00
          MOVE      AADMNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      CLDSC999
.
CLDSC970  MOVE      "Pataxeaf Record Missing",WEBTITLE
          CALL      WEBERR00
          MOVE      AADMNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      CLDSC999
.
CLDSC980  MOVE      "Ward/Bed not Found",WEBTITLE
          CALL      WEBERR00
          MOVE      AADMNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      CLDSC999
.
CLDSC990  CLEAR     WEBTITLE
          APPEND    "Error: Ward - ",WEBTITLE
          PACK      KEY6,TWARD,SP70
          CALL      RDWARD1
          IF        OVRCD<>1
            STRIP     PTWDSDES
            APPEND    PTWDSDES,WEBTITLE
          ELSE
            APPEND    TWARD,WEBTITLE
          ENDIF
          MATCH     SP70,TBED
          IF        !@EQUAL
            APPEND    "/Bed - ",WEBTITLE
            PACK      KEY6,TWARD,TBED,SP70
            CALL      RDWARD1
            IF        OVRCD<>1
              STRIP     PTWDSDES
              APPEND    PTWDSDES,WEBTITLE
            ELSE
              APPEND    TBED,WEBTITLE
            ENDIF
          ENDIF
          APPEND    " has been taken, unable to undischarge",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
CLDSC995  MOVE      AADMNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
.
CLDSC999  RETURN
+
.------------------------------------------------------------------------------
.         Check intended day and on leave to allow overlap
.------------------------------------------------------------------------------
INTL0000  MOVE      ZERO,EXIT
. if currently on leave and leave type ind 3=A or M, allow multiple admissions
          COMPARE   FOUR,ASTAT               * On leave - check type of leave
          GOTO      INTL9999 IF NOT EQUAL
.
          PACK      KEY30,AADMNO,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,INTL9999
.
          MATCH     DAADMNO,DTADMN
          GOTO      INTL9999 IF NOT EQUAL
.
          MATCH     ANSL,TMOVE
          IF        @EQUAL
            MATCH     SP70,PTTRLTYP
            IF        !@EQUAL
              PACK      KEY5,ANST,ANSL,PTTRLTYP,SP70
              CALL      RDCODE1
              IF        OVRCD<>1
                MATCH     ANSM,TCINDC3
                GOTO      INTL9000 IF EQUAL
.
                MATCH     ANSA,TCINDC3
                GOTO      INTL9000 IF EQUAL
              ENDIF
            ENDIF
          ENDIF
          GOTO      INTL9999
.
INTL9000  MOVE      ONE,EXIT
.
INTL9999  RETURN
+
.------------------------------------------------------------------------------
.         Clear Ventilation End Date/Time and Hours; match discharge date/time
.------------------------------------------------------------------------------
CLRVEN00  PACK      KEY27,DAADMNO,Z70
          CALL      RSPTVEN1
CLRVEN10  CALL      RPPTVEN1
          BRANCH    OVRCD,CLRVEN99
.
          MATCH     DAADMNO,PTVEVISN
          GOTO      CLRVEN99 IF NOT EQUAL
.
          MATCH     TEMPDATE,PTVEEDAT
          GOTO      CLRVEN10 IF NOT EQUAL
.
          MATCH     TEMPTIME,PTVEETIM
          GOTO      CLRVEN10 IF NOT EQUAL
.
          MOVE      SP10,PTVEEDAT
          MOVE      SP10,PTVEETIM
          MOVE      ZERO,PTVEHOUR
          CALL      UPPTVEN1           * Update Ventilation record
.
CLRVEN99  RETURN
+
.------------------------------------------------------------
.         Update PRFA for Undischarge a deceased patient
.------------------------------------------------------------
UPRA0000  MATCH     "1",PTCNDEES
          GOTO      UPRA9999 IF NOT EQUAL   * Not update PRFA for deceased pat.
.
          MATCH     SP70,PTCNDDES
          GOTO      UPRA9999 IF EQUAL
.
          MOVE      ZERO,FORM2
          STRIP     PTCNDDES
          SCAN      PTCNDDES,PKNAME
          GOTO      UPRA9999 IF NOT EQUAL
.
          MOVELPTR  PTCNDDES,FORM2
          RESET     PKNAME
.
          MOVE      ZERO,F2
          WHILE     F2<=FORM2
            BUMP      PKNAME
            ADD       ONE,F2
          DO
.
          PACK      KEY20,PKNAME,SP70
          PACK      PKNAME,PKNAME,SP70
.
UPRA9999  RETURN
+
.------------------------------------------------------------
.         Check if the invoice amount is balanced
.------------------------------------------------------------
CINV0000  MOVE      ZERO,EXIT
          PACK      KEY16,AADMNO,SP70
          CALL      RSPTINV3
CINV1000  CALL      RKPTINV3
          BRANCH    OVRCD,CINV9999
          MATCH     PINVADM,AADMNO
          GOTO      CINV9999 IF NOT EQUAL     * no invoice found
.
          ADD       PINVPATA,PINVAMT
          ADD       PINVHFDA,PINVAMT
          ADD       PINVOTHA,PINVAMT
          ADD       PTINCRTT,PINVAMT
          COMPARE   ZERO,PINVAMT              * Invoice balanced?
          GOTO      CINV1000 IF EQUAL
.
CINV9000  MOVE      ONE,EXIT
CINV9999  RETURN
+
.------------------------------------------------------------
. Subroutine to write a delete record to wathisaf
.------------------------------------------------------------
DELNBR00  OPEN      WATHISA1,"wathisaf"
          PACK      KEY31,WMURNO,WMCODE,WMCNT,Z70
          CALL      RSWTHIS1
          CALL      RPWTHIS1
          BRANCH    OVRCD,DELNBR99
.
          MATCH     WMURNO,WTHIURNO
          GOTO      DELNBR99 IF NOT EQUAL
.
          MATCH     WMCODE,WTHIPROC
          GOTO      DELNBR99 IF NOT EQUAL
.
          COMPARE   WMCNT,WTHIPCNT
          GOTO      DELNBR99 IF NOT EQUAL
.
          PACK      WTHIEDAT,CCC,CYY,CMM,CDD,SP10
          REP       " 0",WTHIEDAT
          CLOCK     TIME,WTHIETIM
          MOVE      WMBOOK,WTHIBOOK
          MOVE      ANSN,WTHIRECS
          MOVE      ANSD,WTHIRTYP
.
DELNBR25  PACK      KEY31,WTHIURNO,WTHIPROC,WTHIPCNT,WTHIEDAT,WTHIUCNT,SP70
.
          CALL      RAWTHIS1
          IF        OVRCD<>1
            ADD       ONE,WTHIUCNT
            GOTO      DELNBR25
          ELSE
            CALL      WRWTHIS1
          ENDIF
          GOTO      DELNBR99
.
DELNBR99  RETURN
+
.------------------------------------------------------------
. Subroutine to write a delete record to wathisaf for unadmit
.------------------------------------------------------------
DELWAD00  OPEN      WATHISA1,"wathisaf"
          PACK      KEY31,WMURNO,WMCODE,WMCNT,Z70
          CALL      RSWTHIS1
DELWAD10  CALL      RPWTHIS1
          BRANCH    OVRCD,DELWAD99
.
          MATCH     WMURNO,WTHIURNO
          GOTO      DELWAD99 IF NOT EQUAL
.
          MATCH     WMCODE,WTHIPROC
          GOTO      DELWAD99 IF NOT EQUAL
.
          COMPARE   WMCNT,WTHIPCNT
          GOTO      DELWAD99 IF NOT EQUAL
.
          MATCH     "33",WTHIBSCD
          GOTO      DELWAD10 IF NOT EQUAL
.
          PACK      WTHIEDAT,CCC,CYY,CMM,CDD,SP10
          REP       " 0",WTHIEDAT
          CLOCK     TIME,WTHIETIM
          MOVE      WMBOOK,WTHIBOOK
          MOVE      SP1,WTHIRTYP
          MOVE      "37",WTHIBSCD
.
DELWAD25  PACK      KEY31,WTHIURNO,WTHIPROC,WTHIPCNT,WTHIEDAT,WTHIUCNT,SP70
.
          CALL      RAWTHIS1
          IF        OVRCD<>1
            ADD       ONE,WTHIUCNT
            GOTO      DELWAD25
          ELSE
            CALL      WRWTHIS1
          ENDIF
          GOTO      DELWAD99
.
DELWAD99  RETURN
+
...-------------------------------------------------------- * start   *D-240107
... Check if final episode has had disease coding. From IBAPAT05
... Returns: EXIT  = 0  No coding performed
...                  1  Coding Performed
...------------------------------------------------------------
...
..CEPC0000  PACK      KEY18,AADMNO,TADOCT,PTTREPNO,SP10
..          CALL      RSPTMRD1                     * position in disease file
..CEPC1000  CALL      RKPTMRD1                     * read next record
..          BRANCH    OVRCD,CEPC9000               * end of file
...
..          MATCH     AADMNO,PTMDADMN              * same admission number ?
..          GOTO      CEPC9000 IF NOT EQUAL        * no - finished
...
..          MATCH     TADOCT,PTMDADOC              * same doctor ?
..          GOTO      CEPC9000 IF NOT EQUAL        * no - finished
...
..          COMPARE   PTTREPNO,PTMDEPNO            * same episode number ?
..          GOTO      CEPC9000 IF NOT EQUAL        * no - finished
...
..          CLEAR     WEBTITLE
..          APPEND    "Disease coding has already been done for",WEBTITLE
..          APPEND    " this episode, please delete it before",WEBTITLE
..          APPEND    " undischarging.  ",WEBTITLE
..          RESET     WEBTITLE
..          CALL      WEBERR00
..          MOVE      ONE,EXIT
..          GOTO      CEPC9999
...
..CEPC9000  MOVE      ZERO,EXIT
..          GOTO      CEPC9999
...
..CEPC9999  RETURN
...                                                           * end   *D-240107
+
.------------------------------------------------------------
. Cancel Admission (un-admit by admission number)
. Returns:  EXIT    0 = Ok to continue
.                   1 = Error
.------------------------------------------------------------
.
CLADM000  MOVE      ADMISSNO,AADMNO
.
.        Check if some one is accessing this patient
.
          MOVE      AADMNO,KEY8
          CALL      RLPTMIS1                     * admission record found ?
          BRANCH    OVRCD,CLADM960:              * no
                          CLADM970               * yes - already locked
.
          MATCH     SP70,PTMILSDN
          IF        !@EQUAL
            MOVE      ONE,STATADMN
            PACK      ORIGADMN,ADMISSNO
          ENDIF
.
          COMPARE   TWO,ASTAT
          GOTO      CLADM900 IF NOT EQUAL
.
          CALL      CUSG0000                     * Check Usage
          BRANCH    EXIT,CLADM925                * found usage
.
          IF        AINVPRT<>0
..            CALL      CRED0000      * Check if invoice has been fully credited
..            BRANCH    EXIT,CLADM910 * not fully credited
            GOTO      CLADM910
          ENDIF
.
          PACK      KEY14,DAADMNO,SP20
          CALL      RSPMMTI1
          CALL      RKPMMTI1
          BRANCH    OVRCD,CLADM010
.
          MATCH     PMMIVISN,DAADMNO
          GOTO      CLADM920 IF EQUAL
.
.        Display basic patient details, and check that this is the right person
.
CLADM010  MOVE      AURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,CLADM930
.
          MOVE      AURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MOVE      AADMNO,PVIBILL
          MOVE      PVIBILL,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD,CLADM940
.
          MOVE      AADMNO,KEY8
          CALL      RDPMVX11
.
          MOVE      AADMNO,KEY8
          CALL      RDDSCH1
.
.        Write the MHMS adjustment data if necessary
.
          CALL      MEHB0000             * update MEH details
.
.       update the patdayaf file if appropriate
.
          MOVE      THREE,OPTION
          CALL      PATD0000             * update the patdayaf file
.
.       delete a PATDADFD record if appropriate
.
          BRANCH    PTCNUADT,CLADM020        * PATDADFD control parameter is on
          GOTO      CLADM030
.
CLADM020  PACK      KEY8,AADMNO
          CALL      RDPTDAD1                 * read PATDADFD record
          BRANCH    OVRCD,CLADM030           * record not found
.         CALL      DEPTDAD1                 * delete the PATDADFD record
.
.        Update the Waiting Lists Treatment File if Needed
.
CLADM030  MOVE      ONE,ASTAT
          IF        UPDATETY=9 | STATADMN=1
            MOVE      FIVE,ASTAT
          ENDIF
          COMPARE   ONE,CTHETR
          IF        @EQUAL
            CALL      THET0000
            IF        WAITFLAG=1
              CALL      WRTHIS00
            ENDIF
            GOTO      CLADM040
          ENDIF
          PACK      KEY8,AADMNO
          CALL      RDBKREC1
          BRANCH    OVRCD,CLADM040
.
          MOVE      ONE,BKRESTAT
          CALL      UPBKREC1
.
          PACK      KEY19,BKREURNO,BKREPROC,BKRECNT
          CALL      RDTREA1
          BRANCH    OVRCD,CLADM040
.
          CALL      SAVHIS00
.
. if the procedure is not performed, must delete the new W/L record made and
. return the original back to scheduled
.
          IF        WMSTAT = 8
            MOVE      WMBOOK,KEY8
            CALL      RDWTPNP1
            IF        OVRCD = ZERO
              PACK      KEY19,WMURNO,WMCODE,WTNPNCNT
              CALL      DETREA1
            ENDIF
          ENDIF
.
          PACK      KEY19,BKREURNO,BKREPROC,BKRECNT
          CALL      RDTREA1
          BRANCH    OVRCD,CLADM040
.
          OPEN      WATTX1A1,"wattx1af"
          PACK      KEY19,WMURNO,WMCODE,WMCNT,SP70
          CALL      RDWTTX11
          IF        OVRCD=1
            CALL      CLWATTX1
          ENDIF
          CLOSE     WATTX1A1
.
          MOVE      SP70,SAVEBSCD      * Trigger record to be written
          MOVE      TWO,WMSTAT
          MOVE      "01",WTWMBSCD
          MOVE      ONE,NBRFLAG
          CALL      UPTREA1
          CALL      WRTHIS00
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      THIRTY8,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLIUWL                * HL7 - Update Waiting List Entry
.
.        Release the bed
.
CLADM040  MOVE      AWARD,LWARD
          MOVE      ABED,LBED
          CALL      RELBED00
          BRANCH    EXIT,CLADM980
.
          MOVE      SP3,STWARD
.
.        Delete records from Patient Code Changes file
.
CLADM050  PACK      KEY24,AADMNO,SP20
          CALL      RDSCHCO1
          CALL      RDKCHCO1
          BRANCH    OVRCD,CLADM060
.
          MATCH     CHADMN,AADMNO
          GOTO      CLADM060 IF NOT EQUAL
.
          PACK      KEY24,AADMNO,CHDATE,CHTIME,SP70
          CALL      DECHCO1
          GOTO      CLADM050
.
.        Delete records from the additional charges file
.
CLADM060  COMPARE   ZERO,PTCNADDC
          GOTO      CLADM080 IF EQUAL        * Not using additional charging
.
CLADM070  PACK      KEY16,AADMNO,SP20
          CALL      RSPTAH1                 * Position on & read the additional
          CALL      RKPTAH1                   charges file
          BRANCH    OVRCD,CLADM080
.
          MATCH     AADMNO,PTAHADMN
          GOTO      CLADM080 IF NOT EQUAL
.
          PACK      KEY16,PTAHADMN,PTAHDATE
          CALL      DEPTAH1                 * Delete a record from the
          GOTO      CLADM070                  additional charges file
.
.         Broadcast cancel admission message to Datagate BEFORE deleting
.         the transfer file record
.
CLADM080  PACK      KEY8,AADMNO,SP70
          CALL      RDPTRES1
          IF        OVRCD=1
            CALL      CPTRE100
          ENDIF
.
          PACK      KEY30,AADMNO,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          IF        OVRCD=1
            CALL      CLPATTRN
          ELSE
            MATCH     TADMN,AADMNO
            IF        !@EQUAL
              CALL      CLPATTRN
            ENDIF
          ENDIF
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TWENTY4,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICCA                * cancel admission bcast   *C-90222
.
          CALL      DELWAD00                * write unadmit record to wathisaf
.
.        Delete all transfer file records
.
          MOVE      SP70,SAVTDEPT
CLADM085  PACK      KEY30,AADMNO,SP30
          CALL      RDSTRAN2
          CALL      RDKTRAN2
          BRANCH    OVRCD,CLADM140
.
          MATCH     TADMN,AADMNO
          GOTO      CLADM140 IF NOT EQUAL
.
          PACK      KEY30,TADMN,TDATE,TTIME,TWARD,TBED
          CALL      DETRAN2
.
          MATCH     "1",DELETEMH
          GOTO      CLADM090 IF NOT EQUAL
.
          PACK      KEY5,ANSA,ANSC,TDEPT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CLADM090
.
          MATCH     "P",TCINDC5
          GOTO      CLADM090 IF NOT EQUAL
.
          MOVE      TDEPT,SAVTDEPT
.
.        Set up parameters for Ward Usage file update
.
CLADM090  MOVE      TDATE,CPTDATE
          REP       " 0",CPTDATE
          CALL      GPERD                * Get the financial period for date
          BRANCH    EXIT,CLADM965         * Date not in period file
.
.        Check what type of record has been deleted
.
          MATCH     ANSA,TMOVE
          GOTO      CLADM110 IF EQUAL
.
          MATCH     ANSL,TMOVE
          GOTO      CLADM120 IF EQUAL
.
          MATCH     ANSR,TMOVE
          GOTO      CLADM130 IF EQUAL
.
.        Check if this was a ward transfer record
.
          MATCH     STWARD,TWARD
          GOTO      CLADM085 IF EQUAL
.
.        Update the Ward Usage statistics
.
          PACK      KEY9,STWARD,DRGYR,DRGNUM
          MOVE      THREE,COUNT             * Number of Transfers out
          MOVE      SEQ,FORM2
.
          PACK      KEY9,TWARD,DRGYR,DRGNUM
          MOVE      TWO,COUNT               * Number of Transfers in
          MOVE      SEQ,FORM2
.
          MOVE      TWARD,STWARD
          GOTO      CLADM085
.
.        We have deleted the Admission record - update the Ward Usage stats
.
CLADM110  PACK      KEY9,TWARD,DRGYR,DRGNUM
          MOVE      ONE,COUNT               * Number of Admissions
          MOVE      SEQ,FORM2
.
          MOVE      TWARD,STWARD
          GOTO      CLADM085
.
.        We have deleted a Leave record - Update the Ward Usage statistics
.
CLADM120  PACK      KEY9,TWARD,DRGYR,DRGNUM
          MOVE      FIVE,COUNT              * Number of On-leaves
          MOVE      SEQ,FORM2
.
          MOVE      TWARD,STWARD
          GOTO      CLADM085
.
.        We have deleted a Return record - Update the Ward Usage statistics
.
CLADM130  PACK      KEY9,TWARD,DRGYR,DRGNUM
          MOVE      SIX,COUNT               * Number of Returns
          MOVE      SEQ,FORM2
.
          MOVE      TWARD,STWARD
          GOTO      CLADM085
.
.        Delete the record from the Invoice pending file
.        If Using the Invoice Pending File
.
CLADM140  IF        PTCNIPEN = 0
            MOVE      AADMNO,KEY8
            CALL      DEIPEN1
          ENDIF
.
.        Update the Admission record
.
          MOVE      SP3,AWARD
          MOVE      SP3,ABED
          MOVE      ONE,ASTAT
          IF        UPDATETY=9|STATADMN=1
            MOVE      FIVE,ASTAT
            CALL      PMIGTNID                * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI          CAR 272419
            MOVE      TEN,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICPA                * cancel admission bcast
          ENDIF
          CALL      UPLMISS1
.
.        Delete the entry from the In-patient location file
.
          PACK      KEY88,PTMASNAM,PMPXFNAM,AADMNO
          CALL      DELOCA1
.
.        Delete the entry from the current patient file
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPMCUR1
          IF        OVRCD=0
            CALL      DEPMCUR1
          ENDIF
.
.        Delete the entry from the working diagnosis file
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPMWOR1
          IF        OVRCD=0
            CALL      DEPMWOR1
          ENDIF
.
.        Update the Fee's Raised Indicator
.
          MOVE      ADATE,TDATE
          CALL      UPDCFR00
.
.        Remove All FIM details if they exist      
.
          IF        ADMFIMEX <> 1
            GOTO      CLADM145
          ENDIF
.
          CALL      RMFIM000
.
.        Write an Audit record if needed
.
CLADM145  BRANCH    CAUDA,CLADM150
          MOVE      "D",ACTION
          CALL      ACTASAV0
          CALL      WRAAUD
.
.        Write HCS Admission audit file (Unadmit)
.
CLADM150  MOVE      ONE,PTUNTYPE             * Unadmit record
          MOVE      ADATE,PTUNODTE
          MOVE      ATIME,PTUNOTTM
          PACK      PTUNCANC,TRNUREAS,SP70
          CALL      ADMHCS00
.
.        Update the Admission/Discharge Statistics
.
          MOVE      ADATE,CPTDATE
          REP       " 0",CPTDATE
          CALL      GPERD                * Get the financial period for date
          BRANCH    EXIT,CLADM950         * Date not in period file
.
          MOVE      DRGYR,SADYEAR
          MOVE      DRGNUM,FORM2
.
          MATCH     SP3,ASRCE
          GOTO      CLADM160 IF NOT EQUAL
.
          MOVE      "UNK",ASRCE
CLADM160  PACK      KEY8,SADYEAR,CODEB,ASRCE
          CALL      CANSTA00
.
          MATCH     SP3,ATYPE
          GOTO      CLADM170 IF NOT EQUAL
.
          MOVE      "UNK",ATYPE
CLADM170  PACK      KEY8,SADYEAR,CODEA,ATYPE
          CALL      CANSTA00
.
.       Check if there is a standby patient for the bed just vacated
.
          MOVE      AURNO,SAVEURNO
          MOVE      AADMNO,SAVADMIS
          MOVE      ZERO,DELBTRFL           * delete bed transfer flag = no
          CALL      SBYPT000
          BRANCH    EXIT,CLADM980
.
          MOVE      "Patient Unadmitted.  ",WEBTITLE
          PACK      KEY8,ADMISSNO              * Restore correct admission num
          CALL      UUPTMIS1
.
.         May need to write a 'delete' record to patpeiaf
.
          PACK      KEY18,ADMISSNO,SP70
          CALL      RSP2DTL2
          CALL      RKP2DTL2                  * check prs2 adm.details file
          BRANCH    OVRCD,CLADM180
.
          MATCH     P2DTADMN,ADMISSNO
          IF        @EQUAL
            MOVE      "15",HDPEQUIV
            CALL      DPEI0000                * write patpeiaf(delete) record
          ENDIF
.
CLADM180  MATCH     "1",DELETEMH
          GOTO      CLADM800 IF NOT EQUAL
.
          MATCH     SP70,SAVTDEPT
          GOTO      CLADM800 IF EQUAL
.
          MATCH     "1",DELEPAMH
          GOTO      CLADM600 IF EQUAL
.
          PACK      KEY5,ANSA,ANSC,SAVTDEPT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CANMH999
.
          MATCH     "P",TCINDC5
          GOTO      CANMH999 IF NOT EQUAL
.
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
          CLEAR     REDIRECT
          APPEND    "patweb89.pbl?reportno=07&template=003&urnumber=",REDIRECT
          APPEND    URNUMBER,REDIRECT
          APPEND    "&admissno=",REDIRECT
          APPEND    ADMISSNO,REDIRECT
          RESET     REDIRECT
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
          MOVE      "7",NEXTPAGE
.
          PACK      KEY30,AADMNO,SP70
          CALL      RDSTRAN2
CLADM190  CALL      RDKTRAN2
          BRANCH    OVRCD,CLADM800
.
          MATCH     AADMNO,TADMN
          GOTO      CLADM800 IF NOT EQUAL
.
          PACK      KEY5,ANSA,ANSC,TDEPT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CLADM190
.
          MATCH     "P",TCINDC5
          GOTO      CLADM190 IF NOT EQUAL
.
          MOVE      "0",NEXTPAGE
.
          GOTO      CLADM800
.
CLADM600  REP       " +",SAVTDEPT
          PACK      REDIRECT,REDIRECT,SAVTINIT,SAVTDEPT
.
          GOTO      CLADM800
.
CLADM800  MOVE      ZERO,EXIT
          GOTO      CLADM999
.
CLADM900  MOVE      "Cannot unadmit until undischarged.  ",WEBTITLE
          CALL      WEBERR00
          MOVE      ADMISSNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      CLADM999
.
CLADM910  MOVE      "Admission has been Invoiced",WEBTITLE
          CALL      WEBERR00
          MOVE      ADMISSNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      CLADM999
.
CLADM920  MOVE      "Admission has Misc. Items",WEBTITLE
          CALL      WEBERR00
          MOVE      ADMISSNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      CLADM999
.
CLADM925  MOVE      "Admission has a Theatre booking with Usage",WEBTITLE
          CALL      WEBERR00
          MOVE      ADMISSNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      CLADM999
.
CLADM930  MOVE      "Master File Data Missing",WEBTITLE
          CALL      WEBERR00
          MOVE      ADMISSNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      CLADM999
.
CLADM940  MOVE      "Visit File Record Missing",WEBTITLE
          CALL      WEBERR00
          MOVE      ADMISSNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      CLADM999
.
CLADM950  MOVE      "Date not found in period file",WEBTITLE
          CALL      WEBERR00
          MOVE      ADMISSNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      CLADM999
.
CLADM960  MOVE      "Invalid Admission Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CLADM999
.
CLADM965  UNPACK    CPTDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          CLEAR     WEBTITLE
          APPEND    CPCDATE,WEBTITLE
          APPEND    " not Found in Period file",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ADMISSNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      CLADM999
.
CLADM970  CLEAR     WEBTITLE
          APPEND    "Patient Busy on Terminal",WEBTITLE
          APPEND    APORT,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
CLADM980  MOVE      ONE,EXIT
          GOTO      CLADM999
.
CLADM999  RETURN
+
.-------------------------------------------------------------
.         Check Theatre Usage
.-------------------------------------------------------------
CUSG0000  COMPARE   ONE,PTCNHDPS
          GOTO      CUSG9000 IF EQUAL
.
          PACK      KEY31,AADMNO,SP70
          CALL      RSOPDEA2
CUSG1000  CALL      RKOPDEA2
          BRANCH    OVRCD,CUSG9000
.
          MATCH     DAADMNO,OPDAADMN
          GOTO      CUSG9000 IF NOT EQUAL
.
          COMPARE   THREE,OPDASTAT            * cancelled?
          GOTO      CUSG1000 IF EQUAL
.
          PACK      KEY10,OPDAUNIQ,SP70
          CALL      RDOPARD1                 * arrival/recovery details
          BRANCH    OVRCD,CUSG1000
.
          MOVE      ONE,EXIT                 * found usage
          GOTO      CUSG9999
.
CUSG9000  MOVE      ZERO,EXIT
CUSG9999  RETURN
+
.-------------------------------------------------------------
. Check if this patient has all printed invoice fully credited
. Returns:  EXIT  0 = Ok to continue
.                 1 = Error
.-------------------------------------------------------------
.
CRED0000  OPEN      PMSCNOA2,"pmscnoaf"
.
          PACK      KEY16,ADMISSNO,SP70
          CALL      RSPMCNO2
CRED1000  CALL      RKPMCNO2
          BRANCH    OVRCD,CRED8000
.
          MATCH     ADMISSNO,PMCNVISN
          GOTO      CRED8000 IF NOT EQUAL
.
          MATCH     "1",PMCNSTAT       * Fully credited ?
          GOTO      CRED9000 IF EQUAL  * yes
          GOTO      CRED1000
.
CRED8000  MOVE      ONE,EXIT           * not fully credited
          GOTO      CRED9999
.
CRED9000  MOVE      ZERO,EXIT          * fully credited
.
CRED9999  RETURN
+
.------------------------------------------------------------
.        Subroutine to save the Admission Variables before changes for
.        use in the audit file PATAUAA1
.------------------------------------------------------------
.
ACTASAV0  MOVE      AADMNO,SAADMNO
          MOVE      AURNO,SAURNO
          MOVE      ADATE,SADATE
          MOVE      ATIME,SATIME
          MOVE      ASTAT,SASTAT
          MOVE      APORT,SAPORT
          MOVE      ATRANNO,SATRANNO
          MOVE      AINVPRT,SAINVPRT
          MOVE      ALACDTE,SALACDTE
          MOVE      ACANCEL,SACANCEL
          MOVE      AWARD,SAWARD
          MOVE      ABED,SABED
          MOVE      ADOCTR,SADOCTR
          MOVE      ADOCTA,SADOCTA
          MOVE      ADOCTL,SADOCTL
          MOVE      ASRCE,SASRCE
          MOVE      ATYPE,SATYPE
          MOVE      ACLSS,SACLSS
          MOVE      ACARE,SACARE
          MOVE      AFUNDH,SAFUNDH
          MOVE      AFNDTB,SAFNDTB
          MOVE      AFNDMM,SAFNDMM
          MOVE      AELIG,SAELIG
          MOVE      AVISIT,SAVISIT
          MOVE      AALERG,SAALERG
          MOVE      AILLN,SAILLN
          MOVE      ADIAG1,SADIAG1
          MOVE      ADIAG2,SADIAG2
          MOVE      ADISC,SADISC
          MOVE      ADOCTT,SADOCTT
          MOVE      ACLSSFT,SACLSSFT
          MOVE      AALLOW,SAALLOW
          MOVE      AMBS,SAMBS
          MOVE      ACLAIM,SACLAIM
          MOVE      ADIET,SADIET
          MOVE      APLOCCR,SAPLOCCR
          MOVE      ASTAY,SASTAY
          MOVE      ADYHOSP,SADYHOSP
          MOVE      AMEMB,SAMEMB
          MOVE      AMEMBNO,SAMEMBNO
          MOVE      ACOMM1,SACOMM1
          MOVE      ACOMM2,SACOMM2
          MOVE      APLUR,SAPLUR
          MOVE      APURGE,SAPURGE
          MOVE      AUSR1,SAUSR1
          MOVE      AUSR2,SAUSR2
          MOVE      AUSR3,SAUSR3
          MOVE      AUSR4,SAUSR4
          MOVE      AUSR5,SAUSR5
          MOVE      AUSR6,SAUSR6
          MOVE      AUSR7,SAUSR7
.
          MOVE      ADSCHI,SADSCHI
          MOVE      ARDRNAM,SARDRNAM
          MOVE      AFNDYY,SAFNDYY
          MOVE      AFNDCG,SAFNDCG
          MOVE      AOCCDTE,SAOCCDTE
          MOVE      ACODDTE,SACODDTE
          MOVE      ARETDTE,SARETDTE
          MOVE      AMUMADM,SAMUMADM
          MOVE      DPTMIPVI,SDPTMIPV
          MOVE      ABWGHT,SABWGHT
          MOVE      PMVXRHC1,SPTMSRFG
          MOVE      PMVXRH1G,SPTMSGPP
          MOVE      PTMSFHAN,SPTMSFHA
          MOVE      PTMSECRA,SPTMSECR
          MOVE      PTMSMGIN,SPTMSMGI
          MOVE      PTMIDDIG,SPTMIDIG
          MOVE      PMVXRH1C,SPTMIGPT
          MOVE      PTMIDOFR,SPTMIDOF
          MOVE      PTMIREFD,SPTMIREF
          MOVE      PTMIDFCN,SPTMIDFC
          MOVE      PTMIPHPU,SPTMIPHP
          MOVE      PTMIAGNC,SPTMIAGN
          MOVE      PTMIESSF,SPTMIESS
          MOVE      PTMIUSR8,SPTMIUS8
          MOVE      PTMIUSR9,SPTMIUS9
          MOVE      PTMIUSR0,SPTMIUS0
          MOVE      PTMIPDRG,SPTMSDRG
          MOVE      PTMIOPER,SPTMIOPE
          MOVE      PTMIXWRD,SPTMIXWD
          MOVE      PTMIADOC,SPTMIADC
          MOVE      PTMIREGS,SPTMIREG
          MOVE      PTMIUYN1,SPTMIUY1
          MOVE      PTMIUYN2,SPTMIUY2
.
ACTASAV9  RETURN
+
.------------------------------------------------------------
. MEHA0000 - Handles Mental Health data when Undischarging a Patient.
. From IBAPAT05
. Returns:    EXIT  0 = Ok to continue
.                   1 = Error
.------------------------------------------------------------
.
MEHA0000  COMPARE   ONE,MHCNUSE
          GOTO      MEHA9000 IF NOT EQUAL   * not using mental health
.
          MATCH     SP3,PTMXLS
          GOTO      MEHA9000 IF EQUAL       * not a mental health patient
.
          PACK      KEY5,ANSL,ANSS,PTMXLS
          CALL      RDCODE1
          BRANCH    OVRCD,MEHA9000          * invalid legal status
.
.         update status on visit file - MEHVI1FD
.
          MOVE      AADMNO,KEY8
          CALL      RDMHVIS1
          BRANCH    OVRCD,MEHA9000          * not a mental health
.
          MOVE      TWO,AUDIFLAG            * before change
          CALL      MHAUDVIS                * write audit
          MOVE      ONE,MHVISTAT            * set to In-Hospital
          CALL      UPMHVIS1
          MOVE      THREE,AUDIFLAG          * after change
          CALL      MHAUDVIS                * write audit
.
.         delete discharge record - MEHDS1FD
.
          MOVE      AADMNO,KEY8
          CALL      DEMHDSC1
          MOVE      FOUR,AUDIFLAG           * delete
          CALL      MHAUDDSC                * write audit
.
.         check if change of legal status on discharge date
.
MEHA1000  PACK      KEY21,AADMNO,DDATE,SP20
          CALL      RSMHLEG1
MEHA1500  CALL      RKMHLEG1
          BRANCH    OVRCD,MEHA5000          * no change of legal status
.
          MATCH     AADMNO,MHLEADMN
          GOTO      MEHA5000 IF NOT EQUAL
.
          MATCH     ANSR,MHLEFLAG           * review status change only ?
          GOTO      MEHA1500 IF EQUAL       * yes - ignore
.
          MATCH     ANSN,MHLEFLAG           * no status change ?
          GOTO      MEHA1500 IF EQUAL       * yes - ignore
.
          PACK      DIM8,DDATE,SP10
          MATCH     DIM8,MHLEDATE
          GOTO      MEHA5000 IF NOT EQUAL
.
.         delete the MEHLEGFD record for the discharge date & time
.
          PACK      KEY21,AADMNO,DDATE,MHLETIME
          CALL      DEMHLEG1
.
          GOTO      MEHA1000
.
.         check if change of legal status on discharge date
.
MEHA5000  PACK      KEY21,AADMNO,DDATE,SP20
          CALL      RSMHCJA1
          CALL      RKMHCJA1
          BRANCH    OVRCD,MEHA6000          * no change of legal status
.
          MATCH     AADMNO,MHCJADMN
          GOTO      MEHA6000 IF NOT EQUAL
.
          PACK      DIM8,DDATE,SP10
          MATCH     DIM8,MHCJDATE
          GOTO      MEHA6000 IF NOT EQUAL
.
.         delete the MEHCJAFD record for the discharge date & time
.
          PACK      KEY21,AADMNO,DDATE,MHCJTIME
          CALL      DEMHCJA1
.
          GOTO      MEHA5000
.
.         update the Master file with the previous Legal Status
.
MEHA6000  PACK      KEY21,AADMNO,DDATE,Z20
          CALL      RSMHLEG1
          CALL      RPMHLEG1
          BRANCH    OVRCD,MEHA9000          * no change of legal status
.
          MATCH     AADMNO,MHLEADMN
          GOTO      MEHA9000 IF NOT EQUAL
.
          MOVE      PURNO,KEY8
          CALL      RDMAST1
          IF        OVRCD=0
            MOVE      PURNO,KEY8
            CALL      RDPMPX21
            IF        OVRCD=1
              CALL      CLPMSPX2
            ENDIF
          ENDIF
.
          MOVE      MHLESTAT,PTMXLS
          CALL      UPMAST1
          CALL      UUPTMAS1
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPTRES1
          IF        OVRCD=1
            CALL      CPTRE100
          ENDIF
.
          CALL      PMIGTNID                 * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TWENTY5,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICUP       * send new details to Datagate      *C-90222
.
MEHA9000  MOVE      ZERO,EXIT
          GOTO      MEHA9999
.
MEHA9100  MOVE      ONE,EXIT
.
MEHA9999  RETURN
+
.------------------------------------------------------------
. MEHB0000 - Handles Mental Health data when Un-admitting a patient
. From IBAPAT05
.------------------------------------------------------------
.
MEHB0000  COMPARE   ONE,MHCNUSE
.
          GOTO      MEHB9999 IF NOT EQUAL   * not using mental health
.
          MATCH     SP3,PTMXLS
          GOTO      MEHB9999 IF EQUAL       * not a mental health patient
.
          PACK      KEY5,ANSL,ANSS,PTMXLS
          CALL      RDCODE1
          BRANCH    OVRCD,MEHB9999          * invalid legal status
.
.         update status on visit file - MEHVI1FD
.
          MOVE      AADMNO,KEY8
          CALL      RDMHVIS1
          BRANCH    OVRCD,MEHB9999          * not a mental health patient
.
          MOVE      TWO,AUDIFLAG            * before change
          CALL      MHAUDVIS                * write audit
          MOVE      ZERO,MHVISTAT           * set to Pre-Admitted
          CALL      UPMHVIS1
          MOVE      THREE,AUDIFLAG          * after change
          CALL      MHAUDVIS                * write audit
.
.         delete all records in MEHLEGFD
.
          PACK      KEY21,AADMNO,SP20
          CALL      RSMHLEG1
MEHB1000  CALL      RKMHLEG1
          BRANCH    OVRCD,MEHB1200          * end of file
.
          PACK      SAVKEY21,MHLEADMN,MHLEDATE,MHLETIME,SP20
          MATCH     MHLEADMN,AADMNO
          GOTO      MEHB1200 IF NOT EQUAL   * different patient
.
          PACK      KEY21,MHLEADMN,MHLEDATE,MHLETIME
          CALL      DEMHLEG1
.
          MOVE      SAVKEY21,KEY21
          CALL      RSMHLEG1
          GOTO      MEHB1000
.
.         delete all records in MEHCJAFD
.
MEHB1200  PACK      KEY21,AADMNO,SP20
          CALL      RSMHCJA1
MEHB1300  CALL      RKMHCJA1
          BRANCH    OVRCD,MEHB1500          * end of file
.
          PACK      SAVKEY21,MHCJADMN,MHCJDATE,MHCJTIME,SP20
          MATCH     MHCJADMN,AADMNO
          GOTO      MEHB1500 IF NOT EQUAL   * different patient
.
          PACK      KEY21,MHCJADMN,MHCJDATE,MHCJTIME
          CALL      DEMHCJA1
.
          MOVE      SAVKEY21,KEY21
          CALL      RSMHCJA1
          GOTO      MEHB1300
.
.         delete all records in MEHDIAFD
.
MEHB1500  PACK      KEY16,AADMNO,SP8        * start on MEHLEGFD
          CALL      RSMHDIA1
MEHB1600  CALL      RKMHDIA1
          BRANCH    OVRCD,MEHB2000          * end of file
.
          MATCH     MHDIADMN,AADMNO
          GOTO      MEHB2000 IF NOT EQUAL   * different patient

          PACK      KEY16,MHDIADMN,MHDIDATE
          CALL      DEMHDIA1
          GOTO      MEHB1600
.
.         delete all records in MEHREVFD
.
MEHB2000  PACK      KEY21,AADMNO,SP20
          CALL      RSMHREV1
          CALL      RKMHREV1
          BRANCH    OVRCD,MEHB2500          * end of file
.
          MATCH     AADMNO,MHRVADMN
          GOTO      MEHB2500 IF NOT EQUAL   * different patient
.
          PACK      KEY21,MHRVADMN,MHRVDATE,MHRVTIME
          CALL      DEMHREV1
          GOTO      MEHB2000
.
.         delete all records in MEHCJRFD
.
MEHB2500  PACK      KEY21,AADMNO,SP20
          CALL      RSMHCJR1
          CALL      RKMHCJR1
          BRANCH    OVRCD,MEHB3000          * end of file
.
          MATCH     AADMNO,MHCRADMN
          GOTO      MEHB3000 IF NOT EQUAL   * different patient
.
          PACK      KEY21,MHCRADMN,MHCRDATE,MHCRTIME
          CALL      DEMHCJA1
          GOTO      MEHB2500
.
.         delete all records in MEHDL1FD
.
MEHB3000  PACK      KEY24,AADMNO,SP20
          CALL      RSMHDLV1
MEHB3100  CALL      RKMHDLV1
          BRANCH    OVRCD,MEHB9999          * end of file
.
          MATCH     AADMNO,MHDLADMN
          GOTO      MEHB9999 IF NOT EQUAL   * different patient
.
          PACK      KEY24,MHDLADMN,MHDLDATE,MHDLTIME
          CALL      DEMHDLV1
          MOVE      FOUR,AUDIFLAG           * delete
          CALL      MHAUDDLV                * write audit
          GOTO      MEHB3100
.
MEHB9999  RETURN
+
.------------------------------------------------------------
. Handles Mental Health data when :
. Changing Admission Date.
. Para's  : OLDADATE      old admission date
.           PTMIS002      new admission date
.------------------------------------------------------------
.
MEHC0000  COMPARE   ONE,MHCNUSE
          GOTO      MEHC9999 IF NOT EQUAL   * not using mental health
.
          MATCH     SP3,PTMXLS
          GOTO      MEHC9999 IF EQUAL       * not a mental health patient
.
          PACK      KEY5,ANSL,ANSS,PTMXLS
          CALL      RDCODE1
          BRANCH    OVRCD,MEHC9999          * invalid legal status
.
          MOVE      AADMNO,KEY8
          CALL      RDMHVIS1
          BRANCH    OVRCD,MEHC9999          * not a mental health patient
.
.         update MEHDIAFD if a record on old admission date
.
          PACK      KEY16,AADMNO,OLDADATE
          CALL      RDMHDIA1
          BRANCH    OVRCD,MEHC5000          * no record on the date
.
.         see if a record on the new admission date
.
          PACK      KEY16,AADMNO,PTMIS002   * new admission date
          CALL      RDMHDIA1
          BRANCH    OVRCD,MEHC1000          * no record on new date
          CALL      DEMHDIA1                * delete old record
.
MEHC1000  PACK      KEY16,AADMNO,OLDADATE   * have a record on new date
          CALL      RDMHDIA1
          BRANCH    OVRCD,MEHC5000          * no record
          MOVE      PTMIS002,OLDADATE
          PACK      MHDIUDAT,CCC,CYY,CMM,CDD
          REP       " 0",MHDIUDAT
          CLOCK     TIME,MHDIUTIM
          MOVE      USERID,MHDIUUID
          CALL      UPMHDIA1
.
.         update MEHLEGFD if a record on old admission date
.
MEHC5000  PACK      KEY21,AADMNO,OLDADATE,SP20
          CALL      RSMHLEG1
MEHC5100  CALL      RKMHLEG1
          BRANCH    OVRCD,MEHC7000          * no record on the date
.
          MATCH     AADMNO,MHLEADMN
          GOTO      MEHC7000 IF NOT EQUAL
.
          MATCH     OLDADATE,MHLEDATE
          GOTO      MEHC7000 IF NOT EQUAL
          MOVE      MHLETIME,DIM5
.
.         see if a record on the new admission date & time
.
          PACK      KEY21,AADMNO,PTMIS002,DIM5   * new admission date
          CALL      RDMHLEG1
          BRANCH    OVRCD,MEHC6000          * no record on new date
          CALL      DEMHLEG1                * delete old record
.
MEHC6000  PACK      KEY21,AADMNO,OLDADATE,DIM5  * have a record on new date
          CALL      RDMHLEG1
          BRANCH    OVRCD,MEHC7000          * no record
          MOVE      PTMIS002,MHLEDATE
          MOVE      DIM5,MHLETIME
          CALL      UPMHLEG1
          GOTO      MEHC5100
.
.         update MEHCJAFD if a record on old admission date
.
MEHC7000  PACK      KEY21,AADMNO,OLDADATE,SP20
          CALL      RSMHCJA1
MEHC7100  CALL      RKMHCJA1
          BRANCH    OVRCD,MEHC9999          * no record on the date
.
          MATCH     AADMNO,MHCJADMN
          GOTO      MEHC9999 IF NOT EQUAL
.
          MATCH     OLDADATE,MHCJDATE
          GOTO      MEHC9999 IF NOT EQUAL
          MOVE      MHCJTIME,DIM5
.
.         see if a record on the new admission date & time
.
          PACK      KEY21,AADMNO,PTMIS002,DIM5   * new admission date
          CALL      RDMHCJA1
          BRANCH    OVRCD,MEHC8000          * no record on new date
          CALL      DEMHCJA1                * delete old record
.
MEHC8000  PACK      KEY21,AADMNO,OLDADATE,DIM5  * have a record on new date
          CALL      RDMHCJA1
          BRANCH    OVRCD,MEHC9999          * no record
          MOVE      PTMIS002,MHCJDATE
          MOVE      DIM5,MHCJTIME
          CALL      UPMHCJA1
          GOTO      MEHC7100
.
MEHC9999  RETURN
+
.------------------------------------------------------------
. Cancel New Born ( by urnumber)
. Returns:   EXIT   0 = Ok to continue
.                   1 = Error
.------------------------------------------------------------
.
CLNBN000  MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,CLNBN910
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          BRANCH    PSTAT,CLNBN920,CLNBN930,CLNBN940
          COMPARE   THREE,PSAGE
          GOTO      CLNBN950 IF NOT LESS
.
          MATCH     SP8,PCHGDTE
          GOTO      CLNBN900 IF EQUAL
.
.        Update number of babies from new born file
.
          UNPACK    PCHGDTE,XCENT,XYEAR,XMON,XDAY
          PACK      CPTDATE,XCENT,XYEAR,XMON,XDAY
          REP       " 0",CPTDATE
          CALL      GPERD
          BRANCH    EXIT,CLNBN960
.
          PACK      KEY6,DRGYR,DRGNUM
          CALL      RDBRNS1
          BRANCH    OVRCD,CLNBN900
.
          COMPARE   ZERO,BRADMN             * Make sure it's not a
          GOTO      CLNBN900 IF EQUAL        * negative number of babies
          GOTO      CLNBN900 IF LESS
.
          SUB       ONE,BRADMN              * Subtract no. of admissions
          CALL      UPBRNS1
          MOVE      "New-Born Baby Cancelled.  ",WEBTITLE
CLNBN900  MOVE      ZERO,EXIT
          GOTO      CLNBN999
.
CLNBN910  MOVE      "Invalid U/R Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CLNBN999
.
CLNBN920  MOVE      "U/R Number has been Cancelled.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CLNBN999
.
CLNBN930  MOVE      "Associated U/R Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CLNBN999
.
CLNBN940  MOVE      "Not a valid U/R Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CLNBN999
.
CLNBN950  MOVE      "Not a New-Born Baby.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CLNBN999
.
CLNBN960  UNPACK    CPTDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          CLEAR     WEBTITLE
          APPEND    CPCDATE,WEBTITLE
          APPEND    " not Found in Period File",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
CLNBN999  RETURN
+
.------------------------------------------------------------
. Display/Update Linked U/R's
.------------------------------------------------------------
.
LNKUR000  MATCH     "L",LINKTYPE
          GOTO      LNKUR100 IF EQUAL
.
          MATCH     "UL",LINKTYPE
          GOTO      LNKUR200 IF EQUAL
          GOTO      LNKUR300                * Display Form
.
LNKUR100  CALL      LINK0000                * Link U/R number
          BRANCH    EXIT,LNKUR999
          CALL      WINCLS00
          GOTO      LNKUR999
.
LNKUR200  CALL      UNLN0000                * Unlink U/R
          BRANCH    EXIT,LNKUR999
          CALL      WINCLS00
          GOTO      LNKUR999
.
LNKUR300  MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          MOVE      OVRCD,MASTFLAG
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          CALL      WEBHED00
          BRANCH    EXIT,LNKUR999
          CALL      WEBBOD00
          CALL      WEBEND00
          GOTO      LNKUR999
.
LNKUR999  RETURN
+
.------------------------------------------------------------
. LINK0000 - Link U/R Numbers
. Returns:    EXIT   0 = Ok to continue
.                    1 = Error
.------------------------------------------------------------
.
LINK0000  MOVE      SP70,LINKFUR
          MOVE      SP70,LINKTUR
.
          MOVE      LINKFMUR,LINKFUR
          MOVE      LINKTOUR,LINKTUR
.
          MOVE      LINKFUR,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,LINK9990
.
          MOVE      PBDATE,SAVEDOB               * save "linked from" DOB
.
          MOVE      LINKFUR,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MOVE      LINKTUR,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,LINK9991
.
          MOVE      LINKTUR,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MATCH     LINKFUR,LINKTUR
          GOTO      LINK9992 IF EQUAL
.
          PACK      KEY16,LINKFUR,LINKTUR,SP70
          CALL      RDLINK1
          COMPARE   ZERO,OVRCD
          GOTO      LINK9993 IF EQUAL
.
          MOVE      LINKDATE,LINKDAT
          MATCH     SP70,LINKDAT
          IF        !@EQUAL
            REP       " 0",LINKDAT
          ENDIF
.
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          MATCH     LINKDAT,CURRDATE
          GOTO      LINK9994 IF LESS
.
          MOVE      LINKREAS,LINKREA        * Reason for Link
.
          CALL      WRLINK1                 * Write a new record
.
.         We need to trigger a PMI update message if this is a mother-child
.         link, so first check the type of link.
.
          PACK      KEY5,ANSL,ANSU,LINKREA
          CALL      RDCODE1                      * link reason on file ?
          BRANCH    OVRCD,LINK9000               * no - finished
.
          MATCH     ANSM,TCINDC1                 * mother-child link ?
          GOTO      LINK9000 IF NOT EQUAL        * no - finished
.
.         This was a mother-child link, so check which U/R was the child's.
.
          MATCH     SAVEDOB,PBDATE               * current patient younger ?
          GOTO      LINK8000 IF NOT LESS         * yes - trigger message
.
.         Re-read the "linked from" patient's pmi record as this is the child's
.         record.  We only send link details for the child's U/R.
.
          MOVE      LINKFUR,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,LINK9000
.
          MOVE      LINKFUR,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
LINK8000  CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      EIGHT,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICUP                * trigger PMI update message
.
LINK9000  MOVE      ZERO,EXIT
          GOTO      LINK9999
.
LINK9990  MOVE      "Invalid 'From' U/R Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      LINK9999
.
LINK9991  MOVE      "Invalid 'To' U/R Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      LINK9999
.
LINK9992  MOVE      "Cannot Link Identical U/R Numbers",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      LINK9999
.
LINK9993  MOVE      "Link Already Exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      LINK9999
.
LINK9994  MOVE      "Date must not be in the future",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      LINK9999
.
LINK9999  RETURN
+
.------------------------------------------------------------
. UNLN0000 - Unlink U/R's
. Returns:    EXIT   0 = Ok to continue
.                    1 = Error
.------------------------------------------------------------
.
UNLN0000  MOVE      LINKFMUR,LINKFUR
          MOVE      LINKTOUR,LINKTUR
.
          MOVE      LINKFUR,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,UNLN9990
.
          MOVE      LINKFUR,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MOVE      PBDATE,SAVEDOB               * save "linked from" DOB
.
          MOVE      LINKTUR,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,UNLN9991
.
          MOVE      LINKTUR,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          PACK      KEY16,LINKFUR,LINKTUR,SP70
          CALL      RDLINK1
          BRANCH    OVRCD,UNLN9993
          PACK      SAVEKEY5,ANSL,ANSU,LINKREA
.
          CALL      DELINK1                 * Delete a new record
.
.         We need to trigger a PMI update message if this was a mother-child
.         link, so first check the type of link.
.
          MOVE      SAVEKEY5,KEY5
          CALL      RDCODE1                      * link reason on file ?
          BRANCH    OVRCD,UNLN9000               * no - finished
.
          MATCH     ANSM,TCINDC1                 * mother-child link ?
          GOTO      UNLN9000 IF NOT EQUAL        * no - finished
.
.         This was a mother-child link, so check which U/R was the child's.
.
          MATCH     SAVEDOB,PBDATE               * current patient younger ?
          GOTO      UNLN8000 IF NOT LESS         * yes - trigger message
.
.         Re-read the "linked from" patient's pmi record as this is the child's
.         record.  We only send link details for the child's U/R.
.
          MOVE      LINKFMUR,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,UNLN9000
.
          MOVE      LINKFMUR,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
UNLN8000  CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      NINE,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICUP                * trigger PMI update message
.
UNLN9000  MOVE      ZERO,EXIT
          GOTO      UNLN9999
.
UNLN9990  MOVE      "Invalid 'From' U/R Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UNLN9999
.
UNLN9991  MOVE      "Invalid 'To' U/R Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UNLN9999
.
UNLN9993  MOVE      "Link Does Not Exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UNLN9999
.
UNLN9999  RETURN
+
.------------------------------------------------------------
. LDET0000 - Link Details
.------------------------------------------------------------
.
LDET0000  BRANCH    FLDITMNO,LDET0100,LDET0200,LDET0300
          GOTO      LDET9999
.
LDET0100  CALL      IBACLOCK
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          MOVE      CYY,CYEAR
          REP       " 0",CYEAR
          WRITE     HTMLFILE;CDD,SP1,MTHNAM3,SP1,CCC,CYEAR
          GOTO      LDET9999
.
LDET0200  MOVE      "LU",CATEGORY
          MOVE      LINKREAS,CODE
          CALL      CODITM00
          GOTO      LDET9999
.
LDET0300  CALL      DISL0000                * Display Linked U/R's
          GOTO      LDET9999
.
LDET9999  RETURN
+
.------------------------------------------------------------
. Display Links
.------------------------------------------------------------
.
DISL0000  PACK      KEY16,URNUMBER,SP70
          CALL      RDSLINK1
DISL0100  CALL      RDKLINK1
          BRANCH    OVRCD,DISL9900
.
          MATCH     URNUMBER,LINKFUR
          GOTO      DISL9900 IF NOT EQUAL
.
          UNPACK    LINKDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          PACK      KEY5,CODELU,LINKREA,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      "Invalid Reason",TDESC
          ENDIF
.
          MOVE      LINKTUR,KEY8
          CALL      RDMAST1
          IF        OVRCD=0
            CALL      PATNAA00
          ENDIF
.
          MOVE      LINKTUR,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
DISL0200  PACK     KEY8,LINKTUR,SP10                                  *I-242949
          REP      " +",KEY8
          WRITE    HTMLFILE;"<tr><td>",LINKFUR,"</td>":
....                        "<td>",LINKTUR,"</td>":                   *C-242949
                            "<td><input class=button type=button":
                            " value=",LINKTUR:
                            " onclick='ShowPatient(#"",LINKTUR,"#",#" #")';>":
                            "</td>":
.                                                               * end *C-242949
                            "<td>",PATFNAME,"</td>";
.
          MATCH    SP70,LINKDAT
          IF       @EQUAL
            WRITE    HTMLFILE;"<td>&nbsp;</td>";
          ELSE
            WRITE    HTMLFILE;"<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>";
          ENDIF
          WRITE    HTMLFILE;"<td>",TDESC,"</td>":
                            "<td><input class=button type=button value=UnLink":
                            " onClick=#"UnLink('",LINKFUR,"','",LINKTUR:
                            "');#"></td></tr>"
          GOTO     DISL0100
.
DISL9900  MOVE      URNUMBER,KEY8           * Read the linkfrom ur record again
          CALL      RDMAST1
          MOVE      OVRCD,MASTFLAG
.
          MOVE      URNUMBER,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
DISL9999  RETURN
+
.------------------------------------------------------------
.        Subtract one from appropriate statistic
.------------------------------------------------------------
.
CANSTA00  BRANCH    PTCNSTAU,CANSTA99     * branch if using the new adm. & dsch.
.                                         stats 1 report
          CALL      RDSTAD1
          BRANCH    OVRCD,CANSTA99
.
          LOAD      FORM5,FORM2,SADMTH1,SADMTH2,SADMTH3,SADMTH4:
                    SADMTH5,SADMTH6,SADMTH7,SADMTH8:
                    SADMTH9,SADMTH10,SADMTH11,SADMTH12:
                    SADMTH13
          SUB       ONE,FORM5
          STORE     FORM5,FORM2,SADMTH1,SADMTH2,SADMTH3,SADMTH4:
                    SADMTH5,SADMTH6,SADMTH7,SADMTH8:
                    SADMTH9,SADMTH10,SADMTH11,SADMTH12:
                    SADMTH13
          CALL      UPSTAD1
.
CANSTA99  RETURN
+
.------------------------------------------------------------
. Public Update Doc and Specialty
. Returns:   EXIT 0 = Ok to continue
.                 1 = Error
.------------------------------------------------------------
.
PUBDS000  MOVE      SP70,HDPEQUIV
          MOVE      ONE,ALWLEAVE            * may allow to update on leave
.                                           * depending on leave type
          CALL      VALID000                * validate admission number
          BRANCH    EXIT,PUBDS910
.
          CALL      VLVE0000                * Check not on leave at doctor
          BRANCH    EXIT,PUBDS910           * change date and time
.
          CALL      VDOC0000                * Validate doctors active dates
          BRANCH    EXIT,PUBDS910
.
          CALL      CURDS000                * Find current doctor/specialty
          BRANCH    EXIT,PUBDS910
.
          CALL      PADC0000                * Update Attending Doctor Specialty
          BRANCH    EXIT,PUBDS910
          BRANCH    CHGFIN,PUBDS900         * changing financial elect/claim cod
.
          CALL      WLNBR000
.
          CALL      WCARE000
.
          MATCH     Z70,NEWACARE            * Is the Care Type Changed?
          GOTO      PUBDS900 IF EQUAL
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,PUBDS910
.
          MATCH     NEWACARE,ACARE
          GOTO      PUBDS900 IF EQUAL       * no change
.
          MOVE      ACARE,SAVCARE
          MOVE      AADMNO,KEY8
          CALL      RDMISS1
          MOVE      NEWACARE,ACARE
          CALL      UPMISS1
          CALL      UUPTMIS1
.
          MATCH     ACARE,SAVCARE
          IF        !@EQUAL
            PACK      HDPEQUIV,ZERO,FIVE,SP2
            CALL      WPEI0000
            CALL      CHCC0000
          ENDIF
          CALL      CHKF0000                * Update PMI folder details
.
PUBDS900  CALL      PMIGTNID              * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TWENTY8,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICAC              * broadcast visit update
.
          PROC      WRWATR00              * write to WA triggers table
.
          MOVE      ZERO,EXIT
          GOTO      PUBDS999
.
PUBDS910  MOVE      ONE,EXIT
.
PUBDS999  RETURN
+
.------------------------------------------------------------
. INSUR000 - Update Insurance Details
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
.
INSUR000  MOVE      ZERO,CHGHF
          MOVE      ZERO,CHGCL
          MOVE      ZERO,CHGTB
          MOVE      ZERO,CHGMM
          MOVE      ZERO,CHGGST
          MOVE      SP70,HDPEQUIV
.
          CALL      VALID000                * validate admission number
          BRANCH    EXIT,INSUR980
.
          IF        CHGCFSG=1
            PACK      KEY8,AADMNO,SP70
            CALL      RDPMVX11
            IF        OVRCD=0
              MOVE      TRANCFSG,PMVXCFSG
              CALL      UPPMVX11
            ENDIF
          ENDIF
.
          IF        CHGADMCR=1
            PACK      KEY8,AADMNO,SP70
            CALL      RDPMVX11
            IF        OVRCD=0
              MOVE      PTVIS041,PMVXCADM
              CALL      UPPMVX11
            ENDIF
          ENDIF
.
          MOVE      AADMNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,INSUR910
.
          MOVE      AADMNO,KEY8
          CALL      RDPMVX11
          BRANCH    OVRCD,INSUR910
.
          IF        CHOSTYP=1 & CFEETYP=0
            MOVE      FIVE,PTIPRSTA         * Update bed fees
            CALL      CINVP000              * Check for tobe invoiced
          ENDIF
.
          COMPARE   ZERO,CHGFEE             * nothing changed
          GOTO      INSUR900 IF EQUAL
.
          PACK      KEY9,ACLAIM,AFUNDH,SP70
          CALL      GETCNEFF               * Get Contract Effective From
.
          MATCH     TRANFUND,AFUNDH
          IF        !@EQUAL
            MOVE      ONE,CHGHF               * health fund changed
            MOVE      "07",HDPEQUIV
          ENDIF
.
          MATCH     TRANTABL,AFNDTB
          IF        !@EQUAL
            MOVE      ONE,CHGTB               * health fund table changed
            MOVE      "07",HDPEQUIV
          ENDIF
.
          PACK      TRANMEMB,TRANMEMB,SP70    * packed to prevent wrong matching
.
          MATCH     TRANMEMB,PMVXFNDM
          IF        !@EQUAL
            MOVE      ONE,CHGMM               * health fund changed
          ENDIF
.
          MATCH     TRACLAIM,ACLAIM
          IF        !@EQUAL
            MOVE      ONE,CHGCL               * claim code changed
            MOVE      "04",HDPEQUIV
            CALL      CHGNZ000
          ENDIF
.
          MATCH     PTMIS074,PTMIGSTA
          IF        !@EQUAL
            MOVE      ONE,CHGGST              * GST Applicable changed
          ENDIF
.
          IF        PTCNHDPS=1
            CALL      WRPORD00            * write acc purchase order no if req
          ENDIF
          IF        CHGHF=0 & CHGTB=0 & CHGCL=0 & CHGMM=0 & CHGGST=0
            GOTO      INSUR500
          ENDIF
.
.       Check if health fund was changed, if they do update master file
.
          MOVE      PURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,INSUR920
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21                     * record on file ?
          IF        OVRCD = 1
            CALL      CLPMSPX2                   * no - clear variables
          ENDIF
.
          MOVE      SP10,DIM3
          IF        CHGCL=1
            MOVE      ONE,F1                     * Change Claim code
            PACK      KEY12,ACLAIM,TRACLAIM,SP70 * Old and New Claim code
            IF        CHGHF=1 | CHGTB=1
              MOVE      FOUR,F1                 * Change Claim and Health fund
              PACK      KEY12A,AFUNDH,TRANFUND  * Old and New HF
              PACK      KEY16,AFNDTB,TRANTABL   * Old and New HF table
            ENDIF
            CALL      UAUD0000
.
            MOVE      ACLAIM,DIM3             * Save old claim code
            MOVE      TRACLAIM,ACLAIM
.
            MOVE      ACLAIM,KEY3
            CALL      PRFAINSR
            IF        OVRCD=0
              MOVE      AADMNO,PKADMN
              PACK      KEY8,AADMNO,SP70
              CALL      RAPTRES1
              IF        OVRCD=0
                CALL      UPPTRES1
              ELSE
                CALL      WRPTRES1
              ENDIF
            ENDIF
          ENDIF
.
          IF        CHGGST=1
            MOVE      PTMIS074,PTMIGSTA       * GST Applicable
          ENDIF
.
          IF        CHGHF=1 | CHGTB=1 | CHGMM=1
            IF        CHGHF=1 | CHGTB=1
              IF        CHGCL<>1
                MOVE      TWO,F1                  * Change Health fund
                PACK      KEY12,AFUNDH,TRANFUND   * Old and New HF
                PACK      KEY16,AFNDTB,TRANTABL   * Old and New HF table
                CALL      UAUD0000
              ENDIF
            ENDIF
.
            MATCH     "1",PTCNPMHF           * Option to Update PMI HF ?
            GOTO      INSUR010 IF NOT EQUAL  * default to Update PMIS HF
.
            MATCH     "1",UPDHFUND
            GOTO      INSUR020 IF EQUAL      * Not to Update PMI HF
.
INSUR010    CALL      EDWH0000               * EDWARD Health Fund trigger
            MOVE      TRANFUND,PFUNDH
            MOVE      TRANTABL,PFNDTB
            MOVE      TRANMEMB,PFNDMM
.
INSUR020    MOVE      TRANFUND,AFUNDH
            MOVE      TRANTABL,AFNDTB
            MOVE      TRANMEMB,AFNDMM
            MOVE      TRANMEMB,PMVXFNDM
            CALL      UPLMAST1
            CALL      UPPMVX11
          ENDIF
.
          CALL      UPLMISS1
.
          CALL      FIXT000                 * fix theatre charges
.
.         Broadcast message (CAR 44952)
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPTRES1
          IF        OVRCD=1
            CALL      CPTRE100
          ENDIF
.
          PACK      KEY30,AADMNO,Z70
          CALL      RDSTRAN2                     * position in file
          CALL      RDPTRAN2                     * read previous record
          IF        OVRCD<>0
            CALL      CLPATTRN
            GOTO      INSUR100
          ENDIF
.
          MATCH     AADMNO,TADMN                 * same admission still ?
          IF        !@EQUAL
            CALL      CLPATTRN
            GOTO      INSUR100
          ENDIF
.
.         Save pattranf key for repositioning for HL7 message later, if required
.         (Task: 0823644)
.
          PACK      SAVKEY30,TADMN,TDATE,TTIME,TWARD,TBED
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TWENTY6,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICAC                * broadcast change admission details
.
INSUR100  CALL      UBFE0000                * Update bed fees
.
.         If the claim code changed from international/overseas to public
.         then warn user if the resident status is set to non-resident
.
          COMPARE   ONE,CHGCL
          GOTO      INSUR500 IF NOT EQUAL   * Claim code not changed
.
          CALL      WESE0000                * write to wateseaf
.
.         If patient changed to private claim code or non-compensable claim
.         then delete any existing claim details
.
          CALL      DOCLMN00                * Delete any claim details
.
          MATCH     SP3,DIM3
          IF        !@EQUAL
            PACK      KEY5,CODECL,DIM3        * check old claim code
            CALL      RDCODE1
            BRANCH    OVRCD,INSUR930
.
            MATCH     "1",TCINDC1             * Check if patient was overseas
            GOTO      INSUR500 IF NOT EQUAL   * No
          ENDIF
.
          MATCH     SP3,ACLAIM
          IF        !@EQUAL
            PACK      KEY5,CODECL,ACLAIM     * Check new claim code
            CALL      RDCODE1
            BRANCH    OVRCD,INSUR940
.
            MATCH     "2",TCINDC9           * check if patient changed to public
            GOTO      INSUR500 IF NOT EQUAL  * No
          ENDIF
.
.         Resident status must not be non-resident for public patients
.
          MATCH     SP3,PTYPE
          IF        !@EQUAL
            PACK      KEY5,ANST,SP1,PTYPE
            CALL      RDCODE1
            BRANCH    OVRCD,INSUR950
.
            MATCH     "2",TCINDC1
            GOTO      INSUR960 IF EQUAL
          ENDIF
.
INSUR500  MATCH     PTASF001,Z70            * I SRF 22829
          IF        !@EQUAL
            MOVE      PTASF001,PTAFCTYP
          ENDIF
.
          MATCH     PTASF002,Z70
          IF        !@EQUAL
            MOVE      PTASF002,PTAFCROL
          ENDIF
.
          MATCH     PTASF003,Z70
          IF        !@EQUAL
            MOVE      PTASF003,PTAFCSID
          ENDIF
.
          CALL      WASF0000                * end I SRF 22829
.
          MATCH     "1",TRIGRA11
          IF        @EQUAL
            CALL      CLPATDSC
.
            CALL      PMIGTNID                * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      THIRTY9,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICCA                * broadcast A11 message
          ENDIF
.
          MATCH     "1",TRIGRA01
          IF        @EQUAL
            CALL      CLPATDSC
.
            CALL      PMIGTNID                * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      FORTY,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICAD                * broadcast A01 message
          ENDIF
.
INSUR900  CALL      WEDI0000                  * Write EDWARD IP visit update
.
          MOVE      ZERO,EXIT
          GOTO      INSUR999
.
INSUR910  MOVE      "Admission Number not found",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      INSUR999
.
INSUR920  MOVE      "Patient Master record not found",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      INSUR999
.
INSUR930  MOVE      "Old Claim code not found",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      INSUR999
.
INSUR940  MOVE      "New Claim code not found",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      INSUR999
.
INSUR950  MOVE      "Resident Status code not found",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      INSUR999
.
INSUR960  CALL      WEDI0000                  * Write EDWARD IP visit update
.
          CLEAR     WEBTITLE
          APPEND    "Warning: ",WEBTITLE
          APPEND    "Non-Resident Status, Patient changed from ",WEBTITLE
          APPEND    "International to Public ",WEBTITLE
          APPEND    SP70,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
INSUR980  MOVE      ONE,EXIT
.
INSUR999  RETURN
+
.-----------------------------------------------------------
.         Update Change Audit file
.-----------------------------------------------------------
UAUD0000  UNPACK    SP70,PMCAOATY,PMCANATY,PMCAOHFN,PMCANHFN,PMCAOHFT,PMCANHFT
          UNPACK    SP70,PMCAOCLM,PMCANCLM
          PACK      PMCASPAR,SP70,SP70
.
.          F1=1 Change Claim code
.          F1-2 Change HF/Table
.          F1=3 Change Admission type
.          F1=3 Change Claim and HF/Table
.
          BRANCH    F1,UAUD1000,UAUD2000,UAUD3000,UAUD4000
          GOTO      UAUD9999
.
UAUD1000  UNPACK    KEY12,PMCAOCLM,PMCANCLM    * Old/New Claim code
          GOTO      UAUD5000
.
UAUD2000  UNPACK    KEY12,PMCAOHFN,PMCANHFN  * Old/New HF
          UNPACK    KEY16,PMCAOHFT,PMCANHFT  * Old/New HF Table
          GOTO      UAUD5000
.
UAUD3000  UNPACK    KEY12,PMCAOATY,PMCANATY  * Old/New Admission type
          GOTO      UAUD5000
.
UAUD4000  UNPACK    KEY12,PMCAOCLM,PMCANCLM    * Old/New Claim code
          UNPACK    KEY12A,PMCAOHFN,PMCANHFN   * Old/New HF
          UNPACK    KEY16,PMCAOHFT,PMCANHFT    * Old/New HF Table
.
UAUD5000  MOVE      AADMNO,PMCAVISN        * Admission number
          PACK      PMCADATE,CCC,CYY,CMM,CDD
          REP       " 0",PMCADATE
          CLOCK     TIME,PMCATIME
.
          PACK      KEY24,PMCAVISN,PMCADATE,PMCATIME
          CALL      RAPMCAU1
          IF        OVRCD=1
            MOVE      USERID,PMCAWBID        * web user id
            CALL      WRPMCAU1               * write a new record
            GOTO      UAUD9999
          ENDIF
.
.         If record already exit, just update the new code
.
          CALL      RDPMCAU1
          BRANCH    OVRCD,UAUD9999
          IF        F1=1
            UNPACK    KEY12,KEY3,PMCANCLM    * Old/New Claim code
          ELSE
            IF        F1=2
              UNPACK    KEY12,KEY6,PMCANHFN  * Old/New HF
            ENDIF
          ENDIF
          MOVE      USERID,PMCAWBID
          CALL      UPPMCAU1
UAUD9999  RETURN
+
.-----------------------------------------------------------------------------
.         If patient changed to non-comp. claim, delete any claim details
.-----------------------------------------------------------------------------
.
.         Set the claim type indicator if this is a claim
.
DOCLMN00  PACK      KEY5,CODECL,ACLAIM
          CALL      RDCODE1
          BRANCH    OVRCD,DOCLMN99
.
.         Check the indicators for a W, M, or V (these are the claims)
.
          MOVE      ZERO,FORM2
DOCLMN10  ADD       ONE,FORM2
          COMPARE   SIX,FORM2
          GOTO      DOCLMN90 IF NOT LESS
.
          LOAD      ANS,FORM2,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
          CMATCH    "W",ANS
          GOTO      DOCLMN99 IF EQUAL
          CMATCH    "M",ANS
          GOTO      DOCLMN99 IF EQUAL
          CMATCH    "V",ANS
          GOTO      DOCLMN99 IF EQUAL
          CMATCH    "C",ANS
          GOTO      DOCLMN99 IF EQUAL
          GOTO      DOCLMN10
.
DOCLMN90  OPEN      PATWC1A1,"patwc1af"
          OPEN      PMSWX1A1,"pmswx1af"
          OPEN      PATWMAB1,"patwmabf"
          OPEN      PATWVET1,"patwvetf"
          OPEN      PMSCTCA1,"pmsctcaf"
.
          CALL      DEWCOM00         * Delete Workers Comp.
          CALL      DEWMAB00         * Delete TAC
          CALL      DEWVET00         * Delete Veteran affairs
          CALL      DEWCTC00         * Delete Civil Tort
.
DOCLMN99  RETURN
+
.-----------------------------------------------------------------------------
.         Delete Workers comp. details
.-----------------------------------------------------------------------------
.
DEWCOM00  COMPARE   ONE,PTCNHDPS           * Is it for NZ?
          GOTO      DEWCOM10 IF NOT EQUAL  * Not NZ; proceed to delete WC record
.
          MOVE      AURNO,CHWCURNO
          MOVE      AADMNO,CHWCADMN
          PROC      CHKWCCLM           * check for multiple WC claims records
          BRANCH    EXIT,DEWCOM10
.
.         Only one record with the ACC number, so we just update the
.         Claim Status to "Cancelled" instead of deleting the patwc1af record.
.
          COMPARE   ONE,FORM1            * one record found in CHKWCCLM
          IF        @EQUAL
            MOVE      AADMNO,KEY8
            CALL      RDPMWX11
            BRANCH    OVRCD,DEWCOM99
.
            MOVE      THREE,PMWXCSTA     * set Claim Status to "Cancelled"
            CALL      UPPMWX11
          ENDIF
          CALL      MVACCREM           * Add record ACC Audit file
          GOTO      DEWCOM99
.
DEWCOM10  MOVE      AADMNO,KEY8
          CALL      RDWCOM1
          COMPARE   ZERO,OVRCD
          IF        @EQUAL
            COMPARE   ONE,PTCNHDPS
            IF        @EQUAL
              CALL      MVACCREM           * Add record ACC Audit file
            ENDIF
            CALL      DEWCOM1
.
.           If we are sending ACC details in PV1-20, then we need to
.           trigger an A08 message for the visit to reflect that this is
.           no longer an ACC patient
.
            MATCH     "1",PTCNH7AC
            IF        @EQUAL
.
.             Get the last transfer record for the patient before sending
.             an update (A08) message (Task: 0823644)
.
              MOVE      SAVKEY30,KEY30
              CALL      RDTRAN2
              IF        OVRCD = 0
                CALL      PMIGTNID             * get national id for dgate write
                MOVE      NMPNUMB,PTNINMPI
                MOVE      TWENTY7,HL7TRGID
                MOVE      SP8,HL7INCLD
                PROC      DGCLICAC               * send update admission details
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      AADMNO,KEY8
          CALL      RDPMWX11
          COMPARE   ZERO,OVRCD
          CALL      DEPMWX11 IF EQUAL
.
DEWCOM99  RETURN
+
.-----------------------------------------------------------------------------
.         Delete TAC details
.-----------------------------------------------------------------------------
.
DEWMAB00  MOVE      AADMNO,KEY8
          CALL      RDWMAB1
          COMPARE   ZERO,OVRCD
          CALL      DEWMAB1 IF EQUAL
.
DEWMAB99  RETURN
+
.-----------------------------------------------------------------------------
.         Delete Veteran Affairs details
.-----------------------------------------------------------------------------
.
DEWVET00  MOVE      AADMNO,KEY8
          CALL      RDWVET1
          COMPARE   ZERO,OVRCD
          CALL      DEWVET1 IF EQUAL
.
DEWVET99  RETURN
+
.-----------------------------------------------------------------------------
.         Delete Civil Tort details
.-----------------------------------------------------------------------------
.
DEWCTC00  MOVE      AADMNO,KEY8
          CALL      RDPMCTC1
          COMPARE   ZERO,OVRCD
          CALL      DEPMCTC1 IF EQUAL
.
DEWCTC99  RETURN
+
.-----------------------------------------------------------------------------
. Add record to ACC Audit file when patient changed to non-comp. claim
.-----------------------------------------------------------------------------
MVACCREM  PACK      KEY8,ADMISSNO,SP70
          CALL      RDWCOM1
          BRANCH    OVRCD,MVACCR99
.
          CALL      CLACCAUD
          MATCH     WCCLMNO,Z70
          IF        !@EQUAL
            MOVE      WCCLMNO,ACAUCLMN              * Claim Number
          ENDIF
.
          CALL      IBACLOCK
          PACK      ACAUDATE,CCC,CYY,CMM,CDD        * Date
          REP       " 0",ACAUDATE
          MOVE      CTIMEIS,ACAUTIME
          MOVE      USERID,ACAUWUID                 * Web UserId
.
          MATCH     ADMISSNO,Z70
          IF        !@EQUAL
            MOVE      ADMISSNO,ACAUADMN             * Admission No
          ENDIF
.
          MOVE      "D",ACAUAUTY                    * Audit Type
          MOVE      "A",ACAUTREC                    * ACC Type of Record
.
MVACCR10  PACK      KEY54,ACAUCLMN,ACAUADMN,ACAUDATE,ACAUTIME,ACAUWUID
          CALL      RAACAUD1
          IF        OVRCD=1
            CALL      WRACAUD1
            GOTO      MVACCR99
          ELSE
            CALL      IBACLOCK                    * Set new date and time and
            PACK      ACAUDATE,CCC,CYY,CMM,CDD    * try write again
            REP       " 0",ACAUDATE
            CLOCK     TIME,CTIMEIS
            PACK      ACAUTIME,CTIMEIS
            REP       " 0",ACAUTIME
            GOTO      MVACCR10
          ENDIF
.
MVACCR99  RETURN
.------------------------------------------------------------
. Update bed fees on transfer file
.------------------------------------------------------------
UBFE0000  BRANCH    ADSCHI,UBFE9999           * Printed disharged invoice
          COMPARE   ZERO,AINVPRT
          GOTO      UBFE9999 IF NOT EQUAL     * Invoice printed
.
          MOVE      SP70,STMOVE
          PACK      KEY30,AADMNO,SP20,SP10
          CALL      RDSTRAN2
UBFE2000  CALL      RDKTRAN2
          BRANCH    OVRCD,UBFE4000
.
          MATCH     TADMN,AADMNO
          GOTO      UBFE4000 IF NOT EQUAL
.
          PACK      NEWTDATE,TDATE
          MOVE      TWARD,NEWTWARD
          MOVE      TATYPE,NEWTATYP
          MOVE      TRBTYP,NEWTBTYP
          MOVE      TCHSTAT,NEWTCHST
          MOVE      TDEPT,NEWTDEPT
          CALL      BRAT0000
          MOVE      SAVEND,TRBEND
          MOVE      ADDEND,PTTRAEND
          MOVE      SAVPAT,TRATEF
          MOVE      SAVHF,TRATEH
          PACK      TRCDATE,CCC,CYY,CMM,CDD
          REP       " 0",TRCDATE
          CLOCK     TIME,TRCTIME
          MOVE      WBSEUID,PTTRUUID
.
          CALL      UPTRAN2
.
          GOTO      UBFE2000
.
.         Check if pending record need to be added
.
UBFE4000  MOVE      NEWTDATE,PENDSDAT     * as at date
          MOVE      AADMNO,PVIBILL
          CALL      IPEN0000              * write a record to pending file
.
UBFE9999  RETURN
+
.------------------------------------------------------------
. VALID000 - Validate admission number
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
.
VALID000  MOVE      ADMISSNO,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD,VALID900         * Admission not on visit file
.
          CALL      RDPMVX11
          BRANCH    OVRCD,VALID905
.
          COMPARE   THREE,PVITYPE
          GOTO      VALID910 IF NOT EQUAL
.
          MOVE      PVIBILL,KEY8
          CALL      RDPTMIS1                     * admission record found ?
          BRANCH    OVRCD,VALID900:              * no
                          VALID920               * yes - already locked
.
          IF        ALWLEAVE=1
            BRANCH    ASTAT,VALID930,VALID100,VALID100,VALID050,VALID950
          ELSE
            BRANCH    ASTAT,VALID930,VALID100,VALID100,VALID940,VALID950
          ENDIF
          GOTO      VALID900
.
. currently on leave - 
. check if allowed to update while on leave - leave type ind 5=D
VALID050  PACK      KEY30,AADMNO,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,VALID900
.
          MATCH     TADMN,AADMNO
          GOTO      VALID900 IF NOT EQUAL
.
          MATCH     ANSL,TMOVE             * Leave
          GOTO      VALID100 IF NOT EQUAL
.
          MATCH     SP70,PTTRLTYP
          GOTO      VALID940 IF EQUAL
.
          PACK      KEY5,ANST,ANSL,PTTRLTYP,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,VALID940
.
          MATCH     ANSD,TCINDC5
          GOTO      VALID940 IF NOT EQUAL
.
          GOTO      VALID100
.
VALID100  MOVE      SP8,DDATE               * Default date if not discharged
          MOVE      PVIBILL,KEY8
          CALL      RDDSCH1
.
          MOVE      PVIURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,VALID960
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          CALL      GASF0000                * Get admis SFA file stuff
.
          MOVE      ADMISSNO,KEY8
          CALL      UUPTMIS1
          MOVE      ZERO,EXIT
          GOTO      VALID999
.
VALID900  MOVE      "Invalid Admission Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VALID999
.
VALID905  MOVE      "Missing visit extension",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VALID999
.
VALID910  MOVE      "Patient is Not an Inpatient",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VALID999
.
VALID920  CLEAR     WEBTITLE
          APPEND    "Admission locked on port ",WEBTITLE
          APPEND    APORT,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VALID999
.
VALID930  MOVE      "Patient is a Pre-Admission",WEBTITLE
          CALL      WEBERR00
          MOVE      ADMISSNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      VALID999
.
VALID940  MOVE      "Patient is Currently On Leave ",WEBTITLE
          CALL      WEBERR00
          MOVE      ADMISSNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      VALID999
.
VALID950  MOVE      "Pre-Admission is Cancelled ",WEBTITLE
          CALL      WEBERR00
          MOVE      ADMISSNO,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      VALID999
.
VALID960  MOVE      "Missing PMI record. Contact IBA",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          MOVE      ADMISSNO,KEY8
          CALL      UUPTMIS1
          GOTO      VALID999
.
VALID999  RETURN
+
.------------------------------------------------------------
.       Check if it is a claim or non-claim code
.------------------------------------------------------------
.
CHKCL000  UNPACK    SP5,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
          MOVE      ZERO,CLMFLG
          PACK      KEY5,CODECL,SACLAIM
          CALL      RDCODE1
.
          MOVE      ZERO,FORM2
CHKCL100  ADD       ONE,FORM2
          COMPARE   SIX,FORM2
          GOTO      CHKCL999 IF NOT LESS
.
          LOAD      ANS,FORM2,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
.
          CMATCH    "W",ANS
          GOTO      CHKCL200 IF EQUAL
.
          CMATCH    "M",ANS
          GOTO      CHKCL200 IF EQUAL
.
          CMATCH    "V",ANS
          GOTO      CHKCL200 IF EQUAL
          GOTO      CHKCL100
.
CHKCL200  MOVE      ONE,CLMFLG            * claim flag
.
CHKCL999  RETURN
+
.------------------------------------------------------------
. CURDS000 - Find current doctor/specialty
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
.
CURDS000  MOVE      SP6,OADOCTA
          MOVE      SP3,OATYPE
          MOVE      SP70,OACLAIM
          MOVE      SP3,OAUNIT
          MOVE      SP5,OATEAM
          MOVE      SP10,OARSTR
          MOVE      SP10,OARESI
.
          PACK       KEY30,ADMISSNO,TRANDATE,TRANTIME,SP30
          CALL       RDSTRAN2
          CALL       RDKTRAN2
          BRANCH     OVRCD,CURDS100
.
          MATCH      TADMN,AADMNO
          GOTO       CURDS100 IF NOT EQUAL
.
.... I CAR 48096 using hidden CTADMVAR passed in from template(patweb9603012) to
....             decide whether to update Admission record in pattranf
          MOVE      ZERO,ADMREC
          IF        CTADMVAR = 1
            MOVE      ONE,ADMREC
            GOTO      CURDS100
          ENDIF
.... End I
          MATCH      TDATE,TRANDATE
          GOTO       CURDS100 IF NOT EQUAL
.
          MATCH      TTIME,TRANTIME
          GOTO       CURDS100 IF NOT EQUAL
.
          GOTO       CURDS905
.
CURDS100  PACK      KEY30,ADMISSNO,TRANDATE,TRANTIME,SP70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          IF        OVRCD = 1
            COMPARE   ONE,ADMREC           * is this the admission transfer ?
            GOTO      CURDS200 IF NOT EQUAL
            CALL      RDKTRAN2             * read forward to get "A" record
            BRANCH    OVRCD,CURDS200
            MATCH     AADMNO,TADMN
            GOTO      CURDS200 IF NOT EQUAL
          ENDIF
          MATCH      AADMNO,TADMN
          IF         !@EQUAL 
            COMPARE   ONE,ADMREC           * is this the admission transfer ?
            GOTO      CURDS200 IF NOT EQUAL
            CALL      RDKTRAN2             * read forward to get "A" record
            BRANCH    OVRCD,CURDS200
            MATCH     AADMNO,TADMN
            GOTO      CURDS200 IF NOT EQUAL
          ENDIF
.
          MOVE      TADOCT,OADOCTA         * Default attending doctor
          MOVE      TATYPE,OATYPE
          MOVE      PTTRCLTY,OACLAIM
          MOVE      TDEPT,OAUNIT
          MOVE      PTTRTEAM,OATEAM
          MOVE      PTTRRSTR,OARSTR
          MOVE      PTTRRESI,OARESI
          MOVE      OADOCTA,NADOCTA
          MOVE      OATYPE,NATYPE
          MOVE      OACLAIM,NTRCLTY
          MOVE      OAUNIT,NAUNIT
          MOVE      OATEAM,NATEAM
          MOVE      OARSTR,NARSTR
          MOVE      OARESI,NARESI
          GOTO      CURDS900
.
.         No data found in transfer file (should never occur). Use the data
.         from the admission record
.
CURDS200  MOVE      ADOCTA,OADOCTA         * Default attending doctor
          MOVE      ATYPE,OATYPE
          MOVE      ACLAIM,OACLAIM
          MOVE      ACLSSFT,OAUNIT
          MOVE      PMVXTEAM,OATEAM
          MOVE      PMVXEDC3,OARSTR
          MOVE      PMVXEDC2,OARESI
          MOVE      OADOCTA,NADOCTA
          MOVE      OATYPE,NATYPE
          MOVE      OACLAIM,NTRCLTY
          MOVE      OAUNIT,NAUNIT
          MOVE      OATEAM,NATEAM
          MOVE      OARSTR,NARSTR
          MOVE      OARESI,NARESI
.
CURDS900  MOVE      ZERO,EXIT
          GOTO      CURDS999
.
CURDS905  CLEAR     WEBTITLE
          APPEND    "Previous movement at this time",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
CURDS910  MOVE      ONE,EXIT
          GOTO      CURDS999
.
CURDS999  RETURN
+
.------------------------------------------------------------
. PADC0000 - from IBAPMS03
. Update Attending Doctor Specialty
. Returns:  EXIT   0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
.
PADC0000  MOVE      ZERO,CHGDOC
          MOVE      ZERO,CHGTYP
          MOVE      ZERO,CHGUNT
          MOVE      ZERO,CHGTEM
          MOVE      ZERO,CHGRST
          MOVE      ZERO,CHGRES
          MOVE      ZERO,CHGFIN
          MOVE      ZERO,CHGCASET
.
.         Check if Financial Election/Claim code changed
.
          MATCH     FINANELC,SP70
          IF        !@EQUAL
            MATCH     FINANELC,PTTRCLTY
            IF        !@EQUAL
              MOVE      ONE,F1                       * Change Claim code
              PACK      KEY12,PTTRCLTY,FINANELC,SP70 * Old and New Claim code
              CALL      UAUD0000
.
              MOVE      FINANELC,NTRCLTY
              MOVE      ONE,CHGFIN
              GOTO      PADC0100
            ENDIF
          ENDIF
.
          MATCH     PTASF001,Z70
          IF        !@EQUAL
            MOVE      PTASF001,PTAFCTYP
            MOVE      ONE,ASFFLG
          ENDIF
.
          MATCH     PTASF002,Z70
          IF        !@EQUAL
            MOVE      PTASF002,PTAFCROL
            MOVE      ONE,ASFFLG
          ENDIF
.
          MATCH     PTASF003,Z70
          IF        !@EQUAL
            MOVE      PTASF003,PTAFCSID
            MOVE      ONE,ASFFLG
          ENDIF
.
          MATCH     TRNADOCT,SP70
          IF        !@EQUAL
            MATCH     TRNADOCT,TADOCT
            IF        !@EQUAL
              MOVE      ONE,CHGDOC
              MOVE      TRNADOCT,NADOCTA
            ENDIF
          ENDIF
.
          MATCH     TRNCASET,SP70
          IF        !@EQUAL
            MATCH     TRNCASET,PMVXCASE
            IF        !@EQUAL
              MOVE      ONE,CHGCASET
              MOVE      TRNCASET,NTRCASET
            ENDIF
          ENDIF
.
          MATCH     SPECIALT,SP70
          IF        !@EQUAL
            MATCH     SPECIALT,TATYPE
            IF        !@EQUAL
              MOVE      THREE,F1                     * Change Adm.type
              PACK      KEY12,TATYPE,SPECIALT,SP70   * Old and New Claim code
              CALL      UAUD0000
.
              MOVE      SPECIALT,NATYPE
              MOVE      ONE,CHGTYP
              MOVE      "03",HDPEQUIV
            ENDIF
          ENDIF
.
          MATCH     CHNGUNIT,SP70
          IF        !@EQUAL
            MATCH     CHNGUNIT,TDEPT
            IF        !@EQUAL
              MOVE      CHNGUNIT,NAUNIT
              MOVE      ONE,CHGUNT
.
              PACK      KEY5,ANSA,ANSC,CHNGUNIT,SP70
              CALL      RDCODE1
              IF        OVRCD=0
                MATCH     ANSP,TCINDC5
                IF        @EQUAL
                  MOVE      ONE,MHTRAN
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     CHNGTEAM,Z70
          IF        !@EQUAL
            MATCH     CHNGTEAM,PTTRTEAM
            IF        !@EQUAL
              MOVE      CHNGTEAM,NATEAM
              MOVE      ONE,CHGTEM
            ENDIF
          ENDIF
.
          MATCH     CHNGRSTR,Z70
          IF        !@EQUAL
            MATCH     CHNGRSTR,PTTRRSTR
            IF        !@EQUAL
              MOVE      CHNGRSTR,NARSTR
              MOVE      ONE,CHGRST
            ENDIF
          ENDIF
.
          MATCH     CHNGRESI,Z70
          IF        !@EQUAL
            MATCH     CHNGRESI,PTTRRESI
            IF        !@EQUAL
              MOVE      CHNGRESI,NARESI
              MOVE      ONE,CHGRES
            ENDIF
          ENDIF
.
          MOVE      NATYPE,ATYPE          * New attending doctor
          CALL      WASF0000              * Write admin SFA file stuff
.
          IF        CHGDOC=0 & CHGTYP=0 & CHGUNT=0 & CHGTEM=0 & CHGRST=0 & CHGRES=0 & CHGCASET=0
            GOTO      PADC9000              * nothing changed
          ENDIF
.
.
.         Another piece of ugliness!!
.         Because this section updates all tran records (for the admission)
.         from the new date onwards, we have to get the first record for the
.         new date.  If a record is found, then this episode number will be
.         used.  If no record is found, then the episode # defaults to zero
.         and will be set later in the code
.
PADC0100  MOVE      ZERO,DISREC
.
. ------- determine if directly before discharge record - UK.
.
          IF        PTCNCHAL = 1
            CALL      CHKD0000               * check for discharge
          ENDIF
.
          BRANCH    CHGFIN,PADC0180          * changing claim code
.
. ------- determine if we are changing the admission record - UK.
.
          IF        PTCNCHSD = 1 & ADMREC = 1
            CALL      GETA0000               * get the tran adm record
            BRANCH    EXIT,PADC9800
            GOTO      PADC1500
          ENDIF
.
.-------- get the first record in the transaction file for the new date so
.         that we can determine the new episode number. This is only required
.         when PTCNCHSD is Yes. ie. Changing all trans on date of change.
.
          MOVE      ZERO,TMPEPNO
          IF        PTCNUCEP = 1 & PTCNCHSD = 0
            CALL      GETR0000
          ENDIF
.
.-------- Find the record just before where the new transfer record is to -----
.         be inserted. This record will be used as the default record for the
.         fields not being altered by this option
.
PADC0180  PACK      KEY30,PVIBILL,TRANDATE,TRANTIME,SP30
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,PADC0200
.
          MATCH     TADMN,PVIBILL
          GOTO      PADC1000 IF EQUAL
.
.         The previous record is missing. This should never occur so it doesn't
.         matter if we do some strange things to get the info we need.
.         The Exception being Dudley as they can change the admission record.
.
PADC0200  PACK      KEY30,PVIBILL,SP30
          CALL      RDSTRAN2
          CALL      RDKTRAN2
          BRANCH    OVRCD,PADC0300
.
          MATCH     TADMN,PVIBILL
          GOTO      PADC0300 IF NOT EQUAL
.
          GOTO      PADC1000
.
PADC0300  IF        CHGFIN=1
            CALL      CLPATTRN
          ENDIF
          MOVE      AWARD,TWARD
          MOVE      ABED,TBED
          MOVE      PVIBILL,TADMN
          MOVE      PVIURNO,TURNO
          MOVE      ZERO,TALLW
          MOVE      ZERO,TDISC
          MOVE      SP3,TRBTYP
          MOVE      "999",TRBEND
          MOVE      SP3,TCHSTAT
.
.-------- Write the new transfer file record ---------------------------------
.
PADC1000  MOVE      TRANDATE,TDATE            * Write record on last accom. date
          PACK      TTIME,TRANTIME,COLON,ZERO,ONE
.
          BRANCH    CHGFIN,PADC1600           * Changing Financial Election/Clm
.
          IF        PTCNUCEP = 1
            IF        TMPEPNO > 0
.
. ----------- there is a record on same day (but before) so use episode calced.
.
              MOVE      TMPEPNO,PTTREPNO
            ELSE
.
. ----------- there is NOT a record on same day so use default episode calced.
.
              MATCH     NADOCTA,OADOCTA      * same doctor ?
              IF        !@EQUAL
                ADD       ONE,PTTREPNO
              ENDIF
            ENDIF
          ENDIF
.
PADC1500  MOVE      NADOCTA,TADOCT          * New attending doctor
          MOVE      NATYPE,TATYPE
          MOVE      NTRCLTY,PTTRCLTY
          MOVE      NAUNIT,TDEPT
          MOVE      NATEAM,PTTRTEAM
          MOVE      NARSTR,PTTRRSTR
          MOVE      NARESI,PTTRRESI
          MOVE      PTTREPNO,TMPEPNO
          MOVE      NTRCASET,PTTRCASE       * New Case Team
.
          MOVE      SP3,PTTRLTYP            * clear type of leave value
.
.         We have a record to be written. Find the new rate if this period
.         has not already been invoiced.
.
          MATCH     ALACDTE,TRANDATE
          CALL      NEWR0000 IF NOT LESS    * Get the new rates if possible
          GOTO      PADC1800
.
PADC1600  MOVE      NTRCLTY,PTTRCLTY
.
PADC1800  PACK      KEY30,TADMN,TDATE,TTIME,TWARD,TBED,SP70
          MOVE      KEY30,DIM30
          CALL      RDATRAN2                 * Write this new record
          IF        OVRCD = 0
            PACK      TRCDATE,CCC,CYY,CMM,CDD
            REP       " 0",TRCDATE
            CLOCK     TIME,TRCTIME
            MOVE      WBSEUID,PTTRUUID
            CALL      UPTRAN2                 * Write this new record
          ELSE
            MOVE      ZERO,PTTREPSD
            MOVE      PASSCODE,PTTROPER       * operator Id
            MOVE      ANSC,TMOVE
            PACK      PTTRCDAT,CCC,CYY,CMM,CDD
            REP       " 0",PTTRCDAT
            CLOCK     TIME,PTTRCTIM
            MOVE      WBSEUID,PTTRUCID
            UNPACK    SP70,TRCDATE,TRCTIME,PTTRUUID
            PACK      KEY30,TADMN,TDATE,TTIME,TWARD,TBED,SP70
            CALL      RDATRAN2
            IF        OVRCD=1
              CALL      WRTRAN2
            ELSE
              DISPLAY   "I*D transfer key PADC1800 ",KEY30
            ENDIF
          ENDIF
.
          MOVE      TRATEF,STRATEF         * save Basic rate          *I-130245
          MOVE      TRATEH,STRATEH         * save Rebate rate
          MOVE      TRATEG,STRATEG         * save Government
          MOVE      TEXTRA,STEXTRA         * save Extra rate          *I-130245
.
.         Now update all records from this point on with the new data.
.
.         The real ugliness occurs when a transfer record is being inserted
.         on the same date as an existing record, but with a later time.  If
.         the doctor has changed, then when we position on the date alone, we
.         will be on the record prior to the one being inserted.  This means
.         that the doctor will be updated and consequently, the episode number
.         will also need to be updated.  Ledge said to do it this way for the
.         time being.  (Evidently the program has to position on the first
.         record for that date because if the patient classification or
.         department have changed this will change the rate for that day - as
.         a result, the attending doctor gets updated as well)
.
. ------- Do we want to post the new doctor to all records on the same day
.         (but before) the record which has been inserted.
.
          IF        PTCNCHSD = 0
            CALL      PONC0000              * post to transfer records
            MOVE      TRANDATE,TDATE
            PACK      TTIME,TRANTIME,COLON,ZERO,ONE
          ENDIF
.
. ------- Do we want to post the new consultant to all records following the
.         record which has been inserted.
.
          IF        PTCNCHAL = 0
            CALL      PAFC0000              * post to transfer records
          ELSE
            IF        DISREC = 1
              CALL      PDIC0000              * post to tran discharge
            ELSE
              CALL      FIXE0000              * fix episodes in tran
            ENDIF
          ENDIF
          MOVE        TRANDATE,TDATE
          PACK        TTIME,TRANTIME,COLON,ZERO,ONE
.
.         We have finished updating the transfer file with the new data.
.         Now post the data to the admissions file
.
.-------- only update the admission record if the last transfer record -------
.         was changed.
.
PADC3000  MOVE      "19 ",ALTTYPE
          MOVE      SP70,ALTOLDVL
          MOVE      SP70,ALTNEWVL
          CALL      WEAL0000                * Write EDWARD alteration record
          IF        PTCNCHAL = 1 & DISREC = 0
.
. --------- check if this is the last record for the admission --------
.
            MOVE      DIM30,KEY30
            CALL      RDSTRAN2
            CALL      RDKTRAN2
            IF        OVRCD=0
              MATCH     TADMN,PVIBILL
              IF        @EQUAL
                MATCH     ANSD,TMOVE
                GOTO      PADC3100 IF NOT EQUAL
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      PVIBILL,KEY8
          CALL      RDMISS1
.
          BRANCH    CHGFIN,PADC3060       * Change new claim code
.
          COMPARE   ONE,CHGDOC
          IF        @EQUAL
            MOVE      NADOCTA,ADOCTA         * New attending doctor
          ENDIF
.
          COMPARE   ONE,CHGCASET
          IF        @EQUAL
             MOVE      NTRCASET,PMVXCASE      * New Case Team
             CALL      UPPMVX11
          ENDIF
.
          MOVE      NATYPE,ATYPE          * New attending doctor
          COMPARE   ONE,CHGUNT
          IF        @EQUAL
            MOVE      NAUNIT,ACLSSFT        * New unit
          ENDIF
          COMPARE   ONE,CHGTEM
          IF        @EQUAL
            MOVE      NATEAM,PMVXTEAM       * New team
          ENDIF
          COMPARE   ONE,CHGRST
          IF        @EQUAL
            MOVE      NARSTR,PMVXEDC3       * New registrar
          ENDIF
          COMPARE   ONE,CHGRES
          IF        @EQUAL
            MOVE      NARESI,PMVXEDC2       * New resident
          ENDIF
          MOVE      TRNTREAT,ADOCTT
.
          GOTO      PADC3080
.
PADC3060  MOVE      ACLAIM,OLDCLTY         * save old claim code
          MOVE      NTRCLTY,ACLAIM         * New claim code
          MOVE      SP70,PMVXFSRC
          MATCH     PTVIS131,Z70          * Checking Funding source
          IF        !@EQUAL
            MOVE      PTVIS131,PMVXFSRC
          ENDIF
          CALL      CPRI0000               * Update Private Insurance details
          CALL      FPRA0000
.
PADC3080  CALL      UPLMISS1
          CALL      CHGNZ000
          CALL      UPMVIT00               * Update Motor Vehicle pmsextaf CL
          BRANCH    CHGFIN,PADC8000
.
.         Update the visit file with the new doctor and patient classification
.         If we have changed the last specialty for the patient.
.
PADC3100  IF        PTCNCHAL = 1 & DISREC = 0
.
. --------- check if this is the last record for the admission --------
.
            MOVE      DIM30,KEY30
            CALL      RDSTRAN2
            CALL      RDKTRAN2
            BRANCH    OVRCD,PADC3200
.
            MATCH     TADMN,PVIBILL
            GOTO      PADC3200 IF NOT EQUAL
.
            GOTO      PADC4000
          ENDIF
.
PADC3200  MOVE      ONE,TCINDC1
          PACK      KEY5,CODEA,NATYPE
          CALL      RDCODE1                * Re-read new pat. class record
          MOVE      TCINDC1,FORM1
          LOAD      FORM1,FORM1,TWO,ONE    * Swap the meaning
.
          MOVE      PVIBILL,KEY8
          CALL      RLPTVIS1                     * visit record found ?
          BRANCH    OVRCD,PADC9100:              * no
                          PADC9200               * yes - already locked
.
          IF        CHGDOC=1
            MOVE      NADOCTA,PVIDOCT        * New attending doctor
          ENDIF
          MOVE      FORM1,PVISTAT
          CALL      UPVISA1
          CALL      UUPTVIS1
          GOTO      PADC4000
.
.         If the new date is the admission date, then we need to update the
.         Admission/Discharge statistics file as well
.
PADC4000  
...       COMPARE   ONE,CHGDOC
...       IF        @EQUAL
...         MOVE      PVIBILL,KEY8
...         CALL      RLPTVIS1              * visit record found ?
...         BRANCH    OVRCD,PADC9100:       * no
...                         PADC9200        * yes - already locked
.
...         MOVE      NADOCTA,PVIDOCT       * New attending doctor
...         CALL      UPVISA1
...         CALL      UUPTVIS1
.
...         CALL      RDMISS1
...         MOVE      NADOCTA,ADOCTA        * New attending doctor
...         CALL      UPLMISS1              * Update admission record with lock
...       ENDIF
.
          MATCH     ADATE,TRANDATE
          IF        @EQUAL
            CALL      USTA0000
            BRANCH    EXIT,PADC9800
          ENDIF
.
.         Finally, update the transfer file with any new rates required by
.         these changes
.
          IF        CHGFEE = ONE
            CALL      UPTRN000            * C CAR 44288
          ENDIF
.
          MOVE      TRANDATE,PENDSDAT     * as at date
.
.         If this is Public hospital, check Invoice pending
.
          IF        CHOSTYP=1 & CFEETYP=0
            CALL      IPEN0000
          ELSE
.
.         If patient is chargeable, check if we have the record in pending file
.
            COMPARE   ONE,CHRGFLAG          * non-zero rate is found
            CALL      IPEN0000 IF EQUAL
          ENDIF
.
.         We have finished posting the changes to all the files. Unlock
.         the admission number
.
PADC8000  MOVE      "Update Successfull",WEBTITLE
PADC9000  MATCH     PTVIS110,Z70
          IF        !@EQUAL
            MOVE      PTVIS110,PMVXPGID
          ENDIF
          MOVE      PVIBILL,KEY8
          CALL      UUPTMIS1
          CALL      UPPMVX11
.
          IF        CHOSTYP=1 & CFEETYP=0
            MOVE      FIVE,PTIPRSTA               * Update bed fees
            MOVE      TRANDATE,PENDSDAT           * as at date
            CALL      CINVP000                    * Check for tobe invoiced
          ENDIF
.
          MOVE      PVIBILL,TADMN
.
          PACK      KEY8,TADMN,SP70
          CALL      RDPTRES1
          IF        OVRCD=1
            CALL      CPTRE100
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      PADC9999
.
PADC9100  CLEAR     WEBTITLE
          APPEND    "Visit record for Admission ",WEBTITLE
          APPEND    PVIBILL,WEBTITLE
          APPEND    " has disappeared. Contact IBA.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      PVIBILL,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      PADC9999
.
PADC9200  CLEAR     WEBTITLE
          APPEND    "Visit ",WEBTITLE
          APPEND    PVIBILL,WEBTITLE
          APPEND    " locked on Port ",WEBTITLE
          APPEND    PVILOCK,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
PADC9800  MOVE      PVIBILL,KEY8
          CALL      UUPTMIS1
          MOVE      ONE,EXIT
          GOTO      PADC9999
.
PADC9999  RETURN
+
.------------------------------------------------------------
.         Update Motor Vehicle Claim Code pmsextaf.PMEXCLAM
.------------------------------------------------------------
UPMVIT00  CALL      CLPMSEXT
          OPEN      PMSEXTA1,"pmsextaf"
          PACK      KEY11,DAADMNO,OLDCLTY,SP70
          CALL      RDPMEXT1
          BRANCH    OVRCD,UPMVIT99
.
          MATCH     "1",PMEXUYN1
          GOTO      UPMVIT99 IF NOT EQUAL
.
          PACK      PMEXCLAM,ACLAIM,SP70    * update MV CL to new primary CL
.
          CALL      UPPMEXT1                * update pmsextaf
.
UPMVIT99  RETURN
+
.------------------------------------------------------------
.         Update Health fund details for WA Private
.------------------------------------------------------------
CPRI0000  MATCH     "1",PTCNXCOM
          GOTO      CPRI9999 IF NOT EQUAL    * Not using Extra compensable
.
          PACK      KEY5,ANSC,ANSL,ACLAIM
          CALL      RDCODE1
          BRANCH    OVRCD,CPRI9999
.
          MATCH     "H",TCINDC1
          GOTO      CPRI9999 IF NOT EQUAL
.
          MOVE      PFUNDH,AFUNDH
          MOVE      PFNDTB,AFNDTB
          MOVE      PFNDMM,PMVXFNDM        * Set Member Number
          MOVE      PMPXHFCN,PMVXCONM
.
CPRI9999  RETURN
+
.------------------------------------------------------------
. IPEN0000 -from IBAPMS03
. Write to invoice pending file if necessary
.------------------------------------------------------------
IPEN0000  COMPARE   ZERO,PTCNIPEN
          GOTO      IPEN9999 IF NOT EQUAL
.
          MOVE      SP70,SAVERHLD                   * init Reason for Hold
          PACK      SAVFRHLD,SP70,SP70
          PACK      KEY8,AADMNO,SP70
          CALL      RDIPEN1
          IF        OVRCD=0
            MOVE      PTIPRHLD,SAVERHLD             * save Reason for Hold
            PACK      SAVFRHLD,PTIPRDES,SP70
          ENDIF
.
          MOVE      FIVE,PTIPRSTA
          IF        UPDATETY=4
             MOVE      EIGHT,PTIPRSTA               * Change Adm.date
          ENDIF
          IF        UPDATETY=5
             MOVE      THREE,PTIPRSTA               * Change Disc.date
          ENDIF
          IF        UPDATETY=6
             MOVE      NINE,PTIPRSTA               * Cancel movement
          ENDIF
.
          IF        CHOSTYP=1 & CFEETYP=0
            CALL      CINVP000                    * Check for tobe invoiced
            GOTO      IPEN9999
          ENDIF
.
          COMPARE   ZERO,AINVPRT
          GOTO      IPEN1000 IF EQUAL
.
          COMPARE   THREE,ASTAT
          GOTO      IPEN1000 IF NOT EQUAL
.
.     Check if the patient has already been invoiced upto the discharged date
.
          MATCH     DDATE,ALACDTE
          GOTO      IPEN9999 IF EQUAL
.
IPEN1000  MOVE      AADMNO,IPADMNO
          MOVE      THREE,IPSYSTM
          MOVE      SP70,IPSITE
.
          MOVE      SP70,PENDHOSP
          IF        IBCNMHOS=1
            MOVE      IPADMNO,KEY8
            CALL      RDPMVX11
            IF        OVRCD=0
              MOVE      PMVXMHOS,PENDHOSP         * Hospital ID
            ENDIF
          ENDIF
          MOVE      " 3",PENDSYST                 * Inpatient
.
          MOVE      ADATE,PENDADAT                * admission date
          MOVE      SP70,PENDDDAT
          IF        ASTAT=3
            MOVE      AADMNO,KEY8
            CALL      RDDSCH1
            IF        OVRCD=0
              MOVE      DDATE,PENDDDAT            * discharged date
            ENDIF
          ENDIF
          MOVE      AFUNDH,PENDFUND
          MOVE      ACLAIM,PENDCLAM
          CALL      IPRH0000
.
          MOVE      SP70,PTIPSVAR
.
          PACK      KEY8,IPADMNO,SP70
          CALL      RAIPEN1
          IF        OVRCD=1
            CALL      WRIPEN1
          ELSE
            MATCH     SP70,PTIPRHLD
            IF        @EQUAL
              MOVE      SAVERHLD,PTIPRHLD          * retain Reason for Hold
            ENDIF
            MATCH     SP70,PTIPRDES
            IF        @EQUAL
              MOVE      SAVFRHLD,PTIPRDES          * retain Reason for Hold text
            ENDIF
            CALL      UPIPEN1
          ENDIF
.
IPEN9999  RETURN
+
.--------------------------------------------------------------------------
.* UPTRN000: Update the transfer file with a new set of rates.            *
.*           Ignore all records before ALACDTE (the last accom. date) as  *
.*           they have already been invoiced, but allow for the inserting *
.*           of a new record on that date to cater for a new rate.        *
.*                                                                        *
.* RETURNS   : CHRGFLAG = 0 if the all the new rates are zero             *
.*                        1 if there is a non-zero rate posted            *
.--------------------------------------------------------------------------
.
UPTRN000  MOVE      ZERO,CHRGFLAG          * Assume nothing is being charged
          MOVE      ONE,NOCHANGE           * Assume we don't need a new record
          MOVE      SP1,STMOVE             * initialise last movement type
.
          PACK      KEY30,PVIBILL,SP30
          CALL      RDSTRAN2
UPTRN100  CALL      RDKTRAN2
          BRANCH    OVRCD,UPTRN800         * Finished processing patient
.
          MATCH     TADMN,PVIBILL
          GOTO      UPTRN800 IF NOT EQUAL  * Finished processing patient
.
.         Is this record outside any invoice period ?
.
          MATCH     CLACDATE,TDATE         * check against starting charge date
          GOTO      UPTRN200 IF LESS
.
          MATCH     ALACDTE,TDATE          * check against previous invoices
          GOTO      UPTRN200 IF LESS
.
.         We have an record outside the invoice period. Check if we have to
.         post a record to allow for a change in rate at the end of the last
.         invoice. We do this by check if a rate change is required, and if
.         so and there is not a record with the same date as ALACDTE, we must
.         write one with ALACDTE as the date.
.
          BRANCH    NOCHANGE,UPTRN300      * No new record needed
.
          MATCH     ALACDTE,TDATE
          GOTO      UPTRN300 IF EQUAL      * This record will get the new rate
.
          MATCH     CLACDATE,TDATE
          GOTO      UPTRN300 IF EQUAL      * This record will get the new rate
.
          MATCH     SP1,STMOVE             * unknown last move ?
          GOTO      UPTRN300 IF EQUAL      * This record will get the new rate
.
          MATCH     ANSL,STMOVE            * last move was going on-leave ?
          GOTO      UPTRN300 IF EQUAL      * This record will get the new rate
.
.         Write a new record to set up the change of rate on the first day
.         of the next invoice
.
          PACK      SAVKEY30,TADMN,TDATE,TTIME,TWARD,TBED
.
          MOVE      ALACDTE,TDATE          * use last accomodate date
          MATCH     CLACDATE,ALACDTE       * check if 1st charging date needed
          GOTO      UPTRN150 IF NOT LESS
.
          MOVE      CLACDATE,TDATE         * use 1st date of charging
.
.         Set up the rest of the record
.
UPTRN150  MOVE      "01:00:00",TTIME       * Dummy time value
.
          IF        ASTAT=3
            MATCH     TDATE,DDATE
            IF        @EQUAL
              MATCH     DTIME,TTIME
              GOTO      UPTRN180 IF NOT LESS
            ELSE
              MATCH     TDATE,DDATE
              GOTO      UPTRN180 IF LESS
            ENDIF
          ENDIF
.
          MOVE      STWARD,TWARD           * Restore old ward
          MOVE      STBED,TBED             * Restore old bed
.
          MOVE      ZERO,TDISC             * Set up discount amount
          MOVE      ZERO,TALLW             * Set up allowance amount
          MOVE      ANSC,TMOVE             * Write a change record
          MOVE      STATYPE,TATYPE         * Restore old admission type
          MOVE      STACLM,PTTRCLTY        * Restore old claim type
          MOVE      STADOCT,TADOCT         * Restore old attending doctor
          MOVE      STATEAM,PTTRTEAM       * Restore old team
          MOVE      STDEPT,TDEPT           * Restore old department
          MOVE      STEPNO,PTTREPNO        * Restore episode number
          MOVE      STRBTYP,TRBTYP         * Restore old bed type
          MOVE      STRBEND,TRBEND         * Restore old ending bed day range
          MOVE      STCHSTAT,TCHSTAT       * Restore old chargable status
          MOVE      PASSCODE,PTTROPER      * operator Id
.
.         We have a record to be updated. Find the new rate
.
          CALL      NEWR0000               * Get the new rates
          MOVE      SP3,PTTRLTYP            * clear type of leave value
.
          PACK      KEY30,TADMN,TDATE,TTIME,TWARD,TBED,SP70
          PACK      PTTRCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTTRCDAT
          CLOCK     TIME,PTTRCTIM
          MOVE      WBSEUID,PTTRUCID
          UNPACK    SP70,TRCDATE,TRCTIME,PTTRUUID
.
          PACK      KEY30,TADMN,TDATE,TTIME,TWARD,TBED,SP70
          CALL      RDATRAN2
          IF        OVRCD=1
            CALL      WRTRAN2
          ELSE
            DISPLAY   "I*D transfer key UPTRN150 ",KEY30
          ENDIF
.
          MOVE      ONE,NOCHANGE           * Set flag to say no new rec needed
.
.         We have posted the new record. Now update the record we had just
.         read in before posting the new record.
.
UPTRN180  MOVE      SAVKEY30,KEY30
          CALL      RDTRAN2                * Re-read last record
          GOTO      UPTRN300               * Continue processing
.
.         We have a record that has already been invoice. Don't update. Just
.         save the details and check if anything needs to be changed.
.
UPTRN200  MOVE      TWARD,STWARD           * Save old ward
          MOVE      TBED,STBED             * Save old bed
          MOVE      TATYPE,STATYPE         * Save old admission type
          MOVE      PTTRCLTY,STACLM        * Save old claim type
          MOVE      TADOCT,STADOCT         * Save old attending doctor
          MOVE      PTTRTEAM,STATEAM       * Save old team
          MOVE      TDEPT,STDEPT           * Save old department
          MOVE      PTTREPNO,STEPNO        * Save episode number
          MOVE      TRBTYP,STRBTYP         * Save old bed type
          MOVE      TRBEND,STRBEND         * Save old ending bed day range
          MOVE      TMOVE,STMOVE           * Save old movement type
.
          MOVE      TRATEF,STRATEF
          MOVE      TEXTRA,STEXTRA
          MOVE      TRATEG,STRATEG
          MOVE      TRATEH,STRATEH
.
          CALL      NEWR0000               * Work out the new rate
.
          COMPARE   TRATEF,STRATEF         * Basic rate changed ?
          GOTO      UPTRN210 IF NOT EQUAL  * Yes, set flag accordingly
.
          COMPARE   TRATEH,STRATEH         * Rebate rate changed ?
          GOTO      UPTRN210 IF NOT EQUAL  * Yes, set flag accordingly
.
          COMPARE   TRATEG,STRATEG         * Government rate changed ?
          GOTO      UPTRN210 IF NOT EQUAL  * Yes, set flag accordingly
.
          COMPARE   TEXTRA,STEXTRA         * Extra rate changed ?
          GOTO      UPTRN210 IF NOT EQUAL  * Yes, set flag accordingly
          MOVE      ONE,NOCHANGE           * No new record needed
          GOTO      UPTRN100               * Get the next record
.
.         The rate should have changed. Remember this so the rate can be
.         changed at the end of the invoiced period
.
UPTRN210  MOVE      ZERO,NOCHANGE          * A new rate record is needed
          GOTO      UPTRN100               * Get the next record
.
.         Update the current record with a new rate
.
UPTRN300  CALL      NEWR0000               * Calculate the new rate
.
          PACK      TRCDATE,CCC,CYY,CMM,CDD
          REP       " 0",TRCDATE
          CLOCK     TIME,TRCTIME
          MOVE      WBSEUID,PTTRUUID
.
          CALL      UPTRAN2                * Update with the new rate
          MOVE      ONE,NOCHANGE           * Don't need to post a new record
          GOTO      UPTRN100               * Get the next record
.
.         Finished looping over transfer file. Check if we have to
.         post a record to allow for a change in rate at the end of the last
.         invoice. We do this by check if a rate change is required, and if
.         so write one with ALACDTE as the date.
.
UPTRN800  BRANCH    NOCHANGE,UPTRN999      * No new record needed
.
          COMPARE   TWO,ASTAT              * Is the patient currently admitted?
          GOTO      UPTRN999 IF NOT EQUAL  * No. Don't need to write a new rec
.
.         Write a new record to set up the change of rate on the first day
.         of the next invoice
.
          MOVE      ALACDTE,TDATE          * use last accomodate date
.
          MATCH     CLACDATE,ALACDTE       * check if 1st charging date needed
          GOTO      UPTRN850 IF NOT LESS
          MOVE      CLACDATE,TDATE         * use 1st date of charging
.
.         Make sure date is not in the future
.
UPTRN850  PACK      XDATE,CCC,CYY,CMM,CDD
          REP       " 0",XDATE
.
          MATCH     TDATE,XDATE
          GOTO      UPTRN999 IF LESS
.
.         Set up the rest of the record
.
          MOVE      PVIBILL,TADMN          * Set up admission number
          MOVE      "01:00:00",TTIME       * Dummy time value
          MOVE      STWARD,TWARD           * Restore old ward
          MOVE      STBED,TBED             * Restore old bed
.
          IF        ASTAT=3
            MATCH     TDATE,DDATE
            IF        @EQUAL
              MATCH     DTIME,TTIME
              GOTO      UPTRN999 IF NOT LESS
            ELSE
              MATCH     TDATE,DDATE
              GOTO      UPTRN999 IF LESS
            ENDIF
          ENDIF
.
          MOVE      PVIURNO,TURNO          * Set up U/R Number
          MOVE      ZERO,TDISC             * Set up discount amount
          MOVE      ZERO,TALLW             * Set up allowance amount
          MOVE      ANSC,TMOVE             * Write a change record
          MOVE      STATYPE,TATYPE         * Restore old admission type
          MOVE      STACLM,PTTRCLTY        * Restore old claim type
          MOVE      STADOCT,TADOCT         * Restore old attending doctor
          MOVE      STATEAM,PTTRTEAM       * Restore old team
          MOVE      STDEPT,TDEPT           * Restore old department
          MOVE      STRBTYP,TRBTYP         * Restore old bed type
          MOVE      STRBEND,TRBEND         * Restore old ending bed day range
          MOVE      STCHSTAT,TCHSTAT       * Restore old chargable status
          MOVE      PASSCODE,PTTROPER       * operator Id
.
.         We have a record to be updated. Find the new rate
.
          CALL      NEWR0000               * Get the new rates
          MOVE      SP3,PTTRLTYP            * clear type of leave value
.
          PACK      KEY30,TADMN,TDATE,TTIME,TWARD,TBED,SP70
          PACK      PTTRCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTTRCDAT
          CLOCK     TIME,PTTRCTIM
          MOVE      WBSEUID,PTTRUCID
          UNPACK    SP70,TRCDATE,TRCTIME,PTTRUUID
.
          PACK      KEY30,TADMN,TDATE,TTIME,TWARD,TBED,SP70
          CALL      RDATRAN2
          IF        OVRCD=1
            CALL      WRTRAN2
          ELSE
            DISPLAY   "I*D transfer key UPTRN999 ",KEY30
          ENDIF
.
UPTRN999  RETURN
+
.------------------------------------------------------------
. NEWR0000 - From IBAPMS03
. Calculate the rate for a transfer record
.------------------------------------------------------------
.
NEWR0000  MOVE      ZERO,CHRGFLAG          * Assume nothing is being charged
          PACK      NEWTDATE,TDATE
          MOVE      TWARD,NEWTWARD
          MOVE      TATYPE,NEWTATYP
          MOVE      TRBTYP,NEWTBTYP
          MOVE      TCHSTAT,NEWTCHST
          MOVE      TDEPT,NEWTDEPT
.
          MOVE      ZERO,TRATEH
          MOVE      ZERO,TRATEF
          CALL      BRAT0000
          MOVE      SAVEND,TRBEND
          MOVE      ADDEND,PTTRAEND
          MOVE      SAVPAT,TRATEF
          MOVE      SAVHF,TRATEH
          MOVE      ADISC,TDISC
          MOVE      ZERO,TALLW
          MOVE      SAVEXTR,TEXTRA
          MOVE      AUSR2,TCHSTAT
.
.         Check if we have a zero rate
.
          COMPARE   ZERO,TRATEH
          GOTO      NEWR8500 IF NOT EQUAL
          COMPARE   ZERO,TRATEF
          GOTO      NEWR8500 IF NOT EQUAL
          COMPARE   ZERO,TEXTRA
          GOTO      NEWR9999 IF EQUAL
.
.         We have a non-zero rate
.
NEWR8500  MOVE      ONE,CHRGFLAG
.
NEWR9999  RETURN
+
.------------------------------------------------------------
. USTA0000 - From IBAPMS03
. Update Admission/Discharge statistics
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
.
USTA0000  MATCH     NATYPE,OATYPE          * Was the admission type changed ?
          GOTO      USTA9000 IF EQUAL      * No
.
.         Subtract off the old admission type
.
          MOVE      OATYPE,ATYPE
          MOVE      "-1",COUNT
          CALL      PSTA0000
          BRANCH    EXIT,USTA9100
.
.         Add the new admission type
.
          MOVE      NATYPE,ATYPE
          MOVE      ONE,COUNT
          CALL      PSTA0000
          BRANCH    EXIT,USTA9100
.
USTA9000  MOVE      ZERO,EXIT
          GOTO      USTA9999
.
USTA9100  MOVE      ONE,EXIT
.
USTA9999  RETURN
+
.------------------------------------------------------------
. PSTA0000  - From IBAPMS03
. Post Adm/Dsch statistic changes
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
.
PSTA0000  MOVE      PVIDATE,CPTDATE        * Admission date
          CALL      GPERD                  * Get the period for the adm date
          BRANCH    EXIT,PSTA9100          * Missing period record
.
          MOVE      DRGYR,SADYEAR          * This financial year
          MOVE      ANSA,SADTYPE           * We want to update adm type stats
          MOVE      ATYPE,SADCODE          * Code to be updated
.
          MOVE      DRGNUM,INDEX
.
          PACK      KEY8,SADYEAR,SADTYPE,SADCODE
          MOVE      "STA",PRXCODE
          CALL      GETSLK00
          CALL      RDSTAD1
          BRANCH    OVRCD,PSTA1000
.
          LOAD      WORK,INDEX,SADMTH1,SADMTH2,SADMTH3,SADMTH4,SADMTH5:
                               SADMTH6,SADMTH7,SADMTH8,SADMTH9,SADMTH10:
                               SADMTH11,SADMTH12,SADMTH13
.
          ADD       COUNT,WORK
.
          STORE     WORK,INDEX,SADMTH1,SADMTH2,SADMTH3,SADMTH4,SADMTH5:
                               SADMTH6,SADMTH7,SADMTH8,SADMTH9,SADMTH10:
                               SADMTH11,SADMTH12,SADMTH13
          CALL      UPSTAD1
          CALL      RELSLK00
          GOTO      PSTA9000
.
.         Write a new PATSTAD1 record
.
PSTA1000  CALL      RELSLK00
          MOVE      ZERO,SADMTH1
          MOVE      ZERO,SADMTH2
          MOVE      ZERO,SADMTH3
          MOVE      ZERO,SADMTH4
          MOVE      ZERO,SADMTH5
          MOVE      ZERO,SADMTH6
          MOVE      ZERO,SADMTH7
          MOVE      ZERO,SADMTH8
          MOVE      ZERO,SADMTH9
          MOVE      ZERO,SADMTH10
          MOVE      ZERO,SADMTH11
          MOVE      ZERO,SADMTH12
          MOVE      ZERO,SADMTH13
          STORE     COUNT,INDEX,SADMTH1,SADMTH2,SADMTH3,SADMTH4,SADMTH5:
                                SADMTH6,SADMTH7,SADMTH8,SADMTH9,SADMTH10:
                                SADMTH11,SADMTH12,SADMTH13
.
          CALL      WRSTAD1
.
PSTA9000  MOVE      ZERO,EXIT
          GOTO      PSTA9999
.
.         Missing date in the period file
.
PSTA9100  UNPACK    CPTDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          CLEAR     WEBTITLE
          APPEND    CPCDATE,WEBTITLE
          APPEND    " missing from period file.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
PSTA9999  RETURN
+
.------------------------------------------------------------
. CHKD0000 - From IBAPMS03
. Check for a Discharge Record
.------------------------------------------------------------
.
CHKD0000    MOVE      ZERO,DISREC
            PACK      KEY30,PVIBILL,TRANDATE,TRANTIME,Z70
            CALL      RDSTRAN2
            CALL      RDKTRAN2
            BRANCH    OVRCD,CHKD9000         * Date/time valid
.
            MATCH     AADMNO,TADMN           * Still the same admission ?
            GOTO      CHKD9000 IF NOT EQUAL  * Date/time valid
.
            MATCH     "D",TMOVE
            GOTO      CHKD9000 IF NOT EQUAL
.
            MOVE      ONE,DISREC
.
CHKD9000    MOVE      ZERO,EXIT
.
CHKD9999    RETURN
+
.------------------------------------------------------------
. GETA0000 - IBAPMS03
. Check for an Admission Record
. Returns:   EXIT  0 = Ok to continue
.                  1 - Error
.------------------------------------------------------------
.
GETA0000  PACK      KEY30,PVIBILL,SP20,SP20
          CALL      RDSTRAN2                     * position on admission
          CALL      RDKTRAN2                     * read next record
          BRANCH    OVRCD,GETA9100               * eof - error
.
          MATCH     AADMNO,TADMN                 * same admission still ?
          GOTO      GETA9100 IF NOT EQUAL        * no - error
.
          MATCH     ANSA,TMOVE                   * admission record ?
          GOTO      GETA9100 IF NOT EQUAL        * no - error
.
          MATCH     TRANDATE,TDATE               * same transfer date ?
          GOTO      GETA9100 IF NOT EQUAL        * no - error
.
          MATCH     TRANTIME,TTIME               * same transfer time ?
          GOTO      GETA9100 IF NOT EQUAL        * no - error
.
          MOVE      ONE,ADMREC
          MOVE      ZERO,EXIT
          GOTO      GETA9999
.
GETA9100  MOVE      "Transfer Admission Record Missing. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
GETA9999  RETURN
+
.------------------------------------------------------------
. GETR0000       Get the first record in the transaction file
.                for the new date so that we can determine the
.                new episode number
.  Returns:   TMPEPNO  = 0    no previous episode on same day
.                     = non-zero  previous episode on same day
.------------------------------------------------------------
.
GETR0000  PACK      KEY30,AADMNO,TRANDATE,SP20,SP20
          CALL      RDSTRAN2                     * position in file
          CALL      RDKTRAN2                     * read next record
          BRANCH    OVRCD,GETR5000               * end of file
.
          MATCH     AADMNO,TADMN                 * same admission number ?
          GOTO      GETR5000 IF NOT EQUAL        * no
.
          MATCH     TRANDATE,TDATE                 * same date ?
          GOTO      GETR5000 IF NOT EQUAL        * no
.
          MATCH     TTIME,TRANTIME               * new time < this time ?
          GOTO      GETR5000 IF LESS             * yes
.
          MOVE      PTTREPNO,TMPEPNO             * save episode number
.
. ------- check if the new consultant is now the same as the record before ---
.
          CALL      RDPTRAN2                     * read next record
          BRANCH    OVRCD,GETR9999               * end of file
.
          MATCH     AADMNO,TADMN                 * same admission number ?
          GOTO      GETR9999 IF NOT EQUAL        * no
.
          MATCH     TADOCT,NADOCTA
          IF        !@EQUAL
            ASSIGN    PTTREPNO+1,TMPEPNO
          ELSE
            MOVE      PTTREPNO,TMPEPNO             * save episode number
          ENDIF
.
          GOTO      GETR9999
.
GETR5000  MOVE      ZERO,TMPEPNO                 * default episode number
.
GETR9999  RETURN
+
.------------------------------------------------------------
. PONC0000 - From IBAPMS03
. Post the doctor    for all tran records on (but before) chg date
.------------------------------------------------------------
.
PONC0000  PACK      KEY30,PVIBILL,TRANDATE,TTIME,Z70
          CALL      RDSTRAN2
PONC1000  CALL      RDPTRAN2
          BRANCH    OVRCD,PONC9999
.
          MATCH     TADMN,PVIBILL           * same Admission Number ?
          GOTO      PONC9999 IF NOT EQUAL   * no
.
          MATCH     TDATE,TRANDATE           * same Admission Number ?
          GOTO      PONC9999 IF NOT EQUAL   * no
.
          BRANCH    CHGFIN,PONC2000         * new financial election/claim type
.
          COMPARE   ONE,CHGDOC
          IF        @EQUAL
            MOVE      NADOCTA,TADOCT           * yes, new admission type
          ENDIF
          MATCH     NATYPE,TATYPE                                     *I-130245
          IF        !@EQUAL
            MOVE      STRATEF,TRATEF
            MOVE      STRATEH,TRATEH
            MOVE      STRATEG,TRATEG
            MOVE      STEXTRA,TEXTRA
          ENDIF                                                       *I-130245
          MOVE      NATYPE,TATYPE            * yes, new admission type
          MOVE      NAUNIT,TDEPT             * yes, new unit
          MOVE      NATEAM,PTTRTEAM          * yes, new team
          MOVE      NARSTR,PTTRRSTR          * yes, new registrar
          MOVE      NARESI,PTTRRESI          * yes, new resident
          MOVE      TMPEPNO,PTTREPNO
          GOTO      PONC2800
.
PONC2000  MOVE      NTRCLTY,PTTRCLTY         * New claim code
.
PONC2800  PACK      TRCDATE,CCC,CYY,CMM,CDD
          REP       " 0",TRCDATE
          CLOCK     TIME,TRCTIME
          MOVE      WBSEUID,PTTRUUID
.
          CALL      UPTRAN2
          GOTO      PONC1000
.
PONC9999  RETURN
+
.------------------------------------------------------------
. PAFC0000 - From IBAPMS03
. Post the consultant for all tran records after the change date
.------------------------------------------------------------
.
PAFC0000  PACK      KEY30,PVIBILL,TRANDATE,TTIME,SP30
          CALL      RDSTRAN2
PAFC1000  CALL      RDKTRAN2
          BRANCH    OVRCD,PAFC9999
.
          MATCH     TADMN,PVIBILL           * same Admission Number ?
          GOTO      PAFC9999 IF NOT EQUAL   * no
.
          BRANCH    CHGFIN,PAFC2000         * Changing Financial election
.
          COMPARE   ONE,CHGDOC
          IF        @EQUAL
            MOVE      NADOCTA,TADOCT          * yes, new admission type
          ENDIF
          MATCH     NATYPE,TATYPE                                     *I-130245
          IF        !@EQUAL
            MOVE      STRATEF,TRATEF
            MOVE      STRATEH,TRATEH
            MOVE      STRATEG,TRATEG
            MOVE      STEXTRA,TEXTRA
          ENDIF                                                       *I-130245
          MOVE      NATYPE,TATYPE          * yes, new admission type
          COMPARE   ONE,CHGUNT
          IF        @EQUAL
            MOVE      NAUNIT,TDEPT           * yes, new unit
          ENDIF
          COMPARE   ONE,CHGTEM
          IF        @EQUAL
            MOVE      NATEAM,PTTRTEAM        * yes, new team
          ENDIF
          COMPARE   ONE,CHGRST
          IF        @EQUAL
            MOVE      NARSTR,PTTRRSTR        * yes, new registrar
          ENDIF
          COMPARE   ONE,CHGRES
          IF        @EQUAL
            MOVE      NARESI,PTTRRESI        * yes, new resident
          ENDIF
          MOVE      TMPEPNO,PTTREPNO
          GOTO      PAFC2800
.
PAFC2000  MOVE      NTRCLTY,PTTRCLTY      * new claim code
.
PAFC2800  PACK      TRCDATE,CCC,CYY,CMM,CDD
          REP       " 0",TRCDATE
          CLOCK     TIME,TRCTIME
          MOVE      WBSEUID,PTTRUUID
.
          CALL      UPTRAN2
          GOTO      PAFC1000
.
PAFC9999  RETURN
+
.------------------------------------------------------------
. PDIC0000 - From IBAPMS03
. Post the consultant to the Discharge record if inserted record
. is immediately before it.
.------------------------------------------------------------
.
. ------- if discharge record is next record update it
.
PDIC0000  PACK      KEY30,TADMN,TDATE,TTIME,Z70
          CALL      RDSTRAN2
          CALL      RDKTRAN2
          BRANCH    OVRCD,PDIC9999
.
          MATCH     TADMN,PVIBILL           * same Admission Number ?
          GOTO      PDIC9999 IF NOT EQUAL   * no
.
          MATCH     "D",TMOVE
          GOTO      PDIC9999 IF NOT EQUAL
.
          BRANCH    CHGFIN,PDIC2000
.
          MOVE      NADOCTA,TADOCT           * yes, new consultant
          MATCH     NATYPE,TATYPE                                     *I-130245
          IF        !@EQUAL
            MOVE      STRATEF,TRATEF
            MOVE      STRATEH,TRATEH
            MOVE      STRATEG,TRATEG
            MOVE      STEXTRA,TEXTRA
          ENDIF                                                       *I-130245
          MOVE      NATYPE,TATYPE           * yes, new consultant
          MOVE      NAUNIT,TDEPT            * yes, new unit
          MOVE      NATEAM,PTTRTEAM         * yes, new team
          MOVE      NARSTR,PTTRRSTR         * yes, new registrar
          MOVE      NARESI,PTTRRESI         * yes, new resident
          MOVE      TMPEPNO,PTTREPNO
          GOTO      PDIC8000
.
PDIC2000  MOVE      NTRCLTY,PTTRCLTY        * new financial election/claim code
.
PDIC8000  PACK      TRCDATE,CCC,CYY,CMM,CDD
          REP       " 0",TRCDATE
          CLOCK     TIME,TRCTIME
          MOVE      WBSEUID,PTTRUUID
.
          CALL      UPTRAN2
.
PDIC9999  RETURN
+
.------------------------------------------------------------
. FIXE0000 - From IBAPMS03
. Fix episodes in the transfer file
.------------------------------------------------------------
.
FIXE0000  BRANCH    CHGFIN,FIXE9999
          MOVE      TMPEPNO,SAVEPNO
          MOVE      NADOCTA,SAVDOCT
          PACK      KEY30,TADMN,TDATE,TTIME,TWARD,TBED
          CALL      RDSTRAN2
FIXE1000  CALL      RDKTRAN2
          BRANCH    OVRCD,FIXE9999
.
          MATCH     TADMN,PVIBILL           * same Admission Number ?
          GOTO      FIXE9999 IF NOT EQUAL   * no
.
          MATCH     TADOCT,SAVDOCT          * doctor changed
          GOTO      FIXE2000 IF EQUAL       * no
.
          ADD       ONE,SAVEPNO
.
FIXE2000  MOVE      SAVEPNO,PTTREPNO
          MOVE      ZERO,PTTREPSD
          PACK      TRCDATE,CCC,CYY,CMM,CDD
          REP       " 0",TRCDATE
          CLOCK     TIME,TRCTIME
          MOVE      WBSEUID,PTTRUUID
.
          CALL      UPTRAN2
.
          MOVE      TADOCT,SAVDOCT
.
          GOTO      FIXE1000
.
FIXE9999  RETURN
+
.------------------------------------------------------------
. ALLBD000 - Allocate a bed from the ward list
.------------------------------------------------------------
.
ALLBD000  MATCH     SP3,WBEDNUMB
          GOTO      ALLBD950 IF EQUAL

          MOVE      BEDTRKEY,KEY30
          CALL      RDTRAN2
          BRANCH    OVRCD,ALLBD900
.
          PACK      KEY8,TURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,ALLBD925
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          PACK      KEY8,TADMN,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,ALLBD920
.
          PACK      KEY30,TADMN,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,ALLBD900
.
.         Check that patient details have not altered
.
          PACK      TESTKEY,TADMN,TDATE,TTIME,TWARD,TBED
          MATCH     TESTKEY,BEDTRKEY
          GOTO      ALLBD910 IF NOT EQUAL
          MOVE      WBEDNUMB,TBED
.
          MOVE      APLUR,NBPLUR                 * No bed record
          PACK      KEY13,AWARD,ADMISSNO,NBPLUR
          CALL      RDNOBE1
          BRANCH    OVRCD,ALLBD940
.
          MOVE      ADMISSNO,KEY8      * Admission file
          CALL      RDPTMIS1
          BRANCH    OVRCD,ALLBD920
          MOVE      WBEDNUMB,ABED
.
          PACK      KEY6,AWARD,WBEDNUMB  * Add admission number to ward/bed file
          CALL      RDWARD1
          BRANCH    OVRCD,ALLBD930
          MOVE      ADMISSNO,WADMNO
.
          COMPARE   ONE,PTCNONLA       * Allow on leave bed?
          GOTO      ALLBD200 IF EQUAL
.
          PACK      KEY14,AWARD,WBEDNUMB,SP70
          CALL      RDSONLV1    * Read Patient On-Leave File
          CALL      RDKONLV1
          BRANCH    OVRCD,ALLBD200
.
          MATCH     AWARD,OWARD
          GOTO      ALLBD200 IF NOT EQUAL
.
          MATCH     WBEDNUMB,OBED
          GOTO      ALLBD200 IF NOT EQUAL
.
          GOTO      ALLBD960 * Record found this Bed is Taken
.
ALLBD200  CALL      UPMISS1
          PACK      TRCDATE,CCC,CYY,CMM,CDD
          REP       " 0",TRCDATE
          CLOCK     TIME,TRCTIME
          MOVE      WBSEUID,PTTRUUID
.
          CALL      UPTRAN2
          CALL      UPWARD1
          CALL      DENOBE1
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPTRES1
          IF        OVRCD=1
            CALL      CPTRE100
          ENDIF
.
.         Broadcast change of admission details
.
          CALL      PMIGTNID                 * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TWENTY9,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICAC
.
. *** added 5 lines below for CAR 305091
          MOVE      TDATE,TRANDATE
          MOVE      TTIME,TRANTIME
          MOVE      TWARD,TRNTOWRD
          MOVE      TBED,TRNTOBED
          MOVE      ASTAY,STAYDAYS
.
          IF        ASTAT=2
            PACK      KEY8,AADMNO,SP70
            CALL      RDPMWOR1
            IF        OVRCD=1
              CALL      CLPMWO00               * Use the expected discharge
            ENDIF                              * date if a current admission
.                                              * instead of TRANDATE plus
            MATCH     SP70,PMWOEDAT            * ASTAY
            IF        !@EQUAL
              DAYSEP    TRANDATE,PMWOEDAT,STAYDAYS
            ENDIF
          ENDIF
.
          CALL      UPPBMN00
          MOVE      AURNO,URNUMBER
          MOVE      AADMNO,ADMISSNO
          PROC      BBUP0000              * Bed Board update
.
ALLBD900  MOVE      "Bed Allocation Successful",WEBTITLE
          MOVE      ZERO,EXIT
          GOTO      ALLBD9999
.
ALLBD910  MOVE      "Patient has moved bed",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLBD999
.
ALLBD920  MOVE      "Invalid Admission number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLBD999
.
ALLBD925  MOVE      "Invalid U/R number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLBD999
.
ALLBD930  MOVE      "Invalid Bed number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLBD999
.
ALLBD940  MOVE      "Invalid No Bed Record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLBD999
.
ALLBD950  MOVE      "Invalid Bed Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ALLBD999
.
ALLBD960  COMPARE   TWO,PTCNONLA
          GOTO      ALLBD970 IF EQUAL
.
          MOVE      "Error: Patient on leave from this bed.",WEBTITLE
          CALL      WEBERR00
ALLBD965  MOVE      ONE,EXIT
          GOTO      ALLBD999
.
ALLBD970  MOVE      "Warning: Patient on leave from this bed.",WEBTITLE
          ADD       ONE,WARCOUNT
          MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
          GOTO      ALLBD200
.
ALLBD999  RETURN
+
.------------------------------------------------------------
. Output key for the last transfer record for a patient
.------------------------------------------------------------
.
TRNK0000  MOVE      SP70,BEDTRKEY
          MOVE      ADMISSNO,KEY8
          PACK      KEY30,KEY8,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,TRNK9000
.
          MATCH     KEY8,TADMN
          GOTO      TRNK9000 IF NOT EQUAL
.
          PACK      BEDTRKEY,TADMN,TDATE,TTIME,TWARD,TBED
.
TRNK9000  WRITE     HTMLFILE;BEDTRKEY;
.
TRNK9999  RETURN
+
.------------------------------------------------------------
. CHKLVE00 - Determine where the "L"eave record lies in pattranf
. Returns:  EXIT  0 = Ok to continue
.                 1 = Error
.           LEAVEFLG 1 = last record in pattranf
.                    2 = second last record in pattranf (last should be return)
.                    3 = neither last nor second last record
.------------------------------------------------------------
.
CHKLVE00  MOVE      ZERO,LEAVEFLG
          MOVE      ZERO,LOOPFLG
          MOVE      ZERO,FNDLFLG
          PACK      SAVKEY30,KEY30
.
          PACK      KEY30,AADMNO,Z70
          CALL      RDSTRAN2
CHKLVE10  CALL      RDPTRAN2
          BRANCH    OVRCD,CHKLVE90
.
          MATCH     AADMNO,TADMN
          GOTO      CHKLVE95 IF NOT EQUAL
.
          MATCH     ANSD,TMOVE
          IF        @EQUAL
            COMPARE   ZERO,LOOPFLG
            IF        @EQUAL
              PACK      ODKEY30,TADMN,TDATE,TTIME,TWARD,TBED
            ENDIF
          ENDIF
.
          ADD       ONE,LOOPFLG
.
          MATCH     ANSL,TMOVE
          IF        @EQUAL
            PACK      KEY30,TADMN,TDATE,TTIME,TWARD,TBED
            MATCH     SAVKEY30,KEY30
            IF        @EQUAL
.
              COMPARE   ONE,LOOPFLG
              IF        @EQUAL
                MOVE      ONE,LEAVEFLG
                GOTO      CHKLVE95
              ENDIF
.
              COMPARE   TWO,LOOPFLG
              IF        @EQUAL
                MOVE      TWO,LEAVEFLG
                GOTO      CHKLVE95
              ENDIF
.
              MOVE     THREE,LEAVEFLG
              GOTO      CHKLVE95
.
            ELSE
              MOVE      ONE,FNDLFLG
            ENDIF
          ENDIF                                  * delete it and its return
.
          GOTO      CHKLVE10
.
CHKLVE90  MOVE      ONE,EXIT                     * Error processing
          GOTO      CHKLVE99
.
CHKLVE95  MOVE      ZERO,EXIT
.
CHKLVE99  RETURN
+
.------------------------------------------------------------
. DELREC00 - Delete the leave record and return from leave record
. Returns:  EXIT  0 = Ok to continue
.                 1 = Error
.------------------------------------------------------------
.
DELREC00  PACK      KEY30,SAVKEY30
          CALL      RDTRAN2
          BRANCH    OVRCD,DELREC90
.
          MATCH     AADMNO,TADMN
          GOTO      DELREC90 IF NOT EQUAL
.
          MATCH     ANSL,TMOVE
          IF        @EQUAL
.
.         Broadcast transfer cancellation to Datagate BEFORE deleting record
.
            PACK      KEY30,AADMNO,STDATE,STTIME,STWARD,STBED
            CALL      RDTRAN2
.
.           As the leave and associated return record are not the last
.           record in the pattranf file for this visit, we don't need to
.           send any broadcast HL7 message as the last transfer record
.           still reflects the current status of the patient/visit
.           - hence the following 2 lines of code have been commented out.
.
.>>>        CALL      CISA12BR                * broadcast A12 to CIS
.>>>        BRANCH    EXIT,DELREC91           * error occurred
.
            PACK      KEY8,AADMNO,SP70
            CALL      RDPTRES1
            IF        OVRCD=1
              CALL      CPTRE100
            ENDIF
.
.           Only broadcast cancel transfer (A12) if using on-leave (A21)
.
            IF        PTCNA21M = 1
              CALL      PMIGTNID              * get national id for dgate write
              MOVE      NMPNUMB,PTNINMPI
              MOVE      THIRTY,HL7TRGID
              MOVE      SP8,HL7INCLD
              PROC      DGCLICCT              * b'cast cancel transfer *C-90222
            ENDIF
.
            PACK      KEY30,TADMN,TDATE,TTIME,TWARD,TBED
            CALL      DETRAN2
            MOVE      "18 ",ALTTYPE
            MOVE      SP70,ALTOLDVL
            MOVE      SP70,ALTNEWVL
            CALL      WEAL0000                * Write EDWARD alteration record
.
            CALL      DLLLR000                * delete leave register
          ENDIF
.
          PACK      KEY30,SAVKEY30
          CALL      RDSTRAN2
          CALL      RDKTRAN2
          BRANCH    OVRCD,DELREC90
.
          MATCH     AADMNO,TADMN
          GOTO      DELREC90 IF NOT EQUAL
.
          MATCH     ANSR,TMOVE
          IF        @EQUAL
.
.         Broadcast transfer cancellation to Datagate BEFORE deleting record
.
            PACK      KEY30,AADMNO,TDATE,TTIME,TWARD,TBED
            CALL      RDTRAN2
.
.           As the leave and associated return record are not the last
.           record in the pattranf file for this visit, we don't need to
.           send any broadcast HL7 message as the last transfer record
.           still reflects the current status of the patient/visit
.           - hence the following 2 lines of code have been commented out.
.
.>>>        CALL      CISA12BR                * broadcast A12 to CIS
.>>>        BRANCH    EXIT,DELREC91           * error occurred
.
            PACK      KEY8,AADMNO,SP70
            CALL      RDPTRES1
            IF        OVRCD=1
              CALL      CPTRE100
            ENDIF
.
.           Only broadcast cancel transfer (A12) if using return-from-leave(A22)
.
            IF        PTCNA22M = 1
              CALL      PMIGTNID              * get national id for dgate write
              MOVE      NMPNUMB,PTNINMPI
              MOVE      THIRTY1,HL7TRGID
              MOVE      SP8,HL7INCLD
              PROC      DGCLICCT              * b'cast cancel transfer *C-90222
            ENDIF
.
            PACK      KEY30,TADMN,TDATE,TTIME,TWARD,TBED
            CALL      DETRAN2
.
            CALL      DLLRT000                * delete leave register
          ENDIF
.
DELREC90  MOVE      ZERO,EXIT
          GOTO      DELREC99
.
DELREC91  MOVE      ONE,EXIT
.
DELREC99  RETURN
+
.-----------------------------------------------------------------------------
. Recalculate all bed fees for this admission
.------------------------------------------------------------------------------
.
CALBFE00  PACK      KEY30,AADMNO,SP70
          CALL      RDSTRAN2                * Looping through transfer file
CALBFE10  CALL      RDKTRAN2
          BRANCH    OVRCD,CALBFE99
.
          MATCH     AADMNO,TADMN
          GOTO      CALBFE99 IF NOT EQUAL
.
          CALL      NEWR0000                * Calculating new rates
          CALL      UPTRN000                * Updating transfer file
.
          GOTO      CALBFE10
.
CALBFE99  RETURN
+
.-----------------------------------------------------------------------------
. GETLDT00 - Get last bed and ward before this return record
.------------------------------------------------------------------------------
.
GETLDT00  MOVE      SP70,LSTWARD
          MOVE      SP70,LSTBED
          MOVE      ZERO,LOOPFLG
          MOVE      SP70,DELKEY30
          MOVE      SP70,ODKEY30
.
          PACK      KEY30,AADMNO,Z70        * Work out what ward and bed the
          CALL      RDSTRAN2                * patient should be on leave from
GETLDT10  CALL      RDPTRAN2                * as we are going to remove the
          BRANCH    OVRCD,GETLDT99          * return from leave record
.
          MATCH     AADMNO,TADMN
          GOTO      GETLDT99 IF NOT EQUAL
          COMPARE   ONE,LOOPFLG
          IF        @EQUAL
            PACK      DELKEY30,TADMN,TDATE,TTIME,TWARD,TBED
          ENDIF
.
          MATCH     ANSL,TMOVE
          GOTO      GETLDT10 IF NOT EQUAL
.
          MOVE      TWARD,LSTWARD
          MOVE      TBED,LSTBED

GETLDT99  RETURN
+
.-----------------------------------------------------------------------------
. GETLBT00 - Get last bed and ward before this leave record
.------------------------------------------------------------------------------
.
GETLBT00  MOVE      SP70,LSTWARD
          MOVE      SP70,LSTBED
.
          PACK      KEY30,AADMNO,Z70        * Work out what ward and bed the
          CALL      RDSTRAN2                * patient should be on leave from
GETLBT10  CALL      RDPTRAN2                * as we are going to remove the
          BRANCH    OVRCD,GETLBT99          * return from leave record
.
          MATCH     AADMNO,TADMN
          GOTO      GETLBT99 IF NOT EQUAL
.
          MATCH     ANSL,TMOVE
          GOTO      GETLBT10 IF EQUAL
.
          MOVE      TWARD,LSTWARD
          MOVE      TBED,LSTBED

GETLBT99  RETURN
+
.-----------------------------------------------------------------------------
.        Subroutine to recalculate the fees for any theatre fees
.------------------------------------------------------------------------------
.
FIXT000  MOVE      SP20,CURSESS
.
         PACK      KEY14,DAADMNO,SP20
         CALL      RSPMMTI1
FIXT100  CALL      RKPMMTI1
         BRANCH    OVRCD,FIXT999
.
         MATCH     PMMIVISN,DAADMNO
         GOTO      FIXT999 IF NOT EQUAL
.
         MOVE      PMMIITEM,TITEMNO
         MOVE      ZERO,FORM1
         MOVE      PMMIRTYP,FORM1
         BRANCH    FORM1,FIXT100,FIXT400,FIXT200
         GOTO      FIXT100
.
.        Fixing miscellaneous record
.
FIXT200  MOVE      PMMIITEM,DIM9
         CALL      GMSC0000            * Get the new miscellaneous charges
         BRANCH    EXIT,FIXT100
.
         MOVE      ZERO,FORM62
         MOVE      MPATPOR,FORM62
         ADD       MHFPOR,FORM62
.
         COMPARE   ZERO,FORM62
         GOTO      FIXT100 IF EQUAL     * Ignore zero amount misc. charges
.
         MOVE      MPATPOR,PMMIAMTP
         MOVE      MHFPOR,PMMIRBAT
.
         MOVE      PMMIAMTP,PMMIAMTT
         ADD       PMMIRBAT,PMMIAMTT
         MULT      PMMISERV,PMMIAMTT
.
FIXT300  PACK      PMMIDUPD,CCC,CYY,CMM,CDD
         REP       " 0",PMMIDUPD
         CALL      IBACLOCK
         MOVE      CTIMEIS,PMMITUPD
         MOVE      WBSEUID,PMMIWUSR
         CALL      UPPMMTI1
         GOTO      FIXT100
.
.        Fixing theatre record
.
FIXT400  MOVE      PMMIITEM,DIM9
         MATCH     ANSY,PTMICMXP                * casemix
         GOTO      FIXT450 IF EQUAL
.
.        Get the MBS item record for this theatre fee
.
         PACK      KEY17,DIM9,PMMITDAT
         CALL      PATITMRD
         COMPARE   ZERO,OVRCD
         GOTO      FIXT450 IF EQUAL
.
         PACK      DIM9,PMMIREFN,SP9
.
FIXT450  PACK      KEY17,DIM9,PMMITDAT
         CALL      PATITMRD
         IF        OVRCD = 1
.
.          If this is casemix, check for valid DRG
.
           MATCH     ANSY,PTMICMXP
           IF        @EQUAL
             OPEN      PATDGWA1,"patdgwaf"
             PACK      KEY4,PMMIITEM,SP5
             PACK      KEY7,KEY4,SP10                                 *I-137125
             CALL      RSPTDGW1
             CALL      RKPTDGW1
             BRANCH    OVRCD,FIXT100
             MATCH     PTDWDRGC,KEY4        * same DRG code ?         *I-137125
             GOTO      FIXT100 IF NOT EQUAL                           *I-137125
             GOTO      FIXT500
           ENDIF
           GOTO      FIXT100
         ENDIF
.
.        Check for multiple items in the same session
.
FIXT500  PACK      DIM18,PMMIVISN,PMMISESS,PMMITDAT
         REP       " 0",DIM18
.
         MATCH     DIM18,CURSESS
         GOTO      FIXT600 IF EQUAL
.
         MOVE      ZERO,FORM1
         MOVE      DIM18,CURSESS
.
.        Check claim code, if MBS Amount is used for charging
.
FIXT600  PACK      KEY5,CODECL,ACLAIM
         CALL      RDCODE1
         IF        OVRCD=0
           MATCH     "2",TCINDC1
           IF        @EQUAL
             PACK      KEY17,PMMIITEM,PMMITDAT
             CALL      PATITMRD
             BRANCH    OVRCD,FIXT100       * invalid MBS Item
             MOVE      ZERO,PMMIRBAT
             MOVE      QIAMT,PMMIAMTP      * MBS Amount
             GOTO      FIXT850
           ENDIF
         ENDIF
.
.        Get charges from theatre fee file
.
         MOVE      PMMITDAT,TSRVDATE       * Service date
         MATCH     ANSY,PTMICMXP
         IF        @EQUAL
           ADD       ONE,FORM1
           MOVE      FORM1,FORM2         * Set item sequence
           CALL      CMXT0000            * get theatre casemix funding
           GOTO      FIXT100
         ENDIF
.
         MOVE      SP1,DIM1A
         MATCH     ADATE,DDATE
         IF        @EQUAL
           MOVE      "D",DIM1A
         ENDIF
.
         MOVE      PMMITDAT,CEFFDATE
         LOAD      CEFFDATE,CNTRCEFR,ADATE,DDATE
         CALL      CDSC0000                * Check for 'Disc.Eff.Date From'
         PACK      KEY18 WITH ACLAIM,AFUNDH,AFNDTB,DIM1A,SP70
         CALL      GETTFEES                * Get theatre amount
         BRANCH    EXIT,FIXT100
.
         ADD       ONE,FORM1
         PACK      KEY17,PMMIITEM,PMMITDAT
         CALL      PATITMRD
         COMPARE   ZERO,OVRCD
         GOTO      FIXT800 IF EQUAL
.
.        Fix price item, just adjust rebate portion
.
         LOAD      PMMIRBAT,FORM1,TFHF1,TFHF2,TFHF3,TFHF4,TFHF5,TFHF6
.
         COMPARE   PMMIRBAT,PMMIAMTT
         GOTO      FIXT700 IF NOT LESS
.
         MOVE      PMMIAMTT,PMMIRBAT
.
FIXT700  MOVE      PMMIAMTT,PMMIAMTP
         SUB       PMMIRBAT,PMMIAMTP
.
         MOVE      PMMIRBAT,PMMIAMTT
         ADD       PMMIAMTP,PMMIAMTT
         MULT      PMMISERV,PMMIAMTT
.
         PACK      PMMIDUPD,CCC,CYY,CMM,CDD
         REP       " 0",PMMIDUPD
         CALL      IBACLOCK
         MOVE      CTIMEIS,PMMITUPD
         MOVE      WBSEUID,PMMIWUSR
         CALL      UPPMMTI1
         GOTO      FIXT100
.
.        Normal theatre fee
.
FIXT800  LOAD      PMMIRBAT,FORM1,TFHF1,TFHF2,TFHF3,TFHF4,TFHF5,TFHF6
         LOAD      PMMIAMTP,FORM1,TFPAT1,TFPAT2,TFPAT3,TFPAT4:
                                           TFPAT5,TFPAT6
.
FIXT850  MOVE      PMMIRBAT,PMMIAMTT
         ADD       PMMIAMTP,PMMIAMTT
         MULT      PMMISERV,PMMIAMTT
.
         PACK      PMMIDUPD,CCC,CYY,CMM,CDD
         REP       " 0",PMMIDUPD
         CALL      IBACLOCK
         MOVE      CTIMEIS,PMMITUPD
         MOVE      WBSEUID,PMMIWUSR
         CALL      UPPMMTI1
         GOTO      FIXT100
.
FIXT999  RETURN
+
.-----------------------------------------------------------------------------
.         Subroutine to get the appropriate miscellaneous charges record
.------------------------------------------------------------------------------
.
GMSC0000  MOVE      ZERO,EXIT
          MATCH     SP8,PMMITDAT                                      *I-119158
          IF        @EQUAL
            PACK      PMMITDAT,CURRDATE,SP10
          ENDIF
.
          UNPACK    SP20,PTHFBCAT      * change "H/F Table" to "Table Type"
          PACK      KEY14,AFUNDH,AFNDTB,SP20
          CALL      RDFUND1            * "Table Type code" now in PTHFBCAT
.
.                   *                                                 *C-233046
          PACK      KEY29,ACLAIM,AFUNDH,PTMCHFTT,PMMIITEM,PMMITDAT,SP10
          CALL      PATMCHRD                * read Misc.Charges file
          COMPARE   ZERO,EXIT
          GOTO      GMSC9000 IF EQUAL
.
          PACK      KEY29,ACLAIM,SP6,SP3,PMMIITEM,PMMITDAT,SP10
          CALL      PATMCHRD                * read Misc.Charges file
          COMPARE   ZERO,EXIT
          GOTO      GMSC9000 IF EQUAL
.
          CALL      DCLM0000                * Get default claim code
          PACK      KEY29,PTCNDCLM,SP6,SP3,PMMIITEM,PMMITDAT,SP10
          CALL      PATMCHRD                * read Misc.Charges file
          COMPARE   ZERO,EXIT
          GOTO      GMSC9000 IF EQUAL
.
GMSC9000  MOVE      EXIT,OVRCD              * 0=Item found, 1=Item not valid
.
GMSC9999  RETURN
+
.***************************************************************************
.*  BRAT0000  :  Subroutine to calculate the bed rate                      *
.***************************************************************************
.
BRAT0000  MOVE      ZERO,SAVHF
          MOVE      ZERO,SAVPAT
          MOVE      ZERO,HFPORT
          MOVE      ZERO,ADISC
          MOVE      SP2,AALLOW
          MOVE      ZERO,SAVEND
          MOVE      ZERO,SAVEXTR
          MOVE      ZERO,NOFEE
.
          MOVE      TWARD,NWARD
          MOVE      TATYPE,SAVATYP
          MOVE      PTTRCLTY,SAVACLM
          MOVE      TRBTYP,SAVBTYP
.
.        Check the indicator saying what type of charging we are doing
.
          COMPARE   NINE,CFEETYP
          GOTO      BRAT1000 IF EQUAL       * Johns Hopkins uses bed fees
.
          COMPARE   ZERO,CFEETYP            * bed fee charging ?
          GOTO      BRAT7500 IF NOT EQUAL   * no, use the standard routine
.
BRAT1000  OPEN      PATBFEE1,"patbfeef"
          OPEN      PATFN1A1,"patfn1af"
.
.         Display the daily Bed Fee
.
          MOVE      ADYHOSP,NOHOSP
.
          MATCH     ANSY,PTMICMXP           * check for casemix payment indic.
          GOTO      BRAT2000 IF NOT EQUAL
          MATCH     SP10,PTMIPCMX
          GOTO      BRAT2000 IF EQUAL
.
          MOVE      NOHOSP,BDAYS
          MOVE      ZERO,ADMFLAG           * Not admission progam
          MOVE      ZERO,MSGFLAG           * Not displaying error message
          PROC      PATGNCMX
          BRANCH    NOFEE,BRAT8000
.
          MOVE      DAYPAT,SAVPAT
          MOVE      DAYHF,SAVHF
          MOVE      DAYEND,SAVEND
.
          MOVE      ADDHF,PTTRADRB
          MOVE      ADDPAT,PTTRADPT
          GOTO      BRAT9999
.
.         get the current bed fee
.
BRAT2000  MOVE      ZERO,COMFLAG            * Generate computer rate
          MOVE      SP70,NHOSP
          IF        ASTAT=3
            MATCH     ADATE,DDATE
            IF        @EQUAL
              MOVE      "D ",NHOSP
            ENDIF
          ENDIF
          CALL      PATDSBFE
          BRANCH    NOFEE,BRAT8000
          GOTO      BRAT9999
.
.       Get the rate to be charged (non-bed fee file)
.
BRAT7500  PACK      NEWTDATE,ADATE
          MOVE      NWARD,NEWTWARD
          MOVE      TATYPE,NEWTATYP
          MOVE      SAVBTYP,NEWTBTYP
          MOVE      AUSR2,NEWTCHST
          MOVE      ACLSSFT,NEWTDEPT
          PROC      PATTRRAT                 * calculate new rate
          BRANCH    EXIT,BRAT8000            * couldn't find rate
.
          MOVE      NEWTPPOR,SAVPAT
          MOVE      NEWTRPOR,SAVHF
          MOVE      NEWTRPOR,HFPORT
          MOVE      ZERO,TRATEG
          MOVE      NEWTXTRA,SAVEXTR
          ADD       NEWTXTRA,SAVPAT
          MOVE      NEWTBEND,SAVEND
.
          MOVE      ZERO,OVRCD
          MOVE      ZERO,NOFEE
          GOTO      BRAT9999
.
BRAT8000  MOVE      ZERO,SAVEND
          MOVE      ZERO,ADDEND
          MOVE      ZERO,SAVPAT
          MOVE      ZERO,SAVHF
.
BRAT9999  RETURN
+
.------------------------------------------------------------------------------
. MVMED000 - Move medical record on transfer
. Returns:    EXIT  0 = Ok to continue
.                   1 = Error
.------------------------------------------------------------------------------
.
MVMED000  OPEN      CONTROLF,"controlf"
          READ      CONTROLF,SIXTY;*143,MRCNMOVT
          PACK      KEY6,SAVWARD,SP70
          CALL      RDWARD1                * current ward location
          BRANCH    OVRCD,MVMED900
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDMRVS1
          BRANCH    OVRCD,MVMED910
.
          PACK      KEY10,MRVSMKEY,SP70    * current location
          CALL      RDMRMAS2
          BRANCH    OVRCD,MVMED910
.
          MATCH     MRMACLOC,PTWDLOCN      * compare current loc to current ward
          GOTO      MVMED900 IF NOT EQUAL
.
          PACK      KEY6,TRNTOWRD,SP70     * get new location
          CALL      RDWARD1
          BRANCH    OVRCD,MVMED910
.
          MATCH     MRMACHOS,PTWDHOSN
          IF        @EQUAL
            MATCH     MRMACLOC,PTWDLOCN   * Don't move MR if it's already in
            GOTO      MVMED900 IF EQUAL   * the destination location
          ENDIF
.
          MATCH     SP70,PTWDLOCN         * Location to move to not set up
          GOTO      MVMED920 IF EQUAL
.
          CALL      CLMRTHIS               * clear MRT History record
          MOVE      MRMAKEY,MRHIKEY        * move record
          CALL      IBACLOCK
          PACK      MRHIDATE,CCC,CYY,CMM,CDD   * movement date
          REP       " 0",MRHIDATE
          CLOCK     TIME,MRHITIME          * movement time
          MOVE      PTWDHOSN,MRHIDHOS      * new hospital
          MOVE      PTWDLOCN,MRHILOC       * new location
          MOVE      MRCNMOVT,MRHIREAS      * reason
          MOVE      SP70,MRHIOPER          * operator
          CALL      CALDUE00               * calculate due date
          CALL      CALSTA00               * calculate status
.
          UNPACK    SP70,MRHIRCST,MRHIRCUI,MRHIRCDT,MRHIRCTM
.
          MATCH     "1",MRCNTREC            * System Using Tracking Receipt
          IF        @EQUAL
            MATCH     "1",MRLOTREC          * Location Using Tracking Receipt
            IF        @EQUAL
              MOVE      "1",MRHIRCST        * In Transit
            ELSE
              MOVE      "3",MRHIRCST        * Sent Direct
            ENDIF
          ENDIF
.
          MOVE      USERID,MRHIUSID        * userid
.
          PACK      KEY26,MRHIKEY,MRHIDATE,MRHITIME,SP70
          CALL      RAMRHIS1
          IF        OVRCD=1
            CALL      WRMRHIS1
          ENDIF
          MOVE      THIRTY2,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICRM       * Pass Med.Recs.Movement to DG
.
          PACK      KEY10,MRVSMKEY,SP70    * current location
          CALL      RDMRMAS2
          BRANCH    OVRCD,MVMED910
.
          MOVE      PTWDHOSN,MRMACHOS      * new xhospital            *I-240724
          MOVE      PTWDLOCN,MRMACLOC      * new location
          CALL      IBACLOCK
          PACK      MRMADTUP,CCC,CYY,CMM,CDD
          REP       " 0",MRMADTUP
          MOVE      CTIMEIS,MRMATMUP
          MOVE      WBSEUID,MRMAUUID
          CALL      UPMRMAS2
MVMED900  MOVE      ZERO,EXIT
          GOTO      MVMED999
.
MVMED910  MATCH     "1",MRCNLINK           * Not using linked visits
          GOTO      MVMED999 IF EQUAL
.
          CLEAR     WEBTITLE
          APPEND    "Missing Medical Record",WEBTITLE
          RESET     WEBTITLE
          ADD       ONE,WARCOUNT
          MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
          MOVE      TWO,EXIT
          GOTO      MVMED999
.
MVMED920  IF          PTCNHDPS=1
            CLEAR     WEBTITLE     * only warn for nz sites
            APPEND    "Medical Record Location not configured for this ward. Record will not be moved.",WEBTITLE
            RESET     WEBTITLE
            ADD       ONE,WARCOUNT
            MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
            MOVE      TWO,EXIT
          ENDIF
.
MVMED999  RETURN
+
.-------------------------------------------------------------------------------
. Calculate Due Date - returns MRHIDDUE
.-------------------------------------------------------------------------------
.
CALDUE00  MOVE      SP70,MRHIDDUE
.
          PACK      KEY4,MRHIREAS,SP70
          CALL      RDMRMOV1            * Get Borrowing Period
          BRANCH    OVRCD,CALDUE99
.
          UNPACK    MRHIDATE,CCENT,CYEAR,CMON,CDAY  * Date of Movement
          MOVE      CCENT,CC
          MOVE      CYEAR,YY
          MOVE      CMON,MM
          MOVE      CDAY,DD
          CALL      DMYCON
          ADD       MRMOPERD,JULDAY
          MOVE      JULDAY,JWKDAY
          MOVE      JULYR,JWKYER
          MOVE      JULCC,JWKCC
          CALL      JULCON
          PACK      MRHIDDUE,CC,YY,MM,DD           * Calculated Due Date
          REP       " 0",MRHIDDUE
.
CALDUE99  RETURN
+
.-------------------------------------------------------------------------------
. Calculate Status - returns MRHISTAT
.-------------------------------------------------------------------------------
.
CALSTA00  PACK      KEY7,MRMACHOS,MRMACLOC,SP70                       *C-240724
          CALL      RDMRLOC1        * Read Location File for Indicator
          BRANCH    OVRCD,CALSTA99
.
          MATCH     "2",MRLOINDC
          IF        @EQUAL
            MOVE      ONE,MRHISTAT   * 1-Out
          ELSE
            MOVE      TWO,MRHISTAT   * 2-In
          ENDIF
.
CALSTA99  RETURN
+
.------------------------------------------------------------------------------
. Set Updatety - option 3 - templates where discharged patients are valid
.------------------------------------------------------------------------------
.
SUPT0000  MOVE      ZERO,UPDATETY
          MOVE      ZERO,INVOICED
          MOVE      TEMPLATE,FORM3
          MOVE      FORM3,TEMPLATE
          REP       " 0",TEMPLATE
.
          MATCH     "010",TEMPLATE       * change doctor/unit
          GOTO      SUPT9000 IF EQUAL
          MATCH     "014",TEMPLATE       * change doctor/unit for private
          GOTO      SUPT9000 IF EQUAL
.
          MATCH     "013",TEMPLATE       * Status adjustment
          GOTO      SUPT9000 IF EQUAL
.
          COMPARE   ZERO,AINVPRT
          IF        !@EQUAL
            MOVE      ONE,INVOICED
          ENDIF
.
          MATCH     "017",TEMPLATE       * change Financial Elections/Claim code
          GOTO      SUPT9000 IF EQUAL
.
          MATCH     "011",TEMPLATE       * Insurance details
          GOTO      SUPT9000 IF EQUAL
.
          MATCH     "012",TEMPLATE       * CMBS class
          GOTO      SUPT9000 IF EQUAL
.
          MATCH     "015",TEMPLATE       * Insurance details
          GOTO      SUPT9000 IF EQUAL
.
.         MATCH     "016",TEMPLATE       * Change CMBS class
.         GOTO      SUPT9000 IF EQUAL
.
          GOTO      SUPT9999
.
SUPT9000  MOVE      ONE,UPDATETY
.
SUPT9999  RETURN
+
.------------------------------------------------------------------------------
. Remote Scripting for Bed Transfers/Admission
.------------------------------------------------------------------------------
.
REMS0000  CALL      XMLHED00
          BRANCH    EXIT,REMS9999
.
          BRANCH    REMOTENO,REMS0010,REMS0020,REMS0030,REMS0040,REMS0050:
                             REMS0060,REMS0070,REMS0080,REMS0090,REMS0100:
                             REMS0110,REMS0120,REMS0130,REMS0140,REMS0150
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    " INVALID UPDATE TYPE ":
                    "</RETURN_VALUE>"
          GOTO      REMS9000
.
REMS0010  CALL      CHKBED00
          GOTO      REMS9000
.
REMS0020  CALL      CHAD0000
          GOTO      REMS9000
.
REMS0030  CALL      CHK5DW00           * Check for 5 Day Ward
          GOTO      REMS9000
.
REMS0040  CALL      CHKCBD00           * Check for Closed Beds (Swap Beds Func)
          GOTO      REMS9000
.
REMS0050  CALL      CHKBMN00           * Check overlap in Bed Management file
          GOTO      REMS9000
.
REMS0060  CALL      CHKCLB00           * Check for Closed Beds (Day Oncology)
          GOTO      REMS9000
.
REMS0070  CALL      DONP0000           * Check for max number of patients
          GOTO      REMS9000           * Day Oncology view
.
REMS0080  CALL      CHKWBD00           * Check for ward and bed combination
          GOTO      REMS9000
.                                  
REMS0090  CALL      CHOLA000           * Check for FIM overlap on Adm Date Chg
          GOTO      REMS9000
.                                 
REMS0100  CALL      CHOLD000           * Check for FIM overlap on Dsc Date Chg
          GOTO      REMS9000
.                                                                     Car 252671
REMS0110  CALL      VALDTE00           * Check Admission Date match on booking
          GOTO      REMS9000
.
REMS0120  CALL      CHKAT000           * Check if PGM exists for Adm Type chg
          GOTO      REMS9000
.
REMS0130  CALL      REMSFX00           * Schedule Fax with supplied details
          GOTO      REMS9000
.
REMS0140  CALL      RSTATV00           * Check for stat admission bookings and
          GOTO      REMS9000           * pre admissions
.
REMS0150  CALL      RSTATV00           * Check for stat admission discharges and
          GOTO      REMS9000           * current admissions
.
REMS9000  CALL      XMLEND00
.
REMS9999  RETURN
+
.------------------------------------------------------------------------------
.         Schedule Fax remote scripting call
.------------------------------------------------------------------------------
REMSFX00  CALL      SCHFAX00
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>1</RETURN_VALUE>";
REMSFX99  RETURN
+
.------------------------------------------------------------------------------
. Check for on leave beds
.------------------------------------------------------------------------------
.
CHKBED00  MOVE      ZERO,WARNINGF           * Reset Warning Flag
          MATCH     SP3,WARDCODE            * Is Ward code blank?
          GOTO      CHKBED90 IF EQUAL       * Yes, exit.
          MATCH     SP3,BEDDCODE            * Is Bed code blank?
          GOTO      CHKBED30 IF EQUAL       * Yes, check '5 Day Ward' only.
.
.         Display an error message if selected bed is currently closed.
.
          PACK      KEY6,WARDCODE,BEDDCODE,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,CHKBED10
.
          MATCH     "1",PTWDBDST       * Is selected bed closed?
          IF        @EQUAL
            MATCH     SP70,ADMISTME
            IF        @EQUAL | @EOS
              WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                        "Selected bed is currently closed.":
                        "</RETURN_VALUE>"
              GOTO      CHKBED99         * Yes, display error and exit.
            ELSE
.
CHKBED02      PACK    KEY22,WARDCODE,BEDDCODE,SP70
              CALL    RSPMBDC1
CHKBED05      CALL    RKPMBDC1
              BRANCH  OVRCD,CHKBED10
.
              MATCH   PMBCWARD,WARDCODE
              GOTO    CHKBED10 IF NOT EQUAL
.
              MATCH   PMBCBED,BEDDCODE
              GOTO    CHKBED10 IF NOT EQUAL
.
              MATCH   PMBCFRDT,ADMISDTE
              GOTO    CHKBED10 IF LESS
.
              IF      @EQUAL
                MATCH   PMBCFRTM,ADMISTME
                GOTO    CHKBED06 IF EOS     * Skip if we have a null ADMISTME
                GOTO    CHKBED10 IF LESS    * OK; admis time before from closure
              ENDIF
.
CHKBED06      MATCH   ADMISDTE,PMBCTODT
              GOTO    CHKBED05 IF LESS
.
              IF      @EQUAL
                MATCH   ADMISTME,PMBCTOTM
                GOTO    CHKBED05 IF EOS     * Skip if we have a null ADMISTME
                GOTO    CHKBED05 IF LESS
              ENDIF
.
              WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                        "Selected bed is closed during this date/time.":
                        "</RETURN_VALUE>"
              GOTO      CHKBED99         * Yes, display error and exit.
.
            ENDIF
          ELSE
            GOTO      CHKBED02
          ENDIF
.
.
CHKBED10  BRANCH    PREADMIT,CHKBED20  * Skip if pre admitting only
.
          BRANCH    PTCNONLA,CHKBED20  * Skip if Allow on leave bed allocation
.
.         Check for Patient being on leave for the selected bed.
.
          PACK      KEY14,WARDCODE,BEDDCODE,SP70
          CALL      RDSONLV1
          CALL      RDKONLV1
          BRANCH    OVRCD,CHKBED20
.
          MATCH     OWARD,WARDCODE          * Same Ward?
          GOTO      CHKBED20 IF NOT EQUAL   * No, go to next check
.
          MATCH     OBED,BEDDCODE           * Same Bed?
          GOTO      CHKBED20 IF NOT EQUAL   * No, go to next check
.
          MATCH     ADMISSNO,DOADMNO
          GOTO      CHKBED20 IF EQUAL
.
          COMPARE   ZERO,PTCNONLA      * Is 'On Leave Bed Alloc' disallowed?
          IF        @EQUAL
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                      "Patient on leave from this bed.":
                      "</RETURN_VALUE>"
            GOTO      CHKBED99         * Yes, display error and exit.
          ENDIF
.
          COMPARE   TWO,PTCNONLA       * Warn about 'On Leave Bed Allocation'?
          IF        @EQUAL
            MOVE      ONE,WARNINGF     * Yes, set Warning flag
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=WARNING>":
                      "Patient on leave from this bed.";
            GOTO      CHKBED20         * Yes, record warning, continue checks
          ENDIF
.
.         Check whether patient will have to be placed on on standby.
.
CHKBED20  BRANCH    PREADMIT,CHKBED30            * Skip if pre admitting only
.
          PACK      KEY6,WARDCODE,BEDDCODE,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,CHKBED30
.
          MATCH     ZEROVISN,WADMNO
          GOTO      CHKBED30 IF EQUAL
.
          MATCH     ZEROVISN,WSTBY
          IF        @EQUAL
            IF        WARNINGF=0
              MOVE      ONE,WARNINGF
              WRITE     HTMLFILE;"<RETURN_VALUE TYPE=WARNING>";
            ELSE
              WRITE     HTMLFILE;012;            * Insert 'new line' character
            ENDIF
            WRITE     HTMLFILE;"Patient will be placed on standby.";
          ENDIF
.
.         Bed code blank / Check for '5 Day Ward'
.
CHKBED30  BRANCH    PREADMIT,CHKBED40       * Skip if pre admitting only
.
          MOVE      WARDCODE,CHKWRDCD
          MOVE      BEDDCODE,CHKBEDCD
          MOVE      ADMISDTE,CHKADMDT
          MOVE      ADMISTME,CHKADMTM
          CALL      CHKBHS00           * Validate against Ward Bed History
          IF        EXIT=1
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                        "Invalid Ward/Bed - the ward/bed is not active":
                        " for this date":
                        "</RETURN_VALUE>"
            GOTO      CHKBED99         * Display error and exit
          ENDIF
.
.
.         Check for '5 Day Ward'
.
CHKBED40  PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,CHKBED80
.
          MATCH     "1",PTWDFVDW            * Is this a '5 Day Ward'?
          GOTO      CHKBED80 IF NOT EQUAL   * No, skip this check.
.
          IF        STAYDAYS>5
            IF        WARNINGF=0
              MOVE      ONE,WARNINGF
              WRITE     HTMLFILE;"<RETURN_VALUE TYPE=WARNING>";
            ELSE
              WRITE     HTMLFILE;012;            * Insert 'new line' character
            ENDIF
            WRITE     HTMLFILE;"Five Day Ward was selected and the planned ":
                               "length of stay is greater than five days.";
            GOTO      CHKBED80
          ENDIF
.
.         Check for Saturdays, Sundays and Public Holidays within specified
.         length of stay.
.
          IF        STAYDAYS=ZERO
            MOVE      ONE,STAYDAYS     * Default planned length of stay to 1 day
          ENDIF
          CALL      CHKDAY00           * Check for weekend and public holidays
.
CHKBED80  IF        WARNINGF=1
            WRITE     HTMLFILE;"</RETURN_VALUE>";
          ENDIF
.
CHKBED90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    " OK ":
                    "</RETURN_VALUE>"
          GOTO      CHKBED99
.
CHKBED99  RETURN
+
.------------------------------------------------------------------------------
.         Validates whether the Ward Bed is active at the time of admission;
.         Checks against the Ward Bed History Last Effective Date/Time.
.
.         Parameters:
.           CHKWRDCD - Ward Code
.           CHKBEDCD - Bed Code
.           CHKADMDT - Admission Date
.           CHKADMTM - Admission Time
.
.         Return:
.              EXIT  - 0 (Active)
.                      1 (Inactive)
.------------------------------------------------------------------------------
CHKBHS00  MOVE      ZERO,EXIT
          MOVE      SP70,SAVWARD
          MOVE      SP70,SAVBED
          MOVE      SP70,SAVDATE
.
          MATCH     SP70,CHKWRDCD           * No Ward?
          GOTO      CHKBHS90 IF EQUAL
.
          MATCH     SP70,CHKADMDT           * No Admission Date?
          GOTO      CHKBHS90 IF EQUAL
.
.         Get first ever Ward Bed History record; bail if none exists
.
          PACK      KEY14,CHKWRDCD,CHKBEDCD,SP70
          CALL      RSPTWBH1
          CALL      RKPTWBH1
          BRANCH    OVRCD,CHKBHS90
.
          MATCH     CHKWRDCD,WBHWARD
          GOTO      CHKBHS90 IF NOT EQUAL
.
          MATCH     CHKBEDCD,WBHBED
          GOTO      CHKBHS90 IF NOT EQUAL
.
.         Check if admission date is before the first Effective Date
.
          MATCH     WBHDATE,CHKADMDT
          GOTO      CHKBHS90 IF EQUAL       * Bail out
          GOTO      CHKBHS90 IF LESS        * Bail out
.
.
.         Loop backwards from most recent (applicable) Bed History record
.         to locate the record we need...
.
          PACK      KEY14,CHKWRDCD,CHKBEDCD,Z70
          CALL      RSPTWBH1
CHKBHS11  CALL      RPPTWBH1
          BRANCH    OVRCD,CHKBHS12
.
          MATCH     CHKWRDCD,WBHWARD
          GOTO      CHKBHS12 IF NOT EQUAL
.
          MATCH     CHKBEDCD,WBHBED
          GOTO      CHKBHS12 IF NOT EQUAL
.
.         Check Admission Date is ON or BEFORE the Ward/Bed Last Effective Date
.
          MATCH     WBHDATE,CHKADMDT
          IF        @EQUAL | @LESS
            MATCH     WBHDATE,CHKADMDT      * Admit on same Last Effective Date?
            IF        @EQUAL
              MATCH     WBHTIME,SP70        * No Last Effective Time
              GOTO      CHKBHS19 IF EQUAL   * Got our record!
.
              MATCH     CHKADMTM,SP70       * No Admission Time
              GOTO      CHKBHS19 IF EQUAL   * Got our record!
.
              MATCH     WBHTIME,CHKADMTM    * ON or BEFORE Last Effective Time
              GOTO      CHKBHS19 IF EQUAL   * Got our record!
              GOTO      CHKBHS19 IF LESS    * Got our record!
            ENDIF
.
.           Save record details
.
            MOVE      WBHWARD,SAVWARD
            MOVE      WBHBED,SAVBED
            MOVE      WBHDATE,SAVDATE
.
            GOTO      CHKBHS11         * Get previous record
          ENDIF
.
          MOVE      WBHWARD,SAVWARD
          MOVE      WBHBED,SAVBED
          MOVE      WBHDATE,SAVDATE
          GOTO      CHKBHS13           * Got previous record to the one we want
.
.         Get our saved record...
.
CHKBHS12  MATCH   SP70,SAVWARD
          GOTO    CHKBHS90 IF EQUAL
.
          PACK    KEY14,SAVWARD,SAVBED,SAVDATE,SP70
          CALL    RDPTWBH1
          BRANCH  OVRCD,CHKBHS90
          GOTO    CHKBHS19
.
.         Get the record after our saved one...
.
CHKBHS13  PACK    KEY14,SAVWARD,SAVBED,SP70
          CALL    RSPTWBH1
CHKBHS14  CALL    RKPTWBH1
          BRANCH  OVRCD,CHKBHS90
.
          MATCH   WBHWARD,SAVWARD
          GOTO    CHKBHS90 IF NOT EQUAL
.
          MATCH   WBHBED,SAVBED
          GOTO    CHKBHS90 IF NOT EQUAL
.            
          MATCH   WBHDATE,SAVDATE
          GOTO    CHKBHS14 IF NOT EQUAL
.
          CALL    RKPTWBH1             * get next record
          BRANCH  OVRCD,CHKBHS90       * none exists; bail
.
          MATCH   WBHWARD,SAVWARD
          GOTO    CHKBHS90 IF NOT EQUAL
.
          MATCH   WBHBED,SAVBED
          GOTO    CHKBHS90 IF NOT EQUAL
          GOTO    CHKBHS19
.
CHKBHS19  COMPARE ONE,WBHACTV          * Non-Active ?
          GOTO    CHKBHS91 IF EQUAL
          GOTO    CHKBHS90
.
.
CHKBHS90  MOVE    ZERO,EXIT            * Active
          GOTO    CHKBHS99
.
CHKBHS91  MOVE    ONE,EXIT             * Inactive
CHKBHS99  RETURN
+
.------------------------------------------------------------------------------
.              Check Days selected for 5 Day Ward
.------------------------------------------------------------------------------
.
CHKDAY00  MOVE      ONE,DAYNUMBR
          MATCH     SP70,ADMISDTE           * Is Admission Date blank?
          GOTO      CHKDAY99 IF EQUAL       * Yes, go to exit.
.
          MOVE      ADMISDTE,ADMSDATE       * Set up a DATE variable
.
CHKDAY10  IF        DAYNUMBR>STAYDAYS
            GOTO      CHKDAY99
          ENDIF
.
.         Check for weekend.
.
          UNPACK    ADMSDATE,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK                * 1=Mon,2=Tue,3=Wed.....7=Sun
          IF        (WEEKDAY=6 | WEEKDAY=7)
            IF        WARNINGF=0
              MOVE      ONE,WARNINGF
              WRITE     HTMLFILE;"<RETURN_VALUE TYPE=WARNING>";
            ELSE
              WRITE     HTMLFILE;012;       * Insert 'new line' character
            ENDIF
            WRITE     HTMLFILE;"Five Day Ward was selected and the planned ":
                               "length of stay falls on a weekend.";
            GOTO      CHKDAY99
          ENDIF
.
.         Check for Public Holiday
.
          PACK      KEY11,ADMSDATE,SP70
          CALL      RDPHOA1                 * Is this date a public holiday?
          IF        OVRCD=1
            IF        IBCNMHOS=1
              PACK      KEY11,ADMSDATE,PTWDHOSN,SP70  * Check for Public Holiday
              CALL      RDPHOA1                   * for the clinics hospital
              COMPARE   ONE,OVRCD
              GOTO      CHKDAY20 IF EQUAL
            ELSE
              GOTO      CHKDAY20
            ENDIF
          ENDIF
.
          IF        WARNINGF=0
            MOVE      ONE,WARNINGF
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=WARNING>";
          ELSE
            WRITE     HTMLFILE;012;         * Insert 'new line' character
          ENDIF
          WRITE     HTMLFILE;"Five Day Ward was selected and the planned ":
                             "length of stay falls on a public holiday.";
          GOTO      CHKDAY99
.
CHKDAY20  ADD       ONE,DAYNUMBR            * Increament Day number
          ADD       ONE,ADMSDATE            * Move date to the next day
          GOTO      CHKDAY10
.
CHKDAY99  RETURN
+
.------------------------------------------------------------------------------
. Check for 5 Day Ward
.------------------------------------------------------------------------------
.
CHK5DW00  MOVE      ZERO,WARNINGF           * Reset Warning Flag
          MATCH     SP3,WARDCODE            * Is Ward code blank?
          GOTO      CHK5DW90 IF EQUAL       * Yes, exit.
.
CHK5DW30  PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,CHK5DW80
.
          MATCH     "1",PTWDFVDW            * Is this a '5 Day Ward'?
          GOTO      CHK5DW80 IF NOT EQUAL   * No, skip this check.
.
          IF        STAYDAYS>5
            IF        WARNINGF=0
              MOVE      ONE,WARNINGF
              WRITE     HTMLFILE;"<RETURN_VALUE TYPE=WARNING>";
            ELSE
              WRITE     HTMLFILE;012;            * Insert 'new line' character
            ENDIF
            WRITE     HTMLFILE;"Five Day Ward was selected and the planned ":
                               "length of stay is greater than five days.";
            GOTO      CHK5DW80
          ENDIF
.
.         Check for Saturdays, Sundays and Public Holidays within specified
.         length of stay.
.
          IF        STAYDAYS=ZERO
            MOVE      ONE,STAYDAYS     * Default planned length of stay to 1 day
          ENDIF
          CALL      CHKDAY00           * Check for weekend and public holidays
.
CHK5DW80  IF        WARNINGF=1
            WRITE     HTMLFILE;"</RETURN_VALUE>";
          ENDIF
.
CHK5DW90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    " OK ":
                    "</RETURN_VALUE>"
          GOTO      CHK5DW99
.
CHK5DW99  RETURN
+
.------------------------------------------------------------------------------
. Check for on leave beds
.------------------------------------------------------------------------------
.
CHKCBD00  MOVE      ZERO,WARNINGF           * Reset Warning Flag
          MATCH     SP3,WARDCODE            * Is From Ward code blank?
          GOTO      CHKCBD90 IF EQUAL       * Yes, exit.
          MATCH     SP3,SWPTOWRD            * Is To Ward code blank?
          GOTO      CHKCBD90 IF EQUAL       * Yes, exit.
.
          MATCH     SP3,BEDDCODE            * Is From Bed code blank?
          GOTO      CHKCBD10 IF EQUAL       * Yes, check 'To Ward/Bed'.
.
.         Display a Warning message if selected bed is currently closed.
.
          PACK      KEY6,WARDCODE,BEDDCODE,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,CHKCBD10
.
          MATCH     "1",PTWDBDST       * Is selected bed closed?
          IF        @EQUAL
            MOVE      ONE,WARNINGF     * Yes, set Warning flag
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=WARNING>":
                      "Swap From Bed is currently closed.";
          ENDIF
.
CHKCBD10  MATCH     SP3,SWPTOBED            * Is To Bed code blank?
          GOTO      CHKCBD50 IF EQUAL       * Yes, finished checking
.
          PACK      KEY6,SWPTOWRD,SWPTOBED,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,CHKCBD50
.
          MATCH     "1",PTWDBDST       * Is selected bed closed?
          IF        @EQUAL
            IF        WARNINGF=0
              MOVE      ONE,WARNINGF
              WRITE     HTMLFILE;"<RETURN_VALUE TYPE=WARNING>";
            ELSE
              WRITE     HTMLFILE;012;            * Insert 'new line' character
            ENDIF
            WRITE     HTMLFILE;"Swap To Bed is currently closed.";
          ENDIF
.
CHKCBD50  IF        WARNINGF=1
            WRITE     HTMLFILE;"</RETURN_VALUE>";
          ENDIF
.
CHKCBD90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    " OK ":
                    "</RETURN_VALUE>"
          GOTO      CHKCBD99
.
CHKCBD99  RETURN
+
.==============================================================================
.         SPBD0000 - Check for speciality bed type
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.==============================================================================
.
SPBD0000  BRANCH    CMIXFLAG,SPBD9000            * ignore casemix
.
          PACK      KEY6,TWARD,TBED
          CALL      RDWARD1
          BRANCH    OVRCD,SPBD9000
.
          MATCH     SP3,WEFRBT
          GOTO      SPBD9000 IF EQUAL            * blank bed type
          PACK      KEY5,ANSB,ANST,WEFRBT
          CALL      RDCODE1
          BRANCH    OVRCD,SPBD9000               * invalid bed type
.
          REP       " 0",TCINDC6
          MOVE      ZERO,FORM1
          MOVE      TCINDC6,FORM1                * check for specialty bedtype
          COMPARE   ZERO,FORM1
          GOTO      SPBD9000 IF EQUAL            * normal bed type
.
          MOVE      ONE,EXIT
          GOTO      SPBD9999
.
SPBD9000  MOVE      ZERO,EXIT
.
SPBD9999  RETURN
+
.------------------------------------------------------------
.  Check carer available
. Returns:  EXIT   0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
.
CHKCAR00  MOVE      ONE,FORM1
          MOVE      SP70,DISHDEST
          MOVE      SP70,CARERAVL
          MOVE      SP70,CARETYPE
.
          COMPARE   THREE,PTCNHDPS
          GOTO      CHKCAR90 IF NOT EQUAL
.
          IF        PTCNHOSP=0
            GOTO      CHKCAR90     * not required for private hospitals
          ENDIF
.
          PACK      KEY5,ANSC,ANSC,ACARE,SP70
          CALL      RDCODE1
.******************************************** Start of Changes         *C-49016
          UNPACK    THCSCOD,DIM1,DIM1A,DIM2
          PACK      CARETYPE,DIM1,DIM1A,SP2          * now 2 bytes
.
....      SCAN      CARETYPE,CARAVAIL       * now CARAVAIL obsolete
.
          MATCH     "5",DIM1
          IF        @EQUAL
            REP       "E-T-K-G-S-A-",DIM1A  * Mental Health sub codes
            MATCH     "-",DIM1A
            GOTO      CHKCAR99 IF NOT EQUAL
          ENDIF
          REP       "P-F-E-1-2-6-7-K-8-9-",DIM1
          MATCH     "-",DIM1
.********************************************   End of Changes         *C-49016
          GOTO      CHKCAR90 IF NOT EQUAL
.
CHKCAR10  PACK      KEY5,ANSD,ANSD,DSCHDEST,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CHKCAR94
.
          MOVE      THCSCOD,DISHDEST
.
          PACK      KEY5,ANSV,ANSK,DSCHCRAV,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CHKCAR93
.
          MOVE      THCSCOD,CARERAVL
          MOVE      CARERAVL,FORM1
.
          MATCH     ANSH,DSCHDEST              * Discharged Home
          GOTO      CHKCAR30 IF EQUAL
.
          COMPARE    ONE,FORM1                 * Carer not needed/not applicable
          GOTO       CHKCAR92 IF NOT EQUAL
          GOTO       CHKCAR90
.
CHKCAR30  PACK      AGEDATE,CURRDATE,SP10
          CALL      CALCAGE
.
          IF        PSAGEYRS<=7
            IF        FORM1 >= FOUR & FORM1 <= SIX
              GOTO    CHKCAR90
            ENDIF
            GOTO      CHKCAR91
          ENDIF
.
CHKCAR90  MOVE      ZERO,EXIT
          GOTO      CHKCAR99
.
CHKCAR91  CLEAR     WEBTITLE
          APPEND   "Invalid carer available for discharge destination",WEBTITLE
          APPEND    " and age.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKCAR99
.
CHKCAR92  MOVE     "Invalid carer available for discharge destination.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKCAR99
.
CHKCAR93  MOVE     "Invalid carer available code.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKCAR99
.
CHKCAR94  MOVE     "Invalid discharge destination code.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKCAR99
.
CHKCAR99  RETURN
+
.------------------------------------------------------------
. CTSM0000 - Check Care Type and Separation Mode for PRS2
. Returns:   EXIT   0 = Ok to continue
.                   1 = Error
.------------------------------------------------------------
.
CTSM0000  MOVE      ZERO,DOYR2014
          COMPARE   THREE,PTCNHDPS
          GOTO      CTSM9000 IF NOT EQUAL
.
          MATCH     "20140701",TRANDATE
          IF        !@LESS
            MOVE      ONE,DOYR2014
          ENDIF
.
          PACK      KEY5,ANSC,ANSC,ACARE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CTSM9200
.
          UNPACK    THCSCOD,DIM1,DIM1A,DIM2
          PACK      EPISCTYP,DIM1,DIM1A,SP2
          MATCH     "5",DIM1
          IF        @EQUAL
            REP       "E-T-K-G-S-A-",DIM1A  * Mental Health sub codes
            MATCH     "-",DIM1A
            GOTO      CTSM9200 IF NOT EQUAL
          ENDIF
.
          IF        DOYR2014=0
            CMATCH    "R",DIM1
            IF        @EQUAL
              REP       "1-2-",DIM1A      * allow "R1" or "R2" (2012 mod)
              MATCH     "-",DIM1A
              GOTO      CTSM9200 IF NOT EQUAL
            ENDIF
          ENDIF
.
          IF        DOYR2014=1
            REP       "M-1-6-8-5-9-0-3-4-U-P-",DIM1
          ELSE
            REP       "R-F-E-1-2-6-7-K-8-5-9-0-3-4-U-P-",DIM1         *C-60167
          ENDIF
          MATCH     "-",DIM1
          GOTO      CTSM9200 IF NOT EQUAL
.
          PACK      KEY5,ANSD,ANSD,DSCHDEST,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CTSM9300
.
          MOVE      THCSCOD,EPISTYPE
.
          MOVE      SP70,DIM1
          MOVE      EPISTYPE,DIM1
          REP       "S-D-Z-T-B-N-A-H-R-G-J-L-",DIM1    *C-60167 added G for 2012
          MATCH     "-",DIM1
          GOTO      CTSM9300 IF NOT EQUAL
.
          IF        DOYR2014=0
            CMATCH    ANSF,EPISCTYP                                   *C-49016
            GOTO      CTSM0100 IF EQUAL
            CMATCH    ANSE,EPISCTYP                                   *C-49016
            GOTO      CTSM0200 IF NOT EQUAL
          ENDIF
          GOTO      CTSM0200
.
CTSM0100  MOVE      SP70,TEMPVAR
          MOVE      "SDZTBNAHR",TEMPVAR                                 *C-60167
          REP       " _",TEMPVAR
          SCAN      EPISTYPE,TEMPVAR
          GOTO      CTSM9100 IF NOT EQUAL
          GOTO      CTSM9000
.
CTSM0200  CMATCH    "8",EPISCTYP                                       *C-49016
          GOTO      CTSM9000 IF EQUAL
.
          CMATCH    "0",EPISCTYP                                       *C-49016
          GOTO      CTSM0400 IF NOT EQUAL
.
CTSM0300  MOVE      SP70,TEMPVAR
          MOVE      "DZTBCNAHRSJL",TEMPVAR                              *C-60167
          REP       " _",TEMPVAR
          SCAN      EPISTYPE,TEMPVAR
          GOTO      CTSM9100 IF NOT EQUAL
          GOTO      CTSM9000
.
CTSM0400  CMATCH    "3",EPISCTYP                                       *C-49016
          GOTO      CTSM0500 IF NOT EQUAL
.
          MOVE      SP70,TEMPVAR
          MOVE      "SDTNHJL",TEMPVAR
          REP       " _",TEMPVAR
          SCAN      EPISTYPE,TEMPVAR
          GOTO      CTSM9100 IF NOT EQUAL
          GOTO      CTSM9000
.
CTSM0500  CMATCH    ANSU,EPISCTYP                                      *C-49016
          GOTO      CTSM0600 IF NOT EQUAL
.
          MOVE      SP70,TEMPVAR
          MOVE      "DZTH",TEMPVAR
          REP       " _",TEMPVAR
          SCAN      EPISTYPE,TEMPVAR
          GOTO      CTSM9100 IF NOT EQUAL
          GOTO      CTSM9000
.
CTSM0600  MATCH     "10",EPISCTYP           * caretype = 10, sep.mode = G
          GOTO      CTSM0700 IF NOT EQUAL
.
          MOVE      SP70,TEMPVAR
          MOVE      "G",TEMPVAR
          REP       " _",TEMPVAR
          SCAN      EPISTYPE,TEMPVAR
          GOTO      CTSM9100 IF NOT EQUAL
          GOTO      CTSM9000
.
CTSM0700  IF        DOYR2014=0
            CMATCH    ANSR,EPISCTYP           * allow "R1" or "R2" (2012 mod)
            GOTO      CTSM1000 IF NOT EQUAL
.
            MOVE      SP70,TEMPVAR
            MOVE      "SDZTBANH",TEMPVAR
            REP       " _",TEMPVAR
            SCAN      EPISTYPE,TEMPVAR
            GOTO      CTSM9100 IF NOT EQUAL
            GOTO      CTSM9000
          ENDIF
.
CTSM1000  MATCH     ANSS,EPISTYPE
          GOTO      CTSM1100 IF NOT EQUAL
.
          MOVE      SP70,TEMPVAR
          IF        DOYR2014=1
            MOVE      "P16859M40",TEMPVAR    * July 2014
          ELSE
            MOVE      "PFE1267K59348R",TEMPVAR      * remove J, add K8 (R 2012)
          ENDIF
          REP       " _",TEMPVAR
          UNPACK    EPISCTYP,DIM1,DIM1A                                *I-49016
          SCAN      DIM1,TEMPVAR                                       *I-49016
          GOTO      CTSM9100 IF NOT EQUAL
          GOTO      CTSM9000
.
CTSM1100  MATCH     ANSZ,EPISTYPE
          GOTO      CTSM1200 IF NOT EQUAL
.
          MOVE      SP70,TEMPVAR
          IF        DOYR2014=1
            MOVE      "MP1685904U",TEMPVAR
          ELSE
            MOVE      "PFE1267JK85904UR",TEMPVAR      * add K (R 2012)
          ENDIF
          REP       " _",TEMPVAR
          UNPACK    EPISCTYP,DIM1,DIM1A                                *I-49016
          SCAN      DIM1,TEMPVAR                                       *I-49016
          GOTO      CTSM9100 IF NOT EQUAL
          GOTO      CTSM9000
.
CTSM1200  MATCH     ANSN,EPISTYPE
          IF        !@EQUAL
            MATCH     ANSJ,EPISTYPE
            IF        !@EQUAL
              MATCH     ANSL,EPISTYPE
              GOTO      CTSM1300 IF NOT EQUAL
            ENDIF
          ENDIF
.
          MOVE      SP70,TEMPVAR
          IF        DOYR2014=1
            MOVE      "16859M04U",TEMPVAR
          ELSE
            MOVE      "PFE1267K859034R",TEMPVAR    * remove J, add K (R 2012)
          ENDIF
          REP       " _",TEMPVAR
          UNPACK    EPISCTYP,DIM1,DIM1A                                *I-49016
          SCAN      DIM1,TEMPVAR                                       *I-49016
          GOTO      CTSM9100 IF NOT EQUAL
          GOTO      CTSM9000
.
CTSM1300  MATCH     ANSA,EPISTYPE
          GOTO      CTSM1400 IF NOT EQUAL
.
          MOVE      SP70,TEMPVAR
          IF        DOYR2014=1
            MOVE      "P126859M04",TEMPVAR
          ELSE
            MOVE      "PFE1267K85904R",TEMPVAR        *remove j, add K (R 2012)
          ENDIF
          REP       " _",TEMPVAR
          UNPACK    EPISCTYP,DIM1,DIM1A                                *I-49016
          SCAN      DIM1,TEMPVAR                                       *I-49016
          GOTO      CTSM9100 IF NOT EQUAL
          GOTO      CTSM9000
.
CTSM1400  MATCH     ANSB,EPISTYPE                                      *I-60167
          GOTO      CTSM1500 IF NOT EQUAL
.
          MOVE      SP70,TEMPVAR
          IF        DOYR2014=1
            MOVE      "P16859M04",TEMPVAR
          ELSE
            MOVE      "PFE1267K85904R",TEMPVAR     * added R 2012
          ENDIF
          REP       " _",TEMPVAR
          UNPACK    EPISCTYP,DIM1,DIM1A
          SCAN      DIM1,TEMPVAR
          GOTO      CTSM9100 IF NOT EQUAL
          GOTO      CTSM9000                                       *end I-60167
.
CTSM1500  MATCH     ANSG,EPISTYPE                * 2012 mod
          GOTO      CTSM1600 IF NOT EQUAL
.
          MATCH     "10",EPISCTYP
          GOTO      CTSM9100 IF NOT EQUAL
          GOTO      CTSM9000
.
CTSM1600  MATCH     ANSR,EPISTYPE                                      *I-60167
          GOTO      CTSM9000 IF NOT EQUAL
.
          MOVE      SP70,TEMPVAR
          MOVE      "FE1P267K85904",TEMPVAR
          REP       " _",TEMPVAR
          UNPACK    EPISCTYP,DIM1,DIM1A
          SCAN      DIM1,TEMPVAR
          GOTO      CTSM9100 IF NOT EQUAL
          GOTO      CTSM9000                                       *end I-60167
.
CTSM9000  MOVE      ZERO,EXIT
          GOTO      CTSM9999
.
CTSM9100  CLEAR     WEBTITLE
          APPEND   "Invalid Care Type ",WEBTITLE
          APPEND    EPISCTYP,WEBTITLE
          APPEND    " with Separation Mode ",WEBTITLE
          APPEND    EPISTYPE,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CTSM9999
.
CTSM9200  CLEAR     WEBTITLE
          APPEND    "Invalid Care Type ",WEBTITLE
          APPEND    EPISCTYP,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CTSM9999
.
CTSM9300  CLEAR     WEBTITLE
          APPEND    "Invalid Separation Type ",WEBTITLE
          APPEND    EPISTYPE,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CTSM9999
.
CTSM9999  RETURN
+
.------------------------------------------------------------
. CCART000 - Delete a care type change record.
. Returns:  EXIT  0 = Ok to continue
.                 1 = Error
.------------------------------------------------------------
.
CCART000  PACK      KEY24,DELETECT,SP70
          CALL      RDCHCO1
          BRANCH    OVRCD,CCART910
.
          MOVE      CHCODE,SAVCARE
          CALL      DECHCO1
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,CCART920
.
          MOVE      SAVCARE,ACARE
          CALL      UPMISS1
.
.>>>>     Broadcat HL7 message for care type change (CAR 280870)
.
          PACK      KEY8,AURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,CCART900
.
          PACK      KEY8,AURNO,SP70
          CALL      RDPMPX21
          IF        OVRCD = 1
            CALL      CLPMSPX2
          ENDIF
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDVISA1
          IF        OVRCD=1
            CALL      CLPATVIS
          ENDIF
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDDSCH1
          IF        OVRCD=1
            CALL      CLPATDSC
          ENDIF
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDRESP1
          IF        OVRCD=1
            CALL      CLPATRE1
          ENDIF
.
          CALL      PMIGTNID            * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          PACK      KEY30,AADMNO,Z70
          CALL      RDSTRAN2                     * position in file
          CALL      RDPTRAN2                     * read previous record
          MATCH     AADMNO,TADMN                 * same admission still ?
          IF        @EQUAL
            MOVE      THIRTY5,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICAC          * broadcast change admission
          ELSE
            CALL      CLPATTRN
          ENDIF
.>>>>
CCART900  MOVE      ZERO,EXIT
          GOTO      CCART999
.
CCART910  MOVE      "Invalid Care Type Record Key for Deletion",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CCART999
.
CCART920  MOVE      "Invalid Admission Record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CCART999
.
CCART999  RETURN
+
.--------------------------------------------------------------------------
. UPFOLD00 - This will update the pmi field PMPXFLDR with the appropriate
.            category code (cat FS) that has a matching TCINDC1 to FOLDERTY.
.
. Parameters: FOLDERT1 values 1=DVA,2=TAC,3=Work Comp and 4 = Family choice
.--------------------------------------------------------------------------
.
UPFOLD00  MATCH     "0",PTCNCOMF            * Not using compensable folders
          GOTO      UPFOLD99 IF EQUAL
.
          MOVE      "FS",CATEGORY
          PACK      KEY5,CATEGORY,SP70
          CALL      RDSCODE1
UPFOLD10  CALL      RDKCODE1
          BRANCH    OVRCD,UPFOLD99
.
          MATCH     CATEGORY,TCODE
          GOTO      UPFOLD99 IF NOT EQUAL
.
          MATCH     FOLDERTY,TCINDC1
          GOTO      UPFOLD80 IF EQUAL
.
          GOTO      UPFOLD10
.
UPFOLD80  PACK      KEY8,URNUMBER,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,UPFOLD99
.
          MATCH     ACODE,PMPXFLDR
          GOTO      UPFOLD99 IF EQUAL
.
          MOVE      ACODE,PMPXFLDR
.
          CALL      UPPMPX21
.
UPFOLD99  RETURN
+
.-----------------------------------------------------------------------------
. CHKF0000 - Check to see if this is a family choice care type. If it is update
.            the pmi folder to family choice if not TAC,WORK or VET claim code.
.-----------------------------------------------------------------------------
.
CHKF0000  PACK      KEY5,ANSC,ANSC,ACARE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CHKF8500
.
          MATCH     "3",THCSCOD                * Not family choice
          GOTO      CHKF8500 IF NOT EQUAL
.
          PACK      KEY5,ANSC,ANSL,ACLAIM,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CHKF9999
.
          PACK      KEY5,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
.
          SCAN      ANSV,KEY5
          IF        @EQUAL
            GOTO      CHKF9999                 * Skip VET
          ENDIF
.
          SCAN      ANSM,KEY5
          IF        @EQUAL
            GOTO      CHKF9999                 * Skip TAC
          ENDIF
.
          SCAN      ANSW,KEY5
          IF        @EQUAL
            GOTO      CHKF9999                 * Skip work comp
          ENDIF
.
          MATCH     "1",TCINDC1
          IF        @EQUAL
            MATCH     "1",TCINDC19
            IF        !@EQUAL
              GOTO      CHKF8550                 * Overseas/Ineligible
            ENDIF
          ENDIF
.
CHKF8000  MOVE      FOUR,FOLDERTY              * Set default to family choice
          CALL      UPFOLD00                   * Update PMI folder details
          GOTO      CHKF9999
.
CHKF8500  PACK      KEY5,ANSC,ANSL,ACLAIM,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CHKF9999
.
          PACK      KEY5,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
.
....      SCAN      "1",KEY5                                          *D-205505
          MATCH     "1",TCINDC1             * Ind.1 O'seas/Incompens. *I-205505
          IF        @EQUAL
            MATCH     "1",TCINDC19
            IF        !@EQUAL
CHKF8550      MOVE      SIX,FOLDERTY
              CALL      UPFOLD00
            ENDIF
          ENDIF
.
CHKF9999  RETURN
+
.******************************************************************************
.*                                 WPEI0000                                   *
.*                        Write A Record To patpeiaf                          *
.******************************************************************************
.
WPEI0000  READ      CONTROLF,EIGHTY8;*116,CHCSDTE,*124,CHCSST,*132,CHCSED
.
          COMPARE   SIX,PTCNHDPS                                      *I-241939
          IF        @EQUAL
            COMPARE   ONE,MRCNEPSC
            GOTO      WPEI0100 IF EQUAL     * Using Episode Coding in WA
          ENDIF
.
          COMPARE   THREE,PTCNHDPS
          GOTO      WPEI9999 IF NOT EQUAL   * Not in Victoria
.
WPEI0100  COMPARE   THREE,ASTAT
          GOTO      WPEI9000 IF NOT EQUAL   * Not discharged
.
          MATCH     CHCSDTE,DDATE
          GOTO      WPEI9000 IF LESS        * Discharge date < start HDP date
.
          MATCH     CHCSST,ADATE
          GOTO      WPEI9000 IF NOT LESS    * Adm date >= PRS2 extract start dte
.
          PACK      KEY16,SP8,AADMNO
          CALL      RDPTPEI1                * Read a PRS2 inc/exc file record
          COMPARE   ONE,OVRCD
          GOTO      WPEI9000 IF NOT EQUAL   * Record exists, dont write
.
          PACK      KEY16,CHCSST,AADMNO
          CALL      RDPTPEI1                * Read a PRS2 inc/exc file record
          COMPARE   ONE,OVRCD
          GOTO      WPEI9000 IF NOT EQUAL   * Record exists, dont write
.
          MOVE      SP8,PTPESTDT
          MOVE      AADMNO,PTPEADMN
          MOVE      TWO,PTPESTAT            * write 'include' record
          CALL      IBACLOCK                * Get the current date
          PACK      PTPEDATE,CCC,CYY,CMM,CDD
          REP       " 0",PTPEDATE
          MOVE      USERID,PTPEOPER
.
          MOVE      SP3,PTPERESN
          PACK      KEY5,ANSR,ANSN,SP3
          CALL      RDSCODE1                * Position on & read a codes file
WPEI1000  CALL      RDKCODE1                  record
          BRANCH    OVRCD,WPEI2000
.
          MATCH     "RN",TCODE
          GOTO      WPEI2000 IF NOT EQUAL   * Different category
.
          MATCH     HDPEQUIV,THCSCOD
          GOTO      WPEI1000 IF NOT EQUAL   * Different HDP equivalent
.
          MOVE      ACODE,PTPERESN
.
WPEI2000  MOVE      PASSCODE,PTPEOPER
          PACK      KEY16,PTPESTDT,PTPEADMN,SP70
          CALL      WRPTPEI1                * Write a PRS2 inc/exc file record
.
WPEI9000  MOVE      ZERO,EXIT
.
WPEI9999  RETURN
+
.******************************************************************************
.*                                 DPEI0000                                   *
.*                     Write A 'delete' Record To patpeiaf                    *
.******************************************************************************
.
DPEI0000  READ      CONTROLF,EIGHTY8;*116,CHCSDTE,*124,CHCSST,*132,CHCSED
          PACK      KEY16,SP8,ADMISSNO,SP70
          CALL      RDPTPEI1
          IF        OVRCD=0
            GOTO      DPEI9999
          ENDIF
.
DPEI1000  IF        ASTAT=1|ASTAT=5
            GOTO      DPEI5000
          ENDIF
.
          IF        ASTAT=3
            PACK      KEY8,ADMISSNO,SP70
            CALL      RDDSCH1                * discharged after prs2 reset date
            BRANCH    OVRCD,DPEI9999
            MATCH     DDATE,CHCSDTE
            GOTO      DPEI9999 IF NOT LESS
            GOTO      DPEI5000
          ENDIF
.
          GOTO      DPEI9999
.
DPEI5000  MOVE      SP8,PTPESTDT
          MOVE      AADMNO,PTPEADMN
          MOVE      THREE,PTPESTAT          * write 'delete' record
          CALL      IBACLOCK                * Get the current date
          PACK      PTPEDATE,CCC,CYY,CMM,CDD
          REP       " 0",PTPEDATE
          MOVE      USERID,PTPEOPER
.
          MOVE      SP3,PTPERESN
          PACK      KEY5,ANSR,ANSN,SP3
          CALL      RDSCODE1                * Position on & read a codes file
DPEI6000  CALL      RDKCODE1                  record
          BRANCH    OVRCD,DPEI7000
.
          MATCH     "RN",TCODE
          GOTO      DPEI7000 IF NOT EQUAL   * Different category
.
          MATCH     HDPEQUIV,THCSCOD
          GOTO      DPEI6000 IF NOT EQUAL   * Different HDP equivalent
.
          MOVE      ACODE,PTPERESN
.
DPEI7000  MOVE      PASSCODE,PTPEOPER
          PACK      KEY16,PTPESTDT,PTPEADMN,SP70
          CALL      WRPTPEI1                * Write a PRS2 inc/exc file record
.
DPEI9999  RETURN
+
.------------------------------------------------------------      * I CAR 23608
. Calculate the date range for current patient records
.------------------------------------------------------------
.
CALRAN00  READ      CONTROLF,HUND01;*49,CWEBSDAY  * no of days for search
          MOVE      SP70,STRTDATE
          MOVE      SP70,LASTDATE
.
. ---  calculate starting date ---
.
          CALL      IBACLOCK
          CALL      DMYCON
          SUB       CWEBSDAY,JULDAY
          MOVE      JULDAY,JWKDAY
          MOVE      JULYR,JWKYER
          MOVE      JULCC,JWKCC
          CALL      JULCON
          PACK      STRTDATE,CC,YY,MM,DD
          REP       " 0",STRTDATE
.
. ---  calculate last date ---
.
          CALL      IBACLOCK
          CALL      DMYCON
          ADD       CWEBSDAY,JULDAY
          MOVE      JULDAY,JWKDAY
          MOVE      JULYR,JWKYER
          MOVE      JULCC,JWKCC
          CALL      JULCON
          PACK      LASTDATE,CC,YY,MM,DD
          REP       " 0",LASTDATE
.
CALRAN99  RETURN
+
.------------------------------------------------------------
. Write to the current patient list
.------------------------------------------------------------
.
WRCPAT00  COMPARE   TWO,ASTAT
          GOTO      WRCPAT10 IF EQUAL
.
          CALL      CALRAN00
.
          MATCH     STRTDATE,ADATE        * before start date
          GOTO      WRCPAT99 IF LESS
.
          MATCH     ADATE,LASTDATE        * after end date
          GOTO      WRCPAT99 IF LESS
.
WRCPAT10  MOVE      AADMNO,PMCUVISN
          MOVE      ADATE,PMCUDATE
          MOVE      PTMASNAM,PMCUSURN
          MOVE      PMPXFNAM,PMCUGNAM
.         MOVE      PMPXSNAM,PMCUGNM2
          MOVE      PURNO,PMCUURNO
          MOVE      "3",PMCUSYST
          MOVE      SP70,PMCULOCN
          MOVE      SP70,PMCUOSIT
          MOVE      PMVXMHOS,PMCUHOSP
          MOVE      SP70,PMCUTSTA
          MOVE      SP70,PMCUTLOC
.
          PACK      KEY8,PMCUVISN,SP70
          CALL      RAPMCUR1
          IF        OVRCD=1
            CALL      WRPMCUR1
          ENDIF
.
WRCPAT99  RETURN
.
.-----------------------------------------------------------------------------
. CTRN0000 - Check transfer source
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.-----------------------------------------------------------------------------
.
CTRN0000  MATCH     Z70,TRNSFSRC                 * No transfer source
          GOTO      CTRN9000 IF EQUAL
.
          MATCH     SP70,TRNSFSRC                * No transfer source
          GOTO      CTRN9000 IF EQUAL
.
          PACK      TRNSCODE,TRNSFSRC,SP70
.
          MATCH     Z70,TRNSDATE
          GOTO      CTRN9000 IF EQUAL
.
          MATCH     SP70,TRNSDATE
          GOTO      CTRN9000 IF EQUAL
.
          PACK      TRNSDATE,TRANDATE,SP70
.
          CALL      CVAD0000                     * Validate transfer source
          BRANCH    EXIT,CTRN9100
.
CTRN9000  MOVE      ZERO,EXIT
          GOTO      CTRN9999
.
CTRN9100  MOVE      ONE,EXIT
.
CTRN9999  RETURN
.
+                                                * end I CAR 23608
.-----------------------------------------------------------------------------
.  Check Care Type and Separation Referral                              *I-49016
.-----------------------------------------------------------------------------
CTSF0000  MOVE      ZERO,EXIT
.
          SCAN      ANSI,DSCHSREF
          GOTO      CTSF9999 IF NOT EQUAL
.
          PACK      KEY5,ANSC,ANSC,ACARE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CTSF9990
.
          UNPACK    THCSCOD,DIM1
          REP       "F-E-",DIM1
          MATCH     "-",DIM1
          GOTO      CTSF9990 IF NOT EQUAL
.
          GOTO      CTSF9999
.
CTSF9990  MOVE      "Invalid Separation Referral for Care Type",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CTSF9999
.
CTSF9999  RETURN
+
.-----------------------------------------------------------------------------
.  Create MH records when patient is transferred to a MH Ward
.-----------------------------------------------------------------------------
CRMH0000  CALL      CLMEHVIS
          CALL      CLMEHDIA
          COMPARE   ONE,MHCNUSE             * not using MH?
          GOTO      CRMH9999 IF NOT EQUAL
.
. Post data to the Mental Health Visit file (mehvisaf)
.
          MOVE      AADMNO,MHVIADMN
          MOVE      PURNO,MHVIURNO
          PACK      KEY8,MHVIADMN           * Write or Update ?
          CALL      RAMHVIS1
          IF        OVRCD = 1
            MOVE      ONE,MHVISTAT         * admitted
            CALL      WRMHVIS1
          ENDIF
.
          MOVE      AADMNO,MHDIADMN
          MOVE      ADATE,MHDIDATE
          PACK      KEY16,MHDIADMN,MHDIDATE,SP70
          CALL      RAMHDIA1
          IF        OVRCD = 1
            MOVE      "0",MHDIMOHR           * Unsent
            PACK      MHDICDAT,CCC,CYY,CMM,CDD
            REP       " 0",MHDICDAT
            CLOCK     TIME,MHDICTIM
            MOVE      USERID,MHDICUID
            CALL      WRMHDIA1
          ENDIF
.
CRMH9999  RETURN
.==============================================================================
.******************************************************************************
.*                                 WESE0000                                   *
.*                Write/update wateseaf (episode details)                     *
.******************************************************************************
WESE0000  READ      CONTROLF,EIGHTY;*250,PTCNHDPS
.
          COMPARE   THREE,PTCNHDPS
          GOTO      WESE9999 IF NOT EQUAL   * Not in Victoria
.
          MOVE      AADMNO,KEY8             * Booking System
          CALL      RDBKREC1
          BRANCH    OVRCD,WESE9999
.
          COMPARE   TWO,BKRESTAT            * Cancelled booking?
          GOTO      WESE9999 IF EQUAL
.
          PACK      KEY19,BKREURNO,BKREPROC,BKRECNT
          CALL      RDTREA1
          BRANCH    OVRCD,WESE9999
.
          PACK      KEY17,WTWMECNT,Z70
          CALL      RSWTESE1
          CALL      RPWTESE1
          BRANCH    OVRCD,WESE9999
.
          MATCH     WTEEUNIQ,WTWMECNT
          GOTO      WESE9999 IF NOT EQUAL
.
          CALL      CHKESE00
          BRANCH    EXIT,WESE9999   * no changes
.
          PACK      WTEEURNO,WMURNO,SP70
          PACK      WTEEEDAT,SP70
          PACK      WTEEADAT,ADATE
          PACK      WTEEINSD,ACLAIM
          PACK      WTEEWEBU,SP70
          PACK      WTEEUDAT,SP70
          PACK      WTEEUTIM,SP70
          MOVE      ZERO,WTEEMANU
          PACK      WTEEASAS,SP70
.
          OPEN      WATTX1A1,"wattx1af"
.
          CALL      CLWATTX1
          PACK      KEY19,WMURNO,WMCODE,WMCNT,SP70
WESE2100  CALL      RDWTTX11
          BRANCH    OVRCD,WESE2500
.
          MOVE      WTTXASAS,WTEEASAS
.
WESE2500  CLOSE     WATTX1A1
.
          PACK      KEY17,WTEEUNIQ,WTEEEDAT,SP70
          CALL      RAWTESE1
          IF        OVRCD=0
            PACK      WTEEWEBU,WBSEUID,SP70
            CALL      IBACLOCK
            PACK      WTEEUDAT,CCC,CYY,CMM,CDD
            REP       " 0",WTEEUDAT
            CLOCK     TIME,WTEEUTIM
            REP       " 0",WTEEUTIM
            CALL      UPWTESE1
          ELSE
            PACK      WTEEWEBC,WBSEUID,SP70
            CALL      IBACLOCK
            PACK      WTEECDAT,CCC,CYY,CMM,CDD
            REP       " 0",WTEECDAT
            CLOCK     TIME,WTEECTIM
            REP       " 0",WTEECTIM
            CALL      WRWTESE1
          ENDIF
.
WESE9999  RETURN
+
.******************************************************************************
.*                                 CHKESE00                                   *
.*                Check if any wateseaf details have changed                  *
.******************************************************************************
CHKESE00  MOVE      ZERO,EXIT
.
          MATCH     WTEEADAT,ADATE
          GOTO      CHKESE90 IF NOT EQUAL
.
          MATCH     WTEEINSD,ACLAIM
          GOTO      CHKESE90 IF NOT EQUAL
.
          MOVE      ONE,EXIT                 * No Changes
.
CHKESE90  GOTO      CHKESE99
.
CHKESE99  RETURN
.
.******************************************************************************
.*  Write attending doctor to care team table as admitting doctor             *
.******************************************************************************
WCARE000  MOVE      PURNO,ALPCURNO
          MOVE      " 1",ALPCTYPE
          MOVE      ADOCTA,ALPCCODE
          MOVE      SP70,ALPCSITE
.
          PACK      KEY26,ALPCURNO,ALPCTYPE,ALPCCODE,ALPCSITE,SP70
          CALL      RDALPCT1
          IF        OVRCD=1
            MOVE      ZERO,ALPCADFL
            PACK      ALPCCDAT,CCC,CYY,CMM,CDD
            REP       " 0",ALPCCDAT
            CLOCK     TIME,ALPCCTIM
            MOVE      USERID,ALPCCUID
            MOVE      SP70,ALPCSPAR
            CALL      WRALPCT1
          ENDIF
.
WCARE999  RETURN
.
.-------------------------------------------------------------------------
. SPRGM000 - Set Parameters for Admission Multiple Regime Codes
. Returns:    EXIT   0
.                    1
.-------------------------------------------------------------------------
.
SPRGM000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SPRGM010,SPRGM020,SPRGM030
.
          GOTO      SPRGM910
.
SPRGM010  MOVE      QRYDATA,PTRGM001
          GOTO      SPRGM900
.
SPRGM020  MOVE      QRYDATA,PTRGM002
          GOTO      SPRGM900
.
SPRGM030  MOVE      QRYDATA,PTRGM003
          GOTO      SPRGM900
.
SPRGM900  MOVE      ZERO,EXIT
          GOTO      SPRGM999
.
SPRGM910  MOVE      ONE,EXIT
.
SPRGM999  RETURN
+
.-------------------------------------------------------------------------
. CHKBMN00 - Check Bed Management file for overlap
.-------------------------------------------------------------------------
CHKBMN00  MATCH     SP70,WARDCODE
          GOTO      CHKBMN99 IF EQUAL
          MATCH     SP70,BEDDCODE
          GOTO      CHKBMN90 IF EQUAL
.
          COMPARE   ZERO,STAYDAYS
          IF        @EQUAL
            CALL      GTTOTM00
            COMPARE   ZERO,ADJTIME
            GOTO      CHKBMN90 IF EQUAL
          ENDIF
.
          MATCH     "1",PRNXINDI
          GOTO      CHKBMN30 IF EQUAL
.
          PACK      KEY30,WARDCODE,BEDDCODE,ADMISDTE,ADMISTME,SP3,ADMISSNO,SP70
          CALL      RSPTBMD1
CHKBMN10  CALL      RPPTBMD1
          BRANCH    OVRCD,CHKBMN90
.
          MATCH     PTBDWARD,WARDCODE
          GOTO      CHKBMN90 IF NOT EQUAL
.
          MATCH     PTBDWBED,BEDDCODE
          GOTO      CHKBMN90 IF NOT EQUAL
.
          MATCH     ADMISDTE,PTBDDATE
          GOTO      CHKBMN90 IF LESS
.
          MATCH     ADMISSNO,PTBDADMN
          GOTO      CHKBMN10 IF EQUAL
.
          MOVE      PTBDDATE,STRTDATE
          MOVE      PTBDADTM,STRTTIME
          MOVE      PTBDLOSM,ADJTIME
          MOVE      PTBDLOSD,ADJDAYS
          CALL      GETEDT00
.
          MATCH     EXPDSDTE,ADMISDTE
          IF        @LESS
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                               ONE:
                               "</RETURN_VALUE>";
            GOTO      CHKBMN99
          ENDIF
          GOTO      CHKBMN90 IF NOT EQUAL
.
          MATCH     EXPDSTME,ADMISTME
          IF        @EQUAL | @LESS
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                               ONE:
                               "</RETURN_VALUE>";
            GOTO      CHKBMN99
          ENDIF
.
          GOTO      CHKBMN90
.
CHKBMN30  PACK      KEY30,WARDCODE,BEDDCODE,ADMISDTE,ADMISTME,SP3,ADMISSNO,SP70
          CALL      RSPTBMD1
CHKBMN32  CALL      RKPTBMD1
          BRANCH    OVRCD,CHKBMN90
.
          MATCH     PTBDWARD,WARDCODE
          GOTO      CHKBMN90 IF NOT EQUAL
.
          MATCH     PTBDWBED,BEDDCODE
          GOTO      CHKBMN90 IF NOT EQUAL
.
          MATCH     ADMISSNO,PTBDADMN
          GOTO      CHKBMN32 IF EQUAL
.
          MOVE      ADMISDTE,STRTDATE
          MOVE      ADMISTME,STRTTIME
          MOVE      ZERO,ADJTIME
          MOVE      ONE,F1
          MOVE      SP70,DIM10
.
CHKBMN35  COMPARE   F1,FOUR
          GOTO      CHKBMN40 IF EQUAL
          LOAD      DIM10,F1,PTRGM001,PTRGM002,PTRGM003
.
          PACK      DIM10,DIM10,SP70
.
          MATCH     SP70,DIM10
          IF        @EQUAL|@EOS
            ADD       ONE,F1
            GOTO      CHKBMN35
          ENDIF
.
          PACK      KEY13,DIM10,SP1,SP1,ZERO,SP70
          CALL      RDPMREG1
          IF        OVRCD=1
            ADD       ONE,F1
            GOTO      CHKBMN35
          ENDIF
.
          MOVE      ZERO,FORM3
          SQUEEZE   PMREELOS
          MOVE      PMREELOS,FORM3
          ADD       FORM3,ADJTIME
          ADD       ONE,F1
          GOTO      CHKBMN35
.
CHKBMN40  MOVE      STAYDAYS,ADJDAYS
          CALL      GETEDT00
.
          MATCH     EXPDSDTE,PTBDDATE
          IF        @LESS
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                               ONE:
                               "</RETURN_VALUE>";
            GOTO      CHKBMN99
          ENDIF
          GOTO      CHKBMN90 IF NOT EQUAL
.
          MATCH     EXPDSTME,PTBDADTM
          IF        @EQUAL|@LESS
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                               ONE:
                               "</RETURN_VALUE>";
            GOTO      CHKBMN99
          ENDIF
.
          GOTO      CHKBMN90
.
CHKBMN90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             "OK":
                             "</RETURN_VALUE>";
          GOTO      CHKBMN99
.
CHKBMN99  RETURN
.-------------------------------------------------------------------------
.GETEDT00 - Get Expected Discharge Date and Time
.-------------------------------------------------------------------------
GETEDT00  COMPARE   ZERO,ADJDAYS
          IF        @EQUAL
            MOVE      STRTDATE,EXPDSDTE
            GOTO      GETEDT50
          ENDIF
.
          UNPACK    STRTDATE,CCENT,CYEAR,CMON,CDAY
          CALL      ADJDAT00
          PACK      EXPDSDTE,CCENT,CYEAR,CMON,CDAY
.
GETEDT50  COMPARE   ZERO,ADJTIME
          IF        @EQUAL
            MOVE      STRTTIME,EXPDSTME
            GOTO      GETEDT99
          ENDIF
.
          CALL      CLDUR000
          MOVE      KEY5,EXPDSTME
.
GETEDT99  RETURN
.
.-----------------------------------------------------------------------------
. CLDUR000 - Calculate Expected Discharge Time
.-----------------------------------------------------------------------------
.
CLDUR000  UNPACK    STRTTIME,CHOUR,ANS,CMIN * unpack the start time
          MOVE      CMIN,FORM2              * minutes as a form2
          MOVE      FORM2,FORM4A            * set up work variable
          ADD       ADJTIME,FORM4A          * the total minutes to add
.
CLDUR200  COMPARE   ZERO,FORM4A
          GOTO      CLDUR300 IF NOT LESS    * positve amount
.
          ADD       "60",FORM4A             * make it positive
          MOVE      CHOUR,OPTION
          SUB       ONE,OPTION
          MOVE      OPTION,CHOUR            * sub 1 hour off time
          GOTO      CLDUR200
.
CLDUR300  MOVE      FORM4A,FORM4B           * save the minutes
.
          DIV       "60",FORM4A             * the total hours to add
          MOVE      CHOUR,FORM2             * hours as a form
          ADD       FORM4A,FORM2            * add the hours
.
CLDUR400  COMPARE   "24",FORM2
          GOTO      CLDUR500 IF LESS        * below 24 hours
.
          SUB       "24",FORM2              * get back to 24 hour time
.
          UNPACK    EXPDSDTE,CCENT,CYEAR,CMON,CDAY
          MOVE      "1",ADJDAYS
          CALL      ADJDAT00
          PACK      EXPDSDTE,CCENT,CYEAR,CMON,CDAY
.
          GOTO      CLDUR400
.
CLDUR500  MOVE      FORM2,CHOUR             * set up the hours
.
          MULT      "60",FORM4A             * the total minutes added
          SUB       FORM4A,FORM4B           * the minutes to add
          MOVE      FORM4B,FORM2            * get minutes as form2
.
          COMPARE   ZERO,FORM2
          GOTO      CLDUR800 IF NOT LESS    * not negative
.
          ADD       "60",FORM2              * make it positive
          MOVE      CHOUR,OPTION
          SUB       ONE,OPTION
          MOVE      OPTION,CHOUR            * sub 1 hour off time
.
CLDUR800  MOVE      FORM2,CMIN              * the minutes
.
          PACK      KEY5,CHOUR,COLON,CMIN * the end time
          REP       " 0",KEY5
.
CLDUR999  RETURN
.
.-------------------------------------------------------------------------
.GTTOTM00 - Get total time for regime codes
.-------------------------------------------------------------------------
GTTOTM00  MOVE      ZERO,ADJTIME
          MOVE      ONE,F1
          MOVE      SP70,DIM10
GTTOTM10  COMPARE   F1,FOUR
          GOTO      GTTOTM99 IF EQUAL
          LOAD      DIM10,F1,PTRGM001,PTRGM002,PTRGM003
.
          PACK      DIM10,DIM10,SP70
          MATCH     SP70,DIM10
          IF        @EQUAL|@EOS
            ADD       ONE,F1
            GOTO      GTTOTM10
          ENDIF
.
          PACK      KEY13,DIM10,SP1,SP1,ZERO,SP70
          CALL      RDPMREG1
          IF        OVRCD=1
            ADD       ONE,F1
            GOTO      GTTOTM10
          ENDIF
.
          MOVE      ZERO,FORM3
          SQUEEZE   PMREELOS
          MOVE      PMREELOS,FORM3
          ADD       FORM3,ADJTIME
          ADD       ONE,F1
          GOTO      GTTOTM10
.
GTTOTM99  RETURN
.-------------------------------------------------------------------------
.UPPBMN00 - Write/update the bed management table
.-------------------------------------------------------------------------
UPPBMN00  PACK      TRNTOWRD,TRNTOWRD,SP70
          PACK      TRNTOBED,TRNTOBED,SP70
          MATCH     SP70,TRNTOWRD
          GOTO      UPPBMN99 IF EQUAL
          GOTO      UPPBMN99 IF EOS
          MOVE      SP70,SAVEBRQN
.
          CALL      DELBMD00
.
          MOVE      ZERO,LOSDINDC              * Write/update patbmdaf
          MOVE      TRANDATE,SAVEDATE          * Bed management Detail Tab
          MOVE      TRANTIME,SAVETIME          * Length of Stay days
.
          MOVE      ZERO,LOOPDAYS
          MOVE      STAYDAYS,LOOPDAYS
.
. Restrict to latest 12 weeks to avoid timeout error from old admissions etc.
.
          IF        LOOPDAYS>84
            UNPACK    SAVEDATE,CCENT,CYEAR,CMON,CDAY
            ASSIGN    LOOPDAYS-84,ADJDAYS
            CALL      ADJDAT00
            PACK      SAVEDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      84,LOOPDAYS
          ENDIF
.
UPPBMN30  COMPARE   ZERO,LOOPDAYS
          GOTO      UPPBMN50 IF EQUAL
.
          MOVE      TWO,LOSDINDC
.
          PACK      KEY30,AADMNO,SAVEDATE,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,UPPBMN35
.
          MATCH     DAADMNO,DTADMN
          GOTO      UPPBMN35 IF NOT EQUAL
.
          MOVE      TWARD,PTBDWARD
          MOVE      TBED,PTBDWBED
          GOTO      UPPBMN38
.
UPPBMN35  MOVE      TRNTOWRD,PTBDWARD
          MOVE      TRNTOBED,PTBDWBED
.
UPPBMN38  MOVE      SAVEDATE,PTBDDATE
          MOVE      SAVETIME,PTBDADTM
.         MOVE      "    0",PTBDLOSM
          MOVE      LOOPDAYS,PTBDLOSD
          CALL      GTTOTM00
          MOVE      ADJTIME,PTBDLOSM
          MOVE      SP70,PTBDOPPE
          MOVE      AADMNO,PTBDADMN
.
          MOVE      "3",PTBDSTAT
.
          MOVE      "0",PTBDOVER
          MOVE      SAVEBRQN,PTBDBRQN
          MOVE      SP70,PTBDSPAR
.
          PACK      KEY30,PTBDWARD,PTBDWBED,PTBDDATE,PTBDADTM,SP3,PTBDADMN,SP70
          CALL      RAPTBMD1
          IF        OVRCD=1
            CALL      WRPTBMD1
          ELSE
            CALL      UPPTBMD1
          ENDIF
.
          SUB       ONE,LOOPDAYS
          UNPACK    SAVEDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      "1",ADJDAYS
          CALL      ADJDAT00
          PACK      SAVEDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      "00:00",SAVETIME
          GOTO      UPPBMN30
.
UPPBMN50  CALL      GTTOTM00                       * Write/update patbmdaf
.
          COMPARE   TWO,LOSDINDC
          IF        @EQUAL
            MOVE      SAVEDATE,PTBDDATE
            MOVE      SAVETIME,PTBDADTM
          ELSE
            MOVE      TRANDATE,PTBDDATE
            MOVE      TRANTIME,PTBDADTM
            MOVE      ONE,LOSDINDC
          ENDIF
.
          PACK      KEY30,AADMNO,PTBDDATE,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,UPPBMN55
.
          MATCH     DAADMNO,DTADMN
          GOTO      UPPBMN55 IF NOT EQUAL
.
          MOVE      TWARD,PTBDWARD
          MOVE      TBED,PTBDWBED
          GOTO      UPPBMN58
.
UPPBMN55  MOVE      TRNTOWRD,PTBDWARD
          MOVE      TRNTOBED,PTBDWBED
.
UPPBMN58  MOVE      ADJTIME,PTBDLOSM
          MOVE      "  0",PTBDLOSD
          MOVE      SP70,PTBDOPPE
          MOVE      AADMNO,PTBDADMN
.
          MOVE      "3",PTBDSTAT
.
          MOVE      "0",PTBDOVER
          MOVE      SAVEBRQN,PTBDBRQN
          MOVE      SP70,PTBDSPAR
.
          PACK      KEY30,PTBDWARD,PTBDWBED,PTBDDATE,PTBDADTM,SP3,PTBDADMN,SP70
          CALL      RAPTBMD1
          IF        OVRCD=1
            CALL      WRPTBMD1
          ELSE
            CALL      UPPTBMD1
          ENDIF
          MOVE      PTBDDATE,SAVEDATE
.
UPPBMN70  COMPARE   ZERO,LOSDINDC                         * Override previous
          GOTO      UPPBMN99 IF EQUAL                     * Records in patbmdaf
.
          MATCH     SP70,TRNTOBED
          GOTO      UPPBMN99 IF EQUAL
          GOTO      UPPBMN99 IF EOS
.
          MOVE      TRANTIME,DIM5
          PACK      KEY30,TRNTOWRD,TRNTOBED,TRANDATE,DIM5,SP3,AADMNO,SP70
          CALL      RDPTBMD1
          BRANCH    OVRCD,UPPBMN99
.
          MOVE      PTBDDATE,SAVEDATE
          MOVE      PTBDADTM,SAVETIME
          MOVE      PTBDLOSD,SAVELOSD
          MOVE      PTBDLOSM,SAVELOSM
.
UPPBMN73  CALL      RPPTBMD1
          BRANCH    OVRCD,UPPBMN80
.
          MATCH     TRNTOWRD,PTBDWARD
          GOTO      UPPBMN80 IF NOT EQUAL
.
          MATCH     TRNTOBED,PTBDWBED
          GOTO      UPPBMN80 IF NOT EQUAL
.
          MATCH     SAVEDATE,PTBDDATE
          GOTO      UPPBMN80 IF NOT EQUAL
.
          MOVE      PTBDDATE,STRTDATE
          MOVE      PTBDADTM,STRTTIME
          MOVE      PTBDLOSM,ADJTIME
          MOVE      PTBDLOSD,ADJDAYS
          CALL      GETEDT00
.
          MATCH     EXPDSDTE,SAVEDATE
          IF        @LESS
            GOTO      UPPBMN78
          ENDIF
          GOTO      UPPBMN73 IF NOT EQUAL
.
          MATCH     EXPDSTME,SAVETIME
          IF        @EQUAL | @LESS
            GOTO      UPPBMN78
          ENDIF
.
          GOTO      UPPBMN73
.
UPPBMN78  MOVE      ONE,PTBDOVER
          CALL      UPPTBMD1
          GOTO      UPPBMN73
.
UPPBMN80  PACK      KEY30,TRNTOWRD,TRNTOBED,AADMNO,Z70    * Override following
          CALL      RSPTBMD3                              * Records in patbmdaf
          CALL      RPPTBMD3
          BRANCH    OVRCD,UPPBMN99
.
          MATCH     DAADMNO,PTBDADMN
          GOTO      UPPBMN99 IF NOT EQUAL
.
          MOVE      SAVEDATE,STRTDATE
          MOVE      SAVETIME,STRTTIME
          MOVE      PTBDLOSM,ADJTIME
          MOVE      SAVELOSD,ADJDAYS
          CALL      GETEDT00
.
          PACK      KEY30,TRNTOWRD,TRNTOBED,SAVEDATE,SAVETIME,SP3,DAADMNO,SP70
          CALL      RDPTBMD1
          BRANCH    OVRCD,UPPBMN99
.
UPPBMN85  CALL      RKPTBMD1
          BRANCH    OVRCD,UPPBMN99
.
          MATCH     TRNTOWRD,PTBDWARD
          GOTO      UPPBMN99 IF NOT EQUAL
.
          MATCH     TRNTOBED,PTBDWBED
          GOTO      UPPBMN99 IF NOT EQUAL
.
          MATCH     DAADMNO,PTBDADMN
          GOTO      UPPBMN85 IF EQUAL
.
          MATCH     EXPDSDTE,PTBDDATE
          IF        @LESS
            GOTO      UPPBMN88
          ENDIF
          GOTO      UPPBMN85 IF NOT EQUAL
.
          MATCH     EXPDSTME,PTBDADTM
          IF        @EQUAL | @LESS
            GOTO      UPPBMN88
          ENDIF
.
          GOTO      UPPBMN85
.
UPPBMN88  MOVE      "1",PTBDOVER
          CALL      UPPTBMD1
.
          GOTO      UPPBMN85
.
UPPBMN99  RETURN
.
.-------------------------------------------------------------------------
.DELBMN00 - Delete old patbmdaf records
.-------------------------------------------------------------------------
DELBMD00  MOVE      SP70,SAVEBRQN
          PACK      KEY30,AADMNO,SP70
          CALL      RSPTBMD2
DELBMD10  CALL      RKPTBMD2
          BRANCH    OVRCD,DELBMD99
          MATCH     DAADMNO,PTBDADMN
          GOTO      DELBMD99 IF NOT EQUAL
          MOVE      PTBDBRQN,SAVEBRQN
          PACK      KEY30,PTBDADMN,PTBDDATE,PTBDADTM,PTBDWARD,PTBDWBED,PTBDOPPE,SP70
          CALL      DEPTBMD2
          GOTO      DELBMD10
.
DELBMD99  RETURN
.-------------------------------------------------------------------------
. GETRGM00 - Get Multiple Regime Code for Admission Number
.-------------------------------------------------------------------------
GETRGM00  UNPACK    DIM127,D1,KEY2,DIM127
.
          PACK      KEY10,ADMISSNO,KEY2,DIM127
          CALL      RDPTRGM1
          BRANCH    OVRCD,GETRGM99
.
          WRITE     HTMLFILE;PTRGREGM;
.
GETRGM99  RETURN
.
.-------------------------------------------------------------------------
. GETRG000 - Get First 3 Regime Codes for Admission Number
.-------------------------------------------------------------------------
GETRG000  MATCH     SP70,PTRGM001
          IF        @EQUAL
            PACK      KEY10,ADMISSNO,SP1,ONE,SP70
            CALL      RDPTRGM1
            BRANCH    OVRCD,GETRG999
            PACK      PTRGM001,PTRGREGM,SP70
          ENDIF
.
          MATCH     SP70,PTRGM002
          IF        @EQUAL
            PACK      KEY10,ADMISSNO,SP1,TWO,SP70
            CALL      RDPTRGM1
            BRANCH    OVRCD,GETRG999
            PACK      PTRGM002,PTRGREGM,SP70
          ENDIF
.
          MATCH     SP70,PTRGM003
          IF        @EQUAL
            PACK      KEY10,ADMISSNO,SP1,THREE,SP70
            CALL      RDPTRGM1
            BRANCH    OVRCD,GETRG999
            PACK      PTRGM003,PTRGREGM,SP70
          ENDIF
.
GETRG999  RETURN
.
.------------------------------------------------------------
. BQRQ0000 - Update Bed Request Bed Management Details
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
BDRQ0000  PACK     KEY30,ADMISSNO,SP70
          CALL     RSPTBMD2
BDRQ1000  CALL     RKPTBMD2
          BRANCH   OVRCD,BDRQ2000
.
          MATCH    ADMISSNO,PTBDADMN
          GOTO     BDRQ2000 IF NOT EQUAL
.
          MOVE     BDRQADMN,PTBDBRQN
          CALL     UPPTBMD2
.
          GOTO     BDRQ1000
.
BDRQ2000  PACK      KEY18,ADMISSNO,SP70
          CALL      RSBKUNQ1
          CALL      RKBKUNQ1
          IF        OVRCD=1
            GOTO      BDRQ9000
          ENDIF
.
          MATCH     BKUNVISN,ADMISSNO
          GOTO      BDRQ9000 IF NOT EQUAL
.
          PACK      BKUNLADM,BDRQADMN,SP70
          PACK      BKUNWEBL,WBSEUID,SP70
          CALL      IBACLOCK
          PACK      BKUNDATL,CCC,CYY,CMM,CDD,SP70
          REP       " 0",BKUNDATL
          PACK      BKUNTIML,CTIMEIS,SP70
          PACK      KEY18,BKUNVISN,BKUNUNIQ,SP70
          CALL      UPBKUNQ1
.
BDRQ9000  MOVE     ZERO,EXIT
          GOTO     BDRQ9999
.
BDRQ9999  RETURN
.
.------------------------------------------------------------------------------
. Check for on leave beds
.------------------------------------------------------------------------------
CHKCLB00  MATCH     SP3,WARDCODE
          GOTO      CHKCLB90 IF EQUAL
          MATCH     SP3,BEDDCODE
          GOTO      CHKCLB90 IF EQUAL
.

CHKCLB02  PACK    KEY22,WARDCODE,BEDDCODE,SP70
          CALL    RSPMBDC1
CHKCLB05  CALL    RKPMBDC1
          BRANCH  OVRCD,CHKCLB90
.
          MATCH   PMBCWARD,WARDCODE
          GOTO    CHKCLB90 IF NOT EQUAL
.
          MATCH   PMBCBED,BEDDCODE
          GOTO    CHKCLB90 IF NOT EQUAL
.
          MATCH   PMBCFRDT,ADMISDTE
          GOTO    CHKCLB90 IF LESS
.
          IF      @EQUAL
            MATCH   PMBCFRTM,ADMISTME
            GOTO    CHKCLB90 IF LESS
          ENDIF
.
          MATCH   ADMISDTE,PMBCTODT
          GOTO    CHKCLB05 IF LESS
.
          IF      @EQUAL
            MATCH   ADMISTME,PMBCTOTM
            GOTO    CHKCLB05 IF LESS
          ENDIF
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    ONE:
                    "</RETURN_VALUE>"
          GOTO      CHKCLB99         * Yes, display error and exit.
.
CHKCLB90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             "OK":
                             "</RETURN_VALUE>";
          GOTO      CHKCLB99
.
CHKCLB99  RETURN
.
.------------------------------------------------------------
. Write on leave SFA file stuff
.------------------------------------------------------------
.
LASF0000  COMPARE   THREE,PTCNHDPS
          GOTO      LASF9000 IF NOT EQUAL   * Not in Victoria
.
          MATCH     PTASF001,Z70
          IF        !@EQUAL
            MOVE      PTASF001,PTAFCTYP
          ENDIF
.
          MATCH     PTASF002,Z70
          IF        !@EQUAL
            MOVE      PTASF002,PTAFCROL
          ENDIF
.
          MATCH     PTASF003,Z70
          IF        !@EQUAL
            MOVE      PTASF003,PTAFCSID
          ENDIF
.
          PACK      KEY5,ANST,ANSL,TRNLVTYP,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      "0",ANS
            MOVE      ZERO,FORM1
            UNPACK    THCSCOD,ANS
            REP       "C1S2H3R5E6",ANS                        * I CAR 42820
            MOVE      ANS,PTAFCODE                            * Funding arrmnt
            MOVE      ANS,FORM1
            BRANCH    FORM1,LASF0075,LASF0075,LASF0075:
                            LASF1000,LASF0075,LASF0075        * end I CAR 42820
            GOTO      LASF1000            * remove the reord
          ENDIF
          GOTO      LASF0075
.
LASF0075  MATCH     "5",PTAFCODE
          GOTO      LASF0080 IF EQUAL
          MATCH     "6",PTAFCODE
          GOTO      LASF0080 IF EQUAL
          GOTO      LASF0100
LASF0080  PACK      PTAFCTYP,SP70
          PACK      PTAFCROL,SP70
          PACK      PTAFCSID,SP70
          GOTO      LASF0200                * end I CAR 42820
LASF0100  MATCH     SP1,PTAFCTYP
          GOTO      LASF0200 IF NOT EQUAL
.
          MATCH     SP1,PTAFCROL
          GOTO      LASF0200 IF NOT EQUAL
.
LASF0200  MOVE      AADMNO,PTAFADMN
          MOVE      "L",PTAFTYPE
          PACK      PTAFDATE,TDATE,SP70
          PACK      PTAFTIME,TTIME,SP70
          MOVE      SP30,PTAFSPAR
          PACK      KEY25,PTAFADMN,PTAFTYPE,PTAFDATE,PTAFTIME
          CALL      RAPTASF1                * Read an admin SFA file record
          IF        OVRCD=1
            CALL      WRPTASF1              * Write an admin SFA file record
          ELSE
            CALL      UPPTASF1              * Update an admin SFA file record
          ENDIF
          GOTO      LASF9000
.
LASF1000  PACK      KEY25,AADMNO,ANSL,SP30
          CALL      RDPTASF1                * Read an admin SFA file record
          COMPARE   ONE,OVRCD
          CALL      DEPTASF1 IF NOT EQUAL   * Delete an admin SFA file record
.
LASF9000  MOVE      ZERO,EXIT
.
LASF9999  RETURN
+
.------------------------------------------------------------
. Check max number of patients Day Oncology view
.------------------------------------------------------------
DONP0000  MATCH     SP70,PTCNDONP
          GOTO      DONP9999 IF EQUAL
          GOTO      DONP9999 IF EOS
.
          SQUEEZE   PTCNDONP
          MOVE      ZERO,FORM5B
          MOVE      PTCNDONP,FORM5B
.
          COMPARE   ZERO,FORM5B
          GOTO      DONP9999 IF EQUAL
.
          MOVE      ZERO,FORM5A
          PACK      KEY30,WARDCODE,ADMISDTE,SP70
          CALL      RSPTBMD4
DONP1000  CALL      RKPTBMD4
          BRANCH    OVRCD,DONP9000
.
          MATCH     WARDCODE,PTBDWARD
          GOTO      DONP9000 IF NOT EQUAL
.
          MATCH     ADMISDTE,PTBDDATE
          GOTO      DONP9000 IF NOT EQUAL
.
          MATCH     SP70,PTBDWBED
          GOTO      DONP1000 IF EQUAL
          GOTO      DONP1000 IF EOS
.
          MATCH     "00:00",PTBDADTM
          IF        @EQUAL
            GOTO      DONP1000
          ELSE
            MATCH     SP70,PTBDLOSM
            IF        !@EQUAL & !@EOS
.
              MOVE      ZERO,FORM5
              MOVE      PTBDLOSM,FORM5
.
              IF        FORM5=0
                GOTO      DONP1000
              ENDIF
.
            ELSE
.
              GOTO      DONP1000

            ENDIF
.
          ENDIF
.
          ADD       ONE,FORM5A
          GOTO      DONP1000
.
DONP9000  ADD       ONE,FORM5A
          COMPARE   FORM5A,FORM5B
          IF        @LESS
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
            ONE:
            "</RETURN_VALUE>";
          ELSE
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
            "OK":
            "</RETURN_VALUE>";
          ENDIF
.
DONP9999  RETURN
+
.------------------------------------------------------------
. CHKWBD00 - Validate Ward Bed
.------------------------------------------------------------
CHKWBD00  MATCH     SP70,WARDCODE                * Expected ward populated
          GOTO      CHKWBD90 IF EQUAL
          GOTO      CHKWBD90 IF EOS
.
          MATCH     Z70,WARDCODE
          GOTO      CHKWBD90 IF EQUAL
.
          MATCH     SP70,BEDDCODE                * Expected bed populated
          GOTO      CHKWBD80 IF EQUAL
          GOTO      CHKWBD80 IF EOS
.
          MATCH     Z70,BEDDCODE
          GOTO      CHKWBD80 IF EQUAL
.
          PACK      KEY6,WARDCODE,BEDDCODE,SP70  * Validate ward and bed
          CALL      RDWARD1
          BRANCH    OVRCD,CHKWBD92
.
          GOTO      CHKWBD90
.
CHKWBD80  PACK      KEY6,WARDCODE,SP70           * Validate ward only
          CALL      RDWARD1
          BRANCH    OVRCD,CHKWBD91
.
CHKWBD90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    " OK ":
                    "</RETURN_VALUE>"
          GOTO      CHKWBD99
.
CHKWBD91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                        "Invalid Expected Ward":
                        "</RETURN_VALUE>"
          GOTO      CHKWBD99
.
CHKWBD92  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                        "Invalid Expected Ward/Bed":
                        "</RETURN_VALUE>"
          GOTO      CHKWBD99
.
CHKWBD99  RETURN
+
.
.*******************************************************************************
. Check FIM details do not overlap with new Admission Date  
.*******************************************************************************
CHOLA000  MATCH     "1",PTCNWFIM
          GOTO      CHOLA999 IF NOT EQUAL
.
          PACK      KEY24,ADMISSNO,PTMIS001,SP70
          CALL      RSPTFIM1
CHOLA100  CALL      RKPTFIM1
          IF        OVRCD = 1
            GOTO      CHOLA999
          ENDIF
.
          MATCH     ADMISSNO,PTFIVISN
          GOTO      CHOLA999 IF NOT EQUAL
.
          MATCH     "1",PTFIDELT
          GOTO      CHOLA100 IF EQUAL
.
          MOVE      PTFIDATE,DATEFIM
          MOVE      PTMIS001,DATECHG
          IF        ( DATEFIM > DATECHG )
            GOTO      CHOLA999
          ENDIF
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "FIM Details exist for this patient.   ":
                             "Modify FIM Details before modifying the ":
                             "Admission Date.":
                             "</RETURN_VALUE>"
.
CHOLA999  RETURN
.
.*******************************************************************************
. Check FIM details do not overlap with new Discharge Date   
.*******************************************************************************
CHOLD000  MATCH     "1",PTCNWFIM
          GOTO      CHOLD999 IF NOT EQUAL
.
          PACK      KEY24,ADMISSNO,PTDSC001,Z70
          CALL      RSPTFIM1
CHOLD100  CALL      RKPTFIM1
          IF        OVRCD = 1
            GOTO      CHOLD999
          ENDIF
.
          MATCH     ADMISSNO,PTFIVISN
          GOTO      CHOLD999 IF NOT EQUAL
.
          MATCH     "1",PTFIDELT
          GOTO      CHOLD100 IF EQUAL
.
          MOVE      PTFIDATE,DATEFIM
          MOVE      PTDSC001,DATECHG
          IF        ( DATEFIM < DATECHG )
            GOTO      CHOLD999
          ENDIF
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "FIM Details exist for this patient.   ":
                             "Modify FIM Details before modifying the ":
                             "Discharge Date.":
                             "</RETURN_VALUE>"
.
CHOLD999  RETURN
.*******************************************************************************
. Validate confirmed Admission Date matches Inpatient Admission Date  CAR 252671
.*******************************************************************************
VALDTE00  CALL      XMLHED00
          BRANCH    EXIT,VALDTE99
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,VALDTE98
.
          PACK      KEY8,DAADMNO
          CALL      RDBKREC1
          BRANCH    OVRCD,VALDTE98
.
          MATCH     SP70,BKREPROC
          BRANCH    OVRCD,VALDTE98
.
          PACK      KEY19,BKREURNO,BKREPROC,BKRECNT,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,VALDTE98
.
          MATCH     BKREEDAT,PTMIS001
          GOTO      VALDTE98 IF EQUAL
.
VALDTE90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Confirmed Admission date for this booking ":
                             "will not match the Inpatient Admission date. ":
                             "   Unable to modify":
                             "</RETURN_VALUE>"
          GOTO      VALDTE98
.
VALDTE98  CALL      XMLEND00
VALDTE99  RETURN
+
.*******************************************************************************
. Check If FIM links will be broken by this Admission Type change    CAR 317209
.*******************************************************************************
CHKAT000  PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1                  * Read the Master File
          BRANCH    OVRCD,CHKAT999
.
          PACK      KEY8,ADMISSNO
          CALL      RDVISA1                  * Read the visit file
          BRANCH    OVRCD,CHKAT999
.
          PACK      KEY5,ANSC,ANSC,ACARE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CHKAT998
.                                            * Check if this is a Rehab Patient
          MATCH     "2",TCINDC6
          GOTO      CHKAT998 IF NOT EQUAL
.                                            * Check if Program exists for Visit
          PACK      KEY31,URNUMBER,SP70
          CALL      RSPMUPG1
CHKAT100  CALL      RKPMUPG1
          BRANCH    OVRCD,CHKAT998
.
          MATCH     URNUMBER,PMUGURNO
          GOTO      CHKAT998 IF NOT EQUAL
.
          MATCH     PMUGATYP,ATYPE
          GOTO      CHKAT100 IF NOT EQUAL
.
          MATCH     SP70,PMUGCLAM
          IF        !@EQUAL
            MATCH     PMUGCLAM,ACLAIM
            GOTO      CHKAT100 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,PMUGFUND
          IF        !@EQUAL
            MATCH     PMUGFUND,AFUNDH
            GOTO      CHKAT100 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,PMUGTABT
          IF        !@EQUAL
            MATCH     PMUGTABT,AFNDTB
            GOTO      CHKAT100 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,PMUGEDAT
          IF        !@EQUAL
            MATCH     PVIDATE,PMUGEDAT
            GOTO      CHKAT100 IF LESS
          ENDIF
.
          MATCH     PVIDATE,PMUGSDAT
          GOTO      CHKAT998 IF LESS
.
          MATCH     SP70,PMUGENDD
          IF        !@EQUAL
            MATCH     PMUGENDD,PVIDATE
            GOTO      CHKAT998 IF LESS
          ENDIF
.                                            * Program exists for Visit
CHKAT997  MOVE      SP20,TDESC
          PACK      KEY5,CODEA,ATYPE
          CALL      RDCODE1
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                               ONE,"|",TDESC:
                              "</RETURN_VALUE>";
          GOTO      CHKAT999
.                                            * No Program exists for Visit
CHKAT998  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             "OK":
                             "</RETURN_VALUE>";
.
CHKAT999  RETURN
+
.------------------------------------------------------------
. UPDBRD00 - Update Boarder End Date and Time on discharge
.------------------------------------------------------------
UPDBRD00  PACK     KEY26,DAADMNO,SP70
          CALL     RSPTBRD3
UPDBRD10  CALL     RKPTBRD3
          BRANCH   OVRCD,UPDBRD99
.
          MATCH    DAADMNO,PTBRVISN
          GOTO     UPDBRD99 IF NOT EQUAL
.
          MOVE     DDATE,PTBREDAT
          MOVE     DTIME,PTBRETIM
.
          CALL     UPPTBRD3
.
          GOTO     UPDBRD10
.
UPDBRD99  RETURN
+
.-----------------------------------------------------------------------------
. VDOC0000 - Check doctors active dates
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.-----------------------------------------------------------------------------
.
VDOC0000  COMPARE   ONE,CHGDOC
          GOTO      VDOC9999 IF NOT EQUAL
.
          MATCH     SP70,TRNADOCT           * doctor to validate
          GOTO      VDOC9100 IF EQUAL
.
          PACK      CHCKDOCT,TRNADOCT,SP70
          PACK      CHCKDATE,TRANDATE,SP70  * date to validate
          MOVE      ONE,CHCKTYPE
.
          CALL      ACTDOC00
          BRANCH    EXIT,VDOC9100
.
VDOC9000  MOVE      ZERO,EXIT
          GOTO      VDOC9999
.
VDOC9100  MOVE      ONE,EXIT
.
VDOC9999  RETURN
+
.-----------------------------------------------------------------------------
. VLVE0000 - Check the change of doctor doesn't fall between a leave
.            and return from leave transfer record.
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.-----------------------------------------------------------------------------
.
VLVE0000  PACK      KEY30,AADMNO,TRANDATE,TRANTIME,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,VLVE9000
.
          MATCH     TADMN,AADMNO
          GOTO      VLVE9000 IF NOT EQUAL
.
          MATCH     ANSL,TMOVE             * Leave
          GOTO      VLVE9100 IF EQUAL
.
VLVE9000  MOVE      ZERO,EXIT
          GOTO      VLVE9999
.
VLVE9100  MOVE      "Patient is On Leave at change date/time",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VLVE9999
.
VLVE9999  RETURN
+
.------------------------------------------------------------
. ACTDOC00 - Validate doctors active dates
.
. CHCKDOCT - Doctors code to validate
. CHKCDATE - Date to validate
. CHCKTYPE - Doctors type to validate 1= Attending 2=Referring + Attending
. Returns:  EXIT   0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
.
ACTDOC00  MATCH     SP70,CHCKDOCT           * No doctors code so exit
          GOTO      ACTDOC90 IF EQUAL
.
          PACK      KEY6,CHCKDOCT,SP70
          CALL      RDDOCT1
          BRANCH    OVRCD,ACTDOC93
.
          IF         CHCKTYPE=1
            COMPARE   TWO,DRSTAT              * Active Outside
            GOTO      ACTDOC92 IF EQUAL
          ENDIF
.
          IF        IBCNMHOS=1
            MATCH    "1",PTDOHOSS
            IF       @EQUAL
              PACK     KEY13,WBSEHOSP,DCODE,SP70
              CALL     RDMLHCP1               * use mlthcp dates if they exist
              IF        OVRCD=0
                MATCH     SP70,MLHCSDAT
                IF        !@EQUAL
                  MOVE      MLHCSDAT,PTDOSDAT    * start date
                ENDIF
                MATCH     SP70,MLHCEDAT
                IF        !@EQUAL
                  MOVE      MLHCEDAT,PTDOEDAT    * end date
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     PTDOSDAT,CHCKDATE       * Doctors start date
          GOTO      ACTDOC91 IF LESS
.
          MATCH     SP70,PTDOEDAT           * Still active if no end date
          GOTO      ACTDOC90 IF EQUAL
.
          MATCH     PTDOEDAT,CHCKDATE       * Doctors end date
          GOTO      ACTDOC91 IF NOT LESS
.
ACTDOC90  MOVE      ZERO,EXIT               * Valid doctor code
          GOTO      ACTDOC99
.
ACTDOC91  CLEAR     WEBTITLE
          APPEND    "This doctor was inactive at this date - ",WEBTITLE
          APPEND    KEY6,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ACTDOC99
.
ACTDOC92  CLEAR     WEBTITLE
          APPEND    "This doctor was active outside (Referring) at ",WEBTITLE
          APPEND    "this date - ",WEBTITLE
          APPEND    KEY6,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ACTDOC99
.
ACTDOC93  CLEAR     WEBTITLE
          APPEND    "Invalid doctor code - ",WEBTITLE
          APPEND    KEY6,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ACTDOC99
.
ACTDOC99  RETURN
+
.*****************************************************************************
.*  CHKDVA00
.*  Procedure to check if a patient has a DVA concession card
.*  Exit=0  No concession cards exist
.*      =1  Valid DVA concession card(s) exist
.*****************************************************************************
          DEFPROC   CHKDVA00
.
          INC       PMSCCDFD/INC
.
          CALL      IBACLOCK                * Get the current date
          PACK      XDATE,CCC,CYY,CMM,CDD
          REP       " 0",XDATE
.
          MOVE      ZERO,EXIT               * default to no ccards
          OPEN      PMSCCDA1,"pmsccdaf"
.
          PACK      KEY19,PURNO,SP70
          CALL      RSPMCCD1           * Read concession card table
CHKDVA10  CALL      RKPMCCD1
          BRANCH    OVRCD,CHKDVA99
.
          MATCH     PURNO,PMCDURNO     * Check same UR
          GOTO      CHKDVA99 IF NOT EQUAL
.
          MATCH     XDATE,PMCDEXDT     * check if exp. date is >= current date
          IF        @LESS
            GOTO      CHKDVA10
          ENDIF
.
          MATCH     SP70,PMCDDVAC
          GOTO      CHKDVA10 IF EQUAL
.
          PACK      KEY5,ANSD,ANSX,PMCDDVAC,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CHKDVA10
.
          MATCH     ANSG,THCSCOD
          GOTO      CHKDVA10 IF NOT EQUAL
.
          MOVE      ONE,EXIT
          GOTO      CHKDVA99
.
          INC       PMSCCDIO/INC
          INC       IBAOVRIO/INC
.
CHKDVA99  CLOSE     PMSCCDA1
.
          ENDPROC
+
.------------------------------------------------------------
. FPRA0000 - Update PRFA
.------------------------------------------------------------
FPRA0000  MATCH     "1",PTCNXCOM
          GOTO      FPRA9999 IF NOT EQUAL
.
          PACK      KEY5,ANSC,ANSL,ACLAIM
          CALL      RDCODE1
          BRANCH    OVRCD,FPRA9999
.
          MOVE      SP70,DIM1
          MOVE      TCINDC1,DIM1
          REP       "P~J~ ~",DIM1
          MATCH     "~",DIM1
          GOTO      FPRA9999 IF NOT EQUAL
.
          MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,FPRA9999
.
          COMPARE   ONE,PTCNPAOF              * Using 'Parent of' option?
          GOTO      FPRA3100 IF NOT EQUAL     * no
.
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          CALL      CALCAGE                   * CALCAGE uses PBDATE
          COMPARE   PSAGEYRS,CAGECOFF         * Child?
          GOTO      FPRA3100 IF LESS          * No
.
.-------- Setup 'Parent of' as Person Responsible for Account
.-------- This is done by storing a "@" (defined as ATCHAR) as
.-------- the first character of PKNAME, and defaulting PKRELP
.-------- to "PARENT".  Any letters, statements, invoices, etc
.-------- should print 'Parent of' in replace of "@".
.
          MOVE      SP1,ANS
          MOVE      PGNAME,ANS
          PACK      PKNAME,SP70
.         PACK      PKNAME,ATCHAR,SP1,ANS,DOT,PTMASNAM
.
          CLEAR     PKNAME
          APPEND    "Parent of ",PKNAME
          APPEND    ANS,PKNAME
          APPEND    DOT,PKNAME
          APPEND    SP1,PKNAME
          APPEND    PTMASNAM,PKNAME
          APPEND    SP70,PKNAME
          RESET     PKNAME
          MOVE      "Parent    ",PKRELP
          GOTO      FPRA3200
.
.-------- Use self as P.R.A.
FPRA3100  MOVE      SP1,ANS
          MOVE      PGNAME,ANS
          PACK      PKNAME,PTITL,SP1,ANS,DOT,PTMASNAM,SP70
          MOVE      SP70,PKRELP
.         MOVE      "SELF      ",PKRELP
.
FPRA3200  MOVE      "2",KEY1               * Postal Address
          CALL      DADR0000
          BRANCH    EXIT,FPRA4000          * default to patient details
.
          MOVE      PMCEADD1,PKADD1
          MOVE      PMCEADD2,PKADD2
          MOVE      PMCEADD3,PKSUBR
          MOVE      PMCEADD4,PKADD4
          MOVE      PMCEPOST,PKPOST
          MOVE      PMCETELB,PKTELEB
          MOVE      PMCERELP,PKRELP
          MOVE      PMCETELP,PKTELEP
          MOVE      PMCETELM,PTREMOBL
          GOTO      FPRA5000

FPRA4000  PACK      PKADD1,PADD1,SP30,SP20
          PACK      PKADD2,PADD2,SP30,SP20
          PACK      PKSUBR,PSUBRB,SP20,SP30
          PACK      PKADD4,PADD4,SP30,SP10
          PACK      PKPOST,PPOST,SP10,SP20
          PACK      PKTELEP,PTELEP,SP20
          PACK      PKTELEB,PTELEB,SP20
          PACK      PTREMOBL,PTMXCELL,SP20
.
FPRA5000  MOVE      ADMISSNO,PKADMN
          MOVE      SP70,PTRESNAM
          MOVE      SP70,PTREGNAM
          MOVE      SP70,PTRESPAR
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RAPTRES1
          IF        OVRCD=0
            CALL      UPPTRES1
          ELSE
            CALL      WRPTRES1
          ENDIF
.
FPRA9999  RETURN
+
.------------------------------------------------------------
.        Default Address from Extra Contract file
.------------------------------------------------------------
DADR0000  OPEN      PMSCEXA1,"pmscexaf"
          PACK      KEY14,URNUMBER,SP70
          CALL      RSPMCEX1
DADR1000  CALL      RKPMCEX1
          BRANCH    OVRCD,DADR9000
          MATCH     URNUMBER,PMCEURNO         * Same U/R?
          GOTO      DADR9000 IF NOT EQUAL
.
          MATCH     SP70,PMCETYPE
          GOTO      DADR1000 IF EQUAL
          MOVE      "tc",KEY2
          PACK      KEY5,KEY2,PMCETYPE
          CALL      RDCODE1
          BRANCH    OVRCD,DADR1000
          MATCH     KEY1,TCINDC1
          GOTO      DADR1000 IF NOT EQUAL
          MOVE      ZERO,EXIT
          GOTO      DADR99999
.
DADR9000  MOVE      ONE,EXIT
DADR9999  RETURN
+
.-------------------------------------------------------------
. LSREF000 - Search for current open Inpatient MH Referral and
.            current open Legal Status
.-------------------------------------------------------------
LSREF000  OPEN      MEHHLSA2,"mehhlsaf"
.
          PACK      KEY32,URNUMBER,Z70
          CALL      RSMHHLS2
LSREF100  CALL      RPMHHLS2
          BRANCH    OVRCD,LSREF999
.
          MATCH     URNUMBER,MHHLURNO
          GOTO      LSREF999 IF NOT EQUAL
.
          MATCH     SP70,MHHLOREF
          GOTO      LSREF100 IF EQUAL
.
          PACK      KEY5,CATtm,MHHLOREF,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,LSREF100
.
          MATCH     ANSI,TCINDC1
          GOTO      LSREF100 IF NOT EQUAL
.
          MATCH     "1",MHHLSTAT
          GOTO      LSREF100 IF EQUAL
.
          MATCH     SP70,MHHLEDAT
          GOTO      LSREF100 IF NOT EQUAL
.
          PACK      KEY32,MHHLURNO,MHHLUNIQ,Z70
          CALL      RSMHDLS1
LSREF200  CALL      RPMHDLS1
          BRANCH    OVRCD,LSREF999
.
          MATCH     MHHLURNO,MHDLURNO
          GOTO      LSREF999 IF NOT EQUAL
.
          MATCH     MHHLUNIQ,MHDLUNIQ
          GOTO      LSREF999 IF NOT EQUAL
.
          MATCH     SP70,MHDLEDAT
          GOTO      LSREF200 IF NOT EQUAL
.
          WRITE     HTMLFILE;MHDLURNO,MHDLUNIQ,MHDLSDAT,MHDLSTIM;
          GOTO      LSREF999
.
LSREF999  RETURN
+
.*****************************************************************************
.*  WRWATR00
.*  Procedure to write to the WA triggers table if required
.*****************************************************************************
          DEFPROC   WRWATR00
.
          INC       PMSWTRFD/INC
          INC       PATMI1FD/INC
.
          COMPARE   SIX,PTCNHDPS           * If not WA - exit
          GOTO      WRWATR99 IF NOT EQUAL
.
          OPEN      PMSWTRA1,"pmswtraf"
          OPEN      PATMI1A1,"patmi1af"
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,WRWATR99
.
          COMPARE   THREE,ASTAT
          GOTO      WRWATR99 IF NOT EQUAL
.
WRWATR10  PACK      KEY19,WBSEHOSP,AADMNO,SP70
          CALL      RDPMWTR1
          IF        OVRCD<>1
            GOTO      WRWATR99    * record is already on file to be resent
          ENDIF
.
          CALL      IBACLOCK                * Get the current date
          PACK      PMWTCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMWTCDAT
          MOVE      CTIMEIS,PMWTCTIM
.
          PACK      PMWTHOSP,WBSEHOSP,SP70
          PACK      PMWTVISN,AADMNO,SP70
          PACK      PMWTSDAT,SP70
          PACK      PMWTMDAT,SP70
          PACK      PMWTWEBC,WBSEUID,SP70
.
          PACK      KEY19,PMWTHOSP,PMWTVISN,PMWTSDAT,SP70
          CALL      RAPMWTR1
          IF        OVRCD=1
            CALL      WRPMWTR1
          ENDIF
          GOTO      WRWATR99
.
          INC       PATMI1IO/INC
          INC       PMSWTRIO/INC
          INC       IBAOVRIO/INC
.
WRWATR99  CLOSE     PMSWTRA1
.
          ENDPROC
+
.*****************************************************************************
.*  CANMH000
.*  Procedure to cancel mental health transfer records
.*****************************************************************************
.CANMH000  MATCH     "1",DELETEMH
.          GOTO      CANMH999 IF NOT EQUAL
..
.          MATCH     SP70,SAVTDEPT
.          GOTO      CANMH999 IF EQUAL
..
.          PACK      KEY5,ANSA,ANSC,SAVTDEPT,SP70
.          CALL      RDCODE1
.          BRANCH    OVRCD,CANMH999
..
.          MATCH     "P",TCINDC5
.          GOTO      CANMH999 IF NOT EQUAL
..
.          PACK      KEY30,AADMNO,SP70
.          CALL      RDSTRAN2
.          CALL      RDKTRAN2
.          BRANCH    OVRCD,CANMH005
..
.          MATCH     "A",TMOVE
.          GOTO      CANMH005 IF NOT EQUAL
..
.          MATCH     SP70,TDEPT
.          GOTO      CANMH005 IF EQUAL
..
.          PACK      KEY5,ANSA,ANSC,TDEPT,SP70
.          CALL      RDCODE1
.          BRANCH    OVRCD,CANMH005
..
.          MATCH     "P",TCINDC5
.          GOTO      CANMH007 IF EQUAL
..
.CANMH005  REP       " +",URNUMBER
.          REP       " +",ADMISSNO
.          CLEAR     REDIRECT
.          APPEND    "patweb89.pbl?reportno=07&template=003&urnumber=",REDIRECT
.          APPEND    URNUMBER,REDIRECT
.          APPEND    "&admissno=",REDIRECT
.          APPEND    ADMISSNO,REDIRECT
.          RESET     REDIRECT
.          REP       "+ ",URNUMBER
.          REP       "+ ",ADMISSNO
..
.CANMH007  PACK      KEY30,AADMNO,SP70
.          CALL      RDSTRAN2
.CANMH010  CALL      RDKTRAN2
.          BRANCH    OVRCD,CANMH999
..
.          MATCH     AADMNO,TADMN
.          GOTO      CANMH999 IF NOT EQUAL
..
.          MATCH     "A",TMOVE
.          GOTO      CANMH010 IF EQUAL
..
.          MATCH     "D",TMOVE
.          GOTO      CANMH010 IF EQUAL
..
.          PACK      KEY5,ANSA,ANSC,TDEPT,SP70
.          CALL      RDCODE1
.          BRANCH    OVRCD,CANMH010
..
.          MATCH     "P",TCINDC5
.          GOTO      CANMH010 IF NOT EQUAL
..
.          MOVE      TDATE,TRANDATE
.          MOVE      TTIME,TRANTIME
.          MOVE      TWARD,TRANWARD
.          MOVE      TBED,TRANBEDS
.          MOVE      TMOVE,TRANMOVE
..
.          PACK      SAVKMH30,DTADMN,TDATE,TTIME,TWARD,TBED,SP70
..
..         ***** ADDED CODE FROM CANCL060 *****
..
.          CALL      EPTST000              * Check for existing Episode Coding
.          BRANCH    EXIT,CANMH900
.          CALL      CHMTR000              * Cancel transfer/movement
.          BRANCH    EXIT,CANMH900
.          MATCH     SP70,HDPEQUIV
.          IF        !@EQUAL
.            CALL      WPEI0000              * write to patpeiaf
.          ENDIF
..
.          MOVE      ADMISSNO,AADMNO       * Set for following routine
.          PROC      CALCCODE              * Recalculate hrs of ICU/NCU/CCU
..
.          MATCH     "1",PTCNBMAN
.          IF        @EQUAL
.            PACK      KEY30,AADMNO,SP70
.            CALL      RDSTRAN2
.            CALL      RDKTRAN2
.            BRANCH    OVRCD,CANMH900
..
.            MATCH     DAADMNO,DTADMN
.            GOTO      CANMH900 IF NOT EQUAL
..
.            MATCH     "A",TMOVE
.            GOTO      CANMH900 IF NOT EQUAL
..
.            MOVE      TDATE,TRANDATE
.            MOVE      TTIME,TRANTIME
.            MOVE      TWARD,TRNTOWRD
.            MOVE      TBED,TRNTOBED
.            MOVE      ASTAY,STAYDAYS
.            IF        ASTAT=2
.              PACK      KEY8,AADMNO,SP70
.              CALL      RDPMWOR1
.              IF        OVRCD=1
.                CALL      CLPMWO00               * Use the expected discharge
.              ENDIF                              * date if a current admission
..                                                * instead of TRANDATE plus
.              MATCH     SP70,PMWOEDAT            * ASTAY
.              IF        !@EQUAL
.                DAYSEP    TRANDATE,PMWOEDAT,STAYDAYS
.              ENDIF
.            ENDIF
..            CALL      UPPBMN00
.          ENDIF
..
.          PROC      BBUP0000                * Bed Board
..
..         ***********************************
..
.CANMH900  PACK      KEY30,SAVKMH30,SP70
.          CALL      RDTRAN2
..
.          GOTO      CANMH010
..
.CANMH999  RETURN
.+
.*****************************************************************************
.*  CANMH000
.*  Procedure to cancel mental health transfer records
.*****************************************************************************
CANMH000  MATCH     "1",DELETEMH
          GOTO      CANMH999 IF NOT EQUAL
.
          MATCH     SP70,SAVTDEPT
          GOTO      CANMH999 IF EQUAL
.
          PACK      KEY5,ANSA,ANSC,SAVTDEPT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CANMH999
.
          MATCH     "P",TCINDC5
          GOTO      CANMH999 IF NOT EQUAL
.
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
          CLEAR     REDIRECT
          APPEND    "patweb89.pbl?reportno=07&template=003&urnumber=",REDIRECT
          APPEND    URNUMBER,REDIRECT
          APPEND    "&admissno=",REDIRECT
          APPEND    ADMISSNO,REDIRECT
          RESET     REDIRECT
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
          PACK      KEY30,AADMNO,SP70
          CALL      RDSTRAN2
CANMH010  CALL      RDKTRAN2
          BRANCH    OVRCD,CANMH999
.
          MATCH     AADMNO,TADMN
          GOTO      CANMH999 IF NOT EQUAL
.
          PACK      KEY5,ANSA,ANSC,TDEPT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CANMH010
.
          MATCH     "P",TCINDC5
          GOTO      CANMH010 IF NOT EQUAL
.
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
          CLEAR     REDIRECT
          APPEND    "patweb98.pbl?reportno=01&template=042&urnumber=",REDIRECT
          APPEND    URNUMBER,REDIRECT
          APPEND    "&admissno=",REDIRECT
          APPEND    ADMISSNO,REDIRECT
          RESET     REDIRECT
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
CANMH999  RETURN
+
.*****************************************************************************
.*  GSVDEP00
.*  Procedure to get SAVTDEPT
.*****************************************************************************
GSVDEP00  MOVE      SP70,SAVTDEPT
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,GSVDEP99
.
          PACK      KEY30,AADMNO,TRANDATE,TRANTIME,TRANWARD,TRANBEDS,SP70
          CALL      RDTRAN2
          BRANCH    OVRCD,GSVDEP99
.
          MOVE      TDEPT,SAVTDEPT
.
GSVDEP99  RETURN
+
.------------------------------------------------------------
. Write WL Field Change Audit for unadmit (cancel admission)
.------------------------------------------------------------
WRCHU000  PACK      WTCHURNO,WMURNO,SP70
          PACK      WTCHPROC,WMCODE,SP70
          PACK      WTCHPCNT,WMCNT,SP70
.
          CALL      IBACLOCK
          PACK      WTCHDATE,CCC,CYY,CMM,CDD
          REPLACE   " 0",WTCHDATE
          CLOCK     TIME,WTCHTIME
.
          PACK      WTCHUPTY,TEN2,SP70
          PACK      WTCHREAS,TRNUREAS,SP70
          MOVE      USERID,WTCHUSID
          PACK      WTCHOVAL,ADATE,ATIME,SP70
          PACK      WTCHCVAL,SP70
.
          PACK      KEY35,WTCHURNO,WTCHPROC,WTCHPCNT,WTCHDATE,WTCHTIME,SP70
          CALL      RDWTCHA1
          IF        OVRCD=1
            CALL      WRWTCHA1
          ENDIF
.
WRCHU999  RETURN
+
.
.*******************************************************************************
. Check if FIM Details exist and/or Program is complete   
.*******************************************************************************
CHKPGM00  READ      CONTROLF,HUND18;*242,PTCNWFIM
          MATCH     "1",PTCNWFIM
          GOTO      CHKPGM99 IF NOT EQUAL
.
          CALL      CHFM0000
.
          IF        ASTAT<>1 & ASTAT<>5
            PROC      WARPRG00
          ENDIF
.
          COMPARE   ZERO,WARCOUNT
          GOTO      CHKPGM99 IF EQUAL
.
          MOVE      ONE,COUNTER
          WRITE     HTMLFILE;"<script type=#"text/javascript#">"
CHKPGM10  WRITE     HTMLFILE;"    alert(#"",WEBWARNG[COUNTER],"#");",012
          ADD       ONE,COUNTER
          COMPARE   COUNTER,WARCOUNT
          GOTO      CHKPGM98 IF LESS
          GOTO      CHKPGM10
.
CHKPGM98  WRITE     HTMLFILE;"</script>"
.
CHKPGM99  RETURN
.
.*******************************************************************************
. If Rehab Patient then check if FIM Details exist    
.*******************************************************************************
CHFM0000  READ      CONTROLF,SEVENTY9;*80,PTCNQLDB
          READ      CONTROLF,EIGHTY;*250,PTCNHDPS
          IF        (PTCNHDPS=4 & PTCNQLDB=6)
            MOVE      CODEA,CARECATG
          ELSE
            MOVE      CODECC,CARECATG
          ENDIF
.
          MATCH     "A ",CARECATG              * Read relevant category type
          IF        @EQUAL
            PACK      KEY5,CARECATG,ATYPE,SP70
          ELSE
            PACK      KEY5,CARECATG,ACARE,SP70
          ENDIF
.
          CALL      RDCODE1
          BRANCH    OVRCD,CHFM9999             * Exit if Catagory not found
.
          MATCH     "A ",CARECATG              * Check if Rehabilitation Visit
          IF        @EQUAL
            MATCH   "9",TCINDC8
            GOTO    CHFM9999 IF NOT EQUAL
          ELSE
            MATCH   "2",TCINDC6
            GOTO    CHFM9999 IF NOT EQUAL
          ENDIF
.                                              * Check for Admission FIM Details
          PACK      KEY24,ADMISSNO,SP70
          CALL      RDPTFIM1
CHFM1000  CALL      RKPTFIM1
          BRANCH    OVRCD,CHFM9997
.
          MATCH     PTFIVISN,ADMISSNO
          GOTO      CHFM9997 IF NOT EQUAL
.
          MATCH     ONEINIT,PTFIDELT
          GOTO      CHFM1000 IF EQUAL
.
          MATCH     "A",PTFITYPE
          GOTO       CHFM9999 IF EQUAL
.                                              * warn no FIM For Rehab Patient
CHFM9997  CLEAR     WEBTITLE
          MOVE      "Warning: No FIM Details Exist",WEBTITLE
          RESET     WEBTITLE
          ADD       ONE,WARCOUNT
          MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
.
CHFM9998  MOVE      ONE,EXIT
.
CHFM9999  RETURN
.
.*******************************************************************************
. Delete Existing FIM details   
.*******************************************************************************
RMFIM000  PACK      KEY24,ADMISSNO,SP70
          CALL      RSPTFIM1
RMFIM100  CALL      RKPTFIM1
          IF        OVRCD = 1
            GOTO      RMFIM999
          ENDIF
.
          MATCH     ADMISSNO,PTFIVISN
          GOTO      RMFIM999 IF NOT EQUAL
.
          MATCH     "1",PTFIDELT
          GOTO      RMFIM100 IF EQUAL
.
          MOVE      "1",PTFIDELT                 * Set Deleted Flag
.
          CALL      UPPTFIM1                     * Update FIM Details
.
          GOTO      RMFIM100
.
RMFIM999  RETURN
.
.*******************************************************************************
. Delete Discharge FIM details            
.*******************************************************************************
RMDSC000  PACK      KEY24,ADMISSNO,Z70
          CALL      RSPTFIM1
RMDSC100  CALL      RPPTFIM1
          IF        OVRCD = 1
            GOTO      RMDSC999
          ENDIF
.
          MATCH     ADMISSNO,PTFIVISN
          GOTO      RMDSC999 IF NOT EQUAL
.
          MATCH     "D",PTFITYPE
          GOTO      RMDSC999 IF NOT EQUAL
.
          MATCH     "1",PTFIDELT
          GOTO      RMDSC100 IF EQUAL
.
          MOVE      "1",PTFIDELT                 * Set Deleted Flag
.
          CALL      UPPTFIM1                     * Update FIM Details
.
RMDSC999  RETURN
+
.*******************************************************************************
. SHSY0000 Determine if there is previous short stay transfer
.*******************************************************************************
SHSY0000  MOVE      ZERO,SHSYFLAG
.
          PACK      SAVKEY30,DTADMN,TDATE,TTIME,TWARD,TBED,SP70
.
          PACK      KEY30,AADMNO,SP70
          CALL      RDSTRAN2
SHSY1000  CALL      RDKTRAN2
          BRANCH    OVRCD,SHSY9000
.
          MATCH     AADMNO,TADMN
          GOTO      SHSY9000 IF NOT EQUAL
.
          MATCH     "L",TMOVE
          GOTO      SHSY1000 IF EQUAL
.
          MATCH     "D",TMOVE
          GOTO      SHSY1000 IF EQUAL
.
          PACK      KEY6,TWARD,TBED
          CALL      RDWARD1
          BRANCH    OVRCD,SHSY1000
.
          PACK      KEY5,ANSB,ANST,WEFRBT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,SHSY1000
.
          MATCH     ANSM,TCINDC11
          GOTO      SHSY1000 IF EQUAL
.
          MATCH     ANSE,TCINDC11
          GOTO      SHSY1000 IF NOT EQUAL
.
          MATCH     ANSS,THCSCOD
          GOTO      SHSY1000 IF NOT EQUAL
.
          MOVE      TDATE,EMVIDDAT
          MOVE      TTIME,EMVIDTIM
.
          MOVE      ONE,SHSYFLAG
          GOTO      SHSY9000
.
SHSY9000  PACK      KEY30,SAVKEY30,SP70
          CALL      RDTRAN2
.
SHSY9999  RETURN
.
.------------------------------------------------------------
. ENDBRD00 - Update Boarder End Date and Time on unadmit
.------------------------------------------------------------
ENDBRD00  PACK     KEY26,DAADMNO,SP70
          CALL     RSPTBRD3
ENDBRD10  CALL     RKPTBRD3
          BRANCH   OVRCD,ENDBRD99
.
          MATCH    DAADMNO,PTBRVISN
          GOTO     ENDBRD99 IF NOT EQUAL
.
          CALL      IBACLOCK
          PACK      PTBREDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTBREDAT
          MOVE      CTIMEIS,PTBRETIM
          REP       " 0",PTBRETIM
.
          CALL     UPPTBRD3
.
          GOTO     ENDBRD10
.
ENDBRD99  RETURN
+
.------------------------------------------------------------
. CHGNZ000 - Change NZ NMDS if fields have changed, and require resubmission
.------------------------------------------------------------
CHGNZ000  COMPARE   ONE,PTCNHDPS
          GOTO      CHGNZ999 IF NOT EQUAL   * NZ
.
          MOVE      ADMISSNO,KEY8           * Read in current admission
          CALL      RDMISS1
          BRANCH    OVRCD,CHGNZ999
.
          COMPARE   ONE,AELIG               * has this record been submitted?
          GOTO      CHGNZ999 IF NOT EQUAL
.
          MOVE      "4",AELIG               * update resubmit flag
          CALL      UPMISS1
.
          OPEN      PMSWTRA1,"pmswtraf"
.
          PACK      KEY19,PMVXMHOS,AADMNO,SP70
          CALL      RDPMWTR1
          IF        OVRCD<>1
            GOTO      CHGNZ999    * record is already on file to be resent
          ENDIF
.
          CALL      IBACLOCK                * Get the current date
          PACK      PMWTCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMWTCDAT
          MOVE      CTIMEIS,PMWTCTIM
.
          PACK      PMWTHOSP,PMVXMHOS,SP70
          PACK      PMWTVISN,AADMNO,SP70
          PACK      PMWTSDAT,SP70
          PACK      PMWTMDAT,SP70
          PACK      PMWTWEBC,WBSEUID,SP70
.
          PACK      KEY19,PMWTHOSP,PMWTVISN,PMWTSDAT,SP70
          CALL      RAPMWTR1
          IF        OVRCD=1
            CALL      WRPMWTR1
          ENDIF
.
CHGNZ999  CLOSE      PMSWTRA1
          RETURN
+
.------------------------------------------------------------
. GETHRD00 - Get Housekeeping record
.------------------------------------------------------------
GETHRD00  CALL       CLPMSHRD
          MOVE       ZERO,EXIT
.
          PACK       KEY30,ADMISSNO,Z70
          CALL       RDSTRAN2
GETHRD10  CALL       RDPTRAN2
          BRANCH     OVRCD,GETHRD90
.
          MATCH      ADMISSNO,DTADMN
          GOTO       GETHRD90 IF NOT EQUAL
.
          MATCH      "D",TMOVE
          GOTO       GETHRD10 IF NOT EQUAL
.
          PACK       KEY8,ADMISSNO
          CALL       RDPMVX11
          BRANCH     OVRCD,GETHRD90
.
          PACK       KEY25,PMVXMHOS,TWARD,TBED,DDATE,DTIME,SP70
          CALL       RDPMHRD1
          BRANCH     OVRCD,GETHRD90
.
          GOTO       GETHRD99
.
GETHRD90  MOVE       ONE,EXIT
          GOTO       GETHRD99
.
GETHRD99  RETURN
+
.------------------------------------------------------------
. Process Update Transfer Records
.------------------------------------------------------------
UPDTRN00  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      UPDTRN80 IF EQUAL
.
          MATCH     "U",UPDTTYPE
          GOTO      UPDTRN50 IF EQUAL
.
          GOTO      UPDTRN90
.
.         ************ UPDATE FORMACTION **********
.
UPDTRN50  PACK      KEY30,TRANFKEY,SP70
          CALL      RDTRAN1
          BRANCH    OVRCD,UPDTRN91
.
          MOVE      TRNLVTYP,PTTRLTYP
.
          MATCH     SP70,PTTRLTYP
          IF        !@EQUAL
            MOVE      "TL",CATEGORY
            MOVE      PTTRLTYP,CODE
            CALL      GETCOD00
.
            MATCH     ANSC,THCSCOD
            IF        @EQUAL
              MOVE      TRANSRCE,PTTRLTSC
            ENDIF
          ENDIF
.
          CALL      UPTRAN1 
.
          MATCH     SP70,PTTRLTYP
          IF        !@EQUAL
            MOVE      "TL",CATEGORY
            MOVE      PTTRLTYP,CODE
            CALL      GETCOD00
.
            MATCH     ANSC,THCSCOD
            IF        @EQUAL
.
              PACK      KEY25,TADMN,ANSL,TDATE,TTIME,SP70
              CALL      RDPTASF1
              IF        OVRCD=0
                MATCH     PTASF001,Z70
                IF        !@EQUAL
                  MOVE      PTASF001,PTAFCTYP
                ENDIF
.
                MATCH     PTASF002,Z70
                IF        !@EQUAL
                  MOVE      PTASF002,PTAFCROL
                ENDIF
.
                MATCH     PTASF003,Z70
                IF        !@EQUAL
                  MOVE      PTASF003,PTAFCSID
                ENDIF
.
                CALL      UPPTASF1  
              ELSE
                CALL      CPTASF00
.
                MOVE      TADMN,PTAFADMN
                MOVE      ANSL,PTAFTYPE
                MOVE      TDATE,PTAFDATE
                MOVE      TTIME,PTAFTIME
                MOVE      ONE,PTAFCODE
.
                MATCH     PTASF001,Z70
                IF        !@EQUAL
                  MOVE      PTASF001,PTAFCTYP
                ENDIF
.
                MATCH     PTASF002,Z70
                IF        !@EQUAL
                  MOVE      PTASF002,PTAFCROL
                ENDIF
.
                MATCH     PTASF003,Z70
                IF        !@EQUAL
                  MOVE      PTASF003,PTAFCSID
                ENDIF
.
                MOVE      SP70,PTAFSPAR
.
                CALL      WRPTASF1
              ENDIF 
.
            ENDIF
          ENDIF 
.
          MOVE      ZERO,EXIT
          GOTO      UPDTRN99
.
.         ************ DISPLAY FORMACTION **********
.
UPDTRN80  PACK      KEY30,TRANFKEY,SP70
          CALL      RDTRAN1
          IF        OVRCD=1
            CALL      CLPATTRN            
            CALL      CPTASF00
          ELSE
            PACK      KEY25,TADMN,ANSL,TDATE,TTIME,SP70
            CALL      RDPTASF1
            IF        OVRCD=1
              CALL      CPTASF00
            ENDIF
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Update Transfer Records",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,UPDTRN99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      UPDTRN99
.
UPDTRN90  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDTRN99
.
UPDTRN91  MOVE      "Transfer/Leave Record does not exist.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDTRN99
.
UPDTRN99  RETURN
.------------------------------------------------------------
. Clear patasf variables
.------------------------------------------------------------
CPTASF00  MOVE      ZEROVISN,PTAFADMN
          MOVE      SP70,PTAFTYPE
          MOVE      SP70,PTAFDATE
          MOVE      SP70,PTAFTIME
          MOVE      SP70,PTAFCODE
          MOVE      SP70,PTAFCTYP
          MOVE      SP70,PTAFCROL
          MOVE      SP70,PTAFCSID
          MOVE      SP70,PTAFSPAR
.
CPTASF99  RETURN
.------------------------------------------------------------
. UPNBR000 - Update wathisaf NBRS record to unsent for NZ
.------------------------------------------------------------
UPNBR000  COMPARE   ONE,PTCNHDPS
          GOTO      UPNBR999 IF NOT EQUAL
.
          MATCH     "Update",FORMACTN
          GOTO      UPNBR999 IF NOT EQUAL
.
          MATCH     DSCHSTAT,DSCHSTDF
          GOTO      UPNBR999 IF EQUAL
.
          MATCH     ADMISSNO,WMBOOK
          GOTO      UPNBR999 IF NOT EQUAL
.
          CALL      DELNBR00           * Write delete NBRS record
.
          CALL      SAVHIS00
.
          MOVE      DSCHSTDF,SAVEBSCD
          MOVE      "20",WTWMBSCD
          MOVE      ONE,NBRFLAG        * write new exit NBRS record
          CALL      WRTHIS00
.
UPNBR999  RETURN
+
.------------------------------------------------------------
.   QLD MH Details
.------------------------------------------------------------
PTQMH000  COMPARE   FOUR,PTCNHDPS           * QLD
          GOTO      PTQMH999 IF NOT EQUAL
.
          PACK      KEY6,ADOCTA,SP6
          CALL      RDDOCT1                 * Read the doctors file
          BRANCH    OVRCD,PTQMH999
.
          MATCH     SP3,DRTYPE
          GOTO      PTQMH999 IF EQUAL
.
          PACK      KEY5,ANSD,ANST,DRTYPE,SP70
          CALL      RDCODE1             * Read the codes file
          BRANCH    OVRCD,PTQMH999
.
          MATCH     PYAA,THCSCOD
          GOTO      PTQMH500 IF LESS        * < PYAA
.
          MATCH     THCSCOD,PYZZ
          GOTO      PTQMH500 IF LESS        * PYZZ <
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPTQMH1          * Read the QLD rehab details file
          IF        OVRCD=1
            CALL      MVPTQM00        * Update the qld MH details fil
            CALL      WRPTQMH1
          ELSE
            CALL      MVPTQM00        * Update the qld MH details fil
            CALL      UPPTQMH1
          ENDIF
.
          GOTO      PTQMH999
.
PTQMH500  PACK      KEY8,ADMISSNO,SP70
          CALL      DEPTQMH1
.
PTQMH999  RETURN
.
.-----------------------------------------------------------
. Write EDWARD IP visit alteration record
.------------------------------------------------------------
WEDI0000  MATCH     SP70,PTCNNSSI        * no edward source system
          GOTO      WEDI9999 IF EQUAL
.
          MATCH     "00000000000000000000",PTCNNSSI  * no edward source system
          GOTO      WEDI9999 IF EQUAL
.
          OPEN      PMSADWA1,"pmsadwaf"
          MOVE      ADMISSNO,PMAWVISN
          MOVE      TEN1,PMAWTYPE
          PACK      PMAWOLDV,SP70,SP70,SP70,SP70
          PACK      PMAWNEWV,SP70,SP70,SP70,SP70
.
          CALL      IBACLOCK
          PACK      PMAWCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMAWCDAT
          MOVE      "00:00:00",PMAWCTIM
          PACK      PMAWCUID,USERID
          PACK      PMAWSPAR,SP70,SP70
.
          PACK      KEY27,PMAWCDAT,PMAWCTIM,PMAWVISN,PMAWTYPE,SP70
          CALL      RAPMADW1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            CALL      WRPMADW1
            TRAPCLR   IO
          ELSE
            CALL      UPPMADW1
          ENDIF
.
WEDI9999  RETURN
+
.-----------------------------------------------------------
. Write EDWARD IP visit alteration record
. requires : ALTTYPE
.            ADMISSNO
.            ALTOLDVL
.            ALTNEWVL
.------------------------------------------------------------
WEAL0000  MATCH     SP70,PTCNNSSI        * no edward source system
          GOTO      WEAL9999 IF EQUAL
.
          MATCH     "00000000000000000000",PTCNNSSI  * no edward source system
          GOTO      WEAL9999 IF EQUAL
.
          OPEN      PMSADWA1,"pmsadwaf"
.
          MOVE      ADMISSNO,PMAWVISN
          MOVE      ALTTYPE,PMAWTYPE
          PACK      PMAWOLDV,ALTOLDVL,SP70,SP70,SP70,SP70
          PACK      PMAWNEWV,ALTNEWVL,SP70,SP70,SP70,SP70
.
          CALL      IBACLOCK
          PACK      PMAWCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMAWCDAT
          MOVE      "00:00:00",PMAWCTIM
          PACK      PMAWCUID,USERID
          PACK      PMAWSPAR,SP70,SP70
.
          PACK      KEY27,PMAWCDAT,PMAWCTIM,PMAWVISN,PMAWTYPE,SP70
          CALL      RAPMADW1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            CALL      WRPMADW1
            TRAPCLR   IO
          ELSE
            CALL      UPPMADW1
          ENDIF
.
WEAL9999  CLOSE     PMSADWA1
          RETURN
+
.******************************************************************************
.*                                EDWH0000                                    *
.******************************************************************************
EDWH0000  READ      CONTROLF,HUND25;*93,PTCNNSSI
          MATCH     SP70,PTCNNSSI           * no edward source system
          GOTO      EDWH9999 IF EQUAL
.
          MATCH     "00000000000000000000",PTCNNSSI  * no edward source system
          GOTO      EDWH9999 IF EQUAL
.
          PACK      TRANFUND,TRANFUND,SP70  * Pad with spaces if EOS
          PACK      PFUNDH,PFUNDH,SP70      * Pad with spaces if EOS
.
          MATCH     PFUNDH,TRANFUND         * Different Health Fund
          GOTO      EDWH9999 IF EQUAL
.
          MATCH     SP70,PFUNDH
          IF        @EQUAL
            MOVE      "25",PMEWTYPE       * Health Fund Added
          ELSE
            MOVE      "26",PMEWTYPE       * Health Fund Changed
          ENDIF
.
          PACK      PMEWOLDV,PFUNDH,SP70
          PACK      PMEWNEWV,TRANFUND,SP70
          CALL      WREDW000
.
EDWH9999  RETURN
+
.******************************************************************************
.*                                 WREDW000                                   *
.* If any of the EDWWARD variables have changed, write/update pmsedwaf        *
.******************************************************************************
.
WREDW000  MOVE      PURNO,PMEWURNO
          CALL      IBACLOCK
          PACK      PMEWCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMEWCDAT
          CLOCK     TIME,PMEWCTIM
          PACK      PMEWCUID,USERID
          PACK      PMEWTYPE,PMEWTYPE,SP70
          PACK      PMEWSPAR,SP70,SP70
.
          PACK      KEY27,PMEWURNO,PMEWTYPE,PMEWCDAT,PMEWCTIM,SP70
          CALL      RAPMEDW2
          IF        OVRCD=1
            CALL      WRPMEDW2
          ELSE
            CALL      UPPMEDW2
          ENDIF
.
WREDW999  RETURN
+
.******************************************************************************
.*                                EDWD0000                                    *
.*  EDWARD deceased trigger if discharged as deceased                         *
.******************************************************************************
EDWD0000  READ      CONTROLF,HUND25;*93,PTCNNSSI
          MATCH     SP70,PTCNNSSI           * no edward source system
          GOTO      EDWD9999 IF EQUAL
.
          MATCH     "00000000000000000000",PTCNNSSI  * no edward source system
          GOTO      EDWD9999 IF EQUAL
.
          MOVE      "4  ",PMEWTYPE                   * Deceased
.
          PACK      PMEWOLDV,EDWPCEAS,SP70
          PACK      PMEWNEWV,PCEASE,SP70
          CALL      WREDW000
.
EDWD9999  RETURN
+
.******************************************************************************
.*                                 DDPS0000                                   *
.*                 Default Discharge Payment Status Cat KK                    *
.******************************************************************************
DDPS0000  MOVE      "CC",CATEGORY
          MOVE      ACARE,CODE
          CALL      GETCOD00
.
          COMPARE   TEN1,TCFORM6
          GOTO      DDPS0500 IF NOT EQUAL
.
          MATCH     "N",TCINDC22                   * Qualified Newborn
          GOTO      DDPS0500 IF EQUAL
.
          MATCH     "M",TCINDC22                   * Unqualified Newborn
          GOTO      DDPS0400 IF EQUAL 
.
          GOTO      DDPS0500
.
DDPS0400  PACK      KEY24,AADMNO,SP70
          CALL      RDSCHCO1
DDPS0410  CALL      RDKCHCO1
          BRANCH    OVRCD,DDPS0450
.
          MATCH     AADMNO,CHADMN
          GOTO      DDPS0450 IF NOT EQUAL
.
          MATCH     "CC",CHCATG
          GOTO      DDPS0410 IF NOT EQUAL
.
          MOVE      CHCATG,CATEGORY
          MOVE      CHCODE,CODE
          CALL      GETCOD00           
.
          COMPARE   TEN1,TCFORM6
          GOTO      DDPS0410 IF NOT EQUAL
.
          MATCH     "N",TCINDC22
          GOTO      DDPS0410 IF NOT EQUAL
.
          GOTO      DDPS0500
.
DDPS0450  MOVE      "CL",CATEGORY
          MOVE      ACLAIM,CODE
          CALL      GETCOD00
.
          MATCH     "H",TCINDC1
          IF        @EQUAL
            WRITE     HTMLFILE;TWO,FOUR,SIX;
          ELSE
            WRITE     HTMLFILE;TWO,FOUR,FIVE;
          ENDIF 
.
          GOTO      DDPS9999
.
DDPS0500  MOVE      "CL",CATEGORY
          MOVE      ACLAIM,CODE
          CALL      GETCOD00       
.
          WRITE     HTMLFILE;ONE,TCINDC23;          
.
          GOTO      DDPS9999
.
DDPS9999  RETURN
+
.*******************************************************************************
. Check if any visits are available to be used for a statistical admission
.*******************************************************************************
RSTATV00  MATCH     SP70,URNUMBER                * Any U/R number
          GOTO      RSTATV90 IF EQUAL
.
          MATCH     SP70,ADMISSNO                * Any admission number
          GOTO      RSTATV90 IF EQUAL
.
          COMPARE   TEN5,REMOTENO                * Only check for discharges and
          GOTO      RSTATV30 IF EQUAL            * current admissions
.
          PACK      KEY16,URNUMBER,SP70
          CALL      RSBKREC6
RSTATV10  CALL      RKBKREC6                     * Check for a booking
          BRANCH    OVRCD,RSTATV20
.
          MATCH     URNUMBER,BKREURNO            * Correct U/R
          GOTO      RSTATV20 IF NOT EQUAL
.
          COMPARE   ZERO,BKRESTAT                * Status booked
          GOTO      RSTATV91 IF EQUAL
.
          GOTO      RSTATV10
.
RSTATV20  PACK      KEY17,URNUMBER,ONE,SP70
          CALL      RSPTMI18
          CALL      RKPTMI18                     * Check for a pre admission
          BRANCH    OVRCD,RSTATV30
.
          MATCH     URNUMBER,AURNO               * Correct U/R
          GOTO      RSTATV30 IF NOT EQUAL
.
          COMPARE   ONE,ASTAT                    * Pre admission
          GOTO      RSTATV91 IF EQUAL
.
RSTATV30  COMPARE   TEN4,REMOTENO                * Only check for bookings and
          GOTO      RSTATV90 IF EQUAL            * pre admissions
.
          PACK      KEY17,URNUMBER,TWO,SP70
          CALL      RSPTMI18
RSTATV31  CALL      RKPTMI18                     * Check for current IP visit
          BRANCH    OVRCD,RSTATV40
.
          MATCH     URNUMBER,AURNO               * Correct U/R
          GOTO      RSTATV40 IF NOT EQUAL
.
          MATCH     ADMISSNO,DAADMNO             * Ignore current visit
          GOTO      RSTATV31 IF EQUAL
.
          COMPARE   TWO,ASTAT                    * Current admission
          GOTO      RSTATV91 IF EQUAL
.
RSTATV40  PACK      KEY17,URNUMBER,THREE,SP70
          CALL      RSPTMI18
RSTATV41  CALL      RKPTMI18                     * Check for Discharges
          BRANCH    OVRCD,RSTATV90
.
          MATCH     URNUMBER,AURNO               * Correct U/R
          GOTO      RSTATV90 IF NOT EQUAL
.
          COMPARE   THREE,ASTAT                  * Discharged
          GOTO      RSTATV90 IF NOT EQUAL
.
          MATCH     ADMISSNO,DAADMNO             * Ignore current visit
          GOTO      RSTATV41 IF EQUAL
.
          MATCH     SP70,VALDDATE
          IF        !@EQUAL
            MATCH     VALDDATE,ADATE             * Admitted on proposed
            GOTO      RSTATV91 IF EQUAL          * discharge date
          ELSE
            GOTO      RSTATV91                   * Any Admitted date 
          ENDIF
.
          GOTO      RSTATV41
.
RSTATV90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    ZERO:
                    "</RETURN_VALUE>"
          GOTO      RSTATV99
.
RSTATV91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    ONE:
                    "</RETURN_VALUE>"
          GOTO      RSTATV99
.
RSTATV99  RETURN
+
.*******************************************************************************
. Update visit links for a statistical discharge 
.*******************************************************************************
USTATD00  MATCH     SP70,STATVTYP            * Any update link to statistical
          GOTO      USTATD99 IF EQUAL        * discharge type
.
          MATCH     SP70,STATVISN            * Any update link to statistical
          GOTO      USTATD99 IF EQUAL        * discharge visit number
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDDSCH1                  * Read current discharge record
          BRANCH    OVRCD,USTATD99
.
          MATCH     SP70,PTDSLSDN            * Already linked
          GOTO      USTATD99 IF NOT EQUAL
.
          MOVE      STATVISN,PTDSLSDN        * update linked stst discharge No.
          CALL      UPDSCH1                  * Update current discharge record
.
          MOVE      PTMIOGNO,ORIGADMN        * save original admissno
.
          PACK      KEY8,PTDSLSDN,SP70       * Restre current admision record
          CALL      RDMISS1
          BRANCH    OVRCD,USTATD90
.
          MOVE      ORIGADMN,PTMIOGNO        * Original visit number
          MOVE      ADMISSNO,PTMILSDN        * update linked stat discharge No
          CALL      UPMISS1                  * Update linked admission
       
USTATD90  PACK      KEY8,ADMISSNO,SP70       * Restre current admision record
          CALL      RDMISS1
          BRANCH    OVRCD,USTATD99
.
USTATD99  RETURN
.
.*******************************************************************************
. Leave register detail                           
.*******************************************************************************
LVRG0000  BRANCH    NOLEAVRG,LVRG9999   * exit if table not created
.
          MATCH     "LRUpdate",FORMACTN
          IF        @EQUAL
            CALL      UPBEF000   * update current L record as Before record
            MATCH     "1",NOTIFYHS
            IF        @EQUAL
              CALL      HREQ0000          * Housekeeping request
            ENDIF
          ENDIF
.
          MOVE      ONE,F3
          PACK      KEY27,PMLRD001,PMLRD002,PMLRD003,Z70
          CALL      RSPMLRD1
LVRG1000  CALL      RPPMLRD1
          BRANCH    OVRCD,LVRG1500
.
          MATCH     PMLRD001,PMLRVISN
          GOTO      LVRG1500 IF NOT EQUAL
.
          MATCH     PMLRD002,PMLRDATE
          GOTO      LVRG1500 IF NOT EQUAL
.
          MATCH     PMLRD003,PMLRTIME
          GOTO      LVRG1500 IF NOT EQUAL
.
          MOVE      PMLRCOUN,F3
          ADD       ONE,F3
          PACK      PMLRCOUN,F3
.
LVRG1500  CALL      CLPMLD00
          PACK      PMLRCOUN,F3
          PACK      PMLRRECS,ANSL,SP70   * default to leave record
          CALL      MVPMLR00               
          MATCH     "Return",FORMACTN
          IF        @EQUAL
            PACK      PMLRRECS,ANSR,SP70   * return record           
          ENDIF
          PACK      PMLRCOUN,F3
.
          CALL      IBACLOCK
          PACK      PMLRCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMLRCDAT
          CLOCK     TIME,PMLRCTIM
          PACK      PMLRWEBC,USERID,SP70
.
          PACK      KEY27,PMLRVISN,PMLRDATE,PMLRTIME,PMLRCOUN,SP70
          CALL      RAPMLRD1
          IF        OVRCD=1
            CALL     WRPMLRD1
          ENDIF
.
          MATCH     Z70,PMLRD014
          IF        !@EQUAL
            PACK      KEY8,ADMISSNO,SP70
            CALL      RDPMWOR1
            IF        OVRCD=0
              PACK      PMWOUDF4,PMLRD014,SP70
              CALL      UPPMWOR1
            ENDIF
          ENDIF
.
          MATCH     SP70,STATNCOD
          IF        !@EQUAL
            MOVE      ONE,SCHDCOPY
            CALL      ADDPRN00              * print form
            MOVE      "PATWEB96",SETDFPRG
            MOVE      "03",KEY2
            CALL      UPDEFP00              * Update Default Printer
          ENDIF
.
          MOVE      ANSA,UPDTTYPE
          CALL      UPCOM000    * write notes away
.
LVRG9999  CLOSE     COMFILAF,DELETE
          RETURN
+
.*******************************************************************************
.                          Update this leave record as before
.*******************************************************************************
UPBEF000  PACK      KEY27,PMLRD001,PMLRD002,PMLRD003,Z70
          CALL      RSPMLRD1
          CALL      RPPMLRD1
          BRANCH    OVRCD,UPBEF999
.
          MATCH     PMLRD001,PMLRVISN
          GOTO      UPBEF999 IF NOT EQUAL
.
          MATCH     PMLRD002,PMLRDATE
          GOTO      UPBEF999 IF NOT EQUAL
.
          MATCH     PMLRD003,PMLRTIME
          GOTO      UPBEF999 IF NOT EQUAL
.
          MATCH     ANSL,PMLRRECS
          GOTO      UPBEF999 IF NOT EQUAL
.
          MOVE      ANSB,PMLRRECS
          CALL      UPPMLRD1
.
UPBEF9999 RETURN
+
.*******************************************************************************
.                          Get Text Comments
.*******************************************************************************
GETEXT00  PREP      COMFILAF,COMFILNM
          MOVE      ZERO,TRNWEND
          PACK      QRYDATA,QRYDATA,SP70
          MATCH     SP70,QRYDATA
          GOTO      GETEXT99 IF EQUAL
          MOVE      ONE,F3
          WRITE     COMFILAF,SEQ;QRYDATA
.
GETEXT10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETEXT90 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETEXT80 IF NOT EQUAL
          ADD       ONE,F3
          WRITE     COMFILAF,SEQ;QRYDATA
          GOTO      GETEXT10
.
GETEXT80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETEXT90  MOVE      F3,TRNWEND
          OPEN      COMFILAF,COMFILNM
GETEXT99  RETURN
.
.**********************************************************************
.         Mark leave register record as deleted
.**********************************************************************
DLLR0000  BRANCH    NOLEAVRG,DLLR9999   * exit if table not created
          CALL      DELMV000    * delete transfer information
          BRANCH    EXIT,DLLR9999 * Delete failed, stop
.
          PACK      KEY27,PMLRD001,PMLRD002,PMLRD003,Z70
          CALL      RSPMLRD1
          CALL      RPPMLRD1
          BRANCH    OVRCD,DLLR9999
.
          MATCH     PMLRD001,PMLRVISN
          GOTO      DLLR9999 IF NOT EQUAL
.
          MATCH     PMLRD002,PMLRDATE
          GOTO      DLLR9999 IF NOT EQUAL
.
          MATCH     PMLRD003,PMLRTIME
          GOTO      DLLR9999 IF NOT EQUAL
.
          MOVE      PMLRCOUN,F3
          ADD       ONE,F3
          PACK      PMLRCOUN,F3
.
          MOVE      ANSD,PMLRRECS
          PACK      PMLRWEBD,USERID,SP70
          CALL      IBACLOCK
          PACK      PMLRDATD,CCC,CYY,CMM,CDD
          REP       " 0",PMLRDATD
          CLOCK     TIME,PMLRTIMD
          CALL      IBACLOCK
          PACK      PMLRCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMLRCDAT
          CLOCK     TIME,PMLRCTIM
.
          PACK      KEY27,PMLRVISN,PMLRDATE,PMLRTIME,PMLRCOUN,SP70
          CALL      RAPMLRD1
          IF        OVRCD=1
            CALL      WRPMLRD1
          ELSE
            GOTO      DLLR9999
          ENDIF
.
.  inactive all matching records
.
          PACK      KEY27,PMLRD001,PMLRD002,PMLRD003,SP70
          CALL      RSPMLRD1
DLLR1000  CALL      RKPMLRD1
          BRANCH    OVRCD,DLLR9999
.
          MATCH     PMLRD001,PMLRVISN
          GOTO      DLLR9999 IF NOT EQUAL
.
          MATCH     PMLRD002,PMLRDATE
          GOTO      DLLR9999 IF NOT EQUAL
.
          MATCH     PMLRD003,PMLRTIME
          GOTO      DLLR9999 IF NOT EQUAL
.
          MOVE      "1",PMLRACTV
          CALL      UPPMLRD1
          GOTO      DLLR1000
.
DLLR9999  RETURN
+
.**********************************************************************
.    Mark leave register record as deleted - called from supervisor delete
.    on leave no leave register record in context
.**********************************************************************
DELLR000  BRANCH    NOLEAVRG,DELLR999   * exit if table not created
.
          PACK      KEY27,ADMISSNO,TRANDATE,TRANTIME,Z70
          CALL      RSPMLRD1
          CALL      RPPMLRD1
          BRANCH    OVRCD,DLLR9999
.
          MATCH     ADMISSNO,PMLRVISN
          GOTO      DELLR999 IF NOT EQUAL
.
          MATCH     TRANDATE,PMLRDATE
          GOTO      DELLR999 IF NOT EQUAL
.
          MATCH     TRANTIME,PMLRTIME
          GOTO      DELLR999 IF NOT EQUAL
.
          MOVE      PMLRCOUN,F3
          ADD       ONE,F3
          PACK      PMLRCOUN,F3
.
          MOVE      ANSD,PMLRRECS
          PACK      PMLRWEBD,USERID,SP70
          CALL      IBACLOCK
          PACK      PMLRDATD,CCC,CYY,CMM,CDD
          REP       " 0",PMLRDATD
          CLOCK     TIME,PMLRTIMD
          CALL      IBACLOCK
          PACK      PMLRCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMLRCDAT
          CLOCK     TIME,PMLRCTIM
.
          PACK      KEY27,PMLRVISN,PMLRDATE,PMLRTIME,PMLRCOUN,SP70
          CALL      RAPMLRD1
          IF        OVRCD=1
            CALL      WRPMLRD1
          ENDIF
.
.  inactive all matching records
.
          PACK      KEY27,ADMISSNO,TRANDATE,TRANTIME,SP70
          CALL      RSPMLRD1
DELLR100  CALL      RKPMLRD1
          BRANCH    OVRCD,DELLR999
.
          MATCH     ADMISSNO,PMLRVISN
          GOTO      DELLR999 IF NOT EQUAL
.
          MATCH     TRANDATE,PMLRDATE
          GOTO      DELLR999 IF NOT EQUAL
.
          MATCH     TRANTIME,PMLRTIME
          GOTO      DELLR999 IF NOT EQUAL
.
          MOVE      "1",PMLRACTV
          CALL      UPPMLRD1
          GOTO      DELLR100
.
DELLR999  RETURN
+
.**********************************************************************
.    Mark leave register record as deleted - called from supervisor delete
.    on leave. Not leave register record in context
.    Not the last on leave record.
.**********************************************************************
DLLLR000  BRANCH    NOLEAVRG,DLLLR999   * exit if table not created
.
          PACK      KEY27,ADMISSNO,TDATE,TTIME,Z70
          CALL      RSPMLRD1
          CALL      RPPMLRD1
          BRANCH    OVRCD,DLLR9999
.
          MATCH     ADMISSNO,PMLRVISN
          GOTO      DLLLR999 IF NOT EQUAL
.
          MATCH     TDATE,PMLRDATE
          GOTO      DLLLR999 IF NOT EQUAL
.
          MATCH     TTIME,PMLRTIME
          GOTO      DLLLR999 IF NOT EQUAL
.
          MOVE      PMLRCOUN,F3
          ADD       ONE,F3
          PACK      PMLRCOUN,F3
.
          MOVE      ANSD,PMLRRECS
          PACK      PMLRWEBD,USERID,SP70
          CALL      IBACLOCK
          PACK      PMLRDATD,CCC,CYY,CMM,CDD
          REP       " 0",PMLRDATD
          CLOCK     TIME,PMLRTIMD
          CALL      IBACLOCK
          PACK      PMLRCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMLRCDAT
          CLOCK     TIME,PMLRCTIM
.
          PACK      KEY27,PMLRVISN,PMLRDATE,PMLRTIME,PMLRCOUN,SP70
          CALL      RAPMLRD1
          IF        OVRCD=1
            CALL      WRPMLRD1
          ENDIF
.
.  inactive all matching records
.
          PACK      KEY27,ADMISSNO,TDATE,TTIME,SP70
          CALL      RSPMLRD1
DLLLR100  CALL      RKPMLRD1
          BRANCH    OVRCD,DLLLR999
.
          MATCH     ADMISSNO,PMLRVISN
          GOTO      DLLLR999 IF NOT EQUAL
.
          MATCH     TDATE,PMLRDATE
          GOTO      DLLLR999 IF NOT EQUAL
.
          MATCH     TTIME,PMLRTIME
          GOTO      DLLLR999 IF NOT EQUAL
.
          MOVE      "1",PMLRACTV
          CALL      UPPMLRD1
          GOTO      DLLLR100
.
DLLLR999  RETURN
+
.**********************************************************************
.    Mark leave register record as inactive- called from supervisor delete
.    return no leave register record in context
.**********************************************************************
DELRT000  BRANCH    NOLEAVRG,DELRT999   * exit if table not created
.
.  inactive all matching records
.
          PACK      KEY27,ADMISSNO,Z70
          CALL      RSPMLRD1
DELRT100  CALL      RPPMLRD1
          BRANCH    OVRCD,DELRT999
.
          MATCH     ADMISSNO,PMLRVISN
          GOTO      DELRT999 IF NOT EQUAL
.
          MATCH     ANSR,PMLRRECS
          GOTO      DELRT100 IF NOT EQUAL
.
          MOVE      "1",PMLRACTV
          CALL      UPPMLRD1
.
DELRT999  RETURN
+
.**********************************************************************
.    Mark leave register record as inactive - called from supervisor delete
.    return from leave. No leave register record in context.
.    Not the last return from leave record.
.**********************************************************************
DLLRT000  BRANCH    NOLEAVRG,DLLRT999   * exit if table not created
.
.  inactive matching return from leave record
.
          PACK      KEY27,ADMISSNO,TDATE,TTIME,Z70
          CALL      RSPMLRD1
DLLRT100  CALL      RPPMLRD1
          BRANCH    OVRCD,DLLRT999
.
          MATCH     ADMISSNO,PMLRVISN
          GOTO      DLLRT999 IF NOT EQUAL
.
          MATCH     TDATE,PMLRDATE
          GOTO      DLLRT999 IF NOT EQUAL
.
          MATCH     TTIME,PMLRTIME
          GOTO      DLLRT999 IF NOT EQUAL
.
          MATCH     ANSR,PMLRRECS
          GOTO      DLLRT100 IF NOT EQUAL
.
          MATCH     "1",PMLRACTV
          GOTO      DLLRT999 IF EQUAL
.
          MOVE      "1",PMLRACTV
          CALL      UPPMLRD1
.
DLLRT999  RETURN
+
.**********************************************************************
.         Update Default Printer File for User
.**********************************************************************
UPDEFP00  PACK      KEY20,SETDFPRG,KEY2,WBSEUID,SP70
          UNPACK    KEY20,IBPDPID,IBPDREP,IBPDUID
          MOVE      SCHDPRNT,IBPDPRT
          MOVE      NOLABEL,IBPDCOP         * no of copies
          MOVE      STATNCOD,IBPDDOC        * save stat code to document code
          MOVE      SP70,IBPDNUM
          MOVE      SP70,IBPDSPA
          CALL      RAIBPD1
          IF        OVRCD=0
            CALL      UPIBPD1
          ELSE
            CALL      WRIBPD1
          ENDIF
UPDEFP99  RETURN
+
.*******************************************************************************
.         Multiple Visit based comments
.*******************************************************************************
.         copy the comments back to file - first delete existing comments
.
UPCOM000  COMPARE   ZERO,TRNWEND  * not on screen
          GOTO      UPCOM999 IF EQUAL
.
          MOVE      "012",KEY3
.
          PACK      PMLRLRCN,SP1,SP1,ONE 
.
. * get highest unique number on file already
          PACK      KEY17,PMLRVISN,KEY3,Z70
          CALL      RSVSUCM1
          CALL      RPVSUCM1
          BRANCH    OVRCD,UPCOM200          * end of file
.
          MATCH     VSUCVISN,PMLRVISN       * same Admission Number?
          GOTO      UPCOM200 IF NOT EQUAL
          MATCH     VSUCCTYP,KEY3
          GOTO      UPCOM200 IF NOT EQUAL
.
          MOVE      ZERO,F3
          MOVE      VSUCUCNT,F3
          ADD       ONE,F3
          MOVE      F3,VSUCUCNT
.
UPCOM200  PACK     KEY27,PMLRVISN,PMLRDATE,PMLRTIME,PMLRCOUN,SP70
          CALL     RDPMLRD1
          IF       OVRCD=0
            PACK     PMLRLRCN,VSUCUCNT
            CALL     UPPMLRD1
          ENDIF
.
          PACK      KEY17,PMLRVISN,KEY3,PMLRLRCN,SP70
          CALL      RSVSUCM1
UPCOM400  CALL      RKVSUCM1
          BRANCH    OVRCD,UPCOM500          * end of file
          MATCH     VSUCVISN,PMLRVISN       * same Admission Number?
          GOTO      UPCOM500 IF NOT EQUAL
          MATCH     VSUCCTYP,KEY3
          GOTO      UPCOM500 IF NOT EQUAL
          MATCH     VSUCUCNT,PMLRLRCN
          GOTO      UPCOM500 IF NOT EQUAL
.
          PACK      KEY17,VSUCVISN,VSUCCTYP,VSUCUCNT,VSUCLNUM
          CALL      DEVSUCM1
          GOTO      UPCOM400
.
.         now write the new comments back
.
UPCOM500  MOVE      PMLRVISN,VSUCVISN          * set Admission Number
          MOVE      KEY3,VSUCCTYP              * set Comment Type
          MOVE      PMLRLRCN,VSUCUCNT          * set Unique Count number
.
          MATCH     "A",UPDTTYPE
          GOTO      UPCOM510 IF EQUAL
.
          MATCH     "U",UPDTTYPE
          GOTO      UPCOM510 IF EQUAL
.
          MOVE      PMLRCDAT,VSUCUDAT      * set Record Updated Date
          MOVE      PMLRCTIM,VSUCUTIM      * set Record Updated Time
          MOVE      PMLRWEBC,VSUCUUID      * set Record Updated by User ID
          MOVE      ZERO,F3
          GOTO      UPCOM520
.
UPCOM510  MOVE      PMLRCDAT,VSUCCDAT      * set Record Created Date
          MOVE      PMLRCTIM,VSUCCTIM      * set Record Created Time
          MOVE      PMLRWEBC,VSUCCUID      * set Record Created by User ID
          MOVE      ZERO,F3
.
UPCOM520  ADD       ONE,F3
          READ      COMFILAF,SEQ;VSUCLINE
.
          MATCH     SP70,VSUCLINE
          IF        @EQUAL
            IF        F3>=TRNWEND
              GOTO      UPCOM999
            ELSE
              GOTO      UPCOM520
            ENDIF
          ENDIF
.
          MOVE      F3,VSUCLNUM
          PACK      KEY17,VSUCVISN,VSUCCTYP,VSUCUCNT,VSUCLNUM
          CALL      RAVSUCM1
          IF        OVRCD=1
            CALL      WRVSUCM1
          ELSE
            CALL      UPVSUCM1
          ENDIF
.
          IF        F3>=TRNWEND
            GOTO      UPCOM999
          ENDIF
          GOTO      UPCOM520
.
UPCOM999  RETURN
.
.**********************************************************************
. Delete movement - copied from main1100 updttype=6 for leave register delete
.**********************************************************************
DELMV000  MOVE      ZERO,EXIT
          CALL      GSVDEP00
DELMV060  CALL      CHMTR000              * Cancel transfer/movement
          BRANCH    EXIT,DELMV999
          MATCH     SP70,HDPEQUIV
          IF        !@EQUAL
            CALL      WPEI0000              * write to patpeiaf
          ENDIF
.
          MOVE      ADMISSNO,AADMNO       * Set for following routine
          PROC      CALCCODE              * Recalculate hrs of ICU/NCU/CCU
.
          MATCH     "1",PTCNBMAN
          IF        @EQUAL
            PACK      KEY30,AADMNO,SP70
            CALL      RDSTRAN2
            CALL      RDKTRAN2
            BRANCH    OVRCD,DELMV070
.
            MATCH     DAADMNO,DTADMN
            GOTO      DELMV070 IF NOT EQUAL
.
            MATCH     "A",TMOVE
            GOTO      DELMV070 IF NOT EQUAL
.
            MOVE      TDATE,TRANDATE
            MOVE      TTIME,TRANTIME
            MOVE      TWARD,TRNTOWRD
            MOVE      TBED,TRNTOBED
            MOVE      ASTAY,STAYDAYS
            CALL      GETRG000    *  get regimes if not on screen
.
            IF        ASTAT=2
              PACK      KEY8,AADMNO,SP70
              CALL      RDPMWOR1
              IF        OVRCD=1
                CALL      CLPMWO00               * Use the expected discharge
              ENDIF                              * date if a current admission
.                                                * instead of TRANDATE plus
              MATCH     SP70,PMWOEDAT            * ASTAY
              IF        !@EQUAL
                DAYSEP    TRANDATE,PMWOEDAT,STAYDAYS
              ENDIF
            ENDIF
.
            CALL      UPPBMN00
          ENDIF
.
          PROC      BBUP0000                * Bed Board
.
DELMV070  CALL      CANMH000                * Cancel Mental Health records
.
DELMV999  RETURN
.
.**********************************************************************
. Update visxdcaf type 002 extra discharge details record
.**********************************************************************
UXDC0000  MATCH     Z70,MRFDDATE            * No medically ready for discharge
          GOTO      UXDC9999 IF EQUAL       * date received so exit
.
          MATCH     Z70,VSXDC014            * No reason for discharge
          GOTO      UXDC9999 IF EQUAL       * so exit
.
          MOVE      ADMISSNO,VSXDC001       * Visit Number   
          MOVE      TWO,VSTYPIND            * Type of Data
          MOVE      ONE,VSDATIND            * Date Field index (1-10)
          MOVE      MRFDDATE,VSDATVAL       * Date Field value (DIM8)
         
          CALL      UPDVDT00
.
          MOVE      TWO,VSTYPIND
          MOVE      TWO,VSCODIND
          MOVE      VSXDC014,VSCODVAL
.
          CALL      UPDVCV00
.
UXDC9999  RETURN
+
.----------------------------------------------------------------------------
. Get patient attribute details for URNO, admissno and attribute type "028"
.----------------------------------------------------------------------------
ATRFA000  UNPACK    DIM127,D1,D3,DIM127
          MATCH     SP70,D3
          GOTO      ATRFA999 IF EQUAL
          MOVE      ZERO,F3
          MOVE      D3,F3
.
          MOVE      "028",DIM3
          CALL      GPTATR00
          IF        EXIT = 1
            CALL      CLPATATR
          ENDIF
.
ATRFA008  BRANCH    F3,ATRFA010,ATRFA020,ATRFA030,ATRFA040,ATRFA050:
                       ATRFA060,ATRFA070,ATRFA080,ATRFA090,ATRFA100:
                       ATRFA110,ATRFA120
.
          GOTO      ATRFA999
.
ATRFA010  MOVE      "z1",CATEGORY
          MOVE      PTARCOD1,CODE
          CALL      CODITM00
          GOTO      ATRFA999
.
ATRFA020  MOVE      "z1",CATEGORY
          MOVE      PTARCOD2,CODE
          CALL      CODITM00
          GOTO      ATRFA999
.
ATRFA030  MOVE      PTARCOD3,DIM1
          WRITE     HTMLFILE;DIM1;
          GOTO      ATRFA999
.
ATRFA040  MOVE      PTARCOD4,DIM1
          WRITE     HTMLFILE;DIM1;
          GOTO      ATRFA999
.
ATRFA050  WRITE     HTMLFILE;PTARVAL1;
          GOTO      ATRFA999
.
ATRFA060  WRITE     HTMLFILE;PTARVAL2;
          GOTO      ATRFA999
.
ATRFA070  WRITE     HTMLFILE;PTARVAL3;
          GOTO      ATRFA999
.
ATRFA080  WRITE     HTMLFILE;PTARVAL4;
          GOTO      ATRFA999
.
ATRFA090  MATCH     SP70,PTARTXT1
          GOTO      ATRFA999 IF EQUAL
.
          UNPACK    PTARTXT1,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      ATRFA999
.
ATRFA100  WRITE     HTMLFILE;PTARTXT2;
          GOTO      ATRFA999
.
ATRFA110  WRITE     HTMLFILE;PTARTXT3;
          GOTO      ATRFA999
.
ATRFA120  WRITE     HTMLFILE;PTARTXT4;
          GOTO      ATRFA999
.
ATRFA999  RETURN
+
.----------------------------------------------------------------------------
. Read the relevant records and broadcast an HL7 update visit message (A08)
.----------------------------------------------------------------------------
BVISUP00  PACK      KEY8,ADMISSNO,SP70
          CALL      RDPTMIS1                     * admission on file ?
          BRANCH    OVRCD,BVISUP99               * no - finish
.
          MOVE      AURNO,KEY8
          CALL      RDMAST1                      * pmi record on file ?
          BRANCH    OVRCD,BVISUP99               * no - finish
.
          MOVE      AURNO,KEY8
          CALL      RDPMPX21                     * get pmi extension record
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPTRES1                     * get PRA record
          IF        OVRCD=1
            CALL      CLPATRE1
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDDSCH1                      * get discharge record
          IF        OVRCD=1
            CALL      CLPATDSC
          ENDIF
.
          PACK      KEY30,ADMISSNO,Z70
          CALL      RDSTRAN2                     * pos'n after last tran record
          CALL      RDPTRAN2                     * get last tran record
          BRANCH    OVRCD,BVISUP99               * eof - finish
.
          MATCH     ADMISSNO,DTADMN              * same admission still ?
          GOTO      BVISUP99 IF NOT EQUAL        * no - finish
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      SP8,HL7INCLD
.
          COMPARE   ONE,STATDSCH
          IF        @EQUAL
            IF        STDSCBAC=1
              MOVE      FORTY5,HL7TRGID
              PROC      DGCLICAC            * broadcast change admission details
              GOTO      BVISUP99
            ENDIF
          ENDIF
.
          COMPARE   ONE,STATADMN
          IF        @EQUAL
            IF        STADMFWD=1
              MOVE      FORTY6,HL7TRGID
              PROC      DGCLICDC            * broadcast change discharge details
              GOTO      BVISUP99
            ENDIF
          ENDIF
.
BVISUP99  RETURN
+
.==============================================================================
.
          INC       IBAWEBCD
          INC       WEBDATCD
          INC       AUTOATYP
          INC       CALCCODE
          INC       IBALPCCD
.
          INC       BEDBDPRO
          INC       CALCAGE
          INC       CALCDLOS
          INC       CHKCMXPT
          INC       CLACCAUD                    * Clear ACC Audit file variable
          INC       CLMEHDIA                * Clear mental health diag vars
          INC       CLMEHVIS                * Clear mental health visit vars
          INC       CLMRTMAS
          INC       CLNHIMAS
          INC       CLPATDSC
          INC       CLPMSPX2
          INC       CLPMSUPG                                  
          INC       CLPMSWX1                                  
          INC       CLPMSUPO                                
          INC       CLPATATR
          INC       CLPATTRN
          INC       CLVISXDC
          INC       DAYOFWEK
          INC       DEATHPOL
          INC       DGCLICAC
          INC       DGCLICAD
          INC       DGCLICCA
          INC       DGCLICPA
          INC       DGCLICPO                               
          INC       DGCLICPR                              
          INC       DGCLICRM
          INC       DGCLICUP                             
          INC       DGCLICDS
          INC       DGCLICDC
          INC       DGCLICCD
          INC       DGCLICTR
          INC       DGCLICCT
          INC       DGCLIUWL
          INC       EOCDELEV
          INC       EXCLNEWB
          INC       MEHCLDSC
          INC       MHAUDDLV
          INC       MHAUDDSC
          INC       MHAUDVIS
          INC       MRTVISCD
          INC       NAMSTRCD
          INC       NHOSPDAY
          INC       PABXPROC
          INC       PATDISCH
          INC       PATDSBFE
          INC       PATITMDS
          INC       PATMASTM
          INC       PATMISTM
          INC       PATCOMN3
          INC       PATCMSTP
          INC       PATCLMTM
          INC       PATDAYUP
          INC       PATDEFCL         * routine DCLM0000
          INC       PATDOCTM
          INC       PATDPATH                             
          INC       PATDSCTM
          INC       PATDYCAS
          INC       PATGNCMX
          INC       PATIPERH
          INC       PATMSXTM
          INC       PATSBTYP         * Calculate bed days for a specialty bed
          INC       PATTRRAT
          INC       PATVADCK
          INC       PATVISTM
          INC       PATQMHTM
          INC       PATMCHRD         * Miscellaneous Charges read routine
          INC       PMSHPGTM                            
          INC       PMSHRDTM
          INC       PMSVX1TM
          INC       PATWRDTM
          INC       PMIGTNID
          INC       PMSHCGTM
          INC       PMSHCPTM
          INC       PMSLRDTM
          INC       PMSPX2TM
          INC       RTIODAYS
          INC       UPPATDAD
          INC       WLHISSUB
          INC       CMXMATRX
          INC       CLPMSHRD
          INC       CLPMSVX1
          INC       CLPMSDAU
          INC       CLMEHLEG
          INC       CLMRTHIS         * clear MRT History record
          INC       CLPATRE1
          INC       CLPMSLRD
          INC       CLPATVIS
          INC       CLWATTX1
          INC       GETBFEES
          INC       GETTFEES
          INC       PATDDHRD
          INC       GETCNEFF
          INC       VALCMXFN
          INC       MEHDISTM
          INC       MEHDIATM
          INC       MEHVISTM
.          INC       PMSIPLCD
          INC       DEATHAUD
          INC       RSHWEBCD
          INC       DTTMADDD
          INC       CINVPEND
          INC       GETEFDRG
          INC       PMSWORTM
          INC       VISXDCTM
          INC       PRFAINSR
.
          INC       ACCAUDIO/INC
          INC       ACCDIAIO/INC
          INC       ALLCASIO/INC
          INC       ALLPCTIO/INC
          INC       APSMASIO/INC
          INC       EMRICDIO/INC
          INC       IBALPCIO/INC
          INC       OPRSRGIO/INC
          INC       OPRARDIO/INC
          INC       BOKRC1IO/INC
          INC       CCIEX7IO/INC
          INC       EMRVISIO/INC
          INC       MEHCJAIO/INC
          INC       MEHCJRIO/INC
          INC       MEHDIAIO/INC
          INC       MEHHLSIO/INC
          INC       MEHDLSIO/INC
          INC       MEHDL1IO/INC
          INC       MEHDS1IO/INC
          INC       MEHLEGIO/INC
          INC       MEHLERIO/INC
          INC       MEHREVIO/INC
          INC       MEHVI1IO/INC            * MH visit file
          INC       MRTHISIO/INC
          INC       MRTLOCIO/INC
          INC       MRTMASIO/INC
          INC       MRTMOVIO/INC
          INC       MRTPDSIO/INC
          INC       MRTVISIO/INC
          INC       MLTHCPIO/INC
          INC       NHIETHIO/INC
          INC       NHIMASIO/INC
          INC       OPRDEAIO/INC
          INC       OUTCLIIO/INC
          INC       OUTPHOIO/INC
          INC       OUTPREIO/INC
          INC       OUTSITIO/INC
          INC       OPRNURIO/INC
          INC       PATAA1IO/INC
          INC       PATACHIO/INC
          INC       PATADBIO/INC
          INC       PATAFEIO/INC
          INC       PATALRIO/INC
          INC       PATASDIO/INC
          INC       PATASFIO/INC
          INC       PATAXEIO/INC
          INC       BOKUNQIO/INC
          INC       PATBMDIO/INC
          INC       PATBRDIO/INC
          INC       PATBFEIO/INC
          INC       NZPBFEIO/INC
          INC       PATBRNIO/INC
          INC       PATCHCIO/INC
          INC       PMSUCHIO/INC
          INC       PMSUCDIO/INC
          INC       PATCMCIO/INC
          INC       VISMDTIO/INC
          INC       VISMTXIO/INC
          INC       PATCMXIO/INC
          INC       PMSBDCIO/INC
          INC       PATCMTIO/INC
          INC       PMSCMTIO/INC
          INC       PMSDAUIO/INC
          INC       PMSHRDIO/INC
          INC       PMSREGIO/INC
          INC       PMSRESIO/INC
          INC       PATATRIO/INC
          INC       PATCFAIO/INC
          INC       PATCTFIO/INC
          INC       PMSCAUIO/INC
          INC       PMSCIDIO/INC
          INC       PATDADIO/INC
          INC       PATDAYIO/INC
          INC       PATDGWIO/INC
          INC       PATDO1IO/INC
          INC       PATDRGIO/INC
          INC       PATDSCIO/INC
          INC       PATDTHIO/INC
          INC       PATDTRIO/INC
          INC       PATECDIO/INC
          INC       PATECOIO/INC
          INC       PATEORIO/INC
          INC       PMSCEXIO/INC
          INC       PATFEEIO/INC
          INC       PATFN1IO/INC
          INC       PATFIMIO/INC       
          INC       PATFX1IO/INC
          INC       PATFHIIO/INC
          INC       PATGSRIO/INC
          INC       PATHDFIO/INC
          INC       PATHLFIO/INC
          INC       PATHOSIO/INC      
          INC       PATHSPIO/INC
          INC       PATICOIO/INC
          INC       PATICUIO/INC
          INC       PATINVIO/INC
          INC       PATIN1IO/INC
          INC       PATIPEIO/INC
          INC       PATITMIO/INC
          INC       PATLDFIO/INC
          INC       PATLOCIO/INC
          INC       PATLSDIO/INC
          INC       PATMA1IO/INC
          INC       PATLINIO/INC
          INC       PATMCHIO/INC
          INC       PATMI1IO/INC
          INC       PATMMBIO/INC
          INC       PATMRGIO/INC
          INC       PATNHHIO/INC
          INC       PATNIDIO/INC
          INC       PATNOBIO/INC
          INC       PATNUMIO/INC
          INC       PATNURIO/INC
          INC       PATONLIO/INC
          INC       PATOPTIO/INC
          INC       PATPGRIO/INC
          INC       PATPEIIO/INC
          INC       PATPR1IO/INC
          INC       PATQMHIO/INC
          INC       PATRATIO/INC
          INC       PATRCAIO/INC
          INC       PATRE1IO/INC
          INC       PATRGMIO/INC
          INC       PATSFAIO/INC
          INC       PATSGCIO/INC
          INC       PATSTAIO/INC
          INC       PATTFEIO/INC
          INC       PATTRNIO/INC
          INC       PATUNAIO/INC
          INC       PATVADIO/INC
          INC       PATVENIO/INC
          INC       PATVISIO/INC
          INC       PATWC1IO/INC
          INC       PATWMAIO/INC
          INC       PATONHIO/INC
          INC       PATWR1IO/INC
          INC       PATWVEIO/INC
          INC       PMSEXTIO/INC
          INC       OUTBOAIO/INC   
          INC       OUTBB1IO/INC  
.
          INC       PMSCCDIO/INC   * Concession Card Details
          INC       PMSLRDIO/INC
          INC       PMSUPGIO/INC  
          INC       PMSUPOIO/INC  
          INC       PMSHPGIO/INC  
          INC       PMSHPOIO/INC  
.          INC       PMSIPLIO/INC  
          INC       PMSRCBIO/INC
          INC       PMSCNOIO/INC
          INC       PMSCTCIO/INC
          INC       PMSCURIO/INC
          INC       PMSADWIO/INC
          INC       PMSEDWIO/INC
          INC       PMSMORIO/INC
          INC       PMSMTIIO/INC
          INC       PMSPX2IO/INC
          INC       PMSVX1IO/INC
          INC       PMSWORIO/INC
          INC       PMSWTRIO/INC
          INC       PMSWX1IO/INC            * Patient Work Compensation Ext
          INC       PRSDTLIO/INC
          INC       RESLNKIO/INC
          INC       SCRMASIO/INC
          INC       VISUCMIO/INC
          INC       WATCATIO/INC
          INC       WATCHAIO/INC
          INC       WATHISIO/INC
          INC       WATPNPIO/INC
          INC       WATPROIO/INC
          INC       WATTR1IO/INC
          INC       WATTX1IO/INC
          INC       WATESEIO/INC
          INC       IBAPOLIO/INC
          INC       PMSRUGIO/INC
          INC       PATWBHIO/INC
          INC       PMSEDGIO/INC       * Effective DRG Dates
          INC       VISXDCIO/INC
          INC       PATDDHIO/INC
          INC       TFILENAM
.
          INC       CALCLEAV        
          INC       CHKWCCLM           * Check multiple Workers Comp claims
          INC       ATRFB000
          INC       ATRFC000
.
          INC       COMPARIO/INC
          INC       CLCOMPAR
          INC       CLPMSEXT
          INC       GTCMPA00
          INC       MVITCONF
