.------------------------------------------------------------------------------
. Program       : WATWEB01
.
. Function      : Waiting List Information Server
.
. Modifications  :
.------------------------------------------------------------------------------
. V12.00.03 17/10/2025  Don Nguyen     TSK 0963735
.           Removed code to stop WTPAEND count at 99 in GETCOM00
. V12.00.02 20/08/2025  Jacob Jackson  TSK 0963735
.           Stop WTPAEND count at 99 to prevent overflow
. V12.00.01 19/05/2025  Ebon Clements  TSK 0960463
.           Recompiled for UPEADMVS - eAdmission document update by
.           22/05/2025  Alina Bhari   TSK 0955096
.           Added alpanumeric visit number generation  
. V11.05.06 18.03.2025  DA Sarkies     Task 0955909
.           Updated the ESIS extract to add the ASAS code
. V11.05.05 13.03.2025  DA Sarkies     Task 0955909
.           Added code to handle WTTXASAS code for reading and displaying
. V11.05.04 06.03.2025  DA Sarkies     Task 0955909
.           Added code to retrieve and record NDIS number in watespaf  
. V11.05.03 19.12.2024  DA Sarkies     Task 0954547
.           Commented out <cat> tags to prevent browser incompatibility
. V11.05.02 26.11.2024  Ebon Clements  Task 0954547
.           Added <cat-c> start and end tag to category=XX tag
. V11.05.01 21.11.2024  Ebon Clements  TSK 0953786
.           Added identifying gender to ESIS patient details watespaf
. V11.04.06 10.09.2024  DA Sarkies     TSK 0951076
.           Recompiled for WATTRETM
. V11.04.05 13/08/2024  Nikitha B      TSK 0949879
.           Commented moving of WATTR003 to BKDIDES1 at WATDET28 to prevent
.           overriding of theater "full decription" from Waiting list "Procedur"
. V11.04.04 09/05/2024  Thanh T        TSK 0923560
.           Recompiled as OPRCASTM changes
. V11.04.03 28/02/2024  Ebon Clements  TSK 0916740
.           Recompiled for WATTRETM - RFS days
. V11.04.02 10/01/2024 Thanh T         TSK 0936263
.           Recompiled for DGCLIAWL changes
. V11.04.01 17/11/2023  Alina Bhari    TSK 0925540
.           When adding a proposed admission date to a WL that has had a
.           booking removed, displayed Sch Adm Date as change - WATHIS20
. V11.03.09 21.08/2023  DA Sarkies     TSK 0930673
.           Added ADDTPR00 function to return the prority to 
.           previous value if Suspension is cancelled. 
. V11.03.08 17/08/2023  Ebon Clements  TSK 0935669
.           
. V11.03.07 10/08/2023  Nikitha B      TSK 0935669
.           Added WTEEPTWT and WTEESGID at CLRWTESE
. V11.03.06 28/07/2023  Ebon Clements    TSK 0935527
.           Recompiled for OPRQUEFD - Theatre booking hospital
. V11.03.05 11/07/2023  Ebon Clements    TSK 0934718
.           Added clear of WTEETCMP in CLRWTESE
. V11.03.04 26/06/2023  Ebon Clements    TSK 0933824
.           Changed SESSKEYS from DIM 19 to DIM 22
.           Changed CASEKEYS from DIM 23 to DIM 26
. V11.03.03 17/05/2023  Ebon Clements    TSK 0932616
.           Recompiled for PMSPX2TM - Current IP
. V11.03.02 31/01/2023  Thanh T.         TSK 0919770
.           Recompiled as OPRDPHFD/IO changes
. V11.03.01 24/01/2023 PJ Le Febour      Task 0921040
.           Introduced a limit of 20 accounts that can be merged.
.           If mergecount < 20 alert User then navigate to Waiting List
.           If mergecount > 20 alert an Error
. V11.02.03 08/04/2022 Jill Parkinson Task 0918715  
.           Corrected merged UR to give error instead of loop
. V11.02.02 24.02.2022  DA Sarkies       TSK 0889899
.           Added cgi variables WATTR060 and WATTR061  
. V11.02.01 09/02/2022  Thanh T          TSK 0905641
.           Recompiled as WATTR1FD/OUTMA1FD changes
. V11.01.03 19/07/2021  Ebon Clements  Task 0897729 
.           Only map pre admission status cat XG to cat BG if cat XG
.           indicator 2 is not blank - WATDET23
. V11.01.02 19/07/2021  Jill Parkinson Task 0909109 
.           Fixed wsus1000
. V11.01.01 23/02/2021  Ebon Clements  TSK 0892530
.           Added supervisor update priority list - PRTTAB00
.           Added supervisor update/delete priority history - CATHIS30/40
. V11.00.10 09/12/2020  Thanh T        TSK 0872840
.           Added PMSCCDFD/PMSCCDIO as PMSPX2TM changes
. V11.00.09 22/05/2020  Ebon Clements  Task 0888659
.           Added one second to data integrity write to stop duplicate keys
.           WRCHA0000 and WRCHL0000
.           Added data integrity audit types 18 to 30 - DITB0000
. V11.00.08 29/04/2020  Jill Parkinson Task 0890757
.           Recompiled for WATTRETM
. V11.00.07 21/04/2020  Jill Parkinson Task 0890757
.           Added checks for indicator 3=P for category WR to behave as per X
. V11.00.06 09/04/2020  J.Tan             TSK 0868813
.           Mod to set PACFRMT to 3 for PKNAME
. V11.00.05 02/04/2020  J.Tan             TSK 0868813
.           Changed PKNAME to DIM80
. V11.00.04 24/03/2020  Thanh T        TSK 0888687
.           Added MVWDET80
. V11.00.03 20/03/2020  Peter Vela     Task 0889143
.           Fixed WATLET IO calls 
. V11.00.02 19/03/2020  Peter Vela     Task 0889143
.           Recompiled for WATLETFD
. V11.00.01 26/02/2020  Ebon Clements  Task 0888833
.           Added VSCMTLIN to CLRPAR00 and set to ZERO
. V10.15.06 05/02/2020  Jill Parkinson Task 0887253
.           Added write of claim type changes to watchaaf type=30
. V10.15.05 31/01/2020  Ebon Clements  Task 0886495
.           Fixed redirect in update procedure comment section of change
.           procedure - FIXPRO00 - NEWCASEK
. V10.15.04 07/01/2020  Jill Parkinson Task 0883888
.           Mods to only write watchaaf type 23 for edward sites
. V10.15.03 14/11/2019  Thanh T        TSK 0878880
.           Added ACCURC00 for changing U/R in waiting list procedure
. V10.15.02 17/10/2019  Ebon Clements  TSK 0871855
.           Changed SMS selection list to be in code order - SMSSEL00 
. V10.15.01 08/10/2019  Peter Vela     TSK 0879217
.           Added nz message for Inactive/Invalid ESIS Code
.------------------------------------------------------------------------------
. V10.14.12 09/09/2019  Peter Vela     TSK 0878344
.           Added unscheduled validation to XMLADM00
. V10.14.11 22/08/2019  Don Nguyen     TSK 0875542  
.           Added U/R Extension Details tag processing for Report 4 (PROFLD44)
. V10.14.10 31/07/2019  Peter Vela       TSK 0874259
.           Validate for existing patwc1af record before update in DEWCOM00
. V10.14.09 16/07/2019  Jill Parkinson Task 0875525
.           Corrected change below - update wattr1af when suspension ends 
.           in future or past
. V10.14.08 29/05/2019  Jill Parkinson Task 0875525
.           Changed ADDTP000 to update wattr1af when suspension ends in future
. V10.14.07 22/05/2019  Jill Parkinson Task 0875079
.           Fixed setting of WATTR054 to look for "1" OR "Y"
. V10.14.06 21/05/2019  Ebon Clements   TSK 0874508
.           Changed to use common clear of WATOPAFD - CLWATOPA
. V10.14.05 11/04/2019  Jill Parkinson Task 0872286
.           Added write to watchaaf type=29 for intended stay changed
. V10.14.04 08/04/2019  Tracey Nguyen     TSK 0871443
.           Recompiled for PATATRTD/PATARTM
. V10.14.03 01/04/2019  Jill Parkinson Task 0869595
.           Added write of wttxrcli to wateseaf for 1 July 2019 ESIS
.           03/04/2019  Jill Parkinson Task 0872773
.           Added move of WMBOOK to ADMISSNO in CPRA0000
. V10.14.02 18/03/2019  Richa Phoagt    TSK 0869550
.           Added ACCAUDFD/IO, CLACCAUD, MVACCREM
. V10.14.01 27/02/2019  Ken Bell       TSK 0869648
.           Recompiled for PATCLMTM - Added Diagnosis Codes for NZ template
. V10.13.14 23/01/2019  Nicole Torrisi TSK 0867815
.           Fixed setting of WATTR054 to look for "1" instead of "Y"
. V10.13.13 28/12/2018  Thanh T           TSK 0863964
.           Recompiled for WATTRETM, Added WATTRKEY for WATTX1TM changes. 
. V10.13.12 15/12/2018  Jill Parkinson Task 0867308
.           Added writes to watchaaf for short notice and source of referral
. V10.13.11 15/12/2018  Jill Parkinson Task 0865808
.           Recompiled for WLHISSUB - referral source update
. V10.13.10 14/12/2018  Thanh T        TSK 0867312
.           Changed WATTAB00, UNTTAB00 to return proposed Op Date from
.           wattr1af.WTWMDABD
. V10.13.09 11/12/2018  Ebon Clements  Task 0867095
.           Changed doctor link (31) to call DoctorViewFrame - WATUNS00
. V10.13.08 06/12/2018  Jill Parkinson Task 0867095
.           Added intended stay filter and noonload
. V10.13.07 22/11/2018  Don Nguyen      TSK 0864609
.           Fixed bug introduced in Task 0841602 for linked referral (RLNK0000).
.           Updating a WL entry no longer clears the referral link previously
.           created.
. V10.13.06 21/11/2018  Jill Parkinson Task 0866897
.           Recompiled for WATTRETM -priority changes to ignore deferred for nsw
. V10.13.05 08/11/2018  Richa Phogat   TSK 0865156
.           Added condition under BOKSEL00 to not display CatBK codes which have
.           Booking type = "UNS"
. V10.13.04 07/11/2018  Don Nguyen     TSK 0853817
.           Added ability to remove non-compensible claims (DOCLMN00) on update
. V10.13.03 19/10/2018   Ebon Clements  TSK  0865146
.           Added EDWARD alteration change U/R to watchaaf - WRCHU000
.           17/10/2018  Don Nguyen     TSK 0838558
.           Deleted temp file (VSCTTFIL) after processing.
.           Moved temp file creation (CLRVCM00) to comments processing section
.           rather than on server startup.
. V10.13.02 17/09/2018   Richa Phogat  TSK  0861839
.           Updated WATDET20 to save BKREC005 to BKREATIM
. V10.13.01 17/09/2018   Jill Parkinson Task 0863558
.           Added WRPP0000 to collect change in PPP
.------------------------------------------------------------------------------
. V10.12.15 28/06/2018  Don Nguyen     TSK 0855360
.           Modified PATLB000 to save CASEKEYS
. V10.12.14 25/06/2018  Ebon Clements  TSK 0845295
.           Update eRefrral on status change - UPSTA000             
. V10.12.13 25/06/2018  Ebon Clements  TSK 0845295
.           Update eReferral procedure code if changed - WATDET77
.           21/06/2018  Richa Phogat   TSK 0854035
.           Recompiled for WATTRETM
. V10.12.12 21/06/2018  Richa Phogat   TSK 0854035
.           Updated WATDET20 to update BKRXUDF3, if blank utilise ind2 of CAT XG
.           & BG to match and write first active match found
. V10.12.11 04/06/2018  Ken Bell          TSK 0821014
.           Add Default of WL Reason/Diagnosis using AH Diagnosis 1 Description
.           Add default of score and Clinician cancer sus(if X9 code = lv code)
. V10.12.10 04/06/2018  Nicole Torrisi    TSK 0857634
.           Changed to not REP " 0" in SELPRINT when spooling
. V10.12.09 15/05/2018  Jill Parkinson    TSK 0846170
.           Added call to WRCS0000 when updating suspension (write watchaaf 23)
. V10.12.08 03/05/2018  Richa Phogat      TSK 0843171
.           Added field FIRSTBOK 
. V10.12.07 19/04/2018  Jill Parkinson Task 0846170
.           Recompiled for WATTRETM - source of referral to allow cat S
. V10.12.06 07/03/2018  Ebon Clements  TSK 0850348
.           Recompiled for WATTRETM - WL history list
. V10.12.05 01/03/2018  Ania P         TSK 0853009
.           Fixed date comparison logic in CHKVIS00
. V10.12.04 12/02/2018  Jill Parkinson TSK 0846170 
.           Added setting of wttxcdte,wttxctim and wttxcuid
.           Added write of booking to watchaaf
. V10.12.03 31/01/2018  Thanh Tieu      TSK 0851375
.           Recompiled as OPRCASTM changed
. V10.12.02 23/01/2018  Ebon Clements   TSK 0845295
.           Added eReferral functionality  - cgi erefrlid
. V10.12.01 09/01/2018  Richa Phogat    TSK 0845727
.           Added condition to check future Date 'Not Ready for Care' under
.           CHKSTS00. Recompiled for WATTRETM.PBL
.------------------------------------------------------------------------------
. V10.11.15 27/11/2017  Thanh Tieu      Task 0821710
.           Recompiled as PATMASTM changed
. V10.11.14 02/11/2017  Peter Vela      TSK 0842304
.           Added functionality to copy across data for Outpatient
.           Appointment from linked Referral for patwc1af, pmswx1af
.           accrfpaf, accdiaaf, acccmtaf in ADDWAT00
. V10.11.13 25/10/2017  Jill Parkinson Tsk 0825240
.           Added output of PRIOSTAT in UNTTAB00
. V10.11.12 10/10/2017  Ania P         TSK 0841602
.           Added functionality for linked referral
. V10.11.11 03/10/2017  Peter Vela     TSK 0845586
.           Added waiting list history save variables to CLWATHIS
. V10.11.10 02/10/2017  Thanh T.       TSK 0821710
.           Audit Amission/outpatient visit comments
. V10.11.09 27/09/2017  Jill Parkinson TSK 0845190
.           Added code to WESE000 to save removal values from sent records also
. V10.11.08 19/09/2017  Richa Phogat   TSK 0842304
.           Added code to pull ACC details for the Waiting List event from the
.           referral
. V10.11.07 18/09/2017  Jill Parkinson TSK 0845190
.           Corrected check for theatre bookings in XMLADM00
. V10.11.06 18/09/2017  Jill Parkinson TSK 0836522
.           Added check for victoria to not allow update of details when disch.
. V10.11.05 01/09/2017  Jill Parkinson TSK 0835069
.           Added direct read of watphiaf for records ending on date keyed
. V10.11.04 24/08/2017  Davin          TSK 0837617
.           Added new I12,I13,I14 message triggers (DGCLIAWL/DGCLIUWL/DGCLIRWL)
. V10.11.03 30/07/2017  Thanh T.       TSK 0821710
.           Audit admission/outpatient/UR comments. changed PATMASTM/PMSPX2TM.
. V10.11.02 26/07/2017  Thanh T.       TSK 0821710
.           Recompiled PASMISTM
. V10.11.01 14/07/2017  Thanh T.       TSK 0821710
.           Audit Amission/outpatient visit comments. PATMISTM changed.
.------------------------------------------------------------------------------
. V10.10.03 30/05/2017  Thanh T.       TSK 0838766
.           recompiled for WATTRETM
. V10.10.02 22/05/2017  Thanh T.       TSK 0825240
.           Added Days Not Ready for surgery for Patient and Clinical
. V10.10.01 29/03/2017  Tracey Nguyen  TSK 0833454
.           Recompiled for PATATRTD/PATARTM
.------------------------------------------------------------------------------
. V10.09.04 13/02/2017  Peter Vela     TSK 0832819
.           Added update to Procedure Desc Comments in FIXPRO50
. V10.09.03 12/01/2017  Jill Parkinson TSK 0822329    
.           Changed to use CLPMSWX1
. V10.09.02 16/12/2016  Jill Parkinson TSK 0830073
.           Added output of last priority change date - needed to stop changing
.          before the last time it was changed to keep watcataf records in order
.           14/12/2016  Jill Parkinson TSK 0830360
.           Added check for merged UR's in GETTRE00 so you can still search
.           by uniqueid after the wattr1af record has been merged
. V10.09.01 02/12/2016  Jill Parkinson TSK 0822329    
.           Added ACC purchase order number and write to pmswx1af
. V10.08.14 23/09/2016  Jill Parkinson TSK 0820099    
.           Added read and output of ALWLVISN
. V10.08.13 01/09/2016  Ania P             CAR 815103
.           Forked F12/F13 patcodes read in DITB0000 for CATFX
. V10.08.12 01/09/2016  Jill Parkinson TSK 0822418     
.           Mods to UPDSUS00 to allow suspension start on the same days as
.           the previous suspension ends
. V10.08.11 29/08/2016  Ebon Clements   TSK 0294154   
.           Recompiled for WATTRETM -  WL letter history
. V10.08.10 13/07/2016  Don Nguyen      TSK 0294154   
.           Modified SETPAR00 to replace space with zero for SELPRINT
.           14/07/2016  Jill Parkinson TSK 08224174   
.           Recompiled for WATTRETM - rfc calculation to include Prev Wait Time
. V10.08.09 08/07/2016  Jill Parkinson  TSK 0822002   
.           Added match of attribute type 001 in PATATR00
. V10.08.08 06/07/2016  Jill Parkinson  TSK 0821099   
.           Added read of watphiaf in WTESIS00 to find historical HDP equivelent
. V10.08.07 05/07/2016  Ania P            CAR 0821935
.           Fixed excess <br> output in WLCOMM00 
. V10.08.06 28/06/2016  Don Nguyen         TSK 0322481
.           Modified WLCOMM00 to write <BR> after comment line
. V10.08.05 07/06/2016  Jill Parkinson     TSK 0820003
.           Recompiled for PMSCEXCD - allow patmx1af/patma1af details
. V10.08.04 06/06/2016  Peter Vela         TSK 0321157
.           Recompiled for PATATRFD
. V10.08.03 28/04/2016  Don Nguyen         TSK 0316489
.           Recompiled for PATATRTM & PATATRFD/IO
. V10.08.02 18/04/2016  Jill Parkinson     TSK 0813956
.           Added Total Previous Waiting Time   
. V10.08.01 23/03/2016  Don Nguyen         TSK 0303887
.           Added BATCHNUM - NBRS Batch Number
.----------------------------------------------------------------------
. V10.07.09 04/02/2016  Don Nguyen         TSK 0322481
.           Modified WLCOMM00 to only write <BR> where more than 1 line
. V10.07.08 17/12/2015  Ebon Clements      TSK 0294154
.           Added Opt out of SMS tag - PCOM7800
. V10.07.07 17/12/2015  Ebon Clements      CAR 294154
.           Added SMS notification functionality
. V10.07.06 02/12/2015  Don Nguyen         CAR 316633
.           Modified DUPCHA00 to loop by UR
. V10.07.05 30/11/2015  Don Nguyen         CAR 316633
.           Added DUPCHA00 - Validate all existing WL Proc codes 
. V10.07.04 16/11/2015  Don Nguyen         CAR 316633
.           Modified DUPCHK00 - Added validation for Scheduled/Unscheduled when
.           same Procedure code but different dates.
. V10.07.03 30/10/2015  Don Nguyen         CAR 320394
.           Added code to set file variables WTTXUD09-WTTXUD13.
.           Recompiled for changes to WATTX1FD/IO and WATTX1TM.
. V10.07.02 07/10/2015  Ebon Clements  CAR 316633
.           Added link new WL entry to a referral functionality
. V10.07.01 06/10/2015  Jill Parkinson CAR 318550
.           Changed ADPU0000 and ADSU000 to use F6 not F3 for patients with
.           over 999 days NRFC
. V10.06.20 21/09/2015  Davin             CAR 313906
.           Recompiled for PMSCEXCD - allow patmx1af/patma1af details
. V10.06.19 22/09/2015  Ebon Clements     CAR 316628
.           Fixed mobile phone number display of short notice list - BOKRWB00 
. V10.06.18 10/09/2015  Peter Vela        CAR 321492
.           Added validation for suspension sount in UPDSUS10
. V10.06.17 02/09/2015  Davin             CAR 312680
.           Add Delete Interpreter Audit Record after cancel booking (INTCAN00)
. V10.06.16 18/08/2015  J.Tan             CAR 316628
.           Mods for W/L view by Short Notice/Booking Contracts Unscheduled
. V10.06.15 04/08/2015  Peter Vela        CAR 320249
.           Replace XCDATE spaces with zeros in DELWAT00
. V10.06.14 14/07/2015  J.Tan             CAR 317921
.           Recompiled for PMSEXTTM - checking for inactive Insurance code
. V10.06.13 30/06/2015  Jill Parkinson CAR 317015   
.           Added in wahfunct to clear sch adm date/time for wahealth 
.           unscheduled patients
. V10.06.12 25/06/2015  Steve Armstrong   CAR 318558
.           Recompiled for changes to BOKQUEFD & BOKQUEIO
. V10.06.11 10/06/2015  Steve Armstrong   CAR 313856
.           Mods to use CLVISINT & CLVISIAU instead of internal
.           clear routines
. V10.06.10 18/05/2015 Patrick Adair  CAR 208170
.           Recompiled for changes to UPDUR
. V10.06.09 05/05/2015 Ebon Clements   CAR 314075
.           Added clinical cgi and tag
. V10.06.08 30/04/2015 Ania P          CAR 313976
.           Mods to UPDATR00
. V10.06.07 02.04/2015 B.G.Ackland    CAR 312482
.           Recompiled for UPEADMVS Online Preadmission Changes
. V10.06.06 23/03/2015  Peter Vela CAR 308564
.           Added nowrap to Comments column in COMTAB00
.           Increased number of lines displayed in WCOMM000 to ten
. V10.06.05 17/03/2015  Nicole Torrisi CAR 299464
.           Added Admission Comments GETACM00 and PTCMN000
. V10.06.04 16/03/2015  Peter Vela     CAR 309100
.           Added write to PATATRFD with new WMBOOK to DELBOK20
. V10.06.03 12/03/2015  Steve Armstrong  CAR 314108
.           Removed definition of PTCGDATE as PATCGPFD is no longer
.           in use.
. V10.06.02 11/03/2015  J.Tan          CAR 314106
.           Changed BKREC024 from DIM8 to DIM10
. V10.06.01 10/03/2015  Jill Parkinson CAR 311829
.           Mods to not allow vic sites to suspend on same date as previous
.           suspension ends
.----------------------------------------------------------------------
. V10.05.07 19/02/2015  Ebon Clements  CAR 313149 
.           Removed SFORMAT on HTMLLINK as it can't be used on vars longer
.           than DIM 127 - CASLNK00
. V10.05.06 08/01/2014  Peter Vela     CAR 304784
.           Added validations for procedure and count in GETTHE00
. V10.05.05 06/11/2014  Don Nguyen     CAR 304059
.           Recompiled for changes to OPRSESIO - added Default Team Completed
.           fields.
. V10.05.04 14/10/2014  Peter Vela     CAR 301518
.           Recompiled for UPEADMVS
. V10.05.03 29/08/2014  Don Nguyen     CAR 303881
.           Recompiled for changes to WATTRETM - added WTRE4830
. V10.05.02 04/08/2014  Peter Vela     CAR 299131
.           Added new bokrx1 fields to CLBKRX00
. V10.05.01 28/07/2014  Peter Vela     CAR 301176
.           Added calculated BMI to ADDATR00 and UPDATR00
. V10.04.10 14/07/2014  Ebon Clements  CAR 303319
.           Changed SELPRIN1, SELPRIN2 and SELPRIN3 to DIM6
. V10.04.09 03/07/2014  Peter Vela   CAR 279020
.           Added BMI functionality
. V10.04.08 06/05/2014  Peter Vela   CAR 279020
.           Recompiled for WATTRETM
.           Allow spaces in BKREC039 in ADDBOK00
.           Added tag for WBSEUID in PCOM0000
. V10.04.07 07.04.2014  Peter Vela   CAR 286158
.           Recompiled for PATMASTM
. V10.04.06 31.03.2014  B.G.Ackland  CAR 299363
.           Replace META Tag Redirect with Javascript in Common RDIREC00
.           Routine
. V10.04.05 26/03/2014  J.Tan          CAR 294185
.           ESIS July 1 2014 changes
. V10.04.04 06/03/2014  Patrick Adair  CAR 295839
.           Added remote script to calculate Admit on or before Date
.           13/03/2014  J.Tan          CAR 214167
.           Changed WATTR004 to DIM 80 instead of 40
. V10.04.03 06/02/2014  Patrick Adair  CAR 293445/293780
.           Recompiled for changes to UPEADMVS
. V10.04.02 15/01/2014  Peter Vela        CAR 295705
.           Added updates to watmhdaf and watmtxaf in WLSGL000
. V10.04.01 31/12/2013  Don Nguyen     CAR 294389
.           Recompiled for changes to WATLETFD & WATLETIO
.----------------------------------------------------------------------
. V10.03.95 11/12/2013  Ebon Clements  CAR 293092
.           Added notified and confirmed to interpreter audit
. V10.03.94 14/11/2013  Peter Vela     CAR 293607
.           Enabled spaces to be assigned to variables in MVWDET00
. V10.03.93 13/11/2013  Peter Vela     CAR 293607
.           Enabled spaces to be assigned to WATTR046
. V10.03.92 28/10/2013  Patrick Adair  CAR 201234
.           Update wathisaf with new visit number if status has changed
. V10.03.91 09/10/2013  Ebon Clements  CAR 275205
.           Added EBS unknown U/R edits to limit U/R usage
. V10.03.90 03/10/2013  Ebon Clements  CAR 275205
.           Recompiled for PMSARQFD - Addition of transfer source
. V10.03.89 30/09/2013  Ebon Clements  CAR 252054
.           Added admission request functionality           
. V10.03.88 30/09/2013  Peter Vela     CAR 291974
.           Recompiled for WATTX1TM - Added validations for Start and End Date
.           in HCPHOS00
. V10.03.87 30/09/2013  Ania P         CAR 263655
.           Added notetype to KEY19 in PCOM4800
. V10.03.86 11/09/2013  Jill Parkinson CAR 280284
.           Added update of watchaaf ni WLSGL00 to fix records when changing ppp
. V10.03.85 10/09/2013  Steve Armstrong  CAR 291089
.           Recompiled for changes to PMSQVIIO
.           26/08/2013  Ebon Clements    CAR 275205
.           Recompiled for WATTX1FD - New fields WTTXPSAH and WTTXPHOS
. V10.03.84 06/09/2013  Jill Parkinson CAR 290323
.           Removed part of change from 10.03.47 - exit functionality from
.           GETOPR00.  WA health don't use theatre and would not get there
. V10.03.83 19/08/2013  Don Nguyen       CAR 178866
.           Recompiled for changes to WATTRETM
. V10.03.82 08/08/2013  Don Nguyen       CAR 289889
.           Recompiled for changes to WATTRETM - Added WTWMPDSC to CLWATDET.
.           Fixed up VALWAT00 (invalid labels to WATDET routines).
. V10.03.81 06/08/2013  Patrick Adair    CAR 289877
.           Recompiled for OPRCASTM after eAdmission changes were overwritten
. V10.03.80 30/07/2013  Patrick Adair    CAR 289389
.           Updated to cater for new documents workflow requirements
. V10.03.79 25/07/2013  Davin            CAR 288962
.           Only broadcast A44 message for scheduled patients
. V10.03.78 18/07/2013  Steve Armstrong  CAR 268961
.           Recompiled for changes to PMSQVIFD.
. V10.03.77 12/07/2103  Ebon Clements  CAR 287112
.           Recompiled for WEBDATCD - View type 4 week view
. V10.03.76 11/07/2013  Peter Vela       CAR 286751
.           Added tag for UNITCOD2
. V10.03.75 28/05/2013  Patrick Adair    CAR 285158
.           Populate Visit Number to eAdmission table
. V10.03.74 27/05/2013  Peter Vela       CAR 261630
.           Removed port number from temp file name
. V10.03.73 27/05/2013  Patrick Adair    CAR 285158
.           Added ADMISNID for eAdmission in PCOM0000
. V10.03.72 16/05/2013  Peter Vela       CAR 272093
.           Added functionality to print multiple letter from watweb0104001.html
. V10.03.71 08/05/2013  Ania P           CAR 284957
.           Recompiled for WATTX1TM
. V10.03.70 01/05/2013  Steve Armstrong  CAR 284376
.           Recompiled for changes to DGCLICUP.
. V10.03.69 19/04/2013  Jill Parkinson CAR 284283
.           Added error message in ADDWAT00 when 99 procedures exist
. V10.03.68 15/04/2013  Steve Armstrong  CAR 267329
.           Recompiled for changes to DGCLIWLD, DGCLIWLU & DGCLIWLB.
.           Removed CISMFLAG & IBAMFLAG definitions.
. V10.03.67 17/04/2013  J.Tan            CAR 284019
.           Mods to change Procedure Description Comments
. V10.03.66 03/04/2013  Davin          CAR 270648
.           Recompiled for changes to HL7 messaging includes
. V10.03.65 28/03/2013  Patrick Adair  CAR 281132
.           Strip spaces from WTWMPDSC and WMDESC - new requirement
. V10.03.64 26/03/2013  Patrick Adair  CAR 281548
.           Replaced inline CLOPRDEA code with included routine CLOPRDEA
. V10.03.63 26/03/2013  Peter Vela     CAR 281071
.           Added empty doctcode validation @ WATLST00
. V10.03.62 21/03/2013  Ebon Clements  CAR 267752
.           Added change intended hospital to data integrity audit
.           20/03/2013  Patrick Adair  CAR 281132
.           Added new fields WTWMPDSC and WTTXANAE on WL Screens
. V10.03.61 19/03/2013  Jill Parkinson CAR 282814
.           Recompiled for PATMASTM - Disability alert DSAL0000 change
. V10.03.60 15/03/2013  Patrick Adair  CAR 250713
.           Added call to NRCDAY00 to WATUNS30 
. V10.03.59 28/02/2013  Patrick Adair  CAR 250713
.           Added RFC and corrected "all" option - template had previously 
.           been changed to but the server had never been updated
. V10.03.58 25/02/2013  Patrick Adair  CAR 250713
.           Added RFC Days to output of UNTTAB00
. V10.03.57 06/02/2013  Ebon Clements  CAR 278154
.           Fixed clear and save of suspension file user id field
. V10.03.56 31/01/2013  Ebon Clements   CAR 262292
.           Added language to interpreter audit
. V10.03.55 31/01/2013  Ania P.         CAR 278174
.           Reset RECCOUNT in WATSUN00 and DATTAB00.
. V10.03.54 22/01/2013  J.Tan           CAR 279185
.           Mods Reportable (WTREP000) to display DNO
. V10.03.53 02/01/2013  Jill Parkinson  CAR 278665
.           Changed packing of keys before writing to watrtdaf    
. V10.03.52 18/12/2012  Ania P.         CAR 278174
.           Removed looping of DATTAB10 after LISTLIMT is reached.
. V10.03.51 11/12/2012  Don Nguyen      CAR 273770
.           Modified ADDBOK92 & UPDBOK94 with different wording
. V10.03.50 05/12/2012  Jill Parkinson  CAR 277119
.           Recompiled for WATTRETM - LSTDAY00 change for astat=4 but no admis
. V10.03.49 29/11/2012  Don Nguyen      CAR 273770
.           Added check on UPDBOK00 for Scheduled Admission Time against 
.           Waiting List time and output error message (UPDBOK94) if greater.
. V10.03.48 21/11/2012  Ebon Clements   CAR 273380
.           Fixed AIWH reportable - blank & zero not reportable, 1 reportable
. V10.03.47 02/11/2012  Peter Vela      CAR 271880
.           Added Update to BKRXADWD @ WATDET00
.           Changed exit condition afer GETOPR00 @ WATDET00 to update BKDIDES1
.           and BKDIDES2
. V10.03.46 12/10/2012  Patrick Adair   CAR 273294
.           Recompiled for PATCLMTM
. V10.03.45 31/08/2012  Peter Vela       CAR 266428
.           Added VSINCHON before write to visintaf
. V10.03.44 28/08/2012  Sandra Barcham CAR 272069 
.           Stop writing wttxcdte to bkrxcndt when creating medical booking
. V10.03.43 16/08/2012  Don Nguyen     CAR 270629 
.           Recompiled for WATTRETM - Removed unnecessary field WTRB0030
. V10.03.42 15/08/2012  Don Nguyen     CAR 270629 
.           Recompiled for WATTRETM - Changed output for field WTRB0030
. V10.03.41 15/08/2012  Don Nguyen     CAR 270629 
.           Recompiled for WATTRETM - Added new extension field WTRB0030
. V10.03.40 26/07/2012  Jill Parkinson CAR 267938
.           Changed row restriction to use WTCNNRTS                    
.           Fixed move of ZERO to HLTURNON
. V10.03.39 05/07/2012  Jill Parkinson CAR 268600 
.           Set 200 row restriction for UNTTAB00 (to prevent timeouts) 
. V10.03.38 29/06/2012  Peter McMullen CAR 267938 
.           Set 200 row restriction for WATTAB00 (to prevent timeouts) 
. V10.03.37 28/06/2012  Steve Armstrong  CAR 267352
.           Recompiled for changes to HL7WEXFD
. V10.03.36 25/06/2012  Steve Armstrong  CAR 267355
.           Moved HL7 Trigger "9" for W/L A08 to after UPWTTX11
. V10.03.35 22/06/2012  Peter Vela     CAR 267367
.           Added RDATREA1 before WRTREA1 to fix I*D
. V10.03.34 07/06/2012  Peter McMullen CAR 261500 
.           Remove 50 row restriction from tablesort rows
. V10.03.33 09/05/2012  Saroeun Soeur  CAR 258960
.           Recompiled for WEBDATCD
. V10.03.32 20/04/2012  Ebon Clements  CAR 260555
.           Added removal time to data integrity removal records
. V10.03.31 10/04/2012  Peter Vela     CAR 262395
.           Added FIXWLC000, copy across Witing List comments to new UR
. V10.03.30 10/04/2012  Ebon Clements  CAR 260555
.           Write scheduled adm date/time to cancel booking audit - WRCHJ000
. V10.03.29 30/03/2012  Ebon Clements  CAR 260555
.           Added cancel booking to data integrity audit - DITB0000
.           Write cancel booking and removal audit on cancel booking - DELBOK00
. V10.03.28 23/03/2012  Ebon Clements  CAR 260555
.           Display original value for unadmit data integrity audit - DITB000
. V10.03.27 16/03/2012  Jill Parkinson CAR 243341
.           Recompiled for BOKRX1TM
. V10.03.26 13/03/2012  Ebon Clements  CAR 260555
.           Fixed data integrity display of type 03 admission - DITB0000
. V10.03.25 06/03/2012  Peter Vela     CAR 261139
.           Added FIXCOM00, copy across Waiting List comments to new procedure
. V10.03.24 06/03/2012  Peter Vela     CAR 261194
.           Added tag for WTTXADMW
. V10.03.23 05/03/2012  Peter Vela     CAR 261194
.           Added tag for WBSEHOSP Description @ PCOM0000
. V10.03.22 01/03/2012  Ebon Clements  CAR 261063
.           Added inactive test to WL letter selections
.           LETSEL00, BKSELL00 & LETSNC00
. V10.03.21 17/02/2012  Davin           CAR 256006
.           HL7 trigger calls - moved DGCLIWLD to before DELBOK20
. V10.03.20 15/02/2012  Davin           CAR 256006
.           HL7 trigger calls - added change UR trigger (dgclicur)
.           HL7 trigger id 12 - added WL transfer trigger (dgcliwlu)
. V10.03.19 13/02/2012  Jill Parkinson CAR 256376 
.           Fixed supervis check of pmstmdaf
. V10.03.18 12/02/2012  Jill Parkinson CAR 256376 
.           Added tmddoctf and reads of pmstmdaf instead of watvwlaf
. V10.03.17 09/02/2012  Davin           CAR 256006
.           HL7 trigger calls - moved DGCLIWLD to DELBOK50
.           HL7 trigger calls - added DGCLIWLU to UPDWAT80
. V10.03.16 27/01/2012  Ebon Clements   CAR 256564
.           Added scheduled adm time display to data integrity audit - DITB0000
. V10.03.15 25/01/2012  J.Tan           CAR 259076
.           Fixed Removal date
. V10.03.14 18/01/2012  Peter Vela      CAR 254454
.           Recompiled for WATTX1TM
. V10.03.13 16/01/2012  Sandra Barcham  CAR 256563
.           Recompiled for PATMASTM
. V10.03.12 12/01/2012  Peter Vela        CAR 254454
.           Recompiled for WATTX1TM
. V10.03.11 19/12/2011  Ebon Clements     CAR 257425
.           Changed WALENQ00 to redirect top content page
. V10.03.10 06/12/2011  Peter Vela       CAR 253855
.           Added DISPATA2
. V10.03.09 02/12/2011  Ebon Clements    CAR 259098
.           Recompiled for WATTRETM - Change of intended hospital
. V10.03.08 29/11/2011  Peter Vela       CAR 254598
.           Changed update type to "08" @ WTCHPN00
. V10.03.07 17/11/2011  Saroeun Soeur    CAR 246840
.           Recompiled for WEBDATCD
. V10.03.06 16/11/2011  Peter Vela       CAR 253855
.           Added tag for Disaster Description
.           Added tag for Disaster ID Number
. V10.03.05 16/11/2011  Peter Vela       CAR 254598
.           Added Reason for Change to WRCHI000
.           Added change type 08 to Cat WD @ DITB0000
. V10.03.04 15/11/2011  Peter Vela       CAR 254598
.           Added write to watchaaf on change of scheduled admission date/time
.           @ UPDBOK00
. V10.03.03 14/11/2011  Mike Laming       CAR 233064
.           Added "Actual Procedure Event Number" WRWMACPR 
. V10.03.02 09/11/2011  Ebon Clements     CAR 248529
.           Added multiple contacts of the same type functionality
. V10.03.01 09/11/2011  Jill Parkinson   CAR 254908
.           Added use of WTCNERFC in NEWOVR00
. V10.02.38 04/11/2011  Steve Armstrong  CAR 254751
.           Recompiled for changes to OPRQUEFD
. V10.02.37 20/10/2011  Peter Vela       CAR 250014
.           Added tags for No. of scheduled Admission/Booking Postponements
. V10.02.36 11/10/2011  Mark Coupland    CAR 252429
.           Recompiled for PMSPX2TM and PATMASTM
. V10.02.35 04/01/2011 Steve Armstrong  CAR 246036   
.           Mods to add HL7 message triggers for W/L bookings
.           (DGCLIWLB, DGCLIWLU and DGCLIWLD).
. V10.02.34 29/09/2011 Jill Parkinson CAR 248486     
.           Recompiled for IBAWEBCD - Restrict hospital access
.           30/09/2011 Sandra Barcham CAR 252332     
.           Fix AIHW reportable list view
. V10.02.33 23/09/2011 Sandra Barcham     CAR 251575
.           Fix various views on Date on List
. V10.02.32 22/09/2011 Sandra Barcham     CAR 251574
.           Fix various views
. V10.02.31 22/09/2011 Sandra Barcham     CAR 251572
.           Added description for ap in overdue list WATUNS
. V10.02.30 21/09/2011  Steve Armstrong   CAR 251515
.           Recompiled for changes to WATQUEFD.
. V10.02.29 21/09/2011 Sandra Barcham  CAR 251394
.           Remove limit of 50 records on the overdue w/l records
. V10.02.28 18/09/2011  Jill Parkinson CAR 250989
.           Added ALLWFLAG -show all waiting list records regardless of hospital
. V10.02.27 16/09/2011  Jill Parkinson CAR 243296
.           Added WABKHIST for BKHI0000 layout
. V10.02.26 13/09/2011  Ebon Clements  CAR 249576
.           Added data integrity type 15 update suspension
. V10.02.25 13/09/2011 Jill Parkinson  CAR 248652
.           Recompiled for PMSPX2TM - Added read of pmsvx1af in GETCURIP
. V10.02.24 13.09.2011  Sandra Barcham CAR 250840
.           Display Unknown for Inform GP in WATTX1TM
. V10.02.23 08.09.2011  Jill Parkinson CAR 249587
.           Added clear of new bokrx1af fields
. V10.02.22 08.09.2011  Jill Parkinson CAR 249822
.           Recompiled for WATTRETM
. V10.02.21 08.09.2011  Jill Parkinson CAR 249822
.           Added clear of watsusaf in WATDET00
. V10.02.20 05.09.2011  Saroeun Soeur  CAR 246840
.           added WTWMGADD,HLTURNON,HLREASON
. V10.02.19 01/09/2011  Peter McMullen CAR 248749
.           Removed redundant include  WATLETDF
.           03/09/2011  Jill Parkinson CAR 250111
.           Added pack of WTSUTDAT in WRCHF000
. V10.02.18 26/08/2011  Peter Vela     CAR 249292
.           Added prefer functionality to NWDALT00
. V10.02.17 24/08/2011 Sandra Barcham  CAR 248907
.           Changed warning message
. V10.02.16 23/08/2011  Ebon Clements  CAR 234855
.           Fixed display of delete suspension type 14 - DITB0000
. V10.02.15 22/08/2011 Sandra Barcham  CAR 248530
.           Changed warning message                         
. V10.02.14 18/08/2011  Ebon Clements  CAR 234855
.           Added new return to WL data integrit audit type
. V10.02.13 18/08/2011  Ebon Clements  CAR 234853
.           Added reason for scheduled adm date change to data integrity audi
. V10.02.12 14/08/2011 Jill Parkinson CAR 235921   
.           Added output of watmtxaf comments
. V10.02.11 12/08/2011 Jill Parkinson CAR 243296   
.           Added red comment button functionality
. V10.02.10 07/08/2011 Jill Parkinson CAR 243296   
.           Added removal time functionality
. V10.02.09 05/08/2011 Peter Vela       CAR 239559
.           Removed functionality for PTCNDIAI and used DISMASFD.DSMAAICD
.           05/08/2011  Jill Parkinson CAR 247834
.           Added wahealth fields to clear
. V10.02.08 04/08/2011  Steve Armstrong  CAR 247627 
.           Added DGCLCUP trigger for pmsaidaf
. V10.02.07 01/08/2011  Jill Parkinson   CAR 243296 
.           Added output of wprhat
. V10.02.06 20/07/2011  Jill Parkinson   CAR 243296 
.           Recompiled for changes to WATTX1TM and added mltsecaf
.           Added CHKWA000
. V10.02.05 22/06/2011  Steve Armstrong   CAR 240722
.           Recompiled for changes to PMSCEXCD 
. V10.02.04 27/06/2011  Ebon Clements    CAR 240725
.           Change ward selection list to sort by name, not code 
. V10.02.03 14/06/2011  Ebon Clements    CAR 239530
.           Added print extra contact functionality
. V10.02.02 28/05/2011  Steve Armstrong  CAR 243854 
.           Fixed display of W/L comments (watmtxaf) to validate against
.           note (wtmtnote) in addition to previous parts of the key
.           (in WLCOMM00).
. V10.02.01 04/04/2011  Jill Parkinson CAR 239574   
.           Removed open of ibaprntf
.----------------------------------------------------------------------
. V10.01.05 02/02/2011  Jill Parkinson CAR 237189   
.           Mods to save new WTEEADAT,WTEERREM and WTEERDAT
. V10.01.04 18/02/2011  Jill Parkinson CAR 234014   
.           Increased descriptions from 50 or 55 to 80
. V10.01.03 13/01/2011  Ebon Clements     CAR 236087
.           Recompiled for PATCLMTM - Defence force
. V10.01.02 22/12/2010 Ebon Clements  CAR 235884
.           Fixed test for deleted comments - COMTAB00
. V10.01.01 04/11/2010 Davin          CAR 210842
.           Recompiled for WATTRETM - Default Change column to 'W/L Updated'
.----------------------------------------------------------------------
. V10.00.14 25/10/2010 Sandra Barcham     CAR 230271
.           Data integrity audit should be category FX not FW
. V10.00.13 08/10/2010  Ebon Clements     CAR 223825
.           Clear bokrx1af fields at WATDET00
. V10.00.12 27/09/2010  Ebon Clements     CAR 218982
.           Added new comments exist tag - WSUS1700
. V10.00.11 08/09/2010  Ebon Clements     CAR 218982
.           Added header and line based WL and WL Pre Adm comments
. V10.00.10 02/09/2010  Jill Parkinson    CAR 222489
.           Added clear of BKRXDIET and BKRXTRAN
.           Added BOOKDATE,BOOKTIME,BOOKWARD and BOOKEBED cgi's
. V10.00.09 02/09/2010  Ebon Clements     CAR 218982
.           Added data integrity audit functionality to suspensions
. V10.00.08 24/08/2010  Mike Laming       CAR 195158
.           Recompiled for PATMASTM - Legal Status Icon changes
. V10.00.07 18/08/2010 Sandra Barcham    CAR 228041
.           For unscheduled patients it should display WMDATE3 for proposed
.           admission date
. V10.00.06 17/08/2010 Davin S           CAR 216360
.           Recompiled for OPRCASTM
. V10.00.05 10/08/2010 Jill Parkinson    CAR 227858
.           Recompiled for WATTRETM - NRCDAY00 not to change wttxplst value
. V10.00.04 29/06/2010 Ebon Clements     CAR 218982
.           Added data integrity audit functionality
. V10.00.03 18/06/2010 Mike Laming       CAR 221911
.           Re-compiled for PATMASTM - NZ LS Alerts
. V10.00.02  21/04/2010 Saroeun Soeur     CAR 196071
.            added WATTX033 and recompiled from WATTXTM
. V10.00.01 19/03/2010  Steve Armstrong   CAR 135505
.           Added HL7TRGID & HL7INCLD setting for all broadcast messages
.-------------------------------------------------------------------------------
. V9.12.18  15/03/2010  Saroeun Soeur  CAR 183899
.           fixed cgi variables
. V9.12.17  28/01/2010  Jill Parkinson CAR 213458
.           Added suspension prior to date on list in UPDSUS93
. V9.12.16  18/01/2010  Jill Parkinson CAR 213458
.           Added = in match DATE1 to DATE3 in ADDSUS10
. V9.12.15  14/12/2009  Jill Parkinson CAR 204235
.           Mods to use ERRORFLG instead of EXIT
. V9.12.14  11/12/2009  Jill Parkinson CAR 204235
.           Removed WRWTESN1 in UPESUS00
. V9.12.13  09/12/2009  Peter McMullen CAR 210130
.           recomplied for WATTRETM
. V9.12.12  26/11/2009  Saroeun Soeur  CAR 164870
.           recomplied for WATTRETM
.           added remote script DUPCHK00
. V9.12.11  09/11/2009  Davin          CAR 208349
.           Recompiled for DGCLICUB - check correct parameter to trigger CUB
. V9.12.10  06/10/2009  Jill Parkinson CAR 204527
.           Mods to CHKVIS00 to check for any preadmissions (not only 7 days)
. V9.12.09  22/09/2009  Jill Parkinson CAR 204703
.           Removed V9.12.04 changes
. V9.12.08  11/09/2009  Saroeun Soeur  CAR 183899
.           added new cgi
. V9.12.07  09/09/2009  Jill Parkinson CAR 205541
.           Recompiled for WATTRETM
. V9.12.06  07/09/2009  Peter Vela     CAR 196071
.           Moved SP70 into WTTXANAE before write
. V9.12.05  26/08/2009  Peter McMullen CAR 171901
.                       remove MAPCAT00 call
. V9.12.04  15/07/2009  WeeLee Koo    CAR 182620
.           Display defaulted Booking Type (CAT-BK)- PCOM0100 
. V9.12.03  18/06/2009  Jill Habasque CAR 197190
.           Mods to update priority when adding suspension records
. V9.12.02  27/05/2009  Peter Vela    CAR 196337
.           Added new multihospital ward Selection sub routine WSEH0000
. V9.12.01  12/05/2009  Ebon Clements CAR 195390
.           Added missing bokrx1af fields to CLBKRX00
. V9.11.10  01/05/2009  Jill Habasque CAR 145706
.           Added WL by GP list
. V9.11.09  17/04/2009  Ebon Clements CAR 184925
.           Added doctor filter to waiting list by unit - UNTTAB00
. V9.11.08  11/03/2009  Jill Habasque CAR 179959
.           Mods to write all WTWMDTAD changes if NSW 
. V9.11.07  25/02/2009  Peter Vela    CAR 187336
.           Check for template 023 before read pmi files
. V9.11.06  18/02/2009  Jill Habasque CAR 184242 Rebound
.           Mods to clear WTENEDAT and set WTENETYP in CHNSUS15
. V9.11.05  17/02/2009  Peter Vela    CAR 183976
.           Moved spaces to BKRXPOEC in CLBKRX00
. V9.11.04  04/02/2009  Mike Laming   CAR 187336
.           Remove suspect code to stop loop in WATWEB01 at label WATDET02
. V9.11.03  10/12/2008  Jill Habasque CAR 184242
.           Mods to go to CHNSUS15 if old record doesn't exist
. V9.11.02  07/11/2008  Jill Habasque CAR 182701
.           Added SCHDCOPY to setpar and clrpar   
. V9.11.01  06/11/2008  Peter McMullen CAR 174725
.           convert internal javascript to W3C standards
. V9.10.11  03/09/2008  Davin         CAR 147323
.           Send hl7 message for upd bookings (added call DGCLIS14)
. V9.10.10  01/09/2008  Jill Habasque CAR 176735
.           Added match to Z70 for BOKRX006 before updating
. V9.10.09  29/08/2008  Ebon Clements CAR 163818
.           Added serbflag cgi and tag
. V9.10.08  22/08/2008  Ebon Clements CAR 168503
.           Added defturno cgi and tag
. V9.10.07  22/07/2008  Jill Habasque CAR 174359
.           Recompiled for WATTRETM - clear of wtwmassr
. V9.10.06  28/05/2008  Ebon Clements CAR 169238
.           Added missing fields to CLWTX000
. V9.10.05  30/01/2008  Jill Habasque CAR 160321
.           Added redirect with WMBOOK appended for ACC screens
. V9.10.04  19/05/2008  Ebon Clements  CAR 162051
.           Recompiled for BOKRECTM - BKREDOFR
. V9.10.03  08/05/2008  Jill Hbabasque CAR 140255
.           Added report option 18 - booking confirmation
. V9.10.02  01/05/2008  Jill Hbabasque CAR 166097
.           Added WTWMASSR - Assessor code     
. V9.10.01  30/04/2008  Jill Hbabasque CAR 165994
.           Mods to populate WTEPEDOB for ESIS
. V9.09.13  27/02/2008  Jill Hbabasque CAR 142726
.           Recompiled for WATTRETM - added use of WTCNERFC - ESIS RFC calc
. V9.09.12  19/02/2008 Jill Habasque CAR 157574
.           Added write to bokunqaf
. V9.09.11  20/12/2007 Jill Habasque CAR 126282
.           Added update of update date/time for oprdetaf
. V9.09.10  12/12/2007 Jill Habasque CAR 56032
.           Recompiled for WATTRETM - output of wthidbft in history list
.           06/12/2007  Ebon Clements CAR 152329
.           Recompiled for WATTRETM - Tag for WMUDEF4
.           04/12/2007  Steve Armstrong  CAR 155887
.           Recompiled for changes to DGCLICUB.
. V9.09.09  21/11/2007  Jill Habasque CAR 152264
.           Added DELSS000 - Delete esis suspension when changed to future date
. V9.09.08  26/09/2007  Peter Vela    CAR 148954
.           Added functionality for Hospital Level Medical Bookings
. V9.09.07  19/09/2007  Jill Habasque CAR 150317
.           Added CHKVIS00 - Check for preadmission/admission
. V9.09.06  14/09/2007  Ebon Clements CAR 150226
.           Added PTCNUFFR - Using frame friendly
. V9.09.05  03/09/2007  Peter Vela    CAR 148639
.           Added Gravida filter to Waiting List by Date
.           Cabrini Health watweb0103001.html
. V9.09.04  22/08/2007  Jill Habasque CAR 148317
.           Added calls to GETSET00
. V9.09.03  10/07/2007  Jill Habasque CAR 144382
.           Mods to call UPRNK000 if last review date is changed
. V9.09.02  21/06/2007  Jill Habasque CAR 143398
.           Mods to allow suspensions starting the same day as another finishes
. V9.09.01  21/06/2007  Jill Habasque CAR 143141
.           Fixed packing of WTENWEBC
.----------------------------------------------------------------------
. V9.08.15  08/06/2007  Jill Habasque CAR 142566
.           Fixed adding/changing watsusaf records updating wttxplst
. V9.08.14  06/06/2007  Jill Habasque CAR 142257
.           Remove call to UPDLST00 in PCOM2100
. V9.08.13  24/05/2007  Jill Habasque CAR 132881
.           Added clear of WTEEREMD and WTEERREM if unremoving
. V9.08.12  22/05/2007  Jill Habasque CAR 141173
.           Recompiled for WLHISSUB
. V9.08.11  09/05/2007  Jill Habasque CAR 139862
.           Added WTTX23HR
. V9.08.10  27/04/2007  Jill Habasque CAR 137931
.           Recompiled for WLHISSUB
. V9.08.09  26/04/2007  Jill Habasque CAR 139340
.           Added call to WRTHIS00 in UPPRI000
. V9.08.08  07/03/2007  Jill Habasque  CAR 135076
.           Added locks around WTCNECNT and WTCNHCTU
. V9.08.07  26/02/2007  Peter Vela     CAR 126014
.           Recompiled for OPRCASTM
. V9.08.06  06/02/2007  Jill Habasque  CAR 127559
.           Added WATLETR3 for selection list to be in alphabetical order
. V9.08.05  31/01/2007  Peter Vela     CAR 127930
.           Recompiled for MRTMASFD
. V9.08.04  31/01/2007  Jill Habasque  CAR 113107
.           Mods to update OPDAPROC and OPDACONT in supervisor function
. V9.08.03  04/12/2006  Peter Vela    CAR 126014
.            Recompiled for OPRCASTM - Added Unplanned Visit To Theatre
.                                    - Added tag for existing record in pmsvx1af
. V9.08.02  16/11/2006  Jill Habasque CAR 124708
.           Fixed update of WTWMBSCD in WATSCH00
. V9.08.01  27/09/2006  Jill Habasque CAR 110312
.           Added update of SAVERDT3 in UPDBOK00        
.----------------------------------------------------------------------
. V9.07.06  19/09/2006  Mike Laming   CAR 111288
.           Move routine CLWATDET out of here into WATTRETM
. V9.07.05  11/09/2006  Peter Vela    CAR 118226
.           Recompiled for PATCLMTM
. V9.07.04  30/08/2006  Peter Vela    CAR 117576
.           Recompiled for WATLETDF
. V9.07.03  15/08/2006  Jill Habasque CAR 116079
.           Fixed update of ESIS details after discharge            
. V9.07.02  27/07/2006  Jill Habasque CAR 110312
.           Mods to use treatment date when writing to wathisaf     
. V9.07.01  12/07/2006  Jill Habasque CAR 110312
.           Added write to wathisaf when updating a medical booking
.----------------------------------------------------------------------
. V9.06.03  06/06/2006  Peter Vela    CAR 104129
.           Added EOS validation for WTLHREPR (MVLHI000)
.           Added default to spaces for WTLHREPR at PWTLET00
. V9.06.02  17/05/2006  Jill Habasque CAR 100130
.           Mods to create an 04 instead of 03 NBRS record
. V9.06.01  01/05/2006  Jill Habasque CAR 103096
.           Fixed update of bokdiagf when changing PPP
.----------------------------------------------------------------------
. V9.05.03  31/03/2006  Peter Vela    CAR 86019
.           Recompiled for WATLETDF
. V9.05.02  09/03/2006  Ebon Clements CAR 78533
.           Mods for PATCODTM - Hospital specific category codes
. V9.05.01  07/03/2006  Jill Habasque
.           Mods to CHNSUS00 to allow for future dates
. V9.05.B05 10/02/2006  Mike Laming   CAR 87093
.           Recompiled for WLHISSUB - correct Consent Changed records
. V9.05.B04 02/02/2006  Peter Vela    CAR 89644
.           Recompiled for BOKRX1TM
. V9.05.B03 30/01/2006  Ebon Clements CAR 93186
.           Mods for REDIRECT length change. Recompiled for IBAWEBDF
. V9.05.B02 23/12/2005  Mike Laming   CAR 87726
.           Correct test for Suspended ToDate (if blank) in DELSUS00
.----------------------------------------------------------------------
. V9.04.44  29/11/2005  Ebon Clements CAR 86062
.           Set manually added record to no for esis episode file
. V9.04.43  28/11/2005  Jill Habasque CAR 86409
.           Added update of WTEEADAT with WMDATE4 in WESE0000
. V9.04.42  25/11/2005  Jill Habasque CAR 86280
.           Added match for Z70 to previd01 in CHKESE00
. V9.04.41  11/11/2005  Peter Vela    CAR 80156
.           Recompiled for OPRCASTM
. V9.04.40  04/11/2005  Jill Habasque CAR 80161
.           Removed call to WSAD0000 when updating history records
. V9.04.39  31/10/2005  Jill Habasque CAR 58640
.           Added CONREC00 - Update of confirmation date/time
. V9.04.38  28/10/2005  Jill Habasque CAR 81822
.           Fixed update of current RFC status when updating suspension
. V9.04.37  24/10/2005  Jill Habasque CAR 80660
.           Recompiled for WATTRETM - LSTDAY00 calculation
. V9.04.36  19/10/2005  Jill Habasque CAR 80774
.           Added UPDTESIS flag for changing PPP
. V9.04.35  14/10/2005  Jill Habasque CAR 80161
.           Removed write to watesnaf when updating wathisaf           
. V9.04.34  13/10/2005  Jill Habasque CAR 55584
.           Added multiple letter printing option and print pmi labels
. V9.04.33  11/10/2005  Jill Habasque CAR 76509
.           Recompiled for WATTRETM
. V9.04.32  29/09/2005  Mike Laming   CAR 52354
.           Add Consent Given & Consent Changed Date (WTWMCSST & WTWMCSDT)
.           03/10/2005  Jill Habasque           
.           Fixed suspensions ending in the future in WESUS000
.           04/10/2005  Ebon Clements  CAR 78188
.           Added test for Z70 before moving WATTR003 and WATTR004 to BKDIDES1
.           BKDIDES2
.           04/10/2005  Ebon Clements  CAR 76000
.           Added call to UESN0000 to update esis if changing date in list    
. V9.04.30  21/09/2005  Jill Habasque CAR 76910
.           Added check for DOL before 20050701 for WTEEARDT
. V9.04.29  14/09/2005  Ebon Clements CAR 76051
.           Set manually added record to no before write to watesnaf
. V9.04.28  07/09/2005 Jill Habasque CAR 75251
.           Added write of "07" record for wmdate2 change
. V9.04.27  06/09/2005  Jill Habasque CAR 75059 
.           Added check for wtcnbrsr instead of using wtwmsrcr
. V9.04.26  02/09/2005  Jill Habasque CAR 73862 
.           Added check for intra episode records before writing removal
. V9.04.25  02/09/2005  Jill Habasque CAR 71847 
.           Mods to stop duplicating history records
. V9.04.24  24/08/2005  Jill Habasque CAR 73489 
.           Recompiled for WATTRETM
.           Changed to output wtwmecnt instead of wtwmuniq
. V9.04.23  08/04/2005  Jill Habasque CAR 70599 
.           Added clear of wtwmdtad
.           Added write of 03 or 04 record when clearing wtwmdtad
.           Added check for M in indicator 3 for WTEEINSD             
.           Added writes of "04" records when changing priority 
.           from/to Care & review
. V9.04.22  13/07/2005  Jill Habasque CAR       
.           Added check for Z70 around WATTX026 when removing from WL
. V9.04.21  15/06/2005  Jill Habasque CAR 60165
.           Added call to WESE0000 for supervisor functions
. V9.04.20  09/06/2005  Jill Habasque CAR 60165
.           Added wtenabrg and wtensadi
. V9.04.19  31/05/2005  Jill Habasque CAR 62408
.           Recompiled for WATTRETM - added output of procedure 2 & 3 desc
. V9.04.18  06/05/2005  Jill Habasque CAR 61656
.           Stopped populating booking referring Doctor with WL referring GP
. V9.04.17  06/05/2005  Jill Habasque CAR 61455
.           Fixed comments when adding a patient as NRFC
. V9.04.16  04/05/2005  Jill Habasque CAR 46826
.           Added new routine - NEWOVR00
. V9.04.15  18/04/2005  Jill Habasque CAR 60754
.           Fixed calculation in UNTTAB00
. V9.04.14  06/04/2005  Mike Laming   CAR 60140
.           Add code to set WTTXPLST in "wattx1af" at DELSUS00 for Cancel Susp.
.           Add routine DELES000 to update ESIS suspend records
. V9.04.13  04/04/2005  Ebon Clements CAR 55594
.           Added Pre Anaesthetic clinic functionality
. V9.04.12  01/04/2005  Jill Habasque CAR 55601
.           Added calculation of days since certainty given
. V9.04.11  31/03/2005  Ebon Clements CAR 55603 & 54352
.           Added WTWMUNIQ and WTWMBOOK for nz list screens
. V9.04.10  31/03/2005  Ebon Clements CAR 55604
.           Added new field for category and rank to WATTAB00
. V9.04.09  07/03/2005  Peter Vela    CAR 57547
.           Recompiled for PATVADFD and PATVADIO
.           07/03/2005  Lina Vo       CAR 56404
.           Changed OPRDPAFD to OPRDPHFD.  Recompiled for OPRCASTM.
.           04/03/2005  Jill Habasque CAR 55604
.           Added check for DOCERROR
. V9.04.08  24/02/2005  Jill Habasque CAR 58443
.           Fixed update of bokdiaaf for medical bookings
. V9.04.07  16/02/2005  Jill Habasque CAR 58295
.           Fixed clearing of ESIS previous id
. V9.04.06  20/01/2005  Jill Habasque CAR 57027
.           Fixed medicare reference
. V9.04.05  09/12/2004  Jill Habasque CAR 54731
.           Added writes to new ESIS tables
. V9.04.04  08/12/2004  Jill Habasque CAR 55536
.           Added BOKSEL00
. V9.04.03  13/10/2004  Jill Habasque CAR 54231
.           Changed bkreatim to be updated with bkrec005
. V9.04.02  29/09/2004  Jill Habasque CAR 53600
.           Added display of claim details
. V9.04.01  10/08/2004  Mike Laming  CAR 40489
.           Changes to Interpreter Visit Details "visintaf" & Audit "visiauaf"
.----------------------------------------------------------------------
. V9.03.27  26/07/2004  Ebon Clements CAR 50575
.           Fixed I * D on letter history file
.           26/07/2004  Jill Habasque CAR 50428
.           Recompiled for WATTRETM
. V9.03.26  21/07/2004  Jill Habasque CAR 51922
.           Fixed update of bkreatim on update WL details screen
. V9.03.25  29/06/2004  Jill Habasque CAR 51180
.           Mods to pack NEWPROCC with spaces in setpar00
. V9.03.24  24/06/2004  Jill Habasque CAR 50995
.           Added GETCON00 - Get confirmation date from oprdetaf if blank
. V9.03.23  17/06/2004  Peter Vela    CAR 49016  July 2004 PRS/2
.           - Recompiled for PMSPX2TM
.           11/06/2004  Mike Laming   CAR 49016  July 2004 PRS/2      
.           - Add Sex Description routine SEXDSC00 with Code "R" - "Intersex"
. V9.03.22  08/04/2004 Jill Habasque CAR 34308
.           Added change PPP functionality
. V9.03.21  03/06/2004 Jill Habasque     CAR 50428
.           Recompiled for WATTRETM - clear of NRCDAYS
. V9.03.20  31/05/2004 Jill Habasque     CAR 50237
.           Added update of booking claim type
. V9.03.19  28/05/2004 Jill Habasque     CAR 50240
.           Recompiled for WLHISSUB
. V9.03.18  27/05/2004 Jill Habasque     CAR 49623
.           Fixed bkdiuniq for medical bookings
. V9.03.17  14/05/2004 Jill Habasque     CAR 49610
.           Fixed output of booking scheduled list
. V9.03.16  26/03/2004 Guomin Fu         CAR 44438
.           Recompiled for WATTRETM
.           25/03/2004 Ebon Clements     CAR 18703
.           Added transfer source validation
.           19/03/2004 Peter Vela        CAR 13038
.           Implemented DOCNM00 from PATDOCCD to use doctor name format 
.           parameter for sort lists.
. V9.03.15  09/04/2004 Ebon Clements     CAR 48097
.           Fixed pre admit clinic bugs
. V9.03.14  04/03/2004 Henry Son         CAR 39528
.           Show RFC Suspension to date on summary.
.           Re-compile WATTRETM.
. V9.03.13  01/03/2004 Peter Vela    CAR 46969
.           Made Procedure field (BKDIDES1) updateable from Update Waiting List
.           Entry (watweb0102003.html)
. V9.03.12  26/02/2004 Ebon Clements CAR 19968
.           Added Pre Admit clinics
. V9.03.11  18/12/2003 Guomin Fu     CAR 43419
.           Fixed to update WTTXPATM with BKREATIM when a booking is changed
. V9.03.10  17/12/2003 Guomin Fu     CAR 41096
.           Added "Insurance Declaration" field on Procedure Remove Screen
.           to allow user to capture the insurance status if the entry is
.           removed with Reason for Remove code "S".
. V9.03.09  15/12/2003 Peter Vela    CAR 45249
.           Recompiled for WATLETDF
.           10/11/2003 Ebon Clements CAT 44709 & 43862
.           Phase 2 booking contact screen mods
.           11/12/2003 Peter Vela    CAR 40355
.           Recompiled for PATNAMCD
. V9.03.08  10/10/2003 Jill Habasque CAR 43422
.           Recompiled for CLBOKRX1
. V9.03.07  03/10/2003 Jill Habasque CAR 43194
.           Added clear of WTHIHIDE
. V9.03.06  29/09/2003 Jill Habasque CAR 42833
.           Fixed write to bokdiaaf for multiple theatre bookings
. V9.03.05  13/08/2003 Peter Vela    CAR 41296
.           Fixed supervisor status function: when waiting list procedure
.           status is changed to unscheduled, the theatre booking corresponding
.           to it will be changed to cancelled, instead of deleted.
. ........  13/08/2003 Sylvek Litewka CAR 41293
.           Removed WEBSCHFD and WEBSCHIO includes. These are now included in
.           IBAWEBDF.PBL and IBAWEBCD.PBL.
. V9.03.04  21/07/2003 Ebon Clements CAR 20181
.           Changed UPDBOK00 to update the interpreter details
. V9.03.03  23/05/2003 Ebon Clements CAR 40610
.           Changed UPDWAT00 to write the 02 given certainty history record
. V9.03.02  02/06/2003 Jill Habasque SRF 23744
.           Recompiled for WATTRETM -calulation in OVRDT000  
. V9.03.01  08/05/2003 Jill Habasque SRF 38849
.           Recompiled for WATTRETM -display priority changes in wathis00
.----------------------------------------------------------------------
. V9.02.122 02/05/2003 Jill Habasque SRF 38623
.           Added call to GENBOKNO when unremoving
. V9.02.121 15/04/2003 Jill Habasque SRF 38267
.           Added call to LSTDAY00 in WATTAB00
. V9.02.120 10/04/2003 Jill Habasque SRF 22674
.           Added move of 01 to wtwmbscd when adding a medical booking
. V9.02.119 25/03/2003 Jill Habasque SRF 37524
.           Changed to use category ap instead of ADMISL00 routine
. V9.02.118 14/03/2003 Tracey Nguyen SRF 34880
.           Call PATFLD00 to display the correct colour for the patient folder.
.           Note: A call to PATFLD00 returns KEY3 which contains the folder
.                 colour code.
. V9.02.117 12/03/2003 Jill Habasque SRF 23436
.           Changed to save previous booking number for removed bookings
. V9.02.116 07/03/2003 Jill Habasque SRF 18400
.           Changed to not display RFC date if indefinitely NRFC
.           SRF 36738 Changed to remove nrfc days for overdue list
. V9.02.115 26/02/2003 Jill Habasque SRF 36744
.           Added output of contact 1 relationship
. V9.02.114 07/02/2003 Tonii CAR 35992
.           Recompiled for PATMISTM - inactive codes in patfundf
.           31/01/2003 Jill Habasque SRF 34660
.           Added move of one to NBRFLAG
. V9.02.113 29/01/2003 Tonii SRF 35630
.           Added new variable PRIOCODE to output the priority code in UNTTAB00
.           tag number 25
. V9.02.112 24/01/2003 Jill Habasque SRF 18400
.           Changed to find the latest RFC date
. V9.02.111 23/01/2003 Jill Habasque SRF 35598
.           Added clear of wattr022
. V9.02.110 03/12/2002 Jill Habasque SRF 23723
.           Added move of wattx026 to BKRECLMT when creating a booking  
. V9.02.109 29/11/2002 Jill Habasque SRF 23437
.           Added move of BKRECANC to WTHIBCAN when cancelling a booking
.           Added read of codes file before calculating overdue date
. V9.02.108 14/11/2002 Jill Habasque SRF 23985 
.           Fixed display of RFC status (added use of indicator 1 instead of   
.           hard coded to move in R)
. V9.02.107 04/11/2002 Jill Habasque SRF 23898 
.           Added check for admission date to date on list in supervisor screen
.           04/11/2002 Jill Habasque SRF 23638 
.           Changed to call RDBKDIA1 instead of RABKDIA1                       
. V9.02.106 28/10/2002 Jill Habasque SRF 23433 
.           Added new option to update the effective date on watcataf
.           31/10/2002 Jill Habasque SRF 23741 
.           Fixed bkrxodte when adding a medical booking              
. V9.02.105 23/10/2002 Jill Habasque SRF 23063
.           Recompiled for WATTRETM
. V9.02.104 09.10.2002  Peter Vela    SRF 17693
.           Recompiled for PATMISTM - Admitting Point
. V9.02.103 02.10.2002  Peter Vela    SRF 17693
.           Recompiled for WATTXITM
. V9.02.102 30.09.2002  Ebon Clements SRF 22581
.           Added CHKDEL00 so you can not remove a suspended patient.     
. V9.02.101 27.09.2002  Ebon Clements SRF 22614
.           Recompiled for WATTRETM - Unit display in history screen        
. V9.02.100 18.09.2002  Jill Habasque SRF 22417
.           Mods to not update bokrc1af if the cancellation reason is blank
.           on the supervisor screen                                         
. V9.02.99  18.09.2002  Jill Habasque SRF 20534
.           Recompiled for WATTRETM - Added new routine to calculate Days
.           ready for care (following last urgency change/increase)
. V9.02.98  03.09.2002  Jill Habasque 
.           Fixed download for extraction files
. V9.02.97  23.08.2002  Jill Habasque SRF 21353       
.           Removed reference to CWEBROOT
.           SRF 19705 Added output of NRFC flag            
. V9.02.96  20.08.2002  Jill Habasque SRF 20795       
.           Mods to removal if admitted to another hospital
. V9.02.95  16.08.2002  Jill Habasque SRF 20783       
.           Mods to allow take up bookings even if patient is removed       
. V9.02.94  14.08.2002  Jill Habasque SRF 20783       
.           Mods to take up for adding cancelled bookings                   
. V9.02.93  17.07.2002  Ebon Clements SRF 19055       
.           Changed XMLADM00 to not validate the procedure code and count
.           for bookings if you are using the theatre system.
. V9.02.92  09.07.2002  Ebon Clements SRF 17676       
.           Recompiled for WLHISSUB  
. V9.02.91  02.07.2002  Jill Habasque SRF 19116 18634
.           Added check for merged ur's in WATDET00                   
.           Added read of pmspx2af                                    
. V9.02.90  01.07.2002  Jill Habasque SRF 18800 
.           Added output of cancelled bookings on overdue list        
.           Added unremove option                                     
. V9.02.89  28.06.2002  Ebon Clements SRF 17676 17694 17700
.           Removed WRTHSS00 and changed to use standard write to the 
.           history file WRTHIS00.Added writes for non NBRS history data
.           WRTHSS00
.           27.06.2002  Jill Habasque SRF 19066 19064
.           Added transfer source on removal
.           Added update of booking number in supervisor screen
. V9.02.88  13.06.2002  Ebon Clements 8116       
.           Removed letter printing and added call to ADDWLT00 to print letter
. V9.02.87  14.06.2002  Jill Habasque SRF 18346
.           Added update of removal details if before seal date
. V9.02.86  12.06.2002  Jill Habasque            
.           Added delete of booking records
. V9.02.85  04.06.2002  Jill Habasque SRF 18156
.           Fixed COVER000 if NRFC indefinitely
. V9.02.84  03.06.2002  Jill Habasque SRF 18156
.           Mods to use new routine - NRCDF000 - Not ready for care 
.           including future - used to calculate overdue date
. V9.02.83  31.05.2002  Ebon Clements SRF 18229
.                       Added trap if sigpipe   
.           31.05.2002  Jill Habasque SRF 18112
.                       Added read of patcodes for cat TP before calling 
.                       COVER000 in WATUNS00
.                       SRF 18053
.                       Changed GETTHE00 to allow wmstat=3,4,or 5 
. V9.02.82  20.05.2002  Jill Habasque SRF 17618
.                       Recompiled for WATTRETM
. V9.02.81  07.05.2002  Ebon Clements
.                       Fixed CGI WATTR028 in MVWDET00 so it can be made blank
. V9.02.80  02.05.2002  Ebon Clements
.                       Set varibale URDIM before calling letter functions
.                       in ADDBOK00 and UPDBOK00
. V9.02.79  26.04.2002  Jill Habasque
.                       Recompiled for WATTRETM  (record lock in nrcday00)
. V9.02.78  24.04.2002  Pat Dirito
.                       Recompiled for NAMSTRCD  
. V9.02.77  21.04.2002  Jill Habasque  3596   
.                       Fixed All for WATUNS00   
. V9.02.76  19.04.2002  Pat Dirito            
.                       Recompiled for WATTRETM  
. V9.02.75  17.04.2002  Jill Habasque  3564
.                       Recompiled for WATTRETM  
. V9.02.74  15.04.2002  Jill Habasque
.                       Fixed unlock for wattr1af
. V9.02.73  08.04.2002  Ashwin
.                       Recompiled for WATTRETM
. V9.02.72  02.04.2002  Ebon Clements 
.                       Added next button functions to w/list by doctor and unit
. V9.02.71  28.03.2002  Ebon Clements 
.                       Added FILTPAST pre admission status filter
. V9.02.70  22.03.2002  Jill Habasque 
.                       Fixed ovrcd to branch to BOKTAB10 in BOKTAB00
. V9.02.69  21.03.2002  Ebon Clements 
.                       Fixed update of WTEXTLDT for waiting list extract
. V9.02.68  19.03.2002  Ebon Clements 3429
.                       Fixed format of letter variables
. V9.02.67  15.03.2002  Jill Habasque 2237
.                       Added GTPC0000 to calculate the days since last 
.                       category reassignment
. V9.02.66  08.03.2002  Ebon Clements
.                       Set variable BOOKNO before printing letters PWTLET00
. V9.02.65  05.03.2002  Jill Habasque 3348
.                       Recompiled for WATTRETM (LSTDAY00)
. V9.02.64  25.02.2002  Jill Habasque 
.                       Added report option 16, booking history 
. V9.02.63  22.02.2002  Jill Habasque 
.                       Mods for STV to allow backdated bookings
. V9.02.62  19.02.2002  Ebon Clements 
.                       Only display NRFC to date for STV if in the future
. V9.02.61  15.02.2002  B.G.Ackland
.                       Only Allow Unscheduled for Select Priority
. V9.02.60  15.02.2002  Ebon Clements 
.                       Change tag for the ready for care date. Only display
.                       if this date is in the future
. V9.02.59  08.02.2002  B.G.Ackland
.                       Conversion Tag to Return Matching WL Entry
. V9.02.58  08.02.2002  B.G.Ackland
.                       Fixed GOTO after Read on Booking File
. V9.02.57  08.02.2002  Pat Dirito  
.                       Moved RA on Booking file to approiate read prior to
.                       write in ADDBOK00. Added CGI Var NEWBOKNO
. V9.02.56  06.02.2002  Ebon Clements 
.                       Mods for waiting list history WTHIBMDT set      
. V9.02.55  05.02.2002  Ebon Clements 
.                       Added supervisor history update function        
. V9.02.54  01.02.2002  Ebon Clements 
.                       Recompiled for WLHISSUB - effective date mods
. V9.02.53  31.01.2002  Ebon Clements 
.                       Recompiled for WATTRETM - procedure history display
. V9.02.52  29.01.2002  Jill Habasque
.                       Added output of post op ward
. V9.02.51  24.01.2002  Ebon Clements
.                       Recompiled for WLHISSUB - effective date mods      
. V9.02.50  23.01.2002  Ebon Clements
.                       Recompiled for mods to WATTX1FD - new time fields
. V9.02.49  17.01.2002  Ebon Clements
.                       Do not allow suspend procedure if status is removed  
. V9.02.48  16.01.2002  Ebon Clements
.                       Added update of the booking details from the waiting
.                       list update routine if the status is scheduled and the
.                       booking ststus is booked
. V9.02.47  15.01.2002  Ebon Clements
.                       Recompiled for changes to WATTRETM history display      
. V9.02.46  15.01.2002  Ebon Clements
.                       Display Yes in the intended day case field not the code
.                       in the waiting list by doctor screens. WATTAB00
. V9.02.45  09.01.2002  Ebon Clements
.                       Recopiled for WATTR1FD and new WMSTAT     
. V9.02.44  08.01.2002  Ebon Clements
.                       Added option to change U/R of a procedure
. V9.02.43  03.01.2002  B.G.Ackland
.                       Fix Unscheduled Patient List
. V9.02.42  27.12.2001  Jill Habasque 
.                       Added write to visintaf (interpreter details)        
. V9.02.41  24.12.2001  Ebon Clements 
.                       Letter history should not save a reply date if the   
.                       reply reason is blank
. V9.02.40  24.12.2001  Ebon Clements 
.                       Changes for waiting list extract download - file name
. V9.02.39  20.12.2001  B.G.Ackland
.                       Fix Comments Update
. V9.02.38  20.12.2001  Ashwin
.                       Recompile for WATTX1TM and Add equipment reqd 3.
. V9.02.37  20.12.2001  Ebon Clements 
.                       Added error to Waiting list by date for invalid   
.                       doctor / unit combination
. V9.02.36  20.12.2001  Ebon Clements 
.                       Fixed update of short notice code on update screen  
.                       MVWDET00 to allow update of WMNOTICE with SP70
. V9.02.35  10.12.2001  Ebon Clements 
.                       Added proposed procedure date to w/list by unit      
.                       Added error to stop bookings for inactive doctors
.                       Set BKRXCNDT with cgi not todays date in add booking
.                       Set WTTXPATM with BKREATIM when a booking is made
. V9.02.34  07.12.2001  Ebon Clements 
.                       Recompiled for BOKRX1TM - ward selection lists       
.                       Added overlap date checks to suspensions
. V9.02.33  06.12.2001  Ebon Clements 
.                       Added Intended day case WTTXIDYC to w/list by doctor
. V9.02.32  03.12.2001  Ebon Clements 
.                       Allow bookings if after NRFC date 
.                       Steve Armstrong
.                       Moved call to DGCLICUB until after wattr1af update.
. V9.02.31  27.11.2001  B.G.Ackland
.                       Unscheduled Patient Table Output
.
. V9.02.30  27.11.2001  Ebon Clements 
.                       On all waiting lists if not ready for care overdue
.                       date should be blank. Cat VL indicator 4 is not a R
. V9.02.29  22.11.2001  B.G.Ackland
.                       ESIS History File
.
. V9.02.28  22.11.2001  Ashwin,Sai
.                       Add Overdue date and Preadmission status column and 
.                       correct calculation of category reassignment and include
.                       flag for interpreter
. V9.02.27  16.11.2001  B.G.Ackland
.                       Fix Letter Audit Dates
.                       Filter Confirmations
. V9.02.26  15.11.2001  B.G.Ackland
.                       Waiting List Defects
.                       Fix Update of W/L History
.
. V9.02.25  14.11.2001  B.G.Ackland
.                       Added Schedule/Unschedule Search Page
. V9.02.24  13.11.2001  Raghunandan Surve - HPS
.                       Changed to read referring hospital
. V9.02.23  10.11.2001  Raghunandan Surve - HPS
.                       Changed to display Proposed Opeartion Date
. V9.02.22  08.11.2001  Mike Laming (oops)
.                       Correct DG Cancel Waiting list call DGCLICWC (was   
.                       coded as DGCLICWA).
. V9.02.21  30.10.2001  Ashwin
.                       Change booking status code when Unit/Status changed,
.                       Dont allow to update Waiting list when patient removed
. V9.02.20  24.10.2001  B.G.Ackland
.                       Must have a Doctor Code for List by Doctor
. V9.02.19  23.10.2001  Ashwin - HPS
.                       Fixed for Overdue date display,Ready for care display,
.                       Fixed Suspend,Remove procedures not to function from
.                       menu drop down if patient removed,Removed Performed and
.                       Not Performed
. V9.02.18  19.10.2001  B.G.Ackland
.                       Changes to Enable Letters to be Generated from 
.                       Unix Command (Using VCQ)
.                       Append casekey to redirect to enable link to 
.                       Booking page from Add Procedure
. V9.02.17  10.10.2001  Ashwin - HPS
.                       Fixed for RFC status to change after NRFC days are over
. V9.02.16  04.10.2001  Ashwin - HPS
.                       Fixed for not allowing a waiting list booking if NRFC
. V9.02.15  02.10.2001  Ashwin - HPS
.                       Fixed for proper display of all fields in enquiry screen
.                       Fixed for proper updation of the Category and RFC status
. V9.02.14  01.10.2001  Ebon Clements  
.                       Fixed ward bed selection list descriptions             
. V9.02.13  26.09.2001  Ashwin - HPS
.                       Fixed for updation of Listing status in Suspension File
.                       Fixed for Procedure,Forms in add booking
. V9.02.12  24.09.2001  Rahul Gupta - HPS
.                       Logic changed for Filter listing status
.                       Added History Routine while Deleting Booking  
. V9.02.11  21.09.2001  Rahul Gupta - HPS
.                       Clearing Booking Extension Variables 
. V9.02.10  19.09.2001  Rahul Gupta - HPS
.                       Added for Displaying the correct Category
.                       Reassignment (WATTAB00)
. V9.02.09  14.09.2001  Mike Laming   RCH/SVHM
.           Activate Datagate API (see below V9.02.03)             
. V9.02.08  13.09.2001  Rahul Gupta - HPS
.                       Checked for spaces for Extract Date Field.
. V9.02.07  10.09.2001  Brian & Rahul  - HPS
.                       Changed for Waiting List Extract.
.                       Changed for Unscheduled waiting List Suspension  
. V9.02.06  10.09.2001  Kuldeep - HPS
.                       Error message changed for waiting list for doctor
. V9.02.05  08/09/2001  Rahul Gupta
.           Added for Displaying the Cancellation  (oATTAB00) 
. V9.02.04  06/09/2001  Rahul Gupta 
.           Recompiled for WATTRETM
. V9.02.03  04/09/2001  Mike Laming  RCH/SVHM
.           Add Datagate APIs Cancel Booking        (DGCLICCB)
.                             Pre-Admission Booking (DGCLICUB)
.                             Put Patient on Waiting List (DGCLICWA)
.                             Cancel Waiting List   (DGCLICWC)
. V9.02.02  27.08.2001 Ebon Clements 
.           Added PMSPX2FD,PMSVX1FD,BOKRC1FD and BOKRX1FD variables to letters
.           and print waiting list letters from booking screens
. V9.02.01  21.08.2001 HPS 
.           Changed UPDSUS00 & ADDSUS00 for Validate Suspension Date
. V9.01.02  16.08.2001 J.Tan
.           Recompiled for PATMASTM
. V9.01.01  14.08.2001 J.Tan
.           Recompiled for PATMASTM
. V9.00.03  09.08.2001 Dean Cramer   
.           Recompiled for changes to NRCDAY00 : 
.           Correct Read/Lock on wrong file.                     
. V9.00.02  08.08.2001 Dean Cramer   
.           Recompiled for changes to NRCDAY00 :                    
.           Changed TCINDC4 to TCINDC1.
.           Changed Update and unlock of the treatment file - wattr1af (wrong)
.           to work on the extention file - wattx1af (correct).
. V9.00.01  30.07.2001 Jill Habasque
.           Added PRIN0000 to allow printing of waiting list letters
. V9.00.B13 27.07.2001 HPS
.           Fixed the Letter Print Bug
. V9.00.B12 27.07.2001 HPS
.           Defect Fixing
. V9.00.B11 26.07.2001 HPS Bangalore
.           Defect Fixing
. V9.00.B10 25.07.2001 HPS Bangalore
.           Defect Fixing
. V9.00.B09 13.07.2001 Sandra Barcham
.           Replace GP with HCP
. V9.00.B08 11.07.2001 Hps
.           Worked On  Procedure Add 
. V9.00.B06 09.07.2001 Hps 
.           Fixed Pre-Admission Comments
. V9.00.B05 04.07.2001 Ebon Clements 
.           Worked on make medical booking and add - update procedure details 
. V9.00.B04 28.06.2001 Ebon Clements 
.           Worked on supervisor screen and history detail processing         
. V9.00.B03 14.06.2001 B.G.Ackland
.           Recompile for Changes to PATMASTM
. V9.00.B02 29.05.2001 Ebon Clements 
.           Made changes to report 1 waiting list tables for doctor / unit    
.           as per specification. Added new filters and outputs
.           Changed report 3 for waiting list by date as per specification
.----------------------------------------------------------------------
. V5.09.B03 15.01.2001 Bronko Sosic  
.           Recompiled for PATMASTM                  
. V5.09.B02 27.12.2000 Pat Dirito    
.           Recompiled for IBAWEBCD & UPDUR          
. V5.09.01  15.09.2000 Sandra Barcham
.           Replace RSHCONFD with WEBCONFD
.------------------------------------------------------------
. V5.08.04  05/09/2000  Tonii
.           Mods to accept Unknown and Indeterminate as valid
.           patient sex description
. V5.08.03  01/09/2000  Katie Nelson 
.           Set booking status to "0" when adding a booking
. V5.08.02  16/08/2000  Caleb Sharman
.           Changed Health Fund variables to be 8 chars
.------------------------------------------------------------
. V5.07.05  07/06/2000 Pat Dirito     
.           Added RUNEXT00 execution of Waiting List Extract
.           & Patient Extract Maintenance 
.           Added Option 9 Download Waiting List Extract
. V5.07.04  02/02/2000 Steven Watkins
.           Recompiled for PATMASTM / PATMISTM
. V5.07.03  20.01.2000  B.G.Ackland
.           Recompiled for PATMASTM
. V5.07.02  20.12.1999  K.C Nelson
.           Recompiled for IBAWEBDF/IBAWEBCD 
. V5.07.01  03.11.1999  K.C Nelson
.           Recompiled for DAOFWEK 
. V5.07.00  19.08.1999  K.C Nelson
.           Display Patient Rank in Waiting List Table
.           Change table cell bgcolor to class             
.------------------------------------------------------------
          INC       IBAWEBDF    
          INC       WEBDATDF
          INC       RSHWEBDF
          INC       VISCMTDF
.
          INC       PATCLMTD/INC
          INC       ACCAUDFD/INC        * New ACC Audit file
          INC       ACCDIAFD/INC        * AE Diagnosis
          INC       ALLCONFD/INC
          INC       ALLDIAFD/INC        * Allied Health Diagnosis Code
          INC       ALLREFFD/INC
          INC       ALLWLNFD/INC
          INC       APSMASFD/INC
          INC       BOKCNFFD/INC
          INC       CASSTYFD/INC
          INC       CASAMEFD/INC
          INC       COMERHFD/INC
          INC       DISMASFD/INC
          INC       DISPATFD/INC
          INC       DISPTLFD/INC
          INC       EMRVISFD/INC
          INC       EMRICDFD/INC        AE Diagnosis Codes
          INC       OPRCONFD/INC
          INC       OUTSITFD/INC
          INC       BOKRC1FD/INC
          INC       BOKDIAFD/INC
          INC       IBALPCFD/INC
          INC       MLTHCPFD/INC
          INC       MRTMASFD/INC
          INC       OPRDEAFD/INC
          INC       OUTBB1FD/INC
          INC       OUTBOAFD/INC
          INC       OUTCANFD/INC
          INC       OUTCONFD/INC        * Outpatient System Parameters
          INC       OUTMA1FD/INC        * Session Master file
          INC       OUTRSHFD/INC        * Referral List
          INC       BOKUNQFD/INC
          INC       PATALRFD/INC
          INC       PATATRFD/INC
          INC       PATATRTD/INC
          INC       PATASFFD/INC
          INC       PATCMCFD/INC
          INC       VISMDTFD/INC
          INC       VISMTXFD/INC
          INC       PMSUCHFD/INC
          INC       PMSUCDFD/INC
          INC       PATMASTD/INC
          INC       PATCONFD/INC
          INC       PATDADFD/INC
          INC       PATDO1FD/INC
          INC       PATDGWFD/INC
          INC       PATEORFD/INC
          INC       PATRE1FD/INC
          INC       PATFN1FD/INC
          INC       PATHSPFD/INC
          INC       PMSAIDFD/INC
          INC       MLTSECFD/INC
.
          INC       PMSCCDFD/INC   * Concession Card Details
          INC       PMSCEXFD/INC
          INC       PMSEXTFD/INC
          INC       PMSEXTTD/INC
          INC       PMSHCPFD/INC
          INC       PMSTMDFD/INC
          INC       PMSHCGFD/INC
          INC       PATIN1FD/INC
          INC       PATMI1FD/INC
          INC       PATICOFD/INC
          INC       PATMA1FD/INC
          INC       PATMRGFD/INC
          INC       PATNIDFD/INC
          INC       PMSPX2FD/INC
          INC       PMSPX2TD/INC
          INC       PATDHEAD/INC
          INC       PATPR1FD/INC
          INC       PATWR1FD/INC
          INC       PATONLFD/INC
          INC       PATTRNFD/INC
          INC       PATVISFD/INC
          INC       PATWMAFD/INC
          INC       PATWVEFD/INC
          INC       PATWC1FD/INC
          INC       PMSARQFD/INC
          INC       PMSAMNFD/INC
          INC       PMSARVFD/INC
          INC       PMSCTCFD/INC
          INC       PMSOOSFD/INC
          INC       PMSWX1FD/INC
          INC       VISINTFD/INC
          INC       VISIAUFD/INC
          INC       PMSVX1FD/INC
          INC       VISCMTFD/INC
          INC       WATCONFD/INC
          INC       WATCATFD/INC
          INC       WATCHAFD/INC
          INC       WATEXTFD/INC
          INC       WATLETFD/INC
          INC       WATHISFD/INC
          INC       WATMHDFD/INC
          INC       WATMTXFD/INC
          INC       WATSUSFD/INC
          INC       WATLHIFD/INC
          INC       WATMESFD/INC
          INC       WATPROFD/INC
          INC       WATPHIFD/INC
          INC       WATRTDFD/INC
          INC       WATTR1FD/INC
          INC       WATESPFD/INC
          INC       WATESEFD/INC
          INC       WATESNFD/INC
          INC       WATVWLFD/INC
          INC       WATNBRFD/INC
          INC       PATCALAG/INC
          INC       WATEPSFD/INC
          INC       WATEXAFD/INC
          INC       WATEXBFD/INC
          INC       WATEXCFD/INC
          INC       WATEXDFD/INC
          INC       BOKRX1FD/INC
          INC       WATTX1FD/INC
          INC       WATPACFD/INC
          INC       WATESIFD/INC
          INC       WATESTFD/INC
.
          INC       BOKCNFTD/INC
          INC       WATTX1TD/INC
          INC       BOKRX1TD/INC
          INC       PMSHCGTD/INC
          INC       PMSHCPTD/INC
          INC       OPREXPFD/INC 
          INC       PATDSCFD/INC
          INC       OPRMBSFD/INC
          INC       OPRNURFD/INC
          INC       OPRSESFD/INC            * HPS Code
          INC       OPRDPHFD/INC            * HPS Code
          INC       OPROPRFD/INC            * HPS Code
          INC       OPRPRFFD/INC            * HPS Code
          INC       OPRSRGFD/INC            * HPS Code
          INC       OPRDEDFD/INC            * HPS Code
          INC       PATITMFD/INC            * HPS Code
          INC       PATVADFD/INC
          INC       NHIMASFD/INC
          INC       NHIETHFD/INC
          INC       PMSDUNFD/INC
          INC       WATPNPFD/INC
          INC       WATHISTD/INC
          INC       WATLPCFD/INC
          INC       WATOPAFD/INC
          INC       WATOPSFD/INC
          INC       TFILEVAR/INC
          INC       PATMISTD/INC
          INC       PMSBRQFD/INC
          INC       ACCLODFD/INC
.
. *** letter printing variables ***
.
ACCPORDN  DIM       20
ADMREQNO  DIM       10
ALLWFLAG  FORM      1
ALLCOMM   FORM      1
BATCHNUM  DIM       5        * NBRS Batch Number
BLNKFLAG  FORM      1
BRSRCAT   DIM       3
BLNKBOOK  DIM       1
BOOKDATE  DIM       8
BOOKTIME  DIM       5
BOOKWARD  DIM       3
BOOKEBED  DIM       3
BMIINDIC  DIM       1
PCOMFLAG  FORM      1
CHECKGP   FORM      1
CHGFDAT   FORM      1
CHGTDAT   FORM      1
CHGSUSV   FORM      3
CLINICAL  DIM       1
CONFARRY  DIM       8[99]
DISPVAR1  DIM       127
DISPVAR2  DIM       127
LASTITEM  FORM      3
.IBAMFLAG  FORM      1
.CISMFLAG  FORM      1
LINECNTR  FORM      3
DISPT001  DIM       9
DISPT002  DIM       20
DISPDAT1  DIM       11
DISPDAT2  DIM       11
DISPOVAL  DIM       127
DISPREAS  DIM       20
DISPCVAL  DIM       127
WAHVIEW   FORM      1
WLKEYCNT  FORM      3       * Count of WL Keys
WLKEYEND  FORM      3       * Count of WL Keys
WLTYCODE  DIM       1
WATTRKEY  DIM       19
DEFTURNO  DIM       8
DEFTVIEW  FORM      1
DISPLYAT  INIT      "at"
DONTPRIN  FORM      1
GPCODE    DIM       10
LABELTYP  DIM       11
JULDAYST  FORM      4
JULYRST   FORM      2
JULCCST   FORM      2
KEY3A     DIM       3
TESTDATE  DIM       8
ERRORDAT  FORM      1
EREFRLID  DIM       20
ESISKEYS  DIM       16
FRMTDATE  DIM       12
LISTLIMT  FORM      5
NEWPROCC  DIM       9
NOONLOAD  FORM      1
NOTEFILT  DIM       3
NOTEORDR  FORM      1
NOTETYPE  DIM       3
NOTENUMB  DIM       6
OLDPROC   DIM       9
OLDKEY28  DIM       28
OLDKEY31  DIM       31
OLDURNO   DIM       8
OLDVAL01  DIM       80
OLDVAL02  DIM       80
OLDVAL07  DIM       80
OLDVAL09  DIM       80
OLDVAL13  DIM       8
OLDVAL15  DIM       80
OLDVAL17  DIM       3
PATIENTL  DIM       1
PROCDESC  DIM       86
PRPBDESC  DIM       20
REASFC01  DIM       3
REASFC02  DIM       3
REASFC05  DIM       3
REASFC07  DIM       3
REASFC09  DIM       3
REASFC13  DIM       3
REASFC14  DIM       3
REASFC15  DIM       3
REASFC17  DIM       3
REFRLVIS  DIM       8
SAVVDAT1  DIM       8
SAVVDAT2  DIM       8
SAVDATE8  DIM       8
SAVKEY8   DIM       8
SAVKEY18  DIM       18                                                 *I-60140
SAVKEY28  DIM       28
SAVKEY29  DIM       29
SAVKEY31  DIM       31
SAVKEY36  DIM       36
SAVELSTS  DIM       3
SAVTXWRD  DIM       3
SAVWMBOK  DIM       8
SERBFLAG  DIM       1
STRIKETG  DIM       10
STRENDTG  DIM       11
SWTEADAT  DIM       8
SWTEINSD  DIM       3
SWTEREMD  DIM       8
SWTERREM  DIM       3
SWTERADT  DIM       8
SUPRFLAG  DIM       1
SVNOTICE  DIM       3
SVWMSRCR  DIM       3
SVTXPOWD  DIM       3
SVTXINTD  DIM       3
SVTXCTYP  DIM       3
SVWMDOCT  DIM       10
UPDTESIS  DIM       1    * 1 = dont update esis
UPDFLD01  DIM       2
UPDFLD02  DIM       2
UPDFLD05  DIM       2
UPDFLD07  DIM       2
UPDFLD09  DIM       2
UPDFLD13  DIM       2
UPTYDESC  DIM       55
FORM2P1   FORM      2.1
FORM2P1A  FORM      2.1
FORM4P2   FORM      4.2
FORM6     FORM      6
FORM6A    FORM      6
FORM6P1   FORM      6.1
FORM6P1A  FORM      6.1
FORM5     FORM      5
FORM3     FORM      3
FLTRDATE  FORM      1
SRCHSNAM  DIM       20
SRCHGNAM  DIM       20
REASONFC  DIM       3
RECCNT    FORM      3
RECCOUNT  FORM      8
DRECCNT   DIM       3
UPDSUS01  INIT      "0"
URRFCDAY  FORM      5
TODAYDTE  DIM       8
TAKEUPFL  FORM      1
TAKEBSTA  DIM       1
DESCDAYC  DIM       3
DONEFLAG  FORM      1
DIM3      DIM       3
DIM4      DIM       4
DOCERROR  FORM      1
INTAUDTY  DIM       1
INTSDESC  DIM       25
LETTER    DIM       3
LETCOUNT  FORM      1
LETTER01  DIM       1
LETTER02  DIM       1
LETTER03  DIM       1
LETTFORM  FORM      3
LINK2PRT  FORM      1
LSNRFCRE  FORM      5
NEW       DIM       19                      * new ur and count
NEWBOKNO  DIM       8                       * Using converted booking number
NEWCNT    FORM      2                       * the new count
NEWCND    DIM       2
NEWURNUM  DIM       8                       * new ur number
NRFCDAYS  FORM      5
CANCELRM  FORM      1
CATCHGFL  FORM      1
CATTC     INIT      "tc"
CONTTYPE  DIM       1
CURRDATE  DIM       8
CURRDATX  DIM       8
SHRTNFLG  FORM      1
SUSPNCNT  DIM       2
ERRORFLG  FORM      1
NOOFDAYS  FORM      3
NMPNUMB   DIM       20
OLD       DIM       19                      * old ur and count
OURNO     DIM       8                       * old ur number
SAVINDC3  DIM       1
SAVWMCNT  FORM      2          * save var for old count
SAVWCNTD  DIM       2
SAVWMCND  DIM       2
SAVTREAT  DIM       8
STATNCOD  DIM       6
SUBSYSKY  DIM       50
FREETXT1  DIM       40
FREETXT2  DIM       40
FREETXT3  DIM       40
FREETXT4  DIM       40
FREETXT5  DIM       40
FREETXT6  DIM       40
FREETXT7  DIM       40
FIRSTBOK  DIM       1
.
ADDSECND  FORM      1
ADMCOMTS  FORM      1
ANLTYPE   DIM       3
ANLMEAS   DIM       3
ATYPDESC  DIM       25
BTYPDESC  DIM       25
CTYPDESC  DIM       25
CURDATE   DIM       8
CLURCTDT  DIM       8
CANBFLAG  FORM      1
CRTDAYS   FORM      5
NOTCDESC  DIM       25
CALDAYS   FORM      4
DATACHNG  FORM      1                                                  *I-40489
DATE1     FORM      8
DATE2     FORM      8
DATE3     FORM      8
DATE4     FORM      8
DATE5     FORM      8
DATEC     DIM       8
DATECF    FORM      8
OVERDATE  DATE      8
PRIODATE  DATE      8
XMLDATE1  DIM       8
XMLDATE2  DIM       8
XMLCODE1  FORM      1
PROCCODE  DIM       9
PTHVFLAG  FORM      1
TMDDOCTF  DIM       1                       * transfer source code
TRNSCODE  DIM       5                       * transfer source code
TRNSDATE  DIM       8                       * transfer source date
.
HOSPOST   FORM      2
NODAYS    FORM      5
NOATTRIB  FORM      1
UNITPOST  FORM      2                       * HPS ADDED 5/06/01
PATPOST   FORM      2                       * HPS ADDED 5/06/01
.
TODAY     DIM       8
NRDYCODE  DIM       3
NRDYCARE  FORM      1
MBSDESC   DIM       40
MRGEFLAG  FORM      1
MRGECOUNT FORM      2
SAVEURNO  DIM       8
DISPSUR   DIM       8                          * Display Saved U/R Number
DISPMUR   DIM       8                          * Display Merged U/R Number
SAVEFDAT  DIM       8
SAVETDAT  DIM       8
PRIORCC   DIM       3
PRIORITY  DIM       3
LSTDAYS   FORM      5
NRCDAYS   FORM      5
URGDAYS   FORM      5
RFCDAYS   FORM      5
DSPDATE   DIM       8
DATESUS   DATE      8
CATASSGN  FORM      5
.
CASEKEYS  DIM       26
INVCASEK  DIM       23
USEINVAD  FORM      1
NEWCASEK  DIM       23
SESSKEYS  DIM       22
SAVCODE   DIM       3
PATTITLE  DIM       4       * Title
PATSNAME  DIM       20      * Surname
PATGNAME  DIM       25      * Given Name
PATADDR1  DIM       25      * Address Line 1
PATADDR2  DIM       25      * Address Line 2
PATADDR3  DIM       15      * Address Line 3
PATPOSTC  DIM       4       * Post Code
PATBUSPH  DIM       12      * Phone Business
PATHOMPH  DIM       12      * Phone Private
PATGENDE  DIM       1       * Gender M or F
PATMSTAT  DIM       3       * Marital Status
PATBIRDT  DIM       11      * Date of Birth DD MMM YYYY
PATCOBIR  DIM       3       * Country of Birth
PATRELIG  DIM       3       * Religon
PATRSTAT  DIM       3       * Resident Status
PATOCCUP  DIM       14      * Occupation
PATMEDIC  DIM       10      * Medicare Number
PATPENSI  DIM       15      * Pension Number
PATPENEX  DIM       4       * Pension Expiry
PATHFUND  DIM       6       * Health Fund
PATPAYOR  DIM       9       * Payor (Health Fund 6, Claim Code 3)
PATADMDT  DIM       11      * Date of Admission DD MMM YYYY
PATCLAIM  DIM       3       * Claim Code
VSCMTFLG  FORM      1
VSCMTLIN  FORM      3
VSTXUNIQ  FORM      3
QRYDATA1  DIM       240
.
. Details for New Booking
.-------------------------
OPEREXPD  FORM      4       * Expected Duration (min)
OPERANAE  DIM       3       * Anaesthetic Code (Cat. OA )
OPERTYPE  DIM       3       * Operation Type   (Cat. OY )
OPERTRAN  DIM       3       * Transport Code   (Cat. OR )
OPERUSR1  DIM       3       * User Defined 1 (Category Y6)
OPERUSR2  DIM       3       *              2 (Category Y7)
OPERUSR3  DIM       3       *              3 (Category Y8)
OPERUSR4  DIM       3       *              4 (Category Y9)
OPERPRV1  DIM       9       * Provisional item # 1 ( MBS or ICD9)
OPERPRV2  DIM       9       * Provisional item # 2 ( MBS or ICD9)
OPERPRV3  DIM       9       * Provisional item # 3 ( MBS or ICD9)
OPERPRV4  DIM       9       * Provisional item # 4 ( MBS or ICD9)
OPERPRV5  DIM       9       * Provisional item # 5 ( MBS or ICD9)
OPERPRV6  DIM       9       * Provisional item # 6 ( MBS or ICD9)
OPERPRV7  DIM       9       * Provisional item # 7 ( MBS or ICD9)
OPERPRV8  DIM       9       * Provisional item # 8 ( MBS or ICD9)
OPERPRV9  DIM       9       * Provisional item # 9 ( MBS or ICD9)
OPERPR10  DIM       9       * Provisional item # 10( MBS or ICD9)
OPERPR11  DIM       9       * Provisional item # 11( MBS or ICD9)
OPERPR12  DIM       9       * Provisional item # 12( MBS or ICD9)
OPERPR13  DIM       9       * Provisional item # 13( MBS or ICD9)
OPERPR14  DIM       9       * Provisional item # 14( MBS or ICD9)
OPERPR15  DIM       9       * Provisional item # 15( MBS or ICD9)
OPERPR16  DIM       9       * Provisional item # 16( MBS or ICD9)
OPERPR17  DIM       9       * Provisional item # 17( MBS or ICD9)
OPERPR18  DIM       9       * Provisional item # 18( MBS or ICD9)
OPERPR19  DIM       9       * Provisional item # 19( MBS or ICD9)
OPERPR20  DIM       9       * Provisional item # 20( MBS or ICD9)
OPERPR21  DIM       9       * Provisional item # 21( MBS or ICD9)
OPERPR22  DIM       9       * Provisional item # 22( MBS or ICD9)
OPERPR23  DIM       9       * Provisional item # 23( MBS or ICD9)
OPERPR24  DIM       9       * Provisional item # 24( MBS or ICD9)
OPERPR25  DIM       9       * Provisional item # 25( MBS or ICD9)
OPERPR26  DIM       9       * Provisional item # 26( MBS or ICD9)
OPERPR27  DIM       9       * Provisional item # 27( MBS or ICD9)
OPERPR28  DIM       9       * Provisional item # 28( MBS or ICD9)
OPERPR29  DIM       9       * Provisional item # 29( MBS or ICD9)
OPERPR30  DIM       9       * Provisional item # 30( MBS or ICD9)
.
OPERDES1  DIM       80      * Operation description line 1
OPERDES2  DIM       80      *                            2
OPERDES3  DIM       80      *                            3
OPERCOMM  DIM       40      * Comments
OPERCANC  DIM       3       * Cancellation Code (Category SC)
OPERTHET  DIM       6       * Operating Room Code
OPERKNOW  DIM       3       * Known Infection (Category OK)
OPERPREF  DIM       9       * Doctors Operation Preference
OPCOMTYP  DIM       3
.
.  Variable Declarations
. 
BKREC001  DIM       20       20       17  Surname
BKREC002  DIM       6         6       39  Attending Doctor
BKREC003  DIM       6         6       45  Referring Doctor
BKREC004  DIM       12        8       51  Expected due date (CCYYMMDD)
BKREC005  DIM       8         8       59  Expected assessment time
BKREC006  DIM       12        8       67  Pre-assessment date
BKREC007  DIM       8         8       75  Pre-assessment time
BKREC008  DIM       3         3       91  Booking type (Cat "BK")
BKREC009  DIM       3         3       94  Cancellation reason (Cat "BC")
BKREC010  DIM       1         1       99  Benefit fund member (Y/N/U)
BKREC011  DIM       1         1      100  Previous inpatient (Y/N/U)
BKREC012  DIM       3         3      101  Preferred accommodation (Cat BP)
BKREC013  DIM       9         9      104  Waiting list procedure code
BKREC014  DIM       2         2      113  Waiting list procedure count
BKREC015  DIM       3         3      115  Expected ward
BKREC016  DIM       8         5      118  Maternity admission number
BKREC017  DIM       1         1      123  Deposit paid (Y/N) Matern only
BKREC018  DIM       3         3      124  Expected bed
BKREC019  DIM       3         3      127  Patient Cat./Adm Class. (Cat P)
BKREC020  DIM       3         3      130  Adm Type/Pat. Class (Cat A)
BKREC021  DIM       3         3      133  Department (Cat AC)
BKREC022  DIM       6         6      136  Associated Doctor    
BKREC023  DIM       3         3      142  Claim type (Cat CL)  
BKREC024  DIM       10        10     145  Referring GP
BKREC025  DIM       6         6      155  GP Practice code
BKREC026  DIM       20        20     161  GPFH Approval Number
BKREC027  DIM       3         3      181  Resident Status (Cat T)
BKREC028  DIM       3         3      184  Elective Admission Type  (Cat CC)
BKREC029  DIM       20        20     187  ECR Approval Number
BKREC030  DIM       2         2      207  GP Practice count
BKREC031  DIM       3         3      209  District of Residence (Cat DA)
BKREC032  DIM       4         4      212  Operator who made I/P Booking
BKREC033  DIM       3         3      216  Expected Length of Stay (Days)
BKREC034  DIM       12        12     219  Booking date (ccyymmdd)
BKREC035  DIM       9           9      9  Diagnosis code
BKREC036  DIM       80         80     18  Diagnosis description 1
BKREC037  DIM       80         80     68  Diagnosis description 2
BKREC038  DIM       40         40    118  Booking comments
BKREC039  DIM       12         12    Date Procedure booked for (Take up)
.
CURRADMN  DIM       8
DIM8      DIM       8
DIM8A     DIM       8
FIRSTREC  FORM      1
SAVHRANK  FORM      6
.
. New CGI variables 
.
CATECODE  DIM       3                  * Filter for category CAT TP
LISTCODE  DIM       3                  * Filter for Listing Status CAT VL
INTENDST  DIM       3                  * Filter for Intended Stay  CAT VI
OVRDCODE  DIM       1                  * Overdue patients only 
AIHWREPT  DIM       1                  * AIHW Reportable
INTDHOSP  DIM       3                  * Intended hospital
ADMPOINT  DIM       3                  * Filter for admission point
INTDAYCS  DIM       3                  * Filter for day case CAT XB
.
ADMISNID  DIM       20
BOOKSTAT  DIM       13
EMPTDOCT  DIM       1
ENDDTE    DIM       8
EFFCDATE  DIM       8
FIXBOKNO  DIM       8
GENPNAME  DIM       25
FILENAMA  DIM       8
FILTDOCT  DIM       6
HOUR      DIM       2
SAVDATEL  DIM       8
SUSPKEYS  DIM       21
HISTKEYS  DIM       30
PHISTKEY  DIM       31
NEWCOUNT  FORM      6
STATCODE  DIM       1
SAVSCODE  FORM      1
FILTPAST  DIM       3
UNITCODE  DIM       3
UNITCOD2  DIM       1
UNITCOD1  DIM       3
FLTSHORT  DIM       3
REMSTATS  DIM       3
HOURTM    DIM       2
ADMPDESC  DIM       25
UNITDESC  DIM       25
MIN       DIM       2
MINTIME   DIM       2
NEWEFFDT  DIM       8
NEWPCODF  DIM       3
NEWPCODT  DIM       3
PRIODESC  DIM       25
REMRDESC  DIM       25
HLREASON  DIM       1
PRIOCODE  DIM       3
PRIOSTAT  DIM       25
PRIOOVER  DIM       8
PREVID01  DIM       9
PREVTT01  DIM       4
SEC       DIM       2
SECTIME   DIM       2
OVRDAT01  DIM       8
OVERSTAT  DIM       1
SRCRDESC  DIM       25
UPDTTYPE  DIM       1
UPDATEKY  DIM       22
AUDIFLAG  FORM      1
LINKTYPE  FORM      1
LISTSTAT  FORM      1
FORM8     FORM      8
SAVLIST   DIM       3
SAVEEVAL  DIM       20
SHOWCOMM  FORM      1
SHOWHIDD  FORM      1
SHOCNSNT  FORM      1
SWMUDEF1  DIM       3
SWMUDEF2  DIM       3
SWMUDEF3  DIM       3
SWMUDEF4  DIM       3
SWMUDEF5  DIM       3
SWMUDEF6  DIM       3
SWMUDEF7  DIM       3
SWMUDEF8  DIM       3
SWTWMDRS  DIM       3
SWTWMDOS  DIM       3
SWTWMPHS  DIM       3
UNIQUEID  DIM       9
WABKHIST  FORM      1
.
DOCTTYPE  DIM       3
DOCTCODE  DIM       6
DFLTWARD  DIM       3
.
NEXTPAGE  DIM       1      * Nextpage parameter CGI parameter
NEXTDKEY  DIM       32     * Next Record Key for sort table next button
NEXTUKEY  DIM       31     * Next Record Key for sort table next button
LETTREQD  FORM      1      * Print letter flag
TEAMNUMB  DIM       1      * Teamnumber HPS Code
NURSCODE  DIM       6      * Nurse Code HPS Code  
RFCSTAT   DIM       3      * RFC Status Code
VISFOUND  FORM      1
.
WTMEEND   FORM      2
WTPAEND   FORM      2
WATTFLAG  FORM      1
INTRFLAG  DIM       1
.WATTRCOM  DIM       70[99]                Comments 
.
COMFILNM  DIM       8
COMFILNW  DIM       8
COMFILPR  INIT      "COMFIL"
COMFILPW  INIT      "WATCOM"
COMFILAF  FILE      ASCII, FIXED=127
COMFILWF  FILE      ASCII, FIXED=127        * For visit Notes
.
.WTPACCOM  DIM       70[99]  * Pre-Admission Comments 
.
COMPRENM  DIM       8
COMPREPR  INIT      "COMPRE"
COMPREAF  FILE      ASCII, FIXED=127
.
COMVISAF  FILE      ASCII, FIXED=127
COMVISNM  DIM       8
.
WATEP001  DIM       4       * Extract ID
WATEP002  DIM       8       * U/R Number
WATEP003  DIM       9       * Procedure 
WATEP004  DIM       2       * Count
WATEP005  DIM       1       * Deleted From Extract
.
WATTR001  DIM       9       9       Procedure Code
WATTR002  DIM       5       **      Procedure Time (Minutes) 
WATTR003  DIM       80     80       Procedure Description
WATTR004  DIM       80     80       Reason/Diagnosis for Procedure
WATTR005  DIM       1       1       Procedure Status
WATTR006  DIM       12      8       Date on List (ccyymmdd)
WATTR007  DIM       12      8       Date of Last Review (ccyymmdd) /
WATTR008  DIM       12      8       Scheduled Admit. Date (ccyymmdd)
WATTR009  DIM       12      8       Removal Date (ccyymmdd)
WATTR010  DIM       3       3       Removal Reason (Category WR/BC)
WATTR011  DIM       3       3       Unit/Clinic (Category WU)
WATTR012  DIM       6       6       Attending Doctor
WATTR013  DIM       5       **      Estimated Stay (Days)
WATTR014  DIM       3       3       Priority (Category TP)
WATTR015  DIM       3       3       Short Notice (Category WS)
WATTR016  DIM       3       3       Resident Status (Category T)
WATTR017  DIM       3       3       Cat "A"  - dunno what desc is ????
WATTR018  DIM       3       3       User Defined 1 (Category W1)
WATTR019  DIM       3       3       User Defined 2 (Category W2)
WATTR020  DIM       3       3       User Defined 3 (Category W3)
WATTR021  DIM       3       3       User Defined 4 (Category W4)
WATTR022  DIM       12      8       Re-Assessment Date (ccyymmdd)
WATTR023  DIM       12      8       Deferred or Staged Adm Date
WATTR024  DIM       3       3       Patient Cat/Adm Class (Cat P)
WATTR025  DIM       12      8       Decision to Admit Date 
WATTR026  DIM       3       3       Administrative Category  "CL"
WATTR027  DIM       12      8       Guaranteed Admission Date
WATTR028  DIM       12      8       Do Not Admit Before Date
WATTR029  DIM       3       3       Elective Admission Type  "CC"
WATTR030  DIM       3       3       Admission Category   "WA"
WATTR031  DIM       20      20      ECR Approval Number
WATTR032  DIM       20      20      GPFH Approval Number
WATTR033  DIM       8       8       Referring GP
WATTR034  DIM       6       6       GP Practice code
WATTR035  DIM       2       2       GP Practice count
WATTR036  DIM       3       3       District of Residence (Cat DA)
WATTR037  DIM       4       4       Operator who added proc to W/L
WATTR038  DIM       3       3       Intended Hospital (pathspaf)  
WATTR039  DIM       1       1       Validation Letter Sent Flag (Y/N)
WATTR040  DIM       9       9       Procedure Code 2
WATTR041  DIM       9       9       Procedure Code 3
WATTR042  DIM       12      8       Prev Dec. to Admit Date (Tert. Ref)
WATTR043  DIM       3       3       User Defined 5 (Category X5)
WATTR044  DIM       3       3       User Defined 6 (Category X6)
WATTR045  DIM       3       3       User Defined 7 (Category X7)
WATTR046  DIM       3       3       User Defined 8 (Category X8)
WATTR047  DIM       6       6       Patient Rank
WATTR048  DIM       3       3       Source of Referral (S)
TRNSFSRC  DIM       5       * cgi param for Transfer Source
WATTR049  DIM       8               Booking Number
WATTR050  DIM       3               Referral source (based on wtcnbrsr)
WATTR051  DIM       12              Date of ref for FSA
WATTR052  DIM       12              Date of FSA
WATTR053  DIM       3               Principle HS Purchaser (Cat HP)
WATTR054  DIM       1               Consent Obtained (N or Y)
WATTR055  DIM       12              Consent Changed Date (dd mmm ccyy)
WATTR056  DIM       10              Assessor Code (pmshcpaf)
WATTR057  DIM       8               Actual Procedure Event Number
WATTR058  DIM       80              Procedure Description Comments
WATTR059  DIM       12     8        Referral Accepted Date (ccyymmdd)
WATTR060  DIM       80     80       Proceedure Description Line 2
WATTR061  DIM       80     80       Proceedure Description Line 3
.
WATSU001  DIM       12     8        Suspension From Date
WATSU002  DIM       12     8        Suspension To Date
WATSU003  DIM       3      3        Suspension Reason Cat "WN"
WATSU004  DIM       3      3        Listing Status    Cat "W4"
WATSU005  DIM       1               * Auto Update of RFC Status
WATSU006  DIM       10              * UserID
WATSU007  DIM       70              * Comments
.
WATLH001  DIM       12     8        Date Letter Sent
WATLH002  DIM       3      3        Letter Number
WATLH003  DIM       3      3        Patient Reply   Cat "WB"
WATLH004  DIM       3      3        Action Taken    Cat "WC"
WAITLETT  DIM       1
MULTLETT  DIM       1      Multiple letters (1=yes)
WTLH0021  DIM       3      Letter Number (multiple letters 1)
WTLH0022  DIM       3      Letter Number (multiple letters 2)
WTLH0023  DIM       3      Letter Number (multiple letters 3)
SCHDCOP1  DIM       3      Number of Copies (multiple letters 1)
SCHDCOP2  DIM       3      Number of Copies (multiple letters 2)
SCHDCOP3  DIM       3      Number of Copies (multiple letters 3)
SELPRIN1  DIM       6      Printer (multiple letters 1)
SELPRIN2  DIM       6      Printer (multiple letters 2)
SELPRIN3  DIM       6      Printer (multiple letters 3)
.
WATEX001  DIM       4     * Code                               
WATEX002  DIM       35    * Description                        
WATEX003  DIM       12    * From List Date                     
WATEX004  DIM       12    * To List Date                       
WATEX005  DIM       12    * From Review Date                   
WATEX006  DIM       12    * To Review Date                     
WATEX007  DIM       12    * From Sch Date                      
WATEX008  DIM       12    * To Sch Date                        
WATEX009  DIM       12    * From Removal Date                  
WATEX010  DIM       12    * To Removal Date                    
WATEX011  DIM       3     * Unit (WU)                          
WATEX012  DIM       3     * Priority (TP)                      
WATEX013  DIM       3     * Short Notice (WS)                  
WATEX014  DIM       3     * Procedure Group (WG)               
WATEX015  DIM       3     * Removal Reason (WR/BC)             
WATEX016  DIM       8     * Referring GP                       
WATEX017  DIM       6     * Consultant                         
WATEX018  DIM       9     * Procedure                          
WATEX019  DIM       3     * Source of Referral                 
WATEX020  DIM       3     * User Def 1 (W1)                    
WATEX021  DIM       3     * User Def 2 (W2)                    
WATEX022  DIM       3     * User Def 3 (W3)                    
WATEX023  DIM       3     * User Def 4 (W4)                    
WATEX024  DIM       3     * User Def 5 (X5)                    
WATEX025  DIM       3     * User Def 6 (X6)                    
WATEX026  DIM       3     * User Def 7 (X7)                    
WATEX027  DIM       3     * User Def 8 (X8)                    
WATEX028  DIM       1     * Status
WATEX029  DIM       3     * Analysis Level 1
WATEX030  DIM       3     * Analysis Level 2
WATEX031  DIM       3     * Analysis Level 3
WATEX032  DIM       3     * Analysis Level 4
WATEX033  DIM       3     * Analysis Measure 1
WATEX034  DIM       3     * Analysis Measure 2
WATEX035  DIM       3     * Analysis Measure 3
WATEX036  DIM       3     * Expected Post Op Ward
WATEX037  DIM       3     * Intended Day Case
WATEX038  DIM       3     * Last Letter Sent Code
WATEX039  DIM       1     * Check Response to letter
WATEX040  DIM       3     * Admitting Point
WATEX041  DIM       1     * Include Deceased
WATEX042  DIM       1     * Overdue Patients
WATEX043  DIM       3     * Claim Code
WATEX044  DIM       3     * Listing Status
WATEX045  DIM       8     * U/R Number From
WATEX046  DIM       8     * U/R Number To
WATEX047  DIM       9     * Procedure To
WATEX048  DIM       1     * Procedure Status To
WATEX049  DIM       3     * Unit To (Cat WU)
WATEX050  DIM       10    * Consultant From
WATEX051  DIM       10    * Consultant To
WATEX052  DIM       5     * Estimated Stay From
WATEX053  DIM       5     * Estimated Stay To
WATEX054  DIM       3     * Admission Type (Cat A)
WATEX055  DIM       3     * Resident Status (Cat T)
WATEX056  DIM       12     * Pre-assessment Date From
WATEX057  DIM       12     * Pre-assessment Date To
WATEX058  DIM       12     * Date on System From
WATEX059  DIM       12     * Date on System To
WATEX060  DIM       12     * Date on Suspension From
WATEX061  DIM       12     * Date on Suspension To
WATEX062  DIM       12    * Date off Suspension From
WATEX063  DIM       12     * Date off Suspension To
WATEX064  DIM       9     * Procedure From
WATEX065  DIM       1     * Procedure Status From
WATEX066  DIM       3     * Unit From
.
.WATHI001  DIM       3      * Reason for Change
.WATHI002  DIM       8      * Date of change      
.
WAHFUNCT  DIM       1
WAHEAIND  FORM      1      * WAHealth indicator for WATHIS00
WABMIIND  DIM       1
.
STATDESC  DIM       20
.
ADDWLFLG  FORM      1
XDATTIME  DIM       14     * Date/Time (ccyymmddhhmmss)
.
HLTURNON  DIM       1
.
BODMASIN  DIM       5
BODMASRN  DIM       60
BODMASUW  INIT      "<font color=purple>"
BODMASHE  INIT      "<font color=black>"
BODMASFT  INIT      "<font color=red>"
BOLD      INIT      "<b>"
ENDBOLD   INIT      "</b>"
ENDFONT   INIT      "</font>"
DELETERC  INIT      "DELETE"
BOOKST02  INIT      "Cancelled    "
HTMLBRK   INIT      "<br />"
READINES  INIT      "Readiness           "
URGENCY   INIT      "Urgency             "
WAITST01  INIT      "Unscheduled  "
WAITST02  INIT      "Scheduled    "
WAITST03  INIT      "Pre-Admitted "
WAITST04  INIT      "Admitted     "
WAITST05  INIT      "Discharged   "
WAITST06  INIT      "Removed      "
WAITST07  INIT      "Performed    "
WAITST08  INIT      "Not Performed"
WAITST09  INIT      "Cancelled Booking"
.
CATBG     INIT      "BG"
CATCL     INIT      "CL"
CATW1     INIT      "W1"
CATW2     INIT      "W2"
CATW3     INIT      "W3"
CATW4     INIT      "W4"
CATX5     INIT      "X5"
CATX6     INIT      "X6"
CATX7     INIT      "X7"
CATX8     INIT      "X8"
CATWG     INIT      "WG"
.
WTCHUP01  INIT      "Clinical Registration Date"
WTCHUP02  INIT      "Clinical Urgency"
WTCHUP03  INIT      "Date of Admission"
WTCHUP04  INIT      "Readiness for Care"
WTCHUP05  INIT      "Removal"
WTCHUP06  INIT      "Reason for Scheduled Admission Date Change"
WTCHUP07  INIT      "Removal Update"
WTCHUP08  INIT      "Scheduled Admission Date"
WTCHUP09  INIT      "Status Update"
WTCHUP10  INIT      "Update Suspension"
WTCHUP11  INIT      "Delete Suspension"
WTCHUP12  INIT      "Cancelled Admission"
WTCHUP13  INIT      "Return To Waiting List"
WTCHUP14  INIT      "Delete Suspension"
WTCHUP15  INIT      "Update Suspension"
WTCHUP16  INIT      "Cancel Booking"
WTCHUP17  INIT      "Change Intended Hospital"
WTCHUP18  INIT      "Created booking"
WTCHUP19  INIT      "Change Consultant"
WTCHUP20  INIT      "Patient Admitted"
WTCHUP21  INIT      "Changed Post Op Ward"
WTCHUP22  INIT      "Suspension Added"
WTCHUP23  INIT      "Suspension Updated"
WTCHUP24  INIT      "Suspension Deleted"
WTCHUP25  INIT      "Changed PPP"
WTCHUP26  INIT      "WL Changed U/R"
WTCHUP27  INIT      "Changed Referral Source"
WTCHUP28  INIT      "Changed Short Notice"
WTCHUP29  INIT      "Changed Intended Stay"
WTCHUP30  INIT      "Changed Claim Type"
WTCHUP31  INIT      "Clinical Urgency Delete"
ZERO6     INIT      "000000"
NINETY9   FORM      "99"
CORSP001  DIM       100
CORSP003  DIM       3
PACAFLAG  DIM       1
.
CHWCURNO  DIM       8        * Check UR Number (Workers Compensation)
CHWCADMN  DIM       8        * Check Admission Number (Workers Compensation)
DIM20     DIM       20
ZERO20    INIT      "00000000000000000000"
.
................................................................................
PRGID     INIT      "WATWEB01"
VERSION   INIT      "V12.00.03"
PRGNAM    INIT      "Waiting List Information Server"
................................................................................
.
          CALL      WEBINT00       * Initialise Fifo Etc.
          CALL      INIT0000       * Open Files
.
MAIN1000  CALL      WEBRED00       * Read Fifo WEBPID and USERID & Set Para
.
          MOVE      "40",MENUTYPE  * Default Menu Type to Waiting List
          COMPARE   "999",REPORTNO * End Server Process on Report Option 999
          GOTO      MAIN9999 IF EQUAL
.
          BRANCH    REPORTNO,MAIN1100,MAIN1200,MAIN1300,MAIN1400,MAIN1500:
                             MAIN1600,MAIN1700,MAIN1800,MAIN1900,MAIN2000:
                             MAIN2100,MAIN2200,MAIN2300,MAIN2400,MAIN2500:
                             MAIN2600,MAIN2700,MAIN2800,MAIN2900,MAIN3000:
                             MAIN3100,MAIN3200
          MOVE      "INVALID OPTION",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          GOTO      MAIN1000
.
MAIN1100  CALL      WATLST00     * Show Waiting List for a Doctor/Unit
          GOTO      MAIN1000
.
MAIN1200  CALL      WATDET00     * Waiting List details for a Patient
          GOTO      MAIN1000
.
MAIN1300  CALL      WATDAT00     * Show Waiting Lists by Date etc
          GOTO      MAIN1000
.
MAIN1400  MOVE      ZERO,LETCOUNT
          CALL      WATLET00     * Waiting Lists Letter Details
          GOTO      MAIN1000
.
MAIN1500  CALL      WATSUS00     * Waiting Suspension
          BRANCH    EXIT,MAIN1000
          CALL      WINCLS00
          GOTO      MAIN1000
.
MAIN1600  CALL      WATEXT00     * Waiting Extracts
          BRANCH    EXIT,MAIN1000
          MOVE      "Update Complete",WEBTITLE
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1700  CALL      WATBOK00     * Waiting List Bookings
          GOTO      MAIN1000
.
MAIN1800  CALL      WATEPS00     * Waiting List Patient Extract Table        
          BRANCH    EXIT,MAIN1000
          MOVE      "Update Complete",WEBTITLE
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1900  CALL      XMLSTA00     * returns Status default for Reason 
          GOTO      MAIN1000
.
MAIN2000  CALL      XMLADM00     * Validate admission number for w/list status
          GOTO      MAIN1000
.
MAIN2100  CALL      XMLBOK00     * Validate booking details for procedure date
          GOTO      MAIN1000
.
MAIN2200  CALL      XMLCHK00     * Validate Multiple Entries of Procedure
          GOTO      MAIN1000
.
MAIN2300  CALL      VALWAT00     * Validate Unit/Doctor Combination
          GOTO      MAIN1000
.
MAIN2400  CALL      VALPRO00     * Validate ESIS code 
          GOTO      MAIN1000
.
MAIN2500  CALL      WATESI00     * Waiting List ESIS History
          GOTO      MAIN1000
.
MAIN2600  CALL      BOKHIS00     * Booking history
          GOTO      MAIN1000
.
MAIN2700  CALL      CATHIS00     * Category change history
          GOTO      MAIN1000
.
MAIN2800  CALL      CNFBOK00     * Confirm booking
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2900  CALL      DUPCHK00     * validate Multiple entries date,code,ur
          GOTO      MAIN1000
. 
MAIN3000  CALL      WTCOMM00     *  WL Comments Maintenance
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN3100  CALL      XMLOVD00     * Calculate Admit on or before Date
          GOTO      MAIN1000
.
MAIN3200  CALL      DUPCHA00     * Validate (all) multiple entries date,code,ur
          GOTO      MAIN1000
. 
MAIN9999  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      WEBERR00
          STOP
+
.------------------------------------------------------------
.         DUPCHK00 - check duplicate waiting list 
.------------------------------------------------------------
.
DUPCHK00  CALL      XMLHED00
          BRANCH    EXIT,DUPCHK99
.
          MOVE      "-1",F2
          PACK      KEY27,LASTDATE,URNUMBER,PROCCODE,SP70
          CALL      RDSTREA3
DUPCHK10  CALL      RDKTREA3
          BRANCH    OVRCD,DUPCHK80
.
          MATCH     WMURNO,URNUMBER
          GOTO      DUPCHK80 IF NOT EQUAL
.
          MATCH     "4",DWMSTAT
          GOTO      DUPCHK88 IF EQUAL
.
          MATCH     WMCODE,PROCCODE
          IF        @EQUAL
.
            MATCH     WMDATE1,LASTDATE      * same date?
            IF        @EQUAL 
              GOTO      DUPCHK88            * yes; warn of duplicate
            ELSE  
              MATCH     "1",DWMSTAT         * Unscheduled?
              GOTO      DUPCHK88 IF EQUAL
.
              MATCH     "2",DWMSTAT         * Scheduled?
              GOTO      DUPCHK88 IF EQUAL
.
              MATCH     "5",DWMSTAT
              IF        @EQUAL
                PACK      KEY8,WMBOOK,SP70
                CALL      RDDSCH1
                BRANCH    OVRCD,DUPCHK80
.
                MATCH     DDATE,LASTDATE
                IF        @EQUAL
                  GOTO      DUPCHK88
                ENDIF
.
                GOTO      DUPCHK80
.
              ELSE
                GOTO        DUPCHK80
              ENDIF
            ENDIF
          ELSE
            GOTO      DUPCHK80
          ENDIF
.
          GOTO      DUPCHK10
.
DUPCHK80  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             ZERO:
                             "</RETURN_VALUE>";
          GOTO      DUPCHK95
.
DUPCHK88  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             F2:
                             "</RETURN_VALUE>";
          GOTO      DUPCHK95
.
DUPCHK95  CALL      XMLEND00

DUPCHK99  RETURN
+
.------------------------------------------------------------------------------
.         DUPCHA00 - check (all) duplicate waiting list procedure codes
.------------------------------------------------------------------------------
DUPCHA00  CALL      XMLHED00
          BRANCH    EXIT,DUPCHA99
.
          MOVE      "-1",F2
          PACK      KEY19,URNUMBER,Z70
          CALL      RDSTREA1
DUPCHA10  CALL      RDPTREA1
          BRANCH    OVRCD,DUPCHA80
.
          MATCH     WMURNO,URNUMBER
          GOTO      DUPCHA80 IF NOT EQUAL
.
          MATCH     "4",DWMSTAT
          GOTO      DUPCHA88 IF EQUAL
.
          MATCH     WMCODE,PROCCODE
          IF        @EQUAL
            MATCH     WMDATE1,LASTDATE      * same date?
            IF        @EQUAL 
              GOTO      DUPCHA88            * yes; warn of duplicate
            ELSE  
              MATCH     "1",DWMSTAT         * Unscheduled?
              GOTO      DUPCHA88 IF EQUAL
.
              MATCH     "2",DWMSTAT         * Scheduled?
              GOTO      DUPCHA88 IF EQUAL
.
              MATCH     "5",DWMSTAT
              IF        @EQUAL
                PACK      KEY8,WMBOOK,SP70
                CALL      RDDSCH1
                BRANCH    OVRCD,DUPCHA80
.
                MATCH     DDATE,LASTDATE
                IF        @EQUAL
                  GOTO      DUPCHA88
                ENDIF
.
                GOTO      DUPCHA80
              ELSE
                GOTO        DUPCHA80
              ENDIF
            ENDIF
          ENDIF
.
          GOTO      DUPCHA10
.
DUPCHA80  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             ZERO:
                             "</RETURN_VALUE>";
          GOTO      DUPCHA95
.
DUPCHA88  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             F2:
                             "</RETURN_VALUE>";
          GOTO      DUPCHA95
.
DUPCHA95  CALL      XMLEND00

DUPCHA99  RETURN
+
.------------------------------------------------------------
. Remote scripting for Status     
.------------------------------------------------------------
XMLSTA00  CALL      XMLHED00
          BRANCH    EXIT,XMLSTA99
.
.         WATSU003   --- reason
.
          MOVE      "RDSC",KEY4
          MOVE      "WN",KEY2
          PACK      KEY5,KEY2,WATSU003,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,XMLSTA88
          MOVE      TCINDC2,KEY1
.          
          SCAN      KEY1,KEY4    
          IF        !@EQUAL
            MOVE      SP70,KEY1
          ENDIF
.          MOVE      SP70,KEY1  IF NOT EQUAL
.
XMLSTA80  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             KEY1:
                             "</RETURN_VALUE>"
          GOTO      XMLSTA95
.
XMLSTA88  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Corresponding Status Not Available":
                             "</RETURN_VALUE>"
          GOTO      XMLSTA95
.
.XMLSTA89  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
.                             "Invalid Record":
.                             "</RETURN_VALUE>"
.          GOTO      XMLSTA95
.
XMLSTA95  CALL      XMLEND00
XMLSTA99  RETURN
.
.---------------------------------------------------------------
. Remote scripting for validation of the unit and consultant
.---------------------------------------------------------------
VALWAT00  CALL      XMLHED00
          BRANCH    EXIT,VALWAT99
.
          MOVE      ZERO,F1
          PACK      WATTR012,WATTR012,SP70
          PACK      WATTR011,WATTR011,SP70
.
          MATCH     "1",TMDDOCTF
          GOTO      VALWAT10 IF NOT EQUAL
.
          PACK      KEY21,WBSEHOSP,WATTR011,WATTR012,SP70
          CALL      RDPMTMD2
          IF        OVRCD<>1
            GOTO      VALWAT98
          ENDIF
.
          CALL      RSPMTMD2
          CALL      RKPMTMD2
          BRANCH    OVRCD,VALWAT91
.
          MATCH     WBSEHOSP,PMTDHOSP
          GOTO      VALWAT91 IF NOT EQUAL
          MATCH     WATTR011,PMTDUNIT
          GOTO      VALWAT91 IF NOT EQUAL
          MATCH     WATTR012,PMTDDOCT
          GOTO      VALWAT91 IF NOT EQUAL
.
          GOTO      VALWAT98
.
VALWAT10  PACK      KEY9,WATTR012,WATTR011,SP70
          CALL      RDWTVWL1
          BRANCH    OVRCD,VALWAT92
.
          GOTO      VALWAT98  
.
VALWAT91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Consultant/Unit Combination":
                             "</RETURN_VALUE>"
          GOTO      VALWAT98  
.
VALWAT92  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Consultant/Unit Combination - ":
                              KEY9,"</RETURN_VALUE>"
          GOTO      VALWAT98  
.
VALWAT98  CALL      XMLEND00
.
VALWAT99  RETURN
.
.---------------------------------------------------------------
.   validation of the Procedure code 
.---------------------------------------------------------------
VALPRO00  CALL      XMLHED00
          BRANCH    EXIT,VALPRO99
          MOVE      ZERO,F1
          PACK      WATTR001,WATTR001,SP70
          MATCH     SP70,WATTR001
          GOTO      VALPRO90 IF EQUAL 
          PACK      KEY9,WATTR001,SP70
          CALL      RDPROA1
          BRANCH    OVRCD,VALPRO90
          MOVE      WTWPACTV,F1
          BRANCH    F1,VALPRO91
.

          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             WPDESC:
                             "</RETURN_VALUE>"
          GOTO      VALPRO98
.
VALPRO90  IF        PTCNHDPS = 1
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                               "Invalid Procedure Code - ",KEY9:
                               " Use Supervisor Options to Change Procedure":
                               "</RETURN_VALUE>"
          ELSE
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                               "Invalid ESIS Code - ":
                                KEY9,"</RETURN_VALUE>"
          ENDIF
.
          GOTO      VALPRO98
.
VALPRO91  IF        PTCNHDPS = 1
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                               "Inactive Procedure Code - ",KEY9:
                               " Use Supervisor Options to Change Procedure":
                               "</RETURN_VALUE>"
          ELSE
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                               "Inactive  ESIS Code - ":
                                KEY9,"</RETURN_VALUE>"
          ENDIF
.
          GOTO      VALPRO98
.
VALPRO98  CALL      XMLEND00
.
VALPRO99  RETURN
.------------------------------------------------------------
. Checking Multiple Entries For Procedure
.------------------------------------------------------------
XMLCHK00  CALL      XMLHED00
          BRANCH    EXIT,XMLCHK99
.
          MOVE      "-1",F2 
          PACK      KEY19,URNUMBER,PROCCODE,SP70
          CALL      RDSTREA1
XMLCHK10  CALL      RDKTREA1
          BRANCH    OVRCD,XMLCHK80
          MATCH     WMURNO,URNUMBER
          GOTO      XMLCHK80 IF NOT EQUAL
          MATCH     WMCODE,PROCCODE
          GOTO      XMLCHK88 IF EQUAL
          GOTO      XMLCHK10 
.
XMLCHK80  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             ZERO:
                             "</RETURN_VALUE>";
          GOTO      XMLCHK95
.
XMLCHK88  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             F2:
                             "</RETURN_VALUE>";
          GOTO      XMLCHK95
.
XMLCHK95  CALL      XMLEND00
XMLCHK99  RETURN
.
.------------------------------------------------------------
. Output Next Page Based on CGI Parameter nextpage
.------------------------------------------------------------
NXTPAG00  MOVE      ZERO,F1
          MOVE      NEXTPAGE,F1
          BRANCH    F1,NXTPAG10,NXTPAG20,NXTPAG30,NXTPAG40,NXTPAG50:
                    NXTPAG60,NXTPAG70,NXTPAG80,NXTPAG90
.
          CALL      WINCLS00
          GOTO      NXTPAG99
.
NXTPAG10  CALL      RDIREC00
          GOTO      NXTPAG99
.
NXTPAG20  CALL      GOBACK00      * Go Back 1 Html page
          GOTO      NXTPAG99
.
NXTPAG30  CALL      PRDWMB00              * parent redirect with wmbook
          GOTO      NXTPAG99
.
NXTPAG40  CALL      GOBACK00
          GOTO      NXTPAG99
.
NXTPAG50  CALL      WINPAR00
          GOTO      NXTPAG99
.
NXTPAG60  CALL      RDIWIN00
          GOTO      NXTPAG99
.
NXTPAG70  CALL      PREDIR00
          GOTO      NXTPAG99
.
NXTPAG80  CALL      PPRDIR00
          GOTO      NXTPAG99
.
NXTPAG90  CALL      PRDRCS00              * parent redirect with casekeys
          GOTO      NXTPAG99
.
NXTPAG99  RETURN
.------------------------------------------------------------------------------
.        Close Popup and Goto New Location                         
.------------------------------------------------------------------------------
RDIWIN00  CALL      OPENHTML
          BRANCH    EXIT,RDIWIN99
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                    "self.close();":
                    "  parent.location.href=#"",REDIRECT,"#";":
                    "}":
                    "</script>";
          CALL      CLOSHTML
.
RDIWIN99  RETURN
.------------------------------------------------------------------------------
.        Close Popup and Goto history
.------------------------------------------------------------------------------
RDPWIN00  CALL      OPENHTML
          BRANCH    EXIT,RDPWIN99
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "     self.close();":
                             "parent.history.go(-2);":
                    "}":
                    "</script>";
          CALL      CLOSHTML
.
RDPWIN99  RETURN
.------------------------------------------------------------------------------
.        Close Window or Frame and Goto New Location                         
.------------------------------------------------------------------------------
WINPAR00  CALL      OPENHTML
          BRANCH    EXIT,WINPAR99
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             "src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             "src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#"> ":
                             " redirectTopPopUpFrame(#"",REDIRECT,"#"); ":
                             "</script>";
          CALL      CLOSHTML
WINPAR99  RETURN
.------------------------------------------------------------------------------
.  Redirect Parent URL
.------------------------------------------------------------------------------
PREDIR00  CALL      OPENHTML
          BRANCH    EXIT,PREDIR90
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
.                             " alert(#"",WEBTITLE,"#");":
                             " parent.location.href=#"",REDIRECT,"#";":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      PREDIR99
.
PREDIR90  DISPLAY   "*** Fifo Not Found ***"
.
PREDIR99  RETURN
.
.------------------------------------------------------------------------------
.  Redirect Parent URL and append casekeys
.-----------------------------------------------------------------------------
PRDRCS00  CALL      OPENHTML
          BRANCH    EXIT,PRDRCS90
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
.                             " alert(#"",WEBTITLE,"#");":
                             " parent.location.href=#"",REDIRECT:
                             WMURNO,WMCODE,DWMCNT,"#";":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      PRDRCS99
.
PRDRCS90  DISPLAY   "*** Fifo Not Found ***"
.
PRDRCS99  RETURN
.
.------------------------------------------------------------------------------
.  Redirect Parent URL and append wmbook
.-----------------------------------------------------------------------------
PRDWMB00  CALL      OPENHTML
          BRANCH    EXIT,PRDWMB90
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
.                             " alert(#"",WEBTITLE,"#");":
                             " parent.location.href=#"",REDIRECT:
                             WMBOOK,"#";":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      PRDWMB99
.
PRDWMB90  DISPLAY   "*** Fifo Not Found ***"
.
PRDWMB99  RETURN
.
.------------------------------------------------------------------------------
.  Redirect Parent.Parent URL - Close 2 Dframes and redirect
.------------------------------------------------------------------------------
PPRDIR00  CALL      OPENHTML
          BRANCH    EXIT,PPRDIR90
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             " parent.parent.location.href=#"",REDIRECT,"#";":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      PPRDIR99
.
PPRDIR90  DISPLAY   "*** Fifo Not Found ***"
.
PPRDIR99  RETURN
.-------------------------------------------------------------------------------
.  Goes back 1 page
.-------------------------------------------------------------------------------
GOBACK00  CALL      OPENHTML
          BRANCH    EXIT,GOBACK99
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "    alert(#"",WEBTITLE,"#");":
                             "    self.close();":
                             "    opener.history.go(-1);":
                             "}":
                             "</script>"
          CALL      CLOSHTML
GOBACK99  RETURN
.------------------------------------------------------------
. Open Files and Initialize Variables
.------------------------------------------------------------
INIT0000  OPEN      CASSTYA1,"casstyaf" 
          OPEN      CASAMEA1,"casameaf" 
          OPEN      PATCODE1,"patcodes" 
          OPEN      PATCODE2,"patcodes" 
          OPEN      CONTROLF,"controlf"  * Open the control file
          OPEN      COMERHA3,"comerhaf"
          OPEN      PMSEXTA1,"pmsextaf"
          OPEN      PMSHCPA1,"pmshcpaf"
          OPEN      PMSTMDA2,"pmstmdaf"
          OPEN      PMSHCGA1,"pmshcgaf"
          OPEN      PATDO1A3,"patdo1af"
          OPEN      BOKCNFA1,"bokcnfaf"
          OPEN      BOKRC1A1,"bokrc1af"
          OPEN      BOKRC1A4,"bokrc1af"
          OPEN      BOKRC1A6,"bokrc1af"
          OPEN      IBASPOL1,"ibaspolf"
          OPEN      IBALPCA1,"ibalpcaf"
          OPEN      BOKUNQA1,"bokunqaf"
          OPEN      MLTHCPA2,"mlthcpaf"
          OPEN      OPRDETA2,"oprdetaf"
          OPEN      BOKDIAA1,"bokdiaaf"
          OPEN      PMSAIDA1,"pmsaidaf"
          OPEN      WATEXTA1,"watextaf"
          OPEN      WATVWLA1,"watvwlaf"
          OPEN      WATESIA1,"watesiaf"
          OPEN      WATESIA2,"watesiaf"
          OPEN      WATESTA1,"watestaf"
          OPEN      WATTR1A1,"wattr1af"
          OPEN      WATTR1A2,"wattr1af"
          OPEN      WATTR1A3,"wattr1af"
          OPEN      WATTR1A4,"wattr1af"
          OPEN      WATTR1A5,"wattr1af"
          OPEN      WATTR1A7,"wattr1af"
          OPEN      WATESEA1,"wateseaf"
          OPEN      WATESNA1,"watesnaf"
          OPEN      WATESNA5,"watesnaf"
          OPEN      WATESPA1,"watespaf"
          OPEN      WATMESA1,"watmesaf"
          OPEN      WATLHIA1,"watlhiaf"
          OPEN      WATSUSA1,"watsusaf"
          OPEN      WATSUSA2,"watsusaf"
          OPEN      WATHISA1,"wathisaf"
          OPEN      WATLETR1,"watletrf"
          OPEN      WATLETR2,"watletrf"
          OPEN      WATLETR3,"watletrf"
          OPEN      WATMHDA1,"watmhdaf"
          OPEN      WATMTXA1,"watmtxaf" 
          OPEN      WATCATA1,"watcataf"
          OPEN      WATCATA2,"watcataf"
          OPEN      WATCHAA1,"watchaaf"
          OPEN      WATPROA1,"watproaf"
          OPEN      WATPROA3,"watproaf"
          OPEN      WATPHIA1,"watphiaf"
          OPEN      DISMASA1,"dismasaf"
          OPEN      DISPATA1,"dispataf"
          OPEN      DISPATA2,"dispataf"
          OPEN      DISPTLA1,"disptlaf"
          OPEN      ALLDIAA1,"alldiaaf"        * Allied Health Diagnosis
          OPEN      ALLREFA1,"allrefaf"
          OPEN      ALLWLNA1,"allwlnaf"
          OPEN      IBAPRTA1,"ibaprtaf"        * For Printer Selection
          OPEN      IBACODE1,"ibacodef"        * For Printer Selection
          OPEN      IHAPASS1,"ihapassf"        * For Printer Selection
          OPEN      IBAPDFA1,"ibapdfaf"        * For default printer selection
          OPEN      WATEPSA1,"watepsaf"
          OPEN      PATWR1A7,"patwr1af"
          OPEN      PATMI1A1,"patmi1af"
          OPEN      PATMI1A8,"patmi1af"
          OPEN      WATPACA1,"watpacaf"
          OPEN      VISINTA1,"visintaf"
          OPEN      VISIAUA1,"visiauaf"
          OPEN      PATWC1A1,"patwc1af"
          OPEN      PMSWX1A1,"pmswx1af"
.
          OPEN      WATTX1A1,"wattx1af"
          OPEN      BOKRX1A1,"bokrx1af"
          OPEN      PMSCEXA1,"pmscexaf"
          OPEN      PMSHCPA1,"pmshcpaf"
          OPEN      PATMRGG1,"patmrgaf"
          OPEN      PATDSCH1,"patdschf"
          OPEN      PATMA1A1,"patma1af"
          OPEN      OPRDETA2,"oprdetaf"
          OPEN      PMSVX1A1,"pmsvx1af"
          OPEN      VISCMTA1,"viscmtaf"
          OPEN      PATVADA1,"patvadaf"
          OPEN      PMSDUNA1,"pmsdunaf"
          OPEN      PATHSPA1,"pathspaf"
          OPEN      MLTSECA1,"mltsecaf"
          OPEN      WATLPCA1,"watlpcaf"
          OPEN      WATOPAA1,"watopaaf"
          OPEN      WATOPSA1,"watopsaf"
          OPEN      VISMDTA1,"vismdtaf"
          OPEN      VISMTXA1,"vismtxaf"
          OPEN      ACCAUDA1,"accaudaf"
          OPEN      ACCDIAA1,"accdiaaf"
          OPEN      EMRICDA1,"emricdaf"
          OPEN      PMSCCDA1,"pmsccdaf"
.
          READ      CONTROLF,FIFTY9;*220,PTCNUADT
          READ      CONTROLF,THIRTY7;*242,WTCNUSXB
          READ      CONTROLF,HUND18;*138,PTCNNEWC
          IF        PTCNUADT=1
            OPEN      WATRTDA1,"watrtdaf"
          ENDIF
          READ      CONTROLF,TEN5;*189,CTHETR
          READ      CONTROLF,EIGHTY;*250,PTCNHDPS
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,HUND05;*210,PTCNLCLM
          READ      CONTROLF,HUND12;*96,PTCNH7AC,*101,PTCNUFFR
          MOVE      ZERO,LISTLIMT
          READ      CONTROLF,HUND11;*27,WTCNNRTS
          READ      CONTROLF,HUND19;*182,PTCNEPIS
          READ      CONTROLF,HUND20;*243,PTCNSMSN
          READ      CONTROLF,HUND16;*222,PTCNXCOM
          READ      CONTROLF,TWENTY1;*237,PTCNPAOF,*238,PTCNAGEC
.
          SQUEEZE   WTCNNRTS
          MOVE      WTCNNRTS,LISTLIMT
          COMPARE   ZERO,LISTLIMT
          IF        @EQUAL
            MOVE      "200",LISTLIMT
          ENDIF
.
          PACK      SP70,SP70,SP70
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
          ENDIF
.
.          OPEN      PATGPCA1,"patgpcaf"       * Commented for Compilation
          CALL      INTMAS00
.
          CALL      TFILENAM
          MOVE      TFILNAME,COMFILNM
.
          CALL      TFILENAM
          MOVE      TFILNAME,COMFILNW
.
          CALL      TFILENAM
          MOVE      TFILNAME,COMPRENM
.
          CALL      TFILENAM
          MOVE      TFILNAME,COMVISNM
.
          MOVE      ZERO,NOATTRIB
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PATATRA1,"patatraf"
          OPEN      PATATRA2,"patatraf"
          TRAPCLR   IO
          IF        OVRCD=1
            MOVE      ONE,NOATTRIB
          ENDIF
.
          RETURN
.------------------------------------------------------------
. Process Template Fields in the Body of the HTML
.------------------------------------------------------------
PROFLD00  BRANCH    REPORTNO,PROFLD10,PROFLD20,PROFLD30,PROFLD40,PROFLD50:
                             PROFLD60,PROFLD60,PROFLD80,PROFLD99,PROFLD99:
                             PROFLD99,PROFLD99,PROFLD99,PROFLD99,PROFL150:
                             PROFL160,PROFL170,PROFL180,PROFLD99,PROFL200
          GOTO      PROFLD99
.
PROFLD10  BRANCH    FLDSETNO,PROFLD11
.
PROFLD11  CALL      WLST0000
          GOTO      PROFLD99
.
PROFLD20  BRANCH    FLDSETNO,PROFLD21,PROFLD22,PROFLD23,PROFLD24,PROFLD25:
                    PROFLD26,PROFLD27,PROFLD28,PROFLD29,PROFL299

          GOTO      PROFLD99
.
PROFLD21  CALL      MASF0000
          GOTO      PROFLD99
.
PROFLD22  CALL      WTRE0000
          GOTO      PROFLD99
.
PROFLD23  CALL      MSXF0000
          GOTO      PROFLD99
.
PROFLD24  CALL      PCOM0000
          GOTO      PROFLD99
.
PROFLD25  CALL      BKRX0000           * Booking list extn file
          GOTO      PROFLD99
.
PROFLD26  CALL      WTTX0000
          GOTO      PROFLD99
.
PROFLD27  CALL      WSUS0000
          GOTO      PROFLD99
.
PROFLD28  CALL      BREC0000
          GOTO      PROFLD99
.
PROFLD29  CALL      GETTHE00
          CALL      ODET0000
          GOTO      PROFLD99
.
PROFL299  CALL      CLMF0000
          GOTO      PROFLD99
.
PROFLD30  BRANCH    FLDSETNO,PROFLD31,PROFLD32
          GOTO      PROFLD99
.
PROFLD31  CALL      WATD0000
          GOTO      PROFLD99
.
PROFLD32  CALL      EXTF0000
          GOTO      PROFLD99
.
PROFLD40  BRANCH    FLDSETNO,PROFLD41,PROFLD42,PROFLD43,PROFLD44
          GOTO      PROFLD99
.
PROFLD41  CALL      MASF0000
          GOTO      PROFLD99
.
PROFLD42  CALL      WTRE0000
          GOTO      PROFLD99

PROFLD43  CALL      WLET0000
          GOTO      PROFLD99
.
PROFLD44  CALL      MSXF0000
          GOTO      PROFLD99
.
PROFLD50  BRANCH    FLDSETNO,PROFLD51,PROFLD52,PROFLD53,PROFLD54
          GOTO      PROFLD99
.
PROFLD51  CALL      MASF0000
          GOTO      PROFLD99
.
PROFLD52  CALL      WTRE0000
          GOTO      PROFLD99
.
PROFLD53  CALL      WSUS0000
          GOTO      PROFLD99
.
PROFLD54  CALL      WSCOM000 
          GOTO      PROFLD99
.
PROFLD60  BRANCH    FLDSETNO,PROFLD61,PROFLD62
          GOTO      PROFLD99
.
PROFLD61  CALL      EXTF0000
          GOTO      PROFLD99
.
PROFLD62  CALL      WLST0000
          GOTO      PROFLD99
.
PROFLD80  BRANCH    FLDSETNO,PROFLD81,PROFLD82
          GOTO      PROFLD99
.
PROFLD81  CALL      EXTF0000    
          GOTO      PROFLD99
.
PROFLD82  CALL      WATP0000
          GOTO      PROFLD99
.
PROFL150  BRANCH    FLDSETNO,PROFL151,PROFL152,PROFL153,PROFL154
          GOTO      PROFLD99
.
PROFL151  CALL      MASF0000
          GOTO      PROFLD99
.
PROFL152  CALL      WTRE0000
          GOTO      PROFLD99
.
PROFL153  CALL      MSXF0000
          GOTO      PROFLD99
.
PROFL154  CALL      WESI0000
          GOTO      PROFLD99
.
PROFL160  BRANCH    FLDSETNO,PROFL161,PROFL162,PROFL163,PROFL164,PROFL165
          GOTO      PROFLD99
.
PROFL161  CALL      MASF0000
          GOTO      PROFLD99
.
PROFL162  CALL      WTRE0000
          GOTO      PROFLD99
.
PROFL163  CALL      MSXF0000
          GOTO      PROFLD99
.
PROFL164  CALL      BOKH0000
          GOTO      PROFLD99
.
PROFL165  CALL      BREC0000
          GOTO      PROFLD99
.
.
PROFL170  BRANCH    FLDSETNO,PROFL171,PROFL172,PROFL173,PROFL174
          GOTO      PROFLD99
.
PROFL171  CALL      MASF0000
          GOTO      PROFLD99
.
PROFL172  CALL      WTRE0000
          GOTO      PROFLD99
.
PROFL173  CALL      CTHI0000
          GOTO      PROFLD99
.
PROFL174  CALL      DICC0000    * category change record values
          GOTO      PROFLD99
.
PROFL180  BRANCH    FLDSETNO,PROFL181,PROFL182,PROFL183

          GOTO      PROFLD99
.
PROFL181  CALL      MASF0000
          GOTO      PROFLD99
.
PROFL182  CALL      WTRE0000
          GOTO      PROFLD99
.
PROFL183  CALL      BKCF0000
          GOTO      PROFLD99
.
PROFL200  BRANCH    FLDSETNO,PROFL201,PROFL202,PROFL203
          GOTO      PROFLD99
.
PROFL201  CALL      MASF0000
          GOTO      PROFLD99
.
PROFL202  CALL      WTRE0000
          GOTO      PROFLD99
.
PROFL203  CALL      WTMH0000            
          GOTO      PROFLD99
.
PROFLD99  RETURN
.------------------------------------------------------------
. Get Theatre Booking Details for Waiting List
.------------------------------------------------------------
GETTHE00  COMPARE   TWO,WMSTAT
          GOTO      GETTHE05 IF EQUAL
.
          COMPARE   THREE,WMSTAT
          GOTO      GETTHE05 IF EQUAL
.
          COMPARE   FOUR,WMSTAT
          GOTO      GETTHE05 IF EQUAL
.
          COMPARE   FIVE,WMSTAT
          GOTO      GETTHE05 IF EQUAL
.
          GOTO      GETTHE98
.
GETTHE05  MATCH     ZEROVISN,WMBOOK
          GOTO      GETTHE98 IF EQUAL
.
          PACK      KEY31,WMBOOK,ZERO,SP70
          CALL      RSOPDEA2
GETTHE10  CALL      RKOPDEA2
          BRANCH    OVRCD,GETTHE98
          MOVE      WMBOOK,D8
          MATCH     D8,OPDAADMN
          GOTO      GETTHE98 IF NOT EQUAL
          MATCH     WMCODE,OPDAPROC
          GOTO      GETTHE10 IF NOT EQUAL
          MATCH     DWMCNT,OPDACONT
          GOTO      GETTHE10 IF NOT EQUAL
          COMPARE   THREE,OPDASTAT
          GOTO      GETTHE10 IF EQUAL
          GOTO      GETTHE99
.
GETTHE98  CALL      CLOPRDEA
.
GETTHE99  RETURN
.------------------------------------------------------------
. Clear Parameters
.------------------------------------------------------------
CLRPAR00  MOVE      ZERO,CHECKGP
          MOVE      ZERO,REPORTNO
          MOVE      ZERO,ALLWFLAG
          MOVE      ZERO,NOONLOAD
          MOVE      ZERO,FLTRDATE
          MOVE      ZERO,WAHFUNCT
          MOVE      SP70,TEMPLATE
          MOVE      SP70,CORSP001
          MOVE      SP70,CORSP003
          MOVE      ZERO,TAKEUPFL
          MOVE      SP70,TAKEBSTA
          MOVE      ZERO,STARTNUM
          MOVE      ZERO,MRGEFLAG
          MOVE      ZERO,MRGECOUNT
          MOVE      ZERO,SHRTNFLG
          MOVE      ZERO,DOCERROR
          MOVE      ZERO,TMDDOCTF
          MOVE      SP70,SAVEURNO
          MOVE      ZERO,NORECORD
          MOVE      SP70,SRCHSNAM
          MOVE      SP70,SRCHGNAM
          MOVE      SP70,NEXTPAGE
          MOVE      SP70,NEWPROCC
          MOVE      SP70,INVCASEK
          MOVE      ZERO,USEINVAD
          PACK      REDIRECT,SP70,SP70,SP70,SP70
          MOVE      SP70,FRSTDATE
          MOVE      SP70,LASTDATE
          MOVE      ZERO,VIEWTYPE
          MOVE      SP70,VYEARMTH
          MOVE      SP70,DOCTCODE
          MOVE      SP70,EMPTDOCT
          MOVE      SP70,DOCTTYPE
          MOVE      SP70,UNITCODE
          MOVE      SP70,UNITCOD2
          MOVE      SP70,FLTSHORT
          MOVE      SP70,REMSTATS
          MOVE      SP70,STATCODE
          MOVE      SP70,FILTPAST
          MOVE      SP70,FILTDOCT
          MOVE      SP70,SUSPKEYS
          MOVE      SP70,HISTKEYS
          MOVE      SP70,PHISTKEY
          MOVE      SP70,CASEKEYS
          MOVE      SP70,ESISKEYS
          MOVE      SP70,ADMISSNO
          MOVE      SP70,URNUMBER
          MOVE      SP70,PROCCODE
          MOVE      SP70,UPDTTYPE
          MOVE      SP70,ANLTYPE
          MOVE      SP70,ANLMEAS
          MOVE      ZERO,LISTSTAT
          MOVE      SP70,XMLDATE1
          MOVE      SP70,XMLDATE2
          MOVE      ZERO,XMLCODE1
          MOVE      ZERO,WATTFLAG
          MOVE      ZEROVISN,NEWBOKNO
          MOVE      SP70,REASONFC
          MOVE      ZERO,CANCELRM
          MOVE      SP70,EFFCDATE
          MOVE      SP70,NEWEFFDT
          MOVE      Z70,NEWPCODF
          MOVE      Z70,NEWPCODT
          MOVE      Z70,PREVID01
          MOVE      Z70,PREVTT01
          MOVE      Z70,UNIQUEID
          MOVE      SP70,DEFTURNO
          MOVE      SP70,SERBFLAG
          MOVE      SP70,SELPRINT
          MOVE      SP70,SCHDCOPY
          MOVE      SP70,NOTETYPE
          MOVE      SP70,NOTENUMB
          MOVE      SP70,SUPRFLAG
          MOVE      SP70,ADMREQNO
          MOVE      ZERO,ADMCOMTS
.
          MOVE      Z70,ACCPORDN
          MOVE      SP70,BLNKBOOK
          MOVE      SP70,BOOKDATE
          MOVE      SP70,BOOKTIME
          MOVE      SP70,BOOKWARD
          MOVE      SP70,BOOKEBED
          MOVE      SP70,DISPT001
          MOVE      SP70,DISPT002
.
          MOVE      SP70,WATEP001  
          MOVE      SP70,WATEP002  
          MOVE      SP70,WATEP003  
          MOVE      SP70,WATEP004 
          MOVE      SP70,WATEP005  
          MOVE      Z70,UPDFLD01
          MOVE      Z70,UPDFLD02
          MOVE      Z70,UPDFLD05
          MOVE      Z70,UPDFLD07
          MOVE      Z70,UPDFLD09
          MOVE      Z70,UPDFLD13
          MOVE      Z70,REASFC01
          MOVE      Z70,REASFC02
          MOVE      Z70,REASFC05
          MOVE      Z70,REASFC07
          MOVE      Z70,REASFC09
          MOVE      Z70,REASFC13
          MOVE      Z70,REASFC14
          MOVE      Z70,REASFC15
          MOVE      Z70,REASFC17
.
          MOVE      Z70,WATSU001
          MOVE      Z70,WATSU002
          MOVE      Z70,WATSU003
          MOVE      Z70,WATSU004
          MOVE      Z70,WATSU005
          MOVE      Z70,WATSU006
.         MOVE      Z70,WATSU007 
.
          MOVE      Z70,WATLH001
          MOVE      Z70,WATLH002
          MOVE      Z70,WATLH003
          MOVE      Z70,WATLH004
          MOVE      Z70,WTLH0021
          MOVE      Z70,WTLH0022
          MOVE      Z70,WTLH0023
          MOVE      Z70,SCHDCOP1
          MOVE      Z70,SCHDCOP2
          MOVE      Z70,SCHDCOP3
          MOVE      Z70,SELPRIN1
          MOVE      Z70,SELPRIN2
          MOVE      Z70,SELPRIN3
.
          MOVE      Z70,WATTR001
          MOVE      Z70,WATTR002
          MOVE      Z70,WATTR003
          MOVE      Z70,WATTR004
          MOVE      Z70,WATTR005
          MOVE      Z70,WATTR006
          MOVE      Z70,WATTR007
          MOVE      Z70,WATTR008
          MOVE      Z70,WATTR009
          MOVE      Z70,WATTR010
          MOVE      Z70,WATTR011
          MOVE      Z70,WATTR012
          MOVE      Z70,WATTR013
          MOVE      Z70,WATTR014
          MOVE      Z70,WATTR015
          MOVE      Z70,WATTR016
          MOVE      Z70,WATTR017
          MOVE      Z70,WATTR018
          MOVE      Z70,WATTR019
          MOVE      Z70,WATTR020
          MOVE      Z70,WATTR021
          MOVE      Z70,WATTR022
          MOVE      Z70,WATTR023
          MOVE      Z70,WATTR024
          MOVE      Z70,WATTR025
          MOVE      Z70,WATTR026
          MOVE      Z70,WATTR027
          MOVE      Z70,WATTR028
          MOVE      Z70,WATTR029
          MOVE      Z70,WATTR030
          MOVE      Z70,WATTR031
          MOVE      Z70,WATTR032
          MOVE      Z70,WATTR033
          MOVE      Z70,WATTR034
          MOVE      Z70,WATTR035
          MOVE      Z70,WATTR036
          MOVE      Z70,WATTR037
          MOVE      Z70,WATTR038
          MOVE      Z70,WATTR039
          MOVE      Z70,WATTR040
          MOVE      Z70,WATTR041
          MOVE      Z70,WATTR042
          MOVE      Z70,WATTR043
          MOVE      Z70,WATTR044
          MOVE      Z70,WATTR045
          MOVE      Z70,WATTR046
          MOVE      Z70,WATTR047
          MOVE      Z70,WATTR048
          MOVE      Z70,TRNSFSRC
          MOVE      Z70,WATTR049
          MOVE      Z70,WATTR050
          MOVE      Z70,WATTR051
          MOVE      Z70,WATTR052
          MOVE      Z70,WATTR053
          MOVE      Z70,WATTR054
          MOVE      Z70,WATTR055
          MOVE      Z70,WATTR056
          MOVE      Z70,WATTR057
          MOVE      Z70,WATTR058
          MOVE      Z70,WATTR059
          MOVE      Z70,WATTR060
          MOVE      Z70,WATTR061
          MOVE      Z70,UPDATEKY
          MOVE      ZERO,WTMEEND 
          MOVE      ZERO,WTPAEND 
.
          MOVE      Z70,WATEX001
          MOVE      Z70,WATEX002
          MOVE      Z70,WATEX003
          MOVE      Z70,WATEX004
          MOVE      Z70,WATEX005
          MOVE      Z70,WATEX006
          MOVE      Z70,WATEX007
          MOVE      Z70,WATEX008
          MOVE      Z70,WATEX009
          MOVE      Z70,WATEX010
          MOVE      Z70,WATEX011
          MOVE      Z70,WATEX012
          MOVE      Z70,WATEX013
          MOVE      Z70,WATEX014
          MOVE      Z70,WATEX015
          MOVE      Z70,WATEX016
          MOVE      Z70,WATEX017
          MOVE      Z70,WATEX018
          MOVE      Z70,WATEX019
          MOVE      Z70,WATEX020
          MOVE      Z70,WATEX021
          MOVE      Z70,WATEX022
          MOVE      Z70,WATEX023
          MOVE      Z70,WATEX024
          MOVE      Z70,WATEX025
          MOVE      Z70,WATEX026
          MOVE      Z70,WATEX027
          MOVE      Z70,WATEX028
          MOVE      Z70,WATEX029  
          MOVE      Z70,WATEX030  
          MOVE      Z70,WATEX031  
          MOVE      Z70,WATEX032  
          MOVE      Z70,WATEX033  
          MOVE      Z70,WATEX034  
          MOVE      Z70,WATEX035  
          MOVE      Z70,WATEX036  
          MOVE      Z70,WATEX037  
          MOVE      Z70,WATEX038  
          MOVE      Z70,WATEX039  
          MOVE      Z70,WATEX040  
          MOVE      Z70,WATEX041  
          MOVE      Z70,WATEX042  
          MOVE      Z70,WATEX043  
          MOVE      Z70,WATEX044  
          MOVE      Z70,WATEX045
          MOVE      Z70,WATEX046
          MOVE      Z70,WATEX047
          MOVE      Z70,WATEX048
          MOVE      Z70,WATEX049
          MOVE      Z70,WATEX050
          MOVE      Z70,WATEX051
          MOVE      Z70,WATEX052
          MOVE      Z70,WATEX053
          MOVE      Z70,WATEX054
          MOVE      Z70,WATEX055
          MOVE      Z70,WATEX056
          MOVE      Z70,WATEX057
          MOVE      Z70,WATEX058
          MOVE      Z70,WATEX059
          MOVE      Z70,WATEX060
          MOVE      Z70,WATEX061
          MOVE      Z70,WATEX062
          MOVE      Z70,WATEX063
          MOVE      Z70,WATEX064
          MOVE      Z70,WATEX065
          MOVE      Z70,WATEX066
.
          MOVE      Z70,WATHI001
          MOVE      Z70,WATHI002
.
          MOVE      Z70,BKREC001
          MOVE      Z70,BKREC002
          MOVE      Z70,BKREC003
          MOVE      Z70,BKREC004
          MOVE      Z70,BKREC005
          MOVE      Z70,BKREC006
          MOVE      Z70,BKREC007
          MOVE      Z70,BKREC008
          MOVE      Z70,BKREC009
          MOVE      Z70,BKREC010
          MOVE      Z70,BKREC011
          MOVE      Z70,BKREC012
          MOVE      Z70,BKREC013
          MOVE      Z70,BKREC014
          MOVE      Z70,BKREC015
          MOVE      Z70,BKREC016
          MOVE      Z70,BKREC017
          MOVE      Z70,BKREC018
          MOVE      Z70,BKREC019
          MOVE      Z70,BKREC020
          MOVE      Z70,BKREC021
          MOVE      Z70,BKREC022
          MOVE      Z70,BKREC023
          MOVE      Z70,BKREC024
          MOVE      Z70,BKREC025
          MOVE      Z70,BKREC026
          MOVE      Z70,BKREC027
          MOVE      Z70,BKREC028
          MOVE      Z70,BKREC029
          MOVE      Z70,BKREC030
          MOVE      Z70,BKREC031
          MOVE      Z70,BKREC032
          MOVE      Z70,BKREC033
          MOVE      Z70,BKREC034
          MOVE      Z70,BKREC035
          MOVE      Z70,BKREC036
          MOVE      Z70,BKREC037
          MOVE      Z70,BKREC038
          MOVE      Z70,BKREC039
.
          MOVE      SP70,CATECODE
          MOVE      SP70,LISTCODE
          MOVE      SP70,INTENDST
          MOVE      SP70,OVRDCODE
          MOVE      SP70,AIHWREPT
          MOVE      SP70,INTDHOSP
          MOVE      SP70,ADMPOINT
          MOVE      SP70,INTDAYCS
          MOVE      ZERO,ADDWLFLG
.
          MOVE      SP70,ADMISNID
          MOVE      ZERO,LETTREQD
          MOVE      ZERO,SHOWCOMM
          MOVE      ZERO,ALLCOMM
          CALL      CPWTTX00
          CALL      CPBKRX00
          MOVE      SP70,INTRFLAG
          PACK      KEY52,SP70
          MOVE      ZERO,WABKHIST
.
          MOVE      SP70,NEWURNUM
          MOVE      SP70,NEXTDKEY
          MOVE      SP70,NEXTUKEY
.
          CALL      CPWTHI00
.
          MOVE      Z70,MULTLETT
          MOVE      SP70,SVNOTICE
          MOVE      SP70,SVWMSRCR
          MOVE      SP70,SVTXPOWD
          MOVE      SP70,SVTXINTD
          MOVE      SP70,SVTXCTYP
          MOVE      SP70,SVWMDOCT
          MOVE      SP70,WAITLETT
          MOVE      SP70,SAVEFDAT
          MOVE      SP70,SAVETDAT
          MOVE      SP70,LETTER01
          MOVE      SP70,LETTER02
          MOVE      SP70,LETTER03
          MOVE      Z70,PATIENTL
          MOVE      Z70,LABELTYP
          MOVE      Z70,UPDTESIS
          MOVE      ZERO,WLKEYEND
          MOVE      ZERO,DEFTVIEW
          MOVE      ZERO,WAHVIEW
.
          CALL      CPBKCF00
          MOVE      ZERO,PCOMFLAG
.
          CALL      CLPATATR
          CALL      CLRATR00
.
          MOVE      SP70,ALWLVISN
          MOVE      SP70,WABMIIND
          MOVE      SP70,CLINICAL
          MOVE      SP70,REFRLVIS
.
          MOVE      SP70,BATCHNUM
          MOVE      SP70,EREFRLID
          MOVE      ZERO,VSCMTLIN
.
CLRPAR99  RETURN
+
.------------------------------------------------------------
. Set Parameters
.------------------------------------------------------------
SETPAR00  MATCH     "srchsnam=",QRYNAME
          IF        @EQUAL
            PACK      SRCHSNAM,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "corsp001=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CORSP001
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "noonload=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NOONLOAD
            GOTO      SETPAR99
          ENDIF
          MATCH     "corsp003=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CORSP003
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchgnam=",QRYNAME
          IF        @EQUAL
            PACK      SRCHGNAM,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fltrdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FLTRDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "newprocc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEWPROCC
            PACK      NEWPROCC,NEWPROCC,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startnum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTNUM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "norecord=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NORECORD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "accpordn=",QRYNAME
          IF        @EQUAL
            PACK      ACCPORDN,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nextpage=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTPAGE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "invcasek=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,INVCASEK
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "useinvad=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,USEINVAD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "wahfunct=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,WAHFUNCT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "tmddoctf=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TMDDOCTF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "allwflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ALLWFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "redirect=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REDIRECT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "selprint=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SELPRINT
            MATCH     "S",SELPRINT
            IF        !@EQUAL
              REPLACE   " 0",SELPRINT  * pass 01 to PR not  1
            ENDIF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "schdcopy=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SCHDCOPY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dispt001",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DISPT001
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dispt002",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DISPT002
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "blnkbook=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,BLNKBOOK
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "bookdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,BOOKDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "booktime=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,BOOKTIME
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "bookward=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,BOOKWARD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "bookebed=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,BOOKEBED
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "wathi001=",QRYNAME
          IF        @EQUAL
.            MOVE      QRYDATA,WATHI001
            PACK      WATHI001,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "newbokno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEWBOKNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "reasonfc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REASONFC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "previd01=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PREVID01
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prevtt01=",QRYNAME
          IF        @EQUAL
            PACK      PREVTT01,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "uniqueid=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UNIQUEID
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "docerror=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DOCERROR
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "wathi002=",QRYNAME
          IF        @EQUAL
            MATCH     SP70,QRYDATA
            GOTO      SETPAR99 IF EQUAL
            GOTO      SETPAR99 IF EOS
.
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00              * Set CMON from MTHNAM3
            PACK      WATHI002,CCENT,CYEAR,CMON,CDAY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "wattrcom",QRYNAME
          IF        @EQUAL
            CALL      GETEXT00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "wtpccomm=",QRYNAME
          IF        @EQUAL
            CALL      GETCOM00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "wattr",QRYNAME
          IF        @EQUAL
            CALL      WATTRSET
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "watlh",QRYNAME
          IF        @EQUAL
            CALL      WATLHSET
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "watsu",QRYNAME
          IF        @EQUAL
            CALL      WATSUSET
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "watex",QRYNAME
          IF        @EQUAL
            CALL      WATEXSET
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "watep",QRYNAME
          IF        @EQUAL
            CALL      WATEPSET
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "bkrec",QRYNAME
          IF        @EQUAL
            CALL      BKRECSET
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "wattx",QRYNAME
          IF        @EQUAL
            CALL      SPWTTX00  
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "frstdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FRSTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "lastdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LASTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "vyearmth=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VYEARMTH
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "viewtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VIEWTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updttype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDTTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "urnumber=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,URNUMBER
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "defturno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DEFTURNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admissno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMISSNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "proccode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PROCCODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "doctcode=",QRYNAME
          IF        @EQUAL
            PACK      DOCTCODE,QRYDATA,SP70
.            MOVE      QRYDATA,DOCTCODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "docttype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DOCTTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "unitcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UNITCODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "unitcod2=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UNITCOD2
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "emptdoct=",QRYNAME
          IF        @EQUAL
            PACK      EMPTDOCT,QRYDATA,SP70
.            MOVE      QRYDATA,EMPTDOCT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fltshort=",QRYNAME
          IF        @EQUAL
            PACK      FLTSHORT,QRYDATA,SP70
.            MOVE      QRYDATA,FLTSHORT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "remstats=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REMSTATS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "statcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STATCODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtpast=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILTPAST
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtdoct=",QRYNAME
          IF        @EQUAL
            PACK      FILTDOCT,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "casekeys=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CASEKEYS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "esiskeys=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ESISKEYS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "histkeys=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,HISTKEYS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "phistkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PHISTKEY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "suspkeys=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SUSPKEYS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "catecode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CATECODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "listcode=",QRYNAME
          IF        @EQUAL
.            MOVE      QRYDATA,LISTCODE
            PACK      LISTCODE,QRYDATA
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "intendst=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,INTENDST
            PACK      INTENDST,INTENDST,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ovrdcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OVRDCODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "aihwrept=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,AIHWREPT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "intdhosp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,INTDHOSP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admpoint=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMPOINT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "intdaycs=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,INTDAYCS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "bokrx",QRYNAME
          IF        @EQUAL
            CALL      SPBKRX00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "liststat=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LISTSTAT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "effcdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EFFCDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "neweffdt=",QRYNAME 
          IF        @EQUAL
            MATCH     SP70,QRYDATA
            GOTO      SETPAR99 IF EQUAL
            GOTO      SETPAR99 IF EOS
.
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00              * Set CMON from MTHNAM3
            PACK      NEWEFFDT,CCENT,CYEAR,CMON,CDAY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "newpcodf=",QRYNAME
          IF        @EQUAL
            PACK      NEWPCODF,QRYDATA,SP70
          ENDIF
.
          MATCH     "newpcodt=",QRYNAME
          IF        @EQUAL
            PACK      NEWPCODT,QRYDATA,SP70
          ENDIF
.
          MATCH     "lettreqd=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LETTREQD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "showcomm=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SHOWCOMM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "xmldate1=",QRYNAME
          IF        @EQUAL
            MATCH     SP70,QRYDATA
            GOTO      SETPAR99 IF EQUAL
            GOTO      SETPAR99 IF EOS
.
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00              * Set CMON from MTHNAM3
            PACK      XMLDATE1,CCENT,CYEAR,CMON,CDAY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "xmldate2=",QRYNAME
          IF        @EQUAL
            MATCH     SP70,QRYDATA
            GOTO      SETPAR99 IF EQUAL
            GOTO      SETPAR99 IF EOS
.
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00              * Set CMON from MTHNAM3
            PACK      XMLDATE2,CCENT,CYEAR,CMON,CDAY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "xmlcode1=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,XMLCODE1
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "wattflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,WATTFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trnsfsrc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRNSFSRC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "intrflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,INTRFLAG
            PACK      KEY52,INTRFLAG,SP70
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "newurnum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEWURNUM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "wathi",QRYNAME
          IF        @EQUAL
            CALL      SPWTH000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "bkcnf",QRYNAME
          IF        @EQUAL
            CALL      SPCNF000
            GOTO      SETPAR99
          ENDIF
.  
          MATCH     "takeupfl=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TAKEUPFL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "takebsta=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TAKEBSTA
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nextdkey=",QRYNAME
          IF        @EQUAL
            PACK      NEXTDKEY,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nextukey=",QRYNAME
          IF        @EQUAL
            PACK      NEXTUKEY,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH      "cancelrm=",QRYNAME
          IF         @EQUAL
            MOVE       QRYDATA,CANCELRM
            GOTO       SETPAR99
          ENDIF
.
          MATCH      "multlett=",QRYNAME
          IF         @EQUAL
            MOVE       QRYDATA,MULTLETT
            GOTO       SETPAR99
          ENDIF
.
          MATCH      "waitlett=",QRYNAME
          IF         @EQUAL
            MOVE       QRYDATA,WAITLETT
            GOTO       SETPAR99
          ENDIF
.
          MATCH      "letter01=",QRYNAME
          IF         @EQUAL
            MOVE       QRYDATA,LETTER01
            GOTO       SETPAR99
          ENDIF
.
          MATCH      "letter02=",QRYNAME
          IF         @EQUAL
            MOVE       QRYDATA,LETTER02
            GOTO       SETPAR99
          ENDIF
.
          MATCH      "letter03=",QRYNAME
          IF         @EQUAL
            MOVE       QRYDATA,LETTER03
            GOTO       SETPAR99
          ENDIF
.
          MATCH      "schdcop1=",QRYNAME
          IF         @EQUAL
            MOVE       QRYDATA,SCHDCOP1
            GOTO       SETPAR99
          ENDIF
.
          MATCH      "schdcop2=",QRYNAME
          IF         @EQUAL
            MOVE       QRYDATA,SCHDCOP2
            GOTO       SETPAR99
          ENDIF
.
          MATCH      "schdcop3=",QRYNAME
          IF         @EQUAL
            MOVE       QRYDATA,SCHDCOP3
            GOTO       SETPAR99
          ENDIF
.
          MATCH      "selprin1=",QRYNAME
          IF         @EQUAL
            MOVE       QRYDATA,SELPRIN1
            GOTO       SETPAR99
          ENDIF
.
          MATCH      "selprin2=",QRYNAME
          IF         @EQUAL
            MOVE       QRYDATA,SELPRIN2
            GOTO       SETPAR99
          ENDIF
.
          MATCH      "selprin3=",QRYNAME
          IF         @EQUAL
            MOVE       QRYDATA,SELPRIN3
            GOTO       SETPAR99
          ENDIF
.
          MATCH      "wtlh0021=",QRYNAME
          IF         @EQUAL
            MOVE       QRYDATA,WTLH0021
            GOTO       SETPAR99
          ENDIF
.
          MATCH      "wtlh0022=",QRYNAME
          IF         @EQUAL
            MOVE       QRYDATA,WTLH0022
            GOTO       SETPAR99
          ENDIF
.
          MATCH      "wtlh0023=",QRYNAME
          IF         @EQUAL
            MOVE       QRYDATA,WTLH0023
            GOTO       SETPAR99
          ENDIF
.
          MATCH      "patientl=",QRYNAME
          IF         @EQUAL
            MOVE       QRYDATA,PATIENTL
            GOTO       SETPAR99
          ENDIF
.
          MATCH     "vicmt009",QRYNAME    * Booking confirmation comments
          IF        @EQUAL
            CALL      CLRVCM00            * Create comments temp file
            CALL      SETVCM00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "vicmt010",QRYNAME    * Booking confirmation adm comments
          IF        @EQUAL
            CALL      CLRVCM00            * Create comments temp file
            CALL      SETVCM00
            GOTO      SETPAR99
          ENDIF
.
          MATCH      "labeltyp=",QRYNAME
          IF         @EQUAL
            MOVE       QRYDATA,LABELTYP
            GOTO       SETPAR99
          ENDIF
.
          MATCH      "updtesis=",QRYNAME
          IF         @EQUAL
            MOVE       QRYDATA,UPDTESIS
            GOTO       SETPAR99
          ENDIF
.
          MATCH      "updateky=",QRYNAME
          IF         @EQUAL
            MOVE       QRYDATA,UPDATEKY
            GOTO       SETPAR99
          ENDIF
.
          MATCH      "serbflag=",QRYNAME
          IF         @EQUAL
            MOVE       QRYDATA,SERBFLAG
            GOTO       SETPAR99
          ENDIF
.
          MATCH      "deftview=",QRYNAME
          IF         @EQUAL
            MOVE       QRYDATA,DEFTVIEW
            GOTO       SETPAR99
          ENDIF
.
          MATCH      "updfld01=",QRYNAME
          IF         @EQUAL
            PACK       UPDFLD01,QRYDATA,SP70
            GOTO       SETPAR99
          ENDIF
.
          MATCH      "updfld02=",QRYNAME
          IF         @EQUAL
            PACK       UPDFLD02,QRYDATA,SP70
            GOTO       SETPAR99
          ENDIF
.
          MATCH      "updfld05=",QRYNAME
          IF         @EQUAL
            PACK       UPDFLD05,QRYDATA,SP70
            GOTO       SETPAR99
          ENDIF
.
          MATCH      "updfld07=",QRYNAME
          IF         @EQUAL
            PACK       UPDFLD07,QRYDATA,SP70
            GOTO       SETPAR99
          ENDIF
.
          MATCH      "updfld09=",QRYNAME
          IF         @EQUAL
            PACK       UPDFLD09,QRYDATA,SP70
            GOTO       SETPAR99
          ENDIF
.
          MATCH      "updfld13=",QRYNAME
          IF         @EQUAL
            PACK       UPDFLD13,QRYDATA,SP70
            GOTO       SETPAR99
          ENDIF
.
          MATCH      "reasfc01=",QRYNAME
          IF         @EQUAL
            PACK       REASFC01,QRYDATA,SP70
            GOTO       SETPAR99
          ENDIF
.
          MATCH      "reasfc02=",QRYNAME
          IF         @EQUAL
            PACK       REASFC02,QRYDATA,SP70
            GOTO       SETPAR99
          ENDIF
.
          MATCH      "reasfc05=",QRYNAME
          IF         @EQUAL
            PACK       REASFC05,QRYDATA,SP70
            GOTO       SETPAR99
          ENDIF
.
          MATCH      "reasfc07=",QRYNAME
          IF         @EQUAL
            PACK       REASFC07,QRYDATA,SP70
            GOTO       SETPAR99
          ENDIF
.
          MATCH      "reasfc09=",QRYNAME
          IF         @EQUAL
            PACK       REASFC09,QRYDATA,SP70
            GOTO       SETPAR99
          ENDIF
.
          MATCH      "reasfc13=",QRYNAME
          IF         @EQUAL
            PACK       REASFC13,QRYDATA,SP70
            GOTO       SETPAR99
          ENDIF
.
          MATCH      "reasfc14=",QRYNAME
          IF         @EQUAL
            PACK       REASFC14,QRYDATA,SP70
            GOTO       SETPAR99
          ENDIF
.
          MATCH      "reasfc15=",QRYNAME
          IF         @EQUAL
            PACK       REASFC15,QRYDATA,SP70
            GOTO       SETPAR99
          ENDIF
.
          MATCH      "reasfc17=",QRYNAME
          IF         @EQUAL
            PACK       REASFC17,QRYDATA,SP70
            GOTO       SETPAR99
          ENDIF
.
          MATCH      "notetype=",QRYNAME
          IF         @EQUAL
            PACK       NOTETYPE,QRYDATA,SP70
            GOTO       SETPAR99
          ENDIF
.
          MATCH      "admreqno=",QRYNAME
          IF         @EQUAL
            PACK       ADMREQNO,QRYDATA,SP70
            GOTO       SETPAR99
          ENDIF
.
          MATCH      "notenumb=",QRYNAME
          IF         @EQUAL
            PACK       NOTENUMB,QRYDATA,SP70
            GOTO       SETPAR99
          ENDIF
.
          MATCH     "suprflag=",QRYNAME     
          IF        @EQUAL
            MOVE      QRYDATA,SUPRFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "waitcomm=",QRYNAME
          IF        @EQUAL
            CALL      GETWAT00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admisnid=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMISNID
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "confarry=",QRYNAME
          IF        @EQUAL
SETPAR91    COMPARE   "99",WLKEYEND
            GOTO      SETPAR99 IF EQUAL
            ADD       ONE,WLKEYEND
            PACK      CONFARRY[WLKEYEND],QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptatr",QRYNAME
          IF        @EQUAL
            CALL      SPTATR00
            COMPARE   ZERO,EXIT
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "adcommnt=",QRYNAME
          IF        @EQUAL
            MOVE      ONE,VSCMTFLG
            CALL      GTVISC00              * Read in Adm Comments
          ENDIF
.
          MATCH     "wabmiind=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,WABMIIND
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "clinical=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CLINICAL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "refrlvis=",QRYNAME
          IF        @EQUAL
            PACK      REFRLVIS,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "batchnum=",QRYNAME
          IF        @EQUAL
            PACK     BATCHNUM,QRYDATA,SP70
            GOTO     SETPAR99
          ENDIF
.
          MATCH     "erefrlid=",QRYNAME
          IF        @EQUAL
            PACK     EREFRLID,QRYDATA,SP70
            GOTO     SETPAR99
          ENDIF
.
SETPAR99  RETURN
+
.-------------------------------------------------------------------
WTPRO001  CALL      WTESIS00
          GOTO      PROFLD99
.
WTPRO002  CALL      WTDRG000
          GOTO      PROFLD99
.
WTPRO003  CALL      WTDIF000
          GOTO      PROFLD99
.
WTPRO004  MOVE      "ap",CATEGORY
          MOVE      ADMPOINT,CODE
          CALL      CODSEL00        * Admitting point selection
          GOTO      PROFLD99
.-------------------------------------------------------------------
. Get Text Waiting List Comment
.------------------------------------------------------------
GETEXT00  PREP      COMFILAF,COMFILNM
          ADD       ONE,WTMEEND
          WRITE     COMFILAF,SEQ;QRYDATA
.
GETEXT10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA * Read CONFFILE sequentially
          GOTO      GETEXT80 IF OVER             * If end of file
          MATCH     SP70,QRYNAME                 * If next CGI parameter
          GOTO      GETEXT80 IF NOT EQUAL
          ADD       ONE,WTMEEND                    * Increment Array Counter
          WRITE     COMFILAF,SEQ;QRYDATA
          GOTO      GETEXT10
.
GETEXT80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
          OPEN      COMFILAF,COMFILNM
GETEXT99  RETURN
.-------------------------------------------------------------------
. Pre - Admission Comments
.-------------------------------------------------------------------
GETCOM00  PREP      COMPREAF,COMPRENM
          ADD       ONE,WTPAEND
          WRITE     COMPREAF,SEQ;QRYDATA
.
GETCOM10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA * Read CONFFILE sequentially
          GOTO      GETCOM80 IF OVER             * If end of file
          MATCH     SP70,QRYNAME                 * If next CGI parameter
          GOTO      GETCOM80 IF NOT EQUAL
          ADD       ONE,WTPAEND
          WRITE     COMPREAF,SEQ;QRYDATA
          GOTO      GETCOM10
.
GETCOM80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
          OPEN      COMPREAF,COMPRENM
GETCOM99  RETURN
.------------------------------------------------------------
. Set Input Variables
.------------------------------------------------------------
WATLHSET  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          PACK      QRYDATA,QRYDATA,SP70
          STORE     QRYDATA,F3,WATLH001,WATLH002,WATLH003,WATLH004
          RETURN
.
WATSUSET  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          PACK      QRYDATA,QRYDATA,SP70
          STORE     QRYDATA,F3,WATSU001,WATSU002,WATSU003,WATSU004:
                    WATSU005,WATSU006
          RETURN
.------------------------------------------------------------
. Set Input Variables
.------------------------------------------------------------
WATEXSET  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          PACK      QRYDATA,QRYDATA,SP70
          STORE     QRYDATA,F3,WATEX001,WATEX002,WATEX003,WATEX004,WATEX005:
                               WATEX006,WATEX007,WATEX008,WATEX009,WATEX010:
                               WATEX011,WATEX012,WATEX013,WATEX014,WATEX015:
                               WATEX016,WATEX017,WATEX018,WATEX019,WATEX020:
                               WATEX021,WATEX022,WATEX023,WATEX024,WATEX025:
                               WATEX026,WATEX027,WATEX028,WATEX029,WATEX030:
                               WATEX031,WATEX032,WATEX033,WATEX034,WATEX035:
                               WATEX036,WATEX037,WATEX038,WATEX039,WATEX040:
                               WATEX041,WATEX042,WATEX043,WATEX044,WATEX045:
                               WATEX046,WATEX047,WATEX048,WATEX049,WATEX050:
                               WATEX051,WATEX052,WATEX053,WATEX054,WATEX055:
                               WATEX056,WATEX057,WATEX058,WATEX059,WATEX060:
                               WATEX061,WATEX062,WATEX063,WATEX064,WATEX065:
                               WATEX066



          RETURN
.------------------------------------------------------------
. Set Input Variables
.------------------------------------------------------------
WATEPSET  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          PACK      QRYDATA,QRYDATA,SP70
          STORE     QRYDATA,F3,WATEP001,WATEP002,WATEP003,WATEP004,WATEP005
.
          RETURN
.------------------------------------------------------------
. Set Input Variables
.------------------------------------------------------------
BKRECSET  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          PACK      QRYDATA,QRYDATA,SP70
          STORE     QRYDATA,F3,BKREC001,BKREC002,BKREC003,BKREC004,BKREC005:
                               BKREC006,BKREC007,BKREC008,BKREC009,BKREC010:
                               BKREC011,BKREC012,BKREC013,BKREC014,BKREC015:
                               BKREC016,BKREC017,BKREC018,BKREC019,BKREC020:
                               BKREC021,BKREC022,BKREC023,BKREC024,BKREC025:
                               BKREC026,BKREC027,BKREC028,BKREC029,BKREC030:
                               BKREC031,BKREC032,BKREC033,BKREC034,BKREC035:
                               BKREC036,BKREC037,BKREC038,BKREC039
          RETURN
.------------------------------------------------------------
. Set Input Variables
.------------------------------------------------------------
WATTRSET  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          PACK      QRYDATA,QRYDATA,SP70
          STORE     QRYDATA,F3,WATTR001,WATTR002,WATTR003,WATTR004,WATTR005:
                               WATTR006,WATTR007,WATTR008,WATTR009,WATTR010:
                               WATTR011,WATTR012,WATTR013,WATTR014,WATTR015:
                               WATTR016,WATTR017,WATTR018,WATTR019,WATTR020:
                               WATTR021,WATTR022,WATTR023,WATTR024,WATTR025:
                               WATTR026,WATTR027,WATTR028,WATTR029,WATTR030:
                               WATTR031,WATTR032,WATTR033,WATTR034,WATTR035:
                               WATTR036,WATTR037,WATTR038,WATTR039,WATTR040:
                               WATTR041,WATTR042,WATTR043,WATTR044,WATTR045:
                               WATTR046,WATTR047,WATTR048,WATTR049,WATTR050:
                               WATTR051,WATTR052,WATTR053,WATTR054,WATTR055:
                               WATTR056,WATTR057,WATTR058,WATTR059,WATTR060:
                               WATTR061
          RETURN
.-------------------------------------------------------------------------
.Mapped ESIS Code
.------------------------------------------------------------------------
WTESIS00  PACK      KEY9,WMCODE,SP70
          CALL      RDPROA1
          BRANCH    OVRCD,WTESIS99
.
. *** check if there is a record ending on the date entered *****
          PACK      KEY17,WMCODE,WMKEYDT,SP70
          CALL      RDWTPHI1
          BRANCH    OVRCD,WTESIS10
.
          GOTO      WTESIS40
.
. **** read last record on the procedure HDP history table
WTESIS10  PACK      KEY17,WMCODE,WMKEYDT,SP70
          CALL      RSWTPHI1
          CALL      RKWTPHI1
          BRANCH    OVRCD,WTESIS50
.
          MATCH     WMCODE,WTPHPROC
          GOTO      WTESIS50 IF NOT EQUAL
.
WTESIS40  PACK      WTWPHDPE,WTPHHDPV,SP70
.
WTESIS50  SQUEEZE   WTWPHDPE
          PACK      WTWPHDPE,WTWPHDPE,SP5

          WRITE     HTMLFILE;WTWPHDPE
.
WTESIS99  RETURN
.-------------------------------------------------------------------------
.DRG Code
.-------------------------------------------------------------------------
WTDRG000  PACK      KEY9,WMCODE,SP70
          CALL      RDPROA1
          BRANCH    OVRCD,WTDRG999
          WRITE     HTMLFILE;WTWPDRGC;
.
WTDRG999  RETURN
.-------------------------------------------------------------------------
.Reportable
.-------------------------------------------------------------------------
WTREP000  PACK      KEY9,WMCODE,SP70
          CALL      RDPROA1
          BRANCH    OVRCD,WTREP999
.
          MOVE      ZERO,FORM6
          SQUEEZE   WPRHAT
          MOVE      WPRHAT,FORM6
          RESET     WPRHAT
.
          IF        FORM6=1
            WRITE     HTMLFILE;DYES;
          ELSE
            WRITE     HTMLFILE;DNO;
          ENDIF
.
WTREP999  RETURN
.--------------------------------------------------------------------------
. Proposed Admn Date
WTDIF000
.
WTDIF999  RETURN
.------------------------------------------------------------
. Waiting Case List 
.------------------------------------------------------------
WATLST00  CALL      CLWATDET
.
          MATCH     SP70,DOCTCODE
          IF        @EQUAL
            MATCH     "1",EMPTDOCT
            IF        !@EQUAL
              MOVE      WBSEDOC,DOCTCODE
            ELSE
              CALL      CLPATDOC
              GOTO      WATLST50
            ENDIF
          ENDIF
.
          MOVE      DOCTCODE,KEY6
          CALL      RDDOCT1
          IF        OVRCD=1
            CALL      CLPATDOC
          ENDIF
.
WATLST50  MOVE      "Waiting List",WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,WATLST99
.
          CALL      WEBBOD00
.
          CALL      WEBEND00
          GOTO      WATLST99
.
WATLST95  MOVE      "INVALID SECURITY FOR WAITING LIST",WEBTITLE
          CALL      WEBERR00
.
WATLST99  RETURN
.----------------------------------------------------------------------
. Output Table of Waiting List Patients
.----------------------------------------------------------------------
WLST0000  BRANCH    FLDITMNO,WLST0100,WLST0200,WLST0300,WLST0400,WLST0500:
                             WLST0600,WLST0700,WLST0800,WLST0900,WLST1000:
                             WLST1100,WLST1200,WLST1300,WLST1400,WLST1500:
                             WLST1600,WLST1700,WLST1800,WLST1900,WLST2000:
                             WLST2100,WLST2200,WLST2300,WLST2400,WLST2500:
                             WLST2600,WLST2700,WLST2800,WLST2900
.
          WRITE     HTMLFILE;"Invalid Tag";
          GOTO      WLST9999
.
WLST0100  MOVE      ZERO,LINKTYPE   * Link to Detail Waiting List Screen
          CALL      WATTAB00        * Waiting List by Doctor
          GOTO      WLST9999
.
WLST0200  CALL      DOCDET00
          GOTO      WLST9999
.
WLST0300  MOVE      ONE,LINKTYPE    * Link to U/R Based Screen
          CALL      WATTAB00        * Waiting List by Doctor
          GOTO      WLST9999
.
WLST0400  MOVE      ZERO,LINKTYPE   * Link to Detail Waiting List Screen
          CALL      UNTTAB00        * Waiting List by Unit
          GOTO      WLST9999
.
WLST0500  MOVE      ONE,LINKTYPE    * Link to U/R Based Screen
          CALL      UNTTAB00        * Waiting List by Unit
          GOTO      WLST9999
.
WLST0600  MOVE      "WU",CATEGORY
          MOVE      UNITCODE,CODE
          CALL      CODSEL00        * Waiting List by Unit
          GOTO      WLST9999
.
WLST0700  CALL      STALST00
          GOTO      WLST9999
.
WLST0800  MOVE      "DL",CATEGORY
          MOVE      DOCTTYPE,CODE
          CALL      CODSEL00        * Doctor Type
          GOTO      WLST9999
.
WLST0900  CALL      DOCSEL00        * Select List of Doctors List by Doctor Type
          GOTO      WLST9999
.
WLST1000  MOVE      "TP",CATEGORY
          MOVE      CATECODE,CODE
          CALL      CODSEL00        * Category selection
          GOTO      WLST9999
.
WLST1100  MOVE      "VL",CATEGORY
          MOVE      LISTCODE,CODE
          CALL      CODSEL00        * Listing status selection
          GOTO      WLST9999
.
WLST1200  MATCH     "1",OVRDCODE
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=0 >":
                               "All</option>";
            WRITE     HTMLFILE;"<option value=1 selected>":
                               "Overdue Only</option>";
          ELSE
            WRITE     HTMLFILE;"<option value=0 selected >":
                               "All</option>";
            WRITE     HTMLFILE;"<option value=1>":
                               "Overdue Only</option>";
          ENDIF  
          GOTO      WLST9999
.
WLST1300  MOVE      "ap",CATEGORY
          MOVE      ADMPOINT,CODE
          CALL      CODSEL00        * Admitting point selection
          GOTO      WLST9999   
.
WLST1400  MOVE      "XB",CATEGORY
          MOVE      INTDAYCS,CODE
          CALL      CODSEL00        * Intended day case selection
          GOTO      WLST9999
.
WLST1500  MATCH     SP70,SRCHSNAM
          GOTO      WLST9999 IF EQUAL
          WRITE     HTMLFILE;SRCHSNAM;
          GOTO      WLST9999
.
WLST1600  MATCH     SP70,SRCHGNAM
          GOTO      WLST9999 IF EQUAL
          WRITE     HTMLFILE;SRCHGNAM;
          GOTO      WLST9999
.
WLST1700  MATCH     "1",STATCODE
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=1 selected>",WAITST01,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=1>",WAITST01,"</option>"
          ENDIF
          MATCH     "2",STATCODE
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=2 selected>",WAITST02,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=2>",WAITST02,"</option>"
          ENDIF
          GOTO      WLST9999
.
WLST1800  CALL      WATENQ00
          GOTO      WLST9999
.
WLST1900  CALL      WATUNS00
          GOTO      WLST9999
.
WLST2000  MOVE      "XG",CATEGORY
          MOVE      FILTPAST,CODE
          CALL      CODSEL00        * Pre Admission Status
          GOTO      WLST9999
.
WLST2100  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,WLST2110
.
          PACK      KEY6,FILTDOCT,SP70
          CALL      RDDOCT1
          BRANCH    OVRCD,WLST9999
.
          MOVE      DTITL,FMTTITLE
          MOVE      DGNAME,FMTGNAME
          MOVE      DSNAME,FMTSNAME
          CALL      DOCNM000
          WRITE     HTMLFILE;DOCFNAME;
          GOTO      WLST9999
.
WLST2110  WRITE     HTMLFILE;FILTDOCT;
          GOTO      WLST9999
.
WLST2200  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      WLST9999
.
WLST2300  WRITE     HTMLFILE;DEFTVIEW;
          GOTO      WLST9999
.
WLST2400  MOVE      ZERO,LINKTYPE   * Link to Detail Waiting List Screen
          MOVE      ONE,CHECKGP
          CALL      WATTAB00        * Waiting List by GP
          GOTO      WLST9999
.
WLST2500  MATCH     " ",AIHWREPT
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#" #" selected>":
                               "All</option>";
          ELSE
            WRITE     HTMLFILE;"<option value=#" #">":
                               "All</option>";
          ENDIF
          MATCH     "0",AIHWREPT
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=0 selected>":
                               "No</option>";
          ELSE
            WRITE     HTMLFILE;"<option value=0>":
                               "No</option>";
          ENDIF
          MATCH     "1",AIHWREPT
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=1 selected>":
                               "Yes</option>";
          ELSE
            WRITE     HTMLFILE;"<option value=1>":
                               "Yes</option>";
          ENDIF
          GOTO      WLST9999
.
WLST2600  PACK      D3,INTDHOSP
          MATCH     SP70,INTDHOSP
          IF        @EQUAL
            PACK      D3,WBSEHOSP,SP70
          ENDIF
          CALL      HOSSEL00
          GOTO      WLST9999
.
WLST2700  WRITE     HTMLFILE;UNITCOD2;
          GOTO      WLST9999
.
WLST2800  WRITE     HTMLFILE;CLINICAL;
          GOTO      WLST9999
.
WLST2900  MOVE      "VI",CATEGORY
          MOVE      INTENDST,CODE
          CALL      CODSEL00        * Intended stay
          GOTO      WLST9999
.
WLST9999  RETURN
.----------------------------------------------------------------------------
. Unscheduled Overdue Waiting List Enquiry
.----------------------------------------------------------------------------
WATUNS00  MOVE      ZERO,RECCOUNT
          COMPARE   ONE,NOONLOAD
          GOTO      WATUNS99 IF EQUAL
.         MATCH     SP70,CATECODE
.         GOTO      WATUNS99 IF EQUAL
.
          PACK      KEY20,ONE,SP30
          CALL      RDSTREA2
WATUNS10  CALL      RDKTREA2
          BRANCH    OVRCD,WATUNS99          * end of file
          COMPARE   ONE,WMSTAT
          GOTO      WATUNS20 IF EQUAL       * Check Status
.
          COMPARE   NINE,WMSTAT
          GOTO      WATUNS20 IF EQUAL
.
          PACK      KEY20,NINE,SP30
          CALL      RDSTREA2
          GOTO      WATUNS10
.
WATUNS20  MATCH     SP70,INTDHOSP
          IF        @EQUAL
            PACK      INTDHOSP,WBSEHOSP,SP70
          ENDIF
.
          IF        IBCNMHOS = 1
            MATCH     SP70,WTWMIHSP
            IF        !@EQUAL
              MATCH     WTWMIHSP,INTDHOSP
              GOTO      WATUNS10 IF NOT EQUAL
            ENDIF
          ENDIF
.

WATUNS30  MATCH     SP70,CATECODE
          IF        !@EQUAL
            MATCH     CATECODE,WMPTY
            GOTO      WATUNS10 IF NOT EQUAL
          ENDIF
.
          MOVE      "TP",CATEGORY
          MOVE      WMPTY,CODE
          CALL      GETCOD00
          MOVE      TDESC,PRIODESC
          MATCH     "3",TCINDC3           * dont include priority 3 WL 10079
          GOTO      WATUNS10 IF EQUAL
.
          MOVE      WMURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,WATUNS10
          CALL      RDPMPX21
          BRANCH    OVRCD,WATUNS10 
.
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
          CALL      PATLN000           * Format names
.
          PACK      KEY19,WMURNO,WMCODE,WMCNT
          CALL      RDWTTX11
          IF        OVRCD=1
            CALL      CLWATTX1
          ENDIF
.
          MATCH     ZEROVISN,WMBOOK
          IF        @EQUAL
            CALL      CLBKRX00
          ELSE
            MOVE      WMBOOK,KEY8
            CALL      RDBKRX11
            IF        OVRCD=1
              CALL      CLBKRX00
            ENDIF
          ENDIF
.
          MOVE      "WU",CATEGORY
          MOVE      WMUNIT,CODE
          CALL      GETCOD00
          MOVE      TDESC,UNITDESC
.
          MOVE      "ap",CATEGORY
          MOVE      WTTXADMW,CODE
          CALL      GETCOD00
          MOVE      TDESC,ADMPDESC
.
          LOAD      STATDESC,WMSTAT,WAITST01,WAITST02
          IF        WMSTAT = 9
            MOVE      WAITST09,STATDESC
          ENDIF
          MOVE      WMBOOK,KEY8
          CALL      RDBKREC1
          IF        OVRCD=0
..            IF        BKRESTAT=2
..              MOVE      "Cancelled Adm.",STATDESC
..            ENDIF
          ENDIF
.
          CALL      FLTUNS00
          BRANCH    EXIT,WATUNS10
.
          MOVE      "VL",CATEGORY
          MOVE      WTTXPLST,CODE
          CALL      GETCOD00
          MOVE      TDESC,PRIOSTAT
.
          MOVE      SP70,DOCFNAME
          MOVE      WMDOCTOR,KEY6
          CALL      RDDOCT1
          MOVE      DGNAME,ANS
          MOVE      DTITL,FMTTITLE            * I CAR 13038
          MOVE      DGNAME,FMTGNAME
          MOVE      DSNAME,FMTSNAME
          CALL      DOCNM000                  * end I CAR 13038
.
          CALL      LSTDAY00
.
          MOVE      ZERO,NRCDAYS
          CALL      NRCDF000
          MOVE      "TP",CATEGORY
          MOVE      WMPTY,CODE
          CALL      GETCOD00
          MOVE      TDESC,PRIODESC
          CALL      COVER000
          CALL      NEWOVR00
.          MATCH     "1",OVRDCODE            * Check overdue patients
.          IF        @EQUAL
          MATCH     "1",OVERSTAT
          GOTO      WATUNS10 IF NOT EQUAL
.          ENDIF
.
          CALL      NRCDAY00
.
          MOVE      LSTDAYS,RFCDAYS
          SUB       NRCDAYS,RFCDAYS
.
          MOVE      SP70,PRPBDESC
          MOVE      "yh",CATEGORY
          MOVE      WTTXPRPB,CODE
          CALL      GETCOD00
          MOVE      TDESC,PRPBDESC
.
          MOVE      SP70,INTSDESC
          MOVE      "VI",CATEGORY
          MOVE      WTTXINTD,CODE
          CALL      GETCOD00
          MOVE      TDESC,INTSDESC
.

WATUNS80  CLEAR     HTMLLINK
          APPEND    "javascript:LinkTo('",HTMLLINK
          APPEND    WMURNO,HTMLLINK
          APPEND    WMCODE,HTMLLINK
          APPEND    WMCNT,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",WMDATE1,"#",":     * 1
                             "#"",WMDATE2,"#",":     * 2
                             "#"",FORMATNM,"#",":    * 3
                             "#"",DISPSEX,"#",":     * 4
                             "#"",WMURNO,"#",":      * 5
                             "#"",STATDESC,"#",":    * 6
                             "#"",WMUNIT,"#",":      * 7
                             "#"",UNITDESC,"#",":    * 8
                             "#"",WTTXADMW,"#",";    * 9
.                                            * Display Procedure Description
.                                            * comments only if they exist
          MATCH     SP70,WTWMPDSC
          STRIP     WMDESC
          MOVELPTR  WMDESC,F3
          SFORMAT   DISPVAR1,F3
          MOVE      WMDESC,DISPVAR1
          IF        @EQUAL
            WRITE     HTMLFILE;"#"",DISPVAR1,"#",";   *10
          ELSE
            STRIP     WTWMPDSC
          STRIP     WMDESC
            MOVELPTR  WTWMPDSC,F3
            SFORMAT   DISPVAR2,F3
            MOVE      WTWMPDSC,DISPVAR2
            WRITE     HTMLFILE;"#"",DISPVAR1,"<br />",DISPVAR2,"#","; *10
          ENDIF
          SFORMAT   DISPVAR1,127
          SFORMAT   DISPVAR2,127
.
          MOVE      ZERO,HOSPOST
          CALL      WATHPT00
.
          WRITE     HTMLFILE;"#"",WMCODE,"#",":      * 11
                             "#"",WMDATE3,"#",":     * 12
                             "#"",WTTXPLST,"#",":    * 13
                             "#"",PRIOSTAT,"#",":    * 14
                             "#"",WMPTY,"#",":       * 15
                             "#"",PRIODESC,"#",":    * 16
                             "#"",BKRXCDTE,"#",":    * 17
                             "#"",WTWMDEDA,"#",":    * 18
                             "#"",OVERSTAT,"#",":    * 19
                             "#"",OVERDATE,"#",":    * 20
                             "#"",WTWMECNT,"#",":    * 21
                             "#"",WTWMDTAD,"#",":    * 22
                             "#"",LSTDAYS,"#",":     * 23
                             "#"",DOCFNAME,"#",":    * 24
                             "#"",ADMPDESC,"#",":    * 25
                             "#"",RFCDAYS,"#",":     * 26
                             "#"",PRPBDESC,"#",":    * 27
                             "#"","H: ",PTELEP,"<br>":
                             "B: ",PTELEB,"<br>":
                             "M: ",PTMXCELL,"#",":   * 28
                             "#"",WMSTAY,"#",":      * 29
                             "#"",HOSPOST,"#",":     * 30
                             "#"","javascript:DoctorViewFrame('":
                             WMDOCTOR,"');#",": *31
                             "#"",INTSDESC,"#");"    * 32

          ADD      ONE,RECCOUNT
          IF       RECCOUNT<LISTLIMT
            GOTO     WATUNS10
          ENDIF
.
          WRITE     HTMLFILE;"alert('Too Many Patients to View');"
.
WATUNS99  RETURN
.----------------------------------------------------------------------
. Filter Unscheduled Patient List
.----------------------------------------------------------------------
FLTUNS00  MOVE      ZERO,EXIT
.
.         COMPARE   NINE,WMSTAT             * Skip suspended procedures
.         GOTO      FLTUNS90 IF EQUAL
.
          MATCH     SP70,UNITCODE
          IF        !@EQUAL
            MATCH     UNITCODE,WMUNIT
            GOTO      FLTUNS90 IF NOT EQUAL 
          ENDIF
.
          MATCH     SP70,LISTCODE           * Check list status
          IF        !@EQUAL
            MATCH     LISTCODE,WTTXPLST
            GOTO      FLTUNS90 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,INTENDST           * Check intended stay
          IF        !@EQUAL
            MATCH     INTENDST,WTTXINTD
            GOTO      FLTUNS90 IF NOT EQUAL
          ENDIF
.
          GOTO      FLTUNS99
.
FLTUNS90  MOVE      ONE,EXIT
.
FLTUNS99  RETURN
.----------------------------------------------------------------------------
. Waiting List Enquiry
.----------------------------------------------------------------------------
WATENQ00  MATCH     SP70,STATCODE
          GOTO      WATENQ99 IF EQUAL
          PACK      KEY20,STATCODE,SP30
          CALL      RDSTREA2
WATENQ10  CALL      RDKTREA2
          BRANCH    OVRCD,WATENQ99          * end of file
          MOVE      STATCODE,F1
          COMPARE   F1,WMSTAT
          GOTO      WATENQ99 IF NOT EQUAL   * Check Status
.
          MOVE      WMURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,WATENQ10
          CALL      RDPMPX21
          BRANCH    OVRCD,WATENQ10 
.
          MATCH     SP70,SRCHSNAM
          IF        !@EQUAL
            MOVE      SRCHSNAM,KEY20
            STRIP     KEY20
            MATCH     KEY20,PSNAME
            GOTO      WATENQ10 IF NOT EQUAL
          ENDIF
          MATCH     SP70,SRCHGNAM
          IF        !@EQUAL
            MOVE      SRCHGNAM,KEY20
            STRIP     KEY20
            MATCH     KEY20,PGNAME
            GOTO      WATENQ10 IF NOT EQUAL
          ENDIF
.
          CALL      PATLN000           * Format names
.
          PACK      KEY19,WMURNO,WMCODE,WMCNT
          CALL      RDWTTX11
          IF        OVRCD=1
            CALL      CLWATTX1
          ENDIF
.
          MATCH     ZEROVISN,WMBOOK
          IF        @EQUAL
            CALL      CLBKRX00
          ELSE
            MOVE      WMBOOK,KEY8
            CALL      RDBKRX11
            IF        OVRCD=1
              CALL      CLBKRX00
            ENDIF
          ENDIF
.
          MOVE      "WU",CATEGORY
          MOVE      WMUNIT,CODE
          CALL      GETCOD00
          MOVE      TDESC,UNITDESC
          LOAD      STATDESC,WMSTAT,WAITST01,WAITST02
          IF        WMSTAT = 9
            MOVE      WAITST09,STATDESC
          ENDIF
          MOVE      WMBOOK,KEY8
          CALL      RDBKREC1
          IF        OVRCD=0
..            IF        BKRESTAT=2
..              MOVE      "Cancelled Adm.",STATDESC
..            ENDIF
          ENDIF
.
          MOVE      "VL",CATEGORY
          MOVE      WTTXPLST,CODE
          CALL      GETCOD00
          MOVE      TDESC,PRIOSTAT
.
          MOVE      "TP",CATEGORY
          MOVE      WMPTY,CODE
          CALL      GETCOD00
          MOVE      TDESC,PRIODESC

          CLEAR     HTMLLINK
          APPEND    "javascript:LinkTo('",HTMLLINK
          APPEND    WMURNO,HTMLLINK
          APPEND    WMCODE,HTMLLINK
          APPEND    WMCNT,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",WMDATE1,"#",":     * 1
                             "#"",WMDATE2,"#",":     * 2
                             "#"",FORMATNM,"#",":    * 3
                             "#"",DISPSEX,"#",":     * 4
                             "#"",WMURNO,"#",":      * 5
                             "#"",STATDESC,"#",":    * 6
                             "#"",WMUNIT,"#",":      * 7
                             "#"",UNITDESC,"#",":    * 8
                             "#"",WTTXADMW,"#",":    * 9
                             "#"",WMDESC,"#",":      * 10
                             "#"",WMCODE,"#",":      * 11
                             "#"",WMDATE3,"#",":     * 12
                             "#"",WTTXPLST,"#",":    * 13
                             "#"",PRIOSTAT,"#",":    * 14
                             "#"",WMPTY,"#",":       * 15
                             "#"",PRIODESC,"#",":    * 16
                             "#"",BKRXCDTE,"#",":    * 17
                             "#"",WTWMDEDA,"#");"    * 18
          GOTO     WATENQ10
.
WATENQ99  RETURN
.----------------------------------------------------------------------
. Output Status Options
.----------------------------------------------------------------------
STALST00  MOVE      ZERO,F1
STALST10  ADD       ONE,F1
          LOAD      STATDESC,F1,WAITST01,WAITST02,WAITST03,WAITST04,WAITST05:
.                               WAITST06,WAITST07,WAITST08
                                WAITST06
          MOVE      F1,ANS
          MATCH     ANS,STATCODE
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",F1," selected>":
                               STATDESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",F1,">",STATDESC,"</option>"
          ENDIF
.         IF        F1<8
          IF        F1<6
            GOTO      STALST10
          ENDIF
STALST99  RETURN
.----------------------------------------------------------------------
. Output Status Options
.----------------------------------------------------------------------
STTLST00  MOVE      ZERO,F1
STTLST10  ADD       ONE,F1
          LOAD      STATDESC,F1,WAITST01,WAITST02,WAITST03,WAITST04,WAITST05:
                               WAITST06,WAITST07,WAITST08,WAITST09
          IF        F1=7
            GOTO      STTLST10
          ENDIF
          IF        F1=8
            GOTO      STTLST10
          ENDIF
          MOVE      F1,ANS
          MATCH     ANS,STATCODE
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",F1," selected>":
                               STATDESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",F1,">",STATDESC,"</option>"
          ENDIF
.         IF        F1<8
          IF        F1<9
            GOTO      STTLST10
          ENDIF
STTLST99  RETURN
+
.----------------------------------------------------------------------
. Output Status Options for Short Notice W/L list
.----------------------------------------------------------------------
SNALST00  MOVE      ZERO,F1
SNALST10  ADD       ONE,F1
          LOAD      STATDESC,F1,WAITST01,WAITST02,WAITST03,WAITST04,WAITST05:
                                WAITST06
          MOVE      F1,ANS
          MATCH     ANS,STATCODE
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",F1," selected>":
                               STATDESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",F1,">",STATDESC,"</option>"
          ENDIF
          IF        F1<6
            GOTO      SNALST10
          ENDIF
SNALST99  RETURN
+
.----------------------------------------------------------------------
. Output Table of Waiting List Patients by Doctor
.----------------------------------------------------------------------
WATTAB00  UNPACK    DIM127,D1,LINKPRG,DIM127 
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          MOVE      ZERO,RECCOUNT
          MOVE      SP1,DIM1
          MOVE      ZERO,FORM8
          MOVE      ZERO,F8
.
          IF        CHECKGP=1
            MOVE      SP70,DOCTCODE
            MATCH     SP70,STATCODE
            GOTO      WATTAB90 IF EQUAL
            GOTO      WATTAB05
          ENDIF
.
          MATCH     SP70,DOCTCODE
          GOTO      WATTAB85 IF EQUAL
.
WATTAB05  MATCH     SP70,NEXTDKEY
          IF        !@EQUAL
            PACK      KEY32,NEXTDKEY,SP70
            CALL      RDTREA5
            BRANCH    OVRCD,WATTAB90          * end of file
            GOTO      WATTAB15
          ENDIF
.
          IF        CHECKGP=1
            PACK      KEY32,STATCODE,SP70
          ELSE
            PACK      KEY32,STATCODE,DOCTCODE,SP70
          ENDIF
          CALL      RDSTREA5
WATTAB10  CALL      RDKTREA5
          BRANCH    OVRCD,WATTAB90          * end of file
.
WATTAB15  MOVE      STATCODE,F1
          COMPARE   F1,WMSTAT
          GOTO      WATTAB90 IF NOT EQUAL   * Check Status
          IF        CHECKGP=1
            PACK      KEY8,WMURNO,SP70
            CALL      RDPMPX21
            IF        OVRCD<>1
              CALL      CHGP0000
              BRANCH    EXIT,WATTAB10
            ENDIF
          ENDIF
.
          MATCH     SP70,DOCTCODE
          IF        !@EQUAL|@EOS
            MATCH     DOCTCODE,WMDOCTOR
            GOTO      WATTAB90 IF NOT EQUAL   * Check Doctor
          ENDIF
.
          MATCH     SP70,INTDHOSP
          IF        @EQUAL
            PACK      INTDHOSP,WBSEHOSP,SP70
          ENDIF
.
          IF        IBCNMHOS = 1
            MATCH     SP70,WTWMIHSP
            IF        !@EQUAL
              MATCH     WTWMIHSP,INTDHOSP
              GOTO      WATTAB10 IF NOT EQUAL
            ENDIF
          ENDIF
.  
          MATCH     SP70,AIHWREPT
          GOTO      WATTAB20 IF EQUAL
.
          PACK      KEY9,WMCODE,SP70
          CALL      RDPROA1
          BRANCH    OVRCD,WATTAB10
.
          MOVE      ZERO,FORM6
          SQUEEZE   WPRHAT
          MOVE      WPRHAT,FORM6
          RESET     WPRHAT
.
          MATCH     "0",AIHWREPT
          IF        @EQUAL
            COMPARE   ZERO,FORM6
            GOTO      WATTAB10 IF NOT EQUAL
          ENDIF
.
          MATCH     "1",AIHWREPT
          IF        @EQUAL
            COMPARE   ONE,FORM6
            GOTO      WATTAB10 IF NOT EQUAL
          ENDIF
.
WATTAB20  PACK      KEY19,WMURNO,WMCODE,DWMCNT
          CALL      RDWTTX11
          IF        OVRCD=1
            CALL      CLWATTX1
          ENDIF
.
          MATCH     SP70,CATECODE           * Check selected category
          IF        !@EQUAL
            MATCH     CATECODE,WMPTY
            GOTO      WATTAB10 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTPAST           * Pre Admission Status
          IF        !@EQUAL
            MATCH     FILTPAST,WTTXPAST
            GOTO      WATTAB10 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,LISTCODE           * Check list status
          IF        !@EQUAL
            MATCH     LISTCODE,WTTXPLST
            GOTO      WATTAB10 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,ADMPOINT           * Check admission point
          IF        !@EQUAL
            MATCH     ADMPOINT,WTTXADMW
            GOTO      WATTAB10 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,UNITCODE           * Check Unit Code
          IF        !@EQUAL
            MATCH     UNITCODE,WMUNIT
            GOTO      WATTAB10  IF NOT EQUAL  
          ENDIF
.
          MATCH     SP70,INTDAYCS           * Check intended day case
          IF        !@EQUAL
            MATCH     INTDAYCS,WTTXIDYC
            GOTO      WATTAB10 IF NOT EQUAL
          ENDIF
.
          MATCH     "       0",WMURNO
          IF        @EQUAL
            MOVE      WMURNO,KEY8           * visit number
            UNPACK    KEY8,KEY2,KEY6          * r5
            CALL      RDPRAM1
            MOVE      ZERO,PURNO
          ELSE
            PACK      KEY8,WMURNO           * r5
            UNPACK    KEY8,KEY2,KEY6          * r5
            CALL      RDMAST1
            CALL      RDPMPX21
          ENDIF
.
          CALL      GETSEX00
.
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
          CALL      CASLNK00
.
          MOVE      "S ",CATEGORY
          MOVE      WTWMSRCR,CODE
          CALL      GETCOD00
          MOVE      TDESC,SRCRDESC
          MOVE      "WU",CATEGORY
          MOVE      WMUNIT,CODE
          CALL      GETCOD00
          MOVE      TDESC,UNITDESC
.
          MOVE      "VL",CATEGORY
          MOVE      WTTXPLST,CODE
          CALL      GETCOD00
          MOVE      TDESC,PRIOSTAT
.
          MOVE      "XG",CATEGORY
          MOVE      WTTXPAST,CODE
          CALL      GETCOD00
          MOVE      TDESC,DIM19
.
          MOVE      "ap",CATEGORY
          MOVE      WTTXADMW,CODE
          CALL      GETCOD00
          MOVE      TDESC,ADMPDESC
.
          MOVE      SP10,PTWDSDES
          PACK      KEY6,WTTXWARD,SP70
          CALL      RDWARD1
.
          MOVE      ZERO,NRCDAYS
          MOVE      "TP",CATEGORY
          MOVE      WMPTY,CODE
          CALL      GETCOD00
          MOVE      TDESC,PRIODESC
.
          CALL      COVER000                * Check Overdue
. 
          ASSIGN    (LSTDAYS-NRCDAYS),RFCDAYS
          IF        RFCDAYS < 1
            ASSIGN    ZERO,RFCDAYS
          ENDIF
.
          CALL      NEWOVR00         * New overdue calculation
.
          MATCH     "1",OVRDCODE            * Check overdue patients
          IF        @EQUAL
            MATCH     "1",OVERSTAT
            GOTO      WATTAB10 IF NOT EQUAL
          ENDIF
.
          PACK      GENPNAME,SP70
          PACK      KEY10,WTWMRFGP,SP70
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCGNAM,KEY1
            PACK      GENPNAME,PMHCSNAM,COMMA,KEY1,SP70
            SQUEEZE   GENPNAME
          ENDIF
.
          MOVE      ZERO,COMMFLAG
          PACK      KEY21,WMURNO,WMCODE,DWMCNT,SP70
          CALL      RDSMESA1
WATTAB50  CALL      RDKMESA1
          BRANCH    OVRCD,WATTAB60
.
          MATCH     WMURNO,WAURNO                * Same Person and procedure
          GOTO      WATTAB60 IF NOT EQUAL
          MATCH     WMCODE,WAPROC
          GOTO      WATTAB60 IF NOT EQUAL
          MATCH     DWMCNT,DWACNT
          GOTO      WATTAB60 IF NOT EQUAL
.
          MATCH     SP70,WATEXT
          IF        !@EQUAL
            MOVE      ONE,COMMFLAG
            GOTO      WATTAB60
          ENDIF
.
          GOTO      WATTAB50
.
WATTAB60  CALL      PATLN000           * Format names
.
          MATCH     Z70,WTTXIDYC
          IF        @EQUAL
            MOVE      SP70,WTTXIDYC
          ENDIF
.
          MATCH     Z70,WTTXADMW  
          IF        @EQUAL
            MOVE      SP70,WTTXADMW
          ENDIF
.
          MATCH     Z70,WTTXCTYP 
          IF        @EQUAL
            MOVE      SP70,WTTXCTYP  
          ENDIF
.
          MATCH     Z70,WTTXPLST
          IF        @EQUAL
            MOVE      SP70,WTTXPLST
          ENDIF
.
          CALL      GTPC0000          * get category reassignment
.
WATTAB78  MOVE      ZERO,PATPOST        * Added for Displaying Cancellation
          MOVE      ZERO,UNITPOST
          MOVE      ZERO,HOSPOST
          MOVE      SP70,DIM1
.
          CALL      WATPAT00
          CALL      WATUNT00
          CALL      WATHPT00
          CALL      DRFCUR00
.     
          MOVE      SP70,DESCDAYC
          PACK      KEY5,ANSX,ANSB,WTTXIDYC,SP70
          CALL      RDCODE1
          IF        OVRCD = 0
            MATCH    "1",TCINDC1            * Only display code for day cases
            IF       @EQUAL
              MOVE     DYES,DESCDAYC
            ENDIF
          ENDIF
.
          MOVE      SP70,BKREEDAT
          PACK      KEY8,WMBOOK,SP70
          CALL      RDBKREC1
          IF        OVRCD=1
            MOVE      SP70,BKREEDAT
          ENDIF
.
          IF        RECCOUNT>=LISTLIMT
           PACK      KEY32,WMSTAT,WMDOCTOR,WMUNIT,WMPTY,WMURNO,WMCODE,WMCNT,SP70
           WRITE     HTMLFILE;"LimitReached();"
           WRITE     HTMLFILE;"NextRecordSet('",KEY32,"');"
           GOTO      WATTAB99
          ENDIF
.
          ADD       ONE,RECCOUNT
          CALL      PATFLD00            * Returns KEY3 for folder colour code
.
          CALL      LSTDAY00
          CALL      CRTDAY00
.
          MOVE      SP70,PRPBDESC
          MOVE      "yh",CATEGORY
          MOVE      WTTXPRPB,CODE
          CALL      GETCOD00
          MOVE      TDESC,PRPBDESC
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",FORMATNM,"#",":
                             "#"",WMURNO,"#",":
                             "#"",DISPSEX,"#",":
                             "#"",PBDATE,"#",":
                             "#"",WMDATE1,"#",":
                             "#"",WMDATE2,"#",":
                             "#"",WMDATE3,"#",":
                             "#"",WMCODE,"#",";
.                                            * Display Procedure Description
.                                            * comments only if they exist
          MATCH     SP70,WTWMPDSC
          STRIP     WMDESC
          MOVELPTR  WMDESC,F3
          SFORMAT   DISPVAR1,F3
          MOVE      WMDESC,DISPVAR1
          IF        @EQUAL
            WRITE     HTMLFILE;"#"",DISPVAR1,"#",";
          ELSE
            STRIP     WTWMPDSC
          STRIP     WMDESC
            MOVELPTR  WTWMPDSC,F3
            SFORMAT   DISPVAR2,F3
            MOVE      WTWMPDSC,DISPVAR2
            WRITE     HTMLFILE;"#"",DISPVAR1,"<br />",DISPVAR2,"#",";
          ENDIF
          SFORMAT   DISPVAR1,127
          SFORMAT   DISPVAR2,127
.
          WRITE     HTMLFILE;"#"",WMREASON,"#",":
                             "#"",WTWMRANK,"#",":
                             "#"",WMSTAY,"#",":
                             "#"",SRCRDESC,"#",":
                             "#"",UNITDESC,"#",":
                             "#"",WMPTY,"#",":
                             "#"",OVERDATE,"#",":
                             "#"",OVERSTAT,"#",":
                             "#"",WTTXPLST,"#",":
                             "#"",GENPNAME,"#",":
                             "#"",LSTDAYS,"#",": 
                             "#"",NRCDAYS,"#",": 
                             "#"",URGDAYS,"#",": 
                             "#"",WTTXADMW,"#",":
                             "#"",DESCDAYC,"#",":
                             "#"",WTTXCTYP,"#",":
                             "#"",COMMFLAG,"#",":
                             "#"",PATPOST,"#",":
                             "#"",UNITPOST,"#",":
                             "#"",HOSPOST,"#",":
                             "#"",CATASSGN,"#",":
                             "#"",WTWMREAD,"#",":
                             "#"",DIM19,"#",":
                             "#"",RFCDAYS,"#",":
                             "#"",WTTXPOWD,"#",":
                             "#"",URRFCDAY,"#",":
                             "#"",KEY3,"#",":
                             "#"",WMPTY," - ",WTWMRANK,"#",":
                             "#"",WTWMECNT,"#",":
                             "#"",WTWMDTAD,"#",":
                             "#"",CRTDAYS,"#",":
                             "#"",BKREEDAT,"#",":
                             "#"",PTWDSDES,"#",":       * 42
                             "#"",ADMPDESC,"#",":       * 43
                             "#"",PRPBDESC,"#",":       * 44
                             "#"",PRIOSTAT,"#",":       * 45
                             "#"",WTWMDABD,"#");"       * 46
          GOTO      WATTAB10
.
..WATTAB80  WRITE     HTMLFILE;"alert('Too Many Selected Patients.":
..                             " Please Wait ..');"
..          GOTO      WATTAB99
.
WATTAB85  IF        DOCERROR=1
            WRITE     HTMLFILE;"alert('Doctor must be Specified.');"
          ENDIF
          GOTO      WATTAB99
WATTAB90  
WATTAB99  RETURN
+
.------------------------------------------------------------
. Get Sex for Display
.------------------------------------------------------------
GETSEX00  MOVE      SP8,DISPSEX
.
.* ****************************************** Start of Changes         *C-49016
          MOVE      PSEX,DSEXCHAR
          CALL      SEXDSC00                * get sex description (in IBACOMN)
.                                           *       returns DSEXDESC & DSEXNO
          MOVE      DSEXDESC,DISPSEX
.* ******************************************   End of Changes         *C-49016
.
          RETURN
.----------------------------------------------------------------------
. Get OverDue Date & List Status
.  - Codes File should have been read for Cat TP
.  - Waiting List Record WATTR1AF should have been Read
.----------------------------------------------------------------------
COVER000  MOVE      SP70,PRIOOVER
          MOVE      ZERO,OVERSTAT
..        CALL      URGDAY00
..        CALL      LSTDAY00
          CALL      DRFCUR00
          UNPACK    CLURCTDT,CCENT,CYEAR,CMON,CDAY  * set up parameters
          MOVE      CCENT,CC
          MOVE      CDAY,DD
          MOVE      CMON,MM
          MOVE      CYEAR,YY
.
          CALL      DMYCON                   * convert to Julian date
.
          MOVE      JULDAY,JULDAYST          * For Status
          PACK      KEY5,ANST,ANSP,WMPTY,SP70
          CALL      RDCODE1
          ADD       TCFORM6,JULDAYST
.
          READ      CONTROLF,THIRTY7;*173,WTCNURDY,*177,WTCNSUDY:
                                     *181,WTCNRODY
          MATCH     "U",TCINDC1
          IF        @EQUAL
            ADD       WTCNURDY,JULDAY
          ENDIF
.
          MATCH     "S",TCINDC1
          IF        @EQUAL
            ADD       WTCNSUDY,JULDAY
          ENDIF
.
          MATCH     "R",TCINDC1
          IF        @EQUAL
            ADD       WTCNRODY,JULDAY
          ENDIF
.
.         CALL      NRCDF000
.         BRANCH    EXIT,COVER999
.
          ADD       LSNRFCRE,JULDAY           
          ADD       LSNRFCRE,JULDAYST
.
          MOVE      JULDAY,JWKDAY            * set up parameters
          MOVE      JULYR,JWKYER
          MOVE      JULCC,JWKCC
          MOVE      JULYR,JULYRST
          MOVE      JULCC,JULCCST
          CALL      JULCON                   * convert to DDMMYYCC
.
          PACK      PRIOOVER,CC,YY,MM,DD
          REP       " 0",PRIOOVER
.
          MOVE      JULDAYST,JULDAY
          MOVE      JULDAY,JWKDAY            * set up parameters
          MOVE      JULYRST,JWKYER
          MOVE      JULCCST,JWKCC
          CALL      JULCON                   * convert to DDMMYYCC
          PACK      TESTDATE,CC,YY,MM,DD
          REP       " 0",TESTDATE
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      "0",OVERSTAT
          MATCH     KEY8,TESTDATE
          IF        @LESS
            MOVE      "1",OVERSTAT
          ENDIF
.
          MATCH     KEY8,TESTDATE
          IF        @EQUAL
            MOVE      "1",OVERSTAT
          ENDIF
.
          MATCH     "00000000",TESTDATE
          IF        @EQUAL
            MOVE      "0",OVERSTAT
          ENDIF
.
          IF         WMSTAT>1 & WMSTAT <9
            MOVE       TWO,OVERSTAT
.           MOVE       SP70,PRIOOVER          * As per Jill
          ENDIF
.
          MOVE      "VL",CATEGORY             * If not ready for care 
          MOVE      WTTXPLST,CODE             * overdue date should be blank
          CALL      GETCOD00
.
          MATCH     "C",TCINDC1
          IF        @EQUAL
            MOVE       SP70,PRIOOVER
            MOVE       "0",OVERSTAT
          ENDIF
.         
          MATCH     "D",TCINDC1
          IF        @EQUAL
            MOVE       SP70,PRIOOVER
            MOVE       "0",OVERSTAT
          ENDIF
.         
          MATCH     "S",TCINDC1
          IF        @EQUAL
            MOVE       SP70,PRIOOVER
            MOVE       "0",OVERSTAT
          ENDIF
.         
COVER999  RETURN
.----------------------------------------------------------------------
. Get Link to Case
.----------------------------------------------------------------------
CASLNK00  CLEAR     HTMLLINK
          APPEND    LINKPRG,HTMLLINK
          APPEND    ".pbl?reportno=",HTMLLINK
          APPEND    LINKREP,HTMLLINK
          APPEND    "&template=",HTMLLINK
          APPEND    LINKTEM,HTMLLINK
.
          BRANCH    LINKTYPE,CASLNK10
          PACK      CASEKEYS,WMURNO,WMCODE,WMCNT,SP70
          REP       " +",CASEKEYS
          APPEND    "&casekeys=",HTMLLINK
          APPEND    CASEKEYS,HTMLLINK
          GOTO      CASLNK90
.
CASLNK10  MOVE      WMURNO,URNUMBER
          REP       " +",URNUMBER
          APPEND    "&urnumber=",HTMLLINK
          APPEND    URNUMBER,HTMLLINK
          GOTO      CASLNK90
.
CASLNK90  APPEND    SP70,HTMLLINK
          RESET     HTMLLINK
.
CASLNK99  RETURN
.------------------------------------------------------------
. Display Waiting List Patient
.  N.B.  Add/Update/Delete Routines in Demo Mode
.        Proper Record Locking to be Implemented for General Release
.------------------------------------------------------------
WATDET00  MOVE      ZERO,MRGECOUNT

WATDET04  CALL      CLWATDET
          CALL      CLWATSUS
          CALL      CLWTX000
          CALL      CLBOKREC
          CALL      CLBKRX00
          CALL      CLWATHIS
          CALL      CLRCLM00
.
          MATCH     SP70,INVCASEK
          IF        !@EQUAL
            IF        USEINVAD=1
              PACK      CASEKEYS,INVCASEK,SP70
            ENDIF
          ENDIF
.
          MATCH     Z70,UNIQUEID
          IF        !@EQUAL
            MATCH     SP70,UNIQUEID
            IF        !@EQUAL
              CALL      GETTRE00
            ENDIF
          ENDIF
.
          MOVE      WATHI001,WTHIRDT3
          MATCH     SP70,CASEKEYS
          IF        !@EQUAL
            MOVE      CASEKEYS,KEY19
            CALL      RDTREA1
            IF        OVRCD=0
              MOVE      WMURNO,URNUMBER
            ENDIF 
          ENDIF
.
          MOVE      CASEKEYS,KEY19
          CALL      RDWTTX11 
          IF        OVRCD=1
            CALL      CLWTX000
          ENDIF
.
          MATCH     SP70,CASEKEYS
          IF        !@EQUAL
            CALL      CHKHOS00
            BRANCH    EXIT,WATDET99
          ENDIF
.
          MATCH     SP70,CASEKEYS
          IF        !@EQUAL
            PACK      KEY19,CASEKEYS,SP70
            CALL      RDALWLN1
          ENDIF
.
          MOVE      WMBOOK,KEY8
          CALL      RDBKREC1
          IF        OVRCD = 1
            CALL    CLBOKREC
            CALL    CLBKRX00
          ELSE
            MOVE      WMBOOK,KEY8
            CALL      RDBKRX11
          ENDIF
.
          MATCH     "023",TEMPLATE
          IF        @EQUAL
            CALL      CLPMSPX2
            GOTO      WATDET05
          ENDIF
.
          MOVE      URNUMBER,KEY8           * UR number
          CALL      RDMAST1
          BRANCH    OVRCD,WATDET95
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          COMPARE   FOUR,PSTAT              * EBS Unknown U/R
          GOTO      WATDET93 IF EQUAL
.
          REPEAT                            * check if merged accounts

            ADD       ONE,MRGECOUNT
            IF        PSTAT=1 | PSTAT=2
              MOVE      PURNO,SAVEURNO
              MOVE      PPSNAME,URNUMBER
              MOVE      ONE,MRGEFLAG
              GOTO      WATDET04
             ELSE
               MOVE     NINTY9,MRGECOUNT
             ENDIF

          UNTIL  MRGECOUNT > TWENTY

          IF     (MRGECOUNT <> NINTY9)      
            GOTO   WATDET92
          ENDIF
.
WATDET05  MATCH     SP70,PHISTKEY
          IF        !@EQUAL
            PACK      KEY31,PHISTKEY,SP70
            CALL      RDWTHIS1
            IF        OVRCD = 1
              CALL      CLWTHS00
            ENDIF
          ENDIF
.
          CALL      LCLM0000
          CALL      GETTHE00
          CALL      GESIS000           * Get previous id for ESIS
.
          CALL      CLPATMIS
          MATCH     SP70,ADMISSNO
          IF        !@EQUAL
            PACK      KEY8,ADMISSNO,SP70
            CALL      RDMISS1
            IF        OVRCD=1
              CALL      CLPATMIS
            ENDIF
          ENDIF
.
          PACK      KEY8,REFRLVIS,SP70
          CALL      RDALREF1
          IF        OVRCD=1
            CALL      CLALLREF
          ENDIF
.
          MATCH     SP70,CASEKEYS
          IF        !@EQUAL
            PACK      KEY19,CASEKEYS,SP70
            CALL      RDALWLN1
            IF        OVRCD=1
              MOVE      SP70,ALWLVISN
            ENDIF
          ENDIF
.
          MATCH     SP70,UPDTTYPE      * Display
          GOTO      WATDET50 IF EQUAL
          MATCH     "A",UPDTTYPE       * Add New
          GOTO      WATDET10 IF EQUAL
          MATCH     "U",UPDTTYPE       * Update
          GOTO      WATDET20 IF EQUAL
          MATCH     "D",UPDTTYPE       * Delete
          GOTO      WATDET30 IF EQUAL
          MATCH     "C",UPDTTYPE       * Update Comments
          GOTO      WATDET60 IF EQUAL
          MATCH     "S",UPDTTYPE       * Supervisor
          GOTO      WATDET70 IF EQUAL
          MATCH     "P",UPDTTYPE       * Change procedure
          GOTO      WATDET77 IF EQUAL
          MATCH     "R",UPDTTYPE       * Change U/R for this procedure
          GOTO      WATDET78 IF EQUAL
          MATCH     "H",UPDTTYPE       * Update waiting list history   
          GOTO      WATDET79 IF EQUAL
          MOVE      "Invalid Update Type",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      WATDET99
.
WATDET10  MOVE      URNUMBER,KEY8           * visit number
          CALL      RDMAST1
          BRANCH    OVRCD,WATDET95
          CALL      RDPMPX21
          BRANCH    OVRCD,WATDET95
.
          PACK      WATTR012,WATTR012,SP70
          PACK      WATTR011,WATTR011,SP70
          MATCH     "1",TMDDOCTF
          GOTO      WATDET15 IF NOT EQUAL
.
          PACK      KEY21,WBSEHOSP,WATTR011,WATTR012,SP70
          CALL      RDPMTMD2
          IF        OVRCD<>1
            GOTO      WATDET18
          ENDIF
          CALL      RSPMTMD2
          CALL      RKPMTMD2
          BRANCH    OVRCD,WATDET97
          MATCH     WBSEHOSP,PMTDHOSP
          GOTO      WATDET97 IF NOT EQUAL
          MATCH     WATTR011,PMTDUNIT
          GOTO      WATDET97 IF NOT EQUAL
          MATCH     WATTR012,PMTDDOCT
          GOTO      WATDET97 IF NOT EQUAL
.
          GOTO      WATDET18
.
WATDET15  PACK      KEY9,WATTR012,WATTR011,SP70
          CALL      RDWTVWL1
          BRANCH    OVRCD,WATDET97
.
WATDET18  PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          COMPARE   ONE,PCEASE
          GOTO      WATDET94 IF EQUAL
.
          CALL      CTRN0000                     * Check transfer source
          BRANCH    EXIT,WATDET99
.
          CALL      CHKWA000         * Perform wa health validations
          BRANCH    EXIT,WATDET99
.
          CALL      ADDWAT00
          BRANCH    ERRORFLG,WATDET99
.
          CALL      LCLM1000
          CALL      ADDATR00
          CALL      RLNK0000         * Write referral link
.
          MATCH     SP70,EREFRLID
          IF        !@EQUAL
            MOVE      ZERO,F1
            MOVE      " 9",KEY2
            MOVE      WMBOOK,KEY8
            PACK      KEY19,WMURNO,WMCODE,WMCNT,SP70
            PROC      UPEREFVS              * Update eReferral Details
          ENDIF
.
          CALL      NXTPAG00
          GOTO      WATDET99
.
WATDET20  MATCH     SP70,CASEKEYS
          GOTO      WATDET96 IF EQUAL
.
          PACK      WATTR012,WATTR012,SP70
          PACK      WATTR011,WATTR011,SP70
          MATCH     "1",TMDDOCTF
          GOTO      WATDET22 IF NOT EQUAL
.
          PACK      KEY21,WBSEHOSP,WATTR011,WATTR012,SP70
          CALL      RDPMTMD2
          IF        OVRCD<>1
            GOTO      WATDET23
          ENDIF
          CALL      RSPMTMD2
          CALL      RKPMTMD2
          BRANCH    OVRCD,WATDET97
          MATCH     WBSEHOSP,PMTDHOSP
          GOTO      WATDET97 IF NOT EQUAL
          MATCH     WATTR011,PMTDUNIT
          GOTO      WATDET97 IF NOT EQUAL
          MATCH     WATTR012,PMTDDOCT
          GOTO      WATDET97 IF NOT EQUAL
.
          GOTO      WATDET23
.
WATDET22  PACK      KEY9,WATTR012,WATTR011,SP70
          CALL      RDWTVWL1
          BRANCH    OVRCD,WATDET97
.
WATDET23  CALL      CTRN0000                     * Check transfer source
          BRANCH    EXIT,WATDET99
.
          CALL      CHKWA000                     * Perform WA health validations
          BRANCH    EXIT,WATDET99
.
          CALL      UPDWAT00
          BRANCH    EXIT,WATDET99
.
          CALL      RLNK0000
.
          IF        PTCNHDPS=1
            PACK      ADMISSNO,WMBOOK,SP70
            CALL      WRPORD00       * Write acc purchase order number
          ENDIF
.
          CALL      UPDATR00
.
          COMPARE   TWO,WMSTAT               * Update booking details if w/list
          GOTO      WATDET26 IF NOT EQUAL    * status is scheduled and the 
.                                            * booking status is booked
          PACK      KEY8,WMBOOK,SP70
          CALL      RDBKREC1
          BRANCH    OVRCD,WATDET26
.
          COMPARE   ZERO,BKRESTAT
          GOTO      WATDET26 IF NOT EQUAL
.
          MATCH     Z70,BKREC005
          IF        !@EQUAL
            MOVE      BKREC005,BKREATIM        * admission time
          ENDIF
          MATCH     Z70,WATTX026
          IF        !@EQUAL
            MOVE      WATTX026,BKRECLMT        * Claim type
          ENDIF
          MATCH     Z70,WATTX037
          IF        !@EQUAL
            MOVE      WATTX037,BKREWARD        * Ward
          ENDIF
          CALL      UPBKREC1 
.
          PACK      KEY8,WMBOOK,SP70
          CALL      RDBKRX11
          BRANCH    OVRCD,WATDET26
.
          MATCH     Z70,WATTX005
          IF        !@EQUAL
            MOVE      WATTX005,BKRXPOWD        * Post Op Ward
          ENDIF
          MATCH     Z70,WATTX006
          IF        !@EQUAL
            MOVE      WATTX006,BKRXADWD        * Admitting Point
          ENDIF
          MATCH     Z70,WATTX028
          IF        !@EQUAL
            MOVE      WATTX028,BKREATIM        * Preadmission time
          ENDIF
          MATCH     Z70,WATTX009
          IF        !@EQUAL
            MOVE      WATTX009,BKRXFORM        * Forms
          ENDIF
.      Updated BKRXUDF3 if blank - Utilise ind2 of CAT XG & BG to match and
.      write first active match found
          MATCH     SP70,BKRXUDF3
          GOTO      WATDET25 IF NOT EQUAL
          MATCH     Z70,WATTX012
          GOTO      WATDET25 IF EQUAL                
          MATCH     SP70,WATTX012
          GOTO      WATDET25 IF EQUAL
.
          MOVE      "XG",CATEGORY              * Pre-Admission Status (Cat XG)
          MOVE      WATTX012,CODE
          CALL      GETCOD00
          MOVE      TCINDC2,KEY1
.
          MATCH     SP70,TCINDC2               * Skip no mapping set
          GOTO      WATDET25 IF EQUAL
.
          PACK      KEY5,CATBG,SP70
          CALL      RDSCODE1 
WATDET24  CALL      RDKCODE1
          BRANCH    OVRCD,WATDET25
          MATCH     "BG",TCODE
          GOTO      WATDET25 IF NOT EQUAL
          MATCH     KEY1,TCINDC2
          IF        @EQUAL 
            MOVE      ACODE,BKRXUDF3           * Pre-Admission Status (Cat BG)
            GOTO      WATDET25
          ELSE
            GOTO      WATDET24
          ENDIF
.
WATDET25  CALL      UPBKRX11 
.
          CALL      UPVSCM00
.
WATDET26  COMPARE   ONE,CTHETR    
          IF        !@EQUAL
            PACK      KEY18,WMBOOK,SP9,ONE,SP70
            PACK      OPDAUNIQ,SP9,ONE,SP70
            GOTO      WATDET28
          ENDIF
.
          CALL      GETOPR00
          BRANCH    EXIT,WATDET29
.
WATDET28  CALL      RDBKDIA1
          IF        OVRCD=0
.            MATCH     Z70,WATTR004
.            IF        !@EQUAL
.              MOVE      WATTR004,BKDIDES2 
.            ENDIF
.
.            MATCH     Z70,WATTR003
.            IF        !@EQUAL
.              MOVE      WATTR003,BKDIDES1       * I CAR 46969
.            ENDIF
.            CALL      UPBKDIA1                * update file
          ELSE     
            MOVE      WMBOOK,BKDIBOOK         * set booking number
            MOVE      OPDAUNIQ,BKDIUNIQ
.
            MATCH     Z70,WATTR004
            IF        !@EQUAL
              MOVE      WATTR004,BKDIDES2 
            ENDIF
.
            MATCH     Z70,WATTR003
            IF        !@EQUAL
              MOVE      WATTR003,BKDIDES1       * I CAR 46969
            ENDIF
            CALL      WRBKDIA1                * write details
          ENDIF 
.
WATDET29  CALL      NXTPAG00
          GOTO      WATDET99
.
WATDET30  MATCH     SP70,CASEKEYS
          GOTO      WATDET96 IF EQUAL
.
.          MOVE      CASEKEYS,KEY19
.          CALL      RDTREA1
.          BRANCH    OVRCD,WATDET96
.
          CALL      WRCOM000   * Write Comments
.
          CALL      DELWAT00
          CALL      WESE0000
.
          CALL      NXTPAG00
          GOTO      WATDET99
.
WATDET50  CALL      PATNAM00
.
          PACK      KEY19,WMURNO,WMCODE,WMCNT,SP70
          CALL      RDWTRTD1          
          IF        OVRCD=1
            MOVE     SP70,WTRTREFR 
          ENDIF
.
          CALL      PADM0000                * Check for outpatient link PAC
          CALL      PANS0000                * Check for outpatient link PAS
.
          CALL      PATATR00                * Patient Attributes
.
          CLEAR     WEBTITLE
          APPEND    PATFNAME,WEBTITLE
          APPEND    " (Waiting List Details)",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,WATDET99
.
          CALL      WEBBOD00
          IF        MRGEFLAG=1
            CALL      MRGALT00
          ENDIF
.
          CALL      WEBEND00
          MOVE      ZERO,EXIT
          GOTO      WATDET99
.
WATDET60  CALL      WRCOM000                     * Update Comments
.
          CALL      WINCLS00
          GOTO      WATDET99
.
WATDET70  MATCH     SP70,CASEKEYS
          GOTO      WATDET96 IF EQUAL
.
          MOVE      WMDATE1,SAVDATEL             * Save original date in list
          MOVE      WMDATE1,OLDVAL01             * Save date on list for audit
          MOVE      WMPTY,OLDVAL02               * Save priority for audit
          MOVE      WMSTAT,OLDVAL09              * Save status for audit
          MOVE      WTWMIHSP,OLDVAL17            * Save intended hospital
.
          CALL      CTRN0000                     * Check transfer source
          BRANCH    EXIT,WATDET99
.
          MATCH     Z70,WATHI002
          IF        !@EQUAL
            MATCH     WMDATE1,WATHI002
            GOTO      WATDET98 IF LESS
          ENDIF
.
          PACK      WATTR012,WATTR012,SP70
          PACK      WATTR011,WATTR011,SP70
          MATCH     "1",TMDDOCTF
          GOTO      WATDET72 IF NOT EQUAL
.
          MATCH     Z70,WATTR038
          IF        !@EQUAL
            PACK      KEY21,WATTR038,WATTR011,WATTR012,SP70
          ELSE
            PACK      KEY21,WBSEHOSP,WATTR011,WATTR012,SP70
          ENDIF
          CALL      RDPMTMD2
          IF        OVRCD<>1
            GOTO      WATDET73
          ENDIF
          CALL      RSPMTMD2
          CALL      RKPMTMD2
          BRANCH    OVRCD,WATDET97
          MATCH     Z70,WATTR038
          IF        !@EQUAL
            MATCH     WATTR038,PMTDHOSP
          ELSE
            MATCH     WBSEHOSP,PMTDHOSP
          ENDIF
          GOTO      WATDET97 IF NOT EQUAL
          MATCH     WATTR011,PMTDUNIT
          GOTO      WATDET97 IF NOT EQUAL
          MATCH     WATTR012,PMTDDOCT
          GOTO      WATDET97 IF NOT EQUAL
.
          GOTO      WATDET73
.
WATDET72  PACK      KEY9,WATTR012,WATTR011,SP70
          CALL      RDWTVWL1
          BRANCH    OVRCD,WATDET97
.
.          MOVE      CASEKEYS,KEY19
.          CALL      RDTREA1
.          BRANCH    OVRCD,WATDET96
WATDET73  CALL      UUWTTRE1
          CALL      UPDWAT00
          BRANCH    EXIT,WATDET99
.
          CALL      ERVS0000              * Update eReferral 
.
          CALL      WESE0000
          CALL      UESN0000
          CALL      CHKBOK00    * Check booking record and update if required
          CALL      CHGDOC00              * Update doctor if changed
.
          CALL      WRCHA000    * Write date on list data integrity audit
          CALL      WRCHB000    * Write priority data integrity audit
          CALL      WRCHC000    * Write status data integrity audit
          CALL      WRCHL000    * Write change hospital data integrity audit
.
          MATCH     SP70,BKREC009
          GOTO      WATDET74 IF EQUAL
          GOTO      WATDET74 IF EOS  
.
          MATCH     Z70,BKREC009
          IF        !@EQUAL
            CALL      UPBC0000           * Update Last canc booking - BKRECANC
          ENDIF
. 
WATDET74  BRANCH    WMSTAT,WATDET80,WATDET75,WATDET75,WATDET75,WATDET75
          GOTO      WATDET80
.
WATDET75  MOVE      WMBOOK,KEY8
          CALL      RDBKRX11
          IF        OVRCD = 0
            MATCH     Z70,BOKRX023
            IF        !@EQUAL
.              MOVE      WATTR008,BKRXODTE
            MOVE      BOKRX023,BKRXODTE
            ELSE 
.              PACK      BKRXODTE,CCC,CYY,CMM,CDD
            MOVE         SP70,BKRXODTE
            ENDIF
          CALL      UPBKRX11
          ENDIF
          GOTO      WATDET80
.
WATDET77  MOVE      ZERO,PCOMFLAG           * Initialise
          CALL      FIXPRO00                * Change procedure on W/List
          IF        PCOMFLAG=0
            CALL      FIXCOM00              * Copy comments to new key
          ENDIF
.
          CALL      EPPP0000                * Update eReferral procedure
.
          CALL      SETDIR00                * Create redirect to new casekey
          MATCH     "1",UPDTESIS
          IF        !@EQUAL
            CALL      WESE0000
          ENDIF
          CALL      WRPP0000
          CALL      NXTPAG00
          GOTO      WATDET99
.
WATDET78  CALL      FIXTRE00                * Change U/R W/List
          PACK      KEY8,NEWURNUM,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,WATDET95
          CALL      RDPMPX21
          BRANCH    OVRCD,WATDET95
.
          MOVE      OURNO,OLDURNO
          IF        WMSTAT=2
            MOVE      TEN1,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICUR              * broadcast A44 message (scheduled)
          ENDIF
.
          CALL      WRCHU000                * Change U/R audit
          CALL      WESP0000
          CALL      WESE0000
          CALL      SETDIR00                * Create redirect to new casekey
          CALL      DELP0000                * delete watespaf record
          CALL      NXTPAG00
          GOTO      WATDET99
.
WATDET79  PACK      KEY31,PHISTKEY,SP70
          CALL      RDWTHIS1
          BRANCH    OVRCD,WATDET96
.
          CALL      UPDHIS00
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TEN6,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLIUWL                * HL7 - Update Waiting List Entry
.
          GOTO      WATDET80
.
WATDET80  CALL      WINCLS00
          GOTO      WATDET99
.
WATDET92  MOVE      "Error: Merged Patient",WEBTITLE
          CALL      WEBERR00
          GOTO      WATDET99
.
WATDET93  CLEAR     WEBTITLE
          APPEND    "Patient has an inappropriate identifier for ",WEBTITLE
          APPEND    "this function.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          GOTO      WATDET99
.
WATDET94  MOVE      "Deceased Patient",WEBTITLE
          CALL      WEBERR00
          GOTO      WATDET99
.
WATDET95  MOVE      "Invalid Waiting List Patient",WEBTITLE
          CALL      WEBERR00
          GOTO      WATDET99
.
WATDET96  MOVE      "Invalid Waiting List Case Key",WEBTITLE
          CALL      WEBERR00
          GOTO      WATDET99
.
WATDET97  MOVE      "Invalid Consultant/Unit Combination",WEBTITLE
          CALL      WEBERR00
          GOTO      WATDET99
.
WATDET98  MOVE      "Effective date must be greater than date on list",WEBTITLE
          CALL      WEBERR00
          GOTO      WATDET99
.
WATDET99  CLOSE     COMFILAF,DELETE
          CLOSE     COMPREAF,DELETE
          RETURN
.
.-----------------------------------------------------------------
. GTVISC00 - Get Visit Comments from input comment TextArea and
.            and write them to the temporary file for updating
.            to the database
.-----------------------------------------------------------------
.
GTVISC00  PREP      COMVISAF,COMVISNM
          GOTO      GTVISC20
.
GTVISC10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GTVISC99 IF OVER
.
          MATCH     SP70,QRYNAME
          GOTO      GTVISC80 IF NOT EQUAL
.
GTVISC20  MOVE      QRYDATA,QRYDATA1
          SQUEEZE   QRYDATA1                 * skip the blank line
          GOTO      GTVISC10 IF EOS
.
          ADD       ONE,VSCMTLIN
          WRITE     COMVISAF,SEQ;QRYDATA
          COMPARE   "99",VSCMTLIN
          GOTO      GTVISC99 IF EQUAL
.
          GOTO      GTVISC10
.
GTVISC80  MOVE      ONE,TEXTAREA             * Flag for Next CGI Param
.
GTVISC99  RETURN
.
.-----------------------------------------------------------------
. Insert new Visit Comments - vismdtaf/vismtxaf for pre-admission.
. It first deletes all the comments and then copies them back
.-----------------------------------------------------------------
.
UPVSCM00  IF        VSCMTFLG <> 1
            GOTO      UPVSCM99
          ENDIF
.
          MOVE      VSCMTTYP,KEY3
          CALL      DLVCM000                  * delete visit comments
.
          IF        VSCMTLIN = 0
            GOTO      UPVSCM99
          ENDIF
.
          CALL      IBACLOCK
          PACK      CURRDATX,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATX
          CLOCK     TIME,CTIMEIS              * Set created timestamp
.
.         Insert visit comment header
.
UPVSCM20  MOVE      ADMISSNO,VSMDVISN        * set admission number
          MOVE      VSCMTTYP,VSMDTYPE
          MOVE      ONE,F6
          MOVE      F6,VSMDNOTE
          MOVE      CURRDATX,VSMDDATE           * Visit date
          MOVE      CTIMEIS,VSMDTIME           * Visit time
          MOVE      USERID,VSMDUSER
.
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          IF        OVRCD = 0
            MOVE      WBSEOCG,VSMDOCCG      * Occupation Group
          ELSE
            MOVE      SP70,VSMDOCCG
          ENDIF
.
          MOVE      ZERO,VSMDDELT
          MOVE      SP70,VSMDDDAT
          MOVE      SP70,VSMDDTIM
          MOVE      SP70,VSMDDUSE
          MOVE      SP70,VSMDDOCC
          MOVE      SP70,VSMDSPAR
.
          CALL      WRVSMDT1
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      COMVISAF,COMVISNM
          TRAPCLR   IO
          BRANCH    OVRCD,UPVSCM99
.
.         Insert visit comment details
.
          MOVE      ZERO,F3
          MOVE      F3,VSTXUNIQ
UPVSCM40  READ      COMVISAF,SEQ;VSMTCMNT
          GOTO      UPVSCM90 IF OVER
.
          ADD       ONE,VSTXUNIQ            * add to line number
.
          MOVE      VSMDVISN,VSMTVISN       * set admission number
          MOVE      VSMDTYPE,VSMTTYPE
          MOVE      VSMDNOTE,VSMTNOTE
          MOVE      VSTXUNIQ,VSMTUNIQ
          MOVE      SP70,VSMTSPAR

          PACK      KEY20,VSMTVISN,VSMTTYPE,VSMTNOTE,VSMTUNIQ,SP70
          CALL      WRVSMTX1
.
          IF        VSTXUNIQ = 99
            GOTO      UPVSCM90
          ENDIF
.
          GOTO      UPVSCM40
.
UPVSCM90  MOVE      ZERO,EXIT
.
UPVSCM99  CLOSE     COMVISAF,DELETE
          RETURN
.
.-----------------------------------------------------------------------
. Delete all visit comments for a given visit type
.-----------------------------------------------------------------------
.
DLVCM000  PACK      KEY17,ADMISSNO,KEY3,SP70
          CALL      RSVSMDT1
DLVCM100  CALL      RKVSMDT1
          BRANCH    OVRCD,DLVCM999
.
          MATCH     ADMISSNO,VSMDVISN       * same Admission Number?
          GOTO      DLVCM999 IF NOT EQUAL
.
          MATCH     VSMDTYPE,KEY3
          GOTO      DLVCM999 IF NOT EQUAL
.
          PACK      KEY17,VSMDVISN,VSMDTYPE,VSMDNOTE,SP70
          CALL      DEVSMDT1
.
          PACK      KEY20,VSMDVISN,VSMDTYPE,VSMDNOTE,SP70
          CALL      RSVSMTX1
DLVCM400  CALL      RKVSMTX1
          BRANCH    OVRCD,DLVCM100          * end of file
.
          MATCH     VSMDVISN,VSMTVISN       * same Admission Number?
          GOTO      DLVCM100 IF NOT EQUAL
.
          MATCH     VSMDTYPE,VSMTTYPE
          GOTO      DLVCM100 IF NOT EQUAL
.
          MATCH     VSMDNOTE,VSMTNOTE
          GOTO      DLVCM100 IF NOT EQUAL
.
          PACK      KEY20,VSMTVISN,VSMTTYPE,VSMTNOTE,VSMTUNIQ,SP70
          CALL      DEVSMTX1
          GOTO      DLVCM400
.
DLVCM999  RETURN
.
.------------------------------------------------------------
. Perform WA Health required validations
.------------------------------------------------------------
CHKWA000  MOVE      ZERO,EXIT
.
          MATCH     Z70,WATTX037        * no ward on the page (not wahealth)
          GOTO      CHKWA999 IF EQUAL
.
          PACK      KEY5,ANSC,ANSL,WATTX026,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CHKWA999
.
          MATCH     "33",THCSCOD
          GOTO      CHKWA100 IF NOT EQUAL
.
          PACK      KEY6,WATTX037,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,CHKWA999
.
          PACK      KEY5,ANSB,ANST,WEFRBT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CHKWA999
.
          MATCH     "AMB",THCSCOD
          GOTO      CHKWA900 IF NOT EQUAL
.
          GOTO      CHKWA999
.
CHKWA100  PACK      KEY6,WATTX037,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,CHKWA999
.
          PACK      KEY5,ANSB,ANST,WEFRBT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CHKWA999
.
          MATCH     "AMB",THCSCOD
          GOTO      CHKWA910 IF EQUAL
.
          GOTO      CHKWA9999
.
CHKWA900  CLEAR     WEBTITLE
          APPEND    "Claim Type is invalid for ",WEBTITLE
          APPEND    "Non-Ambulatory Ward. Please amend. ",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKWA999
.
CHKWA910  CLEAR     WEBTITLE
          APPEND    "Claim Type is invalid for Ambulatory Ward. ",WEBTITLE
          APPEND    "Please amend. ",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKWA999
.
CHKWA999  RETURN
+
.------------------------------------------------------------
. Get treatment detail for unique ID
.------------------------------------------------------------
GETTRE00  MOVE      ZERO,EXIT
          MOVE      ZERO,F1
.
          PACK      KEY17,UNIQUEID,Z70
          CALL      RSWTESE1
GETTRE10  CALL      RPWTESE1
          BRANCH    OVRCD,GETTRE99
.
          MATCH     UNIQUEID,WTEEUNIQ
          GOTO      GETTRE90 IF NOT EQUAL
.
GETTRE15  PACK      KEY19,WTEEURNO,SP70
          CALL      RDSTREA1
GETTRE20  CALL      RDKTREA1
          BRANCH    OVRCD,GETTRE65
.
          MATCH     WMURNO,WTEEURNO
          GOTO      GETTRE65 IF NOT EQUAL
.
          MATCH     UNIQUEID,WTWMECNT
          GOTO      GETTRE20 IF NOT EQUAL
.
          PACK      CASEKEYS,WMURNO,WMCODE,DWMCNT,SP70
.
          PACK      URNUMBER,WMURNO,SP70
.
          GOTO      GETTRE99
.
GETTRE65  IF        F1>8
            GOTO      GETTRE90    *  just in case of loop in merge table
          ENDIF
.
.  *****  try merged UR's as wateseaf sent records are not updated with new ur
          ADD       ONE,F1
          PACK      KEY17,THREE,WTEEURNO,SP70
          CALL      RSPTMRG1
          CALL      RKPTMRG1
          BRANCH    OVRCD,GETTRE99
.
          MATCH     PTMROLUR,WTEEURNO
          GOTO      GETTRE99 IF NOT EQUAL
.
          PACK      WTEEURNO,PTMRNWUR
          GOTO      GETTRE15
.
GETTRE90  MOVE      ONE,EXIT
.
GETTRE99  RETURN
+
.------------------------------------------------------------
. Get claim details
.------------------------------------------------------------
LCLM0000  MATCH     SP3,WTTXCTYP
          GOTO      LCLM9999 IF EQUAL       * no claim code
.
.         Set the claim type indicator if this is a claim
.
          PACK      KEY5,ANSC,ANSL,WTTXCTYP,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,LCLM9999
.
.         Check the indicators for a W
.
          MOVE      ZERO,FORM2
LCLM3000  ADD       ONE,FORM2
          COMPARE   SIX,FORM2
          GOTO      LCLM9999 IF NOT LESS
.
          LOAD      ANS,FORM2,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
          CMATCH    "W",ANS
          GOTO      LCLM4000 IF EQUAL
          GOTO      LCLM3000
.
.         We have a workers comp claim
.
LCLM4000  PACK     KEY8,WMBOOK,SP70
          CALL     RDPMWX11
          CALL     RDWCOM1
          BRANCH   OVRCD,LCLM9999
          CALL     RDPMWX11
          GOTO     LCLM9999
.
LCLM9999  RETURN
.------------------------------------------------------------
. Get default claim details from previous visit
.------------------------------------------------------------
LCLM1000  MATCH     SP3,WTTXCTYP
          GOTO      LCLM1700 IF EQUAL       * no claim code
.
          MATCH     ANSN,PTCNLCLM
          GOTO      LCLM1999 IF EQUAL
.
.         Set the claim type indicator if this is a claim
.
          PACK      KEY5,ANSC,ANSL,WTTXCTYP,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,LCLM1700
.
.         Check the indicators for a W, M, or V (these are the claims)
.
          MOVE      ZERO,FORM2
LCLM1300  ADD       ONE,FORM2
          COMPARE   SIX,FORM2
          GOTO      LCLM1700 IF NOT LESS
.
          LOAD      ANS,FORM2,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
          CMATCH    "W",ANS
          GOTO      LCLM1400 IF EQUAL
          GOTO      LCLM1300
.
.         We have a workers comp. claim, get the previous workers comp details
.
LCLM1400  OPEN     PATWC1A1,"patwc1af"
          OPEN     PATWC1A2,"patwc1af"
          PACK     KEY16,URNUMBER,Z70
          CALL     RDSWCOM2
LCLM1410  CALL     RDPWCOM2
          BRANCH   OVRCD,LCLM1700
.
          MATCH    PTWCURNO,URNUMBER
          GOTO     LCLM1700 IF NOT EQUAL
.
          MATCH    ANSI,PTCNLCLM           * Check inpatient visit only
          GOTO     LCLM1420 IF NOT EQUAL   * Any visit
.
          MOVE     WCADMNO,KEY8
          CALL     RDVISA1
          BRANCH   OVRCD,LCLM1410
.
          COMPARE  THREE,PVITYPE
          GOTO     LCLM1410 IF NOT EQUAL   * get next visit
.
LCLM1420  MOVE     WCADMNO,KEY8
          CALL     RDPMWX11           * read ext.workers comp file(prev adm)
.
          MOVE     WMBOOK,WCADMNO   * current outpatient number
          MOVE     WCADMNO,KEY8
          CALL     RDAWCOM1
          IF       OVRCD=1
            MOVE     WMDATE1,PTWCVDAT
            MOVE     WMURNO,PTWCURNO
            CALL     WRWCOM1          * write workers comp file
.
.           If we are sending ACC details in PV1-20, then we need to
.           trigger an A08 message for the visit to reflect that this is
.           now an ACC patient
.
            MATCH     "1",PTCNH7AC
            IF        @EQUAL
              CALL      PMIGTNID               * get national id for dgate write
              MOVE      NMPNUMB,PTNINMPI
              MOVE      SIX,HL7TRGID
              MOVE      SP8,HL7INCLD
              PROC      DGCLICOB                * send update O/P details
            ENDIF
          ENDIF
.
          MOVE     WMBOOK,PMWXVISN
          MOVE     WMBOOK,KEY8
          CALL     RAPMWX11
          IF       OVRCD=1
            CALL     WRPMWX11         * write extension workers comp file
          ELSE
            CALL     UPPMWX11
          ENDIF
.
          GOTO     LCLM1999
.
LCLM1700  CALL      CLRCLM00
LCLM1999  RETURN
+
.
.------------------------------------------------------------
. Get unique number from oprdetaf
.------------------------------------------------------------
GETOPR00  MOVE      ZERO,EXIT
          PACK      KEY31,WMBOOK,ZERO,SP70
          CALL      RSOPDEA2
GETOPR10  CALL      RKOPDEA2 
          BRANCH    OVRCD,GETOPR90
.         
          PACK      KEY8,WMBOOK,SP70
          MATCH     OPDAADMN,KEY8
          GOTO      GETOPR90 IF NOT EQUAL
.
          COMPARE   ZERO,OPDASTAT
          GOTO      GETOPR90 IF NOT EQUAL
.
          MATCH     OPDAPROC,WMCODE
          GOTO      GETOPR10 IF NOT EQUAL
.
          MATCH     OPDACONT,DWMCNT
          GOTO      GETOPR10 IF NOT EQUAL
.
          PACK      KEY18,WMBOOK,OPDAUNIQ,SP70  * set booking number
          GOTO      GETOPR99
.
GETOPR90  MOVE      ONE,EXIT
.
GETOPR99  RETURN
.------------------------------------------------------------
. Alert that this is a merged U/R
.------------------------------------------------------------
MRGALT00  MATCH     SP70,URNUMBER
          GOTO      MRGALT99 IF EQUAL
.
          MATCH     SP70,SAVEURNO
          GOTO      MRGALT99 IF EQUAL
.
          MOVE      SAVEURNO,DISPSUR
          SQUEEZE   DISPSUR
          MOVE      URNUMBER,DISPMUR
          SQUEEZE   DISPMUR
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             " alert('U/R Number ",DISPSUR," is merged with ":
                             DISPMUR," \n Using ",DISPMUR,"');":
                             "}":
                             "</script>"
          GOTO      MRGALT99
.
MRGALT99  RETURN
.------------------------------------------------------------
. Add New Waiting List Procedure
.------------------------------------------------------------
ADDWAT00  CALL      CLWATDET
          CALL      SAVHIS00
.
          CALL      IBACLOCK
          MOVE      ZERO,F2
          PACK      KEY19,URNUMBER,WATTR001,Z70
          CALL      RDSTREA1           * read treatment file
          CALL      RDPTREA1           * read treatment file
          BRANCH    OVRCD,ADDWAT10
.
          MATCH     URNUMBER,WMURNO
          GOTO      ADDWAT10 IF NOT EQUAL
.
          MATCH     WATTR001,WMCODE
          GOTO      ADDWAT10 IF NOT EQUAL
.
          MOVE      WMCNT,F2
ADDWAT10  COMPARE   "99",F2
          GOTO      ADDWAT95 IF EQUAL
.
          ADD       ONE,F2
          MOVE      F2,WMCNT
          PACK      KEY19,URNUMBER,WATTR001,WMCNT,SP70
          CALL      RDTREA1
          COMPARE   ZERO,OVRCD
          GOTO      ADDWAT00 IF EQUAL
.
          CALL      CLWATDET
          UNPACK    KEY19,WMURNO,WMCODE
          CALL      MVWDET00
          CALL      CHKDEF00           * Check for deferred for nsw
          BRANCH    ERRORFLG,ADDWAT99
          CALL      GUNI0000           * Get Unique WL ID
.
          MATCH     ZEROVISN,NEWBOKNO
          IF        @EQUAL          
            CALL      GENBOKNO           * Get WL Booking Number
          ELSE
            MOVE      NEWBOKNO,WMBOOK    * Using converted booking number
          ENDIF
.
          CALL      DISWAR00            * Post disaster code
          BRANCH    EXIT,ADDWAT99
.
          PACK      WMKEYDT,CCC,CYY,CMM,CDD
          REP       " 0",WMKEYDT            
          MOVE      ONE,WMSTAT
          MOVE      SP2,WTWMPORT
.
          MOVE      ONE,NBRFLAG 
          MATCH     SP8,WTWMDTAD
          IF        @EQUAL
            MOVE      "04",WTWMBSCD
          ELSE
            MOVE      "02",WTWMBSCD
          ENDIF
.
          PACK      KEY5,ANST,ANSP,WMPTY,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MATCH     ANSC,TCINDC4
            IF        @EQUAL
              MOVE      "04",WTWMBSCD
            ENDIF
          ENDIF
.
ADDWAT20  PACK      KEY19,WMURNO,WMCODE,WMCNT,SP70
          CALL      RDATREA1
          IF        OVRCD=0
            MOVE      WMCNT,F2
            ADD       ONE,F2
            MOVE      F2,WMCNT
            COMPARE   ZERO,WMCNT
            GOTO      ADDWAT30 IF EQUAL
            GOTO      ADDWAT20
          ELSE
            CALL      WRTREA1
          ENDIF
.
          IF        PTCNHDPS=1
            PACK      ADMISSNO,WMBOOK,SP70
            CALL      WRTACC00
            CALL      WRPORD00        * write ACC Purcharse order number
          ENDIF
.
ADDWAT30  REP       " +",KEY19         * Add New Case Key to Redirect for Add
          STRIP     REDIRECT
          CLEAR     VAR
          APPEND    REDIRECT,VAR
          APPEND    "&casekeys=",VAR
          APPEND    KEY19,VAR
          RESET     VAR
          MOVE      VAR,REDIRECT
.                                      * Hps Code Starts here 
          PACK      KEY19,WMURNO,WMCODE,WMCNT,SP70 
          CALL      RDWTTX11             
          IF        OVRCD = 0  
            CALL      SVWTTX00         * Populate File Variables
            CALL      UPWTTX11         * Update wattx1af
          ELSE
            CALL      SVWTTX00         * Populate File Variables
            CALL      IBACLOCK
            PACK      WTTXCDTE,CCC,CYY,CMM,CDD
            REP       " 0",WTTXCDTE
            CLOCK     TIME,CTIMEIS
            MOVE      CTIMEIS,WTTXCTIM
            MOVE      WBSEUID,WTTXWEBC
.
            CALL      WRWTTX11         * Write a Record in wattx1af
            CALL      PMIGTNID         * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      ONE,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICWA         * DG API Put Patient on W/List  *I-90203
          ENDIF
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TEN3,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLIAWL                * HL7 - Add Waiting List Entry
.
          PACK      KEY5,ANSV,ANSL,WTTXPLST,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      ONE,NBRFLAG
            MATCH     ANSC,TCINDC2
            IF        @EQUAL
              MOVE      "04",WTWMBSCD
            ENDIF
          ENDIF
.
          CALL      WRPAC000           * Write Preadmission Comments
.
          MATCH     Z70,WATSU003
          IF        !@EQUAL
.            MOVE      WMDATE1,WATSU001
            MOVE      WATTR006,WATSU001
            MOVE      WTTXPLST,WATSU004
            MOVE      USERID,WATSU006
            PACK      CASEKEYS,WMURNO,WMCODE,WMCNT,SP70
            CALL      ADDSUS00
          ELSE
            CALL      WRCOM000           * Write Comments
          ENDIF
.
          PACK      WTRTURNO,WMURNO,SP70
          PACK      WTRTPROC,WMCODE,SP70
          PACK      WTRTPCNT,WMCNT,SP70
          PACK      KEY19,WTRTURNO,WTRTPROC,WTRTPCNT,SP70
          CALL      RDWTRTD1
          IF        OVRCD=1
            MOVE      SP70,WTRTREFR
            MOVE      SP70,WTRTTDES
          ENDIF
          MATCH     Z70,TRNSFSRC
          IF        !@EQUAL
            MATCH     SP70,TRNSFSRC
            IF        !@EQUAL
              MOVE      TRNSFSRC,WTRTREFR
              PACK      WTRTREFR,WTRTREFR,SP70
            ENDIF
          ENDIF
          MOVE      SP10,WTRTTDES
          PACK      WTRTSPAR,SP70

          PACK      KEY19,WTRTURNO,WTRTPROC,WTRTPCNT,SP70
          CALL      RAWTRTD1
          IF        OVRCD=1
            CALL      WRWTRTD1       * referral & transfer destination
          ELSE
            CALL      UPWTRTD1 
          ENDIF
.
          MOVE      ONE,AUDIFLAG       * write a A audit
          CALL      AUDWMTRE
.
. -----  Write record to Category Change file  watcataf -----
.
          MOVE      SP3,WTCACODF
          MOVE      WMPTY,WTCACODT     * set the new priority code
          MOVE      WMURNO,WTCAURNO    * set the UR number
          MOVE      WMCODE,WTCAPROC    * set procedure code
          MOVE      WMCNT,WTCAPCNT     * set procedure counter
          MOVE      WMDATE1,WTCAEDAT   * set effective date to date on list
          MOVE      "TP",WTCACATF      * set the priority code category
          MOVE      WBSEUID,WTCAWEBI
          CALL      IBACLOCK
          PACK      WTCAADTE,CCC,CYY,CMM,CDD  * set alteration date
          REP       " 0",WTCAADTE
          PACK      WTCAATIM,CTIMEIS          * set alteration time
          PACK      KEY29,WTCAEDAT,WTCACATF,WMURNO,WMCODE,WMCNT
          CALL      RAWTCAT1
          IF        OVRCD=0
            CALL      UPWTCAT1
            CALL      WURG0000
          ELSE
            CALL      WRWTCAT1         * write change priority file
            CALL      WURG0000
          ENDIF
.
. -----  Write record to Category Change file  watcataf -----
.
          MOVE      SP3,WTCACODF
          MOVE      WTWMEATY,WTCACODT  * set the new priority code
          MOVE      WMURNO,WTCAURNO    * set the UR number
          MOVE      WMCODE,WTCAPROC    * set procedure code
          MOVE      WMCNT,WTCAPCNT     * set procedure counter
          MOVE      WMDATE1,WTCAEDAT   * set effective date to date on list
          REP       " 0",WTCAEDAT
          MOVE      "CC",WTCACATF      * set the priority code category
          PACK      KEY29,WTCAEDAT,WTCACATF,WMURNO,WMCODE,WMCNT
          CALL      RAWTCAT1
          IF        OVRCD=0
            CALL      UPWTCAT1
          ELSE
            CALL      WRWTCAT1         * write change priority file
          ENDIF
.
          MOVE      ONE,ADDWLFLG       * Add record = yes
          MOVE      WMBOOK,SAVEBOOK   
          CALL      WRTHIS00           * write history record
.
          CALL      WESP0000
          CALL      WESE0000
          CALL      ADRED000
          CALL      AREQ0000           * Update admission request
          GOTO      ADDWAT99
.
ADDWAT95  MOVE      "Error: Too many records for this procedure code",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          MOVE      ONE,ERRORFLG
          GOTO      ADDWAT99
.
ADDWAT99  RETURN
.------------------------------------------------------------
. Check if adding as deferred for NSW
.------------------------------------------------------------
CHKDEF00  MOVE      ZERO,ERRORFLG
.
          COMPARE   TWO,PTCNHDPS
          GOTO      CHKDEF99 IF NOT EQUAL
.
          PACK      KEY5,ANSV,ANSL,WATTX004,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CHKDEF99
.
          MATCH     ANSR,TCINDC1
          GOTO      CHKDEF99 IF EQUAL
.
          PACK      KEY5,ANST,ANSP,WMPTY,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CHKDEF99
.
          MATCH     ANSD,TCINDC3
          IF        !@EQUAL
   MOVE      "Patient Not Ready for Care, ensure Priority is Deferred.",WEBTITLE
            CALL      WEBERR00
            MOVE      ONE,ERRORFLG
          ENDIF
.
CHKDEF99  RETURN
+
.------------------------------------------------------------
. Write Comment to File
.------------------------------------------------------------
WRCOM000  COMPARE   ZERO,WTMEEND
          GOTO      WRCOM999 IF EQUAL
          PACK      KEY21,WMURNO,WMCODE,WMCNT,SP70
          CALL      RDSMESA1
WRCOM010  CALL      RDKMESA1
          BRANCH    OVRCD,WRCOM100
          MATCH     WMURNO,WAURNO
          GOTO      WRCOM100 IF NOT EQUAL
          MATCH     WMCODE,WAPROC
          GOTO      WRCOM100 IF NOT EQUAL
          COMPARE   WMCNT,WACNT
          GOTO      WRCOM100 IF NOT EQUAL
          PACK      KEY21,WAURNO,WAPROC,WACNT,WACNT2,SP70
          CALL      DEMESA1
          PACK      KEY21,WMURNO,WMCODE,WMCNT,SP70
          CALL      RDSMESA1
          GOTO      WRCOM010
.
WRCOM100  MOVE      ZERO,F2
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO 
          OPEN      COMFILAF,COMFILNM 
          TRAPCLR   IO
          BRANCH    OVRCD,WRCOM999
.
WRCOM110  ADD       ONE,F2
          MOVE      WMURNO,WAURNO
          MOVE      WMCODE,WAPROC
          MOVE      WMCNT,WACNT
          MOVE      F2,WACNT2
          PACK      KEY21,WAURNO,WAPROC,WACNT,WACNT2,SP70
          CALL      RDMESA1
          IF        OVRCD=0
            READ      COMFILAF,SEQ;WATEXT   
            MOVE      SP70,WASPARE
            CALL      UPMESA1
          ELSE
            READ      COMFILAF,SEQ;WATEXT   
            MOVE      SP70,WASPARE
            CALL      WRMESA1
          ENDIF
          COMPARE   F2,WTMEEND
          GOTO      WRCOM110 IF NOT EQUAL
.
WRCOM999  RETURN
.----------------------------------------------------------------------
. Get unique identifier add one and write it back to control file.
.----------------------------------------------------------------------
GUNI0000  MOVE      " 37",PRXCODE
          CALL      GETSLK00
          READ      CONTROLF,THIRTY7;*195,WTCNHCTU
          MOVE      WTCNHCTU,WTWMUNIQ
          ADD       ONE,WTCNHCTU
          WRITAB    CONTROLF,THIRTY7;*195,WTCNHCTU
          CALL      RELSLK00
.
          MOVE      "111",PRXCODE
          CALL      GETSLK00
          READ      CONTROLF,HUND11;*1,WTCNECNT
          MOVE      WTCNECNT,WTWMECNT
          ADD       ONE,WTCNECNT
          WRITAB    CONTROLF,HUND11;*1,WTCNECNT
          CALL      RELSLK00
.
GUNI9999  RETURN
.------------------------------------------------------------------------
. Writing to wattx1af -- SVWTTX00
.------------------------------------------------------------------------
SVWTTX00  MOVE      WMURNO,WTTXURNO       * U/R Number
          MOVE      WMCODE,WTTXPCOD       * Procedure Code (watproaf)
          MOVE      WMCNT,WTTXPCNT        * Procedure Count
          PACK      WATTX004,WATTX004,SP70
          MATCH     Z70,WATTX004
          IF        !@EQUAL
            MATCH     SP70,WATTX004
            IF        !@EQUAL
              MOVE      WATTX004,WTTXPLST  * Patient List. Status (PRS/2) Cat VL
            ENDIF
          ENDIF
          MATCH     Z70,WATTX005
          IF        !@EQUAL
            MATCH     SP70,WATTX005
            IF        !@EQUAL
              MOVE      WATTX005,WTTXPOWD     * Post-Op Ward (patwr1af)
            ENDIF
          ENDIF
          MATCH     Z70,WATTX006
          IF        !@EQUAL
            MATCH     SP70,WATTX006
            IF        !@EQUAL
              MOVE      WATTX006,WTTXADMW     * Admitting Ward (patwr1af)
            ENDIF
          ENDIF
          MATCH     Z70,WATTX007
          IF        !@EQUAL
            MATCH     SP70,WATTX007
            IF        !@EQUAL
              MOVE      WATTX007,WTTXPSTY     * Parent Staying (0=NO,1=YES)
            ENDIF
          ENDIF
          MATCH     Z70,WATTX008
          IF        !@EQUAL
            MATCH     SP70,WATTX008
            IF        !@EQUAL
              MOVE      WATTX008,WTTXIDYC     * Intended  Day Case (Cat XB) 
            ENDIF
          ENDIF
          MATCH     Z70,WATTX009
          IF        !@EQUAL
            MATCH     SP70,WATTX009
            IF        !@EQUAL
              MOVE      WATTX009,WTTXADMF     * Admission Forms (Cat XA)
            ENDIF
          ENDIF
          MATCH     Z70,WATTX010
          IF        !@EQUAL
            MATCH     SP70,WATTX010
            IF        !@EQUAL
              MOVE      WATTX010,WTTXEQR1     * Equipment Required 1 (Cat XE) 
            ENDIF
          ENDIF
          MATCH     Z70,WATTX011
          IF        !@EQUAL
            MATCH     SP70,WATTX011
            IF        !@EQUAL
              MOVE      WATTX011,WTTXEQR2     * Equipment Required 2 (Cat XE)
            ENDIF
          ENDIF
          MATCH     Z70,WATTX012
          IF        !@EQUAL
            MATCH     SP70,WATTX012
            IF        !@EQUAL
              MOVE      WATTX012,WTTXPAST     * Pre-Admission Status (Cat XG)
            ENDIF
          ENDIF
. .........................................   * not used - see WTWMCSST
          MATCH     Z70,WATTX013
          IF        !@EQUAL
            MATCH     SP70,WATTX013
            IF        !@EQUAL
              MOVE      "0",WTTXCNSN
              CMATCH    "Y",WATTX013
              IF        @EQUAL
                MOVE      "1",WTTXCNSN        * Consent? (0=NO,1=YES)
              ENDIF
            ENDIF
          ENDIF
          MATCH     Z70,WATTX014
          IF        !@EQUAL
            MOVE      WATTX014,WTTXNTGP    * Notify Registered GP (0=NO,1=YES)
          ENDIF
          MATCH     Z70,WATTX015
          IF        !@EQUAL
            MATCH     SP70,WATTX015
            IF        !@EQUAL
              MOVE      WATTX015,WTTXPATM   * Proposed Admission Time (hh:mm:ss)
            ENDIF
          ENDIF
          MATCH     Z70,WATTX016
          IF        !@EQUAL
            MATCH     SP70,WATTX016
            IF        !@EQUAL
              MOVE      WATTX016,WTTXUIDR     * Id who  rmvd procd. (websecaf)
            ENDIF
          ENDIF
          MATCH     Z70,WATTX017
          IF        !@EQUAL
            MATCH     SP70,WATTX017
            IF        !@EQUAL
              MOVE      WATTX017,WTTXLEQR     * Loan Equipment Required (Cat XO)
            ENDIF
          ENDIF
.                                         * Duplicate Procedure Code (watproaf)
          MATCH     Z70,WATTX018
          IF        !@EQUAL
            MATCH     SP70,WATTX018
            IF        !@EQUAL
              UNPACK    WATTX018,KEY8,WTTXDPRC,WTTXDPCN  
            ENDIF
          ENDIF
          MATCH     Z70,WATTX020
          IF        !@EQUAL
            MATCH     SP70,WATTX020
            IF        !@EQUAL
              MOVE      WATTX020,WTTXCDTE     * Date Record Created (ccyymmdd)
            ENDIF
          ENDIF
          MATCH     Z70,WATTX021
          IF        !@EQUAL
            MATCH     SP70,WATTX021
            IF        !@EQUAL
              MOVE      WATTX021,WTTXCTIM     * Time Record Created (hh:mm:ss)
            ENDIF
          ENDIF
          MATCH     Z70,WATTX022
          IF        !@EQUAL
            MATCH     SP70,WATTX022
            IF        !@EQUAL
              MOVE      WATTX022,WTTXWEBC  * WEB User Id rec creator (websecaf)
            ENDIF
          ENDIF
          CALL      IBACLOCK
          REP       " 0",XCDATE
          MOVE      XCDATE,WTTXLUPD       * Current Time
.         MOVE      WATTX023,WTTXLUPD     * Last Update Date (ccyymmdd)
          CLOCK     TIME,WTTXLUPT         * Current Time   
.         MOVE      WATTX024,WTTXLUPT     * Last Update Time (hh:mm:ss)
          MOVE      USERID,WTTXWEBU
.         MOVE      WATTX025,WTTXWEBU     * WEB User Id rec. updater (websecaf)
          MATCH     Z70,WATTX026
          IF        !@EQUAL
            MATCH     SP70,WATTX026
            IF        !@EQUAL
              MOVE      WATTX026,WTTXCTYP     * Claim Type (Cat CL)
            ENDIF
          ENDIF
          MATCH     Z70,WATTX027
          IF        !@EQUAL
            MATCH     SP70,WATTX027
            IF        !@EQUAL
              MOVE      WATTX027,WTTXEQR3     * Equipment Required 3 (Cat XE)
            ENDIF
          ENDIF
.
          MATCH     WATTX028,Z70
          IF        !@EQUAL
            MOVE      WATTX028,WTTXPTIM
          ENDIF
.
          MATCH     WATTX029,Z70
          IF        !@EQUAL
            MOVE      WATTX029,WTTXPOTM
          ENDIF
.
          MATCH     WATTX030,Z70
          IF        !@EQUAL
            MOVE      WATTX030,WTTXPANS
          ENDIF
.
          MATCH     WATTX031,Z70
          IF        !@EQUAL
            MOVE      WATTX031,WTTXPANT
          ENDIF
.
          MATCH     WATTX032,Z70
          IF        !@EQUAL
            MOVE      WATTX032,WTTX23HR
          ENDIF
.
          MATCH     WATTX033,Z70
          IF        !@EQUAL
            MOVE      WATTX033,WTTXANAE
          ENDIF
.
          MATCH     WATTX034,Z70
          IF        !@EQUAL
            MOVE      WATTX034,WTTXBOTY
          ENDIF
.
          MATCH     WATTX035,Z70
          IF        !@EQUAL
            MOVE      WATTX035,WTTXTEAM
          ENDIF
.
          MATCH     WATTX036,Z70
          IF        !@EQUAL
            MOVE      WATTX036,WTTXFUND
          ENDIF
.
          MATCH     WATTX037,Z70
          IF        !@EQUAL
            MOVE      WATTX037,WTTXWARD
          ENDIF
.
          MATCH     WATTX038,Z70
          IF        !@EQUAL
            MOVE      WATTX038,WTTXPREF
          ENDIF
.
          MATCH     WATTX039,Z70
          IF        !@EQUAL
            MOVE      WATTX039,WTTXNWHC
          ENDIF
.
          MATCH     WATTX040,Z70
          IF        !@EQUAL
            MOVE      WATTX040,WTTXINTD
          ENDIF
.
          MATCH     WATTX041,Z70
          IF        !@EQUAL
            MOVE      WATTX041,WTTXMAUT
          ENDIF
.
          MATCH     WATTX042,Z70
          IF        !@EQUAL
            MOVE      WATTX042,WTTXEXPD
          ENDIF
.
          MATCH     WATTX043,Z70
          IF        !@EQUAL
            MOVE      WATTX043,WTTXTCRS
          ENDIF
.
          MATCH     WATTX044,Z70
          IF        !@EQUAL
            MOVE      WATTX044,WTTXDISC
          ENDIF
.
          MATCH     WATTX045,Z70
          IF        !@EQUAL
            MOVE      WATTX045,WTTXRTIM
          ENDIF
.
          MATCH     WATTX046,Z70
          IF        !@EQUAL
            MOVE      WATTX046,WTTXRCLI
          ENDIF
.
          MATCH     WATTX047,Z70
          IF        !@EQUAL
            MOVE      WATTX047,WTTXRCLP
          ENDIF
.
          MATCH     WATTX048,Z70
          IF        !@EQUAL
            MOVE      WATTX048,WTTXPSAH
          ENDIF
.
          MATCH     WATTX049,Z70
          IF        !@EQUAL
            MOVE      WATTX049,WTTXPHOS
          ENDIF
.
          MATCH     WATTX050,Z70
          IF        !@EQUAL
            MOVE      WATTX050,WTTXPRPB
          ENDIF
.
          MATCH     WATTX051,Z70
          IF        !@EQUAL
            MOVE      WATTX051,WTTXAASC
          ENDIF
.
          MATCH     WATTX052,Z70
          IF        !@EQUAL
            MOVE      WATTX052,WTTXUD09
          ENDIF
.
          MATCH     WATTX053,Z70
          IF        !@EQUAL
            MOVE      WATTX053,WTTXUD10
          ENDIF
.
          MATCH     WATTX054,Z70
          IF        !@EQUAL
            MOVE      WATTX054,WTTXUD11
          ENDIF
.
          MATCH     WATTX055,Z70
          IF        !@EQUAL
            MOVE      WATTX055,WTTXUD12
          ENDIF
.
          MATCH     WATTX056,Z70
          IF        !@EQUAL
            MOVE      WATTX056,WTTXUD13
          ENDIF
.
          MATCH     WATTX057,Z70
          IF        !@EQUAL
            MOVE      WATTX057,WTTXASAS
          ENDIF
.
SVWTTX99  RETURN
.---------------------------------------------------------------------------
. Clear wattx1 Variables 
.---------------------------------------------------------------------------
CLWTX000  MOVE      SP70,WTTXURNO   * U/R Number
          MOVE      SP70,WTTXPCOD   * Procedure Code (watproaf)
          MOVE      SP70,WTTXPCNT   * Procedure Count
          MOVE      SP70,WTTXPLST   * Patient List. Status (PRS/2) Cat VL
          MOVE      SP70,WTTXPOWD   * Post-Op Ward (patwr1af)
          MOVE      SP70,WTTXADMW   * Admitting Ward (patwr1af)
          MOVE      SP70,WTTXPSTY   * Parent Staying (0=NO,1=YES)
          MOVE      SP70,WTTXIDYC   * Intended Day Case (Cat XB)
          MOVE      SP70,WTTXADMF   * Admission Forms (Cat XA)
          MOVE      SP70,WTTXEQR1   * Equipment Required 1 (Cat XE)
          MOVE      SP70,WTTXEQR2   * Equipment Required 2 (Cat XE)
          MOVE      SP70,WTTXEQR3   * Equipment Required 2 (Cat XE)
          MOVE      SP70,WTTXPAST   * Pre-Admission Status (Cat XG)
          MOVE      SP70,WTTXCNSN   * Consent? (0=NO,1=YES)
          MOVE      SP70,WTTXNTGP   * Notify Registered GP (0=NO,1=YES)
          MOVE      SP70,WTTXPATM   * Proposed Admission Time (hh:mm:ss)
          MOVE      SP70,WTTXUIDR   * User Id who  rmvd procd. (websecaf)
          MOVE      SP70,WTTXLEQR   * Loan Equipment Required (Cat XO)
          MOVE      SP70,WTTXDPRC   * Duplicate Procedure Code (watproaf)
          MOVE      SP70,WTTXDPCN   * Duplicate Count
          MOVE      SP70,WTTXCDTE   * Date Record Created (ccyymmdd)
          MOVE      SP70,WTTXCTIM   * Time Record Created (hh:mm:ss)
          MOVE      SP70,WTTXWEBC   * WEB User Id rec creator (websecaf)
          MOVE      SP70,WTTXLUPD   * Last Update Date (ccyymmdd)
          MOVE      SP70,WTTXLUPT   * Last Update Time (hh:mm:ss)
          MOVE      SP70,WTTXWEBU   * WEB User Id rec. updater (websecaf)
          MOVE      SP70,WTTXCTYP   * Claim Type (Cat CL)
          MOVE      SP70,WTTXPTIM   * Proposed Pre Admission Time (hh:mm:ss)
          MOVE      SP70,WTTXPOTM   * Proposed Operation Time (hh:mm:ss)
          MOVE      SP70,WTTXPANS   * Pre-Anaesthetic Status (Cat XH)
          MOVE      SP70,WTTXPANT   * Pre-Anaesthetic Time (hh:mm:ss)
          MOVE      SP70,WTTX23HR   * Planned 23 hour stay (0=No 1=Yes)
          MOVE      SP70,WTTXANAE
          MOVE      SP70,WTTXBOTY
          MOVE      SP70,WTTXTEAM
          MOVE      SP70,WTTXFUND
          MOVE      SP70,WTTXWARD
          MOVE      SP70,WTTXPREF
          MOVE      SP70,WTTXNWHC
          MOVE      SP70,WTTXINTD
          MOVE      SP70,WTTXMAUT
          MOVE      SP70,WTTXEXPD
          MOVE      SP70,WTTXTCRS
          MOVE      SP70,WTTXDISC
          MOVE      SP70,WTTXRTIM
          MOVE      SP70,WTTXRCLI
          MOVE      SP70,WTTXRCLP
          MOVE      SP70,WTTXPSAH
          MOVE      SP70,WTTXPHOS
          MOVE      SP70,WTTXPRPB
          MOVE      SP70,WTTXAASC
          MOVE      SP70,WTTXUD09
          MOVE      SP70,WTTXUD10
          MOVE      SP70,WTTXUD11
          MOVE      SP70,WTTXUD12
          MOVE      SP70,WTTXUD13
          MOVE      SP70,WTTXASAS
          MOVE      SP70,WTTXSPAR   * Spare Variable
.
CLWTX999  RETURN
.------------------------------------------------------------
. Update Waiting List Procedure
.------------------------------------------------------------
UPDWAT00  PACK      KEY19,CASEKEYS,SP70
          CALL      RLWTTRE1           * Readlock Treatment File
          BRANCH    OVRCD,UPDWAT90,UPDWAT91
          CALL      RLWTTX11           * Readlock Extension File
          BRANCH    OVRCD,UPDWAT90,UPDWAT91
.
          MOVE      WTTXWARD,SAVTXWRD            * save ward
.
          PACK      KEY19,WMURNO,WMCODE,WMCNT,SP70
          CALL      RDWTRTD1
          IF        OVRCD=1
            MOVE     SP70,WTRTREFR
            MOVE     SP70,WTRTTDES
          ENDIF
.
          MATCH     Z70,WATTR038
          IF        !@EQUAL
            CALL      CHKHSP00
            BRANCH    EXIT,UPDWAT93
          ENDIF
.
          COMPARE   SIX,WMSTAT
          GOTO      UPDWAT92 IF EQUAL
.
          CALL      DISWAR00          * Update disaster
          BRANCH    EXIT,UPDWAT99
.
          CALL      SAVHIS00
          CALL      SAVHSS00
.
          MOVE      WMDOCTOR,SVWMDOCT
          MOVE      WMUNIT,SAVEUNIT
          MOVE      WMSTAT,SAVESTAT
          MOVE      WTWMRANK,SAVERANK
          MOVE      WTWMEATY,PRIORCC 
          MOVE      WMPTY,PRIORITY     * test for a change in priority
          MOVE      WMNOTICE,SVNOTICE
          MOVE      WTWMSRCR,SVWMSRCR
          MOVE      TWO,AUDIFLAG
          CALL      AUDWMTRE           * Before Change
.
          CALL      MVWDET00
          PACK      KEY19,CASEKEYS,SP70
          UNPACK    KEY19,WMURNO,WMCODE,DWMCNT
.
          COMPARE   WMSTAT,SAVESTAT
          CALL      UPSTA000 IF NOT EQUAL
.
          MOVE      DWMCNT,WMCNT
.
          CALL      UPTREA1
.
          MATCH     WTWMSRCR,SVWMSRCR
          IF        !@EQUAL
            CALL      WRCR0000
          ENDIF
          MATCH     WMNOTICE,SVNOTICE
          IF        !@EQUAL
            CALL      WRCN0000
          ENDIF
          MATCH     WMDOCTOR,SVWMDOCT
          IF        !@EQUAL
            CALL      WRCD0000
          ENDIF
.
          MOVE      THREE,AUDIFLAG
          CALL      AUDWMTRE           * After Change
.
          MATCH     WMPTY,PRIORITY     * test for a change in priority
          CALL      UPPRI000 IF NOT EQUAL
.
          MATCH     WTWMEATY,PRIORCC 
          CALL      UPCAR000 IF NOT EQUAL
.
          MATCH     WTWMRANK,SAVERANK
          IF        !@EQUAL
            CALL      UPRNK000
          ELSE
            MATCH     WMDATE2,SAVEDAT2
            IF        !@EQUAL
              CALL      UPRNK000
            ENDIF
          ENDIF
.
          MOVE      WATHI001,SAVERDT3
          MATCH     Z70,BKREC009
          IF        !@EQUAL
            MOVE      BKREC009,SAVEBCAN
          ENDIF
.
UPDWAT10  MATCH     SAVEDTAD,WTWMDTAD    * write given certainty
          GOTO      UPDWAT20 IF EQUAL
.
          COMPARE   TWO,PTCNHDPS
          IF        @EQUAL
            MOVE      "36",WTWMBSCD                * Add Booking code
            CALL      WRITSS00                     * Bypass normal history
            CALL      SAVHIS00
            CALL      SAVHSS00
            GOTO      UPDWAT20
          ENDIF
.
          IF        WMSTAT<>1
            GOTO      UPDWAT20
          ENDIF
.
          MATCH     SP70,SAVEDTAD
          IF        @EQUAL
            MOVE      ONE,NBRFLAG
            MOVE      "02",WTWMBSCD
            CALL      WRTHIS00
            CALL      SAVHIS00
            CALL      SAVHSS00
          ELSE
            MATCH     SP70,WTWMDTAD
            GOTO      UPDWAT20 IF NOT EQUAL
.
            PACK      KEY5,ANST,ANSP,WMPTY,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      ONE,NBRFLAG
              MATCH     ANSC,TCINDC4
              IF        @EQUAL
                MOVE      "04",WTWMBSCD
                CALL      WRTHIS00           * write to Waiting List History
                CALL      SAVHIS00
                CALL      SAVHSS00
              ENDIF
            ENDIF
          ENDIF
.
UPDWAT20  MATCH     SAVEPRIO,WMPTY
          GOTO      UPDWAT30 IF EQUAL       * no Priority change
.
          COMPARE   ONE,WMSTAT
          GOTO      UPDWAT30 IF NOT EQUAL
.
          PACK      KEY5,ANST,ANSP,WMPTY,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      ONE,NBRFLAG
            MATCH     ANSC,TCINDC4
            IF        @EQUAL
              MOVE      "04",WTWMBSCD
              CALL      WRTHIS00           * write to Waiting List History
              CALL      SAVHIS00
              CALL      SAVHSS00
              GOTO      UPDWAT30
            ENDIF
          ENDIF
.
          PACK      KEY5,ANST,ANSP,SAVEPRIO,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      ONE,NBRFLAG
            MATCH     ANSC,TCINDC4
            IF        @EQUAL
              MATCH     SP8,WTWMDTAD
              IF        @EQUAL
                MOVE      "04",WTWMBSCD
              ELSE
                MOVE      "02",WTWMBSCD
              ENDIF
              CALL      WRTHIS00           * write to Waiting List History
              CALL      SAVHIS00
              CALL      SAVHSS00
            ENDIF
          ENDIF
.
.
UPDWAT30  MOVE      ZERO,ADDWLFLG
          COMPARE   WMSTAT,SAVESTAT
          IF        !@EQUAL
            MOVE      WMBOOK,SAVEBOOK
            CALL      WRTHSS00           * write to Waiting List History
          ELSE
            CALL      WRTHIS00           * write to Waiting List History
            CALL      WRTHSS00           * write to Waiting List History
          ENDIF
.
          MATCH     "1",WAHFUNCT
          IF        @EQUAL
            COMPARE   "1",WMSTAT
            IF        @EQUAL
               MOVE     SP70,WMDATE3   * clear sch adm date for wa health if uns
            ENDIF
          ENDIF
          CALL      UPTREA1
          CALL      WRCOM000           * Write Comments
.                                      * Hps Code Starts here
          CALL      WRPAC000           * Write Pre-admission Comments
          PACK      KEY19,WMURNO,WMCODE,WMCNT,SP70
          CALL      RDWTTX11             
          IF        OVRCD = 0  
            MOVE      WTTXPOWD,SVTXPOWD
            MOVE      WTTXINTD,SVTXINTD
            MOVE      WTTXCTYP,SVTXCTYP
            CALL      SVWTTX00                * Populate File Variables
            MATCH     "1",WAHFUNCT
            IF        @EQUAL
              COMPARE   "1",WMSTAT
              IF        @EQUAL
                MOVE     SP70,WTTXPATM * clear sch adm time for wa health if uns
              ENDIF
            ENDIF
            CALL      UPWTTX11                * Update wattx1af
            MATCH     WTTXPOWD,SVTXPOWD
            IF        !@EQUAL
              CALL      WRCP0000
            ENDIF
            MATCH     WTTXCTYP,SVTXCTYP
            IF        !@EQUAL
              CALL      WRCF0000
            ENDIF
            MATCH     WTTXINTD,SVTXINTD
            IF        !@EQUAL
              CALL      WRCI0000
            ENDIF
          ELSE
            CALL      SVWTTX00                * Populate File Variables
            CALL      WRWTTX11                * Write a Record in wattx1af
          ENDIF

          CALL      UUWTTRE1           * Unlock Treatment File
          CALL      UUWTTX11           * Unlock Extension File
.
          MATCH     Z70,TRNSFSRC
          GOTO      UPDWAT50 IF EQUAL
.
          MATCH     SP70,TRNSFSRC
          GOTO      UPDWAT50 IF EQUAL
.
          PACK      WTRTURNO,WMURNO,SP70
          PACK      WTRTPROC,WMCODE,SP70
          PACK      WTRTPCNT,WMCNT,SP70
          PACK      KEY19,WTRTURNO,WTRTPROC,WTRTPCNT,SP70
          CALL      RDWTRTD1
          IF        OVRCD=1
            PACK      WTRTREFR,TRNSFSRC,SP70
            PACK      WTRTTDES,SP70
            CALL      WRWTRTD1                * Update Transfer Source
          ELSE
            MOVE      TRNSFSRC,WTRTREFR
            PACK      WTRTREFR,WTRTREFR,SP70
            CALL      UPWTRTD1                * Update Transfer Source
          ENDIF
.                                      * Confirmed Admission Date   
.         MOVE      BOKRX006,BKRXCNDT
UPDWAT50  MATCH     BOKRX006,SP70
          IF        !@EQUAL
            PACK      KEY8,WMBOOK,SP70
            CALL      RDBKRX11
            IF        OVRCD=0
              MATCH     Z70,BOKRX006
              IF        !@EQUAL
                MOVE      BOKRX006,BKRXCNDT
              ENDIF
              CALL      UPBKRX11
            ELSE
              GOTO      UPDWAT80
            ENDIF
          ENDIF
.
          CALL      WESE0000
.                                             * Hps Code Ends Here
.
UPDWAT80  IF        WMSTAT=2
            MATCH     WTTXWARD,SAVTXWRD
            IF        !@EQUAL
              CALL      PMIGTNID            * get national id for dgate write
              MOVE      NMPNUMB,PTNINMPI
              MOVE      TEN2,HL7TRGID
              MOVE      SP8,HL7INCLD
              PROC      DGCLIWLU            * broadcast transfer
            ENDIF
.
            CALL      PMIGTNID                * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      TEN,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLIWLU          * HL7 A08 - W/L Scheduled Details Update
          ENDIF
.
          CALL      DOCLMN00                * remove non-compensible claims
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TEN4,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLIUWL                * HL7 - Update Waiting List Entry
.
          MOVE      ZERO,EXIT
          GOTO      UPDWAT99
.
UPDWAT90  MOVE      "Invalid Waiting List Record.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDWAT99
.
UPDWAT91  MOVE      "Waiting List Record Locked.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDWAT99
.
UPDWAT92  MOVE      "Cannot update, patient has been removed from the waiting list",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDWAT99
.
UPDWAT93  MOVE      "Invalid Security for this Hospital",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDWAT99
.
UPDWAT94  MOVE      "Cannot update, patient has been discharged from the waiting list",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDWAT99
.
UPDWAT99  CALL      UUWTTRE1           * Unlock Treatment File
          CALL      UUWTTX11           * Unlock Extension File
          RETURN
+
.-----------------------------------------------------------------------------
.         If patient changed to non-comp. claim, delete any claim details
.-----------------------------------------------------------------------------
.
.         Set the claim type indicator if this is a claim
.
DOCLMN00  MATCH     "1",PTCNXCOM
          IF        @EQUAL
            MOVE      WMBOOK,ADMISSNO
            CALL      CPRA0000                * check if we need to update PRFA
            GOTO      DOCLMN99
          ENDIF
.
          PACK      KEY5,CATCL,WTTXCTYP
          CALL      RDCODE1
          BRANCH    OVRCD,DOCLMN99
.
.         Check the indicators for a C, M, V or W (these are the claims)
.
          MOVE      ZERO,FORM2
DOCLMN10  ADD       ONE,FORM2
          COMPARE   SIX,FORM2
          GOTO      DOCLMN90 IF NOT LESS
.
          LOAD      ANS,FORM2,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
          CMATCH    "W",ANS
          GOTO      DOCLMN99 IF EQUAL
          CMATCH    "M",ANS
          GOTO      DOCLMN99 IF EQUAL
          CMATCH    "V",ANS
          GOTO      DOCLMN99 IF EQUAL
          CMATCH    "C",ANS
          GOTO      DOCLMN99 IF EQUAL
          GOTO      DOCLMN10
.
DOCLMN90  OPEN      PATWC1A1,"patwc1af"
          OPEN      PATWMAB1,"patwmabf"
          OPEN      PATWVET1,"patwvetf"
          OPEN      PMSCTCA1,"pmsctcaf"
.
          MOVE      WMBOOK,ADMISSNO
.
          CALL      DEWCOM00         * Delete Workers Comp.
          CALL      DEWMAB00         * Delete TAC
          CALL      DEWVET00         * Delete Veteran affairs
          CALL      DEWCTC00         * Delete Civil Tort
.
DOCLMN99  RETURN
+
.------------------------------------------------------------
.         Check if we need to update PRFA
.------------------------------------------------------------
CPRA0000  PACK      KEY5,ANSC,ANSL,WTTXCTYP,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CPRA9999
.
          MOVE      SP70,DIM1
          MOVE      TCINDC1,DIM1
          REP       "P~J~ ~",DIM1
          MATCH     "~",DIM1
          GOTO      CPRA1000 IF EQUAL        * Public
.
          MATCH     "E",DIM1
          GOTO      CPRA9999 IF NOT EQUAL
.
          MOVE      "7",KEY1           * Local Address
          CALL      DADR0000
          BRANCH    EXIT,CPRA8000      * default to patient details
          GOTO      CPRA9999
.
CPRA1000  MOVE      "2",KEY1                 * Postal Address
          CALL      DADR0000
          BRANCH    EXIT,CPRA8000
          GOTO      CPRA9999
.
CPRA8000  CALL      PRAD0000           * write to person responsible file
CPRA9999  RETURN
+
.------------------------------------------------------------
.        Default Address from Extra Contract file
.------------------------------------------------------------
DADR0000  OPEN      PMSCEXA1,"pmscexaf"
          OPEN      PATRE1A1,"patre1af"
          PACK      KEY14,URNUMBER,SP70
          CALL      RSPMCEX1
DADR1000  CALL      RKPMCEX1
          BRANCH    OVRCD,DADR9000
          MATCH     URNUMBER,PMCEURNO         * Same U/R?
          GOTO      DADR9000 IF NOT EQUAL
.
          MATCH     SP70,PMCETYPE
          GOTO      DADR1000 IF EQUAL
          MOVE      "tc",KEY2
          PACK      KEY5,KEY2,PMCETYPE
          CALL      RDCODE1
          BRANCH    OVRCD,DADR1000
          MATCH     KEY1,TCINDC1
          GOTO      DADR1000 IF NOT EQUAL
.
          MOVE      SP1,ANS
          MOVE      PGNAME,PTREGNAM
          MOVE      PTMASNAM,PTRESNAM
          MOVE      PGNAME,ANS
          PACK      PKNAME,PTITL,SP1,ANS,DOT,PTMASNAM,SP70
          MOVE      PMCEADD1,PKADD1
          MOVE      PMCEADD2,PKADD2
          MOVE      PMCEADD3,PKSUBR
          MOVE      PMCEADD4,PKADD4
          MOVE      PMCEPOST,PKPOST
          MOVE      PMCETELB,PKTELEB
          MOVE      PMCERELP,PKRELP
          MOVE      PMCETELP,PKTELEP
          MOVE      PMCETELM,PTREMOBL
          MOVE      ADMISSNO,PKADMN
          CALL      PARN0000                  * Check for 'Parent of'
.
          PACK      KEY8,ADMISSNO,SP10
          CALL      RDARESP1
          IF        OVRCD=1
            CALL      WRRESP1
          ELSE
            CALL      UPRESP1
          ENDIF
          MOVE      ZERO,EXIT
          GOTO      DADR99999
.
DADR9000  MOVE      ONE,EXIT
DADR9999  RETURN
+
.------------------------------------------------------------
.        Check for Using 'Parent of' option
.------------------------------------------------------------
PARN0000 COMPARE   ONE,PTCNPAOF              * Using 'Parent of' option?
         GOTO      PARN9999 IF NOT EQUAL     * no
.
         PACK      AGEDATE,CCC,CYY,CMM,CDD
         CALL      CALCAGE                   * CALCAGE uses PBDATE
         COMPARE   PSAGEYRS,PTCNAGEC         * Child?
         GOTO      PARN9999 IF LESS          * No
.
         UNPACK    PGNAME,ANS
         PACK      PKNAME,SP70
         CLEAR     PKNAME
         APPEND    "Parent of ",PKNAME
         APPEND    ANS,PKNAME
         APPEND    DOT,PKNAME
         APPEND    SP1,PKNAME
         APPEND    PTMASNAM,PKNAME
         APPEND    SP70,PKNAME
         RESET     PKNAME
         MOVE      "Parent    ",PKRELP
.
PARN9999 RETURN
+
.------------------------------------------------------------------------------
.  PRAD0000  :  Write the Person Responsible for Account Details for RCH
.------------------------------------------------------------------------------
PRAD0000  MATCH     "1",PTCNNEWC            * using new contacts ?
          IF        @EQUAL
            CALL      UPRF0000              * Get Contact for Usual PRFA
            MOVE      ADMISSNO,PKADMN
            COMPARE   ZERO,EXIT
            GOTO      PRAD7000 IF EQUAL
            GOTO      PRAD9500              * No change to PRFA
          ENDIF
.
          MOVE      ZERO,F1
          MOVE      PMPXCONP,F1
          BRANCH    F1,PRAD1000,PRAD2000,PRAD3000,PRAD4000,PRAD5000
.
. patient is responsible for account
.
          MOVE    PTMASNAM,PACSNAMX
          MOVE    PGNAME,ANS
          PACK    PACGNAME,ANS,DOT
          MOVE    PTITL,PACTITLE
          MOVE    THREE,PACFRMT
          CALL    PACNAME
.
          MOVE    ADMISSNO,PKADMN
          MOVE    PACFNAMX,PKNAME
          MOVE    PADD1,PKADD1
          MOVE    PADD2,PKADD2
          MOVE    PSUBRB,PKSUBR
          MOVE    PADD4,PKADD4
          MOVE    PPOST,PKPOST
          MOVE    PTELEP,PKTELEP
          MOVE    PTELEB,PKTELEB
          MOVE    "SELF      ",PKRELP
.
          CALL    PARN0000                  * Check for 'Parent of'
.
          GOTO    PRAD7000
.
. contact 1 is responsible for account
.
PRAD1000  MOVE    ADMISSNO,PKADMN
          MOVE    PMPXMSNA,PACSNAMX
          MOVE    PMPXMGNA,ANS
          PACK    PACGNAME,ANS,DOT
          MOVE    PMPXMTLE,PACTITLE
          MOVE    THREE,PACFRMT
          CALL    PACNAME
.
          MOVE    PACFNAMX,PKNAME
          MOVE    PMPXMAD1,PKADD1
          MOVE    PMPXMAD2,PKADD2
          MOVE    PMPXMAD3,PKSUBR
          MOVE    PMPXMAD4,PKADD4
          MOVE    PMPXMPOS,PKPOST
          MOVE    PMPXMPNO,PKTELEP
          MOVE    PMPXMBNO,PKTELEB
          MOVE    PMPXMREL,PKRELP
.
          GOTO    PRAD7000
.
. contact 2 is responsible for account
.
PRAD2000  MOVE    ADMISSNO,PKADMN
          MOVE    PMPXFSNA,PACSNAMX
          MOVE    PMPXFGNA,ANS
          PACK    PACGNAME,ANS,DOT
          MOVE    PMPXFTLE,PACTITLE
          MOVE    THREE,PACFRMT
          CALL    PACNAME
.
          MOVE    PACFNAMX,PKNAME
          MOVE    PMPXFAD1,PKADD1
          MOVE    PMPXFAD2,PKADD2
          MOVE    PMPXFAD3,PKSUBR
          MOVE    PMPXFAD4,PKADD4
          MOVE    PMPXFPOS,PKPOST
          MOVE    PMPXFPNO,PKTELEP
          MOVE    PMPXFBNO,PKTELEB
          MOVE    PMPXFREL,PKRELP
.
          GOTO    PRAD7000
.
. contact 3 is responsible for account
.
PRAD3000  MOVE    ADMISSNO,PKADMN
          MOVE    PNKNAME,PKNAME
          MOVE    PNKADD1,PKADD1
          MOVE    PNKADD2,PKADD2
          MOVE    PNKSUBR,PKSUBR
          MOVE    PNKADD4,PKADD4
          MOVE    PNKPOST,PKPOST
          MOVE    PNKTELP,PKTELEP
          MOVE    PNKTELB,PKTELEB
          MOVE    PNKRELP,PKRELP
.
          GOTO    PRAD7000
.
. contact 4 is responsible for account
.
PRAD4000  MOVE    ADMISSNO,PKADMN
          MOVE    PTMXECNM,PKNAME
          MOVE    PTMXECA1,PKADD1
          MOVE    PTMXECA2,PKADD2
          MOVE    PTMXECA3,PKSUBR
          MOVE    PTMXECA4,PKADD4
          MOVE    PTMXECPC,PKPOST
          MOVE    PTMXECPP,PKTELEP
          MOVE    PTMXECBP,PKTELEB
          MOVE    PTMXECRE,PKRELP
.
          GOTO    PRAD7000
.
. contact 5 is responsible for account
.
PRAD5000  MOVE    ADMISSNO,PKADMN
          MOVE    PTMXNRNM,PKNAME
          MOVE    PTMXNRA1,PKADD1
          MOVE    PTMXNRA2,PKADD2
          MOVE    PTMXNRA3,PKSUBR
          MOVE    PTMXNRA4,PKADD4
          MOVE    PTMXNRPC,PKPOST
          MOVE    PTMXNRPP,PKTELEP
          MOVE    PTMXNRBP,PKTELEB
          MOVE    PTMXNRRE,PKRELP
.
          GOTO    PRAD7000
.
PRAD7000  PACK    KEY8,ADMISSNO,SP10
          CALL    RDARESP1
          IF      OVRCD=1
            CALL    WRRESP1
          ELSE
            CALL    UPRESP1
          ENDIF
.
PRAD9500  MOVE      ZERO,EXIT
.
PRAD9999  RETURN
+
.-----------------------------------------------------------------------------
.         Get Usual PRFA details
.-----------------------------------------------------------------------------
UPRF0000  MATCH     PMPXI104,Z70
          GOTO      UPRF9000 IF EQUAL
.
          PACK      PMPXUPRF,PMPXI104,SP70
          MATCH     SP70,PMPXUPRF
          GOTO      UPRF9000 IF EQUAL
.
          PACK      KEY14,URNUMBER,PMPXUPRF,Z70
          CALL      RSPMCEX1
UPRF1000  CALL      RPPMCEX1
          BRANCH    OVRCD,UPRF9000
.
          MATCH     URNUMBER,PMCEURNO            * Same U/R
          GOTO      UPRF9000 IF NOT EQUAL
.
          MATCH     PMPXUPRF,PMCETYPE            * Same Contact Type
          GOTO      UPRF9000 IF NOT EQUAL
.
          MATCH     "1",PMCEACTV                 * Skip if Inactive
          GOTO      UPRF1000 IF EQUAL
.
          MOVE      PMCESNAM,PACSNAMX
          MOVE      PMCEGNAM,ANS
          PACK      PACGNAME,ANS,DOT
          MOVE      PMCETITL,PACTITLE
          MOVE      THREE,PACFRMT
          CALL      PACNAME
          MOVE      PACFNAMX,PKNAME
.
          MOVE      PMCEADD1,PKADD1         * Address line 1
          MOVE      PMCEADD2,PKADD2         * Address line 2
          MOVE      PMCEADD3,PKSUBR         * Address line 3
          MOVE      PMCEADD4,PKADD4         * Address line 4
          MOVE      PMCEPOST,PKPOST
          MOVE      PMCETELP,PKTELEP
          MOVE      PMCETELB,PKTELEB
          MOVE      PMCERELP,PKRELP
          MOVE      PMCETELM,PTREMOBL
          MOVE      PMCESNAM,PTRESNAM
          MOVE      PMCEGNAM,PTREGNAM
.
          MOVE      ZERO,EXIT
          GOTO      UPRF9999
.
UPRF9000  MOVE      ONE,EXIT
UPRF9999  RETURN
+
.-----------------------------------------------------------------------------
.         Delete Workers comp. details
.-----------------------------------------------------------------------------
.
DEWCOM00  COMPARE   ONE,PTCNHDPS           * Is it for NZ?
          GOTO      DEWCOM10 IF NOT EQUAL  * Not NZ; proceed to delete WC record
.
          MOVE      URNUMBER,CHWCURNO
          MOVE      ADMISSNO,CHWCADMN
          PROC      CHKWCCLM           * check for multiple WC claims records
          BRANCH    EXIT,DEWCOM10
.
.         Only one record with the ACC number, so we just update the
.         Claim Status to "Cancelled" instead of deleting the patwc1af record.
.
          COMPARE   ONE,FORM1            * one record found in CHKWCCLM
          IF        @EQUAL
            MOVE      ADMISSNO,KEY8
            CALL      RDPMWX11
            BRANCH    OVRCD,DEWCOM99
.
            MOVE      THREE,PMWXCSTA     * set Claim Status to "Cancelled"
            CALL      UPPMWX11
          ENDIF
          CALL      MVACCREM           * Add record ACC Audit file
          GOTO      DEWCOM99
.
DEWCOM10  MOVE      ADMISSNO,KEY8
          CALL      RDWCOM1
          COMPARE   ZERO,OVRCD
          IF        @EQUAL
            IF        PTCNHDPS=1            
              CALL      MVACCREM           * Add record ACC Audit file
            ENDIF
            CALL      DEWCOM1
          ENDIF
.
          MOVE      ADMISSNO,KEY8
          CALL      RDPMWX11
          COMPARE   ZERO,OVRCD
          CALL      DEPMWX11 IF EQUAL
.
DEWCOM99  RETURN
+
.-----------------------------------------------------------------------------
.         Delete TAC details
.-----------------------------------------------------------------------------
.
DEWMAB00  MOVE      ADMISSNO,KEY8
          CALL      RDWMAB1
          COMPARE   ZERO,OVRCD
          CALL      DEWMAB1 IF EQUAL
.
DEWMAB99  RETURN
+
.-----------------------------------------------------------------------------
.         Delete Veteran Affairs details
.-----------------------------------------------------------------------------
.
DEWVET00  MOVE      ADMISSNO,KEY8
          CALL      RDWVET1
          COMPARE   ZERO,OVRCD
          CALL      DEWVET1 IF EQUAL
.
DEWVET99  RETURN
+
.-----------------------------------------------------------------------------
.         Delete Civil Tort details
.-----------------------------------------------------------------------------
.
DEWCTC00  MOVE      ADMISSNO,KEY8
          CALL      RDPMCTC1
          COMPARE   ZERO,OVRCD
          CALL      DEPMCTC1 IF EQUAL
.
DEWCTC99  RETURN
+
.-----------------------------------------------------------------------------
. Add record to ACC Audit file when patient changed to non-comp. claim
.-----------------------------------------------------------------------------
MVACCREM  MOVE      ADMISSNO,KEY8
          CALL      RDWCOM1
          BRANCH    OVRCD,MVACCR99
.
          CALL      CLACCAUD
          MATCH     WCCLMNO,Z70
          IF        !@EQUAL
            MOVE      WCCLMNO,ACAUCLMN              * Claim Number
          ENDIF
.
          CALL      IBACLOCK
          PACK      ACAUDATE,CCC,CYY,CMM,CDD        * Date
          REP       " 0",ACAUDATE
          MOVE      CTIMEIS,ACAUTIME
          MOVE      USERID,ACAUWUID                 * Web UserId
.
          MATCH     ADMISSNO,Z70
          IF        !@EQUAL
            MOVE      ADMISSNO,ACAUADMN             * Admission No
          ENDIF
.
          MOVE      "D",ACAUAUTY                    * Audit Type
          MOVE      "A",ACAUTREC                    * ACC Type of Record
.
MVACCR10  PACK      KEY54,ACAUCLMN,ACAUADMN,ACAUDATE,ACAUTIME,ACAUWUID
          CALL      RAACAUD1
          IF        OVRCD=1
            CALL      WRACAUD1
            GOTO      MVACCR99
          ELSE
            CALL      IBACLOCK                    * Set new date and time and
            PACK      ACAUDATE,CCC,CYY,CMM,CDD    * try write again
            REP       " 0",ACAUDATE
            CLOCK     TIME,CTIMEIS
            PACK      ACAUTIME,CTIMEIS
            REP       " 0",ACAUTIME
            GOTO      MVACCR10
          ENDIF
.
MVACCR99  RETURN
.------------------------------------------------------------
. Check user has access to this hospital
.------------------------------------------------------------
CHKHSP00  MOVE      ZERO,EXIT
          PACK      KEY3,WATTR038,SP70
          CALL      RDPTHSP1
          BRANCH    OVRCD,CHKHSP90
.
          PACK      KEY13,WBSEUID,SP70
          CALL      RSMLSEC1
          CALL      RKMLSEC1
          BRANCH    OVRCD,CHKHSP99
.
          MATCH     WBSEUID,MLSCUSID
          GOTO      CHKHSP99 IF NOT EQUAL
.
          PACK      KEY13,WBSEUID,PTHSHOSP,SP70
          CALL      RDMLSEC1
          IF        OVRCD=1
            GOTO      CHKHSP90
          ENDIF
          GOTO      CHKHSP99
.
CHKHSP90  MOVE      ONE,EXIT
.
CHKHSP99  RETURN
+
.------------------------------------------------------------
. Check booking and update if required (Supervisor Function)
.------------------------------------------------------------
CHKBOK00  BRANCH    WMSTAT,CHKBOK99,CHKBOK10,CHKBOK10,CHKBOK10:
                           CHKBOK10,CHKBOK99,CHKBOK99,CHKBOK99:
                           CHKBOK99
.
CHKBOK10  PACK      KEY8,WMBOOK,SP70
          CALL      RDBKREC1
          IF        OVRCD=0
            MOVE      WMCODE,BKREPROC   * Update code and count for theatre
            MOVE      WMCNT,BKRECNT
            CALL      UPBKREC1
          ELSE
            CALL      FNDBOK00            * find current booking
            BRANCH    EXIT,CHKBOK90
            CALL      FIXBOK00            * fix booking number
          ENDIF
.
          COMPARE   ONE,CTHETR
          GOTO      CHKBOK99 IF NOT EQUAL   * not using theatre
.
          PACK      KEY31,WMBOOK,ZERO,SP70
          CALL      RSOPDEA2
CHKBOK20  CALL      RKOPDEA2
          BRANCH    OVRCD,CHKBOK99
.
          PACK      KEY8,WMBOOK,SP70
          MATCH     OPDAADMN,KEY8
          GOTO      CHKBOK99 IF NOT EQUAL
.
          COMPARE   THREE,OPDASTAT
          GOTO      CHKBOK20 IF EQUAL
.
          MOVE      WMCODE,OPDAPROC
          MOVE      DWMCNT,OPDACONT
          CALL      IBACLOCK
          PACK      OPDAUDAT,CCC,CYY,CMM,CDD
          REP       " 0",OPDAUDAT
.
          CLOCK     TIME,OPDAUTIM
          MOVE      WBSEUID,OPDAWEBU
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          CALL      UPOPDEA2
          MOVE      TWO,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLIS14                * send update booking message
.
          GOTO      CHKBOK99
.
CHKBOK90  MOVE    "No valid booking found, booking details not updated",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKBOK99
.
CHKBOK99  RETURN
+
.------------------------------------------------------------
. Find current booking record           
.------------------------------------------------------------
FNDBOK00  MOVE      ZERO,EXIT
          MOVE      ZEROVISN,FIXBOKNO
          PACK      KEY16,WMURNO,Z70
          CALL      RSBKREC6
FNDBOK10  CALL      RPBKREC6
          BRANCH    OVRCD,FNDBOK90
.
          MATCH     BKREURNO,WMURNO
          GOTO      FNDBOK90 IF NOT EQUAL
.
          MATCH     BKREPROC,WMCODE
          GOTO      FNDBOK10 IF NOT EQUAL
.
          COMPARE   BKRECNT,WMCNT
          GOTO      FNDBOK10 IF NOT EQUAL
.
          COMPARE   TWO,BKRESTAT
          GOTO      FNDBOK10 IF EQUAL
.
          MOVE      BKREBOOK,FIXBOKNO
          GOTO      FNDBOK99
.
FNDBOK90  MOVE      ONE,EXIT
.
FNDBOK99  RETURN
+
.------------------------------------------------------------
. Fix booking number          
.------------------------------------------------------------
FIXBOK00  PACK      KEY8,WMBOOK
          CALL      RDBKREC1
          IF        OVRCD=0
            GOTO      FIXBOK99
          ENDIF
.
          PACK      KEY8,FIXBOKNO,SP70
          CALL      RDBKREC1
          BRANCH    OVRCD,FIXBOK99
.
          IF        WMSTAT=2 
            MOVE      ZERO,BKRESTAT               * scheduled
          ENDIF
.
          IF        WMSTAT=3 
            MOVE      ONE,BKRESTAT               * pre-admitted
          ENDIF
.
          IF        WMSTAT=4 
            MOVE      THREE,BKRESTAT             * admitted
          ENDIF
.
          IF        WMSTAT=5 
            MOVE      FOUR,BKRESTAT             * discharged
          ENDIF
.
          MOVE      WMBOOK,BKREBOOK
          CALL      UPBKREC1
.
FIXBOK99  RETURN
+
.------------------------------------------------------------
. Update to Status (Taken from IBAWAT91)
.------------------------------------------------------------
UPSTA000  COMPARE   ONE,WMSTAT
          GOTO      UPSTA999 IF NOT EQUAL
.
          MOVE      WMBOOK,KEY8             * booking number as key
          CALL      RDBKREC1                * read booking file
          BRANCH    OVRCD,UPSTA100          * no record, update treatment file
          MOVE      SP70,BKREPROC           * I CAR 41296
          MOVE      ZERO,BKRECNT            
          CALL      UPBKREC1                * end I CAR 41296
.                                           * D CAR 41296
.         CALL      DEBKREC1                * delete the booking file
.
.         MOVE      WMBOOK,KEY8             * booking number as key
.         CALL      RDBKRX11                * read booking file
.         BRANCH    OVRCD,UPSTA100          * no record, update treatment file
.         CALL      DEBKRX11                * delete the booking file
.                                           * end D CAR 41296
UPSTA100  CALL      GENBOKNO                * Get WL Booking Number
          CALL      ERVS0000              * Update eReferral
.
UPSTA999  RETURN
.------------------------------------------------------------
. Write record to Category Change file  watcataf
.------------------------------------------------------------
UPPRI000  MOVE      PRIORITY,WTCACODF         * set the old priority code
          MOVE      WMPTY,WTCACODT            * set the new priority code
          MOVE      WMURNO,WTCAURNO           * set the UR number
          MOVE      WMCODE,WTCAPROC           * set procedure code
          MOVE      WMCNT,WTCAPCNT            * set procedure counter
          MOVE      WBSEUID,WTCAWEBI          * set up web user id
          CALL      IBACLOCK
          PACK      WTCAADTE,CCC,CYY,CMM,CDD  * set alteration date
          REP       " 0",WTCAADTE
          PACK      WTCAATIM,CTIMEIS          * set alteration time
.                                              
.                                             * Date Effective
.
          MATCH     Z70,WATHI002
          IF        !@EQUAL
            MOVE      WATHI002,WTCAEDAT         * set effective date
          ELSE
            PACK      WTCAEDAT,CCC,CYY,CMM,CDD  * set effective date
          ENDIF
          REP       " 0",WTCAEDAT


.
          MOVE      "TP",WTCACATF             * set the priority code category
          PACK      KEY29,WTCAEDAT,WTCACATF,WMURNO,WMCODE,WMCNT
          CALL      RAWTCAT1                  * Check if a record exists first
          IF        OVRCD=0
            CALL      UPWTCAT1                * Update priority file
            CALL      WURG0000
          ELSE
            CALL      WRWTCAT1                * write change priority file
            CALL      WURG0000
          ENDIF
          CALL      WRTHIS00
          PACK      SAVEPRIO,WMPTY
          RETURN
.------------------------------------------------------------
. Write record to Category Change file  watcataf
.------------------------------------------------------------
UPCAR000  MOVE      PRIORCC,WTCACODF         * set the old priority code
          MOVE      WTWMEATY,WTCACODT            * set the new priority code
          MOVE      WMURNO,WTCAURNO           * set the UR number
          MOVE      WMCODE,WTCAPROC           * set procedure code
          MOVE      WMCNT,WTCAPCNT            * set procedure counter
          PACK      WTCAEDAT,CCC,CYY,CMM,CDD  * set effective date
          REP       " 0",WTCAEDAT
          MOVE      "CC",WTCACATF             * set the priority code category
          PACK      KEY29,WTCAEDAT,WTCACATF,WMURNO,WMCODE,WMCNT
          CALL      RAWTCAT1                  * Check if a record exists first
          IF        OVRCD=0
            CALL      UPWTCAT1                * Update priority file
          ELSE
            CALL      WRWTCAT1                * write change priority file
          ENDIF
          RETURN
.------------------------------------------------------------
. Write record to Category Change file  watcataf
.------------------------------------------------------------
UPRNK000  CALL      IBACLOCK
          MATCH     "     0",WTWMRANK
          IF        !@EQUAL
            MATCH     WMDATE2,SAVEDAT2
            IF        !@EQUAL
              PACK      WTHIRCDT,WMDATE2
              REP       " 0",WTHIRCDT
            ELSE
              PACK      WTHIRCDT,CCC,CYY,CMM,CDD
              REP       " 0",WTHIRCDT
            ENDIF
            MOVE      "07",WTWMBSCD
            MOVE      ONE,NBRFLAG
            MOVE      SP70,SAVEBSCD
            GOTO      UPRNK999
          ENDIF
          PACK      KEY5,ANSV,ANSL,WTTXPLST,SP70
          CALL      RDCODE1
          MATCH     ANST,TCINDC2
          GOTO      UPRNK100 IF EQUAL
          MATCH     ANSP,TCINDC2
          GOTO      UPRNK100 IF EQUAL
          MATCH     ANSC,TCINDC2
          GOTO      UPRNK999 IF NOT EQUAL
.
UPRNK100  MOVE      "07",WTWMBSCD
          MATCH     WMDATE2,SAVEDAT2
          IF        !@EQUAL
            PACK      WTHIRCDT,WMDATE2
            REP       " 0",WTHIRCDT
          ELSE
            PACK      WTHIRCDT,CCC,CYY,CMM,CDD
            REP       " 0",WTHIRCDT
          ENDIF
          MOVE      ONE,NBRFLAG
          MOVE      SP70,SAVEBSCD
.
UPRNK999  RETURN
.------------------------------------------------------------
. Delete Waiting List Procedure
.------------------------------------------------------------
DELWAT00  MOVE      CASEKEYS,KEY19
          CALL      RLWTTRE1
          BRANCH    OVRCD,DELWAT90,DELWAT91
          CALL      RLWTTX11
          BRANCH    OVRCD,DELWAT90,DELWAT91
.
          PACK      OLDVAL07,WMDATE4,WMREMOVE,SP70    * Save removal for audit
          PACK      OLDVAL13,WMDATE4,SP70             * Save removal for audit
.
          PACK      KEY19,WMURNO,WMCODE,WMCNT,SP70
          CALL      RDWTRTD1
          IF        OVRCD=1
            MOVE     SP70,WTRTREFR
            MOVE     SP70,WTRTTDES
          ENDIF
.
          COMPARE   SIX,WMSTAT
          IF        @EQUAL
            PACK      KEY8,WMDATE4,Z70
            CALL      RSWTEST1
            CALL      RKWTEST1
            BRANCH    OVRCD,DELWAT10
            MATCH     WMDATE4,WTESSDAT
            GOTO      DELWAT10 IF LESS
            GOTO      DELWAT80
          ENDIF
.
          CALL      CHKDEL00                     * Check if patient is suspended
          BRANCH    EXIT,DELWAT94,DELWAT95
.
          CALL      CHKINT00      * Check no ESIS intra events> removal date
          BRANCH    EXIT,DELWAT96
.
          COMPARE   ONE,WMSTAT
          GOTO      DELWAT10 IF EQUAL
.
          MATCH     SP70,WATTR010
          GOTO      DELWAT93 IF EQUAL
.
          PACK      KEY5,ANSW,ANSR,WATTR010,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,DELWAT93
.
          MATCH     ANSX,TCINDC3       * admitted to other hospital
          GOTO      DELWAT10 IF EQUAL
.
          MATCH     ANSP,TCINDC3       * admitted to other hospital
          GOTO      DELWAT93 IF NOT EQUAL
.
DELWAT10  CALL      SAVHIS00           * write to Waiting List History
          CALL      SAVHSS00           * write to Waiting List History
          MOVE      ONE,NBRFLAG
          MOVE      "20",WTWMBSCD
          CALL      MVWDET00
          MOVE      "6",WMSTAT
          IF        CANCELRM=1
            MOVE      SP70,WMREMOVE
            MOVE      SP70,WMDATE4
            MOVE      ONE,WMSTAT
            MOVE      "05",WTWMBSCD
            CALL      GENBOKNO
            MOVE      ONE,NBRFLAG
            MOVE      SP70,WTTXRTIM
          ENDIF
          CALL      UPTREA1
.
          PACK      WTRTURNO,WMURNO,SP70
          PACK      WTRTPROC,WMCODE,SP70
          PACK      WTRTPCNT,WMCNT,SP70
          PACK      KEY19,WTRTURNO,WTRTPROC,WTRTPCNT,SP70
          CALL      RDWTRTD1
          IF        OVRCD=1
            MOVE      SP70,WTRTREFR
            MOVE      SP70,WTRTTDES
          ENDIF
.
          MATCH     Z70,TRNSFSRC
          IF        !@EQUAL
            MATCH     SP70,TRNSFSRC
            IF        !@EQUAL
              MOVE      TRNSFSRC,WTRTTDES
            ENDIF
          ENDIF
          PACK      WTRTSPAR,SP70
.
          PACK      KEY19,WTRTURNO,WTRTPROC,WTRTPCNT,SP70
          CALL      RAWTRTD1
          IF        OVRCD=1
            CALL      WRWTRTD1       * referral & transfer destination
          ELSE
            CALL      UPWTRTD1
          ENDIF
.
          IF        WMSTAT = 6
            CALL      PMIGTNID            * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      TEN5,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLIRWL            * HL7 - Remove Waiting List Entry
          ENDIF
.
          CALL      PMIGTNID              * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      THREE,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICWC              * DG API Cancel Waiting List *C-90222
.
          CALL      IBACLOCK
          REP       " 0",XCDATE
          MOVE      XCDATE,WTTXLUPD       * Current Time
          CLOCK     TIME,WTTXLUPT         * Current Time
          MOVE      USERID,WTTXWEBU
          MOVE      USERID,WTTXUIDR
          MATCH     Z70,WATTX026
          IF        !@EQUAL
            MOVE      WATTX026,WTTXCTYP      * Update Claim type with "Insurance
          ENDIF
          IF        CANCELRM<>1
            MATCH     Z70,WATTX045
            IF        !@EQUAL
              MOVE      WATTX045,WTTXRTIM      * Update removal time
            ENDIF
          ENDIF
          CALL      UPWTTX11              * Declaration" on Procedure Remove Scr
.
          MOVE      ZERO,ADDWLFLG
          IF        CANCELRM=1
            COMPARE   ONE,PTCNHDPS
            IF        @EQUAL
              MOVE      ONE,NBRFLAG
              MOVE      "05",WTWMBSCD
              CALL      WRTHIS00           * write to Waiting List History
            ELSE
              MOVE      "32",WTWMBSCD
              CALL      WRTHSS00           * write to Waiting List History
            ENDIF
            CALL      WRCHH000             * Write return to WL integrity audit
          ELSE
            CALL      WRTHIS00             * write to Waiting List History
          ENDIF
.
          CALL      WRCHD000               * Write removal data integrity audit
          CALL      WRCHE000        * Write update removal data integrity audit
.
          CALL      WESE0000
          CALL      UUWTTRE1
          CALL      UUWTTX11
.
          MOVE      ZERO,EXIT
          GOTO      DELWAT99
.
DELWAT80  MOVE      "ESIS has been sealed, cannot update.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DELWAT99
.
DELWAT90  MOVE      "Invalid Waiting List Record.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DELWAT99
.
DELWAT91  MOVE      "Waiting List Record Locked.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DELWAT99
.
DELWAT92  MOVE      "Patient is already Removed from Waiting List",WEBTITLE
          CALL      WEBERR00
          MOVE      ZERO,EXIT
          GOTO      DELWAT99
.
DELWAT93  MOVE      "Cannot Remove as Patient is booked",WEBTITLE
          CALL      WEBERR00
          MOVE      ZERO,EXIT
          GOTO      DELWAT99
.
DELWAT94  MOVE      "Cannot Remove - Patient is Suspended",WEBTITLE
          CALL      WEBERR00
          MOVE      ZERO,EXIT
          GOTO      DELWAT99
.
DELWAT95  MOVE      "Cannot Remove - Future suspensions exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ZERO,EXIT
          GOTO      DELWAT99
.
DELWAT96  MOVE      "Cannot Remove on this date - intra episodes exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ZERO,EXIT
          GOTO      DELWAT99
.
DELWAT99  CALL      UUWTTRE1
          CALL      UUWTTX11
          RETURN
.
CLWATHIS  MOVE      SP70,WTHIURNO
          MOVE      SP70,WTHIPROC
          MOVE      SP70,DWTHIPCN
          MOVE      SP70,WTHIEDAT
          MOVE      SP70,DWTHIUCN
          MOVE      SP70,WTHIPRIO
          MOVE      "      0",WTHIRANK
          MOVE      SP70,WTHIDAT2
          MOVE      SP70,WTHIDAT3
          MOVE      SP70,WTHIRDT3
          MOVE      SP70,WTHIBSCD
          MOVE      SP70,WTHIDCGV
          MOVE      SP70,WTHIDBFT
          MOVE      SP70,WTHIRECS
.      
          MOVE      SP70,WTHIRTYP
          MOVE      SP70,WTHIRCDT
          MOVE      SP70,WTHIBMDT
          MOVE      SP70,WTHIETIM
          MOVE      SP70,WTHIADTE
          MOVE      SP70,WTHIATIM
          MOVE      SP70,WTHIWEBI
          MOVE      SP70,WTHIBCAN
          MOVE      SP70,WTHIBOOK
          MOVE      SP70,WTHIDOCT
          MOVE      SP70,WTHIBOKC
          MOVE      SP70,WTHIUNIT
          MOVE      SP70,WTHIPLST
          MOVE      SP70,WTHISTAT
          MOVE      SP70,WTHIDAT1
          MOVE      SP70,WTHIDTAD
          MOVE      SP70,WTHIPODT
          MOVE      SP70,WTHICODT
          MOVE      SP70,WTHIHIDE
          MOVE      SP70,WTHISPAR
          MOVE      SP70,SAVEPRIO 
          MOVE      SP70,SAVERANK
          MOVE      SP70,SAVEDAT2
          MOVE      SP70,SAVEDAT3 
          MOVE      SP70,SAVERDT3
          MOVE      SP70,SAVESCHA
          MOVE      SP70,SAVEBSCD
          MOVE      SP70,SAVERCSD
          MOVE      SP70,SAVBMDT
          MOVE      SP70,SAVDBFT
          MOVE      SP70,SAVRCDT
          MOVE      SP70,SAVDOCTR
          MOVE      SP70,SAVEBRSR
          MOVE      SP70,SAVEDRSA
          MOVE      SP70,SAVEDOSA
          MOVE      SP70,SAVEPHSP
          MOVE      SP70,SAVEPCAT
          MOVE      SP70,SAVECSST
          MOVE      SP70,SAVECSDT
          MOVE      SP70,SAVEASSR
.
CLWATH99  RETURN
.
.------------------------------------------------------------
. Move in Waiting List Extract Details
.------------------------------------------------------------
MVEXT000  MATCH     Z70,WATEX001
          IF        !@EQUAL
            MOVE       WATEX001,WTEXCODE
          ENDIF
          MATCH     Z70,WATEX002
          IF        !@EQUAL
            MOVE       WATEX002,WTEXDESC
          ENDIF
.
          MATCH     Z70,WATEX003
          IF        !@EQUAL
            MATCH     "Start",WATEX003
            IF        @EQUAL
              MOVE      SP70,WTEXFLDT
            ELSE
              UNPACK    WATEX003,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      WTEXFLDT,CCENT,CYEAR,CMON,CDAY
              REP       " 0",WTEXFLDT
            ENDIF
          ENDIF
          MATCH     Z70,WATEX004
          IF        !@EQUAL
            MATCH     "Finish",WATEX004
            IF        @EQUAL
              MOVE      Z70,WTEXTLDT
            ELSE
              UNPACK    WATEX004,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      WTEXTLDT,CCENT,CYEAR,CMON,CDAY
              REP       " 0",WTEXTLDT
            ENDIF
          ENDIF
.
          MATCH     Z70,WATEX005
          IF        !@EQUAL
            MATCH     "Start",WATEX005
            IF        @EQUAL
              MOVE      SP70,WTEXFVDT
            ELSE
              UNPACK    WATEX005,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      WTEXFVDT,CCENT,CYEAR,CMON,CDAY
              REP       " 0",WTEXFVDT
            ENDIF
          ENDIF
          MATCH     Z70,WATEX006
          IF        !@EQUAL
            MATCH     "Finish",WATEX006
            IF        @EQUAL
              MOVE      Z70,WTEXTVDT
            ELSE
              UNPACK    WATEX006,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      WTEXTVDT,CCENT,CYEAR,CMON,CDAY
              REP       " 0",WTEXTVDT
            ENDIF
          ENDIF
.
          MATCH     Z70,WATEX007
          IF        !@EQUAL
            MATCH     "Start",WATEX007
            IF        @EQUAL
              MOVE      SP70,WTEXFSDT
            ELSE
              UNPACK    WATEX007,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      WTEXFSDT,CCENT,CYEAR,CMON,CDAY
              REP       " 0",WTEXFSDT
            ENDIF
          ENDIF
          MATCH     Z70,WATEX008
          IF        !@EQUAL
            MATCH     "Finish",WATEX008
            IF        @EQUAL
              MOVE      Z70,WTEXTSDT
            ELSE
              UNPACK    WATEX008,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      WTEXTSDT,CCENT,CYEAR,CMON,CDAY
              REP       " 0",WTEXTSDT
            ENDIF
          ENDIF
.
          MATCH     Z70,WATEX009
          IF        !@EQUAL
            MATCH     "Start",WATEX009
            IF        @EQUAL
              MOVE      SP70,WTEXFRDT
            ELSE
              UNPACK    WATEX009,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      WTEXFRDT,CCENT,CYEAR,CMON,CDAY
              REP       " 0",WTEXFRDT
            ENDIF
          ENDIF
          MATCH     Z70,WATEX010
          IF        !@EQUAL
            MATCH     "Finish",WATEX010
            IF        @EQUAL
              MOVE      Z70,WTEXTRDT
            ELSE
              UNPACK    WATEX010,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      WTEXTRDT,CCENT,CYEAR,CMON,CDAY
              REP       " 0",WTEXTRDT
            ENDIF
          ENDIF
.
          MATCH     Z70,WATEX011
          IF        !@EQUAL
            MOVE       WATEX011,WTEXUNT 
          ENDIF
.
          MATCH     Z70,WATEX012
          IF        !@EQUAL
            MOVE       WATEX012,WTEXPRI 
          ENDIF
.
          MATCH     Z70,WATEX013
          IF        !@EQUAL
            MOVE       WATEX013,WTEXNOT 
          ENDIF
.
          MATCH     Z70,WATEX014
          IF        !@EQUAL
            MOVE       WATEX014,WTEXPGP 
          ENDIF
.
          MATCH     Z70,WATEX015
          IF        !@EQUAL
            MOVE       WATEX015,WTEXRMR 
          ENDIF
.
          MATCH     Z70,WATEX016
          IF        !@EQUAL
            MOVE       WATEX016,WTEXRGP 
          ENDIF
.
          MATCH     Z70,WATEX017
          IF        !@EQUAL
            MOVE       WATEX017,WTEXCON 
          ENDIF
.
          MATCH     Z70,WATEX018
          IF        !@EQUAL
            MOVE       WATEX018,WTEXPRO 
          ENDIF
.
          MATCH     Z70,WATEX019
          IF        !@EQUAL
            MOVE       WATEX019,WTEXSRC 
          ENDIF
.
          MATCH     Z70,WATEX020
          IF        !@EQUAL
            MOVE       WATEX020,WTEXUD1 
          ENDIF
.
          MATCH     Z70,WATEX021
          IF        !@EQUAL
            MOVE       WATEX021,WTEXUD2 
          ENDIF
.
          MATCH     Z70,WATEX022
          IF        !@EQUAL
            MOVE       WATEX022,WTEXUD3 
          ENDIF
.
          MATCH     Z70,WATEX023
          IF        !@EQUAL
            MOVE       WATEX023,WTEXUD4 
          ENDIF
.
          MATCH     Z70,WATEX024
          IF        !@EQUAL
            MOVE       WATEX024,WTEXUD5 
          ENDIF
.
          MATCH     Z70,WATEX025
          IF        !@EQUAL
            MOVE       WATEX025,WTEXUD6 
          ENDIF
.
          MATCH     Z70,WATEX026
          IF        !@EQUAL
            MOVE       WATEX026,WTEXUD7 
          ENDIF
.
          MATCH     Z70,WATEX027
          IF        !@EQUAL
            MOVE       WATEX027,WTEXUD8 
          ENDIF
.
          MATCH     Z70,WATEX028
          IF        !@EQUAL
            MOVE       WATEX028,WTEXSTA 
          ENDIF
.
          MATCH     Z70,WATEX028
          IF        !@EQUAL
            MOVE       WATEX028,WTEXSTA 
          ENDIF
.
          MATCH     Z70,WATEX036
          IF        !@EQUAL
            MOVE       WATEX036,WTEXPOWD
          ENDIF
.
          MATCH     Z70,WATEX037
          IF        !@EQUAL
            MOVE       WATEX037,WTEXIDYC
          ENDIF
.
          MATCH     Z70,WATEX038
          IF        !@EQUAL
            MATCH     SP70,WATEX038
            IF        !@EQUAL
              STRIP     WATEX038
              MOVE      WATEX038,F3
              MOVE      F3,WTEXLLSC
            ELSE
              MOVE      SP70,WTEXLLSC
            ENDIF
          ENDIF
.
          MATCH     Z70,WATEX039
          IF        !@EQUAL
            MOVE       ONE,WTEXCRTL
          ELSE
            MOVE       ZERO,WTEXCRTL
          ENDIF
.
          MATCH     Z70,WATEX040
          IF        !@EQUAL
            MOVE       WATEX040,WTEXADMW
          ENDIF
.
          MATCH     Z70,WATEX041
          IF        !@EQUAL
            MOVE       ONE,WTEXINCD
          ELSE
            MOVE       ZERO,WTEXINCD
          ENDIF
.
          MATCH     Z70,WATEX042
          IF        !@EQUAL
            MOVE       ONE,WTEXOVON
          ELSE
            MOVE       ZERO,WTEXOVON
          ENDIF
.
          MATCH     Z70,WATEX043
          IF        !@EQUAL
            MOVE       WATEX043,WTEXCTYP
          ENDIF
.
          MATCH     Z70,WATEX044
          IF        !@EQUAL
            MOVE       WATEX044,WTEXLIST
          ENDIF
.
          MATCH     Z70,WATEX045
          IF        !@EQUAL
            MATCH     "Start",WATEX045
            IF        @EQUAL
              MOVE      SP70,WTEXFURN
            ELSE
              MOVE      WATEX045,WTEXFURN
            ENDIF
          ENDIF
.
          MATCH     Z70,WATEX046
          IF        !@EQUAL
            MATCH     "Finish",WATEX046
            IF         @EQUAL
              MOVE       Z70,WTEXTURN 
            ELSE
              MOVE       WATEX046,WTEXTURN
            ENDIF
          ENDIF
.
          MATCH     Z70,WATEX047
          IF        !@EQUAL
            MATCH      "Finish",WATEX047
            IF        @EQUAL
              MOVE      Z70,WTEXTPRO
            ELSE
              MOVE       WATEX047,WTEXTPRO
            ENDIF
          ENDIF
.
          MATCH     Z70,WATEX048
          IF        !@EQUAL
            MOVE       WATEX048,WTEXTPRS
          ENDIF
.
          MATCH     Z70,WATEX049
          IF        !@EQUAL
            MATCH     SP70,WATEX049
            IF        @EQUAL
              MOVE      Z70,WTEXTUNI
            ELSE
              MOVE       WATEX049,WTEXTUNI
            ENDIF
          ENDIF
.
          MATCH     Z70,WATEX050
          IF        !@EQUAL
            MATCH     "Start",WATEX050
            IF         @EQUAL
              MOVE       SP70,WTEXFCON
            ELSE
              MOVE       WATEX050,WTEXFCON
            ENDIF
          ENDIF
.
          MATCH     Z70,WATEX051
          IF        !@EQUAL
            MATCH      "Finish",WATEX051
            IF         @EQUAL
              MOVE       Z70,WTEXTCON
            ELSE
              MOVE       WATEX051,WTEXTCON
            ENDIF
          ENDIF
.
          MATCH     Z70,WATEX052
          IF        !@EQUAL
            SQUEEZE    WATEX052
            MATCH      WATEX052,SP70
            IF         @EQUAL
             MOVE        ZERO,FORM5
            ELSE
              MOVE       WATEX052,FORM5
            ENDIF
            MOVE       FORM5,WTEXFSES
          ENDIF
.
          MATCH     Z70,WATEX053
          IF        !@EQUAL
            SQUEEZE    WATEX053
            MATCH      WATEX053,SP70
            IF         @EQUAL
              MOVE       ZERO,FORM5
            ELSE 
              MOVE       WATEX053,FORM5
            ENDIF
            MOVE       FORM5,WTEXTSES
          ENDIF
.
          MATCH     Z70,WATEX054
          IF        !@EQUAL
            MOVE       WATEX054,WTEXADTY
          ENDIF
.
          MATCH     Z70,WATEX055
          IF        !@EQUAL
            MOVE       WATEX055,WTEXRSTA
          ENDIF
.
          MATCH     Z70,WATEX056
          IF        !@EQUAL
            MATCH     "Start",WATEX056
            IF        @EQUAL
              MOVE      SP70,WTEXFPAD
            ELSE
              UNPACK    WATEX056,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      WTEXFPAD,CCENT,CYEAR,CMON,CDAY
              REP       " 0",WTEXFPAD
            ENDIF
          ENDIF
.
          MATCH     Z70,WATEX057
          IF        !@EQUAL
            MATCH     "Finish",WATEX057
            IF        @EQUAL
              MOVE      Z70,WTEXTPAD
            ELSE
              UNPACK    WATEX057,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      WTEXTPAD,CCENT,CYEAR,CMON,CDAY
              REP       " 0",WTEXTPAD
            ENDIF
          ENDIF
.
          MATCH     Z70,WATEX058
          IF        !@EQUAL
            MATCH     "Start",WATEX058
            IF        @EQUAL
              MOVE      SP70,WTEXFSYD
            ELSE
              UNPACK    WATEX058,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      WTEXFSYD,CCENT,CYEAR,CMON,CDAY
              REP       " 0",WTEXFSYD
            ENDIF
          ENDIF
.
          MATCH     Z70,WATEX059
          IF        !@EQUAL
            MATCH     "Finish",WATEX059
            IF        @EQUAL
              MOVE      Z70,WTEXTSYD
            ELSE
              UNPACK    WATEX059,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      WTEXTSYD,CCENT,CYEAR,CMON,CDAY
              REP       " 0",WTEXTSYD
            ENDIF
          ENDIF
.
          MATCH     Z70,WATEX060
          IF        !@EQUAL
            MATCH     "Start",WATEX060
            IF        @EQUAL
              MOVE      SP70,WTEXFSUD
            ELSE
              UNPACK    WATEX060,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      WTEXFSUD,CCENT,CYEAR,CMON,CDAY
              REP       " 0",WTEXFSUD
            ENDIF
          ENDIF
.
          MATCH     Z70,WATEX061
          IF        !@EQUAL
            MATCH     "Finish",WATEX061
            IF        @EQUAL
              MOVE      Z70,WTEXTSUD
            ELSE
              UNPACK    WATEX061,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      WTEXTSUD,CCENT,CYEAR,CMON,CDAY
              REP       " 0",WTEXTSUD
            ENDIF
          ENDIF
.
          MATCH     Z70,WATEX062
          IF        !@EQUAL
            MATCH     "Start",WATEX062
            IF        @EQUAL
              MOVE      SP70,WTEXFOSD
            ELSE
              UNPACK    WATEX062,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      WTEXFOSD,CCENT,CYEAR,CMON,CDAY
              REP       " 0",WTEXFOSD
            ENDIF
          ENDIF
.
          MATCH     Z70,WATEX063
          IF        !@EQUAL
            MATCH     "Finish",WATEX063
            IF        @EQUAL
              MOVE      Z70,WTEXTOSD
            ELSE
              UNPACK    WATEX063,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      WTEXTOSD,CCENT,CYEAR,CMON,CDAY
              REP       " 0",WTEXTOSD
            ENDIF
          ENDIF
.
          MATCH     Z70,WATEX064
          IF        !@EQUAL
            MATCH     "Start",WATEX064
            IF        @EQUAL
              MOVE      SP70,WATEX064
            ELSE
              MOVE      WATEX064,WTEXFPRO
            ENDIF
          ENDIF
.
          MATCH     Z70,WATEX065
          IF        !@EQUAL
            MATCH     "Finish",WATEX065
            IF        @EQUAL
              MOVE      Z70,WATEX065
            ELSE
              MOVE      WATEX065,WTEXFPRS
            ENDIF
          ENDIF
.
          MATCH     Z70,WATEX066
          IF        !@EQUAL
            MATCH     SP70,WATEX066
            IF        @EQUAL
              MOVE      SP70,WTEXFUNI
            ELSE
              MOVE      WATEX066,WTEXFUNI
            ENDIF
          ENDIF
.
RETURN
.---------------------------------------------------------------------
. Set Analysis Levels to SP70                
.---------------------------------------------------------------------
SETANA00  MOVE      SP70,WTEXANL1
          MOVE      SP70,WTEXANL2
          MOVE      SP70,WTEXANL3
          MOVE      SP70,WTEXANL4
          MOVE      SP70,WTEXANM1
          MOVE      SP70,WTEXANM2
          MOVE      SP70,WTEXANM3
.
STEANA99  RETURN
.---------------------------------------------------------------------
. Move Waiting List Analysis Extract Details
.---------------------------------------------------------------------
MVANA000  MATCH     Z70,WATEX029
          IF        !@EQUAL
            MOVE       WATEX029,WTEXANL1
          ENDIF
.
          MATCH     Z70,WATEX030
          IF        !@EQUAL
            MOVE       WATEX030,WTEXANL2
          ENDIF
.
          MATCH     Z70,WATEX031
          IF        !@EQUAL
            MOVE       WATEX031,WTEXANL3
          ENDIF
.
          MATCH     Z70,WATEX032
          IF        !@EQUAL
            MOVE       WATEX032,WTEXANL4
          ENDIF
.
          MATCH     Z70,WATEX033
          IF        !@EQUAL
            MOVE       WATEX033,WTEXANM1
          ENDIF
.
          MATCH     Z70,WATEX034
          IF        !@EQUAL
            MOVE       WATEX034,WTEXANM2
          ENDIF
.
          MATCH     Z70,WATEX035
          IF        !@EQUAL
            MOVE       WATEX035,WTEXANM3
          ENDIF
.
MVANA999  RETURN
.------------------------------------------------------------
. Move in Waiting List Details
.------------------------------------------------------------
MVLHI000  MATCH     Z70,WATLH001
          IF        !@EQUAL
            MATCH     SP70,WATLH001
            IF        @EQUAL
              MOVE      SP70,WTLHDATE
            ELSE
              UNPACK    WATLH001,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      WTLHDATE,CCENT,CYEAR,CMON,CDAY
              REP       " 0",WTLHDATE
            ENDIF
          ENDIF
          MATCH     Z70,WATLH002
          IF        !@EQUAL
            SQUEEZE    WATLH002
            MOVE       WATLH002,WTLHLNUM
          ENDIF
          MATCH     Z70,WATLH003
          IF        !@EQUAL
            MOVE       WATLH003,WTLHRPLY
            MATCH      SP70,WTLHRPLY
            IF         @EQUAL|@EOS
              MOVE      SP70,WTLHREPR              * Clear reply date if no
            ELSE                                   * reply reason
              PACK       WTLHREPR,CCC,CYY,CMM,CDD
              REP        " 0",WTLHREPR
            ENDIF
          ENDIF
          MATCH     Z70,WATLH004
          IF        !@EQUAL
            MOVE       WATLH004,WTLHACTN
          ENDIF
          RETURN
.------------------------------------------------------------
. Move in Waiting List Details
.------------------------------------------------------------
MVWDET00  MATCH     Z70,WATTR001
          IF        !@EQUAL
            MOVE       WATTR001,WMCODE
          ENDIF
          MATCH     Z70,WATTR002
          IF        !@EQUAL
              SQUEEZE    WATTR002
              MOVE       WATTR002,WMTIME
          ENDIF
          MATCH     Z70,WATTR003
          IF        !@EQUAL
            MOVE       WATTR003,WMDESC
          ENDIF
          MATCH     Z70,WATTR004
          IF        !@EQUAL
            MOVE       WATTR004,WMREASON
          ENDIF
          MATCH     Z70,WATTR005
          IF        !@EQUAL
            SQUEEZE    WATTR005
            MOVE       WATTR005,WMSTAT
          ENDIF
          MATCH     Z70,WATTR006
          IF        !@EQUAL
            MATCH     SP70,WATTR006
            IF        !@EQUAL
              UNPACK    WATTR006,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      WMDATE1,CCENT,CYEAR,CMON,CDAY
              REP       " 0",WMDATE1
            ELSE
              MOVE      SP70,WMDATE1
            ENDIF
          ENDIF
          MATCH     Z70,WATTR007
          IF        !@EQUAL
            MATCH     SP70,WATTR007
            IF        !@EQUAL
              UNPACK    WATTR007,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      WMDATE2,CCENT,CYEAR,CMON,CDAY
              REP       " 0",WMDATE2
            ELSE
              MOVE      SP70,WMDATE2
            ENDIF
          ENDIF
          MATCH     Z70,WATTR008
          IF        !@EQUAL
            MATCH     SP70,WATTR008
            IF        !@EQUAL
              UNPACK    WATTR008,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      WMDATE3,CCENT,CYEAR,CMON,CDAY
              REP       " 0",WMDATE3
            ELSE
              MOVE      SP70,WMDATE3
            ENDIF
          ENDIF
          MATCH     Z70,WATTR009
          IF        !@EQUAL
            MATCH     SP70,WATTR009
            IF        !@EQUAL
              UNPACK    WATTR009,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      WMDATE4,CCENT,CYEAR,CMON,CDAY
              REP       " 0",WMDATE4
            ELSE
              MOVE      SP70,WMDATE4
            ENDIF
          ENDIF
          MATCH     Z70,WATTR010
          IF        !@EQUAL
            MOVE      WATTR010,WMREMOVE
          ENDIF
          MATCH     Z70,WATTR011
          IF        !@EQUAL
            MOVE      WATTR011,WMUNIT
          ENDIF
          MATCH     Z70,WATTR012
          IF        !@EQUAL
            MOVE      WATTR012,WMDOCTOR
          ENDIF
          MATCH     Z70,WATTR013
          IF        !@EQUAL
            SQUEEZE   WATTR013
            MOVE      WATTR013,WMSTAY
          ENDIF
          MATCH     Z70,WATTR014
          IF        !@EQUAL
            MOVE      WATTR014,WMPTY
          ENDIF
          MATCH     Z70,WATTR015
          IF        !@EQUAL
            MOVE      WATTR015,WMNOTICE
          ENDIF
          MATCH     Z70,WATTR016
          IF        !@EQUAL
            MOVE      WATTR016,WMPTYPE
          ENDIF
          MATCH     Z70,WATTR017
          IF        !@EQUAL
            MOVE      WATTR017,WMPCAT 
          ENDIF
          MATCH     Z70,WATTR018
          IF        !@EQUAL
            MOVE      WATTR018,WMUDEF1
          ENDIF
          MATCH     Z70,WATTR019
          IF        !@EQUAL
            MOVE      WATTR019,WMUDEF2
          ENDIF
          MATCH     Z70,WATTR020
          IF        !@EQUAL
            MOVE      WATTR020,WMUDEF3
          ENDIF
          MATCH     Z70,WATTR021
          IF        !@EQUAL
            MOVE      WATTR021,WMUDEF4
          ENDIF
          MATCH     Z70,WATTR022
          IF        !@EQUAL
            MATCH     SP70,WATTR022
            IF        !@EQUAL
              UNPACK    WATTR022,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      WTWMREAD,CCENT,CYEAR,CMON,CDAY
              REP       " 0",WTWMREAD
            ELSE
              MOVE      SP70,WTWMREAD
            ENDIF
          ENDIF
          MATCH     Z70,WATTR023
          IF        !@EQUAL
            MATCH     SP70,WATTR023
            IF        !@EQUAL
              UNPACK    WATTR023,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      WTWMDEDA,CCENT,CYEAR,CMON,CDAY
              REP       " 0",WTWMDEDA
            ELSE
              MOVE      SP70,WTWMDEDA
            ENDIF
          ENDIF
          MATCH     Z70,WATTR024
          IF        !@EQUAL
            MOVE      WATTR024,WTWMCLSS
          ENDIF
          MATCH     Z70,WATTR025
          IF        !@EQUAL
            MATCH     SP70,WATTR025
            IF        !@EQUAL
              UNPACK    WATTR025,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      WTWMDTAD,CCENT,CYEAR,CMON,CDAY
              REP       " 0",WTWMDTAD
            ELSE
              MOVE      SP70,WTWMDTAD
            ENDIF
          ENDIF
          MATCH     Z70,WATTR026
          IF        !@EQUAL
            MOVE      WATTR026,WTWMACAT
          ENDIF
          MATCH     Z70,WATTR027
          IF        !@EQUAL
            MATCH     SP70,WATTR027
            IF        !@EQUAL
              UNPACK    WATTR027,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      WTWMGADD,CCENT,CYEAR,CMON,CDAY
              REP       " 0",WTWMGADD
            ELSE
              MOVE      SP70,WTWMGADD
            ENDIF
          ENDIF
          MATCH     Z70,WATTR028
          IF        !@EQUAL
            MATCH     SP70,WATTR028
            IF        !@EQUAL
              UNPACK    WATTR028,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      WTWMDABD,CCENT,CYEAR,CMON,CDAY
              REP       " 0",WTWMDABD
            ELSE
              MOVE      SP70,WTWMDABD
            ENDIF
          ENDIF
          MATCH     Z70,WATTR029
          IF        !@EQUAL
            MOVE      WATTR029,WTWMEATY
          ENDIF
          MATCH     Z70,WATTR030
          IF        !@EQUAL
            MOVE      WATTR030,WTWMADMC
          ENDIF
          MATCH     Z70,WATTR031
          IF        !@EQUAL
            MOVE      WATTR031,WTWMECRA
          ENDIF
          MATCH     Z70,WATTR032
          IF        !@EQUAL
            MOVE      WATTR032,WTWMGPFA
          ENDIF
          MATCH     Z70,WATTR033
          IF        !@EQUAL
            MOVE      WATTR033,WTWMRFGP
          ENDIF
          MATCH     Z70,WATTR034
          IF        !@EQUAL
            MOVE      WATTR034,WTWMGPPC
          ENDIF
          MATCH     Z70,WATTR035
          IF        !@EQUAL
            MOVE      WATTR035,WTWMGPPT
          ENDIF
          MATCH     Z70,WATTR036
          IF        !@EQUAL
            MOVE      WATTR036,WTWMDOFR
          ENDIF
          MATCH     Z70,WATTR037
          IF        !@EQUAL
            MOVE      WATTR037,WTWMOPER
          ENDIF
          MATCH     Z70,WATTR038
          IF        !@EQUAL
            MOVE      WATTR038,WTWMIHSP
          ENDIF
          MATCH     Z70,WATTR039
          IF        !@EQUAL
            MOVE      WATTR039,WTWMVLSF
          ENDIF
          MATCH     Z70,WATTR040
          IF        !@EQUAL
            MOVE      WATTR040,WTWMPRO2
          ENDIF
          MATCH     Z70,WATTR041
          IF        !@EQUAL
            MOVE      WATTR041,WTWMPRO3
          ENDIF
          MATCH     Z70,WATTR042
          IF        !@EQUAL
            MATCH     SP70,WATTR042
            IF        !@EQUAL
              UNPACK    WATTR042,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      WTWMTRPA,CCENT,CYEAR,CMON,CDAY
              REP       " 0",WTWMTRPA
            ELSE
              MOVE      SP70,WTWMTRPA
            ENDIF
          ENDIF
          MATCH     Z70,WATTR043
          IF        !@EQUAL
            MOVE      WATTR043,WMUDEF5
          ENDIF
          MATCH     Z70,WATTR044
          IF        !@EQUAL
            MOVE      WATTR044,WMUDEF6
          ENDIF
          MATCH     Z70,WATTR045
          IF        !@EQUAL
            MOVE      WATTR045,WMUDEF7
          ENDIF
          MATCH     Z70,WATTR046
          IF        !@EQUAL
            MOVE      WATTR046,WMUDEF8
          ENDIF
          MATCH     Z70,WATTR047
          IF        !@EQUAL
            MOVE      ZERO,FORM6
            SQUEEZE   WATTR047
            MOVE      WATTR047,FORM6
            MOVE      FORM6,WTWMRANK
          ENDIF
          MATCH     Z70,WATTR048
          IF        !@EQUAL
            MOVE      WATTR048,WTWMSRCR
          ENDIF
.
          MATCH     Z70,WATTR049
          IF        !@EQUAL
            SQUEEZE   WATTR049
            MOVE      WATTR049,WMBOOK
          ENDIF
.
          MATCH     Z70,WATTR050
          IF        !@EQUAL
            READ      CONTROLF,THIRTY7;*236,WTCNBRSR
            STORE     WATTR050,WTCNBRSR,WMUDEF1,WMUDEF2,WMUDEF3,WMUDEF4,WMUDEF5:
                                     WMUDEF6,WMUDEF7,WMUDEF8
            COMPARE   ZERO,WTCNBRSR
            IF        @EQUAL
              PACK      WTWMSRCR,WATTR050,SP70
            ENDIF
          ENDIF
.
          MATCH     Z70,WATTR051
          IF        !@EQUAL
            MATCH     SP70,WATTR051
            IF        !@EQUAL
              UNPACK    WATTR051,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      WTWMDRSA,CCENT,CYEAR,CMON,CDAY
              REP       " 0",WTWMDRSA
            ELSE
              MOVE      SP70,WTWMDRSA
            ENDIF
          ENDIF
.
          MATCH     Z70,WATTR052
          IF        !@EQUAL
            MATCH     SP70,WATTR052
            IF        !@EQUAL
              UNPACK    WATTR052,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      WTWMDOSA,CCENT,CYEAR,CMON,CDAY 
              REP       " 0",WTWMDOSA 
            ELSE
              MOVE      SP70,WTWMDOSA
            ENDIF
          ENDIF
.
          MATCH     Z70,WATTR053
          IF        !@EQUAL
            MOVE      WATTR053,WTWMPHSP
          ENDIF
.
          MATCH     Z70,WATTR054
          IF        !@EQUAL
            MATCH     SP70,WATTR054
            IF        @EQUAL
              MOVE      " ",WTWMCSST
            ELSE
              MOVE      "N",WTWMCSST
              CMATCH    "Y",WATTR054
              IF        @EQUAL
                MOVE      "Y",WTWMCSST        * Consent Obtained? (N=NO,Y=YES)
              ENDIF
              CMATCH    "1",WATTR054
              IF        @EQUAL
                MOVE      "Y",WTWMCSST        * Consent Obtained? (N=NO,Y=YES)
              ENDIF
            ENDIF
          ENDIF
. 
          MATCH     Z70,WATTR055
          IF        !@EQUAL
            MATCH     SP70,WATTR055
            IF        !@EQUAL
              UNPACK    WATTR055,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      WTWMCSDT,CCENT,CYEAR,CMON,CDAY
              REP       " 0",WTWMCSDT
            ELSE
              MOVE      SP70,WTWMCSDT
            ENDIF
          ENDIF
.
          MATCH     Z70,WATTR056
          IF        !@EQUAL
            MOVE      WATTR056,WTWMASSR
          ENDIF
.
          MATCH     Z70,WATTR057
          IF        !@EQUAL
            MOVE      WATTR057,WTWMACPR
          ENDIF
.
          MATCH     Z70,WATTR058
          IF        !@EQUAL
            MOVE      WATTR058,WTWMPDSC
          ENDIF
.
MVWDET80  MATCH     Z70,WATTR059
          IF        !@EQUAL
            MATCH     SP70,WATTR059
            IF        !@EQUAL
              UNPACK    WATTR059,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      WTWMRADT,CCENT,CYEAR,CMON,CDAY
              REP       " 0",WTWMRADT
            ELSE
              MOVE      SP70,WTWMRADT
            ENDIF
          ENDIF
.
          MATCH     Z70,WATTR060
          IF        !@EQUAL
            MOVE      WATTR060,WMDESC2
          ENDIF
.
          MATCH     Z70,WATTR061
          IF        !@EQUAL
            MOVE      WATTR061,WMDESC3
          ENDIF
.
MVWDET99  RETURN
.------------------------------------------------------------
. Write Audit Record
.------------------------------------------------------------
AUDWMTRE  READ      CONTROLF,THIRTY7;*43,HWAUDA,HWAUDB
          BRANCH    HWAUDB,WMTRE999
          OPEN      WATAUTR1,"watautr1"
.
          COMPARE   FIVE,AUDIFLAG      * test to delete B audit
          GOTO      WMTRE600 IF EQUAL
.
          COMPARE   THREE,AUDIFLAG     * is it an after change audit ??
          GOTO      WMTRE100 IF EQUAL  * yes so dont change time
.
          CALL      IBACLOCK           * get current date
          PACK      WTWMAUDD,CCC,CYY,CMM,CDD
          REP       " 0",WTWMAUDD
          CLOCK     TIME,WTWMAUDT      * clock current time
.
WMTRE100  MOVE      ONE,WTWMAUDS       * set print status
          MOVE      PASSCODE,WTWMAUDO  * get user ID
          MOVE      PORT,WTWMAUDP      * get port number
          BRANCH    AUDIFLAG,WMTRE200,WMTRE200,WMTRE200,WMTRE200,WMTRE600
          GOTO      WMTRE999
.
WMTRE200  MOVE      AUDIFLAG,WTWMAUDR
          REPLACE   "1A2B3C4D",WTWMAUDR
          PACK      KEY19,WTWMAUDD,WTWMAUDT,WTWMAUDP,WTWMAUDR
          CALL      AWTREA1            * write to audit file
          GOTO      WMTRE999
WMTRE600                               * Delete B audit
          PACK      KEY19,WTWMAUDD,WTWMAUDT,WTWMAUDP,ANSB
          CALL      ADTREA1            * delete audit file
.
WMTRE999  RETURN
.----------------------------------------------------------------------
. Output Table of Waiting List Patients by Doctor
.----------------------------------------------------------------------
UNTTAB00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          CALL      IBACLOCK
          MOVE      ZERO,RECCOUNT
.
          MATCH     SP70,NEXTUKEY
          IF        !@EQUAL
            PACK      KEY31,NEXTUKEY,SP70
            CALL      RDTREA7
            BRANCH    OVRCD,UNTTAB99          * end of file
            GOTO      UNTTAB15
          ENDIF
.
          PACK      KEY31,STATCODE,UNITCODE,SP30
          CALL      RDSTREA7
UNTTAB10  CALL      RDKTREA7
          BRANCH    OVRCD,UNTTAB99          * end of file
.
UNTTAB15  COMPARE   NINE,WMSTAT             * Skip suspended procedures
          GOTO      UNTTAB10 IF EQUAL
.
          MOVE      STATCODE,F1
          COMPARE   F1,WMSTAT
          GOTO      UNTTAB99 IF NOT EQUAL   * different consultant
.
          PACK      UNITCODE,UNITCODE,SP70
          MATCH     SP70,UNITCODE
          IF        !@EQUAL
            MATCH     UNITCODE,WMUNIT
            GOTO      UNTTAB99 IF NOT EQUAL   * already have a priority
          ENDIF
.
          MOVE      "WU",CATEGORY
          MOVE      WMUNIT,CODE
          CALL      GETCOD00
          MOVE      TDESC,UNITDESC
.
          PACK      KEY19,WMURNO,WMCODE,DWMCNT
          CALL      RDWTTX11
          BRANCH    OVRCD,UNTTAB10
.
          MATCH     SP70,CATECODE           * Check selected category
          IF        !@EQUAL
            MATCH     CATECODE,WMPTY
            GOTO      UNTTAB10 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,LISTCODE           * Check list status
          IF        !@EQUAL
            MATCH     LISTCODE,WTTXPLST
            GOTO      UNTTAB10 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTPAST           * Pre Admission Status
          IF        !@EQUAL
            MATCH     FILTPAST,WTTXPAST
            GOTO      UNTTAB10 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,ADMPOINT           * Check admission point
          IF        !@EQUAL
            MATCH     ADMPOINT,WTTXADMW
            GOTO      UNTTAB10 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,INTDAYCS           * Check intended day case
          IF        !@EQUAL
            MATCH     INTDAYCS,WTTXIDYC
            GOTO      UNTTAB10 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTDOCT           * Check doctor
          IF        !@EQUAL 
            MATCH     FILTDOCT,WMDOCTOR
            GOTO      UNTTAB10 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,INTDHOSP
          IF        @EQUAL
            PACK      INTDHOSP,WBSEHOSP,SP70
          ENDIF
.
          IF        IBCNMHOS = 1
            MATCH     SP70,WTWMIHSP
            IF        !@EQUAL
              MATCH     WTWMIHSP,INTDHOSP
              GOTO      UNTTAB10 IF NOT EQUAL
            ENDIF
          ENDIF
.
          MATCH     SP70,AIHWREPT
          GOTO      UNTTAB16 IF EQUAL
.
          PACK      KEY9,WMCODE,SP70
          CALL      RDPROA1
          BRANCH    OVRCD,UNTTAB10
.
          MOVE      ZERO,FORM6
          SQUEEZE   WPRHAT
          MOVE      WPRHAT,FORM6
          RESET     WPRHAT
.
          MATCH     "0",AIHWREPT
          IF        @EQUAL
            COMPARE   ZERO,FORM6
            GOTO      UNTTAB10 IF NOT EQUAL
          ENDIF
.
          MATCH     "1",AIHWREPT
          IF        @EQUAL
            COMPARE   ONE,FORM6
            GOTO      UNTTAB10 IF NOT EQUAL
          ENDIF
.
UNTTAB16  MATCH     "       0",WMURNO
          IF        @EQUAL
            MOVE      WMURNO,KEY8           * visit number
            UNPACK    KEY8,KEY2,KEY6          * r5
            CALL      RDPRAM1
            MOVE      ZERO,PURNO
          ELSE
            PACK      KEY8,WMURNO           * r5
            UNPACK    KEY8,KEY2,KEY6          * r5
            CALL      RDMAST1
            CALL      RDPMPX21
          ENDIF
.
          CALL      GETSEX00
.
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
          CALL      CASLNK00
.
          MOVE      "VL",CATEGORY
          MOVE      WTTXPLST,CODE
          CALL      GETCOD00
          MOVE      TDESC,PRIOSTAT
.
          MOVE      "XG",CATEGORY
          MOVE      WTTXPAST,CODE
          CALL      GETCOD00
          MOVE      TDESC,DIM19
.
          MOVE      ZERO,NRCDAYS
          MOVE      "TP",CATEGORY
          MOVE      WMPTY,CODE
          CALL      GETCOD00
          MOVE      TDESC,PRIODESC
          MOVE      ACODE,PRIOCODE
          CALL      COVER000     * Calculate Overdue Date & List Status
.
          CALL      NEWOVR00         * New overdue calculation
.
          MATCH     "1",OVRDCODE            * Check overdue patients
          IF        @EQUAL
            MATCH     "1",OVERSTAT
            GOTO      UNTTAB10 IF NOT EQUAL
          ENDIF
.
          PACK      GENPNAME,SP70
          PACK      KEY10,WTWMRFGP,SP70
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCGNAM,KEY1
            PACK      GENPNAME,PMHCSNAM,COMMA,KEY1,SP70
            SQUEEZE   GENPNAME
          ENDIF
.
          MOVE      WMDOCTOR,KEY6
          CALL      RDDOCT1
          MOVE      DGNAME,ANS
          MOVE      DTITL,FMTTITLE            * I CAR 13038
          MOVE      DGNAME,FMTGNAME
          MOVE      DSNAME,FMTSNAME
          CALL      DOCNM000                  * end I CAR 13038
.
          CALL      PATLN000           * Format names
.
.         Load date from waiting list status
.
          BRANCH     WMSTAT,UNTTAB20,UNTTAB30,UNTTAB40,UNTTAB40,UNTTAB40:
                     UNTTAB50 
.
UNTTAB20  MOVE      SP70,DSPDATE            * Unscheduled
          MATCH     SP8,WMDATE3
          GOTO      UNTTAB60 IF EQUAL
          MOVE      WMDATE3,DSPDATE
          GOTO      UNTTAB60
.
UNTTAB30  MOVE      WMDATE3,DSPDATE         * Scheduled
          GOTO      UNTTAB60
.
UNTTAB40  MOVE      SP70,DSPDATE
          MOVE      WMBOOK,KEY8             * Pre Admitted/Admitted/Disharged
          CALL      RDMISS1
          BRANCH    OVRCD,UNTTAB60
          MOVE      ADATE,DSPDATE
          GOTO      UNTTAB60 
.
UNTTAB50  MOVE      WMDATE4,DSPDATE        * Removed
          GOTO      UNTTAB60 
.
UNTTAB60  IF        RECCOUNT>=LISTLIMT
            PACK      KEY31,WMSTAT,WMUNIT,WMDATE1,WMURNO,WMCODE,WMCNT,SP70
            WRITE     HTMLFILE;"LimitReached();"
            WRITE     HTMLFILE;"NextRecordSet('",KEY31,"');"
            GOTO      WATTAB99
          ENDIF
.
          ADD       ONE,RECCOUNT
.
          CALL      LSTDAY00
          CALL      NRCDAY00
.
          ASSIGN    (LSTDAYS-NRCDAYS),RFCDAYS
          IF        RFCDAYS < 1
            ASSIGN    ZERO,RFCDAYS
          ENDIF
.
          CALL      DRFCUR00
          IF        CATCHGFL=0
            MOVE      ZERO,URGDAYS
          ELSE
            MOVE      URRFCDAY,URGDAYS
          ENDIF
.
          MOVE      SP70,BKREEDAT
          PACK      KEY8,WMBOOK,SP70
          CALL      RDBKREC1
          IF        OVRCD=1
            MOVE      SP70,BKREEDAT
          ENDIF
          CALL      PATFLD00                *Returns KEY3 for folder colour code
          CALL      CRTDAY00
.
          MOVE      SP70,PRPBDESC
          MOVE      "yh",CATEGORY
          MOVE      WTTXPRPB,CODE
          CALL      GETCOD00
          MOVE      TDESC,PRPBDESC
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",FORMATNM,"#",":          *1
                             "#"",WMURNO,"#",":            *2
                             "#"",DISPSEX,"#",":           *3
                             "#"",PSAGEYRS,"#",":          *4 
                             "#"",WMDATE1,"#",":           *5 
                             "#"",WMDATE2,"#",":           *6 
                             "#"",WMDATE3,"#",":           *7 
                             "#"",WMCODE,"#",";            *8 
.                                            * Display Procedure Description
.                                            * comments only if they exist
          MATCH     SP70,WTWMPDSC
          STRIP     WMDESC
          MOVELPTR  WMDESC,F3
          SFORMAT   DISPVAR1,F3
          MOVE      WMDESC,DISPVAR1
          IF        @EQUAL
            WRITE     HTMLFILE;"#"",DISPVAR1,"#",";        *9
          ELSE
            STRIP     WTWMPDSC
          STRIP     WMDESC
            MOVELPTR  WTWMPDSC,F3
            SFORMAT   DISPVAR2,F3
            MOVE      WTWMPDSC,DISPVAR2
            WRITE     HTMLFILE;"#"",DISPVAR1,"<br />",DISPVAR2,"#",";  *9
          ENDIF
          SFORMAT   DISPVAR1,127
          SFORMAT   DISPVAR2,127
.
          WRITE     HTMLFILE;"#"",WMREASON,"#",":          *10
                             "#"",WTWMRANK,"#",":          *11
                             "#"",WMSTAY,"#",":            *12
                             "#"",WMDOCTOR,"#",":          *13
                             "#"",DOCFNAME,"#",":          *14    * C CAR 13038
                             "#"",PRIODESC,"#",":          *15
                             "#"",OVERDATE,"#",":          *16
                             "#"",OVERSTAT,"#",":          *17
                             "#"",WTTXPLST,"#",":          *18
                             "#"",GENPNAME,"#",":          *19
                             "#"",LSTDAYS,"#",":           *20
                             "#"",NRCDAYS,"#",":           *21
                             "#"",URGDAYS,"#",":           *22
                             "#"",DSPDATE,"#",":           *23
                             "#"",DIM19,"#",":             *24
                             "#"",PRIOCODE,"#",":          *25
                             "#"",KEY3,"#",":              *26
                             "#"",WTWMECNT,"#",":          *27
                             "#"",WTWMDTAD,"#",":          *28
                             "#"",CRTDAYS,"#",":           *29
                             "#"",UNITDESC,"#",":          *30
                             "#"",BKREEDAT,"#",":          *31
                             "#"",RFCDAYS,"#",":           *32
                             "#"",PRPBDESC,"#",":          *33
                             "#"",PRIOSTAT,"#",":          *34
                             "#"",WTWMDABD,"#");"          *35
.
          GOTO     UNTTAB10
.
UNTTAB99  RETURN
.
.------------------------------------------------------------
. Select Doctor Based on Supervision Level Code
.------------------------------------------------------------
DOCSEL00  MATCH     SP70,DOCTTYPE
          GOTO      DOCSEL99 IF EQUAL
          PACK      KEY29,DOCTTYPE,SP70
          CALL      RDSDOCT3
DOCSEL10  CALL      RDKDOCT3
          BRANCH    OVRCD,DOCSEL99
          MATCH     DOCTTYPE,DALEVEL
          GOTO      DOCSEL99 IF NOT EQUAL
          MOVE      DGNAME,ANS
          MATCH     DOCTCODE,DCODE
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",DCODE," selected>":
                               DSNAME,COMMA,ANS,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",DCODE,">":
                               DSNAME,COMMA,ANS,"</option>"
          ENDIF
          GOTO       DOCSEL10
.
DOCSEL99 RETURN
.
.------------------------------------------------------------
. Waiting Case List by Date 
.------------------------------------------------------------
WATDAT00  CALL      CURPER00   * Determine Current Period
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.
          MATCH     ANSC,UPDTTYPE
          IF        @EQUAL
            CALL      CONREC00        * Confirm bookings
          ENDIF
.
.          MOVE      DOCTCODE,KEY6
.          CALL      RDDOCT1
.          IF        OVRCD=1
.            MOVE      WBSEDOC,DOCTCODE
.            MOVE      DOCTCODE,KEY6
.            CALL      RDDOCT1
.          ENDIF
.
          MOVE      "Waiting List",WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,WATDAT99
.
          CALL      WEBBOD00
.
          CALL      WEBEND00
          GOTO      WATDAT99
.
WATDAT99  RETURN
.------------------------------------------------------------
. List by Date Range
.------------------------------------------------------------
WATD0000  BRANCH    FLDITMNO,WATD0100,WATD0200,WATD0300,WATD0400:
                             WATD0500,WATD0600,WATD0700,WATD0800:
                             WATD0900,WATD1000,WATD1100,WATD1200:
                             WATD1300,WATD1400,WATD1500,WATD1600:
                             WATD1700,WATD1800,WATD1900,WATD2000:
                             WATD2100,WATD2200,WATD2300,WATD2400:
                             WATD2500,WATD2600,WATD2700,WATD2800
.
WATD0100  CALL      NEXT0000
          GOTO      WATD9999
.
WATD0200  CALL      PREV0000
          GOTO      WATD9999
.
WATD0300  CALL      CURSTD00
          GOTO      WATD9999
.
WATD0400  CALL      CUREND00
          GOTO      WATD9999
.
WATD0500  CALL      CURYR000
          GOTO      WATD9999
.
WATD0600  CALL      CURMON00
          GOTO      WATD9999
.
WATD0700  CALL      SELV0000
          GOTO      WATD9999
.
WATD0800  WRITE     HTMLFILE;TEMPLATE;
          GOTO      WATD9999
.
WATD0900  WRITE     HTMLFILE;REPORTNO;
          GOTO      WATD9999
.
WATD1000  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      WATD9999
.
WATD1100  MOVE      ZERO,LINKTYPE    * Link to Case Key Based Screen
          CALL      DATTAB00
          GOTO      WATD9999
.
WATD1200  MOVE      ONE,LINKTYPE    * Link to U/R Based Screen
          CALL      DATTAB00
          GOTO      WATD9999
.
WATD1300  MOVE      "WU",CATEGORY
          MOVE      UNITCODE,CODE
          CALL      CODSEL00        * Waiting List by Unit
          GOTO      WATD9999
.
WATD1400  CALL      STALST00
          GOTO      WATD9999
.
WATD1500  MOVE      "DL",CATEGORY
          MOVE      DOCTTYPE,CODE
          CALL      CODSEL00        * Doctor Type
          GOTO      WATD9999
.
WATD1600  CALL      DOCSEL00        * Select List of Doctors List by Doctor Type
          GOTO      WATD9999
.
WATD1700  MOVE      "TP",CATEGORY
          MOVE      CATECODE,CODE
          CALL      CODSEL00        * Category selection
          GOTO      WATD9999
.
WATD1800  MOVE      "VL",CATEGORY
          MOVE      LISTCODE,CODE
          CALL      CODSEL00        * Listing status selection
          GOTO      WATD9999
.
WATD1900  CALL      DOCDET00
          GOTO      WATD9999
.
WATD2000  CALL      BOKTAA00        * Scheduled Bookings List
          GOTO      WATD9999
.
WATD2100  CALL      BOKTAB00        * Unscheduled Bookings List
          GOTO      WATD9999
.
WATD2200  IF        FLTRDATE=1
            WRITE     HTMLFILE;"checked";
          ENDIF
          GOTO      WATD9999
.
WATD2300  MOVE      "WS",CATEGORY
          MOVE      FLTSHORT,CODE
          CALL      CODSEL00        * Category selection
          GOTO      WATD9999
.
WATD2400  MOVE      ONE,WAHVIEW     
          CALL      BOKTAA00        * WA Health Scheduled Bookings List
          GOTO      WATD9999
.
WATD2500  MOVE      ONE,WAHVIEW     
          CALL      BOKTAB00        * Unscheduled Bookings List
          GOTO      WATD9999
.
WATD2600  MOVE      "WR",CATEGORY
          MOVE      REMSTATS,CODE
          CALL      CODSEL00
          GOTO      WATD9999
.
WATD2700  CALL      SNALST00        * List of status fo Short Notice view
          GOTO      WATD9999
.
WATD2800  MOVE      "TP",CATEGORY
          MOVE      CATECODE,CODE
          CALL      CODSEL00        * Category selection
          GOTO      WATD9999
.
WATD9999  RETURN
.------------------------------------------------------------
. Output Scheduled Bookings List by Date Range
.------------------------------------------------------------
BOKTAA00  PACK      KEY16,FRSTDATE,SP70
          CALL      RSBKREC4
BOKTAA10  CALL      RKBKREC4
          BRANCH    OVRCD,BOKTAA99
          MATCH     BKREEDAT,LASTDATE
          GOTO      BOKTAA99 IF LESS
          COMPARE   "2",BKRESTAT
          GOTO      BOKTAA10 IF EQUAL
.
          PACK      KEY19,BKREURNO,BKREPROC,BKRECNT,SP70
          CALL      RDTREA1 
          BRANCH    OVRCD,BOKTAA10
.
          IF        WAHVIEW=1
            IF        WMSTAT<>2
              GOTO      BOKTAA10
            ENDIF
            MATCH     SP70,WTWMIHSP
            IF        !@EQUAL
              MATCH     WTWMIHSP,WBSEHOSP
              GOTO      BOKTAA10 IF NOT EQUAL
            ENDIF
          ENDIF
          PACK      KEY8,BKREBOOK,SP70
          CALL      RDBKRX11                * Read booking extn file
          IF        OVRCD = 1
            CALL      CLBKRX00
          ENDIF
.
          PACK      KEY19,BKREURNO,BKREPROC,BKRECNT,SP70
          CALL      RDWTTX11
          IF        OVRCD=1
            CALL      CLWATTX1
          ENDIF
.
          CALL      BOKFLA00
          BRANCH    EXIT,BOKTAA10
.
          CALL      GETCON00               * get confirmation date
          CALL      BOKROW00
.          
          GOTO      BOKTAA10

BOKTAA99  RETURN
.------------------------------------------------------------
. Get confirmation date
.------------------------------------------------------------
GETCON00  COMPARE   ONE,CTHETR  
          GOTO      GETCON99 IF NOT EQUAL   * not using theatre
.
          MATCH     SP70,BKRXCNDT           * already found confirmation date
          GOTO      GETCON99 IF NOT EQUAL
.
          PACK      KEY31,BKREBOOK,SP70
          CALL      RSOPDEA2 
          CALL      RKOPDEA2
          BRANCH    OVRCD,GETCON99          * not a theatre booking
.         
          MOVE      OPDAADMN,DIM8          * get as a form
          MATCH     DIM8,BKREBOOK
          GOTO      GETCON99 IF NOT EQUAL   * not a theatre booking
.
          MOVE      OPDADATE,BKRXCNDT
.
GETCON99  RETURN
.------------------------------------------------------------
. Output Row Details
.------------------------------------------------------------
BOKROW00  MATCH     "       0",WMURNO
          IF        @EQUAL
            MOVE      WMURNO,KEY8           * visit number
            UNPACK    KEY8,KEY2,KEY6          * r5
            CALL      RDPRAM1
            MOVE      ZERO,PURNO
          ELSE
            PACK      KEY8,WMURNO           * r5
            UNPACK    KEY8,KEY2,KEY6          * r5
            CALL      RDMAST1
            CALL      RDPMPX21
          ENDIF
.
          CALL      GETSEX00
.
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
          MOVE      "S ",CATEGORY
          MOVE      WTWMSRCR,CODE
          CALL      GETCOD00
          MOVE      TDESC,SRCRDESC
.
          MOVE      "WU",CATEGORY
          MOVE      WMUNIT,CODE
          CALL      GETCOD00
          MOVE      TDESC,UNITDESC
          MOVE      ACODE,UNITCOD1
.
          MOVE      "VL",CATEGORY
          MOVE      WTTXPLST,CODE
          CALL      GETCOD00
          MOVE      TDESC,PRIOSTAT
.
          MOVE      "TP",CATEGORY
          MOVE      WMPTY,CODE
          CALL      GETCOD00
          MOVE      TDESC,PRIODESC
.
          PACK      GENPNAME,SP70
          PACK      KEY10,WTWMRFGP,SP70
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCGNAM,KEY1
            PACK      GENPNAME,PMHCSNAM,COMMA,KEY1,SP70
            SQUEEZE   GENPNAME
          ENDIF
.
          MOVE      WMDOCTOR,KEY6
          CALL      RDDOCT1
          MOVE      DGNAME,ANS
          MOVE      DTITL,FMTTITLE            * I CAR 13038
          MOVE      DGNAME,FMTGNAME
          MOVE      DSNAME,FMTSNAME
          CALL      DOCNM000                  * end I CAR 13038
.
          CALL      PATLN000           * Format names
          CALL      PATFLD00           * Patient Folder Details
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          ADD       ONE,RECCNT
          MOVE      RECCNT,DRECCNT
          REP       " 0",DRECCNT
.
          CLEAR     HTMLLINK
          APPEND    "javascript:LinkTo('",HTMLLINK
          APPEND    WMURNO,HTMLLINK
          APPEND    WMCODE,HTMLLINK
          APPEND    WMCNT,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
          PACK      CASEKEYS,WMURNO,WMCODE,WMCNT,SP70
.
          CLEAR     HTMLLINK
          APPEND    "javascript:LinkTo('",HTMLLINK
          APPEND    WMURNO,HTMLLINK
          APPEND    WMCODE,HTMLLINK
          APPEND    WMCNT,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    BKRXBNUM,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
          PACK      CASEKEYS,WMURNO,WMCODE,WMCNT,SP70
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",FORMATNM,"#",":             *1
                             "#"",WMURNO,"#",":               *2
                             "#"",DISPSEX,"#",":              *3
                             "#"",PSAGEYRS,"#",":             *4
                             "#"",WMDATE1,"#",":              *5
                             "#"",WMDATE2,"#",":              *6
                             "#"",WMDATE3,"#",":              *7
                             "#"",WMCODE,"#",";               *8
.                                            * Display Procedure Description
.                                            * comments only if they exist
          MATCH     SP70,WTWMPDSC
          STRIP     WMDESC
          MOVELPTR  WMDESC,F3
          SFORMAT   DISPVAR1,F3
          MOVE      WMDESC,DISPVAR1
          IF        @EQUAL
            WRITE     HTMLFILE;"#"",DISPVAR1,"#",";          *9
          ELSE
            STRIP     WTWMPDSC
          STRIP     WMDESC
            MOVELPTR  WTWMPDSC,F3
            SFORMAT   DISPVAR2,F3
            MOVE      WTWMPDSC,DISPVAR2
            WRITE     HTMLFILE;"#"",DISPVAR1,"<br />",DISPVAR2,"#",";  *9
          ENDIF
          SFORMAT   DISPVAR1,127
          SFORMAT   DISPVAR2,127
.
          WRITE     HTMLFILE;"#"",WMREASON,"#",":             *10
                             "#"",WTWMRANK,"#",":             *11
                             "#"",WMSTAY,"#",":               *12
                             "#"",WMDOCTOR,"#",":             *13
                             "#"",DOCFNAME,"#",":             *14 * I CAR 13038
                             "#"",WMPTY,"#",":                *15
                             "#"",PRIOOVER,"#",":             *16
                             "#"",OVERSTAT,"#",":             *17
                             "#"",WTTXPLST,"#",":             *18
                             "#"",SRCRDESC,"#",":             *19
                             "#"",UNITDESC,"#",":             *20
                             "#"",GENPNAME,"#",":             *21
                             "#"",PTELEP,"#",":               *22
                             "#"",PTELEB,"#",":               *23
                             "#"",PMPXMPNO,"#",":             *24
                             "#"",PMPXMBNO,"#",":             *25
                             "#"",PMPXMMNO,"#",":             *26
                             "#"",WTTXADMW,"#",":             *27
                             "#"",BKREEDAT,"#",":             *28
                             "#"",BKREBKDT,"#",":             *29
                             "#"",BKRXCNDT,"#",":             *30
                             "#"",PMPXFPNO,"#",":             *31
                             "#"",PMPXFBNO,"#",":             *32
                             "#"",PMPXFMNO,"#",":             *33
                             "#"",PMPXMREL,"#",":             *34
                             "#"",KEY3,"#",":                 *35
                             "#"",UNITCOD1,"#",":             *36
                             "#"",PNKTELP,"#",":              *37
                             "#"",PNKTELB,"#",":              *38
                             "#"",PTMXECPP,"#",":             *39
                             "#"",PTMXECBP,"#",":             *40
                             "#"",PRIODESC,"#",";             *41
          MATCH     SP70,BKRXCNDT
          IF        @EQUAL 
            WRITE    HTMLFILE;"#"<input type=checkbox name=confarry",DRECCNT:
                     " value='",BKRXBNUM,"' onClick=RemoveTable(this.value); >":
                     "#",";
          ELSE
            WRITE     HTMLFILE;"#"",SP1,"#",";
          ENDIF
.
          WRITE     HTMLFILE;"#"",PTMXCELL,"#",";             *43
          MOVE      "1",CONTTYPE 
          CALL      XCON0000
          MOVE      PMCESNAM,PACSNAME
          MOVE      PMCEGNAM,PACGNAME
          MOVE      PMCETITL,PACTITLE
          MOVE      "1",PACFRMT
          CALL      PACNAME
          WRITE     HTMLFILE;"#"",PACFNAME,"#",":             *44
                             "#"",PMCETELP,"#",":             *45
                             "#"",PMCETELB,"#",":             *46
                             "#"",PMCETELM,"#");";            *47
          RETURN
.------------------------------------------------------------
. Output Scheduled Bookings List Filter
.------------------------------------------------------------
BOKFLA00  IF        FLTRDATE=0
            MATCH     SP70,BKRXCNDT
            IF        !@EQUAL
              DAYSEP    BKRXCNDT,BKREEDAT,CALDAYS
              IF        CALDAYS < 7
                GOTO      BOKFLA90
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     SP70,DOCTCODE
          IF        !@EQUAL
            MATCH     WMDOCTOR,DOCTCODE
            GOTO      BOKFLA90 IF NOT EQUAL
          ENDIF
          MATCH     SP70,UNITCODE
          IF        !@EQUAL|@EOS
            MATCH     UNITCODE,WMUNIT
            GOTO      BOKFLA90 IF NOT EQUAL 
          ENDIF
          MOVE      ZERO,EXIT
          GOTO      BOKFLA99
.
BOKFLA90  MOVE      ONE,EXIT
          GOTO      BOKFLA99
.
BOKFLA99  RETURN
.------------------------------------------------------------
. Output Unscheduled Bookings 
.------------------------------------------------------------
BOKTAB00  MATCH     SP70,UNITCODE
          GOTO      BOKTAB99 IF EQUAL
.
          MOVE      ONE,SAVSCODE
          MOVE      ZERO,SHRTNFLG
          PACK      STATCODE,STATCODE,SP70
.
          UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,SHRTNFLG         * Flag for Short Notice
          IF        SHRTNFLG=1
            MATCH     SP70,STATCODE
            IF        !@EQUAL
              PACK      KEY31,STATCODE,UNITCODE,SP30
              GOTO      BOKTAB08
            ENDIF
          ENDIF
.
          PACK      KEY31,ONE,UNITCODE,SP30 * default to Unscheduled
BOKTAB08  CALL      RDSTREA7
BOKTAB10  CALL      RDKTREA7
          BRANCH    OVRCD,BOKTAB99          * end of file
.
          BRANCH    SHRTNFLG,BOKTAB12       * Short Notice flag
.
          COMPARE   ONE,WMSTAT
          GOTO      BOKTAB99 IF NOT EQUAL   * Check Status
          MATCH     WMUNIT,UNITCODE
          GOTO      BOKTAB99 IF NOT EQUAL
.
          MATCH     SP70,WMNOTICE
          GOTO      BOKTAB10 IF EQUAL   * Check Status
.
          IF        WAHVIEW=1
            MATCH     SP70,WTWMIHSP
            IF        !@EQUAL
              MATCH     WTWMIHSP,WBSEHOSP
              GOTO      BOKTAB10 IF NOT EQUAL
            ENDIF
          ENDIF
          GOTO      BOKTAB20
.
.         W/L Short Notice
.
BOKTAB12  MOVE      STATCODE,F1
          MATCH     SP70,STATCODE
          IF        @EQUAL
            MOVE      SAVSCODE,F1
          ENDIF
.
          COMPARE   F1,WMSTAT
          GOTO      BOKTAB18 IF NOT EQUAL
          MATCH     WMUNIT,UNITCODE
          GOTO      BOKTAB20 IF EQUAL
.
BOKTAB18  MATCH     SP70,STATCODE
          GOTO      BOKTAB99 IF NOT EQUAL
.
          ADD       ONE,SAVSCODE                   * next status
          COMPARE   SEVEN,SAVSCODE
          GOTO      BOKTAB99 IF NOT LESS
.
          PACK      KEY31,SAVSCODE,UNITCODE,SP30   * get next Status
          GOTO      BOKTAB08
.
BOKTAB20  PACK      KEY19,WMURNO,WMCODE,DWMCNT
          CALL      RDWTTX11
          BRANCH    OVRCD,BOKTAB10
.
          CALL      BOKFLB00                   * Filter Unit/Doctor/Short Notice
          BRANCH    EXIT,BOKTAB10
.
          CALL      BOKRWB00
.
          MOVE      STATCODE,SAVSCODE
          GOTO      BOKTAB10
.
BOKTAB99  RETURN
.------------------------------------------------------------
. Output Row Details
.------------------------------------------------------------
BOKRWB00  MATCH     "       0",WMURNO
          IF        @EQUAL
            MOVE      WMURNO,KEY8           * visit number
            UNPACK    KEY8,KEY2,KEY6          * r5
            CALL      RDPRAM1
            MOVE      ZERO,PURNO
          ELSE
            PACK      KEY8,WMURNO           * r5
            UNPACK    KEY8,KEY2,KEY6          * r5
            CALL      RDMAST1
            CALL      RDPMPX21
          ENDIF
.
          CALL      GETSEX00
.
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
          MOVE      "S ",CATEGORY
          MOVE      WTWMSRCR,CODE
          CALL      GETCOD00
          MOVE      TDESC,SRCRDESC
.
          MOVE      "WU",CATEGORY
          MOVE      WMUNIT,CODE
          CALL      GETCOD00
          MOVE      TDESC,UNITDESC
          MOVE      ACODE,UNITCODE
.
          MOVE      "VL",CATEGORY
          MOVE      WTTXPLST,CODE
          CALL      GETCOD00
          MOVE      TDESC,PRIOSTAT
.
          MOVE      "TP",CATEGORY
          MOVE      WMPTY,CODE
          CALL      GETCOD00
          MOVE      TDESC,PRIODESC
.
          MOVE      "WS",CATEGORY
          MOVE      WMNOTICE,CODE
          CALL      GETCOD00
          MOVE      TDESC,NOTCDESC
.
          PACK      GENPNAME,SP70
          PACK      KEY10,WTWMRFGP,SP70
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCGNAM,KEY1
            PACK      GENPNAME,PMHCSNAM,COMMA,KEY1,SP70
            SQUEEZE   GENPNAME
          ENDIF
.
          MOVE      WMDOCTOR,KEY6
          CALL      RDDOCT1
          MOVE      DGNAME,ANS
          MOVE      DTITL,FMTTITLE            * I CAR 13038
          MOVE      DGNAME,FMTGNAME
          MOVE      DSNAME,FMTSNAME
          CALL      DOCNM000                  * end I CAR 13038
.
          CALL      PATLN000           * Format names
          CALL      PATFLD00           * Patient Folder Details
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          CALL      LSTDAY00
          CALL      NRCDAY00
.
          ASSIGN    (LSTDAYS-NRCDAYS),RFCDAYS
          IF        RFCDAYS < 1
            ASSIGN    ZERO,RFCDAYS
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:LinkTo('",HTMLLINK
          APPEND    WMURNO,HTMLLINK
          APPEND    WMCODE,HTMLLINK
          APPEND    WMCNT,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",FORMATNM,"#",":
                             "#"",WMURNO,"#",":
                             "#"",DISPSEX,"#",":
                             "#"",PSAGEYRS,"#",":
                             "#"",WMDATE1,"#",":
                             "#"",WMDATE2,"#",":
                             "#"",WMDATE3,"#",":
                             "#"",WMCODE,"#",";
.                                            * Display Procedure Description
.                                            * comments only if they exist
          MATCH     SP70,WTWMPDSC
          STRIP     WMDESC
          MOVELPTR  WMDESC,F3
          SFORMAT   DISPVAR1,F3
          MOVE      WMDESC,DISPVAR1
          IF        @EQUAL
            WRITE     HTMLFILE;"#"",DISPVAR1,"#",";
          ELSE
            STRIP     WTWMPDSC
          STRIP     WMDESC
            MOVELPTR  WTWMPDSC,F3
            SFORMAT   DISPVAR2,F3
            MOVE      WTWMPDSC,DISPVAR2
            WRITE     HTMLFILE;"#"",DISPVAR1,"<br />",DISPVAR2,"#",";
          ENDIF
          SFORMAT   DISPVAR1,127
          SFORMAT   DISPVAR2,127
.
          WRITE     HTMLFILE;"#"",WMREASON,"#",":
                             "#"",WTWMRANK,"#",":
                             "#"",WMSTAY,"#",":
                             "#"",WMDOCTOR,"#",":
                             "#"",DOCFNAME,"#",":             *14 * C CAR 13038
                             "#"",WMPTY,"#",":
                             "#"",PRIOOVER,"#",":
                             "#"",OVERSTAT,"#",":
                             "#"",WTTXPLST,"#",":
                             "#"",SRCRDESC,"#",":
                             "#"",UNITDESC,"#",":
                             "#"",GENPNAME,"#",":
                             "#"",PTELEP,"#",":               *22
                             "#"",PTELEB,"#",":               *23
                             "#"",PMPXMPNO,"#",":             *24
                             "#"",PMPXMBNO,"#",":             *25
                             "#"",PMPXMMNO,"#",":             *26
                             "#"",WTTXADMW,"#",":             *27
                             "#"",PSUBRB,"#",":               *28
                             "#"",WMNOTICE,"#",":             *29
                             "#"",NOTCDESC,"#",":             *30
                             "#"",PMPXFPNO,"#",":             *31
                             "#"",PMPXFBNO,"#",":             *32
                             "#"",PMPXFMNO,"#",":             *33
                             "#"",PCEASE,PCASE:
                                  PTMXSIN1,PTMXSIN2,PTMXSIN3,PTMXSIN4:
                                  PTMXSIN5,"#",":             *34
                             "#"",KEY3,"#",":                 *35
                             "#"",UNITCODE,"#",":             *36
                             "#"",PNKTELP,"#",":              *37
                             "#"",PNKTELB,"#",":              *38
                             "#"",PTMXECPP,"#",":             *39
                             "#"",PTMXECBP,"#",":             *40
                             "#"",PRIODESC,"#",":             *41
                             "#"",RFCDAYS,"#",":              *42
                             "#"#",";                         *43
.
          WRITE     HTMLFILE;"#"",PTMXCELL,"#",";             *44
          MOVE      "1",CONTTYPE
          CALL      XCON0000
          MOVE      PMCESNAM,PACSNAME
          MOVE      PMCEGNAM,PACGNAME
          MOVE      PMCETITL,PACTITLE
          MOVE      "1",PACFRMT
          CALL      PACNAME
          WRITE     HTMLFILE;"#"",PACFNAME,"#",":             *45
                             "#"",PMCETELP,"#",":             *46
                             "#"",PMCETELB,"#",":             *47
                             "#"",PMCETELM,"#",":             *48
                             "#"",WTWMDABD,"#",":             *49
                             "#"",WTWMREAD,WTTXPTIM,"#",";    *50
.
          MOVE      "<br>",D4
          PACK      KEY80,PNKNAME,D4,PNKTELP,SP70
          MATCH     "1",PTCNNEWC            * using new contacts ?
          IF        @EQUAL
            MOVE      "1",CONTTYPE
            CALL      XCON0000
            MOVE      PMCESNAM,PACSNAME
            MOVE      PMCEGNAM,PACGNAME
            MOVE      PMCETITL,PACTITLE
            MOVE      "1",PACFRMT
            CALL      PACNAME
            PACK      KEY80,PACFNAME,D4,PMCETELP,SP70
          ENDIF
          WRITE     HTMLFILE;"#"",KEY80,"#",";              *51
.
          PACK      KEY80,PNKNAME,D4,PMPXKMOB,SP70
          MATCH     "1",PTCNNEWC            * using new contacts ?
          IF        @EQUAL
            PACK      KEY80,PACFNAME,D4,PMCETELM,SP70
          ENDIF
          WRITE     HTMLFILE;"#"",KEY80,"#",";              *52
.
          PACK      KEY80,PTMXECNM,D4,PTMXECPP,SP70
          MATCH     "1",PTCNNEWC            * using new contacts ?
          IF        @EQUAL
            MOVE      "3",CONTTYPE
            CALL      XCON0000
            MOVE      PMCESNAM,PACSNAME
            MOVE      PMCEGNAM,PACGNAME
            MOVE      PMCETITL,PACTITLE
            MOVE      "1",PACFRMT
            CALL      PACNAME
            PACK      KEY80,PACFNAME,D4,PMCETELP,SP70
          ENDIF
          WRITE     HTMLFILE;"#"",KEY80,"#",";             *53
.
          PACK      KEY80,PTMXECNM,D4,PMPXCMOB,SP70
          MATCH     "1",PTCNNEWC            * using new contacts ?
          IF        @EQUAL
            PACK      KEY80,PACFNAME,D4,PMCETELM,SP70
          ENDIF
          WRITE     HTMLFILE;"#"",KEY80,"#");";            *54
.
BOKRWB99  RETURN
.------------------------------------------------------------
. Output Scheduled Bookings List Filter
.------------------------------------------------------------
BOKFLB00  MATCH     SP70,FLTSHORT
          IF        !@EQUAL
            MATCH     WMNOTICE,FLTSHORT
            GOTO      BOKFLB90 IF NOT EQUAL
          ENDIF
          MATCH     SP70,DOCTCODE
          IF        !@EQUAL
            MATCH     WMDOCTOR,DOCTCODE
            GOTO      BOKFLB90 IF NOT EQUAL
          ENDIF
.
          IF        SHRTNFLG=1
            PACK      CATECODE,CATECODE,SP70
            MATCH     SP70,CATECODE           * Check selected category
            IF        !@EQUAL
              MATCH     WMPTY,CATECODE
              GOTO      BOKFLB90 IF NOT EQUAL
            ENDIF
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      BOKFLB99
.
BOKFLB90  MOVE      ONE,EXIT
          GOTO      BOKFLB99
.
BOKFLB99  RETURN
.------------------------------------------------------------
. Output Waiting List by Date Range
.------------------------------------------------------------
DATTAB00  UNPACK    DIM127,D1,LINKPRG,DIM127 
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          MOVE      ZERO,RECCOUNT
.
          MATCH     SP70,UNITCODE
          GOTO      DATTAB05 IF EQUAL
.
          MATCH     SP70,DOCTCODE
          GOTO      DATTAB05 IF EQUAL
.
          PACK      KEY9,DOCTCODE,UNITCODE,SP70
          CALL      RDPMDUN1
          IF        OVRCD = 1
            WRITE     HTMLFILE;"alert('Doctor not linked to this UNIT');"
          ENDIF
.
DATTAB05  CALL      IBACLOCK
          PACK      KEY27,FRSTDATE,SP70
          CALL      RDSTREA3
DATTAB10  CALL      RDKTREA3
          BRANCH    OVRCD,DATTAB99
          MATCH     WMDATE1,LASTDATE
          GOTO      DATTAB99 IF LESS
.
          PACK      KEY19,WMURNO,WMCODE,DWMCNT
          CALL      RDWTTX11
          BRANCH    OVRCD,DATTAB10
.
          MATCH     SP70,INTDHOSP
          IF        @EQUAL
            PACK      INTDHOSP,WBSEHOSP,SP70
          ENDIF
.
          IF        IBCNMHOS = 1
            MATCH     SP70,WTWMIHSP
            IF        !@EQUAL
              MATCH     WTWMIHSP,INTDHOSP
              GOTO      DATTAB10 IF NOT EQUAL
            ENDIF
          ENDIF
.
          CALL      FILTER00
          BRANCH    EXIT,DATTAB10
.
          CALL      DATROW00
          ADD       ONE,RECCOUNT
          IF        RECCOUNT<LISTLIMT
            GOTO      DATTAB10
          ENDIF
.
          WRITE     HTMLFILE;"alert('Too Many Patients to View');"
.
          GOTO      DATTAB99
.
DATTAB99  RETURN
.------------------------------------------------------------
. Filter Waiting List by Date
.------------------------------------------------------------
FILTER00  MOVE      ZERO,EXIT
          MATCH     SP70,STATCODE
          GOTO      FILTER10 IF EQUAL
          MOVE      STATCODE,F1
          COMPARE   F1,WMSTAT
          GOTO      FILTER90 IF NOT EQUAL   * Check Status
.
FILTER10  MATCH     SP70,UNITCODE
          GOTO      FILTER20 IF EQUAL
          MATCH     UNITCODE,WMUNIT
          GOTO      FILTER90 IF NOT EQUAL 
.
FILTER20  MATCH     SP70,DOCTTYPE
          GOTO      FILTER25 IF EQUAL
          MOVE      WMDOCTOR,KEY6
          CALL      RDDOCT1
          BRANCH    OVRCD,FILTER30
.
          MATCH     DALEVEL,DOCTTYPE
          GOTO      FILTER90 IF NOT EQUAL
.
FILTER25  MATCH     SP70,DOCTCODE
          GOTO      FILTER30 IF EQUAL
          MATCH     WMDOCTOR,DOCTCODE
          GOTO      FILTER90 IF NOT EQUAL
.
FILTER30  COMPARE   NINE,WMSTAT             * Skip suspended procedures
          GOTO      FILTER90 IF EQUAL
.
FILTER40  MATCH     SP70,CATECODE           * Check selected category
          IF        !@EQUAL
            MATCH     CATECODE,WMPTY
            GOTO      FILTER90 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,LISTCODE           * Check list status
          IF        !@EQUAL
            MATCH     LISTCODE,WTTXPLST
            GOTO      FILTER90 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,REMSTATS
          IF        !@EQUAL
            MATCH     REMSTATS,WMREMOVE
            GOTO      FILTER90 IF NOT EQUAL
          ENDIF
.
          GOTO      FILTER99
.
FILTER90  MOVE      ONE,EXIT
.
FILTER99  RETURN
.------------------------------------------------------------
. Output Row Details
.------------------------------------------------------------
DATROW00  MATCH     "       0",WMURNO
          IF        @EQUAL
            MOVE      WMURNO,KEY8           * visit number
            UNPACK    KEY8,KEY2,KEY6          * r5
            CALL      RDPRAM1
            MOVE      ZERO,PURNO
          ELSE
            PACK      KEY8,WMURNO           * r5
            UNPACK    KEY8,KEY2,KEY6          * r5
            CALL      RDMAST1
            CALL      RDPMPX21
          ENDIF
.
          CALL      GETSEX00
.
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
          CALL      CASLNK00
.
          MOVE      "S ",CATEGORY
          MOVE      WTWMSRCR,CODE
          CALL      GETCOD00
          MOVE      TDESC,SRCRDESC
.
          MOVE      "WU",CATEGORY
          MOVE      WMUNIT,CODE
          CALL      GETCOD00
          MOVE      TDESC,UNITDESC
.
          MOVE      "VL",CATEGORY
          MOVE      WTTXPLST,CODE
          CALL      GETCOD00
          MOVE      TDESC,PRIOSTAT
.
          MOVE      "ap",CATEGORY
          MOVE      WTTXADMW,CODE
          CALL      GETCOD00
          MOVE      TDESC,ADMPDESC
.
          MOVE      SP10,PTWDSDES
          PACK      KEY6,WTTXWARD,SP70
          CALL      RDWARD1
.
          MOVE      "XG",CATEGORY
          MOVE      WTTXPAST,CODE
          CALL      GETCOD00
          MOVE      TDESC,DIM19
.
          MOVE      ZERO,NRCDAYS
          MOVE      "TP",CATEGORY
          MOVE      WMPTY,CODE
          CALL      GETCOD00
          MOVE      TDESC,PRIODESC
          CALL      COVER000     * Calculate Overdue Date & List Status
.
          MOVE      "WR",CATEGORY
          MOVE      WMREMOVE,CODE
          CALL      GETCOD00
          MOVE      TDESC,REMRDESC
          MOVE      TCINDC4,HLREASON
.
          PACK      HLTURNON,SP70    * determines if highlight is turned on
          CALL      FPCD0000         * find procedure group
.

          CALL      NEWOVR00         * New overdue calculation
.
          PACK      GENPNAME,SP70
          PACK      KEY10,WTWMRFGP,SP70
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCGNAM,KEY1
            PACK      GENPNAME,PMHCSNAM,COMMA,KEY1,SP70
            SQUEEZE   GENPNAME
          ENDIF
.
          MOVE      WMDOCTOR,KEY6
          CALL      RDDOCT1
          MOVE      DGNAME,ANS
          MOVE      DTITL,FMTTITLE            * I CAR 13038
          MOVE      DGNAME,FMTGNAME
          MOVE      DSNAME,FMTSNAME
          CALL      DOCNM000                  * end I CAR 13038
.
          PACK      KEY8,WMBOOK,SP70
          CALL      RDBKRX11
          IF        OVRCD = 1
           CALL       CLBOKRX1
          ENDIF
.
          MOVE      SP70,BKREEDAT
          PACK      KEY8,WMBOOK,SP70
          CALL      RDBKREC1
          IF        OVRCD=1
            MOVE      SP70,BKREEDAT
          ENDIF
.
          CALL      LSTDAY00
          CALL      NRCDAY00
.
          ASSIGN    (LSTDAYS-NRCDAYS),RFCDAYS
          IF        RFCDAYS < 1
            ASSIGN    ZERO,RFCDAYS
          ENDIF
.
          CALL      PATLN000           * Format names
          CALL      PATFLD00           * Returns KEY3 for folder colour code
          CALL      CRTDAY00
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":      * 0
                             "#"",FORMATNM,"#",":
                             "#"",WMURNO,"#",":
                             "#"",DISPSEX,"#",":
                             "#"",PSAGEYRS,"#",":
                             "#"",WMDATE1,"#",":
                             "#"",WMDATE2,"#",":
                             "#"",WMDATE3,"#",":
                             "#"",WMCODE,"#",";
.                                            * Display Procedure Description
.                                            * comments only if they exist
          MATCH     SP70,WTWMPDSC
          STRIP     WMDESC
          MOVELPTR  WMDESC,F3
          SFORMAT   DISPVAR1,F3
          MOVE      WMDESC,DISPVAR1
          IF        @EQUAL
            WRITE     HTMLFILE;"#"",DISPVAR1,"#",";
          ELSE
            STRIP     WTWMPDSC
          STRIP     WMDESC
            MOVELPTR  WTWMPDSC,F3
            SFORMAT   DISPVAR2,F3
            MOVE      WTWMPDSC,DISPVAR2
            WRITE     HTMLFILE;"#"",DISPVAR1,"<br />",DISPVAR2,"#",";
          ENDIF
          SFORMAT   DISPVAR1,127
          SFORMAT   DISPVAR2,127
.
          WRITE     HTMLFILE;"#"",WMREASON,"#",":
                             "#"",WTWMRANK,"#",":            * 10
                             "#"",WMSTAY,"#",":
                             "#"",WMDOCTOR,"#",":
                             "#"",DOCFNAME,"#",":            * I CAR 13038
                             "#"",WMPTY,"#",":
                             "#"",PRIOOVER,"#",":
                             "#"",OVERSTAT,"#",":
                             "#"",WTTXPLST,"#",":
                             "#"",SRCRDESC,"#",":
                             "#"",UNITDESC,"#",":
                             "#"",GENPNAME,"#",":           * 20
                             "#"",LSTDAYS,"#",":
                             "#"",NRCDAYS,"#",":
                             "#"",URGDAYS,"#",":
                             "#"",WTTXADMW,"#",":
                             "#"",WTWMDABD,"#",":
                             "#"",DIM19,"#",":
                             "#"",BKRXODTE,"#",":
                             "#"",WTTXPOWD,"#",":
                             "#"",KEY3,"#",":
                             "#"",WTWMECNT,"#",":           * 30
                             "#"",WTWMDTAD,"#",":
                             "#"",CRTDAYS,"#",":
                             "#"",WTWMUNIQ,"#",":
                             "#"",PRIOSTAT,"#",":
                             "#"",BKREEDAT,"#",":
                             "#"",RFCDAYS,"#",":            * 37
                             "#"",REMRDESC,"#",":           * 38
                             "#"",PRIODESC,"#",":           * 39
                             "#"",WTWMGADD,"#",":           * 40
                             "#"",HLTURNON,"#",":           * 41
                             "#"",HLREASON,"#",":           * 42
                             "#"",PTWDSDES,"#",":           * 43
                             "#"",ADMPDESC,"#");"           * 44
          RETURN
.------------------------------------------------------------
. highlight procedure code based on "WG" procedure group
.------------------------------------------------------------
FPCD0000  MOVE      ZERO,HLTURNON
.
          PACK      KEY9,WMCODE,SP70
          CALL      RDPROA1
          BRANCH    OVRCD,FPCD9999
.
          MATCH     WMCODE,WPCODE
          GOTO      FPCD9999 IF NOT EQUAL
.
          PACK      KEY5,CATWG,WPGRP,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,FPCD9999
.
          MATCH     "1",TCINDC1
          IF        @EQUAL
            PACK      HLTURNON,ONE
          ENDIF
.
FPCD9999  RETURN
.
.------------------------------------------------------------
. Next Day, Week, Month
.------------------------------------------------------------
NEXT0000  MOVE      VIEWTYPE,F1
          BRANCH    F1,NEXT0100,NEXT0200
          WRITE     HTMLFILE;"SelectNextDay();";
          GOTO      NEXT9999
NEXT0100  WRITE     HTMLFILE;"SelectNextWeek();";
          GOTO      NEXT9999
NEXT0200  WRITE     HTMLFILE;"SelectNextMonth();";
          GOTO      NEXT9999
NEXT9999  RETURN
.------------------------------------------------------------
. Last Day, Week, Month
.------------------------------------------------------------
PREV0000  MOVE      VIEWTYPE,F1
          BRANCH    F1,PREV0100,PREV0200
          WRITE     HTMLFILE;"SelectLastDay();";
          GOTO      PREV9999
PREV0100  WRITE     HTMLFILE;"SelectLastWeek();";
          GOTO      PREV9999
PREV0200  WRITE     HTMLFILE;"SelectLastMonth();";
          GOTO      PREV9999
PREV9999  RETURN
.------------------------------------------------------------
. Waiting List Letter Details
.------------------------------------------------------------
WATLET00  MATCH     "1",PATIENTL
          IF        @EQUAL
            CALL      PATLB000
          ENDIF
.
          MATCH     "1",MULTLETT
          IF        @EQUAL
            COMPARE   THREE,LETCOUNT
            GOTO      WATLET99 IF NOT LESS
          ENDIF
          CALL      CLWATDET
          MOVE      SP70,WTLHURNO
          MOVE      SP70,WTLHCODE
          MOVE      ZERO,WTLHCONT
          MOVE      SP70,WTLHDATE
          MOVE      SP70,WTLHLNUM
          MOVE      SP70,WTLHACTN
          MOVE      SP70,WTLHRPLY
          MATCH     SP70,CASEKEYS
          IF        !@EQUAL
            MOVE      CASEKEYS,KEY19
            CALL      RDTREA1
            BRANCH    OVRCD,WATLET96
            MOVE      WMURNO,URNUMBER
          ENDIF
          MATCH     SP70,HISTKEYS
          IF        !@EQUAL
            MOVE      HISTKEYS,KEY19
            CALL      RDTREA1
            BRANCH    OVRCD,WATLET96
            MOVE      WMURNO,URNUMBER
            MOVE      HISTKEYS,KEY30
            CALL      RDWTLHI1
            BRANCH    OVRCD,WATLET97
          ENDIF
          MOVE      URNUMBER,KEY8           * visit number
          CALL      RDMAST1
          BRANCH    OVRCD,WATLET95
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MATCH     SP70,UPDTTYPE      * Display
          GOTO      WATLET50 IF EQUAL
          MATCH     "A",UPDTTYPE       * Add New
          GOTO      WATLET10 IF EQUAL
          MATCH     "U",UPDTTYPE       * Update
          GOTO      WATLET20 IF EQUAL
          MATCH     "D",UPDTTYPE       * Delete
          GOTO      WATLET30 IF EQUAL
          MOVE      "Invalid Update Type",WEBTITLE
          CALL      WEBERR00
          GOTO      WATLET99
.
WATLET10  CALL      ADDLHI00
          BRANCH    DONTPRIN,WATLET00
.
          MOVE      WTLHLNUM,LETTER
.
          MATCH     "1",MULTLETT
          IF        !@EQUAL
            MATCH     "1",WAITLETT
            IF        !@EQUAL
              MOVE      ONE,SCHDCOPY
            ENDIF
          ENDIF
          CALL      ADDWLT00           * Add letter to watlpcaf
.
          MATCH     "1",MULTLETT
          GOTO      WATLET00 IF EQUAL
.
          GOTO      WATLET99
.
WATLET20  CALL      UPDLHI00
          GOTO      WATLET99
.
WATLET30  CALL      DELLHI00
          GOTO      WATLET99
.
WATLET50  CALL      PATNAM00
          CLEAR     WEBTITLE
          APPEND    PATFNAME,WEBTITLE
          APPEND    "(Waiting List History Details)",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00
          BRANCH    EXIT,WATLET99
          CALL      WEBBOD00
          CALL      WEBEND00
          GOTO      WATLET99
.
WATLET95  MOVE      "Invalid Waiting List Patient",WEBTITLE
          CALL      WINALT00
          GOTO      WATLET99
.
WATLET96  MOVE      "Invalid Waiting List Case Key",WEBTITLE
          CALL      WINALT00
          GOTO      WATLET99
.
WATLET97  MOVE      "Invalid Waiting List History Key",WEBTITLE
          CALL      WINALT00
          GOTO      WATLET99
.
WATLET99  RETURN
.------------------------------------------------------------
. Print a pmi label         
.------------------------------------------------------------
PATLB000  MOVE      SELPRINT,SCHDPRNT   * Array of selected Printer
          MOVE      CASEKEYS,SUBSYSKY
          CALL      ADDPRN00
          MOVE      ZERO,PATIENTL
.
PATLB999  RETURN
+
.------------------------------------------------------------
. Add & Print New Letter
.------------------------------------------------------------
ADDLHI00  MOVE      ZERO,DONTPRIN
          MATCH     "1",MULTLETT
          IF        @EQUAL
            ADD       ONE,LETCOUNT
            LOAD      DIM1,LETCOUNT,LETTER01,LETTER02,LETTER03
            MATCH     "1",DIM1
            IF        !@EQUAL
              MOVE      ONE,DONTPRIN
              GOTO      ADDLHI80
            ENDIF
            LOAD      WATLH002,LETCOUNT,WTLH0021,WTLH0022,WTLH0023
            LOAD      SCHDCOPY,LETCOUNT,SCHDCOP1,SCHDCOP2,SCHDCOP3
            LOAD      SELPRINT,LETCOUNT,SELPRIN1,SELPRIN2,SELPRIN3
          ENDIF
.
          MOVE      SP70,WTLHDATE
          MOVE      SP70,WTLHLNUM
          MOVE      SP70,WTLHACTN
          MOVE      SP70,WTLHRPLY
          MOVE      CASEKEYS,KEY19
          CALL      RDTREA1
          BRANCH    OVRCD,ADDLHI90
.
          CALL      MVLHI000
.
          MATCH     SP70,WTLHDATE
          IF        @EQUAL
            CALL      IBACLOCK
            PACK      WTLHDATE,CCC,CYY,CMM,CDD
            REP       " 0",WTLHDATE
          ENDIF
.
          MOVE      USERID,WTLHUSER
.
          MOVE      WTLHLNUM,KEY3
          MOVE      ZERO,F3
          PACK      KEY6,KEY3,F3
          CALL      RDLET1
          BRANCH    OVRCD,ADDLHI91
.
          UNPACK    CASEKEYS,WTLHURNO,WTLHCODE,KEY2
          MOVE      KEY2,WTLHCONT
          PACK      KEY30,WTLHURNO,WTLHCODE,WTLHCONT,WTLHDATE,WTLHLNUM,SP70
          CALL      RDWTLHI1
          IF        OVRCD=1
            CALL      WRWTLHI1
          ENDIF
.
.???? Need Routine to Print the Letter ?????
.  Maybe Schedule like Labels in EMR ?????
.--------------------------------------------
.
          COMPARE   ONE,LETTREQD
          IF        !@EQUAL
            CALL      WINCLS00
          ENDIF
ADDLHI80  MATCH     "1",MULTLETT
          IF        @EQUAL
            COMPARE   THREE,LETCOUNT
            IF        @EQUAL
              CALL      RDIREC00
            ENDIF
          ENDIF
          GOTO      ADDLHI99
.
ADDLHI90  MOVE      "Invalid Waiting List Key",WEBTITLE
          CALL      WEBERR00
          GOTO      ADDLHI99
ADDLHI91  MOVE      "Invalid Letter Code",WEBTITLE
          CALL      WEBERR00
          GOTO      ADDLHI99
.
ADDLHI99  RETURN
.------------------------------------------------------------
. Update Letter Details
.------------------------------------------------------------
UPDLHI00  MOVE      HISTKEYS,KEY19
          CALL      RDTREA1
          BRANCH    OVRCD,UPDLHI90
          MOVE      WMURNO,URNUMBER
          MOVE      HISTKEYS,KEY30
          CALL      RDWTLHI1
          BRANCH    OVRCD,UPDLHI90
          CALL      MVLHI000
          CALL      UPWTLHI1
.
          MATCH     Z70,BOKRX006
          GOTO      UPDLHI10 IF NOT EQUAL
.
          CALL      WINCLS00
          GOTO      UPDLHI99
.
UPDLHI10  PACK      KEY8,ADMISSNO,SP70
          CALL      RDBKRX11                * Read booking extn file
          IF        OVRCD=0
            MOVE      BOKRX006,BKRXCNDT
            CALL      UPBKRX11                * Update booking extn file
          ENDIF
.
          CALL      RDIWIN00
          GOTO      UPDLHI99
.
UPDLHI90  MOVE      "Invalid History Key",WEBTITLE
          CALL      WEBERR00
.
UPDLHI99  RETURN
.------------------------------------------------------------
. Delete Letter 
.------------------------------------------------------------
DELLHI00  MOVE      HISTKEYS,KEY19
          CALL      RDTREA1
          BRANCH    OVRCD,DELLHI90
          MOVE      WMURNO,URNUMBER
          MOVE      HISTKEYS,KEY30
          CALL      RDWTLHI1
          BRANCH    OVRCD,DELLHI90
          CALL      DEWTLHI1
          CALL      WINCLS00
          GOTO      DELLHI99
.
DELLHI90  MOVE      "Invalid History Key",WEBTITLE
          CALL      WEBERR00
.
DELLHI99  RETURN
.------------------------------------------------------------
. Process Letter Fields
.------------------------------------------------------------
WLET0000  BRANCH    FLDITMNO,WLET0100,WLET0200,WLET0300,WLET0400,WLET0500:
                    WLET0600
          WRITE     HTMLFILE;"Invalid Tag";
          GOTO      WLET9999
.
WLET0100  PACK      KEY30,WTLHURNO,WTLHCODE,WTLHCONT,WTLHDATE,WTLHLNUM,SP70
          WRITE     HTMLFILE;KEY30;
          GOTO      WLET9999
.
WLET0200  MATCH     SP70,WTLHDATE
          GOTO      WLET9999 IF EQUAL
          UNPACK    WTLHDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      WLET9999
.
WLET0300  CALL      LETITM00
          GOTO      WLET9999
.
WLET0400  MOVE      "WB",CATEGORY
          MOVE      WTLHRPLY,CODE
          CALL      CODITM00
          GOTO      WLET9999
.
WLET0500  MOVE      "WC",CATEGORY
          MOVE      WTLHACTN,CODE
          CALL      CODITM00
          GOTO      WLET9999
.
WLET0600  PACK      KEY8,ADMISSNO,SP70
          CALL      RDBKRX11                * Read booking extn file
          IF        OVRCD=1
            MOVE      SP70,BKRXCNDT
          ENDIF
          MATCH     SP70,BKRXCNDT
          GOTO      WLET9999 IF EQUAL
          MOVE      ZERO,F2
          MOVE      SP70,MTHNAM3
          MOVE      ZERO,CCENT
          MOVE      ZERO,CYEAR
          MOVE      ZERO,CMON
          MOVE      ZERO,CDAY
          UNPACK    BKRXCNDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      WLET9999           
.
WLET9999  RETURN
.------------------------------------------------------------
. Display Letter Drop Down List
.------------------------------------------------------------
BKTITM00  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,BKTITM10,BKTITM20
          MOVE      BKRXCTTY,KEY3
          MOVE      ZERO,F3
          PACK      KEY6,KEY3,F3
          CALL      RDLET1
          WRITE     HTMLFILE;WLTEXT;
          GOTO      BKTITM99
.
BKTITM10  WRITE     HTMLFILE;BKRXCTTY;
          GOTO      BKTITM99
.
BKTITM20  CALL      BKSELL00
          GOTO      BKTITM99
.
BKTITM99  RETURN
.------------------------------------------------------------
. Display Letter Drop Down List
.------------------------------------------------------------
LETITM00  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,LETITM10,LETITM20,LETITM20,LETITM30
          MOVE      WTLHLNUM,KEY3
          MOVE      ZERO,F3
          PACK      KEY6,KEY3,F3
          CALL      RDLET1
          WRITE     HTMLFILE;WLTEXT;
          GOTO      LETITM99
.
LETITM10  WRITE     HTMLFILE;WTLHLNUM;
          GOTO      LETITM99
.
LETITM20  CALL      LETSEL00
          GOTO      LETITM99
.
LETITM30  CALL      SMSSEL00
          GOTO      LETITM99
.
LETITM99  RETURN
.
LETSEL00  MOVE      ZERO,F3
          PACK      KEY76,F3,SP70
          CALL      RDSLET3
LETSEL10  CALL      RDKLET3
          BRANCH    OVRCD,LETSEL99
          COMPARE   ZERO,WLINNO
          GOTO      LETSEL99 IF NOT EQUAL
.
          MATCH     "1",WLETACTV            * Skip if inactive
          GOTO      LETSEL10 IF EQUAL
.
          MATCH     "1",WLETCOMM            * Skip if SMS
          GOTO      LETSEL10 IF EQUAL
.
          IF        F1=3
            WRITE     HTMLFILE;"<option value=",WLETNO,">":
                               WLTEXT,"</option>"
            GOTO      LETSEL10
          ENDIF
          COMPARE   WTLHLNUM,WLETNO
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",WLETNO," selected>":
                               WLTEXT,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",WLETNO,">":
                               WLTEXT,"</option>"
          ENDIF
          GOTO       LETSEL10
.
LETSEL99 RETURN
.
SMSSEL00  MOVE      ZERO,F3
          PACK      KEY6,F3,SP70
          CALL      RDSLET2
SMSSEL10  CALL      RDKLET2
          BRANCH    OVRCD,SMSSEL99
          COMPARE   ZERO,WLINNO
          GOTO      SMSSEL99 IF NOT EQUAL
.
          MATCH     "1",WLETACTV            * Skip if inactive
          GOTO      SMSSEL10 IF EQUAL
.
          MATCH     "1",WLETCOMM            * Skip if NOT SMS
          GOTO      SMSSEL10 IF NOT EQUAL
.
          COMPARE   WTLHLNUM,WLETNO
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",WLETNO," selected>":
                               WLTEXT,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",WLETNO,">":
                               WLTEXT,"</option>"
          ENDIF
          GOTO       SMSSEL10
.
SMSSEL99 RETURN
.
BKSELL00  MOVE      ZERO,F3
          PACK      KEY6,F3,SP70
          CALL      RDSLET2
BKSELL10  CALL      RDKLET2
          BRANCH    OVRCD,BKSELL99
          COMPARE   ZERO,WLINNO
          GOTO      BKSELL99 IF NOT EQUAL
          MATCH     BKRXCTTY,DWLETNO
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",WLETNO," selected>":
                               WLTEXT,"</option>"
          ELSE
            MATCH     "1",WLETACTV            * Skip if inactive
            GOTO      BKSELL10 IF EQUAL
.
            MATCH     "1",WLETCOMM            * Skip if SMS
            GOTO      BKSELL10 IF EQUAL
.
            WRITE     HTMLFILE;"<option value=",WLETNO,">":
                               WLTEXT,"</option>"
          ENDIF
          GOTO       BKSELL10
.
BKSELL99 RETURN
.------------------------------------------------------------
. Waiting List Suspension Details
.------------------------------------------------------------
WATSUS00  CALL      CLWATDET
.
          MOVE      SP70,WTSUURNO
          MOVE      SP70,WTSUCODE
          MOVE      ZERO,WTSUCNT
          MOVE      ZERO,WTSUSCNT
          MOVE      SP70,WTSUFDAT
          MOVE      SP70,WTSUTDAT
          MOVE      SP70,WTSUREAS
          MOVE      SP70,WTSULSTS
          MOVE      SP70,WTSUUSER
          MOVE      SP70,WATEXT
.
          MATCH     SP70,CASEKEYS
          IF        !@EQUAL
            MOVE      CASEKEYS,KEY19
            CALL      RDTREA1
            BRANCH    OVRCD,WATSUS96
            MOVE      WMURNO,URNUMBER
          ENDIF
.
          MATCH     SP70,SUSPKEYS
          IF        !@EQUAL
            MOVE      SUSPKEYS,KEY19
            CALL      RDTREA1
            BRANCH    OVRCD,WATSUS96
            MOVE      WMURNO,URNUMBER
            MOVE      SUSPKEYS,KEY21
            CALL      RDMESA1
            CALL      RDWTSUS1
            BRANCH    OVRCD,WATSUS97
          ENDIF
. Allow Suspension for Schedule Patient (RCH Request - 15/11/2001)
.          COMPARE   ONE,WMSTAT
.          GOTO      WATSUS94 IF NOT EQUAL
.

          COMPARE   SIX,WMSTAT
          GOTO      WATSUS94 IF EQUAL
.
          MOVE      URNUMBER,KEY8           * visit number
          CALL      RDMAST1
          BRANCH    OVRCD,WATSUS95
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MATCH     SP70,UPDTTYPE      * Display
          GOTO      WATSUS50 IF EQUAL
          MATCH     "A",UPDTTYPE       * Add New
          GOTO      WATSUS10 IF EQUAL
          MATCH     "U",UPDTTYPE       * Update
          GOTO      WATSUS20 IF EQUAL
          MATCH     "D",UPDTTYPE       * Delete
          GOTO      WATSUS30 IF EQUAL
          MOVE      "Invalid Update Type",WEBTITLE
          CALL      WEBERR00
          GOTO      WATSUS99
.
WATSUS10  MOVE      "1",UPDSUS01
          CALL      ADDSUS00
          IF        EXIT<>1
            CALL      ADDTP000
          ENDIF
          GOTO      WATSUS99
.
WATSUS20  CALL      UPDSUS00
          GOTO      WATSUS99
.
WATSUS30  CALL      DELSUS00
          GOTO      WATSUS99
.
WATSUS50  
.          UNPACK    CASEKEYS,WTSUURNO,WTSUCODE,KEY2  * Commented by HPS
.          MOVE      KEY2,WTSUCNT                     * Commented by HPS
.
          PACK      KEY21,WTSUURNO,WTSUCODE,WTSUCNT,WTSUSCNT,SP70 
          CALL      RDWTSUS1
          IF        OVRCD=1
             CALL     CLRWTS00    
          ENDIF
.
          CALL      PATNAM00
          CLEAR     WEBTITLE
          APPEND    PATFNAME,WEBTITLE
          APPEND    "(Waiting List History Details)",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00
          BRANCH    EXIT,WATSUS99
          CALL      WEBBOD00
          CALL      WEBEND00
          MOVE      ONE,EXIT
          GOTO      WATSUS99
.
WATSUS94  MOVE      "Patient status is not Unscheduled",WEBTITLE
          CALL      WINALT00
          GOTO      WATSUS99
.
WATSUS95  MOVE      "Invalid Waiting List Patient",WEBTITLE
          CALL      WINALT00
          GOTO      WATSUS99
.
WATSUS96  MOVE      "Invalid Waiting List Case Key",WEBTITLE
          CALL      WINALT00
          GOTO      WATSUS99
.
WATSUS97  MOVE      "Invalid Waiting List History Key",WEBTITLE
          CALL      WINALT00
          GOTO      WATSUS99
.
WATSUS99  CLOSE     COMFILAF,DELETE
          RETURN
.
.----------------------------------------------------------------------
.      Add category TP record if required
.----------------------------------------------------------------------
ADDTP000  MATCH     Z70,WATTR014
          GOTO      ADDTP999 IF EQUAL
.
          PACK      KEY19,CASEKEYS,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,ADDTP999
.
          PACK      PRIORITY,WMPTY
          MATCH     WMPTY,WATTR014           * has priority changed?
          GOTO      ADDTP999 IF EQUAL
.
          CALL      IBACLOCK
          PACK      CURDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURDATE
.
          MATCH     WTSUFDAT,CURDATE        * ignore future changes
          GOTO      ADDTP999 IF LESS
.
          PACK      WMPTY,WATTR014,SP70
          CALL      UPTREA1
.
          PACK      WATHI002,WTSUFDAT,SP70
          CALL      UPPRI000
.
          MATCH     SP70,WTSUTDAT
          GOTO      ADDTP999 IF EQUAL
.
          MATCH     WTSUTDAT,CURDATE
          GOTO      ADDTP999 IF LESS
.
          PACK      WATHI002,WTSUTDAT,SP70
          PACK      WMPTY,PRIORITY,SP70
          CALL      UPPRI000
.... change back to previous priority???
          CALL      UPTREA1
          GOTO      ADDTP999
.
ADDTP999  RETURN
.
.----------------------------------------------------------------------
.      Add category TP record for rfc - same as previous priority
.----------------------------------------------------------------------
ADDTPR00  COMPARE   TWO,PTCNHDPS                * Is NSW?
          GOTO      ADDTPR99 IF NOT EQUAL
.
          PACK      KEY29,WMURNO,WMCODE,WMCNT,ANST,ANSP,Z70
          PACK      KEY5,ANST,ANSP,SP70
          CALL      RSWTCAT2
ADDTPR10  CALL      RPWTCAT2
          BRANCH    OVRCD,ADDTPR99
.
          MATCH     WMURNO,WTCAURNO            * Correct U/R
          GOTO      ADDTPR99 IF NOT EQUAL
.
          MATCH     WMCODE,WTCAPROC            * Correct proceedure code
          GOTO      ADDTPR99 IF NOT EQUAL
.
          COMPARE   WMCNT,WTCAPCNT            * Correct proceedure code
          GOTO      ADDTPR99 IF NOT EQUAL
.
          MATCH     KEY5,WTCACATF             * Priority 
          GOTO      ADDTPR99 IF NOT EQUAL
.
          MATCH     SP70,WTCACODF             * Exit No Previous Priority
          GOTO      ADDTPR99 IF EQUAL
.
          PACK      KEY19,WMURNO,WMCODE,WMCNT,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,ADDTPR99
.
          PACK      PRIORITY,WMPTY            * Save priority
.
          MATCH     WMPTY,WTCACODF            * has priority changed?    
          GOTO      ADDTPR99 IF EQUAL
.
          CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          MATCH     WTCAEDAT,CURRDATE         * ignore future changes    
          GOTO      ADDTPR99 IF LESS 
.
          PACK      WMPTY,WTCACODF,SP70
          CALL      UPTREA1
.
          PACK      WATHI002,WTSUTDAT,SP70
          CALL      UPPRI000
.
ADDTPR99  RETURN
.
.----------------------------------------------------------------------
.
CLRWTS00  MOVE      SP70,WTSUFDAT
          MOVE      SP70,WTSUTDAT
          MOVE      SP70,WTSUREAS
          MOVE      SP70,WTSULSTS
          MOVE      SP70,WTSUUSER
          MOVE      SP70,WAURNO
          MOVE      SP70,WAPROC 
          MOVE      SP70,DWACNT
          MOVE      SP70,DWACNT2 
          MOVE      SP70,WATEXT 
          MOVE      SP70,WASPARE
.
CLRWTS99  RETURN
.----------------------------------------------------------------------
.      Suspend a Waiting List Entry --- ADDSUS00 -- ADD Suspension
.----------------------------------------------------------------------
ADDSUS00  CALL      CLRWTS00 
          PACK      KEY19,CASEKEYS,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,ADDSUS90
.                                           * Hps Code Starts Here
          CALL      MVSUS000                * Move Cgi Variables To File  
          MOVE      WTSUFDAT,DATE1          * Move FromDate to Date1 
          MOVE      WMDATE1,DATE2           * Move DateOnList to Date2 
          IF        DATE1 < DATE2           
            GOTO      ADDSUS94              * If suspension date < date on List
          ENDIF
          MOVE      ZERO,DATE2              * Clear Date2 Variable
          MOVE      ZERO,DATE3              * Clear Date3 Variable
          MOVE      WTSUTDAT,DATE2          * Move FromDate to Date2
.
.---------loop through the watsusaf and check the patient is already ------
.---------suspended or not-------------------------------------------------
.          
          UNPACK    CASEKEYS,WTSUURNO,WTSUCODE,KEY2
          MOVE      KEY2,WTSUCNT
          PACK      KEY21,WTSUURNO,WTSUCODE,WTSUCNT,SP70
          CALL      RSWTSUS1
ADDSUS10  CALL      RKWTSUS1
          BRANCH    OVRCD,ADDSUS20
.
          MATCH     WMURNO,WTSUURNO
          GOTO      ADDSUS20 IF NOT EQUAL       * Exit if URNo does'nt match
.
          MATCH     WMCODE,WTSUCODE
          GOTO      ADDSUS20 IF NOT EQUAL       * Exit Proc-code Does'nt match
.
          COMPARE   WMCNT,WTSUCNT
          GOTO      ADDSUS20 IF NOT EQUAL       * Exit proc-count does'nt match 
.
          MOVE      ZERO,DATE3
          MOVE      ZERO,DATE4
          MOVE      WTSUFDAT,DATE3
          MOVE      WTSUTDAT,DATE4
. 
... for victoria, you cannot have two changes on one day, so error if it is
... starting a suspension on the same date as the previous record finishes
          COMPARE   THREE,PTCNHDPS
          IF        @EQUAL
            IF        DATE1=DATE4
........      GOTO      ADDSUS95
            ENDIF
          ENDIF
.
.--------case when the ToDate is not entered ------------------------
. 
          COMPARE   ZERO,DATE2
          IF        @EQUAL
            IF        DATE1 >= DATE3 & DATE1 < DATE4 
              GOTO      ADDSUS92
            ENDIF
            IF        DATE1 > DATE3 & DATE4 = 0
              GOTO      ADDSUS92
            ENDIF
            IF        DATE1 <= DATE3
              GOTO      ADDSUS92          * CAR 213458 added =
            ENDIF
          GOTO      ADDSUS10
          ENDIF
. 
.--------case when the Fromdate and Todate are Entered----------------
.
ADDSUS11  IF        DATE3 < DATE1 & DATE4 > DATE1 & DATE4 <> 0
            GOTO      ADDSUS92
          ENDIF  
          IF        DATE3 < DATE2 & DATE4 >= DATE2 & DATE4 <> 0 
            GOTO      ADDSUS92
          ENDIF
          IF        DATE1 < DATE3 & DATE2 > DATE4 & DATE4 <> 0 
            GOTO      ADDSUS92
          ENDIF
          IF        DATE1 > DATE3 & DATE4 = 0
            GOTO      ADDSUS92
          ENDIF
          GOTO        ADDSUS10
.-------------------------------------------------------------------------
.------case when patient is unscheduled & proposed adm date greater than todate
.                                          * Hps Code Ends Here 
ADDSUS20  UNPACK    CASEKEYS,WTSUURNO,WTSUCODE,KEY2
          MOVE      KEY2,WTSUCNT
          MOVE      ZERO,WTSUSCNT
          MOVE      ZERO,F2
.
          PACK      KEY21,WTSUURNO,WTSUCODE,WTSUCNT,Z70
          CALL      RSWTSUS1
ADDSUS30  CALL      RPWTSUS1
          BRANCH    OVRCD,ADDSUS40
.
          MATCH     WMURNO,WTSUURNO
          GOTO      ADDSUS40 IF NOT EQUAL
.
          MATCH     WMCODE,WTSUCODE
          GOTO      ADDSUS40 IF NOT EQUAL
.
          COMPARE   WMCNT,WTSUCNT
          GOTO      ADDSUS40 IF NOT EQUAL
          MOVE      WTSUSCNT,F2
.
ADDSUS40  CALL      MVSUS000
          ADD       ONE,F2
          MOVE      F2,WTSUSCNT
          UNPACK    CASEKEYS,WTSUURNO,WTSUCODE,KEY2
          MOVE      KEY2,WTSUCNT
.                                            * Hps Code starts Here
          PACK      KEY21,WTSUURNO,WTSUCODE,WTSUCNT,WTSUSCNT,SP70
          CALL      RAWTSUS1
          IF        OVRCD=1
            CALL      CLRWTS00
            CALL      MVSUS000
            CALL      WRWTSUS1
            PACK      WTCHUPTY,TWO,TWO,SP70
            CALL      WRCS0000
          ELSE
            GOTO      ADDSUS90
          ENDIF
.
.         MOVE      WTSULSTS,WMUDEF4          * Commented as per specs 
          PACK      KEY19,WMURNO,WMCODE,WMCNT,SP70
          CALL      RDWTTX11
          BRANCH    OVRCD,ADDSUS50
.
          MATCH     "1",UPDSUS01
          IF        !@EQUAL
            CALL      SVWTTX00                * Populate File Variables
          ELSE
            REP       " 0",XCDATE
            MOVE      XCDATE,WTTXLUPD       * Current Date 
            CLOCK     TIME,WTTXLUPT         * Current Time
            MOVE      USERID,WTTXWEBU       * WEB User Id rec.   
            MOVE      "0",UPDSUS01
          ENDIF
          PACK      DATEC,CCC,CYY,CMM,CDD      * HPSI
          REP       " 0",DATEC
          MOVE      DATEC,DATE1
          MOVE      WTSUFDAT,DATE2
          MOVE      ZERO,DATE3
          MOVE      WTSUTDAT,DATE3
          IF        DATE3=0
            MOVE      DATEC,DATE3
            ADD       ONE,DATE3
          ENDIF
          IF        DATE1>=DATE2 & DATE1<DATE3
            MOVE      WTSULSTS,WTTXPLST
          ENDIF
          CALL      UPWTTX11                * Write a Record in wattx1af
.
ADDSUS50  CALL      WESUS000
          MATCH     "1",DWMSTAT
          GOTO      ADDSUS60 IF NOT EQUAL
.      
          PACK      KEY5,ANSV,ANSL,WATSU004,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ADDSUS60
.
          MATCH     ANSR,TCINDC1
          GOTO      ADDSUS60 IF EQUAL
.
          PACK      KEY19,CASEKEYS,SP70
          CALL      RDTREA1
          IF        OVRCD=0
            MOVE      WMDATE3,DATE5
            IF        DATE5 < DATE2
              MOVE      SP70,WMDATE3
              CALL      UPTREA1 
              PACK      KEY19,WMURNO,WMCODE,WMCNT,SP70
              CALL      RDWTTX11
              IF        OVRCD=0
                MOVE      SP70,WTTXPATM 
                CALL      UPWTTX11     * Write a Record in wattx1af
              ENDIF
            ENDIF
          ENDIF
.
ADDSUS60  CALL      WRCOM000                  * Write the Comments 
          MOVE      ZERO,EXIT
          GOTO      ADDSUS99
.
ADDSUS90  MOVE      "Invalid Waiting List Key",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDSUS99
.
ADDSUS91  MOVE      "Invalid Letter Code",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDSUS99
.
ADDSUS92  MOVE      "Attempt to Suspend an already Suspended Patient",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDSUS99
.
ADDSUS93  MOVE      "ToDate Less Than FromDate",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDSUS99
.
ADDSUS94  MOVE      "Date Of Suspension Less Than Date On List",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDSUS99
.                                          * Hps Code Ends Here 
ADDSUS95  MOVE      "Unable to suspend on same date as previous record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDSUS99
.
ADDSUS99  RETURN
.------------------------------------------------------------
. Write ESIS Suspension details
.------------------------------------------------------------
WESUS000  COMPARE   THREE,PTCNHDPS
          GOTO      WESUS999 IF NOT EQUAL   * Not in Victoria
.
          MOVE      ZERO,CHGFDAT
          MOVE      ZERO,CHGTDAT
          MOVE      ZERO,CHGSUSV
          CALL      IBACLOCK
          PACK      CURDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURDATE
.
          MATCH     SP70,SUSPKEYS             * updating
          IF        !@EQUAL
            MATCH     WTSUFDAT,SAVEFDAT       * no change to from date
            IF        @EQUAL
              GOTO      WESUS100
            ELSE
              MOVE      ONE,CHGFDAT
              CALL      CHNSUS00
              MOVE      ZERO,CHGFDAT
              GOTO      WESUS100
            ENDIF
          ENDIF
.
          MATCH     WTSUFDAT,CURDATE
          GOTO      WESUS999 IF LESS
.
          MOVE      WTSUFDAT,WTENEVDT
          MOVE      WTSULSTS,WTENEVAL
          CALL      WRRED000
.
WESUS100  MATCH     SP70,SUSPKEYS             * updating
          IF        !@EQUAL
            MATCH     WTSUTDAT,SAVETDAT       * no change to to date
            IF        @EQUAL
              GOTO      WESUS999
            ELSE
              MOVE      ONE,CHGTDAT
              CALL      CHNSUS00
              MOVE      ZERO,CHGTDAT
            ENDIF
          ENDIF
.
          MATCH     SP70,WTSUTDAT
          GOTO      WESUS999 IF EQUAL
          MATCH     WTSUTDAT,CURDATE
          GOTO      WESUS999 IF LESS
.
          PACK      KEY5,ANSV,ANSL,SP70
          CALL      RDSCODE1
WESUS500  CALL      RDKCODE1
          BRANCH    OVRCD,WESUS999
.
          MATCH     "VL",TCODE
          GOTO      WESUS999 IF NOT EQUAL
.
          MATCH     "A",PTCOACTV           * Only want active codes
          GOTO      WESUS500 IF NOT EQUAL
.
          MATCH     "R",TCINDC1            * Must have indicator 1 = "R"
          GOTO      WESUS500 IF NOT EQUAL
.
          MOVE      WTSUTDAT,WTENEVDT
          MOVE      ACODE,WTENEVAL
          CALL      WRRED000
.
WESUS999  RETURN
.------------------------------------------------------------
. Write  Suspension
.------------------------------------------------------------
WRRED000  PACK      WTENUNIQ,WTWMECNT,SP70
          PACK      WTENEDAT,SP70
          PACK      WTENETYP,ANSR
          PACK      WTENWEBC,WBSEUID
          PACK      WTENSADI,SP70
          CALL      IBACLOCK
          PACK      WTENCDAT,CCC,CYY,CMM,CDD
          REP       " 0",WTENCDAT
          CLOCK     TIME,WTENCTIM
          REP       " 0",WTENCTIM
          PACK      WTENWEBU,SP70
          PACK      WTENUDAT,SP70
          PACK      WTENUTIM,SP70
          MOVE      ZERO,WTENMANU
.
          PACK      KEY36,WTENUNIQ,WTENETYP,WTENEVDT,WTENEDAT,SP70
          CALL      RAWTESN1
          IF        OVRCD=1
            CALL      WRWTESN1
          ELSE
            PACK      WTENWEBU,WBSEUID
            PACK      WTENUDAT,CCC,CYY,CMM,CDD
            REP       " 0",WTENUDAT
            CLOCK     TIME,WTENUTIM
            REP       " 0",WTENUTIM
            CALL      UPWTESN1
          ENDIF
.
WRRED999  RETURN
.------------------------------------------------------------
. Change ESIS Suspension
.------------------------------------------------------------
CHNSUS00  PACK      WTENUNIQ,WTWMECNT,SP70
          PACK      WTENEDAT,SP70
          PACK      WTENETYP,ANSR
.
          IF        CHGFDAT=0
            GOTO      CHNSUS20
          ENDIF
.
          MATCH     WTSUFDAT,CURDATE
          IF        @LESS
            PACK      WTSUFDAT,SAVEFDAT
            CALL      DELSS000
            MOVE      SP70,WTSUFDAT
            GOTO      CHNSUS99
          ENDIF
.
. ---- check if new record already exists ----
.
          PACK      KEY36,WTENUNIQ,WTENETYP,WTSUFDAT,WTENEDAT,SP70
          CALL      RAWTESN1
          IF        OVRCD=0
            GOTO      CHNSUS20
          ENDIF
.
. ----  check if old record is unsent, if so update with new date ----
.
          PACK      KEY36,WTENUNIQ,WTENETYP,SAVEFDAT,WTENEDAT,SP70
          CALL      RDWTESN1
          BRANCH    OVRCD,CHNSUS10
.
          PACK      WTENWEBU,WBSEUID
          MOVE      WTSUFDAT,WTENEVDT
          PACK      WTENUDAT,CCC,CYY,CMM,CDD
          REP       " 0",WTENUDAT
          CLOCK     TIME,WTENUTIM
          REP       " 0",WTENUTIM
          CALL      UPWTESN1
          GOTO      CHNSUS20
.
.
. ----  check if old record is sent, if so delete and write new date ----
.
CHNSUS10  PACK      KEY36,WTWMECNT,ANSR,SAVEFDAT,SP70
          CALL      RSWTESN1
          CALL      RKWTESN1
          BRANCH    OVRCD,CHNSUS15
.
          MATCH     WTENUNIQ,WTWMECNT
          GOTO      CHNSUS15 IF NOT EQUAL
.
          MATCH     ANSR,WTENETYP
          GOTO      CHNSUS15 IF NOT EQUAL
.
          MATCH     SAVEFDAT,WTENEVDT
          GOTO      CHNSUS15 IF NOT EQUAL
.
          MOVE      DELETERC,WTENEVAL
          MOVE      SP70,WTENEDAT
          PACK      WTENWEBC,WBSEUID
          PACK      WTENSADI,SP70
          CALL      IBACLOCK
          PACK      WTENCDAT,CCC,CYY,CMM,CDD
          REP       " 0",WTENCDAT
          CLOCK     TIME,WTENCTIM
          REP       " 0",WTENCTIM
          MOVE      SP70,WTENWEBU
          MOVE      SP70,WTENUDAT
          MOVE      SP70,WTENUTIM
          MOVE      ZERO,WTENMANU
.
. ---- write delete record ----
.
          PACK      KEY36,WTENUNIQ,WTENETYP,WTENEVDT,WTENEDAT,SP70
          CALL      RAWTESN1
          IF        OVRCD=1
            CALL      WRWTESN1
          ENDIF
.
. ---- write correct record ----
.
CHNSUS15  MOVE      WTSUFDAT,WTENEVDT
          MOVE      WTSULSTS,WTENEVAL
          MATCH     WTENEVDT,TODAY
          GOTO      CHNSUS20 IF LESS
          PACK      WTENETYP,ANSR,SP70
          MOVE      SP70,WTENEDAT
          PACK      WTENWEBC,WBSEUID
          PACK      WTENSADI,SP70
          CALL      IBACLOCK
          PACK      WTENCDAT,CCC,CYY,CMM,CDD
          REP       " 0",WTENCDAT
          CLOCK     TIME,WTENCTIM
          REP       " 0",WTENCTIM
          MOVE      SP70,WTENWEBU
          MOVE      SP70,WTENUDAT
          MOVE      SP70,WTENUTIM
          MOVE      ZERO,WTENMANU
          PACK      KEY36,WTENUNIQ,WTENETYP,WTENEVDT,WTENEDAT,SP70
          CALL      RAWTESN1
          IF        OVRCD=1
            CALL      WRWTESN1
          ENDIF
.
CHNSUS20  IF        CHGTDAT=0
            GOTO      CHNSUS50
          ENDIF
.
          MATCH     WTSUTDAT,CURDATE
          IF        @LESS
            MOVE      SP70,WTSUTDAT
          ENDIF
.
          PACK      WTENUNIQ,WTWMECNT,SP70
          PACK      WTENEDAT,SP70
          PACK      WTENETYP,ANSR
          MATCH     SP70,WTSUTDAT
          GOTO      CHNSUS25 IF EQUAL
.
. ---- check if new record already exists ----
.
          PACK      KEY36,WTENUNIQ,WTENETYP,WTSUTDAT,WTENEDAT,SP70
          CALL      RAWTESN1
          IF        OVRCD=0
            GOTO      CHNSUS50
          ENDIF
.
. ----  check if old record is unsent, if so update with new date ----
.
CHNSUS25  PACK      KEY36,WTENUNIQ,WTENETYP,SAVETDAT,WTENEDAT,SP70
          CALL      RDWTESN1
          BRANCH    OVRCD,CHNSUS30
.
          MATCH     SP70,WTSUTDAT
          IF        @EQUAL
            CALL      DEWTESN1
            GOTO      CHNSUS50
          ENDIF
          MOVE      WTSUTDAT,WTENEVDT
          PACK      WTENWEBU,WBSEUID
          PACK      WTENUDAT,CCC,CYY,CMM,CDD
          REP       " 0",WTENUDAT
          CLOCK     TIME,WTENUTIM
          REP       " 0",WTENUTIM
          CALL      UPWTESN1
          GOTO      CHNSUS50
.
. ----  check if old record is sent, if so delete and write new date ----
.
CHNSUS30  PACK      KEY36,WTWMECNT,ANSR,SAVETDAT,SP70
          CALL      RSWTESN1
          CALL      RKWTESN1
          BRANCH    OVRCD,CHNSUS50
.
          MATCH     WTENUNIQ,WTWMECNT
          GOTO      CHNSUS50 IF NOT EQUAL
.
          MATCH     ANSR,WTENETYP
          GOTO      CHNSUS50 IF NOT EQUAL
.
          MATCH     SAVETDAT,WTENEVDT
          GOTO      CHNSUS50 IF NOT EQUAL
.
          MOVE      WTENEVAL,SAVEEVAL
          MOVE      DELETERC,WTENEVAL
          MOVE      SP70,WTENEDAT
          PACK      WTENWEBC,WBSEUID
          PACK      WTENSADI,SP70
          CALL      IBACLOCK
          PACK      WTENCDAT,CCC,CYY,CMM,CDD
          REP       " 0",WTENCDAT
          CLOCK     TIME,WTENCTIM
          REP       " 0",WTENCTIM
          MOVE      SP70,WTENWEBU
          MOVE      SP70,WTENUDAT
          MOVE      SP70,WTENUTIM
          MOVE      ZERO,WTENMANU
.
. ---- write delete record ----
.
          PACK      KEY36,WTENUNIQ,WTENETYP,WTENEVDT,WTENEDAT,SP70
          CALL      RAWTESN1
          IF        OVRCD=1
            CALL      WRWTESN1
          ENDIF
.
          MATCH     SP70,WTSUTDAT
          GOTO      CHNSUS50 IF EQUAL
. ---- write correct record ----
.
          MOVE      WTSUTDAT,WTENEVDT
          MOVE      SAVEEVAL,WTENEVAL
          MATCH     WTENEVDT,TODAY
          GOTO      CHNSUS50 IF LESS
          PACK      KEY36,WTENUNIQ,WTENETYP,WTENEVDT,WTENEDAT,SP70
          CALL      RAWTESN1
          IF        OVRCD=1
            CALL      WRWTESN1
          ENDIF
          GOTO      CHNSUS50
. 
CHNSUS50  IF        CHGSUSV=0
            GOTO      CHNSUS99
          ENDIF     
          CALL      UPESUS00
.
CHNSUS99  RETURN
+
DELSS000  CALL      DELES000
          MATCH     WMDATE1,WTSUFDAT
          GOTO      DELSS099 IF NOT EQUAL
.         
          PACK      KEY5,ANSV,ANSL,SP70
          CALL      RDSCODE1
DELSS070  CALL      RDKCODE1
          BRANCH    OVRCD,DELSS099
.
          MATCH     "VL",TCODE
          GOTO      DELSS099 IF NOT EQUAL
.
          MATCH     "A",PTCOACTV          * Only want active codes
          GOTO      DELSS070 IF NOT EQUAL
.
          MATCH     "R",TCINDC1           * Must have indicator 1 = "R"
          GOTO      DELSS070 IF NOT EQUAL
.
          MOVE      ACODE,WTTXPLST
          MOVE      WMDATE1,WTENEVDT
          CALL      WRED0000
.
DELSS099  RETURN
.------------------------------------------------------------
. Update ESIS suspension reason
.------------------------------------------------------------
UPESUS00  MATCH     WTSUFDAT,CURDATE
          GOTO      UPESUS99 IF LESS
.
. ----  check if old record is unsent, if so update with new date ----
.
          PACK      KEY36,WTENUNIQ,WTENETYP,WTSUFDAT,WTENEDAT,SP70
          CALL      RDWTESN1
          BRANCH    OVRCD,UPESUS10
.
          PACK      WTENWEBU,WBSEUID
          MOVE      WTSUFDAT,WTENEVDT
          MOVE      WTSULSTS,WTENEVAL
          PACK      WTENUDAT,CCC,CYY,CMM,CDD
          REP       " 0",WTENUDAT
          CLOCK     TIME,WTENUTIM
          REP       " 0",WTENUTIM
          CALL      UPWTESN1
          GOTO      UPESUS99
.
.
. ----  check if old record is sent, if so delete and write new date ----
.
UPESUS10  PACK      KEY36,WTWMECNT,ANSR,WTSUFDAT,SP70
          CALL      RSWTESN1
          CALL      RKWTESN1
          BRANCH    OVRCD,UPESUS99
.
          MATCH     WTENUNIQ,WTWMECNT
          GOTO      UPESUS99 IF NOT EQUAL
.
          MATCH     ANSR,WTENETYP
          GOTO      UPESUS99 IF NOT EQUAL
.
          MATCH     WTSUFDAT,WTENEVDT
          GOTO      UPESUS99 IF NOT EQUAL
.
          MOVE      DELETERC,WTENEVAL
          MOVE      SP70,WTENEDAT
          PACK      WTENWEBC,WBSEUID
          PACK      WTENSADI,SP70
          CALL      IBACLOCK
          PACK      WTENCDAT,CCC,CYY,CMM,CDD
          REP       " 0",WTENCDAT
          CLOCK     TIME,WTENCTIM
          REP       " 0",WTENCTIM
          MOVE      SP70,WTENWEBU
          MOVE      SP70,WTENUDAT
          MOVE      SP70,WTENUTIM
          MOVE      ZERO,WTENMANU
.
. ---- write delete record ----
.
          PACK      KEY36,WTENUNIQ,WTENETYP,WTENEVDT,WTENEDAT,SP70
          CALL      RAWTESN1
          IF        OVRCD=1
.....       CALL      WRWTESN1   * commented out for CAR 204325
          ENDIF
.
. ---- write correct record ----
.
          MOVE      WTSUFDAT,WTENEVDT
          MOVE      WTSULSTS,WTENEVAL
          MATCH     WTENEVDT,TODAY
          GOTO      UPESUS99 IF LESS
          PACK      KEY36,WTENUNIQ,WTENETYP,WTENEVDT,WTENEDAT,SP70
          CALL      RAWTESN1
          IF        OVRCD=1
            CALL      WRWTESN1
          ENDIF
.
UPESUS99  RETURN
+
.------------------------------------------------------------
. Update Suspension
.------------------------------------------------------------
UPDSUS00  MOVE      SUSPKEYS,KEY19
          CALL      RDTREA1                            * was RLWTTRE1  *C-60140
          BRANCH    OVRCD,UPDSUS90,UPDSUS91
.
          MOVE      WMURNO,URNUMBER
          MOVE      SUSPKEYS,KEY21
          CALL      RDWTSUS1
          BRANCH    OVRCD,UPDSUS90
          MOVE      WTSUFDAT,SAVEFDAT
          MOVE      WTSUTDAT,SAVETDAT
.                                           * Hps Code Starts Here 
          CALL      MVSUS000                * Move cgi values to File Variables 
.
          PACK      KEY19,SUSPKEYS,SP70
          CALL      RDWTTX11
          BRANCH    OVRCD,UPDSUS05
          PACK      SAVLIST,WTTXPLST
.
          PACK      DATEC,CCC,CYY,CMM,CDD      * HPSI
          REP       " 0",DATEC
          MOVE      DATEC,DATE1
          MOVE      DATEC,DATECF
          MOVE      WTSUFDAT,DATE2
          MATCH     SP70,WTSUTDAT
          IF        !@EQUAL
            MOVE      WTSUTDAT,DATE3
          ELSE
            MOVE      DATEC,DATE3
            ADD       ONE,DATE3
          ENDIF
.
          IF        DATE1>=DATE2 & DATE1<DATE3
            MATCH     WTSULSTS,WTTXPLST
            IF        !@EQUAL
              MOVE      WTSULSTS,WTTXPLST
              CALL      UPWTTX11                * Write a Record in wattx1af
            ENDIF
          ELSE
            IF        DATE1>=DATE3
              CALL      ADDTPR00
            ENDIF
            CALL      FNDRFC00
            CALL      UPWTTX11
          ENDIF
.
.--------Check the Suspension FromDate is Less than the Date on List ----
.          
UPDSUS05  MOVE      WMDATE1,DATE2
          MOVE      WTSUFDAT,DATE1         
          IF        DATE1 < DATE2
.           CALL      UUWTTRE1
            GOTO      UPDSUS93
          ENDIF
          MOVE      ZERO,DATE2
          MOVE      WTSUTDAT,DATE2
.
.---------loop through the watsusaf and check the patient is already ------
.---------suspended or not-------------------------------------------------
.          
          MOVE      SP70,SUSPNCNT
          UNPACK    SUSPKEYS,WTSUURNO,WTSUCODE,KEY2,SUSPNCNT,DIM127
          MOVE      KEY2,WTSUCNT
          PACK      KEY21,WTSUURNO,WTSUCODE,WTSUCNT,SP70
          CALL      RSWTSUS1
UPDSUS10  CALL      RKWTSUS1
          BRANCH    OVRCD,UPDSUS20
.
          MATCH     WMURNO,WTSUURNO
          GOTO      UPDSUS20 IF NOT EQUAL       * Exit if URNo does'nt match
          MATCH     WMCODE,WTSUCODE
          GOTO      UPDSUS20 IF NOT EQUAL       * Exit Proc-code Does'nt match
          COMPARE   WMCNT,WTSUCNT
          GOTO      UPDSUS20 IF NOT EQUAL       * Exit proc-count does'nt match 
.
          MOVE      ZERO,FORM2
          MOVE      SUSPNCNT,FORM2
          COMPARE   FORM2,WTSUSCNT
          GOTO      UPDSUS10 IF EQUAL
.
.         MATCH     SAVEFDAT,WTSUFDAT
.         GOTO      UPDSUS10 IF EQUAL
.
          MOVE      ZERO,DATE3
          MOVE      ZERO,DATE4
          MOVE      WTSUFDAT,DATE3
          MOVE      WTSUTDAT,DATE4
          COMPARE   ZERO,DATE4
          IF        @EQUAL
            MOVE      DATECF,DATE4
            ADD       ONE,DATE4
          ENDIF  
. 
.--------case when the ToDate is not entered ------------------------
. 
          COMPARE   ZERO,DATE2
          IF        @EQUAL
            IF        DATE1 >= DATE3 & DATE1 < DATE4 
              GOTO      UPDSUS92
            ENDIF
            IF        DATE1 >= DATE3 & DATE4 = 0
              GOTO      UPDSUS92
            ENDIF
            IF        DATE1 <= DATE3
              GOTO      UPDSUS92
            ENDIF
            GOTO      UPDSUS10
          ENDIF
. 
.--------case when the Fromdate and Todate are Entered----------------
.
UPDSUS11  IF        DATE3 < DATE1 & DATE4 > DATE1 & DATE4 <> 0
           GOTO      UPDSUS92
          ENDIF  
          IF        DATE3 <= DATE2 & DATE4 >= DATE2 & DATE4 <> 0
            GOTO      UPDSUS92
          ENDIF
          IF        DATE1 < DATE3 & DATE2 > DATE4 & DATE4 <> 0
            GOTO      UPDSUS92
          ENDIF
          IF        DATE1 > DATE3 & DATE4 = 0
            GOTO      UPDSUS92
          ENDIF
          IF        DATECF > DATE3 & DATECF < DATE4
            MOVE      WTSULSTS,WTTXPLST
            CALL      UPWTTX11                * Write a Record in wattx1af
          ENDIF
          GOTO        UPDSUS10
.-------------------------------------------------------------------------
UPDSUS20  MOVE      SUSPKEYS,KEY21
          CALL      RDWTSUS1
          BRANCH    OVRCD,UPDSUS90
.
          PACK      OLDVAL01,WTSUFDAT,WTSUTDAT,WTSULSTS,SP70                   
          PACK      OLDVAL15,WTSUFDAT,WTSUTDAT,WTSULSTS,WTSUREAS,SP70
.
          PACK      SAVELSTS,WTSULSTS
          CALL      MVSUS000
          CALL      UPWTSUS1
          CALL      WESUS000
          MATCH     SAVELSTS,WTSULSTS
          IF        !@EQUAL
            MOVE      ONE,CHGSUSV
            CALL      CHNSUS00
            MOVE      ZERO,CHGSUSV
          ENDIF
.
          PACK      WTCHUPTY,TWO,THREE,SP70
          CALL      WRCS0000
          CALL      UUWTTRE1
.   
          CALL      WRCOM000           * Write Comments 
          CALL      WRCHF000           * Update suspension data integrity audit
.   
          MOVE      ZERO,EXIT
          GOTO      UPDSUS99
.
UPDSUS90  MOVE      "Invalid Suspension Key.",WEBTITLE
          CALL      WEBERR00
          GOTO      UPDSUS99
.
UPDSUS91  MOVE      "Waiting List Record Locked.",WEBTITLE
          CALL      WEBERR00
          GOTO      UPDSUS99
.
UPDSUS92  MOVE      "Patient is Already Suspended.",WEBTITLE
          CALL      WEBERR00
          GOTO      UPDSUS99
.
UPDSUS93  MOVE      "Suspension Prior to Date on List.",WEBTITLE
          CALL      WEBERR00
          GOTO      UPDSUS99
UPDSUS99  CALL      UUWTTRE1           * Unlock Treatment File 
.                                      * Hps Code Ends Here 
          RETURN
.------------------------------------------------------------
. Delete Suspension 
.------------------------------------------------------------
DELSUS00  MOVE      SUSPKEYS,KEY19
          CALL      RDTREA1
          BRANCH    OVRCD,DELSUS90
          MOVE      WMURNO,URNUMBER
          MOVE      SUSPKEYS,KEY21
          CALL      RDWTSUS1
          BRANCH    OVRCD,DELSUS90
.
          PACK      OLDVAL01,WTSUFDAT,WTSUTDAT,WTSULSTS,SP70                   
.
          CALL      DEWTSUS1
.
          CALL      WRCHG000           * Delete suspension data integrity audit
.
          CALL      IBACLOCK
          PACK      TODAYDTE,CCC,CYY,CMM,CDD
          REP       " 0",TODAYDTE
          MATCH     WTSUFDAT,TODAYDTE
          GOTO      DELSUS50 IF LESS
.
          MATCH     SP10,WTSUTDAT
          GOTO      DELSUS10 IF EQUAL                                  *I-87726
.
          MATCH     WTSUTDAT,TODAYDTE
          GOTO      DELSUS50 IF NOT LESS
.
.******************************************** Start of Addition        *I-60140
DELSUS10  PACK      KEY19,SUSPKEYS,SP70
          CALL      RDWTTX11
          BRANCH    OVRCD,DELSUS80
.                                           * find a "Ready for Care" code
          PACK      KEY5,ANSV,ANSL,SP70
          CALL      RDSCODE1
DELSUS20  CALL      RDKCODE1
          BRANCH    OVRCD,DELSUS80
.
          MATCH     "VL",TCODE
          GOTO      DELSUS80 IF NOT EQUAL
.
          MATCH     "A",PTCOACTV          * Only want active codes
          GOTO      DELSUS20 IF NOT EQUAL
.
          MATCH     "R",TCINDC1           * Must have indicator 1 = "R"
          GOTO      DELSUS20 IF NOT EQUAL
.
          MOVE      ACODE,WTTXPLST
          CALL      UPWTTX11
.
DELSUS50  CALL      DELES000
          MATCH     WMDATE1,WTSUFDAT
          GOTO      DELSUS80 IF NOT EQUAL
.
          PACK      KEY5,ANSV,ANSL,SP70
          CALL      RDSCODE1
DELSUS70  CALL      RDKCODE1
          BRANCH    OVRCD,DELSUS80
.
          MATCH     "VL",TCODE
          GOTO      DELSUS80 IF NOT EQUAL
.
          MATCH     "A",PTCOACTV          * Only want active codes
          GOTO      DELSUS70 IF NOT EQUAL
.
          MATCH     "R",TCINDC1           * Must have indicator 1 = "R"
          GOTO      DELSUS70 IF NOT EQUAL
.
          MOVE      ACODE,WTTXPLST
          MOVE      WMDATE1,WTENEVDT
          CALL      WRED0000
.
DELSUS80  MOVE      ZERO,EXIT
.********************************************   End of Addition        *I-60140
...        CALL      WINCLS00
          MOVE      ZERO,EXIT
          GOTO      DELSUS99
.
DELSUS90  MOVE      "Invalid Deletion Key",WEBTITLE
          CALL      WEBERR00
.
DELSUS99  RETURN
.
.******************************************** Start of Addition        *I-60140
.------------------------------------------------------------
. Update ESIS for Deleted Suspension
.------------------------------------------------------------
DELES000  COMPARE   THREE,PTCNHDPS
          GOTO      DELES999 IF NOT EQUAL   * Not in Victoria
          MOVE      ZERO,DONEFLAG
.
          PACK      SAVKEY18,WTWMECNT,ANSR,WTSUFDAT,SP70
DELES050  PACK      KEY36,WTWMECNT,ANSR,SP70
          CALL      RSWTESN1
DELES100  CALL      RKWTESN1
          BRANCH    OVRCD,DELES999
.
          PACK      KEY18,WTENUNIQ,WTENETYP,WTENEVDT,SP70
          MATCH     KEY18,SAVKEY18
          GOTO      DELES999 IF LESS
          GOTO      DELES100 IF NOT EQUAL
.
DELES200  CALL      IBACLOCK
          PACK      WTENUDAT,CCC,CYY,CMM,CDD
          REP       " 0",WTENUDAT
          CLOCK     TIME,WTENUTIM
          REP       " 0",WTENUTIM
          MOVE      USERID,WTENWEBU
          MOVE      ZERO,WTENMANU
.
          MATCH     SP20,WTENEDAT           * has it been sent to HD?
          IF        @EQUAL
            PACK      KEY36,WTENUNIQ,WTENETYP,WTENEVDT,WTENEDAT,SP70
            CALL      DEWTESN1
          ELSE
.                                           * already sent to HD
            MOVE      SP8,WTENEDAT          * blank "sent date"
            PACK      KEY36,WTENUNIQ,WTENETYP,WTENEVDT,WTENEDAT,SP70
            CALL      RAWTESN1
            IF        OVRCD = 1
              PACK      WTENEVAL,DELETERC,SP70
              CALL      WRWTESN1
            ENDIF
          ENDIF
          COMPARE   ONE,DONEFLAG
          GOTO      DELES999 IF EQUAL
.
          MOVE      ONE,DONEFLAG
          MATCH     SP70,WTSUTDAT
          IF        !@EQUAL
            PACK      SAVKEY18,WTWMECNT,ANSR,WTSUTDAT,SP70
            GOTO      DELES050
          ENDIF
.
DELES999  RETURN
.********************************************   End of Addition        *I-60140
.
.------------------------------------------------------------
. Process Suspension
.------------------------------------------------------------
WSUS0000  BRANCH    FLDITMNO,WSUS0100,WSUS0200,WSUS0300,WSUS0400,WSUS0500:
                             WSUS0600,WSUS0700,WSUS0800,WSUS0900,WSUS1000:
                             WSUS1100,WSUS1200,WSUS1300,WSUS1400,WSUS1500:
                             WSUS1600,WSUS1700,WSUS1800,WSUS1900
          WRITE     HTMLFILE;"Invalid Tag";
          GOTO      WSUS9999
.
WSUS0100  PACK      KEY21,WTSUURNO,WTSUCODE,WTSUCNT,WTSUSCNT,SP70
          WRITE     HTMLFILE;KEY21;
          GOTO      WSUS9999
.
WSUS0200  CALL      SUSTAB00
          GOTO      WSUS9999
.
WSUS0300  MATCH     SP70,WTSUFDAT
          GOTO      WSUS9999 IF EQUAL
          UNPACK    WTSUFDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      WSUS9999
.
WSUS0400  MATCH     SP70,WTSUTDAT
          GOTO      WSUS9999 IF EQUAL
          MOVE      ZERO,F2
          MOVE      SP70,MTHNAM3
          MOVE      ZERO,CCENT
          MOVE      ZERO,CYEAR
          MOVE      ZERO,CMON
          MOVE      ZERO,CDAY
          UNPACK    WTSUTDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      WSUS9999
.
WSUS0500  MOVE      "WN",CATEGORY
          MOVE      WTSUREAS,CODE
          CALL      CODITM00
          GOTO      WSUS9999
.
WSUS0600  MOVE      "W4",CATEGORY
          MOVE      WTSULSTS,CODE
          MATCH     SP70,WTSULSTS
          IF        @EQUAL
            MOVE      WMUDEF4,WTSULSTS
          ENDIF
          CALL      CODITM00
          GOTO      WSUS9999
.
WSUS0700  WRITE     HTMLFILE;WTSUAUTO;
          GOTO      WSUS9999
.
WSUS0800  WRITE     HTMLFILE;WTSUUSER
          GOTO      WSUS9999
.
WSUS0900  WRITE     HTMLFILE;WATEXT;
          GOTO      WSUS9999
.
WSUS1000  PACK      KEY21,WMURNO,WMCODE,WMCNT,Z70
          PACK      KEY19,WMURNO,WMCODE,WMCNT,Z70
          CALL      RSWTSUS1
WSUS1010  CALL      RPWTSUS1
          BRANCH    OVRCD,WSUS1099
          PACK      KEY21,WTSUURNO,WTSUCODE,WTSUCNT,SP70
          MATCH     KEY19,KEY21
          GOTO      WSUS1099 IF NOT EQUAL
          MATCH     "R",WTTXPLST
          GOTO      WSUS1099 IF EQUAL
          MOVE      "WN",CATEGORY
          MOVE      WTSUREAS,CODE
          CALL      CODITM00
          GOTO      WSUS9999          
.
WSUS1099  UNPACK    DIM127,KEY2,DIM127
          GOTO      WSUS9999          
.
WSUS1100  MATCH     "R",WTTXPLST
          IF        @EQUAL
            MATCH     SP70,WTSUTDAT
            GOTO      WSUS9999 IF EQUAL
            MOVE      ZERO,F2
            MOVE      SP70,MTHNAM3
            MOVE      ZERO,CCENT
            MOVE      ZERO,CYEAR
            MOVE      ZERO,CMON
            MOVE      ZERO,CDAY
            UNPACK    WTSUTDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          ELSE
            WRITE     HTMLFILE;SP1;
          ENDIF
          GOTO      WSUS9999
.
WSUS1200  MOVE      WMDATE1,SAVDATE8
          PACK      KEY21,WMURNO,WMCODE,WMCNT,Z70
          PACK      KEY19,WMURNO,WMCODE,WMCNT,Z70
          CALL      RSWTSUS1
WSUS1210  CALL      RPWTSUS1
          BRANCH    OVRCD,WSUS1290
.
          PACK      KEY21,WTSUURNO,WTSUCODE,WTSUCNT,SP70
          MATCH     KEY19,KEY21
          GOTO      WSUS1290 IF NOT EQUAL
.
          MATCH     SP70,WTSUTDAT          * no ready for care date SRF 18400
          GOTO      WSUS9999 IF EQUAL
.
          MATCH     WTSUTDAT,SAVDATE8
          GOTO      WSUS1210 IF NOT LESS
.
          MOVE      WTSUTDAT,SAVDATE8
          GOTO      WSUS1210
.
WSUS1290  UNPACK    SAVDATE8,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      WSUS9999
.
WSUS1300  PACK      KEY21,WMURNO,WMCODE,WMCNT,Z70   * Display for RFC date
          PACK      KEY19,WMURNO,WMCODE,WMCNT,Z70   * Only display if in future
          CALL      RSWTSUS1
WSUS1310  CALL      RPWTSUS1
          BRANCH    OVRCD,WSUS9999
.
          PACK      KEY21,WTSUURNO,WTSUCODE,WTSUCNT,SP70
          MATCH     KEY19,KEY21
          GOTO      WSUS9999 IF NOT EQUAL
.
          MATCH     SP70,WTSUTDAT
          GOTO      WSUS9999 IF EQUAL
.
          CALL      IBACLOCK
          PACK      TODAYDTE,CCC,CYY,CMM,CDD
          REP       " 0",TODAYDTE
          MATCH     WTSUTDAT,TODAYDTE
          GOTO      WSUS9999 IF NOT LESS
.
          UNPACK    WTSUTDAT,CCENT,CYEAR,CMON,CDAY
          GOTO      WSUS1391
.
WSUS1391  MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      WSUS9999
.
WSUS1400  CALL      CHKSTS00
          WRITE     HTMLFILE;EXIT;
          GOTO      WSUS9999
.
WSUS1500  CALL      NEWOVR00         * new calculation for overdue date
          MATCH     SP70,OVERDATE
          GOTO      WSUS9999 IF EQUAL
.
          UNPACK    OVERDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          GOTO      WSUS9999
.
WSUS1600  CALL      NEWRFC00
          GOTO      WSUS9999
.
WSUS1700  MOVE      SP70,KEY3
          UNPACK    DIM127,D1,KEY3,DIM127        * Get comment type
.
          MOVE      CASEKEYS,DIM19
          PACK      KEY28,DIM19,NOTETYPE,SP70
          CALL      RSWTMHD1
WSUS1710  CALL      RKWTMHD1
          BRANCH    OVRCD,WSUS9999
.
          PACK      KEY19,WTMHURNO,WTMHPROC,WTMHPCNT,SP70
          MATCH     CASEKEYS,KEY19
          GOTO      WSUS9999 IF NOT EQUAL
.
          MATCH     "1",WTMHDELT            * Deleted
          GOTO      WSUS1710 IF EQUAL
.
          WRITE     HTMLFILE;ONE;           * Yes comments available
          GOTO      WSUS9999
.
WSUS1800  WRITE     HTMLFILE;BATCHNUM;
          GOTO      WSUS9999
.
WSUS1900  PACK      KEY29,WMURNO,WMCODE,WMCNT,ANST,ANSP,Z70
          CALL      RSWTCAT2                * Position on & read code changes
WSUS1910  CALL      RPWTCAT2                  file record
          BRANCH    OVRCD,WSUS9999
.
          MATCH     WMURNO,WTCAURNO
          GOTO      WSUS9999 IF NOT EQUAL   * Different U/R no
.
          MATCH     WMCODE,WTCAPROC
          GOTO      WSUS9999 IF NOT EQUAL   * Different procedure code
.
          COMPARE   WMCNT,WTCAPCNT
          GOTO      WSUS9999 IF NOT EQUAL   * Different procedure count
.
          MATCH     "TP",WTCACATF
          GOTO      WSUS9999 IF NOT EQUAL   * Different category
.
          MATCH     SP70,WTCAEDAT
          GOTO      WSUS9999 IF EQUAL
          UNPACK    WTCAEDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      WSUS9999
.
WSUS9999  RETURN
+
.-----------------------------------------------------------------------------
. CHKSTS00 - Check waiting list suspension status
.-----------------------------------------------------------------------------
CHKSTS00  MOVE      ZERO,EXIT
          CALL      IBACLOCK
          PACK      D8,CCC,CYY,CMM,CDD
          REP       " 0",D8
          MOVE      D8,DATE1
.
          PACK      KEY21,WMURNO,WMCODE,WMCNT,SP70
          CALL      RSWTSUS1
CHKSTS10  CALL      RKWTSUS1
          BRANCH    OVRCD,CHKSTS99
.
          MATCH     WMURNO,WTSUURNO
          GOTO      CHKSTS99 IF NOT EQUAL
.
          MATCH     WMCODE,WTSUCODE
          GOTO      CHKSTS99 IF NOT EQUAL
.
          COMPARE   WMCNT,WTSUCNT
          GOTO      CHKSTS99 IF NOT EQUAL
.
          MOVE      SP70,TCINDC4
          MOVE      "VL",CATEGORY
          MOVE      WTSULSTS,CODE
          PACK      KEY5,ANSV,ANSL,WTSULSTS,SP70
          CALL      RDCODE1
.
          MATCH     ANSR,TCINDC1                 * Ignore if RFC Suspension
          GOTO      CHKSTS10 IF EQUAL
.
          MOVE      ZERO,DATE2
          MOVE      ZERO,DATE3
          MOVE      WTSUFDAT,DATE2
          MOVE      WTSUTDAT,DATE3
.
          IF        DATE1 >= DATE2
            COMPARE   ZERO,DATE3
            GOTO      CHKSTS90 IF EQUAL
          ENDIF
.
          IF        DATE1 >= DATE2 & DATE1 < DATE3
            GOTO      CHKSTS90
          ENDIF
.
          IF        PTCNHDPS=1
            COMPARE   ZERO,DATE2
            GOTO      CHKSTS10 IF EQUAL
            IF        DATE1 <= DATE2
              GOTO      CHKSTS90
            ENDIF
          ENDIF
.
          GOTO      CHKSTS10
.
CHKSTS90  MOVE      ONE,EXIT
          GOTO      CHKSTS99

CHKSTS99  RETURN
.
.------------------------------------------------------------
. New overdue date calculation
.------------------------------------------------------------
NEWOVR00  MOVE      ZERO,OVERSTAT
          READ      CONTROLF,HUND11;*11,WTCNERFC
          MOVE      "TP",CATEGORY
          MOVE      WMPTY,CODE
          CALL      GETCOD00
          CALL      GTPC0000
          MOVE      CLURCTDT,OVERDATE
          MOVE      CLURCTDT,PRIODATE
.
          IF        CATCHGFL=0
            MATCH     "1",WTCNERFC
            IF        @EQUAL
              MOVE      WMKEYDT,OVERDATE   * no urgency change, use date on list
              MOVE      WMKEYDT,CLURCTDT
              MOVE      WMKEYDT,PRIODATE   * no urgency change, use date on list
            ELSE
              MOVE      WMDATE1,OVERDATE   * no urgency change, use date on list
              MOVE      WMDATE1,CLURCTDT
              MOVE      WMDATE1,PRIODATE   * no urgency change, use date on list
            ENDIF
          ENDIF
.
          PACK      KEY5,ANST,ANSP,WMPTY,SP70
          CALL      RDCODE1
          ADD       TCFORM6,PRIODATE
          READ      CONTROLF,THIRTY7;*173,WTCNURDY,*177,WTCNSUDY:
                                     *181,WTCNRODY
          MATCH     "U",TCINDC1
          IF        @EQUAL
            ADD       WTCNURDY,OVERDATE
          ENDIF
.
          MATCH     "S",TCINDC1
          IF        @EQUAL
            ADD       WTCNSUDY,OVERDATE
          ENDIF
.
          MATCH     "R",TCINDC1
          IF        @EQUAL
            ADD       WTCNRODY,OVERDATE
          ENDIF
.
          CALL      ADSU0000      * add suspensions within overdue date
          CALL      ADPU0000      * add suspensions within priority overdue date
.
          MATCH     SP70,PRIODATE
          GOTO      NEWOVR99 IF EQUAL
.
          PACK      TODAY,CCC,CYY,CMM,CDD
          REP       " 0",TODAY
          MATCH     TODAY,PRIODATE
          IF        @LESS
            MOVE      ONE,OVERSTAT
          ENDIF
.
NEWOVR99  RETURN
+
.------------------------------------------------------------
. New RFC date calculation
.------------------------------------------------------------
NEWRFC00  MOVE      WMDATE1,SAVDATE8
          PACK      TODAY,CCC,CYY,CMM,CDD
          REP       " 0",TODAY
          PACK      KEY29,WMURNO,WMCODE,WMCNT,TODAY,Z70
          PACK      KEY19,WMURNO,WMCODE,WMCNT,Z70
          CALL      RSWTSUS2
NEWRFC10  CALL      RPWTSUS2
          BRANCH    OVRCD,NEWRFC90
.
          PACK      KEY21,WTSUURNO,WTSUCODE,WTSUCNT,SP70
          MATCH     KEY19,KEY21
          GOTO      NEWRFC90 IF NOT EQUAL
.
          MATCH     SP70,WTSUTDAT          * no ready for care date SRF 18400
          GOTO      NEWRFC99 IF EQUAL
.
          MOVE      WTSUTDAT,SAVDATE8
.
NEWRFC90  UNPACK    SAVDATE8,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      NEWRFC99
.
NEWRFC99  RETURN
.------------------------------------------------------------
. Add suspensions within overdue date
.------------------------------------------------------------
ADSU0000  PACK      CASEKEYS,WMURNO,WMCODE,WMCNT,SP70
          PACK      KEY29,WMURNO,WMCODE,WMCNT,SP70
          CALL      RSWTSUS2
ADSU0010  CALL      RKWTSUS2
          BRANCH    OVRCD,ADSU9999
          PACK      KEY19,WTSUURNO,WTSUCODE,WTSUCNT,SP70
          MATCH     KEY19,CASEKEYS
          GOTO      ADSU9999 IF NOT EQUAL
.
          MATCH     WTSUFDAT,OVERDATE
          GOTO      ADSU9999 IF LESS
.
          MATCH     WTSUFDAT,CLURCTDT
          IF        !@LESS
            MOVE       CLURCTDT,WTSUFDAT
            MATCH      WTSUTDAT,CLURCTDT
            IF         !@LESS
              GOTO       ADSU0010
            ENDIF
          ENDIF
.
          MATCH     SP70,WTSUTDAT
          IF        @EQUAL
            MOVE      SP70,OVERDATE
            GOTO      ADSU9999
          ENDIF
.
          DAYSEP    WTSUFDAT,WTSUTDAT,F6
.
          ADD       F6,OVERDATE
          GOTO      ADSU0010
.
ADSU9999  RETURN
.------------------------------------------------------------
. Add suspensions within priority overdue date
.------------------------------------------------------------
ADPU0000  PACK      CASEKEYS,WMURNO,WMCODE,WMCNT,SP70
          PACK      KEY29,CASEKEYS,SP70
          CALL      RSWTSUS2
ADPU0010  CALL      RKWTSUS2
          BRANCH    OVRCD,ADSU9999
          PACK      KEY19,WTSUURNO,WTSUCODE,WTSUCNT,SP70
          MATCH     KEY19,CASEKEYS
          GOTO      ADPU9999 IF NOT EQUAL
.
          MATCH     WTSUFDAT,PRIODATE
          GOTO      ADPU9999 IF LESS
.
          MATCH     SP70,WTSUTDAT
          IF        @EQUAL
            MOVE      SP70,PRIODATE
            GOTO      ADPU9999
          ENDIF
.
          MATCH     WTSUFDAT,CLURCTDT
          IF        !@LESS
            MOVE       CLURCTDT,WTSUFDAT
            MATCH      WTSUTDAT,CLURCTDT
            IF         !@LESS
              GOTO       ADPU0010
            ENDIF
          ENDIF
.
          DAYSEP    WTSUFDAT,WTSUTDAT,F6
.
          ADD       F6,PRIODATE
          GOTO      ADPU0010
.
ADPU9999  RETURN
.------------------------------------------------------------
. Suspension Dates
.------------------------------------------------------------
SUSTAB00  PACK      KEY21,CASEKEYS,SP70
          CALL      RSWTSUS1
SUSTAB10  CALL      RKWTSUS1
          BRANCH    OVRCD,SUSTAB99
          PACK      KEY19,WTSUURNO,WTSUCODE,WTSUCNT,SP70
          MATCH     KEY19,CASEKEYS
          GOTO      SUSTAB99 IF NOT EQUAL
.
          UNPACK    WTSUFDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY21,WTSUURNO,WTSUCODE,WTSUCNT,WTSUSCNT,SP70
          WRITE     HTMLFILE;"<tr><td>":
                       "<a href='javascript:UpdateSusp(#"",KEY21,"#");'>":
                       "<img src=../images/DocumentIcon.gif ":
                       "border=0 align=absmiddle hspace=4></a>":
                       CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>";
.
          MATCH     SP70,WTSUTDAT
          IF        !@EQUAL
            MOVE      SP70,MTHNAM3
            UNPACK    WTSUTDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      SP70,MTHNAM3
            MOVE      SP70,F2
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            WRITE     HTMLFILE;"<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>";
          ELSE
            WRITE     HTMLFILE;"<td>&nbsp;</td>"
          ENDIF   
.
.          MOVE      "W4",CATEGORY
SUSTAB20  MOVE      "VL",CATEGORY
          MOVE      WTSULSTS,CODE
          CALL      GETCOD00
          WRITE     HTMLFILE;"<td>",TDESC,"&nbsp;</td>";
.
          MOVE      "WN",CATEGORY
          MOVE      WTSUREAS,CODE
          CALL      GETCOD00
          WRITE     HTMLFILE;"<td>",TDESC,"&nbsp;</td></tr>"
.
          GOTO      SUSTAB10
.
SUSTAB99  RETURN
.------------------------------------------------------------
. Move in Waiting List Details
.------------------------------------------------------------
MVSUS000  MATCH     Z70,WATSU001
          IF        !@EQUAL
            UNPACK    WATSU001,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      WTSUFDAT,CCENT,CYEAR,CMON,CDAY
.            REP       " 0",WTSUFDAT 
          ENDIF
          MATCH     Z70,WATSU002
          IF        !@EQUAL
            UNPACK    WATSU002,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      WTSUTDAT,CCENT,CYEAR,CMON,CDAY
.            REP       " 0",WTSUTDAT
          ENDIF

          MATCH     Z70,WATSU003
          IF        !@EQUAL
            MOVE       WATSU003,WTSUREAS
          ENDIF

          MATCH     Z70,WATSU004
          IF        !@EQUAL
            MOVE       WATSU004,WTSULSTS
          ENDIF

          MATCH     Z70,WATSU005
          IF        !@EQUAL
            MOVE       WATSU005,WTSUAUTO
          ELSE
            MOVE       ZERO,WTSUAUTO
          ENDIF

          MATCH     Z70,WATSU006
          IF        !@EQUAL
            MOVE       WATSU006,WTSUUSER 
          ENDIF
.
          RETURN
.------------------------------------------------------------
. Waiting List Extract Details
.------------------------------------------------------------
WATEXT00  CALL      CLWATEXT
          MATCH     SP70,UPDTTYPE      * Display
          GOTO      WATEXT50 IF EQUAL
.
          MATCH     "A",UPDTTYPE       * Add New
          GOTO      WATEXT10 IF EQUAL
.
          MATCH     "U",UPDTTYPE       * Update
          GOTO      WATEXT20 IF EQUAL
.
          MATCH     "D",UPDTTYPE       * Delete
          GOTO      WATEXT30 IF EQUAL
.
          MATCH     "L",UPDTTYPE       * Download File
          IF        @EQUAL
            CALL      WATDWN00 
            GOTO      WATEXT99
          ENDIF
.
          MATCH     "N",UPDTTYPE       * Update Extract Analysis Details
          IF        @EQUAL
            CALL      UPDANA00 
            GOTO      WATEXT99
          ENDIF
.
          MOVE      "Invalid Update Type",WEBTITLE
          CALL      WEBERR00
          GOTO      WATEXT99
.
WATEXT10  CALL      ADDEXT00
          GOTO      WATEXT99
.
WATEXT20  CALL      UPDEXT00
          GOTO      WATEXT99
.
WATEXT30  CALL      DELEXT00
          GOTO      WATEXT99
.
WATEXT50  MOVE      WATEX001,KEY4
          CALL      RDWTEXT1
          IF        OVRCD=1
            CALL      CLWATEXT
          ENDIF
          MOVE      "Waiting List Extract",WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,WATEXT99
          CALL      WEBBOD00
          CALL      WEBEND00
          MOVE      ONE,EXIT
          GOTO      WATEXT99
.
WATEXT95  MOVE      "Invalid Waiting List Patient",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      WATEXT99
.
WATEXT96  MOVE      "Invalid Waiting List Case Key",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      WATEXT99
.
WATEXT97  MOVE      "Invalid Waiting List History Key",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      WATEXT99
.
WATEXT99  RETURN
.---------------------------------------------------------------------------
CLWATEXT  MOVE      SP70,WTEXCODE
          MOVE      SP70,WTEXDESC
          MOVE      SP70,WTEXFLDT
          MOVE      SP70,WTEXTLDT
          MOVE      SP70,WTEXFVDT
          MOVE      SP70,WTEXTVDT
          MOVE      SP70,WTEXFSDT
          MOVE      SP70,WTEXTSDT
          MOVE      SP70,WTEXFRDT
          MOVE      SP70,WTEXTRDT
          MOVE      SP70,WTEXUNT 
          MOVE      SP70,WTEXPRI 
          MOVE      SP70,WTEXNOT 
          MOVE      SP70,WTEXPGP 
          MOVE      SP70,WTEXRMR
          MOVE      SP70,WTEXRGP
          MOVE      SP70,WTEXCON
          MOVE      SP70,WTEXPRO 
          MOVE      SP70,WTEXSRC  
          MOVE      SP70,WTEXUD1 
          MOVE      SP70,WTEXUD2   
          MOVE      SP70,WTEXUD3
          MOVE      SP70,WTEXUD4  
          MOVE      SP70,WTEXUD5   
          MOVE      SP70,WTEXUD6
          MOVE      SP70,WTEXUD7 
          MOVE      SP70,WTEXUD8  
          MOVE      SP70,WTEXSTA  
          MOVE      SP70,WTEXPOWD
          MOVE      SP70,WTEXIDYC
          MOVE      SP70,WTEXLLSC
          MOVE      ZERO,WTEXCRTL
          MOVE      SP70,WTEXADMW
          MOVE      ZERO,WTEXINCD
          MOVE      ZERO,WTEXOVON
          MOVE      SP70,WTEXCTYP
          MOVE      SP70,WTEXLIST
          MOVE      SP70,WTEXSPA   
          MOVE      SP70,WTEXFURN
          MOVE      SP70,WTEXTURN
          MOVE      SP70,WTEXTPRO
          MOVE      SP70,WTEXTPRS
          MOVE      SP70,WTEXTUNI
          MOVE      SP70,WTEXFCON
          MOVE      SP70,WTEXTCON
          MOVE      SP70,WTEXFSES
          MOVE      SP70,WTEXTSES
          MOVE      SP70,WTEXADTY
          MOVE      SP70,WTEXRSTA
          MOVE      SP70,WTEXFPAD
          MOVE      SP70,WTEXTPAD
          MOVE      SP70,WTEXFSYD
          MOVE      SP70,WTEXFSUD
          MOVE      SP70,WTEXTSUD
          MOVE      SP70,WTEXFOSD
          MOVE      SP70,WTEXTOSD
          MOVE      SP70,WTEXFPRO
          MOVE      SP70,WTEXFPRS
          MOVE      SP70,WTEXFUNI
          RETURN
.------------------------------------------------------------
. Add Extract
.------------------------------------------------------------
ADDEXT00  CALL      CLWATEXT
          PACK      KEY4,WATEX001
          CALL      RAWTEXT1
          IF        OVRCD=1 
            CALL      MVEXT000
            CALL      SETANA00      * Set Analysis Levels to SP70
            CALL      WRWTEXT1
            CALL      RUNEXT00      * Schedule Extract
            MOVE      ZERO,EXIT
          ELSE
            MOVE      "Extract Already on File",WEBTITLE
            CALL      WEBERR00
            MOVE      ONE,EXIT
          ENDIF
          RETURN
.------------------------------------------------------------
. Update Extract
.------------------------------------------------------------
UPDEXT00  CALL      CLWATEXT
          PACK      KEY4,WATEX001
          CALL      RAWTEXT1
          IF        OVRCD=0 
            CALL      MVEXT000
            CALL      UPWTEXT1
            CALL      RUNEXT00      * Schedule Extract
            MOVE      ZERO,EXIT
          ELSE
            MOVE      "Extract Not On File",WEBTITLE
            CALL      WEBERR00
            MOVE      ONE,EXIT
          ENDIF
          RETURN
.------------------------------------------------------------
. Update Extract
.------------------------------------------------------------
UPDANA00  PACK      KEY4,WATEX001
          CALL      RLWTEXT1    * Read with lock
          IF        OVRCD=0 
            CALL      MVANA000
            CALL      UPWTEXT1  * Update record 
            CALL      UUWTEXT1  * Unlock record
            CALL      RUNANA00  * Schedule Analysis to RUN 
            MOVE      ZERO,EXIT
          ELSE
            MOVE      "Extract Not On File",WEBTITLE
            CALL      WEBERR00
            MOVE      ONE,EXIT
          ENDIF
.
UPDANA99  RETURN
.------------------------------------------------------------
. Delete Extract
.------------------------------------------------------------
DELEXT00  PACK      KEY4,WATEX001
          CALL      RAWTEXT1
          IF        OVRCD=0 
            CALL      DEWTEXT1
            CALL      RUNDEL00      * Schedule Extract Delete
            CALL      DELANA00      * Deletes Extract Analysis Files
            MOVE      ZERO,EXIT
          ELSE
            MOVE      "Extract Not On File",WEBTITLE
            CALL      WEBERR00
            MOVE      ONE,EXIT
          ENDIF
          RETURN
.
.------------------------------------------------------------
.                       RUNEXT00
.   Schedule Waiting List Extract to be run via Program Scheduler    
.------------------------------------------------------------
RUNEXT00  MOVE      "IBAWAT53",SCHDPGID
          MOVE      "Waiting List Extraction",SCHDDESC
          PACK      SCHDDATE,CCC,CYY,CMM,CDD
          REP       " 0",SCHDDATE
          CLOCK     TIME,SCHDTIME
.
.         Write Keyin parameters for Extract
.
          MOVE      ONE,KEYSTARR[1]          * Option
          MOVE      WATEX001,KEYSTARR[2]     * Extract ID
          MOVE      TWO,KEYSTCNT             * Number of Keyins 
.
          CALL      SCHPRO00   * Schedule Extract
.
RUNEXT99  RETURN
.------------------------------------------------------------
.                       RUNDEL00
.   Schedule Waiting List Extract Delete to be run via Program Scheduler    
.------------------------------------------------------------
RUNDEL00  MOVE      "IBAWAT53",SCHDPGID
          MOVE      "Delete Waiting List Extract",SCHDDESC
          PACK      SCHDDATE,CCC,CYY,CMM,CDD
          REP       " 0",SCHDDATE
          CLOCK     TIME,SCHDTIME
.
.         Write Keyin parameters for Extract
.
          MOVE      TWO,KEYSTARR[1]          * Option
          MOVE      WATEX001,KEYSTARR[2]     * Extract ID
          MOVE      TWO,KEYSTCNT             * Number of Keyins
.
          CALL      SCHPRO00   * Schedule Extract 
.
RUNDEL99  RETURN
.------------------------------------------------------------
.                           RUNANA00
.   Schedule Waiting List Analysis to generate - run via Program Scheduler    
.------------------------------------------------------------
RUNANA00  MOVE      "IBAWAT53",SCHDPGID
          MOVE      "Generate Waiting List Analysis Extract",SCHDDESC
          PACK      SCHDDATE,CCC,CYY,CMM,CDD
          REP       " 0",SCHDDATE
          CLOCK     TIME,SCHDTIME
.
.         Write Keyin parameters for Extract
.
          MOVE      FOUR,KEYSTARR[1]         * Option
          MOVE      WATEX001,KEYSTARR[2]     * Extract ID
          MOVE      TWO,KEYSTCNT             * Number of Keyins
.
          CALL      SCHPRO00   * Schedule Extract 
.
RUNANA99  RETURN
.------------------------------------------------------------
.                       DELANA00
.   Delete Waiting List Analysis Files    
.------------------------------------------------------------
DELANA00  CLEAR     FILENAMA          * Delete Extract Analysis Level File A
          APPEND    "wtxa",FILENAMA
          APPEND    WATEX001,FILENAMA
          RESET     FILENAMA
          MOVE      ZERO,OVRCD            * Trap IO if Open Fails
          TRAP      OVERCOND IF IO
          OPEN      WATEXAA1,FILENAMA
          TRAPCLR   IO                    * If File does exist then delete it
          IF        OVRCD=0
            CLOSE     WATEXAA1,DELETE
          ENDIF
.
          CLEAR     FILENAMA          * Delete Extract Analysis Level File B
          APPEND    "wtxb",FILENAMA
          APPEND    WATEX001,FILENAMA
          RESET     FILENAMA
          MOVE      ZERO,OVRCD            * Trap IO if Open Fails
          TRAP      OVERCOND IF IO
          OPEN      WATEXBA1,FILENAMA
          TRAPCLR   IO                    * If File does exist then delete it
          IF        OVRCD=0
            CLOSE     WATEXBA1,DELETE
          ENDIF
.
          CLEAR     FILENAMA          * Delete Extract Analysis Level File C
          APPEND    "wtxc",FILENAMA
          APPEND    WATEX001,FILENAMA
          RESET     FILENAMA
          MOVE      ZERO,OVRCD            * Trap IO if Open Fails
          TRAP      OVERCOND IF IO
          OPEN      WATEXCA1,FILENAMA
          TRAPCLR   IO                    * If File does exist then delete it
          IF        OVRCD=0
            CLOSE     WATEXCA1,DELETE
          ENDIF
.
          CLEAR     FILENAMA          * Delete Extract Analysis Level File D
          APPEND    "wtxd",FILENAMA
          APPEND    WATEX001,FILENAMA
          RESET     FILENAMA
          MOVE      ZERO,OVRCD            * Trap IO if Open Fails
          TRAP      OVERCOND IF IO
          OPEN      WATEXDA1,FILENAMA
          TRAPCLR   IO                    * If File does exist then delete it
          IF        OVRCD=0
            CLOSE     WATEXDA1,DELETE
          ENDIF
.
DELANA99  RETURN
.------------------------------------------------------------
. Report No. 8 : Waiting List Patient Extract Table
.----------------------------------------------------------------------------
WATP0000  BRANCH    FLDITMNO,WATP0100,WATP0200,WATP0300,WATP0400,WATP0500:
                             WATP0600,WATP0700,WATP0800,WATP0900
.
          WRITE     HTMLFILE;"Invalid Tag";
          GOTO      WATP9999
.
WATP0100  WRITE     HTMLFILE;WTEPEID;   * Extract ID
          GOTO      WATP9999
.
WATP0200  WRITE     HTMLFILE;WTEPURN;   * U/R
          GOTO      WATP9999
.
WATP0300  WRITE     HTMLFILE;WTEPPRO;   * Procedure 
          GOTO      WATP9999
.
WATP0400  WRITE     HTMLFILE;WTEPCNT;   * Count 
          GOTO      WATP9999
.
WATP0500  WRITE     HTMLFILE;WTEPDEL;   * Deleted from Extract 0=No
          GOTO      WATP9999
.
WATP0600  CALL      WATEX000     * List of of Patient Extracts by Extract
          GOTO      WATP9999
.
WATP0700  CALL      NEXTEP00     * Next List of Extracts
          GOTO      WATP9999
.
WATP0800  CALL      PREVEP00     * Prev List of Extracts
          GOTO      WATP9999
.
WATP0900  CALL      CNTP0000
          GOTO      WATP9999
.
WATP9999  RETURN
.
.-----------------------------------------------------------
. CNTP0000 - count number of patient in extract 
.-----------------------------------------------------------
CNTP0000  MOVE      ZERO,FORM3
.
          PACK      KEY23,WATEP001,SP70  * set position on record
          CALL      RSWTEPS1
CNTP1000  CALL      RKWTEPS1            * read next record
          BRANCH    OVRCD,CNTP2000      * record end
.
          MATCH     WTEPEID,WATEP001        * extract id same?
          GOTO      CNTP2000 IF NOT EQUAL

          ADD       ONE,FORM3
          GOTO      CNTP1000
.
CNTP2000  WRITE     HTMLFILE;FORM3;
.
          IF        FORM3>1
            WRITE     HTMLFILE;" Records";
          ELSE
            WRITE     HTMLFILE;" Record";
          ENDIF
. 
          GOTO      CNTP9999
.
CNTP9999  RETURN
+
.-----------------------------------------------------------
. Link to Next Group
.-----------------------------------------------------------
NEXTEP00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
          REP       " +",WTEXCODE
.
          WRITE     HTMLFILE;"watweb01.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&watep001=",WTEXCODE;
.
          REP       "+ ",WTEXCODE
.
NEXTEP99  RETURN
.-------------------------------------------------------------
. Link to Prev Group
.-------------------------------------------------------------
PREVEP00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM-NORECORD,F3
          IF        F3<0
            MOVE      ZERO,F3
          ENDIF
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
          REP       " +",WTEXCODE
.
          WRITE     HTMLFILE;"watweb01.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&watep001=",WTEXCODE;
.
          REP       "+ ",WTEXCODE
.
PREVEP99  RETURN
.------------------------------------------------------------
. Table Waiting List Patient Extract Tables
.------------------------------------------------------------
WATEX000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          CALL      WATHD000   * Output Table Heading
.
          IF        NORECORD=0
            MOVE      "14",NORECORD       * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          PACK      KEY23,WATEP001,SP70
          CALL      RSWTEPS1
WATEX100  CALL      RKWTEPS1
          BRANCH    OVRCD,WATEX999
.
          MATCH     WATEP001,WTEPEID       * Extract ID
          GOTO      WATEX999 IF NOT EQUAL
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      WATEX100
          ENDIF
.
          CALL      WATRW000       * Table Row
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      WATEX100 IF NOT EQUAL
.
WATEX999  RETURN
.---------------------------------------------------------------------
.  Table Waiting List Patient Extract Tables (TABLE HEADING)
.---------------------------------------------------------------------
WATHD000  WRITE     HTMLFILE;"<tr>":
                              "<td class=HeadingCell>Patient</td>":
                              "<td class=HeadingCell width=52%>Procedure</td>":
                              "<td class=HeadingCell width=10%>Date on List":
                              "</td>":
                              "<td class=HeadingCell width=8%>Deleted</td>":
                             "</tr>"
WATHD999  RETURN
.---------------------------------------------------------------------
.   Ward Table Maintenance (TABLE ROW)
.---------------------------------------------------------------------
WATRW000  PACK      KEY8,WTEPURN     * Setup Patient Formatted name
          CALL      RDMAST1 
          IF        OVRCD=1
            MOVE      "Invalid U/R",PATFNAME
          ELSE 
            CALL      PATNAA00
          ENDIF
          CALL      RDPMPX21
.
          PACK      KEY19,WTEPURN,WTEPPRO,WTEPCNT,SP70  * Waiting List Record
          CALL      RDTREA1
.
          UNPACK    WMDATE1,CCENT,CYEAR,CMON,CDAY  * Date on List
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MATCH     "1",WTEPDEL  * Deleted from extract
          IF        @EQUAL
            MOVE      "Yes",KEY4
          ELSE
            MOVE      "No",KEY4
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td nowrap><A HREF='javascript:ShowDetail08":
                              "(#"",LINKPRG,"#.pbl":
                              "?reportno=",LINKREP:
                              "&template=",LINKTEM:
                              "&watep001=",WTEPEID:
                              "&watep002=",WTEPURN:
                              "&watep003=",WTEPPRO:
                              "&watep004=",WTEPCNT,"#")'>":
                              "<img src=../images/MaintenanceIcon.gif hspace=4":
                              " border=0 align=absmiddle></a>":
                              WTEPURN," - ",PATFNAME,"</td>":
                              "<td>",WTEPPRO," - ",WMDESC,"</td><td>":
                              KEY11,"</td><td>",KEY4,"</td>":
                             "</tr>"
.
WATRW999  RETURN
.------------------------------------------------------------
. Process Suspension
.------------------------------------------------------------
EXTF0000  BRANCH    FLDITMNO,EXTF0100,EXTF0200,EXTF0300,EXTF0400,EXTF0500:
                             EXTF0600,EXTF0700,EXTF0800,EXTF0900,EXTF1000:
                             EXTF1100,EXTF1200,EXTF1300,EXTF1400,EXTF1500:
                             EXTF1600,EXTF1700,EXTF1800,EXTF1900,EXTF2000:
                             EXTF2100,EXTF2200,EXTF2300,EXTF2400,EXTF2500:
                             EXTF2600,EXTF2700,EXTF2800,EXTF2900,EXTF3000:
                             EXTF3100,EXTF3200,EXTF3300,EXTF3400,EXTF3500:
                             EXTF3600,EXTF3700,EXTF3800,EXTF3900,EXTF4000:
                             EXTF4100,EXTF4200,EXTF4300,EXTF4400,EXTF4500:
                             EXTF4600,EXTF4700,EXTF4800,EXTF4900,EXTF5000:
                             EXTF5100,EXTF5200,EXTF5300,EXTF5400,EXTF5500:
                             EXTF5600,EXTF5700,EXTF5800,EXTF5900,EXTF6000:
                             EXTF6100,EXTF6200,EXTF6300,EXTF6400,EXTF6500:
                             EXTF6600,EXTF6700,EXTF6800
.
          WRITE     HTMLFILE;"Invalid Tag";
          GOTO      EXTF9999
.
EXTF0100  MATCH     SP70,WTEXCODE
          GOTO      EXTF0110 IF EQUAL
          WRITE     HTMLFILE;WTEXCODE;
          GOTO      EXTF9999
EXTF0110  MOVE      Z70,KEY4
          CALL      RSWTEXT1
          CALL      RPWTEXT1
          IF        OVRCD=1
            WRITE     HTMLFILE;"0001";
          ELSE
            MOVE      WTEXCODE,F4
            ADD       ONE,F4
            MOVE      F4,WTEXCODE
            REP       " 0",WTEXCODE
            WRITE     HTMLFILE;WTEXCODE;
            CALL      CLWATEXT
          ENDIF
          GOTO      EXTF9999

.
EXTF0200  MATCH     SP70,WTEXDESC
          GOTO      EXTF9999 IF EQUAL
          WRITE     HTMLFILE;WTEXDESC;
          GOTO      EXTF9999
.
EXTF0300  MATCH     SP70,WTEXFLDT
          GOTO      EXTF0310 IF EQUAL
          MOVE      ZERO,F2
          MOVE      SP70,CMON
          MOVE      SP70,MTHNAM3
          UNPACK    WTEXFLDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      EXTF9999
EXTF0310  WRITE     HTMLFILE;"Start";
          GOTO      EXTF9999
EXTF0400  MATCH     Z70,WTEXTLDT
          GOTO      EXTF0410 IF EQUAL
          MOVE      ZERO,F2
          MOVE      SP70,CMON
          MOVE      SP70,MTHNAM3
          UNPACK    WTEXTLDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      EXTF9999
EXTF0410  WRITE     HTMLFILE;"Finish";
          GOTO      EXTF9999
.
EXTF0500  MATCH     SP70,WTEXFVDT
          GOTO      EXTF0510 IF EQUAL
          MOVE      ZERO,F2
          MOVE      SP70,CMON
          MOVE      SP70,MTHNAM3
          UNPACK    WTEXFVDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      EXTF9999
EXTF0510  WRITE     HTMLFILE;"Start";
          GOTO      EXTF9999
EXTF0600  MATCH     Z70,WTEXTVDT
          GOTO      EXTF0610 IF EQUAL
          MOVE      ZERO,F2
          MOVE      SP70,CMON
          MOVE      SP70,MTHNAM3
          UNPACK    WTEXTVDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      EXTF9999
EXTF0610  WRITE     HTMLFILE;"Finish";
          GOTO      EXTF9999
.
EXTF0700  MATCH     SP70,WTEXFSDT
          GOTO      EXTF0710 IF EQUAL
          MOVE      ZERO,F2
          MOVE      SP70,CMON
          MOVE      SP70,MTHNAM3
          UNPACK    WTEXFSDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      EXTF9999
EXTF0710  WRITE     HTMLFILE;"Start";
          GOTO      EXTF9999
EXTF0800  MATCH     Z70,WTEXTSDT
          GOTO      EXTF0810 IF EQUAL
          MOVE      ZERO,F2
          MOVE      SP70,CMON
          MOVE      SP70,MTHNAM3
          UNPACK    WTEXTSDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      EXTF9999
EXTF0810  WRITE     HTMLFILE;"Finish";
          GOTO      EXTF9999
.
EXTF0900  MATCH     SP70,WTEXFRDT
          GOTO      EXTF0910 IF EQUAL
          MOVE      ZERO,F2
          MOVE      SP70,CMON
          MOVE      SP70,MTHNAM3
          UNPACK    WTEXFRDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      EXTF9999
EXTF0910  WRITE     HTMLFILE;"Start";
          GOTO      EXTF9999
EXTF1000  MATCH     Z70,WTEXTRDT
          GOTO      EXTF1010 IF EQUAL
          MOVE      ZERO,F2
          MOVE      SP70,CMON
          MOVE      SP70,MTHNAM3
          UNPACK    WTEXTRDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      EXTF9999
EXTF1010  WRITE     HTMLFILE;"Finish";
          GOTO      EXTF9999
.
EXTF1100  MOVE      "WU",CATEGORY
          MOVE      WTEXUNT,CODE
          CALL      CODITM00
          GOTO      EXTF9999
.
EXTF1200  MOVE      "TP",CATEGORY
          MOVE      WTEXPRI,CODE
          CALL      CODITM00
          GOTO      EXTF9999
.
EXTF1300  MOVE      "WS",CATEGORY
          MOVE      WTEXNOT,CODE
          CALL      CODITM00
          GOTO      EXTF9999
.
EXTF1400  MOVE      "WG",CATEGORY
          MOVE      WTEXPGP,CODE
          CALL      CODITM00
          GOTO      EXTF9999
.
EXTF1500  MOVE      "WR",CATEGORY
          MOVE      WTEXRMR,CODE
          CALL      CODITM00
          GOTO      EXTF9999
.
EXTF1600  UNPACK    DIM127,KEY1,ANS,DIM127
          MOVE      ZERO,F1
          MOVE      ANS,F1
          BRANCH    F1,EXTF1610
          PACK      GENPCODE,WTEXRGP,SP70
          CALL      HCPDET00
          GOTO      EXTF9999
.
EXTF1610  WRITE     HTMLFILE;WTEXRGP;
          GOTO      EXTF9999
.
EXTF1700  MOVE      WTEXCON,DOCTCODE
          CALL      DOCDET00
          GOTO      EXTF9999
.
EXTF1800  UNPACK    DIM127,D1,ANS,DIM127
          MATCH     SP70,WTEXPRO
          GOTO      EXTF9999 IF EQUAL
          MOVE      ZERO,F1
          MOVE      ANS,F1
          BRANCH    F1,EXTF1810
          RESET     WTEXPRO
          PACK      KEY9,WTEXPRO,SP70
          CALL      RDPROA1
          BRANCH    OVRCD,EXTF9999
          WRITE     HTMLFILE;WPDESC;
          GOTO      EXTF9999
.
EXTF1810  WRITE     HTMLFILE;WTEXPRO;
          GOTO      EXTF9999
.
EXTF1900  MOVE      "S ",CATEGORY
          MOVE      WTEXSRC,CODE
          CALL      CODITM00
          GOTO      EXTF9999
.
EXTF2000  MOVE      "W1",CATEGORY
          MOVE      WTEXUD1,CODE
          CALL      CODITM00
          GOTO      EXTF9999
.
EXTF2100  MOVE      "W2",CATEGORY
          MOVE      WTEXUD2,CODE
          CALL      CODITM00
          GOTO      EXTF9999
.
EXTF2200  MOVE      "W3",CATEGORY
          MOVE      WTEXUD3,CODE
          CALL      CODITM00
          GOTO      EXTF9999
.
EXTF2300  MOVE      "W4",CATEGORY
          MOVE      WTEXUD4,CODE
          CALL      CODITM00
          GOTO      EXTF9999
.
EXTF2400  MOVE      "X5",CATEGORY
          MOVE      WTEXUD5,CODE
          CALL      CODITM00
          GOTO      EXTF9999
.
EXTF2500  MOVE      "X6",CATEGORY
          MOVE      WTEXUD6,CODE
          CALL      CODITM00
          GOTO      EXTF9999
.
EXTF2600  MOVE      "X7",CATEGORY
          MOVE      WTEXUD7,CODE
          CALL      CODITM00
          GOTO      EXTF9999
.
EXTF2700  MOVE      "X8",CATEGORY
          MOVE      WTEXUD8,CODE
          CALL      CODITM00
          GOTO      EXTF9999
.
EXTF2800  MOVE      WTEXSTA,STATCODE
          CALL      STTLST00
          GOTO      EXTF9999
.
EXTF2900  CALL      EXTTAB00
          GOTO      EXTF9999
.
EXTF3000  CALL      LETITM00       * Waiting List Letter Selection List
          GOTO      EXTF9999
.
EXTF3100  MOVE      WTEXANL1,ANLTYPE * Analysis Level 1 
          CALL      ANLEVL00         * Extract Analysis Level Selection List
          GOTO      EXTF9999
.
EXTF3200  MOVE      WTEXANL2,ANLTYPE * Analysis Level 2 
          CALL      ANLEVL00         * Extract Analysis Level Selection List
          GOTO      EXTF9999
.
EXTF3300  MOVE      WTEXANL3,ANLTYPE * Analysis Level 3 
          CALL      ANLEVL00         * Extract Analysis Level Selection List
          GOTO      EXTF9999
.
EXTF3400  MOVE      WTEXANL4,ANLTYPE * Analysis Level 4 
          CALL      ANLEVL00         * Extract Analysis Level Selection List
          GOTO      EXTF9999
.
EXTF3500  MOVE      WTEXANM1,ANLMEAS * Analysis Measure 1 
          CALL      ANLMEA00         * Extract Analysis Measures Selection List
          GOTO      EXTF9999
.
EXTF3600  MOVE      WTEXANM2,ANLMEAS * Analysis Measure 2 
          CALL      ANLMEA00         * Extract Analysis Measures Selection List
          GOTO      EXTF9999
.
EXTF3700  MOVE      WTEXANM3,ANLMEAS * Analysis Measure 3 
          CALL      ANLMEA00         * Extract Analysis Measures Selection List
          GOTO      EXTF9999
.
EXTF3800  PACK      DFLTWARD,WTEXPOWD
          CALL      WSEL0000         * Expected ward selection list
          GOTO      EXTF9999
.
EXTF3900  MOVE      "XB",CATEGORY    * Intended Day Case
          MOVE      WTEXIDYC,CODE
          CALL      CODITM00
          GOTO      EXTF9999
.
EXTF4000  CALL      LETSNC00            * Letter sent code
          GOTO      EXTF9999
.
EXTF4100  WRITE     HTMLFILE;WTEXCRTL;  * Check response to letter
          GOTO      EXTF9999
.
EXTF4200  MOVE      "ap",CATEGORY                   * I SRF 17693
          MOVE      WTEXADMW,CODE                   * Set parameter
          CALL      CODITM00                        * Look in patcodes for desc
          GOTO      WTTX9999                        * end I SRF 17693
.
EXTF4300  WRITE     HTMLFILE;WTEXINCD;  * Include deceased
          GOTO      EXTF9999
.
EXTF4400  WRITE     HTMLFILE;WTEXOVON;  * Overdue patients only
          GOTO      EXTF9999
.
EXTF4500  MOVE      "CL",CATEGORY       * Intended Day Case
          MOVE      WTEXCTYP,CODE
          CALL      CODITM00
          GOTO      EXTF9999
.
EXTF4600  MOVE      "VL",CATEGORY       * Listing Status
          MOVE      WTEXLIST,CODE
          CALL      CODITM00
          GOTO      EXTF9999
.
EXTF4700  MOVE      "WU",CATEGORY       * Unit From (WU)
          MOVE      WTEXFUNI,CODE
          CALL      CODITM00
          GOTO      EXTF9999
.
EXTF4800  MOVE      "T ",CATEGORY       * Resident Status (T)
          MOVE      WTEXRSTA,CODE
          CALL      CODITM00
          GOTO      EXTF9999
.
EXTF4900  MOVE      "A ",CATEGORY       * Admission Type (A) 
          MOVE      WTEXADTY,CODE
          CALL      CODITM00
          GOTO      EXTF9999
.
EXTF5000  MATCH     SP70,WTEXFPAD
          GOTO      EXTF5010 IF EQUAL
          MOVE      ZERO,F2
          MOVE      SP70,CMON
          MOVE      SP70,MTHNAM3
          UNPACK    WTEXFPAD,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      EXTF9999
.
EXTF5010  WRITE     HTMLFILE;"Start";
          GOTO      EXTF9999
.
EXTF5100  MATCH     Z70,WTEXTPAD
          GOTO      EXTF5110 IF EQUAL
          MOVE      ZERO,F2
          MOVE      SP70,CMON
          MOVE      SP70,MTHNAM3
          UNPACK    WTEXTPAD,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      EXTF9999
.
EXTF5110  WRITE     HTMLFILE;"Finish";
          GOTO      EXTF9999
.
EXTF5200  MATCH     SP70,WTEXFSYD
          GOTO      EXTF5210 IF EQUAL
          MOVE      ZERO,F2
          MOVE      SP70,CMON
          MOVE      SP70,MTHNAM3
          UNPACK    WTEXFSYD,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      EXTF9999
.
EXTF5210  WRITE     HTMLFILE;"Start";
          GOTO      EXTF9999
.
EXTF5300  MATCH     Z70,WTEXTSYD
          GOTO      EXTF5310 IF EQUAL
          MOVE      ZERO,F2
          MOVE      SP70,CMON
          MOVE      SP70,MTHNAM3
          UNPACK    WTEXTSYD,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      EXTF9999
.
EXTF5310  WRITE     HTMLFILE;"Finish";
          GOTO      EXTF9999
.
EXTF5400  MATCH     SP70,WTEXFSUD
          GOTO      EXTF5410 IF EQUAL
          MOVE      ZERO,F2
          MOVE      SP70,CMON
          MOVE      SP70,MTHNAM3
          UNPACK    WTEXFSUD,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      EXTF9999
.
EXTF5410  WRITE     HTMLFILE;"Start";
          GOTO      EXTF9999
.
EXTF5500  MATCH     Z70,WTEXTSUD
          GOTO      EXTF5510 IF EQUAL
          MOVE      ZERO,F2
          MOVE      SP70,CMON
          MOVE      SP70,MTHNAM3
          UNPACK    WTEXTSUD,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      EXTF9999
.
EXTF5510  WRITE     HTMLFILE;"Finish";
          GOTO      EXTF9999
.
EXTF5600  MATCH     SP70,WTEXFOSD
          GOTO      EXTF5610 IF EQUAL
          MOVE      ZERO,F2
          MOVE      SP70,CMON
          MOVE      SP70,MTHNAM3
          UNPACK    WTEXFOSD,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      EXTF9999
.
EXTF5610  WRITE     HTMLFILE;"Start";
          GOTO      EXTF9999
.
EXTF5700  MATCH     Z70,WTEXTOSD
          GOTO      EXTF5710 IF EQUAL
          MOVE      ZERO,F2
          MOVE      SP70,CMON
          MOVE      SP70,MTHNAM3
          UNPACK    WTEXTOSD,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      EXTF9999
.
EXTF5710  WRITE     HTMLFILE;"Finish";
          GOTO      EXTF9999
.
EXTF5800  MATCH     SP70,WTEXFURN
          GOTO      EXTF5810 IF EQUAL
          WRITE     HTMLFILE;WTEXFURN;
          GOTO      EXTF9999

.
EXTF5810  WRITE     HTMLFILE;"Start";
          GOTO      EXTF9999
.
EXTF5900  MATCH     Z70,WTEXTURN
          GOTO      EXTF5910 IF EQUAL
          WRITE     HTMLFILE;WTEXTURN;
          GOTO      EXTF9999
.
EXTF5910  WRITE     HTMLFILE;"Finish";
          GOTO      EXTF9999
.
EXTF6000  MATCH     SP70,WTEXFPRO
          GOTO      EXTF6010 IF EQUAL
          WRITE     HTMLFILE;WTEXFPRO;
          GOTO      EXTF9999
.
EXTF6010  WRITE     HTMLFILE;"Start"
          GOTO      EXTF9999
.
EXTF6100  MATCH     Z70,WTEXTPRO
          GOTO      EXTF6110 IF EQUAL
          WRITE     HTMLFILE;WTEXTPRO;
          GOTO      EXTF9999
.
EXTF6110  WRITE     HTMLFILE;"Finish";
          GOTO      EXTF9999
.
EXTF6200  MOVE      "WU",CATEGORY       * Unit From (WU)
          MOVE      WTEXTUNI,CODE
          CALL      CODITM00
          GOTO      EXTF9999
.
EXTF6300  MOVE      WTEXFPRS,STATCODE
          CALL      STALST00
          GOTO      EXTF9999
.
EXTF6400  MOVE      WTEXTPRS,STATCODE
          CALL      STALST00
          GOTO      EXTF9999
.
EXTF6500  MATCH     SP70,WTEXFCON
          GOTO      EXTF6510 IF EQUAL
          WRITE     HTMLFILE;WTEXFCON;
          GOTO      EXTF9999
.
EXTF6510  WRITE     HTMLFILE;"Start";
          GOTO      EXTF9999
.
EXTF6600  MATCH     Z70,WTEXTCON
          GOTO      EXTF6610 IF EQUAL 
          WRITE     HTMLFILE;WTEXTCON;
          GOTO      EXTF9999
.
EXTF6610  WRITE     HTMLFILE;"Finish";
          GOTO      EXTF9999
.
EXTF6700  WRITE     HTMLFILE;WTEXFSES;
          GOTO      EXTF9999
.
EXTF6800  WRITE     HTMLFILE;WTEXTSES;
          GOTO      EXTF9999
.
EXTF9999  RETURN
.------------------------------------------------------------
.  Extract Analysis Level Selection List
.  INPUT PARAMETER: ANLTYPE
.------------------------------------------------------------
ANLEVL00  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,ANLEVL10,ANLEVL20
          MOVE      "004",KEY3
          PACK      KEY6,KEY3,ANLTYPE
          CALL      RDCAST1
          WRITE     HTMLFILE;CASTDES;
          GOTO      ANLEVL99
.
ANLEVL10  WRITE     HTMLFILE;ANLTYPE;
          GOTO      ANLEVL99
.
ANLEVL20  CALL      LEVSEL00
          GOTO      ANLEVL99
.
ANLEVL99  RETURN
.------------------------------------------------------------
. Selection List
.------------------------------------------------------------
LEVSEL00  MOVE      "004",KEY3
          PACK      KEY6,KEY3,SP70
          CALL      RSCAST1 
LEVSEL10  CALL      RKCAST1 
          BRANCH    OVRCD,LEVSEL99
          MATCH     KEY3,CASTTOE
          GOTO      LEVSEL99 IF NOT EQUAL
          MATCH     ANLTYPE,CASTSTY
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",CASTSTY," selected>":
                               CASTDES,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",CASTSTY,">":
                               CASTDES,"</option>"
          ENDIF
          GOTO       LEVSEL10
.
LEVSEL99 RETURN
.------------------------------------------------------------
.  Extract Analysis Measures Selection List
.  INPUT PARAMETER: ANLMEAS
.------------------------------------------------------------
ANLMEA00  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,ANLMEA10,ANLMEA20
          MOVE      "004",KEY3
          PACK      KEY6,KEY3,ANLMEAS
          CALL      RDCAAM1
          WRITE     HTMLFILE;CAAMDES;
          GOTO      ANLMEA99
.
ANLMEA10  WRITE     HTMLFILE;ANLMEAS;
          GOTO      ANLMEA99
.
ANLMEA20  CALL      MEASEL00
          GOTO      ANLMEA99
.
ANLMEA99  RETURN
.------------------------------------------------------------
. Selection List
.------------------------------------------------------------
MEASEL00  MOVE      "004",KEY3
          PACK      KEY6,KEY3,SP70
          CALL      RSCAAM1 
MEASEL10  CALL      RKCAAM1 
          BRANCH    OVRCD,MEASEL99
          MATCH     KEY3,CAAMTOE
          GOTO      MEASEL99 IF NOT EQUAL
          MATCH     ANLMEAS,CAAMAM 
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",CAAMAM," selected>":
                               CAAMDES,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",CAAMAM,">":
                               CAAMDES,"</option>"
          ENDIF
          GOTO       MEASEL10
.
MEASEL99 RETURN
.------------------------------------------------------------
. Output Table of Extract Details
.------------------------------------------------------------
EXTTAB00  PACK      KEY4,SP70
          CALL      RSWTEXT1
EXTTAB10  CALL      RKWTEXT1
          BRANCH    OVRCD,EXTTAB99
.
          MATCH     Z70,WTEXTLDT
          IF        @EQUAL
            PACK      WTEXTLDT,CCC,CYY,CMM,CDD
            REP       " 0",WTEXTLDT      * Set Current Date
          ENDIF
.
          MATCH     Z70,WTEXTVDT
          IF        @EQUAL
            PACK      WTEXTVDT,CCC,CYY,CMM,CDD
            REP       " 0",WTEXTVDT      * Set Current Date
          ENDIF
.
          MATCH     Z70,WTEXTSDT
          IF        @EQUAL
            PACK      WTEXTSDT,CCC,CYY,CMM,CDD
            REP       " 0",WTEXTSDT      * Set Current Date
          ENDIF
.
          MATCH     Z70,WTEXTRDT
          IF        @EQUAL
            PACK      WTEXTRDT,CCC,CYY,CMM,CDD
            REP       " 0",WTEXTRDT      * Set Current Date
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:UpdateItem('",HTMLLINK
          APPEND    WTEXCODE,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",WTEXCODE,"#",":
                             "#"",WTEXDESC,"#",":
                             "#"",WTEXFLDT,"#",":
                             "#"",WTEXTLDT,"#",":
                             "#"",WTEXFVDT,"#",":
                             "#"",WTEXTVDT,"#",":
                             "#"",WTEXFSDT,"#",":
                             "#"",WTEXTSDT,"#",":
                             "#"",WTEXFRDT,"#",":
                             "#"",WTEXTRDT,"#");"
.
          GOTO      EXTTAB10
.
EXTTAB99  RETURN
.------------------------------------------------------------
. Common Patient Codes Required for forms data
.------------------------------------------------------------
PCOM0000  BRANCH    FLDITMNO,PCOM0100,PCOM0200,PCOM0300,PCOM0400,PCOM0500:
                             PCOM0600,PCOM0700,PCOM0800,PCOM0900,PCOM1000:
                             PCOM1100,PCOM1200,PCOM1300,PCOM1400,PCOM1500:
                             PCOM1600,PCOM1700,PCOM1800,PCOM1900,PCOM2000:
                             PCOM2100,PCOM2200,PCOM2300,PCOM2400,PCOM2500:
                             PCOM2600,PCOM2700,PCOM2800,PCOM2900,PCOM3000:
                             PCOM3100,PCOM3200,PCOM3300,PCOM3400,PCOM3500:
                             PCOM3600,PCOM3700,PCOM3800,PCOM3900,PCOM4000:
                             PCOM4100,PCOM4200,PCOM4300,PCOM4400,PCOM4500:
                             PCOM4600,PCOM4700,PCOM4800,PCOM4900,PCOM5000:
                             PCOM5100,PCOM5200,PCOM5300,PCOM5400,PCOM5500:
                             PCOM5600,PCOM5700,PCOM5800,PCOM5900,PCOM6000:
                             PCOM6100,PCOM6200,PCOM6300,PCOM6400,PCOM6500:
                             PCOM6600,PCOM6700,PCOM6800,PCOM6900,PCOM7000:
                             PCOM7100,PCOM7200,PCOM7300,PCOM7400,PCOM7500:
                             PCOM7600,PCOM7700,PCOM7800,PCOM7900,PCOM8000:
                             PCOM8100,PCOM8200,PCOM8300,PCOM8400,PCOM8500:
                             PCOM8600
.
. Selected Category options List
.
PCOM0100  UNPACK    DIM127,D1,CATEGORY,DIM127
          MOVE      SP70,CODE
          CALL      CODSEL00
          GOTO      PCOM9999
.
. Ward Selection
.
PCOM0200  PACK      DFLTWARD,SP70
          CALL      WSEL0000
          GOTO      PCOM9999
.
PCOM0300  CALL      STALST00
          GOTO      PCOM9999
.
PCOM0400  CALL      WTESIS00
          GOTO      PCOM9999
.
PCOM0500  CALL      WTDRG000
          GOTO      PCOM9999
.
PCOM0600  CALL      WTDIF000
          GOTO      PCOM9999
.
PCOM0700  MOVE      "ap",CATEGORY
          MOVE      ADMPOINT,CODE
          CALL      CODSEL00        * Intended day case selection
          GOTO      PCOM9999
.
PCOM0800  MOVE      "XG",CATEGORY
.         MOVE      WMUNIT,CODE
          CALL      CODITM00
          GOTO      PCOM9999
.
PCOM0900  CALL      IBACLOCK
          MOVE      CMM,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.          REP       " 0",CYY
          WRITE     HTMLFILE;CDD,SP1,MTHNAM3,SP1,CCC,CYY
          GOTO      PCOM9999
.
PCOM1000  WRITE     HTMLFILE;USERID
          GOTO      PCOM9999
.
PCOM1100  MOVE      "BC",CATEGORY
.         MOVE      BRRECANC,CODE
          CALL      CODITM00
          GOTO      PCOM9999
.
PCOM1200  MOVE      "VL",CATEGORY
          MOVE      WTTXPLST,CODE
          CALL      CODITM00
          GOTO      PCOM9999
.
PCOM1300  CALL      SUNTAB00
          GOTO      PCOM9999
.
PCOM1400  MOVE      "WD",CATEGORY
          MOVE      WTHIRDT3,CODE
          CALL      CODITM00
          GOTO      PCOM9999
.
PCOM1500  MATCH     SP70,WTHIEDAT
          GOTO      PCOM9999 IF EQUAL
          GOTO      PCOM9999 IF EOS
          UNPACK    WTHIEDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      PCOM9999
.
PCOM1600  CALL      SUSSTA00
          GOTO      PCOM9999
.
PCOM1700  CALL      LETITM00           * Selection list if letters
          GOTO      PCOM9999
.
PCOM1800  CALL      BKTITM00           * Selection list if letters
          GOTO      PCOM9999
.
PCOM1900  CALL      DOCDET00
          GOTO      PCOM9999
.
PCOM2000  MOVE      "TP",CATEGORY
          MOVE      WTTXPLST,CODE
          CALL      CODITM00
          GOTO      PCOM9999
.
PCOM2100  MOVE      "VL",CATEGORY
          MOVE      WTTXPLST,CODE
          CALL      CODITM00
          GOTO      PCOM9999
.
PCOM2200  WRITE     HTMLFILE;INTRFLAG;
          GOTO      PCOM9999
.
PCOM2300  WRITE     HTMLFILE;WMDATE1;
          GOTO      PCOM9999
.
PCOM2400  UNPACK    DIM127,D1,KEY3,DIM127        * Waiting list hitory file tags
          MOVE      KEY3,FLDITMNO
          CALL      WTHI0000
          GOTO      PCOM9999
.
. Find W/L entry for Matching U/R & frstdate
.
PCOM2500  PACK      KEY19,URNUMBER,SP70
          CALL      RDSTREA1
PCOM2510  CALL      RDKTREA1
          BRANCH    OVRCD,PCOM2590
          MATCH     URNUMBER,WMURNO
          GOTO      PCOM2590 IF NOT EQUAL
          MATCH     FRSTDATE,WMDATE1
          GOTO      PCOM2510 IF NOT EQUAL
          PACK      CASEKEYS,WMURNO,WMCODE,WMCNT,SP70
          WRITE     HTMLFILE;CASEKEYS
          WRITE     HTMLFILE;WMUNIT
          WRITE     HTMLFILE;WMDOCTOR
          GOTO      PCOM9999
PCOM2590  WRITE     HTMLFILE;"ERROR NO W-LIST ENTRY FOR ",URNUMBER," ",FLTRDATE;
          GOTO      PCOM9999
.
PCOM2600  WRITE     HTMLFILE;WTOPSTAT;
          GOTO      PCOM9999
.
PCOM2700  MOVE      "WP",CATEGORY
          MOVE      WTHIPCHG,CODE
          CALL      CODITM00
          GOTO      PCOM9999
.
PCOM2800  UNPACK    PBDATE,CCENT,CYEAR,CMON,CDAY
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          CALL      CALCAGE
          WRITE     HTMLFILE;PSAGEYRS;
          GOTO      PCOM9999
.
PCOM2900  MOVE      BKRETYPE,CODE
          CALL      BOKSEL00
          GOTO      PCOM9999
.
PCOM3000  WRITE     HTMLFILE;WTEEPREV;
          GOTO      PCOM9999
.
PCOM3100  WRITE     HTMLFILE;WTOSSTAT;
          GOTO      PCOM9999
.
PCOM3200  CALL      CHKVIS00
          GOTO      PCOM9999
.
PCOM3300  UNPACK    DIM127,D1,KEY3,DIM127
          MOVE      KEY3,FLDITMNO
          CALL      MISF0000
          GOTO      PCOM9999
.
PCOM3400  WRITE     HTMLFILE;CURRADMN;
          GOTO      PCOM9999
.
PCOM3500  WRITE     HTMLFILE;DEFTURNO;
          GOTO      PCOM9999
.
PCOM3600  WRITE     HTMLFILE;SERBFLAG;
          GOTO      PCOM9999
.
PCOM3700  PACK      DFLTWARD,SP70
          CALL      WSEL0000
          GOTO      PCOM9999
.
PCOM3800  CALL      DITB0000              * Data integrity audit
          GOTO      PCOM9999
.
PCOM3900  MATCH     SP70,BOOKDATE
          GOTO      PCOM9999 IF EQUAL
          GOTO      PCOM9999 IF EOS
          UNPACK    BOOKDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      PCOM9999
.
PCOM4000  WRITE     HTMLFILE;BOOKTIME;
          GOTO      PCOM9999
.
PCOM4100  WRITE     HTMLFILE;BOOKWARD;
          GOTO      PCOM9999
.
PCOM4200  WRITE     HTMLFILE;BOOKEBED;
          GOTO      PCOM9999
.
PCOM4300  WRITE     HTMLFILE;BLNKBOOK;
          GOTO      PCOM9999
.
PCOM4400  CALL      DISSEL00
          GOTO      PCOM9999
.
PCOM4500  CALL      DISCOD00
          GOTO      PCOM9999
.
PCOM4600  CALL      WTREP000
          GOTO      PCOM9999
.
PCOM4700  WRITE     HTMLFILE;SHOWCOMM;
          GOTO      PCOM9999
.
PCOM4800  MOVE      SP70,KEY3
          UNPACK    DIM127,DIM1,NOTETYPE,DIM127
          MOVE      CASEKEYS,DIM19
          PACK      KEY28,DIM19,NOTETYPE,SP70
          CALL      RSWTMHD1
PCOM4810  CALL      RKWTMHD1
          BRANCH    OVRCD,PCOM9999
.
          PACK      KEY19,WTMHURNO,WTMHPROC,WTMHPCNT,SP70
          MATCH     CASEKEYS,KEY19
          GOTO      PCOM9999 IF NOT EQUAL
.
          MATCH     NOTETYPE,WTMHTYPE
          GOTO      PCOM9999 IF NOT EQUAL
.
          MATCH     "1",WTMHDELT            * Deleted
          GOTO      PCOM4810 IF EQUAL
.
          WRITE     HTMLFILE;ONE;           * Yes comments available
.
          GOTO      PCOM9999
.
PCOM4900  MOVE      ZERO,NOTEORDR
          CALL      VEWCOM00
          GOTO      PCOM9999
.
PCOM5000  MOVE      ONE,NOTEORDR
          CALL      VEWCOM00
          GOTO      PCOM9999
.
PCOM5100  MATCH     SP70,INVCASEK
          GOTO      PCOM9999 IF EQUAL
          WRITE     HTMLFILE;INVCASEK;
          GOTO      PCOM9999
.
PCOM5200  MOVE      "H",DIM1
          CALL      WTCHPN00
          GOTO      PCOM9999
.
PCOM5300  MOVE      "U",DIM1
          CALL      WTCHPN00
          GOTO      PCOM9999
.
PCOM5400  MOVE      "P",DIM1
          CALL      WTCHPN00
          GOTO      PCOM9999
.
PCOM5500  CALL      DISDSC00
          GOTO      PCOM9999
.
PCOM5600  CALL      DISIDN00
          GOTO      PCOM9999
.
PCOM5700  PACK      KEY3,WBSEHOSP,SP70
          CALL      RDPTHSP1
          BRANCH    OVRCD,PCOM9999
.
          WRITE     HTMLFILE;PTHSNAME;
          GOTO      PCOM9999 
.
PCOM5800  WRITE     HTMLFILE;WTTXADMW;
          GOTO      PCOM9999
.                                         * Display Anaesthetic type for WA
PCOM5900  MATCH     BKRXANTY,SP70
          IF        @EQUAL
            MOVE      WTTXANAE,CODE
          ELSE
            MOVE      BKRXANTY,CODE
          ENDIF
          MOVE      "OA",CATEGORY
          CALL      CODITM00
          GOTO      PCOM9999
.
PCOM6000  WRITE     HTMLFILE;ADMISNID;
          GOTO      PCOM9999
.
PCOM6100  WRITE     HTMLFILE;ADMREQNO;
          GOTO      PCOM9999
.
PCOM6200  WRITE     HTMLFILE;WBSEUID;
          GOTO      PCOM9999
.
PCOM6300  WRITE     HTMLFILE;PTARVAL1;
          GOTO      PCOM9999
.
PCOM6400  WRITE     HTMLFILE;PTARVAL2;
          GOTO      PCOM9999
.
PCOM6500  CALL      CLCBMI00
          CALL      RNGBMI00
          WRITE     HTMLFILE;BODMASRN;
          GOTO      PCOM9999
.
PCOM6600  MATCH     SP70,PTARUDTE
          GOTO      PCOM6610 IF EQUAL
.
          UNPACK    PTARUDTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP1,PTARUTME;
          GOTO      PCOM9999
.
PCOM6610  MATCH     SP70,PTARCDTE
          GOTO      PCOM9999 IF EQUAL
.
          UNPACK    PTARCDTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP1,PTARCTME;
          GOTO      PCOM9999
.
PCOM6700  WRITE     HTMLFILE;PTARVAL1;
          GOTO      PCOM9999
.
PCOM6800  WRITE     HTMLFILE;PTARVAL2;
          GOTO      PCOM9999
.
PCOM6900  MATCH     SP70,PTARDATE
          GOTO      PCOM9999 IF EQUAL
.
          UNPACK    PTARDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP1,PTARUTME;
          GOTO      PCOM9999
.
PCOM7000  WRITE     HTMLFILE;PTARTIME;
          GOTO      PCOM9999
.
PCOM7100  WRITE     HTMLFILE;PTARURNO;
          GOTO      PCOM9999
.
PCOM7200  MATCH     SP70,PTARDATE
          GOTO      PCOM9999 IF EQUAL
.
          UNPACK    PTARDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      PCOM9999
.
PCOM7300  WRITE     HTMLFILE;REFRLVIS;
          GOTO      PCOM9999
.
PCOM7400  WRITE     HTMLFILE;ALREPSIT; 
          GOTO      PCOM9999
.
PCOM7500  WRITE     HTMLFILE;ALREHCP;
          GOTO      PCOM9999
.
PCOM7600  WRITE     HTMLFILE;ALRECOMP;
          GOTO      PCOM9999
.
PCOM7700  WRITE     HTMLFILE;ALREPURC;
          GOTO      PCOM9999
.
PCOM7800  MATCH     "1",PTCNSMSN            * Using SMS Messages
          GOTO      PCOM9999 IF NOT EQUAL
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSOOSA1,"pmsoosaf"
          TRAPCLR   IO
          BRANCH    OVRCD,PCOM9999
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDPMOOS1                * Check if Opt out of SMS
          BRANCH    OVRCD,PCOM9999
.
          WRITE     HTMLFILE;ONE;
          CLOSE     PMSOOSA1
          GOTO      PCOM9999
.
PCOM7900  WRITE     HTMLFILE;WTEEPTWT;
          GOTO      PCOM9999
.
PCOM8000  WRITE     HTMLFILE;ALWLVISN;
          GOTO      PCOM9999
.
PCOM8100  MATCH     SP70,REFRLVIS
          GOTO      PCOM9999 IF EQUAL
          GOTO      PCOM9999 IF EOS
.
          PACK      KEY8,REFRLVIS,SP70
          CALL      RDWCOM1
          BRANCH    OVRCD,PCOM9999
.
          WRITE     HTMLFILE;WCCLMNO;
          GOTO      PCOM9999
.
PCOM8200  WRITE     HTMLFILE;EREFRLID;      * eReferral ID
          GOTO      PCOM9999
.
PCOM8300  PACK      KEY12,ALREDEPT,ALREDIA1,SP70
          CALL      RDALDIA1
          IF        OVRCD=1
            MOVE      SP70,ALDIDESC
          ENDIF

          WRITE     HTMLFILE;ALDIDESC;     * Allied Health Dx
          GOTO      PCOM9999
.
PCOM8400  WRITE     HTMLFILE;ALRESCOR;     * Score
          GOTO      PCOM9999
.
PCOM8500  WRITE     HTMLFILE;ALREUC22;	   * Clinician Sus Cancer
          GOTO      PCOM9999
.
PCOM8600  CALL      PRTTAB00               * Priority Change table
          GOTO      PCOM9999
.
PCOM9999  RETURN
.------------------------------------------------------------
. DISSEL00 - Display Selection List for Disasters
.------------------------------------------------------------
.
DISSEL00  PACK      KEY9,SP70
          CALL      RSDSMAS1
DISSEL10  CALL      RKDSMAS1
          BRANCH    OVRCD,DISSEL99
.
          MATCH     "3",DSMAACTV
          GOTO      DISSEL10 IF EQUAL
.
          WRITE     HTMLFILE;"<option value=#"",DSMACODE,"#">":
                             DSMADESC,"</option>"
          GOTO      DISSEL10
.
DISSEL99  RETURN
+
.------------------------------------------------------------
. DISCOD00 - Get Disaster Code for UR/Visit No
.------------------------------------------------------------
DISCOD00  PACK      KEY25,URNUMBER,SP70
          CALL      RSDSPTL1
DISCOD10  CALL      RKDSPTL1
          BRANCH    OVRCD,DISCOD99
.
          MATCH     URNUMBER,DSPLURNO
          GOTO      DISCOD99 IF NOT EQUAL
.
          PACK      DIM8,WMBOOK,SP70
          MATCH     DIM8,DSPLVISN
          GOTO      DISCOD10 IF NOT EQUAL
.
          MATCH     SP70,DSPLCODE
          IF        !@EQUAL & !@EOS
            WRITE     HTMLFILE;DSPLCODE;
          ENDIF
.
DISCOD99  RETURN
.
.------------------------------------------------------------
. DISDSC00 - Get Disaster Description for UR/Visit No
.------------------------------------------------------------
DISDSC00  PACK      KEY25,URNUMBER,SP70
          CALL      RSDSPTL1
DISDSC10  CALL      RKDSPTL1
          BRANCH    OVRCD,DISDSC99
.
          MATCH     URNUMBER,DSPLURNO
          GOTO      DISDSC99 IF NOT EQUAL
.
          PACK      DIM8,WMBOOK,SP70
          MATCH     DIM8,DSPLVISN
          GOTO      DISDSC10 IF NOT EQUAL
.
          MATCH     SP70,DSPLCODE
          GOTO      DISDSC99 IF EQUAL
          GOTO      DISDSC99 IF EOS
.
          PACK      KEY9,DSPLCODE,SP70
          CALL      RDDSMAS1
          BRANCH    OVRCD,DISDSC99
.
          WRITE     HTMLFILE;DSMADESC;
.
DISDSC99  RETURN
.
.------------------------------------------------------------
. DISIDN00 - Get Disaster ID for UR/Visit No
.------------------------------------------------------------
DISIDN00  PACK      KEY25,URNUMBER,SP70
          CALL      RSDSPTL1
DISIDN10  CALL      RKDSPTL1
          BRANCH    OVRCD,DISIDN99
.
          MATCH     URNUMBER,DSPLURNO
          GOTO      DISIDN99 IF NOT EQUAL
.
          PACK      DIM8,WMBOOK,SP70
          MATCH     DIM8,DSPLVISN
          GOTO      DISIDN10 IF NOT EQUAL
.
          MATCH     SP70,DSPLCODE
          GOTO      DISIDN99 IF EQUAL
          GOTO      DISIDN99 IF EOS
.
          PACK      KEY17,DSPLCODE,DSPLURNO,SP70
          CALL      RDDSPAT2
          BRANCH    OVRCD,DISIDN99
.
          WRITE     HTMLFILE;DSPTDIID;
.
DISIDN99  RETURN
.
.------------------------------------------------------------------------
. Update the Listing Status after Suspension date is crossed over
.------------------------------------------------------------------------
UPDLST00  MOVE      SP70,WTTXPLST
          MOVE      ZERO,DONEFLAG
          MOVE      SP70,SAVETDAT
          PACK      KEY31,WMURNO,WMCODE,WMCNT,Z70
          CALL      RAWTHIS1
          CALL      RPWTHIS1
          PACK      DATEC,CCC,CYY,CMM,CDD
          REP       " 0",DATEC
          MOVE      DATEC,DATE1
          UNPACK    CASEKEYS,D8,D9,D2
          MOVE      CASEKEYS,KEY19
          CALL      RDWTTX11
          IF        OVRCD=0
            PACK      SAVLIST,WTTXPLST
          ENDIF
.
          PACK      KEY21,CASEKEYS,SP70    
          CALL      RSWTSUS1
UPDLST10  CALL      RKWTSUS1
          BRANCH    OVRCD,UPDLST20
          PACK      KEY19,WTSUURNO,WTSUCODE,DWTSUCNT,SP70
          MATCH     KEY19,CASEKEYS
          GOTO      UPDLST20 IF NOT EQUAL
.
          MOVE      ONE,DONEFLAG              * found first record
          MOVE      WTSUFDAT,DATE2
          MOVE      WTSUTDAT,SAVETDAT
          MATCH     SP70,WTSUTDAT
          IF        @EQUAL
            MOVE      DATE1,DATE3
          ELSE
            MOVE      WTSUTDAT,DATE3
          ENDIF
.
          IF        DATE1<=DATE3 & DATE1>=DATE2
            GOTO      UPDLST15
          ELSE 
            GOTO      UPDLST10
          ENDIF
.
UPDLST15  MOVE      CASEKEYS,KEY19
          CALL      RDWTTX11
          IF        OVRCD=0
            MATCH     WTSULSTS,WTTXPLST
            IF        !@EQUAL
              MOVE      WTSULSTS,WTTXPLST
              CALL      UPWTTX11
              MATCH     SAVLIST,WTTXPLST
              IF        !@EQUAL
                PACK      SAVLIST,WTTXPLST
                MOVE      WTSUFDAT,WTENEVDT
.....           CALL      WRED0000
              ENDIF
            ENDIF
          ENDIF
          GOTO      UPDLST99
.
UPDLST20  COMPARE   ZERO,DONEFLAG
          GOTO      UPDLST99 IF EQUAL
.
          MOVE      CASEKEYS,KEY19
          CALL      RDWTTX11
          CALL      FNDRFC00
          IF        OVRCD=0
            CALL      UPWTTX11
            MATCH     SAVLIST,WTTXPLST
            IF        !@EQUAL
              PACK      SAVLIST,WTTXPLST
              PACK      WTENEVDT,SAVETDAT
              MATCH     SP70,SAVETDAT
              IF        @EQUAL
                PACK      WTENEVDT,TODAY
                REP       " 0",WTENEVDT
              ENDIF
.....         CALL      WRED0000
            ENDIF
          ENDIF
          GOTO      UPDLST99
.
UPDLST99  RETURN
.------------------------------------------------------------------------
. Find new RFC code
.------------------------------------------------------------------------
FNDRFC00  MOVE      "VL",KEY2
          PACK      KEY5,KEY2,SP70
          CALL      RDSCODE1
FNDRFC60  CALL      RDKCODE1
          BRANCH    OVRCD,FNDRFC99
.
          MATCH     "VL",TCODE
          GOTO      FNDRFC99 IF NOT EQUAL
.
          MATCH     "A",PTCOACTV           * Only want active codes
          GOTO      FNDRFC60 IF NOT EQUAL
.
          MATCH     "R",TCINDC1            * Must have indicator 1 = "R"
          GOTO      FNDRFC60 IF NOT EQUAL
.
          MOVE      ACODE,WTTXPLST
.
FNDRFC99  RETURN
.
.----------------------Common Codes for Report 5---------
WSCOM000  BRANCH    FLDITMNO,WSCOM100,WSCOM200
.
WSCOM100  MOVE      "VL",CATEGORY      * RFC Status Selection List
          MOVE      WTSULSTS,CODE
          CALL      CODITM00
          GOTO      WSCOM999  
.
WSCOM200  MOVE      "VL",CATEGORY      * RFC Status Selection List for    
          MOVE      WTSULSTS,CODE      * suspensions all values are NOT RFC
          CALL      SLSTAT00          
          GOTO      WSCOM999  
WSCOM999  RETURN
.------------------------------------------------------------
. Suspension Dates
.------------------------------------------------------------
SUNTAB00  PACK      KEY21,CASEKEYS,SP70
          CALL      RSWTSUS1
SUNTAB10  CALL      RKWTSUS1
          BRANCH    OVRCD,SUNTAB99
          PACK      KEY19,WTSUURNO,WTSUCODE,WTSUCNT,SP70
          MATCH     KEY19,CASEKEYS
          GOTO      SUNTAB99 IF NOT EQUAL
.
          MOVE      SP70,CMON 
          UNPACK    WTSUFDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      ZERO,F2
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY21,WTSUURNO,WTSUCODE,WTSUCNT,WTSUSCNT,SP70
          WRITE     HTMLFILE;"<tr><td>":
                    CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>";
.
          MATCH     SP70,WTSUTDAT
          IF        !@EQUAL 
            MOVE      SP70,CMON         
            UNPACK    WTSUTDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      ZERO,F2
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            WRITE     HTMLFILE;"<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>";
          ELSE
            WRITE     HTMLFILE;"<td>&nbsp;</td>"
          ENDIF
.
.          MOVE      "W4",CATEGORY
          MOVE      "VL",CATEGORY
          MOVE      WTSULSTS,CODE
          CALL      GETCOD00
          WRITE     HTMLFILE;"<td>",TDESC,"&nbsp;</td>";
.
          MOVE      "WN",CATEGORY
          MOVE      WTSUREAS,CODE
          CALL      GETCOD00
          WRITE     HTMLFILE;"<td>",TDESC,"&nbsp;</td></tr>"
.
          GOTO      SUNTAB10
.
SUNTAB99  RETURN
.------------------------------------------------------------
. Category Change History Table
.------------------------------------------------------------
CTHI0000  PACK      KEY19,CASEKEYS,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,CTHI9999
.
          PACK      KEY29,WMURNO,WMCODE,WMCNT,ANST,ANSP,SP20
          CALL      RSWTCAT2                * Position on & read code changes
CTHI1000  CALL      RKWTCAT2                  file record
          BRANCH    OVRCD,CTHI9999
.
          MATCH     WMURNO,WTCAURNO
          GOTO      CTHI9999 IF NOT EQUAL   * Different U/R no
.
          MATCH     WMCODE,WTCAPROC
          GOTO      CTHI9999 IF NOT EQUAL   * Different procedure code
.
          COMPARE   WMCNT,WTCAPCNT
          GOTO      CTHI9999 IF NOT EQUAL   * Different procedure count
.
          MATCH     "TP",WTCACATF
          GOTO      CTHI9999 IF NOT EQUAL   * Different category
.
          WRITE     HTMLFILE;"<tr><td><img src=#"../images/EditIcon.gif#"":
                             " class=ListIcon onclick='UpdateCategory(#"":
                             CASEKEYS,"#",#"",WTCAEDAT,"#");'>"
          MOVE      SP70,CMON
          UNPACK    WTCAEDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      ZERO,F2
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;"":
                    CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>";
.
          MATCH     SP70,WTCACODF
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp</td>";
            GOTO      CTHI1500
          ENDIF
.
          PACK      KEY5,ANST,ANSP,WTCACODF,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            WRITE     HTMLFILE;"<td>",TDESC,"</td>";
          ENDIF
.
CTHI1500  MATCH     SP70,WTCACODT
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp</td>";
            GOTO      CTHI1600
          ENDIF
.
          PACK      KEY5,ANST,ANSP,WTCACODT,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            WRITE     HTMLFILE;"<td>",TDESC,"</td>";
          ENDIF
.
CTHI1600  MOVE      SP70,CMON
          UNPACK    WTCAADTE,CCENT,CYEAR,CMON,CDAY
          MOVE      ZERO,F2
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;"<td>":
                    CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>";
.
          PACK      KEY10,WTCAWEBI,SP70
          CALL      RDWBSE1
          IF        OVRCD = 1
            MOVE      SP70,WBSENAM
          ENDIF
          WRITE     HTMLFILE;"<td>":
                    WBSENAM,"&nbsp;</td>";
.        
          GOTO      CTHI1000
.
CTHI9999  RETURN
.------------------------------------------------------------
. Booking History Table
.------------------------------------------------------------
BOKH0000  BRANCH    FLDITMNO,BOKH0010,BOKH0020
          GOTO      BOKH9999
.
BOKH0010  CALL      BKHI0000       *booking history
          GOTO      BOKH9999
.
BOKH0020  MOVE      "1",WABKHIST     * wa booking history format
          CALL      BKHI0000       * booking history
          GOTO      BOKH9999
.
BOKH9999  RETURN
+
.------------------------------------------------------------
. Booking History Table
.------------------------------------------------------------
BKHI0000  PACK      KEY19,CASEKEYS,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,BKHI9999
.
          PACK      KEY16,WMURNO,SP70
          CALL      RSBKREC6
BKHI1000  CALL      RKBKREC6
          BRANCH    OVRCD,BKHI9999
.
.
          MATCH     WMURNO,BKREURNO
          GOTO      BKHI9999 IF NOT EQUAL
.
          MATCH     BKREPROC,WMCODE
          GOTO      BKHI1000 IF NOT EQUAL
.
          MATCH     DBKRECNT,DWMCNT
          GOTO      BKHI1000 IF NOT EQUAL
.
          PACK      KEY8,DBKREBOO,SP70
          CALL      RDBKRX11
          BRANCH    OVRCD,BKHI1000
.
          WRITE     HTMLFILE;"<tr><td><img src=#"../images/EditIcon.gif#"":
                             " class=ListIcon onclick='UpdateBooking(#"":
                             CASEKEYS,"#",#"",DBKREBOO,"#");'>"
          MOVE      SP70,CMON
          UNPACK    BKREBKDT,CCENT,CYEAR,CMON,CDAY
          MOVE      ZERO,F2
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY21,WTSUURNO,WTSUCODE,WTSUCNT,WTSUSCNT,SP70
          WRITE     HTMLFILE;"":
                    CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>";
.
          MOVE      SP70,CMON
          UNPACK    BKREEDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      ZERO,F2
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY21,WTSUURNO,WTSUCODE,WTSUCNT,WTSUSCNT,SP70
          WRITE     HTMLFILE;"<td>":
                    CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP1,BKREATIM,"</td>";
.
          MOVE      SP70,CMON
          WRITE     HTMLFILE;"<td>";
          IF        WABKHIST=1
            MATCH     SP70,BKRXCNDT
            IF        !@EQUAL
              UNPACK    BKRXCNDT,CCENT,CYEAR,CMON,CDAY
              MOVE      ZERO,F2
              MOVE      CMON,F2
              LOAD    MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
              WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
            ENDIF
          ELSE
            MATCH     SP70,BKREADAT
            IF        !@EQUAL
              UNPACK    BKREADAT,CCENT,CYEAR,CMON,CDAY
              MOVE      ZERO,F2
              MOVE      CMON,F2
              LOAD    MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
              WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
            ENDIF
          ENDIF
          WRITE     HTMLFILE;"</td>";
.
          MOVE      "BC",CATEGORY
          MOVE      BKRECANC,CODE
          CALL      GETCOD00
          WRITE     HTMLFILE;"<td>",TDESC,"&nbsp;</td>";
.
          MOVE      "Booked       ",BOOKSTAT
          LOAD      BOOKSTAT,BKRESTAT,WAITST03,BOOKST02,WAITST04,WAITST05 
          WRITE     HTMLFILE;"<td>",BOOKSTAT,"</td>";
.
          GOTO      BKHI1000
.
BKHI9999  RETURN
.------------------------------------------------------------
. Category Change values        
.------------------------------------------------------------
DICC0000  BRANCH    FLDITMNO,DICC0100,DICC0200,DICC0300,DICC0400,DICC0500:
                             DICC0600,DICC0700,DICC0800
          GOTO      DICC9999
.
DICC0100  MATCH     SP70,WTCAEDAT
          GOTO      DICC9999 IF EQUAL
          UNPACK    WTCAEDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      DICC9999
.
DICC0200  MOVE      "TP",CATEGORY
          MOVE      WTCACODF,CODE
          CALL      CODITM00
          GOTO      DICC9999
.
DICC0300  MOVE      "TP",CATEGORY
          MOVE      WTCACODT,CODE
          CALL      CODITM00
          GOTO      DICC9999
.
DICC0400  MOVE      ZERO,EXIT                * ESIS sealed for this record
          PACK      KEY8,Z70                 * 0=No 1=Yes
          CALL      RSWTEST1
          CALL      RPWTEST1
          BRANCH    OVRCD,DICC0450
          MATCH     WTCAEDAT,WTESSDAT
          GOTO      DICC0450 IF LESS
          MOVE      ONE,EXIT

DICC0450  WRITE     HTMLFILE;EXIT;
          GOTO      DICC9999
.
DICC0500  MATCH     WTCAEDAT,WMDATE1         * First clinical urgency record?
          IF        @EQUAL
            WRITE     HTMLFILE;ONE;
          ELSE
            WRITE     HTMLFILE;ZERO;
          ENDIF
          GOTO      DICC9999
.
DICC0600  MATCH     SP70,WTCAEDAT
          GOTO      DICC9999 IF EQUAL
          WRITE     HTMLFILE;WTCAEDAT;
          GOTO      DICC9999
.
DICC0700  MATCH     SP70,WTCAADTE
          GOTO      DICC9999 IF EQUAL
          UNPACK    WTCAADTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      DICC9999
.
. Last clinical urgency file record?
.
DICC0800  MATCH     SP70,UPDTTYPE           * Only used on update page display
          GOTO      DICC9999 IF NOT EQUAL
.
          MATCH     SP70,EFFCDATE           * record key
          GOTO      DICC9999 IF EQUAL

          PACK      KEY29,WMURNO,WMCODE,WMCNT,ANST,ANSP,Z70
          CALL      RSWTCAT2                * Position on & read code changes
          CALL      RPWTCAT2                  file record
          BRANCH    OVRCD,DICC0850
.
          MATCH     WMURNO,WTCAURNO         * U/R
          GOTO      DICC0850 IF NOT EQUAL
.
          MATCH     WMCODE,WTCAPROC         * Procedure
          GOTO      DICC0850 IF NOT EQUAL
.
          COMPARE   WMCNT,WTCAPCNT          * Procedure count
          GOTO      DICC0850 IF NOT EQUAL
.
          MATCH     "TP",WTCACATF           * Priority Change
          GOTO      DICC0850 IF NOT EQUAL
.
          MATCH     EFFCDATE,WTCAEDAT       * Last record on file 
          IF        @EQUAL
            MATCH     WTCACODT,WMPTY        * Same clinical urgency to
            IF        @EQUAL
              WRITE     HTMLFILE;ONE;
            ENDIF
          ENDIF
.
DICC0850  MATCH     SP70,EFFCDATE           * Restore original record
          IF        !@EQUAL
            MOVE      CASEKEYS,KEY19
            PACK      KEY29,KEY19,ANST,ANSP,EFFCDATE,SP70
            CALL      RDWTCAT2
          ENDIF
.
          GOTO      DICC9999
.
DICC9999  RETURN
+
.------------------------------------------------------------
. Ward selection
.------------------------------------------------------------
WSEL0000  PACK      KEY29,SP70
          IF        IBCNMHOS = 1
            PACK      KEY29,SP3,WBSEHOSP,SP70
          ENDIF
          CALL      RDSWARD7
WSEL0100  CALL      RDKWARD7
          BRANCH    OVRCD,WSEL9999
.
.                         if we have a bed number we have passed all the ward
.                         master records, so exit
          MATCH     SP70,WBED
          GOTO      WSEL9999 IF NOT EQUAL
.
          COMPARE   WACTIVE,ZERO                 *List only active wards
          GOTO      WSEL0100 IF NOT EQUAL
.
          IF        IBCNMHOS = 1
            MATCH      SP3,WBSEHOSP
            IF        !@EQUAL
              MATCH     WBSEHOSP,PTWDHOSN
              GOTO      WSEL9999 IF NOT EQUAL
            ENDIF
          ENDIF
.
.                       write the select option.
          WRITE     HTMLFILE;"<option value=#"",WWARD,"#"";
          MATCH     DFLTWARD,WWARD
          IF        @EQUAL
            WRITE     HTMLFILE;" selected";
          ENDIF
          WRITE     HTMLFILE;">",WBDESC;
.
          IF        IBCNMHOS = 1
            MATCH      SP3,WBSEHOSP
            IF        @EQUAL
              WRITE     HTMLFILE;" - ",PTWDHOSN;
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"</option>"
          GOTO      WSEL0100
.
WSEL9999  RETURN
.
.------------------------------------------------------------
.   Waiting List Extract Table: Display,Update
.------------------------------------------------------------
WATEPS00  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      WATEPS40 IF EQUAL
.
          MATCH     "A",UPDTTYPE    * Add formaction     NOT USED!!!!!!!!
          GOTO      WATEPS10 IF EQUAL
.
          MATCH     "U",UPDTTYPE    * Update formaction
          GOTO      WATEPS20 IF EQUAL
.
          MATCH     "D",UPDTTYPE    * Delete formaction  NOT USED!!!!!!!!  
          GOTO      WATEPS30 IF EQUAL
.
          GOTO      WATEPS93
.
.         ************ ADD FORMACTION ***********
.
WATEPS10  CALL      CHKEPS00      * Checks mandatory fields
          BRANCH    EXIT,WATEPS99
.
          PACK      KEY23,WATEP001,WATEP002,WATEP003,WATEP004,SP70
          CALL      RDWTEPS1
          COMPARE   ZERO,OVRCD
          GOTO      WATEPS92 IF EQUAL
.
          CALL      SAVEPS00         * Moves input variables to file variables
          PACK      KEY23,WATEP001,WATEP002,WATEP003,WATEP004,SP70
          CALL      WRWTEPS1         * Writes away the data
.
          MOVE      ZERO,EXIT
          GOTO      WATEPS99
.
.         ************ UPDATE FORMACTION **********
.
WATEPS20  PACK      KEY23,WATEP001,WATEP002,WATEP003,WATEP004,SP70 
          CALL      RDWTEPS1
          BRANCH    OVRCD,WATEPS91
.
.          CALL      CHKEPS00      * Checks mandatory fields
.          BRANCH    EXIT,WATEPS99
.
          CALL      RLWTEPS1      * Read Lock Record
          CALL      SAVEPS00      * Moves input variables to file variables
          CALL      UPWTEPS1      * Writes away the data
          CALL      UUWTEPS1      * Unlocks IO
.
          MOVE      ZERO,EXIT
          GOTO      WATEPS99
.
.         ************ DELETE FORMACTION **********
.
WATEPS30  PACK      KEY23,WATEP001,WATEP002,WATEP003,WATEP004,SP70  
          CALL      RDWTEPS1
          BRANCH    OVRCD,WATEPS91
.
          CALL      DEWTEPS1       * Does Cascading Delete on Beds
.
          MOVE      ZERO,EXIT
          GOTO      WATEPS99
.
.         ************ DISPLAY FORMACTION **********
.
WATEPS40  PACK      KEY4,WATEP001,SP70   * Read Extract Record
          CALL      RDWTEXT1
          BRANCH    OVRCD,WATEPS94

          PACK      KEY23,WATEP001,WATEP002,WATEP003,WATEP004,SP70  
          CALL      RDWTEPS1
          IF        OVRCD=1
            CALL      CLREPS00    * Clear all the file variables
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Waiting List Extract Table Maintenance",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,WATEPS99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      WATEPS99
.
WATEPS91  MOVE      "Extract does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      WATEPS99
.
WATEPS92  MOVE      "Extract record exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      WATEPS99
.
WATEPS93  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      WATEPS99
.
WATEPS94  MOVE      "Invalid Waiting List Extract.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      WATEPS99
.
WATEPS99  RETURN
.---------------------------------------------------------------------------
.  Clears File Data
.---------------------------------------------------------------------------
CLREPS00  MOVE      SP70,WTEPEID   * Extract ID
          MOVE      SP70,WTEPURN   * U/R Number
          MOVE      SP70,WTEPPRO   * Procedure
          MOVE      SP70,WTEPCNT   * Count
          MOVE      SP70,WTEPDEL   * Deleted from Extract 0=No
          MOVE      SP70,WTEPSPA   * Spare
.
CLREPS99  RETURN
.---------------------------------------------------------------------------
.  Saves CGI Parameters
.---------------------------------------------------------------------------
SAVEPS00  MOVE      WATEP001,WTEPEID   * Extract ID 
          MOVE      WATEP002,WTEPURN   * U/R Number
          MOVE      WATEP003,WTEPPRO   * Procedure
          MOVE      WATEP004,WTEPCNT   * Count
          MOVE      WATEP005,WTEPDEL   * Deleted from Extract 0=No
          MOVE      SP70,WTEPSPA       * Spare
.
SAVEPS99  RETURN
.-------------------------------------------------------------------------
. * Checks mandatory fields
.-------------------------------------------------------------------------
CHKEPS00  RESET     WATEP005
          MATCH     SP70,WATEP005
          GOTO      CHKEPS90 IF EQUAL
.
          GOTO      CHKEPS98
.
CHKEPS90  MOVE      " ##### ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKEPS99
.
CHKEPS98  MOVE      ZERO,EXIT
CHKEPS99  RETURN
.------------------------------------------------------------
.         Waiting List Download Extraction
.------------------------------------------------------------
WATDWN00  PACK      KEY23,WATEX001,SP70
          CALL      RSWTEPS1
          CALL      RKWTEPS1
          BRANCH    OVRCD,WATDWN90 
.
.  Set Nextpage and redirect
.
          MOVE      ".txt",KEY4
          CLEAR     KEY13
          APPEND    "extrc",KEY13
          APPEND    WATEX001,KEY13 
          APPEND    KEY4,KEY13   
          RESET     KEY13
.
          MOVE      "91",SECTOR
          READ      CONTROLF,SECTOR;*179,CWEBROOT
          MOVE      "104",SECTOR
          READ      CONTROLF,SECTOR;RSCNEXT
.
          STRIP     CWEBROOT
          MOVELPTR  CWEBROOT,F3
          RESET     RSCNEXT,F3
          MOVE      RSCNEXT,KEY40
.
          MOVE      "..",KEY2
          PACK      REDIRECT,KEY2,KEY40,KEY13
          SQUEEZE   REDIRECT
          MOVE      ONE,NEXTPAGE
.
          MOVE      ZERO,EXIT
          GOTO      WATDWN99
.
WATDWN90  MOVE      "Waiting List Patient Extract Table is empty ",WEBTITLE
          ENDSET    WEBTITLE
          APPEND    "for Extract Id:",WEBTITLE
          APPEND    WATEX001,WEBTITLE 
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      WATDWN99
.
WATDWN99  RETURN
.------------------------------------------------------------
. Waiting List Booking Details Update
.------------------------------------------------------------
WATBOK00  CALL      CLBOKREC
          CALL      CLBKRX00
          MOVE      CASEKEYS,KEY19
          CALL      RDTREA1
          BRANCH    OVRCD,WATBOK95
.
          MOVE      CASEKEYS,KEY19
          CALL      RDWTTX11
          BRANCH    OVRCD,WATBOK95
.
          MATCH     "2",TAKEBSTA
          IF        !@EQUAL
            MATCH     "6",DWMSTAT
            GOTO      WATBOK93 IF EQUAL
          ENDIF
.
          MOVE      WMURNO,URNUMBER
          MOVE      URNUMBER,KEY8           * visit number
          CALL      RDMAST1
          BRANCH    OVRCD,WATBOK95
          CALL      RDPMPX21
          BRANCH    OVRCD,WATBOK95 
.
          MATCH     "A",UPDTTYPE       * Add New
          GOTO      WATBOK10 IF EQUAL
          MATCH     "U",UPDTTYPE       * Update
          GOTO      WATBOK20 IF EQUAL
          MATCH     "D",UPDTTYPE       * Delete
          GOTO      WATBOK30 IF EQUAL
          MOVE      "Invalid Update Type",WEBTITLE
          CALL      WEBERR00
          GOTO      WATBOK99
.
WATBOK10  MATCH     "0",TAKEBSTA
          GOTO      WATBOK11 IF EQUAL
.
          MATCH     "2",TAKEBSTA
          GOTO      WATBOK11 IF EQUAL
.
          COMPARE   ONE,WMSTAT
          GOTO      WATBOK11 IF EQUAL
          COMPARE   TWO,WMSTAT
          GOTO      WATBOK96 IF NOT EQUAL
.
WATBOK11  MATCH     SP70,BKREC004
          GOTO      WATBOK97 IF EQUAL
          MATCH     Z70,BKREC004
          GOTO      WATBOK97 IF EQUAL
          MATCH     SP70,BKREC008
          GOTO      WATBOK98 IF EQUAL
          MATCH     Z70,BKREC008
          GOTO      WATBOK98 IF EQUAL
.
          COMPARE   ONE,TAKEUPFL
          IF        !@EQUAL
            CALL      CHKSUS00
            BRANCH    EXIT,WATBOK94
          ENDIF
.
          CALL      ADDBOK00
          COMPARE   ZERO,WTMEEND
          CALL      WRCOM000 IF NOT EQUAL
.
          MATCH     ADMISNID,SP70
          IF        !@EQUAL
            MOVE      ZERO,F1
            MOVE      SEVEN,KEY1
            MOVE      BKREBOOK,KEY8
            PROC      UPEADMVS               * Update eAdmssion Details
          ENDIF
.
          MATCH     CORSP001,SP70
          IF        !@EQUAL
            MOVE      ONE,F1
            MOVE      BKREBOOK,KEY8
            PROC      UPEADMVS               * Add Correspondence to Theatre Booking
          ENDIF
.
          IF        PTCNHDPS=1
            PACK      ADMISSNO,BKREBOOK,SP70
            CALL      WRPORD000             * Write ACC Purchase Order no
          ENDIF
.
          CALL      NXTPAG00
          GOTO      WATBOK99
.
WATBOK20  CALL      UPDBOK00
          COMPARE   ZERO,WTMEEND
          CALL      WRCOM000 IF NOT EQUAL
          IF        PTCNHDPS=1
            PACK      ADMISSNO,BKREBOOK,SP70
            CALL      WRPORD000             * Write ACC Purchase Order no
          ENDIF
.
          CALL      NXTPAG00
          GOTO      WATBOK99
.
WATBOK30  CALL      DELBOK00 
          BRANCH    EXIT,WATBOK99
          COMPARE   ZERO,WTMEEND
          CALL      WRCOM000 IF NOT EQUAL
.
          CALL      NXTPAG00 
          GOTO      WATBOK99
.
WATBOK93  MOVE      "Cannot Add/Update as Patient is Removed",WEBTITLE
          CALL      WEBERR00
          GOTO      WATBOK99
.
WATBOK94  MOVE      "Patient Not Ready for Care",WEBTITLE
          CALL      WEBERR00
          GOTO      WATBOK99
.
WATBOK95  MOVE      "Invalid Waiting List Case Key",WEBTITLE
          CALL      WEBERR00
          GOTO      WATBOK99
.
WATBOK96  MOVE      "Invalid Status for New Booking",WEBTITLE
          CALL      WEBERR00
          GOTO      WATBOK99
.
WATBOK97  MOVE      "Expected Due Date Required",WEBTITLE
          CALL      WEBERR00
          GOTO      WATBOK99
.
WATBOK98  MOVE      "Booking Type Required",WEBTITLE
          CALL      WEBERR00
          GOTO      WATBOK99
.
WATBOK99  CLOSE     COMFILAF,DELETE
          RETURN
.----------------------------------------------------------------------
. Update the scheduled admission date on waiting list files
.----------------------------------------------------------------------
WATSCH00  MOVE      CASEKEYS,KEY19
          CALL      RDTREA1
          BRANCH    OVRCD,WATSCH99
          CALL      RDWTTX11
          BRANCH    OVRCD,WATSCH99
.
.          CALL      CLWATHIS
          PACK      KEY19,WMURNO,WMCODE,WMCNT,SP70
          CALL      RDWTRTD1
          IF        OVRCD=1
            MOVE     SP70,WTRTREFR
            MOVE     SP70,WTRTTDES
          ENDIF
.
          CALL      SAVHIS00                     * save history
          IF        TAKEUPFL<>1
            MOVE      TWO,WMSTAT
          ENDIF
. 
          CALL      MVWDET00                     * Hps new 
          MOVE      BKREEDAT,WMDATE3             * set the date
.
          MOVE      "01",WTWMBSCD                * Add Booking code
          CALL      UPTREA1
.
          MOVE      WATHI001,SAVERDT3
          MOVE      ONE,NBRFLAG
.
          MOVE      ZERO,ADDWLFLG
          CALL      WRTHIS00                     * write history
.
          IF        TAKEUPFL=1
            CALL      SAVHSS00                     * save history
            MOVE      "30",WTWMBSCD                * Add Booking code
            CALL      WRITSS00                     * Bypass normal history 
          ENDIF                                    * functions for take up data
.
          MOVE      CASEKEYS,KEY19
          CALL      RDWTTX11
          BRANCH    OVRCD,WATSCH99
.
          CALL      SVWTTX00                     * Hps New 
.
          MOVE      BKREATIM,WTTXPATM            * Proposed admission time
          CALL      IBACLOCK                     * get current date
          PACK      WTTXLUPD,CCC,CYY,CMM,CDD
          REP       " 0",WTTXLUPD
          CLOCK     TIME,WTTXLUPT
          MOVE      USERID,WBSEUID 
.
          CALL      UPWTTX11 
.
          MATCH     SP70,WTTXDPRC
          GOTO      WATSCH99 IF EQUAL
          PACK      KEY19,WMURNO,WTTXDPRC,WTTXDPCN
          CALL      RDTREA1
          BRANCH    OVRCD,WATSCH99
.
          MOVE      "9",WMSTAT
          CALL      UPTREA1
.
WATSCH99  RETURN
.----------------------------------------------------------------------
. Update URA
.----------------------------------------------------------------------
...********** Removed for Demo **************
UPDURA00  
...          PACK      URDATE,CCC,CYY,CMM,CDD
...          REP       " 0",URDATE
....
....
...POST2200  COMPARE   ONE,CPMIAD
...          GOTO      POST3200 IF NOT EQUAL   * not using audit
...          OPEN      PATURAD1,"paturadf"     * open audit file
...          OPEN      PATURAD2,"paturadf"     * open audit file
....
...POST3000  PACK      KEY17,PURNO,ANSC,SP10
...          CALL      RDSURAD2
...          CALL      RDKURAD2
...          BRANCH    OVRCD,POST3100          * end of file
....
...          MATCH     URURNO,PURNO
...          GOTO      POST3100 IF NOT EQUAL   * different patient
....
....         delete old record
.
...          PACK      KEY17,URRTYPE,URDATE,URURNO
...          CALL      DEURAD1
...          GOTO      POST3000
....
....         write record
....
...POST3100  PACK      URDATE,CCC,CYY,CMM,CDD
...          REP       " 0",URDATE
...          MOVE      "3",URSYST              * set system
...          MOVE      PURNO,URURNO            * set U/R Number
...          MOVE      ANSC,URRTYPE            * set record type
...          PACK      KEY17,URRTYPE,URDATE,URURNO
...          CALL      WRURAD1
...          CLOSE     PATURAD2                * close audit file
UPDURA99  RETURN
.------------------------------------------------------------
. Create Booking Medical/Maternity
.------------------------------------------------------------
ADDBOK00  MOVE      WMBOOK,BKREBOOK         * set the booking number
          MOVE      BKREBOOK,AADMNO
          MOVE      PSNAME,BKRESNAM         * surname
          MOVE      PURNO,BKREURNO          * U/R Number
          UNPACK    CASEKEYS,KEY8,BKREC013,BKREC014
.
          CALL      CLBOKREC
          CALL      CLBKRX00
          MOVE      SP70,BKRXCNDT
          CALL      MVBOK000                * Move in Booking Details
          CALL      MVBKRX00                * Move in Booking Exnt Details
.
          COMPARE   ONE,TAKEUPFL
          IF        !@EQUAL
            MATCH     BKRXCNDT,BKREEDAT
            GOTO      ADDBOK94 IF LESS
          ENDIF
.
          MATCH     SP70,DBKREBOO
          IF        @EQUAL
            MOVE      WMBOOK,DBKREBOO
          ENDIF
.
          MATCH     SP70,BKREADOC 
          IF        @EQUAL
             MOVE      WMDOCTOR,BKREADOC     * Attending Doctor 
          ENDIF
.
          PACK      KEY6,BKREADOC,SP70
          CALL      RDDOCT1
          BRANCH    OVRCD,ADDBOK95
.
          BRANCH    DRSTAT,ADDBOK95          * Can not book to inactive doctor
.
          MATCH     SP70,BKRESDOC
          IF        @EQUAL
....         MOVE      WTWMRFGP,BKRESDOC     * Referring GP
          ENDIF
.
          MATCH     SP70,BKREEDAT
          IF        @EQUAL
            MOVE      WMDATE3,BKREEDAT
          ENDIF
.
          CALL      IBACLOCK                * get current date
          PACK      BKREADAT,CCC,CYY,CMM,CDD
          REP       " 0",BKREADAT           * date of addition
.
          MATCH     Z70,BKREC039
          IF        !@EQUAL
            MATCH     SP70,BKREC039
            IF        @EQUAL
              MOVE      SP70,BKREADAT
            ELSE
              UNPACK    BKREC039,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      BKREADAT,CCENT,CYEAR,CMON,CDAY
              REP       " 0",BKREADAT
            ENDIF
          ENDIF
.
          MOVE      "M",BKRETYPE
          MATCH     Z70,BKREC008
          IF        !@EQUAL
            MOVE      BKREC008,BKRETYPE
          ENDIF
          MOVE      SP20,BKRECANC
          MATCH     Z70,BKREC009
          IF        !@EQUAL
            MOVE      BKREC009,BKRECANC
          ENDIF
.
          MOVE      "0",BKRESTAT            * Set status equals booked
.         
          MATCH     SP70,BKREPROC
          IF        @EQUAL
            MOVE      WMCODE,BKREPROC
          ENDIF
.
          MATCH     SP70,DBKRECNT
          IF        @EQUAL
            MOVE      WMCNT,DBKRECNT
          ENDIF
.
          MATCH     SP70,BKREDEPT
          IF        @EQUAL
            MOVE      WMUNIT,BKREDEPT    
          ENDIF
. 
          MATCH     SP70,BKRECLMT
          IF        @EQUAL
            MOVE      WTTXCTYP,BKRECLMT    
          ENDIF
.
          CALL      IBACLOCK
          PACK      BKREBKDT,CCC,CYY,CMM,CDD          
          REP       " 0",BKREBKDT
.
          MATCH     Z70,BKREC034
          IF        !@EQUAL
            MATCH     SP70,BKREC034
            IF        !@EQUAL
              UNPACK    BKREC034,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      BKREBKDT,CCENT,CYEAR,CMON,CDAY
              REP       " 0",BKREBKDT
            ENDIF
          ENDIF
.
          MATCH     SP70,BKRXBNUM
          IF        @EQUAL
            MOVE      DBKREBOO,BKRXBNUM        * U/R Number 
          ENDIF
.
          MATCH     SP70,BKRXPOWD
          IF        @EQUAL
            MOVE      WTTXPOWD,BKRXPOWD        * Post-Op Ward    
          ENDIF
.
          MATCH     SP70,BKRXADWD
          IF        @EQUAL
            MOVE      WTTXADMW,BKRXADWD        * Admitting Ward 
          ENDIF
.
.          PACK      BKRXCDTE,CCC,CYY,CMM,CDD  
.          REP       " 0",BKRXCDTE
.
          MATCH     SP70,BKRXPSTY
          IF        @EQUAL
            MOVE      WTTXPSTY,BKRXPSTY    
          ENDIF
.
.         MATCH     SP70,BKRXCNDT
.         IF        @EQUAL
.           MOVE      WTTXCDTE,BKRXCNDT
.         ENDIF
.
          PACK      KEY5,ANSX,ANSB,WTTXIDYC,SP70
          CALL      RDCODE1
          IF        OVRCD = 0
            MATCH     "1",TCINDC1          
            IF        @EQUAL
               MOVE      BKREEDAT,BKRXODTE
            ENDIF
          ENDIF
.
          PACK      BKRXCRDT,CCC,CYY,CMM,CDD  
          REP       " 0",BKRXCRDT
.
          CLOCK     TIME,BKRXCRTM
          MOVE      WBSEUID,BKRXWEBC
.
          PACK      BKRXLUPD,CCC,CYY,CMM,CDD  
          REP       " 0",BKRXLUPD
.
          CLOCK     TIME,BKRXLUPT
          MATCH     SP70,BKRXWEBU
          IF        @EQUAL
            MOVE      WBSEUID,BKRXWEBU    
          ENDIF
.
          MOVE      WTTXADMF,BKRXFORM       * forms for booking
.
          MATCH     WMDATE1,BKREEDAT
          GOTO      ADDBOK92 IF LESS
.
          COMPARE   ONE,TAKEUPFL
          IF        !@EQUAL
            MATCH     SP70,BKRXODTE
            IF        !@EQUAL
              MATCH     BKREEDAT,BKRXODTE
              GOTO      ADDBOK93 IF LESS
            ENDIF
          ELSE
            MATCH     SP70,TAKEBSTA
            IF        !@EQUAL
              MOVE      TAKEBSTA,BKRESTAT        * Booked or Cancelled Only
              IF        BKRESTAT=2
                CALL      GENBOKNO
                MOVE      WMBOOK,BKREBOOK
              ENDIF
            ELSE
              MOVE      TWO,BKRESTAT
            ENDIF
          ENDIF
.
          UNPACK    KEY8,DBKREBOO
.
          MATCH     Z70,WATTR004
          IF        !@EQUAL
            MOVE      WATTR004,BKDIDES2       * for Reason/Diagnosis
          ENDIF
.
          MATCH     Z70,BKREC037
          IF        !@EQUAL
            MOVE       BKREC037,BKDIDES2
          ENDIF
.
          MOVE      BKREBOOK,KEY8           * booking number
          CALL      RABKREC1                * Check if already exists
          COMPARE   ONE,OVRCD
          GOTO      ADDBOK91 IF NOT EQUAL   * Already exists or locked
.
          CALL      WRBKREC1                * write record to booking file
.
          CALL      WRCB0000
.
          MATCH     SP70,BKRETYPE
          GOTO      ADDBOK10 IF EQUAL
.
          PACK      KEY5,ANSB,ANSK,BKRETYPE,SP70
          CALL      RDCODE1          * allow usage if indicator 3=1
          BRANCH    OVRCD,ADDBOK10
.
          MATCH     "1",TCINDC3
          GOTO      ADDBOK10 IF NOT EQUAL
.
          CALL      WRUSG000         * write theatre usage unique id table
.
ADDBOK10  CALL      WRINT000                * write interpreter details
.
          PACK      WTENEVDT,BKREBKDT   * Write ESIS Intra Episode Record
          PACK      WTENEVAL,BKREEDAT
          MOVE      ANSS,WTENETYP
          PACK      WTENSADI,DBKREBOO,SP70
          CALL      WSAD0000
.
          MOVE      DBKREBOO,BKRXBNUM
          MATCH     SP70,BOKRX003
          IF        @EQUAL
             MOVE      WTTXADMW,BKRXPOWD
          ENDIF
          PACK      KEY8,DBKREBOO,SP70
          CALL      RABKRX11
          IF        OVRCD=1
            CALL      WRBKRX11                * write record to booking details
          ELSE
            CALL      UPBKRX11
          ENDIF
.
          IF        PTCNHDPS=1
            PACK      ADMISSNO,DBKREBOO,SP70
            CALL      WRPORD00       * Write acc purchase order number
          ENDIF
.
          CALL      SAVHIS00                * write to Waiting List History
          MOVE      ONE,NBRFLAG
          CALL      WHIS0000          
          MOVE      "01",WTWMBSCD
.
          MATCH     "0",TAKEBSTA              * We only want to add a booking
          GOTO      ADDBOK99 IF EQUAL         * if tabebsta=0 so do not update
.                                             * wattr1af or generate new WMBOOK
          MATCH     "2",TAKEBSTA              * We only want to add a canc book
          GOTO      ADDBOK99 IF EQUAL         * if tabebsta=2 so do not update
                                              * wattr1af or generate new WMBOOK
.
          IF        TAKEUPFL=1
            PACK      KEY19,CASEKEYS,SP70
            CALL      RDTREA1
            BRANCH    OVRCD,ADDBOK96
            MOVE      ONE,WMSTAT              * Return to waiting list
            MOVE      SP70,WMDATE3            * Removing proposed admission date
            CALL      GENBOKNO                * Get WL Booking Number
            CALL      UPTREA1
            MOVE      "30",WTWMBSCD
            CALL      WHIS0000
          ENDIF
.
.         check box check  ???
.
.         MOVE      "01",WTWMBSCD
          MOVE      BKREBKDT,SAVBMDT           
          MOVE      BKREADAT,SAVDBFT
.
          MATCH     Z70,BKREC034
          IF        !@EQUAL
            MATCH     SP70,BKREC034
            IF        !@EQUAL
              MOVE    BKREBKDT,SAVBMDT
            ENDIF
          ENDIF
.
.          CALL      WLHISSOB
.
...         COMPARE   ONE,OPCNBKBD
...         GOTO      POST2000 IF NOT EQUAL   * no booking date audit
...         OPEN      BOKBUDA1,"bokbudaf"     * open booking date audit file
...         CALL      WRBKBUD1                * write to booking date audit file
...         CLOSE     BOKBUDA1
.
          CALL      WATSCH00                * Update the Waiting List
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      FOUR,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICUB                * DG API Pre-Admis Booking *I-90203
.
          MOVE      SEVEN,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLIWLB                * HL7 A05 - W/L Booking
.
          MOVE      TEN7,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLIUWL                * HL7 - Update Waiting List Entry
.
          CALL      UPDURA00                * Update UR Audit
.
.
. New Code to print letters
.
          IF        LETTREQD = 1
            CALL     PWTLET00
          ENDIF
.
          MOVE      ZERO,EXIT
          MATCH     SP9,BKDICODE
          GOTO      ADDBOK20 IF NOT EQUAL   * have a code
          MATCH     SP30,BKDIDES1
          GOTO      ADDBOK20 IF NOT EQUAL   * have a desc
          MATCH     SP30,BKDIDES2
          GOTO      ADDBOK20 IF NOT EQUAL   * have a desc
          MATCH     SP30,BKDICOMM
          GOTO      ADDBOK99 IF EQUAL       * dont have comments
.
ADDBOK20  MOVE      BKREBOOK,BKDIBOOK       * set booking number
          PACK      BKDIUNIQ,SP9,ONE,SP70   * set unique number
          PACK      KEY18,BKREBOOK,SP9,ONE,SP70  * set booking number
          CALL      RABKDIA1
          IF        OVRCD=0
            CALL      UPBKDIA1                * update file
          ELSE      
            CALL      WRBKDIA1                * write details
          ENDIF
          MOVE      ZERO,EXIT
          GOTO      ADDBOK99
.
ADDBOK91  MOVE      "Booking Number in Use",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDBOK99
.
ADDBOK92  CLEAR     WEBTITLE
          APPEND    "Scheduled Admission Date must be greater than ",WEBTITLE
          APPEND    "Date on List",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDBOK99
.
ADDBOK93  CLEAR     WEBTITLE
          APPEND    "Proposed Admission Date must be Less ",WEBTITLE
          APPEND    "than Proposed Procedure Date",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDBOK99
.
ADDBOK94  CLEAR     WEBTITLE
          APPEND    "Admission Date must be Greater Than Or ",WEBTITLE 
          APPEND    "Equal To Confirmation Date",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDBOK99
.
ADDBOK95  CLEAR     WEBTITLE
          APPEND    "Can not book a patient with an inactive doctor",WEBTITLE 
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDBOK99
.
ADDBOK96  CLEAR     WEBTITLE
          APPEND    "Invalid treatment record.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDBOK99
.
ADDBOK99  RETURN
.------------------------------------------------------------
. Write  booking change audit
.------------------------------------------------------------
WRCB0000  PACK      WTCHURNO,WMURNO,SP70
          PACK      WTCHPROC,WMCODE,SP70
          PACK      WTCHPCNT,WMCNT,SP70
.
          CALL      IBACLOCK
          PACK      WTCHDATE,CCC,CYY,CMM,CDD
          REPLACE   " 0",WTCHDATE
          CLOCK     TIME,WTCHTIME
.
          PACK      WTCHUPTY,ONE,EIGHT,SP70
          PACK      WTCHREAS,SP70
          MOVE      USERID,WTCHUSID
          PACK      WTCHOVAL,DBKREBOO,SP70
          PACK      WTCHCVAL,SP70
.
          PACK      KEY35,WTCHURNO,WTCHPROC,WTCHPCNT,WTCHDATE,WTCHTIME,SP70
          CALL      RDWTCHA1
          IF        OVRCD=1
            CALL      WRWTCHA1
          ENDIF
.
WRCB9999  RETURN
+
.------------------------------------------------------------
. Write  change PPP  audit
.------------------------------------------------------------
WRPP0000  PACK      WTCHURNO,WMURNO,SP70
          PACK      WTCHPROC,WMCODE,SP70
          PACK      WTCHPCNT,WMCNT,SP70
.
          CALL      IBACLOCK
          PACK      WTCHDATE,CCC,CYY,CMM,CDD
          REPLACE   " 0",WTCHDATE
          CLOCK     TIME,WTCHTIME
.
          PACK      WTCHUPTY,TWO,FIVE,SP70
          PACK      WTCHREAS,REASONFC,SP70
          MOVE      USERID,WTCHUSID
          PACK      WTCHOVAL,OLDPROC,SP70
          PACK      WTCHCVAL,WMCODE,SP70
.
          PACK      KEY35,WTCHURNO,WTCHPROC,WTCHPCNT,WTCHDATE,WTCHTIME,SP70
          CALL      RDWTCHA1
          IF        OVRCD=1
            CALL      WRWTCHA1
          ENDIF
.
WRPP9999  RETURN
+
.------------------------------------------------------------
. Write suspension added audit
.------------------------------------------------------------
WRCS0000  MATCH     "22",WTCHUPTY    * always write a 22
          GOTO      WRCS1000 IF EQUAL
.
.         * only write 23 and 24 types for EDWARD sites
          READ      CONTROLF,HUND25;*93,PTCNNSSI
          MATCH     SP70,PTCNNSSI        * no edward source system
          GOTO      WRCS9999 IF EQUAL
.
          MATCH     ZERO20,PTCNNSSI        * no edward source system
          GOTO      WRCS9999 IF EQUAL
.
WRCS1000  PACK      WTCHURNO,WMURNO,SP70
          PACK      WTCHPROC,WMCODE,SP70
          PACK      WTCHPCNT,WMCNT,SP70
.
          CALL      IBACLOCK
          PACK      WTCHDATE,CCC,CYY,CMM,CDD
          REPLACE   " 0",WTCHDATE
          CLOCK     TIME,WTCHTIME
.
          PACK      WTCHREAS,SP70
          MOVE      USERID,WTCHUSID
          PACK      WTCHOVAL,SP70
          PACK      WTCHCVAL,WTSUFDAT,WTSUTDAT,WTSULSTS,WTSUREAS,DWTSUCNT,SP70
.
          PACK      KEY35,WTCHURNO,WTCHPROC,WTCHPCNT,WTCHDATE,WTCHTIME,SP70
          CALL      RDWTCHA1
          IF        OVRCD=1
            CALL      WRWTCHA1
          ENDIF
.
WRCS9999  RETURN
+
.------------------------------------------------------------
. Write  post op ward change audit
.------------------------------------------------------------
WRCP0000  PACK      WTCHURNO,WMURNO,SP70
          PACK      WTCHPROC,WMCODE,SP70
          PACK      WTCHPCNT,WMCNT,SP70
.
          CALL      IBACLOCK
          PACK      WTCHDATE,CCC,CYY,CMM,CDD
          REPLACE   " 0",WTCHDATE
          CLOCK     TIME,WTCHTIME
.
          PACK      WTCHUPTY,TWO,ONE,SP70
          PACK      WTCHREAS,SP70
          MOVE      USERID,WTCHUSID
          PACK      WTCHOVAL,SVTXPOWD,SP70
          PACK      WTCHCVAL,WTTXPOWD,SP70
.
          MOVE      ZERO,ADDSECND
.
WRCP0200  PACK      KEY35,WTCHURNO,WTCHPROC,WTCHPCNT,WTCHDATE,WTCHTIME,SP70
          CALL      RAWTCHA1
          IF        OVRCD=1
            CALL      WRWTCHA1
          ELSE
            IF        ADDSECND<=5
              ADD       ONE,ADDSECND
            ELSE
              GOTO      WRCP9999
            ENDIF
.
            UNPACK    WTCHTIME,HOUR,D1,MIN,D1,SEC
            PACK      XDATTIME,WTCHDATE,HOUR,MIN,SEC,SP70
            CALL      ASEC0000                     * add 1 sec to date/time
                                                   * to stop duplicate key
            UNPACK    XDATTIME,WTCHDATE,HOUR,MIN,SEC
            PACK      WTCHTIME,HOUR,COLON,MIN,COLON,SEC
            GOTO      WRCP0200
          ENDIF
.
WRCP9999  RETURN
+
.------------------------------------------------------------
. Write  intended stay change audit
.------------------------------------------------------------
WRCI0000  PACK      WTCHURNO,WMURNO,SP70
          PACK      WTCHPROC,WMCODE,SP70
          PACK      WTCHPCNT,WMCNT,SP70
.
          CALL      IBACLOCK
          PACK      WTCHDATE,CCC,CYY,CMM,CDD
          REPLACE   " 0",WTCHDATE
          CLOCK     TIME,WTCHTIME
.
          PACK      WTCHUPTY,TWO,NINE,SP70
          PACK      WTCHREAS,SP70
          MOVE      USERID,WTCHUSID
          PACK      WTCHOVAL,SVTXINTD,SP70
          PACK      WTCHCVAL,WTTXINTD,SP70
.
          MOVE      ZERO,ADDSECND
.
WRCI0200  PACK      KEY35,WTCHURNO,WTCHPROC,WTCHPCNT,WTCHDATE,WTCHTIME,SP70
          CALL      RAWTCHA1
          IF        OVRCD=1
            CALL      WRWTCHA1
          ELSE
            IF        ADDSECND<=5
              ADD       ONE,ADDSECND
            ELSE
              GOTO      WRCI9999
            ENDIF
.
            UNPACK    WTCHTIME,HOUR,D1,MIN,D1,SEC
            PACK      XDATTIME,WTCHDATE,HOUR,MIN,SEC,SP70
            CALL      ASEC0000                     * add 1 sec to date/time
                                                   * to stop duplicate key
            UNPACK    XDATTIME,WTCHDATE,HOUR,MIN,SEC
            PACK      WTCHTIME,HOUR,COLON,MIN,COLON,SEC
            GOTO      WRCI0200
          ENDIF
.
WRCI9999  RETURN
+
.------------------------------------------------------------
. Write  claim type change audit
.------------------------------------------------------------
WRCF0000  PACK      WTCHURNO,WMURNO,SP70
          PACK      WTCHPROC,WMCODE,SP70
          PACK      WTCHPCNT,WMCNT,SP70
.
          CALL      IBACLOCK
          PACK      WTCHDATE,CCC,CYY,CMM,CDD
          REPLACE   " 0",WTCHDATE
          CLOCK     TIME,WTCHTIME
.
          PACK      WTCHUPTY,THREE,ZERO,SP70
          PACK      WTCHREAS,SP70
          MOVE      USERID,WTCHUSID
          PACK      WTCHOVAL,SVTXCTYP,SP70
          PACK      WTCHCVAL,WTTXCTYP,SP70
.
          MOVE      ZERO,ADDSECND
.
WRCF0200  PACK      KEY35,WTCHURNO,WTCHPROC,WTCHPCNT,WTCHDATE,WTCHTIME,SP70
          CALL      RAWTCHA1
          IF        OVRCD=1
            CALL      WRWTCHA1
          ELSE
            IF        ADDSECND<=5
              ADD       ONE,ADDSECND
            ELSE
              GOTO      WRCF9999
            ENDIF
.
            UNPACK    WTCHTIME,HOUR,D1,MIN,D1,SEC
            PACK      XDATTIME,WTCHDATE,HOUR,MIN,SEC,SP70
            CALL      ASEC0000                     * add 1 sec to date/time
                                                   * to stop duplicate key
            UNPACK    XDATTIME,WTCHDATE,HOUR,MIN,SEC
            PACK      WTCHTIME,HOUR,COLON,MIN,COLON,SEC
            GOTO      WRCF0200
          ENDIF
.
WRCF9999  RETURN
+
.------------------------------------------------------------
. Write  source of referral change audit
.------------------------------------------------------------
WRCR0000  PACK      WTCHURNO,WMURNO,SP70
          PACK      WTCHPROC,WMCODE,SP70
          PACK      WTCHPCNT,WMCNT,SP70
.
          CALL      IBACLOCK
          PACK      WTCHDATE,CCC,CYY,CMM,CDD
          REPLACE   " 0",WTCHDATE
          CLOCK     TIME,WTCHTIME
.
          PACK      WTCHUPTY,TWO,SEVEN,SP70
          PACK      WTCHREAS,SP70
          MOVE      USERID,WTCHUSID
          PACK      WTCHOVAL,SVWMSRCR,SP70
          PACK      WTCHCVAL,WTWMSRCR,SP70
.
          MOVE      ZERO,ADDSECND
.
WRCR0200  PACK      KEY35,WTCHURNO,WTCHPROC,WTCHPCNT,WTCHDATE,WTCHTIME,SP70
          CALL      RAWTCHA1
          IF        OVRCD=1
            CALL      WRWTCHA1
          ELSE
            IF        ADDSECND<=5
              ADD       ONE,ADDSECND
            ELSE
              GOTO      WRCR9999
            ENDIF
.
            UNPACK    WTCHTIME,HOUR,D1,MIN,D1,SEC
            PACK      XDATTIME,WTCHDATE,HOUR,MIN,SEC,SP70
            CALL      ASEC0000                     * add 1 sec to date/time
                                                   * to stop duplicate key
            UNPACK    XDATTIME,WTCHDATE,HOUR,MIN,SEC
            PACK      WTCHTIME,HOUR,COLON,MIN,COLON,SEC
            GOTO      WRCR0200
          ENDIF
.
WRCR9999  RETURN
+
.------------------------------------------------------------
. Write  short notice change audit
.------------------------------------------------------------
WRCN0000  PACK      WTCHURNO,WMURNO,SP70
          PACK      WTCHPROC,WMCODE,SP70
          PACK      WTCHPCNT,WMCNT,SP70
.
          CALL      IBACLOCK
          PACK      WTCHDATE,CCC,CYY,CMM,CDD
          REPLACE   " 0",WTCHDATE
          CLOCK     TIME,WTCHTIME
.
          PACK      WTCHUPTY,TWO,EIGHT,SP70
          PACK      WTCHREAS,SP70
          MOVE      USERID,WTCHUSID
          PACK      WTCHOVAL,SVNOTICE,SP70
          PACK      WTCHCVAL,WMNOTICE,SP70
.
          MOVE      ZERO,ADDSECND
.
WRCN0200  PACK      KEY35,WTCHURNO,WTCHPROC,WTCHPCNT,WTCHDATE,WTCHTIME,SP70
          CALL      RAWTCHA1
          IF        OVRCD=1
            CALL      WRWTCHA1
          ELSE
            IF        ADDSECND<=5
              ADD       ONE,ADDSECND
            ELSE
              GOTO      WRCN9999
            ENDIF
.
            UNPACK    WTCHTIME,HOUR,D1,MIN,D1,SEC
            PACK      XDATTIME,WTCHDATE,HOUR,MIN,SEC,SP70
            CALL      ASEC0000                     * add 1 sec to date/time
                                                   * to stop duplicate key
            UNPACK    XDATTIME,WTCHDATE,HOUR,MIN,SEC
            PACK      WTCHTIME,HOUR,COLON,MIN,COLON,SEC
            GOTO      WRCN0200
          ENDIF
.
WRCN9999  RETURN
+
.------------------------------------------------------------
. Write  doctor change audit
.------------------------------------------------------------
WRCD0000  PACK      WTCHURNO,WMURNO,SP70
          PACK      WTCHPROC,WMCODE,SP70
          PACK      WTCHPCNT,WMCNT,SP70
.
          CALL      IBACLOCK
          PACK      WTCHDATE,CCC,CYY,CMM,CDD
          REPLACE   " 0",WTCHDATE
          CLOCK     TIME,WTCHTIME
.
          PACK      WTCHUPTY,ONE,NINE,SP70
          PACK      WTCHREAS,SP70
          MOVE      USERID,WTCHUSID
          PACK      WTCHOVAL,SVWMDOCT,SP70
          PACK      WTCHCVAL,WMDOCTOR,SP70
.
          MOVE      ZERO,ADDSECND
.
WRCD0200  PACK      KEY35,WTCHURNO,WTCHPROC,WTCHPCNT,WTCHDATE,WTCHTIME,SP70
          CALL      RAWTCHA1
          IF        OVRCD=1
            CALL      WRWTCHA1
          ELSE
            IF        ADDSECND<=5
              ADD       ONE,ADDSECND
            ELSE
              GOTO      WRCD9999
            ENDIF
.
            UNPACK    WTCHTIME,HOUR,D1,MIN,D1,SEC
            PACK      XDATTIME,WTCHDATE,HOUR,MIN,SEC,SP70
            CALL      ASEC0000                     * add 1 sec to date/time
                                                   * to stop duplicate key
            UNPACK    XDATTIME,WTCHDATE,HOUR,MIN,SEC
            PACK      WTCHTIME,HOUR,COLON,MIN,COLON,SEC
            GOTO      WRCD0200
          ENDIF
.
WRCD9999  RETURN
+
.------------------------------------------------------------------------
. Write ESIS SAD record
.------------------------------------------------------------------------
WSAD0000  READ      CONTROLF,EIGHTY;*250,PTCNHDPS
          COMPARE   THREE,PTCNHDPS
          GOTO      WSAD9999 IF NOT EQUAL
.
          PACK      WTENUNIQ,WTWMECNT,SP70
          PACK      WTENEDAT,SP70
          PACK      WTENWEBC,WBSEUID,SP70
          CALL      IBACLOCK
          PACK      WTENCDAT,CCC,CYY,CMM,CDD
          REP       " 0",WTENCDAT
          CLOCK     TIME,WTENCTIM
          REP       " 0",WTENCTIM
          PACK      WTENWEBU,SP70
          PACK      WTENUDAT,SP70
          PACK      WTENUTIM,SP70
          MOVE      ZERO,WTENMANU
.
          PACK      KEY36,WTENUNIQ,WTENETYP,WTENEVDT,WTENEDAT,WTENSADI,SP70
          CALL      RAWTESN1
          IF        OVRCD=1
            CALL      WRWTESN1
          ELSE
            PACK      WTENWEBU,WBSEUID
            PACK      WTENUDAT,CCC,CYY,CMM,CDD
            REP       " 0",WTENUDAT
            CLOCK     TIME,WTENUTIM
            REP       " 0",WTENUTIM
            CALL      UPWTESN1
          ENDIF
.
WSAD9999  RETURN
.------------------------------------------------------------------------
. Delete booking waiting list booking details
.------------------------------------------------------------------------
DELBOK00  MOVE      ZERO,EXIT
          MOVE      WMBOOK,BKREBOOK         * set the booking number
          MOVE      BKREBOOK,AADMNO
          MOVE      PSNAME,BKRESNAM         * surname
          MOVE      PURNO,BKREURNO          * U/R Number
          UNPACK    CASEKEYS,KEY8,BKREC013,BKREC014
.
          MOVE      BKREBOOK,KEY8           * booking number
          CALL      RLBKREC1                * Read booking file
          BRANCH    OVRCD,DELBOK90,DELBOK92
.
          COMPARE   ZERO,BKRESTAT
          GOTO      DELBOK93 IF NOT EQUAL
.
          MOVE      TWO,BKRESTAT            * Cancel booking
.
          CALL      SAVHIS00                * write to Waiting List History
          MOVE      "05",WTWMBSCD
          MOVE      ONE,NBRFLAG
. 
          CALL      MVBOK000                * Move in booking details
          UNPACK    KEY8,DBKREBOO
.
          MOVE      BKREC009,BKRECANC 
          CALL      UPBKREC1                * Update booking extn file
          CALL      UUBKREC1
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      FIVE,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICCB                * DG API Cancel Booking    *I-90203
.
          PACK      KEY8,BKREBOOK,SP70
          CALL      RDBKRX11                * Read booking extn file
          BRANCH    OVRCD,DELBOK90
.
          PACK      BKRXLUPD,CCC,CYY,CMM,CDD
          REP       " 0",BKRXLUPD
          CLOCK     TIME,BKRXLUPT
          MOVE      USERID,BKRXWEBU 
.         MOVE      SP70,BKRXODTE           * Move spaces to Date
          CALL      UPBKRX11                * Update booking extn file
.
          MOVE      ZERO,ADDWLFLG
          MOVE      BKRECANC,SAVEBCAN
          CALL      WRTHIS00                * write to Waiting List History 
          CALL      WRCHJ000           * Write data integrity cancel booking
.
          CALL      INTCAN00                * Add Delete Interpreter Audit
.
          MOVE      CASEKEYS,KEY19          * Return to waiting list
          CALL      RDTREA1
          BRANCH    OVRCD,DELBOK90
.
          MOVE      WMURNO,URNUMBER
.
          MATCH     "1",WABMIIND
          IF        @EQUAL
            MOVE      WMBOOK,SAVWMBOK
          ENDIF
.>>>>
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      EIGHT,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLIWLD                * HL7 A38 - W/L Booking Cancellation
.
          BRANCH    WATTFLAG,DELBOK20
          GOTO      DELBOK40
.
DELBOK20  MOVE      ONE,WMSTAT              * Return to waiting list
          MOVE      SP70,WMDATE3            * Removing proposed admission date
          CALL      GENBOKNO                * Get WL Booking Number
          CALL      UPTREA1
.
          CALL      IBACLOCK
          PACK      WTENEVDT,CCC,CYY,CMM,CDD   * Write ESIS Intra Episode Record
          REP       " 0",WTENEVDT
          MATCH     WTENEVDT,BKREEDAT
          IF        @LESS
            PACK      WTENEVDT,BKREEDAT
            REP       " 0",WTENEVDT
          ENDIF
          PACK      WTENEVAL,BKRECANC
          MOVE      ANSP,WTENETYP
          PACK      WTENSADI,DBKREBOO,SP70
          PACK      KEY5,ANSB,ANSC,BKRECANC,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            MATCH     ANSA,THCSCOD
            IF        @EQUAL
              CALL      GETSET00
              GOTO      DELBOK50
            ENDIF
          ENDIF
          CALL      WSAD0000
.
          CALL      ADDAT100
.
          GOTO      DELBOK50
.
DELBOK40  MOVE      SIX,WMSTAT              * Do not return to waiting list
          MOVE      BKREC009,WMREMOVE
          MOVE      SP70,WMDATE3            * Removing proposed admission date
          PACK      WMDATE4,CCC,CYY,CMM,CDD
          REP       " 0",WMDATE4
.
          MATCH     Z70,WATTR009
          IF        !@EQUAL
            MATCH     SP70,WATTR009
            IF        !@EQUAL
              UNPACK    WATTR009,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      WMDATE4,CCENT,CYEAR,CMON,CDAY
              REP       " 0",WMDATE4
            ELSE
              MOVE      SP70,WMDATE4
            ENDIF
          ENDIF
.
          MATCH     Z70,WATTR010
          IF        !@EQUAL
            PACK      WMREMOVE,WATTR010
          ENDIF
          CALL      UPTREA1
.
          CALL      IBACLOCK
          PACK      WTENEVDT,CCC,CYY,CMM,CDD   * Write ESIS Intra Episode Record
          REP       " 0",WTENEVDT
          PACK      WTENEVAL,BKRECANC
          MOVE      ANSP,WTENETYP
          PACK      WTENSADI,DBKREBOO,SP70
          PACK      KEY5,ANSB,ANSC,BKRECANC,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            MATCH     ANSA,THCSCOD
            IF        @EQUAL
              CALL      GETSET00
              GOTO      DELBOK50
            ENDIF
          ENDIF
          CALL      WSAD0000
.
DELBOK50  MOVE      CASEKEYS,KEY19          * Record last update details
          CALL      RDWTTX11
          BRANCH    OVRCD,DELBOK90
.
          CALL      IBACLOCK
          PACK      WTTXLUPD,CCC,CYY,CMM,CDD
          REP       " 0",WTTXLUPD
          CLOCK     TIME,WTTXLUPT
          MOVE      USERID,WBSEUID
          MOVE      SP70,WTTXPATM           * Removing proposed admission time
          MATCH     Z70,WATTX045
          IF        !@EQUAL
            PACK      WTTXRTIM,WATTX045
          ENDIF
          CALL      UPWTTX11
.
          IF        WMSTAT=6
            CALL      WRCHK000           * Write data integrity removal
          ENDIF
.
          GOTO      DELBOK99
.
DELBOK90  MOVE      "Invalid booking number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DELBOK99
.
DELBOK92  MOVE      "booking number locked",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DELBOK99
.
DELBOK93  CALL      UUBKREC1
          MOVE      "Invalid booking status for cancellation",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DELBOK99
.
DELBOK99  CALL      UUBKREC1
          RETURN
.------------------------------------------------------------
. Move in Booking Details
.------------------------------------------------------------
MVBOK000  MATCH     Z70,BKREC001
          IF        !@EQUAL
            MOVE       BKREC001,BKRESNAM
          ENDIF
          MATCH     Z70,BKREC002
          IF        !@EQUAL
            MOVE       BKREC002,BKREADOC
          ENDIF
          MATCH     Z70,BKREC003
          IF        !@EQUAL
            MOVE       BKREC003,BKRESDOC
          ENDIF
          MATCH     Z70,BKREC004
          IF        !@EQUAL
            MATCH     SP70,BKREC004
            IF        @EQUAL
              MOVE      SP70,BKREEDAT
            ELSE
              UNPACK    BKREC004,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      BKREEDAT,CCENT,CYEAR,CMON,CDAY
              REP       " 0",BKREEDAT
            ENDIF
          ENDIF
          MATCH     Z70,BKREC005
          IF        !@EQUAL
            MOVE       BKREC005,BKREATIM
          ENDIF
          MATCH     Z70,BKREC006
          IF        !@EQUAL
            MATCH     SP70,BKREC006
            IF        @EQUAL
              MOVE      SP70,BKREPDAT
            ELSE
              UNPACK    BKREC006,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      BKREPDAT,CCENT,CYEAR,CMON,CDAY
              REP       " 0",BKREPDAT
            ENDIF
          ENDIF
          MATCH     Z70,BKREC007
          IF        !@EQUAL
            MOVE       BKREC007,BKREPTIM
          ENDIF
          MATCH     Z70,BKREC008
          IF        !@EQUAL
            MOVE       BKREC008,BKRETYPE
          ENDIF
          MATCH     Z70,BKREC009
          IF        !@EQUAL
            MOVE       BKREC009,BKRECANC
          ENDIF
          MATCH     Z70,BKREC010
          IF        !@EQUAL
            MOVE       BKREC010,BKREOMEM
          ENDIF
          MATCH     Z70,BKREC011
          IF        !@EQUAL
            MOVE       BKREC011,BKREPREV
          ENDIF
          MATCH     Z70,BKREC012
          IF        !@EQUAL
            MOVE       BKREC012,BKREACCM
          ENDIF
          MATCH     Z70,BKREC013
          IF        !@EQUAL
            MOVE       BKREC013,BKREPROC
          ENDIF
          MATCH     Z70,BKREC014
          IF        !@EQUAL
            SQUEEZE    BKREC014
            MOVE       BKREC014,BKRECNT 
          ENDIF
          MATCH     Z70,BKREC015
          IF        !@EQUAL
            MOVE       BKREC015,BKREWARD
          ENDIF
          MATCH     Z70,BKREC016
          IF        !@EQUAL
            SQUEEZE    BKREC016
            MOVE       BKREC016,BKREADMN
          ENDIF
          MATCH     Z70,BKREC017
          IF        !@EQUAL
            MOVE       BKREC017,BKREPREA
          ENDIF
          MATCH     Z70,BKREC018
          IF        !@EQUAL
            MOVE       BKREC018,BKREEBED
          ENDIF
          MATCH     Z70,BKREC019
          IF        !@EQUAL
            MOVE       BKREC019,BKRECLSS
          ENDIF
          MATCH     Z70,BKREC020
          IF        !@EQUAL
            MOVE       BKREC020,BKREATYP
          ENDIF
          MATCH     Z70,BKREC021
          IF        !@EQUAL
            MOVE       BKREC021,BKREDEPT
          ENDIF
          MATCH     Z70,BKREC022
          IF        !@EQUAL
            MOVE       BKREC022,BKRETDOC
          ENDIF
          MATCH     Z70,BKREC023
          IF        !@EQUAL
            MOVE       BKREC023,BKRECLMT
          ENDIF
          MATCH     Z70,BKREC024
          IF        !@EQUAL
            MOVE       BKREC024,BKRERFGP
          ENDIF
          MATCH     Z70,BKREC025
          IF        !@EQUAL
            MOVE       BKREC025,BKREGPPC
          ENDIF
          MATCH     Z70,BKREC026
          IF        !@EQUAL
            MOVE       BKREC026,BKREGPFA
          ENDIF
          MATCH     Z70,BKREC027
          IF        !@EQUAL
            MOVE       BKREC027,BKRERESI
          ENDIF
          MATCH     Z70,BKREC028
          IF        !@EQUAL
            MOVE       BKREC028,BKREEATY
          ENDIF
          MATCH     Z70,BKREC029
          IF        !@EQUAL
            MOVE       BKREC029,BKREECRA
          ENDIF
          MATCH     Z70,BKREC030
          IF        !@EQUAL
            MOVE       BKREC030,BKREGPPT
          ENDIF
          MATCH     Z70,BKREC031
          IF        !@EQUAL
            MOVE       BKREC031,BKREDOFR
          ENDIF
          MATCH     Z70,BKREC032
          IF        !@EQUAL
            MOVE       BKREC032,BKREOPER
          ENDIF
          MATCH     Z70,BKREC033
          IF        !@EQUAL
            SQUEEZE    BKREC033
            MOVE       BKREC033,BKREELOS
          ENDIF
          MATCH     Z70,BKREC034
          IF        !@EQUAL
            MATCH     SP70,BKREC034
            IF        @EQUAL
              MOVE      SP70,BKREBKDT
            ELSE
              UNPACK    BKREC034,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      BKREBKDT,CCENT,CYEAR,CMON,CDAY
              REP       " 0",BKREBKDT
            ENDIF
          ENDIF
          MATCH     Z70,BKREC035
          IF        !@EQUAL
            MOVE       BKREC035,BKDICODE
          ENDIF
          MATCH     Z70,BKREC036
          IF        !@EQUAL
            MOVE       BKREC036,BKDIDES1
          ENDIF
          MATCH     Z70,BKREC037
          IF        !@EQUAL
            MOVE       BKREC037,BKDIDES2
          ENDIF
          MATCH     Z70,BKREC038
          IF        !@EQUAL
            MOVE       BKREC038,BKDICOMM
          ENDIF
          MATCH     Z70,BKREC039
          IF        !@EQUAL
            MATCH     SP70,BKREC039
            IF        @EQUAL
              MOVE      SP70,BKREADAT
            ELSE
              UNPACK    BKREC039,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      BKREADAT,CCENT,CYEAR,CMON,CDAY
              REP       " 0",BKREADAT
            ENDIF
          ENDIF
.
          MATCH     Z70,WATTX026
          IF        !@EQUAL
            MATCH     SP70,WATTX026
            IF        !@EQUAL
              MOVE      WATTX026,BKRECLMT     * Claim Type (Cat CL)
            ENDIF
          ENDIF
.
MVBOK999  RETURN
.
.------------------------------------------------------------
. Create Booking Medical/Maternity
.------------------------------------------------------------
UPDBOK00  MOVE      WMBOOK,BKREBOOK         * set the booking number
          MOVE      BKREBOOK,AADMNO
          MOVE      PSNAME,BKRESNAM         * surname
          MOVE      PURNO,BKREURNO          * U/R Number
          UNPACK    CASEKEYS,KEY8,BKREC013,BKREC014
.
          MOVE      BKREBOOK,KEY8           * booking number
          CALL      RDBKREC1                * Read booking file
          BRANCH    OVRCD,UPDBOK91
.
          PACK      OLDVAL01,BKREEDAT,BKREATIM,SP70,SP70
.
          PACK      KEY8,DBKREBOO,SP70
          CALL      RDBKRX11                * Read booking extn file
          BRANCH    OVRCD,UPDBOK91
.
          MOVE      BKREADAT,SAVTREAT
          CALL      MVBOK000                * Move in booking details
.         
          PACK      OLDVAL02,BKREEDAT,BKREATIM,SP70,SP70
.
          MATCH     Z70,BOKRX023
          IF        !@EQUAL
            MOVE      BOKRX023,BKRXODTE
          ENDIF
          MATCH     SP70,BKRXODTE
          IF        !@EQUAL
            MATCH     BKREEDAT,BKRXODTE
            GOTO      UPDBOK92 IF LESS
          ENDIF
.
          MATCH     Z70,BOKRX006
          IF        !@EQUAL
            MOVE      BOKRX006,BKRXCNDT
          ENDIF
.
          MATCH     BKRXCNDT,BKREEDAT
          GOTO      UPDBOK93 IF LESS
.
          MATCH     WMDATE1,BKREEDAT
          GOTO      UPDBOK94 IF LESS
.
          UNPACK    KEY8,DBKREBOO
          CALL      UPBKREC1                * Update booking extn file
.
          CALL      MVBKRX00                * Move in booking extn details
          UNPACK    KEY8,DBKREBOO
          CALL      UPBKRX11                * Update booking extn file

          MOVE      WATHI001,WTHIRDT3
          MOVE      CASEKEYS,KEY19
          CALL      RDTREA1
          BRANCH    OVRCD,UPDBOK99
          CALL      SAVHIS00
          MOVE      WATHI001,SAVERDT3
          MOVE      WMDATE3,SAVESCHA
          MOVE      BKREEDAT,WMDATE3        * set the date
.
          MOVE      BKREPTIM,D5
          SQUEEZE   D5
          MOVE      D5,WMTIME
          CALL      UPTREA1
.
          MATCH     BKREADAT,SAVTREAT
          GOTO      UPDBOK70 IF NOT EQUAL
.
          MATCH     BKREEDAT,SAVESCHA
          GOTO      UPDBOK80 IF EQUAL
.
UPDBOK70  MOVE      BKREADAT,SAVDBFT
          MOVE      BKREBKDT,SAVBMDT
          CALL      IBACLOCK
          MOVE      "06",WTWMBSCD
          MOVE      ONE,NBRFLAG
          CALL      WRTHIS00
.
UPDBOK80  MOVE      CASEKEYS,KEY19
          CALL      RDWTTX11
          BRANCH    OVRCD,UPDBOK99
.... CAR 43419
          MOVE      BKREATIM,WTTXPATM            * Proposed admission time
....
          MOVE      BKRXADWD,WTTXADMW
          MOVE      BKRXPOWD,WTTXPOWD
          CALL      UPWTTX11
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      NINE,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLIWLU                * HL7 A08 - W/L Booking Update
.
          CALL      INTUPD00                * Update interpreter details
.
. New Code to print letters
.
          IF        LETTREQD = 1
            CALL     PWTLET00
          ENDIF
.
          MOVE      BKREBOOK,BKDIBOOK       * set booking number
          PACK      BKDIUNIQ,SP9,ONE,SP70   * set unique number
          PACK      KEY18,BKREBOOK,SP9,ONE,SP70  * set booking number
          CALL      RABKDIA1
          IF        OVRCD=0
            CALL      UPBKDIA1                * update file
          ELSE
            CALL      WRBKDIA1                * write details
          ENDIF
.
          MATCH     OLDVAL01,OLDVAL02
          IF        !@EQUAL
            CALL      WRCHI000
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      UPDBOK99
.
UPDBOK91  MOVE      "Invalid booking number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDBOK99
.
UPDBOK92  CLEAR     WEBTITLE
          APPEND    "Procedure Date must be Greater Than ",WEBTITLE 
          APPEND    "Admission Date",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDBOK99
.
UPDBOK93  CLEAR     WEBTITLE
          APPEND    "Admission Date must be Greater Than Or ",WEBTITLE 
          APPEND    "Equal To Confirmation Date",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDBOK99
.
UPDBOK94  CLEAR     WEBTITLE
          APPEND    "Scheduled Admission Date must be greater than ",WEBTITLE
          APPEND    "Date on List",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDBOK99
.
UPDBOK99  RETURN
.------------------------------------------------------------------------
. Clear details
.------------------------------------------------------------------------
CLBOKREC  MOVE      SP70,BKRESNAM  *       Surname
          MOVE      SP70,BKRELOCK  *        Lock variable
          MOVE      SP70,BKREADOC  *        Attending Doctor
          MOVE      SP70,BKRESDOC  *        Referring Doctor
          MOVE      SP70,BKREEDAT  *        Expected due date (CCYYMMDD)
          MOVE      SP70,BKREATIM  *        Expected assessment time
          MOVE      SP70,BKREPDAT  *        Pre-assessment date
          MOVE      SP70,BKREPTIM  *        Pre-assessment time
          MOVE      SP70,BKREADAT  *        Date booking was made CCYYMMDD
          MOVE      SP70,BKRETYPE  *        Booking type (Cat "BK")
          MOVE      SP70,BKRECANC  *        Cancellation reason (Cat "BC")
          MOVE      SP70,BKRESTAT  *        Booking status
          MOVE      SP70,BKREOMEM  *        Benefit fund member (Y/N/U)
          MOVE      SP70,BKREPREV  *        Previous inpatient (Y/N/U)
          MOVE      SP70,BKREACCM  *        Preferred accommodation (Cat BP)
          MOVE      SP70,BKREPROC  *        Waiting list procedure code
          MOVE      SP70,DBKRECNT  *        Waiting list procedure count
          MOVE      SP70,BKREWARD  *        Expected ward
          MOVE      SP70,BKREADMN  *        Maternity admission number
          MOVE      SP70,BKREPREA  *        Deposit paid (Y/N) Matern only
          MOVE      SP70,BKREEBED  *        Expected bed
          MOVE      SP70,BKRECLSS  *        Patient Cat./Adm Class. (Cat P)
          MOVE      SP70,BKREATYP  *        Adm Type/Pat. Class (Cat A)
          MOVE      SP70,BKREDEPT  *        Department (Cat AC)
          MOVE      SP70,BKRETDOC  *        Associated Doctor    
          MOVE      SP70,BKRECLMT  *        Claim type (Cat CL)  
          MOVE      SP70,BKRERFGP  *        Referring GP
          MOVE      SP70,BKREGPPC  *        GP Practice code
          MOVE      SP70,BKREGPFA  *       GPFH Approval Number
          MOVE      SP70,BKRERESI  *        Resident Status (Cat T)
          MOVE      SP70,BKREEATY  *        Elective Admission Type  (Cat CC)
          MOVE      SP70,BKREECRA  *       ECR Approval Number
          MOVE      SP70,BKREGPPT  *        GP Practice count
          MOVE      SP70,BKREDOFR  *        District of Residence (Cat DA)
          MOVE      SP70,BKREOPER  *        Operator who made I/P Booking
          MOVE      SP70,DBKREELO  *        Expected Length of Stay (Days)
          MOVE      SP70,BKREBKDT  *        Booking date (ccyymmdd)
          MOVE      SP70,BKRESPAR  *        Spare
          MOVE      SP70,BKDICODE
          MOVE      SP70,BKDIDES1
          MOVE      SP70,BKDIDES2
          MOVE      SP70,BKDICOMM
          MOVE      SP70,BKDISPAR
          MOVE      SP70,BKREINDC
          RETURN
.------------------------------------------------------------------------
. Clear details
.------------------------------------------------------------------------
CLBKRX00  MOVE      SP70,BKRXPOWD  *  Post-Op Ward (patwr1af)
          MOVE      SP70,BKRXADWD  * Admitting Ward (patwr1af)
          MOVE      SP70,BKRXCDTE  * Contact Date (ccyymmdd)
          MOVE      SP70,BKRXPSTY  * Parent Staying (0=NO,1=YES)
          MOVE      SP70,BKRXCNDT  * Confirmation Date (ccyymmdd)
          MOVE      SP70,BKRXUDF1  * User Defined Field 1 (Cat BE)
          MOVE      SP70,BKRXUDF2  * User Defined Field 2 (Cat BF)
          MOVE      SP70,BKRXUDF3  * User Defined Field 3 (Cat BG)
          MOVE      SP70,BKRXUDF4  * User Defined Field 4 (Cat BH)
          MOVE      SP70,BKRXUDF5  * User Defined Field 5 (Cat BL)
          MOVE      SP70,BKRXUDD1  * User Defined Date 1 (ccyymmdd)
          MOVE      SP70,BKRXUDD2  * User Defined Date 2 (ccyymmdd)
          MOVE      SP70,BKRXUDD3  * User Defined Date 3 (ccyymmdd)
          MOVE      SP70,BKRXUDD4  * User Defined Date 4 (ccyymmdd)
          MOVE      SP70,BKRXUFF1  * Procedure Description 1
          MOVE      SP70,BKRXUFF2  * Procedure Description 2
          MOVE      SP70,BKRXUFF3  * Procedure Description 3
          MOVE      SP70,BKRXUFF4  * User Defined Free Format 4
          MOVE      SP70,BKRXEDC1  * Extra Doctor Code 1 (pmshcpaf)
          MOVE      SP70,BKRXEDC2  * Extra Doctor Code 2 (pmshcpaf)
          MOVE      SP70,BKRXEDC3  * Extra Doctor Code 3 (pmshcpaf)
          MOVE      SP70,BKRXODTE  * Operation Date (ccyymmdd)
          MOVE      SP70,BKRXOPRD  * Operation Period (Cat SP)
          MOVE      SP70,BKRXCRDT  * Date record created (ccyymmdd)
          MOVE      SP70,BKRXCRTM  * Time record created (hh:mm:ss)
          MOVE      SP70,BKRXWEBC  * WEB User Id rec. creator (websecaf)
          MOVE      SP70,BKRXLUPD  * Last Update Date (ccyymmdd)
          MOVE      SP70,BKRXLUPT  * Last Update Time (hh:mm:ss)
          MOVE      SP70,BKRXWEBU  * WEB User Id rec. updater (websecaf)
          MOVE      SP70,BKRXASRC  * Admission Source (Category S)
          MOVE      SP70,BKRXBLDT  * Blood Type (category BO)
          MOVE      SP70,BKRXCTTY  * Contact Type (Letter No.-watletaf)
          MOVE      SP70,BKRXSGBK  * Surgical Booking
          MOVE      SP70,BKRXPOBD  * Post Op Bed     
          MOVE      SP70,BKRXPOEC  * Patient Online Eligibility Check
          MOVE      SP70,BKRXDIET  * Diet
          MOVE      SP70,BKRXTRAN  * Transport
          MOVE      SP70,BKRXATRN  * Arrival Transport
          MOVE      SP70,BKRXANTY  * Anaesthetic Type
          MOVE      SP70,BKRXESOP  * Estimated Op Time
          MOVE      SP70,BKRXEABR  * Early Booking Reason
          MOVE      SP70,BKRXAUBY  * Authorised By
          MOVE      SP70,BKRXEAID  * Web User ID that added the Early
.                                  * Booking Reason
          MOVE      SP70,BKRXDROR
          MOVE      SP70,BKRXUDF6
          MOVE      SP70,BKRXUDF7
          MOVE      SP70,BKRXPACA
          RETURN
.
.------------------------------------------------------------
. Selection list of letters send  
.------------------------------------------------------------
LETSNC00  PACK      KEY6,SP70
          CALL      RDSLET1
LETSNC10  CALL      RDKLET1
          BRANCH    OVRCD,LETSNC99
          COMPARE   ZERO,WLINNO
          GOTO      LETSNC10 IF NOT EQUAL
.
          MATCH     WTEXLLSC,DWLETNO
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",WLETNO," selected>",WLTEXT:
                               "</option>";
          ELSE
            MATCH     "1",WLETACTV            * Skip if inactive
            GOTO      LETSNC10 IF EQUAL
.
            MATCH     "1",WLETCOMM            * Skip if SMS
            GOTO      LETSNC10 IF EQUAL
.
            WRITE     HTMLFILE;"<option value=",WLETNO,">",WLTEXT:
                               "</option>";
          ENDIF
          GOTO      LETSNC10
.
LETSNC99  RETURN
.------------------------------------------------------------
. Write Comment to File  watpacaf -hps
.------------------------------------------------------------
WRPAC000  COMPARE   ZERO,WTPAEND
          GOTO      WRPAC999 IF EQUAL
          PACK      KEY21,WMURNO,WMCODE,WMCNT,SP70
          CALL      RDWTPAC1
          IF        OVRCD=0
            CALL      RPWTPAC1
          ENDIF
WRPAC010  CALL      RKWTPAC1
          BRANCH    OVRCD,WRPAC100
          MATCH     WMURNO,WTPCURNO
          GOTO      WRPAC100 IF NOT EQUAL
          MATCH     WMCODE,WTPCPCOD
          GOTO      WRPAC100 IF NOT EQUAL
          MOVE      WMCNT,D2
          MATCH     D2,WTPCPCNT
          GOTO      WRPAC100 IF NOT EQUAL
.
          PACK      KEY21,WTPCURNO,WTPCPCOD,WTPCPCNT,WTPCLINE,SP70
          CALL      DEWTPAC1
          PACK      KEY21,WMURNO,WMCODE,WMCNT,SP70
          CALL      RSWTPAC1
          GOTO      WRPAC010
.
WRPAC100  COMPARE   ZERO,WTPAEND
          GOTO      WRPAC999 IF EQUAL
          MOVE      ZERO,F2
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      COMPREAF,COMPRENM
          TRAPCLR   IO
          BRANCH    OVRCD,WRPAC999
.
WRPAC110  ADD       ONE,F2
          MOVE      WMURNO,WTPCURNO
          MOVE      WMCODE,WTPCPCOD
          MOVE      WMCNT,WTPCPCNT
          MOVE      F2,WTPCLINE
          PACK      KEY21,WTPCURNO,WTPCPCOD,WTPCPCNT,WTPCLINE,SP70
          CALL      RDWTPAC1
          IF        OVRCD=0
            READ      COMPREAF,SEQ;WTPCCOMM
            MOVE      SP70,WTPCSPAR
            CALL      UPWTPAC1
          ELSE
            READ      COMPREAF,SEQ;WTPCCOMM
            MOVE      SP70,WTPCSPAR
            CALL      WRWTPAC1
          ENDIF
          COMPARE   F2,WTPAEND
          GOTO      WRPAC110 IF NOT EQUAL
.
WRPAC999  RETURN
.------------------------------------------------------------
. Validate Patient Admission number according to w/list status
. Do not validate the procedure code and count for the booking
. if using theatre
.------------------------------------------------------------
XMLADM00  CALL      XMLHED00
          BRANCH    EXIT,XMLADM99
.
          PACK      KEY19,CASEKEYS,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,XMLADM82
.
          BRANCH    LISTSTAT,XMLADM50,XMLADM20,XMLADM30,XMLADM30,XMLADM40
          GOTO      XMLADM90
.
. Scheduled
.
XMLADM20  PACK      KEY8,ADMISSNO
          CALL      RDBKREC1
          BRANCH    OVRCD,XMLADM90
.
          MATCH     URNUMBER,BKREURNO
          GOTO      XMLADM90 IF NOT EQUAL
.
          COMPARE   ONE,CTHETR                   * Using Theatre
          IF        !@EQUAL
            MATCH     BKREPROC,WMCODE
            GOTO      XMLADM90 IF NOT EQUAL
.
            COMPARE   BKRECNT,WMCNT
            GOTO      XMLADM90 IF NOT EQUAL
          ENDIF
.
          COMPARE   ZERO,BKRESTAT
          GOTO      XMLADM94 IF NOT EQUAL
.
          GOTO      XMLADM80
.          
. Pre - Admitted and Admitted
.
XMLADM30  PACK      KEY8,ADMISSNO
          CALL      RDMISS1 
          BRANCH    OVRCD,XMLADM92
.
          MATCH     URNUMBER,AURNO
          GOTO      XMLADM92 IF NOT EQUAL
.
          MATCH     WMDATE1,ADATE
          GOTO      XMLADM96 IF LESS
.
          COMPARE   ONE,CTHETR                   * Using Theatre
          IF        @EQUAL
            PACK      KEY8,ADMISSNO
            CALL      RDBKREC1
            BRANCH    OVRCD,XMLADM90
.
            MATCH     URNUMBER,BKREURNO
            GOTO      XMLADM90 IF NOT EQUAL
.
.           COMPARE   TWO,BKRESTAT
.           GOTO      XMLADM84 IF EQUAL
.
            GOTO      XMLADM80
          ENDIF
.
          PACK      KEY16,URNUMBER,SP70
          CALL      RSBKREC6
XMLADM35  CALL      RKBKREC6
          BRANCH    OVRCD,XMLADM90
.
          MATCH     URNUMBER,BKREURNO
          GOTO      XMLADM90 IF NOT EQUAL
.
          MATCH     BKREPROC,WMCODE
          GOTO      XMLADM35 IF NOT EQUAL
.
          COMPARE   BKRECNT,WMCNT
          GOTO      XMLADM35 IF NOT EQUAL
.
          COMPARE   TWO,BKRESTAT
          GOTO      XMLADM35 IF EQUAL
.
          GOTO      XMLADM80
.          
. Discharged
.
XMLADM40  PACK      KEY8,ADMISSNO
          CALL      RDDSCH1 
          BRANCH    OVRCD,XMLADM94
.
          MATCH     URNUMBER,DURNO
          GOTO      XMLADM94 IF NOT EQUAL
.
          PACK      KEY8,ADMISSNO
          CALL      RDMISS1
          BRANCH    OVRCD,XMLADM92
.
          MATCH     WMDATE1,ADATE
          GOTO      XMLADM96 IF LESS
.
          COMPARE   ONE,CTHETR                   * Using Theatre
          IF        @EQUAL
            PACK      KEY8,ADMISSNO
            CALL      RDBKREC1
            BRANCH    OVRCD,XMLADM90
.
            MATCH     URNUMBER,BKREURNO
            GOTO      XMLADM90 IF NOT EQUAL
.
.           COMPARE   TWO,BKRESTAT
.           GOTO      XMLADM84 IF EQUAL
.
            GOTO      XMLADM80
          ENDIF
.
          PACK      KEY16,URNUMBER,SP70
          CALL      RSBKREC6
XMLADM45  CALL      RKBKREC6
          BRANCH    OVRCD,XMLADM90
.
          MATCH     URNUMBER,BKREURNO
          GOTO      XMLADM90 IF NOT EQUAL
.
          MATCH     BKREPROC,WMCODE
          GOTO      XMLADM45 IF NOT EQUAL
.
          COMPARE   BKRECNT,WMCNT
          GOTO      XMLADM45 IF NOT EQUAL
.
          COMPARE   TWO,BKRESTAT
          GOTO      XMLADM45 IF EQUAL
.
          GOTO      XMLADM80
.
. Unscheduled
.
XMLADM50  PACK      KEY8,ADMISSNO
          CALL      RDBKREC1
          IF        OVRCD=0
            MATCH     URNUMBER,BKREURNO
            GOTO      XMLADM80 IF EQUAL
          ENDIF
.
          PACK      KEY8,ADMISSNO
          CALL      RDMISS1
          IF        OVRCD=0
            MATCH     URNUMBER,AURNO
            GOTO      XMLADM80
          ENDIF
.
          MOVE      SP70,DIM8
          MOVE      WMBOOK,DIM8
          MATCH     ADMISSNO,DIM8
          GOTO      XMLADM80 IF EQUAL
.
          GOTO      XMLADM83
.
XMLADM80  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             ADMISSNO:
                             "</RETURN_VALUE>"
          GOTO      XMLADM98
.
XMLADM82  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Case Keys - ":
                             "</RETURN_VALUE>"
          GOTO      XMLADM98
.
XMLADM83  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Missing Admission/Booking Record - Admission - ":
                             KEY8,"</RETURN_VALUE>"
          GOTO      XMLADM98
.
XMLADM84  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Booking Status - ":
                             KEY8,"</RETURN_VALUE>"
          GOTO      XMLADM98
.
XMLADM90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Missing Booking Record - Admission - ":
                             KEY8,"</RETURN_VALUE>"
          GOTO      XMLADM98
.
XMLADM92  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Missing Admission Record - Admission - ":
                             KEY8,"</RETURN_VALUE>"
          GOTO      XMLADM98
.
XMLADM94  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Missing Discharge Record - Admission - ":
                             KEY8,"</RETURN_VALUE>"
          GOTO      XMLADM98
.
XMLADM96  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Admission Record before date on list - ":
                             KEY8,"</RETURN_VALUE>"
          GOTO      XMLADM98
.
XMLADM98  CALL      XMLEND00
.
XMLADM99  RETURN
.******************************************************************************
.* SUSSTA00 - Display waiting list suspension status
.******************************************************************************
.
SUSSTA00  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1 
          PACK      TODAY,CCC,CYY,CMM,CDD
          REP       " 0",TODAY
          PACK      KEY21,CASEKEYS,Z70
          PACK      KEY19,WMURNO,WMCODE,WMCNT,SP70
          CALL      RSWTSUS1
SUSSTA10  CALL      RPWTSUS1
          BRANCH    OVRCD,SUSSTA99
.
          PACK      KEY21,WTSUURNO,WTSUCODE,WTSUCNT,SP70
          MATCH     KEY19,KEY21
          GOTO      SUSSTA99 IF NOT EQUAL
.
          MATCH     WTSUFDAT,TODAY
          GOTO      SUSSTA10 IF LESS
          MATCH     TODAY,WTSUTDAT
          GOTO      SUSSTA10 IF LESS
.
          PACK      KEY5,ANSW,ANSN,WTSUREAS
          CALL      RDCODE1
          BRANCH    OVRCD,SUSSTA99
.
          IF        F1 = 0
            WRITE     HTMLFILE;TDESC;
            GOTO      SUSTAB99
          ENDIF
          IF        F1 = 1
            MATCH     WTSUTDAT,SP70
            GOTO      SUSTAB99 IF EQUAL
            MOVE      ZERO,F2
            MOVE      SP70,MTHNAM3 
            UNPACK    WTSUTDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
SUSSTA99  RETURN
.------------------------------------------------------------
. Validate booking dates according to waiting list status      
.------------------------------------------------------------
XMLBOK00  CALL      XMLHED00
          BRANCH    EXIT,XMLBOK99
.
          MOVE      ZERO,F1
          MATCH     SP70,XMLDATE1
          GOTO      XMLBOK85 IF EQUAL
.
          MATCH     SP70,XMLDATE2
          GOTO      XMLBOK85 IF EQUAL
.          
          DAYSEP    XMLDATE1,XMLDATE2,CALDAYS
          CALL      NRCDAY00
          ASSIGN    (CALDAYS-NRCDAYS),CALDAYS
.
          BRANCH    XMLCODE1,XMLBOK20,XMLBOK40
          GOTO      XMLBOK99
.
XMLBOK20  COMPARE   CALDAYS,THIRTY
          IF        @LESS
            MOVE      ONE,F1
          ENDIF
          GOTO      XMLBOK85

XMLBOK40  COMPARE   CALDAYS,NINTY
          IF        @LESS
            MOVE     TWO,F1
          ENDIF
          GOTO      XMLBOK85
. 
XMLBOK85  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             F1:
                             "</RETURN_VALUE>"
          GOTO      XMLBOK98
.
XMLBOK95  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Booking Dates - ":
                             "</RETURN_VALUE>"
          GOTO      XMLBOK98
.
XMLBOK98  CALL      XMLEND00
.
XMLBOK99  RETURN
.
.-------------------------------------------------------------------------------
. Calculate the "Admit on or before" date for Theatre booking if the booking is
. done from a Waiting List
.-------------------------------------------------------------------------------
XMLOVD00  CALL      XMLHED00
          BRANCH    EXIT,XMLOVD99
.
          PACK      KEY19,CASEKEYS,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,XMLOVD82
.
          PACK      FRMTDATE,SP70
          CALL      NEWOVR00         * calculation for overdue date
          MATCH     SP70,OVERDATE
          GOTO      XMLOVD80 IF EQUAL
.
          UNPACK    OVERDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      FRMTDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR  
.
XMLOVD80  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             FRMTDATE:
                             "</RETURN_VALUE>"
          GOTO      XMLOVD98
.
XMLOVD82  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Case Keys - ":
                             KEY19,"</RETURN_VALUE>"
          GOTO      XMLOVD98
.
XMLOVD98  CALL      XMLEND00
.
XMLOVD99  RETURN
.
.----------------------------------------------------------------------
. Print waiting list letter from booking add and update booking screens
.----------------------------------------------------------------------
PWTLET00  CALL      CLWATDET
          MOVE      SP70,WTLHURNO
          MOVE      SP70,WTLHCODE
          MOVE      ZERO,WTLHCONT
          MOVE      SP70,WTLHDATE
          MOVE      SP70,WTLHLNUM
          MOVE      SP70,WTLHACTN
          MOVE      SP70,WTLHRPLY
          MOVE      SP70,WTLHREPR
.
          MATCH     SP70,CASEKEYS
          IF        !@EQUAL
            MOVE      CASEKEYS,KEY19
            CALL      RDTREA1
            BRANCH    OVRCD,WATLET96
            MOVE      WMURNO,URNUMBER
          ENDIF
.
          MOVE      URNUMBER,KEY8           * visit number
          CALL      RDMAST1
          BRANCH    OVRCD,PWTLET99
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
PWTLET10  MOVE      BKRXCTTY,WTLHLNUM
          MOVE      BKRXCTTY,LETTER
          CALL      ADDLHI00
.
          MOVE      ONE,SCHDCOPY
          CALL      ADDWLT00           * Add letter to watlpcaf
.
PWTLET99  RETURN
.
.------------------------------------------------------------
. Display Waiting List Patient ESIS History
.------------------------------------------------------------
WATESI00  CALL      CLWATDET
          CALL      CLWTX000
          CALL      CLWATHIS
          CALL      CLWATESI
.
          MATCH     SP70,ESISKEYS
          IF        !@EQUAL
            MOVE      ESISKEYS,KEY16
            CALL      RDWTESI1
            BRANCH    OVRCD,WATESI92
          ENDIF
.
          MOVE      CASEKEYS,KEY19
          CALL      RDTREA1
          BRANCH    OVRCD,WATESI90
.
          MOVE      CASEKEYS,KEY19
          CALL      RDWTTX11 
          IF        OVRCD=1
            CALL      CLWTX000
          ENDIF
.
          MOVE      URNUMBER,KEY8           * visit number
          CALL      RDMAST1
          BRANCH    OVRCD,WATESI91
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
WATESI50  CALL      PATNAM00
          MOVE      "Waiting List ESIS History",WEBTITLE
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,WATESI99
.
          CALL      WEBBOD00
.
          CALL      WEBEND00
          MOVE      ZERO,EXIT
          GOTO      WATESI99
.
WATESI90  MOVE      "Invalid Waiting List Key",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      WATESI99
.
WATESI91  MOVE      "Invalid Patient",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      WATESI99
.
WATESI92  MOVE      "Invalid ESIS Key",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      WATESI99
.
WATESI99  RETURN
.
.------------------------------------------------------------
. Display Waiting List Booking History
.------------------------------------------------------------
BOKHIS00  CALL      CLWATDET
          CALL      CLWTX000
          CALL      CLWATHIS
          CALL      CLBOKREC
.
          MOVE      CASEKEYS,KEY19
          CALL      RDTREA1
          BRANCH    OVRCD,BOKHIS90
.
          MOVE      CASEKEYS,KEY19
          CALL      RDWTTX11
          IF        OVRCD=1
            CALL      CLWTX000
          ENDIF
.
          UNPACK    CASEKEYS,URNUMBER
          MOVE      URNUMBER,KEY8           * visit number
          CALL      RDMAST1
          BRANCH    OVRCD,BOKHIS91
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MATCH     SP70,ADMISSNO
          IF        !@EQUAL
            PACK      KEY8,ADMISSNO,SP70
            CALL      RDBKREC1
            IF        OVRCD=1
              CALL      CLBOKREC
            ENDIF
          ENDIF
.
          MATCH     SP70,UPDTTYPE       * Display
          GOTO      BOKHIS50 IF EQUAL
          MATCH     "U",UPDTTYPE       * Update
          GOTO      BOKHIS20 IF EQUAL
          MATCH     "D",UPDTTYPE       * Delete Booking
          GOTO      BOKHIS30 IF EQUAL
          MOVE      "Invalid Update Type",WEBTITLE
          CALL      WEBERR00
          GOTO      BOKHIS99
.
BOKHIS20  CALL      UPBKHI00
          CALL      NXTPAG00
          GOTO      BOKHIS50
.
BOKHIS30  CALL      DLBKHI00
          CALL      NXTPAG00
          GOTO      BOKHIS50
.
BOKHIS50  CALL      PATNAM00
          MOVE      "Waiting List Booking History",WEBTITLE
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,BOKHIS99
.
          CALL      WEBBOD00
.
          CALL      WEBEND00
          MOVE      ZERO,EXIT
          GOTO      BOKHIS99
.
BOKHIS90  MOVE      "Invalid Waiting List Key",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      BOKHIS99
.
BOKHIS91  MOVE      "Invalid Patient",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      BOKHIS99
.
BOKHIS99  RETURN
.
.------------------------------------------------------------
. Display Waiting List Category Change History (Urgency changes)
.------------------------------------------------------------
CATHIS00  CALL      CLWATDET
          CALL      CLWTX000
          CALL      CLWATHIS
          CALL      CLBOKREC
.
          MOVE      CASEKEYS,KEY19
          CALL      RDTREA1
          BRANCH    OVRCD,CATHIS90
.
          MOVE      CASEKEYS,KEY19
          CALL      RDWTTX11
          IF        OVRCD=1
            CALL      CLWTX000
          ENDIF
.
          UNPACK    CASEKEYS,URNUMBER
          MOVE      URNUMBER,KEY8           * visit number
          CALL      RDMAST1
          BRANCH    OVRCD,CATHIS91
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MATCH     SP70,EFFCDATE
          IF        !@EQUAL
            MOVE      CASEKEYS,KEY19
            PACK      KEY29,KEY19,ANST,ANSP,EFFCDATE,SP70
            CALL      RDWTCAT2
          ENDIF
.
          MATCH     SP70,UPDTTYPE       * Display
          GOTO      CATHIS50 IF EQUAL
.
          MATCH     "U",UPDTTYPE       * Update
          GOTO      CATHIS20 IF EQUAL
.
          MATCH     "S",UPDTTYPE       * Supervisor Update
          GOTO      CATHIS30 IF EQUAL
.
          MATCH     "D",UPDTTYPE       * Supervisor Delete
          GOTO      CATHIS40 IF EQUAL
.
          MOVE      "Invalid Update Type",WEBTITLE
          CALL      WEBERR00
          GOTO      CATHIS99
.
CATHIS20  CALL      CATHIU00            * Update
          CALL      NXTPAG00
          GOTO      CATHIS50
.
CATHIS30  CALL      CATHSS00            * Supervisor Update
          CALL      NXTPAG00
          GOTO      CATHIS50
.
CATHIS40  CALL      CATHSD00            * Supervisor Delete
          CALL      NXTPAG00
          GOTO      CATHIS50
.
CATHIS50  CALL      PATNAM00
          MOVE      "Waiting List Category Change History",WEBTITLE
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,CATHIS99
.
          CALL      WEBBOD00
.
          CALL      WEBEND00
          MOVE      ZERO,EXIT
          GOTO      CATHIS99
.
CATHIS90  MOVE      "Invalid Waiting List Key",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CATHIS99
.
CATHIS91  MOVE      "Invalid Patient",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CATHIS99
.
CATHIS99  RETURN
.
.-----------------------------------------------------------------------------
. CATHIU00 - Update watcataf record
.-----------------------------------------------------------------------------
CATHIU00  MATCH     SP70,EFFCDATE
          GOTO      CATHIU99 IF EQUAL
.
          PACK      KEY8,Z70                 * 0=No 1=Yes
          CALL      RSWTEST1
          CALL      RPWTEST1
          BRANCH    OVRCD,CATHIU05
          MATCH     NEWEFFDT,WTESSDAT
          GOTO      CATHIU95 IF NOT LESS
.
CATHIU05  MOVE      CASEKEYS,KEY19
          PACK      KEY29,KEY19,ANST,ANSP,EFFCDATE,SP70
          MOVE      KEY29,SAVKEY29
          CALL      RDWTCAT2
          BRANCH    OVRCD,CATHIU90
.
          CALL      RPWTCAT2
          BRANCH    OVRCD,CATHIU91
.
          MATCH     WMURNO,WTCAURNO
          GOTO      CATHIU91 IF NOT EQUAL
.
          MATCH     WMCODE,WTCAPROC
          GOTO      CATHIU91 IF NOT EQUAL
.
          MATCH     DWMCNT,DWTCAPCN
          GOTO      CATHIU91 IF NOT EQUAL
.
          MATCH     NEWEFFDT,WTCAEDAT
          GOTO      CATHIU92 IF NOT LESS
.
          PACK      KEY29,KEY19,ANST,ANSP,EFFCDATE,SP70
          CALL      RDWTCAT2
          BRANCH    OVRCD,CATHIU90
.
          CALL      RKWTCAT2
          BRANCH    OVRCD,CATHIU10
.         
          MATCH     WMURNO,WTCAURNO
          GOTO      CATHIU10 IF NOT EQUAL
.         
          MATCH     WMCODE,WTCAPROC
          GOTO      CATHIU10 IF NOT EQUAL
.         
          MATCH     DWMCNT,DWTCAPCN
          GOTO      CATHIU10 IF NOT EQUAL
.
          MATCH     WTCAEDAT,NEWEFFDT
          GOTO      CATHIU93 IF NOT LESS
.
CATHIU10  PACK      KEY29,KEY19,ANST,ANSP,NEWEFFDT,SP70
          CALL      RAWTCAT2
          IF        OVRCD<>1
            GOTO      CATHIU94
          ENDIF
.
          MOVE      SAVKEY29,KEY29
          CALL      RDWTCAT2
          BRANCH    OVRCD,CATHIU90
.
          MOVE      NEWEFFDT,WTCAEDAT
          CALL      UPWTCAT2
          GOTO      CATHIU99
.
CATHIU90  MOVE      "Category change record not found",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CATHIU99
.
CATHIU91  MOVE      "Cannot update first category change record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CATHIU99
.
CATHIU92  MOVE      "New change date cannot be less than previous record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CATHIU99
.
CATHIU93  MOVE      "New change date cannot be after next change record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CATHIU99
.
CATHIU94  MOVE      "Record already exists for this date",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CATHIU99
.
CATHIU95  MOVE      "ESIS has been sealed, unable to update",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CATHIU99
.
CATHIU99  RETURN
+
.-----------------------------------------------------------------------------
. UPBKHI00 - Update booking history record
.-----------------------------------------------------------------------------
UPBKHI00  PACK     KEY8,ADMISSNO,SP70
          CALL     RDBKREC1
          BRANCH   OVRCD,UPBKHI99
.
          MATCH     Z70,BKREC034
          IF        !@EQUAL
            MATCH     SP70,BKREC034
            IF        @EQUAL
              MOVE      SP70,BKREBKDT
            ELSE
              UNPACK    BKREC034,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      BKREBKDT,CCENT,CYEAR,CMON,CDAY
              REP       " 0",BKREBKDT
            ENDIF
          ENDIF
.
          MATCH     Z70,BKREC004
          IF        !@EQUAL
            MATCH     SP70,BKREC004
            IF        !@EQUAL
              UNPACK    BKREC004,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      BKREEDAT,CCENT,CYEAR,CMON,CDAY
              REP       " 0",BKREEDAT
            ENDIF
          ENDIF
.
          MATCH     Z70,BKREC039
          IF        !@EQUAL
            MATCH     SP70,BKREC039
            IF        !@EQUAL
              UNPACK    BKREC039,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      BKREADAT,CCENT,CYEAR,CMON,CDAY
              REP       " 0",BKREADAT
            ENDIF
          ENDIF
.
          MATCH     Z70,BKREC009
          IF        !@EQUAL
            MOVE      BKREC009,BKRECANC
          ENDIF
.
          MATCH     SP70,BKRECANC
          IF        !@EQUAL
            MOVE      TWO,BKRESTAT
          ENDIF
.
          CALL      UPBKREC1
.
          MATCH     SP70,BKRECANC
          GOTO      UPBKHI99 IF EQUAL
.
          PACK      WTENSADI,DBKREBOO,SP70
          CALL      IBACLOCK
          PACK      WTENEVDT,CCC,CYY,CMM,CDD   * Write ESIS Intra Episode Record
          REP       " 0",WTENEVDT
          MATCH     WTENEVDT,BKREEDAT
          IF        @LESS
            PACK      WTENEVDT,BKREEDAT
            REP       " 0",WTENEVDT
          ENDIF
          PACK      WTENEVAL,BKRECANC,SP70
          MOVE      ANSP,WTENETYP
          PACK      KEY5,ANSB,ANSC,BKRECANC,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            MATCH     ANSA,THCSCOD
            IF        @EQUAL
              CALL      GETSET00
              GOTO      UPBKHI05
            ENDIF
          ENDIF
          CALL      WSAD0000
.
UPBKHI05  PACK      KEY31,CASEKEYS,SP70
          CALL      RSWTHIS1
UPBKHI10  CALL      RKWTHIS1
          BRANCH    OVRCD,UPBKHI99
.
          MATCH     WMURNO,WTHIURNO
          GOTO      UPBKHI99 IF NOT EQUAL
          MATCH     WMCODE,WTHIPROC
          GOTO      UPBKHI99 IF NOT EQUAL
          COMPARE   WMCNT,WTHIPCNT
          GOTO      UPBKHI99 IF NOT EQUAL
.
          MATCH     "21",WTHIBSCD
          GOTO      UPBKHI10 IF NOT EQUAL
.
          MATCH     WTHIBOOK,ADMISSNO
          GOTO      UPBKHI10 IF NOT EQUAL
.
          MOVE      BKRECANC,WTHIBCAN
          CALL      UPWTHIS1
.
UPBKHI99  RETURN
.
.-----------------------------------------------------------------------------
. DLBKHI00 - Delete booking record
.-----------------------------------------------------------------------------
DLBKHI00  PACK      KEY8,ADMISSNO,SP70
          CALL      RDBKREC1
          BRANCH    OVRCD,DLBKHI99
.
          COMPARE   TWO,BKRESTAT
          GOTO      DLBKHI90 IF NOT EQUAL
.
          CALL      DEBKREC1
          MOVE      ADMISSNO,KEY8           * booking number as key
          CALL      RDBKRX11                * read booking file
          BRANCH    OVRCD,DLBKHI99          * no record, update treatment file
          CALL      DEBKRX11                * delete the booking file
.
          GOTO      DLBKHI99
.
DLBKHI90  MOVE      "Booking not cancelled, unable to delete.",WEBTITLE
          CALL      WEBERR00
.
DLBKHI99  RETURN
.-----------------------------------------------------------------------------
. CHKSUS00 - Check waiting list suspension status
.-----------------------------------------------------------------------------
CHKSUS00  MOVE      ZERO,EXIT
          MOVE      ZERO,DATE1
          MATCH     Z70,BKREC004
          IF        !@EQUAL
            MATCH     SP70,BKREC004
            IF        !@EQUAL
              UNPACK    BKREC004,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      D8,CCENT,CYEAR,CMON,CDAY
              REP       " 0",D8
              MOVE      D8,DATE1
            ENDIF
          ENDIF
.
          PACK      KEY21,CASEKEYS,SP70
          CALL      RSWTSUS1
CHKSUS10  CALL      RKWTSUS1
          BRANCH    OVRCD,CHKSUS99
.
          MATCH     WMURNO,WTSUURNO
          GOTO      CHKSUS99 IF NOT EQUAL
.
          MATCH     WMCODE,WTSUCODE
          GOTO      CHKSUS99 IF NOT EQUAL
.
          COMPARE   WMCNT,WTSUCNT
          GOTO      CHKSUS99 IF NOT EQUAL
.
          MOVE      SP70,TCINDC4
          MOVE      "VL",CATEGORY
          MOVE      WTSULSTS,CODE
          PACK      KEY5,ANSV,ANSL,WTSULSTS,SP70
          CALL      RDCODE1
.
          MATCH     ANSR,TCINDC1                 * Ignore if RFC Suspension
          GOTO      CHKSUS10 IF EQUAL
.
          MOVE      ZERO,DATE2
          MOVE      ZERO,DATE3
          MOVE      WTSUFDAT,DATE2
          MOVE      WTSUTDAT,DATE3
.
          IF        DATE1 >= DATE2
            COMPARE   ZERO,DATE3
            GOTO      CHKSUS90 IF EQUAL
          ENDIF
.
          IF        DATE1 >= DATE2 & DATE1 < DATE3
            GOTO      CHKSUS90
          ENDIF
.
          GOTO      CHKSUS10
.
CHKSUS90  MOVE      ONE,EXIT
          GOTO      CHKSUS99

CHKSUS99  RETURN
.
.*************************************************************************
. Write unique id to bokunqaf to allow usage to be entered
.*************************************************************************
WRUSG000  MOVE      "42",FORM2              * get previous unique record
          MOVE      " 42",PRXCODE   * System Lock Sector 42
          CALL      GETSLK00        * Get System Lock of Sector 42
          READ      CONTROLF,FORM2;*32,OPCNUNIQ
          ADD       ONE,OPCNUNIQ            * set it to next unique number
          WRITAB    CONTROLF,FORM2;*32,OPCNUNIQ
          CALL      RELSLK00        * Release System Lock of Sector 42
          MOVE      OPCNUNIQ,OPDAUNIQ
.
          PACK      KEY18,BKREBOOK,OPDAUNIQ,SP70
          CALL      RDBKUNQ1
          IF        OVRCD<>1
            GOTO      WRUSG999
          ENDIF
.
          PACK      BKUNVISN,BKREBOOK,SP70
          PACK      BKUNUNIQ,OPDAUNIQ,SP70
          PACK      BKUNLADM,SP70
          PACK      BKUNWEBL,SP70
          PACK      BKUNDATL,SP70
          PACK      BKUNTIML,SP70
          PACK      KEY18,BKUNVISN,BKUNUNIQ,SP70
          CALL      WRBKUNQ1
.
WRUSG999  RETURN
.
.*************************************************************************
. Write interpreter details
.*************************************************************************
WRINT000  MATCH     "1",PMPXINTR
          GOTO      WRINT999 IF NOT EQUAL
.
          CALL      CLVISINT
          MOVE      BKREBOOK,VSINVISN
          MOVE      BKREEDAT,VSINDATE
          MOVE      BKREATIM,VSINTIME
          MOVE      "3",VSINTYPE
          MOVE      SP70,VSINSUBK
          MOVE      USERID,VSINWUID
.
          PACK      KEY8,BKREBOOK,SP70
          CALL      RAVSINT1
          IF        OVRCD=1
            CALL      WRVSINT1
            MOVE      "A",INTAUDTY
            CALL      INTAUD00
          ELSE
            CALL      UPVSINT1
            MOVE      "C",INTAUDTY
            CALL      INTAUD00
          ENDIF
.
WRINT999  RETURN
.
.*******************************************************************************
. INTCAN00 - Add Delete Interpreter Audit Table Record after cancel booking
.*******************************************************************************
INTCAN00  MATCH     "1",PMPXINTR
          GOTO      INTCAN99 IF NOT EQUAL
.
          PACK      KEY8,BKREBOOK,SP70
          CALL      RDVSINT1
          IF        OVRCD=0
            MOVE      "D",INTAUDTY
            CALL      INTAUD00           * Add record to Int.Audit after Cancel
          ENDIF
.
INTCAN99  RETURN
+
.*************************************************************************
. Update interpreter details
.*************************************************************************
INTUPD00  MATCH     "1",PMPXINTR
          GOTO      INTUPD99 IF NOT EQUAL
.
          CALL      CLVISINT
          MOVE      ZERO,DATACHNG                                      *I-40489
.
          PACK      KEY8,BKREBOOK,SP70
          CALL      RDVSINT1
....      IF        OVRCD=0
....        MOVE      "B",INTAUDTY
....        CALL      INTAUD00
....      ENDIF
.******************************************** Start of Addition        *I-40489
          BRANCH    OVRCD,INTUPD50          * new record - DATACHNG=0
.
          MOVE      ONE,DATACHNG
.                                           * has data changed?
          MATCH     BKREEDAT,VSINDATE
          GOTO      INTUPD50 IF NOT EQUAL
          MATCH     BKREATIM,VSINTIME
          GOTO      INTUPD50 IF NOT EQUAL
.
          MOVE      ZERO,DATACHNG           * no data changed - end it all
          GOTO      INTUPD99
.
INTUPD50  IF        DATACHNG = 1
            MOVE      "B",INTAUDTY          * "before change"
            CALL      INTAUD00
          ENDIF
.
.********************************************   End of Addition        *I-40489
.
          MOVE      BKREBOOK,VSINVISN
          MOVE      BKREEDAT,VSINDATE
          MOVE      BKREATIM,VSINTIME
          MOVE      "3",VSINTYPE
          MOVE      SP70,VSINSUBK
          MOVE      USERID,VSINWUID
....      PACK      KEY8,BKREBOOK,SP70                                  D-40489
....      CALL      RAVSINT1                                            D-40489
....      IF        OVRCD=0                                             D-40489
.                                           * test data change flag    *I-40489
          IF        DATACHNG = 1
            MOVE      "0",VSINNOTF                                     *I-40489
            CALL      UPVSINT1
            MOVE      "C",INTAUDTY
            CALL      INTAUD00
          ELSE
            CALL      WRVSINT1
            MOVE      "A",INTAUDTY
            CALL      INTAUD00
          ENDIF
.
INTUPD99  RETURN
+
.*******************************************************************************
. Update Interpreter Audit Table
.  Input - CASEKEYS  Key To Booking
.          INTAUDTY  Audit Type
.*******************************************************************************
INTAUD00  CALL      CLVISIAU
          PACK      VSIACDAT,CCC,CYY,CMM,CDD
          REP       " 0",VSIACDAT
          MOVE      CTIMEIS,VSIACTIM
          MOVE      INTAUDTY,VSIARTYP
.
          MOVE      VSINVISN,VSIAVISN
          MOVE      VSINDATE,VSIADATE
          MOVE      VSINTIME,VSIATIME
....      MOVE      "3",VSIATYPE                                        D-40489
          MOVE      VSINTYPE,VSIATYPE                                  *I-40489
          MOVE      VSINSUBK,VSIASUBK
          MOVE      VSINWUID,VSIAWUID
          MOVE      PMPXLNG1,VSIALNG1
          MOVE      PMPXLNG2,VSIALNG2
          MOVE      PMPXLNG3,VSIALNG3
          MOVE      VSINNOTF,VSIANOTF
          MOVE      VSINCONF,VSIACONF 
.
          PACK      KEY25,VSIACDAT,VSIACTIM,VSIARTYP,VSIAVISN,SP70
          CALL      RAVSIAU1
          IF        OVRCD=0
            CALL      UPVSIAU1
          ELSE
            CALL      WRVSIAU1
          ENDIF
          MOVE      ZERO,EXIT
INTAUD99  RETURN
+
.*******************************************************************************
. Change the U/R for a single waiting list procedure
.*******************************************************************************
FIXTRE00  MATCH     SP70,URNUMBER
          GOTO      FIXTRE99 IF EQUAL 
.
          MATCH     SP70,NEWURNUM
          GOTO      FIXTRE99 IF EQUAL 
.
          MOVE      URNUMBER,OURNO
.
          PACK      KEY19,CASEKEYS,SP70
          CALL      RDTREA1                      * read next record
          BRANCH    OVRCD,FIXTRE99
.
          MOVE      WMCNT,SAVWMCNT               * save the OLD count
          MOVE      WMCNT,SAVWCNTD
          DISPLAY   *P1:24,*EL,"Procedure : ",*V2LON,WMCODE,WMCNT;
.
.         Loop over treatment file for NEW UR until we get a unique count
.         for procedure code
.
FIXTRE30  PACK      KEY19,NEWURNUM,WMCODE,WMCNT
          CALL      RDTREA1                      * Proc/Count already on file ?
          BRANCH    OVRCD,FIXTRE50               * no - count ok
.
          ADD       ONE,WMCNT                    * yes - increment count
          COMPARE   "99",WMCNT                   * maximum reached ?
          GOTO      FIXTRE99 IF EQUAL            * yes - finished
          GOTO      FIXTRE30                     * get next count record
.
.         The next count for the procedure has been found for the new U/R
.
FIXTRE50  MOVE      WMCNT,NEWCNT                 * save the new count
          PACK      KEY19,OURNO,WMCODE,SAVWMCNT
          CALL      RDTREA1                      * reposition on old record
          MOVE      NEWURNUM,WMURNO              * update U/R number
          MOVE      NEWCNT,WMCNT                 * update count
          CALL      UPTREA1                      * update record
.
          PACK      NEWCASEK,WMURNO,WMCODE,WMCNT,SP70 * case key for redirect
.
.         Update Extn File with new urnumber
.
          PACK      KEY19,OURNO,WMCODE,SAVWMCNT
          CALL      RDWTTX11
          IF        OVRCD = 0
            MOVE      NEWURNUM,WTTXURNO          * update U/R number
            MOVE      NEWCNT,WTTXPCNT            * update count
            CALL      UPWTTX11                   * update record
          ENDIF
.
.         Update booking file with new count and UR if needed
.
          MOVE      WMBOOK,KEY8
          CALL      RDBKREC1
          IF        OVRCD = ZERO
            MOVE      NEWURNUM,BKREURNO
            MOVE      NEWCNT,BKRECNT
            CALL      UPBKREC1
          ENDIF
.
.         Update all other files, set OLD and NEW codes
.
          PACK      KEY38,OURNO,WMCODE,SAVWMCNT,NEWURNUM,WMCODE,NEWCNT
          MOVE      WMBOOK,BKREBOOK
          CALL      WLSGL000                * update the single procedure
.
          CALL      FIXWLC00
          CALL      ACCURC00
.
FIXTRE99  RETURN
.
.*********************************************************************
. Update ACC details file for this visit number
.*********************************************************************
ACCURC00  PACK      KEY8,ADMISSNO,SP70
          CALL      RDWCOM1
          BRANCH    OVRCD,ACCURC99
.
          MATCH     OURNO,PTWCURNO
          GOTO      ACCURC99 IF NOT EQUAL
.
          MOVE      NEWURNUM,PTWCURNO
          CALL      UPWCOM1
.
          OPEN      ACCLODA1,"acclodaf"
          PACK      KEY20,WCCLMNO,SP30
          CALL      RDACLOD1
          BRANCH    OVRCD,ACCURC99
.
          MOVE      NEWURNUM,ACLOURNO
          CALL      UPACLOD1
.
ACCURC99  RETURN
.
.*******************************************************************************
. Change the procedure code for a single waiting list episode
.*******************************************************************************
FIXPRO00  MATCH     SP70,URNUMBER
          GOTO      FIXPRO99 IF EQUAL
.
          MATCH     SP70,NEWPROCC
          GOTO      FIXPRO99 IF EQUAL
.
          MATCH     NEWPROCC,WMCODE
          GOTO      FIXPRO10 IF NOT EQUAL
.
          MOVE      ONE,PCOMFLAG                 * Flag for changing Proc.Comm.
          PACK      KEY19,CASEKEYS,SP70
          CALL      RDTREA1                      * read next record
          BRANCH    OVRCD,FIXPRO99
.
          PACK      NEWCASEK,WMURNO,WMCODE,WMCNT,SP70 * case key for redirect
.
          MATCH     Z70,WATTR058
          GOTO      FIXPRO99 IF EQUAL
.
          MOVE      WATTR058,WTWMPDSC
          CALL      UPTREA1                      * update record
          GOTO      FIXPRO99
.
FIXPRO10  MOVE      WMCODE,OLDPROC
          MOVE      WMCODE,SAVEOLDP
          MOVE      REASONFC,SAVEPCHG
.
          PACK      KEY19,CASEKEYS,SP70
          CALL      RDTREA1                      * read next record
          BRANCH    OVRCD,FIXPRO99
.
          MOVE      WMCNT,SAVWMCNT               * save the OLD count
          DISPLAY   *P1:24,*EL,"Procedure : ",*V2LON,WMCODE,WMCNT;
.
.         Loop over treatment file for NEW UR until we get a unique count
.         for procedure code
.
FIXPRO30  PACK      KEY19,URNUMBER,NEWPROCC,WMCNT
          CALL      RDTREA1                      * Proc/Count already on file ?
          BRANCH    OVRCD,FIXPRO50               * no - count ok
.
          ADD       ONE,WMCNT                    * yes - increment count
          COMPARE   "99",WMCNT                   * maximum reached ?
          GOTO      FIXPRO99 IF EQUAL            * yes - finished
          GOTO      FIXPRO30                     * get next count record
.
.         The next count for the procedure has been found for the new U/R
.
FIXPRO50  MOVE      WMCNT,NEWCNT                 * save the new count
          PACK      KEY19,URNUMBER,OLDPROC,SAVWMCNT
          CALL      RDTREA1                      * reposition on old record
          MOVE      NEWPROCC,WMCODE              * update procedure code
          MOVE      WATTR003,WMDESC              * update procedure desc
          MOVE      NEWCNT,WMCNT                 * update count
          MATCH     Z70,WATTR011
          IF        !@EQUAL
            MATCH     SP70,WATTR011
            IF        !@EQUAL
              MOVE      WATTR011,WMUNIT
            ENDIF
          ENDIF
.
          MATCH     Z70,WATTR058
          IF        !@EQUAL
            MOVE      WATTR058,WTWMPDSC
          ENDIF
.
          CALL      UPTREA1                      * update record
.
          COMPARE   ONE,CTHETR
          IF        !@EQUAL
            PACK      KEY18,WMBOOK,SP9,ONE,SP70
            PACK      OPDAUNIQ,SP9,ONE,SP70
          ELSE
            CALL      GETOPR00
          ENDIF
          CALL      RDBKDIA1
          IF        OVRCD=0
            MATCH     Z70,WATTR004
            IF        !@EQUAL
              MOVE      WATTR004,BKDIDES2
            ENDIF
.
            MATCH     Z70,WATTR003
            IF        !@EQUAL
              MOVE      WATTR003,BKDIDES1       * I CAR 46969
            ENDIF
            CALL      UPBKDIA1                * update file
          ENDIF
          PACK      NEWCASEK,WMURNO,WMCODE,WMCNT,SP70 * case key for redirect
.
.         Update Extn File with new urnumber
.
          PACK      KEY19,URNUMBER,OLDPROC,SAVWMCNT

          CALL      RDWTTX11
          IF        OVRCD = 0
            MOVE      NEWPROCC,WTTXPCOD           * update procedure code
            MOVE      NEWCNT,WTTXPCNT            * update count
            CALL      UPWTTX11                   * update record
          ENDIF
.
.         Update booking file with new count and UR if needed
.
          MOVE      WMBOOK,KEY8
          CALL      RDBKREC1
          IF        OVRCD = ZERO
            MOVE      NEWPROCC,BKREPROC
            MOVE      NEWCNT,BKRECNT
            CALL      UPBKREC1
          ENDIF
.
.         Update all other files, set OLD and NEW codes
.
          PACK      KEY38,URNUMBER,OLDPROC,SAVWMCNT,URNUMBER,NEWPROCC,NEWCNT
          MOVE      WMBOOK,BKREBOOK
          CALL      WLSGL000                * update the single procedure
          CALL      SAVHIS00
          MOVE      "34",WTWMBSCD
          CALL      WRTHSS00                * write to Waiting List History
          MOVE      SP70,SAVEOLDP
          MOVE      SP70,SAVEPCHG
.
FIXPRO99  RETURN
.
.*******************************************************************************
. Copy Waiting List Comments to new key
.*******************************************************************************
FIXCOM00  MOVE      SAVWMCNT,SAVWMCND
          MOVE      NEWCNT,NEWCND
.
          PACK      KEY28,URNUMBER,OLDPROC,SAVWMCND,ZERO,ZERO,ONE,SP70
          CALL      RSWTMHD1
FIXCOM10  CALL      RKWTMHD1
          BRANCH    OVRCD,FIXCOM50
.
          MATCH     URNUMBER,WTMHURNO
          GOTO      FIXCOM50 IF NOT EQUAL
.
          MATCH     OLDPROC,WTMHPROC
          GOTO      FIXCOM50 IF NOT EQUAL
.
          MATCH     SAVWMCND,WTMHPCNT
          GOTO      FIXCOM50 IF NOT EQUAL
.
          MATCH     "001",WTMHTYPE
          GOTO      FIXCOM50 IF NOT EQUAL
.
          PACK      SAVKEY28,WTMHURNO,WTMHPROC,WTMHPCNT,WTMHTYPE,WTMHNOTE,SP70
.
          MOVE      NEWPROCC,WTMHPROC
          MOVE      NEWCND,WTMHPCNT
.
          PACK      KEY28,WTMHURNO,WTMHPROC,WTMHPCNT,WTMHTYPE,WTMHNOTE,SP70
          CALL      RAWTMHD1
          IF        OVRCD=1
            CALL      WRWTMHD1
          ENDIF
.
          PACK      KEY28,SAVKEY28,SP70
          CALL      RDWTMHD1
.
          GOTO      FIXCOM10
.
FIXCOM50  PACK      KEY31,URNUMBER,OLDPROC,SAVWMCND,ZERO,ZERO,ONE,SP70
          CALL      RSWTMTX1
FIXCOM60  CALL      RKWTMTX1
          BRANCH    OVRCD,FIXCOM99
.
          MATCH     URNUMBER,WTMTURNO
          GOTO      FIXCOM99 IF NOT EQUAL
.
          MATCH     OLDPROC,WTMTPROC
          GOTO      FIXCOM99 IF NOT EQUAL
.
          MATCH     SAVWMCND,WTMTPCNT
          GOTO      FIXCOM99 IF NOT EQUAL
.
          MATCH     "001",WTMTTYPE
          GOTO      FIXCOM99 IF NOT EQUAL
.
          PACK      SAVKEY31,WTMTURNO,WTMTPROC,WTMTPCNT,WTMTTYPE,WTMTNOTE:
                             WTMTUNIQ,SP70
.
          MOVE      NEWPROCC,WTMTPROC
          MOVE      NEWCND,WTMTPCNT
.
          PACK      KEY31,WTMTURNO,WTMTPROC,WTMTPCNT,WTMTTYPE,WTMTNOTE:
                          WTMTUNIQ,SP70
          CALL      RAWTMTX1
          IF        OVRCD=1
            CALL      WRWTMTX1
          ENDIF
.
          PACK      KEY31,SAVKEY31,SP70
          CALL      RDWTMTX1
.
          GOTO      FIXCOM60
.
FIXCOM99  RETURN
.
.*********************************************************************
.         maintain the W/L files
.*********************************************************************
WLSGL000  UNPACK    KEY38,OLD,NEW           * the OLD count and NEW count
.
. fix watpnpaf
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      WATPNPA1,"watpnpaf"
          TRAPCLR   IO
          BRANCH    OVRCD,WLSGL100
.
          MOVE      BKREBOOK,KEY8
          CALL      RDWTPNP1
          IF        OVRCD = ZERO
            UNPACK    NEW,WTNPURNO,WTNPCODE,KEY2
            MOVE      KEY2,WTNPCNT
            CALL      UPWTPNP1
          ENDIF
.
. fix watlhiaf
.
WLSGL100  PACK      KEY30,OLD,SP30
          CALL      RSWTLHI1
          CALL      RKWTLHI1
          BRANCH    OVRCD,WLSGL200
          PACK      KEY19,WTLHURNO,WTLHCODE,WTLHCONT
          MATCH     OLD,KEY19
          GOTO      WLSGL200 IF NOT EQUAL
.
          UNPACK    NEW,WTLHURNO,WTLHCODE,KEY2
          MOVE      KEY2,WTLHCONT
          CALL      UPWTLHI1
          GOTO      WLSGL100
.
. fix watcataf
.
WLSGL200  PACK      KEY29,OLD,SP30
          CALL      RSWTCAT2
          CALL      RKWTCAT2
          BRANCH    OVRCD,WLSGL300
          PACK      KEY19,WTCAURNO,WTCAPROC,WTCAPCNT
          MATCH     OLD,KEY19
          GOTO      WLSGL300 IF NOT EQUAL
.
          UNPACK    NEW,WTCAURNO,WTCAPROC,KEY2
          MOVE      KEY2,WTCAPCNT
          CALL      UPWTCAT2
          GOTO      WLSGL200
.
. fix watmesaf
.
WLSGL300  PACK      KEY21,OLD,SP30
          CALL      RDSMESA1
          CALL      RDKMESA1
          BRANCH    OVRCD,WLSGL400
          PACK      KEY19,WAURNO,WAPROC,WACNT
          MATCH     OLD,KEY19
          GOTO      WLSGL400 IF NOT EQUAL
.
          UNPACK    NEW,WAURNO,WAPROC,KEY2
          MOVE      KEY2,WACNT
          CALL      UPMESA1
          GOTO      WLSGL300
.
. fix watsusaf
.
WLSGL400  PACK      KEY21,OLD,SP30
          CALL      RSWTSUS1
          CALL      RKWTSUS1
          BRANCH    OVRCD,WLSGL450
          PACK      KEY19,WTSUURNO,WTSUCODE,WTSUCNT
          MATCH     OLD,KEY19
          GOTO      WLSGL450 IF NOT EQUAL
.
          UNPACK    NEW,WTSUURNO,WTSUCODE,KEY2
          MOVE      KEY2,WTSUCNT
          CALL      UPWTSUS1
          GOTO      WLSGL400
.
WLSGL450  PACK      KEY21,OLD,SP30
          CALL      RSWTPAC1
          CALL      RKWTPAC1
          BRANCH    OVRCD,WLSGL500
          PACK      KEY19,WTPCURNO,WTPCPCOD,WTPCPCNT
          MATCH     OLD,KEY19
          GOTO      WLSGL500 IF NOT EQUAL
.
          UNPACK    NEW,WTPCURNO,WTPCPCOD,WTPCPCNT
          CALL      UPWTPAC1
          GOTO      WLSGL450
.
WLSGL500  PACK      KEY19,OLD,SP30
          CALL      RSWTRTD1
          CALL      RKWTRTD1
          BRANCH    OVRCD,WLSGL600
          PACK      KEY19,WTRTURNO,WTRTPROC,WTRTPCNT
          MATCH     OLD,KEY19
          GOTO      WLSGL600 IF NOT EQUAL
.
          UNPACK    NEW,WTRTURNO,WTRTPROC,WTRTPCNT
          CALL      UPWTRTD1
          GOTO      WLSGL500
.
WLSGL600  PACK      KEY31,OLD,SP30
          CALL      RSWTHIS1
          CALL      RKWTHIS1
          BRANCH    OVRCD,WLSGL700
          PACK      KEY19,WTHIURNO,WTHIPROC,DWTHIPCN
          MATCH     OLD,KEY19
          GOTO      WLSGL700 IF NOT EQUAL
.
          UNPACK    NEW,WTHIURNO,WTHIPROC,DWTHIPCN
          MOVE      DWTHIPCN,WTHIPCNT
          CALL      UPWTHIS1
          GOTO      WLSGL600
.
. fix watchaaf
.
WLSGL700  PACK      KEY35,OLD,SP30
          CALL      RSWTCHA1
          CALL      RKWTCHA1
          BRANCH    OVRCD,WLSGL800
          PACK      KEY19,WTCHURNO,WTCHPROC,WTCHPCNT
          MATCH     OLD,KEY19
          GOTO      WLSGL800 IF NOT EQUAL
.
          UNPACK    NEW,WTCHURNO,WTCHPROC,KEY2
          MOVE      KEY2,WTCHPCNT
          CALL      UPWTCHA1
          GOTO      WLSGL700
.
. fix watmhdaf
.
WLSGL800  PACK      KEY28,OLD,SP70
          CALL      RSWTMHD1
          CALL      RKWTMHD1
          BRANCH    OVRCD,WLSGL900
          PACK      KEY19,WTMHURNO,WTMHPROC,WTMHPCNT
          MATCH     OLD,KEY19
          GOTO      WLSGL900 IF NOT EQUAL
.
          UNPACK    NEW,WTMHURNO,WTMHPROC,KEY2
          MOVE      KEY2,WTMHPCNT
          CALL      UPWTMHD1
          GOTO      WLSGL800
.
. fix watmtxaf
.
WLSGL900  PACK      KEY31,OLD,SP70
          CALL      RSWTMTX1
          CALL      RKWTMTX1
          BRANCH    OVRCD,WLSGL910
          PACK      KEY19,WTMTURNO,WTMTPROC,WTMTPCNT
          MATCH     OLD,KEY19
          GOTO      WLSGL910 IF NOT EQUAL
.
          UNPACK    NEW,WTMTURNO,WTMTPROC,KEY2
          MOVE      KEY2,WTMTPCNT
          CALL      UPWTMTX1
          GOTO      WLSGL900
.
WLSGL910  PACK      KEY19,OLD,SP70
          CALL      RDALWLN1
          BRANCH    OVRCD,WLSGL999
.
          UNPACK    NEW,ALWLURNO,ALWLPCOD,ALWLPCNT
          CALL      UPALWLN1
.
WLSGL999  RETURN
.
.*****************************************************************************
. Create redirect string to the new casekey
.*****************************************************************************
SETDIR00  CLEAR     REDIRECT
          REP       " +",NEWCASEK
          APPEND    "watweb01.pbl?",REDIRECT
          APPEND    "&reportno=2",REDIRECT
          APPEND    "&template=1",REDIRECT
          APPEND    "&casekeys=",REDIRECT
          APPEND    NEWCASEK,REDIRECT
          RESET     REDIRECT
.
          REP       "+ ",NEWCASEK
.
SETDIR99  RETURN
.
.*****************************************************************************
. UPBC0000 - Update the last cancelled booking BKRECANC field for the 
.            Supervisor waitign list update screen.Loop back because we do not
.            have a booking number for this cancellation
.*****************************************************************************
UPBC0000  PACK      KEY16,WMURNO,Z70
          CALL      RSBKREC6
UPBC1000  CALL      RPBKREC6
          BRANCH    OVRCD,UPBC9999
.
          MATCH     BKREURNO,WMURNO
          GOTO      UPBC9999 IF NOT EQUAL
.
          COMPARE   TWO,BKRESTAT
          GOTO      UPBC1000 IF NOT EQUAL
.
          MATCH     BKREPROC,WMCODE
          GOTO      UPBC1000 IF NOT EQUAL
.
          COMPARE   BKRECNT,WMCNT
          GOTO      UPBC1000 IF NOT EQUAL
.
          MOVE      BKREC009,BKRECANC
          CALL      UPBKREC6 
          MOVE      BKRECANC,SAVEBOKC
.
          CALL      IBACLOCK
          PACK      WTENEVDT,CCC,CYY,CMM,CDD   * Write ESIS Intra Episode Record
          REP       " 0",WTENEVDT
          PACK      WTENEVAL,BKRECANC
          MOVE      ANSP,WTENETYP
          PACK      WTENSADI,DBKREBOO,SP70
          PACK      KEY5,ANSB,ANSC,BKRECANC,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            MATCH     ANSA,THCSCOD
            IF        @EQUAL
              CALL      GETSET00
              GOTO      UPBC9999
            ENDIF
          ENDIF
          CALL      WSAD0000
.
UPBC9999  RETURN
+
.
.*****************************************************************************
. CLWTHS00 - Clear file variables for WATHISFD                         
.*****************************************************************************
CLWTHS00  MOVE      SP70,WTHIURNO 
          MOVE      SP70,WTHIPROC 
          MOVE      SP70,WTHIEDAT 
          MOVE      SP70,WTHIPRIO 
          MOVE      SP70,WTHIRANK 
          MOVE      SP70,WTHIDAT2 
          MOVE      SP70,WTHIDAT3 
          MOVE      SP70,WTHIRDT3 
          MOVE      SP70,WTHIBSCD 
          MOVE      SP70,WTHIDCGV 
          MOVE      SP70,WTHIDBFT 
          MOVE      SP70,WTHIRECS 
.        
          MOVE      SP70,WTHIRTYP 
          MOVE      SP70,WTHIRCDT 
          MOVE      SP70,WTHIBMDT 
          MOVE      SP70,WTHIETIM 
          MOVE      SP70,WTHIADTE 
          MOVE      SP70,WTHIATIM 
          MOVE      SP70,WTHIWEBI 
          MOVE      SP70,WTHIBCAN 
          MOVE      SP70,WTHIBOOK 
          MOVE      SP70,WTHIDOCT 
          MOVE      SP70,WTHIBOKC 
          MOVE      SP70,WTHIUNIT 
          MOVE      SP70,WTHIPLST 
          MOVE      SP70,WTHISTAT 
          MOVE      SP70,WTHIDAT1 
          MOVE      SP70,WTHIDTAD 
          MOVE      SP70,WTHIPODT 
          MOVE      SP70,WTHICODT 
          MOVE      SP70,WTHISPAR 
          MOVE      ZERO,WTHIPCNT 
          MOVE      ZERO,WTHIUCNT 

CLWTHS99  RETURN
.
.*****************************************************************************
. UPDHIS00 - Updaet a waiting list history record                      
.*****************************************************************************
UPDHIS00  MATCH     SP70,PHISTKEY
          GOTO      UPDHIS99 IF EQUAL
.
          MATCH     WTHIEDAT,WATHI002       * If effective date different
          GOTO      UPDHIS50 IF NOT EQUAL   * generate a new unique count
.
UPDHID20  CALL      MVWTHI00                * Move cgi's to file variables
          CALL      UPWTHIS1                * Update History File
.
          PACK      KEY8,WTHIBOOK,SP70
          CALL      RDBKREC1
          BRANCH    OVRCD,UPDHIS30
.
          MOVE      WTHIBCAN,BKRECANC        * Cancellation reason (Cat BC)
          CALL      UPBKREC1
.
UPDHIS30  PACK      KEY8,WTHIBOOK,SP70
          CALL      RDBKRX11
          BRANCH    OVRCD,UPDHIS99
.
          MOVE      WTHIBOKC,BKRXUDF1        * Canc Booking Reason (Cat BE)
          CALL      UPBKRX11
.
          GOTO      UPDHIS99
.
UPDHIS50  PACK      KEY31,WMURNO,WMCODE,WMCNT,WATHI002,Z70
          CALL      RSWTHIS1
          CALL      RPWTHIS1
          BRANCH    OVRCD,UPDHIS60
.
          MATCH     WMURNO,WTHIURNO
          GOTO      UPDHIS60 IF NOT EQUAL
.
          MATCH     WMCODE,WTHIPROC
          GOTO      UPDHIS60 IF NOT EQUAL
.
          COMPARE   WMCNT,WTHIPCNT
          GOTO      UPDHIS60 IF NOT EQUAL
.
          MATCH     WATHI002,WTHIEDAT
          GOTO      UPDHIS60 IF NOT EQUAL
.
          ADD       ONE,WTHIUCNT
          GOTO      UPDHIS70
.
UPDHIS60  MOVE      ONE,WTHIUCNT
.
UPDHIS70  MOVE      WTHIUCNT,NEWCOUNT
          PACK      KEY31,PHISTKEY,SP70
          CALL      RDWTHIS1
          BRANCH    OVRCD,UPDHIS99
.
          CALL      MVWTHI00                * Move cgi's to file variables
          MOVE      NEWCOUNT,WTHIUCNT
.
          CALL      UPWTHIS1                * Write new history record
.
          PACK      KEY8,WTHIBOOK,SP70
          CALL      RDBKREC1
          BRANCH    OVRCD,UPDHIS75
.
          MOVE      WTHIBCAN,BKRECANC        * Cancellation reason (Cat BC)
          CALL      UPBKREC1
....      CALL      IBACLOCK
....      PACK      WTENEVDT,CCC,CYY,CMM,CDD   * Write ESIS Intra Episode Record
....      REP       " 0",WTENEVDT
....      PACK      WTENEVAL,BKRECANC
....      MOVE      ANSP,WTENETYP
....      PACK      WTENSADI,DBKREBOO,SP70
....      CALL      WSAD0000
.
UPDHIS75  PACK      KEY8,WTHIBOOK,SP70
          CALL      RDBKRX11
          BRANCH    OVRCD,UPDHIS99
.
          MOVE      WTHIBOKC,BKRXUDF1        * Canc Booking Reason (Cat BE)
          CALL      UPBKRX11
.
UPDHIS99  RETURN
.
.************************************************************************
.*  WHIS0000  :  Write a record to the history file                     *
.************************************************************************
WHIS0000  COMPARE   ONE,WTCNULHI
          GOTO      WHIS9999 IF NOT EQUAL
          PACK      KEY19,WMURNO,WMCODE,WMCNT
          CALL      RDTREA1
          BRANCH    OVRCD,WHIS9999
.
          MOVE      WMURNO,WTLHURNO
          MOVE      WMCODE,WTLHCODE
          MOVE      WMCNT,WTLHCONT
          PACK      WTLHDATE,CCC,CYY,CMM,CDD
          REP       " 0",WTLHDATE
          MOVE      LETTFORM,WTLHLNUM
          MOVE      SP3,WTLHRPLY
          MOVE      SP3,WTLHACTN
.
          PACK      KEY30,WTLHURNO,WTLHCODE,WTLHCONT,WTLHDATE,WTLHLNUM,SP70
          CALL      RAWTLHI1
          IF        OVRCD=1
            CALL      WRWTLHI1
          ENDIF
.
WHIS9999  RETURN
.
.---------------------------------------------------------------------
. SLSTAT00 - Selection list for cat VL where TCINDC1 is not equal to R
.---------------------------------------------------------------------
SLSTAT00  MOVE      SP70,TDESC
          PACK      KEY5,CATEGORY,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      CATEGORY,TCODE
            MOVE      "Invalid Category",TDESC
          ENDIF
          REP       " _",TCODE
          REP       " _",THCSCOD
          WRITE     HTMLFILE;"<!--<cat-c category=#"",TCODE,"#" name=#"",TDESC:
                             "#" map=#"",THCSCOD,"#"></cat-c>-->"
.
          PACK      PTCDKEY2,CATEGORY,SP70
          CALL      RDSCODE2
SLSTAT10  CALL      RDKCODE2
          BRANCH    OVRCD,SLSTAT99
          MATCH     CATEGORY,TCODE
          GOTO      SLSTAT99 IF NOT EQUAL
          MATCH     SP70,ACODE
          GOTO      SLSTAT10 IF EQUAL
          MATCH     "I",PTCOACTV
          GOTO      SLSTAT10 IF EQUAL
          PACK      KEY15,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5:
                          TCINDC6,TCINDC7,TCINDC8,TCINDC9,TCINDC10:
                          TCINDC11,THCSCOD
          PACK      KEY20,QUOTE,ACODE,KEY15,QUOTE
          MATCH     CODE,ACODE
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY20," selected>":
                               TDESC,"</option>"
          ELSE
            MATCH     ANSR,TCINDC1
            IF        !@EQUAL
              WRITE     HTMLFILE;"<option value=",KEY20,">",TDESC,"</option>"
            ENDIF
          ENDIF
          GOTO      SLSTAT10
SLSTAT99  RETURN
.
.---------------------------------------------------------------------
. CHGDOC00 - Check if the doctor need to be updated                    
.---------------------------------------------------------------------
CHGDOC00  MATCH     SAVDOCTR,WMDOCTOR     * Update doctor if doctor changed
          GOTO      CHGDOC99 IF EQUAL     * and WMSTAT = 2 or 3
.
          COMPARE   TWO,WMSTAT                   * Scheduled
          GOTO      CHGDOC10 IF EQUAL
.
          COMPARE   THREE,WMSTAT                 * Pre-Admitted
          GOTO      CHGDOC10 IF EQUAL
.
          GOTO      CHGDOC99
.
CHGDOC10  PACK      KEY8,WMBOOK
          CALL      RDBKREC1
          BRANCH    OVRCD,CHGDOC99 
.
          COMPARE   ZERO,BKRESTAT                * Booked
          GOTO      CHGDOC20 IF EQUAL
.
          COMPARE   ONE,BKRESTAT                 * Pre-Admitted
          GOTO      CHGDOC20 IF EQUAL
          GOTO      CHGDOC99
.
CHGDOC20  MATCH     SP70,BKRETYPE                * Update doctor if it is a
          GOTO      CHGDOC99 IF EQUAL            * medical booking
.
          PACK      KEY5,ANSB,ANSK,BKRETYPE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CHGDOC99
.
          MATCH     "THE ",THCSCOD
          GOTO      CHGDOC99 IF EQUAL
.
CHGDOC30  MOVE      WMDOCTOR,BKREADOC
          CALL      UPBKREC1
.
          COMPARE   ZERO,BKRESTAT                * No visit or admission if 
          GOTO      CHGDOC99 IF EQUAL            * status is booked
.
          PACK      KEY8,WMBOOK
          CALL      RDMISS1
          BRANCH    OVRCD,CHGDOC99 
.
          MOVE      WMDOCTOR,ADOCTA
          CALL      UPMISS1
.
          PACK      KEY8,WMBOOK
          CALL      RDVISA1
          BRANCH    OVRCD,CHGDOC99 
.
          MOVE      WMDOCTOR,PVIDOCT
          CALL      UPVISA1
.
          PACK      KEY8,WMBOOK
          CALL      RDPMVX11
          BRANCH    OVRCD,CHGDOC99 
.
          MOVE      WMDOCTOR,PMVXDOCA
          CALL      UPPMVX11
.
CHGDOC99  RETURN
.
.-----------------------------------------------------------------------------
. CHKINT00 - Check if patient has an intra episode event after the removal date
.-----------------------------------------------------------------------------
CHKINT00  COMPARE   THREE,PTCNHDPS
          GOTO      CHKINT99 IF NOT EQUAL   * Not in Victoria
.
          MOVE      ZERO,EXIT
          CALL      IBACLOCK
.
          MATCH     Z70,WATTR009
          GOTO      CHKINT99 IF EQUAL
.
          MATCH     SP70,WATTR009
          GOTO      CHKINT99 IF EQUAL
.
          UNPACK    WATTR009,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00
          PACK      D8,CCENT,CYEAR,CMON,CDAY
          REP       " 0",D8
.
          PACK      KEY36,WTWMECNT,SP70
          CALL      RSWTESN1
CHKINT10  CALL      RKWTESN1
          BRANCH    OVRCD,CHKINT99
.
          MATCH     WTWMECNT,WTENUNIQ
          GOTO      CHKINT99 IF NOT EQUAL
.
          MATCH     WTENEVDT,D8
          IF        @LESS
            MOVE      ONE,EXIT
          ELSE
            GOTO      CHKINT10
          ENDIF
.
CHKINT99  RETURN
+
.-----------------------------------------------------------------------------
. CHKDEL00 - Check is patient is not suspened before removal from waiting list
.          - Do not allow removal if a future suspension exists
.-----------------------------------------------------------------------------
CHKDEL00  MOVE      ZERO,EXIT
          CALL      IBACLOCK
.
          PACK      D8,CCC,CYY,CMM,CDD
          REP       " 0",D8
          MOVE      D8,DATE1
.
          MATCH     Z70,WATTR009
          IF        !@EQUAL
            MATCH     SP70,WATTR009
            IF        !@EQUAL
              UNPACK    WATTR009,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
              CALL      SETMTH00
              PACK      D8,CCENT,CYEAR,CMON,CDAY
              REP       " 0",D8
              MOVE      D8,DATE1
            ENDIF
          ENDIF
.
          PACK      KEY21,WMURNO,WMCODE,WMCNT,SP70
          CALL      RSWTSUS1
CHKDEL20  CALL      RKWTSUS1
          BRANCH    OVRCD,CHKDEL99
.
          MATCH     WMURNO,WTSUURNO
          GOTO      CHKDEL99 IF NOT EQUAL
.
          MATCH     WMCODE,WTSUCODE
          GOTO      CHKDEL99 IF NOT EQUAL
.
          COMPARE   WMCNT,WTSUCNT
          GOTO      CHKDEL99 IF NOT EQUAL
.
          MOVE      SP70,TCINDC4
          MOVE      "VL",CATEGORY
          MOVE      WTSULSTS,CODE
          PACK      KEY5,ANSV,ANSL,WTSULSTS,SP70
          CALL      RDCODE1
.
          MATCH     ANSR,TCINDC1                 * Ignore if RFC Suspension
          GOTO      CHKDEL20 IF EQUAL
.
          MOVE      ZERO,DATE2
          MOVE      ZERO,DATE3
          MOVE      WTSUFDAT,DATE2
          MOVE      WTSUTDAT,DATE3
.
          IF        DATE2 > DATE1
            GOTO      CHKDEL95
          ENDIF

          IF        DATE1 >= DATE2
            COMPARE   ZERO,DATE3
            GOTO      CHKDEL90 IF EQUAL
          ENDIF
.
          IF        DATE1 >= DATE2 & DATE1 < DATE3
            GOTO      CHKDEL90
          ENDIF
.
          GOTO      CHKDEL20
.
CHKDEL90  MOVE      ONE,EXIT
          GOTO      CHKDEL99
.
CHKDEL95  MOVE      TWO,EXIT
          GOTO      CHKDEL99
.
CHKDEL99  RETURN
.
.-----------------------------------------------------------------------------
. CLWTOS00 - Clear waiting list pre anawsthetic outpatient link file
.-----------------------------------------------------------------------------
CLWTOS00  MOVE      SP70,WTOSURNO
          MOVE      SP70,WTOSCODE
          MOVE      SP70,WTOSCOUN
          MOVE      SP70,WTOSSITE
          MOVE      SP70,WTOSCLIN
          MOVE      SP70,WTOSDATE
          MOVE      SP70,WTOSSTRT
          MOVE      SP70,WTOSSLOT
          MOVE      SP70,WTOSOUTN
          MOVE      SP70,WTOSOSTA
          MOVE      SP70,WTOSPDAT
          MOVE      SP70,WTOSPTIM
          MOVE      SP70,WTOSSTAT
          MOVE      SP70,WTOSCDAT
          MOVE      SP70,WTOSCTIM
          MOVE      SP70,WTOSCUID
          MOVE      SP70,WTOSUDAT
          MOVE      SP70,WTOSUTIM
          MOVE      SP70,WTOSUUID
          MOVE      SP70,WTOSSPAR
.
CLWTOS99  RETURN
.
.-----------------------------------------------------------------------------
. PADM0000 - Check for outpatient pre admission link booking
.-----------------------------------------------------------------------------
PADM0000  PACK      KEY27,WMURNO,WMCODE,WMCNT,SP70
          CALL      RSWTOPA1
PADM1000  CALL      RKWTOPA1
          BRANCH    OVRCD,PADM9000
.
          MATCH     WTOPURNO,WMURNO
          GOTO      PADM9000 IF NOT EQUAL
.
          MATCH     WTOPCODE,WMCODE
          GOTO      PADM9000 IF NOT EQUAL
.
          MATCH     WTOPCOUN,DWMCNT
          GOTO      PADM9000 IF NOT EQUAL
.
          MATCH     "0",WTOPSTAT
          GOTO      PADM9999 IF EQUAL
.
          GOTO      PADM1000
.
PADM9000  CALL      CLWATOPA
          GOTO      PADM9999
.
PADM9999  RETURN
.
.-----------------------------------------------------------------------------
. PANS0000 - Check for outpatient pre anaesthetic link booking
.-----------------------------------------------------------------------------
PANS0000  PACK      KEY27,WMURNO,WMCODE,WMCNT,SP70
          CALL      RSWTOPS1
PANS1000  CALL      RKWTOPS1
          BRANCH    OVRCD,PANS9000
.
          MATCH     WTOSURNO,WMURNO
          GOTO      PANS9000 IF NOT EQUAL
.
          MATCH     WTOSCODE,WMCODE
          GOTO      PANS9000 IF NOT EQUAL
.
          MATCH     WTOSCOUN,DWMCNT
          GOTO      PANS9000 IF NOT EQUAL
.
          MATCH     "0",WTOSSTAT
          GOTO      PANS9999 IF EQUAL
.
          GOTO      PANS1000
.
PANS9000  CALL      CLWTOS00
          GOTO      PANS9999
.
PANS9999  RETURN
.
.-----------------------------------------------------------------------------
. CTRN0000 - Check transfer source                                
.-----------------------------------------------------------------------------
CTRN0000  MATCH     Z70,TRNSFSRC                 * No transfer source 
          GOTO      CTRN9000 IF EQUAL
.
          MATCH     SP70,TRNSFSRC                * No transfer source
          GOTO      CTRN9000 IF EQUAL
.
          PACK      TRNSCODE,TRNSFSRC,SP70
.
          MATCH     Z70,WATTR006                 * No date on list
          GOTO      CTRN9000 IF EQUAL
.
          MATCH     SP70,WATTR006                * No date on list
          GOTO      CTRN9000 IF EQUAL
.
          UNPACK    WATTR006,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00
          PACK      TRNSDATE,CCENT,CYEAR,CMON,CDAY
          REP       " 0",TRNSDATE
.
          CALL      CVAD0000                     * Validate transfer source
          BRANCH    EXIT,CTRN9999
.
CTRN9000  MOVE      ZERO,EXIT
          GOTO      CTRN9999
.
CTRN9999  RETURN
.
.******************************************************************************
.*                                 CHKESI00                                   *
.*                 Check if any ESIS have changed since last sent             *
.******************************************************************************
.
CHKESI00  MOVE      ZERO,EXIT
.
          MATCH     WTEPPDOB,PBDATE
          GOTO      CHKESI90 IF NOT EQUAL
.
          MATCH     WTEPEDOB,PMPXEDOB
          GOTO      CHKESI90 IF NOT EQUAL
.
          MATCH     WTEPPSEX,PSEX
          GOTO      CHKESI90 IF NOT EQUAL
.
          MATCH     WTEPMEDI,PMEDI
          GOTO      CHKESI90 IF NOT EQUAL
.
          SQUEEZE   PTMXMCCD
          MATCH     WTEPMREF,PTMXMCCD
          GOTO      CHKESI90 IF NOT EQUAL
.
          MATCH     WTEPRESI,PTYPE
          GOTO      CHKESI90 IF NOT EQUAL
.
          MATCH     WTEPPOST,PPOST
          GOTO      CHKESI90 IF NOT EQUAL
.
          MATCH     WTEPSUBR,PSUBRB
          GOTO      CHKESI90 IF NOT EQUAL
.
          MATCH     WTEPABRG,PMPXABRG
          GOTO      CHKESI90 IF NOT EQUAL
.
          MATCH     WTEPPGEN,PMPXUCC4
          GOTO      CHKESI90 IF NOT EQUAL
.
          MOVE      ONE,EXIT                 * No Changes
.
CHKESI90  GOTO      CHKESI99
.
CHKESI99  RETURN
+
.******************************************************************************
.*                                 WESP0000                                   *
.*                          Write/update watespaf                             *
.******************************************************************************
.
WESP0000  READ      CONTROLF,EIGHTY;*250,PTCNHDPS
.
          COMPARE   THREE,PTCNHDPS
          GOTO      WESE9999 IF NOT EQUAL   * Not in Victoria
.
          PACK      KEY16,PURNO,Z70
          CALL      RSWTESP1
          CALL      RPWTESP1
          BRANCH    OVRCD,WESP0100
.
          MATCH     PURNO,WTEPURNO
          GOTO      WESP0100 IF NOT EQUAL
.
          CALL      CHKESI00
          BRANCH    EXIT,WESP0999   * no changes
          GOTO      WESP0200
.
WESP0100  CALL      CLRWTESI
.
WESP0200  PACK      WTEPURNO,PURNO
          PACK      WTEPEDAT,SP70
          PACK      WTEPPDOB,PBDATE,SP70
          PACK      WTEPEDOB,PMPXEDOB,SP70
          PACK      WTEPPSEX,PSEX,SP70
          PACK      WTEPMEDI,PMEDI,SP70
          SQUEEZE   PTMXMCCD
          PACK      WTEPMREF,PTMXMCCD,SP70
          PACK      WTEPRESI,PTYPE,SP70
          PACK      WTEPPOST,PPOST,SP70
          PACK      WTEPSUBR,PSUBRB,SP70
          PACK      WTEPABRG,PMPXABRG,SP70
          PACK      WTEPPGEN,PMPXUCC4,SP70
.
          CALL      IBACLOCK
          PACK      XDATE,CCC,CYY,CMM,CDD
          REP       " 0",XDATE
.
          PACK      KEY19,URNUMBER,SP70
          CALL      RSPMCCD1
WESP0280  CALL      RKPMCCD1
          BRANCH    OVRCD,WESP0300
.
          MATCH     URNUMBER,PMCDURNO
          GOTO      WESP0300 IF NOT EQUAL
.
          MATCH     XDATE,PMCDEXDT
          IF        !@LESS
            MATCH     "NDI",PMCDCTYP
            IF        @EQUAL
              PACK    WTEPNDIS,PMCDCNUM,SP70
            ENDIF
          ENDIF
          GOTO      WESP0280
.
WESP0300  PACK      WTEPSPAR,SP70
.
          PACK      KEY16,PURNO,SP70
          CALL      RAWTESP1
          IF        OVRCD=1
            PACK      WTEPWEBC,WBSEUID,SP70
            PACK      WTEPCDAT,CCC,CYY,CMM,CDD,SP70
            REP       " 0",WTEPCDAT
            PACK      WTEPCTIM,CTIMEIS,SP70
            REP       " 0",WTEPCTIM
            CALL      WRWTESP1
          ELSE
            PACK      WTEPWEBU,WBSEUID,SP70
            PACK      WTEPUDAT,CCC,CYY,CMM,CDD,SP70
            REP       " 0",WTEPUDAT
            PACK      WTEPUTIM,CTIMEIS,SP70
            REP       " 0",WTEPUTIM
            CALL      UPWTESP1
          ENDIF
.
WESP0999  RETURN
.
CLRWTESI  PACK      WTEPURNO,SP70
          PACK      WTEPEDAT,SP70
          PACK      WTEPPDOB,SP70
          PACK      WTEPEDOB,SP70
          PACK      WTEPPSEX,SP70
          PACK      WTEPMEDI,SP70
          PACK      WTEPMREF,SP70
          PACK      WTEPRESI,SP70
          PACK      WTEPPOST,SP70
          PACK      WTEPSUBR,SP70
          PACK      WTEPABRG,SP70
          PACK      WTEPWEBC,SP70
          PACK      WTEPCDAT,SP70
          PACK      WTEPCTIM,SP70
          PACK      WTEPWEBU,SP70
          PACK      WTEPUDAT,SP70
          PACK      WTEPUTIM,SP70
          PACK      WTEPPGEN,SP70
          PACK      WTEPNDIS,SP70
          PACK      WTEPSPAR,SP70
.
          RETURN
.
CLRWTESE  PACK      WTEEUNIQ,SP70
          PACK      WTEEURNO,SP70
          PACK      WTEEDEST,SP70
          PACK      WTEEINSD,SP70
          PACK      WTEEPLOS,SP70
          PACK      WTEEPROC,SP70
          PACK      WTEEPDES,SP70
          PACK      WTEERDAT,SP70
          PACK      WTEESREF,SP70
          PACK      WTEESSPC,SP70
          PACK      WTEEWEBC,SP70
          PACK      WTEECDAT,SP70
          PACK      WTEECTIM,SP70
          PACK      WTEEWEBU,SP70
          PACK      WTEEUDAT,SP70
          PACK      WTEEUTIM,SP70
          PACK      WTEEARDT,SP70
          PACK      WTEEMANU,ZERO
          PACK      WTEERADT,SP70
          PACK      WTEETCMP,SP70
          PACK      WTEESPAR,SP70
          PACK      WTEEPTWT,SP70
          PACK      WTEEASAS,SP70
          PACK      WTEESGID,SP70
.
          RETURN
.******************************************************************************
.*                                 WESE0000                                   *
.*                Write/update wateseaf (episode details)                     *
.******************************************************************************
WESE0000  READ      CONTROLF,EIGHTY;*250,PTCNHDPS
.
          COMPARE   THREE,PTCNHDPS
          GOTO      WESE9999 IF NOT EQUAL   * Not in Victoria
.
          MOVE      SP70,SWTEADAT
          MOVE      SP70,SWTEREMD
          MOVE      SP70,SWTERREM
          MOVE      SP70,SWTEINSD
          MOVE      SP70,SWTERADT
.
          PACK      KEY17,WTWMECNT,SP70
          CALL      RDWTESE1
          IF        OVRCD<>1
            MOVE      WTEEADAT,SWTEADAT
            MOVE      WTEEREMD,SWTEREMD
            MOVE      WTEERREM,SWTERREM
            MOVE      WTEEINSD,SWTEINSD
            MOVE      WTEERADT,SWTERADT
          ENDIF
.
          PACK      KEY17,WTWMECNT,Z70
          CALL      RSWTESE1
          CALL      RPWTESE1
          IF        OVRCD=1
            MOVE      SP70,WTEEADAT
            MOVE      SP70,WTEEREMD
            MOVE      SP70,WTEERREM
            GOTO      WESE1000
          ENDIF
.
          MATCH     WTEEUNIQ,WTWMECNT
          IF        @EQUAL
            MOVE      WTEEADAT,SWTEADAT
            MOVE      WTEEREMD,SWTEREMD
            MOVE      WTEERREM,SWTERREM
            MOVE      WTEEINSD,SWTEINSD
            MOVE      WTEERADT,SWTERADT
          ELSE
            MOVE      SP70,WTEEADAT
            MOVE      SP70,WTEEREMD
            MOVE      SP70,WTEERREM
            GOTO      WESE1000
          ENDIF
.
          MOVE      SWTEADAT,WTEEADAT
          MOVE      SWTEREMD,WTEEREMD
          MOVE      SWTERREM,WTEERREM
          MOVE      SWTEINSD,WTEEINSD
          MOVE      SWTERADT,WTEERADT
.
WESE0500  CALL      CHKESE00
          BRANCH    EXIT,WESE9999   * no changes
          GOTO      WESE2000
.
WESE1000  CALL      CLRWTESE
.
WESE2000  PACK      WTEEUNIQ,WTWMECNT,SP70
          PACK      WTEEEDAT,SP70
          PACK      WTEEURNO,WMURNO,SP70
          PACK      WTEESGID,WTTXRCLI,SP70
.
          PACK      WTEEDEST,SP70
.
          READ      CONTROLF,THIRTY7;*236,WTCNBRSR
          LOAD      WTEESREF,WTCNBRSR,WMUDEF1,WMUDEF2,WMUDEF3,WMUDEF4,WMUDEF5:
                                     WMUDEF6,WMUDEF7,WMUDEF8
.
          PACK      KEY19,WMURNO,WMCODE,WMCNT,SP70
          CALL      RDWTRTD1
          IF        OVRCD<>1
            PACK      WTEEDEST,WTRTTDES,SP70
          ENDIF
          IF        WTCNUSXB=0
            UNPACK    WMSTAY,DIM2,WTEEPLOS
            MATCH     "1",WTTX23HR
            IF        @EQUAL
              MOVE      ANSA,WTEEPLOS
            ENDIF
          ELSE
            PACK      WTEEPLOS,WTTXIDYC,SP70
          ENDIF
.
          COMPARE   SIX,WMSTAT
          GOTO      WESE3000 IF NOT EQUAL
.
          PACK      KEY5,ANSW,ANSR,WMREMOVE
          CALL      RDCODE1               * Read a codes file record
          BRANCH    OVRCD,WESE3000
.
          MATCH     ANSX,TCINDC3
          GOTO      WESE2400 IF EQUAL
.
          MATCH     ANSP,TCINDC3
          GOTO      WESE2400 IF EQUAL
.
          MATCH     ANSS,TCINDC3
          GOTO      WESE2400 IF EQUAL
.
          MATCH     ANSM,TCINDC3
          GOTO      WESE2400 IF EQUAL
.
          MATCH     ANSK,TCINDC3
          IF        @EQUAL
            PACK      WTEEADAT,WMDATE3 
            GOTO      WESE2500
          ENDIF
.
          MATCH     ANSW,TCINDC3
          GOTO      WESE2500 IF EQUAL
          GOTO      WESE3000
.
WESE2400  PACK      WTEEADAT,WMDATE4 
WESE2500  PACK      WTEEINSD,WTTXCTYP
.
WESE3000  PACK      WTEEPROC,WMCODE,SP70
          PACK      WTEEPDES,WMDESC,SP70
          IF        WMSTAT=6
            PACK      WTEERREM,WMREMOVE,SP70
          ELSE
            PACK      WTEERREM,SP70
          ENDIF
          PACK      WTEERDAT,WMDATE1,SP70
          REP       " 0",WTEERDAT
          IF        WMSTAT=6
            PACK      WTEEREMD,WMDATE4,SP70
          ENDIF
          IF        WMSTAT=5
            PACK      WTEERREM,SWTERREM,SP70
          ENDIF
.
....      MATCH     SP70,WTEEADAT
....      IF        !@EQUAL
....        MOVE      WTEEADAT,WTEEREMD
....      ENDIF
          MATCH     "20050701",WMDATE1
          IF        @LESS
            PACK      WTEEARDT,WMDATE1,SP70
            REP       " 0",WTEEARDT
          ELSE
            PACK      WTEEARDT,WMKEYDT,SP70
            REP       " 0",WTEEARDT
          ENDIF
.
          PACK      WTEEPREV,SP70
          PACK      WTEEPTWT,SP70
          PACK      WTEEREFR,SP70
          MATCH     Z70,PREVID01
          IF        !@EQUAL
            PACK      WTEEPREV,PREVID01,SP70
            PACK      WTEEPTWT,PREVTT01,SP70
            PACK      WTEEREFR,WTRTREFR,SP70
          ENDIF
          PACK      WTEESSPC,WMUNIT,SP70
          PACK      WTEEWEBU,SP70
          PACK      WTEEUDAT,SP70
          PACK      WTEEUTIM,SP70
          MOVE      ZERO,WTEEMANU
          MOVE      WTWMRADT,WTEERADT
          MOVE      WTTXASAS,WTEEASAS
.
          PACK      KEY17,WTEEUNIQ,WTEEEDAT,SP70
          CALL      RAWTESE1
          IF        OVRCD=0
            PACK      WTEEWEBU,WBSEUID,SP70
            CALL      IBACLOCK
            PACK      WTEEUDAT,CCC,CYY,CMM,CDD
            REP       " 0",WTEEUDAT
            CLOCK     TIME,WTEEUTIM
            REP       " 0",WTEEUTIM
            CALL      UPWTESE1
          ELSE
            PACK      WTEEWEBC,WBSEUID,SP70
            CALL      IBACLOCK
            PACK      WTEECDAT,CCC,CYY,CMM,CDD
            REP       " 0",WTEECDAT
            CLOCK     TIME,WTEECTIM
            REP       " 0",WTEECTIM
            CALL      WRWTESE1
          ENDIF
.
WESE9999  RETURN
+
.******************************************************************************
.*                                 CHKESE00                                   *
.*                Check if any wateseaf details have changed                  *
.******************************************************************************
CHKESE00  MOVE      ZERO,EXIT
.
          MATCH     WTEEURNO,WMURNO
          GOTO      CHKESE90 IF NOT EQUAL
.
          MATCH     WTEEDEST,WTRTTDES
          GOTO      CHKESE90 IF NOT EQUAL
.
          PACK      WTTXRCLI,WTTXRCLI,SP70  
          MATCH     WTEESGID,WTTXRCLI
          GOTO      CHKESE90 IF NOT EQUAL
.
          IF        WTCNUSXB=0
            MATCH     "1",WTTX23HR
            IF        @EQUAL
              MATCH     ANSA,WTEEPLOS
              GOTO      CHKESE90 IF NOT EQUAL
              GOTO      CHKESE20
            ENDIF
            MOVE      WTEEPLOS,F3
            COMPARE   F3,WMSTAY
            GOTO      CHKESE90 IF NOT EQUAL
          ELSE
            MATCH     WTTXIDYC,WTEEPLOS
            GOTO      CHKESE90 IF NOT EQUAL
          ENDIF
.
CHKESE20  MATCH     WTEEPROC,WMCODE
          GOTO      CHKESE90 IF NOT EQUAL
.
          MATCH     WTEEPDES,WMDESC
          GOTO      CHKESE90 IF NOT EQUAL
.
          IF        WMSTAT=6
            MATCH     WTEERREM,WMREMOVE
            GOTO      CHKESE90 IF NOT EQUAL
          ENDIF
.
          IF        WMSTAT=6
            MATCH     WTEEINSD,WTTXCTYP
            GOTO      CHKESE90 IF NOT EQUAL
.
            MATCH     WTEEREMD,WMDATE4
            GOTO      CHKESE90 IF NOT EQUAL
          ENDIF
.
          MATCH     WTEERDAT,WMDATE1
          GOTO      CHKESE90 IF NOT EQUAL
.
          MATCH     WTEERADT,WTWMRADT
          GOTO      CHKESE90 IF NOT EQUAL
.
          MOVE      SP70,CODE
          READ      CONTROLF,THIRTY7;*236,WTCNBRSR
          LOAD      CODE,WTCNBRSR,WMUDEF1,WMUDEF2,WMUDEF3,WMUDEF4,WMUDEF5:
                                     WMUDEF6,WMUDEF7,WMUDEF8
          MATCH     WTEESREF,CODE
          GOTO      CHKESE90 IF NOT EQUAL
.
          MATCH     WTEESSPC,WMUNIT
          GOTO      CHKESE90 IF NOT EQUAL
.
          MATCH     Z70,PREVID01
          IF        !@EQUAL
            MATCH     WTEEPREV,PREVID01
            GOTO      CHKESE90 IF NOT EQUAL
          ENDIF
.   
          MATCH     Z70,PREVTT01
          IF        !@EQUAL
            MATCH     WTEEPTWT,PREVTT01
            GOTO      CHKESE90 IF NOT EQUAL
          ENDIF
.   
          PACK      WTRTREFR,WTRTREFR,SP70
          MATCH     WTEEREFR,WTRTREFR
          GOTO      CHKESE90 IF NOT EQUAL
.
          MATCH     WTTXASAS,WTEEASAS
          GOTO      CHKESE90 IF NOT EQUAL
.
          MOVE      ONE,EXIT                 * No Changes
          GOTO      CHKESE99
.
CHKESE90  GOTO      CHKESE99
.
CHKESE99  RETURN
.
.******************************************************************************
.*                                 WURG0000                                   *
.*         Write/update urgency watesiaf (intra episode details)              *
.******************************************************************************
WURG0000  COMPARE   THREE,PTCNHDPS
          GOTO      WURG9999 IF NOT EQUAL   * Not in Victoria
.
          PACK      WTENUNIQ,WTWMECNT,SP70
          PACK      WTENEDAT,SP70
          PACK      WTENETYP,ANSU
          PACK      WTENSADI,SP70
          PACK      WTENEVDT,WTCAEDAT,SP70
          PACK      WTENEVAL,WTCACODT,SP70
          PACK      WTENWEBC,WBSEUID,SP70
          CALL      IBACLOCK
          PACK      WTENCDAT,CCC,CYY,CMM,CDD
          REP       " 0",WTENCDAT
          CLOCK     TIME,WTENCTIM
          REP       " 0",WTENCTIM
          PACK      WTENWEBU,SP70
          PACK      WTENUDAT,SP70
          PACK      WTENUTIM,SP70
          MOVE      ZERO,WTENMANU
.
          PACK      KEY36,WTENUNIQ,WTENETYP,WTENEVDT,WTENEDAT,SP70
          CALL      RAWTESN1
          IF        OVRCD=1
            CALL      WRWTESN1
          ELSE
            PACK      WTENWEBU,WBSEUID
            PACK      WTENUDAT,CCC,CYY,CMM,CDD
            REP       " 0",WTENUDAT
            CLOCK     TIME,WTENUTIM
            REP       " 0",WTENUTIM
            CALL      UPWTESN1
          ENDIF
.
WURG9999  RETURN
.
.******************************************************************************
.*                                 ADRED000                                   *
.*         Write readiness watesiaf (intra episode details)                   *
.******************************************************************************
ADRED000  COMPARE   THREE,PTCNHDPS
          GOTO      ADRED999 IF NOT EQUAL   * Not in Victoria
.
          MOVE      WTTXPLST,WTENEVAL
          PACK      WTENEVDT,WMDATE1,SP70
.
          CALL      WRRED000
.
ADRED999  RETURN
.
CLRCLM00  MOVE      SP70,WCENAME
          MOVE      SP70,WCEADD1
          MOVE      SP70,WCEADD2
          MOVE      SP70,WCEADD3
          MOVE      SP70,WCEADD4
          MOVE      SP70,WCEPOST
          MOVE      SP70,WCETELE
          MOVE      SP70,WCACDAT
          MOVE      SP70,WCACCPT
          MOVE      SP70,WCICODE
          MOVE      SP70,WCCLMNO
.
          CALL      CLPMSWX1
.
          RETURN
.
.******************************************************************************
.*                                 DELP0000                                   *
.*         Delete watespaf record if required                                 *
.******************************************************************************
DELP0000  READ      CONTROLF,EIGHTY;*250,PTCNHDPS
.
          COMPARE   THREE,PTCNHDPS
          GOTO      DELP9999 IF NOT EQUAL   * Not in Victoria
.
          PACK      KEY19,OURNO,SP70
          CALL      RDSTREA1
          CALL      RDKTREA1
          BRANCH    OVRCD,DELP1000
.
          MATCH     WMURNO,OURNO
          GOTO      DELP9999 IF EQUAL
.
DELP1000  PACK      KEY16,OURNO,SP70
          CALL      RSWTESP1
          CALL      RKWTESP1
          BRANCH    OVRCD,DELP9999
.
          MATCH     OURNO,WTEPURNO
          GOTO      DELP9999 IF NOT EQUAL
.
          MATCH     SP70,WTEPEDAT
          IF        @EQUAL
            CALL      DEWTESP1
            GOTO      DELP1000
          ENDIF
.
          PACK      WTEPURNO,OURNO,SP70
          PACK      WTEPEDAT,SP70
          PACK      WTEPPDOB,SP70
          PACK      WTEPEDOB,SP70
          PACK      WTEPPSEX,SP70
          PACK      WTEPMEDI,DELETERC,SP70
          PACK      WTEPMREF,SP70
          PACK      WTEPRESI,SP70
          PACK      WTEPPOST,SP70
          PACK      WTEPSUBR,SP70
          PACK      WTEPABRG,SP70
          PACK      WTEPWEBC,WBSEUID,SP70
          PACK      WTEPCDAT,CCC,CYY,CMM,CDD,SP70
          REP       " 0",WTEPCDAT
          PACK      WTEPCTIM,CTIMEIS,SP70
          REP       " 0",WTEPCTIM
          PACK      WTEPWEBU,WBSEUID,SP70
          PACK      WTEPUDAT,CCC,CYY,CMM,CDD,SP70
          REP       " 0",WTEPUDAT
          PACK      WTEPUTIM,CTIMEIS,SP70
          REP       " 0",WTEPUTIM
          PACK      WTEPPGEN,SP70
          CALL      WRWTESP1
.
DELP9999  RETURN
+
.******************************************************************************
.*                                 GESIS000                                   *
.*                Get ESIS wateseaf (episode details)                         *
.******************************************************************************
GESIS000  READ      CONTROLF,EIGHTY;*250,PTCNHDPS
          MOVE      SP70,WTEEPREV
          MOVE      SP70,WTEEPTWT
.
          COMPARE   THREE,PTCNHDPS
          GOTO      GESIS999 IF NOT EQUAL   * Not in Victoria
.
          PACK      KEY17,WTWMECNT,SP70
          CALL      RDWTESE1
          BRANCH    OVRCD,GESIS100
.
          GOTO      GESIS999
.
GESIS100  PACK      KEY17,WTWMECNT,Z70
          CALL      RSWTESE1
          CALL      RPWTESE1
          BRANCH    OVRCD,GESIS900
.
          MATCH     WTEEUNIQ,WTWMECNT
          GOTO      GESIS999 IF EQUAL
.
GESIS900  MOVE      SP70,WTEEPREV
          MOVE      SP70,WTEEPTWT
.
GESIS999  RETURN
+
.------------------------------------------------------------
. Medical Booking Select List
.------------------------------------------------------------
BOKSEL00  MOVE      SP70,TDESC
          PACK      CATEGORY,ANSB,ANSK,SP70
          PACK      KEY5,CATEGORY,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      CATEGORY,TCODE
            MOVE      "Invalid Category",TDESC
          ENDIF
          REP       " _",TCODE
          REP       " _",THCSCOD
          WRITE     HTMLFILE;"<!--<cat-c category=#"",TCODE,"#" name=#"",TDESC:
                             "#" map=#"",THCSCOD,"#"></cat-c>-->"
.
          PACK      PTCDKEY2,CATEGORY,SP70
          CALL      RDSCODE2
BOKSEL10  CALL      RDKCODE2
          BRANCH    OVRCD,BOKSEL99
          MATCH     CATEGORY,TCODE
          GOTO      BOKSEL99 IF NOT EQUAL
          MATCH     SP70,ACODE
          GOTO      BOKSEL10 IF EQUAL
.
          MATCH     "THE",THCSCOD         * dont output theatre booking type
          GOTO      BOKSEL10 IF EQUAL
.
          MATCH     "UNS",THCSCOD         * dont output UNS booking type
          GOTO      BOKSEL10 IF EQUAL
.
          PACK      KEY25,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5:
                          TCINDC6,TCINDC7,TCINDC8,TCINDC9,TCINDC10:
                          TCINDC11,THCSCOD,PTCDNHCP,TCFORM6
          PACK      KEY30,QUOTE,ACODE,KEY25,QUOTE
          MATCH     CODE,ACODE
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY30," selected>":
                               TDESC,"</option>"
          ELSE
            MATCH     "I",PTCOACTV
            GOTO      BOKSEL10 IF EQUAL
            WRITE     HTMLFILE;"<option value=",KEY30,">",TDESC,"</option>"
          ENDIF
          GOTO      BOKSEL10
BOKSEL99  RETURN
.
.------------------------------------------------------------
. Update watesnaf urgency and readiness if the date on list
. is been changed via the supervisor function.
. If records have not been sent update the event date. If they
. have been sent write a delete record and add new records.
.------------------------------------------------------------
UESN0000  READ      CONTROLF,EIGHTY;*250,PTCNHDPS
.
          COMPARE   THREE,PTCNHDPS
          GOTO      UESN9999 IF NOT EQUAL    * Not in Victoria
.
          MATCH     SAVDATEL,WMDATE1         * Date on list has not changed
          GOTO      UESN9999 IF EQUAL
.
. Urgency Record
.
          PACK      KEY36,WTWMECNT,ANSU,SAVDATEL,SP70
          CALL      RDWTESN1
          COMPARE   ZERO,OVRCD                   * Direct read if not sent
          GOTO      UESN1100 IF EQUAL
.
          CALL      RSWTESN1
UESN1000  CALL      RKWTESN1
          BRANCH    OVRCD,UESN5000
.
          MATCH     WTWMECNT,WTENUNIQ            * Unique number
          GOTO      UESN5000 IF NOT EQUAL
.
          MATCH     ANSU,WTENETYP                * Urgency
          GOTO      UESN5000 IF NOT EQUAL
.
          MATCH     SAVDATEL,WTENEVDT            * Date on list
          GOTO      UESN5000 IF NOT EQUAL
.
UESN1100  PACK      SAVKEY36,WTENUNIQ,WTENETYP,WTENEVDT,WTENEDAT,WTENSADI,SP70
.
          MATCH     SP70,WTENEDAT                * Extract sent date 
          GOTO      UESN3000 IF NOT EQUAL
.
          PACK      KEY36,WTENUNIQ,WTENETYP,WMDATE1,WTENEDAT,WTENSADI,SP70
          CALL      RAWTESN1
          COMPARE   ZERO,OVRCD              * Check new event date
          GOTO      UESN5000 IF EQUAL
.
          MOVE      SAVKEY36,KEY36
          CALL      RDWTESN1                * Re position on record to update
          BRANCH    OVRCD,UESN5000
.
          MOVE      WMDATE1,WTENEVDT        * Update event date
.
          PACK      KEY36,WTENUNIQ,WTENETYP,WTENEVDT,WTENEDAT,WTENSADI,SP70
          PACK      WTENWEBU,WBSEUID
          PACK      WTENUDAT,CCC,CYY,CMM,CDD
          REP       " 0",WTENUDAT
          CLOCK     TIME,WTENUTIM
          REP       " 0",WTENUTIM
          CALL      UPWTESN1
.
          GOTO      UESN5000
.
UESN3000  MOVE      SP70,WTENEDAT
          MOVE      DELETERC,WTENEVAL
.
          PACK      KEY36,WTENUNIQ,WTENETYP,WTENEVDT,WTENEDAT,WTENSADI,SP70
          CALL      RAWTESN1
          IF        OVRCD=1
            CALL      WRWTESN1              * Write urgency delete record
          ENDIF
.
          MOVE      SAVKEY36,KEY36
          CALL      RDWTESN1                * Re position on original record
          BRANCH    OVRCD,UESN5000
.
          MOVE      SP70,WTENEDAT
          MOVE      WMDATE1,WTENEVDT        * New urgency date
.
          PACK      KEY36,WTENUNIQ,WTENETYP,WTENEVDT,WTENEDAT,WTENSADI,SP70
          CALL      RAWTESN1
          IF        OVRCD=1
            CALL      WRWTESN1              * Write new urgency record
          ENDIF
.
. Readiness Record
.
UESN5000  PACK      KEY36,WTWMECNT,ANSR,SAVDATEL,SP70
          CALL      RDWTESN1
          COMPARE   ZERO,OVRCD                   * Direct read if not sent
          GOTO      UESN6100 IF EQUAL
.
          CALL      RSWTESN1
UESN6000  CALL      RKWTESN1
          BRANCH    OVRCD,UESN9999
.
          MATCH     WTWMECNT,WTENUNIQ            * Unique number
          GOTO      UESN9999 IF NOT EQUAL
.
          MATCH     ANSR,WTENETYP                * Readiness
          GOTO      UESN9999 IF NOT EQUAL
.
          MATCH     SAVDATEL,WTENEVDT            * Date on list
          GOTO      UESN9999 IF NOT EQUAL
.
UESN6100  PACK      SAVKEY36,WTENUNIQ,WTENETYP,WTENEVDT,WTENEDAT,WTENSADI,SP70
.
          MATCH     SP70,WTENEDAT                * Extract sent date
          GOTO      UESN8000 IF NOT EQUAL
.
          PACK      KEY36,WTENUNIQ,WTENETYP,WMDATE1,WTENEDAT,WTENSADI,SP70
          CALL      RAWTESN1
          COMPARE   ZERO,OVRCD              * Check new event date
          GOTO      UESN9999 IF EQUAL
.
          MOVE      SAVKEY36,KEY36
          CALL      RDWTESN1                * Re position on record to update
          BRANCH    OVRCD,UESN9999
.
          MOVE      WMDATE1,WTENEVDT        * Update event date
.
          PACK      KEY36,WTENUNIQ,WTENETYP,WTENEVDT,WTENEDAT,WTENSADI,SP70
          PACK      WTENWEBU,WBSEUID
          PACK      WTENUDAT,CCC,CYY,CMM,CDD
          REP       " 0",WTENUDAT
          CLOCK     TIME,WTENUTIM
          REP       " 0",WTENUTIM
          CALL      UPWTESN1
.
          GOTO      UESN9999
.
UESN8000  MOVE      SP70,WTENEDAT
          MOVE      DELETERC,WTENEVAL
.
          PACK      KEY36,WTENUNIQ,WTENETYP,WTENEVDT,WTENEDAT,WTENSADI,SP70
          CALL      RAWTESN1
          IF        OVRCD=1
            CALL      WRWTESN1              * Write readiness delete record
          ENDIF
.
          MOVE      SAVKEY36,KEY36
          CALL      RDWTESN1                * Re position on original record
          BRANCH    OVRCD,UESN9999
.
          MOVE      SP70,WTENEDAT
          MOVE      WMDATE1,WTENEVDT        * New readiness date
.
          PACK      KEY36,WTENUNIQ,WTENETYP,WTENEVDT,WTENEDAT,WTENSADI,SP70
          CALL      RAWTESN1
          IF        OVRCD=1
            CALL      WRWTESN1              * Write new readiness record
          ENDIF
.
UESN9999  RETURN
+
.------------------------------------------------------------
. Update confirmation dates
.------------------------------------------------------------
CONREC00  MOVE      ZERO,WLKEYCNT
.
          PACK      TODAY,CCC,CYY,CMM,CDD
          REP       " 0",TODAY
          CLOCK     TIME,CTIMEIS
.
CONREC10  ADD       ONE,WLKEYCNT
          IF        WLKEYCNT>WLKEYEND
            GOTO       CONREC99
          ENDIF
.
          MATCH     SP70,CONFARRY[WLKEYCNT]  * = corresponding UR
          GOTO      CONREC10 IF EQUAL
.
          UNPACK    CONFARRY[WLKEYCNT],KEY8
          CALL      RDBKRX11
          BRANCH    OVRCD,CONREC10
.
          PACK      BKRXCNDT,TODAY,SP70
          REP       " 0",BKRXCNDT
          PACK      BKRXCNTM,CTIMEIS,SP70
          REP       " 0",BKRXCNTM
          CALL      UPBKRX11
.
          GOTO      CONREC10
.
CONREC99  RETURN
+
.******************************************************************************
.*                                 GETSET00                                   *
.*     Write delete for watesnaf if cancelling without informing the patient  *
.******************************************************************************
GETSET00  PACK      KEY36,WTWMECNT,ANSS,DBKREBOO,SP70
          CALL      RSWTESN5
          CALL      RKWTESN5
          BRANCH    OVRCD,GETSET99
.
          MATCH     WTENUNIQ,WTWMECNT
          GOTO      GETSET99 IF NOT EQUAL
.
          MATCH     ANSS,WTENETYP
          GOTO      GETSET99 IF NOT EQUAL
.
          MATCH     DBKREBOO,WTENSADI
          GOTO      GETSET99 IF NOT EQUAL
.
          MATCH     SP70,WTENEDAT
          IF        @EQUAL
            PACK      KEY36,WTENUNIQ,WTENETYP,WTENSADI,WTENEVDT,WTENEDAT,SP70
            CALL      DEWTESN5
            GOTO      GETSET99
          ENDIF
.
          MOVE      DELETERC,WTENEVAL
          MOVE      SP70,WTENEDAT
          PACK      WTENWEBC,USERID
          CALL      IBACLOCK
          PACK      WTENCDAT,CCC,CYY,CMM,CDD
          REP       " 0",WTENCDAT
          CLOCK     TIME,WTENCTIM
          REP       " 0",WTENCTIM
          PACK      WTENWEBU,SP70
          PACK      WTENUDAT,SP70
          PACK      WTENUTIM,SP70
          MOVE      ZERO,WTENMANU
.
          PACK      KEY36,WTENUNIQ,WTENETYP,WTENEVDT,WTENEDAT,WTENSADI,SP70
          CALL      RAWTESN1
          IF        OVRCD=1
            CALL      WRWTESN1
          ENDIF
.
GETSET99  RETURN
+
.------------------------------------------------------------
. Check for Admissions
.------------------------------------------------------------
CHKVIS00  MOVE      ZERO,VISFOUND
          MOVE      ZERO,NODAYS
          MOVE      ZEROVISN,CURRADMN
          CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
.
. --- check for preadmissions
.
          PACK      KEY17,URNUMBER,ONE,Z70
          CALL      RSPTMI18
CHKVIS10  CALL      RPPTMI18
          BRANCH    OVRCD,CHKVIS15
.
          MATCH     URNUMBER,AURNO
          GOTO      CHKVIS15 IF NOT EQUAL
.
          COMPARE   ONE,ASTAT
          GOTO      CHKVIS15 IF NOT EQUAL
.
....      MATCH     ADATE,CURRDATE
....      GOTO      CHKVIS10 IF LESS
.
....      DAYSEP    ADATE,CURRDATE,NODAYS
....      COMPARE   NODAYS,SEVEN
....      GOTO      CHKVIS10 IF LESS
.
          MOVE      DAADMNO,CURRADMN
          ADD       ONE,VISFOUND
          COMPARE   TWO,VISFOUND
          GOTO      CHKVIS99 IF EQUAL
          GOTO      CHKVIS10
.
. --- check for current admissions before session date ---
.
CHKVIS15  PACK      KEY17,URNUMBER,TWO,SP70
          CALL      RSPTMI18
          CALL      RKPTMI18
          BRANCH    OVRCD,CHKVIS20
.
          MATCH     URNUMBER,AURNO
          GOTO      CHKVIS20 IF NOT EQUAL
.
          COMPARE   TWO,ASTAT
          GOTO      CHKVIS20 IF NOT EQUAL
.
          MOVE      DAADMNO,CURRADMN
          ADD       ONE,VISFOUND
          COMPARE   TWO,VISFOUND
          GOTO      CHKVIS99 IF EQUAL
.
. --- check for on leave admissions before session date ---
.
CHKVIS20  PACK      KEY17,URNUMBER,FOUR,SP70
          CALL      RSPTMI18
          CALL      RKPTMI18
          BRANCH    OVRCD,CHKVIS25
.
          MATCH     URNUMBER,AURNO
          GOTO      CHKVIS25 IF NOT EQUAL
.
          COMPARE   FOUR,ASTAT
          GOTO      CHKVIS25 IF NOT EQUAL
.
          MOVE      DAADMNO,CURRADMN
          ADD       ONE,VISFOUND
          COMPARE   TWO,VISFOUND
          GOTO      CHKVIS99 IF EQUAL
.
. --- check for discharged admissions within session date ---
.
CHKVIS25  PACK      KEY17,URNUMBER,THREE,Z70
          CALL      RSPTMI18
CHKVIS30  CALL      RPPTMI18
          BRANCH    OVRCD,CHKVIS99
.
          MATCH     URNUMBER,AURNO
          GOTO      CHKVIS99 IF NOT EQUAL
.
          COMPARE   THREE,ASTAT
          GOTO      CHKVIS99 IF NOT EQUAL
.
          MATCH     ADATE,CURRDATE
          GOTO      CHKVIS30 IF LESS
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDDSCH1
          BRANCH    OVRCD,CHKVIS30
.
          MATCH     CURRDATE,DDATE
          GOTO      CHKVIS99 IF LESS
          GOTO      CHKVIS99 IF EQUAL
.
          MOVE      DAADMNO,CURRADMN
          ADD       ONE,VISFOUND
          COMPARE   TWO,VISFOUND
          GOTO      CHKVIS99 IF EQUAL
.
CHKVIS99  WRITE     HTMLFILE;VISFOUND;
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          RETURN
+
.------------------------------------------------------------
.   Confirm booking details
.------------------------------------------------------------
CNFBOK00  RESET     UPDTTYPE
          CALL      CLWATDET
          CALL      CLWTX000
          CALL      CLBOKREC
          CALL      CLWATHIS
.
          MATCH     SP70,CASEKEYS
          IF        !@EQUAL
            MOVE      CASEKEYS,KEY19
            CALL      RDTREA1
            IF        OVRCD=0
              MOVE      WMURNO,URNUMBER
              MOVE      WMBOOK,ADMISSNO
            ENDIF
          ENDIF
.
          MOVE      CASEKEYS,KEY19
          CALL      RDWTTX11
          IF        OVRCD=1
            CALL      CLWTX000
          ENDIF
.
          MOVE      WMBOOK,KEY8
          CALL      RDBKREC1
          IF        OVRCD = 1
            CALL      CLBOKREC
            CALL      CLBKRX00
          ELSE
            MOVE      WMBOOK,KEY8
            CALL      RDBKRX11
          ENDIF
.
          MOVE      URNUMBER,KEY8           * visit number
          CALL      RDMAST1
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MATCH     SP1,UPDTTYPE
          GOTO      CNFBOK40 IF EQUAL
.         
          MATCH     "U",UPDTTYPE    * Update formaction
          GOTO      CNFBOK20 IF EQUAL
.         
          MATCH     "D",UPDTTYPE    * Delete formaction
          GOTO      CNFBOK30 IF EQUAL
.         
          GOTO      CNFBOK93
.
.         ************ UPDATE FORMACTION **********
.
CNFBOK20  PACK      KEY8,BKCNF001,SP70
          CALL      RDBKCNF1
          IF        OVRCD=1
            CALL      MVBOKCNF         * Moves input variables to file variables
            PACK      KEY8,BKCNF001,SP70
            MOVE      WBSEUID,BKCFWEBC
            CALL      IBACLOCK
            PACK      BKCFCDAT,CCC,CYY,CMM,CDD  * set created date
            REP       " 0",BKCFCDAT
            PACK      BKCFCTIM,CTIMEIS          * set created time
            CALL      WRBKCNF1         * Writes away the data
            CALL      UPVCM000
            MOVE      ZERO,EXIT
            GOTO      CNFBOK99
          ENDIF
.
          CALL      MVBOKCNF      * Moves input variables to file variables
          MOVE      WBSEUID,BKCFWEBU
          CALL      IBACLOCK
          PACK      BKCFUDAT,CCC,CYY,CMM,CDD  * set created date
          REP       " 0",BKCFUDAT
          PACK      BKCFUTIM,CTIMEIS          * set created time
          CALL      UPBKCNF1      * Writes away the data
          CALL      UPVCM000
.
          MOVE      ZERO,EXIT
          GOTO      CNFBOK99
.
.         ************ DELETE FORMACTION **********
.
CNFBOK30  PACK      KEY8,BKCNF001,SP70
          CALL      RDBKCNF1
          BRANCH    OVRCD,CNFBOK91
.
          CALL      DEBKCNF1
.
          MOVE      ZERO,EXIT
          GOTO      CNFBOK99
.
.         ************ DISPLAY FORMACTION **********
.
CNFBOK40  MATCH     Z70,BKCNF001
          IF        !@EQUAL 
            PACK      KEY8,BKCNF001,SP70
          ELSE
            PACK      KEY8,WMBOOK,SP70
          ENDIF
          CALL      RDBKCNF1
          IF        OVRCD=1
            CALL      CLBOKCNF    * Clear all the file variables
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Booking Confirmation Maintenance",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,CNFBOK99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      CNFBOK99
.
CNFBOK91  MOVE      "Confirmation record does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CNFBOK99
.
CNFBOK93  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CNFBOK99
.
CNFBOK99  CLOSE     VSCTTFIL,DELETE    * Delete temp file created by CLRVCM00
          RETURN
+
.------------------------------------------------------------------------
.  Check for GP Access on websecaf
.------------------------------------------------------------------------
CHGP0000 MOVE       ZERO,EXIT
         MOVE       SP70,GPCODE
.
         MATCH      WBSEGPAC,SP70           * all access
         IF         @EQUAL
           PACK       GPCODE,PMPXRHC1,SP70
         ENDIF
.
         MATCH      "1",WBSEGPAC           * using registered gp
         IF         @EQUAL
           PACK       GPCODE,PMPXRHC1,SP70
         ENDIF
.
         MATCH      "2",WBSEGPAC           * using verified gp
         IF         @EQUAL
           PACK       GPCODE,PMPXVGPC,SP70
         ENDIF
.
         MATCH      GPCODE,WBSEGPCD
         GOTO       CHGP9999 IF EQUAL
.
         MATCH      WBSEGPAC,SP70           * all access
         IF         @EQUAL
           PACK       GPCODE,PMPXVGPC,SP70
         ENDIF
.
         MATCH      GPCODE,WBSEGPCD
         GOTO       CHGP9999 IF EQUAL
.
CHGP9000 MOVE       ONE,EXIT
.
CHGP9999 RETURN
+
.-------------------------------------------------------------------------------
. Data integrity audit list
.-------------------------------------------------------------------------------
DITB0000  PACK      KEY35,CASEKEYS,SP70
          CALL      RSWTCHA1
DITB1000  CALL      RKWTCHA1
          BRANCH    OVRCD,DITB9999
.
          PACK      KEY19,WTCHURNO,WTCHPROC,WTCHPCNT,SP70
          MATCH     KEY19,CASEKEYS
          GOTO      DITB9999 IF NOT EQUAL
.
          PACK      HTMLLINK,SP70,SP70,SP70
.
          PACK      KEY10,WTCHUSID,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      WTCHUSID,WBSENAM
          ENDIF
.
          MOVE      SP70,TDESC
          MOVE      SP70,UPTYDESC
          MOVE      ZERO,F2
          MOVE      WTCHUPTY,F2
          LOAD      UPTYDESC,F2,WTCHUP01,WTCHUP02,WTCHUP03,WTCHUP04,WTCHUP05:
                                WTCHUP06,WTCHUP07,WTCHUP08,WTCHUP09,WTCHUP10:
                                WTCHUP11,WTCHUP12,WTCHUP13,WTCHUP14,WTCHUP15:
                                WTCHUP16,WTCHUP17,WTCHUP18,WTCHUP19,WTCHUP20:
                                WTCHUP21,WTCHUP22,WTCHUP23,WTCHUP24,WTCHUP25:
                                WTCHUP26,WTCHUP27,WTCHUP28,WTCHUP29,WTCHUP30:
                                WTCHUP31
.
          IF        F2=2 | F2=9 | F2=8
            PACK      KEY5,ANSW,ANSD,WTCHREAS,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      WTCHREAS,TDESC
            ENDIF
            GOTO      DITB2000
          ENDIF
.
          IF        F2=5
            PACK      KEY5,ANSW,ANSR,WTCHREAS,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      WTCHREAS,TDESC
            ENDIF
            GOTO      DITB2000
          ENDIF
.
          IF        F2=10 | F2=11
            PACK      KEY5,ANSW,ANSN,WTCHREAS,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      WTCHREAS,TDESC
            ENDIF
            GOTO      DITB2000
          ENDIF
.
          IF          F2=12
            MATCH     SP70,WTCHREAS
            GOTO      DITB2000 IF EQUAL
.
            PACK      KEY5,ANSP,ANSC,WTCHREAS,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      WTCHREAS,TDESC
            ENDIF
            GOTO      DITB2000
          ENDIF
.
          IF          F2=13
            MATCH     SP70,WTCHREAS
            GOTO      DITB2000 IF EQUAL
.
            PACK      KEY5,ANSF,ANSX,WTCHREAS,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      WTCHREAS,TDESC
            ENDIF
            GOTO      DITB2000
          ENDIF
.
          IF          F2=16
            MATCH     SP70,WTCHREAS
            GOTO      DITB2000 IF EQUAL
.
            PACK      KEY5,ANSB,ANSC,WTCHREAS,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      WTCHREAS,TDESC
            ENDIF
            GOTO      DITB2000
          ENDIF
.
          IF          F2=17
            MATCH     SP70,WTCHREAS
            GOTO      DITB2000 IF EQUAL
.
            PACK      KEY5,ANSW,ANSQ,WTCHREAS,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      WTCHREAS,TDESC
            ENDIF
            GOTO      DITB2000
          ENDIF
.
          MATCH     SP70,WTCHREAS
          GOTO      DITB2000 IF EQUAL
.
          PACK      KEY5,ANSF,ANSX,WTCHREAS,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      WTCHREAS,TDESC
          ENDIF
.
DITB2000  MOVE      TDESC,DISPREAS
.
          PACK      DISPOVAL,SP70,SP70
          PACK      DISPCVAL,SP70,SP70
.
          IF        F2=26
            MOVE      "Changed U/R",UPTYDESC
            PACK      DISPOVAL,WTCHOVAL,SP70
            PACK      DISPCVAL,WTCHCVAL,SP70
            MOVE      SP70,DISPREAS
          ENDIF
. 
          IF        F2=2
            PACK      KEY5,ANST,ANSP,WTCHOVAL,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      WTCHOVAL,TDESC
            ENDIF
            PACK      DISPOVAL,TDESC,SP70,SP70
.
            PACK      KEY5,ANST,ANSP,WTCHCVAL,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      WTCHCVAL,TDESC
            ENDIF
            PACK      DISPCVAL,TDESC,SP70,SP70
          ENDIF
.
          IF        F2=4
            PACK      KEY5,ANSV,ANSL,WTCHOVAL,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      WTCHOVAL,TDESC
            ENDIF
            PACK      DISPOVAL,TDESC,SP70,SP70
          ENDIF
.
          IF        F2=5
            UNPACK    WTCHCVAL,CCENT,CYEAR,CMON,CDAY,WTCHCVAL
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPCVAL,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                      SP1,WTCHCVAL,SP70
            GOTO      DITB8000
          ENDIF
.
          IF        F2=6
            PACK      KEY5,ANSS,ANSC,WTCHOVAL,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      WTCHOVAL,TDESC
            ENDIF
            PACK      DISPOVAL,TDESC,SP70,SP70
.
            PACK      KEY5,ANSS,ANSC,WTCHCVAL,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      WTCHCVAL,TDESC
            ENDIF
            PACK      DISPCVAL,TDESC,SP70,SP70
          ENDIF
.
          IF        F2=7
            MOVE      SP70,KEY3
            MOVE      SP70,TDESC
            UNPACK    WTCHOVAL,CCENT,CYEAR,CMON,CDAY,KEY3,WTCHOVAL
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
            MATCH     SP70,KEY3
            IF        !@EQUAL
              PACK      KEY5,ANSW,ANSR,KEY3,SP70
              CALL      RDCODE1
              IF        OVRCD=1
                MOVE      KEY3,TDESC
              ENDIF
            ENDIF
.
            PACK      DISPOVAL,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP1,TDESC,SP70
.           
            MOVE      SP70,KEY3
            MOVE      SP70,TDESC
            UNPACK    WTCHCVAL,CCENT,CYEAR,CMON,CDAY,KEY3,WTCHCVAL
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
            MATCH     SP70,KEY3
            IF        !@EQUAL
              PACK      KEY5,ANSW,ANSR,KEY3,SP70
              CALL      RDCODE1
              IF        OVRCD=1
                MOVE      KEY3,TDESC
              ENDIF
            ENDIF
            PACK      DISPCVAL,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP1,TDESC,SP70
            GOTO      DITB8000
          ENDIF
.
          IF        F2=1 | F2=3
            UNPACK    WTCHOVAL,CCENT,CYEAR,CMON,CDAY,WTCHOVAL
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPOVAL,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                      SP1,WTCHOVAL,SP70
.
            MATCH     SP70,WTCHCVAL
            IF        @EQUAL
              PACK      DISPCVAL,SP70,SP70
            ELSE
              UNPACK    WTCHCVAL,CCENT,CYEAR,CMON,CDAY,WTCHCVAL
              MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
              PACK      DISPCVAL,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                        SP1,WTCHCVAL,SP70
            ENDIF

            GOTO      DITB8000
          ENDIF
.
          IF        F2=8
            UNPACK    WTCHOVAL,CCENT,CYEAR,CMON,CDAY,WTCHOVAL
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPOVAL,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                      SP1,WTCHOVAL,SP70
.
            UNPACK    WTCHCVAL,CCENT,CYEAR,CMON,CDAY,WTCHCVAL
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPCVAL,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                      SP1,WTCHCVAL,SP70
            GOTO      DITB8000
          ENDIF
.
          IF        F2=9
            MOVE      ZERO,F1
            SQUEEZE   WTCHOVAL
            MOVE      WTCHOVAL,F1
            RESET     WTCHOVAL
            LOAD      DISPOVAL,F1,WAITST01,WAITST02,WAITST03,WAITST04,WAITST05:
                               WAITST06,WAITST07,WAITST08,WAITST09
.
            MOVE      ZERO,F1
            SQUEEZE   WTCHCVAL
            MOVE      WTCHCVAL,F1
            RESET     WTCHCVAL
            LOAD      DISPCVAL,F1,WAITST01,WAITST02,WAITST03,WAITST04,WAITST05:
                               WAITST06,WAITST07,WAITST08,WAITST09
          ENDIF
.
          IF        F2=10 | F2=11 | F2=14
            MOVE      SP70,KEY3
            MOVE      SP70,TDESC
            MOVE      SP70,DIM8
            MOVE      SP70,DIM8A
            MOVE      SP70,DISPDAT1
            MOVE      SP70,DISPDAT2

            UNPACK    WTCHOVAL,DIM8,DIM8A,KEY3,WTCHOVAL
.
            MATCH     SP70,DIM8
            IF        !@EQUAL
              UNPACK    DIM8,CCENT,CYEAR,CMON,CDAY,WTCHOVAL
              MOVE      CMON,F2
              LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP:
                                   OCT,NOV,DEC
              PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP70
            ENDIF
.
            MATCH     SP70,DIM8A
            IF        !@EQUAL
              UNPACK    DIM8A,CCENT,CYEAR,CMON,CDAY,WTCHOVAL
              MOVE      CMON,F2
              LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP:
                                   OCT,NOV,DEC
              PACK      DISPDAT2,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP70
            ENDIF
.
            MATCH     SP70,KEY3
            IF        !@EQUAL
              PACK      KEY5,ANSV,ANSL,KEY3,SP70
              CALL      RDCODE1
              IF        OVRCD=1
                MOVE      KEY3,TDESC
              ENDIF
            ENDIF
.
            PACK      DISPOVAL,DISPDAT1,SP1,DISPDAT2,SP1,TDESC,SP70
.
            MOVE      SP70,KEY3
            MOVE      SP70,TDESC
            MOVE      SP70,DIM8
            MOVE      SP70,DIM8A
            MOVE      SP70,DISPDAT1
            MOVE      SP70,DISPDAT2
.
            UNPACK    WTCHCVAL,DIM8,DIM8A,KEY3,WTCHCVAL
.
            MATCH     SP70,DIM8
            IF        !@EQUAL
              UNPACK    DIM8,CCENT,CYEAR,CMON,CDAY,WTCHCVAL
              MOVE      CMON,F2
              LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP:
                                   OCT,NOV,DEC
              PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP70
            ENDIF
.
            MATCH     SP70,DIM8A
            IF        !@EQUAL
              UNPACK    DIM8A,CCENT,CYEAR,CMON,CDAY,WTCHCVAL
              MOVE      CMON,F2
              LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP:
                                   OCT,NOV,DEC
              PACK      DISPDAT2,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP70
            ENDIF
.
            MATCH     SP70,KEY3
            IF        !@EQUAL
              PACK      KEY5,ANSV,ANSL,KEY3,SP70
              CALL      RDCODE1
              IF        OVRCD=1
                MOVE      KEY3,TDESC
              ENDIF
            ENDIF
.
            PACK      DISPCVAL,DISPDAT1,SP1,DISPDAT2,SP1,TDESC,SP70
          ENDIF
.
          IF        F2=12
            UNPACK    WTCHOVAL,CCENT,CYEAR,CMON,CDAY,WTCHOVAL
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPOVAL,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                      SP1,WTCHOVAL,SP70
            PACK      DISPCVAL,WTCHCVAL,SP70
          ENDIF
.
          IF        F2=13
            MATCH     SP70,WTCHOVAL
            IF        !@EQUAL
              UNPACK    WTCHOVAL,CCENT,CYEAR,CMON,CDAY,WTCHOVAL
              MOVE      CMON,F2
              LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT:
                                   NOV,DEC
              PACK      DISPOVAL,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                        SP1,WTCHOVAL,SP70
            ENDIF
            PACK      DISPCVAL,SP70
          ENDIF
.
          IF        F2=15
            MOVE      SP70,KEY3
            MOVE      SP70,KEY3A
            MOVE      SP70,TDESC
            MOVE      SP70,KEY20
            MOVE      SP70,DIM8
            MOVE      SP70,DIM8A
            MOVE      SP70,DISPDAT1
            MOVE      SP70,DISPDAT2

            UNPACK    WTCHOVAL,DIM8,DIM8A,KEY3,KEY3A,WTCHOVAL
.
            MATCH     SP70,DIM8
            IF        !@EQUAL
              UNPACK    DIM8,CCENT,CYEAR,CMON,CDAY,WTCHOVAL
              MOVE      CMON,F2
              LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP:
                                   OCT,NOV,DEC
              PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP70
            ENDIF
.
            MATCH     SP70,DIM8A
            IF        !@EQUAL
              UNPACK    DIM8A,CCENT,CYEAR,CMON,CDAY,WTCHOVAL
              MOVE      CMON,F2
              LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP:
                                   OCT,NOV,DEC
              PACK      DISPDAT2,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP70
            ENDIF
.
            MATCH     SP70,KEY3
            IF        !@EQUAL
              PACK      KEY5,ANSV,ANSL,KEY3,SP70
              CALL      RDCODE1
              IF        OVRCD=1
                MOVE      KEY3,TDESC
              ENDIF
              MOVE      TDESC,KEY20
            ENDIF
.
            MATCH     SP70,KEY3A
            IF        !@EQUAL
              PACK      KEY5,ANSW,ANSN,KEY3A,SP70
              CALL      RDCODE1
              IF        OVRCD=1
                MOVE      KEY3A,TDESC
              ENDIF
            ENDIF
.
            PACK      DISPOVAL,DISPDAT1,SP1,DISPDAT2,SP1,KEY20,SP1,TDESC,SP70
.
            MOVE      SP70,KEY3
            MOVE      SP70,KEY3A
            MOVE      SP70,TDESC
            MOVE      SP70,KEY20
            MOVE      SP70,DIM8
            MOVE      SP70,DIM8A
            MOVE      SP70,DISPDAT1
            MOVE      SP70,DISPDAT2
.
            UNPACK    WTCHCVAL,DIM8,DIM8A,KEY3,KEY3A,WTCHCVAL
.
            MATCH     SP70,DIM8
            IF        !@EQUAL
              UNPACK    DIM8,CCENT,CYEAR,CMON,CDAY,WTCHCVAL
              MOVE      CMON,F2
              LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP:
                                   OCT,NOV,DEC
              PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP70
            ENDIF
.
            MATCH     SP70,DIM8A
            IF        !@EQUAL
              UNPACK    DIM8A,CCENT,CYEAR,CMON,CDAY,WTCHCVAL
              MOVE      CMON,F2
              LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP:
                                   OCT,NOV,DEC
              PACK      DISPDAT2,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP70
            ENDIF
.
            MATCH     SP70,KEY3
            IF        !@EQUAL
              PACK      KEY5,ANSV,ANSL,KEY3,SP70
              CALL      RDCODE1
              IF        OVRCD=1
                MOVE      KEY3,TDESC
              ENDIF
              MOVE      TDESC,KEY20
            ENDIF
.
            MATCH     SP70,KEY3A
            IF        !@EQUAL
              PACK      KEY5,ANSW,ANSN,KEY3A,SP70
              CALL      RDCODE1
              IF        OVRCD=1
                MOVE      KEY3A,TDESC
              ENDIF
            ENDIF
.
            PACK      DISPCVAL,DISPDAT1,SP1,DISPDAT2,SP1,KEY20,SP1,TDESC,SP70
          ENDIF
.
          IF        F2=16
            UNPACK    WTCHOVAL,CCENT,CYEAR,CMON,CDAY,WTCHOVAL
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPOVAL,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                      SP1,WTCHOVAL,SP70
            PACK      DISPCVAL,WTCHCVAL,SP70
          ENDIF
.
          IF        F2=17
            PACK      KEY3,WTCHOVAL,SP70
            CALL      RDPTHSP1
            IF        OVRCD=1
              MOVE      KEY3,PTHSNAME
            ENDIF
            PACK      DISPOVAL,PTHSNAME,SP70
.
            PACK      KEY3,WTCHCVAL,SP70
            CALL      RDPTHSP1
            IF        OVRCD=1
              MOVE      KEY3,PTHSNAME
            ENDIF
            PACK      DISPCVAL,PTHSNAME,SP70
          ENDIF
.
          IF        F2=18
            PACK      DISPOVAL,WTCHOVAL,SP70     * Booking Number
            PACK      DISPCVAL,WTCHCVAL,SP70
          ENDIF
.
          IF        F2=19
            PACK      KEY6,WTCHOVAL,SP70
            CALL      RDDOCT1
            IF        OVRCD<>1
              MOVE      DGNAME,ANS
              MOVE      DTITL,FMTTITLE
              MOVE      DGNAME,FMTGNAME
              MOVE      DSNAME,FMTSNAME
              CALL      DOCNM000
              PACK      DISPOVAL,DOCFNAME,SP70
            ENDIF
.
            PACK      KEY6,WTCHCVAL,SP70
            CALL      RDDOCT1
            IF        OVRCD<>1
              MOVE      DGNAME,ANS
              MOVE      DTITL,FMTTITLE
              MOVE      DGNAME,FMTGNAME
              MOVE      DSNAME,FMTSNAME
              CALL      DOCNM000
              PACK      DISPCVAL,DOCFNAME,SP70
            ENDIF
          ENDIF
.
          IF        F2=20
            PACK      DISPOVAL,WTCHOVAL,SP70
            PACK      DISPCVAL,WTCHCVAL,SP70
          ENDIF
.
          IF        F2=21
            PACK      KEY6,WTCHOVAL,SP70
            CALL      RDWARD1
            IF        OVRCD<>1
              PACK      DISPOVAL,WBDESC,SP70
            ENDIF
.
            PACK      KEY6,WTCHCVAL,SP70
            CALL      RDWARD1
            IF        OVRCD<>1
              PACK      DISPCVAL,WBDESC,SP70
            ENDIF
          ENDIF
.
          IF        F2=22
            PACK      DISPOVAL,WTCHOVAL,SP70
            PACK      DISPCVAL,WTCHCVAL,SP70
          ENDIF
.
          IF        F2=23
            PACK      DISPOVAL,WTCHOVAL,SP70
            PACK      DISPCVAL,WTCHCVAL,SP70
          ENDIF
.
          IF        F2=24
            PACK      DISPOVAL,WTCHOVAL,SP70
            PACK      DISPCVAL,WTCHCVAL,SP70
          ENDIF
.
          IF        F2=25
            PACK      DISPOVAL,WTCHOVAL,SP70
            PACK      DISPCVAL,WTCHCVAL,SP70
          ENDIF
.
          IF        F2=26
            PACK      DISPOVAL,WTCHOVAL,SP70
            PACK      DISPCVAL,WTCHCVAL,SP70
          ENDIF
.
          IF        F2=27
            PACK      DISPOVAL,WTCHOVAL,SP70
            PACK      DISPCVAL,WTCHCVAL,SP70
          ENDIF
.
          IF        F2=28
            PACK      DISPOVAL,WTCHOVAL,SP70
            PACK      DISPCVAL,WTCHCVAL,SP70
          ENDIF
.
          IF        F2=29
            PACK      DISPOVAL,WTCHOVAL,SP70
            PACK      DISPCVAL,WTCHCVAL,SP70
          ENDIF
.
          IF        F2=30
            PACK      DISPOVAL,WTCHOVAL,SP70
            PACK      DISPCVAL,WTCHCVAL,SP70
          ENDIF
.
          IF        F2=31
            PACK      DISPOVAL,WTCHOVAL,SP70
            PACK      DISPCVAL,WTCHCVAL,SP70
          ENDIF
.
DITB8000  WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":           * 0
                             "#"",WTCHDATE,WTCHTIME,"#",":           * 1
                             "#"",WTCHDATE,"#",":                    * 2
                             "#"",WTCHTIME,"#",":                    * 3
                             "#"",WTCHUSID,"#",":                    * 4
                             "#"",WBSENAM,"#",":                     * 5
                             "#"",WTCHREAS,"#",":                    * 6
                             "#"",DISPREAS,"#",":                    * 7
                             "#"",UPTYDESC,"#",":                    * 8
                             "#"",DISPOVAL,"#",":                    * 9
                             "#"",DISPCVAL,"#");"                    * 10
.
          GOTO      DITB1000
.
DITB9999  RETURN
.
.------------------------------------------------------------
. Update Field Change Audit for date on list
.------------------------------------------------------------
WRCHA000  MATCH     Z70,UPDFLD01
          GOTO      WRCHA999 IF EQUAL
.
          MATCH     SP70,UPDFLD01
          GOTO      WRCHA999 IF EQUAL
.
          MATCH     Z70,REASFC01
          GOTO      WRCHA999 IF EQUAL
.
          MATCH     SP70,REASFC01
          GOTO      WRCHA999 IF EQUAL
.
          MATCH     OLDVAL01,WMDATE1
          GOTO      WRCHA999 IF EQUAL
.
          PACK      WTCHURNO,WMURNO,SP70
          PACK      WTCHPROC,WMCODE,SP70
          PACK      WTCHPCNT,WMCNT,SP70
.
          CALL      IBACLOCK
          PACK      WTCHDATE,CCC,CYY,CMM,CDD
          REPLACE   " 0",WTCHDATE
          CLOCK     TIME,WTCHTIME
.
          PACK      WTCHUPTY,UPDFLD01,SP70
          PACK      WTCHREAS,REASFC01,SP70
          MOVE      USERID,WTCHUSID
          PACK      WTCHOVAL,OLDVAL01
          PACK      WTCHCVAL,WMDATE1
.
          MOVE      ZERO,ADDSECND
.
WRCHA200  PACK      KEY35,WTCHURNO,WTCHPROC,WTCHPCNT,WTCHDATE,WTCHTIME,SP70
          CALL      RAWTCHA1
          IF        OVRCD=1
            CALL      WRWTCHA1
          ELSE
            IF        ADDSECND<=5
              ADD       ONE,ADDSECND
            ELSE
              GOTO      WRCHA999
            ENDIF
.
            UNPACK    WTCHTIME,HOUR,D1,MIN,D1,SEC
            PACK      XDATTIME,WTCHDATE,HOUR,MIN,SEC,SP70
            CALL      ASEC0000                     * add 1 sec to date/time
                                                   * to stop duplicate key
            UNPACK    XDATTIME,WTCHDATE,HOUR,MIN,SEC
            PACK      WTCHTIME,HOUR,COLON,MIN,COLON,SEC
            GOTO      WRCHA200
          ENDIF
.
WRCHA999  RETURN
.
.------------------------------------------------------------
. Update Field Change Audit for priority
.------------------------------------------------------------
WRCHB000  MATCH     Z70,UPDFLD02
          GOTO      WRCHB999 IF EQUAL
.
          MATCH     SP70,UPDFLD02
          GOTO      WRCHB999 IF EQUAL
.
          MATCH     Z70,REASFC02
          GOTO      WRCHB999 IF EQUAL
.
          MATCH     SP70,REASFC02
          GOTO      WRCHB999 IF EQUAL
.
          MATCH     OLDVAL02,WMPTY
          GOTO      WRCHB999 IF EQUAL
.
          PACK      WTCHURNO,WMURNO,SP70
          PACK      WTCHPROC,WMCODE,SP70
          PACK      WTCHPCNT,WMCNT,SP70
.
          CALL      IBACLOCK
          PACK      WTCHDATE,CCC,CYY,CMM,CDD
          REPLACE   " 0",WTCHDATE
          CLOCK     TIME,WTCHTIME
.
          PACK      WTCHUPTY,UPDFLD02,SP70
          PACK      WTCHREAS,REASFC02,SP70
          MOVE      USERID,WTCHUSID
          PACK      WTCHOVAL,OLDVAL02
          PACK      WTCHCVAL,WMPTY
.
          MOVE      ZERO,ADDSECND
.
WRCHB200  PACK      KEY35,WTCHURNO,WTCHPROC,WTCHPCNT,WTCHDATE,WTCHTIME,SP70
          CALL      RAWTCHA1
          IF        OVRCD=1
            CALL      WRWTCHA1
          ELSE
            IF        ADDSECND<=5
              ADD       ONE,ADDSECND
            ELSE
              GOTO      WRCHB999
            ENDIF
.           
            UNPACK    WTCHTIME,HOUR,D1,MIN,D1,SEC
            PACK      XDATTIME,WTCHDATE,HOUR,MIN,SEC,SP70
            CALL      ASEC0000                     * add 1 sec to date/time
                                                   * to stop duplicate key
            UNPACK    XDATTIME,WTCHDATE,HOUR,MIN,SEC
            PACK      WTCHTIME,HOUR,COLON,MIN,COLON,SEC
            GOTO      WRCHB200
.
          ENDIF
.
WRCHB999  RETURN
.
.------------------------------------------------------------
. Update Field Change Audit for status
.------------------------------------------------------------
WRCHC000  MATCH     Z70,UPDFLD09
          GOTO      WRCHC999 IF EQUAL
.
          MATCH     SP70,UPDFLD09
          GOTO      WRCHC999 IF EQUAL
.
          MATCH     Z70,REASFC09
          GOTO      WRCHC999 IF EQUAL
.
          MATCH     SP70,REASFC09
          GOTO      WRCHC999 IF EQUAL
.
          MATCH     OLDVAL09,DWMSTAT
          GOTO      WRCHC999 IF EQUAL
.
          PACK      WTCHURNO,WMURNO,SP70
          PACK      WTCHPROC,WMCODE,SP70
          PACK      WTCHPCNT,WMCNT,SP70
.
          CALL      IBACLOCK
          PACK      WTCHDATE,CCC,CYY,CMM,CDD
          REPLACE   " 0",WTCHDATE
          CLOCK     TIME,WTCHTIME
.
          PACK      WTCHUPTY,UPDFLD09,SP70
          PACK      WTCHREAS,REASFC09,SP70
          MOVE      USERID,WTCHUSID
          PACK      WTCHOVAL,OLDVAL09
          PACK      WTCHCVAL,WMSTAT
.
          MOVE      ZERO,ADDSECND
.
WRCHC200  PACK      KEY35,WTCHURNO,WTCHPROC,WTCHPCNT,WTCHDATE,WTCHTIME,SP70
          CALL      RAWTCHA1
          IF        OVRCD=1
            CALL      WRWTCHA1
          ELSE
            IF        ADDSECND<=5
              ADD       ONE,ADDSECND
            ELSE
              GOTO      WRCHC999
            ENDIF
.
            UNPACK    WTCHTIME,HOUR,D1,MIN,D1,SEC
            PACK      XDATTIME,WTCHDATE,HOUR,MIN,SEC,SP70
            CALL      ASEC0000                     * add 1 sec to date/time
                                                   * to stop duplicate key
            UNPACK    XDATTIME,WTCHDATE,HOUR,MIN,SEC
            PACK      WTCHTIME,HOUR,COLON,MIN,COLON,SEC
            GOTO      WRCHC200
.
          ENDIF
.
WRCHC999  RETURN
.
.------------------------------------------------------------
. Update Field Change Audit for removal
.------------------------------------------------------------
WRCHD000  MATCH     Z70,UPDFLD05
          GOTO      WRCHD999 IF EQUAL
.
          MATCH     SP70,UPDFLD05
          GOTO      WRCHD999 IF EQUAL
.         
          MATCH     Z70,REASFC05
          GOTO      WRCHD999 IF EQUAL
.
          MATCH     SP70,REASFC05
          GOTO      WRCHD999 IF EQUAL
.
          MATCH     SP70,WMDATE4
          GOTO      WRCHD999 IF EQUAL
.         
          PACK      WTCHURNO,WMURNO,SP70
          PACK      WTCHPROC,WMCODE,SP70
          PACK      WTCHPCNT,WMCNT,SP70
.
          CALL      IBACLOCK
          PACK      WTCHDATE,CCC,CYY,CMM,CDD
          REPLACE   " 0",WTCHDATE
          CLOCK     TIME,WTCHTIME
.
          PACK      WTCHUPTY,UPDFLD05,SP70
          PACK      WTCHREAS,REASFC05,SP70
          MOVE      USERID,WTCHUSID
          PACK      WTCHOVAL,SP70,SP70
          PACK      WTCHCVAL,WMDATE4,WTTXRTIM,SP70
.
          PACK      KEY35,WTCHURNO,WTCHPROC,WTCHPCNT,WTCHDATE,WTCHTIME,SP70
          CALL      RDWTCHA1
          IF        OVRCD=1
            CALL      WRWTCHA1
          ENDIF
.
WRCHD999  RETURN
.
.------------------------------------------------------------
. Update Field Change Audit for removal update
.------------------------------------------------------------
WRCHE000  MATCH     Z70,UPDFLD07
          GOTO      WRCHE999 IF EQUAL
.
          MATCH     SP70,UPDFLD07
          GOTO      WRCHE999 IF EQUAL
.
          MATCH     Z70,REASFC07
          GOTO      WRCHE999 IF EQUAL
.
          MATCH     SP70,REASFC07
          GOTO      WRCHE999 IF EQUAL
.
          MATCH     SP70,WMREMOVE
          GOTO      WRCHE999 IF EQUAL
.
          MATCH     SP70,WMDATE4
          GOTO      WRCHE999 IF EQUAL
.
          PACK      WTCHURNO,WMURNO,SP70
          PACK      WTCHPROC,WMCODE,SP70
          PACK      WTCHPCNT,WMCNT,SP70
.
          CALL      IBACLOCK
          PACK      WTCHDATE,CCC,CYY,CMM,CDD
          REPLACE   " 0",WTCHDATE
          CLOCK     TIME,WTCHTIME
.
          PACK      WTCHUPTY,UPDFLD07,SP70
          PACK      WTCHREAS,REASFC07,SP70
          MOVE      USERID,WTCHUSID
          PACK      WTCHOVAL,OLDVAL07,SP70
          PACK      WTCHCVAL,WMDATE4,WMREMOVE,SP70
.
          PACK      KEY35,WTCHURNO,WTCHPROC,WTCHPCNT,WTCHDATE,WTCHTIME,SP70
          CALL      RDWTCHA1
          IF        OVRCD=1
            CALL      WRWTCHA1
          ENDIF
.
WRCHE999  RETURN
.
.------------------------------------------------------------
. Update Field Change Audit for suspension update
.------------------------------------------------------------
.
.------------------------------------------------------------
. Update Field Change Audit for suspension update
.------------------------------------------------------------
WRCHF000  PACK      WTCHURNO,WMURNO,SP70
          PACK      WTCHPROC,WMCODE,SP70
          PACK      WTCHPCNT,WMCNT,SP70
          UNPACK    WATSU002,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00
          PACK      WTSUTDAT,CCENT,CYEAR,CMON,CDAY
.
          CALL      IBACLOCK
          PACK      WTCHDATE,CCC,CYY,CMM,CDD
          REPLACE   " 0",WTCHDATE
          CLOCK     TIME,WTCHTIME
          MOVE      USERID,WTCHUSID
.
          MATCH     Z70,REASFC15
          GOTO      WRCHF500 IF EQUAL
.
          MATCH     SP70,REASFC15
          GOTO      WRCHF500 IF EQUAL
.
          PACK      WTCHUPTY,TEN5,SP70           * Integrity Audit Reason for
          MOVE      REASFC15,WTCHREAS            * update suspension
          PACK      WTCHOVAL,OLDVAL15,SP70
          PACK      WTCHCVAL,WTSUFDAT,WTSUTDAT,WTSULSTS,WTSUREAS,DWTSUCNT,SP70
          GOTO      WRCHF800
.
WRCHF500  PACK      WTCHUPTY,TEN,SP70
          MOVE      SP70,WTCHREAS
          MATCH     Z70,WATSU003
          IF        !@EQUAL
            PACK      WTCHREAS,WATSU003,SP70
          ENDIF
.
          PACK      WTCHOVAL,OLDVAL01,SP70
          PACK      WTCHCVAL,WTSUFDAT,WTSUTDAT,WTSULSTS,SP70
.
WRCHF800  PACK      KEY35,WTCHURNO,WTCHPROC,WTCHPCNT,WTCHDATE,WTCHTIME,SP70
          CALL      RDWTCHA1
          IF        OVRCD=1
            CALL      WRWTCHA1
          ENDIF
.
WRCHF999  RETURN
.
.------------------------------------------------------------
. Update Field Change Audit for suspension delete
.------------------------------------------------------------
WRCHG000  PACK      WTCHURNO,WMURNO,SP70
          PACK      WTCHPROC,WMCODE,SP70
          PACK      WTCHPCNT,WMCNT,SP70
.
          CALL      IBACLOCK
          PACK      WTCHDATE,CCC,CYY,CMM,CDD
          REPLACE   " 0",WTCHDATE
          CLOCK     TIME,WTCHTIME
          MOVE      USERID,WTCHUSID
.
          MATCH     Z70,REASFC14
          GOTO      WRCHG500 IF EQUAL
.
          MATCH     SP70,REASFC14
          GOTO      WRCHG500 IF EQUAL
.
          PACK      WTCHUPTY,TEN4,SP70           * Integrity Audit Reason for
          MOVE      REASFC14,WTCHREAS            * deletion
          GOTO      WRCHG800
.
WRCHG500  PACK      WTCHUPTY,TEN1,SP70
          MOVE      SP70,WTCHREAS
          MATCH     Z70,WATSU003
          IF        !@EQUAL
            PACK      WTCHREAS,WATSU003,SP70
          ENDIF
.
WRCHG800  PACK      WTCHOVAL,OLDVAL01,SP70
          PACK      WTCHCVAL,SP70
.
          PACK      KEY35,WTCHURNO,WTCHPROC,WTCHPCNT,WTCHDATE,WTCHTIME,SP70
          CALL      RDWTCHA1
          IF        OVRCD=1
            CALL      WRWTCHA1
          ENDIF
.
WRCHG999  RETURN
.
.------------------------------------------------------------
. Update Field Change Audit for scheduled admission date/time
.------------------------------------------------------------
WRCHI000  PACK      WTCHURNO,WMURNO,SP70
          PACK      WTCHPROC,WMCODE,SP70
          PACK      WTCHPCNT,WMCNT,SP70
.
          CALL      IBACLOCK
          PACK      WTCHDATE,CCC,CYY,CMM,CDD
          REPLACE   " 0",WTCHDATE
          CLOCK     TIME,WTCHTIME
          MOVE      USERID,WTCHUSID
          MOVE      "08",WTCHUPTY
          MOVE      WATHI001,WTCHREAS
          MOVE      OLDVAL01,WTCHOVAL
          MOVE      OLDVAL02,WTCHCVAL
          PACK      WTCHSPAR,SP70
.
          PACK      KEY35,WTCHURNO,WTCHPROC,WTCHPCNT,WTCHDATE,WTCHTIME,SP70
          CALL      RDWTCHA1
          IF        OVRCD=1
            CALL      WRWTCHA1
          ENDIF
.
WRCHI999  RETURN
.
.*****************************************************************************
.*                            ASEC0000                                       *
.*               Add one second to date/time                                 *
.* Requires: XDATTIME - Date/time value (ccyymmddhhmmss)                     *
.* Returns : XDATTIME - Date/time value (ccyymmddhhmmss) incremented by 1 sec*
.*****************************************************************************
ASEC0000  UNPACK    XDATTIME,DIM8,HOURTM,MINTIME,SECTIME
          MATCH     "59",SECTIME
          IF        !@EQUAL
            MOVE      SECTIME,FORM2              * just increment seconds
            ADD       ONE,FORM2
            MOVE      FORM2,SECTIME
            REP       " 0",SECTIME
            PACK      XDATTIME,DIM8,HOURTM,MINTIME,SECTIME
            GOTO      ASEC9999
          ENDIF
.
.         The seconds were "59", so reset these to "00" and increment the
.         minutes
.
          MOVE      "00",SECTIME
          MATCH     "59",MINTIME
          IF        !@EQUAL
            MOVE      MINTIME,FORM2              * just increment minutes
            ADD       ONE,FORM2
            MOVE      FORM2,MINTIME
            REP       " 0",MINTIME
            PACK      XDATTIME,DIM8,HOURTM,MINTIME,SECTIME
            GOTO      ASEC9999
          ENDIF
.
.         The minutes were "59", so reset these to "00" and increment the
.         hours
.
          MOVE      "00",SECTIME
          MOVE      "00",MINTIME
          MATCH     "23",HOURTM
          IF        !@EQUAL
            MOVE      HOURTM,FORM2              * just increment hours
            ADD       ONE,FORM2
            MOVE      FORM2,HOURTM
            REP       " 0",HOURTM
            PACK      XDATTIME,DIM8,HOURTM,MINTIME,SECTIME
            GOTO      ASEC9999
          ENDIF
.
.         The hours were "59", so reset these to "00" and increment the
.         date
.
          MOVE      "00",SECTIME
          MOVE      "00",MINTIME
          MOVE      "00",HOURTM
.
.         We need to increment the date by 1 day
.
          UNPACK    DIM8,CCENT,CYEAR,CMON,CDAY
          MOVE      CCENT,CC
          MOVE      CYEAR,YY
          MOVE      CMON,MM
          MOVE      CDAY,DD
          CALL      DMYCON                       * get julian day
          ADD       ONE,JULDAY                   * increment julian day
          MOVE      JULDAY,JWKDAY
          MOVE      JULYR,JWKYER
          MOVE      JULCC,JWKCC
          CALL      JULCON                       * get new date
          PACK      XDATTIME,CC,YY,MM,DD,ZERO6
          REP       " 0",XDATTIME
.
ASEC9999  RETURN
.
.------------------------------------------------------------
. WL Comments Maintenance
.------------------------------------------------------------
WTCOMM00  RESET     UPDTTYPE
          MATCH     SP70,UPDTTYPE
          GOTO      WTCOMM80 IF EQUAL
.
          MATCH     "A",UPDTTYPE            * Add Comments Formaction
          GOTO      WTCOMM10 IF EQUAL
.
          MATCH     "D",UPDTTYPE            * Delete Comments Formaction
          GOTO      WTCOMM30 IF EQUAL
.
          GOTO      WTCOMM92
.
.         ************ ADD FORMACTION ***********
.
WTCOMM10  CALL      CHKCAS00           * Checks mandatory fields and for blanks
          BRANCH    EXIT,WTCOMM99
.
          PACK      KEY19,CASEKEYS,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,WTCOMM90
.         
          CALL      ADDCOM00                * Add Note SubRoutine
.
          MOVE      ZERO,EXIT
          GOTO      WTCOMM99
.
.         ************ DELETE FORMACTION **********
.
WTCOMM30  PACK      KEY19,CASEKEYS,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,WTCOMM90
.
          CALL      DELCOM00                * Delete Note SubRoutine
          BRANCH    EXIT,WTCOMM99
.
          MOVE      ZERO,EXIT
          GOTO      WTCOMM99
.
.         ************ DISPLAY FORMACTION **********
.
WTCOMM80  PACK      KEY19,CASEKEYS,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,WTCOMM90
.
          MOVE      WMURNO,URNUMBER
.
          PACK      KEY19,CASEKEYS,SP70
          CALL      RDWTTX11
          BRANCH    OVRCD,WTCOMM90
.
          PACK      KEY8,URNUMBER,SP70 
          CALL      RDMAST1
          BRANCH    OVRCD,WTCOMM91
.         
          PACK      KEY8,URNUMBER,SP70 
          CALL      RDPMPX21
          BRANCH    OVRCD,WTCOMM91
.
          MOVE      CASEKEYS,DIM19
          PACK      KEY28,DIM19,NOTETYPE,NOTENUMB,SP70
          CALL      RDWTMHD1
          IF        OVRCD=1
            CALL      CLWATMHD     * Clear all the file variables
          ENDIF
.
          MOVE      "Comments Maintenance",WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,WTCOMM99
          CALL      WEBBOD00                * Process Web Body
          CALL      WEBEND00                * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      WTCOMM99
.
WTCOMM90  MOVE      "Invalid Waiting List Case Key",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      WTCOMM99
.
WTCOMM91  MOVE      "Invalid U/R Number ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      WTCOMM99
.
WTCOMM92  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      WTCOMM99
.
WTCOMM99  CLOSE     COMFILWF,DELETE
          RETURN
.
.------------------------------------------------------------
. WL header and line based comments tags
.------------------------------------------------------------
WTMH0000  BRANCH    FLDITMNO,WTMH0100,WTMH0200,WTMH0300,WTMH0400,WTMH0500:
                             WTMH0600,WTMH0700,WTMH0800,WTMH0900,WTMH1000:
                             WTMH1100,WTMH1200,WTMH1300,WTMH1400,WTMH1500
.         
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      WTMH9999
.         
WTMH0100  WRITE     HTMLFILE;WTMHTYPE;
          GOTO      WTMH9999
.
WTMH0200  WRITE     HTMLFILE;WTMHNOTE;
          GOTO      WTMH9999
.
WTMH0300  MATCH     SP70,WTMHDATE
          GOTO      WTMH9999 IF EQUAL
.
          UNPACK    WTMHDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      ZERO,F2
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      FRMTDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          WRITE     HTMLFILE;FRMTDATE;
          GOTO      WTMH9999
.
WTMH0400  WRITE     HTMLFILE;WTMHTIME;
          GOTO      WTMH9999
.
WTMH0500  WRITE     HTMLFILE;WTMHUSER;
          GOTO      WTMH9999
.
WTMH0600  WRITE     HTMLFILE;WTMHOCCG;
          GOTO      WTMH9999
.
WTMH0700  WRITE     HTMLFILE;WTMHDELT;
          GOTO      WTMH9999
.
WTMH0800  MATCH     SP70,WTMHDDAT
          GOTO      WTMH9999 IF EQUAL
.         
          UNPACK    WTMHDDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      ZERO,F2
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      FRMTDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          WRITE     HTMLFILE;FRMTDATE;
          GOTO      WTMH9999
.         
WTMH0900  WRITE     HTMLFILE;WTMHDTIM;
          GOTO      WTMH9999
.
WTMH1000  WRITE     HTMLFILE;WTMHDUSE;
          GOTO      WTMH9999
.
WTMH1100  WRITE     HTMLFILE;WTMHDOCC;
          GOTO      WTMH9999
.
WTMH1200  WRITE     HTMLFILE;WTMTCMNT;
          GOTO      WTMH9999
.
WTMH1300  PACK      KEY31,WTMHURNO,WTMHPROC,WTMHPCNT,WTMHTYPE,WTMHNOTE,SP70
          CALL      RSWTMTX1
WTMH1310  CALL      RKWTMTX1
          BRANCH    OVRCD,WTMH9999
.
          MATCH     WTMHURNO,WTMTURNO
          GOTO      WTMH9999 IF NOT EQUAL
.
          MATCH     WTMHPROC,WTMTPROC
          GOTO      WTMH9999 IF NOT EQUAL
.
          MATCH     WTMHPCNT,WTMTPCNT
          GOTO      WTMH9999 IF NOT EQUAL
.
          MATCH     WTMHTYPE,WTMTTYPE
          GOTO      WTMH9999 IF NOT EQUAL
.
          MATCH     WTMHNOTE,WTMTNOTE
          GOTO      WTMH9999 IF NOT EQUAL
.
          STRIP     WTMTCMNT
          MOVELPTR  WTMTCMNT,LENGTH
.
          COMPARE   LENGTH,ZERO
          IF        @EQUAL
            MOVE      ONE,LENGTH
          ENDIF
.
          SFORMAT   VAR,LENGTH
          MOVE      WTMTCMNT,VAR
          WRITE     HTMLFILE;VAR
          SFORMAT   VAR,127
.
          GOTO      WTMH1310
.
WTMH1400  MOVE      ZERO,NOTEORDR
          CALL      COMTAB00
          GOTO      WTMH9999
.
WTMH1500  MOVE      ONE,NOTEORDR
          CALL      COMTAB00
          GOTO      WTMH9999
.
WTMH9999  RETURN
.
.---------------------------------------------------------------------
. Display Table of Waiting list comments
.---------------------------------------------------------------------
COMTAB00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          MOVE      SP70,NOTEFILT
          UNPACK    DIM127,D1,NOTEFILT,DIM127
.
          CALL      COMHD000      * Output Table Heading
.
          MOVE      CASEKEYS,DIM19
          IF        NOTEORDR=0
            PACK      KEY28,DIM19,NOTEFILT,Z70
          ELSE
            PACK      KEY28,DIM19,NOTEFILT,SP70
          ENDIF
.
          CALL      RSWTMHD1
COMTAB10  IF        NOTEORDR=0
            CALL      RPWTMHD1
          ELSE
            CALL      RKWTMHD1
          ENDIF
          BRANCH    OVRCD,COMTAB99
.
          PACK      KEY19,WTMHURNO,WTMHPROC,WTMHPCNT,SP70
          MATCH     CASEKEYS,KEY19
          GOTO      COMTAB99 IF NOT EQUAL
.
          MATCH     NOTEFILT,WTMHTYPE
          GOTO      COMTAB99 IF NOT EQUAL
.
          MATCH     WTMHDATE,SP70
          IF        @EQUAL
            MOVE     "&nbsp",FRMTDATE
            GOTO     COMTAB40
          ENDIF
.
          UNPACK    WTMHDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      FRMTDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
COMTAB40  MATCH     "1",WTMHDELT
          IF        @EQUAL
            MOVE       "<strike>",STRIKETG
            MOVE       "</strike>",STRENDTG
          ELSE
            MOVE       "",STRIKETG
            MOVE       "",STRENDTG
          ENDIF
.
          MOVE      CASEKEYS,DIM19
          MOVE      ZERO,LINECNTR
          CALL      WLCNTL00
.
          REP       " +",CASEKEYS
          REP       " +",WTMHTYPE
          REP       " +",WTMHNOTE
.
          WRITE     HTMLFILE;"<tr><td nowrap><a href='javascript:ShowDetail20":
                             "(#"",LINKPRG,"#.pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&casekeys=",DIM19:
                             "&notetype=",WTMHTYPE:
                             "&notenumb=",WTMHNOTE,"#")'>":
                             "<img src=../images/MaintenanceIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>";
          IF        LINECNTR>2
            WRITE     HTMLFILE;"<font color=red>",STRIKETG,FRMTDATE,SP1,WTMHTIME,"</td>";
          ELSE
            WRITE     HTMLFILE;STRIKETG,FRMTDATE,SP1,WTMHTIME,"</td>";
          ENDIF
.
          PACK      KEY10,WTMHUSER,SP70
          CALL      RDWBSE1
          IF        OVRCD=0
            WRITE     HTMLFILE;"<td>",STRIKETG,WBSENAM," - ",WTMHOCCG,"&nbsp":
                               STRENDTG,"</td>":
                               "<td nowrap>",STRIKETG;
          ELSE
            WRITE     HTMLFILE;"<td>",STRIKETG,WTMHUSER," - ",WTMHOCCG,"&nbsp":
                               STRENDTG,"</td>":
                               "<td nowrap>",STRIKETG;
          ENDIF
.
          REP       "+ ",CASEKEYS
          REP       "+ ",WTMHTYPE
          REP       "+ ",WTMHNOTE
.
          MOVE      ZERO,LINECNTR
          MOVE      ZERO,ALLCOMM
          CALL      WLCOMM00
.
          PACK      KEY10,WTMHDUSE,SP70
          CALL      RDWBSE1
          IF        OVRCD=0
            WRITE     HTMLFILE;"&nbsp",STRENDTG,"</td>":
                               "<td>",WBSENAM," - ",WTMHDOCC,"&nbsp":
                               "</td>":
                               "</tr>"
          ELSE
            WRITE     HTMLFILE;"&nbsp",STRENDTG,"</td>":
                               "<td>",WTMHDUSE," - ",WTMHDOCC,"&nbsp":
                               "</td>":
                               "</tr>"
          ENDIF
.
          GOTO      COMTAB10
.
COMTAB99  RETURN
.
.---------------------------------------------------------------------
. Display View only of Waiting list comments
.---------------------------------------------------------------------
VEWCOM00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          MOVE      SP70,NOTEFILT
          UNPACK    DIM127,D1,NOTEFILT,DIM127
.
          MOVE      CASEKEYS,DIM19
          IF        NOTEORDR=0
            PACK      KEY28,DIM19,NOTEFILT,Z70
          ELSE
            PACK      KEY28,DIM19,NOTEFILT,SP70
          ENDIF
.
          CALL      RSWTMHD1
VEWCOM10  IF        NOTEORDR=0
            CALL      RPWTMHD1
          ELSE
            CALL      RKWTMHD1
          ENDIF
          BRANCH    OVRCD,VEWCOM99
.
          PACK      KEY19,WTMHURNO,WTMHPROC,WTMHPCNT,SP70
          MATCH     CASEKEYS,KEY19
          GOTO      VEWCOM99 IF NOT EQUAL
.
          MATCH     NOTEFILT,WTMHTYPE
          GOTO      VEWCOM99 IF NOT EQUAL
.
          MATCH     WTMHDATE,SP70
          IF        @EQUAL
            MOVE     "&nbsp",FRMTDATE
            GOTO     VEWCOM40
          ENDIF
.
          UNPACK    WTMHDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      FRMTDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
VEWCOM40  MATCH     "1",WTMHDELT
          IF        @EQUAL
            GOTO       VEWCOM10
          ENDIF
          MOVE       "",STRIKETG
          MOVE       "",STRENDTG
.
          REP       " +",CASEKEYS
          REP       " +",WTMHTYPE
          REP       " +",WTMHNOTE
.
          MOVE      CASEKEYS,DIM19
          WRITE     HTMLFILE;STRIKETG,FRMTDATE,SP1,WTMHTIME," - ";
.
          PACK      KEY10,WTMHUSER,SP70
          CALL      RDWBSE1
          IF        OVRCD=0
            WRITE     HTMLFILE;STRIKETG,WBSENAM,"<br>";
          ELSE
            WRITE     HTMLFILE;STRIKETG,WTMHUSER,"<br>";
          ENDIF
.
          REP       "+ ",CASEKEYS
          REP       "+ ",WTMHTYPE
          REP       "+ ",WTMHNOTE
.
          MOVE      ZERO,LINECNTR
          MOVE      ONE,ALLCOMM
          CALL      WLCOMM00
.
          GOTO      VEWCOM10
.
VEWCOM99  RETURN
.

.------------------------------------------------------------
. Waiting List Comments Heading (TABLE HEADING)
.------------------------------------------------------------
COMHD000  WRITE     HTMLFILE;"<tr>":
                              "<td class=HeadingCell width=20%>Date</td>":
                              "<td class=HeadingCell width=20%>Input By</td>":
                              "<td class=HeadingCell width=40%>":
                              "Comment</td>":
                              "<td class=HeadingCell width=20%>Delete By</td>":
                             "</tr>"
.
COMHD999  RETURN
.
.--------------------------------------------------------------------
. WL Comment Display
.--------------------------------------------------------------------
WLCOMM00  PACK      KEY31,WTMHURNO,WTMHPROC,WTMHPCNT,WTMHTYPE,WTMHNOTE,SP70
          CALL      RSWTMTX1
WLCOMM10  CALL      RKWTMTX1
          BRANCH    OVRCD,WLCOMM99
.
          MATCH     WTMHURNO,WTMTURNO
          GOTO      WLCOMM99 IF NOT EQUAL
.
          MATCH     WTMHPROC,WTMTPROC
          GOTO      WLCOMM99 IF NOT EQUAL
.
          MATCH     WTMHPCNT,WTMTPCNT
          GOTO      WLCOMM99 IF NOT EQUAL
.
          MATCH     WTMHTYPE,WTMTTYPE
          GOTO      WLCOMM99 IF NOT EQUAL
.
          MATCH     WTMHNOTE,WTMTNOTE            * CAR 243854
          GOTO      WLCOMM99 IF NOT EQUAL
.
          IF        ALLCOMM<>1
            COMPARE   TEN,LINECNTR
            GOTO      WLCOMM99 IF EQUAL
          ENDIF
.
          COMPARE   ZERO,LINECNTR
          IF        !@EQUAL
...         WRITE     HTMLFILE;"<br>";
          ENDIF
  
          ADD       ONE,LINECNTR
          WRITE     HTMLFILE;WTMTCMNT,"<br>";;
          GOTO      WLCOMM10
.
WLCOMM99  RETURN
.
.--------------------------------------------------------------------
. WL Comment Line count
.--------------------------------------------------------------------
WLCNTL00  PACK      KEY31,WTMHURNO,WTMHPROC,WTMHPCNT,WTMHTYPE,WTMHNOTE,SP70
          CALL      RSWTMTX1
WLCNTL10  CALL      RKWTMTX1
          BRANCH    OVRCD,WLCNTL99
.
          MATCH     WTMHURNO,WTMTURNO
          GOTO      WLCNTL99 IF NOT EQUAL
.
          MATCH     WTMHPROC,WTMTPROC
          GOTO      WLCNTL99 IF NOT EQUAL
.
          MATCH     WTMHPCNT,WTMTPCNT
          GOTO      WLCNTL99 IF NOT EQUAL
.
          MATCH     WTMHTYPE,WTMTTYPE
          GOTO      WLCNTL99 IF NOT EQUAL
.
          MATCH     WTMHNOTE,WTMTNOTE
          GOTO      WLCNTL99 IF NOT EQUAL
.
          ADD       ONE,LINECNTR
          GOTO      WLCNTL10
.
WLCNTL99  RETURN
.
.-----------------------------------------------------------
.* Checks if casekeys is populated for WL comments
.------------------------------------------------------------
CHKCAS00  MATCH     SP70,CASEKEYS
          GOTO      CHKCAS90 IF EQUAL
          GOTO      CHKCAS98
.
CHKCAS90  MOVE      "Invalid Waiting List Case Key",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKCAS99
.
CHKCAS98  MOVE      ZERO,EXIT
.
CHKCAS99  RETURN
.
.-----------------------------------------------------------
. Delete a Waiting List Comment
.-----------------------------------------------------------
DELCOM00  MATCH     SP70,CASEKEYS
          GOTO      DELCOM90 IF EQUAL
.
          MOVE      CASEKEYS,DIM19
          PACK      KEY28,DIM19,NOTETYPE,NOTENUMB,SP70
          CALL      RDWTMHD1
          BRANCH    OVRCD,DELCOM99
.
          MATCH     "1",SUPRFLAG
          IF        !@EQUAL
            MATCH     USERID,WTMHUSER
            GOTO      DELCOM91 IF NOT EQUAL
          ENDIF
.
          PACK      WTMHDDAT,CCC,CYY,CMM,CDD
          REP       " 0",WTMHDDAT
          CLOCK     TIME,WTMHDTIM
          MOVE      USERID,WTMHDUSE
.
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,DELCOM99
.
          MOVE      WBSEOCG,WTMHDOCC
.
          MOVE      "1",WTMHDELT           * Delete Indicator
.
          MOVE      CASEKEYS,DIM19
          PACK      KEY28,DIM19,NOTETYPE,NOTENUMB,SP70
          CALL      UPWTMHD1               * Write Record
          GOTO      DELCOM98
.
DELCOM90  MOVE      "Invalid Waiting List Case Key.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DELCOM99
.
DELCOM91  MOVE      "User ID must be the same to strikeout this entry.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DELCOM99
.
DELCOM98  MOVE      ZERO,EXIT
.
DELCOM99  RETURN
.
.------------------------------------------------------------
.  Write Waiting List Comments
.------------------------------------------------------------
ADDCOM00  MOVE      ZERO,F6
.
          MOVE      CASEKEYS,DIM19
          PACK      KEY28,DIM19,NOTETYPE,Z70
          CALL      RSWTMHD1
          CALL      RPWTMHD1                * read back to get last record
          IF        OVRCD=1
            MOVE      ONE,F6
            MOVE      F6,WTMHNOTE           * Note Number
          ELSE
            PACK      KEY19,WTMHURNO,WTMHPROC,WTMHPCNT,SP70
            MATCH     CASEKEYS,KEY19        * Same visit
            IF        @EQUAL
              MATCH     NOTETYPE,WTMHTYPE   * Same note type
              IF        @EQUAL
                MOVE      WTMHNOTE,F6
                ADD       ONE,F6
                MOVE      F6,WTMHNOTE
              ELSE
                MOVE      ONE,F6
                MOVE      F6,WTMHNOTE       * Note Number
              ENDIF
            ELSE
              MOVE      ONE,F6
              MOVE      F6,WTMHNOTE         * Note Number
            ENDIF
          ENDIF
.
             
          UNPACK    CASEKEYS,WTMHURNO,WTMHPROC,WTMHPCNT
          MOVE      NOTETYPE,WTMHTYPE       * Notes Type
.
          PACK      WTMHDATE,CCC,CYY,CMM,CDD
          REP       " 0",WTMHDATE          * Date
          CLOCK     TIME,WTMHTIME
          MOVE      USERID,WTMHUSER        * User
.
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,ADDCOM99
.
          MOVE      WBSEOCG,WTMHOCCG        * Occupation Group
          MOVE      "0",WTMHDELT            * Delete Indicator
          MOVE      SP70,WTMHDDAT           * Delete Date
          MOVE      SP70,WTMHDTIM           * Delete Time
          MOVE      SP70,WTMHDUSE           * Delete User
          MOVE      SP70,WTMHDOCC           * Delete User Occupation group
          PACK      WTMHSPAR,SP70,SP70      * Spare
.
          PACK      KEY28,WTMHURNO,WTMHPROC,WTMHPCNT,WTMHTYPE,WTMHNOTE,SP70
          CALL      RDWTMHD1
          IF        OVRCD=1
            CALL      WRWTMHD1              * Write Record
          ELSE
            GOTO      ADDCOM99
          ENDIF
.
.         now write the comments
.
          MOVE      WTMHURNO,WTMTURNO
          MOVE      WTMHPROC,WTMTPROC
          MOVE      WTMHPCNT,WTMTPCNT
          MOVE      WTMHTYPE,WTMTTYPE
          MOVE      WTMHNOTE,WTMTNOTE
          MOVE      ZERO,BLNKFLAG
          MOVE      ZERO,F3
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      COMFILWF,COMFILNW
          TRAPCLR   IO
          BRANCH    OVRCD,ADDCOM99
.
ADDCOM90  ADD       ONE,F3
          MOVE      F3,WTMTUNIQ
.
          READ      COMFILWF,SEQ;WTMTCMNT
          GOTO      ADDCOM99 IF OVER
.
          MATCH     SP70,WTMTCMNT
          IF        @EQUAL
            BRANCH    BLNKFLAG,ADDCOM90
            MOVE      ONE,BLNKFLAG               * Blank line yes
            GOTO      ADDCOM70                   * don't write second blank line
          ENDIF
          IF        @EOS
            BRANCH    BLNKFLAG,ADDCOM90          * don't write second blank line
            MOVE      ONE,BLNKFLAG               * Blank line yes
            GOTO      ADDCOM70
          ENDIF
.
          MOVE      ZERO,BLNKFLAG
.
ADDCOM70  PACK      KEY31,WTMTURNO,WTMTPROC,WTMTPCNT,WTMTTYPE,WTMTNOTE:
                          WTMTUNIQ,SP70
          CALL      WRWTMTX1
          IF        F3>=LASTITEM
            GOTO     ADDCOM99
          ENDIF
          GOTO      ADDCOM90
.
ADDCOM99  RETURN
.
.------------------------------------------------------------
. Get Waiting List Comments
.------------------------------------------------------------
GETWAT00  PREP      COMFILWF,COMFILNW
          MOVE      ONE,F3
          WRITE     COMFILWF,SEQ;QRYDATA
.
GETWAT10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETWAT90 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETWAT80 IF NOT EQUAL
          ADD       ONE,F3
          WRITE     COMFILWF,SEQ;QRYDATA
          GOTO      GETWAT10
.
GETWAT80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETWAT90  MOVE      F3,LASTITEM
          OPEN      COMFILWF,COMFILNW
GETWAT99  RETURN
+
.-------------------------------------------------------------------------------
.  DISWAR00 - Disaster Validations and Warnings
.-------------------------------------------------------------------------------
DISWAR00  MOVE      ZERO,EXIT
          MATCH     SP70,DISPT001
          GOTO      DISWAR99 IF EQUAL
          GOTO      DISWAR99 IF EOS
.
          PACK      KEY9,DISPT001,SP70
          CALL      RDDSMAS1
          BRANCH    OVRCD,DISWAR90
.
          MATCH     SP70,DSMASDAT
          IF        !@EQUAL & !@EOS
            MATCH     DSMASDAT,WMDATE1
            IF        @LESS
              GOTO      DISWAR92
            ENDIF
          ENDIF
.
          MATCH     SP70,DSMAEDAT
          IF        !@EQUAL & !@EOS
            MATCH     WMDATE1,DSMAEDAT
            IF        @LESS
              GOTO      DISWAR92
            ENDIF
          ENDIF
.
          MOVE      PURNO,DSPTURNO
          MOVE      DISPT002,DSPTDIID
          MOVE      DISPT001,DSPTCODE
          MOVE      DSMASDAT,DSPTSDAT
          MOVE      DSMAEDAT,DSPTEDAT
          MOVE      SP70,DSPTOTCM
          MOVE      " 4",DSPTFICA
          MOVE      SP70,DSPTSPAR
.
          PACK      KEY17,PURNO,DISPT001,SP70
          CALL      RADSPAT1
          IF        OVRCD=1
            MOVE      WBSEUID,DSPTCUSR
            CALL      IBACLOCK
            PACK      DSPTCDAT,CCC,CYY,CMM,CDD
            REP       " 0",DSPTCDAT
            CLOCK     TIME,CTIMEIS
            MOVE      CTIMEIS,DSPTCTIM
            MOVE      SP70,DSPTUUSR
            MOVE      SP70,DSPTUDAT
            MOVE      SP70,DSPTUTIM
            CALL      WRDSPAT1
          ELSE
            MOVE      WBSEUID,DSPTUUSR
            CALL      IBACLOCK
            PACK      DSPTUDAT,CCC,CYY,CMM,CDD
            REP       " 0",DSPTUDAT
            CLOCK     TIME,CTIMEIS
            MOVE      CTIMEIS,DSPTUTIM
            CALL      UPDSPAT1
          ENDIF
.
          MOVE      PURNO,DSPLURNO
          MOVE      DISPT001,DSPLCODE
          MOVE      WMBOOK,DSPLVISN
          MOVE      SP70,DSPLSPAR
          PACK      KEY25,PURNO,DISPT001,WMBOOK,SP70
          CALL      RADSPTL1
          IF        OVRCD=1
            MOVE      WBSEUID,DSPLCUSR
            CALL      IBACLOCK
            PACK      DSPLCDAT,CCC,CYY,CMM,CDD
            REP       " 0",DSPLCDAT
            CLOCK     TIME,CTIMEIS
            MOVE      CTIMEIS,DSPLCTIM
            MOVE      SP70,DSPLUUSR
            MOVE      SP70,DSPLUDAT
            MOVE      SP70,DSPLUTIM
            CALL      WRDSPTL1
          ELSE
            MOVE      WBSEUID,DSPLUUSR
            CALL      IBACLOCK
            PACK      DSPLUDAT,CCC,CYY,CMM,CDD
            REP       " 0",DSPLUDAT
            CLOCK     TIME,CTIMEIS
            MOVE      CTIMEIS,DSPTUTIM
            CALL      UPDSPTL1
          ENDIF
.
          CALL     NWDALT00
          GOTO     DISWAR99
.
DISWAR90  MOVE      "Disaster Master Record not found.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DISWAR99
.
DISWAR92  MOVE      "Date on list is not within the Disaster Start/End Date.",WEBTITLE
.
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DISWAR99
.
DISWAR99  RETURN
.
.---------------------------------------------------------------------
. NWDALT00 - Write a new alternate ID record for disaster patients
.---------------------------------------------------------------------
NWDALT00  PACK      PMAIURNO,PURNO,SP70
.
          MATCH     SP70,DSMAAICD
          GOTO      NWDALT99 IF EQUAL
          GOTO      NWDALT99 IF EOS
.
          PACK      PMAITYPE,DSMAAICD,SP70
.
          MATCH     SP70,DSPTDIID
          GOTO      NWDALT99 IF EQUAL
          GOTO      NWDALT99 IF EOS
.
          PACK      KEY5,ANSA,ANSI,DSMAAICD,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MATCH     SP70,TCINDC1
            IF        !@EQUAL & !@EOS
              PACK      PMAIALID,TCINDC1,DSPTDIID,SP70
            ELSE
              PACK      PMAIALID,DSPTDIID,SP70
            ENDIF
          ELSE
            PACK      PMAIALID,DSPTDIID,SP70
          ENDIF
.
          RJUSTIFY  PMAIALID
          PACK      PMAIDISU,SP70
          PACK      PMAIHOSP,SP70
          READ      CONTROLF,HUND10;*249,PTCNDAUR
          MATCH     "1",PTCNDAUR
          IF        @EQUAL
            MOVE      "1",PMAIDISU
          ENDIF
          PACK      PMAIRDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMAIRDAT
          UNPACK    SP70,PMAISPAR
.
          PACK      KEY31,PMAIURNO,PMAITYPE,PMAIALID,SP70
          CALL      RAPMAID1
          IF        OVRCD<>1
            GOTO      NWDALT99
          ENDIF
.
          MOVE      USERID,PMAICRUD
          CALL      IBACLOCK
          PACK      PMAICRDT,CCC,CYY,CMM,CDD
          REP       " 0",PMAICRDT
          MOVE      CTIMEIS,PMAICRTM
          MOVE      SP70,PMAIUPDT
          MOVE      SP70,PMAIUPTM
          MOVE      SP70,PMAIUPUD
.
          CALL      WRPMAID1
.
          CALL      PMIGTNID                   * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      SIX,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICUP                     * trigger PMI update
.
NWDALT99  RETURN
.
.------------------------------------------------------------
. Check hospital security if required
.------------------------------------------------------------
CHKHOS00  READ      CONTROLF,HUND18;*154,PTCNUHSC    * using hospital security?
          MOVE      ZERO,EXIT
.
          BRANCH    ALLOWAHS,CHKHOS99
.
          MATCH     "1",PTCNUHSC
          GOTO      CHKHOS99 IF NOT EQUAL
.
          PACK      KEY19,CASEKEYS,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,CHKHOS99
.
          MATCH     WBSEHOSP,WTWMIHSP
          GOTO      CHKHOS99 IF EQUAL
.
CHKHOS90  MOVE      "Invalid Hospital Access",WEBTITLE
          CALL      WALENQ00
          MOVE      ONE,EXIT
          GOTO      CHKHOS99
.
CHKHOS99  RETURN
+
.------------------------------------------------------------
. Invalid visit for user based on current hospital logged in to
.------------------------------------------------------------
WALENQ00  CALL      OPENHTML
          BRANCH    EXIT,WALENQ99
.
          REP       " +",CASEKEYS
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
.
          PACK      REDIRECT,SP70,SP70
          CLEAR     REDIRECT
          APPEND    "patweb98.pbl?reportno=01&template=001",REDIRECT
          APPEND    "&urnumber=",REDIRECT
          APPEND    URNUMBER,REDIRECT
          APPEND    "&invcasek=",REDIRECT
          APPEND    CASEKEYS,REDIRECT
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             "src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             "src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#"> {":
                             "getTop().content.location.href=#"",REDIRECT,"#"}":
                             "</script>"
.
          REP       "+ ",CASEKEYS
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
          CALL      CLOSHTML     * End of Document
.
WALENQ99  RETURN
+
.------------------------------------------------------------
. Update Field Change Audit for return to WL
.------------------------------------------------------------
WRCHH000  MATCH     Z70,UPDFLD13
          GOTO      WRCHH999 IF EQUAL
.
          MATCH     SP70,UPDFLD13
          GOTO      WRCHH999 IF EQUAL
.
          MATCH     Z70,REASFC13
          GOTO      WRCHH999 IF EQUAL
.
          MATCH     SP70,REASFC13
          GOTO      WRCHH999 IF EQUAL
.
          PACK      WTCHURNO,WMURNO,SP70
          PACK      WTCHPROC,WMCODE,SP70
          PACK      WTCHPCNT,WMCNT,SP70
.
          CALL      IBACLOCK
          PACK      WTCHDATE,CCC,CYY,CMM,CDD
          REPLACE   " 0",WTCHDATE
          CLOCK     TIME,WTCHTIME
.
          PACK      WTCHUPTY,UPDFLD13,SP70
          PACK      WTCHREAS,REASFC13,SP70
          MOVE      USERID,WTCHUSID
          PACK      WTCHOVAL,OLDVAL13,SP70
          PACK      WTCHCVAL,SP70,SP70
.
          PACK      KEY35,WTCHURNO,WTCHPROC,WTCHPCNT,WTCHDATE,WTCHTIME,SP70
          CALL      RDWTCHA1
          IF        OVRCD=1
            CALL      WRWTCHA1
          ENDIF
.
WRCHH999  RETURN
+
.------------------------------------------------------------
. Number of Scheduled Admission/Booking Postponements
.------------------------------------------------------------
WTCHPN00  MOVE      ZERO,FORM3
.
          PACK      KEY35,WMURNO,WMCODE,DWMCNT,SP70
          CALL      RSWTCHA1
WTCHPN10  CALL      RKWTCHA1
          BRANCH    OVRCD,WTCHPN90 
.
          MATCH     WMURNO,WTCHURNO
          GOTO      WTCHPN90 IF NOT EQUAL
.
          MATCH     WMCODE,WTCHPROC
          GOTO      WTCHPN90 IF NOT EQUAL
.
          MATCH     DWMCNT,WTCHPCNT
          GOTO      WTCHPN90 IF NOT EQUAL
.
          MATCH     "08",WTCHUPTY
          GOTO      WTCHPN10 IF NOT EQUAL
.
          MATCH     SP70,WTCHREAS
          GOTO      WTCHPN10 IF EQUAL
          GOTO      WTCHPN10 IF EOS
.
          PACK      KEY5,ANSW,ANSD,WTCHREAS,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,WTCHPN10
.
          MATCH     DIM1,TCINDC1
          GOTO      WTCHPN10 IF NOT EQUAL
.
          ADD       ONE,FORM3
.
          GOTO      WTCHPN10
.
WTCHPN90  WRITE     HTMLFILE;FORM3;
.
WTCHPN99  RETURN
+
CLWATSUS  MOVE      SP70,WTSUURNO
          MOVE      SP70,WTSUCODE
          MOVE      ZERO,WTSUCNT
          MOVE      ZERO,WTSUSCNT
          MOVE      SP70,WTSUFDAT
          MOVE      SP70,WTSUTDAT
          MOVE      SP70,WTSUREAS
          MOVE      SP70,WTSULSTS
          RETURN
+
.------------------------------------------------------------
. Write Field Change Audit for Cancel Booking
.------------------------------------------------------------
WRCHJ000  PACK      WTCHURNO,WMURNO,SP70
          PACK      WTCHPROC,WMCODE,SP70
          PACK      WTCHPCNT,WMCNT,SP70
.
          CALL      IBACLOCK
          PACK      WTCHDATE,CCC,CYY,CMM,CDD
          REPLACE   " 0",WTCHDATE
          CLOCK     TIME,WTCHTIME
.
          MOVE      "16",WTCHUPTY
          MOVE      BKRECANC,WTCHREAS
          MOVE      USERID,WTCHUSID
          PACK      WTCHOVAL,BKREEDAT,BKREATIM,SP70
          MOVE      SP70,WTCHCVAL
.
          MOVE      ZERO,ADDSECND
.
WRCHJ200  PACK      KEY35,WTCHURNO,WTCHPROC,WTCHPCNT,WTCHDATE,WTCHTIME,SP70
          CALL      RAWTCHA1
          IF        OVRCD=1
            CALL      WRWTCHA1
          ELSE
            IF        ADDSECND<=5
              ADD       ONE,ADDSECND
            ELSE
              GOTO      WRCHJ999
            ENDIF
.
            UNPACK    WTCHTIME,HOUR,D1,MIN,D1,SEC
            PACK      XDATTIME,WTCHDATE,HOUR,MIN,SEC,SP70
            CALL      ASEC0000                     * add 1 sec to date/time
                                                   * to stop duplicate key
            UNPACK    XDATTIME,WTCHDATE,HOUR,MIN,SEC
            PACK      WTCHTIME,HOUR,COLON,MIN,COLON,SEC
            GOTO      WRCHJ200
.
          ENDIF
.
WRCHJ999  RETURN
.
.------------------------------------------------------------
. Write Field Change Audit for WL Removal      
.------------------------------------------------------------
WRCHK000  PACK      WTCHURNO,WMURNO,SP70
          PACK      WTCHPROC,WMCODE,SP70
          PACK      WTCHPCNT,WMCNT,SP70
.
          CALL      IBACLOCK
          PACK      WTCHDATE,CCC,CYY,CMM,CDD
          REPLACE   " 0",WTCHDATE
          CLOCK     TIME,WTCHTIME
.
          MOVE      "05",WTCHUPTY
          MOVE      WMREMOVE,WTCHREAS
          MOVE      USERID,WTCHUSID
          MOVE      SP70,WTCHOVAL
          PACK      WTCHCVAL,WMDATE4,WTTXRTIM,SP70
.
          MOVE      ZERO,ADDSECND
.
WRCHK200  PACK      KEY35,WTCHURNO,WTCHPROC,WTCHPCNT,WTCHDATE,WTCHTIME,SP70
          CALL      RAWTCHA1
          IF        OVRCD=1
            CALL      WRWTCHA1
          ELSE
            IF        ADDSECND<=5
              ADD       ONE,ADDSECND
            ELSE
              GOTO      WRCHK999
            ENDIF
.
            UNPACK    WTCHTIME,HOUR,D1,MIN,D1,SEC
            PACK      XDATTIME,WTCHDATE,HOUR,MIN,SEC,SP70
            CALL      ASEC0000                     * add 1 sec to date/time
                                                   * to stop duplicate key
            UNPACK    XDATTIME,WTCHDATE,HOUR,MIN,SEC
            PACK      WTCHTIME,HOUR,COLON,MIN,COLON,SEC
            GOTO      WRCHK200
.
          ENDIF
.
WRCHK999  RETURN
.
+
.*****************************************************************************
.*                                  FIXWLC00                                 *
.*                  Fix watmhdaf & watmtxaf - W/L header & comments          *
.*****************************************************************************
FIXWLC00  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      WATMHDA1,"watmhdaf"
          TRAPCLR   IO
          BRANCH    OVRCD,FIXWLC99
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      WATMTXA1,"watmtxaf"
          TRAPCLR   IO
          BRANCH    OVRCD,FIXWLC99
.
.         Fix the W/L header file first...
.
FIXWLC10  PACK      KEY28,OURNO,WMCODE,SAVWCNTD,ZERO,ZERO,ONE,SP70
          CALL      RSWTMHD1
          CALL      RKWTMHD1
          BRANCH    OVRCD,FIXWLC50
.
          MATCH     OURNO,WTMHURNO                * same U/R?
          GOTO      FIXWLC50 IF NOT EQUAL         * no - process the comments
. 
          MATCH     WMCODE,WTMHPROC
          GOTO      FIXWLC50 IF NOT EQUAL
.
          MATCH     SAVWCNTD,WTMHPCNT
          GOTO      FIXWLC50 IF NOT EQUAL
.
          MATCH     "001",WTMHTYPE
          GOTO      FIXWLC50 IF NOT EQUAL
.
.         A matching record has been found, so update the record with
.         the new U/R
.
          PACK      OLDKEY28,WTMHURNO,WTMHPROC,WTMHPCNT,WTMHTYPE,WTMHNOTE
.
.         See if new key already exists...
.
          PACK      KEY28,NEWURNUM,WTMHPROC,NEWCNT,WTMHTYPE,WTMHNOTE
          CALL      RAWTMHD1                      * duplicate key?
          COMPARE   OVRCD,ZERO
          GOTO      FIXWLC50 IF EQUAL             * yes - do comments
.
          PACK      KEY28,OLDKEY28                * re-read to get cursor
          CALL      RDWTMHD1
          BRANCH    OVRCD,FIXWLC10                * get next partial U/R match
.
          MOVE      NEWURNUM,WTMHURNO              * update the U/R
          MOVE      NEWCNT,WTMHPCNT
.
          CALL      UPWTMHD1                      * update record
          GOTO      FIXWLC10                      * get next record
.
.         Now for the W/L comments file...
.
FIXWLC50  PACK      KEY31,OURNO,WMCODE,SAVWCNTD,ZERO,ZERO,ONE,SP70
          CALL      RSWTMTX1
          CALL      RKWTMTX1
          BRANCH    OVRCD,FIXWLC90                * no such U/R
.
          MATCH     OURNO,WTMTURNO                * same U/R?
          GOTO      FIXWLC90 IF NOT EQUAL         * no - finish
.
          MATCH     WMCODE,WTMTPROC
          GOTO      FIXWLC90 IF NOT EQUAL
.
          MATCH     SAVWCNTD,WTMTPCNT
          GOTO      FIXWLC90 IF NOT EQUAL
.
          MATCH     "001",WTMTTYPE
          GOTO      FIXWLC90 IF NOT EQUAL
.
.         A matching record has been found, so update the record with
.         the new U/R
.
          PACK      OLDKEY31,WTMTURNO,WTMTPROC,WTMTPCNT,WTMTTYPE,WTMTNOTE:
                             WTMTUNIQ
.
.         See if new key already exists...
.
          PACK      KEY31,NEWURNUM,WTMTPROC,NEWCNT,WTMTTYPE,WTMTNOTE:
                          WTMTUNIQ
.
          CALL      RAWTMTX1                      * duplicate key?
          COMPARE   OVRCD,ZERO
          GOTO      FIXWLC90 IF EQUAL             * yes - bail
.
          PACK      KEY31,OLDKEY31
          CALL      RDWTMTX1
          BRANCH    OVRCD,FIXWLC50                * get next partial U/R match
.
          MOVE      NEWURNUM,WTMTURNO              * update the U/R
          MOVE      NEWCNT,WTMTPCNT
.
          CALL      UPWTMTX1                      * update record
          GOTO      FIXWLC50
.
FIXWLC90  
.
FIXWLC99  RETURN
.
.------------------------------------------------------------
. Update Field Change Audit for intended hospital
.------------------------------------------------------------
WRCHL000  PACK      WTCHURNO,WMURNO,SP70
          PACK      WTCHPROC,WMCODE,SP70
          PACK      WTCHPCNT,WMCNT,SP70
.
          CALL      IBACLOCK
          PACK      WTCHDATE,CCC,CYY,CMM,CDD
          REPLACE   " 0",WTCHDATE
          CLOCK     TIME,WTCHTIME
          MOVE      USERID,WTCHUSID
.
          MATCH     Z70,REASFC17                 * Reason for change
          GOTO      WRCHL999 IF EQUAL
.
          MATCH     SP70,REASFC17
          GOTO      WRCHL999 IF EQUAL
.
          MATCH     OLDVAL17,WTWMIHSP            * No change of intended
          GOTO      WRCHL999 IF EQUAL            * hospital
.
          PACK      WTCHUPTY,TEN7,SP70           * Integrity Audit Reason for
          MOVE      REASFC17,WTCHREAS            * change intended hospital
.
          PACK      WTCHOVAL,OLDVAL17,SP70
          PACK      WTCHCVAL,WTWMIHSP,SP70
.
          MOVE      ZERO,ADDSECND
.
WRCHL200  PACK      KEY35,WTCHURNO,WTCHPROC,WTCHPCNT,WTCHDATE,WTCHTIME,SP70
          CALL      RAWTCHA1
          IF        OVRCD=1
            CALL      WRWTCHA1
          ELSE
            IF        ADDSECND<=5
              ADD       ONE,ADDSECND
            ELSE
              GOTO      WRCHL999
            ENDIF
.
            UNPACK    WTCHTIME,HOUR,D1,MIN,D1,SEC
            PACK      XDATTIME,WTCHDATE,HOUR,MIN,SEC,SP70
            CALL      ASEC0000                     * add 1 sec to date/time
                                                   * to stop duplicate key
            UNPACK    XDATTIME,WTCHDATE,HOUR,MIN,SEC
            PACK      WTCHTIME,HOUR,COLON,MIN,COLON,SEC
            GOTO      WRCHL200
          ENDIF
.
WRCHL999  RETURN
.
.------------------------------------------------------------
. Update admission request status to processed and set 
. the visit number
.------------------------------------------------------------
AREQ0000  MATCH     SP70,ADMREQNO           * Exit if no admission request
          GOTO      AREQ9999 IF EQUAL
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSARQA1,"pmsarqaf"
          TRAPCLR   IO
          BRANCH    OVRCD,AREQ9999
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSAMNA1,"pmsamnaf"
          TRAPCLR   IO
          BRANCH    OVRCD,AREQ9999
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSARVA1,"pmsarvaf"
          TRAPCLR   IO
          BRANCH    OVRCD,AREQ9999
.
          PACK      KEY10,ADMREQNO,SP70
          CALL      RDPMARQ1
          BRANCH    OVRCD,AREQ9999
.
          MOVE      "4",PMARSTAT            // processed
          MOVE      WMBOOK,PMARVISN         // visit number
.
          CALL      UPPMARQ1
.
          PACK      KEY15,PMARREQN,SP70
          CALL      RSPMAMN1
AREQ1000  CALL      RKPMAMN1
          BRANCH    OVRCD,AREQ3000
.
          MATCH     PMARREQN,PMAMREQN
          GOTO      AREQ3000 IF NOT EQUAL
.
          MOVE      PMARVISN,PMAMVISN       // visit number
.
          CALL      UPPMAMN1
          GOTO      AREQ1000
.
AREQ3000  PACK      KEY16,PMARREQN,SP70
          CALL      RSPMARV1
AREQ4000  CALL      RKPMARV1
          BRANCH    OVRCD,AREQ9999
.
          MATCH     PMARREQN,PMAVREQN
          GOTO      AREQ9999 IF NOT EQUAL
.
          MOVE      PMARVISN,PMAVVISN       // visit number
.
          CALL      UPPMARV1
          GOTO      AREQ4000
.
AREQ9999  RETURN
.-----------------------------------------------------------
.        Get Patient Attributes
.-----------------------------------------------------------
PATATR00  MOVE      SP70,BMIINDIC
.
          COMPARE   ONE,NOATTRIB
          GOTO      PATATR90 IF EQUAL
.
          MATCH     SP70,URNUMBER
          GOTO      PATATR90 IF EQUAL
          GOTO      PATATR90 IF EOS
.
          PACK      KEY35,URNUMBER,WMBOOK,Z70
          CALL      RSPTATR2
PATATR10  CALL      RPPTATR2
          BRANCH    OVRCD,PATATR90
.
          MATCH     URNUMBER,PTARURNO
          GOTO      PATATR90 IF NOT EQUAL
.
          MOVE      WMBOOK,DIM8
          MATCH     DIM8,PTARVISN
          GOTO      PATATR90 IF NOT EQUAL
.
          MATCH     "1",PTARDELR
          GOTO      PATATR10 IF EQUAL
.
          MATCH     "001",PTARTYPE
          GOTO      PATATR10 IF NOT EQUAL
.
.         MATCH     WTTXCDTE,PTARCDTE
.         GOTO      PATATR10 IF NOT EQUAL
.
.         MATCH     WTTXCTIM,PTARCTME
.         GOTO      PATATR10 IF NOT EQUAL
.
          MOVE      "1",BMIINDIC
.
          GOTO      PATATR99
.
PATATR90  CALL      CLPATATR
PATATR99  RETURN
.
.-----------------------------------------------------------
.        Add Patient Attributes
.-----------------------------------------------------------
ADDATR00  COMPARE   ONE,NOATTRIB
          GOTO      ADDATR99 IF EQUAL
.
          MATCH     SP70,PTATR001
          GOTO      ADDATR99 IF EQUAL
          GOTO      ADDATR99 IF EOS
.
          MATCH     SP70,PTATR006
          GOTO      ADDATR99 IF EQUAL
          GOTO      ADDATR99 IF EOS
.
          MATCH     SP70,PTATR007
          GOTO      ADDATR99 IF EQUAL
          GOTO      ADDATR99 IF EOS
.
          PACK      KEY35,PTATR001,PTATR003,PTATR004,ZERO,ZERO,ONE,WMBOOK,SP70
          CALL      RDPTATR1
          COMPARE   ZERO,OVRCD
          GOTO      ADDATR99 IF EQUAL 
.
          CALL      CLPATATR
          CALL      MVPATATR
.
          CALL      CLCBMI00
          PACK      PTARVAL3,BODMASIN,SP70
.
          MOVE      WMBOOK,PTARVISN
.         MOVE      WTTXCDTE,PTARDATE
.         MOVE      WTTXCTIM,PTARTIME
          PACK      PTARTYPE,ZERO,ZERO,ONE,SP70
          MOVE      USERID,PTARCUSR
          MOVE      PTATR003,PTARCDTE
          MOVE      PTATR004,PTARCTME
.
          PACK      KEY35,PTATR001,PTATR003,PTATR004,ZERO,ZERO,ONE,WMBOOK,SP70
          CALL      WRPTATR1
.
ADDATR99  RETURN
+
.-----------------------------------------------------------
.        Update Patient Attributes
.-----------------------------------------------------------
UPDATR00  COMPARE   ONE,NOATTRIB
          GOTO      UPDATR99 IF EQUAL
.
          MATCH     SP70,PTATR001
          IF        @EQUAL
            MOVE      URNUMBER,PTATR001
          ENDIF
.
          CALL      IBACLOCK
.
          PACK      KEY35,PTATR001,PTATR003,PTATR004,ZERO,ZERO,ONE,PTATR002,SP70
          CALL      RDPTATR1
          IF        OVRCD=0
            MOVE      PTATR006,PTARVAL1
            MOVE      PTATR007,PTARVAL2
            CALL      CLCBMI00
            PACK      PTARVAL3,BODMASIN,SP70
            PACK      PTARUDTE,CCC,CYY,CMM,CDD
            REP       " 0",PTARUDTE
            CLOCK     TIME,PTARUTME
            MOVE      USERID,PTARUUSR
            CALL      UPPTATR1
          ELSE
            MATCH     SP70,PTATR006
            GOTO      UPDATR99 IF EQUAL
.
            MATCH     SP70,PTATR007
            GOTO      UPDATR99 IF EQUAL
.
            CALL      CLPATATR
            MOVE      PTATR006,PTARVAL1
            MOVE      PTATR007,PTARVAL2
            CALL      CLCBMI00
            PACK      PTARVAL3,BODMASIN,SP70
            MOVE      PTATR001,PTARURNO
            MOVE      WMBOOK,PTARVISN
            PACK      PTARCDTE,CCC,CYY,CMM,CDD
            REP       " 0",PTARCDTE
            MOVE      PTARCDTE,PTARDATE
            CLOCK     TIME,PTARCTME
            MOVE      PTARCTME,PTARTIME
            MOVE      USERID,PTARCUSR
            MOVE      "001",PTARTYPE
            MOVE      "0",PTARDELR
.
            PACK      KEY35,PTARURNO,PTARDATE,PTARTIME,ZERO,ZERO,ONE,PTARVISN,SP70
            CALL      RAPTATR1
            IF        OVRCD=1
              CALL      WRPTATR1
            ENDIF
          ENDIF
.
          PACK      KEY8,PTATR001,SP70
          CALL      RDPMPX21
          IF        OVRCD=0
            MOVE      PTATR006,PMPXPHEI
            MOVE      PTATR007,PMPXPWEI
            CALL      UPPMPX21
          ENDIF
.
          PACK      KEY8,PTATR002,SP70
          CALL      RDPMVX11
          IF        OVRCD=0
            MOVE      PTATR006,PMVXPHGT
            MOVE      PTATR007,PMVXPWGT
            CALL      IBACLOCK
            PACK      PMVXDHWR,CCC,CYY,CMM,CDD
            REP       " 0",PMVXDHWR
            CALL      UPPMVX11
          ENDIF
.
UPDATR99  RETURN
+
.-----------------------------------------------------------------
.        Add Patient Attributes with a new Booking Number (WMBOOK)
.-----------------------------------------------------------------
ADDAT100  MATCH     "1",WABMIIND
          GOTO      ADDAT199 IF NOT EQUAL
.
          PACK      KEY35,WMURNO,SAVWMBOK,Z70
          CALL      RAPTATR2
ADDAT120  CALL      RPPTATR2
          BRANCH    OVRCD,ADDAT199
.
          MATCH     WMURNO,PTARURNO
          GOTO      ADDAT199 IF NOT EQUAL
.
          MATCH     SAVWMBOK,PTARVISN
          GOTO      ADDAT199 IF NOT EQUAL
.
          PACK      KEY35,PTARURNO,WMBOOK,PTARDATE,PTARTIME,PTARTYPE,SP70
          CALL      RAPTATR2
          IF        OVRCD=1
            MOVE      WMBOOK,PTARVISN
            CALL      WRPTATR2
          ENDIF
.
ADDAT199  RETURN
.
+
.-----------------------------------------------------------------
. Write link to Allied Health Referral if Required
.-----------------------------------------------------------------
RLNK0000  MATCH     SP70,REFRLVIS           * Any referral to link
          GOTO      RLNK9999 IF EQUAL  
.
          PACK      ALWLURNO,WMURNO,SP70
          PACK      ALWLPCOD,WMCODE,SP70
          PACK      ALWLPCNT,WMCNT,SP70
          PACK      ALWLVISN,REFRLVIS,SP70
          MOVE      SP70,ALWLSPAR
.
          PACK      KEY19,ALWLURNO,ALWLPCOD,ALWLPCNT,SP70
          CALL      RAALWLN1
          IF        OVRCD=1
            CALL      WRALWLN1
          ELSE
            MATCH     "U",UPDTTYPE
            IF        @EQUAL
              CALL      UPALWLN1
            ENDIF
          ENDIF
.
RLNK9999  RETURN
.
.*******************************************************************************
.                        Write ACC Details
.*******************************************************************************
WRTACC00  MATCH     ANSN,PTCNLCLM
          GOTO      WRTACC99 IF NOT EQUAL
.
         MATCH      SP70,REFRLVIS
         GOTO       WRTACC99 IF EQUAL
         GOTO       WRTACC99 IF EOS
.
         PACK       KEY8,REFRLVIS,SP70
         CALL       RDWCOM1
         IF         OVRCD=ZERO
           PACK       KEY8,ADMISSNO,SP70
           CALL       RDAWCOM1
           IF         OVRCD=ONE
             MOVE       ADMISSNO,WCADMNO
             CALL       WRWCOM1
           ENDIF
         ENDIF
.
         PACK       KEY8,REFRLVIS,SP70
         CALL       RDPMWX11
         IF         OVRCD=ZERO
           PACK       KEY8,ADMISSNO,SP70
           CALL       RAPMWX11
           IF         OVRCD=ONE
             MOVE       ADMISSNO,PMWXVISN
             CALL       WRPMWX11
           ENDIF
         ENDIF
.
WRTACC99 RETURN
+
.******************************************************************************
.*                                  EPPP0000                                  *
.*  Update eReferral procedure code, count and visit number                   *
.******************************************************************************
EPPP0000  MATCH     "1",PTCNEPIS
          GOTO      EPPP9999 IF NOT EQUAL
.
          PACK      KEY38,URNUMBER,SP70
          CALL      RSCMERH3
EPPP1000  CALL      RKCMERH3
          BRANCH    OVRCD,EPPP9999
.
          MATCH     URNUMBER,CMRHURNO
          GOTO      EPPP9999 IF NOT EQUAL
.
          MATCH     OLDPROC,CMRHPCOD
          GOTO      EPPP1000 IF NOT EQUAL
.
          MOVE      ZERO,F2
          MOVE      CMRHPCNT,F2
          COMPARE   SAVWMCNT,F2
          GOTO      EPPP1000 IF NOT EQUAL
.
          MOVE      NEWPROCC,CMRHPCOD
          MOVE      NEWCNT,CMRHPCNT
          MOVE      WMBOOK,CMRHVISN
.
          CALL      UPCMERH3
.
EPPP9999  RETURN
+
.******************************************************************************
.*                                  ERVS0000                                  *
.*  Update eReferral visit number                                             *
.******************************************************************************
ERVS0000  MATCH     "1",PTCNEPIS
          GOTO      ERVS9999 IF NOT EQUAL
.
          PACK      KEY38,URNUMBER,SP70
          CALL      RSCMERH3
ERVS1000  CALL      RKCMERH3
          BRANCH    OVRCD,ERVS9999
.
          MATCH     URNUMBER,CMRHURNO
          GOTO      ERVS9999 IF NOT EQUAL
.
          MATCH     WMCODE,CMRHPCOD
          GOTO      ERVS1000 IF NOT EQUAL
.
          MOVE      WMCNT,D2
          MATCH     D2,CMRHPCNT
          GOTO      ERVS1000 IF NOT EQUAL
.
          MOVE      WMBOOK,CMRHVISN
.
          CALL      UPCMERH3
.
ERVS9999  RETURN
.
.------------------------------------------------------------
. Update Field Change Audit for change U/R
.------------------------------------------------------------
WRCHU000  PACK      WTCHURNO,WMURNO,SP70
          PACK      WTCHPROC,WMCODE,SP70
          PACK      WTCHPCNT,WMCNT,SP70
.
          CALL      IBACLOCK
          PACK      WTCHDATE,CCC,CYY,CMM,CDD
          REPLACE   " 0",WTCHDATE
          CLOCK     TIME,WTCHTIME
.
          MOVE     "26",WTCHUPTY
          PACK      WTCHREAS,SP70
          MOVE      USERID,WTCHUSID
          PACK      WTCHOVAL,OURNO,SP70
          PACK      WTCHCVAL,WMURNO,SP70
.
          PACK      KEY35,WTCHURNO,WTCHPROC,WTCHPCNT,WTCHDATE,WTCHTIME,SP70
          CALL      RDWTCHA1
          IF        OVRCD=1
            CALL      WRWTCHA1
          ENDIF
.
WRCHU999  RETURN
+
.------------------------------------------------------------
. Category Change History Table
.------------------------------------------------------------
PRTTAB00  PACK      KEY19,CASEKEYS,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,PRTTAB99
.
          PACK      KEY29,WMURNO,WMCODE,WMCNT,ANST,ANSP,SP20
          CALL      RSWTCAT2                * Position on & read code changes
PRTTAB10  CALL      RKWTCAT2                  file record
          BRANCH    OVRCD,PRTTAB99
.
          MATCH     WMURNO,WTCAURNO
          GOTO      PRTTAB99 IF NOT EQUAL   * Different U/R no
.
          MATCH     WMCODE,WTCAPROC
          GOTO      PRTTAB99 IF NOT EQUAL   * Different procedure code
.
          COMPARE   WMCNT,WTCAPCNT
          GOTO      PRTTAB99 IF NOT EQUAL   * Different procedure count
.
          MATCH     "TP",WTCACATF
          GOTO      PRTTAB99 IF NOT EQUAL   * Different category
.
          WRITE     HTMLFILE;"<tr><td>":
                             "<img src=#"../images/MaintenanceIcon.gif#"":
                             " class=ListIcon onclick='UpdateCategory(#"":
                             CASEKEYS,"#",#"",WTCAEDAT,"#");'>"
          MOVE      SP70,CMON
          UNPACK    WTCAEDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      ZERO,F2
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;"":
                    CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>";
.
          PACK      KEY10,WTCAWEBI,SP70
          CALL      RDWBSE1
          IF        OVRCD = 1
            MOVE      SP70,WBSENAM
          ENDIF
          WRITE     HTMLFILE;"<td>",WBSENAM,"&nbsp;</td>";
.
          MATCH     SP70,WTCACODF
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>Added &nbsp;</td>";
          ELSE
            WRITE     HTMLFILE;"<td>Priority &nbsp;</td>";
          ENDIF
.
          MATCH     SP70,WTCACODF
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp</td>";
            GOTO      PRTTAB20
          ENDIF
.
          PACK      KEY5,ANST,ANSP,WTCACODF,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            WRITE     HTMLFILE;"<td>",TDESC,"</td>";
          ENDIF
.
PRTTAB20  MATCH     SP70,WTCACODT
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp</td>";
            GOTO      PRTTAB30
          ENDIF
.
          PACK      KEY5,ANST,ANSP,WTCACODT,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            WRITE     HTMLFILE;"<td>",TDESC,"</td>";
          ENDIF
.
PRTTAB30  MOVE      SP70,CMON
          UNPACK    WTCAADTE,CCENT,CYEAR,CMON,CDAY
          MOVE      ZERO,F2
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;"<td>":
                    CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td></tr>"
.
          GOTO      PRTTAB10
.
PRTTAB99  RETURN
+
.-----------------------------------------------------------------------------
. CATHSS00 - Update watcataf priority record - NSW only
.-----------------------------------------------------------------------------
CATHSS00  MATCH     SP70,EFFCDATE
          GOTO      CATHSS99 IF EQUAL
.
          COMPARE   TWO,PTCNHDPS                 * NSW
          GOTO      CATHSS94 IF NOT EQUAL
.
          MOVE      WMDATE1,SAVVDAT1
          CALL      IBACLOCK
          PACK      SAVVDAT2,CCC,CYY,CMM,CDD
          REP       " 0",SAVVDAT2
          MOVE      ZERO,ERRORDAT
.
CATHSS05  MOVE      CASEKEYS,KEY19
          PACK      KEY29,KEY19,ANST,ANSP,EFFCDATE,SP70
          MOVE      KEY29,SAVKEY29
          CALL      RDWTCAT2
          BRANCH    OVRCD,CATHSS90
.
          CALL      RPWTCAT2
          BRANCH    OVRCD,CATHSS91
.
          MATCH     WMURNO,WTCAURNO
          GOTO      CATHSS91 IF NOT EQUAL
.
          MATCH     WMCODE,WTCAPROC
          GOTO      CATHSS91 IF NOT EQUAL
.
          MATCH     DWMCNT,DWTCAPCN
          GOTO      CATHSS91 IF NOT EQUAL
.
          UNPACK    WTCAEDAT,CCENT,CYEAR,CMON,CDAY,WTCHOVAL
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP:
                               OCT,NOV,DEC
          PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP70
.
          MOVE      WTCAEDAT,SAVVDAT1
.
          MATCH     NEWEFFDT,WTCAEDAT
          IF        !@LESS
            MOVE      ONE,ERRORDAT
          ENDIF
.
          PACK      KEY29,KEY19,ANST,ANSP,EFFCDATE,SP70
          CALL      RDWTCAT2
          BRANCH    OVRCD,CATHSS90
.
          CALL      RKWTCAT2
          BRANCH    OVRCD,CATHSS10
.
          MATCH     WMURNO,WTCAURNO
          GOTO      CATHSS10 IF NOT EQUAL
.
          MATCH     WMCODE,WTCAPROC
          GOTO      CATHSS10 IF NOT EQUAL
.
          MATCH     DWMCNT,DWTCAPCN
          GOTO      CATHSS10 IF NOT EQUAL
.
          MOVE      WTCAEDAT,SAVVDAT2
.
          MATCH     WTCAEDAT,NEWEFFDT
          IF        !@LESS
            MOVE      ONE,ERRORDAT
          ENDIF
.
CATHSS10  BRANCH    ERRORDAT,CATHSS92
.
          MATCH     EFFCDATE,NEWEFFDT
          IF        !@EQUAL
            PACK      KEY29,KEY19,ANST,ANSP,NEWEFFDT,SP70
            CALL      RAWTCAT2
            IF        OVRCD<>1
              GOTO      CATHSS93
            ENDIF
          ENDIF
.
          MOVE      SAVKEY29,KEY29
          CALL      RDWTCAT2
          BRANCH    OVRCD,CATHSS90
.
          MOVE      NEWEFFDT,WTCAEDAT
.
          MATCH     Z70,NEWPCODF
          IF        !@EQUAL
            MOVE      NEWPCODF,WTCACODF
          ENDIF
.
          MATCH     Z70,NEWPCODT
          IF        !@EQUAL
            MOVE      NEWPCODT,WTCACODT
          ENDIF
.
          CALL      UPWTCAT2
.
          PACK      WTCHURNO,WMURNO,SP70
          PACK      WTCHPROC,WMCODE,SP70
          PACK      WTCHPCNT,WMCNT,SP70
.
          CALL      IBACLOCK
          PACK      WTCHDATE,CCC,CYY,CMM,CDD
          REPLACE   " 0",WTCHDATE
          CLOCK     TIME,WTCHTIME
.
          PACK      WTCHUPTY,ZERO,TWO,SP70       * Clinical Urgency Update
          PACK      WTCHREAS,SP70
          MOVE      USERID,WTCHUSID
          PACK      WTCHOVAL,WTCACODF,SP70
          PACK      WTCHCVAL,WTCACODT,SP70
.
          PACK      KEY35,WTCHURNO,WTCHPROC,WTCHPCNT,WTCHDATE,WTCHTIME,SP70
          CALL      RDWTCHA1
          IF        OVRCD=1
            CALL      WRWTCHA1
          ENDIF
.
          GOTO      CATHSS99
.
CATHSS90  MOVE      "Category change record not found",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CATHSS99
.
CATHSS91  MOVE      "Cannot update first category change record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CATHSS99
.
CATHSS92  UNPACK    SAVVDAT1,CCENT,CYEAR,CMON,CDAY,WTCHOVAL
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP:
                               OCT,NOV,DEC
          PACK      DISPDAT2,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP70
.
          UNPACK    SAVVDAT2,CCENT,CYEAR,CMON,CDAY,WTCHOVAL
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP:
                               OCT,NOV,DEC
          PACK      DISPDAT2,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP70
.
          CLEAR     WEBTITLE
          APPEND    "Effective Date must be between ",WEBTITLE
          APPEND    DISPDAT1,WEBTITLE
          APPEND    " and ",WEBTITLE
          APPEND    DISPDAT2,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CATHSS99
.
CATHSS93  MOVE      "Record already exists for this date",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CATHSS99
.
CATHSS94  MOVE      "This functionality is only avialable for NSW.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CATHSS99
.
CATHSS99  RETURN
+
.-----------------------------------------------------------------------------
. CATHSD00 - Delete watcataf priority record - NSW only
.-----------------------------------------------------------------------------
CATHSD00  COMPARE   TWO,PTCNHDPS                 * NSW
          GOTO      CATHSD91 IF NOT EQUAL
.
CATHSD05  MOVE      CASEKEYS,KEY19
          PACK      KEY29,KEY19,ANST,ANSP,EFFCDATE,SP70
          CALL      RDWTCAT2
          BRANCH    OVRCD,CATHSD90
.
          CALL      DEWTCAT2
.
          PACK      WTCHURNO,WMURNO,SP70
          PACK      WTCHPROC,WMCODE,SP70
          PACK      WTCHPCNT,WMCNT,SP70
.
          CALL      IBACLOCK
          PACK      WTCHDATE,CCC,CYY,CMM,CDD
          REPLACE   " 0",WTCHDATE
          CLOCK     TIME,WTCHTIME
.
          PACK      WTCHUPTY,THREE,ONE,SP70      * Clinical Urgency Delete
          PACK      WTCHREAS,SP70
          MOVE      USERID,WTCHUSID
          PACK      WTCHOVAL,SP70
          PACK      WTCHCVAL,SP70
.
          PACK      KEY35,WTCHURNO,WTCHPROC,WTCHPCNT,WTCHDATE,WTCHTIME,SP70
          CALL      RDWTCHA1
          IF        OVRCD=1
            CALL      WRWTCHA1
          ENDIF
.
          GOTO      CATHSD99
.
CATHSD90  MOVE      "Category change record not found",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CATHSD99
.
CATHSD91  MOVE      "This functionality is only avialable for NSW.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CATHSD99
.
CATHSD99  RETURN
+
          INC       IBALPCCD
          INC       UPEADMVS                * Update visit number on eAdmission
          INC       VISCMTCD
          INC       PMSEXTTM
          INC       PATATRTM
.
          INC       ACCAUDIO/INC
          INC       ACCDIAIO/INC
          INC       ALLDIAIO/INC            * Allied Health Diagnosis Codes
          INC       ALLREFIO/INC
          INC       ALLWLNIO/INC
          INC       APSMASIO/INC
          INC       BOKCNFIO/INC
          INC       CASSTYIO/INC
          INC       CASAMEIO/INC
          INC       COMERHIO/INC
          INC       DISMASIO/INC
          INC       DISPATIO/INC
          INC       DISPTLIO/INC
          INC       EMRICDIO/INC
          INC       IBALPCIO/INC
          INC       OUTSITIO/INC
          INC       MLTHCPIO/INC
          INC       MRTMASIO/INC
          INC       PATCMCIO/INC
          INC       VISMDTIO/INC
          INC       VISMTXIO/INC
          INC       PATASFIO/INC
          INC       PATATRIO/INC
          INC       PATDADIO/INC
          INC       PATRE1IO/INC
          INC       PATDO1IO/INC
          INC       PATDGWIO/INC
          INC       PATEORIO/INC
.
          INC       PMSCCDIO/INC   * Concession Card Details
          INC       PMSARQIO/INC
          INC       PMSAMNIO/INC
          INC       PMSARVIO/INC
          INC       PMSEXTIO/INC
          INC       PMSHCPIO/INC
          INC       PMSTMDIO/INC
          INC       PMSHCGIO/INC
          INC       PATIN1IO/INC
          INC       PATHSPIO/INC
          INC       MLTSECIO/INC
          INC       PATMI1IO/INC
          INC       PATICOIO/INC
          INC       PATMA1IO/INC
          INC       PATMRGIO/INC
          INC       PMSPX2IO/INC
          INC       PATPR1IO/INC
          INC       PATVISIO/INC
          INC       PATWC1IO/INC
          INC       PMSWX1IO/INC
          INC       VISINTIO/INC
          INC       VISIAUIO/INC
          INC       PATWR1IO/INC
          INC       PATALRIO/INC
          INC       PMSUCHIO/INC
          INC       PMSUCDIO/INC
          INC       WATCATIO/INC
          INC       WATCHAIO/INC
          INC       WATEXTIO/INC
          INC       WATHISIO/INC
          INC       WATLETIO/INC
          INC       WATMHDIO/INC
          INC       WATMTXIO/INC
          INC       WATLHIIO/INC
          INC       WATSUSIO/INC
          INC       WATPROIO/INC
          INC       WATPHIIO/INC
          INC       WATMESIO/INC
          INC       WATVWLIO/INC
          INC       WATTR1IO/INC
          INC       WATESPIO/INC
          INC       WATESEIO/INC
          INC       WATESNIO/INC
          INC       WATRTDIO/INC
          INC       WATNBRIO/INC
          INC       WATESIIO/INC
          INC       WATESTIO/INC
          INC       WATESITM     
          INC       CLWATESI
          INC       CLWATOPA
          INC       CLOPRSRG
          INC       CLOPRDEA
          INC       BOKRC1IO/INC
          INC       BOKDIAIO/INC
          INC       PATFN1IO/INC
          INC       WATEPSIO/INC
          INC       WATEXAIO/INC
          INC       WATEXBIO/INC
          INC       WATEXCIO/INC
          INC       WATEXDIO/INC
          INC       OPRDEAIO/INC
          INC       BOKUNQIO/INC
          INC       WATPACIO/INC
. 
          INC       BOKRX1IO/INC
          INC       WATTX1IO/INC
          INC       PATDSCIO/INC
          INC       OPREXPIO/INC
          INC       OPRMBSIO/INC
          INC       OPRNURIO/INC
          INC       OPRSESIO/INC            * HPS Code
          INC       OPRDPHIO/INC            * HPS Code
          INC       OPROPRIO/INC            * HPS Code
          INC       OPRPRFIO/INC            * HPS Code
          INC       OPRSRGIO/INC            * HPS Code
          INC       OPRDEDIO/INC            * HPS Code
          INC       PATITMIO/INC            * HPS Code
          INC       PMSAIDIO/INC
          INC       PMSCEXIO/INC
          INC       PMSOOSIO/INC
          INC       PMSVX1IO/INC
          INC       VISCMTIO/INC
          INC       PATCLMTM
          INC       PATDOCTM
          INC       PATMASTM
          INC       PMSHCPTM
          INC       PMSHCGTM
          INC       CLACCAUD                    * Clear ACC Audit file variables
          INC       CLPATATR
          INC       CLPMSPX2
          INC       CLWATTX1
          INC       CLVISINT
          INC       CLVISIAU
          INC       PMSPX2TM
          INC       PATMSXTM
          INC       GENBOKNO
          INC       WLHISSUB
          INC       WATTRETM
          INC       WRWATNBR
          INC       NAMSTRCD
          INC       CALCAGE 
          INC       DAYOFWEK
          INC       IBAWEBCD    
          INC       WEBDATCD
          INC       RSHWEBCD
          INC       PATDOCCD
          INC       WATLPCCD
.
          INC       DGCLICCB                * DG API Cancel Booking    *I-90203
          INC       DGCLICUB                * DG API Pre-Adm (Booking) *I-90203
          INC       DGCLICWA                * DG API Put On Waitn List *I-90203
          INC       DGCLICWC                * DG API Cancel Waitn List *I-90203
          INC       DGCLICUP                * DG API Cancel Waitn List *I-90203
          INC       DGCLICUR                * HL7 W/L Change UR
          INC       DGCLIS14
          INC       DGCLIWLB                * HL7 W/L Booking
          INC       DGCLIWLU                * HL7 W/L Booking Update
          INC       DGCLIWLD                * HL7 W/L Cancel Booking
.
          INC       DGCLIAWL                * HL7 Add W/L Entry
          INC       DGCLIUWL                * HL7 Update W/L Entry
          INC       DGCLIRWL                * HL7 Remove W/L Entry
          INC       DGCLICOB                * DG O/P Change Booking Details
.
          INC       BOKRECTM
          INC       BOKRX1TM
          INC       BOKCNFTM
          INC       CALCBMIN
          INC       CLALLREF
          INC       CLPATDOC
          INC       CLPMSCEX
          INC       CLPMSWX1
          INC       CLWATMHD
          INC       WATTX1TM
          INC       PATNAMCD
          INC       PMIGTNID
          INC       OPRCASTM                * HPS Code
          INC       CLPATMIS    
          INC       PATMISTM
          INC       PMSCEXCD
          INC       CLNHIMAS
          INC       CLBOKRX1
          INC       PATNIDIO/INC
          INC       PATVADIO/INC
          INC       NHIMASIO/INC
          INC       NHIETHIO/INC
          INC       PMSDUNIO/INC
          INC       WATPNPIO/INC
          INC       WATLPCIO/INC
          INC       WATHISTM
          INC       WATOPAIO/INC
          INC       WATOPSIO/INC
          INC       PATVADCK
          INC       TFILENAM
          INC       UPEREFVS
.
          INC       PMSCTCIO/INC
          INC       PATWMAIO/INC
          INC       PATWVEIO/INC
          INC       ACCLODIO/INC
.
          INC       CHKWCCLM
          INC       GENANVIS
