.******************************************************************************
.* System    :   Datagate                                                     *
.* Program   :   DGSRVFWD.PBL                                                 *
.* Desc      :   Broadcast Message Forwarding Server                          *
.******************************************************************************
.* Date      :   04/10/2001                                                   *
.* Author    :   Davin Sloan / Steve Armstrong                                *
.* Function  :   This program will send messages from IBA data holding files  *
.*               to Datagate.                                                 *
.*               (based on DGSRVINB)                                          *
.* Mods      :                                                                *
.******************************************************************************
.*  V11.04.01    01/07/2024  Davin            TSK 0948725                     *
.*               Added OPEN PMSQPXA1 index                                    *
.******************************************************************************
.* V11.02.01  09/02/2022  Thanh T       TSK 0905641                           *
.*            Recompiled as OUTMA1FD/WATTR1FD changes                         *
.******************************************************************************
.*       V10.15.01 13/11/2019  Davin            TSK 0861253                   *
.*                 Added OUTTHIFD for O/P telehealth fields                   *
.******************************************************************************
.*       V10.10.01 21/03/2017  Steve Armstrong  TSK 0832066                   *
.*                 Mods to only use Concession Card file for DVA data         *
.*                 instead of PREPAT and PMPXDVAC.                            *
.******************************************************************************
.*       V10.08.01 02/05/2016  Ebon Clements     TSK 0268970                  *
.*                 Change to use OUTCLIFD index 1 instead of index 2          *
.*       V10.06.02 25/06/2015  Steve Armstrong   CAR 318558                   *
.*                 Recompiled for changes to BOKQUEFD & BOKQUEIO              *
.*       V10.06.01 12/03/2015  Steve Armstrong   CAR 314108                   *
.*                 Removed definition of PTCGDATE as PATCGPFD is no longer    *
.*                 in use                                                     *
.******************************************************************************
.*       V10.03.01 18/05/2013  Steve Armstrong   CAR 268961                   *
.*                 Recompiled for changes to PMSQVIFD                         *
.******************************************************************************
.*       V10.02.01 21/09/2011  Steve Armstrong   CAR 251515                   *
.*                 Recompiled for changes to WATQUEFD.                        *
.******************************************************************************
.*       V10.00.02 02/07/2010  Davin            CAR 225293                    *
.*                 Changed CEA & CED messages to use alrevisn not alenvisn    *
.*       V10.00.01 11/03/2010  Steve Armstrong  CAR 135505                    *
.*                 Mods for CEA & CED messages now that they are written      *
.*                 directly to hl7inbaf/allqueaf/pmsqptaf instead of to       *
.*                 hl7bmtaf where they were previously processed by DGSRVSTR. *
.******************************************************************************
.*       V9.08.01  31/01/2007  Peter Vela     CAR 127930                      *
.*                 Recompiled for MRTMASFD                                    *
.*       V9.05.B02 03/03/2006  Steve Armstrong  CAR  88829                    *
.*                 Recompiled for changes to OUTQUEFD                         *
.*       V9.05.B01 30/01/2006  Peter Vela       CAR 54614                     *
.*                 Added PATRE1FD variables                                   *
.******************************************************************************
.*        V9.04.01 22/09/2004  Steve Armstrong  CAR 53573                     *
.*                 Mods for O/P messages to use parameter (OTCNDGCL) to       *
.*                 determine if always sending clinic id.                     *
.******************************************************************************
.*        V9.03.05 04/08/2004  Steve Armstrong  CAR 34707 & 48877             *
.*                 Added CHA and CHD messages for Health Concession Card      *
.*        V9.03.04 27/05/2004  Steve Armstrong  CAR 48778                     *
.*                 Added CCP message (Change Pre-Admission)                   *
.*        V9.03.03 10/02/2003  Ebon Clements    CAR 47349                     *
.*                 Changed ALERNDIM to ALERNDIG                               *
.*        V9.03.02 22/12/2003  Steve Armstrong  CAR 45916                     *
.*                 Added OTBBCIND to CON, COB and COA messages                *
.*        V9.03.01 21/08/2003  Steve Armstrong  CAR 37356                     *
.*                 Mods to include additional fields from ALLERCFD & ALLAEFFD *
.*                 in CEA broadcast message                                   *
.******************************************************************************
.*        V9.02.09 17/02/2003  Davin  CAR 19525                               *
.*                 Changed CEA message to send referral details from allrefaf *
.*        V9.02.08 10/02/2003  Davin  CAR 33610                               *
.*                 Changed CON message to send clinic type description (added *
.*                 GCTD0000) and location type/description (added GLTD0000)   *
.*        V9.02.07 17/04/2002  Steve Armstrong                                *
.*                 Mods to include the Medicare reference number appended to  *
.*                 the medicare Number.                                       *
.*        V9.02.06 13/03/2002  Davin                                          *
.*                 Added descriptions to coded fields for att.doct, ref.doct, *
.*                 srce.refl, adm.class and presenting complaint (CEC/CCE)    *
.*        V9.02.05 07/03/2002  Steve Armstrong                                *
.*                 Mods to use pmshcpaf instead of patdo1af for attending     *
.*                 doctor in CAE, CEC and CCE messages                        *
.*        V9.02.04 07/01/2002  Davin                                          *
.*                 Add logic for CAE, CEC and CCE messages to be read from    *
.*                 'emrqueaf'.                                                *
.*                 Display 'sent' counters after sending the message          *
.*        V9.02.03 13/12/2001  Mike Laming                                    *
.*                 Add logic for CRM, CEA and CED messages to be read from    *
.*                 'mrtqueaf' and 'allqueaf'.                                 *
.*        V9.02.02 12/12/2001  Steve Armstrong                                *
.*                 Added close of DGATE if e-Gate connection is lost          *
.*        V9.02.01 12/12/2001  Steve Armstrong                                *
.*                 Mods for check of EOS flag after write to e-Gate           *
.******************************************************************************
.
          INC       STD002FD
.
          INC       ALLQUEFD/INC                                       *I-90203
          INC       ALLAEFFD/INC
          INC       ALLERCFD/INC
          INC       ALLENCFD/INC                                       *I-90203
          INC       ALLREFFD/INC                                       *I-90203
          INC       BOKRC1FD/INC
          INC       BOKRX1FD/INC
          INC       BOKQUEFD/INC
          INC       EMRQUEFD/INC
          INC       EMRVISFD/INC
          INC       HL7INBFD/INC
          INC       MRTHISFD/INC
          INC       MRTMASFD/INC
          INC       MRTQUEFD/INC                                       *I-90203
          INC       NHIMASFD/INC
          INC       OUTBOAFD/INC
          INC       OUTBB1FD/INC
          INC       OUTCANFD/INC
          INC       OUTCONFD/INC
          INC       OUTCLIFD/INC
          INC       OUTCTYFD/INC
          INC       OUTMA1FD/INC
          INC       OUTQUEFD/INC
          INC       OUTRSHFD/INC
          INC       OUTSITFD/INC
          INC       OUTTHIFD/INC
          INC       PATCODFD/INC
          INC       PATCONFD/INC
          INC       PATDO1FD/INC
          INC       PATDSCFD/INC
          INC       PATFN1FD/INC
          INC       PATMA1FD/INC
          INC       PATMI1FD/INC
          INC       PATNIDFD/INC
          INC       PATONLFD/INC
          INC       PATRE1FD/INC
          INC       PATTRNFD/INC
          INC       PATWR1FD/INC
          INC       PMSBRQFD/INC
          INC       PMSCCDFD/INC
          INC       PMSHCPFD/INC
          INC       PMSPX2FD/INC
          INC       PMSQCCFD/INC
          INC       PMSQPTFD/INC
          INC       PMSQVIFD/INC
          INC       PMSVX1FD/INC
          INC       WATQUEFD/INC
          INC       WATTR1FD/INC
          INC       WATTX1FD/INC
.
.
. LOCAL VARIABLES
. ---------------
AHFUNDD   DIM       47
AHFTABD   DIM       49
ADMCLSS   DIM       24
ADMNCODE  DIM       3
ADMNDESC  DIM       24
ADMTYPE   DIM       24
ATTDCODE  DIM       6
ATTDDESC  DIM       65
ATTDOCT   DIM       65
.
CACFAIL   FORM      8
CACSENT   FORM      8
CADFAIL   FORM      8
CADSENT   FORM      8
CAEFAIL   FORM      8
CAESENT   FORM      8
CARDTYPE  DIM       24
CATEGORY  DIM       2
CATFAIL   FORM      8
CATSENT   FORM      8
CCAFAIL   FORM      8
CCASENT   FORM      8
CCBFAIL   FORM      8
CCBSENT   FORM      8
CCDFAIL   FORM      8
CCDSENT   FORM      8
CCEFAIL   FORM      8
CCESENT   FORM      8
CCPFAIL   FORM      8
CCPSENT   FORM      8
CCTFAIL   FORM      8
CCTSENT   FORM      8
CDCFAIL   FORM      8
CDCSENT   FORM      8
CECFAIL   FORM      8
CECSENT   FORM      8
COBFAIL   FORM      8
COBSENT   FORM      8
CDNFAIL   FORM      8
CDNSENT   FORM      8
CDSFAIL   FORM      8
CDSSENT   FORM      8
CEAFAIL   FORM      8
CEASENT   FORM      8
CEDFAIL   FORM      8
CEDSENT   FORM      8
CHAFAIL   FORM      8
CHASENT   FORM      8
CHDFAIL   FORM      8
CHDSENT   FORM      8
CINDDESC  DIM       24
CLASCODE  DIM       3
CLASDESC  DIM       24
CLINCODE  DIM       6
CLINDATE  DIM       8
CLINDESC  DIM       65
CLINSITE  DIM       6
CLIUNIT   DIM       24
CMRFAIL   FORM      8
CMRSENT   FORM      8
CMWFAIL   FORM      8
CMWSENT   FORM      8
CPEFAIL   FORM      8
CPESENT   FORM      8
COAFAIL   FORM      8
COASENT   FORM      8
COCFAIL   FORM      8
COCSENT   FORM      8
CODFAIL   FORM      8
CODSENT   FORM      8
CONFAIL   FORM      8
CONSCODE  DIM       6
CONSDESC  DIM       65
CONSENT   FORM      8
CONSULT   DIM       65
CORFAIL   FORM      8
CORSENT   FORM      8
CPAFAIL   FORM      8
CPASENT   FORM      8
CPOFAIL   FORM      8
CPOSENT   FORM      8
CPRFAIL   FORM      8
CPRSENT   FORM      8
CRGFAIL   FORM      8
CRGSENT   FORM      8
CRMFAIL   FORM      8
CRMSENT   FORM      8
CTRFAIL   FORM      8
CTRSENT   FORM      8
CTYPDESC  DIM       37
CTYPSITE  DIM       6
CTYPTYPE  DIM       6
CUAFAIL   FORM      8
CUASENT   FORM      8
CUBFAIL   FORM      8
CUBSENT   FORM      8
CUPFAIL   FORM      8
CUPSENT   FORM      8
CWAFAIL   FORM      8
CWASENT   FORM      8
CWCFAIL   FORM      8
CWCSENT   FORM      8
.
DATETIME  DIM       14
DIM8      DIM       8
DVADIM10  DIM       10
DVACCODE  DIM       3
.
FATCONT   DIM       24
FULLMEDI  DIM       12
FUNDDESC  DIM       47
FUNDCODE  DIM       6
.
HOURTM    DIM       2
.
LADMCLSS  DIM       24
LADOCT    DIM       6
LALLW     DIM       9
LATYPE    DIM       3
LBED      DIM       3
LCHSTAT   DIM       3
LCLIUNIT  DIM       24
LCONSULT  DIM       65
LDEPT     DIM       3
LDISC     DIM       9
LEXTRA    DIM       9
LOCDOCT   DIM       93
LOCNTYPE  DIM       3
LTYPDESC  DIM       24
LPATWLOC  DIM       34
LRATEF    DIM       9
LRATEG    DIM       9
LRATEH    DIM       9
LRBEND    DIM       3
LRBTYP    DIM       3
LTTRLTYP  DIM       3
LTTREPNO  DIM       2
LWARD     DIM       3
.
MESSTYPE  DIM       3
MHLRCODE  DIM       3
MINTIME   DIM       2
MUMCONT   DIM       24
.
OPCLDSC   DIM       65
OPCTDSC   DIM       37
OPLTDSC   DIM       24
OPOCDSC   DIM       65
OPOSDSC   DIM       37
OPSTDSC   DIM       37
.
PATCONT   DIM       24
PATLANG   DIM       24
PATWLOC   DIM       34
PHFUNDD   DIM       47
PHFTABD   DIM       49
PREFINT   DIM       24
PRESCODE  DIM       3
PRESCOM   DIM       24
PRESDESC  DIM       24
.
REFDCODE  DIM       10
REFDDESC  DIM       93
REFDOCT   DIM       93
RELIGON   DIM       24
.
SAVTXWRD  DIM       3
SECTIME   DIM       2
SITECODE  DIM       6
SITEDESC  DIM       37
SRCECODE  DIM       3
SRCEDESC  DIM       24
SRCREFL   DIM       24
.
TABLDESC  DIM       49
TABLCODE  DIM       8
.
UNITCODE  DIM       3
UNITDESC  DIM       24
.
WARDCODE  DIM       3
WARDDESC  DIM       34
.
.
. PROGRAM CONSTANTS
. -----------------
CARET     INIT      "^"
CATel     INIT      "el"
CATct     INIT      "ct"
DGATE     DFILE                                   * datagate file
TILDA20   INIT      "~~~~~~~~~~~~~~~~~~~~"
ZERO4     INIT      "0000    "
.
.
PRGID     INIT      "DGSRVFWD"
PRGNAM    INIT      "Broadcast Message Forwarding Server"
VERSION   INIT      "V12.00.00"
+
.******************************************************************************
.*                                   ML0000                                   *
.*                       Controlling Logic (Mainline code)                    *
.******************************************************************************
.
ML0000    CALL      SETX0000                * Setup common variables
          CALL      INIT0000                * Initialise variables & open files
.
          CALL      BACK0000                * Display background screen
          CALL      RDIN0000                * Read HL7 inbound file
          CLOSE     DGATE
.
ML9999    STOP
+
.******************************************************************************
.*                                  INIT0000                                  *
.*                      Initialise Variables & Open Files                     *
.******************************************************************************
.
INIT0000  CALL      DISPHEAD                * Display screen heading
.
          DISPLAY   *P56:24,"Opening controlf";
          OPEN      CONTROLF,"controlf"
.
          DISPLAY   *P64:24,"allqueaf";                                *I-90203
          OPEN      ALLQUEA1,"allqueaf"                                *I-90203
.
          DISPLAY   *P64:24,"allaefaf";
          OPEN      ALLAEFA1,"allaefaf"
.
          DISPLAY   *P64:24,"allercaf";
          OPEN      ALLERCA2,"allercaf"
.
          DISPLAY   *P64:24,"bokqueaf";
          OPEN      BOKQUEA1,"bokqueaf"
.
          DISPLAY   *P64:24,"emrqueaf";
          OPEN      EMRQUEA1,"emrqueaf"
.
          DISPLAY   *P64:24,"hl7inbaf";
          OPEN      HL7INB01,"hl7inbaf"
          OPEN      HL7INB02,"hl7inbaf"
.
          DISPLAY   *P64:24,"mrtqueaf";                                *I-90203
          OPEN      MRTQUEA1,"mrtqueaf"                                *I-90203
.
          DISPLAY   *P64:24,"outqueaf";
          OPEN      OUTQUEA1,"outqueaf"
.
          DISPLAY   *P64:24,"outsitaf";
          OPEN      OUTSITA1,"outsitaf"
.
          DISPLAY   *P64:24,"patcodes";
          OPEN      PATCODE1,"patcodes"
.
          DISPLAY   *P64:24,"patdo1af";
          OPEN      PATDO1A1,"patdo1af"
.
          DISPLAY   *P64:24,"patfn1af";
          OPEN      PATFN1A1,"patfn1af"
.
          DISPLAY   *P64:24,"patwr1af";
          OPEN      PATWR1A1,"patwr1af"
.
          DISPLAY   *P64:24,"pmsccdaf";
          OPEN      PMSCCDA1,"pmsccdaf"
.
          DISPLAY   *P64:24,"pmshcpaf";
          OPEN      PMSHCPA1,"pmshcpaf"
.
          DISPLAY   *P64:24,"pmsqccaf";
          OPEN      PMSQCCA1,"pmsqccaf"
.
          DISPLAY   *P64:24,"pmsqptaf";
          OPEN      PMSQPTA1,"pmsqptaf"
          OPEN      PMSQPXA1,"pmsqpxaf"
.
          DISPLAY   *P64:24,"pmsqviaf";
          OPEN      PMSQVIA1,"pmsqviaf"
.
          DISPLAY   *P64:24,"watqueaf";
          OPEN      WATQUEA1,"watqueaf"
.
          READ      CONTROLF,THIRTY1;*250,OTCNDGCL
          READ      CONTROLF,SEVENTY9;*179,PTCNDGPB
.
INIT9999  RETURN
+
.******************************************************************************
.*                                  BACK0000              Called by: ML0000   *
.*                          Display Background Screen                         *
.******************************************************************************
.
BACK0000  DISPLAY   *P1:4,*EF
          BOX       16,1,2,80,24
          HLINE     *G33,5,1,1
          HLINE     *G37,5,2,79
          HLINE     *G34,5,80,80
          HLINE     *G21,5,28,28
          HLINE     *G21,5,53,53
          HLINE     *G30,24,28,28
          HLINE     *G30,24,53,53
          VLINE     *G39,28,6,23
          VLINE     *G39,53,6,23
          DISPLAY   *P30:3,*HON,*V2LON," MESSAGE STATISTICS ";
.
          CALL      IBACLOCK
          PACK      KEY8,CCC,CYY,CMM,CDD
          UNPACK    KEY8,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          REP       " 0",CPCDATE
          CLOCK     TIME,CTIMEIS
.
          DISPLAY   *P4:4,"Activated on ",*V2LON,CPCDATE,*HOFF:
                    "  @  ",*V2LON,CTIMEIS,*HOFF:
                    *P41:4,"Current status... ",*V2LON,*HON,"Waiting";
.
          DISPLAY   *P2:6,*V2LON,*ULON,"Type ":
                    *P8:6,"  Sent  ",*P18:6," Failed ":
                    *P29:6,*V2LON,*ULON,"Type ":
                    *P35:6,"  Sent  ",*P44:6," Failed ":
                    *P54:6,*V2LON,*ULON,"Type ":
                    *P60:6,"  Sent  ",*P69:6," Failed "
.
          DISPLAY   *P3:7,"CRG":
                    *P3:8,"CUP":
                    *P3:9,"CUA":
                    *P3:10,"CMR":
                    *P3:11,"CHA":
                    *P3:12,"CHD":
                    *P3:13,"CAT    Not Available":
                    *P3:14,"CMW    Not Available":
                    *P3:15,"CDN    Not Available":
                    *P3:16,"CPE":
                    *P3:17,"CCP":
                    *P3:18,"CPA":
                    *P3:19,"CAD":
                    *P3:20,"CAC":
                    *P3:21,"CCA":
                    *P3:22,"CTR":
                    *P3:23,"CCT":
                    *P30:7,"CPO":
                    *P30:8,"CPR":
                    *P30:9,"CDS":
                    *P30:10,"CDC":
                    *P30:11,"CCD":
                    *P30:12,"CON":
                    *P30:13,"COB":
                    *P30:14,"COR":
                    *P30:15,"COC":
                    *P30:16,"COD":
                    *P30:17,"COA":
                    *P30:18,"CUB":
                    *P30:19,"CCB":
                    *P30:20,"CWA":
                    *P30:21,"CWC":
                    *P30:22,"CRM":
                    *P30:23,"CEA":
                    *P55:7,"CED":
                    *P55:8,"CAE":
                    *P55:9,"CEC":
                    *P55:10,"CCE";
.
.         Initialise counters
.
          MOVE      ONE,FORM2
          REPEAT
            STORE     ZERO,FORM2,CUASENT,CMRSENT,CUPSENT,CADSENT,CACSENT:
                                 CCASENT,CDSSENT,CDCSENT,CCDSENT,CTRSENT:
                                 CCTSENT,CRGSENT,CPESENT,COBSENT,CAESENT:
                                 CCESENT,CONSENT,CORSENT,COCSENT,CODSENT:
                                 COASENT,CUBSENT,CCBSENT,CPOSENT,CPRSENT:
                                 CPASENT,CWASENT,CWCSENT,CRMSENT,CEASENT:
                                 CEDSENT,CECSENT,CCPSENT,CHASENT,CHDSENT:
                                 CATSENT,CMWSENT,CDNSENT,CUAFAIL,CMRFAIL:
                                 CUPFAIL,CADFAIL,CACFAIL,CCAFAIL,CDSFAIL:
                                 CDCFAIL,CCDFAIL,CTRFAIL,CCTFAIL,CRGFAIL:
                                 CPEFAIL,COBFAIL,CAEFAIL,CCEFAIL,CONFAIL:
                                 CORFAIL,COCFAIL,CODFAIL,COAFAIL,CUBFAIL:
                                 CCBFAIL,CPOFAIL,CPRFAIL,CPAFAIL,CWAFAIL:
                                 CWCFAIL,CRMFAIL,CEAFAIL,CEDFAIL,CECFAIL:
                                 CCPFAIL,CHAFAIL,CHDFAIL,CATFAIL,CMWFAIL:
                                 CDNFAIL
            ADD       ONE,FORM2
          UNTIL     FORM2>76
.
BACK9999  RETURN
+
.******************************************************************************
.*                                  RDIN0000                                  *
.*                       Read Inbound Holding Header File                     *
.******************************************************************************
.
RDIN0000  CALL      CONN0000                     * connect to e-Gate
          IF        EXIT = 1
            DISPLAY   *P59:4,*W5;
            GOTO      RDIN0000
          ENDIF
.
RDIN0500  PACK      KEY37,ANST,SP70
          CALL      RSH7INB2                     * position at start of file
RDIN1000  CALL      RKH7INB2                     * read next record
          IF        OVRCD = 1
            DISPLAY   *P59:4,*W2;                * eof
            GOTO      RDIN0500
          ENDIF
.
          DISPLAY   *P59:4,*V2LON,*HON,"Processing":
                    *HOFF,*V2LON," (",H7INMETP,")"
.
          MATCH     "CUA",H7INMETP               * alias update ?
          IF        @EQUAL
            CALL      CUAM0000                   * yes
            GOTO      RDIN9000
          ENDIF
.
          MATCH     "CMR",H7INMETP               * merge U/R numbers ?
          IF        @EQUAL   
            CALL      CMRM0000                   * yes
            GOTO      RDIN9000                            
          ENDIF   
.
          MATCH     "CUP",H7INMETP               * update PMI details ?
          IF        @EQUAL    
            CALL      CUPM0000                   * yes
            GOTO      RDIN9000
          ENDIF                                       
.                                                        
          MATCH     "CPE",H7INMETP               * preadmission ?
          IF        @EQUAL   
            CALL      CPEM0000                   * yes
            GOTO      RDIN9000
          ENDIF
.
          MATCH     "CAD",H7INMETP               * admission ?
          IF        @EQUAL   
            CALL      CADM0000                   * yes
            GOTO      RDIN9000
          ENDIF
.
          MATCH     "CAC",H7INMETP               * change admission ?
          IF        @EQUAL
            CALL      CACM0000                   * yes
            GOTO      RDIN9000
          ENDIF
.
          MATCH     "CCA",H7INMETP               * cancel admission ?
          IF        @EQUAL
            CALL      CCAM0000                   * yes
            GOTO      RDIN9000
          ENDIF
.
          MATCH     "CDS",H7INMETP               * discharge ?
          IF        @EQUAL
            CALL      CDSM0000                   * yes
            GOTO      RDIN9000
          ENDIF
.
          MATCH     "CDC",H7INMETP               * change discharge ?
          IF        @EQUAL
            CALL      CDCM0000                   * yes
            GOTO      RDIN9000
          ENDIF
.
          MATCH     "CCD",H7INMETP               * cancel discharge ?
          IF        @EQUAL
            CALL      CCDM0000                   * yes
            GOTO      RDIN9000
          ENDIF
.
          MATCH     "CTR",H7INMETP               * transfer ?
          IF        @EQUAL
            CALL      CTRM0000                   * yes
            GOTO      RDIN9000
          ENDIF
.
          MATCH     "CCT",H7INMETP               * cancel transfer ?
          IF        @EQUAL
            CALL      CCTM0000                   * yes
            GOTO      RDIN9000
          ENDIF
.
          MATCH     "CRG",H7INMETP               * Patient Register ?
          IF        @EQUAL
            CALL      CRGM0000                   * yes
            GOTO      RDIN9000
          ENDIF
.
          MATCH     "CON",H7INMETP               * New O/P Appointment ?
          IF        @EQUAL
            CALL      CONM0000                   * yes
            GOTO      RDIN9000
          ENDIF
.
          MATCH     "COB",H7INMETP               * Change O/P Appointment ?
          IF        @EQUAL
            CALL      COBM0000                   * yes
            GOTO      RDIN9000
          ENDIF
.
          MATCH     "COR",H7INMETP               * Reschedule O/P Appointment ?
          IF        @EQUAL
            CALL      CORM0000                   * yes
            GOTO      RDIN9000
          ENDIF
.
          MATCH     "COC",H7INMETP               * Cancel O/P Appointment ?
          IF        @EQUAL
            CALL      COCM0000                   * yes
            GOTO      RDIN9000
          ENDIF
.
          MATCH     "COD",H7INMETP               * O/P Appointment DNA ?
          IF        @EQUAL
            CALL      CODM0000                   * yes
            GOTO      RDIN9000
          ENDIF
.
          MATCH     "COA",H7INMETP               * Confirm O/P Appointment ?
          IF        @EQUAL
            CALL      COAM0000                   * yes
            GOTO      RDIN9000
          ENDIF
.
          MATCH     "CUB",H7INMETP               * Booking ?
          IF        @EQUAL
            CALL      CUBM0000                   * yes
            GOTO      RDIN9000
          ENDIF
.
          MATCH     "CCB",H7INMETP               * Cancel Booking ?
          IF        @EQUAL
            CALL      CCBM0000                   * yes
            GOTO      RDIN9000
          ENDIF
.
          MATCH     "CPO",H7INMETP               * Patient On-Leave ?
          IF        @EQUAL
            CALL      CPOM0000                   * yes
            GOTO      RDIN9000
          ENDIF
.
          MATCH     "CPR",H7INMETP               * Return from Leave ?
          IF        @EQUAL
            CALL      CPRM0000                   * yes
            GOTO      RDIN9000
          ENDIF
.
          MATCH     "CPA",H7INMETP               * Cancel Pre-admission ?
          IF        @EQUAL
            CALL      CPAM0000                   * yes
            GOTO      RDIN9000
          ENDIF
.
          MATCH     "CWA",H7INMETP               * Put on Waiting List ?
          IF        @EQUAL
            CALL      CWAM0000                   * yes
            GOTO      RDIN9000
          ENDIF
.
          MATCH     "CWC",H7INMETP               * Cancel Waiting List entry ?
          IF        @EQUAL
            CALL      CWCM0000                   * yes
            GOTO      RDIN9000
          ENDIF
.
          MATCH     "CRM",H7INMETP               * Medical records movement ?
          IF        @EQUAL
            CALL      CRMM0000                   * yes
            GOTO      RDIN9000
          ENDIF
.
          MATCH     "CEA",H7INMETP               * Create All.Health Encounter ?
          IF        @EQUAL
            CALL      CEAM0000                   * yes
            GOTO      RDIN9000
          ENDIF
.
          MATCH     "CED",H7INMETP               * Create All.Health Encounter ?
          IF        @EQUAL
            CALL      CEDM0000                   * yes
            GOTO      RDIN9000
          ENDIF
.
          MATCH     "CAE",H7INMETP               * Emergency Visit ?
          IF        @EQUAL
            CALL      CAEM0000                   * yes
            GOTO      RDIN9000
          ENDIF
.
          MATCH     "CEC",H7INMETP               * Update Emergency Visit ?
          IF        @EQUAL
            CALL      CECM0000                   * yes
            GOTO      RDIN9000
          ENDIF
.
          MATCH     "CCE",H7INMETP               * Cancel Emergency Visit ?
          IF        @EQUAL
            CALL      CCEM0000                   * yes
            GOTO      RDIN9000
          ENDIF
.
          MATCH     "CCP",H7INMETP               * Change Pre-Admission ?
          IF        @EQUAL
            CALL      CCPM0000                   * yes
            GOTO      RDIN9000
          ENDIF
.
.         CAT not implemented
.
          MATCH     "CAT",H7INMETP               * Alerts ?
          IF        @EQUAL
.           CALL      CCAT0000                   * yes
.           GOTO      RDIN9000
          ENDIF
.
.         CMW not implemented
.
          MATCH     "CMW",H7INMETP               * Medical Warnings ?
          IF        @EQUAL
.           CALL      CCMW0000                   * yes
.           GOTO      RDIN9000
          ENDIF
.
.         CDN not implemented
.
          MATCH     "CDN",H7INMETP               * Donor Details ?
          IF        @EQUAL
.           CALL      CCDN0000                   * yes
.           GOTO      RDIN9000
          ENDIF
.
          MATCH     "CHA",H7INMETP               * Add Health Conc. Card ?
          IF        @EQUAL
            CALL      CHAM0000                   * yes
            GOTO      RDIN9000
          ENDIF
.
          MATCH     "CHD",H7INMETP               * Delete Health Conc. Card ?
          IF        @EQUAL
            CALL      CHDM0000                   * yes
            GOTO      RDIN9000
          ENDIF
.
RDIN9000  BRANCH    EXIT,RDIN9100:               * message rejected
                         RDIN9200                * e-Gate connection lost
.
.         Message delivered ok
.
          CALL      IBACLOCK                     * no-update status to delivered
          PACK      H7INDDAT,CCC,CYY,CMM,CDD,CTIMEIS
          REP       " 0",H7INDDAT
          MOVE      ANSD,H7INSTAT
          CALL      UPH7INB2
          DISPLAY   *P59:4,SP20,*P59:4,*V2LON,*HON,"Waiting";
          GOTO      RDIN0500
.
.         Message rejected - either an error occurred in formatting the message,
.         or a NAK was returned from e-Gate
.
RDIN9100  MOVE      ANSR,H7INSTAT                * yes - set status to rejected
          CALL      UPH7INB2                     * update record
          DISPLAY   *P59:4,SP20,*P59:4,*V2LON,*HON,"Waiting";
          GOTO      RDIN0500
.
RDIN9200  CLOSE     DGATE
          GOTO      RDIN0000
.
RDIN9999  RETURN
+
.******************************************************************************
.*                                  CUAM0000       Called by: RDIN0000        *
.*                       Write Update Alias Message                           *
.* Returns:  EXIT  0 = message sent ok                                        *
.*                 1 = message rejected                                       *
.*                 2 = e-Gate connection lost                                 *
.******************************************************************************
CUAM0000  MOVE      H7INMESI,KEY20
          CALL      RDPMQPT1                     * PMI details found ?
          BRANCH    OVRCD,CUAM9500               * no - error
.
          CALL      GDTM0000                     * get message date/time
.
.         Write message
.
          MOVE      "CUA",MESSTYPE
          WRITE     DGATE;MESSTYPE,PURNO,CSALIAS,PSNAME,PGNAME,PSEX,PBDATE:
                          DATETIME,SP1
.
          GOTO      CUAM9700 IF EOS              * e-Gate connection lost
          GOTO      CUAM9500 IF OVER             * NAK returned from e-Gate
.
CUAM9000  ADD       ONE,CUASENT
          DISPLAY   *P8:9,CUASENT;
          MOVE      ZERO,EXIT
          GOTO      CUAM9999
.
CUAM9500  ADD       ONE,CUAFAIL
          DISPLAY   *P18:9,CUAFAIL;
          MOVE      ONE,EXIT
          GOTO      CUAM9999
.
CUAM9700  MOVE      TWO,EXIT
.
CUAM9999  RETURN
+
.******************************************************************************
.*                                  CMRM0000       Called by: RDIN0000        *
.*                       Write Merge U/R Message                              *
.* Returns:  EXIT  0 = message sent ok                                        *
.*                 1 = message rejected                                       *
.*                 2 = e-Gate connection lost                                 *
.******************************************************************************
CMRM0000  MOVE      H7INMESI,KEY20
          CALL      RDPMQPT1                     * PMI details found ?
          BRANCH    OVRCD,CMRM9500               * no - error
.
.         Format PMI coded fields for HL7
.
          CALL      LDOC0000                     * format local doctor
          CALL      GREL0000                     * format religion
          CALL      GLAN0000                     * format language
          CALL      PINL0000                     * format preferred interpreter
.                                                  language
          CALL      PCON0000                     * format patient COB
          CALL      FCON0000                     * format father's COB
          CALL      MCON0000                     * format mother's COB
.
          MOVE      PFUNDH,FUNDCODE
          CALL      GFND0000                     * format health fund
          MOVE      FUNDDESC,PHFUNDD
.
          MOVE      PFUNDH,FUNDCODE
          MOVE      PFNDTB,TABLCODE
          CALL      GTBL0000                     * format fund table
          MOVE      TABLDESC,PHFTABD
.
          CALL      GDTM0000                     * get message date/time
          CALL      MEDI0000                     * format full medicare number
          CALL      GDVA0000                     * get DVA details
.
.         Write message
.
          MOVE      "CMR",MESSTYPE
          WRITE     DGATE;MESSTYPE,PURNO,PMQPOURN,PTITL,PHOSP,PLDAYS,PBDEBT:
                          PSNAME,PGNAME,PPSNAME,PADD1,PADD2,PSUBRB,PADD4,PPOST:
                          PTELEP,PTELEB,PSEX,PMSTAT,PBDATE:
                          PATCONT,RELIGON,PTYPE:
                          POCCUP,PLDDATE,FULLMEDI,PPENNO,PPNDTE,DVADIM10,PSMOK:
                          PMICRO,PCEASE,PCASE,PAUTOPY,PHIGH1,PHIGH2,PHIGH3:
                          PLOCDOC,PHFUNDD,PHFTABD,PFNDMM,PUSR1,PUSR2,PUSR3:
                          PUSR4,PUSR5,PUSR6,PUYN1,PUYN2,PUYN3,PYRRES:
                          PNKNAME,PNKADD1,PNKADD2,PNKSUBR,PNKADD4,PNKPOST:
                          PNKTELP,PNKTELB,PNKRELP,PFNDYY,PFNDCG,PDECDTE:
                          PDIET,PINITHOS,PHKADUNI,PTMAEMPC,PTMANOKO:
                          PTMANOKE,PTMADCNO,PTMXRDAT,PTMXMEAL,PTMXLGA:
                          PTMXLS,PTMXLSDT,PTMXFHMD,PTMXMHU1,PTMXMHU2:
                          PTMXMHU3,PTMXECNM,PTMXECA1,PTMXECA2,PTMXECA3:
                          PTMXECA4,PTMXECPC,PTMXECPP,PTMXECBP,PTMXECRE:
                          PTMXNRNM,PTMXNRA1,PTMXNRA2,PTMXNRA3,PTMXNRA4:
                          PTMXNRPC,PTMXNRPP,PTMXNRBP,PTMXNRRE,PTMX3BEX:
                          PTMXCARD,PTMXCEXP,PTMXCXMP,PTMXFMLY,PTMXCHNM:
                          PTMXDOFR,LOCDOCT,PMPXRH1G,PTMXSPID,PMPXR1GC:
                          PTMXOSDT,PTNINMPI:
                          NHMASURN,NHMAGIV1,NHMAGIV2,NHMAGIV3,NHMAPREI:
                          NHMAADD1,NHMAADD2,NHMAADD3,NHMAADD4,NHMAADD5:
                          NHMADOB,NHMADDTH,NHMADOMC,NHMARES,NHMAETH,NHMASEX:
                          NHMADAT,NHMATIM,NHMAETH2,NHMAETH3:
                          PTMXOPER,PTMXUKDO,PTMXCELL,PTMXADD1,PTMXADD2:
                          PTMXADD3,PTMXADD4,PTMXPOST:
                          PMPXINTR,PATLANG,PREFINT,PMPXLNG3,PMPXPEML:
                          PMPXEDOB,PMPXCMOB,PMPXCEML,PMPXCCRP,PMPXKMOB:
                          PMPXKEML,PMPXKCRP,PMPXRMOB,PMPXREML,PMPXRCRP:
                          PMPXMEDC,PMPXDETY,PMPXPRIS,PMPXCSER,PMPXPHEI:
                          PMPXPWEI,PMPXDREC,DVACCODE,PMPXPNSD,PMPXUYN4:
                          PMPXUYN5,PMPXUYN6,PMPXABRG,PMPXPRVI,PMPXCRIN:
                          PMPXHOML,PMPXUDC1,PMPXUDC2,PMPXUDC3,PMPXUSR7:
                          PMPXUSR8,PMPXUSR9,PMPXMSNA,PMPXMGNA,PMPXMTLE:
                          PMPXMAD1,PMPXMAD2,PMPXMAD3,PMPXMAD4,PMPXMPOS:
                          PMPXMPNO,PMPXMBNO,PMPXMMNO,PMPXMEML,MUMCONT:
                          PMPXMCRP,PMPXMLAB,PMPXMREL,PMPXFSNA,PMPXFGNA:
                          PMPXFTLE,PMPXFAD1,PMPXFAD2,PMPXFAD3,PMPXFAD4:
                          PMPXFPOS,PMPXFPNO,PMPXFBNO,PMPXFMNO,PMPXFEML:
                          FATCONT,PMPXFCRP,PMPXFLAB,PMPXFREL,DATETIME:
                          SP1
.
          GOTO      CMRM9700 IF EOS              * e-Gate connection lost
          GOTO      CMRM9500 IF OVER             * NAK returned from e-Gate
.
CMRM9000  ADD       ONE,CMRSENT
          DISPLAY   *P8:10,CMRSENT;
          MOVE      ZERO,EXIT
          GOTO      CMRM9999
.
CMRM9500  ADD       ONE,CMRFAIL
          DISPLAY   *P18:10,CMRFAIL;
          MOVE      ONE,EXIT
          GOTO      CMRM9999
.
CMRM9700  MOVE      TWO,EXIT
.
CMRM9999  RETURN
+
.******************************************************************************
.*                                  CUPM0000       Called by: RDIN0000        *
.*                       Write PMI Update Message                             *
.* Returns:  EXIT  0 = message sent ok                                        *
.*                 1 = message rejected                                       *
.*                 2 = e-Gate connection lost                                 *
.******************************************************************************
CUPM0000  MOVE      H7INMESI,KEY20
          CALL      RDPMQPT1                     * PMI details found ?
          BRANCH    OVRCD,CUPM9500               * no - error
.
.         Format PMI coded fields for HL7
.
          CALL      LDOC0000                     * format local doctor
          CALL      GREL0000                     * format religion
          CALL      GLAN0000                     * format language
          CALL      PINL0000                     * format preferred interpreter
.                                                  language
          CALL      PCON0000                     * format patient COB
          CALL      FCON0000                     * format father's COB
          CALL      MCON0000                     * format mother's COB
.
          MOVE      PFUNDH,FUNDCODE
          CALL      GFND0000                     * format health fund
          MOVE      FUNDDESC,PHFUNDD
.
          MOVE      PFUNDH,FUNDCODE
          MOVE      PFNDTB,TABLCODE
          CALL      GTBL0000                     * format fund table
          MOVE      TABLDESC,PHFTABD
.
          CALL      GDTM0000                     * get message date/time
          CALL      MEDI0000                     * format full medicare number
          CALL      GDVA0000                     * get DVA details
.
.         Write message
.
          MOVE      "CUP",MESSTYPE
          WRITE     DGATE;MESSTYPE,PURNO,CSALIAS,SP8,PTITL,PHOSP,PLDAYS:
                          PBDEBT,PSNAME,PGNAME,PPSNAME,PADD1,PADD2,PSUBRB,PADD4:
                          PPOST,PTELEP,PTELEB,PSEX,PMSTAT:
                          PBDATE,PATCONT,RELIGON:
                          PTYPE,POCCUP,PLDDATE,FULLMEDI,PPENNO,PPNDTE,DVADIM10:
                          PSMOK:
                          PMICRO,PCEASE,PCASE,PAUTOPY,PHIGH1,PHIGH2,PHIGH3:
                          PLOCDOC,PHFUNDD,PHFTABD,PFNDMM,PUSR1,PUSR2,PUSR3:
                          PUSR4,PUSR5,PUSR6,PUYN1,PUYN2,PUYN3,PYRRES:
                          PNKNAME,PNKADD1,PNKADD2,PNKSUBR,PNKADD4,PNKPOST:
                          PNKTELP,PNKTELB,PNKRELP,PFNDYY,PFNDCG,PDECDTE:
                          PDIET,PINITHOS,PHKADUNI,PTMAEMPC,PTMANOKO:
                          PTMANOKE,PTMADCNO,PTMXRDAT,PTMXMEAL,PTMXLGA:
                          PTMXLS,PTMXLSDT,PTMXFHMD,PTMXMHU1,PTMXMHU2:
                          PTMXMHU3,PTMXECNM,PTMXECA1,PTMXECA2,PTMXECA3:
                          PTMXECA4,PTMXECPC,PTMXECPP,PTMXECBP,PTMXECRE:
                          PTMXNRNM,PTMXNRA1,PTMXNRA2,PTMXNRA3,PTMXNRA4:
                          PTMXNRPC,PTMXNRPP,PTMXNRBP,PTMXNRRE,PTMX3BEX:
                          PTMXCARD,PTMXCEXP,PTMXCXMP,PTMXFMLY,PTMXCHNM:
                          PTMXDOFR,LOCDOCT,PMPXRH1G,PTMXSPID,PMPXR1GC:
                          PTMXOSDT,PTNINMPI:
                          NHMASURN,NHMAGIV1,NHMAGIV2,NHMAGIV3,NHMAPREI:
                          NHMAADD1,NHMAADD2,NHMAADD3,NHMAADD4,NHMAADD5:
                          NHMADOB,NHMADDTH,NHMADOMC,NHMARES,NHMAETH,NHMASEX:
                          NHMADAT,NHMATIM,NHMAETH2,NHMAETH3:
                          PTMXOPER,PTMXUKDO,PTMXCELL,PTMXADD1,PTMXADD2:
                          PTMXADD3,PTMXADD4,PTMXPOST:
                          PMPXINTR,PATLANG,PREFINT,PMPXLNG3,PMPXPEML:
                          PMPXEDOB,PMPXCMOB,PMPXCEML,PMPXCCRP,PMPXKMOB:
                          PMPXKEML,PMPXKCRP,PMPXRMOB,PMPXREML,PMPXRCRP:
                          PMPXMEDC,PMPXDETY,PMPXPRIS,PMPXCSER,PMPXPHEI:
                          PMPXPWEI,PMPXDREC,DVACCODE,PMPXPNSD,PMPXUYN4:
                          PMPXUYN5,PMPXUYN6,PMPXABRG,PMPXPRVI,PMPXCRIN:
                          PMPXHOML,PMPXUDC1,PMPXUDC2,PMPXUDC3,PMPXUSR7:
                          PMPXUSR8,PMPXUSR9,PMPXMSNA,PMPXMGNA,PMPXMTLE:
                          PMPXMAD1,PMPXMAD2,PMPXMAD3,PMPXMAD4,PMPXMPOS:
                          PMPXMPNO,PMPXMBNO,PMPXMMNO,PMPXMEML,MUMCONT:
                          PMPXMCRP,PMPXMLAB,PMPXMREL,PMPXFSNA,PMPXFGNA:
                          PMPXFTLE,PMPXFAD1,PMPXFAD2,PMPXFAD3,PMPXFAD4:
                          PMPXFPOS,PMPXFPNO,PMPXFBNO,PMPXFMNO,PMPXFEML:
                          FATCONT,PMPXFCRP,PMPXFLAB,PMPXFREL,DATETIME:
                          SP1
.
          GOTO      CUPM9700 IF EOS              * e-Gate connection lost
          GOTO      CUPM9500 IF OVER             * NAK returned from e-Gate
.
CUPM9000  ADD       ONE,CUPSENT
          DISPLAY   *P8:8,CUPSENT;
          MOVE      ZERO,EXIT
          GOTO      CUPM9999
.
CUPM9500  ADD       ONE,CUPFAIL
          DISPLAY   *P18:8,CUPFAIL;
          MOVE      ONE,EXIT
          GOTO      CUPM9999
.
CUPM9700  MOVE      TWO,EXIT
.
CUPM9999  RETURN
+
.******************************************************************************
.*                                  CPEM0000       Called by: RDIN0000        *
.*                       Write Pre-Admission Message                          *
.* Returns:  EXIT  0 = message sent ok                                        *
.*                 1 = message rejected                                       *
.*                 2 = e-Gate connection lost                                 *
.******************************************************************************
CPEM0000  MOVE      H7INMESI,KEY20
          CALL      RDPMQPT1                     * PMI details found ?
          BRANCH    OVRCD,CPEM9500               * no - error
.
          PACK      KEY22,H7INMESI,SP1,ONE
          CALL      RDPMQVI1                     * visit details found ?
          BRANCH    OVRCD,CPEM9500               * no - error
.
          MOVE      H7INMESI,KEY20
          CALL      RDWTQUE1                     * W/L details found ?
          BRANCH    OVRCD,CPEM9500               * no - error
.
.         Format PMI coded fields for HL7
.
          CALL      LDOC0000                     * format local doctor
          CALL      GREL0000                     * format religion
          CALL      GLAN0000                     * format language
          CALL      PINL0000                     * format preferred interpreter
.                                                  language
          CALL      PCON0000                     * format patient COB
          CALL      FCON0000                     * format father's COB
          CALL      MCON0000                     * format mother's COB
.
          MOVE      PFUNDH,FUNDCODE
          CALL      GFND0000                     * format health fund
          MOVE      FUNDDESC,PHFUNDD
.
          MOVE      PFUNDH,FUNDCODE
          MOVE      PFNDTB,TABLCODE
          CALL      GTBL0000                     * format fund table
          MOVE      TABLDESC,PHFTABD
.
.         Format Visit coded fields for HL7
.
          MOVE      ADOCTT,ATTDCODE
          CALL      ADOC0000                     * format attending doctor
          MOVE      ATTDDESC,ATTDOCT
.
          MOVE      TADOCT,CONSCODE
          CALL      GCON0000                     * format consultant
          MOVE      CONSDESC,CONSULT
.
          PACK      REFDCODE,PMVXRHC1,SP10
          CALL      GREF0000                     * format referring doctor
          MOVE      REFDDESC,REFDOCT
.
          MOVE      ASRCE,SRCECODE
          CALL      GSRC0000                     * format source of referral
          MOVE      SRCEDESC,SRCREFL
.
          MOVE      TDEPT,UNITCODE
          CALL      UNIT0000                     * format clinical unit
          MOVE      UNITDESC,CLIUNIT
.
          MOVE      ACLSS,ADMNCODE
          CALL      GTYP0000                     * format admission type
          MOVE      ADMNDESC,ADMTYPE
.
          MOVE      TATYPE,CLASCODE
          CALL      CLAS0000                     * format admission class
          MOVE      CLASDESC,ADMCLSS
.
          MOVE      TWARD,WARDCODE
          CALL      GWRD0000                     * format patient location
          MOVE      WARDDESC,PATWLOC
.
          MOVE      AFUNDH,FUNDCODE
          CALL      GFND0000                     * format health fund
          MOVE      FUNDDESC,AHFUNDD
.
          MOVE      AFUNDH,FUNDCODE
          MOVE      AFNDTB,TABLCODE
          CALL      GTBL0000                     * format fund table
          MOVE      TABLDESC,AHFTABD
.
          CALL      GDTM0000                     * get message date/time
          CALL      MEDI0000                     * format full medicare number
          CALL      GDVA0000                     * get DVA details
.
.         Write message
.
          MOVE      "CPE",MESSTYPE
          WRITE     DGATE;MESSTYPE,PURNO,CSALIAS,SP8,PTITL,PHOSP,PLDAYS:
                          PBDEBT,PSNAME,PGNAME,PPSNAME,PADD1,PADD2,PSUBRB,PADD4:
                          PPOST,PTELEP,PTELEB,PSEX,PMSTAT:
                          PBDATE,PATCONT,RELIGON:
                          PTYPE,POCCUP,PLDDATE,FULLMEDI,PPENNO,PPNDTE,DVADIM10:
                          PSMOK:
                          PMICRO,PCEASE,PCASE,PAUTOPY,PHIGH1,PHIGH2,PHIGH3:
                          PLOCDOC,PHFUNDD,PHFTABD,PFNDMM,PUSR1,PUSR2,PUSR3:
                          PUSR4,PUSR5,PUSR6,PUYN1,PUYN2,PUYN3,PYRRES:
                          PNKNAME,PNKADD1,PNKADD2,PNKSUBR,PNKADD4,PNKPOST:
                          PNKTELP,PNKTELB,PNKRELP,PFNDYY,PFNDCG,PDECDTE:
                          PDIET,PINITHOS,PHKADUNI,PTMAEMPC,PTMANOKO:
                          PTMANOKE,PTMADCNO,PTMXRDAT,PTMXMEAL,PTMXLGA:
                          PTMXLS,PTMXLSDT,PTMXFHMD,PTMXMHU1,PTMXMHU2:
                          PTMXMHU3,PTMXECNM,PTMXECA1,PTMXECA2,PTMXECA3:
                          PTMXECA4,PTMXECPC,PTMXECPP,PTMXECBP,PTMXECRE:
                          PTMXNRNM,PTMXNRA1,PTMXNRA2,PTMXNRA3,PTMXNRA4:
                          PTMXNRPC,PTMXNRPP,PTMXNRBP,PTMXNRRE,PTMX3BEX:
                          PTMXCARD,PTMXCEXP,PTMXCXMP,PTMXFMLY,PTMXCHNM:
                          PTMXDOFR,LOCDOCT,PMPXRH1G,PTMXSPID,PMPXR1GC:
                          PTMXOSDT,PTNINMPI:
                          NHMASURN,NHMAGIV1,NHMAGIV2,NHMAGIV3,NHMAPREI:
                          NHMAADD1,NHMAADD2,NHMAADD3,NHMAADD4,NHMAADD5:
                          NHMADOB,NHMADDTH,NHMADOMC,NHMARES,NHMAETH:
                          NHMASEX,NHMADAT,NHMATIM,NHMAETH2,NHMAETH3:
                          PTMXOPER,PTMXUKDO,PTMXCELL,PTMXADD1,PTMXADD2:
                          PTMXADD3,PTMXADD4,PTMXPOST:
                          AADMNO,ADATE,ATIME,AINVPRT:
                          ALACDTE,ACANCEL,ADOCTR,ADOCTL,SRCREFL,ADMTYPE:
                          ACARE,AHFUNDD,AHFTABD,AFNDMM,AELIG:
                          AVISIT,AALERG,AILLN,ADIAG1,ADIAG2:
                          ADISC,ATTDOCT,AALLOW,AMBS,ACLAIM,ADIET:
                          APLOCCR,ASTAY,ADYHOSP,AMEMB,AMEMBNO,ACOMM1:
                          ACOMM2,APLUR,APURGE,AUSR1,AUSR2,AUSR3,AUSR4:
                          AUSR5,AUSR6,AUSR7,ADSCHI,ARDRNAM,AFNDYY:
                          AFNDCG,AOCCDTE,ACODDTE,ARETDTE,AMUMADM:
                          PTMIPVIS,ABWGHT,REFDOCT,PMVXRH1G,PTMSFHAN:
                          PTMSECRA,PTMSMGIN,PTMIDDIG,PMVXRH1C,PTMIDOFR:
                          PTMIREFD,PTMIDFCN,PTMIPHPU,PTMIAGNC,PTMIESSF:
                          PTMIUSR8,PTMIUSR9,PTMIUSR0,PTMIPDRG,PTMIOPER:
                          PTMIXWRD,PTMIADOC,PTMIREGS,PTMIUYN1,PTMIUYN2:
                          PATWLOC,TBED,TRATEF,TRATEG,TDISC,TALLW,ADMCLSS:
                          CONSULT,TRATEH,TEXTRA,TRBTYP,TRBEND:
                          CLIUNIT,PTTRLTYP,PTTREPNO,DSNAME,DGNAME:
                          PMPXINTR,PATLANG,PREFINT,PMPXLNG3,PMPXPEML:
                          PMPXEDOB,PMPXCMOB,PMPXCEML,PMPXCCRP,PMPXKMOB:
                          PMPXKEML,PMPXKCRP,PMPXRMOB,PMPXREML,PMPXRCRP:
                          PMPXMEDC,PMPXDETY,PMPXPRIS,PMPXCSER,PMPXPHEI:
                          PMPXPWEI,PMPXDREC,DVACCODE,PMPXPNSD,PMPXUYN4:
                          PMPXUYN5,PMPXUYN6,PMPXABRG,PMPXPRVI,PMPXCRIN:
                          PMPXHOML,PMPXUDC1,PMPXUDC2,PMPXUDC3,PMPXUSR7:
                          PMPXUSR8,PMPXUSR9,PMPXMSNA,PMPXMGNA,PMPXMTLE:
                          PMPXMAD1,PMPXMAD2,PMPXMAD3,PMPXMAD4,PMPXMPOS:
                          PMPXMPNO,PMPXMBNO,PMPXMMNO,PMPXMEML,MUMCONT:
                          PMPXMCRP,PMPXMLAB,PMPXMREL,PMPXFSNA,PMPXFGNA:
                          PMPXFTLE,PMPXFAD1,PMPXFAD2,PMPXFAD3,PMPXFAD4:
                          PMPXFPOS,PMPXFPNO,PMPXFBNO,PMPXFMNO,PMPXFEML:
                          FATCONT,PMPXFCRP,PMPXFLAB,PMPXFREL:
                          PMVXVLOC,PMVXCFSG,PMVXINGP,PMVXCPTH,PMVXHCP1:
                          PMVXHCP2,PMVXHCP3,PMVXHCP4,PMVXRHC1,PMVXRHC2:
                          PMVXRHC3,PMVXRHC4,PMVXCADM,PMVXIRAD,PMVXIDUS:
                          PMVXCRAV,PMVXRCCT,PMVXAPWD,PMVXAPBD,PMVXPOWD:
                          PMVXPOBD,PMVXPSTY,PMVXVALW,PMVXPALW,PMVXINDC:
                          PMVXMDAV,PMVXFRMS,PMVXEDC1,PMVXEDC2,PMVXEDC3:
                          PMVXUDF1,PMVXUDF2,PMVXUDF3,PMVXUDF4,PMVXUDT1:
                          PMVXUDT2,PMVXUDT3,PMVXUDT4,PMVXUDT5,PMVXUDT6:
                          DATETIME,WMCODE,WMCNT,WMTIME,WMDESC,WMREASON:
                          PKNAME,PKADD1,PKADD2,PKSUBR,PKADD4,PKPOST,PKTELEP:
                          PKTELEB,PKRELP,SP1
.
          GOTO      CPEM9700 IF EOS              * e-Gate connection lost
          GOTO      CPEM9500 IF OVER             * NAK returned from e-Gate
.
CPEM9000  ADD       ONE,CPESENT
          DISPLAY   *P8:16,CPESENT;
          MOVE      ZERO,EXIT
          GOTO      CPEM9999
.
CPEM9500  ADD       ONE,CPEFAIL
          DISPLAY   *P18:16,CPEFAIL;
          MOVE      ONE,EXIT
          GOTO      CPEM9999
.
CPEM9700  MOVE      TWO,EXIT
.
CPEM9999  RETURN
+
.******************************************************************************
.*                                  CADM0000       Called by: RDIN0000        *
.*                       Write Admission Message                              *
.* Returns:  EXIT  0 = message sent ok                                        *
.*                 1 = message rejected                                       *
.*                 2 = e-Gate connection lost                                 *
.******************************************************************************
CADM0000  MOVE      H7INMESI,KEY20
          CALL      RDPMQPT1                     * PMI details found ?
          BRANCH    OVRCD,CADM9500               * no - error
.
          PACK      KEY22,H7INMESI,SP1,ONE
          CALL      RDPMQVI1                     * visit details found ?
          BRANCH    OVRCD,CADM9500               * no - error
.
.         Format PMI coded fields for HL7
.
          CALL      LDOC0000                     * format local doctor
          CALL      GREL0000                     * format religion
          CALL      GLAN0000                     * format language
          CALL      PINL0000                     * format preferred interpreter
.                                                  language
          CALL      PCON0000                     * format patient COB
          CALL      FCON0000                     * format father's COB
          CALL      MCON0000                     * format mother's COB
.
          MOVE      PFUNDH,FUNDCODE
          CALL      GFND0000                     * format health fund
          MOVE      FUNDDESC,PHFUNDD
.
          MOVE      PFUNDH,FUNDCODE
          MOVE      PFNDTB,TABLCODE
          CALL      GTBL0000                     * format fund table
          MOVE      TABLDESC,PHFTABD
.
.         Format Visit coded fields for HL7
.
          MOVE      ADOCTT,ATTDCODE
          CALL      ADOC0000                     * format attending doctor
          MOVE      ATTDDESC,ATTDOCT
.
          MOVE      TADOCT,CONSCODE
          CALL      GCON0000                     * format consultant
          MOVE      CONSDESC,CONSULT
.
          PACK      REFDCODE,PMVXRHC1,SP10
          CALL      GREF0000                     * format referring doctor
          MOVE      REFDDESC,REFDOCT
.
          MOVE      ASRCE,SRCECODE
          CALL      GSRC0000                     * format source of referral
          MOVE      SRCEDESC,SRCREFL
.
          MOVE      TDEPT,UNITCODE
          CALL      UNIT0000                     * format clinical unit
          MOVE      UNITDESC,CLIUNIT
.
          MOVE      ACLSS,ADMNCODE
          CALL      GTYP0000                     * format admission type
          MOVE      ADMNDESC,ADMTYPE
.
          MOVE      TATYPE,CLASCODE
          CALL      CLAS0000                     * format admission class
          MOVE      CLASDESC,ADMCLSS
.
          MOVE      TWARD,WARDCODE
          CALL      GWRD0000                     * format patient location
          MOVE      WARDDESC,PATWLOC
.
          MOVE      AFUNDH,FUNDCODE
          CALL      GFND0000                     * format health fund
          MOVE      FUNDDESC,AHFUNDD
.
          MOVE      AFUNDH,FUNDCODE
          MOVE      AFNDTB,TABLCODE
          CALL      GTBL0000                     * format fund table
          MOVE      TABLDESC,AHFTABD
.
          CALL      GDTM0000                     * get message date/time
          CALL      MEDI0000                     * format full medicare number
          CALL      GDVA0000                     * get DVA details
.
.         Write message
.
          MOVE      "CAD",MESSTYPE
          WRITE     DGATE;MESSTYPE,PURNO,CSALIAS,SP8,PTITL,PHOSP,PLDAYS:
                          PBDEBT,PSNAME,PGNAME,PPSNAME,PADD1,PADD2,PSUBRB,PADD4:
                          PPOST,PTELEP,PTELEB,PSEX,PMSTAT:
                          PBDATE,PATCONT,RELIGON:
                          PTYPE,POCCUP,PLDDATE,FULLMEDI,PPENNO,PPNDTE,DVADIM10:
                          PSMOK:
                          PMICRO,PCEASE,PCASE,PAUTOPY,PHIGH1,PHIGH2,PHIGH3:
                          PLOCDOC,PHFUNDD,PHFTABD,PFNDMM,PUSR1,PUSR2,PUSR3:
                          PUSR4,PUSR5,PUSR6,PUYN1,PUYN2,PUYN3,PYRRES:
                          PNKNAME,PNKADD1,PNKADD2,PNKSUBR,PNKADD4,PNKPOST:
                          PNKTELP,PNKTELB,PNKRELP,PFNDYY,PFNDCG,PDECDTE:
                          PDIET,PINITHOS,PHKADUNI,PTMAEMPC,PTMANOKO:
                          PTMANOKE,PTMADCNO,PTMXRDAT,PTMXMEAL,PTMXLGA:
                          PTMXLS,PTMXLSDT,PTMXFHMD,PTMXMHU1,PTMXMHU2:
                          PTMXMHU3,PTMXECNM,PTMXECA1,PTMXECA2,PTMXECA3:
                          PTMXECA4,PTMXECPC,PTMXECPP,PTMXECBP,PTMXECRE:
                          PTMXNRNM,PTMXNRA1,PTMXNRA2,PTMXNRA3,PTMXNRA4:
                          PTMXNRPC,PTMXNRPP,PTMXNRBP,PTMXNRRE,PTMX3BEX:
                          PTMXCARD,PTMXCEXP,PTMXCXMP,PTMXFMLY,PTMXCHNM:
                          PTMXDOFR,LOCDOCT,PMPXRH1G,PTMXSPID,PMPXR1GC:
                          PTMXOSDT,PTNINMPI:
                          NHMASURN,NHMAGIV1,NHMAGIV2,NHMAGIV3,NHMAPREI:
                          NHMAADD1,NHMAADD2,NHMAADD3,NHMAADD4,NHMAADD5:
                          NHMADOB,NHMADDTH,NHMADOMC,NHMARES,NHMAETH:
                          NHMASEX,NHMADAT,NHMATIM,NHMAETH2,NHMAETH3:
                          PTMXOPER,PTMXUKDO,PTMXCELL,PTMXADD1,PTMXADD2:
                          PTMXADD3,PTMXADD4,PTMXPOST:
                          AADMNO,ADATE,ATIME,AINVPRT:
                          ALACDTE,ACANCEL,ADOCTR,ADOCTL,SRCREFL,ADMTYPE:
                          ACARE,AHFUNDD,AHFTABD,AFNDMM,AELIG:
                          AVISIT,AALERG,AILLN,ADIAG1,ADIAG2:
                          ADISC,ATTDOCT,AALLOW,AMBS,ACLAIM,ADIET:
                          APLOCCR,ASTAY,ADYHOSP,AMEMB,AMEMBNO,ACOMM1:
                          ACOMM2,APLUR,APURGE,AUSR1,AUSR2,AUSR3,AUSR4:
                          AUSR5,AUSR6,AUSR7,ADSCHI,ARDRNAM,AFNDYY:
                          AFNDCG,AOCCDTE,ACODDTE,ARETDTE,AMUMADM:
                          PTMIPVIS,ABWGHT,REFDOCT,PMVXRH1G,PTMSFHAN:
                          PTMSECRA,PTMSMGIN,PTMIDDIG,PMVXRH1C,PTMIDOFR:
                          PTMIREFD,PTMIDFCN,PTMIPHPU,PTMIAGNC,PTMIESSF:
                          PTMIUSR8,PTMIUSR9,PTMIUSR0,PTMIPDRG,PTMIOPER:
                          PTMIXWRD,PTMIADOC,PTMIREGS,PTMIUYN1,PTMIUYN2:
                          PATWLOC,TBED,TRATEF,TRATEG,TDISC,TALLW,ADMCLSS:
                          CONSULT,TRATEH,TEXTRA,TRBTYP,TRBEND:
                          CLIUNIT,PTTRLTYP,PTTREPNO,DSNAME,DGNAME:
                          PMPXINTR,PATLANG,PREFINT,PMPXLNG3,PMPXPEML:
                          PMPXEDOB,PMPXCMOB,PMPXCEML,PMPXCCRP,PMPXKMOB:
                          PMPXKEML,PMPXKCRP,PMPXRMOB,PMPXREML,PMPXRCRP:
                          PMPXMEDC,PMPXDETY,PMPXPRIS,PMPXCSER,PMPXPHEI:
                          PMPXPWEI,PMPXDREC,DVACCODE,PMPXPNSD,PMPXUYN4:
                          PMPXUYN5,PMPXUYN6,PMPXABRG,PMPXPRVI,PMPXCRIN:
                          PMPXHOML,PMPXUDC1,PMPXUDC2,PMPXUDC3,PMPXUSR7:
                          PMPXUSR8,PMPXUSR9,PMPXMSNA,PMPXMGNA,PMPXMTLE:
                          PMPXMAD1,PMPXMAD2,PMPXMAD3,PMPXMAD4,PMPXMPOS:
                          PMPXMPNO,PMPXMBNO,PMPXMMNO,PMPXMEML,MUMCONT:
                          PMPXMCRP,PMPXMLAB,PMPXMREL,PMPXFSNA,PMPXFGNA:
                          PMPXFTLE,PMPXFAD1,PMPXFAD2,PMPXFAD3,PMPXFAD4:
                          PMPXFPOS,PMPXFPNO,PMPXFBNO,PMPXFMNO,PMPXFEML:
                          FATCONT,PMPXFCRP,PMPXFLAB,PMPXFREL:
                          PMVXVLOC,PMVXCFSG,PMVXINGP,PMVXCPTH,PMVXHCP1:
                          PMVXHCP2,PMVXHCP3,PMVXHCP4,PMVXRHC1,PMVXRHC2:
                          PMVXRHC3,PMVXRHC4,PMVXCADM,PMVXIRAD,PMVXIDUS:
                          PMVXCRAV,PMVXRCCT,PMVXAPWD,PMVXAPBD,PMVXPOWD:
                          PMVXPOBD,PMVXPSTY,PMVXVALW,PMVXPALW,PMVXINDC:
                          PMVXMDAV,PMVXFRMS,PMVXEDC1,PMVXEDC2,PMVXEDC3:
                          PMVXUDF1,PMVXUDF2,PMVXUDF3,PMVXUDF4,PMVXUDT1:
                          PMVXUDT2,PMVXUDT3,PMVXUDT4,PMVXUDT5,PMVXUDT6:
                          DATETIME,PKNAME,PKADD1,PKADD2,PKSUBR,PKADD4,PKPOST:
                          PKTELEP,PKTELEB,PKRELP,SP1
.
          GOTO      CADM9700 IF EOS              * e-Gate connection lost
          GOTO      CADM9500 IF OVER             * NAK returned from e-Gate
.
CADM9000  ADD       ONE,CADSENT
          DISPLAY   *P8:19,CADSENT;
          MOVE      ZERO,EXIT
          GOTO      CADM9999
.
CADM9500  ADD       ONE,CADFAIL
          DISPLAY   *P18:19,CADFAIL;
          MOVE      ONE,EXIT
          GOTO      CADM9999
.
CADM9700  MOVE      TWO,EXIT
.
CADM9999  RETURN
+
.******************************************************************************
.*                                  CACM0000       Called by: RDIN0000        *
.*                       Write Change Admission Message                       *
.* Returns:  EXIT  0 = message sent ok                                        *
.*                 1 = message rejected                                       *
.*                 2 = e-Gate connection lost                                 *
.******************************************************************************
CACM0000  MOVE      H7INMESI,KEY20
          CALL      RDPMQPT1                     * PMI details found ?
          BRANCH    OVRCD,CACM9500               * no - error
.
          PACK      KEY22,H7INMESI,SP1,ONE
          CALL      RDPMQVI1                     * visit details found ?
          BRANCH    OVRCD,CACM9500               * no - error
.
.         Format PMI coded fields for HL7
.
          CALL      LDOC0000                     * format local doctor
          CALL      GREL0000                     * format religion
          CALL      GLAN0000                     * format language
          CALL      PINL0000                     * format preferred interpreter
.                                                  language
          CALL      PCON0000                     * format patient COB
          CALL      FCON0000                     * format father's COB
          CALL      MCON0000                     * format mother's COB
.
          MOVE      PFUNDH,FUNDCODE
          CALL      GFND0000                     * format health fund
          MOVE      FUNDDESC,PHFUNDD
.
          MOVE      PFUNDH,FUNDCODE
          MOVE      PFNDTB,TABLCODE
          CALL      GTBL0000                     * format fund table
          MOVE      TABLDESC,PHFTABD
.
.         Format Visit coded fields for HL7
.
          MOVE      ADOCTT,ATTDCODE
          CALL      ADOC0000                     * format attending doctor
          MOVE      ATTDDESC,ATTDOCT
.
          MOVE      TADOCT,CONSCODE
          CALL      GCON0000                     * format consultant
          MOVE      CONSDESC,CONSULT
.
          PACK      REFDCODE,PMVXRHC1,SP10
          CALL      GREF0000                     * format referring doctor
          MOVE      REFDDESC,REFDOCT
.
          MOVE      ASRCE,SRCECODE
          CALL      GSRC0000                     * format source of referral
          MOVE      SRCEDESC,SRCREFL
.
          MOVE      TDEPT,UNITCODE
          CALL      UNIT0000                     * format clinical unit
          MOVE      UNITDESC,CLIUNIT
.
          MOVE      ACLSS,ADMNCODE
          CALL      GTYP0000                     * format admission type
          MOVE      ADMNDESC,ADMTYPE
.
          MOVE      TATYPE,CLASCODE
          CALL      CLAS0000                     * format admission class
          MOVE      CLASDESC,ADMCLSS
.
          MOVE      TWARD,WARDCODE
          CALL      GWRD0000                     * format patient location
          MOVE      WARDDESC,PATWLOC
.
          MOVE      AFUNDH,FUNDCODE
          CALL      GFND0000                     * format health fund
          MOVE      FUNDDESC,AHFUNDD
.
          MOVE      AFUNDH,FUNDCODE
          MOVE      AFNDTB,TABLCODE
          CALL      GTBL0000                     * format fund table
          MOVE      TABLDESC,AHFTABD
.
          CALL      GDTM0000                     * get message date/time
          CALL      MEDI0000                     * format full medicare number
          CALL      GDVA0000                     * get DVA details
.
.         Write message
.
          MOVE      "CAC",MESSTYPE
          WRITE     DGATE;MESSTYPE,PURNO,CSALIAS,SP8,PTITL,PHOSP,PLDAYS:
                          PBDEBT,PSNAME,PGNAME,PPSNAME,PADD1,PADD2,PSUBRB,PADD4:
                          PPOST,PTELEP,PTELEB,PSEX,PMSTAT:
                          PBDATE,PATCONT,RELIGON:
                          PTYPE,POCCUP,PLDDATE,FULLMEDI,PPENNO,PPNDTE,DVADIM10:
                          PSMOK:
                          PMICRO,PCEASE,PCASE,PAUTOPY,PHIGH1,PHIGH2,PHIGH3:
                          PLOCDOC,PHFUNDD,PHFTABD,PFNDMM,PUSR1,PUSR2,PUSR3:
                          PUSR4,PUSR5,PUSR6,PUYN1,PUYN2,PUYN3,PYRRES:
                          PNKNAME,PNKADD1,PNKADD2,PNKSUBR,PNKADD4,PNKPOST:
                          PNKTELP,PNKTELB,PNKRELP,PFNDYY,PFNDCG,PDECDTE:
                          PDIET,PINITHOS,PHKADUNI,PTMAEMPC,PTMANOKO:
                          PTMANOKE,PTMADCNO,PTMXRDAT,PTMXMEAL,PTMXLGA:
                          PTMXLS,PTMXLSDT,PTMXFHMD,PTMXMHU1,PTMXMHU2:
                          PTMXMHU3,PTMXECNM,PTMXECA1,PTMXECA2,PTMXECA3:
                          PTMXECA4,PTMXECPC,PTMXECPP,PTMXECBP,PTMXECRE:
                          PTMXNRNM,PTMXNRA1,PTMXNRA2,PTMXNRA3,PTMXNRA4:
                          PTMXNRPC,PTMXNRPP,PTMXNRBP,PTMXNRRE,PTMX3BEX:
                          PTMXCARD,PTMXCEXP,PTMXCXMP,PTMXFMLY,PTMXCHNM:
                          PTMXDOFR,LOCDOCT,PMPXRH1G,PTMXSPID,PMPXR1GC:
                          PTMXOSDT,PTNINMPI:
                          NHMASURN,NHMAGIV1,NHMAGIV2,NHMAGIV3,NHMAPREI:
                          NHMAADD1,NHMAADD2,NHMAADD3,NHMAADD4,NHMAADD5:
                          NHMADOB,NHMADDTH,NHMADOMC,NHMARES,NHMAETH:
                          NHMASEX,NHMADAT,NHMATIM,NHMAETH2,NHMAETH3:
                          PTMXOPER,PTMXUKDO,PTMXCELL,PTMXADD1,PTMXADD2:
                          PTMXADD3,PTMXADD4,PTMXPOST:
                          AADMNO,ADATE,ATIME,AINVPRT:
                          ALACDTE,ACANCEL,ADOCTR,ADOCTL,SRCREFL,ADMTYPE:
                          ACARE,AHFUNDD,AHFTABD,AFNDMM,AELIG:
                          AVISIT,AALERG,AILLN,ADIAG1,ADIAG2:
                          ADISC,ATTDOCT,AALLOW,AMBS,ACLAIM,ADIET:
                          APLOCCR,ASTAY,ADYHOSP,AMEMB,AMEMBNO,ACOMM1:
                          ACOMM2,APLUR,APURGE,AUSR1,AUSR2,AUSR3,AUSR4:
                          AUSR5,AUSR6,AUSR7,ADSCHI,ARDRNAM,AFNDYY:
                          AFNDCG,AOCCDTE,ACODDTE,ARETDTE,AMUMADM:
                          PTMIPVIS,ABWGHT,REFDOCT,PMVXRH1G,PTMSFHAN:
                          PTMSECRA,PTMSMGIN,PTMIDDIG,PMVXRH1C,PTMIDOFR:
                          PTMIREFD,PTMIDFCN,PTMIPHPU,PTMIAGNC,PTMIESSF:
                          PTMIUSR8,PTMIUSR9,PTMIUSR0,PTMIPDRG,PTMIOPER:
                          PTMIXWRD,PTMIADOC,PTMIREGS,PTMIUYN1,PTMIUYN2:
                          PATWLOC,TBED,TRATEF,TRATEG,TDISC,TALLW,ADMCLSS:
                          CONSULT,TRATEH,TEXTRA,TRBTYP,TRBEND:
                          CLIUNIT,PTTRLTYP,PTTREPNO,DSNAME,DGNAME:
                          PMPXINTR,PATLANG,PREFINT,PMPXLNG3,PMPXPEML:
                          PMPXEDOB,PMPXCMOB,PMPXCEML,PMPXCCRP,PMPXKMOB:
                          PMPXKEML,PMPXKCRP,PMPXRMOB,PMPXREML,PMPXRCRP:
                          PMPXMEDC,PMPXDETY,PMPXPRIS,PMPXCSER,PMPXPHEI:
                          PMPXPWEI,PMPXDREC,DVACCODE,PMPXPNSD,PMPXUYN4:
                          PMPXUYN5,PMPXUYN6,PMPXABRG,PMPXPRVI,PMPXCRIN:
                          PMPXHOML,PMPXUDC1,PMPXUDC2,PMPXUDC3,PMPXUSR7:
                          PMPXUSR8,PMPXUSR9,PMPXMSNA,PMPXMGNA,PMPXMTLE:
                          PMPXMAD1,PMPXMAD2,PMPXMAD3,PMPXMAD4,PMPXMPOS:
                          PMPXMPNO,PMPXMBNO,PMPXMMNO,PMPXMEML,MUMCONT:
                          PMPXMCRP,PMPXMLAB,PMPXMREL,PMPXFSNA,PMPXFGNA:
                          PMPXFTLE,PMPXFAD1,PMPXFAD2,PMPXFAD3,PMPXFAD4:
                          PMPXFPOS,PMPXFPNO,PMPXFBNO,PMPXFMNO,PMPXFEML:
                          FATCONT,PMPXFCRP,PMPXFLAB,PMPXFREL:
                          PMVXVLOC,PMVXCFSG,PMVXINGP,PMVXCPTH,PMVXHCP1:
                          PMVXHCP2,PMVXHCP3,PMVXHCP4,PMVXRHC1,PMVXRHC2:
                          PMVXRHC3,PMVXRHC4,PMVXCADM,PMVXIRAD,PMVXIDUS:
                          PMVXCRAV,PMVXRCCT,PMVXAPWD,PMVXAPBD,PMVXPOWD:
                          PMVXPOBD,PMVXPSTY,PMVXVALW,PMVXPALW,PMVXINDC:
                          PMVXMDAV,PMVXFRMS,PMVXEDC1,PMVXEDC2,PMVXEDC3:
                          PMVXUDF1,PMVXUDF2,PMVXUDF3,PMVXUDF4,PMVXUDT1:
                          PMVXUDT2,PMVXUDT3,PMVXUDT4,PMVXUDT5,PMVXUDT6:
                          DATETIME,PKNAME,PKADD1,PKADD2,PKSUBR,PKADD4,PKPOST:
                          PKTELEP,PKTELEB,PKRELP,SP1
.
          GOTO      CACM9700 IF EOS              * e-Gate connection lost
          GOTO      CACM9500 IF OVER             * NAK returned from e-Gate
.
CACM9000  ADD       ONE,CACSENT
          DISPLAY   *P8:20,CACSENT;
          MOVE      ZERO,EXIT
          GOTO      CACM9999
.
CACM9500  ADD       ONE,CACFAIL
          DISPLAY   *P18:20,CACFAIL;
          MOVE      ONE,EXIT
          GOTO      CACM9999
.
CACM9700  MOVE      TWO,EXIT
.
CACM9999  RETURN
+
.******************************************************************************
.*                                  CCAM0000       Called by: RDIN0000        *
.*                       Write Cancel Admission Message                       *
.* Returns:  EXIT  0 = message sent ok                                        *
.*                 1 = message rejected                                       *
.*                 2 = e-Gate connection lost                                 *
.******************************************************************************
CCAM0000  MOVE      H7INMESI,KEY20
          CALL      RDPMQPT1                     * PMI details found ?
          BRANCH    OVRCD,CCAM9500               * no - error
.
          PACK      KEY22,H7INMESI,SP1,ONE
          CALL      RDPMQVI1                     * visit details found ?
          BRANCH    OVRCD,CCAM9500               * no - error
.
.         Format PMI coded fields for HL7
.
          CALL      LDOC0000                     * format local doctor
          CALL      GREL0000                     * format religion
          CALL      PCON0000                     * format patient COB
.
          MOVE      PFUNDH,FUNDCODE
          CALL      GFND0000                     * format health fund
          MOVE      FUNDDESC,PHFUNDD
.
          MOVE      PFUNDH,FUNDCODE
          MOVE      PFNDTB,TABLCODE
          CALL      GTBL0000                     * format fund table
          MOVE      TABLDESC,PHFTABD
.
.         Format Visit coded fields for HL7
.
          MOVE      ADOCTT,ATTDCODE
          CALL      ADOC0000                     * format attending doctor
          MOVE      ATTDDESC,ATTDOCT
.
          MOVE      TADOCT,CONSCODE
          CALL      GCON0000                     * format consultant
          MOVE      CONSDESC,CONSULT
.
          PACK      REFDCODE,PMVXRHC1,SP10
          CALL      GREF0000                     * format referring doctor
          MOVE      REFDDESC,REFDOCT
.
          MOVE      ASRCE,SRCECODE
          CALL      GSRC0000                     * format source of referral
          MOVE      SRCEDESC,SRCREFL
.
          MOVE      TDEPT,UNITCODE
          CALL      UNIT0000                     * format clinical unit
          MOVE      UNITDESC,CLIUNIT
.
          MOVE      ACLSS,ADMNCODE
          CALL      GTYP0000                     * format admission type
          MOVE      ADMNDESC,ADMTYPE
.
          MOVE      TATYPE,CLASCODE
          CALL      CLAS0000                     * format admission class
          MOVE      CLASDESC,ADMCLSS
.
          MOVE      TWARD,WARDCODE
          CALL      GWRD0000                     * format patient location
          MOVE      WARDDESC,PATWLOC
.
          MOVE      AFUNDH,FUNDCODE
          CALL      GFND0000                     * format health fund
          MOVE      FUNDDESC,AHFUNDD
.
          MOVE      AFUNDH,FUNDCODE
          MOVE      AFNDTB,TABLCODE
          CALL      GTBL0000                     * format fund table
          MOVE      TABLDESC,AHFTABD
.
          CALL      GDTM0000                     * get message date/time
          CALL      MEDI0000                     * format full medicare number
          CALL      GDVA0000                     * get DVA details
.
.         Write message
.
          MOVE      "CCA",MESSTYPE
          WRITE     DGATE;MESSTYPE,PURNO,CSALIAS,SP8,PTITL,PHOSP,PLDAYS:
                          PBDEBT,PSNAME,PGNAME,PPSNAME,PADD1,PADD2,PSUBRB,PADD4:
                          PPOST,PTELEP,PTELEB,PSEX,PMSTAT:
                          PBDATE,PATCONT,RELIGON:
                          PTYPE,POCCUP,PLDDATE,FULLMEDI,PPENNO,PPNDTE,DVADIM10:
                          PSMOK:
                          PMICRO,PCEASE,PCASE,PAUTOPY,PHIGH1,PHIGH2,PHIGH3:
                          PLOCDOC,PHFUNDD,PHFTABD,PFNDMM,PUSR1,PUSR2,PUSR3:
                          PUSR4,PUSR5,PUSR6,PUYN1,PUYN2,PUYN3,PYRRES:
                          PNKNAME,PNKADD1,PNKADD2,PNKSUBR,PNKADD4,PNKPOST:
                          PNKTELP,PNKTELB,PNKRELP,PFNDYY,PFNDCG,PDECDTE:
                          PDIET,PINITHOS,PHKADUNI,PTMAEMPC,PTMANOKO:
                          PTMANOKE,PTMADCNO,PTMXRDAT,PTMXMEAL,PTMXLGA:
                          PTMXLS,PTMXLSDT,PTMXFHMD,PTMXMHU1,PTMXMHU2:
                          PTMXMHU3,PTMXECNM,PTMXECA1,PTMXECA2,PTMXECA3:
                          PTMXECA4,PTMXECPC,PTMXECPP,PTMXECBP,PTMXECRE:
                          PTMXNRNM,PTMXNRA1,PTMXNRA2,PTMXNRA3,PTMXNRA4:
                          PTMXNRPC,PTMXNRPP,PTMXNRBP,PTMXNRRE,PTMX3BEX:
                          PTMXCARD,PTMXCEXP,PTMXCXMP,PTMXFMLY,PTMXCHNM:
                          PTMXDOFR,LOCDOCT,PMPXRH1G,PTMXSPID,PMPXR1GC:
                          PTMXOSDT,PTNINMPI:
                          NHMASURN,NHMAGIV1,NHMAGIV2,NHMAGIV3,NHMAPREI:
                          NHMAADD1,NHMAADD2,NHMAADD3,NHMAADD4,NHMAADD5:
                          NHMADOB,NHMADDTH,NHMADOMC,NHMARES,NHMAETH:
                          NHMASEX,NHMADAT,NHMATIM,NHMAETH2,NHMAETH3:
                          PTMXOPER,PTMXUKDO,PTMXCELL,PTMXADD1,PTMXADD2:
                          PTMXADD3,PTMXADD4,PTMXPOST:
                          AADMNO,ADATE,ATIME,AINVPRT:
                          ALACDTE,ACANCEL,ADOCTR,ADOCTL,SRCREFL,ADMTYPE:
                          ACARE,AHFUNDD,AHFTABD,AFNDMM,AELIG:
                          AVISIT,AALERG,AILLN,ADIAG1,ADIAG2:
                          ADISC,ATTDOCT,AALLOW,AMBS,ACLAIM,ADIET:
                          APLOCCR,ASTAY,ADYHOSP,AMEMB,AMEMBNO,ACOMM1:
                          ACOMM2,APLUR,APURGE,AUSR1,AUSR2,AUSR3,AUSR4:
                          AUSR5,AUSR6,AUSR7,ADSCHI,ARDRNAM,AFNDYY:
                          AFNDCG,AOCCDTE,ACODDTE,ARETDTE,AMUMADM:
                          PTMIPVIS,ABWGHT,REFDOCT,PMVXRH1G,PTMSFHAN:
                          PTMSECRA,PTMSMGIN,PTMIDDIG,PMVXRH1C,PTMIDOFR:
                          PTMIREFD,PTMIDFCN,PTMIPHPU,PTMIAGNC,PTMIESSF:
                          PTMIUSR8,PTMIUSR9,PTMIUSR0,PTMIPDRG,PTMIOPER:
                          PTMIXWRD,PTMIADOC,PTMIREGS,PTMIUYN1,PTMIUYN2:
                          PATWLOC,TBED,TRATEF,TRATEG,TDISC,TALLW,ADMCLSS:
                          CONSULT,TRATEH,TEXTRA,TRBTYP,TRBEND:
                          CLIUNIT,PTTRLTYP,PTTREPNO,DSNAME,DGNAME,DATETIME:
                          PKNAME,PKADD1,PKADD2,PKSUBR,PKADD4,PKPOST,PKTELEP:
                          PKTELEB,PKRELP,SP1
.
          GOTO      CCAM9700 IF EOS              * e-Gate connection lost
          GOTO      CCAM9500 IF OVER             * NAK returned from e-Gate
.
CCAM9000  ADD       ONE,CCASENT
          DISPLAY   *P8:21,CCASENT;
          MOVE      ZERO,EXIT
          GOTO      CCAM9999
.
CCAM9500  ADD       ONE,CCAFAIL
          DISPLAY   *P8:21,CCAFAIL;
          MOVE      ONE,EXIT
          GOTO      CCAM9999
.
CCAM9700  MOVE      TWO,EXIT
.
CCAM9999  RETURN
+
.******************************************************************************
.*                                  CDSM0000       Called by: RDIN0000        *
.*                       Write Discharge Message                              *
.* Returns:  EXIT  0 = message sent ok                                        *
.*                 1 = message rejected                                       *
.*                 2 = e-Gate connection lost                                 *
.******************************************************************************
CDSM0000  MOVE      H7INMESI,KEY20
          CALL      RDPMQPT1                     * PMI details found ?
          BRANCH    OVRCD,CDSM9500               * no - error
.
          PACK      KEY22,H7INMESI,SP1,ONE
          CALL      RDPMQVI1                     * visit details found ?
          BRANCH    OVRCD,CDSM9500               * no - error
.
.         Format PMI coded fields for HL7
.
          CALL      LDOC0000                     * format local doctor
          CALL      GREL0000                     * format religion
          CALL      PCON0000                     * format patient COB
.
          MOVE      PFUNDH,FUNDCODE
          CALL      GFND0000                     * format health fund
          MOVE      FUNDDESC,PHFUNDD
.
          MOVE      PFUNDH,FUNDCODE
          MOVE      PFNDTB,TABLCODE
          CALL      GTBL0000                     * format fund table
          MOVE      TABLDESC,PHFTABD
.
.         Format Visit coded fields for HL7
.
          MOVE      ADOCTT,ATTDCODE
          CALL      ADOC0000                     * format attending doctor
          MOVE      ATTDDESC,ATTDOCT
.
          MOVE      TADOCT,CONSCODE
          CALL      GCON0000                     * format consultant
          MOVE      CONSDESC,CONSULT
.
          PACK      REFDCODE,PMVXRHC1,SP10
          CALL      GREF0000                     * format referring doctor
          MOVE      REFDDESC,REFDOCT
.
          MOVE      ASRCE,SRCECODE
          CALL      GSRC0000                     * format source of referral
          MOVE      SRCEDESC,SRCREFL
.
          MOVE      TDEPT,UNITCODE
          CALL      UNIT0000                     * format clinical unit
          MOVE      UNITDESC,CLIUNIT
.
          MOVE      ACLSS,ADMNCODE
          CALL      GTYP0000                     * format admission type
          MOVE      ADMNDESC,ADMTYPE
.
          MOVE      TATYPE,CLASCODE
          CALL      CLAS0000                     * format admission class
          MOVE      CLASDESC,ADMCLSS
.
          MOVE      TWARD,WARDCODE
          CALL      GWRD0000                     * format patient location
          MOVE      WARDDESC,PATWLOC
.
          MOVE      AFUNDH,FUNDCODE
          CALL      GFND0000                     * format health fund
          MOVE      FUNDDESC,AHFUNDD
.
          MOVE      AFUNDH,FUNDCODE
          MOVE      AFNDTB,TABLCODE
          CALL      GTBL0000                     * format fund table
          MOVE      TABLDESC,AHFTABD
.
          CALL      GDTM0000                     * get message date/time
          CALL      MEDI0000                     * format full medicare number
          CALL      GDVA0000                     * get DVA details
.
.         Write message
.
          MOVE      "CDS",MESSTYPE
          WRITE     DGATE;MESSTYPE,PURNO,CSALIAS,SP8,PTITL,PHOSP,PLDAYS:
                          PBDEBT,PSNAME,PGNAME,PPSNAME,PADD1,PADD2,PSUBRB,PADD4:
                          PPOST,PTELEP,PTELEB,PSEX,PMSTAT:
                          PBDATE,PATCONT,RELIGON:
                          PTYPE,POCCUP,PLDDATE,FULLMEDI,PPENNO,PPNDTE,DVADIM10:
                          PSMOK:
                          PMICRO,PCEASE,PCASE,PAUTOPY,PHIGH1,PHIGH2,PHIGH3:
                          PLOCDOC,PHFUNDD,PHFTABD,PFNDMM,PUSR1,PUSR2,PUSR3:
                          PUSR4,PUSR5,PUSR6,PUYN1,PUYN2,PUYN3,PYRRES:
                          PNKNAME,PNKADD1,PNKADD2,PNKSUBR,PNKADD4,PNKPOST:
                          PNKTELP,PNKTELB,PNKRELP,PFNDYY,PFNDCG,PDECDTE:
                          PDIET,PINITHOS,PHKADUNI,PTMAEMPC,PTMANOKO:
                          PTMANOKE,PTMADCNO,PTMXRDAT,PTMXMEAL,PTMXLGA:
                          PTMXLS,PTMXLSDT,PTMXFHMD,PTMXMHU1,PTMXMHU2:
                          PTMXMHU3,PTMXECNM,PTMXECA1,PTMXECA2,PTMXECA3:
                          PTMXECA4,PTMXECPC,PTMXECPP,PTMXECBP,PTMXECRE:
                          PTMXNRNM,PTMXNRA1,PTMXNRA2,PTMXNRA3,PTMXNRA4:
                          PTMXNRPC,PTMXNRPP,PTMXNRBP,PTMXNRRE,PTMX3BEX:
                          PTMXCARD,PTMXCEXP,PTMXCXMP,PTMXFMLY,PTMXCHNM:
                          PTMXDOFR,LOCDOCT,PMPXRH1G,PTMXSPID,PMPXR1GC:
                          PTMXOSDT,PTNINMPI:
                          NHMASURN,NHMAGIV1,NHMAGIV2,NHMAGIV3,NHMAPREI:
                          NHMAADD1,NHMAADD2,NHMAADD3,NHMAADD4,NHMAADD5:
                          NHMADOB,NHMADDTH,NHMADOMC,NHMARES,NHMAETH:
                          NHMASEX,NHMADAT,NHMATIM,NHMAETH2,NHMAETH3:
                          PTMXOPER,PTMXUKDO,PTMXCELL,PTMXADD1,PTMXADD2:
                          PTMXADD3,PTMXADD4,PTMXPOST:
                          AADMNO,ADATE,ATIME,AINVPRT:
                          ALACDTE,ACANCEL,ADOCTR,ADOCTL,SRCREFL,ADMTYPE:
                          ACARE,AHFUNDD,AHFTABD,AFNDMM,AELIG:
                          AVISIT,AALERG,AILLN,ADIAG1,ADIAG2:
                          ADISC,ATTDOCT,AALLOW,AMBS,ACLAIM,ADIET:
                          APLOCCR,ASTAY,ADYHOSP,AMEMB,AMEMBNO,ACOMM1:
                          ACOMM2,APLUR,APURGE,AUSR1,AUSR2,AUSR3,AUSR4:
                          AUSR5,AUSR6,AUSR7,ADSCHI,ARDRNAM,AFNDYY:
                          AFNDCG,AOCCDTE,ACODDTE,ARETDTE,AMUMADM:
                          PTMIPVIS,ABWGHT,REFDOCT,PMVXRH1G,PTMSFHAN:
                          PTMSECRA,PTMSMGIN,PTMIDDIG,PMVXRH1C,PTMIDOFR:
                          PTMIREFD,PTMIDFCN,PTMIPHPU,PTMIAGNC,PTMIESSF:
                          PTMIUSR8,PTMIUSR9,PTMIUSR0,PTMIPDRG,PTMIOPER:
                          PTMIXWRD,PTMIADOC,PTMIREGS,PTMIUYN1,PTMIUYN2:
                          DDATE,DTIME,DSTAT,DDEST,DDIAG,DDIAG2,DUSD1:
                          DUSD2,DUSD3,DUSD4,DUSD5,DFMBS,PTDSDMDC,PTDSDDRG:
                          DWLREASN,PTDSSIDX,PTDSVOGU,PTDSOPER:
                          PTDSUYN1,PTDSUYN2,PTDSUYN3,PTDSUYN4:
                          PATWLOC,TBED,TRATEF,TRATEG,TDISC,TALLW,ADMCLSS:
                          CONSULT,TRATEH,TEXTRA,TRBTYP,TRBEND:
                          CLIUNIT,PTTRLTYP,PTTREPNO,DSNAME,DGNAME,DATETIME:
                          PKNAME,PKADD1,PKADD2,PKSUBR,PKADD4,PKPOST,PKTELEP:
                          PKTELEB,PKRELP,SP1
.
          GOTO      CDSM9700 IF EOS              * e-Gate connection lost
          GOTO      CDSM9500 IF OVER             * NAK returned from e-Gate
.
CDSM9000  ADD       ONE,CDSSENT
          DISPLAY   *P35:9,CDSSENT;
          MOVE      ZERO,EXIT
          GOTO      CDSM9999
.
CDSM9500  ADD       ONE,CDSFAIL
          DISPLAY   *P44:9,CDSFAIL;
          MOVE      ONE,EXIT
          GOTO      CDSM9999
.
CDSM9700  MOVE      TWO,EXIT
.
CDSM9999  RETURN
+
.******************************************************************************
.*                                  CDCM0000       Called by: RDIN0000        *
.*                       Write Change Discharge Details Message               *
.* Returns:  EXIT  0 = message sent ok                                        *
.*                 1 = message rejected                                       *
.*                 2 = e-Gate connection lost                                 *
.******************************************************************************
CDCM0000  MOVE      H7INMESI,KEY20
          CALL      RDPMQPT1                     * PMI details found ?
          BRANCH    OVRCD,CDCM9500               * no - error
.
          PACK      KEY22,H7INMESI,SP1,ONE
          CALL      RDPMQVI1                     * visit details found ?
          BRANCH    OVRCD,CDCM9500               * no - error
.
.         Format PMI coded fields for HL7
.
          CALL      LDOC0000                     * format local doctor
          CALL      GREL0000                     * format religion
          CALL      PCON0000                     * format patient COB
.
          MOVE      PFUNDH,FUNDCODE
          CALL      GFND0000                     * format health fund
          MOVE      FUNDDESC,PHFUNDD
.
          MOVE      PFUNDH,FUNDCODE
          MOVE      PFNDTB,TABLCODE
          CALL      GTBL0000                     * format fund table
          MOVE      TABLDESC,PHFTABD
.
.         Format Visit coded fields for HL7
.
          MOVE      ADOCTT,ATTDCODE
          CALL      ADOC0000                     * format attending doctor
          MOVE      ATTDDESC,ATTDOCT
.
          MOVE      TADOCT,CONSCODE
          CALL      GCON0000                     * format consultant
          MOVE      CONSDESC,CONSULT
.
          PACK      REFDCODE,PMVXRHC1,SP10
          CALL      GREF0000                     * format referring doctor
          MOVE      REFDDESC,REFDOCT
.
          MOVE      ASRCE,SRCECODE
          CALL      GSRC0000                     * format source of referral
          MOVE      SRCEDESC,SRCREFL
.
          MOVE      TDEPT,UNITCODE
          CALL      UNIT0000                     * format clinical unit
          MOVE      UNITDESC,CLIUNIT
.
          MOVE      ACLSS,ADMNCODE
          CALL      GTYP0000                     * format admission type
          MOVE      ADMNDESC,ADMTYPE
.
          MOVE      TATYPE,CLASCODE
          CALL      CLAS0000                     * format admission class
          MOVE      CLASDESC,ADMCLSS
.
          MOVE      TWARD,WARDCODE
          CALL      GWRD0000                     * format patient location
          MOVE      WARDDESC,PATWLOC
.
          MOVE      AFUNDH,FUNDCODE
          CALL      GFND0000                     * format health fund
          MOVE      FUNDDESC,AHFUNDD
.
          MOVE      AFUNDH,FUNDCODE
          MOVE      AFNDTB,TABLCODE
          CALL      GTBL0000                     * format fund table
          MOVE      TABLDESC,AHFTABD
.
          CALL      GDTM0000                     * get message date/time
          CALL      MEDI0000                     * format full medicare number
          CALL      GDVA0000                     * get DVA details
.
.         Write message
.
          MOVE      "CDC",MESSTYPE
          WRITE     DGATE;MESSTYPE,PURNO,CSALIAS,SP8,PTITL,PHOSP,PLDAYS:
                          PBDEBT,PSNAME,PGNAME,PPSNAME,PADD1,PADD2,PSUBRB,PADD4:
                          PPOST,PTELEP,PTELEB,PSEX,PMSTAT:
                          PBDATE,PATCONT,RELIGON:
                          PTYPE,POCCUP,PLDDATE,FULLMEDI,PPENNO,PPNDTE,DVADIM10:
                          PSMOK:
                          PMICRO,PCEASE,PCASE,PAUTOPY,PHIGH1,PHIGH2,PHIGH3:
                          PLOCDOC,PHFUNDD,PHFTABD,PFNDMM,PUSR1,PUSR2,PUSR3:
                          PUSR4,PUSR5,PUSR6,PUYN1,PUYN2,PUYN3,PYRRES:
                          PNKNAME,PNKADD1,PNKADD2,PNKSUBR,PNKADD4,PNKPOST:
                          PNKTELP,PNKTELB,PNKRELP,PFNDYY,PFNDCG,PDECDTE:
                          PDIET,PINITHOS,PHKADUNI,PTMAEMPC,PTMANOKO:
                          PTMANOKE,PTMADCNO,PTMXRDAT,PTMXMEAL,PTMXLGA:
                          PTMXLS,PTMXLSDT,PTMXFHMD,PTMXMHU1,PTMXMHU2:
                          PTMXMHU3,PTMXECNM,PTMXECA1,PTMXECA2,PTMXECA3:
                          PTMXECA4,PTMXECPC,PTMXECPP,PTMXECBP,PTMXECRE:
                          PTMXNRNM,PTMXNRA1,PTMXNRA2,PTMXNRA3,PTMXNRA4:
                          PTMXNRPC,PTMXNRPP,PTMXNRBP,PTMXNRRE,PTMX3BEX:
                          PTMXCARD,PTMXCEXP,PTMXCXMP,PTMXFMLY,PTMXCHNM:
                          PTMXDOFR,LOCDOCT,PMPXRH1G,PTMXSPID,PMPXR1GC:
                          PTMXOSDT,PTNINMPI:
                          NHMASURN,NHMAGIV1,NHMAGIV2,NHMAGIV3,NHMAPREI:
                          NHMAADD1,NHMAADD2,NHMAADD3,NHMAADD4,NHMAADD5:
                          NHMADOB,NHMADDTH,NHMADOMC,NHMARES,NHMAETH:
                          NHMASEX,NHMADAT,NHMATIM,NHMAETH2,NHMAETH3:
                          PTMXOPER,PTMXUKDO,PTMXCELL,PTMXADD1,PTMXADD2:
                          PTMXADD3,PTMXADD4,PTMXPOST:
                          AADMNO,ADATE,ATIME,AINVPRT:
                          ALACDTE,ACANCEL,ADOCTR,ADOCTL,SRCREFL,ADMTYPE:
                          ACARE,AHFUNDD,AHFTABD,AFNDMM,AELIG:
                          AVISIT,AALERG,AILLN,ADIAG1,ADIAG2:
                          ADISC,ATTDOCT,AALLOW,AMBS,ACLAIM,ADIET:
                          APLOCCR,ASTAY,ADYHOSP,AMEMB,AMEMBNO,ACOMM1:
                          ACOMM2,APLUR,APURGE,AUSR1,AUSR2,AUSR3,AUSR4:
                          AUSR5,AUSR6,AUSR7,ADSCHI,ARDRNAM,AFNDYY:
                          AFNDCG,AOCCDTE,ACODDTE,ARETDTE,AMUMADM:
                          PTMIPVIS,ABWGHT,REFDOCT,PMVXRH1G,PTMSFHAN:
                          PTMSECRA,PTMSMGIN,PTMIDDIG,PMVXRH1C,PTMIDOFR:
                          PTMIREFD,PTMIDFCN,PTMIPHPU,PTMIAGNC,PTMIESSF:
                          PTMIUSR8,PTMIUSR9,PTMIUSR0,PTMIPDRG,PTMIOPER:
                          PTMIXWRD,PTMIADOC,PTMIREGS,PTMIUYN1,PTMIUYN2:
                          DDATE,DTIME,DSTAT,DDEST,DDIAG,DDIAG2,DUSD1:
                          DUSD2,DUSD3,DUSD4,DUSD5,DFMBS,PTDSDMDC,PTDSDDRG:
                          DWLREASN,PTDSSIDX,PTDSVOGU,PTDSOPER:
                          PTDSUYN1,PTDSUYN2,PTDSUYN3,PTDSUYN4:
                          PATWLOC,TBED,TRATEF,TRATEG,TDISC,TALLW,ADMCLSS:
                          CONSULT,TRATEH,TEXTRA,TRBTYP,TRBEND:
                          CLIUNIT,PTTRLTYP,PTTREPNO,DSNAME,DGNAME,DATETIME:
                          PKNAME,PKADD1,PKADD2,PKSUBR,PKADD4,PKPOST,PKTELEP:
                          PKTELEB,PKRELP,SP1
.
          GOTO      CDCM9700 IF EOS              * e-Gate connection lost
          GOTO      CDCM9500 IF OVER             * NAK returned from e-Gate
.
CDCM9000  ADD       ONE,CDCSENT
          DISPLAY   *P35:10,CDCSENT;
          MOVE      ZERO,EXIT
          GOTO      CDCM9999
.
CDCM9500  ADD       ONE,CDCFAIL
          DISPLAY   *P44:10,CDCFAIL;
          MOVE      ONE,EXIT
          GOTO      CDCM9999
.
CDCM9700  MOVE      TWO,EXIT
.
CDCM9999  RETURN
+
.******************************************************************************
.*                                  CCDM0000       Called by: RDIN0000        *
.*                       Write Cancel Discharge Message                       *
.* Returns:  EXIT  0 = message sent ok                                        *
.*                 1 = message rejected                                       *
.*                 2 = e-Gate connection lost                                 *
.******************************************************************************
CCDM0000  MOVE      H7INMESI,KEY20
          CALL      RDPMQPT1                     * PMI details found ?
          BRANCH    OVRCD,CCDM9500               * no - error
.
          PACK      KEY22,H7INMESI,SP1,ONE
          CALL      RDPMQVI1                     * visit details found ?
          BRANCH    OVRCD,CCDM9500               * no - error
.
.         Format PMI coded fields for HL7
.
          CALL      LDOC0000                     * format local doctor
          CALL      GREL0000                     * format religion
          CALL      PCON0000                     * format patient COB
.
          MOVE      PFUNDH,FUNDCODE
          CALL      GFND0000                     * format health fund
          MOVE      FUNDDESC,PHFUNDD
.
          MOVE      PFUNDH,FUNDCODE
          MOVE      PFNDTB,TABLCODE
          CALL      GTBL0000                     * format fund table
          MOVE      TABLDESC,PHFTABD
.
.         Format Visit coded fields for HL7
.
          MOVE      ADOCTT,ATTDCODE
          CALL      ADOC0000                     * format attending doctor
          MOVE      ATTDDESC,ATTDOCT
.
          MOVE      TADOCT,CONSCODE
          CALL      GCON0000                     * format consultant
          MOVE      CONSDESC,CONSULT
.
          PACK      REFDCODE,PMVXRHC1,SP10
          CALL      GREF0000                     * format referring doctor
          MOVE      REFDDESC,REFDOCT
.
          MOVE      ASRCE,SRCECODE
          CALL      GSRC0000                     * format source of referral
          MOVE      SRCEDESC,SRCREFL
.
          MOVE      TDEPT,UNITCODE
          CALL      UNIT0000                     * format clinical unit
          MOVE      UNITDESC,CLIUNIT
.
          MOVE      ACLSS,ADMNCODE
          CALL      GTYP0000                     * format admission type
          MOVE      ADMNDESC,ADMTYPE
.
          MOVE      TATYPE,CLASCODE
          CALL      CLAS0000                     * format admission class
          MOVE      CLASDESC,ADMCLSS
.
          MOVE      TWARD,WARDCODE
          CALL      GWRD0000                     * format patient location
          MOVE      WARDDESC,PATWLOC
.
          MOVE      AFUNDH,FUNDCODE
          CALL      GFND0000                     * format health fund
          MOVE      FUNDDESC,AHFUNDD
.
          MOVE      AFUNDH,FUNDCODE
          MOVE      AFNDTB,TABLCODE
          CALL      GTBL0000                     * format fund table
          MOVE      TABLDESC,AHFTABD
.
          CALL      GDTM0000                     * get message date/time
          CALL      MEDI0000                     * format full medicare number
          CALL      GDVA0000                     * get DVA details
.
.         Write message
.
          MOVE      "CCD",MESSTYPE
          WRITE     DGATE;MESSTYPE,PURNO,CSALIAS,SP8,PTITL,PHOSP,PLDAYS:
                          PBDEBT,PSNAME,PGNAME,PPSNAME,PADD1,PADD2,PSUBRB,PADD4:
                          PPOST,PTELEP,PTELEB,PSEX,PMSTAT:
                          PBDATE,PATCONT,RELIGON:                         
                          PTYPE,POCCUP,PLDDATE,FULLMEDI,PPENNO,PPNDTE,DVADIM10:
                          PSMOK:
                          PMICRO,PCEASE,PCASE,PAUTOPY,PHIGH1,PHIGH2,PHIGH3:
                          PLOCDOC,PHFUNDD,PHFTABD,PFNDMM,PUSR1,PUSR2,PUSR3:
                          PUSR4,PUSR5,PUSR6,PUYN1,PUYN2,PUYN3,PYRRES:
                          PNKNAME,PNKADD1,PNKADD2,PNKSUBR,PNKADD4,PNKPOST:
                          PNKTELP,PNKTELB,PNKRELP,PFNDYY,PFNDCG,PDECDTE:
                          PDIET,PINITHOS,PHKADUNI,PTMAEMPC,PTMANOKO:
                          PTMANOKE,PTMADCNO,PTMXRDAT,PTMXMEAL,PTMXLGA:
                          PTMXLS,PTMXLSDT,PTMXFHMD,PTMXMHU1,PTMXMHU2:
                          PTMXMHU3,PTMXECNM,PTMXECA1,PTMXECA2,PTMXECA3:
                          PTMXECA4,PTMXECPC,PTMXECPP,PTMXECBP,PTMXECRE:
                          PTMXNRNM,PTMXNRA1,PTMXNRA2,PTMXNRA3,PTMXNRA4:
                          PTMXNRPC,PTMXNRPP,PTMXNRBP,PTMXNRRE,PTMX3BEX:
                          PTMXCARD,PTMXCEXP,PTMXCXMP,PTMXFMLY,PTMXCHNM:
                          PTMXDOFR,LOCDOCT,PMPXRH1G,PTMXSPID,PMPXR1GC:
                          PTMXOSDT,PTNINMPI:
                          NHMASURN,NHMAGIV1,NHMAGIV2,NHMAGIV3,NHMAPREI:
                          NHMAADD1,NHMAADD2,NHMAADD3,NHMAADD4,NHMAADD5:
                          NHMADOB,NHMADDTH,NHMADOMC,NHMARES,NHMAETH:
                          NHMASEX,NHMADAT,NHMATIM,NHMAETH2,NHMAETH3:
                          PTMXOPER,PTMXUKDO,PTMXCELL,PTMXADD1,PTMXADD2:
                          PTMXADD3,PTMXADD4,PTMXPOST:
                          AADMNO,ADATE,ATIME,AINVPRT:
                          ALACDTE,ACANCEL,ADOCTR,ADOCTL,SRCREFL,ADMTYPE:
                          ACARE,AHFUNDD,AHFTABD,AFNDMM,AELIG:
                          AVISIT,AALERG,AILLN,ADIAG1,ADIAG2:
                          ADISC,ATTDOCT,AALLOW,AMBS,ACLAIM,ADIET:
                          APLOCCR,ASTAY,ADYHOSP,AMEMB,AMEMBNO,ACOMM1:
                          ACOMM2,APLUR,APURGE,AUSR1,AUSR2,AUSR3,AUSR4:
                          AUSR5,AUSR6,AUSR7,ADSCHI,ARDRNAM,AFNDYY:
                          AFNDCG,AOCCDTE,ACODDTE,ARETDTE,AMUMADM:
                          PTMIPVIS,ABWGHT,REFDOCT,PMVXRH1G,PTMSFHAN:
                          PTMSECRA,PTMSMGIN,PTMIDDIG,PMVXRH1C,PTMIDOFR:
                          PTMIREFD,PTMIDFCN,PTMIPHPU,PTMIAGNC,PTMIESSF:
                          PTMIUSR8,PTMIUSR9,PTMIUSR0,PTMIPDRG,PTMIOPER:
                          PTMIXWRD,PTMIADOC,PTMIREGS,PTMIUYN1,PTMIUYN2:
                          DDATE,DTIME,DSTAT,DDEST,DDIAG,DDIAG2,DUSD1:
                          DUSD2,DUSD3,DUSD4,DUSD5,DFMBS,PTDSDMDC,PTDSDDRG:
                          DWLREASN,PTDSSIDX,PTDSVOGU,PTDSOPER:
                          PTDSUYN1,PTDSUYN2,PTDSUYN3,PTDSUYN4:
                          PATWLOC,TBED,TRATEF,TRATEG,TDISC,TALLW,ADMCLSS:
                          CONSULT,TRATEH,TEXTRA,TRBTYP,TRBEND:
                          CLIUNIT,PTTRLTYP,PTTREPNO,DSNAME,DGNAME,DATETIME:
                          PKNAME,PKADD1,PKADD2,PKSUBR,PKADD4,PKPOST,PKTELEP:
                          PKTELEB,PKRELP,SP1
.
          GOTO      CCDM9700 IF EOS              * e-Gate connection lost
          GOTO      CCDM9500 IF OVER             * NAK returned from e-Gate
.
CCDM9000  ADD       ONE,CCDSENT
          DISPLAY   *P35:11,CCDSENT;
          MOVE      ZERO,EXIT
          GOTO      CCDM9999
.
CCDM9500  ADD       ONE,CCDFAIL
          DISPLAY   *P44:11,CCDFAIL;
          MOVE      ONE,EXIT
          GOTO      CCDM9999
.
CCDM9700  MOVE      TWO,EXIT
.
CCDM9999  RETURN
+
.******************************************************************************
.*                                  CTRM0000       Called by: RDIN0000        *
.*                       Write Transfer Message                               *
.* Returns:  EXIT  0 = message sent ok                                        *
.*                 1 = message rejected                                       *
.*                 2 = e-Gate connection lost                                 *
.******************************************************************************
.
.         Read the previous tran details first
.
CTRM0000  PACK      KEY22,H7INMESI,SP1,TWO
          CALL      RDPMQVI1                     * visit details found ?
          BRANCH    OVRCD,CTRM9500               * no - error
.
.         Load last tran variables
.
          MOVE      TBED,LBED
          MOVE      TRATEF,LRATEF
          MOVE      TRATEG,LRATEG
          MOVE      TDISC,LDISC
          MOVE      TALLW,LALLW
          MOVE      TRATEH,LRATEH
          MOVE      TEXTRA,LEXTRA
          MOVE      TRBTYP,LRBTYP
          MOVE      TRBEND,LRBEND
          MOVE      TCHSTAT,LCHSTAT
          MOVE      PTTRLTYP,LTTRLTYP
          MOVE      PTTREPNO,LTTREPNO
.
.         Format Visit coded fields for HL7 (previous tran record)
.
          MOVE      TADOCT,CONSCODE
          CALL      GCON0000                     * format consultant
          MOVE      CONSDESC,LCONSULT
.
          MOVE      TDEPT,UNITCODE
          CALL      UNIT0000                     * format clinical unit
          MOVE      UNITDESC,LCLIUNIT
.
          MOVE      TATYPE,CLASCODE
          CALL      CLAS0000                     * format admission class
          MOVE      CLASDESC,LADMCLSS
.
          MOVE      TWARD,WARDCODE
          CALL      GWRD0000                     * format patient location
          MOVE      WARDDESC,LPATWLOC
.
.         Read PMI and current visit details
.
          MOVE      H7INMESI,KEY20
          CALL      RDPMQPT1                     * PMI details found ?
          BRANCH    OVRCD,CTRM9500               * no - error
.
          PACK      KEY22,H7INMESI,SP1,ONE
          CALL      RDPMQVI1                     * visit details found ?
          BRANCH    OVRCD,CTRM9500               * no - error
.
.         Format PMI coded fields for HL7
.
          CALL      LDOC0000                     * format local doctor
          CALL      GREL0000                     * format religion
          CALL      PCON0000                     * format patient COB
.
          MOVE      PFUNDH,FUNDCODE
          CALL      GFND0000                     * format health fund
          MOVE      FUNDDESC,PHFUNDD
.
          MOVE      PFUNDH,FUNDCODE
          MOVE      PFNDTB,TABLCODE
          CALL      GTBL0000                     * format fund table
          MOVE      TABLDESC,PHFTABD
.
.         Format Visit coded fields for HL7 (current tran record)
.
          MOVE      ADOCTT,ATTDCODE
          CALL      ADOC0000                     * format attending doctor
          MOVE      ATTDDESC,ATTDOCT
.
          MOVE      TADOCT,CONSCODE
          CALL      GCON0000                     * format consultant
          MOVE      CONSDESC,CONSULT
.
          PACK      REFDCODE,PMVXRHC1,SP10
          CALL      GREF0000                     * format referring doctor
          MOVE      REFDDESC,REFDOCT
.
          MOVE      ASRCE,SRCECODE
          CALL      GSRC0000                     * format source of referral
          MOVE      SRCEDESC,SRCREFL
.
          MOVE      TDEPT,UNITCODE
          CALL      UNIT0000                     * format clinical unit
          MOVE      UNITDESC,CLIUNIT
.
          MOVE      ACLSS,ADMNCODE
          CALL      GTYP0000                     * format admission type
          MOVE      ADMNDESC,ADMTYPE
.
          MOVE      TATYPE,CLASCODE
          CALL      CLAS0000                     * format admission class
          MOVE      CLASDESC,ADMCLSS
.
          MOVE      TWARD,WARDCODE
          CALL      GWRD0000                     * format patient location
          MOVE      WARDDESC,PATWLOC
.
          MOVE      AFUNDH,FUNDCODE
          CALL      GFND0000                     * format health fund
          MOVE      FUNDDESC,AHFUNDD
.
          MOVE      AFUNDH,FUNDCODE
          MOVE      AFNDTB,TABLCODE
          CALL      GTBL0000                     * format fund table
          MOVE      TABLDESC,AHFTABD
.
          CALL      GDTM0000                     * get message date/time
          CALL      MEDI0000                     * format full medicare number
          CALL      GDVA0000                     * get DVA details
.
.         Write message
.
          MOVE      "CTR",MESSTYPE
          WRITE     DGATE;MESSTYPE,PURNO,CSALIAS,SP8,PTITL,PHOSP,PLDAYS:
                          PBDEBT,PSNAME,PGNAME,PPSNAME,PADD1,PADD2,PSUBRB,PADD4:
                          PPOST,PTELEP,PTELEB,PSEX,PMSTAT:
                          PBDATE,PATCONT,RELIGON:
                          PTYPE,POCCUP,PLDDATE,FULLMEDI,PPENNO,PPNDTE,DVADIM10:
                          PSMOK:
                          PMICRO,PCEASE,PCASE,PAUTOPY,PHIGH1,PHIGH2,PHIGH3:
                          PLOCDOC,PHFUNDD,PHFTABD,PFNDMM,PUSR1,PUSR2,PUSR3:
                          PUSR4,PUSR5,PUSR6,PUYN1,PUYN2,PUYN3,PYRRES:
                          PNKNAME,PNKADD1,PNKADD2,PNKSUBR,PNKADD4,PNKPOST:
                          PNKTELP,PNKTELB,PNKRELP,PFNDYY,PFNDCG,PDECDTE:
                          PDIET,PINITHOS,PHKADUNI,PTMAEMPC,PTMANOKO:
                          PTMANOKE,PTMADCNO,PTMXRDAT,PTMXMEAL,PTMXLGA:
                          PTMXLS,PTMXLSDT,PTMXFHMD,PTMXMHU1,PTMXMHU2:
                          PTMXMHU3,PTMXECNM,PTMXECA1,PTMXECA2,PTMXECA3:
                          PTMXECA4,PTMXECPC,PTMXECPP,PTMXECBP,PTMXECRE:
                          PTMXNRNM,PTMXNRA1,PTMXNRA2,PTMXNRA3,PTMXNRA4:
                          PTMXNRPC,PTMXNRPP,PTMXNRBP,PTMXNRRE,PTMX3BEX:
                          PTMXCARD,PTMXCEXP,PTMXCXMP,PTMXFMLY,PTMXCHNM:
                          PTMXDOFR,LOCDOCT,PMPXRH1G,PTMXSPID,PMPXR1GC:
                          PTMXOSDT,PTNINMPI:
                          NHMASURN,NHMAGIV1,NHMAGIV2,NHMAGIV3,NHMAPREI:
                          NHMAADD1,NHMAADD2,NHMAADD3,NHMAADD4,NHMAADD5:
                          NHMADOB,NHMADDTH,NHMADOMC,NHMARES,NHMAETH:
                          NHMASEX,NHMADAT,NHMATIM,NHMAETH2,NHMAETH3:
                          PTMXOPER,PTMXUKDO,PTMXCELL,PTMXADD1,PTMXADD2:
                          PTMXADD3,PTMXADD4,PTMXPOST:
                          AADMNO,ADATE,ATIME,AINVPRT:
                          ALACDTE,ACANCEL,ADOCTR,ADOCTL,SRCREFL,ADMTYPE:
                          ACARE,AHFUNDD,AHFTABD,AFNDMM,AELIG:
                          AVISIT,AALERG,AILLN,ADIAG1,ADIAG2:
                          ADISC,ATTDOCT,AALLOW,AMBS,ACLAIM,ADIET:
                          APLOCCR,ASTAY,ADYHOSP,AMEMB,AMEMBNO,ACOMM1:
                          ACOMM2,APLUR,APURGE,AUSR1,AUSR2,AUSR3,AUSR4:
                          AUSR5,AUSR6,AUSR7,ADSCHI,ARDRNAM,AFNDYY:
                          AFNDCG,AOCCDTE,ACODDTE,ARETDTE,AMUMADM:
                          PTMIPVIS,ABWGHT,REFDOCT,PMVXRH1G,PTMSFHAN:
                          PTMSECRA,PTMSMGIN,PTMIDDIG,PMVXRH1C,PTMIDOFR:
                          PTMIREFD,PTMIDFCN,PTMIPHPU,PTMIAGNC,PTMIESSF:
                          PTMIUSR8,PTMIUSR9,PTMIUSR0,PTMIPDRG,PTMIOPER:
                          PTMIXWRD,PTMIADOC,PTMIREGS,PTMIUYN1,PTMIUYN2:
                          LPATWLOC,LBED,LRATEF,LRATEG,LDISC,LALLW,LADMCLSS:
                          LCONSULT,LRATEH,LEXTRA,LRBTYP,LRBEND:
                          LCHSTAT,LCLIUNIT,LTTRLTYP,LTTREPNO:
                          PATWLOC,TBED,TRATEF,TRATEG,TDISC,TALLW,ADMCLSS:
                          CONSULT,TRATEH,TEXTRA,TRBTYP,TRBEND:
                          TCHSTAT,CLIUNIT,PTTRLTYP,PTTREPNO,DSNAME,DGNAME:
                          TDATE,TTIME,DATETIME,PKNAME,PKADD1,PKADD2,PKSUBR:
                          PKADD4,PKPOST,PKTELEP,PKTELEB,PKRELP,SP1
.
          GOTO      CTRM9700 IF EOS              * e-Gate connection lost
          GOTO      CTRM9500 IF OVER             * NAK returned from e-Gate
.
CTRM9000  ADD       ONE,CTRSENT
          DISPLAY   *P8:22,CTRSENT;
          MOVE      ZERO,EXIT
          GOTO      CTRM9999
.
CTRM9500  ADD       ONE,CTRFAIL
          DISPLAY   *P18:22,CTRFAIL;
          MOVE      ONE,EXIT
          GOTO      CTRM9999
.
CTRM9700  MOVE      TWO,EXIT
.
CTRM9999  RETURN
+
.******************************************************************************
.*                                  CCTM0000       Called by: RDIN0000        *
.*                       Write Cancel Transfer Message                        *
.* Returns:  EXIT  0 = message sent ok                                        *
.*                 1 = message rejected                                       *
.*                 2 = e-Gate connection lost                                 *
.******************************************************************************
.
.         Read the previous tran details first
.
CCTM0000  PACK      KEY22,H7INMESI,SP1,TWO
          CALL      RDPMQVI1                     * visit details found ?
          BRANCH    OVRCD,CCTM9500               * no - error
.
.         Load last tran variables
.
          MOVE      TBED,LBED
          MOVE      TRATEF,LRATEF
          MOVE      TRATEG,LRATEG
          MOVE      TDISC,LDISC
          MOVE      TALLW,LALLW
          MOVE      TRATEH,LRATEH
          MOVE      TEXTRA,LEXTRA
          MOVE      TRBTYP,LRBTYP
          MOVE      TRBEND,LRBEND
          MOVE      TCHSTAT,LCHSTAT
          MOVE      PTTRLTYP,LTTRLTYP
          MOVE      PTTREPNO,LTTREPNO
.
.         Format Visit coded fields for HL7 (previous tran record)
.
          MOVE      TADOCT,CONSCODE
          CALL      GCON0000                     * format consultant
          MOVE      CONSDESC,LCONSULT
.
          MOVE      TDEPT,UNITCODE
          CALL      UNIT0000                     * format clinical unit
          MOVE      UNITDESC,LCLIUNIT
.
          MOVE      TATYPE,CLASCODE
          CALL      CLAS0000                     * format admission class
          MOVE      CLASDESC,LADMCLSS
.
          MOVE      TWARD,WARDCODE
          CALL      GWRD0000                     * format patient location
          MOVE      WARDDESC,LPATWLOC
.
.         Get current PMI & Visit details
.
          MOVE      H7INMESI,KEY20
          CALL      RDPMQPT1                     * PMI details found ?
          BRANCH    OVRCD,CCTM9500               * no - error
.
          PACK      KEY22,H7INMESI,SP1,ONE
          CALL      RDPMQVI1                     * visit details found ?
          BRANCH    OVRCD,CCTM9500               * no - error
.
.         Format PMI coded fields for HL7
.
          CALL      LDOC0000                     * format local doctor
          CALL      GREL0000                     * format religion
          CALL      PCON0000                     * format patient COB
.
          MOVE      PFUNDH,FUNDCODE
          CALL      GFND0000                     * format health fund
          MOVE      FUNDDESC,PHFUNDD
.
          MOVE      PFUNDH,FUNDCODE
          MOVE      PFNDTB,TABLCODE
          CALL      GTBL0000                     * format fund table
          MOVE      TABLDESC,PHFTABD
.
.         Format Visit coded fields for HL7 (current tran record)
.
          MOVE      ADOCTT,ATTDCODE
          CALL      ADOC0000                     * format attending doctor
          MOVE      ATTDDESC,ATTDOCT
.
          MOVE      TADOCT,CONSCODE
          CALL      GCON0000                     * format consultant
          MOVE      CONSDESC,CONSULT
.
          PACK      REFDCODE,PMVXRHC1,SP10
          CALL      GREF0000                     * format referring doctor
          MOVE      REFDDESC,REFDOCT
.
          MOVE      ASRCE,SRCECODE
          CALL      GSRC0000                     * format source of referral
          MOVE      SRCEDESC,SRCREFL
.
          MOVE      TDEPT,UNITCODE
          CALL      UNIT0000                     * format clinical unit
          MOVE      UNITDESC,CLIUNIT
.
          MOVE      ACLSS,ADMNCODE
          CALL      GTYP0000                     * format admission type
          MOVE      ADMNDESC,ADMTYPE
.
          MOVE      TATYPE,CLASCODE
          CALL      CLAS0000                     * format admission class
          MOVE      CLASDESC,ADMCLSS
.
          MOVE      TWARD,WARDCODE
          CALL      GWRD0000                     * format patient location
          MOVE      WARDDESC,PATWLOC
.
          MOVE      AFUNDH,FUNDCODE
          CALL      GFND0000                     * format health fund
          MOVE      FUNDDESC,AHFUNDD
.
          MOVE      AFUNDH,FUNDCODE
          MOVE      AFNDTB,TABLCODE
          CALL      GTBL0000                     * format fund table
          MOVE      TABLDESC,AHFTABD
.
          CALL      GDTM0000                     * get message date/time
          CALL      MEDI0000                     * format full medicare number
          CALL      GDVA0000                     * get DVA details
.
.         Write message
.
          MOVE      "CCT",MESSTYPE
          WRITE     DGATE;MESSTYPE,PURNO,CSALIAS,SP8,PTITL,PHOSP,PLDAYS:
                          PBDEBT,PSNAME,PGNAME,PPSNAME,PADD1,PADD2,PSUBRB,PADD4:
                          PPOST,PTELEP,PTELEB,PSEX,PMSTAT:
                          PBDATE,PATCONT,RELIGON:
                          PTYPE,POCCUP,PLDDATE,FULLMEDI,PPENNO,PPNDTE,DVADIM10:
                          PSMOK:
                          PMICRO,PCEASE,PCASE,PAUTOPY,PHIGH1,PHIGH2,PHIGH3:
                          PLOCDOC,PHFUNDD,PHFTABD,PFNDMM,PUSR1,PUSR2,PUSR3:
                          PUSR4,PUSR5,PUSR6,PUYN1,PUYN2,PUYN3,PYRRES:
                          PNKNAME,PNKADD1,PNKADD2,PNKSUBR,PNKADD4,PNKPOST:
                          PNKTELP,PNKTELB,PNKRELP,PFNDYY,PFNDCG,PDECDTE:
                          PDIET,PINITHOS,PHKADUNI,PTMAEMPC,PTMANOKO:
                          PTMANOKE,PTMADCNO,PTMXRDAT,PTMXMEAL,PTMXLGA:
                          PTMXLS,PTMXLSDT,PTMXFHMD,PTMXMHU1,PTMXMHU2:
                          PTMXMHU3,PTMXECNM,PTMXECA1,PTMXECA2,PTMXECA3:
                          PTMXECA4,PTMXECPC,PTMXECPP,PTMXECBP,PTMXECRE:
                          PTMXNRNM,PTMXNRA1,PTMXNRA2,PTMXNRA3,PTMXNRA4:
                          PTMXNRPC,PTMXNRPP,PTMXNRBP,PTMXNRRE,PTMX3BEX:
                          PTMXCARD,PTMXCEXP,PTMXCXMP,PTMXFMLY,PTMXCHNM:
                          PTMXDOFR,LOCDOCT,PMPXRH1G,PTMXSPID,PMPXR1GC:
                          PTMXOSDT,PTNINMPI:
                          NHMASURN,NHMAGIV1,NHMAGIV2,NHMAGIV3,NHMAPREI:
                          NHMAADD1,NHMAADD2,NHMAADD3,NHMAADD4,NHMAADD5:
                          NHMADOB,NHMADDTH,NHMADOMC,NHMARES,NHMAETH:
                          NHMASEX,NHMADAT,NHMATIM,NHMAETH2,NHMAETH3:
                          PTMXOPER,PTMXUKDO,PTMXCELL,PTMXADD1,PTMXADD2:
                          PTMXADD3,PTMXADD4,PTMXPOST:
                          AADMNO,ADATE,ATIME,AINVPRT:
                          ALACDTE,ACANCEL,ADOCTR,ADOCTL,SRCREFL,ADMTYPE:
                          ACARE,AHFUNDD,AHFTABD,AFNDMM,AELIG:
                          AVISIT,AALERG,AILLN,ADIAG1,ADIAG2:
                          ADISC,ATTDOCT,AALLOW,AMBS,ACLAIM,ADIET:
                          APLOCCR,ASTAY,ADYHOSP,AMEMB,AMEMBNO,ACOMM1:
                          ACOMM2,APLUR,APURGE,AUSR1,AUSR2,AUSR3,AUSR4:
                          AUSR5,AUSR6,AUSR7,ADSCHI,ARDRNAM,AFNDYY:
                          AFNDCG,AOCCDTE,ACODDTE,ARETDTE,AMUMADM:
                          PTMIPVIS,ABWGHT,REFDOCT,PMVXRH1G,PTMSFHAN:
                          PTMSECRA,PTMSMGIN,PTMIDDIG,PMVXRH1C,PTMIDOFR:
                          PTMIREFD,PTMIDFCN,PTMIPHPU,PTMIAGNC,PTMIESSF:
                          PTMIUSR8,PTMIUSR9,PTMIUSR0,PTMIPDRG,PTMIOPER:
                          PTMIXWRD,PTMIADOC,PTMIREGS,PTMIUYN1,PTMIUYN2:
                          LPATWLOC,LBED,LRATEF,LRATEG,LDISC,LALLW,LADMCLSS:
                          LCONSULT,LRATEH,LEXTRA,LRBTYP,LRBEND:
                          LCHSTAT,LCLIUNIT,LTTRLTYP,LTTREPNO:
                          PATWLOC,TBED,TRATEF,TRATEG,TDISC,TALLW,ADMCLSS:
                          CONSULT,TRATEH,TEXTRA,TRBTYP,TRBEND:
                          TCHSTAT,CLIUNIT,PTTRLTYP,PTTREPNO,DSNAME,DGNAME:
                          TDATE,TTIME,DATETIME,PKNAME,PKADD1,PKADD2,PKSUBR:
                          PKADD4,PKPOST,PKTELEP,PKTELEB,PKRELP,SP1
.
          GOTO      CCTM9700 IF EOS              * e-Gate connection lost
          GOTO      CCTM9500 IF OVER             * NAK returned from e-Gate
.
CCTM9000  ADD       ONE,CCTSENT
          DISPLAY   *P8:23,CCTSENT;
          MOVE      ZERO,EXIT
          GOTO      CCTM9999
.
CCTM9500  ADD       ONE,CCTFAIL
          DISPLAY   *P18:23,CCTFAIL;
          MOVE      ONE,EXIT
          GOTO      CCTM9999
.
CCTM9700  MOVE      TWO,EXIT
.
CCTM9999  RETURN
+
.******************************************************************************
.*                                  CRGM0000       Called by: RDIN0000        *
.*                       Write PMI Registration Message                       *
.* Returns:  EXIT  0 = message sent ok                                        *
.*                 1 = message rejected                                       *
.*                 2 = e-Gate connection lost                                 *
.******************************************************************************
CRGM0000  MOVE      H7INMESI,KEY20
          CALL      RDPMQPT1                     * PMI details found ?
          BRANCH    OVRCD,CRGM9500               * no - error
.
.         Format PMI coded fields for HL7
.
          CALL      LDOC0000                     * format local doctor
          CALL      GREL0000                     * format religion
          CALL      GLAN0000                     * format language
          CALL      PINL0000                     * format preferred interpreter
.                                                  language
          CALL      PCON0000                     * format patient COB
          CALL      FCON0000                     * format father's COB
          CALL      MCON0000                     * format mother's COB
.
          MOVE      PFUNDH,FUNDCODE
          CALL      GFND0000                     * format health fund
          MOVE      FUNDDESC,PHFUNDD
.
          MOVE      PFUNDH,FUNDCODE
          MOVE      PFNDTB,TABLCODE
          CALL      GTBL0000                     * format fund table
          MOVE      TABLDESC,PHFTABD
.
          CALL      GDTM0000                     * get message date/time
          CALL      MEDI0000                     * format full medicare number
          CALL      GDVA0000                     * get DVA details
.
.         Write message
.
          MOVE      "CRG",MESSTYPE
          WRITE     DGATE;MESSTYPE,PURNO,CSALIAS,SP8,PTITL,PHOSP,PLDAYS:
                          PBDEBT,PSNAME,PGNAME,PPSNAME,PADD1,PADD2,PSUBRB,PADD4:
                          PPOST,PTELEP,PTELEB,PSEX,PMSTAT:
                          PBDATE,PATCONT,RELIGON:
                          PTYPE,POCCUP,PLDDATE,FULLMEDI,PPENNO,PPNDTE,DVADIM10:
                          PSMOK:
                          PMICRO,PCEASE,PCASE,PAUTOPY,PHIGH1,PHIGH2,PHIGH3:
                          PLOCDOC,PHFUNDD,PHFTABD,PFNDMM,PUSR1,PUSR2,PUSR3:
                          PUSR4,PUSR5,PUSR6,PUYN1,PUYN2,PUYN3,PYRRES:
                          PNKNAME,PNKADD1,PNKADD2,PNKSUBR,PNKADD4,PNKPOST:
                          PNKTELP,PNKTELB,PNKRELP,PFNDYY,PFNDCG,PDECDTE:
                          PDIET,PINITHOS,PHKADUNI,PTMAEMPC,PTMANOKO:
                          PTMANOKE,PTMADCNO,PTMXRDAT,PTMXMEAL,PTMXLGA:
                          PTMXLS,PTMXLSDT,PTMXFHMD,PTMXMHU1,PTMXMHU2:
                          PTMXMHU3,PTMXECNM,PTMXECA1,PTMXECA2,PTMXECA3:
                          PTMXECA4,PTMXECPC,PTMXECPP,PTMXECBP,PTMXECRE:
                          PTMXNRNM,PTMXNRA1,PTMXNRA2,PTMXNRA3,PTMXNRA4:
                          PTMXNRPC,PTMXNRPP,PTMXNRBP,PTMXNRRE,PTMX3BEX:
                          PTMXCARD,PTMXCEXP,PTMXCXMP,PTMXFMLY,PTMXCHNM:
                          PTMXDOFR,LOCDOCT,PMPXRH1G,PTMXSPID,PMPXR1GC:
                          PTMXOSDT,PTNINMPI:
                          NHMASURN,NHMAGIV1,NHMAGIV2,NHMAGIV3,NHMAPREI:
                          NHMAADD1,NHMAADD2,NHMAADD3,NHMAADD4,NHMAADD5:
                          NHMADOB,NHMADDTH,NHMADOMC,NHMARES,NHMAETH,NHMASEX:
                          NHMADAT,NHMATIM,NHMAETH2,NHMAETH3:
                          PTMXOPER,PTMXUKDO,PTMXCELL,PTMXADD1,PTMXADD2:
                          PTMXADD3,PTMXADD4,PTMXPOST:
                          PMPXINTR,PATLANG,PREFINT,PMPXLNG3,PMPXPEML:
                          PMPXEDOB,PMPXCMOB,PMPXCEML,PMPXCCRP,PMPXKMOB:
                          PMPXKEML,PMPXKCRP,PMPXRMOB,PMPXREML,PMPXRCRP:
                          PMPXMEDC,PMPXDETY,PMPXPRIS,PMPXCSER,PMPXPHEI:
                          PMPXPWEI,PMPXDREC,DVACCODE,PMPXPNSD,PMPXUYN4:
                          PMPXUYN5,PMPXUYN6,PMPXABRG,PMPXPRVI,PMPXCRIN:
                          PMPXHOML,PMPXUDC1,PMPXUDC2,PMPXUDC3,PMPXUSR7:
                          PMPXUSR8,PMPXUSR9,PMPXMSNA,PMPXMGNA,PMPXMTLE:
                          PMPXMAD1,PMPXMAD2,PMPXMAD3,PMPXMAD4,PMPXMPOS:
                          PMPXMPNO,PMPXMBNO,PMPXMMNO,PMPXMEML,MUMCONT:
                          PMPXMCRP,PMPXMLAB,PMPXMREL,PMPXFSNA,PMPXFGNA:
                          PMPXFTLE,PMPXFAD1,PMPXFAD2,PMPXFAD3,PMPXFAD4:
                          PMPXFPOS,PMPXFPNO,PMPXFBNO,PMPXFMNO,PMPXFEML:
                          FATCONT,PMPXFCRP,PMPXFLAB,PMPXFREL,DATETIME:
                          SP1
     
          GOTO      CRGM9700 IF EOS              * e-Gate connection lost
          GOTO      CRGM9500 IF OVER             * NAK returned from e-Gate
.
CRGM9000  ADD       ONE,CRGSENT
          DISPLAY   *P8:7,CRGSENT;
          MOVE      ZERO,EXIT
          GOTO      CRGM9999
.
CRGM9500  ADD       ONE,CRGFAIL
          DISPLAY   *P18:7,CRGFAIL;
          MOVE      ONE,EXIT
          GOTO      CRGM9999
.
CRGM9700  MOVE      TWO,EXIT
.
CRGM9999  RETURN
+
.******************************************************************************
.*                                  CONM0000       Called by: RDIN0000        *
.*                       Write New O/P Appointment Message                    *
.* Returns:  EXIT  0 = message sent ok                                        *
.*                 1 = message rejected                                       *
.*                 2 = e-Gate connection lost                                 *
.******************************************************************************
CONM0000  MOVE      H7INMESI,KEY20
          CALL      RDPMQPT1                     * PMI details found ?
          BRANCH    OVRCD,CONM9500               * no - error
.
          MOVE      H7INMESI,KEY20
          CALL      RDOTQUE1                     * O/P details found ?
          BRANCH    OVRCD,CONM9500               * no - error
.
.         Format PMI coded fields for HL7
.
          CALL      LDOC0000                     * format local doctor
          CALL      GREL0000                     * format religion
          CALL      GLAN0000                     * format language
          CALL      PINL0000                     * format preferred interpreter
.                                                  language
          CALL      PCON0000                     * format patient COB
          CALL      FCON0000                     * format father's COB
          CALL      MCON0000                     * format mother's COB
.
          MOVE      PFUNDH,FUNDCODE
          CALL      GFND0000                     * format health fund
          MOVE      FUNDDESC,PHFUNDD
.
          MOVE      PFUNDH,FUNDCODE
          MOVE      PFNDTB,TABLCODE
          CALL      GTBL0000                     * format fund table
          MOVE      TABLDESC,PHFTABD
.
.         Format Visit coded fields for HL7
.
          MOVE      OBADOCT,ATTDCODE
          CALL      ADOC0000                     * format attending doctor
          MOVE      ATTDDESC,ATTDOCT
.
          PACK      REFDCODE,OTBBRFGP,SP10
          CALL      GREF0000                     * format referring doctor
          MOVE      REFDDESC,REFDOCT
.
          MOVE      OBASITE,SITECODE
          CALL      GSIT0000                     * format site
          MOVE      SITEDESC,OPSTDSC
.
.         The call to GSRC0000 must follow GSIT0000 so that the source of
.         referral category is loaded
.
          MOVE      OBASRCR,SRCECODE
          CALL      GSRC0000                     * format source of referral
          MOVE      SRCEDESC,SRCREFL
.
          MOVE      OTBBDEPT,UNITCODE
          CALL      UNIT0000                     * format clinical unit
          MOVE      UNITDESC,CLIUNIT
.
          MOVE      OBACAT,ADMNCODE
          CALL      GTYP0000                     * format admission type
          MOVE      ADMNDESC,ADMTYPE
.
          MOVE      OBACLASS,CLASCODE
          CALL      CLAS0000                     * format admission class
          MOVE      CLASDESC,ADMCLSS
.
          MOVE      OTBBFUND,FUNDCODE
          CALL      GFND0000                     * format health fund
          MOVE      FUNDDESC,AHFUNDD
.
          MOVE      OTBBFUND,FUNDCODE
          MOVE      OTBBTBLE,TABLCODE
          CALL      GTBL0000                     * format fund table
          MOVE      TABLDESC,AHFTABD
.
          MOVE      OBASITE,CLINSITE
          MOVE      OBADATE,CLINDATE
          MOVE      OBACLIN,CLINCODE
          CALL      CLIN0000                     * format clinic
          MOVE      CLINDESC,OPCLDSC
.
          MOVE      OBASITE,CTYPSITE
          MOVE      OBACTYP,CTYPTYPE
          CALL      GCTD0000                     * format clinic type
          MOVE      CTYPDESC,OPCTDSC
.
          MOVE      OTMALTYP,LOCNTYPE
          CALL      GLTD0000                     * format location type
          MOVE      LTYPDESC,OPLTDSC
.
          CALL      GCID0000                     * format clinic indicator
.
          CALL      GDTM0000                     * get message date/time
          CALL      MEDI0000                     * format full medicare number
          CALL      GDVA0000                     * get DVA details
.
.         Write message
.
          MOVE      "CON",MESSTYPE
          WRITE     DGATE;MESSTYPE,PURNO,CSALIAS,SP8,PTITL,PHOSP:
                                 PLDAYS,PBDEBT,PSNAME,PGNAME,PPSNAME:
                                 PADD1,PADD2,PSUBRB,PADD4,PPOST:
                                 PTELEP,PTELEB,PSEX,PMSTAT,PBDATE:
                                 PATCONT,RELIGON,PTYPE,POCCUP,PLDDATE:
                                 FULLMEDI,PPENNO,PPNDTE,DVADIM10,PSMOK:
                                 PMICRO,PCEASE,PCASE,PAUTOPY,PHIGH1:
                                 PHIGH2,PHIGH3,PLOCDOC,PHFUNDD,PHFTABD:
                                 PFNDMM,PUSR1,PUSR2,PUSR3,PUSR4:
                                 PUSR5,PUSR6,PUYN1,PUYN2,PUYN3:
                                 PYRRES,PNKNAME,PNKADD1,PNKADD2,PNKSUBR:
                                 PNKADD4,PNKPOST,PNKTELP,PNKTELB,PNKRELP:
                                 PFNDYY,PFNDCG,PDECDTE,PDIET,PINITHOS:
                                 PHKADUNI,PTMAEMPC,PTMANOKO,PTMANOKE,PTMADCNO:
                                 PTMXRDAT,PTMXMEAL,PTMXLGA,PTMXLS,PTMXLSDT:
                                 PTMXFHMD,PTMXMHU1,PTMXMHU2,PTMXMHU3,PTMXECNM:
                                 PTMXECA1,PTMXECA2,PTMXECA3,PTMXECA4,PTMXECPC:
                                 PTMXECPP,PTMXECBP,PTMXECRE,PTMXNRNM,PTMXNRA1:
                                 PTMXNRA2,PTMXNRA3,PTMXNRA4,PTMXNRPC,PTMXNRPP:
                                 PTMXNRBP,PTMXNRRE,PTMX3BEX,PTMXCARD,PTMXCEXP:
                                 PTMXCXMP,PTMXFMLY,PTMXCHNM,PTMXDOFR,LOCDOCT:
                                 PMPXRH1G,PTMXSPID,PMPXR1GC,PTMXOSDT,PTNINMPI:
                                 NHMASURN,NHMAGIV1,NHMAGIV2,NHMAGIV3,NHMAPREI:
                                 NHMAADD1,NHMAADD2,NHMAADD3,NHMAADD4,NHMAADD5:
                                 NHMADOB,NHMADDTH,NHMADOMC,NHMARES,NHMAETH:
                                 NHMASEX,NHMADAT,NHMATIM,NHMAETH2,NHMAETH3:
                                 PTMXOPER,PTMXUKDO,PTMXCELL,PTMXADD1,PTMXADD2:
                                 PTMXADD3,PTMXADD4,PTMXPOST,PMPXINTR,PATLANG:
                                 PREFINT,PMPXLNG3,PMPXPEML,PMPXEDOB,PMPXCMOB:
                                 PMPXCEML,PMPXCCRP,PMPXKMOB,PMPXKEML,PMPXKCRP:
                                 PMPXRMOB,PMPXREML,PMPXRCRP,PMPXMEDC,PMPXDETY:
                                 PMPXPRIS,PMPXCSER,PMPXPHEI,PMPXPWEI,PMPXDREC:
                                 DVACCODE,PMPXPNSD,PMPXUYN4,PMPXUYN5,PMPXUYN6:
                                 PMPXABRG,PMPXPRVI,PMPXCRIN,PMPXHOML,PMPXUDC1:
                                 PMPXUDC2,PMPXUDC3,PMPXUSR7,PMPXUSR8,PMPXUSR9:
                                 PMPXMSNA,PMPXMGNA,PMPXMTLE,PMPXMAD1,PMPXMAD2:
                                 PMPXMAD3,PMPXMAD4,PMPXMPOS,PMPXMPNO,PMPXMBNO:
                                 PMPXMMNO,PMPXMEML,MUMCONT,PMPXMCRP,PMPXMLAB:
                                 PMPXMREL,PMPXFSNA,PMPXFGNA,PMPXFTLE,PMPXFAD1:
                                 PMPXFAD2,PMPXFAD3,PMPXFAD4,PMPXFPOS,PMPXFPNO:
                                 PMPXFBNO,PMPXFMNO,PMPXFEML,FATCONT,PMPXFCRP:
                                 PMPXFLAB,PMPXFREL,OPSTDSC,OPCLDSC,OBADATE:
                                 OBASTRT,OBASLOT,OBATIME,OPCTDSC,OBAVISIT:
                                 OBAOUTNO,OBASESST,SRCREFL,OBACOMP,ADMCLSS:
                                 OBAINS,OBAATTN,ATTDOCT,OBACOMM,AHFUNDD:
                                 AHFTABD,OTBBPVIS,OTBBCLAL,ADMTYPE,OBAPRTY:
                                 OBBBOOK,OBOUSR1,OBOUSR2,OBOUSR3,OBOUSR4:
                                 CLIUNIT,OTBBTRAN,OTBBLNGI,OTBBTMFS,OTBBTMBO:
                                 OTBBGPFA,OTBBECRA,REFDOCT,OTBBGPPC,OTBBADCS:
                                 OTBBCITM,OTBBASTM,OTBBDPTM,OTBBOUTC,OTBBDOFR:
                                 OBOUSR5,OBOUSR6,OBOUSR7,OBOUSR8,OTBBRANK:
                                 OTBBSPCA,DATETIME,OPLTDSC,CINDDESC,SP1
.
          GOTO      CONM9700 IF EOS              * e-Gate connection lost
          GOTO      CONM9500 IF OVER             * NAK returned from e-Gate
.
CONM9000  ADD       ONE,CONSENT
          DISPLAY   *P35:12,CONSENT;
          MOVE      ZERO,EXIT
          GOTO      CONM9999
.
CONM9500  ADD       ONE,CONFAIL
          DISPLAY   *P44:12,CONFAIL;
          MOVE      ONE,EXIT
          GOTO      CONM9999
.
CONM9700  MOVE      TWO,EXIT
.
CONM9999  RETURN
+
.******************************************************************************
.*                                  COBM0000       Called by: RDIN0000        *
.*                       Write Change O/P Appointment Message                 *
.* Returns:  EXIT  0 = message sent ok                                        *
.*                 1 = message rejected                                       *
.*                 2 = e-Gate connection lost                                 *
.******************************************************************************
COBM0000  MOVE      H7INMESI,KEY20
          CALL      RDPMQPT1                     * PMI details found ?
          BRANCH    OVRCD,COBM9500               * no - error
.
          MOVE      H7INMESI,KEY20
          CALL      RDOTQUE1                     * O/P details found ?
          BRANCH    OVRCD,COBM9500               * no - error
.
.         Format PMI coded fields for HL7
.
          CALL      LDOC0000                     * format local doctor
          CALL      GREL0000                     * format religion
          CALL      GLAN0000                     * format language
          CALL      PINL0000                     * format preferred interpreter
.                                                  language
          CALL      PCON0000                     * format patient COB
          CALL      FCON0000                     * format father's COB
          CALL      MCON0000                     * format mother's COB
.
          MOVE      PFUNDH,FUNDCODE
          CALL      GFND0000                     * format health fund
          MOVE      FUNDDESC,PHFUNDD
.
          MOVE      PFUNDH,FUNDCODE
          MOVE      PFNDTB,TABLCODE
          CALL      GTBL0000                     * format fund table
          MOVE      TABLDESC,PHFTABD
.
.         Format Visit coded fields for HL7
.
          MOVE      OBADOCT,ATTDCODE
          CALL      ADOC0000                     * format attending doctor
          MOVE      ATTDDESC,ATTDOCT
.
          PACK      REFDCODE,OTBBRFGP,SP10
          CALL      GREF0000                     * format referring doctor
          MOVE      REFDDESC,REFDOCT
.
          MOVE      OBASITE,SITECODE
          CALL      GSIT0000                     * format site
          MOVE      SITEDESC,OPSTDSC
.
.         The call to GSRC0000 must follow GSIT0000 so that the source of
.         referral category is loaded
.
          MOVE      OBASRCR,SRCECODE
          CALL      GSRC0000                     * format source of referral
          MOVE      SRCEDESC,SRCREFL
.
          MOVE      OTBBDEPT,UNITCODE
          CALL      UNIT0000                     * format clinical unit
          MOVE      UNITDESC,CLIUNIT
.
          MOVE      OBACAT,ADMNCODE
          CALL      GTYP0000                     * format admission type
          MOVE      ADMNDESC,ADMTYPE
.
          MOVE      OBACLASS,CLASCODE
          CALL      CLAS0000                     * format admission class
          MOVE      CLASDESC,ADMCLSS
.
          MOVE      OTBBFUND,FUNDCODE
          CALL      GFND0000                     * format health fund
          MOVE      FUNDDESC,AHFUNDD
.
          MOVE      OTBBFUND,FUNDCODE
          MOVE      OTBBTBLE,TABLCODE
          CALL      GTBL0000                     * format fund table
          MOVE      TABLDESC,AHFTABD
.
          MOVE      OBASITE,CLINSITE
          MOVE      OBADATE,CLINDATE
          MOVE      OBACLIN,CLINCODE
          CALL      CLIN0000                     * format clinic
          MOVE      CLINDESC,OPCLDSC
.
          CALL      GCID0000                     * format clinic indicator
.
          CALL      GDTM0000                     * get message date/time
          CALL      MEDI0000                     * format full medicare number
          CALL      GDVA0000                     * get DVA details
.
.         Write message
.
          MOVE      "COB",MESSTYPE
          WRITE     DGATE;MESSTYPE,PURNO,CSALIAS,SP8,PTITL,PHOSP:
                                 PLDAYS,PBDEBT,PSNAME,PGNAME,PPSNAME:
                                 PADD1,PADD2,PSUBRB,PADD4,PPOST:
                                 PTELEP,PTELEB,PSEX,PMSTAT,PBDATE:
                                 PATCONT,RELIGON,PTYPE,POCCUP,PLDDATE:
                                 FULLMEDI,PPENNO,PPNDTE,DVADIM10,PSMOK:
                                 PMICRO,PCEASE,PCASE,PAUTOPY,PHIGH1:
                                 PHIGH2,PHIGH3,PLOCDOC,PHFUNDD,PHFTABD:
                                 PFNDMM,PUSR1,PUSR2,PUSR3,PUSR4:
                                 PUSR5,PUSR6,PUYN1,PUYN2,PUYN3:
                                 PYRRES,PNKNAME,PNKADD1,PNKADD2,PNKSUBR:
                                 PNKADD4,PNKPOST,PNKTELP,PNKTELB,PNKRELP:
                                 PFNDYY,PFNDCG,PDECDTE,PDIET,PINITHOS:
                                 PHKADUNI,PTMAEMPC,PTMANOKO,PTMANOKE,PTMADCNO:
                                 PTMXRDAT,PTMXMEAL,PTMXLGA,PTMXLS,PTMXLSDT:
                                 PTMXFHMD,PTMXMHU1,PTMXMHU2,PTMXMHU3,PTMXECNM:
                                 PTMXECA1,PTMXECA2,PTMXECA3,PTMXECA4,PTMXECPC:
                                 PTMXECPP,PTMXECBP,PTMXECRE,PTMXNRNM,PTMXNRA1:
                                 PTMXNRA2,PTMXNRA3,PTMXNRA4,PTMXNRPC,PTMXNRPP:
                                 PTMXNRBP,PTMXNRRE,PTMX3BEX,PTMXCARD,PTMXCEXP:
                                 PTMXCXMP,PTMXFMLY,PTMXCHNM,PTMXDOFR,LOCDOCT:
                                 PMPXRH1G,PTMXSPID,PMPXR1GC,PTMXOSDT,PTNINMPI:
                                 NHMASURN,NHMAGIV1,NHMAGIV2,NHMAGIV3,NHMAPREI:
                                 NHMAADD1,NHMAADD2,NHMAADD3,NHMAADD4,NHMAADD5:
                                 NHMADOB,NHMADDTH,NHMADOMC,NHMARES,NHMAETH:
                                 NHMASEX,NHMADAT,NHMATIM,NHMAETH2,NHMAETH3:
                                 PTMXOPER,PTMXUKDO,PTMXCELL,PTMXADD1,PTMXADD2:
                                 PTMXADD3,PTMXADD4,PTMXPOST,PMPXINTR,PATLANG:
                                 PREFINT,PMPXLNG3,PMPXPEML,PMPXEDOB,PMPXCMOB:
                                 PMPXCEML,PMPXCCRP,PMPXKMOB,PMPXKEML,PMPXKCRP:
                                 PMPXRMOB,PMPXREML,PMPXRCRP,PMPXMEDC,PMPXDETY:
                                 PMPXPRIS,PMPXCSER,PMPXPHEI,PMPXPWEI,PMPXDREC:
                                 DVACCODE,PMPXPNSD,PMPXUYN4,PMPXUYN5,PMPXUYN6:
                                 PMPXABRG,PMPXPRVI,PMPXCRIN,PMPXHOML,PMPXUDC1:
                                 PMPXUDC2,PMPXUDC3,PMPXUSR7,PMPXUSR8,PMPXUSR9:
                                 PMPXMSNA,PMPXMGNA,PMPXMTLE,PMPXMAD1,PMPXMAD2:
                                 PMPXMAD3,PMPXMAD4,PMPXMPOS,PMPXMPNO,PMPXMBNO:
                                 PMPXMMNO,PMPXMEML,MUMCONT,PMPXMCRP,PMPXMLAB:
                                 PMPXMREL,PMPXFSNA,PMPXFGNA,PMPXFTLE,PMPXFAD1:
                                 PMPXFAD2,PMPXFAD3,PMPXFAD4,PMPXFPOS,PMPXFPNO:
                                 PMPXFBNO,PMPXFMNO,PMPXFEML,FATCONT,PMPXFCRP:
                                 PMPXFLAB,PMPXFREL,OPSTDSC,OPCLDSC,OBADATE:
                                 OBASTRT,OBASLOT,OBATIME,OBACTYP,OBAVISIT:
                                 OBAOUTNO,OBASESST,SRCREFL,OBACOMP,ADMCLSS:
                                 OBAINS,OBAATTN,ATTDOCT,OBACOMM,AHFUNDD:
                                 AHFTABD,OTBBPVIS,OTBBCLAL,ADMTYPE,OBAPRTY:
                                 OBBBOOK,OBOUSR1,OBOUSR2,OBOUSR3,OBOUSR4:
                                 CLIUNIT,OTBBTRAN,OTBBLNGI,OTBBTMFS,OTBBTMBO:
                                 OTBBGPFA,OTBBECRA,REFDOCT,OTBBGPPC,OTBBADCS:
                                 OTBBCITM,OTBBASTM,OTBBDPTM,OTBBOUTC,OTBBDOFR:
                                 OBOUSR5,OBOUSR6,OBOUSR7,OBOUSR8,OTBBRANK:
                                 OTBBSPCA,DATETIME,CINDDESC,SP1
.
          GOTO      COBM9700 IF EOS              * e-Gate connection lost
          GOTO      COBM9500 IF OVER             * NAK returned from e-Gate
.
COBM9000  ADD       ONE,COBSENT
          DISPLAY   *P35:13,COBSENT;
          MOVE      ZERO,EXIT
          GOTO      COBM9999
.
COBM9500  ADD       ONE,COBFAIL
          DISPLAY   *P44:13,COBFAIL;
          MOVE      ONE,EXIT
          GOTO      COBM9999
.
COBM9700  MOVE      TWO,EXIT
.
COBM9999  RETURN
+
.******************************************************************************
.*                                  CORM0000       Called by: RDIN0000        *
.*                       Write O/P Reschedule Message                         *
.* Returns:  EXIT  0 = message sent ok                                        *
.*                 1 = message rejected                                       *
.*                 2 = e-Gate connection lost                                 *
.******************************************************************************
CORM0000  MOVE      H7INMESI,KEY20
          CALL      RDPMQPT1                     * PMI details found ?
          BRANCH    OVRCD,CORM9500               * no - error
.
          MOVE      H7INMESI,KEY20
          CALL      RDOTQUE1                     * O/P details found ?
          BRANCH    OVRCD,CORM9500               * no - error
.
.         Format PMI coded fields for HL7
.
          CALL      LDOC0000                     * format local doctor
          CALL      GREL0000                     * format religion
          CALL      GLAN0000                     * format language
          CALL      PINL0000                     * format preferred interpreter
.                                                  language
          CALL      PCON0000                     * format patient COB
          CALL      FCON0000                     * format father's COB
          CALL      MCON0000                     * format mother's COB
.
          MOVE      PFUNDH,FUNDCODE
          CALL      GFND0000                     * format health fund
          MOVE      FUNDDESC,PHFUNDD
.
          MOVE      PFUNDH,FUNDCODE
          MOVE      PFNDTB,TABLCODE
          CALL      GTBL0000                     * format fund table
          MOVE      TABLDESC,PHFTABD
.
.         Format Visit coded fields for HL7
.
          MOVE      OPRSSITE,SITECODE
          CALL      GSIT0000                     * format current site
          MOVE      SITEDESC,OPSTDSC
.
          MOVE      OPRSSITE,SITECODE
          CALL      GSIT0000                     * format old site
          MOVE      SITEDESC,OPOSDSC
.
          MOVE      OPRSSITE,CLINSITE
          MOVE      OPRSNDAT,CLINDATE
          MOVE      OPRSNCLI,CLINCODE
          CALL      CLIN0000                     * format current clinic
          MOVE      CLINDESC,OPCLDSC
.
          MOVE      OPRSSITE,CLINSITE
          MOVE      OPRSDATE,CLINDATE
          MOVE      OPRSCLIN,CLINCODE
          CALL      CLIN0000                     * format old clinic
          MOVE      CLINDESC,OPOCDSC
.
          CALL      GDTM0000                     * get message date/time
          CALL      MEDI0000                     * format full medicare number
          CALL      GDVA0000                     * get DVA details
.
.         Write message
.
          MOVE      "COR",MESSTYPE
          WRITE     DGATE;MESSTYPE,PURNO,CSALIAS,SP8,PTITL,PHOSP:
                                 PLDAYS,PBDEBT,PSNAME,PGNAME,PPSNAME:
                                 PADD1,PADD2,PSUBRB,PADD4,PPOST:
                                 PTELEP,PTELEB,PSEX,PMSTAT,PBDATE:
                                 PATCONT,RELIGON,PTYPE,POCCUP,PLDDATE:
                                 FULLMEDI,PPENNO,PPNDTE,DVADIM10,PSMOK:
                                 PMICRO,PCEASE,PCASE,PAUTOPY,PHIGH1:
                                 PHIGH2,PHIGH3,PLOCDOC,PHFUNDD,PHFTABD:
                                 PFNDMM,PUSR1,PUSR2,PUSR3,PUSR4:
                                 PUSR5,PUSR6,PUYN1,PUYN2,PUYN3:
                                 PYRRES,PNKNAME,PNKADD1,PNKADD2,PNKSUBR:
                                 PNKADD4,PNKPOST,PNKTELP,PNKTELB,PNKRELP:
                                 PFNDYY,PFNDCG,PDECDTE,PDIET,PINITHOS:
                                 PHKADUNI,PTMAEMPC,PTMANOKO,PTMANOKE,PTMADCNO:
                                 PTMXRDAT,PTMXMEAL,PTMXLGA,PTMXLS,PTMXLSDT:
                                 PTMXFHMD,PTMXMHU1,PTMXMHU2,PTMXMHU3,PTMXECNM:
                                 PTMXECA1,PTMXECA2,PTMXECA3,PTMXECA4,PTMXECPC:
                                 PTMXECPP,PTMXECBP,PTMXECRE,PTMXNRNM,PTMXNRA1:
                                 PTMXNRA2,PTMXNRA3,PTMXNRA4,PTMXNRPC,PTMXNRPP:
                                 PTMXNRBP,PTMXNRRE,PTMX3BEX,PTMXCARD,PTMXCEXP:
                                 PTMXCXMP,PTMXFMLY,PTMXCHNM,PTMXDOFR,LOCDOCT:
                                 PMPXRH1G,PTMXSPID,PMPXR1GC,PTMXOSDT,PTNINMPI:
                                 NHMASURN,NHMAGIV1,NHMAGIV2,NHMAGIV3,NHMAPREI:
                                 NHMAADD1,NHMAADD2,NHMAADD3,NHMAADD4,NHMAADD5:
                                 NHMADOB,NHMADDTH,NHMADOMC,NHMARES,NHMAETH:
                                 NHMASEX,NHMADAT,NHMATIM,NHMAETH2,NHMAETH3:
                                 PTMXOPER,PTMXUKDO,PTMXCELL,PTMXADD1,PTMXADD2:
                                 PTMXADD3,PTMXADD4,PTMXPOST,PMPXINTR,PATLANG:
                                 PREFINT,PMPXLNG3,PMPXPEML,PMPXEDOB,PMPXCMOB:
                                 PMPXCEML,PMPXCCRP,PMPXKMOB,PMPXKEML,PMPXKCRP:
                                 PMPXRMOB,PMPXREML,PMPXRCRP,PMPXMEDC,PMPXDETY:
                                 PMPXPRIS,PMPXCSER,PMPXPHEI,PMPXPWEI,PMPXDREC:
                                 DVACCODE,PMPXPNSD,PMPXUYN4,PMPXUYN5,PMPXUYN6:
                                 PMPXABRG,PMPXPRVI,PMPXCRIN,PMPXHOML,PMPXUDC1:
                                 PMPXUDC2,PMPXUDC3,PMPXUSR7,PMPXUSR8,PMPXUSR9:
                                 PMPXMSNA,PMPXMGNA,PMPXMTLE,PMPXMAD1,PMPXMAD2:
                                 PMPXMAD3,PMPXMAD4,PMPXMPOS,PMPXMPNO,PMPXMBNO:
                                 PMPXMMNO,PMPXMEML,MUMCONT,PMPXMCRP,PMPXMLAB:
                                 PMPXMREL,PMPXFSNA,PMPXFGNA,PMPXFTLE,PMPXFAD1:
                                 PMPXFAD2,PMPXFAD3,PMPXFAD4,PMPXFPOS,PMPXFPNO:
                                 PMPXFBNO,PMPXFMNO,PMPXFEML,FATCONT,PMPXFCRP:
                                 PMPXFLAB,PMPXFREL,OPSTDSC,OPCLDSC,OPRSNDAT:
                                 OPRSNSTR,OPRSNSLO,OPRSNTIM,OPRSNTYP,OPRSNVIS:
                                 OPRSOUTN,OPRSREAS,OPOSDSC,OPOCDSC,OPRSDATE:
                                 OPRSSTRT,OPRSSLOT,OPRSTIME,DATETIME,OPRSVIST:
                                 OPRSCTYP,SP1
.
          GOTO      CORM9700 IF EOS              * e-Gate connection lost
          GOTO      CORM9500 IF OVER             * NAK returned from e-Gate
.
CORM9000  ADD       ONE,CORSENT
          DISPLAY   *P35:14,CORSENT;
          MOVE      ZERO,EXIT
          GOTO      CORM9999
.
CORM9500  ADD       ONE,CORFAIL
          DISPLAY   *P44:14,CORFAIL;
          MOVE      ONE,EXIT
          GOTO      CORM9999
.
CORM9700  MOVE      TWO,EXIT
.
CORM9999  RETURN
+
.******************************************************************************
.*                                  COCM0000       Called by: RDIN0000        *
.*                       Write Cancel O/P Appoitment Message                  *
.* Returns:  EXIT  0 = message sent ok                                        *
.*                 1 = message rejected                                       *
.*                 2 = e-Gate connection lost                                 *
.******************************************************************************
COCM0000  MOVE      H7INMESI,KEY20
          CALL      RDPMQPT1                     * PMI details found ?
          BRANCH    OVRCD,COCM9500               * no - error
.
          MOVE      H7INMESI,KEY20
          CALL      RDOTQUE1                     * O/P details found ?
          BRANCH    OVRCD,COCM9500               * no - error
.
.         Format PMI coded fields for HL7
.
          CALL      LDOC0000                     * format local doctor
          CALL      GREL0000                     * format religion
          CALL      GLAN0000                     * format language
          CALL      PINL0000                     * format preferred interpreter
.                                                  language
          CALL      PCON0000                     * format patient COB
          CALL      FCON0000                     * format father's COB
          CALL      MCON0000                     * format mother's COB
.
          MOVE      PFUNDH,FUNDCODE
          CALL      GFND0000                     * format health fund
          MOVE      FUNDDESC,PHFUNDD
.
          MOVE      PFUNDH,FUNDCODE
          MOVE      PFNDTB,TABLCODE
          CALL      GTBL0000                     * format fund table
          MOVE      TABLDESC,PHFTABD
.
.         Format Visit coded fields for HL7
.
          MOVE      OPCNSITE,SITECODE
          CALL      GSIT0000                     * format old site
          MOVE      SITEDESC,OPOSDSC
.
          MOVE      OPCNSITE,CLINSITE
          MOVE      OPCNDATE,CLINDATE
          MOVE      OPCNCLIN,CLINCODE
          CALL      CLIN0000                     * format old clinic
          MOVE      CLINDESC,OPOCDSC
.
          CALL      GDTM0000                     * get message date/time
          CALL      MEDI0000                     * format full medicare number
          CALL      GDVA0000                     * get DVA details
.
.         Write message
.
          MOVE      "COC",MESSTYPE
          WRITE     DGATE;MESSTYPE,PURNO,CSALIAS,SP8,PTITL,PHOSP:
                                 PLDAYS,PBDEBT,PSNAME,PGNAME,PPSNAME:
                                 PADD1,PADD2,PSUBRB,PADD4,PPOST:
                                 PTELEP,PTELEB,PSEX,PMSTAT,PBDATE:
                                 PATCONT,RELIGON,PTYPE,POCCUP,PLDDATE:
                                 FULLMEDI,PPENNO,PPNDTE,DVADIM10,PSMOK:
                                 PMICRO,PCEASE,PCASE,PAUTOPY,PHIGH1:
                                 PHIGH2,PHIGH3,PLOCDOC,PHFUNDD,PHFTABD:
                                 PFNDMM,PUSR1,PUSR2,PUSR3,PUSR4:
                                 PUSR5,PUSR6,PUYN1,PUYN2,PUYN3:
                                 PYRRES,PNKNAME,PNKADD1,PNKADD2,PNKSUBR:
                                 PNKADD4,PNKPOST,PNKTELP,PNKTELB,PNKRELP:
                                 PFNDYY,PFNDCG,PDECDTE,PDIET,PINITHOS:
                                 PHKADUNI,PTMAEMPC,PTMANOKO,PTMANOKE,PTMADCNO:
                                 PTMXRDAT,PTMXMEAL,PTMXLGA,PTMXLS,PTMXLSDT:
                                 PTMXFHMD,PTMXMHU1,PTMXMHU2,PTMXMHU3,PTMXECNM:
                                 PTMXECA1,PTMXECA2,PTMXECA3,PTMXECA4,PTMXECPC:
                                 PTMXECPP,PTMXECBP,PTMXECRE,PTMXNRNM,PTMXNRA1:
                                 PTMXNRA2,PTMXNRA3,PTMXNRA4,PTMXNRPC,PTMXNRPP:
                                 PTMXNRBP,PTMXNRRE,PTMX3BEX,PTMXCARD,PTMXCEXP:
                                 PTMXCXMP,PTMXFMLY,PTMXCHNM,PTMXDOFR,LOCDOCT:
                                 PMPXRH1G,PTMXSPID,PMPXR1GC,PTMXOSDT,PTNINMPI:
                                 NHMASURN,NHMAGIV1,NHMAGIV2,NHMAGIV3,NHMAPREI:
                                 NHMAADD1,NHMAADD2,NHMAADD3,NHMAADD4,NHMAADD5:
                                 NHMADOB,NHMADDTH,NHMADOMC,NHMARES,NHMAETH:
                                 NHMASEX,NHMADAT,NHMATIM,NHMAETH2,NHMAETH3:
                                 PTMXOPER,PTMXUKDO,PTMXCELL,PTMXADD1,PTMXADD2:
                                 PTMXADD3,PTMXADD4,PTMXPOST,PMPXINTR,PATLANG:
                                 PREFINT,PMPXLNG3,PMPXPEML,PMPXEDOB,PMPXCMOB:
                                 PMPXCEML,PMPXCCRP,PMPXKMOB,PMPXKEML,PMPXKCRP:
                                 PMPXRMOB,PMPXREML,PMPXRCRP,PMPXMEDC,PMPXDETY:
                                 PMPXPRIS,PMPXCSER,PMPXPHEI,PMPXPWEI,PMPXDREC:
                                 DVACCODE,PMPXPNSD,PMPXUYN4,PMPXUYN5,PMPXUYN6:
                                 PMPXABRG,PMPXPRVI,PMPXCRIN,PMPXHOML,PMPXUDC1:
                                 PMPXUDC2,PMPXUDC3,PMPXUSR7,PMPXUSR8,PMPXUSR9:
                                 PMPXMSNA,PMPXMGNA,PMPXMTLE,PMPXMAD1,PMPXMAD2:
                                 PMPXMAD3,PMPXMAD4,PMPXMPOS,PMPXMPNO,PMPXMBNO:
                                 PMPXMMNO,PMPXMEML,MUMCONT,PMPXMCRP,PMPXMLAB:
                                 PMPXMREL,PMPXFSNA,PMPXFGNA,PMPXFTLE,PMPXFAD1:
                                 PMPXFAD2,PMPXFAD3,PMPXFAD4,PMPXFPOS,PMPXFPNO:
                                 PMPXFBNO,PMPXFMNO,PMPXFEML,FATCONT,PMPXFCRP:
                                 PMPXFLAB,PMPXFREL,OPCNOUTN,OPCNREAS,OPOSDSC:
                                 OPOCDSC,OPCNDATE,OPCNSTRT,OPCNSLOT,OPCNTIME:
                                 OPCNVTYP,DATETIME,SP1
.
          GOTO      COCM9700 IF EOS              * e-Gate connection lost
          GOTO      COCM9500 IF OVER             * NAK returned from e-Gate
.
COCM9000  ADD       ONE,COCSENT
          DISPLAY   *P35:15,COCSENT;
          MOVE      ZERO,EXIT
          GOTO      COCM9999
.
COCM9500  ADD       ONE,COCFAIL
          DISPLAY   *P44:15,COCFAIL;
          MOVE      ONE,EXIT
          GOTO      COCM9999
.
COCM9700  MOVE      TWO,EXIT
.
COCM9999  RETURN
+
.******************************************************************************
.*                                  CODM0000       Called by: RDIN0000        *
.*                       Write O/P Appointment DNA                            *
.* Returns:  EXIT  0 = message sent ok                                        *
.*                 1 = message rejected                                       *
.*                 2 = e-Gate connection lost                                 *
.******************************************************************************
CODM0000  MOVE      H7INMESI,KEY20
          CALL      RDPMQPT1                     * PMI details found ?
          BRANCH    OVRCD,CODM9500               * no - error
.
          MOVE      H7INMESI,KEY20
          CALL      RDOTQUE1                     * O/P details found ?
          BRANCH    OVRCD,CODM9500               * no - error
.
.         Format PMI coded fields for HL7
.
          CALL      LDOC0000                     * format local doctor
          CALL      GREL0000                     * format religion
          CALL      GLAN0000                     * format language
          CALL      PINL0000                     * format preferred interpreter
.                                                  language
          CALL      PCON0000                     * format patient COB
          CALL      FCON0000                     * format father's COB
          CALL      MCON0000                     * format mother's COB
.
          MOVE      PFUNDH,FUNDCODE
          CALL      GFND0000                     * format health fund
          MOVE      FUNDDESC,PHFUNDD
.
          MOVE      PFUNDH,FUNDCODE
          MOVE      PFNDTB,TABLCODE
          CALL      GTBL0000                     * format fund table
          MOVE      TABLDESC,PHFTABD
.
.         Format Visit coded fields for HL7
.
          MOVE      OBASITE,SITECODE
          CALL      GSIT0000                     * format old site
          MOVE      SITEDESC,OPOSDSC
.
          MOVE      OBASITE,CLINSITE
          MOVE      OBADATE,CLINDATE
          MOVE      OBACLIN,CLINCODE
          CALL      CLIN0000                     * format old clinic
          MOVE      CLINDESC,OPOCDSC
.
          CALL      GDTM0000                     * get message date/time
          CALL      MEDI0000                     * format full medicare number
          CALL      GDVA0000                     * get DVA details
.
.         Write message
.
          MOVE      "COD",MESSTYPE
          WRITE     DGATE;MESSTYPE,PURNO,CSALIAS,SP8,PTITL,PHOSP:
                                 PLDAYS,PBDEBT,PSNAME,PGNAME,PPSNAME:
                                 PADD1,PADD2,PSUBRB,PADD4,PPOST:
                                 PTELEP,PTELEB,PSEX,PMSTAT,PBDATE:
                                 PATCONT,RELIGON,PTYPE,POCCUP,PLDDATE:
                                 FULLMEDI,PPENNO,PPNDTE,DVADIM10,PSMOK:
                                 PMICRO,PCEASE,PCASE,PAUTOPY,PHIGH1:
                                 PHIGH2,PHIGH3,PLOCDOC,PHFUNDD,PHFTABD:
                                 PFNDMM,PUSR1,PUSR2,PUSR3,PUSR4:
                                 PUSR5,PUSR6,PUYN1,PUYN2,PUYN3:
                                 PYRRES,PNKNAME,PNKADD1,PNKADD2,PNKSUBR:
                                 PNKADD4,PNKPOST,PNKTELP,PNKTELB,PNKRELP:
                                 PFNDYY,PFNDCG,PDECDTE,PDIET,PINITHOS:
                                 PHKADUNI,PTMAEMPC,PTMANOKO,PTMANOKE,PTMADCNO:
                                 PTMXRDAT,PTMXMEAL,PTMXLGA,PTMXLS,PTMXLSDT:
                                 PTMXFHMD,PTMXMHU1,PTMXMHU2,PTMXMHU3,PTMXECNM:
                                 PTMXECA1,PTMXECA2,PTMXECA3,PTMXECA4,PTMXECPC:
                                 PTMXECPP,PTMXECBP,PTMXECRE,PTMXNRNM,PTMXNRA1:
                                 PTMXNRA2,PTMXNRA3,PTMXNRA4,PTMXNRPC,PTMXNRPP:
                                 PTMXNRBP,PTMXNRRE,PTMX3BEX,PTMXCARD,PTMXCEXP:
                                 PTMXCXMP,PTMXFMLY,PTMXCHNM,PTMXDOFR,LOCDOCT:
                                 PMPXRH1G,PTMXSPID,PMPXR1GC,PTMXOSDT,PTNINMPI:
                                 NHMASURN,NHMAGIV1,NHMAGIV2,NHMAGIV3,NHMAPREI:
                                 NHMAADD1,NHMAADD2,NHMAADD3,NHMAADD4,NHMAADD5:
                                 NHMADOB,NHMADDTH,NHMADOMC,NHMARES,NHMAETH:
                                 NHMASEX,NHMADAT,NHMATIM,NHMAETH2,NHMAETH3:
                                 PTMXOPER,PTMXUKDO,PTMXCELL,PTMXADD1,PTMXADD2:
                                 PTMXADD3,PTMXADD4,PTMXPOST,PMPXINTR,PATLANG:
                                 PREFINT,PMPXLNG3,PMPXPEML,PMPXEDOB,PMPXCMOB:
                                 PMPXCEML,PMPXCCRP,PMPXKMOB,PMPXKEML,PMPXKCRP:
                                 PMPXRMOB,PMPXREML,PMPXRCRP,PMPXMEDC,PMPXDETY:
                                 PMPXPRIS,PMPXCSER,PMPXPHEI,PMPXPWEI,PMPXDREC:
                                 DVACCODE,PMPXPNSD,PMPXUYN4,PMPXUYN5,PMPXUYN6:
                                 PMPXABRG,PMPXPRVI,PMPXCRIN,PMPXHOML,PMPXUDC1:
                                 PMPXUDC2,PMPXUDC3,PMPXUSR7,PMPXUSR8,PMPXUSR9:
                                 PMPXMSNA,PMPXMGNA,PMPXMTLE,PMPXMAD1,PMPXMAD2:
                                 PMPXMAD3,PMPXMAD4,PMPXMPOS,PMPXMPNO,PMPXMBNO:
                                 PMPXMMNO,PMPXMEML,MUMCONT,PMPXMCRP,PMPXMLAB:
                                 PMPXMREL,PMPXFSNA,PMPXFGNA,PMPXFTLE,PMPXFAD1:
                                 PMPXFAD2,PMPXFAD3,PMPXFAD4,PMPXFPOS,PMPXFPNO:
                                 PMPXFBNO,PMPXFMNO,PMPXFEML,FATCONT,PMPXFCRP:
                                 PMPXFLAB,PMPXFREL,OBAOUTNO,OPOSDSC,OPOCDSC:
                                 OBADATE,OBASTRT,OBASLOT,OBATIME,OBACTYP:
                                 OBAVISIT,DATETIME,OBAATTN,SP1
.
          GOTO      CODM9700 IF EOS              * e-Gate connection lost
          GOTO      CODM9500 IF OVER             * NAK returned from e-Gate
.
CODM9000  ADD       ONE,CODSENT
          DISPLAY   *P35:16,CODSENT;
          MOVE      ZERO,EXIT
          GOTO      CODM9999
.
CODM9500  ADD       ONE,CODFAIL
          DISPLAY   *P44:16,CODFAIL;
          MOVE      ONE,EXIT
          GOTO      CODM9999
.
CODM9700  MOVE      TWO,EXIT
.
CODM9999  RETURN
+
.******************************************************************************
.*                                  COAM0000       Called by: RDIN0000        *
.*                       Write Confirm O/P Appointment Message                *
.* Returns:  EXIT  0 = message sent ok                                        *
.*                 1 = message rejected                                       *
.*                 2 = e-Gate connection lost                                 *
.******************************************************************************
COAM0000  MOVE      H7INMESI,KEY20
          CALL      RDPMQPT1                     * PMI details found ?
          BRANCH    OVRCD,COAM9500               * no - error
.
          MOVE      H7INMESI,KEY20
          CALL      RDOTQUE1                     * O/P details found ?
          BRANCH    OVRCD,COAM9500               * no - error
.
.         Format PMI coded fields for HL7
.
          CALL      LDOC0000                     * format local doctor
          CALL      GREL0000                     * format religion
          CALL      GLAN0000                     * format language
          CALL      PINL0000                     * format preferred interpreter
.                                                  language
          CALL      PCON0000                     * format patient COB
          CALL      FCON0000                     * format father's COB
          CALL      MCON0000                     * format mother's COB
.
          MOVE      PFUNDH,FUNDCODE
          CALL      GFND0000                     * format health fund
          MOVE      FUNDDESC,PHFUNDD
.
          MOVE      PFUNDH,FUNDCODE
          MOVE      PFNDTB,TABLCODE
          CALL      GTBL0000                     * format fund table
          MOVE      TABLDESC,PHFTABD
.
.         Format Visit coded fields for HL7
.
          MOVE      OBADOCT,ATTDCODE
          CALL      ADOC0000                     * format attending doctor
          MOVE      ATTDDESC,ATTDOCT
.
          PACK      REFDCODE,OTBBRFGP,SP10
          CALL      GREF0000                     * format referring doctor
          MOVE      REFDDESC,REFDOCT
.
          MOVE      OBASITE,SITECODE
          CALL      GSIT0000                     * format site
          MOVE      SITEDESC,OPSTDSC
.
.         The call to GSRC0000 must follow GSIT0000 so that the source of
.         referral category is loaded
.
          MOVE      OBASRCR,SRCECODE
          CALL      GSRC0000                     * format source of referral
          MOVE      SRCEDESC,SRCREFL
.
          MOVE      OTBBDEPT,UNITCODE
          CALL      UNIT0000                     * format clinical unit
          MOVE      UNITDESC,CLIUNIT
.
          MOVE      OBACAT,ADMNCODE
          CALL      GTYP0000                     * format admission type
          MOVE      ADMNDESC,ADMTYPE
.
          MOVE      OBACLASS,CLASCODE
          CALL      CLAS0000                     * format admission class
          MOVE      CLASDESC,ADMCLSS
.
          MOVE      OTBBFUND,FUNDCODE
          CALL      GFND0000                     * format health fund
          MOVE      FUNDDESC,AHFUNDD
.
          MOVE      OTBBFUND,FUNDCODE
          MOVE      OTBBTBLE,TABLCODE
          CALL      GTBL0000                     * format fund table
          MOVE      TABLDESC,AHFTABD
.
          MOVE      OBASITE,CLINSITE
          MOVE      OBADATE,CLINDATE
          MOVE      OBACLIN,CLINCODE
          CALL      CLIN0000                     * format clinic
          MOVE      CLINDESC,OPCLDSC
.
          CALL      GCID0000                     * format clinic indicator
.
          CALL      GDTM0000                     * get message date/time
          CALL      MEDI0000                     * format full medicare number
          CALL      GDVA0000                     * get DVA details
.
.         Write message
.
          MOVE      "COA",MESSTYPE
          WRITE     DGATE;MESSTYPE,PURNO,CSALIAS,SP8,PTITL,PHOSP:
                                 PLDAYS,PBDEBT,PSNAME,PGNAME,PPSNAME:
                                 PADD1,PADD2,PSUBRB,PADD4,PPOST:
                                 PTELEP,PTELEB,PSEX,PMSTAT,PBDATE:
                                 PATCONT,RELIGON,PTYPE,POCCUP,PLDDATE:
                                 FULLMEDI,PPENNO,PPNDTE,DVADIM10,PSMOK:
                                 PMICRO,PCEASE,PCASE,PAUTOPY,PHIGH1:
                                 PHIGH2,PHIGH3,PLOCDOC,PHFUNDD,PHFTABD:
                                 PFNDMM,PUSR1,PUSR2,PUSR3,PUSR4:
                                 PUSR5,PUSR6,PUYN1,PUYN2,PUYN3:
                                 PYRRES,PNKNAME,PNKADD1,PNKADD2,PNKSUBR:
                                 PNKADD4,PNKPOST,PNKTELP,PNKTELB,PNKRELP:
                                 PFNDYY,PFNDCG,PDECDTE,PDIET,PINITHOS:
                                 PHKADUNI,PTMAEMPC,PTMANOKO,PTMANOKE,PTMADCNO:
                                 PTMXRDAT,PTMXMEAL,PTMXLGA,PTMXLS,PTMXLSDT:
                                 PTMXFHMD,PTMXMHU1,PTMXMHU2,PTMXMHU3,PTMXECNM:
                                 PTMXECA1,PTMXECA2,PTMXECA3,PTMXECA4,PTMXECPC:
                                 PTMXECPP,PTMXECBP,PTMXECRE,PTMXNRNM,PTMXNRA1:
                                 PTMXNRA2,PTMXNRA3,PTMXNRA4,PTMXNRPC,PTMXNRPP:
                                 PTMXNRBP,PTMXNRRE,PTMX3BEX,PTMXCARD,PTMXCEXP:
                                 PTMXCXMP,PTMXFMLY,PTMXCHNM,PTMXDOFR,LOCDOCT:
                                 PMPXRH1G,PTMXSPID,PMPXR1GC,PTMXOSDT,PTNINMPI:
                                 NHMASURN,NHMAGIV1,NHMAGIV2,NHMAGIV3,NHMAPREI:
                                 NHMAADD1,NHMAADD2,NHMAADD3,NHMAADD4,NHMAADD5:
                                 NHMADOB,NHMADDTH,NHMADOMC,NHMARES,NHMAETH:
                                 NHMASEX,NHMADAT,NHMATIM,NHMAETH2,NHMAETH3:
                                 PTMXOPER,PTMXUKDO,PTMXCELL,PTMXADD1,PTMXADD2:
                                 PTMXADD3,PTMXADD4,PTMXPOST,PMPXINTR,PATLANG:
                                 PREFINT,PMPXLNG3,PMPXPEML,PMPXEDOB,PMPXCMOB:
                                 PMPXCEML,PMPXCCRP,PMPXKMOB,PMPXKEML,PMPXKCRP:
                                 PMPXRMOB,PMPXREML,PMPXRCRP,PMPXMEDC,PMPXDETY:
                                 PMPXPRIS,PMPXCSER,PMPXPHEI,PMPXPWEI,PMPXDREC:
                                 DVACCODE,PMPXPNSD,PMPXUYN4,PMPXUYN5,PMPXUYN6:
                                 PMPXABRG,PMPXPRVI,PMPXCRIN,PMPXHOML,PMPXUDC1:
                                 PMPXUDC2,PMPXUDC3,PMPXUSR7,PMPXUSR8,PMPXUSR9:
                                 PMPXMSNA,PMPXMGNA,PMPXMTLE,PMPXMAD1,PMPXMAD2:
                                 PMPXMAD3,PMPXMAD4,PMPXMPOS,PMPXMPNO,PMPXMBNO:
                                 PMPXMMNO,PMPXMEML,MUMCONT,PMPXMCRP,PMPXMLAB:
                                 PMPXMREL,PMPXFSNA,PMPXFGNA,PMPXFTLE,PMPXFAD1:
                                 PMPXFAD2,PMPXFAD3,PMPXFAD4,PMPXFPOS,PMPXFPNO:
                                 PMPXFBNO,PMPXFMNO,PMPXFEML,FATCONT,PMPXFCRP:
                                 PMPXFLAB,PMPXFREL,OPSTDSC,OPCLDSC,OBADATE:
                                 OBASTRT,OBASLOT,OBATIME,OBACTYP,OBAVISIT:
                                 OBAOUTNO,OBASESST,SRCREFL,OBACOMP,ADMCLSS:
                                 OBAINS,OBAATTN,ATTDOCT,OBACOMM,AHFUNDD:
                                 AHFTABD,OTBBPVIS,OTBBCLAL,ADMTYPE,OBAPRTY:
                                 OBBBOOK,OBOUSR1,OBOUSR2,OBOUSR3,OBOUSR4:
                                 CLIUNIT,OTBBTRAN,OTBBLNGI,OTBBTMFS,OTBBTMBO:
                                 OTBBGPFA,OTBBECRA,REFDOCT,OTBBGPPC,OTBBADCS:
                                 OTBBCITM,OTBBASTM,OTBBDPTM,OTBBOUTC,OTBBDOFR:
                                 OBOUSR5,OBOUSR6,OBOUSR7,OBOUSR8,OTBBRANK:
                                 OTBBSPCA,DATETIME,CINDDESC,SP1
.
          GOTO      COAM9700 IF EOS              * e-Gate connection lost
          GOTO      COAM9500 IF OVER             * NAK returned from e-Gate
.
COAM9000  ADD       ONE,COASENT
          DISPLAY   *P35:17,COASENT;
          MOVE      ZERO,EXIT
          GOTO      COAM9999
.
COAM9500  ADD       ONE,COAFAIL
          DISPLAY   *P44:17,COAFAIL;
          MOVE      ONE,EXIT
          GOTO      COAM9999
.
COAM9700  MOVE      TWO,EXIT
.
COAM9999  RETURN
+
.******************************************************************************
.*                                  CUBM0000       Called by: RDIN0000        *
.*                       Write Booking Message                                *
.* Returns:  EXIT  0 = message sent ok                                        *
.*                 1 = message rejected                                       *
.*                 2 = e-Gate connection lost                                 *
.******************************************************************************
CUBM0000  MOVE      H7INMESI,KEY20
          CALL      RDPMQPT1                     * PMI details found ?
          BRANCH    OVRCD,CUBM9500               * no - error
.
          MOVE      H7INMESI,KEY20
          CALL      RDBKQUE1                     * Booking details found ?
          BRANCH    OVRCD,CUBM9500               * no - error
.
          MOVE      H7INMESI,KEY20
          CALL      RDWTQUE1                     * W/L details found ?
          BRANCH    OVRCD,CUBM9500               * no - error
.
.         Format PMI coded fields for HL7
.
          CALL      LDOC0000                     * format local doctor
          CALL      GREL0000                     * format religion
          CALL      GLAN0000                     * format language
          CALL      PINL0000                     * format preferred interpreter
.                                                  language
          CALL      PCON0000                     * format patient COB
          CALL      FCON0000                     * format father's COB
          CALL      MCON0000                     * format mother's COB
.
          MOVE      PFUNDH,FUNDCODE
          CALL      GFND0000                     * format health fund
          MOVE      FUNDDESC,PHFUNDD
.
          MOVE      PFUNDH,FUNDCODE
          MOVE      PFNDTB,TABLCODE
          CALL      GTBL0000                     * format fund table
          MOVE      TABLDESC,PHFTABD
.
.         Format Visit coded fields for HL7
.
          MOVE      BKREADOC,CONSCODE
          CALL      GCON0000                     * format consultant
          MOVE      CONSDESC,CONSULT
.
          PACK      REFDCODE,BKRERFGP,SP10
          CALL      GREF0000                     * format referring doctor
          MOVE      REFDDESC,REFDOCT
.
          MOVE      BKREDEPT,UNITCODE
          CALL      UNIT0000                     * format clinical unit
          MOVE      UNITDESC,CLIUNIT
.
          MOVE      BKRECLSS,ADMNCODE
          CALL      GTYP0000                     * format admission type
          MOVE      ADMNDESC,ADMTYPE
.
          MOVE      BKREATYP,CLASCODE
          CALL      CLAS0000                     * format admission class
          MOVE      CLASDESC,ADMCLSS
.
          MOVE      BKREWARD,WARDCODE
          CALL      GWRD0000                     * format patient location
          MOVE      WARDDESC,PATWLOC
.
          CALL      GDTM0000                     * get message date/time
          CALL      MEDI0000                     * format full medicare number
          CALL      GDVA0000                     * get DVA details
.
.         Write message
.
          MOVE      "CUB",MESSTYPE
          WRITE     DGATE;MESSTYPE,PURNO,BKREBOOK,PTITL,PHOSP,PLDAYS:
                                 PBDEBT,PSNAME,PGNAME,PPSNAME,PADD1:
                                 PADD2,PSUBRB,PADD4,PPOST,PTELEP:
                                 PTELEB,PSEX,PMSTAT,PBDATE,PATCONT:
                                 RELIGON,PTYPE,POCCUP,PLDDATE,FULLMEDI:
                                 PPENNO,PPNDTE,DVADIM10,PSMOK,PMICRO:
                                 PCEASE,PCASE,PAUTOPY,PHIGH1,PHIGH2:
                                 PHIGH3,PLOCDOC,PHFUNDD,PHFTABD,PFNDMM:
                                 PUSR1,PUSR2,PUSR3,PUSR4,PUSR5:
                                 PUSR6,PUYN1,PUYN2,PUYN3,PYRRES:
                                 PNKNAME,PNKADD1,PNKADD2,PNKSUBR,PNKADD4:
                                 PNKPOST,PNKTELP,PNKTELB,PNKRELP,PFNDYY:
                                 PFNDCG,PDECDTE,PDIET,PINITHOS,PHKADUNI:
                                 PTMAEMPC,PTMANOKO,PTMANOKE,PTMADCNO,PTMXRDAT:
                                 PTMXMEAL,PTMXLGA,PTMXLS,PTMXLSDT,PTMXFHMD:
                                 PTMXMHU1,PTMXMHU2,PTMXMHU3,PTMXECNM,PTMXECA1:
                                 PTMXECA2,PTMXECA3,PTMXECA4,PTMXECPC,PTMXECPP:
                                 PTMXECBP,PTMXECRE,PTMXNRNM,PTMXNRA1,PTMXNRA2:
                                 PTMXNRA3,PTMXNRA4,PTMXNRPC,PTMXNRPP,PTMXNRBP:
                                 PTMXNRRE,PTMX3BEX,PTMXCARD,PTMXCEXP,PTMXCXMP:
                                 PTMXFMLY,PTMXCHNM,PTMXDOFR,LOCDOCT,PMPXRH1G:
                                 PTMXSPID,PMPXR1GC,PTMXOSDT,PTNINMPI:
                                 PTMXOPER,PTMXUKDO,PTMXCELL,PTMXADD1:
                                 PTMXADD2,PTMXADD3,PTMXADD4,PTMXPOST,PMPXINTR:
                                 PATLANG,PREFINT,PMPXLNG3,PMPXPEML,PMPXEDOB:
                                 PMPXCMOB,PMPXCEML,PMPXCCRP,PMPXKMOB,PMPXKEML:
                                 PMPXKCRP,PMPXRMOB,PMPXREML,PMPXRCRP,PMPXMEDC:
                                 PMPXDETY,PMPXPRIS,PMPXCSER,PMPXPHEI,PMPXPWEI:
                                 PMPXDREC,DVACCODE,PMPXPNSD,PMPXUYN4,PMPXUYN5:
                                 PMPXUYN6,PMPXABRG,PMPXPRVI,PMPXCRIN,PMPXHOML:
                                 PMPXUDC1,PMPXUDC2,PMPXUDC3,PMPXUSR7,PMPXUSR8:
                                 PMPXUSR9,PMPXMSNA,PMPXMGNA,PMPXMTLE,PMPXMAD1:
                                 PMPXMAD2,PMPXMAD3,PMPXMAD4,PMPXMPOS,PMPXMPNO:
                                 PMPXMBNO,PMPXMMNO,PMPXMEML,MUMCONT,PMPXMCRP:
                                 PMPXMLAB,PMPXMREL,PMPXFSNA,PMPXFGNA,PMPXFTLE:
                                 PMPXFAD1,PMPXFAD2,PMPXFAD3,PMPXFAD4,PMPXFPOS:
                                 PMPXFPNO,PMPXFBNO,PMPXFMNO,PMPXFEML,FATCONT:
                                 PMPXFCRP,PMPXFLAB,PMPXFREL:
                                 BKRXPOWD,BKRXADWD:
                                 BKRXCDTE,BKRXPSTY,BKRXCNDT,BKRXUDF1,BKRXUDF2:
                                 BKRXUDF3,BKRXUDF4,BKRXUDF5,BKRXUDD1,BKRXUDD2:
                                 BKRXUDD3,BKRXUDD4,BKRXUFF1,BKRXUFF2,BKRXUFF3:
                                 BKRXUFF4,BKRXEDC1,BKRXEDC2,BKRXEDC3,BKRXODTE:
                                 BKRXOPRD,DATETIME,CONSULT,BKRESDOC,BKREEDAT:
                                 BKREATIM,BKREPDAT,BKREPTIM,BKREADAT,BKRETYPE:
                                 BKRECANC,BKREOMEM,BKREPREV,BKREACCM,BKREPROC:
                                 BKRECNT,PATWLOC,BKREADMN,BKREPREA,BKREEBED:
                                 ADMTYPE,ADMCLSS,CLIUNIT,BKRETDOC,BKRECLMT:
                                 REFDOCT,BKREGPPC,BKREGPFA,BKRERESI,BKREEATY:
                                 BKREECRA,BKREGPPT,BKREDOFR,BKREOPER,BKREELOS:
                                 BKREBKDT,WMTIME,WMDESC,WMREASON,SP1
.
          GOTO      CUBM9700 IF EOS              * e-Gate connection lost
          GOTO      CUBM9500 IF OVER             * NAK returned from e-Gate
.
CUBM9000  ADD       ONE,CUBSENT
          DISPLAY   *P35:18,CUBSENT;
          MOVE      ZERO,EXIT
          GOTO      CUBM9999
.
CUBM9500  ADD       ONE,CUBFAIL
          DISPLAY   *P44:18,CUBFAIL;
          MOVE      ONE,EXIT
          GOTO      CUBM9999
.
CUBM9700  MOVE      TWO,EXIT
.
CUBM9999  RETURN
+
.******************************************************************************
.*                                  CCBM0000       Called by: RDIN0000        *
.*                       Write Cancel Booking Message                         *
.* Returns:  EXIT  0 = message sent ok                                        *
.*                 1 = message rejected                                       *
.*                 2 = e-Gate connection lost                                 *
.******************************************************************************
CCBM0000  MOVE      H7INMESI,KEY20
          CALL      RDBKQUE1                     * Booking details found ?
          BRANCH    OVRCD,CCBM9500               * no - error
.
          CALL      GDTM0000                     * get message date/time
.
.         Write message
.
          MOVE      "CCB",MESSTYPE
          WRITE     DGATE;MESSTYPE,BKREURNO,BKREBOOK,BKRECANC,DATETIME,SP1
.
          GOTO      CCBM9700 IF EOS              * e-Gate connection lost
          GOTO      CCBM9500 IF OVER             * NAK returned from e-Gate
.
CCBM9000  ADD       ONE,CCBSENT
          DISPLAY   *P35:19,CCBSENT;
          MOVE      ZERO,EXIT
          GOTO      CCBM9999
.
CCBM9500  ADD       ONE,CCBFAIL
          DISPLAY   *P44:19,CCBFAIL;
          MOVE      ONE,EXIT
          GOTO      CCBM9999
.
CCBM9700  MOVE      TWO,EXIT
.
CCBM9999  RETURN
+
.******************************************************************************
.*                                  CPOM0000       Called by: RDIN0000        *
.*                       Write On-Leave Message                               *
.* Returns:  EXIT  0 = message sent ok                                        *
.*                 1 = message rejected                                       *
.*                 2 = e-Gate connection lost                                 *
.******************************************************************************
CPOM0000  PACK      KEY22,H7INMESI,SP1,ONE
          CALL      RDPMQVI1                     * Visit details found ?
          BRANCH    OVRCD,CPOM9500               * no - error
.
.         Write message
.
          CALL      GDTM0000                     * get message date/time
.
          MOVE      "CPO",MESSTYPE
          WRITE     DGATE;MESSTYPE,TURNO,TADMN,TDATE,TTIME,PTTRLTYP,ARETDTE:
                          DATETIME,SP1
.
          GOTO      CPOM9700 IF EOS              * e-Gate connection lost
          GOTO      CPOM9500 IF OVER             * NAK returned from e-Gate
.
CPOM9000  ADD       ONE,CPOSENT
          DISPLAY   *P35:7,CPOSENT;
          MOVE      ZERO,EXIT
          GOTO      CPOM9999
.
CPOM9500  ADD       ONE,CPOFAIL
          DISPLAY   *P44:7,CPOFAIL;
          MOVE      ONE,EXIT
          GOTO      CPOM9999
.
CPOM9700  MOVE      TWO,EXIT
.
CPOM9999  RETURN
+
.******************************************************************************
.*                                  CPRM0000       Called by: RDIN0000        *
.*                       Write Return from Leave Message                      *
.* Returns:  EXIT  0 = message sent ok                                        *
.*                 1 = message rejected                                       *
.*                 2 = e-Gate connection lost                                 *
.******************************************************************************
CPRM0000  PACK      KEY22,H7INMESI,SP1,ONE
          CALL      RDPMQVI1                     * Visit details found ?
          BRANCH    OVRCD,CPRM9500               * no - error
.
.         Format Visit coded fields for HL7
.
          MOVE      TADOCT,CONSCODE
          CALL      GCON0000                     * format consultant
          MOVE      CONSDESC,CONSULT
.
          MOVE      TDEPT,UNITCODE
          CALL      UNIT0000                     * format clinical unit
          MOVE      UNITDESC,CLIUNIT
.
          MOVE      TWARD,WARDCODE
          CALL      GWRD0000                     * format patient location
          MOVE      WARDDESC,PATWLOC
.
          CALL      GDTM0000                     * get message date/time
.
.         Write message
.
          MOVE      "CPR",MESSTYPE
          WRITE     DGATE;MESSTYPE,TURNO,TADMN,PATWLOC,TBED,TDATE,TTIME:
                                   CONSULT,CLIUNIT,MHLRCODE,DATETIME,SP1
.
          GOTO      CPRM9700 IF EOS              * e-Gate connection lost
          GOTO      CPRM9500 IF OVER             * NAK returned from e-Gate
.
CPRM9000  ADD       ONE,CPRSENT
          DISPLAY   *P35:8,CPRSENT;
          MOVE      ZERO,EXIT
          GOTO      CPRM9999
.
CPRM9500  ADD       ONE,CPRFAIL
          DISPLAY   *P44:8,CPRFAIL;
          MOVE      ONE,EXIT
          GOTO      CPRM9999
.
CPRM9700  MOVE      TWO,EXIT
.
CPRM9999  RETURN
+
.******************************************************************************
.*                                  CPAM0000       Called by: RDIN0000        *
.*                       Write Cancel Pre-admission Message                   *
.* Returns:  EXIT  0 = message sent ok                                        *
.*                 1 = message rejected                                       *
.*                 2 = e-Gate connection lost                                 *
.******************************************************************************
CPAM0000  PACK      KEY22,H7INMESI,SP1,ONE
          CALL      RDPMQVI1                     * Visit details found ?
          BRANCH    OVRCD,CPAM9500               * no - error
.
          CALL      GDTM0000                     * get message date/time
.
.         Write message
.
          MOVE      "CPA",MESSTYPE
          WRITE     DGATE;MESSTYPE,AURNO,AADMNO,ACANCEL,DATETIME,SP1   *C-90201
.
          GOTO      CPAM9700 IF EOS              * e-Gate connection lost
          GOTO      CPAM9500 IF OVER             * NAK returned from e-Gate
.
CPAM9000  ADD       ONE,CPASENT
          DISPLAY   *P8:18,CPASENT;
          MOVE      ZERO,EXIT
          GOTO      CPAM9999
.
CPAM9500  ADD       ONE,CPAFAIL
          DISPLAY   *P18:18,CPAFAIL;
          MOVE      ONE,EXIT
          GOTO      CPAM9999
.
CPAM9700  MOVE      TWO,EXIT
.
CPAM9999  RETURN
+
.******************************************************************************
.*                                  CWAM0000       Called by: RDIN0000        *
.*                       Write W/L Addition Message                           *
.* Returns:  EXIT  0 = message sent ok                                        *
.*                 1 = message rejected                                       *
.*                 2 = e-Gate connection lost                                 *
.******************************************************************************
CWAM0000  MOVE      H7INMESI,KEY20
          CALL      RDPMQPT1                     * PMI details found ?
          BRANCH    OVRCD,CWAM9500               * no - error
.
          MOVE      H7INMESI,KEY20
          CALL      RDWTQUE1                     * W/L details found ?
          BRANCH    OVRCD,CWAM9500               * no - error
.
.         Format PMI coded fields for HL7
.
          CALL      LDOC0000                     * format local doctor
          CALL      GREL0000                     * format religion
          CALL      GLAN0000                     * format language
          CALL      PINL0000                     * format preferred interpreter
.                                                  language
          CALL      PCON0000                     * format patient COB
          CALL      FCON0000                     * format father's COB
          CALL      MCON0000                     * format mother's COB
.
          MOVE      PFUNDH,FUNDCODE
          CALL      GFND0000                     * format health fund
          MOVE      FUNDDESC,PHFUNDD
.
          MOVE      PFUNDH,FUNDCODE
          MOVE      PFNDTB,TABLCODE
          CALL      GTBL0000                     * format fund table
          MOVE      TABLDESC,PHFTABD
.
.         Format Visit coded fields for HL7
.
          MOVE      WMDOCTOR,CONSCODE
          CALL      GCON0000                     * format consultant
          MOVE      CONSDESC,CONSULT
.
          PACK      REFDCODE,WTWMRFGP,SP10
          CALL      GREF0000                     * format referring doctor
          MOVE      REFDDESC,REFDOCT
.
          MOVE      WTWMSRCR,SRCECODE
          CALL      GSRC0000                     * format source of referral
          MOVE      SRCEDESC,SRCREFL
.
          MOVE      WTWMCLSS,ADMNCODE
          CALL      GTYP0000                     * format admission type
          MOVE      ADMNDESC,ADMTYPE
.
          MOVE      WMPCAT,CLASCODE
          CALL      CLAS0000                     * format admission class
          MOVE      CLASDESC,ADMCLSS
.
.         Write message
.
          CALL      GDTM0000                     * get message date/time
          CALL      MEDI0000                     * format full medicare number
          CALL      GDVA0000                     * get DVA details
.
          MOVE      "CWA",MESSTYPE
          WRITE     DGATE;MESSTYPE,PURNO,CSALIAS,SP8,PTITL,PHOSP:
                                 PLDAYS,PBDEBT,PSNAME,PGNAME,PPSNAME:
                                 PADD1,PADD2,PSUBRB,PADD4,PPOST:
                                 PTELEP,PTELEB,PSEX,PMSTAT,PBDATE:
                                 PATCONT,RELIGON,PTYPE,POCCUP,PLDDATE:
                                 FULLMEDI,PPENNO,PPNDTE,DVADIM10,PSMOK:
                                 PMICRO,PCEASE,PCASE,PAUTOPY,PHIGH1:
                                 PHIGH2,PHIGH3,PLOCDOC,PHFUNDD,PHFTABD:
                                 PFNDMM,PUSR1,PUSR2,PUSR3,PUSR4:
                                 PUSR5,PUSR6,PUYN1,PUYN2,PUYN3:
                                 PYRRES,PNKNAME,PNKADD1,PNKADD2,PNKSUBR:
                                 PNKADD4,PNKPOST,PNKTELP,PNKTELB,PNKRELP:
                                 PFNDYY,PFNDCG,PDECDTE,PDIET,PINITHOS:
                                 PHKADUNI,PTMAEMPC,PTMANOKO,PTMANOKE,PTMADCNO:
                                 PTMXRDAT,PTMXMEAL,PTMXLGA,PTMXLS,PTMXLSDT:
                                 PTMXFHMD,PTMXMHU1,PTMXMHU2,PTMXMHU3,PTMXECNM:
                                 PTMXECA1,PTMXECA2,PTMXECA3,PTMXECA4,PTMXECPC:
                                 PTMXECPP,PTMXECBP,PTMXECRE,PTMXNRNM,PTMXNRA1:
                                 PTMXNRA2,PTMXNRA3,PTMXNRA4,PTMXNRPC,PTMXNRPP:
                                 PTMXNRBP,PTMXNRRE,PTMX3BEX,PTMXCARD,PTMXCEXP:
                                 PTMXCXMP,PTMXFMLY,PTMXCHNM,PTMXDOFR,LOCDOCT:
                                 PMPXRH1G,PTMXSPID,PMPXR1GC,PTMXOSDT,PTNINMPI:
                                 NHMASURN,NHMAGIV1,NHMAGIV2,NHMAGIV3,NHMAPREI:
                                 NHMAADD1,NHMAADD2,NHMAADD3,NHMAADD4,NHMAADD5:
                                 NHMADOB,NHMADDTH,NHMADOMC,NHMARES,NHMAETH:
                                 NHMASEX,NHMADAT,NHMATIM,NHMAETH2,NHMAETH3:
                                 PTMXOPER,PTMXUKDO,PTMXCELL,PTMXADD1,PTMXADD2:
                                 PTMXADD3,PTMXADD4,PTMXPOST,PMPXINTR,PATLANG:
                                 PREFINT,PMPXLNG3,PMPXPEML,PMPXEDOB,PMPXCMOB:
                                 PMPXCEML,PMPXCCRP,PMPXKMOB,PMPXKEML,PMPXKCRP:
                                 PMPXRMOB,PMPXREML,PMPXRCRP,PMPXMEDC,PMPXDETY:
                                 PMPXPRIS,PMPXCSER,PMPXPHEI,PMPXPWEI,PMPXDREC:
                                 DVACCODE,PMPXPNSD,PMPXUYN4,PMPXUYN5,PMPXUYN6:
                                 PMPXABRG,PMPXPRVI,PMPXCRIN,PMPXHOML,PMPXUDC1:
                                 PMPXUDC2,PMPXUDC3,PMPXUSR7,PMPXUSR8,PMPXUSR9:
                                 PMPXMSNA,PMPXMGNA,PMPXMTLE,PMPXMAD1,PMPXMAD2:
                                 PMPXMAD3,PMPXMAD4,PMPXMPOS,PMPXMPNO,PMPXMBNO:
                                 PMPXMMNO,PMPXMEML,MUMCONT,PMPXMCRP,PMPXMLAB:
                                 PMPXMREL,PMPXFSNA,PMPXFGNA,PMPXFTLE,PMPXFAD1:
                                 PMPXFAD2,PMPXFAD3,PMPXFAD4,PMPXFPOS,PMPXFPNO:
                                 PMPXFBNO,PMPXFMNO,PMPXFEML,FATCONT,PMPXFCRP:
                                 PMPXFLAB,PMPXFREL,WMCODE,WMTIME,WMDESC:
                                 WMREASON,WMDATE1,WMDATE2,WMDATE3,WMUNIT:
                                 CONSULT,WMSTAY,WMPTY,WMNOTICE,WMPTYPE:
                                 ADMCLSS,WMUDEF1,WMUDEF2,WMUDEF3,WMUDEF4:
                                 WMBOOK,WMKEYDT,WTWMREAD,WTWMDEDA,ADMTYPE:
                                 WTWMDTAD,WTWMACAT,WTWMGADD,WTWMDABD,WTWMEATY:
                                 WTWMADMC,WTWMECRA,WTWMGPFA,REFDOCT,WTWMGPPC:
                                 WTWMNAFR,WTWMNATO,WTWMGPPT,WTWMDOFR,WTWMIHSP:
                                 WTWMVLSF,WTWMPRO2,WTWMPRO3,WTWMTRPA,WMUDEF5:
                                 WMUDEF6,WMUDEF7,WMUDEF8,WTWMRANK,SRCREFL:
                                 WTWMDRSA,WTWMDOSA,WTWMPHSP,WTWMBSCD,WTTXPLST:
                                 WTTXPOWD,WTTXADMW,WTTXPSTY,WTTXIDYC,WTTXADMF:
                                 WTTXEQR1,WTTXEQR2,WTTXPAST,WTTXCNSN,WTTXNTGP:
                                 WTTXPATM,WTTXLEQR,DATETIME,WMCNT,SP1
.
          GOTO      CWAM9700 IF EOS              * e-Gate connection lost
          GOTO      CWAM9500 IF OVER             * NAK returned from e-Gate
.
CWAM9000  ADD       ONE,CWASENT
          DISPLAY   *P35:20,CWASENT;
          MOVE      ZERO,EXIT
          GOTO      CWAM9999
.
CWAM9500  ADD       ONE,CWAFAIL
          DISPLAY   *P44:20,CWAFAIL;
          MOVE      ONE,EXIT
          GOTO      CWAM9999
.
CWAM9700  MOVE      TWO,EXIT
.
CWAM9999  RETURN
+
.******************************************************************************
.*                                  CWCM0000       Called by: RDIN0000        *
.*                       Write W/L Cancellation Message                       *
.* Returns:  EXIT  0 = message sent ok                                        *
.*                 1 = message rejected                                       *
.*                 2 = e-Gate connection lost                                 *
.******************************************************************************
CWCM0000  MOVE      H7INMESI,KEY20
          CALL      RDWTQUE1                     * W/L details found ?
          BRANCH    OVRCD,CWCM9500               * no - error
.
          CALL      GDTM0000                     * get message date/time
.
.         Write message
.
          MOVE      "CWC",MESSTYPE
          WRITE     DGATE;MESSTYPE,WMURNO,WMCODE,WMDESC,WMDATE1,WMDATE2:
                                   WMBOOK,WMDATE4,WMREMOVE,DATETIME,SP1
.
          GOTO      CWCM9700 IF EOS              * e-Gate connection lost
          GOTO      CWCM9500 IF OVER             * NAK returned from e-Gate
.
CWCM9000  ADD       ONE,CWCSENT
          DISPLAY   *P35:21,CWCSENT;
          MOVE      ZERO,EXIT
          GOTO      CWCM9999
.
CWCM9500  ADD       ONE,CWCFAIL
          DISPLAY   *P44:21,CWCFAIL;
          MOVE      ONE,EXIT
          GOTO      CWCM9999
.
CWCM9700  MOVE      TWO,EXIT
.
CWCM9999  RETURN
+
.******************************************************************************
.*                                  CRMM0000       Called by: RDIN0000        *
.*                       Write Med Record Movement Message                    *
.* Returns:  EXIT  0 = message sent ok                                        *
.*                 1 = message rejected                                       *
.*                 2 = e-Gate connection lost                                 *
.******************************************************************************
CRMM0000  MOVE      H7INMESI,KEY20
          CALL      RDMRQUE1                     * Med Records details found ?
          BRANCH    OVRCD,CRMM9500               * no - error
.
          CALL      GDTM0000                     * get message date/time
.
.         Write message
.
          MOVE      "CRM",MESSTYPE
          WRITE     DGATE;MESSTYPE,MRMAURNO,MRMADOTY,MRMAHLOC,MRMAVOLN:
                                   MRHIDATE,MRHITIME,MRHILOC,MRHIRECV:
                                   MRHIREAS,MRHIOPER,MRHIDDUE,MRHISTAT:
                                   MRHIREQB,MRHIUSID,MRHIEXTN,MRHIPAGE:
                                   DATETIME,SP1
.
          GOTO      CRMM9700 IF EOS              * e-Gate connection lost
          GOTO      CRMM9500 IF OVER             * NAK returned from e-Gate
.
CRMM9000  ADD       ONE,CRMSENT
          DISPLAY   *P35:22,CRMSENT;
          MOVE      ZERO,EXIT
          GOTO      CRMM9999
.
CRMM9500  ADD       ONE,CRMFAIL
          DISPLAY   *P44:22,CRMFAIL;
          MOVE      ONE,EXIT
          GOTO      CRMM9999
.
CRMM9700  MOVE      TWO,EXIT
.
CRMM9999  RETURN
+
.******************************************************************************
.*                                  CEAM0000       Called by: RDIN0000        *
.*                       Write Create Allied Health Encounter                 *
.* Returns:  EXIT  0 = message sent ok                                        *
.*                 1 = message rejected                                       *
.*                 2 = e-Gate connection lost                                 *
.******************************************************************************
CEAM0000  MOVE      H7INMESI,KEY20
          CALL      RDPMQPT1                     * PMI details found ?
          BRANCH    OVRCD,CEAM9500               * no - error
.
          MOVE      H7INMESI,KEY20
          CALL      RDALQUE1                     * All.Health details found ?
          BRANCH    OVRCD,CEAM9500               * no - error
.
.         Note:  retrieves only 1 erc record per encounter (if present)
.
          PACK      KEY24,ALREVISN,ALENENCT,SP70 * AH erc key
          CALL      RSALERC2                     * position on visit for erc
          CALL      RKALERC2                     * read next record
          BRANCH    OVRCD,CEAM1000               * eof - no erc record
.
          MATCH     ALERVISN,ALREVISN            * same visit still ?
          IF        @EQUAL
            MATCH     ALERENCT,ALENENCT          * same encounter still ?
            GOTO      CEAM2000 IF EQUAL          * yes
          ENDIF
.
CEAM1000  CALL      CLALLERC                     * clear erc variables
.
CEAM2000  PACK      KEY8,ALREVISN,SP70           * load allaefaf key
          CALL      RDALAEF1                     * AH referral record found ?
          IF        OVRCD = 1
            CALL      CLALLAEF                   * no - clear aef variables
          ENDIF
.
.         Format PMI coded fields for HL7
.
          CALL      LDOC0000                     * format local doctor
          CALL      GREL0000                     * format religion
          CALL      GLAN0000                     * format language
          CALL      PINL0000                     * format preferred interpreter
.                                                  language
          CALL      PCON0000                     * format patient COB
          CALL      FCON0000                     * format father's COB
          CALL      MCON0000                     * format mother's COB
.
          MOVE      PFUNDH,FUNDCODE
          CALL      GFND0000                     * format health fund
          MOVE      FUNDDESC,PHFUNDD
.
          MOVE      PFUNDH,FUNDCODE
          MOVE      PFNDTB,TABLCODE
          CALL      GTBL0000                     * format fund table
          MOVE      TABLDESC,PHFTABD
.
          PACK      REFDCODE,ALENHCP,SP10
          CALL      GREF0000                     * format service provider
          MOVE      REFDDESC,REFDOCT
.
          CALL      GDTM0000                     * get message date/time
          CALL      MEDI0000                     * format full medicare number
          CALL      GDVA0000                     * get DVA details
.
.         Write message
.
          MOVE      "CEA",MESSTYPE
          WRITE     DGATE;MESSTYPE,PURNO,CSALIAS,SP8,PTITL,PHOSP:
                                 PLDAYS,PBDEBT,PSNAME,PGNAME,PPSNAME:
                                 PADD1,PADD2,PSUBRB,PADD4,PPOST:
                                 PTELEP,PTELEB,PSEX,PMSTAT,PBDATE:
                                 PATCONT,RELIGON,PTYPE,POCCUP,PLDDATE:
                                 FULLMEDI,PPENNO,PPNDTE,DVADIM10,PSMOK:
                                 PMICRO,PCEASE,PCASE,PAUTOPY,PHIGH1:
                                 PHIGH2,PHIGH3,PLOCDOC,PHFUNDD,PHFTABD:
                                 PFNDMM,PUSR1,PUSR2,PUSR3,PUSR4:
                                 PUSR5,PUSR6,PUYN1,PUYN2,PUYN3:
                                 PYRRES,PNKNAME,PNKADD1,PNKADD2,PNKSUBR:
                                 PNKADD4,PNKPOST,PNKTELP,PNKTELB,PNKRELP:
                                 PFNDYY,PFNDCG,PDECDTE,PDIET,PINITHOS:
                                 PHKADUNI,PTMAEMPC,PTMANOKO,PTMANOKE,PTMADCNO:
                                 PTMXRDAT,PTMXMEAL,PTMXLGA,PTMXLS,PTMXLSDT:
                                 PTMXFHMD,PTMXMHU1,PTMXMHU2,PTMXMHU3,PTMXECNM:
                                 PTMXECA1,PTMXECA2,PTMXECA3,PTMXECA4,PTMXECPC:
                                 PTMXECPP,PTMXECBP,PTMXECRE,PTMXNRNM,PTMXNRA1:
                                 PTMXNRA2,PTMXNRA3,PTMXNRA4,PTMXNRPC,PTMXNRPP:
                                 PTMXNRBP,PTMXNRRE,PTMX3BEX,PTMXCARD,PTMXCEXP:
                                 PTMXCXMP,PTMXFMLY,PTMXCHNM,PTMXDOFR,LOCDOCT:
                                 PMPXRH1G,PTMXSPID,PMPXR1GC,PTMXOSDT,PTNINMPI:
                                 NHMASURN,NHMAGIV1,NHMAGIV2,NHMAGIV3,NHMAPREI:
                                 NHMAADD1,NHMAADD2,NHMAADD3,NHMAADD4,NHMAADD5:
                                 NHMADOB,NHMADDTH,NHMADOMC,NHMARES,NHMAETH:
                                 NHMASEX,NHMADAT,NHMATIM,NHMAETH2,NHMAETH3:
                                 PTMXOPER,PTMXUKDO,PTMXCELL,PTMXADD1,PTMXADD2:
                                 PTMXADD3,PTMXADD4,PTMXPOST,PMPXINTR,PATLANG:
                                 PREFINT,PMPXLNG3,PMPXPEML,PMPXEDOB,PMPXCMOB:
                                 PMPXCEML,PMPXCCRP,PMPXKMOB,PMPXKEML,PMPXKCRP:
                                 PMPXRMOB,PMPXREML,PMPXRCRP,PMPXMEDC,PMPXDETY:
                                 PMPXPRIS,PMPXCSER,PMPXPHEI,PMPXPWEI,PMPXDREC:
                                 DVACCODE,PMPXPNSD,PMPXUYN4,PMPXUYN5,PMPXUYN6:
                                 PMPXABRG,PMPXPRVI,PMPXCRIN,PMPXHOML,PMPXUDC1:
                                 PMPXUDC2,PMPXUDC3,PMPXUSR7,PMPXUSR8,PMPXUSR9:
                                 PMPXMSNA,PMPXMGNA,PMPXMTLE,PMPXMAD1,PMPXMAD2:
                                 PMPXMAD3,PMPXMAD4,PMPXMPOS,PMPXMPNO,PMPXMBNO:
                                 PMPXMMNO,PMPXMEML,MUMCONT,PMPXMCRP,PMPXMLAB:
                                 PMPXMREL,PMPXFSNA,PMPXFGNA,PMPXFTLE,PMPXFAD1:
                                 PMPXFAD2,PMPXFAD3,PMPXFAD4,PMPXFPOS,PMPXFPNO:
                                 PMPXFBNO,PMPXFMNO,PMPXFEML,FATCONT,PMPXFCRP:
                                 PMPXFLAB,PMPXFREL:
                                 ALREVISN,ALENENCT,ALENCLIN:
                                 REFDOCT,ALENSDAT,ALENSTIM,ALENLOCA,ALENLINK:
                                 ALENTYPE,ALENSERV,ALENDIUN,ALENDBUN,ALENINUN:
                                 ALENIBUN,ALENBULK,ALENUDT1,ALENUTM1,ALENUDT2:
                                 ALENUTM2,ALENUDT3,ALENUTM3,ALENUDT4,ALENUTM4:
                                 ALENUHC1,ALENUHC2,ALENUHC3,ALENUHC4,ALENUDI1:
                                 ALENUDI2,ALENUDI3,ALENUDI4,ALENUDI5,ALENUDI6:
                                 ALENUYN1,ALENUYN2,ALENUYN3,ALENUYN4,ALENUYN5:
                                 ALENUYN6,ALENUYN7,ALENUYN8,ALENUYN9,ALENUFF1:
                                 ALENUFF2,ALENUFF3,ALENUC01,ALENUC02,ALENUC03:
                                 ALENUC04,ALENUC05,ALENUC06,ALENUC07,ALENUC08:
                                 ALENUC09,ALENUC10,ALENUC11,ALENUC12,ALENUC13:
                                 ALENUC14,ALENUC15,ALENUC16,ALENUC17,ALENUC18:
                                 ALENUC19,ALENUC20,ALENUC21,ALENUC22,ALENUC23:
                                 ALENUC24,ALENUC25,ALENUC26,ALENUC27,ALENUC28:
                                 ALENUC29,ALENUC30,ALENUC31,ALENUC32,ALENUC33:
                                 ALENUC34,ALENUC35,ALENUC36,ALENUC37,ALENUC38:
                                 ALENUC39,ALENUC40,ALENUF01,ALENUF02,ALENUF03:
                                 ALENUF04,ALENUF05,ALENUF06,ALENUF07,ALENUF08:
                                 ALENUF09,ALENUF10,ALENUF11,ALENUF12,ALENUF13:
                                 ALENUF14,ALENUF15,ALENUF16,ALENUF17,ALENUF18:
                                 ALENUF19,ALENUF20,ALENCMT1,ALENCMT2,ALENCOMP:
                                 ALENUNIQ,DATETIME:
                                 ALRESTAT,ALREDACT,ALRERCLO,ALREDCLO,ALRETCLO:
                                 ALREUCLO,ALRERCAN,ALREDCAN,ALRETCAN,ALREUCAN:
                                 ALRERINA,ALREDINA,ALRETINA,ALREDINU,ALREUINA:
                                 ALRERDAT,ALRERDEP,ALRERDOC,ALRERHCP,ALRERHCR:
                                 ALRERHCT,ALREDEPT,ALREUNIT,ALREPRTY,ALREPRO1:
                                 ALREPRO2,ALREPRO3,ALREDIA1,ALREDIA2,ALREDIA3:
                                 ALRESRCE,ALREBULK,ALREDREV,ALREHCP,ALREDREC:
                                 ALREUC01,ALREUC02,ALREUC03,ALREUC04,ALREUC05:
                                 ALREUC06,ALREUC07,ALREUC08,ALREUC09,ALREUC10:
                                 ALREUC11,ALREUC12,ALREUC13,ALREUC14,ALREUC15:
                                 ALREUC16,ALREUC17,ALREUC18,ALREUC19,ALREUC20:
                                 ALREUC21,ALREUC22,ALREUC23,ALREUC24,ALREUC25:
                                 ALREUC26,ALREUC27,ALREUC28,ALREUC29,ALREUC30:
                                 ALREUC31,ALREUC32,ALREUC33,ALREUC34,ALREUC35:
                                 ALREUC36,ALREUC37,ALREUC38,ALREUC39,ALREUC40:
                                 ALREUYN1,ALREUYN2,ALREUYN3,ALREUYN4,ALREUHC1:
                                 ALREUHC2,ALREUHC3,ALREUHC4,ALREUFR1,ALREUFR2:
                                 ALREUDT1,ALREUTM1,ALREUDT2,ALREUTM2,ALREUDT3:
                                 ALREUTM3,ALREUDT4,ALREUTM4,ALREUNO1,ALREUNO2:
                                 ALAEMRYN,ALAEETYN,ALAERSYN,ALAEOTYN,ALAEOTDS:
                                 ALAEPDRS,ALERPHOT,ALERLASR,ALERPOSS,ALERCAR:
                                 ALERCARH,ALERNVIE,ALERNTRA,ALERNNEG,ALERNBWP:
                                 ALERNCLP,ALERNVID,ALERCDAT,ALERCTIM,ALERCUID:
                                 ALERUDAT,ALERUTIM,ALERUUID,ALERDSNT,ALERSTFF:
                                 ALERNDIG,SP1
.
          GOTO      CEAM9700 IF EOS              * e-Gate connection lost
          GOTO      CEAM9500 IF OVER             * NAK returned from e-Gate
.
CEAM9000  ADD       ONE,CEASENT
          DISPLAY   *P35:23,CEASENT;
          MOVE      ZERO,EXIT
          GOTO      CEAM9999
.
CEAM9500  ADD       ONE,CEAFAIL
          DISPLAY   *P44:23,CEAFAIL;
          MOVE      ONE,EXIT
          GOTO      CEAM9999
.
CEAM9700  MOVE      TWO,EXIT
.
CEAM9999  RETURN
+
.******************************************************************************
.*                                  CEDM0000       Called by: RDIN0000        *
.*                       Write Delete Allied Health Encounter                 *
.* Returns:  EXIT  0 = message sent ok                                        *
.*                 1 = message rejected                                       *
.*                 2 = e-Gate connection lost                                 *
.******************************************************************************
CEDM0000  MOVE      H7INMESI,KEY20
          CALL      RDALQUE1                     * All Health details found ?
          BRANCH    OVRCD,CEDM9500               * no - error
.
          PACK      REFDCODE,ALENHCP,SP10
          CALL      GREF0000                     * format service provider
          MOVE      REFDDESC,REFDOCT
.
          CALL      GDTM0000                     * get message date/time
.
.         Write message
.
          MOVE      "CED",MESSTYPE
          WRITE     DGATE;MESSTYPE,ALREURNO,ALREVISN,ALENENCT,ALENCLIN:
                                   REFDOCT,ALENSDAT,ALENSTIM,ALENLOCA:
                                   ALENLINK,ALENTYPE,ALENSERV,ALENDIUN:
                                   ALENDBUN,ALENINUN,ALENIBUN:
                                   DATETIME,SP1
.
          GOTO      CEDM9700 IF EOS              * e-Gate connection lost
          GOTO      CEDM9500 IF OVER             * NAK returned from e-Gate
.
CEDM9000  ADD       ONE,CEDSENT
          DISPLAY   *P60:7,CEDSENT;
          MOVE      ZERO,EXIT
          GOTO      CEDM9999
.
CEDM9500  ADD       ONE,CEDFAIL
          DISPLAY   *P69:7,CEDFAIL;
          MOVE      ONE,EXIT
          GOTO      CEDM9999
.
CEDM9700  MOVE      TWO,EXIT
.
CEDM9999  RETURN
+
.******************************************************************************
.*                                  CAEM0000       Called by: RDIN0000        *
.*                           Write Emergency Visit                            *
.* Returns:  EXIT  0 = message sent ok                                        *
.*                 1 = message rejected                                       *
.*                 2 = e-Gate connection lost                                 *
.******************************************************************************
CAEM0000  MOVE      H7INMESI,KEY20
          CALL      RDPMQPT1                     * PMI details found ?
          BRANCH    OVRCD,CAEM9500               * no - error
.
          MOVE      H7INMESI,KEY20
          CALL      RDEMQUE1                     * Emergency details found ?
          BRANCH    OVRCD,CAEM9500               * no - error
.
.         Format PMI coded fields for HL7
.
          CALL      LDOC0000                     * format local doctor
          CALL      GREL0000                     * format religion
          CALL      GLAN0000                     * format language
          CALL      PINL0000                     * format preferred interpreter
.                                                  language
          CALL      PCON0000                     * format patient COB
          CALL      FCON0000                     * format father's COB
          CALL      MCON0000                     * format mother's COB
.
          MOVE      PFUNDH,FUNDCODE
          CALL      GFND0000                     * format health fund
          MOVE      FUNDDESC,PHFUNDD
.
          MOVE      PFUNDH,FUNDCODE
          MOVE      PFNDTB,TABLCODE
          CALL      GTBL0000                     * format fund table
          MOVE      TABLDESC,PHFTABD
.
.         Format Visit coded fields for HL7
.
          PACK      REFDCODE,EMVIDOCT,SP10
          CALL      GREF0000                     * format attending doctor
          MOVE      REFDDESC,ATTDOCT
.
          MOVE      EMVISRCE,SRCECODE
          CALL      GSRC0000                     * format source of referral
          MOVE      SRCEDESC,SRCREFL
.
          PACK      REFDCODE,EMVIREFG,SP10
          CALL      GREF0000                     * format referring doctor
          MOVE      REFDDESC,REFDOCT
.
          MOVE      EMVIACLS,ADMNCODE
          CALL      GTYP0000                     * format admission type
          MOVE      ADMNDESC,ADMTYPE
.
          MOVE      EMVIFUND,FUNDCODE
          CALL      GFND0000                     * format health fund
          MOVE      FUNDDESC,AHFUNDD
.
          MOVE      EMVIFUND,FUNDCODE
          MOVE      EMVITABL,TABLCODE
          CALL      GTBL0000                     * format fund table
          MOVE      TABLDESC,AHFTABD
.
          MOVE      EMVIUC20,PRESCODE
          CALL      GPRC0000                     * format presenting complaint
          MOVE      PRESDESC,PRESCOM
.
          CALL      GDTM0000                     * get message date/time
          CALL      MEDI0000                     * format full medicare number
          CALL      GDVA0000                     * get DVA details
.
.         Write message
.
          MOVE      "CAE",MESSTYPE
          WRITE     DGATE;MESSTYPE,PURNO,CSALIAS,SP8,PTITL,PHOSP:
                                 PLDAYS,PBDEBT,PSNAME,PGNAME,PPSNAME:
                                 PADD1,PADD2,PSUBRB,PADD4,PPOST:
                                 PTELEP,PTELEB,PSEX,PMSTAT,PBDATE:
                                 PATCONT,RELIGON,PTYPE,POCCUP,PLDDATE:
                                 FULLMEDI,PPENNO,PPNDTE,DVADIM10,PSMOK:
                                 PMICRO,PCEASE,PCASE,PAUTOPY,PHIGH1:
                                 PHIGH2,PHIGH3,PLOCDOC,PHFUNDD,PHFTABD:
                                 PFNDMM,PUSR1,PUSR2,PUSR3,PUSR4:
                                 PUSR5,PUSR6,PUYN1,PUYN2,PUYN3:
                                 PYRRES,PNKNAME,PNKADD1,PNKADD2,PNKSUBR:
                                 PNKADD4,PNKPOST,PNKTELP,PNKTELB,PNKRELP:
                                 PFNDYY,PFNDCG,PDECDTE,PDIET,PINITHOS:
                                 PHKADUNI,PTMAEMPC,PTMANOKO,PTMANOKE,PTMADCNO:
                                 PTMXRDAT,PTMXMEAL,PTMXLGA,PTMXLS,PTMXLSDT:
                                 PTMXFHMD,PTMXMHU1,PTMXMHU2,PTMXMHU3,PTMXECNM:
                                 PTMXECA1,PTMXECA2,PTMXECA3,PTMXECA4,PTMXECPC:
                                 PTMXECPP,PTMXECBP,PTMXECRE,PTMXNRNM,PTMXNRA1:
                                 PTMXNRA2,PTMXNRA3,PTMXNRA4,PTMXNRPC,PTMXNRPP:
                                 PTMXNRBP,PTMXNRRE,PTMX3BEX,PTMXCARD,PTMXCEXP:
                                 PTMXCXMP,PTMXFMLY,PTMXCHNM,PTMXDOFR,LOCDOCT:
                                 PMPXRH1G,PTMXSPID,PMPXR1GC,PTMXOSDT,PTNINMPI:
                                 NHMASURN,NHMAGIV1,NHMAGIV2,NHMAGIV3,NHMAPREI:
                                 NHMAADD1,NHMAADD2,NHMAADD3,NHMAADD4,NHMAADD5:
                                 NHMADOB,NHMADDTH,NHMADOMC,NHMARES,NHMAETH:
                                 NHMASEX,NHMADAT,NHMATIM,NHMAETH2,NHMAETH3:
                                 PTMXOPER,PTMXUKDO,PTMXCELL,PTMXADD1,PTMXADD2:
                                 PTMXADD3,PTMXADD4,PTMXPOST,PMPXINTR,PATLANG:
                                 PREFINT,PMPXLNG3,PMPXPEML,PMPXEDOB,PMPXCMOB:
                                 PMPXCEML,PMPXCCRP,PMPXKMOB,PMPXKEML,PMPXKCRP:
                                 PMPXRMOB,PMPXREML,PMPXRCRP,PMPXMEDC,PMPXDETY:
                                 PMPXPRIS,PMPXCSER,PMPXPHEI,PMPXPWEI,PMPXDREC:
                                 DVACCODE,PMPXPNSD,PMPXUYN4,PMPXUYN5,PMPXUYN6:
                                 PMPXABRG,PMPXPRVI,PMPXCRIN,PMPXHOML,PMPXUDC1:
                                 PMPXUDC2,PMPXUDC3,PMPXUSR7,PMPXUSR8,PMPXUSR9:
                                 PMPXMSNA,PMPXMGNA,PMPXMTLE,PMPXMAD1,PMPXMAD2:
                                 PMPXMAD3,PMPXMAD4,PMPXMPOS,PMPXMPNO,PMPXMBNO:
                                 PMPXMMNO,PMPXMEML,MUMCONT,PMPXMCRP,PMPXMLAB:
                                 PMPXMREL,PMPXFSNA,PMPXFGNA,PMPXFTLE,PMPXFAD1:
                                 PMPXFAD2,PMPXFAD3,PMPXFAD4,PMPXFPOS,PMPXFPNO:
                                 PMPXFBNO,PMPXFMNO,PMPXFEML,FATCONT,PMPXFCRP:
                                 PMPXFLAB,PMPXFREL:
                                 EMVIADMN,EMVISTAT,EMVIURNO,EMVIDATE,EMVITIME:
                                 EMVITRIG,EMVICOM1,EMVICOM2,EMVILOCN,ATTDOCT:
                                 EMVICOMP,EMVICLAS,EMVIINSR,SRCREFL,EMVISITN:
                                 EMVIMODE,EMVIADMT,EMVIDURN,EMVIEMPL,EMVIWAIT:
                                 EMVIPREV,AHFUNDD,AHFTABD,REFDOCT,EMVIREFD:
                                 EMVIPLIN,EMVIINIT,EMVIRTAS,EMVIDDAT,EMVIDTIM:
                                 EMVIDSTA,EMVIOPR1,EMVIOPR2,EMVIUC01,EMVIUC02:
                                 EMVIUC03,EMVIUC04,EMVIUC05,EMVIUC06,EMVIUC07:
                                 EMVIUC08,EMVIUC09,EMVIUC10,EMVIUC11,EMVIUC12:
                                 EMVIUC13,EMVIUC14,EMVIUC15,EMVIUC16,EMVIUC17:
                                 EMVIUC18,EMVIUC19,PRESCOM,EMVIUC21,EMVIUC22:
                                 EMVIUC23,EMVIUC24,EMVIUC25,EMVIUC26,EMVIUC27:
                                 EMVIUC28,EMVIUC29,EMVIUC30,EMVIUD01,EMVIUD02:
                                 EMVIUD03,EMVIUD04,EMVIUD05,EMVIUD06,EMVIUD07:
                                 EMVIUD08,EMVIUD09,EMVIUD10,EMVIUT01,EMVIUT02:
                                 EMVIUT03,EMVIUT04,EMVIUT05,EMVIUT06,EMVIUT07:
                                 EMVIUT08,EMVIUT09,EMVIUT10,EMVIYN01,EMVIYN02:
                                 EMVIYN03,EMVIYN04,EMVIYN05,EMVIYN06,EMVIYN07:
                                 EMVIYN08,EMVIYN09,EMVIYN10,EMVITXT1,EMVITXT2:
                                 EMVITXT3,EMVITXT4,EMVITXT5,EMVIUN01,EMVIUN02:
                                 EMVIUN03,EMVIUN04,EMVIUN05,EMVIELAP,EMVINSDT:
                                 EMVINSTM,EMVIDRDT,EMVIDRTM,EMVIPATT,EMVITSRC:
                                 EMVIDEST,EMVIAMBL,EMVIREGN,EMVISENT,EMVIUR01:
                                 EMVIUR02,EMVIUR03,EMVIUR04,EMVIUR05,EMVIPADM:
                                 EMVIEWRD,EMVIEBED,EMVIHFMN,ADMTYPE,EMVICCLS:
                                 EMVITRNS,EMVIDUM1,EMVITRDT,EMVITRTM,EMVIATNS:
                                 EMVIDUM2,EMVIEXLC,EMVISITE,EMVIUNIT,EMVICOM3:
                                 EMVICOM4,EMVICOM5,EMVICOM6,EMVIINJ1,EMVIINJ2:
                                 EMVINATI,EMVIINJC,EMVIHUMI,EMVIACTI,EMVILOCO:
                                 DATETIME,SP1
.
          GOTO      CAEM9700 IF EOS              * e-Gate connection lost
          GOTO      CAEM9500 IF OVER             * NAK returned from e-Gate
.
CAEM9000  ADD       ONE,CAESENT
          DISPLAY   *P60:8,CAESENT;
          MOVE      ZERO,EXIT
          GOTO      CAEM9999
.
CAEM9500  ADD       ONE,CAEFAIL
          DISPLAY   *P69:8,CAEFAIL;
          MOVE      ONE,EXIT
          GOTO      CAEM9999
.
CAEM9700  MOVE      TWO,EXIT
.
CAEM9999  RETURN
+
.******************************************************************************
.*                                  CECM0000       Called by: RDIN0000        *
.*                         Write Update Emergency Visit                       *
.* Returns:  EXIT  0 = message sent ok                                        *
.*                 1 = message rejected                                       *
.*                 2 = e-Gate connection lost                                 *
.******************************************************************************
CECM0000  MOVE      H7INMESI,KEY20
          CALL      RDPMQPT1                     * PMI details found ?
          BRANCH    OVRCD,CECM9500               * no - error
.
          MOVE      H7INMESI,KEY20
          CALL      RDEMQUE1                     * Emergency details found ?
          BRANCH    OVRCD,CECM9500               * no - error
.
.         Format PMI coded fields for HL7
.
          CALL      LDOC0000                     * format local doctor
          CALL      GREL0000                     * format religion
          CALL      GLAN0000                     * format language
          CALL      PINL0000                     * format preferred interpreter
.                                                  language
          CALL      PCON0000                     * format patient COB
          CALL      FCON0000                     * format father's COB
          CALL      MCON0000                     * format mother's COB
.
          MOVE      PFUNDH,FUNDCODE
          CALL      GFND0000                     * format health fund
          MOVE      FUNDDESC,PHFUNDD
.
          MOVE      PFUNDH,FUNDCODE
          MOVE      PFNDTB,TABLCODE
          CALL      GTBL0000                     * format fund table
          MOVE      TABLDESC,PHFTABD
.
.         Format Visit coded fields for HL7
.
          PACK      REFDCODE,EMVIDOCT,SP10
          CALL      GREF0000                     * format attending doctor
          MOVE      REFDDESC,ATTDOCT
.
          MOVE      EMVISRCE,SRCECODE
          CALL      GSRC0000                     * format source of referral
          MOVE      SRCEDESC,SRCREFL
.
          PACK      REFDCODE,EMVIREFG,SP10
          CALL      GREF0000                     * format referring doctor
          MOVE      REFDDESC,REFDOCT
.
          MOVE      EMVIACLS,ADMNCODE
          CALL      GTYP0000                     * format admission type
          MOVE      ADMNDESC,ADMTYPE
.
          MOVE      EMVIFUND,FUNDCODE
          CALL      GFND0000                     * format health fund
          MOVE      FUNDDESC,AHFUNDD
.
          MOVE      EMVIFUND,FUNDCODE
          MOVE      EMVITABL,TABLCODE
          CALL      GTBL0000                     * format fund table
          MOVE      TABLDESC,AHFTABD
.
          MOVE      EMVIUC20,PRESCODE
          CALL      GPRC0000                     * format presenting complaint
          MOVE      PRESDESC,PRESCOM
.
          CALL      GDTM0000                     * get message date/time
          CALL      MEDI0000                     * format full medicare number
          CALL      GDVA0000                     * get DVA details
.
.         Write message
.
          MOVE      "CEC",MESSTYPE
          WRITE     DGATE;MESSTYPE,PURNO,CSALIAS,SP8,PTITL,PHOSP:
                                 PLDAYS,PBDEBT,PSNAME,PGNAME,PPSNAME:
                                 PADD1,PADD2,PSUBRB,PADD4,PPOST:
                                 PTELEP,PTELEB,PSEX,PMSTAT,PBDATE:
                                 PATCONT,RELIGON,PTYPE,POCCUP,PLDDATE:
                                 FULLMEDI,PPENNO,PPNDTE,DVADIM10,PSMOK:
                                 PMICRO,PCEASE,PCASE,PAUTOPY,PHIGH1:
                                 PHIGH2,PHIGH3,PLOCDOC,PHFUNDD,PHFTABD:
                                 PFNDMM,PUSR1,PUSR2,PUSR3,PUSR4:
                                 PUSR5,PUSR6,PUYN1,PUYN2,PUYN3:
                                 PYRRES,PNKNAME,PNKADD1,PNKADD2,PNKSUBR:
                                 PNKADD4,PNKPOST,PNKTELP,PNKTELB,PNKRELP:
                                 PFNDYY,PFNDCG,PDECDTE,PDIET,PINITHOS:
                                 PHKADUNI,PTMAEMPC,PTMANOKO,PTMANOKE,PTMADCNO:
                                 PTMXRDAT,PTMXMEAL,PTMXLGA,PTMXLS,PTMXLSDT:
                                 PTMXFHMD,PTMXMHU1,PTMXMHU2,PTMXMHU3,PTMXECNM:
                                 PTMXECA1,PTMXECA2,PTMXECA3,PTMXECA4,PTMXECPC:
                                 PTMXECPP,PTMXECBP,PTMXECRE,PTMXNRNM,PTMXNRA1:
                                 PTMXNRA2,PTMXNRA3,PTMXNRA4,PTMXNRPC,PTMXNRPP:
                                 PTMXNRBP,PTMXNRRE,PTMX3BEX,PTMXCARD,PTMXCEXP:
                                 PTMXCXMP,PTMXFMLY,PTMXCHNM,PTMXDOFR,LOCDOCT:
                                 PMPXRH1G,PTMXSPID,PMPXR1GC,PTMXOSDT,PTNINMPI:
                                 NHMASURN,NHMAGIV1,NHMAGIV2,NHMAGIV3,NHMAPREI:
                                 NHMAADD1,NHMAADD2,NHMAADD3,NHMAADD4,NHMAADD5:
                                 NHMADOB,NHMADDTH,NHMADOMC,NHMARES,NHMAETH:
                                 NHMASEX,NHMADAT,NHMATIM,NHMAETH2,NHMAETH3:
                                 PTMXOPER,PTMXUKDO,PTMXCELL,PTMXADD1,PTMXADD2:
                                 PTMXADD3,PTMXADD4,PTMXPOST,PMPXINTR,PATLANG:
                                 PREFINT,PMPXLNG3,PMPXPEML,PMPXEDOB,PMPXCMOB:
                                 PMPXCEML,PMPXCCRP,PMPXKMOB,PMPXKEML,PMPXKCRP:
                                 PMPXRMOB,PMPXREML,PMPXRCRP,PMPXMEDC,PMPXDETY:
                                 PMPXPRIS,PMPXCSER,PMPXPHEI,PMPXPWEI,PMPXDREC:
                                 DVACCODE,PMPXPNSD,PMPXUYN4,PMPXUYN5,PMPXUYN6:
                                 PMPXABRG,PMPXPRVI,PMPXCRIN,PMPXHOML,PMPXUDC1:
                                 PMPXUDC2,PMPXUDC3,PMPXUSR7,PMPXUSR8,PMPXUSR9:
                                 PMPXMSNA,PMPXMGNA,PMPXMTLE,PMPXMAD1,PMPXMAD2:
                                 PMPXMAD3,PMPXMAD4,PMPXMPOS,PMPXMPNO,PMPXMBNO:
                                 PMPXMMNO,PMPXMEML,MUMCONT,PMPXMCRP,PMPXMLAB:
                                 PMPXMREL,PMPXFSNA,PMPXFGNA,PMPXFTLE,PMPXFAD1:
                                 PMPXFAD2,PMPXFAD3,PMPXFAD4,PMPXFPOS,PMPXFPNO:
                                 PMPXFBNO,PMPXFMNO,PMPXFEML,FATCONT,PMPXFCRP:
                                 PMPXFLAB,PMPXFREL:
                                 EMVIADMN,EMVISTAT,EMVIURNO,EMVIDATE,EMVITIME:
                                 EMVITRIG,EMVICOM1,EMVICOM2,EMVILOCN,ATTDOCT:
                                 EMVICOMP,EMVICLAS,EMVIINSR,SRCREFL,EMVISITN:
                                 EMVIMODE,EMVIADMT,EMVIDURN,EMVIEMPL,EMVIWAIT:
                                 EMVIPREV,AHFUNDD,AHFTABD,REFDOCT,EMVIREFD:
                                 EMVIPLIN,EMVIINIT,EMVIRTAS,EMVIDDAT,EMVIDTIM:
                                 EMVIDSTA,EMVIOPR1,EMVIOPR2,EMVIUC01,EMVIUC02:
                                 EMVIUC03,EMVIUC04,EMVIUC05,EMVIUC06,EMVIUC07:
                                 EMVIUC08,EMVIUC09,EMVIUC10,EMVIUC11,EMVIUC12:
                                 EMVIUC13,EMVIUC14,EMVIUC15,EMVIUC16,EMVIUC17:
                                 EMVIUC18,EMVIUC19,PRESCOM,EMVIUC21,EMVIUC22:
                                 EMVIUC23,EMVIUC24,EMVIUC25,EMVIUC26,EMVIUC27:
                                 EMVIUC28,EMVIUC29,EMVIUC30,EMVIUD01,EMVIUD02:
                                 EMVIUD03,EMVIUD04,EMVIUD05,EMVIUD06,EMVIUD07:
                                 EMVIUD08,EMVIUD09,EMVIUD10,EMVIUT01,EMVIUT02:
                                 EMVIUT03,EMVIUT04,EMVIUT05,EMVIUT06,EMVIUT07:
                                 EMVIUT08,EMVIUT09,EMVIUT10,EMVIYN01,EMVIYN02:
                                 EMVIYN03,EMVIYN04,EMVIYN05,EMVIYN06,EMVIYN07:
                                 EMVIYN08,EMVIYN09,EMVIYN10,EMVITXT1,EMVITXT2:
                                 EMVITXT3,EMVITXT4,EMVITXT5,EMVIUN01,EMVIUN02:
                                 EMVIUN03,EMVIUN04,EMVIUN05,EMVIELAP,EMVINSDT:
                                 EMVINSTM,EMVIDRDT,EMVIDRTM,EMVIPATT,EMVITSRC:
                                 EMVIDEST,EMVIAMBL,EMVIREGN,EMVISENT,EMVIUR01:
                                 EMVIUR02,EMVIUR03,EMVIUR04,EMVIUR05,EMVIPADM:
                                 EMVIEWRD,EMVIEBED,EMVIHFMN,ADMTYPE,EMVICCLS:
                                 EMVITRNS,EMVIDUM1,EMVITRDT,EMVITRTM,EMVIATNS:
                                 EMVIDUM2,EMVIEXLC,EMVISITE,EMVIUNIT,EMVICOM3:
                                 EMVICOM4,EMVICOM5,EMVICOM6,EMVIINJ1,EMVIINJ2:
                                 EMVINATI,EMVIINJC,EMVIHUMI,EMVIACTI,EMVILOCO:
                                 DATETIME,SP1
.
          GOTO      CECM9700 IF EOS              * e-Gate connection lost
          GOTO      CECM9500 IF OVER             * NAK returned from e-Gate
.
CECM9000  ADD       ONE,CECSENT
          DISPLAY   *P60:9,CECSENT;
          MOVE      ZERO,EXIT
          GOTO      CECM9999
.
CECM9500  ADD       ONE,CECFAIL
          DISPLAY   *P69:9,CECFAIL;
          MOVE      ONE,EXIT
          GOTO      CECM9999
.
CECM9700  MOVE      TWO,EXIT
.
CECM9999  RETURN
+
.******************************************************************************
.*                                  CCEM0000       Called by: RDIN0000        *
.*                        Write Cancel Emergency Visit                        *
.* Returns:  EXIT  0 = message sent ok                                        *
.*                 1 = message rejected                                       *
.*                 2 = e-Gate connection lost                                 *
.******************************************************************************
CCEM0000  MOVE      H7INMESI,KEY20
          CALL      RDPMQPT1                     * PMI details found ?
          BRANCH    OVRCD,CCEM9500               * no - error
.
          MOVE      H7INMESI,KEY20
          CALL      RDEMQUE1                     * Emergency details found ?
          BRANCH    OVRCD,CCEM9500               * no - error
.
.         Format PMI coded fields for HL7
.
          CALL      LDOC0000                     * format local doctor
          CALL      GREL0000                     * format religion
          CALL      GLAN0000                     * format language
          CALL      PINL0000                     * format preferred interpreter
.                                                  language
          CALL      PCON0000                     * format patient COB
          CALL      FCON0000                     * format father's COB
          CALL      MCON0000                     * format mother's COB
.
          MOVE      PFUNDH,FUNDCODE
          CALL      GFND0000                     * format health fund
          MOVE      FUNDDESC,PHFUNDD
.
          MOVE      PFUNDH,FUNDCODE
          MOVE      PFNDTB,TABLCODE
          CALL      GTBL0000                     * format fund table
          MOVE      TABLDESC,PHFTABD
.
.         Format Visit coded fields for HL7
.
          PACK      REFDCODE,EMVIDOCT,SP10
          CALL      GREF0000                     * format attending doctor
          MOVE      REFDDESC,ATTDOCT
.
          MOVE      EMVISRCE,SRCECODE
          CALL      GSRC0000                     * format source of referral
          MOVE      SRCEDESC,SRCREFL
.
          PACK      REFDCODE,EMVIREFG,SP10
          CALL      GREF0000                     * format referring doctor
          MOVE      REFDDESC,REFDOCT
.
          MOVE      EMVIACLS,ADMNCODE
          CALL      GTYP0000                     * format admission type
          MOVE      ADMNDESC,ADMTYPE
.
          MOVE      EMVIFUND,FUNDCODE
          CALL      GFND0000                     * format health fund
          MOVE      FUNDDESC,AHFUNDD
.
          MOVE      EMVIFUND,FUNDCODE
          MOVE      EMVITABL,TABLCODE
          CALL      GTBL0000                     * format fund table
          MOVE      TABLDESC,AHFTABD
.
          MOVE      EMVIUC20,PRESCODE
          CALL      GPRC0000                     * format presenting complaint
          MOVE      PRESDESC,PRESCOM
.
          CALL      GDTM0000                     * get message date/time
          CALL      MEDI0000                     * format full medicare number
          CALL      GDVA0000                     * get DVA details
.
.         Write message
.
          MOVE      "CCE",MESSTYPE
          WRITE     DGATE;MESSTYPE,PURNO,CSALIAS,SP8,PTITL,PHOSP:
                                 PLDAYS,PBDEBT,PSNAME,PGNAME,PPSNAME:
                                 PADD1,PADD2,PSUBRB,PADD4,PPOST:
                                 PTELEP,PTELEB,PSEX,PMSTAT,PBDATE:
                                 PATCONT,RELIGON,PTYPE,POCCUP,PLDDATE:
                                 FULLMEDI,PPENNO,PPNDTE,DVADIM10,PSMOK:
                                 PMICRO,PCEASE,PCASE,PAUTOPY,PHIGH1:
                                 PHIGH2,PHIGH3,PLOCDOC,PHFUNDD,PHFTABD:
                                 PFNDMM,PUSR1,PUSR2,PUSR3,PUSR4:
                                 PUSR5,PUSR6,PUYN1,PUYN2,PUYN3:
                                 PYRRES,PNKNAME,PNKADD1,PNKADD2,PNKSUBR:
                                 PNKADD4,PNKPOST,PNKTELP,PNKTELB,PNKRELP:
                                 PFNDYY,PFNDCG,PDECDTE,PDIET,PINITHOS:
                                 PHKADUNI,PTMAEMPC,PTMANOKO,PTMANOKE,PTMADCNO:
                                 PTMXRDAT,PTMXMEAL,PTMXLGA,PTMXLS,PTMXLSDT:
                                 PTMXFHMD,PTMXMHU1,PTMXMHU2,PTMXMHU3,PTMXECNM:
                                 PTMXECA1,PTMXECA2,PTMXECA3,PTMXECA4,PTMXECPC:
                                 PTMXECPP,PTMXECBP,PTMXECRE,PTMXNRNM,PTMXNRA1:
                                 PTMXNRA2,PTMXNRA3,PTMXNRA4,PTMXNRPC,PTMXNRPP:
                                 PTMXNRBP,PTMXNRRE,PTMX3BEX,PTMXCARD,PTMXCEXP:
                                 PTMXCXMP,PTMXFMLY,PTMXCHNM,PTMXDOFR,LOCDOCT:
                                 PMPXRH1G,PTMXSPID,PMPXR1GC,PTMXOSDT,PTNINMPI:
                                 NHMASURN,NHMAGIV1,NHMAGIV2,NHMAGIV3,NHMAPREI:
                                 NHMAADD1,NHMAADD2,NHMAADD3,NHMAADD4,NHMAADD5:
                                 NHMADOB,NHMADDTH,NHMADOMC,NHMARES,NHMAETH:
                                 NHMASEX,NHMADAT,NHMATIM,NHMAETH2,NHMAETH3:
                                 PTMXOPER,PTMXUKDO,PTMXCELL,PTMXADD1,PTMXADD2:
                                 PTMXADD3,PTMXADD4,PTMXPOST,PMPXINTR,PATLANG:
                                 PREFINT,PMPXLNG3,PMPXPEML,PMPXEDOB,PMPXCMOB:
                                 PMPXCEML,PMPXCCRP,PMPXKMOB,PMPXKEML,PMPXKCRP:
                                 PMPXRMOB,PMPXREML,PMPXRCRP,PMPXMEDC,PMPXDETY:
                                 PMPXPRIS,PMPXCSER,PMPXPHEI,PMPXPWEI,PMPXDREC:
                                 DVACCODE,PMPXPNSD,PMPXUYN4,PMPXUYN5,PMPXUYN6:
                                 PMPXABRG,PMPXPRVI,PMPXCRIN,PMPXHOML,PMPXUDC1:
                                 PMPXUDC2,PMPXUDC3,PMPXUSR7,PMPXUSR8,PMPXUSR9:
                                 PMPXMSNA,PMPXMGNA,PMPXMTLE,PMPXMAD1,PMPXMAD2:
                                 PMPXMAD3,PMPXMAD4,PMPXMPOS,PMPXMPNO,PMPXMBNO:
                                 PMPXMMNO,PMPXMEML,MUMCONT,PMPXMCRP,PMPXMLAB:
                                 PMPXMREL,PMPXFSNA,PMPXFGNA,PMPXFTLE,PMPXFAD1:
                                 PMPXFAD2,PMPXFAD3,PMPXFAD4,PMPXFPOS,PMPXFPNO:
                                 PMPXFBNO,PMPXFMNO,PMPXFEML,FATCONT,PMPXFCRP:
                                 PMPXFLAB,PMPXFREL:
                                 EMVIADMN,EMVISTAT,EMVIURNO,EMVIDATE,EMVITIME:
                                 EMVITRIG,EMVICOM1,EMVICOM2,EMVILOCN,ATTDOCT:
                                 EMVICOMP,EMVICLAS,EMVIINSR,SRCREFL,EMVISITN:
                                 EMVIMODE,EMVIADMT,EMVIDURN,EMVIEMPL,EMVIWAIT:
                                 EMVIPREV,AHFUNDD,AHFTABD,REFDOCT,EMVIREFD:
                                 EMVIPLIN,EMVIINIT,EMVIRTAS,EMVIDDAT,EMVIDTIM:
                                 EMVIDSTA,EMVIOPR1,EMVIOPR2,EMVIUC01,EMVIUC02:
                                 EMVIUC03,EMVIUC04,EMVIUC05,EMVIUC06,EMVIUC07:
                                 EMVIUC08,EMVIUC09,EMVIUC10,EMVIUC11,EMVIUC12:
                                 EMVIUC13,EMVIUC14,EMVIUC15,EMVIUC16,EMVIUC17:
                                 EMVIUC18,EMVIUC19,PRESCOM,EMVIUC21,EMVIUC22:
                                 EMVIUC23,EMVIUC24,EMVIUC25,EMVIUC26,EMVIUC27:
                                 EMVIUC28,EMVIUC29,EMVIUC30,EMVIUD01,EMVIUD02:
                                 EMVIUD03,EMVIUD04,EMVIUD05,EMVIUD06,EMVIUD07:
                                 EMVIUD08,EMVIUD09,EMVIUD10,EMVIUT01,EMVIUT02:
                                 EMVIUT03,EMVIUT04,EMVIUT05,EMVIUT06,EMVIUT07:
                                 EMVIUT08,EMVIUT09,EMVIUT10,EMVIYN01,EMVIYN02:
                                 EMVIYN03,EMVIYN04,EMVIYN05,EMVIYN06,EMVIYN07:
                                 EMVIYN08,EMVIYN09,EMVIYN10,EMVITXT1,EMVITXT2:
                                 EMVITXT3,EMVITXT4,EMVITXT5,EMVIUN01,EMVIUN02:
                                 EMVIUN03,EMVIUN04,EMVIUN05,EMVIELAP,EMVINSDT:
                                 EMVINSTM,EMVIDRDT,EMVIDRTM,EMVIPATT,EMVITSRC:
                                 EMVIDEST,EMVIAMBL,EMVIREGN,EMVISENT,EMVIUR01:
                                 EMVIUR02,EMVIUR03,EMVIUR04,EMVIUR05,EMVIPADM:
                                 EMVIEWRD,EMVIEBED,EMVIHFMN,ADMTYPE,EMVICCLS:
                                 EMVITRNS,EMVIDUM1,EMVITRDT,EMVITRTM,EMVIATNS:
                                 EMVIDUM2,EMVIEXLC,EMVISITE,EMVIUNIT,EMVICOM3:
                                 EMVICOM4,EMVICOM5,EMVICOM6,EMVIINJ1,EMVIINJ2:
                                 EMVINATI,EMVIINJC,EMVIHUMI,EMVIACTI,EMVILOCO:
                                 DATETIME,SP1
.
          GOTO      CCEM9700 IF EOS              * e-Gate connection lost
          GOTO      CCEM9500 IF OVER             * NAK returned from e-Gate
.
CCEM9000  ADD       ONE,CCESENT
          DISPLAY   *P60:10,CCESENT;
          MOVE      ZERO,EXIT
          GOTO      CCEM9999
.
CCEM9500  ADD       ONE,CCEFAIL
          DISPLAY   *P69:10,CCEFAIL;
          MOVE      ONE,EXIT
          GOTO      CCEM9999
.
CCEM9700  MOVE      TWO,EXIT
.
CCEM9999  RETURN
+
.******************************************************************************
.*                                  CCPM0000       Called by: RDIN0000        *
.*                       Write Change Pre-Admission Message                   *
.* Returns:  EXIT  0 = message sent ok                                        *
.*                 1 = message rejected                                       *
.*                 2 = e-Gate connection lost                                 *
.******************************************************************************
CCPM0000  MOVE      H7INMESI,KEY20
          CALL      RDPMQPT1                     * PMI details found ?
          BRANCH    OVRCD,CCPM9500               * no - error
.
          PACK      KEY22,H7INMESI,SP1,ONE
          CALL      RDPMQVI1                     * visit details found ?
          BRANCH    OVRCD,CCPM9500               * no - error
.
          MOVE      H7INMESI,KEY20
          CALL      RDWTQUE1                     * W/L details found ?
          BRANCH    OVRCD,CCPM9500               * no - error
.
.         Format PMI coded fields for HL7
.
          CALL      LDOC0000                     * format local doctor
          CALL      GREL0000                     * format religion
          CALL      GLAN0000                     * format language
          CALL      PINL0000                     * format preferred interpreter
.                                                  language
          CALL      PCON0000                     * format patient COB
          CALL      FCON0000                     * format father's COB
          CALL      MCON0000                     * format mother's COB
.
          MOVE      PFUNDH,FUNDCODE
          CALL      GFND0000                     * format health fund
          MOVE      FUNDDESC,PHFUNDD
.
          MOVE      PFUNDH,FUNDCODE
          MOVE      PFNDTB,TABLCODE
          CALL      GTBL0000                     * format fund table
          MOVE      TABLDESC,PHFTABD
.
.         Format Visit coded fields for HL7
.
          MOVE      ADOCTT,ATTDCODE
          CALL      ADOC0000                     * format attending doctor
          MOVE      ATTDDESC,ATTDOCT
.
          MOVE      TADOCT,CONSCODE
          CALL      GCON0000                     * format consultant
          MOVE      CONSDESC,CONSULT
.
          PACK      REFDCODE,PMVXRHC1,SP10
          CALL      GREF0000                     * format referring doctor
          MOVE      REFDDESC,REFDOCT
.
          MOVE      ASRCE,SRCECODE
          CALL      GSRC0000                     * format source of referral
          MOVE      SRCEDESC,SRCREFL
.
          MOVE      TDEPT,UNITCODE
          CALL      UNIT0000                     * format clinical unit
          MOVE      UNITDESC,CLIUNIT
.
          MOVE      ACLSS,ADMNCODE
          CALL      GTYP0000                     * format admission type
          MOVE      ADMNDESC,ADMTYPE
.
          MOVE      TATYPE,CLASCODE
          CALL      CLAS0000                     * format admission class
          MOVE      CLASDESC,ADMCLSS
.
          MOVE      TWARD,WARDCODE
          CALL      GWRD0000                     * format patient location
          MOVE      WARDDESC,PATWLOC
.
          MOVE      AFUNDH,FUNDCODE
          CALL      GFND0000                     * format health fund
          MOVE      FUNDDESC,AHFUNDD
.
          MOVE      AFUNDH,FUNDCODE
          MOVE      AFNDTB,TABLCODE
          CALL      GTBL0000                     * format fund table
          MOVE      TABLDESC,AHFTABD
.
          CALL      GDTM0000                     * get message date/time
          CALL      MEDI0000                     * format full medicare number
          CALL      GDVA0000                     * get DVA details
.
.         Write message
.
          MOVE      "CCP",MESSTYPE
          WRITE     DGATE;MESSTYPE,PURNO,CSALIAS,SP8,PTITL,PHOSP,PLDAYS:
                          PBDEBT,PSNAME,PGNAME,PPSNAME,PADD1,PADD2,PSUBRB,PADD4:
                          PPOST,PTELEP,PTELEB,PSEX,PMSTAT:
                          PBDATE,PATCONT,RELIGON:
                          PTYPE,POCCUP,PLDDATE,FULLMEDI,PPENNO,PPNDTE,DVADIM10:
                          PSMOK:
                          PMICRO,PCEASE,PCASE,PAUTOPY,PHIGH1,PHIGH2,PHIGH3:
                          PLOCDOC,PHFUNDD,PHFTABD,PFNDMM,PUSR1,PUSR2,PUSR3:
                          PUSR4,PUSR5,PUSR6,PUYN1,PUYN2,PUYN3,PYRRES:
                          PNKNAME,PNKADD1,PNKADD2,PNKSUBR,PNKADD4,PNKPOST:
                          PNKTELP,PNKTELB,PNKRELP,PFNDYY,PFNDCG,PDECDTE:
                          PDIET,PINITHOS,PHKADUNI,PTMAEMPC,PTMANOKO:
                          PTMANOKE,PTMADCNO,PTMXRDAT,PTMXMEAL,PTMXLGA:
                          PTMXLS,PTMXLSDT,PTMXFHMD,PTMXMHU1,PTMXMHU2:
                          PTMXMHU3,PTMXECNM,PTMXECA1,PTMXECA2,PTMXECA3:
                          PTMXECA4,PTMXECPC,PTMXECPP,PTMXECBP,PTMXECRE:
                          PTMXNRNM,PTMXNRA1,PTMXNRA2,PTMXNRA3,PTMXNRA4:
                          PTMXNRPC,PTMXNRPP,PTMXNRBP,PTMXNRRE,PTMX3BEX:
                          PTMXCARD,PTMXCEXP,PTMXCXMP,PTMXFMLY,PTMXCHNM:
                          PTMXDOFR,LOCDOCT,PMPXRH1G,PTMXSPID,PMPXR1GC:
                          PTMXOSDT,PTNINMPI:
                          NHMASURN,NHMAGIV1,NHMAGIV2,NHMAGIV3,NHMAPREI:
                          NHMAADD1,NHMAADD2,NHMAADD3,NHMAADD4,NHMAADD5:
                          NHMADOB,NHMADDTH,NHMADOMC,NHMARES,NHMAETH:
                          NHMASEX,NHMADAT,NHMATIM,NHMAETH2,NHMAETH3:
                          PTMXOPER,PTMXUKDO,PTMXCELL,PTMXADD1,PTMXADD2:
                          PTMXADD3,PTMXADD4,PTMXPOST:
                          AADMNO,ADATE,ATIME,AINVPRT:
                          ALACDTE,ACANCEL,ADOCTR,ADOCTL,SRCREFL,ADMTYPE:
                          ACARE,AHFUNDD,AHFTABD,AFNDMM,AELIG:
                          AVISIT,AALERG,AILLN,ADIAG1,ADIAG2:
                          ADISC,ATTDOCT,AALLOW,AMBS,ACLAIM,ADIET:
                          APLOCCR,ASTAY,ADYHOSP,AMEMB,AMEMBNO,ACOMM1:
                          ACOMM2,APLUR,APURGE,AUSR1,AUSR2,AUSR3,AUSR4:
                          AUSR5,AUSR6,AUSR7,ADSCHI,ARDRNAM,AFNDYY:
                          AFNDCG,AOCCDTE,ACODDTE,ARETDTE,AMUMADM:
                          PTMIPVIS,ABWGHT,REFDOCT,PMVXRH1G,PTMSFHAN:
                          PTMSECRA,PTMSMGIN,PTMIDDIG,PMVXRH1C,PTMIDOFR:
                          PTMIREFD,PTMIDFCN,PTMIPHPU,PTMIAGNC,PTMIESSF:
                          PTMIUSR8,PTMIUSR9,PTMIUSR0,PTMIPDRG,PTMIOPER:
                          PTMIXWRD,PTMIADOC,PTMIREGS,PTMIUYN1,PTMIUYN2:
                          PATWLOC,TBED,TRATEF,TRATEG,TDISC,TALLW,ADMCLSS:
                          CONSULT,TRATEH,TEXTRA,TRBTYP,TRBEND:
                          CLIUNIT,PTTRLTYP,PTTREPNO,DSNAME,DGNAME:
                          PMPXINTR,PATLANG,PREFINT,PMPXLNG3,PMPXPEML:
                          PMPXEDOB,PMPXCMOB,PMPXCEML,PMPXCCRP,PMPXKMOB:
                          PMPXKEML,PMPXKCRP,PMPXRMOB,PMPXREML,PMPXRCRP:
                          PMPXMEDC,PMPXDETY,PMPXPRIS,PMPXCSER,PMPXPHEI:
                          PMPXPWEI,PMPXDREC,DVACCODE,PMPXPNSD,PMPXUYN4:
                          PMPXUYN5,PMPXUYN6,PMPXABRG,PMPXPRVI,PMPXCRIN:
                          PMPXHOML,PMPXUDC1,PMPXUDC2,PMPXUDC3,PMPXUSR7:
                          PMPXUSR8,PMPXUSR9,PMPXMSNA,PMPXMGNA,PMPXMTLE:
                          PMPXMAD1,PMPXMAD2,PMPXMAD3,PMPXMAD4,PMPXMPOS:
                          PMPXMPNO,PMPXMBNO,PMPXMMNO,PMPXMEML,MUMCONT:
                          PMPXMCRP,PMPXMLAB,PMPXMREL,PMPXFSNA,PMPXFGNA:
                          PMPXFTLE,PMPXFAD1,PMPXFAD2,PMPXFAD3,PMPXFAD4:
                          PMPXFPOS,PMPXFPNO,PMPXFBNO,PMPXFMNO,PMPXFEML:
                          FATCONT,PMPXFCRP,PMPXFLAB,PMPXFREL:
                          PMVXVLOC,PMVXCFSG,PMVXINGP,PMVXCPTH,PMVXHCP1:
                          PMVXHCP2,PMVXHCP3,PMVXHCP4,PMVXRHC1,PMVXRHC2:
                          PMVXRHC3,PMVXRHC4,PMVXCADM,PMVXIRAD,PMVXIDUS:
                          PMVXCRAV,PMVXRCCT,PMVXAPWD,PMVXAPBD,PMVXPOWD:
                          PMVXPOBD,PMVXPSTY,PMVXVALW,PMVXPALW,PMVXINDC:
                          PMVXMDAV,PMVXFRMS,PMVXEDC1,PMVXEDC2,PMVXEDC3:
                          PMVXUDF1,PMVXUDF2,PMVXUDF3,PMVXUDF4,PMVXUDT1:
                          PMVXUDT2,PMVXUDT3,PMVXUDT4,PMVXUDT5,PMVXUDT6:
                          DATETIME,WMCODE,WMCNT,WMTIME,WMDESC,WMREASON:
                          PKNAME,PKADD1,PKADD2,PKSUBR,PKADD4,PKPOST,PKTELEP:
                          PKTELEB,PKRELP,SP1
.
          GOTO      CCPM9700 IF EOS              * e-Gate connection lost
          GOTO      CCPM9500 IF OVER             * NAK returned from e-Gate
.
CCPM9000  ADD       ONE,CCPSENT
          DISPLAY   *P8:17,CCPSENT;
          MOVE      ZERO,EXIT
          GOTO      CCPM9999
.
CCPM9500  ADD       ONE,CCPFAIL
          DISPLAY   *P18:17,CCPFAIL;
          MOVE      ONE,EXIT
          GOTO      CCPM9999
.
CCPM9700  MOVE      TWO,EXIT
.
CCPM9999  RETURN
+
.******************************************************************************
.*                                  CHAM0000       Called by: RDIN0000        *
.*                       Write Add Health Conc. Card Message                  *
.* Returns:  EXIT  0 = message sent ok                                        *
.*                 1 = message rejected                                       *
.*                 2 = e-Gate connection lost                                 *
.******************************************************************************
CHAM0000  MOVE      H7INMESI,KEY20
          CALL      RDPMQCC1                     * HCC details found ?
          BRANCH    OVRCD,CHAM9500               * no - error
.
          CALL      CTYP0000                     * get card type description
.
          CALL      GDTM0000                     * get message date/time
.
.         Write message
.
          MOVE      "CHA",MESSTYPE
          WRITE     DGATE;MESSTYPE,PMCDURNO,CARDTYPE,PMCDCNUM,PMCDEXDT:
                          DATETIME,SP1
     
          GOTO      CHAM9700 IF EOS              * e-Gate connection lost
          GOTO      CHAM9500 IF OVER             * NAK returned from e-Gate
.
CHAM9000  ADD       ONE,CHASENT
          DISPLAY   *P8:11,CHASENT;
          MOVE      ZERO,EXIT
          GOTO      CHAM9999
.
CHAM9500  ADD       ONE,CHAFAIL
          DISPLAY   *P18:11,CHAFAIL;
          MOVE      ONE,EXIT
          GOTO      CHAM9999
.
CHAM9700  MOVE      TWO,EXIT
.
CHAM9999  RETURN
.******************************************************************************
.*                                  CHDM0000       Called by: RDIN0000        *
.*                       Write Delete Health Conc. Card Message               *
.* Returns:  EXIT  0 = message sent ok                                        *
.*                 1 = message rejected                                       *
.*                 2 = e-Gate connection lost                                 *
.******************************************************************************
CHDM0000  MOVE      H7INMESI,KEY20
          CALL      RDPMQCC1                     * HCC details found ?
          BRANCH    OVRCD,CHDM9500               * no - error
.
          CALL      CTYP0000                     * get card type description
.
          CALL      GDTM0000                     * get message date/time
.
.         Write message
.
          MOVE      "CHD",MESSTYPE
          WRITE     DGATE;MESSTYPE,PMCDURNO,CARDTYPE,PMCDCNUM,PMCDEXDT:
                          DATETIME,SP1
     
          GOTO      CHDM9700 IF EOS              * e-Gate connection lost
          GOTO      CHDM9500 IF OVER             * NAK returned from e-Gate
.
CHDM9000  ADD       ONE,CHDSENT
          DISPLAY   *P8:12,CHDSENT;
          MOVE      ZERO,EXIT
          GOTO      CHDM9999
.
CHDM9500  ADD       ONE,CHDFAIL
          DISPLAY   *P18:12,CHDFAIL;
          MOVE      ONE,EXIT
          GOTO      CHDM9999
.
CHDM9700  MOVE      TWO,EXIT
.
CHDM9999  RETURN
.*****************************************************************************
.*                              GDTM0000           Called by: lots           *
.*        Get the datetime the message is being sent                         *
.*****************************************************************************
.
GDTM0000  CALL      IBACLOCK
          UNPACK    CTIMEIS,HOURTM,ANS,MINTIME,ANS,SECTIME
          PACK      DATETIME,CCC,CYY,CMM,CDD,HOURTM,MINTIME,SECTIME
          REP       " 0",DATETIME
.
GDTM9999  RETURN
+
.*****************************************************************************
.*                          LDOC0000               Called by:                *
.*        Get local doctor                                                   *
.*****************************************************************************
.
LDOC0000  PACK      LOCDOCT,SP70,SP70
          MATCH     SP8,PMPXRHC1
          IF        !@EQUAL
            PACK      KEY10,PMPXRHC1,SP70
            CALL      RDPMHCP1
            IF        OVRCD<>1
              STRIP     PMHCSNAM
              STRIP     PMHCGNAM
              STRIP     PMHCTITL
              PACK      LOCDOCT,PMPXRHC1,CARET,PMHCSNAM,CARET,PMHCGNAM:
                                CARET,CARET,CARET,PMHCTITL
            ENDIF
          ENDIF
.
LDOC9999  RETURN
+
.*****************************************************************************
.*                           GREL0000              Called by:                *
.*        Get religion                                                       *
.*****************************************************************************
.
GREL0000  PACK      RELIGON,SP70
          MATCH     SP3,PREG
          IF        !@EQUAL
            PACK      KEY5,ANSR,SP1,PREG,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              STRIP     TDESC
              PACK      RELIGON,PREG,CARET,TDESC
            ENDIF
          ENDIF
.
GREL9999  RETURN
+
.*****************************************************************************
.*                           GLAN0000              Called by:                *
.*        Get patient language                                               *
.*****************************************************************************
.
GLAN0000  PACK      PATLANG,SP70
          MATCH     SP3,PMPXLNG1
          IF        !@EQUAL
            PACK      KEY5,ANSL,ANSA,PMPXLNG1,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              STRIP     TDESC
              PACK      PATLANG,PMPXLNG1,CARET,TDESC
            ENDIF
          ENDIF
.
GLAN9999  RETURN
+
.*****************************************************************************
.*                          PINL0000               Called by:                *
.*        Get preferred interpreter language                                 *
.*****************************************************************************
.
PINL0000  PACK      PREFINT,SP70
          MATCH     SP3,PMPXLNG2
          IF        !@EQUAL
            PACK      KEY5,ANSL,ANSA,PMPXLNG2,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              STRIP     TDESC
              PACK      PREFINT,PMPXLNG2,CARET,TDESC
            ENDIF
          ENDIF
.
PINL9999  RETURN
+
.*****************************************************************************
.*                          PCON0000               Called by:                *
.*        Get patient country of birth                                       *
.*****************************************************************************
.
PCON0000  PACK      PATCONT,SP70
          MATCH     SP3,PCONT
          IF        !@EQUAL
            PACK      KEY5,ANSC,SP1,PCONT,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              STRIP     TDESC
              PACK      PATCONT,PCONT,CARET,TDESC
            ENDIF
          ENDIF
.
PCON9999  RETURN
+
.*****************************************************************************
.*                          FCON0000               Called by:                *
.*        Get father's country of birth                                      *
.*****************************************************************************
.
FCON0000  PACK      FATCONT,SP70
          MATCH     SP3,PMPXFCNT
          IF        !@EQUAL
            PACK      KEY5,ANSC,SP1,PMPXFCNT,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              STRIP     TDESC
              PACK      FATCONT,PMPXFCNT,CARET,TDESC
            ENDIF
          ENDIF
.
FCON9999  RETURN
+
.*****************************************************************************
.*                          MCON0000               Called by:                *
.*        Get mother's country of birth                                      *
.*****************************************************************************
.
MCON0000  PACK      MUMCONT,SP70
          MATCH     SP3,PMPXMCNT
          IF        !@EQUAL
            PACK      KEY5,ANSC,SP1,PMPXMCNT,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              STRIP     TDESC
              PACK      MUMCONT,PMPXMCNT,CARET,TDESC
            ENDIF
          ENDIF
.
MCON9999  RETURN
+
.*****************************************************************************
.*                          CTYP0000               Called by:                *
.*        Get health concession card type description                        *
.*****************************************************************************
.
CTYP0000  PACK      CARDTYPE,SP70
          MATCH     SP3,PMCDCTYP
          IF        !@EQUAL
            PACK      KEY5,CATct,PMCDCTYP,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              STRIP     TDESC
              PACK      CARDTYPE,PMCDCTYP,CARET,TDESC
            ENDIF
          ENDIF
.
CTYP9999  RETURN
+
.*****************************************************************************
.*                          GFND0000               Called by:                *
.*        Get Health Fund description                                        *
.* Requires: FUNDCODE - Health Fund Code                                     *
.* Returns:  FUNDDESC - Formatted Health Fund                                *
.*****************************************************************************
.
GFND0000  PACK      FUNDDESC,SP70
          MATCH     SP6,FUNDCODE
          IF        !@EQUAL
            PACK      KEY14,FUNDCODE,ZERO4,SP70
            CALL      RDFUND1
            IF        OVRCD<>1
              STRIP     HFNAME
              PACK      FUNDDESC,FUNDCODE,CARET,HFNAME
            ENDIF
          ENDIF
.
GFND9999  RETURN
+
.*****************************************************************************
.*                          GTBL0000               Called by:                *
.*        Get Health Fund Table description                                  *
.* Requires: FUNDCODE - Health Fund Code                                     *
.*           TABLCODE - Health Fund Table Code                               *
.* Returns:  TABLDESC - Formatted Health Fund Table                          *
.*****************************************************************************
.
GTBL0000  PACK      TABLDESC,SP70
          MATCH     SP8,PFNDTB
          IF        !@EQUAL
            PACK      KEY14,FUNDCODE,TABLCODE,SP70
            CALL      RDFUND1
            IF        OVRCD<>1
              STRIP     HFNAME
              PACK      TABLDESC,TABLCODE,CARET,HFNAME
            ENDIF
          ENDIF
.
GTBL9999  RETURN
+
.*****************************************************************************
.*                           ADOC0000              Called by:                *
.*        Get attending doctor                                               *
.* Requires:  ATTDCODE - Attending Doctor Code                               *
.* Returns:   ATTDDESC - Formatted Description                               *
.*****************************************************************************
.
ADOC0000  PACK      ATTDDESC,SP70
          MATCH     SP6,ATTDCODE
          IF        !@EQUAL
            MOVE      ATTDCODE,KEY6
            CALL      RDDOCT1
            IF        OVRCD<>1
              STRIP     DGNAME
              STRIP     DSNAME
              STRIP     DTITL
              PACK      ATTDDESC,ATTDCODE,CARET,DSNAME,CARET,DGNAME:
                                CARET,CARET,CARET,DTITL
            ENDIF
          ENDIF
.
ADOC9999  RETURN
+
.*****************************************************************************
.*                          GCON0000               Called by:                *
.*        Get consultant                                                     *
.*        NB.  This needs to be the last code to get doctor details so       *
.*             that the existing DSNAME & DGNAME variables still get set     *
.*             according to the original message specifications              *
.* Requires : CONSCODE - Consultant Code                                     *
.* Returns:   CONSDESC - Formatted Consultant                                *
.*****************************************************************************
.
GCON0000  MOVE      SP20,DGNAME
          MOVE      SP30,DSNAME
          MOVE      SP9,DTITL
          PACK      CONSDESC,SP70
          MATCH     SP6,CONSCODE
          IF        !@EQUAL
            MOVE      CONSCODE,KEY6
            CALL      RDDOCT1
            IF        OVRCD<>1
              STRIP     DGNAME
              STRIP     DSNAME
              PACK      CONSDESC,CONSCODE,CARET,DSNAME,CARET,DGNAME:
                                 CARET,CARET,CARET,DTITL
              PACK      DGNAME,DGNAME,SP20
              PACK      DSNAME,DSNAME,SP30
            ENDIF
          ENDIF
.
GCON9999  RETURN
+
.*****************************************************************************
.*                           GREF0000              Called by:                *
.*        Get referring doctor                                               *
.* Requires:  REFDCODE - Referring Doctor Code                               *
.*            REFDDESC - Formatted Description                               *
.*****************************************************************************
.         
GREF0000  PACK      REFDDESC,SP70,SP70
          MATCH     SP10,REFDCODE
          IF        !@EQUAL
            PACK      KEY10,REFDCODE,SP70
            CALL      RDPMHCP1
            IF        OVRCD<>1
              STRIP     PMHCSNAM
              STRIP     PMHCGNAM
              STRIP     PMHCTITL
              PACK      REFDDESC,REFDCODE,CARET,PMHCSNAM,CARET,PMHCGNAM:
                                CARET,CARET,CARET,PMHCTITL
            ENDIF
          ENDIF
.
GREF9999  RETURN
+
.*****************************************************************************
.*                        GSRC0000                 Called by:                *
.*        Get source of referral                                             *
.*****************************************************************************
.
GSRC0000  PACK      SRCEDESC,SP70
          MATCH     SP3,SRCECODE
          GOTO      GSRC9999 IF EQUAL
.
          PACK      CATEGORY,ANSS,SP1            * load default category "S"
.
          MATCH     "CON",H7INMETP
          IF        @EQUAL
            MOVE      OSTCATG,CATEGORY           * load O/P category
          ENDIF
.
          MATCH     "COA",H7INMETP
          IF        @EQUAL
            MOVE      OSTCATG,CATEGORY           * load O/P category
          ENDIF
.
          PACK      KEY5,CATEGORY,SRCECODE,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            STRIP     TDESC
            PACK      SRCEDESC,SRCECODE,CARET,TDESC
          ENDIF
.
GSRC9999  RETURN
+
.*****************************************************************************
.*                       UNIT0000                  Called by:                *
.*        Get clinical unit                                                  *
.* Requires:  UNITCODE - Clinical Unit Code                                  *
.* Returns:   UNITDESC - Formatted Description                               *
.*****************************************************************************
.
UNIT0000  PACK      UNITDESC,SP70
          MATCH     SP3,UNITCODE
          IF        !@EQUAL
            PACK      KEY5,ANSA,ANSC,UNITCODE,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              STRIP     TDESC
              PACK      UNITDESC,UNITCODE,CARET,TDESC
            ENDIF
          ENDIF
.
UNIT9999  RETURN
+
.*****************************************************************************
.*                       GTYP0000                  Called by:                *
.*        Get admission type                                                 *
.*****************************************************************************
.
GTYP0000  PACK      ADMNDESC,SP70
          MATCH     SP3,ADMNCODE
          IF        !@EQUAL
            PACK      KEY5,ANSP,SP1,ADMNCODE,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              STRIP     TDESC
              PACK      ADMNDESC,ADMNCODE,CARET,TDESC
            ENDIF
          ENDIF
.
GTYP9999  RETURN
+
.*****************************************************************************
.*                       CLAS0000                  Called by:                *
.*        Get admission class                                                *
.* Requires:  CLASCODE - admission class code                                *
.*            CLASDESC - Formatted Description                               *
.*****************************************************************************
.
CLAS0000  PACK      CLASDESC,SP70
          MATCH     SP3,CLASCODE
          IF        !@EQUAL
            PACK      KEY5,ANSA,SP1,CLASCODE,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              STRIP     TDESC
              PACK      CLASDESC,CLASCODE,CARET,TDESC
            ENDIF
          ENDIF
.
CLAS9999  RETURN
+
.*****************************************************************************
.*                         GWRD0000                Called by:                *
.*        Get patient ward location                                          *
.* Requires:  WARDCODE - Ward code                                           *
.* Returns:   WARDDESC - Formatted description                               *
.*****************************************************************************
.
GWRD0000  PACK      WARDDESC,SP70
          MATCH     SP3,WARDCODE
          IF        !@EQUAL
            PACK      KEY6,WARDCODE,SP3,SP70
            CALL      RDWARD1
            IF        OVRCD<>1
              STRIP     WBDESC
              PACK      WARDDESC,WARDCODE,CARET,CARET,TBED:
                                CARET,CARET,CARET,CARET,CARET,CARET,WBDESC
            ENDIF
          ENDIF
.
GWRD9999  RETURN
+
.*****************************************************************************
.*                           GSIT0000              Called by:                *
.*        Get Outpatient Site Code Description                               *
.* Requires: SITECODE - O/P site code                                        *
.* Returns:  SITEDESC - Formatted Description                                *
.*****************************************************************************
.
GSIT0000  PACK      SITEDESC,SP70
          MATCH     SP6,SITECODE
          IF        !@EQUAL
            PACK      KEY6,SITECODE,SP70
            CALL      RDSITA1
            IF        OVRCD<>1
              STRIP     OSTDESC
              PACK      SITEDESC,SITECODE,CARET,OSTDESC
            ENDIF
          ENDIF
.
GSIT9999  RETURN
+
.*****************************************************************************
.*                          CLIN0000               Called by:                *
.*        Get Outpatient Clinic Code Description                             *
.* Requires:  CLINSITE - O/P site code                                       *
.*            CLINCODE - O/P Clinic Id Code                                  *
.*            CLINDATE - O/P booking date                                    *
.*            CLINDESC - Formatted Description                               *
.*****************************************************************************
.
CLIN0000  PACK      KEY8,OSTFILE,FILCLIA1
          OPEN      OUTCLIA1,KEY8
.
          PACK      CLINDESC,SP70
.
          MATCH     SP6,CLINCODE 
          IF        !@EQUAL
            PACK      KEY20,CLINSITE,CLINCODE,CLINDATE,SP70
            CALL      RDCLIA1
            IF        OVRCD<>1
              CALL      CDSC0000                 * get description
            ELSE
              PACK    KEY20,CLINSITE,CLINCODE,CLINDATE,Z70
              CALL    RDSCLIA1
              CALL    RDPCLIA1
              IF      OVRCD<>1
                MATCH   CLINSITE,OCASITE
                IF      @EQUAL
                  MATCH   CLINCODE,OCACLIN
                  IF      @EQUAL
                    CALL    CDSC0000             * get clinic description
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          CLOSE     OUTCLIA1
CLIN9999  RETURN
+
.******************************************************************************
.*                             CDSC0000            Called by: CLIN0000        *
.*           Get the description for the current clinic id record             *
.* Requires:  OTCNDGCL - Parameter for clinic id in O/P messages              *
.******************************************************************************
.
CDSC0000  MATCH     SP6,OCADOCT         * Do we have a doctors code ?
          GOTO      CDSC9000 IF EQUAL   * No. Use the description provided.
.
          MOVE      OCADOCT,KEY6        * Set up key for doctors file
          CALL      RDDOCT1             * Read the doctors code
          BRANCH    OVRCD,CDSC9000      * No doctors record found. Blank desc.
.
.         Pack up the doctors name
.
          STRIP     DGNAME
          STRIP     DSNAME
          STRIP     DTITL
          IF        OTCNDGCL = 1
            PACK      CLINDESC,OCACLIN,CARET,DSNAME,CARET,DGNAME:
                               CARET,CARET,CARET,DTITL
          ELSE
            PACK      CLINDESC,OCADOCT,CARET,DSNAME,CARET,DGNAME:
                               CARET,CARET,CARET,DTITL
          ENDIF
          GOTO      CDSC9999
.
CDSC9000  STRIP     OCADESC
          PACK      CLINDESC,OCACLIN,CARET,OCADESC
.
CDSC9999  RETURN
+
.*****************************************************************************
.*                       GPRC0000                  Called by:                *
.*        Get presenting complaint                                           *
.*****************************************************************************
.
GPRC0000  PACK      PRESDESC,SP70
          MATCH     SP3,PRESCODE
          IF        !@EQUAL
            PACK      KEY5,CATel,PRESCODE,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              STRIP     TDESC
              PACK      PRESDESC,PRESCODE,CARET,TDESC
            ENDIF
          ENDIF
.
GPRC9999  RETURN
+
.*****************************************************************************
.*                       GCTD0000                                            *
.*             Get clinic type description                                   *
.*****************************************************************************
GCTD0000  PACK      KEY8,OSTFILE,FILCTYA1
          OPEN      OUTCTYA1,KEY8
.
          PACK      CTYPDESC,SP70
          MATCH     SP6,CTYPTYPE
          IF        !@EQUAL
            PACK      KEY12,CTYPSITE,CTYPTYPE,SP70
            CALL      RDCTYA1
            IF        OVRCD<>1
              STRIP     OCTCTYP
              STRIP     OCTDESC
              PACK      CTYPDESC,OCTCTYP,CARET,OCTDESC
            ENDIF
          ENDIF
GCTD9999  RETURN
+
.*****************************************************************************
.*                       GCID0000                                            *
.*             Get clinic indicator description                              *
.* Requires: OTBBCIND - Clinic Indicator                                     *
.* Returns:  CINDDESC - <code>^<description>                                 *
.*****************************************************************************
.
GCID0000  PACK      CINDDESC,SP70
          MATCH     SP3,OTBBCIND
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSI,OTBBCIND,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              STRIP     ACODE
              STRIP     TDESC
              PACK      CINDDESC,ACODE,CARET,TDESC
            ENDIF
          ENDIF
GCID9999  RETURN
+
.*****************************************************************************
.*                       GLTD0000                                            *
.*             Get clinic type description                                   *
.*****************************************************************************
GLTD0000  PACK      LTYPDESC,SP70
          MATCH     SP3,LOCNTYPE
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANST,LOCNTYPE,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              STRIP     ACODE
              STRIP     TDESC
              PACK      LTYPDESC,ACODE,CARET,TDESC
            ENDIF
          ENDIF
GLTD9999  RETURN
+
.*****************************************************************************
.*                         CONN0000                Called by:                *
.*                     Connect to e-Gate                                     *
.* Returns:  EXIT  0 = connected ok                                          *
.*                 1 = cannot connect                                        *
.*****************************************************************************
.
.         Open the data gate broadcast file
.
CONN0000  MOVE      ZERO,OVRCD              * assume open succeeds
          STRIP     PTCNDGPB
          TRAP      OVERCOND IF IO          * trap if open fails
          OPEN      DGATE,PTCNDGPB
          TRAPCLR   IO
          COMPARE   ONE,OVRCD
          GOTO      CONN9000 IF NOT EQUAL
.
          UNPACK    PRGID,KEY3,KEY3
          MATCH     "WEB",KEY3
          IF        @EQUAL
            CLEAR     KEY99
            APPEND    "Service [",KEY99
            APPEND    PTCNDGPB,KEY99
            APPEND    "] not currently available. ",KEY99
            RESET     KEY99
          ELSE
            DISPLAY   *P1:24,*EL,*B,"Service [",*+,PTCNDGPB:
                      "] not currently available.  ",*W2;
          ENDIF
          MOVE      ONE,EXIT
          GOTO      CONN9999
.
CONN9000  MOVE      ZERO,EXIT
.
CONN9999  RETURN
+
.*****************************************************************************
.*                             MEDI0000            Called by:                *
.*        Format the full medicare number (reference number included)        *
.*****************************************************************************
.
MEDI0000  PACK      FULLMEDI,PMEDI,PTMXMCCD
          SQUEEZE   FULLMEDI
.
MEDI9999  RETURN
+
.*****************************************************************************
.*                              GDVA0000           Called by: WRPID000       *
.*     Get the DVA concession card details for the patient.                  *
.* Requires: PURNO - U/R number                                              *
.* Returns:  DVADIM10 = DVA number for concession card file                  *
.*           DVACCODE = DVA card colour for concession card file             *
.*****************************************************************************
.
GDVA0000  MOVE      SP10,DVADIM10                * initialise DVA fields
          MOVE      SP3,DVACCODE
.
          PACK      KEY19,PURNO,TILDA20
          CALL      RSPMCCD1                     * position on U/R
GDVA0500  CALL      RPPMCCD1                     * read previous record
          BRANCH    OVRCD,GDVA9999               * eof - nothing found
.
          MATCH     PURNO,PMCDURNO               * same U/R still ?
          GOTO      GDVA9999 IF NOT EQUAL        * no - nothing found
.
.         Check if the card type is DVA (Cat ct, Indicator 1=3)
.
          PACK      KEY5,CATct,PMCDCTYP
          CALL      RDCODE1                      * code on file ?
          BRANCH    OVRCD,GDVA0500               * no - ignore record
.
          MATCH     SP1,TCINDC1                  * blank indicator 1 ?
          GOTO      GDVA0500 IF EQUAL            * yes - ignore record
.
          TYPE      TCINDC1                      * numeric indicator 1 ?
          GOTO      GDVA0500 IF NOT EQUAL        * no - ignore record
.
          MATCH     "3",TCINDC1                  * DVA card ?
          GOTO      GDVA0500 IF NOT EQUAL        * no - ignore record
.
.         A concession card of the same type has been found, so check
.         if there is an expiry date
.
          MATCH     SP8,PMCDEXDT                 * expiry date blank ?
          GOTO      GDVA1000 IF EQUAL            * yes - assume valid
.
.         There is an expiry date for the card, so check that the
.         card is current
.
          MOVE      DATETIME,DIM8
          MATCH     DIM8,PMCDEXDT                * card valid for date ?
          GOTO      GDVA9999 IF LESS             * no
.
.         Concession card is current
.
GDVA1000  MATCH     SP20,PMCDCNUM                * card number blank ?
          GOTO      GDVA9999 IF EQUAL            * yes - nothing found
.
          MOVE      PMCDCNUM,DVADIM10            * load concession card number
          MOVE      PMCDDVAC,DVACCODE            * load dva card colour
.
GDVA9999  RETURN
+
.*****************************************************************************
.*                                                 Called by:                *
.*        I/O Includes                                                       *
.*****************************************************************************
.
          INC       STD002IO
.
          INC       CLALLAEF
          INC       CLALLERC
          INC       CLPMSQPX
.
          INC       ALLAEFIO/INC
          INC       ALLERCIO/INC
          INC       ALLQUEIO/INC                                       *I-90203
          INC       BOKQUEIO/INC
          INC       EMRQUEIO/INC
          INC       EMRVISIO/INC
          INC       HL7INBIO/INC
          INC       MRTQUEIO/INC                                       *I-90203
          INC       OUTCLIIO/INC
          INC       OUTCTYIO/INC
          INC       OUTMA1IO/INC
          INC       OUTSITIO/INC
          INC       OUTQUEIO/INC
          INC       PATCODIO/INC
          INC       PATDO1IO/INC
          INC       PATFN1IO/INC
          INC       PATWR1IO/INC
          INC       PMSCCDIO/INC
          INC       PMSHCPIO/INC
          INC       PMSQCCIO/INC
          INC       PMSQPTIO/INC
          INC       PMSQVIIO/INC
          INC       WATQUEIO/INC
+
