.-------------------------------------------------------------------------------
. Program       : PRIWEB04 
.
. Function      : Private Practice Enquiry
.
. Modifications : 
.
.------------------------------------------------------------------------------
. V12.00.04 22/09/2025  J.Tan            TSK 0966921
.           Mod to remove tempfiles
. V12.00.03 27/08/2025  Alina Bhari      TSK 0954453
.           Recompiled for PRIINVHL - Added Patient Name
. V12.00.02 24/07/2025  J.Tan          TSK 0962500
.           Mod Cash routines to check for U/R number
. V12.00.01 26/05/2025  J.Tan          TSK 0955096
.           Added Alphanumeric visit number changes
. V11.05.03 04/02/2025  Peter Vela       TSK 0939466
.           Recompiled for PRIINVPR - Added Distance In kms
.           Eclipse WebServices DVAW
.           14/02/2025 J.Tan           TSK 0946490
.           Recompiled for PATCATBI - changes for MV CWO
. V11.05.02 09.12.2024 DA Sarkies      TSK 0951086
.           Increased size of CALDAYS from 3 to 4
. V11.05.01 27/11/2024 Thanh T         TSK 0939466
.           Recompiled for PMSMTIFD and PRIHTRFD changes
. V11.04.05 07/11/2024 Thanh T           TSK 0946085
.           Recompiled for RCPCONFD changes
. V11.04.04 09/07/2024  J.Tan            TSK 0934944
.           Mod to check Referral Provider no from a linked Practice
. V11.04.03 12/04/2024  J.Tan         TSK 0941662
.           Mod PRDTGSTM - GST of Total amt(Item amt x Quantity)
. V11.04.02 29/01/2024  Jacob Jackson  TSK 0919335
.           Add HF History includes
. V11.04.01 29/01/2024  Jacob Jackson  TSK 0919335
.           Add new local variable and recompile for GETTFEES
. V11.03.04 08/11/2023  Nikitha B      TSK 0927699c
.           Read CAPPRVNO and PTCNHABN for Hospital Approval and ABN number.
. V11.03.03 04/10/2023  Nikitha B     TSK 0927699
.           Recomplied for PRIINVHL, PRIINVTL - Stationary variables
. V11.03.02 05/05/2023  J.Tan          TSK 0847250
.           Fixed total payment for Unreconciled outstanding amount
. V11.03.01 20/03/2023 J.Tan          TSK 0847250
.           Mod for Receipt Processing, Unreconciled invoice(PRIUPURE)
. V11.02.02 16/03/2022  J.Tan           TSK 0902652
.           Changed second index of pathtraf 
. V11.02.01 10/02/2022  Thanh T       TSK 0905641
.           Recompiled as OUTMA1FD (PATMASTM) changes
. V11.01.11 17/11/2021  J.Tan          TSK 0913621
.           Recompiled for ABFPTINV - Mod for Multiple NEP Values
. V11.01.10 29/09/2021  J.Tan          TSK 0901515
.           Recompiled for CMXMATRX - Added Primary Proc.to Matrix
. V11.01.09 14/09/2021  J.Tan          TSK 0906222
.           Recompiled for ABFPTINV - Mod for Multiple NEP Values
. V11.01.08 24/08/2021   Davin          TSK 0897318
.           Recompiled for PRIINVTL - added field 51 (Adjustment Total)
. V11.01.07 20/07/2021   J.Tan          TSK 0908902
.           Recompiled for PRIINVPR - printing Insurance for multi pages invoice
. V11.01.06 07/07/2021  J.Tan          TSK 0908588
.           Recompiled for PATCATBI - Exclude Unqualified days for Casepayment
. V11.01.05 29/04/2021  Tracey Nguyen    TSK 0308555
.           Recompiled for PRIINVPR
.           29/04/2021  Thanh T          TSK 0299439
.           Added PRSECP00 to return the user access practice code if only one
.           is setup  
. V11.01.04 27/04/2021  J.Tan           TSK 0863287
.           Mod for Patient Invoice new functionality
.           28/04/2021  Thanh T         TSK 0895165
.           Recompiled for OPRARDFD changes
. V11.01.03 07/04/2021  Tracey Nguyen   TSK 0901515
.           Recompiled for PMSCMTFD - Added new fields
.           a) 1 File type for ICD procedure (PMCCIPF)
.           b) 3 new CMBS Field Type (PMCCFTS4/PMCCFT5C/PMCCFT6C)
.           c) 3 new CMBS Codes From (PMCCPC4F,PMCCSC5F,PMCCTC6F)
.           d) 3 new CMBS Codes To   (PMCCPC4T/PMCCSC5T,PMCCTC6T)
. V11.01.02 15/03/2021  Thanh T        TSK 0299439
.           Added MAIN1500, PPINVP00 and PROFLD50 for private practive pending
.           list 
. V11.01.01 11/03/2021  Tracey Nguyen   TSK 0901515
.           Recompiled for PMSCMTFD - Added Primary ICD Procedure 1-5
.           (PMCCICP1-5)
. V11.00.06 09/12/2020  Thanh T        TSK 0872840
.           Added PMSCCDFD/PMSCCDIO as PMSPX2TM changes
. V11.00.05 20/10/2020  Peter Vela       TSK 0898361
.           Recompiled for PRIINVPR
. V11.00.04 20/10/2020  Peter Vela       TSK 0898361
.           Recompiled for PRIINVPR
. V11.00.03 24/04/2020  Peter Vela       TSK 0874025
.           Recompiled for PRIINVPR
. V11.00.02 20/04/2020  Peter Vela      TSK 0874025
.           Recompiled for PRIECTFD
. V11.00.01 17/04/2020  Peter Vela      TSK 0874025
.           Recompiled for PRIECTFD 
. V10.14.06 09/09/2019  J.Tan           TSK 0857392
.           Recompiled for ABF invoice
. V10.14.05 20/08/2019  Thanh T.         TSK 0879967                            
.           Recompiled for PRIINVPR changes                                  
. V10.14.04 23/04/2019  Peter Vela       TSK 0871522
.           Recompiled for PRIINVPR
. V10.14.03 22/03/2019  J.Tan            TSK 0857392
.           Changed RCP Transaction count from DIM3 to DIM5
. V10.14.02 18/02/2019  Peter Vela     TSK 0870149
.           Added Eclipse IMC indicator tag
. V10.14.01 06/02/2019  Peter Vela       TSK 0870096
.           Recompiled for PRIINVPR
.-------------------------------------------------------------------------------
. V10.13.05 21/11/2018  Peter Vela       TSK 0866770
.           Recompiled for PRIINVPR
. V10.13.04 02/11/2018  Peter Vela    TSK 0863035                           
.           Recompiled for PRIINVPR                                   
. V10.13.03 25/09/2018  J.Tan           TSK 0863727
.           Added Restrictive Override code
. V10.13.02 21/08/2018  J.Tan           TSK 0859742
.           Mod to use CLPRIHTR - added Hospital Indicator
. V10.13.01 31/07/2018  J.Tan            TSK 0848506
.           Changed PP Doctor from DIM6 to DIM10
. V10.12.02 18/07/2018  J.Tan          TSK 0859911
.           Recompiled for PATCATBI - Fixed No Payday Add on charge
. V10.12.01 26/04/2018  Peter Vela    TSK 0852811
.           Recompiled for PRIINVTL
. V10.11.05 27/11/2017  Thanh Tieu     Task 0821710
.           Recompiled as PATMASTM changed
. V10.11.04 07/09/2017  J.Tan         TSK 0837479
.           Recompiled for CMXMATRX - OPCNCONS (Using Consumption type items)
. V10.11.03 06/09/2017  J.Tan         TSK 0821057
.           Recompiled for PRIINVHL - mod to variable 76 health fund
. V10.11.02 03/08/2017  Peter Vela     TSK 0837619
.           Recompiled for PRIINVPR
. V10.11.01 28/07/2017  Peter Vela     TSK 0837619
.           Recompiled for PRIINVPR
.           28/07/2017  Thanh T.       TSK 0821710
.           Audit admission/outpatient/UR comments. changed PATMASTM/PMSPX2TM.
.-------------------------------------------------------------------------------
. V10.10.02 13/06/2017  J.Tan          TSK 0839991
.           Recompiled for PATDBTYP (PATCMSTP)
. V10.10.01 10/05/2017  Tracey Nguyen TSK 0837929
.           Recompiled for PRIINVHL and PRIINVTL - Fixed I*C error
.           message on PATMESG1
. V10.08.06 22/06/2016  Peter Vela    TSK 0294177
.           Recompiled for PRIINVPR
. V10.08.05 26/08/2016  Don Nguyen    TSK 0312570
.           Recompiled for CMXMATRX - Added check for PTCNDGED=1
.           Added PMSEDGFD/IO and GETEFDRG
.           15/07/2016  J.Tan         TSK 0819914
.           Recompiled for PATCATBI - Calculating non ICU MV hours
. V10.08.04 24/06/2016  J.Tan         TSK 0821329
.           Mods to initialise CHKMPRAC to 1
. V10.08.03 09/06/2016  Peter Vela    TSK 0820206
.           Recompiled for PRIINVHL
. V10.08.02 18.04.2016  Peter Vela   TSK 0294177
.           Changed read to prihdb to KEY27
. V10.08.01 07/04/2016  Peter Vela    CAR 0294177                            
.           Recompiled for PRIINVPR
. V10.06.02 14/07/2015  Peter Vela     CAR 319413
.           Recompiled for PRBILCMN - Validate for deleted VISMDT
.           record
. V10.06.01 15/05/2015  Davin         CAR 310155
.           Recompiled for PATGBCRN - added MOD10V05 for BPAY
. V10.05.02 06/11/2014  Don Nguyen     CAR 304059
.           Recompiled for changes to OPRSESIO - added Default Team Completed
.           fields.
. V10.05.01 22/07/2014  Ebon Clements CAR 302954
.           Added open of misc charges file
. V10.04.12 16/06/2014  Peter Vela    CAR 302147
.           Recompiled for PRIINVPR
.           16/06/2014 Jill Parkinson CAR 301639
.           Added calls to TFILENAM for FNAME2 and FNAME3
. V10.04.11 10/06/2014 Jill Parkinson CAR 301639
.           Moved calls to TFILENAM to be in INIT0000
. V10.04.10 17/04/2014  Peter Vela   CAR 285260
.           Recompiled for PRIINVPR - Moved Cabrini invoice tail one line
.           down in PRINV230
. V10.04.09 16/04/2014  J.Tan        CAR 261630
.           Removed port number from temp files
. V10.04.08 15.04.2014  Peter Vela   CAR 285260
.           Recompiled for PRIINVPR
. V10.04.07 14.04.2014  Peter Vela   CAR 285260
.           Recompiled for PRIINVPR
. V10.04.06 11.04.2014  Peter Vela   CAR 285260
.           Recompiled for PRIINVPR
. V10.04.05 07.04.2014  Peter Vela   CAR 286158
.           Recompiled for PATMASTM
. V10.04.04 31/03/2014  Peter Vela    CAR 285260
.           Recompiled for PRIINNPR
. V10.04.03 31.03.2014  B.G.Ackland  CAR 299363
.           Replace META Tag Redirect with Javascript in Common RDIREC00
.           Routine
. V10.04.02 23/01/2014 Patrick Adair  CAR 265844
.           Recompiled for PRIINVPR - new fields for PRA State and Mobile phone
.-------------------------------------------------------------------------------
. V10.03.11 09/12/2013  J.Tan         CAR 280726
.           Recompiled for PRIINVPR - flag for Inpatients from Other hospital
. V10.03.10 05/07/2013  J.Tan         CAR 288042
.           Recompiled for PRIINVPR - Fixed WEBFLAG
. V10.03.09 20/06/2013  Davin         CAR 287161
.           Recompiled for PATGBCRN - right justify ptcnhbpi
. V10.03.08 26/03/2013  Don Nguyen    CAR 282342
.           Recompiled for PATGBCRN
. V10.03.07 05/03/2013  Patrick Adair CAR 281898 
.           Recompiled for PATCATBI
. V10.03.06 21/09/2012  J.Tan         CAR 271474
.           Recompiled for CMXMATRX - using index 5 of pmscmtaf
.           04/12/2012  J.Tan         CAR 262673
.           Recompiled for PATCATBI - Casepayment perdiem rate
. V10.03.05 18/07/2012  Don Nguyen    CAR 264561
.           Recompiled for PATGBCRN
. V10.03.04 30/05/2012 J.Tan          CAR 260731
.           Changed 'onchange' to 'onblur' for Credit by Item
. V10.03.03 09/05/2012 J.Tan          CAR 222041
.           Recompiled for PRIINVPR - checking for range of Medical Prac
. V10.03.02 21/02/2012  J.Tan             CAR 255813
.           Added a tag Invoice number for Credit note screen
. V10.03.01 16/01/2012  Sandra Barcham  CAR 256563
.           Recompiled for PATMASTM
. V10.01.03 24/02/2011  Peter Vela    CAR 233034
.           Removed PATBF2FD and PATBF2IO
. V10.01.02 11/02/2010  J.Tan         CAR 233034
.           Mods bed fees to use HF table type
. V10.01.01 21/12/2010  Mike Laming   CAR 233046
.           Mods to Misc.Charges PATMCHFD - Key change, logic changes
. V10.00.08 14/09/2010  Davin             CAR 229590
.           Recompiled for PRIINVTL
. V10.00.07 26/08/2010  Davin             CAR 226963
.           Recompiled for PRIINVHL & PRIINVTL
. V10.00.06 24/08/2010 Peter Vela    CAR 221500
.           Recompiled for PRIINVTL
. V10.00.05 30/07/2010 J.Tan         CAR 227319                       
.           Recompiled for PATCATBI - Mechanical ventilation          
. V10.00.04 14/07/2010  J.Tan         CAR 226158
.           Recompiled for STEPDOWN - bed fees update
. V10.00.03 16/07/2010 J.Tan         CAR 226322
.           Recompiled for CMXMATRX - search for next rule if Contract not valid
. V10.00.02 12/07/2010  J.Tan         CAR 225932
.           Recompiled for PATCATBI - set TDATE to IDATET for per-diem*
. V10.00.01 07/06/2010  Mike Laming   CAR 212864
.           Recompiled for PATCATBI - mods at GCDE6500
. V9.12.10  16/02/2010 Peter Vela    CAR 215485
.           Recompiled for PATCATBI - Ignore Leave if less than 1 day
. V9.12.09  05/02/2010 Peter Vela    CAR 215485
.           Recompiled for PATCATBI - Ignore Leave if less than 1 day
. V9.12.08  09/12/2009 Mike Laming   CAR 210835
.           Added logic for Private Practice Outstanding Debt alert
. V9.12.07  09/10/2009  J.Tan         CAR 203934
.           Recompiled for PATCATBI - display ICD10 Sugg.Class on Inv.
. V9.12.06  01/10/2009  Peter Vela     CAR 203143
.           Recompiled for PRIINVHL
. V9.12.05  03/09/2009  Peter Vela     CAR 194715
.           Recompiled for PRIINVHL PRIINVTL
.           21/09/2009  J.Tan          CAR 204390
.           Recompiled for STEPDOWN - mods to old bed fees file
. V9.12.04  07/08/2009  Mike Laming    CAR 123419
.           Recompiled for PRIINVPR - re-write PATHL000, Add index 4 to
.           PRIHTRFD/IO and index 3 to Temp3 table
. V9.12.03  23/07/2009  J.Tan          CAR 200230
.           Recompiled for PRICALFN - fixed generating previous year data
. V9.12.02  21/07/2009  Mike Laming   CAR 187485
.           Recompiled for RCPBDTFD/IO & TMPBDTFD/IO
. V9.12.01  20/07/2009  Mike Laming   CAR 187485
.           Recompiled for RCPBDTFD/IO & TMPBDTFD/IO
. V9.11.04  23/09/2009  Davin            CAR 178015
.           Recompiled for PRIINVTL - Added field 33 for BPAY CRN
.           Added VARGBCRN and PATGBCRN - BPAY Reference Number
. V9.11.03  08/01/2009  Steve Armstrong   CAR 185927      
.           Recompiled for changes to PRIINVPR & PRIWEBVR.
.           08/01/2009 J.Tan          CAR 178415
.           Added Medical Practice to prifinsf
. V9.11.02  01/12/2008  Steve Armstrong   CAR 184702
.           Recompiled for changes to PRIINVHL & PRIINVTL.
. V9.11.01  20/11/2008  Steve Armstrong   CAR 181373
.           Recompiled for changes to PATCATBI.
.---------------------------------------------------------------------
. V9.10.02  23/05/2008 J.Tan          CAR 169149
.           Added Date and Time invoice created/updated
. V9.10.01  12/05/2008  J.Tan         CAR 162313
.           Added Deposit Status to compdeaf file
.---------------------------------------------------------------------
. V9.09.10  06/03/2008  Ebon Clements CAR 152074
.           Added credit notes to billing summary
. V9.09.09  20/02/2008  Peter Vela    CAR 161535
.           Recompiled for PATCATBI
. V9.09.08  24/20/2007  J.Tan         CAR 147470
.           Mods to update pristatf file for Credit notes
. V9.09.07  24/08/2007  Peter Vela CAR 146143
.           Recompiled for PATCATBI
. V9.09.06  20/08/2007 J.Tan          CAR 144656
.           Recompiled for PATCATBI - for Multiple Procedures Billing 
. V9.09.05  10/08/2007 Peter Vela     CAR 146143
.           Recompiled for PATCATAI
. V9.09.04  25/07/2007 Peter Vela     CAR 144787
.           Recompiled for PATCATAI
. V9.09.03  03/07/2007 Peter Vela     CAR 142173
.           Recompiled for PATCATAI
. V9.09.02  29/06/2007 Peter Vela     CAR 142173
.           Recompiled for PATCATAI
. V9.09.01  25/06/2007 Peter Vela     CAR 142173
.           Recompiled for PATCATAI
.---------------------------------------------------------------------
. V9.08.08  14/05/2007  Peter Vela    CAR 136586
.           Recompiled for PRIINVPR - Added SJOG Referral Doctor details
. V9.08.07  19/02/2007 Peter Vela     CAR 135241  
.           Recompiled for PATCATBI - St. John of God invoice layout
. V9.08.06  26/02/2007  J.Tan         CAR 120014
.           Recompiled for NZPCATBI - NZ exploding misc.item 
. V9.08.05  02/02/2007  Ebon Clements CAR 120001                     
.           Added nz private billing files                           
. V9.08.04  31/01/2007  Peter Vela     CAR 127930
.           Recompiled for MRTMASFD
. V9.08.03  16/01/2007  Peter Vela    CAR 125224
.           Added PRBL0000 to PROFLD00 reportno 1
. V9.08.02  17/11/2006  Peter Vela    CAR 124538
.           Recompiled for PATCATBI
.           Added display of PATITMFD.PTITTCER
.           Type of Certificate Type B Type C
. V9.08.01  28/09/2006  Peter Vela    CAR 118366
.           Recompiled for PRIINVHL - Added medicare suffix
.---------------------------------------------------------------------
. V9.07.01  25/09/2006  Peter Vela    CAR 118940
.           Recompiled for PATCATBI
.---------------------------------------------------------------------
. V9.06.02  16/05/2006  Peter Vela    CAR 104103
.           Recompiled for PATCATBI - PTCNINVL=12
. V9.06.01  28/04/2006  Peter Vela    CAR 102393
.           Recompiled for PRIINVHL - Added PRFA variables from PRINVFD
.---------------------------------------------------------------------
. V9.05.03  27/03/2006  Peter Vela    CAR 95780
.           Recompiled for PRIINVHL - Added emg mobile contact numbers
. V9.05.02  27/03/2006  Peter Vela    CAR 61299
.           Recompiled for PRIINVHL
. V9.05.01  09/03/2006  Ebon Clements CAR 78533
.           Mods for PATCODTM - Hospital specific category codes
. V9.05.B02 30/01/2006  Ebon Clements CAR 93186
.           Mods for REDIRECT length change. Recompiled for IBAWEBDF
. V9.05.B01 20/12/2005  Ebon Clements CAR 76341      
.           Key length changes for encounter number
.---------------------------------------------------------------------
. V9.04.12  02/11/2005  Peter Vela        CAR 81394
.           Recompiled for PATCATBI
. V9.04.11  06/10/2005  J.Tan    CAR 79018 
.           Recompiled for PRIINVPR - fixing item amount
. V9.04.10  03/08/05 J.Tan    CAR 62750  
.           Removed redefined amount variables  
. V9.04.09  11/08/2005  J.Tan        CAR 66543
.           Fixed I*D on pmscnoaf file
. V9.04.08  29/06/2005  Peter Vela    CAR 59789
.           Fixed next and previous buttons for priweb0401002.html (SCHFEE00)
. V9.04.07  16/06/2005  Mike Laming   CAR 61746
.           Recompiled for CLPATDTR - add clear PTDTTIME & PTDTCRST
. V9.04.06  08.06.2005  J.Tan          CAR 56701
.           Added HIC item key to prihtraf file
. V9.04.05  29/03/2005 Ebon Clements  CAR 56706
.           Move SP70 to PRDOSPAR not ZERO
. V9.04.04  21/12/2004  Jeni Tan      CAR 55893
.           Recompiled for PRIINVPR - Fixed west wimmera invoice layout
. V9.04.03  29/11/2004  Mike Laming   CAR 54534
.           Re-comple for PATCMSTP - fix Addit.Charge Description
. V9.04.02  23/09/2004  Lina Vo  CAR 53660
.           Recompiled for PATCATBI - multi hospital theatre fee
. V9.04.01  27/08/2004  J.Tan    CAR 52835
.           Recompiled for PATCATBI - multi hospital
.-------------------------------------------------------------------------------
. V9.03.09  30/06/2004  J.Tan    CAR 51112 
.           Re-comp.for PRIINVPR-unreleased Non-banked deposit 
. V9.03.08  09/06/2004  J.Tan    CAR 50035 
.           Re-compile for PATCATBI - Mechanical ventilation
. V9.03.07  07.06.2004 Peter Vela CAR 49016
.           2004 Statutory Changes - recompiled for PMSPX2TM
. V9.03.06  01.06.2004 J.Tan  CAR 50273
.           Recompiled for PRIINVPR - Cancelled deposit
. V9.03.05  27.04.2004 J.Tan  CAR 49339
.           Fixed amount to be billed for private practice
. V9.03.04  26.03.2004 Lina Vo         CAR 44116
.           Added Credit Note List and View           
. V9.03.03  19.03.2004 Lina Vo         CAR 44116
.           Added Option 4 - Credit Notes             
. V9.03.02  11.03.2004 Lina Vo         CAR 44108
.           Added Option 3 - Debtor Billing Enquiry 
. V9.03.01  10.03.2004 Lina Vo         CAR 44118

. V9.03.00  04.03.2004 Lina Vo         CAR 44117
.           Added Option 1 - Medical Practice Enquiry 
. V9.03.00  03.12.2003 Jill Habasque   CAR 44119
.           Created Program  
.                    
.-------------------------------------------------------------------------------
          INC       IBAWEBDF    
          INC       WEBDATDF
          INC       PABXVARS/INC
          INC       PATCOMM/INC                  * common file
.
          INC       IBAPOLFD/INC
          INC       AAEDE1FD/INC                 * for PATCATAI
          INC       AAEDTRFD/INC                 * for PATCATAI
          INC       APSMASFD/INC
          INC       COMDEPFD/INC
          INC       IBAGEDFD/INC
          INC       IBAGSTFD/INC
          INC       IBATMDFD/INC
          INC       MRTMASFD/INC
          INC       NHIMASFD/INC
          INC       NHIETHFD/INC
          INC       MLTCFNFD/INC
          INC       NZPEXTFD/INC
          INC       NZPRDTFD/INC
          INC       NZPBFEFD/INC
          INC       NZPCFNFD/INC
          INC       NZPCMTFD/INC
          INC       NZPFIGFD/INC
          INC       NZPFINFD/INC
          INC       NZPIBRFD/INC
          INC       NZPMCHFD/INC
          INC       NZPMXCFD/INC
          INC       NZPPFEFD/INC
          INC       NZPRBRFD/INC
          INC       NZPRFNFD/INC
          INC       NZPPICFD/INC
          INC       NZPSPRFD/INC
          INC       NZPTFEFD/INC
          INC       NZPIVBFD/INC
          INC       NZPRVBFD/INC
          INC       OPRDEAFD/INC
          INC       OPRARDFD/INC
          INC       OPRSESFD/INC
          INC       OUTPREFD/INC                 * for PATSRCH
          INC       OUTSITFD/INC
.
          INC       PATAFEFD/INC
          INC       PATALRFD/INC
          INC       PATASDFD/INC
          INC       PATELGFD/INC
          INC       PATBFEFD/INC                 * bed fee file
          INC       PATCALAG/INC
          INC       PATCMXFD/INC
          INC       PMSUCHFD/INC
          INC       PMSUCDFD/INC
          INC       PATMASTD/INC
          INC       PATCONFD/INC
          INC       PATCTFFD/INC
          INC       PATCFAFD/INC
          INC       PMSCIDFD/INC
          INC       PATDGWFD/INC
          INC       PATDO1FD/INC
          INC       PATDRGFD/INC
          INC       PATDSCFD/INC                 * discharge file
          INC       PATDTRFD/INC                 * patient transaction file
          INC       PATECDFD/INC
          INC       PATECOFD/INC
          INC       PATFINFD/INC                 * financial statistics file
          INC       PATFMOFD/INC
          INC       PATFX1FD/INC
          INC       PATFN1FD/INC
          INC       PATFN2FD/INC
          INC       PATGSRFD/INC
          INC       PATHDFFD/INC
          INC       PATHLFFD/INC
          INC       PATHTRFD/INC
          INC       PATIBLFD/INC
          INC       PATICUFD/INC
          INC       PATIN1FD/INC
          INC       PATINPFD/INC
          INC       PATINVFD/INC                 * invoice file
          INC       PATIOVFD/INC
          INC       PATITMFD/INC                 * item file
          INC       PATLDFFD/INC
          INC       PATLSDFD/INC
          INC       PATMA1FD/INC
          INC       PATMCHFD/INC                 * miscellaneous charges file
          INC       PATMESFD/INC
          INC       PATMI1FD/INC
          INC       PATOVBFD/INC
          INC       PATPERFD/INC
          INC       PATPGRFD/INC
          INC       PATPR1FD/INC
          INC       PATRATFD/INC                 * Rate file
          INC       PATRBLFD/INC
          INC       PATRCAUD/INC                 * billing rate audit file
          INC       PATRFNFD/INC
          INC       PATSRBFD/INC
          INC       PATTFEFD/INC
          INC       PATTRNFD/INC                 * bed transfer file
          INC       PATVISFD/INC
          INC       PATVENFD/INC
          INC       PMSHATFD/INC
          INC       PMSVX1FD/INC
          INC       PATWR1FD/INC
          INC       VISPAYFD/INC
.
          INC       PATHSPFD/INC
          INC       PATCMTFD/INC
          INC       PMSCCDFD/INC   * Concession Card Details
          INC       PMSCMTFD/INC
          INC       PMSHCGTD/INC
          INC       PMSHCGFD/INC
          INC       PMSHCPTD/INC
          INC       PMSHCPFD/INC
          INC       PMSHCLFD/INC
          INC       PMSCNOFD/INC
          INC       PMSIDEFD/INC
          INC       PMSPBRFD/INC
          INC       PMSSGAFD/INC
          INC       PMSMTIFD/INC
          INC       PMSMPRFD/INC
          INC       PMSPX2TD/INC
          INC       PMSSINFD/INC
          INC       PMSPX2FD/INC
.
          INC       PRIRASFD/INC
          INC       PRIUREFD/INC
          INC       PATDETFD/INC
          INC       PRIALSFD/INC                 * Access to All Med Prac
          INC       PRIAUIFD/INC
          INC       PRIBULFD/INC
          INC       PRICNOFD/INC
          INC       PRICONFD/INC
          INC       PRIDOCFD/INC
          INC       PRIDTRFD/INC
          INC       PRIECTFD/INC
          INC       PRIEXCFD/INC                 * execption charges file
          INC       PRIFCIFD/INC
          INC       PRIFIGFD/INC
          INC       PRIFINFD/INC
          INC       PRIGRPFD/INC
          INC       PRIHDBFD/INC
          INC       PRIHISFD/INC
          INC       PRILHIFD/INC                 * fin. letter history file
          INC       PRIFLTFD/INC                 * fin. letter file
          INC       PRIHOLFD/INC
          INC       PRIHREFD/INC
          INC       PRIHTRFD/INC
          INC       PRIINVFD/INC
          INC       PRIITMFD/INC
          INC       PRIMABFD/INC
          INC       PRIMGPFD/INC
          INC       PRIMULFD/INC
          INC       PRIPRAFD/INC
          INC       PRISECFD/INC                 * Access to Indiv Med Prac
          INC       PRISPTFD/INC                 * spec. path. test file
          INC       PRISTAFD/INC
          INC       PRITESFD/INC
          INC       PRIVAFFD/INC
          INC       PRIVRDEB/INC
          INC       PRIWEBVR/INC
          INC       PRIWCOFD/INC
          INC       HICITIFD/INC
.
          INC       TFILEVAR/INC
.
          INC       RCPBNKFD/INC
          INC       RCPBDTFD/INC
          INC       RCPREGFD/INC
          INC       RCPDTEFD/INC
          INC       WEBDINVS/INC                 * invoice data definitions
          INC       PMSEDGFD/INC       * Effective DRG Dates
          INC       PATDDHFD/INC
.
          INC       VARGBCRN/INC
.
          INC       WEBIMCFD/INC
          INC       WEBB2BFD/INC
.
          INC       RSHWEBDF
.
.*********************************************************************
.*                              TEMP FILES                           *
.*********************************************************************
PRITM1XX  IFILE     SQL, FIXED=19, KEY="U1-8"
PRITM1XY  IFILE     SQL, FIXED=19, KEY="U9-16,17-18,1-8"
.
. NAME    TYPE   LENGTH   PHYSICAL  START LOC.   DESCRIPTION
. ----    ----   ------   --------  ----------   -----------
DTEMPUNQ  DIM      8         8          1        Unique Identifier
TEMPDEB   DIM      8         8          9        Debtor Number
DTEMPSCN  DIM      2         2         17        Scan Flag
.                                                  0 = Debtor
.                                                  1 = PMI
.End of Record                         19
.
. Redefine form fields from key
. -----------------------------
TEMPUNQ   FORM     8
TEMPSCN   FORM     2
+
.---------------------------------------------------------------------------
.  CGI Variables
.---------------------------------------------------------------------------
.
NEXTPAGE  DIM       1       * Nextpage parameter CGI parameter
UPDTTYPE  DIM       1       * Update Type
UPDATETY  FORM      1
STARTKEY  DIM       15      * Starting Key
INVOICEN  FORM      12      * Invoice Number
UNIQNUMB  FORM      8       * Unique Number
REASCRED  DIM       3
KEEPMISC  FORM      1
CREDAMNT  FORM      8.2[99]   * Array of credit amount
GSTAAMNT  FORM      8.2[99]   * Array of GST amount
TRANSNUM  FORM      6[99]   * Array of Transaction number
VISITTYP  FORM      1
CREDITNO  DIM       8
.
PRIDC001  DIM       6       * Medical Practice Code
PRIDC002  DIM       10      * Associated Doctor Code
PRIDC003  DIM       4       * Financial Year
PRIDC004  DIM       1       * Display 1=Invoiced 2=To be Invoiced
.
ASGDEB    DIM       1[999]
PRTINV    DIM       1[999]
INVNUM    DIM       8[999]
REASMOVE  DIM       3
REASADMN  DIM       50
DEBTAGNT  DIM       3                       * Debt Collection Agency
FILTSTAT  DIM       1
FILTAUTO  DIM       1
FILTCLAM  DIM       3
FILTHFND  DIM       6
SHOWFLAG  DIM       1
.
DOCTNAME  DIM       50
CLAMDESC  DIM       20
FUNDNAME  DIM       40
PATTYPED  DIM       20
ACCTYPED  DIM       20
.
.---------------------------------------------------------------------------
. Variable Declarations  
.---------------------------------------------------------------------------
.
.
ALLMPFLG  FORM      1
.
BALANCE   FORM      12.2
BALDIM15  DIM       15
.
CALCDATE  DATE      8
CALDAYS   FORM      4                           * for PATCATBI
CASHT     FORM      12.2
CASHTOT1  FORM      12.2
CASHTOT2  FORM      12.2
CASHTOT3  FORM      12.2
CASHTOT4  FORM      12.2
CASHTOT5  FORM      12.2
CASHTOT6  FORM      12.2
CASHTOT7  FORM      12.2
CASHTOT8  FORM      12.2
CASHTOT9  FORM      12.2
CASTOT10  FORM      12.2
CASTOT11  FORM      12.2
CASTOT12  FORM      12.2
CASTOT13  FORM      12.2
CHKMPRAC  FORM      "1"
CERTINDC  FORM      1
CMBSFEE   FORM      1                           * for PATCATBI
COUNTER   FORM      3
CREDNUMB  DIM       8 
CURRDATE  DIM       8 
CURSESS   DIM       18                          * for PATCATBI
.
DAYCOL    FORM      4                           * for PATCATBI
DAYFORMT  DIM       4                           * for PATCATBI
DESCPERD  DIM       20
DESCPIND  DIM       20
DIM1A     DIM       1                           * for PATCATBI
DIM3      DIM       3
DIM3A     DIM       3                           * for PATCATBI
DIM3B     DIM       3                           * for PATCATBI
DIM4      DIM       4                           * for PATCATBI
DIM9      DIM       9                           * for PATCATBI
DIM14     DIM       14
DIM18     DIM       18                          * for CALCTBI
DIM18A    DIM       18                          * for CALCTBI
DIM24A    DIM       24
DIM26A    DIM       26
DIM28     DIM       28
DIM30     DIM       30                          * for PATCATBI
DIM80     DIM       80
DISPFLAG  FORM      1       * PP Billin Enquiry 0=Med Prac 1=Serv Doct
DOCTCODE  DIM       10
DOCTOR    DIM       30      * Formatted Doctor
.
.
EPRAC     DIM       6
EFTDATE   DIM       8         * Effective date (ccyymmdd)
FIRST12   DIM       12
FGSTFLAG  FORM      1
FNAME1    DIM       8
FORM3A    FORM      3
FORM52    FORM      5.2
FORM8     FORM      8
FORM10    FORM      10
FSTAMNT   FORM      12.2
FSTDATE   DIM       8
FSTWORK   FORM      12.2
FORM5     FORM      5
.
GNDCASH   FORM      8.2
GNDINV    FORM      8.2
GNDJOUR   FORM      8.2
GRANDTOT  FORM      10.2
.
HFHIFUND  FORM      2
.
INVOICE   FORM      12.2
INVTOT1   FORM      12.2
INVTOT2   FORM      12.2
INVTOT3   FORM      12.2
INVTOT4   FORM      12.2
INVTOT5   FORM      12.2
INVTOT6   FORM      12.2
INVTOT7   FORM      12.2
INVTOT8   FORM      12.2
INVTOT9   FORM      12.2
INVTOT10  FORM      12.2
INVTOT11  FORM      12.2
INVTOT12  FORM      12.2
INVTOT13  FORM      12.2
ITEMAMNT  FORM      12.2
.
JOURNALS  FORM      12.2
JOURTOT1  FORM      12.2
JOURTOT2  FORM      12.2
JOURTOT3  FORM      12.2
JOURTOT4  FORM      12.2
JOURTOT5  FORM      12.2
JOURTOT6  FORM      12.2
JOURTOT7  FORM      12.2
JOURTOT8  FORM      12.2
JOURTOT9  FORM      12.2
JORTOT10  FORM      12.2
JORTOT11  FORM      12.2
JORTOT12  FORM      12.2
JORTOT13  FORM      12.2
.
KEY13A    DIM       13                          
KEY24A    DIM       24                          
KEY21A    DIM       21
KEY29A    DIM       29
.
HEALTHFD  DIM       6
.
LASTITEM  FORM      2       * Last Array Item
LENPTR    FORM      2
.
MBSCOUNT  FORM      2
MBSFLAG   FORM      1
MESSCODE  DIM       3
MPGEFLAG  FORM      1
MTHNAM3A  DIM       3                           * for PATCATBI
MTIFLAG   FORM      1
.
OPENBAL   FORM      12.2
OPCNCONS  DIM       1
.
PROCESSD  FORM      1
PRINTINV  DIM       1
PATPORTN  FORM      12.2
PREVFLAG  FORM      1
PREVVKEY  DIM       26
PATLINK   DIM       127                     * Link to the next patient info
PATINDIC  DIM       3
PATNAME   DIM       25
PATADD3   DIM       21
PPBILL    FORM      9.2                          * pp amount to be billed
PPCASH    FORM      9.2                          * pp pending cash received
PPCRED    FORM      9.2                          * pp credit notes
PPIDATE   DIM       8                            * pp last invoice date
PPINV     FORM      9.2                          * pp invoice totals
PPPAID    FORM      9.2                          * pp amount paid total
PPJRNL    FORM      9.2                          * pp journal total
PPNEXT    FORM      9.2                          * pp next invoice total
PPOUT     FORM      9.2                          * pp amount outstanding
PPPEND    FORM      9.2                          * pp outstanding total
PRANAME   DIM       45
PRAADD1   DIM       35                 * address of P.R.A. - line 1
PRAADD2   DIM       35                 *                     line 2
PRAADD3   DIM       35                 *                     line 3
PRAADD4   DIM       35                 *                     line 4
PRAPOST   DIM       8                  * postcode of P.R.A.
PRAPPHON  DIM       20                 * home phone of P.R.A.
PRABPHON  DIM       20                 * business phone of P.R.A.
PRAMPHON  DIM       20                 * mobile phone of P.R.A.
PRARREL   DIM       10                 * relationship of P.R.A.
PRACTICE  DIM       6
PREVBAL   FORM      12.2
PSAGECON  DIM       3
PSAGETYP  DIM       6
PTBILL    FORM      12.2                         * patient amount to be billed
PTCASH    FORM      12.2                         * patient pending cash received
PTCRED    FORM      12.2                         * patient credit notes
PTIDATE   DIM       8                            * patient last invoice date
PTINV     FORM      12.2                         * patient invoice totals
PTPAID    FORM      12.2                         * patient amount paid total
PTJRNL    FORM      12.2                         * patient journal total
PTNEXT    FORM      12.2                         * patient next invoice total
PTOUT     FORM      12.2                         * patient amount outstanding
PTPEND    FORM      12.2                         * patient outstanding total
NETAMNT   FORM      12.2                         * Inv pending net amount
TOTNETA   FORM      12.2                         * Inv pending net amount total
SERVDATE  DIM       8                            * Inv pending service date
.
PRHTR001  DIM       8                            * Unique Identifier
PRHTR002  DIM       6                            * Medical Practice code
PRHTR003  DIM       10                           * Service Doctor
PRHTR004  DIM       3                            * Patient Indicator
PRHTR005  DIM       10                           * Referring doctor code
PRHTR006  DIM       8                            * Referring date
PRHTR007  DIM       2                            * Item flag
PRHTR008  DIM       9                            * Item number
PRHTR009  DIM       3                            * Sub item number
PRHTR010  DIM       3                            * Transaction number
.
PRHRE028  DIM       3
.
ROWCOUNT  FORM      5
RACLINDC  DIM       1
.
SPRAC     DIM       6
SAVKEY9   DIM       9
SAVKEY12  DIM       12
SAVAEND   FORM      4                           * for PATCATBI
SAVALLW   FORM      6.2                          * for CALCTBI
SAVBEND   FORM      3                            * for CALCTBI
SAVDEBT   DIM       8
SAVDISC   FORM      6.2                          * for CALCTBI
SAVSCAN   FORM      2
STRDATE   DIM       12
SUMDAYS   FORM      4                           * for PATCATBI
SAVPSNAM  DIM       20
.
TOTOUTS   FORM      12.2
TEMPDATE  DIM       8                           * temporary date
TEST12    DIM       12
TFEEIND   FORM      1                           * for PATCATBI
THCFLG    FORM      2                           * for PATCATBI
TOTCRED   FORM      9.2
TOTTCRD   FORM     7.2
TOTTGST   FORM     7.2
TOTCCRD   FORM     7.2
TOTCGST   FORM     7.2
TOTBILL   FORM      9.2                         * totals for inpatient & pp
TOTCASH   FORM      9.2
TOTINV    FORM      9.2
TOTNEXT   FORM      9.2
TOTPAID   FORM      9.2
TOTDEPS   FORM      12.2
TOTJRNL   FORM      9.2
TOTOUT    FORM      9.2
TOTPEND   FORM      9.2
TRANSNO   FORM      3                  * transaction number
.
URDIM8    DIM       8
.
WDATE1    DIM       8                          * for PATGNCMX
WDATE2    DIM       8                          * for PATGNCMX
.
CFPAYCOD  DIM       3        * 3M Codefinder PAY Code
.
.
.---------------------------------------------------------------------------
.  Constants
.---------------------------------------------------------------------------
.
OPNFLAG   FORM      "0"                          * for CALCTBI
.
NJAN      INIT      "January"
NFEB      INIT      "February"
NMAR      INIT      "March"
NAPR      INIT      "April"
NMAY      INIT      "May"
NJUN      INIT      "June"
NJUL      INIT      "July"
NAUG      INIT      "August"
NSEP      INIT      "September"
NOCT      INIT      "October"
NNOV      INIT      "November"
NDEC      INIT      "December"
.
CATCR     INIT      "cr"
CODEPY    INIT      "Py"
.
SP14      INIT      "              "
SP45      INIT      "                                             "
...X5        INIT      "XXXXX"
...X10       INIT      "XXXXXXXXXX"
Z2        INIT      "ZZ"
ZED20     INIT      "zzzzzzzzzzzzzzzzzzzz"
ZERO8     INIT      "0000    "              * needed by PATINVS
.
.
.---------------------------------------------------------------------------
PRGID     INIT      "PRIWEB04"
VERSION   INIT      "V12.00.04"
PRGNAM    INIT      "Private Practice Enquiry"
.---------------------------------------------------------------------------
          CALL      WEBINT00       * Initialise Fifo Etc.
          CALL      INIT0000       * Open Files
.
MAIN1000  CALL      WEBRED00       * Read Fifo WEBPID and USERID
.
          COMPARE   "999",REPORTNO * End Server Process on Report Option 999
          GOTO      MAIN9999 IF EQUAL
.
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          BRANCH    REPORTNO,MAIN1100,MAIN1200,MAIN1300,MAIN1400,MAIN1500:
                             MAIN1600
.
          PACK      WEBTITLE,PRGID,SP1,VERSION,SP1,PRGNAM,SP70
          MOVE      "Invalid Option",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          GOTO      MAIN1000
.
...MAIN1100  CALL      PRIDBT00        * Debtors Maintenance
...          BRANCH    EXIT,MAIN1000
...          MOVE      "Update Complete",WEBTITLE
...          CALL      NXTPAG00
...          GOTO      MAIN1000
. 
MAIN1100  CALL      PRIMPE00              * Medical Practice Enquiry
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
. 
MAIN1200  CALL      PRISDE00              * Service Doctor Enquiry
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
. 
MAIN1300  CALL      PRIBIL00              * Debtor Billing Enquiry
          GOTO      MAIN1000
. 
MAIN1400  CALL      PRICRN00              * Credit Notes             
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1500  CALL      PPINVP00              * Private Practive Invoice Pending
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
. 
MAIN1600  CALL      LRCP0000              * Reciepts Processing List
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN9999  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      WEBERR00
          STOP
.------------------------------------------------------------
. Output Next Page Based on CGI Parameter nextpage
.------------------------------------------------------------
NXTPAG00  MOVE      ZERO,F1
          MOVE      NEXTPAGE,F1
          BRANCH    F1,NXTPAG10,NXTPAG20,NXTPAG30,NXTPAG40,NXTPAG50
.
          CALL      WINCLS00
          GOTO      NXTPAG99
.
NXTPAG10  CALL      RDIREC00
          GOTO      NXTPAG99
.
NXTPAG20  CALL      GOBACK00      * Go Back 1 Html page
          GOTO      NXTPAG99
.
NXTPAG30  CALL      DAH20000      * Go Back 2 html pages 
          GOTO      NXTPAG99
.
NXTPAG40  CALL      GOBACK00
          GOTO      NXTPAG99
.
NXTPAG50  CALL      PREDIR00
          GOTO      NXTPAG99
NXTPAG99  RETURN
.------------------------------------------------------------------------------
.  Redirect Parent URL
.------------------------------------------------------------------------------
PREDIR00  CALL      OPENHTML
          BRANCH    EXIT,PREDIR90
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
.                             " alert(#"",WEBTITLE,"#");":
                             " parent.location.href=#"",REDIRECT,"#";":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      PREDIR99
.
PREDIR90  DISPLAY   "*** Fifo Not Found ***"
.
PREDIR99  RETURN
.-------------------------------------------------------------------------------
.  Goes back 1 page
.-------------------------------------------------------------------------------
GOBACK00  CALL      OPENHTML
          BRANCH    EXIT,GOBACK99
          WRITE     HTMLFILE;"<script language=#"JavaScript#"> {":
                             "    alert(#"",WEBTITLE,"#");":
                             "    self.close();":
                             "    opener.history.go(-1);": 
                             "}":
                             "</script>"
          CALL      CLOSHTML
GOBACK99  RETURN
.-------------------------------------------------------------------------------
. Open Files and Initialize Variables
.-------------------------------------------------------------------------------
INIT0000  CALL      INTMAS00
.
          OPEN      PATCODE1,"patcodes" 
          OPEN      PATCODE2,"patcodes" 
.
          OPEN      PATAFEA1,"patafeaf"
          OPEN      PATASDA1,"patasdaf"
          OPEN      PATCMXA1,"patcmxaf"
          OPEN      PATDRGA1,"patdrgaf"
          OPEN      PATDRGA2,"patdrgaf"
          OPEN      PATDSCH1,"patdschf"          * discharge file
          OPEN      PATDTRA1,"patdtraf"
          OPEN      PATDTRA3,"patdtraf"          * transaction file
          OPEN      PATGSRN1,"patgsrnf"
          OPEN      PATGSRN2,"patgsrnf"          * open Patient Surname file
          OPEN      PATHDFA1,"pathdfaf"
          OPEN      PATHLFA1,"pathlfaf"
          OPEN      PATINVR1,"patinvrf"
          OPEN      PATINVR3,"patinvrf"          * invoice file
          OPEN      PATLDFA1,"patldfaf"
          OPEN      PATLSDA1,"patlsdaf"
          OPEN      PATMA1A1,"patma1af"
          OPEN      PATMESG1,"patmesgf"
          OPEN      PATMCHG1,"patmchgf"
          OPEN      PATMX1A1,"patmx1af"
          OPEN      PATTRAN2,"pattranf"          * transfer file
          OPEN      PATVISA2,"patvisaf"
.
          OPEN      PMSHCPA1,"pmshcpaf" 
          OPEN      PMSMTIA1,"pmsmtiaf"
          OPEN      PMSHCLA1,"pmshclaf"
.
          OPEN      PRIALSA1,"prialsaf"
          OPEN      PRIBULK1,"pribulkf"
          OPEN      PRICNOA1,"pricnoaf"
          OPEN      PRICNOA2,"pricnoaf"
          OPEN      PRICNOA3,"pricnoaf"
...          OPEN      PRIDEBT1,"pridebtf" 
          OPEN      PRIDOCT1,"pridoctf" 
          OPEN      PRIDOCT2,"pridoctf" 
          OPEN      PRIDTRA1,"pridtraf"
          OPEN      PRIDTRA3,"pridtraf"
          OPEN      PRIDTRA4,"pridtraf"
          OPEN      PRIFCIA1,"prifciaf"
          OPEN      PRIFCIA3,"prifciaf"
          OPEN      PRIFINS1,"prifinsf"  
          OPEN      PRIFIGA1,"prifigaf"  
          OPEN      PRIFLTR1,"prifltrf"          * fin. letter file
          OPEN      PRIGRPA1,"prigrpaf"
          OPEN      PRIHDBT1,"prihdbtf"
          OPEN      PRIHDBT2,"prihdbtf"
          OPEN      PRIHOLA1,"priholdf"
          OPEN      PRIHREF1,"prihreff"
          OPEN      PRIHREF2,"prihreff"
          OPEN      PRIHREF4,"prihreff"
          OPEN      PRIHREF5,"prihreff"
          OPEN      PRIHTRA1,"prihtraf"
          OPEN      PRIHTRA2,"prihtraf"
          OPEN      PRIHTRA3,"prihtraf"
          OPEN      PRIHTRA4,"prihtraf"                               *I-123419
          OPEN      PRIINVO1,"priinvof"
          OPEN      PRIINVO2,"priinvof"
          OPEN      PRIINVO3,"priinvof"
          OPEN      PRIITEM1,"priitemf"
          OPEN      PRILHIS1,"prilhisf"          * fin. letter history file
          OPEN      PRIMGPA1,"primgpaf"
          OPEN      PRIMULT1,"primultf"
          OPEN      PRIPRAC1,"pripracf"
          OPEN      PRISECA1,"prisecaf"
          OPEN      PRISECA2,"prisecaf"
          OPEN      PRISTAT1,"pristatf"
          OPEN      PRISTAT2,"pristatf"
          OPEN      PRISTAT3,"pristatf"
          OPEN      PRITEST1,"pritestf"
          OPEN      PRITHIS1,"prithisf"
          OPEN      OPRARDA1,"oprardaf"
.
          OPEN      PRIUREA1,"priureaf"
          OPEN      PRIUREA2,"priureaf"
          OPEN      PRIRASA1,"prirasaf"
          OPEN      PATDETA1,"patdetaf"
          OPEN      IBAPOLA1,"ibapolaf"
          OPEN      RCPREGA1,"rcpregaf"
          OPEN      RCPBNKA1,"rcpbnkaf"
          OPEN      RCPBDTA1,"rcpbdtaf"
          OPEN      RCPDTEA1,"rcpdteaf"
          OPEN      RCPDTEA3,"rcpdteaf"
          OPEN      COMDEPA2,"comdepaf"
. 
          OPEN      NZPBFEA1,"nzpbfeaf"
          OPEN      NZPCFNA1,"nzpcfnaf"
          OPEN      NZPCMTA1,"nzpcmtaf"
          OPEN      NZPCMTA2,"nzpcmtaf"
          OPEN      NZPCMTA3,"nzpcmtaf"
          OPEN      NZPFIGA1,"nzpfigaf"
          OPEN      NZPFIGA2,"nzpfigaf"
          OPEN      NZPFINA1,"nzpfinaf"
          OPEN      NZPFINA2,"nzpfinaf"
          OPEN      NZPIBRA1,"nzpibraf"
          OPEN      NZPMCHA1,"nzpmchaf"
          OPEN      NZPMCHA2,"nzpmchaf"
          OPEN      NZPPICA1,"nzppicaf"
          OPEN      NZPPICA2,"nzppicaf"
          OPEN      NZPRBRA1,"nzprbraf"
          OPEN      NZPRFNA1,"nzprfnaf"
          OPEN      NZPRFNA2,"nzprfnaf"
          OPEN      NZPPFEA1,"nzppfeaf"
          OPEN      NZPSPRA1,"nzpspraf"
          OPEN      NZPSPRA2,"nzpspraf"
          OPEN      NZPTFEA1,"nzptfeaf"
          OPEN      NZPTFEA2,"nzptfeaf"
          OPEN      OPRDETA1,"oprdetaf"
          OPEN      OPRDETA2,"oprdetaf"
          OPEN      OPRSESA1,"oprsesaf"
          OPEN      MLTCFNA1,"mltcfnaf"
          OPEN      MLTCFNA2,"mltcfnaf"
.
          OPEN      CONTROLF,"controlf"
          READ      CONTROLF,ZERO;*85,IBCNUGST
          READ      CONTROLF,TEN;*79,CAPPRVNO
          READ      CONTROLF,THIRTY3;*115,PRCNAUTO,*200,PRCNRDOC,*213,PRCNDAPS
          READ      CONTROLF,THIRTY4;*199,PRCNAFEE
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,HUND24;*111,PTCNUIMC
          READ      CONTROLF,HUND29;*61,PTCNWSIN,*73,PTCNIMCW
          READ      CONTROLF,HUND30;*1,PTCNHABN
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
          ENDIF
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FNAME1
.
...  used in PATCATBI CRMV0000
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FNAMEX
.
...  used in PATCATBI PTMP0000
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FNAMEZ
.
...  used in PATCATBI PT2P0000
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FNAMEY
.
...  used in PABXBILL
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,PBXFNAME
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,PBXFNAM2
.
...  used in PRIINVPR
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FNAME2
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FNAME3
.
INIT9999  RETURN
.-------------------------------------------------------------------------------
. Clear Parameters
.-------------------------------------------------------------------------------
CLRPAR00  MOVE      ZERO,STARTNUM
          MOVE      ZERO,NORECORD
          MOVE      SP70,FRSTDATE
          MOVE      SP70,LASTDATE
          MOVE      SP70,VYEARMTH
          MOVE      ZERO,VIEWTYPE
          MOVE      ZERO,REPORTNO
          MOVE      SP70,TEMPLATE
          MOVE      SP70,UPDTTYPE
          MOVE      ZERO,UPDATETY
          MOVE      SP70,ADMISSNO
          MOVE      SP70,URNUMBER 
          MOVE      SP70,NEXTPAGE
          PACK      REDIRECT,SP70,SP70,SP70,SP70
          MOVE      SP70,STARTKEY
          MOVE      ZERO,INVOICEN
          MOVE      ZERO,UNIQNUMB
          MOVE      ZERO,KEEPMISC
          MOVE      SP70,REASCRED
          MOVE      ZERO,VISITTYP
          MOVE      SP70,CREDITNO
.
...          CALL      CLPRDB00
.
          MOVE      SP70,PRIDC001
          MOVE      SP70,PRIDC002
          MOVE      SP70,PRIDC003
          MOVE      SP70,PRIDC004
.
          MOVE      SP70,FILTCLAM
          MOVE      SP70,FILTHFND
          MOVE      SP70,FILTSTAT
          MOVE      SP70,FILTAUTO
          MOVE      SP70,SHOWFLAG
.
          MOVE      SP70,REASMOVE
          MOVE      SP70,DEBTAGNT
          MOVE      SP70,PRINTINV
          MOVE      ZERO,PATPORTN
          MOVE      ZERO,PROCESSD
          MOVE      SP70,REASADMN
          MOVE      SP70,PREVVKEY
          MOVE      ZERO,PREVFLAG
          MOVE      SP70,SELPRINT
.
          MOVE      ONE,COUNTER
          WHILE     COUNTER <= 99
            MOVE      ZERO,CREDAMNT[COUNTER]
            MOVE      ZERO,GSTAAMNT[COUNTER]
            MOVE      ZERO,TRANSNUM[COUNTER]
            MOVE      SP70,ASGDEB[COUNTER]
            MOVE      SP70,PRTINV[COUNTER]
            MOVE      SP70,INVNUM[COUNTER]
            ADD       ONE,COUNTER
          DO
.
CLRPAR99  RETURN
.-------------------------------------------------------------------------------
. Set Parameters
.-------------------------------------------------------------------------------
SETPAR00  MATCH     "reportno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REPORTNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "urnumber=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,URNUMBER
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admissno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMISSNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "template=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TEMPLATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updttype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDTTYPE
            GOTO      SETPAR99
          ENDIF
.   
          MATCH     "updatety=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,UPDATETY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nextpage=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTPAGE
            GOTO      SETPAR99
          ENDIF  
.
          MATCH     "redirect=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REDIRECT
            GOTO      SETPAR99
          ENDIF
. 
          MATCH     "keywords=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,KEYWORDS
            GOTO      SETPAR99
          ENDIF
. 
          MATCH     "norecord=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NORECORD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "frstdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FRSTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "lastdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LASTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "vyearmth=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VYEARMTH
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "viewtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VIEWTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startnum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTNUM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTKEY
            PACK      STARTKEY,STARTKEY,SP70
            GOTO      SETPAR99
          ENDIF
.
...          MATCH     "pridb",QRYNAME
...          IF        @EQUAL
...            CALL      SPPRD000
...            GOTO      SETPAR99 
...          ENDIF
.
          MATCH     "pridc",QRYNAME
          IF        @EQUAL
            CALL      STDOC000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtclam=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILTCLAM
            PACK      FILTCLAM,FILTCLAM,SP70 
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filthfnd=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILTHFND
            PACK      FILTHFND,FILTHFND,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtstat=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILTSTAT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtauto=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILTAUTO
            PACK      FILTAUTO,FILTAUTO,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "showflag=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,SHOWFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "invoicen=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,INVOICEN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "uniqnumb=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,uniqnumb
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "keepmisc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,KEEPMISC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "reascred=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REASCRED
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "tranno",QRYNAME
          IF        @EQUAL
            CALL      STTRN000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "crdamt",QRYNAME
          IF        @EQUAL
            CALL      STCRD000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "gstamt",QRYNAME
          IF        @EQUAL
            CALL      STGST000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "visittyp=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,VISITTYP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "creditno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CREDITNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "reasmove=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REASMOVE
            PACK      REASMOVE,REASMOVE,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "reasadmn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REASADMN
            PACK      REASADMN,REASADMN,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "debtagnt=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DEBTAGNT
            PACK      DEBTAGNT,DEBTAGNT,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "printinv=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRINTINV
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "patportn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PATPORTN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "processd=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PROCESSD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prevvkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PREVVKEY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prevflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PREVFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "asg00",QRYNAME
          IF        @EQUAL
            CALL      STASG000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prt00",QRYNAME
          IF        @EQUAL
            CALL      STPRT000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "inv00",QRYNAME
          IF        @EQUAL
            CALL      STINV000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "selprint=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SELPRINT
            GOTO      SETPAR99
          ENDIF

SETPAR99  RETURN
+
.------------------------------------------------------------
.   Set Parameters for transaction number
.------------------------------------------------------------
STTRN000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY6,KEY2
          MOVE      KEY2,F2
          SQUEEZE   QRYDATA
          MOVE      QRYDATA,TRANSNUM[F2]
          MOVE      F2,LASTITEM
STTRN999  RETURN
+
.------------------------------------------------------------
.   Set Parameters for Credit amount
.------------------------------------------------------------
STCRD000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY6,KEY2
          MOVE      KEY2,F2
          SQUEEZE   QRYDATA
          MOVE      QRYDATA,CREDAMNT[F2]
STCRD999  RETURN
+
.------------------------------------------------------------
.   Set Parameters for GST amount
.------------------------------------------------------------
STGST000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY6,KEY2
          MOVE      KEY2,F2
          SQUEEZE   QRYDATA
          MOVE      QRYDATA,GSTAAMNT[F2]
STGST999  RETURN
+
.------------------------------------------------------------
. Set parameters for Reassign Debt
.------------------------------------------------------------
STASG000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STASG999 IF EQUAL
          MOVE      QRYDATA,ASGDEB[F3]
STASG999  RETURN
+
.------------------------------------------------------------
. Set parameters for Reprint Invoice
.------------------------------------------------------------
STPRT000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STPRT999 IF EQUAL
          MOVE      QRYDATA,PRTINV[F3]
STPRT999  RETURN
+
.------------------------------------------------------------
. Set parameters for Invoice number
.------------------------------------------------------------
STINV000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STINV999 IF EQUAL
          MOVE      QRYDATA,INVNUM[F3]
STINV999  RETURN
+
.-------------------------------------------------------------------------------
.   Set Parameters for Option 1 - Medical Practice Doctors
.-------------------------------------------------------------------------------
STDOC000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,STDOC001,STDOC002,STDOC003,STDOC004
          GOTO      STDOC999
.
STDOC001  SQUEEZE   QRYDATA
          MOVE      QRYDATA,PRIDC001
          PACK      PRIDC001,PRIDC001,SP70
          GOTO      STDOC999
.
STDOC002  SQUEEZE   QRYDATA
          MOVE      QRYDATA,PRIDC002
          PACK      PRIDC002,PRIDC002,SP70
          GOTO      STDOC999
.
STDOC003  SQUEEZE   QRYDATA
          MOVE      QRYDATA,PRIDC003
          PACK      PRIDC003,PRIDC003,SP70
          GOTO      STDOC999
.
STDOC004  SQUEEZE   QRYDATA
          MOVE      QRYDATA,PRIDC004
          PACK      PRIDC004,PRIDC004,SP70
          GOTO      STDOC999
.
STDOC999  RETURN
.---------------------------------------------------------------------
. Medical Practice Enquiry : Display
.---------------------------------------------------------------------
PRIMPE00  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      PRIMPE50 IF EQUAL
.
.
.         ************ DISPLAY FORMACTION **********
.
PRIMPE50  MATCH     SP70,PRIDC001
          GOTO      PRIMPE90 IF EQUAL
.
          PACK      KEY6,PRIDC001,SP70  * Read Medical Practice Record
          CALL      RDPRPR1
          BRANCH    OVRCD,PRIMPE91
.
          PACK      KEY22,PRIDC001,PRIDC002,SP70
          CALL      RSPRDO1
          CALL      RKPRDO1
          IF        OVRCD = 0
            MATCH     PRIDC001,PRDOPRAC
            CALL      CLRDOC00 IF NOT EQUAL
.
            MATCH     PRIDC002,PRDODOCT
            CALL      CLRDOC00 IF NOT EQUAL
.
          ELSE
            CALL      CLRDOC00    * Clear all the file variables
          ENDIF
          GOTO      PRIMPE90
.
PRIMPE90  CLEAR     WEBTITLE
          MOVE      "Medical Practice Enquiry",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,PRIMPE99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      PRIMPE99
.
PRIMPE91  MOVE      "Medical Practice does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRIMPE99
.
PRIMPE99  RETURN
+
.---------------------------------------------------------------------
. Service Doctor Enquiry : Display
.---------------------------------------------------------------------
PRISDE00  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      PRISDE50 IF EQUAL
.
.
.         ************ DISPLAY FORMACTION **********
.
PRISDE50  MATCH     SP70,PRIDC002
          GOTO      PRISDE90 IF EQUAL
.
          PACK      KEY22,PRIDC002,SP70
          CALL      RSPRDO2
          CALL      RKPRDO2
          IF        OVRCD = 0
            MATCH     PRIDC002,PRDODOCT
            CALL      CLRDOC00 IF NOT EQUAL
          ELSE
            CALL      CLRDOC00    * Clear all the file variables
          ENDIF
.
          GOTO      PRISDE90
.
PRISDE90  CLEAR     WEBTITLE
          MOVE      "Service Doctor Enquiry",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,PRISDE99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      PRISDE99
.
PRISDE91  MOVE      "Service Doctor does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRISDE99
.
PRISDE99  RETURN
+
.-----------------------------------------------------------
. Initialize's file data
.-----------------------------------------------------------
CLRDOC00  MOVE      SP70,PRDOPRAC  * Medical Practice Code
          MOVE      SP70,PRDODOCT  * Associated Doctor Code
          MOVE      SP70,PRDOCLAM  * Claim Code (Category CL)
          MOVE      SP70,PRDOPIND  * Patient Indicator (Category GI)
          MOVE      ZERO,PRDOCOMM  * Associated Doctor % Commission
          MOVE      ZERO,PRDOFEEP  * % of Schedule Fee Charged
          MOVE      ZERO,PRDOSTAT  * Assoc Doctor Status 1=Inactive 0=Active
          MOVE      SP70,PRDOPROV  * Service provider 
          MOVE      SP70,PRDOSPAR  * Spare Variable
.
CLRDOC99  RETURN
+
.---------------------------------------------------------------------
. Debtor Billing Enquiry : Display
.---------------------------------------------------------------------
PRIBIL00  MATCH     SP10,URNUMBER
          GOTO      PRIBIL91 IF EQUAL
.
          CALL      CLPATMAS
          MATCH     "       0",URNUMBER
          IF        !@EQUAL
            MOVE      URNUMBER,KEY8
            CALL      RDMAST1
            MOVE      OVRCD,MASTFLAG
            MOVE      PURNO,KEY8
            CALL      RDPMPX21
            IF        OVRCD=1
              CALL      CLPMSPX2
            ENDIF
            CALL      PATNAA00                * format name without bold tags
          ENDIF
.
.         Get the most recent letter sent from the history file
.
          MOVE      URNUMBER,VDEBTOR
          MOVE      ONE,VSCANPMI
.
          PACK      KEY21,VDEBTOR,VSCANPMI,ZED20
          CALL      RSPRLH1                      * position in file
          CALL      RPPRLH1                      * read previous record
          BRANCH    OVRCD,PRIBIL50               * end of file
.
          MATCH     VDEBTOR,PRLHDEBT             * same debtor ?
          GOTO      PRIBIL50 IF NOT EQUAL        * no
.
          COMPARE   VSCANPMI,PRLHSCAN                 * same scan flag ?
          GOTO      PRIBIL50 IF NOT EQUAL        * no
.
          MOVE      ZERO,PRFLLINE
          PACK      KEY6,PRLHNUMB,PRFLLINE
          CALL      RDPRFL1                      * read fin. letter file
          IF        OVRCD=1                                       
            MOVE      "Unknown letter",PRFLTEXT
          ENDIF
          GOTO      PRIBIL80
.
PRIBIL50  MOVE      ZERO,PRLHNUMB
          MOVE      SP70,PRFLTEXT
          MOVE      SP70,PRLHDATE
.
PRIBIL80  MOVE      ZERO,ALLMPFLG
          MOVE      USERID,KEY10
          CALL      RDPRALS1
          IF        OVRCD=0          
            MOVE      ONE,ALLMPFLG
          ENDIF
          CALL      BPRI0000                     * get private practice details
          CALL      BPAT0000                     * get patient details
.
PRIBIL90  CLEAR     WEBTITLE
          MOVE      "Debtor Billing Enquiry",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,PRIBIL99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      PRIBIL99
.
PRIBIL91  MOVE      "Patient does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRIBIL99
.
PRIBIL99  RETURN
+
.****************************************************************************
.*                                BPRI0000             Called by: PRIBIL00  *
.*                       get private practice billing details               *
.****************************************************************************
.
.         Get all the debtor's invoice records
.
BPRI0000  MOVE      SP8,PPIDATE                  * initialise totals
          MOVE      ZERO,PPOUT
          MOVE      ZERO,PPINV
          MOVE      ZERO,PPPAID
          MOVE      ZERO,PPJRNL
          MOVE      ZERO,PPCRED
          MOVE      ZERO,PPPEND
          MOVE      ZERO,PPBILL
          MOVE      ZERO,PPCASH
          MOVE      ZERO,PPNEXT
.
          PACK      KEY18,VDEBTOR,VSCANPMI,SP8
          CALL      RSPRIN3                      * position in file
BPRI0500  CALL      RKPRIN3                      * read next record
          BRANCH    OVRCD,BPRI2000               * end of file
.
          MATCH     PRINDEBT,VDEBTOR             * same debtor ?
          GOTO      BPRI2000 IF NOT EQUAL        * no
.
          COMPARE   VSCANPMI,PRINSCAN                 * same scan number ?
          GOTO      BPRI2000 IF NOT EQUAL        * no
.
.         Show only Medical Practice user has access to.
.
          MATCH     SP10,PRIDC001
          IF        @EQUAL
            BRANCH    ALLMPFLG,BPRI0800
            PACK      KEY16,USERID,PRINPRAC
            CALL      RDPRSEC2
            BRANCH    OVRCD,BPRI0500
          ELSE
            MATCH     PRINPRAC,PRIDC001
            GOTO      BPRI0500 IF NOT EQUAL
          ENDIF
.
.         Save most recent invoice date
.
BPRI0800  MATCH     PRINDATE,PPIDATE             * invoice date more recent ?
          GOTO      BPRI1000 IF NOT LESS         * no
.
          MOVE      PRINDATE,PPIDATE
.
BPRI1000  ADD       PRINITOT,PPINV               * update running totals
          ADD       PRINPAMT,PPPAID
          ADD       PRINHAMT,PPPAID
          ADD       PRINIAMT,PPPAID
          ADD       PRINMAMT,PPPAID
          ADD       PRINVAMT,PPPAID
          ADD       PRINOTHA,PPPAID
          ADD       PRINJAMT,PPJRNL
          ADD       PRINGSTJ,PPJRNL
          ADD       PRINCNTT,PPCRED
          GOTO      BPRI0500                     * get next invoice record
.
BPRI2000  UNPACK    PPIDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE                      * format date
.
          MOVE      PPINV,PPPEND                 * calculate amount outstanding
          ADD       PPPAID,PPPEND                * for current invoices
          ADD       PPJRNL,PPPEND
          ADD       PPCRED,PPPEND
          ADD       PPPEND,PPOUT
.
. ------- Get pending invoice details ---------------------
.
          CALL      NXTI0000                     * get pending invoice trans.
.
          ADD       PPBILL,PPNEXT                * update next invoice totals
          ADD       PPNEXT,PPOUT
.
BPRI9500  MOVE      PPINV,TOTINV                 * update grand totals
          MOVE      PPPAID,TOTPAID
          MOVE      PPJRNL,TOTJRNL
          MOVE      PPCRED,TOTCRED
          MOVE      PPOUT,TOTOUT
          MOVE      PPPEND,TOTPEND
          MOVE      PPBILL,TOTBILL
          MOVE      PPCASH,TOTCASH
          MOVE      PPNEXT,TOTNEXT
.
BPRI9999  RETURN
+
.****************************************************************************
.*                                BPAT0000             Called by: PRIN0000  *
.*                   get patient system billing details           BDET0000  *
.****************************************************************************
.
.         Read all the visit records for this debtor
.
BPAT0000  MOVE      SP8,PTIDATE                  * initialise totals
          MOVE      ZERO,PTOUT
          MOVE      ZERO,PTINV
          MOVE      ZERO,PTPAID
          MOVE      ZERO,PTJRNL
          MOVE      ZERO,PTCRED
          MOVE      ZERO,PTPEND
          MOVE      ZERO,PTBILL
          MOVE      ZERO,PTCASH
          MOVE      ZERO,PTNEXT
.
          PACK      KEY24,VDEBTOR,SP20
          CALL      RDSVISA2                     * position in file
BPAT1000  CALL      RDKVISA2                     * read next record
          BRANCH    OVRCD,BPAT5000               * end of file
.
          MOVE      VDEBTOR,KEY8                  * same debtor ?
          MATCH     PVIURNO,KEY8                 * same debtor ?
          GOTO      BPAT5000 IF NOT EQUAL        * no
.
.         Get the admission record
.
          MOVE      PVIBILL,AADMNO
          MOVE      AADMNO,KEY8
          CALL      RDMISS1                      * read admission record
          BRANCH    OVRCD,BPAT1000
.
.         Using the admission number, access the invoice file for any
.         matching records
.
          PACK      KEY16,AADMNO,SP8
          CALL      RDSINV3                      * position in file
BPAT2000  CALL      RDKINV3                      * read next record
          BRANCH    OVRCD,BPAT4000               * end of file
.
          MATCH     PVIBILL,PINVADM              * same admission number ?
          GOTO      BPAT4000 IF NOT EQUAL        * no - get next visit record
.
.         Save most recent invoice date
.
          MOVE      PINVDTE,TEMPDATE
          MATCH     TEMPDATE,PTIDATE             * invoice date more recent ?
          GOTO      BPAT3000 IF NOT LESS         * no
.
          MOVE      TEMPDATE,PTIDATE
.
BPAT3000  ADD       PINVAMT,PTINV                * store amounts
          ADD       PINVPATA,PTPAID
          ADD       PINVHFDA,PTPAID
          ADD       PINVOTHA,PTPAID
          ADD       PINVJOUR,PTJRNL
          ADD       PTINGSTJ,PTJRNL
          ADD       PTINCRTT,PTCRED
.
          GOTO      BPAT2000                     * get next invoice record
.
. ------- Calculate the amount still to be invoiced for this admission -----
.
BPAT4000  MOVE      CDD,TDAY                     * initialise variables
          MOVE      CMM,TMON
          MOVE      CYY,TYEAR
          MOVE      CCC,TCENT
          MOVE      ZERO,NETTOT
          MOVE      ZERO,GOVTOTAL
          MOVE      ZERO,DISFLG                  * discharge flag
.
.         See if a discharge record is on file, as the discharge date
.         will be used to calculate the "to be invoiced" amounts
.
          MOVE      SP8,DDATE
          MOVE      AADMNO,KEY8
          CALL      RDDSCH1                      * discharge record on file ?
          MOVE      OVRCD,DISFLG
.
          MOVE      ZERO,IPASS
          MOVE      ONE,PROGFLAG                 * calculate totals only
.
          COMPARE   ONE,ASTAT                    * pre-admission record ?
          CALL      CALCTBI IF NOT EQUAL         * no - get next invoice amount
.
          CALL      GCSH0000                     * get cash recvd for admission
.
          ADD       NETTOT,PTBILL                * update next invoice totals
          IF        IBCNUGST=2
            ADD       TOTGST,PTBILL
          ENDIF
          ADD       CSAMT,PTCASH
.
          GOTO      BPAT1000                     * get next visit record
.
. ------- No more records, so display totals ---------------
.
BPAT5000  UNPACK    PTIDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE                      * format date
.
          MOVE      PTINV,PTPEND                 * calculate amount outstanding
          ADD       PTPAID,PTPEND                * for current invoices
          ADD       PTJRNL,PTPEND
          ADD       PTCRED,PTPEND
          ADD       PTPEND,PTOUT
          MOVE      PTBILL,PTNEXT
          SUB       PTCASH,PTNEXT
          ADD       PTNEXT,PTOUT
.
BPAT5500  ADD       PTINV,TOTINV                 * update invoice grand totals
          ADD       PTPAID,TOTPAID
          ADD       PTJRNL,TOTJRNL
          ADD       PTCRED,TOTCRED
          ADD       PTPEND,TOTPEND
          ADD       PTOUT,TOTOUT
.
BPAT6000  ADD       PTBILL,TOTBILL                * update grand totals
          ADD       PTCASH,TOTCASH
          ADD       PTNEXT,TOTNEXT
.
BPAT9999  RETURN
+
.****************************************************************************
.*                                NXTI0000             Called by: ML0000    *
.*                   get the transactions for pending invoices    BPRI0000  *
.****************************************************************************
.
NXTI0000  CALL      CREATP00                     * create temp files
          CALL      CLRTF000                     * clear temp files
          MOVE      ONE,FLAGSOME                 * set flag for no transactions
.
          PACK      KEY27,VDEBTOR,VSCANPMI,SP20
          CALL      RSPRHD1                      * position in header file
NXTI0500  CALL      RKPRHD1                      * read next record
          BRANCH    OVRCD,NXTI2000               * no more records
.
          MATCH     PRHDDEBT,VDEBTOR             * same debtor ?
          GOTO      NXTI2000 IF NOT EQUAL        * no
.
          COMPARE   PRHDSCAN,VSCANPMI            * same scan flag ?
          GOTO      NXTI2000 IF NOT EQUAL        * no
.
          MOVE      PRHDUNIQ,TEMPUNQ
          PACK      KEY28,ONE,PRHDUNIQ,SP20
          CALL      RSPRHR2                      * position in referral file
.
          CALL      RKPRHR2                      * read next record
          BRANCH    OVRCD,NXTI0500               * no more records
.
          COMPARE   PRHRPINV,ONE                 * invoice to print ?
          GOTO      NXTI0500 IF NOT EQUAL        * no
.
          COMPARE   PRHDUNIQ,PRHRUNIQ            * same unique identifier ?
          GOTO      NXTI0500 IF NOT EQUAL        * no - get next header record
.
.         Show only Medical Practice user has access to.
.
          MATCH     SP10,PRIDC001
          IF        @EQUAL
            BRANCH    ALLMPFLG,NXTI1000
            PACK      KEY16,USERID,PRHRPRAC
            CALL      RDPRSEC2
            BRANCH    OVRCD,NXTI0500
          ELSE
            MATCH     PRHRPRAC,PRIDC001
            GOTO      NXTI0500 IF NOT EQUAL
          ENDIF
.
NXTI1000  CALL      PRIINVLD                     * load data into temp file
          BRANCH    EXIT,NXTI0500                * get next header record
.
          MOVE      ZERO,FLAGSOME                * set transactions found flag
          GOTO      NXTI0500                     * get next header record
.
NXTI2000  IF        FLAGSOME = ZERO
             CALL      PPTMP000                  * process pathology tests
             CALL      PINV0000               * calculate pending amount
          ENDIF
.
NXTI9800  CALL      KILL0000                  * kill existing temp file
NXTI9999  RETURN
+
.****************************************************************************
.*                                GCSH0000             Called by: NXTI0000  *
.*                         get cash received                      BPAT0000  *
.****************************************************************************
GCSH0000  MOVE      AADMNO,DAADMNO
          MOVE      ZERO,CSAMT                   * initialise cash total
          MOVE      "0",CMDESTAT
          PACK      KEY26,AADMNO,CMDESTAT,SP70
.
          CALL      RSCMDEP2
GCSH1000  CALL      RKCMDEP2
          BRANCH    OVRCD,GCSH9999
.
          MATCH     DAADMNO,CMDEADMN             * same admission number ?
          GOTO      GCSH9999 IF NOT EQUAL        * no
          MATCH     "0",CMDESTAT                 * Deposit held?
          GOTO      GCSH9999 IF NOT EQUAL
.
          PACK      KEY17,CMDERECN,CMDETCNT
          CALL      RDRCDTE1
          BRANCH    OVRCD,GCSH1000
.
          ADD       RCDTAMNT,CSAMT                * add amount
          GOTO      GCSH1000                     * get next cash record
.
GCSH9999  RETURN
+
.****************************************************************************
.*                                PINV0000             Called by: NXTI0000  *
.*              get total for pending invoices for billing screen           *
.****************************************************************************
.
PINV0000  PACK      KEY80,SP30,SP30,SP20
          CALL      RSTMPR2                      * position in temp file
PINV0500  CALL      RKTMPR2                      * read next record
          BRANCH    OVRCD,PINV9999               * end of file
.
          CALL      RDIT0000                     * read in item record
.
          MOVE      ONEHUND,PRDOFEEP             * get % doctor charge
          PACK      KEY22,TMPPRAC,TMPSDOCT,TMPCLAIM,TMPPIND
          CALL      RDPRDO1
.
          MOVE      TMPITOT,TEMPTOTV
          MOVE      TMPITOT,TEMPAMNT
          CALL      GETAJ000                     * adjust for doctor % charge
          MOVE      TEMPAMNT,TMPITOT
.
          MULT      TMPSERVS,TMPITOT             * calculate line total
.
          ADD       TMPITOT,PPBILL               * increment total
          IF        IBCNUGST=2
            MOVE      TMPGSTA,PRDTGSTA
            MOVE      TMPGSTC,PRDTGSTC
            CALL      GGST0000                   * Get GST amount
            MOVE      TMPITOT,LINGSTA
            MULT      IBGEAMNT,LINGSTA
            DIV       "100.00",LINGSTA
            ADD       LINGSTA,PPBILL
          ENDIF
.
          GOTO      PINV0500                     * get next transaction
.
PINV9999  RETURN
+
.---------------------------------------------------------------------
. Credit Note                         
.---------------------------------------------------------------------
PRICRN00  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      PRICRN80 IF EQUAL
.
          MATCH     "A",UPDTTYPE
          GOTO      PRICRN10 IF EQUAL
.
          MATCH     "I",UPDTTYPE
          GOTO      PRICRN20 IF EQUAL
          GOTO      PRICRN99
.
.         Credit All the selected invoice
.
PRICRN10  MOVE      INVOICEN,FORM8
          MOVE      FORM8,KEY8
          CALL      RDPRIN1
          BRANCH    OVRCD,PRICRN93
.
          MATCH     "1",PRINCNST
          GOTO      PRICRN94 IF EQUAL
.
          CALL      PRCA0000        * Processing Credit All
          MOVE      ZERO,EXIT
          GOTO      PRICRN99
.
.         Credit by item
.
PRICRN20  MOVE      INVOICEN,FORM8
          MOVE      FORM8,KEY8
          CALL      RDPRIN1
          BRANCH    OVRCD,PRICRN93
.
          MATCH     "1",PRINCNST
          GOTO      PRICRN94 IF EQUAL
.
          CALL      PRCI0000  * Processing credit for each trans record
          MOVE      ZERO,EXIT
          GOTO      PRICRN99
.
.
.         ************ DISPLAY FORMACTION **********
.
PRICRN80  MATCH     "005",TEMPLATE
          GOTO      PRICRN90 IF EQUAL
.
          MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,PRICRN92
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MOVE      INVOICEN,FORM8
          MOVE      FORM8,KEY8
          CALL      RDPRIN1
          BRANCH    OVRCD,PRICRN90
          MOVE      PRINUNIQ,UNIQNUMB
.
          CALL      GINDC000  * Get patient Indictor
          GOTO      PRICRN90
.
PRICRN90  CLEAR     WEBTITLE
          MOVE      "Credit Note",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,PRICRN99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      PRICRN99
.
PRICRN91  MOVE      "Credit Note does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRICRN99
.
PRICRN92  MOVE      "Patient U/R does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRICRN99
.
PRICRN93  MOVE      "Invoice Number does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRICRN99
.
PRICRN94  MOVE      "Invoice already fully credited",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRICRN99
.
PRICRN99  RETURN
+
.------------------------------------------------------------
.         Get patient indicator
.------------------------------------------------------------
GINDC000  MOVE      ONE,VSCANPMI
          PACK      KEY24,PRINDEBT,VSCANPMI,PRINNUMB,SP10
          CALL      RSPRDT3                      * position in file
          CALL      RKPRDT3                      * read next record
          BRANCH    OVRCD,GINDC900               * end of file
.
          MATCH     PRINDEBT,PRDTDEBT            * same debtor ?
          GOTO      GINDC900 IF NOT EQUAL        * no
.
          COMPARE   ONE,PRDTSCAN                 * same scan flag ?
          GOTO      GINDC900 IF NOT EQUAL        * no
.
          MATCH     PRDTINVN,PRINNUMB            * same invoice number ?
          GOTO      GINDC900 IF NOT EQUAL
.
          MOVE      PRDTCODE,PATINDIC
          GOTO      GINDC999
.
GINDC900  MOVE      SP10,PATINDIC
GINDC999  RETURN
.------------------------------------------------------------
.         Process PP Credit ALL for the selected invoice
.------------------------------------------------------------
PRCA0000  CALL      GENCR000               * Generate next credit note number
          MOVE      ZERO,TOTCCRD
          MOVE      ZERO,TOTCGST
.
          PACK      KEY22,UNIQNUMB,PRINNUMB,SP6
          CALL      RSPRDT1
PRCA1000  CALL      RKPRDT1
          BRANCH    OVRCD,PRCA2000
.
          COMPARE   UNIQNUMB,PRDTUNIQ
          GOTO      PRCA2000 IF NOT EQUAL
          MATCH     PRINNUMB,PRDTINVN
          GOTO      PRCA2000 IF NOT EQUAL
.
          COMPARE   ONE,PRDTRTYP              * Item type only
          GOTO      PRCA1000 IF NOT EQUAL
.
          CALL      GCCR0000             * Get previous amount of credit note
.
          MOVE      PRDTAMNT,ITEMAMNT
.
          MOVE      ZERO,FORM8P2
          COMPARE   PRDTAMNT,ZERO
          IF        !@EQUAL
            MOVE      PRDTGSTM,FORM8P2
          ENDIF
.
          MOVE      ITEMAMNT,PRFCCAMT    * Credit Amount
          MOVE      FORM8P2,PRFCCGST    * Credit GST Amount
          ADD       TOTAMT,PRFCCAMT
          ADD       TOTGST,PRFCCGST
          MULT      "-1",PRFCCAMT
          MULT      "-1",PRFCCGST
          CALL      WRFCI000       * Write record to prifciaf
.
          MOVE      "1",PRDTCNST   * Fully credited
          CALL      UPPRDT1        * Update pridtraf
.
.         If misc.items are to be kept, write records to prihtraf
.
          IF        KEEPMISC=1
            CALL      WRHTR000     * Write record to prihtraf
          ENDIF
.
          MOVE      PRFCCAMT,PRDTIAMT
          MOVE      PRFCCGST,PRDTGSTM   
          CALL      UPPFIN00       * Update prifinsf & prifigaf file
.
          ADD       PRFCCAMT,TOTCCRD
          ADD       PRFCCGST,TOTCGST
          GOTO      PRCA1000
.
.         Update invoice file
.
PRCA2000  MOVE      "1",PRINCNST           * Fully credited
          MOVE      PRINITOT,PRINCNTT      * amount credited
          MULT      "-1",PRINCNTT
          PACK      PRINUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PRINUDAT          * date updated
          CLOCK     TIME,PRINUTIM          * time updated
          MOVE      USERID,PRINUUID        * web user id
          CALL      UPPRIN1                * Update priinvof
.                                                                     *I-210835
          IF        PRINSCAN = 1
            PROC      FLAGDEBP             * Flag PMI Outstanding Debt
          ENDIF
.
          MOVE      PRINNUMB,KEY8
          PROC      PRIUPURE               * Write/Update Unreconciled inv.file
.
          MOVE      CREDNUMB,PRCOCRNO
          PACK      PRCODATE,CCC,CYY,CMM,CDD
          REP       " 0",PRCODATE          * date invoice was credited
          MOVE      PRINDEBT,PRCODEBT
          MOVE      PRINSCAN,PRCOSCAN
          MOVE      PRINNUMB,PRCOINVN
          MOVE      "1",PRCOSTAT           * Fully credited
          MOVE      REASCRED,PRCOREAS    * Reason for credit note
          MOVE      TOTCCRD,PRCOAMNT       * Total amount of credit note
          ADD       TOTCGST,PRCOAMNT       * plus GST
          MOVE      TOTCGST,PRCOGSTM       * Total GST
          MOVE      PRCOCRNO,KEY8
          CALL      WRPRCNO1               * Write record to pricnoaf
.
          CALL      PSTA0000               * Update statistic file
.
          CALL      DECL0000           *  Check if need to delete Eclipse claims
.
PRCA9999  RETURN
+
.------------------------------------------------------------
.         Process Credit by item
.------------------------------------------------------------
PRCI0000  COMPARE   ZERO,LASTITEM
          GOTO      PRCI9999 IF EQUAL
.
.         Do not process if no amounts entered
.
          MOVE      ONE,COUNTER
          WHILE     COUNTER <= LASTITEM
            MOVE      CREDAMNT[COUNTER],FORM72
            MOVE      GSTAAMNT[COUNTER],FORM7P2
            IF        FORM72<>0 | FORM7P2<>0
              GOTO      PRCI0100
            ENDIF
            ADD       ONE,COUNTER
          DO
          GOTO      PRCI9999
          
PRCI0100  CALL      GENCR000               * Generate next credit note number
.
          MOVE      ZERO,TOTAMT
          MOVE      ZERO,TOTGST
.
          MOVE      ONE,COUNTER
          WHILE     COUNTER <= LASTITEM
            MOVE      CREDAMNT[COUNTER],FORM72
            MOVE      GSTAAMNT[COUNTER],FORM7P2
            IF        FORM72<>0 | FORM7P2<>0
              PACK      KEY22,UNIQNUMB,PRINNUMB,TRANSNUM[COUNTER],SP70
              CALL      RDPRDT1
              IF        OVRCD=0
                MOVE      CREDAMNT[COUNTER],PRFCCAMT   * Credit Amount
                MOVE      GSTAAMNT[COUNTER],PRFCCGST   * GST Amount
                MULT      "-1",PRFCCAMT
                MULT      "-1",PRFCCGST
                CALL      WRFCI000       * Write record to prifciaf
.
                MOVE      "2",PRDTCNST   * credit by item
                CALL      UPPRDT1        * Update pridtraf
.
                MOVE      PRFCCAMT,PRDTIAMT   * add credit amount from prifinsf
                MOVE      PRFCCGST,PRDTGSTM   * add gst crd amount from prifinsf
                CALL      UPPFIN00            * Update prifinsf & prifigaf file
              ENDIF
              ADD      PRFCCAMT,TOTAMT
              ADD      PRFCCGST,TOTAMT
.
              ADD      PRFCCGST,TOTGST
            ENDIF
            ADD       ONE,COUNTER
          DO
.
          COMPARE   ZERO,TOTAMT
          GOTO      PRCI1000 IF NOT EQUAL
          COMPARE   ZERO,TOTGST
          GOTO      PRCI9999 IF EQUAL
.
.         Check if invoice is now fully credited
.
PRCI1000  CALL      CCRD0000               * Check if invoice is now fully cred.
          IF        EXIT=1
            MOVE      "1",PRCOSTAT         * fully credited
          ELSE
            MOVE      "2",PRCOSTAT         * partially credited
          ENDIF
.
          MOVE      CREDNUMB,PRCOCRNO
          PACK      PRCODATE,CCC,CYY,CMM,CDD
          REP       " 0",PRCODATE       * date invoice was credited
          MOVE      PRINDEBT,PRCODEBT
          MOVE      PRINSCAN,PRCOSCAN
          MOVE      PRINNUMB,PRCOINVN
          MOVE      REASCRED,PRCOREAS    * Reason for credit note
          MOVE      TOTAMT,PRCOAMNT        * Total amount of credit note
          MOVE      TOTGST,PRCOGSTM        * Total GST
          MOVE      PRCOCRNO,KEY8
          CALL      WRPRCNO1               * Write record to pricnoaf
.
.         Credit note has now been fully credited, so update the flag in dtr
.
          MATCH     "1",PRCOSTAT
          IF        @EQUAL
            CALL      UPCRD000             * Update dtr for the credit note flag
          ENDIF
.
.         Update the total amount credited for this invoice
.
          IF        EXIT=1
            MOVE      "1",PRINCNST           * fully credited
          ELSE
            MOVE      "2",PRINCNST           * partially credited
          ENDIF
          ADD       TOTAMT,PRINCNTT        * amount credited
          PACK      PRINUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PRINUDAT             * date updated
          CLOCK     TIME,PRINUTIM             * time updated
          MOVE      USERID,PRINUUID           * web user id
          CALL      UPPRIN1
.                                                                     *I-210835
          IF        PRINSCAN = 1
            PROC      FLAGDEBP                * Flag PMI Outstanding Debt
          ENDIF
.
          MOVE      PRINNUMB,KEY8
          PROC      PRIUPURE               * Write/Update Unreconciled inv.file
.
          CALL      PSTA0000               * Update statistic file
.
PRCI9999  RETURN
+
.----------------------------------------------------------------
.         Update Credit notes amount to Statistic file
.----------------------------------------------------------------
PSTA0000  MOVE      PRCOAMNT,FORM12P2
          PACK      KEY14,PRCODATE,SP6
          CALL      RDSDRGA2                * position on the date range file
          CALL      RDKDRGA2
          BRANCH    OVRCD,PSTA9999
.
          MATCH     DRGFDTE,PRCODATE        * see if the invoice date is in a
          GOTO      PSTA9999 IF LESS          date range
.
          MOVE      DRGYR,PRSTYEAR
          MOVE      DRGNUM,FORM2
          MOVE      PRINPRAC,PRSTPRAC
          MOVE      PRINDOCT,PRSTDOCT
          PACK      KEY20,PRSTYEAR,PRSTPRAC,PRSTDOCT,SP70
          CALL      RDPRST1                 * read the private practice
          BRANCH    OVRCD,PSTA5000            financial statistics file
.
          LOAD      SAVAMT,FORM2,PRSTJP01,PRSTJP02,PRSTJP03,PRSTJP04:
                                 PRSTJP05,PRSTJP06,PRSTJP07,PRSTJP08:
                                 PRSTJP09,PRSTJP10,PRSTJP11,PRSTJP12,PRSTJP13
          ADD       FORM12P2,SAVAMT
          STORE     SAVAMT,FORM2,PRSTJP01,PRSTJP02,PRSTJP03,PRSTJP04:
                                 PRSTJP05,PRSTJP06,PRSTJP07,PRSTJP08:
                                 PRSTJP09,PRSTJP10,PRSTJP11,PRSTJP12,PRSTJP13
.
          CALL      UPPRST1                 * update the private practice
          GOTO      PSTA9999                  financial statistics file
.
.------ Record doesn't exist - create new record with zero opening balance ----
.
PSTA5000  MOVE      ZERO,COUNTR
PSTA6000  ADD       ONE,COUNTR
          COMPARE   COUNTR,FORTY             * see if all fields have been
          GOTO      PSTA7000 IF LESS          processed
.
          STORE     ZERO,COUNTR,PRSTOBAL,PRSTIP01,PRSTIP02,PRSTIP03,PRSTIP04:
                                PRSTIP05,PRSTIP06,PRSTIP07,PRSTIP08,PRSTIP09:
                                PRSTIP10,PRSTIP11,PRSTIP12,PRSTIP13,PRSTCP01:
                                PRSTCP02,PRSTCP03,PRSTCP04,PRSTCP05,PRSTCP06:
                                PRSTCP07,PRSTCP08,PRSTCP09,PRSTCP10,PRSTCP11:
                                PRSTCP12,PRSTCP13,PRSTJP01,PRSTJP02,PRSTJP03:
                                PRSTJP04,PRSTJP05,PRSTJP06,PRSTJP07,PRSTJP08:
                                PRSTJP09,PRSTJP10,PRSTJP11,PRSTJP12,PRSTJP13
          GOTO      PSTA6000
.
.------ Add amount to appropriate field ------
.
PSTA7000  LOAD      SAVAMT,FORM2,PRSTJP01,PRSTJP02,PRSTJP03,PRSTJP04:
                                 PRSTJP05,PRSTJP06,PRSTJP07,PRSTJP08:
                                 PRSTJP09,PRSTJP10,PRSTJP11,PRSTJP12,PRSTJP13
          ADD       FORM12P2,SAVAMT
          STORE     SAVAMT,FORM2,PRSTJP01,PRSTJP02,PRSTJP03,PRSTJP04:
                                 PRSTJP05,PRSTJP06,PRSTJP07,PRSTJP08:
                                 PRSTJP09,PRSTJP10,PRSTJP11,PRSTJP12,PRSTJP13
          CALL      WRPRST1                 * write to the private practice
.                                             financial statistics file
PSTA9999  RETURN
+
.----------------------------------------------------------------
.         Update credit note flag in dtr file
.----------------------------------------------------------------
UPCRD000  PACK      KEY22,UNIQNUMB,PRINNUMB,SP70
          CALL      RSPRDT1 
UPCRD100  CALL      RKPRDT1 
          BRANCH    OVRCD,UPCRD999
.
          COMPARE   UNIQNUMB,PRDTUNIQ
          GOTO      UPCRD999 IF NOT EQUAL
          MATCH     PRINNUMB,PRDTINVN
          GOTO      UPCRD999 IF NOT EQUAL
.
          COMPARE   ONE,PRDTRTYP              * Item type only
          GOTO      UPCRD100 IF NOT EQUAL
.
          MOVE      "1",PRDTCNST   * Fully credited
          CALL      UPPRDT1 
          GOTO      UPCRD100
.
UPCRD999  RETURN
+
.----------------------------------------------------------------
.         Generate next PP credit note number
.----------------------------------------------------------------
GENCR000  MOVE      SP20,PRFCCRNO
          READ      CONTROLF,THIRTY4;*218,PRCNCRNO
.
          MOVE      "109",PRXCODE   * System Lock Sector 109
          CALL      GETSLK00        * Get System Lock of Sector 109
.
          READ      CONTROLF,THIRTY4;*218,PRCNCRNO
.
          COMPARE   ZERO,PRCNCRNO
          IF        @EQUAL
            MOVE      ONE,PRCNCRNO
          ENDIF
.
GENCR100  MOVE      PRCNCRNO,KEY8
          CALL      RAPRCNO1               * Write record to pricnoaf
          IF        OVRCD=0
            ADD       ONE,PRCNCRNO
            GOTO      GENCR100
          ENDIF
.
          ADD       ONE,PRCNCRNO
          WRITAB    CONTROLF,THIRTY4;*218,PRCNCRNO
          CALL      RELSLK00        * Release System Lock of Sector 109
          SUB       ONE FROM PRCNCRNO
          MOVE      PRCNCRNO,CREDNUMB       * credit note number
GENCR999  RETURN
+
.------------------------------------------------------------
.         Get the previous credit amount
.------------------------------------------------------------
GCCR0000  MOVE      ZERO,TOTAMT
          MOVE      ZERO,TOTGST
          PACK      KEY24,PRDTDEBT,PRDTSCAN,PRDTINVN,PRDTTRAN
          PACK      KEY32,PRDTDEBT,PRDTSCAN,PRDTINVN,PRDTTRAN,SP70
          CALL      RSPRFCI1
GCCR1000  CALL      RKPRFCI1
          BRANCH    OVRCD,GCCR9999
          PACK      KEY24A,PRFCDEBT,PRFCSCAN,PRFCINVN,PRFCTRAN
          MATCH     KEY24,KEY24A
          GOTO      GCCR9999 IF NOT EQUAL
          ADD       PRFCCAMT,TOTAMT
          ADD       PRFCCGST,TOTGST
          GOTO      GCCR1000
GCCR9999  RETURN
.----------------------------------------------------------------
.         Write record to prifciaf (fully credited invoice file)
.----------------------------------------------------------------
WRFCI000  MOVE      PRDTDEBT,PRFCDEBT
          MOVE      PRDTSCAN,PRFCSCAN
          MOVE      PRDTUNIQ,PRFCUNIQ
          MOVE      PRDTINVN,PRFCINVN
          MOVE      PRDTTRAN,PRFCTRAN
.
          MOVE      CREDNUMB,PRFCCRNO       * credit note number
          PACK      PRFCCRDT,CCC,CYY,CMM,CDD
          REP       " 0",PRFCCRDT
.
          MOVE      PRDTAMNT,PRFCIAMT     * Invoice Total amount
.
          MOVE      PRDTSDAT,PRFCTRDT     * Transaction Date  
          MOVE      PRDTSTIM,PRFCTRTM     * Transaction Time  
.
          MOVE      PRDTDESC,PRFCDESC      * Description
          MOVE      PRDTPRAC,PRFCMPRA      * Medical Practice
          MOVE      PRDTDOCT,PRFCSDOC      * Service Doctor
          MOVE      PRDTSERV,PRFCNUMS      * Number of Services
          MOVE      PRDTREFD,PRFCRDOC      * Referring Doctor
          MOVE      PRDTREFT,PRFCRDET      * Referring Details
.
          MOVE      PRDTCLAM,PRFCCLMC      * Claim Code
          MOVE      PRDTCODE,PRFCPIND      * Patient Indicator
          MOVE      PRDTMESS,PRFCMSGC      * Message Code
          MOVE      PRDTRTYP,PRFCRTYP      * Record Type 
          MOVE      PRDTIFLG,PRFCIFLG      * Item/Receipt Flag
          MOVE      PRDTITMN,PRFCINUM      * Item Number             
          MOVE      PRDTSUBN,PRFCSUBI      * Sub-Item Number
          MOVE      PRDTSETC,PRFCMSCG      * Miscellaneous Group
.
          MOVE      PRDTBATC,PRFCBNUM      * Batch Number
          MOVE      PRDTUDF1,PRFCUDF1      * User Defined Field 1
          MOVE      PRDTUDF2,PRFCUDF2      * User Defined Field 2
          MOVE      PRDTUDF3,PRFCUDF3      * User Defined Field 3
          MOVE      PRDTUDF4,PRFCUDF4      * User Defined Field 4
.
          MOVE      PRDTADMN,PRFCADMC      * Admission Code         
          MOVE      PRDTRDTE,PRFCRDAT      * Referral Date          
          MOVE      PRDTIAMT,PRFCITAM      * Item Amount
          MOVE      PRDTOPS,PRFCOPCD       * Operation Codes       
          MOVE      PRDTMFLG,PRFCMSFL      * Multiple Service Code Flag
          MOVE      PRDTGLT,PRFCTRFR       * Transterred to G/L        
          MOVE      PRDTMEDA,PRFCMAFN      * Medicare Assign Form Number
          MOVE      PRDTGSTA,PRFCGSTA      * GST Applicable            
          MOVE      PRDTGSTC,PRFCGSTC      * GST Code
          MOVE      PRDTGSTM,PRFCGAMT      * GST Code
          MOVE      PRDTRFPD,PRFCRPRD      * Referral Period             
.
          MOVE      WBSEUID,PRFCWUID     * WEB user
          PACK      PRFCUPDT,CCC,CYY,CMM,CDD
          REP       " 0",PRFCUPDT
          PACK      PRFCSPAR,SP70
.
          PACK      KEY30,PRFCDEBT,PRFCSCAN,PRFCINVN,PRFCTRAN,PRFCCRNO
          CALL      WRPRFCI1
.
WRFCI999  RETURN
+
.----------------------------------------------------------------
.         Write record to prihtraf (Holding Table for Billing Transactions)
.----------------------------------------------------------------
WRHTR000  CALL      GTRN0000
          CALL      CLPRIHTR
          MOVE      PRDTUNIQ,PRHTUNIQ
          MOVE      PRDTPRAC,PRHTPRAC
          MOVE      PRDTDOCT,PRHTDOCT
          MOVE      PRDTCODE,PRHTPIND
          MOVE      PRDTREFD,PRHTREFD
          MOVE      PRDTIFLG,PRHTFLAG
          MOVE      PRDTITMN,PRHTITMN
          MOVE      PRDTSUBN,PRHTSUBN
          MOVE      TRANSNO,PRHTNUMB
          MOVE      PRDTSDAT,PRHTDATE
          MOVE      PRDTSTIM,PRHTTIME
          MOVE      PRDTSERV,PRHTSERN
          MOVE      PRDTDESC,PRHTIDES
          MOVE      PRDTIAMT,PRHTIAMT
          MOVE      PRDTPFLG,PRHTPFLG
          MOVE      PRDTS4B3,PRHTS4B3
.
          MOVE      PRDTMEDA,PRHTMEDA
          MOVE      PRDTRDTE,PRHTRDAT
          MOVE      PRDTREFT,PRHTREFT
          MOVE      PRDTGSTA,PRHTGSTA
          MOVE      PRDTGSTC,PRHTGSTC
          MOVE      PRDTRFPD,PRHTRFPD
          MOVE      PRDTREFN,PRHTREFN
          MOVE      PRDTENCN,PRHTENCN
          MOVE      PRDTACOI,PRHTACOI     * After Care Override Indicator
          MOVE      PRDTTDUR,PRHTTDUR     * Time Duration (mins)
          MOVE      PRDTROVR,PRHTROVR     * Referral Override (Cat ro)
          MOVE      PRDTMPOV,PRHTMPOV     * Multi Procedure Override
          MOVE      PRDTDSOV,PRHTDSOV     * Duplicate Service Override
          MOVE      PRDTSTXT,PRHTSTXT     * Service Text
          MOVE      PRDTASPF,PRHTASPF     * Claim Code Indicator
          MOVE      PRDTASPC,PRHTASPC     * Alternate Service Provider HCP Code
          MOVE      PRDTAICF,PRHTAICF
          MOVE      PRDTAICV,PRHTAICV     * Alternate IFC Issue Code Value
          MOVE      PRDTNMPT,PRHTNMPT     * Number of Patients
          MOVE      PRDTLSPN,PRHTLSPN     * Location Specific Practice No. Value
          MOVE      PRDTSDCD,PRHTSDCD     * Self Deem Code (Cat Sd)
          MOVE      PRDTLVIS,PRHTLVIS     * Linked Visit Number
          MOVE      PRDTHOSI,PRHTHOSI     * Hospital Indicator
          MOVE      PRDTROVC,PRHTROVC     * Restrictive Override Code (Cat Ro)
          MOVE      SP70,PRHTHICI
.
          PACK      KEY62,PRHTUNIQ,PRHTPRAC,PRHTDOCT,PRHTPIND,PRHTREFD,PRHTRDAT:
                          PRHTFLAG,PRHTITMN,PRHTSUBN,PRHTNUMB,SP70
          CALL      WRPRHT1
.
          PACK      KEY27,PRHTUNIQ,PRHTPRAC,PRHTDOCT,PRHTPIND,SP70
          CALL      RDPRHR1
          BRANCH    OVRCD,WRHTR999
.
          COMPARE   ONE,PRHRPINV          * Check status To be Invoiced
          GOTO      WRHTR999 IF EQUAL
.
          MOVE      ONE,PRHRPINV          * Change status To be Invoiced
          CALL      UPPRHR1
.
WRHTR999  RETURN
+
.**********************************************************************
.      Get last transaction number
.**********************************************************************
GTRN0000  MOVE      ZERO,TRANSNO
          IF        PRCNRDOC = 1
            PACK      KEY62,PRDTUNIQ,PRDTPRAC,PRDTDOCT,PRDTCODE,PRDTREFD:
                            PRDTRDTE,Z70
          ELSE
            PACK      KEY62,PRDTUNIQ,PRDTPRAC,PRDTDOCT,PRDTCODE,Z70
          ENDIF
          CALL      RSPRHT3                      * position in trans. file
          CALL      RPPRHT3                      * read trans. record
          BRANCH    OVRCD,GTRN9000               * end of file
.
          COMPARE   PRDTUNIQ,PRHTUNIQ            * same unique identifier ?
          GOTO      GTRN9000 IF NOT EQUAL        * no
.
          MATCH     PRDTPRAC,PRHTPRAC            * same medical practice ?
          GOTO      GTRN9000 IF NOT EQUAL        * no
.
          MATCH     PRDTDOCT,PRHTDOCT            * same service doctor ?
          GOTO      GTRN9000 IF NOT EQUAL        * no
.
          MATCH     PRDTCODE,PRHTPIND            * same patient indicator ?
          GOTO      GTRN9000 IF NOT EQUAL        * no
.
          IF        PRCNRDOC = 1
             MATCH     PRDTREFD,PRHTREFD         * same referring doctor ?
             GOTO      GTRN9000 IF NOT EQUAL     * no
             MATCH     PRDTRDTE,PRHTRDAT         * same referral date?
             GOTO      GTRN9000 IF NOT EQUAL     * no
          ENDIF
          MOVE      PRHTNUMB,TRANSNO
.
GTRN9000  ADD       ONE,TRANSNO                  * next available trans no
GTRN9999  RETURN
+
.----------------------------------------------------------------
.         Update patfinsf (financial file)
.----------------------------------------------------------------
UPPFIN00  PACK      FSTDATE,CCC,CYY,CMM,CDD
          REP       " 0",FSTDATE
          MOVE      ANSA,PRFNTYPE
.
          IF        PRCNAFEE=0
            PACK      PRFNCODE,ANSN,PRDTSETC,PRDTIFLG,PRDTITMN,PRDTSUBN,SP20
.                               Item Group, Item Flag, Item Code, Subitem code
          ELSE
            PACK      PRFNCODE,ANSN,PRDTDOCT,PRDTSETC,PRDTIFLG,PRDTITMN,PRDTSUBN
          ENDIF
.
          MOVE      PRDTPRAC,PRFNMPRA
          MOVE      PRDTIAMT,FSTAMNT
          MULT      "-1",FSTAMNT
          MOVE      ZERO,FGSTFLAG
          CALL      PRICALFS
.
          IF        IBCNUGST=2 & PRDTGSTM<>0
            MOVE      PRDTGSTM,FSTAMNT    
            MULT      "-1",FSTAMNT
            MOVE      ONE,FGSTFLAG
            CALL      PRICALFS
          ENDIF
.
UPPFIN99  RETURN
+
.----------------------------------------------------------------
.         Check if it's now fully credited
.----------------------------------------------------------------
CCRD0000  MOVE      ZERO,EXIT
          MOVE      TOTAMT,FORM82
          PACK      KEY16,PRINNUMB,SP20
          CALL      RSPRCNO3
CCRD1000  CALL      RKPRCNO3
          BRANCH    OVRCD,CCRD8000
          MATCH     PRINNUMB,PRCOINVN        * same invoice number?
          GOTO      CCRD8000 IF NOT EQUAL
          ADD       PRCOAMNT,FORM82        * add up the credit amount
          GOTO      CCRD1000
CCRD8000  MULT      "-1",FORM82            * total of credit amount is negative
          COMPARE   FORM82,PRINITOT
          GOTO      CCRD9999 IF NOT EQUAL
          MOVE      ONE,EXIT               * Fully credited
CCRD9999  RETURN
+
.------------------------------------------------------------
. Debtors Maintenance: Display,Add,Update,Delete
.------------------------------------------------------------
...PRIDBT00  MOVE      ZERO,EXIT
...          RESET     UPDTTYPE
...          MATCH     SP1,UPDTTYPE
...          GOTO      PRIDBT40 IF EQUAL
.
...          MATCH     "A",UPDTTYPE    * Add formaction
...          GOTO      PRIDBT10 IF EQUAL
.
...          MATCH     "U",UPDTTYPE    * Update formaction
...          GOTO      PRIDBT20 IF EQUAL
.
...          MATCH     "D",UPDTTYPE    * Delete formaction
...          GOTO      PRIDBT30 IF EQUAL
.
...          GOTO      PRIDBT93
.
.         ************ ADD FORMACTION ***********
.
...PRIDBT10  CALL      GENDB000      * get new debtor number
...          BRANCH    EXIT,PRIDBT99
. 
...          PACK      KEY8,URNUMBER,SP70
...          CALL      RDPRDB1
...          COMPARE   ZERO,OVRCD
...          GOTO      PRIDBT92 IF EQUAL
.
...          MOVE      URNUMBER,PRDBDEBT
...          CALL      MVPRDB00      * Moves input variables to file variables
.
...          CALL      WRPRDB1       * Writes away the data
.
...          MOVE      ZERO,EXIT
...          GOTO      PRIDBT99
.
.         ************ UPDATE FORMACTION **********
.
...PRIDBT20  PACK      KEY8,URNUMBER,SP70   
...          CALL      RDPRDB1
...          BRANCH    OVRCD,PRIDBT91
...
...          CALL      MVPRDB00      * Moves input variables to file variables
...          CALL      UPPRDB1       * Writes away the data
.
...          MOVE      ZERO,EXIT
...          GOTO      PRIDBT99
.
.         ************ DELETE FORMACTION **********
.
...PRIDBT30  PACK      KEY8,URNUMBER,SP70   
...          CALL      RDPRDB1
...          BRANCH    OVRCD,PRIDBT91
.
...          CALL      DEPRDB1
.
...          MOVE      ZERO,EXIT
...          GOTO      PRIDBT99
.
.         ************ DISPLAY FORMACTION **********
.
...PRIDBT40  PACK      KEY8,URNUMBER,SP70
...          CALL      RDPRDB1
...          IF        OVRCD=1
...            CALL      CLDB0000    * Clear all the file variables
...          ENDIF
.
...          CALL      CLPATMAS
.
...          MOVE      PRDBDEBT,PURNO
...          MOVE      PRDBSNAM,PSNAME
...          MOVE      PRDBGNAM,PGNAME
...          MOVE      PRDBTITL,PTITL
...          MOVE      PRDBDOBH,PBDATE
.
...          CLEAR     WEBTITLE
...          MOVE      "PP Debtors Maintenance",WEBTITLE
...          RESET     WEBTITLE
.
...          CALL      WEBHED00   * Create Output File and Write HTML Page Header
...          BRANCH    EXIT,PRIDBT99
...          CALL      WEBBOD00   * Process Web Body
...          CALL      WEBEND00   * Process End of HTML File
...          MOVE      ONE,EXIT
...          GOTO      PRIDBT99
.
...PRIDBT91  MOVE      "PP Debtor Master file record does not exist",WEBTITLE
...          CALL      WEBERR00
...          MOVE      ONE,EXIT
...          GOTO      PRIDBT99
.
...PRIDBT92  MOVE      "PP Debtor Master file record exists",WEBTITLE
...          CALL      WEBERR00
...          MOVE      ONE,EXIT
...          GOTO      PRIDBT99
.
...PRIDBT93  MOVE      "Invalid Form Action.",WEBTITLE
...          CALL      WEBERR00
...          MOVE      ONE,EXIT
...          GOTO      PRIDBT99
.
...PRIDBT99  RETURN
.-------------------------------------------------------------------------------
. Check new debtor number
.-------------------------------------------------------------------------------
...GENDB000  MOVE      ZERO,EXIT
...          BRANCH    PRCNAUTO,GENDB100
...          GOTO      GENDB500
.
...GENDB100  READ      CONTROLF,THIRTY3;*116,PRCNDETN
.
...GENDB200  PACK      KEY8,PRCNDETN                * check number not on file
...          CALL      RDPRDB1
...          IF        OVRCD<>1
...            ADD       ONE,PRCNDETN
...            GOTO      GENDB200
...          ENDIF
.
...          PACK      KEY8,PRCNDETN
...          CALL      RDMAST1
...          BRANCH    OVRCD,GENDB300
...          ADD       ONE,PRCNDETN
...          GOTO      GENDB200
.
...GENDB300  MOVE      PRCNDETN,URNUMBER
...          ADD       ONE,PRCNDETN
...          WRITAB    CONTROLF,THIRTY3;*116,PRCNDETN
...          GOTO      GENDB900
.
...GENDB500  PACK      KEY8,URNUMBER,SP70
...          CALL      RDMAST1
...          BRANCH    OVRCD,GENDB900
.
...          MOVE      "Invalid Debtor Number (PMI record already exists)",WEBTITLE
...          CALL      WEBERR00
...          MOVE      ONE,EXIT
...          GOTO      GENDB999
.
...GENDB900  REP       " +",URNUMBER
...          ENDSET    REDIRECT
...          APPEND    "&urnumber=",REDIRECT
...          APPEND    URNUMBER,REDIRECT
...          RESET     REDIRECT
...          SQUEEZE   REDIRECT
...          REP       "+ ",URNUMBER
.
...GENDB999  RETURN
.-------------------------------------------------------------------------------
. Process Fields called from WEBBOD00 
.-------------------------------------------------------------------------------
PROFLD00  BRANCH    REPORTNO,PROFLD10,PROFLD20,PROFLD30,PROFLD40,PROFLD50:
                             PROFLD60
          GOTO      PROFLD99
.
...PROFLD10  BRANCH    FLDSETNO,PROFLD11,PROFLD12,PROFLD13
...          GOTO      PROFLD99
.
...PROFLD11  CALL      MASF0000       * PMI Master file
...          GOTO      PROFLD99
.
...PROFLD12  CALL      PRDB0000       * PP Debtors Master file
...          GOTO      PROFLD99
.
...PROFLD13  CALL      MISC0000       * Miscellaneous
...          GOTO      PROFLD99
.
PROFLD10  BRANCH    FLDSETNO,PROFLD11,PROFLD12
          GOTO      PROFLD99
.
PROFLD11  CALL      PRMP0000
          GOTO      PROFLD99
.
PROFLD12  CALL      PRBL0000
          GOTO      PROFLD99
.
PROFLD20  BRANCH    FLDSETNO,PROFLD21,PROFLD22
          GOTO      PROFLD99
.
PROFLD21  CALL      PRMP0000
          GOTO      PROFLD99
.
PROFLD22  CALL      PRSD0000
          GOTO      PROFLD99
.
PROFLD30  BRANCH    FLDSETNO,PROFLD31,PROFLD32
          GOTO      PROFLD99
.
PROFLD31  CALL      MASF0000       * PMI Master file
          GOTO      PROFLD99
.
PROFLD32  CALL      PRBL0000      
          GOTO      PROFLD99
.
PROFLD40  BRANCH    FLDSETNO,PROFLD41,PROFLD42
          GOTO      PROFLD99
.
PROFLD41  CALL      MASF0000       * PMI Master file
          GOTO      PROFLD99
.
PROFLD42  CALL      PRCN0000
          GOTO      PROFLD99
.
PROFLD50  BRANCH    FLDSETNO,PROFLD51,PROFLD52,PROFLD53
          GOTO      PROFLD99
.
PROFLD51  CALL      PRMP0000
          GOTO      PROFLD99
.
PROFLD52  CALL      PRBL0000
          GOTO      PROFLD99
.
PROFLD53  CALL      INVP0000       * Private Practice Invoice Pending
          GOTO      PROFLD99
.
PROFLD60  BRANCH    FLDSETNO,PROFLD61,PROFLD62,PROFLD63
          GOTO      PROFLD99
.
PROFLD61  CALL      MASF0000       * PMI Master file
          GOTO      PROFLD99
.
PROFLD62  CALL      PRMP0000
          GOTO      PROFLD99
.
PROFLD63  CALL      RCPP0000                * Receipts Processing
          GOTO      PROFLD99
.
PROFLD99  RETURN
.-----------------------------------------------------------
. Option 1 - Medical Practice Enquiry
.-----------------------------------------------------------
PRMP0000  BRANCH    FLDITMNO,PRMP0100,PRMP0200,PRMP0300,PRMP0400,PRMP0500:
                             PRMP0600,PRMP0700,PRMP0800,PRMP0900,PRMP1000:
                             PRMP1100,PRMP1200,PRMP1300,PRMP1400,PRMP1500:
                             PRMP1600
          GOTO      PRMP9999
.
PRMP0100  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          BRANCH    F1,PRMP0110,PRMP0120
.
          WRITE     HTMLFILE;PRIDC001;
          GOTO      PRMP9999
.
PRMP0110  PACK      KEY6,PRIDC001,SP70  * Read Medical Practice Record
          CALL      RDPRPR1
          IF        OVRCD=1
            MOVE      PRDOPRAC,PRPRDESC
          ENDIF
          WRITE     HTMLFILE;PRPRDESC;
          GOTO      PRMP9999
.
PRMP0120  MOVE      PRIDC001,PRACTICE  * Medical Practice Code
          CALL      MPRSEL00
          GOTO      PRMP9999
.
PRMP0200  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          BRANCH    F1,PRMP0210,PRMP0220
. 
          WRITE     HTMLFILE;PRIDC002;   
          GOTO      PRMP9999
.
PRMP0210  PACK      KEY10,PRIDC002,SP70   * Associated Doctor
          CALL      RDPMHCP1
          IF        OVRCD = 0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
            CLEAR     DOCTOR
            APPEND    DOCFNAME,DOCTOR
          ELSE
            MOVE      PRIDC002,DOCTOR
          ENDIF
          WRITE     HTMLFILE;DOCTOR;
          GOTO      PRMP9999
.
PRMP0220  PACK      DOCTCODE,PRIDC002,SP70
          PACK      PRIDC001,PRIDC001,SP70
          CALL      SELPPD00     * Private Practice Doctors
          GOTO      PRMP9999
.
PRMP0300  CALL      PDCTB000     * Table of Medical Practice Doctors
          GOTO      PRMP9999
.
PRMP0400  CALL      NEXTPR00     * Link to Next Set of Medical Details
          GOTO      PRMP9999
.
PRMP0500  CALL      PREVPR00     * Link to Prev Set of Medical Details
          GOTO      PRMP9999
.
PRMP0600  CALL      SCHFEE00     * Display Table of Schedule Fee's
          GOTO      PRMP9999
.
PRMP0700  WRITE     HTMLFILE;PRDOCOMM;
          GOTO      PRMP9999
.
PRMP0800  IF        PRDOSTAT=1
            WRITE     HTMLFILE;"Inactive";
          ELSE
            WRITE     HTMLFILE;"Active";
          ENDIF
          GOTO      PRMP9999
.
PRMP0900  MATCH     SP70,PRDOCRCD
          GOTO      PRMP9999 IF EQUAL
.
          COMPARE   TWO,IBCNUGST
          GOTO      PRMP9999 IF NOT EQUAL
          COMPARE   ONE,PRCNDAPS
          GOTO      PRMP9999 IF NOT EQUAL
.
          MOVE      PRDOCRCD,KEY5
          CALL      RDAPMA1
          IF        OVRCD=1
            MOVE      PRDOCRCD,APMACN1
          ENDIF
          WRITE     HTMLFILE;APMACN1;
          GOTO      PRMP9999
.          
PRMP1000  COMPARE   TWO,IBCNUGST
          GOTO      PRMP9999 IF NOT EQUAL
          WRITE     HTMLFILE;PRDOABNN;
          GOTO      PRMP9999
.
PRMP1100  COMPARE   TWO,IBCNUGST
          GOTO      PRMP9999 IF NOT EQUAL
          IF        PRDOGSTR=1
            WRITE     HTMLFILE;"Yes";
          ELSE
            WRITE     HTMLFILE;"No";
          ENDIF
          GOTO      PRMP9999
.
PRMP1200  WRITE     HTMLFILE;IBCNUGST;
          GOTO      PRMP9999
.
PRMP1300  WRITE     HTMLFILE;PRCNDAPS;
          GOTO      PRMP9999
.
PRMP1400  MOVE      ZERO,DISPFLAG
          MATCH     "2",PRIDC004
          GOTO      PRMP1410 IF EQUAL
.
          CALL      BILL0000     * Invoiced Finance Table 
          GOTO      PRMP9999
.
PRMP1410  CALL      TBIN0000     * To be Invoiced Table
          GOTO      PRMP9999
.
PRMP1500  WRITE     HTMLFILE;PRIDC003;
          GOTO      PRMP9999
.
PRMP1600  WRITE     HTMLFILE;PRIDC004;
          GOTO      PRMP9999
.
PRMP9999  RETURN
+
.-----------------------------------------------------------
. Option 2 - Service Doctor Enquiry
.-----------------------------------------------------------
PRSD0000  BRANCH    FLDITMNO,PRSD0100,PRSD0200,PRSD0300,PRSD0400
          GOTO      PRSD9999
.
PRSD0100  CALL      PMPTB000     * Table of Medical Practice Doctors
          GOTO      PRSD9999
.
PRSD0200  CALL      NEXTPR00     * Link to Next Set of Medical Details
          GOTO      PRSD9999
.
PRSD0300  CALL      PREVPR00     * Link to Prev Set of Medical Details
          GOTO      PRSD9999
.
PRSD0400  MOVE      ONE,DISPFLAG
          MATCH     "2",PRIDC004
          GOTO      PRSD0410 IF EQUAL
.
          CALL      BILL0000     * Invoiced Finance Table
          GOTO      PRSD9999
.
PRSD0410  CALL      TBIN0000     * To be Invoiced Table
          GOTO      PRSD9999
.
PRSD9999  RETURN
.------------------------------------------------------------
.  Outputs a selection list of Medical Practices
.----------------------------------------------------------------
MPRSEL00  PACK      KEY6,SP70
          CALL      RSPRPR1
MPRSEL10  CALL      RKPRPR1
          BRANCH    OVRCD,MPRSEL99
.
          MATCH     PRACTICE,PRPRCODE    * Default Medical Records Location
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",PRPRCODE,"#" selected>":
                                 "(",PRPRCODE,") ",PRPRDESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"",PRPRCODE,"#">":
                                 "(",PRPRCODE,") ",PRPRDESC,"</option>"
          ENDIF
.
          GOTO    MPRSEL10
.
MPRSEL99  RETURN
+
.------------------------------------------------------------
. Private Practice Doctors within Practice
.------------------------------------------------------------
SELPPD00  PACK      FIRST12,SP70
          PACK      PRIDC001,PRIDC001,SP70
.
          PACK      KEY10,USERID,SP70
          CALL      RDPRALS1
          COMPARE   ZERO,OVRCD
          GOTO      SELPPD06 IF EQUAL       * User has access to all Med.Prac.
.
.         Check if user has only one Medical practice access
.
          MOVE      ZERO,F1
          MOVE      SP70,KEY6
          PACK      KEY16,USERID,SP70
          CALL      RSPRSEC2
SELPPD02  CALL      RKPRSEC2
          BRANCH    EXIT,SELPPD04
.
          MATCH     USERID,PRSEUSID
          GOTO      SELPPD04 IF NOT EQUAL    * different user id
.
          ADD       ONE,F1
          IF        F1=1
            MOVE      PRSEPRAC,KEY6          * save medical practice
            GOTO      SELPPD02
          ENDIF
.
SELPPD04  COMPARE   ZERO,F1
          GOTO      SELPPD99 IF EQUAL        * No medical practice access
.
          MATCH     SP70,PRIDC001
          IF        @EQUAL
            IF        F1=1
              MOVE      KEY6,PRIDC001        * only access one medical practice
            ENDIF
          ENDIF
.
SELPPD06  PACK      KEY22,SP70
          CALL      RSPRDO2
SELPPD10  CALL      RKPRDO2
          BRANCH    OVRCD,SELPPD99
.
          MATCH     SP10,PRDODOCT
          GOTO      SELPPD10 IF EQUAL
.
          MATCH     SP70,FIRST12
          GOTO      SELPPD20 IF NOT EQUAL
.
          GOTO      SELPPD30
.
SELPPD20  PACK      TEST12,PRDODOCT,SP70
          MATCH     FIRST12,TEST12
          GOTO      SELPPD10 IF EQUAL
.
SELPPD30  MATCH     SP70,PRIDC001
          IF        !@EQUAL
            MATCH     PRDOPRAC,PRIDC001
            GOTO      SELPPD10 IF NOT EQUAL
          ELSE
            PACK      KEY10,USERID,SP70
            CALL      RDPRALS1
            IF        OVRCD=1
              PACK      KEY16,PRDOPRAC,USERID
              CALL      RDPRSECA1
              BRANCH    OVRCD,SELPPD10           * no access
            ENDIF
          ENDIF
.
          PACK      FIRST12,PRDODOCT,SP70
          MOVE      SP25,KEY25
          MOVE      PRDODOCT,DCODE
          PACK      KEY10,PRDODOCT,SP10
          CALL      RDPMHCP1
          BRANCH    OVRCD,SELPPD40
.
          MOVE      "1",PACFRMT
          MOVE      PMHCTITL,PACTITLE
          MOVE      PMHCSNAM,PACSNAME
          MOVE      PMHCGNAM,PACGNAME
          CALL      PACNAME
          MOVE      PACFNAME,KEY25
.
SELPPD40  PACK      KEY14,QUOTE,PRDODOCT,QUOTE
.
          MATCH     DOCTCODE,PRDODOCT
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY14," selected>":
                      "(",PRDODOCT,") ",KEY25,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY14,">":
                      "(",PRDODOCT,") ",KEY25,"</option>"
          ENDIF
.
          GOTO      SELPPD10
.
SELPPD99  RETURN
.
.------------------------------------------------------------
. Table of Medical Practice Doctors
.------------------------------------------------------------
PDCTB000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          CALL      DCHED000      * Output Table Heading
.
          IF        NORECORD=0
            MOVE      "13",NORECORD       * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
          MOVE      SP70,DOCTCODE
.
          MATCH     SP70,PRIDC001
          GOTO      PDCTB999 IF EQUAL
.
          PACK      KEY22,PRIDC001,SP70
          CALL      RSPRDO1
PDCTB100  CALL      RKPRDO1
          BRANCH    OVRCD,PDCTB999
.
          MATCH     PRIDC001,PRDOPRAC     * Medical Practice
          GOTO      PDCTB999 IF NOT EQUAL
.
          MATCH     SP70,DOCTCODE
          IF        !@EQUAL
            MATCH     DOCTCODE,PRDODOCT     * Only want One Doctor Record!
            GOTO      PDCTB100 IF EQUAL
          ENDIF
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      PDCTB100
          ENDIF
.
          CALL      PDCRW000      * Display Doctors Table Details Row
          MOVE      PRDODOCT,DOCTCODE
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      PDCTB100 IF NOT EQUAL
.
PDCTB999  RETURN
.------------------------------------------------------------
. Medical Practice Doctors Table Details (TABLE HEADING)
.------------------------------------------------------------
DCHED000  PACK      KEY6,PRIDC001,SP70  * Read Medical Practice Record
          CALL      RDPRPR1
          IF        OVRCD=1
            MOVE      PRIDC001,PRPRDESC
          ENDIF
.
          WRITE     HTMLFILE;"<tr>":
                               "<td class=HeadingCell colspan=3 align=center>":
                               "Doctors for ",PRPRDESC,"</td>":
                               "</tr><tr>":
                               "<td class=HeadingCell width=50%>":
                               "Doctors</td>":
                               "<td class=HeadingCell width=25% align=right>":
                               "Commission</td>":
                               "<td class=HeadingCell width=25%>":
                               "&nbsp;Status</td>":
                             "</tr>"
.
DCHED999  RETURN
.------------------------------------------------------------
. Medical Practice Doctors Table (TABLE ROW)
.------------------------------------------------------------
PDCRW000  PACK      KEY10,PRDODOCT,SP70   * Associated Doctor
          CALL      RDPMHCP1
          IF        OVRCD = 0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
            CLEAR     DOCTOR
            APPEND    DOCFNAME,DOCTOR
          ELSE
            MOVE      PRDODOCT,DOCTOR
          ENDIF
.
          COMPARE   ZERO,PRDOSTAT
          IF        @EQUAL
            MOVE      "Active",KEY8
          ELSE
            MOVE      "Inactive",KEY8
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td nowrap><A HREF='javascript:ShowDoctors":
                             "(#"",LINKPRG,"#.pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&pridc001=",PRDOPRAC:
                             "&pridc002=",PRDODOCT:
                             "#")'>":
                             "<img src=../images/MaintenanceIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             DOCTOR,"</td>":
                             "<td align=right>",PRDOCOMM,"%</td>":
                             "<td>&nbsp;",KEY8,"</td>":
                             "</tr>"
.
PDCRW999 RETURN
.--------------------------------------------------------------------
.                            SCHFEE00
. Display Routine - For each Claim Code (Category CL) on file, get out
.                   each patient Indicator Code (Category GI) on file
.                   and write a to HTML Display
.--------------------------------------------------------------------
SCHFEE00  IF        NORECORD=0
            MOVE      "8",NORECORD       * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          PACK      KEY22,PRIDC001,PRIDC002,SP8
          CALL      RSPRDO1
SCHFEE10  CALL      RKPRDO1
          BRANCH    OVRCD,SCHFEE99
.
          MATCH     PRDOPRAC,PRIDC001
          GOTO      SCHFEE99 IF NOT EQUAL
.
          MATCH     PRDODOCT,PRIDC002
          GOTO      SCHFEE99 IF NOT EQUAL
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      SCHFEE10
          ENDIF
.
          CALL      DISCOM00        * Displays Table of Schedule Fee Rows
.
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      SCHFEE10 IF NOT EQUAL    * get next patient indicator code
.
SCHFEE99  RETURN
.-----------------------------------------------------------
.                        DISCOM00
. Displays Claim Code & Patient Indicator Row
.-----------------------------------------------------------
DISCOM00  MOVE      "CL",CATEGORY     * Get Claim Code descirption
          MOVE      PRDOCLAM,CODE
          CALL      GETCOD00
          MATCH     SP70,TDESC
          IF        @EQUAL
            MOVE      PRDOCLAM,KEY30
          ELSE
            MOVE      TDESC,KEY30
          ENDIF
.
          MOVE      "GI",CATEGORY     * Get Patient Indicator Description
          MOVE      PRDOPIND,CODE
          CALL      GETCOD00
          MATCH     SP70,TDESC
          IF        @EQUAL
            MOVE      PRDOPIND,TDESC
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td>",KEY30,"</td>":
                             "<td>",TDESC,"</td>":
                             "<td align=right>",PRDOFEEP,"%</td>":
                             "</tr>"
.
DISCOM99  RETURN
.-----------------------------------------------------------
. Link to Next List Page
.-----------------------------------------------------------
NEXTPR00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
.
          REP       " +",PRIDC001
          REP       " +",PRIDC002
.
          WRITE     HTMLFILE;"priweb04.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&pridc001=",PRIDC001:
                                 "&pridc002=",PRIDC002;
.
          REP       "+ ",PRIDC001
          REP       "+ ",PRIDC002
.
NEXTPR99  RETURN
.-----------------------------------------------------------
. Link to Prev List Page
.-----------------------------------------------------------
PREVPR00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM-NORECORD,F3
          IF        F3<0
            MOVE      ZERO,F3
          ENDIF
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
.
          REP       " +",PRIDC001
          REP       " +",PRIDC002
.
          WRITE     HTMLFILE;"priweb04.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&pridc001=",PRIDC001:
                                 "&pridc002=",PRIDC002;
.
          REP       "+ ",PRIDC001
          REP       "+ ",PRIDC002
.
PREVPR99  RETURN
+
.-----------------------------------------------------------
. Medical Practice Finance Table
.-----------------------------------------------------------
BILL0000  BRANCH    DISPFLAG,BILL0100
.
.   Medical Practice Enquiry
.
          MATCH     SP70,PRIDC001          
          GOTO      BILL9999 IF EQUAL
          MATCH     SP70,PRIDC003
          GOTO      BILL9999 IF EQUAL
          GOTO      BILL0500
.
.   Service Doctor Enquiry
.
BILL0100  MATCH     SP70,PRIDC002          
          GOTO      BILL9999 IF EQUAL
          MATCH     SP70,PRIDC003
          GOTO      BILL9999 IF EQUAL
          GOTO      BILL0500
.
.   Both Options
.
BILL0500  CALL      CLRV0000                * clear the variables
          CALL      OBAL0000                * calculate opening balance
          MOVE      OPENBAL,BALANCE
.
          BRANCH    DISPFLAG,BILL2000
.
.   Medical Practice Enquiry
.
          PACK      KEY20,PRIDC003,PRIDC001,SP20  
          CALL      RSPRST1
BILL1000  CALL      RKPRST1
          BRANCH    OVRCD,BILL5000
.
          MATCH     PRIDC003,PRSTYEAR        * match financial years
          GOTO      BILL5000 IF NOT EQUAL
.
          MATCH     PRIDC001,PRSTPRAC       * match medical practice codes
          GOTO      BILL5000 IF NOT EQUAL
          GOTO      BILL3000
.
.   Service Doctor Enquiry
.
BILL2000  PACK      KEY20,PRIDC003,PRIDC002,PRIDC001,SP20
          CALL      RDPRST2
          BRANCH    OVRCD,BILL2100
          GOTO      BILL3000
.
BILL2100  CALL      RKPRST2
          BRANCH    OVRCD,BILL5000
.
          MATCH     PRIDC003,PRSTYEAR        * match financial years
          GOTO      BILL5000 IF NOT EQUAL
.
          MATCH     PRIDC002,PRSTDOCT       * match service doctor codes
          GOTO      BILL5000 IF NOT EQUAL
.
          MATCH     SP6,PRIDC001            * display all medical practice
          GOTO      BILL3000 IF EQUAL
.
          MATCH     PRIDC001,PRSTPRAC       * match medical practice codes
          GOTO      BILL5000 IF NOT EQUAL
          GOTO      BILL3000
.
.   Both Options
.
BILL3000  ADD       PRSTIP01,INVTOT1
          ADD       PRSTIP02,INVTOT2
          ADD       PRSTIP03,INVTOT3
          ADD       PRSTIP04,INVTOT4
          ADD       PRSTIP05,INVTOT5
          ADD       PRSTIP06,INVTOT6
          ADD       PRSTIP07,INVTOT7
          ADD       PRSTIP08,INVTOT8
          ADD       PRSTIP09,INVTOT9
          ADD       PRSTIP10,INVTOT10
          ADD       PRSTIP11,INVTOT11
          ADD       PRSTIP12,INVTOT12
          ADD       PRSTIP13,INVTOT13
.
          SUB       PRSTCP01,CASHTOT1
          SUB       PRSTCP02,CASHTOT2
          SUB       PRSTCP03,CASHTOT3
          SUB       PRSTCP04,CASHTOT4
          SUB       PRSTCP05,CASHTOT5
          SUB       PRSTCP06,CASHTOT6
          SUB       PRSTCP07,CASHTOT7
          SUB       PRSTCP08,CASHTOT8
          SUB       PRSTCP09,CASHTOT9
          SUB       PRSTCP10,CASTOT10
          SUB       PRSTCP11,CASTOT11
          SUB       PRSTCP12,CASTOT12
          SUB       PRSTCP13,CASTOT13
.
          ADD       PRSTJP01,JOURTOT1
          ADD       PRSTJP02,JOURTOT2
          ADD       PRSTJP03,JOURTOT3
          ADD       PRSTJP04,JOURTOT4
          ADD       PRSTJP05,JOURTOT5
          ADD       PRSTJP06,JOURTOT6
          ADD       PRSTJP07,JOURTOT7
          ADD       PRSTJP08,JOURTOT8
          ADD       PRSTJP09,JOURTOT9
          ADD       PRSTJP10,JORTOT10
          ADD       PRSTJP11,JORTOT11
          ADD       PRSTJP12,JORTOT12
          ADD       PRSTJP13,JORTOT13
.
          BRANCH    DISPFLAG,BILL2100
          GOTO      BILL1000
.
.------ display header details if not doing the print option ------
.
BILL5000  WRITE     HTMLFILE;"<tr><td class=HeadingCell colspan=4 ":
                             "align=center>Financial Details for ":
                             PRIDC003,"</td>":
                             "<td class=HeadingCell align=right width=25%>":
                             "Balance</td></tr>":
                             "<tr><td class=HeadingCell width=30%>":
                             "Month</td>":
                             "<td class=HeadingCell align=right width=15%>":
                             "Invoice</td>":
                             "<td class=HeadingCell align=right width=15%>":
                             "Cash</td>":
                             "<td class=HeadingCell align=right width=15%>":
                             "Journals</td>":
                             "<td class=HeadingCell align=right>Opening":
                             "&nbsp;&nbsp;&nbsp;$",OPENBAL,"</td>":
                             "</tr>"
.
.------ initialise variables and position on the date range file ------
.
          MOVE      BALANCE,PREVBAL
          MOVE      ONE,COUNTR
          PACK      KEY6,PRIDC003,SP2
          CALL      RDSDRGA1                * position on the date range file
.
.------ read through the date range file ------
.
BILL5100  CALL      RDKDRGA1
          BRANCH    OVRCD,BILL8000
.
          MATCH     PRIDC003,DRGYR           * match financial years
          GOTO      BILL8000 IF NOT EQUAL
.
          COMPARE   ONE,COUNTR              * see if processing first record
          GOTO      BILL5200 IF EQUAL
.
          ADD       INVOICE,BALANCE
          ADD       CASHT,BALANCE
          ADD       JOURNALS,BALANCE
          MOVE      SP20,BALDIM15
.
          COMPARE   BALANCE,PREVBAL         * see if balance is the same as the
          GOTO      BILL5120 IF EQUAL         previous balance
.
          MOVE      BALANCE,BALDIM15
          MOVE      BALANCE,PREVBAL
.
.------ display the current details if not doing the print option ------
.
BILL5120  WRITE     HTMLFILE;"<tr><td>",DESCPERD,"</td>":
                             "<td align=right>$",INVOICE,"</td>":
                             "<td align=right>$",CASHT,"</td>":
                             "<td align=right>$",JOURNALS,"</td>":
                             "<td align=right>$",BALDIM15,"</td>":
                             "</tr>"
.
.------ set up the grand total variables ------
.
          ADD       INVOICE,GNDINV
          ADD       CASHT,GNDCASH
          ADD       JOURNALS,GNDJOUR
.
.------ set up the variables ------
.
BILL5200  LOAD      INVOICE,COUNTR,INVTOT1,INVTOT2,INVTOT3,INVTOT4,INVTOT5:
                                   INVTOT6,INVTOT7,INVTOT8,INVTOT9,INVTOT10:
                                   INVTOT11,INVTOT12,INVTOT13
          LOAD      CASHT,COUNTR,CASHTOT1,CASHTOT2,CASHTOT3,CASHTOT4,CASHTOT5:
                                CASHTOT6,CASHTOT7,CASHTOT8,CASHTOT9,CASTOT10:
                                CASTOT11,CASTOT12,CASTOT13
          LOAD      JOURNALS,COUNTR,JOURTOT1,JOURTOT2,JOURTOT3,JOURTOT4:
                                    JOURTOT5,JOURTOT6,JOURTOT7,JOURTOT8:
                                    JOURTOT9,JORTOT10,JORTOT11,JORTOT12:
                                    JORTOT13
          ADD       ONE,COUNTR
          MOVE      DRGLDSC,DESCPERD
.
          GOTO      BILL5100
.
.------ end of financial year on the date range file ------
.------ so display last record ------
.
BILL8000  ADD       INVOICE,BALANCE
          ADD       CASHT,BALANCE
          ADD       JOURNALS,BALANCE
          MOVE      SP20,BALDIM15
.
          COMPARE   BALANCE,PREVBAL         * see if the balance is the same
          GOTO      BILL8100 IF EQUAL         as the previous balance
.
          MOVE      BALANCE,BALDIM15
.
.------ display last record and grand totals ------
.
BILL8100  WRITE     HTMLFILE;"<tr><td>",DESCPERD,"</td>":
                             "<td align=right>$",INVOICE,"</td>":
                             "<td align=right>$",CASHT,"</td>":
                             "<td align=right>$",JOURNALS,"</td>":
                             "<td align=right>$",BALDIM15,"</td>":
                             "</tr>" 
          ADD       INVOICE,GNDINV
          ADD       CASHT,GNDCASH
          ADD       JOURNALS,GNDJOUR
          WRITE     HTMLFILE;"<tr><td>TOTALS</td>":
                             "<td align=right>$",GNDINV,"</td>":
                             "<td align=right>$",GNDCASH,"</td>":
                             "<td align=right>$",GNDJOUR,"</td>":
                             "<td>&nbsp;</td></tr>":
                             "<tr><td colspan=4>&nbsp;</td>":
                             "<td align=right><b>Closing &nbsp;&nbsp;&nbsp;":
                             "<b>$",BALANCE,"</b></td>":
                             "</tr>"
.
          GOTO      BILL9999
.
BILL9999  RETURN
+
.***************************************************************************
.*                                   CLRV0000                              *
.*          Clear all the variables for the billing details display        *
.***************************************************************************
CLRV0000  MOVE      ONE,COUNTR
.
.------ clear the current variable ------
.
CLRV1000  STORE     ZERO,COUNTR,CASHTOT1,CASHTOT2,CASHTOT3,CASHTOT4,CASHTOT5:
                                CASHTOT6,CASHTOT7,CASHTOT8,CASHTOT9,CASTOT10:
                                CASTOT11,CASTOT12,CASTOT13,GNDCASH,GNDINV:
                                GNDJOUR,INVTOT1,INVTOT2,INVTOT3,INVTOT4:
                                INVTOT5,INVTOT6,INVTOT7,INVTOT8,INVTOT9:
                                INVTOT10,INVTOT11,INVTOT12,INVTOT13,JOURTOT1:
                                JOURTOT2,JOURTOT3,JOURTOT4,JOURTOT5,JOURTOT6:
                                JOURTOT7,JOURTOT8,JOURTOT9,JORTOT10,JORTOT11:
                                JORTOT12,JOURTOT13,BALANCE
.
          ADD       ONE,COUNTR
.
          COMPARE   "44",COUNTR             * see if we have done all of the
          GOTO      CLRV1000 IF NOT EQUAL     variables
.
CLRV9999  RETURN
+
.****************************************************************************
.*                               OBAL0000             Called by: BILL0000   *
.*                    calculate the opening balance                         *
.****************************************************************************
.
OBAL0000  MOVE      ZERO,OPENBAL                 * initialise opening balance
.
          IF        DISPFLAG=1
            PACK      KEY20,PRIDC001,PRIDC002,SP20  * Serv doct enquiry
          ELSE
            PACK      KEY20,PRIDC001,SP20           * Med prac enquiry
          ENDIF
          CALL      RSPRST3                      * position in file
OBAL0500  CALL      RKPRST3                      * read next record
          BRANCH    OVRCD,OBAL9999               * end of file
.
          BRANCH    DISPFLAG,OBAL1000
.
.   Medical Practice Enquiry
.
          MATCH     PRIDC001,PRSTPRAC            * same practice still
          GOTO      OBAL9999 IF NOT EQUAL        * no - finish
.
          MATCH     PRIDC003,PRSTYEAR            * same financial year ?
          GOTO      OBAL0500 IF NOT LESS         * no - finish
          GOTO      OBAL5000
.
.   Service Doctor Enquiry
.
OBAL1000  MATCH     SP6,PRIDC001                 * All practices
          GOTO      OBAL1100 IF EQUAL        
.
          MATCH     PRIDC001,PRSTPRAC            * same practice still
          GOTO      OBAL9999 IF NOT EQUAL        * no - finish
.
OBAL1100  MATCH     SP6,PRIDC001
          IF        @EQUAL
            MATCH     PRIDC002,PRSTDOCT            * same doctor still
            GOTO      OBAL0500 IF NOT EQUAL        * no - finish
            MATCH     PRIDC003,PRSTYEAR            * same financial year ?
            GOTO      OBAL0500 IF NOT LESS         * no - finish
          ELSE
            MATCH     PRIDC002,PRSTDOCT            * same doctor still
            GOTO      OBAL9999 IF NOT EQUAL        * no - finish
            MATCH     PRIDC003,PRSTYEAR            * same financial year ?
            GOTO      OBAL9999 IF NOT LESS         * no - finish
          ENDIF
          GOTO      OBAL5000
.
.    Both Options
.
OBAL5000  ADD       PRSTIP01,OPENBAL             * add invoice totals for year
          ADD       PRSTIP02,OPENBAL
          ADD       PRSTIP03,OPENBAL
          ADD       PRSTIP04,OPENBAL
          ADD       PRSTIP05,OPENBAL
          ADD       PRSTIP06,OPENBAL
          ADD       PRSTIP07,OPENBAL
          ADD       PRSTIP08,OPENBAL
          ADD       PRSTIP09,OPENBAL
          ADD       PRSTIP10,OPENBAL
          ADD       PRSTIP11,OPENBAL
          ADD       PRSTIP12,OPENBAL
          ADD       PRSTIP13,OPENBAL
.
          SUB       PRSTCP01,OPENBAL             * subtract receipts for year
          SUB       PRSTCP02,OPENBAL
          SUB       PRSTCP03,OPENBAL
          SUB       PRSTCP04,OPENBAL
          SUB       PRSTCP05,OPENBAL
          SUB       PRSTCP06,OPENBAL
          SUB       PRSTCP07,OPENBAL
          SUB       PRSTCP08,OPENBAL
          SUB       PRSTCP09,OPENBAL
          SUB       PRSTCP10,OPENBAL
          SUB       PRSTCP11,OPENBAL
          SUB       PRSTCP12,OPENBAL
          SUB       PRSTCP13,OPENBAL
.
          ADD       PRSTJP01,OPENBAL             * subtract journals for year
          ADD       PRSTJP02,OPENBAL
          ADD       PRSTJP03,OPENBAL
          ADD       PRSTJP04,OPENBAL
          ADD       PRSTJP05,OPENBAL
          ADD       PRSTJP06,OPENBAL
          ADD       PRSTJP07,OPENBAL
          ADD       PRSTJP08,OPENBAL
          ADD       PRSTJP09,OPENBAL
          ADD       PRSTJP10,OPENBAL
          ADD       PRSTJP11,OPENBAL
          ADD       PRSTJP12,OPENBAL
          ADD       PRSTJP13,OPENBAL
.
          GOTO      OBAL0500                     * get next record
.
OBAL9999  RETURN
+
.***************************************************************************
.*                                  TBIN0000                               *
.*                     Display to be invoiced details                      *
.***************************************************************************
TBIN0000  BRANCH    DISPFLAG,TBIN0100
.
.    Medical Practice Enquiry
.
          MATCH     SP70,PRIDC001
          GOTO      TBIN9999 IF EQUAL
          MATCH     SP70,PRIDC003
          GOTO      TBIN9999 IF EQUAL
          GOTO      TBIN0500
. 
.    Service Doctor Enquiry
.
TBIN0100  MATCH     SP70,PRIDC002
          GOTO      TBIN9999 IF EQUAL
          MATCH     SP70,PRIDC003
          GOTO      TBIN9999 IF EQUAL
          GOTO      TBIN0500
. 
.    Both Enquiry
.
TBIN0500  CALL      GETDAT00
          BRANCH    EXIT,TBIN9999
          CALL      CREA0000                * create the temp file
.
.------ load the temp file with the relevant debtors ------
.
          CALL      LOAD0000                * load the temp file with the
          BRANCH    EXIT,TBIN9800             relevant debtors
          MOVE      ZERO,CHKMPRAC
.
          WRITE     HTMLFILE;"<tr><td class=HeadingCell colspan=7 ":
                             "align=center>Patients to be Invoiced ":
                             "</td></tr>":
                             "<tr><td class=HeadingCell>Debtor</td>":
                             "<td class=HeadingCell>Patient Name</td>":
                             "<td class=HeadingCell>Date</td>":
                             "<td class=HeadingCell>Doctor</td>":
                             "<td class=HeadingCell>Item</td>":
                             "<td class=HeadingCell align=right>":
                             "No. of Serv X Amt</td>":
                             "<td class=HeadingCell align=right>":
                             "Nett Amount</td>":
                             "</tr>";
.
          MOVE      ZERO,GRANDTOT
          MOVE      TRUE,FLAGFRST
          MOVE      SP8,SAVDEBT
          MOVE      SP20,KEY18
          CALL      RSTMPR12
.
.------ loop through the debtors temp file ------
.
TBIN1000  CALL      RKTMPR12
          BRANCH    OVRCD,TBIN9000
.
          MATCH     SP8,SAVDEBT             * see if we have a debtor number
          GOTO      TBIN1100 IF EQUAL         saved
.
          MATCH     TEMPDEB,SAVDEBT         * see if the debtor number has
          GOTO      TBIN2000 IF NOT EQUAL     changed
.
          COMPARE   TEMPSCN,SAVSCAN         * same scan flag ?
          GOTO      TBIN2000 IF NOT EQUAL   * no
.
.------ get the details for the current debtor ------
.
TBIN1100  MOVE      TEMPDEB,VDEBTOR
          MOVE      TEMPSCN,VSCANPMI
.
          IF        VSCANPMI=1
            PACK      KEY8,VDEBTOR,SP70  * PMI
            CALL      RDMAST1
            IF        OVRCD=1        
              MOVE      "Unknown Debtor",PATFNAME
              PACK      PATFNAME,PATFNAME,SP70
            ELSE
              CALL      PATNAM00
            ENDIF
          ELSE
            MOVE      "Unknown Debtor",PATFNAME
            PACK      PATFNAME,PATFNAME,SP70
          ENDIF
.
TBIN1150  CALL      PRIINVLD                * load the data into the temp file
          BRANCH    EXIT,TBIN1000             for this debtor number
.
          MOVE      FALSE,FLAGFRST
          MOVE      TEMPDEB,SAVDEBT
          MOVE      TEMPSCN,SAVSCAN
.
          GOTO      TBIN1000
.
.------ print the invoice/s for the current debtor ------
.
TBIN2000  CALL      PPTMP000                * process the pathology temp file
.                                             debtor number
          CALL      DIST0000                * display the To Be Invoiced

          CALL      CLRTF000                * clear the temp file
.
          MOVE      SP8,SAVDEBT
.
          GOTO      TBIN1100
.
.------ see if we found any valid transactions ------
.
TBIN9000  MOVE      ONE,CHKMPRAC
.
          COMPARE   ZERO,FLAGFRST
          GOTO      TBIN9100 IF EQUAL
.
          WRITE     HTMLFILE;"<tr><td colspan=7 align=center><b>":
                             "No transactions found":
                             "</b></td></tr>"
          GOTO      TBIN9800
.
.------ see if we need to print for the last debtor on the temp file ------
.
TBIN9100  MATCH     SP8,SAVDEBT
          GOTO      TBIN9150 IF EQUAL
.
          CALL      PPTMP000                * process the pathology temp file
.
          CALL      DIST0000                * display the To Be Invoiced
.
.------ skip if doing the print option ------
.
TBIN9150  WRITE     HTMLFILE;"<tr><td colspan=6>&nbsp;</td>":
                             "<td align=right><b>Total &nbsp;&nbsp;&nbsp;&nbsp":
                             "$",GRANDTOT,"</b></td>":
                             "</tr>"
.
          GOTO      TBIN9800
.
TBIN9800  CALL      KILL0000                * kill existing temp file
TBIN9999  RETURN
+
.**********************************************************************
.*                              GETDAT00                              *
.*                   Get date range for financial year                *
.**********************************************************************
GETDAT00  PACK      KEY6,PRIDC003,SP2
          CALL      RDSDRGA1                * position on the date range file
          CALL      RDKDRGA1
          BRANCH    OVRCD,GETDAT90
.
          MATCH     PRIDC003,DRGYR           * match financial years
          GOTO      GETDAT90 IF NOT EQUAL
.
          MOVE      DRGFDTE,FROMDATE
.
          PACK      KEY6,PRIDC003,Z2
          CALL      RDSDRGA1                * position on the date range file
          CALL      RDPDRGA1
          BRANCH    OVRCD,GETDAT90
.
          MATCH     PRIDC003,DRGYR           * match financial years
          GOTO      GETDAT90 IF NOT EQUAL
.
          MOVE      DRGTDTE,TODATE
          GOTO      GETDAT99
.
GETDAT90  MOVE      "Financial Year not on date range file",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      GETDAT99
.
GETDAT99  RETURN
.**********************************************************************
.*                              CREA0000                              *
.*                   Create the Indexed Temp File                     *
.**********************************************************************
CREA0000  CALL      KILL0000                * kill existing temp file
.
.------ Build new indexed temp file ------
.
          CLEAR     CMDLINE
          APPEND    "isbuild ",CMDLINE
          APPEND    FNAME1,CMDLINE
          APPEND    " 19 u1-8 u9-16,17-18,1-8",CMDLINE
          APPEND    SP30,CMDLINE
          RESET     CMDLINE
.
          EXECUTE   CMDLINE,TASKID
          OPEN      PRITM1XX,FNAME1
          OPEN      PRITM1XY,FNAME1
.
          CALL      CREATP00                * create the second temp file
.
CREA9999  RETURN
+
.**********************************************************************
.*                              KILL0000                              *
.*                  Kill the Tempfile if it Already Exists            *
.**********************************************************************
KILL0000  CLEAR     CMDLINE
          CLOSE     PRITM1XX
          CLOSE     PRITM1XY
          APPEND    "iserase ",CMDLINE
          APPEND    FNAME1,CMDLINE
          RESET     CMDLINE
.
          EXECUTE   CMDLINE,TASKID
          CALL      RMTMP000                     * remove PRIIVPR temp files
KILL9999  RETURN
+
.**********************************************************************
.*                               LOAD0000                             *
.*       Load the temp file with the relevant unique identifiers      *
.*       for the debtors that are to be invoiced                      *
.**********************************************************************
LOAD0000  MOVE      TRUE,FLAGFRST
.
          PACK      KEY28,ONE,SP30
          CALL      RSPRHR2                 * position on referral holding
.                                             file
.------ read through referral holding file ------
.
LOAD0100  CALL      RKPRHR2
          BRANCH    OVRCD,LOAD9000
.
          COMPARE   ONE,PRHRPINV            * finished if no more invoices
          GOTO      LOAD9000 IF NOT EQUAL     to print
.
          MOVE      PRHRUNIQ,KEY8
          CALL      RDPRHD2                 * read the header file
          BRANCH    OVRCD,LOAD0100
.
          MOVE      FALSE,FLAGFRST
          MOVE      PRHDDEBT,TEMPDEB
          MOVE      PRHDSCAN,TEMPSCN
          MOVE      PRHDUNIQ,KEY8
          CALL      RATMPR1                 * position on the temp file
          BRANCH    OVRCD,LOAD0900
.
          GOTO      LOAD0100
.
.------ write to the temp file ------
.
LOAD0900  CALL      WRTMPR1
.
          GOTO      LOAD0100
.
.------ we have finished so see if we actually wrote anything to the temp -----
.------ file ------
.
LOAD9000  COMPARE   ZERO,FLAGFRST
          GOTO      LOAD9100 IF NOT EQUAL
.
          MOVE      FALSE,EXIT
.
          GOTO      LOAD9999
.
.------ no debtors found to print invoices for ------
.
LOAD9100  MOVE      TRUE,EXIT
.
          WRITE     HTMLFILE;"<tr><td colspan=7 align=center><b>":
                             "No transactions found":
                             "</b></td></tr>"
          GOTO      LOAD9999
.
LOAD9999  RETURN
+
.***************************************************************************
.*                                   DIST0000                              *
.*                Display the To Be Invoiced details                       *
.***************************************************************************
DIST0000  MOVE      FALSE,EXIT
          PACK      KEY80,SP30,SP30,SP20
          CALL      RSTMPR2
.
.------ read through the temp file ------
.
DIST1000  CALL      RKTMPR2
          BRANCH    OVRCD,DIST9999
.
          BRANCH    DISPFLAG,DIST1100
.
.    Medical Practice Enquiry
.
          MATCH     TMPPRAC,PRIDC001        * see if we have the same practice
          GOTO      DIST1000 IF NOT EQUAL
          GOTO      DIST1500
.
.    Service Doctor Enquiry
.
DIST1100  MATCH     SP6,PRIDC001            * see if all practice
          GOTO      DIST1110 IF EQUAL
.
          MATCH     TMPPRAC,PRIDC001        * see if we have the same practice
          GOTO      DIST1000 IF NOT EQUAL
.
DIST1110  MATCH     TMPSDOCT,PRIDC002        * see if we have the same doctor
          GOTO      DIST1000 IF NOT EQUAL
          GOTO      DIST1500
.
.    Both Enquiry
.
DIST1500  MATCH     FROMDATE,TMPSDATE       * make sure the service date is in
          GOTO      DIST1000 IF LESS          range
.
          MATCH     TMPSDATE,TODATE         * make sure the service date is in
          GOTO      DIST1000 IF LESS          range
.
          UNPACK    TMPSDATE,CCENT,CYEAR,CMON,CDAY
          REP       " 0",CCENT
          REP       " 0",CYEAR
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          MOVE      TMPSERVS,FORM2
          MOVE      ONEHUND,PRDOFEEP
          PACK      KEY22,TMPPRAC,TMPSDOCT,TMPCLAIM,TMPPIND
          CALL      RDPRDO1                 * read the private practice doctor
.
          CALL      RDIT0000                     * read in item record
.                                             file
          MOVE      TMPITOT,TEMPTOTV
          MOVE      TMPITOT,TEMPAMNT
.
          CALL      GETAJ000                * get the adjusted amount
.
          MOVE      TEMPAMNT,PRDTAMNT
          MOVE      TMPIAMNT,TEMPTOTV
          MOVE      TMPIAMNT,TEMPAMNT
.
          CALL      GETAJ000                * get the adjusted amount
.
          MOVE      TEMPAMNT,PRDTIAMT
.
.------ set up the details to display ------
.
          MOVE      PRDTAMNT,TOTAMT
          MULT      TMPSERVS,TOTAMT
          ADD       TOTAMT,GRANDTOT
.
          PACK      KEY10,TMPSDOCT,SP70   * Associated Doctor
          CALL      RDPMHCP1
          IF        OVRCD = 0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
            CLEAR     DOCTOR
            APPEND    DOCFNAME,DOCTOR
          ELSE
            MOVE      PRIDC002,DOCTOR
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td>",TMPDEBT,"</td>":
                             "<td>",PATFNAME,"</td>":
                             "<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>":
                             "<td>",DOCTOR,"</td>":
                             "<td>",TMPITEM,"/",TMPSITEM,"</td>":
                             "<td align=right>",FORM2," X ",PRDTIAMT,"</td>";
.
          COMPARE   ZERO,TOTAMT             * see if the total amount exists
          GOTO      DIST2100 IF EQUAL
.
          WRITE     HTMLFILE;"<td align=right>$",TOTAMT,"</td></tr>";
          GOTO      DIST1000
.
DIST2100  WRITE     HTMLFILE;"<td>&nbsp;</td><tr>"
          GOTO      DIST1000
.
DIST9999  RETURN
+
.****************************************************************************
.*                                RDIT0000             Called by: PINV0000  *
.*         read in the item record to find out if fixed charged   DISN0000  *
.****************************************************************************
.
RDIT0000  PACK      KEY22,TMPIFLAG,TMPITEM,TMPSITEM,TMPSDATE
          CALL      RDPRIT1                 * read the item file
          COMPARE   ZERO,OVRCD
          GOTO      RDIT9999 IF EQUAL
.
          CALL      RPPRIT1                 * get the previous record on the
          BRANCH    OVRCD,RDIT9000            item file
.
          MATCH     PRITSUBN,TMPSITEM       * see if we have the same sub-item
          GOTO      RDIT9000 IF NOT EQUAL
.
          MATCH     PRITITMN,TMPITEM        * see if we have the same item
          GOTO      RDIT9000 IF NOT EQUAL
.
          COMPARE   PRITFLAG,TMPIFLAG       * see if we have the item type
          GOTO      RDIT9000 IF NOT EQUAL
.
.         We have the required record
.
          GOTO      RDIT9999
.
.------ assume not a fixed charged item -------
.
RDIT9000  MOVE      TWO,PRITFIXD        * not fixed charged
.
RDIT9999  RETURN
+
.------------------------------------------------------------
. Table of Service Doctors Practices
.------------------------------------------------------------
PMPTB000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          CALL      MPHED000      * Output Table Heading
.
          IF        NORECORD=0
            MOVE      "13",NORECORD       * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
          MOVE      SP70,PRACTICE
.
          MATCH     SP70,PRIDC002
          GOTO      PDCTB999 IF EQUAL
.
          PACK      KEY22,PRIDC002,SP70
          CALL      RSPRDO2
PMPTB100  CALL      RKPRDO2
          BRANCH    OVRCD,PMPTB999
.
          MATCH     PRIDC002,PRDODOCT     
          GOTO      PMPTB999 IF NOT EQUAL
.
          MATCH     SP70,PRACTICE
          IF        !@EQUAL
            MATCH     PRACTICE,PRDOPRAC     * Only want One Med Prac Record!
            GOTO      PMPTB100 IF EQUAL
          ENDIF
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      PMPTB100
          ENDIF
.
          CALL      PMPRW000      * Display Med Prac Table Details Row
          MOVE      PRDOPRAC,PRACTICE
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      PMPTB100 IF NOT EQUAL
.
PMPTB999  RETURN
.------------------------------------------------------------
. Service Doctor Practices Table Details (TABLE HEADING)
.------------------------------------------------------------
MPHED000  PACK      KEY10,PRIDC002,SP70   * Service Doctor
          CALL      RDPMHCP1
          IF        OVRCD = 0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
            CLEAR     DOCTOR
            APPEND    DOCFNAME,DOCTOR
          ELSE
            MOVE      PRIDC002,DOCTOR
          ENDIF
.
          WRITE     HTMLFILE;"<tr>":
                               "<td class=HeadingCell colspan=2 align=center>":
                               "Practices for ",DOCTOR,"</td>":
                               "</tr><tr>":
                               "<td class=HeadingCell width=60%>":
                               "Practices</td>":
                               "<td class=HeadingCell width=40%>":
                               "&nbsp;Status</td>":
                             "</tr>"
.
MPHED999  RETURN
.------------------------------------------------------------
. Service Doctor Practices Table (TABLE ROW)
.------------------------------------------------------------
PMPRW000  PACK      KEY6,PRDOPRAC,SP70  * Read Medical Practice Record
          CALL      RDPRPR1
          IF        OVRCD=1
            MOVE      PRDOPRAC,PRPRDESC
          ENDIF
.
          COMPARE   ZERO,PRPRSTAT
          IF        @EQUAL
            MOVE      "Active",KEY8
          ELSE
            MOVE      "Inactive",KEY8
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td nowrap><A HREF='javascript:ShowFinance":
                             "(#"",LINKPRG,"#.pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&pridc001=",PRDOPRAC:
                             "&pridc002=",PRDODOCT:
                             "#")'>":
                             "<img src=../images/MaintenanceIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             PRPRDESC,"</td>":
                             "<td>&nbsp;",KEY8,"</td>":
                             "</tr>"
.
PMPRW999 RETURN
.-----------------------------------------------------------
. Option 3 - 
.-----------------------------------------------------------
PRBL0000  BRANCH    FLDITMNO,PRBL0100,PRBL0200,PRBL0300,PRBL0400,PRBL0500:
                             PRBL0600,PRBL0700,PRBL0800,PRBL0900,PRBL1000:
                             PRBL1100,PRBL1200,PRBL1300,PRBL1400,PRBL1500:
                             PRBL1600,PRBL1700,PRBL1800,PRBL1900,PRBL2000:
                             PRBL2100,PRBL2200,PRBL2300,PRBL2400,PRBL2500:
                             PRBL2600,PRBL2700,PRBL2800,PRBL2900,PRBL3000:
                             PRBL3100,PRBL3200
          GOTO      PRBL9999
.
PRBL0100  COMPARE   ZERO,PRLHNUMB
          GOTO      PRBL9999 IF EQUAL
          WRITE     HTMLFILE;PRLHNUMB," - ",PRFLTEXT; * Last Letter Number
          GOTO      PRBL9999
.
PRBL0200  MATCH     SP10,PRLHDATE
          GOTO      PRBL9999 IF EQUAL
          UNPACK    PRLHDATE,CCENT,CYEAR,CMON,CDAY    * Last Letter date
          WRITE     HTMLFILE;CDAY,SLASH,CMON,SLASH,CCENT,CYEAR;
          GOTO      PRBL9999
.
PRBL0300  MATCH     SP10,PPIDATE
          IF        @EQUAL
            WRITE     HTMLFILE;"&nbsp;";
          ELSE
            UNPACK    PPIDATE,CCENT,CYEAR,CMON,CDAY     * Last PP Invoice date
            WRITE     HTMLFILE;CDAY,SLASH,CMON,SLASH,CCENT,CYEAR;
          ENDIF
          GOTO      PRBL9999
.
PRBL0400  WRITE     HTMLFILE;"$",PPINV;               * PP Invoice Totals
          GOTO      PRBL9999
.
PRBL0500  WRITE     HTMLFILE;"$",PPPAID;              * PP Payments 
          GOTO      PRBL9999
.
PRBL0600  WRITE     HTMLFILE;"$",PPJRNL;              * PP Journal Adjustments 
          GOTO      PRBL9999
.
PRBL0700  WRITE     HTMLFILE;"$",PPPEND;              * PP Outstanding Balance 
          GOTO      PRBL9999
.
PRBL0800  WRITE     HTMLFILE;"$",PPBILL;              * PP Amount to be billed 
          GOTO      PRBL9999
.
PRBL0900  WRITE     HTMLFILE;"$",PPCASH;              * PP Less cash received 
          GOTO      PRBL9999
.
PRBL1000  WRITE     HTMLFILE;"$",PPNEXT;              * PP Next Invoice amount 
          GOTO      PRBL9999
.
PRBL1100  WRITE     HTMLFILE;"$",PPOUT;               * PP Total Amount Outst 
          GOTO      PRBL9999
.
PRBL1200  MATCH     SP10,PTIDATE
          IF        @EQUAL
            WRITE     HTMLFILE;"&nbsp;";
          ELSE
            UNPACK    PTIDATE,CCENT,CYEAR,CMON,CDAY     * Last Pat Invoice date
            WRITE     HTMLFILE;CDAY,SLASH,CMON,SLASH,CCENT,CYEAR;
          ENDIF
          GOTO      PRBL9999
.
PRBL1300  WRITE     HTMLFILE;"$",PTINV;               * Pat Invoice Totals
          GOTO      PRBL9999
.
PRBL1400  WRITE     HTMLFILE;"$",PTPAID;              * Pat Payments 
          GOTO      PRBL9999
.
PRBL1500  WRITE     HTMLFILE;"$",PTJRNL;              * Pat Journal Adjustments 
          GOTO      PRBL9999
.
PRBL1600  WRITE     HTMLFILE;"$",PTPEND;              * Pat Outstanding Balance 
          GOTO      PRBL9999
.
PRBL1700  WRITE     HTMLFILE;"$",PTBILL;              * Pat Amount to be billed 
          GOTO      PRBL9999
.
PRBL1800  WRITE     HTMLFILE;"$",PTCASH;              * Pat Less cash received 
          GOTO      PRBL9999
.
PRBL1900  WRITE     HTMLFILE;"$",PTNEXT;              * Pat Next Invoice amount 
          GOTO      PRBL9999
.
PRBL2000  WRITE     HTMLFILE;"$",PTOUT;               * Pat Total Amount Outst 
          GOTO      PRBL9999
.
PRBL2100  WRITE     HTMLFILE;"$",TOTINV;          * Total Invoice Totals
          GOTO      PRBL9999
.
PRBL2200  WRITE     HTMLFILE;"$",TOTPAID;         * Total Payments 
          GOTO      PRBL9999
.
PRBL2300  WRITE     HTMLFILE;"$",TOTJRNL;         * Total Journal Adjustments 
          GOTO      PRBL9999
.
PRBL2400  WRITE     HTMLFILE;"$",TOTPEND;         * Total Outstanding Balance 
          GOTO      PRBL9999
.
PRBL2500  WRITE     HTMLFILE;"$",TOTBILL;         * Total Amount to be billed 
          GOTO      PRBL9999
.
PRBL2600  WRITE     HTMLFILE;"$",TOTCASH;         * Total Less cash received 
          GOTO      PRBL9999
.
PRBL2700  WRITE     HTMLFILE;"$",TOTNEXT;         * Total Next Invoice amount 
          GOTO      PRBL9999
.
PRBL2800  WRITE     HTMLFILE;"$",TOTOUT;          * Total Total Amount Outst 
          GOTO      PRBL9999
.
PRBL2900  MOVE      USERID,KEY10
          CALL      RDPRALS1
          BRANCH    OVRCD,PRBL2910
          MOVE      PRIDC001,PRACTICE
          CALL      MPRSEL00
          GOTO      PRBL9999
.
PRBL2910  MOVE      USERID,KEY16
          CALL      RSPRSEC2
PRBL2915  CALL      RKPRSEC2
          BRANCH    OVRCD,PRBL9999
.
          MATCH     USERID,PRSEUSID
          GOTO      PRBL9999 IF NOT EQUAL
.
          MOVE      PRSEPRAC,KEY6
          CALL      RDPRPR1
          IF        OVRCD=1
            MOVE      "Unknown Practice",PRPRDESC
          ENDIF
.
          MATCH     PRIDC001,PRPRCODE    * Default Medical Prac 
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",PRPRCODE,"#" selected>":
                                 "(",PRPRCODE,") ",PRPRDESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"",PRPRCODE,"#">":
                                 "(",PRPRCODE,") ",PRPRDESC,"</option>"
          ENDIF
.
          GOTO      PRBL2915
.
PRBL3000  WRITE     HTMLFILE;"$",PPCRED;              * PP Credit Note
          GOTO      PRBL9999
.
PRBL3100  WRITE     HTMLFILE;"$",PTCRED;              * Pat Credit Note
          GOTO      PRBL9999
.
PRBL3200  WRITE     HTMLFILE;"$",TOTCRED;             * Total Credit Note
          GOTO      PRBL9999
.
PRBL9999  RETURN
+
.-----------------------------------------------------------
. Option 3 -
.-----------------------------------------------------------
PRCN0000  BRANCH    FLDITMNO,PRCN0100,PRCN0200,PRCN0300,PRCN0400,PRCN0500:
                             PRCN0600,PRCN0700,PRCN0800,PRCN0900,PRCN1000:
                             PRCN1100,PRCN1200,PRCN1300,PRCN1400,PRCN1500:
                             PRCN1600,PRCN1700,PRCN1800,PRCN1900
          GOTO      PRCN9999
.
PRCN0100  WRITE     HTMLFILE;PRINNUMB; 
          GOTO      PRCN9999
.
PRCN0200  WRITE     HTMLFILE;PRINUNIQ; 
          GOTO      PRCN9999
.
PRCN0300  CALL      PPGMSC00           * check if Misc Item exists
          GOTO      PRCN9999
.
PRCN0400  MOVE      "BX",CATEGORY
          MOVE      SP70,CODE
          CALL      CODITM00           * get Reason selection list
          GOTO      PRCN9999
.
PRCN0500  CALL      DCRI0000               * List of Credit note by item
          GOTO      PRCN9999
.
PRCN0600  UNPACK    PRINDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          GOTO      PRCN9999
.
PRCN0700  CALL      RDIR0000           * build redirect string    
          GOTO      PRCN9999
.
PRCN0800  WRITE     HTMLFILE;PRINPRAC; 
          GOTO      PRCN9999
.
PRCN0900  WRITE     HTMLFILE;PRINDOCT; 
          GOTO      PRCN9999
.
PRCN1000  WRITE     HTMLFILE;PATINDIC; 
          GOTO      PRCN9999
.
PRCN1100  CALL      LCRD0000                     * Credit Note List
          GOTO      PRCN9999
.
PRCN1200  CALL      PREVGR00
          GOTO      PRCN9999
.
PRCN1300  CALL      NEXTGR00
          GOTO      PRCN9999
.
PRCN1400  WRITE     HTMLFILE;CREDITNO; 
          GOTO      PRCN9999
.
PRCN1500  PACK      KEY8,CREDITNO
          CALL      RDPRCNO1
          UNPACK    PRCODATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY12,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          IF        OVRCD=0
            WRITE     HTMLFILE;KEY12;
          ENDIF
          GOTO      PRCN9999
.
PRCN1600  CALL      DSCR0000               * Display credit note
          GOTO      PRCN9999
.
PRCN1700  CALL      DICR0000               * Display credit notes for an invoice
          GOTO      PRCN9999
.
PRCN1800  MOVE      CREDITNO,KEY8
          CALL      RDPRCNO1
          IF        OVRCD=0
            WRITE     HTMLFILE;PRCOINVN;
          ENDIF
          GOTO      PRCN9999
.
PRCN1900  CALL      EIMC0000
          WRITE     HTMLFILE;F1;
          GOTO      PRCN9999
.
PRCN9999  RETURN
+
.------------------------------------------------------------
.   Check if any item in the invoice
.------------------------------------------------------------
PPGMSC00  MOVE      ZERO,FORM1
          PACK      KEY22,PRINUNIQ,PRINNUMB,SP6
          CALL      RSPRDT1
PPGMSC10  CALL      RKPRDT1
          BRANCH    OVRCD,PPGMSC90
.
          COMPARE   PRINUNIQ,PRDTUNIQ
          GOTO      PPGMSC90 IF NOT EQUAL
.
          MATCH     PRINNUMB,PRDTINVN
          GOTO      PPGMSC90 IF NOT EQUAL
.
.         Check if there is any item for this invoice
.
          BRANCH    PRDTRTYP,PPGMSC20
          GOTO      PPGMSC10
.
PPGMSC20  MOVE      ONE,FORM1               * Found theatre or misc.item
PPGMSC90  WRITE     HTMLFILE;FORM1;
.
PPGMSC99  RETURN
+
.------------------------------------------------------------
.   List of invoice details for credit by item
.------------------------------------------------------------
DCRI0000  MOVE      ZERO,FORM2
          MOVE      ZERO,TOTTCRD
          MOVE      ZERO,TOTTGST
          MOVE      ZERO,TOTCCRD
          MOVE      ZERO,TOTCGST
          CALL      CNDHD000      * Output Table Heading
.
          PACK      KEY22,UNIQNUMB,PRINNUMB,SP6
          CALL      RSPRDT1 
DCRI1000  CALL      RKPRDT1 
          BRANCH    OVRCD,DCRI2000
.
          COMPARE   UNIQNUMB,PRDTUNIQ
          GOTO      DCRI2000 IF NOT EQUAL
.
          MATCH     PRINNUMB,PRDTINVN
          GOTO      DCRI2000 IF NOT EQUAL
.
          COMPARE   ONE,PRDTRTYP
          GOTO      DCRI1000 IF NOT EQUAL
.
DCRI1200  CALL      DISRW000    * Display Row
          GOTO      DCRI1000
.
DCRI2000  MOVE      "        0",KEY10
          MOVE      TOTTCRD,FORM72
          MOVE      FORM72,KEY10
          WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td><b>Total</b></td>":
                             "<td align=right><b>",KEY10,"</b></td>";

          MOVE      "        0",KEY10
          MOVE      TOTTGST,FORM72
          MOVE      FORM72,KEY10
          WRITE     HTMLFILE;"<td align=right><b>",KEY10,"</b></td>";
.
          MOVE      "        0",KEY10
          MOVE      TOTCCRD,FORM72
          MOVE      FORM72,KEY10
          WRITE     HTMLFILE;"<td align=right><b>",KEY10,"</b></td>":
                             "<td>&nbsp;</td>";
.
          MOVE      "        0",KEY10
          MOVE      TOTCGST,FORM72
          MOVE      FORM72,KEY10
          WRITE     HTMLFILE;"<td align=right><b>",KEY10,"</b></td>":
                             "<td>&nbsp;</td></tr>";
.
DCRI9999  RETURN
.------------------------------------------------------------
. Credit note (TABLE HEADING)
.------------------------------------------------------------
CNDHD000  WRITE     HTMLFILE;"<tr>":
                               "<td class=HeadingCell width=8%>":
                               "Date</td>":
                               "<td class=HeadingCell width=8%>":
                               "Item</td>":
                               "<td class=HeadingCell width=20%>":
                               "Description</td>":
                               "<td align=right class=HeadingCell width=10%>":
                               "Exc.GST</td>":
                               "<td align=right class=HeadingCell width=10%>":
                               "GST</td>":
                               "<td align=right class=HeadingCell width=10%>":
                               "Current Credit</td>":
                               "<td align=right class=HeadingCell>":
                               "New Credit</td>":
                               "<td align=right class=HeadingCell width=10%>":
                               "Current Cr GST</td>":
                               "<td align=right class=HeadingCell>":
                               "New Credit GST</td>":
                             "</tr>"
.
CNDHD999  RETURN
.------------------------------------------------------------
. Display invoice row (TABLE ROW)
.------------------------------------------------------------
DISRW000  ADD       ONE,FORM2   * Increment parameter counter
          MOVE      FORM2,KEY2
          REP       " 0",KEY2
.
          UNPACK    PRDTSDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      STRDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MOVE      ZERO,FORM8P2
          COMPARE   PRDTAMNT,ZERO
          IF        !@EQUAL
            MOVE      PRDTGSTM,FORM8P2
          ENDIF
.
          MOVE      "        0",KEY10
          MOVE      PRDTAMNT,FORM72        * Display Total item amount
          MOVE      FORM72,KEY10
.
          CALL      GCCR0000               * Get previous amount of credit note
          MOVE      PRDTAMNT,FORM72
          ADD       TOTAMT,FORM72          * maximum credit
.
          MOVE      FORM8P2,FORM7P2        * GST amount
          ADD       TOTGST,FORM7P2         * maximum gst
.
          WRITE     HTMLFILE;"<input type=hidden name=tranno",KEY2," value=#"":
                             PRDTTRAN,"#">":
                             "<input type=hidden name=maxcrd",KEY2," value=#"":
                             FORM72,"#">":
                             "<input type=hidden name=maxgst",KEY2," value=#"":
                             FORM7P2,"#">":
                             "<tr><td>",STRDATE,"</td>";
.
          IF        PRDTIFLG=0
            PACK      KEY1,ANSM,SP1
          ELSE
            PACK      KEY1,ANSA,SP1
          ENDIF
.
          WRITE     HTMLFILE;"<td>",KEY1,"-",PRDTITMN;
.
          MATCH     SP10,PRDTSUBN
          IF        !@EQUAL
            WRITE     HTMLFILE;"(",PRDTSUBN,")";
          ENDIF
.
          WRITE     HTMLFILE;"</td>":
                             "<td>",PRDTDESC,"(",PRDTSERV,"x",PRDTIAMT,")</td>":
                             "<td align=right>",KEY10,"</td>";
.
          MOVE      "        0",KEY10
          MOVE      FORM8P2,FORM72         * Display GST amount
          MOVE      FORM72,KEY10
          WRITE     HTMLFILE;"<td align=right>",KEY10,"</td>";
.
.
          MOVE      "        0",KEY10
          MOVE      TOTAMT,FORM72          * Display Current Credit Amount
          MOVE      FORM72,KEY10
.
          WRITE     HTMLFILE;"<td align=right>",KEY10,"</td>":
                             "<td align=right>":
                             "<input type=text name=crdamt",KEY2:
                             " min=0.00 max=9999999.99 maxlength=10 size=10 ":
                         "onblur='checkCRD(crdamt",KEY2,",maxcrd",KEY2,")' >":
                             "</td>";
.
          MOVE      "        0",KEY10
          MOVE      TOTGST,FORM72          * Display Current Credit GST Amount
          MOVE      FORM72,KEY10
.
          WRITE     HTMLFILE;"<td align=right>",KEY10,"</td>":
                             "<td align=right>":
                             "<input type=text name=gstamt",KEY2:
                             " min=0.00 max=9999999.99 maxlength=10 size=10 ":
                         "onblur='checkCRD(gstamt",KEY2,",maxgst",KEY2,")' >":
                             "</td></tr>";
.
          ADD       PRDTAMNT,TOTTCRD
          ADD       FORM8P2,TOTTGST
          ADD       TOTAMT,TOTCCRD
          ADD       TOTGST,TOTCGST
.
DISRW999  RETURN
+
.------------------------------------------------------------
.   Redirect to invoice details screen
.------------------------------------------------------------
RDIR0000  REP       " +",URNUMBER
          MOVE      INVOICEN,FORM8
          MOVE      FORM8,DIM8
          REP       " +",DIM8
          UNPACK    DIM127,D1,KEY8,DIM127
          UNPACK    DIM127,D1,KEY2,DIM127
          UNPACK    DIM127,D1,FLDPARA,DIM127
          WRITE     HTMLFILE;KEY8,".pbl?reportno=",KEY2:
                                 "&template=",FLDPARA:
                                 "&urnumber=",URNUMBER:
                                 "&visittyp=",VISITTYP:
                                 "&invoicen=",DIM8;
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
RDIR9999  RETURN
+
.-------------------------------------------------------------
. List credit notes
.-------------------------------------------------------------
LCRD0000  MOVE      "10",NORECORD           * Numb of records=0 Default to 10
          MOVE      ZERO,RECNUMB            * Init Number of records Read
          MOVE      ZERO,ROWCOUNT           * Init number of records output
.
          MOVE      ONE,VSCANPMI
          PACK      KEY18,URNUMBER,VSCANPMI,SP20
          CALL      RSPRCNO2
LCRD1000  CALL      RKPRCNO2
          BRANCH    OVRCD,LCRD9999
.
          MATCH     URNUMBER,PRCODEBT     * Same UR number 
          GOTO      LCRD9999 IF NOT EQUAL
          MATCH     " 1",PRCOSCAN     * Same scan flag   
          GOTO      LCRD9999 IF NOT EQUAL
.
          MOVE      PRCOINVN,KEY8
          CALL      RDPRIN1
          BRANCH    OVRCD,LCRD1000
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      LCRD1000
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td><img src=../images/InvoiceIcon.gif ":
                             " class=ListIcon onclick='linkCredit(#"":
                             PRCOCRNO,"#")'>":
                             PRCOCRNO,"</td>";
.
          REP       " 0",PRCODATE
          UNPACK    PRCODATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          MOVE      PRINITOT,FORM82
          ADD       PRCOAMNT,FORM82
.
          WRITE     HTMLFILE;"<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>":
                             "<td align=right>",PRCOAMNT,"</td>":
                             "<td align=right>",PRINITOT,"</td>":
                             "<td align=right>",PRINNUMB,"</td>":
                             "<td align=right>",FORM82,"</td></tr>";
.
          ADD       ONE,ROWCOUNT
          COMPARE   NORECORD,ROWCOUNT
          GOTO      LCRD1000 IF NOT EQUAL
.
LCRD9999  RETURN
+
.-------------------------------------------------------------
. Link to Prev Group
.-------------------------------------------------------------
PREVGR00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM-NORECORD,F3
          IF        F3<0
            MOVE      ZERO,F3
          ENDIF
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
.
          REP       " +",URNUMBER
.
          WRITE     HTMLFILE;"priweb04.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&prevflag=",ONE:
                                 "&urnumber=",URNUMBER;
.
          REP       "+ ",URNUMBER
.
PREVGR99  RETURN
.-----------------------------------------------------------
. Link to Next Group
.-----------------------------------------------------------
NEXTGR00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
.
          REP       " +",URNUMBER
.
          WRITE     HTMLFILE;"priweb04.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&urnumber=",URNUMBER;
.
          REP       "+ ",URNUMBER
.
NEXTGR99  RETURN
+
.------------------------------------------------------------
.   Display credit note details
.------------------------------------------------------------
DSCR0000  MOVE      ZERO,FORM2
          MOVE      ZERO,TOTAMT
          MOVE      ZERO,TOTGST
          MOVE      ZERO,TOTCCRD
          MOVE      ZERO,TOTCGST
          CALL      DCRHD000      * Output Table Heading
.
          MOVE      CREDITNO,KEY8
          CALL      RDPRCNO1
          BRANCH    OVRCD,DSCR9999
.
          MOVE      PRCOINVN,KEY8
          CALL      RDPRIN1
          BRANCH    OVRCD,DSCR9999
.
          CALL      PCRD0000          * credit note details
.
          MOVE      "        0",KEY10
          MOVE      TOTAMT,FORM72
          MOVE      FORM72,KEY10
          WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td><b>Total</b></td>":
                             "<td align=right><b>",KEY10,"</b></td>";
.
          MOVE      "        0",KEY10
          MOVE      TOTGST,FORM72
          MOVE      FORM72,KEY10
          WRITE     HTMLFILE;"<td align=right><b>",KEY10,"</b></td>";
.
          MOVE      "        0",KEY10
          MOVE      TOTCCRD,FORM72
          MOVE      FORM72,KEY10
          WRITE     HTMLFILE;"<td align=right><b>",KEY10,"</b></td>";

          MOVE      "        0",KEY10
          MOVE      TOTCGST,FORM72
          MOVE      FORM72,KEY10
          WRITE     HTMLFILE;"<td align=right><b>",KEY10,"</b></td></tr>";
.
DSCR9999  RETURN
+
.------------------------------------------------------------
. Credit note (TABLE HEADING)
.------------------------------------------------------------
DCRHD000  WRITE     HTMLFILE;"<tr>":
                               "<td class=HeadingCell width=11%>":
                               "Date</td>":
                               "<td class=HeadingCell width=10%>":
                               "Item</td>":
                               "<td class=HeadingCell width=35%>":
                               "Description</td>":
                               "<td align=right class=HeadingCell width=11%>":
                               "Total Exc.GST</td>":
                               "<td align=right class=HeadingCell width=11%>":
                               "GST</td>":
                               "<td align=right class=HeadingCell width=11%>":
                               "Credit Exc.GST</td>":
                               "<td align=right class=HeadingCell width=11%>":
                               "Credit GST</td></tr>";
.
DCRHD999  RETURN
+
.------------------------------------------------------------
.   Display credit note details
.------------------------------------------------------------
PCRD0000  PACK      KEY33,CREDITNO,SP70
          CALL      RSPRFCI3
PCRD2000  CALL      RKPRFCI3
          BRANCH    OVRCD,PCRD9999
.
          MATCH     CREDITNO,PRFCCRNO
          GOTO      PCRD9999 IF NOT EQUAL
.
          CALL      DFRRW000    * Display Row
          GOTO      PCRD2000
.
PCRD9999  RETURN
+
.------------------------------------------------------------
. Display full credit note row (TABLE ROW)
.------------------------------------------------------------
DFRRW000  UNPACK    PRFCTRDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      STRDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          PACK      KEY12,STRDATE,SP70
.
          MOVE      ZERO,FORM8P2
          COMPARE   PRFCIAMT,ZERO
          IF        !@EQUAL
            MOVE      PRFCGAMT,FORM8P2
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td>",KEY12,"</td>";
.
          IF        PRFCIFLG=0
            PACK      KEY1,ANSM,SP1
          ELSE
            PACK      KEY1,ANSA,SP1
          ENDIF
.
          WRITE     HTMLFILE;"<td>",KEY1,"-",PRFCINUM;
.
          MATCH     SP10,PRFCSUBI
          IF        !@EQUAL
            WRITE     HTMLFILE;"(",PRFCSUBI,")";
          ENDIF
.
          WRITE     HTMLFILE;"</td>":
                             "<td>",PRFCDESC,"(",PRFCNUMS,"x",PRFCITAM,")</td>";
.
          MOVE      "        0",KEY10
          MOVE      PRFCIAMT,FORM72        * total transaction amount
          MOVE      FORM72,KEY10
          WRITE     HTMLFILE;"<td align=right>",KEY10,"</td>";
.
          MOVE      "        0",KEY10
          MOVE      FORM8P2,FORM72        * GST amount
          MOVE      FORM72,KEY10
          WRITE     HTMLFILE;"<td align=right>",KEY10,"</td>";
.
          MOVE      "        0",KEY10
          MOVE      PRFCCAMT,FORM72          * total credit
          MOVE      FORM72,KEY10
.
          WRITE     HTMLFILE;"<td align=right>",KEY10,"</td>";
.
          MOVE      "        0",KEY10
          MOVE      PRFCCGST,FORM72          * total credit GST
          MOVE      FORM72,KEY10
.
          WRITE     HTMLFILE;"<td align=right>",KEY10,"</td>":
                             "</tr>";
.
          ADD       PRFCIAMT,TOTAMT
          ADD       FORM8P2,TOTGST
          ADD       PRFCCAMT,TOTCCRD
          ADD       PRFCCGST,TOTCGST
.
DFRRW999  RETURN
+
.------------------------------------------------------------
. Display Credit notes transaction for an invoice
.------------------------------------------------------------
DICR0000  MOVE      ZERO,TOTAMT
          MOVE      ZERO,TOTGST
          MOVE      ZERO,TOTCCRD
          MOVE      ZERO,TOTCGST
          MOVE      ZERO,FORM1
          CALL      DIRHD000      * Output Table Heading
.
          PACK      KEY24,SP70
          PACK      KEY24A,SP70
.
          PACK      KEY32,PRINDEBT,PRINSCAN,PRINNUMB,SP70
          CALL      RSPRFCI1
DICR1000  CALL      RKPRFCI1
          BRANCH    OVRCD OF DICR9000
.
          MATCH     PRINDEBT,PRFCDEBT
          GOTO      DICR9000 IF NOT EQUAL
          MATCH     " 1",PRFCSCAN
          GOTO      DICR9000 IF NOT EQUAL
          MATCH     PRINNUMB,PRFCINVN
          GOTO      DICR9000 IF NOT EQUAL
.
          PACK      KEY24,PRFCDEBT,PRFCSCAN,PRFCINVN,PRFCTRAN
          MATCH     SP70,KEY24A
          GOTO      DICR2000 IF EQUAL     * first time
.
          MATCH     KEY24,KEY24A
          GOTO      DICR3000 IF EQUAL     * display credit notes details
.
          IF        FORM1=0
            MOVE      ONE,FORM1
          ELSE
            MOVE      ZERO,FORM1
          ENDIF
.
.         Display transaction details
.
DICR2000  IF        FORM1=0
            WRITE     HTMLFILE;"<tr>";
          ELSE
            WRITE     HTMLFILE;"<tr bgcolor=#CCCCCC>";
          ENDIF
.
          MOVE      KEY24,KEY24A          * save transaction key
.
          UNPACK    PRFCTRDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      STRDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          WRITE     HTMLFILE;"<td>",STRDATE,"</td>";
.
..          MATCH     "1",PRFCRTYP
..          IF        @EQUAL
..            PACK      KEY27,STRDATE,SP70
..          ENDIF
.
          MATCH     SP20,PRFCDESC
          IF        @EQUAL
            MOVE      "&nbsp;   ",PRFCDESC
          ENDIF
.
          IF        PRFCIFLG=0
            MOVE      ANSM,KEY1
          ELSE
            MOVE      ANSA,KEY1
          ENDIF
.
          WRITE     HTMLFILE;"<td>",KEY1,"-",PRFCINUM;
          MATCH     SP10,PRFCSUBI
          IF        !@EQUAL
            WRITE     HTMLFILE;"(",PRFCSUBI,")";
          ENDIF
          WRITE     HTMLFILE;"</td>";
.
          WRITE     HTMLFILE;"<td>",PRFCDESC,"(",PRFCNUMS,"x",PRFCITAM,")</td>";
.
          MOVE      ZERO,FORM8P2
          COMPARE   PRFCIAMT,ZERO
          IF        !@EQUAL
            MOVE      PRFCGAMT,FORM8P2
          ENDIF
. 
          MOVE      "        0",KEY10
          MOVE      PRFCIAMT,FORM72        * total transaction amount
          MOVE      FORM72,KEY10
          WRITE     HTMLFILE;"<td align=right>",KEY10,"</td>";
.
          MOVE      "        0",KEY10
          MOVE      FORM8P2,FORM72        * GST amount
          MOVE      FORM72,KEY10
          WRITE     HTMLFILE;"<td align=right>",KEY10,"</td>";
.
          WRITE     HTMLFILE;"<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "</tr>";
.
          ADD       PRFCIAMT,TOTAMT
          ADD       FORM8P2,TOTGST
.
.         Display credit notes details
.
DICR3000  IF        FORM1=0
            WRITE     HTMLFILE;"<tr>";
          ELSE
            WRITE     HTMLFILE;"<tr bgcolor=#CCCCCC>";
          ENDIF
.
          UNPACK    PRFCCRDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      STRDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MOVE      "        0",KEY10
          MOVE      PRFCCAMT,FORM72        * total credit amount
          MOVE      FORM72,KEY10
.
          WRITE     HTMLFILE;"<td>",STRDATE,"</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td align=right>",KEY10,"</td>";
.
          MOVE      "        0",KEY10
          MOVE      PRFCCGST,FORM72        * Credit GST amount
          MOVE      FORM72,KEY10
          WRITE     HTMLFILE;"<td align=right>",KEY10,"</td>":
                             "<td align=right>",PRFCCRNO,"</td>":
                             "</tr>";
.
          ADD       PRFCCAMT,TOTCCRD
          ADD       PRFCCGST,TOTCGST
          GOTO      DICR1000
.
.         Display totals
.
DICR9000  MOVE      "        0",KEY10
          MOVE      TOTAMT,FORM72
          MOVE      FORM72,KEY10
          WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td><b>Total</b></td>":
                             "<td align=right><b>",KEY10,"</b></td>";
.
          MOVE      "        0",KEY10
          MOVE      TOTGST,FORM72
          MOVE      FORM72,KEY10
          WRITE     HTMLFILE;"<td align=right><b>",KEY10,"</b></td>";
.
          MOVE      "        0",KEY10
          MOVE      TOTCCRD,FORM72
          MOVE      FORM72,KEY10
          WRITE     HTMLFILE;"<td align=right><b>",KEY10,"</b></td>";

          MOVE      "        0",KEY10
          MOVE      TOTCGST,FORM72
          MOVE      FORM72,KEY10
          WRITE     HTMLFILE;"<td align=right><b>",KEY10,"</b></td>":
                             "<td>&nbsp;</td>":
                             "</tr>";
.
DICR9999  RETURN
+
.------------------------------------------------------------
. Credit note transaction (TABLE HEADING)
.------------------------------------------------------------
DIRHD000  WRITE     HTMLFILE;"<tr>":
                               "<td class=HeadingCell width=10%>":
                               "Date</td>":
                               "<td class=HeadingCell width=10%>":
                               "Item</td>":
                               "<td class=HeadingCell width=25%>":
                               "Description</td>":
                               "<td align=right class=HeadingCell width=11%>":
                               "Exc.GST</td>":
                               "<td align=right class=HeadingCell width=11%>":
                               "GST</td>":
                               "<td align=right class=HeadingCell width=11%>":
                               "Credit Exc.GST</td>":
                               "<td align=right class=HeadingCell width=11%>":
                               "Credit GST</td>":
                               "<td align=right class=HeadingCell width=11%>":
                               "Credit Note No.</td></tr>";
.
DIRHD999  RETURN
+
.------------------------------------------------------------------------------
.         Check if invoice has been submitted via Eclipse IMC
.------------------------------------------------------------------------------
EIMC0000  MOVE      ZERO,F1
          OPEN      PRIECTA2,"priectaf"
          PACK      KEY16,PRINNUMB,SP70
          CALL      RDPRECT2
          COMPARE   ZERO,OVRCD
          GOTO      EIMC2000 IF EQUAL
.
EIMC1000  CALL      RKPRECT2
          BRANCH    OVRCD,EIMC9999
.
          MATCH     PRECINVN,PINVNO         * same invoice?
          GOTO      EIMC9999 IF NOT EQUAL
.
EIMC2000
.         COMPARE   ZERO,PRECFLAG
.         GOTO      EIMC1000 IF EQUAL
          MOVE      ONE,F1
EIMC9999  RETURN
+
.------------------------------------------------------------
.         Delete IMC Eclipse claims
.------------------------------------------------------------
DECL0000  OPEN      PRIECTA1,"priectaf"
          OPEN      PRIECTA2,"priectaf"
          PACK      KEY16,PRINNUMB,SP70
          CALL      RDPRECT2
          BRANCH    OVRCD,DECL9999
.
          COMPARE   ZERO,PRECFLAG      * Check Eclipse status flag
          GOTO      DECL9999 IF NOT EQUAL
.
          PACK      KEY35,PRECHOSP,DPRECFLG,PRECHFND,PRECUNIQ:
                          PRECINVN,PRECBATN,SP70
          CALL      DEPRECT1
DECL9999  RETURN
.
.---------------------------------------------------------------------
. Private Practice Invoice Pending
.---------------------------------------------------------------------
PPINVP00  CLEAR     WEBTITLE
          MOVE      "Private Practice Invoice Pending",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,PRIMPE99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      PPINVP99
.
PPINVP99  RETURN
.
.------------------------------------------------------------
. Private Practice Invoice Pending Tags
.------------------------------------------------------------
INVP0000  BRANCH    FLDITMNO,INVP0100,INVP0200,INVP0300,INVP0400,INVP0500:
                             INVP0600
.
          GOTO      INVP9999
.
INVP0100  CALL      HFUND000 
          GOTO      INVP9999
.
INVP0200  MOVE      "CL",CATEGORY
          MOVE      FILTCLAM,CODE
          CALL      CODITM00
          GOTO      INVP9999
.
INVP0300  CALL      INVPL000 
          GOTO      INVP9999
.
INVP0400  WRITE     HTMLFILE;SHOWFLAG;
          GOTO      INVP9999
.
INVP0500  WRITE     HTMLFILE;PRIDC001;
          GOTO      INVP9999
.
INVP0600  CALL      PRSECP00
          GOTO      INVP9999
.
INVP9999  RETURN
.
.---------------------------------------------------------------------
. Get health fund details
.---------------------------------------------------------------------
HFUND000  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,HFUND110,HFUND120
          WRITE     HTMLFILE;FILTHFND;
          GOTO      HFUND999
.
HFUND110  PACK      KEY14,FILTHFND,ZERO,ZERO,ZERO,ZERO,SP10
          CALL      RDFUND1
          IF        OVRCD=0
            WRITE     HTMLFILE;HFNAME;
          ELSE
            WRITE     HTMLFILE;FILTHFND;
          ENDIF
          GOTO      HFUND999
.
.   Display Selection List for health fund
.
HFUND120  PACK      KEY14,SP70
          CALL      RDSFUND1
HFUND125  CALL      RDKFUND1
          BRANCH    OVRCD,HFUND999
          MATCH     "0000    ",HFTABL
          GOTO      HFUND125 IF NOT EQUAL     * skip table record
.
          BRANCH    PHFTACT,HFUND125   * if code is inactive,ignore
.
          MATCH     FILTHFND,HCODE
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",HCODE,"#" selected> ":
                               HCODE,": ",HFNAME,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"",HCODE,"#"> ":
                               HCODE,": ",HFNAME,"</option>"
          ENDIF
          GOTO      HFUND125
.
HFUND999  RETURN
.
.---------------------------------------------------------------------
. Get invoice pending list
.---------------------------------------------------------------------
INVPL000  MOVE      ZERO,TOTNETA
          MATCH     "1",SHOWFLAG
          GOTO       INVPL999 IF NOT EQUAL
        
          MOVE      "1",DIM1
          MATCH     SP70,PRIDC001
          IF        @EQUAL
            PACK      KEY28,DIM1,PRIDC002,SP70 
            CALL      RSPRHR5
          ELSE
            PACK      KEY28,DIM1,PRIDC001,PRIDC002,SP70
            CALL      RSPRHR4
          ENDIF
.
INVPL200  MATCH     SP70,PRIDC001
          IF        @EQUAL
            CALL      RKPRHR5
          ELSE
            CALL      RKPRHR4
          ENDIF
          BRANCH    OVRCD,INVPL999
.
          MATCH     SP70,PRIDC001
          IF        @EQUAL
            MATCH     SP70,PRIDC002
            IF        !@EQUAL
              MATCH     PRIDC002,PRHRDOCT
              GOTO      INVPL999 IF NOT EQUAL
            ENDIF
          ELSE
            MATCH     PRIDC001,PRHRPRAC
            GOTO      INVPL999 IF NOT EQUAL
.
            MATCH     SP70,PRIDC002
            IF        !@EQUAL
              MATCH     PRIDC002,PRHRDOCT
              GOTO      INVPL200 IF NOT EQUAL
            ENDIF
          ENDIF            
.
INVPL300  PACK      KEY8,DPRHRUNQ,SP70      
          CALL      RDPRHD2
          BRANCH    OVRCD,INVPL200
.
          MATCH     SP70,FILTCLAM
          IF        !@EQUAL
            MATCH     FILTCLAM,PRHDCLAM
            GOTO      INVPL200 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTHFND
          IF        !@EQUAL
            MATCH     FILTHFND,PRHDHFND
            GOTO      INVPL200 IF NOT EQUAL
          ENDIF
.
          MOVE      PRHDDEBT,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,INVPL200
          CALL      RDPMPX21
          BRANCH    OVRCD,INVPL200
.
          PACK      KEY6,PRHRPRAC,SP70
          CALL      RDPRPR1
          BRANCH    OVRCD,INVPL200
.
          PACK      KEY10,USERID,SP70
          CALL      RDPRALS1
          COMPARE   ZERO,OVRCD
          GOTO      INVPL500 IF EQUAL       * User has access to all Med.Prac.
.
          PACK      KEY16,PRHRPRAC,USERID,SP70
          CALL      RDPRSEC1
          BRANCH    OVRCD,INVPL200
.
INVPL500  CALL      PATNAM00              * Patient name (Surname+)
.
          MOVE      SP70,DOCTNAME
          PACK      KEY10,PRHRDOCT,SP70
          CALL      RDPMHCP1
          IF        OVRCD=0
            CALL      HCPNAM00
            MOVE      DOCFNAME,DOCTNAME
          ENDIF
.
          MOVE      SP70,CLAMDESC
          PACK      KEY5,ANSC,ANSL,PRHDCLAM
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,CLAMDESC
          ENDIF
.
          MOVE      SP70,FUNDNAME
          MATCH     SP70,PRHDHFND
          IF        !@EQUAL
            PACK      KEY14,PRHDHFND,ZERO,ZERO,ZERO,ZERO,SP70
            CALL      RDFUND1
            IF        OVRCD=0
              MOVE      HFNAME,FUNDNAME
            ENDIF
          ENDIF
.
          MOVE      SP70,PATTYPED
          PACK      KEY5,ANSG,ANSI,PRHRPIND   * Patient indicator
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,PATTYPED
          ENDIF
.
          MOVE      SP70,ACCTYPED
          MOVE      "ta",KEY2
          PACK      KEY5,KEY2,PRHRTACC   
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,ACCTYPED
          ENDIF
.
          MOVE      ONEHUND,PRDOFEEP             * get % doctor charge
          PACK      KEY22,PRHRPRAC,PRHRDOCT,PRHDCLAM,PRHRPIND,SP70
          CALL      RDPRDO1
.
          MOVE      ZERO,NETAMNT
          CALL      INVNET00
. 
          CLEAR     HTMLLINK
          APPEND    "javascript:linkInvoice('",HTMLLINK
          APPEND    PRHDDEBT,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    DPRHRUNQ,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PRHRPRAC,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PRHRDOCT,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PRHRPIND,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":       * 0
                             "#"",PRHDDEBT,"#",":                * 1     
                             "#"",PATFNAME,"#",":                * 2
                             "#"",SERVDATE,"#",":                * 3 
                             "#"",DOCTNAME,"#",":                * 4
                             "#"",PRPRDESC,"#",":                * 5
                             "#"",CLAMDESC,"#",":                * 6
                             "#"",FUNDNAME,"#",":                * 7
                             "#"",PATTYPED,"#",":                * 8
                             "#"",ACCTYPED,"#",":                * 9
                             "#"",DPRHRUNQ,"#",":                * 10
                             "#"",PRHRREFD,"#",":                * 11
                             "#"",PRHRRDAT,"#",":                * 12
                             "#"",NETAMNT,"#")"                  * 13
.
          ADD       NETAMNT,TOTNETA
.
          GOTO INVPL200
.
INVPL999  RETURN
.
.--------------------------------------------------------------------------
. Get invoice net amount
.--------------------------------------------------------------------------
INVNET00  MOVE      ZERO,F3
          MOVE      ZERO,NETAMNT
          MOVE      SP70,SERVDATE 
.
          PACK      KEY37,DPRHRUNQ,PRHRPRAC,PRHRDOCT,PRHRPIND,PRHRREFD,SP70
          PACK      KEY70,KEY37,SP70
          CALL      RSPRHT4
INVNET20  CALL      RKPRHT4 
          BRANCH    OVRCD,INVNET99
.
          PACK      SAVKEY37,DPRHTUNQ,PRHTPRAC,PRHTDOCT,PRHTPIND,PRHTREFD,SP70
          MATCH     KEY37,SAVKEY37
          GOTO      INVNET99 IF NOT EQUAL
.
          MATCH     PRHTRDAT,PRHRRDAT
          GOTO      INVNET20 IF NOT EQUAL
.
          MATCH     SERVDATE,PRHTDATE
          IF        !@EQUAL
INVNET32    MOVE      SERVDATE,SERVDATE
          ENDIF                                
.
INVNET50  MOVE      PRHTDATE,SERVDATE
.
          CALL      RDITM000    
.
          MOVE      PRHTIAMT,TEMPTOTV
          MOVE      PRHTIAMT,TEMPAMNT
          CALL      GETADJ00   
          MULT      PRHTSERN,TEMPAMNT             * calculate line total
.
          ADD       TEMPAMNT,NETAMNT       
          MOVE      PRHTDATE,SERVDATE
.
          ADD       ONE,F3
          GOTO      INVNET20
.
INVNET99  RETURN 
.
.--------------------------------------------------------------------------
. Get user access practice code if only one is setup
.--------------------------------------------------------------------------
PRSECP00  MOVE      ZERO,F1
          MOVE      SP70,PRACTICE
          MOVE      USERID,KEY16
          CALL      RSPRSEC2
PRSECP20  CALL      RKPRSEC2
          BRANCH    OVRCD,PRSECP80
.
          MATCH     USERID,PRSEUSID
          GOTO      PRSECP80 IF NOT EQUAL
.
          IF        F1 = ZERO
            MOVE      PRSEPRAC,PRACTICE
          ENDIF
          ADD       ONE,F1
.
          GOTO      PRSECP20
.
PRSECP80  IF        F1 = ONE
            WRITE     HTMLFILE;PRACTICE;
          ENDIF            
.
PRSECP99  RETURN
.
.--------------------------------------------------------------------------
. read in the item record to find out if fixed charged      
.--------------------------------------------------------------------------
.
RDITM000  PACK      KEY22,PRHTFLAG,PRHTITMN,PRHTSUBN,PRHTDATE,SP70
          CALL      RDPRIT1                 * read the item file
          COMPARE   ZERO,OVRCD
          GOTO      RDITM999 IF EQUAL
.
RDITM100  CALL      RPPRIT1                 * get the previous record on the
          BRANCH    OVRCD,RDIT9000            item file
.
          MATCH     PRITSUBN,PRHTSUBN       * see if we have the same sub-item
          GOTO      RDITM900 IF NOT EQUAL
.
          MATCH     PRITITMN,PRHTITMN       * see if we have the same item
          GOTO      RDITM900 IF NOT EQUAL
.
          COMPARE   PRITFLAG,PRHTFLAG       * see if we have the item type
          GOTO      RDITM900 IF NOT EQUAL
.
.                                           * check Effective & Cease dates
.
          MATCH     PRITDAT1,PRHTDATE        
          GOTO      RDITM100 IF LESS
.
          MATCH     SP8,PRITDAT2            * test for a Cease Date
          IF        !@EQUAL
            MATCH     PRHTDATE,PRITDAT2
            GOTO      RDITM100 IF LESS      * read next if past Cease date
          ENDIF                              
.
.         We have the required record
.
          GOTO      RDITM999
.
.------ assume not a fixed charged item -------
.
RDITM900  MOVE      TWO,PRITFIXD        * not fixed charged
.
RDITM999  RETURN
+
.--------------------------------------------------------------------------
. Routine to get an adjusted invoice amount if appropriate 
.--------------------------------------------------------------------------
GETADJ00  BRANCH    PRITFIXD,GETADJ99       * fixed charge item
.
.         If an exception charge applies, just use that charge
.
          CALL      ISEXC000                * exception charge apply?
          IF        EXIT = 1
            IF        PRITKEYI = 0
              MOVE      PREXCHRG,TEMPAMNT   * use this charge
            ENDIF
            GOTO      GETADJ99              * don't apply doctor percentage
          ENDIF
.
.         Modify the charge by the doctor's percentage
.
          MOVE      TEMPAMNT,FORM8P4
          MULT      PRDOFEEP,FORM8P4
          DIV       ONEHUND,FORM8P4
          MOVE      FORM8P4,TEMPAMNT
.
          MATCH     "1",PRCNNRND
          GOTO      GETADJ20 IF EQUAL       * No rounding
.
          MOVE      TEMPAMNT,VDIM15
.
          CALL      ROUND000                * round the amount to the nearest
.                                             highest 5 cents
          ADD       FORM0P2,TEMPAMNT
.
GETADJ20  COMPARE   FORM85P0,PRDOFEEP       * see if we are charging 85% of
          GOTO      GETADJ99 IF NOT EQUAL   * the scheduled fee
.
          MATCH     SP3,PRHRPIND            * see if the patient indicator
          GOTO      GETADJ99 IF EQUAL       * exists
.
          PACK      KEY5,CODEGI,PRHRPIND
          CALL      RDCODE1                 * read patient codes file
          BRANCH    OVRCD,GETADJ99
.
          MATCH     ANSO,TCINDC1            * see if we have an outpatient
          GOTO      GETADJ99 IF NOT EQUAL
.
          MOVE      TEMPTOTV,FORM8P2
          SUB       TEMPAMNT,FORM8P2
.
          MOVE      PRDTSDAT,KEY8
          CALL      RDPRMG1                 * read the Medicare Gap file
          COMPARE   ZERO,OVRCD
          GOTO      GETADJ10 IF EQUAL
.
          CALL      RPPRMG1                 * get the previous Medicare Gap
          BRANCH    OVRCD,GETADJ99            file record
.
.------ check the gap difference ------
.
GETADJ10  COMPARE   FORM8P2,PRMGVALU        * see if the difference is more
          GOTO      GETADJ99 IF NOT LESS      than the medicare gap allowed
.
          MOVE      TEMPTOTV,TEMPAMNT
          SUB       PRMGVALU,TEMPAMNT
.
          MATCH     "1",PRCNNRND
          GOTO      GETADJ99 IF EQUAL       * No rounding
.
          MOVE      TEMPAMNT,VDIM15
.
          CALL      ROUND000                * round the amount to the nearest
.                                             highest 5 cents
          ADD       FORM0P2,TEMPAMNT
.
GETADJ99  RETURN
.
.------------------------------------------------------------
.         Processing Receipts
.------------------------------------------------------------
RCPP0000  BRANCH    FLDITMNO,RCPP0100,RCPP0200,RCPP0300,RCPP0400,RCPP0500:
                             RCPP0600,RCPP0700,RCPP0800,RCPP0900,RCPP1000:
                             RCPP1100,RCPP1200,RCPP1300,RCPP1400,RCPP1500:
                             RCPP1600,RCPP1700,RCPP1800,RCPP1900,RCPP2000:
                             RCPP2100,RCPP2200,RCPP2300,RCPP2400,RCPP2500:
                             RCPP2600,RCPP2700
          GOTO      RCPP9999
.
RCPP0100  CALL      RCPL0000           * List of Receipts Processing
          GOTO      RCPP9999
.
RCPP0200  MOVE      "CL",CATEGORY
          MOVE      FILTCLAM,CODE
          CALL      CODITM00
          GOTO      RCPP9999
.
RCPP0300  WRITE     HTMLFILE;SHOWFLAG;
          GOTO      RCPP9999
.
RCPP0400  WRITE     HTMLFILE;PRIDC001;
          GOTO      RCPP9999
.
RCPP0500  CALL      PRSECP00
          GOTO      RCPP9999
.
RCPP0600  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,RCPP0610
.
          MATCH     SP70,FILTHFND
          GOTO      RCPP9999 IF EQUAL
.
          WRITE     HTMLFILE;FILTHFND;
          GOTO      RCPP9999
.
RCPP0610  PACK      KEY14,FILTHFND,ZERO,ZERO,ZERO,ZERO,SP70
          CALL      RDFUND1
          IF        OVRCD=0
            WRITE     HTMLFILE;HFNAME;
          ELSE
            WRITE     HTMLFILE;FILTHFND;
          ENDIF
          GOTO      RCPP9999
.
RCPP0700  WRITE     HTMLFILE;FILTSTAT;       * Status
          GOTO      RCPP9999
.
RCPP0800  CALL      PREVRC00        * Show Previous Receipts of records
          GOTO      RCPP9999
.
RCPP0900  CALL      NEXTRC00        * Show Next Receipts of records
          GOTO      RCPP9999
.
RCPP1000  CALL      SELV0000
          GOTO      RCPP9999
.
RCPP1100  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      RCPP9999
.
RCPP1200  WRITE     HTMLFILE;INVOICEN;
          GOTO      RCPP9999
.
RCPP1300  MOVE      "dm",CATEGORY
          MOVE      PRRARMOV,CODE          * reason for Debt movement
          CALL      CODITM00
          GOTO      RCPP9999
.
RCPP1400  MOVE      "dc",CATEGORY
          MOVE      PRRADBAG,CODE          * Debt Collection Agencies
          CALL      CODITM00
          GOTO      RCPP9999
.
RCPP1500  WRITE     HTMLFILE;FILTAUTO;     * filter for Auto Processing
          GOTO      RCPP9999
.
RCPP1600  MOVE      "CL",CATEGORY
          MOVE      PRURCLMN,CODE
          CALL      CODITM00
          GOTO      RCPP9999
.
RCPP1700  WRITE     HTMLFILE;PRURHFND;
          GOTO      RCPP9999
.
RCPP1800  WRITE     HTMLFILE;PRINNUMB;
          GOTO      RCPP9999
.
RCPP1900  UNPACK    PRINDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          GOTO      RCPP9999
.
RCPP2000  WRITE     HTMLFILE;PRINITOT;
          GOTO      RCPP9999
.
RCPP2100  CALL      TPAY0000
          WRITE     HTMLFILE;TOTPAID;
          GOTO      RCPP9999
.
RCPP2200  CALL      TPAY0000
          MOVE      PRINITOT,FORM12P2
          ADD       TOTPAID,FORM12P2
          ADD       PRINJAMT,FORM12P2
          ADD       PRINCNTT,FORM12P2
          ADD       PRINGSTJ,FORM12P2
.
          WRITE     HTMLFILE;FORM12P2;
          GOTO      RCPP9999
.
RCPP2300  MOVE      "dm",CATEGORY
          MOVE      PRRARMOV,CODE          * reason for Debt movement
          CALL      CODITM00
          GOTO      RCPP9999
.
RCPP2400  MOVE      "dc",CATEGORY
          MOVE      PRRADBAG,CODE          * Debt Collection Agencies
          CALL      CODITM00
          GOTO      RCPP9999
.
RCPP2500  WRITE     HTMLFILE;PRRAPPOR;     * Patient portion
          GOTO      RCPP9999
.
RCPP2600  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,RCPP2610
.
          WRITE     HTMLFILE;PRURMPRA;
          GOTO      RCPP9999
.
RCPP2610  PACK      KEY6,PRURMPRA,SP70     * Medical Practice
          CALL      RDPRPR1
          IF        OVRCD=1
            MOVE      PRDOPRAC,PRPRDESC
          ENDIF
          WRITE     HTMLFILE;PRPRDESC;
          GOTO      RCPP9999
.
RCPP2700  MOVE      SP70,KEY35
          PACK      KEY10,PRURSDOC,SP10
          CALL      RDPMHCP1                * read the doctors file
          IF        OVRCD=0
            CALL      HCPNAM00
            MOVE      DOCFNAME,KEY35
          ENDIF
          WRITE     HTMLFILE;KEY35;
          GOTO      RCPP9999
.
RCPP9999  RETURN
+
.------------------------------------------------------------
.         List of Receipts
.------------------------------------------------------------
RCPL0000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          MOVE      ZERO,DISNUMB
          PACK      KEY24,FRSTDATE,SP70
          CALL      RSPRURE2
RCPL1000  CALL      RKPRURE2
          BRANCH    OVRCD,RCPL9999
.
          MATCH     PRURCDAT,LASTDATE
          GOTO      RCPL9999 IF LESS
.
          MOVE      PRURINVN,KEY8
          CALL      RDPRIN1
          BRANCH    OVRCD,RCPL1000         * Missing Invoice record
.
          MOVE      PRURDEBT,URNUMBER
          PACK      KEY8,URNUMBER
          CALL      RDMAST1
          BRANCH    OVRCD,RCPL1000
.
          PACK      KEY6,PRURMPRA,SP70
          CALL      RDPRPR1
          BRANCH    OVRCD,RCPL1000
.
          PACK      KEY10,USERID,SP70
          CALL      RDPRALS1
          COMPARE   ZERO,OVRCD
          GOTO      RCPL2000 IF EQUAL       * User has access to all Med.Prac.
.
          PACK      KEY16,PRURMPRA,USERID,SP70
          CALL      RDPRSEC1
          BRANCH    OVRCD,RCPL1000
.
RCPL2000  REP       " 0",FILTAUTO
          MATCH     "0",FILTAUTO
          IF        !@EQUAL
            CALL      CRAS0000          * Check for existing reassign record
            BRANCH    EXIT,RCPL1000
          ENDIF
.
          MATCH     SP70,PRIDC001
          IF        !@EQUAL
            MATCH     PRIDC001,PRURMPRA
            GOTO      RCPL1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,PRIDC002
          IF        !@EQUAL
            MATCH     PRIDC002,PRURSDOC
            GOTO      RCPL1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTCLAM
          IF        !@EQUAL
            MATCH     FILTCLAM,PRURCLMN
            GOTO      RCPL1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTHFND
          IF        !@EQUAL
            MATCH     FILTHFND,PRURHFND
            GOTO      RCPL1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTSTAT
          IF        !@EQUAL
            MATCH     FILTSTAT,PRURSTAT
            GOTO      RCPL1000 IF NOT EQUAL
          ENDIF
.
.
          CALL      PATNAC00               * setup patient name
          CALL      PATLN000               * display patient name
.
          ADD       ONE,DISNUMB
          MOVE      SP70,DIM5
          MOVE      ZERO,FORM5
          MOVE      DISNUMB,FORM5
          MOVE      FORM5,DIM5
          REP       " 0",DIM5
.
          CLEAR     PATLINK
          APPEND    LINKPRG,PATLINK
          APPEND    ".pbl?reportno=",PATLINK
          APPEND    LINKREP,PATLINK
          APPEND    "&template=",PATLINK
          APPEND    LINKTEM,PATLINK
          APPEND    "&urnumber=",PATLINK
          APPEND    PRURDEBT,PATLINK
          RESET     PATLINK
.
          CLEAR     HTMLLINK
          APPEND    "javascript:linkPatient('",HTMLLINK
          APPEND    PRURINVN,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":       * 0
                          "#"",PRURMPRA,"#",";                   * 1
.
          MOVE      "&nbsp;",KEY35
          PACK      KEY10,PRURSDOC,SP10
          CALL      RDPMHCP1                * read the doctors file
          IF        OVRCD=0
            CALL      HCPNAM00
            MOVE      DOCFNAME,KEY35
          ENDIF
          WRITE     HTMLFILE;"#"",KEY35,"#",";                * 2
.
          MOVE      "&nbsp;",KEY20
          PACK      KEY5,ANSC,ANSL,PRURCLMN
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,KEY20             * Claim code desc.
          ENDIF
          WRITE     HTMLFILE;"#"",KEY20,"#",";                * 3
.
          MOVE      "&nbsp;",KEY6
          MATCH     SP70,PRURHFND
          IF        !@EQUAL
            PACK      KEY6,PRURHFND
          ENDIF
          WRITE     HTMLFILE;"#"",KEY6,"#",";                 * 4
.
.         Get payment for released and un-released payments
.
          CALL      TPAY0000
.
          MOVE      PRINJAMT,FORM12P2    * Journals
          ADD       PRINGSTJ,FORM12P2
          ADD       PRINCNTT,FORM12P2
.
          MOVE      PRINITOT,TOTOUTS      * Total Outstanding
          ADD       TOTPAID,TOTOUTS
          ADD       FORM12P2,TOTOUTS
.
          MOVE      SP70,KEY1
          PACK      DIM10A,PRURINVN,SP70
          MATCH     "1",PRURSTAT
          IF         @EQUAL
            MOVE       "*",KEY1            * status of Processed
          ENDIF
          PACK      DIM10A,KEY1,PRURINVN,SP70
.
.         Get the last record of Reassign debt table
.
          MOVE      ZERO,PATPORTN
          PACK      KEY10,PRURINVN,Z70
          CALL      RSPRRAS1
          CALL      RPPRRAS1
          IF        OVRCD=0
            MATCH     PRURINVN,PRRAINVN    * Same invoice number?
            IF        @EQUAL
              MATCH     "1",PRRADELE       * Not deleted
              IF        !@EQUAL
                MOVE      PRRAPPOR,PATPORTN
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      SP70,KEY3
          CALL      PATFLD00
.
          WRITE     HTMLFILE;"#"",FORMATNM,"#",":                * 5
                             "#"",PRINDATE,"#",":                * 6
                             "#"",DIM10A,"#",":                  * 7
                             "#"",PRINITOT,"#",":                * 8
                             "#"",TOTPAID,"#",":                 * 9
                             "#"",FORM12P2,"#",":                * 10
                             "#"",TOTOUTS,"#",":                 * 11
                             "#"",PRURUDAT,"#",":                * 12
                             "#"",PATLINK,"#",":                 * 13
                             "#"",PATPORTN,"#",":                * 14
                             "#"",KEY3,"#",";                    * 15
.
          WRITE     HTMLFILE;"#"<input type=checkbox name=asg",DIM5:
                     " value='",PRURINVN;                        * 16
.
          MATCH     "0",FILTAUTO
          IF        @EQUAL
            WRITE   HTMLFILE;"' disabled onclick=updateAssignDebt();>","#",";
          ELSE
            WRITE     HTMLFILE;"' onclick=updateAssignDebt();>","#",";
          ENDIF
.
          WRITE     HTMLFILE;"#"<input type=checkbox name=prt",DIM5:    * 17
                      " value='",PRURINVN,"' onclick=updatePrintInv();>":
                      "#")"
.
          GOTO      RCPL1000
.
RCPL9999  RETURN
+
.------------------------------------------------------------------------------
.         Check for existing reassign record
.------------------------------------------------------------------------------
CRAS0000  MOVE      ZERO,EXIT
          PACK      KEY10,PRURINVN,SP70
          CALL      RSPRRAS1
CRAS1000  CALL      RKPRRAS1
          BRANCH    OVRCD,CRAS2000
.
          MATCH     PRURINVN,PRRAINVN    * Same invoice number?
          GOTO      CRAS2000 IF NOT EQUAL
.
          MATCH     "1",PRRADELE       * Not deleted
          GOTO      CRAS1000 IF EQUAL
.
.         found existing reassign record
.
          MATCH     "1",FILTAUTO         * Previouly processed
          GOTO      CRAS9999 IF EQUAL
          GOTO      CRAS9000

CRAS2000  MATCH     "2",FILTAUTO         * New Movement
          GOTO      CRAS9999 IF EQUAL
.
CRAS9000  MOVE      ONE,EXIT
CRAS9999  RETURN
+
.------------------------------------------------------------------------------
.      get all receipts/payments
.------------------------------------------------------------------------------
TPAY0000 MOVE      ZERO,TOTPAID
         MOVE      ZERO,TOTDEPS
         PACK      SAVKEY12,SP4,PRINNUMB,SP70  * set up invoice number
         PACK      KEY29,SAVKEY12,SP70
         CALL      RSRCDTE3
TPAY1000 CALL      RKRCDTE3
         BRANCH    OVRCD,TPAY9000
.
         MATCH     SAVKEY12,RCDTINVN       * Same invoice number?
         GOTO      TPAY9000 IF NOT EQUAL
.
         MATCH     PRINDEBT,RCDTURNO       * Same debtor number?
         GOTO      TPAY1000 IF NOT EQUAL
.
         PACK      KEY12,RCDTRECN,SP70
         CALL      RDRCBNK1
         BRANCH    OVRCD,TPAY1000
         MATCH     "1",RCBNSTAT
         GOTO      TPAY1000 IF EQUAL       * Receipt cancelled
.
.        Check for Deposit register
.
         PACK      KEY3,RCDTREGI,SP70
         CALL      RDREGA1
         BRANCH    OVRCD,TPAY1000
.
         COMPARE   "2",REGIBACD
         GOTO      TPAY2000 IF EQUAL       * Private Practice
         COMPARE   "96",REGIBACD
         GOTO      TPAY1000 IF NOT EQUAL   * NOT PRI Deposit
.
         ADD       RCDTAMNT,TOTDEPS       * Deposit amount
.
TPAY2000 ADD       RCDTAMNT,TOTPAID
         GOTO      TPAY1000
.
TPAY9000 MULT      "-1",TOTPAID
         MULT      "-1",TOTDEPS
TPAY9999 RETURN
+
.-------------------------------------------------------------
. Link to Prev Receipts
.-------------------------------------------------------------
PREVRC00  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
.
          REP       " +",URNUMBER
          REP       " +",FILTHFND
          REP       " +",FILTCLAM
.
          WRITE     HTMLFILE;"priweb04.pbl":
                                 "?reportno=",KEY2:
                                 "&template=",KEY3:
                                 "&frstdate=",PREFDATE:
                                 "&lastdate=",PRELDATE:
                                 "&filtclam=",FILTCLAM:
                                 "&filthfnd=",FILTHFND:
                                 "&filtstat=",FILTSTAT:
                                 "&viewtype=",VIEWTYPE:
                                 "&invoicen=",INVOICEN;
.
          REP       "+ ",URNUMBER
          REP       "+ ",PREVVKEY
          REP       "+ ",FILTHFND
          REP       "+ ",FILTCLAM
.
PREVRC99  RETURN
+
.-----------------------------------------------------------
. Link to Next Receipts
.-----------------------------------------------------------
NEXTRC00  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
.
          REP       " +",URNUMBER
          REP       " +",FILTHFND
          REP       " +",FILTCLAM
.
          WRITE     HTMLFILE;"priweb04.pbl":
                                 "?reportno=",KEY2:
                                 "&template=",KEY3:
                                 "&norecord=",KEY2:
                                 "&frstdate=",NXTFDATE:
                                 "&lastdate=",NXTLDATE:
                                 "&filtclam=",FILTCLAM:
                                 "&filthfnd=",FILTHFND:
                                 "&filtvtyp=",FILTSTAT:
                                 "&viewtype=",VIEWTYPE:
                                 "&invoicen=",INVOICEN;
.
          REP       "+ ",URNUMBER
          REP       "+ ",FILTHFND
          REP       "+ ",FILTCLAM
.
NEXTRC99  RETURN
+
.------------------------------------------------------------
.         Receipts Processing List
.------------------------------------------------------------
LRCP0000  BRANCH    UPDATETY,LRCP1000,LRCP2000,LRCP3000,LRCP4000
          MOVE      SP70,PRRARMOV       * Reason of Movement
          MOVE      SP70,PRRADBAG       * Debt Collection Agency (code)
          GOTO      LRCP9000
.
LRCP1000  COMPARE   ZERO,INVOICEN
          GOTO      LRCP9800 IF EQUAL
.
          MOVE      INVOICEN,FORM8
          MOVE      FORM8,KEY8
          CALL      RDPRIN1
          BRANCH    OVRCD,LRCP9200
.
          MOVE      PRINNUMB,KEY8
          CALL      RDPRURE1
          IF        OVRCD=1
            MOVE      ZERO,FORM12P2
            CALL      TPAY0000
            CALL      SETU0000              * Setup Unreconciled inv.fields
            CALL      WRPRURE1
          ENDIF
.
          MOVE      PRINDEBT,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,LRCP9200
          CALL      RDPMPX21
          BRANCH    OVRCD,LRCP9200
.
.         Check if there is any previous reassign debt record
.
          PACK      KEY10,PRINNUMB,Z70
          CALL      RSPRRAS1
          CALL      RPPRRAS1
          BRANCH    OVRCD,LRCP1200
.
          MATCH     PRINNUMB,PRRAINVN      * Same invoice ?
          GOTO      LRCP1200 IF NOT EQUAL
.
          MATCH     "1",PRRADELE       * Not deleted?
          GOTO      LRCP9000 IF NOT EQUAL
.
LRCP1200  MOVE      SP70,PRRARMOV
          MOVE      ZERO,PRRAPPOR
          GOTO      LRCP9000
.
. ******************************************************************************
.         Reassign Debt   (also reasign to Debt Collection Agency)
.
LRCP2000  COMPARE   ZERO,INVOICEN
          GOTO      LRCP9800 IF EQUAL
.
          MOVE      INVOICEN,FORM8
          MOVE      FORM8,KEY8
          CALL      RDPRIN1
          BRANCH    OVRCD,LRCP9200
          CALL      TPAY0000                * get total payment
.
          MOVE      PRINNUMB,KEY8
          CALL      RDPRURE1
          IF        OVRCD=1
            MOVE      ZERO,FORM12P2
            CALL      SETU0000              * Setup Unreconciled inv.fields
            CALL      WRPRURE1
          ENDIF
.
          MOVE      PRINDEBT,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,LRCP9200
          CALL      RDPMPX21
          BRANCH    OVRCD,LRCP9200
.
          MOVE      "1",PRURSTAT          * Default status to Process
          IF        PROCESSD=0
            MOVE      "0",PRURSTAT        * New or Not processed
          ENDIF

          MOVE      PRINITOT,PRURINVT    * Invoice total
          ADD       PRINCNTT,PRURINVT    * credit note
          MOVE      TOTPAID,PRURPAYM     * Patient payments +
          MOVE      PRINJAMT,PRURJRNL    * journals
          ADD       PRINGSTJ,PRURJRNL    * journals GST
.
          MOVE      PRINITOT,PRUROSTD    * Invoice amount +
          ADD       PRURPAYM,PRUROSTD    * payments +
          ADD       PRINCNTT,PRUROSTD    * Credit Notes +
          ADD       PRINJAMT,PRUROSTD    * Journals = amount outstanding
          ADD       PRINGSTJ,PRUROSTD    * Journal GST = amount outstanding
.
          CALL      IBACLOCK
          PACK      PRURUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PRURUDAT
          MOVE      CTIMEIS,PRURUTIM
          MOVE      WBSEUID,PRURUUID        * WEB user id
          CALL      UPPRURE1
.
.         Write record to Reassign Debt table
.
          MOVE      ONE,FORM2
          PACK      KEY10,PRINNUMB,Z70
          CALL      RSPRRAS1
          CALL      RPPRRAS1
          BRANCH    OVRCD,LRCP2400
.
          MATCH     PRINNUMB,PRRAINVN      * Same invoice ?
          GOTO      LRCP2400 IF NOT EQUAL
.
          MOVE      PRRACNTN,FORM2
.
LRCP2400  MOVE      FORM2,PRRACNTN
          PACK      KEY10,PRINNUMB,PRRACNTN,SP70
          CALL      RDPRRAS1
          IF        OVRCD=0
            ADD       ONE,FORM2
            GOTO      LRCP2400
          ENDIF
          PACK      CURRDATE,CCC,CYY,CMM,CDD  * write a new "patrasaf" record
          REP       " 0",CURRDATE
          MOVE      FORM2,PRRACNTN
          MOVE      PRINNUMB,PRRAINVN
          MOVE      FORM2,PRRACNTN
          MOVE      PRUROSTD,PRRAOUST       * Outstanding amount
          MOVE      REASMOVE,PRRARMOV       * Reason of Movement
          MOVE      DEBTAGNT,PRRADBAG       * Debt Collection Agency (code)
          MOVE      PATPORTN,PRRAPPOR       * Patient portion
          MOVE      "0",PRRADELE            * set Deleted flag off
.
          CALL      IBACLOCK
          MOVE      CURRDATE,PRRACDAT
          MOVE      CTIMEIS,PRRACTIM
          MOVE      WBSEUID,PRRACUID        * WEB user id
.
          MOVE      CURRDATE,PRRAUDAT
          MOVE      CTIMEIS,PRRAUTIM
          MOVE      WBSEUID,PRRAUUID        * WEB user id
          CALL      WRPRRAS1
.
.                        *****************  * write to Patient Debt Reg. file
LRCP2500  MOVE      "4",PTDESYST            * System
          PACK      KEY10,THREE,PRINNUMB,PTDESYST,SP10
          CALL      RDPTDET1
          IF        OVRCD = 1
            MATCH     SP3,DEBTAGNT          * assigned to Debt Collect.Agency ?
            GOTO      LRCP2800 IF EQUAL     * no - this debt has been cleared
.
            CALL      CLPATDET
            MOVE      "3",PTDETYPE
            MOVE      PRINNUMB,PTDEINVN
            MOVE      DEBTAGNT,PTDEAGNT     * Debt Collection Agency (code)
            MOVE      CURRDATE,PTDECDAT
            MOVE      CTIMEIS,PTDECTIM
            MOVE      WBSEUID,PTDECUID      * WEB user id
            MOVE      PRINDEBT,PTDEURNO
	    MOVE      "4",PTDESYST          * System
            CALL      WRPTDET1
            MOVE      ONE,KEY1
          ELSE
            MOVE      ZERO,KEY1
            MATCH     SP3,DEBTAGNT          * assigned to Debt Collect.Agency ?
            IF        @EQUAL
              MOVE      CURRDATE,PTDEDTCL
            ELSE
              MOVE      SP8,PTDEDTCL
              MOVE      DEBTAGNT,PTDEAGNT   * Debt Collection Agency (code)
              MOVE      ONE,KEY1
            ENDIF
            MOVE      CURRDATE,PTDEUDAT
            MOVE      CTIMEIS,PTDEUTIM
            MOVE      WBSEUID,PTDEUUID      * WEB user id
            CALL      UPPTDET1
          ENDIF
.
          MATCH     "1",PMPXSN14
          IF        !@EQUAL
            MOVE      KEY1,PMPXSN14         * set Debt Collection flag
            CALL      UPPMPX21              * update PMI Extention record
          ENDIF
.
LRCP2800  IF        PRINSCAN=1
            PROC      FLAGDEBP              * flag Outstanding Debt
          ENDIF
.
          MATCH     "1",PRINTINV
          GOTO      LRCP9800 IF NOT EQUAL   * Not reprinting invoice
.
          COMPARE   ZERO,PRUROSTD
          GOTO      LRCP9800 IF EQUAL       * No outstanding amount
.
          MOVE      ZERO,UPDATETY
          MOVE      "017",KEY3         * Pooling Type
          CALL      PNTX0000            * reprint invoice
.
          GOTO      LRCP9800
.
. ******************************************************************************
.        Reset - Update the last record of the Reassign debt table to be Deleted
.
LRCP3000  MOVE      INVOICEN,FORM8
          MOVE      FORM8,PRINNUMB
          MOVE      ONE,FORM2
          PACK      KEY10,PRINNUMB,Z70
          CALL      RSPRRAS1
          CALL      RPPRRAS1
          IF        OVRCD=0
            MATCH     PRINNUMB,PRRAINVN      * Same invoice ?
            IF        @EQUAL
              MOVE      PRRACNTN,FORM2
            ENDIF
          ENDIF
          MOVE      FORM2,PRRACNTN         * Count
          PACK      KEY10,PRINNUMB,PRRACNTN,SP70
          CALL      RDPRRAS1
          BRANCH    OVRCD,LRCP9800
          MOVE      "1",PRRADELE            * Deleted
          CALL      UPPRRAS1
.
          MOVE      PRINNUMB,KEY8
          CALL      RDPRURE1
          IF        OVRCD=0
            MOVE      "2",PRURSTAT          * Deleted - reset
            CALL      IBACLOCK
            PACK      PRURUDAT,CCC,CYY,CMM,CDD
            REP       " 0",PRURUDAT
            MOVE      CTIMEIS,PRURUTIM
            MOVE      WBSEUID,PRURUUID        * WEB user id
            CALL      UPPRURE1
          ENDIF
.
          IF        PRINSCAN=1
            PROC      FLAGDEBP              * flag Outstanding Debt
          ENDIF
.
          MATCH     SP3,DEBTAGNT            * assigned to Debt Collect.Agency ?
          GOTO      LRCP9800 IF EQUAL
.
.                        *****************  * write to Patient Debt Reg. file
          MOVE      "4",PTDESYST            * PP System
          PACK      KEY10,THREE,PRINNUMB,PTDESYST,SP10
          CALL      RDPTDET1
          IF        OVRCD = 0
            PACK      CURRDATE,CCC,CYY,CMM,CDD
            REP       " 0",CURRDATE
            MOVE      CURRDATE,PTDEDTCL
            MOVE      CURRDATE,PTDEUDAT
            MOVE      CTIMEIS,PTDEUTIM
            MOVE      WBSEUID,PTDEUUID      * WEB user id
            CALL      UPPTDET1
          ENDIF
.
          GOTO      LRCP9800
.
. ******************************************************************************
LRCP4000  MOVE      ONE,COUNTER
.
          WHILE     COUNTER < 500
            PACK      ASGDEB[COUNTER],ASGDEB[COUNTER],SP70
            PACK      PRTINV[COUNTER],PRTINV[COUNTER],SP70
            PACK      INVNUM[COUNTER],INVNUM[COUNTER],SP70
.
            MOVE      ZERO,FORM8
            MOVE      INVNUM[COUNTER],FORM8
            IF        FORM8<>0
              MOVE      FORM8,KEY8
              CALL      RDPRIN1
              IF        OVRCD=0
                MOVE      SP70,KEY1
                MOVE      ASGDEB[COUNTER],KEY1
                MATCH     "1",KEY1
                IF        @EQUAL
                  CALL      RASG0000              * Reassign debt
                ENDIF
.
                MOVE      SP70,KEY1
                MOVE      PRTINV[COUNTER],KEY1
                MATCH     "1",KEY1
                IF        @EQUAL
                  IF        PRUROSTD <>0
                    MOVE      "017",KEY3         * Pooling Type
                    CALL      PNTX0000            * reprint invoice
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
            ADD       ONE,COUNTER
          DO
.
          GOTO      LRCP9800
.
. ******************************************************************************
.
LRCP9000  MOVE      "Receipts Processing List",WEBTITLE
          CALL      CURPER00   * Determine Current Period
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,LRCP9999
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      LRCP9999
.
LRCP9200  MOVE      "Record does not exist.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      LRCP9999
LRCP9800  MOVE      ZERO,EXIT
          GOTO      LRCP9999
.
LRCP9999  RETURN
+
.------------------------------------------------------------
.         Setup fields for the Unreconciled invoices file
.------------------------------------------------------------
SETU0000  CALL      CLPRIURE             * Clear variables
.
          MOVE      PRINNUMB,PRURINVN    * Invoice number
          MOVE      PRINDEBT,PRURDEBT    * Debtor number
          MOVE      PRINSCAN,PRURSCAN    * Scan flag
          MOVE      "0",PRURSTAT         * New status
.
          MOVE      PRINPRAC,PRURMPRA    * Medical practice
          MOVE      PRINDOCT,PRURSDOC    * Service doctor
          MOVE      PRINCLAM,PRURCLMN    * Claim code
          MOVE      PRHDHFND,PRURHFND    * Health fund code
.
          MOVE      PRINITOT,PRURINVT    * Invoice total
          MOVE      TOTPAID,PRURPAYM     * Patient payments +

          MOVE      PRINCNTT,PRURJRNL    * Credit Notes +
          ADD       PRINJAMT,PRURJRNL    * Journals = amount outstanding
          ADD       PRINGSTJ,PRURJRNL    * Journal GST = amount outstanding
          MOVE      FORM12P2,PRUROSTD    * Outstanding amount
.
          CALL      IBACLOCK
          PACK      PRURCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PRURCDAT
          MOVE      CTIMEIS,PRURCTIM
          MOVE      WBSEUID,PRURCUID        * WEB user id
.
          PACK      PRURUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PRURUDAT
          MOVE      CTIMEIS,PRURUTIM
          MOVE      WBSEUID,PRURUUID        * WEB user id
.
SETU9999  RETURN
+
.------------------------------------------------------------
. Format Patient Name in Title Text
.------------------------------------------------------------
PATNAC00  CLEAR     DIM80
          MOVE      SP70,PATFNAME
          REP       UPPLOW,PSNAME
          APPEND    PSNAME,DIM80
          PACK      NAME35,PTITL,SP70
          CALL      NAMSTR00
          PACK      NAME35,PGNAME,SP70
          CALL      NAMSTR00
          PACK      NAME35,PSNAME,SP70
          APPEND    SP70,DIM80
          RESET     DIM80
          MOVE      DIM80,PATFNAME
          STRIP     PATFNAME
          RETURN
.
.------------------------------------------------------------------------
. Format Patient Name with Second Name Initial
.------------------------------------------------------------------------
PATINT00  CLEAR     DISPNAME
          MOVE      PSNAME,SAVPSNAM
.
..        REP       "' ",PSNAME
          REP       "#" ",PSNAME
..        REP       "' ",PGNAME
          REP       "#" ",PGNAME
          MOVE      SP70,PATFNAME
          REP       UPPLOW,PSNAME
          APPEND    "<b>",DISPNAME
          APPEND    PSNAME,DISPNAME
          APPEND    "</b>",DISPNAME
          PACK      NAME35,PTITL,SP70
          CALL      NAMSTR00
.
          MOVELPTR  PGNAME,LENPTR
          MOVE      ONE,COUNT
PATINT10  BUMP      PGNAME
          GOTO      PATINT99 IF EOS
          ADD       ONE,COUNT
          MATCH     SP1,PGNAME
          GOTO      PATINT10 IF NOT EQUAL
          BUMP      PGNAME
          ADD       ONE,COUNT
          RESET     PGNAME
          SETLPTR   PGNAME,COUNT
          PACK      NAME35,PGNAME,SP70
          CALL      NAMSTR00
          RESET     PGNAME,LENPTR
          RESET     PGNAME
.
          APPEND    SP70,DISPNAME
          RESET     DISPNAME
          MOVE      DISPNAME,PATFNAME
          STRIP     PATFNAME
.
          MOVE      SAVPSNAM,PSNAME         * Original value with quotes etc
.
PATINT99  RETURN
.
.*****************************************************************************
. Write the Invoice number to the COMWEB70 polling table to reprint
. invoice or reassign debt
.*****************************************************************************
PNTX0000  MOVE      ZERO,FORM10
.
          PACK      KEY10,Z70
          CALL      RSIBPOL1
          CALL      RPIBPOL1
          BRANCH    OVRCD,PNTX1000
.
          MOVE      IBPLUNIQ,FORM10
PNTX1000  ADD       ONE,FORM10
.
          MOVE      FORM10,IBPLUNIQ
          MOVE      KEY3,IBPLTYPE     * Pooling Type
          MOVE      PRINDEBT,IBPLURNO
          MOVE      SP70,IBPLVISN
          PACK      IBPLSKEY,PRINNUMB,SELPRINT,WBSEUID,SP70
          MOVE      SP70,IBPLSPAR
.
          MOVE      FORM10,KEY10
          CALL      RAIBPOL1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            CALL      WRIBPOL1
            TRAPCLR   IO
            BRANCH    OVRCD,PNTX1000
          ELSE
            GOTO      PNTX1000
          ENDIF
.
PNTX9999  RETURN
.
. ******************************************************************************
.         Bulk re-assign debt
. ******************************************************************************
RASG0000  MOVE      FORM8,INVOICEN        * Invoice number
          MOVE      FORM8,KEY8
          CALL      RDPRIN1
          BRANCH    OVRCD,RASG9999
.
          MOVE      PRINDEBT,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,RASG9999
          CALL      RDPMPX21
          BRANCH    OVRCD,RASG9999
.
          MOVE      PRINNUMB,KEY8
          PROC      PRIUPURE              * Write/Update Unreconciled inv.file
.
          MOVE      PRINNUMB,KEY8
          CALL      RDPRURE1
          IF        OVRCD=0
            MOVE      "1",PRURSTAT        * Processed
            CALL      UPPRURE1
          ENDIF
.
          CALL      WRRDB000              * Write to Reassign debt file
          CALL      WRPDR000              * Write to Patient Debt Reg.file
.
          IF        PRINSCAN=1
            PROC      FLAGDEBP            * flag Outstanding Debt
          ENDIF
.
RASG9999  RETURN
.
.------------------------------------------------------------
.         Write record to Reassign Debt table
.------------------------------------------------------------
WRRDB000  PACK      REASMOVE,REASMOVE,SP70
          PACK      DEBTAGNT,DEBTAGNT,SP70
.
          MOVE      ONE,FORM2
.
.     Bulk New movement should not have record in patrasaf, double check anyway
.
          MATCH     "2",FILTAUTO
          GOTO      WRRDB200 IF EQUAL      * Bulk New movement
.
.         Reprocess Previous
.
          PACK      KEY10,PRINNUMB,Z70
          CALL      RSPRRAS1
WRRDB100  CALL      RPPRRAS1
          BRANCH    OVRCD,WRRDB400
.
          MATCH     PRINNUMB,PRRAINVN      * Same invoice ?
          GOTO      WRRDB400 IF NOT EQUAL
          MATCH     "1",PRRADELE       * Deleted ?
          GOTO      WRRDB400 IF EQUAL
.
          MOVE      PRRARMOV,REASMOVE       * save previous Reason of Movement
          MOVE      PRRADBAG,DEBTAGNT       * save previous Debt Collec.Agency
.
.         Get the last counter
.
WRRDB200  PACK      KEY10,PRINNUMB,Z70
          CALL      RSPRRAS1
          CALL      RPPRRAS1
          IF        OVRCD=0
            MATCH     PRINNUMB,PRRAINVN      * Same invoice ?
            IF        @EQUAL
              MOVE      PRRACNTN,FORM2
            ENDIF
          ENDIF
.
WRRDB400  MOVE      FORM2,PRRACNTN
          PACK      KEY10,PRINNUMB,PRRACNTN,SP70
          CALL      RDPRRAS1
          IF        OVRCD=0
            ADD       ONE,FORM2
            GOTO      WRRDB400
          ENDIF
          PACK      CURRDATE,CCC,CYY,CMM,CDD  * write a new "patrasaf" record
          REP       " 0",CURRDATE
          MOVE      FORM2,PRRACNTN
          MOVE      PRINNUMB,PRRAINVN
          MOVE      FORM2,PRRACNTN
          MOVE      PRUROSTD,PRRAOUST       * Outstanding amount
          MOVE      REASMOVE,PRRARMOV       * Reason of Movement
          MOVE      DEBTAGNT,PRRADBAG       * Debt Collection Agency (code)
          MOVE      PRUROSTD,PRRAPPOR       * Patient portion=Outstanding amt
          MOVE      "0",PRRADELE            * set Deleted flag off
.
          CALL      IBACLOCK
          MOVE      CURRDATE,PRRACDAT
          MOVE      CTIMEIS,PRRACTIM
          MOVE      WBSEUID,PRRACUID        * WEB user id
.
          PACK      CURRDATE,PRRAUDAT
          MOVE      CTIMEIS,PRRAUTIM
          MOVE      WBSEUID,PRRAUUID        * WEB user id
          CALL      WRPRRAS1
WRRDB999  RETURN
+
.------------------------------------------------------------
.         write to Patient Debt Reg. file
.------------------------------------------------------------
WRPDR000  MOVE      "4",PTDESYST            * PP System
          PACK      KEY10,THREE,PRINNUMB,PTDESYST,SP10
          CALL      RDPTDET1
          IF        OVRCD = 1
            MATCH     SP3,DEBTAGNT          * assigned to Debt Collect.Agency ?
            GOTO      WRPDR999 IF EQUAL     * no - this debt has been cleared
.
            CALL      CLPATDET
            MOVE      "3",PTDETYPE
            MOVE      PRINNUMB,PTDEINVN
            MOVE      DEBTAGNT,PTDEAGNT     * Debt Collection Agency (code)
            MOVE      CURRDATE,PTDECDAT
            MOVE      CTIMEIS,PTDECTIM
            MOVE      WBSEUID,PTDECUID      * WEB user id
            MOVE      PRINDEBT,PTDEURNO
            MOVE      "4",PTDESYST          * System
            CALL      WRPTDET1
            MOVE      ONE,KEY1
          ELSE
            MOVE      ZERO,KEY1
            MATCH     SP3,DEBTAGNT          * assigned to Debt Collect.Agency ?
            IF        @EQUAL
              MOVE      CURRDATE,PTDEDTCL
            ELSE
              MOVE      SP8,PTDEDTCL
              MOVE      DEBTAGNT,PTDEAGNT   * Debt Collection Agency (code)
              MOVE      ONE,KEY1
            ENDIF
            MOVE      CURRDATE,PTDEUDAT
            MOVE      CTIMEIS,PTDEUTIM
            MOVE      WBSEUID,PTDEUUID      * WEB user id
            CALL      UPPTDET1
          ENDIF
.
          MATCH     "1",PMPXSN14
          IF        !@EQUAL
            MOVE      KEY1,PMPXSN14       * set Debt Collection flag
            CALL      UPPMPX21            * update PMI Extention record
          ENDIF
.
WRPDR999  RETURN
.
.-----------------------------------------------------------
. Miscellaneous
.-----------------------------------------------------------
...MISC0000  BRANCH    FLDITMNO,MISC0010
.
...          WRITE     HTMLFILE;"Invalid IBA Tag";
...          GOTO      MISC9999
.
...MISC0010  WRITE     HTMLFILE;PRCNAUTO;    * auto generate debtor number
...          GOTO      MISC9999
.
...MISC9999  RETURN
+
.------ I/O Routines for temp files ------
.
RATMPR1   MOVE      ZERO,OVRCD
          RESET     KEY8
          READ      PRITM1XX,KEY8;ANS
          GOTO      OVERCOND IF OVER
          RETURN
.
RSTMPR1   MOVE      ZERO,OVRCD
          RESET     KEY8
          READ      PRITM1XX,KEY8;;
          RETURN
.
RDTMPR1   MOVE      ZERO,OVRCD
          RESET     KEY8
          READ      PRITM1XX,KEY8;DTEMPUNQ,TEMPDEB,DTEMPSCN
          GOTO      OVERCOND IF OVER
          MOVE      DTEMPUNQ,TEMPUNQ
          MOVE      DTEMPSCN,TEMPSCN
          RETURN
.
RKTMPR1   MOVE      ZERO,OVRCD
          RESET     KEY8
          READKS    PRITM1XX;DTEMPUNQ,TEMPDEB,DTEMPSCN
          GOTO      OVERCOND IF OVER
          MOVE      DTEMPUNQ,TEMPUNQ
          MOVE      DTEMPSCN,TEMPSCN
          RETURN
.
RPTMPR1   MOVE      ZERO,OVRCD
          RESET     KEY8
          READKP    PRITM1XX;DTEMPUNQ,TEMPDEB,DTEMPSCN
          GOTO      OVERCOND IF OVER
          MOVE      DTEMPUNQ,TEMPUNQ
          MOVE      DTEMPSCN,TEMPSCN
          RETURN
.
WRTMPR1   MOVE      TEMPSCN,DTEMPSCN
          MOVE      ZERO,OVRCD
          RESET     KEY8
          WRITE     PRITM1XX,KEY8;KEY8,TEMPDEB,DTEMPSCN
          RETURN
.
UPTMPR1   MOVE      TEMPUNQ,DTEMPUNQ
          MOVE      TEMPSCN,DTEMPSCN
          UPDATE    PRITM1XX;DTEMPUNQ,TEMPDEB,DTEMPSCN
          RETURN
.
DETMPR1   RESET     KEY8
          DELETE    PRITM1XX,KEY8
          RETURN
.
RATMPR12  MOVE      ZERO,OVRCD
          RESET     KEY18
          READ      PRITM1XY,KEY18;ANS
          GOTO      OVERCOND IF OVER
          RETURN
.
RSTMPR12  MOVE      ZERO,OVRCD
          RESET     KEY18
          READ      PRITM1XY,KEY18;;
          RETURN
.
RDTMPR12  MOVE      ZERO,OVRCD
          RESET     KEY18
          READ      PRITM1XY,KEY18;DTEMPUNQ,TEMPDEB,DTEMPSCN
          GOTO      OVERCOND IF OVER
          MOVE      DTEMPUNQ,TEMPUNQ
          MOVE      DTEMPSCN,TEMPSCN
          RETURN
.
RKTMPR12  MOVE      ZERO,OVRCD
          RESET     KEY18
          READKS    PRITM1XY;DTEMPUNQ,TEMPDEB,DTEMPSCN
          GOTO      OVERCOND IF OVER
          MOVE      DTEMPUNQ,TEMPUNQ
          MOVE      DTEMPSCN,TEMPSCN
          RETURN
.
RPTMPR12  MOVE      ZERO,OVRCD
          RESET     KEY18
          READKP    PRITM1XY;DTEMPUNQ,TEMPDEB,DTEMPSCN
          GOTO      OVERCOND IF OVER
          MOVE      DTEMPUNQ,TEMPUNQ
          MOVE      DTEMPSCN,TEMPSCN
          RETURN
.
DETMPR12  RESET     KEY18
          DELETE    PRITM1XY,KEY18
          RETURN
.
.  Dummy Routine - required by PATCATBI
.
INITIVAR
NXTTRAN1
PATIVMES
PATCALF   
PROCMISC
PRTCLMS
WRITETRN
PRTINVTL
ISUG0000
CKTL0000
PRLN0000
ENDPRT00
PEOL0000
PROACC00
PRTIPROV
SETDEF00
TAIL      RETURN
.------------------------------------------------------------------------------
          INC       IBAWEBCD
.
          INC       PATMASTM
          INC       PATMSXTM
          INC       PMSPX2TM
...          INC       PRIDBTTM
...          INC       PRIDBTIO/INC
.
          INC       PATDOCCD
          INC       PATDOCTM
          INC       PMSHCPTM
          INC       PMSHCGTM
          INC       PATMCHRD              * Miscellaneous Charges read routine
          INC       GETBFEES
          INC       GETCNEFF
          INC       GETTFEES
          INC       TFILENAM
          INC       PATNAMCD
          INC       APSMASIO/INC
          INC       COMDEPIO/INC
          INC       IBAGEDIO/INC
          INC       IBAGSTIO/INC
          INC       IBATMDIO/INC
          INC       IBAPOLIO/INC
.
          INC       MRTMASIO/INC
          INC       NHIMASIO/INC
          INC       NHIETHIO/INC
          INC       MLTCFNIO/INC
          INC       NZPEXTIO/INC
          INC       NZPRDTIO/INC
          INC       NZPBFEIO/INC
          INC       NZPCFNIO/INC
          INC       NZPCMTIO/INC
          INC       NZPFIGIO/INC
          INC       NZPIBRIO/INC
          INC       NZPMCHIO/INC
          INC       NZPMXCIO/INC
          INC       NZPPFEIO/INC
          INC       NZPPICIO/INC
          INC       NZPRBRIO/INC
          INC       NZPRFNIO/INC
          INC       NZPFINIO/INC
          INC       NZPSPRIO/INC
          INC       NZPTFEIO/INC
          INC       NZPIVBIO/INC
          INC       NZPRVBIO/INC
          INC       OPRARDIO/INC
          INC       OPRDEAIO/INC
          INC       OPRSESIO/INC
          INC       OUTPREIO/INC                 * for PATSRCH
          INC       OUTSITIO/INC
.
          INC       PATAFEIO/INC
          INC       PATALRIO/INC
          INC       PATASDIO/INC
          INC       PATELGIO/INC
          INC       PATBFEIO/INC                 * bed fee file
          INC       PATCMXIO/INC
          INC       PATCTFIO/INC
          INC       PATCFAIO/INC
          INC       PMSCIDIO/INC
          INC       PMSUCHIO/INC
          INC       PMSUCDIO/INC
          INC       PATDGWIO/INC
          INC       PATDO1IO/INC
          INC       PATDSCIO/INC                 * discharge file
          INC       PATECDIO/INC
          INC       PATECOIO/INC
          INC       PATFINIO/INC                 * financial statistics file
          INC       PATFMOIO/INC
          INC       PATDTRIO/INC                 * patient transaction file
          INC       PATFX1IO/INC
          INC       PATFN1IO/INC
          INC       PATFN2IO/INC
          INC       PATGSRIO/INC
          INC       PATHDFIO/INC
          INC       PATHLFIO/INC
          INC       PATHTRIO/INC
          INC       PATIBLIO/INC
          INC       PATICUIO/INC
          INC       PATIN1IO/INC
          INC       PATINVIO/INC                 * invoice file
          INC       PATIOVIO/INC
          INC       PATITMIO/INC                 * item file
          INC       PATLDFIO/INC
          INC       PATLSDIO/INC
          INC       PATMA1IO/INC
          INC       PATMCHIO/INC                 * miscellaneous charges file
          INC       PATMESIO/INC
          INC       PATMI1IO/INC
          INC       PATOVBIO/INC
          INC       PATPERIO/INC
          INC       PATPGRIO/INC
          INC       PATPR1IO/INC
          INC       PATRATIO/INC                 * Rate file
          INC       PATRBLIO/INC
          INC       PATRCAIO/INC                 * rate audit file
          INC       PATRFNIO/INC
          INC       PATSRBIO/INC
          INC       PATTFEIO/INC
          INC       PATTRNIO/INC                 * bed transfer file
          INC       PATVISIO/INC
          INC       PATVENIO/INC
          INC       PMSHATIO/INC
          INC       PMSVX1IO/INC
          INC       PATWR1IO/INC
          INC       VISPAYIO/INC
.
          INC       PATCMTIO/INC
          INC       PMSCMTIO/INC
          INC       PMSHCGIO/INC
          INC       PMSHCPIO/INC
          INC       PMSHCLIO/INC
          INC       PMSCNOIO/INC
          INC       PATHSPIO/INC
          INC       PMSCCDIO/INC   * Concession Card Details
          INC       PMSIDEIO/INC
          INC       PMSSGAIO/INC
          INC       PMSMTIIO/INC
          INC       PMSMPRIO/INC
          INC       PMSPX2IO/INC
          INC       PMSSINIO/INC
.
          INC       PRIRASIO/INC
          INC       PRIUREIO/INC
          INC       PATDETIO/INC
          INC       PRIALSIO/INC                 * Access to All Med Prac
          INC       PRIAUIIO/INC
          INC       PRIBULIO/INC
          INC       PRICNOIO/INC
          INC       PRIDOCIO/INC
          INC       PATDRGIO/INC
          INC       PRIDTRIO/INC
          INC       PRIECTIO/INC
          INC       PRIEXCIO/INC                 * execption charges file
          INC       PRIFIGIO/INC
          INC       PRIFINIO/INC
          INC       PRIGRPIO/INC
          INC       PRIHDBIO/INC
          INC       PRIHISIO/INC
          INC       PRILHIIO/INC                 * fin. letter history file
          INC       PRIFCIIO/INC
          INC       PRIFLTIO/INC                 * fin. letter file
          INC       PRIHOLIO/INC
          INC       PRIHREIO/INC
          INC       PRIHTRIO/INC
          INC       PRIINVIO/INC
          INC       PRIINVIT/INC
          INC       PRIITMIO/INC
          INC       PRIMABIO/INC
          INC       PRIMGPIO/INC
          INC       PRIMULIO/INC
          INC       PRIPRAIO/INC
          INC       PRISECIO/INC                 * Access to Indiv Med Prac
          INC       PRISPTIO/INC                 * spec. path. test file
          INC       PRISTAIO/INC
          INC       PRITESIO/INC
          INC       PRIVAFIO/INC
          INC       PRIWCOIO/INC
          INC       HICITIIO/INC
.
          INC       RCPBNKIO/INC
          INC       RCPBDTIO/INC
          INC       RCPREGIO/INC
          INC       RCPDTEIO/INC
          INC       PMSEDGIO/INC       * Effective DRG Dates
          INC       PATDDHIO/INC
.
          INC       WEBIMCIO/INC
          INC       WEBB2BIO/INC
.
          INC       CLPRIURE
          INC       PRIUPURE
          INC       DAYOFWEK
          INC       CALCAGE
          INC       CHKCMXPT
          INC       CLNHIMAS
          INC       CLNZPPIC
          INC       CLPRIHTR
          INC       CLPRIDTR
          INC       CLPATDTR
          INC       CLPATMAS
          INC       CLPMSPX2
          INC       CMGETTHR
          INC       CMXMATRX
          INC       NAMSTRCD
          INC       NHOSPDAY
          INC       PABXBILL
          INC       PATCATBI
          INC       PATITMRD
          INC       PATCOMN3
          INC       PATCMSTP
          INC       PATGNCMX
          INC       PRICALFS
          INC       PRIINVHL
          INC       PRIINVTL
          INC       PRIINVPR
          INC       STEPDOWN
          INC       WEBDATCD
          INC       PATGBCRN       
          INC       VALCMXFN
          INC       CLPMSIDE
          INC       CLPATDET
.
          INC       RSHWEBCD
          INC       GETEFDRG
.
