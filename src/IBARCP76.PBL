.******************************************************************************
.* System    :   CASH RECEIPTING                                              *
.* Program   :   IBARCP76                                                     *
.* Desc      :   Cash Release                                                 *
.******************************************************************************
.* Date      :   25/8/88                                                      *
.* Author    :   Darren Jones                                                 *
.* Mods      :                                                                *
.******************************************************************************
.* V12.00.02 23/05/2025  Bella Turco   TSK 0925576                            *
.*           Recompiled for UPFAPPLN                                          *
.* V12.00.01 20/05/2025  Bella Turco   TSK 0925576                            *
.*           Recompiled for UPFAPPLN                                          *
.* V11.05.03 08/05/2025  J.Tan         TSK 0925576                            *
.*           Recompiled for UPFAPPLN - Checking for invoice number            *
.* V11.05.02 20/02/2025  J.Tan   TSK 0955356                                  *
.*           Recompiled for PATCALFN - Financial Summary details file         *
.* V11.05.01 18/12/2024  J.Tan          TSK 0945920                           *
.*           Mod to update Completion date for Future Actions Ind3=P          *
.* V11.04.02 16/02/2024  J.Tan          TSK 0942877                           *
.*           Mod checking Cash for Unattended Outpat visit(UATT0000)          *
.* V11.04.01 15/02/2024  Thanh T       TSK 0939466                            *
.*           Recompiled as PRIDTRFD changes                                   *
.******************************************************************************
.*        V11.01.02 03/11/2021  J.Tan            TSK 0913139                  *
.*                  Fixed printing Suspense Reallocation Transaction          *
.*                  RDAL2000 to check for Hospital id                         *
.*        V11.01.01 04/03/2021  Tracey Nguyen    TSK 0888639                  *
.*                  Initalized comdepaf.CMDETRSF in CDEP0000                  *
.*        V10.14.01 21/03/2019  J.Tan            TSK 0857392                  *
.*                  Changed RCP Transaction count from DIM3 to DIM5           *
.*        V10.13.04 23/10/2018  J.Tan        TSK 0848506                      *
.*                  Recompiled for PRIINVIO                                   *
.*        V10.13.03 19/09/2018  J.Tan        TSK 0863727                      *
.*                  Added Restrictive Override code                           *
.*        V10.13.02 21/08/2017  J.Tan        TSK 0859742                      *
.*                  Added ECLIPSE new fields from aaedtr                      *
.*        V10.13.01 26/07/2018  J.Tan            TSK 0848506                  *
.*                  Changed PP Doctor from DIM6 to DIM10                      *
.*                  07/08/2019  Tracey Nguyen    TSK 0848506                  *
.*                  Move SP10 to PRDTREFD instead SP6                         *
.*        V10.12.01 28/02/2018  J.Tan          TSK 0842945                    *
.*                  Mod checking for Patient portion from Reassign Debts file *
.*        V10.11.12 22/11/2017  Ania P         TSK 0261630                    *
.*                  Moved TFILNAME to CFNAMEDP in INIT0000                    *
.*        V10.11.01 20/10/2017  J.Tan          TSK 0847913                    *
.*                  Added GST Journal to Invoice balanced date Calculation    *
.*        V10.08.03 19/09/2016  J.Tan          TSK 0825952                    *
.*                  Mods Multi hospital to check for hospital ID of Csh Drawer*
.*        V10.08.02 30/08/2016  J.Tan         TSK 0819992                     *
.*                  Set RCDTALLO to 2 instead of 0 for Suspense register      *
.*        V10.08.01 19/08/2016  J.Tan          TSK 0823571                    *
.*                  Mods Multi hospital to check for hospital ID              *
.*        V10.07.04 18/02/2016  J.Tan          CAR 0814217                    *
.*                  Fixed Looping for missing visit rec, OVRCD after TRVISA   *
.*        V10.07.03 29/01/2016  J.Tan         CAR 303942                      *
.*                  Mods for Payment types                                    *
.*        V10.07.02 21/12/2015  J.Tan          CAR 0303942                    *
.*                  Mods to setup Payment code                                *
.*        V10.07.01 13/10/2015  J.Tan    CAR 310329                           *
.*                  Added PRDTEFFD - Effective date to FI for Private Practice*
.*                  FSTDATE to current date instead of trans.date             *
.*                  12/08/2016  J.Tan          CAR 314900                     *
.*                  Added HSYS1=5 for Extended Integra interface              *
.*        V10.05.02 03/10/2010  J.Tan    CAR 305994                           *
.*                  Fixed allocating payment type for SX G/L Extract(GPAY0000)*
.*        V10.05.01 05/08/2014  Peter Vela    CAR 302164                      *
.*                  Added ATDTRBRS - Rebate Reason CAT Rr                     *
.*        V10.04.02 16/04/2014  J.Tan         CAR 261630                      *
.*                  Removed pataud audit files                                *
.*                  Removed port number from temp file name                   *
.*        V10.04.01 03/03/2014  J.Tan    CAR 297922                           *
.*                  Mods to set PP Service doctor to Deposits                 *
.*        V10.02.05 05/10/2010  J.Tan    CAR 249242                           *
.*                  Mods to set Receipt Reference for SX G/L extract          *
.*        V10.02.04 05/09/2010  J.Tan    CAR 244159                           *
.*                  Fixed releasing credit card surcharge                     *
.*        V10.02.03 23/08/2010  J.Tan    CAR 244159                           *
.*                  Removed writing credit card surcharge to patfinsf         *
.*        V10.02.02 28/07/2010  J.Tan    CAR 244159                           *
.*                  Mods for Credit Card Surchage                             *
.*        V10.02.01 13/04/2011  Mike Laming      CAR 233901                   *
.*                  Added RCDTRELU (Released by) at WRTS5000                  *
.*        V10.01.02 14/01/2011  Ebon Clements    CAR 233146                   *
.*                  Added include CLPATDTR for new fields in PATDTRFD         *
.*        V10.01.01 24/11/2010  Ebon Clements    CAR 233156                   *
.*                  Added created by to journals                              *
.*        V10.00.04 04/06/2010  J.Tan            CAR 222746                   *
.*                  Mods to set parameter for running cash release            *
.*        V10.00.03 11/05/2010  J.Tan           CAR 216328                    *
.*                  New parameter HSYS1=3 for G/L Integra cash interface      *
.*        V10.00.02 19/04/2010  J.Tan        CAR 219670                       *
.*                  Mods to set date/time updated to rcpdteaf file            *
.*        V10.00.01 29/03/2010  J.Tan           CAR 174079                    *
.*                  Added new field to patfactaf for Act.Plan Inv.number      *
.*        V9.12.07  05/03/2010  J.Tan           CAR 174079                    *
.*                  Mods to remove future actions from Action plan for        *
.*                  balanced invoice after payment                            *
.*        V9.12.06  04/03/2010 J.Tan         CAR 216328                       *
.*                  Added parameter for using one char of Ledger              *
.*        V9.12.05  09/12/2009 Mike Laming   CAR 210835                       *
.*                  Added logic for Private Practice Outstanding Debt alert   *
.*        V9.12.04  05/10/2009  J.Tan        CAR 191624                       *
.*                  Mods to set the Deposit Applied date to Current date      *
.*        V9.12.03  28/07/2009 J.Tan          CAR 201847                      *
.*                  Mods Not to generate SX G/L for Suspense not allocated yet*
.*        V9.12.02  18/06/2009 J.Tan          CAR 199122                      *
.*                  Mods to set Invoice date of Deposit where invoice raised  *
.*                  prior cash relase                                         *
.*        V9.12.01  18/05/2009 J.Tan          CAR 194470                      *
.*                  Mods to set FINDATE to current date instead of trans.date *
.*        V9.11.02  28/04/2009  J.Tan     CAR 195596                          *
.*                  Added fields PTDTADPT PTDTADRB                            *
.*        V9.11.01  08/01/2009 J.Tan      CAR 178415                          *
.*                  Added Medical Practice to prifinsf                        *
.*        V9.10.05  13/08/2008 Sandra Barcham CAR 175156                      *
.*                  Fix deposit printing for name                             *
.*        V9.10.04  17/07/2008  J.Tan         CAR 170967                      *
.*                  Mods to set PTDTEFFD to current date instead of trans.date*
.*        V9.10.03  23/07/2008 J.Tan                                          *
.*                  Mods to use RCDTGLEX for SX G/L Extract                   *
.*        V9.10.02  23/05/2008 J.Tan      CAR 169149                          *
.*                  Added Date and Time invoice created/updated               *
.*        V9.10.01  05/05/2008  J.Tan         CAR 162313                      *
.*                  Added Deposit status to comdepaf file                     *
.*        V9.09.12  27/03/2008 J.Tan      CAR 161684                          *
.*                  Mods to initialise ATSPARE1 - used for indicator to       *
.*                  'Print Service Date/Time for EMR Procedures               *
.*        V9.09.11  31/01/2008  J.Tan         CAR 160482                      *
.*                  Removed checking parameer for Updating Bank Reconciliation*
.*        V9.09.10  03/01/2008  J.Tan         CAR 152740                      *
.*                  Added receipt no to invoice not found error message       *
.*        V9.09.09  19/12/2007  Jill Habasque CAR 152740                      *
.*                  Added invoice not found error message                     *
.*        V9.09.08  20/11/2007  J.Tan         CAR 154363                      *
.*                  Mods for G/L Extract SX re-allocation suspense register   *
.*        V9.09.07  28/09/2007  J.Tan         CAR 151260                      *
.*                  Mods to initialise pridtraf fields                        *
.*        V9.09.06  26/09/2007  J.Tan         CAR 150443                      *
.*                  Fixed printing Date for Suspense Transactions Report      *
.*        V9.09.05  13/09/2007  J.Tan         CAR 150156                      *
.*                  Fixed I*C on Extract file                                 *
.*        V9.09.04  31/08/2007  J.Tan         CAR 148877                      *
.*                  Fixed Debit and Credit Account for Cash payments          *
.*        V9.09.03  06/08/2007  J.Tan         CAR 140282                      *
.*                  Mods to allocate payment type for each receipt(SX Extract)*
.*        V9.09.02  27/07/2007  J.Tan         CAR 140282                      *
.*                  Mods for SX G/L Extract                                   *
.*        V9.09.01  12/06/2007  J.Tan         CAR 141511                      *
.*                  Fixed I*C on fmsbc for multi hospitals                    *
.*        V9.08.07  09/05/2007  Peter Vela    CAR SJOG ED Billing             *
.*                  Initialised new aaedtref variables                        *
.*        V9.08.06  30/04/2007  J.Tan          CAR 139572                     *
.*                  Mods to execute us1 commands for the spoolfile            *
.*        V9.08.05  07/05/2007 J.Tan  CAR 140282                              *
.*                  Mods to initialise batch no for NZ Private extract        *
.*        V9.08.04  01/03/2007  Mike Laming   CAR 130096                      *
.*                  Add a GOTO at READ3000 to bypass suspense transactions    *
.*        V9.08.03  22/02/2007 Mike Laming   CAR 119436                       *
.*                  Added PMSOSDTM for Outstanding Debt Alert indicator       *
.*        V9.08.02  07/02/2007 Davin          126848                          *
.*                  Added code for cash receipt type 4 - fund group           *
.*        V9.08.01  08/11/2006 Sandra Barcham 123247                          *
.*                  Extended file name variable to cater for 40 char path     *
.*        V9.07.01  14/09/06 J.Tan    CAR 114713                              *
.*                  Fixed payment by health fund and Insurance (trebate)      *
.*        V9.04.10  03/08/05 J.Tan    CAR 62750                               *
.*                  Removed redefined amount variables                        *
.*                  19/08/05 J.Tan    CAR 64493                               *
.*                  Added Bed type to dtr file                                *
.*        V9.04.09  05/01/2005  Jill Habasque CAR 56152                       *
.*                  Changed to use RCBNRCOD instead of rcdtrefr               *
.*        V9.04.08  30/11/2004  J.Tan      CAR 55470                          *
.*                  Added uniq id to patdtraf                                 *
.*        V9.04.07  09/11/2004  J.Tan   CAR 54893                             *
.*                  Fixed description for payment from health fund or insur.  *
.*        V9.04.06  25/10/2004  J.Tan   CAR 54434                             *
.*                  Mods to print Name instead of Reference for all systems(if*
.*                  the invoice number is blank)                              *
.*        V9.04.05  20/10/2004  J.Tan   CAR 54434                             *
.*                  Mods to print reference for system 98                     *
.*        V9.04.04  01/10/2004  J.Tan   CAR 53909                             *
.*                  Mods multi hospital to check field for 'Using FMS' from   *
.*                  hospital file                                             *
.*        V9.04.03  03/09/2004  Lina Vo CAR 53061                             *
.*                  Zero Fill date fields for bchxxxxx.txt file                *
.*        V9.04.02  30/08/2004  Lina Vo CAR 53061                             *
.*                  Fixed write fmsbcfaf and bchxxxxx.txt file                *
.*        V9.04.01  20/08/2004 J.Tan  CAR 52835
.*                  Mods to setup hospital ID for patfinsf
.*        V9.03.10  25/06/2004  J.Tan  CAR 51112                              *
.*                  Mods to check for deposit after invoiced                  *
.*                  29/06/2004  Lina Vo   CAR 50811                           *
.*                  Removed use of RCPCRDFD & IO and PATCSHFD & IO.           *
.*                  Also removed use of PATCSHFD fields.                      *
.*        V9.03.09  22/06/2004  Lina Vo  CAR 50811                            *
.*                  Removed use of RCPDEPFD & IO - now obselete.              *
.*        V9.03.08  28/05/2004  J.Tan   CAR  50035                            *
.*                  Mods to set cmdesflg to 1 for private practice            *
.*                  Initialised PTDTEPSD to zero                              *
.*        V9.03.07  04/05/2004  Lina Vo       CAR 49530                       *
.*                  Do not process cancelled receipts.                        *
.*        V9.03.06  26/04/2004  Lina Vo       CAR 49293                       *
.*                  Fixed display of UR & visit number for deposits.          *
.*                  Fixed display layout of report.                           *
.*        V9.03.05  19/04/2004  Jill Habasque CAR 49078                       *
.*                  Fixed packing of fields using RCDTINVN where size=8       *
.*        V9.03.04  18/03/2004  Jill Habasque CAR 44083                       *
.*                  Added suspense reallocation                               *
.*        V9.03.03  30/01/2004  Jill Habasque CAR 44083                       *
.*                  Changed to use new receipting tables                      *
.*        V9.03.02  12/06/2003  CAR 39875   Mike Laming                       *
.*                  Add logic to KILL (delete records) from ORACLE Temp file  *
.*        V9.03.01  12/05/2003  Henry Son   CAR 39004                         *
.*                  Fixing problem with zero percent GST code                 *
.*                  System Register 92.                                       *
.******************************************************************************
.*  V9.02.11  06/03/2003  Dean Cramer  CAR 36648                              *
.*            Initialised SAVUR and SAVAD                                     *
.*  V9.02.10  14/02/2003  Dean Cramer  CAR 22238                              *
.*            Recompiled for RCPTRNFD                                         *
.*  V9.02.09  19/12/2002  Dean Cramer defect 22393                            *
.*            Include U/R and Admission on report.                            *
.*  V9.02.08  29/08/2002  Dean Cramer                                         *
.*            Include RCCNCRDR param. to determine date range or single date  *
.*  V9.02.07  28/08/2002  Sandra Barcham                                      *
.*            Fix posting date                                                *
.*  V9.02.06  07/08/2002  Davin  SRF 9612                                     *
.*            Check if fms controlf.txt exists when assigning GL batch file   *
.*  V9.02.05  23/07/2002  Dean Cramer   srf 19844                             *
.*            Create an RCH option for date range.                            *
.*  V9.02.04  11/06/2002  J.Tan                                               *
.*            Added patrfn                                                    *
.*  V9.02.03  03/06/2002  Dean Cramer                                         *
.*            Fixed I*D on aaedtref file                                      *
.*  V9.02.02  12/03/2002  Dean Cramer                                         *
.*            Change size and sector for HDATARCP & HDATACCT                  *
.*  V9.02.01  26/02/2002  Steve Downing  SRF 12250                            *
.*            Delete batch header rec in fmsbcfaf when batch file is unused   *
.*  V5.09.B03 19.12.2000 Charles Handaya                                      *
.*            Added New System Code 92 - GST Sundry Cash Sales                *
.*  V5.09.B02 19.12.2000 Charles Handaya                                      *
.*            RCPREGFD, RCPREGIO changes                                      *
.*            (part of BAS Statement Modification)                            *
.*  V5.09.B01 18/12/2000 Steve Downing  SRF 6219                              *
.*            Fixed reading of health fund file to get health fund name       *
.******************************************************************************
.*        V5.08.05  16/08/2000  Caleb Sharman                                 *
.*                  Changed Health Fund variables to be 8 chars               *
.*        V5.08.04  29/06/2000  Steve Downing                                 *
.*                  Mods to set flag for Accounts payable                     *
.*        V5.08.03  28/06/2000  J.Tan                                         *
.*                  Recompiled for PATCALFN - to set FGSTFLAG                 *
.*        V5.08.02  06/06/2000  Tonii                                         *
.*                  Changed from KEY10 to KEY14 for the health fund file      *
.*        V5.08.01  31/05/2000  Caleb Sharman  SRF 2195                       *
.*                  Recompiled for PATAUDFD                                   *
.*        V5.08.B05 10/03/2000  J.Tan                                         *
.*                  Added effective to DTR files  & GST                       *
.*        V5.08.B04 02/03/2000  Sandra Barcham                                *
.*                  Recompiled for DEBRELCD change                            *
.*        V5.08.B03 02/03/2000  J.Tan                                         *
.*                  Recompiled for PATDTRFD                                   *
.*        V5.08.B02 21/02/2000  Steve Downing                                 *
.*                  Mods to initialise GST variables                          *
.******************************************************************************
.*        V5.07.12  10/01/2000  J.Tan                                         *
.*                  Recompiled for PRIINVIO - reading next transaction number *
.*        V5.07.11  16/11/1999  Charles Handaya                               *
.*                  Recompiled for NFMACCFD change                            *
.*                  08/10/1999  Charles Handaya                               *
.*                  Added new System of Nursing Home (HSYS7 = 1  TRNSYS = 6)  *
.*                  21/10/1999  Steve Armstrong                               *
.*                  Removed reference to CSTRTYR (not used)                   *
.*        V5.07.10  11/08/1999  Steve Armstrong                               *
.*                  Fixed writing of century from PTCHCENT to patdtraf.       *
.*                  This line had been commented out for some unknown reason. *
.*        V5.07.09  30.07.1999  Sandra Barcham                                *
.*                  Read FMCORDIS from correct position                       *
.*        V5.07.08  02/07/1999  J.Tan                                         *
.*                  Fixed private practice receipt number                     *
.*        V5.07.07  23/06/1999  Caleb Sharman                                 *
.*                  Recompiled for PATIOAUD                                   *
.*        V5.07.06  22/06/1999  Jill Habasque                                 *
.*                  Recompiled for PRISTAIO                                   *
.*        V5.07.05  09/06/1999  Greg Horvat                                   *
.*                  Recompiled for PRIINVIO - Fixed problem with direct read  *
.*        V5.07.04  25/05/1999  Steve Armstrong                               *
.*                  Fixed writing of century to DTR                           *
.*        V5.07.03  13.04.1999 Sandra Barcham                                 *
.*                  Fix control entry in fms                                  *
.*        V5.07.02  06.04.1999 Sandra Barcham                                 *
.*                  Remove RCPGLXFD                                           *
.*        V5.07.01  30.03.1999 Sandra Barcham                                 *
.*                  Fix sundry account receivable                             *
.*       V5.07.B02  21/01/1999  Nicole Harrington                             *
.*                  Mods to fix I*I on CONTROLF, controlf.txt now FCONTROL    *
.*       V5.07.B01  04/11/1998  Davin                                         *
.*                  Mods for 507 & removed old debtors                        *
.*        V5.05.01  20/04/1998  Steve Armstrong   STH                         *
.*                  Recompiled for mods to PATDPTHV & PATDPATH                *
.******************************************************************************
.*        V5.04.06  14.10.1997  Sandra Barcham   SRF 622099                   *
.*                  Fix private practice interface to g/l                     *
.*        V5.04.05  22.09.1997  Sandra Barcham   SRF 622026                   *
.*                  Recompiled for DEBRELCD (Correct for credit adjustments)  *
.*                  Removed .txt on controlf                                  *
.*        V5.04.04  14/07/1997  Howellsy                                      *
.*                  Added URDIM8                                              *
.*        V5.04.03  01.07.1997  Sandra Barcham   SRF 643148                   *
.*                  Stop overwriting batchs                                   *
.*        V5.04.02  02.04.1997  Sandra Barcham   SRF 642690 & 642469          *
.*                  For debtors invoices not fully paid pay some gst & total  *
.*        V5.04.01  01/08/1996  Steve Armstrong                               *
.*                  Fixed bugs in global recompile                            *
.*        V5.03.12  02.07.1996  Sandra Barcham   SRF 641646                   *
.*                  Overpayments to debtors invoices should not be  fully paid*
.*        V5.03.11  10.05.1996  Sandra Barcham   SRF 641546                   *
.*                  Cash receipts should be written to debfdtaf dbfdgls as 1  *
.*        V5.03.10  17/04/1996  Sandra Barcham   SRF 641390                   *
.*                  Not updating amount in debfthaf for receipt               *
.*        V5.03.09  05/03/1996  Greg Horvat      SRF 641207                   *
.*                  Fixed a problem when updating the patfinsf file with the  *
.*                  discount amount                                           *
.*        V5.03.08  04/01/1996  Greg Horvat                                   *
.*                  Removed the menu program, security key & IBA screen       *
.*                  password read on the control file                         * 
.*        V5.03.07  10/11/1995  Steve Armstrong   SRF 612596                  *
.*                  Mods to use OPPTMIS1                                      *
.*        V5.03.06  06/10/1995  Steve Armstrong                               *
.*                  Mods to subtract cash amount from PRINPEND instead of     *
.*                  adding to it                                              *
.*        V5.03.05  12/09/1995  MATT                                          *
.*                  Fixed bugs from global recompile.                         *
.*        V5.03.B4  08/08/1995  Steve Armstrong      SRF 611038               *
.*                  Fixed merchant card amounts to be written as merchant     *
.*                  card amounts in patfinsf and prifinsf instead of being    *
.*                  written as cash                                           *
.*        V5.03.B3  02/06/1995  Steve Armstrong                               *
.*                  Recompiled for RCPDEPFD                                   *
.******************************************************************************
.*               V5.01.00  10/01/94 Matt Surridge Mt Alvernia                 *
.*                          Ported from IBARCP71 release 6                    *
.*               V5.01.01  28/01/94 Matt Surridge Mt Alvernia                 * 
.*                         Added Update of doctors fee file for medisave      *
.*                         registers and doctors registers.                   *
.*               V5.01.02  02/02/94 Matt Surridge Mt Alvernia                 *
.*                         Fixed GL update.                                   *
.*                         Upgraded Standards.                                *
.*               V5.01.03  03/03/1994  Steve Armstrong                        *
.*                         Fixed update of cost centre in DTR for "93"        *
.*                         transactions                                       *
.*               V5.01.04  28/03/1994  Steve Armstrong                        *
.*                         Fixed bug in release of deposits                   *
.*               V5.01.05  03/05/94 Matt Surridge Mt Alvernia                 *
.*                         Fixed update of Journals.                          *
.*               V5.01.06  02/06/94  ROD                                      *
.*                         Access invoices across multi-databases             *
.*               V5.01.07  20/06/94 Matt Surridge                             *
.*                         Added opening of FMS files from accounting path    *
.*                         changed to get batch no. from fms control file     *
.*                         and fixed REF2 allocation to unpack into DIM2      *
.*                         and REF2.                                          *
.*               V5.01.08  28/06/94 Matt Surridge                             *
.*                         MADE FNAME DIM40                                   *
.*               V5.01.09  07/07/94  ROD                                      *
.*                         allow for 93 & 97 as patient registers             *
.*               V5.01.10  15/07/94  Sandra Barcham                           *
.*                         Fix Ageing                                         *
.*               V5.01.11  11/08/94  ROD                                      *
.*                         fix I*C on pataxeaf                                *
.*               V5.01.12  24/08/94  Sandra Barcham                           *
.*                         fix FMS directories                                *
.*        V5.02.01  02/03/1995  Greg Horvat      SRF 134196  Quote 8277       *
.*                  Changed fees invoiced to print journal charges by claim   *
.*                  code & recompiled for PATCALFN                            *
.*        V5.02.02  18/04/1995  Steve Armstrong                               *
.*                  Recompiled for changes to RCPTRNFD, RCPDEPFD & RCPCRDFD   *
.******************************************************************************
.
+
            INC       FMSSTDDF
            INC       IBASEQFD/INC                 * Sequential Numbers File
            INC       TFILEVAR/INC                 * Generate Temp File Name
            INC       WEBSECFD/INC
            INC       WEBERRFD/INC                 * Web Server Error Logging
            INC       PATCOMM/INC
            INC       PATDPTHV/INC
            INC       PATHOSFD/INC
            INC       RCPCIDFD/INC
            INC       RCPCONFD/INC
            INC       RCPBNKFD/INC
            INC       RCPBDTFD/INC
            INC       RCPDTEFD/INC
            INC       RCPREGFD/INC
.
            INC       COMDEPFD/INC
            INC       PATAXEFD/INC
            INC       PATCONFD/INC
            INC       PATCODFD/INC
            INC       PATDETFD/INC
            INC       PATDFEFD/INC
            INC       PATDRGFD/INC
            INC       PATDTRFD/INC
            INC       PATFIGFD/INC
            INC       PATFINFD/INC
            INC       PATFN1FD/INC
            INC       NZPEXTFD/INC
            INC       NZPFIGFD/INC
            INC       NZPFINFD/INC
            INC       NZPRFNFD/INC
            INC       PATFACFD/INC
            INC       PATGO1FD/INC
            INC       PATHGPFD/INC
            INC       PATHFRFD/INC
            INC       PATIN1FD/INC
            INC       PATINVFD/INC
            INC       PATJRNFD/INC
            INC       PATMA1FD/INC
            INC       PATMI1FD/INC
            INC       PATRFNFD/INC
            INC       PATRFGFD/INC
            INC       PATVISFD/INC
            INC       PMSVX1FD/INC
            INC       PATHSPFD/INC
            INC       PATRASFD/INC
.
            INC       OUTSITFD/INC
            INC       OUTBOAFD/INC
            INC       OUTDTRFD/INC
            INC       AAEDTRFD/INC
.
            INC       PRIAUDFD/INC
            INC       PRICONFD/INC
            INC       PRIDTRFD/INC
            INC       PRIFINFD/INC
            INC       PRIFIGFD/INC
            INC       PRIINVFD/INC
            INC       PRISTAFD/INC
            INC       PRIJRNFD/INC
.
            INC       IBABATFD/INC
            INC       IBAGEDFD/INC
            INC       IBAGSTFD/INC
.
.           INC       ARSGLIFD/INC
.           INC       DDP029FD/INC
.           INC       DDP030FD/INC
.           INC       DDP031FD/INC
            INC       FMSAMAFD/INC
            INC       FMSBCFFD/INC
            INC       FMSBNKFD/INC
            INC       FMSCAFFD/INC
            INC       FMSCONFD/INC
            INC       FMSCSAFD/INC
            INC       FMSLMAFD/INC
            INC       FMSLMCFD/INC
.
            INC       DEBTCRFD/INC
            INC       DEBDBTFD/INC
            INC       DEBITMFD/INC
            INC       DEBFTHFD/INC
            INC       DEBFDTFD/INC
.
. Temp file to store receipt numbers for SX Extract
.--------------------------------------------------
XTRTMPA1  IFILE     SQL, FIXED=15, KEY="U1-12"
.
XTMRNUMB  DIM       12      1      Receipt Number
XTMRSPAR  DIM       2       13     Spare
.EOR                        15
.
. Temp file to accumulate control totals
.---------------------------------------
APSTMPA1  IFILE     SQL, FIXED=39, KEY="U1-2,3-14"
.
APTMLED   DIM       2       2      1
APTMACC   DIM       12      12     3
APTPACC   DIM       12      12     15
APTRESP   DIM       4       4      27
APTMAMT   FORM      12.2    8      31 
.
.End of Record                     39
.
. Temp file for suspense receipts
.---------------------------------------
SUSTMPA1  IFILE     SQL, FIXED=19, KEY="U18-18,1-12,13-17"
.
RECEIPTN  DIM       12      12     1
TRNCOUNT  DIM       5       5      13
REALLOCT  DIM       1       1      18
.End of Record                     19
.
MAKE      INIT      "isbuild "
KILL      INIT      "iserase "
INDEX     INIT      " 39 U1-2,3-14"
INDEX2    INIT      " 19 U18-18,1-12,13-17"
INDEX3    INIT      " 15 U1-12"
MAKETMP   DIM       80
KILLTMP   DIM       80
TMPFILE   DIM       8
TMPFILE2  DIM       8
TMPFILE3  DIM       8
ENDSEC    FORM      5
SAVETYPE  DIM       2
SUSFLAG   FORM      1
SVBCBASC  DIM       3
SKEY40    DIM       40
.
AMOUNT    FORM      12.2
.
BATCH     DIM       5
BDTAMNT   FORM      12.2
DTEAMNT   FORM      12.2
DRAWNAME  DIM       40
.
CASHIER   DIM       6
CONTRFLG  FORM      1
CODEPY    INIT      "Py"
.
DCODE     FORM      1       
DEPOS93   FORM      1                     * System Code 93 Deposit Flag
DIM20     DIM       20
DIM30     DIM       30
DIM50     DIM       50
DRAWERF   DIM       6 
DRAWERT   DIM       6
.
ENDFILE   FORM      1
EXT       INIT      ".txt"
.
FMSFLAG   FORM      1
FGSTFLAG  FORM      1
FILENAME  DIM       60
FILENAM   DIM       8
FNAME     DIM       60
FORM8     FORM      8
FORM8P2   FORM      8.2
FORM12P2  FORM      12.2
SAVAMNT   FORM      12.2
FROMDATE  DIM       8
FROMDATD  DIM       10
FSTAMNT   FORM      12.2
FSTDATE   DIM       8
FSTWORK   FORM      7.2
.
GLACCT    DIM       14
GLAMNT    FORM      12.2
GLBANK    DIM       12
GLGSTC    DIM       6
GLREG     DIM       3
GLSACCT   DIM       12
GLSLEDG   DIM       2
GLTYPE    DIM       1
.
LINECNT   FORM      2
LEDGERN   DIM       2
ACCOUNT   DIM       12
.
MRCNNOHS  FORM      2
NOINVFLG  FORM      1
PAYMCODE  DIM       3
PAGENO    FORM      8
PASSWORD  DIM       8
PRINTOT   FORM      1
RFNFLAG   FORM      "0"
REPUNIQ   INIT      "yzxywxvwuvtustrsqrpqopnomnlmkljkijhighfgefdecdbcabZa":
                    "YZXYWXVWUVTUSTRSQRPQOPNOMNLMKLJKIJHIGHFGEFDECDBCAB9A":
                    "8978675645342312 1"
.
RDATE     DIM       8
RDD       FORM      2
RMM       FORM      2 
RCC       FORM      2
RYY       FORM      2
.
SAVAD     DIM       8
SAVDTEKY  DIM       17
SAVUR     DIM       8
SEC1      FORM      "00001"
.
TAXAMNT   FORM      12.2
TCC       DIM       2
TDD       DIM       2
TMM       DIM       2
TODATE    DIM       8
TODATD    DIM       10
TOTAMT    FORM      10.2
TOTALAMT  FORM      12.2
TOTALOUT  FORM      12.2
TOTDIS    FORM      10.2
USEFMS    FORM      1
TRNSYS    FORM      2
TYY       DIM       2
.
USERID    DIM       10
XXDPATH   DIM       120
ZEDS      INIT      "zzzzzzzzzzzz"
.
IBCNMHOS  FORM      1
INVREF    DIM       12
INVDAT    DIM       8 
TRANLINE  FORM      3 
.
PRGID     INIT      "IBARCP76"
PRGNAM    INIT      "Cash Release"
VERSION   INIT      "V12.00.02"
+
.**************************************************************************
.*                              MAINLINE                                  *
.*                            Controlling Logic                           *
.**************************************************************************
ML0000      CALL      INIT0000               * initialization
            BRANCH    EXIT,ML9999
.
ML1000      CALL      OPTN0000               * date / cashier / OK ?
            BRANCH    EXIT,ML9999
.
.           Lock Cash release program
.
            MOVE      PORT,RCCNCSHL
            PACK      RCCNCSHU,USERID,SP10
            WRITAB    CONTROLF,HUND08;*97,RCCNCSHL,*99,RCCNCSHU
.
ML2000      CALL      READ0000               * start a receipt
            BRANCH    ENDFILE,ML2500
            CALL      WRTS0000               * update sub-systems
            BRANCH    EXIT,ML2000            * invoice record not found
            CALL      TOT0000                * consolidate gl trx
            CALL      PRT0000                * print transaction
.
            GOTO      ML2000
.
ML2500      MOVE      ZERO,ENDFILE
            PACK      KEY18,ONE,SP70         * start suspense reallocation
            CALL      RSRCDTE4
.
ML3000      CALL      RDAL0000               
            BRANCH    ENDFILE,ML4000
            CALL      WRTS0000               * update sub-systems
            BRANCH    EXIT,ML3000            * invoice record not found
            CALL      TOT0000                * consolidate gl trx
            CALL      PRT0000                * print transaction
.
            GOTO      ML3000
.
ML4000      CALL      PRTT0000               * print totals
            CALL      PRTS0000               * print suspense 
            CALL      WRTG0000               * write end of gl batch
            CALL      EXCUS000               * Execute us1 command
            CALL      GPAY0000               * Process Extract for each payment
.
ML9999      PACK      KILLTMP,KILL,TMPFILE2
            EXECUTE   KILLTMP,TASKID
            PACK      KILLTMP,KILL,TMPFILE
            EXECUTE   KILLTMP,TASKID
.
            PACK      RCCNCSHL,ZERO,ZERO
            MOVE      SP70,RCCNCSHU
            WRITAB    CONTROLF,HUND08;*97,RCCNCSHL,*99,RCCNCSHU
.
            CHAIN     PGM
+
.**************************************************************************
.*                              INIT0000                                  *
.*                            Initialization                              *
.**************************************************************************
.
INIT0000    CALL      TFILENAM
            MOVE      TFILNAME,CFNAMEDP          * Must preceed CALL PATDPATH
            CALL      PATDPATH
            CALL      DISPHEAD
            MOVE      SP70,BATCH
            MOVE      ZERO,PRINTOT
.
            DISPLAY   *P56:24,*EL,"Opening ":
                      *P64:24,"rcpcidaf";
            OPEN      RCPCIDA1,"rcpcidaf"
.
            DISPLAY   *P64:24,"rcpbnkaf";
            OPEN      RCPBNKA1,"rcpbnkaf"
.
            DISPLAY   *P64:24,"rcpdteaf";
            OPEN      RCPDTEA1,"rcpdteaf"
            OPEN      RCPDTEA2,"rcpdteaf"
            OPEN      RCPDTEA4,"rcpdteaf"
.
            DISPLAY   *P64:24,"rcpregaf";
            OPEN      RCPREGA1,"rcpregaf"
            OPEN      RCPBDTA1,"rcpbdtaf"
.
            DISPLAY   *P64:24,"controlf"; 
            OPEN      CONTROLF,"controlf"
.
            DISPLAY   *P64:24,"patrasaf";
            OPEN      PATRASA1,"patrasaf"
.
            READ      CONTROLF,ZERO;*43,IBCNMHOS
            READ      CONTROLF,TEN9;*212,CFEETYP
            READ      CONTROLF,THIRTY4;*166,PRCNGLIN
            READ      CONTROLF,THIRTY6;*86,HSYS1,HSYS2,HSYS3:
                                       HSYS4,HSYS5,HSYS6,HSYS7,HSYS8,HSYS9:
                                       HSYS10,HSYS11,HSYS12,HSYS13,HSYS14:
                                       HSYS15,HSYS16,HSYS17,HSYS18,HSYS19:
                                       HSYS20,*113,HJNL,*145,HBATCH:
                                       *151,HPRTREC,*152,RCCNPDOC,RCCNODO1:
                                       RCCNODO2,RCCNPAED,RCCNANTH:
                                       *167,RCCNMERG,*176,RCCNUPBR:
                                       *218,RCCNCRDR:
                                       *221,RCCNORUH:
                                       *238,RCCNLEDG
.
            READ      CONTROLF,SEVENTY7;*240,PTCNAXEU
            READ      CONTROLF,SEVENTY9;*68,PTCNMFEE,PTCNJFEE
            READ      CONTROLF,HUND08;*1,HDATARCP,*41,HDATACCT
            READ      CONTROLF,HUND14;*249,PTCNDFUP

.
            DISPLAY   *P64:24,"ibagedaf"; 
            OPEN      IBAGEDA1,"ibagedaf"
.
            DISPLAY   *P64:24,"ibagstaf"; 
            OPEN      IBAGSTA1,"ibagstaf"
.
            DISPLAY   *P64:24,"pathspaf"; 
            OPEN      PATHSPA1,"pathspaf"
.
            OPEN      PATCODE1,"patcodes"
            OPEN      PATFACT1,"patfactf"
.
. ---- patient management ----
.
            IF        RCCNUPBR=1
              OPEN      FMSBNKA1,"fmsbnkaf"
            ENDIF
.
            COMPARE   "1",HSYS2
            GOTO      INIT0600 IF NOT EQUAL
.
            DISPLAY   *P64:24,"pmsvx1af";
            OPEN      PMSVX1A1,"pmsvx1af"
            DISPLAY   *P64:24,"patinvrf";
            OPEN      PATINVR1,"patinvrf"
            DISPLAY   *P64:24,"patdtraf";
            OPEN      PATDTRA1,"patdtraf"
            DISPLAY   *P64:24,"patvisaf"; 
            OPEN      PATVISA1,"patvisaf"
.
            DISPLAY   *P64:24,"patfinsf";
            OPEN      PATFINS1,"patfinsf"
            OPEN      PATFIGA1,"patfigaf"
            OPEN      NZPFINA1,"nzpfinaf"
            OPEN      NZPFIGA1,"nzpfigaf"
.
            IF        PTCNAXEU=ONE
              DISPLAY   *P64:24,"pataxeaf";
              OPEN      PATAXEA1,"pataxeaf"
            ENDIF
.
            DISPLAY   *P64:24,"patdfeaf";
            OPEN      PATDFEA1,"patdfeaf"
.
            DISPLAY   *P64:24,"patjrnlf";
            OPEN      PATJRNL1,"patjrnlf"
            DISPLAY   *P64:24,"pathfrec";
            OPEN      PATHFRE1,"pathfrec"
            DISPLAY   *P64:24,"patfn1af";
            OPEN      PATFN1A1,"patfn1af"
            DISPLAY   *P64:24,"patin1af ";
            OPEN      PATIN1A1,"patin1af"
            DISPLAY   *P64:24,"patgo1af ";
            OPEN      PATGO1A1,"patgo1af"
            DISPLAY   *P64:24,"pathgrpf ";
            OPEN      PATHGRP1,"pathgrpf"
            DISPLAY   *P64:24,"patma1af";
            OPEN      PATMA1A1,"patma1af" 
            DISPLAY   *P64:24,"patmx1af";
            OPEN      PATMX1A1,"patmx1af" 
            DISPLAY   *P64:24,"patmi1af";
            OPEN      PATMI1A1,"patmi1af" 
            DISPLAY   *P64:24,"aaedtref";
            OPEN      AAEDTRE1,"aaedtref"
            DISPLAY   *P64:24,"outsitaf";
            OPEN      OUTSITA1,"outsitaf"
            OPEN      WEBSECA1,"websecaf"
.
            CALL      TFILENAM                   * Generate temporary file name
            MOVE      TFILNAME,TMPFILE2
.
            PACK      MAKETMP,MAKE,TMPFILE2,INDEX2
            PACK      KILLTMP,KILL,TMPFILE2
.
            CLOSE     SUSTMPA1
            EXECUTE   KILLTMP,TASKID
.
            CALL      SUST0000            * Delete any records on temp suspense
            BRANCH    EXIT,INIT0500       * bypass the "isbuild"
.
            EXECUTE   MAKETMP,TASKID
.
INIT0500    OPEN      SUSTMPA1,TMPFILE2
.
INIT0600    COMPARE   FIVE,CFEETYP        * SX
            GOTO      INIT1000 IF NOT EQUAL
.
            CALL      TFILENAM                  * Generate temporary file name
            MOVE      TFILNAME,TMPFILE3
.
            PACK      MAKETMP,MAKE,TMPFILE3,INDEX3
            PACK      KILLTMP,KILL,TMPFILE3
.
            CLOSE     XTRTMPA1
            EXECUTE   KILLTMP,TASKID
.
            CALL      XTRA0000            * Delete any records on temp extract
            BRANCH    EXIT,INIT0700       * bypass the "isbuild"
.
            EXECUTE   MAKETMP,TASKID
.
INIT0700    OPEN      XTRTMPA1,TMPFILE3
.
. ---- private practice ----
.
INIT1000    COMPARE   "1",HSYS3
            GOTO      INIT2000 IF NOT EQUAL
.
            DISPLAY   *P64:24,"priinvof";
            OPEN      PRIINVO1,"priinvof"
            DISPLAY   *P64:24,"pridtraf";
            OPEN      PRIDTRA1,"pridtraf"
            DISPLAY   *P64:24,"prifinsf";
            OPEN      PRIFINS1,"prifinsf"
            OPEN      PRIFIGA1,"prifigaf"
            DISPLAY   *P64:24,"pristatf";
            OPEN      PRISTAT1,"pristatf"
            DISPLAY   *P64:24,"prijrnlf";
            OPEN      PRIJRNL1,"prijrnlf"
.
.           OPEN      CGLCONTF,"cglcontf"
.           READ      CGLCONTF,ONE;*181,CCASHDIS
.
. ---- general ledger ----
.
INIT2000    CALL      FMSSYS00             * Check if any hosp using FMS system
            IF        IBCNMHOS=1
              MOVE      FMSFLAG,HSYS1
            ENDIF
.
            COMPARE   "1",HSYS1
            GOTO      INIT3000 IF NOT EQUAL
.
            DISPLAY   *P64:24,"fmscsaaf";
            OPEN      FMSCSAA1,"fmscsaaf"     
.
            DISPLAY   *P64:24,"fmscafaf";
            OPEN      FMSCAFA1,"fmscafaf"     
.
            DISPLAY   *P64:24,"fmslmaaf";
            OPEN      FMSLMAA1,"fmslmaaf"     
.
            DISPLAY   *P64:24,"fmsbcfaf";
            OPEN      FMSBCFA1,"fmsbcfaf"     
.
            DISPLAY   *P64:24,"fmslmcaf";
            OPEN      FMSLMCA1,"fmslmcaf"     
.
            DISPLAY   *P64:24,"fmsamaaf";
            OPEN      FMSAMAA1,"fmsamaaf"     
.
            DISPLAY   *P64:24,"fmscafaf";
            OPEN      FMSCAFA2,"fmscafaf"     
.
.           OPEN      CGLCONTF,"cglcontf"
.           READ      CGLCONTF,ONE;*181,CCASHDIS
.
            CALL      TFILENAM               * Generate temporary file name
            MOVE      TFILNAME,TMPFILE
.
            PACK      MAKETMP,MAKE,TMPFILE,INDEX
            PACK      KILLTMP,KILL,TMPFILE
.
. ---- nursing home ----
.
INIT3000    COMPARE   "1",HSYS6
            GOTO      INIT9000 IF NOT EQUAL
.
            DISPLAY   *P64:24,"debdbtaf";
            OPEN      DEBDBTA1,"debdbtaf"
.
            DISPLAY   *P64:24,"debfthaf";
            OPEN      DEBFTHA1,"debfthaf"
            OPEN      DEBFTHA6,"debfthaf"
.
            DISPLAY   *P64:24,"debtcraf";
            OPEN      DEBTCRA1,"debtcraf"
.
            DISPLAY   *P64:24,"debitmaf";
            OPEN      DEBITMA1,"debitmaf"
.
            DISPLAY   *P64:24,"debfdtaf";
            OPEN      DEBFDTA1,"debfdtaf"
            OPEN      DEBFDTA3,"debfdtaf"
.
INIT9000    DISPLAY   *P1:24,*EL;
            RETURN
+
.**************************************************************************
.*                              OPTN0000                                  *
.*                        Process Users Options                           *
.**************************************************************************
OPTN0000    MOVE      TEN4,ECOL
            MOVE      FOUR,EVERT
            MOVE      ZERO,CKYIMAND
            MOVE      ZERO,CKYIMODE
            MOVE      SP6,CKYIDEF6
            MOVE      ONE,CNEWDS
.
          CALL      CDRF0000           * enter from cash drawer
          BRANCH    EXIT,OPTN9000
.
          CALL      CDRT0000           * enter to cash drawer
          BRANCH    EXIT,OPTN9000
.
          DISPLAY   *P1:6,"Release Date :"
          MOVE      CDD,CDAY
          MOVE      CMM,CMON
          MOVE      CYY,CYEAR
          MOVE      CCC,CCENT
          MOVE      TWENTY3,CCOL
          MOVE      SIX,CVERT
          CALL      KEYDATE            * enter release date
          PACK      TODATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CDAY,RDD
          MOVE      CMON,RMM
          MOVE      CYEAR,RYY
          MOVE      CCENT,RCC
.
          KEYIN     *P1:7,"Web user id: ",USERID;
          MOVE      USERID,KEY10
          CALL      RDWBSE1
          BRANCH    OVRCD,OPTN9000
.
. ---- ok to continue ----
.
OPTN3000    CALL      CONTQST
.
            BRANCH    CEXIT,OPTN4000:       * yes
                            OPTN0000:       * no
                            OPTN9000        * cancel
.
. ---- allocate batch file ----
.
. ---- extract default details for G.L. batch ----
.
OPTN4000   
.           CALL      FMSSYS00             * Check if any hosp using FMS system
            CALL      RDFRST00             * read first record
            BRANCH    EXIT,OPTN9000
.
            CALL      GLBT0000
.
            BRANCH    EXIT,OPTN9000
.
            PACK      KEY25,SP70
            CALL      RSRCDTE2
.
            MOVE      ZERO,PAGENO
            MOVE      "88",LINECNT
            MOVE      ZERO,TOTAMT
            MOVE      ZERO,TOTDIS
            DISPLAY   *P1:10,"Consolidation / Sub-System Pass -- ";
            GOTO      OPTN9999
.
OPTN9000    MOVE      TRUE,EXIT
OPTN9999    RETURN
+
.****************************************************************************
.*                                RDFRST00             Called by: OPTN0000  *
.*                        Read first Record for batch                       *
.****************************************************************************
RDFRST00  PACK      KEY25,SP70
          CALL      RSRCDTE2
RDFRST10  CALL      RKRCDTE2             * read first record
          BRANCH    OVRCD,RDFRST90

          MATCH     SP70,RCDTRELD        * finished ???
          GOTO      RDFRST90 IF NOT EQUAL
.
          PACK      KEY12,RCDTRECN,SP70
          CALL      RDRCBNK1
          BRANCH    OVRCD,RDFRST10
.
          MATCH     "1",RCBNSTAT          * skip cancelled receipts
          GOTO      RDFRST10 IF EQUAL
.
          MATCH     SP70,RCBNBDAT
          GOTO      RDFRST10 IF EQUAL
.
          MATCH     TODATE,RCDTTDAT
          GOTO      RDFRST20 IF EQUAL
          GOTO      RDFRST20 IF LESS
.
          GOTO      RDFRST10
.
RDFRST20  IF        IBCNMHOS=1
            MATCH     "1",RCCNORUH
            IF        @EQUAL
              PACK      KEY6,RCBNCDRW,SP70
              CALL      RDCIDA1
              BRANCH    OVRCD,RDFRST10
              MATCH     RCCIHOSP,WBSEHOSP
              GOTO      RDFRST10 IF NOT EQUAL   * different hospital id
            ENDIF
          ENDIF
.
          MATCH     DRAWERF,RCBNCDRW      * check drawer
          GOTO      RDFRST10 IF LESS
.
          MATCH     RCBNCDRW,DRAWERT
          GOTO      RDFRST10 IF LESS
.
          MATCH     "2",RCBNSTAT          * check receipt status
          GOTO      RDFRST10 IF NOT EQUAL
.
          MOVE      ZERO,TRNSYS
          MOVE      ZERO,USEFMS
          PACK      KEY3,RCDTREGI,SP70
          CALL      RDREGA1
          IF        OVRCD<>1
            MOVE      REGIBACD,TRNSYS
            MOVE      REGHOSP,KEY3
            CALL      RDPTHSP1
            IF        OVRCD=0
              MOVE      PTHSUFMS,USEFMS   * Use FMS system
            ENDIF
          ENDIF
.
          GOTO      RDFRST99
.
RDFRST90  MOVE      ONE,EXIT
RDFRST99  RETURN
+
.****************************************************************************
.*                                CDRF0000             Called by: OPTN0000  *
.*                        Key in cash drawer from                           *
.****************************************************************************
CDRF0000  KEYIN     *P1:3,*EF,*P1:4,"Cash Drawer From: ",*V2LON,DRAWERF
.
          ENDSET    DRAWERF
          APPEND    SP6,DRAWERF
          RESET     DRAWERF
.
          MATCH     SP6,DRAWERF
          GOTO      CDRF9000 IF EQUAL
.
          MOVE      DRAWERF,KEY6
          CALL      RDCIDA1
          BRANCH    OVRCD,CDRF1000
          GOTO      CDRF9000
.
CDRF1000  DISPLAY   *P1:24,"Invalid Cash Drawer";
          CALL      HITENTER
          MOVE      ONE,EXIT
          GOTO      CDRF9999
.
CDRF9000  MOVE      ZERO,EXIT
.
CDRF9999  RETURN
+
.****************************************************************************
.*                                CDRT0000             Called by: OPTN0000  *
.*                        Key in cash drawer to                             *
.****************************************************************************
CDRT0000  KEYIN     *P1:5,"Cash Drawer To: ",*V2LON,DRAWERT
.
          ENDSET    DRAWERT
          APPEND    SP6,DRAWERT
          RESET     DRAWERT
.
          MATCH     SP6,DRAWERT
          IF        @EQUAL
            PACK      DRAWERT,Z70
            GOTO      CDRT9000
          ENDIF
.
          MOVE      DRAWERT,KEY6
          CALL      RDCIDA1
          BRANCH    OVRCD,CDRT1000
          MATCH     DRAWERF,DRAWERT
          GOTO      CDRT2000 IF LESS
          GOTO      CDRT9000
.
CDRT1000  DISPLAY   *P1:24,"Invalid Cash Drawer";
          CALL      HITENTER
          MOVE      ONE,EXIT
          GOTO      CDRT9999
.
CDRT2000  DISPLAY   *P1:24,"Cash Drawer from must be less than Cash Drawer to";
          CALL      HITENTER
          MOVE      ONE,EXIT
          GOTO      CDRT9999
.
CDRT9000  MOVE      ZERO,EXIT
.
CDRT9999  RETURN
+
.***************************************************************************
.*                             READ0000                                    *
.*                         read next transaction                           *
.***************************************************************************
READ0000    CALL      RKRCDTE2
            BRANCH    OVRCD,READ9000
.
            MATCH     SP70,RCDTRELD        * finished ???
            GOTO      READ9000 IF NOT EQUAL
.
            PACK      KEY12,RCDTRECN,SP70
            CALL      RDRCBNK1
            IF        OVRCD=1
              PRINT     *1,"Missing header record for receipt  ",RCDTRECN
            ENDIF
.
.
            MATCH     "1",RCBNSTAT          * skip cancelled receipts
            GOTO      READ0000 IF EQUAL
.
            MATCH     SP70,RCBNBDAT
            GOTO      READ0000 IF EQUAL
.
            PACK      SAVDTEKY,RCDTRECN,RCDTTCNT,SP70
            MATCH     TODATE,RCDTTDAT
            GOTO      READ2000 IF EQUAL
            GOTO      READ2000 IF LESS
.
            GOTO      READ0000                
.
READ2000    IF        IBCNMHOS=1
              MATCH     "1",RCCNORUH
              IF        @EQUAL
                PACK      KEY6,RCBNCDRW,SP70
                CALL      RDCIDA1
                BRANCH    OVRCD,READ0000
                MATCH     RCCIHOSP,WBSEHOSP
                GOTO      READ0000 IF NOT EQUAL   * different hospital id
              ENDIF
            ENDIF
.
            MATCH     DRAWERF,RCBNCDRW      * check drawer
            GOTO      READ0000 IF LESS
.
            MATCH     RCBNCDRW,DRAWERT
            GOTO      READ0000 IF LESS
.
            MATCH     "2",RCBNSTAT          * check receipt status
            GOTO      READ0000 IF NOT EQUAL
.
            MOVE      ZERO,TRNSYS
            MOVE      ZERO,USEFMS
            PACK      KEY3,RCDTREGI,SP70
            CALL      RDREGA1
            IF        OVRCD<>1
              MOVE      REGIBACD,TRNSYS
              MOVE      REGHOSP,KEY3
              CALL      RDPTHSP1
              IF        OVRCD=0
                MOVE      PTHSUFMS,USEFMS   * Use FMS system
              ENDIF
            ENDIF
.
READ3000    COMPARE   "99",TRNSYS           * check if suspense transaction
            IF        @EQUAL
              MOVE      RCDTRECN,RECEIPTN
              MOVE      RCDTTCNT,TRNCOUNT
              MOVE      TWO,REALLOCT
              PACK      KEY18,REALLOCT,RECEIPTN,TRNCOUNT,SP70
              CALL      RASUTM1
              IF        OVRCD=1
                CALL      WRSUTM1          * record suspense info for reporting
              ENDIF
              GOTO      READ8000           * bypass suspense transactions
            ENDIF
.
            MATCH     "1",RCDTALLO         * check if reallocated suspense trans
            IF        @EQUAL
              MOVE      RCDTRECN,RECEIPTN
              MOVE      RCDTTCNT,TRNCOUNT
              MOVE      ONE,REALLOCT
              PACK      KEY18,REALLOCT,RECEIPTN,TRNCOUNT,SP70
              CALL      RASUTM1
              IF        OVRCD=1
                CALL      WRSUTM1          * record reallocated sus. for report
              ENDIF
              GOTO      READ8000           * bypass reallocated sus. trans. to
            ENDIF                          * be processed at ML2500
.
.                                          * continue for all other transactions
            GOTO      READ9999
.
.           For suspense register, if it hasn't been extracted
.           Write to Extract tempfile for the receipt number to be extracted
.             
READ8000    COMPARE   FIVE,CFEETYP         
            GOTO      READ0000 IF NOT EQUAL  * Not SX
.             
.           COMPARE   "99",TRNSYS            * check if suspense transaction
.           GOTO      READ0000 IF NOT EQUAL
.
.           MATCH     SP70,RCDTGLEX
.           GOTO      READ0000 IF NOT EQUAL  * already had been extracted
.
.           MOVE      RCDTRECN,KEY12
.           CALL      RDXTRA1
.           COMPARE   ZERO,OVRCD
.           GOTO      READ0000 IF EQUAL
.
.           MOVE      RCDTRECN,XTMRNUMB      * Receipt Number
.           MOVE      SP70,XTMRSPAR          * Spare
.           CALL      WRXTRA1
            GOTO      READ0000
.
READ9000    MOVE      TRUE,ENDFILE
READ9999    RETURN
+
.***************************************************************************
.*                             RDAL0000                                    *
.*              read next suspense reallocation transaction                *
.***************************************************************************
RDAL0000    CALL      RKRCDTE4
            BRANCH    OVRCD,RDAL9000
.
            PACK      KEY12,RCDTRECN,SP70
            CALL      RDRCBNK1
            IF        OVRCD=1
              PRINT     *1,"Missing header record for receipt  ",RCDTRECN
            ENDIF
.
            MATCH     "1",RCBNSTAT          * skip cancelled receipts
            GOTO      RDAL0000 IF EQUAL
.
            MATCH     SP70,RCBNBDAT
            GOTO      RDAL0000 IF EQUAL
.
            PACK      SAVDTEKY,RCDTRECN,RCDTTCNT,SP70
            MATCH     TODATE,RCDTTDAT
            GOTO      RDAL2000 IF EQUAL
            GOTO      RDAL2000 IF LESS
.
            GOTO      RDAL0000
.
RDAL2000    IF        IBCNMHOS=1
              MATCH     "1",RCCNORUH
              IF        @EQUAL
                PACK      KEY6,RCBNCDRW,SP70
                CALL      RDCIDA1
                BRANCH    OVRCD,RDAL0000
                MATCH     RCCIHOSP,WBSEHOSP
                GOTO      RDAL0000 IF NOT EQUAL   * different hospital id
              ENDIF
            ENDIF
.
            MATCH     DRAWERF,RCBNCDRW      * check drawer
            GOTO      RDAL0000 IF LESS
.
            MATCH     RCBNCDRW,DRAWERT
            GOTO      RDAL0000 IF LESS
.
            MATCH     "2",RCBNSTAT          * check receipt status
            GOTO      RDAL0000 IF NOT EQUAL
.
            MOVE      ZERO,TRNSYS
            MOVE      ZERO,USEFMS
            PACK      KEY3,RCDTREGI,SP70
            CALL      RDREGA1
            IF        OVRCD<>1
              MOVE      REGIBACD,TRNSYS
              MOVE      REGHOSP,KEY3
              CALL      RDPTHSP1
              IF        OVRCD=0
                MOVE      PTHSUFMS,USEFMS   * Use FMS system
              ENDIF
            ENDIF
.
RDAL3000    COMPARE   "99",TRNSYS           * check if suspense transaction
.                                           * this bit not really needed (99s
.                                           * should not be re-allocated) but
.                                           * it wont break anything
            IF        @EQUAL
              MOVE      RCDTRECN,RECEIPTN
              MOVE      RCDTTCNT,TRNCOUNT
              MOVE      TWO,REALLOCT
              PACK      KEY18,REALLOCT,RECEIPTN,TRNCOUNT,SP70
              CALL      RASUTM1
              IF        OVRCD=1
                CALL      WRSUTM1
              ENDIF
              GOTO      RDAL0000            * bypass processing
            ENDIF
.
            MATCH     "1",RCDTALLO         * check if reallocated suspense trans
            IF        @EQUAL
              MOVE      RCDTRECN,RECEIPTN
              MOVE      RCDTTCNT,TRNCOUNT
              MOVE      ONE,REALLOCT
              PACK      KEY18,REALLOCT,RECEIPTN,TRNCOUNT,SP70
              CALL      RASUTM1
              IF        OVRCD=1
                CALL      WRSUTM1
              ENDIF
            ENDIF
.
            GOTO      RDAL9999
.
RDAL9000    MOVE      TRUE,ENDFILE
RDAL9999    RETURN
+
.************************************************************************
.*                              WRTS0000                                *
.*                        write to sub-system files                     *
.************************************************************************
WRTS0000  MOVE      ZERO,NOINVFLG          * set no invoice flag
          MOVE      SP70,PAYMCODE
          PACK      SAVUR,SP10
          PACK      SAVAD,SP10
.
          PACK      KEY15,RCDTRECN,SP70
          CALL      RSRCBDT1
          CALL      RKRCBDT1
          IF        OVRCD=0
            MATCH     RCBDRECN,RCDTRECN    * Same receipt no?
            IF        @EQUAL
              MOVE      RCBDPCOD,PAYMCODE  * the first payment code of receipt
            ENDIF
          ENDIF
.
          MATCH     SP70,RCDTINVN
          GOTO      WRTS0800 IF EQUAL
.
.         Invoice has been raised, before deposits have been released
.         Treat deposit like a receipt taken against an invoice.
.
          COMPARE   "90",TRNSYS                * EMR deposits
          GOTO      WRTS0900 IF EQUAL
          COMPARE   "91",TRNSYS                * Oupatient deposits
          GOTO      WRTS0900 IF EQUAL
          COMPARE   "96",TRNSYS                * P.P. cash deposits
          GOTO      WRTS1050 IF EQUAL
          COMPARE   "97",TRNSYS                * Patient cash deposits
          GOTO      WRTS0900 IF EQUAL
.
WRTS0800  COMPARE   "99",TRNSYS                * suspense receipts 
          GOTO      WRTS5000 IF EQUAL
          COMPARE   "98",TRNSYS                * internal receipts 
          GOTO      WRTS5000 IF EQUAL
          COMPARE   "94",TRNSYS                * internal receipts 
          GOTO      WRTS5000 IF EQUAL
          COMPARE   "95",TRNSYS                * internal receipts 
          GOTO      WRTS5000 IF EQUAL
          COMPARE   "92",TRNSYS                * internal GST receipts 
          GOTO      WRTS5000 IF EQUAL
          COMPARE   "89",TRNSYS                * Credit Card Surcharge
          GOTO      WRTS5000 IF EQUAL
.
          COMPARE   "90",TRNSYS                * EMR deposits
          GOTO      WRTS2000 IF EQUAL
          COMPARE   "91",TRNSYS                * Oupatient deposits
          GOTO      WRTS2000 IF EQUAL
          COMPARE   "96",TRNSYS                * P.P. cash deposits
          GOTO      WRTS2000 IF EQUAL
          COMPARE   "97",TRNSYS                * Patient cash deposits
          GOTO      WRTS2000 IF EQUAL
.
          BRANCH    TRNSYS,WRTS1000,WRTS1100,WRTS5000,WRTS1300,WRTS1400
          GOTO      WRTS1000
.
.         Invoice has been raised, before deposits have been released
.         Write deposit to comdepaf with status of 1
.
WRTS0900  MOVE      "1",CMDESTAT               * Deposit applied to an invoice
          CALL      CDEP0000
.
. ---- patient billing ----
.
WRTS1000  CALL      OVIS0000                   * set up visit based files open
          CALL      PATB0000
          BRANCH    EXIT,WRTS9000              * no invoice record found
          IF        TRNSYS=93
            PACK      KEY8,PINVADM,SP10
            CALL      DFEE0000                   * Update Doctors fee file
          ENDIF
          GOTO      WRTS5000
.
.         Invoice has been raised, before deposits have been released
.         Write deposit to comdepaf with status of 1
.
WRTS1050  MOVE      "1",CMDESTAT               * Deposit applied to an invoice
          CALL      CDEP0000
.
. ---- private practice ----
.
WRTS1100  CALL      PP0000
          BRANCH    EXIT,WRTS9000              * no invoice record found
          GOTO      WRTS5000
.
. ---- medical services ----
.
WRTS1300  CALL      MEDS0000
          GOTO      WRTS5000
.
. ---- sundry accounts rec. ----
.
WRTS1400  CALL      ARCS0000                   * Include DEBRCPCD.PBL
          BRANCH    EXIT,WRTS9000              * no invoice record found
          GOTO      WRTS5000
.
. ---- cash deposits ----
.
WRTS2000  MOVE      "0",CMDESTAT
          CALL      CDEP0000
          GOTO      WRTS5000
.
WRTS5000  PACK      KEY17,SAVDTEKY,SP70
          CALL      RDRCDTE1
          IF        OVRCD=0
            CALL      IBACLOCK
            PACK      RCDTRELD,CCC,CYY,CMM,CDD,SP70
            REP       " 0",RCDTRELD
            MOVE      CTIMEIS,RCDTRELT
            MOVE      USERID,RCDTRELU                                 *I-233901
            MATCH     "1",RCDTALLO
            IF        @EQUAL
              MOVE      SP70,RCDTALLO   
            ENDIF
            PACK      RCDTUDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCDTUDAT           * date updated
            CLOCK     TIME,RCDTUTIM           * time updated
            MOVE      USERID,RCDTUUID         * web user id
            CALL      UPRCDTE1
          ENDIF
          MOVE      ZERO,EXIT
          COMPARE   FIVE,CFEETYP
          GOTO      WRTS9999 IF NOT EQUAL  * Not SX
.
          COMPARE   "99",TRNSYS                * suspense receipts 
          GOTO      WRTS9999 IF EQUAL          * ignore suspense register
.
          MOVE      RCDTRECN,KEY12
          CALL      RDXTRA1
          COMPARE   ZERO,OVRCD
          GOTO      WRTS9999 IF EQUAL      * already exist
.
          MOVE      RCDTRECN,XTMRNUMB      * Receipt Number
          MOVE      SP70,XTMRSPAR          * Spare
          CALL      WRXTRA1
          GOTO      WRTS9999
.
WRTS9000  MOVE      ONE,EXIT
          IF        NOINVFLG=1
            PRINT     *1,"Invoice not found ",RCDTINVN," Receipt No: ",RCDTRECN:
                       "/",RCDTTCNT
            MOVE      ZERO,NOINVFLG
          ENDIF
.
WRTS9999  RETURN
+
.**************************************************************************
.*  OVIS0000  :  Set up visit based files for open                        *
.**************************************************************************
OVIS0000  MOVE      RCDTMDHS,FORM2

          LOAD      XXDPATH,FORM2,HDPATH1,HDPATH2,HDPATH3,HDPATH4,HDPATH5
.
. now open visit related files in appropriate databases (ie. across hospitals)
.
          MOVE      "patvisaf",OPFILE
          MOVE      TWENTY,FILENUM
          CALL      OMDFN000
          IF        EXIT=1
            OPEN      PATVISA1,"patvisaf"      * Visit file
          ENDIF
.
          MOVE      "patinvrf",OPFILE
          MOVE      FIFTY1,FILENUM
          CALL      OMDFN000
          IF        EXIT=1
            OPEN      PATINVR1,"patinvrf"      * Invoice file
          ENDIF
.
          MOVE      "patdtraf",OPFILE
          MOVE      FIFTY2,FILENUM
          CALL      OMDFN000
          IF        EXIT=1
            OPEN      PATDTRA1,"patdtraf"      * debtor trans file
          ENDIF
.
          MOVE      "out",OSTFILE
          MOVE      PINVSITE,KEY6
          CALL      RDSITA1                    * Get the site for this pat
          PACK      CFNAME,OSTFILE,FILDTRO1
          MOVE      CFNAME,OPFILE
          MOVE      FIFTY3,FILENUM
          CALL      OMDFN000
          IF        EXIT=1
            OPEN      OUTDTRO1,CFNAME            * Open this sites dtran
          ENDIF
.
          MOVE      "patmi1af",OPFILE
          MOVE      ONE,FILENUM
          CALL      OMDFN000
          IF        EXIT=1
            OPEN      PATMI1A1,"patmi1af"                   * SRF 612596
          ENDIF
.
          MOVE      "patjrnlf",OPFILE
          MOVE      FIFTY4,FILENUM
          CALL      OMDFN000
          IF        EXIT=1
            OPEN      PATJRNL1,"patjrnlf"      * journals file
          ENDIF
.
          MOVE      "pathfrec",OPFILE
          MOVE      FIFTY5,FILENUM
          CALL      OMDFN000
          IF        EXIT=1
            OPEN      PATHFRE1,"pathfrec"      * HFund receipt file
          ENDIF
.
OVIS9999  RETURN
+
.**************************************************************************
.*                                TOT0000                                 *
.*                      consolidation of gl accounts                      *
.**************************************************************************
TOT0000   COMPARE   "5",TRNSYS            * Performed by Sundry A/R
          GOTO      TOT9999 IF EQUAL      * Routines
          IF        IBCNMHOS=1
            MOVE      USEFMS,HSYS1
          ENDIF
          BRANCH    HSYS1,TOT2000         * Update GL Batch File
.
.          COMPARE   ONE,RCCNUPBR
.          GOTO      TOT9999 IF NOT EQUAL  * No GL or Bank Rec Update Needed
.
.TOT1000   CALL      UPBR0000              * Update Bank Rec.
.
          GOTO      TOT9999
.
TOT2000   UNPACK    RCDTINCA,GLSLEDG,GLSACCT
          PACK      GLACCT,GLSLEDG,GLSACCT
          MOVE      ONE,GLTYPE
          PACK      KEY15,GLACCT,GLTYPE
          UNPACK    RCDTBNKA,DIM2,GLBANK
          MOVE      RCDTREGI,GLREG
          MOVE      RCDTAMNT,GLAMNT
          MOVE      RCDTGSTC,GLGSTC
.
          CALL      VGRN0000      * determine whether GST or Normal process
.
TOT9999   RETURN
+
.***************************************************************************
.*                                 PRT0000                                 *
.*                               print details                             *
.***************************************************************************
PRT0000   MOVE      ONE,PRINTOT
          COMPARE   "55",LINECNT
          CALL      PRT8000 IF NOT LESS
.
          UNPACK    RCDTTDAT,TCC,TYY,TMM,TDD
          PRINT     *N,RCBNCDRW,*8,TDD,SLASH,TMM,SLASH,TYY,*17,RCDTRECN:
                    *30,RCDTTCNT,*36,TRNSYS;
.
          MATCH     SP70,RCDTINVN
          IF        !@EQUAL
            PRINT     *40,RCDTINVN;
          ELSE
            MATCH     SP70,RCDTNAME
            IF        !@EQUAL
              MOVE      RCDTNAME,DIM14
              PRINT     *39,DIM14;
            ELSE
              MOVE      RCDTREFR,DIM14
              PRINT     *39,DIM14;
            ENDIF
          ENDIF
.
          COMPARE   FIVE,CFEETYP
          GOTO      PRT1000 IF EQUAL      * SX
.
          IF        IBCNMHOS=1
            MOVE      USEFMS,HSYS1
          ENDIF
          IF        HSYS1=1 | HSYS1=2 | HSYS1=3 | HSYS1=4 | HSYS1=5
            UNPACK    SP30,LEDGERN,ACCOUNT
            UNPACK    RCDTBNKA,LEDGERN,ACCOUNT
            UNPACK    RCDTINCA,BCLEDG,BCACCTP
            IF        HSYS1=1
              MATCH     "1",RCDTALLO
              IF        !@EQUAL
                CALL      GETC0000
              ENDIF
            ELSE
              MATCH     "1",RCCNLEDG             * Using one char of Ledger
              IF        @EQUAL
                UNPACK    RCDTBNKA,KEY1,ACCOUNT
                PACK      LEDGERN,SP1,KEY1
                UNPACK    RCDTINCA,KEY1,BCACCTP
                PACK      BCLEDG,SP1,KEY1
                UNPACK    RCDTBNKA,KEY1,BCCONT
              ELSE    
                UNPACK    RCDTBNKA,LEDGERN,BCCONT
              ENDIF
            ENDIF
          ELSE
            UNPACK    SP30,BCLEDG,BCACCTP
          ENDIF
          GOTO      PRT2000
.
.         For SX - just print the Debit/Credit Account
.
PRT1000   UNPACK    SP30,LEDGERN,ACCOUNT
          UNPACK    RCDTBNKA,LEDGERN,ACCOUNT
          UNPACK    RCDTINCA,BCLEDG,BCACCTP
          UNPACK    RCDTBNKA,LEDGERN,BCCONT
.
PRT2000   IF        TRNSYS<>98
            PRINT     *54,RCDTURNO,*63,RCDTVIST;  
          ENDIF
.
PRT2999   MOVE      RCDTDISC,FORM8P2
          PRINT     *75,RCDTAMNT,*92,FORM8P2,*105,BCLEDG,"/",BCACCTP:
                    *121,BCLEDG,SLASH,BCCONT;
          ADD       ONE,LINECNT
          ADD       RCDTAMNT,TOTAMT
          ADD       RCDTDISC,TOTDIS
          RETURN
.
.
PRT8000   CLOCK     TIME,CTIMEIS
          MOVE      ONE,CNOUNDLN
          CALL      HEAD132
.
          MATCH     SP70,DRAWERF
          GOTO      PRT8200 IF EQUAL
.
          PACK      KEY6,DRAWERF,SP70
          CALL      RDCIDA1
          IF        OVRCD=1
            UNPACK    SP70,RCPSUR,RCPGIVEN
          ENDIF
          SQUEEZE   RCPGIVEN
          SQUEEZE   RCPSUR
          PACK      DRAWNAME,RCPSUR,SP1,RCPGIVEN,SP70
          PRINT     *40,"Drawer From: ",DRAWNAME
.
PRT8200   MATCH     SP70,DRAWERT
          GOTO      PRT8400 IF EQUAL
.
          PACK      KEY6,DRAWERT,SP70
          CALL      RDCIDA1
          IF        OVRCD=1
            UNPACK    SP70,RCPSUR,RCPGIVEN
          ENDIF
          SQUEEZE   RCPGIVEN
          SQUEEZE   RCPSUR
          PACK      DRAWNAME,RCPSUR,SP1,RCPGIVEN,SP70
          PRINT     *40,"         To: ",DRAWNAME
.
PRT8400   IF        HSYS1=1
            PRINT     "General Ledger Batch No. : ",BATCH
          ENDIF
          PRINT     *N,"Cash/r   Date        Receipt Cnt   Sys       Invoice":
                       "  U/R     Admission":
                    *76,"        Amount     Discount  Credit Account":
                       "  Bank Account":
                    *N,"------ ----------   -------- ----- ---   -------":
                       "---- -------- ---------  ":
                       "-----------------  ----------- --------------  ":
                       "--------------";
.                    *N;
          MOVE      "10",LINECNT
          RETURN
.***************************************************************************
.*                                 PRTT0000                                *
.*                               print totals                              *
.***************************************************************************
PRTT0000    COMPARE      ZERO,PRINTOT
            GOTO         PRTT9999 IF EQUAL
.
            PRINT        *N,*77,"--------------------------":
                         *N,*68,"Total",*77,TOTAMT,*90,TOTDIS:
                         *N,*77,"=========================="
PRTT9999    RETURN
.***************************************************************************
.*                                 PRTS0000                                *
.*                         Print suspense transactions                     *
.***************************************************************************
PRTS0000  CLOCK     TIME,CTIMEIS
          CALL      HEAD132
          PRINT     *N,*1,"Suspense Transactions",*N
          IF        HSYS1=1
            PRINT     "General Ledger Batch No. : ",BATCH
          ENDIF
          PRINT     *N,"Date       Receipt Number  Count   Cash Drawer":
                    *65,"       Amount        Discount":
                    "  Register                ":
                    "Credit Account":
                    *N,"---------  --------------  ------  ":
                    "--------------------------  --------------  ":
                    "--------------  ----------------------  ":
                    "---------------"
          ADD       TWO,CLNO
          MOVE      ZERO,TOTAMT
          MOVE      ZERO,TOTDIS
          MOVE      ZERO,SUSFLAG
          PACK      KEY18,SP70
          CALL      RSSUTM1
PRTS1000  CALL      RKSUTM1
          BRANCH    OVRCD,PRTS9000
.
          COMPARE   ONE,SUSFLAG
          IF        !@EQUAL
            MATCH     "1",REALLOCT
            IF        @EQUAL
              MOVE      ONE,SUSFLAG
              CALL      HEAD132
              PRINT     *N,*1,"Reallocated Suspense Transactions",*N
              IF        HSYS1=1
                PRINT     "General Ledger Batch No. : ",BATCH
              ENDIF
              PRINT     *N,"Date       Receipt Number  Count   Cash Drawer":
                        *65,"       Amount        Discount":
                        "  Register                ":
                        "Credit Account":
                        *N,"---------  --------------  ------  ":
                        "--------------------------  --------------  ":
                        "--------------  ----------------------  ":
                        "---------------"
            ENDIF
          ENDIF
.
          PACK      KEY12,RECEIPTN,SP70
          CALL      RDRCBNK1
          BRANCH    OVRCD,PRTS1000
.
          PACK      KEY17,RECEIPTN,TRNCOUNT,SP70
          CALL      RDRCDTE1
          BRANCH    OVRCD,PRTS1000
.
          PACK      KEY3,RCDTREGI
          CALL      RDREGA1
          IF        OVRCD=1
            MOVE      "Invalid Register",DIM20
            PACK      DIM20,DIM20,SP70
          ELSE
            PACK      DIM20,REGDESC
          ENDIF
.
          UNPACK    RCBNTDAT,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          PRINT     *1,CPCDATE,*12,RECEIPTN,*28,TRNCOUNT,*36,RCBNCDRW:
                    *63,RCDTAMNT,*79,RCDTDISC,*96,DIM20,*120,RCDTINCA
          ADD       RCDTAMNT,TOTAMT
          ADD       RCDTDISC,TOTDIS
          GOTO      PRTS1000
.
PRTS9000  PRINT     *N,*64,"------------------------------":
                    *N,*56,"Total",*65,TOTAMT,*81,TOTDIS:
                    *N,*64,"=============================="
PRTS9999  PRINT     *N,*N,"*** End of Report ***"
          RETURN
.*************************************************************************
.*                                   GLBT0000                            *
.*                              assign g.l. batch file                   *
.*************************************************************************
GLBT0000    IF        IBCNMHOS=1
              MOVE      FMSFLAG,HSYS1   * found a hospital uses FMS system?
            ENDIF
            COMPARE   "1",HSYS1
            RETURN    IF NOT EQUAL
.
            STRIP     HDATACCT
.
            CLEAR     FNAME
            APPEND    HDATACCT,FNAME
            APPEND    "controlf.txt",FNAME
            RESET     FNAME
.
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            OPEN      FCONTROL,FNAME        * check if file exists
            TRAPCLR   IO
            IF        OVRCD<>1
              READ      FCONTROL,SIXTY6;*67,FMCORDIS
              MOVE      ONE,CONTRFLG        * use FCONTROL
            ELSE
              READ      CONTROLF,SIXTY6;*67,FMCORDIS
              MOVE      ZERO,CONTRFLG       * use CONTROLF
            ENDIF
.
. ---- allocate next batch number ----
.
GLBT1000    IF        CONTRFLG = 1
              CALL      RDFMCOCX            * read FCONTROL
            ELSE
              CALL      RDFMCOCO            * read CONTROLF
            ENDIF
            MATCH     "00000",FMBCOBAT
            GOTO      GLBT1000 IF EQUAL
.
            PACK      KEY5,FMBCOBAT,SP20
            CALL      RDFMBC1
            COMPARE   OVRCD,ZERO
            GOTO      GLBT1000 IF EQUAL
.
            STRIP     HDATARCP
            CLEAR     FILENAME
            APPEND    HDATARCP,FILENAME
            APPEND    "bch",FILENAME
            APPEND    BATCH,FILENAME
            APPEND    EXT,FILENAME
            RESET     FILENAME
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            OPEN      BATFILE,FILENAME
            TRAPCLR   IO
.
            COMPARE   ZERO,OVRCD
            GOTO      GLBT1000 IF EQUAL
.
            MOVE      FMBCOBAT,BATCH
            REPLACE   " 0",BATCH
            CLOSE     FCONTROL
.
            MOVE      BATCH,FMBCBAT
            MOVE      ZERO,FMBCSTA
            MOVE      ZERO,FMBCSEC
            MOVE      ZERO,FMBCTOT
            MOVE      ZERO,FMBCDIS
            MOVE      PASSCODE,FMBCUID
            PACK      FMBCDAT,CCC,CYY,CMM,CDD
            REP       " 0",FMBCDAT
            MOVE      TODATE,FMBCPDAT
            MOVE      REGGENLD,FMBCLED
            REP       " 0",FMBCLED
            MOVE      "CS",FMBCTRT
            MOVE      ZERO,FMBCINV
            MOVE      TODATE,FMBCCDAT
            MOVE      SP20,FMBCSPAR
.
            PACK      KEY5,FMBCBAT
            CALL      WRFMBC1            * should not exist
.
            DISPLAY   *P1:24,*EL,"Allocated Batch Number is ",*V2LON,BATCH;
.
. ---- open file ----
.
            STRIP     HDATARCP
            CLEAR     FILENAME
            APPEND    HDATARCP,FILENAME
            APPEND    "bch",FILENAME
            APPEND    BATCH,FILENAME
            APPEND    EXT,FILENAME
            RESET     FILENAME
.
. ---- write header details to batch ----
.
            MOVE      SP10,BC0DIM2
            MOVE      TWO,BC0NXTSC
            MOVE      ZERO,BC0NXTSW
            MOVE      ZERO,BC0BTCHT
            MOVE      ZERO,BC0SUPBC
            MOVE      SP6,BC0DIM6
            MOVE      ZERO,BC0SPLTK
            MOVE      ZERO,BC0SPLTP
            MOVE      ONE,BC0ONE
            MOVE      ZERO,BC0DISC
            MOVE      ZERO,BC0SPSEC
.
            PREP      BATFILE,FILENAME
            CALL      WRBAT0
.
            MOVE      "HD",BC1HEAD
            MOVE      BATCH,BC1BATCH
            MOVE      ZERO,BC1KEYT
            MOVE      ZERO,BC1ACCT
            MOVE      ZERO,BC1NOTR
            PACK      BC1DATE,RDD,RMM,RCC,RYY
            REPLACE   " 0",BC1DATE
            MOVE      PASSCODE,BC1OPER
            MOVE      REGGENLD,BC1LEDG
            MOVE      "CS",BC1TRAN
            MOVE      BC1DATE,BC1BDATE
            MOVE      ZERO,BC1REORG
            MOVE      REGDISS,BC1DISS
            MOVE      SP10,BC1PAYT
            MOVE      REGRESP,BC1RESP
            MOVE      ZERO,BC1REST
.
            CALL      WRBAT1
.
GLBT9999    RETURN
+
.**************************************************************************
.*                             PATB0000                                   *
.*                         patient billing interface                      *
.**************************************************************************
.
. ---- set and write to DTRAN file ----
.
PATB0000    UNPACK    RCDTTDAT,TCC,TYY,TMM,TDD
            MATCH     SP70,RCDTINVN
            GOTO      PATB9800 IF EQUAL
.
            UNPACK    RCDTINVN,DIM4,KEY8
            CALL      RDINV1
            BRANCH    OVRCD,PATB9500
.
            MOVE      PINVNO,FININVN        * set fields for Financial details
            MOVE      PINVADM,FINADMN
            MOVE      PINVUR,FINURNO
.
            MOVE      SP70,PMVXMHOS
            PACK      KEY8,PINVADM
            CALL      RDVISA1
            CALL      RDPMVX11
.
            BRANCH    PINVSYS,PATB1000,PATB3000,PATB5000,PATB3000
.
. ---- accident & emergency ----
.  
PATB1000    MOVE      PINVADM,ATNUMB
            UNPACK    RCDTINVN,DIM4,ATINVNO
            MOVE      PINVADM,PVIBILL
            MOVE      PVIBILL,KEY8
            CALL      TRVISA1
            BRANCH    OVRCD,PATB9500,PATB9500
.
.           Check if DTR record already exists
.
            PACK      KEY22,PINVADM,PINVNO,PVITRAN
            CALL      RDADTRE1
            IF        OVRCD = 0
              GOTO      PATB1000
            ENDIF
.
            MOVE      PVITRAN,ATTRANS
            CALL      GTRD0000               * Get transaction description
            MOVE      DIM30,ATDDESC
            MOVE      RCDTAMNT,AMOUNT
            MULT      "-1",AMOUNT
            MOVE      AMOUNT,ATPATAMT
            PACK      ATDDATE,TCC,TYY,TMM,TDD
            REPLACE   " 0",ATDDATE
            MOVE      SP4,ATITEMNO
            MOVE      "PY",ATTYPE
.....       MOVE      TRNPTYPE,ATPAYTYP
            MOVE      RCDTRECN,ATRECEPT
            MOVE      "1",ATINVPRT
            MOVE      "2",ATRECTYP
.           PACK      ATDTEFFD,TCC,TYY,TMM,TDD
            PACK      ATDTEFFD,CCC,CYY,CMM,CDD,SP70
            REP       " 0",ATDTEFFD
.
            MOVE      SP3,ATMISGRP
            MOVE      SP3,ATDEPTYP
            MOVE      SP8,ATBATCHN
            MOVE      SP70,ATDTBTCH
            MOVE      SP70,ATDTSUBN
            MOVE      SP70,ATDTEDAD
            MOVE      SP70,ATDTSVTM
            MOVE      ZERO,ATDTSCHF
            MOVE      SP70,ATDTITYP
            MOVE      SP70,ATDTRBRS
            MOVE      PAYMCODE,ATDTPCOD
            PACK      ATDTACOI,SP70       * After Care Override Indicator
            PACK      ATDTDSOV,SP70       * Duplicate Service Override
            PACK      ATDTSTXT,SP70       * Service Text
            PACK      ATDTLSPN,SP70       * Location Specific Practice No(LSPN)
            PACK      ATDTMPOV,SP70       * Multi Procedure Override
            PACK      ATDTNMPT,SP70       * Number of Patients Seen
            PACK      ATDTSDCD,SP70       * Self Deem Code (Cat Sd)
            PACK      ATDTTDUR,SP70       * Time Duration (Mins)
            PACK      ATDTROVR,SP70       * Restricted Override Code (Cat Ro)
            MOVE      ZERO,ATSPARE1
            MOVE      ZERO,ATSPARE2
            MOVE      SP70,ATSPARE
.
            MOVE      ATPATAMT,ATPATPOR
            MOVE      ZERO,ATREBPOR
            MOVE      RCBNTTYP,F1
            LOAD      ATPATPOR,F1,ZERO,ZERO,ZERO,ZERO
            LOAD      ATREBPOR,F1,ATPATAMT,ATPATAMT,ATPATAMT,ATPATAMT
.
            PACK      KEY22,ATNUMB,ATINVNO,ATTRANS
            CALL      WRDTRE1
.
. ---- allocate discount form A & E transactions ----
.
            COMPARE   ZERO,RCDTDISC
            GOTO      PATB7000 IF EQUAL
.
            MOVE      RCDTDISC,ATPATAMT
            MULT      "-1",ATPATAMT
            MOVE      HJNL,ATTYPE
.....       MOVE      ZERO,ATPAYTYP
            MOVE      "3",ATRECTYP
.
PATB1100    CALL      TRVISA1
.
            MOVE      PVITRAN,ATTRANS
            MOVE      ATPATAMT,ATPATPOR
            MOVE      ZERO,ATREBPOR
            MOVE      RCBNTTYP,F1
            LOAD      ATPATPOR,F1,ZERO,ZERO,ZERO,ZERO
            LOAD      ATREBPOR,F1,ATPATAMT,ATPATAMT,ATPATAMT,ATPATAMT
.           PACK      ATDTEFFD,TCC,TYY,TMM,TDD
            PACK      ATDTEFFD,CCC,CYY,CMM,CDD,SP70
            REP       " 0",ATDTEFFD
            MOVE      SP70,ATDTBTCH
            MOVE      SP70,ATDTSUBN
            MOVE      SP70,ATDTEDAD
            MOVE      SP70,ATDTSVTM
            MOVE      ZERO,ATDTSCHF
            MOVE      SP70,ATDTITYP
            MOVE      SP70,ATDTRBRS
.
            PACK      ATDTACOI,SP70       * After Care Override Indicator
            PACK      ATDTDSOV,SP70       * Duplicate Service Override
            PACK      ATDTSTXT,SP70       * Service Text
            PACK      ATDTLSPN,SP70       * Location Specific Practice No(LSPN)
            PACK      ATDTMPOV,SP70       * Multi Procedure Override
            PACK      ATDTNMPT,SP70       * Number of Patients Seen
            PACK      ATDTSDCD,SP70       * Self Deem Code (Cat Sd)
            PACK      ATDTTDUR,SP70       * Time Duration (Mins)
            PACK      ATDTROVR,SP70       * Restricted Override Code (Cat Ro)
            MOVE      ZERO,ATSPARE1
            MOVE      ZERO,ATSPARE2
            MOVE      SP70,ATSPARE
.
            PACK      KEY22,ATNUMB,ATINVNO,ATTRANS
            CALL      RDADTRE1
            COMPARE   ZERO,OVRCD
            GOTO      PATB1100 IF EQUAL
.
            CALL      WRDTRE1
            GOTO      PATB6000
.
. ---- outpatients ----
.
PATB3000    CLOSE     OUTDTRO1                   * Close dtran
            MOVE      "out",OSTFILE
            MOVE      PINVSITE,KEY6
            CALL      RDSITA1                    * Get the site for this pat
            PACK      CFNAME,OSTFILE,FILDTRO1
            OPEN      OUTDTRO1,CFNAME            * Open this sites dtran
.
            MOVE      PINVADM,KEY8
            CALL      RDVISA1
            COMPARE   ZERO,OVRCD
            GOTO      PATB3200 IF EQUAL
.
            CALL      UATT0000                * Check if visit is not attended
            BRANCH    OVRCD,PATB9500
.
PATB3100    PACK      KEY22,PINVADM,PINVNO,PVITRAN
            CALL      RDADTRO1
            IF        OVRCD = 0
              ADD       ONE,PVITRAN
              GOTO      PATB3100
            ENDIF
            GOTO      PATB3400
.
PATB3200    MOVE      PINVADM,OTNUMB
            UNPACK    RCDTINVN,DIM4,OTINVNO
            MOVE      PINVADM,PVIBILL
            MOVE      PVIBILL,KEY8
            CALL      TRVISA1
            BRANCH    OVRCD,PATB9500,PATB9500
.
.           See if DTR record already exists
.
            PACK      KEY22,PINVADM,PINVNO,PVITRAN
            CALL      RDADTRO1
            IF        OVRCD = 0
              GOTO      PATB3200
            ENDIF
.
PATB3400    MOVE      PVITRAN,OTTRANS
            CALL      GTRD0000               * Get transaction description
            MOVE      DIM30,OTDDESC
            MOVE      RCDTAMNT,AMOUNT
            MULT      "-1",AMOUNT
            MOVE      AMOUNT,OTPATAMT
            PACK      OTDDATE,TCC,TYY,TMM,TDD
            MOVE      SP4,OTITEMNO
            MOVE      "PY",OTTYPE
......      MOVE      TRNPTYPE,OTPAYTYP
            MOVE      RCDTRECN,OTRECEPT
            MOVE      "1",OTINVPRT
            MOVE      "2",OTRECTYP
.           PACK      OTDTEFFD,TCC,TYY,TMM,TDD
            PACK      OTDTEFFD,CCC,CYY,CMM,CDD,SP70
            REP       " 0",OTDTEFFD
            MOVE      ZERO,OTDTGSTA
            MOVE      SP10,OTDTGSTC
            MOVE      ZERO,OTDTGSTM
.
            MOVE      SP3,OTMISGRP
            MOVE      SP3,OTDEPTYP
            MOVE      SP8,OTBATCHN
            MOVE      SP70,OTDTBTCH
            MOVE      PAYMCODE,OTDTPCOD
.
            MOVE      OTPATAMT,OTPATPOR
            MOVE      ZERO,OTREBPOR
            MOVE      RCBNTTYP,F1
            LOAD      OTPATPOR,F1,ZERO,ZERO,ZERO,ZERO
            LOAD      OTREBPOR,F1,OTPATAMT,OTPATAMT,OTPATAMT,OTPATAMT
.
            PACK      KEY22,OTNUMB,OTINVNO,OTTRANS
            CALL      WRDTRO1
.
. ---- allocate discount for OUT transactions ----
.
            COMPARE   ZERO,RCDTDISC
            GOTO      PATB7000 IF EQUAL
.
            MOVE      RCDTDISC,OTPATAMT
            MULT      "-1",OTPATAMT
            MOVE      HJNL,OTTYPE
            MOVE      ZERO,OTPAYTYP
            MOVE      "3",OTRECTYP
            CALL      TRVISA1
            MOVE      PVITRAN,OTTRANS
            MOVE      OTPATAMT,OTPATPOR
            MOVE      ZERO,OTREBPOR
            MOVE      RCBNTTYP,F1
            LOAD      OTPATPOR,F1,ZERO,ZERO,ZERO,ZERO
            LOAD      OTREBPOR,F1,OTPATAMT,OTPATAMT,OTPATAMT,OTPATAMT
.           PACK      OTDTEFFD,TCC,TYY,TMM,TDD
            PACK      OTDTEFFD,CCC,CYY,CMM,CDD,SP70
            REP       " 0",OTDTEFFD
            MOVE      ZERO,OTDTGSTA
            MOVE      SP10,OTDTGSTC
            MOVE      ZERO,OTDTGSTM
            MOVE      SP70,OTDTBTCH
.
            PACK      KEY22,OTNUMB,OTINVNO,OTTRANS
            CALL      WRDTRO1
            GOTO      PATB6000
.
. ---- inpatients ----
.
PATB5000    MOVE      ZERO,TPATAMTG
            MOVE      ZERO,TPATAMTH
            MOVE      ZERO,TPATAMTI
            MOVE      PINVADM,TADMNO
            MOVE      PINVADM,PVIBILL
            MOVE      PVIBILL,KEY8
            CALL      TRVISA1
            BRANCH    OVRCD,PATB9500,PATB9500
.
.           See if DTR record already exists
.
            PACK      KEY22,PINVADM,PINVNO,PVITRAN
            CALL      RDADTRN1
            IF        OVRCD = 0
              GOTO      PATB5000
            ENDIF
            
            CALL      CLPATDTR              * clear patdtraf record
            MOVE      PINVADM,TADMNO
            MOVE      PVITRAN,TTRANSN1
            MOVE      RCDTAMNT,AMOUNT
            MULT      "-1",AMOUNT
            MOVE      AMOUNT,TPATAMTT
            MOVE      TPATAMTT,TPATAMTP
            MOVE      "P",TTYPEDEB
            MOVE      RCBNTTYP,F1
            LOAD      TPATAMTP,F1,ZERO,ZERO,ZERO,ZERO
            LOAD      TREBATE,F1,TPATAMTT,TPATAMTT,TPATAMTT,TPATAMTT
            LOAD      TTYPEDEB,F1,ANSH,ANSI,ANSG,ANSH
.
            PACK      KEY8,PINVADM,SP10
            CALL      RDMISS1
.
            MOVE      PINVUR,TDCODE
            LOAD      TDCODE,F1,RCBNRCOD,RCBNRCOD,RCBNRCOD
            MOVE      TCC,TFCENT
            MOVE      TYY,TFYEAR
            MOVE      TMM,TFMONTH
            MOVE      TDD,TFDAY
            MOVE      ZERO,TTCENT
            MOVE      ZERO,TTYEAR
            MOVE      ZERO,TTMONTH
            MOVE      ZERO,TTDAY
            MOVE      "PY",TTYPE
            MOVE      SP4,TITEMNO
            UNPACK    RCDTINVN,DIM4,TREF
......      MOVE      TRNPTYPE,TPAYTYPE
            MOVE      RCDTRECN,TRECEIPT
            CALL      GTRD0000               * Get transaction description
            MOVE      DIM30,TDDESC
            MOVE      "1",TINVPRT
            MOVE      "5",TRECTYPE
            IF        TRNSYS = 93
              MOVE      RCDTREGI,TMISGRP
            ELSE
              MOVE      SP3,TMISGRP
            ENDIF
            MOVE      ZERO,PTDTGSTA
            MOVE      SP6,PTDTGSTC
            MOVE      ZERO,PTDTGSTM
            MOVE      ZERO,PTDTGSTL
.           PACK      PTDTEFFD,TCC,TYY,TMM,TDD
            PACK      PTDTEFFD,CCC,CYY,CMM,CDD,SP70
            REP       " 0",PTDTEFFD
            MOVE      PAYMCODE,PTDTPCOD
.
            PACK      KEY22,TADMNO,TREF,TTRANSN1
            CALL      WRDTRN1
.
. ---- allocate discount for IN transactions ----
.
            COMPARE   ZERO,RCDTDISC
            GOTO      PATB7000 IF EQUAL
.
            MOVE      RCDTDISC,TPATAMTT
            MULT      "-1",TPATAMTT
            MOVE      TPATAMTT,TPATAMTP
            MOVE      ZERO,TREBATE
            MOVE      RCBNTTYP,F1
            LOAD      TPATAMTP,F1,ZERO,ZERO,ZERO,ZERO
            LOAD      TREBATE,F1,TPATAMTT,TPATAMTT,TPATAMTT,TPATAMTT
            MOVE      HJNL,TTYPE
            MOVE      ZERO,TPAYTYPE
            MOVE      "6",TRECTYPE
            CALL      TRVISA1
            MOVE      PVITRAN,TTRANSN1
            MOVE      SP10,PTDTEFFD
.           PACK      PTDTEFFD,TCC,TYY,TMM,TDD
            PACK      PTDTEFFD,CCC,CYY,CMM,CDD,SP70
            REP       " 0",PTDTEFFD
.
            PACK      KEY22,TADMNO,TREF,TTRANSN1
            CALL      WRDTRN1
.
. ---- write discount journal info to journal file ----
. ---- use the reciept date, NOT the current date  ----
.
PATB6000    MOVE      HJNL,JCODE
.           PACK      JDATE,TCC,TYY,TMM,TDD
            PACK      JDATE,CCC,CYY,CMM,CDD
            REPLACE   " 0",JDATE
            MOVE      PINVADM,JADMN
            MOVE      PVITRAN,JTRNS
            UNPACK    RCDTINVN,DIM4,JINVN
            MOVE      SP70,PTJRINDC
.
            MOVE      USERID,PTJRCUID              * Created by
            PACK      PTJRCDAT,CCC,CYY,CMM,CDD
            REP       " 0",PTJRCDAT                * Date created
            CLOCK     TIME,PTJRCTIM                * Time created
            MOVE      SP70,JSPARE
.
            PACK      KEY24,JCODE,JDATE,JADMN,JTRNS
            CALL      WRJRNL1
.
. ---- set and write discount to PATFINS file ----
.
.           PACK      FINDATE,TCC,TYY,TMM,TDD
            PACK      FINDATE,CCC,CYY,CMM,CDD
            REP       " 0",FINDATE
            MOVE      PINVSYS,FINSYS
            MOVE      PINVSITE,FINSITE
            MOVE      RCDTDISC,FINAMT
            PACK      FINTYPE,ANSC,SP70
            IF        PTCNJFEE=1
              PACK      FINCODE,ACLAIM,HJNL,SP20
.                                 Claim Code, Journal Code
            ELSE
              PACK      FINCODE,HJNL,SP20
.                                 Journal Code
            ENDIF
            MOVE      ZERO,FGSTFLAG
            MOVE      PMVXMHOS,FINHOSP
            CALL      PATCALF
.
. ---- set and write to PATFINS file ----
.
PATB7000    
.           PACK      FINDATE,TCC,TYY,TMM,TDD
            PACK      FINDATE,CCC,CYY,CMM,CDD
            REP       " 0",FINDATE
            MOVE      PINVSYS,FINSYS
            MOVE      PINVSITE,FINSITE
            MULT      "-1",AMOUNT
            MOVE      AMOUNT,FINAMT
            PACK      FINTYPE,ANSB,SP70
            MOVE      RCBNTTYP,F1
            BRANCH    F1,PATB7100,PATB7200,PATB7300,PATB7100
.
            PACK      FINCODE,ANSA,SP20
            GOTO      PATB7500
.
PATB7100    PACK      FINCODE,ANSB,RCBNRCOD,SP70
            GOTO      PATB7500
.
PATB7200    PACK      FINCODE,ANSI,RCBNRCOD,SP70
            GOTO      PATB7500

PATB7300    PACK      FINCODE,ANSC,SP20
.
PATB7500    MOVE      ZERO,FGSTFLAG
            MOVE      PMVXMHOS,FINHOSP
            CALL      PATCALF
.
. ---- set and write to CASH RECEIPTS file ----
.
PATB7600    COMPARE   ONE,HPRTREC            * Printing receipts in IBABIL21 ?
            GOTO      PATB8000 IF NOT EQUAL  * No. Don't write to receipts file
.
            UNPACK    RCDTINVN,DIM4,KEY8
            CALL      RDHFRE1
            BRANCH    OVRCD,PATB7800
.
            MOVE      ZERO,HFRSTAT
            CALL      UPHFRE1
            GOTO      PATB8000
.
PATB7800    UNPACK    RCDTINVN,DIM4,HFRINVR
            MOVE      ZERO,HFRSTAT
            CALL      WRHFRE1
.
. ---- set and write to INVOICE file ----
.
PATB8000    MULT      "-1",AMOUNT
            SUB       AMOUNT,PINVPCSH
            SUB       RCDTDISC,PINVJOUR
            MOVE      RCBNTTYP,F1
            BRANCH    F1,PATB8100,PATB8200,PATB8200,PATB8100
.
            ADD       AMOUNT,PINVPATA
            GOTO      PATB8500
.
PATB8100    ADD       AMOUNT,PINVHFDA
            GOTO      PATB8500
.
PATB8200    ADD       AMOUNT,PINVOTHA
.
.           Check if the invoice is now balanced
.
PATB8500    MOVE      "99999999",PINVBLCD        * assume not balanced
            MOVE      PINVAMT,F12P2
            ADD       PINVPATA,F12P2
            ADD       PINVHFDA,F12P2
            ADD       PINVOTHA,F12P2
            ADD       PTINCRTT,F12P2             * Credit Notes +
            ADD       PINVJOUR,F12P2
            ADD       PTINGSTJ,F12P2             * Journal GST = amt outstanding
.
            COMPARE   "0.00",F12P2               * invoice balanced ?
            GOTO      PATB8600 IF NOT EQUAL      * not balanced
.
            PACK      PINVBLCD,CCC,CYY,CMM,CDD   * balanced at current date
            REP       " 0",PINVBLCD
.
PATB8600    PACK      PTINUDAT,CCC,CYY,CMM,CDD
            REP       " 0",PTINUDAT             * date updated
            CLOCK     TIME,PTINUTIM             * time updated
            MOVE      USERID,PTINUUID           * web user id
            CALL      UPINV1
.
.       If invoice is full paid or overpaid remove further Debtor Future Actions
.
            IF        F12P2<=0.00
              CALL      DFAC0000           * Delete Future Action from Act.Plan
              CALL      UPFAPPLN           * Update FA Completion date
              GOTO      PATB9000
            ENDIF
.
.       Check if Health Fund or Patient portions are full paid
.
            CALL      CPAY0000
.
PATB9000    PROC      FLAGDEBT                                        *I-119436
            MOVE      ZERO,EXIT
            GOTO      PATB9999
.
PATB9500    MOVE      ONE,NOINVFLG
.
PATB9800    MOVE      ONE,EXIT
PATB9999    RETURN
+
.------------------------------------------------------------             
.           Check for Un-attended Outpatient
.------------------------------------------------------------             
UATT0000    PACK      CFNAME,OSTFILE,FILBOKA6
            OPEN      OUTBOKA6,CFNAME
.
            PACK      KEY36,DPINVADM,SP70
            CALL      RDSBOKA6
            CALL      RDKBOKA6
            BRANCH    OVRCD,UATT9000
.
            MATCH     DPINVADM,DOBAOUTN
            GOTO      UATT9000 IF NOT EQUAL
.
            MATCH     "5",DOBASTAT          * Check for NOT attended
            GOTO      UATT9000 IF NOT EQUAL
.
            MOVE      ZERO,F6
            PACK      KEY22,DPINVADM,PINVNO,Z70
            CALL      RDSDTRO1
            CALL      RDPDTRO1
            BRANCH    OVRCD,UATT8000
.
            MATCH     DPINVADM,DOTNUMB      * different visit number
            GOTO      UATT8000 IF NOT EQUAL
            MATCH     PINVNO,OTINVNO
            GOTO      UATT8000 IF NOT EQUAL * different invoice number
.
            MOVE      OTTRANS,F6
.
UATT8000    MOVE      F6,OTTRANS
            ADD       ONE,OTTRANS
            MOVE      OTTRANS,PVITRAN
.
            MOVE      ZERO,OVRCD
            GOTO      UATT9999
.
UATT9000    MOVE      ONE,OVRCD
UATT9999    RETURN
+
.------------------------------------------------------------             
.       Check if Health Fund or Patient portions are full paid
.------------------------------------------------------------             
CPAY0000  MATCH     "1",PTCNDFUP
          GOTO      CPAY9999 IF NOT EQUAL
.
          MOVE      ONE,F1
          MOVE      PINVREB,FORM12P2
          ADD       PINVHFDA,FORM12P2      * Health fund payment
.
.         Check Health fund fully paid the Health fund portion of invoice
.
          COMPARE   ZERO,FORM12P2
          GOTO      CPAY5000 IF EQUAL      * Health fund fully paid HF portion
.
.         Check Patient portion
.
CPAY1000  MOVE      TWO,F1
          MOVE      PINVAMT,FORM12P2
          SUB       PINVREB,FORM12P2       * Patient Portion
          ADD       PINVPATA,FORM12P2      * Patient payment
.
.         Check patient fully paid the patient portion of invoice
.
          COMPARE   ZERO,FORM12P2
          GOTO      CPAY2000 IF EQUAL      * Fully paid
          GOTO      CPAY9999 IF NOT LESS
.
.         Patient portion is fully paid or overpaid, check reassign debt
.
CPAY2000  CALL      REAS0000    * Check for any Patient portion reassign debt
          COMPARE   ZERO,PTRAPPOR
          GOTO      CPAY9999 IF NOT EQUAL
.
          MOVE      "P",KEY1               * Patient future action
          GOTO      CPAY6000
.
CPAY5000  MOVE      "H",KEY1               * Health fund future action
CPAY6000  PACK      DIM8,CCC,CYY,CMM,CDD    * setup current date
          REP       " 0",DIM8
          PACK      KEY19,DPINVADM,DIM8,SP70
CPAY6200  CALL      RDSFACT1
CPAY6400  CALL      RDKFACT1
          BRANCH    OVRCD,CPAY8000
.
          MATCH     DPINVADM,DFADMNO
          GOTO      CPAY8000 IF NOT EQUAL
.
          MATCH     PINVNO,PTFCINVN          * same invoice number?
          GOTO      CPAY6400 IF NOT EQUAL
.
          MOVE      "FA",TCODE
          PACK      KEY5,TCODE,FACODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CPAY6400
.
          MATCH     KEY1,TCINDC1
          GOTO      CPAY6400 IF NOT EQUAL
.
          PACK      KEY19,DFADMNO,FADATE,FACODE,SP70
          CALL      DEFACT1
          GOTO      CPAY6200
.
CPAY8000  BRANCH    F1,CPAY1000
CPAY9999  RETURN
+
.*******************************************************************************
.         Check Reassign debt file
.*******************************************************************************
REAS0000  PACK      KEY10,PINVNO,Z70
          CALL      RSPTRAS1
          CALL      RPPTRAS1
          BRANCH    OVRCD,REAS9000
.
          MATCH     PINVNO,PTRAINVN          * Same invoice number?
          GOTO      REAS9000 IF NOT EQUAL
          MATCH     "1",PTRADELE             * Deleted?
          GOTO      REAS9999 IF NOT EQUAL
.
REAS9000  MOVE      ZERO,PTRAPPOR
REAS9999  RETURN
+
.------------------------------------------------------------             
.         Delete Future Actions where tcindc1= H,B or P                   
.------------------------------------------------------------
DFAC0000  MATCH     "1",PTCNDFUP
          GOTO      DFAC9999 IF NOT EQUAL
.
          PACK      DIM8,CCC,CYY,CMM,CDD    * setup current date
          REP       " 0",DIM8
          PACK      KEY19,DPINVADM,DIM8,SP70
DFAC1000  CALL      RDSFACT1
DFAC2000  CALL      RDKFACT1
          BRANCH    OVRCD,DFAC9999
.
          MATCH     DPINVADM,DFADMNO
          GOTO      DFAC9999 IF NOT EQUAL
.
          MATCH     PINVNO,PTFCINVN          * same invoice number?
          GOTO      DFAC2000 IF NOT EQUAL
.
          MOVE      "FA",TCODE
          PACK      KEY5,TCODE,FACODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,DFAC2000
.
          MATCH     "H",TCINDC1
          GOTO      DFAC4000 IF EQUAL
          MATCH     "B",TCINDC1
          GOTO      DFAC4000 IF EQUAL
          MATCH     "P",TCINDC1
          GOTO      DFAC2000 IF NOT EQUAL
.
DFAC4000  PACK      KEY19,DFADMNO,FADATE,FACODE,SP70
          CALL      DEFACT1
          GOTO      DFAC1000
.
DFAC9999  RETURN
+
.**************************************************************************
.*                             NURS0000                                   *
.*                    nursing home billing interface                      *
.**************************************************************************
.
. ---- set and write to DTRAN file ----
.
NURS0000    UNPACK    RCDTTDAT,TCC,TYY,TMM,TDD
            UNPACK    RCDTINVN,DIM4,KEY8
            CALL      RDINV1
            BRANCH    OVRCD,NURS9500
.
            MOVE      PINVNO,FININVN        * set fields for Financial details
            MOVE      PINVADM,FINADMN
            MOVE      PINVUR,FINURNO
.
            BRANCH    PINVSYS,NURS9500,NURS9500,NURS5000,NURS9500
.
. ---- inpatients ----
.
NURS5000    MOVE      ZERO,TPATAMTG
            MOVE      ZERO,TPATAMTH
            MOVE      ZERO,TPATAMTI
            MOVE      PINVADM,TADMNO
            MOVE      PINVADM,PVIBILL
            MOVE      PVIBILL,KEY8
            CALL      TRVISA1
            BRANCH    OVRCD,NURS9500,NURS9500
.
.           See if DTR record already exists
.
            PACK      KEY22,PINVADM,PINVNO,PVITRAN
            CALL      RDADTRN1
            IF        OVRCD = 0
              GOTO      NURS5000
            ENDIF
.
            CALL      CLPATDTR              * clear patdtraf record
            MOVE      PINVADM,TADMNO
            MOVE      PVITRAN,TTRANSN1
            MOVE      RCDTAMNT,AMOUNT
            MULT      "-1",AMOUNT
            MOVE      AMOUNT,TPATAMTT
            MOVE      TPATAMTT,TPATAMTP
            MOVE      ZERO,TREBATE
            MOVE      "P",TTYPEDEB
            MOVE      RCBNTTYP,F1
            LOAD      TPATAMTP,F1,ZERO,ZERO,ZERO,ZERO
            LOAD      TREBATE,F1,TPATAMTT,TPATAMTT,TPATAMTT,TPATAMTT
            LOAD      TTYPEDEB,F1,ANSH,ANSI,ANSG,ANSH
.
            PACK      KEY8,PINVADM,SP10
            CALL      RDMISS1
.
            MOVE      PINVUR,TDCODE
            MOVE      RCBNTTYP,F1
            LOAD      TDCODE,F1,RCBNRCOD,RCBNRCOD,RCBNRCOD,RCBNRCOD
            MOVE      TCC,TFCENT
            MOVE      TYY,TFYEAR
            MOVE      TMM,TFMONTH
            MOVE      TDD,TFDAY
            MOVE      ZERO,TTCENT
            MOVE      ZERO,TTYEAR
            MOVE      ZERO,TTMONTH
            MOVE      ZERO,TTDAY
            MOVE      "PY",TTYPE
            MOVE      SP4,TITEMNO
.
            UNPACK    RCDTINVN,DIM4,TREF
......      MOVE      TRNPTYPE,TPAYTYPE
            MOVE      RCDTRECN,TRECEIPT
            CALL      GTRD0000               * Get transaction description
            MOVE      DIM30,TDDESC
            MOVE      "1",TINVPRT
            MOVE      "5",TRECTYPE
.           PACK      PTDTEFFD,TCC,TYY,TMM,TDD
            PACK      PTDTEFFD,CCC,CYY,CMM,CDD,SP70
            REP       " 0",PTDTEFFD
            MOVE      SP70,PTDTPCOD
.
            PACK      KEY22,TADMNO,TREF,TTRANSN1
            CALL      WRDTRN1
.
. ---- set and write to PATFINS file ----
.
NURS7000    
.           PACK      FINDATE,TCC,TYY,TMM,TDD
            PACK      FINDATE,CCC,CYY,CMM,CDD
            REP       " 0",FINDATE
            MOVE      PINVSYS,FINSYS
            MOVE      PINVSITE,FINSITE
            MULT      "-1",AMOUNT
            MOVE      AMOUNT,FINAMT
            PACK      FINTYPE,ANSB,SP70
            MOVE      RCBNTTYP,F1
            BRANCH    F1,NURS7100,NURS7200,NURS7300,NURS7100
.
            PACK      FINCODE,ANSA,SP20
            GOTO      NURS7500
.
NURS7100    PACK      FINCODE,ANSB,RCBNRCOD,SP70
            GOTO      NURS7500
.
NURS7200    PACK      FINCODE,ANSI,RCBNRCOD,SP70
            GOTO      NURS7500

NURS7300    PACK      FINCODE,ANSC,SP20
.
NURS7500    MOVE      ZERO,FGSTFLAG
            MOVE      PMVXMHOS,FINHOSP
            CALL      PATCALF
.
. ---- set and write to CASH RECEIPTS file ----
.
NURS7600    COMPARE   ONE,HPRTREC            * Printing receipts in IBABIL21 ?
            GOTO      NURS8000 IF NOT EQUAL  * No. Don't write to receipts file
.
            UNPACK    RCDTINVN,DIM4,KEY8
            CALL      RDHFRE1
            BRANCH    OVRCD,NURS7800
.
            MOVE      ZERO,HFRSTAT
            CALL      UPHFRE1
            GOTO      NURS8000
.
NURS7800    UNPACK    RCDTINVN,DIM4,HFRINVR
            MOVE      ZERO,HFRSTAT
            CALL      WRHFRE1
.
. ---- set and write to INVOICE file ----
.
NURS8000    MULT      "-1",AMOUNT
            SUB       AMOUNT,PINVPCSH
            SUB       RCDTDISC,PINVJOUR
            MOVE      RCBNTTYP,F1
            BRANCH    F1,NURS8100,NURS8200,NURS8200,NURS8100
.
            ADD       AMOUNT,PINVPATA
            GOTO      NURS8500
.
NURS8100    ADD       AMOUNT,PINVHFDA
            GOTO      NURS8500
.
NURS8200    ADD       AMOUNT,PINVOTHA
.
.           Check if the invoice is now balanced
.
NURS8500    MOVE      "99999999",PINVBLCD        * assume not balanced
            MOVE      PINVAMT,F12P2
            ADD       PINVPATA,F12P2
            ADD       PINVHFDA,F12P2
            ADD       PINVOTHA,F12P2
            ADD       PTINCRTT,F12P2             * Credit Notes +
            ADD       PINVJOUR,F12P2
            ADD       PTINGSTJ,F12P2             * Journal GST = amt outstanding
.
            COMPARE   "0.00",F12P2               * invoice balanced ?
            GOTO      NURS8600 IF NOT EQUAL      * not balanced
.
            PACK      PINVBLCD,CCC,CYY,CMM,CDD   * balanced at current date
            REP       " 0",PINVBLCD
.
NURS8600    PACK      PTINUDAT,CCC,CYY,CMM,CDD
            REP       " 0",PTINUDAT             * date updated
            CLOCK     TIME,PTINUTIM             * time updated
            MOVE      USERID,PTINUUID           * web user id
            CALL      UPINV1
.
.       If invoice is full paid or overpaid remove further Debtor Future Actions
.
            IF        F12P2<=0
              CALL      DFAC0000           * Delete Future Action from Act.Plan
              CALL      UPFAPPLN           * Update FA Completion date
            ENDIF
.
            PROC      FLAGDEBT                                        *I-119436
            MOVE      ZERO,EXIT
            GOTO      NURS9999
.
NURS9500    MOVE      ONE,EXIT
.
NURS9999    RETURN
+
.**************************************************************************
.*                             PP0000                                     *
.*                         private practice interface                     *
.**************************************************************************
PP0000      MATCH     SP70,RCDTINVN
            GOTO      PP9800 IF EQUAL
.
            CALL      CLPRIDTR
.
            UNPACK    RCDTINVN,DIM4,KEY8
            CALL      RDPRIN1               * read the invoice file
            BRANCH    OVRCD,PP9500
.
            UNPACK    RCDTTDAT,TCC,TYY,TMM,TDD
            MOVE      PRINUNIQ,PRDTUNIQ
            MOVE      PRINDEBT,PRDTDEBT
            MOVE      PRINSCAN,PRDTSCAN
            UNPACK    RCDTINVN,DIM4,PRDTINVN
            CALL      TRPRIN1                  * next trx number
            MOVE      PRINTRAN,PRDTTRAN
.
. ---- check if a valid trx number has been allocated ----
.
            PACK      KEY22 WITH PRDTUNIQ,PRDTINVN,PRDTTRAN
            CALL      RAPRDT1 
            COMPARE   ZERO,OVRCD
            GOTO      PP0000 IF EQUAL
.
            CALL      GTRD0000               * Get transaction description
            MOVE      DIM30,PRDTDESC
            MOVE      RCDTAMNT,AMOUNT
            MOVE      AMOUNT,PRDTAMNT
            MULT      "-1",PRDTAMNT
            PACK      PRDTSDAT,RCDTTDAT
            REP       " 0",PRDTSDAT
            MOVE      SP10,PRDTSTIM
            MOVE      PRINDOCT,PRDTDOCT
            MOVE      ONE,PRDTSERV
            MOVE      SP10,PRDTREFD
            MOVE      SP3,PRDTCLAM
            MOVE      SP20,PRDTREFT
            MOVE      SP3,PRDTMESS
            MOVE      SP10,PRDTITMN
            MOVE      "PY",PRDTTTYP
            MOVE      ONE,PRDTMETH
......      MOVE      TRNPTYPE,PRDTMETH
.           MOVE      RCDTRECN,PRDTRECN
            UNPACK    RCDTRECN,KEY4,PRDTRECN
            MOVE      "1",PRDTINVP
            MOVE      "2",PRDTRTYP
            MOVE      PRINPRAC,PRDTPRAC
            MOVE      RCBNTTYP,PRDTIFLG
            ADD       ONE,PRDTIFLG
            PACK      PRDTEFFD,CCC,CYY,CMM,CDD,SP70
            REP       " 0",PRDTEFFD
.
            UNPACK    SP70,PRDTBATC,PRDTUDF1,PRDTUDF2,PRDTUDF3,PRDTUDF4
            UNPACK    SP70,PRDTADMN,PRDTMISG,PRDTRDTE,PRDTOPS
            MOVE      ZERO,PRDTMFLG
            UNPACK    SP70,PRDTMEDA,PRDTGSTC,PRDTRFPD,PRDTREFN
            UNPACK    SP70,PRDTENCN,PRDTCNST
            MOVE      ZERO,PRDTIAMT
            MOVE      ZERO,PRDTGSTA
            MOVE      ZERO,PRDTGSTM
            MOVE      ZERO,PRDTPFLG
            MOVE      ZERO,PRDTS4B3
            MOVE      PAYMCODE,PRDTPCOD
            MOVE      SP70,PRDTSPAR
.
            PACK      KEY22 WITH PRDTUNIQ,PRDTINVN,PRDTTRAN
            CALL      WRPRDT1
.
. ---- allocate discount for PP transactions ----
.
            COMPARE   ZERO,RCDTDISC
            GOTO      PP3000 IF EQUAL
.
            MOVE      RCDTDISC,PRDTAMNT
            MULT      "-1",PRDTAMNT
            MOVE      HJNL,PRDTTTYP
            MOVE      ZERO,PRDTMETH
            MOVE      "3",PRDTRTYP
            UNPACK    RCDTINVN,DIM4,KEY8
            CALL      RDPRIN1
            MOVE      PRINSCAN,PRDTSCAN
            CALL      TRPRIN1              * next trx number
            MOVE      PRINTRAN,PRDTTRAN
.
            PACK      KEY22 WITH PRDTUNIQ,PRDTINVN,PRDTTRAN
            CALL      WRPRDT1
.
. ---- Update the financial statistics and journals file for the discount ----
. NB. use receipt date, not current date
.
            REP       " 0",RCDTTDAT
            MOVE      SP4,PRJRSPAR
            PACK      PRJRCODE,HJNL,SP10     * pad to three characters
            PACK      KEY35,PRJRCODE,RCDTTDAT:
                            PRINDEBT,PRINSCAN,PRDTTRAN,PRINNUMB
            CALL      WRPRJR1
.
.           PACK      FSTDATE,RCDTTDAT
            PACK      FSTDATE,CCC,CYY,CMM,CDD
            REP       " 0",FSTDATE
            MOVE      RCDTDISC,FSTAMNT
            PACK      PRFNTYPE,ANSC,SP70
            PACK      PRFNCODE,HJNL,SP10
            MOVE      PRDTPRAC,PRFNMPRA
            MOVE      ZERO,FGSTFLAG
            CALL      PRICALFS
. 
.
.------------------------------------------------------------------------------
.         Update Private practice statistics for cash
.------------------------------------------------------------------------------
.
PP3000      UNPACK    PRINDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      PRINPRAC,PRSTPRAC
            MOVE      PRINDOCT,PRSTDOCT
            PACK      CPTDATE,RCDTTDAT
            REP       " 0",CPTDATE
            CALL      GPERD                 * get period
            COMPARE   ONE,EXIT
            IF        @EQUAL
              DISPLAY   *P1:24,*EL,*B,"Date not found in date range period ":
                               "file. ";
              CALL      HITENTER
              GOTO      PP3000
            ENDIF
.
            MOVE      DRGNUM,IMON
            MOVE      DRGYR,PRSTYEAR
.
            PACK      KEY20 WITH PRSTYEAR,PRSTPRAC,PRSTDOCT
            CALL      RDPRST1
            BRANCH    OVRCD,PP3100
.
.           Add amount to appropriate field. Also update discount if applicable
.
            LOAD      F12P2,IMON,PRSTCP01,PRSTCP02,PRSTCP03,PRSTCP04:
                                  PRSTCP05,PRSTCP06,PRSTCP07,PRSTCP08:
                                  PRSTCP09,PRSTCP10,PRSTCP11,PRSTCP12,PRSTCP13
            ADD       AMOUNT,F12P2
            STORE     F12P2,IMON,PRSTCP01,PRSTCP02,PRSTCP03,PRSTCP04:
                                  PRSTCP05,PRSTCP06,PRSTCP07,PRSTCP08:
                                  PRSTCP09,PRSTCP10,PRSTCP11,PRSTCP12,PRSTCP13
.
            LOAD      F12P2,IMON,PRSTJP01,PRSTJP02,PRSTJP03,PRSTJP04:
                                  PRSTJP05,PRSTJP06,PRSTJP07,PRSTJP08:
                                  PRSTJP09,PRSTJP10,PRSTJP11,PRSTJP12,PRSTJP13
            SUB       RCDTDISC,F12P2           * reverse sign for journals
            STORE     F12P2,IMON,PRSTJP01,PRSTJP02,PRSTJP03,PRSTJP04:
                                  PRSTJP05,PRSTJP06,PRSTJP07,PRSTJP08:
                                  PRSTJP09,PRSTJP10,PRSTJP11,PRSTJP12,PRSTJP13
.
            CALL      UPPRST1 
            GOTO      PP5000
.
.           Record doesn't exist - create new record with zero opening balance
.
PP3100      MOVE      ZERO,CLNO
            MOVE      SP20,PRSTSPAR
.
PP3110      ADD       ONE,CLNO
            COMPARE   CLNO,FORTY
            GOTO      PP3120 IF LESS
.
            STORE     ZERO,CLNO,PRSTOBAL,PRSTIP01,PRSTIP02,PRSTIP03,PRSTIP04:
                                        PRSTIP05,PRSTIP06,PRSTIP07,PRSTIP08:
                                        PRSTIP09,PRSTIP10,PRSTIP11,PRSTIP12:
                                        PRSTIP13:
                                        PRSTCP01,PRSTCP02,PRSTCP03,PRSTCP04:
                                        PRSTCP05,PRSTCP06,PRSTCP07,PRSTCP08:
                                        PRSTCP09,PRSTCP10,PRSTCP11,PRSTCP12:
                                        PRSTCP13:
                                        PRSTJP01,PRSTJP02,PRSTJP03,PRSTJP04:
                                        PRSTJP05,PRSTJP06,PRSTJP07,PRSTJP08:
                                        PRSTJP09,PRSTJP10,PRSTJP11,PRSTJP12:
                                        PRSTJP13 
            GOTO      PP3110
.
.           Add amount to appropriate field. Also any discount
.
PP3120      MOVE      AMOUNT,F12P2
            STORE     F12P2,IMON,PRSTCP01,PRSTCP02,PRSTCP03,PRSTCP04:
                                  PRSTCP05,PRSTCP06,PRSTCP07,PRSTCP08:
                                  PRSTCP09,PRSTCP10,PRSTCP11,PRSTCP12,PRSTCP13
.
            MOVE      RCDTDISC,F12P2
            MULT      "-1",F12P2              * reverse sign for journals
            STORE     F12P2,IMON,PRSTJP01,PRSTJP02,PRSTJP03,PRSTJP04:
                                  PRSTJP05,PRSTJP06,PRSTJP07,PRSTJP08:
                                  PRSTJP09,PRSTJP10,PRSTJP11,PRSTJP12,PRSTJP13
            CALL      WRPRST1
.
. ---- set and write to PRIFINS file ----
.
PP5000      
.           PACK      FSTDATE,RCDTTDAT
            PACK      FSTDATE,CCC,CYY,CMM,CDD
            REP       " 0",FSTDATE
            MOVE      AMOUNT,FSTAMNT
            PACK      PRFNTYPE,ANSB,SP70
            MOVE      RCBNTTYP,F1
            BRANCH    F1,PP5100,PP5200,PP5300,PP5100
.
            PACK      PRFNCODE,ANSA,SP70
            GOTO      PP5500
.
PP5100      PACK      PRFNCODE,ANSB,RCBNRCOD,SP70
            GOTO      PP5500
.
PP5200      PACK      PRFNCODE,ANSI,RCBNRCOD,SP70
            GOTO      PP5500
.
PP5300      PACK      PRFNCODE,ANSC,SP20
.
PP5500      MOVE      ZERO,FGSTFLAG
            MOVE      PRINPRAC,PRFNMPRA
            CALL      PRICALFS
.
. ---- set and write to invoice file ----
.
            SUB       AMOUNT,PRINPEND
            SUB       RCDTDISC,PRINJAMT
            MOVE      RCBNTTYP,F1
            BRANCH    F1,PP8100,PP8200,PP8200,PP8100
.
            SUB       AMOUNT,PRINPAMT
            GOTO      PP8500
.
PP8100      SUB       AMOUNT,PRINHAMT
            GOTO      PP8500
.
PP8200      SUB       AMOUNT,PRINOTHA
.
PP8500      ADD       ONE,PRINTRAN
            PACK      PRINUDAT,CCC,CYY,CMM,CDD
            REP       " 0",PRINUDAT             * date updated
            CLOCK     TIME,PRINUTIM             * time updated
            MOVE      USERID,PRINUUID           * web user id
            CALL      UPPRIN1
.                                                                     *I-210835
            IF        PRINSCAN = 1
              PROC      FLAGDEBP                * Flag PMI Outstanding Debt
            ENDIF
            SUB       ONE,PRINTRAN
.
            CALL      CBAL0000           * Check if invoice balanced
            GOTO      PP9999
.
PP9500      MOVE      ONE,NOINVFLG
PP9800      MOVE      ONE,EXIT
.
PP9999      RETURN
+
.**************************************************************************
.*                             CBAL0000                                   *
.*                Check if invoice is balanced                            *
.**************************************************************************
CBAL0000  MOVE      PRINITOT,F12P2
          ADD       PRINPAMT,F12P2
          ADD       PRINHAMT,F12P2
          ADD       PRINIAMT,F12P2
          ADD       PRINMAMT,F12P2
          ADD       PRINVAMT,F12P2
          ADD       PRINOTHA,F12P2
          ADD       PRINJAMT,F12P2
.
          COMPARE   ZERO,F12P2
          GOTO      CBAL9999 IF NOT EQUAL       * invoice not balanced
.
          PACK      KEY22,PRINUNIQ,PRINNUMB,SP20
          CALL      RSPRDT1
CBAL1000  CALL      RKPRDT1
          BRANCH    OVRCD,CBAL9999
.
          COMPARE   PRINUNIQ,PRDTUNIQ
          GOTO      CBAL9999 IF NOT EQUAL       * different unique number
.
          MATCH     PRINNUMB,PRDTINVN
          GOTO      CBAL9999 IF NOT EQUAL       * different invoice number
.
.         COMPARE   ONE,PRDTAPAY
.         GOTO      CBAL9999 IF NOT EQUAL       * accounts payable not set
.
          BRANCH    PRDTRTYP,CBAL2000,CBAL1000,CBAL2000  * only item & journal
.
CBAL2000  MOVE      TWO,PRDTAPAY                * accounts payable flag- balance
          CALL      UPPRDT1
          GOTO      CBAL1000
.
CBAL9999  RETURN
+
.**************************************************************************
.*                             MEDS0000                                   *
.*                        medical services interface                      *
.**************************************************************************
MEDS0000    RETURN
+
.*****************************************************************************
.*                                 CDEP0000                                  *
.*      Post to the cash deposits file                                       *
.*****************************************************************************
CDEP0000  OPEN      COMDEPA1,"comdepaf"
.
          PACK      CMDETDAT,RCDTTDAT,SP70
          PACK      CMDERECN,RCDTRECN,SP70
          PACK      CMDETCNT,RCDTTCNT,SP70
          PACK      CMDEDTYP,RCDTDPTY,SP70
          PACK      CMDERRFN,SP70
          PACK      CMDEREFT,SP70
          PACK      CMDEURNO,RCDTURNO,SP70
          PACK      CMDEADMN,RCDTVIST,SP70
          PACK      CMDESFLG,RCDTSFLG,SP70
          MOVE      SP70,CMDESDOC
          IF        TRNSYS=96 | TRNSYS=2
            MOVE      "1",CMDESFLG             * Set to PMI for PP
            PACK      CMDESDOC,RCDTSDOC,SP70   * PP Service doctor
          ENDIF
.
          COMPARE   "90",TRNSYS                * EMR deposits
          IF        @EQUAL
            MOVE      "1",CMDESYST
          ENDIF
          COMPARE   "91",TRNSYS                * Oupatient deposits
          IF        @EQUAL
            MOVE      "2",CMDESYST
          ENDIF
          COMPARE   "97",TRNSYS                * Patient cash deposits
          IF        @EQUAL
            MOVE      "3",CMDESYST
          ENDIF
          COMPARE   "96",TRNSYS                * P.P. cash deposits
          IF        @EQUAL
            MOVE      "4",CMDESYST
          ENDIF
          PACK      CMDEPRAC,RCDTPRAC,SP70
          PACK      CMDECDAT,CCC,CYY,CMM,CDD
          REP       " 0",CMDECDAT
          CLOCK     TIME,CMDECTIM
          PACK      CMDECUID,RCDTCUID,SP70
          PACK      CMDEUDAT,SP70
          PACK      CMDEUTIM,SP70
          PACK      CMDEUUID,SP70
          PACK      CMDEAINV,RCDTINVN,SP70
          PACK      CMDEREFD,SP70
          MATCH     SP70,RCDTINVN
          IF        !@EQUAL
            UNPACK    RCDTINVN,DIM4,KEY8
            IF        TRNSYS=96
              CALL      RDPRIN1               * read the invoice file
              IF        OVRCD=0
                PACK      CMDEREFD,PRINDATE   * PP invoice date
              ENDIF
            ELSE
              CALL      RDINV1
              IF        OVRCD=0
                PACK      CMDEREFD,PINVDTE    * Patient invoice date
              ENDIF
            ENDIF
          ENDIF
          MATCH     "1",CMDESTAT              * Deposit Applied
          IF        @EQUAL
            PACK      CMDEREFD,CCC,CYY,CMM,CDD,SP70     * set to Current date
          ENDIF
          REP       " 0",CMDEREFD
          PACK      CMDETRSF,SP70
          PACK      CMDESPAR,SP70
          PACK      KEY17,CMDERECN,CMDETCNT,SP70
.
          CALL      RACMDEP1
          IF        OVRCD=1
            CALL      WRCMDEP1                * write to the deposits file
          ENDIF
.
          GOTO      CDEP9999
.
CDEP9999  RETURN
+
.**************************************************************************
.*                             WRTG0000                                   *
.*                        write gl batch file                             *
.**************************************************************************
WRTG0000    IF        IBCNMHOS=1
              MOVE      FMSFLAG,HSYS1
            ENDIF
.
            COMPARE   "1",HSYS1
            RETURN    IF NOT EQUAL
            DISPLAY   *P1:12,*EL,"G.L. Interface Pass -- ";
.
WRTG5000    CALL      RDBATS0 
            COMPARE   "2",BC0NXTSC
            GOTO      WRTG6000 IF NOT EQUAL
.
. ---- file empty so delete it ----
.
            DISPLAY   *P1:24,*EL,*B,"Deleting Unused Batch File. ";
            CALL      HITENTER
.
            CLOSE     BATFILE
            PREP      BATFILE,FILENAME
            CLOSE     BATFILE
.
            MOVE      FMBCBAT,KEY5
            CALL      DEFMBC1         * Delete record for this batch file
.
            GOTO      WRTG9999
.
. ---- move batch to accounting directory update batch queue & Control Totals 
.
WRTG6000    CALL      CONT0000     * Update Control Totals
.
WRTG9999    RETURN
.------------------------------------------------------------------------------
. Verifying whether it's GST or Normal process 
.------------------------------------------------------------------------------
VGRN0000  MOVE      SP70,SVBCBASC
.
          MATCH     SP70,GLGSTC          * Use GST ?
          GOTO      VGRN1000 IF EQUAL    * No, it's Normal process
.
. GST process here
.
          MOVE      ZERO,TAXAMNT                                       C-90301
          CALL      GSTC0000         * all GST processes               C-90301
          MOVE      SP70,BCBASC                                        C-90301
          IF        TAXAMNT <> 0
            CALL      WGLB0000       * Only write if not zero          C-90301
          ENDIF                                                        C-90301
.                                                                      C-90301
          UNPACK    RCDTINCA,GLSLEDG,GLSACCT                           C-90301
          PACK      GLACCT,GLSLEDG,GLSACCT                             C-90301
.                                                                      C-90301
          ASSIGN    (RCDTAMNT-TAXAMNT),GLAMNT                           C-90301
          MOVE      ZERO,TAXAMNT                                       C-90301
          MOVE      SVBCBASC,BCBASC                                    C-90301
          CALL      WGLB0000                                           C-90301
          GOTO      VGRN9999                                           C-90301
.
. Normal process here
.
VGRN1000  MOVE      SP70,BCBASC        
          CALL      WGLB0000             * write GL Batch transaction
          GOTO      VGRN9999
.
VGRN9999  RETURN
.----------------------------------------------------------------------
. Write General Ledger Batch Transaction
.----------------------------------------------------------------------
WGLB0000  CALL      RDBATS0
          MOVE      BC0NXTSC,SECTOR
          ADD       ONE,BC0NXTSC
          CALL      WRBATS0
          MOVE      SECTOR,BC0NXTSC
.
. ---- update sector 1 ----
.
          CALL      RDBAT1
          ADD       GLAMNT,BC1KEYT
          ADD       GLAMNT,BC1ACCT
          ADD       ONE,BC1NOTR
          CALL      WRBAT1
.
. ---- write actual transaction ----
.
          PACK      KEY3,GLREG
          CALL      RDREGA1
          MOVE      FIVE,BCSTAT
          MOVE      "CS",BCTRAN
          UNPACK    GLACCT,BCLEDG,BCACCTP
          MOVE      REGDISS,BCDISS
          MOVE      SP2,BCPAYT
          MOVE      "00000",BCRED
.
          UNPACK    RCDTRECN,KEY1,KEY11
          CLEAR     BCREFER
          APPEND    KEY11,BCREFER
          APPEND    "/",BCREFER
          APPEND    RCDTTCNT,BCREFER
          RESET     BCREFER
.
          MOVE      GLAMNT,BCAMT
          MOVE      SP10,BCORD
          PACK      BCDATED,RDD,RMM,RCC,RYY
          REPLACE   " 0",BCDATED
          MOVE      BCDATED,BCDATEE
          MOVE      SP10,BCDATCX
.
          MOVE      GLBANK,BCCONT
.
          MOVE      REGIBACD,TRNSYS
.
          MATCH     "1",RCDTALLO
          IF        !@EQUAL
            CALL      GETC0000
          ENDIF
.
          MOVE      REGCHQCD,BCCHEQ
          MOVE      BC1BATCH,BCBATCH
          MOVE      GLAMNT,BCINVT
          MOVE      ZERO,BCDISC
          MOVE      REGRESP,BCRESP
          MOVE      "N",BCCOMX
          MOVE      ZERO,BCCOMXA
.
          PACK      BCTRAND,RCDTREFR,SP70
.
          MOVE      SP20,BCDISCC
.
          CALL      WRBATC 
.
WGLB9999  RETURN
.------------------------------------------------------------------------------
. BAS - GST A/C Processes (applicable for Register 92 - GST Sundry Cash Sales)
.------------------------------------------------------------------------------
.
. get GST Rate and calculate TAX
.
GSTC0000  PACK      DIM8,CCC,CYY,CMM,CDD
          REP       " 0",DIM8
          PACK      KEY14,GLGSTC,DIM8,SP70
          CALL      RDIBGE1
          COMPARE   ZERO,OVRCD
          GOTO      GSTC0100 IF EQUAL
.
          CALL      RPIBGE1
          BRANCH    OVRCD,GSTC0200
.
          MATCH     GLGSTC,IBGECODE
          GOTO      GSTC0200 IF NOT EQUAL
.
GSTC0100  ASSIGN    (GLAMNT-(GLAMNT/(ONE+(IBGEAMNT/HUNDRED)))),TAXAMNT
          MOVE      TAXAMNT,GLAMNT
.
. get BAS Code
.
          PACK      KEY6,GLGSTC,SP70
          CALL      RDIBGS1
          BRANCH    OVRCD,GSTC0200
.
          COMPARE   ZERO,IBGSACTV
          GOTO      GSTC0200 IF NOT EQUAL
.
          MOVE      IBGSBASC,SVBCBASC
.
          UNPACK    RCDTGSTA,GLSLEDG,GLSACCT
          PACK      GLACCT,GLSLEDG,GLSACCT
          GOTO      GSTC9999
.
GSTC0200  MOVE      ZERO,TAXAMNT
          GOTO      GSTC9999
.
GSTC9999  RETURN
.------------------------------------------------------------------------------
.         * GET THE CONTROL ACCOUNTS
.------------------------------------------------------------------------------
GETC0000  MOVE      BCLEDG,KEY2
          CALL      RDFMLA1
          BRANCH    OVRCD,GETC9000
          MOVE      FMLABNK,FMCSBNK
          MOVE      FMLACRD,FMCSCRD
          MOVE      FMLADIS,FMCSDIS
          MOVE      FMLADEB,FMCSDEB
          PACK      KEY14,BCLEDG,BCACCTP
          CALL      RDFMCS1
.
          MATCH     SP70,FMCSBNK
          GOTO      GETC0010 IF NOT EQUAL
          MOVE      FMLABNK,FMCSBNK
GETC0010
          MATCH     SP70,FMCSCRD
          GOTO      GETC0020 IF NOT EQUAL
          MOVE      FMLACRD,FMCSCRD
GETC0020
          MATCH     SP70,FMCSDIS
          GOTO      GETC0030 IF NOT EQUAL
          MOVE      FMLADIS,FMCSDIS
GETC0030
          MATCH     SP70,FMCSDEB
          GOTO      GETC0300 IF NOT EQUAL
          MOVE      FMLADEB,FMCSDEB
GETC0300  MOVE      FMCSBNK,BCCONT
          COMPARE   "89",TRNSYS
          GOTO      GETC0330 IF EQUAL
          COMPARE   "92",TRNSYS
          GOTO      GETC0330 IF EQUAL
          COMPARE   "95",TRNSYS
          GOTO      GETC0330 IF EQUAL
          COMPARE   "98",TRNSYS
          GOTO      GETC0340 IF NOT EQUAL
.
GETC0330  MOVE      BCACCTP,BCACCT
          GOTO      GETC0380
.
GETC0340  MOVE      FMCSDEB,BCACCT
.
GETC0380  PACK      KEY14,BCLEDG,BCACCT
          CALL      RDFMAM1
          BRANCH    OVRCD,GETC9000
          PACK      KEY14,BCLEDG,BCCONT
          CALL      RDFMAM1
          BRANCH    OVRCD,GETC9000
          CALL      RDFMCA1
          BRANCH    OVRCD,GETC9000
          MOVE      FMCACHQ TO BCCHQAC
          GOTO      GETC9999
.
GETC9000  DISPLAY   *P1:24,*EL,"Control Account Error ",KEY14,". ";
..          PRINT     *1,"Control Account Error ",KEY14,". "
          CALL      HITENTER
GETC9999  RETURN
.------------------------------------------------------------------------------
.         Get transaction description
.         Requires : RCBNTTYP, RCBNRCOD
.         Returns  : DIM30
.------------------------------------------------------------------------------
GTRD0000  MOVE      SP30,DIM30
.
          MOVE      RCBNTTYP,F1
          BRANCH    F1,GTRD1000,GTRD2000,GTRD3000,GTRD4000
.
. ------- From Patient -------
.
          MOVE      "FROM PATIENT RECEIPT ##",DIM30
          GOTO      GTRD9999
.
. ------- From Health Fund -------
.
GTRD1000  MOVE      "FROM HEALTH FUND",DIM30
          MOVE      RCBNRCOD,KEY6
          PACK      KEY14,KEY6,SP4,SP10
          CALL      RDSFUND1
          CALL      RDKFUND1
          BRANCH    OVRCD,GTRD9999
          MATCH     KEY6,HCODE
          GOTO      GTRD9999 IF NOT EQUAL
          MOVE      HFNAME,DIM30
          GOTO      GTRD9999
.
. ------- From Insurance Company -------
.
GTRD2000  MOVE      "FROM INSURANCE COMPANY",DIM30
          MOVE      RCBNRCOD,KEY6
          CALL      RDINSR1
          BRANCH    OVRCD,GTRD9999
          MOVE      INAME,DIM30
          GOTO      GTRD9999
.
. ------- From Government Department -------
.
GTRD3000  MOVE      "FROM GOVERNMENT DEPARTMENT",DIM30
          MOVE      RCBNRCOD,KEY6
          CALL      RDGOVR1
          BRANCH    OVRCD,GTRD9999
          MOVE      GNAME,DIM30
          GOTO      GTRD9999
.
. ------- From Health Fund Group -
.
GTRD4000  MOVE      "FROM FUND GROUP",DIM30
          MOVE      RCBNRCOD,KEY6
          CALL      RDPAHGP1
          BRANCH    OVRCD,GTRD9999
          MOVE      PTHGDESC,DIM30
          GOTO      GTRD9999
.
. ------- Finished -------
.
GTRD9999  RETURN
.----------------------------------------------------------------------
. Update General Ledger Batch Queue and Control Totals
.----------------------------------------------------------------------
CONT0000  CALL      RDBAT0
          CALL      RDBAT1
          CALL      WRBAT1
.
          MOVE      BC0NXTSC,ENDSEC
.
          CLOSE     APSTMPA1
          EXECUTE   KILLTMP,TASKID
.
          CALL      ORCL0000                * Delete any Oracle recds  *I-90302
          BRANCH    EXIT,CONT0100           * bypass the "isbuild"     *I-90302
.
          EXECUTE   MAKETMP,TASKID
.
CONT0100  OPEN      APSTMPA1,TMPFILE                                   *C-90302
          MOVE      ONE,BC0NXTSC
.
. Loop Through the batch and extract control account to be updated
.
CONT1000  DISPLAY   *P71:24,*V2LON,BC0NXTSC;
          ADD       ONE,BC0NXTSC
          COMPARE   BC0NXTSC,ENDSEC
          GOTO      CONT2000 IF EQUAL
          CALL      RDBATC
.
          CALL      UPTM0000
.
          GOTO      CONT1000
.
CONT2000  CALL      CCTR0000            * Write Credit Entries
.
          COMPARE   "1",HSYS1
          RETURN    IF NOT EQUAL
.
          PACK      KEY5,FMBCBAT
          CALL      RDFMBC1
          ADD       ONE,BC0NXTSC
          MOVE      BC0NXTSC,FMBCSEC     * Update Number of Records
          MOVE      TWO,FMBCSTA
          MOVE      BC1ACCT,FMBCTOT
          CALL      UPFMBC1
          RETURN
+
.******************************************** Start of Additional Code *I-90302
.----------------------------------------------------------------------
.*                       ORCL0000               Called by:           *
.*        Delete all records in an Oracle Temp file                  *
.----------------------------------------------------------------------
ORCL0000  MOVE      ZERO,OVRCD
          MOVE      ZERO,EXIT
.
          TRAP      OVERCOND IF IO          * Check if file exists
          OPEN      APSTMPA1,TMPFILE
          BRANCH    OVRCD,ORCL9999          * File does not exist
.
          MOVE      ONE,EXIT                * set to bypass "isbuild" 
.
ORCL1000  DISPLAY   *P1:24,*EL,"** Deleting tempfile records ***";
          MOVE      ZERO,FORM4
.
ORCL2000  PACK      KEY14,SP20              * start at the first record
          CALL      RSAPTM1
          CALL      RKAPTM1
          BRANCH    OVRCD,ORCL9999          * file now empty
.
          PACK      KEY14,APTMLED,APTMACC,SP20
          CALL      DEAPTM1
          ADD       ONE,FORM4
          DISPLAY   *P40:24,*EL,FORM4," deleted";
          GOTO      ORCL2000
.
ORCL9999  RETURN
.******************************************** End of Additional Code   *I-90302
+
.----------------------------------------------------------------------
.*                       SUST0000               Called by:           *
.*        Delete all records in the suspense tempfile                *
.----------------------------------------------------------------------
SUST0000  MOVE      ZERO,OVRCD
          MOVE      ZERO,EXIT
.
          TRAP      OVERCOND IF IO          * Check if file exists
          OPEN      SUSTMPA1,TMPFILE2
          BRANCH    OVRCD,SUST9999          * File does not exist
.
          MOVE      ONE,EXIT                * set to bypass "isbuild"
.
SUST1000  DISPLAY   *P1:24,*EL,"** Deleting tempfile records ***";
          MOVE      ZERO,FORM4
.
SUST2000  PACK      KEY18,SP20              * start at the first record
          CALL      RSSUTM1
          CALL      RKSUTM1
          BRANCH    OVRCD,SUST9999          * file now empty
.
          PACK      KEY18,REALLOCT,RECEIPTN,TRNCOUNT,SP20
          CALL      DESUTM1
          ADD       ONE,FORM4
          DISPLAY   *P40:24,*EL,FORM4," deleted";
          GOTO      SUST2000
.
SUST9999  RETURN
+
.----------------------------------------------------------------------
.*                       XTRA0000               Called by:            *
.*        Delete all records in the Extract tempfile                  *
.----------------------------------------------------------------------
XTRA0000  MOVE      ZERO,OVRCD
          MOVE      ZERO,EXIT
.
          TRAP      OVERCOND IF IO          * Check if file exists
          OPEN      XTRTMPA1,TMPFILE3
          BRANCH    OVRCD,XTRA9999          * File does not exist
.
          MOVE      ONE,EXIT                * set to bypass "isbuild"
.
XTRA1000  DISPLAY   *P1:24,*EL,"** Deleting tempfile records ***";
.
XTRA2000  PACK      KEY12,SP20              * start at the first record
          CALL      RSXTRA1
          CALL      RKXTRA1
          BRANCH    OVRCD,XTRA9999          * file now empty
.
          PACK      KEY12,XTMRNUMB,SP20
          CALL      DEXTRA1
          GOTO      XTRA2000
.
XTRA9999  RETURN
+
.----------------------------------------------------------------------
. Write Credit Transactions From Temp File
.----------------------------------------------------------------------
CCTR0000  MOVE      "00000",BCRED
          PACK      BCDATEE WITH CDD,CMM,CCC,CYY
          REP       " 0" IN BCDATEE
          PACK      BCDATED WITH CDD,CMM,CCC,CYY
          REP       " 0" IN BCDATED
          MOVE      ZERO,BCINVT
          MOVE      ZERO,BCDISC
          MOVE      BC1RESP TO BCRESP
          MOVE      SP70 TO BCTRAND
          CLEAR     BCTRAND
          APPEND    "Cash Rel: ",BCTRAND
          MOVE      RDD,DIM2
          REP       " 0",DIM2
          APPEND    DIM2,BCTRAND
          APPEND    "/",BCTRAND
          MOVE      RMM,DIM2
          REP       " 0",DIM2
          APPEND    DIM2,BCTRAND
          APPEND    "/",BCTRAND
          MOVE      RYY,DIM2
          REP       " 0",DIM2
          APPEND    DIM2,BCTRAND
          APPEND    " ID : ",BCTRAND
          APPEND    CASHIER,BCTRAND
          RESET     BCTRAND
          MOVE      BC1TRAN,SAVETYPE
          MOVE      "CASH    ",BCORD
          MOVE      "CASH           ",BCREFER
          MOVE      FMCORDIS TO BCDISS
.
          MOVE      SP70,KEY14
          CALL      RSAPTM1
CCTR1000  CALL      RKAPTM1
          BRANCH    OVRCD,CCTR9999
          MOVE      APTMAMT,BCAMT
.
          MOVE      "JA",BCTRAN
.
          MOVE      APTMLED,BCLEDG
          MOVE      APTMACC,BCACCT
          MOVE      APTPACC,BCACCTP
          MOVE      APTRESP,BCRESP
          MOVE      SP70,BCBASC
.         
          CALL      WBCH0000                * Write Record Back to Batch file
.
          GOTO      CCTR1000                * for General Ledger
.
CCTR9999  MOVE      SAVETYPE,BCTRAN
          RETURN
.----------------------------------------------------------------------
. Add Control Account Transactions to Batch
.----------------------------------------------------------------------
WBCH0000  MOVE      "5",BCSTAT
          MOVE      SP70,BCDATCX
          MOVE      SP70,BCCHEQ
          MOVE      "N",BCCOMX
          MOVE      ZERO,BCCOMXA
          MOVE      SP70,BCCONT
          MOVE      SP70,BCDISCC
          MOVE      SP70,BCCEORD
          MOVE      SP70,BCCELNE
          MOVE      SP70,BCCATA
          CALL      RDBATS0
          ADD       ONE,BC0NXTSC
          CALL      WRBATS0
          SUB       ONE,BC0NXTSC
          CALL      WRBATC
.
          CALL      RDBAT1
          ADD       ONE,BC1NOTR
          MOVE      "5",BC1STAT
          CALL      WRBAT1
.
          RETURN
. ******************************************************************************
.  Accumulate Control Totals
. ******************************************************************************
UPTM0000  PACK      KEY14,BCLEDG,BCCONT
          CALL      RDAPTM1
          BRANCH    OVRCD,UPTM1000
          ADD       BCAMT,APTMAMT
          CALL      UPAPTM1
          GOTO      UPTM9999
.
UPTM1000  UNPACK    KEY14,APTMLED,APTMACC
          MOVE      APTMACC,APTPACC
          MOVE      BCRESP,APTRESP
          MOVE      BCAMT,APTMAMT
          CALL      WRAPTM1
UPTM9999  RETURN
.
+
.******************************************************************************
.*                             UPBR0000    Called From : TOT0000              *
.* Routine to update the Bank Rec Only Files.                                 * 
.******************************************************************************
.
UPBR0000  PACK      KEY3,RCDTREGI
          CALL      RDREGA1
.
          CALL      GNID0000
          BRANCH    EXIT,UPBR9999
.
          UNPACK    KEY20,FMBNBNK,FMBNUNQ
.
          CLEAR     FMBNREF
          COMPARE   "97",TRNSYS
          IF        @EQUAL 
            PACK      FMBNREF,CMDERECN,SLASH,CMDETCNT    * Deposit
            GOTO        UPBR2000
          ENDIF
          COMPARE   "93",TRNSYS
          GOTO      UPBR1000 IF NOT EQUAL 
          IF        DEPOS93=TRUE 
            PACK      FMBNREF,CMDERECN,SLASH,CMDETCNT    * Deposit
          ELSE 
            PACK      FMBNREF,RCDTRECN,SLASH,RCDTTCNT    * Billing
          ENDIF
.
          GOTO        UPBR2000
.
UPBR1000  PACK      FMBNREF,RCDTRECN,SLASH,RCDTTCNT
.
UPBR2000  RESET     FMBNREF 
.
          PACK      KEY29,REGCHQCD,REGGENLD
          CALL      RDFMCA2
.
          CALL      RKFMCA2
.
          MOVE      FMCAACC,FMBNACC
          PACK      FMBNDAT,CCC,CYY,CMM,CDD,SP70
          REP       " 0",FMBNDAT
          MOVE      ONE,FMBNTYP
          MOVE      ZERO,FMBNPRE
          MOVE      SP8,FMBNPDT
          MOVE      RCDTAMNT,FMBNAMT
.
          PACK      WORKDATE,CCC,CYY,CMM,CDD
          PACK      KEY2,REGGENLD
          CALL      RDFMLA1
          CALL      CFYR0000                * Get Financial Year.
          MOVE      CURYEAR,FMBNFYR
.
          REP       " 0",FMBNFYR
          MOVE      SP5,FMBNBCH
          MOVE      SP5,FMBNLNO
          IF        TRNSYS=93 & DEPOS93=TRUE
.            No longer allocates individual cheques to invoices/visits
.            MOVE      CSHDRAW,FMBNNAM
            MOVE      SP70,FMBNNAM
          ENDIF
.
          IF        TRNSYS=97
.            No longer allocates individual cheques to invoices/visits
.            MOVE      CSHDRAW,FMBNNAM
            MOVE      SP70,FMBNNAM
          ELSE
            MOVE      SP70,FMBNNAM
......      MOVE      TRNPAYEE,FMBNNAM
          ENDIF
          MOVE      SP20,FMBNSPAR
.
          CALL      WRFMBN1
.
UPBR9999  RETURN
.
+
.******************************************************************************
.*                             GNID0000    Called From : UPBR0000             *
.* Routine to get next bank rec unique id.                                    * 
.******************************************************************************
.
GNID0000  MOVE      "~~~~~",KEY5
          PACK      KEY20,REGCHQCD,KEY5
          CALL      RSFMBN1
          CALL      RPFMBN1
          BRANCH    OVRCD,GNID2000
          MATCH     FMBNBNK,REGCHQCD
          GOTO      GNID2000 IF NOT EQUAL
          UNPACK    FMBNUNQ,ANS,KEY4
          MOVE      ZERO,F4
          MOVE      KEY4,F4
.
GNID1000  COMPARE   "9999",F4
          GOTO      GNID1100 IF NOT EQUAL
.
          MATCH     ANSZ,ANS
          GOTO      GNID9000 IF EQUAL
.
          REP       REPUNIQ,ANS
          MOVE      ZERO,F4
.
GNID1100  ADD       ONE,F4
          PACK      KEY20,REGCHQCD,ANS,F4,SP70
          CALL      RDFMBN1
          BRANCH    OVRCD,GNID9999
          GOTO      GNID1000
.
GNID2000  MOVE      ONE,F4
          MOVE      SP1,ANS
          PACK      KEY20,REGCHQCD,ANS,F4,SP70
          GOTO      GNID9999
.
GNID9000  DISPLAY   *P1:24,*EL,*B,"fmsbnkaf Full For - ",REGGENLD:
                    " Contact IBA. ";
          CALL      HITENTER
          CHAIN     PGM 
.
GNID9999  RETURN
.
+
.**************************************************************************
.* CFYR0000  Calculate Financial Year From Date        Called By PRTC0000 * 
.*                                         & Ledger                       * 
.*                                                                        *
.* Input    - WORKDATE - Date to find format CCYYMMDD         DIM  8      *
.*            FMLALEDG - Ledger FMLA Record should have been read         *
.*            FMSLMCA1 - Must be open                                     *
.*                                                                        *
.* Output   - CURYEAR  - Current financial year for ledger    DIM  4      *
.*            PERDESC  - Period description                   DIM  15     *
.*            PEREDAT  - Period End date                      DIM  8      *
.*            PERSDAT  - Period Start date                    DIM  8      *
.*            PERLOCK  - Period Lock 0 - No                   FORM 1      *
.*            PERCNT   - Period                               FORM 2      *
.*            ERRMSG   - Message                              DIM  40     *
.*            EXIT     - 0 - period found                                 *
.*                       1 - Error                                        *
.*                                                                        *
.* Other Variable Required - MAXPER  FORM   2                             *
.*                                                                        *
.**************************************************************************
.
CFYR0000  REP       " 0",WORKDATE
          UNPACK    WORKDATE,CCENT,CYEAR,CMON,CDAY
          PACK      KEY6,FMLALEDG,CCENT,CYEAR
.
          CALL      RDFMLC1
          BRANCH    OVRCD,CFYR4000
.
CFYR1000  MATCH     FMLC01FR,WORKDATE      * is it before start year
          GOTO      CFYR2000 IF LESS       * Goto Previous Year
.
          BRANCH    FMLAPERS,CFYR1100      * how many periods?
.
          MATCH     WORKDATE,FMLC12TO      * is it after end of Year
          GOTO      CFYR3000 IF LESS       * Goto Next Year
          GOTO      CFYR5000               * 
.
CFYR1100  MATCH     WORKDATE,FMLC13TO      * is it after end of year
          GOTO      CFYR3000 IF LESS       * Goto Next Year
          GOTO      CFYR5000               * 
         
CFYR2000  CALL      RPFMLC1                * Previous Financial Year
          BRANCH    OVRCD,CFYR9200         * Period Not Found in Calendar File
          MATCH     FMLCLEDG,FMLALEDG
          GOTO      CFYR9200 IF NOT EQUAL
          GOTO      CFYR1000
.
CFYR3000  CALL      RKFMLC1                * Next Financial Year
          BRANCH    OVRCD,CFYR9200         * Period Not Found in Calendar File
          MATCH     FMLCLEDG,FMLALEDG
          GOTO      CFYR9200 IF NOT EQUAL
          GOTO      CFYR1000
.
CFYR4000  PACK      KEY6,FMLALEDG,SP4      * First Financial Year.
          CALL      RSFMLC1
          CALL      RKFMLC1
          BRANCH    OVRCD,CFYR9100         * No records found for Ledger.
          MATCH     FMLCLEDG,FMLALEDG
          GOTO      CFYR9100 IF NOT EQUAL
          GOTO      CFYR1000
.
CFYR5000  MOVE      FMLCYEAR,CURYEAR       * Year Determined.
          MOVE      ZERO,PERCNT
          MOVE      "12",MAXPER
          ADD       FMLAPERS,MAXPER
CFYR5100  COMPARE   PERCNT,MAXPER
          GOTO      CFYR9300 IF EQUAL      * Financial Calendar Incorrectly Set.
.      
          ADD       ONE,PERCNT
          LOAD      PEREDAT,PERCNT,FMLC01TO,FMLC02TO,FMLC03TO,FMLC04TO,FMLC05TO:
                                  FMLC06TO,FMLC07TO,FMLC08TO,FMLC09TO,FMLC10TO:
                                  FMLC11TO,FMLC12TO,FMLC13TO
.
          MATCH     WORKDATE,PEREDAT
          GOTO      CFYR5200 IF NOT LESS
          GOTO      CFYR5100 
.
CFYR5200  LOAD      PERSDAT,PERCNT,FMLC01FR,FMLC02FR,FMLC03FR,FMLC04FR,FMLC05FR:
                                  FMLC06FR,FMLC07FR,FMLC08FR,FMLC09FR,FMLC10FR:
                                  FMLC11FR,FMLC12FR,FMLC13FR
.
          LOAD      PERDESC,PERCNT,FMLC01DE,FMLC02DE,FMLC03DE,FMLC04DE,FMLC05DE:
                                  FMLC06DE,FMLC07DE,FMLC08DE,FMLC09DE,FMLC10DE:
                                  FMLC11DE,FMLC12DE,FMLC13DE
.
          LOAD      PERLOCK,PERCNT,FMLC01IN,FMLC02IN,FMLC03IN,FMLC04IN,FMLC05IN:
                                  FMLC06IN,FMLC07IN,FMLC08IN,FMLC09IN,FMLC10IN:
                                  FMLC11IN,FMLC12IN,FMLC13IN
.
          MOVE      ZERO,EXIT
          GOTO      CFYR9999 
.**********************************************************************
.         Error Messages
.**********************************************************************
CFYR9100  DISPLAY   *P1:24,*EL,*B,"No Calender Records Found For Ledger. ";
          GOTO      CFYR9800
.
CFYR9200  DISPLAY   *P1:24,*EL,*B,"Period Not Found In Calender File. "; 
          GOTO      CFYR9800
.
CFYR9300  DISPLAY   *P1:24,*EL,*B,"Financial Calender Incorrectly Set. "; 
.
CFYR9800  CALL      HITENTER 
          MOVE      SP10,CURYEAR
.
CFYR9999  RETURN
.
.******************************************************************************
.*                             DFEE0000    Called From : WRTA0000             *
.*                                                       WRDP0000             *
.* Routine to update the doctors fee file patdfeaf.                           * 
.******************************************************************************
.
DFEE0000  COMPARE   ONE,PTCNAXEU
          GOTO      DFEE9999 IF NOT EQUAL
.
          CALL      RDPTAXE1
          BRANCH    OVRCD,DFEE9000
.
          MATCH     RCCNMERG,RCDTREGI
          GOTO      DFEE0400 IF EQUAL   * Check for medisave transaction
.
          MOVE      ONE,DCODE
          MATCH     RCCNPDOC,RCDTREGI
          GOTO      DFEE0200 IF EQUAL   * Check for principle doctor 
.
          ADD       ONE,DCODE
          MATCH     RCCNODO1,RCDTREGI
          GOTO      DFEE0200 IF EQUAL   * Check for other doctor 1 
.
          ADD       ONE,DCODE
          MATCH     RCCNODO2,RCDTREGI
          GOTO      DFEE0200 IF EQUAL   * Check for other doctor 2 
.
          ADD       ONE,DCODE
          MATCH     RCCNPAED,RCDTREGI
          GOTO      DFEE0200 IF EQUAL   * Check for paediatrician 
.
          ADD       ONE,DCODE
          MATCH     RCCNANTH,RCDTREGI
          GOTO      DFEE0200 IF EQUAL   * Check for anaesthetist 
.
          GOTO      DFEE9999
.
DFEE0200  LOAD      PTDFDCOD,DCODE,PTAXDFPC,PTAXDFOC,PTAXDFDC,PTAXDFBC,PTAXDFAC
          PACK      KEY15,PTDFDCOD,ANSN,KEY8
.
          CALL      RDPTDFE1
.
          BRANCH    OVRCD,DFEE0300
.
          ASSIGN    (PTDFCOAM+RCDTAMNT),PTDFCOAM
          CALL      UPPTDFE1
          GOTO      DFEE9999
.
DFEE0300  MOVE      ANSN,PTDFPAID
          MOVE      KEY8,PTDFADMN
          MOVE      ZERO,PTDFMDAM
          MOVE      ZERO,PTDFADFE
          MOVE      RCDTAMNT,PTDFCOAM
          CALL      WRPTDFE1
          GOTO      DFEE9999
.          
DFEE0400  MATCH     SP6,PTAXDFPC
          GOTO      DFEE1000 IF EQUAL
.
          PACK      KEY15,PTAXDFPC,ANSN,KEY8
          CALL      RDPTDFE1
          BRANCH    OVRCD,DFEE0500
.
          ASSIGN    (PTDFMDAM+PTAXCPPI+PTAXCPPT),PTDFMDAM
          CALL      UPPTDFE1
          GOTO      DFEE1000
.
DFEE0500  MOVE      PTAXDFPC,PTDFDCOD
          MOVE      ANSN,PTDFPAID
          MOVE      KEY8,PTDFADMN
          ASSIGN    (PTAXCPPI+PTAXCPPT),PTDFMDAM
          MOVE      ZERO,PTDFADFE
          MOVE      ZERO,PTDFCOAM
          CALL      WRPTDFE1
.
DFEE1000  MATCH     SP6,PTAXDFOC
          GOTO      DFEE2000 IF EQUAL
.
          PACK      KEY15,PTAXDFOC,ANSN,KEY8
          CALL      RDPTDFE1
          BRANCH    OVRCD,DFEE1500
.
          ASSIGN    (PTDFMDAM+PTAXCPOI+PTAXCPOT),PTDFMDAM
          CALL      UPPTDFE1
          GOTO      DFEE2000
.
DFEE1500  MOVE      PTAXDFOC,PTDFDCOD
          MOVE      ANSN,PTDFPAID
          MOVE      KEY8,PTDFADMN
          ASSIGN    (PTAXCPOI+PTAXCPOT),PTDFMDAM
          MOVE      ZERO,PTDFADFE
          MOVE      ZERO,PTDFCOAM
          CALL      WRPTDFE1
.
DFEE2000  MATCH     SP6,PTAXDFDC
          GOTO      DFEE3000 IF EQUAL
.
          PACK      KEY15,PTAXDFDC,ANSN,KEY8
          CALL      RDPTDFE1
          BRANCH    OVRCD,DFEE2500
.
          ASSIGN    (PTDFMDAM+PTAXCPDI+PTAXCPDT),PTDFMDAM
          CALL      UPPTDFE1
          GOTO      DFEE3000
.
DFEE2500  MOVE      PTAXDFDC,PTDFDCOD
          MOVE      ANSN,PTDFPAID
          MOVE      KEY8,PTDFADMN
          ASSIGN    (PTAXCPDI+PTAXCPDT),PTDFMDAM
          MOVE      ZERO,PTDFADFE
          MOVE      ZERO,PTDFCOAM
          CALL      WRPTDFE1
.
DFEE3000  MATCH     SP6,PTAXDFBC
          GOTO      DFEE4000 IF EQUAL
.
          PACK      KEY15,PTAXDFBC,ANSN,KEY8
          CALL      RDPTDFE1
          BRANCH    OVRCD,DFEE3500
.
          ASSIGN    (PTDFMDAM+PTAXCPBI+PTAXCPBT),PTDFMDAM
          CALL      UPPTDFE1
          GOTO      DFEE4000
.
DFEE3500  MOVE      PTAXDFBC,PTDFDCOD
          MOVE      ANSN,PTDFPAID
          MOVE      KEY8,PTDFADMN
          ASSIGN    (PTAXCPBI+PTAXCPBT),PTDFMDAM
          MOVE      ZERO,PTDFADFE
          MOVE      ZERO,PTDFCOAM
          CALL      WRPTDFE1
.
DFEE4000  MATCH     SP6,PTAXDFAC
          GOTO      DFEE9999 IF EQUAL
.
          PACK      KEY15,PTAXDFAC,ANSN,KEY8
          CALL      RDPTDFE1
          BRANCH    OVRCD,DFEE4500
.
          ASSIGN    (PTDFMDAM+PTAXCPAI+PTAXCPAT),PTDFMDAM
          CALL      UPPTDFE1
          GOTO      DFEE9999
.
DFEE4500  MOVE      PTAXDFAC,PTDFDCOD
          MOVE      ANSN,PTDFPAID
          MOVE      KEY8,PTDFADMN
          ASSIGN    (PTAXCPAI+PTAXCPAT),PTDFMDAM
          MOVE      ZERO,PTDFADFE
          MOVE      ZERO,PTDFCOAM
          CALL      WRPTDFE1
          GOTO      DFEE9999
.
DFEE9000  DISPLAY   *P1:24,"Patient is not on Patient Extension File. ":
                    "Contact IBA - ";
          CALL      HITENTER 
          CHAIN     PGM 
.
DFEE9999  RETURN
+
.------------------------------------------------------------
. Display Message on Line 24 (No Hit Enter)
.------------------------------------------------------------
.ESSAGE2  GETVAR    LINE24A,ATTR24A,1,24
.         RESET     DISPMSG
.         STRIP     DISPMSG
.         ENDSET    DISPMSG
.         APPEND    SP1,DISPMSG
.         RESET     DISPMSG
.         DISPLAY   *P1:24,*EL,*+,DISPMSG;
.         RETURN
.
.------------------------------------------------------------
. Display Restore Line 24 after Message2
.------------------------------------------------------------
.ESSAGE3  PUTVAR    LINE24A,ATTR24A,1,24
.         RETURN
.***************************************************************************
.*  OTRF0000  :  Open all required visit based files                       *
.***************************************************************************
OTRF0000  IF        FILENUM = 20
            CLOSE     PATVISA1
            OPEN      PATVISA1,PATH
          ENDIF
          IF        FILENUM = 51
            CLOSE     PATINVR1
            OPEN      PATINVR1,PATH
          ENDIF
          IF        FILENUM = 52
            CLOSE     PATDTRA1
            OPEN      PATDTRA1,PATH
          ENDIF
          IF        FILENUM = 53
            CLOSE     OUTDTRO1
            OPEN      OUTDTRO1,PATH
          ENDIF
          IF        FILENUM = 54
            CLOSE     PATJRNL1
            OPEN      PATJRNL1,PATH
          ENDIF
          IF        FILENUM = 55
            CLOSE     PATHFRE1
            OPEN      PATHFRE1,PATH
          ENDIF
          IF        FILENUM = 1
            CLOSE     PATMI1A1
            OPEN      PATMI1A1,PATH
          ENDIF
.
OTRF9999  RETURN
.
.***************************************************************************
.*  FMSSYS00  :  For multi hospital check if any of the hospitals use FMS  *
.***************************************************************************
FMSSYS00  MOVE      ZERO,FMSFLAG
          COMPARE   ONE,IBCNMHOS
          GOTO      FMSSYS99 IF NOT EQUAL     * Not using multi hospital
          PACK      KEY3,SP70
          CALL      RSPTHSP1
FMSSYS10  CALL      RKPTHSP1
          BRANCH    OVRCD,FMSSYS99
          MATCH     "1",PTHSUFMS
          IF        @EQUAL
            MOVE      PTHSUFMS,FMSFLAG
            GOTO      FMSSYS99
          ENDIF
          GOTO      FMSSYS10
.
FMSSYS99  RETURN
.
.*****************************************************************************
EXCUS000  CLEAR     CMDLINE                 * header file
          APPEND    "ibarcp76.us1 ",CMDLINE
          APPEND    SPLFILE,CMDLINE
          APPEND    ".prt",CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
EXCUS999  RETURN
+
.*****************************************************************************
.         Get payments for All receipts in tempfile - SX only
.*****************************************************************************
GPAY0000  COMPARE   FIVE,CFEETYP
          GOTO      GPAY8000 IF NOT EQUAL   * Not SX
.
          OPEN      NZPEXTA2,"nzpextaf"
.
          PACK      KEY12,SP70
          CALL      RSXTRA1
GPAY1000  CALL      RKXTRA1
          BRANCH    OVRCD,GPAY8000
.
.         If there is a negative cash trans., different payment type can not
.         be allocated to each transaction
.
          CALL      CTRN0000             * Check if there is a -ve cash trans.
          BRANCH    EXIT,GPAY4000        * found -ve cash trans.
.
.         If there is more than one payment type, we need to allocate
.         the different payment to each transaction
.
          CALL      CPTY0000             * Check if only one payment type
          BRANCH    EXIT,GPAY2000:       * more than one payment type
                         GPAY1000        * missing record from rcpbdtaf
.
.         Found more than one payment types
.         Allocate each payment type (rcpbdtaf) to all transactions (rcpdteaf)
.
GPAY2000  CALL      PRXT0000             * Process SX Extract
          GOTO      GPAY1000
.
.         Found A negative transaction amount or Only one Payment type,
.         allocate same payment type to all Transaction
.
GPAY4000  CALL      PRXP0000             * Process SX Extract
          GOTO      GPAY1000
.
GPAY8000  PACK      KILLTMP,KILL,TMPFILE3
          EXECUTE   KILLTMP,TASKID
.
GPAY9999  RETURN
+
.*****************************************************************************
.         Check if there is a negative amount of cash Transaction for the
.         receipt
.*****************************************************************************
CTRN0000  MOVE      ZERO,EXIT
          PACK      KEY17,XTMRNUMB,SP70
          CALL      RSRCDTE1
CTRN1000  CALL      RKRCDTE1
          BRANCH    OVRCD,CTRN9999
.
          MATCH     XTMRNUMB,RCDTRECN    * Same receipt no?
          GOTO      CTRN9999 IF NOT EQUAL
.
          COMPARE   ZERO,RCDTAMNT
          GOTO      CTRN9000 IF LESS     * Found -ve transaction
          GOTO      CTRN1000
.
CTRN9000  MOVE      ONE,EXIT
CTRN9999  RETURN
+
.*****************************************************************************
.         Check if receipt has more than one payment types
.*****************************************************************************
CPTY0000  MOVE      ZERO,EXIT
          MOVE      ZERO,F1
          PACK      KEY15,XTMRNUMB,SP70
          CALL      RSRCBDT1
CPTY1000  CALL      RKRCBDT1
          BRANCH    OVRCD,CPTY2000
.
          MATCH     RCBDRECN,XTMRNUMB    * Same receipt no?
          GOTO      CPTY2000 IF NOT EQUAL
.
          BRANCH    F1,CPTY9000          * found more than one payment types
          ADD       ONE,F1
          GOTO      CPTY1000
.
CPTY2000  BRANCH    F1,CPTY9999
          MOVE      TWO,EXIT
          GOTO      CPTY9999
.
CPTY9000  MOVE      ONE,EXIT             * more than one payment type
CPTY9999  RETURN
+
.*****************************************************************************
.        Processing extracting for a receipt number
.        Allocate same payment type (rcpbdtaf) to all transactions (rcpdteaf)
.        of the same receipt
.*****************************************************************************
PRXP0000  MOVE      ZERO,TRNSYS
.
          PACK      KEY15,XTMRNUMB,SP70
          CALL      RSRCBDT1
          CALL      RKRCBDT1
          BRANCH    OVRCD,PRXP9999
          MATCH     RCBDRECN,XTMRNUMB    * Same receipt no?
          GOTO      PRXP9999 IF NOT EQUAL
.
          PACK      KEY17,XTMRNUMB,SP70
          CALL      RSRCDTE1
PRXP1000  CALL      RKRCDTE1
          BRANCH    OVRCD,PRXP9999
          MATCH     RCDTRECN,XTMRNUMB    * Same receipt no?
          GOTO      PRXP9999 IF NOT EQUAL
.
          PACK      KEY3,RCDTREGI,SP70
          CALL      RDREGA1
          IF        OVRCD<>1
            MOVE      REGIBACD,TRNSYS
          ENDIF
.
          CMATCH    "1",RCDTGLEX
          GOTO      PRXP1000 IF EQUAL      * has already been extracted
.
          MOVE      "1",KEY1
          PACK      RCDTGLEX,KEY1,SP70     * flag for G/L extraction
          PACK      RCDTUDAT,CCC,CYY,CMM,CDD
          REP       " 0",RCDTUDAT           * date updated
          CLOCK     TIME,RCDTUTIM           * time updated
          MOVE      USERID,RCDTUUID         * web user id
          CALL      UPRCDTE1
.
.         Do not extract suspense register until being allocated
.
          IF        TRNSYS<>99
            MOVE      RCDTAMNT,FORM12P2
            CALL      GLEX0000             * Write to Extract file
          ENDIF
.
          GOTO      PRXP1000
.
PRXP9999  RETURN
+
.*****************************************************************************
.        Processing extracting for a receipt number
.        Allocate each payment type (rcpbdtaf) to all transactions (rcpdteaf)
.        of the same receipt
.*****************************************************************************
PRXT0000  MOVE      ZERO,BDTAMNT
          MOVE      ZERO,DTEAMNT
          MOVE      ZERO,TRNSYS
.
          PACK      KEY15,XTMRNUMB,SP70
          CALL      RSRCBDT1
          CALL      RKRCBDT1
          BRANCH    OVRCD,PRXT9999
          MATCH     RCBDRECN,XTMRNUMB    * Same receipt no?
          GOTO      PRXT9999 IF NOT EQUAL
          MOVE      RCBDPAMT,BDTAMNT
.
.         If it has suspense register, allocate payment from the last record
.
          PACK      KEY17,XTMRNUMB,SP70
          CALL      RSRCDTE1
          CALL      RKRCDTE1
          BRANCH    OVRCD,PRXT9999
          GOTO      PRXT3000
.
PRXT1000  CALL      RKRCBDT1
          BRANCH    OVRCD,PRXT9999       * Get next receipt number
.
          MATCH     RCBDRECN,XTMRNUMB    * Same receipt no?
          GOTO      PRXT9999 IF NOT EQUAL
          MOVE      RCBDPAMT,BDTAMNT
.
          COMPARE   ZERO,DTEAMNT
          GOTO      PRXT3200 IF NOT EQUAL   * still got invoice to be allocated
.
PRXT2000  CALL      RKRCDTE1
          BRANCH    OVRCD,PRXT9999
.
PRXT3000  MATCH     RCBDRECN,RCDTRECN    * Same receipt no?
          GOTO      PRXT1000 IF NOT EQUAL
.         
          PACK      KEY3,RCDTREGI,SP70
          CALL      RDREGA1
          IF        OVRCD<>1
            MOVE      REGIBACD,TRNSYS
          ENDIF
.
.         Skip suspense record that had been extracted and waiting for re-alloc.
.         
          CMATCH    "1",RCDTGLEX
          GOTO      PRXT3100 IF NOT EQUAL * Not extracted yet
.         
          MOVE      RCDTAMNT,DTEAMNT
          IF        BDTAMNT<DTEAMNT
            SUB       BDTAMNT,DTEAMNT
            MOVE      ZERO,BDTAMNT
            GOTO      PRXT1000
          ELSE
            SUB       DTEAMNT,BDTAMNT
            MOVE      ZERO,DTEAMNT
            COMPARE   ZERO,BDTAMNT
            GOTO      PRXT1000 IF EQUAL  
            GOTO      PRXT2000
          ENDIF     
.
PRXT3100  MOVE      "1",KEY1
          PACK      RCDTGLEX,KEY1,SP70     * flag for G/L extraction
          PACK      RCDTUDAT,CCC,CYY,CMM,CDD
          REP       " 0",RCDTUDAT           * date updated
          CLOCK     TIME,RCDTUTIM           * time updated
          MOVE      USERID,RCDTUUID         * web user id
          CALL      UPRCDTE1
.
PRXT3120  MOVE      RCDTAMNT,DTEAMNT
.
PRXT3200  COMPARE   DTEAMNT,BDTAMNT
          GOTO      PRXT4000 IF LESS
.
.         Do not extract suspense register until being allocated
.
          IF        TRNSYS<>99
            MOVE      DTEAMNT,FORM12P2
            CALL      GLEX0000             * Write to Extract file
          ENDIF
.
          SUB       DTEAMNT,BDTAMNT
          MOVE      ZERO,DTEAMNT
.
          COMPARE   ZERO,BDTAMNT
          GOTO      PRXT1000 IF EQUAL
.
          GOTO      PRXT2000
.
PRXT4000  IF        TRNSYS<>99
            MOVE      BDTAMNT,FORM12P2
            CALL      GLEX0000             * Write to Extract file
          ENDIF
.
          SUB       BDTAMNT,DTEAMNT
          MOVE      ZERO,BDTAMNT
          GOTO      PRXT1000
.
PRXT9999  RETURN
+
.*****************************************************************************
.         SX G/L Extract
.*****************************************************************************
GLEX0000  CALL      CLNZPEXT                * clear variables
.
          MATCH     SP70,RCDTVIST
          GOTO      GLEX2000 IF EQUAL
.
          MOVE      RCDTVIST,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD,GLEX9999
          BRANCH    PVITYPE,GLEX1000,GLEX1000,GLEX1000
          GOTO      GLEX9999
.
GLEX1000  MOVE      PVITYPE,NZEXSYST        * System
GLEX2000  PACK      KEY3,RCDTREGI,SP70
          CALL      RDREGA1
          BRANCH    OVRCD,GLEX9999          * Invalid register
.
          MOVE      FORM12P2,NZEXCAMT
          MOVE      FORM12P2,NZEXDAMT
          MULT      "-1",NZEXDAMT
.
          MOVE      RCDTBNKA,NZEXCACC       * Credit account
          MOVE      RCDTINCA,NZEXDACC       * Debit account
.
          MOVE      "5",NZEXRTYP
          CLEAR     NZEXDESC
          APPEND    "Payment",NZEXDESC
          APPEND    SP70,NZEXDESC
          RESET     NZEXDESC
.
          MOVE      RCDTMHOS,NZEXHCOD
          MOVE      RCDTVIST,NZEXADMN
          UNPACK    RCDTINVN,KEY4,NZEXINVN
          PACK      NZEXTRNO,SP1,RCDTTCNT,SP70   * Transaction count
          MOVE      RCDTURNO,NZEXURNO
          MOVE      RCDTTDAT,NZEXTDAT
          REP       " 0",NZEXTDAT
          MOVE      RCDTRECN,NZEXRCNO
          MOVE      RCDTREFR,NZEXPREF
.
          PACK      NZEXBNAM,RCBDPAYD
          MOVE      "5",NZEXPMTH               * Direct Deposit
          PACK      NZEXRREF,RCBDSTRF
.
          MOVE      ZERO,F1
          MOVE      RCBDPTYP,F1
          MOVE      F1,F2
          PACK      KEY5,CODEPY,RCBDPCOD
          CALL      RDCODE1
          IF        OVRCD=0
            SQUEEZE   PTCDNHCP
            MOVE      PTCDNHCP,F2
          ENDIF
.
          IF        F2=1
            MOVE      "1",NZEXPMTH             * Cash payment
            MOVE      SP70,NZEXRREF
          ENDIF
          IF        F2=2
            MOVE      "2",NZEXPMTH             * Cheque payment
            PACK      NZEXBNAM,RCBDDRAW,SP70
            PACK      NZEXRREF,RCBDCHQN,SP70
          ENDIF
.
          COMPARE   "3",F2
          GOTO      GLEX4000 IF NOT EQUAL
.
          MOVE      "3",NZEXPMTH               * Credit payment
          MOVE      SP70,NZEXRREF
          PACK      KEY5,ANSC,ANSR,RCBDCRDT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,GLEX4000
.
          MATCH     "C",TCINDC1
          GOTO      GLEX4000 IF NOT EQUAL
.
          MOVE      "4",NZEXPMTH         * Merchant care payment
          MOVE      RCBDCRDT,NZEXMCTY    * Card type
          MOVE      SP70,KEY6
          MOVE      TCFORM6,KEY6
          UNPACK    KEY6,ANS,KEY4,KEY1
          MOVE      ".",ANS
          PACK      KEY6,KEY4,ANS,KEY1
          SQUEEZE   KEY6
          MOVE      KEY6,NZEXCOMS        * Commission percentage
.
GLEX4000  MOVE      "00000",NZEXGLBT
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,NZEXCDAT               * date created
          CLOCK     TIME,NZEXCTIM               * time created
          MOVE      PASSCODE,NZEXCUID           * user id
          MOVE      SP70,NZEXSPAR
.
          PACK      KEY30,NZEXADMN,NZEXINVN,NZEXGLBT,NZEXHCOD,NZEXTRNO,SP70
          CALL      WRNZEXT2                     * Write a record
GLEX9999  RETURN
+
.**********************************************************************
. Temp file IO routines
.**********************************************************************
RSAPTM1   RESET     KEY14
          READ      APSTMPA1,KEY14;;
          RETURN
.
RAAPTM1   RESET     KEY14
          MOVE      ZERO,OVRCD
          READ      APSTMPA1,KEY14;ANS
          GOTO      OVERCOND IF OVER
          RETURN
.
RDAPTM1   RESET     KEY14
          MOVE      ZERO,OVRCD
          READ      APSTMPA1,KEY14;APTMLED,APTMACC,APTPACC,APTRESP,APTMAMT
          GOTO      OVERCOND IF OVER
          RETURN
.
RKAPTM1   MOVE      ZERO,OVRCD
          READKS    APSTMPA1;APTMLED,APTMACC,APTPACC,APTRESP,APTMAMT
          GOTO      OVERCOND IF OVER
          RETURN
.
RPAPTM1   MOVE      ZERO,OVRCD
          READKP    APSTMPA1;APTMLED,APTMACC,APTPACC,APTRESP,APTMAMT
          GOTO      OVERCOND IF OVER
          RETURN
.
UPAPTM1   UPDATE    APSTMPA1;APTMLED,APTMACC,APTPACC,APTRESP,APTMAMT
          RETURN
.
WRAPTM1   RESET     KEY14
          WRITE     APSTMPA1,KEY14;APTMLED,APTMACC,APTPACC,APTRESP,APTMAMT
          RETURN
.
DEAPTM1   RESET     KEY14
          DELETE    APSTMPA1,KEY14
          RETURN
+
RSSUTM1   RESET     KEY18
          READ      SUSTMPA1,KEY18;;
          RETURN
.
RASUTM1   RESET     KEY18
          MOVE      ZERO,OVRCD
          READ      SUSTMPA1,KEY18;ANS
          GOTO      OVERCOND IF OVER
          RETURN
.
RDSUTM1   RESET     KEY18
          MOVE      ZERO,OVRCD
          READ      SUSTMPA1,KEY18;RECEIPTN,TRNCOUNT,REALLOCT
          GOTO      OVERCOND IF OVER
          RETURN
.
RKSUTM1   MOVE      ZERO,OVRCD
          READKS    SUSTMPA1;RECEIPTN,TRNCOUNT,REALLOCT
          GOTO      OVERCOND IF OVER
          RETURN
.
RPSUTM1   MOVE      ZERO,OVRCD
          READKP    SUSTMPA1;RECEIPTN,TRNCOUNT,REALLOCT
          GOTO      OVERCOND IF OVER
          RETURN
.
UPSUTM1   UPDATE    SUSTMPA1;RECEIPTN,TRNCOUNT,REALLOCT
          RETURN
.
WRSUTM1   RESET     KEY18
          WRITE     SUSTMPA1,KEY18;RECEIPTN,TRNCOUNT,REALLOCT
          RETURN
.
DESUTM1   RESET     KEY18
          DELETE    SUSTMPA1,KEY18
          RETURN
.
RSXTRA1   RESET     KEY12
          READ      XTRTMPA1,KEY12;;
          RETURN
.
RAXTRA1   RESET     KEY12
          MOVE      ZERO,OVRCD
          READ      XTRTMPA1,KEY12;ANS
          GOTO      OVERCOND IF OVER
          RETURN
.
RDXTRA1   RESET     KEY12
          MOVE      ZERO,OVRCD
          READ      XTRTMPA1,KEY12;XTMRNUMB,XTMRSPAR
          GOTO      OVERCOND IF OVER
          RETURN
.
RKXTRA1   MOVE      ZERO,OVRCD
          READKS    XTRTMPA1;XTMRNUMB,XTMRSPAR
          GOTO      OVERCOND IF OVER
          RETURN
.
RPXTRA1   MOVE      ZERO,OVRCD
          READKP    XTRTMPA1;XTMRNUMB,XTMRSPAR
          GOTO      OVERCOND IF OVER
          RETURN
.
UPXTRA1   UPDATE    XTRTMPA1;XTMRNUMB,XTMRSPAR
          RETURN
.
WRXTRA1   RESET     KEY12
          WRITE     XTRTMPA1,KEY12;XTMRNUMB,XTMRSPAR
          RETURN
.
DEXTRA1   RESET     KEY12
          DELETE    XTRTMPA1,KEY12
          RETURN
+
.*****************************************************************************
+
            INC       FMSSTDCD
            INC       CLNZPEXT
            INC       PMSOSPTM 
            INC       CLPATDTR
            INC       TFILENAM                     * Generate Temp File Name
.
            INC       IBASEQIO/INC                 * Sequential Numbers File
            INC       WEBSECIO/INC
            INC       WEBERRIO/INC                 * Web Server Error Logging
            INC       RCPCIDIO/INC
            INC       RCPBNKIO/INC
            INC       RCPBDTIO/INC
            INC       RCPDTEIO/INC
            INC       RCPREGIO/INC
            INC       PATAXEIO/INC
            INC       PATCOMN3
            INC       PATCODIO/INC
            INC       PATDETIO/INC
            INC       PATDFEIO/INC
            INC       PATDRGIO/INC
            INC       PATDTRIO/INC
            INC       PATFINIO/INC
            INC       PATFN1IO/INC
            INC       PATFIGIO/INC
            INC       NZPEXTIO/INC
            INC       NZPFIGIO/INC
            INC       NZPFINIO/INC
            INC       NZPRFNIO/INC
            INC       PATFACIO/INC
            INC       PATGO1IO/INC
            INC       PATHGPIO/INC
            INC       PATHFRIO/INC
            INC       PATIN1IO/INC
            INC       PATINVIO/INC
            INC       PATJRNIO/INC
            INC       PATMA1IO/INC
            INC       PATMI1IO/INC
            INC       PATRFNIO/INC
            INC       PATRFGIO/INC
            INC       PATVISIO/INC
            INC       PMSVX1IO/INC
            INC       PATHSPIO/INC
            INC       PATRASIO/INC
            INC       PATCALFN
            INC       PMSOSDTM              * Outstanding Debt alert routine
            INC       UPFAPPLN              * Update FA Completion date
            INC       AAEDTRIO/INC
            INC       OUTBOAIO/INC
            INC       OUTDTRIO/INC
            INC       OUTSITIO/INC
            INC       COMDEPIO/INC
            INC       PRIAUDIO/INC
            INC       PRIDTRIO/INC
            INC       PRIFIGIO/INC
            INC       PRIFINIO/INC
            INC       PRIINVIO/INC
            INC       PRISTAIO/INC
            INC       PRIJRNIO/INC
            INC       PRICALFS
            INC       FMSAMAIO/INC
            INC       FMSCAFIO/INC
            INC       FMSCONIO/INC
            INC       FMSCSAIO/INC
            INC       FMSBNKIO/INC
            INC       FMSLMAIO/INC
            INC       FMSLMCIO/INC
            INC       FMSBCFIO/INC
            INC       IBABATIO/INC
            INC       IBAGEDIO/INC
            INC       IBAGSTIO/INC
            INC       DEBDBTIO/INC
            INC       DEBFTHIO/INC
            INC       DEBFDTIO/INC
            INC       DEBITMIO/INC
            INC       DEBTCRIO/INC
            INC       DEBRELCD           * Code for New AR Interface
            INC       PATDPATH
            INC       RCPCIDKY
            INC       CLPRIDTR
            INC       PATHOSIO/INC
