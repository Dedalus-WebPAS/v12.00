.************************************************************************
.*  Procedure: DGCLICRM  -  Send a Medical Records Movement             *
.*                                                                      *
.*  Author   : Mike Laming  (11/07/2001)                                *
.*                                                                      *
.*  Requires : MRTMASFD (Medical Records Tracking Master Details)       *
.*             MRTHISFD (Medical Records Tracking History)              *
.*                                                                      *
.*             MRTCONFD (Medical Records Control File)                  *
.*             PATCONFD (Patient Control File)                          *
.*                                                                      *
.*  Mods     :                                                          *
.*  V10.03.01 10/10/2013  Davin S          CAR 291578                   *
.*            Added dummy label rapmqpt1 as pmsqpt is not used here     *
.*  V10.02.01  11/07/2011  Mike Laming   CAR 240724                     *
.*             Mods to add Hospital to all Location records - mod Keys  *
.*  V9.08.01   05/01/2007  Steve Armstrong  CAR 130015                  *
.*             Mods to ignore CIS interface.                            *
.************************************************************************
.*  V9.04.01   07/07/2005  Davin            CAR 64087                   *
.*             Mods to handle CIS interface.                            *
.************************************************************************
.*  V9.02.03   07/01/2003  Davin  SRF 23333                             *
.*             Changed to write directly to mrt holding file            *
.*  V9.02.02   11/12/2001  Mike Laming                                  *
.*             Correct the key set up in HLBMKEY                        *
.*  V9.02.01   02/10/2001  Davin                                        *
.*             Mods to use message holding file                         *
.************************************************************************
          DEFPROC   DGCLICRM
.
          INC       HL7CISFD/INC
          INC       HL7INBFD/INC
          INC       MRTQUEFD/INC
.
CISMFLAG  FORM      1             * CIS message flag
.                                    0 = don't send HL7 CIS message
.                                    1 = send HL7 CIS message
IBAMFLAG  FORM      1             * IBA proprietary message flag
.                                    0 = don't send IBA proprietary message
.                                    1 = send IBA proprietary message
.
MESSAGID  DIM       20                           * message id
.
ZED30     INIT      "~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~"
.
DGCLI000  OPEN      CONTROLF,"controlf"
          READ      CONTROLF,ZERO;*133,IBCNUCIS
          READ      CONTROLF,NINTY7;*101,MRCNDGRM
.
          MOVE      ZERO,CISMFLAG                * set default interface flag
.         MATCH     "1",IBCNUCIS                 * using CIS interface ?
.         IF        @EQUAL
.             MOVE      ONE,CISMFLAG             * yes- set flag for CIS message
.         ENDIF
.
.         Check if we are sending any messages.
.
          IF        MRCNDGRM <> 1 & CISMFLAG <> 1
            GOTO      DGCLI999
          ENDIF
.
.         We are sending IBA Proprietary and/or CIS HL7 messages, so
.         first open the relevant holding tables
.
          MOVE      ZERO,IBAMFLAG
          IF        MRCNDGRM = 1
            OPEN      HL7INB01,"hl7inbaf"
            MOVE      ONE,IBAMFLAG
          ENDIF
          IF        CISMFLAG = 1
            OPEN      HL7CISA1,"hl7cisaf"
          ENDIF
          OPEN      MRTQUEA1,"mrtqueaf"
.
          CALL      DGMESSID                     * Get Message ID
.                                                                     *C-240724
          PACK      KEY20,MRMAURNO,MRMAHHOS,MRMAHLOC,MRMADOTY,MRMAVOLN,SP30
          CALL      RDMRMAS1                     * read the MR master
          BRANCH    OVRCD,DGCLI999               * no - error
.
          PACK      KEY26,MRMAKEY,ZED30          * set up key for History recd
          CALL      RSMRHIS1                     * position in history file
          CALL      RPMRHIS1                     * read previous record
          BRANCH    OVRCD,DGCLI999               * eof - error
.
          MATCH     MRMAKEY,MRHIKEY              * same MR history key ?
          GOTO      DGCLI999 IF NOT EQUAL
.
.         Write a record to mrtqueaf (holding Med.Records details)
.
          MOVE      MESSAGID,MRQUMESI
          PACK      MRQUSPAR,SP70
          CALL      WRMRQUE1
.
          COMPARE   ONE,MRCNDGRM                 * sending proprietary message?
          IF        @EQUAL
            MOVE      "CRM",H7INMETP
            CALL      WRINB000                   * yes - write hl7inbaf record
          ENDIF
.
          CLOSE     HL7CISA1
          CLOSE     HL7INB01
          CLOSE     MRTQUEA1
.
DGCLI999  GOTO      DGCLIEND                     * end procedure
.
.         I/O Routines
.
RAPMQPT1  GOTO      OVERCOND                    * dummy for DGMESSID
.
          INC       BRHLCOMN
.
          INC       HL7CISIO/INC
          INC       HL7INBIO/INC
          INC       MRTQUEIO/INC
          INC       IBAOVRIO/INC
.
DGCLIEND  ENDPROC
+
