.*******************************************************************************
.*                              WRITBOOK.PBL                                   *
.*             Common routines used by OUTWEB02 and HL7RECVR                   *
.*** NOTE: When making changes to this code please test OUTWEB02 and HL7RECVR **
.*******************************************************************************
.* Mods:                                                                       *
.*******************************************************************************
.* V12.00.03 17/09/2025  Ebon Clements  TSK 0965123                            *
.*           Set values of SAVADMNO and SAVBCOMP at BOKUPD00. Used in UPMV0000 *
.*           to update pmsextaf claim code                                     *
.* V12.00.02 23/07/2025  Ebon Clements  TSK 0959840                            *
.*           Populate PVIBILL before CBIL0000 call - BOKUPD00                  *
.* V12.00.01 13/05/2025  Ebon Clements  TSK 0955096                            *
.*           Added alpanumeric visit number generation - REAP0000 - GENANVIS   *
.* V11.05.01 29/11/2024  Thanh T        TSK 0939466                            *
.*           Added Distance in kms field                                       *
.******************************************************************************
.* V11.04.09 08/11/2024 PJ Le Febour    TSK 0950014b                           *
.*           UPMV0000 corrected test when PMEXCLAM UPDated clear PMEXICOD 
.* V11.04.08 07/11/2024 PJ Le Febour    TSK 0950014a                           *
.*           UPMV0000 when PMEXCLAM updated and OPWAMVNY=1 clear PMEXICOD      *
.* V11.04.07 29/10/2024 PJ Le Febour    TSK 0950014                            *
.*           UPMV0000 use SAVBCOMP to read RDPMEXT1                            *
.* V11.04.06 18/10/2024 Ebon Clements   TSK 0942992                            *
.*           Open outsesaf index 7 - OPNOUT00                                  *
.* V11.04.05 19/04/2024 Alina Bhari     TSK 0945381                            *
.*           Correctly assigned clinic type from the slot template master      *
.*           instead from clinic master -ADDSLT60                              *
.* V11.04.02 15/03/2024 Jacob Jackson  TSK 0914658                             *
.*           Add updates to allow PMEXUYN1 to be changed                       *
.* V11.04.01 13/03/2024 Ebon Clements  TSK 0929465                             *
.*           Update slot counts after single follow up appointment - UPDCNT00  *
.* V11.03.02 12/10/2023 Davin          TSK 0903933                             *
.*           Mods to trigger HL7 A11 when changing appointment status from     *
.*           'Attended' to 'DNA' on supervisor screen (OTCNA11N/UPDBOK80)      *
.* V11.03.01 10/10/2023 Thanh T        TSK 0935874                             *
.*           Changed UPDBOK90 to comment out the codes for PTCNUNET = '1'      *
.*           since it is no longer used                                        *
.* V11.02.03 07/06/2022 Jacob Jackson   TSK 0918806                            *
.*           Use CNLH7FLG to conditionally check to send A08 message           *
.* V11.02.02 20/04/2022 J.Tan           TSK 0837128                            *
.*           Mod Default PRFA based on Claim type (PRFAINSR)                   *
.* V11.02.01 09/02/2022 Thanh T         TSK 0905641                            *
.*           Added Additional HCP Code (1-4) for outbb1af                      *
.*******************************************************************************
.*        V11.02.01 29.03.2022 DA Sarkies      TSK 0905641                     *
.*                  Added CGI variables for additional HCPs
.*        V11.01.03 17/12/2021 Ebon Clements   TSK 0914940                     *
.*                  Don't send ACC details A08 for OUTWEB02 bulk follow        *
.*                  up appointments. It will be sent in the A05 - GCLM4000     *
.*        V11.01.02 10/11/2021 J.Tan           TSK 0880410                     *
.*                  Mod for System Health fund on hold invoice                 *
.*        V11.01.01 18/02/2021  J.Tan          TSK 0888639                     *
.*                  Added PMMITMNO - Theatre Team no                           *
.*        V11.00.04 12/01/2021  Ebon Clements    TSK 0901440                   *
.*                  Fixed deposit file read comdepaf index 2 key size - KEY26  *
.*        V11.00.03 13/11/2020  Davin            TSK 0890602                   *
.*                  Added add slot routines ADDSLT00/ADDOVR00/WSLT0000/ADDSCH00*
.*        V11.00.02 20/10/2020  Davin            TSK 0890602                   *
.*                  Set active date ALREDACT when activating referral(URSR9100)*
.*        V11.00.01 19/10/2020  Davin            TSK 0890602                   *
.*                  Added common update booking routines                       *
.*        V11.00.00 21/09/2020  Davin            TSK 0890602                   *
.*                  Created common include from OUTWEB02.PBL                   *
.*******************************************************************************
.                                Write New Booking
.*******************************************************************************
WRTBOK00  MOVE      ONE,VINAHFLG              * set for no after VINAHDEF audits
.
.         Initialise flags to show no audit records have been written
.
          MOVE      ZERO,EPAUDFLG
          MOVE      ZERO,RIAUDFLG
.
          CALL      CLOUTBOA                     * clear bok variables
          CALL      CLOUTBOB
          CALL      CLOUTBB1
          MOVE      SP70,OTBBCIND                
.
          MATCH     SP70,NEWSLOTK        
          GOTO      WRTBOK91 IF EQUAL
.
          MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,WRTBOK89
.
          CALL      RDPMPX21
          BRANCH    OVRCD,WRTBOK89
.
          MOVE      NEWSLOTK,KEY28
          CALL      RDBOKA1
          BRANCH    OVRCD,WRTBOK92
.
          IF        PCEASE=1
            MATCH     SP70,PDECDTE
            IF        !@EQUAL
              MATCH     OBADATE,PDECDTE
              GOTO      WRTBOK90 IF LESS
            ELSE
              GOTO      WRTBOK90
            ENDIF
          ENDIF
.
          UNPACK    PBDATE,CDAY,CMON,CYEAR,CCENT
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
          CALL      VALICD00
          BRANCH    ERRFLAG,WRTBOK99
.
          MOVE      NEWSLOTK,KEY28
          CALL      RLOTBOA1
          BRANCH    OVRCD,WRTBOK92,WRTBOK93
          COMPARE   NINE,OBASTAT             * Slot Reserved
          GOTO      WRTBOK30 IF EQUAL       
          COMPARE   ZERO,OBASTAT             * Make sure record isn't booked
          GOTO      WRTBOK94 IF NOT EQUAL    * Record isn't vacant !!
.
WRTBOK30  MOVE      NEWSLOTK,KEY28
          CALL      RDOTSRV1
          IF        OVRCD=0
            MATCH     USERID,OTSRWEBU
            GOTO      WRTBOK94 IF NOT EQUAL    * Record isn't vacant !!
            CALL      DEOTSRV1
          ENDIF
          MOVE      ZERO,OBASTAT             * Make sure record isn't booked
          CALL      UPBOKA1
.
          MOVE      OBAVISIT,OLDVTYP 
          MOVE      OBAVISIT,NEWVTYP 
          MATCH     Z70,OUTBB047
          IF        !@EQUAL
            MOVE      OUTBB047,NEWVTYP
          ENDIF
.
          CALL      REAP0000 
          BRANCH    EXIT,WRTBOK99
.
          MOVE      NEWSLOTK,KEY28
          CALL      RDBOKA1
          CALL      MOVBB000
.
          MOVE      OBACOMP,KEY3
          CALL      LCLM0000                 * get default claim details
.
          CALL      UPBOKA1
          MATCH     OLDVTYP,NEWVTYP
          IF        !@EQUAL
            PACK      SESSKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
            MOVE      OLDVTYP,OBAVISIT
            CALL      SUBBOK00
            MOVE      NEWVTYP,OBAVISIT
            CALL      ADDBOK00
            CALL      ADJNEW00
            CALL      ADJOLD00
.
            MOVE      ONE,RECALFLG          * Slot type has changed so
          ENDIF                             * recalculate clinic counts
.
WRTBOK40  IF        BOOKFLAG=1
            MOVE      OBAOUTNO,KEY8     * If booked from a referral letter
            CALL      RDOTRFL1          * update the booking details
            IF        OVRCD=0
              MOVE      OBASITE,OTRLBSIT
              MOVE      OBACLIN,OTRLBCLI
              MOVE      OBADATE,OTRLBDTE
              MOVE      OBASTRT,OTRLBSTR
              MOVE      OBASLOT,OTRLBSLT
              PACK      OTRLUDAT,CCC,CYY,CMM,CDD
              REP       " 0",OTRLUDAT
              CLOCK     TIME,OTRLUTIM
              MOVE      WBSEUID,OTRLUUID
              CALL      UPOTRFL1
.
              MOVE      OBAOUTNO,KEY8       * I-48256
              CALL      RDOTBOC1
              IF        OVRCD=0
                MOVE      OTRLDATE,OTBCRDAT
                CALL      UPOTBOC1
              ELSE
                MOVE      OTRLDATE,OTBCRDAT
                MOVE      SP70,OTBCSPAR
                CALL      WROTBOC1
              ENDIF
.                                           * end I-48256
            ENDIF
          ENDIF
.
WRTBOK45  MOVE      ZERO,BBREFLIN
.
          IF        BOOKFLAG=2 | BOOKFLAG=3 | WAITFLAG=1
            MATCH     SP70,REFRLVIS
            IF        !@EQUAL
              PACK      KEY16,REFRLVIS,OBAOUTNO,SP70
              CALL      RAALLNK1              * Write link to A/H referral
              IF        OVRCD=1
                MOVE      REFRLVIS,ALLNVISN
                MOVE      OBAOUTNO,ALLNLNKV
                MOVE      OBASITE,ALLNSITE
                MOVE      OBACLIN,ALLNCLIN
                MOVE      OBADATE,ALLNDATE
                MOVE      OBASTRT,ALLNSTRT
                MOVE      OBASLOT,ALLNSLOT
                MOVE      ZERO,ALLNSTAT
                MOVE      SP70,ALLNSPAR
                MOVE      "0",ALLNMOHR            * Set to Unsent
                CALL      WRALLNK1
.
                MOVE      ONE,AUDTTYPE            * write history record
                CALL      WAALLN00
              ENDIF
            ENDIF
.
            PACK      KEY8,REFRLVIS,SP70
            CALL      RDALREF1
            IF        OVRCD=0
              MOVE      ONE,BBREFLIN
.
              MATCH     "0",ALRESTAT              * Waiting
              IF        @EQUAL
.
.               Write a before audit record for the referral, then set the
.               flag to show that we just wrote a before audit record for
.               an Episode Referral
.
                MOVE      TWO,AUDTTYPE            * before history record
                CALL      WAALRE00
                MOVE      ONE,EPAUDFLG
.
                PACK      ALREUDAT,CCC,CYY,CMM,CDD
                REP       " 0",ALREUDAT
                CLOCK     TIME,ALREUTIM
                MOVE      USERID,ALREUUID
                PACK      ALREDACT,CCC,CYY,CMM,CDD
                REP       " 0",ALREDACT
                MOVE      ONE,ALRESTAT         * Activate referral
                MOVE      ALREDACT,ALSTSDAT    * write to Referral History Table
.
                MOVE      OBADATE,BOOKDATE
                CALL      CALX0000             * calculate expiry date
.
                CALL      ARMHI000             * Set MHINC indicator
                CALL      UPALREF1
.
                CALL      PMIGTNID             * get national id for dgate write
                MOVE      NMPNUMB,PTNINMPI
                MOVE      THREE,HL7TRGID
                MOVE      SP8,HL7INCLD
                CALL      DGCLII13             * broadcast Update Ref. (REF^I13)
.
                CALL      WRTRSH00             * write a record to allstsaf
.
                MOVE      ALREVISN,CHECKREF
                CALL      AMAS0000             * Auto activate master referral
.
              ENDIF
.
              MATCH     "1",ALRESTAT           * Active
              IF        @EQUAL
                CALL      REFX0000                * Calculate referral expiry
              ENDIF
.
              CALL      FAPD0000               * Set first appointment booked
              MOVE      ALREPRTY,SAVVPRTY      * Save referral priority
              MOVE      ALRETRGS,SAVVTRGS     * Save referral triage status
              MOVE      ALREVISN,SAVVREFN     * Referral number
              PROC      VDEF0000              * VINAH Field defaults
.
.             Check if an after Episode audit is still required and if so,
.             write one.
.
              IF        EPAUDFLG = 1
                MOVE      THREE,AUDTTYPE         * write after history record
                CALL      WAALRE00
              ENDIF
.
.             Check if an after Referral In audit is still required and if so,
.             write one
.
              IF        RIAUDFLG = 1
                MATCH     SP8,VINAHREF
                IF        !@EQUAL
                  MOVE      VINAHREF,KEY8
                  CALL      RDALREF1
                  IF        OVRCD = 0
                    MOVE      THREE,AUDTTYPE     * write after history record
                    CALL      WAALRE00
                  ENDIF
                ENDIF
              ENDIF
.
              CALL      RCLM0000               * Default Ref claim details
.
              MOVE      OBAOUTNO,KEY8
              CALL      RDOTBOC1
              IF        OVRCD=0
                MOVE      ALRERDAT,OTBCRDAT
                CALL      UPOTBOC1
              ELSE      
                MOVE      ALRERDAT,OTBCRDAT
                MOVE      SP70,OTBCSPAR
                CALL      WROTBOC1
              ENDIF
            ENDIF
          ENDIF
.
          IF        BOOKFLAG=3
            PACK      KEY32,REQUESTK,SP70
            CALL      RDOTART1                   * Update appointment request 
            IF        OVRCD=0
              MOVE      OBAOUTNO,OTARBKNO
              MOVE      OBASITE,OTARBKSI
              MOVE      OBACLIN,OTARBKCL
              MOVE      OBADATE,OTARBKDT
              MOVE      OBASTRT,OTARCLST
              MOVE      OBASLOT,OTARCLSN
              MOVE      OBATIME,OTARCLTM
              MOVE      TWO,OTARSTAT
              PACK      OTARCPDT,CCC,CYY,CMM,CDD
              REP       " 0",OTARCPDT
              CLOCK     TIME,OTARCPTM
              MOVE      WBSEUID,OTARCPID
.
              CALL      UPOTART1
.
              CALL      DELVCM00                 * delete any viscmtaf records
.                                                * that are type 014 pend/reschd
.                                                * that belong to old booking 
.                                                * number OTAROOBN
.
            ENDIF
          ENDIF
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDDIAG1
          MOVE      OVRCD,DIAGOVR
          IF        OVRCD=1
            MOVE      OBAOUTNO,OPDIOUTN
            MOVE      SP70,OPDICODE
            MOVE      SP70,OPDIDESC
.                                           *** HPS Code Starts Here ***
            MOVE      SP70,OPDICOD2          
            MOVE      SP70,OPDIDES2
            MOVE      SP70,OPDICOD3
            MOVE      SP70,OPDIDES3
            MOVE      SP70,OPDICOD4
            MOVE      SP70,OPDIDES4
            MOVE      SP70,OPDICOD5
            MOVE      SP70,OPDIDES5          
.                                           *** HPS Code Ends Here ***
            MOVE      SP70,OPDISPAR
          ENDIF
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          IF        OVRCD=0
            CALL      MOVBB000
            CALL      UPBOKB1
.
            PACK      KEY8,OBAOUTNO,SP70
            CALL      RDPMVX11
            IF        OVRCD=0
                CALL      IBACLOCK
                PACK      PMVXLUPD,CCC,CYY,CMM,CDD
                REP       " 0",PMVXLUPD
                MOVE      CTIMEIS,PMVXLUPT
                MOVE      USERID,PMVXWEBU
                CALL      UPPMVX11
            ENDIF
.
          ELSE
            CALL      MOVBB000
            CALL      WRBOKB1
            CALL      WRCPAT00           * write to current patient file
            PACK      KEY3,OBACOMP,SP70
            CALL      PRAD0000           * write to person responsible file
          ENDIF
.
          IF        BBREFLIN=ONE
            MOVE      OBAOUTNO,KEY8
            CALL      RDBOKB1
            IF        OVRCD=0
              PACK      DIM17,OTBBBKOV,OTBBBKPR,OTBBBKPM,OTBBBKBA:
                              OTBBRDAT,SP70
              MATCH      SP70,DIM17
              IF         @EQUAL
                MOVE       ALREBKOV,OTBBBKOV
                MOVE       ALREBKPR,OTBBBKPR
                MOVE       ALREBKPM,OTBBBKPM
                MOVE       ALREBKBA,OTBBBKBA
                MOVE       ALRERDAT,OTBBRDAT
                CALL       UPBOKB1
              ENDIF
            ENDIF
          ENDIF
.
          IF        PTCNHDPS=1
            MOVE      OBAOUTNO,ADMISSNO
            CALL      WRTACC00
            CALL      WRPORD00          * write/upd ACC Purchase Order
          ENDIF
.
          MOVE      OBAOUTNO,KEY8
          IF        DIAGOVR=0
            CALL      UPDIAG1
          ELSE
            CALL      WRDIAG1
          ENDIF
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDOTPRC1
          IF        OVRCD=1
            CALL      CLOUTPRC
            MOVE      OBAOUTNO,OTPROUTN
            CALL      MVOTPC00
            CALL      WROTPRC1
          ELSE
            CALL      MVOTPC00
            CALL      UPOTPRC1
          ENDIF
.
          CALL      CMBS0000                * Check for CMBS items
.
          CALL      XWPCOM00                *wrtbok
          CALL      UPVCM000                
          CALL      NWVCM000   
.
          MOVE      "013",KEY3
          CALL      PATINS00                * Patient Instructions
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,WRTBOK99
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,WRTBOK99
.
          MATCH     Z70,OUTBB008            * Health fund received from
          GOTO      WRTBOK60 IF EQUAL       * booking
.
          MATCH     SP70,OBACOMP
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSL,OBACOMP,SP70
            CALL      RDCODE1
            BRANCH    OVRCD,WRTBOK60
.
            MATCH     "A",TCINDC2
            IF        @EQUAL
              MATCH     "1",TCINDC13
              GOTO      WRTBOK60 IF EQUAL     * ABF - Not copying HF from PMI
            ENDIF
          ENDIF
.
          MOVE      OTBBFUND,PFUNDH         * Update PMI health fund
          MOVE      OTBBTBLE,PFNDTB         * Update PMI health fund table
.
          CALL      UPMAST1
.
          CALL      PMIGTNID              * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      FORTY7,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICUP              * broadcast PMI update message
.
WRTBOK60  MATCH     "1",OTCNINTR       * Not using visit based interpreter req
          IF        !@EQUAL
            MATCH     "1",PMPXINTR 
            IF        @EQUAL
              PACK      CASEKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,DOBASLOT,SP70
              CALL      INTUPD00                 * Interpreter Table Processing
            ENDIF
          ENDIF
          CALL      PRNT0000
.
          MOVE      NEWSLOTK,SESSKEYS          * Read session details to get
          CALL      SESDET00                   * hospital code
          IF        EXIT=1
            MOVE      WBSEHOSP,OTHEHOSP
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMVX11
          IF        OVRCD=0
            CALL      MVVXTF00
            MOVE      USERID,PMVXWEBU
            PACK      PMVXLUPD,CCC,CYY,CMM,CDD
            REP       " 0",PMVXLUPD
            CLOCK     TIME,PMVXLUPT
            MOVE      PPOST,PMVXPOST
            MOVE      OTHEHOSP,PMVXMHOS
            CALL      GTASGC00                 * get SLA/ASGC code
            MOVE      PMPXABRG,PMVXABRG
            CALL      UPPMVX11
          ELSE
            CALL      CLPMSVX1
            CALL      MVVXTF00
            MOVE      ADMISSNO,PMVXVISN 
            MOVE      USERID,PMVXWEBC
            PACK      PMVXCDTE,CCC,CYY,CMM,CDD
            REP       " 0",PMVXCDTE
            CLOCK     TIME,PMVXCTIM
            MOVE      PPOST,PMVXPOST
            MOVE      OTHEHOSP,PMVXMHOS
            CALL      GTASGC00                 * get SLA/ASGC code
            MOVE      SP70,PMVXPOEC
            MOVE      SP70,PMVXPGID
            MOVE      SP70,PMVXPILC
            MOVE      PMPXABRG,PMVXABRG
            CALL      WRPMVX11
          ENDIF
.
          MATCH     "1",OTCNINTR            * Using visit based interpreter req
          IF        @EQUAL
            MATCH     "1",PMVXINTR
            IF        @EQUAL
              PACK      CASEKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,DOBASLOT,SP70
              CALL      INTUPD00                 * Interpreter Table Processing
            ENDIF
          ENDIF
.
          MOVE      ADMISSNO,PVIBILL
          MOVE      ADMISSNO,DPVIBILL
          MOVE      URNUMBER,PVIURNO
          CALL      ADDVIS00                 * Writes to MRTVISFD
          CALL      AEXP0000                 * write adm based expected payors
.
          CALL      WOPG0000                 * Write new program to patient
.
          CALL      WWAT0000                 * Write waiting list link
          CALL      WWAI0000                 * Write waiting list link
.
          CALL      WREF0000                 * No linked referral warning
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      FOUR,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICON        * DG API O/P New Appoint.  *I-90203
.
          CALL      DISVAL00
          BRANCH    EXIT,WRTBOK99
.
          COMPARE   ONE,RECALFLG          * This may need to be changed to only
          GOTO      WRTBOK80 IF NOT EQUAL * re calc if the slot type has changed
.                                         * ie New - Review - Special
          PACK      SAVSKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RCAL0000              * Recalculate clinic counts as a
.                                         * slot type was changed
          MOVE      NEWSLOTK,KEY28        * Read correct appointment for
          CALL      RDBOKA1               * redirect
          BRANCH    OVRCD,WRTBOK92
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,WRTBOK92
.
WRTBOK80  MOVE      ZERO,EXIT
          COMPARE   ZERO,WARNCNT 
          GOTO      WRTBOK99 IF EQUAL       * No warning message
.
          STRIP     REDIRECT
          ENDSET    REDIRECT
          APPEND    "&admissno=",REDIRECT
          MOVE      OBAOUTNO,KEY8
          REP       " +",KEY8
          APPEND    KEY8,REDIRECT
          APPEND    "&casekeys=",REDIRECT
          PACK      CASEKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
          REP       " +",CASEKEYS
          APPEND    CASEKEYS,REDIRECT
          RESET     REDIRECT
.
          CALL      ERRLST00                * Display warning messages
          MOVE      ONE,EXIT
          GOTO      WRTBOK99
.
WRTBOK89  MOVE      "Error: Invalid Patient U/R",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      WRTBOK99
.
WRTBOK90  MOVE      "Error: Patient is Deceased",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      WRTBOK99
.
WRTBOK91  MOVE      "Error: Appointment Details Must be Specified",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      WRTBOK99
.
WRTBOK92  MOVE      "Error: Appointment Record Missing",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      WRTBOK99
.
WRTBOK93  MOVE      "Error: Appointment Record Locked",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      WRTBOK99
.
WRTBOK94  MOVE      "Error: Appointment Time Has Been Taken. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      WRTBOK99
.
. HPS Code Starts Here
WRTBOK95  MOVE      "Patient already has a booking in this Clinic/Type",WEBTITLE
          CALL      WEBERR00
          MOVE      ZERO,EXIT
          GOTO      WRTBOK99
.
WRTBOK96  MOVE      "Patient already booked to the Clinic at same time",WEBTITLE
          CALL      WEBERR00
          MOVE      ZERO,EXIT
          GOTO      WRTBOK99
. 
WRTBOK97  MOVE      "Invalid referral criteria for this booking.",WEBTITLE
          CALL      WEBERR00
          MOVE      ZERO,EXIT
          GOTO      WRTBOK99
.
WRTBOK99  CALL      UUOTBOA1
          CLOSE     COMFILAF,DELETE
          CLOSE     COMFILBF,DELETE
          CLOSE     COMVISAF,DELETE
          MOVE      ZERO,VINAHFLG                * reset audit flags
          MOVE      ZERO,EPAUDFLG
          MOVE      ZERO,RIAUDFLG
          MOVE      SP8,VINAHREF
          RETURN
+
.*******************************************************************************
.                    Open Outpatient Files
.*******************************************************************************
OPNOUT00  PACK      CFNAME,CFILEPRE,FILBOKA1  * Get the name of the BOKA1 file
          CLOSE     OUTBOKA1
          OPEN      OUTBOKA1,CFNAME           * Open the file
          PACK      CFNAME,CFILEPRE,FILBOKA2  * Get the name of the BOKA2 file
          CLOSE     OUTBOKA2
          OPEN      OUTBOKA2,CFNAME           * Open the file
          PACK      CFNAME,CFILEPRE,FILBOKA3  * Get the name of the BOKA3 file
          CLOSE     OUTBOKA3
          OPEN      OUTBOKA3,CFNAME           * Open the file
          PACK      CFNAME,CFILEPRE,FILBOKA4  * Get the name of the BOKA4 file
          CLOSE     OUTBOKA4
          OPEN      OUTBOKA4,CFNAME           * Open the file
          PACK      CFNAME,CFILEPRE,FILBOKA5  * Get the name of the BOKA5 file
          CLOSE     OUTBOKA5
          OPEN      OUTBOKA5,CFNAME
          PACK      CFNAME,CFILEPRE,FILBOKA6  * Get the name of the BOKA6 file
          CLOSE     OUTBOKA6
          OPEN      OUTBOKA6,CFNAME
.
          PACK      CFNAME,CFILEPRE,FILBOKC1  * Get the name of the BOKC1 file
          CLOSE     OUTBOKC1
          OPEN      OUTBOKC1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILXSCA1  * Get the name of the XSCA1 file
          CLOSE     OUTXSCA1
          OPEN      OUTXSCA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILXWPA1  * Get the name of the XWPA1 file
          CLOSE     OUTXWPA1
          OPEN      OUTXWPA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILRAPA1  * Get the name of the PAPA1 file
          CLOSE     OUTRAPA1
          OPEN      OUTRAPA1,CFNAME         * Open the Re-Appointment file
.
          PACK      CFNAME,CFILEPRE,FILRAPA2  * Get the name of the PAPA2 file
          CLOSE     OUTRAPA2
          OPEN      OUTRAPA2,CFNAME         * Open the Re-Appointment file
.
          PACK      CFNAME,CFILEPRE,FILSESA1  * Get the name of the SESA1 file
          CLOSE     OUTSESA1
          OPEN      OUTSESA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILSESA2  * Get the name of the SESA2 file
          CLOSE     OUTSESA2
          OPEN      OUTSESA2,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILSESA4  * Get the name of the SESA4 file
          CLOSE     OUTSESA4
          OPEN      OUTSESA4,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILSESA2  * Get the name of the SESA6 file
          CLOSE     OUTSESA6
          OPEN      OUTSESA6,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILSESA2  * Get the name of the SESA7 file
          CLOSE     OUTSESA7
          OPEN      OUTSESA7,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILCLIA1  * Get the name of the CLIA1 file
          CLOSE     OUTCLIA1
          OPEN      OUTCLIA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILCTYA1  * Get the name of the CLIA1 file
          CLOSE     OUTCTYA1
          OPEN      OUTCTYA1,CFNAME           * Open the file
          PACK      CFNAME,CFILEPRE,FILCTYA2  * Get the name of the CTYA2 file
          CLOSE     OUTCTYA2
          OPEN      OUTCTYA2,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILCANA1  * Get the name of the CANA2 file
          CLOSE     OUTCANA1
          OPEN      OUTCANA1,CFNAME          * Open the cancellation log file
.
          PACK      CFNAME,CFILEPRE,FILDIAG1  * Get the name of the DIAG1 file
          CLOSE     OUTDIAG1
          OPEN      OUTDIAG1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILDTRO1
          CLOSE     OUTDTRO1
          OPEN      OUTDTRO1,CFNAME
.
          PACK      CFNAME,CFILEPRE,FILMA1A1
          CLOSE     OUTMA1A1
          CALL      OPOTMA11                * Open the file
          PACK      CFNAME,CFILEPRE,FILMA1A2
          CLOSE     OUTMA1A2
          CALL      OPOTMA12                * Open the file
.
          PACK      CFNAME,CFILEPRE,FILBB1A1
          CLOSE     OUTBB1A1
          CALL      OPOTBB11               * Open the file
.
          PACK      CFNAME,CFILEPRE,FILBB1A2
          CLOSE     OUTBB1A2
          CALL      OPOTBB12               * Open the file
.
          PACK      CFNAME,CFILEPRE,FILRSHA1
          CLOSE     OUTRSHA1
          OPEN      OUTRSHA1,CFNAME          * Open the rescheduling file
.
          OPEN      OUTPREA1,"outpreaf"      * Open pre-attendance file
.
          OPEN      VISCMTA1,"viscmtaf"      * Open Comments file      *I-48413
.
          PACK      CFNAME,CFILEPRE,FILHISA1
          CLOSE     OUTHISA1
          OPEN      OUTHISA1,CFNAME
.
          PACK      CFNAME,CFILEPRE,FILSRVA1
          CLOSE     OUTSRVA1
          OPEN      OUTSRVA1,CFNAME
.
          PACK      CFNAME,CFILEPRE,FILMSPA1
          CLOSE     OUTMSPA1
          OPEN      OUTMSPA1,CFNAME
.
          PACK      CFNAME,CFILEPRE,FILCMNA1
          CLOSE     OUTCMNA1
          OPEN      OUTCMNA1,CFNAME
.
          PACK      CFNAME,CFILEPRE,FILMASB1
          CLOSE     OUTMASB1
          OPEN      OUTMASB1,CFNAME
.
          PACK      CFNAME,CFILEPRE,FILUSEA1
          CLOSE     OUTUSEA1
          OPEN      OUTUSEA1,CFNAME
.
          PACK      CFNAME,CFILEPRE,FILPRCA1
          CLOSE     OUTPRCA1
          OPEN      OUTPRCA1,CFNAME
.
          IF        HOAUDA=0
            PACK      CFNAME,CFILEPRE,FILAUDBA
            CLOSE     OUTAUDBA
            OPEN      OUTAUDBA,CFNAME
          ENDIF
.
          IF        HOAUDB=0
            PACK      CFNAME,CFILEPRE,FILAUBB1
            CLOSE     OUTAUBB1
            OPEN      OUTAUBB1,CFNAME      * 0 = use audit, 1 = not required
          ENDIF
.
          PACK      CFNAME,CFILEPRE,FILLKBA1  * Get the name of the LKBA1 file
          CLOSE     OUTLKBA1
          OPEN      OUTLKBA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILLKBA2  * Get the name of the LKBA2 file
          CLOSE     OUTLKBA2
          OPEN      OUTLKBA2,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILHEDA1  * Get the name of the HEDA1 file
          CLOSE     OUTHEDA1
          OPEN      OUTHEDA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILBOXA1  * Get the name of the BOXA1 file
          CLOSE     OUTBOXA1
          OPEN      OUTBOXA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILBITA1  * Get the name of the BITA1 file
          CLOSE     OUTBITA1
          OPEN      OUTBITA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILCPBA1  * Get the name of the CPBA1 file
          CLOSE     OUTCPBA1
          OPEN      OUTCPBA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILCPCA1  * Get the name of the CPCA1 file
          CLOSE     OUTCPCA1
          OPEN      OUTCPCA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILCVTA1  * Get the name of the CVTA1 file
          CLOSE     OUTCVTA1
          OPEN      OUTCVTA1,CFNAME           * Open the file
.
          RETURN
+
.------------------------------------------------------------------------------
. Update PMEXUYN1 for pmsextaf if passed value found
.------------------------------------------------------------------------------
UPMV0000  PACK      KEY11,OBAOUTNO,SAVBCOMP,SP70 
          CALL      RDPMEXT1
          IF        OVRCD=0
            MATCH     "0",OPWAMVNY           * Motor Vehicle Accident NO
            IF        @EQUAL
              PACK      PMEXCLAM,OBACOMP                            
              MOVE      OPWAMVNY,PMEXUYN1
              CALL      UPPMEXT1
            ENDIF
.
            MATCH     "1",OPWAMVNY           * Motor Vehicle Accident YES
            IF        @EQUAL
              MATCH     OBACOMP,SAVBCOMP      
              GOTO      UPMV0100 IF EQUAL    * CLaim Code UPDated NO
              MOVE      SP70,PMEXICOD
              GOTO      UPMV0100

UPMV0100      PACK      PMEXCLAM,OBACOMP
              MOVE      OPWAMVNY,PMEXUYN1
              CALL      UPPMEXT1
            ENDIF
          ENDIF

UPMV9999  RETURN
+
.------------------------------------------------------------------------------
. Re calculate the session statistics
.------------------------------------------------------------------------------
RCAL0000  MATCH     SP70,SAVSKEYS
          GOTO      RCAL9999 IF EQUAL
.
          MOVE      SAVSKEYS,SESSKEYS
.
          PACK      KEY25,SESSKEYS,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,RCAL9999
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,RCAL9999
.
          PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,RCAL9999
.
... SRF 33923 - Commented out the next 3 lines of code
.          PACK      KEY25,OSESITE,OSECLIN,OSEDATE,OSESTRT
.          PACK      OSESCSTT,SP5
.          CALL      GCST0000
.
          COMPARE   EIGHT,UPDATETY
          IF        !@EQUAL
            MOVE      "00:00",OSETIMEU
          ENDIF
.
          CALL      SLTCOUNT                   * update slot counts
.
RCAL9999  RETURN
+
.-------------------------------------------------------------------------------
.  DISVAL00 - Disaster Validations and Post
.-------------------------------------------------------------------------------
DISVAL00  MOVE      ZERO,EXIT
          MATCH     SP70,DISPT001
          GOTO      DISVAL99 IF EQUAL
          GOTO      DISVAL99 IF EOS
.
          PACK      KEY9,DISPT001,SP70
          CALL      RDDSMAS1
          BRANCH    OVRCD,DISVAL90
.
          MATCH     SP70,DSMASDAT
          IF        !@EQUAL & !@EOS
            MATCH     DSMASDAT,OBADATE
            IF        @LESS
              GOTO      DISVAL92
            ENDIF
          ENDIF
.
          MATCH     SP70,DSMAEDAT
          IF        !@EQUAL & !@EOS
            MATCH     OBADATE,DSMAEDAT
            IF        @LESS
              GOTO      DISVAL92
            ENDIF
          ENDIF
.
          MOVE      PURNO,DSPTURNO
          MOVE      DISPT002,DSPTDIID
          MOVE      DISPT001,DSPTCODE
          MOVE      DSMASDAT,DSPTSDAT
          MOVE      DSMAEDAT,DSPTEDAT
          MOVE      SP70,DSPTOTCM
          MOVE      " 3",DSPTFICA
          MOVE      SP70,DSPTSPAR
.
          PACK      KEY17,PURNO,DISPT001,SP70
          CALL      RADSPAT1
          IF        OVRCD=1
            MOVE      WBSEUID,DSPTCUSR
            CALL      IBACLOCK
            PACK      DSPTCDAT,CCC,CYY,CMM,CDD
            REP       " 0",DSPTCDAT
            CLOCK     TIME,CTIMEIS
            MOVE      CTIMEIS,DSPTCTIM
            MOVE      SP70,DSPTUUSR
            MOVE      SP70,DSPTUDAT
            MOVE      SP70,DSPTUTIM
            CALL      WRDSPAT1
          ELSE
            MOVE      WBSEUID,DSPTUUSR
            CALL      IBACLOCK
            PACK      DSPTUDAT,CCC,CYY,CMM,CDD
            REP       " 0",DSPTUDAT
            CLOCK     TIME,CTIMEIS
            MOVE      CTIMEIS,DSPTUTIM
            CALL      UPDSPAT1
          ENDIF
.
          MOVE      PURNO,DSPLURNO
          MOVE      DISPT001,DSPLCODE
          MOVE      DOBAOUTN,DSPLVISN
          MOVE      SP70,DSPLSPAR
          PACK      KEY25,PURNO,DISPT001,DOBAOUTN,SP70
          CALL      RADSPTL1
          IF        OVRCD=1
            MOVE      WBSEUID,DSPLCUSR
            CALL      IBACLOCK
            PACK      DSPLCDAT,CCC,CYY,CMM,CDD
            REP       " 0",DSPLCDAT
            CLOCK     TIME,CTIMEIS
            MOVE      CTIMEIS,DSPLCTIM
            MOVE      SP70,DSPLUUSR
            MOVE      SP70,DSPLUDAT
            MOVE      SP70,DSPLUTIM
            CALL      WRDSPTL1
          ELSE
            MOVE      WBSEUID,DSPLUUSR
            CALL      IBACLOCK
            PACK      DSPLUDAT,CCC,CYY,CMM,CDD
            REP       " 0",DSPLUDAT
            CLOCK     TIME,CTIMEIS
            MOVE      CTIMEIS,DSPTUTIM
            CALL      UPDSPTL1
          ENDIF
.
          CALL     NWDALT00
          GOTO     DISVAL99
.
DISVAL90  MOVE      "Disaster Master Record not found.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DISVAL99
.
DISVAL92  MOVE      "Date on list is not within the Disaster Start/End Date.",WEBTITLE
.
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DISVAL99
.
DISVAL99  RETURN
+
.---------------------------------------------------------------------
. NWDALT00 - Write a new alternate ID record for disaster patients
.---------------------------------------------------------------------
NWDALT00  PACK      PMAIURNO,PURNO,SP70
.
          MATCH     SP70,DSMAAICD
          GOTO      NWDALT99 IF EQUAL
          GOTO      NWDALT99 IF EOS
.
          PACK      PMAITYPE,DSMAAICD,SP70
.
          MATCH     SP70,DSPTDIID
          GOTO      NWDALT99 IF EQUAL
          GOTO      NWDALT99 IF EOS
.
          PACK      KEY5,ANSA,ANSI,DSMAAICD,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MATCH     SP70,TCINDC1
            IF        !@EQUAL & !@EOS
              PACK      PMAIALID,TCINDC1,DSPTDIID,SP70
            ELSE
              PACK      PMAIALID,DSPTDIID,SP70
            ENDIF
          ELSE
            PACK      PMAIALID,DSPTDIID,SP70
          ENDIF
.
          RJUSTIFY  PMAIALID
          PACK      PMAIDISU,SP70
          PACK      PMAIHOSP,SP70
          MATCH     "1",PTCNDAUR
          IF        @EQUAL
            MOVE      "1",PMAIDISU
          ENDIF
          PACK      PMAIRDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMAIRDAT
          UNPACK    SP70,PMAISPAR
.
          PACK      KEY31,PMAIURNO,PMAITYPE,PMAIALID,SP70
          CALL      RAPMAID1
          IF        OVRCD<>1
            GOTO      NWDALT99
          ENDIF
.
          MOVE      USERID,PMAICRUD
          CALL      IBACLOCK
          PACK      PMAICRDT,CCC,CYY,CMM,CDD
          REP       " 0",PMAICRDT
          MOVE      CTIMEIS,PMAICRTM
          MOVE      SP70,PMAIUPDT
          MOVE      SP70,PMAIUPTM
          MOVE      SP70,PMAIUPUD
.
          CALL      WRPMAID1
.
NWDALT99  RETURN
+
.-----------------------------------------------------------------------------.
. Warn user if there is no linked referral if they are using medclaims
.-----------------------------------------------------------------------------.
WREF0000  MATCH     "1",IBCNUMCI            * Using medclaims
          GOTO      WREF9999 IF NOT EQUAL
.
          MATCH     "1",OTMAUMCI            *Clinic Using medclaims
          GOTO      WREF9999 IF NOT EQUAL
.
          PACK      KEY16,DOBAOUTN,SP70
          CALL      RSALLNK2
WREF1000  CALL      RKALLNK2
          BRANCH    OVRCD,WREF9000
.
          MATCH     DOBAOUTN,ALLNLNKV     * same visit no?
          GOTO      WREF9000 IF NOT EQUAL
.
          GOTO      WREF9999
.
WREF9000  ADD       ONE,WARNCNT
          MOVE      "Warning - No referral linked to this visit.",WEBWRN[WARNCNT]
.
WREF9999  RETURN
+
.------------------------------------------------------------------------------
. Booking - Write waiting list link record PAS
.------------------------------------------------------------------------------
WWAI0000  COMPARE   ONE,HBWAIT            * Using w/list
          GOTO      WWAI9999 IF NOT EQUAL
.
          MATCH     Z70,WAITLKEY          * Not a w/list booking
          GOTO      WWAI9999 IF EQUAL
.
          COMPARE   TWO,WAITFLAG          * w/list booking PAS
          GOTO      WWAI9999 IF NOT EQUAL
.
          PACK      KEY27,WAITLKEY,OBAOUTNO,SP70
          CALL      RDWTOPS1
          COMPARE   ZERO,OVRCD
          GOTO      WWAI9999 IF EQUAL
.
          PACK      KEY19,WAITLKEY,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,WWAI9999
.
          PACK      KEY19,WAITLKEY,SP70
          CALL      RDWTTX11
          BRANCH    OVRCD,WWAI9999
.
          UNPACK    WAITLKEY,WTOSURNO,WTOSCODE,WTOSCOUN
          MOVE      OBASITE,WTOSSITE
          MOVE      OBACLIN,WTOSCLIN
          MOVE      OBADATE,WTOSDATE
          MOVE      OBASTRT,WTOSSTRT
          MOVE      OBASLOT,WTOSSLOT
          MOVE      OBAOUTNO,WTOSOUTN
.
          MOVE      WTTXPANS,WTOSOSTA         * Original status
.
          MOVE      OBADATE,WTOSPDAT
          MOVE      OBATIME,WTOSPTIM
          MOVE      ZERO,WTOSSTAT
.
          PACK      WTOSCDAT,CCC,CYY,CMM,CDD
          REP       " 0",WTOSCDAT
          CLOCK     TIME,WTOSCTIM
          MOVE      WBSEUID,WTOSCUID
.
          MOVE      SP70,WTOSUDAT
          MOVE      SP70,WTOSUTIM
          MOVE      SP70,WTOSUUID
          MOVE      SP70,WTOSSPAR
.
          PACK      KEY27,WTOSURNO,WTOSCODE,WTOSCOUN,WTOSOUTN,SP70
          CALL      WRWTOPS1
.
          MOVE      OBADATE,WTWMTRPA      * Set Pre Anaesthetic date
          CALL      UPTREA1
.
          CALL      PSTA0000              * Set Pre Anaesthetic status to booked
.
          MOVE      OBATIME,WTTXPANT      * Set Pre Anaesthetic time
          CALL      UPWTTX11
.
WWAI9999  RETURN
+
.------------------------------------------------------------------------------
. Set pre anaesthetic status to booked. Cat XG indicator 1 = B
.------------------------------------------------------------------------------
PSTA0000  PACK      DIM2,ANSX,ANSG,SP70
          PACK      KEY5,DIM2,SP70
          CALL      RDSCODE1
PSTA1000  CALL      RDKCODE1
          BRANCH    OVRCD,PSTA9500
.
          MATCH     TCODE,DIM2
          GOTO      PSTA9500 IF NOT EQUAL
.
          MATCH     ANSB,TCINDC1                  * Booked
          GOTO      PSTA1000 IF NOT EQUAL
.
PSTA9000  MOVE      ACODE,WTTXPANS
          GOTO      PSTA9999
.
PSTA9500  MOVE      SP70,WTTXPANS
          GOTO      PSTA9999
.
PSTA9999  RETURN
+
.------------------------------------------------------------------------------
. Booking - Write waiting list link record PAC
.------------------------------------------------------------------------------
WWAT0000  COMPARE   ONE,HBWAIT            * Using w/list
          GOTO      WWAT9999 IF NOT EQUAL
.
          MATCH     Z70,WAITLKEY          * Not a w/list booking
          GOTO      WWAT9999 IF EQUAL
.
          COMPARE   ONE,WAITFLAG          * w/list booking PAC
          GOTO      WWAT9999 IF NOT EQUAL
.
          PACK      KEY27,WAITLKEY,OBAOUTNO,SP70
          CALL      RDWTOPA1
          COMPARE   ZERO,OVRCD
          GOTO      WWAT9999 IF EQUAL
.
          PACK      KEY19,WAITLKEY,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,WWAT9999
.
          PACK      KEY19,WAITLKEY,SP70
          CALL      RDWTTX11
          BRANCH    OVRCD,WWAT9999
.
          UNPACK    WAITLKEY,WTOPURNO,WTOPCODE,WTOPCOUN
          MOVE      OBASITE,WTOPSITE
          MOVE      OBACLIN,WTOPCLIN
          MOVE      OBADATE,WTOPDATE
          MOVE      OBASTRT,WTOPSTRT
          MOVE      OBASLOT,WTOPSLOT
          MOVE      OBAOUTNO,WTOPOUTN
.
          MOVE      WTTXPAST,WTOPOSTA         * Original status
.
          MOVE      OBADATE,WTOPPDAT
          MOVE      OBATIME,WTOPPTIM
          MOVE      ZERO,WTOPSTAT
.
          PACK      WTOPCDAT,CCC,CYY,CMM,CDD
          REP       " 0",WTOPCDAT
          CLOCK     TIME,WTOPCTIM
          MOVE      WBSEUID,WTOPCUID
.
          MOVE      SP70,WTOPUDAT
          MOVE      SP70,WTOPUTIM
          MOVE      SP70,WTOPUUID
          MOVE      SP70,WTOPSPAR
.
          PACK      KEY27,WTOPURNO,WTOPCODE,WTOPCOUN,WTOPOUTN,SP70
          CALL      WRWTOPA1
.
          MOVE      OBADATE,WTWMREAD      * Set Pre Adm date
          CALL      UPTREA1
.
          CALL      BSTA0000              * Set Pre Adm status to booked
.
          MOVE      OBATIME,WTTXPTIM      * Set Pre Adm time
          CALL      UPWTTX11
.
          CALL      BBST0000              * Set booking Pre Adm status to booked
.
WWAT9999  RETURN
+
.------------------------------------------------------------------------------
. Set pre admission status to booked. Cat XG indicator 1 = B
.------------------------------------------------------------------------------
BSTA0000  PACK      DIM2,ANSX,ANSG,SP70
          PACK      KEY5,DIM2,SP70
          CALL      RDSCODE1
BSTA1000  CALL      RDKCODE1
          BRANCH    OVRCD,BSTA9500
.
          MATCH     TCODE,DIM2
          GOTO      BSTA9500 IF NOT EQUAL
.
          MATCH     "I",PTCOACTV                  * Skip inactive
          GOTO      BSTA1000 IF EQUAL
.
          MATCH     ANSB,TCINDC1                  * Booked
          GOTO      BSTA1000 IF NOT EQUAL
.
BSTA9000  MOVE      ACODE,WTTXPAST
          GOTO      BSTA9999
.
BSTA9500  MOVE      SP70,WTTXPAST
          GOTO      BSTA9999
.
BSTA9999  RETURN
+
.------------------------------------------------------------------------------
. Set the booking records pre admission status (Cat BG) to booked.
. W/L Cat XG indicator 1 = B then map to cat BG using indicator 2
. W/L and W/L extension files must have been read
.------------------------------------------------------------------------------
BBST0000  MOVE      "XG",CATEGORY
          MOVE      WTTXPAST,CODE
          CALL      GETCOD00

          MATCH     ANSB,TCINDC1
          GOTO      BBST9999 IF NOT EQUAL
.
          MOVE      WMBOOK,KEY8
          CALL      RDBKRX11
          BRANCH    OVRCD,BBST9999
.
          MOVE      TCINDC2,KEY1            * Indicator 2 maps cat XG & BG
.
          PACK      DIM2,ANSB,ANSG,SP70
          PACK      KEY5,DIM2,SP70
          CALL      RDSCODE1
BBST1000  CALL      RDKCODE1
          BRANCH    OVRCD,BBST9999
.
          MATCH     TCODE,DIM2                    * Cat BG
          GOTO      BBST9999 IF NOT EQUAL
.
          MATCH     "I",PTCOACTV                  * Skip inactive
          GOTO      BBST1000 IF EQUAL
.
          MATCH     KEY1,TCINDC2                  * Booked/Attended
          GOTO      BBST1000 IF NOT EQUAL
.
          MOVE      ACODE,BKRXUDF3
          CALL      UPBKRX11
.
BBST9999  RETURN
+
.*******************************************************************************
. Update Interpreter Table
. Input  - OBAURNO
.        - OBAOUTNO
.        - CASEKEYS - for New Booking
.*******************************************************************************
INTUPD00  PACK      KEY8,OBAURNO,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,INTUPD99
.
.         MATCH     SP70,OBAVISIT
.         IF        !@EQUAL
.           PACK      KEY5,ANSC,ANSV,OBAVISIT,SP70
.           CALL      RDCODE1
.           IF        OVRCD=0
.             MATCH     ANSC,TCINDC8
.             IF        @EQUAL
.               CALL      INTDEL00          * Delete Interpreter record if it
.               GOTO      INTUPD99          * exists and write audit record
.             ENDIF
.           ENDIF
.         ENDIF
.
          MATCH     "1",OTCNINTR            * Using visit based interpreter req
          IF        @EQUAL
            MATCH     "1",PMVXINTR
            GOTO      INTUPD10 IF EQUAL
            GOTO      INTUPD99
          ENDIF
.
          MATCH     "1",PMPXINTR
          GOTO      INTUPD99 IF NOT EQUAL
.
INTUPD10  CALL      CLVISINT
          MOVE      ZERO,DATACHNG                                      *I-40489
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDVSINT1
....      IF        OVRCD=0
....        MOVE      "B",INTAUDTY
....        CALL      INTAUD00
....      ENDIF
.******************************************** Start of Addition        *I-40489
          BRANCH    OVRCD,INTUPD50          * new record - DATACHNG=0
.
          MOVE      ONE,DATACHNG
.                                           * has data changed?
          MATCH     OBADATE,VSINDATE
          GOTO      INTUPD50 IF NOT EQUAL
          MATCH     OBATIME,VSINTIME
          GOTO      INTUPD50 IF NOT EQUAL
          MATCH     CASEKEYS,VSINSUBK
          GOTO      INTUPD50 IF NOT EQUAL
.
          MATCH     SP70,OBAVISIT
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSV,OBAVISIT,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MATCH     ANSC,TCINDC8
              IF        @EQUAL
                MATCH     "1",VSINCHON
                GOTO      INTUPD50 IF NOT EQUAL
              ELSE
                MATCH     "0",VSINCHON
                GOTO      INTUPD50 IF NOT EQUAL
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      ZERO,DATACHNG           * no data changed - end it all
          GOTO      INTUPD99
.
INTUPD50  IF        DATACHNG = 1
            MOVE      "B",INTAUDTY          * "before change"
            CALL      INTAUD00
          ENDIF
.
.********************************************   End of Addition        *I-40489
.
          MOVE      OBAOUTNO,VSINVISN
          MOVE      OBADATE,VSINDATE
          PACK      VSINTIME,OBATIME,KSECONDS
          MOVE      "2",VSINTYPE
          MOVE      CASEKEYS,VSINSUBK
          MOVE      USERID,VSINWUID
.
          MATCH     SP70,OBAVISIT
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSV,OBAVISIT,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MATCH     ANSC,TCINDC8
              IF        @EQUAL
                MOVE      "1",VSINCHON
              ELSE
                MOVE      "0",VSINCHON
              ENDIF
            ENDIF
          ENDIF
.
....      PACK      KEY8,OBAOUTNO,SP70                                  D-40489
....      CALL      RAVSINT1                                            D-40489
....      IF        OVRCD=0                                             D-40489
.                                           * test data change flag    *I-40489
          IF        DATACHNG = 1
            MOVE      ZERO,VSINNOTF                                    *I-40489
            CALL      UPVSINT1
            MOVE      "C",INTAUDTY
            CALL      INTAUD00
          ELSE
            MOVE      ZERO,VSINNOTF
            MOVE      SP70,VSINUDC1
            MOVE      SP70,VSINUDC2
            MOVE      SP70,VSINUDC3
            MOVE      SP70,VSINUDC4
            MOVE      SP70,VSININTP
            MOVE      SP70,VSINSPAR
            MOVE      ZERO,VSINCONF
            CALL      WRVSINT1
            MOVE      "A",INTAUDTY
            CALL      INTAUD00
          ENDIF
          MOVE      ZERO,EXIT
.
INTUPD99  RETURN
+
.------------------------------------------------------------
. Get SLA/ASGC code from ibapostf
.------------------------------------------------------------
GTASGC00  MOVE      PPOST,D8
          SQUEEZE   D8
          MOVE      D8,F4
          MOVE      F4,D4
          REP       " 0",D4
          PACK      PPOST,D4,SP10
          PACK      KEY56,PPOST,PSUBRB,SP10,PADD4,SP70                *C-240184
          CALL      RDIBPOS1
          IF        OVRCD=0
            MOVE      IBPOASGC,PMVXASGC
          ELSE                                                        *I-240184
            PACK      KEY56,PPOST,PSUBRB,SP70
            CALL      RSIBPOS1
            CALL      RKIBPOS1
            BRANCH    OVRCD,GTASGC99
            MATCH     PPOST,IBPOPCOD
            IF        @EQUAL
              MATCH     PSUBRB,IBPOSUBR
              IF        @EQUAL
                MOVE      IBPOASGC,PMVXASGC
              ENDIF
            ENDIF
          ENDIF
.
GTASGC99  RETURN
+
.*******************************************************************************
.                    Get Session Details for SESSKEYS
.*******************************************************************************
SESDET00  PACK      KEY25,SESSKEYS,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,SESDET90
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,SESDET90
.
          PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,SESDET90
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,SESDET90
.
          PACK      KEY12,OTHESITE,OTHECTYP,SP70
          CALL      RDCTYA1
          BRANCH    OVRCD,SESDET90
.
          PACK      KEY20,OSESITE,OSECLIN,OSEDATE,SP70
          CALL      RDCLIA1
          IF        OVRCD<>1
            GOTO      SESDET12
          ENDIF
.
          PACK      KEY20,OSESITE,OSECLIN,OSEDATE,Z70
          CALL      RDSCLIA1          * Read Clinic Record
SESDET10  CALL      RDPCLIA1          * Read Clinic Record
          BRANCH    OVRCD,SESDET99
.
          MATCH     OCASITE,OSESITE
          GOTO      SESDET99 IF NOT EQUAL
.
          MATCH     OCACLIN,OSECLIN
          GOTO      SESDET99 IF NOT EQUAL
.
SESDET12  MOVE      OCADESC,DOCFNAME
.
          MATCH     SP70,OCADESC
          IF        @EQUAL
            MATCH     SP70,OCADOCT
            IF        !@EQUAL
              MOVE      OCADOCT,KEY6
              CALL      RDDOCT1
              IF        OVRCD=1
                MOVE      OCADOCT,DOCFNAME
              ELSE
                MOVE      OCADOCT,DOCTCODE
                MOVE      DTITL,FMTTITLE
                MOVE      DGNAME,FMTGNAME
                MOVE      DSNAME,FMTSNAME
                CALL      DOCNM000
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      SESDET99
SESDET90  MOVE      ONE,EXIT
SESDET99  RETURN
+
.*******************************************************************************
.                        Print Request Processing
.*******************************************************************************
PRNT0000  CALL      CLRPRT00                * HPS_ODC(Screen No.9) Modified
          PACK      CASEKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
          PACK      KEY18,OBASITE,OBACLIN,OBADAY,OBASTRT,SP70
          CALL      RDMASA1
.
          MOVE      OBAURNO,URNUMBER
          MOVE      OBAOUTNO,ADMISSNO
          MOVE      CASEKEYS,SUBSYSKY
          MOVE      SP70,STATNCOD
          MOVE      SP70,FREETXT1
          MOVE      SP70,FREETXT2
          MOVE      SP70,FREETXT3
          MOVE      SP70,FREETXT4
          MOVE      SP70,FREETXT5
          MOVE      SP70,FREETXT6
          MOVE      SP70,FREETXT7
.
          MATCH     "1",LABPRT01
          GOTO      PRNT0010 IF NOT EQUAL
          MOVE      LABPSL01,SCHDPRNT
          MOVE      LABPNO01,SCHDCOPY
          PACK      LABELTYP,LABELOUT,OTMASBKL
.
          MATCH     SP70,OTMASBKL
          GOTO      PRNT0010 IF EQUAL
.
          MOVE      OUTLABEL,SETDFPRG
          MOVE      "1",SETDFRPT
          CALL      SETDEF00
.
          MATCH     SP70,OTMASBKL
          GOTO      PRNT0010 IF EQUAL
          CALL      ADDPRN00
.
PRNT0010  MATCH     "1",LABPRT02
          GOTO      PRNT0020 IF NOT EQUAL
          MOVE      LABPSL02,SCHDPRNT
          MOVE      LABPNO02,SCHDCOPY
          PACK      LABELTYP,LABELOUT,OTMASAPL
.
          MATCH     SP70,OTMASAPL
          GOTO      PRNT0020 IF EQUAL
.
          MOVE      OUTLABEL,SETDFPRG
          MOVE      "2",SETDFRPT
          CALL      SETDEF00
.
          MATCH     SP70,OTMASAPL
          GOTO      PRNT0020 IF EQUAL
          CALL      ADDPRN00
.
PRNT0020  MATCH     "1",LABPRT03
          GOTO      PRNT0030 IF NOT EQUAL
          MOVE      LABPSL03,SCHDPRNT
          MOVE      LABPNO03,SCHDCOPY
          PACK      LABELTYP,LABELOUT,OTMASPMM
.
          MATCH     SP70,OTMASPMM
          GOTO      PRNT0030 IF EQUAL
.
          MOVE      OUTLABEL,SETDFPRG
          MOVE      "3",SETDFRPT
          CALL      SETDEF00
.
          MATCH     SP70,OTMASPMM
          GOTO      PRNT0030 IF EQUAL
          CALL      ADDPRN00
.
PRNT0030  MATCH     "1",LABPRT04
          GOTO      PRNT0200 IF NOT EQUAL
          MOVE      LABPSL04,SCHDPRNT
          MOVE      LABPNO04,SCHDCOPY
          PACK      LABELTYP,LABELOUT,OTMASGPM
.
          MATCH     SP70,OTMASGPM
          GOTO      PRNT0200 IF EQUAL
.
          MOVE      OUTLABEL,SETDFPRG
          MOVE      "4",SETDFRPT
          CALL      SETDEF00
.
          MATCH     SP70,OTMASGPM
          GOTO      PRNT0200 IF EQUAL
          CALL      ADDPRN00
.
PRNT0200  MATCH     "1",LETPRT01              * Print Process for Letters
          GOTO      PRNT0210 IF NOT EQUAL
          MOVE      LETPSL01,SCHDPRNT
          MOVE      ONE,SCHDCOPY
.
          MOVE      LETTROUT,SETDFPRG
          MOVE      "1",SETDFRPT
          CALL      SETDEF00
.
          COMPARE   ZERO,OTMALPTR
          GOTO      PRNT0210 IF EQUAL
          MOVE      OTMALPTR,LETTNCOD
          MOVE      SP70,STATNCOD
          MOVE      TWO,PRNTTYPE
          CALL      PRNTUD00
.
PRNT0210  MATCH     "1",LETPRT02
          GOTO      PRNT0220 IF NOT EQUAL
          MOVE      LETPSL02,SCHDPRNT
          MOVE      ONE,SCHDCOPY
.
          MOVE      LETTROUT,SETDFPRG
          MOVE      "2",SETDFRPT
          CALL      SETDEF00
.
          COMPARE   ZERO,OTMALGPD
          GOTO      PRNT0220 IF EQUAL
          MOVE      OTMALGPD,LETTNCOD
          MOVE      SP70,STATNCOD
          MOVE      TWO,PRNTTYPE
          CALL      PRNTUD00
.
PRNT0220  MATCH     "1",LETPRT03
          GOTO      PRNT0230 IF NOT EQUAL
          MOVE      LETPSL03,SCHDPRNT
          MOVE      ONE,SCHDCOPY
.
          MOVE      LETTROUT,SETDFPRG
          MOVE      "3",SETDFRPT
          CALL      SETDEF00
.
          COMPARE   ZERO,OTMALPTD
          GOTO      PRNT0230 IF EQUAL
          MOVE      OTMALPTD,LETTNCOD
          MOVE      SP70,STATNCOD
          MOVE      TWO,PRNTTYPE
          CALL      PRNTUD00
.
PRNT0230  MATCH     "1",LETPRT04
          GOTO      PRNT0240 IF NOT EQUAL
          MOVE      LETPSL04,SCHDPRNT
          MOVE      ONE,SCHDCOPY
.
          MOVE      LETTROUT,SETDFPRG
          MOVE      "4",SETDFRPT
          CALL      SETDEF00
.
          COMPARE   ZERO,OTMABKLT
          GOTO      PRNT0240 IF EQUAL
          MOVE      OTMABKLT,LETTNCOD
          MOVE      SP70,STATNCOD
          MOVE      TWO,PRNTTYPE
          CALL      PRNTUD00
.
PRNT0240  MATCH     "1",LETPRT05
          GOTO      PRNT0250 IF NOT EQUAL
          MOVE      LETPSL05,SCHDPRNT
          MOVE      ONE,SCHDCOPY
.
          MOVE      LETTROUT,SETDFPRG
          MOVE      "5",SETDFRPT
          CALL      SETDEF00
.
          COMPARE   ZERO,OTMARALT
          GOTO      PRNT0250 IF EQUAL
          MOVE      OTMARALT,LETTNCOD
          MOVE      SP70,STATNCOD
          MOVE      TWO,PRNTTYPE
          CALL      PRNTUD00
.
PRNT0250  MATCH     "1",LETPRT06
          GOTO      PRNT0260 IF NOT EQUAL
          MOVE      LETPSL06,SCHDPRNT
          MOVE      ONE,SCHDCOPY
.
          MOVE      LETTROUT,SETDFPRG
          MOVE      "6",SETDFRPT
          CALL      SETDEF00
.
          COMPARE   ZERO,OTMARSLT
          GOTO      PRNT0260 IF EQUAL
          MOVE      OTMARSLT,LETTNCOD
          MOVE      SP70,STATNCOD
          MOVE      TWO,PRNTTYPE
          CALL      PRNTUD00
.
PRNT0260  MATCH     "1",LETPRT07
          GOTO      PRNT0270 IF NOT EQUAL
.
          MATCH     SP70,CASEKEYS
          GOTO      PRNT0270 IF EQUAL

          MOVE      LETPSL07,SCHDPRNT
          MOVE      ONE,SCHDCOPY
.
          MOVE      LETTROUT,SETDFPRG
          MOVE      "7",SETDFRPT
          CALL      SETDEF00
.
          COMPARE   ZERO,OTMALPPC
          GOTO      PRNT0270 IF EQUAL
          MOVE      OTMALPPC,LETTNCOD
          MOVE      SP70,STATNCOD
          MOVE      TWO,PRNTTYPE
          MOVE      PURNO,URNUMBER
          MOVE      PURNO,OBAURNO
          MOVE      SAVEADMN,OBAOUTNO
          CALL      PRNTUD00
.
PRNT0270  MATCH     "1",LETPRT08
          GOTO      PRNT0280 IF NOT EQUAL
          MOVE      LETPSL08,SCHDPRNT
          MOVE      ONE,SCHDCOPY
.
          MOVE      LETTROUT,SETDFPRG
          MOVE      "8",SETDFRPT
          CALL      SETDEF00
.
          COMPARE   ZERO,OTMASRLH
          GOTO      PRNT0400 IF EQUAL
          MOVE      OTMASRLH,LETTNCOD
          MOVE      SP70,STATNCOD
          MOVE      TWO,PRNTTYPE
          CALL      PRNTUD00
.
PRNT0280  MATCH     "1",LETPRT09
          GOTO      PRNT0290 IF NOT EQUAL
          MOVE      LETPSL09,SCHDPRNT
          MOVE      ONE,SCHDCOPY
.
          MOVE      LETTROUT,SETDFPRG
          MOVE      "9",SETDFRPT
          CALL      SETDEF00
.
          MATCH     SP70,OTMALSER
          GOTO      PRNT0400 IF EQUAL
          MOVE      OTMALSER,LETTNCOD
          MOVE      SP70,STATNCOD
          MOVE      TWO,PRNTTYPE
          CALL      PRNTUD00

.
PRNT0290  MATCH     "1",LETPRT10
          GOTO      PRNT0300 IF NOT EQUAL
          MOVE      LETPSL10,SCHDPRNT
          MOVE      ONE,SCHDCOPY
.
          MOVE      LETTROUT,SETDFPRG
          MOVE      "10",SETDFRPT
          CALL      SETDEF00
.
          MATCH     SP70,OTMALDNA
          GOTO      PRNT0300 IF EQUAL
          MOVE      OTMALDNA,LETTNCOD
          MOVE      SP70,STATNCOD
          MOVE      TWO,PRNTTYPE
          CALL      PRNTUD00
.
PRNT0300  MATCH     "1",LETPRT11
          GOTO      PRNT0400 IF NOT EQUAL
          MOVE      LETPSL11,SCHDPRNT
          MOVE      ONE,SCHDCOPY
.
          MOVE      LETTROUT,SETDFPRG
          MOVE      "11",SETDFRPT
          CALL      SETDEF00
.
          MATCH     Z70,LETTYP11
          GOTO      PRNT0400 IF EQUAL
.
          MOVE      LETTYP11,LETTNCOD
          MOVE      SP70,STATNCOD
          MOVE      TWO,PRNTTYPE
          CALL      PRNTUD00
.
PRNT0400  MATCH     "1",FRMPRT01                * Print Process for Forms
          GOTO      PRNT0500 IF NOT EQUAL
          MOVE      FRMPSL01,SCHDPRNT
          MOVE      ONE,SCHDCOPY
          MOVE      "31",SECTOR
          READ      CONTROLF,SECTOR;*139,HOMR3COD
          MOVE      HOMR3COD,STATNCOD
          MOVE      SP70,LETTNCOD
          MOVE      ONE,PRNTTYPE
.
          MOVE      FORMSOUT,SETDFPRG
          MOVE      "1",SETDFRPT
          CALL      SETDEF00
          CALL      PRNTUD00
.
PRNT0500  MATCH     "1",FRMPRT02                * Print Process for Invoices
          GOTO      PRNT0550 IF NOT EQUAL
          MOVE      FRMPSL02,SCHDPRNT
          MOVE      ONE,SCHDCOPY
          MOVE      SP70,STATNCOD
          MOVE      SP70,LETTNCOD
          MOVE      THREE,PRNTTYPE
.
          MOVE      FORMSOUT,SETDFPRG
          MOVE      "2",SETDFRPT
          CALL      SETDEF00
          CALL      PRNTUD00
.
PRNT0550  MATCH     "1",FRMPRT03                * Print Process for Forms
          GOTO      PRNT0600 IF NOT EQUAL
          MOVE      FRMPSL03,SCHDPRNT
          MOVE      ONE,SCHDCOPY
          MOVE      ONE,PRNTTYPE
.
          MOVE      FORMSOUT,SETDFPRG
          MOVE      "3",SETDFRPT
          MOVE      FRMTYP03,STATNCOD
          CALL      SETDEF00
          CALL      PRNTUD00
.
PRNT0600  MATCH     "1",CLAIMPRT                * Print Process for MedClaims
          GOTO      PRNT0700 IF NOT EQUAL
.
          CALL      HICCLAIM                * writes record to hicclmaf
          BRANCH    EXIT,PRNT0700,PRNT0700
.
          MOVE      CLAIMPSL,SCHDPRNT
          MOVE      ONE,SCHDCOPY
          MOVE      "HICCLM",STATNCOD
          MOVE      ZERO,LETTNCOD
          MOVE      ONE,PRNTTYPE
.
          MOVE      OUTCLAIM,SETDFPRG
          MOVE      "3",SETDFRPT
          CALL      SETDEF00
          CALL      PRNTUD00
          GOTO      PRNT9999
.
PRNT0700  MOVE      ZERO,EXIT
          GOTO      PRNT9999
.
PRNT9000
....CALL      WEBERR00
....          MOVE      ONE,EXIT
          MOVE      ZERO,EXIT
          GOTO      PRNT9999
.
PRNT9999  RETURN
+
.*******************************************************************************
.              Update Labels and Forms Printing Control Table
.*******************************************************************************
PRNTUD00  PACK      KEY5,Z70
          CALL      RSOTLPC1
          CALL      RPOTLPC1
          IF        OVRCD=1
            MOVE      ZERO,F5
            MOVE      F5,OTLPSCHE
          ENDIF
.
          MOVE      OTLPSCHE,F5
          ADD       ONE,F5
          MOVE      F5,OTLPSCHE
          MOVE      OBAURNO,OTLPURNO
          MOVE      OBAOUTNO,OTLPBOOK
          MOVE      OBASITE,OTLPSITE
          MOVE      OBACLIN,OTLPCLIN
          MOVE      OBADATE,OTLPSDAT
          MOVE      OBASTRT,OTLPSTIM
          MOVE      OBASLOT,OTLPSLOT
.
          MOVE      SCHDPRNT,OTLPPRNT
          MOVE      SCHDCOPY,OTLPCOPY
          MOVE      STATNCOD,OTLPSTAT
          MOVE      LETTNCOD,OTLPLETT
.         MOVE      PRNTTYPE,OTLPLETT
          MOVE      PRNTTYPE,OTLPPTYP
          MOVE      USERID,OTLPWEBU
          PACK      OTLPRDAT,CCC,CYY,CMM,CDD
          REP       " 0",OTLPRDAT
          MOVE      CTIMEIS,OTLPRTIM
.
          MOVE      ZERO,OTLPSERS
          MATCH     Z70,LETPRT09
          IF        !@EQUAL
            MOVE      ONE,OTLPSERS               * Series booking letter = Yes
          ENDIF
.
PRNTUD50  PACK      KEY5,OTLPSCHE
          CALL      RAOTLPC1
          IF        OVRCD=1
            TRAP      WRTRAP IF IO               * Trap to stop I * D when
            CALL      WROTLPC1                   * multiple servers write to the
            TRAPCLR   IO                         * outpatient print file
          ELSE
            GOTO      PRNTUD00
          ENDIF
.
PRNTUD99  RETURN
.
WRTRAP    NORETURN
          ADD         ONE,F5
          MOVE        F5,OTLPSCHE
          GOTO        PRNTUD50
+
.*******************************************************************************
.                 Clear Variables for Printing Control Table
.*******************************************************************************
CLRPRT00  MOVE      Z70,IBLPSCHE
          MOVE      Z70,IBLPURNO
          MOVE      Z70,IBLPVISN
          MOVE      Z70,IBLPSKEY
          MOVE      Z70,IBLPPRNT
          MOVE      ZERO,IBLPCOPY
          MOVE      Z70,IBLPSTAT
          MOVE      Z70,IBLPLAPR
          MOVE      Z70,IBLPLASC
          MOVE      Z70,IBLPFRE1
          MOVE      Z70,IBLPFRE2
          MOVE      Z70,IBLPFRE3
          MOVE      Z70,IBLPFRE4
          MOVE      Z70,IBLPFRE5
          MOVE      Z70,IBLPFRE6
          MOVE      Z70,IBLPFRE7
          MOVE      Z70,IBLPRUID
          MOVE      Z70,IBLPRDAT
          MOVE      Z70,IBLPRTIM
.
CLRPRT99  RETURN
+
.------------------------------------------------------------
. Set Default Printer
.------------------------------------------------------------
SETDEF00  MOVE      PRGID,SAVPRGID
          MOVE      REPORTNO,SAVREPTN
.
          MOVE      SCHDPRNT,SELPRINT
          MOVE      SETDFPRG,PRGID
          MOVE      SETDFRPT,REPORTNO
          CALL      UPDFPT00
.
          MOVE      SAVPRGID,PRGID
          MOVE      SAVREPTN,REPORTNO
          RETURN
+
.*****************************************************************************
. Check for the Disease code and Sex Combination
.*****************************************************************************
VALICD00  MOVE      ZERO,WARNCNT
          MOVE      ZERO,ERRFLAG
          MATCH     Z70,OUTBB045
          IF        !@EQUAL
            MOVE      OUTBB045,D9
            CALL      DISCOD00
            BRANCH    EXIT,VALICD99
          ENDIF
.
          MATCH     Z70,OUTBB055
          IF        !@EQUAL
            MOVE      OUTBB055,D9
            CALL      DISCOD00
            BRANCH    EXIT,VALICD99
          ENDIF
.
          MATCH     Z70,OUTBB057
          IF        !@EQUAL
            MOVE      OUTBB057,D9
            CALL      DISCOD00
            BRANCH    EXIT,VALICD99
          ENDIF
.
          MATCH     Z70,OUTBB059
          IF        !@EQUAL
            MOVE      OUTBB059,D9
            CALL      DISCOD00
            BRANCH    EXIT,VALICD99
          ENDIF
.
          MATCH     Z70,OUTBB061
          IF        !@EQUAL
            MOVE      OUTBB061,D9
            CALL      DISCOD00
            BRANCH    EXIT,VALICD99
          ENDIF
.
          MOVE      ZERO,EXIT
.
VALICD99  RETURN
+
.------------------------------------------------------------
. Validate ICD Code
.------------------------------------------------------------
DISCOD00  MOVE      SP70,WEBERR
.
          MOVE      OBADATE,ICDRDDTE  * Use Booking Date to read ICD file
          UNPACK    D9,D1
          MOVE      D9,KEY9
          CALL      RDPTICD1
          BRANCH    OVRCD,DISCOD99
          COMPARE   ONE,ICDRDVER      * ICD9?
          GOTO      DISCOD99 IF EQUAL * Yes, skip this record
.
          MOVE      ONE,AUTCDFLG      * Auto Coding off
          MOVE      ZERO,SWAPFLG      * Off
          MOVE      ZERO,ECODECNT     * E code counter
          MOVE      DISCODNO,DSCODNO  * Diagnosis Code Sequence Counter
          MOVE      D1,DSCODPFX       * Diagnosis Code Prefix
          MOVE      D9,DSCOD          * Set Var for routine
.
          MOVE      OBADATE,DDATE     * Set up trigger date for ICD Versions
.
          CALL      VDSCD000
          BRANCH    EXIT,DISCOD90
          GOTO      DISCOD99
.
DISCOD90  MATCH     SP70,WEBERR
          IF        !@EQUAL
            MOVE      WEBERR,WEBTITLE
            CALL      WEBERR00
            MOVE      ONE,EXIT
            MOVE      ONE,ERRFLAG
            CALL      UUOTBOA1
          ENDIF
          GOTO      DISCOD99
DISCOD99  RETURN
+
.*******************************************************************************
.                        Patient Instructions
.*******************************************************************************
.         copy the comments back to file - first delete existing comments
.
PATINS00
.         MOVE      "013",KEY3
          PACK      KEY14,OBAOUTNO,KEY3,SP70
          CALL      RSVSCMT1
PATINS40  CALL      RKVSCMT1
          BRANCH    OVRCD,PATINS50          * end of file
          MOVE      OBAOUTNO,DIM8
          MATCH     VSCTVIST,DIM8           * same Admission Number?
          GOTO      PATINS50 IF NOT EQUAL
          MATCH     VSCTTYPE,KEY3
          GOTO      PATINS50 IF NOT EQUAL
.
          PACK      KEY14,VSCTVIST,VSCTTYPE,VSCTLINE
          CALL      DEVSCMT1
          GOTO      PATINS40
.
.         now write the new comments back
.
PATINS50  MOVE      OBAOUTNO,VSCTVIST          * set Admission Number
          MOVE      KEY3,VSCTTYPE
          MOVE      ZERO,F3
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      COMFILBF,COMFILNB
          TRAPCLR   IO
          BRANCH    OVRCD,PATINS99
.
PATINS51  ADD       ONE,F3
          READ      COMFILBF,SEQ;VSCTDATA
.
          MATCH     SP70,VSCTDATA
          IF        @EQUAL
            IF        F3>=OTXWEN2
              GOTO      PATINS99
            ELSE
              GOTO      PATINS51
            ENDIF
          ENDIF
.
          MOVE      F3,VSCTLINE
          PACK      KEY14,VSCTVIST,VSCTTYPE,VSCTLINE
          CALL      WRVSCMT1
          IF        F3>=OTXWEN2
            GOTO      PATINS99
          ENDIF
          GOTO      PATINS51
.
PATINS99  MOVE      ONE,OTXFLA2
          RETURN
+
.--------------------------------------------------------------------
. Insert new Visit Comments - vismdtaf/vismtxaf for ipad appointment.
. The new comments will be will be inserted to the end of the table
. with the next nore number
.--------------------------------------------------------------------
.
NWVCM000  IF        VSCMTFLG <> TWO
            GOTO      NWVCM999
          ENDIF
.
          IF        VSCMTLIN = 0
            GOTO      NWVCM999
          ENDIF
.
          CALL      NXTNOT00
.
          CALL      IBACLOCK
          PACK      CURRDATX,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATX
          CLOCK     TIME,CTIMEIS              * Set created timestamp
.
.         Insert visit comment header
.
NWVCM200  MOVE      OBAOUTNO,KEY8
          MOVE      KEY8,VSMDVISN             * set admission number
          MOVE      VSCMTTYP,VSMDTYPE
          MOVE      NOTENUMB,VSMDNOTE
          MOVE      CURRDATX,VSMDDATE         * Visit date
          MOVE      CTIMEIS,VSMDTIME          * Visit time
          MOVE      USERID,VSMDUSER
.
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          IF        OVRCD = 0
            MOVE      WBSEOCG,VSMDOCCG        * Occupation Group
          ELSE
            MOVE      SP70,VSMDOCCG
          ENDIF
.
          MOVE      ZERO,VSMDDELT
          MOVE      SP70,VSMDDDAT
          MOVE      SP70,VSMDDTIM
          MOVE      SP70,VSMDDUSE
          MOVE      SP70,VSMDDOCC
          MOVE      SP70,VSMDSPAR
.
          CALL      WRVSMDT1
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      COMVISAF,COMVISNM
          TRAPCLR   IO
          BRANCH    OVRCD,NWVCM999
.
.         Insert visit comment details
.
          MOVE      ZERO,F3
          MOVE      F3,VSTXUNIQ
NWVCM400  READ      COMVISAF,SEQ;VSMTCMNT
          GOTO      NWVCM990 IF OVER
.
          ADD       ONE,VSTXUNIQ            * add to line number
.
          MOVE      VSMDVISN,VSMTVISN       * set admission number
          MOVE      VSMDTYPE,VSMTTYPE
          MOVE      VSMDNOTE,VSMTNOTE
          MOVE      VSTXUNIQ,VSMTUNIQ
          MOVE      SP70,VSMTSPAR

          PACK      KEY20,VSMTVISN,VSMTTYPE,VSMTNOTE,VSMTUNIQ,SP70
          CALL      WRVSMTX1
.
          IF        VSTXUNIQ = 99
            GOTO      NWVCM990
          ENDIF
.
          GOTO      NWVCM400
.
NWVCM990  CLOSE     COMVISAF,DELETE
.
NWVCM999  RETURN
+
.---------------------------------------------------------------------
. get the next note number for an admmision number and type.
.---------------------------------------------------------------------
NXTNOT00  MOVE      ONE,NOTENUMB
          MOVE      OBAOUTNO,KEY8
          PACK      KEY17,KEY8,VSCMTTYP,Z70
          CALL      RSVSMDT1                * header record exists?
          CALL      RPVSMDT1
          BRANCH    OVRCD,NXTNOT99
.
          MATCH     KEY8,VSMDVISN
          GOTO      NXTNOT99 IF NOT EQUAL
.
          MATCH     VSCMTTYP,VSMDTYPE
          GOTO      NXTNOT99 IF NOT EQUAL
.
          MOVE      ZERO,FORM6
          MOVE      VSMDNOTE,FORM6
          ADD       ONE,FORM6
          MOVE      FORM6,NOTENUMB
.
NXTNOT99  RETURN
+
.*******************************************************************************
.                            Update Booking Comments
.*******************************************************************************
XWPCOM00  BRANCH    OTXFLAG,XWPCOM90
          PACK      KEY12,OBAOUTNO,SP70
          CALL      RDOTXWP1
XWPCOM10  CALL      RKOTXWP1
          BRANCH    OVRCD,XWPCOM20
.
          MATCH     OBAOUTNO,OTXWOUTN
          GOTO      XWPCOM20 IF NOT EQUAL
.
          PACK      KEY12,OTXWOUTN,OTXWLINE,SP70
          CALL      DEOTXWP1
          CALL      RSOTXWP1
          GOTO      XWPCOM10
.
XWPCOM20  COMPARE   ZERO,OTXWEND
          GOTO      XWPCOM99 IF EQUAL
          MOVE      ZERO,F2
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      COMFILAF, COMFILNM
          TRAPCLR   IO
          BRANCH    OVRCD,XWPCOM99
.
XWPCOM30  READ      COMFILAF,SEQ;COMM127
          GOTO      XWPCOM90 IF OVER
.
          ADD       ONE,F2
          MOVE      OBAOUTNO,OTXWOUTN
          MOVE      F2,OTXWLINE
          PACK      KEY12,OTXWOUTN,OTXWLINE,SP70
          CALL      RDOTXWP1
          IF        OVRCD=1
            MOVE      COMM127,OTXWDESC
            CALL      WROTXWP1
          ENDIF
          COMPARE   F2,OTXWEND
          GOTO      XWPCOM30 IF NOT EQUAL
.
XWPCOM90  CLOSE     COMFILAF,DELETE
.
XWPCOM99  RETURN
+
.-----------------------------------------------------------------
. Insert new Visit Comments - vismdtaf/vismtxaf for pre-admission.
. It first deletes all the comments and then copies them back
.-----------------------------------------------------------------
.
UPVCM000  IF        VSCMTFLG <> 1
            GOTO      UPVCM999
          ENDIF
.
          MOVE      OBAOUTNO,KEY8
          MOVE      VSCMTTYP,KEY3
          CALL      DLVCM000                  * delete visit comments
.
          IF        VSCMTLIN = 0
            GOTO      UPVCM999
          ENDIF
.
          CALL      IBACLOCK
          PACK      CURRDATX,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATX
          CLOCK     TIME,CTIMEIS              * Set created timestamp
.
.         Insert visit comment header
.
UPVCM200  MOVE      OBAOUTNO,KEY8
          MOVE      KEY8,VSMDVISN             * set admission number
          MOVE      VSCMTTYP,VSMDTYPE
          MOVE      ONE,F6
          MOVE      F6,VSMDNOTE
          MOVE      CURRDATX,VSMDDATE         * Visit date
          MOVE      CTIMEIS,VSMDTIME          * Visit time
          MOVE      USERID,VSMDUSER
.
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          IF        OVRCD = 0
            MOVE      WBSEOCG,VSMDOCCG        * Occupation Group
          ELSE
            MOVE      SP70,VSMDOCCG
          ENDIF
.
          MOVE      ZERO,VSMDDELT
          MOVE      SP70,VSMDDDAT
          MOVE      SP70,VSMDDTIM
          MOVE      SP70,VSMDDUSE
          MOVE      SP70,VSMDDOCC
          MOVE      SP70,VSMDSPAR
.
          CALL      WRVSMDT1
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      COMVISAF,COMVISNM
          TRAPCLR   IO
          BRANCH    OVRCD,UPVCM999
.
.         Insert visit comment details
.
          MOVE      ZERO,F3
          MOVE      F3,VSTXUNIQ
UPVCM400  READ      COMVISAF,SEQ;VSMTCMNT
          GOTO      UPVCM990 IF OVER
.
          ADD       ONE,VSTXUNIQ            * add to line number
.
          MOVE      VSMDVISN,VSMTVISN       * set admission number
          MOVE      VSMDTYPE,VSMTTYPE
          MOVE      VSMDNOTE,VSMTNOTE
          MOVE      VSTXUNIQ,VSMTUNIQ
          MOVE      SP70,VSMTSPAR

          PACK      KEY20,VSMTVISN,VSMTTYPE,VSMTNOTE,VSMTUNIQ,SP70
          CALL      WRVSMTX1
.
          IF        VSTXUNIQ = 99
            GOTO      UPVCM990
          ENDIF
.
          GOTO      UPVCM400
.
UPVCM990  CLOSE     COMVISAF,DELETE
.
UPVCM999  RETURN
+
.-----------------------------------------------------------------------
. Delete all visit comments for a given visit type
.-----------------------------------------------------------------------
.
DLVCM000  PACK      KEY17,KEY8,KEY3,SP70
          CALL      RSVSMDT1
DLVCM100  CALL      RKVSMDT1
          BRANCH    OVRCD,DLVCM999
.
          MATCH     KEY8,VSMDVISN       * same Admission Number?
          GOTO      DLVCM999 IF NOT EQUAL
.
          MATCH     VSMDTYPE,KEY3
          GOTO      DLVCM999 IF NOT EQUAL
.
          PACK      KEY17,VSMDVISN,VSMDTYPE,VSMDNOTE,SP70
          CALL      DEVSMDT1
.
          PACK      KEY20,VSMDVISN,VSMDTYPE,VSMDNOTE,SP70
          CALL      RSVSMTX1
DLVCM400  CALL      RKVSMTX1
          BRANCH    OVRCD,DLVCM100          * end of file
.
          MATCH     VSMDVISN,VSMTVISN       * same Admission Number?
          GOTO      DLVCM100 IF NOT EQUAL
.
          MATCH     VSMDTYPE,VSMTTYPE
          GOTO      DLVCM100 IF NOT EQUAL
.
          MATCH     VSMDNOTE,VSMTNOTE
          GOTO      DLVCM100 IF NOT EQUAL
.
          PACK      KEY20,VSMTVISN,VSMTTYPE,VSMTNOTE,VSMTUNIQ,SP70
          CALL      DEVSMTX1
          GOTO      DLVCM400
.
DLVCM999  RETURN
+
.------------------------------------------------------------
. Check for CMBS items
.------------------------------------------------------------
CMBS0000  COMPARE   ONE,CMBSFLAG             * check if any cmbs items updated
          GOTO      CMBS9999 IF NOT EQUAL
.
          PACK      KEY16,OBAOUTNO,Z70
          CALL      RSHCCLM2
          CALL      RPHCCLM2                * check for hic claim record
          BRANCH    OVRCD,CMBS0200
.
          MATCH     DOBAOUTN,HCCLVISN
          GOTO      CMBS0200 IF NOT EQUAL   * Different visit number
.
          MATCH     " 1",HCCLSTAT
          GOTO      CMBS9999 IF EQUAL       * don't post if batched claim exists
.
CMBS0200  PACK      KEY10,OBAOUTNO,SP10
          CALL      RSOTBIT1
          CALL      RKOTBIT1
          BRANCH    OVRCD,CMBS1000
          MATCH     DOBAOUTN,OTBIVISN
          GOTO      CMBS1000 IF NOT EQUAL    * Different visit number
.
          PACK      KEY10,OTBIVISN,OTBIITMC
          CALL      DEOTBIT1
          GOTO      CMBS0200
.
CMBS1000  MOVE      ZERO,F2
          MOVE      ZERO,FORM2
          MOVE      OBAOUTNO,OTBIVISN         * Visit number
.
CMBS1200  COMPARE   FIVE,F2
          GOTO      CMBS9999 IF EQUAL         * reach maximum of 5 MBS items
          ADD       ONE,F2
          LOAD      OTBIIFLG,F2,OTBIT001,OTBIT004,OTBIT007,OTBIT010,OTBIT013
.
          MATCH     Z70,OTBIIFLG
          GOTO      CMBS1200 IF EQUAL
.
          MATCH     SP70,OTBIIFLG
          GOTO      CMBS1200 IF EQUAL
.
          LOAD      OTBIITMN,F2,OTBIT002,OTBIT005,OTBIT008,OTBIT011,OTBIT014
          LOAD      OTBISUBN,F2,OTBIT003,OTBIT006,OTBIT009,OTBIT012,OTBIT015
          LOAD      OTBIPUSE,F2,OTBIT016,OTBIT017,OTBIT018,OTBIT019,OTBIT020
.
          MATCH     SP70,OTBIITMN
          GOTO      CMBS1200 IF EQUAL
.
          MATCH     Z70,OTBIITMN
          GOTO      CMBS1200 IF EQUAL
.
          ADD       ONE,FORM2
          MOVE      FORM2,OTBIITMC
.
          MOVE      OBADATE,OTBIDATE
          MOVE      OBAURNO,OTBIURNO
          MOVE      "0",OTBISTAT
          UNPACK    SP70,OTBICDAT,OTBICTIM,OTBICUID
          UNPACK    SP70,OTBIUDAT,OTBIUTIM,OTBIUUID
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          PACK      KEY10,OTBIVISN,OTBIITMC
          CALL      RAOTBIT1
          IF        OVRCD=1
            MOVE      KEY8,OTBICDAT             * date created
            CLOCK     TIME,OTBICTIM             * time created
            MOVE      USERID,OTBICUID           * web user id
            CALL      WROTBIT1
          ELSE
            MOVE      KEY8,OTBIUDAT             * date updated
            CLOCK     TIME,OTBIUTIM             * time updated
            MOVE      USERID,OTBIUUID           * web user id
            CALL      UPOTBIT1
          ENDIF
          GOTO      CMBS1200
.
CMBS9999  RETURN
+
.*******************************************************************************
.  PRAD0000  :  Write the Person Responsible for Account Details for RCH
.*******************************************************************************
PRAD0000  CALL      CINS0000                    * Check Claim insurance details
          BRANCH    OVRCD,PRAD0200
.
          GOTO      PRAD9500
.
PRAD0200  MOVE      ZERO,F1
          MOVE      PMPXCONP,F1
          BRANCH    F1,PRAD1000,PRAD2000,PRAD3000,PRAD4000,PRAD5000
.
. patient is responsible for account
.
          MOVE    PTMASNAM,PACSNAMX
          MOVE    PGNAME,ANS
          PACK    PACGNAME,ANS,DOT
          MOVE    PTITL,PACTITLE
          MOVE    THREE,PACFRMT
          CALL    PACNAME
.
          MOVE    OBAOUTNO,PKADMN
          MOVE    PACFNAMX,PKNAME
          MOVE    PADD1,PKADD1
          MOVE    PADD2,PKADD2
          MOVE    PSUBRB,PKSUBR
          MOVE    PADD4,PKADD4
          MOVE    PPOST,PKPOST
          MOVE    PTELEP,PKTELEP
          MOVE    PTELEB,PKTELEB
          MOVE    "SELF      ",PKRELP
.
          CALL    PARN0000                  * Check for 'Parent of'
.
          GOTO    PRAD7000
.
. contact 1 is responsible for account
.
PRAD1000  MOVE    OBAOUTNO,PKADMN
          MOVE    PMPXMSNA,PACSNAMX
          MOVE    PMPXMGNA,ANS
          PACK    PACGNAME,ANS,DOT
          MOVE    PMPXMTLE,PACTITLE
          MOVE    THREE,PACFRMT
          CALL    PACNAME
.
          MOVE    PACFNAMX,PKNAME
          MOVE    PMPXMAD1,PKADD1
          MOVE    PMPXMAD2,PKADD2
          MOVE    PMPXMAD3,PKSUBR
          MOVE    PMPXMAD4,PKADD4
          MOVE    PMPXMPOS,PKPOST
          MOVE    PMPXMPNO,PKTELEP
          MOVE    PMPXMBNO,PKTELEB
          MOVE    PMPXMREL,PKRELP
.
          GOTO    PRAD7000
.
. contact 2 is responsible for account
.
PRAD2000  MOVE    OBAOUTNO,PKADMN
          MOVE    PMPXFSNA,PACSNAMX
          MOVE    PMPXFGNA,ANS
          PACK    PACGNAME,ANS,DOT
          MOVE    PMPXFTLE,PACTITLE
          MOVE    THREE,PACFRMT
          CALL    PACNAME
.
          MOVE    PACFNAMX,PKNAME
          MOVE    PMPXFAD1,PKADD1
          MOVE    PMPXFAD2,PKADD2
          MOVE    PMPXFAD3,PKSUBR
          MOVE    PMPXFAD4,PKADD4
          MOVE    PMPXFPOS,PKPOST
          MOVE    PMPXFPNO,PKTELEP
          MOVE    PMPXFBNO,PKTELEB
          MOVE    PMPXFREL,PKRELP
.
          GOTO    PRAD7000
.
. contact 3 is responsible for account
.
PRAD3000  MOVE    OBAOUTNO,PKADMN
          MOVE    PNKNAME,PKNAME
          MOVE    PNKADD1,PKADD1
          MOVE    PNKADD2,PKADD2
          MOVE    PNKSUBR,PKSUBR
          MOVE    PNKADD4,PKADD4
          MOVE    PNKPOST,PKPOST
          MOVE    PNKTELP,PKTELEP
          MOVE    PNKTELB,PKTELEB
          MOVE    PNKRELP,PKRELP
.
          GOTO    PRAD7000
.
. contact 4 is responsible for account
.
PRAD4000  MOVE    OBAOUTNO,PKADMN
          MOVE    PTMXECNM,PKNAME
          MOVE    PTMXECA1,PKADD1
          MOVE    PTMXECA2,PKADD2
          MOVE    PTMXECA3,PKSUBR
          MOVE    PTMXECA4,PKADD4
          MOVE    PTMXECPC,PKPOST
          MOVE    PTMXECPP,PKTELEP
          MOVE    PTMXECBP,PKTELEB
          MOVE    PTMXECRE,PKRELP
.
          GOTO    PRAD7000
.
. contact 5 is responsible for account
.
PRAD5000  MOVE    OBAOUTNO,PKADMN
          MOVE    PTMXNRNM,PKNAME
          MOVE    PTMXNRA1,PKADD1
          MOVE    PTMXNRA2,PKADD2
          MOVE    PTMXNRA3,PKSUBR
          MOVE    PTMXNRA4,PKADD4
          MOVE    PTMXNRPC,PKPOST
          MOVE    PTMXNRPP,PKTELEP
          MOVE    PTMXNRBP,PKTELEB
          MOVE    PTMXNRRE,PKRELP
.
          GOTO    PRAD7000
.
PRAD7000  PACK    KEY8,OBAOUTNO,SP10
          CALL    RDARESP1
          IF      OVRCD=1
            CALL    WRRESP1
          ELSE
            CALL    UPRESP1
          ENDIF
.
PRAD9500  MOVE      ZERO,EXIT
.
PRAD9999  RETURN
+
.***********************************************************************
.*        Check Insurance details for the Claim code
.***********************************************************************
CINS0000  CALL      PRFAINSR              * Copy Claim Insurance details to PRFA
          BRANCH    OVRCD,CINS9999
.
          MOVE      OBAOUTNO,PKADMN
          PACK      KEY8,OBAOUTNO,SP10
          CALL      RDARESP1
          IF        OVRCD=1
            CALL      WRRESP1
          ELSE
            CALL      UPRESP1
          ENDIF
          MOVE      ZERO,OVRCD
.
CINS9999  RETURN
+
.***********************************************************************
.        Check for Using 'Parent of' option
.***********************************************************************
PARN0000 COMPARE   ONE,PTCNPAOF              * Using 'Parent of' option?
         GOTO      PARN9999 IF NOT EQUAL     * no
.
         PACK      AGEDATE,CCC,CYY,CMM,CDD
         CALL      CALCAGE                   * CALCAGE uses PBDATE
         COMPARE   PSAGEYRS,PTCNAGEC         * Child?
         GOTO      PARN9999 IF LESS          * No
.
         UNPACK    PGNAME,ANS
         PACK      PKNAME,SP70,SP10
         CLEAR     PKNAME
         APPEND    "Parent of ",PKNAME
         APPEND    ANS,PKNAME
         APPEND    DOT,PKNAME
         APPEND    SP1,PKNAME
         APPEND    PTMASNAM,PKNAME
         APPEND    SP70,PKNAME
         APPEND    SP10,PKNAME
         RESET     PKNAME
         MOVE      "Parent    ",PKRELP
.
PARN9999 RETURN
+
.*******************************************************************************
.                Delete pending/rescheduled patient instructions
.*******************************************************************************
DELVCM00  MOVE      "014",KEY3
          PACK      KEY14,OTAROOBN,KEY3,SP70
          CALL      RSVSCMT1
DELVCM10  CALL      RKVSCMT1
          BRANCH    OVRCD,DELVCM99          * end of file
          MATCH     VSCTVIST,OTAROOBN
          GOTO      DELVCM99 IF NOT EQUAL
          MATCH     VSCTTYPE,KEY3
          GOTO      DELVCM99 IF NOT EQUAL
.
          PACK      KEY14,VSCTVIST,VSCTTYPE,VSCTLINE
          CALL      DEVSCMT1
          GOTO      DELVCM10
.
DELVCM99  RETURN
+
.------------------------------------------------------------------------------
. Default AH referrals claim details to OP booking if booked from an AH referral
.------------------------------------------------------------------------------
RCLM0000  MATCH     "1",PTCNXCOM            * Using extra compensable details
          GOTO      RCLM9999 IF NOT EQUAL
.
          PACK      KEY11,ALREVISN,OBACOMP,SP70
          CALL      RDPMEXT1                     * Copy compensable details
          BRANCH    OVRCD,RCLM9999               * from AH to OP if same claim
.                                                * code
          MOVE      OBAOUTNO,PMEXVISN
.
          PACK      KEY11,PMEXVISN,PMEXCLAM,SP70
          CALL      RAPMEXT1
          IF        OVRCD=1
            MOVE      OBADATE,PMEXVDAT
            CALL      WRPMEXT1
          ENDIF
.
RCLM9999  RETURN
+
.*******************************************************************************
. Update the referral expiry date if required
.*******************************************************************************
REFX0000  MATCH     SP70,ALREREXP                 * Exit if the referral expiry
          GOTO      REFX9999 IF NOT EQUAL         * date is populated
.
          MATCH     SP70,ALRERTYP                 * No referral type
          GOTO      REFX9999 IF EQUAL
.
          PACK      KEY5,ANSR,ANSI,ALRERTYP,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,REFX9999
.
          COMPARE   ZERO,TCFORM6                  * No days for expiry warning
          GOTO      REFX9999 IF EQUAL
.
          IF        EPAUDFLG = 0
            MOVE      TWO,AUDTTYPE            * before history record
            CALL      WAALRE00
.
.           Set flag to indicate that a before audit record has been written
.
            MOVE      ONE,EPAUDFLG
          ENDIF
.
          PACK      ALREUDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALREUDAT
          CLOCK     TIME,ALREUTIM
          MOVE      USERID,ALREUUID
          MOVE      OBADATE,BOOKDATE
          CALL      CALX0000                      * calculate expiry date
.
          CALL      UPALREF1
.
          CALL      PMIGTNID             * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      FORTY4,HL7TRGID
          MOVE      SP8,HL7INCLD
          CALL      DGCLII13             * broadcast Update Ref. (REF^I13)
.
REFX9999  RETURN
+
.------------------------------------------------------------
. Calculate referral expiry date if required
.------------------------------------------------------------
CALX0000  MATCH     SP70,ALRERTYP           * No referral type
          GOTO      CALX9999 IF EQUAL
.
          MATCH     SP70,BOOKDATE           * No booking date
          GOTO      CALX9999 IF EQUAL
.
          PACK      KEY5,ANSR,ANSI,ALRERTYP,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CALX9999
.
          COMPARE   ZERO,TCFORM6            * No days for expiry warning
          GOTO      CALX9999 IF EQUAL
.
          MOVE      BOOKDATE,EXPRDATE
          ADD       TCFORM6,EXPRDATE
          MOVE      EXPRDATE,ALREREXP
.
CALX9999  RETURN
+
ADJNEW00  IF        NEWSLOTS<=0
            GOTO      ADJNEW99
          ENDIF
          MOVE      ZERO,LOCKCNT
.
ADJNEW10  PACK      KEY25,NEWSLOTK,SP70      * Key for selected booking
          CALL      RLOTSES1
          BRANCH    OVRCD,ADJNEW99,ADJNEW90
          SUB       NEWSLOTS,OSESLOTB
          CALL      UPSESA1
          CALL      UUOTSES1
          GOTO      ADJNEW99
.
ADJNEW90  DISPLAY   *W
          ADD       ONE,LOCKCNT
          IF        LOCKCNT<10
            GOTO      ADJNEW10
          ENDIF
ADJNEW99  RETURN
+
ADJOLD00  IF        OLDSLOTS<=0
            GOTO      ADJOLD99
          ENDIF
          MOVE      ZERO,LOCKCNT
.
ADJOLD10  PACK      KEY25,NEWSLOTK,SP70      * Key for selected booking
          CALL      RLOTSES1
          BRANCH    OVRCD,ADJOLD99,ADJOLD90
          ADD       OLDSLOTS,OSESLOTB
          CALL      UPSESA1
          CALL      UUOTSES1
          GOTO      ADJOLD99
.
ADJOLD90  DISPLAY   *W
          ADD       ONE,LOCKCNT
          IF        LOCKCNT<10
            GOTO      ADJOLD10
          ENDIF
ADJOLD99  RETURN
+
.------------------------------------------------------------
. Get Slot Count from Code File
.------------------------------------------------------------
GETSCT00  MOVE      ONE,CNTSLOTS
          MOVE      "CV",CATEGORY
          PACK      KEY5,CATEGORY,CODE
          CALL      RDCODE1
          BRANCH    OVRCD,GETSCT99
          IF        TCFORM6=0
            MOVE      ONE,TCFORM6
          ENDIF
          MOVE      TCFORM6,CNTSLOTS
GETSCT99  RETURN
+
.---------------------------------------------------
. Increment Booking Count on Session
.---------------------------------------------------
ADDBOK00  MOVE      ZERO,LOCKCNT
          MOVE      "CV",KEY2
          PACK      KEY5,KEY2,OBAVISIT
          CALL      RDCODE1
          BRANCH    OVRCD,ADDBOK98
          IF        TCFORM6=0
            MOVE      ONE,TCFORM6
          ENDIF
.
ADDBOK10  PACK      KEY25,SESSKEYS,SP70
          CALL      RLOTSES1
          BRANCH    OVRCD,ADDBOK98,ADDBOK90
          ADD       TCFORM6,OSESLOTB
          MATCH     ANSN,TCINDC1
          IF        @EQUAL
            ADD       ONE,OSEBNEW
          ENDIF
          MATCH     ANSR,TCINDC1
          IF        @EQUAL
            ADD       ONE,OSEBRV
          ENDIF
          MATCH     ANSS,TCINDC1
          IF        @EQUAL
            ADD       ONE,OSEBSPC
          ENDIF
          CALL      RDSLT000
          CALL      ADDTIM00
          CALL      UPSESA1
          CALL      UUOTSES1
          MOVE      ZERO,EXIT
          GOTO      ADDBOK99
ADDBOK90  DISPLAY   *W
          ADD       ONE,LOCKCNT
          IF        LOCKCNT<5
            GOTO      ADDBOK10
          ENDIF
ADDBOK98  MOVE      ONE,EXIT
ADDBOK99  RETURN
+
.---------------------------------------------------
. Reduce Booking Count on Session
.---------------------------------------------------
SUBBOK00  MOVE      ZERO,LOCKCNT
          MOVE      "CV",KEY2
          PACK      KEY5,KEY2,OBAVISIT
          CALL      RDCODE1
          BRANCH    OVRCD,SUBBOK98
          IF        TCFORM6=0
            MOVE      ONE,TCFORM6
          ENDIF
.
SUBBOK10  PACK      KEY25,SESSKEYS,SP70
          CALL      RLOTSES1
          BRANCH    OVRCD,SUBBOK98,SUBBOK90
          SUB       TCFORM6,OSESLOTB
          MATCH     ANSN,TCINDC1
          IF        @EQUAL
            SUB       ONE,OSEBNEW
          ENDIF
          MATCH     ANSR,TCINDC1
          IF        @EQUAL
            SUB       ONE,OSEBRV
          ENDIF
          MATCH     ANSS,TCINDC1
          IF        @EQUAL
            SUB       ONE,OSEBSPC
          ENDIF
          CALL      RDSLT000
          CALL      SUBTIM00
          CALL      UPSESA1
          CALL      UUOTSES1
          MOVE      ZERO,EXIT
          GOTO      SUBBOK99
SUBBOK90  DISPLAY   *W
          ADD       ONE,LOCKCNT
          IF        LOCKCNT<5
            GOTO      SUBBOK10
          ENDIF
SUBBOK98  MOVE      ONE,EXIT
SUBBOK99  RETURN
+
.------------------------------------------------------------
. Get default claim details from previous visit
.------------------------------------------------------------
LCLM0000  MATCH     SP3,KEY3
          GOTO      LCLM7000 IF EQUAL       * no claim code
.
          MATCH     ANSN,PTCNLCLM
          GOTO      LCLM9999 IF EQUAL
.
.         Set the claim type indicator if this is a claim
.
          PACK      KEY5 WITH ANSC,ANSL,KEY3
          CALL      RDCODE1
          BRANCH    OVRCD OF LCLM7000
.
.         Check the indicators for a W, M, or V (these are the claims)
.
          MOVE      ZERO,FORM2
LCLM3000  ADD       ONE,FORM2
          COMPARE   SIX,FORM2
          GOTO      LCLM7000 IF NOT LESS
.
          LOAD      ANS USING FORM2 OF TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
          CMATCH    "W",ANS
          GOTO      LCLM4000 IF EQUAL
          CMATCH    "M",ANS
          GOTO      LCLM5000 IF EQUAL
          GOTO      LCLM3000
.
.         We have a workers comp. claim, get the previous workers comp details
.
LCLM4000  OPEN     PATWC1A1,"patwc1af"
          OPEN     PATWC1A2,"patwc1af"
          PACK     KEY16,URNUMBER,Z70
          CALL     RDSWCOM2
LCLM4100  CALL     RDPWCOM2
          BRANCH   OVRCD,LCLM7000
          MATCH    PTWCURNO,URNUMBER
          GOTO     LCLM7000 IF NOT EQUAL
.
          MATCH    ANSI,PTCNLCLM           * Check inpatient visit only
          GOTO     LCLM4200 IF NOT EQUAL   * Any visit
.
          MOVE     WCADMNO,KEY8
          CALL     RDVISA1
          BRANCH   OVRCD,LCLM4100
.
          COMPARE  THREE,PVITYPE
          GOTO     LCLM4100 IF NOT EQUAL   * get next visit
.
LCLM4200  MOVE     WCADMNO,KEY8
          CALL     RDPMWX11           * read ext.workers comp file(prev adm)
.
          MOVE     OBAOUTNO,WCADMNO   * current outpatient number
          MOVE     WCADMNO,KEY8
          CALL     RDAWCOM1
          IF       OVRCD=1
            MOVE     OBADATE,PTWCVDAT
            MOVE     OBAURNO,PTWCURNO
            CALL     WRWCOM1          * write workers comp file
.
.           If we are sending ACC details in PV1-20, then we need to
.           trigger an A08 message for the visit to reflect that this is
.           now an ACC patient
.
            MATCH     "1",PTCNH7AC
            IF        @EQUAL
              CALL      PMIGTNID               * get national id for dgate write
              MOVE      NMPNUMB,PTNINMPI
              MOVE      SIX,HL7TRGID
              MOVE      SP8,HL7INCLD
              PROC      DGCLICOB                * send update O/P details
            ENDIF
          ENDIF
.
          MOVE     OBAOUTNO,PMWXVISN
          CALL     RAPMWX11
          IF       OVRCD=1
            CALL     WRPMWX11         * write extension workers comp file
          ENDIF
.
          GOTO     LCLM9999
.
.         We have a motors accident claim, get the previous workers comp details
.
LCLM5000  OPEN     PATWMAB1,"patwmabf"
          OPEN     PATWMAB2,"patwmabf"
          PACK     KEY16,URNUMBER,Z70
          CALL     RDSWMAB2           * read claim details for previous visit
LCLM5100  CALL     RDPWMAB2
          BRANCH   OVRCD,LCLM7000
          MATCH    PTWMURNO,URNUMBER
          GOTO     LCLM7000 IF NOT EQUAL
.
          MATCH    ANSI,PTCNLCLM           * Check inpatient visit only
          GOTO     LCLM5200 IF NOT EQUAL   * Any visit
.
          MOVE     MADMNO,KEY8
          CALL     RDVISA1
          BRANCH   OVRCD,LCLM5100
.
          COMPARE  THREE,PVITYPE
          GOTO     LCLM5100 IF NOT EQUAL   * get next visit
.
LCLM5200  MOVE     OBAOUTNO,MADMNO    * current outpatient number
          MOVE     OBAOUTNO,KEY8
          CALL     RDAWMAB1
          IF       OVRCD=1
            MOVE     OBADATE,PTWMVDAT
            MOVE     OBAURNO,PTWMURNO
            CALL     WRWMAB1          * write workes comp file
          ENDIF
          GOTO     LCLM9999
.
LCLM7000  CALL      CLRCLM00
LCLM9999  RETURN
+
.------------------------------------------------------------
.     Clear Claim Details
.------------------------------------------------------------
CLRCLM00  MOVE      SP70,WCENAME
          MOVE      SP70,WCEADD1
          MOVE      SP70,WCEADD2
          MOVE      SP70,WCEADD3
          MOVE      SP70,WCEADD4
          MOVE      SP70,WCEPOST
          MOVE      SP70,WCETELE
          MOVE      SP70,WCACDAT
          MOVE      SP70,WCACCPT
          MOVE      SP70,WCICODE
          MOVE      ZERO,WCCLMNO
.
          MOVE      SP70,VCLMNO
.
          MOVE      ZERO,PTWMTACF
          MOVE      SP70,PTWMTYPE
          MOVE      SP70,MREFNO
          MOVE      SP70,MACDAT
          MOVE      SP70,MPOLIC
          MOVE      SP70,MCREGO
          MOVE      SP70,MOTHDET1
          MOVE      SP70,MOTHDET2
          MOVE      SP70,MOTHDET3
          MOVE      SP70,MMDTRANS
          MOVE      SP70,MENGAGED
          MOVE      SP70,MPINJURE
          MOVE      SP70,MMECHSEV
          MOVE      SP70,MREGNSEV
          MOVE      SP70,MSNAME
          MOVE      SP70,MSTELE
          MOVE      SP70,MACLOC
          MOVE      SP70,PMWXVISN           * Visit Number
          MOVE      SP70,PMWXALOC           * Accident Location
          MOVE      SP70,PMWXCINJ           * of Injury (Cat IK)
          MOVE      SP70,PMWXICOD           * Injury Code (Cat IJ)
          MOVE      SP70,PMWXCNAM           * Contact Name
          MOVE      SP70,PMWXECOD           * Employer code
          MOVE      SP70,PMWXCDTE           * Date Record Created (ccyymmdd)
          MOVE      SP70,PMWXCTIM           * Time Record Created (hh:mm:ss)
          MOVE      SP70,PMWXWEBC           * WEB User Id rec. creator(websecaf)
          MOVE      SP70,PMWXLUPD           * Last Update Date (ccyymmdd)
          MOVE      SP70,PMWXLUPT           * Last Update Time (hh:mm:ss)
          MOVE      SP70,PMWXWEBU           * WEB User Id rec. updater(websecaf)
          MOVE      SP70,PMWXSPAR           * Spare Variable
CLRCLM99  RETURN
+
.*******************************************************************************
.            REAP0000: Generate and post a new outpatient number
.*******************************************************************************
REAP0000  COMPARE   ONE,BOOKFLAG            * Booking from a referral letter
          IF        @EQUAL
            MOVE      ADMISSNO,OPROUTN      * Use admission number from the
            PACK      KEY8,OPROUTN          * Key for visit file
            CALL      RDVISA1               * Check if visit record exists
            COMPARE   ZERO,OVRCD            * Does this record exist ?
            GOTO      REAP9030 IF EQUAL     * Yes. Try again
.
            PACK      KEY8,OPROUTN          * Key for pre-attendance file
            CALL      RDPREA1               * Check if record already exists
            COMPARE   ZERO,OVRCD            * Does this record exist ?
            GOTO      REAP9030 IF EQUAL     * Yes. Try again
.
            PACK      KEY8,OPROUTN          * Key for bokb file
            CALL      RDABOKB1
            COMPARE   ZERO,OVRCD            * Does this record exist ?
            GOTO      REAP9030 IF EQUAL     * Yes. Try again
.
            GOTO      REAP0700              * referral letter
          ENDIF
.
          COMMIT
          BEGIN
.
          READ      CONTROLF,HUND30;*75,PTCNUANV      * Using AN Visit Numbers
.
          MATCH     "1",PTCNUANV
          IF        @EQUAL
            CALL      GANV0000                * Get next AN visit number
            MOVE      PTCNNXTV,OPROUTN
          ELSE
            MOVE      " 10",PRXCODE
            CALL      GETSLK00
            READ      CONTROLF,TEN;*1,FORM8V  * Get the next Outpatient number
            ADD       ONE,FORM8V              * Increment next Outpatient No.
            WRITAB    CONTROLF,TEN;*1,FORM8V  * Post new outpatient no
            SUB       ONE,FORM8V              * Go back to original O/P Number
            MOVE      FORM8V,OPROUTN
            CALL      RELSLK00
          ENDIF
.
          COMMIT
          BEGIN
.
REAP0500  PACK      KEY8,OPROUTN             * Key for visit file
          CALL      RDVISA1                  * Check if visit record exists
          COMPARE   ZERO,OVRCD               * Does this record exist ?
          GOTO      REAP0000 IF EQUAL        * Yes. Try again
.
          PACK      KEY8,OPROUTN             * Key for pre-attendance file
          CALL      RDPREA1                  * Check if record already exists
          COMPARE   ZERO,OVRCD               * Does this record exist ?
          GOTO      REAP0000 IF EQUAL        * Yes. Try again
.
          PACK      KEY8,OPROUTN             * Key for bokb file
          CALL      RDABOKB1
          COMPARE   ZERO,OVRCD               * Does this record exist ?
          GOTO      REAP0000 IF EQUAL        * Yes. Try again
.
.         We have a valid outpatient number. Post the Boka data
.
REAP0700  PACK      KEY28,NEWSLOTK,SP70      * Key for selected booking
          CALL      RDBOKA1                  * Read in the booking record
          BRANCH    OVRCD,REAP9020
.
.         Update this record with the booking data
.
          COMPARE   ZERO,OBASTAT             * Make sure record isn't booked
          GOTO      REAP1000 IF EQUAL
          COMPARE   NINE,OBASTAT             * Make sure record isn't booked
          GOTO      REAP9010 IF NOT EQUAL    * Record isn't vacant !!
.
          MOVE      NEWSLOTK,KEY28
          CALL      RDOTSRV1
          IF        OVRCD=0
            MATCH     USERID,OTSRWEBU
            GOTO      REAP9020 IF NOT EQUAL * Record is locked by another
            CALL      DEOTSRV1
          ENDIF
.
REAP1000  MOVE      OPROUTN,OBAOUTNO         * Outpatient number
          MATCH     ZEROVISN,OBAOUTNO
          GOTO      REAP9040 IF EQUAL
.
          MATCH     SP70,URNUMBER
          IF        @EQUAL
            MOVE      "       0",URNUMBER
            CALL      WRTZUR00
          ENDIF
          MOVE      URNUMBER,OBAURNO         * U/R Number
          MOVE      ONE,OBASTAT              * Status = Booked
          MOVE      ZERO,OBAPULL             * Clear pulling list flag
          CLOCK     TIME,CTIMEIS             * Get the current time
          PACK      OBABKDTE,CCC,CYY,CMM,CDD,CTIMEIS
          REP       " 0",OBABKDTE            * Zero-fill booking date/time
          CALL      UPBOKA1
.
          PACK      SESSKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      ADDBOK00                 * Increment Booking Count
.
          CALL      PPRE0000                 * Updating the pre-attend file data
.
          MOVE      ZERO,REVWFLAG
          CALL      REVD0000                 * Update waiting list review date
.
          CALL      CHRT0000                 * Clear send letter if chart review
.
          PACK      KEY8,OBAOUTNO,SP70       * Key for bokb file
          CALL      RDABOKB1                 * Write the bokb record
          IF        OVRCD=1
            MOVE      LINKOUTN,OBALADMN
            MOVE      OBACTYP,OBBCTYP        * Store Clinic Type (SRF 103335)
            MOVE      SP10,OTBBADCS
            MOVE      SP10,OTBBCITM
            MOVE      SP10,OTBBASTM
            MOVE      SP10,OTBBDPTM
            MOVE      SP10,OTBBOUTC
            MOVE      SP70,OTBBCIND          * Clear before write
            MOVE      SP70,OBAATTN           * Attendance code
            MOVE      SP70,OTBBHCP1
            MOVE      SP70,OTBBHCP2
            MOVE      SP70,OTBBHCP3
            MOVE      SP70,OTBBHCP4
.
            IF        UPDATETY=2
              MATCH     Z70,OUTBB066
              IF        !@EQUAL
                MOVE      OUTBB066,OTBBGLDT
              ENDIF
.
              MATCH     Z70,OUTBB067
              IF        !@EQUAL
                MOVE      OUTBB067,OTBBSNGL
              ENDIF
            ENDIF
.
            CALL      WRBOKB1
            CALL      WRCPAT00           * write to current patient file
.
            MATCH     "1",PTCNXCOM       * if using Extra Compensation
            IF        @EQUAL
              MATCH     Z70,OUTBB002
              IF        !@EQUAL
                MOVE      OUTBB002,OBACOMP
              ENDIF
              CALL      CPRA0000         * check if we need to update PRFA
            ELSE
              MOVE      SP70,KEY3
              MATCH     Z70,OUTBB002
              IF        !@EQUAL
                MOVE      OUTBB002,KEY3
                CALL      PRAD0000       * write to person responsible file
              ENDIF
            ENDIF
          ENDIF
.
          IF        REPORTNO=4 & UPDATETY=4
            GOTO      REAP2000              * Skip if follow up booking
          ENDIF
.
          IF        REPORTNO <> 6
            CALL      PMIGTNID              * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      TEN1,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICON              * DG API O/P New Appoint.
          ENDIF
.
REAP2000  IF        REPORTNO <> 6
            CALL      WRAP0000
          ENDIF
.
          MATCH     OLDVTYP,NEWVTYP
          GOTO      REAP8900 IF EQUAL
.
          CALL      EXTSLT00
          GOTO      REAP8900
.
.REAP7000  PACK      KEY28,NEWSLOTK,SP70      * Key for selected booking
.          CALL      RDBOKA1                  * Read in the booking record
.          MOVE      OBASLOT,PARNSLOT
.REAP8000  CALL      RDKBOKA1                 * Check the next record
.          BRANCH    OVRCD,REAP8900           * Finished
.          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT
.          MATCH     KEY25,NEWSLOTK         * Correct session ?
.          GOTO      REAP8900 IF NOT EQUAL    * No. Finished
.          COMPARE   THREE,OBASTAT            * Is this an extended slot ?
.          GOTO      REAP8900 IF NOT EQUAL    * No. Finished
.          COMPARE   OBAEXSL,PARNSLOT
.          GOTO      REAP8900 IF NOT EQUAL    * No. Finished
..
.          MOVE      OPROUTN,OBAOUTNO         * Outpatient number
.          MOVE      URNUMBER,OBAURNO         * U/R Number
.          CALL      UPBOKA1                  * Update this record
.
.          GOTO      REAP8000                 * Check for another extended slot
.
.         Finished update. Re-read the original record to make sure
.         variables such as OBAOUTNO and OBAURNO contain the correct data
.
REAP8900  PACK      KEY28,NEWSLOTK,SP70      * Key for selected booking
          CALL      RDBOKA1                  * Read in the booking record
          MOVE      ZERO,EXIT
          GOTO      REAP9999                * Finished posting data
.
.         Booking record has the wrong status
.
REAP9010  MOVE      "Booking Record has wrong status.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      REAP9999                * Finished posting data
.
REAP9020  MOVE      "New Booking Record not Available.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      REAP9999                * Finished posting data
.
REAP9030  MOVE      "Invalid Booking Status for Referral Letter.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      REAP9999                * Finished posting data
.
REAP9040  MOVE      "New Booking has a Zero Visit Number.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      REAP9999                * Finished posting data
.
REAP9999  COMMIT
          BEGIN
          RETURN
+
.------------------------------------------------------------
. Extend Slots
.  Input - NEWVTYP New Visit Type
.          OLDVTYP old Visit Type
.          NEWSLOTK - Slot Key
.------------------------------------------------------------
EXTSLT00  MOVE      NEWVTYP,CODE
          CALL      GETSCT00   * Get Slot Count
          MOVE      CNTSLOTS,NEWSLOTS
.
          MOVE      OLDVTYP,CODE
          CALL      GETSCT00   * Get Slot Count
          MOVE      CNTSLOTS,OLDSLOTS
.
          PACK      KEY28,NEWSLOTK,SP70      * Key for selected booking
          CALL      RDBOKA1                  * Read in the booking record
          MOVE      NEWVTYP,OBAVISIT         * Update to New Visit Type
          CALL      UPBOKA1
          SUB       ONE,OLDSLOTS
          SUB       ONE,NEWSLOTS
.
          MOVE      OBASLOT,PARNSLOT         * Set Parent Slot
.
EXTSLT10  CALL      RDKBOKA1                 * Check the next record
          BRANCH    OVRCD,EXTSLT90           * Finished
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT
          MATCH     KEY25,NEWSLOTK         * Correct session ?
          GOTO      EXTSLT90 IF NOT EQUAL    * No. Finished
          COMPARE   ZERO,NEWSLOTS
          GOTO      EXTSLT30 IF EQUAL
.
          MATCH     OLDVTYP,OBAVISIT
          IF        !@EQUAL
            MOVE      OBAVISIT,CODE          * Check Slot is not Extended
            CALL      GETSCT00               * Get Slot Count
            COMPARE   ONE,CNTSLOTS           * Exit if This Slot Extended
            GOTO      EXTSLT90 IF NOT EQUAL
          ENDIF
.
          MATCH     ANSU,TCINDC6
          GOTO      EXTSLT90 IF EQUAL        * Ignore unavailable slots
.
          MATCH     ANSZ,TCINDC2
          GOTO      EXTSLT90 IF EQUAL        * Ignore over bookings slots
.
          MATCH     ZEROVISN,OBAOUTNO        * Outpatient number
          GOTO      EXTSLT90 IF NOT EQUAL    * Exit if Slot has Booking
.
          SUB       ONE,OLDSLOTS
          SUB       ONE,NEWSLOTS
          MOVE      THREE,OBASTAT            * Update as Extended Slot
          MOVE      NEWVTYP,OBAVISIT
          MOVE      PARNSLOT,OBAEXSL
          CALL      UPBOKA1
          GOTO      EXTSLT10
.
EXTSLT20  CALL      RDKBOKA1     * Read Next Slot
          BRANCH    OVRCD,EXTSLT90
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT
          MATCH     KEY25,NEWSLOTK          * Correct session ?
          GOTO      EXTSLT90 IF NOT EQUAL   * No. Finished
.
EXTSLT30  COMPARE   PARNSLOT,OBAEXSL
          GOTO      EXTSLT90 IF NOT EQUAL
.
          SUB       ONE,OLDSLOTS
          MOVE      ZEROVISN,OBAOUTNO       * Outpatient number
          MOVE      ZEROUR,OBAURNO          * Outpatient number
          MOVE      "R  ",OBAVISIT
          MOVE      ZERO,OBAEXSL            * Update as Not Extended
          MOVE      ZERO,OBASTAT            * Update as Not Extended
          CALL      UPBOKA1
          GOTO      EXTSLT20
.
EXTSLT90  PACK      KEY28,NEWSLOTK,SP70      * Key for selected booking
          CALL      RDBOKA1                  * Read in the booking record
          RETURN
+
.******************************************************************************
.*          WRAP0000: write to the outrapaf file (Re-appointments File)       *
.******************************************************************************
WRAP0000  READ      CONTROLF,THIRTY1;*226,OTCNRAPA
          IF        OTCNRAPA=1
            MOVE      ADMISSNO,OTRPOBKN   * Old
            MOVE      OBAOUTNO,OTRPRBKN   * New
            PACK      OTRPDATE,CCC,CYY,CMM,CDD
            REP       " 0",OTRPDATE
            CLOCK     TIME,OTRPTIME
            MOVE      PASSCODE,OTRPLOGI
            MOVE      SP30,OTRPSPAR
            PACK      KEY16,OTRPOBKN,OTRPRBKN
            CALL      RDOTRAP1
            IF        OVRCD=1
              CALL      WROTRAP1
            ENDIF
          ENDIF
          RETURN
+
.------------------------------------------------------------------------------
. If the slot type is chart review set the send letter to N/A
. and clear the send letter date
.------------------------------------------------------------------------------
CHRT0000  PACK      KEY5,ANSC,ANSV,OBAVISIT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CHRT9999
.
          MATCH     "C",TCINDC8
          IF        @EQUAL
            MOVE      "2",OTBBSNDL        * Sent send letter to N/A and clear
            MOVE      SP70,OTBBGLDT       * send date if chart review slot
          ENDIF
.
CHRT9999  RETURN
+
.------------------------------------------------------------------------------
. Update waiting list review date
. OTCNAUPD - Update waiting list outpatient review date set to yes
. REVWFLAG - 0 = Update review date
.            1 = Delete review date
.------------------------------------------------------------------------------
REVD0000  COMPARE   ONE,HBWAIT                   * Using w/list
          GOTO      REVD9999 IF NOT EQUAL
.
          MATCH     "1",OTCNAUPD                 * Not using auto update review
          GOTO      REVD9999 IF NOT EQUAL        * date
.
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          MATCH     CURRDATE,OBADATE             * Exit if booking date is
          GOTO      REVD9999 IF LESS             * less than today
.
          PACK      KEY12,OBASITE,OBACTYP,SP70
          CALL      RDCTYA1                      * Exit if invalid clinic type
          BRANCH    OVRCD,REVD9999
.
          MATCH     SP70,OCTWUNIT                * Exit if no W/List unit
          GOTO      REVD9999 IF EQUAL
.
          PACK      KEY19,OBAURNO,SP70
          CALL      RDSTREA1
REVD1000  CALL      RDKTREA1
          BRANCH    OVRCD,REVD9999
.
          MATCH     WMURNO,OBAURNO               * Select records that are
          GOTO      REVD9999 IF NOT EQUAL        * Unscheduled, Scheduled or
.                                                * Pre-Admitted
          BRANCH    WMSTAT,REVD2000,REVD2000,REVD2000
.
          GOTO      REVD1000
.
REVD2000  BRANCH    REVWFLAG,REVD6000            * Cancel booking
.
          MATCH     SP70,WMDATE2                 * Update if no review date
          GOTO      REVD5000 IF EQUAL
.
          MATCH     WMDATE2,OBADATE              * Skip if booking date is
          GOTO      REVD1000 IF EQUAL            * equal to review date
.
          MATCH     WMDATE2,OBADATE              * Exit if booking date is
          GOTO      REVD1000 IF LESS             * less than review date
.
REVD5000  MOVE      OBADATE,WMDATE2              * Set review date to book date
          GOTO      REVD8000
.
REVD6000  MATCH     SP70,WMDATE2                 * Skip if no review date to
          GOTO      REVD1000 IF EQUAL            * clear on cancel
.
          MOVE      SP70,WMDATE2                 * Clear review date
.
REVD8000  CALL      UPTREA1                      * Update waiting list
.
          GOTO      REVD1000                     * Check next record
.
REVD9999  RETURN
+
.*******************************************************************************
.             PPRE0000 : Post the pre-attendance file data
.*******************************************************************************
PPRE0000  MOVE      OBAOUTNO,KEY8
          CALL      RDPREA1
          BRANCH    OVRCD,PPRE5000
.
          MOVE      OBACLIN,OPRCLIN
          MOVE      OBADATE,OPRDATE
          MOVE      OBASTRT,OPRSTRT
          MOVE      OBASLOT,OPRSLOT
          MOVE      OBATIME,OPRTIME
          MOVE      OBACTYP,OPRCTYP
          CALL      UPPREA1
          GOTO      PPRE9999
.
PPRE5000  MOVE      OBAOUTNO,OPROUTN
          MOVE      OBASITE,OPRSITE
          MOVE      OBACLIN,OPRCLIN
          MOVE      OBADATE,OPRDATE
          MOVE      OBASTRT,OPRSTRT
          MOVE      OBASLOT,OPRSLOT
          MOVE      OBATIME,OPRTIME
          MOVE      OBACTYP,OPRCTYP
          MOVE      SP20,OPRSPAR
          MOVE      OPROUTN,KEY8
          CALL      WRPREA1
.
PPRE9999  RETURN
+
.------------------------------------------------------------
. Wite Zero UR Records
.------------------------------------------------------------
WRTZUR00  MOVE      OBAOUTNO,KEY8
          CALL      RDPRAM1
          IF        OVRCD=1
            CALL      CLPATMAS
            MOVE      OBAOUTNO,PURNO
            CALL      MVPRAM00
            CALL      WRPRAM1
            CALL      WZUS0000
          ENDIF
.
WRTZUR99  RETURN
+
.******************************************************************************
.*                         WZUS0000                                           *
.*         Write a zero u/r record to double soundex surname file             *
.*                   called by : WRIT5100                                     *
.******************************************************************************
WZUS0000  MOVE      PTMASNAM,GSRSNAM         * Surname
          MOVE      PMPXFNAM,GSRGNAM         * Given Name 1
          MOVE      PMPXSNAM,PTGSGNM2        * Given Name 2
          MOVE      ZEROUR,GSRURNO           * No U/R Number
          MOVE      OBAOUTNO,GSRBILL         * Billing Number
          MOVE      TWO,GSRSYS               * Outpatients System
          CALL      SOUNDEX                  * Calculate soundex key
          CALL      SOUNDX2                  * given name soundex
.
          PACK      KEY115,GSRURNO,GSRBILL,GSRSNAM,GSRGNAM,PTGSGNM2,GSRDOB:
                           GSRSEX
          CALL      RAPTGSR1                 * check if its already there
          COMPARE   ZERO,OVRCD               * check overcond flag
          GOTO      WZUS9999 IF EQUAL        * already exists
          CALL      WRPTGSR1                 * Write the surname record
.
WZUS9999  RETURN
+
.*******************************************************************************
.                         Update Master Details
.*******************************************************************************
MVPRAM00  MATCH     PTMAS001,Z70
          IF        !@EQUAL
            MOVE      PTMAS001,PTITL
          ENDIF
.
          COMPARE   PTMAS002,ZERO
          IF        !@EQUAL
            MOVE      PTMAS002,PHOSP
          ENDIF
.
          COMPARE   PTMAS003,ZERO
          IF        !@EQUAL
            MOVE      PTMAS003,PLDAYS
          ENDIF
.
          COMPARE   PTMAS004,ZERO
          IF        !@EQUAL
            MOVE      PTMAS004,PBDEBT
          ENDIF
.
          MATCH     PTMAS005,Z70
          IF        !@EQUAL
            MOVE      PTMAS005,PSNAME
          ENDIF
.
          MATCH     PTMAS006,Z70
          IF        !@EQUAL
            MOVE      PTMAS006,PGNAME
          ENDIF
.
          MATCH     PTMAS007,Z70
          IF        !@EQUAL
            MOVE      PTMAS007,PPSNAME
          ENDIF
.
          MATCH     PTMAS008,Z70
          IF        !@EQUAL
            MOVE      PTMAS008,PADD1
          ENDIF
.
          MATCH     PTMAS009,Z70
          IF        !@EQUAL
            MOVE      PTMAS009,PADD2
          ENDIF
.
          MATCH     PTMAS010,Z70
          IF        !@EQUAL
            MOVE      PTMAS010,PSUBRB
          ENDIF
.
          MATCH     PTMAS011,Z70
          IF        !@EQUAL
            MOVE      PTMAS011,PADD4
          ENDIF
.
          MATCH     PTMAS012,Z70
          IF        !@EQUAL
            MOVE      PTMAS012,PPOST
          ENDIF
.
          MATCH     PTMAS013,Z70
          IF        !@EQUAL
            MOVE      PTMAS013,PTELEP
          ENDIF
.
          MATCH     PTMAS014,Z70
          IF        !@EQUAL
            MOVE      PTMAS014,PTELEB
          ENDIF
.
          MATCH     PTMAS015,Z70
          IF        !@EQUAL
            MOVE      PTMAS015,PSEX
          ENDIF
.
          MATCH     PTMAS016,Z70
          IF        !@EQUAL
            MOVE      PTMAS016,PMSTAT
          ENDIF
.
          MATCH     PTMAS017,Z70
          IF        !@EQUAL
            MOVE      PTMAS017,PBDATE
          ENDIF
.
          COMPARE   PTMAS018,ZERO
          IF        !@EQUAL
            MOVE      PTMAS018,PSAGE
          ENDIF
.
          MATCH     PTMAS019,Z70
          IF        !@EQUAL
            MOVE      PTMAS019,PCONT
          ENDIF
.
          MATCH     PTMAS020,Z70
          IF        !@EQUAL
            MOVE      PTMAS020,PREG
          ENDIF
.
          MATCH     PTMAS021,Z70
          IF        !@EQUAL
            MOVE      PTMAS021,PTYPE
          ENDIF
.
          MATCH     PTMAS022,Z70
          IF        !@EQUAL
            MOVE      PTMAS022,POCCUP
          ENDIF
.
          MATCH     PTMAS023,Z70
          IF        !@EQUAL
            MOVE      PTMAS023,PMEDI
          ENDIF
.
          MATCH     PTMAS024,Z70
          IF        !@EQUAL
            MOVE      PTMAS024,PPENNO
          ENDIF
.
          MATCH     PTMAS025,Z70
          IF        !@EQUAL
            MOVE      PTMAS025,PPNDTE
          ENDIF
.
          MATCH     PTMAS026,Z70
          IF        !@EQUAL
            MOVE      PTMAS026,PREPAT
          ENDIF
.
          COMPARE   PTMAS027,ZERO
          IF        !@EQUAL
            MOVE      PTMAS027,PSMOK
          ENDIF
.
          MATCH     PTMAS028,Z70
          IF        !@EQUAL
            MOVE      PTMAS028,PMICRO
          ENDIF
.
          COMPARE   PTMAS029,ZERO
          IF        !@EQUAL
            MOVE      PTMAS029,PCEASE
          ELSE
            MOVE      ZERO,PCEASE
          ENDIF
.
          COMPARE   PTMAS030,ZERO
          IF        !@EQUAL
            MOVE      PTMAS030,PCASE
          ENDIF
.
          COMPARE   PTMAS031,ZERO
          IF        !@EQUAL
            MOVE      PTMAS031,PAUTOPY
          ENDIF
.
          MATCH     PTMAS032,Z70
          IF        !@EQUAL
            MOVE      PTMAS032,PHIGH1
          ENDIF
.
          MATCH     PTMAS033,Z70
          IF        !@EQUAL
            MOVE      PTMAS033,PHIGH2
          ENDIF
.
          MATCH     PTMAS034,Z70
          IF        !@EQUAL
            MOVE      PTMAS034,PHIGH3
          ENDIF
.
          MATCH     PTMAS035,Z70
          IF        !@EQUAL
            MOVE      PTMAS035,PLOCDOC
          ENDIF
.
          MATCH     PTMAS036,Z70
          IF        !@EQUAL
            MOVE      PTMAS036,PFUNDH
          ENDIF
.
          MATCH     PTMAS037,Z70
          IF        !@EQUAL
            MOVE      PTMAS037,PFNDTB
          ENDIF
.
          MATCH     PTMAS038,Z70
          IF        !@EQUAL
            MOVE      PTMAS038,PFNDMM
          ENDIF
.
          MATCH     PTMAS039,Z70
          IF        !@EQUAL
            MOVE      PTMAS039,PUSR1
          ENDIF
.
          MATCH     PTMAS040,Z70
          IF        !@EQUAL
            MOVE      PTMAS040,PUSR2
          ENDIF
.
          MATCH     PTMAS041,Z70
          IF        !@EQUAL
            MOVE      PTMAS041,PUSR3
          ENDIF
.
          MATCH     PTMAS042,Z70
          IF        !@EQUAL
            MOVE      PTMAS042,PUSR4
          ENDIF
.
          MATCH     PTMAS043,Z70
          IF        !@EQUAL
            MOVE      PTMAS043,PUSR5
          ENDIF
.
          MATCH     PTMAS044,Z70
          IF        !@EQUAL
            MOVE      PTMAS044,PUSR6
          ENDIF
.
          COMPARE   PTMAS045,ZERO
          IF        !@EQUAL
            MOVE      PTMAS045,PUYN1
          ENDIF
.
          COMPARE   PTMAS046,ZERO
          IF        !@EQUAL
            MOVE      PTMAS046,PUYN2
          ENDIF
.
          COMPARE   PTMAS047,ZERO
          IF        !@EQUAL
            MOVE      PTMAS047,PUYN3
          ENDIF
.
          COMPARE   PTMAS048,ZERO
          IF        !@EQUAL
            MOVE      PTMAS048,PYRRES
          ENDIF
.
          MATCH     PTMAS049,Z70
          IF        !@EQUAL
            MOVE      PTMAS049,PNKNAME
          ENDIF
.
          MATCH     PTMAS050,Z70
          IF        !@EQUAL
            MOVE      PTMAS050,PNKADD1
          ENDIF
.
          MATCH     PTMAS051,Z70
          IF        !@EQUAL
            MOVE      PTMAS051,PNKADD2
          ENDIF
.
          MATCH     PTMAS052,Z70
          IF        !@EQUAL
            MOVE      PTMAS052,PNKSUBR
          ENDIF
.
          MATCH     PTMAS053,Z70
          IF        !@EQUAL
            MOVE      PTMAS053,PNKADD4
          ENDIF
.
          MATCH     PTMAS054,Z70
          IF        !@EQUAL
            MOVE      PTMAS054,PNKPOST
          ENDIF
.
          MATCH     PTMAS055,Z70
          IF        !@EQUAL
            MOVE      PTMAS055,PNKTELP
          ENDIF
.
          MATCH     PTMAS056,Z70
          IF        !@EQUAL
            MOVE      PTMAS056,PNKTELB
          ENDIF
.
          MATCH     PTMAS057,Z70
          IF        !@EQUAL
            MOVE      PTMAS057,PNKRELP
          ENDIF
.
          COMPARE   PTMAS058,ZERO
          IF        !@EQUAL
            MOVE      PTMAS058,PNXRAY
          ENDIF
.
          MATCH     PTMAS059,Z70
          IF        !@EQUAL
            MOVE      PTMAS059,PFNDYY
          ENDIF
.
          MATCH     PTMAS060,Z70
          IF        !@EQUAL
            MOVE      PTMAS060,PFNDCG
          ENDIF
.
          MATCH     PTMAS061,Z70
          IF        !@EQUAL
            MOVE      PTMAS061,PDECDTE
          ENDIF
.
          MATCH     PTMAS062,Z70
          IF        !@EQUAL
            MOVE      PTMAS062,PDIET
          ENDIF
.
          MATCH     PTMAS063,Z70
          IF        !@EQUAL
            MOVE      PTMAS063,PINITHOS
          ENDIF
.
          MATCH     PTMAS064,Z70
          IF        !@EQUAL
            MOVE      PTMAS064,PTMAEMPC
          ENDIF
.
          MATCH     PTMAS065,Z70
          IF        !@EQUAL
            MOVE      PTMAS065,PTMANOKO
          ENDIF
.
          MATCH     PTMAS066,Z70
          IF        !@EQUAL
            MOVE      PTMAS066,PTMANOKE
          ENDIF
.
MVPRAM99  RETURN
+
.*******************************************************************************
.                           Set Out B Parameters
.*******************************************************************************
SETBB000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          IF        (F3=11|F3=52|F3=66|F3=79)
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      QRYDATA,CCENT,CYEAR,CMON,CDAY,SP70
          ENDIF
.
          STORE     QRYDATA,F3,OUTBB001,OUTBB002,OUTBB003,OUTBB004,OUTBB005:
                               OUTBB006,OUTBB007,OUTBB008,OUTBB009,OUTBB010:
                               OUTBB011,OUTBB012,OUTBB013,OUTBB014,OUTBB015:
                               OUTBB016,OUTBB017,OUTBB018,OUTBB019,OUTBB020:
                               OUTBB021,OUTBB022,OUTBB023,OUTBB024,OUTBB025:
                               OUTBB026,OUTBB027,OUTBB028,OUTBB029,OUTBB030:
                               OUTBB031,OUTBB032,OUTBB033,OUTBB034,OUTBB035:
                               OUTBB036,OUTBB037,OUTBB038,OUTBB039,OUTBB040:
                               OUTBB041,OUTBB042,OUTBB043,OUTBB044,OUTBB045:
                               OUTBB046,OUTBB047,OUTBB048,OUTBB049,OUTBB050:
                               OUTBB051,OUTBB052,OUTBB053,OUTBB054,OUTBB055:
                               OUTBB056,OUTBB057,OUTBB058,OUTBB059,OUTBB060:
                               OUTBB061,OUTBB062,OUTBB063,OUTBB064,OUTBB065:
                               OUTBB066,OUTBB067,OUTBB068,OUTBB069,OUTBB070:
                               OUTBB071,OUTBB072,OUTBB073,OUTBB074,OUTBB075:
                               OUTBB076,OUTBB077,OUTBB078,OUTBB079,OUTBB080:
                               OUTBB081,OUTBB082,OUTBB083
SETBB999  RETURN
+
.*****************************************************************************
.* clear cgi parameters for outbb1                                           *
.*****************************************************************************
CLRBB000  MOVE       Z70,OUTBB001
          MOVE       Z70,OUTBB002
          MOVE       Z70,OUTBB003
          MOVE       Z70,OUTBB004
          MOVE       Z70,OUTBB005
          MOVE       Z70,OUTBB006
          MOVE       Z70,OUTBB007
          MOVE       Z70,OUTBB008
          MOVE       Z70,OUTBB009
          MOVE       Z70,OUTBB010
          MOVE       Z70,OUTBB011
          MOVE       Z70,OUTBB012
          MOVE       Z70,OUTBB013
          MOVE       Z70,OUTBB014
          MOVE       Z70,OUTBB015
          MOVE       Z70,OUTBB016
          MOVE       Z70,OUTBB017
          MOVE       Z70,OUTBB018
          MOVE       Z70,OUTBB019
          MOVE       Z70,OUTBB020
          MOVE       Z70,OUTBB021
          MOVE       Z70,OUTBB022
          MOVE       Z70,OUTBB023
          MOVE       Z70,OUTBB024
          MOVE       Z70,OUTBB025
          MOVE       Z70,OUTBB026
          MOVE       Z70,OUTBB027
          MOVE       Z70,OUTBB028
          MOVE       Z70,OUTBB029
          MOVE       Z70,OUTBB030
          MOVE       Z70,OUTBB031
          MOVE       Z70,OUTBB032
          MOVE       Z70,OUTBB033
          MOVE       Z70,OUTBB034
          MOVE       Z70,OUTBB035
          MOVE       Z70,OUTBB036
          MOVE       Z70,OUTBB037
          MOVE       Z70,OUTBB038
          MOVE       Z70,OUTBB039
          MOVE       Z70,OUTBB040
          MOVE       Z70,OUTBB041
          MOVE       Z70,OUTBB042
          MOVE       Z70,OUTBB043
          MOVE       Z70,OUTBB044
          MOVE       Z70,OUTBB045
          MOVE       Z70,OUTBB046
          MOVE       Z70,OUTBB047
          MOVE       Z70,OUTBB048
          MOVE       Z70,OUTBB049
          MOVE       Z70,OUTBB050
          MOVE       Z70,OUTBB051
          MOVE       Z70,OUTBB052
          MOVE       Z70,OUTBB053
.                                           *** HPS Code Starts Here ***
          MOVE       Z70,OUTBB054
          MOVE       Z70,OUTBB055
          MOVE       Z70,OUTBB056
          MOVE       Z70,OUTBB057
          MOVE       Z70,OUTBB058
          MOVE       Z70,OUTBB059
          MOVE       Z70,OUTBB060
          MOVE       Z70,OUTBB061
          MOVE       Z70,OUTBB062
          MOVE       Z70,OUTBB063
          MOVE       Z70,OUTBB064
          MOVE       Z70,OUTBB065
          MOVE       Z70,OUTBB066
          MOVE       Z70,OUTBB067
          MOVE       Z70,OUTBB068
          MOVE       Z70,OUTBB069
          MOVE       Z70,OUTBB070
          MOVE       Z70,OUTBB071
          MOVE       Z70,OUTBB072
          MOVE       Z70,OUTBB073
          MOVE       Z70,OUTBB074
          MOVE       Z70,OUTBB075
          MOVE       Z70,OUTBB076
          MOVE       Z70,OUTBB077
          MOVE       Z70,OUTBB078
          MOVE       Z70,OUTBB079
          MOVE       Z70,OUTBB080
          MOVE       Z70,OUTBB081
          MOVE       Z70,OUTBB082
          MOVE       Z70,OUTBB083
.                                           *** HPS Code Ends Here ***
CLRBB999  RETURN
+
.*******************************************************************************
.                         Move in Bok B Details
.*******************************************************************************
MOVBB000  MATCH     Z70,OUTBB001
          IF        !@EQUAL
            MOVE      OUTBB001,OBASRCR
          ENDIF
.
          MATCH     Z70,OUTBB002
          IF        !@EQUAL
            MOVE      OUTBB002,OBACOMP
          ENDIF
.
          MATCH     Z70,OUTBB003
          IF        !@EQUAL
            MOVE      OUTBB003,OBACLASS
          ENDIF
.
          MATCH     Z70,OUTBB004
          IF        !@EQUAL
            MOVE      OUTBB004,OBAINS
          ENDIF
.
          MATCH     Z70,OUTBB005
          IF        !@EQUAL
            MOVE      OUTBB005,OBAATTN
          ENDIF
.
          MATCH     Z70,OUTBB006
          IF        !@EQUAL
            MOVE      OUTBB006,OBADOCT
          ENDIF
.
          MATCH     Z70,OUTBB007
          IF        !@EQUAL
            MOVE      OUTBB007,OBACOMM
          ENDIF
.
          MATCH     Z70,OUTBB008
          IF        !@EQUAL
            MOVE      OUTBB008,OTBBFUND
          ENDIF
.
          MATCH     Z70,OUTBB009
          IF        !@EQUAL
            MOVE     OUTBB009,OTBBTBLE
          ENDIF
.
          MATCH     Z70,OUTBB010
          IF        !@EQUAL
            MOVE     OUTBB010,DOTBBPVI
          ENDIF
.
          MATCH     Z70,OUTBB011
          IF        !@EQUAL
            MOVE      OUTBB011,OBADATE
          ENDIF
.
          MATCH     Z70,OUTBB012
          IF        !@EQUAL
            MOVE      OUTBB012,OBACAT
          ENDIF
.
          MATCH     Z70,OUTBB013
          IF        !@EQUAL
            MOVE      OUTBB013,OBAPRTY
          ENDIF
.
          MATCH     Z70,OUTBB014
          IF        !@EQUAL
            MOVE      OUTBB014,OBARSCHD
          ENDIF
.
          MATCH     Z70,OUTBB015
          IF        !@EQUAL
            MOVE      OUTBB015,OBBBOOK
          ENDIF
.
          MATCH     Z70,OUTBB016
          IF        !@EQUAL
            MOVE      OUTBB016,OBBCTYP
          ELSE
            MATCH     SP70,OBBCTYP
            IF        @EQUAL
              MOVE      OBACTYP,OBBCTYP
            ENDIF
          ENDIF
.
          MATCH     Z70,OUTBB017
          IF        !@EQUAL
            MOVE      OUTBB017,OBOUSR1
          ENDIF
.
          MATCH     Z70,OUTBB018
          IF        !@EQUAL
            MOVE      OUTBB018,OBOUSR2
          ENDIF
.
          MATCH     Z70,OUTBB019
          IF        !@EQUAL
            MOVE      OUTBB019,OBOUSR3
          ENDIF
.
          MATCH     Z70,OUTBB020
          IF        !@EQUAL
            MOVE      OUTBB020,OBOUSR4
          ENDIF
.
          MATCH     Z70,OUTBB021
          IF        !@EQUAL
            MOVE      OUTBB021,OBALADMN
          ENDIF
.
          MATCH     Z70,OUTBB022
          IF        !@EQUAL
            MOVE      OUTBB022,OTBBDEPT
          ENDIF
.
          MATCH     Z70,OUTBB023
          IF        !@EQUAL
            MOVE      OUTBB023,OTBBTRAN
          ENDIF
.
          MATCH     Z70,OUTBB024
          IF        !@EQUAL
            MOVE      OUTBB024,OTBBLNGI
          ENDIF
.
          MATCH     Z70,OUTBB025
          IF        !@EQUAL
            MOVE      OUTBB025,OTBBTMFS
          ENDIF
.
          MATCH     Z70,OUTBB026
          IF        !@EQUAL
            MOVE      OUTBB026,OTBBTMBO
          ENDIF
.
          MATCH     Z70,OUTBB027
          IF        !@EQUAL
            MOVE      OUTBB027,OTBBGPFA
          ENDIF
.
          MATCH     Z70,OUTBB028
          IF        !@EQUAL
            MOVE      OUTBB028,OTBBECRA
          ENDIF
.
          MATCH     Z70,OUTBB029
          IF        !@EQUAL
            MOVE      OUTBB029,OTBBRFGP
          ENDIF
.
          MATCH     Z70,OUTBB030
          IF        !@EQUAL
            MOVE      OUTBB030,OTBBGPPC
          ENDIF
.
          MATCH     Z70,OUTBB031
          IF        !@EQUAL
            MOVE      OUTBB031,OTBBADCS
          ENDIF
.
          MATCH     Z70,OUTBB032
          IF        !@EQUAL
            MOVE      OUTBB032,OTBBCITM
          ENDIF
.
          MATCH     Z70,OUTBB033
          IF        !@EQUAL
            MOVE      OUTBB033,OTBBASTM
          ENDIF
.
          MATCH     Z70,OUTBB034
          IF        !@EQUAL
            MOVE      OUTBB034,OTBBDPTM
          ENDIF
.
          MATCH     Z70,OUTBB035
          IF        !@EQUAL
            MOVE      OUTBB035,OTBBOUTC
          ENDIF
.
          MATCH     Z70,OUTBB036
          IF        !@EQUAL
            MOVE      OUTBB036,OTBBSNDL
          ELSE
            MOVE      ZERO,OTBBSNDL
          ENDIF
.
          MATCH     Z70,OUTBB037
          IF        !@EQUAL
            MOVE      OUTBB037,OTBBGPPT
          ENDIF
.
          MATCH     Z70,OUTBB038
          IF        !@EQUAL
            MOVE      OUTBB038,OTBBDOFR
          ENDIF
.
          MATCH     Z70,OUTBB039
          IF        !@EQUAL
            MOVE      OUTBB039,OTBBOPER
          ENDIF
.
          MATCH     Z70,OUTBB040
          IF        !@EQUAL
            MOVE      OUTBB040,OBOUSR5
          ENDIF
.
          MATCH     Z70,OUTBB041
          IF        !@EQUAL
            MOVE      OUTBB041,OBOUSR6
          ENDIF
.
          MATCH     Z70,OUTBB042
          IF        !@EQUAL
            MOVE      OUTBB042,OBOUSR7
          ENDIF
.
          MATCH     Z70,OUTBB043
          IF        !@EQUAL
            MOVE      OUTBB043,OBOUSR8
          ENDIF
.
          MATCH     Z70,OUTBB044
          IF        !@EQUAL
            MOVE      OUTBB044,OTBBRANK
          ENDIF
.
          MATCH     Z70,OUTBB045
          IF        !@EQUAL
            MOVE      OUTBB045,OPDICODE
          ENDIF
.
          MATCH     Z70,OUTBB046
          IF        !@EQUAL
            MOVE      OUTBB046,OPDIDESC
          ENDIF
.
          MATCH     Z70,OUTBB047
          IF        !@EQUAL
            MOVE      OUTBB047,OBAVISIT
          ENDIF
.
          MATCH     Z70,OUTBB048
          IF        !@EQUAL
            MOVE      OUTBB048,OBAPXRAY
          ENDIF
.
          MATCH     Z70,OUTBB049
          IF        !@EQUAL
            MOVE      OUTBB049,OBASESST
          ENDIF
.
          MATCH     Z70,OUTBB050
          IF        !@EQUAL
            MOVE      OUTBB050,OBADISCH
          ENDIF
.
          MATCH     Z70,OUTBB051
          IF        !@EQUAL
            MOVE      OUTBB051,OTBARESV
          ENDIF
.
          MATCH     Z70,OUTBB052
          IF        !@EQUAL
            MOVE      OUTBB051,OTBCRDAT
          ENDIF
          MATCH     Z70,OUTBB054
          IF        !@EQUAL
            MOVE      OUTBB054,OTBBSPCA
          ENDIF
.
.                                           *** HPS Code Starts Here ***
          MATCH     Z70,OUTBB055
          IF        !@EQUAL
            MOVE      OUTBB055,OPDICOD2
          ENDIF
.
          MATCH     Z70,OUTBB056
          IF        !@EQUAL
            MOVE      OUTBB056,OPDIDES2
          ENDIF
.
          MATCH     Z70,OUTBB057
          IF        !@EQUAL
            MOVE      OUTBB057,OPDICOD3
          ENDIF
.
          MATCH     Z70,OUTBB058
          IF        !@EQUAL
            MOVE      OUTBB058,OPDIDES3
          ENDIF
.
          MATCH     Z70,OUTBB059
          IF        !@EQUAL
            MOVE      OUTBB059,OPDICOD4
          ENDIF
.
          MATCH     Z70,OUTBB060
          IF        !@EQUAL
            MOVE      OUTBB060,OPDIDES4
          ENDIF
.
          MATCH     Z70,OUTBB061
          IF        !@EQUAL
            MOVE      OUTBB061,OPDICOD5
          ENDIF
.
          MATCH     Z70,OUTBB062
          IF        !@EQUAL
            MOVE      OUTBB062,OPDIDES5
          ENDIF
.
          MATCH     Z70,OUTBB063
          IF        !@EQUAL
            MOVE      OUTBB063,OTBBCIND
          ENDIF
.                                           *** HPS Code Ends Here ***
          MATCH     Z70,OUTBB064
          IF        !@EQUAL
            MOVE      OUTBB064,OTBBFLUP
          ENDIF
.
          MATCH     Z70,OUTBB065
          IF        !@EQUAL
            MOVE      OUTBB065,OTBBSCAR
          ENDIF
.
          MATCH     Z70,OUTBB066
          IF        !@EQUAL
            MOVE      OUTBB066,OTBBGLDT
          ENDIF
.
          MATCH     Z70,OUTBB067
          IF        !@EQUAL
            MOVE      OUTBB067,OTBBSNGL
          ENDIF
.
          MATCH     Z70,OUTBB068
          IF        !@EQUAL
            MOVE      OUTBB068,OTBBNMDS
          ENDIF
.
          MATCH     Z70,OUTBB069
          IF        !@EQUAL
            MOVE      OUTBB069,OTBBCART
          ENDIF
.
          MATCH     Z70,OUTBB070
          IF        !@EQUAL
            MOVE      OUTBB070,OTBBSRVD
          ENDIF
.
          MATCH     Z70,OUTBB071
          IF        !@EQUAL
            MOVE      OUTBB071,OTBBCLHR
          ENDIF
.
          MATCH     Z70,OUTBB072
          IF        !@EQUAL
            MOVE      OUTBB072,OTBBTCOD
          ENDIF
.
          MATCH     Z70,OUTBB073
          IF        !@EQUAL
            MOVE      OUTBB073,OTBBPURC
          ENDIF
.
          MATCH     Z70,OUTBB074
          IF        !@EQUAL
            MOVE      OUTBB074,OTBBCONT
          ENDIF
.
          MATCH     Z70,OUTBB080
          IF        !@EQUAL
            MOVE      OUTBB080,OTBBHCP1
          ENDIF
.
          MATCH     Z70,OUTBB081
          IF        !@EQUAL
            MOVE      OUTBB081,OTBBHCP2
          ENDIF
.
          MATCH     Z70,OUTBB082
          IF        !@EQUAL
            MOVE      OUTBB082,OTBBHCP3
          ENDIF
.
          MATCH     Z70,OUTBB083
          IF        !@EQUAL
            MOVE      OUTBB083,OTBBHCP4
          ENDIF
.
MOVBB999  RETURN
+
.*******************************************************************************
.                              Update Booking
.*******************************************************************************
.  Update Type (UPDATETY)
.   1 = Attendance
.   2 = Non attendance
.   3 = Discharge
.   4 = Re-Appointment
.   5 = Re-Schedule
.   6 = Update Booking Details
.   7 = Outcome
.   8 = Cancel Booking
.   9 = Supervisor Update
.*******************************************************************************
UPDBOK00  MOVE      ZERO,BILLFLAG
          MOVE      CASEKEYS,KEY28
          CALL      RLOTBOA1
          BRANCH    OVRCD,UPDBOK95,UPDBOK93
          MOVE      OBAURNO,URNUMBER
          MOVE      OBAOUTNO,ADMISSNO
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1 
          BRANCH    OVRCD,UPDBOK96
.
          MOVE      OBALADMN,LINKOUTN
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDOTXSC1
          IF        OVRCD=1
            CALL      CLOUTXSC         * Clear File fields
          ENDIF
.
          MOVE      OBAURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,UPDBOK85
.... CAR 49664  don't check "deceased" flag when cancelling booking
          IF        UPDATETY<>8
            IF        PCEASE=1
              MATCH     SP70,PDECDTE
              IF        !@EQUAL
                MATCH     OBADATE,PDECDTE
                GOTO      UPDBOK86 IF LESS
              ELSE  
                GOTO      UPDBOK86
              ENDIF
            ENDIF 
          ENDIF
          CALL      RDPMPX21
          BRANCH    OVRCD,UPDBOK85
.
          UNPACK    PBDATE,CDAY,CMON,CYEAR,CCENT
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
          CALL      VALICD00
          BRANCH    EXIT,UPDBOK99
.
          BRANCH    UPDATETY,UPDBOK10,UPDBOK20,UPDBOK30,UPDBOK40,UPDBOK50:
                             UPDBOK55,UPDBOK60,UPDBOK65,UPDBOK70,UPDBOK75
          GOTO      UPDBOK97
.----------------------------------------
. Attendance
.----------------------------------------
UPDBOK10  MOVE      ZERO,ATNDFLAG            * initialise HL7 message flag
.
          COMPARE   ONE,OBASTAT              * Is this a booking ?
          GOTO      UPDBOK15 IF EQUAL        * yes
.
          COMPARE   FOUR,OBASTAT             * Is this an attendance ?
          GOTO      UPDBOK94 IF NOT EQUAL    * no
.
          MOVE      ONE,ATNDFLAG             * set flag for A08 instead of A04
.
          PACK      KEY18,OBASITE,OBACLIN,OBADAY,OBASTRT,SP70
          CALL      RDMASA1
          MATCH     SP70,NEWSLOTK            * New Appointment
          GOTO      UPDBOK79 IF EQUAL        * Yes - Re-Appoint
          MOVE      OBAURNO,URNUMBER
          CALL      REAP0000                 * Re-appoint
          BRANCH    EXIT,UPDBOK99
          GOTO      UPDBOK79
.
UPDBOK15  CALL      ATTD0000                 * Attendance
          BRANCH    EXIT,UPDBOK89
          PACK      KEY18,OBASITE,OBACLIN,OBADAY,OBASTRT,SP70
          CALL      RDMASA1
          CALL      XCHG0000                 * Get the charge for this patient
          CALL      POSTCHRG                 * Post the charge to the Dtrof file
          CALL      CNTCT000
.
          MATCH     SP70,NEWSLOTK            * New Appointment
          GOTO      UPDBOK79 IF EQUAL        * Yes - Re-Appoint
          MOVE      OBAURNO,URNUMBER
          CALL      REAP0000                 * Re-appoint
          BRANCH    EXIT,UPDBOK99
          GOTO      UPDBOK79
.----------------------------------------
. Non Attendance 
.----------------------------------------
UPDBOK20  COMPARE   ONE,OBASTAT             * Is this a booking ?
          GOTO      UPDBOK25 IF EQUAL
          COMPARE   FIVE,OBASTAT            * Is this a booking ?
          GOTO      UPDBOK94 IF NOT EQUAL
.
UPDBOK25  UNPACK    CASEKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,DOBASLOT
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MATCH     OBADATE,KEY8
          GOTO      UPDBOK88 IF LESS
          GOTO      UPDBOK26 IF NOT EQUAL
          CLOCK     TIME,CTIMEIS
          MATCH     OBATIME,CTIMEIS
          GOTO      UPDBOK88 IF LESS
.    
UPDBOK26  CALL      NATT0000                * Non Attendance
.
          CALL      NREQ0000                * Write new appointment request
.
          CALL      PDNA0000                * Print DNA letter
.
          MATCH     SP70,NEWSLOTK           * New Appointment
          GOTO      UPDBOK79 IF EQUAL       * Yes - Re-Appoint
.
.         The following save varaibles are used by EOCACC00 procedure
.
          MOVE      OBAOUTNO,SAVADMNO     * Save original admission number
          MOVE      OBACOMP,SAVBCOMP      * Save original claim code
.
          MOVE      NEWSLOTK,SAVSLOTK
          MOVE      SP70,NEWSLOTK
          CALL      BOKUPD00                * Update DNA Appointment Details
          MOVE      SAVSLOTK,NEWSLOTK
.
          MOVE      OBAURNO,URNUMBER
          CALL      REAP0000                * Re-appoint
          BRANCH    EXIT,UPDBOK99
.
          MOVE      NEWSLOTK,SESSKEYS       * Read session details
          CALL      SESDET00
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDPMVX11
          IF        OVRCD=1
            CALL      CLPMSVX1
            CALL      MVVXTF00
            MOVE      OBAOUTNO,PMVXVISN
            MOVE      USERID,PMVXWEBC
            PACK      PMVXCDTE,CCC,CYY,CMM,CDD
            REP       " 0",PMVXCDTE
            CLOCK     TIME,PMVXCTIM
            MOVE      PVIDATE,PMVXVSDT
            MOVE      PPOST,PMVXPOST
            MOVE      OTHEHOSP,PMVXMHOS
            CALL      GTASGC00                 * SLA/ASGC code
            MOVE      SP70,PMVXPOEC
            MOVE      SP70,PMVXPGID
            MOVE      SP70,PMVXPILC
            MOVE      PMPXABRG,PMVXABRG
            CALL      WRPMVX11
          ENDIF
.
.         Get claim details of the original admission no and copy to the new
.         appointment outpatient number
.
          CALL      GCLM0000              * Write claim details
          CALL      EOCACC00
.
          CALL      LNKR0000              * Write referral letter link
.
          MATCH     "1",COPYDNAC
          IF        @EQUAL
            CALL      WCOM0000            * Copy old comments to new appointment
          ENDIF
.
          GOTO      UPDBOK90
.----------------------------------------
. Discharge
.----------------------------------------
UPDBOK30  MATCH     "4",DOBASTAT
          GOTO      UPDBOK87 IF NOT EQUAL
          GOTO      UPDBOK79
.----------------------------------------
. Re-appoint
.----------------------------------------
UPDBOK40  MATCH     SP70,NEWSLOTK
          GOTO      UPDBOK98 IF EQUAL
.
          CALL      OCHK0000
          IF        EXIT=1
            MOVE      CASEKEYS,KEY28      * Check we are not converting a
            CALL      UUOTBOA1            * normal slot to an over booking
            GOTO      UPDBOK99            * and over bookings to normal slots
          ENDIF
.
.         The following save varaibles are used by EOCACC00 procedure
.
          MOVE      OBAOUTNO,SAVADMNO     * Save original admission number
          MOVE      OBACOMP,SAVBCOMP      * Save original claim code
.          
          MOVE      ONE,OTBBFLUP          * Follow Up Appointment Made
          CALL      UPBOKB1
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDPMVX11
          IF        OVRCD=0
              CALL      IBACLOCK
              PACK      PMVXLUPD,CCC,CYY,CMM,CDD
              REP       " 0",PMVXLUPD
              MOVE      CTIMEIS,PMVXLUPT
              MOVE      USERID,PMVXWEBU
              CALL      UPPMVX11
          ENDIF
.
          MOVE      SP70,OTBBFLUP       
.
          MOVE      OBAURNO,URNUMBER
          CALL      REAP0000              * Re-appoint
          BRANCH    EXIT,UPDBOK99
.
.         Get claim details of the original admission no and copy to the new
.         appointment outpatient number
.
          CALL      GCLM0000              * Write claim details
          CALL      EOCACC00
.
          CALL      LNKR0000              * Write referral letter link
.
          GOTO      UPDBOK79
.----------------------------------------
. Re Schedule
.----------------------------------------
UPDBOK50  IF        OBASTAT<>1
            COMPARE   SIX,OBASTAT              * Is this a booking ?
            GOTO      UPDBOK94 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,NEWSLOTK
          GOTO      UPDBOK98 IF EQUAL
.
          CALL      OCHK0000
          IF        EXIT=1
            MOVE      CASEKEYS,KEY28      * Check we are not converting a
            CALL      UUOTBOA1            * normal slot to an over booking
            GOTO      UPDBOK99            * and over bookings to normal slots
          ENDIF
.
.        Check if we need to send an A38 cancellation message for
.        a reschedule (while we still have the original booking details).
.
          MATCH     "1",PTCNH7RA
          IF        @EQUAL
            CALL      PMIGTNID               * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      TWENTY5,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICOC             * DG O/P Cancel Appoint
          ENDIF
.
          CALL      LOGR0000              * Log the rescheduling
.
          CALL      ROPD0000              * Write OPD reschedule action
.
          CALL      PRFL0000              * update outrf1af
.
          CALL      WBKA0000              * Write the new booking
          BRANCH    EXIT,UPDBOK98
.
          CALL      UWAT0000              * Update waiting list link booking PAC
          CALL      UWAI0000              * Update waiting list link booking PAS
          CALL      ULNK0000              * Update allied health link booking
          CALL      UMBS0000              * Update cmbs item table
          CALL      UTRN0000              * Update Transport Details
          CALL      UCLM0000              * Update claim details
.                                                                   * CAR 270888
          PACK      KEY8,OBAOUTNO,SP10
          CALL      DEPMCUR1              * Remove existing Curr Patient Record
          CALL      WRCPAT00              * Re-instate Current Patient Record 
.
          MOVE      CASEKEYS,SAVCASEK     * Save Casekeys for UPDCNT00
          CALL      DBOK0000              * Delete the old booking
          CALL      UUOTBOA1
.
          GOTO      UPDBOK79
.----------------------------------------
. UPDBOK55: Update a Booking
.----------------------------------------
UPDBOK55  MOVE      ONE,BILLFLAG          * Set flag to update billing
          GOTO      UPDBOK79
.----------------------------------------
. UPDBOK60: Update Outcome
.----------------------------------------
UPDBOK60  MOVE      "OZ",CATEGORY
          MOVE      OUTBB035,CODE
          MOVE      SP70,TCINDC2
          MOVE      ZERO,F1
          PACK      KEY5,CATEGORY,CODE,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TCINDC2,F1
          ENDIF
          BRANCH    F1,UPDBOK10,UPDBOK79,UPDBOK20
          GOTO      UPDBOK10
.----------------------------------------
. UPDBOK65: Cancel a single booking
.----------------------------------------
UPDBOK65  CALL      CANS0000
          BRANCH    EXIT,UPDBOK99
          GOTO      UPDBOK90
.----------------------------------------
. UPDBOK70: Supervisor Update Status
.----------------------------------------
UPDBOK70  MOVE      OUTBB002,KEY3       * New claim code
          CALL      LCLM0000            * get default claim details
.
          MOVE      ZERO,ATNDFLAG            * initialise HL7 message flag
          COMPARE   OBASTAT,BOOKSTAT
          IF        @EQUAL
            MOVE      ONE,ATNDFLAG           * set flag for A08
            GOTO      UPDBOK72
          ENDIF
          CALL      UPDSTA00    * Update Booking Status
          BRANCH    EXIT,UPDBOK99
.
UPDBOK72  MOVE      ONE,BILLFLAG          * Set flag to update billing
          GOTO      UPDBOK79    * Update Booking
.-------------------------------------------------------------
. UPDBOK75: Update Extra Screens (Booking/Attendance) details.
.-------------------------------------------------------------
UPDBOK75  PACK      KEY8,ADMISSNO,SP70
          CALL      RDOTXSC1
          IF        OVRCD=1
            CALL      CLOUTXSC         * Clear File fileds
          ENDIF
.
          CALL      MVOTXS00           * Move CGI parameters to File fields
          MOVE      ADMISSNO,OTXSOUTN
.
          CALL      RAOTXSC1
          IF        OVRCD=1
            CALL      WROTXSC1
          ELSE
            CALL      UPOTXSC1
          ENDIF
. 
          CALL      UUOTBOA1
.
          GOTO      UPDBOK99
.----------------------------------------
. UPDBOK79: Update Booking
.----------------------------------------
UPDBOK79  CALL      BOKUPD00 
          BRANCH    EXIT,UPDBOK95,UPDBOK96
          MOVE      ZERO,BILLFLAG
.
          COMPARE   NINE,UPDATETY
          IF        @EQUAL
            MATCH     Z70,OUTBB002
            IF        !@EQUAL
              MATCH     SAVCOMP,OUTBB002
              IF        !@EQUAL
                MOVE      SAVCOMP,PMCAOCLM    * Old Claim Code
                MOVE      OUTBB002,PMCANCLM   * New Claim code
                PACK      KEY14,OUTBB002,SP70
                CALL      UAUD0000            * Update Change audit file
              ENDIF
            ENDIF 
          ENDIF
.
.         If we are updating an existing attendance details, then generate
.         an update message (A08) inastead of another attend (A04) message.
.
          IF        UPDATETY = 1 & ATNDFLAG = 1
            GOTO      UPDBOK83
          ENDIF
          IF        WAHDISCH = 1
            GOTO      UPDBOK83              * wahealth discharge (CAR 305297)
          ENDIF
.
          BRANCH    UPDATETY,UPDBOK84:           * Attendance
                             UPDBOK90:           * DNA
                             UPDBOK84:           * Discharge
                             UPDBOK82:           * Re-appointment
                             UPDBOK81:           * Reschedule
                             UPDBOK83:           * Update Booking Details
                             UPDBOK82:           * Outcome
                             UPDBOK82:           * Cancel Booking
                             UPDBOK80            * Supervisor Update
.
.         Supervisor update - Check what the updated status is and send the
.         corresponding message.  This could be a COA, COB or COD.
.
UPDBOK80  BRANCH    OBASTAT,UPDBOK83:            * Update booking
                            UPDBOK90:
                            UPDBOK90:
                            UPDBOK84             * Attend
.                                                * DNA
          IF         OBASTAT=5 & DISCFLAG=2
            CALL      PMIGTNID              * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      FORTY1,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICOH              * send cancel discharge (A13)
          ENDIF
.
          IF         OBASTAT=5
            CALL      CLOUTRSH              * TSK: 0293130
.
            IF        OTCNA11N = 1
              CALL      PMIGTNID              * get national id for dgate write
              MOVE      NMPNUMB,PTNINMPI
              MOVE      FIFTY,HL7TRGID        * TSK 0903933
              MOVE      "WRITBOOK",HL7INCLD   * supervisor screen
              PROC      DGCLICOU              * send cancel attendance (A11)
            ENDIF
.
            CALL      PMIGTNID              * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      FORTY6,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICOD              * send DNA update (A08)
          ENDIF
.
          GOTO      UPDBOK90
.
.         Send reschedule HL7 messages
.
UPDBOK81  CALL      PMIGTNID               * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MATCH     "1",PTCNH7RA
          IF        @EQUAL
            MOVE      TWENTY6,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICON             * DG O/P New Appoint.
          ELSE
            MOVE      THIRTY1,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICOB    * Send Change O/P Booking Details message
          ENDIF
          GOTO      UPDBOK90
.
UPDBOK82  CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      SEVEN,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICON    * DG API O/P New Appoint.  *I-90203
          GOTO      UPDBOK90
.
UPDBOK83  IF        CANAFLAG=1 & UPDATETY=9
            IF        DISCFLAG=2
              CALL      PMIGTNID            * get national id for dgate write
              MOVE      NMPNUMB,PTNINMPI
              MOVE      FORTY,HL7TRGID
              MOVE      SP8,HL7INCLD        * Supervisor screen
              PROC      DGCLICOH            * send cancel discharge (A13)
            ENDIF
.
            CALL      PMIGTNID              * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      TEN,HL7TRGID
            MOVE      SP8,HL7INCLD          * supervisor screen 
            PROC      DGCLICOU              * send cancel attendance (A11) 
.
            GOTO      UPDBOK90
          ENDIF
.
          IF        CNLH7FLG<>1
            CALL      PMIGTNID               * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      EIGHT,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICOB      * Send Change O/P Booking Details message
          ENDIF
.
          IF        DISCFLAG=1
            CALL      PMIGTNID              * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      THIRTY9,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICOG              * send discharge (A03)
          ENDIF
.
          IF        DISCFLAG=2
            CALL      PMIGTNID              * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      THIRTY8,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICOH              * send cancel discharge (A13)
          ENDIF
.
          IF        UPBOOKRD=1
            CALL      UPOB0000               * Update linked outpatient booking
          ENDIF
.
          GOTO      UPDBOK90
.
UPDBOK84  IF        UPDATETY = 9 & ATNDFLAG = 1
            CALL      PMIGTNID                * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      FORTY2,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICOB      * Send Change O/P Booking Details message
          ELSE
            CALL      PMIGTNID                * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      NINE,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICOA      * Send O/P Confirm Appointment message
          ENDIF
.
          IF        DISCFLAG=1
            CALL      PMIGTNID              * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      THIRTY4,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICOG              * send discharge (A03)
          ENDIF
.
          IF        DISCFLAG=2
            CALL      PMIGTNID              * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      THIRTY5,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICOH              * send cancel discharge (A13)
          ENDIF
.
          IF        UPBOOKRD=1
            CALL      UPOB0000               * Update linked outpatient booking
          ENDIF
.
          GOTO      UPDBOK90
.----------------------------------------
. ERROR ROUTINES
.----------------------------------------
UPDBOK85  MOVE      "Invalid Patient UR",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDBOK99
.
UPDBOK86  MOVE      "Patient is Deceased",WEBTITLE
          CALL      WEBERR00
          CALL      UUOTBOA1
          MOVE      ONE,EXIT
          GOTO      UPDBOK99
.
UPDBOK87  MOVE      "This appointment has no recorded Attendance",WEBTITLE
          CALL      WEBERR00
          CALL      UUOTBOA1
          MOVE      ONE,EXIT
          GOTO      UPDBOK99
.
UPDBOK88  MOVE      "Booking can't be DNA in the future.",WEBTITLE
          CALL      WEBERR00
          CALL      UUOTBOA1
          MOVE      ONE,EXIT
          GOTO      UPDBOK99                
.
UPDBOK89  MOVE      "Booking can't be attended in future",WEBTITLE
          CALL      WEBERR00
          CALL      UUOTBOA1
          MOVE      ONE,EXIT
          GOTO      UPDBOK99
.
UPDBOK90  MOVE      CASEKEYS,KEY28
          CALL      UUOTBOA1
.
          CALL      UPDCNT00                    * Update Slot counts
.
.          MATCH     "1",PTCNUNET
.          IF        @EQUAL
.            MOVE      "01",KEY2                 * IHI Validation
.            PACK      KEY11,WBSEUID,SP70        * User ID
.            PACK      KEY50,OBAURNO,SP70
.            CALL      WIPL0000                  * Write to polling table
.          ENDIF
.
          CALL      PRNT0000  
.
          CALL      DISVAL00
          BRANCH    EXIT,UPDBOK99
.
          MOVE      "Booking Updated",WEBTITLE
          MOVE      ZERO,EXIT
          GOTO      UPDBOK99
.
UPDBOK91  MOVE      "New Appointment Record Locked",WEBTITLE
          CALL      WEBERR00
          CALL      UUOTBOA1
          MOVE      ONE,EXIT
          GOTO      UPDBOK99
.
UPDBOK92  MOVE      "New Appointment Has Been Taken. ",WEBTITLE
          CALL      WEBERR00
          CALL      UUOTBOA1
          MOVE      ONE,EXIT
          GOTO      UPDBOK99
.
UPDBOK93  MOVE      "Booking Record Locked",WEBTITLE
          CALL      WEBERR00
          CALL      UUOTBOA1
          MOVE      ONE,EXIT
          GOTO      UPDBOK99
.
UPDBOK94  MOVE      CASEKEYS,KEY28
          CALL      UUOTBOA1
          MOVE      "Invalid Booking Status ",WEBTITLE
          IF        OBASTAT=4
            MOVE      "Error: Appointment has been Attended",WEBTITLE
          ENDIF
          IF        OBASTAT=5
            MOVE      "Error: Appointment has been Non-Attended",WEBTITLE
          ENDIF
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDBOK99
.
UPDBOK95  MOVE      "Invalid Case",WEBTITLE
          CALL      WEBERR00
          CALL      UUOTBOA1
          MOVE      ONE,EXIT
          GOTO      UPDBOK99
.
UPDBOK96  MOVE      "Invalid Booking Status",WEBTITLE
          CALL      WEBERR00
          CALL      UUOTBOA1
          MOVE      ONE,EXIT
          GOTO      UPDBOK99
.
UPDBOK97  MOVE      CASEKEYS,KEY28
          CALL      UUOTBOA1
          MOVE      "Invalid Update Type",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDBOK99
.
UPDBOK98  MOVE      CASEKEYS,KEY28
          CALL      UUOTBOA1
          MOVE      "New Slot Key is Reserved or Invalid",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDBOK99
.
UPDBOK99  CLOSE     COMFILAF,DELETE
          CLOSE     COMFILBF,DELETE
          CLOSE     COMVISAF,DELETE
          CLOSE     COMFILOF,DELETE
          RETURN
+
.**********************************************************************
.*  UPDCNT00  - recalculate session stats                             *
.**********************************************************************
UPDCNT00  COMPARE   FIVE,UPDATETY         * Reschedule appointment
          IF        @EQUAL
            MATCH     SP70,SAVCASEK
            IF          !@EQUAL
              MOVE        SAVCASEK,SAVSKEYS
              CALL        RCAL0000
            ENDIF
            MATCH     SP70,NEWSLOTK
            GOTO      UPDCNT99 IF EQUAL
            MOVE      NEWSLOTK,SAVSKEYS
            GOTO      UPDCNT50
          ENDIF
.
          COMPARE   FOUR,UPDATETY         * Follow Up Appointment
          IF        @EQUAL
            MATCH     SP70,NEWSLOTK
            GOTO      UPDCNT99 IF EQUAL
            MOVE      NEWSLOTK,SAVSKEYS
            GOTO      UPDCNT50
          ENDIF
.
          COMPARE   SIX,UPDATETY         * Update Appointment
          IF        @EQUAL
            MATCH     SP70,NEWSLOTK
            GOTO      UPDCNT99 IF EQUAL
            MOVE      NEWSLOTK,SAVSKEYS
            MATCH     OLDVTYP,NEWVTYP    * Do not recalc if same visit type
            GOTO      UPDCNT99 IF EQUAL
            GOTO      UPDCNT50
          ENDIF
.
          COMPARE   EIGHT,UPDATETY        * Cancel Appointment
          GOTO      UPDCNT50 IF EQUAL     * savskey is set up before this call
.
          GOTO      UPDCNT99
.
UPDCNT50  CALL      RCAL0000              * Recalc session status for the new
.                                         * session because of slot type changes
          COMPARE   EIGHT,UPDATETY        * Don't have newslotk for cancel
          GOTO      UPDCNT60 IF EQUAL     * Appointment
.
          MOVE      NEWSLOTK,CASEKEYS
.
UPDCNT60  MOVE      CASEKEYS,KEY28        * Read correct appointment for
          CALL      RDBOKA1               * redirect
          IF        OVRCD=1
            COMPARE   EIGHT,UPDATETY        * Cancelled appointment
            GOTO      UPDCNT99 IF NOT EQUAL
.
            CALL      CLOUTBOA               * Clear all file fields
            PACK      KEY8,ADMISSNO,SP70
            CALL      RDOTCAN1               * Check if appointment cancelled
            IF        OVRCD=0
              MOVE      OPCNSITE,OBASITE     * Site Id
              MOVE      OPCNCLIN,OBACLIN     * Clinic Id
              MOVE      OPCNDATE,OBADATE     * Date (CCYYMMDD)
              MOVE      OPCNSTRT,OBASTRT     * Start Time (HH:MM)
              MOVE      OPCNSLOT,DOBASLOT    * Slot Number
              MOVE      OPCNSLOT,OBASLOT     * Slot Number
              MOVE      OPCNTIME,OBATIME     * Slot Time  (HH:MM)
              MOVE      OPCNCTYP,OBACTYP     * Clinic Type
              MOVE      OPCNURNO,OBAURNO     * U/R Number
              MOVE      OPCNVTYP,OBAVISIT    * Visit Type (N,R,S)(CV)
              MOVE      OPCNOUTN,DOBAOUTN    * Outpatient Number
              MOVE      OPCNOUTN,OBAOUTNO    * Outpatient Number
            ENDIF
          ENDIF
.
          COMPARE   EIGHT,UPDATETY        * Cancelled appointment so exit
          GOTO      UPDCNT99 IF EQUAL     * as obaoutno is zero for empty slots
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,UPDCNT99
.
UPDCNT99  RETURN
+
.*******************************************************************************
.        Update linked outpatient booking
.*******************************************************************************
UPOB0000  PACK      KEY8,OBAOUTNO,SP70
          CALL      RDWTOPA2
          BRANCH    OVRCD,UPOB9999
.
          PACK      KEY19,WTOPURNO,WTOPCODE,WTOPCOUN,SP70
          CALL      RDWTTX11
          BRANCH    OVRCD,UPOB9999
.
          MOVE      "XG",CATEGORY
          MOVE      WTTXPAST,CODE
          CALL      GETCOD00
.
          MATCH     ANSA,TCINDC1
          IF        !@EQUAL
            MATCH     ANSB,TCINDC1
            GOTO      UPOB9999 IF NOT EQUAL
          ENDIF
.
          PACK      KEY19,WTOPURNO,WTOPCODE,WTOPCOUN,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,UPOB9999
.
          MOVE      WMBOOK,KEY8
          CALL      RDBKRX11
          BRANCH    OVRCD,UPOB9999
.
          MOVE      TCINDC2,KEY1            * Indicator 2 maps cat XG & BG
.
          PACK      DIM2,ANSB,ANSG,SP70
          PACK      KEY5,DIM2,SP70
          CALL      RDSCODE1
UPOB1000  CALL      RDKCODE1
          BRANCH    OVRCD,UPOB9999
.
          MATCH     TCODE,DIM2                    * Cat BG
          GOTO      UPOB9999 IF NOT EQUAL
.
          MATCH     "I",PTCOACTV                  * Skip inactive
          GOTO      UPOB1000 IF EQUAL
.
          MATCH     KEY1,TCINDC2                  * Booked/Attended
          GOTO      UPOB1000 IF NOT EQUAL
.
          MOVE      ACODE,BKRXUDF3
          CALL      UPBKRX11
.
UPOB9999  RETURN
+
.-----------------------------------------------------------
.         Update Change Audit file
.-----------------------------------------------------------
UAUD0000  MOVE      ADMISSNO,PMCAVISN        * Admission number
          PACK      PMCADATE,CCC,CYY,CMM,CDD
          REP       " 0",PMCADATE
          CLOCK     TIME,PMCATIME
.
          PACK      KEY24,PMCAVISN,PMCADATE,PMCATIME
          CALL      RAPMCAU1
          IF        OVRCD=1
            MOVE      USERID,PMCAWBID
            CALL      WRPMCAU1               * write a new record
            GOTO      UAUD9999
          ENDIF
.
.         If record already exit, just update the new code
.
          CALL      RDPMCAU1
          BRANCH    OVRCD,UAUD9999
.
          UNPACK    KEY14,PMCANCLM         * New claim code
          MOVE      USERID,PMCAWBID
          CALL      UPPMCAU1
UAUD9999  RETURN
+
.------------------------------------------------------------
. Update Booking
.------------------------------------------------------------
BOKUPD00  MOVE      SP70,OLDADCS
          MATCH     SP70,NEWSLOTK
          IF        !@EQUAL
            MOVE      NEWSLOTK,CASEKEYS
            MOVE      CASEKEYS,KEY28
            CALL      RDBOKA1
          ENDIF
.
          PACK      CASEKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,DOBASLOT,SP70
.
.         MATCH     "1",OTCNINTR       * Not using visit based interpreter req
.         IF        !@EQUAL
.           CALL      INTUPD00               * Interpreter Table Processing
.         ENDIF
.
          MOVE      ZERO,EXIT
          COMPARE   ZERO,FLGOTBOK      * Any Booking Fields Updated
          GOTO      BOKUPD99 IF EQUAL  * No
.
          MOVE      CASEKEYS,KEY28
          CALL      RDBOKA1
          BRANCH    OVRCD,BOKUPD91
.
          MOVE      OBAVISIT,OLDVTYP
          MOVE      OBAOUTNO,SAVADMNO     * Save original admission number
          MOVE      OBACOMP,SAVBCOMP      * Save original claim code
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,BOKUPD92
          MOVE      OBACOMP,SAVCOMP
.
          IF        CCCNSVHM = 1
            CALL      SAVE0000      * for SVHM Transition II extract 7
          ENDIF
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDOTXSC1
          IF        OVRCD=1
            CALL      CLOUTXSC         * Clear File fileds
          ENDIF
.
          MOVE      TWO,AUDIFLAG
          CALL      AUDOTBOA  * write audit A
          CALL      AUDOTBOB  * write audit B
.
          MOVE      OBAPRTY,SAOTPRIO
          MOVE      OTBBRANK,SAOTRANK
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDDIAG1
          MOVE      OVRCD,DIAGOVR
          IF        OVRCD=1
            MOVE      OBAOUTNO,OPDIOUTN
            MOVE      SP70,OPDICODE
            MOVE      SP70,OPDIDESC
            MOVE      SP70,OPDICOD2
            MOVE      SP70,OPDIDES2
            MOVE      SP70,OPDICOD3
            MOVE      SP70,OPDIDES3
            MOVE      SP70,OPDICOD4
            MOVE      SP70,OPDIDES4
            MOVE      SP70,OPDICOD5
            MOVE      SP70,OPDIDES5
            MOVE      SP70,OPDISPAR
          ENDIF
.
          MOVE      CASEKEYS,KEY28
          CALL      RDBOKA1
          BRANCH    OVRCD,UPDBOK95
          MOVE      OTBBADCS,OLDADCS
.
          PACK      SESSKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      SUBBOK00
.
          MOVE      OTBBDPTM,SAVEDPTM       * Save discharge time
.
          IF        UPDATETY=TWO
            MOVE      OTBBGLDT,DNASAVGD
            MOVE      OTBBSNGL,DNASAVSL
          ENDIF
.
          CALL      MOVBB000
.
          COMPARE   SIX,UPDATETY
          IF        @EQUAL
            MATCH     Z70,OUTBB002
            IF        !@EQUAL
              MATCH     SAVCOMP,OUTBB002
              IF        !@EQUAL
                MOVE      OBACOMP,KEY3
                CALL      CINS0000             * Check Claim insurance details
              ENDIF
            ENDIF
          ENDIF
.
          IF        UPDATETY=TWO
            MOVE      DNASAVGD,OTBBGLDT
            MOVE      DNASAVSL,OTBBSNGL
          ENDIF
.
          MATCH     SP70,SAVEDPTM
          IF        @EQUAL
            MATCH     SP70,OTBBDPTM
            IF        !@EQUAL & !@EOS
              MOVE      ONE,DISCFLAG        * Send A03 dicharge message
            ENDIF
          ELSE
            MATCH     SP70,OTBBDPTM
            IF        @EQUAL | @EOS
              MOVE      TWO,DISCFLAG        * Send A13 cancel dicharge message
            ENDIF
          ENDIF
.
          MOVE      OBAVISIT,NEWVTYP
.
          CALL      CHRT0000                * Clear send letter if chart review
.
          CALL      UPBOKA1
          CALL      UPBOKB1
.
          IF        BILLFLAG=1
            MOVE      OBAOUTNO,PVIBILL
            CALL      CBIL0000            * Check if billing need to be recalc.
          ENDIF
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDPMVX11
          IF        OVRCD=0
              CALL      IBACLOCK
              PACK      PMVXLUPD,CCC,CYY,CMM,CDD
              REP       " 0",PMVXLUPD
              MOVE      CTIMEIS,PMVXLUPT
              MOVE      USERID,PMVXWEBU
              CALL      UPPMVX11
          ENDIF
.
          COMPARE   ONE,PTCNHDPS            * New Zealand?
          GOTO      BOKUPD30 IF NOT EQUAL
.
.         Update or write to Admission/Discharge Transfer Destination (PTDADFD)
.         file if system parameter PTCNUADT is on ------
.
          BRANCH    PTCNUADT,BOKUPD10
          GOTO      BOKUPD30
.
BOKUPD10  MATCH     Z70,TRNSFSRC            * Transfer Source not on page
          GOTO      BOKUPD30 IF EQUAL       * skip write/update
.
          PACK      KEY8,OBAOUTNO,SP10
          CALL      RDPTDAD1
          BRANCH    OVRCD,BOKUPD20
.
          MOVE      TRNSFSRC,PTDADCTS
          CALL      UPPTDAD1                * update PTDADFD record
          GOTO      BOKUPD30
.
BOKUPD20  MOVE      SP5,PTDAADTS            * clear Admission Transfer Source
          MOVE      TRNSFSRC,PTDADCTS
          CALL      WRPTDAD1                * write a PTDADFD record
.
BOKUPD30  IF        CCCNSVHM = 1
            OPEN      CCIEX7A1,"cciex7af"
            CALL      TRNSII00
            CLOSE     CCIEX7A1
          ENDIF
.
          CALL      XWPCOM00   *bokupd
          CALL      UPVCM000
          CALL      NWVCM000
.
          MOVE      "013",KEY3
          CALL      PATINS00   * Patient Instructions
.
          PACK      SESSKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      ADDBOK00                 * Increment Booking Count
.
          MATCH     Z70,OUTBB052
          IF        !@EQUAL
            MOVE      OBAOUTNO,KEY8
            CALL      RDOTBOC1
            IF        OVRCD=0
              MOVE      OUTBB052,OTBCRDAT
              CALL      UPOTBOC1
            ELSE
              MOVE      OUTBB052,OTBCRDAT
              MOVE      SP70,OTBCSPAR
              CALL      WROTBOC1
            ENDIF
          ENDIF
.
          IF        UPDATETY=4
.
            MOVE      SP70,SAVRFDAT                * I-48256
            MOVE      OBAOUTNO,SAVRFOUT
            MOVE      ADMISSNO,KEY8
            CALL      RDOTBOC1
            IF        OVRCD=0
              MATCH     SP70,OTBCRDAT
              IF        !@EQUAL
                MOVE      OTBCRDAT,SAVRFDAT
                MOVE      SAVRFOUT,OBAOUTNO
                MOVE      OBAOUTNO,KEY8
                CALL      RDOTBOC1
                IF        OVRCD=0
                  MOVE      SAVRFDAT,OTBCRDAT
                  CALL      UPOTBOC1
                ELSE
                  MOVE      SAVRFDAT,OTBCRDAT
                  MOVE      SP70,OTBCSPAR
                  CALL      WROTBOC1
                ENDIF
              ENDIF
            ENDIF
.                                                  * end I-48256
            MOVE      SAVRFOUT,OBAOUTNO
            MOVE      OBAOUTNO,ADMISSNO
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP10
          CALL      RDVISA1                    * Read visit file
          IF        OVRCD=1
            CALL      CLPATVIS
          ENDIF
.
          PACK      KEY8,OBAURNO,SP10
          CALL      RDMAST1                    * Read PMI master detail
          IF        OVRCD=1
            CALL      CLPATMAS
          ENDIF
.
          PACK      KEY8,OBAURNO,SP10
          CALL      RDPMPX21                   * Read PMI Extn file
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          CALL      SESDET00
          IF        EXIT=1
            MOVE      WBSEHOSP,OTHEHOSP        * Read session details to get
          ENDIF                                * hospital code
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMVX11
          IF        OVRCD=0
            CALL      MVVXTF00
            MOVE      USERID,PMVXWEBU
            PACK      PMVXLUPD,CCC,CYY,CMM,CDD
            REP       " 0",PMVXLUPD
            CLOCK     TIME,PMVXLUPT
            MOVE      PVIDATE,PMVXVSDT
            MOVE      PPOST,PMVXPOST
            MOVE      OTHEHOSP,PMVXMHOS
.
            MATCH     "1",RESETCAP
            IF        @EQUAL
              MOVE      ZERO,PMVXCONF          * Reset confirmed appointment
              MOVE      SP70,PMVXCNID
              MOVE      SP70,PMVXCNDT
            ENDIF                              * flag
.
            CALL      GTASGC00                 * SLA/ASGC code
            MOVE      PMPXABRG,PMVXABRG
            CALL      UPPMVX11
          ELSE
            CALL      CLPMSVX1
            CALL      MVVXTF00
            MOVE      ADMISSNO,PMVXVISN
            MOVE      USERID,PMVXWEBC
            PACK      PMVXCDTE,CCC,CYY,CMM,CDD
            REP       " 0",PMVXCDTE
            CLOCK     TIME,PMVXCTIM
            MOVE      PVIDATE,PMVXVSDT
            MOVE      PPOST,PMVXPOST
            MOVE      OTHEHOSP,PMVXMHOS
            CALL      GTASGC00                 * SLA/ASGC code
            MOVE      SP70,PMVXPOEC
            MOVE      SP70,PMVXPGID
            MOVE      SP70,PMVXPILC
            MOVE      PMPXABRG,PMVXABRG
            CALL      WRPMVX11
          ENDIF
.
          MATCH     "1",OTCNINTR       * Not using visit based interpreter req
          IF        !@EQUAL
            CALL      INTUPD00               * Interpreter Table Processing
          ENDIF
.
          MATCH     "1",OTCNINTR             * Using visit based interpreter req
          IF        @EQUAL
            MATCH     "1",PMVXINTR
            IF        @EQUAL
              CALL      INTUPD00               * Interpreter Table Processing
            ELSE
              CALL      INTDEL00               * Delete Interpretor Details
            ENDIF
          ENDIF
.
          PACK      KEY8,OBAOUTNO,SP70
          IF        DIAGOVR=0
            CALL      UPDIAG1
          ELSE
            CALL      WRDIAG1
          ENDIF
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDOTPRC1
          IF        OVRCD=1
            CALL      CLOUTPRC
            MOVE      OBAOUTNO,OTPROUTN
            CALL      MVOTPC00
            CALL      WROTPRC1
          ELSE
            CALL      MVOTPC00
            CALL      UPOTPRC1
          ENDIF
.
          CALL      UPMV0000
          CALL      CMBS0000                * Check for CMBS items
          CALL      WEDV0000                * Write EDWARD visit alteration
.
          MOVE      THREE,AUDIFLAG
          CALL      AUDOTBOA  * write audit A
          CALL      AUDOTBOB  * write audit B
.
          CALL      WRTHIS00
.
          CALL      DOCLMN00                * remove non-compensible claims
.
          MATCH     OLDVTYP,NEWVTYP
          GOTO      BOKUPD40 IF EQUAL
          CALL      EXTSLT00
          CALL      ADJNEW00
          CALL      ADJOLD00
.
BOKUPD40  MATCH     "1",IBCNUMCI
          GOTO      BOKUPD90 IF NOT EQUAL
.
          MATCH     OLDADCS,OTBBADCS        * Check if doctor seen had changed
          GOTO      BOKUPD50 IF NOT EQUAL
.
.         Check if payee provider has changed
.
          PACK      KEY18,OBASITE,OBACLIN,OBADAY,OBASTRT,SP70
          CALL      RDMASA1              * read clinic master for med.prac.
          BRANCH    OVRCD,BOKUPD90
.
          OPEN      PRIPRAC1,"pripracf"
          MOVE      OTMAMPRC,KEY6
          CALL      RDPRPR1              * read med prac for mci and payee
          BRANCH    OVRCD,BOKUPD90
.
          PACK      KEY16,OBAOUTNO,Z70
          CALL      RSHCCLM2
          CALL      RPHCCLM2                * read last hic claim record
          BRANCH    OVRCD,BOKUPD90
          MATCH     DOBAOUTN,HCCLVISN
          GOTO      BOKUPD90 IF NOT EQUAL   * Different visit number
.
          MATCH     PRPRPYEE,HCCLPYEE
          GOTO      BOKUPD50 IF NOT EQUAL   * Service provider is not blank
          MATCH     SP70,HCCLPYEE           * if payee provider blank
          GOTO      BOKUPD90 IF NOT EQUAL   * use service prov as the payee
.
BOKUPD50  CALL      HICCLAIM                * Fixup hic's file
.
BOKUPD90  MOVE      ZERO,EXIT
          GOTO      BOKUPD99
.
BOKUPD91  MOVE      ONE,EXIT
          GOTO      BOKUPD99
BOKUPD92  MOVE      TWO,EXIT
          GOTO      BOKUPD99
BOKUPD99  RETURN
+
.-----------------------------------------------------------------------------
.         If patient changed to non-comp. claim, delete any claim details
.-----------------------------------------------------------------------------
.
.         Set the claim type indicator if this is a claim
.
DOCLMN00  MATCH     "1",PTCNXCOM              * if using Extra Compensation
          IF        @EQUAL
            CALL      CPRA0000                * check if we need to update PRFA
            CALL      CIND0000           * Check prefix for Deceased patient
            GOTO      DOCLMN99
          ENDIF
.
          PACK      KEY5,ANSC,ANSL,OBACOMP,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,DOCLMN99
.
.         Check the indicators for a W, M, or V (these are the claims)
.
          MOVE      ZERO,FORM2
DOCLMN10  ADD       ONE,FORM2
          COMPARE   SIX,FORM2
          GOTO      DOCLMN90 IF NOT LESS
.
          LOAD      ANS,FORM2,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
          CMATCH    "W",ANS
          GOTO      DOCLMN99 IF EQUAL
          CMATCH    "M",ANS
          GOTO      DOCLMN99 IF EQUAL
          CMATCH    "V",ANS
          GOTO      DOCLMN99 IF EQUAL
          CMATCH    "C",ANS
          GOTO      DOCLMN99 IF EQUAL
          GOTO      DOCLMN10
.
DOCLMN90  OPEN      PATWC1A1,"patwc1af"
          OPEN      PATWMAB1,"patwmabf"
          OPEN      PATWVET1,"patwvetf"
.
          CALL      DEWCOM00         * Delete Workers Comp.
          CALL      DEWMAB00         * Delete TAC
          CALL      DEWVET00         * Delete Veteran affairs
.
DOCLMN99  RETURN
+
.-----------------------------------------------------------------------------
.         Delete Workers comp. details
.-----------------------------------------------------------------------------
.
DEWCOM00  COMPARE   ONE,PTCNHDPS           * Is it for NZ?
          GOTO      DEWCOM10 IF NOT EQUAL  * Not NZ; proceed to delete WC record
.
          MOVE      URNUMBER,CHWCURNO
          MOVE      ADMISSNO,CHWCADMN
          PROC      CHKWCCLM           * check for multiple WC claims records
          BRANCH    EXIT,DEWCOM10
.
.         Only one record with the ACC number, so we just update the
.         Claim Status to "Cancelled" instead of deleting the patwc1af record.
.
          COMPARE   ONE,FORM1            * one record found in CHKWCCLM
          IF        @EQUAL
            MOVE      ADMISSNO,KEY8
            CALL      RDPMWX11
            BRANCH    OVRCD,DEWCOM99
.
            MOVE      THREE,PMWXCSTA     * set Claim Status to "Cancelled"
            CALL      UPPMWX11
          ENDIF
.
          CALL      MVACCREM           * Add record ACC Audit file
          GOTO      DEWCOM99
.
DEWCOM10  MOVE      ADMISSNO,KEY8
          CALL      RDWCOM1
          COMPARE   ZERO,OVRCD
          IF        @EQUAL
            IF        PTCNHDPS=1
              CALL      MVACCREM           * Add record ACC Audit file
            ENDIF
            CALL      DEWCOM1
.
.           If we are sending ACC details in PV1-20, then we need to
.           trigger an A08 message for the visit to reflect that this is
.           no longer an ACC patient
.
            MATCH     "1",PTCNH7AC
            IF        @EQUAL
              CALL      PMIGTNID               * get national id for dgate write
              MOVE      NMPNUMB,PTNINMPI
              MOVE      TWENTY1,HL7TRGID
              MOVE      SP8,HL7INCLD
              PROC      DGCLICOB                 * send update O/P details
            ENDIF
          ENDIF
.
          MOVE      ADMISSNO,KEY8
          CALL      RDPMWX11
          COMPARE   ZERO,OVRCD
          CALL      DEPMWX11 IF EQUAL
.
DEWCOM99  RETURN
+
.-----------------------------------------------------------------------------
.         Delete TAC details
.-----------------------------------------------------------------------------
.
DEWMAB00  MOVE      ADMISSNO,KEY8
          CALL      RDWMAB1
          COMPARE   ZERO,OVRCD
          CALL      DEWMAB1 IF EQUAL
.
DEWMAB99  RETURN
+
.-----------------------------------------------------------------------------
.         Delete Veteran Affairs details
.-----------------------------------------------------------------------------
.
DEWVET00  MOVE      ADMISSNO,KEY8
          CALL      RDWVET1
          COMPARE   ZERO,OVRCD
          CALL      DEWVET1 IF EQUAL
.
DEWVET99  RETURN
+
.-----------------------------------------------------------------------------
. Add record to ACC Audit file when patient changed to non-comp. claim
.-----------------------------------------------------------------------------
MVACCREM  MOVE      ADMISSNO,KEY8
          CALL      RDWCOM1
          BRANCH    OVRCD,MVACCR99
.
          CALL      CLACCAUD
          MATCH     WCCLMNO,Z70
          IF        !@EQUAL
            MOVE      WCCLMNO,ACAUCLMN              * Claim Number
          ENDIF
.
          CALL      IBACLOCK
          PACK      ACAUDATE,CCC,CYY,CMM,CDD        * Date
          REP       " 0",ACAUDATE
          MOVE      CTIMEIS,ACAUTIME
          MOVE      USERID,ACAUWUID                 * Web UserId
.
          MATCH     ADMISSNO,Z70
          IF        !@EQUAL
            MOVE      ADMISSNO,ACAUADMN             * Admission No
          ENDIF
.
          MOVE      "D",ACAUAUTY                    * Audit Type
          MOVE      "A",ACAUTREC                    * ACC Type of Record
.
MVACCR10  PACK      KEY54,ACAUCLMN,ACAUADMN,ACAUDATE,ACAUTIME,ACAUWUID
          CALL      RAACAUD1
          IF        OVRCD=1
            CALL      WRACAUD1
            GOTO      MVACCR99
          ELSE
            CALL      IBACLOCK                    * Set new date and time and
            PACK      ACAUDATE,CCC,CYY,CMM,CDD    * try write again
            REP       " 0",ACAUDATE
            CLOCK     TIME,CTIMEIS
            PACK      ACAUTIME,CTIMEIS
            REP       " 0",ACAUTIME
            GOTO      MVACCR10
          ENDIF
.
MVACCR99  RETURN
+
.------------------------------------------------------------------------------
.         Check claim code indicator17 - No prefix for Deceased patient
.------------------------------------------------------------------------------
CIND0000  COMPARE   ONE,PCEASE
          GOTO      CIND9999 IF NOT EQUAL
.
          MATCH     "1",PTCNDEES
          GOTO      CIND9999 IF NOT EQUAL
          MATCH     SP70,PTCNDDES
          GOTO      CIND9999 IF EQUAL
.
          MOVE      ADMISSNO,KEY8
          CALL      RDRESP1
          BRANCH    OVRCD,CIND9999
.
          MATCH     "Parent of",PKNAME
          GOTO      CIND9999 IF EQUAL          * No prefix
.
          MATCH     SP70,OBACOMP
          GOTO      CIND9000 IF EQUAL
.
          PACK      KEY5,ANSC,ANSL,OBACOMP,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CIND9000
.
.         The following Claim codes don't have pmsextaf record
.
          MATCH     "H",TCINDC1
          GOTO      CIND9999 IF EQUAL          * Private - No prefix
          MATCH     SP70,TCINDC1
          GOTO      CIND2000 IF EQUAL          * Blank
          MATCH     "J",TCINDC1
          GOTO      CIND2000 IF EQUAL          * Private Uninsured
          MATCH     "P",TCINDC1
          GOTO      CIND2000 IF EQUAL          * Public/All Funding Source
.
          PACK      KEY11,ADMISSNO,OBACOMP,SP70
          CALL      RDPMEXT1
          BRANCH    OVRCD,CIND9000
.
.         INDIC1=Blank,O,E,G,J,P & INDIC17=Blank -Proceed with the Estate prefix
.
          MATCH     "O",TCINDC1
          GOTO      CIND1000 IF EQUAL          * Compsensable
          MATCH     "E",TCINDC1
          GOTO      CIND1000 IF EQUAL          * Overseas Student
          MATCH     "G",TCINDC1
          GOTO      CIND1000 IF EQUAL          * Overseas Visitor
.
          MATCH     "V",TCINDC1
          GOTO      CIND1000 IF EQUAL          * Veterans Affairs
.
.         INDIC1=A,F,M,H,S,W & INDIC17=D - Ignore the Estate prefix
.
          MATCH     "A",TCINDC1
          GOTO      CIND3200 IF EQUAL          * ADF
          MATCH     "F",TCINDC1
          GOTO      CIND3200 IF EQUAL          * Foreign Defence
          MATCH     "M",TCINDC1
          GOTO      CIND3200 IF EQUAL          * Motor Vehicle
          MATCH     "S",TCINDC1
          GOTO      CIND9999 IF EQUAL          * Shipping
          MATCH     "W",TCINDC1
          GOTO      CIND9999 IF EQUAL          * Workers Compensation
          GOTO      CIND9000
.
CIND1000
          MATCH     "O",TCINDC1
          GOTO      CIND2000 IF NOT EQUAL
.
.         If Billing address is not blank, No Prefix
.
          MATCH     "1",PMEXPOLC
          GOTO      CIND9999 IF EQUAL         * Police Officer checked(NoPrefix)
.
          MATCH     SP70,PMEXICOD
          GOTO      CIND9999 IF NOT EQUAL     * Insurance Code entered(NoPrefix)
.
CIND2000  MATCH     SP70,TCINDC17
          GOTO      CIND9000 IF EQUAL          * Proceed with the prefix
          GOTO      CIND9999
.
.------------------------------------------------------------------------------
.         ADF,Motor Vehicle,Foreign Defence
.
CIND3200  MATCH     SP70,PMEXICOD
          GOTO      CIND9999 IF NOT EQUAL      * has Insurance details
          MATCH     SP70,PMEXCAD1
          GOTO      CIND5000 IF NOT EQUAL
          GOTO      CIND9999
.
CIND5000  MATCH     "D",TCINDC17
          GOTO      CIND9000 IF NOT EQUAL      * Proceed with the prefix
          GOTO      CIND9999
.
CIND9000  MATCH     SP70,PKNAME
          GOTO      CIND9999 IF EQUAL
.
          SCAN      PTCNDDES,PKNAME
          GOTO      CIND9999 IF EQUAL          * already has prefix
.
          UNPACK    PKNAME,KEY80
          STRIP     PTCNDDES
          MOVE      PTCNDDES,KEY20
.
          PACK      PKNAME,KEY20,SP1,KEY80,SP30
          CALL      UPPTRES1
.
CIND9999  RETURN
+
.------------------------------------------------------------
. Get claim details from the original visit
.------------------------------------------------------------
GCLM0000  CALL      CLRCLM00
          MATCH     SP3,SAVBCOMP
          GOTO      GCLM9999 IF EQUAL       * no claim code
.
.         Set the claim type indicator if this is a claim
.
          PACK      KEY5 WITH ANSC,ANSL,SAVBCOMP
          CALL      RDCODE1
          BRANCH    OVRCD OF GCLM9999
.
          MATCH     "1",PTCNXCOM            * Using extra compensable details
          GOTO      GCLM8000 IF EQUAL
.
.         Check the indicators for a W, M, or V (these are the claims)
.
          MOVE      ZERO,FORM2
GCLM3000  ADD       ONE,FORM2
          COMPARE   SIX,FORM2
          GOTO      GCLM9999 IF NOT LESS
.
          LOAD      ANS USING FORM2 OF TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
          CMATCH    "W",ANS
          GOTO      GCLM4000 IF EQUAL
          CMATCH    "M",ANS
          GOTO      GCLM5000 IF EQUAL
          CMATCH    "V",ANS
          GOTO      GCLM6000 IF EQUAL
          GOTO      GCLM3000
.
GCLM4000  OPEN      PATWC1A1,"patwc1af"
          MOVE      SAVADMNO,KEY8
          CALL      RDWCOM1            * read previous Workers Comp details
          IF        OVRCD=0
            MOVE      OBAOUTNO,KEY8
            MOVE      OBAOUTNO,WCADMNO
            MOVE      OBADATE,PTWCVDAT
            CALL      RDAWCOM1
            IF        OVRCD=1
              CALL      WRWCOM1
.
.             If we are sending ACC details in PV1-20, then we need to
.             trigger an A08 message for the visit to reflect that this is
.             now an ACC patient
.
              MATCH     "1",PTCNH7AC
              IF        @EQUAL
                MATCH     "OUTWEB02",PRGID
                IF        @EQUAL
                  IF        REPORTNO = 8 & UPDATETY = 15
                    GOTO      GCLM4100           * Skip if bulk follow up
                  ENDIF
                ENDIF
.
                COMPARE  "4",UPDATETY          * Single follow up
                IF        !@EQUAL
                  CALL      PMIGTNID           * get national id for dgate write
                  MOVE      NMPNUMB,PTNINMPI
                  MOVE      FIVE,HL7TRGID
                  MOVE      SP8,HL7INCLD
                  PROC      DGCLICOB           * send update O/P details
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
GCLM4100  MOVE      SAVADMNO,KEY8
          CALL      RDPMWX11           * read ext.workers comp file(prev adm)
          IF        OVRCD=0
            MOVE      OBAOUTNO,KEY8
            MOVE      OBAOUTNO,PMWXVISN
            CALL      RAPMWX11
            IF        OVRCD=1
              CALL      WRPMWX11
            ENDIF
          ENDIF
          GOTO      GCLM9999
.
GCLM5000  OPEN      PATWMAB1,"patwmabf"
          MOVE      SAVADMNO,KEY8
          CALL      RDWMAB1            * read previous TAC details
          IF        OVRCD=0
            MOVE      OBAOUTNO,KEY8
            MOVE      OBAOUTNO,MADMNO
            MOVE      OBADATE,PTWMVDAT
            CALL      RDAWMAB1
            IF        OVRCD=1
              CALL      WRWMAB1
            ENDIF
          ENDIF
          GOTO      GCLM9999
.
GCLM6000  OPEN      PATWVET1,"patwvetf"
          MOVE      SAVADMNO,KEY8
          CALL      RDWVET1
          IF        OVRCD=0
            MOVE      OBAOUTNO,KEY8
            CALL      RDAWVET1
            IF        OVRCD=1
              CALL      WRWVET1
            ENDIF
          ENDIF
          GOTO      GCLM9999
.
GCLM8000  PACK      KEY11,SAVADMNO,SAVBCOMP,SP70
          CALL      RDPMEXT1                     * Copy compensable details
          IF        OVRCD=0
            MOVE      OBAOUTNO,PMEXVISN
            PACK      KEY11,PMEXVISN,PMEXCLAM,SP70
            CALL      RAPMEXT1
            IF        OVRCD=0
              MOVE      OBADATE,PMEXVDAT
              CALL      UPPMEXT1
            ENDIF
            IF        OVRCD=1
              MOVE      OBADATE,PMEXVDAT
              CALL      WRPMEXT1
            ENDIF
          ENDIF
.
GCLM9999  RETURN
+
.******************************************************************************
.*                 WRTHIS00 - Write to the Outpatient History
.******************************************************************************
WRTHIS00  READ      CONTROLF,SEVENTY9;*138,PTCNURHA
          COMPARE   ONE,PTCNURHA
          GOTO      WRTHIS99 IF NOT EQUAL
.
          MATCH     SAOTPRIO,OBAPRTY     * Check if anything has changed
          GOTO      WRTHIS50 IF NOT EQUAL
          MATCH     SAOTRANK,OTBBRANK
          GOTO      WRTHIS50 IF NOT EQUAL
.
          GOTO      WRTHIS99          * No Changes
.
WRTHIS50  PACK      KEY8,CCC,CYY,CMM,CDD,SP10
          REP       " 0",KEY8
          PACK      KEY28,OBAURNO,OBAOUTNO,KEY8,Z70
          CALL      RSOTHIS1
          CALL      RPOTHIS1
          BRANCH    OVRCD,WRTHIS60
          MATCH     OBAURNO,OTHIURNO
          GOTO      WRTHIS60 IF NOT EQUAL
          MOVE      OBAOUTNO,DIM8
          MATCH     DIM8,OTHIEVNT
          GOTO      WRTHIS60 IF NOT EQUAL
          MATCH     KEY8,OTHIEDAT
          GOTO      WRTHIS60 IF NOT EQUAL
          ADD       ONE,OTHIUCNT
          GOTO      WRTHIS70
.
WRTHIS60  MOVE      OBAURNO,OTHIURNO
          MOVE      OBAOUTNO,OTHIEVNT
          PACK      OTHIEDAT,CCC,CYY,CMM,CDD,SP10
          REP       " 0",OTHIEDAT
          MOVE      ONE,OTHIUCNT
.
WRTHIS70  MOVE      OBAPRTY,OTHIPRIO
          MOVE      OTBBRANK,OTHIRANK
          PACK      OTHISPAR,SP20,SP20,SP20
.
          PACK      KEY28,OTHIURNO,OTHIEVNT,OTHIEDAT,OTHIUCNT,SP20
          CALL      RAOTHIS1
          IF        OVRCD=1
            CALL      WROTHIS1
          ENDIF
.
WRTHIS99  RETURN
+
.-----------------------------------------------------------
. Write EDWARD outpatient visit alteration record
.------------------------------------------------------------
WEDV0000  MATCH     SP70,PTCNNSSI        * no edward source system
          GOTO      WEDV9999 IF EQUAL
.
          MATCH     "00000000000000000000",PTCNNSSI  * no edward source system
          GOTO      WEDV9999 IF EQUAL
.
          MOVE      OBAOUTNO,PMAWVISN
          MOVE      FIVE,PMAWTYPE
          PACK      PMAWOLDV,SP70,SP70,SP70,SP70
          PACK      PMAWNEWV,SP70,SP70,SP70,SP70
.
          CALL      IBACLOCK
          PACK      PMAWCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMAWCDAT
          MOVE      "00:00:00",PMAWCTIM
          PACK      PMAWCUID,USERID
          PACK      PMAWSPAR,SP70,SP70
.
          PACK      KEY27,PMAWCDAT,PMAWCTIM,PMAWVISN,PMAWTYPE,SP70
          CALL      RAPMADW1
          IF        OVRCD=1
            CALL      WRPMADW1
          ELSE
            CALL      UPPMADW1
          ENDIF
.
WEDV9999  RETURN
+
.*******************************************************************************
. Delete Interpreter Table Record
. Input  - OBAURNO
.          OBAOUTNO
.*******************************************************************************
INTDEL00  PACK      KEY8,OBAURNO,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,INTDEL99
.
          MATCH     "1",OTCNINTR            * Using visit based interpreter req
          GOTO      INTDEL10 IF EQUAL
.
          MATCH     "1",PMPXINTR
          GOTO      INTDEL99 IF NOT EQUAL
.
INTDEL10  PACK      KEY8,OBAOUTNO
          CALL      RDVSINT1
          IF        OVRCD=0
            CALL      DEVSINT1           * Delete record from Int.Table(Cancel)
            MOVE      "D",INTAUDTY
            CALL      INTAUD00           * Add record to Int.Audit after Delete
          ENDIF
          MOVE      ZERO,EXIT
INTDEL99  RETURN
+
.******************************************************************************
.                Check if CCIEX7AF table needs to be updated
.******************************************************************************
TRNSII00  MOVE      CASEKEYS,KEY28
          CALL      RDBOKA1
          BRANCH    OVRCD,TRNSII99
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,TRNSII99
.
          MATCH     OBAOUTNO,SAVOUTNO
          GOTO      TRNSII80 IF NOT EQUAL
.
          MATCH     OBADATE,SAVDATE
          GOTO      TRNSII80 IF NOT EQUAL
.
          MATCH     OBAURNO,SAVURNO
          GOTO      TRNSII80 IF NOT EQUAL
.
          MATCH     OBATIME,SAVTIME
          GOTO      TRNSII80 IF NOT EQUAL
.
          MATCH     OBACLIN,SAVCLIN
          GOTO      TRNSII80 IF NOT EQUAL
.
          MATCH     OTBBDEPT,SAVBDEPT
          GOTO      TRNSII80 IF NOT EQUAL
.
          MATCH     OBASRCR,SAVSRCR
          GOTO      TRNSII80 IF NOT EQUAL
.
          MATCH     OBACOMP,SAVCOMP
          GOTO      TRNSII80 IF NOT EQUAL
.
          MATCH     OBADOCT,SAVDOCT
          GOTO      TRNSII80 IF NOT EQUAL
.
          MATCH     OTBBRFGP,SAVRFGP
          GOTO      TRNSII80 IF NOT EQUAL
.
          GOTO      TRNSII99
.
TRNSII80  MOVE      ANST,CLEXSTAT
          MOVE      TWO,CLEXTYPE
          MOVE      OBAOUTNO,CLEXVISN
          PACK      KEY11,CLEXSTAT,CLEXTYPE,CLEXVISN
          CALL      RDCLEX71
          IF        OVRCD = 1
            CALL      WRCLEX71
          ENDIF
.
TRNSII99  RETURN
+
.******************************************************************************
.                Save outpatient variables for Transition II
.******************************************************************************
SAVE0000  MOVE      OBAOUTNO,SAVOUTNO
          MOVE      OBADATE,SAVDATE
          MOVE      OBAURNO,SAVURNO
          MOVE      OBATIME,SAVTIME
          MOVE      OBACLIN,SAVCLIN
          MOVE      OTBBDEPT,SAVBDEPT
          MOVE      OBASRCR,SAVSRCR
          MOVE      OBACOMP,SAVCOMP
          MOVE      OBADOCT,SAVDOCT
          MOVE      OTBBRFGP,SAVRFGP
SAVE9999  RETURN
+
.------------------------------------------------------------
. Check if billing need to be recalculated
.------------------------------------------------------------
CBIL0000  COMPARE   FOUR,OBASTAT
          GOTO      CBIL9000 IF NOT EQUAL * Not attended
.
          CALL      ABFO0000             * Check for ABF invoice
          IF        EXIT=1
            BRANCH    ABFFLAG,CBIL8400
            GOTO      CBIL9000           * Charge ABF - exit
          ENDIF
.
.         Check type charging, if using patnip then recalculate
.
          COMPARE   ZERO,OTCNFTYP
          GOTO      CBIL9999 IF NOT EQUAL * Not using patnip
.
          MATCH     SP3,OTBBCIND
          IF        @EQUAL
            MOVE      OMACIND,OTBBCIND      * default from master clinic record
          ENDIF
.
          PACK      KEY13,TWO,OTBBCIND,PTYPE,OBACOMP,OBAVISIT
.
.         Get the O/P charging record that has not been invoiced
.
          PACK      KEY14,OBAOUTNO,SP20
          CALL      RSPMMTI1
CBIL6000  CALL      RKPMMTI1
          BRANCH    OVRCD,CBIL8000
.
          MATCH     DOBAOUTN,PMMIVISN
          GOTO      CBIL8000 IF NOT EQUAL  * different outpatient number
.
          MATCH     SP9,PMMIITEM
          GOTO      CBIL6000 IF NOT EQUAL  * it's not an outpatient charge rec.
.
          OPEN      PATNIPB1,"patnipbf"
          CALL      RDNIPB1
          CLOSE     PATNIPB1
          IF        OVRCD=0
            MOVE      NBITEM,PMMIMGRP
            MOVE      NBDESC,PMMIDESC
            MOVE      NBAMNT,PMMIAMTT
            MOVE      NBAMNT,PMMIAMTP
            MOVE      ZERO,PMMIRBAT
            PACK      PMMIDUPD,CCC,CYY,CMM,CDD
            REP       " 0",PMMIDUPD
            CALL      IBACLOCK
            MOVE      CTIMEIS,PMMITUPD
            MOVE      WBSEUID,PMMIWUSR
            CALL      UPPMMTI1
            GOTO      CBIL8400
          ENDIF
          GOTO      CBIL9000                 * No charges
.
.         Can not find charge record, check if Service fee already been invoiced
.         if not, create one
.
CBIL8000  CALL      CFEE0000
          BRANCH    EXIT,CBIL9999            * invoice raised already
.
          OPEN      PATNIPB1,"patnipbf"
          CALL      RDNIPB1
          CLOSE     PATNIPB1
          IF        OVRCD=0
            MOVE      OBAOUTNO,PMMIVISN
            MOVE      OBAURNO,PMMIURNO
            MOVE      " 2",PMMISYST
            MOVE      SP10,PMMIITEM
            MOVE      NBDESC,PMMIDESC
            MOVE      SP70,PMMIDES2
            MOVE      OBADATE,PMMITDAT
            MOVE      "3",PMMIRTYP
            MOVE      SP70,PMMIREFN
            MOVE      NBAMNT,PMMIAMTT
            MOVE      PMMIAMTT,PMMIAMTP
            MOVE      ZERO,PMMIRBAT
            MOVE      ZERO,PMMIAMTG
            MOVE      ZERO,PMMIAMTH
            UNPACK    SP70,PMMITDOC,PMMIODOC,PMMISESS
.
            MOVE      NBITEM,PMMIMGRP
            UNPACK    SP70,PMMIBTCH,PMMIGSTC
            MOVE      ZERO,PMMIINVN
            MOVE      ZERO,PMMISERV
            MOVE      ZERO,PMMIGSTA
            MOVE      ZERO,PMMIGSTM
            MOVE      "0",PMMIMVBR             * Mechanical ventilation billing
            MOVE      WBSEUID,PMMIWUSR
.
CBIL8200    PACK      KEY8,OBAOUTNO
            CALL      TRVISA1                  * Get next transaction number
            MOVE      PVITRAN,PMMITRAN
            PACK      KEY14,PMMIVISN,PMMITRAN
            CALL      RAPMMTI1
            COMPARE   ZERO,OVRCD
            GOTO      CBIL8200 IF EQUAL
.
            MOVE      SP70,PMMICNTR
            MOVE      SP70,PMMISUNQ
            MOVE      SP70,PMMIINCT
            MOVE      SP70,PMMISUBN
            MOVE      SP70,PMMIEDAD
            MOVE      SP70,PMMISVTM
            MOVE      SP70,PMMIDUPD
            MOVE      SP70,PMMITUPD
            MOVE      SP70,PMMIWUSR
            PACK      PMMIDTCR,CCC,CYY,CMM,CDD
            REP       " 0",PMMIDTCR
            CALL      IBACLOCK
            MOVE      CTIMEIS,PMMITMCR
            MOVE      WBSEUID,PMMIIDCR
            MOVE      SP70,PMMITMNO
            MOVE      SP70,PMMIPMBS
            MOVE      SP70,PMMIRBRS
            MOVE      SP70,PMMICTYP
            PACK      PMMIACOI,SP70       * After Care Override Indicator
            PACK      PMMIDSOV,SP70       * Duplicate Service Override
            PACK      PMMISTXT,SP70       * Service Text
            PACK      PMMILSPN,SP70       * Location Specific Practice No(LSPN)
            PACK      PMMIMPOV,SP70       * Multi Procedure Override
            PACK      PMMINMPT,SP70       * Number of Patients Seen
            PACK      PMMISDCD,SP70       * Self Deem Code (Cat Sd)
            PACK      PMMITDUR,SP70       * Time Duration (Mins)
            PACK      PMMIROVR,SP70       * Restricted Override Code (Cat Ro)
            PACK      PMMIHOSI,SP70       * Hospital Indicator         *T0859743
            MOVE      SP70,PMMIDKSM       * Distance in kms
            PACK      PMMISPAR,SP70,SP70
.
            CALL      WRPMMTI1
            GOTO      CBIL8400
          ENDIF
          GOTO      CBIL9000                 * No charges
.
. ------- Write an invoice pending record -------
.
CBIL8400  COMPARE   ZERO,PTCNIPEN
          GOTO      CBIL9999 IF NOT EQUAL
.
          MOVE      OBAOUTNO,IPADMNO         * Outpatient/Id Number
          MOVE      TWO,IPSYSTM              * Outpatients system
          MOVE      OBASITE,IPSITE           * Site code
.
          MOVE      SP70,PENDHOSP
          IF        IBCNMHOS=1
            MOVE      IPADMNO,KEY8
            CALL      RDPMVX11
            IF        OVRCD=0
              MOVE      PMVXMHOS,PENDHOSP    * Hospital ID
            ENDIF
          ENDIF
          MOVE      " 2",PENDSYST            * Outpatient
.
          MOVE      OBADATE,PENDSDAT         * as at date
          MOVE      OBADATE,PENDADAT         * Visit date
          MOVE      OBADATE,PENDDDAT         * discharged date
          MOVE      OTBBFUND,PENDFUND        * Health fund
          MOVE      OBACOMP,PENDCLAM         * Claim code
          CALL      IPRH0000                 * Invoicing on hold
          MOVE      ONE,PTIPRSTA             * Record status
          MOVE      SP70,PTIPSVAR            * Clear spare
.
          PACK      KEY8,IPADMNO,SP70        * Set key up
          CALL      RAIPEN1                  * Read to check existence
          IF        OVRCD=1
            CALL      WRIPEN1                * Write new record
          ELSE
            CALL      UPIPEN1                * Update record
          ENDIF
          GOTO      CBIL9999
.
CBIL9000  CALL      DCHR0000               * Not attend -remove existing charges
.
CBIL9999  RETURN
+
.------------------------------------------------------------
.         Check if service fees has been charged
.------------------------------------------------------------
CFEE0000  MOVE      OBAOUTNO,IPADMNO         * Outpatient/Id Number
          PACK      KEY22,OBAOUTNO,SP70
          CALL      RDSDTRO1
CFEE1000  CALL      RDKDTRO1
          BRANCH    OVRCD,CFEE9000
.
          MATCH     OBAOUTNO,OTNUMB
          GOTO      CFEE9000 IF NOT EQUAL
.
          MATCH     "1",OTDTCRST
          GOTO      CFEE1000 IF EQUAL        * Fully credited
.
          MATCH     SP70,OTITEMNO
          GOTO      CFEE1000 IF NOT EQUAL
.
          MOVE      ONE,EXIT                 * found charges
          GOTO      CFEE9999
.
CFEE9000  MOVE      ZERO,EXIT
CFEE9999  RETURN
+
.------------------------------------------------------------
.     Delete billing charges in pmsmtiaf file
.------------------------------------------------------------
DCHR0000  MOVE      ZERO,F1
          MATCH     "1",PTCNUABF
          GOTO      DCHR0200 IF NOT EQUAL    * not using ABF
.
          PACK      KEY5,ANSC,ANSL,OBACOMP
          CALL      RDCODE1
          BRANCH    OVRCD,DCHR0200
.
          MATCH     "A",TCINDC2
          GOTO      DCHR0200 IF NOT EQUAL   * NOT ABF Funding
.
          PACK      KEY5,ANSN,ANSC,OTBBTCOD
          CALL      RDCODE1
          BRANCH    OVRCD,DCHR0200
          MATCH     "A",TCINDC1
          GOTO      DCHR0200 IF NOT EQUAL
.
          MOVE      ONE,F1                  * ABF Funding
DCHR0200  MOVE      ZERO,F2
          PACK      KEY14,OBAOUTNO,SP20
          CALL      RSPMMTI1
DCHR1000  CALL      RKPMMTI1
          BRANCH    OVRCD,DCHR3000
.
          MATCH     DOBAOUTN,PMMIVISN
          GOTO      DCHR3000 IF NOT EQUAL  * different outpatient number
.
          ADD       ONE,F2
          BRANCH    F1,DCHR1000            * ABF Funding
.
          MATCH     SP9,PMMIITEM
          GOTO      DCHR1000 IF NOT EQUAL * it's not an outpatient charge rec.
          SUB       ONE,F2
.
          PACK      KEY14,PMMIVISN,PMMITRAN
          CALL      DEPMMTI1
          GOTO      DCHR1000
.
DCHR3000  COMPARE   ZERO,F2
          GOTO      DCHR9999 IF NOT EQUAL     * still got charges
.
          IF        PTCNIPEN=0
            MOVE      OBAOUTNO,IPADMNO         * FORM8 to FORM6
            PACK      KEY8,IPADMNO             * Set key up
            CALL      DEIPEN1
          ENDIF
DCHR9999  RETURN
+
.------------------------------------------------------------
. Link existing referral to the new appointment
.------------------------------------------------------------
LNKR0000  MATCH     "1",LINKREFR
          GOTO      LNKR9999 IF NOT EQUAL
.
          PACK      KEY16,SAVADMNO,SP70
          CALL      RSALLNK2
LNKR1000  CALL      RKALLNK2
          BRANCH    OVRCD,LNKR9999          * not a referral
.
          MOVE      SAVADMNO,KEY8
          MATCH     KEY8,ALLNLNKV           * Get original referral link for
          GOTO      LNKR9999 IF NOT EQUAL   * the old appointment
.
          PACK      KEY16,ALLNVISN,OBAOUTNO,SP70
          CALL      RAALLNK1                * Write link to new appointment
          IF        OVRCD=1
            MOVE      OBAOUTNO,ALLNLNKV
            MOVE      OBASITE,ALLNSITE
            MOVE      OBACLIN,ALLNCLIN
            MOVE      OBADATE,ALLNDATE
            MOVE      OBASTRT,ALLNSTRT
            MOVE      OBASLOT,ALLNSLOT
            MOVE      ZERO,ALLNSTAT
            MOVE      SP70,ALLNSPAR
            MOVE      "0",ALLNMOHR            * Set to Unsent
            CALL      WRALLNK1
.
            MOVE      ONE,AUDTTYPE            * write history record
            CALL      WAALLN00
          ENDIF
.
          PACK      KEY8,ALLNVISN,SP70
          CALL      RDALREF1                  * Read referral
          BRANCH    OVRCD,LNKR9999
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDOTBOC1
          IF        OVRCD=0
            MOVE      ALRERDAT,OTBCRDAT       * Write referral date
            CALL      UPOTBOC1
          ELSE
            MOVE      ALRERDAT,OTBCRDAT
            MOVE      SP70,OTBCSPAR
            CALL      WROTBOC1
          ENDIF
.
LNKR9999  RETURN
+
.*****************************************************************************
.*  EOCACC00  - Link the Follow-Up Appointment with the Episodes of Care
.*              Accident Data. The link is performed only when the following
.*              conditions are met:
.*              1. Control flag for Using Epsiodes of care is set (PTCNUEOC)
.*              2. The original Appointment has an ACC (Accident) claim code
.*              3. The original Appointment is linked to an Episode of Care
.*              If these conditions are met then the Follow-Up Appointment is
.*              linked to the same EOC as the original Appointment.
.*****************************************************************************
EOCACC00  COMPARE   ONE,PTCNUEOC            * Using Episodes Of Care?
          GOTO      EOCACC99 IF NOT EQUAL   * No, return
.
          MOVE      "CL",CATEGORY           * Check Claim Code of orig App
          MOVE      SAVBCOMP,CODE
          CALL      GETCOD00
          MATCH     ANSA,TCINDC3            * Is it an ACC Appointment?
          GOTO      EOCACC99 IF NOT EQUAL   * No, return
.
          PACK      KEY10,CHOSPNUM,SAVADMNO,SP70
          CALL      RDECLNK2
          BRANCH    OVRCD,EOCACC99          * Orig App not linked to EOC
.
          MOVE      OBAOUTNO,ECLNVISI
          PACK      KEY10,CHOSPNUM,OBAOUTNO,SP70
          CALL      RAECLNK2
          IF        OVRCD=1
            CALL      WRECLNK2              * Link Follow-Up App with EOC
          ENDIF
.
EOCACC99  RETURN
+
.**********************************************************************
.*  OCHK0000  - Check we are not converting a normal slots to over    *
.*              bookings and over bookings to normal slots            *
.**********************************************************************
OCHK0000  MOVE      ZERO,EXIT
          MOVE      ZERO,OVERBOOK
.
          MATCH     Z70,OUTBB047                 * New visit type
          GOTO      OCHK9999 IF EQUAL
.
          PACK      KEY5,ANSC,ANSV,OUTBB047,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,OCHK9300
.
          MATCH     ANSZ,TCINDC2                 * Is the new visit type an
          IF        @EQUAL
            MOVE      ONE,OVERBOOK               * New type is an over booking
          ENDIF
.
          MATCH     SP70,NEWSLOTK
          GOTO      OCHK9999 IF EQUAL
.
          PACK      KEY28,NEWSLOTK,SP70         * Key for new slot
          CALL      RDBOKA1                     * Read in the booking record
          BRANCH    OVRCD,OCHK9200
.
          PACK      KEY5,ANSC,ANSV,OBAVISIT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,OCHK9300
.
          MATCH     ANSZ,TCINDC2
          IF        @EQUAL
            IF      OVERBOOK<>1
              GOTO    OCHK9100                 * if new type is an over booking
            ENDIF                              * the new slot must be an over
            GOTO      OCHK9000                 * booking
          ENDIF
.
          IF        OVERBOOK<>0
            GOTO      OCHK9100                 * if new type is not an over
          ENDIF                                * bookings the new slot must
.                                              * not be an over booking
OCHK9000  MOVE      CASEKEYS,KEY28
          CALL      RDBOKA1
          MOVE      ZERO,EXIT
          GOTO      OCHK9999
.
OCHK9100  CLEAR     WEBTITLE
          APPEND    "Invalid visit type change - Slots can not be ",WEBTITLE
          APPEND    "changed from or to over bookings.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OCHK9800
.
OCHK9200  MOVE      "New booking record not Available.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OCHK9800
.
OCHK9300  MOVE      "Invalid visit type.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      OCHK9800
.
OCHK9800  MOVE      CASEKEYS,KEY28
          CALL      RDBOKA1
.
OCHK9999  RETURN
+
.*******************************************************************************
.                        Print DNA letters
.*******************************************************************************
PDNA0000  MATCH     "1",LETPRT10
          GOTO      PDNA1000 IF NOT EQUAL
.
          PACK      KEY18,OBASITE,OBACLIN,OBADAY,OBASTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,PDNA1000
.
          MOVE      LETPSL10,SCHDPRNT
          MOVE      ONE,SCHDCOPY
.
          MOVE      LETTROUT,SETDFPRG
          MOVE      "10",SETDFRPT
          CALL      SETDEF00
.
          MATCH     SP70,OTMALDNA
          GOTO      PDNA1000 IF EQUAL
.
          MOVE      OTMALDNA,LETTNCOD
          MOVE      SP70,STATNCOD
          MOVE      TWO,PRNTTYPE
          CALL      PRNTUD00
          MOVE      ZERO,LETPRT10
.
PDNA1000  MATCH     "1",LETPRT11
          GOTO      PDNA9999 IF NOT EQUAL
.
          MOVE      LETPSL11,SCHDPRNT
          MOVE      ONE,SCHDCOPY
.
          MOVE      LETTROUT,SETDFPRG
          MOVE      "11",SETDFRPT
          CALL      SETDEF00
.
          MATCH     Z70,LETTYP11
          GOTO      PDNA9999 IF EQUAL
.
          MOVE      LETTYP11,LETTNCOD
          MOVE      SP70,STATNCOD
          MOVE      TWO,PRNTTYPE
          CALL      PRNTUD00
          MOVE      ZERO,LETPRT11
.
PDNA9999  RETURN
+
.---------------------------------------------------------------------------
. Write new appointment request for a non attendance
.---------------------------------------------------------------------------
NREQ0000  MATCH     "1",REQUESTA                 * Write appointment request
          GOTO      NREQ9999 IF NOT EQUAL
.
          MATCH     Z70,OTART001                 * U/R
          GOTO      NREQ9999 IF EQUAL
.
          MATCH     Z70,OTART002                 * Referral Number
          GOTO      NREQ9999 IF EQUAL
.
          MOVE      OBAOUTNO,KEY8                * Read visit extn to get
          CALL      RDPMVX11                     * pres comp and hospital
          BRANCH    OVRCD,NREQ9999
.
          CALL      CLOUTART                     * Clear file vars
          MOVE      OTART001,OTARURNO            * U/R
          MOVE      OTART002,OTARREFN            * Referral
.
          PACK      KEY8,OTARREFN,SP70
          CALL      RDALREF1
          IF        OVRCD=1
            CALL      CLALLREF
          ENDIF
.                                                * Use booking date and time
          MOVE      OBADATE,OTARRQDT             * as the request date and time
          PACK      OTARRQTM,OBATIME,COLON,ZERO,ZERO,OTARRQTM,SP70
.
          PACK      KEY32,OTARURNO,OTARREFN,OTARRQDT,OTARRQTM,SP70
          CALL      RDOTART1
          COMPARE   ZERO,OVRCD
          GOTO      NREQ9999 IF EQUAL
.
          MOVE      ALREDEPT,OTARRDEP    * Requesting Department
          MOVE      ALREDEPT,OTARADEP    * Appointment with Department(Cat.AC)
          MOVE      PMVXMHOS,OTARPRHS    * Preferred Hospital
          MOVE      OBASITE,OTARPRSI     * Preferred Site
          MOVE      OBACTYP,OTARCLTY     * Clinic Type
          MOVE      OBACLIN,OTARCLID     * Clinic Id
          MOVE      OBAVISIT,OTARVIST    * Visit Type                 (Cat.CV)
          MOVE      OTBBTRAN,OTARTRRQ    * Transport Required         (Cat.OB)
          MOVE      PMVXUDF1,OTARPCOM    * Presenting Complaint
          MOVE      OBACOMP,OTARFINC     * Financial Class            (Cat.CL)
          MOVE      OBAPRTY,OTARPRIO     * Priority                   (Cat.PR)
          MOVE      ALRESRCE,OTARSORF    * Source of Referral         (Cat.S )
          MOVE      OTBBSPCA,OTARSARR    * Special Arrangements       (Cat.SA)
          MOVE      OBAOUTNO,OTAROOBN    * Original O/P Booking Number
          MOVE      ONE,OTARSTAT         * Status   1 - Pending Reschedule
          MOVE      PMVXINTR,OTARINTR    * Interpreter required
          MOVE      PMVXLNG1,OTARLNG1    * Preferred language
.
          MATCH     OTART021,Z70
          IF        !@EQUAL
            MOVE      OTART021,OTARRREQ
          ENDIF
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,OTARCDAT        * System date
          CLOCK     TIME,OTARCTIM        * System time
          MOVE      USERID,OTARCUID      * web user id
.
          PACK      KEY32,OTARURNO,OTARREFN,OTARRQDT,OTARRQTM,SP70
          CALL      WROTART1
.
          STRIP     REDIRECT                     * Append key for request to
          ENDSET    REDIRECT                     * redirect popup
          APPEND    "&popupreq=",REDIRECT
          APPEND    KEY32,REDIRECT
          RESET     REDIRECT
.
NREQ9999  RETURN
+
.*******************************************************************************
. ATTD0000 : Make the current booking Attended
.            Write a visit record for this outpatient
.            Delete Pre Attendance
.*******************************************************************************
ATTD0000  MOVE      OBAOUTNO,PVIBILL         * Set up billing number
          MOVE      OBAURNO,PVIURNO          * Set up U/R Number
          CALL      IBACLOCK
          REP       " 0",XDATE
          MATCH     OBADATE,XDATE
          IF        @LESS
            MOVE    ONE,EXIT
            GOTO    ATTD9999
          ELSE
            MOVE      OBADATE,PVIDATE          * Set up visit date
          ENDIF
.
          MOVE      TWO,PVITYPE              * Set up visit type
.          MOVE      WBSESIT,PVISITE            * Set up visit site
          MOVE      OBASITE,PVISITE          * Set up visit site
          MOVE      PTYPE,PVIRESI            * Set up resident status
          MOVE      ONE,PVITRAN              * Set up next transaction number
          MOVE      OBACLIN,PVIDOCT          * Set up visit clinic
          MOVE      SP20,PVISPAR             * Clear spare variable
          MOVE      ONE,TCINDC1              * Default to public patient
          PACK      KEY5,CODEA,OBACLASS      * Key for patient classification
          CALL      RDCODE1                  * Get the code record
          MOVE      ONE,FORM1                * Default to public patient
          MOVE      TCINDC1,FORM1            * Convert indicator to a form
          LOAD      PVISTAT,FORM1,TWO,ONE    * patvisaf reverse of patcodes
.
          MOVE      PVIBILL,KEY8             * Key for visit file
          CALL      RDAVISA1                 * Check if record already exists
          BRANCH    OVRCD,ATTD5100           * No. Can go ahead and write it
.
          CALL      UPVISA1                  * Update with latest info
          GOTO      ATTD5500                 * Go to the next step
.
ATTD5100  CALL      WRVISA1                  * Write the visit record
.
.         Now delete the pre-attendance information
.
ATTD5500  MOVE      OBAOUTNO,KEY8            * Key for pre-attendance info
          CALL      RDPREA1                  * Delete this information
          IF        OVRCD=0
            CALL      DEPREA1                  * Delete this information
          ENDIF
.
          CALL      UPMV0000
.
.         Finally, change the status on the current booking to "4"
.
          MOVE      TWO,AUDIFLAG
          CALL      AUDOTBOA  * write audit A
          CALL      AUDOTBOB  * write audit B
.
          MOVE      FOUR,OBASTAT             * Make "Attended"
          CALL      UPBOKA1                  * Update the booking
          CLOCK     TIME,OTBBCITM            * Update Check in Time
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,ATTD6000
.
          PACK      KEY18,OBASITE,OBACLIN,OBADAY,OBASTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,ATTD6000
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT:
                          OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,ATTD6000
.
          PACK      KEY8,PVIBILL,SP70
          CALL      RDPMVX11
          IF        OVRCD=1
            MOVE      OTHEHOSP,PMVXMHOS
          ENDIF
.
          MATCH     SP70,PMVXMHOS
          IF        @EQUAL
            MOVE      OTHEHOSP,PMVXMHOS
          ENDIF
.
          CALL      ADDVIS00                 * Writes to MRTVISFD
.
          MATCH     SP70,OTBBCIND
          IF        @EQUAL
            MOVE      OTHECIND,OTBBCIND
          ENDIF
.
ATTD6000  CALL      UPBOKB1
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDPMVX11
          IF        OVRCD=0
              CALL      IBACLOCK
              PACK      PMVXLUPD,CCC,CYY,CMM,CDD
              REP       " 0",PMVXLUPD
              MOVE      CTIMEIS,PMVXLUPT
              MOVE      USERID,PMVXWEBU
              CALL      UPPMVX11
          ENDIF

.
.         MOVE      OUTBB032,OTBBCITM       * load check-in time
.         MOVE      OUTBB033,OTBBASTM       * load time actually seen
.         MOVE      OUTBB034,OTBBDPTM       * load time of departure
.         MOVE      OUTBB035,OTBBOUTC       * load outcome
.
          MATCH     Z70,OUTBB032
          IF        !@EQUAL
            MOVE      OUTBB032,OTBBCITM
          ENDIF
.
          MATCH     Z70,OUTBB033
          IF        !@EQUAL
            MOVE      OUTBB033,OTBBASTM
          ENDIF
.
          MATCH     Z70,OUTBB034
          IF        !@EQUAL
            MOVE      OUTBB034,OTBBDPTM
          ENDIF
.
          MATCH     Z70,OUTBB035
          IF        !@EQUAL
            MOVE      OUTBB035,OTBBOUTC
          ENDIF
.
          PACK      SAVSKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RCAL0000
.
.         Reposition on the booking after looping through the session
.
          MOVE      CASEKEYS,KEY28
          CALL      RDBOKA1
          BRANCH    OVRCD,ATTD9999
.
          CALL      ATWLLINK                     * update W/L link records
          CALL      POLX0000                     * Polling AH referral expiry
.
          MOVE      THREE,AUDIFLAG
          CALL      AUDOTBOA  * write audit A
          CALL      AUDOTBOB  * write audit B
.
.-------- SVHM Transition II Extract 7, write a record to the CCIEX7AF table
.
          IF        CCCNSVHM = 1
            OPEN      CCIEX7A1,"cciex7af"
            MOVE      ANST,CLEXSTAT
            MOVE      TWO,CLEXTYPE
            MOVE      ADMISSNO,CLEXVISN
.
            PACK      KEY11,CLEXSTAT,CLEXTYPE,CLEXVISN
            CALL      RDCLEX71
            IF        OVRCD = 1
.
. No record with status "T" has been written to cciexaf table, write one
.
              CALL      WRCLEX71
            ENDIF
            CLOSE     CCIEX7A1
          ENDIF
.
          MATCH     "1",SCANNEDM            * Set scanned medical record flag
          GOTO      ATTD9000 IF NOT EQUAL

          PACK      KEY8,OBAURNO,SP70
          CALL      RDPMPX21                * read 2nd master file extension
          BRANCH    OVRCD,ATTD9000          * invalid UR number
.
          MOVE      SCANNEDM,PMPXSN17
          CALL      UPPMPX21
.
ATTD9000  MOVE      ZERO,EXIT
.
ATTD9999  RETURN
+
.*******************************************************************************
.                 NATT0000 - Perform a non-attendance update
.*******************************************************************************
NATT0000  MOVE      TWO,AUDIFLAG
          CALL      AUDOTBOA  * write audit A
          MOVE      FIVE,OBASTAT
          CALL      UPBOKA1
.
.         Only send a visit update message if this has not been triggered
.         by changing from Attended to DNA via the Supervisor Update screen
.         (TSK: 0293130)
.
          IF        UPDATETY <> 9
            CALL      PMIGTNID              * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      TWO,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICOD              * DG API DNA
          ENDIF
.
          CALL      CWAT0000                    * Cancel waiting list link PAC
          CALL      CWAI0000                    * Cancel waiting list link PAS
.
          MOVE      THREE,AUDIFLAG              * set flag to write a c audit
          CALL      AUDOTBOA                    * write audit
.
          CALL      DHIC0000                 * Delete HIC CMBS items (if any)
          CALL      DCHR0000                 * Delete existing charges
          CALL      PNTX0000                 * DNA referral expiry update
.
          COMPARE   ONE,PTCNUEOC            * Using Episodes Of Care?
          GOTO      NATT9999 IF NOT EQUAL
.
          PACK      KEY10,CHOSPNUM,OBAOUTNO,SP70
          CALL      RAECLNK2
          IF        OVRCD=0
            CALL      DEECLNK2              * Delete episode of care link
          ENDIF
.
NATT9999  RETURN
+
.*******************************************************************************
.                Update Contacts
.*******************************************************************************
CNTCT000  MATCH     "1",UPDCONIN
          GOTO      CNTCT999 IF EQUAL
.
          PACK      KEY16,OBAOUTNO,SP70
          CALL      RSALLNK2
          CALL      RKALLNK2
          BRANCH    OVRCD,CNTCT999
.
          MOVE       OBAOUTNO,DIM8
          MATCH      DIM8,ALLNLNKV
          GOTO       CNTCT999 IF NOT EQUAL
.
          PACK       KEY16,ALLNVISN,SP70
          CALL       RSALENC1
CNTCT010  CALL       RKALENC1
          BRANCH     OVRCD,CNTCT999
.
          MATCH      ALLNVISN,ALENVISN
          GOTO       CNTCT999 IF NOT EQUAL
.
          MATCH      DIM8,ALENLINK                   * Is the contact for this
          GOTO       CNTCT010 IF NOT EQUAL           * OP booking skip if not
.
          PACK       KEY8,OBAOUTNO,SP70              * Presenting complaint
          CALL       RDPMVX11
          IF         OVRCD=1
            MOVE       SP70,ALENUFF1
          ELSE
            MOVE       PMVXUDF1,ALENUFF1
          ENDIF
.
          MOVE       OTBBOUTC,ALENOUTC               * Outcome
.
          MATCH      SP70,ALENOUTC
          IF         !@EQUAL
            MOVE       OBADATE,ALENUDT2                * Outcome Date
          ENDIF
.
          MOVE       OTBBDPTM,ALENUTM2               * Outcome Time
.
          MATCH      SP70,ALENUTM2
          IF         !@EQUAL
            PACK       ALENUTM2,ALENUTM2,COLON,ZERO,ZERO
          ENDIF
.
          CALL       UPALENC1
.
          GOTO       CNTCT010
.
CNTCT999  RETURN
+
.*****************************************************************************
. Write the OP visit to the COMWEB70 polling table to see if we
. need to clear the AH referrals expiry date after an appointment DNA
.*****************************************************************************
PNTX0000  MOVE      ZERO,FORM10
.
          PACK      KEY10,Z70
          CALL      RSIBPOL1
          CALL      RPIBPOL1
          BRANCH    OVRCD,PNTX1000
.
          MOVE      IBPLUNIQ,FORM10
PNTX1000  ADD       ONE,FORM10
.
          MOVE      FORM10,IBPLUNIQ
          MOVE      "008",IBPLTYPE     * Not Attendance AH referral expiry
          MOVE      OBAURNO,IBPLURNO
          MOVE      OBAOUTNO,IBPLVISN
          PACK      IBPLSKEY,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
          MOVE      SP70,IBPLSPAR
.
          MOVE      FORM10,KEY10
          CALL      RAIBPOL1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            CALL      WRIBPOL1
            TRAPCLR   IO
            BRANCH    OVRCD,PNTX1000
          ELSE
            GOTO      PNTX1000
          ENDIF
.
PNTX9999  RETURN
+
.------------------------------------------------------------
. Delete CMBS items for booking for HIC
.------------------------------------------------------------
DHIC0000  PACK      KEY10,OBAOUTNO,SP70
          CALL      RSOTBIT1
          CALL      RKOTBIT1
          BRANCH    OVRCD,DHIC2000          * no items on file
.
          MATCH     DOBAOUTN,OTBIVISN
          GOTO      DHIC2000 IF NOT EQUAL
.
          PACK      KEY10,OTBIVISN,OTBIITMC
          CALL      DEOTBIT1
          GOTO      DHIC0000
.
.         Check if claim form had been printed
.
DHIC2000  MATCH     "1",IBCNUMCI            * Using medclaims
          GOTO      DHIC9999 IF NOT EQUAL
.
          OPEN      HICBCNA1,"hicbcnaf"
          OPEN      HICCITA1,"hiccitaf"
          PACK      KEY16,OBAOUTNO,SP70
          CALL      RSHCCLM2
          CALL      RKHCCLM2
          BRANCH    OVRCD,DHIC9999
          MATCH     DOBAOUTN,HCCLVISN       * Same visit
          GOTO      DHIC9999 IF NOT EQUAL
.
          MATCH     " 0",HCCLSTAT           * Status of Printed?
          GOTO      DHIC9999 IF NOT EQUAL   * No
.
.         Delete records from Item claims file
.
DHIC3000  PACK      KEY18,HCCLCLMN,HCCLVISN,SP70
          CALL      RSHCCIT1
          CALL      RKHCCIT1
          BRANCH    OVRCD,DHIC4000
          MATCH     HCCLCLMN,HCCICLMN       * same claim number?
          GOTO      DHIC4000 IF NOT EQUAL
          MATCH     HCCLVISN,HCCIVISN       * same visit number?
          GOTO      DHIC4000 IF NOT EQUAL
.
          PACK      KEY18,HCCICLMN,HCCIVISN,HCCITRAN
          CALL      DEHCCIT1
          GOTO      DHIC3000
.
DHIC4000  PACK      KEY16,HCCLVISN,HCCLCLMN
          CALL      DEHCCLM2
.
          PACK      KEY33,HCCLPMCI,HCCLPYEE,HCCLPSRV,HCCLBTCH
          CALL      RDHCBCN1
          BRANCH    OVRCD,DHIC9999
          SUB       ONE,HCBCBCNT            * subtract batch counter
          MOVE      "0",HCBCSTAT            * batch not completed
          CALL      UPHCBCN1
.
DHIC9999  RETURN
+
.------------------------------------------------------------------------------
. Cancel/DNA - Cancel waiting list link record PAC
.------------------------------------------------------------------------------
CWAT0000  COMPARE   ONE,HBWAIT            * Using w/list
          GOTO      CWAT9999 IF NOT EQUAL
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDWTOPA2
          BRANCH    OVRCD,CWAT9999
.
          PACK      KEY19,WTOPURNO,WTOPCODE,WTOPCOUN,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,CWAT9999
.
          MOVE      SP70,WTWMREAD      * Clear Pre Adm date
          CALL      UPTREA1
.
          PACK      KEY19,WTOPURNO,WTOPCODE,WTOPCOUN,SP70
          CALL      RDWTTX11
          BRANCH    OVRCD,CWAT9999
.
          MOVE      WTOPOSTA,WTTXPAST  * Set back to original pre adm stat
          MOVE      SP70,WTTXPTIM      * Clear Pre Adm time
          CALL      UPWTTX11
.
          MOVE      ONE,WTOPSTAT       * Cancelled
          PACK      WTOPUDAT,CCC,CYY,CMM,CDD
          REP       " 0",WTOPUDAT
          CLOCK     TIME,WTOPUTIM
          MOVE      WBSEUID,WTOPUUID
          CALL      UPWTOPA2
.
          MOVE      WMBOOK,KEY8
          CALL      RDBKRX11
          BRANCH    OVRCD,CWAT9999
.
          MOVE      "XG",CATEGORY
          MOVE      WTTXPAST,CODE
          CALL      GETCOD00
.
          MOVE      TCINDC2,KEY1            * Indicator 2 maps cat XG & BG
.
          PACK      DIM2,ANSB,ANSG,SP70
          PACK      KEY5,DIM2,SP70
          CALL      RDSCODE1
CWAT1000  CALL      RDKCODE1
          BRANCH    OVRCD,CWAT9999
.
          MATCH     TCODE,DIM2                    * Cat BG
          GOTO      CWAT9999 IF NOT EQUAL
.
          MATCH     "I",PTCOACTV                  * Skip inactive
          GOTO      CWAT1000 IF EQUAL
.
          MATCH     KEY1,TCINDC2                  * Map back to orginal pre
          GOTO      CWAT1000 IF NOT EQUAL         * adm status
.
          MOVE      ACODE,BKRXUDF3
          CALL      UPBKRX11
.
CWAT9999  RETURN
+
.------------------------------------------------------------------------------
. Cancel/DNA - Cancel waiting list link record PAS
.------------------------------------------------------------------------------
CWAI0000  COMPARE   ONE,HBWAIT            * Using w/list
          GOTO      CWAI9999 IF NOT EQUAL
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDWTOPS2
          BRANCH    OVRCD,CWAI9999
.
          PACK      KEY19,WTOSURNO,WTOSCODE,WTOSCOUN,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,CWAI9999
.
          MOVE      SP70,WTWMTRPA      * Clear Pre Anaesthetic date
          CALL      UPTREA1
.
          PACK      KEY19,WTOSURNO,WTOSCODE,WTOSCOUN,SP70
          CALL      RDWTTX11
          BRANCH    OVRCD,CWAI9999
.
          MOVE      WTOSOSTA,WTTXPANS  * Set back to original pre adm stat
          MOVE      SP70,WTTXPANT      * Clear Pre Adm time
          CALL      UPWTTX11
.
          MOVE      ONE,WTOSSTAT       * Cancelled
          PACK      WTOSUDAT,CCC,CYY,CMM,CDD
          REP       " 0",WTOSUDAT
          CLOCK     TIME,WTOSUTIM
          MOVE      WBSEUID,WTOSUUID
          CALL      UPWTOPS2
.
CWAI9999  RETURN
+
.------------------------------------------------------------------------------
. Reschedule - Update waiting list link record with new booking details PAC
.------------------------------------------------------------------------------
UWAT0000  COMPARE   ONE,HBWAIT            * Using w/list
          GOTO      UWAT9999 IF NOT EQUAL
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDWTOPA2
          BRANCH    OVRCD,UWAT9999
.
          MOVE      OBASITE,WTOPSITE
          MOVE      OBACLIN,WTOPCLIN
          MOVE      OBADATE,WTOPDATE
          MOVE      OBASTRT,WTOPSTRT
          MOVE      OBASLOT,WTOPSLOT
          MOVE      OBAOUTNO,WTOPOUTN
.
          MOVE      OBADATE,WTOPPDAT
          MOVE      OBATIME,WTOPPTIM
          MOVE      ZERO,WTOPSTAT
.
          PACK      WTOPUDAT,CCC,CYY,CMM,CDD
          REP       " 0",WTOPUDAT
          CLOCK     TIME,WTOPUTIM
          MOVE      WBSEUID,WTOPUUID
          CALL      UPWTOPA2
.
          PACK      KEY19,WTOPURNO,WTOPCODE,WTOPCOUN,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,UWAT9999
.
          MOVE      OBADATE,WTWMREAD      * Set Pre Adm date
          CALL      UPTREA1
.
          PACK      KEY19,WTOPURNO,WTOPCODE,WTOPCOUN,SP70
          CALL      RDWTTX11
          BRANCH    OVRCD,UWAT9999
.
          CALL      BSTA0000              * Set Pre Adm status to booked
.
          MOVE      OBATIME,WTTXPTIM      * Set Pre Adm time
          CALL      UPWTTX11
.
          CALL      BBST0000              * Set booking Pre Adm status to booked
.
UWAT9999  RETURN
+
.------------------------------------------------------------------------------
. Reschedule - Update waiting list link record with new booking details PAS
.------------------------------------------------------------------------------
UWAI0000  COMPARE   ONE,HBWAIT            * Using w/list
          GOTO      UWAI9999 IF NOT EQUAL
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDWTOPS2
          BRANCH    OVRCD,UWAI9999
.
          MOVE      OBASITE,WTOSSITE
          MOVE      OBACLIN,WTOSCLIN
          MOVE      OBADATE,WTOSDATE
          MOVE      OBASTRT,WTOSSTRT
          MOVE      OBASLOT,WTOSSLOT
          MOVE      OBAOUTNO,WTOSOUTN
.
          MOVE      OBADATE,WTOSPDAT
          MOVE      OBATIME,WTOSPTIM
          MOVE      ZERO,WTOSSTAT
.
          PACK      WTOSUDAT,CCC,CYY,CMM,CDD
          REP       " 0",WTOSUDAT
          CLOCK     TIME,WTOSUTIM
          MOVE      WBSEUID,WTOSUUID
          CALL      UPWTOPS2
.
          PACK      KEY19,WTOSURNO,WTOSCODE,WTOSCOUN,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,UWAI9999
.
          MOVE      OBADATE,WTWMTRPA      * Set Pre Anaesthetic date
          CALL      UPTREA1
.
          PACK      KEY19,WTOSURNO,WTOSCODE,WTOSCOUN,SP70
          CALL      RDWTTX11
          BRANCH    OVRCD,UWAI9999
.
          CALL      PSTA0000              * Set Pre Anaesthetic status to booked
.
          MOVE      OBATIME,WTTXPANT      * Set Pre Anaesthetic time
          CALL      UPWTTX11
.
UWAI9999  RETURN
+
.------------------------------------------------------------------------------
. Supervisor  - Supervisor status change update waiting list link record PAC
.------------------------------------------------------------------------------
SWAT0000  COMPARE   ONE,HBWAIT            * Using w/list
          GOTO      SWAT9999 IF NOT EQUAL
.
          COMPARE   ONE,OBASTAT           * Update Pre Admiss stat to booked
          GOTO      SWAT9999 IF NOT EQUAL
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDWTOPA2
          BRANCH    OVRCD,SWAT9999
.
          MOVE      ZERO,WTOPSTAT
          PACK      WTOPUDAT,CCC,CYY,CMM,CDD
          REP       " 0",WTOPUDAT
          CLOCK     TIME,WTOPUTIM
          MOVE      WBSEUID,WTOPUUID
          CALL      UPWTOPA2
.
          PACK      KEY19,WTOPURNO,WTOPCODE,WTOPCOUN,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,UWAT9999
.
          MOVE      OBADATE,WTWMREAD      * Set Pre Adm date
          CALL      UPTREA1
.
          PACK      KEY19,WTOPURNO,WTOPCODE,WTOPCOUN,SP70
          CALL      RDWTTX11
          BRANCH    OVRCD,UWAT9999
.
          CALL      BSTA0000              * Set Pre Adm status to booked
.
          MOVE      OBATIME,WTTXPTIM      * Set Pre Adm time
          CALL      UPWTTX11
.
          CALL      BBST0000              * Set booking Pre Adm status to booked
.
SWAT9999  RETURN
+
.------------------------------------------------------------------------------
. Supervisor  - Supervisor status change update waiting list link record PAS
.------------------------------------------------------------------------------
SWAI0000  COMPARE   ONE,HBWAIT            * Using w/list
          GOTO      SWAI9999 IF NOT EQUAL
.
          COMPARE   ONE,OBASTAT           * Update Pre Admiss stat to booked
          GOTO      SWAI9999 IF NOT EQUAL
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDWTOPS2
          BRANCH    OVRCD,SWAI9999
.
          MOVE      ZERO,WTOSSTAT
          PACK      WTOSUDAT,CCC,CYY,CMM,CDD
          REP       " 0",WTOSUDAT
          CLOCK     TIME,WTOSUTIM
          MOVE      WBSEUID,WTOSUUID
          CALL      UPWTOPS2
.
          PACK      KEY19,WTOSURNO,WTOSCODE,WTOSCOUN,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,SWAI9999
.
          MOVE      OBADATE,WTWMTRPA      * Set Pre Anaesthetic date
          CALL      UPTREA1
.
          PACK      KEY19,WTOSURNO,WTOSCODE,WTOSCOUN,SP70
          CALL      RDWTTX11
          BRANCH    OVRCD,SWAI9999
.
          CALL      PSTA0000              * Set Pre Anaesthetic status to booked
.
          MOVE      OBATIME,WTTXPANT      * Set Pre Anaesthetic time
          CALL      UPWTTX11
.
SWAI9999  RETURN
+
.------------------------------------------------------------
. Update Booking Status
.------------------------------------------------------------
UPDSTA00  BRANCH    OBASTAT,UPDSTA90,UPDSTA90,UPDSTA90,UPDSTA40,UPDSTA50
          GOTO      UPDSTA99
.
. Attended
.
UPDSTA40  BRANCH    BOOKSTAT,UPDSTA41,UPDSTA99,UPDSTA99,UPDSTA99,UPDSTA45
          GOTO      UPDSTA99
.
UPDSTA41  CALL      CMTI0000
          BRANCH    EXIT,UPDSTA92
.
          PACK      SESSKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      SUBATT00                 * Increment Attendance Count
          MOVE      ONE,OBASTAT              * Booked
          CALL      UPBOKA1
.
          MOVE      ONE,CANAFLAG             * send cancel attendance (A11)
.
          MOVE      ONE,FLGOTBOK
          MOVE      SP70,OUTBB005
          MOVE      SP70,OUTBB025
          MOVE      SP70,OUTBB026
          MOVE      SP70,OUTBB032
          MOVE      SP70,OUTBB033
          MOVE      SP70,OUTBB034
          MOVE      SP70,OUTBB035
.
          CALL      SWAT0000                * Supervisor update w/list link PAC
          CALL      SWAI0000                * Supervisor update w/list link PAS
.
          CALL      PPRE0000                * Create the pre attendace record
.
          PACK      KEY8,OBAOUTNO,SP70      * Delete visit record as patient
          CALL      DEVISA1                 * is only booked now.
.
          GOTO      UPDSTA80
.
UPDSTA45  CALL      CMTI0000
          BRANCH    EXIT,UPDSTA92
.
          PACK      SESSKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      SUBATT00                * Increment Attendance Count
          CALL      NATT0000                * Non Attendance
.
          CALL      PPRE0000                * Create the pre attendace record
.
          PACK      KEY8,OBAOUTNO,SP70      * Delete visit record as patient
          CALL      DEVISA1                 * is only booked now.
.
          MOVE      ONE,FLGOTBOK
          MOVE      SP70,OUTBB005
          MOVE      SP70,OUTBB025
          MOVE      SP70,OUTBB026
          MOVE      SP70,OUTBB032
          MOVE      SP70,OUTBB033
          MOVE      SP70,OUTBB034
.
          GOTO      UPDSTA80
.
. Did Not Attended
.
UPDSTA50  BRANCH    BOOKSTAT,UPDSTA51,UPDSTA99,UPDSTA99,UPDSTA54,UPDSTA99
          GOTO      UPDSTA99
.
UPDSTA51  MOVE      ONE,OBASTAT
          CALL      UPBOKA1
          MOVE      SP70,OUTBB005
          MOVE      SP70,OUTBB035
.
          CALL      SWAT0000                * Supervisor update w/list link PAC
          CALL      SWAI0000                * Supervisor update w/list link PAS
.
          GOTO      UPDSTA80
.
UPDSTA54  CALL      ATTD0000
          MOVE      SP70,OUTBB005
          MOVE      SP70,OUTBB035
.
          GOTO      UPDSTA80
.
UPDSTA80  MOVE      ZERO,EXIT
          GOTO      UPDSTA99
.
UPDSTA90  MOVE      "Invalid Status Change.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDSTA99
.
UPDSTA92  CLEAR     WEBTITLE
          APPEND    "Items must be removed before Changing ",WEBTITLE
          APPEND    "Booking Status.",WEBTITLE
          APPEND    SP70,WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDSTA99
.
UPDSTA99  RETURN
+
.------------------------------------------------------------
. Check for to be invoiced items
.------------------------------------------------------------
CMTI0000  MOVE      ZERO,EXIT
          PACK      KEY14,OBAOUTNO,SP70
          CALL      RSPMMTI1
          CALL      RKPMMTI1
          BRANCH    OVRCD,CMTI9999
.
          MATCH     DOBAOUTN,PMMIVISN       * check visit number
          GOTO      CMTI9999 IF NOT EQUAL
.
          MOVE      ONE,EXIT
CMTI9999  RETURN
+
.*******************************************************************************
.  Cancel a single booking - See CANS0000 in OUTWEB08
.*******************************************************************************
CANS0000  MOVE      ZERO,OVERBOOK
          BRANCH    OTXFLAG,CANS0500        * bypass if no comments    *I-48413
          CALL      UPCOM000                * update text comments     *I-48413
.
CANS0500  MOVE      CASEKEYS,KEY28                                     *C-48413
          MOVE      CASEKEYS,SAVSKEYS
          CALL      RLOTBOA1
          BRANCH    OVRCD,CANS9910,CANS9920
          MOVE      OBAURNO,URNUMBER
          MOVE      OBAOUTNO,ADMISSNO
          MOVE      OBAOUTNO,SAVEADMN
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,CANS9910
          MOVE      OBAOUTNO,KEY8
          COMPARE   ONE,OBASTAT              * Make sure record is booked
          GOTO      CANS1000 IF EQUAL        * Record is booked.
          COMPARE   SIX,OBASTAT              * Is this a suspended booking?
          GOTO      CANS9930 IF NOT EQUAL    * No, exit.
.
CANS1000  CALL      CHKD0000                 * Check for deposits
          BRANCH    EXIT,CANS9940
.
          CALL      LOGC0000                 * Log the cancellation of booking
          BRANCH    EXIT,CANS9910            * Input aborted
.
          CALL      COPD0000                 * Write OPD Cancel action
.
          CALL      WREQ0000                 * Write new appointment request
.
          MATCH     "1",REQUESTA
          IF        @EQUAL
            MOVE      "014",KEY3
            CALL      PATINS00                 * Write Pending/Rescheduled
.                                              * comments
          ENDIF
.
          CALL      INTDEL00                 * Delete Interpretor Details
.
          CALL      CLET0000                 * Clear referral letter booking
.
          IF        RETREFTW = 1
            CALL      RETREW00               * Return linked Referral to Waiting
          ENDIF
.
          CALL      DLNK0000                 * Delete A/H referral link
.
          CALL      DHIC0000                 * Delete HIC CMBS items (if any)
          CALL      DCHR0000                 * Delete any existing charges
.
          CALL      DTRN0000                 * Delete Transport Details(if any)
.
          MOVE      OBAOUTNO,KEY8            * Key for the bokb file
          CALL      DEBOKB1                  * Delete the bokb record
          MOVE      FOUR,AUDIFLAG            * set to a write audit
          CALL      AUDOTBOB                 * write the audit
.
          CALL      CWAT0000                 * Cancel waiting list link PAC
          CALL      CWAI0000                 * Cancel waiting list link PAS
          IF        UPBOOKRD=1
            CALL      UPOB0000               * Update linked outpatient booking
          ENDIF
.
          MOVE      ONE,REVWFLAG
          CALL      REVD0000                 * Update waiting list review date
.
          CALL      SCAN0000                 * Cancel series booking
.
          MOVE      OBAOUTNO,KEY8            * Key for the bokc file
          CALL      RAOTBOC1
          IF        OVRCD = 0
            CALL      DEOTBOC1               * Delete the bokc record
          ENDIF
.
          MOVE      OBAOUTNO,KEY8            * Key for the diagnosis file
          CALL      DEDIAG1                  * Delete the diagnosis record
.
          MOVE      OBAOUTNO,KEY8            * Key for the preaf file
          CALL      DEPREA1                  * Delete the preaf record
.
          MOVE      OBAOUTNO,KEY8            * Key for the visit extn file
          CALL      DEPMVX11                 * Delete the pmsvx1af record
.
          MOVE      CASEKEYS,KEY25
          CALL      RDSESA1
          BRANCH    OVRCD,CANS5000
.
CANS5000  MOVE      TWO,AUDIFLAG             * set to a before audit
          CALL      AUDOTBOA                 * write the audit
.
          CALL      RMDIS000                 * Remove Disaster Details
.
          MOVE      CASEKEYS,KEY28
          CALL      RDBOKA1                  * Position on the record
          BRANCH    OVRCD,CANS6000           * Check for extended slots
.
          PACK      KEY5,ANSC,ANSV,OBAVISIT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CANS5500
.
          MATCH     ANSZ,TCINDC2
          IF        @EQUAL
            MOVE      ONE,OVERBOOK           * Yes it is an over bookings
          ENDIF                              * so delete slots
.
CANS5500  CALL      CHKSUS00                 * Check Clinic Master Suspension
          IF        EXIT = 1
            MOVE      SIX,SLOTSTAT           * Suspended - set status to Susp.
          ELSE
            MOVE      ZERO,SLOTSTAT          * Not Suspended - reset status
          ENDIF
.
          MOVE      SLOTSTAT,OBASTAT         * Set slot status
          MOVE      ZEROUR,OBAURNO           * Set the U/R Number back to zero
          MOVE      ZEROVISN,OBAOUTNO        * Set the outpatient number to zero
          MOVE      SP20,OBABKDTE            * Reset the booking date
          MOVE      ZERO,OBAPULL             * Reset pulling list indicator
.
          IF        OTCNCREV=1
            MATCH     SP70,OTCNREVC
            IF        !@EQUAL & !@EOS
.
              MATCH     "000",OTCNREVC
              GOTO      CANS5550 IF EQUAL
.
              MOVE      OTCNREVC,OBAVISIT
              PACK      OBAVISIT,OBAVISIT,SP70
            ELSE
CANS5550      MOVE      "R  ",OBAVISIT         * Convert visit type to REVIEW
            ENDIF
          ENDIF
.
          IF        OVERBOOK=1
            PACK      KEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
            CALL      DEBOKA1                * Delete this over booking slot
          ELSE
            CALL      UPBOKA1                * Clear this slot
          ENDIF
.
          MOVE      THREE,AUDIFLAG           * set to an after audit
          CALL      AUDOTBOA                 * write the audit
.
.         PACK      SESSKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
.         CALL      SUBBOK00                 * decrease Booking Count
.
.         Check for any extended slots that also need to be cleared
.
          MOVE      CASEKEYS,KEY25
          CALL      RDSESA1
          MOVE      CASEKEYS,KEY28
          CALL      RDBOKA1                  * Position on the record
          MOVE      OBASLOT,VSLOT            * Correct parent ?
.
CANS6000  CALL      RDKBOKA1                 * Get the next booking record
          BRANCH    OVRCD,CANS9000           * Booking cancelled.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT
          MATCH     KEY25,CASEKEYS            * Correct session ?
          GOTO      CANS9000 IF NOT EQUAL    * No. Finished
          COMPARE   THREE,OBASTAT            * Is this an extended slot ?
          GOTO      CANS9000 IF NOT EQUAL    * No. Finished
.
          MOVE      OBAEXSL,SLOTOPT          * Move parent slot to a dim field
          MATCH     SLOTOPT,VSLOT            * Correct parent ?
          GOTO      CANS9000 IF NOT EQUAL    * No. Finished
.
          MOVE      TWO,AUDIFLAG             * set to a before audit
          CALL      AUDOTBOA                 * write the audit
.
          MOVE      ZEROUR,OBAURNO           * Set the U/R Number back to zero
          MOVE      ZEROVISN,OBAOUTNO        * Set the outpatient number to zero
          MOVE      SP20,OBABKDTE            * Reset the booking date
          MOVE      ZERO,OBAPULL             * Reset pulling list indicator
.
          IF        OTCNCREV=1
.
            MATCH     SP70,OTCNREVC
            IF        !@EQUAL & !@EOS
.
              MATCH     "000",OTCNREVC
              GOTO      CANS6010 IF EQUAL
.
              MOVE      OTCNREVC,OBAVISIT
              PACK      OBAVISIT,OBAVISIT,SP70
            ELSE
CANS6010      MOVE      "R  ",OBAVISIT         * Convert visit type to REVIEW
            ENDIF
.
            MOVE      ZERO,OBAEXSL           * Clear parent slot number
            MOVE      SLOTSTAT,OBASTAT       * Set slot status
          ENDIF
.
          IF        OVERBOOK=1
            PACK      KEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
            CALL      DEBOKA1                  * Clear this slot
            CALL      RDSBOKA1
          ELSE
            CALL      UPBOKA1                  * Clear this slot
          ENDIF
.
          MOVE      THREE,AUDIFLAG           * set to an after audit
          CALL      AUDOTBOA                 * write the audit
          GOTO      CANS6000                 * Check for another extended slot
.
CANS9000  MOVE      CASEKEYS,KEY28
          CALL      RDBOKA1                  * Position on the record
          IF        OVRCD=1
            CALL      CLOUTBOA               * Clear outbokaf variables
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      CANS9999
.
CANS9910  MOVE      "Booking Record Missing",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CANS9999
.
CANS9920  MOVE      "Booking Record Locked",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CANS9999
.
CANS9930  MOVE      "Booking has the wrong status",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CANS9999
.
CANS9940  MOVE      "Deposits Exist - Booking not cancelled",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CANS9999
.
CANS9999  RETURN
+
.*******************************************************************************
.                  DBOK0000: Cancel a booking. Used in rescheduling
.*******************************************************************************
DBOK0000  MOVE      ZERO,OVERBOOK            * set over booking to no
          PACK      KEY28,CASEKEYS,SP70      * Key for slot being cancelled
          CALL      RDBOKA1                  * Position on the record
          BRANCH    OVRCD,DBOK9000           * Record has disappeared
          COMPARE   ONE,OBASTAT              * Make sure record isn't booked
          GOTO      DBOK1000 IF EQUAL        * Record isn't vacant !!
          COMPARE   SIX,OBASTAT              * Make sure record isn't booked
          GOTO      DBOK9010 IF NOT EQUAL    * Record isn't vacant !!
.
          MOVE      CASEKEYS,KEY25
          CALL      RDSESA1
          BRANCH    OVRCD,DBOK1000
.
.         Now cancel the booking from the bookings file
.
DBOK1000  MOVE      TWO,AUDIFLAG             * set to a before audit
          CALL      AUDOTBOA                 * write the audit
.
          PACK      KEY5,ANSC,ANSV,OBAVISIT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CANS5500
.
          MATCH     ANSZ,TCINDC2
          IF        @EQUAL
            MOVE      ONE,OVERBOOK           * Yes it is an over bookings
          ENDIF                              * so delete slots
.
          CALL      CHKSUS00                 * Check Clinic Master Suspension
          IF        EXIT = 1
            MOVE      SIX,SLOTSTAT           * Suspended - set status to Susp.
          ELSE
            MOVE      ZERO,SLOTSTAT          * Not Suspended - reset status
          ENDIF
.
          PACK      SESSKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      SUBBOK00                 * Increment Booking Count
.
          MOVE      SLOTSTAT,OBASTAT         * Set slot status
          MOVE      ZEROUR,OBAURNO           * Set the U/R Number back to zero
          MOVE      ZEROVISN,OBAOUTNO        * Set the outpatient number to zero
.
          MOVE      SP20,OBABKDTE            * Reset the booking date
          MOVE      ZERO,OBAPULL             * Reset pulling list indicator
.
          IF        OTCNCREV=1
            MATCH     SP70,OTCNREVC
            IF        !@EQUAL & !@EOS
.
              MATCH     "000",OTCNREVC
              GOTO      DBOK1010 IF EQUAL
.
              MOVE      OTCNREVC,OBAVISIT
              PACK      OBAVISIT,OBAVISIT,SP70
            ELSE
DBOK1010      MOVE      "R  ",OBAVISIT         * Convert visit type to REVIEW
            ENDIF
          ENDIF
.
          IF        OVERBOOK=1
            PACK      KEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
            CALL      DEBOKA1                * Delete this over booking slot
          ELSE
            CALL      UPBOKA1                * Clear this slot
          ENDIF
.
          MOVE      THREE,AUDIFLAG           * set to an after audit
          CALL      AUDOTBOA                 * write the audit
.
.         Check for any extended slots that also need to be cleared
.
          MOVE      OBASLOT,PARNSLOT
DBOK6000  CALL      RDKBOKA1                 * Get the next booking record
          BRANCH    OVRCD,DBOK9999           * Booking cancelled.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT
          MATCH     KEY25,CASEKEYS           * Correct session ?
          GOTO      DBOK9999 IF NOT EQUAL    * No. Finished
          COMPARE   THREE,OBASTAT            * Is this an extended slot ?
          GOTO      DBOK9999 IF NOT EQUAL    * No. Finished
          COMPARE   OBAEXSL,PARNSLOT
          GOTO      DBOK9999 IF NOT EQUAL    * No. Finished
.
          MOVE      TWO,AUDIFLAG             * set to a before audit
          CALL      AUDOTBOA                 * write the audit
          MOVE      ZEROUR,OBAURNO           * Set the U/R Number back to zero
          MOVE      ZEROVISN,OBAOUTNO        * Set the outpatient number to zero
.
          MOVE      SP20,OBABKDTE            * Reset the booking date
          MOVE      ZERO,OBAPULL             * Reset pulling list indicator
.
          IF        OTCNCREV=1
.
            MATCH     SP70,OTCNREVC
            IF        !@EQUAL & !@EOS
.
              MATCH     "000",OTCNREVC
              GOTO      DBOK6010 IF EQUAL
.
              MOVE      OTCNREVC,OBAVISIT
              PACK      OBAVISIT,OBAVISIT,SP70
            ELSE
DBOK6010      MOVE      "R  ",OBAVISIT         * Convert visit type to REVIEW
            ENDIF
.
            MOVE      ZERO,OBAEXSL           * Clear parent slot number
            MOVE      SLOTSTAT,OBASTAT       * Set slot status
          ENDIF
.
          IF        OVERBOOK=1
            PACK      KEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
            CALL      DEBOKA1                * Delete this over booking slot
          ELSE
            CALL      UPBOKA1                * Clear this slot
          ENDIF
.
          MOVE      THREE,AUDIFLAG           * set to an after audit
          CALL      AUDOTBOA                 * write the audit
          GOTO      DBOK6000                 * Check for another extended slot
.
.         The booking record has disappeared
.
DBOK9000  DISPLAY   *P1:23,*EF,*B,"Booking Record [",KEY28,"] has disappeared.":
                    *P4:24,"Old booking not cancelled.  ";
          GOTO      DBOK9999
.
.         Booking record has the wrong status
.
DBOK9010  DISPLAY  *P1:23,*EF,*B,"Booking Record [",KEY28,"] has wrong status.":
                   *P4:24,"Old booking not cancelled.  ";
DBOK9999  RETURN
+
.------------------------------------------------------------
. Update transport details when rescheduling an appointment
.------------------------------------------------------------
UTRN0000  PACK      KEY19,OBAURNO,OBAOUTNO,SP70
          CALL      RSPMTSP1
UTRN1000  CALL      RKPMTSP1
          BRANCH    OVRCD,UTRN9999
.
          MATCH     OBAURNO,PMTSURNO             * Correct U/R
          GOTO      UTRN9999 IF NOT EQUAL
.
          MATCH     DOBAOUTN,PMTSVISN            * Correct Visit
          GOTO      UTRN9999 IF NOT EQUAL
.
          PACK      PMTSTDAT,OBADATE,COLON,ZERO,ZERO   * Set transport dates to
          PACK      PMTSTTIM,OBATIME,COLON,ZERO,ZERO   * app date
          PACK      PMTSRTDT,OBADATE,COLON,ZERO,ZERO
          PACK      PMTSRTTM,OBATIME,COLON,ZERO,ZERO
.
          PACK      KEY19,PMTSURNO,PMTSVISN,PMTSUNIQ,SP70
          CALL      UPPMTSP1                     * Update Transport Details
.
          GOTO      UTRN1000
.
UTRN9999  RETURN
+
.------------------------------------------------------------
. Update claim details when rescheduling an appointment
.------------------------------------------------------------
UCLM0000  PACK      KEY8,OBAOUTNO,SP70
          CALL      RDWCOM1
          BRANCH    OVRCD,UCLM9999
.
          MOVE      OBADATE,PTWCVDAT                    * Update the visit date to the new appointment date
          CALL      UPWCOM1
.
UCLM9999  RETURN
+
.------------------------------------------------------------
. Update CMBS items for booking
.------------------------------------------------------------
UMBS0000  PACK      KEY10,OBAOUTNO,SP70
          CALL      RSOTBIT1
UMBS1000  CALL      RKOTBIT1
          BRANCH    OVRCD,UMBS9999          * no items on file
.
          MATCH     DOBAOUTN,OTBIVISN       * check visit number
          GOTO      UMBS9999 IF NOT EQUAL
.
          MOVE      OBADATE,OTBIDATE        * update with new date
.
          PACK      KEY10,OTBIVISN,OTBIITMC
          CALL      UPOTBIT1
          GOTO      UMBS1000
.
UMBS9999  RETURN
+
.------------------------------------------------------------
. Copy outbitaf data to pmsmitaf
.------------------------------------------------------------
UPPMS000  MATCH     "1",BULKBILL             * check if it is bulk billing
          GOTO      UPPMS999 IF NOT EQUAL
.
          COMPARE   ONE,CMBSFLAG             * check if any cmbs items updated
          GOTO      UPPMS999 IF NOT EQUAL
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,UPPMS999
.
. if departure time has been changed to blank, delete all the pmsmtiaf
.
          MATCH     SP70,OTBBDPTM
          IF        @EQUAL
            MATCH     SP70,ODEPTTIM
            IF        @EQUAL | @EOS
              GOTO      UPPMS999
            ELSE
              CALL      DLPMSM00
              GOTO      UPPMS999
            ENDIF
          ENDIF
.
. if pmsmtiaf exists, copy outbitaf to pmsmtiaf
.
          PACK      KEY14,OBAOUTNO,SP70
          CALL      RSPMMTI1
          CALL      RKPMMTI1
          BRANCH    OVRCD,UPPMS100
.
          MATCH     DOBAOUTN,PMMIVISN       * check visit number
          GOTO      UPPMS100 IF NOT EQUAL
.
          GOTO      UPPMS200
.
. No pmsmtiaf exists, if the departure time is newly entered from
. blank, copy outbitaf to pmsmtiaf. Otherwise, do nothing
.
UPPMS100  MATCH     SP70,ODEPTTIM
          GOTO      UPPMS300 IF EQUAL
          GOTO      UPPMS300 IF EOS
.
          GOTO      UPPMS999
.
UPPMS200  CALL      DLPMSM00                * Delete pmsmtiaf
.
. copy outbitaf to pmsmtiaf
.
UPPMS300  PACK      KEY10,OBAOUTNO,SP70
          CALL      RSOTBIT1
UPPMS320  CALL      RKOTBIT1
          BRANCH    OVRCD,UMBS9999          * no items on file
.
          MATCH     DOBAOUTN,OTBIVISN       * check visit number
          GOTO      UPPMS999 IF NOT EQUAL
.
. Write new pmsmitaf record
.
          CALL      CLPMSMTI
.
          MOVE      OTBIVISN,PMMIVISN
          MOVE      OTBIITMC,F2
          MOVE      F2,F6
          MOVE      F6,PMMITRAN
          MOVE      OTBIURNO,PMMIURNO
          MOVE      "2",PMMISYST
          MOVE      OTBIDATE,PMMITDAT
          MOVE      "2",PMMIRTYP
          MOVE      OTBIIFLG,PMMIITYP
          MOVE      OTBIITMN,PMMIITEM
          MOVE      OTBISUBN,PMMISUBN
          MOVE      OTBICDAT,PMMIDTCR
          MOVE      OTBICTIM,PMMITMCR
          MOVE      OTBICUID,PMMIIDCR
.
          LOAD      PMMIDESC,F2,MBSDESC1,MBSDESC2,MBSDESC3,MBSDESC4,MBSDESC5
          LOAD      PMMIAMTT,F2,MBSAMNT1,MBSAMNT2,MBSAMNT3,MBSAMNT4,MBSAMNT5
.
          PACK      KEY14,PMMIVISN,PMMITRAN
          CALL      WRPMMTI1
          GOTO      UPPMS320
.
UPPMS999  RETURN
+
.------------------------------------------------------------
. Delete pmsmtiaf data
.------------------------------------------------------------
DLPMSM00  PACK      KEY14,OBAOUTNO,SP70
          CALL      RSPMMTI1
DLPMSM20  CALL      RKPMMTI1
          BRANCH    OVRCD,DLPMSM99
.
          MATCH     DOBAOUTN,PMMIVISN
          GOTO      DLPMSM99 IF NOT EQUAL
.
          PACK      KEY14,PMMIVISN,PMMITRAN
          CALL      DEPMMTI1
          GOTO      DLPMSM20
.
DLPMSM99  RETURN
+
.*******************************************************************************
. DLNK0000 - Update allied health referral link to cancelled
.*******************************************************************************
DLNK0000  PACK      KEY16,OBAOUTNO,SP70
          CALL      RSALLNK2
          CALL      RKALLNK2
          BRANCH    OVRCD,DLNK9999          * not a referral
.
          MATCH     DOBAOUTN,ALLNLNKV
          GOTO      DLNK9999 IF NOT EQUAL
.
          MOVE      ONE,ALLNSTAT            * Set to cancelled
.
          PACK      KEY16,ALLNVISN,ALLNLNKV,SP70
          CALL      UPALLNK2
.
          MATCH     "1",ALLNMOHR
            IF        @EQUAL
            MOVE      "2",ALLNMOHR           * set to 'Send Delete'
          ENDIF
.
          MOVE      FOUR,AUDTTYPE           * delete history record
          CALL      WAALLN00
.
          COMPARE   ONE,RETREFTW            * Return Referral To Waiting?
          GOTO      DLNK9999 IF EQUAL
.
          CALL      URSR0000                * Update Referral Status
.
DLNK9999  RETURN
+
.*******************************************************************************
. ULNK0000 - Update allied health referral letter link
.*******************************************************************************
ULNK0000  PACK      KEY16,OBAOUTNO,SP70
          CALL      RSALLNK2
          CALL      RKALLNK2
          BRANCH    OVRCD,ULNK9999          * not a referral
.
          MATCH     DOBAOUTN,ALLNLNKV
          GOTO      ULNK9999 IF NOT EQUAL
.
          MOVE      TWO,AUDTTYPE            * before history record
          CALL      WAALLN00
.
          MOVE      OBASITE,ALLNSITE
          MOVE      OBACLIN,ALLNCLIN
          MOVE      OBADATE,ALLNDATE
          MOVE      OBASTRT,ALLNSTRT
          MOVE      OBASLOT,ALLNSLOT
          MOVE      SP70,ALLNSPAR
.
          PACK      KEY16,ALLNLNKV,ALLNVISN,SP70
          CALL      UPALLNK2
.
          MOVE      THREE,AUDTTYPE        * after history record
          CALL      WAALLN00
.
          CALL      URSR0000                * Update Referral Status
.
ULNK9999  RETURN
+
.*******************************************************************************
.   WBKA0000: Write a booking to the appropriate files. Used in rescheduling
.*******************************************************************************
WBKA0000  PACK      KEY28,CASEKEYS,SP70    * Key for selected booking
          CALL      RDBOKA1                * Read in the booking record
          BRANCH    OVRCD,WBKA9900
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDBOKB1
          BRANCH    OVRCD,WBKA9900
.
          MOVE      OBAOUTNO,ADMISSNO
          MOVE      OBAURNO,URNUMBER
.
          PACK      KEY28,NEWSLOTK,SP70    * Key for selected booking
          CALL      RLOTBOA1              * Read & Lock in the booking record
          BRANCH    OVRCD,WBKA9900
.
          COMPARE   ZERO,OBASTAT
          GOTO      WBKA0100 IF EQUAL
... CAR 36688 - START (Commented out the next 2 lines of code)
...          MATCH     "1",RESHFLAG
...          GOTO      WBKA0100 IF EQUAL
... CAR 36688 - END
          COMPARE   NINE,OBASTAT
          GOTO      WBKA9900 IF NOT EQUAL
.
          MOVE      NEWSLOTK,KEY28
          CALL      RDOTSRV1
          IF        OVRCD=0
            MATCH     USERID,OTSRWEBU
            GOTO      WBKA9900 IF NOT EQUAL * Record is locked by another
            CALL      DEOTSRV1
          ENDIF
.
WBKA0100  MOVE      TWO,AUDIFLAG           * set to a before audit
          CALL      AUDOTBOA               * write the audit
.
          MOVE      ADMISSNO,OBAOUTNO      * Outpatient number
          MOVE      URNUMBER,OBAURNO        * U/R Number
          MOVE      ONE,OBASTAT            * Status = Booked
          MOVE      ZERO,OBAPULL           * Clear pulling list flag
          CLOCK     TIME,CTIMEIS           * Get the current time
          PACK      OBABKDTE,CCC,CYY,CMM,CDD,CTIMEIS
          REP       " 0",OBABKDTE      * Zero-fill booking date/time
          CALL      UPBOKA1
.
          MOVE      THREE,AUDIFLAG         * set to an after audit
          CALL      AUDOTBOA               * write the audit
.
          PACK      SESSKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      ADDBOK00                 * Increment Booking Count
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          IF        OVRCD=1
            CALL      CLOUTHED
            MOVE      OTBBTCOD,OTHETCOD      * Use original Tier 2 Code
          ENDIF
.
          MOVE      ZERO,REVWFLAG
          CALL      REVD0000                 * Update waiting list review date
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDABOKB1
          IF        OVRCD=0
            MOVE      OBACTYP,OBBCTYP        * update clinic type
            MOVE      OTHETCOD,OTBBTCOD
            CALL      UPBOKB1
.
            PACK      KEY8,OBAOUTNO,SP70
            CALL      RDPMVX11
            IF        OVRCD=0
                CALL      IBACLOCK
                PACK      PMVXLUPD,CCC,CYY,CMM,CDD
                REP       " 0",PMVXLUPD
                MOVE      CTIMEIS,PMVXLUPT
                MOVE      USERID,PMVXWEBU
                CALL      UPPMVX11
            ENDIF
.
          ENDIF
.
          CALL      UPMV0000
          CALL      PPRE0000               * Updating the pre-attend file data
.
.         Finally, check if this is an extended slot, and if so update those
.         records with the new patient details
.
.
.         MOVE      OBASLOT,PARNSLOT
.WBKA1000  CALL      RDKBOKA1               * Check the next record
.          BRANCH    OVRCD,WBKA1900         * Finished
.          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT
.          MATCH     KEY25,NEWSLOTK         * Correct session ?
.          GOTO      WBKA1900 IF NOT EQUAL  * No. Finished
.          COMPARE   THREE,OBASTAT          * Is this an extended slot ?
.          GOTO      WBKA1900 IF NOT EQUAL  * No. Finished
.          COMPARE   OBAEXSL,PARNSLOT
.          GOTO      WBKA1900 IF NOT EQUAL  * No. Finished
...
.          MOVE      TWO,AUDIFLAG           * set to a before audit
.          CALL      AUDOTBOA               * write the audit
.          MOVE      ADMISSNO,OBAOUTNO      * Outpatient number
.          MOVE      URNUMBER,OBAURNO       * U/R Number
.          CALL      UPBOKA1                * Update this record
.          MOVE      THREE,AUDIFLAG         * set to an after audit
.          CALL      AUDOTBOA               * write the audit
.
.          GOTO      WBKA1000               * Check for another extended slot
.
WBKA1900  PACK      KEY28,NEWSLOTK,SP70    * Key for parent slot
          CALL      RDBOKA1                * Re-read bookin record
.
          CALL      UUOTBOA1              * Unlock Records
          MOVE      ZERO,EXIT              * Set exit flag
          GOTO      WBKA9999
.
WBKA9900  MOVE      ONE,EXIT
.
WBKA9999  RETURN
+
.*******************************************************************************
.                 LOGR0000: Log the rescheduling of a booking
.*******************************************************************************
LOGR0000  READ      CONTROLF,THIRTY1;*123,HLOGRSCH
          COMPARE   ONE,HLOGRSCH             * Check if they want to log it
          GOTO      LOGR9999 IF NOT EQUAL    * No they don't. Just return
.
          PACK      KEY28,CASEKEYS,SP70       * Key for old record
          CALL      RDBOKA1                  * Read in the old record
.
.         Get the last rescheduling number for this patient
.
          PACK      KEY11,OBAOUTNO,Z70       * Key for the end of patient
          CALL      RDSRSHA1                 * Position at end of patient
          CALL      RDPRSHA1                 * Read the last record for patient
          BRANCH    OVRCD,LOGR0500           * No record of patient
.
          MATCH     OBAOUTNO,OPRSOUTN        * Correct patient ?
          GOTO      LOGR0500 IF NOT EQUAL    * No.
.
          ADD       ONE,OPRSUNIQ             * Increment the unique counter
          GOTO      LOGR1000
.
.         No previous entry in the rescheduling log file
.
LOGR0500  MOVE      ONE,OPRSUNIQ             * Set the unique counter
.
.         Save the old parameters
.
LOGR1000  MOVE      OBASITE,OPRSSITE         * Site
          MOVE      OBACLIN,OPRSCLIN         * Old Clinic Id
          MOVE      OBADATE,OPRSDATE         * Old Clinic Date
          MOVE      OBASTRT,OPRSSTRT         * Old Clinic Start Time
          MOVE      OBASLOT,OPRSSLOT         * Old Slot Number
          MOVE      OBATIME,OPRSTIME         * Old Slot Time
          MOVE      OBAVISIT,OPRSVIST        * Old visit type for DGCLICOR
          MOVE      OBACTYP,OPRSCTYP         * Old clinic type for DGCLICOR
.
.         Set up the other parameters for the new record
.
          MOVE      OBAOUTNO,OPRSOUTN        * Outpatient Number
          MOVE      OUTBB014,OPRSREAS        * Reason for Rescheduling
          PACK      OPRSRDTE,CCC,CYY,CMM,CDD * Date of Rescheduling
          REP       " 0",OPRSRDTE            * Zero-fill the Rescheduling Date
          CLOCK     TIME,OPRSRTIM            * Get the Rescheduling Time
          MOVE      OBABKDTE,OPRSBKDT        * Book Date/Time
.
          UNPACK    NEWSLOTK,OBASITE,OPRSNCLI,OPRSNDAT,OPRSNSTR,KEY3
          MOVE      KEY3,OPRSNSLO
          PACK      KEY28,NEWSLOTK,SP70      * Key for new record
          CALL      RDBOKA1                  * Read in the new record
          MOVE      OBACTYP,OPRSNTYP         * load new clinic type for DGCLICOR
          MOVE      OUTBB047,OPRSNVIS        * load new visit type for DGCLICOR
          MOVE      OBATIME,OPRSNTIM
          MOVE      PASSCODE,OPRSOPER
.
          MOVE      OBACTYP,OPRSCLTY         * Clinic Type (outctyaf)
          MOVE      OBAVISIT,OPRSVTYP        * Visit Type (Cat CV)
          MOVE      OBACOMP,OPRSCOMP         * Claim Code (Cal CL)
          MOVE      OTBBNMDS,OPRSNMDS        * NMDS Clinic (Cat NM)
          MOVE      OTBBSRVD,OPRSSRVD        * Service Delivery (Cat sd)
          MOVE      OTBBCART,OPRSCARE        * Care Type (Cat CC)
          MOVE      SP70,OPRSSPAR            * Spare variable
.
          MATCH     ZEROVISN,OPRSOUTN        * Don't write reschedule record if
          GOTO      LOGR9000 IF EQUAL        * the visit number is zero
.
          PACK      KEY11,OPRSOUTN,OPRSUNIQ  * Key for new record
          CALL      RDRSHA1
          IF        OVRCD=1
            CALL      WRRSHA1                * Write the new record
.
            CALL      PMIGTNID               * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      TEN2,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICOR               * DG O/P Resched Appoint.  *I-90203
          ENDIF
.
LOGR9000  PACK      KEY28,CASEKEYS,SP70      * Key for old record
          CALL      RDBOKA1                  * Read in the old record
.
LOGR9999  RETURN
+
.*******************************************************************************
.        PRFL0000  Update the booking on the referral letters file
.*******************************************************************************
PRFL0000  READ      CONTROLF,THIRTY1;*174,OTCNULET
          COMPARE   ONE,OTCNULET
          GOTO      PRFL9999 IF NOT EQUAL   * not using referral letters
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDOTRFL1
          BRANCH    OVRCD,PRFL9999          * not a referral
.
          UNPACK    NEWSLOTK,OTRLBSIT,OTRLBCLI,OTRLBDTE,OTRLBSTR,OTRLBSLT
          MOVE      OBAURNO,OTRLURNO        * U/R Number
.
          PACK      OTRLUDAT,CCC,CYY,CMM,CDD
          REP       " 0",OTRLUDAT
          CLOCK     TIME,OTRLUTIM
          MOVE      WBSEUID,OTRLUUID
.
          CALL      UPOTRFL1
.
PRFL9999  RETURN
+
.------------------------------------------------------------------------------
. Write cancel OPD action and comments
.------------------------------------------------------------------------------
COPD0000  PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,COPD9999
.
          MATCH     SP70,WBSEOPDU                * Exit if not an OPD user
          GOTO      COPD9999 IF EQUAL
.
          PACK      KEY5,CATTZ,WBSEOPDU,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,COPD9999
.
          MATCH     ANSO,TCINDC1                 * OPD user
          GOTO      COPD9999 IF NOT EQUAL
.
          CALL      CLOUTDAN
          MOVE      OPCNURNO,OTDNURNO
          MOVE      OPCNRDTE,OTDNADAT
          MOVE      OPCNRTIM,OTDNATIM
.
          MATCH     "1",REQUESTA
          IF        @EQUAL
            MOVE      " 4",OTDNATYP                * Pending reschedule appt
            MOVE      OTART002,OTDNREFN            * Referral
          ELSE
            MOVE      " 3",OTDNATYP                * Cancel appointment
          ENDIF
          MOVE      OPCNOUTN,OTDNVISN
          MOVE      OPCNDATE,OTDNVDAT
.
          PACK      OTDNCDAT,CCC,CYY,CMM,CDD
          REP       " 0",OTDNCDAT           *
          CLOCK     TIME,OTDNCTIM
          MOVE      USERID,OTDNCUID
.
          PACK      KEY34,OTDNURNO,OTDNADAT,OTDNATIM,OTDNATYP,OTDNVISN,SP70
          CALL      RAOTDAN1
          IF        OVRCD=1
            CALL      WROTDAN1                    * Write actions record
          ENDIF
.
          MOVE      OTDNURNO,COMMURNO
          MOVE      OTDNADAT,COMMADAT
          MOVE      OTDNATIM,COMMATIM
          MATCH     "1",REQUESTA
          IF        @EQUAL
            MOVE      " 4",COMMTYPE            * Pending reschedule appt
          ELSE
            MOVE      " 3",COMMTYPE            * Cancelled Appointment
          ENDIF
          CALL      UPOPD000                 * OPD Message
.
COPD9999  RETURN
+
.------------------------------------------------------------------------------
. Write reschedule OPD action and comments
.------------------------------------------------------------------------------
ROPD0000  PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,ROPD9999
.
          MATCH     SP70,WBSEOPDU                * Exit if not an OPD user
          GOTO      ROPD9999 IF EQUAL
.
          PACK      KEY5,CATTZ,WBSEOPDU,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ROPD9999
.
          MATCH     ANSO,TCINDC1                 * OPD user
          GOTO      ROPD9999 IF NOT EQUAL
.
          CALL      CLOUTDAN
          MOVE      OBAURNO,OTDNURNO
          MOVE      OPRSRDTE,OTDNADAT
          MOVE      OPRSRTIM,OTDNATIM
          MOVE      " 2",OTDNATYP                * Reschedule appointment
          MOVE      OPRSOUTN,OTDNVISN
          MOVE      OPRSDATE,OTDNVDAT
.
          PACK      OTDNCDAT,CCC,CYY,CMM,CDD
          REP       " 0",OTDNCDAT           *
          CLOCK     TIME,OTDNCTIM
          MOVE      USERID,OTDNCUID
.
          PACK      KEY34,OTDNURNO,OTDNADAT,OTDNATIM,OTDNATYP,OTDNVISN,SP70
          CALL      RAOTDAN1
          IF        OVRCD=1
            CALL      WROTDAN1                    * Write actions record
          ENDIF
.
          MOVE      OTDNURNO,COMMURNO
          MOVE      OTDNADAT,COMMADAT
          MOVE      OTDNATIM,COMMATIM
          MOVE      " 2",COMMTYPE            * Reschedule Appointment
          CALL      UPOPD000                 * OPD Message
.
ROPD9999  RETURN
+
.------------------------------------------------------------
. Check for Master Suspension
.------------------------------------------------------------
CHKSUS00  MOVE      ZERO,EXIT
          PACK      KEY24,OSESITE,OSECLIN,OSEDAY,Z70
          CALL      RSOTMSP1
CHKSUS10  CALL      RPOTMSP1
          BRANCH    OVRCD,CHKSUS99
          MATCH     OSESITE,OTMSSITE
          GOTO      CHKSUS99 IF NOT EQUAL
          MATCH     OSECLIN,OTMSCLIN
          GOTO      CHKSUS99 IF NOT EQUAL
          MOVE      OSEDAY,KEY1
          MATCH     KEY1,OTMSDOWK
          GOTO      CHKSUS99 IF NOT EQUAL
.
          MATCH     OSESTRT,OTMSSTIM             * Same session start time
          GOTO      CHKSUS10 IF NOT EQUAL
.
.         MATCH     SP70,OTMSTDAT
.         IF        !@EQUAL
.           MATCH     OTMSTDAT,OSEDATE           * ????????????
.           GOTO      CHKSUS10 IF LESS
.         ENDIF
.
          MATCH     OTMSFDAT,OSEDATE
          GOTO      CHKSUS10 IF LESS
          GOTO      CHKSUS20 IF EQUAL
.
          MATCH     OSEDATE,OTMSTDAT
          GOTO      CHKSUS10 IF LESS
.
CHKSUS20  MOVE      ONE,EXIT
.
CHKSUS99  RETURN
+
.**********************************************************************
.*  CHKD0000  - Check if there are any deposits for this visit if so  *
.*              display an error                                      *
.**********************************************************************
CHKD0000  MOVE      ZERO,EXIT
          MOVE      "0",CMDESTAT
          PACK      KEY26,OBAOUTNO,CMDESTAT,SP70
          CALL      RSCMDEP2
          CALL      RKCMDEP2
          BRANCH    OVRCD,CHKD9999
.
          MATCH     DOBAOUTN,CMDEADMN            * Same outpatient booking
          GOTO      CHKD9999 IF NOT EQUAL
          MATCH     "0",CMDESTAT                 * Deposit held?
          GOTO      CHKD9999 IF NOT EQUAL        * so check for other deposits
.
CHKD9000  MOVE      ONE,EXIT
          GOTO      CHKD9999

CHKD9999  RETURN
+
.*******************************************************************************
. OPD appointment comments
.*******************************************************************************
.         copy the comments back to file - first delete existing comments
.
UPOPD000  BRANCH    OPDFLAG,UPOPD999
.
          PACK      KEY29,COMMURNO,COMMADAT,COMMATIM,COMMTYPE,SP70
          CALL      RSOTDCO1
UPOPD400  CALL      RKOTDCO1
          BRANCH    OVRCD,UPOPD500          * end of file
.
          MATCH     COMMURNO,OTDOURNO
          GOTO      UPOPD500 IF NOT EQUAL
.
          MATCH     COMMADAT,OTDOADAT
          GOTO      UPOPD500 IF NOT EQUAL
.
          MATCH     COMMATIM,OTDOATIM
          GOTO      UPOPD500 IF NOT EQUAL
.
          MATCH     COMMTYPE,OTDOATYP
          GOTO      UPOPD500 IF NOT EQUAL
.
          PACK      KEY29,OTDOURNO,OTDOADAT,OTDOATIM,OTDOATYP,OTDOCLNO,SP70
          CALL      DEOTDCO1
          GOTO      UPOPD400
.
.         now write the new comments back
.
UPOPD500  MOVE      COMMURNO,OTDOURNO
          MOVE      COMMADAT,OTDOADAT
          MOVE      COMMATIM,OTDOATIM
          MOVE      COMMTYPE,OTDOATYP
          MOVE      ZERO,F3
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      COMFILAF,COMFILNO
          TRAPCLR   IO
          BRANCH    OVRCD,UPOPD999
.
UPOPD510  ADD       ONE,F3
          READ      COMFILOF,SEQ;OTDOCOMM
.
          MATCH     SP70,OTDOCOMM
          IF        @EQUAL
            IF        F3>=OPDWEND
              GOTO      UPOPD999
            ELSE
              GOTO      UPOPD510
            ENDIF
          ENDIF
.
          MOVE      F3,OTDOCLNO
          PACK      KEY29,OTDOURNO,OTDOADAT,OTDOATIM,OTDOATYP,OTDOCLNO,SP70
          CALL      WROTDCO1
          IF        F3>=OPDWEND
            GOTO      UPOPD999
          ENDIF
          GOTO      UPOPD510
.
UPOPD999  MOVE      ONE,OPDFLAG
          RETURN
+
.------------------------------------------------------------
. Update referral status to waiting/active
.------------------------------------------------------------
URSR0000  MOVE      SP70,BOOKDATE
.
          PACK      KEY8,ALLNVISN,SP70      * Patient Referral Details
          CALL      RDALREF1
          BRANCH    OVRCD,URSR9999
.
          MATCH     "0",ALRESTAT           * Waiting
          GOTO      URSR1000 IF EQUAL
.
          MATCH     "1",ALRESTAT            * Active
          GOTO      URSR1000 IF EQUAL
.
          GOTO      URSR9999                * Not waiting/Active so exit
.
URSR1000  CALL      ARMHI000              * Set MHINC indicator
          PACK      KEY16,ALREVISN,SP70
          CALL      RSALLNK1
URSR1050  CALL      RKALLNK1
          BRANCH    OVRCD,URSR2000
.
          MATCH     ALREVISN,ALLNVISN       * Linked bookings
          IF        @EQUAL
            MATCH     "1",ALLNSTAT          * Skip cancelled booking
            GOTO      URSR1050 IF EQUAL
.
            CALL      DATR0000              * Get first booking date
            GOTO      URSR9100
          ENDIF
.
URSR2000  PACK      KEY16,ALREVISN,SP70
          CALL      RSALENC1
          CALL      RKALENC1
          BRANCH    OVRCD,URSR9000
.
          MATCH     ALREVISN,ALENVISN       * Encounters
          GOTO      URSR9200 IF EQUAL
.
URSR9000  MATCH     "0",ALRESTAT
          IF        !@EQUAL
            MOVE      TWO,AUDTTYPE            * before history record
            CALL      WAALRE00

.           MOVE      ZERO,ALRESTAT         * Update status to waiting
            MOVE      SP70,ALREREXP         * Clear expiry date if not linked
            CALL      UPALREF1
.
            CALL      PMIGTNID              * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      TEN8,HL7TRGID
            MOVE      SP8,HL7INCLD
            CALL      DGCLII13              * broadcast Update Ref. (REF^I13)
.
            MOVE      THREE,AUDTTYPE        * after history record
            CALL      WAALRE00
          ENDIF
          GOTO        URSR9999
.
URSR9100  MOVE      TWO,AUDTTYPE            * before history record
          CALL      WAALRE00
.
          MATCH     "0",ALRESTAT
          IF        @EQUAL
            CALL      IBACLOCK
            PACK      ALREDACT,CCC,CYY,CMM,CDD
            REP       " 0",ALREDACT
          ENDIF
.
          MOVE      ONE,ALRESTAT          * Update status to active
          CALL      CALX0000              * Calculate referral expiry date
          CALL      UPALREF1
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TEN9,HL7TRGID
          MOVE      SP8,HL7INCLD
          CALL      DGCLII13                * broadcast Update Ref. (REF^I13)
.
          MOVE      THREE,AUDTTYPE          * after history record
          CALL      WAALRE00
          GOTO      URSR9999
.
URSR9200  MATCH     "1",ALRESTAT            * EOC only no linked referrals
          IF        !@EQUAL
            MOVE      TWO,AUDTTYPE            * before history record
            CALL      WAALRE00
.
            MOVE      ONE,ALRESTAT          * Update status to active
            MOVE      SP70,ALREREXP         * Clear expiry date if not linked
            CALL      UPALREF1
.
            CALL      PMIGTNID              * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      TWENTY,HL7TRGID
            MOVE      SP8,HL7INCLD
            CALL      DGCLII13              * broadcast Update Ref. (REF^I13)
.
            MOVE      THREE,AUDTTYPE        * after history record
            CALL      WAALRE00
          ENDIF
          GOTO        URSR9999
.
URSR9999  RETURN
+
.------------------------------------------------------------
. Work out the first booking date for this referral
.------------------------------------------------------------
DATR0000  MOVE      SP70,BOOKDATE
.
          PACK      KEY16,ALREVISN,SP70
          CALL      RSALLNK1
DATR1000  CALL      RKALLNK1
          BRANCH    OVRCD,DATR9999
.
          MATCH     ALREVISN,ALLNVISN       * Linked bookings
          GOTO      DATR9999 IF NOT EQUAL
.
          MATCH     SP70,BOOKDATE
          IF        @EQUAL
            MOVE      ALLNDATE,BOOKDATE         * Calc ref expiry
          ENDIF
.
          MATCH     BOOKDATE,ALLNDATE
          IF        @LESS
            MOVE      ALLNDATE,BOOKDATE
          ENDIF
          GOTO      DATR1000
.
DATR9999  RETURN
+
.---------------------------------------------------
. Reduce Attendance Count on Session
.---------------------------------------------------
SUBATT00  MOVE      ZERO,LOCKCNT
          MOVE      "CV",KEY2
          PACK      KEY5,KEY2,OBAVISIT
          CALL      RDCODE1
          BRANCH    OVRCD,SUBATT98
.
SUBATT10  PACK      KEY25,SESSKEYS,SP70
          CALL      RLOTSES1
          BRANCH    OVRCD,SUBATT98,SUBATT90
          MATCH     ANSN,TCINDC1
          IF        @EQUAL
            SUB       ONE,OSEANEW
          ENDIF
          MATCH     ANSR,TCINDC1
          IF        @EQUAL
            SUB       ONE,OSEARV
          ENDIF
          MATCH     ANSS,TCINDC1
          IF        @EQUAL
            SUB       ONE,OSEASPC
          ENDIF
          CALL      UPSESA1
          CALL      UUOTSES1
          MOVE      ZERO,EXIT
          GOTO      SUBATT99
SUBATT90  DISPLAY   *W
          ADD       ONE,LOCKCNT
          IF        LOCKCNT<5
            GOTO      SUBATT10
          ENDIF
SUBATT98  MOVE      ONE,EXIT
SUBATT99  RETURN
+
.------------------------------------------------------------
. Delete transport details when cancelling a booking
.------------------------------------------------------------
DTRN0000  PACK      KEY19,OBAURNO,OBAOUTNO,SP70
          CALL      RSPMTSP1
          CALL      RKPMTSP1
          BRANCH    OVRCD,DTRN9999
.
          MATCH     OBAURNO,PMTSURNO             * Correct U/R
          GOTO      DTRN9999 IF NOT EQUAL
.
          MATCH     DOBAOUTN,PMTSVISN            * Correct Visit
          GOTO      DTRN9999 IF NOT EQUAL
.
          PACK      KEY19,PMTSURNO,PMTSVISN,PMTSUNIQ,SP70
          CALL      DEPMTSP1                     * Delete Transport Details
.
          GOTO      DTRN0000
.
DTRN9999  RETURN
+
.*******************************************************************************
. RMDIS000 - Remove disaster details when cancelling preadmission
.*******************************************************************************
..  First, delete the disaster link record if there is one
RMDIS000  PACK     SAVDISKY,SP70
          PACK     KEY25,URNUMBER,SP70
          CALL     RSDSPTL1
RMDIS100  CALL     RKDSPTL1
          BRANCH   OVRCD,RMDIS999
.
          MATCH    DSPLURNO,URNUMBER
          GOTO     RMDIS999 IF NOT EQUAL
.
          MATCH    DSPLVISN,ADMISSNO
          GOTO     RMDIS100 IF NOT EQUAL
.
          PACK     KEY25,DSPLURNO,DSPLCODE,DSPLVISN,SP70
          CALL     DEDSPTL1
          PACK     SAVDISKY,DSPLURNO,DSPLCODE,SP70
.
..  If this was the only disaster link record, delete the patient level record
.
          PACK     KEY25,URNUMBER,SP70
          CALL     RSDSPTL1
          CALL     RKDSPTL1
          BRANCH   OVRCD,RMDIS200
.
          MATCH    DSPLURNO,URNUMBER
          GOTO     RMDIS200 IF NOT EQUAL
          GOTO     RMDIS999
.
RMDIS200  PACK     KEY17,SAVDISKY,SP70
          CALL     DEDSPAT1
          CALL     DELALT00
.
RMDIS999  RETURN
+
.*******************************************************************************
.                        Cancellation text comments
.*******************************************************************************
.         copy the comments back to file - first delete existing comments
.
UPCOM000  MOVE      "005",KEY3
          PACK      KEY14,ADMISSNO,KEY3,SP70
          CALL      RSVSCMT1
UPCOM400  CALL      RKVSCMT1
          BRANCH    OVRCD,UPCOM500          * end of file
          MATCH     VSCTVIST,ADMISSNO       * same Admission Number?
          GOTO      UPCOM500 IF NOT EQUAL
          MATCH     VSCTTYPE,KEY3
          GOTO      UPCOM500 IF NOT EQUAL
.
          PACK      KEY14,VSCTVIST,VSCTTYPE,VSCTLINE
          CALL      DEVSCMT1
          GOTO      UPCOM400
.
.         now write the new comments back
.
UPCOM500  MOVE      ADMISSNO,VSCTVIST          * set Admission Number
          MOVE      KEY3,VSCTTYPE
          MOVE      ZERO,F3
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      COMFILAF,COMFILNM
          TRAPCLR   IO
          BRANCH    OVRCD,UPCOM999
.
UPCOM510  ADD       ONE,F3
          READ      COMFILAF,SEQ;VSCTDATA
.
          MATCH     SP70,VSCTDATA
          IF        @EQUAL
            IF        F3>=OTXWEND
              GOTO      UPCOM999
            ELSE
              GOTO      UPCOM510
            ENDIF
          ENDIF
.
          MOVE      F3,VSCTLINE
          PACK      KEY14,VSCTVIST,VSCTTYPE,VSCTLINE
          CALL      WRVSCMT1
          IF        F3>=OTXWEND
            GOTO      UPCOM999
          ENDIF
          GOTO      UPCOM510
.
UPCOM999  MOVE      ONE,OTXFLAG
          RETURN
+
.**********************************************************************
.*  SCAN0000  - Update the status of a series booking to cancelled    *
.*              OTLKBSTA  1=Cancelled  0=Not Cancelled                *
.**********************************************************************
SCAN0000  PACK      KEY24,OBAURNO,OBAOUTNO,SP70 * Is this a master record
          CALL      RDOTLKB1
          BRANCH    OVRCD,SCAN1000
.
          MOVE      ONE,OTLKBSTA
          PACK      OTLKUDAT,CCC,CYY,CMM,CDD * current date
          REP       " 0",OTLKUDAT
          MOVE      CTIMEIS,OTLKUTIM
          MOVE      WBSEUID,OTLKUUID
          CALL      UPOTLKB1
          GOTO      SCAN9999
.
SCAN1000  PACK      KEY24,OBAURNO,OBAOUTNO,SP70 * Check non master records
          CALL      RSOTLKB2
          CALL      RKOTLKB2
          BRANCH    OVRCD,SCAN9999
.
          MATCH     OBAURNO,OTLKURNO
          GOTO      SCAN9999 IF NOT EQUAL
.
          MATCH     DOBAOUTN,OTLKLBOK
          GOTO      SCAN9999 IF NOT EQUAL
.
          MOVE      ONE,OTLKBSTA
          PACK      OTLKUDAT,CCC,CYY,CMM,CDD * current date
          REP       " 0",OTLKUDAT
          MOVE      CTIMEIS,OTLKUTIM
          MOVE      WBSEUID,OTLKUUID
          CALL      UPOTLKB2
.
SCAN9999  RETURN
+
.******************************************************************************
.*             LOGC0000: Log the cancellation of a booking                    *
.******************************************************************************
LOGC0000  MOVE      OBAOUTNO,KEY8            * Key for the bokb record
          CALL      RDBOKB1                  * Read in the bokb record
          BRANCH    OVRCD,LOGC9999           * Details missing
.
.         Open the log file and post the record
.
          MOVE      OUTBB053,OPCNREAS        * Reason
          MOVE      OBASITE,OPCNSITE         * Site
          MOVE      OBACLIN,OPCNCLIN         * Clinic Id
          MOVE      OBADATE,OPCNDATE         * Booking Date
          MOVE      OBASTRT,OPCNSTRT         * Clinic Start Time
          MOVE      OBASLOT,OPCNSLOT         * Booking Slot Number
          MOVE      OBATIME,OPCNTIME         * Booking Slot Time
          MOVE      OBAOUTNO,OPCNOUTN        * Outpatient Number
          MOVE      OBAURNO,OPCNURNO         * Site
          PACK      OPCNRDTE,CCC,CYY,CMM,CDD * Cancellation date
          REP       " 0",OPCNRDTE        * Zero-fill Cancellation DAte
          CLOCK     TIME,OPCNRTIM            * Cancellation Time
          MOVE      OBASRCR,OPCNSRCR         * Source of Referral
          MOVE      OBACOMP,OPCNCOMP         * Compensation Eligibilty
          MOVE      OBACLASS,OPCNCLAS        * Patient Classification
          MOVE      OBAINS,OPCNINS           * U1 User Defined field
          MOVE      OBACAT,OPCNCAT           * Patient Category
          MOVE      OBAPRTY,OPCNPRTY         * Priority Code
          MOVE      OTBBTRAN,OPCNTRAN        * Transport Allocation (cat oB)
          MOVE      OBAVISIT,OPCNVTYP        * Visit type (Cat CV)
          MOVE      PASSCODE,OPCNOPER
.
          MOVE      OBACTYP,OPCNCTYP         * Clinic Type
          MOVE      OTBBNMDS,OPCNNMDS        * NMDS Clinic (Cat NM)
          MOVE      OTBBSRVD,OPCNSRVC        * Service Delivery (Cat sd)
          MOVE      OTBBCART,OPCNCART        * Care Type (Cat CC)
          MOVE      OBABKDTE,OPCNBKDT        * Book Date/Time
          MOVE      SP70,OPCNSPAR            * Spare Variable
.
          MOVE      SP70,OPCNREFN            * linked AH referral number
          PACK      KEY16,OBAOUTNO,SP70
          CALL      RSALLNK2
          CALL      RKALLNK2
          BRANCH    OVRCD,LOGC0800          * not a referral
.
          MATCH     DOBAOUTN,ALLNLNKV
          GOTO      LOGC0800 IF NOT EQUAL
.
          MOVE      ALLNVISN,OPCNREFN        * linked AH referral number
.
LOGC0800  MOVE      OPCNOUTN,KEY8            * Key for file
          CALL      RAOTCAN1
          BRANCH    OVRCD,LOGC1000           * not exists
          CALL      UPOTCAN1                 * Update the cancellation record
          GOTO      LOGC2000
.
LOGC1000  CALL      WROTCAN1                 * Write the cancellation record
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TEN3,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICOC                * DG O/P Cancel Appoint    *I-90203
.
LOGC2000  MOVE      ZERO,EXIT
          GOTO      LOGC9999
.
LOGC9500  MOVE      ONE,EXIT
LOGC9999  RETURN
+
.*******************************************************************************
.         Set the Outpatient linked Referral status to Waiting
.*******************************************************************************
RETREW00  PACK      KEY16,OBAOUTNO,SP70
          CALL      RSALLNK2
          CALL      RKALLNK2
          BRANCH    OVRCD,RETREW99     * no Referral links
.
          MATCH     DOBAOUTN,ALLNLNKV  * same Outpatient visit no?
          GOTO      RETREW99 IF NOT EQUAL
.
          PACK      KEY8,ALLNVISN,SP70 * get Referral Details
          CALL      RDALREF1
          BRANCH    OVRCD,RETREW99
.
          MOVE      ZERO,ALRESTAT      * set status to Waiting
          CALL      UPALREF1
.
          CALL      PMIGTNID           * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      FORTY3,HL7TRGID
          MOVE      SP8,HL7INCLD
          CALL      DGCLII13           * broadcast Update Ref. (REF^I13
.
RETREW99  RETURN
+
.*******************************************************************************
.  CLET0000 - Clear the referral letter booked site and clinic if an appointment
.             is cancelled
.*******************************************************************************
CLET0000  READ      CONTROLF,THIRTY1;*174,OTCNULET
          COMPARE   ONE,OTCNULET
          GOTO      CLET9999 IF NOT EQUAL   * not using referral letters
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDOTRFL1
          BRANCH    OVRCD,CLET9999          * not a referral
.
          MOVE      SP70,OTRLBSIT
          MOVE      SP70,OTRLBCLI
          MOVE      SP70,OTRLBDTE
          MOVE      SP70,OTRLBSTR
          MOVE      SP70,OTRLBSLT
.
          MATCH     Z70,OTRFL017
          IF        !@EQUAL
            MOVE      OTRFL017,OTRLCDTE     * Cancellation Date
          ENDIF
.
          MATCH     Z70,OTRFL018
          IF        !@EQUAL
            MOVE      OTRFL018,OTRLREAS     * Cancellation Reason
          ENDIF
.
          PACK      OTRLUDAT,CCC,CYY,CMM,CDD
          REP       " 0",OTRLUDAT
          CLOCK     TIME,OTRLUTIM
          MOVE      WBSEUID,OTRLUUID
.
          CALL      UPOTRFL1
.
          CALL      PRTLET00               * Print referral letter
.
CLET9999  RETURN
+
.---------------------------------------------------------------------------
. Write new appointment request for cancelled booking
.---------------------------------------------------------------------------
WREQ0000  MATCH     "1",REQUESTA                 * Write appointment request
          GOTO      WREQ9999 IF NOT EQUAL
.
          MATCH     Z70,OTART001                 * U/R
          GOTO      WREQ9999 IF EQUAL
.
          MATCH     Z70,OTART002                 * Referral Number
          GOTO      WREQ9999 IF EQUAL
.
          MOVE      OBAOUTNO,KEY8                * Read visit extn to get
          CALL      RDPMVX11                     * pres comp and hospital
          BRANCH    OVRCD,WREQ9999
.
          CALL      CLOUTART                     * Clear file vars
          MOVE      OTART001,OTARURNO            * U/R
          MOVE      OTART002,OTARREFN            * Referral
.
          PACK      KEY8,OTARREFN,SP70
          CALL      RDALREF1
          IF        OVRCD=1
            CALL      CLALLREF
          ENDIF
.
          MOVE      OPCNRDTE,OTARRQDT            * Use cancellation date time
          MOVE      OPCNRTIM,OTARRQTM            * as request date and time
.
          PACK      KEY32,OTARURNO,OTARREFN,OTARRQDT,OTARRQTM,SP70
          CALL      RDOTART1
          COMPARE   ZERO,OVRCD
          GOTO      WREQ9999 IF EQUAL
.
          MOVE      ALREDEPT,OTARRDEP    * Requesting Department
          MOVE      ALREDEPT,OTARADEP    * Appointment with Department(Cat.AC)
          MOVE      PMVXMHOS,OTARPRHS    * Preferred Hospital
          MOVE      OBASITE,OTARPRSI     * Preferred Site
          MOVE      OBACTYP,OTARCLTY     * Clinic Type
          MOVE      OBACLIN,OTARCLID     * Clinic Id
          MOVE      OBAVISIT,OTARVIST    * Visit Type                 (Cat.CV)
          MOVE      OTBBTRAN,OTARTRRQ    * Transport Required         (Cat.OB)
          MOVE      PMVXUDF1,OTARPCOM    * Presenting Complaint
          MOVE      OBACOMP,OTARFINC     * Financial Class            (Cat.CL)
          MOVE      OBAPRTY,OTARPRIO     * Priority                   (Cat.PR)
          MOVE      ALRESRCE,OTARSORF    * Source of Referral         (Cat.S )
          MOVE      OTBBSPCA,OTARSARR    * Special Arrangements       (Cat.SA)
          MOVE      OBAOUTNO,OTAROOBN    * Original O/P Booking Number
          MOVE      ONE,OTARSTAT         * Status   1 - Pending Reschedule
          MOVE      PMVXINTR,OTARINTR    * Interpreter required
          MOVE      PMVXLNG1,OTARLNG1    * Preferred language
.
          MATCH     OTART021,Z70
          IF        !@EQUAL
            MOVE      OTART021,OTARRREQ
          ENDIF
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,OTARCDAT        * System date
          CLOCK     TIME,OTARCTIM        * System time
          MOVE      USERID,OTARCUID      * web user id
.
          PACK      KEY32,OTARURNO,OTARREFN,OTARRQDT,OTARRQTM,SP70
          CALL      WROTART1
.
          STRIP     REDIRECT                     * Append key for request to
          ENDSET    REDIRECT                     * redirect popup
          APPEND    "&popupreq=",REDIRECT
          APPEND    KEY32,REDIRECT
          RESET     REDIRECT
.
WREQ9999  RETURN
+
.---------------------------------------------------------------------
. DELALT00 - Delete alternate ID record for disaster patients
.---------------------------------------------------------------------
DELALT00  UNPACK    SAVDISKY,DIM8,DIM9
          PACK      KEY9,DIM9,SP70
          CALL      RDDSMAS1
          BRANCH    OVRCD,DELALT99
.
          MATCH     SP70,DSMAAICD
          GOTO      DELALT99 IF EQUAL
          GOTO      DELALT99 IF EOS
.
          PACK      KEY31,DIM8,DSMAAICD,SP70
          CALL      RSPMAID1
          CALL      RKPMAID1
          BRANCH    OVRCD,DELALT99
.
          MATCH     PMAIURNO,DIM8
          GOTO      DELALT99 IF NOT EQUAL
.
          MATCH     PMAITYPE,DSMAAICD
          GOTO      DELALT99 IF NOT EQUAL
.
          PACK      KEY31,PMAIURNO,PMAITYPE,PMAIALID,SP70
          CALL      DEPMAID1
.
DELALT99  RETURN
+
.------------------------------------------------------------------------------
. Print Referral Letter
.------------------------------------------------------------------------------
PRTLET00  MATCH     Z70,LETNUMBR
          GOTO      PRTLET99 IF EQUAL
          MATCH     SP70,LETNUMBR
          GOTO      PRTLET99 IF EQUAL
.
          MOVE      LETPRNTR,SCHDPRNT
          MOVE      ONE,SCHDCOPY
          MOVE      LETTRREF,SETDFPRG
          MOVE      "1",SETDFRPT
          CALL      SETDEF00
.
          MOVE      LETNUMBR,LETTNCOD
.
PRTLET10  PACK      KEY5,Z70
          CALL      RSOTLPC1
          CALL      RPOTLPC1
          IF        OVRCD=1
            MOVE      ZERO,F5
            MOVE      F5,OTLPSCHE
          ENDIF
.
          MOVE      OTLPSCHE,F5
          ADD       ONE,F5
          MOVE      F5,OTLPSCHE
          MOVE      OTRLURNO,OTLPURNO
          MOVE      OTRLOUTN,OTLPBOOK
          MOVE      OTRLSITE,OTLPSITE
          MOVE      SP70,OTLPCLIN
          MOVE      SP70,OTLPSDAT
          MOVE      SP70,OTLPSTIM
          MOVE      SP70,OTLPSLOT
.
          MOVE      LETPRNTR,OTLPPRNT
          MOVE      ONE,OTLPCOPY
          MOVE      SP70,OTLPSTAT
          MOVE      LETTNCOD,OTLPLETT
          MOVE      TWO,OTLPPTYP
          MOVE      USERID,OTLPWEBU
          PACK      OTLPRDAT,CCC,CYY,CMM,CDD
          REP       " 0",OTLPRDAT
          MOVE      CTIMEIS,OTLPRTIM
.
PRTLET50  PACK      KEY5,OTLPSCHE
          CALL      RAOTLPC1
          IF        OVRCD=1
            TRAP      WRTRAPR IF IO               * Trap to stop I * D when
            CALL      WROTLPC1                   * multiple servers write to the
            TRAPCLR   IO                         * outpatient print file
          ELSE
            GOTO      PRTLET10
          ENDIF
.
PRTLET99  RETURN
.
WRTRAPR   NORETURN
          ADD         ONE,F5
          MOVE        F5,OTLPSCHE
          GOTO        PRTLET50
+
.*******************************************************************************
.                          Add Slot to a Session
.*******************************************************************************
ADDSLT00  PACK      KEY5,ANSC,ANSV,NEWSLTYP,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ADDSLT97
.
          MATCH     ANSZ,TCINDC2
          IF        @EQUAL
            CALL      ADDOVR00              * Add new over booking slot
            BRANCH    EXIT,ADDSLT99         * Errors are in ADDOVR00
            GOTO      ADDSLT85
          ENDIF
.
          PACK      KEY28,SESSKEYS,SP70
          CALL      RDBOKA1
          MOVE      ZERO,SLTEXFLG           * Reset "Slot Exist" Flag
          MOVE      ZERO,OBASLOT
ADDSLT10  MOVE      OBASLOT,BEFSLOT
          CALL      RDKBOKA1
          BRANCH    OVRCD,ADDSLT50
.
          PACK      KEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT
          MATCH     KEY28,SESSKEYS
          GOTO      ADDSLT50 IF NOT EQUAL
.
          PACK      KEY5,ANSC,ANSV,OBAVISIT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ADDSLT10
.
          MATCH     ANSZ,TCINDC2           * Finished if up to over booked slots
          GOTO      ADDSLT50 IF EQUAL
.
          MOVE      ONE,SLTEXFLG            * Slot found, set "Slot Exist" Flag
          MATCH     NEWSLTIM,OBATIME
          GOTO      ADDSLT10 IF LESS
.
          COMPARE   THREE,OBASTAT      * Is the next slot an extended slot?
          GOTO      ADDSLT96 IF EQUAL  * Yes, new slot can not be added.
.
          ASSIGN    ((OBASLOT-BEFSLOT)/2)+BEFSLOT,OBASLOT
          PACK      CASEKEYS,SESSKEYS,OBASLOT
          MOVE      OBACTYP,VCTYP
          MOVE      OBADAY,WDAY
          MOVE      OBASESST,VSESST
.
          CALL      WSLT0000
          BRANCH    EXIT,ADDSLT95
.
          GOTO      ADDSLT85
.
ADDSLT50  COMPARE   ZERO,SLTEXFLG        * Is the session empty?
          GOTO      ADDSLT60 IF EQUAL    * Yes, go to insert first slot
          CALL      RDPBOKA1             * Add New Slot After End of Slots
          BRANCH    OVRCD,ADDSLT99
.
          PACK      KEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT
          MATCH     KEY28,SESSKEYS
          GOTO      ADDSLT99 IF NOT EQUAL
.
          ASSIGN    10+BEFSLOT,OBASLOT
          PACK      CASEKEYS,SESSKEYS,OBASLOT
          MOVE      OBACTYP,VCTYP
          MOVE      OBADAY,WDAY
          MOVE      OBASESST,VSESST
          GOTO      ADDSLT80
.
ADDSLT60  PACK      KEY25,SESSKEYS,SP70     * Add first slot to an empty session
          CALL      RDSESA1                 * Get Day Ind from session file
          BRANCH    OVRCD,ADDSLT99
.
          UNPACK    SESSKEYS,OMASITE,OMACLIN,DIM8,OMASTART
          PACK      KEY18,OMASITE,OMACLIN,OSEDAY,OMASTART,SP70
          CALL      RDMASA1                 * Get Clinic Type
          BRANCH    OVRCD,ADDSLT99
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,ADDSLT99
.
          MOVE      TEN,OBASLOT
          PACK      CASEKEYS,SESSKEYS,OBASLOT
          MOVE      OTHECTYP,VCTYP            * Set Clinic Type
          MOVE      OSEDAY,WDAY             * Set Day Indicator
          MOVE      SP10,VSESST
.
ADDSLT80  CALL      WSLT0000
          BRANCH    EXIT,ADDSLT95
.
ADDSLT85  STRIP     REDIRECT                * HPS_ODC Starts here
          ENDSET    REDIRECT
.
          MATCH     "3",SLOTBTYP            * Follow-Up Appointment
          IF        @EQUAL
            APPEND    "&addslotk=",REDIRECT
            PACK      NEWSLOTK,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
            REP       " +",NEWSLOTK
            APPEND    NEWSLOTK,REDIRECT
          ELSE
            MATCH     "4",SLOTBTYP            * Reschedule Appointment
            IF        @EQUAL
              APPEND    "&addslotk=",REDIRECT
              PACK      NEWSLOTK,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
              REP       " +",NEWSLOTK
              APPEND    NEWSLOTK,REDIRECT
            ELSE
              MATCH     "5",SLOTBTYP            * DNA Appointment
              IF        @EQUAL
                APPEND    "&addslotk=",REDIRECT
                PACK      NEWSLOTK,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
                REP       " +",NEWSLOTK
                APPEND    NEWSLOTK,REDIRECT
              ELSE
                APPEND    "&casekeys=",REDIRECT
                PACK      CASEKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
                REP       " +",CASEKEYS
                APPEND    CASEKEYS,REDIRECT
              ENDIF
            ENDIF
          ENDIF
          RESET     REDIRECT
.
ADDSLT86  MATCH     "HL7RECVR",PRGID
          IF        !@EQUAL
            CALL      NXTPAG00              * HPS Ends here
            MOVE      ONE,EXIT
          ENDIF
          GOTO      ADDSLT99
.
ADDSLT95  MATCH     "HL7RECVR",PRGID
          IF        @EQUAL
            MOVE      ZERO,EXIT
            CALL      ADDOVR00              * Add new over booking slot
            BRANCH    EXIT,ADDSLT99         * Errors are in ADDOVR00
          ELSE
            MOVE      "Session slot time is full - slot not added. ",WEBTITLE
            CALL      WEBERR00
            MOVE      ONE,EXIT
          ENDIF
          GOTO      ADDSLT99
.
ADDSLT96  MATCH     "HL7RECVR",PRGID
          IF        @EQUAL
            MOVE      ZERO,EXIT
            CALL      ADDOVR00              * Add new over booking slot
            BRANCH    EXIT,ADDSLT99         * Errors are in ADDOVR00
          ELSE
            MOVE      "Slot can not be added before an extended slot.",WEBTITLE
            CALL      WEBERR00
            MOVE      ONE,EXIT
          ENDIF
          GOTO      ADDSLT99
.
ADDSLT97  MOVE      "Invalid slot visit type.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDSLT99
.
ADDSLT99  RETURN
+
.*******************************************************************************
.                          Add Overbooking Slot to a Session
.*******************************************************************************
ADDOVR00  PACK      KEY25,SESSKEYS,SP70     * Add first slot to an empty session
          CALL      RDSESA1                 * Get Day Ind from session file
          BRANCH    OVRCD,ADDOVR99
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,ADDOVR99
.
          UNPACK    SESSKEYS,OMASITE,OMACLIN,DIM8,OMASTART
          PACK      KEY18,OMASITE,OMACLIN,OSEDAY,OMASTART,SP70
          CALL      RDMASA1                 * Get Clinic Type
          BRANCH    OVRCD,ADDOVR99
.
          PACK      KEY28,SESSKEYS,Z70
          MOVE      ZERO,SLTEXFLG
          CALL      RDBOKA1
ADDOVR10  MOVE      OBASLOT,BEFSLOT
          CALL      RDPBOKA1
          BRANCH    OVRCD,ADDSLT50
.
          PACK      KEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT
          MATCH     KEY28,SESSKEYS
          GOTO      ADDOVR50 IF NOT EQUAL
.
          MOVE      ONE,SLTEXFLG            * Slot found, set "Slot Exist" Flag
.
          IF        OBASLOT=999
            GOTO      ADDOVR95              * No more free slots
          ENDIF
.
ADDOVR50  IF        SLTEXFLG=0
            MOVE      "900",OBASLOT
          ELSE
            IF        OBASLOT<900
              MOVE      "900",OBASLOT
            ELSE
              ADD       ONE,OBASLOT
            ENDIF
          ENDIF
.
          PACK      CASEKEYS,SESSKEYS,OBASLOT
          MOVE      OTHECTYP,VCTYP          * Set Clinic Type
          MOVE      OSEDAY,WDAY             * Set Day Indicator
          MOVE      SP10,VSESST
.
ADDOVR70  CALL      WSLT0000
          BRANCH    EXIT,ADDOVR95

ADDOVR80  MOVE      ZERO,EXIT
          GOTO      ADDOVR99
.
ADDOVR95  MOVE      "Session slot time is full - slot not added. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDSLT99
.
ADDOVR99  RETURN
+
.*******************************************************************************
.          WSLT0000: Write a new empty slot to the bookings file
.*******************************************************************************
WSLT0000  UNPACK    CASEKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,VSLOT
          MOVE      VSLOT,OBASLOT            * Clinic type
          MOVE      NEWSLTIM,OBATIME         * Slot time to write
          MOVE      NEWSLTYP,OBAVISIT        * Visit type
.
          MOVE      VCTYP,OBACTYP            * Clinic type
          MOVE      WDAY,OBADAY              * Day of the Week
          MOVE      VSESST,OBASESST          * Session status code
.
          MOVE      ZERO,OBAEXSL             * Parent slot (none)
          MOVE      SP4,OBAFINST             * Final stats not done
          MOVE      SP2,OBALOCK              * Locking variable
          MOVE      ZERO,OBAPXRAY            * Clinic status
          MOVE      SP30,OBABKDTE            * Booking date/time
          MOVE      ZERO,OBAPULL             * Hasn't appeared on pulling list
          MOVE      SP3,OBADISCH             * Discharge status
          MOVE      SP6,OBASPARA             * Spare variable
          MOVE      ZEROVISN,OBAOUTNO        * Outpatient number
          MOVE      ZEROUR,OBAURNO           * U/R Number
          MOVE      ZERO,OBASTAT             * Status = Not Booked
.
          COMPARE   ZERO,OBASLOT
          IF        @EQUAL
            MOVE      ONE,EXIT               * Can't add slot zero. Report
            GOTO      WSLT9999               * error slot time full
          ENDIF
.
          PACK      KEY28,CASEKEYS,SP70      * Key for this new record
          CALL      RDABOKA1                 * Write the new record
          IF        OVRCD=1
.
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            CALL      WRBOKA1                  * Write the new record
            TRAPCLR   IO
            BRANCH    OVRCD,WSLT9999
.
            MOVE      ONE,AUDIFLAG             * set to a write audit
            CALL      AUDOTBOA                 * write the audit
            PACK      SESSKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
            CALL      ADDSCH00                 * Increment Schedule Count
          ELSE
            MOVE      ONE,EXIT
          ENDIF
.
WSLT9999  RETURN
+
.---------------------------------------------------
. Increment Schedule Count on Session
.---------------------------------------------------
ADDSCH00  MOVE      ZERO,LOCKCNT
          MOVE      "CV",KEY2
          PACK      KEY5,KEY2,OBAVISIT
          CALL      RDCODE1
          BRANCH    OVRCD,ADDSCH98
          IF        TCFORM6=0
            MOVE      ONE,TCFORM6
          ENDIF
.
ADDSCH10  PACK      KEY25,SESSKEYS,SP70
          CALL      RLOTSES1
          BRANCH    OVRCD,ADDSCH98,ADDSCH90
          ADD       TCFORM6,OSESLOTS
          MATCH     ANSN,TCINDC1
          IF        @EQUAL
            ADD       ONE,OSESSLTN
          ENDIF
          MATCH     ANSR,TCINDC1
          IF        @EQUAL
            ADD       ONE,OSESSLTR
          ENDIF
          MATCH     ANSS,TCINDC1
          IF        @EQUAL
            ADD       ONE,OSESSLTS
          ENDIF
          CALL      UPSESA1
          CALL      UUOTSES1
          MOVE      ZERO,EXIT
          GOTO      ADDSCH99
ADDSCH90  DISPLAY   *W
          ADD       ONE,LOCKCNT
          IF        LOCKCNT<5
            GOTO      ADDSCH10
          ENDIF
ADDSCH98  MOVE      ONE,EXIT
ADDSCH99  RETURN
+
