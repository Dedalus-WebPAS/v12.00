.******************************************************************************
.* System   : Patient Management                                              *
.* Program  : CHECKPRS                                                        *
.* Desc     : Check PRS2 extract coding                                       *
.******************************************************************************
.* Date     : 09/04/2003                                                      *
.* Author   : Jill Habasque SRF 37900                                         *
.* Function : This program checks the selected extract to the current coding  *
.*            records to find any changes                                     *
.* Mods     :                                                                 *
.*                                                                            *
.* V12.00.01 22/05/2025  Alina Bhari   TSK 0955096                            *
.*           Added alpanumeric visit number generation                        *
.*           -GETECM00                                                        *
.*           -PROC9000 changed the *AADMNO to *1                              *
.* V11.02.02  01.04.2022  DA Sarkies    TSK 0918429                           *
.*            Fixed malformed code by removing SP70
.* V10.02.01  28/03/2011  Mike Laming   CAR 240107                            *
.*            Mods to PATECDaf & PATECOaf variables & Keys - file Change      *
.* V10.01.01  10/03/2011 Jill Parkinson CAR 233088                            *
.*            Added pmsvx1af                                                  *
.******************************************************************************
          
          INC       STD001FD
          INC       PATCONFD/INC
          INC       PATASFFD/INC
          INC       PATDSCFD/INC
          INC       PATECDFD/INC
          INC       PATECMFD/INC
          INC       PATECOFD/INC
          INC       PATICOFD/INC
          INC       PATICDFD/INC
          INC       PATMA1FD/INC
          INC       PATMI1FD/INC
          INC       PMSVX1FD/INC
          INC       PATPGRFD/INC
.
.H2 Header file
.--------------
.Name     Type   Length   Start   Description
.----     ----   ------   -----   -----------
H2        INIT    "H2"      1     Transaction type - H2
.PTCNHCOD DIM       3       3     Hospital code
PRDSTDTE  DIM       8       6     Period start date (ddmmccyy)
PRDEDDTE  DIM       8      14     Period end date (ddmmccyy)
.
.X2 Diagnosis file
.-----------------
.Name     Type   Length   Start   Description
.----     ----   ------   -----   -----------
X2        INIT    "X2"      1     Transaction type - X2
UNIQKEY   DIM       6       3     Unique key
DIAG1     DIM       8       9     Diagnosis code 1
DIAG2     DIM       8      17     Diagnosis code 2
DIAG3     DIM       8      25     Diagnosis code 3
DIAG4     DIM       8      33     Diagnosis code 4
DIAG5     DIM       8      41     Diagnosis code 5
DIAG6     DIM       8      49     Diagnosis code 6
DIAG7     DIM       8      57     Diagnosis code 7
DIAG8     DIM       8      65     Diagnosis code 8
DIAG9     DIM       8      73     Diagnosis code 9
DIAG10    DIM       8      81     Diagnosis code 10
DIAG11    DIM       8      89     Diagnosis code 11
DIAG12    DIM       8      97     Diagnosis code 12
PROC1     DIM       8      105    Procedure code 1
PROC2     DIM       8      113    Procedure code 2
PROC3     DIM       8      121    Procedure code 3
PROC4     DIM       8      129    Procedure code 4
PROC5     DIM       8      137    Procedure code 5
PROC6     DIM       8      145    Procedure code 6
PROC7     DIM       8      153    Procedure code 7
PROC8     DIM       8      161    Procedure code 8
PROC9     DIM       8      169    Procedure code 9
PROC10    DIM       8      177    Procedure code 10
PROC11    DIM       8      185    Procedure code 11
PROC12    DIM       8      193    Procedure code 12
EPBAWGHT  DIM       4      201    Admission weight for babies
EPREADMT  DIM       1      205    Intention to readmit < 28 days
EPDUSRF   DIM       1      206    User flag
EPDSICUH  DIM       4      207    Duration of ICU stay
EPDCMVH   DIM       4      211    Duration of mechanical ventilation
EPDRG     DIM       4      215    DRG code
EPDSCCU   DIM       4      219    Duration of stay in CCU
EPRCCT    DIM       1      223    Reason for critical care transfer
EPDCPAPH  DIM       4      224    Duration of CPAP   *after 01/07/2002
.
.Y2 Xtra diagnosis file
.----------------------
.Name     Type   Length   Start   Description
.----     ----   ------   -----   -----------
Y2        INIT    "Y2"      1     Transaction type - Y2
.UNIQKEY  DIM       6       3     Unique key
DIAG13    DIM       8       9     Diagnosis code 13 
DIAG14    DIM       8      17     Diagnosis code 14
DIAG15    DIM       8      25     Diagnosis code 15
DIAG16    DIM       8      33     Diagnosis code 16
DIAG17    DIM       8      41     Diagnosis code 17
DIAG18    DIM       8      49     Diagnosis code 18
DIAG19    DIM       8      57     Diagnosis code 19
DIAG20    DIM       8      65     Diagnosis code 20
DIAG21    DIM       8      73     Diagnosis code 21
DIAG22    DIM       8      81     Diagnosis code 22
DIAG23    DIM       8      89     Diagnosis code 23
DIAG24    DIM       8      97     Diagnosis code 24
DIAG25    DIM       8      105    Diagnosis code 25
PROC13    DIM       8      113    Procedure code 13
PROC14    DIM       8      121    Procedure code 14
PROC15    DIM       8      129    Procedure code 15
PROC16    DIM       8      137    Procedure code 16
PROC17    DIM       8      145    Procedure code 17
PROC18    DIM       8      153    Procedure code 18
PROC19    DIM       8      161    Procedure code 19
PROC20    DIM       8      169    Procedure code 20
PROC21    DIM       8      177    Procedure code 21
PROC22    DIM       8      185    Procedure code 22
PROC23    DIM       8      193    Procedure code 23
PROC24    DIM       8      201    Procedure code 24
PROC25    DIM       8      209    Procedure code 25
.SP24     DIM      24      217    24 spaces
.
.End of Record             241
.
XDIAG1     DIM       8       9     Diagnosis code 1
XDIAG2     DIM       8      17     Diagnosis code 2
XDIAG3     DIM       8      25     Diagnosis code 3
XDIAG4     DIM       8      33     Diagnosis code 4
XDIAG5     DIM       8      41     Diagnosis code 5
XDIAG6     DIM       8      49     Diagnosis code 6
XDIAG7     DIM       8      57     Diagnosis code 7
XDIAG8     DIM       8      65     Diagnosis code 8
XDIAG9     DIM       8      73     Diagnosis code 9
XDIAG10    DIM       8      81     Diagnosis code 10
XDIAG11    DIM       8      89     Diagnosis code 11
XDIAG12    DIM       8      97     Diagnosis code 12
XPROC1     DIM       8      105    Procedure code 1
XPROC2     DIM       8      113    Procedure code 2
XPROC3     DIM       8      121    Procedure code 3
XPROC4     DIM       8      129    Procedure code 4
XPROC5     DIM       8      137    Procedure code 5
XPROC6     DIM       8      145    Procedure code 6
XPROC7     DIM       8      153    Procedure code 7
XPROC8     DIM       8      161    Procedure code 8
XPROC9     DIM       8      169    Procedure code 9
XPROC10    DIM       8      177    Procedure code 10
XPROC11    DIM       8      185    Procedure code 11
XPROC12    DIM       8      193    Procedure code 12
XEPBAWGH   DIM       4      201    Admission weight for babies
XEPREADM   DIM       1      205    Intention to readmit < 28 days
XEPDUSRF   DIM       1      206    User flag
XEPDSICU   DIM       4      207    Duration of ICU stay
XEPDCMVH   DIM       4      211    Duration of mechanical ventilation
XEPDRG     DIM       4      215    DRG code
XEPDSCCU   DIM       4      219    Duration of stay in CCU
XEPRCCT    DIM       1      223    Reason for critical care transfer
XEPDCPAP   DIM       4      224    Duration of CPAP   *after 01/07/2002
.
XDIAG13    DIM       8       9     Diagnosis code 13
XDIAG14    DIM       8      17     Diagnosis code 14
XDIAG15    DIM       8      25     Diagnosis code 15
XDIAG16    DIM       8      33     Diagnosis code 16
XDIAG17    DIM       8      41     Diagnosis code 17
XDIAG18    DIM       8      49     Diagnosis code 18
XDIAG19    DIM       8      57     Diagnosis code 19
XDIAG20    DIM       8      65     Diagnosis code 20
XDIAG21    DIM       8      73     Diagnosis code 21
XDIAG22    DIM       8      81     Diagnosis code 22
XDIAG23    DIM       8      89     Diagnosis code 23
XDIAG24    DIM       8      97     Diagnosis code 24
XDIAG25    DIM       8      105    Diagnosis code 25
XPROC13    DIM       8      113    Procedure code 13
XPROC14    DIM       8      121    Procedure code 14
XPROC15    DIM       8      129    Procedure code 15
XPROC16    DIM       8      137    Procedure code 16
XPROC17    DIM       8      145    Procedure code 17
XPROC18    DIM       8      153    Procedure code 18
XPROC19    DIM       8      161    Procedure code 19
XPROC20    DIM       8      169    Procedure code 20
XPROC21    DIM       8      177    Procedure code 21
XPROC22    DIM       8      185    Procedure code 22
XPROC23    DIM       8      193    Procedure code 23
XPROC24    DIM       8      201    Procedure code 24
XPROC25    DIM       8      209    Procedure code 25
.
B10NUMB   FORM      10
CODCNT    FORM      3
DIM3      DIM       3
EPISODNO  FORM      2
ERRORF    FORM      1
NEWBASE   FORM      "36"
NEWBNUMB  DIM       6
NEXTX2    FORM      1
PATNAME   DIM       31       * patient's name output
PRTHDR    FORM      1        * Print header flag
RECCNT    FORM      5
TESTDATE  DIM       8
.
TEMP1     FILE      ASCII, FIXED=256
.
FILENAME  DIM       8
BASEDGTS  INIT      "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"
PIPE      INIT      "|"
.
PRGID     INIT      "CHECKPRS"
PRGNAM    INIT      "Check PRS/2 Records"
VERSION   INIT      "V12.00.01"
.
ML0000    CALL      DISPHEAD
          MOVE      ZERO,RECCNT
          CALL      INIT0000
.
          CALL      KEYFIL00           * keying the extract file name
          BRANCH    EXIT,ML9999
.
          CALL      CONTQST                       * Ok to continue ?
          BRANCH    CEXIT,ML1000,ML0000,ML9999    * Yes, no, cancel
.
ML1000    CALL      HEAD0000
          CALL      PROC0000           * Process the file
.
          CALL      HITEXIT
.
ML9999    CHAIN     PGM
.
.******************************************************************************
.*                                  INIT0000              Called by: ML0000   *
.*                      Initialise Variables & Open Files                     *
.******************************************************************************
.
INIT0000  DISPLAY   *P64:24,"patecdaf";
          OPEN      PATECDA1,"patecdaf"
          OPEN      PATECDA2,"patecdaf"
.
          DISPLAY   *P64:24,"patecoaf";
          OPEN      PATECOA2,"patecoaf"
.
          DISPLAY   *P64:24,"patecmaf";
          OPEN      PATECMA1,"patecmaf"
.
          DISPLAY   *P64:24,"pati10df";
          OPEN      PATI10D1,"pati10df"
.
          DISPLAY   *P64:24,"pati10of";
          OPEN      PATI10O1,"pati10of"
.
          DISPLAY   *P64:24,"paticddf";
          OPEN      PATICDD1,"paticddf"
.
          DISPLAY   *P64:24,"paticdof";
          OPEN      PATICDO1,"paticdof"
.
          DISPLAY   *P64:24,"patma1af";
          OPEN      PATMA1A1,"patma1af"
.
          DISPLAY   *P64:24,"patmx1af";
          OPEN      PATMX1A1,"patmx1af"
.
          DISPLAY   *P64:24,"patmi1af";
          OPEN      PATMI1A1,"patmi1af"
          OPEN      PMSVX1A1,"pmsvx1af"
.
          DISPLAY   *P64:24,"patpgraf";
          OPEN      PATPGRA1,"patpgraf"
.
          DISPLAY   *P64:24,"patdschf";
          OPEN      PATDSCH1,"patdschf"
.
          DISPLAY   *P64:24,"patasfaf";
          OPEN      PATASFA1,"patasfaf"
.
          DISPLAY   *P56:24,"Opening controlf";
          OPEN      CONTROLF,"controlf"
.
          READ      CONTROLF,TEN;*36,CMDISD,*37,CMOPRT,*235,CMDISP,*236,CMDISS:
                                          *237,CMDISC,*238,CMDISA,*243,PTCNEFLG
.
          READ      CONTROLF,EIGHTY8;*59,PTCNI10D,*116,CHCSDTE
.
          MOVE      ZERO,NEXTX2
          RETURN
.********************************************************************
.*   Keyin file name to check
.********************************************************************
KEYFIL00  MOVE      ZERO,EXIT
.
          DISPLAY   *P1:4,*EF,"PRS/2 Filename : ";
          KEYIN     *P18:4,*EL,*V2LON,FILENAME;
.
          PACK      FILENAME,FILENAME,SP8
          MATCH     SP8,FILENAME
          IF        @EQUAL
            MOVE      ONE,EXIT
            GOTO      KEYFIL99
          ENDIF
.
          STRIP     FILENAME
          MOVE      "/XMT",KEY4
          PACK      KEY12,FILENAME,KEY4
          DISPLAY   *P18:4,*EL,*V2LON,*+,FILENAME,".XMT";
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      TEMP1,KEY12
          TRAPCLR   IO
          IF        OVRCD=1
            DISPLAY   *P1:24,*EL,*B,"Filename not found.  ";
            CALL      HITENTER
            MOVE      ONE,EXIT
            GOTO      KEYFIL99
          ENDIF
.
KEYFIL99  RETURN
+
.********************************************************************
.*   Process extract file    
.********************************************************************
PROC0000  CALL      CLRVAR00
          CALL      READX000           * read extract file
          BRANCH    OVRCD,PROC9999
.
          ADD       ONE,RECCNT
          IF        RECCNT%10=1
            DISPLAY   *P1:24,"Records processed ",*V2LON,RECCNT;
          ENDIF
.
          MOVE      ZERO,ERRORF
          PACK      NEWBNUMB,UNIQKEY,SP70
          PROC      FROMBASE
          UNPACK    B10NUMB,DIM2,KEY8
          MOVE      KEY8,AADMNO
          MOVE      DIM2,EPISODNO
          PACK      KEY8,AADMNO,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,PROC9000
.
          PACK      KEY8,AURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,PROC9100
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDDSCH1
.
          CALL      GDSC0000          * get diagnosis coding from tables
          CALL      GOPC0000          * get procedure coding from tables
          CALL      GDRG0000          * get drg
          CALL      COMPD000          * compare diagnosis to extract
          CALL      COMPP000          * compare procedures to extract
          CALL      COMPG000          * compare drg
.
          IF        ERRORF=1
            CALL      GETECM00
          ENDIF
.
          GOTO      PROC0000
.
PROC9000  PRINT     *1," Missing admission record."
          GOTO      PROC0000
.
PROC9100  PRINT     *1," Missing master records for ",AURNO
          GOTO      PROC0000
.
PROC9999  RETURN
+
.********************************************************************
.*   Get patecmaf date          
.********************************************************************
GETECM00  PACK      KEY18,AADMNO,Z70
          CALL      RSPTECM1                * Read an episode morbidity changes
          CALL      RPPTECM1                  file record
          BRANCH    OVRCD,GETECM90
.         
          MATCH     AADMNO,PTEMADMN
          GOTO      GETECM90 IF NOT EQUAL   * Different admin no
.
          MATCH     PTEMCDTE,TESTDATE
          IF        !@LESS
            PRINT     *12,"patecmaf date lower : ",PTEMCDTE,*N
          ELSE
            PRINT     *12,"patecmaf date : ",PTEMCDTE,*N
          ENDIF
          GOTO      GETECM99
.
GETECM90  PRINT     *12,"Missing patecmaf record ",*N
.
GETECM99  RETURN
+
.********************************************************************
.*   Read extract record        
.********************************************************************
READX000  MOVE      ZERO,OVRCD
          BRANCH    NEXTX2,READX100
.
          READ      TEMP1,SEQ;D2;
          GOTO      OVERCOND IF OVER
.
          MATCH     X2,D2
          IF        !@EQUAL
            READ      TEMP1,SEQ;UNIQKEY
            GOTO      READX000
          ENDIF
.
READX100  READ      TEMP1,SEQ;UNIQKEY,XDIAG1,XDIAG2,XDIAG3,XDIAG4,XDIAG5:
                            XDIAG6,XDIAG7,XDIAG8,XDIAG9,XDIAG10,XDIAG11,XDIAG12:
                            XPROC1,XPROC2,XPROC3,XPROC4,XPROC5,XPROC6,XPROC7:
                            XPROC8,XPROC9,XPROC10,XPROC11,XPROC12,XEPBAWGH:
                            XEPREADM,XEPDUSRF,XEPDSICU,XEPDCMVH,XEPDRG:
                            XEPDSCCU,XEPRCCT,XEPDCPAP
          GOTO      OVERCOND IF OVER
.
          READ      TEMP1,SEQ;D2;
          MATCH     X2,D2
          IF        @EQUAL
            MOVE      ONE,NEXTX2
            GOTO      READX999 
          ENDIF
.
          MOVE      ZERO,NEXTX2
          MATCH     Y2,D2
          GOTO      READX999 IF NOT EQUAL
.
          READ      TEMP1,SEQ;UNIQKEY,XDIAG13,XDIAG14,XDIAG15,XDIAG16,XDIAG17:
                              XDIAG18,XDIAG19,XDIAG20,XDIAG21,XDIAG22,XDIAG23:
                              XDIAG24,XDIAG25,XPROC13,XPROC14,XPROC15,XPROC16:
                              XPROC17,XPROC18,XPROC19,XPROC20,XPROC21,XPROC22:
                              XPROC23,XPROC24,XPROC25
          GOTO      READX999
.
READX999  RETURN
+
.******************************************************************************
.*                                  GDSC0000              Called by: PROC0000 *
.*                              Get Disease Codes                             *
.******************************************************************************
GDSC0000  MOVE      ONE,CODCNT
          REPEAT
            STORE     SP8,CODCNT,DIAG1,DIAG2,DIAG3,DIAG4,DIAG5:
                                 DIAG6,DIAG7,DIAG8,DIAG9,DIAG10:
                                 DIAG11,DIAG12,DIAG13,DIAG14,DIAG15:
                                 DIAG16,DIAG17,DIAG18,DIAG19,DIAG20:
                                 DIAG21,DIAG22,DIAG23,DIAG24,DIAG25
            ADD       ONE,CODCNT
          UNTIL     CODCNT>25
.
          MOVE      ONE,CODCNT              * Clear the code counter
          PACK      KEY16,AADMNO,SP20
          CALL      RSPTECD2                * Position on & read a patient
GDSC1000  CALL      RKPTECD2                  episode disease file record
          BRANCH    OVRCD,GDSC9999
.
          MATCH     AADMNO,PTEDADMN
          GOTO      GDSC9999 IF NOT EQUAL   * Different admin no
.
          COMPARE   EPISODNO,PTEDEPNO
          GOTO      GDSC1000 IF NOT EQUAL   * Different episode no
.
          MATCH     ANSX,PTEDTYPE
          GOTO      GDSC1000 IF EQUAL       * Ignore operation code
.
          MATCH     CMDISD,PTEDTYPE
          GOTO      GDSC1000 IF EQUAL       * Ignore disability disease types
.
          MATCH     CMDISS,PTEDTYPE
          GOTO      GDSC1000 IF EQUAL       * Ignore sequela disease types
.
          COMPARE   ONE,CODCNT
          GOTO      GDSC3000 IF NOT EQUAL   * Not the 1st disease code
.
          MATCH     "000000000",PTEDCODE
          GOTO      GDSC2000 IF NOT EQUAL   * Not a PRS2 deletion code
.
          MOVE      "00000000",DIAG1        * PRS2 deletion code
          GOTO      GDSC9000
.
GDSC2000  MATCH     CMDISP,PTEDTYPE
          GOTO      GDSC4000 IF NOT EQUAL   * Not a primary disease code
.
GDSC3000  MATCH     PTCNI10D,PTEDDTCD
          IF        @LESS
            PACK      KEY9,PTEDCODE,SP10
            CALL      RD10T9D1              * Read an ICD9 disease file record
            BRANCH    OVRCD,GDSC5000
.
            MOVE      DICD10CD,PTEDCODE     * Mapped ICD10 disease code
          ENDIF
.
          PACK      KEY9,PTEDCODE,SP10
          CALL      RDPT10D1                * Read an ICD10 disease file record
          BRANCH    OVRCD,GDSC5000
.
          MOVE      PTEDTYPE,KEY1
          IF        CODCNT<>1
            MATCH     "4",PT0DACRQ
            IF        @EQUAL
              MOVE      ANSM,KEY1           * Morphology codes need M prefix
            ENDIF
          ENDIF
.
          MOVE      PTEDCODE,KEY9
          REP       ". ",KEY9
          REP       "/ ",KEY9
          SQUEEZE   KEY9
.
          PACK      KEY8,KEY1,KEY9,SP10
          STORE     KEY8,CODCNT,DIAG1,DIAG2,DIAG3,DIAG4,DIAG5:
                                DIAG6,DIAG7,DIAG8,DIAG9,DIAG10:
                                DIAG11,DIAG12,DIAG13,DIAG14,DIAG15:
                                DIAG16,DIAG17,DIAG18,DIAG19,DIAG20:
                                DIAG21,DIAG22,DIAG23,DIAG24,DIAG25
          ADD       ONE,CODCNT
          COMPARE   "26",CODCNT
          GOTO      GDSC9999 IF NOT LESS    * Code counter >= 26, exit
          GOTO      GDSC1000
.
GDSC4000  
...       CALL      ADDT0000
...       COMPARE   "60",CLNO
...       CALL      HEAD0000 IF NOT LESS    * Line count >= 60
.
...       PRINT     "355 : Admission ",AADMNO," diagnosis code was not a ":
...                 "primary type",*90,"No X2 record generated",*N
...       ADD       TWO,CLNO
          GOTO      GDSC9000
.
GDSC5000  COMPARE   ONE,CODCNT
          GOTO      GDSC1000 IF NOT EQUAL   * Not the 1st code, exit
.
...       CALL      ADDT0000
...       COMPARE   "60",CLNO
...       CALL      HEAD0000 IF NOT LESS    * Line count >= 60
.
...       PRINT     "355 : Missing or blank primary diagnosis code for ":
...                 AADMNO,*N
...       ADD       TWO,CLNO
.
GDSC9000  MOVE      ZERO,EXIT
.
GDSC9999  RETURN
+
.******************************************************************************
.*                                  GOPC0000              Called by: GDGR0000 *
.*                             Get Operation Codes                            *
.******************************************************************************
GOPC0000  PACK      KEY25,AADMNO,SP30
          CALL      RSPTASF1                * Position on & read the admission
          CALL      RKPTASF1                  SFA file
          IF        OVRCD=1
            UNPACK    SP20,PTAFCODE,PTAFCTYP,PTAFCROL,PTAFCSID
          ENDIF
.
          MOVE      ONE,CODCNT
          REPEAT
            STORE     SP8,CODCNT,PROC1,PROC2,PROC3,PROC4,PROC5:
                                 PROC6,PROC7,PROC8,PROC9,PROC10:
                                 PROC11,PROC12,PROC13,PROC14,PROC15:
                                 PROC16,PROC17,PROC18,PROC19,PROC20:
                                 PROC21,PROC22,PROC23,PROC24,PROC25
            ADD       ONE,CODCNT
          UNTIL     CODCNT>25
.
          MOVE      ONE,CODCNT              * Clear the code counter
          PACK      KEY16,AADMNO,SP20
          CALL      RSPTECO2                * Position on & read a patient
GOPC1000  CALL      RKPTECO2                  episode operation file record
          BRANCH    OVRCD,GOPC9000
.
          MATCH     AADMNO,PTEOADMN
          GOTO      GOPC9000 IF NOT EQUAL   * Different admin no
.
          COMPARE   EPISODNO,PTEOEPNO
          GOTO      GOPC1000 IF NOT EQUAL   * Different episode no
.
          MATCH     ANSX,PTEOTYPE
          GOTO      GOPC1000 IF EQUAL       * Ignore operation code
.
          MATCH     PTCNEDRG,PTEOCODE
          GOTO      GOPC2000 IF EQUAL       * PRS2 dummy code
.
          MATCH     PTCNI10D,PTEODTCD
          IF        @LESS
            PACK      KEY9,PTEOCODE,SP10
            CALL      RD10T9O1              * Read an ICD9 operation file record
            BRANCH    OVRCD,GOPC5000
.
            MOVE      OICD10CD,PTEOCODE     * Mapped ICD10 operation code
          ENDIF
.
          PACK      KEY9,PTEOCODE,SP10
          CALL      RDPT10O1                * Read an ICD10 operation file rec
          BRANCH    OVRCD,GOPC5000
.
GOPC2000  MOVE      PTEOCODE,KEY9
          REP       "- ",KEY9
          SQUEEZE   KEY9
          PACK      KEY9,KEY9,SP9
.
          MATCH     CMOPRT,PTEOTYPE
          GOTO      GOPC4000 IF EQUAL       * Operation code in this hospital
.
          MATCH     SP1,PTAFCODE
          GOTO      GOPC4000 IF EQUAL       * No special funding arrange code
.
          MATCH     ANSA,PTAFCROL
          GOTO      GOPC3000 IF EQUAL       * Contract role A for conting hosp
.
.         COMPARE   ONE,ADMDTFLG
.         CALL      ADDT0000 IF NOT EQUAL   * Print admin details
.         COMPARE   "60",CLNO
.         CALL      HEAD0000 IF NOT LESS    * Line count >= 60
.
.         PRINT     "408 : Contracting Hospital must have Contract role A. ":
.                   AADMNO,*N
.         ADD       TWO,CLNO
.         ADD       ONE,NUMERROR
.         MOVE      ONE,PTERRFLG
.
GOPC3000  MOVE      PTEOTYPE,KEY1
          REP       "IF",KEY1               * PRS2 requires I to be F
.
          RESET     KEY9,7
          APPEND    KEY1,KEY9               * Contract flag in 8th position
          RESET     KEY9
.
GOPC4000  PACK      KEY8,KEY9,SP10
          STORE     KEY8,CODCNT,PROC1,PROC2,PROC3,PROC4,PROC5:
                                PROC6,PROC7,PROC8,PROC9,PROC10:
                                PROC11,PROC12,PROC13,PROC14,PROC15:
                                PROC16,PROC17,PROC18,PROC19,PROC20:
                                PROC21,PROC22,PROC23,PROC24,PROC25
          ADD       ONE,CODCNT
          COMPARE   "26",CODCNT
          GOTO      GOPC9000 IF NOT LESS    * Code counter >= 26, exit
          GOTO      GOPC1000
.
GOPC5000  COMPARE   ONE,CODCNT
          GOTO      GDSC1000 IF NOT EQUAL   * Not the 1st code, exit
.
.         COMPARE   ONE,ADMDTFLG
.         CALL      ADDT0000 IF NOT EQUAL   * Print admin details
.         COMPARE   "60",CLNO
.         CALL      HEAD0000 IF NOT LESS    * Line count >= 60
.
.         PRINT     "### : Missing or blank primary procedure code for ":
.                   AADMNO,*N
.         ADD       TWO,CLNO
.         ADD       ONE,NUMERROR
.         MOVE      ONE,PTERRFLG
.
GOPC9000  MOVE      ZERO,EXIT
GOPC9999  RETURN
+
.******************************************************************************
.*                                  GDRG0000              Called by: GDGR0000 *
.*                              Get The DRG Code                              *
.******************************************************************************
GDRG0000  MOVE      SP4,EPDRG               * Default to no DRG
          MATCH     SP8,DDATE
          GOTO      GDRG9000 IF EQUAL       * Patient not discharged
.
          MOVE      PTDSDDRG,EPDRG          * Default to discharge DRG code
          MATCH     "20010701",DDATE
          GOTO      GDRG1000 IF LESS        * Disch date < 01/07/2001
.
          PACK      KEY13,AADMNO,SP1,ONE,ZERO,FOUR,TWO
          CALL      RDPTPGR1                * Read a patient grouper file record
          BRANCH    OVRCD,GDRG1000
.
          MATCH     SP4,PTPGNDRG
          GOTO      GDRG1000 IF EQUAL       * Invalid 4.2 DRG
.
          MOVE      PTPGNDRG,EPDRG
          GOTO      GDRG9000
.
GDRG1000  PACK      KEY13,AADMNO,SP1,ONE,ZERO,FOUR,ONE
          CALL      RDPTPGR1                * Read a patient grouper file record
          BRANCH    OVRCD,GDRG9000
.
          MATCH     SP4,PTPGNDRG
          GOTO      GDRG9000 IF EQUAL       * Invalid 4.1 DRG
.
          MOVE      PTPGNDRG,EPDRG
.
GDRG9000  MOVE      ZERO,EXIT
GDRG9999  RETURN
+
.******************************************************************************
.*                                  COMPD000                                  *
.*                  Compare current coding to extract coding                  *
.******************************************************************************
COMPD000  MATCH     DIAG1,XDIAG1
          GOTO      COMPD900 IF NOT EQUAL
.
          MATCH     DIAG2,XDIAG2
          GOTO      COMPD900 IF NOT EQUAL
.
          MATCH     DIAG3,XDIAG3
          GOTO      COMPD900 IF NOT EQUAL
.
          MATCH     DIAG4,XDIAG4
          GOTO      COMPD900 IF NOT EQUAL
.
          MATCH     DIAG5,XDIAG5
          GOTO      COMPD900 IF NOT EQUAL
.
          MATCH     DIAG6,XDIAG6
          GOTO      COMPD900 IF NOT EQUAL
.
          MATCH     DIAG7,XDIAG7
          GOTO      COMPD900 IF NOT EQUAL
.
          MATCH     DIAG8,XDIAG8
          GOTO      COMPD900 IF NOT EQUAL
.
          MATCH     DIAG9,XDIAG9
          GOTO      COMPD900 IF NOT EQUAL
.
          MATCH     DIAG10,XDIAG10
          GOTO      COMPD900 IF NOT EQUAL
.
          MATCH     DIAG11,XDIAG11
          GOTO      COMPD900 IF NOT EQUAL
.
          MATCH     DIAG12,XDIAG12
          GOTO      COMPD900 IF NOT EQUAL
.
          MATCH     DIAG13,XDIAG13
          GOTO      COMPD900 IF NOT EQUAL
.
          MATCH     DIAG14,XDIAG14
          GOTO      COMPD900 IF NOT EQUAL
.
          MATCH     DIAG15,XDIAG15
          GOTO      COMPD900 IF NOT EQUAL
.
          MATCH     DIAG16,XDIAG16
          GOTO      COMPD900 IF NOT EQUAL
.
          MATCH     DIAG17,XDIAG17
          GOTO      COMPD900 IF NOT EQUAL
.
          MATCH     DIAG18,XDIAG18
          GOTO      COMPD900 IF NOT EQUAL
.
          MATCH     DIAG19,XDIAG19
          GOTO      COMPD900 IF NOT EQUAL
.
          MATCH     DIAG20,XDIAG20
          GOTO      COMPD900 IF NOT EQUAL
.
          MATCH     DIAG21,XDIAG21
          GOTO      COMPD900 IF NOT EQUAL
.
          MATCH     DIAG22,XDIAG22
          GOTO      COMPD900 IF NOT EQUAL
.
          MATCH     DIAG23,XDIAG23
          GOTO      COMPD900 IF NOT EQUAL
.
          MATCH     DIAG24,XDIAG24
          GOTO      COMPD900 IF NOT EQUAL
.
          MATCH     DIAG25,XDIAG25
          GOTO      COMPD900 IF NOT EQUAL
.
          GOTO      COMPD999
.
COMPD900  PRINT     AADMNO,*12,"Diagnosis Coding has changed ":
                    " Unique Key : ",UNIQKEY," UR Number : ",AURNO,*N:
                    *12,"Extract codes : ",XDIAG1,XDIAG2,XDIAG3,XDIAG4,XDIAG5:
                    XDIAG6,XDIAG7,XDIAG8,XDIAG9,XDIAG10,XDIAG11,XDIAG12:
                    XDIAG13,XDIAG14,XDIAG15,XDIAG16,XDIAG17,XDIAG18,XDIAG19:
                    XDIAG20,XDIAG21,XDIAG22,XDIAG23,XDIAG24,XDIAG25,*N:
                    *12,"Current codes : ",DIAG1,DIAG2,DIAG3,DIAG4,DIAG5:
                    DIAG6,DIAG7,DIAG8,DIAG9,DIAG10,DIAG11,DIAG12:
                    DIAG13,DIAG14,DIAG15,DIAG16,DIAG17,DIAG18,DIAG19:
                    DIAG20,DIAG21,DIAG22,DIAG23,DIAG24,DIAG25
.
          MOVE      ONE,ERRORF
.
COMPD999  RETURN
+
.******************************************************************************
.*                                  COMPP000                                  *
.*              Compare current procedures to extract coding                  *
.******************************************************************************
COMPP000  MATCH     PROC1,XPROC1
          GOTO      COMPP900 IF NOT EQUAL
.
          MATCH     PROC2,XPROC2
          GOTO      COMPP900 IF NOT EQUAL
.
          MATCH     PROC3,XPROC3
          GOTO      COMPP900 IF NOT EQUAL
.
          MATCH     PROC4,XPROC4
          GOTO      COMPP900 IF NOT EQUAL
.
          MATCH     PROC5,XPROC5
          GOTO      COMPP900 IF NOT EQUAL
.
          MATCH     PROC6,XPROC6
          GOTO      COMPP900 IF NOT EQUAL
.
          MATCH     PROC7,XPROC7
          GOTO      COMPP900 IF NOT EQUAL
.
          MATCH     PROC8,XPROC8
          GOTO      COMPP900 IF NOT EQUAL
.
          MATCH     PROC9,XPROC9
          GOTO      COMPP900 IF NOT EQUAL
.
          MATCH     PROC10,XPROC10
          GOTO      COMPP900 IF NOT EQUAL
.
          MATCH     PROC11,XPROC11
          GOTO      COMPP900 IF NOT EQUAL
.
          MATCH     PROC12,XPROC12
          GOTO      COMPP900 IF NOT EQUAL
.
          MATCH     PROC13,XPROC13
          GOTO      COMPP900 IF NOT EQUAL
.
          MATCH     PROC14,XPROC14
          GOTO      COMPP900 IF NOT EQUAL
.
          MATCH     PROC15,XPROC15
          GOTO      COMPP900 IF NOT EQUAL
.
          MATCH     PROC16,XPROC16
          GOTO      COMPP900 IF NOT EQUAL
.
          MATCH     PROC17,XPROC17
          GOTO      COMPP900 IF NOT EQUAL
.
          MATCH     PROC18,XPROC18
          GOTO      COMPP900 IF NOT EQUAL
.
          MATCH     PROC19,XPROC19
          GOTO      COMPP900 IF NOT EQUAL
.
          MATCH     PROC20,XPROC20
          GOTO      COMPP900 IF NOT EQUAL
.
          MATCH     PROC21,XPROC21
          GOTO      COMPP900 IF NOT EQUAL
.
          MATCH     PROC22,XPROC22
          GOTO      COMPP900 IF NOT EQUAL
.
          MATCH     PROC23,XPROC23
          GOTO      COMPP900 IF NOT EQUAL
.
          MATCH     PROC24,XPROC24
          GOTO      COMPP900 IF NOT EQUAL
.
          MATCH     PROC25,XPROC25
          GOTO      COMPP900 IF NOT EQUAL
.
          GOTO      COMPP999
.
COMPP900  PRINT     AADMNO,*12,"Procedure Coding has changed":
                    " Unique Key : ",UNIQKEY," UR Number : ",AURNO,*N:
                    *12,"Extract codes : ",XPROC1,XPROC2,XPROC3,XPROC4,XPROC5:
                    XPROC6,XPROC7,XPROC8,XPROC9,XPROC10,XPROC11,XPROC12:
                    XPROC13,XPROC14,XPROC15,XPROC16,XPROC17,XPROC18,XPROC19:
                    XPROC20,XPROC21,XPROC22,XPROC23,XPROC24,XPROC25,*N:
                    *12,"Current codes : ",PROC1,PROC2,PROC3,PROC4,PROC5:
                    PROC6,PROC7,PROC8,PROC9,PROC10,PROC11,PROC12:
                    PROC13,PROC14,PROC15,PROC16,PROC17,PROC18,PROC19:
                    PROC20,PROC21,PROC22,PROC23,PROC24,PROC25
.
          MOVE      ONE,ERRORF
.
COMPP999  RETURN
+
.******************************************************************************
.*                                  COMPG000                                  *
.*              Compare current drg to extract drg                            *
.******************************************************************************
COMPG000  MATCH     EPDRG,XEPDRG
          GOTO      COMPG900 IF NOT EQUAL
.
          GOTO      COMPG999
COMPG900  PRINT     AADMNO,*12,"DRG has changed":
                    " Unique Key : ",UNIQKEY," UR Number : ",AURNO,*N:
                    *12,"Extract DRG : ",XEPDRG,*N:
                    *12,"Current DRG : ",EPDRG
          MOVE      ONE,ERRORF
.
COMPG999  RETURN
.
.******************************************************************************
.*                                  HEAD0000              Called by: Lots     *
.*                             Print Report Header                            *
.******************************************************************************
HEAD0000  CALL      HEAD132 
          MOVE      SP70,TESTDATE
          PRINT     *N,*40,"Extract File: ",FILENAME
          ADD       "2",CLNO
.         
          MOVE      ONE,PRTHDR              * Print header flag - yes
.
          READ      TEMP1,SEQ;D2;
          GOTO      OVERCOND IF OVER
.
          MATCH     H2,D2
          IF        @EQUAL
            READ      TEMP1,SEQ;DIM3,PRDSTDTE,PRDEDDTE
            PRINT     "Start Date : ",PRDSTDTE,SP10,"End Date : ",PRDEDDTE
            UNPACK    PRDSTDTE,CDAY,CMON,CCENT,CYEAR
            PACK      TESTDATE,CCENT,CYEAR,CMON,CDAY
          ENDIF
.
HEAD9000  MOVE      ZERO,EXIT
HEAD9999  RETURN
+
.******************************************************************************
.*                                  ADDT0000              Called by: Lots     *
.*                           Print Admission Details                          *
.******************************************************************************
ADDT0000  BRANCH    PRTHDR,ADDT1000         * Header printed
.
          COMPARE   "55",CLNO
          CALL      HEAD0000 IF NOT LESS    * Line count >= 55
.
ADDT1000  MOVE      ZERO,PRTHDR             * Print header flag - no
          MOVE      PSNAME,PACSNAME
          MOVE      PGNAME,PACGNAME
          MOVE      PTITL,PACTITLE
          MOVE      TWO,PACFRMT
          CALL      PACNAME                 * Format the patients name
          MOVE      PACFNAME,PATNAME
.
          PRINT     *N:
                    "Admission No. : ",AADMNO,*26,"U/R Number : ",AURNO:
                    *48,"Name : ",PATNAME,"  Sex : ",PSEX,"  Born : ",PBDATE:
                    "  Age : ",PSAGE,*N:
                    *77,"Admission Date : ",ADATE:
                    "  Discharge Date : ",DDATE,*N
          ADD       "4",CLNO
.
ADDT9000  MOVE      ZERO,EXIT
ADDT9999  RETURN
+
.******************************************************************************
.*                                  CLRVAR00                                  *
.*                           Clear Variables                                  *
.******************************************************************************
CLRVAR00  UNPACK    SP70,DIAG1,DIAG2,DIAG3,DIAG4,DIAG5,DIAG6,DIAG7   
          UNPACK    SP70,DIAG8,DIAG9,DIAG10,DIAG11,DIAG12,PROC1,PROC2   
          UNPACK    SP70,PROC3,PROC4,PROC5,PROC6,PROC7,PROC8,PROC9   
          UNPACK    SP70,PROC10,PROC11,PROC12,EPBAWGHT,EPREADMT,EPDUSRF 
          UNPACK    SP70,EPDSICUH,EPDCMVH,EPDRG,EPDSCCU,EPRCCT,EPDCPAPH
.
          UNPACK    SP70,UNIQKEY,DIAG13,DIAG14,DIAG15,DIAG16,DIAG17  
          UNPACK    SP70,DIAG18,DIAG19,DIAG20,DIAG21,DIAG22,DIAG23  
          UNPACK    SP70,DIAG24,DIAG25,PROC13,PROC14,PROC15,PROC16  
          UNPACK    SP70,PROC17,PROC18,PROC19,PROC20,PROC21,PROC22  
          UNPACK    SP70,PROC23,PROC24,PROC25  
          UNPACK    SP70,XDIAG1,XDIAG2,XDIAG3,XDIAG4,XDIAG5,XDIAG6  
          UNPACK    SP70,XDIAG7,XDIAG8,XDIAG9,XDIAG10,XDIAG11,XDIAG12 
          UNPACK    SP70,XPROC1,XPROC2,XPROC3,XPROC4,XPROC5,XPROC6  
          UNPACK    SP70,XPROC7,XPROC8,XPROC9,XPROC10,XPROC11,XPROC12 
          UNPACK    SP70,XEPBAWGH,XEPREADM,XEPDUSRF,XEPDSICU,XEPDCMVH
          UNPACK    SP70,XEPDRG,XEPDSCCU,XEPRCCT,XEPDCPAP
.
          UNPACK    SP70,XDIAG13,XDIAG14,XDIAG15,XDIAG16,XDIAG17,XDIAG18 
          UNPACK    SP70,XDIAG19,XDIAG20,XDIAG21,XDIAG22,XDIAG23,XDIAG24 
          UNPACK    SP70,XDIAG25,XPROC13,XPROC14,XPROC15,XPROC16,XPROC17 
          UNPACK    SP70,XPROC18,XPROC19,XPROC20,XPROC21,XPROC22,XPROC23 
          UNPACK    SP70,XPROC24,XPROC25 
.
          RETURN
+
          INC       STD001IO
          INC       PATASFIO/INC
          INC       PATDSCIO/INC
          INC       PATECDIO/INC
          INC       PATECMIO/INC
          INC       PATECOIO/INC
          INC       PATICDIO/INC
          INC       PATICOIO/INC
          INC       PATMA1IO/INC
          INC       PATMI1IO/INC
          INC       PMSVX1IO/INC
          INC       PATPGRIO/INC
          INC       BASECONV
+
.

