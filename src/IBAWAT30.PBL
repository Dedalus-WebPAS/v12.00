.******************************************************************************
.* System   :  WAITING LISTS                                                  *
.* Program  :  IBAWAT30                                                       *
.* Desc     :  Adhoc Letter Printing                                          *
.******************************************************************************
.* Author   :  DIG                                                            *
.* Date     :  23/04/1989                                                     *
.* Mods.    :                                                                 *
.*----------------------------------------------------------------------------*
.* V12.00.03 01/09/2025  Thanh T           TSK 0949457                        *
.*           Added LXPUSRAC-LXPUSRIL fields                                   *
.*           Moved all LX fields to WATLETDF.PBL                              *
.*----------------------------------------------------------------------------*
.* V12.00.02 11/06/2025  Ebon Clements    TSK 0961623                         *
.*           Alphanueric visit number changes                                 *
.* V12.00.01 30/05/2025  Don Nguyen       TSK 0955096                         *
.*           Alphanumeric visit number changes                                *
.* V11.04.01 17/07/2024  Thanh T          TSK 0939648                         *
.*           Added LXPXSN18 to LXPXSN30                                       *
.* V11.03.01 15/08/2023  Don Nguyen       TSK 0935736                         *
.*           Recompiled for SMSPRXML - Skip inactive extra contacts for SMS   *
.* V11.02.02 19/04/2022  Thanh T          TSK 0903453                         *
.*           Added LXPXUCC4, LXUCC4LD, LXPXATF1, LXPXUCC5, LXUCC5LD and       *
.*           LXPXATF2 fields                                                  
.* V11.02.01 09/02/2022  Thanh T       TSK 0905641                            *
.*           Recompiled as OUTHEDFD/OUTMA1FD/WATTR1FD changes                 *
.* V11.01.01 02/07/2021  Ebon Clements    TSK 0900650                         *
.*           Recompiled for SMSPRXML                                          *
.* V11.00.05 16/07/2020  Tracey Nguyen    TSK 0893621                         *
.*           Added %smsusrnm (LCCSMSUN/LXXSMSUN)                              *
.* V11.00.04 15/04/2020  Thanh T          TSK 0879163                         *
.*           Changed SET0182 for Sex category changes                         *
.* V11.00.03 08/04/2020  Thanh T          TSK 0879163                         *
.*           Changed SET0182 for Sex category changes                         *
.* V11.00.02 20/03/2020  Peter Vela       TSK 0889143                         *
.*           Fixed WATLET IO calls                                            *
.* V11.00.01 19/03/2020  Peter Vela       TSK 0889143                         *
.*           Recompiled for WATLETFD                                          *
.*----------------------------------------------------------------------------*
.* V10.15.01 07/02/2020  Ebon Clements    TSK 0887235                         *
.*----------------------------------------------------------------------------*
.*           Recompiled for PMSCEXCD - extra contact postal address           *
.* V10.13.02 23/01/2019  Nicole Torrisi   TSK 0868849                         *
.*           Added LXPACLOC and LXPASLOC                                      *
.* V10.13.01 05/12/2018  Don Nguyen       TSK 0838558                         *
.*           Deleted temp files (TEMP1 & TEMPF2) on program exit              *
.* V10.12.01 07/05/2018  Richa Phogat     TSK 0852348                         *
.*           Added LXRELDES - Removal Reason Long Description(Cat WR)         *
.* V10.11.01 30/10/2017  Peter Vela       TSK 0843931                         *
.*           Added to Waiting List Letter variables:                          *
.*           WL Suspension From Date                                          *
.*           WL Suspension To Date                                            *
.*           WL Suspension Reason Code Cat WN                                 *
.*           WL Suspension Reason Description Cat WN                          *
.*           WL Consultant Address 1                                          *
.*           WL Consultant Address 2                                          *
.*           WL Consultant Address 3                                          *
.*           WL Consultant Address 4                                          *
.*           WL Consultant Post Code                                          *
.*           WL Consultant State                                              *
.* V10.10.01 24/05/2017  Thanh T.          TSK 0825240                        *
.*           Added Days Not Ready for surgery for Patient and Clinical        *
.*           fields                                                           *
.*----------------------------------------------------------------------------*
.* V10.08.05 17/11/2016  Peter Vela        TSK 0828936                        *
.*           Added %wxidus %wtstay                                            *
.* V10.08.04 15/09/2016  Don Nguyen        TSK 0294154                        *
.*           Recompiled for WATLETCD - Modified PRIN0000                      *
.*           14/09/2016  Ebon Clements     TSK 0294154                        *
.*           Added CONTTYPS                                                   *
.* V10.08.03 16/08/2016  Peter Vela        TSK 319220                         *
.*           Increased PRTSTRNG to 80                                         *
.*           Increased DISPSTRN to 80                                         *
.*           04/08/2016  Don Nguyen        TSK 0294154                        *
.*           Recompiled for WATLETCD - Added PRIN9050 to skip line count check*
.* V10.08.02 25/07/2016  Don Nguyen        TSK 0294154                        *
.*           Added SMSPRXML - print XML metatags for SMS (PRIN0000).          *
.*           Recompiled for changes to WATLETCD.                              *
.* V10.08.01 07/06/2016  Jill Parkinson    TSK 0820003                        *
.*           Recompiled for PMSCEXCD - allow patmx1af/patma1af details        *
.* V10.07.01 09/03/2016  Ebon Clements     TSK 0294154                        *
.*           Added %smsid, %smscode, %smskey, %smsurno, %smsuser,             *
.*           %smsphone                                                        *
.* V10.06.02 21/09/2015  Davin             CAR 313906                         *
.*           Recompiled for PMSCEXCD - allow patmx1af/patma1af details        *
.* V10.06.01 02/06/2015  Peter Vela        CAR 308967                         *
.*           Changed LXWRDESC to length 80                                    *
.* V10.05.01 05/01/2015  Ebon Clements     CAR 261630                         *
.*           Removed port number from temp file name                          *
.* V10.05.01 06/10/2014  Ebon Clements     CAR 268970                         * 
.*           Change to use OUTCLIFD index 1 instead of index 2                *
.* V10.04.02 18/03/2014  Don Nguyen        CAR 291879                         *
.*           Added LXIHINUM. Recompiled for changes to WATLETCD               *
.* V10.04.01 31/12/2013  Don Nguyen        CAR 294389                         *
.*           Recompiled for changes to WATLETFD & WATLETIO                    *
.* V10.03.04 18/04/2013  Ania P            CAR 281663                         *
.*           Recompile for WATLETCD                                           *
.* V10.03.03 30/01/2012  Peter Vela        CAR 257930                         *
.*           Added LXWTCHRC - Reason Code Urgency Update                      *
.*           Added LXWTCHRD - Reason Desc Urgency Update                      *
.*           Added LXWTCHOV - Original Value Urgency Update                   *
.* V10.03.02 30/01/2012  Davin             CAR 257512                         *
.*           Recompiled for changes to WATLETCD                               *
.* V10.03.01 09/11/2011  Ebon Clements     CAR 248529                         *
.*           Added multiple contacts of the same type functionality           *
.* V10.02.06 25/10/2011  Ebon Clements     CAR 253354                         *
.*           Recompiled for changes to WATLETCD                               *
.* V10.02.05 21/09/2011  Davin             CAR 248749                         *
.*           Recompiled for changes to WATLETCD                               *
.* V10.02.04 15/09/2011  Ebon Clements     CAR 250738                         *
.*           Recompiled for changes to WATLETCD                               *
.* V10.02.03 08/08/2011  Peter McMullen    CAR 248749                         *
.*           Recompiled for changes to WATLETCD                               *
.* V10.02.02 22/06/2011  Steve Armstrong   CAR 240722                         *
.*           Recompiled for changes to PMSCEXCD                               *
.* V10.02.01 14/06/2011  Ebon Clements     CAR 239530                         *
.*           Added print extra contact functionality                          *
.******************************************************************************
.* V10.00.01 28/06/2010  Peter McMullen    CAR 224562                         *
.*           Add support for tag %reresi                                      *
.******************************************************************************
.* V9.09.04  18/10/2007  Steve Armstrong   CAR 149755                         *
.*           Recompiled for changes to WEBLETCD.                              *
.*           Created new RGGP... & RGPR... variables instead of using LX...   *
.*           variables and extended the length of some of the RGGP... &       *
.*           RGPR... variables to 55.                                         *
.* V9.09.03  08/08/2007  Peter Vela      CAR 143567                           *
.*           Added Waiting List Consultant email address (pmshcpaf,patdo1af)  *
.* V9.09.02  03/07/2007  Peter Vela      CAR 143555                           *
.*           Added Reg GP Prac Email Address                                  *
.* V9.09.01  01/08/2007  Peter Vela      CAR 143555                           *
.*           Added Reg GP Phone Number                                        *
.*           Added Reg GP Prac Fax Number                                     *
.******************************************************************************
.* V9.07.01  30/08/2006  Peter Vela      CAR 117576                           *
.*           Added patient date of birth                                      *
.*           Added local gp preferred method of contact                       *
.******************************************************************************
.* V9.06.01  08/06/2006  Ramesh VK       CAR 86021                            *
.*           Added patient sex %psex                                          *
.******************************************************************************
.* V9.05.01  31/03/2006 Peter Vela    CAR 86019                               *
.*           Added procedure description (WMDESC.wattr1af)                    *
.******************************************************************************
.* V9.04.11  15/11/2005 Peter Vela    CAR 83840                               *
.*           Added Admit Ward, Admit Date, Admit Time                         *
.*           (patmi1af)                                                       *
.* V9.04.10  05/10/2005 Mike Laming   CAR 52354                               *
.*           Add WTWMCSST & WTWMCSDT - Recompiled for WATLETCD and WATLETDF   *
.* V9.04.09  19/08/2005 Peter Vela    CAR 69456                               *
.*           Recompiled for WATLETCD and WATLETDF                             *
.* V9.04.08  09/08/2005 Peter Vela    CAR 67204                               *
.*           Recompiled for WATLETCD and WATLETDF                             *
.* V9.04.07  27/07/2005 Peter Vela    CAR 68536                               *
.*           Recompiled for WATLETCD and WATLETDF                             *
.* V9.04.06  19/07/2005 Peter Vela    CAR 63023                               *
.*           Recompiled for WATLETCD and WATLETDF                             *
.* V9.04.05  27/06/2005 Peter Vela    CAR 62391                               *
.*           Recompiled for WATLETCD and WATLETDF                             *
.* V9.04.04  22/06/2005 Peter Vela    CAR 60667                               *
.*           Fixed %wrprad, %wxprat, %wrprod, %wxprot variables               *
.*           22/06/2005 Peter Vela    CAR 59792                               *
.*           Fixed %wxadmw variable                                           *
.*           22/06/2005 Peter Vela    CAR 45249                               *
.*           Fixed %age variable                                              *
.* V9.04.03  21/06/2005 Ebon Clements CAR 62391                               *
.*           Recompiled for WATLETCD and WATLETDF - PAS and PAC clinics       *
.* V9.04.02  02/05/2005 Peter Vela   CAR 60667                                *
.*           Recompiled for WATLETCD and WATLETDF                             *
.* V9.04.01  07/04/2005 Peter Vela   CAR 59792                                *
.*           Recompiled for WATLETCD and WATLETDF                             *
.* V9.03.03  24/12/2003 Peter Vela   CAR 45149                                *
.*           Recompiled for WATLETCD                                          *
.* V9.03.02  15/12/2003 Peter Vela   CAR 45249                                *
.*           Recompiled for WATLETDF and WATLETCD                             *
.* V9.03.01  29/10/2003 Sandra Barcham   43783                                *
.*           Recompiled for NZHISIIO and NZHISIUP                             *
.******************************************************************************
.* V5.10.03  09/09/2002  Sunil Kumar  SRF 16160                               *
.*           Fixed (*) Problem in particular address line                     *
.* V5.10.02  21/08/2002 Raghunandan Surve,HPS  SRF18814                       *
.*           Re-compiled for PMSHCPDS                                         *
.* V5.10.01  07/08/2002  Guomin Fu      SRF 14267                             *
.*           Recompiled for WATLETCD                                          *
.* V5.09.B01 10/04/2001  Steve Downing  SRF 9644                              *
.*           Fixed display error caused by Proc Status flag reset bug         *
.******************************************************************************
.*        V5.08.04  21/08/2000  Caleb Sharman                                 *
.*                  Changed Health Fund variables to be 8 chars               *
.*        V5.08.03  21/07/2000 Caleb Sharman  SRF 646913                      *
.*                  Recompiled for PATEXTRD                                   *
.*        V5.08.02  11/07/2000 Caleb Sharman  SRF 646961                      *
.*                  Mods to allow for the variable at IBA screens - Misc 1    *
.*                  Number 14 (WL Ad-Hoc Screen in WAT30/OPR40), created for  *
.*                  Dudley in the UK, but used in NZ !!!                      *
.*        V5.08.01  12/05/2000 Caleb Sharman                                  *
.*                  Recompiled for PATEXTRD                                   *
.*        V5.07.03  06/12/1999 Caleb Sharman  5.08 Mods                       *
.*                  Mods to default the second UR to be the same as the first *
.*                  UR, also a list of records for the criteria is displayed  *
.*                  and the user is givin the ability to delete any of these  *
.*                  records                                                   *
.*        V5.07.02  03/11/1999 J Habasque                                     *
.*                  Mods to display inactive codes                            *
.*        V5.07.01  26/10/1999 J Habasque                                     *
.*                  Recompiled for WATDSPRO                                   *
.*       V5.07.B01  10/12/1998  Jim Stathopoulos                              *
.*                  507 Changes                                               *
.******************************************************************************
.*        V5.04.12  26/06/1997  Howellsy         505                          *
.*                  Use PATDOCKY instead of PATDOCDS                          *
.*        V5.04.11  02/09/1997  Steve Armstrong    SRF 643284/643230          *
.*                  Mods to read in STCNMISS parameter                        *
.*        V5.04.10  07/07/1997  Nick     SRF 643098                           *
.*                  Added OPEN statement to open patmi1af or patma1af for use *
.*                  in PATSRCH when doing a surname search                    *
.*        V5.04.09  16/06/1997  Steve Armstrong                               *
.*                  Fixed bugs in global recompile                            *
. *       V5.04.08  15/04/1997  howellsy   RHA                                *
. *                 Recompiled for WATDSPRO                                   *
.*                  Added user def 5-8, rank                          *
.*             V5.04.07  11/04/1997  Steve Armstrong    SRF 642798            *
.*                       Fixed UK bug (not padding out work variable)         *
.*             V5.04.06  07/03/97 Howellsy     SRF 642520                  *
.*                       Fixed Residential Address 3 & 4                   *
.*             V5.04.05  28/02/97 Howellsy     WHT                           *
.*                       Fixed U/R Number Keyin.                             *
.*             V5.04.04  18/02/97 Howellsy     WHT                           *
.*                       Added Cell Phone, Postal Add1-4, Postal Post Code   *
.*             V5.04.03  17/01/1997  Steve Armstrong                          *
.*                       Fixed bugs from global recompile (TBC 7)             *
.*             V5.04.02  29/10/1996  Steve Armstrong   SRF 642286             *
.*                       Mods to use alternative indexes on extract depending *
.*                       on which ranges are input                            *
.*             V5.04.01  13/08/1996  Steve Armstrong   SRF 641876             *
.*                       Added printing of priority variables.                *
.******************************************************************************
.*             V5.03.02  18/08/1995  MATT              SRF 611297             *
.*                       Put a return in the GETSVAR ROUTINE.                 *
.******************************************************************************
.*             V5.01.01  19/06/1989  M.Ohleiter        SRF 101623             *
.*                       Changes for new release 5.01                         *
.*                       Fixed to print all patients, exp. time               *
.*                       14/08/1989  S. O'Gorman                              *
.*                       Fixed Modify Routine for > 80 characters             *
.*             V5.01.02  25/08/1989  K.Peak            SRF 102114             *
.*                       Changed Treatment status to Procedure status         *
.*             V5.01.03  30/08/1989  Graeme Williams                          *
.*                       New PATCOMN1 (allows for merged U/R numbers)         *
.*             V5.01.04  20/11/1989  DIG               SRF 102895             *
.*                       Changed so that program picks up the dates that are  *
.*                       not on file properly and puts all 9's in them        *
.*             V5.01.05  12/12/1989  Karin Peak        SRF 103377             *
.*                       Recompiled for 5th index in BOKMASFD                 *
.*             V5.01.06  23/02/1990  E.Phan                                   *
.*                       Recompiled for WATPROFD                              *
.*             V5.01.07  01/03/1990  Steve O'Gorman                           *
.*                       Reset UPPLOW after scan in case conversion           *
.*             V5.01.08  25/07/1990 Paul Duncan                               *
.*                       Implemented second surname file                      *
.*             V5.01.09  03/08/1990  Justin Coates                            *
.*                       Added use of WTCNTPDS : Treatment/Procedure          *
.*                                                                            *
.*        V5.01.121 21/11/1990  i chung           SRF 107708                  *
.*                  Increased COUNTER size to cater for a big date range      *
.*        V5.01.122 24/01/1991  Justin Coates                                 *
.*                  Changed to use BOKRC1FD (rather than BOKMASFD)            *
.*        V5.01.123 29/01/1992  Graeme Williams                               *
.*                  Use category description for category "A "                *
.*        V5.01.124 13/05/92  ROD IS A POOF                                   *
.*                  Added department field                                    *
.*        V5.01.125 15/05/92  ROD IS A POOF                                   *
.*                  Added Pat. Class. ,Referred Doctor address 1 & 2          *
.*        V5.01.126 14/07/1992  Justin Coates     SRF 115771                  *
.*                  Fixed display of Procedure code and unit                  *
.*        V5.01.127 15/12/1992  Whirlpool                                     *
.*                  Added new ad-hoc selection screen for Dudley              *
.*        V5.01.128 11/01/93  ROD IS A POOF                                   *
.*                  Write to letter history file                              *
.*        V5.01.129 20/01/93  ROD IS A POOF                                   *
.*                  Allow 4th address line                                    *
.*        V5.01.130 21/01/93  ROD IS A POOF                                   *
.*                  Change Elective Admission Type to Category "CC"           *
.*        V5.01.131 23/03/1993  Justin Coates                                 *
.*                  Changed to use watonsus                                   *
.*        V5.01.132 25/02/1993  Steve O'Gorman                                *
.*                  Changed Version Number                                    *
.*        V5.01.133 03/03/1993  Whirlpool                                     *
.*                  Added new variables for letter for Dudley                 *
.*        V5.01.134 18/03/1993  ROD IS A POOF                                 *
.*                  Added item no.'s to "?" on GP code and practice           *
.*        V5.01.135 24/03/1993  Whirlpool                                     *
.*                  Changes to Watahocs                                       *
.*        V5.01.136 30/03/1993  ROD IS A POOF                                 *
.*                  Print ALL patients satisfying search criteria             *
.*        V5.01.137 30/03/1993  i chung           (Dudley change)             *
.*                  Added user security check                                 *
.*        V5.01.138 05/03/1993  Whirlpool                                     *
.*                  Fixed printing of hospital name                           *
.*                  Fixed I * M when no data was found                        *
.*        V5.01.139 08/04/1993  Whirlpool                                     *
.*                  Modified for new vars in WATAHOCS                         *
.*        V5.01.140 11/04/93 Graeme Williams                                  *
.*                  Recompiled for changes to WATAHSVR                        *
.*                  Use CONDSPUR instead of CONPURDS                          *
.*        V5.01.141 14/04/93  ROD IS GAY                                      *
.*                  Recompiled for changes to WATAHOCS                        *
.*        V5.01.142 16/04/93  ROD IS GAY                                      *
.*                  Changed category BC to WR                                 *
.*        V5.01.143 27/04/1993  Whirlpool                                     *
.*                  Fixed bug when writing to the letter history file         *
.*        V5.01.144 13/05/93  ROD IS GAY                                      *
.*                  Recompiled for changes to WATAHOCS                        *
.*        V5.01.145 18/05/93  Steve O'Gorman                                  *
.*                  Recompiled for changes to WATAHOCS (Suspensions)          *
.*        V5.01.146 26/05/93  Whirlpool                                       *
.*                  Recompiled for changes to WATAHOCS (invalid security mess)*
.*        V5.01.147 01/06/93  ROD                                             *
.*                  Open GP files only if used                                *
.*        V5.01.148 07/07/93  WHIRLPOOL          SRF 123516                   *
.*                  Recompiled for changes to WATAHOCS                        *
.*        V5.01.149 12/07/93  WHIRLPOOL          SRF 123516                   *
.*                  Recompiled for changes to WATAHOCS                        *
.*        V5.01.150 23/07/93  WHIRLPOOL          SRF 440243                   *
.*                  Recompiled for changes to WATAHOCS user defined fields    *
.*        V5.01.151 26/08/93  ROD                                             *
.*                  Recompiled for nzhis                                      *
.*        V5.01.152 11/10/93  Whirlpool     SRF 440289                        *
.*                  Fixed problem with ? option if not using WATAHOCS         *
.*        V5.01.153 22/11/93  Rob Leonard  SRF 440445                         *
.*                  Recompiled for changes to WATAHOCS                        *
.*        V5.01.154 23/11/93  Paul Howells       NZHIS    FIX-------> * Fix it 
.*                  Added PATALRFD & IO for NZHISIIO      FIX-------> *Yourself
.*        V5.01.155 16/12/93  ROD             (DUDLEY)                        *
.*                  Added GP Practice Letter variables                        *
.*        V5.01.156 24/03/1994    Matt Surridge                               *
.*                  Recompile for NZHISIIO and DONORDET.                      *
.*        V5.01.157 06/05/1994  Glenn Berry      SRF 601021                   *
.*                  Fixed I * C.  Don't Read gp files if not using them       *
.*        V5.01.158 19/05/1994  Paul Howells     SRF 440822                   *
.*                  Determine & use the most appropriate index when searching.*
.*        V5.01.159 01/07/1994  Rob Leonard  SRF 440475                       *
.*                  Recompiled for changes to WATAHOCS                        *
.*                                                                            *
.*        V5.02.01  30.11.1994    B.G.Ackland                                 *
.*                  Remove Date of Death Link to NHI/MWS                      *
.*                  Recompile for Latest NHI/MWS Changes                      *
.******************************************************************************
.
          INC       STD001FD
          INC       IBASEQFD/INC
          INC       PATCOMM/INC
.
          INC       NHIMASFD/INC
          INC       NZHISIFD/INC
          INC       PATALRFD/INC
........  INC       PATMWSFD/INC
          INC       PATSMWFD/INC
          INC       PATDNRFD/INC
          INC       PATSDNFD/INC
          INC       PATNIDFD/INC
          INC       BOKRC1FD/INC
          INC       BOKRX1FD/INC
          INC       OUTPREFD/INC
          INC       PATCODFD/INC
          INC       MLTCODFD/INC
          INC       PATCONFD/INC
          INC       PATDO1FD/INC
          INC       PMSHCLFD/INC
          INC       PMSHCPFD/INC
          INC       PMSHCGFD/INC
          INC       PATHSPFD/INC
          INC       PATMA1FD/INC
          INC       PMSPX2FD/INC
          INC       PATMI1FD/INC
          INC       PATVISFD/INC
          INC       PATPR1FD/INC
          INC       PATGSRFD/INC
          INC       PATWR1FD/INC
          INC       PMSCEXFD/INC
          INC       PMSVX1FD/INC
          INC       TFILEVAR/INC
.
          INC       WATAHSVR/INC
          INC       WATCONFD/INC
          INC       WATLETDF                 * variables for letter printing
          INC       WATLETFD/INC
          INC       WATLHIFD/INC
          INC       WATVWLFD/INC
          INC       PATCALAG/INC
          INC       PATDHEAD/INC
          INC       WATPROFD/INC
          INC       WATSEAFD/INC
          INC       WATSEIFD/INC
          INC       WATSUSFD/INC
          INC       WATTR1FD/INC
          INC       SCRPSTFD/INC
          INC       WATOPAFD/INC
          INC       WATOPSFD/INC
          INC       OUTBB1FD/INC
          INC       OUTBOAFD/INC
          INC       OUTCLIFD/INC
          INC       OUTHEDFD/INC
          INC       OUTMA1FD/INC
          INC       OUTSESFD/INC
          INC       OUTSITFD/INC
          INC       WATTX1FD/INC
          INC       WATCHAFD/INC
          INC       WEBERRFD/INC
          INC       WEBSECFD/INC
+
.**********************************************************************
.*                  TEMP FILE DECLARATION                             *
.**********************************************************************
TEMP1     FILE      ASCII,FIXED=399
.Name     Type    Length      Start
.-------  ----    ------      -----
BOOKNO    DIM       8           1
URDIM     DIM       8           9
FDATE     DIM       19         17
DOCTNAM   DIM       33         36
XXDATE    DIM       19         69
FULLNAME  DIM       52         88
XTIME     DIM       8         140
LDATE     DIM       19        148
PDATE     DIM       19        167
PTIME     DIM       8         186
LRDATE    DIM       19        194
WORKDEPT  DIM       3         213
RFDADD1   DIM       30        216
RFDADD2   DIM       30        246
.WMCODE    DIM       9        276
.WMUNIT    DIM       3        285
DADATE    DIM       19        288
GADATE    DIM       19        307
DNABDATE  DIM       19        326
NAFDATE   DIM       19        345
NATDATE   DIM       19        364
ELECATYP  DIM       3         373
.WMCNT    FORM      2         376
.WMPTY    DIM       3         378
.WMUDEF5  DIM       3         381
.WMUDEF6  DIM       3         384
.WMUDEF7  DIM       3         387
.WMUDEF7  DIM       3         390
.WTWMRANK FORM      6         393
.End of Record                399
RFDTITL   DIM       10
RFDADD3   DIM       30
RFDADD4   DIM       30
.                                          
TEMPF2    IFILE     SQL,FIXED=28, KEY="U1-8,9-16,17-25,26-27"
.Name     Type    Length      Start
.-------  ----    ------      -----
YYDATE1   DIM      8           1
YYURNO    DIM      8           9 
YYCODE    DIM      9           17
YYMCNT    DIM      2           26
.End of Record                 27
+
.**********************************************************************
.*                       GLOBAL VARIABLES                             *
.**********************************************************************
BOOKDM8   DIM       8
BOTTMARG  FORM      2
BTYPE     DIM       20
BJDAY     FORM      3
CJDAY     FORM      3
CALLPOSN  FORM      1
CATACTIV  FORM      1
CATADES   DIM       20
CATEGORY  DIM       2
CATTC     INIT      "tc"
CFILEPRE  DIM       3
CHECKSIT  DIM       6
CKLINKED  FORM      1
CMDLINE   DIM       80
CODE      DIM       2
CONTTYPE  DIM       1
COUNT2    FORM      5
COUNT3    FORM      3
COUNTER   FORM      5
DATE      DIM       8
DATELINE  DIM       19
DDESCWU   DIM       20           * display variable for referral/unit
DESCBC    DIM       20           * removal decription
DESCNOT   DIM       20           * description for short notice (cata WS)
DESCCAT   DIM       20           * description for department (cata A)
DESCPCLS  DIM       20           * description for patient classif (cata A)
DESCPTYP  DIM       20           * description for Waiting type (cata WT)
DESCRESS  DIM       20           * description for residential status (cata RRS
DESCTP    DIM       20           * description for priority (cata TP)
DESCWU    DIM       20           * description for clinic/unit (cata WU)
DEXT      DIM       3
DIM6ARRY  DIM       6[34]
DIM27     DIM       27
DIM30     DIM       30
DIM55     DIM       55 
DIM70     DIM       70 
DIM127    DIM       127
DIMAGE    DIM       3                * I CAR 45249
DIMD01    DIM       27
DIMD02    DIM       27                                                         
DIMD03    DIM       27
DIMD04    DIM       27
DIMD05    DIM       27
DIMD06    DIM       27
DIMD07    DIM       27
DIMD08    DIM       27
DIMD09    DIM       27
DIMD10    DIM       27
DIMD11    DIM       27
DIMD12    DIM       27
DIMD13    DIM       27
DIMD14    DIM       27
DIMD15    DIM       27
DIMD16    DIM       27
DIMD17    DIM       27
DISPACT   FORM      1
DISPSTRN  DIM       80 
DOCLINE   DIM       33
DOCNAME   DIM       32           * doctor title initial.surname for display
DSEX      DIM       6            * descr. sex
DUMMY     DIM       1
EADMDESC  DIM       20
ENDSTR    FORM      2
FORM8     FORM      8
FIELD     FORM      2
FIRSTCH   FORM      1
FLGRR     FORM      1            * Removal Reason
FLGRD     FORM      1            * Removal Date
FLGUDF1   FORM      1            * user define 1
FLGUDF2   FORM      1            * user define 2
FLGUDF3   FORM      1            * user define 3
FLGUDF4   FORM      1            * user define 4
FLGCO     FORM      1        * proccode
FLAGCO    FORM      1        * proccode
FLGD1     FORM      1        * date on list
FLAGD1    FORM      1        * date on list
FLAGD2    FORM      1        * last review date
FLGD2     FORM      1        * last review date
FLGD3     FORM      1        * scheduled admission
FLAGD3    FORM      1        * scheduled admission
FLGDO     FORM      1        * doctor
FLAGDO    FORM      1        * doctor
FLGDOS    FORM      1            * Date On System
FLGES     FORM      1        * estimated stay
FLAGES    FORM      1        * estimated stay
FLGPC     FORM      1        * patient category
FLGPL     FORM      1            * patient classification
FLGPT     FORM      1        * priority
FLAGPT    FORM      1        * priority
FLGRAD    FORM      1            * Re-Assessment Date
FLGSN     FORM      1        * short notice
FLAGSN    FORM      1        * short notice
FLGST     FORM      1        * treatment status
FLAGST    FORM      1        * treatment status
FLGUN     FORM      1        * unit
FLAGUN    FORM      1        * unit
FLGUR     FORM      1        * UR
FLAGUR    FORM      1        * UR
FLGRS     FORM      1        * resident status 
FNAMER    DIM       8
FORM3     FORM      3
FORM3A    FORM      3
FRSTGNAM  DIM       40
FULLGNAM  DIM       80
HOUR      DIM       2
HTMLFILE  FIFO      ASCII, FIXED=250
IBCNMHOS  FORM      1
IDDIM1    DIM       8
INITIAL   DIM       4
.
KDOSDAT1  DIM       8            * start date on system
KDOSDAT2  DIM       8            * end date on system
KREMDAT1  DIM       8            * start removal date
KREMDAT2  DIM       8            * end removal date
KREADAT1  DIM       8            * start re-assessment date
KREADAT2  DIM       8            * end re-assessment date
KREMREAS  DIM       3            * removal reason
KSTCODE   DIM       9
KSTDATE1  DIM       8
KSTDATE2  DIM       8
KSTDATE3  DIM       8
KSTDOC    DIM       6
KSTNOT    DIM       3
KSTPCAT   DIM       3
KSTPCLS   DIM       3
KSTPTY    DIM       3
KSTSTAT   FORM      1
KSTUNIT   DIM       3
KSTWTYP   DIM       3
KSTRESS   DIM       3
KTOCODE   DIM       9
KTODATE1  DIM       8
KTODATE2  DIM       8
KTODATE3  DIM       8
KTODOC    DIM       6
KTOUNIT   DIM       3
.
LEAVPSMS  FORM      1        * Don't send overdue leave SMS to patient
LEAVFSMS  DIM       20       * First SMS number of not sending to patient
LEFTMARG  FORM      2
LETDESC   DIM       25
LETTER    DIM       3
LETTFORM  FORM      3
LINE      DIM       55
.
MASK      DIM       20
MINUTE    DIM       2
MODE1     DIM       1
MONTH     DIM       9
NAMELINE  DIM       52
NAMEDIS   DIM       14
NMPNUMB   DIM       20
.
PACCOM    DIM       20
PATDOB    DIM       10           * DOB patient
PATNAME   DIM       30           * name patient
PDESC     DIM       50
PERCPOS   FORM      2
PHYSPAGE  FORM      3
POS       FORM      2
PRTSTRNG  DIM       80
PMHGFLAG  FORM      "0"             Flag for display of active GP prac's in ?
.                                   0 = Don't Display Inactive Gp's Prac's
.                                   1 = Display all Gp Practices
.
PMHGQARR  DIM       12[17]        * array for pmshcgds
PMHGQCNT  FORM      2             * count of items on screen
PMHCSNAX  DIM       20              Redefine field for ? Surname
PMHCGNAX  DIM       25              Redefine field for ? Given Name
PMHCPRCX  DIM       6               Redefine field for ? Practice Code
PMHCFLAG  FORM      "0"             Flag for display of active GP in ?
.                                   0 = Don't Display Inactive Gp's
.                                   1 = Display all Gp's
.
PMHCQARR  DIM       16[20]        * array for ? option
PMHCQCNT  FORM      2             * counter for ? option
PMHLFLAG  FORM      "0"                   Flag to display all links in ?
.                                         0 = Don't display inactive links
.                                         1 = Display all links
.
QUOTE     INIT      "#""
.
REDISPS   DIM       8
REFPRTY   DIM       20
REFUNIT   DIM       20
REPLY     DIM       2
RESPSEX   DIM       6 
RESPNAME  DIM       52
RESPADDA  DIM       25
RESPADDB  DIM       25
RESPSUBR  DIM       15
RESPPOST  DIM       4
RESPADDD  DIM       25
.
RGPRSURG  DIM       55            * Registered GP PRACTICE vars
RGPRSAD1  DIM       55
RGPRSAD2  DIM       55
RGPRSAD3  DIM       55
RGPRSAD4  DIM       55
RGPRSPCD  DIM       8 
RGPRTELE  DIM       20
RGPRFAXN  DIM       20
RGPRPEML  DIM       55
.
RFPRSURG  DIM       25            * Referring GP PRACTICE vars
RFPRSAD1  DIM       35
RFPRSAD2  DIM       35
RFPRSAD3  DIM       35
RFPRSAD4  DIM       35
RFPRSPCD  DIM       8 
RFPRTELE  DIM       20
.
RFGPSNAM  DIM       20
RFGPGNAM  DIM       20
RFGPADD1  DIM       35
RFGPADD2  DIM       35
RFGPADD3  DIM       35
RFGPADD4  DIM       35
RFGPPOST  DIM       8
RGGPSNAM  DIM       35
RGGPGNAM  DIM       35
RGGPADD1  DIM       55
RGGPADD2  DIM       55
RGGPADD3  DIM       55
RGGPADD4  DIM       55
RGGPPOST  DIM       8
RGGPFAXN  DIM       20
RGGPSEML  DIM       80
RGGPMOBN  DIM       20
RGGPPAGR  DIM       20
RGGPPAGN  DIM       20
RGGPPRV1  DIM       10
RGGPSTEL  DIM       20
.
SCNDGNAM  DIM       40
SCREEN    FORM      2
SESNDATE  DIM       8
SP40      DIM       40
SRCHNUM   FORM      3
STARTSTR  FORM      2
STATUS    DIM       13
SURN1     DIM       20
SURN2     DIM       20
.
TEMP2     FORM      2
TEMP3     FORM      3
TEMP4     FORM      3
TEMP55    DIM       55
TEMP70    DIM       70
TEMPHOUR  FORM      3
TEMPHOUR2 FORM      2
TMPKEY    DIM       27[17]
TESTFORM  FORM      6
TIMELINE  DIM       8
TOPMARG   FORM      2
.
URFORM    FORM      8
USERDEF1  DIM       3            * user define code 1
USERDEF2  DIM       3            * user define code 2
USERDEF3  DIM       3            * user define code 3
USERDEF4  DIM       3            * user define code 4
VAR       DIM       127
VERT      FORM      2
VERTPOS   FORM      2
WLETPLEN  FORM      3
YPOS      FORM      2
.
LETRCOMM  DIM       1                  * Letter Communication Method
.                                         0 or Blank = Printed Letter
.                                         1 = SMS Notification
CONTPNMS  DIM       200                * Pipe-delimited list of phone numbers
CONTMSGI  DIM       200                * Pipe-delimited list of msg id's
CONTTYPS  DIM       200                * Pipe-delimited list of contact types
MAXCOUNT  INIT      "10"               * Max count for SMS phone numbers
+
.**********************************************************************
.*                             CONSTANTS                              *
.**********************************************************************
NINETY4   FORM      "94"
CATAP     INIT      "ap"                                               *I-59792
CODET     INIT      "T "
CODEBK    INIT      "BK"
CODEBP    INIT      "BP"
CODECZ    INIT      "CZ"
CODEX5    INIT      "X5"
CODEX6    INIT      "X6"
CODEX7    INIT      "X7"
CODEX8    INIT      "X8"
CODES     INIT      "S "
CODEVI    INIT      "VI"
CODEWR    INIT      "WR"
DEXT1     INIT      "st"
DEXT2     INIT      "nd"
DEXT3     INIT      "rd"
DEXT4     INIT      "th"
DOLLAR    INIT      "$"
PRSCR     INIT      "18"
.
LINE27    FORM      "27"
.
MONTH1    INIT      "January"
MONTH2    INIT      "February"
MONTH3    INIT      "March"
MONTH4    INIT      "April"
MONTH5    INIT      "May"
MONTH6    INIT      "June"
MONTH7    INIT      "July"
MONTH8    INIT      "August"
MONTH9    INIT      "September"
MONTH10   INIT      "October"
MONTH11   INIT      "November"
MONTH12   INIT      "December"
REPSTR    INIT      "a0b0c0d0e0f0g0h0i0j0k0l0m0n0o0p0q0r0s0t0u0v0w0x0y0z0102030405060708090"
.
SP52      INIT      "                                                    "
SP50      INIT      "                                                  "
SP27      INIT      "                           "
.                                           * SRF 16160 Code Change Begin
.STAR52    INIT      "****************************************************"
.STAR50    INIT      "**************************************************"
STAR52    INIT      "                                                    "
STAR50    INIT      "                                                  "
.                                           * SRF 16160 Code Change End
.
TMKEY     INIT      " 28 U1-8,9-16,17-25,26-27"
TO        INIT      " TO "
TWOHUN24  FORM      "224"
TWOHUN28  FORM      "228"
WAT5FLAG  FORM      "1"
XX        INIT      "17"
ZEDS      INIT      "ZZZZZZZZ"
Z15       INIT      "zzzzzzzzzzzzzzz"
.
PRGID     INIT      "IBAWAT30"
PRGNAM    INIT      "Adhoc Letter Printing"
VERSION   INIT      "V12.00.03"
+
.**********************************************************************
.*                           MAINLINE                                 *
.*                      Controlling Logic                             *
.**********************************************************************
ML0000    CALL      INIT0000                * display header, initialise files
.                                           * & set up port dependant temp. file
ML0200    CALL      OPTN0000                * main option screen
          BRANCH    EXIT,ML9999
          CALL      CLRP0000                * clear all input parameters
.
.------ mainline for general letters ------
.
ML0500    IF        PTCNUAHS = 0
            CALL      GOPN0000              * general letter option 
          ELSE
.
. the routines below come from WATAHOCS (Dudley wanted ALL patients extracted
. from search criteria. What a product specialist!)
.
            CALL      CLER0000
            CALL      IMTH0000              * Initialise Match variables
            CALL      SCRN0000              * parameter screen + keyin params
            CALL      SIPC0000              * select to update
            BRANCH    EXIT,ML0200
.
            PREP      TEMP1,FNAMER
            PREP      TEMPF2,FNAMEX
            CALL      NXTR0000              * extract data
            BRANCH    EXIT,ML0200
            CLOSE     TEMP1
            BRANCH    EXIT,ML0500,ML0000
            OPEN      TEMP1,FNAMER     
            GOTO      ML0700
          ENDIF
.
ML0600    CALL      SEL0000                 * select field or Ok to post
          BRANCH    EXIT,ML0200
          BRANCH    CCITEM,ML1000,ML2000,ML3000,ML4000,ML5000,ML6000,ML7000:
                           ML8000,ML9000,MLX1000,MLX2000,MLX3000,MLX4000
          GOTO      ML0650
.
.------ parameter fields for selection ------
.
ML1000    CALL      URNO0000                * input U/R Number range
          BRANCH    EXIT,ML0200
          GOTO      ML0600
.
ML2000    CALL      PROC0000                * input proc. code range
          GOTO      ML0600
.
ML3000    CALL      TMNT0000                * input treatment status
          GOTO      ML0600
.
ML4000    CALL      LDTE0000                * input date on list range
          GOTO      ML0600
.
ML5000    CALL      RDTE0000                * input last review date range
          GOTO      ML0600
.
ML6000    CALL      ADTE0000                * input scheduled adm. date range
          GOTO      ML0600
.
ML7000    CALL      UNIT0000                * input unit range         
          GOTO      ML0600   
.
ML8000    CALL      DOCT0000                * input doctor             
          GOTO      ML0600   
.
ML9000    CALL      STAY0000                * input estimated stay     
          GOTO      ML0600   
.
MLX1000   CALL      PRTY0000                * input priority           
          GOTO      ML0600   
.
MLX2000   CALL      SHRT0000                * input short notice       
          GOTO      ML0600   
.
MLX3000   CALL      CATG0000                * Department
          GOTO      ML0600   
.
MLX4000   CALL      STAT0000                * input resident status    
          GOTO      ML0600   
.
ML0650    CALL      EXT20000
          BRANCH    EXIT,ML0200
          CALL      EXTR0000                * extract details 
          BRANCH    EXIT,ML0200
.
ML0700    CALL      LSEL0000                * select general letter for printing
.
ML0720    CALL      SET0000                 * set up values for % var's
          BRANCH    EXIT,ML0750
          CALL      WHIS0000                * write to the history file
.
          MATCH     "1",PTCNSMSN            * Using SMS Notifications?
          GOTO      ML0730 IF NOT EQUAL
.
          MATCH     "1",WLETCOMM
          IF        @EQUAL
            CALL      PRMSGH00              * print SMS Messages XML Header tag
          ENDIF
.
ML0730    CALL      PRIN0000                * print letters
          BRANCH    EXIT,ML0700,ML0720
.
ML0750    MATCH     "1",WLETCOMM
          IF        @EQUAL
            CALL      PRMSGF00              * print SMS Messages XML Footer tag
          ENDIF
.
          CALL      MORE0000                * any more letters to print
          BRANCH    EXIT,ML0200,ML0700
.
ML9999    PREP      TEMP1,FNAMER
          CLOSE     TEMP1,DELETE
          PREP      TEMPF2,FNAMEX
          CLOSE     TEMPF2,DELETE
          CHAIN     PGM
+
.**********************************************************************
.*                           INIT0000                                 *
.*                   Display header and open files                    *
.**********************************************************************
INIT0000  CALL      DISPHEAD
          DISPLAY   *P56:24,"Opening bokrc1af";
          OPEN      BOKRC1A1,"bokrc1af"
.
          DISPLAY   *P56:24,"Opening bokrx1af";
          OPEN      BOKRX1A1,"bokrx1af"
.
          OPEN      IBASEQA1,"ibaseqaf"
          OPEN      WEBSECA3,"websecaf"
.
          DISPLAY   *P64:24,"controlf";
          OPEN      CONTROLF,"controlf"
.
          READ      CONTROLF,THIRTY7;*122,WTCNTPUC,*185,WTCNTPDS,*211,WTCNWLSC:
                                     *213,WTCNULHI
          READ      CONTROLF,TWENTY1;*57,PTCNUAHS
          READ      CONTROLF,HUND18;*138,PTCNNEWC
          READ      CONTROLF,HUND20;*243,PTCNSMSN
.
          DISPLAY   *P64:24,"patcodes";
          OPEN      PATCODE1,"patcodes"
.
          DISPLAY   *P64:24,"patdo1af";
          OPEN      PATDO1A1,"patdo1af"
          OPEN      PATDO1A2,"patdo1af"
.
          DISPLAY   *P64:24,"patgsrnf"
          OPEN      PATGSRN2,"patgsrnf"
          OPEN      PATGSRN3,"patgsrnf"
          OPEN      PATGSRN4,"patgsrnf"
.
          DISPLAY   *P64:24,"pathspaf";
          OPEN      PATHSPA1,"pathspaf"
.
          DISPLAY   *P64:24,"patma1af";
          OPEN      PATMA1A1,"patma1af"
          DISPLAY   *P64:24,"patmx1af";
          OPEN      PATMX1A1,"patmx1af"
          DISPLAY   *P64:24,"pmspx2af";
          OPEN      PMSPX2A1,"pmspx2af"
.
          DISPLAY   *P72:24,"pmscexaf"
          OPEN      PMSCEXA1,"pmscexaf"
.
          DISPLAY   *P64:24,"patpramf";
          OPEN      PATPR1A1,"patpr1af"
          OPEN      PATPX1A1,"patpx1af"
.
          DISPLAY   *P64:24,"patwr1af";
          OPEN      PATWR1A1,"patwr1af"            
.
          DISPLAY   *P64:24,"watletrf";
          OPEN      WATLETR1,"watletrf"
          OPEN      WATLETR2,"watletrf"
.
          IF        WTCNULHI = 1
            DISPLAY   *P64:24,"watlhiaf";
            OPEN      WATLHIA1,"watlhiaf"
          ENDIF
.
          DISPLAY   *P64:24,"watproaf";
          OPEN      WATPROA1,"watproaf"
          OPEN      WATPROA2,"watproaf"
          OPEN      WATPROA3,"watproaf"
.
          IF        WTCNWLSC = 1
            DISPLAY   *P64:24,"watseaaf";
            OPEN      WATSEAA1,"watseaaf"
            DISPLAY   *P64:24,"watseiaf";
            OPEN      WATSEIA2,"watseiaf"
          ENDIF
.
          DISPLAY   *P64:24,"watsusaf";
          OPEN      WATSUSA1,"watsusaf"
.
          DISPLAY   *P64:24,"wattr1af";
          OPEN      WATTR1A1,"wattr1af"
          OPEN      WATTR1A2,"wattr1af"
          OPEN      WATTR1A3,"wattr1af"
.
          DISPLAY   *P64:24,"watchaaf";
          OPEN      WATCHAA1,"watchaaf"
.
          DISPLAY   *P64:24,"wattx1af";
          OPEN      WATTX1A1,"wattx1af"
.
          DISPLAY   *P64:24,"watvwlaf";
          OPEN      WATVWLA1,"watvwlaf"
.
          DISPLAY   *P64:24,"pmshclaf";
          OPEN      PMSHCLA1,"pmshclaf"
.
          DISPLAY   *P64:24,"pmshcpaf";
          OPEN      PMSHCPA1,"pmshcpaf"
          OPEN      PMSHCPA2,"pmshcpaf"
.
          DISPLAY   *P64:24,"pmshcgaf";
          OPEN      PMSHCGA1,"pmshcgaf"
.
          DISPLAY   *P64:24,"patma1af";
          OPEN      PATMA1A1,"patma1af"
.
          DISPLAY   *P64:24,"patmi1af";
          OPEN      PATMI1A1,"patmi1af"
.
          DISPLAY   *P64:24,"patvisaf";
          OPEN      PATVISA1,"patvisaf"
.
          DISPLAY   *P64:24,"pmsvx1af";
          OPEN      PMSVX1A1,"pmsvx1af"
.
          DISPLAY   *P64:24,"watopaaf";
          OPEN      WATOPAA1,"watopaaf"
.
          DISPLAY   *P64:24,"watopsaf";
          OPEN      WATOPSA1,"watopsaf"
.
          DISPLAY   *P64:24,"outsitaf";
          OPEN      OUTSITA1,"outsitaf"

          MOVE      "out",CFILEPRE          * Save Current File Prefix
          CALL      OPNOUT00                * Open Outpatient Files
.
          PACK      SP40,SP20,SP20
          MOVE      SP8,SESNDATE
.
.------ set up port dependant temporary file ------
.
          CALL      TFILENAM * Get temp file name in create
          MOVE      TFILNAME,FNAMER
.
          CALL      TFILENAM * Get temp file name in create
          MOVE      TFILNAME,FNAMEX
.
          MOVE      SP20,TDESC
          PACK      KEY5,CODEWU,SP5
          CALL      RDCODE1
          MOVE      TDESC,DDESCWU
.
          MOVE      SP20,TDESC
          PACK      KEY5,CODEA,SP5
          CALL      RDCODE1
          MOVE      TDESC,CATADES
          STRIP     CATADES
.
          IF        PTCNUAHS = 1
            MOVE      ONE,CNEWDS
          ELSE
            MOVE      ZERO,CNEWDS    
          ENDIF
.
          MOVE      ZERO,PRINTOPT
.
          MOVE      ONE,FLAGUR 
          MOVE      ONE,FLAGCO
          MOVE      ONE,FLAGST
          MOVE      ONE,FLAGD1
          MOVE      ONE,FLAGD2
          MOVE      ONE,FLAGD3
          MOVE      ONE,FLAGUN
          MOVE      ONE,FLAGDO
          MOVE      ONE,FLAGES
          MOVE      ONE,FLAGPT
          MOVE      ONE,FLAGSN
.
INIT9999  RETURN
+
.**********************************************************************
.*                           OPTN0000                                 *
.*                   Display the main option screen                   *
.*  0 = Exit                                                          *
.*  1 = Print Letters                                                 *
.**********************************************************************
OPTN0000    MOVE       FALSE,EXIT
.
            HLINE      *G37,2,51,80
            DISPLAY    *P1:3,*EF:
                       *P1:4,*V2LON,"0",*HOFF," = Exit":
                       *P1:5,*V2LON,"1",*HOFF," = Print Letters":
                       *P1:7,*EL,"Select Option : ";
.
OPTN1000    KEYIN      *P17:7,*DV,UNDLN1,*P17:7,*V2LON,OPTION;
            COMPARE    ZERO,OPTION
            GOTO       OPTN9000 IF EQUAL
.
            BRANCH     OPTION,OPTN9999
            BEEP
            GOTO       OPTN1000
.
OPTN9000    MOVE       TRUE,EXIT            * exit option chosen
.
OPTN9999    RETURN
+
.**********************************************************************
.*                               GOPN0000                             *
.*           Display menu for general letter option                   *
.**********************************************************************
GOPN0000    DISPLAY    *P51:2,*V2LON,"- General Letters ",*P1:3,*EF:
                       *P1:4," 1":
                       *P1:5," 2":
                       *P1:6," 3":
                       *P1:7," 4":
                       *P1:8," 5":
                       *P1:9," 6":
                       *P1:10," 7":
                       *P1:11," 8":
                       *P1:12," 9":
                       *P1:13,"10":
                       *P1:14,"11":
                       *P1:15,"12":
                       *P1:16,"13":
                       *P1:16,"13":
                       *P3:4,*HOFF,". U/R Number          : ":
                       *P3:5,". ",WTCNTPDS," Code      : ":
                       *P3:6,". ",WTCNTPDS," Status    : ":
                       *P3:7,". Date On List        : ":
                       *P3:8,". Last Review Date    : ":
                       *P3:9,". Scheduled Admission : ":
                       *P3:10,". ",DDESCWU,*P25:10,": ":
                       *P3:11,". Doctor              : ":
                       *P3:12,". Estimated Stay      : ":
                       *P3:13,". Priority            : ":
                       *P3:14,". Short Notice        : ":
                       *P3:15,". ",CATADES,*P25:15,": ":
                       *P3:16,". Resident Status     : ";
GOPN9999    RETURN
+
.**********************************************************************
.*                           CLRP0000                                 *
.*                  Clears all input parameters                       *
.**********************************************************************
CLRP0000  MOVE      SP8,KSTUR
          MOVE      ZEDS,KTOUR
          PACK      KSTCODE,SP10
          PACK      KTOCODE,SP10
          MOVE      ZERO,KSTSTAT
          PACK      KSTDATE1,SP10
          PACK      KTODATE1,SP10
          PACK      KSTDATE2,SP10
          PACK      KTODATE2,SP10
          PACK      KSTDATE3,SP10
          PACK      KTODATE3,SP10
          PACK      KSTUNIT,SP10
          PACK      KTOUNIT,SP10
          PACK      KSTDOC,SP10
          PACK      KTODOC,SP10
          MOVE      ZERO,KSTSTAY
          MOVE      "99999",KTOSTAY
          PACK      KSTPTY,SP10
          PACK      KSTNOT,SP10
          PACK      KSTPCAT,SP10
          PACK      KSTRESS,SP10
          MOVE      ZERO,FLGUR
          MOVE      ZERO,FLGCO
          MOVE      ZERO,FLGST
          MOVE      ZERO,FLGD1
          MOVE      ZERO,FLGD2
          MOVE      ZERO,FLGD3
          MOVE      ZERO,FLGUN
          MOVE      ZERO,FLGDO
          MOVE      ZERO,FLGES
          MOVE      ZERO,FLGPT
          MOVE      ZERO,FLGSN
          MOVE      ZERO,FLGPC
          MOVE      ZERO,FLGRS
          MOVE      ONE,FLAGUR
          MOVE      ONE,FLAGCO
          MOVE      ONE,FLAGST
          MOVE      ONE,FLAGD1
          MOVE      ONE,FLAGD2
          MOVE      ONE,FLAGD3
          MOVE      ONE,FLAGUN
          MOVE      ONE,FLAGDO
          MOVE      ONE,FLAGES
          MOVE      ONE,FLAGPT
          MOVE      ONE,FLAGSN
.
          MOVE      ZERO,LETRCOMM
          PACK      CONTPNMS,SP70,SP70,SP70
          PACK      CONTMSGI,SP70,SP70,SP70
.
CLRP9999  RETURN
+
.**********************************************************************
.*                             DISP0000                               *
.*         Display field values again for question mark option        *
.**********************************************************************
DISP0000  COMPARE   ZERO,FLGUR   
          GOTO      DISP1010 IF EQUAL
          DISPLAY   *P27:4,*V2LON,KSTUR,*HOFF,"   To ",*V2LON,*P41:4,KTOUR;
.
DISP1010  COMPARE   ZERO,FLGCO   
          GOTO      DISP1020 IF EQUAL
          DISPLAY   *P27:5,*V2LON,KSTCODE,*HOFF,"  To ",*V2LON,*P41:5,KTOCODE;
.
DISP1020  COMPARE   ZERO,FLGST   
          GOTO      DISP1030 IF EQUAL
          DISPLAY   *P27:6,*V2LON,KSTSTAT,*P38:6,*HOFF,STATUS;
.
DISP1030  COMPARE   ZERO,FLGD1   
          GOTO      DISP1040 IF EQUAL
          UNPACK    KSTDATE1,CCENT,CYEAR,CMON,CDAY
          DISPLAY   *P27:7,*V2LON,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR,*HOFF:
                                  " To ";
          UNPACK    KTODATE1,CCENT,CYEAR,CMON,CDAY
          DISPLAY   *P41:7,*V2LON,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR;
.
DISP1040  COMPARE   ZERO,FLGD2   
          GOTO      DISP1050 IF EQUAL
          UNPACK    KSTDATE2,CCENT,CYEAR,CMON,CDAY
          DISPLAY   *P27:8,*V2LON,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR,*HOFF:
                                  " To ";
          UNPACK    KTODATE2,CCENT,CYEAR,CMON,CDAY
          DISPLAY   *P41:8,*V2LON,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR;
.
DISP1050  COMPARE   ZERO,FLGD3   
          GOTO      DISP1060 IF EQUAL
          UNPACK    KSTDATE3,CCENT,CYEAR,CMON,CDAY
          DISPLAY   *P27:9,*V2LON,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR,*HOFF:
                                  " To ";
          UNPACK    KTODATE3,CCENT,CYEAR,CMON,CDAY
          DISPLAY   *P41:9,*V2LON,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR;
.
DISP1060  COMPARE   ZERO,FLGUN   
          GOTO      DISP1070 IF EQUAL
          DISPLAY   *P27:10,*V2LON,KSTUNIT,*HOFF,"        To ",*V2LON:
                    *P41:10,KTOUNIT;
.
DISP1070  COMPARE   ZERO,FLGDO   
          GOTO      DISP1080 IF EQUAL
          DISPLAY   *P27:11,*V2LON,KSTDOC,*HOFF,"     To ",*V2LON:
                    *P41:11,KTODOC;
.
DISP1080  COMPARE   ZERO,FLGES   
          GOTO      DISP1090 IF EQUAL
          DISPLAY   *P27:12,*V2LON,KSTSTAY,*HOFF,"      To ",*V2LON:
                    *P41:12,KTOSTAY;
.
DISP1090  COMPARE   ZERO,FLGPT   
          GOTO      DISP1100 IF EQUAL
          DISPLAY   *P27:13,*V2LON,KSTPTY,*HOFF,*P38:13,DESCTP;
.
DISP1100  COMPARE   ZERO,FLGSN   
          GOTO      DISP1110 IF EQUAL
          DISPLAY   *P27:14,*V2LON,KSTNOT,*HOFF,*P38:14,DESCNOT;
.
DISP1110  COMPARE   ZERO,FLGPC   
          GOTO      DISP1120 IF EQUAL
          DISPLAY   *P27:15,*V2LON,KSTPCAT,*HOFF,*P38:15,DESCCAT;
.
DISP1120  COMPARE   ZERO,FLGRS   
          GOTO      DISP9999 IF EQUAL
          DISPLAY   *P27:16,*V2LON,KSTRESS,*HOFF,*P38:16,DESCRESS;
.
DISP9999  RETURN
+
.**********************************************************************
.*                             SEL0000                                *
.*                Select field to modify or OK to post - General      *
.**********************************************************************
SEL0000     MOVE       FALSE,EXIT
            CALL       MAINQST
            COMPARE    ZERO,CCITEM          * zero to post
            GOTO       SEL9999 IF EQUAL
            COMPARE    "-1",CCITEM          * -1 to cancel
            GOTO       SEL9000 IF EQUAL
            COMPARE    TEN4,CCITEM
            GOTO       SEL0000 IF NOT LESS  * invalid selection
            GOTO       SEL9999
.
SEL9000     MOVE       TRUE,EXIT            * cancel option chosen
.
SEL9999     RETURN
+
.**********************************************************************
.*                           URNO0000                                 *
.*                     Input U/R numbers                              *
.**********************************************************************
URNO0000  MOVE      FALSE,EXIT
          MOVE      SP8,KSTUR
          MOVE      ONE,FLGUR
          DISPLAY   *P27:4,*EL,"________   To ________ ";
.
          MOVE      FOUR,CVERT
          MOVE      LINE27,CCOL
          MOVE      TWO,SRCHOPT
          MOVE      ZERO,SRCHSYS
          OPEN      CONTROLF,"controlf"
          CALL      KURN                            * keyin U/R Number
          CLOSE     CONTROLF
          BRANCH    EXIT,URNO1000
          BRANCH    OVRCD,URNO1500
.
          MOVE      CPPURNO,KSTUR
          MATCH     "       0",KSTUR
          GOTO      URNO9000 IF EQUAL
          GOTO      URNO2000
.
.
URNO1500  DISPLAY   *P1:24,*EL,*B,"U/R Not on File. ";
          CALL      HITENTER
          GOTO      URNO0000
.
URNO1000  MOVE      SP8,KSTUR
          DISPLAY   *P27:4,*V2LON,KSTUR;
          DISPLAY   *P38:4,"To ";
.
URNO2000  MOVE      "41",CCOL
          OPEN      CONTROLF,"controlf"
          CALL      KURN
          CLOSE     CONTROLF
          BRANCH    EXIT,URNO3000
          BRANCH    OVRCD,URNO2500
          MOVE      CPPURNO,KTOUR
          MOVE      ZERO,FLAGUR
          GOTO      URNO4000
.
URNO2500  DISPLAY   *P1:24,*EL,*B,"U/R Not on File. ";
          CALL      HITENTER
          GOTO      URNO2000
.
URNO3000  MOVE      KSTUR,KTOUR
          MATCH     SP8,KTOUR
          GOTO      URNO4000 IF EQUAL
          MOVE      ZERO,FLAGUR
.
URNO4000  MATCH     KSTUR,KTOUR
          GOTO      URNO4500 IF LESS
          DISPLAY   *P27:4,*V2LON,KSTUR,*HOFF,"   To ",*V2LON,KTOUR;
          MOVE      FALSE,EXIT
          GOTO      URNO9999
.
URNO4500  DISPLAY   *P1:24,*EL,*B,*V2LON:
                    "** End U/R No. must be > or equal to Start U/R No. **   ";
          CALL      HITENTER
          GOTO      URNO0000
.
URNO9000  MOVE      TRUE,EXIT
.
URNO9999  RETURN
+
.**********************************************************************
.*                             PROC0000                               *
.*                  input the PROCedure code                          *
.**********************************************************************
PROC0000  MOVE      ONE,FLGCO
          MOVE      SP9,KSTCODE
          DISPLAY   *P27:5,*EL,"_________  To _________ ";
.
PROC5100  KEYIN     *P27:5,*V2LON,KSTCODE,*P27:5,*DV,KSTCODE;
          ENDSET    KSTCODE
          APPEND    SP9,KSTCODE
          RESET     KSTCODE
.
          MATCH     SP9,KSTCODE
          GOTO      PROC7000 IF EQUAL
.
          CMATCH    QUEST,KSTCODE
          GOTO      PROC5200 IF NOT EQUAL
          OPEN      WATPROA3,"watproaf"
          MOVE      ONE,DISPACT
          CALL      WATDSPRO
          CALL      GOPN0000
          CALL      DISP0000
          GOTO      PROC0000
.
PROC5200  MOVE      SP9,KTOCODE
          DISPLAY   *P41:5,UNDLN9;
          KEYIN     *P41:5,*V2LON,KTOCODE,*P41:5,*DV,KTOCODE;
          ENDSET    KTOCODE
          APPEND    SP9,KTOCODE
          RESET     KTOCODE
.
          MATCH     SP9,KTOCODE
          GOTO      PROC8000 IF EQUAL
.
          CMATCH    QUEST,KTOCODE
          GOTO      PROC5300 IF NOT EQUAL
          OPEN      WATPROA3,"watproaf"
          MOVE      ONE,DISPACT
          CALL      WATDSPRO
          CALL      GOPN0000
          CALL      DISP0000
          DISPLAY   *P27:5,*V2LON,KSTCODE;
          GOTO      PROC5200
.
PROC5300  MATCH     KSTCODE,KTOCODE
          GOTO      PROC9000 IF LESS
          MOVE      ZERO,FLAGCO
          GOTO      PROC9999
.
PROC7000  MOVE      FALSE,FLGCO
          MOVE      ZERO,FLAGCO
          DISPLAY   *P27:5,*EL;
          GOTO      PROC9999
.
PROC8000  DISPLAY   *P1:24,*EL,*B,*V2LON:
                    "** To ",WTCNTPDS," code is mandatory **    ";
          CALL      HITENTER
          GOTO      PROC5200
.
PROC9000  DISPLAY   *P1:24,*EL,*B:
                    "** End ",WTCNTPDS," code must be > or = start ":
                           WTCNTPDS," code **    ";
          CALL      HITENTER
          GOTO      PROC0000
.
PROC9999  RETURN
+
.**********************************************************************
.*                             TMNT0000                               *
.*                    input TreatMeNT status                          *
.**********************************************************************
TMNT0000  MOVE      SP20,STATUS
          MOVE      ONE,FLGST
          KEYIN     *P27:6,*EL,"_",*P27:6,*V2LON,ANS:
                    *P27:6,*DV,ANS;
          ENDSET    ANS
          APPEND    SP1,ANS
          RESET     ANS
.
          MATCH     SP1,ANS
          GOTO      TMNT8000 IF EQUAL
.
          CMATCH    QUEST,ANS
          GOTO      TMNT6100 IF NOT EQUAL
          CALL      WATDSSTA
          CALL      GOPN0000
          CALL      DISP0000
          GOTO      TMNT0000
.
TMNT6100  TYPE      ANS
          GOTO      TMNT9000 IF NOT EQUAL
          MOVE      ANS,KSTSTAT
          COMPARE   ZERO,KSTSTAT
          GOTO      TMNT9000 IF EQUAL            * no value keyed in
          COMPARE   SEVEN,KSTSTAT
          GOTO      TMNT9000 IF NOT LESS
          LOAD      STATUS,KSTSTAT,STAT1,STAT2,STAT3,STAT4,STAT5,STAT6
          DISPLAY   *P38:6,STATUS;
          MOVE      ZERO,FLAGST
          GOTO      TMNT9999
.
TMNT8000  MOVE      ZERO,FLGST
          MOVE      ONE,FLAGST
          GOTO      TMNT9999
.
TMNT9000  DISPLAY   *P1:24,*EL,*B,*V2LON:
                    "** Invalid ",WTCNTPDS," Status **    ";
          CALL      HITENTER
          GOTO      TMNT0000
.
TMNT9999  RETURN
+
.**********************************************************************
.*                             LDTE0000                               *
.*                    input date on LisT range                        *
.**********************************************************************
LDTE0000  MOVE      SP10,KSTDATE1
          MOVE      ONE,FLGD1
          UNPACK    KSTDATE1 INTO CDAY,CMON,CCENT,CYEAR
          MOVE      CCC,CCENT
          DISPLAY   *P27:7,*EL,"__/__/____ To __/__/____ ";
          MOVE      ZERO,CHIGHLT
          MOVE      TWENTY7,CCOL
          MOVE      SEVEN,CVERT
          CALL      KEYDATE
          MATCH     SP2,CDAY
          GOTO      LDTE6000 IF EQUAL
          PACK      KSTDATE1 WITH CCENT,CYEAR,CMON,CDAY
.
LDTE1000  MOVE      SP10,KTODATE1
          UNPACK    KTODATE1 INTO CDAY,CMON,CCENT,CYEAR
          MOVE      CCC,CCENT
          MOVE      "41",CCOL
          MOVE      SEVEN,CVERT
          CALL      KEYDATE
          MATCH     SP2,CDAY
          GOTO      LDTE7000 IF EQUAL
          PACK      KTODATE1 WITH CCENT,CYEAR,CMON,CDAY
.
          MATCH     KSTDATE1,KTODATE1
          GOTO      LDTE8000 IF LESS
          MOVE      ZERO,FLAGD1
          GOTO      LDTE9999
.
LDTE6000  MOVE      ZERO,FLGD1
          DISPLAY   *P27:7,*EL;
          MOVE      ZERO,FLAGD1
          GOTO      LDTE9999
.
LDTE7000  CALL      IVTD0000                   * invalid To date
          DISPLAY   *P41:7,*EL,"__/__/____";
          GOTO      LDTE1000
.
LDTE8000  CALL      IVDR0000                   * invalid date range
          GOTO      LDTE0000
.
LDTE9999  RETURN               
+
.**********************************************************************
.*                             IVDR0000                               *
.*                   InValid Date Range message                       *
.**********************************************************************
IVDR0000  DISPLAY   *P1:24,*EL,*B,*V2LON:
                    "** End Date must be greater than or = Start Date **    ";
          CALL      HITENTER
          RETURN
+
.**********************************************************************
.*                             IVTD0000                               *
.*                   InValid To Date message                          *
.**********************************************************************
IVTD0000  DISPLAY   *P1:24,*EL,*B,*V2LON,"** To Date is mandatory **    ";
          CALL      HITENTER
          RETURN
+
.**********************************************************************
.*                             RDTE0000                               *
.*                   input last Review DaTE range                     *
.**********************************************************************
RDTE0000  MOVE      SP10,KSTDATE2
          MOVE      ONE,FLGD2
          UNPACK    KSTDATE2 INTO CDAY,CMON,CCENT,CYEAR
          MOVE      CCC,CCENT
          DISPLAY   *P27:8,*EL,"__/__/____ To __/__/____ ";
          MOVE      ZERO,CHIGHLT
          MOVE      TWENTY7,CCOL
          MOVE      EIGHT,CVERT
          CALL      KEYDATE
          MATCH     SP2,CDAY
          GOTO      RDTE6000 IF EQUAL
          PACK      KSTDATE2 WITH CCENT,CYEAR,CMON,CDAY
.
RDTE1000  MOVE      SP10,KTODATE2
          UNPACK    KTODATE2 INTO CDAY,CMON,CCENT,CYEAR
          MOVE      CCC,CCENT
          MOVE      "41",CCOL
          MOVE      EIGHT,CVERT
          CALL      KEYDATE
          MATCH     SP2,CDAY
          GOTO      RDTE7000 IF EQUAL
          PACK      KTODATE2 WITH CCENT,CYEAR,CMON,CDAY
.
          MATCH     KSTDATE2,KTODATE2
          GOTO      RDTE8000 IF LESS
          MOVE      ZERO,FLAGD2
          GOTO      RDTE9999
.
RDTE6000  MOVE      ZERO,FLGD2
          MOVE      ZERO,FLAGD2
          DISPLAY   *P27:8,*EL;
          GOTO      RDTE9999
.
RDTE7000  CALL      IVTD0000                   * invalid To Date
          DISPLAY   *P41:8,*EL,"__/__/____";
          GOTO      RDTE1000
.
RDTE8000  CALL      IVDR0000                   * invalid date range
          GOTO      RDTE0000
.
RDTE9999  RETURN               
+
.**********************************************************************
.*                               ADTE0000                             *
.*                   input scheduled Admission DaTE                   *
.**********************************************************************
ADTE0000  MOVE      SP10,KSTDATE3
          MOVE      ONE,FLGD3
          UNPACK    KSTDATE3 INTO CDAY,CMON,CCENT,CYEAR
          MOVE      CCC,CCENT
          DISPLAY   *P27:9,*EL,"__/__/____ To __/__/____ ";
          MOVE      ZERO,CHIGHLT
          MOVE      TWENTY7,CCOL
          MOVE      NINE,CVERT
          CALL      KEYDATE
          MATCH     SP2,CDAY
          GOTO      ADTE6000 IF EQUAL
          PACK      KSTDATE3 WITH CCENT,CYEAR,CMON,CDAY
.
ADTE1000  MOVE      SP10,KTODATE3
          UNPACK    KTODATE3 INTO CDAY,CMON,CCENT,CYEAR
          MOVE      CCC,CCENT
          MOVE      "41",CCOL
          MOVE      NINE,CVERT
          CALL      KEYDATE
          MATCH     SP2,CDAY
          GOTO      ADTE7000 IF EQUAL
          PACK      KTODATE3 WITH CCENT,CYEAR,CMON,CDAY
.
          MATCH     KSTDATE3,KTODATE3
          GOTO      ADTE8000 IF LESS
          MOVE      ZERO,FLAGD3
          GOTO      ADTE9999
.
ADTE6000  MOVE      ZERO,FLGD3
          MOVE      ZERO,FLAGD3
          DISPLAY   *P27:9,*EL;
          GOTO      ADTE9999
.
ADTE7000  CALL      IVTD0000                   * invalid To date
          DISPLAY   *P41:9,*EL,"__/__/____";
          GOTO      ADTE1000
.
ADTE8000  CALL      IVDR0000                   * invalid date range
          GOTO      ADTE0000
.
ADTE9999  RETURN               
+
.**********************************************************************
.*                          UNIT0000                                  *
.*                   input UNIT range                                 *
.**********************************************************************
UNIT0000  MOVE      ONE,FLGUN
          DISPLAY   *P27:10,*EL,"___        To ___        ";
.
UNIT1100  KEYIN     *P27:10,*V2LON,KSTUNIT,*P27:10,*DV,KSTUNIT;
          ENDSET    KSTUNIT
          APPEND    SP3,KSTUNIT
          RESET     KSTUNIT
.
          MATCH     SP3,KSTUNIT
          GOTO      UNIT6000 IF EQUAL
.
          CMATCH    QUEST,KSTUNIT
          GOTO      UNIT1200 IF NOT EQUAL
          MOVE      CODEWU,CODE
          CALL      PATCODDS
          CALL      GOPN0000
          CALL      DISP0000
          GOTO      UNIT0000
.
UNIT1200  DISPLAY   *P41:10,UNDLN3;
          KEYIN     *P41:10,*V2LON,KTOUNIT,*P41:10,*DV,KTOUNIT;
          ENDSET    KTOUNIT
          APPEND    SP3,KTOUNIT
          RESET     KTOUNIT
.
          MATCH     SP3,KTOUNIT
          GOTO      UNIT8000 IF EQUAL
.
          CMATCH    QUEST,KTOUNIT
          GOTO      UNIT1300 IF NOT EQUAL
          MOVE      CODEWU,CODE
          CALL      PATCODDS
          CALL      GOPN0000
          CALL      DISP0000
          DISPLAY   *P27:10,*V2LON,KSTUNIT;
          GOTO      UNIT1200
.
UNIT1300  MATCH     KSTUNIT,KTOUNIT
          GOTO      UNIT9000 IF LESS
          MOVE      ZERO,FLAGUN
          GOTO      UNIT9999
.
UNIT6000  MOVE      ZERO,FLGUN
          MOVE      ZERO,FLAGUN
          DISPLAY   *P27:10,*EL;
          GOTO      UNIT9999
.
UNIT8000  DISPLAY   *P1:24,*EL,*B,*V2LON,"** To Unit is mandatory **    ";
          CALL      HITENTER
          GOTO      UNIT1200
.
UNIT9000  DISPLAY   *P1:24,*EL,*B,*V2LON:
                    "** To Unit must be greater than or equal Start Unit **  ";
          CALL      HITENTER
          GOTO      UNIT1200
.
UNIT9999  RETURN
+
.**********************************************************************
.*                             DOCT0000                               *
.*                        input DOCTor range                          *
.**********************************************************************
DOCT0000  MOVE      ONE,FLGDO
          DISPLAY   *P27:11,*EL,"______     To ______     "
.
          MOVE      SP10,KSTDOC
          MOVE      "27",ECOL
          MOVE      "11",EVERT
          MOVE      ZERO,CKYIMAND
          MOVE      SP6,CKYIDEF6
          CALL      PATDOCKY
          BRANCH    EXIT,DOCT6000,DOCT0000
.
          MOVE      DCODE,KSTDOC
.
DOCT2200  DISPLAY   *P41:11,UNDLN6
.
          MOVE      SP10,KTODOC
          MOVE      "41",ECOL
          MOVE      "11",EVERT
          MOVE      ZERO,CKYIMAND
          MOVE      SP6,CKYIDEF6
          CALL      PATDOCKY
          BRANCH    EXIT,DOCT8000,DOCT2200
.
          MOVE      DCODE,KTODOC
.
DOCT2300  MATCH     KSTDOC,KTODOC
          GOTO      DOCT9000 IF LESS
          MOVE      ZERO,FLAGDO
          GOTO      DOCT9999
.
DOCT6000  MOVE      ZERO,FLGDO
          MOVE      ZERO,FLAGDO
          DISPLAY   *P27:11,*EL;
          GOTO      DOCT9999
.
DOCT8000  DISPLAY   *P1:24,*EL,*B,*V2LON,"** To Doctor is mandatory **    ";
          CALL      HITENTER
          GOTO      DOCT2200
.
DOCT9000  DISPLAY   *P1:24,*EL,*B,*V2LON:
                    "** To Doctor must be greater than or = Start Doctor **  ";
          CALL      HITENTER
          GOTO      DOCT0000
.
DOCT9999  RETURN
+
.**********************************************************************
.*                                STAY0000                            *
.*                       input estimated STAY range                   *
.**********************************************************************
STAY0000  MOVE      ONE,FLGES
          DISPLAY   *P27:12,*EL,"_____      To _____ ";
.
          MOVE      ZERO,KSTSTAY
          KEYIN     *P27:12,*V2LON,*RV,KSTSTAY,*P27:12,*DV,KSTSTAY;
.
          MOVE      "99999",KTOSTAY
          KEYIN     *P41:12,*V2LON,*RV,KTOSTAY,*P41:12,*DV,KTOSTAY;
.
          COMPARE   KSTSTAY,KTOSTAY
          IF        !@LESS
            MOVE      ZERO,FLAGES
            GOTO      STAY9999 
          ENDIF
.
          DISPLAY   *P1:24,*EL,*B:
                    "** To E/Stay must be greater than or = Start E/Stay **  ";
          CALL      HITENTER
          GOTO      STAY0000
.
STAY9999  RETURN
+
.**********************************************************************
.*                               PRTY0000                             *
.*                            keyin PRioriTY                          *
.**********************************************************************
PRTY0000  MOVE      ONE,FLGPT
.
PRTY4100  KEYIN     *P27:13,*EL,*DV,UNDLN3,*P27:13,*V2LON,KSTPTY:
                    *P27:13,*DV,KSTPTY;
          ENDSET    KSTPTY
          APPEND    SP3,KSTPTY
          RESET     KSTPTY
.
          MATCH     SP3,KSTPTY
          GOTO      PRTY8000 IF EQUAL
.
          CMATCH    QUEST,KSTPTY
          GOTO      PRTY4200 IF NOT EQUAL
          MOVE      CODETP,CODE
          CALL      PATCODDS
          CALL      GOPN0000
          CALL      DISP0000
          GOTO      PRTY0000
.
PRTY4200  PACK      KEY5,CODETP,KSTPTY
          CALL      RDCODE1
          BRANCH    OVRCD,PRTY9000
          MOVE      TDESC,DESCTP
          DISPLAY   *P38:13,*EL,DESCTP;
          MOVE      ZERO,FLAGPT
          GOTO      PRTY9999
.
PRTY8000  MOVE      ZERO,FLGPT
          DISPLAY   *P27:13,*EL;
          MOVE      ZERO,FLAGPT
          GOTO      PRTY9999
.
PRTY9000  DISPLAY   *P1:24,*EL,*B,*V2LON,"** Invalid Priority **    ";
          CALL      HITENTER
          GOTO      PRTY4100
.
PRTY9999  RETURN                
+
.**********************************************************************
.*                              SHRT0000                              *
.*                        Input short notice                          *
.**********************************************************************
SHRT0000  MOVE      ONE,FLGSN
.
SHRT5100  KEYIN     *P27:14,*EL,*DV,UNDLN3,*P27:14,*V2LON,KSTNOT:
                    *P27:14,*DV,KSTNOT;
          ENDSET    KSTNOT
          APPEND    SP3,KSTNOT
          RESET     KSTNOT
.
          MATCH     SP3,KSTNOT
          GOTO      SHRT8000 IF EQUAL
.
          CMATCH    QUEST,KSTNOT
          GOTO      SHRT5200 IF NOT EQUAL
          MOVE      CODEWS,CODE
          CALL      PATCODDS
          CALL      GOPN0000
          CALL      DISP0000
          GOTO      SHRT0000
.
SHRT5200  PACK      KEY5,CODEWS,KSTNOT
          CALL      RDCODE1
          BRANCH    OVRCD,SHRT9000
          MOVE      TDESC,DESCNOT
          DISPLAY   *P38:14,*EL,DESCNOT;
          MOVE      ZERO,FLAGSN
          GOTO      SHRT9999
.
SHRT8000  MOVE      ZERO,FLGSN
          DISPLAY   *P27:14,*EL;
          MOVE      ZERO,FLAGSN
          GOTO      SHRT9999
.
SHRT9000  DISPLAY   *P1:24,*EL,*B,*V2LON,"** Invalid Short Notice **    ";
          CALL      HITENTER
          GOTO      SHRT5100
.
SHRT9999  RETURN
+
.**********************************************************************
.*                                  CATG0000                          *
.*                             input Department                       *
.**********************************************************************
CATG0000  MOVE      ONE,FLGPC
.
CATG6100  KEYIN     *P27:15,*EL,*DV,UNDLN3,*P27:15,*V2LON,KSTPCAT:
                    *P27:15,*DV,KSTPCAT;
          ENDSET    KSTPCAT
          APPEND    SP3,KSTPCAT
          RESET     KSTPCAT
.
          MATCH     SP3,KSTPCAT
          GOTO      CATG8000 IF EQUAL
.
          CMATCH    QUEST,KSTPCAT
          GOTO      CATG6200 IF NOT EQUAL
          MOVE      CODEA,CODE
          CALL      PATCODDS
          CALL      GOPN0000
          CALL      DISP0000
          GOTO      CATG0000
.
CATG6200  PACK      KEY5,CODEA,KSTPCAT
          CALL      RDCODE1
          BRANCH    OVRCD TO CATG9000
          MOVE      TDESC,DESCCAT
          DISPLAY   *P38:15,*EL,DESCCAT;
          GOTO      CATG9999
.
CATG8000  MOVE      ZERO,FLGPC
          DISPLAY   *P27:15,*EL;
          GOTO      CATG9999
.
CATG9000  DISPLAY   *P1:24,*EL,*B,*V2LON,"** Invalid ",*+,CATADES," **    ";
          CALL      HITENTER
          GOTO      CATG6100
.
CATG9999  RETURN 
+
.**********************************************************************
.*                              STAT0000                              *
.*                      Keyin resident status                         *
.**********************************************************************
STAT0000  MOVE      ONE,FLGRS
.
STAT7100  KEYIN     *P27:16,*EL,*DV,UNDLN3,*P27:16,*V2LON,KSTRESS:
                    *P27:16,*DV,KSTRESS;
          ENDSET    KSTRESS
          APPEND    SP3,KSTRESS
          RESET     KSTRESS
.
          MATCH     SP3,KSTRESS
          GOTO      STAT8000 IF EQUAL
.
          CMATCH    QUEST,KSTRESS
          GOTO      STAT7200 IF NOT EQUAL
          MOVE      CODERS,CODE
          CALL      PATCODDS
          CALL      GOPN0000
          CALL      DISP0000
          GOTO      STAT0000
.
STAT7200  PACK      KEY5,CODERS,KSTRESS
          CALL      RDCODE1
          BRANCH    OVRCD,STAT9000
          MOVE      TDESC,DESCRESS
          DISPLAY   *P38:16,*EL,DESCRESS;
          GOTO      STAT9999
.
STAT8000  MOVE      ZERO,FLGRS
          DISPLAY   *P27:16,*EL;
          GOTO      STAT9999
.
STAT9000  DISPLAY   *P1:24,*EL,*B,*V2LON,"** Invalid Resident Status **    ";
          CALL      HITENTER
          GOTO      STAT7100
.
STAT9999  RETURN
+
.**********************************************************************
.*                           EXTR0000                                 *
.*         EXTRacts the required information from various files       *
.*              for general letters                                   *
.**********************************************************************
EXTR0000  MOVE      FALSE,EXIT
          DISPLAY   *P1:24,*EL,*P8:24,"Searching";
          MOVE      ONE,COUNTER
          PREP      TEMP1,FNAMER            * sets up temporary file
          
.
.         If no U/R range input, then see if "Date on List" or 
.         "Procedure Status" have ranges and if so use the appropriate index
.
          PACK      KEY27,SP27
          READ      TEMPF2,KEY27;;
EXTR5000  READKS    TEMPF2;YYDATE1,YYURNO,YYCODE,YYMCNT
          GOTO      EXTR8000 IF OVER
.
          PACK      KEY27,YYDATE1,YYURNO,YYCODE,YYMCNT
          CALL      RDTREA3
          CALL      FRMT0000
          GOTO      EXTR5000
.
.------ all records have been found ------
.
EXTR8000  COMPARE   ONE,COUNTER
          GOTO      EXTR8500 IF EQUAL
          DISPLAY   *P1:24,*EL,*B,*V2LON:
                    "***  All records have been extracted  ***    ";
          CALL      HITENTER
          CLOSE     TEMP1
          OPEN      TEMP1,FNAMER     
          GOTO      EXTR9999
.
.------ no records found ------
.
EXTR8500  DISPLAY   *P1:24,*EL,*B,*V2LON:
                    "***  No records available for given parameters  ***    ";
          CALL      HITENTER
          CLOSE     TEMP1
          MOVE      TRUE,EXIT
.
EXTR9999  RETURN
+
.****************************************************************************
.*                                FRMT0000                                  *
.*                           FoRMaT the details                             *
.****************************************************************************
FRMT0000  MOVE      WMBOOK,BOOKNO
          MOVE      WMBOOK,BOOKDM8
          MOVE      BOOKDM8,KEY8
          MOVE      SP8,BKREPDAT          * pre-assesment date
          MOVE      SP8,BKREPTIM          * pre-assesment time
          MOVE      SP8,BKREATIM          * expected assesment time
          MOVE      SP8,BKREEDAT          * expected due date
          CALL      RDBKREC1              * read booking file
.
          UNPACK    WTWMDTAD,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000                        * Decision to admit date
          MOVE      DATELINE,DADATE
          MOVE      "99",CDAY
          UNPACK    WTWMGADD,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000                      * Guareented admission date
          MOVE      DATELINE,GADATE
          MOVE      "99",CDAY
          UNPACK    WTWMDABD,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000                       * Do not admit before date
          MOVE      DATELINE,DNABDATE
          MOVE      "99",CDAY
          UNPACK    CDATE,CDAY,DUMMY,CMON,DUMMY,CCENT,CYEAR
          CALL      FDAT0000                        * format todays date 
          MOVE      DATELINE,FDATE
          MOVE      "99",CDAY
          UNPACK    WMDATE1,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000                        * format date on list
          MOVE      DATELINE,LDATE
          MOVE      "99",CDAY
          UNPACK    WMDATE2,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000                       * format last review date
          MOVE      DATELINE,LRDATE
          MOVE      "99",CDAY
          UNPACK    BKREEDAT,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000                      * format expected due date
          MOVE      DATELINE,XXDATE
          MOVE      "99",CDAY
          UNPACK    BKREPDAT,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000                    * format pre-assessment date
          MOVE      DATELINE,PDATE
          MOVE      "99",HOUR
          UNPACK    BKREPTIM,HOUR,DUMMY,MINUTE,DUMMY,DIM2
          CALL      FTIM0000                    * format pre-assessment time
          MOVE      TIMELINE,PTIME
          MOVE      "99",HOUR
          UNPACK    BKREATIM,HOUR,DUMMY,MINUTE,DUMMY,DIM2
          CALL      FTIM0000                    * format expected due time
          MOVE      TIMELINE,XTIME
          MOVE      WMURNO,PURNO
          MOVE      WMURNO,URDIM
          MOVE      PURNO,KEY8
          CALL      RDMAST1                         * read master file
          CALL      RDPMPX21
          CALL      FNAM0000                        * format patients name
          MOVE      NAMELINE,FULLNAME
.
          PACK      KEY8,BOOKNO,SP70
          CALL      RDPTVIS1
          IF        OVRCD = 1
            CALL      CLPATVIS
          ENDIF
.
          PACK      KEY8,BOOKNO,SP70
          CALL      RDPMVX11
          IF        OVRCD = 1
            CALL      CLPMSVX1
          ENDIF
.
          PACK      KEY8,BOOKNO,SP70
          CALL      RDPTMIS1
          IF        OVRCD = 1
            CALL      CLPATMIS
          ENDIF
.
          PACK      KEY10,WMDOCTOR,SP70
          CALL      FDOC0000                        * format doctors name
          MOVE      DOCLINE,DOCTNAM
.
          MOVE      SP70,LXWRWLCC
          MOVE      SP70,LXWTWLA1
          MOVE      SP70,LXWTWLA2
          MOVE      SP70,LXWTWLA3
          MOVE      SP70,LXWTWLA4
          MOVE      SP70,LXWTWLPT
          MOVE      SP70,LXWTWLST
.
          PACK      KEY10,WMDOCTOR,SP70
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCHCPC,LXWRWLCC               * doctor code
            MOVE      PMHCSEML,LXWLCHEM
.
            MOVE      PMHCADR1,LXWTWLA1
            MOVE      PMHCADR2,LXWTWLA2
            MOVE      PMHCADR3,LXWTWLA3
            MOVE      PMHCADR4,LXWTWLA4
            MOVE      PMHCPOST,LXWTWLPT
            MOVE      PMHCSTAT,LXWTWLST
          ENDIF
.
          PACK      KEY6,WMDOCTOR,SP70
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      PTDOSEML,LXWLCDEM
          ENDIF    
.
          MOVE      SP70,LXWRWLCP
          PACK      KEY9,WMDOCTOR,WMUNIT,SP70
          CALL      RDWTVWL1
          IF        OVRCD=0
            MOVE      WTVWTELE,LXWRWLCP               * Consultant Surgery Tel
          ENDIF
.
          MOVE      WMPCAT,WORKDEPT                 * department
          MOVE      WTWMEATY,ELECATYP
.
. get referred doctor's address
.
          MOVE      SP30,RFDADD1
          MOVE      SP30,RFDADD2
.
          MATCH     ZEROVISN,BKREBOOK
          GOTO      FRMT1000 IF EQUAL
.
          MATCH     SP6,BKRESDOC
          GOTO      FRMT1000 IF EQUAL
.
          MOVE      BKRESDOC,KEY6
          CALL      RDDOCT1
          BRANCH    OVRCD,FRMT1000
          MOVE      DTITL,RFDTITL
          MOVE      DSADD1,RFDADD1
          MOVE      DSADD2,RFDADD2
          MOVE      DSADD3,RFDADD3
          MOVE      DSADD4,RFDADD4
.
.
.------ write formatted variables to temporary file ------
.
FRMT1000  WRITE     TEMP1,SEQ;BOOKNO,URDIM,FDATE,DOCTNAM,XXDATE,FULLNAME:
                              XTIME,LDATE,PDATE,PTIME,LRDATE,WORKDEPT,RFDADD1:
                              RFDADD2,WMCODE,WMUNIT,DADATE,GADATE,DNABDATE:
                              NAFDATE,NATDATE,ELECATYP,WMCNT,WMPTY,WMUDEF5:
                              WMUDEF6,WMUDEF7,WMUDEF8,WTWMRANK
.
          MOVE      PSNAME,NAMEDIS
          DISPLAY   *P27:24,*EL,"Found ",*V2LON,NAMEDIS;
          ADD       ONE,COUNTER
.
FRMT9999  RETURN
+
.**********************************************************************
.*                           FTIM0000                                 *
.*                   routine to Format the TIMe                       *
.**********************************************************************
FTIM0000  CLEAR     TIMELINE
          MATCH     "99",HOUR
          GOTO      FTIM7000 IF EQUAL
          MATCH     SP2,HOUR
          GOTO      FTIM7000 IF EQUAL
          MOVE      HOUR,TEMPHOUR
          SUBTRACT  TEN2,TEMPHOUR
          GOTO      FTIM1000 IF LESS
          GOTO      FTIM2000 IF EQUAL
          COMPARE   TEN2,TEMPHOUR
          GOTO      FTIM0050 IF NOT EQUAL
          MOVE      TEMPHOUR,TEMPHOUR2
          MOVE      TEMPHOUR2,HOUR
          GOTO      FTIM1100
.
FTIM0050  MOVE      TEMPHOUR,TEMPHOUR2
          MOVE      TEMPHOUR2,HOUR
          RESET     HOUR
          CMATCH    "0",HOUR
          GOTO      FTIM0100 IF NOT EQUAL
          BUMP      HOUR
.
FTIM0100  PACK      TIMELINE,HOUR,COLON,MINUTE,SP1
          ENDSET    TIMELINE
          APPEND    "pm",TIMELINE
          RESET     TIMELINE
          MOVE      TIMELINE,LINE
          CALL      COMP0000
          MOVE      LINE,TIMELINE
          GOTO      FTIM9999
.
FTIM1000  ADD       TEN2,TEMPHOUR
          GOTO      FTIM1050 IF NOT EQUAL
          MOVE      TEN2,HOUR
          GOTO      FTIM1100
.
FTIM1050  MOVE      TEMPHOUR,TEMPHOUR2
          MOVE      TEMPHOUR2,HOUR
          RESET     HOUR
          CMATCH    "0",HOUR
          GOTO      FTIM1100 IF NOT EQUAL
          BUMP      HOUR
.
FTIM1100  PACK      TIMELINE,HOUR,COLON,MINUTE,SP1
          ENDSET    TIMELINE
          APPEND    "am",TIMELINE
          RESET     TIMELINE
          MOVE      TIMELINE,LINE
          CALL      COMP0000
          MOVE      LINE,TIMELINE
          GOTO      FTIM9999
.
FTIM2000  MOVE      TEN2,HOUR
          GOTO      FTIM0100
.
FTIM7000  MOVE      "        ",TIMELINE
.         MOVE      "99:99 pm",TIMELINE
          GOTO      FTIM9999
.
FTIM9999  RETURN
+            
.**********************************************************************
.*                           FDAT0000                                 *
.*                  routine to Format the DATe                        *
.**********************************************************************
FDAT0000  CLEAR     DATELINE
          MATCH     SP2,CDAY
          GOTO      FDAT2000 IF EQUAL
          MATCH     "99",CDAY
          GOTO      FDAT2000 IF EQUAL
          MOVE      CDAY,FORM2
.
.------ add date extension onto the day ------
.
          LOAD      DEXT,FORM2,DEXT1,DEXT2,DEXT3,DEXT4,DEXT4,DEXT4,DEXT4:
                               DEXT4,DEXT4,DEXT4,DEXT4,DEXT4,DEXT4,DEXT4:
                               DEXT4,DEXT4,DEXT4,DEXT4,DEXT4,DEXT4,DEXT1:
                               DEXT2,DEXT3,DEXT4,DEXT4,DEXT4,DEXT4,DEXT4:
                               DEXT4,DEXT4,DEXT1
          MOVE      CMON,FORM2
.
.------ change month into long format ------
.
          LOAD      MONTH,FORM2,MONTH1,MONTH2,MONTH3,MONTH4,MONTH5,MONTH6:
                                MONTH7,MONTH8,MONTH9,MONTH10,MONTH11,MONTH12
          RESET     CDAY
          CMATCH    "0",CDAY
          GOTO      FDAT1000 IF NOT EQUAL
          BUMP      CDAY
.
.------ pack the formatted date ------
.
FDAT1000  PACK      DATELINE,CDAY,DEXT,SP1,MONTH,SP1,CCENT,CYEAR
          MOVE      DATELINE,LINE
          CALL      COMP0000
          MOVE      LINE,DATELINE
          GOTO      FDAT9999
.
.------ date does not exist ------
.
FDAT2000  MOVE      "                  ",DATELINE
.         MOVE      "99th December 1999",DATELINE
          GOTO      FDAT9999
.
FDAT9999  RETURN
+
.**********************************************************************
.*                              FDOC0000                              *
.*                   routine to Format DOCtor's name                  *
.**********************************************************************
FDOC0000  CLEAR     DOCLINE
          CALL      RDPMHCP1                        * read doctor file
          BRANCH    OVRCD,FDOC7000
          CLEAR     INITIAL
          APPEND    SP1,INITIAL
          MOVE      PMHCGNAM,ANS
          APPEND    ANS,INITIAL
          APPEND    ". ",INITIAL
          RESET     INITIAL
          PACK      DOCLINE,PMHCTITL,INITIAL,PMHCSNAM   * pack formatted doctors
          MOVE      DOCLINE,LINE                   *   name
          CALL      COMP0000                       * compress blanks  
          CALL      CASE0000                       * convert to lower case
          MOVE      LINE,DOCLINE
          GOTO      FDOC9999
.
.------ doctors name does not exist ------
.                                           * SRF 16160 Code Changed
.FDOC7000  MOVE      "*********************************",DOCLINE
FDOC7000  MOVE      "                                 ",DOCLINE
          GOTO      FDOC9999
.
FDOC9999  RETURN
+
.**********************************************************************
.*                           FNAM0000                                 *
.*                routine to Format patient's NAMe                    *
.**********************************************************************
FNAM0000  CLEAR     NAMELINE
          RESET     PTITL
          MATCH     SP4,PTITL               * test title for spaces
          GOTO      FNAM2000 IF EQUAL
.
FNAM0500  CMATCH    SP1,PTITL
          GOTO      FNAM1000 IF EQUAL
          MOVE      PTITL,ANS               * append title to nameline
          APPEND    ANS,NAMELINE
          BUMP      PTITL
          GOTO      FNAM1000 IF EOS
          GOTO      FNAM0500
.
FNAM1000  APPEND    DOT,NAMELINE
          APPEND    SP1,NAMELINE
          MATCH     SP20,PGNAME             * test given name for spaces
          GOTO      FNAM1700 IF EQUAL
.
FNAM1500  APPEND    PGNAME,NAMELINE         * append given name to nameline
          APPEND    SP1,NAMELINE
.
FNAM1700  APPEND    PSNAME,NAMELINE
          RESET     NAMELINE
          MOVE      NAMELINE,LINE           * append surname to name line
          CALL      COMP0000                * compress blanks
          CALL      CASE0000                * convert to lower case
          MOVE      LINE,NAMELINE
          GOTO      FNAM9999
.
FNAM2000  MATCH     SP20,PGNAME             * test given name for spaces
          GOTO      FNAM1500 IF NOT EQUAL
          GOTO      FNAM1700
.
FNAM9999  RETURN
+
.**********************************************************************
.*                              COMP0000                              *
.*            routine to COMPress excessive blanks in LINE            *
.**********************************************************************
COMP0000  MOVE      LINE,DIM55
          PACK      TEMP55,SP20,SP20,SP10,SP5
          MATCH     TEMP55,DIM55                 * test line for spaces
          GOTO      COMP9999 IF EQUAL
          CLEAR     LINE
.
COMP1000  CMATCH    SP1,DIM55
          GOTO      COMP5000 IF NOT EQUAL        * compress leading blanks
          BUMP      DIM55 
          GOTO      COMP1000 IF NOT EOS
          GOTO      COMP8000
.
COMP5000  MOVE      DIM55,TEMP55
          MOVE      TEMP55,DIM55
          ENDSET    DIM55
.
COMP5100  CMATCH    SP1,DIM55
          GOTO      COMP7000 IF NOT EQUAL   * compress trailing blanks
          BUMP      DIM55,-1
          GOTO      COMP5100
.
COMP7000  LENSET    DIM55
          RESET     DIM55
.
COMP7100  MOVE      DIM55,ANS
          APPEND    ANS,LINE
          BUMP      DIM55                   * compress multiple blanks
          GOTO      COMP8000 IF EOS         *   from in-between words
          CMATCH    SP1,DIM55                   
          GOTO      COMP7100 IF NOT EQUAL
          MOVE      DIM55,ANS
          APPEND    ANS,LINE
.   
COMP7200  BUMP      DIM55
          CMATCH    SP1,DIM55
          GOTO      COMP7100 IF NOT EQUAL
          GOTO      COMP7200
.
COMP8000  RESET     LINE
          GOTO      COMP9999
.
COMP9999  RETURN
+
.**********************************************************************
.*                             CASE0000                               *
.*  routine to convert all except first character of each word to     *
.*        lower CASE                                                  *
.**********************************************************************
CASE0000  MOVE      ONE,FIRSTCH
          RESET     LINE
.
CASE1000  CMATCH    SP1,LINE
          GOTO      CASE5000 IF EQUAL       * match char to space
          BRANCH    FIRSTCH,CASE2000
          MOVE      LINE,ANS
          RESET     UPPLOW
          SCAN      ANS,UPPLOW              * test to see if char is a letter
          GOTO      CASE1100 IF EQUAL
          MOVE      ONE,FIRSTCH
          GOTO      CASE3000                * any char but a letter found
.
CASE1100  RESET     UPPLOW
          OR        040,LINE                * actual conversion to lower case
.
CASE2000  MOVE      ZERO,FIRSTCH            * not on first char. any more
.
CASE3000  BUMP      LINE
          GOTO      CASE1000 IF NOT EOS     * move to next character
          RESET     LINE                    * end of line reached
          GOTO      CASE9999
.
CASE5000  MOVE      ONE,FIRSTCH             * first character was a space
          GOTO      CASE3000
.
CASE9999  RETURN
+
.**********************************************************************
.*                              LSEL0000                              *
.*                   SeLect general letter to print                   *
.**********************************************************************
LSEL0000  MOVE      FALSE,EXIT
          MOVE      ZERO,COUNTER
          DISPLAY   *P1:4,*EF:
                    *P1:5,"Select Letter to print : ";
          MOVE      SP3,LETTER
          DISPLAY   *P26:5,UNDLN3;
          KEYIN     *P26:5,*V2LON,*RV,LETTER; * enter letter code
          DISPLAY   *P26:5,*V2LON,LETTER;
          MATCH     SP3,LETTER              * Check for spaces
          GOTO      LSEL7000 IF EQUAL
          MATCH     "0",LETTER              * check for zero
          GOTO      LSEL7000 IF EQUAL 
          MATCH     QUEST,LETTER            * Check for a "?"
          GOTO      LSEL1000 IF NOT EQUAL
          GOTO      LSEL5000                * Display LETTER fields
.
.------ LETTER field entered ------
.
LSEL1000  MOVE      LETTER,LETTFORM
          MOVE      ZERO,FORM3
          PACK      KEY6,LETTFORM,FORM3     * Validate letter is on the
          CALL      RDLET1                  * letter file   
          COMPARE   ONE,OVRCD
          GOTO      LSEL1200 IF NOT EQUAL
.
.------ letter not on file ------
.
          DISPLAY   *P1:24,*EL,*B,*V2LON,"** LETTER code not on file **    ";
          CALL      HITENTER
          GOTO      LSEL0000                * return if not found
.
LSEL1200  MOVE      WLTEXT,LETDESC
          DISPLAY   *P31:5,LETDESC;         * Display the description
          GOTO      LSEL9999
.
.------ ? has been entered for LETTER field ------
.
LSEL5000  MOVE      SP5,KEY6
          CALL      RDSLET2
.
.         Display Category Heading, and then loop over entries
.
          DISPLAY   *P1:4,*EF,*P30:4,*V2LON,*ULON,"EXISTING LETTERS";
          MOVE      FIVE,CVERT
          MOVE      ONE,CCOL
.
LSEL5100  CALL      RDKLET2
          BRANCH    OVRCD,LSEL5900
.
          COMPARE   ZERO,WLINNO
          GOTO      LSEL5400 IF NOT EQUAL
.
          MOVE      WLTEXT,DIM30
          DISPLAY   *PCCOL:CVERT,*V2LON,WLETNO,SP2,*HOFF,DIM30;
          ADD       ONE,CVERT
          COMPARE   TWENTY3,CVERT
          GOTO      LSEL5100 IF LESS
.
          MOVE      FIVE,CVERT
          ADD       "40",CCOL
          COMPARE   "70",CCOL
          GOTO      LSEL5100 IF LESS
.
          KEYIN     *P1:24,*EL," (",*V2LON,"E",*HOFF,")xit, (":
                    *V2LON,"N",*HOFF,")ext Screen : ",*V2LON,ANS;
.
          MATCH     ANSE,ANS
          GOTO      LSEL0000 IF EQUAL
.
          MOVE      FIVE,CVERT
          MOVE      ONE,CCOL
          DISPLAY   *P1:5,*EF;
.
.         End of Codes
.
LSEL5400  DISPLAY   *P1:24,*EL;
          CALL      HITENTER
          GOTO      LSEL0000
.
LSEL5900  DISPLAY   *P1:24,*EL,*B,*V2LON:
                    "***  No letters entered in Letters file  ***    ";
          CALL      HITENTER
          GOTO      LSEL0000
.
.------ zero entered for letter code, used as an exit char ------
.
LSEL7000  DISPLAY   *P1:24,"Are you sure you want to exit (",*V2LON,"Y":   
                           *HOFF,"/",*V2LON,"N",*HOFF,") ?";
          KEYIN     *P39:24,*EL,*DV,UNDLN1,*P39:24,*V2LON,ANS;
          TYPE      ANS
          GOTO      LSEL7300 IF EQUAL
          REP       UPPLOW,ANS
          REPLACE   "Y1N0",ANS
          TYPE      ANS
          GOTO      LSEL7500 IF EQUAL       * valid option
.
LSEL7300  BEEP
          GOTO      LSEL7000
.
LSEL7500  MOVE      ANS,OPTION
          BRANCH    OPTION,LSEL8000
          GOTO      LSEL0000                * re-enter letter code
.
.------ user wants to exit, branch back to main menu ------
.
LSEL8000  NORETURN
          GOTO      ML0200
.
LSEL9999  RETURN
+
.**********************************************************************
.*                              SET0000                               *
.*             SET up the values for all the "%" variables            *
.**********************************************************************
.
.------ read the temporary file ------
.
SET0000   READ      TEMP1,SEQ;BOOKNO,URDIM,FDATE,DOCTNAM,XXDATE,FULLNAME:
                              XTIME,LDATE,PDATE,PTIME,LRDATE,WORKDEPT,RFDADD1:
                              RFDADD2,WMCODE,WMUNIT,DADATE,GADATE,DNABDATE:
                              NAFDATE,NATDATE,ELECATYP,WMCNT,WMPTY,WMUDEF5:
                              WMUDEF6,WMUDEF7,WMUDEF8,WTWMRANK
          GOTO      SET9000 IF OVER
.
          CALL      CLRV0000                             * initialise var's
          DISPLAY   *P60:24,*EL,*V2LON,COUNTER,*HOFF," Printed";
          MOVE      FALSE,EXIT
.
.------ read files to get values of other % variables ------
.------ not already formatted -------
.
          ADD       ONE,COUNTER
          MOVE      FALSE,EXIT
          MOVE      SP3,BKREWARD
          MOVE      BOOKNO,BOOKDM8
          MOVE      BOOKDM8,KEY8
          CALL      RDBKREC1
          IF        OVRCD = 1
            CALL    CLBOKREC
          ELSE
            MOVE      WMBOOK,KEY8
            CALL      RDBKRX11
            IF        OVRCD = 1
              CALL      CLBKRX00
            ENDIF
          ENDIF
.
          CALL      SHSP0000             * set up hospital details
          CALL      RCLI0000             * Set referring clinician fields
.
          PACK      KEY5,CODEBK,BKRETYPE * booking type
          CALL      RDCODE1
          BRANCH    OVRCD,SET0010
          MOVE      TDESC,BTYPE
.
SET0010   PACK      KEY5,CODEBP,BKREACCM * preferred accomadation
          CALL      RDCODE1
          BRANCH    OVRCD,SET0015
          MOVE      TDESC,PACCOM
.
SET0015   MOVE      WMCODE,KEY9
          CALL      RDPROA1
          BRANCH    OVRCD,SET0020
          MOVE      WPDESC,PDESC
.
SET0020   PACK      KEY5,CODEWU,WMUNIT
          CALL      RDCODE1
          BRANCH    OVRCD,SET0021
          MOVE      TDESC,REFUNIT
.
SET0021   PACK      KEY5,CODETP,WMPTY
          CALL      RDCODE1
          BRANCH    OVRCD,SET0022
          MOVE      TDESC,REFPRTY
.
SET0022   MATCH     SP3,WORKDEPT
          GOTO      SET0025 IF EQUAL
          PACK      KEY5,CODEA,WORKDEPT
          CALL      RDCODE1
          BRANCH    OVRCD,SET0025
          MOVE      TDESC,DESCCAT
.
SET0025   MOVE      URDIM,PURNO
          MOVE      PURNO,KEY8
          CALL      RDMAST1
          CALL      RDPMPX21
.>>>>
          MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "9",CONTTYPE          * OTH Contact
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCESNAM,PACSNAME
            MOVE      PMCEGNAM,PACGNAME
            MOVE      PMCETITL,PACTITLE
            MOVE      "1",PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,LXOCNAME     * Other Contact Details
            MOVE      PMCETITL,LXOCTITL     
            MOVE      PMCESNAM,LXOCSNAM
            MOVE      PMCEGNAM,LXOCGNAM
            MOVE      PMCEGNM2,LXOCGNM2
            MOVE      PMCEADD1,LXOCADD1
            MOVE      PMCEADD2,LXOCADD2
            MOVE      PMCEADD3,LXOCADD3
            MOVE      PMCEADD4,LXOCADD4
            MOVE      PMCEPOST,LXOCPOST
            MOVE      PMCETELP,LXOCTELP
            MOVE      PMCETELB,LXOCTELB
            MOVE      PMCETELM,LXOCTELM
            MOVE      PMCERELP,LXOCRELP
            MOVE      PMCEEMAI,LXOCEMAI
            MATCH     "1",PMCESLET
            IF        @EQUAL
              MOVE     DYES,LXOCSLET
            ELSE
              MOVE     DNO,LXOCSLET
            ENDIF
          ENDIF
.
          MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "1",CONTTYPE          * NOK2 Contact
            CALL      NOK20000              * Get extra contact details
            MOVE      PMCESNAM,PACSNAME
            MOVE      PMCEGNAM,PACGNAME
            MOVE      PMCETITL,PACTITLE
            MOVE      "1",PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,LXP2NAME     * NOK2 Contact Details
            MOVE      PMCETITL,LXP2TITL
            MOVE      PMCESNAM,LXP2SNAM
            MOVE      PMCEGNAM,LXP2GNAM
            MOVE      PMCEGNM2,LXP2GNM2
            MOVE      PMCEADD1,LXP2ADD1
            MOVE      PMCEADD2,LXP2ADD2
            MOVE      PMCEADD3,LXP2ADD3
            MOVE      PMCEADD4,LXP2ADD4
            MOVE      PMCEPOST,LXP2POST
            MOVE      PMCETELP,LXP2TELP
            MOVE      PMCETELB,LXP2TELB
            MOVE      PMCETELM,LXP2TELM
            MOVE      PMCERELP,LXP2RELP
            MOVE      PMCEEMAI,LXP2EMAI
            MATCH     "1",PMCESLET
            IF        @EQUAL
              MOVE     DYES,LXP2SLET
            ELSE
              MOVE     DNO,LXP2SLET
            ENDIF
          ENDIF
.
          MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "C",CONTTYPE          * CAR Contact
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCESNAM,PACSNAME
            MOVE      PMCEGNAM,PACGNAME
            MOVE      PMCETITL,PACTITLE
            MOVE      "1",PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,LXPCNAME     * Carer Contact Details
            MOVE      PMCETITL,LXPCTITL
            MOVE      PMCESNAM,LXPCSNAM
            MOVE      PMCEGNAM,LXPCGNAM
            MOVE      PMCEGNM2,LXPCGNM2
            MOVE      PMCEADD1,LXPCADD1
            MOVE      PMCEADD2,LXPCADD2
            MOVE      PMCEADD3,LXPCADD3
            MOVE      PMCEADD4,LXPCADD4
            MOVE      PMCEPOST,LXPCPOST
            MOVE      PMCETELP,LXPCTELP
            MOVE      PMCETELB,LXPCTELB
            MOVE      PMCETELM,LXPCTELM
            MOVE      PMCERELP,LXPCRELP
            MOVE      PMCEEMAI,LXPCEMAI
            MATCH     "1",PMCESLET
            IF        @EQUAL
              MOVE     DYES,LXPCSLET
            ELSE
              MOVE     DNO,LXPCSLET
            ENDIF
          ENDIF
.
          MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "3",CONTTYPE          * EMR Contact
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCESNAM,PACSNAME
            MOVE      PMCEGNAM,PACGNAME
            MOVE      PMCETITL,PACTITLE
            MOVE      "1",PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,LXECNAME     * Emergency Contact Details
            MOVE      PMCETITL,LXECTITL
            MOVE      PMCESNAM,LXECSNAM
            MOVE      PMCEGNAM,LXECGNAM
            MOVE      PMCEGNM2,LXECGNM2
            MOVE      PMCEADD1,LXECADD1
            MOVE      PMCEADD2,LXECADD2
            MOVE      PMCEADD3,LXECADD3
            MOVE      PMCEADD4,LXECADD4
            MOVE      PMCEPOST,LXECPOST
            MOVE      PMCETELP,LXECTELP
            MOVE      PMCETELB,LXECTELB
            MOVE      PMCETELM,LXECTELM
            MOVE      PMCERELP,LXECRELP
            MOVE      PMCEEMAI,LXECEMAI
            MATCH     "1",PMCESLET
            IF        @EQUAL
              MOVE     DYES,LXECSLET
            ELSE
              MOVE     DNO,LXECSLET
            ENDIF
          ENDIF
.
          MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "7",CONTTYPE          * Local Address Contact
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCESNAM,PACSNAME
            MOVE      PMCEGNAM,PACGNAME
            MOVE      PMCETITL,PACTITLE
            MOVE      "1",PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,LXPLNAME     * Local Address Contact Details
            MOVE      PMCETITL,LXPLTITL
            MOVE      PMCESNAM,LXPLSNAM
            MOVE      PMCEGNAM,LXPLGNAM
            MOVE      PMCEGNM2,LXPLGNM2
            MOVE      PMCEADD1,LXPLADD1
            MOVE      PMCEADD2,LXPLADD2
            MOVE      PMCEADD3,LXPLADD3
            MOVE      PMCEADD4,LXPLADD4
            MOVE      PMCEPOST,LXPLPOST
            MOVE      PMCETELP,LXPLTELP
            MOVE      PMCETELB,LXPLTELB
            MOVE      PMCETELM,LXPLTELM
            MOVE      PMCERELP,LXPLRELP
            MOVE      PMCEEMAI,LXPLEMAI
            MATCH     "1",PMCESLET
            IF        @EQUAL
              MOVE     DYES,LXPLSLET
            ELSE
              MOVE     DNO,LXPLSLET
            ENDIF
          ENDIF
.
          MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "8",CONTTYPE          * Preferred Contact
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCESNAM,PACSNAME
            MOVE      PMCEGNAM,PACGNAME
            MOVE      PMCETITL,PACTITLE
            MOVE      "1",PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,LXPRNAME     * Preferred Contact Details
            MOVE      PMCETITL,LXPRTITL
            MOVE      PMCESNAM,LXPRSNAM
            MOVE      PMCEGNAM,LXPRGNAM
            MOVE      PMCEGNM2,LXPRGNM2
            MOVE      PMCEADD1,LXPRADD1
            MOVE      PMCEADD2,LXPRADD2
            MOVE      PMCEADD3,LXPRADD3
            MOVE      PMCEADD4,LXPRADD4
            MOVE      PMCEPOST,LXPRPOST
            MOVE      PMCETELP,LXPRTELP
            MOVE      PMCETELB,LXPRTELB
            MOVE      PMCETELM,LXPRTELM
            MOVE      PMCERELP,LXPRRELP
            MOVE      PMCEEMAI,LXPREMAI
            MATCH     "1",PMCESLET
            IF        @EQUAL
              MOVE     DYES,LXPRSLET
            ELSE
              MOVE     DNO,LXPRSLET
            ENDIF
          ENDIF
.>>>>
          MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "1",CONTTYPE          * Next of Kin
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCESNAM,PACSNAME
            MOVE      PMCEGNAM,PACGNAME
            MOVE      PMCETITL,PACTITLE
            MOVE      "1",PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,PNKNAME      * NEXT OF KIN 1 NAME
            MOVE      PMCETITL,LXP1TITL     * title
            MOVE      PMCESNAM,LXP1SNAM     * surname
            MOVE      PMCEGNAM,LXP1GNAM     * given name 1
            MOVE      PMCEGNM2,LXP1GNM2     * given name 2
            MOVE      PMCEADD1,PNKADD1      * N.O.K 1 ADDRESS LINE 1
            MOVE      PMCEADD2,PNKADD2      * N.O.K 1 ADDRESS LINE 2
            MOVE      PMCEADD3,PNKSUBR      * N.O.K 1 ADDRESS LINE 3
            MOVE      PMCEADD4,PNKADD4      * N.O.K 1 ADDRESS LINE 4
            MOVE      PMCEPOST,PNKPOST      * N.O.K 1 POSTCODE
            MOVE      PMCETELP,PNKTELP      * N.O.K 1 PRIVATE TELEPHONE
            MOVE      PMCETELP,LXP1TELP
            MOVE      PMCETELB,PNKTELB      * N.O.K 1 BUSINESS TELEPHONE
            MOVE      PMCETELB,LXP1TELB
            MOVE      PMCETELM,PMPXKMOB     * N.O.K 1 MOBILE
            MOVE      PMCETELM,LXP1TELM
            MOVE      PMCERELP,PNKRELP      * N.O.K 1 RELATIONSHIP
            MOVE      PMCERELP,LXP1RELP
            MOVE      PMCEEMAI,PMPXKEML     * N.O.K 1 EMAIL
            MOVE      PMCEEMAI,LXP1EMAI
            MOVE      PMCESLET,PMPXKCRP     * N.O.K 1 Send Letter
            MATCH     "1",PMCESLET
            IF        @EQUAL
              MOVE     DYES,LXP1SLET
            ELSE
              MOVE     DNO,LXP1SLET
            ENDIF
          ENDIF
.
          MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "2",CONTTYPE          * Postal Address
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCESNAM,PACSNAME
            MOVE      PMCEGNAM,PACGNAME
            MOVE      PMCETITL,PACTITLE
            MOVE      "1",PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,LXPONAME     * Postal Address Formatted Name
            MOVE      PMCETITL,LXPOTITL     * title
            MOVE      PMCESNAM,LXPOSNAM     * surname
            MOVE      PMCEGNAM,LXPOGNAM     * given name 1
            MOVE      PMCEGNM2,LXPOGNM2     * given name 2
            MOVE      PMCEADD1,PTMXADD1     * POSTAL ADDRESS LINE 1
            MOVE      PMCEADD2,PTMXADD2     * POSTAL ADDRESS LINE 2
            MOVE      PMCEADD3,PTMXADD3     * POSTAL ADDRESS LINE 3
            MOVE      PMCEADD4,PTMXADD4     * POSTAL ADDRESS LINE 4
            MOVE      PMCEPOST,PTMXPOST     * POSTAL POSTCODE
            MOVE      PMCETELP,LXPOTELP
            MOVE      PMCETELB,LXPOTELB
            MOVE      PMCETELM,LXPOTELM
            MOVE      PMCERELP,LXPORELP
            MOVE      PMCEEMAI,LXPOEMAI
            MATCH     "1",PMCESLET
            IF        @EQUAL
              MOVE     DYES,LXPOSLET
            ELSE
              MOVE     DNO,LXPOSLET
            ENDIF
          ENDIF
.
          MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "4",CONTTYPE          * Mother
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCESNAM,PMPXMSNA     * MOTHER SURNAME
            MOVE      PMCEGNAM,PMPXMGNA     * MOTHER GIVEN NAME
            MOVE      PMCETITL,PMPXMTLE     * MOTHER TITLE
            MOVE      PMCEADD1,PMPXMAD1     * MOTHER ADDRESS LINE 1
            MOVE      PMCEADD2,PMPXMAD2     * MOTHER ADDRESS LINE 2
            MOVE      PMCEADD3,PMPXMAD3     * MOTHER ADDRESS LINE 3
            MOVE      PMCEADD4,PMPXMAD4     * MOTHER ADDRESS LINE 4
            MOVE      PMCEPOST,PMPXMPOS     * MOTHER POSTCODE
            MOVE      PMCETELP,PMPXMPNO     * MOTHER PRIVATE TELEPHONE
            MOVE      PMCETELB,PMPXMBNO     * MOTHER BUSINESS TELEPHONE
            MOVE      PMCETELM,PMPXMMNO     * MOTHER MOBILE
            MOVE      PMCEEMAI,PMPXMEML     * MOTHER EMAIL
            MOVE      PMCECONT,PMPXMCNT     * MOTHER COUNTYR OF BIRTH
            MOVE      PMCESLET,PMPXMCRP     * MOTHER SEND LETTER
            MOVE      SP70,PMPXMLAB         * MOTHER NAME OF LABEL
            MOVE      PMCERELP,PMPXMREL     * MOTHER RELATIONSHIP
          ENDIF
.
          MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MOVE      "5",CONTTYPE          * Father
            CALL      XCON0000              * Get extra contact details
            MOVE      PMCESNAM,PMPXFSNA     * FATHER SURNAME
            MOVE      PMCEGNAM,PMPXFGNA     * FATHER GIVEN NAME
            MOVE      PMCETITL,PMPXFTLE     * FATHER TITLE
            MOVE      PMCEADD1,PMPXFAD1     * FATHER ADDRESS LINE 1
            MOVE      PMCEADD2,PMPXFAD2     * FATHER ADDRESS LINE 2
            MOVE      PMCEADD3,PMPXFAD3     * FATHER ADDRESS LINE 3
            MOVE      PMCEADD4,PMPXFAD4     * FATHER ADDRESS LINE 4
            MOVE      PMCEPOST,PMPXFPOS     * FATHER POSTCODE
            MOVE      PMCETELP,PMPXFPNO     * FATHER PRIVATE TELEPHONE
            MOVE      PMCETELB,PMPXFBNO     * FATHER BUSINESS TELEPHONE
            MOVE      PMCETELM,PMPXFMNO     * FATHER MOBILE
            MOVE      PMCEEMAI,PMPXFEML     * FATHER EMAIL
            MOVE      PMCECONT,PMPXFCNT     * FATHER COUNTYR OF BIRTH
            MOVE      PMCESLET,PMPXFCRP     * FATHER SEND LETTER
            MOVE      SP70,PMPXFLAB         * FATHER NAME OF LABEL
            MOVE      PMCERELP,PMPXFREL     * FATHER RELATIONSHIP
          ENDIF
.
          PACK      RESPNAME,PNKNAME,SP20,SP20,SP20
          MATCH     SP52,RESPNAME
          GOTO      SET0040 IF EQUAL
          MOVE      PNKADD1,RESPADDA
          MOVE      PNKADD2,RESPADDB
          MOVE      PNKADD4,RESPADDD
          MOVE      PNKSUBR,RESPSUBR
          MOVE      PNKPOST,RESPPOST
          GOTO      SET0050
.
SET0040   MOVE      FULLNAME,RESPNAME
          MOVE      PADD1,RESPADDA
          MOVE      PADD2,RESPADDB
          MOVE      PPOST,RESPPOST
          MOVE      PSUBRB,RESPSUBR
          MOVE      PADD4,RESPADDD
.
SET0050   CALL      CLGP0000             * Clear Gp details
          PACK      KEY10,PMPXRHC1
          CALL      RDPMHCP1
          BRANCH    OVRCD,SET0060
          MOVE      PMHCSNAM,RGGPSNAM
          MOVE      PMHCGNAM,RGGPGNAM
          MOVE      PMHCADR1,RGGPADD1
          MOVE      PMHCADR2,RGGPADD2
          MOVE      PMHCADR3,RGGPADD3
          MOVE      PMHCADR4,RGGPADD4
          MOVE      PMHCPOST,RGGPPOST
          MOVE      PMHCFAXN,RGGPFAXN
          MOVE      PMHCSEML,RGGPSEML
          MOVE      PMHCMOBN,RGGPMOBN
          MOVE      PMHCPAGR,RGGPPAGR
          MOVE      PMHCPAGN,RGGPPAGN
          MOVE      PMHCPRV1,RGGPPRV1
          MOVE      PMHCSTEL,RGGPSTEL
.
          PACK      PACFNAME,SP30,SP30,SP20
          PACK      KEY10,PMPXRHC1,SP70
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCSNAM,PACSNAME
            MOVE      PMHCGNAM,PACGNAME
            MOVE      PMHCTITL,PACTITLE
            MOVE      ONE,PACFRMT
            CALL      PACNAME
          ENDIF
          MOVE      PACFNAME,LXWRLDFN
.                                                                      *I-52354
          MATCH     "Y",WTWMCSST
          IF        @EQUAL
            MOVE     DYES,LXWRCSST
          ELSE
            MOVE     DNO,LXWRCSST
          ENDIF
.
          MOVE      SP70,LXWRCSDT
          MOVE      "99",CDAY
          UNPACK    WTWMCSDT,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000
          MOVE      DATELINE,LXWRCSDT
.
SET0060   PACK      KEY10,WTWMRFGP
          CALL      RDPMHCP1
          BRANCH    OVRCD,SET0063
          MOVE      PMHCSNAM,RFGPSNAM
          MOVE      PMHCGNAM,RFGPGNAM
          MOVE      PMHCADR1,RFGPADD1
          MOVE      PMHCADR2,RFGPADD2
          MOVE      PMHCADR3,RFGPADD3
          MOVE      PMHCADR4,RFGPADD4
          MOVE      PMHCPOST,RFGPPOST
.
. get the Registered GP Practice address
.
SET0063   PACK      PMHGPRAC,PMPXRH1G
          PACK      KEY12,PMHGPRAC,PMPXR1GC
          CALL      RDPMHCG1
          BRANCH    OVRCD,SET0065
          MOVE      PMHGPNAM,RGPRSURG
          MOVE      PMHGADD1,RGPRSAD1
          MOVE      PMHGADD2,RGPRSAD2
          MOVE      PMHGADD3,RGPRSAD3
          MOVE      PMHGADD4,RGPRSAD4
          MOVE      PMHGPOST,RGPRSPCD
          MOVE      PMHGPTEL,RGPRTELE
          MOVE      PMHGPFAX,RGPRFAXN
          MOVE      PMHGPEML,RGPRPEML
.
. get the Referring GP Practice address
.
SET0065   PACK      KEY19,URDIM,WMCODE,WMCNT
          CALL      RDTREA1
          BRANCH    OVRCD,SET0070
.
          PACK      KEY19,WMURNO,WMCODE,DWMCNT
          CALL      RDWTTX11
          BRANCH    OVRCD,SET0070
.
          PACK      PMHGPRAC,WTWMGPPC,SP20
          PACK      KEY12,PMHGPRAC,WTWMGPPT
          CALL      RDPMHCG1
          BRANCH    OVRCD,SET0070
          MOVE      PMHGPNAM,RFPRSURG
          MOVE      PMHGADD1,RFPRSAD1
          MOVE      PMHGADD2,RFPRSAD2
          MOVE      PMHGADD3,RFPRSAD3
          MOVE      PMHGADD4,RFPRSAD4
          MOVE      PMHGPOST,RFPRSPCD
          MOVE      PMHGPTEL,RFPRTELE
.
SET0070   MOVE      SP20,TDESC
          MATCH     SP3,ELECATYP
          PACK      KEY5,ANSC,ANSC,ELECATYP
          CALL      RDCODE1
          MOVE      TDESC,EADMDESC
.                                           * SRF 16160 Code Change Begin
SET0071   MATCH     "                         ",RESPADDA
          GOTO      SET0072 IF NOT EQUAL
.          MOVE      "*************************",RESPADDA
.
SET0072   MATCH     "                              ",RFDADD1
          GOTO      SET0073 IF NOT EQUAL
.          MOVE      "******************************",RFDADD1
.
SET0073   MATCH     "                              ",RFDADD2
          GOTO      SET0075 IF NOT EQUAL
.          MOVE      "******************************",RFDADD2
.
SET0074   MATCH     "      ",RESPSEX
          GOTO      SET0075 IF NOT EQUAL
          MOVE      "******",RESPSEX
.
SET0075   MATCH     "                         ",RESPADDB
          GOTO      SET0080 IF NOT EQUAL
.          MOVE      "*************************",RESPADDB
.
SET0080   MATCH     "               ",RESPSUBR
          GOTO      SET0085 IF NOT EQUAL
.          MOVE      "***************",RESPSUBR
.
SET0085   MATCH     "    ",RESPPOST
          GOTO      SET0090 IF NOT EQUAL
.          MOVE      "****",RESPPOST
.
SET0090   MATCH     "                         ",PADD1
          GOTO      SET0140 IF NOT EQUAL
.          MOVE      "*************************",PADD1
.
SET0140   MATCH     "                         ",PADD4
          GOTO      SET0141 IF NOT EQUAL
.          MOVE      "*************************",PADD4
.
SET0141   MATCH     "                         ",PSUBRB
          GOTO      SET0144 IF NOT EQUAL
.          MOVE      "*************************",PSUBRB
.
SET0144   MATCH     "                         ",PADD2
          GOTO      SET0146 IF NOT EQUAL
.          MOVE      "*************************",PADD2

.
SET0146   MATCH     "                         ",PGNAME
          GOTO      SET0148 IF NOT EQUAL
.          MOVE      "*************************",PGNAME
.
SET0148   MATCH     "                    ",PSNAME
          GOTO      SET0150 IF NOT EQUAL
.          MOVE      "********************",PSNAME
.
SET0150   MATCH     "    ",PPOST
          GOTO      SET0155 IF NOT EQUAL
.          MOVE      "****",PPOST
.
SET0155   MATCH     "            ",PTELEP
          GOTO      SET0160 IF NOT EQUAL
.          MOVE      "************",PTELEP
.
SET0160   MATCH     "                    ",BTYPE
          GOTO      SET0164 IF NOT EQUAL
.          MOVE      "********************",BTYPE
.
SET0164   MATCH     "                    ",PACCOM
          GOTO      SET0166 IF NOT EQUAL
.          MOVE      "********************",PACCOM
.
SET0166   MATCH     SP50,PDESC
          GOTO      SET0170 IF NOT EQUAL
          MOVE      STAR50,PDESC
.
SET0170   MATCH     "                    ",REFUNIT
          GOTO      SET0175 IF NOT EQUAL
.          MOVE      "********************",REFUNIT
.
SET0175   MATCH     "                    ",REFPRTY
          GOTO      SET0180 IF NOT EQUAL
.          MOVE      "********************",REFPRTY
.
SET0180   MATCH     "               ",PSUBRB
          GOTO      SET0181 IF NOT EQUAL
.          MOVE      "***************",PSUBRB
.
SET0181   MATCH     "    ",PTITL
          GOTO      SET0182 IF NOT EQUAL
.          MOVE      "****",PTITL
.
SET0182   MOVE      PSEX,DSEXCHAR
          CALL      SEXDSP00
          MOVE      DSEXASC1,RESPSEX
          GOTO      SET0190
.
SET0190   CALL      IBACLOCK
          PACK      AGEDATE,CC,YY,MM,DD
          REP       " 0",AGEDATE
          CALL      CALCAGE
          MOVE      PSAGEYRS,DIMAGE
.
.                                           * SRF 16160 Code Change End
.------ move all the form totals to dims and ------
.------ compress any multiple blanks ------
.
SET8000   MOVE      BOOKNO,IDDIM1
.
          MATCH     SP3,WMUDEF5
          IF        !@EQUAL
            PACK      KEY5,CODEX5,WMUDEF5
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,LXUDEF5
              MOVE      LXUDEF5,LINE
              CALL      CASE0000
              MOVE      LINE,LXUDEF5
            ENDIF
          ENDIF
.
          MATCH     SP3,WMUDEF6
          IF        !@EQUAL
            PACK      KEY5,CODEX6,WMUDEF6
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,LXUDEF6
              MOVE      LXUDEF6,LINE
              CALL      CASE0000
              MOVE      LINE,LXUDEF6
            ENDIF
          ENDIF
.
          MATCH     SP3,WMUDEF7
          IF        !@EQUAL
            PACK      KEY5,CODEX7,WMUDEF7
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,LXUDEF7
              MOVE      LXUDEF7,LINE
              CALL      CASE0000
              MOVE      LINE,LXUDEF7
            ENDIF
          ENDIF
.
          MATCH     SP3,WMUDEF8
          IF        !@EQUAL
            PACK      KEY5,CODEX8,WMUDEF8
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,LXUDEF8
              MOVE      LXUDEF8,LINE
              CALL      CASE0000
              MOVE      LINE,LXUDEF8
            ENDIF
          ENDIF
.
          MOVE      SP70,LXREMCOD
          MOVE      SP70,LXREMDES
          MOVE      SP70,LXRELDES
          MATCH     SP3,WMREMOVE
          IF        !@EQUAL
            PACK      LXREMCOD,WMREMOVE,SP70
            PACK      KEY5,CODEWR,WMREMOVE,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,LXREMDES
              MOVE      LXREMDES,LINE
              CALL      CASE0000
              MOVE      LINE,LXREMDES
              MOVE      PTCDLDES,LXRELDES
              MOVE      LXRELDES,LINE
              CALL      CASE0000
              MOVE      LINE,LXRELDES
            ENDIF
          ENDIF
.
          MOVE      WTWMRANK,LXPRANK
          MOVE      WMREASON,LXWRWLDI

         MATCH     SP70,BKRERESI
          IF        !@EQUAL
            PACK      KEY5,CODET,BKRERESI,SP70   * Resident
            CALL      RDCODE1
            IF        OVRCD = 0
              MOVE      TDESC,LXRERESI
            ENDIF
          ELSE
            MATCH     SP70,PTYPE
            IF        !@EQUAL
              PACK      KEY5,CODET,PTYPE,SP70   * Resident
              CALL      RDCODE1
              IF        OVRCD = 0
                MOVE      TDESC,LXRERESI
              ENDIF
            ENDIF
          ENDIF

.
.------  move all names, addresses etc to LINE and convert to lower case ------
.
          MOVE      PSEX,LINE
          CALL      CASE0000
          MOVE      LINE,PSEX
.
          MOVE      BTYPE,LINE
          CALL      CASE0000
          MOVE      LINE,BTYPE
          MOVE      PACCOM,LINE
          CALL      CASE0000
          MOVE      LINE,PACCOM
          MOVE      PDESC,LINE
          CALL      CASE0000
          MOVE      LINE,PDESC
          MOVE      REFUNIT,LINE
          CALL      CASE0000
          MOVE      LINE,REFUNIT
          MOVE      REFPRTY,LINE
          CALL      CASE0000
          MOVE      LINE,REFPRTY
.
          MOVE      PADD1,LINE
          CALL      CASE0000
          MOVE      LINE,PADD1
.
          MOVE      PADD2,LINE
          CALL      CASE0000
          MOVE      LINE,PADD2
.
          MOVE      PSUBRB,LINE
          CALL      CASE0000
          MOVE      LINE,PSUBRB
.
          MOVE      PADD4,LINE
          CALL      CASE0000
          MOVE      LINE,PADD4
.
          MOVE      PTITL,LINE
          CALL      CASE0000
          MOVE      LINE,PTITL
          MOVE      RESPNAME,LINE
          CALL      CASE0000
          MOVE      LINE,RESPNAME
          MOVE      PGNAME,LINE
          CALL      CASE0000
          MOVE      LINE,PGNAME
          MOVE      PSNAME,LINE
          CALL      CASE0000
          MOVE      LINE,PSNAME
          MOVE      PTMASNAM,LXPTLSNM            * Patient Long Surname
          MOVE      LXPTLSNM,LINE
          CALL      CASE0000
          MOVE      LINE,LXPTLSNM
          MOVE      RESPSEX,LINE
          CALL      CASE0000
          MOVE      LINE,RESPSEX
          MOVE      RESPADDA,LINE
          CALL      CASE0000
          MOVE      LINE,RESPADDA
          MOVE      RESPADDB,LINE
          CALL      CASE0000
          MOVE      LINE,RESPADDB
          MOVE      RESPSUBR,LINE
          CALL      CASE0000
          MOVE      LINE,RESPSUBR
          MOVE      PSUBRB,LINE
          CALL      CASE0000
          MOVE      LINE,PSUBRB
          MOVE      EADMDESC,LINE
          CALL      CASE0000
          MOVE      LINE,EADMDESC
          
          MOVE      PTHSNAME,LINE
          CALL      CASE0000
          MOVE      LINE,PTHSNAME
.
          MOVE      PTHSADD1,LINE
          CALL      CASE0000
          MOVE      LINE,PTHSADD1
.
          MOVE      PTHSADD2,LINE
          CALL      CASE0000
          MOVE      LINE,PTHSADD2
.
          MOVE      PTHSADD3,LINE
          CALL      CASE0000
          MOVE      LINE,PTHSADD3
.
          MOVE      PTHSADD4,LINE
          CALL      CASE0000
          MOVE      LINE,PTHSADD4
.
          MOVE      RGPRSURG,LINE
          CALL      CASE0000
          MOVE      LINE,RGPRSURG
          MOVE      RGPRSAD1,LINE
          CALL      CASE0000
          MOVE      LINE,RGPRSAD1
          MOVE      RGPRSAD2,LINE
          CALL      CASE0000
          MOVE      LINE,RGPRSAD2
          MOVE      RGPRSAD3,LINE
          CALL      CASE0000
          MOVE      LINE,RGPRSAD3
          MOVE      RGPRSAD4,LINE
          CALL      CASE0000
          MOVE      LINE,RGPRSAD4
          MOVE      RGPRTELE,LINE
          CALL      CASE0000
          MOVE      LINE,RGPRTELE
.
          MOVE      RFPRSURG,LINE
          CALL      CASE0000
          MOVE      LINE,RFPRSURG
          MOVE      RFPRSAD1,LINE
          CALL      CASE0000
          MOVE      LINE,RFPRSAD1
          MOVE      RFPRSAD2,LINE
          CALL      CASE0000
          MOVE      LINE,RFPRSAD2
          MOVE      RFPRSAD3,LINE
          CALL      CASE0000
          MOVE      LINE,RFPRSAD3
          MOVE      RFPRSAD4,LINE
          CALL      CASE0000
          MOVE      LINE,RFPRSAD4
          MOVE      RFPRTELE,LINE
          CALL      CASE0000
          MOVE      LINE,RFPRTELE
.
          MOVE      PTMXCELL,LINE              * load cellular phone number
          CALL      CASE0000
          MOVE      LINE,LXCELL
          MOVE      PTMXADD1,LINE              * load postal address line 1
          CALL      CASE0000
          MOVE      LINE,LXPADDA
          MOVE      PTMXADD2,LINE              * load postal address line 2
          CALL      CASE0000
          MOVE      LINE,LXPADDB
          MOVE      PTMXADD3,LINE              * load postal address line 3
          CALL      CASE0000
          MOVE      LINE,LXPADDC
          MOVE      PTMXADD4,LINE              * load postal address line 4
          CALL      CASE0000
          MOVE      LINE,LXPADDD
          MOVE      PTMXPOST,LINE              * load postal Post Code     
          CALL      CASE0000
          MOVE      LINE,LXPPOST
.
          MOVE      SP70,LXWRPRED
          MOVE      "99",CDAY                            
          UNPACK    WTWMREAD,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000
          MOVE      DATELINE,LXWRPRED
.
          MOVE      SP70,LXWXPRET
          MOVE      "99",HOUR
          UNPACK    WTTXPTIM,HOUR,DUMMY,MINUTE,DUMMY,DIM2
          CALL      FTIM0000
          MOVE      TIMELINE,LXWXPRET
.
          MOVE      SP70,LXWXADMW
          MATCH     SP70,WTTXADMW
          IF        !@EQUAL
            PACK      KEY5,CATAP,WTTXADMW,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,LXWXADMW
            ENDIF
          ENDIF
.
          MOVE      SP70,LXWRPAND
          MOVE      "99",CDAY
          UNPACK    WTWMTRPA,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000
          MOVE      DATELINE,LXWRPAND
.
          MOVE      SP70,LXWXPANT
          MOVE      "99",HOUR
          UNPACK    WTTXPANT,HOUR,DUMMY,MINUTE,DUMMY,DIM2
          CALL      FTIM0000
          MOVE      TIMELINE,LXWXPANT
.
          MOVE      SP70,LXWRPRAD
          MOVE      "99",CDAY
          UNPACK    WMDATE3,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000
          MOVE      DATELINE,LXWRPRAD
.
          MOVE      SP70,LXWXPRAT
          MOVE      "99",HOUR
          UNPACK    WTTXPATM,HOUR,DUMMY,MINUTE,DUMMY,DIM2
          CALL      FTIM0000
          MOVE      TIMELINE,LXWXPRAT
.
          MOVE      SP70,LXWRPROD
          MOVE      "99",CDAY
          UNPACK    WTWMDABD,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000
          MOVE      DATELINE,LXWRPROD
.
          MOVE      SP70,LXWXPROT
          MOVE      "99",HOUR
          UNPACK    WTTXPOTM,HOUR,DUMMY,MINUTE,DUMMY,DIM2
          CALL      FTIM0000
          MOVE      TIMELINE,LXWXPROT
.
          CALL      PACC0000
          CALL      PACLOC00
.
          CALL      PASC0000
          CALL      PASLOC00
.
          MOVE      SP70,LXPMIXWD
          PACK      KEY6,PTMIXWRD,SP70
          CALL      RDAWARD1
          CALL      RDKWARD1
          IF        OVRCD = 0
            MATCH     PTMIXWRD,WWARD
            IF        @EQUAL
              MOVE      WBDESC,LXPMIXWD
            ENDIF
          ENDIF
.
          MOVE      SP70,LXPMIATM
          MOVE      "99",HOUR
          UNPACK    ATIME,HOUR,DUMMY,MINUTE,DUMMY,DIM2
          CALL      FTIM0000
          MOVE      TIMELINE,LXPMIATM
.
          MOVE      SP70,LXPMIADT
          MOVE      "99",CDAY
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000
          MOVE      DATELINE,LXPMIADT
.
          MOVE      SP70,LXWRDESC
          MATCH     SP70,WMDESC
          IF        !@EQUAL|!@EOS
            MOVE      WMDESC,LXWRDESC
          ENDIF
.
          MATCH     SP70,BKRXADWD
          IF        !@EQUAL
            MOVE      "ap",TCODE
            PACK      KEY5,TCODE,BKRXADWD,SP70  * Admitting Ward
            CALL      RDCODE1
            IF        OVRCD = 0
              MOVE      TDESC,LXRXADWD
            ENDIF
          ENDIF
.
          MOVE      "99",CDAY
          UNPACK    BKREEDAT,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000                 * Format Date XX/XX/XXXX
          MOVE      DATELINE,LXREEDAT
.
          MOVE      BKREATIM,LXREATIM         * Booking Time
.
          MOVE      SP70,LXVXAPWD
          MATCH     SP70,PMVXAPWD
          IF        !@EQUAL
            PACK      KEY5,CATAP,PMVXAPWD,SP70
            CALL      RDCODE1
            IF        OVRCD = 0
              MOVE      TDESC,LXVXAPWD
            ENDIF
          ENDIF
.
          MOVE      SP70,LXPMIDOB
          MOVE      "99",CDAY
          UNPACK    PBDATE,CCENT,CYEAR,CMON,CDAY
          CALL      FDAT0000
          MOVE      DATELINE,LXPMIDOB
.
          MOVE      SP70,LXWRLPCC
          MOVE      PMHCPRFC,LXWRLPCC
.
          MOVE      SP70,LXWRLDPC
          MATCH     SP70,PMHCPRFC
          IF        !@EQUAL
            PACK      KEY5,CODECZ,PMHCPRFC
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,LXWRLDPC
            ENDIF
          ENDIF
.
          MOVE      SP70,LXWRSRCR
          MATCH     SP70,WTWMSRCR
          IF        !@EQUAL
            PACK      KEY5,CODES,WTWMSRCR,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,LXWRSRCR
              MOVE      LXWRSRCR,LINE
              CALL      CASE0000
              MOVE      LINE,LXWRSRCR
            ENDIF
          ENDIF
.
          MOVE      SP70,LXWTCHOV
          MOVE      SP70,LXWTCHRD
          MOVE      SP70,LXWTCHRC
.
          PACK      KEY35,WMURNO,WMCODE,DWMCNT,Z70
          CALL      RSWTCHA1
SET8710   CALL      RPWTCHA1
          BRANCH    OVRCD,SET8720
.
          MATCH     WMURNO,WTCHURNO
          GOTO      SET8720 IF NOT EQUAL
.
          MATCH     WMCODE,WTCHPROC
          GOTO      SET8720 IF NOT EQUAL
.
          MATCH     DWMCNT,WTCHPCNT
          GOTO      SET8720 IF NOT EQUAL
.
          MATCH     "02",WTCHUPTY
          GOTO      SET8710 IF NOT EQUAL
.
          MOVE      WTCHOVAL,LXWTCHOV
          MOVE      WTCHREAS,LXWTCHRC
.
          MATCH     SP70,WTCHREAS
          GOTO      SET8720 IF EQUAL
.
          PACK      KEY5,ANSW,ANSD,WTCHREAS,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,SET8720
.
          MOVE      TDESC,LXWTCHRD
.
SET8720   MOVE      SP70,LXWTSUFT
          MOVE      SP70,LXWTSUTT
          MOVE      SP70,LXWTSURC
          MOVE      SP70,LXWTSURD
.
          PACK      KEY21,WMURNO,WMCODE,DWMCNT,Z70
          CALL      RSWTSUS1
          CALL      RPWTSUS1
          BRANCH    OVRCD,SET8750
.
          MATCH     WMURNO,WTSUURNO
          GOTO      SET8750 IF NOT EQUAL
.
          MATCH     WMCODE,WTSUCODE
          GOTO      SET8750 IF NOT EQUAL
.
          MATCH     DWMCNT,DWTSUCNT
          GOTO      SET8750 IF NOT EQUAL
.
.         MATCH     SP70,WTSUFDAT
.         IF        !@EQUAL
.           UNPACK    WTSUFDAT,CCENT,CYEAR,CMON,CDAY
.           MOVE      CMON,F2
.           LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.           PACK      NAFDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.         ENDIF
.
          MATCH     SP70,WTSUTDAT
          IF        !@EQUAL
.           UNPACK    WTSUTDAT,CCENT,CYEAR,CMON,CDAY
.           MOVE      CMON,F2
.           LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.           PACK      NATDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
            CALL      IBACLOCK
            PACK      DIM8,CC,YY,MM,DD
            REP       " 0",DIM8
.
            MATCH     DIM8,WTSUTDAT
            GOTO      SET8730 IF NOT LESS
.
          ELSE
.
SET8730     MATCH       SP70,WTSUFDAT
            IF          !@EQUAL & !@EOS
              UNPACK      WTSUFDAT,CCENT,CYEAR,CMON,CDAY
              PACK        LXWTSUFT,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR
            ENDIF
.
            MATCH       SP70,WTSUTDAT
            IF          !@EQUAL & !@EOS
              UNPACK      WTSUTDAT,CCENT,CYEAR,CMON,CDAY
              PACK        LXWTSUTT,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR
            ENDIF
.
            MOVE        WTSUREAS,LXWTSURC
.
            MATCH       SP70,WTSUREAS
            IF          !@EQUAL & !@EOS
              PACK        KEY5,ANSW,ANSN,WTSUREAS,SP70
              CALL        RDCODE1
              IF          OVRCD=0
                MOVE        TDESC,LXWTSURD
              ENDIF
            ENDIF
.
          ENDIF
.
SET8750   CALL      GSMSID00                 * Get SMS message id
          MOVE      IBSQNEXT,LXXSMSID        * SMS message id
.
          PACK      LXXSMSKY,SP1,NINE,WMURNO,WMCODE,WMCNT,SP70  * SMS key
          MOVE      LETTER,LXSMSCOD          * SMS Code (Letter Number)
          MOVE      PTMXCELL,LXXSMSPH        * SMS Phone Number
          MOVE      PURNO,LXXSMSUR           * SMS U/R
          MOVE      SP70,LXXSMSUS            * SMS User
          MOVE      SP70,LXXSMSUN            * SMS User Name
          PACK      KEY14,PASSCODE,SP70
          CALL      RSWBSE3
          CALL      RKWBSE3
          IF        OVRCD<>1
           MATCH      PASSCODE,WBSEPCD
           IF         @EQUAL
             MOVE      WBSEUID,LXXSMSUS      * SMS User
             MOVE      WBSENAM,LXXSMSUN      * SMS User Name
           ENDIF
          ENDIF
.
          MOVE      SP70,LXWXIDUS
          MATCH     SP70,WTTXINTD
          IF        !@EQUAL
            PACK      KEY5,CODEVI,WTTXINTD           * Intended stay duration
            CALL      RDCODE1
            IF        OVRCD = 0
              MOVE     TDESC,LXWXIDUS
            ENDIF
          ENDIF
.
          MOVE      WMSTAY,LXWTSTAY
.
          GOTO      SET9999
.            
SET9000   MOVE      TRUE,EXIT
.
SET9999   RETURN
+
.*****************************************************************************
.*                             SHSP0000                                      *
.*               Set up HoSPital details for multi hospital                  *
.*****************************************************************************
SHSP0000  PACK      PTHSHOSP,SP30,SP30
          PACK      PTHSNAME,SP30,SP30
          PACK      PTHSADD1,SP30,SP30
          PACK      PTHSADD2,SP30,SP30
          PACK      PTHSADD3,SP30,SP30
          PACK      PTHSADD4,SP30,SP30
          PACK      PTHSPCOD,SP30,SP30
          PACK      PTHSTELE,SP30,SP30
.
          PACK      BKREWARD,BKREWARD,SP3
          MATCH     SP3,BKREWARD
          GOTO      SHSP9999 IF EQUAL
.
SHSP5000  PACK      KEY6,BKREWARD,SP10
          CALL      RDWARD1
          BRANCH    OVRCD,SHSP9999
.
          PACK      KEY3,PTWDHOSN
          CALL      RDPTHSP1
.         
SHSP9999  RETURN
+
.****************************************************************************
.*                              CLGP0000                                    *
.*                          CLear GP details                                *
.****************************************************************************
CLGP0000  MOVE      SP70,RGGPSNAM
          MOVE      SP70,RGGPGNAM
          MOVE      SP70,RGGPADD1
          MOVE      SP70,RGGPADD2 
          MOVE      SP70,RGGPADD3 
          MOVE      SP70,RGGPADD4  
          MOVE      SP70,RGGPPOST  
          MOVE      SP70,RGGPFAXN
          MOVE      SP70,RGGPSEML
          MOVE      SP70,RGGPMOBN
          MOVE      SP70,RGGPPAGR
          MOVE      SP70,RGGPPAGN
          MOVE      SP70,RGGPPRV1
          MOVE      SP70,RGGPSTEL
          MOVE      SP40,RFGPSNAM  
          MOVE      SP40,RFGPGNAM  
          MOVE      SP40,RFGPADD1 
          MOVE      SP40,RFGPADD2 
          MOVE      SP40,RFGPADD3 
          MOVE      SP40,RFGPADD4 
          MOVE      SP40,RFGPPOST 
.
. Registered GP Practice address
.
          MOVE      SP70,RGPRSURG  
          MOVE      SP70,RGPRSAD1  
          MOVE      SP70,RGPRSAD2 
          MOVE      SP70,RGPRSAD3 
          MOVE      SP70,RGPRSAD4 
          MOVE      SP70,RGPRSPCD 
          MOVE      SP70,RGPRTELE 
          MOVE      SP70,RGPRFAXN
          MOVE      SP70,RGPRPEML
.
. Referring GP Practice address
.
          MOVE      SP40,RFPRSURG  
          MOVE      SP40,RFPRSAD1  
          MOVE      SP40,RFPRSAD2 
          MOVE      SP40,RFPRSAD3 
          MOVE      SP40,RFPRSAD4 
          MOVE      SP40,RFPRSPCD 
          MOVE      SP40,RFPRTELE 
.
CLGP9999  RETURN
+
.**********************************************************************
.*                              CLRV0000                              *
.*      routine to initialise all unformatted variables to "*"        *
.**********************************************************************
.                                           * SRF 16160 Code Change Begin
CLRV0000  MOVE      SP1,PSEX
          MOVE      SP25,PADD1
          MOVE      SP25,PADD2
          MOVE      SP25,PSUBRB
          MOVE      SP25,PADD4
          MOVE      SP25,PGNAME
          MOVE      SP25,PSNAME
          MOVE      SP5,PPOST
          MOVE      SP15,PTELEP
          MOVE      STAR52,RESPNAME
          MOVE      STAR50,PDESC
          MOVE      SP15,RESPSEX
          MOVE      SP25,RESPADDA
          MOVE      SP25,RESPADDB
          MOVE      SP5,RESPPOST
          MOVE      SP15,RESPSUBR
          MOVE      SP20,BTYPE
          MOVE      SP20,PACCOM
          MOVE      SP20,REFUNIT
          MOVE      SP20,REFPRTY
          MOVE      SP15,PSUBRB
          MOVE      SP5,PTITL
          MOVE      SP20,DESCCAT
          MOVE      SP20,LXCELL
          MOVE      SP35,LXPADDA
          MOVE      SP35,LXPADDB
          MOVE      SP35,LXPADDC
          MOVE      SP35,LXPADDD
          MOVE      SP8,LXPPOST
          MOVE      SP20,LXUDEF5
          MOVE      SP20,LXUDEF6
          MOVE      SP20,LXUDEF7
          MOVE      SP20,LXUDEF8
          MOVE      SP8,LXPRANK
          MOVE      SP20,LXWRLDMB
          MOVE      SP20,LXWRLDPR
          MOVE      SP20,LXWRLDPG
          MOVE      SP20,LXWRLDPV
          MOVE      SP70,LXWRLDFN
          MOVE      SP70,LXWRCSST
          MOVE      SP70,LXWRCSDT
          MOVE      SP70,LXPMIXWD
          MOVE      SP70,LXPMIATM
          MOVE      SP70,LXPMIADT
          MOVE      SP70,LXWRDESC
          MOVE      SP70,LXRXADWD
          MOVE      SP70,LXREATIM
          MOVE      SP70,LXREEDAT
          MOVE      SP70,LXVXAPBD
          MOVE      SP70,LXPMIDOB
          MOVE      SP70,LXWRLDPC
          MOVE      SP70,LXWRLPCC
          MOVE      SP70,LXWRLSTL
          MOVE      SP70,LXWRLPFX
          MOVE      SP70,LXWRLPEM
          MOVE      SP70,LXWLCHEM
          MOVE      SP70,LXWLCDEM
.                                           * SRF 16160 Code Change End
CLRV9999  RETURN
+
.**********************************************************************
.*                               MORE0000                             *
.*                     any MORE letters to print?                     *
.**********************************************************************
MORE0000  MOVE      FALSE,EXIT
          DISPLAY   *P1:7,*EF,"Any more letters for the same people (":
                          *V2LON,"Y",*HOFF,"/",*V2LON,"N",*HOFF,") ?";
          KEYIN     *P46:7,*EL,*DV,UNDLN1,*P46:7,*V2LON,ANS;
          TYPE      ANS
          GOTO      MORE1000 IF EQUAL
          REP       UPPLOW,ANS
          REPLACE   "Y1N0",ANS
          TYPE      ANS
          GOTO      MORE2000 IF EQUAL
.
MORE1000  BEEP
          GOTO      MORE0000
.
MORE2000  MOVE      ANS,OPTION
          BRANCH    OPTION,MORE3000
          MOVE      TRUE,EXIT                     * no more letters desired
          GOTO      MORE9999
.
.------  there are more letters to print ------
.
MORE3000  MOVE      TWO,EXIT
          CLOSE     TEMP1
          OPEN      TEMP1,FNAMER     
          GOTO      MORE9999
.
MORE9999  RETURN
+         
.
GETSVAR   * dummy label needed by search routine *
          RETURN
.
REDISPS   IF        PTCNUAHS = 1
            CALL      PUTSCR00
            MOVE      ONE,REFRESH
          ELSE
            CALL      GOPN0000
            CALL      DISP0000
          ENDIF
          RETURN
+
.******************************************************************************
.*                                NXTR0000                                    *
.*                 Extract records using search criteria                      *
.******************************************************************************
NXTR0000  MOVE      ZERO,EXIT
          MOVE      ZERO,PROPTION           * signal SVRC to display data to scr
          MOVE      ZERO,COUNTER
          MOVE      ONE,COUNT2
          MOVE      ONE,SCREEN
.
          MOVE      ZERO,EXTRFLAG           * set search thru wattr1af
          DISPLAY   *P1:4,*EF,*P1:24,*BLINKON,"Searching...";
          MOVE      ZERO,COUNT              * zero the number of records counter
          MOVE      FIVE,YPOS
.
          DISPLAY   *P1:3,*EF,*V2LON:
                    *ULON,*P1:4,"Cnt",*P5:4,"  U/R No",*P14:4,"Code     ":
                    *P24:4,"Description         ",*P45:4,"On List   ":
                    *P56:4,"Review    ",*P67:4,"Status      ";
.
          CALL      CRET0000
          CALL      UINDX000           * select index and pack the key 
          CALL      POSITION
.
NXTR1000  CALL      READNEXT           * read next record
          BRANCH    OVRCD TO NXTR9000
.
          CALL      RANGE0000          * Check index ranges
          BRANCH    EXIT,NXTR9000
.
          PACK      KEY8,WMURNO
          CALL      RDMAST1
          BRANCH    OVRCD,NXTR1000
          CALL      RDPMPX21
.
.------  Validate not available dates ------
.
          PACK      SESNDATE,SESNDATE,SP8
          MATCH     SP8,SESNDATE
          IF          !@EQUAL
            PACK        WTWMNAFR,WTWMNAFR,SP8
            MATCH       SP8,WTWMNAFR
            IF          !@EQUAL
              MATCH       WTWMNAFR,SESNDATE
              GOTO        NXTR2000 IF LESS
.
              MATCH       SESNDATE,WTWMNATO
              GOTO        NXTR2000 IF LESS
              GOTO        NXTR1000
            ENDIF
          ENDIF
.
.         check if user has security access to this record
.
NXTR2000  COMPARE   ONE,WTCNWLSC
          GOTO      NXTR3000 IF NOT EQUAL
.
          PACK      KEY4,PASSCODE
          CALL      RDWTSEA1
          COMPARE   ZERO,OVRCD
          GOTO      NXTR3000 IF EQUAL       * All access
          PACK      KEY13,PASSCODE,WMDOCTOR,WMUNIT
          CALL      RDWTSEI2
          BRANCH    OVRCD,NXTR1000          * no access
.
NXTR3000  CALL      MTCH0000                * match rec. against search criteria
          BRANCH    EXIT,NXTR1000           * exit=1 if match failed
          ADD       ONE,COUNT               * increment the found record counter
.
          PACK      KEY27,WMDATE1,WMURNO,WMCODE,DWMCNT
          UNPACK    KEY27,YYDATE1,YYURNO,YYCODE,YYMCNT
          PACK      KEY27,YYDATE1,YYURNO,YYCODE,YYMCNT,SP30
          WRITE     TEMPF2,KEY27;YYDATE1,YYURNO,YYCODE,YYMCNT
          ADD       ONE,COUNT
          ADD       ONE,COUNTER
.   
          GOTO      NXTR1000                * get next record
.
NXTR8000  CALL      DSPP0000                * show screen a single record
.
          MATCH     ANSX,ANS
          IF        @EQUAL
            MOVE      TWO,EXIT
          ENDIF
.
          GOTO      NXTR9500
.
NXTR9000  MOVE      ZERO,EXIT
          COMPARE   ZERO,COUNT
          GOTO      NXTR8000 IF NOT EQUAL
          DISPLAY   *P1:24,*EL,*B,*V2LON,"** No records found **    ";
          CALL      HITENTER
          MOVE      ONE,EXIT
.
NXTR9500  COMPARE   ZERO,COUNTER
          GOTO      NXTR9700 IF NOT EQUAL
.
          DISPLAY   *P1:24,*EL,*B,*V2LON:
                    "*** No records available for given parameters ***   ";
          CALL      HITENTER
          MOVE      ONE,EXIT
.
NXTR9700  PACK      KEY27,SP27
          READ      TEMPF2,KEY27;;
NXTR9800  READKS    TEMPF2;YYDATE1,YYURNO,YYCODE,YYMCNT
          GOTO      NXTR9999 IF OVER
.
          PACK      KEY27,YYDATE1,YYURNO,YYCODE,YYMCNT
          CALL      RDTREA3
          CALL      FRMT0000
          GOTO      NXTR9800
.
NXTR9999  RETURN
+
PRNT0000  RETURN    * print option called from WATAHOCS (used by WAT13)
.
.------------------------------------------------------------
. Open Outpatient Files
.------------------------------------------------------------
OPNOUT00  PACK      CFNAME,CFILEPRE,FILCLIA1  * Get the name of the CLIA1 file
          CLOSE     OUTCLIA1
          OPEN      OUTCLIA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILBOKA6  * Get the name of the BOKA6 file
          CLOSE     OUTBOKA6
          OPEN      OUTBOKA6,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILBB1A1  * Get the name of the BB1A1 file
          CLOSE     OUTBB1A1
          OPEN      OUTBB1A1,CFNAME
.
          PACK      CFNAME,CFILEPRE,FILSESA1  * Get the name of the SESA1 file
          CLOSE     OUTSESA1
          OPEN      OUTSESA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILMA1A1
          CLOSE     OUTMA1A1
          OPEN      OUTMA1A1,CFNAME
.
          PACK      CFNAME,CFILEPRE,FILHEDA1
          CLOSE     OUTHEDA1
          OPEN      OUTHEDA1,CFNAME
.
OPNOUT99  RETURN
.
.*******************************************************************************
. COTFIL00 - Check that the correct outpatient site prefix files are open
.            according to the site code. If the site is invalid
.            or blank just open the default site of out.

.*******************************************************************************
COTFIL00  MATCH     SP70,CHECKSIT            * Does the visit have a site
          GOTO      COTFIL50 IF NOT EQUAL
.
COTFIL10  MATCH     "out",CFILEPRE           * Is out currently open
          IF        !@EQUAL
            MOVE      "out",OSTFILE          * open default prefix of out
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open out Outpatient Files
          ENDIF
.
          GOTO      COTFIL99
.
COTFIL50  MOVE      CHECKSIT,KEY6
          CALL      RDSITA1
          BRANCH    OVRCD,COTFIL10           * error invalid site code
.
          MATCH     OSTFILE,CFILEPRE         * Save Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open prefixed Outpatient Files
          ENDIF
.
          GOTO      COTFIL99
.
COTFIL99  RETURN
.
.------------------------------------------------------------
. Get pre admission clinic name
.------------------------------------------------------------
PACC0000  MOVE      SP70,LXWRPRCC
          MOVE      SP70,LXWRPRAC
.
          PACK      KEY27,WMURNO,WMCODE,WMCNT,SP70
          CALL      RSWTOPA1
PACC1000  CALL      RKWTOPA1
          BRANCH    OVRCD,PACC9999
.
          MATCH     WTOPURNO,WMURNO
          GOTO      PACC9999 IF NOT EQUAL
.
          MATCH     WTOPCODE,WMCODE
          GOTO      PACC9999 IF NOT EQUAL
.
          MATCH     WTOPCOUN,DWMCNT
          GOTO      PACC9999 IF NOT EQUAL
.
          MATCH     "0",WTOPSTAT
          GOTO      PACC9000 IF EQUAL
.
          GOTO      PACC1000
.
PACC9000  MOVE      WTOPSITE,CHECKSIT
          CALL      COTFIL00
.
          PACK      KEY20,WTOPSITE,WTOPCLIN,WTOPDATE,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          BRANCH    OVRCD,PACC9999
.
          MATCH     WTOPSITE,OCASITE
          GOTO      PACC9999 IF NOT EQUAL
.
          MATCH     WTOPCLIN,OCACLIN
          GOTO      PACC9999 IF NOT EQUAL
.
          MOVE      OCACLIN,LXWRPRCC
          MOVE      OCADESC,LXWRPRAC
.
PACC9999  RETURN
.
.------------------------------------------------------------
. Get pre admission clinic location
.------------------------------------------------------------
PACLOC00  PACK      KEY36,WTOPOUTN,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,PACLOC99
.
          MATCH     DOBAOUTN,WTOPOUTN
          GOTO      PACLOC99 IF NOT EQUAL
.
          MOVE      WTOPOUTN,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,PACLOC99    
.
          PACK      KEY18,OBASITE,OBACLIN,OBADAY,OBASTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,PACLOC99    
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,PACLOC99    
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,PACLOC99    
.
          MOVE      "CT",CATEGORY
          MOVE      OTHELTYP,CODE
          CALL      GETCOD00
          MOVE      TDESC,LXPACLOC
.
PACLOC99  RETURN
.
.------------------------------------------------------------
. Get pre anaesthetic clinic name
.------------------------------------------------------------
PASC0000  MOVE      SP70,LXWRPACC
          MOVE      SP70,LXWRPANC
.
          PACK      KEY27,WMURNO,WMCODE,WMCNT,SP70
          CALL      RSWTOPS1
PASC1000  CALL      RKWTOPS1
          BRANCH    OVRCD,PASC9999
.
          MATCH     WTOSURNO,WMURNO
          GOTO      PASC9999 IF NOT EQUAL
.
          MATCH     WTOSCODE,WMCODE
          GOTO      PASC9999 IF NOT EQUAL
.
          MATCH     WTOSCOUN,DWMCNT
          GOTO      PASC9999 IF NOT EQUAL
.
          MATCH     "0",WTOSSTAT
          GOTO      PASC9000 IF EQUAL
.
          GOTO      PASC1000
.
PASC9000  MOVE      WTOSSITE,CHECKSIT
          CALL      COTFIL00
.
          PACK      KEY20,WTOSSITE,WTOSCLIN,WTOSDATE,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          BRANCH    OVRCD,PACC9999
.
          MATCH     WTOSSITE,OCASITE
          GOTO      PACC9999 IF NOT EQUAL
.
          MATCH     WTOSCLIN,OCACLIN
          GOTO      PACC9999 IF NOT EQUAL
.
          MOVE      OCACLIN,LXWRPACC
          MOVE      OCADESC,LXWRPANC
.
PASC9999  RETURN
.
.------------------------------------------------------------
. Get pre anaesthetic clinic location
.------------------------------------------------------------
PASLOC00  PACK      KEY36,WTOSOUTN,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,PASLOC99
.
          MATCH     DOBAOUTN,WTOSOUTN
          GOTO      PASLOC99 IF NOT EQUAL
.
          MOVE      WTOSOUTN,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,PASLOC99
.
          PACK      KEY18,OBASITE,OBACLIN,OBADAY,OBASTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,PASLOC99
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,PASLOC99
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,PASLOC99
.
          MOVE      "CT",CATEGORY
          MOVE      OTHELTYP,CODE
          CALL      GETCOD00
          MOVE      TDESC,LXPASLOC
.
PASLOC99  RETURN
.
.------------------------------------------------------------------------
. Clear details
.------------------------------------------------------------------------
CLBKRX00  MOVE      SP70,BKRXPOWD  *  Post-Op Ward (patwr1af)
          MOVE      SP70,BKRXADWD  * Admitting Ward (patwr1af)
          MOVE      SP70,BKRXCDTE  * Contact Date (ccyymmdd)
          MOVE      SP70,BKRXPSTY  * Parent Staying (0=NO,1=YES)
          MOVE      SP70,BKRXCNDT  * Confirmation Date (ccyymmdd)
          MOVE      SP70,BKRXUDF1  * User Defined Field 1 (Cat BE)
          MOVE      SP70,BKRXUDF2  * User Defined Field 2 (Cat BF)
          MOVE      SP70,BKRXUDF3  * User Defined Field 3 (Cat BG)
          MOVE      SP70,BKRXUDF4  * User Defined Field 4 (Cat BH)
          MOVE      SP70,BKRXUDF5  * User Defined Field 5 (Cat BL)
          MOVE      SP70,BKRXUDD1  * User Defined Date 1 (ccyymmdd)
          MOVE      SP70,BKRXUDD2  * User Defined Date 2 (ccyymmdd)
          MOVE      SP70,BKRXUDD3  * User Defined Date 3 (ccyymmdd)
          MOVE      SP70,BKRXUDD4  * User Defined Date 4 (ccyymmdd)
          MOVE      SP70,BKRXUFF1  * Procedure Description 1
          MOVE      SP70,BKRXUFF2  * Procedure Description 2
          MOVE      SP70,BKRXUFF3  * Procedure Description 3
          MOVE      SP70,BKRXUFF4  * User Defined Free Format 4
          MOVE      SP70,BKRXEDC1  * Extra Doctor Code 1 (pmshcpaf)
          MOVE      SP70,BKRXEDC2  * Extra Doctor Code 2 (pmshcpaf)
          MOVE      SP70,BKRXEDC3  * Extra Doctor Code 3 (pmshcpaf)
          MOVE      SP70,BKRXODTE  * Operation Date (ccyymmdd)
          MOVE      SP70,BKRXOPRD  * Operation Period (Cat SP)
          MOVE      SP70,BKRXCRDT  * Date record created (ccyymmdd)
          MOVE      SP70,BKRXCRTM  * Time record created (hh:mm:ss)
          MOVE      SP70,BKRXWEBC  * WEB User Id rec. creator (websecaf)
          MOVE      SP70,BKRXLUPD  * Last Update Date (ccyymmdd)
          MOVE      SP70,BKRXLUPT  * Last Update Time (hh:mm:ss)
          MOVE      SP70,BKRXWEBU  * WEB User Id rec. updater (websecaf)
          MOVE      SP70,BKRXASRC  * Admission Source (Category S)
          MOVE      SP70,BKRXBLDT  * Blood Type (category BO)
          MOVE      SP70,BKRXCTTY  * Contact Type (Letter No.-watletaf)
          MOVE      SP70,BKRXSGBK  * Surgical Booking
          RETURN
.------------------------------------------------------------------------
. Clear details
.------------------------------------------------------------------------
CLBOKREC  MOVE      SP70,BKRESNAM  *       Surname
          MOVE      SP70,BKRELOCK  *        Lock variable
          MOVE      SP70,BKREADOC  *        Attending Doctor
          MOVE      SP70,BKRESDOC  *        Referring Doctor
          MOVE      SP70,BKREEDAT  *        Expected due date (CCYYMMDD)
          MOVE      SP70,BKREATIM  *        Expected assessment time
          MOVE      SP70,BKREPDAT  *        Pre-assessment date
          MOVE      SP70,BKREPTIM  *        Pre-assessment time
          MOVE      SP70,BKREADAT  *        Date booking was made CCYYMMDD
          MOVE      SP70,BKRETYPE  *        Booking type (Cat "BK")
          MOVE      SP70,BKRECANC  *        Cancellation reason (Cat "BC")
          MOVE      SP70,BKRESTAT  *        Booking status
          MOVE      SP70,BKREOMEM  *        Benefit fund member (Y/N/U)
          MOVE      SP70,BKREPREV  *        Previous inpatient (Y/N/U)
          MOVE      SP70,BKREACCM  *        Preferred accommodation (Cat BP)
          MOVE      SP70,BKREPROC  *        Waiting list procedure code
          MOVE      SP70,DBKRECNT  *        Waiting list procedure count
          MOVE      SP70,BKREWARD  *        Expected ward
          MOVE      SP70,BKREADMN  *        Maternity admission number
          MOVE      SP70,BKREPREA  *        Deposit paid (Y/N) Matern only
          MOVE      SP70,BKREEBED  *        Expected bed
          MOVE      SP70,BKRECLSS  *        Patient Cat./Adm Class. (Cat P)
          MOVE      SP70,BKREATYP  *        Adm Type/Pat. Class (Cat A)
          MOVE      SP70,BKREDEPT  *        Department (Cat AC)
          MOVE      SP70,BKRETDOC  *        Associated Doctor
          MOVE      SP70,BKRECLMT  *        Claim type (Cat CL)
          MOVE      SP70,BKRERFGP  *        Referring GP
          MOVE      SP70,BKREGPPC  *        GP Practice code
          MOVE      SP70,BKREGPFA  *       GPFH Approval Number
          MOVE      SP70,BKRERESI  *        Resident Status (Cat T)
          MOVE      SP70,BKREEATY  *        Elective Admission Type  (Cat CC)
          MOVE      SP70,BKREECRA  *       ECR Approval Number
          MOVE      SP70,BKREGPPT  *        GP Practice count
          MOVE      SP70,BKREDOFR  *        District of Residence (Cat DA)
          MOVE      SP70,BKREOPER  *        Operator who made I/P Booking
          MOVE      SP70,DBKREELO  *        Expected Length of Stay (Days)
          MOVE      SP70,BKREBKDT  *        Booking date (ccyymmdd)
          MOVE      SP70,BKRESPAR  *        Spare
          MOVE      SP70,BKREINDC
          RETURN
.
.------------------------------------------------------------
. Set referring clinician fields (WTTXRCLI)
.------------------------------------------------------------
RCLI0000  MOVE      SP70,LXRCLINF
          MOVE      SP70,LXRCLTLE
          MOVE      SP70,LXRCLSNM
          MOVE      SP70,LXRCLGNM
          MOVE      SP70,LXRCLAD1
          MOVE      SP70,LXRCLAD2
          MOVE      SP70,LXRCLAD3
          MOVE      SP70,LXRCLAD4
          MOVE      SP70,LXRCLPST
.
          MATCH     SP70,WTTXRCLI           * Referring clinician
          GOTO      RCLI9999 IF EQUAL       * blank
.
          PACK      KEY10,WTTXRCLI,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,RCLI9999
.
          MOVE      PMHCSNAM,PACSNAME
          MOVE      PMHCGNAM,PACGNAME
          MOVE      PMHCTITL,PACTITLE
          MOVE      ONE,PACFRMT
          CALL      PACNAME
          MOVE      PACFNAME,LXRCLINF
          MOVE      PMHCTITL,LXRCLTLE
          MOVE      PMHCSNAM,LXRCLSNM
          MOVE      PMHCGNAM,LXRCLGNM
          MOVE      PMHCADR1,LXRCLAD1
          MOVE      PMHCADR2,LXRCLAD2
          MOVE      PMHCADR3,LXRCLAD3
          MOVE      PMHCADR4,LXRCLAD4
          MOVE      PMHCPOST,LXRCLPST
.
RCLI9999  RETURN
+
.******************************************************************************
.*                                  NOK20000                                  *
.*                         Get NOK2 Contact Details                           *
.******************************************************************************
NOK20000  PACK      KEY5,CATTC,SP70
          CALL      RDSCODE1
NOK21000  CALL      RDKCODE1
          BRANCH    OVRCD,NOK25000
.
          MATCH     CATTC,TCODE
          GOTO      NOK25000 IF NOT EQUAL
.
          MATCH     "I",PTCOACTV
          GOTO      NOK21000 IF EQUAL
.
          MATCH     CONTTYPE,TCINDC1
          IF        @EQUAL
            MATCH     "2",TCINDC3                * indc1=1 and indc3=2
            GOTO      NOK22000 IF EQUAL
          ENDIF
          GOTO      NOK21000
.
NOK22000  PACK      KEY14,PURNO,ACODE,SP70
          CALL      RSPMCEX1
NOK22100  CALL      RKPMCEX1
          BRANCH    OVRCD,NOK25000
.
          MATCH     PURNO,PMCEURNO          * Same U/R
          GOTO      NOK25000 IF NOT EQUAL
.
          MATCH     ACODE,PMCETYPE          * Same Contact Type
          GOTO      NOK25000 IF NOT EQUAL
.
          MATCH     "1",PMCEACTV            * Ignore if inactive
          GOTO      NOK22100 IF EQUAL
.
          GOTO      NOK29999
.
NOK25000  CALL      CLPMSCEX                * Clear extra contact file vars
.
NOK29999  RETURN
+
.==============================================================================
.
          INC       STD001IO
          INC       PATCODKY
          INC       PATCOMN1
          INC       WATEXTRD
          INC       PATSNDX
          INC       PATSNX2
          INC       SMSMESID
.
          INC       CLPATMIS
          INC       CLPMSCEX
          INC       CLPMSPX2
          INC       CLPMSVX1
          INC       CLPATVIS
.
          INC       PATDOCKY
          INC       PMSCEXCD
          INC       PMSHCPDS
          INC       PMSHCGDS
          INC       TFILENAM
.
          INC       WATAHOCS
          INC       WATONSUS
          INC       WATDSPRO
          INC       WATDSSTA
          INC       SEXDSP00
          INC       WATLETCD                 * common code for printing letters
.
          INC       BOKRC1IO/INC
          INC       BOKRX1IO/INC
          INC       IBASEQIO/INC
          INC       OUTPREIO/INC
          INC       PMSCEXIO/INC
          INC       PMSHCLIO/INC
          INC       PMSHCPIO/INC
          INC       PMSHCGIO/INC
          INC       PATHSPIO/INC
          INC       PATCODIO/INC
          INC       PATDO1IO/INC
          INC       PATMA1IO/INC
          INC       PMSPX2IO/INC
          INC       PATMI1IO/INC
          INC       PATVISIO/INC
          INC       PATPR1IO/INC
          INC       PATGSRIO/INC
          INC       PATWR1IO/INC
          INC       PMSVX1IO/INC
          INC       WATPROIO/INC
          INC       WATTR1IO/INC
          INC       WATLETIO/INC
          INC       WATVWLIO/INC
          INC       WATLHIIO/INC
          INC       WATSEAIO/INC
          INC       WATSEIIO/INC
          INC       WATSUSIO/INC
          INC       WATTX1IO/INC
          INC       WATCHAIO/INC
          INC       WEBERRIO/INC
          INC       WEBSECIO/INC
          INC       MLTCODIO/INC
.
          INC       CLPATMAS
.
          INC       NZHISIIO
          INC       NZIBSRCH
          INC       PATALRIO/INC
          INC       NHIMASIO/INC
......    INC       PATMWSIO/INC
          INC       PATSMWIO/INC
          INC       PATDNRIO/INC
          INC       PATSDNIO/INC
          INC       PATNIDIO/INC
          INC       WATOPAIO/INC
          INC       WATOPSIO/INC
          INC       OUTBB1IO/INC
          INC       OUTBOAIO/INC
          INC       OUTCLIIO/INC
          INC       OUTHEDIO/INC
          INC       OUTMA1IO/INC
          INC       OUTSESIO/INC
          INC       OUTSITIO/INC
          INC       CALCAGE
          INC       PATCODTM
.
          INC       SMSPRXML           * Print XML metatags for SMS
.
OPEN0000
CLOS0000
AGECHK    RETURN
+
