.------------------------------------------------------------------------
. Program       : PATWEB89
.
. Function      : Admissions Web Server
.
. Modifications :
.------------------------------------------------------------------------
. V12.00.17 15.09.2025 Ebon Clements     TSK 0966920
.           Use ADMISSNO for visit pmsextaf read - SFA12500
. V12.00.16 08.09.2025 DA Sarkies        TSK 0965997
.           Added variable to set a rebook if required by appointment WPMNPL10
.           variable - RETDFRAE & SCRNAME
. V12.00.15 02.08.2025 DA Sarkies        TSK 0965457
.           Added check for entry in WPMNPL00 and increase count if present
. V12.00.14 01/08/2025 Thah T            TSK 0959732
.           Added DFGEN000 to default Identifying Gender and Pronoun
. V12.00.13 30.07.2025 Ebon Clements     TSK 0963540
.           Open ICD10 ED 13 diagnosis file for bed request diagnosis tag
.           BQDIAG00
. V12.00.12 09.07.2025 Alina Bhari       TSK 0962695
.           corrected the comment for V12.00.11                            
. V12.00.11 09.07.2025 Alina Bhari       TSK 0962695
.           Correctly assgined admissno -VEDU000
. V12.00.10 03.07.2025 Ebon Clements     TSK 0962695
.           Read latest pattranf record for stat adm A01 - ADMS2000
. V12.00.09 23.06.2025 DA Sarkies        TSK 0947257
.           Updated patient transfer when claim accepted by ICWA
. V12.00.08 18/06/2025 Jacob Jackson     TSK 0960175
.           For WDIET000, check if statistical discharge
.           18/06/2025 Peter Vela        TSK 0962332
.           Save and restore values for pattran TWARD and TBED in UPPHSP00
.           (SAVETWRD/SAVETBED)
.           The incorrect TWARD and TBED were getting written to pattran in
.           STRNA0000
. V12.00.07 16/06/2025 J.Tan             TSK 0961932
.           Recompiled for WEBDINVS - Moved back SAVEND to FORM3
. V12.00.06 11/06/2025  Ebon Clements   TSK 0961623
.           Alphanueric visit number changes - PTMIS050
. V12.00.05 06/06/2025  J.Tan          TSK 0961638
.           Mod Public Hospital NOT to write to Previous Hospitalisation file
. V12.00.04 02/06/2025  Nikitha        TSK 0955096
.           Alphanumeric error corrections. 
.           30/05/2025  J.Tan          TSK 0961444
.           Mod UPPHSP00 updating Days of Hospitalisation in Adm.file
. V12.00.03 19/05/2025  Ebon Clements    TSK 0960463
.           Recompiled for UPEADMVS - eAdmission document update by
. V12.00.02 15/05/2025  Alina Bhari      TSK 0959524
.           Fixed the issue with unable to admit the patient with sex as
.           Not Stated - NEWR0000
. V12.00.01 13/05/2025  Ebon Clements  TSK 0955096
.           Added alpanumeric visit number generation - NXTA0000 - GENANVIS
.           13.05.2025  DA Sarkies     TSK 0947257
.           Added CHCKCOMP to redirect workflow after MVA entered to
.           secondary insurer
.           28/05/2025  Nikitha        TSK 0955096
.           Alphanumeric changes.
. V11.05.29 08.09.2025 DA Sarkies        TSK 0965997
.           Added variable to set a rebook if required by appointment WPMNPL10
.           variable - RETDFRAE & SCRNAME
. V11.05.28 02.08.2025 DA Sarkies        TSK 0965457
.           Added check for entry in WPMNPL00 and increase count if present
. V11.05.27 30.07.2025 Ebon Clements     TSK 0963540
.           Open ICD10 ED 13 diagnosis file for bed request diagnosis tag
.           BQDIAG00
. V11.05.26 24/06/2025 Thah T            TSK 0959732
.           Added DFGEN000 to default Identifying Gender and Pronoun
. V11.05.25 03.07.2025 Ebon Clements     TSK 0962695
.           Read latest pattranf record for stat adm A01 - ADMS2000
. V11.05.24 23.06.2025 DA Sarkies        TSK 0947257
.           Updated patient transfer when claim accepted by ICWA
. V11.05.23 18/06/2025 Peter Vela        TSK 0962332
.           Save and restore values for pattran TWARD and TBED in UPPHSP00
.           (SAVETWRD/SAVETBED)
.           The incorrect TWARD and TBED were getting written to pattran in
.           STRNA0000
. V11.05.22 16/06/2025 J.Tan             TSK 0961932
.           Recompiled for WEBDINVS - Moved back SAVEND to FORM3
. V11.05.21 06/06/2025  J.Tan          TSK 0961638
.           Mod Public Hospital NOT to write to Previous Hospitalisation file
. V11.05.20 05/06/2025  Jacob Jackson    TSK 0960175
.           For WDIET000, check if statistical discharge
. V11.05.19 15/05/2025  Alina Bhari      TSK 0959524
.           Fixed the issue with unable to admit the patient with sex as
.           Not Stated - NEWR0000
. V11.05.18 19/05/2025  Ebon Clements    TSK 0960463
.           Recompiled for UPEADMVS - eAdmission document update by
. V11.05.17 30/05/2025  J.Tan          TSK 0961444
.           Mod UPPHSP00 updating Days of Hospitalisation in Adm.file
. V11.05.16 13.05.2025  DA Sarkies     TSK 0947257
.           Added CHCKCOMP to redirect workflow after MVA entered to
.           secondary insurer
. V11.05.15 07/05/2025  Nikitha B      TSK 0959601
.           Recomplied for PATMISTM.
. V11.05.14 01.05.2025  DA Sarkies     TSK 0947257 
.           Added variable to hold claim code for redirection in wahealth     
.           29.04.2025  Peter Vela     TSK 0960164
.           Fix assignment of WBOEELEG at HOEM9999 before UPWBOEM1
. V11.05.13 01.04.2025  DA Sarkies     TSK 0946536
.           Moved space to Included in Billing field for automatic Previous Hosp
. V11.05.12 26.03.2025  DA Sarkies     TSK 0946536
.           Added check for WRPMPHS1 and also updated code to automatically
.           record previous hospitalisations within range
. V11.05.11 06.03.2025  DA Sarkies     TSK 0955909
.           Added code to retrieve and record NDIS number in watespaf
. V11.05.10 21.02.2025  DA Sarkies     TSK 0884838
.           Added code to Add previous hospitalisation details when discharge
.           within time frame.
. V11.05.09 29/01/2025  Thanh T        TSK 0884838
.           Added supinsad
. V11.05.08 20/01/2025  Thanh T        TSK 0884838
.           Added SFA13500 and IPMCHA00
. V11.05.07 19.12.2024  DA Sarkies     TSK 0954547
.           Commented out <cat> tags to prevent browser incompatibility
. V11.05.06 05.12.2024  DA Sarkies     TSK 0951086
.           Increase size of number of days to 4 digits
. V11.05.05 03/12/2024  Nikitha B      TSK 0954602
.           Called CLPATATR at ADMS1400 to clear discharge time&date values.
. V11.05.04 26/11/2024  J.Tan          TSK 0946342
.           Recompiled for PATDISCH - Updating Inv.pending on visxdcaf
. V11.05.03 26/11/2024  Ebon Clements  TSK 0954547
.           Added <cat-c> start and end tag to category=XX tag
. V11.05.02 25.11.2024  Ebon Clements  TSK 0953786
.           Added identifying gender to ESIS patient details watespaf
. V11.05.01 21/11/2024 Thanh T        TSK 0951086
.           Recompiled for PATMI1FD changes
. V11.04.39 22/10/2024 Bella Turco     TSK 0952718
.           Allow Aliases with inactive cat G (Sex at Birth) to be deleted
.           DELNEW00
. V11.04.38 11/10/2024 J.Tan           TSK 0951331
.           Adding Eligibility Check Misc.charge on Admitting patient
. V11.04.37 23/09/2024 J.Tan           TSK 0950577
.           Recompiled for PATIPERH - Fixed issue with Hold Invoice audit
. V11.04.36 19/09/2024  Don Nguyen      TSK 0951703
.           Modified function that returns the ACC45 Claim API Response Message
.           to use an alternative to 'find' as it was having performance issues
.           (slowness) when following symbolic links; GARM0000
. V11.04.35 16/09/2924  Niitha Bhaskar  TSK 0950724
.           Replaced TDATE with ADATE at BLKD0000 to avoid discharging
.           before the last transfer movement for recurring care a visit.
. V11.04.34 10/09/2024  PJ Le Febour    TSK 0951406
.           Added CANUR315 to delete contacts(pmscexaf) when Cancel U/R   
. V11.04.33 27/08/2024  Bella Turco     TSK 0911922
.           Added Pref Surname to alias functionality UPALIA00            
. V11.04.32 22/08/2024 Alina Bhari     TSK 0941329
.           Copied the defence force detail from the prev visit when both       
.           visits have a Claim Type of Defence Force where Indicator 1 =D      
.           -COPYPDEF,CPYPAMIS,PROADM10                                         
. V11.04.31 19/08/2024  Bella Turco     TSK 0911922
.           Add Preferred Name as alias for New/Temp Registration UPALIA00
. V11.04.30 06/08/2024  Bella Turco     TSK 0911922                     
.           Added UPALIA00 to update alias for new Preferred Given Name  
. V11.04.29 22/07/2024  Peter Vela      WEBPAS / ORBIS UI R&D 0949702
.           Added WEBPAS FHIR API Patient Resource POST/PUT functionality
. V11.04.28 22/07/2024  Ebon Clements   TSK 0949287 
.           Added update of ED visits aaede1af claim code ADACOMP UPCLTY00
. V11.04.27 27.05.2024  Jaocb Jackosn   TSK 0948535
.           Recompiled for PATMSXTM
. V11.04.26 25/06/2024  Jaocb Jackosn   TSK 0948238
.           Ensure right variable is used and array does not surpass declared
.           usage
. V11.04.25 25/06/2024  Jacob Jackson   TSK 0948238
.           Clear with ZERO instead of SP70 for SCHDCARR 
. V11.04.24 25/06/2024  Jacob Jackson   TSK 0948238
.           Ensure that arrays that are using prtform function are being cleared
.           Ensure prtform2 can be printed even if prtform1 can't be
. V11.04.23 17/06/2024  Jacob Jackson   TSK 0947689
.           Fix problem where only one form was printing even when both
.           options were checked
. V11.04.22 30/05/2024  Thanh T         TSK 0939982 
.           Added SFA13400 and UTPRFA00 
.           30/05/2024  Don Nguyen      TSK 0947423
.           Added -L option for the find command to follow symbolic links with
.           GARM0000 - Get the ACC45 Claim API Response Message from .resp file
. V11.04.21 14/05/2024  Bella Turco     TSK 0941305
.           Writes pmsoosaf record when registering new patient (NEWREG00)
.           14/05/2024  Thanh T         TSK 0941543
.           Recompiled as PMSPX2TM changes
. V11.04.20 01/05/2024  Jacob Jackson   TSK 0941762
.           Allow server to receive empty MRFDDATE values to be updated
. V11.04.19 30/04/2024  Bella Turco     TSK 0943738
.           Demographics Last Updated fields are now updated even when
.           Confirmed Demographics Date is blank (UPDMAS3)
. V11.04.18 26/04/2024  Jacob Jackson   TSK 0941762
.           Recompiled for PATECDFD
. V11.04.17 24/04/2024  Jacob Jackson   TSK 0941762
.           Upload and display "Reason for Discharge Delay" input value to
.           VSXDCOD2
. V11.04.16 12/04/2024  Davin           TSK 0931586
.           Added read on pmsvx1 for hl7 when registering ED patient (NEWREG00)
. V11.04.15 09/04/2024  Bella Turco     TSK 0914658
.           Added UPINSU00 routine to auto-update insurance code when MVIT
.           status is Confirmed
. V11.04.14 08/04/2024 Thanh T         TSK 0940239
.           Added TABL0500 for Medically Cleared for Discharge History
.           list
. V11.04.13 26/03/2024  Bella Turco     TSK 0914658
.           Added new tag SFA12900 for returning Visit Type and Status
. V11.04.12 26/03/2024  Bella Turco     TSK 0914658
.           Added new include MVITCONF
. V11.04.11 20/03/2024  Jacob Jackson   TSK 0914658
.           Ensure update of PMEXUYN1 only occurs when parameter has
.           valid value
. V11.04.10 13/03/2024  Ebon Clements   TSK 0914658
.           Only update the claim code of the last transfer file record
.           UPTRAN00
.           06/03/2024 Bella Turco      TSK 0914658
.           Fix problem with server not reading printer parameters
.           Change logic to allow multiple printers to be saved
.           for MV templates
.           Add new tag SFA12700 for accessing PMCHREAS
.           On certain circumstances, add manual update for PMEXUYN1
.           Call UPCLTY00 on pmsextaf write as well as update
.           Update PMEXCLAM to Alternate Election when status is Confirmed
.           (UPCLTY00)
.           Added pmsextaf read before UPPMEXT1 in UPCLTY00 to stop error
.           13/03/2024 J.Tan
.           Added HF History
. V11.04.09 04/03/2024  PJ Le Febour   TSK 0929044dc
.           REWOEC00 - populate WBOCCUID with USERID
.           update WBOCUUID WBOCUDTE WBOCUTIM before call WRWBOEC1
.           update WBOCUUID WBOCUDTE WBOCUTIM before call UPWBOEC1
. V11.04.08 29/01/2024  Jacob Jackson  TSK 0919335
.           Add HF History includes
. V11.04.07 29/01/2024  Jacob Jackson  TSK 0919335
.           Add new local variable and recompile for GETTFEES
. V11.04.06 10/01/2024 Thanh T         TSK 0936263
.           Recompiled for DGCLICAC changes
. V11.04.05 14/12/2023 Bella Turco     TSK 0914658
.           Added UPCLTY00 - updates Claim Code if ICWA Status is Confirmed
. V11.04.04 01/12/2023  Peter Vela     TSK 0935874
.           Removed ability to execute auto NIHC IHI lookup on Quick Reg
. V11.04.03 30/11/2023  Ebon Clements  TSK 0925492
.           Recompile for BEDBDPRO - Multiple theatre bookings per admission
. V11.04.02 29/11/2023 Thanh T                TSK 0932689
.           Recompiled for MRTVISFD changes
. V11.04.01 28/11/2023 J.Tan          TSK 0939602
.           Recompiled for PATDSBFE - set default Hos.id for pre-adm(multi hosp)
. V11.03.27 09/11/2023 Peter Vela     TSK 0935874
.           Added single hospital / multi hospital validation in 
.           before WRPMNPL1 for NIHC IHI Lookup
. V11.03.26 06/11/2023 Jacob Jackson  TSK 0914658
.           Add SFA12600 tag for dealing with redirect value PMEXT049, 
.           also add logic to ensure claim details are correctly read
. V11.03.25 25/10/2023 Ebon Clements  TSK 0939169
.           Only generate OEC for non blank admission numbers - REWOEC00
. V11.03.24 11/10/2023 Thanh T        TSK 0935874
.           Changed UPPRE020, UPMAD210, ADMP8000, REGNEW50 to comment out
.           the codes for PTCNUNET = '1' since it is no longer used 
. V11.03.23 10/10/2023 Jacob Jackson   TSK 0914658
.           Add new tag SFA12500 for access to PMEX0000 tags 
.           05/10/2023 Thanh T         TSK 0935874
.           Changed REGNEW00 to Write a record to the pmsnplaf Table for
.           new registration patient. Changed UPMAD000 to Write a record 
.           to the pmsnplaf Table when surname, given names, sex, DOB, 
.           medicare number or medicare IRN is changed. 
. V11.03.22 09.10.2023  Alina Bhari    TASK 0937677
.           Didn't allow new admission date and prev discharge date to be same
.           - ISIN8000
. V11.03.21 21.09.2023  DA Sarkies     TASK 0935885
.           Added code to accept a slash in the claim number, as well as no
.           slash
. V11.03.20 20.09.2023  DA Sarkies     TASK 0935885
.           Increased warning for the claim number. 
. V11.03.19 05.09.2023  DA Sarkies     TASK 0935885
.           Increase size of TAC Claim Number by 1.
. V11.03.18 21/08/2023  J.Tan          TASK 0935226
.           Recompiled for PATDISCH - Set PMMRARDT to disc.date
. V11.03.17 10/08/2023  Nikitha B      TSK 0935669
.           Added WTEEMANU,WTEEPTWT,WTEESGID,WTEERADT,WTEETCMP at CLRWTESE
. V11.03.16 28/07/2023  Ebon Clements  TSK 0935527
.           Recompiled for OPRQUEFD - Theatre booking hospital
. V11.03.15 26/07/2023  Bella Turco    TSK 0926218
.           Added check for different Demographics Confirmed Date time and 
.           userID before writing to pmsdauaf in SJGAU240
. V11.03.14 11/07/2023  J.Tan          TSK 0931036
.           Mod to write to Pending prior checking date in Period file
. V11.03.13 10/07/2023  Ebon Clements  TSK 0931036
.           Open ICD10 ED 12 diagnosis file for bed request diagnosis tag
.           BQDIAG00
. V11.03.12 04/07/2023  Peter Vela     TSK 0931539
.           Added validation for QUALSTAT = A in VCAQS000
. V11.03.11 14/06/2023  Don Nguyen     TSK 0928367
.           Recompiled for CALCCODE; Re-worked code to round up ICU & NCU hrs
. V11.03.10 08/06/2023  Ebon Clements  TSK 0933631
.           Changed SESSKEYS from DIM 19 to DIM 22 - NEWREG00 redirect
. V11.03.09 17/05/2023  Don Nguyen     TSK 0928367
.           Recompiled for CALCCODE; Rounded up ICU & NCU hrs for Vic
.           17/05/2023  Ebon Clements  TSK 0932616
.           Recompiled for PMSPX2TM - Current IP
. V11.03.08 12.05.2023  DA Sarkies     TSK 0928369
.           Added a check to determine whether the patient has a valid
.           NDIS Card
. V11.03.07 04/04/2023  Bella Turco    TSK 0911166
.           Recompiled for PATIPERH - Hold Invoice Audit
. V11.03.06 07/03/2023  Peter Vela TSK 0909393
.           Changed KEY for oprsesaf reads
. V11.03.05 06/03/2023 Jacob Jackson   TSK 0918711
.           Recompiled for PATMASTM
. V11.03.04 17/02/2023 Ebon Clements   TSK 0929172
.           Added current theatre booking exits tag - CANDET60
. V11.03.03 01/02/2023 Ebon Clements   TSK 0917166
.           Added EDWARD baby update details trigger to admissions
.           EDWB0000 - EDWDBABY
. V11.03.02 31/01/2023 Ebon Clements   TSK 0924381
.           Recompiled for PATCOMN2 - location file name update
. V11.03.01 13.12.2022 DA Sarkies      TSK 0919347
.           Added EXTIM001 to compile for OPRARDTM
. V11.02.34 13.12.2022 DA Sarkies      TSK 0919347
.           Added EXTIM001 to compile for OPRARDTM
. V11.02.33 04.11.2022 DA Sarkies      TSK 0924316
.           Switched a couple lines that were accidentally removed
. V11.02.32 04.11.2022 DA Sarkies      TSK 0924316
.           Commented out IF statement so that USERID and Times in UPDMAS3
.           are always recorded on an update.
. V11.02.31 29/09/2022 Thanh T         TSK 0913180
.           Changed ADMS0000 to update the patmi1af.ADYHOSP and
.           patmi1af.PTMI3BDY day fields depending on the indicator 9 of 
.           the Category DD for discharge destination
. V11.02.30 28.09.2022 DA Sarkies     Task 0889650
.           Added CGI variable REFREJCT as a flag for a rejected referral   
. V11.02.29 06/09/2022 Ebon Clements  Task 0923776
.           Don't update visit extn H/F member number in VISPST00 it will be
.           done in the next routine UPMEMB00
. V11.02.28 23/08/2022 Jill Parkinson Task 0913560
.           Changed CHKTIM00 to use fromtime>endtime to decide if overnight
.           instead of overnight indicator (issue with which time was overnight)
. V11.02.27 07/28/2022 Alina Bhari     TSK 0922408
.           Fixed the issue with writting comments when diet comment field
.           is empty - SFAX6300
. V11.02.26 07/07/2022 Alina Bhari     TSK 0921297
.           Added and displayed medically ready for discharge date         
.           - UXDC0000,SFA12200                                            
. V11.02.25 15/06/2022 Thanh T         TSK 0893159
.           Added RECATR00, DISWRD00 for Recurring Care Specified Admission
. V11.02.24 06/06/2022 Thanh T         TSK 0893159
.           Added RECATR00, DISWRD00 for Recurring Care Specified Admission
. V11.02.23 08/06/2022 Thanh T         TSK 0920104
.           Fixed issue with Demographic Last updated time not updating
.           correctly on Update
. V11.02.22 19/05/2022 J.Tan           TSK 0837128
.           Recompiled for PRFAINSR - to use Cat CL indic 24
. V11.02.21 16/05/2022 Davin           TSK 0915902
.           Added hl7 message trigger when updating ACC details (ADET9000)
. V11.02.20 10/05/2022 Alina Bhari     TSK 0916986
.           Corrected the age of patient created through the inpatient search
.           -REGNEW20
. V11.02.19 04/05/2022 Jacob Jackson   TSK 0864505
.           Remove unnecessary ALPR0000 call
. V11.02.18 29/04/2022 Ebon Clements   TSK 0888071
.           Added PMVXADMP,PMVXCONO and PMVXMEDH to CLPV0000 and CLRVXS00
. V11.02.17 26/04/2022 J.Tan           TSK 0837128
.           Mod Default PRFA based on Claim type (PRFAINSR)
.           28/04/2022 Don Nguyen      TSK 0301017
.           Modified MVMED000 (Move Medical Record) for multi-hospital and fixed
.           bug when admitting to a ward with a bed selection also.
. V11.02.16 20/04/2022 Ebon Clements   TSK 0916756
.           Recompiled for PATCOMN2 - location file name update
.           19/04/2022 Jill Parkinson Task 0915984 
.           Mods to allow N as HDP for Cat A in NEWR0000     
. V11.02.15 08/04/2022 Jacob Jackson   TSK 0864505
.           Add ALPR0000 call when registering a new patient
. V11.02.14 31/03/2022 Thanh T         TSK 0903453
.           Added WAUDT800 to write out death audit table for type 008  
. V11.02.13 30/03/2022 Don Nguyen      TSK 0301017
.           Added new routine (MVMED000) to auto track (move) the medical record
.           to the admitting ward on patient admission.
.           Added new remote script routine (REMOTE20) to verify that the
.           'MR Current Location' is the same as the ED Site 'Default MR
.           Request Location'.
.           Fixed bug in PMAU0000 where SP70 was being overwritten.
. V11.02.12 15/02/2022 Peter Vela      TSK 0914306
.           Fixed assignment to WBOEELEG in HOEM0000
. V11.02.11 14/02/2022 Peter Vela      TSK 0914306
.           Recompiled for WEBOMST - Fixed assignment of WEBMS019
. V11.02.10 11/02/2022 Thanh T         TSK 0877055
.           Changed DEATHA00 to be called only when addraudt = 1
. V11.02.09 11/02/2022  Jill Parkinson Task 0916636
.           Modified to exclude VAED validations for boarders (NEWR0000)
. V11.02.08 10/02/2022  Thanh T          TSK 0905641
.           Recompiled as OUTHEDFD/OUTMA1FD changes
. V11.02.07 09/02/2022 Ebon Clements   TSK 0915508
.           Added PMSVX079 employment status to CLRPAR00 and SETPAR00
. V11.02.06 08/02/2022 P.Le Febour     TSK 0914583
.           Amended PROADM60 template 030 CALL VALDPO00 post op bed valid
. V11.02.05 07/02/2022 Peter Vela      TSK 0914306
.           Added missing variables for OEC-ECM
. V11.02.04 07/02/2022 Ebon Clements   TSK 0915508
.           Only use current admission inform GP value for stat admission
.           if not received - PTVIS022 ADMS1200
. V11.02.03 03/02/2022 Thanh T         TSK 0877055
.           Changed DEATHA00 to write out pmsaudaf for Patient Residential
.           changes
. V11.02.02 01/02/2022 Ebon Clements   TSK 0888071
.           Added output of clinical documents exits indicators. Admission
.           paperwork, Medical history and consent - OBSV0000
.           20/01/2022 Jacob Jackson   TSK 0864505
.           Add PTCNNMPR to determine which part of template to render
.           Recomplied for changes in IBACOMM & IBACOMN - preferred name reports
.           19/01/2022 Ebon Clements   TSK 0888071
.           Added visit entension file cgi vars PTVIS136, PTVIS137 and PTVIS138
.           14/01/2022 P.Le Febour     TSK 0914583
.           Changed ADMP0000 include CALL VALDPO00 post op bed validation
.           20/12/2021 Peter Vela      TSK 0914306
.           Added Medicare WebServices OEC-ECM
. V11.02.01 28/01/2022 Thanh T         TSK 0877055
.           Changed DEATHA00 to write out pmsaudaf for Patient postal address
.           changes
. V11.01.39 20/12/2021 Thanh T         TSK 0877055
.           Added DEATHA00 to write out pmsaudaf for Patient postal address
.           changes
. V11.01.38 20/12/2021 Thanh T         TSK 0877055
.           Added DEATHA00 to write out pmsaudaf for Patient postal address
.           changes
. V11.01.37 20/12/2021 Don Nguyen      TSK 0875549
.           Recompiled for changes in ACCEXTRA - Use PTCDUDF8 for HPI Org Number
. V11.01.36 13/12/2021 Thanh T         TSK 0877055
.           Changed SJGAU200 for demographic confirm PMI enhancement
. V11.01.35 01/12/2021 Don Nguyen      TSK 0875549 
.           Recompiled for changes in ACCEXTRA
.            - Write ACC Claim Lodgement record before submitting to API
. V11.01.34 10/11/2021 J.Tan           TSK 0880410
.           Mod for System Health fund on hold invoice (PATIPERH)
.           29/11/2021 Jacob Jackson   TSK 0882972
.           Recomplied for changes in PATMASTM and PMSPX2FD around Secure
.           Address functionality
. V11.01.33 12/11/2021 Don Nguyen      TSK 0875549
.           Recompiled for changes in ACCEXTRA (JSNCLM00) around Work Capacity
. V11.01.32 05.11.2021 DASarkies       TSK 0912682
.           Fixed some malformed tags in DMBS0000
. V11.01.31 04/11/2021 Thanh T         TSK 0889595
.           Changed SJGAU250 to fix issue with writing out incorrect
.           Death Audit data for type 7            
. V11.01.30 22/10/2021  Don Nguyen     TSK 0875549
.           Recompiled for changes in ACCEXTRA (JSNCLM00)
.            - Added logic to omit "workCapacity" if not in paid employment
. V11.01.29 29/09/2021  J.Tan          TSK 0901515
.           Recompiled for CMXMATRX - Added Primary Proc.to Matrix
. V11.01.28 27/09/2021 Thanh T         TSK 0889595
.           Recompiled for DEATHAUD changes
. V11.01.27 14/09/2021 Thanh T         TSK 0889595             
.           Changed SJGAU200 to add Alias status field PMDEFL08 
. V11.01.26 13/09/2021  Don Nguyen     TSK 0875549
.           Recompiled for changes in ACCEXTRA (ACCXML00) - Write new 'acclodaf'
.           record for API (JSON) claim error.
. V11.01.25 13/09/2021  Ebon Clements  TSK 0910279
.           Recompiled for BEDBDVCD (BEDBDPRO) - Post Op Ward
. V11.01.24 27/08/2021  Ebon Clements  TSK 0910383
.           Recompiled for BEDBDVCD (BEDBDPRO) - Post Op / Expected Ward 
. V11.01.23 26/08/2021  Ebon Clements  TSK 0910526
.           Changed PTMAS046 to and DIM and to use a Z70 clear
. V11.01.22 18/08/2021  Ebon Clements  TSK 0884918
.           Use the expected dicharge date for the bed management bed board if
.           it's a current admission instead of ADTATE plus ASTAY - UPPBMN00 
. V11.01.21 17/08/2021  Don Nguyen     TSK 0875549
.           Recompiled for changes in ACCEXTRA.
.           Added include (ACCJSONV) for ACCEXTRA / ACCXML00.
.           Modified GETV0900 to cater for new Failed status values (FAILED1-5).
.           Added new tag (GETV0903) to output all Status select option values.
.           Added new tag (SFA11600) for ACC API response message.
. V11.01.20 02/08/2021  J.Tan          TSK 0888546
.           Mod default Surgeon for adding procedure (multi theatre booking)
. V11.01.19 26/07/2021  J.Tan           TSK 0888546
.           Mod updating NZSPUNTH for NZ multiple theatre booking (WRNZP200)
.           Mod SECP0000 to check for multi theatre booking (THEATREF)
. V11.01.18 22/07/2021  Ebon Clements   TSK 0909330
.           Recompiled for BEDBDPRO - Post op ward
. V11.01.17 16/07/2021  Ebon Clements   TSK 0908119
.           Added read of parameter PTCNCHOD - Capture HouseKeeping on Discharge
. V11.01.16 07/07/2021  J.Tan           TSK 0908588
.           Recompiled for CMXMATRX - Exclude Unqualified days for Casepayment
. V11.01.15 02/07/2021  Thanh T        TSK 0905755
.           Recompiled as BEDBDPRO changes
. V11.01.14 02/07/2021  Thanh T        TSK 0901286
.           Changed to use address and postcode from pmscexaf using XCON0000
.           instead of patmx1af when the new contacts parameter is turned on
. V11.01.13 08/06/2021  J.Tan          Task 0900650
.           Fixed trap around leave register reads
. V11.01.12 21/05/2021  Thanh T        TSK 0873184
.           Added SEENDTIM, TESTDTIM, EMCNPBSD for EMRVISTM changes 
. V11.01.11 17/05/2021  J.Tan          TSK 0903875
.           Mod to update Unknown GST file
. V11.01.10 11/05/2021  Thanh T        TSK 0886023
.           Changed AMHATR00 to update patatraf if exists
. V11.01.09 10/05/2021  J.Tan          TSK 0903326
.           Added a tag to return NZ Contract (CNTRFLAG=1)
. V11.01.08 07/05/2021  Thanh T        TSK 0895165
.           Fixed NDIS card is automatically added issue
. V11.01.07 27/04/2021  Thanh T        TSK 0895165
.           Recompiled for OPRARDFD changes
. V11.01.06 20/04/2021  Thanh T        TSK 0901851
.           Changed WASF0000 to cater for Funding qualified/unqualified 
.           new born
. V11.01.05 13/04/2021 Jill Parkinson Task 0902601 
.           Mods to allow F as valid funding source in WASF0000
. V11.01.04 07/04/2021  Thanh T         TSK 0900995
.           Added SFA11500 to return NDIS type 
.           07/04/2021  Tracey Nguyen   TSK 0901515
.           Recompiled for PMSCMTFD - Added new fields
.           a) 1 File type for ICD procedure (PMCCIPF)
.           b) 3 new CMBS Field Type (PMCCFTS4/PMCCFT5C/PMCCFT6C)
.           c) 3 new CMBS Codes From (PMCCPC4F,PMCCSC5F,PMCCTC6F)
.           d) 3 new CMBS Codes To   (PMCCPC4T/PMCCSC5T,PMCCTC6T)
. V11.01.03 11/03/2021  Tracey Nguyen   TSK 0901515
.           Recompiled for PMSCMTFD - Added Primary ICD Procedure 1-5
.           (PMCCICP1-5)
. V11.01.02 26/02/2021  J.Tan          TSK 0903267
.           Recompiled for NZPSPRTM - Theatre duration
. V11.01.01 15/02/2021  Thanh T         TSK 0899715
.           Changed NZPC0000 to return the select procedure description
. V11.00.39 12/02/2021  Thanh T         TSK 0899715
.           Changed NZPC0000 to add new column for procedure description
. V11.00.38 09/02/2021  J.Tan           TSK 0898692
.           Added UPNZP000 - Update NZ Procedures on Update preadm
. V11.00.37 28/01/2021  Thanh T         TSK 0873541
.           Added SFA11400 to return PTMXCTIM  
. V11.00.36 15/01/2021  Thanh T        TSK 0878747
.           Fixed issue with Multiple birth icon show wrong in the banner
. V11.00.35 14/01/2021  J.Tan           TSK 0899807
.           Mod CHKTIM00 to check for Blank End Time
. V11.00.34 12/01/2021  Ebon Clements   TSK 0901440
.           Fixed deposit file read comdepaf index 2 key size - KEY26
. V11.00.33 17/12/2020  Thanh T         TSK 0873541
.           Added SFA11300 and SUPRFUNC field
.           21/12/2020  Tracey Ngyen    TSK 0888079
.           Recompiled for PMSVSCTM
. V11.00.32 15/12/2020  Thanh T         TSK 0868699
.           Added SFA11200 for NDIS number
. V11.00.31 15/12/2020  Thanh T         TSK 0868699
.           Added SPMSX520 and ANDIS000 for NDIS patient and number
. V11.00.30 14/12/2020  J.Tan           TSK 0899807
.           Mod SETSPR00 Not to update thea duration if Surgery end is blank
. V11.00.29 10/12/2020  Thanh T         TSK 0868699
.           Added ANDIS000 for NDIS patient and number       
. V11.00.28 08/12/2020  Tracey Nguyen   TSK 0888079
.           Fixed incorrect mapping of ICD code to AMBS - GXDF0000
. V11.00.27 03/12/2020  Davin          TSK 0890602
.           Moved routines to PREADCAN for use in HL7RECVR and PATWEB89
. V11.00.26 Changed SFA10900 and SFA11000 to get the active mulitple 
.           birth details
. V11.00.25 24/11/2020 Tracey Nguyen   TSK 0888079
.           1)Added tag SFA11100 based on tag SFAL8500
.           2)Recompiled for PATMISTM and PMSVSCTM
. V11.00.24 Changed LMLBRA00 to return DIM16 for "Order Not Stated" instead
.           of "Not Stated"
. V11.00.23 10/11/2020  J.Tan           TSK 0899562
.           Recompiled for CMXMATRX - setup date for reading MBS item
. V11.00.22 02/11/2020  Thanh T        TSK 0878747
.           Added MBRTH000 SPMAS860 SPMAS870 SFA10900 and SFA11000 for
.           multiple birth
. V11.00.21 22/10/2020  J.Ta           TSK 0898866
.           Recompiled for PATIPERH - on hold invoice
. V11.00.20 14/10/2020  Ebon Clements  TSK 0890602
.           Added SUPERLEV cgi for MOSAIQ supervisor menu options
. V11.00.19 29/09/2020  J.Tan          TSK 0896829
.           Recompiled for CMXMATRX - use National(PTPGNDRG)DRG
. V11.00.18 28/09/2020  Ebon Clements   TSK 0870994
.           Mods for GBED0000 for stat discharge to not populate casepayment 
.           Yes from the health fund
. V11.00.17 22/09/2020  J.Tan           TSK 0895330
.           Recompiled for CMXMATRX - reposition read of Matrix table
. V11.00.16 24/08/2020  Peter Vela     Task 0895969
.           Added WebServices OECW
. V11.00.15 18/08/2020  Tracey Nguyen  Task 0887425
.           Allowed PTVIS022 (Inform GP) to have spaces as a valid value
.           (removed REP " 0",PTVIS022) in SPVIS220 
. V11.00.14 03/08/2020  Jill Parkinson Task 0870994
.           Mods for ISIN0000 for stat discharge to not re-read previous adm
. V11.00.13 28/07/2020  Jill Parkinson Task 0894488
.           Mods to set DIETDTYP and DIETCOMM to z70 and only use if on page
. V11.00.12 13/07/2020  J.Tan          Task 0894432
.           Mod ABF to use Current Effective date
. V11.00.11 23/06/2020  Peter Vela     Task 0878550
.           Validate for blank previous value for MyHR Consent in SJGAU200
. V11.00.10 17/06/2020  Jill Parkinson Task 0871656   
.           Added update of opdaasrc if ptcnubap=5
. V11.00.09 10/06/2020  Peter Vela        TSK 0878550
.           Added My HR Consent to PMI Audit
.           01/06/2020  Ebon Clements     TSK 0870994
.           Added selected visit statistical discharge functionality
.           ADMS1200
. V11.00.08 29/05/2020  Sunny          Task 0892340
.           Added PROFLD62 to use Category G for gender
. V11.00.02 16/05/2020  Jill Parkinson Task 0891216
.           Added write to pmsedwaf from ADDUAI00 - UPI alternate id
. V11.00.01 07/05/2020  Thanh T           TSK 0876574
.           Recompiled for PMSCEXTM/PMSCEXTD changes
. V11.00.05 21/04/2020  Ebon Clements     TSK 0890716
.           Added read of outbokaf for booked OP visits prior to TACC0000
.           call at UPCLMD50
. V11.00.04 09/04/2020  J.Tan             TSK 0868813
.           Mod to set PACFRMT to 3 for PKNAME
. V11.00.03 02/04/2020  J.Tan             TSK 0868813
.           Changed PKNAME to DIM80
. V11.00.02 17/03/2020 Tracey Nguyen  TSK 0887397
.           Recompiled for PATVISTM -  Added VISS6600 for PMVXUD13 
.           (Cat N - NDIS Participant flag)
. 11.00.01 24/02/2020  J.Tan             TSK 0838262
.           Added Effective from and to date to MBS Item file
.           02/03/2020  Thanh T           TSK 0880961
.           Changed CPEMR000 to show warning message when any of emrvcdaf
.           rows exist with emicactv=2 for copying  
. V10.15.14 10/02/2020  Ebon Clements     TSK 0887077
.           Added ptmis036 test to set of number of babies to ZERO for
.           pre admissions - PPRE2000 - APLUR
.           Added no bed file number of babies update to change admission
.           details - NOBD0000
. V10.15.13 03/02/2020  Ebon Clements     TSK 0870852
.           Added only default anaesthetist from cases staff option to 
.           DEFANA00
. V10.15.12 30/01/2020  Ebon Clements     TSK 0887539
.           Added systflag to referral next and previous - PREVRD00 and NEXTRD00
. V10.15.11 16/01/2020  Thanh T           TSK 0856646
.           Changed SFA10700 to use Category code CG instead of AC 
. V10.15.10 13/01/2020  Ebon Clements     TSK 0886191
.           Fixed save of pre admit from booking comments - UPVCM200 (VISCOMIN)
. V10.15.09 09/01/2020  Ebon Clements     TSK 0885440
.           Added patient not pre admitted test/error to the update
.           pre admission template 032 page load - OUADMF00
. V10.15.08 20/12/2019  Jill Parkinson    Task 0866392
.           Added call to SBED0000 from DISS0000 to validate new ward/bed
.           before performing a statistical discharge
. V10.15.07 13/11/2019  Peter Vela        TSK 0879283
.           Added validation for reciprocal patients in RESCLM00
. V10.15.06 11/11/2019  Ebon Clements     TSK 0873239
.           Changed PROADM60 patient not pre admitted error to call DEMOGR00
.           which redirects to patweb9801001
. V10.15.05 06/11/2019  Richa Phogat      TSK 0871656
.           Updated UPBKD000           
. V10.15.04 30/10/2019  Thanh T           TSK 0856646
.           Added SFA10200 to SFA10700, BQEXST00. 
. V10.15.03 11/10/2019  Thanh T           TSK 0856646
.           Recompiled for PMSBRQFD changes
.           15/10/2019  Tracey Nguyen     TSK 0881450
.           Commented out CHPR0820 to stop wrong visit number from being
.           updated when no Primary/Plan/Performed procedure is found
.           17/10/2019  Peter Vela        TSK 0878702
.           Added Pre admission from previous booking validation for hea in
.           UPVCM000. Don't delete old visit comments.
. V10.15.02 10/10/2019  Ebon Clements     TSK 0880973 0881435
.           Update OPDAATYP, OPDACTYP, OPDAPOWD and OPDAPOBD if the parameter
.           is set to update the booking - UPBKD000
.           If NZ only update the booking if it's a pre admission - UPBKD000
. V10.15.01 04/10/2019  Thanh T           TSK 0860841
.           Get MRCNROUN for CALCCODE
. V10.14.42 03/10/2019  Ebon Clements     TSK 0873239
.           Changed PROADM60 patient not pre admitted error to call ADMERR00
.           instead of WEBERR00
. V10.14.41 10/01/2019  Nicole Torrisi    TSK 0881960
.           Fixed setting of ACDISIDE in CPEMR000 for NZ
. V10.14.40 20/09/2019  Peter Vela        TSK 0826834
.           Added Z70 validation to PTMIS026 in HOEC0000
. V10.14.39 16/09/2019  Ebon Clements     TSK 0873239
.           Added pre admission status edit to pre admission update 
.           PROADM60 template 032
. V10.14.38 13/09/2019  Richa Phogat      TSK 0870756
.           Recompiled for ACCEXTRA - Added condition for accdiaaf.ACDICSYC=
.           3(READ) under XMLCLM65 when DIGHDPCD=0
. V10.14.37 10/09/2019  Peter Vela        TSK 0852291
.           Added query validation in BEDR0000
. V10.14.36 10/09/2019  Ebon Clements     TSK 0860952
.           Added vemdresi cgi to not update the ED visits resident status
.           PVIRESI when updating PMI master details. - VISPST00
. V10.14.35 09/09/2019  J.Tan             TSK 0857392
.           Recompiled for ABF invoice
. V10.14.34 05/09/2019  Thanh T           TSK 0879640
.           Changed INIT0000 to read the controlf for ALCNDAMR
. V10.14.33 27/08/2019  Thanh T           TSK 0879640
.           Changed LNKINP00 to call AMAS0000 to activate a waiting master
.           referral if the linked internal referral is active
. V10.14.32 21/08/2019  Davin          TSK 0870119
.           Default visitors/phone calls allowed for preadmissions (SVXDF000)
. V10.14.31 19/08/2019  Richa Phogat     TSK 0871656
.           Added condition under UPADM000 when PTCNUBAP=5
. V10.14.30 31/07/2019  Peter Vela       TSK 0874259
.           Validate for existing patwc1af record before update in DEWCOM00
. V10.14.29 30/07/2019  Richa Phogat   Task 0876834
.           Added UPALWC00 under WCAP0000 and UPWC0000 under ADET0000
. V10.14.28 31/07/2019  J.Tan           TSK 0857392
.           Mod for ABF Admitted 
. V10.14.27 22/07/2019  Jill Parkinson Task 0878412
.           Added EDWARD alias triggers
. V10.14.26 16/07/2019  Ebon Clements  Task 0877986
.           Added EDWARD health fund add/update trigger - EDWH0000 CHEDW000
.           Added 20 zero test to PTCNNSSI using EDWARD 
. V10.14.25 17/07/2019  Jill Parkinson Task 0878412
.           Added EDWARD delete alias  trigger
.           17/07/2019  Richa Phogat   Task 0876696
.           Moved all the fields relating to Verbal Consent and Authorised 
.           Representatives from UPCLV000 to CPCLV000
. V10.14.24 12/07/2019  Jill Parkinson Task 0877216
.           Removed change from 10.13.22 as checkbox is not returned if unticked
. V10.14.23 09/07/2019  Jill Parkinson Task 0878014
.           Added check for MHCNUSE to SFAX0800 to stop I*D
. V10.14.22 27/06/2019  Richa Phogat   TSK 0827947
.           Recompiled for NZPSPRTM
.           27/06/2019  Thanh T.       TSK 0876487
.           Changed OUADMF00 to check if the admission exists in patmi1af
.           or not for Template "030" (Change Admission). If it is not, 
.           show error message "Patient is not Admitted" 
. V10.14.21 13/06/2019  Peter Vela     TSK 0871798
.           Added PTCNEMPL validation to SAVEUSR7
. V10.14.20 06/06/2019  Richa Phogat   TSK 0871949
.           Added condition for TEMPLATE '030' under OUADMF12
. V10.14.19 06/06/2019  Thanh T.          TSK 0870674
.           Changed WRAR0000 to add LNKINP00 to update the referral status
.           from Waiting to Active. Added SFA10100
. V10.14.18 03/06/2019  Jill Parkinson Task 0873054
.           Added AMHATR00 - MH legal status attributes
. V10.14.17 30/05/2019  Don Nguyen      TSK 0871451
.           Added clear of PMVXCONF (Appointment Confirmed) to clear
.           routines (CLPV0000 & CLRVXS00); used to mark SMS confirmed.
. V10.14.16 28/05/2019  Nicole Torrisi  TSK 0861051
.           Changed to not calculate Expected Discharge Date when
.           Cat P Assoc Field 1 = 999
. V10.14.15 21/05/2019  Tracey Nguyen   TSK 0874934
.           Added defstatd flag when redirecting to patweb8901030.html
.           for sjog - WEBWAR00, MISX0300
. V10.14.14 03/05/2019  Jill Parkinson Task 0874143
.           Corrected write of 22 to pmsedwaf
. V10.14.13 29/04/2019  Peter Vela      TSK 0868836
.           Changed VAED dates back to 20190701
. V10.14.12 26/04/2019  Steve Armstrong  Task 0873749
.           Moved UPI WRPMAID1 so that it occurs prior to the patma1af
.           record being created, so that when the A28 message is triggered,
.           the UPI alternate ID exists and will be sent in the message.
. V10.14.11 24/04/2019  Richa Phogat   TSK 0869550
.           Updated ADET0000 by adding CKACCAUD
. V10.14.10 08/04/2019  Tracey Nguyen     TSK 0871443
.           Recompiled for PATATRTD/PATARTM
.           08/04/2019  Richa Phogat   TSK 0867466
.           Updated UPDVIS00 by moveing PTVIS131 to PTTRFSRC when not same
. V10.14.09 05/04/2019  Jill Parkinson Task 0872438
.           Mods to pack pmewtype with spaces in WREDW000 to stop I*D
. V10.14.08 01/04/2019  Richa Phogat   TSK 0871949
.           Added condition for TEMPLATE '032' under OUADMF12
. V10.14.07 27/03/2019  Jill Parkinson Task 0863524
.           Changed read of oprsemaf to use key 21 not key12
. V10.14.06 14/03/2019  Richa Phogat   TSK 0869550
.           Added ACCAUDFD/IO, CLACCAUD, AUDITYPE, ACCAUFLG, CHECKACC, MVACCINJ,
.           MVACCWRK, MVACCXML, MVACCUPD, MVACCREF, MVACCADD, WRACAUD1
.           18/03/2019  Peter Vela     TSK 0868836
.           2019 Stat Changes CHKINT00
.           22/03/2019  J.Tan            TSK 0857392
.           Changed RCP Transaction count from DIM3 to DIM5
. V10.14.05 13/03/2019  Tracey Nguyen  TSK 0863060
.           Recompiled for PATVISTM - Added VISS6400 & VISS6500
. V10.14.04 04/03/2019  Richa Phogat   TSK 0869551
.           Added PMWXVHCP, Recompiled for PATCLMTM
. V10.14.03 21/02/2019  Ken Bell       TSK 0869548
.           Recompiled for PATCLMTM - Added Diagnosis Codes for NZ template
. V10.14.02 15/02/2019  Don Nguyen     TSK 0821139
.           Recompiled for EMRVISTM - Modified Location selection list code
.           15/02/2019  Ebon Clements  TSK  0828972
.           Added set scanned medical record flag - scannedm
. V10.14.01 12/02/2019  J.Tan          Task 0836050
.           Allow multiple MBS items to OEC consent
. V10.13.22 18/01/2019  Jill Parkinson Task 0864975
.           Added check for ptmas067=z70 before updating ptmaukdd
. V10.13.21 10/01/2019  Thanh T.          TSK 0863964
.           Added SFA10000/WTPACM00
.           09/01/2019  Jill Parkinson Task 0864975
.           Added WREDW000 when adding an alias manually
. V10.13.20 03/01/2019  Jill Parkinson Task 0867688
.           Added WEAL0000 - EDWARD Visit alteration
. V10.13.19 05/12/2018  Nicole Torrisi    TSK 0866945
.           Added ADMTFLAG
. V10.13.18 27/11/2018  Richa Phogat   TSK  0865246
.           Updated DOWL6500 to move spaces to wmdate3 when conditions are not 
.           met
. V10.13.17 26/11/2018  Don Nguyen      TSK 0853817
.           Recompiled for PATCLMTM - Added Claim Status description (CLMF8700)
. V10.13.16 13/11/2018  Jill Parkinson Task 0866132
.           Recompiled for ACCEXTRA - increased Cause_Of_Injury to allow 255
. V10.13.15 07/11/2018  Don Nguyen      TSK 0853817
.           Modified DEWCOM00 (Delete Workers comp. details) to set
.           Claim Status to 'Cancelled' if only one visit for the Claim Number
.           exists (NZ Only); instead of deleting it.
.           05/11/2018  Ken Bell        TSK 0865239
.           Recompile for PATDISCH changes
. V10.13.14 24/10/2018  Steve Armstrong TSK 0863512
.           Recompiled for changes to DGCLICAE.
.           Also moved triggers DGCLICAE and DGCLICDI to be executed
.           after write/update of pmsvx1af record.
. V10.13.13 22/10/2018 Richa Phogat   TSK 0862593
.           Updated NEWPRE00 by calling RDEMVIS1
. V10.13.12 22/10/2018 Jill Parkinson Task 0864785
.           Only write wathisaf records when status is changing
. V10.13.11 10/10/2018 Ebon Clements  TSK 0860241
.           Only update MyHr consent for future visits if PMI changing
.           to No - MHRI0000 & UPMHRI00
. V10.13.10 19/09/2018 Richa Phogat   Tsk 0860241
.           Added UPMHRI00 to Update already admitted patient visit
. V10.13.09 14/09/2018 Jill Parkinson Tsk 0861535
.           Added write of 22 to edward alteration table for privacy indicator
. V10.13.08 06/09/2018  Tracey Nguyen    TSK 0861841
.           1)Added check to update patmx1af.ptmxslac in PADM1000,DOAD2000
.           2)Recompiled for PATMSXTM - Added MSXF6800 to output PTMSXSLAC
.             date format
. V10.13.07 06/09/2018  Richa Phogat   TSK 0862786
.           Recompiled for WEBGROUP - Removed bypass Morphology
. V10.13.06 27/08/2018  Ebon Clements    TSK 0855890
.           Added non multi hospital default ACC provider - SFAX6000
.           23/08/2018  Richa Phogat     TSJ 0860241
.           Added MHRI0000 to update current/future episode with new PMI level 
.           My HR Consent value
. V10.13.05 23/08/2018  Jill Parkinson   TSK 0861535
.           Added write of 20 and 21 records to pmsedwaf
.           Added PROFLD78,MISX0000,MHLSR000 to check MH LS Referral management
.           (Cat S Ind7=I) for HEA
.           23/08/2018  Tracey Nguyen    TSK 0852969
.           Removed changes made to use HEAVIEW1 as the value is not available
.           on page load to resolve the tag in LSREF000
. V10.13.04 22/08/2018  Nicole Torrisi   TSK 0861086
.           Fixed comparison of UNIQUEKY in CPROC000
. V10.13.03 20/08/2018  Ebon Clements   TSK 0861535
.           Changed PTMIS036 - cgi for pluratily of baby to test for Z70 
. V10.13.02 13/08/2018  Peter Vela     Task 0845218
.           Fixed PMI Audit to include new contacts
.           15/08/2018  Tracey Nguyen   TSK 0852969
.           1)Removed PROFLD78 as it is not used
.           2)Added HEAVIEW1 CGI variable to indicate view/validation
.             required for HEA
.           3)Modified LSREF000, MHREF0000 to validate Referral Source
.             (Cat S Ind7=I) for HEAVIEW1=1
.           4)Added GSREF000 to get first Referral Source from Cat S Ind7=I
.           16/08/2018  Richa Phogat    TSK 0851999
.           Recompiled for PMSPX2TM
. V10.13.01 03/08/2018  Ebon Clements   TSK 0850366
.           Recompiled for CLPMSPX2
.           26/07/2018  J.Tan            TSK 0848506
.           Changed PP Doctor from DIM6 to DIM10
. V10.12.41 20/07/2018  Jill Parkinson Task 0860686 
.           Removed open of IBAPOST1,PMSPHSA1,EOCLNKA1,IBAALVA1,ALLRSAA1,
.           ALLPCTA1
.           PMSDAUA2,PATURAD2,PATVCHA1,MRTMOVA1,PATDSCH3,PMSREGA1,OPRTSMA1,
.           OPRSEMA1
. V10.12.40 17/07/2018  J.Tan          TSK 0858170
.           Changed setting of PTMIS082 in ADMS0000 for CFEETYP=8 (No Charging)
. V10.12.39 13/07/2018  Peter Vela       TSK 0845218
.           Added PMI Audit functionality for SJOG
. V10.12.38 12/07/2018  Tracey Nguyen    TSK 0852969
.           Added PROFLD78 to call SFAX0000 to check MH LS in LSRE1000
.           12/07/2018  Ebon Clements    TSK 0850366
.           Recompiled for PMSPX2TM
. V10.12.37 11/07/2018  Richa Phogat     TSK 0859797
.           Added code under OUADMF00 to read PATQMHFD file, added CLPATQMH
. V10.12.36 11/07/2018  Ebon Clements    TSK 0854375
.           Allocate U/R to ED visit as soon as new U/R in generated - REGNEW00
. V10.12.35 05/07/2018  Tracey Nguyen    TSK 0845646
.           1) Added CANDET40 to check for visits with Post Discharge coding
.           2) Added CANDET50 to check for visits with a Booking
. V10.12.34 02/07/2018  Richa Phogat     TSK 0820199
.           Added check for UPDHFUND under UPDMAS00
.           05/07/2018  Thanh T          TSK 0857684
.           Recompiled for PATMISTM changes
. V10.12.33 03/07/2018  Thanh T          TSK 0858385
.           Recompiled for PATDISCH changes
. V10.12.32 27/06/2018  Thanh T          TSK 0858385
.           Recompiled for PATDISCH changes
. V10.12.31 26/06/2018  Jill Parkinson Tsk 0859012   
.           Added re-read of first oprdeaf record in SFLAG8650 as new tags
.           are looping oprdetaf and end up on incorrect visit
.           the correct record
.           26/06/2018  Ebon Clements    TSK 0845295
.           Recompiled for PATCHPRE - eReferral update
.           25/06/2018  Don Nguyen       TSK 0847015
.           Modified PREDET00 to call GETNZP00 for all pre-admission templates
.           21/06/2018  Steve Armstrong  TSK 0854259
.           Added bed request A08 HL7 message trigger into BEDR0000
.           (HL7TRGID = 6).
.           Fixed duplicate HL7TRGID value in UBOK0000 - updated
.           from FORTY to FORTY4.
. V10.12.30 19/06/2018  Nicole Torrisi   TSK 0857684
.           Recompiled for PATMASTM - Occupational Group in Comments
. V10.12.29 06/06/2018  Richa Phogat     TSK 0854297
.           Updated PREDET00 to include template '056' option under PREDET94
.           to avoid an error display
. V10.12.28 05/06/2018  J.Tan            TSK 0851006
.           Mod MY6KB000 to use indicator 1 of cat KB
. V10.12.27 29/05/2018  Thanh Tieu       TSK 0857496
.           Added CHKINT00 to check for intention to readmit
. V10.12.26 28/05/2018  Richa Phogat     TSK 0854297
.           Updated PREDET00 to include template '062', '072' option under 
.           PREDET94 to avoid an error display
. V10.12.25 23/05/2018  Richa Phogat     TSK 0854297
.           Updated PREDET00 to include template '054', '061', '071' option 
.           under PREDET94 to avoid an error display
. V10.12.24 21/05/2018  Peter Vela       TSK 0851006
.           Get mapped value from Category Y6 oprdetaf.opdausr1 and default to
.           Category KB pmsvx1af.pmvxuvth MY6KB000
. V10.12.23 18/05/2018  Thanh T.         TSK 0851528
.           Recompiled for PATVISTM changed
. V10.12.22 17/05/2018  Don Nguyen       TSK 0844685
.           Increased size of SRCHMEDI to cater for Medicare Reference No.
. V10.12.21 20/04/2018  Don Nguyen       TSK 0844685
.           Added tag output for SRCHMNAM (Second Given Name) and 
.           SRCHMEDI (Medicare No).
. V10.12.20 12/04/2018  Don Nguyen       TSK 0844685
.           Added test for blank UPINUMBR before calling ADDUAI00
. V10.12.19 04/04/2018  Richa Phogat     TSK 0854297
.           Updated PREDET00 to include template '005' option under PREDET94 to
.           avoid an error display
.           06/04/2018  J.Tan            TSK 0850453
.           I * H Too many files open
.           open and close NZPPFEA1,PATBRDA2,PATBRDA3,COMDEPA2,PATDNRA1
.           RCPDTEA6,RCPBNKA1
.           06/04/2018  J.Tan            TSK 0850063
.           Mod DEFANA00(default Anaesthetist) to check for Adhoc Theatre Sess.
. V10.12.18 04/04/2018  Davin            TSK 0844301
.           Initialise DSCHPALC to Z70 not SP70
. V10.12.17 29/03/2018  Don Nguyen       TSK 0844685
.           Added UPINUMBR as a new Alternate ID (if PTCNEPMI=1) for 
.           New Registration (NEWREG00 / REGNEW00) using ADDUAI00.
. V10.12.16 22/03/2018  J.Tan            TSK 0853108
.           Added DSCHRTOS - Ref on Separation
. V10.12.15 13/03/2018  Peter Vela       TSK 0852700
.           Added OEC Request indicator for Request Generated message ECLOEC00
. V10.12.14 09/03/2018  Don Nguyen       TSK 0844685
.           Added new tag output SFAX9500 (UPINUMBR) - UPI Number
.           06/03/2018  J.Tan            TSK 0310703
.           Mod to close/reopen files (CINVP0000)
.           28/02/2018  Peter Vela       TSK 0843363
.           Added MBS Codes check for oprdetaf in CMBS0000 and DMBC0000
. V10.12.13 22/02/2018  J.Tan            TSK 0310703
.           Mod UPMEMB00 - Changed HF public hospital to update Inv.pending
. V10.12.12 15/02/2018  Peter Vela       TSK 0849919
.           Added Completed Bed Request validation in BEDR2000
. V10.12.11 09/02/2018  Peter Vela       TSK 0843363
.           Added tag for qldmhdoc emergency SFAX9400
. V10.12.10 08.02.2018  B.G.Ackland      TSK 0837357
.           Added PTCNSZEC - Send ZEC segment in HL7 broadcasts
.           12.02.2018  B.G.Ackland      TSK 0837357
.           Added Trigger for I13 in TACC9000 after update of extra compensible details
.           07/02/2018  Peter Vela       TSK 0843363
.           Defaulted checkboxes in DMBH0000 to checked
.           08/02/2018  Jill Parkinson TSK 0846167  
.           Added write of type 16 to pmsedwaf             
. V10.12.09 07/02/2018  Richa Phogat     TSK 0844301
.           Added code under DMBS0000 to display all MBS value online
. V10.12.08 06/02/2018  Richa Phogat     TSK 0851527
.           Uncomment opening file PATWMAB3
. V10.12.07 06/02/2018  Richa Phogat     TSK 0851304
.           Added SFAX9300 to display an error message if any Diagnosis has a
.           blank side value
. V10.12.06 06/02/2018  Ebon Clements    TSK 0844997
.           Added recurring care tag for last attending dr for a unit - RECD0000
.           01/02/2018  Peter Vela       TSK 0843363
.           Added tags for patqmh in SFAX0000
.           30/01/2018  Jill Parkinson TSK 0846167
.           Added write to pmsedwaf - EDWARD PMI Alterations
. V10.12.05 29/01/2018  Peter Vela       TSK 0843363
.           Added Provisional MBS items to DMBH0000 ECLOEC00
. V10.12.04 24/01/2018  Peter Vela       TSK 0843363
.           Added tags for BKRXUFF1, BKRXUFF2, BKRXUFF3
.           24/01/2018  Steve Armstrong  TSK 0851340
.           Mods to trigger an I14 instead of an I13 at Trigger 42
.           when removing W/L entry instead of just cancelling a W/L Booking.
. V10.12.03 12/01/2018  Ebon Clements    TSK 0845295 
.           Added eReferral functionality  - cgi erefrlid
.           Fixed size of ADMISNID - Should be DIM 20
.           18/01/2018  Davin            TSK 0847438
.           Update pmsvx1af straight after moving in cgi variables (UPDVIS90)
. V10.12.02 11/01/2018  Don Nguyen       TSK 0846956
.           Added validation in GBED0000 to make sure patient not already
.           admitted into the bed (GBED7000); NEW error message GBED9831.
. V10.12.01 08/01/2018  Peter Vela       TSK 0843363
.           Added DMBH0000 , DMBC0000
.------------------------------------------------------------------------
. V10.11.41 27/12/2017  Steve Armstrong  TSK 0850165
.           Recompiled for changes to DGCLICAC.
.           28/12/2017  Ania P           TSK 0848601
.           Recompiled for changes to DGCLICAE
. V10.11.40 20/12/2017  Ebon Clements  TSK 0850453            
.           I * H Too many files open
.           Don't open PATBMDA4, PATBRDA4, DISPATA2, PATWMAB3
.           PATGSRN2, PATGSRN3, PATGSRN4, PATDRGA1
. V10.11.39 19/12/2017  Richa Phogat   TSK 0850144
.           Added new variables to store 30 char data from “patmx1af.ptmxadd2
.           patmx1af.ptmxadd4
.           Added code to update PATMA1FD when occupation is updated from 
.           Incident/Accident data screen
.           15/12/2017  J.Tan          TSK 0844301
.           Mod for Eclipse EOC extra MBS Codes
.           19/12/2017  Ebon Clements  TSK 0843363
.           Added using visit base interpreter - PTCNINTR
. V10.11.37 13/12/2017  Ebon Clements  TSK 0841602
.           Added bed request allocated bed tags - SFAX7600
. V10.11.36 07/12/2017  Richa Phogat   TSK 0849400
.           Recompiled for ACCEXTRA.PBL
. V10.11.35 06/12/2017  Richa Phogat   TSK 0831640
.           Retain EDD for cancelled Obstetric Pre-Admission(DOWL6500)
. V10.11.34 06/12/2017  Richa Phogat   TSK 0849400
.           Recompiled for ACCEXTRA.PBL
. V10.11.33 05/12/2017  Richa Phogat   TSK 0849400
.           Recompiled for ACCEXTRA.PBL
. V10.11.32 24/11/2017  Richa Phogat   TSK 0847509
.           Recompiled for PATCLMTM.PBL
. V10.11.31 20/11/2017  Peter Vela     TSK 0846923
.           Changed KEY100 to KEY200 in WEBWAR20
.           14/11/2017  Ebon Clements  TSK 0843363
.           Added write/update to QLD HDP mental health file - PTQMH000
.           Added admission diagnosis/Reason for admission write -  ADCM0000
.           23/11/2017  Ania P         TSK 0261630
.           Moved TFILNAME to CFNAMEDP in INIT0000
.           23/11/2017  Peter Vela     TSK 0845751
.           Added PTATRU00 to display BMI details without visit number
.           validation
. V10.11.30 14/11/2017  Don Nguyen     TSK 0816814
.           Recompiled for changes to ACCEXTRA (ACCXML00).
.           Added call to CLACCDIA.
.           Added SFAX6700 - Coding System Code select list
.           Modified CPEMR000 to copy over EMVCUDC1 and PTCNDSID (NZ only)
.           13/11/2017  Peter Vela     TSK 0847214
.           Recompiled for ACCEXTRA
. V10.11.29 03/11/2017  Jill Parkinson TSK 0841602
.           Corrected copying of pmsnutaf for statistical admission
. V10.11.28 31/10/2017  Peter Vela     TSK 0845751
.           Changed PATATR00 to validate BMI
. V10.11.27 31/10/2017  Jill Parkinson TSK 0841602
.           Put back update of ADYHOSP in ADMS0000 but not PTMI3BDY
. V10.11.26 25/10/2017  J.Tan          TSK 0841508
.           Added NZLT0900 - Session details for the Uniqueky
.           25/10/2017  Peter Vela     TSK 0843396
.           Recompiled for ACCEXTRA
. V10.11.25 24/10/2017  J.Tan          TSK 0842350
.           Changed setting of PTMIS082 in ADMS0000 for Public Hospital only
. V10.11.24 23/10/2017  Thanh T.       TSK 0845751
.           Fixed the BMI information not showing on PMI Detail screen.
. V10.11.23 19/10/2017  J.Tan          TSK 0846343
.           Added Contract Type (NZSPCLMN) to selectProcedure()
.           20/10/2017  Jill Parkinson TSK  0835482   
.           Added check for fhirtype to WEBWAR00
. V10.11.22 09/10/2017  Richa Phogat   TSK 0845211
.           Recompiled for ACCEXTRA.PBL
. V10.11.21 02/10/2017  Steve Armstrong  TSK 0816814
.           Recompiled for changes to ACCDIAFD
. V10.11.20 26/09/2017  Richa Phogat   TSK 0833462
.           Added code 'REMOTE00' to send email informing someone that Next ACC
.           number is with 200 of the last valid ACC number.
. V10.11.19 26/09/2017  Jill Parkinson TSK 0841602
.           Mods to copy condition when creating a statistical admission
. V10.11.18 15/09/2017  Richa Phogat   TSK 0841373
.           Recompiled for ACCEXTRA.PBL
. V10.11.17 14/09/2017  Richa Phogat   TSK 0839897
.           Added new variable DIGHDPCD  to save value of 'EMR Diagnosis HDP
.           Code. Recompiled for ACCEXTRA.PBL
. V10.11.16 12/09/2017  Richa Phogat   TSK 0842717
.           Recompiled for ACCEXTRA.PBL
.           12/09/2017  Thanh T.       TSK 0821710
.           Audit Amission/outpatient visit comments
. V10.11.15 12/09/2017  Richa Phogat   TSK 0841374
.           Updated PMWXUNFD to spaces when it has zero value in UPWRK000
. V10.11.14 11/09/2017  Ania P         TSK 0837582
.           Added PTCNUBAP=4 to UPBKD00
. V10.11.13 08/09/2017  Thanh T.       TSK 0821710
.           Removed PATCOMDF/IO
. V10.11.12 07/09/2017  Thanh T.       TSK 0821710
.           Audit Amission/outpatient visit comments
. V10.11.11 06/09/2017  Richa Phogat   TSK 0844400
.           Recompiled for ACCEXTRA.PBL
. V10.11.10 24/08/2017  Davin          TSK 0837617
.           Added new I13 message trigger for Update Waiting List (DGCLIUWL)
. V10.11.09 17/08/2017  Richa Phogat   TSK 0842712
.           Recompiled for ACCEXTRA.PBL
. V10.11.08 15/08/2017  J.Tan          TSK 0841548
.           Mod UPRF0000 - set PRFA to patient name if Contact is blank
. V10.11.07 10/08/2017  Thanh T.       TSK 0821710
.           Audit Amission/outpatient visit comments
. V10.11.06 08/08/2017  Peter Vela     TSK 0837619
.           Added PMVXEAFL to CLPV0000, CLRVXS00
. V10.11.05 07/08/2017  Richa Phogat   TSK 0832291
.           Recompiled for ACCEXTRA.PBL
. V10.11.04 03/08/2017  Richa Phogat   TSK 0832291
.           Recompiled for ACCEXTRA.PBL
. V10.11.03 01/08/2017  J.Tan          TSK 0820199
.           Fixed option for updating PMI and Visit HF
. V10.11.02 31/07/2017  Ebon Clements  TSK 0833992
.           Added trap around patdadaf write - ADTD4000
.           26/07/2017  Thanh T.       TSK 0821710
.           Audit Admission/outpatient visit comments
. V10.11.01 13/07/2017  Thanh T.       TSK 0821710
.           Audit Admission/outpatient visit comments
.------------------------------------------------------------------------
. V10.10.15 11/07/2017  Jill Parkinson TSK 0841439
.           Corrected PRS2 error for qualification status for contracted patient
. V10.10.14 10/07/2017  Davin          TSK 0841809
.           Don't update visit doctor PMVXDOCT if PTVIS016 = Z70 (ADET8000)
. V10.10.13 28/06/2017  Ania P         TSK 0840783
.           Added output for PMCDCNUM to SFAX2055
. V10.10.12 21/06/2017  Davin          TSK 0836775
.           Recompiled for WEBGROUP - mental health legal status
. V10.10.11 20/06/2017  Ania P         CAR 261630
.           Recompiled for UPDUCARD.PBL
. V10.10.10 15/06/2017  J.Tan          TSK 0820199
.           Added option to update HF for Un-Invoiced Discharged visit
. V10.10.09 29/05/2017  Ebon Clements  TSK 0839299
.           Cancel bed requests when cancelling a pre admission - CNBRQ000
. V10.10.08 23/05/2017  Richa Phogat   TSK 0838700
.           Recompiled for ACCEXTRA.PBL
. V10.10.07 22/05/2017  Ania P         TSK 0823522
.           Added output for death details audit
. V10.10.06 18/05/2017  Davin          TSK 0321570
.           Added ward diet/comment functionality (wdiet000/sfax6200/sfax6300)
. V10.10.05 21/04/2017  Ebon Clements  TSK 0837221
.           Added MHCNUSE - Using MH system to report 7 - MEHVIS00
. V10.10.04 29/03/2017  Ebon Clements  TSK  0833052
.           Recompiled for PATMX1FD - New filed - Episode Special Purpose Flag
.           29/03/2017  Tracey Nguyen  TSK  0833454
.           Recompiled for PATATRTD/PATATRTM
. V10.10.03 22/03/2017  Peter Vela     TSK  0833050
.           Recompiled for PATVISTM
. V10.10.02 07/03/2017  Jill Parkinson TSK  0833992
.           Mods to return to RSPTBMD2 in DELBMD00
. V10.10.01 07/03/2017  Peter Vela     TSK 0833050
.           2017 Statutory Changes
.           Recompiled for PATVISTM
.           Added Criteria of Admission validations to VASCA000, VATCA000
.           VCAAG000, VCACT000, VCAQS000          
.           09/03/2017  J.Tan          TSK 0310703
.           Mod Public hospital to check claim code ind12 for pending invoice
. V10.09.12 01/03/2017  Ebon Clements  TSK 0834347
.           Fixced I * A on diet date update - UPCAT000
. V10.09.11 28/02/2017  Don Nguyen     TSK 0808741
.           Recompiled for PATDISCH - Modified MVEN0000 to call CHRS0000
.           Added FORM5C & FORM5P2
. V10.09.10 24/02/2017  Ebon Clements  TSK 0833864
.           Check for duplicate key on diet date update - UPCAT000
. V10.09.09 18/01/2017  J.Tan          TSK 0808741
.           Recompiled for PATDISCH - Checking for Ventilation hours
. V10.09.08 29/11/2016 J.Tan          TSK 0825247
.           Mod SECP000 - to clear OPDAPRV3 & IODADES3 if same as OPDAPRV2/DES2
.           Added CKDE0000 - to update OPDAPRV/OPDADES after unperformed proc.
. V10.09.07 05/01/2017  Jill Parkinson TSK 0814744
.           Added input and output of EMEXP001 for emergency expect patient reg
. V10.09.06 28/12/2016  Jill Parkinson TSK 0828192
.           Added clear of PTMIDMOV so medical records appear on
.           pulling lists when patients have the admission date changed
. V10.09.05 22/12/2016  Davin             TSK 0814504
.           Update diet tables (UNUT0000) after booking update (UPBKD000)
. V10.09.04 21/12/2016  Jill Parkinson TSK 0822329
.           Changed to not update all acc details for Authorised Rep fields
. V10.09.03 16/12/2016  Peter Vela     TSK 0830070
.           Added nz validation for BKREWARD assignment in UPBKD000
. V10.09.02 29/11/2016  Jill Parkinson TSK 0822329
.           Added output of Default Treating Provider
. V10.09.01 29/11/2016  Jill Parkinson TSK 0822329
.           Added input of new acc fields
.           Added write of ACC Purchase Order Number when admitting
. V10.08.29 22/11/2016  Nicole Torrisi TSK 0814468
.           Recompiled for changes to ACCEXTRA - remove post code
. V10.08.28 22/11/2016  Ebon Clements  TSK 0828226
.           Always check/complete bed requests on admission.
.           Removed test for PTCNBEDM - BEDR0000
. V10.08.27 18/11/2016  Peter Vela     TSK 0827671
.           Added single space after Parent of <Initial>.
.           before write to patre1af
. V10.08.26 08/11/2016  Ebon Clements  TSK 0825010
.           Added U/R already allocated to ED visit edit - VEDU0000
.           27/10/2016 J.Tan          TSK 0308496
.           Mods to Copy previous Mental health details for QLD (CPMH0000)
. V10.08.25 27/10/2016 J.Tan          TSK 0292044
.           Mods SECP000 - Not to update bokrx1af and bokdiag
. V10.08.24 27/10/2016  Davin          TSK 0824773
.           Added EMERFLAG for NZ emergency redirects
. V10.08.23 21/10/2016  Davin          TSK 0814504
.           Update diet tables with new date if preadmission changes (UNUT0000)
.           Added extra diet details for UNUT0000 (UPCAT000/catcomaf)
. V10.08.22 21/10/2016  Steve Armstrong  TSK 0315509
.           Added initialisation of MESSFLAG into CLRPAR00 and also added
.           call to CLPATVIS in CLRPAR00.
. V10.08.21 19/10/2016  Peter Vela    TSK 0827811
.           Initialised PMOEELEG to SP70 at ECLOEC00 
. V10.08.20 17/10/2016  Ebon Clements TSK 0816954
.           Fixed OP series booking visit number for defence claim - OUTCLM10
. V10.08.19 21/09/2016  J.Tan         TSK 0826370
.           Recompiled for CMXMATRX - Chgd MCHGARR MCHGAMT array to F3
. V10.08.18 12/09/2016  J.Tan          TSK 0822442
.           Mods to read PTCNIPEN 
. V10.08.17 06/07/2016  Jill Parkinson TSK 0808513
.           Added UNLE0000 to unlink ur from eadmission when cancelling     
. V10.08.16 31/08/2016  Jill Parkinson TSK 0822622
.           Added move of Z70 to ptvis085 in CLRPAR00 to stop copying values
.           from previous patient
. V10.08.15 25/08/2016  Peter Vela     TSK 0820145
.           Added validation to stop overwriting PTMIXWRD
.           25/08/2016  Don Nguyen     TSK 0312570
.           Recompiled for CMXMATRX - Added check for PTCNDGED=1
.           Added PMSEDGFD/IO and GETEFDRG
. V10.08.14 24/08/2016  Ebon Clements TSK 0323341
.           Added ACC claim status description tag - CLMF8700
. V10.08.13 21/07/2016  Jill Parkinson TSK 0822810
.           Added branch on exit to PRAD0250 if no record on pmscexaf for PRFA
. V10.08.12 08/07/2016  Jill Parkinson TSK 0822002
.           Recompiled for PATMASTM
. V10.08.11 22/06/2016  J.Tan         TSK 0321972
.           Fixed updating Casepayment (ptmis075)
. V10.08.10 20/06/2016  Ebon Clements TSK 0815677
.           Added test for template 047 for Admit MH visit from ED - OUADMF05
. V10.08.09 14/06/2016  Jill Parkinson TSK 0302976
.           Added output of PMHBUNIQ for sites using episoft interface
. V10.08.08 10/06/2016  Peter Vela    TSK 0816991
.           Recompiled for EMRVISTM
. V10.08.07 25/05/2016 J.Tan          TSK 0292044
.           Mods CHPR000 to blank adiag2 & opdades2 if no performed proc.found
. V10.08.06 20/05/2016 Jill Parkinson TSK 0818251
.           Added cgi NOBKDES2 to allow adiag2 to not overwrite bkdides2
. V10.08.05 17/05/2016 Peter Vela     TSK 0819159
.           Recompiled for PMSHRDTM
.           06/05/2016 J.Tan          TSK 0292044
.           Fixed Updating 'Not Performed' procedure
. V10.08.04 02/05/2016 Jill Parkinson TSK 0817368
.           Added call to ADDVIS00 in DOAD0000 so admitting patients will create
.           a medical record visit link
. V10.08.03 28/04/2016  Don Nguyen     TSK 0316489
.           Recompiled for PATATRTM & PATATRFD/IO
. V10.08.02 14/04/2016 J.Tan         CAR 0814716
.           Mods for Usual PRFA code - UPRF0000
. V10.08.01 18/04/2016  Peter Vela     TSK 0294177
.           Changed read to prihdb to KEY27 
.           13/04/2016  J.Tan          TSK 0814716
.           Recompiled for PMSPX2TM - added Usual PRFA Code
. V10.07.18 11/03/2016  Peter Vela     TSK 0814678
.           Added extra validation in WORKD000 to stop update if Expected
.           Discharge Date is already populated
. V10.07.17 08/03/2016  Nicole Torrisi TSK 0809293
.           Recompiled for MRTVISCD - clearing of MRMAFILM field
. V10.07.16 29/02/2016  Peter Vela    CAR 0809143
.           Added functionality to add/update ibaalvaf for kids
. V10.07.15 29/02/2016  Don Nguyen     TSK 0319052
.           Modified SETALT00, SETALI00 & NWDALT00 to cater for indicator 3
. V10.07.14 16/02/2016  J.Tan          CAR 0310703
.           Mods Public Hosp to check for to be inv.amnt before write to patipen
. V10.07.13 14/01/2016  Peter Vela     TSK 0809191
.           Assigned value to PMEFDINT in HOEC0000
. V10.07.12 11/01/2016  Ebon Clements  TSK 0294154
.           Added write to opt out of SMS file - PMSOOSFD
. V10.07.11 04/01/2016  Ebon Clements  TSK 0294154
.           Added Opt out of SMS to prev address file write
. V10.07.10 18/12/2015  Ebon Clements  CAR 294154
.           Added Opt out of SMS functionality
. V10.07.09 17/12/2015  Don Nguyen     CAR 316624
.           Added verification on PMSVX146 cgi before writing to PMVXCASE
. V10.07.08 16/12/2015  Don Nguyen     CAR 316625
.           Modified STRNA000 to also record Case Team (PTTRCASE)
. V10.07.07 15/12/2015  Don Nguyen     TSK 0318657
.           Recompiled for PATMSXTM - Added output for PUYN2
. V10.07.06 23/11/2015  Peter Vela    CAR 324078
.           Changed MEHVIS00 to include UPDATETY = 4
.           Added new open legal status tag for sjog LSRE1000
.           Added HL7 call for preadmission in UPMHAD60
. V10.07.05 18/11/2015  Peter Vela    CAR 323713
.           Added extra validation for ED Discharge Date/Time in EMER0500
. V10.07.04 30/10/2015  Don Nguyen     CAR 320394
.           Recompiled for changes to WATTX1FD/IO
. V10.07.03 26/10/2015  J.Tan          CAR 317554
.           Recompiled for CALCCODE-Calcultes Daycase ICU/CCU/NCU times
. V10.07.02 19/10/2015  Don Nguyen     CAR 316625
.           Added PMSVX146 - Case Team. Recompiled for PATVISTM
.           15/10/2015  Peter Vela     CAR 322285
.           Added functionality to update OnlinePreadmission forms
.           in WEBWAR00 for SVHA/SVMP
.           13/10/2015  Peter Vela     CAR 317276
.           Added SP70 validation in WNUT0000 for ADIET 
.           15/10/2015 Ania P         CAR 316632
.           Added code to allow for redirect to patweb8901020
. V10.07.01 18/09/2015  J.Tan         CAR 314089
.           Added flag to display all NZ Private Procedures
. V10.06.36 01/09/2015  Ebon Clements CAR 319970
.           Recompiled for UPDUR  - Previous GP audit
. V10.06.35 24/08/2015  Ebon Clements CAR 319970
.           Added record type match in SFAX5300 - Prev HCP
. V10.06.34 21/08/2015  Peter Vela     CAR 307798
.           Changed HOEC0000 to get data from screen variables
. V10.06.33 13/08/2015  Don Nguyen     CAR 308621 
.           Recompiled for PATVISTM - Added VISS6100
.           06.08.2015  B.G.Ackland    CAR 320470 
.           Remove PATBMHAF table updates
.           Restrict Number of Records Written to PATBMDAF to 12 weeks
. V10.06.32 05/08/2015  Peter Vela     CAR 320066
.           Recompiled for EMRVISTM
. V10.06.31 30/07/2015  Jill Parkinson CAR 320123
.           Mods to match Z70 to PTPRA001 instead of SP70
. V10.06.30 28/07/2015  Davin          CAR 314914
.           Recompiled for PMSPX2TM (added PCEHR Flag)
. V10.06.29 23/07/2015  Jill Parkinson CAR 314263
.           Added use of COPYFLAG
. V10.06.28 15/07/2015  J.Tan          CAR 319342
.           Recompiled for CMXMATRX - Chg 'Disc.UDF' to 'Care Class'
. V10.06.27 14/07/2015  J.Tan          CAR 317921
.           Recompiled for PMSEXTTM - Checking inactive insurance code
. V10.06.26 13/07/2015  Peter Vela     CAR 317276
.           Commented out CLPMSNUT in WNUT000
. V10.06.25 03/07/2015  J.Tan          CAR 318466
.           Changed OVERSEAS/INELIGIBLE Error message for wahealth
. V10.06.24 29/06/2015  Don Nguyen     CAR 313365
.           Added IADD4 in FPRA0500 and fixed FPRA7250 to correctly map PKADD4
. V10.06.23 10/06/2015  Steve Armstrong   CAR 313856
.           Mods to use CLVISINT & CLVISIAU instead of internal
.           clear routines.
.           Mods to move some variable definitions into PREADMVR.INC
.           for use by CONVPADM as well for preadmissions.
.           Mods to move some routines into PREADMVR.PBL
.           for use by CONVPADM as well for preadmissions.
. V10.06.22 22/06/2015 Patrick Adair  CAR 307795
.           Allow update of preadmission or not depending on user selection
. V10.06.21 22/06/2015 Patrick Adair  CAR 307795
.           Allow update of preadmission or not depending on user selection
. V10.06.20 22/06/2015 Peter Vela     CAR 311435
.           Recompiled for EMRVISTM
. V10.06.19 18/06/2015 Jill Parkinson CAR 313317
.           Fix FSDDT00 to output first seen doctor date/time for emr
. V10.06.18 17/06/2015  Peter Vela      CAR 315532
.           Added functionality to copy pmsextaf record to new
.           recurring care type admission
. V10.06.17 12/06/2015  Patrick Adair   CAR 302976
.           Auto update eAdmission Status for sites with PTCNEPIS set on
.           12/06/2015 Peter Vela     CAR 314273
.           Recompiled for PMSHRDTM
. V10.06.16 11/06/2015  Patrick Adair   CAR 313223
.           Recompiled for WEBGROUP - admission weight check
. V10.06.15 04/06/2015 Patrick Adair  CAR 313318
.           Check if adm date time default is blank
. V10.06.14 02/06/2015 Jill Parkinson CAR 317467
.           Recompiled for PATVISTM and PATDISCH (moved cat YF to pmvxudf8)
. V10.06.13 28/05/2015 Ebon Clements  CAR 305068
.           Recompiled for CLPMSEXT - clear defence force fields
.           26/05/2015 Jill Parkinson CAR 313321
.           Added checks for NMDS fields to update aelig accordingly
. V10.06.12 18/05/2015 Patrick Adair  CAR 208170
.           Recompiled for changes to UPDUR
. V10.06.11 05/05/2015 Jill Parkinson CAR 313317
.           Added FSDDT00 to output first seen doctor date/time for emr
. V10.06.10 05/05/2015  Don Nguyen    CAR 299117
.           Recompiled for OPMAKBOK - clear OPDAACPD & OPDARICM before write
.           25/04/2015 Jill Parkinson CAR 311205
.           Recompiled for PATVISTM - VISS6000 correction
. V10.06.09 14/04/2015 Peter Vela     CAR 312723
.           Added audit functionality for PMPXUSR9
. V10.06.08 14/04/2015 J.Tan          CAR 315362
.           Fixed Updating PRFA with Insurance code for PTCNXCOM=1
. V10.06.07 02.04/2015 B.G.Ackland    CAR 312482
.           Move CSC Portal Document to Patient Correspondence
. V10.06.06 30/03/2015 Jill Parkinson CAR 311806
.           Added PMVXCPDD and PMVXPBMI to all clear routines
. V10.06.05 25/03/2015  Peter Vela     CAR 282090
.           Recompiled for EMRVISTM
. V10.06.04 23/03/2015  Ebon Clements  CAR 282146
.           Recompiled for PMSPX2FD - Opt out of SMS
. V10.06.03 20/03/2015  Don Nguyen     CAR 306757
.           Recompiled for MEHVISTM - Modified MHVS5800 to read mehdlsaf
. V10.06.02 19/03/2015  Don Nguyen     CAR 300414
.           Recompiled for CALCCODE - Added check for PTCNICUT
. V10.06.01 16/03/2015  Don Nguyen     CAR 306757
.           Recompiled for MEHVISTM - Added MHVS5900
.           12/03/2015  Steve Armstrong  CAR 314108
.           Removed definition of PTCGDATE as PATCGPFD is no longer
.           in use.
.           12/03/2015  Ania P         CAR 311205
.           Recompiled for PATVISTM
.           27/02/2015  Steve Armstrong
.           Removed redundant Detente code
. ----------------------------------------------------------------------
. V10.05.33 27/02/2015 Ebon Clements   CAR 313158
.           Added trap around oprdetaf update at THET2000
. V10.05.32 25/02/2015 Davin      CAR 311423
.           Ensure wattx1af is read before dgcliwld called for A38 (dowl0000)
. V10.05.31 20/02/2015 J.Tan      CAR 311352
.           Recompiled for PATDSBFE - Public Hosp.tocheck if only Daycase setup
. V10.05.30 18/02/2015  Don Nguyen     CAR 306757
.           Modified MHREF000 to work with either Cat AC or CC; dependent on
.           MHCNMHLS (Category for allocating MH Legal Status - Sector 69)
.           18/02/2015  Ania P         CAR 311205
.           Added PTVIS134
. V10.05.29 13/02/2015 Ebon Clements   CAR 312372
.           Added trap around admission comments write - PTCMN510
.           11/02/2015  Patrick Adair  CAR 208170
.           Added Previous HCP/Practice Audit Details and corrected Death Audit
.           Included new HCP save variables as SVMAS variables are too small for
.           new fields
. V10.05.28 02/02/2015 Ebon Clements   CAR 311997
.           Added trap around U/R comments write - URCMN600
. V10.05.27 02/02/2015 Ebon Clements   CAR 303279
.           Changed error to patient not currenly admitted instead of
.           invalid admission on the update admission screen - PREDET97
. V10.05.26 19/01/2015 Ebon Clements   CAR 311079
.           Added TRAP around pmsoecaf write - ECLOEC20
. V10.05.25 06/01/2015 J.Tan      CAR 305441
.           Added pmsvx125 for PCEHR Upload
. V10.05.24 18/12/2014 J.Tan      CAR 309655
.           Recompiled for CALCCODE - fixed ICU hours
. V10.05.23 15/12/2014  Peter Vela     CAR 310009
.           Changed RD to RA for pmself and pmsoec in GELN0000
. V10.05.22 10/12/2014  J.Tan          CAR 298445
.           Mods to update Diet code in pmsnutaf file
. V10.05.21 28/11/2014  Ebon Clements  CAR 306866
.           Recompiled for MRTVISCD - Clear of new MR comments
. V10.05.20 27/11/2014  Ebon Clements  CAR 304036
.           Clear proposed admission time of WL on cancel pre admission DOWL0000
. V10.05.19 26/11/2014  Peter Vela     CAR 308067
.           Recompiled for PATDISCH
. V10.05.18 20/11/2014  J.Tan          CAR 302263
.           Mods for ACT Statutory changes
. V10.05.17 06/11/2014  Don Nguyen     CAR 304059
.           Recompiled for changes to OPRSESIO - added Default Team Completed
.           fields.
. V10.05.16 23/10/2014 J.Tan           CAR 291475
.           Fixed Defence force PRFA to insurance details (PROADM50)
. V10.05.15 21/10/2014 Ebon Clements   CAR 307127
.           Populate PMVXLNG1 even if interpreter required is no - UPABK000
. V10.05.14 14/10/2014 Ebon Clements     CAR 300196
.           Added nutrition for pre admisssion functionality
.           14/10/2014  Don Nguyen       CAR 307008
.           Recompiled for changes to EMRVISTM
.           14/10/2014  Peter Vela       CAR 301518
.           Recompiled for UPEADMVS
. V10.05.13 06/10/2014 Peter Vela CAR 290666
.           Added tag for valid PTVITYPE
. V10.05.12 19/09/2014 J.Tan  CAR 299241
.           Recompiled for CALCCODE - minutes in ICU
. V10.05.11 03/09/2014  Jill Parkinson   CAR 306061
.           Removed use of ptcnsouc - caused comments to get duplicated if
.           added by another using when updating pmi comments
.           03/09/2014  J.Tan          CAR 305745
.           Removed UPMEMB00 - updating Adm.HF for NZ
.           10/09/2014  J.Tan          CAR 274958
.           Added Employer code to pmswx1af file
. V10.05.10 21/08/2014  Peter Vela       CAR 303909
.           Recompiled for EMRVISTM
.           21/08/2014  Don Nguyen       CAR 303878
.           Recompiled for changes to PATMASTM
. V10.05.09 19/08/2014  Peter Vela       CAR 304873
.           Recompiled for EMRVISTM
. V10.05.08 18/08/2014  Peter Vela       CAR 304873
.           Recompiled for EMRVISTM
. V10.05.07 14/08/2014  Peter Vela     CAR 304860
.           Fixed Height and Weight write and update in pmsvx1af
.           (ABMI0000 UBMI0000)
.           14/08/2014  Jill Parkinson CAR 304358
.           Added VINAHUPD - mods to allow VINAH in to update merged UR numbers
. V10.05.06 13/08/2014  Don Nguyen     CAR 299099
.           Recompiled for changes to MRTRQHFD/IO - Added Index 6
. V10.05.05 12/08/2014  J.Tan          CAR 279251
.           Added ptmas085 - Death certificate number
. V10.05.04 11/08/2014  Don Nguyen     CAR 297774
.           Recompiled for changes to PMSBRQFD/IO
. V10.05.03 04/08/2014  Jill Parkinson CAR 304148
.           Corrected validation for care type 10 and adm source K
. V10.05.02 28/07/2015  Peter Vela     CAR 301176
.           Added calculated BMI to ADDATR00 UPDATR00 SFAX4100
. V10.05.01 17/07/2014  Ebon Clements  CAR 251384
.           Clear sub system key for ibapolaf write
.           14/07/2014  Peter Vela     CAR 299513
.           Added BMI functionality for mhaccq admission screens
. V10.04.29 01/07/2014  Jill Parkinson CAR 302961
.           Mods to setting of DOYR2014
. V10.04.28 26.06.2014  Ania P          CAR 302302
.           Changed "Invalid Admission Type" message to use cat P description
.           instead of being hardcoded.
. V10.04.27 19/06/2014  J.Tan           CAR 302452
.           Recompiled for WEBDINVS - Changed MCHGARR/MCHGAMT
. V10.04.26 04/06/2014  Peter Vela      CAR 301127
.           Added THEAFLAG = 3 redirect to day oncology booking after new reg
.           popupframe
.           04/06/2014  J.Tan           CAR 300791
.           Recompiled for PATDISCH - checking Invoice pending
. V10.04.25 19/05/2014  Ebon Clements   CAR 298155
.           Fixed non multi hospital user id defaults - CRMED000
. V10.04.24 13/05/2014  Don Nguyen      CAR 300615
.           Modified CYER0000 to return different error/warning code values.
.           Updated UPCLMD93 to output error messages accordingly.
.           Fixed PROADM50; GOTO PROADM90 after call to PDIREC00.
. V10.04.23 26/04/2014  Peter Vela      CAR 292257
.           Added OEC Store Details of Request
.           01/05/2014  J.Tan           CAR 261630
.           Removed pataum Misc.audit file
. V10.04.22 24/04/2014  Jill Parkinson  CAR 295474
.           Added update of emviwrd and bed with either exp ward or post op ward
.           if still blank after using PTCNDWAW
. V10.04.21 15/04/2014  Davin           CAR 297618
.           Added HL7 WL booking cancel (A38) when cancel preadmit (dowl3000)
. V10.04.20 11/04/2014  J.Tan           CAR 291832
.           Recompiled for PATDISCH - Removed updating Invoice on hold for Disc.
. V10.04.19 09/04/2014  Ania P          CAR 294810
.           Removed NEWR9460
. V10.04.18 07/04/2014  Peter Vela      CAR 286258
.           Recompiled for PATMASTM
. V10.04.17 03/04/2014  Peter Vela       CAR 276543
.           Added Previous PRFA default functionality
.           03/04/2014  J.Tan            CAR 299607
.           Fixed FPRA7250 - removed PACK SP70 with WA Workers Comp.Contact name
. V10.04.16 02/04/2014  Peter McMullen   CAR 294400
.           no change timestemp on Theatre Operation Detail
. V10.04.15 02/04/2014  Ebon Clements    CAR 295177
.           Added TRAP to pmsupdaf write - WRUPD000
. V10.04.14 31.03.2014  B.G.Ackland  CAR 299363
.           Replace META Tag Redirect with Javascript in Common RDIREC00
.           Routine
. V10.04.13 24/03/2014  Steve Armstrong  CAR 298483
.           Recompiled for changes to DGCLICOB
.           20/03/2014  J.Tan         CAR 279251
.           Mods to write to Death audit file
. V10.04.12 18/03/2014  Jill Parkinson CAR 294183
.           Added new July 2014 validations for Adm Type and Care Type
. V10.04.11 17/03/2014  Don Nguyen     CAR 298261
.           Modified NEWREG00 to also update A&E visit record (aaede1af) U/R
.           13/03/2014  Patrick Adair  CAR 292935
.           Added CGI variables for Additional Doctors
.           05/03/2014  Peter Vela     CAR 218689
.           Added Allocate UR Theatre Request functionality to UR registration
.           28/02/2014  Don Nguyen     CAR 291879
.           Added CHNGMADE to flag field value changes made on a template for
.           IHI enquiry if using NEHTA (PTCNUNET).
.           Call WIPL0000 in the relevant routines.
. V10.04.10 06/02/2014  Patrick Adair  CAR 293445/293780
.           Recompiled for changes to UPEADMVS
. V10.04.09 24/01/2014  Peter Vela     CAR 286158
.           Changed PATATR reads and writes
. V10.04.08 22/01/2014  Peter Vela     CAR 286158
.           Recompiled for CALCBMIN
. V10.04.07 22/01/2014  Don Nguyen     CAR 295972
.           Modified UPAD0000 - KEY16 to KEY24. Updated key PACK.
. V10.04.06 17/01/2014  Peter Vela     CAR 286158
.           Changed BMI underweight to purple
. V10.04.05 16/01/2013  Peter Vela     CAR 296018
.           Validate for Update Admission in ACTDOC00
. V10.04.04 13/01/2014  Peter Vela     CAR 286158
.           Fixed BMI colors
. V10.04.03 19/12/2013  Peter Vela     CAR 286159
.           Fixed Patient Attributes Date and Time tag
. V10.04.02 18/12/2013  Peter Vela     CAR 286158
.           Added SFAX4400 Patient Attributes Created Date and Time
. V10.04.01 17/12/2013  Ania P         CAR 294810
.           Added NEWR9460
. ----------------------------------------------------------------------
.V10.03.195 13/12/2013  J.Tan          CAR 294609
.           Recompiled for CMXMATRX - mods for Default Grouper ersion
.V10.03.194 11/12/2013  Ebon Clements  CAR 293092
.           Added notified and confirmed to interpreter audit
.V10.03.193 05/12/2013  Peter Vela     CAR 286158
.           Added Patient BMI/Attributes functionality
.           10/12/2013  Davin          CAR 295110
.           Recompiled for changes to DGCLICCP
.V10.03.192 04/12/2013  Don Nguyen     CAR 281940
.           Fixed bug in UPPBMN00 where FORM3 wasn't initialised before used.
.           Also fixed same issue in GTTOTM00 and GNXOEC00.
.V10.03.191 28/11/2013  Patrick Adair  CAR 294291
.           Do not default Visitors/Phone allowed in SVXDF000 on
.           Admission Update.
.V10.03.190 22/11/2013  Peter Vela     CAR 293008
.           Added check for Cancelled visit in UPADM000
.V10.03.189 22/11/2013  Jill Parkinson CAR 260977
.           Added update of bkrxpowd if ptcndwaw=0 in UPBKD000
.V10.03.188 21/11/2013  Ania P           CAR 223240
.           Added SFAX3800: output for PMWXASST/Work Capacity Button
.V10.03.187 20/11/2013  Ebon Clements    CAR 212716
.           Recompiled for PATCODTM - catactiv cgi for active only cat codes.
.           CATACTIV=1 for report 4 and selected report 1 admission pages
.V10.03.186 14/11/2013  Steve Armstrong  CAR 294040
.           Recompiled for changes to DGCLICCP & DGCLICPE
.V10.03.185 11/11/2013  J.Tan            CAR 293838
.           Changed UPMEMB00 to update HF only if NOT invoiced & NOT cancelled
.V10.03.184 06/11/2013  Peter Vela       CAR 292759
.           Added RA reads right before both WRPMRES1 in UPRES000, URES0000
.V10.03.183 29/10/2013  Peter Vela       CAR 291485
.           Added update to boarders for statistical discharge/admission
.V10.03.182 28/10/2013  Patrick Adair    CAR 201234
.           Recompiled for changes to WLHISSUB
.V10.03.181 11/10/2013  Ebon Clements    CAR 291694
.           Added second given name to alias lists and delete
.V10.03.180 09/10/2013  Ebon Clements    CAR 275205
.           Added EBS unknown U/R edits to limit U/R usage
.V10.03.179 07/10/2013  Ebon Clements    CAR 275205
.           Added EBS temp ur generation - Creates a UR with PSTAT=4
.           when temporar=2
.V10.03.178 03/10/2013  Ebon Clements    CAR 275205
.           Recompiled for PMSARQFD - Addition of transfer source
.V10.03.177 03/10/2013  Patrick Adair    CAR 291014
.           Do not update eAdmissions unless UPPRE000 is successful
.V10.03.176 01/10/2013  Ebon Clements    CAR 275205
.           Added admission request functionality
.V10.03.175 30/09/2013  Ebon Clements    CAR 292168
.           Changed open and close of PMSALAA1 in ADDNEW00 to PMSALNA1
.           to fix I * C
.V10.03.174 26/09/2013  Peter Vela       CAR 291485
.           Update Boarders End Date/Time when patient is deceased
.           @ UPMAD050
.V10.03.173 26/09/2013  J.Tan            CAR 291627
.           Recompiled for PATDYCAS - Mods checking Inv.Pending for Public Hosp.
.V10.03.172 27/08/2013  Ebon Clements    CAR 275205
.           Recompiled for WATTX1FD - New fields WTTXPSAH and WTTXPHOS
.V10.03.171 18/09/2013  Jill Parkinson   CAR 291766
.           Mods to ignore cancelled admissions in VALADM00
.V10.03.170 10/09/2013  Peter Vela       CAR 289907
.           Added Dates on Provisonal DRG functionality in WRUNA000
.           10/09/2013  Steve Armstrong  CAR 291089
.           Recompiled for changes to PMSQVIIO
.V10.03.169 28/08/2013  Peter Vela       CAR 290545
.           Added PTMIS076 (Expected Bed) to EMER0000
.V10.03.168 19/08/2013  Peter Vela     CAR 289311
.           Fixed Cancel UR CANUR000 when there are cancelled preadmissions
.V10.03.167 19/08/2013  Peter Vela     CAR 289732
.           Fixed Department of Defence validation in UPCLMD00 and FPRA0000
.           again
.V10.03.166 16/08/2013  Peter Vela     CAR 289732
.           Fixed Department of Defence validation in UPCLMD00 and FPRA0000
.V10.03.165 12/08/2013  Jill Parkinson CAR 290059
.           Moved call to RESCLM00 in UPPRE000 to be before PPRE0000
.V10.03.164 12/08/2013  Jill Parkinson CAR 289926
.           Added call to CLRRES00 to clear PRA details in NEWPRE00
.           Commented out call to UPDPRA00 and UPPRA000 in PPRE2000
.V10.03.163 06/08/2013  Don Nguyen        CAR 289622
.           Added call to VSAD0000 for DISS0000 (statistical discharge)
.V10.03.162 05/08/2013  Ania P            CAR 288890
.           Added check for parameter PTCNUNDH
.           05/08/2013  J.Tan             CAR 288060
.           Recompiled for CMXMATRX - fixed Primary/Secondary/Tertiary
.V10.03.161 30/07/2013  Patrick Adair     CAR 289389
.           Updated to cater for new documents workflow requirements
.V10.03.160 30/07/2013  Ebon Clements     CAR 283202
.           Recompiled for PMSPX2TM - Preferred method of contact
.V10.03.159 26/07/2013  Steve Armstrong   CAR 287787
.           Recompiled for changes to DGCLICUA.
.V10.03.158 25/07/2013  Jill Parkinson    CAR 285046
.           Added branch on exit in WBMHMS00
.V10.03.157 23/07/2013  Jill Parkinson    CAR 288982
.           Added clear of STATFLAG in CLRPAR00
.V10.03.156 18/07/2013  Steve Armstrong   CAR 268961
.           Recompiled for changes to PMSQVIFD.
.V10.03.155 17/07/2013  Ania P            CAR 219768
.           Recompiled for NEWBNMAS
.V10.03.154 16/07/2013  Davin             CAR 288417
.           Use pmsextaf for claimtyp=D when ptcnxcom is turned off (upclmd06)
.V10.03.153 04/07/2013  Patrick Adair     CAR 286548
.           Added Auto update of PRFA and Contacts for eAdmission
.V10.03.152 03/07/2013  J.Tan             CAR 287845
.           Fixed default CMCODE to PTMIPCMX when Admitting patients
.V10.03.151 02/07/2013  Ania P            CAR 287813
.           Opened oprsesaf before read, then closed immediately after
.           as there is an open file limit. This is to fix I*C error
.V10.03.150 01/07/2013  Davin             CAR 286607
.           Recompiled for PATDISCH - save team from pmsvx1af in pattranf
.V10.03.149 01/07/2013  Ebon Clements     CAR 287145
.           Default vic ED admission date/time to short stay location date/time
.           CHKWHO00
.V10.03.148 30/06/2013  Davin             CAR 283202
.           Recompiled for changes to hl7 messaging (pmsqptfd)
.V10.03.147 25/06/2013  J.Tan             CAR 286616
.           Fixed updating NZPrivate Secondary procedure
.V10.03.146 20/06/2013  Patrick Adair     CAR 286557
.           Added processing to move eAdmission documents on new registration
.           20/06/2013  Peter Vela        CAR 283202
.           Recompiled for PMSPX2FD
.           19/06/2013  Ebon Clements     CAR 286907
.           Check WBSEHHOS and WHSEHLOC are both populated before using
.           17/06/2013  Patrick Adair     CAR 286938
.           Updated pre-admission status for eAdmission to "Processed" (2)
.V10.03.145 21/06/2013  J.Tan             CAR 287197
.           Mods to open pmspayaf (INIT0000) after reading parameter/controlfile
.V10.03.144 20/06/2013  J.Tan             CAR 287197
.           Mods checking for PTCNEPAY before read pmspayaf (SFAL5400)
.V10.03.143 19/06/2013  Sandra Barcham    CAR 285752
.           Change error message to WA Health specification
.V10.03.142 04/06/2013  Patrick Adair     CAR 285158
.           Update URNO and Status in pmsehbaf for eAdmission
.V10.03.141 31/05/2013  Peter Vela        CAR 261630
.           Removed port number from temp file name
.V10.03.140 27/05/2013  Patrick Adair     CAR 285158
.           Added ADMISNID for eAdmission in SFAL0000
.V10.03.139 04/06/2013 Sandra Barcham    CAR 285752
.           Changed error message to include parameter C3BDAYS
.V10.03.138 22/05/2013  Don Nguyen       CAR 283702
.           Fixed WRUPD000 to update PMUDUSER with correct USERID before write
.V10.03.137 16/05/2013  Davin            CAR 279533
.           Don't call dgclicac if no valid pattranf record found (hl7trgid=5)
.V10.03.136 07/05/2013  J.Tan            CAR 284694
.           Mods Overseas Student PRFA to default to Local address
.V10.03.135 02/05/2013  Don Nguyen       CAR 284693
.           Recompiled for changes to IBAWEBCD (TITLESEL & RELATSEL).
.           01/05/2013  Steve Armstrong  CAR 284376
.           Recompiled for changes to DGCLICUP.
.V10.03.134 15/04/2013  Steve Armstrong  CAR 267329
.           Fixed read (RAIBPOL1) on ibapolaf to increment counter
.           where a record already exists.
.           Recompiled for changes to COPYMCOD (to remove related Grouper code)
.V10.03.133 16/04/2013  Don Nguyen       CAR 284099
.           Added ISEDLITE processing for ED Lite templates
.V10.03.132 09/04/2013  Ebon Clements  CAR 276830
.           Fixed visit number of patre1af write  - UPRFA800
.V10.03.131 03/04/2013  Davin          CAR 270648
.           Recompiled for changes to HL7 messaging includes
.V10.03.130 26/03/2013  J.Tan          CAR 283007
.           Fixed Changing Financial Election for a given date
.V10.03.129 19/03/2013  Jill Parkinson CAR 282814
.           Recompiled for PATMASTM - Disability alert DSAL0000 change
.V10.03.128 08/03/2013  Davin            CAR 268971
.           Added HL7 visit triggers for PMI changes - new table ibapolaf
.           (SH7VP000/CH7VP000/WH7VP000)
.V10.03.127 08/03/2013  Jill Parkinson CAR 268131
.           Added EORIG000 - output of original adm date for emr visits
.V10.03.126 28/02/2013  Jill Parkinson CAR 257831
.           Added pmsupdaf functionality - demographics updated date/time/user
.V10.03.125 28/02/2013  Don Nguyen     CAR 281977
.           Added BYPASSCV to bypass current ED patient visit check on admission
.V10.03.124 14/02/2013  Ebon Clements  CAR 281198
.           Added chdisdte to CLRPAR00 to fix expected discharge date
.V10.03.123 11/02/2013  Ebon Clements  CAR 279320
.           Clear death notification if not deceased - UPMAD000
.V10.03.122 06/02/2013  Jill Parkinson CAR 276975
.           Mods to stop if error on readmission for statistical readmissions
.V10.03.121 30/01/2013  Ebon Clements  CAR 262292
.           Update or delete furture visit interpreter required on pmi update
.V10.03.120 23/01/2013  Jill Parkinson CAR 279239
.           Added call to CHKSTB00 (in PATDISCH) added clear of STBYPAT
.V10.03.119 22/01/2013  J.Tan          CAR 278496
.           Mods WA Pre-Adm not to validate Claim code against Resident Status
.V10.03.118 11/01/2013  Peter Vela     CAR 268131
.           Added previous hospitalisation functionality
.V10.03.117 10/01/2013  Jill Parkinson CAR 276103
.           Recompiled for PATDISCH - message trigger 16 sending wrong ward/bed
.           on update discharge
.V10.03.116 17/12/2012  J.Tan          CAR 272547
.           Mods not to clear 3B expiry date at preadmission
.V10.03.115 10/12/2012  J.Tan            CAR 276875
.           Mods 'Send Bill to Local' address for Overseas patient
.V10.03.114 04/12/2012  Jill Parkinson CAR 275193
.           Recompiled for PMSHPGTM - update of start of therapy date on pmsupg
.           30/11/2012  Peter Vela      CAR 262297
.           Update pmsvx1af Last Updated User/Data/Time on update of
.           outbb1af
.V10.01.113 23/11/2012  Jill Parkinson CAR 275193
.           Recompiled for PMSHPGTM - update of start of therapy date on pmsupg
.V10.03.112 21/11/2012  J.Tan            CAR 276430
.           Fixed validating Overseas Students/visitors resident against Claim
.V10.03.111 21/11/2012  Don Nguyen       CAR 276430
.           Un-did previous change with CRES2000
.V10.03.110 19/11/2012  J.Tan            CAR 275549
.           Mods Public Hosp. to write to Inv.pending only if bedfees not zero
.V10.03.109 19/11/2012  Peter Vela       CAR 275750
.           Added update to Presenting Illness Number (patmi1af) to PROADM60
.           if template if Single Online Eligibility Request
.           (patweb8901036.html)
.           15/11/2012  Peter Vela       CAR 189848
.           Added validation for Overseas Reciprocal and Asylum Seeker @
.           CHKF0000.
.           19/11/2012  Don Nguyen       CAR 276430
.           Modified CRES2000 to allow template 4 through (Overseas Student)
.V10.03.108 13/11/2012  Jill Parkinson CAR 268575
.           Added call to CLPATMIS in CLRPAR00
.V10.03.107 31/10/2012  Jill Parkinson CAR 275673
.           Fixed branch statements at SFAX2900,SFAX3000,SFAX3100 to stop
.           after UR is passed.
.V10.03.106 29/10/2012  Jill Parkinson CAR 275448 and 275366
.           Fixed open of mrtrqdaf in MWWRT0000
.           Changed CPRA0000 to use ADMISSNO instead of PMEXT001
.V10.03.105 23/10/2012  Mike Laming    CAR 267261
.           Recompiled for PMSEXTTM - Added OSeas Country List
.V10.03.104 25/10/2012  J.Tan            CAR 275366
.           Fixed PKADMN before Updating PRFA1
.V10.03.103 12/10/2012  Mike Laming      CAR 265541
.           Added test for Workers Comp. in RESCLM00
.V10.03.102 10/10/2012 Patrick Adair     CAR 273294
.           Add Insurance Company Code to PATWMAAF
.V10.03.101 11/10/2012 Steve Armstrong   CAR 274402
.           Added call to DGCLICDI for a discharged ED patient
.V10.03.100 09/10/2012 J.Tan             CAR 273822
.           Mods to check for Inactive Postal address
. V10.03.99 05/10/2012 Davin             CAR 273793
.           Added A04 broadcast to emr registration (dgclicae/newreg00)
. V10.03.98 05/10/2012 Peter Vela        CAR 273485
.           Exit UBOK0000 if Theatre Booking is cancelled. Don't update bokrc1
.           and wattr1 @ UBOK1000
. V10.03.97 01/10/2012  J.Tan            CAR 273822
.           Mods to use CAGECOFF for 'Parent of' PRFA
.           Fixed the default WA PRFA for Public/Bulkbill to Postal Address
. V10.03.96 20/09/2012  Davin            CAR 273279
.           Recompiled for PATWIS19
. V10.03.95 17/09/2012  Don Nguyen     CAR 273077
.           Recompiled for changes to EMRVISTM (EMRB6700)
. V10.03.94 06/09/2012  Patrick Adair  CAR 270065
.           Recompiled to pick up PATDISCH updates
. V10.03.93 06/09/2012  J.Tan          CAR 268575
.           Removed update Usual PRFA in UPMAD000 (undo changes for CAR 256117)
. V10.03.92 31/08/2012  Jill Parkinson   CAR 271930
.           Added RAURAD1 before writing in PMIA0000
. V10.03.91 31/08/2012  Peter Vela       CAR 266428
.           Added VSINCHON before write to visintaf
. V10.03.90 24/08/2012  Jill Parkinson   CAR 269138
.           Moved call to RESCLM00 in UPPRE00 to be after UPDMIS00
. V10.03.89 13/08/2012  Steve Armstrong  CAR 270853
.           Fixed RAPMOEC1 to use loaded file variables
.           09/08/2012 Peter Vela        CAR 270853
.           Added traps around WRPTBMD
.           02/08/2012 J.Tan   CAR 263723
.           Mods checking Claim code TCINDC17 for Deceased Estates Desc.
.           03/08/2012 J.Tan          CAR 268575
.           Mods to clear PRFA fields
.           08/08/2012  Davin        CAR 270114
.           Recompiled for COPYMCOD (added WIES19)
.           02/08/2012 J.Tan   CAR 269138
.           Removed checking Resident stat.with WA Over.Student/Visitor(RESCLM)
. V10.03.88 01/08/2012 Ebon Clements  CAR 269465
.           Added cgi IPADMDAT to not update ED discharge date with IP Adm date
. V10.03.87 31/07/2012 Jill Parkinson CAR 254372
.           Added check for on leave in CURI0000
. V10.03.86 26/07/2012 Jill Parkinson CAR 269632
.           Don't update status of cancelled bookings in UBOK0000
. V10.03.85 23/07/2012 Patrick Adair     CAR 269159
.           Recompiled for changes to PATCOMN2
. V10.03.84 20/07/2012  Ebon Clements     CAR 217579
.           Recompiled for addition of patient BMI field to PMSVX1FD
. V10.03.83 19/07/2012  Steve Armstrong   CAR 268870
.           Recompiled for changes to UPDUR & PATCOMN2
. V10.03.82 10/07/2012  Steve Armstrong   CAR 268882
.           Added trigger id's 34 & 35 for DGCLICDS following changes
.           for CAR 267469.
.           10/07/2012  Jill Parkinson CAR 268840
.           Added check for  BEDTRKEY in BLKD000
. V10.03.81 09/07/2012  Steve Armstrong   CAR 267675
.           Recompiled for changes to PATCOMN2
. V10.03.80 05/07/2012  Jill Parkinson CAR 268498
.           Added R to care type validations in VASCT000
. V10.03.79 04/07/2012  Jill Parkinson CAR 266654
.           Added match of spaces to CPMISKEY in WEBWAR00
. V10.03.78 29/06/2012  Steve Armstrong  CAR 267469
.           Recompiled for changes to PATDISCH
. V10.03.77 27/06/2012  Don Nguyen     CAR 266175
.           Output all patient comments for matching ADMISSNO (SFAL8600)
. V10.03.76 27/06/2012  Jill Parkinson CAR 267601
.           Added RAPTCOM1 before writing to patcomaf
. V10.03.75 19/06/2012  Jill Parkinson CAR 266709
.           Changed UBOK0000 to go through THET0000 if not a theatre booking
. V10.03.74 18/06/2012  Jill Parkinson CAR 267045
.           Added call to CHKBTR00 and WRWATR00 for stat discharge
. V10.03.73 18/06/2012  Don Nguyen     CAR 261697
.           Recompiled for WEBGROUP - Corrected default value of end date
.           (EPENDDAT) for DAYSEP calculations in CPDATS00.
. V10.03.72 15/06/2012  Don Nguyen     CAR 266261
.           Added code (SFAX0000) to output Waiting List Procedure descriptions
. V10.03.71 08/06/2012  Jill Parkinson CAR 265258
.           Added pack of URNUMBER with AURNO in BLKD0000
. V10.03.70 07/06/2012  Mike Laming    CAR 266421
.           Added vars CBB & OBB for use in COPYMCOD (CPDATS00)
. V10.03.69 01/06/2012  Davin            CAR 260600 VAED-2012
.           Added adm.src=K/care type=10 validation (vasct200)
. V10.03.68 31/05/2012  J.Tan          CAR 265261
.           Changed UPMEMB00 to update Health Fund/table and Contributor Name
.           31/05/2012  Jill Parkinson CAR 265258
.           Recompiled for COPYMCOD
. V10.03.67 30/05/2012  Patrick Adair  CAR 257776
.           Moved PROC WARPRG00 to PATDISCH.PBL
. V10.03.66 29/05/2012  Ebon Clements  CAR 265261
.           Fixed card type test to DVA card number tags - SFAX0600 & SFAX0700
. V10.03.65 18/05/2012  Davin            CAR 260777 WA-HMDS Triggers
.           Added call to proc WRWATR00 for DVA extra compensable screen
. V10.03.64 18/05/2012 Ebon Clements     CAR 262141
.           Reset pre adm MR pulled flag if pre admission date changed UPADM010
. V10.03.63 15/05/2012 J.Tan             CAR 255708
.           Mods checking for Hold Invoices From Date
. V10.03.62 16/05/2012  Ebon Clements  CAR 265261
.           Added card type test to DVA card number tags - SFAX0600 & SFAX0700
. V10.03.61 10/05/2012  Peter Vela     CAR 232137
.           Recompiled for BEDBDVCD
. V10.03.60 03/05/2012  Jill Parkinson CAR 257615
.           Recompiled for PMSHPGTM
. V10.03.59 24/04/2012  Davin            CAR 260600 VAED-2012
.           Allow deceased patients to be admitted for organ procurement
.           when cat.cc,indc12=D (deadflag,gadm9600,admded00,chkded00)
. V10.03.58 20/04/2012  Ebon Clements  CAR 260555
.           Added same of WL removal time and added to data integrity
.           removal records
. V10.03.57 19/04/2012  Jill Parkinson CAR 263850
.           Recompiled for changes to GNXTUR
. V10.03.56 04/04/2012  Davin            CAR 260600 VAED-2012
.           Added validations (vatca000,newr0000,v2012000)
. V10.03.55 10/04/2012  Ebon Clements  CAR 260555
.           Write scheduled adm date/time to cancel booking audit - WRCHW000
. V10.03.54 01/04/2012  Jill Parkinson CAR 257776
.           Added call to WIPG0000 on admitting a preadmission
. V10.03.53 30/03/2012  Ebon Clements      CAR 260555
.           Write cancel booking integrity audit on cancel pre adm - WRCHW000
. V10.03.52 23/03/2012  Steve Armstrong    CAR 262457
.           Mods to open W/L files after reading PTCNHDPS
. V10.03.51 23/03/2012  Ebon Clements  CAR 260555
.           Save adm date and time in data integrity audit unadmit - WRCHU000
. V10.03.50 20/03/2012  J.Tan          CAR 260406
.           Mods Catg CL indic16=1 not to check for resident status
. V10.03.49 20/03/2012  Jill Parkinson CAR 243341
.           Mods to default BKRXUDF5 into PMVXIDUS for preadmit from booking
.           20/03/2012  Ebon Clements  CAR 262060
.           Added deceased date must be after DOB edit - VALDEC00
. V10.03.48 16/03/2012  J.Tan          CAR 259019
.           Mods to fix Primary and Secondary Procedures
. V10.03.47 15/03/2012  Jill Parkinson CAR 261864
.           Added quickreg cgi
. V10.03.46 15/03/2012  Jill Parkinson CAR 261614
.           Removed previous change
. V10.03.45 14/03/2012  Jill Parkinson CAR 261614
.           Added set of PMVXPICD in RSETB000 (Booking defaults)
. V10.03.44 09/03/2012  Ebon Clements  CAR 260555
.           Write admission, WL removal and WL return record to WL change audit
. V10.03.43 07/03/2012  Jill Parkinson CAR 261444
.           Recompiled for IBAWEBCD - ibapdfaf opens
. V10.03.42 06/03/2012  Davin           CAR 261243
.           Recompiled for PMSCEXTM - oseas country desc
. V10.03.41 01/02/2012  Peter Vela     CAR 260225
.           Added delete mental health redirect functionality
. V10.03.40 27/02/2012  Peter Vela     CAR 257196
.           Recompiled for CLPMSVX1
. V10.03.39 24/02/2012  Jill Parkinson CAR 260679
.           Added copy of pmsextaf records for Statistical Readmissions
. V10.03.38 22/02/2012  Peter Vela     CAR 260225
.           Recompiled for MEHVISTM
.           Added Delete MH Details functionality
. V10.03.37 22/02/2012  J.Tan          CAR 260406
.           Mods not to check Claim code OVERSEAS/INELIGIBLE for Shipping
. V10.03.36 21/02/2012  J.Tan          CAR 259824
.           Mods to SX Insurer free text field
. V10.03.35 20/02/2012  Jill Parkinson CAR 260440
.           Removed open of patwr1a3, changed to use parameter before opening
.           pmspaya1,pmspaya2,watespaf,watesnaf and wateseaf
. V10.03.34 17/02/2012  Peter Vela     CAR 257138
.           Added call to ECLOEC00 @ PROADM20
. V10.03.33 20/02/2012  J.Tan          CAR 260406
.           Mods checking Claim Overseas Visit./Student against Residence status
. V10.03.32 15/02/2012  Davin          CAR 256006
.           Recompiled for changes to WATQUEFD
. V10.03.31 14/02/2012  J.Tan          CAR 259631
.           Mods to update HF Contributor (pmspx2af) for Outpat Priv.Compensable
. V10.03.30 13/02/2012  J.Tan          CAR 251323
.           Mods ADMS000 to set Inform GP (ptvis022) & Mailing List (ptmis072)
. V10.03.29 07/02/2012  Jill Parkinson CAR 254372
.           Added check for RECURRFL in ISIN0000
. V10.03.28 07/02/2012  Peter Vela     CAR 258382
.           Added tag for Disaster Code Description @ SFAX0000
. V10.03.27 01/02/2012  Ebon Clements  CAR 257648
.           Recompiled for COPYMCOD - Procedure date
. V10.03.26 19/01/2012  Jill Parkinson CAR 253987
.           Added write to pmswtraf (wa extract triggers)
.           Added write to prspmiaf for wa
. V10.03.25 24/01/2012  Davin          CAR 258176
.           Added STATFLAG to broadcast A01 after statistical admission
. V10.03.24 20/01/2012  Peter Vela     CAR 258389
.           Default Referring Clinician and Role into mehhls @ MHREF100
. V10.03.23 17/01/2012  Ebon Clements  CAR 244332
.           Fixed updated of OP booking visit extn file on pmi update - VISPST00
. V10.03.22 16/01/2012  J.Tan          CAR 256117
.           Mods UPMAD000-Usual PRFA to update patprfa (only if pkname is blank)
. V10.03.21 16/01/2012  Sandra Barcham  CAR 256563
.           Recompiled for PATMASTM
. V10.03.20 10/01/2012  J.Tan          CAR 257674
.           Added THEADURA - Not to check for Theatre duration
. V10.03.19 04/01/2012  Peter Vela      CAR 252413
.           Assign outpatient site to pvisite for wahealth @ PADM0000 and
.           UPVS0000
.           Added Dropdown selection list for MH Clinic Name
. V10.03.18 22/12/2011  Peter Vela      CAR 253349
.           Assign mehvis referral date/time into mehhls start date/time
.           @ MHREF000
.           21/12/2011  Jill Parkinson  CAR 257713
.           Changed 'Invalid Sex for Age' to 365 for WA
. V10.03.17 21/12/2011  Peter Vela      CAR 254056
.           Check for active/inactive mh referral @ LSREF000
. V10.03.16 15/12/2011  Jill Parkinson  CAR 257475
.           Recompiled for COPYMCOD
.           15/12/2011  Peter Vela     CAR 256569
.           Added transfer date and time to MHREF000
. V10.03.15 14/12/2011  Jill Parkinsin CAR 256062
.           Mods to allow deceased for statistal readmissions
. V10.03.14 13/12/2011  Davin          CAR 243631
.           Don't send A08 if no emr vis record (dewcom00)
. V10.03.13 08/12/2011 Ebon Clements    CAR 248529
.           Added webPAS unique id to contacts
. V10.03.12 07/12/2011  J.Tan          CAR 246468
.           Fixed description for Deceased Estates
. V10.03.11 06/12/2011  Ebon Clements  CAR 253911
.           Recompiled for COPYMCOD - Coding completed date
. V10.03.10 05/12/2011  Peter Vela     CAR 255529
.           Added Inpatient MH Referral validation @ MHREF000
.           Check for open MH Inpatient Referral @ LSREF000
. V10.03.09 02/12/2011  J.Tan          CAR 256004
.           Fixed getting the default Ins.code for Extra compensation details
. V10.03.08 01/12/2011  Mike Laming    CAR 250985
.           Added MultiDatabase to DEAPOL00 (DEATHPOL), added variables etc to
.           this for DEATHPOL.PBL
. V10.03.07 01/12/2011  Ebon Clements  CAR 256395
.           If admitting from ED copy compensable details - EMRINP00
. V10.03.06 30/11/2011  Ebon Clements  CAR 256007
.           Recompiled for newborn defaults - Provisional ICD10 code
. V10.03.05 29/11/2011  Jill Parkinson CAR 256222
.           Added update of nzspunth
.           29/11/2011  Jill Parkinson CAR 249362
.           Changed alert keys
.           18/11/2011  Jill Parkinson CAR 255739
.           Removed some opens from INIT0000 (oprdedaf,patasdaf,mrtpdsaf
.           ,oprsesaf)
. V10.03.04 29/11/2011  Saroeun Soeur   CAR 255802
.           delivery on admissno DELVISIT
. V10.03.03 18/11/2011  Ebon Clements   CAR 255473
.           Clear ED expected ward on cancel pre admission - UNEMR000
.           10/11/2011  Ebon Clements     CAR 248529
.           Added multiple contacts of the same type functionality
.           17/11/2011  Mike Laming     CAR 240184
.           Changes to IBAPOSTF Post Code table - added State to Keys
.           15/11/2011  Jill Parkinson CAR
.           Recompiled for PATDISCH - setting of PCEASE
.           Added move of 1 to DISERROR in STAT0000 CAR 254918
.           15/11/2011  Jill Parkinson CAR  255090
.           Added setting of PTMIS082 in ADMS0000
.           16/11/2011  Jill Parkinson CAR  254982
.           Added call to MEHVIS00 in STAT0000
.           14/11/2011  Davin           CAR 249257
.           Added A08 triggers for prfa change - tacc0000
.           (fpra9000/uppra900/wrpr7000/prad7000)
. V10.03.02 08/11/2011  Jill Parkinson CAR 251994
.           Added read of patdadaf
. V10.03.01 07/11/2011  J.Tan           CAR 252790
.           Mods checking for blank local address line one
. V10.02.85 04/11/2011  Steve Armstrong  CAR 254751
.           Recompiled for changes to OPRQUEFD
. V10.02.84 27/10/2011  Steve Armstrong CAR 251323
.           Recompiled for PMSQVIFD changes
. V10.02.83 26/10/2011  Peter Vela       CAR 253949
.           Added WAHealth business rules to FPRA0000
. V10.02.82 26/10/2011  Peter Vela       CAR 249257
.           Added WAHealth business rules to FPRA0000
.           26/10/2011  Jill Parkinson   CAR 251645
.           Added nbrdays to  adyhosp for statistal readmissionS
. V10.02.81 24/10/2011  Peter Vela       CAR 253495
.           Added update for mehhlsaf @ UPMHVS00
. V10.02.80 24/10/2011  steve Armstrong  CAR 253574
.           Added message trigger 32 to send admission update after
.           mental health visit details are entered.
.           20/10/2011  Peter Vela       CAR 252436
.           Added latest mehhlsaf update @ UPMHVS00
. V10.02.79 18/10/2011  Jill Parkinson   CAR 251645
.           Added statistical discharge/admission (report number 13)
.           18/10/2011  Jill Parkinson   CAR 252165
.           Added read of patma1af in BULK0000
.           Recompiled for PATDISCH
. V10.02.78 14/10/2011  Ebon Clements    CAR 251052
.           Clear ED linked IP admission on cancel pre admission - UNEMR000
. V10.02.77 12/10/2011  Peter Vela       CAR 252428
.           Added validation in WASF0000 for WAHealth if HDP Equivalent = 0
. V10.02.76 12/10/2011  Steve Armstrong  CAR 251644
.           Recompiled for changes to PMSQVIFD/PMSQVIIO and COPYMCOD
. V10.02.75 11/10/2011  Mark Coupland    CAR 252429
.           Recompiled for PATMASTM & PMSPX2TM
. V10.02.74 10/10/2011  Nicole Torrisi   CAR 244903
.           Added call to GWCDAT00 when updating ACC details
. V10.02.73 06/10/2011  Nicole Torrisi   CAR 238267
.           Fixed LASTITEM counter for comments fields.
.           Changed to use LASTITM1 to LASTITM6
. V10.02.72 05/10/2011  Mike Laming      CAR 252032
.           Added SFAX2100 to determine if Patient has any Medical Records
. V10.02.71 04/10/2011  Peter Vela       CAR 251522
.           Added tags for last DVA Number and Card Colour @ SFAX0000
.           04/10/2011  Jill Parkinson   CAR 252404
.           Added invalid claim code to VALDWB00
. V10.02.70 04/10/2011  Jill Parkinson   CAR 252404
.           Added invalid claim code to VDAT0000
. V10.02.69 03/10/2011  Peter Vela     CAR 242151
.           Fixed mehhls variables initialisation in MHREF000
. V10.02.68 29/09/2011  Jill Parkinson CAR 248486
.           Recompiled for IBAWEBCD - Restrict visit access
.           29/09/2011  Sandra Barcham CAR 252027
.           Added PMVXPICD into CLPV0000
. V10.02.67 26/09/2011  Steve Armstrong   CAR 249584
.           Added read of pmsvx1af record prior to calls to DGCLICEC.
.           Recompiled for changes to DGCLICEC.
. V10.02.66 22/09/2011  Ebon Clements     CAR 251121
.           Recompiled for newbord defaults - extra doctors code
. V10.02.65 21/09/2011  Steve Armstrong   CAR 251515
.           Recompiled for changes to WATQUEFD.
.           21/09/2011 J.Tan           CAR 242151
.           Recompiled for WA MH
. V10.02.64 21/09/2011  Ebon Clements  CAR 250896
.           Added clear of visit and visit extn file fields  - OUADMF02
. V10.02.63 19/09/2011  Ebon Clements  CAR 248915
.           Added CONFDEMO cgi to trigger confimed demograhics update
. V10.02.62 19/09/2011  Jill Parkinson CAR 251365
.           Recompiled for PATDISCH
.           16/09/2011  Jill Parkinson CAR 251213
.           Added move of PTMIS015 into PMVXFNDM in UPDVIS00
.           16/09/2011  Jill Parkinson CAR 251213
.           Added update of pmvxfndm in UPMEMB00
. V10.02.61 15/09/2011  Jill Parkinson CAR 250945
.           Removed previous admission warning if recurring care
. V10.02.60 12/09/2011  Jill Parkinson CAR 249548
.           Added output of CURRHOSP and CURRADMN - Current hospital admitted to
.           12/09/2011  Nicole Torrisi CAR 240560
.           Recompiled for PATMISTM - changed PTMSMGIN to use CODITM00
. V10.02.59 12/09/2011  Peter Vela        CAR 248778
.           Added validation for blank expiry date in CHKDVA00
.           12/09/2011  Davin             CAR 250290
.           Allow blank expiry date in chkccd00 (added tag sfax1600)
. V10.02.58 09/09/2011  J.Tan             CAR 242151
.           Mods for WA Mental health
. V10.02.57 08/09/2011  Jill Parkinson    CAR 249154
.           Added non wa contact and funding source to RSETB000
. V10.02.56 08/09/2011  Jill Parkinson    CAR 250438
.           Fixed death update
. V10.02.55 08/09/2011  Jill Parkinson    CAR 249380
.           Added open and close of some files
. V10.02.54 07.09.2011  Saroeun Soeur     CAR 243942
.           recompiled for PATCLMTM
. V10.02.53 06/09/2011  Jill Parkinson    CAR 249984
.           Mods to delete disaster alternate id
. V10.02.52 06/09/2011  Jill Parkinson    CAR 249984
.           Mods to delete dispataf and disptlaf record when cancelling preadmit
. V10.02.51 02/09/2011  Jill Parkinson    CAR 249154
.           Added WL defaults for WA
. V10.02.50 01/09/2011  Saroeun Soeur     CAR 228618
.           added CHDISDTE flag to prevent update on expected discharge date
. V10.02.49 01/09/2011  Steve Armstrong   CAR 248500
.           Mods to trigger DGCLICAC after COPYMCOD call (copying coding
.           from previous admission).
. V10.02.48 01/09/2011  J.Tan           CAR 248961
.           Mods populating MH Receival date/time from Adm.date/time
. V10.02.47 31/08/2011  J.Tan           CAR 249641
.           Fixed Insurance selection for Defence force
. V10.02.46 30/08/2011  J.Tan           CAR 247870
.           Mods to populate Contributor Name from Master to Admission screen
. V10.02.45 30/08/2011  Peter Vela      CAR 248636
.           Add Insurance Company dropdown tag for
.           Other Compensable Details screen (patweb8901341.html)
. V10.02.44 29/08/2011  Jill Parkinson  CAR 248100
.           Recompiled for COPYMCOD
. V10.02.43 29/08/2011  J.Tan          CAR 248632
.           Added tag for Australian defence Service
. V10.02.42 26/08/2011  Jill Parkinson CAR 249295
.           Added output of PTGSGNM2 in LSTALV00
. V10.02.41 26/08/2011  Peter Vela     CAR 249292
.           Added prefer functionality to NWDALT00
. V10.02 40 24/08/2011  J.Tan          CAR 235900
.           Mods for SX identification of multiple theatre booking
. V10.02.39 21/08/2011  Jill Parkinson CAR 248821
.           Recompiled for PATCOMN2 - fixed alias saving for dob or sex
. V10.02.38 19/08/2011 Davin            CAR 248341
.           Changed to use ptvis062/pmvxedc3 for registrar
. V10.02.37 17/08/2011  J.Tan          CAR 235765
.           Mods for Other insurance free text (SX)
. V10.02.36 02/08/2011  Mike Laming       CAR 241939
.           Mods to CARUPD00 for Episode Coding (patchcof)
. V10.02.35 05/08/2011 Peter Vela       CAR 239559
.           Removed functionality for PTCNDIAI and used DISMASFD.DSMAAICD
.           04/08/2011 Davin            CAR 240723
.           Include team when writing/updating pattranf (pttrteam)
.           Include registrar when writing/updating pattranf (pttrrstr)
.           Include resident when writing/updating pattranf (pttrresi)
. V10.02.34 03/08/2011 Steve Armstrong  CAR 247627
.           Added DGCLICUP trigger for write to patalrtf, patgsrnf & pmsaidaf
.           Also removed HL7ALERT call
.           03/08/2011 Jill Parkinson CAR 240713
.           Added coding error for recurring care
.           04/08/2011 J.Tan          CAR 247870
.           Fixed Private Extra Compensable details
. V10.02.33 03/08/2011 J.Tan          CAR 239592
.           Mods Extra Comp. - Selection of Insurance for a claim code
. V10.02.32 02/08/2011  Jill Parkinson    CAR 242416
.           Recompiled for PATMASTM
. V10.02.31 02/08/2011  Jill Parkinson    CAR 242269
.           Fixed saving of pmvxnwhc
. V10.02.30 01/08/2011  Steve Armstrong   CAR 247602
.           Recompiled for changes to DGCLICCP & DGCLICPE.
.           29/07/2011  Peter Vela        CAR 239559
.           Added PTCNUDPD - Using Disaster Patient Detail parameter to
.           Disaster functionality
. V10.02.29 28/07/2011  Ebon Clements     CAR 243582
.           Added using tracking receipt functionality
. V10.02.28 27/07/2011  Jill Parkinson    CAR 240721
.           Mods to append ur number if surname is unknown
. V10.02.27 26/07/2011  Steve Armstrong   CAR 240684
.           Mods to cater for changes to LEGALTFD
. V10.02.26 25/07/2011  Peter Vela        CAR 239556
.           Check for Z70 when assign MEHVS034 to MHLESTAT @ UPMHVS00
.           25/07/2011  Peter McMullen    CAR 240722
.           Include middle name in alias processing
. V10.02.25 22/07/2011  Davin             CAR 240723
.           Use mlthcp dates if they exist to validate doctors active dates
.           when admitting (actdoc00)
. V10.02.24 20/07/2011  J.Tan             CAR 239592
.           Mods to pmsresaf file
.           21/07/2011  Jill Parkinson   CAR 240721
.           Recompiled for PATCOMN2 - valdur not to call WAMD0000
. V10.02.23 19/07/2011  Ebon Clements     CAR 242070
.           Added extra compensable functionality for AH visits
. V10.02.22 18/07/2011  Peter Vela        CAR 240067
.           Recompiled for PATMSXTM
. V10.02.21 15/07/2011  Steve Armstrong   CAR 245199
.           Added HL7 trigger for WRPMCEX, UPPMCEX & DEPMCEX calls.
. V10.02.20 13/07/2011  J.Tan             CAR 239592
.           Mods for Outpatient Extra compensable
.           13/07/2011  Steve Armstrong   CAR 240722
.           Further mods to cater for second given name as
.           part of PATGSRFD keys
. V10.02.19 08/07/2011  Mike Laming       CAR 240724
.           Mods to MRT Tables to add Hospital Id. (MRTMASaf MRTLOCaf MRTHISaf)
.           22/06/2011  Steve Armstrong   CAR 240722
.           Mods to cater for changes to PATGSRFD:
.                - GSRSNAM & GSRGNAM extended to 30 chars.
.                - PTGSGNM2 added.
.                - all indexes changed in length.
.           Mods to cater for changes to PATLOCFD.
.                - LSNAME & LGNAME extended to 40 chars.
.                - PTLCGNM2 added.
.           Mods to cater for changes to PMSCURFD:
.            - PMCUSURN & PMCUGNAM extended to 40 chars.
.            - PMCUGNM2 added.
.           Also recompiled for changes to PATDISCH.
.           01/07/2011  Jill Parkinson CAR 245506
.           Fixed changing of nzpspraf created fields
. V10.02.18 28/06/2011  Jill Parkinson CAR 222655
.           Mods to fix read of opretaf in GETTH000
. V10.02.17 27/06/2011  Jill Parkinson CAR 242269
.           Added tag for patient with a current Gold DVA card
. V10.02.16 16/06/2011  J.Tan          CAR 239592
.           Mods for Overseas student/visitor visit view
.           20/06/2011  Ebon Clements  CAR 242416
.           Recompiled for PMSPX2FD - Added health fund contributor name
.           24/06/2011  Peter Vela     CAR 239556
.           Recompiled for MEHVI1FD
. V10.02.16 16/06/2011  J.Tan          CAR 239592
.           Mods for Overseas student/visitor visit view
. V10.02.15 16/06/2011  Ebon Clements  CAR 239530
.           Added demographics confirmed date updated by functionality
. V10.02.14 14/06/2011  J.Tan          CAR 239592
.           Mods for Student overseas/Visitor overseas residency details
. V10.02.13 08/06/2011  Jill Parkinson CAR 240713
.           Added contmult - continue with multiple admission
. V10.02.12 06/06/2011  Ebon Clements  CAR 239525
.           Added confirm PMI functionality
. V10.02.11 27/05/2011  Saroeun Soeur  CAR 238062
.           clear PMVXTICM
. V10.02.10 18/05/2011  Peter Vela     CAR 239579
.           Added Disaster functionality to pre admissions/admissions
. V10.02.09 18/05/2011  Jill Parkinson CAR 240712
.           Added discharge functionality for recurring care
. V10.02.08 16/05/2011  Peter McMullen CAR 242450
.           Remove link to medical records volume on cancel pre-admission
. V10.02.07 11/05/2011  Mike Laming    CAR 240707
.           Mods to use CLMRTHIS - caused by MRTHISFD file change.
. V10.02.06 04/05/2011  Peter Vela     CAR 239556
.           Added write to mental health visit file @ ADMH0000
. V10.02.05 21/04/2011  Saroeun Soeur  CAR 241294
.           added MRWRT000 - request medical record when new registration is
.           coming from emergency
. V10.02.04 20/04/2011  Jill Parkinson CAR 240721
.           Added URWAARAY for WA health modulus 11 UR check digit
. V10.02.03 14/04/2011  Peter Vela     CAR 239537
.           Added tag for preceding mental health legal status
. V10.02.02 12/04/2011  Jill Parkinson CAR 233088
.           Mods to NOT delete pmsvx1af or patvisaf when cancelling a preadmit
. V10.02.01 07/04/2011  J.Tan          CAR 233269
.           Mods to squeeze PTMI3BDY
. V10.01.16 08/02/2011  Mike Laming    CAR 240067
.           Recompiled for PATMSXTM - mods for Country Names Pulldown list
. V10.01.15 04/03/2011  Peter Vela     CAR 227807
.           Validate for RCH Supervisor Change Patient Details screen
.           @ PREDET94
.           03/03/2011  Jill Parkinson CAR 233154
.           Recompiled for PATMISTM - PTMICONB tag
.           Added postal PRA fields
. V10.01.14 21/02/2011  Jill Parkinson CAR 222655
.           Added packing of NZSPUNTH in WRNZP000
.           Added theatref and theatrek
. V10.01.14 08/02/2011  Mike Laming    CAR 230468
.           Added new routine at ADET7000 for NZ ACC in PMSWX1FD to update
.           every record with the same ACC Number
. V10.01.13 02/02/2011  Steve Armstrong   CAR 237520
.           Mods to remove Detente interface (PATDETNT)
.           25/01/2011  J.Tan          CAR 233038
.           Mods to check for Claim code file for Using matrix
.           Mods to use JHSBFE for Johns Hopkins
. V10.01.12 20/01/2011  Jill Parkinson CAR 236493
.           Added P for Funding Arrangements
. V10.01.11 13/01/2011  Ebon Clements     CAR 236087
.           Added defence force claim functionality
. V10.01.10 11/01/2011  Ebon Clements  CAR 215701
.           Recompiled for BEDBDVCD -  H/F stepdown
. V10.01.09 11/01/2011  Jill Parkinson    CAR 236279
.           Added PTMASNAM
. V10.01.08 10/01/2011  Mike Laming       CAR 214541
.           Changed code to use "SQUEEZE" when creating PTMIS051 (Baby Weight)
. V10.01.07 05/01/2011  Jill Parkinson CAR 235009
.           Fixed UPBKD000 to use ptmis027 for claim type and added
.           update of bkrxuff1 and bkrxuff2
. V10.01.06 21/12/2010  Ebon Clements  CAR 215701
.           Recompiled for BEDBDPRO - H/F stepdown update
. V10.01.05 20/12/2010  Jill Parkinson CAR 233154
.           Added use of PTMICONB
. V10.01.04 13/12/2010  Jill Parkinson CAR 233088
.           Changed to use PMVXFNDM
.           06/12/2010  Ebon Clements     CAR 233927
.           Added reason for hold update to invoice pending
.           30/11/2010  Peter Vela     CAR 233148
.           Initalised PTTRUCID and PTTRUUID before write to pattranf
.           and update to pattranf
. V10.01.03 29/11/2010  Jill Parkinson CAR 227455
.           Added PTMADCDT
. V10.01.02 10/11/2010  Jill Parkinson CAR 233259
.           Recompiled for PATCLMTM - added check for CHOSTYP
. V10.01.01 29/10/2010  Peter Vela     CAR 232434
.           Added tag for Theatre Booking Comments
. V10.00.25 06/10/2010  Ebon Clements  CAR 231396
.           Recompiled for BEDBDVCD - Post op records expected ward/bed
. V10.00.24 04/10/2010  Ebon Clements     CAR 230239
.           Added read of default MRT parameters to INIT0000
. V10.00.23 22/09/2010 J.Tan            CAR 218066
.           Added Query selection to Eligibility Pre-existing ailment
.           22/09/2010 Jill Parkinson   CAR 222489
.           Added update of pmscuraf
. V10.00.22 20/09/2010  Mike Laming       CAR 229732
.           Re-Compiled for ACCEXTRA - ACC XML Extract changes
. V10.00.21 17/09/2010  Ebon Clements     CAR 230239
.           Re-Compiled for MRTVISCD - Home Location and Document type test
. V10.00.20 31/08/2010  Mike Laming       CAR 228831
.           Re-compiled for ACCEXTRA - Change "Occupation" to use PTCDNHCP
. V10.00.19 25/08/2010  Jill Parkinson    CAR 224320
.           Added clears of pvisite
. V10.00.18 24/08/2010  Jill Parkinson    CAR 216702
.           Mods to write to patunaaf when cancelling preadmissions
. V10.00.17 20/08/2010  Steve Armstrong   CAR 228545
.           Added RDMISS1 for OEC processing prior to checking ASTAT value
. V10.00.16 18/08/2010  Jill Parkinson    CAR 223114
.           Added ADDSPR92 error message
. V10.00.15 18/08/2010  Jill Parkinson    CAR 220984
.           Mods to ADDSPR00 - fixed duration when adding a procedure which
.           will become the primary
. V10.00.14 18/08/2010  Davin             CAR 223805
.           Recompiled for PATVISTM
. V10.00.13 11/08/2010  Ebon Clements    CAR 228051
.           Added check for Other Contacts screen 022 -  PREDET94
. V10.00.12 29/07/2010  Steve Armstrong  CAR 227100
.           Fixed setting of KEY31 prior to CALL on RAPMAID1 (NWALID00)
. V10.00.11 07/07/2010 Mike Laming       CAR 220069
.           Re-compiled for PATVISTM - Correct CGI Var for PMVXINGP
. V10.00.10 18/06/2010 Mike Laming       CAR 221911
.           Re-compiled for PATMASTM - NZ LS Alerts
. V10.00.09 15/06/2010  Peter Vela     CAR 216620
.           Added tag for EMRVCDFD Primary Diagnosis
. V10.00.08 08/06/2010  Ebon Clements  CAR 207040
.           Recompiled for PMSHPGTM - Manage programs
. V10.00.07 24/05/2010  Jill Parkinson CAR 220389
.           Added Waiting List details to GWCDAT00
. V10.00.06 21/05/2010  Ebon Clements  CAR 207040
.           Recompiled for PMSHPGTM - Manage programs
. V10.00.05 21/04/2010  Jill Parkinson CAR 220389
.           Added GWCDAT00
. V10.00.04 14/04/2010 Steve Armstrong   CAR 219933
.           Recompiled for changes to EMRVCDFD
. V10.00.03 09/04/2010 Steve Armstrong   CAR 219045
.           Recompiled for changes PATMRGFD.
.           31/03/2010  Mike Laming  CAR 217575
.           Recompiled for changes to MEHDIAFD
. V10.00.02 23/03/2010  J.Tan          CAR 218438
.           Mods to update admission fields after changing SX procedures
. V10.00.01 19/03/2010  Steve Armstrong   CAR 135505
.           Added HL7TRGID & HL7INCLD setting for all broadcast messages
.-------------------------------------------------------------------------------
. V9.12.38  24/02/2010  Ebon Clements  CAR 207040
.           Added manage health fund program functionality
.           02/03/2010  Jill Parkinson CAR
.           Added clear of missing PMVX fields
. V9.12.37  01/03/2010  J.Tan          CAR 217058
.           Mods to set AFUNDH for adding a new primary procedure
. V9.12.36  10/02/2010  Peter Vela     CAR 215744
.           Added check for Other Contacts screen and Alias screen @ PREDET94
. V9.12.35  13/01/2010  Ebon Clements  CAR 209034
.           Move zero to GSRBILL before write to surname file for alias UPDALI00
. V9.12.34  22/12/2009  Ebon Clements  CAR 208819
.           Added OP ref letters to ACC list - ACCTAB00
. V9.12.33  30/10/2009  Jill Parkinson CAR 208841
.           Mods to populate updated and created dates and times on pmswx1af
. V9.12.32  07/12/2009  Saroeun soeur  CAR 209737
.           Recompiled for PATMASTM - post ward /bed
. V9.12.31  03/12/2009  Ebon Clements  CAR 204362
.           Recompiled for BEDBDPRO - Clear post op ward
. V9.12.30  02/12/2009  Jill Parkinson CAR 211397
.           Mods to call CURI0000 and PREA0000 in mainline not PROFLD00
. V9.12.29  02/12/2009  Ebon Clements  CAR 210183
.           Allow admit a pre admission that is linked to ED - OUADMF05
. V9.12.28  27/11/2009  Ebon Clements  CAR 210183
.           Allow ED visits to be linked to pre admissions - EMER0000
. V9.12.27  18/11/2009  Jill Parkinson CAR 186042
.           Mods to update PRFA if PKNAME is blank in PRAD0000
. V9.12.26  11/11/2009  WeeLee Koo     CAR 209730
.           Fixed error message (NEWR9140)
. V9.12.25  11/11/2009  Ebon Clements  CAR 208991
.           Recompiled for BEDBDVCD - Post op expected due date
. V9.12.24  04/11/2009  Jill Parkinson CAR 204818
.           Mods to write to bokunqaf when copying booking records
. V9.12.23  23/10/2009  J.Tan    CAR 205381
.           Mods for Fees Estimation Alert - Out of Pocket
. V9.12.22  21/10/2009  Jill Parkinson CAR 207717
.           Recompiled for NEWBDMAS - boarder default preferred accommodation
. V9.12.21  20/10/2009  Jill Parkinson CAR 198893
.           Added WRBL0000 to write boarder link records
. V9.12.20  12/10/2009  J.Tan         CAR 188108
.           Recompiled for CHKCMXPT - I*C on patcmxaf file
. V9.12.19  01/10/2009  Ebon Clements  CAR 205398
.           Recompiled for PMSPX2TM - Transport required
. V9.12.18  29/09/2009  Jill Parkinson CAR 204924
.           Mods to replace ' with spaces in ADIAG1 and ADIAG2
. V9.12.17  23/09/2009  Ebon Clements  CAR 202769
.           Added alternate address functionality (pmscexaf)
. V9.12.16  16/09/2009  Davin          CAR 205246
.           Save nzpspr procedure description (nzsppdes) to patmi1af (adiag1)
.           when updating nzp procedure details in setspr00 & updspr00.
. V9.12.15  10/09/2009  Peter Vela     CAR 205229
.           Added UPEMMRIN indicator and TMRR0000 for update medical record on
.           emergency registration without triage.
. V9.12.14  10/09/2009  Jill Parkinson CAR 204527
.           Fixed setting of BKFLAG
. V9.12.13  08/09/2009  J.Tan         CAR 205303
.           Added Casemix Contract ID
. V9.12.12  02/09/2009  Jill Habasque CAR 175429
.           Mods to ready PTCNNDAT in PATD0000
. V9.12.11  20/08/2009  Davin          CAR 202101 SJOG-WA
.           Recompiled for PATMISTM - change to religious visit tag
. V9.12.10  18/08/2009  Jill Habasque  CAR 203983
.           Added WCFLAG
. V9.12.09  13/08/2009  Jill Habasque  CAR 201265
.           Added cgi for PTMXSLAC
. V9.12.08  05/08/2009  Ebon Clements  CAR 202911
.           Changed PREA0000 to use the admission file index 8
. V9.12.07  28/07/2009  Jill Habasque  CAR 183323
.           Commented out call to FSEQ0000
. V9.12.06  22/07/2009  Jill Habasque  CAR 183323
.           Added CHPR000 - select next procedure as primary in nzpspraf
. V9.12.05  06/07/2009  Peter McMullen CAR 199979
.           Cleat PMVXATIM/ITIM in clear pat vsit CLPV0000
. V9.12.04  24/06/2009  Ebon Clements  CAR 199232
.           Recompiled for BEDBDVCD
. V9.12.03  12/06/2009  J.Tan          CAR 195182
.           Fixed NZPrivate - sequence number of primary procedure
. V9.12.02  10/06/2009  Jill Habasque  CAR 198465
.           Removed clearing of PBDEBT if not on the template
. V9.12.01  21/05/2009  Jill Habasque  CAR 195396
.           Added CPBOK000 - copy booking if preadmit by previous (oncology only
.           20/05/2009  J.Tan          CAR 188108
.           Mods to display warning for existing previous visit
. V9.11.23  23/04/2009  Sandra Barcham CAR 194910
.           Fix automatic folder update for overseas
. V9.11.22  08/04/2009  Peter Vela     CAR 183976
.           Added PTVIS111 - PMVXPILC Presenting Illness Code
.           09/04/2009  Jill Habasque  CAR 159753
.           Added boarderf functionality
. V9.11.21  07/04/2009  Jill Habasque  CAR 182606
.           Mods to use PTCNDWAW in UPBKD000
. V9.11.20  06/04/2009  Ebon Clements  CAR 188090
.           Added MRCNEMRT - Auto track medical record to ED on PMI registration
. V9.11.19  17/03/2009  Jill Habasque  CAR 192509
.           Added KEEPBKTM to stop bkreatim getting updated if not wanted
.           and to not update the day oncology view
. V9.11.18  26/02/2009  Peter Vela     CAR 183976
.           Added PMVXPOEC - Consent for Online Eligibility Check
.           Added PTELSPEA - Pre existing ailment for Online Eligibiiility Check
.           Added PTELEADM - Emergency Admission for Online Eligibility Check
. V9.11.17  11/02/2009  Jill Habasque  CAR 186302
.           Added PTCNEMPL
. V9.11.16  15/01/2009  Peter Vela     CAR 185966
.           Added check for 99 lines in PTCMN000
. V9.11.15  15/01/2009  Ebon Clements  CAR 187563
.           Added bed baord functionality to bed request update
. V9.11.14  12/01/2009  Ebon Clements  CAR 174080
.           Added post op bed to UPBKD000
.           Added Post op ward/bed validation - VALDPO00
. V9.11.13  22/12/2008  Ebon Clements  CAR 174080
.           Recompiled for BEDBDVCD - Ward not assigned
. V9.11.12  11/12/2008  Ebon Clements  CAR 174080
.           Recompiled for BEDBDVCD - Post op bed
. V9.11.11  11/12/2008  Ebon Clements  CAR 174080
.           Fixed js error on PDIREC00
. V9.11.10  26/11/2008  Ebon Clements  CAR 174057
.           Added bed board functionality
. V9.11.09  20/11/2008  Ebon Clements  CAR 183976
.           Added eclipse health fund alias functionality
.           21/11/2008  Jill Habasque  CAR 184016
.           Mods to only call CARUPD00 if astat<>1
. V9.11.08  06/11/2008  Peter McMullen CAR 174725
.           convert internal javascript to W3C standards
. V9.11.07  29/10/2008  Peter Vela     CAR 176048
.           Fix ADMISSNO validation in MBDEF000
. V9.11.06  28/10/2008  Ebon Clements  CAR 177572
.           Added trap around write to care team - WCARE000
. V9.11.05  27/10/2008  Ebon Clements  CAR 176179
.           Added trap around write to bed management header - UPPBMH50
. V9.11.04  27/10/2008  Ebon Clements  CAR 181125
.           Added trap around working diagnosis write - WORKD000
. V9.11.03  08/10/2008  Peter Vela     CAR 178815
.           Added UPFOLD00 (update folder colour) in ADET0000
.           (ACC Details) NZ.
. V9.11.02  08/10/2008  Ebon Clements  CAR 174068
.           Update bed board and expected patient file patients name
. V9.11.01  08/10/2008  Ebon Clements  CAR 174075
.           Recompiled for PATMASTM - Display pre adm ward/bed in patient header
.           Added CASMXKEY - casemix key
. V9.10.32  19/09/2008  Mike Laming    CAR 178850
.           Recompiled for ACCEXTRA - change Alt_Work_ind fields
. V9.10.31  18/09/2008  Mike Laming    CAR 178850
.           Recompiled for ACCEXTRA - change default Alt_Work_ind to blank
. V9.10.30  03/09/2008  Davin         CAR 147323
.           Send hl7 message for upd bookings (added call DGCLIS14)
.           Send hl7 message for del bookings (added call DGCLIS15)
. V9.10.29  11/09/2008 Jill Habasque   CAR 178214
.           Mods to output acc flags for red buttons
.           Changed completed to receipted
. V9.10.28  03/09/2008 Jill Habasque   CAR 164652
.           Mods to pack BKREELOS with ASTAY (instead of DBKREELO)
. V9.10.27  21/08/2008  Ebon Clements  CAR 168503
.           Added THEAFLAG = 2 redirect to day oncology booking after new reg
. V9.10.26  12/08/2008  Jill Habasque  CAR 176002
.           Added back open of PMSNEWA2
. V9.10.25  07/08/2008  Ebon Clements  CAR 175252
.           Added bed validation to VALDWB00 and added call at PROADM60
. V9.10.24  07/08/2008  Jill Habasque  CAR 175467
.           Removed file opens that were not used
. V9.10.23  01/08/2008  Mike Laming    CAR 153670
.           Recompiled for ACCEXTRA - changes to Ethnicity & Injury
. V9.10.22  30/07/2008  Mike Laming    CAR 153670
.           Recompiled for ACCEXTRA & ACCNZXML - changes after submission to ACC
.           - added PMSTLEFD/IO (Patients Title table)
. V9.10.21  29/07/2008  Jill Habasque  CAR 174859
.           Mods to only validate marital status if not blank
. V9.10.20  17/07/2008  Ebon Clements  CAR 173713
.           Don't check for unit/c-type for ed admission if vic private CHKEM000
. V9.10.19  16/07/2008  Jill Habasque  CAR 164652
.           Added UPBKD000 - Update booking details with preadmission details
. V9.10.18  15/07/2008  Ebon Clements  CAR 160213
.           Recompiled for update fee estimate functionality changes
. V9.10.17  11/07/2008  Jill Habasque  CAR 172717
.           Mods to delete from pmscuraf in WRCPT000 if outside date range
.           11/07/2008  Ebon Clements  CAR 171268
.           Allow pmi to be updated when cancelled ED visit selected PREDET20
. V9.10.16  10/07/2008  Jill Habasque  CAR 169798
.           Added save ADMISSNO before calling UPDVIS00 in PADM0000(use aadmno)
. V9.10.15  02/07/2008  Mike Laming    CAR 153670
.           Recompiled for ACCEXTRA & ACCNZXML
. V9.10.14  01/07/2008  Mike Laming    CAR 153670
.           Recompiled for ACCEXTRA & ACCNZXML
. V9.10.13  25/06/2008  Jill Habasque  CAR 171734
.           Added message, cannot change primary invoices already printed
. V9.10.12  19/06/2008  Jill Habasque  CAR 170222
.           Mods to move 1 to nzspprim in ADDSPR20 if no primary proc exists
. V9.10.11  19/06/2008  Mike Laming    CAR 168794
.           Recompiled for PATRE1TD/TM - added PTREMOBL (PTRA010) in P.R.A
. V9.10.10  12/06/2008  Mike Laming    CAR 168794
.           Recompiled for PATMASTM & PATMSXTM - added Domicile Description
. V9.10.09  04/06/2008  Jill Habasque  CAR 159333
.           Mods to only update all other TAC records if not C-U
. V9.10.08  29/05/2008  Jill Habasque  CAR 161251
.           Mods to write to patasfaf for Admission type HDP=N
. V9.10.07  20/05/2008  Jill Habasque  CAR 168210
.           Fixed WRNZP000 to find the primary procedure (not the first)
. V9.10.06  19/05/2008 Ebon Clements   162051
.           Added PTMIDOFR default to pre admit from booking - RSETB000
. V9.10.05  13/05/2008 Ebon Clements   161800
.           Added default of the ambs to pre admit from booking - MBDEF000
. V9.10.04  13/05/2008 J.Tan          CAR 162313
.           Added Deposit status to comdepaf
. V9.10.03  01/05/2008  Mike Laming   CAR 153670
.           Recompile for file changes for NZ ACC (PMSWX1FD/IO)
. V9.10.02  30/04/2008 Jill Habasque  CAR 165994
.           Mods to populate WTEPEDOB for ESIS
. V9.10.01  30/04/2008 Sandra Barcham  166622
.           Fix emergency default date if nurse seen date & time is blank
. V9.09.47  16/04/2008  J.Tan
.           Mods to set NZP Funder Contribution - UFCN0000
. V9.09.46  15/04/2008  Jill Habasque  CAR 166369
.           Added check for spaces in nzsppdes in ADDSPR00
. V9.09.45  11/04/2008  Jill Habasque  CAR 161251
.           Recompiled for PMSPX2TM - changed PMPMI006 to not get cleared
. V9.09.44  01/04/2008  Jill Habasque  CAR 165137
.           Moved move of PTCNCMYN to be in PPRE0000 instead of UPDMIS00
. V9.09.43  07/03/2008  J.Tan     CAR 163451
.           Recompile for PATMISTM - Default casemix payment from parameter
.           Fixed CMIX000 to check for PTHFUCMX instead of PTHFUMTD
. V9.09.42  06/03/2008  Mike Laming   CAR 153670
.           Add ACC XML routines ACCNZXML.INC & ACCEXTRA.PBL & mods at ACCD0000
.           07/03/2008  Ebon Clements CAR 163155
.           Fixed display of aae visit details
. V9.09.41  04/03/2008  Peter Vela    CAR 161153
.           More Mods to validate non mandatory Date of Accident TAC patients
.           (private template)
. V9.09.40  04/03/2008  Mike Laming   CAR 153670
.           Add code to update PMSVX1af for Treating Doctor at ADET8000
. V9.09.39  04/03/2008  Ebon Clements CAR 144114
.           Don't update PRFA when admitting/updating admission - PRAD7000
. V9.09.38  29/02/2008  J.Tan   CAR 156964
.           Mods for WA Mental Health
. V9.09.37  28/02/2008  Jill Habasque CAR 162675
.           Added update of ADIET to PDIET
. V9.09.36  26/02/2008  Peter Vela    CAR 161153
.           Mods to validate non mandatory Date of Accident TAC patients
.           (private template)
. V9.09.35  22/02/2008  Jill Habasque CAR 162396
.           Mods to write to patasfaf for WA if PTCNWAUC=1
. V9.09.34  14/02/2008  Jill Habasque CAR 161621
.           Mods to populate pmvxwebu,pmvxlupd and pmvxlupt when updating
. V9.09.33  12/02/2008  Jill Habasque CAR 161322
.           Mods to populate pmvxwebc,pmvxcdte and pmvxctim when writing
. V9.09.32  30/01/2008  Jill Habasque CAR 160321
.           Mods to move wmbook to admissno
. V9.09.31  29/01/2008  Jill Habasque CAR 155370
.           Added move on one to los for bed board
.           23/01/2008  Jill Habasque CAR 159848
.           Moved move zero to nzspinvd to be only if writing (not updating)
.           23/01/2008  Mike Laming   CAR 156741
.           Added logic to set PMVXVALW & PMVXPALW (Visitors/Phone allowed)
.           routine SVXDF000 in DOAD000 and PADM0000
. V9.09.30  17/01/2008  Jill Habasque CAR 159336
.           Added call to RESCLM00 in PROADM10
. V9.09.29  16/01/2008  Jill Habasque CAR 159305
.           Commented out WEBERR00 in CANUR330 so redirect will work
. V9.09.28  08/01/2007  Ebon Clements CAR 158929
.           Added pack of KEY8 in FPRA9000 when writing patre1af records
. V9.09.27  04/01/2008  Jill Habasque    CAR 142467
.           Mods to output accmdata
. V9.09.26  04/01/2008  Peter McMullen   CAR 158011
.           Re-compiled for change in PMSPX2TM.PBL
. V9.09.25  20/12/2007  Jill Habasque    CAR 126282
.           Added update of update date/time for oprdetaf
. V9.09.24  11/12/2007  Jill Habasque    CAR 150915
.           Fixed storing ptmas045 and ptmas047
.           06/12/2007  Steve Armstrong  CAR 156781
.           Added clear of wattr1af/wattx1af variables in INIVAR00 to
.           prevent data carryover in watqueaf (HL7 messages).
.           05/12/2007 Jill Habasque CAR 156912
.           Fixed pack of PTAFCTYP,PTAFCROL and PTAFCSID with itself and spaces
.           26/11/2007  Peter Vela    CAR 110404
.           New variables for Write and Update to pmsaidaf
. V9.09.23  21/11/2007  Peter Vela    CAR 132264
.           New variables for Write and Update to patchcof
. V9.09.22  15/11/2007 Ebon Clements CAR 151894
.           Added ward/bed request functionality
. V9.09.21  14/11/2007 Jill Habasque CAR 154640
.           Added call to WORKD00 in PROADM00
.           13/11/2007 Peter Vela    CAR 151199
.           Added new Emergency Cancellation status
.           13/11/2007 Jill Habasque CAR 154640
.           Fixed clearing of TWARD/TBED in XADM0000 if CAUDQ=0
. V9.09.20  12/11/2007 Jill Habasque CAR 154039
.           Added update of patmi1af in UPDSPR00
. V9.09.19  07/11/2007 Jill Habasque CAR 153790
.           Added clear of BKREPROC
. V9.09.18  05/11/2007 Jill Habasque CAR 142467
.           Added ACCFFLAG
. V9.09.17  02/11/2007  Ebon Clements  CAR 151800
.           Added retain previous ED location functionality
. V9.09.16  31/10/2007 Ebon Clements  CAR 151935
.           Added option to update U/R comments without updating pmi details
. V9.09.15  24/10/2007 Sandra Barcham CAR 142588
.           Fixed look deleting mrthisaf records at DELHIS00
. V9.09.14  17/10/2007  Peter Vela    CAR 148954
.           Added delete patbmdaf for Cancel Pre-Admission
. V9.09.13  12/10/2007  Jill Habasque CAR 149561
.           Fixed branch in FRPA0000 and added read of PTCNPAOF
. V9.09.12  03/10/2007  Ebon Clements CAR 150561
.           Added PMVXPSOS, PMVXASUT and PMVXPPPT to admission functionality
. V9.09.11  20/09/2007  Peter Vela      CAR 148954
.           Fixed pack KEY30 @ DELBMD00
.           26/09/2007  Jill Habasque   CAR 149180
.           Moved calls to VALP0000 and CHOS0000 to be before GNXTUR
. V9.09.10  20/09/2007  Jill Habasque   CAR 142467
.           Fixed saving of cause of injury for series bookings
.           12/09/2007  Jill Habasque   CAR 142467
.           Mods for ACCDET00 to write multiple records if seriflag=1
.           06/09/2007  Peter Vela      CAR 148954
.           Added functionality for patient admission multiple regime codes.
.           Added functionality for bed management table.
. V9.09.09  05/09/2007  Steve Armstrong CAR 145650
.           Mods for additional triggers for ACC changes
.           28/08/2007  Jill Habasque CAR 135539
.           Added match 005 to EMVCTYPE in CPEMR000
.           27/08/2007  Peter Vela   CAR 147747
.           Added variables for PATCOMN2 Cabrini Health UR format
.           20/08/2007  Steve Armstrong CAR 147953
.           Recompiled for changes to HL7ALERT.
.           22/08/2007  Jill Habasque CAR 148317
.           Added calls to GETSET00
. V9.09.08  09/08/2007  Jill Habasque CAR 142467
.           Removed squeeze of ACC referral comments
. V9.09.07  07/08/2007  Mike Laming    CAR 146598
.           Recompiled for LEGALTFD/IO
. V9.09.06  31/07/2007  Mike Laming    CAR 110404
.           Added PMAIRDAT (Registration Date) to PMSAIDFD/IO
. V9.09.05  31/07/2007  Jill Habasque CAR 142467
.           Re-wrote CPEMR000 (was a tag)
. V9.09.04  25/07/2007  Mike Laming   CAR 145752
.           Added call to CALCAGE in PRAD0000 to set up PRA record for children
. V9.09.03  12/07/2007  Jill Habasque  CAR 142467
.           Mods to call UPWCOM3 instead of UPWCOM1 in ADET0000
. V9.09.02  10/07/2007  Jill Habasque  CAR 142588
.           Added DELHIS00
. V9.09.01  22/06/2007  Neelkamal Pyla/Janet George  CAR 142467
.           Added routines DIAG0000/REFR0000/WCAP0000/ADET0000 respectively
.           to process Diagnosis/Referral/Work Capacity/Accident Details
.           Added routine GETACC00 to get ACC comments
. ----------------------------------------------------------------------
. V9.08.28  16/05/2007  Mike Laming   CAR 140841
.           Fix routine FPRA0000 to use ADMISSNO instead of WCADMNO
. V9.08.27  07/05/2007  J.Tan         CAR 140096
.           Mods PRFA to 'Parent of' for a child
. V9.08.26  26/04/2007  Jill Habasque CAR 138049
.           Added PMVXQASN
. V9.08.25  23/04/2007  Peter Vela    CAR 139117
.           Changed validation for TAC Claims @ UPCLMCD20 and UPCLMCD22
. V9.08.24  24/04/2007  J.Tan         CAR 138966
.           Mods to set PTTREPSD to zero even Hospitalisation days <>0
. V9.08.23  20/04/2007  Ebon Clements CAR 132858
.           Recompiled for PMSWORFD file change
. V9.08.22  12/04/2007  Peter Vela    CAR 126219
.           Recompiled for PMSPX2TM
. V9.08.21  05/04/2007  Jill Habasque    CAR 135535
.           Added write to allrsaaf
. V9.08.20  29/03/2007  Janet George     CAR 109028
.           Added View Only Alias funtionality in LSTALV00 routine
. V9.08.19  23/03/2007  Peter Vela       CAR 136397
.           Fixed ALEMRFLG tag functionality
. V9.08.18  20/03/2007  J.Tan            CAR 120014
.           Recompiled for PATDSBFE - checking for effective date of NZPBFE
. V9.08.17  15/03/2007  Jill Habasque    CAR 135524
.           Added RETURNCD to clrpar and setpar
. V9.08.16  09/03/2007  J.Tan            CAR 120003
.           Mods if no contract write primary funder as payee
. V9.08.15  09/03/2007  Jill Habasque    CAR 89064
.           Added check for bokrc1af before cancelled UR
. V9.08.14  01/03/2007  Jill Habasuqe   CAR 120004
.           Mods to allow admission details to be updated if discharged
. V9.08.13  01/03/2007  Janet George     CAR 120378
.           Added tags for REFRLVIS and BOOKFLAG in SFAL0000
.           28/02/2007  Neelkamal Pyla CAR 128536
.           Modified CANUR000 to check for the record in Legacy Visit File and
.           Alternate Legacy File
. V9.08.12  28/02/2007  Jill Habasque  CAR 120004
.           Added update of claim code and contract if adding a nzspraf record
.           that is included with the primary
. V9.08.11  20/02/2007  Peter Vela    CAR 118225
.           Removed update to Preferred Name and Surname from UPDALI40 and
.           DELNEW00
.           Added update of PATGSR from Preferred Surname and Given Names
. V9.08.10  20/02/2007  Jill Habasque CAR 120004
.           Mods to default anaesthetist and provisional items for nzprivate
. V9.08.09  13/02/2007  Janet George  CAR 114378
.           Populated web user id in field pmpxwbid (pmspx2af)
. V9.08.08  02/02/2007  Peter Vela    CAR 124547
.           Added tag for PTCNDEES
.           Added functionality for PTCNDEES
. V9.08.07  31/01/2007  Peter Vela    CAR 127930
.           Added created by variables to CRMED000
. V9.08.06  24/01/2007  Jill Habasque CAR 113014
.           Added move of 8888 to postcode for OS patients
. V9.08.05  05/01/2007  Jill Habasque CAR 1200013
.           Mods to default opdaprov to ambs for nz private
. V9.08.04  28/11/2006  Jill Habasque CAR 125725
.           Mods to allow B for admission source in PRS2 edits
.           27/11/2006  Ebon Clements    CAR 126035 120001
.           Added write to the working diagnosis file on admission
.           Added follow-up for implant invoicing cgi
.           22/11/2006  Peter Vela       CAR 125165
.           Modified error message to display category description
.           NEWR9200 VASAT910
.           20/11/2006  Jill Habasque CAR 120004
.           Mods to write nzpspraf records
. V9.08.03  01/11/2006  Jill Habasque    CAR 122665
.           Mods to use alternate ID as UR if altidflg=2
. V9.08.02  20/10/2006  Mike Laming      CAR 119915
.           Added V6.14 code to FPRA0000 for Workers Comp. to display Ins.Coy.
. V9.08.01  27/09/2006  Mike Laming      CAR 119915
.           Added FPRA0000 to set PRA Address when Claim Type is W-Workers Comp,
.           V-Veteran Affairs, or M-Motor Vehicle
. ----------------------------------------------------------------------
. V9.07.12  11/09/2006  Peter Vela      CAR 118226
.           Added functionality to submit PTWVAUTH, PTWVDATE Veteran Affairs
.           variables.
. V9.07.11  08/09/2006  Steve Armstrong CAR 107632
.           Added calls to HL7ALERT
. V9.07.10  08/09/2006  Peter Vela       CAR 118225
.           Added functionality to update Pref Name fields in pmspx2af in alias
.           update UPDALI40 DELNEW00
. V9.07.09  07/09/2006  Steve Armstrong  CAR 118139
.           Added call to PMIGTNID to load NHI details before sending A27
.           message (DGCLICPA).
.           29/08/2006  Ebon Clements CAR 117379
.           Added PMVXEOCL, PMVXSLOC, PMVXSCLI & PMVXSTRA
. V9.07.08  25/08/2006  J.Tan         CAR 103365
.           Mods for Johns Hopkins fees
. V9.07.07  16/08/2006  Ebon Clements CAR 115299
.           Fixed position of PTCNDWAW should be 216 not 215
. V9.07.06  24/07/2006  Ebon Clements CAR 99899
.           Fixed series booking update TAC claim details redirect
. V9.07.05  21/07/2006  Peter Vela        CAR 112999
.           Recompiled for EMRVISTM
. V9.07.04  13/07/2006  Mike Laming       CAR 111521
.           Change all Bed Fee & Theatre Fee work areas to FORM 8.2
. V9.07.03  12/07/2006  Ebon Clements     CAR 103365
.           Added adm expected payor functionality
. V9.07.02  07/07/2006  Ebon Clements     CAR 103365
.           Added expected payor functionality to pmi add/update
. V9.07.01  04/07/2006  Janet George      CAR 108278
.           Validations if Expiry Date is expired or closed to expiring
.           in case of "V" indicator(CHKRES00)
.-----------------------------------------------------------------------
. V9.06.04  14/06/2006  Davin S           CAR 104165 QLD HDP 2006
.           Write contract details based on either Cat S or Cat CL (wasf0000)
. V9.06.03  08/06/2006  Steve Armstrong   CAR 108060
.           Recompiled for changes to UPDUR
. V9.06.02  08/05/2006  Peter Vela    CAR 104252
.           Renamed DPTCEURN to PTCEURNO
. V9.06.01  27/04/2006  Jill Habasque CAR 93842
.           Added REGIFLAG
. ----------------------------------------------------------------------
. V9.05.08  05/04/2006  Ebon Clements CAR 100159
.           Recompiled for EMRVISTM - Hospital specific ward selection lists
. V9.05.07  03/04/2006  Ebon Clements CAR 78527
.           Added hospital to current patients
. V9.05.06  29/03/2006  Jill Habasque     CAR 98583
.           Added alternat cgi  - registering alternate ID from search
. V9.05.05  22/03/2006  Ebon Clements     CAR 94905
.           Added visa number to pmsresaf
.           21/03/2006  Jill Habasque     CAR 78520
.           Added update of PMPXIHOS
. V9.05.04  17/03/2006  Ebon Clements CAR 89155
.           Mods for multi hospital medical record locations
. V9.05.03  09/03/2006  J.Tan         CAR 80700
.           Added new option to add/update TAC and Workers Comp claim details
. V9.05.02  09/03/2006  Ebon Clements CAR 78533
.           Mods for PATCODTM - Hospital specific category codes
. V9.05.02  03/03/2006  J.Tan         CAR 94034
.           Added tag for ainvprt (no of invoices printed)
. V9.05.B13 28/02/2006  Ebon Clements CAR 96001
.           Recompiled for PATMISTM - admission weight tag semi colon
. V9.05.B12 15/02/2006  Peter Vela         CAR 51366
.           Added tag for alemrflg
. V9.05.B11 13/02/2006  Peter Vela         CAR 94476
.           Added Replace "+ " for input variables in UPMAD000 and
.           REGNEW00
. V9.05.B10 15/02/2006  Ebon Clements CAR 89479
.           NZ temp ur allocation. Changed MVNHI000 to move PPOST to NHMADOMC
.           not SP70 and added new cgi vars to save ethnicity not hard coded 00
. V9.05.B09 31/01/2006  Peter Vela    CAR 54614
.           Recompiled for PMSQVIFD
. V9.05.B08 30/01/2006  Ebon Clements CAR 93186
.           Mods for REDIRECT length change. Recompiled for IBAWEBDF
. V9.05.B07 12/01/2006  Peter Vela         CAR 90085
.           Fixed zero assignment for PTMAS004 - PBDEBT UPDMAS00
. V9.05.B06 15/12/2005  Peter Vela         CAR 88340
.           Added patient folder overseas/ineligible CHKF0000
.           09/12/2005  Peter Vela         CAR 89839
.           Recompiled for PATMASTM - Added CCENT to tag for PFNDCG
. V9.05.B05 22/12/2005 Ebon Clements CAR 76341
.           Added write of attending HCP to care team details table
.           on admission
. V9.05.B04 20/12/2005  Ebon Clements CAR 7634185191
.           Key length changes for encounter number
. V9.05.B03 19/12/2005  J.Tan              CAR 85191
.           Added Iwi fields
. V9.05.B02 13/12/2005  Steve Armstrong    CAR 88438
.           Recompiled for changes to DGCLICPA (to read PMI details before
.           sending A27 message)
. ----------------------------------------------------------------------
. V9.04.47  30/11/2005  Mike Laming        CAR 86040
.           Add PMVXPRGM/PTVIS099 (Program Code)
. V9.04.46  30/11/2005  J.Tan              CAR 58666
.           Mods for Eligibility
. V9.04.45  28/11/2005  Ebon Clements      CAR 86308
.           Fixed update of emergency visit urnumber in NEWREG00
. V9.04.44  25/11/2005  Mike Laming        CAR 86040
.           Add Tag for Certificates exist in CHKCER00 (via SFAL0000)
. V9.04.43  24/11/2005  Davin S       CAR 83419
.           Recompiled for DGCLICAC - write most recent tran record to pmsqviaf
. V9.04.42  21/11/2005  Ebon Clements CAR 80002
.           Added update of wattr1af after move of 33 to WTWMBSCD - THET3000
. V9.04.41  17/11/2005  J.Tan              CAR 84125
.           Fixed Casepayment field Y/N
. V9.04.40  14/11/2005  Jill Habasque CAR 55028
.           Changed PTMIS016 to a dim
. V9.04.39  08/11/2005  J.Tan         CAR 5866
.           Mods checking for Eligibility when admitting
. V9.04.38  17/10/2005  Jill Habasque CAR 64883
.           Fixed position of read of PTCNDWAW
.           07/10/2005  Ebon Clements CAR 78951
.           Added test for refunded deposits in CPADM040
.           05/10/2005  Jill Habasque CAR 75952
.           Added new pmsresaf fields
. V9.04.37  29/09/2005  Davin         CAR 78165
.           Changed to read last transfer record before sending CAC message
. V9.04.36  26/09/2005  Ebon Clements CAR 56868
.           Recompiled for web user id in DEATHPOL
. V9.04.35  14/09/2005  Ebon Clements CAR 76051
.           Set manually added record to no before write to watesnaf
. V9.04.34  12/09/2005  Ebon Clements      CAR 61061
.           Added PTCNCOMF - Using compensable details patient folders
. V9.04.33  24/08/2005  Ebon Clements CAR 70766
.           Recompiled for hcp file changes - Show free format local gp
. V9.04.32  02/08/2005  Davin         CAR 64087
.           Mods for PAS/CIS and proprietary interface changes
. V9.04.31  13/07/2005 Davin         CAR 66431
.           Recompiled for PATVISTM - Changed hcp practice tag (visf3200)
.           Added open of pmshcgaf
. V9.04.30  08/07/2005  Jill Habasque CAR 62516
.           Mods to only update bokrc1af when cancelling preadmission if not
.           already cancelled
. V9.04.29  15/06/2005  Jill Habasque CAR 60165
.           Fixed writing to watespaf for WL patients only
. V9.04.28  10/06/2005  Jill Habasque CAR 61761
.           Recompiled for IBAWEBCD - Title selection list
. V9.04.27  07/06/2005  Jill Habasque CAR 60165
.           Added WTEPABRG - Indigenous status
.           06/06/2005  Peter Vela    CAR 62361
.           Added outpatient redirect functionality to bhs patweb8905001 and
.           bhs patweb8905003
. V9.04.26  02/06/2005  Jill Habasque CAR 61534
.           Added newborn defaults
. V9.04.25  27/05/2005  Peter Vela    CAR 60167
.           2004 PRS/2 Stat Changes
.           Added C to Admission Source
. V9.04.24  20/05/2005  Jill Habasque CAR 59013
.           Added update of admission comments only
. V9.04.23  12/05/2005  Jill Habasque CAR 52841
.           Fixed unqualified newborn edits
. V9.04.22  29/04/2005  Peter Vela CAR 55214
.           Recompiled for MRTCONFD
.           29/04/2005  Jill Habasque
.           Added pack of spaces for patmasaf variables
. V9.04.21  04/04/2005  Ebon Clements CAR 55594
.           Mods for pre anaesthetic appointment redirects
. V9.04.20  30/03/2005  Jill Habasque CAR 59996
.           Mods to allow outpatient referrals to store ACC information for NZ
. V9.04.19  15/03/2005  Guomin Fu          CAR 55923
.           Added testing of hospital state before TAC number format checking
.           because for NSW, there is no specific format required.
. V9.04.18  07/03/2005  Steve Armstrong    CAR 59137
.           Recompiled for changes to CISINADT, HL7CISIN & HL7CISVR
. V9.04.17  07/03/2005  Peter Vela    CAR 57547
.           Recompiled for PATVADFD and PATVADIO
.           25/02/2005  Jill Habasque CAR 58443
.           Fixed update of waiting list details for medical bookings
. V9.04.16  07/02/2005  Jill Habasque CAR 56347
.           Added updates of PMVXEDU1, PMVXEDU2 and PMVXEDU3
.           21/02/2005  Jill Habasque CAR 58419
.           Mods to only write to watespaf if required
. V9.04.15  27/01/2005  Ebon Clements CAR 56340
.           Removed read locks and unlocks from visit extension file
. V9.04.14  19/01/2005  Jill Habasque
.           Added storing of WTEPMREF
. V9.04.13  22/12/2004  Lina Vo       CAR 55990
.           Changed PMVXPWGT to store FORM 4.2 in FORM6.  Multiply field by 100.
. V9.04.12  09/12/2004  Jill Habasque CAR 54731
.           Added writes to new ESIS tables
. V9.04.11  23/11/2004  Davin             CAR 34707
.           Changed CHKCCD00 to return "1" if at least one valid concession
.           card exists
. V9.04.10  15/10/2004  Peter Vela               CAR 53371
.           Added pmvxread (PTVIS094)
.           Added pmvxusac (PTVIS095)
. V9.04.09  22/10/2004  Ebon Clements            CAR 54412
.           Added ward/bed warnings for intended sex and ward classification
. V9.04.08  25/10/2004 Steve Armstrong  CAR 52359
.           Recompiled for changes to PATSNDX & PATGSRFD
.           25/10/2004  Jill Habasque            CAR 46397
.           Recompiled for MEHVISTM
. V9.04.07  14/10/2004  Ebon Clements            CAR 54202
.           Added SHOWFLAG for concession card popup and redirect
. V9.04.06  06/10/2004  Peter Vela               CAR 49647
.           Recompiled for UPDUR
. V9.04.05  28/09/2004  Ebon Clements            CAR 53703
.           Changed EMER0000 to update the emergency departure date and time
.           with the currect date and time if admitted directly to EOU
. V9.04.04  27/09/2004  Ebon Clements            CAR 53266
.           Multi hospital changes for ADDVIS00 & CRMED000 - medical record link
.           23/09/2004  Ebon Clements  CAR 53561
.           Fixed doctor validations - Active inside can now be referring
.           Recompiled for EMRVISTM - new tag for primary diagnosis description
.           20/09/2004  Jill Habasque  CAR 50611
.           Added PTCNLCLM value of N - no default
. V9.04.03  03/09/2004 Jill Habasque CAR 52836
.           Added clear of ljuscode
. V9.04.02  26/08/2004  Jill Habasque CAR 52930
.           Added write/update of PMVXMHOS
. V9.04.01  18/08/2004  Lina Vo        CAR 52746
.           Added open of pathspaf and included PATHSPFD & IO for PATVISTM
. ----------------------------------------------------------------------
. V9.03.56  10/08/2004  Mike Laming    CAR 40489
.           Changes to Interpreter Visit Details "visintaf" & Audit "visiauaf"
. V9.03.55  28/07/2004 Jill Habasque CAR 50611
.           Added new ACC fields
. V9.03.54  22/07/2004 J.Tan   CAR 51728
.           New tag for default C/P from system parameter
. V9.03.53  21/07/2004 Jill Habasque CAR 51060
.           Fixed provisional diagnosis redirect
. V9.03.52  12/07/2004 Jill Habasque CAR 51060
.           Changed storing of ptmas025
.           15/07/2004 Jill Habasque CAR 51795
.           Added clear of PVIUNQE
. V9.03.51  06/07/2004 Davin      CAR 51372
.           Default ctype admission date/time to screen rather than after
.           posting (for EMR admissions from patweb8901044)
.           06/07/2004 Jill Habasque CAR 51060
.           Added update of PTMIDFAS
. V9.03.50  01/07/2004 Peter Vela CAR 51164
.           Recompiled for PATMASTM, IBACOMN, IBACOMM, IBAWEBDF
. V9.03.49  29/06/2004 Guomin Fu  CAR 47395
.           Fixed a bug that system allows for 2 spaces to be entered followed
.           by 5 digits in TAC number.
. V9.03.48  28/06/2004  Steve Armstrong      CAR 51167
.           Recompiled for changes to HL7CISIN
.           28/06/2004  Ebon Clements        CAR 51189
.           Clear admission file vars before use in PROADM10
. V9.03.47  28/06/2004  Jill Habasque CAR 50617
.           Added call to ISIN0000 if preadmitting-admitting in one step
. V9.03.46  24/06/2004  Peter Vela   CAR 51095  2004 PRS/2 changes
.           Added further edits for Admission Type and Criteria (VATCA000)
. V9.03.45  22/06/2004  J.Tan  CAR 42846
.           Mods to include hospitalisation days for C/P
. V9.03.44  21/06/2004  Peter Vela   CAR 49016  2004 PRS/2 changes
.           Updated edits for Admission Type and Care Type (VASCT000)
.           Updated edits for Admission Criteria and Source(VASCA000)
.           Updated edits for Admission Type and Criteria  (VATCA000)
.           18/06/2004  Mike Laming  CAR 49016  2004 PRS/2 changes
.           Change CARETYPE to 2 chars. and change Cat.CC edits
.           17/06/2004  J.Tan             CAR  49644
.           Added tag for casemix patient
.           17/06/2004  Davin             CAR  34707
.           Added concession card check
.           16/06/2004  Ebon Clements     CAR  50735
.           Open correct outpatient files for user site
.           16/06/2004  Steve Armstrong   CAR  48463
.           Fixed call to UPDVIS00 in UPADM000.
.           15/06/2004  Mike Laming   CAR 49016  July 2004 PRS/2
.           - Add Sex Description routine SEXDSC00 with Code "R" - "Intersex"
.           11/06/2004 Jill Habasque  CAR 44641
.           Added alternate ID
.           07/06/2004 Peter Vela     CAR 49016
.           2004 Statutory Changes - recompiled for PMSPX2TM
.           04/06/2004 Ebon Clements  CAR 50427
.           Added single hcp series booking redirect to OUTWAR00
.           02/06/2004 Ebon Clements  CAR 50363 & 50380
.           Do not create medical records in update pmi details. Removed call
.           to CRMED000 in UPMAD000. Fixed I * D in CRMED000
.           27/05/2004  Steve Armstrong  CAR 48778
.           Mods to add new Change Pre-admission broadcast message (DGCLICCP)
.           26/05/2004  Steve Armstrong  CAR 50082 & 50078
.           Fixed UPDVIS00 so that PMSVX1FD variables are updated on
.           change pre-admission & change admission.  Also fixed TRNUPD00 to
.           ignore pre-admissions.
.           17/05/2004  Steve Armstrong  CAR 49715
.           Mods to change UPMAD000 valid EXIT values from 0, 1 or 2 to
.           1 or 2.
.           26/04/2004  Steve Armstrong   PAS-CIS Product Integration
.           Added calls to cisaxxbr routines and included relevant variables
.           for PAS-CIS Interface  CAR  49679
. V9.03.43  12/05/2003  Guomin Fu        CAR 39616
.           Added checking on PTCNDWAW to decide Adm ward is default to
.           "Expected Ward" or "Exp. Post Op Ward"
.           29/04/2004  Henry Son                CAR 41560
.           Fix not altering TAC details for all the same MABs.
.           03/05/2004 Lina Vo        CAR 42846
.           Added CFINAN tag - Display financial details in patient management.
.           Added RETURNCD tag.
. V9.03.42  16/04/2004 Lina Vo        CAR 48793
.           Changed pre-admission/admission to write Consent to Release info,
.           Privacy Indicator & Homeless status to pmsvx1af.
.           16/04/2004 Ebon Clements  CAR 18703
.           Added doctors active date validation
. V9.03.41  29/03/2004 Ebon Clements  CAR 18703
.           Added transfer source validation
.           19/03/2004 Peter Vela     CAR 13038
.           Recompiled for BOKRECTM
. V9.03.40  ?????????? ?????????      ?????????
.           Skipped          
. V9.03.39  10/03/2004 Guomin Fu      CAR 47828
.           Recompiled for UPDUR
. V9.03.38  01/03/2004 Guomin Fu      CAR 43491
.           Added UUPTMAS1 in UPMAD000 to unlock patient after finishing doing
.           whatever need to do with the patient.
. V9.03.37  26/02/2004 Ebon Clements  CAR 19968
.           Added waitflag cgi for w/list outpatient pre admit redirects
. V9.03.36  16/02/2004 Henry Son      CAR 44617
.           Fix Unable to delete alias.
. V9.03.35  29/01/2004 Davin         CAR 22654
.           Added write to patpeiaf when updating admission/tac details
.           Added write/update to prspmiaf for PRS2 PMI trigger changes
. V9.03.34  23/01/2004 Ebon Clements CAR 38490 and 46979
.           Recompiled for MRTVISCD - Auto create medical records
. V9.03.33  22/01/2004  Guomin Fu     CAR 43491
.           Fixed a bug when posting blank alias it can cause invalid UR lock
.           which can be a problem for other users.
. V9.03.32  16/01/2004  Peter Vela    CAR 38490
.           Removed auto creation of medical record for NZ preadm/adm
.           Added functionality for Create Medical Record tickbox for NZ
.           16/01/2004  Peter Vela    CAR 45066
.           Move zero TO PREVAMDN instead of spaces because PREVADMN is a FORM!
. V9.03.31  19/12/2003  J.Tan  CAR 44093
.           Replaced patcashf with comdepaf file
. V9.03.30  18/12/2003  Peter Vela    CAR 43134
.           Recompiled for MRTCONFD
. V9.03.29  15/12/2003  Ebon Clements CAR 45481
.           Mods for PMSCURFD file change - added outpatient site
. V9.03.28  05/12/2003  Peter Vela    CAR 44809
.           Added tag for PTCNHPCD Purchaser default IBAPAT98 parameter
. V9.03.27  13/11/2003  Peter Vela    CAR 43413
.           Added tag for PTCNHDPS State IBAPAT98 parameter
.           10/11/2003  Jill Habasque CAR 45066
.           Added clear of prevadmn and prevadmd
. V9.03.26  30/10/2003  Jill Habasque CAR 43171
.           Added write of admission comments
. V9.03.25  21/10/2003  J.Tan  CAR 44172
.           Mods for Misc.Theatre item file
. V9.03.24  29/09/2003  Jill Habasque CAR 43296
.           Added use of PTCNGEST
. V9.03.23  23/09/2003  CAR 42882   Mike Laming
.           Change DOWL8000 to write W/L "05" record only - not "05"
.           and "03" - See label DOWL8000 - NBRS change
. V9.03.22  01/09/2003 Peter Vela    CAR 42820
.           Added Rural Patient Initiatives and ESAS to Funding Arrangement
. V9.03.21  12/09/2003 Sandra Barcham    43010
.           Remove file prefix from opens of outpreaf & outphoaf
. V9.03.20  29/08/2003 Peter Vela    CAR 42820
.           Added Rural Patient Initiatives and ESAS to Funding Arrangement
. ........  27/08/2003 J.Tan   36502
.           Mods to write to Unknown GST file if necessary
. ........  26/08/2003 Peter Vela    CAR 42825
.           Recompiled for EMRVISTM
. V9.03.19  25/08/2003 Ebon Clements CAR 42813
.           Recompiled for EMRSITFD changes that were missing in V9 that
.           had been made in 5.09 - EMSTDLOC
. V9.03.18  15/08/2003 23/07/2003  Ebon Clements            CAR 37803
.           Made changes to the update claim details for outpatient booking
.           redirects. PROADM50
. V9.03.17  15/08/2003 Jill Habasque CAR 42395
.           Removed update of patnumwf
. V9.03.16  11/08/2003 Jill Habasque CAR 41815
.           Added update of opdastat
. V9.03.15  22/07/2003 Jill Habasque CAR 21760
.           Fixed read of bokdiaaf
. V9.03.14  21/07/2003 Jill Habasque CAR 41233
.           Fixed write to pmswx1af in EMRINP00
.           21/07/2003 Guomin Fu     CAR 41320
.           Added admission source (Cat S) HDP equivalent H an S for
.           qualification status of U or N in Cat A
. V9.03.13  08/07/2003 Jill Habasque SRF 41139
.           Changed ptmis071 and 72 to dim fields
. V9.03.12  24/06/2003 Jill Habasque SRF 38102
.           Mods for remaining ins for PRS2
. V9.03.11  10/06/2003 J.Tan
.           Mods to check for TAC claim number
.           10/06/2003 J.Habasque SRF 39505
.           Fixed EMRINP00 for WC and Vet Affairs
.           11/06/2003 J.Habasque SRF 39445
.           Added flag for update of folder selection
. V9.03.10  02/06/2003 Jill Habasque SRF 38102
.           New PRS2 validation for 2003
. V9.03.09  30/05/2003 J.Tan
.           Mods to remove comp.record when changing claim to public/private
. V9.03.08  28/05/2003 J.Tan  CAR 39445
.           Mods to update patient folder when admitting patient
. V9.03.07  27/05/2003 Lina Vo       CAR 37504
.           Write SLA/ASGC code from ibapostf to visit extension table for
.           patient pre-admission and admission
.           27/05/2003 J.Tan
.           Mods validating TAC claim no and Accident date
. V9.03.06  22/05/2003 Ebon Clements CAR 38102
.           Added update of new visit extn file fields PMVXINTR and PMVXLNG1
. V9.03.05  22/05/2003 J.Tan  CAR 39218
.           Added warning for validating TAC claim number
. V9.03.04  15/05/2003 J.Tan  CAR 39120
.           Updating visit date of claim details when attending O/P
. V9.03.03  15/05/2003 J.Tan  CAR 39089
.           Mods to cancel claim details when cancelling pre-admission
.           Fixed updating U/R no in claim files for outpatient - CAR 39045
. V9.03.02  14/05/2003 J.Tan  CAR 39020 38845
.           Fixed default claim details to check for Inpatient only or All
. V9.03.01  06/05/2003 J.Tan
.           Recompiled for PATDSBFE -no bed setup for last record of bedfeefile
.           Recompiled for PATCLMTM - default TAC Accident date
. V9.02.132 17/04/2003 J.Tan
.           Added Civil Tort claim details  CAR 20009
.           Fixed TAC error messages
. V9.02.131 14/04/2003 Ebon Clements CAR 38215
.           Clear visit extn file vars when admitting from Emergency map
.           14/04/2003 Ebon Clements CAR 37950
.           Added a new option to admit a pre admission to an emr visit
. V9.02.130 08/04/2003 Ebon Clements CAR 37959
.           Recompiled for PATCLMTM - Insurance claim accepted selection list
. V9.02.129 03/04/2003 J.Tan
.           Mods to TAC Claim number
. V9.02.128 02/04/2003 J.Tan    SRF 37664
.           Recompiled for PATMISTM - Admitting point
. V9.02.127 20/03/2003 Peter Vela    CAR 37438
.           Recompiled for EMRVISTM - Added new tag (EMRA8500)
.           19/03/2003 Ebon Clements SRF 37270
.           Added UPFOLD00 to update patient folder details
.           19/03/2003  J.Tan   SRF 37335
.           TAC claim number must be 5 numerics instead of 6 numeric
. V9.02.126 12/03/2003  Jill Habasque SRF 37025
.           Added branch on exit after VDAT0000
. V9.02.125 26/02/2003  J.Tan SRF 20178
.           Mods to default claim details from previous visit
. V9.02.124 07/02/2003  Tonii CAR 35992
.           Recompiled for PATMISTM
.           03/02/2003  Jill Habasque SRF 34660
.           Added check for ptcnhdps in resclm00
. V9.02.123 21/01/2003  Lina Vo       SRF 22693
.           Added read and display of PTCNUEOC for link to ACC screen.
.           17/01/2003  Jill Habasque SRF 35356 SRF 34064
.           Fixed write to mehlegaf
.           Added delete of pmscuraf and pmsvx1af when cancelling preadmissions
.           17/01/2003  Lina Vo
.           Fix write of decease date to nhimasaf
. V9.02.122 13/01/2003  Lina Vo
.           Write temporary record to nhimasaf when PTCNNHII=1 for new reg.
.           16/01/2003  Jill Habasque SRF 35098
.           Fixed pack of key for patipenf
. V9.02.121 10/01/2003  Steve Armstrong
.           Moved all CGI Template Variables into an include (TMPLVARS.INC)
.           20/12/2002  Jill Habasque
.           Changed ISIN0000 to only check the last admission record
.           20/12/2002  Sylvek Litewka SRF 34523
.           Removed control flag PTCNRTWL (Return Patient to Waiting List)
.           as it's no longer used. Because of this flag patient could not be
.           removed from waiting list in procedure DOWL0000.
. V9.02.120 16/12/2002  Jill Habasque SRF 34511
.           Changed to use the new index on patmi1af for ISUR0000
.           16/12/2002  Sylvek Litewka SRF 34523
.           Added variable CPADM008 (Waiting List Removal Date).
. V9.02.119 13/12/2002  Peter Vela               SRF 33698
.           - Added default read of legal status record for Pre Adm MH from Prev
.           Visit.
.           - Added default read of diagnosis record for Pre Adm MH from Prev
.           Visit.
.           - Recompiled for CLMEHDIA
.           10/12/2002  Peter Vela               SRF 33833
.           Recompiled for CLMEHVIS and MEHVISTM
. V9.02.118 07/12/2002  Peter Vela               SRF 18390/20178
.           Transport Accident Default SRS - Added functionality for updating
.           all TAC records with the same M.A.B. reference number.
.           05/12/2002  Lina Vo                  SRF 22709
.           Changed OPNOUT00 to open outpreaf with site prefix
.           03/12/2002  Peter Vela               SRF 33833
.           Changed read of Mental Health Details View Screen Legal Status: from
.           Initial status to latest status.
.           03/12/2002 Jill Habasque SRF 33602
.           Added update of pviresi when changing master details
. V9.02.117 26/11/2002  Pat Dirito               SRF 22611
.           Added call to ADDVIS00 - Write Medical Record Vist to routine
.           NEWREG00
. V9.02.116 22/11/2002  Sandra Barcham           SRF 33570
.           Changed check for current admission
. V9.02.115 08/11/2002  Ebon Clements            SRF 23307
.           Added a clear of file variable before the write to patlocaf
.           11/11/2002  Jill Habasque
.           Added check for MHCNUSE in PREDET00
. V9.02.114 06/10/2002  Peter Vela               SRF 22829
.           Recompiled for PATMISTM
. V9.02.113 30/10/2002  Peter Vela               SRF 22829
.           Added validation for Contract Spoke Id field to Financial Class
.           for Queenslan HDP extract
.           (patweb8903001.html) Pre-Admission
.           (patweb8904002.html) Change Pre-Admission
.           (patweb8901032.html) Admission
.           28/10/2002  Jill Habasque            SRF 22726
.           Added MH details
. V9.02.112 14/10/2002  Jill Habasque            SRF 22962
.           Fixed branch on ovrcd before wripen1
. V9.02.111 14/10/2002  Jill Habasque            SRF 23022
.           Added check for Admission source Z with admission type O
.           SRF 22726 Added mehvisaf details
. V9.02.110 10/10/2002  Peter Vela               SRF 17693
.           Recompiled for PATMISTM - Admitting Point
. V9.02.109 07/10/2002  Peter Vela               SRF 17693
.           Recompiled for PATVISTM - Admitting Point
. V9.02.108 05/10/2002  Ebon Clements            SRF 20735 21430
.           Update BKREEDAT and BKREATIM for all hospitals except victorian
.           public when the admission and pre admission details are updated.
. V9.02.107 30/09/2002  Ebon Clements            SRF 17768
.           Added update of pmi variable prepat in UPCLMD30
. V9.02.106 26/09/2002  Ebon Clements            SRF 17501
.           Added admission error for PCONT,PMPXABRG and PTYPE NEWR0000
. V9.02.105 17/09/2002  Jill Habasque            SRF 22224
.           Mods to CANUR00 when deleting bokrc1af records
.           Mods not to check for prs2 for calvary
. V9.02.104 17/09/2002  J.Tan
.           Mods to read contract details for all states
. V9.02.103 07/09/2002  Jill Habasque            SRF 21503
.           Mods to allow clearing of ADYHOSP
. V9.02.102 29/08/2002  J.Tan
.           Mods to write to patasf for all states
.           29/08/2002  Jill Habasque            SRF 21127
.           Added admission type W with admission source L for PRS2 edits
. V9.02.101 20/08/2002  Jill Habasque            SRF 21064
.           Added check for bad debts in VALADM00
. V9.02.100 02/08/2002  Ebon Clements            SRF 20215
.           Pack key for no bed file with SP70 before read and write XADM0000
.           30/07/2002  Ebon Clements            SRF 20188
.           Changed UPABK000 to update the interpreter details if the
.           patient is a current admission
.           31/07/2002 J.Tan
.           Update aboriginal in visit file (pmsvx1af) from master (pmspx2af)
. V9.02.99  23/07/2002  J.Tan                    SRF 18497
.           Recompiled for PATMISTM - added patasfaf file
. V9.02.98  15/07/2002  Jill Habasque            SRF 18716
.           Added check for date of accident before date of birth
. V9.02.97  09/07/2002  Ebon Clements            SRF 17676
.           Recompiled for WLHISSUB
. V9.02.96  06/07/2002  Jill Habasque            SRF 19273
.           Recompiled for PATCOMN2
. V9.02.95  03/07/2002  Jill Habasque            SRF 18436
.           Commented out unknown sex error on update master file
. V9.02.94  02/07/2002  Ebon Clements            SRF 18894
.           Added a write to the interpreter file for future outpatient bookings
.           if the PMI details have an interpreter added.
. V9.02.93  01/07/2002  Jill Habasque            SRF 19150
.           Added clear of PMPXELPS
. V9.02.92  28/06/2002  Ebon Clements            SRF 17676 17694 17700
.           Recompiled for WLHISSUB
. V9.02.91  26/06/2002  Bronko sosic
.           Changed the check for c-type to just defult the doctor/nurse seen
.           date/time for the admission date/time. (it feels like i am repeating.           myself)
. V9.02.90  25/06/2002  Bronko sosic
.           Changed the EMR patint being admitted to make common files between
.           EMR and INP routen EMRINP00
. V9.02.89  24/06/2002  Tonii SVHM Transition II Extract 7
.           Changed format of read and write of cciex7af (****)
. V9.02.88  16/06/2002  J.Tan
.           Recompiled for PATMISTM - mods for GST applicable field
. V9.02.87  13/06/2002  Bronko sosic
.           Changed the check for c-type to just defult the triage date/time
.           for the admission. I wish they could make up there minds!
. V9.02.86  12/06/2002  J.Tan
.           Mods to check for hf casepayment
. V9.02.85  11/06/2002  J.Tan
.           Mods to check for default casepayment from system parameter
. V9.02.84  09/06/2002  Bronko sosic
.           Changed the check for c-type to be a general check for ANY
.           EMR patient and allocate a admission date and time
. V9.02.83  06/06/2002  J.Tan
.           Recompiled for CLPATMIS
. V9.02.82  05/06/2002  J.Tan
.           Added variables from patient visit extension file
. V9.02.81  29/05/2002  J.Habasque               SRF 18166
.           Fixed update of patgsrnf
.           Added trap if sigpipe 18229
. V9.02.80  24/05/2002  J.Tan
.           Mods for casemix code
. V9.02.79  22/05/2002  Bronko sosic
.           Added a check on c-type for EMR patients being admited
.           for PRS2
. V9.02.78  21/05/2002  J.Tan
.           Recompiled for PATDSBFE
. V9.02.77  14/05/2002  J.Tan
.           Recompiled for PATMISTM - added casemix code.
.           14/05/2002  Steve Armstrong          SRF 17592
.           Mods to send type "11" message to the Detente interface
.           for all patients, not just booked patients.
. V9.02.76  08/05/2002  J.Tan
.           Modified for Casepayment
.           Jill Habasque SRF 17407
.           Recompiled for PATCOMN2
. V9.02.75  07/05/2002  Jill Habasque 3686
.           Mods to CANUR000
. V9.02.74  22/04/2002  Jill Habasque
.           Added check for TAC patients in RESCLM00
. V9.02.73  21/04/2002  Jill Habasque
.           Added check for current admissions in WRCPT000
. V9.02.72  15/04/2002  Jill Habasque
.           Removed medicare reference warning
. V9.02.71  08/04/2002  Ebon Clements
.           Added function UPADMN00 to update the health fund member number
.           on the admission file
. V9.02.70  04/04/2002  Pat Dirito
.           Added function VISPST00 to Update Visit Extension File postcode.
.           05/04/2002  Tonii  SVHM Transition II extract 7
.           Removed write to CCIEX7AF if patient master details are changed
. V9.02.69  03/04/2002  Pat Dirito
.           Changed UPAD0000 to use PURNO in KEY and the save of vars, as it
.           was using URNUMBER for sav and PURNO for KEY!!
. V9.02.68  23/03/2002  Jill Habasque
.           Fixed cancel preadmission for waiting list patients
.           25/03/2002  Tonii  SVHM Transition II extract 7
.           Added read to patient visit file in TRNSII00 to determine which
.           visit type we are updating (EMR, O/P or I/P)
. V9.02.67  22/03/2002  B.G.Ackland
.           Fix Emergency
. V9.02.66  19/03/2002  B.G.Ackland
.           Fix Emergency
. V9.02.65  06/03/2002  Tonii  St V's Transition II
.           Added TRNSII00 to write to the new Extract 7 table (cciex7af)
.           Program will only write to cciex7af if:
.           - a patient is admitted
.           - visit details corresponding to the extract 7 fields are changed
. V9.02.64  07/03/2002  Jill Habasque
.           Added clearing of PRAUPDFL in CLRPAR00
. V9.02.63  25/02/2002  Kuldeep Singh
.           Added  code to redirect to theatre for patient new booking
. V9.02.62  22/02/2002  Ebon Clements
.           Added CANDET00 to SFAL1200 for booking cancellation flags
.           24/02/2002  Ashwin
.           Added code for admission through Emergency
. V9.02.61  21/02/2002  Jill Habasque
.           Added RSETB000 after checking for current admissions
. V9.02.60  13/02/2002  Jill Habasque
.           Fixed ISIN0000 for outstanding debts
. V9.02.59  12/02/2002  Steve Armstrong
.           Mods to set KEY70 instead of KEY45 prior to calling DGCLICUA
. V9.02.58  11/02/2002  J.Tan
.           Mods to update person responsibility for private practice
. V9.02.57  10/02/2002  Jill Habasque
.           Recompiled for MRTVISCD
. V9.02.56  08/02/2002  Jill Habasque
.           Fixed check for admission time
. V9.02.55  06/02/2002  Jill Habasque
.           Removed check for past date on admission (see CheckAdmitDate)
. V9.02.54  04/02/2002  Jill Habasque
.           Added delete from visintaf when cancelling a preadmission
. V9.02.53  02/02/2002  Ebon Clements
.           Recompiled for WLHISSUB - WATHI002 cgi for effective date
.           02/02/2002  Jill Habasque
.           Fixed update of provisional diagnosis
. V9.02.52  01/02/2002  Greg Horvat
.           Changed the routine CANUR000 to be a procedure & removed unwanted
.           space variables as the program couldnt compile
. V9.02.51  31/01/2002  Jill Habasque
.           Added move of MRCNSTAT to MRMASTAT in CRMED000
. V9.02.50  29/01/2002  Jill Habasque
.           Added clear of EMVIEWRD and medical records fields
. V9.02.49  24/01/2002  Ebon Clements
.           Recompiled for WLHISSUB - effective date history mods
. V9.02.48  22/01/2002  Jill Habasque
.           Fixed write of alias record
. V9.02.47  21/01/2002  Jill Habasque
.           Added write to visintaf when master details updated
. V9.02.46  19/01/2002  Jill Habasque
.           Added change preadmission details
. V9.02.45  16/01/2002  Jill Habasque
.           Fixed default details from theatre bookings
. V9.02.44  08/01/2002  Jill Habasque
.           Fixed write to pmscuraf
. V9.02.43  02/01/2002  Ebon Clements
.           Recompiled for IBACOMN - reset PRGID after scan in HITENTER
. V9.02.42  27/12/2001  Jill Habasque
.           Added VALP0000 (PMI PRS2 validation)
. V9.02.41  19/12/2001  Jill Habasque
.           Added write to visiauaf (Interpreter Audit) & pmscuraf(current pat)
. V9.02.40  17/12/2001  Pat Dirito
.           Added CGI for new PMSVX1FD field PMVXPICD
. V9.02.39  17/12/2001  Jill Habasque
.           Fixed clearing of PRA details
. V9.02.38  12/12/2001  Jill Habasque
.           Added check for PRS2 edits on update of admission details
. V9.02.37  11/12/2001  Jill Habasque
.           Added default of BKRXASRC for bookings
. V9.02.36  10/12/2001  Jill Habasque
.           Added tag for PTCNAGEC
. V9.02.35  07/12/2001  Jill Habasque
.           Mods for PRA details
. V9.02.34  04/12/2001  Jill Habasque
.           Fixed PRS2 edit for health fund/claim code
. V9.02.33  04/12/2001 Katie Nelson/Harvinder   SRF 648628(nz)
.           Recompiled for NHI tags added to PATMASTM
. V9.02.32  30/11/2001  Jill Habasque
.           Added PRS2 edit for health fund/claim code
. V9.02.31  28/11/2001  Jill Habasque
.           Added write to visintaf if interpreter is required
. V9.02.30  26/11/2001  Jill Habasque
.           Added check for onleave beds
. V9.02.29  22/11/2001  J.Tan
.           Fixed not to write to comments file with a blank record at admission
. V9.02.28  19/11/2001  Jill Habasque
.           Mods for PRS2 validations
. V9.02.27  17/11/2001  Jill Habasque
.           Mods for PRS2 validations
. V9.02.26  15/11/2001  Jill Habasque
.           Fixed criterion for admission error
. V9.02.25  13/11/2001  Jill Habasque
.           Added PRAD0000 - default PRA details on admission
. V9.02.24  12/11/2001  Jill Habasque
.           Added VASAT00 - validate admission type/admission source
. V9.02.23  08/11/2001  Mike Laming
.           Rename dgcliupm TO dgclicup
.           Rename dgcliual TO dgclicua
.           Rename dgclicad TO dgclicac
.           Rename dgcliadm TO dgclicad
.           Jill Habasque
.           Commented out call to DGCLICUP in PPRE0000 as this is already
.           called from PPMI0000
. V9.02.22  07/11/2001 Ebon Clements
.           Recompiled for PATMISTM - Referring HCP tag
. V9.02.21  05/11/2001 Jill Habasque
.           Added MANALLOC, manual allocation of UR
. V9.02.20  02/11/2001 Jill Habasque
.           Added read of pmspx2af before dgcliadm
. V9.02.19  29/10/2001 Jill Habasque
.           Fixed maternity edit check
. V9.02.18  29/10/2001 Steve Armstrong
.           Moved call to DGCLICPA from DOBK0000 to CPADM000
. V9.02.17  27/10/2001 Jill Habasque
.           Mods to create a medical record on registration
. V9.02.16  25/10/2001 Bronko Sosic
.           Fixed Provisional Diagnosis Update
. V9.02.15  22/10/2001 Jill Habasque
.           Fixed No bed fee error
. V9.02.14  18/10/2001 Jill Habasque
.           Added expected bed
. V9.02.13  12/10/2001 Jill Habasque
.           Fixed missing visit file error
. V9.02.12  12/10/2001 Jill Habasque
.           Fixed call to NEWR0000 so that it does get called
. V9.02.11  10/10/2001 Jill Habasque
.           Fixed check if patient is already in hospital
. V9.02.10  06/10/2001 Jill Habasque
.           Added new routine for DeleteAlias to output %60 instead of '
. V9.02.09  06/10/2001 J.Tan
.           Changed PTMIS051 from DIM 4 to DIM 6 for ABWGHT
. V9.02.08  27/09/2001 Jill Habasque
.           Fixed temporary UR for manual UR generation
. V9.02.07  25/09/2001 Jill Habasque  Defect 2521
.           Fixed CHAD0000 to return 0 if no address changes have been made
. V9.02.06  19/09/2001 Jill Habasque
.           Added admitbox to automatically admit a patient if checked
. V9.02.05  13/09/2001 Jill Habasque
.           Recompiled for PATMASTM
. V9.02.04  07/09/2001 Jill Habasque
.           Fixed delete of alias
. V9.02.03  05/09/2001 Jill Habasque
.           Added list to output alias without sex and DOB for RCH
. V9.02.02  03/09/2001 Mike Laming   RCH/SVHM
.           Add Datagate API Cancel Booking (DGCLICCB) and
.           API Cancel Pre-admission (DGCLICPA)
. V9.02.01  30.08.2001 Raghu
.           Recompiled for EMRHISFD
. V9.01.02  17.08.2001 J Habasque
.           Recompiled for PATMISTM
. V9.01.01  14.08.2001 J.Tan
.           Recompiled for PATMASTM
. V9.00.02  12.08.2001 Bronko Sosic
.           changed NEWREG00 to write visit record for all emergency visits
.           with a zero ur.
. V9.00.01  03.08.2001 Jill Habasque
.           Commented out call to UPDSUR in PPRE0000 as it is not required when
.           posting a preadmission (should only be called for posting pmi det.)
.           Added check for bed fee file details
. V9.00.B10 19.07.2001 Jill Habasque
.           Mods to call CARUPD00 only when updating admission details (not
.           when creating an admission)
. V9.00.B09 16.07.2001 Jill Habasque SRF 11285
.           Fixed check for MHCNUSE in PADM1500
. V9.00.B08 13.07.2001 Sandra Barcham
.           Replace GP with HCP
. V9.00.B07 13/07/2001 Jill Habasque
.           Fixed call to TRNUPD00 (to be called after updating
.           patmi1af)
. V9.00.B06 25.06.2001 Bronko Sosic
.           Recompiled for changes tp PMSPX2TM
. V9.00.B05 22.06.2001 HPS
.           Removed the Program Funding source and Bugs fixing
. V9.00.B04 29.05.2001 HPS
.           PROFLD20 added
. V9.00.B03 12.05.2001  Bronko Sosic
.           Recompled
. V9.00.B01 12.05.2001  HPS - Ashwin,Sasi,Harvinder
.           Changes for Process Admission,New Function Cancel
.           U/R,Automation of U/R generation
. V5.10.B24 01.05.2001  B.G.Ackland
.           Tidy LSTALI00 Routine
. V5.10.B23 24/04/2001  Ebon Clements
.           Fixed update of sex and date of birth in the
.           surname file. It used to skip the update if
.           your name had not changed. (UPDUR and UPDSUR)
. V5.10.B22 23/04/2001  Glenn Saunders
.           Replace WEBEMCM2 with PATCOMN2 (now web-verted)
. V5.10.B21 19/04/2001  Ebon Clements
.           Added PARCNIND for contact details indicator
. V5.10.B20 11/04/2001  Ebon Clements
.           Made changes for new PATPA1FD layout
. V5.10.B19 11/04/2001  Ebon Clements
.           Made changes for new PATPA1FD layout
. V5.10.B18 11/04/2001  Glenn Saunders
.           Remove access to PTCNSNDX and associated processing.
.           Remove all references to PATSUR file (old s/names).
. V5.10.B17 09/04/2001 Ebon Clements
.           Added validation of sex for age VLSEX000
. V5.10.B16 04/04/2001 Ebon Clements
.           Recompiled for PMSPX2FD layout changes
. V5.10.B15 04/04/2001 Ebon Clements
.           Recompiled for PMSPX2FD layout changes
. V5.10.B14 03/04/2001 Ebon Clements
.           Recompiled for PMSPX2FD layout changes
. V5.10.B13 28/03/2001 Ebon Clements
.           Fixed display of emergency contact details
. V5.10.B12 28/03/2001 Ebon Clements
.           Fixed display of sex for alias
. V5.10.B11 27/03/2001 Ebon Clements
.           Recomplied for PMSPX2FD file changes
. V5.10.B10 26/03/2001 Ebon Clements
.           Added code to maintain the PMSPX2FD master extension
.           file two
. V5.10.B09 20/03/2001 Ebon Clements
.           Changed the update of the previous address file to
.           save the last change for a day not the first
. V5.10.B08 16/03/2001 Ebon Clements
.           Update deceased ind if unknown date of death is Yes
. V5.10.B07 16/03/2001 Ebon Clements
.           Fixed update of PTMAUKDD to patient master file
. V5.10.B06 08/03/2001 Bronko Sosic
.           Fixed Registration of a patient for St V's
. V5.10.B05 03/03/2001 J.Tan
.           Recompiled for PMI Extension file
. V5.10.B04 02/03/2001 J.Tan
.           Mods to check for Unknown Sex
.           Set Registration date to current date
. V5.10.B03 01/03/2001 J.Tan
.           Added PMI extension file variable to NOK/Guardian.
. V5.10.B02 27/02/2001 J.Tan
.           Mods to initialise motor accident board claims fields
. V5.10.B01 26/02/2001  Pat Dirito
.           Fixed a bug for Patients On-Leave at Label GBED4000
.           26/02/2001  J.Tan
.           Recompiled for PATWMAFD
.----------------------------------------------------------------------
. V5.09.B06 21/02/2001  Pat Dirito
.           Changes for Patients On-Leave at Label GBED4000
. V5.09.B05 15/01/2001  Bronko Sosic
.           Recompiled for PATMASTM
.           08/01/2001  Pat Dirito
.           Recompiled for UPDUR
.           08/01/2001  Pat Dirito
.           Added Mobile Phone No. and Web User ID to
.           write to Previous Address file.
. V5.09.B03 04/01/2001  Bronko Sosic
.           Added include MRTVISCD to write a file to
.           MRTVISFD when a visit is added
. V5.09.B02 03/01/2001  J.Tan
.           Added DOB and sex to patgsrnf file
.  V5.08.16 09/11/2000  Katie Nelson
.           Fixed ALACDTE being updated with ADATE
.  V5.08.15 06/11/2000  Katie Nelson
.                          Recompiled for PATMISTM
.                 V5.08.14 04/10/2000  Katie Nelson
.                          No changes/needed to increment version for V5.08
.                 V5.08.13 03/10/2000  Steve Downing
.                          Recompiled for dgcliadm
.                 V5.08.12 20/09/2000 Katie Nelson
.                          509 Changes
.                 V5.08.11 20/09/2000  Caleb Sharman
.                          Changed Health Fund variables to be 8 chars
.                 V5.08.10 22/08/2000 Jill Habasque
.                          Added variables for patdetnt
.                 V5.08.08 17.08.2000 K.C.Nelson
.                          Fixed pre-admitting from a booking to use booking num
.                          15.08.2000 K.C.Nelson
.                          Added parameter read for TRNSFSRC (Transfer Source)
.                          27.07.2000 K.C.Nelson
.                          Recompiled for WLHISSUB
.                 V5.08.07 25.07.2000 K.C.Nelson
.                          Check if patient is deceased before displaying forms
.                 V5.08.06 21.07.2000 K.C.Nelson
.                          Recompiled for WATHISFD
.                 V5.08.05 20.07.2000 K.C.Nelson
.                          Added Display/Add/Delete of Aliases
.                          26/06/2000 K.C.Nelson
.                          NBRS changes.  Write to history file if WMSTAT is
.                          changed to "3".
.                          23/06/2000 B.G.Ackland
.                          Read in Claim Details for Display
.                 V5.08.04 15/06/2000 B.G.Ackland
.                          Added open on patam1a1
.                 V5.08.03 13/06/2000 Katie Nelson
.                          Added open on mrtmasaf
.                 V5.08.02 07/06/2000 Bronko Sosic
.                          Recompiled for PATMASTM
.                 V5.08.01 19/05/2000 Nicole Harrington
.                          Added reads on emrvisaf in PREDET00 for PVITYPE=1
.                 V5.08.00 15/05/2000 Katie Nelson
.                          Port from 5.07
.----------------------------------------------------------------------
.                 V5.07.04 02/02/2000 Steven Watkins
.                          Recompiled for PATMASTM / PATMISTM
.                 V5.07.03 02.12.1999 K.C.Nelson
.                          Created Program - Rewritten from IBAPAT31 V5.07
.----------------------------------------------------------------------
          INC       IBAWEBDF
          INC       WEBDATDF
          INC       IBALPCFD/INC
.
          INC       ACCNZXML/INC
          INC       ACCJSONV/INC        * JSON variables (ACC Claim API)
          INC       NZPSPRTD/INC
          INC       PMSHRDTD/INC
          INC       OPRARDTD/INC
          INC       MULTVISV/INC        * PATDPATH variables          *I-250985
          INC       PATDPTHV/INC        * PATDPATH variables          *I-250985
.
          INC       PMSRESTD/INC
          INC       AAEDE1FD/INC
          INC       ACCAUDFD/INC        ***** new ACC Audit file
          INC       ACCDIAFD/INC        ***** new ACC Diagnosis Details FD
          INC       ACCCMTFD/INC        ***** new ACC Comments file
          INC       ALLCASFD/INC
          INC       ALLCTMFD/INC
          INC       ALLCONFD/INC
          INC       ALLLNKFD/INC
          INC       ALLPCTFD/INC
          INC       ALLREFFD/INC
          INC       ALLRLNFD/INC
          INC       ALLSTSFD/INC
          INC       ALLAUDFD/INC
          INC       ALLRSAFD/INC
          INC       ACCRFPFD/INC        ***** new ACC Referral Details FD
          INC       ACCLODFD/INC        *     ACC Claim Lodgement
          INC       APSMASFD/INC
          INC       BOKDIAFD/INC
          INC       BOKSTAFD/INC
          INC       BOKRC1FD/INC
          INC       BOKUNQFD/INC
          INC       BOKRX1FD/INC
          INC       BOKRQ1FD/INC
          INC       BOKRAUFD/INC
          INC       CATCOMFD/INC
          INC       CCIEX7FD/INC        ***** new CCI FD
          INC       COMDEPFD/INC
          INC       COMERHFD/INC
          INC       DEATHATD/INC
          INC       DISMASFD/INC
          INC       DISPATFD/INC
          INC       DISPTLFD/INC
          INC       EMRCONFD/INC
          INC       EMRDOCFD/INC
          INC       EMRGRCFD/INC
          INC       EMRHISFD/INC
          INC       EMRLOCFD/INC
          INC       EMRSITFD/INC
          INC       EMRUNKFD/INC            * FD Still needed IO makes no diff
          INC       EMRVISFD/INC
          INC       EMRVCDFD/INC
          INC       EMRICDFD/INC
          INC       EOCLNKFD/INC
          INC       IBAALVFD/INC
          INC       IBAPOLFD/INC
          INC       IBAPOSFD/INC
          INC       MEHCJAFD/INC
          INC       MEHDIAFD/INC
          INC       MEHDLSFD/INC
          INC       MEHLEGTD/INC
          INC       MEHLEGFD/INC
          INC       MEHVI1FD/INC
          INC       MEHDS1FD/INC
          INC       MEHVISTD/INC
          INC       MEHHLSFD/INC
          INC       MRTCONFD/INC
          INC       MRTLOCFD/INC
          INC       MRTMASFD/INC
          INC       MRTMOVFD/INC
          INC       MRTHISFD/INC
          INC       MRTPDSFD/INC
          INC       MRTVISFD/INC
          INC       NEWBORTD/INC
          INC       NHIETHFD/INC
          INC       NZHISIFD/INC
          INC       NHIMASFD/INC
          INC       NZPSPRFD/INC
          INC       NZPPFEFD/INC
          INC       NZPCMTFD/INC
          INC       NZPCFNFD/INC
          INC       MLTCFNFD/INC
          INC       MLTHCPFD/INC
          INC       OUTARTFD/INC
          INC       OUTBB1FD/INC
          INC       OUTBOAFD/INC
          INC       OBSPCOFD/INC
          INC       OUTCANFD/INC
          INC       OUTCLIFD/INC
          INC       OUTCONFD/INC
          INC       OUTLKBFD/INC            * Outpat Linked bookings table
          INC       OUTMA1FD/INC
          INC       OUTPREFD/INC
          INC       OUTRF1FD/INC
          INC       OUTRSHFD/INC
          INC       OUTSITFD/INC
          INC       OPRCONFD/INC
          INC       OPRDEAFD/INC
          INC       OPRMBSFD/INC
          INC       OPRARDFD/INC
          INC       OPRDEDFD/INC
          INC       OPRSRGFD/INC
          INC       OPRDEBFD/INC
          INC       OPRNURFD/INC
          INC       OPRSESFD/INC
          INC       OPRSEMFD/INC
          INC       OPRTSMFD/INC
          INC       PATADBFD/INC
          INC       PATAA1FD/INC
          INC       PATAK1FD/INC            * FD Still needed IO makes no diff
          INC       PATALRFD/INC
          INC       PATALWFD/INC            * FD Still needed IO makes no diff
          INC       PATAM1FD/INC
          INC       PATAFEFD/INC
          INC       PATATRFD/INC
          INC       PATATRTD/INC
          INC       PATHDFFD/INC
          INC       PATONHFD/INC
          INC       PATHLFFD/INC
          INC       PATLDFFD/INC
          INC       PATASDFD/INC
          INC       PATASFFD/INC
          INC       PATAU1FD/INC            * Patient U/R Canc. Audit File
          INC       PATBFEFD/INC
          INC       NZPBFEFD/INC
          INC       PATBMDFD/INC
          INC       PATBRDFD/INC
          INC       PATCALAG/INC
          INC       PATCADAT/INC
          INC       PATCFAFD/INC
          INC       PATCHCFD/INC            * Patient Change Code File
          INC       PATCMCFD/INC
          INC       VISMDTFD/INC
          INC       VISMTXFD/INC
          INC       PMSUCHFD/INC
          INC       PMSUCDFD/INC
          INC       PATCMXFD/INC
          INC       PATCOMM/INC
          INC       PATCONFD/INC
          INC       PATCSLFD/INC
          INC       PATCTFFD/INC
          INC       PMSCIDFD/INC
          INC       PMSLRDFD/INC
          INC       PATDADFD/INC
          INC       PATDAYFD/INC
          INC       PATDGWFD/INC
          INC       PATDHEAD/INC
          INC       PATDNRFD/INC
          INC       PATDO1FD/INC
          INC       PATDRGFD/INC
          INC       PATDSCFD/INC
          INC       PATDTHFD/INC
          INC       PATDTRFD/INC
          INC       PATECDFD/INC
          INC       PATECOFD/INC                                     *T0845646
          INC       PATELGFD/INC
          INC       PATEORFD/INC
          INC       PATFN1FD/INC
          INC       PATFX1FD/INC
          INC       PATFHIFD/INC
          INC       PATGSRFD/INC
          INC       PATGTUFD/INC
          INC       PATHSPFD/INC
          INC       PATICDFD/INC
          INC       PATICOFD/INC
          INC       PATIN1FD/INC
          INC       PATINVFD/INC
          INC       PATIPEFD/INC
          INC       PATITMFD/INC
          INC       PATKWCFD/INC
          INC       PATLOCFD/INC
          INC       PATLSDFD/INC
          INC       PMSRELFD/INC
          INC       PMSRESFD/INC
          INC       PMSREGFD/INC
          INC       PATMA1FD/INC
          INC       PATMCHFD/INC
          INC       PMSAIDFD/INC
          INC       PMSPWAFD/INC
          INC       PATMI1FD/INC
          INC       PATLINFD/INC
          INC       PATHOSFD/INC                                      *I-250985
          INC       PATMRGFD/INC
          INC       PATNIDFD/INC            * Patient NMPI File
          INC       PATNIPFD/INC
          INC       PATNOBFD/INC
          INC       PATNUMFD/INC
          INC       PATONLFD/INC
          INC       PATPA1FD/INC
          INC       PATPEIFD/INC
          INC       PATPGRFD/INC
          INC       PATPNIFD/INC
          INC       PATPR1FD/INC
          INC       PATRCAUD/INC
          INC       PATRE1FD/INC
          INC       PATRE1TD/INC            * P.R.A. cgi variables
          INC       PATRGMFD/INC
          INC       PATSDNFD/INC
          INC       PATSFAFD/INC
          INC       PATSTAFD/INC
          INC       PATTFEFD/INC
          INC       PATTRDAT/INC
          INC       PATTRNFD/INC
          INC       PATUNAFD/INC
          INC       PATURAFD/INC
          INC       PATVADFD/INC
          INC       PATVCHFD/INC
          INC       PATVENFD/INC
          INC       PATVISFD/INC
          INC       PATVKCFD/INC
          INC       PATQMHTD/INC
          INC       PATQMHFD/INC
          INC       PATWC1FD/INC
          INC       PATCLMTD/INC      * Claim cgi variables
          INC       PATWMAFD/INC
          INC       PATWR1FD/INC
          INC       PATWVEFD/INC
          INC       PMSAELFD/INC
          INC       PMSALNFD/INC
          INC       PMSALAFD/INC
          INC       PMSARQFD/INC
          INC       PMSAMNFD/INC
          INC       PMSARVFD/INC
          INC       PMSBBDFD/INC
          INC       PMSBRQFD/INC
          INC       PMSCEXTD/INC
          INC       PMSCEXFD/INC
          INC       PATCMTFD/INC
          INC       PMSCMTFD/INC
          INC       PMSDAUFD/INC
          INC       PMSCTCFD/INC
          INC       PMSCCDFD/INC
          INC       PMSCURFD/INC
          INC       PMSDTCFD/INC
          INC       PMSADWFD/INC
          INC       PMSEDWFD/INC
          INC       PMSELFFD/INC
          INC       PMSEPBFD/INC
          INC       PMSEHBFD/INC
          INC       PMSEXTFD/INC
          INC       PMSEXTTD/INC
          INC       PMSCHAFD/INC
          INC       PMSHCGFD/INC
          INC       PMSHCGTD/INC
          INC       PMSHCLFD/INC
          INC       PMSHCLTD/INC
          INC       PMSHCPFD/INC
          INC       PMSHCPTD/INC
          INC       PMSMORFD/INC
          INC       PMSNUTFD/INC
          INC       PMSUPDFD/INC
          INC       PMSUPGFD/INC
          INC       PMSUPOFD/INC
          INC       PMSHPGFD/INC
          INC       PMSHPOFD/INC
          INC       PMSHRDFD/INC
          INC       PMSOECFD/INC
          INC       PMSOECTD/INC
          INC       PMSOESFD/INC
          INC       PMSOESTD/INC
          INC       PMSOOSFD/INC
          INC       PMSMTIFD/INC
          INC       PMSTLEFD/INC            * Patient Titles table
          INC       PMSPAYFD/INC
          INC       PMSPHSFD/INC
          INC       PMSPX2FD/INC
          INC       PMSBORFD/INC
          INC       PMSNEWFD/INC
          INC       PMSRCBFD/INC
          INC       PMSVX1FD/INC            * Patient Visit Extension
          INC       PMSVX1TD/INC
          INC       PMSWORTD/INC
          INC       PMSWORFD/INC
          INC       PMSWTRFD/INC
          INC       PMSWX1FD/INC            * Patient Work Compensation Ext
          INC       PMSRLDFD/INC            * doctor role table
          INC       PREADMVR/INC
          INC       PRIHDBFD/INC
          INC       PRIHREFD/INC
          INC       PRSPMIFD/INC
          INC       RESLNKFD/INC
          INC       RCPBNKFD/INC
          INC       RCPDTEFD/INC
          INC       TMPLVARS/INC       * CGI variables
          INC       VISCMTFD/INC
          INC       VISINTFD/INC
          INC       VISIAUFD/INC
          INC       VISPAYFD/INC
          INC       WATCATFD/INC
          INC       WATCHAFD/INC
          INC       WATHISFD/INC
          INC       WATNBRFD/INC
          INC       WATPROFD/INC
          INC       WATRTDFD/INC
          INC       WATTR1FD/INC
          INC       WATTX1FD/INC
          INC       WATESPFD/INC
          INC       WATESEFD/INC
          INC       WATESNFD/INC
          INC       WATPACFD/INC
          INC       WEBDINVS/INC
          INC       WEBELFFD/INC
          INC       WEBOECFD/INC
          INC       WEBOECTD/INC
          INC       WEBOESFD/INC
          INC       WEBOESTD/INC
.
          INC       WEBOMFFD/INC
          INC       WEBOEMFD/INC
          INC       WEBOEMTD/INC
          INC       WEBOMSFD/INC
          INC       WEBOMSTD/INC
.
          INC       MRTRQDFD/INC        * medical records
          INC       MRTRQHFD/INC
          INC       TFILEVAR/INC
          INC       PMSIPLFD/INC
          INC       PMSNPLFD/INC       * NIHC IHI Polling
          INC       PMSEDGFD/INC       * Effective DRG Dates
          INC       PATMISTD/INC
          INC       PATMASTD/INC
          INC       PMSVMTFD/INC       * Clinical Codes Value Mapping
          INC       PMSVSCFD/INC       * Clinical Coding Value Set Codes
          INC       PMSVSTFD/INC       * Clinical Coding Value Set ID
          INC       PMSVSCTD/INC
          INC       PMSUKIFD/INC       * Key Words file for Value Set ID
.
          INC       HL7CISFD/INC
          INC       HL7INBFD/INC
          INC       ALLENCFD/INC
          INC       ALLQUEFD/INC
          INC       PMSQPTFD/INC
          INC       PATDDHFD/INC
.
          INC       VISXDCFD/INC
          INC       VISXDCTD/INC
.
ANS2      DIM       2   
ACCNUMBR  DIM       20
ADDNEWPG  FORM      1
ACCPORDN  DIM       20
ADDSECND  FORM      1
ALTOLDVL  DIM       200
ALTNEWVL  DIM       200
ALTTYPE   DIM       3
ATRTYPE   DIM       3
AUDITKEY  DIM       24                      * Audit Key
EREFRLID  DIM       20
EDWDBABY  FORM      1                       * EDWARD Baby detail update flag
VSCMTFLG  FORM      1
VSCMTLIN  FORM      3    
VSTXUNIQ  FORM      3
URCMTFLG  FORM      1
URCMTLIN  FORM      3
URTXUNIQ  FORM      3
QRYDATA1  DIM       240
.
ADMISNID  DIM       20
ADMISCKI  DIM       12
ADMNDATE  DIM       8
ADMREQNO  DIM       10
ADJTIME   FORM      5
ADDWLFLG  FORM      1
ALTIDFLG  FORM      1
ALTIDTYP  DIM       3
BATCHNUM  DIM       8
BEDRFLAG  FORM      1             * Bed Request HL7 A08 send flag
BEDRQQRY  DIM       1
.                                    0 = Send an A08 bed request message
.                                    1 = Don't send an A08 bed request message
BEDTRKEY  DIM       30
.XBFFLAG    FORM      1
BEDRWARD  INIT      "~~B"
.XCNTRCEFR  FORM      1
.XCEFFDATE  DIM       8
BMIINDIC  DIM       1
CNTRFLAG  FORM      1
CNTITEM   FORM      3
CALCTOTD  FORM      4
CCCNSVHM  FORM      1                       * Using SHVM Transition II
CMDLINE   DIM       200                     *I-250985
CODERROR  DIM       10
CONFDEMO  DIM       1
CONTMULT  FORM      1
CONTTYPE  DIM       3
CPAYMFLG  FORM      1
CPMISKEY  DIM       25                      * Confirm PMI OP session redirect
CPYADMNO  DIM       8
.XCMCODE    DIM       9
. For the purpose of UR comments
COMFILAF  FILE      ASCII, FIXED=127
COMFILNM  DIM       8
COMVISAF  FILE      ASCII, FIXED=127
COMVISNM  DIM       8
COPYFLAG  FORM      1
COPYPDEF  FORM      1                       * Copy prev defense detail
CPADM001  DIM       3                       * Booking Cancellation Reason CAT BC
CPADM002  DIM       1                       * Return to Waiting list? (Y/N)
CPADM003  DIM       3                       * Removal Reason
CPADM004  DIM       3                       * Reason for Change of Schedule Adm
CPADM006  DIM       3                       * Theatre Booking Cancellation Reas
CPADM007  DIM       3                       * Booking Cancellation Reason CAT BE
CPADM008  DIM       8                       * Removal Date
CPADM009  DIM       8                       * Removal Date Time
CHNGLEGL  FORM      1                       * change legal status flag
CHNGREVW  FORM      1                       * change review status flag
CHNGMADE  FORM      1                  * flag if some field values have changed
CNCEFLAG  FORM      1
CNCWFLAG  FORM      1
CNMWFLAG  FORM      1
CURRDATE  DIM       8
CURRDATX  DIM       8
DDIND9    DIM       1
DD3BDY    DIM       4
DEADFLAG  FORM      1
DEFSTATD  FORM      1                                      *T0874934
GELNFLAG  FORM      1
GELWFLAG  FORM      1
GELMFLAG  FORM      1
.XDIM8A     DIM       8
DIM8B     DIM       8
DIM9      DIM       9
.XDIM10     DIM       10
DIM18A    DIM       18
.XDIM29     DIM       29
DIM30     DIM       30
.XDIM34A    DIM       34
DIM11A    DIM       11
DIM11     DIM       11
DIM16     DIM       16
.XDISCFLAG  FORM      1
DISCADMN  DIM       8
DISERROR  FORM      1                       * Theatre Booking Cancellation Reas
DISPT001  DIM       9
DISPT002  DIM       20
DIETDTYP  DIM       3
DIETCOMM  DIM       40
DISWARD   DIM       3
DISUNIT   DIM       3
DISBED    DIM       3
DFLTWARD  DIM       3
.
DATRDATM  DIM       23
DCRTDATM  DIM       23
DDELDATM  DIM       23
DREASLD1  DIM       50
DREASLD2  DIM       50
DCRTUSRN  DIM       30
DDELUSRN  DIM       30
.
MVITTYPE  DIM       1
MVITSTAT  DIM       1
.
F3A       FORM      3
F5A       FORM      5
NOLEVDAY  FORM      5
FHIRLOCH  DIM       50
FROMLINK  FORM      8
FRSTGNAM  DIM       40
FULLGNAM  DIM       80
HOSPCODE  DIM       4                                                 *I-250985
HOSPITAL  DIM       25                                                *I-250985
HFHIFUND  FORM      2
.
IGNWRNFL  DIM       1
WRNMESS1  INIT      "Diagnosis Codes that are not accepted by ACC have "
WRNMESS2  INIT      "not been copied"       
.
TOLINK    FORM      8
MURNO     DIM       8
NOLEAVRG  FORM      1
NOBKDES2  DIM       1
BURNO     DIM       8
KEY3A     DIM       3
KEY8A     DIM       8
LASTITEM  FORM      3
KEY35A    DIM       35
KEY35B    DIM       35
LASTTRNS  DIM       16
LOSDINDC  FORM      1
MASTREFN  DIM       8                       * Master referral number
MRFDDATE  DIM       8                       * cgi medically ready for discharge
ORIGADMN  DIM       8
MCNTR     DIM       13[999]
OECMB     DIM       1[999]
OECEPROV  DIM       1
OECEPRV2  DIM       1
OECEPRV3  DIM       1
OECREQIN  FORM      1
EXTRPROV  DIM       9
EXTRPRV2  DIM       9
EXTRPRV3  DIM       9
EXTRPRV4  DIM       9
EXTRPRV5  DIM       9
PREVDETA  DIM       1                 * preadmit from previous detail
PRIMARY   DIM       3
PYAA      INIT      "PYAA"
PYZZ      INIT      "PYZZ"
QUICKREG  DIM       1
QCKREGHD  DIM       1
RACTVFLG  FORM      1
REASADM1  DIM       100
REASADM2  DIM       100
REASADM3  DIM       100
RECURRFL  FORM      1
REMOTENO  FORM      2
TILDA35   INIT      "~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~"
.XSAVEUNIQ  DIM       3
.
SEENDTIM  DIM       16
TESTDTIM  DIM       16
TESTDATE  DIM       8
TESTTIME  DIM       8
.
SAVCLCD   DIM       100
SAVFPRIM  DIM       9
SAVEPHCP  DIM       10               * Used for HCP Audit as SVMAS variable
SAVEPRAC  DIM       10               * are too small
SAVEPCTR  DIM       2
SAVEUSR9  DIM       3
.
SAVESNAM  DIM       40
SAVEXFNM  DIM       40
SAVEXSNM  DIM       40
SAVETITL  DIM       4
SAVEPSEX  DIM       1
SAVEPDOB  DIM       8
SAVEPFGN  DIM       25
SAVEPMST  DIM       3
SAVEPREG  DIM       3
SAVEPCNT  DIM       3
SAVEPTYP  DIM       3
SAVEABRG  DIM       3
SAVEUSR7  DIM       3
SAVEMEDI  DIM       10
SAVEUSR1  DIM       3
SAVEMCCD  DIM       2
SAVEMEDC  DIM       8
SAVECONP  DIM       1
SAVEUPRF  DIM       3
SAVEINTR  DIM       1
SAVELNG1  DIM       3
SAVEPRVI  DIM       3
SAVEFLDR  DIM       3
SAVESN16  DIM       1
SPPXUCC4  DIM       3     
SPPXUCC5  DIM       3     
SPPXATF1  DIM       80     
SPPXATF2  DIM       80    
.
SAVECUID  DIM       8
SAVECDAT  DIM       8
SAVECTIM  DIM       8
SAVEDCDT  DIM       8
.
EXTIM001  DIM       8
.
. SAVE PMSWX1FD fileds to save WC details
SAVENEED  DIM       1
SAVEASST  DIM       1
SAVECONT  DIM       1
SAVEAPPR  DIM       10
SAVEALTW  DIM       1
SAVEUNFD  DIM	    3
SAVEUNFT  DIM       3
SAVEFISD  DIM       8
SAVERNWD  DIM       8
SAVETYPA  DIM       3
SAVESALT  DIM       8
SAVEHPDA  DIM       2
.
SAVKEY14  DIM       14
SAVPKNAM  DIM       30
SAVPKREL  DIM       10
SAVPKAD1  DIM       35
SAVPKAD2  DIM       35
SAVPKSUB  DIM       35
SAVPKAD4  DIM       35
SAVPKPOS  DIM       8
SAVADMIS  DIM       8
SAVEBRDN  DIM       10
SAVEREVW  DIM       3
SAVCLAIM  DIM       3
SCANNEDM  DIM       1
STAFFDEF  FORM      1
STATDISC  FORM      1
STATVTYP  DIM       3
STATVISN  DIM       8
TESTKEY   DIM       30
TESTTRNS  DIM       13
PRECLAIM  DIM       3
SAVCARE   DIM       3
SAVDATA1  DIM       65
SADMISSN  DIM       8
SAVDISKY  DIM       17
SAVEADAT  FORM      8
SAVEADMN  DIM       8
SAVEBRQN  DIM       8
SAVEALIA  FORM      1
SAVEALPR  FORM      1
SAVEDATE  DIM       8
SAVETIME  DIM       5
SAVELOSM  DIM       5
SAVELOSD  DIM       3
SAVESITE  DIM       3
SAVIADAT  DIM       8                       * Save internal ref date active
SAVKEY15  DIM       15
SAVKEY17  DIM       17
SAVKEY8A  DIM       8
SAVKEY18  DIM       18
SAVKEY26  DIM       26
SAVKEY29  DIM       29
SAVKEY31  DIM       31
SAVKEY34  DIM       34
SAVKEY80  DIM       80
SAVTXWRD  DIM       3
SBBED     DIM       3
SBWARD    DIM       3
SCNDGNAM  DIM       40
SJOGAUDT  DIM       1
ADDRAUDT  DIM       1
ALIASSTS  DIM       1
STATADMN  FORM      1
STATDSCH  FORM      1
STBYPAT   DIM       8
STRTTIME  DIM       8
STOPDWAW  DIM       1
REDIREC1  DIM       240
REDIR254  DIM       254
REGIFLAG  FORM      1
RETURNCD  DIM       3
REFRLVIS  DIM       8
RESIDADM  FORM      1                  * Residential admission flag (AH)
REFVISNO  DIM       8                  * Residential admission referral number
REFRDATE  DIM       11                 * Residential admission referral Date
REQUESTN  DIM       10
BOOKFLAG  FORM      1                  * Flag for booking from referral letter
BLANKEXP  FORM      1                  * flag for blank conc.card expiry date
SVDIRECT  DIM       240
UPDHFUND  DIM       1
UPPRAFLG  FORM      1
UNKNOWN   INIT      "UNKNOWN"
UPDRGDAT  FORM      1
USERNAME  DIM       10
DELALDOB  DIM       8
VISITTYP  DIM       2
.
CTYPDATE  DIM       8
CTYPTIME  DIM       8
COMMCNT   FORM      3
CURDTE8   DIM       8
FLDVALUE  DIM       127
FORMACTN  DIM       2
NOMESSAG  FORM      1
NOPROGRM  FORM      1
NOATTRIB  FORM      1
.XFORM12P2  FORM      12.2
FORM2P1   FORM      2.1
FORM2P1A  FORM      2.1
FORM2P2   FORM      2.2
FORM2P2A  FORM      2.2
FORM4P1   FORM      4.1
FORM4P2   FORM      4.2
FORM5     FORM      5
FORM5C    FORM      5
FORM5P2   FORM      5.2
.XFORM6     FORM      6
.
.  Discharge variables
DIM3A     DIM       3
DIM3B     DIM       3
DIM18     DIM       18
.
AGECARAS  DIM       3
DCEASE    DIM       3
DSCHADTT  DIM       6
DSCHADTA  DIM       6
DSCHAUTP  FORM      1
DSCHCOM1  DIM       40
DSCHCOM2  DIM       30
DSCHCRAV  DIM       3
DSCHDEST  DIM       3
DSCHDETY  DIM       3
DSCHDIA1  DIM       50
DSCHDIA2  DIM       50
DSCHDIND  FORM      1
DSCHIRAD  DIM       3
DSCHMBSC  DIM       9
DSCHMHLS  DIM       3
DSCHPALC  DIM       3                                                  *I-53371
DSCHRTOS  DIM       3
DSCHPYSP  DIM       3                                                  *I-53371
DSCHFINP  DIM       3                                                  *I-53371
DSCHREAS  DIM       3
DSCHDPMN  DIM       3
DSCHRCCT  DIM       3                       * HPS Code Ends Here
DSCHSREF  DIM       8
DSCHSTAT  DIM       3
DSCHTRAN  DIM       5
DSCHUSR1  DIM       3
DSCHUSR2  DIM       3
DSCHUSR3  DIM       3
DSCHUSR4  DIM       3
DSCHUSR5  DIM       3
DSECONDS  DIM       2
DSCHUYN1  DIM       1
DSCHUYN2  DIM       1
DSCHUYN3  DIM       1
DSCHCLGP  DIM       12
FORM6A    FORM      6
FORM6P1   FORM      6.1
FORM6P1A  FORM      6.1

KEY13A    DIM       13
HOURS     FORM      2
INDEX     FORM      2
MINUTES   FORM      2
MTIFLAG   FORM      1
NOTIFYHS  DIM       1
NMDSAELI  DIM       1  * Save existing AELIG value
NMDSASRC  DIM       3  * Admission Source
NMDSPHSP  DIM       3  * Principal Health Service Purchaser
NMDSACLS  DIM       3  * Patient Type
NMDSAGNC  DIM       3  * Agency Code
.
ONAME     DIM       30
ONLEAVE   FORM      1
PREVPRFA  DIM       8
RTDAYS    FORM      4
SAVALLW   FORM      6.2
SAVDISC   FORM      6.2
SAVPCEAS  FORM      1
SAVPAUTO  FORM      1
SAVDECDT  DIM       8
SAVKEY9   DIM       9
SAVTMOVE  DIM       1
SAVTTIME  DIM       8
SECONDS   FORM      2
SDCEASE   DIM       3
SP14      INIT      "              "
SVHAONPR  DIM       1
SVHAWBWR  DIM       1
THCFLG    FORM      2
THISTRNS  DIM       16
UPBMSTAT  FORM      1
UPDATPMI  DIM       1
UPDATHRD  DIM       1
.
.   Work Variables
.
VISTTYPE  DIM       5
VINAHUPD  DIM       1
VISCOMIN  DIM       1
.
AUDITYPE  DIM       1                       * Audit Type
ACCAUFLG  DIM       1                       * Audit Flag
ACCDFLAG  DIM       1                       * Diagnosis / Referral Screen Flag
ACCFLAG1  DIM       1                       * Accident Details Flag
CHECKACC  DIM       1                       * Check if it is a new ACC Number
ACCOUNT   FORM      3
.
ANAFNAME  DIM       25
.XNPDAYFLG  FORM      1
.XPCENDDTE  DIM       8
EFTDATE   DIM       8
EMEXP001  DIM       10
.XERRFLAG   FORM      1
PRFNDSRC  DIM       1
ADDORDEL  DIM       1
ATYPDESC  DIM       1
BTYPDESC  DIM       1
CTYPDESC  DIM       1
CHGDEPT   FORM      1
CHGDOCTR  FORM      1
CHGATYPE  FORM      1
.CHGCCLSS  FORM      1
CHGTEAM   FORM      1
CHGRSTR   FORM      1
CHGRESI   FORM      1
ETHNCTY1  DIM       2
ETHNCTY2  DIM       2
ETHNCTY3  DIM       2
ALLOCATE  FORM      1
AUDIFLAG  FORM      1        * Signals which audit type to write.
.XADDCOL    FORM      2
ADMISNO   DIM       8                       * Used for saving booking number
ADMITNOW  FORM      1
ADMITBOX  FORM      1
ADMTFLAG  DIM       1
ADMISFLG  FORM      1
ADD       DIM       2
AMM       DIM       2
AYY       DIM       2
ACC       DIM       2
ACTION    DIM       1
A5TIME    DIM       5
.XADMFLAG   FORM      1
ALTERNAT  FORM      1
ALTERNID  DIM       20
APPSIGHT  DIM       3
DIGHDPCD  FORM      1        * EMR Diagnosis HDP Code Parameter
.
. cgi Variables for Diagnosis Details Table ACCDIAFD
ACCDG002  DIM       3                   * Count
ACCDG003  DIM       5                   * Coding System Code
ACCDG004  DIM       10                  * Diagnosis Code
ACCDG005  DIM       5                   * Side L/R/NA
.
. cgi Variables for Referral Table ACCRFPFD
ACCRD002  DIM       3                   * Count
ACCRD003  DIM       3                   * Referral Provider Type
ACCRD004  DIM       80                  * Other Provider Type
ACCRD005  DIM       100                 * Suggested Treatment Comments Line 1
ACCRD006  DIM       100                 * Suggested Treatment Comments Line 2
ACCRD007  DIM       50                  * Suggested Treatment Comments Line 3
.
. cgi Variables for Lodgement Table ACCLODFD
ACCLO002  DIM       1                   * Status
.
. File Variables for Comments Table ACCCMTFD
TXTLEN    FORM      3                    * Text Length
BODMASIN  DIM       5
BODMASRN  DIM       60
BODMASUW  INIT      "<font color=purple>"
BODMASHE  INIT      "<font color=black>"
BODMASFT  INIT      "<font color=red>"
BOLD      INIT      "<b>"
ENDBOLD   INIT      "</b>"
ENDFONT   INIT      "</font>"
PIPE      INIT      "|"
CHECKREF  DIM       8                       * Auto activate internal referral
CHCKCOMP  DIM       2 
SCRNAME   DIM       3
HEANBHFL  DIM       1
COMSGTAF  FILE      ASCII, FIXED=127
COMAIJAF  FILE      ASCII, FIXED=127
COMCIJAF  FILE      ASCII, FIXED=127
COMAWKAF  FILE      ASCII, FIXED=127
COMSGTNM  DIM       8
COMAIJNM  DIM       8
COMCIJNM  DIM       8
COMAWKNM  DIM       8
COMSGTPR  INIT      "COMSGT"
COMAIJPR  INIT      "COMAIJ"
COMCIJPR  INIT      "COMCIJ"
COMAWKPR  INIT      "COMAWK"
COMMTYPE  DIM       3
CPYPAMIS  DIM       8           * Copy prev Adm for copying prev defense detail
SGTRCMNT  DIM       255
.
.XBFCOL     FORM      1
.XBFEND1    FORM      3
.XBFEND2    FORM      3
.XBFEND3    FORM      3
.XBFEND4    FORM      3
.XBFEND5    FORM      3
.XBFEND6    FORM      3
BOARDERF  DIM       1
.
CANCTHET  DIM       3                  * Theatre Cancellation code
CASETO    DIM       3                  * new case number OPMVSBOK
CBOOK     FORM      1
.XCBFLAG    FORM      1                  * For display bed fee rate
CFILEPRE  DIM       3
CHRCOUNT  FORM      2
CHCKNAME  FORM      1
CHGUR     FORM      1
CHGCGP    FORM      1
CHGATYP   FORM      1
.XCOUNT     FORM      2
CLAIMTYP  DIM       1
CLMUPDFL  FORM      1
.XCMDRG     DIM       9
CALDAYS   FORM      4
.XCOMFLAG   FORM      1
COUNTER   FORM      2
CRMEDREC  FORM      1        * I CAR 38490
CHCKDOCT  DIM       8
CHCKDATE  DIM       8
CHCKTYPE  FORM      1
.
.XDANS1     DIM       20
.XDANS2     DIM       20
.XDANS3     DIM       20
.XDANS4     DIM       20
.XDANS5     DIM       4
.XDANS6     DIM       11
DATACHNG  FORM      1                                                  *I-40489
DAYCOL    FORM      2
DETNFILE  DIM       5
DETNTREC  FORM      2
DIM40     DIM       40
.XDIM20     DIM       20
DIM26A    DIM       26
DOCTCODE  DIM       6
DOCEXIST  DIM       3
DIM1A     DIM       1
DIM2B     DIM       2
DIM3      DIM       3
DIM4      DIM       4
.XDIM5      DIM       5
.XDIM8      DIM       8
DATIME    DIM       5
.XDEFCOL    FORM      1
.XDEFLAG    FORM      1
.XDSCITEM   DIM       30
.XDSPONLY   FORM      "0"        * Display the Bed Fee Only
DSPOECST  DIM       20
DSWOECST  DIM       20
DSWOEMST  DIM       20
DATECALC  DATE      8
.
EXPSTART  DIM       5        * Expected start time : Use to Recalculate starts
EXPDURA   FORM      5        * Expected duration : Recalculate durations
EXPDSDTE  DIM       8        * Calculated Expected Discharge Date
EXPDSTME  DIM       5        * Calculated Expected Discharge Time
EMERFLAG  DIM       1
EMRADMIS  DIM       8        * Emergency visit number
PREVEMRA  DIM       8
EMRADMIT  FORM      1        * Emergency patient admitted to hospital (1=yes)
EMRVISIT  DIM       8        * Emr Visit Number for map view admit a pre admiss
EXPDDAT   DATE      8
EXTCOMIN  DIM       1
.
FILTFDAT  DIM       8
FILTTDAT  DIM       8
FREETXT1  DIM       40
FREETXT2  DIM       40
FREETXT3  DIM       40
FREETXT4  DIM       40
FREETXT5  DIM       40
FREETXT6  DIM       40
FREETXT7  DIM       40
F2A       FORM      2
FORM3A    FORM      3
FORM8     FORM      8
FORM10    FORM      10
.
HDPEQUIV  DIM       2
HEAVIEW1  DIM       1       * CGI var for HEA view/validation    *T0852969
HELPRNT   FORM      3
HBWAIT    FORM      1          * S27/P46 - Waiting Lists (1=ON,  2=OFF)BOKCONFD
HWDSOUR   DIM       3          * S37/P137 - WATCONFD
HFPORT    FORM      8.2
.
HOURTM    DIM       2
HOURD     DIM       2
.
IPADMDAT  FORM      1          * don't update ED discharge date with IP Adm date
ICOMMENT  DIM       50
.
MIN       DIM       2
MINTIME   DIM       2
ENDNAME   DIM       30
SEC       DIM       2
SECTIME   DIM       2
SURNAME   DIM       30
SUPERLEV  DIM       1
GIVNAME   DIM       30
GIVNAM2   DIM       30
JUSTNO    FORM      2
JAVFNAME  DIM       70
JAVGNAME  DIM       30
JAVGNAM2  DIM       30
JAVSNAME  DIM       30
KEEPBKTM  DIM       1
STRTNAME  DIM       30
.
KEY4A     DIM       4
KSECONDS  INIT      ":00"
KWCFIL    INIT      "patkwc"
.
IBAALVIN  DIM       1
IBALV001  DIM       20
.
LABELTYP  DIM       10
LASTITM1  FORM      3
LASTITM3  FORM      3
LASTITM4  FORM      3
LASTITM5  FORM      3
LASTITM6  FORM      3
LJUSCODE  DIM       80
THEADURA  DIM       1                       * Checking for Theatre duration
THEAFLAG  DIM       1                       * Theatre flag
THEATREF  DIM       1                       * Theatre flag for nzprivate
THEATREK  DIM       10                      * Theatre key for nzprivate
OTPTFLAG  DIM       1                       * Outpatient flag
KIDSFLAG  DIM       1                       * for kids template flag
SUPRFUNC  DIM       1                       * for supervisor flag
SESSKEYS  DIM       22
MHLRCODE  DIM       3
MOTHADMN  DIM       8
NOOFDAYS  FORM      3
NEWBORNF  DIM       1
NEWLEGFL  FORM      1
NEWVALID  FORM      1
DOYR2014  FORM      1
NZCLDESC  DIM       25
.
MHCNAUDA  FORM      1              * Auditing mehvi1af ?
MHCNUSE   FORM      1              * Using Mental Health system ?
MHCEMPST  DIM       2              * Which MH UDF for employemnt status?
MHADMFLG  FORM      1
MHCNUDSA  FORM      1              * Using Mental Health Diagnosis Screen ?
MHCNUNIQ  FORM      8              * Next Legal status referral unique number
MHCNMHLS  DIM       2              * Category for allocating MH Legal Status
.                                      ('AC' or 'CC')
MAXDISC   FORM      6.2
.XMAXNUM    FORM      1
MANALLOC  FORM      1
MBSDESC   DIM       40
MESSFLAG  FORM      1              * message flag
.                                     0 = standard visit using patvisaf
.                                     1 = O/P booking
.                                     2 = error getting data
MISUPDFL  FORM      1
MASUPDFL  FORM      1
MRGEFLAG  FORM      1
.XMSGFLAG   FORM      1
MODE      DIM       2
MVMEDREC  DIM       1
RETDFRAE  DIM       1
MRMAS001  DIM       3              * document type
MRMAS002  DIM       4              * home location
MRMAS003  DIM       3              * home Hospital                    *I-240724
.
NEXTPAGE  FORM      1
NADM      FORM      4
.XNBRDAYS   FORM      4
.XNHOSP     DIM       3
NOBEDFLG  FORM      1
.XNOHOSP    FORM      3
NWARD     DIM       3
NBED      DIM       3
.XNUMBER    FORM      3
.
OPERCODE  DIM       4
OLDADATE  DIM       8
OLDDEATH  DIM       30
OLDCEASE  FORM      1                    * parameter used in PRADEATH
ORIGDAYS  FORM      4          * number of original days
ORIGVISI  FORM      3          * number of original visits
OTHRCONT  DIM       1
.
PRNTFORM  DIM       1
PTELG014  DIM       1      * Subject to Pre-Existing Ailment
PTELG033  DIM       1      * Emergency Admission (1=Yes)
PATINS    DIM       3
PATRGPMI  FORM      1          * update PMI flag
PMBRFLAG  FORM      1          * Bed Request Exist flag
PROCSTAT  DIM       13
PLANNED   INIT      "Planned      "
PERFORMD  INIT      "Performed    "
NOTPERFD  INIT      "Not Performed"
.XPENDFUND  DIM       6
.XPENDCLAM  DIM       3
PREADBOK  FORM      1          * Pre-Admit form a booking indicator
PREADMEH  FORM      1          * Pre-Admit from previous MH visit
PREAFLAG  FORM      1
PRECOMPL  FORM      1          * Pre-Admission Complete flag 0=NO, 1=YES
PREVADMN  DIM       8
PREVADMD  DIM       8
PREVADDR  FORM      1
PRIFOUND  FORM      1
PRIMTIME  FORM      5
PRVADMIS  DIM       8
PTCUPDFL  FORM      1
.
PTASF001  DIM       1
PTASF002  DIM       1
PTASF003  DIM       5
.
PTRGM001  DIM       10
PTRGM002  DIM       10
PTRGM003  DIM       10
.
PTDSC003  DIM       8
PTDSC004  DIM       8
PTDSC005  DIM       3
PTDSC006  DIM       3
PRFANEWA  DIM       1
.
CHNGREAS  DIM       3
SUPINSAD  DIM       1
.
SAVKEY11  DIM       11
SAVPPDRG  DIM       4
UPDTMHHL  DIM       1
WATHI002  DIM       8                * Date of change
XDATTIME  DIM       14     * Date/Time (ccyymmddhhmmss)
ZERO6     INIT      "000000"
ZERO20    INIT      "00000000000000000000"
.
ACCFFLAG  FORM      1
REFRFLAG  FORM      1
RJUSCODE  DIM       80
.
SCHDPRNT  DIM       6       * Printer
SCHDCOPY  FORM      3       * No of Copies
STATNCOD  DIM       6       * Stationery Code
SAVKEY16  DIM       16
SAVKEY19  DIM       19
SAVADMN   DIM       8        * save admission number
SAVBOOK   DIM       8
CDTKEY16  DIM       16
UDTKEY16  DIM       16
.XSDIM30    DIM       30
SAVEURNO  DIM       8
.XSAVCOL    FORM      1
.XSAVATYP   DIM       3
.XSAVBTYP   DIM       3
SAVLEGST  DIM       3
SAVLSDAT  DIM       8
.XSAVEND    FORM      3          * Save Last Day in Period
SAVEXTR   FORM      8.2
SAVCASE   FORM      1
.XSAVTOT    FORM      8.2
SAVADATE  DIM       8
SAVADMNO  DIM       8          * Save Admission Key before Scan
SAVATIME  DIM       8          * Save Admission Time
.XSAVPAT    FORM      8.2
.XSAVHF     FORM      8.2
SAVEF10   FORM      10       * save form 10
SAVETWRD  DIM       3
SAVETBED  DIM       3
SAVURNO   DIM       8          * Save Master Key before Scan
SAVKCARD  DIM       20      |  * save variables for kiwi card details
SAVKCEXP  DIM       8       |
SAVKCXMP  DIM       3       |
SAVKFMLY  DIM       12
SAVTDEPT  DIM       3
SCHDPCNT  FORM      2
SCHDPARR  DIM       6[95]
SCHDCARR  FORM      3[95]
STATNARR  DIM       6[95]
PRTFOARR  DIM       1[95]
SELCDATE  DIM       8
SERIFLAG  DIM       1        * Outpatient series booking flag
PARNTBOK  DIM       8        * Parent booking admission number
SIDEDESC  DIM       5
SHOWFLAG  DIM       1
SRCHSNAM  DIM       30
SRCHGNAM  DIM       30
SRCHMNAM  DIM       30
SRCHPDOB  DIM       8
SRCHPSEX  DIM       1
SRCHPAGE  DIM       3
SRCHMEDI  DIM       11
SKEY11    DIM       11
.XSKEY18    DIM       18
SMONDAY   DIM       4
SP12      INIT      "            "
SP100     INIT      "                                   ":
                    "                                   ":
                    "                              "
SPPEML    DIM       80               * Saved email address
SPPXCONP  DIM       1                * Saved Usual Contact for PRFA
SPPXSN16  DIM       1                * save Status Indicator 16
SYEAR     DIM       4
SYSTFLAG  FORM      1                * Flag for system when going to acc details
STORURNO  DIM       8
SURSYST   FORM      1                * Used in UPDUR
.
TACINDCT  DIM       1
TEMPORAR  FORM      1
TRNSFSRC  DIM       5                * cgi param for Transfer Source
TFRSRCE   DIM       5                * temporary Transfer Source code variable
.XTODATE    DIM       8
TODAY     DIM       8
ADMTWARD  DIM       3
ADMITBED  DIM       3
THISYEAR  DIM       4
THETFLAG  FORM      1
TYEARR    DIM       4
.XTOTAL     FORM      8.2
TRANDATE  DIM       8
TOTNDAYS  FORM      4
TOT3BDAY  FORM      4
DELVISIT  DIM       1
TRANTIME  DIM       8
TRNSCODE  DIM       5                       * transfer source code
TRNSDATE  DIM       8                       * transfer source date
.
.XCONTRCID  DIM       6
CASEKEYS  DIM       30
UPPRIM    FORM      1
.XUSEDEF    FORM      1
UPDATETY  FORM      2
UPDTADMN  DIM       1
UPDTTYPE  DIM       1
UPDATET2  FORM      1
UPDATEKY  DIM       22
UPEMMRIN  DIM       1
UNIQUEKY  DIM       10               * theatre unique key
URCHKDGT  FORM      4
URWTARAY  INIT      "234567"
URNLNGTH  FORM      2
URCHKPRD  FORM      2
CHDISDTE  DIM       1
CHDISDT2  DIM       1
URNOWGHT  FORM      1
SAVUNQUE  DIM       10               * theatre unique key
REASCHNG  DIM       3
.HPS added
URGENOVR  FORM      1
WATTRKEY  DIM       19
WTCNA38M  FORM      1                * Sending HL7 A38 ?
WTCNUSBC  FORM      1
WTCNBRSR  FORM      1
WTCNI13M  DIM       1
WTCNI14M  DIM       1
WAITFLAG  FORM      1
.
WARNMESS  DIM       500 
.
VCASE     DIM       1
VCODE     DIM       5
.
WAABWGHT  DIM       6
WAACLSS   DIM       3
WAASRCE   DIM       3
WAEXAUTH  DIM       20
WAEXAUDA  DIM       8
WCFLAG    FORM      1
WARDTYPE  DIM       1
WDATE1    DIM       8
WDATE2    DIM       8
WBOMF001  DIM       3      * Service Type Code
WORKDATE  DIM       8
WLFLAG    FORM      1
YESSADMP  DIM       1      * Adm Paperwork Received
YESSCONO  DIM       1      * Consent Obtained
YESSMEDH  DIM       1      * Medical History Received
CURRADMN  DIM       8
CURRFLAG  FORM      1
CNTPMSNP  FORM      4
CURRHOSP  DIM       50
BKFLAG    FORM      1
POSTADD1  DIM       35
POSTADD2  DIM       30
POSTADD3  DIM       30
POSTADD4  DIM       30
POSTCODE  DIM       8
.
ZERO45    INIT      "045"
.
.   Casemix / DRG
.
.XADDPAT    FORM      8.2
.XADDHF     FORM      8.2
.XADDEND    FORM      4
.XBDAYS     FORM      4
.XDAYPAT    FORM      8.2
.XDAYHF     FORM      8.2
.XDAYEND    FORM      4
.XDIM21     DIM       21
.XDIM23A    DIM       23
.XFORM4B    FORM      4
.XLOWFLAG   FORM      1
.XLUMPAT    FORM      8.2
.XLUMHF     FORM      8.2
.
.   SVHM Transition II variables
.
.   Patient Master details
SVMABDAT  DIM       8             * Patient birth date
SVMASNAM  DIM       20            * Patient Surname
SVMAGNAM  DIM       25            * Patient Givenname
SVMAPOST  DIM       8             * Patient Post code
SVMAPSEX  DIM       1             * patient Sex
SVMAMSTA  DIM       3             * Patient martial status
SVMAPREG  DIM       3             * Patient religion
SVMASUBB  DIM       35            * Patient suburb
SVMACONT  DIM       3             * Patient Country of Birth
SVMAMEDI  DIM       10            * Patient Medicare number
.
.   Patient Admission details
SVMIADAT  DIM       8             * Admission Date
SVMIATIM  DIM       8             * Admission Time
SVMICLSS  DIM       3             * Admission Class (Cat P)
SVMIACLM  DIM       3             * Admission Claim code (Cat CL)
SVMISRCE  DIM       3             * Admission Source (Cat S)
SVMIBWHT  DIM       6             * Admission Weight
SVMICARE  DIM       3             * Patient Care Class (Cat CC)
SVMIVIST  FORM      1             * Patient Religious Visit (Y/N)
SVMIRFGP  DIM       8             * Referring GP
.
.   Patient Visit Extension 2 details
SVVXMDAV  DIM       3             * Mode of arrival (Cat VM)
SVVXIRAD  DIM       3             * Intent to Readmit (Cat VR)
SVVXCADM  DIM       3             * Admission Criterion (Cat VB)
sVVXIDUS  DIM       3             * Intend stat duration (Cat VI)
.
.   Patient PMI Extension details
SVPXHOML  DIM       1             * Homeless (Y/N)
SVPXINTR  DIM       1             * Interpreter Required? (Y/N)
SVPXLNG1  DIM       3             * Language 1                         *I-40489
SVPXABRG  DIM       3             * Aboriginality (Cat VA)
.
. PRS2 PMI Trigger save variables
SAVPBDAT  DIM       8             * birthdate
SAVXABRG  DIM       3             * indig. status
SAVPXGPC  DIM       10            * GP Code
SAVPGPRC  DIM       10            * Practice
SAVPPRVI  DIM       3             * Privacy ind
SAVPCONT  DIM       3             * cob
SAVXLNG1  DIM       3             * pref. language
SAVPPSEX  DIM       1             * sex
SAVPMSTA  DIM       3             * marital status
SAVPTYPE  DIM       3             * resident status
SAVXINTR  DIM       1             * interpreter requ.
SAVPADD2  DIM       35            * address line 2
SAVPSUBR  DIM       35            * suburb
SAVPPOST  DIM       8             * postcode
SAVPMEDI  DIM       10            * medicare number
SAVPMCCD  DIM       2             * medicare code
SAVPREG   DIM       3             * religous group
SAVPOCCU  DIM       3             * occupation     
SAVPSNAM  DIM       40            * surname        
SAVPFGNM  DIM       40            * first given name
SAVPSGNM  DIM       40            * second given name
SAVFUNDH  DIM       6             * Health Fund (EDWARD trigger)
.
. PMI HL7 visit trigger save variables
SAVXPRVI  DIM       3
SAVXRHC1  DIM       10
SAVXRH1G  DIM       10
.
BYPASSCV  FORM      1             * bypass current ED patient visit check?
ISEDLITE  DIM       1             * Flag for whether or not it is ED Lite?
.
SAVINDC2  DIM       1
.
.   Constants
.
ATCHAR    INIT      "@"
.
Cat       INIT      " at "
.
CODEUNK   INIT      "UNK"
CODEA     INIT      "A "
CATCT     INIT      "ct"
CATcz     INIT      "cz"
CATD1     INIT      "D1"
CATD2     INIT      "D2"
CATD3     INIT      "D3"
CATD4     INIT      "D4"
CATD5     INIT      "D5"
CATU6     INIT      "U6"
CATU7     INIT      "U7"
CATDY     INIT      "DY"
CODEBK    INIT      "BK"
CODECL    INIT      "CL"
CODET     INIT      "T "
CODEXM    INIT      "XM"
CATTC     INIT      "tc"
CATtm     INIT      "tm"
CATLWI    INIT      "wi"
.
DASH      INIT      "-"
DLCHAR    INIT      "$"
.
INVADMTP  INIT      "Invalid "
INVALID   INIT      "Invalid admission source with "
.
.XNOFEE     FORM      "0"
.
OCLAIM    DIM       3                    * Old Claim Code
OFUNDH    DIM       6                    * Old Fund
OFNDTB    DIM       8                    * Old Fund Table
OTYPE     DIM       3                    * Old Admn Type
DUMURNO   DIM       8
COUNTERD  DIM       2
.
ALEMRFLG  FORM      1
CARETYPE  DIM       2                                                  *C-49016
DELESN    INIT      "DELETE"
ADMISRC   DIM       1
ADMICRIT  DIM       1
QUALSTAT  DIM       1
ADMITYPE  DIM       1
TEMPVAR   DIM       20
EXPDATE   DATE      8
MEDRTYPE  DIM       3
EMADMISS  DIM       8
FIRSTADM  DIM       8                  * This CGI contains the parent admission
.                                        number for multiple HCP bookings
TRANDTTM  DIM       16
.
.XSEC1      FORM      "00001"
REPUNIQ   INIT      "yzxywxvwuvtustrsqrpqopnomnlmkljkijhighfgefdecdbcab"
TILDA30   INIT      "~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~"
TILDA40   INIT      "~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~"
.
ZERO8     INIT      "0000    "
.
OBB       INIT      "("
CBB       INIT      ")"
STATFLAG  FORM      "0"                * flag for HL7 broadcast of stat. adm.
SUBSYSKY  DIM       50
SUBMITED  INIT      "Submitted"
SENT      INIT      "Sent"
RECEIPTD  INIT      "Receipted"
FAILED    INIT      "Failed"
.
. ACC45 Claim API Failed Status Values
FAILED1   INIT      "Failed - Bad Request: invalid data"
FAILED2   INIT      "Failed - Unauthorized: authentication error"
FAILED3   INIT      "Failed - Forbidden: authorization error"
FAILED4   INIT      "Failed - Not Found"
FAILED5   INIT      "Failed - Internal Server Error"
.
CORSP001  DIM       100
CORSP003  DIM       3
LOOPDAYS  FORM      3
.
CFPAYCOD  DIM       3        * 3M Codefinder PAY Code
DIM256    DIM       256      * SNOMED Value Set Code Preferred Term
.
MESSAGID  DIM       20
CISMFLAG  FORM      1                       * for HL7 messaging
IBAMFLAG  FORM      1                       * for HL7 messaging
.
UPINUMBR  DIM       10       * UPI Number
UPINSPID  DIM       30       * NSLHD Person ID
.
CHWCURNO  DIM       8        * Check UR Number (Workers Compensation)
CHWCADMN  DIM       8        * Check Admission Number (Workers Compensation)
VEMDRESI  DIM       1        * Don't update ED visit resident status
.
REFREJCT  DIM       1        * Flag whether to open reject referral DFrame
.
. File variables for ACC45 Claim API response message (.resp)
ACCRESAF  FILE      ASCII, FIXED=4000
ACCTMPFL  FILE      ASCII, FIXED=127    * Output of shell command for file path
ACCFILNP  DIM       80       * ACC45 Claim response file path (.resp)
ACCRESPM  DIM       4000     * ACC45 Claim response message
.
AUTOMVMR  DIM       1        * Auto move (track) MR to Admitting Ward
.
.---------------------------------------------------------------------------
PRGID     INIT      "PATWEB89"
VERSION   INIT      "V12.00.17"
PRGNAM    INIT      "Admissions Web Server"
.---------------------------------------------------------------------------
.
MAIN0000  CALL      WEBINT00       * Initialise Fifo Etc.
          CALL      INIT0000       * Open Files
.
MAIN1000  CALL      WEBRED00       * Read Fifo WEBPID and USERID
.
          CALL      OUTFIL00       * Check Correct Site Files Are Open
          BRANCH    EXIT,MAIN1000
.
          COMPARE   "999",REPORTNO * End Server Process on Report Option 999
          GOTO      MAIN9000 IF EQUAL
.
MAIN1020  BRANCH    REPORTNO,MAIN1100,MAIN1200,MAIN1300,MAIN1400,MAIN1500:
                             MAIN1600,MAIN1700,MAIN1800,MAIN1900,MAIN2000:
                             MAIN2100,MAIN2200,MAIN2300,MAIN2400
.
          PACK      WEBTITLE,PRGID,SP1,VERSION,SP1,PRGNAM,SP70
          MOVE      "Invalid Option",WEBTITLE
          CALL      ADMERR00   * Create Output File and Write HTML Page Header
          GOTO      MAIN1000
.
MAIN1100  CALL      OUADMF00                * Output (Pre)Admission Form
          GOTO      MAIN1000
.
MAIN1200  MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          CALL      RDPMPX21
          CALL      PROADM00                * Process Admission Details
          BRANCH    EXIT,MAIN1000,MAIN1000
          IF        NEXTPAGE=1
            CALL      WINCLS00              * Close DFrame
          ENDIF
.
          IF        NEXTPAGE=9
            CALL      PREDIR00
          ENDIF
.
.          IF        FHIRTYPE=1
.            CALL      NXTPAG00
.          ENDIF
.
          GOTO      MAIN1000
.
MAIN1300  CALL      NEWPRE00                * Output New Pre-Admission Form
          GOTO      MAIN1000
.
MAIN1400  MOVE      ONE,ADMISFLG
          CALL      OUADMF00
          GOTO      MAIN1000
.
MAIN1500  CALL      NEWREG00                * New Registration Form
          BRANCH    EXIT,MAIN1000
          MATCH     "3",THEAFLAG
          IF        @EQUAL
            CALL      NXTPAG00
          ELSE
            IF        FHIRTYPE=1
              CALL      NXTPAG00 
            ELSE
              CALL      PREDIR00                * Parent Redirect
            ENDIF
          ENDIF
          GOTO      MAIN1000
.
MAIN1600  CALL      OUADMF00
          GOTO      MAIN1000
.
MAIN1700  CALL      MEHVIS00                * Mental health visit details
          BRANCH    EXIT,MAIN1000
          IF        NEXTPAGE=1
            CALL      PREDIR00                * Redirect
          ENDIF
          GOTO      MAIN1000
.
MAIN1800  MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          CALL      RDPMPX21
          CALL      PROCLM00                * Process Claim Details
          BRANCH    EXIT,MAIN1000
          CALL      RDIREC00                * Redirect
          GOTO      MAIN1000
.
MAIN1900  CALL      NZPR0000                * NZ Private procedure details
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2000  CALL      ACCS0000                 * Acc Search
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2100  CALL      BLKD0000                 * Bulk discharge
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2200  CALL      RESI0000                 * Residency Details
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2300  CALL      STAT0000                 * Statistical discharge/readmission
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2400  CALL      REMOTE00      * Remote scripts
          GOTO      MAIN1000
.
MAIN9000  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      ADMERR00
.
MAIN9999  STOP
+
.--------------------------------------------------------------------
. ACCD0000 - Diagnosis / Referral / Accident / Work Capacity  Details
.--------------------------------------------------------------------
ACCD0000  MATCH     "D",ACCDFLAG            * Diagnosis details
          IF        @EQUAL
            CALL      DIAG0000
            GOTO      ACCD9999
          ENDIF
.
          MATCH     "R",ACCDFLAG            * Referral details
          IF        @EQUAL
            CALL      REFR0000
            GOTO      ACCD9999
          ENDIF
.
          MATCH     "L",ACCDFLAG            * Lodgement record
          IF        @EQUAL
            CALL      ACCXMT00              * update ACC Transmit Status
.         NZ only...
            IF        PTCNHDPS=1  
              CALL      MVACCXML            * Add record to accaudaf
            ENDIF
            GOTO      ACCD9999
          ENDIF
.
          MATCH     "A",ACCFLAG1            * Accident Details Flag
          IF        @EQUAL
            MATCH     "1",SERIFLAG
            IF        @EQUAL
              CALL      OUTCLM00
            ELSE
              CALL      ADET0000
            ENDIF
            CALL      NXTPAG00
            GOTO      ACCD9999
          ENDIF
.
          MATCH     "K",ACCDFLAG            * From Work Capacity Screen
          IF        @EQUAL
            CALL      WCAP0000
            GOTO      ACCD9999
          ENDIF
.
          MATCH     "C",ACCDFLAG            * Copy EMR diagnosis
          IF        @EQUAL
            CALL      CPEMR000
            GOTO      ACCD9999
          ENDIF
.
          MATCH     "S",ACCFLAG1            * Accident XML extract
          IF        @EQUAL
            MATCH     "1",SERIFLAG          * update ACC Details first
            IF        @EQUAL
              CALL      OUTCLM00
            ELSE
              CALL      ADET0000
            ENDIF
            CALL      ACCXML00              * (in ACCEXTRA.PBL)
            CALL      NXTPAG00
            GOTO      ACCD9999
          ENDIF
.
          MATCH     "T",ACCFLAG1            * Resubmit Accident XML extract
          IF        @EQUAL
            MOVE      ACCNUMBR,PTCLM011
            CALL      ACCXML00              * (in ACCEXTRA.PBL)
.         NZ only...
            IF        PTCNHDPS=1 
              CALL      MVACCXML            * Add record to accaudaf
            ENDIF
            GOTO      ACCD9999
          ENDIF
.
ACCD9999  RETURN
.
.------------------------------------------------------------
. ADMERR00 - Output HTML Error File for Admissions Only
.------------------------------------------------------------
.
ADMERR00  CALL      OPENHTML
          BRANCH    EXIT,ADMERR95
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "    alert(#"",WEBTITLE,"#");";
.
          MOVE      REDIRECT,SVDIRECT        * Save the successful redirect
          CALL      SETDIR00                 * Set error redirect
          MOVE      REDIRECT,KEY65
          MOVE      AADMNO,ADMISSNO
          REP       " +",ADMISSNO
          PACK      REDIRECT,KEY65,ADMISSNO,SP70
.
          WRITE     HTMLFILE;" if (window.name.substr(0,4)=='Hide' ) {":
                             "    self.close() } ":
                             " else {";
.
          COMPARE   ONE,PRECOMPL
          IF        @EQUAL
            IF        NOMESSAG=1
              WRITE     HTMLFILE;"   location.href=#"",REDIRECT,"#"}";
            ELSE
              MOVE      "Patient Pre-Admitted Successfully",WEBTITLE
              WRITE     HTMLFILE;"    alert(#"",WEBTITLE,"#");":
                                 "    location.href=#"",REDIRECT,"#"}";
            ENDIF
          ELSE
            WRITE     HTMLFILE;"    history.go(-1)}";
          ENDIF
.
          WRITE     HTMLFILE;"}":
                             "</script>"
.
          MOVE      SVDIRECT,REDIRECT        * Restore the successful redirect
          CALL      CLOSHTML
          GOTO      ADMERR99
.
ADMERR95  DISPLAY   "*** Fifo Not Found - ADMERR95***"
.
ADMERR99  RETURN
+
.------------------------------------------------------------
. DEMOGR00 - Output HTML Error and redirect to the
.            demographics page patweb9801001 for Admissions Only
.------------------------------------------------------------
DEMOGR00  CALL      OPENHTML
          BRANCH    EXIT,DEMOGR95
.
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
          CLEAR     REDIRECT
          APPEND    "patweb98.pbl?reportno=01&template=001&urnumber=",REDIRECT
          APPEND    URNUMBER,REDIRECT
          APPEND    "&admissno=",REDIRECT
          APPEND    ADMISSNO,REDIRECT
          RESET     REDIRECT
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             "src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             "src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#">":
                             " alert(#"",WEBTITLE,"#");":
                             " if (window.name.substr(0,4)=='Hide' ) {":
                             "    self.close() } ":
                             " else { ":
                             "getTop().content.location.href=#"",REDIRECT,"#"}";
.
          WRITE     HTMLFILE;"</script>"
.
          CALL      CLOSHTML
          GOTO      DEMOGR99
.
DEMOGR95  DISPLAY   "*** Fifo Not Found - DEMOGR95***"
.
DEMOGR99  RETURN
+
.-----------------------------------------------------------------------------
. SETDIR00 - Set Redirect : Pre-Admission complete so direct to admission form
.-----------------------------------------------------------------------------
.
SETDIR00  REP       " +",URNUMBER
          REP       " +",ADMISSNO
          CLEAR     REDIRECT
          APPEND    "patweb89.pbl?reportno=01&template=001&urnumber=",REDIRECT
          APPEND    URNUMBER,REDIRECT
          APPEND    "&admissno=",REDIRECT
          APPEND    ADMISSNO,REDIRECT
          RESET     REDIRECT
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
SETDIR99  RETURN
+
.----------------------------------------------------------------------
. DEDDIR00 - Set Redirect : Pre-Admitting patient for organ procurement
.----------------------------------------------------------------------
DEDDIR00  REP       " +",URNUMBER
          REP       " +",ADMISSNO
          CLEAR     REDIRECT
          APPEND    "patweb89.pbl?reportno=03&template=001&urnumber=",REDIRECT
          APPEND    URNUMBER,REDIRECT
          APPEND    "&admissno=",REDIRECT
          APPEND    ADMISSNO,REDIRECT
          APPEND    "&deadflag=1",REDIRECT
          RESET     REDIRECT
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
DEDDIR99  RETURN
+
.------------------------------------------------------------------------
. ADMDED00 - Output HTML Error File for Organ Procurement Admissions Only
.------------------------------------------------------------------------
ADMDED00  CALL      OPENHTML
          BRANCH    EXIT,ADMDED95
.
          CALL      DEDDIR00                 * Set redirect
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             " if (window.name.substr(0,4)=='Hide' ) {":
                             "    self.close() } ":
                             " else {";
.
          WRITE     HTMLFILE;" if(confirm('Warning: Patient is Deceased.\n":
                             "Click OK to continue with admission ')) {":
                             " location.href=#"",REDIRECT,"#"}":
                             " else { history.go(-1)}}";
.
          WRITE     HTMLFILE;"}":
                             "</script>"
.
          CALL      CLOSHTML
          GOTO      ADMDED99
.
ADMDED95  DISPLAY   "*** Fifo Not Found ***"
.
ADMDED99  RETURN
+
.------------------------------------------------------------------------
. CHKDED00 - Invalid admitting care type for Organ Procurement Admissions
.------------------------------------------------------------------------
CHKDED00  CALL      OPENHTML
          BRANCH    EXIT,CHKDED95
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             " if (window.name.substr(0,4)=='Hide' ) {":
                             "    self.close() } ":
                             " else {";
.
          WRITE     HTMLFILE;" alert('Error: Invalid Care Type for a ":
                             " Deceased Patient.')}";
.
          WRITE     HTMLFILE;"}":
                             "</script>"
.
          CALL      CLOSHTML
          GOTO      CHKDED99
.
CHKDED95  DISPLAY   "*** Fifo Not Found ***"
.
CHKDED99  RETURN
+
.------------------------------------------------------------
. INIT0000 - Open Files and Initialize Variables
.------------------------------------------------------------
.
INIT0000  CALL      INTMAS00
          CLOSE     WEBSCHA1
          CLOSE     WEBSCHA2
          CLOSE     WEBSCHA3
          CLOSE     WEBSCHA4
          OPEN      PATASDA1,"patasdaf"
          OPEN      PATHDFA1,"pathdfaf"
          OPEN      PATHLFA1,"pathlfaf"
          OPEN      PATLDFA1,"patldfaf"
          OPEN      PATMI1A1,"patmi1af"
          OPEN      PATMI1A8,"patmi1af"
          OPEN      PATLSDA1,"patlsdaf"
          OPEN      PATVISA1,"patvisaf"
          OPEN      PMSAIDA1,"pmsaidaf"
          OPEN      PMSCMTA1,"pmscmtaf"
          OPEN      PMSCHAA1,"pmschaaf"
          OPEN      IBATMHA1,"ibatmhaf"
....      OPEN      IBAPOST1,"ibapostf"
....      OPEN      PMSPHSA1,"pmsphsaf"
          OPEN      PMSPX2A1,"pmspx2af"
          OPEN      PATLINK1,"patlinkf"
          OPEN      BOKDIAA1,"bokdiaaf"     * booking diagnosis file
          OPEN      MRTLOCA1,"mrtlocaf"
          OPEN      ALLLNKA2,"alllnkaf"
          OPEN      EMRSITA1,"emrsitaf"
          OPEN      MRTVISA1,"mrtvisaf"
          OPEN      MRTMASA1,"mrtmasaf"
          OPEN      MRTMASA2,"mrtmasaf"
.....     OPEN      MRTMOVA1,"mrtmovaf"
          OPEN      MRTHISA1,"mrthisaf"
          OPEN      EMRDOCA1,"emrdocaf"
          OPEN      EMRVISA1,"emrvisaf"
          OPEN      EMRVCDA1,"emrvcdaf"
          OPEN      EMRVISA3,"emrvisaf"
          OPEN      EMRHISA1,"emrhisaf"
          OPEN      EMRICDA1,"emricdaf"
.....     OPEN      BOKBSTA1,"bokstaaf"
          OPEN      PATDSCH1,"patdschf"
.....     OPEN      PATDSCH3,"patdschf"
          OPEN      PATCTFA1,"patctfaf"
          OPEN      NHIMASA1,"nhimasaf"
          OPEN      NHIMASA2,"nhimasaf"
          OPEN      PMSHRDA1,"pmshrdaf"
          OPEN      PMSRELA1,"pmsrelaf"
          OPEN      PMSRESA1,"pmsresaf"
.....     OPEN      PMSREGA1,"pmsregaf"
.....     OPEN      PATUNAA1,"patunaaf"
          OPEN      NZPSPRA1,"nzpspraf"
.....     OPEN      NZPPFEA1,"nzppfeaf"
.....     OPEN      NZPCMTA1,"nzpcmtaf"
.....     OPEN      NZPCMTA3,"nzpcmtaf"
.....     OPEN      NZPCFNA1,"nzpcfnaf"
.....     OPEN      MLTCFNA1,"mltcfnaf"
          OPEN      MLTHCPA1,"mlthcpaf"
.....     OPEN      ALLPCTA1,"allpctaf"
          OPEN      ALLREFA1,"allrefaf"
.....     OPEN      ALLRSAA1,"allrsaaf"
          OPEN      AAEDE1A1,"aaede1af"
          OPEN      ACCAUDA1,"accaudaf"
          OPEN      ACCDIAA1,"accdiaaf"
          OPEN      ACCRFPA1,"accrfpaf"
          OPEN      ACCCMTA1,"acccmtaf"
...       OPEN      ACCLODA1,"acclodaf"          * NZ only - see ACCEXTRA.PBL
.
.....     OPEN      OPRDETA1,"oprdetaf"
          OPEN      OPRDETA2,"oprdetaf"
          OPEN      OPRDETA3,"oprdetaf"
.....     OPEN      OPRDETA5,"oprdetaf"
.....     OPEN      OPRDETB1,"oprdetbf"
.         OPEN      OPRDETC1,"oprdetcf"
.....     OPEN      OPRSESA3,"oprsesaf"
          OPEN      OPRMBSA1,"oprmbsaf"
.....     OPEN      OPRSEMA1,"oprsemaf"
.....     OPEN      OPRTSMA1,"oprtsmaf"
          OPEN      OPRARDA1,"oprardaf"
          OPEN      OPRSRGA1,"oprsrgaf"
.
.....     OPEN      PMSMTIA1,"pmsmtiaf"
          OPEN      PATBMDA1,"patbmdaf"
          OPEN      PATBMDA2,"patbmdaf"
          OPEN      PATBMDA3,"patbmdaf"
.....     OPEN      PATBMDA4,"patbmdaf"
          OPEN      PATBRDA1,"patbrdaf"
.....     OPEN      PATBRDA2,"patbrdaf"
.....     OPEN      PATBRDA3,"patbrdaf"
.....     OPEN      PATBRDA4,"patbrdaf"
          OPEN      VISMDTA1,"vismdtaf"
          OPEN      VISMTXA1,"vismtxaf"
          OPEN      PATCSLA1,"patcslaf"
          OPEN      PATCFAA1,"patcfaaf"
.....     OPEN      COMDEPA2,"comdepaf"
          OPEN      DISMASA1,"dismasaf"
          OPEN      DISPATA1,"dispataf"
.....     OPEN      DISPATA2,"dispataf"
          OPEN      DISPTLA1,"disptlaf"
          OPEN      PATFX1A1,"patfx1af"
          OPEN      PATIN1A1,"patin1af"
          OPEN      PATRE1A1,"patre1af"
          OPEN      PATRGMA1,"patrgmaf"
          OPEN      PATPA1A1,"patpa1af"
          OPEN      PATPEIO1,"patpeiaf"
          OPEN      PATPGRA1,"patpgraf"
          OPEN      PRSPMIA1,"prspmiaf"
          OPEN      BOKUNQA1,"bokunqaf"
          OPEN      BOKRC1A1,"bokrc1af"
          OPEN      BOKRC1A6,"bokrc1af"
          OPEN      BOKRX1A1,"bokrx1af"
          OPEN      PATQMHA1,"patqmhaf"
          OPEN      PATWC1A1,"patwc1af"
          OPEN      PATWC1A2,"patwc1af"
          OPEN      PATWC1A3,"patwc1af"
.....     OPEN      PATDNRA1,"patdnraf"
          OPEN      PATHSPA1,"pathspaf"
          OPEN      PATTRAN1,"pattranf"
          OPEN      PATTRAN2,"pattranf"
          OPEN      PATDGWA1,"patdgwaf"
          OPEN      PATLOCA1,"patlocaf"
          OPEN      PATVISA2,"patvisaf"
          OPEN      PATINVR3,"patinvrf"
          OPEN      PATDADA1,"patdadaf"
          OPEN      PATASFA1,"patasfaf"
          OPEN      PATSTAD1,"patstads"
          OPEN      PATTFEE1,"pattfeef"
.....     OPEN      PATSDNA1,"patsdnaf"
          OPEN      PATIPEN1,"patipenf"
          OPEN      PATNOBE1,"patnobef"
.....     OPEN      PATNUMW1,"patnumwr"
          OPEN      PATWMAB1,"patwmabf"
          OPEN      PATWMAB2,"patwmabf"
          OPEN      PATWMAB3,"patwmabf"
          OPEN      PATWVET1,"patwvetf"
          OPEN      PATPNIA1,"patpniaf"          * Zero U/R Number
          OPEN      PATNIDA1,"patnidaf"          * all other countries
....      OPEN      PATVCHA1,"patvchaf"
          OPEN      PATVENA1,"patvenaf"
          OPEN      PATVKCA1,"patvkcaf"
          OPEN      PATURAD1,"paturadf"
....      OPEN      PATURAD2,"paturadf"
          OPEN      PMSCURA1,"pmscuraf"
          OPEN      PMSDTCA1,"pmsdtcaf"
          OPEN      PMSCEXA1,"pmscexaf"
          OPEN      PMSCTCA1,"pmsctcaf"
          OPEN      PMSOECA1,"pmsoecaf"
          OPEN      PMSOESA1,"pmsoesaf"
          OPEN      PMSTLEA1,"pmstleaf"          * open Patient Titles table
.....     OPEN      PMSTLEA2,"pmstleaf"          *
.....     OPEN      WATCATA1,"watcataf"
          OPEN      WATTR1A1,"wattr1af"
          OPEN      WATPROA1,"watproaf"
          OPEN      VISCMTA1,"viscmtaf"
          OPEN      VISINTA1,"visintaf"
          OPEN      VISIAUA1,"visiauaf"
          OPEN      VISPAYA1,"vispayaf"
          OPEN      VISPAYA2,"vispayaf"
          OPEN      PATONLV1,"patonlvf"
          OPEN      PMSBBDA1,"pmsbbdaf"
          OPEN      PMSBBDA2,"pmsbbdaf"
          OPEN      PMSBRQA1,"pmsbrqaf"
          OPEN      PMSBRQA2,"pmsbrqaf"
          OPEN      PMSEPBA1,"pmsepbaf"
          OPEN      PMSEPBA2,"pmsepbaf"
          OPEN      PMSEXTA1,"pmsextaf"
          OPEN      PMSEXTA2,"pmsextaf"
.....     OPEN      PMSNEWA1,"pmsnewaf"
          OPEN      PMSNEWA2,"pmsnewaf"
          OPEN      PMSBORA2,"pmsboraf"
          OPEN      PMSWORA1,"pmsworaf"
          OPEN      PMSVX1A1,"pmsvx1af"
          OPEN      PMSWX1A1,"pmswx1af"
          OPEN      PATELGA1,"patelgaf"
          OPEN      PATEORA1,"pateoraf"
          OPEN      PATCHCO1,"patchcof"
          OPEN      PATGSRN1,"patgsrnf"
.....     OPEN      PATGSRN2,"patgsrnf"
.....     OPEN      PATGSRN3,"patgsrnf"
.....     OPEN      PATGSRN4,"patgsrnf"
          OPEN      PATDO1A1,"patdo1af"
          OPEN      PATCODE1,"patcodes"
          OPEN      PATCODE2,"patcodes"
.....     OPEN      PATWR1A3,"patwr1af"
          OPEN      PATWR1A7,"patwr1af"
          OPEN      PMSHCPA1,"pmshcpaf"
          OPEN      PMSHCGA1,"pmshcgaf"
.....     OPEN      PATDRGA1,"patdrgaf"
          OPEN      PATDRGA2,"patdrgaf"
          OPEN      PATITEM1,"patitemn"
          OPEN      PATVADA1,"patvadaf"
          OPEN      PATDTRA1,"patdtraf"
          OPEN      PATMCHG1,"patmchgf"
.....     OPEN      RCPDTEA6,"rcpdteaf"
.....     OPEN      RCPBNKA1,"rcpbnkaf"
          OPEN      IBALPCA1,"ibalpcaf"
          OPEN      PMSIPLA1,"pmsiplaf"     * Polling table for DHS Medicare
.
          OPEN      ALLCASA1,"allcasaf"
.....     OPEN      IBAALVA1,"ibaalvaf"
.....     OPEN      PMSDAUA2,"pmsdauaf"
.
          OPEN      VISXDCA1,"visxdcaf"
.
          READ      CONTROLF,SEVENTY9;*120,PTCNUEOC
          COMPARE   ONE,PTCNUEOC                 * using EOC ?
          IF        @EQUAL
            OPEN      EOCLNKA1,"eoclnkaf"
          ENDIF
.
          MOVE      "out",CFILEPRE          * Save Current File Prefix
          CALL      OPNOUT00                * Open Outpatient Files
          OPEN      OUTRF1A1,"outrf1af"
.
          OPEN      CONTROLF,"controlf"
          READ      CONTROLF,TEN;*94,CAGECOFF
          READ      CONTROLF,HUND20;*174,PTCNBEAD
          READ      CONTROLF,HUND05;*165,PTCNONLA
          READ      CONTROLF,EIGHTY;*243,PTCNODRG
          READ      CONTROLF,HUND12;*19,PTCNACCE * ACC Elodgement Y/N
          READ      CONTROLF,EIGHTY;*241,PTCNUCGP   * Using Reg Gp changes file
          READ      CONTROLF,SEVENTY9;*248,PTCNIPEN
          READ      CONTROLF,HUND22;*12,EMCNPBSD
          READ      CONTROLF,HUND24;*157,PTCNPMHF:
                                    *158,PTCNVSHF:
                                    *213,PTCNINTR:
                                    *214,PTCNSZEC:
                                    *217,PTCNSZBR
          READ      CONTROLF,HUND25;*93,PTCNNSSI,*183,PTCNAVCD
          CALL      RDCTRL00                     * Read control file parameters
          IF        CAUDM=0
            OPEN      PATAM1A1,"patam1af"
          ENDIF
.
          IF        OPCNAUDS=0
            OPEN      OPRAUDSE,"opraudse"
          ENDIF
.
          MATCH     "1",PTCNEPAY
          IF        @EQUAL
            OPEN      PMSPAYA1,"pmspayaf"
            OPEN      PMSPAYA2,"pmspayaf"
          ENDIF
.
          IF        PTCNHDPS=3
            OPEN      WATESPA1,"watespaf"
            OPEN      WATESEA1,"wateseaf"
            OPEN      WATESNA1,"watesnaf"
            OPEN      WATESNA5,"watesnaf"
          ENDIF
.
          IF        MHCNUSE=1
            OPEN      MEHCJAA1,"mehcjaaf"
            OPEN      MEHDIAA1,"mehdiaaf"
            OPEN      MEHLEGA1,"mehlegaf"
            OPEN      MEHVI1A1,"mehvi1af"
            OPEN      MEHDS1A1,"mehds1af"
            OPEN      MEHDLSA1,"mehdlsaf"
          ENDIF
          IF        MHCNAUDA=0
            OPEN      MEHAUVI1,"mehauvi1"
          ENDIF
.
          IF        PTCNVKCA<>1
            OPEN      PATAUDVK,"pataudvk"
          ENDIF
.
          IF        OPCNAUDB<>1
            OPEN      OPRAUDDA,"opraudda"
          ENDIF
.
          MOVE      ZERO,NOLEAVRG
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSLRDA1,"pmslrdaf"
          IF        OVRCD=1
            MOVE      ONE,NOLEAVRG
          ENDIF
.
          READ      CONTROLF,SEVENTY1;*200,CCCNSVHM
          READ      CONTROLF,THIRTY1;*163,OTCNFTYP
          READ      CONTROLF,SEVENTY9;*120,PTCNUEOC
          READ      CONTROLF,NINTY7;*152,MRCNACRR,*169,MRCNEMRT,*166,MRCNRRED:
                                    *176,MRCNTREC,*246,MRCNROUN
          READ      CONTROLF,TWENTY1;*237,PTCNPAOF
.
          READ      CONTROLF,HUND03;*220,PTCNDEES,*221,PTCNDDES
          READ      CONTROLF,HUND03;*245,PTCNWAUC
          READ      CONTROLF,HUND05;*216,PTCNDWAW,*235,PTCNQCCT
          READ      CONTROLF,HUND09;*244,PTCNCELG
          READ      CONTROLF,HUND12;*96,PTCNH7AC,*106,PTCNBEDM,*107,PTCNBMAN
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,SIXTY8;*244,OPCNCPOD
          READ      CONTROLF,HUND14;*139,PTCNCHOD
          READ      CONTROLF,HUND16;*215,PTCNAADR,*222,PTCNXCOM:
                                    *247,PTCNUNDH
          READ      CONTROLF,HUND18;*138,PTCNNEWC,*153,PTCNUDPD,*167,PTCNNWCA:
                                    *179,PTCNH7ID
          READ      CONTROLF,SIXTY;*84,MRCNHLOC
          READ      CONTROLF,SIXTY;*88,MRCNRCTY
          READ      CONTROLF,SIXTY;*91,MRCNVOLM
          READ      CONTROLF,SIXTY;*108,MRCNSTAT
          READ      CONTROLF,NINTY7;*154,MRCNUSRD
          READ      CONTROLF,HUND19;*182,PTCNEPIS
          READ      CONTROLF,HUND20;*132,PTCNUNDW,*137,PTCNHEFR:
                                    *142,PTCNHETO,*147,PTCNOVRW,*152,PTCNOBES
          READ      CONTROLF,HUND20;*158,PTCNUNET,*243,PTCNSMSN
          READ      CONTROLF,HUND21;*101,ALCNDAMR
          READ      CONTROLF,HUND23;*209,PTCNUTOM,*210,PTCNUESD
          READ      CONTROLF,HUND24;*148,PTCNDWDC,*214,PTCNSZEC
          READ      CONTROLF,HUND25;*224,PTCNACTR
          READ      CONTROLF,HUND28;*226,PTCNNMPR
          READ      CONTROLF,HUND30;*69,PTCNEIVS
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
          ENDIF
.
          MATCH     "1",PTCNNWCA
          IF        @EQUAL
            OPEN      PMSAUDCE,"pmsaudce"
            OPEN      PMSAUDC2,"pmsaudce"
          ENDIF
.
          MOVE      ZERO,NOPROGRM
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSHPGA1,"pmshpgaf"
          TRAPCLR   IO
          IF        OVRCD<>1
            OPEN      PMSHPOA1,"pmshpoaf"
            OPEN      PMSUPGA1,"pmsupgaf"
            OPEN      PMSUPOA1,"pmsupoaf"
          ELSE
            MOVE      ONE,NOPROGRM
          ENDIF
.
          MOVE      ZERO,NOATTRIB
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PATATRA1,"patatraf"
          TRAPCLR   IO
          IF        OVRCD=1
            MOVE      ONE,NOATTRIB
          ENDIF
.
          CALL      OPICO1
.
          CALL      TFILENAM
          MOVE      TFILNAME,COMFILNM
          CALL      TFILENAM
          MOVE      TFILNAME,COMVISNM
          CALL      TFILENAM
          MOVE      TFILNAME,COMCIJNM
          CALL      TFILENAM
          MOVE      TFILNAME,COMAIJNM
          CALL      TFILENAM
          MOVE      TFILNAME,COMAWKNM
          CALL      TFILENAM
          MOVE      TFILNAME,COMSGTNM
          CALL      TFILENAM
          MOVE      TFILNAME,CFNAMEDP
.
          OPEN      PMSVSTA1,"pmsvstaf"
          OPEN      PMSVSCA1,"pmsvscaf"
          OPEN      PMSVMTA1,"pmsvmtaf"
          OPEN      PMSUKIA1,"pmsukiaf"
          OPEN      PMSUKIA2,"pmsukiaf"
.
          READ      CONTROLF,TEN;*32,PTCNUBRD,*126,CLABPG,*201,CAUDA,CAUDB
          BRANCH    CAUDB,INIT9999
          OPEN      PATBAUD,"patbaud"
.
INIT9999  RETURN
.
.*******************************************************************************
. OUTFIL00 - Check if the user id has an outpatienty site. If they do open
.            the correct outpatient files according to the site. If they do not
.            have a site make sure the default prefix of out is is used to
.            open the files.
.*******************************************************************************
OUTFIL00  MATCH     SP70,WBSESIT             * Does the user have a site
          GOTO      OUTFIL50 IF NOT EQUAL
.
OUTFIL10  MATCH     "out",CFILEPRE           * Is out currently open
          IF        !@EQUAL
            MOVE      "out",OSTFILE          * open default prefix of out
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open out Outpatient Files
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      OUTFIL99
.
OUTFIL50  MOVE      WBSESIT,KEY6
          CALL      RDSITA1
          BRANCH    OVRCD,OUTFIL90           * error invalid site code
.
          MATCH     OSTFILE,CFILEPRE         * Save Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open prefixed Outpatient Files
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      OUTFIL99
.
OUTFIL90  MOVE      "Outpatient Site Invalid",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
OUTFIL99  RETURN
.
+
.------------------------------------------------------------------------------
.  Redirect URL
.------------------------------------------------------------------------------
PDIREC00  CALL      OPENHTML
          BRANCH    EXIT,PDIREC90
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             "src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             "src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#"> ":
                             " if (self.name.match(/PopUpFrame/)) {":
                          "  redirectParentFrame(#"",REDIRECT,REDIREC1,"#");}":
                             " else {":
                             "  location.href=#"",REDIRECT,REDIREC1,"#"}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      PDIREC99
.
PDIREC90  DISPLAY   "*** Fifo Not Found ***"
.
PDIREC99  RETURN
+
.------------------------------------------------------------------------------
. PREDIR00 - Redirect Parent URL
.------------------------------------------------------------------------------
.
PREDIR00  CALL      OPENHTML
          BRANCH    EXIT,PREDIR90
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
.                             " alert(#"",WEBTITLE,"#");":
                             " parent.location.href=#"",REDIRECT,"#";":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      PREDIR99
.
PREDIR90  DISPLAY   "*** Fifo Not Found ***"
.
PREDIR99  RETURN
+
.------------------------------------------------------------------------------
. PPARDR00 - Redirect Parent Parent URL
.------------------------------------------------------------------------------
.
PPARDR00  CALL      OPENHTML
          BRANCH    EXIT,PREDIR90
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
.                             " alert(#"",WEBTITLE,"#");":
                             " parent.parent.location.href=#"",REDIRECT,"#";":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      PREDIR99
.
PPARDR90  DISPLAY   "*** Fifo Not Found ***"
.
PPARDR99  RETURN
.------------------------------------------------------------
. RDCTRL00 - Read control file parameters
.------------------------------------------------------------
.
RDCTRL00  READ      CONTROLF,TEN;*25,PTCNVKCA,*42,PTCNDGAT,*53,CPCONT:
                                *126,CLABPG:
                                *127,CLABPRT,*164,CSPECCO,*165,CIDENT:
                                *166,CMEMB,*167,CSECURA,*188,CCHKRAT:
                                *194,CDIETCD,*196,CGENRUR,*197,CASSOCD:
                                *198,CDIETDF,*201,CAUDA,*211,CAUDK:
                                *213,CAUDM,*217,CAUDQ,*244,CHOSPNUM
.
          READ      CONTROLF,TEN3;*143,CSIZLAB,*186,CMBSOPR,*188,CMABINS:
                                  *194,CVETINS,*216,CUSR1,*217,CUSRDS1:
                                  *229,CUSR2,*230,CUSRDS2,*242,CCLMCHN:
                                  *243,CACCLSS,*244,CHCS,*245,CHOSTYP
.
          READ      CONTROLF,TEN4;*227,CIDLAY,*229,CUSMAN1,*230,CUSMAN2:
                                  *231,CATDMAN,*248,CURDEL
.
          READ      CONTROLF,TEN5;*187,CBOOK,*189,CTHETR,*190,CKMBS,*191,CMUSR1:
                                  *192,CMUSDS1,*204,CMUSR2,*205,CMUSDS2:
                                  *217,CMUSR3,*218,CMUSDS3,*230,CMUSMAN1:
                                  *231,CMUSMAN2,*232,CMUSMAN3,*233,CUSR3:
                                  *234,CUSRDS3,*246,CUSMAN3,*249,CRDRTYP
.
          READ      CONTROLF,TEN8;*17,CUSR4,*18,CUSRDS4,*30,CUSMAN4:
                                  *31,CUSR5,*32,CUSRDS5,*44,CUSMAN5:
                                  *45,CUSR6,*46,CUSRDS6,*58,CUSMAN6:
                                  *59,CUSR7,*60,CUSRDS7,*72,CUSMAN7:
                                  *143,CLOWMBS,*148,CLOWADM,*151,CHIGHMBS:
                                  *156,CHIGHADM,*159,CTOPADM,*206,CFINAN:
                                  *225,CCHGST1,*228,CCHGST2,*246,CMAXAGE
.
          READ      CONTROLF,TEN9;*75,CCNOTES,*208,CPMIAD,*209,CSRESP:
                                  *212,CFEETYP,*214,CWRDSCN,*225,CSALIAS
.
          READ      CONTROLF,TWENTY;*50,PTCNADBF,*52,PTPCLRES,*165,PTCNDFBO:
                                    *193,PTCNDCLM
.
          READ      CONTROLF,TWENTY1;*45,PTCNDRSM,*46,PTCNBAGE,*205,PTCNUKEY:
                                     *221,CNSWLOC,*238,PTCNAGEC,*248,PTCNSOUC
.
          READ      CONTROLF,TWENTY2;*30,STCNIPPM,*31,STCNIPAD,*45,STCNFUND
.
          READ      CONTROLF,TWENTY7;*46,HBWAIT
.
          READ      CONTROLF,THIRTY;*90,HELPRNT
.
          READ      CONTROLF,THIRTY7;*137,HWDSOUR,*241,WTCNUSBC
.
          READ      CONTROLF,FORTY;*44,OPCNAUDB,*61,OPCNAUDS,*112,OPCNCODE
.
          READ      CONTROLF,FORTY2;*19,OPCNFOTM,*20,OPCNTOTM,*101,OPCNSGCL
.
          READ      CONTROLF,FIFTY9;*2,C3BDAYS:
                                    *6,CLUNTNO,*35,CTYPLAB,*141,CPIDCOD:
                                    *171,PTCNSTAU,*172,PTCNNUMM,*174,PTCNNDAT:
                                    *182,PTCNORNO,*192,PTCNURCF,*193,PTCNRQCF:
                                    *194,PTCNDPCF,*195,PTCNRLAY,*196,PTCNUCOD:
                                    *202,PTCNMRPN,*209,PTCNDAYF,*216,PTPRVALS:
                                    *220,PTCNUADT,*226,CCARECL:
                                    *233,PTCNADOC
.
          READ      CONTROLF,SIXTY9;*43,MHCNAUDA,*69,MHCNUSE,*80,MHCNUDSA
.
          READ      CONTROLF,SEVENTY7;*201,PTCNIDHD
.
          READ      CONTROLF,SEVENTY9;*82,PTCNDSCI,*94,PTCNADTT:
                                      *95,PTCNDSTT,*138,PTCNURHA
.
          READ      CONTROLF,EIGHTY;*250,PTCNHDPS
.
          READ      CONTROLF,EIGHTY8;*234,PTCNNCFB,*235,PTCNADCF,*237,PTCNEMPL:
                                     *246,PTCNH7VP
.
          READ      CONTROLF,FIFTY9;*234,CPNMPICK
          READ      CONTROLF,TWENTY1;*55,SRCHDOBS,*138,PTCNNHII
          READ      CONTROLF,FIFTY9;*234,PTCNNMPI
          READ      CONTROLF,NINTY8;*124,PTCNHPCD,*129,PTCNDGST
          READ      CONTROLF,HUND05;*98,PTCNCMYN,PTCNNWCM,*166,PTCNCMXF:
                                    *210,PTCNLCLM
          READ      CONTROLF,HUND10;*115,PTCNUEDI,*243,PTCNCOMF,*248,PTCNEPAY
          READ      CONTROLF,HUND28;*105,PTCNUABF
          READ      CONTROLF,HUND29;*61,PTCNWSIN,*71,PTCNOECW,*72,PTCNOECE
          READ      CONTROLF,HUND30;*70,PTCNTRSC
.
RDCTRL99  RETURN
+
.------------------------------------------------------------
. CLRPAR00 - Clear Parameters
.------------------------------------------------------------
.
CLRPAR00  READ      CONTROLF,TEN;*196,CGENRUR
          MOVE      ZERO,CURRFLAG
          MOVE      SP70,CORSP001
          MOVE      SP70,CORSP003
          MOVE      SP70,CURRHOSP
          MOVE      SP70,CURRADMN
          MOVE      ZERO,BKFLAG
          MOVE      ONE,DOYR2014
          MOVE      ZERO,PREAFLAG
          MOVE      ZERO,VSCMTFLG
          MOVE      ZERO,VSCMTLIN
          MOVE      ZERO,URCMTFLG
          MOVE      ZERO,URCMTLIN
          MOVE      ZERO,MHADMFLG
          MOVE      ZERO,NEWLEGFL
          MOVE      ZERO,NEWBORNF
          MOVE      ZERO,BOARDERF
          MOVE      ZERO,STATFLAG
          MOVE      SP70,MOTHADMN
          MOVE      ZERO,PRAUPDFL
          MOVE      ZERO,DISERROR
          MOVE      ZERO,CONTMULT
          MOVE      ZERO,NOOFDAYS
          MOVE      SP70,BEDTRKEY
          MOVE      Z70,BATCHNUM
          MOVE      SP70,BEDRQQRY
          MOVE      ZERO,COPYFLAG
          MOVE      ZERO,COPYPDEF
          MOVE      ZERO,RECURRFL
          MOVE      ZERO,DISCFLAG
          MOVE      SP70,EMADMISS
          MOVE      SP70,SESSKEYS
          MOVE      SP70,THEAFLAG
          MOVE      SP70,THEATREF
          MOVE      SP70,THEATREK
          MOVE      SP70,OTPTFLAG
          MOVE      SP70,KIDSFLAG
          MOVE      SP70,SUPRFUNC
          MOVE      SP70,REASCHNG
          MOVE      SP70,CASEKEYS
          MOVE      ZERO,UPDATETY
          MOVE      SP70,UPDTTYPE
          MOVE      ZERO,UPDATET2
          MOVE      SP70,URNUMBER
          MOVE      SP70,MVMEDREC
          MOVE      SP70,RETDFRAE
          MOVE      SP70,FORMACTN
          MOVE      SP70,SAVEURNO
          MOVE      SP70,ADMISSNO
          MOVE      SP70,NOBKDES2
          MOVE      ZERO,PREVADDR
          MOVE      SP70,PREVEMRA
          MOVE      ZERO,TEMPORAR
          MOVE      ZERO,ADMISFLG
          MOVE      ZERO,MANALLOC
          MOVE      ZERO,STATADMN
          MOVE      ZERO,STATDSCH
          MOVE      SP70,TESTTRNS
          MOVE      SP70,LASTTRNS
          MOVE      SP70,TESTKEY
          MOVE      ZERO,STBYPAT
          MOVE      ZERO,CHGUR
          MOVE      ZERO,CHGCGP
          MOVE      SP70,CPYADMNO
          MOVE      SP70,CPYPAMIS
          MOVE      ZERO,CRMEDREC           * I CAR 38490
          MOVE      ONE,ADMITNOW            * 1 - Do not admit patient
          MOVE      ZERO,ADMITBOX           * 0 - Do not admit patient
          MOVE      ZERO,PREADBOK           * 0 - Do not admit from booking
          MOVE      ZERO,PREADMEH           * 0 - Do not admit from MEH visit
          MOVE      ZERO,PRECOMPL           * 0 - Pre-Admission not complete
          MOVE      ZERO,DEADFLAG
          MOVE      ZERO,DEFSTATD                          *T0874934
          MOVE      Z70,EMEXP001
          MOVE      ZERO,WARCOUNT
          MOVE      ZERO,MRGEFLAG
          MOVE      ZERO,ALTIDFLG
          MOVE      Z70,ALTIDTYP
          MOVE      ZERO,ALTERNAT
          MOVE      Z70,ALTERNID
          MOVE      SP70,SRCHSNAM
          MOVE      SP70,SRCHGNAM
          MOVE      SP70,SRCHMNAM
          MOVE      SP70,SRCHPSEX
          MOVE      SP70,SRCHPAGE
          MOVE      SP70,SRCHPDOB
          MOVE      SP70,SRCHMEDI
          MOVE      SP70,DELALDOB
          MOVE      SP70,ADDORDEL
          MOVE      ZERO,NEXTPAGE
          MOVE      SP70,TRNSFSRC
          MOVE      ZERO,SAVEALIA
          MOVE      ZERO,SAVEALPR
          MOVE      ZERO,LASTITM1
          MOVE      ZERO,LASTITM3
          MOVE      ZERO,LASTITM4
          MOVE      ZERO,LASTITM5
          MOVE      ZERO,LASTITM6
          MOVE      ZERO,STATDISC
          MOVE      ZERO,ADDWLFLG
          MOVE      SP70,EMRVISIT
          MOVE      SP70,EXTCOMIN
          MOVE      SP70,UPDTADMN
          MOVE      ZERO,REGIFLAG
          MOVE      ZERO,ALEMRFLG
          MOVE      SP70,REFRLVIS
          MOVE      ZERO,BOOKFLAG
          MOVE      ZERO,SYSTFLAG
          MOVE      ZERO,RESIDADM
          MOVE      SP70,REFVISNO
          MOVE      SP70,REFRDATE
          MOVE      SP70,PREVDETA
          MOVE      Z70,PRVADMIS
          MOVE      ZERO,ADDNEWPG
          MOVE      ZERO,UPDRGDAT
          MOVE      ZERO,NOMESSAG
          MOVE      SP70,CONFDEMO
          MOVE      SP70,UPDTMHHL
          MOVE      Z70,QUICKREG
          MOVE      ZERO,CHDISDTE
          MOVE      ZERO,CHDISDT2
          MOVE      SP70,ADMISNID
          MOVE      SP70,EREFRLID
          MOVE      SP70,ADMREQNO
          MOVE      ZERO,VINAHUPD
          MOVE      SP70,HEAVIEW1                           *T0852969
.
          MOVE      Z70,RETURNCD
          MOVE      ZERO,REMOTENO
.
          MOVE      SP70,ACCAUFLG
          MOVE      SP70,AUDITYPE
          MOVE      SP70,ACCDFLAG
          MOVE      SP70,ACCFLAG1
          MOVE      SP70,CHECKACC
.
          MOVE      SP70,CPADM001
          MOVE      SP70,CPADM002
          MOVE      SP70,CPADM003
          MOVE      SP70,CPADM004
          MOVE      SP70,CPADM006
          MOVE      SP70,CPADM007
          MOVE      SP70,CPADM008
          MOVE      SP70,CPADM009
.
          MOVE      SP70,DSCHSTAT
          MOVE      SP70,DSCHDEST
          MOVE      SP70,DSCHDIA1
          MOVE      SP70,DSCHDIA2
          MOVE      SP70,DSCHUSR1
          MOVE      SP70,DSCHUSR2
          MOVE      SP70,DSCHUSR3
          MOVE      SP70,DSCHUSR4
          MOVE      SP70,DSCHUSR5
          MOVE      SP70,DSCHMBSC
          MOVE      SP70,DSCHIRAD
          MOVE      SP70,DSCHSREF
          MOVE      SP70,DSCHCOM1
          MOVE      SP70,DSCHCOM2
          MOVE      SP70,DSCHDETY
          MOVE      SP70,DSCHCRAV
          MOVE      SP70,DSCHRCCT
          MOVE      SP70,DSCHMHLS
          MOVE      Z70,DSCHPALC
          MOVE      SP70,DSCHPYSP
          MOVE      SP70,DSCHFINP
          MOVE      SP70,DSCHCLGP
          MOVE      Z70,DSCHRTOS
.
          MOVE      Z70,PTMAS001
          MOVE      ZERO,PTMAS002
          MOVE      ZERO,PTMAS003
          MOVE      Z70,PTMAS004
          MOVE      Z70,PTMAS005
          MOVE      Z70,PTMAS006
          MOVE      Z70,PTMAS007
          MOVE      Z70,PTMAS008
          MOVE      Z70,PTMAS009
          MOVE      Z70,PTMAS010
          MOVE      Z70,PTMAS011
          MOVE      Z70,PTMAS012
          MOVE      Z70,PTMAS013
          MOVE      Z70,PTMAS014
          MOVE      Z70,PTMAS015
          MOVE      Z70,PTMAS016
          MOVE      Z70,PTMAS017
          MOVE      ZERO,PTMAS018
          MOVE      Z70,PTMAS019
          MOVE      Z70,PTMAS020
          MOVE      Z70,PTMAS021
          MOVE      Z70,PTMAS022
          MOVE      Z70,PTMAS023
          MOVE      Z70,PTMAS024
          MOVE      Z70,PTMAS025
          MOVE      Z70,PTMAS026
          MOVE      ZERO,PTMAS027
          MOVE      Z70,PTMAS028
          MOVE      Z70,PTMAS029
          MOVE      ZERO,PTMAS030
          MOVE      ZERO,PTMAS031
          MOVE      Z70,PTMAS032
          MOVE      Z70,PTMAS033
          MOVE      Z70,PTMAS034
          MOVE      Z70,PTMAS035
          MOVE      Z70,PTMAS036
          MOVE      Z70,PTMAS037
          MOVE      Z70,PTMAS038
          MOVE      Z70,PTMAS039
          MOVE      Z70,PTMAS040
          MOVE      Z70,PTMAS041
          MOVE      Z70,PTMAS042
          MOVE      Z70,PTMAS043
          MOVE      Z70,PTMAS044
          MOVE      Z70,PTMAS045
          MOVE      Z70,PTMAS046
          MOVE      Z70,PTMAS047
          MOVE      Z70,PTMAS048
          MOVE      Z70,PTMAS049
          MOVE      Z70,PTMAS050
          MOVE      Z70,PTMAS051
          MOVE      Z70,PTMAS052
          MOVE      Z70,PTMAS053
          MOVE      Z70,PTMAS054
          MOVE      Z70,PTMAS055
          MOVE      Z70,PTMAS056
          MOVE      Z70,PTMAS057
          MOVE      ZERO,PTMAS058
          MOVE      Z70,PTMAS059
          MOVE      Z70,PTMAS060
          MOVE      Z70,PTMAS061
          MOVE      Z70,PTMAS062
          MOVE      Z70,PTMAS063
          MOVE      Z70,PTMAS064
          MOVE      Z70,PTMAS065
          MOVE      Z70,PTMAS066
          MOVE      Z70,PTMAS067
          MOVE      Z70,PTMAS068
          MOVE      Z70,PTMAS069
          MOVE      Z70,PTMAS070
          MOVE      Z70,PTMAS071
          MOVE      Z70,PTMAS072
          MOVE      Z70,PTMAS073
          MOVE      Z70,PTMAS074
          MOVE      Z70,PTMAS075
          MOVE      Z70,PTMAS076
          MOVE      Z70,PTMAS077
          MOVE      Z70,PTMAS078
          MOVE      Z70,PTMAS079
          MOVE      Z70,PTMAS080
          MOVE      Z70,PTMAS081
          MOVE      Z70,PTMAS082
          MOVE      Z70,PTMAS083
          MOVE      Z70,PTMAS084
          MOVE      Z70,PTMAS085
          MOVE      Z70,PTMAS086
          MOVE      Z70,PTMAS087
.
          MOVE      Z70,PTMSX001
          MOVE      Z70,PTMSX002
          MOVE      Z70,PTMSX003
          MOVE      Z70,PTMSX004
          MOVE      Z70,PTMSX005
          MOVE      Z70,PTMSX006
          MOVE      Z70,PTMSX007
          MOVE      Z70,PTMSX008
          MOVE      Z70,PTMSX009
          MOVE      Z70,PTMSX010
          MOVE      Z70,PTMSX011
          MOVE      Z70,PTMSX012
          MOVE      Z70,PTMSX013
          MOVE      Z70,PTMSX014
          MOVE      Z70,PTMSX015
          MOVE      Z70,PTMSX016
          MOVE      Z70,PTMSX017
          MOVE      Z70,PTMSX018
          MOVE      Z70,PTMSX019
          MOVE      Z70,PTMSX020
          MOVE      Z70,PTMSX021
          MOVE      Z70,PTMSX022
          MOVE      Z70,PTMSX023
          MOVE      Z70,PTMSX024
          MOVE      Z70,PTMSX025
          MOVE      Z70,PTMSX026
          MOVE      Z70,PTMSX027
          MOVE      Z70,PTMSX028
          MOVE      Z70,PTMSX029
          MOVE      Z70,PTMSX030
          MOVE      Z70,PTMSX031
          MOVE      Z70,PTMSX032
          MOVE      Z70,PTMSX033
          MOVE      Z70,PTMSX034
          MOVE      Z70,PTMSX035
          MOVE      Z70,PTMSX036
          MOVE      Z70,PTMSX037
          MOVE      Z70,PTMSX038
          MOVE      Z70,PTMSX039
          MOVE      Z70,PTMSX040
          MOVE      Z70,PTMSX041
          MOVE      Z70,PTMSX042
          MOVE      Z70,PTMSX043
          MOVE      Z70,PTMSX044
          MOVE      Z70,PTMSX045
          MOVE      Z70,PTMSX046
          MOVE      Z70,PTMSX047
          MOVE      Z70,PTMSX048
          MOVE      Z70,PTMSX049
          MOVE      Z70,PTMSX050
          MOVE      Z70,PTMSX051
          MOVE      Z70,PTMSX052
.
          CALL      CLPTPRA0                * clear Person Responsible for Acct
.
          MOVE      Z70,PTMIS001
          MOVE      Z70,PTMIS002
          MOVE      Z70,PTMIS003
          MOVE      Z70,PTMIS004
          MOVE      Z70,PTMIS005
          MOVE      Z70,PTMIS006
          MOVE      Z70,PTMIS007
          MOVE      Z70,PTMIS008
          MOVE      Z70,PTMIS009
          MOVE      Z70,PTMIS010
          MOVE      Z70,PTMIS011
          MOVE      Z70,PTMIS012
          MOVE      Z70,PTMIS013
          MOVE      Z70,PTMIS014
          MOVE      Z70,PTMIS015
          MOVE      Z70,PTMIS016
          MOVE      ZERO,PTMIS017
          MOVE      ZERO,PTMIS018
          MOVE      ZERO,PTMIS019
          MOVE      Z70,PTMIS020
          MOVE      Z70,PTMIS021
          MOVE      ZERO,PTMIS022
          MOVE      Z70,PTMIS023
          MOVE      Z70,PTMIS024
          MOVE      Z70,PTMIS025
          MOVE      Z70,PTMIS026
          MOVE      Z70,PTMIS027
          MOVE      Z70,PTMIS028
          MOVE      Z70,PTMIS029
          MOVE      Z70,PTMIS030
          MOVE      Z70,PTMIS031
          MOVE      ZERO,PTMIS032
          MOVE      ZERO,PTMIS033
          MOVE      Z70,PTMIS034
          MOVE      Z70,PTMIS035
          MOVE      Z70,PTMIS036
          MOVE      Z70,PTMIS037
          MOVE      Z70,PTMIS038
          MOVE      Z70,PTMIS039
          MOVE      Z70,PTMIS040
          MOVE      Z70,PTMIS041
          MOVE      Z70,PTMIS042
          MOVE      Z70,PTMIS043
          MOVE      Z70,PTMIS044
          MOVE      Z70,PTMIS045
          MOVE      Z70,PTMIS046
          MOVE      Z70,PTMIS047
          MOVE      Z70,PTMIS048
          MOVE      Z70,PTMIS049
          MOVE      Z70,PTMIS050
          MOVE      Z70,PTMIS051
          MOVE      Z70,PTMIS052
          MOVE      Z70,PTMIS053
          MOVE      Z70,PTMIS054
          MOVE      Z70,PTMIS055
          MOVE      Z70,PTMIS056
          MOVE      Z70,PTMIS057
          MOVE      Z70,PTMIS058
          MOVE      Z70,PTMIS059
          MOVE      Z70,PTMIS060
          MOVE      Z70,PTMIS061
          MOVE      Z70,PTMIS062
          MOVE      Z70,PTMIS063
          MOVE      Z70,PTMIS064
          MOVE      Z70,PTMIS065
          MOVE      Z70,PTMIS066
          MOVE      Z70,PTMIS067
          MOVE      Z70,PTMIS068
          MOVE      Z70,PTMIS069
          MOVE      Z70,PTMIS070
          MOVE      Z70,PTMIS071
          MOVE      Z70,PTMIS072
.         MOVE      Z70,PTMIS073
     PACK   PTMIS073,Z70
.
          MOVE      Z70,PTMIS074
          MOVE      Z70,PTMIS075
          MOVE      Z70,PTMIS076
          MOVE      Z70,PTMIS077
          MOVE      Z70,PTMIS078
          MOVE      Z70,PTMIS079
          MOVE      Z70,PTMIS080
          MOVE      Z70,PTMIS081
          MOVE      Z70,PTMIS082
          MOVE      Z70,PTMIS083
          MOVE      Z70,PTASF001
          MOVE      Z70,PTASF002
          MOVE      Z70,PTASF003
          MOVE      Z70,MRMAS001
          MOVE      Z70,MRMAS002
          MOVE      Z70,MRMAS003
          MOVE      Z70,WATHI002
          MOVE      SP70,WATTRKEY
          MOVE      ZERO,WAITFLAG
.
          MOVE      Z70,PTCLM033
          MOVE      Z70,PTCLM034
          MOVE      Z70,PTCLM035
          MOVE      Z70,PTCLM036
.
          MOVE      Z70,PTVIS015
          MOVE      Z70,PTVIS016
          MOVE      Z70,PTVIS017
          MOVE      Z70,PTVIS018
          MOVE      Z70,PTVIS019
          MOVE      Z70,PTVIS020
          MOVE      Z70,PTVIS021
          MOVE      Z70,PTVIS022
          MOVE      Z70,PTVIS023
          MOVE      Z70,PTVIS024
          MOVE      Z70,PTVIS025
          MOVE      Z70,PTVIS026
          MOVE      Z70,PTVIS027
          MOVE      Z70,PTVIS028
          MOVE      Z70,PTVIS029
          MOVE      Z70,PTVIS030
          MOVE      Z70,PTVIS031
          MOVE      Z70,PTVIS032
          MOVE      Z70,PTVIS033
          MOVE      Z70,PTVIS034
          MOVE      Z70,PTVIS035
          MOVE      Z70,PTVIS036
          MOVE      Z70,PTVIS037
          MOVE      Z70,PTVIS038
          MOVE      Z70,PTVIS039
          MOVE      Z70,PTVIS040
          MOVE      Z70,PTVIS041
          MOVE      Z70,PTVIS042
          MOVE      Z70,PTVIS043
          MOVE      Z70,PTVIS044
          MOVE      Z70,PTVIS045
          MOVE      Z70,PTVIS046
          MOVE      Z70,PTVIS047
          MOVE      Z70,PTVIS048
          MOVE      Z70,PTVIS049
          MOVE      Z70,PTVIS050
          MOVE      Z70,PTVIS051
          MOVE      Z70,PTVIS052
          MOVE      Z70,PTVIS053
          MOVE      Z70,PTVIS054
          MOVE      Z70,PTVIS055
          MOVE      Z70,PTVIS056
          MOVE      Z70,PTVIS057
          MOVE      Z70,PTVIS058
          MOVE      Z70,PTVIS059
          MOVE      Z70,PTVIS060
          MOVE      Z70,PTVIS061
          MOVE      Z70,PTVIS062
          MOVE      Z70,PTVIS063
          MOVE      Z70,PTVIS064
          MOVE      Z70,PTVIS065
          MOVE      Z70,PTVIS066
          MOVE      Z70,PTVIS067
          MOVE      Z70,PTVIS068
          MOVE      Z70,PTVIS069
          MOVE      Z70,PTVIS070
          MOVE      Z70,PTVIS071
          MOVE      Z70,PTVIS072
          MOVE      Z70,PTVIS073
          MOVE      Z70,PTVIS074
          MOVE      Z70,PTVIS075
          MOVE      Z70,PTVIS076
          MOVE      Z70,PTVIS077
          MOVE      Z70,PTVIS078
          MOVE      Z70,PTVIS079
          MOVE      Z70,PTVIS080
          MOVE      Z70,PTVIS081
          MOVE      Z70,PTVIS082
          MOVE      Z70,PTVIS083
          MOVE      Z70,PTVIS084
          MOVE      Z70,PTVIS085
          MOVE      Z70,PTVIS086
          MOVE      Z70,PTVIS087
          MOVE      Z70,PTVIS088
          MOVE      Z70,PTVIS089
          MOVE      Z70,PTVIS090
          MOVE      Z70,PTVIS091
          MOVE      Z70,PTVIS092
          MOVE      Z70,PTVIS093
          MOVE      Z70,PTVIS094                                       *I-53371
          MOVE      Z70,PTVIS095                                       *I-53371
          MOVE      Z70,PTVIS096
          MOVE      Z70,PTVIS097
          MOVE      Z70,PTVIS098
          MOVE      Z70,PTVIS099
          MOVE      Z70,PTVIS100
          MOVE      Z70,PTVIS101
          MOVE      Z70,PTVIS102
          MOVE      Z70,PTVIS103
          MOVE      Z70,PTVIS104
          MOVE      Z70,PTVIS105
          MOVE      Z70,PTVIS106
          MOVE      Z70,PTVIS107
          MOVE      Z70,PTVIS108
          MOVE      Z70,PTVIS109
          MOVE      Z70,PTVIS110
          MOVE      Z70,PTVIS111
          MOVE      Z70,PTVIS112
          MOVE      Z70,PTVIS113
          MOVE      Z70,PTVIS114
          MOVE      Z70,PTVIS115
          MOVE      Z70,PTVIS116
          MOVE      Z70,PTVIS117
          MOVE      Z70,PTVIS118
          MOVE      Z70,PTVIS119
          MOVE      Z70,PTVIS120
          MOVE      Z70,PTVIS121
          MOVE      Z70,PTVIS122
          MOVE      Z70,PTVIS123
          MOVE      Z70,PTVIS124
          MOVE      Z70,PTVIS125
          MOVE      Z70,PTVIS126
          MOVE      Z70,PTVIS127
          MOVE      Z70,PTVIS128
          MOVE      Z70,PTVIS129
          MOVE      Z70,PTVIS130
          MOVE      Z70,PTVIS131
          MOVE      Z70,PTVIS132
          MOVE      Z70,PTVIS133
          MOVE      Z70,PTVIS134
          MOVE      Z70,PTVIS135
          MOVE      Z70,PTVIS136
          MOVE      Z70,PTVIS137
          MOVE      Z70,PTVIS138
.
          MOVE      Z70,PTELG014
          MOVE      Z70,PTELG033
          MOVE      Z70,ETHNCTY1
          MOVE      Z70,ETHNCTY2
          MOVE      Z70,ETHNCTY3
          MOVE      Z70,MEDRTYPE
          MOVE      ZERO,OTHRCONT
          MOVE      ZERO,SCHDPCNT
.
          MOVE      ZERO,SAVEBOOK
          MOVE      SP70,SAVEBOKC
          MOVE      SP70,SAVEBCAN
.
          MOVE      SP70,PTCLM001
          MOVE      SP70,PTCLM002
          MOVE      SP70,PTCLM003
          MOVE      SP70,PTCLM004
          MOVE      SP70,PTCLM005
          MOVE      SP70,PTCLM006
          MOVE      SP70,PTCLM007
          MOVE      SP70,PTCLM008
          MOVE      SP70,PTCLM010
          MOVE      SP70,PTCLM011
          MOVE      SP70,PTCLM012
          MOVE      SP70,PTCLM013
          MOVE      SP70,PTCLM014
          MOVE      SP70,PTCLM015
          MOVE      SP70,PTCLM016
          MOVE      SP70,PTCLM017
          MOVE      SP70,PTCLM018
          MOVE      SP70,PTCLM019
          MOVE      SP70,PTCLM020
          MOVE      SP70,PTCLM021
          MOVE      SP70,PTCLM022
          MOVE      SP70,PTCLM023
          MOVE      SP70,PTCLM024
          MOVE      SP70,PTCLM025
          MOVE      SP70,PTCLM026
          MOVE      SP70,PTCLM027
          MOVE      SP70,PTCLM028
          MOVE      SP70,PTCLM029
          MOVE      SP70,PTCLM030
          MOVE      SP70,PTCLM031
          MOVE      SP70,PTCLM032
.
          MOVE      Z70,PTCLM037
          MOVE      Z70,PTCLM038
          MOVE      Z70,PTCLM039
          MOVE      Z70,PTCLM040
          MOVE      Z70,PTCLM041
          MOVE      Z70,PTCLM042
          MOVE      Z70,PTCLM043
          MOVE      Z70,PTCLM044
          MOVE      Z70,PTCLM045
          MOVE      Z70,PTCLM046
          MOVE      Z70,PTCLM047
          MOVE      Z70,PTCLM048
          MOVE      Z70,PTCLM049
          MOVE      Z70,PTCLM050
          MOVE      Z70,PTCLM051
.
          MOVE      Z70,PTCLM052
          MOVE      Z70,PTCLM053
          MOVE      Z70,PTCLM054
          MOVE      Z70,PTCLM055
          MOVE      Z70,PTCLM056
          MOVE      Z70,PTCLM057
          MOVE      Z70,PTCLM058
          MOVE      Z70,PTCLM059
          MOVE      Z70,PTCLM060
          MOVE      Z70,PTCLM061
          MOVE      Z70,PTCLM062
          MOVE      Z70,PTCLM063
          MOVE      Z70,PTCLM064
          MOVE      Z70,PTCLM065
          MOVE      Z70,PTCLM066
          MOVE      Z70,PTCLM067
          MOVE      Z70,PTCLM068
          MOVE      Z70,PTCLM069
          MOVE      Z70,PTCLM070
          MOVE      Z70,PTCLM071
          MOVE      Z70,PTCLM072
          MOVE      Z70,PTCLM073
          MOVE      Z70,PTCLM074
          MOVE      Z70,PTCLM075
          MOVE      Z70,PTCLM076
          MOVE      Z70,PTCLM077
          MOVE      Z70,PTCLM078
          MOVE      Z70,PTCLM079
          MOVE      Z70,PTCLM080
          MOVE      Z70,PTCLM081
          MOVE      Z70,PTCLM082                                    * Car 273294
          MOVE      Z70,PTCLM083
          MOVE      Z70,PTCLM084
          MOVE      Z70,PTCLM085
          MOVE      Z70,PTCLM086
          MOVE      Z70,PTCLM087
          MOVE      Z70,PTCLM088
          MOVE      Z70,PTCLM089
.
          MOVE      ZERO,RACTVFLG
          MOVE      ZERO,REFRFLAG
          MOVE      ZERO,ACCFFLAG
          MOVE      ZERO,SERIFLAG
          MOVE      SP70,FIRSTADM
          MOVE      SP70,TRANDTTM
          PACK      REDIREC1,SP70,SP70,SP70,SP70
          PACK      REDIRECT,SP70,SP70,SP70,SP70
          MOVE      ZEROVISN,PREVADMN
          MOVE      SP70,PREVADMD
          PACK      REDIR254,SP70,SP70,SP70,SP70
          MOVE      ZERO,SHOWFLAG
          PACK      KEEPBKTM,SP70
.
          CALL      CLRMEH00
          CALL      CLRLEG00
.
          CALL      CVPMI000            * clear parameter for PMI Extension
.
          CALL      CPNZSP00            * clear parameter for nzpspraf
.
          MOVE      ZERO,NORECORD
          MOVE      ZERO,STARTNUM
.
          MOVE      SP70,ACCDG002
          MOVE      SP70,ACCDG003
          MOVE      SP70,ACCDG004
          MOVE      SP70,ACCDG005
.
          MOVE      SP70,ACCRD002
          MOVE      SP70,ACCRD003
          MOVE      SP70,ACCRD004
          MOVE      SP70,ACCRD005
          MOVE      SP70,ACCRD006
          MOVE      SP70,ACCRD007
.
          MOVE      SP70,ACCLO002
          MOVE      SP70,ACCNUMBR
          MOVE      Z70,ACCPORDN
          MOVE      Z70,ICOMMENT
.
          PACK      UNIQUEKY,Z70
.
          PACK      PTRGM001,SP70
          PACK      PTRGM002,SP70
          PACK      PTRGM003,SP70
.
          MOVE      SP70,PTDSC003
          MOVE      SP70,PTDSC004
          MOVE      SP70,PTDSC005
          MOVE      SP70,PTDSC006
          MOVE      SP70,PRFANEWA
.
          MOVE      SP70,CHNGREAS
          MOVE      SP70,SUPINSAD
.
          PACK      TACINDCT,SP70
.
          PACK      UPEMMRIN,SP70
          MOVE      ZERO,IPADMDAT
          PACK      THEADURA,SP70
.
          CALL      CPMOC000
          CALL      CPMOS000
          CALL      CPPMCE00
          CALL      CPPMEX00
          CALL      CPMRES00
.
          MOVE      SP70,DISPT001
          MOVE      SP70,DISPT002
          MOVE      SP70,CPMISKEY
          MOVE      SP70,STATNCOD
          MOVE      Z70,PRNTFORM
          MOVE      SP70,SCHDPRNT
          MOVE      ZERO,SCHDCOPY
          MOVE      SP70,UPDATPMI
.
          MOVE      SP70,SAVTDEPT
.
          MOVE      Z70,PMSVX079
          MOVE      Z70,PMSVX125
          MOVE      Z70,PMSVX142
          MOVE      Z70,PMSVX146
.
          MOVE      Z70,WAABWGHT
          MOVE      Z70,WAACLSS
          MOVE      Z70,WAASRCE
          MOVE      Z70,WAEXAUTH
          MOVE      Z70,WAEXAUDA
.
          MOVE      ZERO,BYPASSCV
.
          CALL      CLPATMIS
.
          MOVE      SP70,ISEDLITE
.
          CALL      CLPATATR
.
          MOVE      ZERO,CHNGMADE
          MOVE      SP70,REQUESTN
          MOVE      SP70,USERNAME
.
          MOVE      SP70,PREVPRFA
.
          MOVE      SP70,BMIINDIC
.
          MOVE      SP70,NMDSAELI    * Save existing AELIG value
          MOVE      SP70,NMDSASRC    * Admission Source
          MOVE      SP70,NMDSPHSP    * Principal Health Service Purchaser
          MOVE      SP70,NMDSACLS    * Patient Type
          MOVE      SP70,NMDSAGNC    * Agency Code
.
          MOVE      SP70,ADMISCKI
          MOVE      SP70,SVHAONPR
          MOVE      SP70,SVHAWBWR
.
          MOVE      SP70,IBAALVIN
          MOVE      SP70,IBALV001
.
          MOVE      SP70,STOPDWAW
.
          MOVE      SP70,OLDADATE
.
          MOVE      ZERO,MESSFLAG
          CALL      CLPATVIS
.
          MOVE      SP70,EMERFLAG
          MOVE      SP70,ADMTFLAG
.
          MOVE      Z70,DIETDTYP
          MOVE      Z70,DIETCOMM
          MOVE      SP70,UPDHFUND
          MOVE      Z70,REASADM1
          MOVE      Z70,REASADM2
          MOVE      Z70,REASADM3
          CALL      CPPTQM00
.
          MOVE      ZERO,LASTITEM
          MOVE      ONE,F3
          WHILE     F3 <= 100
            MOVE      SP70,MCNTR[F3]
            MOVE      SP70,OECMB[F3]
            ADD       ONE,F3
          DO
.
          MOVE      SP70,OECEPROV
          MOVE      SP70,OECEPRV2
          MOVE      SP70,OECEPRV3
.
          MOVE      SP70,EXTRPROV
          MOVE      SP70,EXTRPRV2
          MOVE      SP70,EXTRPRV3
          MOVE      SP70,EXTRPRV4
          MOVE      SP70,EXTRPRV5
.
          MOVE      SP70,UPINUMBR
          MOVE      SP70,UPINSPID
.
          MOVE      SP70,SJOGAUDT
          MOVE      SP70,ADDRAUDT
          MOVE      SP70,ALIASSTS
          MOVE      SP70,SCANNEDM
.
          MOVE      SP70,SAVENEED
          MOVE      SP70,SAVEASST
          MOVE      SP70,SAVECONT
          MOVE      SP70,SAVEAPPR
          MOVE      SP70,SAVEALTW
          MOVE      SP70,SAVEUNFD
          MOVE      SP70,SAVEUNFT
          MOVE      SP70,SAVEFISD
          MOVE      SP70,SAVERNWD
          MOVE      SP70,SAVETYPA
          MOVE      SP70,SAVESALT
          MOVE      SP70,SAVEHPDA
          MOVE      Z70,VEMDRESI
          MOVE      SP70,VISCOMIN
          MOVE      SP70,STATVTYP
          MOVE      SP70,STATVISN
          MOVE      SP70,SUPERLEV
          MOVE      SP70,NOTIFYHS
.
          CALL      CWBOC000
          CALL      CWBOS000
          CALL      CWBMS000
.
          MOVE      SP70,WBOMF001
          MOVE      SP70,AUTOMVMR
.
          MOVE      Z70,MRFDDATE
.
          MOVE      ZERO,REFREJCT
          MOVE      SP70,EXTIM001
          MOVE      ZERO,EDWDBABY
          MOVE      SP70,FHIRLOCH
          MOVE      SP70,CHCKCOMP
          MOVE      SP70,SCRNAME
.
          MOVE      ONE,F2
          WHILE     F2 < 95
            MOVE      SP70,PRTFOARR[F2]
            MOVE      SP70,SCHDPARR[F2]
            MOVE      ZERO,SCHDCARR[F2]
            MOVE      SP70,STATNARR[F2]
            ADD       ONE,F2
          DO
.
CLRPAR99  RETURN
+
.------------------------------------------------------------
. SETPAR00 - Set Parameters
.------------------------------------------------------------
.
SETPAR00  MATCH     "casekeys=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CASEKEYS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "redirect=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REDIRECT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "corsp001=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CORSP001
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "corsp003=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CORSP003
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "copyflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,COPYFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "copypdef=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,COPYPDEF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "returncd=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RETURNCD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "redirec1=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REDIREC1
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nextpage=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTPAGE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "batchnum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,BATCHNUM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "recurrfl=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RECURRFL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "discflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DISCFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "emexp001=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EMEXP001
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "contmult=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CONTMULT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prevdeta=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PREVDETA
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "urnumber=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,URNUMBER
            PACK      URNUMBER,URNUMBER,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "temporar=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TEMPORAR
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nobkdes2=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NOBKDES2
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "bedtrkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,BEDTRKEY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "alternat=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ALTERNAT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "vinahupd=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VINAHUPD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "alternid=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ALTERNID
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trandate=",QRYNAME     * this it for date field
          IF        @EQUAL
            UNPACK    QRYDATA,KEY1,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00              * Set CMON from MTHNAM3
            PACK      QRYDATA,CCENT,CYEAR,CMON,CDAY
            MOVE      QRYDATA,TRANDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trandate1=",QRYNAME     * this it for date field
          IF        @EQUAL
            UNPACK    QRYDATA,KEY1,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00              * Set CMON from MTHNAM3
            PACK      QRYDATA,CCENT,CYEAR,CMON,CDAY
            MOVE      QRYDATA,TRANDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trantime=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRANTIME
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "refrejct=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REFREJCT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mvmedrec=",QRYNAME
          IF        @EQUAL
            MOVE       QRYDATA,MVMEDREC
            GOTO       SETPAR99
          ENDIF
.
          MATCH     "retdfrae=",QRYNAME
          IF        @EQUAL
            MOVE       QRYDATA,RETDFRAE
            GOTO       SETPAR99
          ENDIF
.
          MATCH     "urgenovr=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,URGENOVR
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nomessag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NOMESSAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "quickreg=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,QUICKREG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "showflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SHOWFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admissno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMISSNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "emadmiss=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EMADMISS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "emrvisit=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EMRVISIT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "medrtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MEDRTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prvadmis=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRVADMIS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "cpypamis=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CPYPAMIS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "noofdays=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NOOFDAYS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "newbornf=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEWBORNF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "boarderf=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,BOARDERF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mothadmn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MOTHADMN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "sesskeys=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SESSKEYS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "theaflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,THEAFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "otptflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OTPTFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "altidflg=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ALTIDFLG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "kidsflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,KIDSFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "suprfunc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SUPRFUNC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "altidtyp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ALTIDTYP
            PACK      ALTIDTYP,ALTIDTYP,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "formactn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FORMACTN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updatety=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,UPDATETY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updttype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDTTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updatet2=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,UPDATET2
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "chdisdte=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CHDISDTE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "chdisdt2=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CHDISDT2
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "allocate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ALLOCATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "addordel=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADDORDEL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "emradmit=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EMRADMIT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "emradmis=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EMRADMIS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "chckname=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CHCKNAME
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prevaddr=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PREVADDR
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prevemra",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PREVEMRA
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "claimtyp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CLAIMTYP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "savealia=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SAVEALIA
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "savealpr=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SAVEALPR
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "preadbok=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PREADBOK
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "preadmeh=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PREADMEH
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "cpadm001=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CPADM001
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "cpadm002=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CPADM002
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "cpadm003=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CPADM003
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "cpadm004=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CPADM004
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "cpadm006=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CPADM006
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "cpadm007=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CPADM007
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "regiflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REGIFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "cpadm008=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,KEY11         * Change Date format
            PACK      KEY11,KEY11,SP70
.
            MATCH     SP70,KEY11
            GOTO      SETPAR99 IF EQUAL
.
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      CPADM008,CCENT,CYEAR,CMON,CDAY
            REP       " 0",CPADM008
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "cpadm009=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CPADM009
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admtward=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMTWARD
            MOVE      ONE,MISUPDFL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admitbed=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMITBED
            MOVE      ONE,MISUPDFL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admitbox=",QRYNAME
          IF        @EQUAL
SETPAT50    MOVE      QRYDATA,FORM1
            COMPARE   ONE,FORM1
            IF        @EQUAL
              MOVE      FORM1,ADMITBOX
            ENDIF
            MOVE      ONE,MISUPDFL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admitnow=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FORM1
            COMPARE   ZERO,FORM1
            IF        @EQUAL
              MOVE      FORM1,ADMITNOW
            ENDIF
            MOVE      ONE,MISUPDFL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "bookflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,BOOKFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "systflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SYSTFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "residadm=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RESIDADM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "refvisno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REFVISNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "refrdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REFRDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "refrlvis=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REFRLVIS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "cancthet=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CANCTHET
            MOVE      ONE,MISUPDFL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchsnam=",QRYNAME
          IF        @EQUAL
            PACK      SRCHSNAM,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchgnam=",QRYNAME
          IF        @EQUAL
            PACK      SRCHGNAM,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchmnam=",QRYNAME
          IF        @EQUAL
            PACK      SRCHMNAM,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchpsex=",QRYNAME
          IF        @EQUAL
            PACK      SRCHPSEX,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchpdob=",QRYNAME
          IF        @EQUAL
            MATCH     SP70,QRYDATA
            GOTO      SETPAR99 IF EQUAL
            GOTO      SETPAR99 IF EOS
.
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00              * Set CMON from MTHNAM3
            PACK      SRCHPDOB,CCENT,CYEAR,CMON,CDAY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchmedi=",QRYNAME
          IF        @EQUAL
            PACK      SRCHMEDI,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "delaldob=",QRYNAME
          IF        @EQUAL
            MATCH     SP70,QRYDATA
            GOTO      SETPAR99 IF EQUAL
            GOTO      SETPAR99 IF EOS
.
            MOVE      QRYDATA,DELALDOB
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "manalloc=",QRYNAME
          IF        @EQUAL
            MATCH     SP70,QRYDATA
            GOTO      SETPAR99 IF EQUAL
            GOTO      SETPAR99 IF EOS
.
            MOVE      QRYDATA,MANALLOC
            IF        MANALLOC=1
              MOVE      ZERO,CGENRUR
            ENDIF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchpage=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SRCHPAGE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trnsfsrc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRNSFSRC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mhadmflg=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MHADMFLG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "urcommnt=",QRYNAME
          IF        @EQUAL
            MOVE      ONE,URCMTFLG
            CALL      GTURCM00              * Read in U/R Comments
          ENDIF
.
          MATCH     "adcommnt=",QRYNAME
          IF        @EQUAL
            MOVE      ONE,VSCMTFLG
            CALL      GTVISC00              * Read in Adm Comments
          ENDIF
.
          MATCH     "ptmas",QRYNAME
          IF        @EQUAL
            CALL      SPMAS000
            COMPARE   ZERO,EXIT
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "ptmsx",QRYNAME
          IF        @EQUAL
            CALL      SPMSX000
            COMPARE   ZERO,EXIT
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "mrmas001",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MRMAS001
            PACK      MRMAS001,MRMAS001,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mrmas002",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MRMAS002
            PACK      MRMAS002,MRMAS002,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mrmas003",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MRMAS003
            PACK      MRMAS003,MRMAS003,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptvis",QRYNAME
          IF        @EQUAL
            CALL      SPVIS000
            COMPARE   ZERO,EXIT
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "othrcont",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OTHRCONT
            PACK      OTHRCONT,OTHRCONT,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptmis",QRYNAME
          IF        @EQUAL
            CALL      SPMIS000
            COMPARE   ZERO,EXIT
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "pmext",QRYNAME
          IF        @EQUAL
            CALL      SPPME000
            BRANCH    EXIT,SETPAR99
            MOVE      ONE,CLMUPDFL
          ENDIF
.
          MATCH     "ptasf",QRYNAME
          IF        @EQUAL
            CALL      SPASF000
            COMPARE   ZERO,EXIT
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "ptclm",QRYNAME
          IF        @EQUAL
            CALL      SPCLM000
            COMPARE   ZERO,EXIT
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "ptpra",QRYNAME
          IF        @EQUAL
            CALL      SPPRA000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmpmi",QRYNAME
          IF        @EQUAL
            CALL      SVPMI000
            COMPARE   ZERO,EXIT
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "wathi002=",QRYNAME
          IF        @EQUAL
            MATCH     SP70,QRYDATA
            GOTO      SETPAR99 IF EQUAL
            GOTO      SETPAR99 IF EOS
.
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00              * Set CMON from MTHNAM3
            PACK      WATHI002,CCENT,CYEAR,CMON,CDAY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mehvs",QRYNAME
          IF        @EQUAL
            CALL      SETMHF00
            COMPARE   ZERO,EXIT
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "seriflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SERIFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "refrflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REFRFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "accfflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ACCFFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "firstadm=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FIRSTADM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trandttm=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRANDTTM
            GOTO      SETPAR99
          ENDIF

.
          MATCH     "crmedrec=",QRYNAME              * I CAR 38490
          IF        @EQUAL
            MOVE      QRYDATA,CRMEDREC
            GOTO      SETPAR99                       * end I CAR 38490
          ENDIF
.
          MATCH     "waitflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,WAITFLAG
            GOTO      SETPAR99
          ENDIF
.
.
          MATCH     "ethncty1=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ETHNCTY1
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ethncty2=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ETHNCTY2
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ethncty3=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ETHNCTY3
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "alemrflg",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ALEMRFLG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nzspr",QRYNAME
          IF        @EQUAL
            CALL      SPNZSP00
            COMPARE   ZERO,EXIT
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "pmres",QRYNAME
          IF        @EQUAL
            CALL      SPMRES00
            COMPARE   ZERO,EXIT
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "uniqueky",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UNIQUEKY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "accauflg",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ACCAUFLG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "accdflag",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ACCDFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "accflag1",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ACCFLAG1
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "accdg002",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ACCDG002
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "accdg003",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ACCDG003
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "accdg004",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ACCDG004
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "accdg005",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ACCDG005
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "accrd002",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ACCRD002
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "accrd003",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ACCRD003
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "accrd004",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ACCRD004
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "accrd005",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ACCRD005
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "accrd006",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ACCRD006
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "accrd007",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ACCRD007
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "acclo002",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ACCLO002
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ainjcmnt",QRYNAME            * Additional Injury Comment
          IF        @EQUAL
            CALL      GETAIJ00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "cinjcmnt",QRYNAME            * Cause of Injury Comment
          IF        @EQUAL
            CALL      GETCIJ00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "awrkcmnt",QRYNAME            * Alternative Work Restn
          IF        @EQUAL
            CALL      GETAWK00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "norecord=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NORECORD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startnum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTNUM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptrgm",QRYNAME
          IF        @EQUAL
            CALL      SPRGM000
            COMPARE   ZERO,EXIT
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "mehlg",QRYNAME
          IF        @EQUAL
            CALL      SETMHL00
            COMPARE   ZERO,EXIT
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "tacindct",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TACINDCT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "accnumbr",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ACCNUMBR
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "accpordn",QRYNAME
          IF        @EQUAL
            PACK      ACCPORDN,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptelg014=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PTELG014
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptelg033=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PTELG033
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmsoc",QRYNAME
          IF        @EQUAL
            CALL      SPMOC000
            CALL      SWBOC000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "oes0",QRYNAME
          IF        @EQUAL
            CALL      SPMOS000
            CALL      SWBOS000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmsom",QRYNAME
          IF        @EQUAL
            CALL      SWBOM000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "oms0",QRYNAME
          IF        @EQUAL
            CALL      SWBMS000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "keepbktm=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,KEEPBKTM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "upemmrin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPEMMRIN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmcex",QRYNAME
          IF        @EQUAL
            CALL      SPPMC000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "addnewpg=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADDNEWPG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updrgdat=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDRGDAT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dispt001",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DISPT001
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dispt002",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DISPT002
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "cpmiskey",QRYNAME
          IF        @EQUAL
            PACK      CPMISKEY,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prntform=",QRYNAME
          IF        @EQUAL
            PACK      PRNTFORM,QRYDATA,SP70
          ENDIF
.
          MATCH     "prtform",QRYNAME
          IF        @EQUAL
            MATCH     "prtform1",QRYNAME
            IF        @EQUAL
              PACK      PRTFOARR[1],QRYDATA,SP70
            ENDIF
.
            MATCH     "prtform2",QRYNAME
            IF        @EQUAL
              PACK      PRTFOARR[2],QRYDATA,SP70
            ENDIF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "schdprnt",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SCHDPRNT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "schdprt",QRYNAME
          IF        @EQUAL
            MATCH     "schdprt1",QRYNAME
            IF        @EQUAL
              PACK      SCHDPARR[1],QRYDATA,SP70
            ENDIF
.
            MATCH     "schdprt2",QRYNAME
            IF        @EQUAL
              PACK      SCHDPARR[2],QRYDATA,SP70
            ENDIF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "schdcopy=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,SCHDCOPY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "schdcop",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MATCH     "schdcop1",QRYNAME
            IF        @EQUAL
              MOVE      QRYDATA,SCHDCARR[1]
            ENDIF
.
            MATCH     "schdcop2",QRYNAME
            IF        @EQUAL
              MOVE      QRYDATA,SCHDCARR[2]
            ENDIF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "statncod=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STATNCOD
            PACK      STATNCOD,STATNCOD,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "schform",QRYNAME
          IF        @EQUAL
            MATCH     "schform1",QRYNAME
            IF        @EQUAL
              PACK      STATNARR[1],QRYDATA,SP70
            ENDIF
.
            MATCH     "schform2",QRYNAME
            IF        @EQUAL
              PACK      STATNARR[2],QRYDATA,SP70
            ENDIF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updatpmi",QRYNAME
          IF        @EQUAL
            PACK      UPDATPMI,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmsvx079=",QRYNAME
          IF        @EQUAL
            PACK     PMSVX079,QRYDATA,SP70
          ENDIF
.
          MATCH     "pmsvx125=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PMSVX125
            PACK      PMSVX125,PMSVX125,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmsvx142=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PMSVX142
            PACK      PMSVX142,PMSVX142,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "icomment=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ICOMMENT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "confdemo=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CONFDEMO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschstat=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHSTAT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschdest=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHDEST
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschdia1=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHDIA1
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschdia2=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHDIA2
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschirad=",QRYNAME     * HPS Code Starts Here
          IF        @EQUAL
            MOVE      QRYDATA,DSCHIRAD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschsref=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHSREF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschmbsc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHMBSC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschcom1=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHCOM1
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschcom2=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHCOM2
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschdety=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHDETY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschcrav=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHCRAV
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschadtt=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHADTT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschadta=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHADTA
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschrcct=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHRCCT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschmhls=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHMHLS
            GOTO      SETPAR99
          ENDIF                             * HPS Code Ends Here
.
          MATCH     "dschusr1=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHUSR1
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschusr2=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHUSR2
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschusr3=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHUSR3
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschusr4=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHUSR4
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschusr5=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHUSR5
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschautp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHAUTP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschdind=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHDIND
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschpalc=",QRYNAME                                *I-53371
          IF        @EQUAL
            MOVE      QRYDATA,DSCHPALC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschpysp=",QRYNAME                                *I-53371
          IF        @EQUAL
            MOVE      QRYDATA,DSCHPYSP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschrtos=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHRTOS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschfinp=",QRYNAME                                *I-53371
          IF        @EQUAL
            MOVE      QRYDATA,DSCHFINP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschtran=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHTRAN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschdpmn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHDPMN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschclgp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DSCHCLGP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updtmhhl=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDTMHHL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "theadura=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,THEADURA
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "savtdept=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SAVTDEPT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "deadflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DEADFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "defstatd=",QRYNAME                    *T0874934
          IF        @EQUAL
            MOVE      QRYDATA,DEFSTATD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ipadmdat=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,IPADMDAT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "bypasscv=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,BYPASSCV
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "isedlite=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ISEDLITE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admisnid=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMISNID
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "heaview1=",QRYNAME                     *T0852969
          IF        @EQUAL
            MOVE      QRYDATA,HEAVIEW1
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "erefrlid=",QRYNAME
          IF        @EQUAL
            PACK      EREFRLID,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admreqno=",QRYNAME
          IF        @EQUAL
            PACK      ADMREQNO,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "chngmade=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CHNGMADE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "requestn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REQUESTN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "username=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,USERNAME
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prevprfa=",QRYNAME
          IF        @EQUAL
            PACK      PREVPRFA,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "bmiindic=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,BMIINDIC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptatr",QRYNAME
          IF        @EQUAL
            CALL      SPTATR00
            COMPARE   ZERO,EXIT
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "extcomin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EXTCOMIN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updtadmn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDTADMN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmsvx146=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PMSVX146
            PACK      PMSVX146,PMSVX146,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admiscki=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMISCKI
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "svhaonpr=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SVHAONPR
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ibaalvin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,IBAALVIN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ibalv001=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,IBALV001
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "stopdwaw=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STOPDWAW
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "emerflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EMERFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admtflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMTFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dietdtyp",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DIETDTYP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dietcomm",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DIETCOMM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updhfund=",QRYNAME
          IF        @EQUAL
            MOVE       QRYDATA,UPDHFUND
            GOTO       SETPAR99
          ENDIF
.
          MATCH     "remoteno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REMOTENO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "reasadm1=",QRYNAME
          IF        @EQUAL
            PACK      REASADM1,QRYDATA,SP70,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "reasadm2=",QRYNAME
          IF        @EQUAL
            PACK      REASADM2,QRYDATA,SP70,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "reasadm3=",QRYNAME
          IF        @EQUAL
            PACK      REASADM3,QRYDATA,SP70,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptqmh",QRYNAME
          IF        @EQUAL
            CALL      SPQMH000              * Set QLD MH Details
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mcntr",QRYNAME
          IF        @EQUAL
            CALL      SMCNTR00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "oecmb",QRYNAME
          IF        @EQUAL
            CALL      SOECMB00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "oeceprov=",QRYNAME
          IF        @EQUAL
            PACK      OECEPROV,QRYDATA,SP70,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "oeceprv2=",QRYNAME
          IF        @EQUAL
            PACK      OECEPRV2,QRYDATA,SP70,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "oeceprv3=",QRYNAME
          IF        @EQUAL
            PACK      OECEPRV3,QRYDATA,SP70,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "extrprov=",QRYNAME
          IF        @EQUAL
            PACK      EXTRPROV,QRYDATA,SP70,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "extrprv2=",QRYNAME
          IF        @EQUAL
            PACK      EXTRPRV2,QRYDATA,SP70,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "extrprv3=",QRYNAME
          IF        @EQUAL
            PACK      EXTRPRV3,QRYDATA,SP70,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "extrprv4=",QRYNAME
          IF        @EQUAL
            PACK      EXTRPRV4,QRYDATA,SP70,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "extrprv5=",QRYNAME
          IF        @EQUAL
            PACK      EXTRPRV5,QRYDATA,SP70,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "upinumbr=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPINUMBR
            PACK      UPINUMBR,UPINUMBR,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "upinspid=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPINSPID
            PACK      UPINSPID,UPINSPID,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "sjogaudt=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SJOGAUDT
            PACK      SJOGAUDT,SJOGAUDT,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "addraudt=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADDRAUDT
            PACK      ADDRAUDT,ADDRAUDT,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "aliassts=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ALIASSTS
            PACK      ALIASSTS,ALIASSTS,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "scannedm=",QRYNAME
          IF        @EQUAL
            PACK      SCANNEDM,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "vemdresi=",QRYNAME
          IF        @EQUAL
            PACK      VEMDRESI,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "bedrqqry=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,BEDRQQRY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "viscomin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VISCOMIN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "statvtyp=",QRYNAME
          IF        @EQUAL
            PACK      STATVTYP,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "statvisn=",QRYNAME
          IF        @EQUAL
            PACK      STATVISN,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "superlev=",QRYNAME
          IF        @EQUAL
            PACK      SUPERLEV,QRYDATA,SP70
          ENDIF
.
          MATCH     "notifyhs=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NOTIFYHS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmhrd",QRYNAME
          IF        @EQUAL
            CALL      SPPMHR00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "wbomf001=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,WBOMF001
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "automvmr=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,AUTOMVMR
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "reaschng=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REASCHNG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mrfddate=",QRYNAME
          IF        @EQUAL
            MATCH     SP70,QRYDATA
            IF        @EQUAL | @EOS
              MOVE      SP70,MRFDDATE
              GOTO      SETPAR99
            ENDIF
.
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00            * Set CMON from MTHNAM3
            PACK      MRFDDATE,CCENT,CYEAR,CMON,CDAY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "vsxdc",QRYNAME
          IF        @EQUAL
            CALL      SVSXDC00              * Visit extra data
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptdsc003=",QRYNAME
          IF        @EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00              * Set CMON from MTHNAM3
            PACK      QRYDATA,CCENT,CYEAR,CMON,CDAY
            PACK      PTDSC003,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptdsc004=",QRYNAME
          IF        @EQUAL
            PACK      PTDSC004,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptdsc005=",QRYNAME
          IF        @EQUAL
            PACK      PTDSC005,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptdsc006=",QRYNAME
          IF        @EQUAL
            PACK      PTDSC006,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prfanewa=",QRYNAME
          IF        @EQUAL
            PACK      PRFANEWA,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "chngreas=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CHNGREAS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "supinsad=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SUPINSAD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "chckcomp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CHCKCOMP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "scrname =",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SCRNAME
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "heanbhfl=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,HEANBHFL
            GOTO      SETPAR99
          ENDIF
.
SETPAR99  RETURN
+
.------------------------------------------------------------
. Set parameters for Unique ID/counter for MBS items
.------------------------------------------------------------
SMCNTR00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      SMCNTR99 IF EQUAL
          PACK      MCNTR[F3],QRYDATA,SP70
SMCNTR99  RETURN
+
.------------------------------------------------------------
. Set parameters for OEC request checkbox
.------------------------------------------------------------
SOECMB00  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      SOECMB99 IF EQUAL
          PACK      OECMB[F3],QRYDATA,SP70
          MOVE      F3,LASTITEM
SOECMB99  RETURN
+
.--------------------------------------------------------------
. GTURCM00 - Get UR Comments from input UR comment TextArea and
.            and write them to the temporary file for updating
.            to the database 
.--------------------------------------------------------------
.
GTURCM00  PREP      COMFILAF,COMFILNM
          GOTO      GTURCM20
.
GTURCM10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GTURCM99 IF OVER
.
          MATCH     SP70,QRYNAME
          GOTO      GTURCM80 IF NOT EQUAL
.
GTURCM20  MOVE      QRYDATA,QRYDATA1
          SQUEEZE   QRYDATA1                 * skip the blank line
          GOTO      GTURCM10 IF EOS
.
          ADD       ONE,URCMTLIN
          WRITE     COMFILAF,SEQ;QRYDATA
          COMPARE   "99",URCMTLIN
          GOTO      GTURCM99 IF EQUAL
.
          GOTO      GTURCM10
.
GTURCM80  MOVE      ONE,TEXTAREA             * Flag for Next CGI Param
.
GTURCM99  RETURN
+
.-----------------------------------------------------------------
. GTVISC00 - Get Visit Comments from input comment TextArea and
.            and write them to the temporary file for updating
.            to the database 
.-----------------------------------------------------------------
.
GTVISC00  PREP      COMVISAF,COMVISNM
          GOTO      GTVISC20
.
GTVISC10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GTVISC99 IF OVER
.
          MATCH     SP70,QRYNAME
          GOTO      GTVISC80 IF NOT EQUAL
.
GTVISC20  MOVE      QRYDATA,QRYDATA1
          SQUEEZE   QRYDATA1                 * skip the blank line      
          GOTO      GTVISC10 IF EOS
.
          ADD       ONE,VSCMTLIN
          WRITE     COMVISAF,SEQ;QRYDATA
          COMPARE   "99",VSCMTLIN
          GOTO      GTVISC99 IF EQUAL
.
          GOTO      GTVISC10
.
GTVISC80  MOVE      ONE,TEXTAREA             * Flag for Next CGI Param
.
GTVISC99  RETURN
+
.------------------------------------------------------------
. GETSCM00 - Get Suggested Treatment Comments
.------------------------------------------------------------

GETSCM00  PREP      COMSGTAF,COMSGTNM
          MOVE      ONE,F3
          WRITE     COMSGTAF,SEQ;QRYDATA
.
GETSCM10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETSCM90 IF OVER
.
          MATCH     SP70,QRYNAME
          GOTO      GETSCM80 IF NOT EQUAL
.
          ADD       ONE,F3
          WRITE     COMSGTAF,SEQ;QRYDATA
          COMPARE   "999",F3
          GOTO      GETSCM90 IF EQUAL
          GOTO      GETSCM10
.
GETSCM80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETSCM90  MOVE      F3,LASTITM3
          OPEN      COMSGTAF,COMSGTNM
.
GETSCM99  RETURN
+
.------------------------------------------------------------
. GETAIJ00 - Get Additonal Injury Comments
.------------------------------------------------------------
GETAIJ00  PREP      COMAIJAF,COMAIJNM
          MOVE      ONE,F3
          WRITE     COMAIJAF,SEQ;QRYDATA
.
GETAIJ10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETAIJ90 IF OVER
.
          MATCH     SP70,QRYNAME
          GOTO      GETAIJ80 IF NOT EQUAL
.
          ADD       ONE,F3
          WRITE     COMAIJAF,SEQ;QRYDATA
          COMPARE   "999",F3
          GOTO      GETAIJ90 IF EQUAL
          GOTO      GETAIJ10
.
GETAIJ80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETAIJ90  MOVE      F3,LASTITM4
          OPEN      COMAIJAF,COMAIJNM
.
GETAIJ99  RETURN
+
.------------------------------------------------------------
. GETCIJ00 - Get Cause of Injury Comments
.------------------------------------------------------------
GETCIJ00  PREP      COMCIJAF,COMCIJNM
          MOVE      ONE,F3
          WRITE     COMCIJAF,SEQ;QRYDATA
.
GETCIJ10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETCIJ90 IF OVER
.
          MATCH     SP70,QRYNAME
          GOTO      GETCIJ80 IF NOT EQUAL
.
          ADD       ONE,F3
          WRITE     COMCIJAF,SEQ;QRYDATA
          COMPARE   "999",F3
          GOTO      GETCIJ90 IF EQUAL
          GOTO      GETCIJ10
.
GETCIJ80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETCIJ90  MOVE      F3,LASTITM5
          OPEN      COMCIJAF,COMCIJNM
.
GETCIJ99  RETURN
+
.------------------------------------------------------------
. GETAWK00 - Get Alternative Work Restriction Comments
.------------------------------------------------------------
GETAWK00  PREP      COMAWKAF,COMAWKNM
          MOVE      ONE,F3
          WRITE     COMAWKAF,SEQ;QRYDATA
.
GETAWK10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETAWK90 IF OVER
.
          MATCH     SP70,QRYNAME
          GOTO      GETAWK80 IF NOT EQUAL
.
          ADD       ONE,F3
          WRITE     COMAWKAF,SEQ;QRYDATA
          COMPARE   "999",F3
          GOTO      GETAWK90 IF EQUAL
          GOTO      GETAWK10
.
GETAWK80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETAWK90  MOVE      F3,LASTITM6
          OPEN      COMAWKAF,COMAWKNM
.
GETAWK99  RETURN
+
.------------------------------------------------------------
. PROFLD00 - Process Fields
.------------------------------------------------------------
.
PROFLD00  BRANCH    REPORTNO,PROFLD10,PROFLD30,PROFLD10,PROFLD10,PROFLD10:
                             PROFLD60,PROFLD70,PROFLD99,PROFLD90,PROFL100:
                             PROFLD99,PROFL120
          GOTO      PROFLD99
.
PROFLD10  BRANCH    FLDSETNO,PROFLD11,PROFLD12,PROFLD13,PROFLD14,PROFLD15:
                             PROFLD16,PROFLD17,PROFLD18,PROFLD19,PROFLD20
          GOTO      PROFLD99
.
PROFLD11  CALL      MASF0000
          GOTO      PROFLD99
.
PROFLD12  IF        REPORTNO=3
            MATCH     "1",NEWBORNF
            IF        !@EQUAL
              MATCH     "1",BOARDERF
              IF        !@EQUAL
                CALL      CLPATMIS
                CALL      CLRAS000                * Clear funding arranging
              ENDIF
            ENDIF
          ENDIF
          CALL      MISF0000
          GOTO      PROFLD99
.
PROFLD13  IF        REPORTNO=3
            MATCH     "1",NEWBORNF
            IF        !@EQUAL
              MATCH     "1",BOARDERF
              IF        !@EQUAL
                CALL      CLPV0000
              ENDIF
            ENDIF
          ENDIF
          CALL      VISF0000
          GOTO      PROFLD99
.
PROFLD14  CALL      CLMF0000
          GOTO      PROFLD99
.
PROFLD15  CALL      EMRA0000
          GOTO      PROFLD99
.
PROFLD16  CALL      EMRB0000
          GOTO      PROFLD99
.
PROFLD17  CALL      MSXF0000
          GOTO      PROFLD99
.
PROFLD18  CALL      BREC0000
          GOTO      PROFLD99
.
PROFLD19  CALL      PMIX0000                * PMI extension file
          GOTO      PROFLD99
.
PROFLD20  CALL      SFAL0000                * Special Funding Arrangement
          GOTO      PROFLD99
.
PROFLD30  BRANCH    FLDSETNO,PROFLD31
          GOTO      PROFLD99
.
PROFLD31  CALL      SFAL0000
          GOTO      PROFLD99
.
PROFLD60  BRANCH    FLDSETNO,PROFLD61,PROFLD62,PROFLD63
          GOTO      PROFLD99
.
PROFLD61  CALL      TABL0000
          GOTO      PROFLD99
.
PROFLD62  CALL      MASF0000
          GOTO      PROFLD99
.
PROFLD63  CALL      SFAL0000                * Special Funding Arrangement
          GOTO      PROFLD99
.
PROFLD70  BRANCH    FLDSETNO,PROFLD71,PROFLD72,PROFLD73,PROFLD74,PROFLD75:
                             PROFLD76,PROFLD77,PROFLD78
          GOTO      PROFLD99
.
PROFLD71  CALL      MASF0000
          GOTO      PROFLD99
.
PROFLD72  CALL      MISF0000
          GOTO      PROFLD99
.
PROFLD73  CALL      VISF0000
          GOTO      PROFLD99
.
PROFLD74  CALL      MHVS0000
          GOTO      PROFLD99
.
PROFLD75  CALL      SFAL0000                * Special Funding Arrangement
          GOTO      PROFLD99
.
PROFLD76  CALL      MHLG0000                * MH Legal status
          GOTO      PROFLD99
.
PROFLD77  CALL      PTEO0000                * External Organisation
          GOTO      PROFLD99
.
PROFLD78  CALL      MISX0000                * miscellaneous extra tags
          GOTO      PROFLD99
.
PROFLD90  BRANCH    FLDSETNO,PROFLD91,PROFLD92,PROFLD93,PROFLD94,PROFLD95:
                             PROFLD96,PROFLD97
          GOTO      PROFLD99
.
PROFLD91  CALL      MASF0000
          GOTO      PROFLD99
.
PROFLD92  CALL      MISF0000
          GOTO      PROFLD99
.
PROFLD93  CALL      NZSP0000
          GOTO      PROFLD99
.
PROFLD94  CALL      NZLT0000          * NZ list
          GOTO      PROFLD99
.
PROFLD95  CALL      VISF0000
          GOTO      PROFLD99
.
PROFLD96  CALL      OPAR0000
          GOTO      PROFLD99
.
PROFLD97  CALL      SFAX0000
          GOTO      PROFLD99
.
PROFL100  BRANCH    FLDSETNO,PROFL101
          GOTO      PROFLD99
.
PROFL101  CALL      ATAB0000
          GOTO      PROFLD99
.
PROFL120  BRANCH    FLDSETNO,PROFL121,PROFL122,PROFL123,PROFL124,PROFL125
          GOTO      PROFLD99
.
PROFL121  CALL      MASF0000
          GOTO      PROFLD99
.
PROFL122  CALL      PMCE0000               * Extra contact details
          GOTO      PROFLD99
.
PROFL123  CALL      RESD0000               * Residency details
          GOTO      PROFLD99
.
PROFL124  CALL      PMEX0000               * Extra compensable details
          GOTO      PROFLD99
.
PROFL125  CALL      RESF0000
          GOTO      PROFLD99
.
PROFLD99  RETURN
+
.------------------------------------------------------------
.         Resident details
.------------------------------------------------------------
RESF0000  BRANCH    FLDITMNO,RESF0100,RESF0200
          GOTO      RESF9999
.
RESF0100  CALL      DSTN0000           * Get Stationery code for the claim code
          GOTO      RESF9999
.
RESF0200  CALL      LINS0000           * List of insurance for a claim code
          GOTO      RESF9999
.
RESF9999  RETURN
+
.------------------------------------------------------------
.         List of Insurance for a claim code
.------------------------------------------------------------
LINS0000  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          MOVE      SP70,ACLAIM
          MOVE      SP70,DIM6
          MOVE      URNUMBER,KEY8
          CALL      RDPMRES1           * read residency file
          IF        OVRCD=0
            MOVE      PMRSINCD,DIM6
          ENDIF
.
          MOVE      SP70,KEY3
.         BRANCH    F1,LINS1000        * PMI
.
          MATCH     SP70,ADMISSNO
          GOTO      LINS1000 IF EQUAL
.
          CALL      GCLM0000           * Get claim for a visit
          MOVE      ACLAIM,KEY3
.
          MATCH     Z70,PMEXT002
          IF        !@EQUAL
            MOVE      PMEXT002,KEY3
          ENDIF
.
          PACK      KEY11,ADMISSNO,KEY3
          CALL      RDPMEXT1           * read extra compensable file
          IF        OVRCD=0
            MOVE      PMEXICOD,DIM6
          ENDIF
.
LINS1000  PACK      KEY6,SP70
          CALL      RDSINSR1
LINS2000  CALL      RDKINSR1
          BRANCH    OVRCD,LINS9999
.
          MATCH     SP70,ICODE
          GOTO      LINS2000 IF EQUAL
.
          COMPARE   THREE,F1
          GOTO      LINS3000 IF EQUAL
.
          MATCH     SP70,KEY3
          IF        !@EQUAL
            MATCH     KEY3,PTINCLAI              * check claim code
            GOTO      LINS2000 IF NOT EQUAL
          ENDIF
.
LINS3000  PACK      KEY8,QUOTE,ICODE,QUOTE
          MATCH     ICODE,DIM6
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY8," selected>":
                               INAME,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY8,">",INAME,"</option>"
          ENDIF
          GOTO      LINS2000
.
LINS9999  RETURN
+
.------------------------------------------------------------
.         Get Stationery code for the claim code
.------------------------------------------------------------
DSTN0000  MOVE      SP70,KEY3
          MATCH     Z70,PMEXT002
          IF        !@EQUAL
            MOVE       PMEXT002,KEY3
          ELSE
            MOVE       ACLAIM,KEY3
          ENDIF
.
          MATCH     SP70,KEY3
          GOTO      DSTN9999 IF EQUAL
.
          PACK      KEY5,ANSC,ANSL,KEY3
          CALL      RDCODE1
          BRANCH    OVRCD,DSTN9999
.
          UNPACK    SP70,IBTHSCOD,IBTHDESC
          MOVE      PTCDFELC,KEY6
          CALL      RDIBTH1
.
          UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          BRANCH    F1,DSTN1000
          WRITE     HTMLFILE;IBTHSCOD;           * Stationery code
          GOTO      DSTN9999
.
DSTN1000  WRITE     HTMLFILE;IBTHDESC;           * Stationery description
.
DSTN9999  RETURN
+
.------------------------------------------------------------
. ACC Search Table Outputs (Visit, Transfers, etc)
.------------------------------------------------------------
ATAB0000  BRANCH    FLDITMNO,ATAB0100
          GOTO      ATAB9999
.
ATAB0100  CALL      ACCTAB00                   * Display ACC Details Table
          GOTO      ATAB9999
.
ATAB9999  RETURN
+
.------------------------------------------------------------
. Output ACC Table Details
.------------------------------------------------------------
ACCTAB00  MOVE      ZERO,DIM1
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,ANS,DIM127      * Visit Type Flag
          UNPACK    DIM127,D1,KEY1,DIM127     * Admission Status Flag
.
          MATCH     "       0",URNUMBER
          GOTO      ACCTAB99 IF EQUAL
.
          CALL      ACOLST00                  * ACC Details Table
.
ACCTAB99  RETURN
+
.------------------------------------------------------------
. Output ACC Table Details
.------------------------------------------------------------
ACOLST00  PACK      KEY44,PTCLM011,SP70
          CALL      RDSWCOM3
ACOLST10  CALL      RDKWCOM3
          BRANCH    OVRCD,ACOLST99
.
          MATCH     PTCLM011,WCCLMNO          * Match ACC Claim Number
          GOTO      ACOLST99 IF NOT EQUAL
.
          PACK      KEY8,DWCADMNO,SP70
          CALL      RDPMWX11
.
          PACK      KEY8,DWCADMNO,SP70         * Read for corresponding
          CALL      RDVISA1                   * admission file
          IF        OVRCD<>1
            GOTO      ACOLST15
          ENDIF
          CALL      OUTFIL00
.
          MOVE      DWCADMNO,KEY8
          CALL      RDBOKB1
          IF        OVRCD=0
            PACK      DPVIBILL,DWCADMNO,SP70
            MOVE      DWCADMNO,PVIBILL
            MOVE      TWO,PVITYPE
            PACK      PVIDATE,OBADATE,SP70
            PACK      PVIURNO,PTWCURNO,SP70
            GOTO      ACOLST15
          ENDIF
.
          MOVE      DWCADMNO,KEY8
          CALL      RDOTRFL1
          IF        OVRCD=0
            PACK      DPVIBILL,DWCADMNO,SP70
            MOVE      DWCADMNO,PVIBILL
            MOVE      TWO,PVITYPE
            PACK      PVIDATE,OTRLDATE,SP70
            PACK      PVIURNO,OTRLURNO,SP70
            GOTO      ACOLST15
          ENDIF
.
          GOTO      ACOLST10
.
ACOLST15  BRANCH    PVITYPE,ACOLST21:
                            ACOLST22:
                            ACOLST23
.
.         MOVE      NINE,DIM1
          COMPARE   NINE,PVITYPE
          GOTO      ACOLST24 IF EQUAL
.
          MOVE      "Unkwn",VISTTYPE
          GOTO      ACOLST30
.
ACOLST21  MOVE      "EMG",VISTTYPE
          GOTO      ACOLST30
.
ACOLST22  MOVE      "OP",VISTTYPE
          GOTO      ACOLST30
.
ACOLST23  MOVE      "IP",VISTTYPE
          GOTO      ACOLST30
.
ACOLST24  MOVE      "AH",VISTTYPE
          GOTO      ACOLST30
.
ACOLST30  MOVE      SP1,PVITYPE               * Initialise PVITYPE
.
          PACK      SAVDATA1,SP70,SP70,SP70
.
          PACK      KEY26,WCCLMNO,ZERO,ZERO,ONE,SP1,SP1,ONE,SP70
          CALL      RDACCMT1
          BRANCH    OVRCD,ACOLST40
.
          MATCH     WCCLMNO,ACCMACCN
          GOTO      ACOLST40 IF NOT EQUAL
          STRIP     ACCMDATA
          CLEAR     SAVDATA1
          APPEND    ACCMDATA,SAVDATA1
          CALL      RKACCMT1
          BRANCH    OVRCD,ACOLST40
          MATCH     WCCLMNO,ACCMACCN
          GOTO      ACOLST40 IF NOT EQUAL
          MATCH     "001",ACCMTYPE
          GOTO      ACOLST40 IF NOT EQUAL
          ENDSET    SAVDATA1
          APPEND    SP1,SAVDATA1
          STRIP     ACCMDATA
          ENDSET    SAVDATA1
          APPEND    ACCMDATA,SAVDATA1
.
ACOLST40  RESET     SAVDATA1
          STRIP     SAVDATA1
          CLEAR     HTMLLINK
          APPEND    "javascript:linkPatient('",HTMLLINK
          APPEND    PVIURNO,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    DPVIBILL,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PVITYPE,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",WCENAME,"#",";
          CLEAR     HTMLLINK
          APPEND    "javascript:linkInsurance('",HTMLLINK
          APPEND    WCICODE,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    ANSV,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"#"",HTMLLINK,"#",":
                             "#"",WCCLMNO,"#",":
                             "#"",PTWCURNO,"#",":
                             "#"",WCACDAT,"#",":
                             "#"",VISTTYPE,"#",":
                             "#"",PVIDATE,"#",":
                             "#"",PVIBILL,"#",":
                             "#"",PMWXALOC,"#",":
                             "#"",SAVDATA1,"#")"
          GOTO      ACOLST10
.
ACOLST99  RETURN
.------------------------------------------------------------
. NEWPRE00 - Display New-Preadmission form
. Returns:    EXIT  0 = Ok to continue
.                   1 = Error
.------------------------------------------------------------
.
NEWPRE00  CALL      CURI0000
          CALL      PREA0000
          CALL      CHKWB000                * check for WL or booking
.
          CALL      CLPATMAS                * clear master detils
          CALL      CLPMSPX2                * clear mast ext2 details
          CALL      CLPATMIS                * clear admission details
          CALL      CLRAS000                * Clear funding arranging
          CALL      CLRCLM00                * clear claim details
          CALL      CLPV0000                * clear patvisaf details
          CALL      CLMR0000                * clear mrtvisaf details
          CALL      CLNZSP00                * clear nzprivate variables
          CALL      CLRRES00                * clear nzprivate variables
          MOVE      SP70,EMVIEWRD
.
          MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,NEWPRE91
.
          COMPARE   FOUR,PSTAT              * EBS Unknown U/R
          GOTO      NEWPRE93 IF EQUAL
.
          IF        DEADFLAG=0
            BRANCH    PCEASE,NEWPRE92       * Patient Deceased
          ENDIF
.
          CALL      RDPMPX21
.
          PACK      KEY8,URNUMBER
          CALL      RDPMPX21
.
          IF        PSTAT=1
            MOVE      PURNO,SAVEURNO
            MOVE      PPSNAME,URNUMBER
            MOVE      ONE,MRGEFLAG
          ENDIF
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDPMRES1
          IF        OVRCD=1
            CALL      CLPMSRES
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDEMVIS1
          IF        OVRCD=1
            CALL       CLEMRVIS
          ENDIF
.
          CALL      CLMISV00               * Clear admission variables
.
          MATCH     "1",NEWBORNF
          IF        !@EQUAL
            MATCH     "1",BOARDERF
            IF        !@EQUAL
              GOTO      NEWPRE90
            ENDIF
          ENDIF
.
          PACK      KEY8,MOTHADMN,SP70
          CALL      RDMISS1
          IF        OVRCD=1
            CALL       CLPATMIS
          ENDIF
          CALL      RDVISA1
          IF        OVRCD=1
            CALL       CLPV0000
          ENDIF
          CALL      RDPMVX11
          IF        OVRCD=1
            CALL       CLPV0000
          ENDIF
.
          CALL      SVMTHADM
          CALL      CLPATMIS
          CALL      CLPV0000
          MATCH     "1",NEWBORNF
          IF        @EQUAL
            CALL      DEFADM00
          ENDIF
.
          MATCH     "1",BOARDERF
          IF        @EQUAL
            CALL      DEFBDA00
          ENDIF
.
NEWPRE90  CALL      PREFOR00                *New Pre-Admission form
          BRANCH    EXIT,NEWPRE99
.
          MOVE      ZERO,EXIT
          GOTO      NEWPRE99
.
NEWPRE91  MOVE      "Can't Find Master Details - NEWPRE",WEBTITLE
          CALL      ADMERR00
          MOVE      ONE,EXIT
          GOTO      NEWPRE99
.
NEWPRE92  MOVE      "Patient is Deceased",WEBTITLE
          CALL      ADMDED00                * allow preadmit deceased patient
          MOVE      ONE,EXIT
          GOTO      NEWPRE99
.
NEWPRE93  CLEAR     WEBTITLE
          APPEND    "Patient has an inappropriate identifier for ",WEBTITLE
          APPEND    "this function.",WEBTITLE
          RESET     WEBTITLE
          CALL      ADMERR00                * allow preadmit deceased patient
          MOVE      ONE,EXIT
          GOTO      NEWPRE99
.
NEWPRE99  RETURN
+
DEFNEW00  RETURN
.------------------------------------------------------------
. ACCS0000 - ACC Search
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
ACCS0000  MOVE      ZERO,EXIT
          CALL      WEBHED00
          BRANCH    EXIT,ACCS9999
          CALL      WEBBOD00
          CALL      WEBEND00
          MOVE      ONE,EXIT
          GOTO      ACCS9999
.
ACCS9999  RETURN
.------------------------------------------------------------
. OUADMF00 - Output Pre-Admission/Admission Form
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
.

OUADMF00  CALL      PATATR00                * Patient Attributes
          CALL      ACAT0000                * Set active only cate code flag
.
          COMPARE   ONE,RECURRFL
          IF        @EQUAL
            CALL      CLPATMAS
            CALL      CLPATMIS
            MATCH     SP70,URNUMBER         * recurring care display page
            GOTO      OUADMF45 IF EQUAL     * no ur entered yet
            GOTO      OUADMF45 IF EOS       * no ur entered yet
          ENDIF
.
          MOVE      SP70,BKREPROC
          CALL      PREA0000
          CALL      CURI0000
          CALL      CLPATMIS
.
          CALL      CLACCDIA
          MATCH     "D",ACCDFLAG            * Diagnosis details
          IF        @EQUAL
            PACK      KEY23,PTCLM011,ACCDG002,SP70
            CALL      RDACDIA1
            BRANCH    OVRCD,OUADMF99
          ENDIF
.
          MATCH     "R",ACCDFLAG            * Referral details
          IF        @EQUAL
            PACK      KEY23,PTCLM011,ACCRD002,SP70
            CALL      RDACRFP1
            BRANCH    OVRCD,OUADMF99
          ENDIF
.
          CALL      CLPATMAS                * clear master detils
          COMPARE   ONE,REPORTNO
          GOTO      OUADMF02 IF NOT EQUAL
          CALL      GCLM0000               * Get claim code
.
          COMPARE   ONE,COPYFLAG    * Copying an admission?
          IF        @EQUAL
            MOVE      ADMISSNO,KEY8
            CALL      RDMISS1
            IF        OVRCD=1
              GOTO      OUADMF95
            ENDIF
          ENDIF
    
          MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
          IF        OVRCD=1
            PACK      KEY8,ADMISSNO,SP70
            CALL      RDEMVIS1              * try emergency file
            IF        OVRCD=1
              PACK      KEY8,ADMISSNO,SP70
              CALL      RDDETA1             * try aae file
              IF        OVRCD=0
                MOVE      ADACOMP,ACLAIM
                MOVE      ADACOMP,EMVICOMP
              ENDIF
            ELSE
              IF        EMVISTAT<>FOUR
                MOVE      EMVICOMP,ACLAIM
              ENDIF
            ENDIF
            MATCH     "030",TEMPLATE
            IF        @EQUAL
              GOTO     OUADMF94 
            ENDIF   
            MATCH     "032",TEMPLATE        * Change pre admission screen
            IF        @EQUAL
              GOTO     OUADMF93
            ENDIF
          ELSE
            MATCH     "032",TEMPLATE          * Change pre admission screen
            IF        @EQUAL
              IF        ASTAT<>1
                GOTO     OUADMF93
              ENDIF
            ENDIF
          ENDIF
.
          IF        SYSTFLAG=4
            MATCH     SP70,CASEKEYS
            IF        !@EQUAL
              PACK      KEY19,CASEKEYS,SP70
              CALL      RDTREA1
              IF        OVRCD<>1
                MOVE      WMBOOK,AADMNO
                MOVE      WMBOOK,ADMISSNO
              ENDIF
            ENDIF
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP20
          CALL      RDRESP1
          IF        OVRCD=1
            CALL      CLPATRE1         * Clear PRFA variables
          ENDIF
.
          PACK      KEY8,ADMISSNO
          CALL      RDPMWX11
          IF        OVRCD=1
            CALL      CLPMSWX1
          ENDIF
.
          MOVE      ZERO,WCFLAG
          PACK      KEY16,URNUMBER,SP70
          CALL      RDSWCOM2
          CALL      RDKWCOM2
          BRANCH    OVRCD,OUADMF02
.
          MATCH     URNUMBER,PTWCURNO         * Match UR numbers
          GOTO      OUADMF02 IF NOT EQUAL
.
          MOVE      ONE,WCFLAG
.
OUADMF02  CALL      LCLM0000                * get default claim details
          CALL      CLPATMIS                * clear admission details
          CALL      CLPV0000                * Clear visit and visit extn
          CALL      CLRAS000                * Clear funding arranging
          CALL      CLRRES00                * clear person responsible details
          CALL      CLMR0000                * clear person responsible details
          CALL      CLSVHM00                * clear SVHM save variables
          CALL      CLMEHVIS                * clear mental health variables
          CALL      CLNZSP00                * clear nzprivate variables
          CALL      CLPMSCEX                * clear extra contact details
          CALL      CLPMSEXT                * clear extrac compensable details
          MOVE      SP70,EMVIEWRD
.
          MATCH     SP70,URNUMBER           * Is there a urnumber????
          GOTO      OUADMF40 IF EQUAL       * no - not sure yet?????
.
          MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,OUADMF92
.
          CALL      RDPMPX21
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDPMRES1
          IF        OVRCD=1
            CALL      CLPMSRES
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70      * Get QLD HDP mental health details
          CALL      RDPTQMH1
          IF        OVRCD=1
            CALL      CLPATQMH
          ENDIF
.
.    SVHM Trasition II
.       save variables for later
.
          MOVE      PSNAME,SVMASNAM
          MOVE      PGNAME,SVMAGNAM
          MOVE      PBDATE,SVMABDAT
          MOVE      PPOST,SVMAPOST
          MOVE      PSEX,SVMAPSEX
          MOVE      PMSTAT,SVMAMSTA
          MOVE      PREG,SVMAPREG
          MOVE      PSUBRB,SVMASUBB
          MOVE      PCONT,SVMACONT
          MOVE      PMEDI,SVMAMEDI
.
          MATCH     "047",TEMPLATE          * MH Admission in Emergency
          GOTO      OUADMF05 IF EQUAL
.
          MATCH     "044",TEMPLATE          * Admission in Emergency
          IF        @EQUAL
OUADMF05    CALL      CLPMSVX1              * Clear visit ex file vars for pre
.                                           * adm when in emergency
            CALL      CHKEM000
            BRANCH    EXIT,OUADMF98
.
            IF        REPORTNO=1
              PACK      KEY8,EMVIADMN,SP70  * Read ED visit extn record for
              CALL      RDPMVX11            * pre admission field defaults
              IF        OVRCD=1
                CALL      CLPMSVX1
              ENDIF
            ENDIF
.
            IF        REPORTNO=4
              MATCH     SP70,EMVIPADM
              IF        !@EQUAL
                MATCH     ADMISSNO,EMVIPADM   * Admit a linked pre admission
                GOTO      OUADMF06 IF EQUAL
              ENDIF
            ENDIF
.
            MATCH     SP70,EMVIPADM
            GOTO      OUADMF91 IF NOT EQUAL
.
            IF        REPORTNO=4
              GOTO      OUADMF06
            ENDIF
.
            GOTO      OUADMF20
          ENDIF
.
OUADMF06  PACK      KEY8,ADMISSNO,SP20
          CALL      RDPMVX11
          IF        OVRCD=1
            CALL      CLPMSVX1
          ELSE
            MOVE      PMVXMDAV,SVVXMDAV
            MOVE      PMVXIRAD,SVVXIRAD
            MOVE      PMVXCADM,SVVXCADM
            MOVE      PMVXIDUS,SVVXIDUS
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP20
          CALL      RDRESP1
          IF        OVRCD=1
            CALL      CLPATRE1         * Clear PRFA variables
          ENDIF
.
          CALL      GASF0000           * get admission SFA details
.
          IF        PSTAT=1
.           ******** VINAH needs to allow pdate old ur values ****
            MATCH     "1",VINAHUPD
            IF        @EQUAL
              MOVE      PURNO,URNUMBER
              MOVE      PPSNAME,SAVEURNO
              MOVE      ONE,MRGEFLAG
            ELSE
              MOVE      PURNO,SAVEURNO
              MOVE      PPSNAME,URNUMBER
              MOVE      ONE,MRGEFLAG
            ENDIF
            GOTO      OUADMF10
          ENDIF
.
          MOVE      URNUMBER,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2              * clear PMI Extension details
          ELSE
            MOVE      PMPXHOML,SVPXHOML
            MOVE      PMPXINTR,SVPXINTR
            MOVE      PMPXLNG1,SVPXLNG1                                *I-40489
            MOVE      PMPXABRG,SVPXABRG
          ENDIF
.
          MATCH     SP70,PTCNAADR
          IF        !@EQUAL
            MATCH     "000",PTCNAADR
            IF        !@EQUAL
              CALL      GALT0000                  * Read alternate address
            ENDIF
          ENDIF
.
          MATCH     SP70,ADMISSNO           * Is there a blank visit number?
          GOTO      OUADMF10 IF EQUAL       * yes - do a new preadmission
          GOTO      OUADMF10 IF EOS
.
          MATCH     ZEROUR,ADMISSNO         * Is there a zero visit number?
          GOTO      OUADMF10 IF EQUAL       * yes - do a new preadmission
.
.         Pre-Admission Previous Details or Admission
.
          CALL      PREDET00                * Read Previous Details
          BRANCH    EXIT,OUADMF98
.
          MATCH     "1",PTCNXCOM
          GOTO      OUADMF08 IF NOT EQUAL   * Not using extra compensable
.
          COMPARE   ONE,REPORTNO
          GOTO      OUADMF08 IF NOT EQUAL
.
          MATCH     "14",TEMPLATE      * template '14*' for Emergency Comp.
          GOTO      OUADMF07 IF EQUAL
          MATCH     "24",TEMPLATE      * template '24*' for Outpat.Compensable
          GOTO      OUADMF07 IF EQUAL
          MATCH     "34",TEMPLATE      * template '34*' for Inpat.Compensable
          GOTO      OUADMF07 IF EQUAL
          MATCH     "44",TEMPLATE      * template '34*' for Inpat.Compensable
          GOTO      OUADMF08 IF NOT EQUAL
.
OUADMF07  MOVE      "7",KEY1           * Local address
          CALL      CNTY0000           * Get contact type for Local
          BRANCH    EXIT,OUADMF08
.
          CALL      GLOC0000           * Get local address
.
          MOVE      SP70,KEY3
          PACK      ADMISSNO,ADMISSNO,SP70
          MATCH     SP70,ADMISSNO
          IF        !@EQUAL
            CALL      GCLM0000           * Get claim code
            IF        EXIT=0
              MOVE      ACLAIM,KEY3
              CALL      REXT0000         * default Resident to Extra compensable
            ENDIF
          ENDIF
.
OUADMF08  COMPARE   ONE,ADMISFLG
          GOTO      OUADMF10 IF EQUAL
.
          CALL      PATNAA00                * format name without bold tags
          CLEAR     WEBTITLE
          APPEND    PATFNAME,WEBTITLE
          APPEND    SP1,WEBTITLE
          APPEND    "(Pre-Admission Previous Details)",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,OUADMF98
.
          CALL      WEBBOD00
          IF        MRGEFLAG=1
            CALL      MRGALT00
          ENDIF
          CALL      WEBEND00
          GOTO      OUADMF90
.
.         If this is Add/Update W/C or TAC claim, must have admission no
.
OUADMF10  COMPARE   ONE,REPORTNO
          GOTO      OUADMF12 IF NOT EQUAL
.
          MATCH     "030",TEMPLATE
          IF        @EQUAL
            MATCH     SP70,ADMISSNO
            GOTO      OUADMF94 IF EQUAL
            GOTO      OUADMF94 IF EOS
          ENDIF
.
          MATCH     "032",TEMPLATE
          IF        @EQUAL
            MATCH     SP70,ADMISSNO
            GOTO      OUADMF93 IF EQUAL
            GOTO      OUADMF93 IF EOS
          ENDIF
.
          MATCH     "050",TEMPLATE
          IF        !@EQUAL
            MATCH     "051",TEMPLATE
            GOTO      OUADMF12 IF NOT EQUAL
          ENDIF
          GOTO      OUADMF94             * missing admission number
.
.         New Pre-Admission
.
OUADMF12  COMPARE   ONE,ADMISFLG
          GOTO      OUADMF20 IF NOT EQUAL
.
          MATCH     SP70,ADMISSNO
          GOTO      OUADMF93 IF EQUAL
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,OUADMF93
.
          CALL      GETNZP00                * Get admission nzpspraf details
.
          COMPARE   ONE,ASTAT
          GOTO      OUADMF93 IF NOT EQUAL
.
OUADMF20  CALL      PREFOR00                * Display New Pre-admission Form
          BRANCH    EXIT,OUADMF98
          GOTO      OUADMF90
.
.         Read Pre-Admission File
.
OUADMF40  MATCH     SP70,ADMISSNO
          GOTO      OUADMF92 IF EQUAL
.
          MOVE      ADMISSNO,KEY8           * Validate pre-admission number
          CALL      RDPRAM1
          BRANCH    OVRCD,OUADMF92          * no pre-admission
.
          CALL      PATNAA00                * format name without bold tags
          CLEAR     WEBTITLE
          APPEND    PATFNAME,WEBTITLE
          APPEND    SP1,WEBTITLE
OUADMF45  APPEND   "(Pre-Admission Previous Details)",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,OUADMF98
.
          CALL      WEBBOD00
          IF        MRGEFLAG=1
            CALL      MRGALT00
          ENDIF
          CALL      WEBEND00
.
OUADMF90  MOVE      ZERO,EXIT
          GOTO      OUADMF99
.
OUADMF91
.
          CLEAR     REDIRECT
          APPEND    "patweb98.pbl?reportno=1&template=51",REDIRECT
          APPEND    "&urnumber=",REDIRECT
          APPEND    URNUMBER,REDIRECT
          APPEND    "&admissno=",REDIRECT
          APPEND    EMVIPADM,REDIRECT
          RESET     REDIRECT
          REP       " +",REDIRECT
          CALL      RDIREC00
          BRANCH    EXIT,OUADMF98
          GOTO      OUADMF90
.
OUADMF92  MOVE      "Can't Find Master Details",WEBTITLE
          CALL      ADMERR00
          MOVE      ONE,EXIT
          GOTO      OUADMF99
.
OUADMF93  MOVE      "Patient is not admitted",WEBTITLE
          CALL      ADMERR00
          GOTO      OUADMF98
.
OUADMF94  MOVE      "Patient is not Admitted",WEBTITLE
          CALL      ADMERR00
          GOTO      OUADMF98
.
OUADMF95  MOVE      "Current visit not an Inpatient Visit",WEBTITLE
          CALL      ADMERR00
          GOTO      OUADMF98
.
OUADMF98  MOVE      ONE,EXIT
          GOTO      OUADMF99
.
OUADMF99  RETURN
+
.------------------------------------------------------------
. Set CATACTIV - only display active cat code for selected
. patweb89 functions. eg admission
.------------------------------------------------------------
ACAT0000  COMPARE   FOUR,REPORTNO           * All report 4 admission pages
          GOTO      ACAT9000 IF EQUAL
.
          COMPARE   ONE,REPORTNO
          GOTO      ACAT9999 IF NOT EQUAL
.
          MATCH     "11",TEMPLATE            * Pre Adm Prev IP details
          GOTO      ACAT9000 IF EQUAL
.
          MATCH     "011",TEMPLATE           * Pre Adm Prev IP details
          GOTO      ACAT9000 IF EQUAL
.
          MATCH     "20",TEMPLATE            * Pre Adm from booking
          GOTO      ACAT9000 IF EQUAL
.
          MATCH     "020",TEMPLATE           * Pre Adm from booking
          GOTO      ACAT9000 IF EQUAL
.
          GOTO      ACAT9999
.
ACAT9000  MOVE      ONE,CATACTIV          * display active cat codes only
.
ACAT9999  RETURN
+
.------------------------------------------------------------
. MEHVIS00 - Mental Health Visit details
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
.
MEHVIS00  COMPARE   ONE,MHCNUSE             * Using MH system
          GOTO      MEHVIS97 IF NOT EQUAL
.
          CALL      CLPATMAS                * clear master detils
          CALL      CLPMSPX2                * clear mast ext2 details
          CALL      CLPATDSC                * clear discharge details
          CALL      CLPATMIS                * clear admission details
          CALL      CLRAS000                * Clear funding arranging
          CALL      CLRCLM00                * clear claim details
          CALL      CLPV0000                * clear patvisaf details
          CALL      CLMR0000                * clear mrtvisaf details
          CALL      CLMEHVIS                * clear mental health details
          CALL      CLRRES00                * clear PRA details
          MOVE      SP70,EMVIEWRD
.
          MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,MEHVIS92
.
          BRANCH    PCEASE,MEHVIS93         * Patient Deceased
.
          PACK      KEY8,URNUMBER
          CALL      RDPMPX21
          BRANCH    OVRCD,MEHVIS92
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMHVIS1
          BRANCH    OVRCD,MEHVIS95
.
          IF        MHVISTAT=7|MHVISTAT=8
            PACK      KEY8,ADMISSNO,SP70
            CALL      RDALREF1
            BRANCH    OVRCD,MEHVIS96
            MOVE      ADMISSNO,AADMNO
            PACK      DAADMNO,ADMISSNO
          ELSE
            PACK      KEY8,ADMISSNO,SP70
            CALL      RDMISS1
            BRANCH    OVRCD,MEHVIS94
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70     * Check if Visit exists?
          CALL      RDVISA1
          BRANCH    OVRCD,MEHVIS91
.
          PACK      KEY8,ADMISSNO,SP70     * Read Visit Extension File?
          CALL      RDPMVX11
          BRANCH    OVRCD,MEHVIS91
.
          PACK      KEY21,ADMISSNO,Z70           * I SRF 33833
          CALL      RSMHLEG1                     * Read latest legal status
          CALL      RPMHLEG1                     * instead of initial
.
          MATCH     DMHLEADM,ADMISSNO
          GOTO      MEHVIS05 IF EQUAL
.
          CALL      CLMEHLEG                * clear MH LS details
          MOVE      ADATE,MHLEDATE
          MOVE      ATIME,MHLETIME
.         MOVE      SP70,MHLESTAT
          MOVE      PMVXMHLS,MHLESTAT
          MOVE      ONE,NEWLEGFL
.
MEHVIS05  PACK      KEY7,MHLEEMPT,MHLEEMPC,SP70
          CALL      RDPTEOR1
          IF        OVRCD=1
            CALL      CLREOR00                * clear external organisation
          ENDIF
          COMPARE   ONE,UPDATETY
          GOTO      MEHVIS08 IF EQUAL
          COMPARE   TWO,UPDATETY
          GOTO      MEHVIS08 IF EQUAL
          COMPARE   THREE,UPDATETY
          GOTO      MEHVIS20 IF EQUAL
          COMPARE   FOUR,UPDATETY
          GOTO      MEHVIS08 IF EQUAL
.
          GOTO      MEHVIS10
.
MEHVIS08
          CALL      UPMHVS00
          CALL      UPMHAD00
          CALL      UPVCM000 
          GOTO      MEHVIS90
.
MEHVIS10  CALL      PATNAA00                * format name without bold tags
          CLEAR     WEBTITLE
          APPEND    PATFNAME,WEBTITLE
          APPEND    SP1,WEBTITLE
          APPEND    "(Mental Health Visit Details)",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,MEHVIS99
.
          CALL      WEBBOD00
          CALL      WEBEND00
.
          GOTO      MEHVIS90
.
MEHVIS20  PACK      KEY8,ADMISSNO,SP70
          CALL      RDMHVIS1
          BRANCH    OVRCD,MEHVIS95
.
          CALL      DEMHVIS1
.
          GOTO      MEHVIS90
.
MEHVIS90  MOVE      ZERO,EXIT
          GOTO      MEHVIS99
.
MEHVIS91  MOVE      "Can't Find Visit record. ",WEBTITLE
          CALL      ADMERR00
          MOVE      ONE,EXIT
          GOTO      MEHVIS99
.
MEHVIS92  MOVE      "Can't Find Master Details",WEBTITLE
          CALL      ADMERR00
          MOVE      ONE,EXIT
          GOTO      MEHVIS99
.
MEHVIS93  MOVE      "Patient is Deceased",WEBTITLE
          CALL      ADMERR00
          MOVE      ONE,EXIT
          GOTO      MEHVIS99
.
MEHVIS94  MOVE      "Admission details not found.",WEBTITLE
          CALL      ADMERR00
          MOVE      ONE,EXIT
          GOTO      MEHVIS99
.
MEHVIS95  MOVE      "Invalid mental health admission.",WEBTITLE
          CALL      ADMERR00
          MOVE      ONE,EXIT
          GOTO      MEHVIS99
.
MEHVIS96  MOVE      "Allied health details not found.",WEBTITLE
          CALL      ADMERR00
          MOVE      ONE,EXIT
          GOTO      MEHVIS99
.
MEHVIS97  MOVE      "Using mental health system not configured.",WEBTITLE
          CALL      ADMERR00
          MOVE      ONE,EXIT
          GOTO      MEHVIS99
.
MEHVIS99  RETURN
+
.-----------------------------------------------------------
. Initialize's file data
.-----------------------------------------------------------
CLREOR00  MOVE      SP70,PTERTYPE   * Organisation Type
          MOVE      SP70,PTERCODE   * Organisation Code
          MOVE      SP70,PTERNAME   * Organisation Name
          MOVE      SP70,PTERADD1   * Organisation Address
          MOVE      SP70,PTERADD2   * Organisation Address
          MOVE      SP70,PTERADD3   * Organisation Address
          MOVE      SP70,PTERADD4   * Organisation Address
          MOVE      SP70,PTERPOST   * Organisation Postcode
          MOVE      SP70,PTERTELP   * Organisation Telephone
          MOVE      SP70,PTERCONT   * Organisation Contact
          MOVE      SP70,PTERSTAT   * Organisation Active
          MOVE      SP70,PTERSPAR   * Spare
CLREOR99  RETURN
+
.------------------------------------------------------------
. UPMHVS00 - Update Mental Health details
.------------------------------------------------------------
.
UPMHVS00  PACK      KEY8,ADMISSNO
          CALL      RDMHVIS1
          BRANCH    OVRCD,UPMHVS99
.
          MOVE      URNUMBER,MHVIURNO
          MOVE      ADMISSNO,MHVIADMN
          MOVE      ZERO,MHVIMXBE
          CALL      MVMEH000               * move cgi to file variables
          CALL      UPMHVIS1
.
          MOVE      ADMISSNO,MHLEADMN
          PACK      KEY21,MHLEADMN,MHLEDATE,MHLETIME,SP70
          CALL      RDMHLEG1
          IF        OVRCD=1
            UNPACK    SP70,MHLEEMPC,MHLEEMPT
            CALL      MVMHL000
            MOVE      ADMISSNO,MHLEADMN
.
            MATCH     Z70,MEHVS034
            IF        !@EQUAL
              MOVE      MEHVS034,MHLESTAT
            ENDIF
.
            MOVE      ANSN,MHLESENT
            MOVE      SP70,MHLEREVW
            MOVE      ANSL,MHLEFLAG
            MOVE      SP70,MHLESPAR
            CALL      WRMHLEG1
          ELSE
            CALL      MVMHL000
.
            MATCH     Z70,MEHVS034
            IF        !@EQUAL
              MOVE      MEHVS034,MHLESTAT
            ENDIF
.
            CALL      UPMHLEG1
          ENDIF
.
          PACK      KEY8,URNUMBER
          CALL      RDMAST1
          BRANCH    OVRCD,UPMHVS99
.
          MOVE      MHLEDATE,PTMXLSDT
          MOVE      MHLESTAT,PTMXLS
          CALL      UPMAST1
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,UPMHVS99
.
          MATCH     MHLESTAT,PMVXMHLS            * change of LS ?
          IF        !@EQUAL
            MOVE      MHLESTAT,PMVXMHLS
            CALL      UPPMVX11
          ENDIF
.
          IF         UPDATETY=2
            CALL       MHREF000             * Write record to LS header record
          ENDIF
.
          MATCH      "1",UPDTMHHL
          IF         @EQUAL
            CALL       UPMHHL00
          ENDIF
.
UPMHVS99  RETURN
+
.----------------------------------------------------------------------------
. MHREF000 - Automatic add LS Referral Management only if no existing record
.----------------------------------------------------------------------------
MHREF000  PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,MHREF999
.
          READ      CONTROLF,SIXTY9;*190,MHCNMHLS
          MATCH     SP70,MHCNMHLS
          GOTO      MHREF010 IF EQUAL
.
          MATCH     "AC",MHCNMHLS
          GOTO      MHREF010 IF EQUAL
.
          MATCH     "CC",MHCNMHLS
          GOTO      MHREF020 IF EQUAL
.
          GOTO      MHREF999
.
MHREF010  MATCH     SP70,ACLSSFT
          GOTO      MHREF999 IF EQUAL
.
          PACK      KEY5,ANSA,ANSC,ACLSSFT,SP70
          GOTO      MHREF030
.
MHREF020  MATCH     SP70,ACARE
          GOTO      MHREF999 IF EQUAL
.
          PACK      KEY5,ANSC,ANSC,ACARE,SP70
          GOTO      MHREF030
.
MHREF030  CALL      RDCODE1
          BRANCH    OVRCD,MHREF9999
.
          MATCH     "P",TCINDC5
          GOTO      MHREF9999 IF NOT EQUAL     * No automatic MH Ref details
.
          OPEN      MEHHLSA1,"mehhlsaf"
          OPEN      MEHHLSA2,"mehhlsaf"
.
          MOVE      SP70,KEY8
          PACK      KEY32,URNUMBER,Z70
          CALL      RSMHHLS2
MHREF050  CALL      RPMHHLS2
          BRANCH    OVRCD,MHREF100
          MATCH     URNUMBER,MHHLURNO
          GOTO      MHREF100 IF NOT EQUAL
.
          MATCH     "1",HEAVIEW1                          *T0852969-Start
          GOTO      MHREF060 IF EQUAL                     *T0852969-End
.
          MATCH     SP70,MHHLOREF
          GOTO      MHREF050 IF EQUAL
.
          PACK      KEY5,CATtm,MHHLOREF,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,MHREF050
.
          MATCH     ANSI,TCINDC1
          GOTO      MHREF050 IF NOT EQUAL
          GOTO      MHREF080 IF EQUAL                      *T0852969-Start
.
.-------- Check Referral Source (Cat S ind7=I) for HEA
MHREF060  MATCH     SP70,MHHLSREF
          GOTO      MHREF050 IF EQUAL
.
          PACK      KEY5,ANSS,SP1,MHHLSREF,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,MHREF050
.
          MATCH     ANSI,TCINDC7
          GOTO      MHREF050 IF NOT EQUAL
          GOTO      MHREF080 IF EQUAL
.
.         Check if it's an Open Legal status
.
MHREF080  MATCH     "1",MHHLSTAT                           *T0852969-End
          GOTO      MHREF050 IF EQUAL
.
          MATCH     SP70,MHHLEDAT
          GOTO      MHREF999 IF EQUAL             * opened referral LS
.
          GOTO      MHREF050
.
MHREF100  READ      CONTROLF,SIXTY9;*86,MHCNUNIQ
          MOVE      MHCNUNIQ,FORM8
          ADD       ONE,MHCNUNIQ
          WRITAB    CONTROLF,SIXTY9;*86,MHCNUNIQ
          MOVE      FORM8,MHCNUNIQ
.
          PACK      KEY16,URNUMBER,MHCNUNIQ,SP70
          CALL      RDMHHLS1
          COMPARE   ZERO,OVRCD
          GOTO      MHREF000 IF EQUAL     * already exist, get next unique no.
.
          CALL      CLMEHHLS
          MOVE      URNUMBER,MHHLURNO
          MOVE      MHCNUNIQ,MHHLUNIQ
.

.         MATCH     SP70,TRANDTTM
.         IF        !@EQUAL & !@EOS
.           MOVE      SP70,DIM8
.           MOVE      SP70,DIM8A
.           UNPACK    TRANDTTM,DIM8,DIM8A
.           PACK      MHHLSDAT,DIM8,SP70
.           PACK      MHHLSTIM,DIM8A,SP70
.         ELSE
.           MOVE      ADATE,MHHLSDAT            * Start date
.           MOVE      ATIME,MHHLSTIM            * Start time
.         ENDIF
.
          MOVE      MHVIRFDT,MHHLSDAT
          MOVE      MHVIRFTM,MHHLSTIM
.
          PACK      MHHLRSCL,ADOCTA,SP70      * Responsible clinician
          MOVE      MHVICSMN,MHHLKWRK         * Case Manager/Key Worker
          PACK      MHHLRODT,MHVIRODT,SP70    * Receival Date
          PACK      MHHLROTM,MHVIROTM,SP70    * Receival Time
          PACK      MHHLAMDT,MHVIAMDT,SP70    * Admit MH Act date
          PACK      MHHLAMTM,MHVIAMTM,SP70    * Admit MH Act time
.
          MATCH     "1",HEAVIEW1                           *T0852969-Start
          IF        @EQUAL
            CALL      GSREF000            *1st Rec of Cat S ind7=I
            PACK      MHHLSREF,MHHLSREF,SP70
          ELSE
            CALL      GORF0000           * first rec.of catg tm with Indic1=I
            PACK      MHHLOREF,MHHLOREF,SP70
          ENDIF
.                                                          *T0852969-End
          PACK      MHHLRCLI,PMVXRHC1,SP70
          PACK      MHHLRCLR,MHVIRMHC,SP70
.
          MOVE      "0",MHHLSTAT              * always active
          MOVE      "1",MHHLCURR              * always Current
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,MHHLCDAT             * date created
          CLOCK     TIME,MHHLCTIM             * time created
          MOVE      USERID,MHHLCUID           * web user id
          UNPACK    SP70,MHHLUDAT,MHHLUTIM,MHHLUUID
          CALL      WRMHHLS1
.
          CLEAR     KEY138
          APPEND    REDIRECT,KEY138
          APPEND    "&uniqnumb=",KEY138
          APPEND    MHHLUNIQ,KEY138
          RESET     KEY138
          REP       " +",KEY138
          MOVE      KEY138,REDIRECT
.
          MOVE      "A",MHHLRTYP               * set Record Type to 'Add'
          CALL      IBACLOCK
          PACK      MHHLMDAT,CCC,CYY,CMM,CDD   * Date
          REP       " 0",MHHLMDAT
          MOVE      CTIMEIS,MHHLMTIM
          MOVE      USERID,MHHLMUID            * Operator
.
          OPEN      MEHAUDHA,"mehaudha"
          PACK      KEY24,MHHLURNO,MHHLMDAT,MHHLMTIM
          CALL      AWMHHL                     * Write Audit Header File
          MOVE      ZERO,EXIT
.
MHREF999  RETURN
+
.-----------------------------------------------------------------------------
.         Get the first code of catg tm with Indic1=1 for Origin of Referral
.-----------------------------------------------------------------------------
GORF0000  MOVE      "tm",KEY2
          PACK      KEY5,KEY2,SP70
          CALL      RDSCODE1
GORF1000  CALL      RDKCODE1
          BRANCH    OVRCD,GORF9999
.
          MATCH     KEY2,TCODE
          GOTO      GORF9999 IF NOT EQUAL
          MATCH     "I",TCINDC1
          GOTO      GORF1000 IF NOT EQUAL
.
          MOVE      ACODE,MHHLOREF             * Origin of Referral
GORF9999  RETURN
+
.-----------------------------------------------------------------------------
.GSREF000 - Get the first code of Cat S ind7=I for Referral Source  *T0852969
.-----------------------------------------------------------------------------
GSREF000  MOVE      "S ",KEY2
          PACK      KEY5,KEY2,SP70
          CALL      RDSCODE1
GSREF100  CALL      RDKCODE1
          BRANCH    OVRCD,GSREF999
.
          MATCH     KEY2,TCODE
          GOTO      GSREF999 IF NOT EQUAL
          MATCH     ANSI,TCINDC7
          GOTO      GSREF100 IF NOT EQUAL
.
          MOVE      ACODE,MHHLSREF             * Source Referral
GSREF999  RETURN
+
.------------------------------------------------------------
. UPMHAD00 - Update Mental Health admission details
.------------------------------------------------------------
.
UPMHAD00  PACK      KEY8,ADMISSNO
          CALL      RDMISS1
          BRANCH    OVRCD,UPMHAD99
.
          MATCH     Z70,MEHVS039
          GOTO      UPMHAD50 IF EQUAL
.
          READ      CONTROLF,HUND05;*208,PTCNSORP
          UNPACK    PTCNSORP,DIM1,DIM1A
          MOVE      DIM1A,F1
          STORE     MEHVS039,F1,AUSR1,AUSR2,AUSR3,AUSR4,AUSR5,AUSR6:
                             AUSR7,PTMIUSR8,PTMIUSR9
          MATCH     "0",DIM1A
          IF        !@EQUAL
            PACK      PTMIUSR0,MEHVS039
          ENDIF
.
          PACK      PTMIWEBU,WBSEUID,SP70
          CALL      UPMISS1
.
.         Get the last transfer, the discharge and the PRA record for the
.         admission prior to sending a message
.
UPMHAD50  BRANCH    ASTAT,UPMHAD60          * pre-admission
.
          PACK      KEY30,AADMNO,TILDA30
          CALL      RDSTRAN2                * position on admission
          CALL      RDPTRAN2                * read previous record
          BRANCH    OVRCD,UPMHAD99          * shouldn't happen
.
          MATCH     AADMNO,TADMN            * same admission still ?
          GOTO      UPMHAD99 IF NOT EQUAL   * no - shouldn't happen
.
UPMHAD60  MOVE      AADMNO,KEY8
          CALL      RDPTRES1                * PRA record on file ?
.
          MOVE      AADMNO,KEY8
          CALL      RDDSCH1                 * discharge record on file ?
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
.
          MOVE      SP8,HL7INCLD
          IF        ASTAT=ONE
            MOVE      THIRTY9,HL7TRGID
            PROC      DGCLICCP
          ELSE
            MOVE      THIRTY2,HL7TRGID
            PROC      DGCLICAC
          ENDIF
.
UPMHAD99  RETURN
+
.------------------------------------------------------------
. PREDET00 - Read Previous Details
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
.
PREDET00  PACK      KEY8,ADMISSNO,SP70
          CALL      RDPTDAD1
          IF        OVRCD=1
            UNPACK    SP70,PTDAADTS,PTDADCTS
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDRESP1
          IF        OVRCD=1
            CALL      CLPATRE1              * Clear PRFA variables
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMVX11                * read the Visit Extension file
          IF        OVRCD=0
            MOVE      PMVXMDAV,SVVXMDAV
            MOVE      PMVXIRAD,SVVXIRAD
            MOVE      PMVXCADM,SVVXCADM
            MOVE      PMVXIDUS,SVVXIDUS
          ENDIF
          CALL      CLRCLM00                * clear claim details
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMWX11                * read workers compensation ext file
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDWCOM1
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDWVET1
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDWMAB1
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMCTC1
.
          MOVE      SP70,SAVCLAIM
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDVISA1
          BRANCH    OVRCD,PREDET50          * No visit go check for booking
.
          MATCH     URNUMBER,PVIURNO
          GOTO      PREDET50 IF NOT EQUAL
.
          BRANCH    PVITYPE,PREDET20,PREDET72,PREDET40
.
          IF        PVITYPE=9
            MATCH     " 2",PVISYST               * AH Referral
            GOTO      PREDET73 IF EQUAL
          ENDIF
          GOTO      PREDET80
.
PREDET20  MOVE      PVIBILL,KEY8
          CALL      RDEMVIS1
          IF        OVRCD=1
            PACK      KEY8,ADMISSNO,SP70
            CALL      RDDETA1             * try aae file
            BRANCH    OVRCD,PREDET93
.
            MOVE      ADACOMP,EMVICOMP
          ELSE
.....       COMPARE   FOUR,EMVISTAT
.....       GOTO      PREDET93 IF EQUAL
          ENDIF
.
          MOVE      EMVICOMP,SAVCLAIM   * Save claim code
.
          PACK      KEY11,EMVIADMN,EMVICOMP,SP70
          CALL      RDPMEXT1
.
          GOTO      PREDET80
.
PREDET40  MOVE      PVIBILL,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,PREDET93
          MOVE      ACLAIM,SAVCLAIM   * Save claim code
          PACK      KEY11,AADMNO,ACLAIM,SP70
          CALL      RDPMEXT1
.
.   Save Transition II extract variables
.
          MOVE      ADATE,SVMIADAT
          MOVE      ATIME,SVMIATIM
          MOVE      ACLSS,SVMICLSS
          MOVE      ACLAIM,SVMIACLM
          MOVE      ASRCE,SVMISRCE
          MOVE      ABWGHT,SVMIBWHT
          MOVE      ACARE,SVMICARE
          MOVE      AVISIT,SVMIVIST
          MOVE      PMVXRHC1,SVMIRFGP
.
          COMPARE   ONE,MHCNUSE
          IF        @EQUAL
            PACK      KEY8,ADMISSNO
            CALL      RDMHVIS1
            IF        OVRCD=1
              CALL      CLMEHVIS
            ENDIF
          ENDIF
.
          MATCH     "030",TEMPLATE         * update admission details
          GOTO      PREDET45 IF EQUAL
.
          MATCH     "30",TEMPLATE         * update admission details
          GOTO      PREDET45 IF EQUAL
          GOTO      PREDET47
.
PREDET45  COMPARE   ONE,ASTAT
          GOTO      PREDET97 IF EQUAL
          COMPARE   FIVE,ASTAT
          GOTO      PREDET97 IF EQUAL
.         CALL      GETNZP00                * Get admission nzpspraf details
.
PREDET47  MATCH     "036",TEMPLATE
          IF        @EQUAL
            IF        ASTAT=ONE | ASTAT=TWO
              PACK      KEY8,ADMISSNO,SP20
              CALL      RDPTELG1          * check for eligibility information
              IF        OVRCD=1
                CALL      CLPATELG
              ENDIF
              GOTO      PREDET48
            ENDIF
            GOTO      PREDET91
          ENDIF
.
          MATCH     "032",TEMPLATE        * update preadmission details
          IF        @EQUAL
            COMPARE   ONE,ASTAT
            GOTO      PREDET92 IF NOT EQUAL
.           CALL      GETNZP00                * Get admission nzpspraf details
          ENDIF
.
PREDET48  CALL      GETNZP00                * Get admission nzpspraf details
          MOVE      AADMNO,BKREBOOK         * Read for Cancel Preadmissions form
          CALL      RDBKREC1
.
          GOTO      PREDET80
.
PREDET50  MOVE      ADMISSNO,BKREBOOK
          CALL      RDBKREC1
          BRANCH    OVRCD,PREDET60
          MOVE      BKRECLMT,SAVCLAIM
.
          CALL      RDBKRX11
.
          IF        SYSTFLAG<>4
            COMPARE   ZERO,BKRESTAT
            GOTO      PREDET94 IF NOT EQUAL
          ENDIF
          COMPARE   ZERO,BKRESTAT
          GOTO      PREDET94 IF NOT EQUAL
.
          CALL      RSETB000                * Set the default booking details
          GOTO      PREDET80
.
PREDET60  IF        SYSTFLAG=4
            GOTO      PREDET80
          ENDIF
.
          MOVE      ADMISSNO,KEY8
          CALL      RDPREA1
          BRANCH    OVRCD,PREDET70
.
          MOVE      ADMISSNO,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,PREDET70
.
          PACK      KEY11,OBAOUTNO,OBACOMP,SP70
          CALL      RDPMEXT1
.
          GOTO      PREDET80
.
PREDET70  MOVE      ADMISSNO,KEY8
          CALL      RDOTRFL1
          BRANCH    OVRCD,PREDET94
          GOTO      PREDET80
.
PREDET72  MOVE      PVIBILL,KEY8
          CALL      RDBOKB1
          IF        OVRCD=0
            MOVE      OBACOMP,SAVCLAIM
          ENDIF
.
          PACK      KEY11,OBAOUTNO,OBACOMP,SP70
          CALL      RDPMEXT1
          GOTO      PREDET80
.
PREDET73  MOVE      ADMISSNO,KEY8
          CALL      RDALREF1
          BRANCH    OVRCD,PREDET94
.
          PACK      KEY11,ALREVISN,ALRECOMP,SP70
          CALL      RDPMEXT1
          GOTO      PREDET80
.
.
.         Validate Claim for Add/Change W/C or TAC claim
.
PREDET80  COMPARE   ONE,REPORTNO
          GOTO      PREDET90 IF NOT EQUAL
          MATCH     "050",TEMPLATE
          IF        @EQUAL
            MOVE      "W",KEY1            * Check for Workers comp claim code
            CALL      VCLM0000
            BRANCH    OVRCD,PREDET95      * must be workers comp claim code
          ENDIF
.
          MATCH     "051",TEMPLATE
          IF        @EQUAL
            MOVE      "M",KEY1            * Check for TAC claim code
            CALL      VCLM0000
            BRANCH    OVRCD,PREDET96      * must be TAC claim code
          ENDIF
.
PREDET90  MOVE      ZERO,EXIT
          GOTO      PREDET99
.
PREDET91  MOVE      "Invalid admission record",WEBTITLE
          CALL      ADMERR00
          MOVE      ONE,EXIT
          GOTO      PREDET99
.
PREDET92  MOVE      "Patient is not pre-admitted",WEBTITLE
          CALL      ADMERR00
          MOVE      ONE,EXIT
          GOTO      PREDET99
.
PREDET93  MOVE      "No Previous details found",WEBTITLE
          CALL      ADMERR00
          MOVE      ONE,EXIT
          GOTO      PREDET99
.
PREDET94  IF        REPORTNO=1
            MATCH     "002",TEMPLATE         * changing master details
            GOTO      PREDET90 IF EQUAL
            MATCH     "005",TEMPLATE         * ACC Claim details       
            GOTO      PREDET90 IF EQUAL
            MATCH     "20",TEMPLATE          * changing contact details
            GOTO      PREDET90 IF EQUAL
            MATCH     "020",TEMPLATE         * changing contact details
            GOTO      PREDET90 IF EQUAL
            MATCH     "22",TEMPLATE          * changing contact details
            GOTO      PREDET90 IF EQUAL
            MATCH     "022",TEMPLATE         * changing contact details
            GOTO      PREDET90 IF EQUAL
            MATCH     "054",TEMPLATE         * Work Capacity details
            GOTO      PREDET90 IF EQUAL  
            MATCH     "056",TEMPLATE         * ACC XML Message Reset/Resubmit
            GOTO      PREDET90 IF EQUAL  
            MATCH     "061",TEMPLATE         * Injury Diagnosis details   
            GOTO      PREDET90 IF EQUAL
            MATCH     "062",TEMPLATE         * Add Injury Diagnosis details   
            GOTO      PREDET90 IF EQUAL
            MATCH     "071",TEMPLATE         * Referral Details
            GOTO      PREDET90 IF EQUAL
            MATCH     "072",TEMPLATE         * Add Referral Details
            GOTO      PREDET90 IF EQUAL
            MATCH     "083",TEMPLATE         * changing master details sup RCH
            GOTO      PREDET90 IF EQUAL
          ENDIF
.
          IF        REPORTNO=6
            MATCH     "1",TEMPLATE           * changing alias details
            GOTO      PREDET90 IF EQUAL
          ENDIF
.
          MOVE      "Invalid Booking Status",WEBTITLE
          CALL      ADMERR00
          MOVE      ONE,EXIT
          GOTO      PREDET99
.
PREDET95  MOVE      "Not a Wokers Comp.Claim Code.",WEBTITLE
          CALL      ADMERR00
          MOVE      ONE,EXIT
          GOTO      PREDET99
.
PREDET96  MOVE      "Not a TAC Claim Code.",WEBTITLE
          CALL      ADMERR00
          MOVE      ONE,EXIT
          GOTO      PREDET99
.
PREDET97  MOVE      "Patient is not currently admitted",WEBTITLE
          CALL      ADMERR00
          MOVE      ONE,EXIT
          GOTO      PREDET99
.
PREDET99  RETURN
+
.------------------------------------------------------------
.         Validate claim code
.------------------------------------------------------------
VCLM0000  MATCH     SP70,SAVCLAIM
          GOTO      VCLM9200 IF EQUAL
.
          PACK      KEY5,CODECL,SAVCLAIM
p
          CALL      RDCODE1
          BRANCH    OVRCD,VCLM9200
.
.         Check the indicators for a W, M, or V (these are the claims)
.
          MOVE      ZERO,FORM2
VCLM1000  ADD       ONE,FORM2
          COMPARE   SIX,FORM2
          GOTO      VCLM9200 IF NOT LESS
.
          LOAD      ANS,FORM2,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
.
          CMATCH    KEY1,ANS
          GOTO      VCLM9000 IF EQUAL
          GOTO      VCLM1000
.
VCLM9000  MOVE      ZERO,OVRCD
          GOTO      VCLM9999
.
VCLM9200  MOVE      ONE,OVRCD
VCLM9999  RETURN
+
.------------------------------------------------------------
. PREFOR00 - Display Pre-admission Form
. Returns:    EXIT   0 = Ok to continue
.                    1 = Error
.------------------------------------------------------------
.
PREFOR00  CLEAR     WEBTITLE
          APPEND    PGNAME,WEBTITLE
          APPEND    PSNAME,WEBTITLE
          APPEND    "(New Pre-Admission)",WEBTITLE
          APPEND    SP70,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,PREFOR91
.
          CALL      WEBBOD00
          IF        MRGEFLAG=1
            CALL      MRGALT00
          ENDIF
          CALL      WEBEND00
.
          MOVE      ZERO,EXIT
          GOTO      PREFOR99
.
PREFOR91  MOVE      ONE,EXIT
.
PREFOR99  RETURN
+
.------------------------------------------------------------
. MRGALT00 - Alert that this is a merged U/R
.------------------------------------------------------------
.
MRGALT00  MATCH     SP70,URNUMBER
          GOTO      MRGALT99 IF EQUAL
.
          MATCH     SP70,SAVEURNO
          GOTO      MRGALT99 IF EQUAL
.
          MATCH     "1",VINAHUPD
          IF        @EQUAL
            WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                              " alert('Warning : U/R Number ",URNUMBER:
                              " is merged with ",SAVEURNO,".');":
                               "}":
                               "</script>"
            GOTO      MRGALT99
          ENDIF
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             " alert('U/R Number ",SAVEURNO," is merged with ":
                             URNUMBER,".\nUsing ",URNUMBER,".');":
                             "}":
                             "</script>"
          GOTO      MRGALT99
.
MRGALT99  RETURN
+
.------------------------------------------------------------
. CLRCLM00 - Clear Claim Details
.------------------------------------------------------------
.
CLRCLM00  MOVE      SP70,WCENAME
          MOVE      SP70,WCEADD1
          MOVE      SP70,WCEADD2
          MOVE      SP70,WCEADD3
          MOVE      SP70,WCEADD4
          MOVE      SP70,WCEPOST
          MOVE      SP70,WCETELE
          MOVE      SP70,WCACDAT
          MOVE      SP70,WCACCPT
          MOVE      SP70,WCICODE
          MOVE      SP70,WCCLMNO
.
          MOVE      SP70,VCLMNO
.
          MOVE      SP70,PTWVAUTH
          MOVE      SP70,PTWVDATE
.
          MOVE      ZERO,PTWMTACF
          MOVE      SP70,PTWMTYPE
          MOVE      SP70,PTWMICDE                                   * Car 273294
          MOVE      SP70,MREFNO
          MOVE      SP70,MACDAT
          MOVE      SP70,MPOLIC
          MOVE      SP70,MCREGO
          MOVE      SP70,MOTHDET1
          MOVE      SP70,MOTHDET2
          MOVE      SP70,MOTHDET3
          MOVE      SP70,MMDTRANS
          MOVE      SP70,MENGAGED
          MOVE      SP70,MPINJURE
          MOVE      SP70,MMECHSEV
          MOVE      SP70,MREGNSEV
          MOVE      SP70,MSNAME
          MOVE      SP70,MSTELE
          MOVE      SP70,MACLOC
          MOVE      SP70,PMWXVISN           * Visit Number
          MOVE      SP70,PMWXALOC           * Accident Location
          MOVE      SP70,PMWXCINJ           * of Injury (Cat IK)
          MOVE      SP70,PMWXICOD           * Injury Code (Cat IJ)
          MOVE      SP70,PMWXCNAM           * Contact Name
          MOVE      SP70,PMWXCDTE           * Date Record Created (ccyymmdd)
          MOVE      SP70,PMWXCTIM           * Time Record Created (hh:mm:ss)
          MOVE      SP70,PMWXWEBC           * WEB User Id rec. creator(websecaf)
          MOVE      SP70,PMWXLUPD           * Last Update Date (ccyymmdd)
          MOVE      SP70,PMWXLUPT           * Last Update Time (hh:mm:ss)
          MOVE      SP70,PMWXWEBU           * WEB User Id rec. updater(websecaf)
          MOVE      SP70,PMWXACCF           * Work Related (Cat IQ)
          MOVE      SP70,PMWXPLIN           * Place Injury Occurred (Cat IP)
          MOVE      SP70,PMWXACTI           * Activity When Injured (Cat IO)
          MOVE      SP70,PMWXADTE           * ACC Decline Date (ccyymmdd)
          MOVE      SP70,PMWXATME           * Accident Time (hh:mm:ss)
          MOVE      SP70,PMWXACLC           * Accident Location
          MOVE      SP70,PMWXAINZ           * Accident in NZ?
          MOVE      SP70,PMWXMOVV           * Involves moving vehicle
          MOVE      SP70,PMWXSPTI           * Sporting Injury Y/N
          MOVE      SP70,PMWXSPRT           * Sport Name
          MOVE      SP70,PMWXRECI           * Recurring Injury Indicator
          MOVE      SP70,PMWXTRIC           * Treatment Injury Claim Y/N
          MOVE      SP70,PMWXESTA           * Employment Status
          MOVE      SP70,PMWXPDDT           * Patient Declaration Date
          MOVE      SP70,PMWXARG1           * Authorised Rep. Given Name1
          MOVE      SP70,PMWXARG2           * Authorised Rep. Given Name2
          MOVE      SP70,PMWXARSN           * Authorised Rep. Surname
          MOVE      SP70,PMWXARTL           * Authorised Rep. Title
          MOVE      SP70,PMWXARRP           * Authorised Rep. Relation
          MOVE      SP70,PMWXASST           * Assistance Required Indicator
          MOVE      SP70,PMWXNEED           * Need to call HP Indicator
          MOVE      SP70,PMWXCONT           * Continue Normal Hrs of Work
          MOVE      SP70,PMWXALTW           * Alternative Work Indicator
          MOVE      SP70,PMWXTYPA           * Type of Alternative Work
          MOVE      SP70,PMWXSALT           * Start Date of Alt Work
          MOVE      SP70,PMWXHPDA           * Hrs per day of Alt Work
          MOVE      SP70,PMWXUNFD           * Unfit for Work Duration
          MOVE      SP70,PMWXUNFT           * Unfit for Work Type
          MOVE      SP70,PMWXFISD           * Full Incapacity Start Date
          MOVE      SP70,PMWXRNWD           * Return to Normal Work Date
          MOVE      SP70,PMWXCSTA           * Claim Status
          MOVE      SP70,PMWXTWRK           * Type of Work
          MOVE      SP70,PMWXOEST           * Other Employment Status
          MOVE      SP70,PMWXTPRO           * HDP Treatment Provider
          MOVE      SP70,PMWXECOD           * Employer Code
          MOVE      SP70,PMWXGRAD           * Gradual process injury
          MOVE      SP70,PMWXAHOS           * Admitted to hosp
          MOVE      SP70,PMWXVCON           * Verbal consent  
          MOVE      SP70,PMWXAPPR           * Approval HCP
          MOVE      SP70,PMWXPORD           * Purchase order number
          MOVE      SP70,PMWXSPAR           * Spare Variable
          MOVE      SP70,PMCTADMN           * Admission Number
          MOVE      SP70,PMCTURNO           * U/R Number
          MOVE      SP70,PMCTVDAT           * Visit Date
          MOVE      SP70,PMCTSNAM           * Solicitor's name
          MOVE      SP70,PMCTSAD1           * Solicitor's address line 1
          MOVE      SP70,PMCTSAD2           * Solicitor's address line 2
          MOVE      SP70,PMCTSAD3           * Solicitor's address line 3
          MOVE      SP70,PMCTSAD4           * Solicitor's address line 4
          MOVE      SP70,PMCTSPCO           * Solicitor's postcode
          MOVE      SP70,PMCTSPHN           * Solicitor's phone number
          MOVE      SP70,PMCTCONT           * Contact Name
          MOVE      SP70,PMCTREFN           * Reference Number
          MOVE      SP70,PMWXVHCP           * Verbal Consent Gained By HCP
.
          CALL      CLPMSEXT                * Defence force
.
CLRCLM99  RETURN
+
.------------------------------------------------------------
. CLMISV00 - Clear admission variables
.------------------------------------------------------------
.
CLMISV00  CALL      CLPATMIS               * Clear admission variables
          MOVE      SP70,MBSDESC           * clear mbs description
          MOVE      SP70,PTDWDESC          * clear drg description
.
CLMISV99  RETURN
+
.------------------------------------------------------------
. SPMAS000 - Set Parameters for Master Details
. Returns:    EXIT   0
.                    1
.------------------------------------------------------------
.
SPMAS000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SPMAS010,SPMAS020,SPMAS030,SPMAS040,SPMAS050:
                       SPMAS060,SPMAS070,SPMAS080,SPMAS090,SPMAS100:
                       SPMAS110,SPMAS120,SPMAS130,SPMAS140,SPMAS150:
                       SPMAS160,SPMAS170,SPMAS180,SPMAS190,SPMAS200:
                       SPMAS210,SPMAS220,SPMAS230,SPMAS240,SPMAS250:
                       SPMAS260,SPMAS270,SPMAS280,SPMAS290,SPMAS300:
                       SPMAS310,SPMAS320,SPMAS330,SPMAS340,SPMAS350:
                       SPMAS360,SPMAS370,SPMAS380,SPMAS390,SPMAS400:
                       SPMAS410,SPMAS420,SPMAS430,SPMAS440,SPMAS450:
                       SPMAS460,SPMAS470,SPMAS480,SPMAS490,SPMAS500:
                       SPMAS510,SPMAS520,SPMAS530,SPMAS540,SPMAS550:
                       SPMAS560,SPMAS570,SPMAS580,SPMAS590,SPMAS600:
                       SPMAS610,SPMAS620,SPMAS630,SPMAS640,SPMAS650:
                       SPMAS660,SPMAS670,SPMAS680,SPMAS690,SPMAS700:
                       SPMAS710,SPMAS720,SPMAS730,SPMAS740,SPMAS750:
                       SPMAS760,SPMAS770,SPMAS780,SPMAS790,SPMAS800:
                       SPMAS810,SPMAS820,SPMAS830,SPMAS840,SPMAS850:
                       SPMAS860,SPMAS870
.
          GOTO      SPMAS910

SPMAS010  MOVE      QRYDATA,PTMAS001
          MOVE      ONE,CHGUR
          GOTO      SPMAS900
.
SPMAS020  MOVE      QRYDATA,PTMAS002
          GOTO      SPMAS900
.
SPMAS030  MOVE      QRYDATA,PTMAS003
          GOTO      SPMAS900
.
SPMAS040  MOVE      QRYDATA,PTMAS004
          GOTO      SPMAS900
.
SPMAS050  PACK      PTMAS005,QRYDATA,SP70
          MOVE      ONE,CHGUR
          GOTO      SPMAS900
.
SPMAS060  PACK      PTMAS006,QRYDATA,SP70
          MOVE      ONE,CHGUR
          GOTO      SPMAS900
.
SPMAS070  PACK      PTMAS007,QRYDATA,SP70
          GOTO      SPMAS900
.
SPMAS080  PACK      PTMAS008,QRYDATA,SP70
          MOVE      ONE,CHGUR
          GOTO      SPMAS900
.
SPMAS090  PACK      PTMAS009,QRYDATA,SP70
          MOVE      ONE,CHGUR
          GOTO      SPMAS900
.
SPMAS100  PACK      PTMAS010,QRYDATA,SP70
          MOVE      ONE,CHGUR
          GOTO      SPMAS900
.
SPMAS110  PACK      PTMAS011,QRYDATA,SP70
          MOVE      ONE,CHGUR
          GOTO      SPMAS900
.
SPMAS120  PACK      PTMAS012,QRYDATA,SP70
          MOVE      ONE,CHGUR
          GOTO      SPMAS900
.
SPMAS130  PACK      PTMAS013,QRYDATA,SP70
          MOVE      ONE,CHGUR
          GOTO      SPMAS900
.
SPMAS140  PACK      PTMAS014,QRYDATA,SP70
          MOVE      ONE,CHGUR
          GOTO      SPMAS900
.
SPMAS150  PACK      PTMAS015,QRYDATA,SP70
          MOVE      ONE,CHGUR
          GOTO      SPMAS900
.
SPMAS160  PACK      PTMAS016,QRYDATA,SP70
          GOTO      SPMAS900
.
SPMAS170  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00            * Set CMON from MTHNAM3
          PACK      PTMAS017,CCENT,CYEAR,CMON,CDAY
          GOTO      SPMAS900
.
SPMAS180  MOVE      QRYDATA,PTMAS018
          MOVE      ONE,CHGUR
          GOTO      SPMAS900
.
SPMAS190  PACK      PTMAS019,QRYDATA,SP70
          GOTO      SPMAS900
.
SPMAS200  PACK      PTMAS020,QRYDATA,SP70
          GOTO      SPMAS900
.
SPMAS210  PACK      PTMAS021,QRYDATA,SP70
          GOTO      SPMAS900
.
SPMAS220  PACK      PTMAS022,QRYDATA,SP70
          GOTO      SPMAS900
.
SPMAS230  PACK      PTMAS023,QRYDATA,SP70
          GOTO      SPMAS900
.
SPMAS240  PACK      PTMAS024,QRYDATA,SP70
          GOTO      SPMAS900
.
SPMAS250  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00            * Set CMON from MTHNAM3
          PACK      PTMAS025,CCENT,CYEAR,CMON
          GOTO      SPMAS900
.
SPMAS260  PACK      PTMAS026,QRYDATA,SP70
          GOTO      SPMAS900
.
SPMAS270  MOVE      QRYDATA,PTMAS027
          GOTO      SPMAS900
.
SPMAS280  PACK      PTMAS028,QRYDATA,SP70
          GOTO      SPMAS900
.
SPMAS290  MOVE      QRYDATA,PTMAS029
          GOTO      SPMAS900
.
SPMAS300  MOVE      QRYDATA,PTMAS030
          GOTO      SPMAS900
.
SPMAS310  MOVE      QRYDATA,PTMAS031
          GOTO      SPMAS900
.
SPMAS320  PACK      PTMAS032,QRYDATA,SP70
          GOTO      SPMAS900
.
SPMAS330  PACK      PTMAS033,QRYDATA,SP70
          GOTO      SPMAS900
.
SPMAS340  PACK      PTMAS034,QRYDATA,SP70
          GOTO      SPMAS900
.
SPMAS350  PACK      PTMAS035,QRYDATA,SP70
          GOTO      SPMAS900
.
SPMAS360  PACK      PTMAS036,QRYDATA,SP70
          GOTO      SPMAS900
.
SPMAS370  PACK      PTMAS037,QRYDATA,SP70
          GOTO      SPMAS900
.
SPMAS380  PACK      PTMAS038,QRYDATA,SP70
          GOTO      SPMAS900
.
SPMAS390  PACK      PTMAS039,QRYDATA,SP70
          GOTO      SPMAS900
.
SPMAS400  PACK      PTMAS040,QRYDATA,SP70
          GOTO      SPMAS900
.
SPMAS410  PACK      PTMAS041,QRYDATA,SP70
          GOTO      SPMAS900
.
SPMAS420  PACK      PTMAS042,QRYDATA,SP70
          GOTO      SPMAS900
.
SPMAS430  PACK      PTMAS043,QRYDATA,SP70
          GOTO      SPMAS900
.
SPMAS440  PACK      PTMAS044,QRYDATA,SP70
          GOTO      SPMAS900
.
SPMAS450  MOVE      QRYDATA,PTMAS045
          GOTO      SPMAS900
.
SPMAS460  MOVE      QRYDATA,PTMAS046
          GOTO      SPMAS900
.
SPMAS470  MOVE      QRYDATA,PTMAS047
          GOTO      SPMAS900
.
SPMAS480  MOVE      QRYDATA,PTMAS048
          GOTO      SPMAS900
.
SPMAS490  PACK      PTMAS049,QRYDATA,SP70
          MOVE      ONE,PTCUPDFL
          GOTO      SPMAS900
.
SPMAS500  PACK      PTMAS050,QRYDATA,SP70
          MOVE      ONE,PTCUPDFL
          GOTO      SPMAS900
.
SPMAS510  PACK      PTMAS051,QRYDATA,SP70
          MOVE      ONE,PTCUPDFL
          GOTO      SPMAS900
.
SPMAS520  PACK      PTMAS052,QRYDATA,SP70
          MOVE      ONE,PTCUPDFL
          GOTO      SPMAS900
.
SPMAS530  PACK      PTMAS053,QRYDATA,SP70
          MOVE      ONE,PTCUPDFL
          GOTO      SPMAS900
.
SPMAS540  PACK      PTMAS054,QRYDATA,SP70
          MOVE      ONE,PTCUPDFL
          GOTO      SPMAS900
.
SPMAS550  PACK      PTMAS055,QRYDATA,SP70
          MOVE      ONE,PTCUPDFL
          GOTO      SPMAS900
.
SPMAS560  PACK      PTMAS056,QRYDATA,SP70
          MOVE      ONE,PTCUPDFL
          GOTO      SPMAS900
.
SPMAS570  PACK      PTMAS057,QRYDATA,SP70
          MOVE      ONE,PTCUPDFL
          GOTO      SPMAS900
.
SPMAS580  MOVE      QRYDATA,PTMAS058
          GOTO      SPMAS900
.
SPMAS590  PACK      PTMAS059,QRYDATA,SP70
          GOTO      SPMAS900
.
SPMAS600  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00            * Set CMON from MTHNAM3
          PACK      PTMAS060,CCENT,CYEAR,CMON,CDAY
          GOTO      SPMAS900
.
SPMAS610  PACK      PTMAS061,SP70
          MATCH     SP70,QRYDATA
          GOTO      SPMAS900 IF EQUAL
          GOTO      SPMAS900 IF EOS
.
          UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00            * Set CMON from MTHNAM3
          PACK      PTMAS061,CCENT,CYEAR,CMON,CDAY
          GOTO      SPMAS900
.
SPMAS620  PACK      PTMAS062,QRYDATA,SP70
          GOTO      SPMAS900
.
SPMAS630  PACK      PTMAS063,QRYDATA,SP70
          GOTO      SPMAS900
.
SPMAS640  PACK      PTMAS064,QRYDATA,SP70
          GOTO      SPMAS900
.
SPMAS650  PACK      PTMAS065,QRYDATA,SP70
          GOTO      SPMAS900
.
SPMAS660  PACK      PTMAS066,QRYDATA,SP70
          GOTO      SPMAS900
.
SPMAS670  PACK      PTMAS067,QRYDATA,SP70
          GOTO      SPMAS900
.
SPMAS680  PACK      PTMAS068,QRYDATA,SP70
          GOTO      SPMAS900
.
SPMAS690  MATCH     SP70,QRYDATA
          GOTO      SPMAS900 IF EQUAL
          GOTO      SPMAS900 IF EOS
.
          UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00            * Set CMON from MTHNAM3
          PACK      PTMAS069,CCENT,CYEAR,CMON,CDAY
          GOTO      SPMAS900
.
SPMAS700  PACK      PTMAS070,QRYDATA,SP70
          GOTO      SPMAS900
.
SPMAS710  PACK      PTMAS071,QRYDATA,SP70
          GOTO      SPMAS900
.
SPMAS720  PACK      PTMAS072,QRYDATA,SP70
          GOTO      SPMAS900
.
SPMAS730  PACK      PTMAS073,QRYDATA,SP70
          GOTO      SPMAS900
.
SPMAS740  PACK      PTMAS074,QRYDATA,SP70
          GOTO      SPMAS900
.
SPMAS750  PACK      PTMAS075,QRYDATA,SP70
          GOTO      SPMAS900
.
SPMAS760  PACK      PTMAS076,QRYDATA,SP70
          GOTO      SPMAS900
.
SPMAS770  PACK      PTMAS077,QRYDATA,SP70
          GOTO      SPMAS900
.
SPMAS780  PACK      PTMAS078,QRYDATA,SP70
          GOTO      SPMAS900
.
SPMAS790  PACK      PTMAS079,QRYDATA,SP70
          GOTO      SPMAS900
.
SPMAS800  PACK      PTMAS080,QRYDATA,SP70
          GOTO      SPMAS900
.
SPMAS810  PACK      PTMAS081,QRYDATA,SP70
          GOTO      SPMAS900
.
SPMAS820  PACK      PTMAS082,QRYDATA,SP70
          GOTO      SPMAS900
.
SPMAS830  PACK      PTMAS083,QRYDATA,SP70
          GOTO      SPMAS900
.
SPMAS840  PACK      PTMAS084,QRYDATA,SP70
          GOTO      SPMAS900
.
SPMAS850  PACK      PTMAS085,QRYDATA,SP70
          GOTO      SPMAS900
.
SPMAS860  PACK      PTMAS086,QRYDATA,SP70
          GOTO      SPMAS900
.
SPMAS870  PACK      PTMAS087,QRYDATA,SP70
          GOTO      SPMAS900
.
.
SPMAS900  MOVE      ONE,MASUPDFL
          MOVE      ZERO,EXIT
          GOTO      SPMAS999
.
SPMAS910  MOVE      ONE,EXIT
.
SPMAS999  RETURN
+
.------------------------------------------------------------
. SPMSX000 - Set Parameters for Master Extension Details
. Returns:    EXIT   0
.                    1
.------------------------------------------------------------
.
SPMSX000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SPMSX010,SPMSX020,SPMSX030,SPMSX040,SPMSX050:
                       SPMSX060,SPMSX070,SPMSX080,SPMSX090,SPMSX100:
                       SPMSX110,SPMSX120,SPMSX130,SPMSX140,SPMSX150:
                       SPMSX160,SPMSX170,SPMSX180,SPMSX190,SPMSX200:
                       SPMSX210,SPMSX220,SPMSX230,SPMSX240,SPMSX250:
                       SPMSX260,SPMSX270,SPMSX280,SPMSX290,SPMSX300:
                       SPMSX310,SPMSX320,SPMSX330,SPMSX340,SPMSX350:
                       SPMSX360,SPMSX370,SPMSX380,SPMSX390,SPMSX400:
                       SPMSX410,SPMSX420,SPMSX430,SPMSX440,SPMSX450:
                       SPMSX460,SPMSX470,SPMSX480,SPMSX490,SPMSX500:
                       SPMSX510,SPMSX520
.
          GOTO      SPMSX910
.
SPMSX010  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00            * Set CMON from MTHNAM3
          PACK      PTMSX001,CCENT,CYEAR,CMON,CDAY
          GOTO      SPMSX900
.
SPMSX020  MOVE      QRYDATA,PTMSX002
          GOTO      SPMSX900
.
SPMSX030  MOVE      QRYDATA,PTMSX003
          GOTO      SPMSX900
.
SPMSX040  MOVE      QRYDATA,PTMSX004
          GOTO      SPMSX900
.
SPMSX050  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00            * Set CMON from MTHNAM3
          PACK      PTMSX005,CCENT,CYEAR,CMON,CDAY
          GOTO      SPMSX900
.
SPMSX060  MOVE      QRYDATA,PTMSX006
          GOTO      SPMSX900
.
SPMSX070  MOVE      QRYDATA,PTMSX007
          GOTO      SPMSX900
.
SPMSX080  MOVE      QRYDATA,PTMSX008
          GOTO      SPMSX900
.
SPMSX090  MOVE      QRYDATA,PTMSX009
          GOTO      SPMSX900
.
SPMSX100  MOVE      QRYDATA,PTMSX010
          GOTO      SPMSX900
.
SPMSX110  MOVE      QRYDATA,PTMSX011
          GOTO      SPMSX900
.
SPMSX120  MOVE      QRYDATA,PTMSX012
          GOTO      SPMSX900
.
SPMSX130  MOVE      QRYDATA,PTMSX013
          GOTO      SPMSX900
.
SPMSX140  MOVE      QRYDATA,PTMSX014
          GOTO      SPMSX900
.
SPMSX150  MOVE      QRYDATA,PTMSX015
          GOTO      SPMSX900
.
SPMSX160  MOVE      QRYDATA,PTMSX016
          GOTO      SPMSX900
.
SPMSX170  MOVE      QRYDATA,PTMSX017
          GOTO      SPMSX900
.
SPMSX180  MOVE      QRYDATA,PTMSX018
          GOTO      SPMSX900
.
SPMSX190  MOVE      QRYDATA,PTMSX019
          GOTO      SPMSX900
.
SPMSX200  MOVE      QRYDATA,PTMSX020
          GOTO      SPMSX900
.
SPMSX210  MOVE      QRYDATA,PTMSX021
          GOTO      SPMSX900
.
SPMSX220  MOVE      QRYDATA,PTMSX022
          GOTO      SPMSX900
.
SPMSX230  MOVE      QRYDATA,PTMSX023
          GOTO      SPMSX900
.
SPMSX240  MOVE      QRYDATA,PTMSX024
          GOTO      SPMSX900
.
SPMSX250  MOVE      QRYDATA,PTMSX025
          GOTO      SPMSX900
.
SPMSX260  MOVE      QRYDATA,PTMSX026
          GOTO      SPMSX900
.
SPMSX270  MOVE      QRYDATA,PTMSX027
          GOTO      SPMSX900
.
SPMSX280  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00            * Set CMON from MTHNAM3
          PACK      PTMSX028,CCENT,CYEAR,CMON,CDAY
          GOTO      SPMSX900
.
SPMSX290  MOVE      QRYDATA,PTMSX029
          GOTO      SPMSX900
.
SPMSX300  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00            * Set CMON from MTHNAM3
          PACK      PTMSX030,CCENT,CYEAR,CMON,CDAY
          GOTO      SPMSX900
.
SPMSX310  MOVE      QRYDATA,PTMSX031
          GOTO      SPMSX900
.
SPMSX320  MOVE      QRYDATA,PTMSX032
          GOTO      SPMSX900
.
SPMSX330  MOVE      QRYDATA,PTMSX033
          GOTO      SPMSX900
.
SPMSX340  MOVE      QRYDATA,PTMSX034
          MOVE      ONE,CHGCGP
          GOTO      SPMSX900
.
SPMSX350  MOVE      QRYDATA,PTMSX035
          MOVE      ONE,CHGCGP
          GOTO      SPMSX900
.
SPMSX360  MOVE      QRYDATA,PTMSX036
          GOTO      SPMSX900
.
SPMSX370  MOVE      QRYDATA,PTMSX037
          MOVE      ONE,CHGCGP
          GOTO      SPMSX900
.
SPMSX380  MOVE      QRYDATA,PTMSX038
          GOTO      SPMSX900
.
SPMSX390  MOVE      QRYDATA,PTMSX039
          GOTO      SPMSX900
.
SPMSX400  MOVE      QRYDATA,PTMSX040
          GOTO      SPMSX900
.
SPMSX410  MOVE      QRYDATA,PTMSX041
          GOTO      SPMSX900
.
SPMSX420  MOVE      QRYDATA,PTMSX042
          GOTO      SPMSX900
.
SPMSX430  MOVE      QRYDATA,PTMSX043
          GOTO      SPMSX900
.
SPMSX440  MOVE      QRYDATA,PTMSX044
          GOTO      SPMSX900
.
SPMSX450  MOVE      QRYDATA,PTMSX045
          GOTO      SPMSX900
.
SPMSX460  MOVE      QRYDATA,PTMSX046
          GOTO      SPMSX900
.
SPMSX470  MOVE      QRYDATA,PTMSX047
          GOTO      SPMSX900
.
SPMSX480  MOVE      QRYDATA,PTMSX048
          GOTO      SPMSX900
.
SPMSX490  MOVE      QRYDATA,PTMSX049
          GOTO      SPMSX900
.
SPMSX500  MOVE      QRYDATA,PTMSX050
          GOTO      SPMSX900
.
SPMSX510  MOVE      QRYDATA,PTMSX051
          GOTO      SPMSX900
.
SPMSX520  PACK      PTMSX052,QRYDATA,SP70
          GOTO      SPMSX900
.
.
SPMSX900  MOVE      ONE,MASUPDFL
          MOVE      ZERO,EXIT
          GOTO      SPMSX999
.
SPMSX910  MOVE      ONE,EXIT
.
SPMSX999  RETURN
+
.************************************************************
. SPVIS000 - Set Parameters for Visit Extension File
. Returns:    EXIT   0
.                    1
.************************************************************
.
SPVIS000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SPVIS998,SPVIS998,SPVIS998,SPVIS998,SPVIS998:
                       SPVIS998,SPVIS998,SPVIS998,SPVIS998,SPVIS998:
                       SPVIS998,SPVIS998,SPVIS998,SPVIS998,SPVIS150:
                       SPVIS160,SPVIS170,SPVIS180,SPVIS190,SPVIS200:
                       SPVIS210,SPVIS220,SPVIS230,SPVIS240,SPVIS250:
                       SPVIS260,SPVIS270,SPVIS280,SPVIS290,SPVIS300:
                       SPVIS310,SPVIS320,SPVIS330,SPVIS340,SPVIS350:
                       SPVIS360,SPVIS370,SPVIS380,SPVIS390,SPVIS400:
                       SPVIS410,SPVIS420,SPVIS430,SPVIS440,SPVIS450:
                       SPVIS460,SPVIS470,SPVIS480,SPVIS490,SPVIS500:
                       SPVIS510,SPVIS520,SPVIS530,SPVIS540,SPVIS550:
                       SPVIS560,SPVIS570,SPVIS580,SPVIS590,SPVIS600:
                       SPVIS610,SPVIS620,SPVIS630,SPVIS640,SPVIS650:
                       SPVIS660,SPVIS670,SPVIS680,SPVIS690,SPVIS700:
                       SPVIS710,SPVIS720,SPVIS730,SPVIS740,SPVIS750:
                       SPVIS760,SPVIS770,SPVIS780,SPVIS790,SPVIS800:
                       SPVIS810,SPVIS820,SPVIS830,SPVIS840,SPVIS850:
                       SPVIS860,SPVIS870,SPVIS880,SPVIS890,SPVIS900:
                       SPVIS910,SPVIS920,SPVIS930,SPVIS940,SPVIS950:
                       SPVIS960,SPVIS970,SPVIS980,SPVIS990,SPVI1000:
                       SPVI1100,SPVI1200,SPVI1300,SPVI1400,SPVI1500:
                       SPVI1600,SPVI1700,SPVI1800,SPVI1900,SPVI2000:
                       SPVI2100,SPVI2200,SPVI2300,SPVI2400,SPVI2500:
                       SPVI2600,SPVI2700,SPVI2800,SPVI2900,SPVI2000:
                       SPVI3100,SPVI3200,SPVI3300,SPVI3400,SPVI3500:
                       SPVI3600,SPVI3700,SPVI3800,SPVI3900,SPVI4000:
                       SPVI4100,SPVI4200,SPVI4300,SPVI4400,SPVI4500:
                       SPVI4600,SPVI4700,SPVI4800
          GOTO      SPVIS995
.
SPVIS150  MOVE      QRYDATA,PTVIS015
          GOTO      SPVIS998
.
SPVIS160  MOVE      QRYDATA,PTVIS016
          GOTO      SPVIS998
.
SPVIS170  MOVE      QRYDATA,PTVIS017
          GOTO      SPVIS998
.
SPVIS180  MOVE      QRYDATA,PTVIS018
          GOTO      SPVIS998
.
SPVIS190  MOVE      QRYDATA,PTVIS019
          GOTO      SPVIS998
.
SPVIS200  MOVE      QRYDATA,PTVIS020
          GOTO      SPVIS998
.
SPVIS210  MOVE      QRYDATA,PTVIS021
          GOTO      SPVIS998
.
SPVIS220  MOVE      QRYDATA,PTVIS022
          GOTO      SPVIS998
.
SPVIS230  MOVE      QRYDATA,PTVIS023
          GOTO      SPVIS998
.
SPVIS240  MOVE      QRYDATA,PTVIS024
          GOTO      SPVIS998
.
SPVIS250  MOVE      QRYDATA,PTVIS025
          GOTO      SPVIS998
.
SPVIS260  MOVE      QRYDATA,PTVIS026
          GOTO      SPVIS998
.
SPVIS270  MOVE      QRYDATA,PTVIS027
          GOTO      SPVIS998
.
SPVIS280  MOVE      QRYDATA,PTVIS028
          GOTO      SPVIS998
.
SPVIS290  MOVE      QRYDATA,PTVIS029
          GOTO      SPVIS998
.
SPVIS300  MOVE      QRYDATA,PTVIS030
          GOTO      SPVIS998
.
SPVIS310  MOVE      QRYDATA,PTVIS031
          GOTO      SPVIS998
.
SPVIS320  MOVE      QRYDATA,PTVIS032
          GOTO      SPVIS998
.
SPVIS330  MOVE      QRYDATA,PTVIS033
          GOTO      SPVIS998
.
SPVIS340  MOVE      QRYDATA,PTVIS034
          GOTO      SPVIS998
.
SPVIS350  MOVE      QRYDATA,PTVIS035
          GOTO      SPVIS998
.
SPVIS360  MOVE      QRYDATA,PTVIS036
          GOTO      SPVIS998
.
SPVIS370  MOVE      QRYDATA,PTVIS037
          GOTO      SPVIS998
.
SPVIS380  MOVE      QRYDATA,PTVIS038
          GOTO      SPVIS998
.
SPVIS390  MOVE      QRYDATA,PTVIS039
          GOTO      SPVIS998
.
SPVIS400  MOVE      QRYDATA,PTVIS040
          GOTO      SPVIS998
.
SPVIS410  MOVE      QRYDATA,PTVIS041
          GOTO      SPVIS998
.
SPVIS420  MOVE      QRYDATA,PTVIS042
          GOTO      SPVIS998
.
SPVIS430  MOVE      QRYDATA,PTVIS043
          GOTO      SPVIS998
.
SPVIS440  MOVE      QRYDATA,PTVIS044
          GOTO      SPVIS998
.
SPVIS450  MOVE      QRYDATA,PTVIS045
          GOTO      SPVIS998
.
SPVIS460  MOVE      QRYDATA,PTVIS046
          GOTO      SPVIS998
.
SPVIS470  MOVE      QRYDATA,PTVIS047
          GOTO      SPVIS998
.
SPVIS480  MOVE      QRYDATA,PTVIS048
          GOTO      SPVIS998
.
SPVIS490  MOVE      QRYDATA,PTVIS049
          GOTO      SPVIS998
.
SPVIS500  MOVE      QRYDATA,PTVIS050
          GOTO      SPVIS998
.
SPVIS510  MOVE      QRYDATA,PTVIS051
          GOTO      SPVIS998
.
SPVIS520  MOVE      QRYDATA,PTVIS052
          GOTO      SPVIS998
.
SPVIS530  MOVE      QRYDATA,PTVIS053
          GOTO      SPVIS998
.
SPVIS540  MOVE      QRYDATA,PTVIS054
          GOTO      SPVIS998
.
SPVIS550  MOVE      QRYDATA,PTVIS055
          GOTO      SPVIS998
.
SPVIS560  MOVE      QRYDATA,PTVIS056
          GOTO      SPVIS998
.
SPVIS570  MOVE      QRYDATA,PTVIS057
          GOTO      SPVIS998
.
SPVIS580  MOVE      QRYDATA,PTVIS058
          GOTO      SPVIS998
.
SPVIS590  MOVE      QRYDATA,PTVIS059
          GOTO      SPVIS998
.
SPVIS600  MOVE      QRYDATA,PTVIS060
          GOTO      SPVIS998
.
SPVIS610  MOVE      QRYDATA,PTVIS061
          GOTO      SPVIS998
.
SPVIS620  MOVE      QRYDATA,PTVIS062
          GOTO      SPVIS998
.
SPVIS630  MOVE      QRYDATA,PTVIS063
          GOTO      SPVIS998
.
SPVIS640  MOVE      QRYDATA,PTVIS064
          GOTO      SPVIS998
.
SPVIS650  MOVE      QRYDATA,PTVIS065
          GOTO      SPVIS998
.
SPVIS660  MOVE      QRYDATA,PTVIS066
          GOTO      SPVIS998
.
SPVIS670  MOVE      QRYDATA,PTVIS067
          GOTO      SPVIS998
.
SPVIS680  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00            * Set CMON from MTHNAM3
          PACK      PTVIS068,CCENT,CYEAR,CMON,CDAY
          GOTO      SPVIS998
.
SPVIS690  MOVE      QRYDATA,PTVIS069
          GOTO      SPVIS998
.
SPVIS700  MOVE      QRYDATA,PTVIS070
          GOTO      SPVIS998
.
SPVIS710  MOVE      QRYDATA,PTVIS071
          GOTO      SPVIS998
.
SPVIS720  MOVE      QRYDATA,PTVIS072
          GOTO      SPVIS998
.
SPVIS730  MOVE      QRYDATA,PTVIS073
          GOTO      SPVIS998
.
SPVIS740  MOVE      QRYDATA,PTVIS074
          GOTO      SPVIS998
.
SPVIS750  MOVE      QRYDATA,PTVIS075
          GOTO      SPVIS998
.
SPVIS760  MOVE      QRYDATA,PTVIS076
          GOTO      SPVIS998
.
SPVIS770  MOVE      QRYDATA,PTVIS077
          GOTO      SPVIS998
.
SPVIS780  MOVE      QRYDATA,PTVIS078
          GOTO      SPVIS998
.
SPVIS790  MOVE      QRYDATA,PTVIS079
          GOTO      SPVIS998
.
SPVIS800  MOVE      QRYDATA,PTVIS080
          GOTO      SPVIS998
.
SPVIS810  MOVE      QRYDATA,PTVIS081
          GOTO      SPVIS998
.
SPVIS820  MOVE      QRYDATA,PTVIS082
          GOTO      SPVIS998
.
SPVIS830  MOVE      QRYDATA,PTVIS083
          GOTO      SPVIS998
.
SPVIS840  MOVE      QRYDATA,PTVIS084
          GOTO      SPVIS998
.
SPVIS850  MOVE      QRYDATA,PTVIS085
          GOTO      SPVIS998
.
SPVIS860  MOVE      QRYDATA,PTVIS086
          GOTO      SPVIS998
.
SPVIS870  MOVE      QRYDATA,PTVIS087
          GOTO      SPVIS998
.
SPVIS880  MOVE      QRYDATA,PTVIS088
          GOTO      SPVIS998
.
SPVIS890  MOVE      QRYDATA,PTVIS089
          GOTO      SPVIS998
.
SPVIS900  MOVE      QRYDATA,PTVIS090
          GOTO      SPVIS998
.
SPVIS910  MOVE      QRYDATA,PTVIS091
          GOTO      SPVIS998
.
SPVIS920  MOVE      QRYDATA,PTVIS092
          GOTO      SPVIS998
.
SPVIS930  MOVE      QRYDATA,PTVIS093
          GOTO      SPVIS998
.
SPVIS940  MOVE      QRYDATA,PTVIS094                                   *I-53371
          GOTO      SPVIS998
.
SPVIS950  MOVE      QRYDATA,PTVIS095                                   *I-53371
          GOTO      SPVIS998
.
SPVIS960  MOVE      QRYDATA,PTVIS096
          GOTO      SPVIS998
.
SPVIS970  MOVE      QRYDATA,PTVIS097
          GOTO      SPVIS998
.
SPVIS980  MOVE      QRYDATA,PTVIS098
          GOTO      SPVIS998
.
SPVIS990  MOVE      QRYDATA,PTVIS099                                   *I-86040
          GOTO      SPVIS998
.
SPVI1000  MOVE      QRYDATA,PTVIS100
          GOTO      SPVIS998
.
SPVI1100  MOVE      QRYDATA,PTVIS101
          GOTO      SPVIS998
.
SPVI1200  MOVE      QRYDATA,PTVIS102
          GOTO      SPVIS998
.
SPVI1300  MOVE      QRYDATA,PTVIS103
          GOTO      SPVIS998
.
SPVI1400  MOVE      QRYDATA,PTVIS104
          GOTO      SPVIS998
.
SPVI1500  MOVE      QRYDATA,PTVIS105
          GOTO      SPVIS998
.
SPVI1600  MOVE      QRYDATA,PTVIS106
          GOTO      SPVIS998
.
SPVI1700  MOVE      QRYDATA,PTVIS107
          GOTO      SPVIS998
.
SPVI1800  MOVE      QRYDATA,PTVIS108
          GOTO      SPVIS998
.
SPVI1900  MOVE      QRYDATA,PTVIS109
          GOTO      SPVIS998
.
SPVI2000  MOVE      QRYDATA,PTVIS110
          GOTO      SPVIS998
.
SPVI2100  MOVE      QRYDATA,PTVIS111
          GOTO      SPVIS998
.
SPVI2200  MOVE      QRYDATA,PTVIS112
          GOTO      SPVIS998
.
SPVI2300  MOVE      QRYDATA,PTVIS113
          GOTO      SPVIS998
.
SPVI2400  MOVE      QRYDATA,PTVIS114
          GOTO      SPVIS998
.
SPVI2500  MOVE      QRYDATA,PTVIS115
          GOTO      SPVIS998
.
SPVI2600  MOVE      QRYDATA,PTVIS116
          GOTO      SPVIS998
.
SPVI2700  MOVE      QRYDATA,PTVIS117
          GOTO      SPVIS998
.
SPVI2800  MOVE      QRYDATA,PTVIS118
          GOTO      SPVIS998
.
SPVI2900  MOVE      QRYDATA,PTVIS119
          GOTO      SPVIS998
.
SPVI3000  MOVE      QRYDATA,PTVIS120
          GOTO      SPVIS998
.
SPVI3100  MOVE      QRYDATA,PTVIS121
          GOTO      SPVIS998
.
SPVI3200  MOVE      QRYDATA,PTVIS122
          GOTO      SPVIS998
.
SPVI3300  MOVE      QRYDATA,PTVIS123
          GOTO      SPVIS998
.
SPVI3400  MOVE      QRYDATA,PTVIS124
          GOTO      SPVIS998
.
SPVI3500  MOVE      QRYDATA,PTVIS125
          GOTO      SPVIS998
.
SPVI3600  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00            * Set CMON from MTHNAM3
          PACK      PTVIS126,CCENT,CYEAR,CMON,CDAY
          GOTO      SPVIS998
.
SPVI3700  MOVE      QRYDATA,PTVIS127
          GOTO      SPVIS998
.
SPVI3800  MOVE      QRYDATA,PTVIS128
          GOTO      SPVIS998
.
SPVI3900  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00            * Set CMON from MTHNAM3
          PACK      PTVIS129,CCENT,CYEAR,CMON,CDAY
          GOTO      SPVIS998
.
SPVI4000  MOVE      QRYDATA,PTVIS130
          GOTO      SPVIS998
.
SPVI4100  MOVE      QRYDATA,PTVIS131
          GOTO      SPVIS998
.
SPVI4200  MOVE      QRYDATA,PTVIS132
          GOTO      SPVIS998
.
SPVI4300  MOVE      QRYDATA,PTVIS133
          GOTO      SPVIS998
.
SPVI4400  MOVE      QRYDATA,PTVIS134
          GOTO      SPVIS998
.
SPVI4500  MOVE      QRYDATA,PTVIS135
          GOTO      SPVIS998
.
SPVI4600  MOVE      QRYDATA,PTVIS136
          GOTO      SPVIS998
.
SPVI4700  MOVE      QRYDATA,PTVIS137
          GOTO      SPVIS998
.
SPVI4800  MOVE      QRYDATA,PTVIS138
          GOTO      SPVIS998
.
SPVIS998  MOVE      ZERO,EXIT
          GOTO      SPVIS999
.
SPVIS995  MOVE      ONE,EXIT
.
SPVIS999  RETURN
+
.------------------------------------------------------------
. SPMIS000 - Set Parameters for Admission Details
. Returns:    EXIT   0
.                    1
.------------------------------------------------------------
.
SPMIS000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SPMIS010,SPMIS020,SPMIS030,SPMIS040,SPMIS050:
                       SPMIS060,SPMIS070,SPMIS080,SPMIS090,SPMIS100:
                       SPMIS110,SPMIS120,SPMIS130,SPMIS140,SPMIS150:
                       SPMIS160,SPMIS170,SPMIS180,SPMIS190,SPMIS200:
                       SPMIS210,SPMIS220,SPMIS230,SPMIS240,SPMIS250:
                       SPMIS260,SPMIS270,SPMIS280,SPMIS290,SPMIS300:
                       SPMIS310,SPMIS320,SPMIS330,SPMIS340,SPMIS350:
                       SPMIS360,SPMIS370,SPMIS380,SPMIS390,SPMIS400:
                       SPMIS410,SPMIS420,SPMIS430,SPMIS440,SPMIS450:
                       SPMIS460,SPMIS470,SPMIS480,SPMIS490,SPMIS500:
                       SPMIS510,SPMIS520,SPMIS530,SPMIS540,SPMIS550:
                       SPMIS560,SPMIS570,SPMIS580,SPMIS590,SPMIS600:
                       SPMIS610,SPMIS620,SPMIS630,SPMIS640,SPMIS650:
                       SPMIS660,SPMIS670,SPMIS680,SPMIS690,SPMIS700:
                       SPMIS710,SPMIS720,SPMIS730,SPMIS740,SPMIS750:
                       SPMIS760,SPMIS770,SPMIS780,SPMIS790,SPMIS800:
                       SPMIS810,SPMIS820,SPMIS830
.
          GOTO      SPMIS910
.
SPMIS010  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00            * Set CMON from MTHNAM3
          PACK      PTMIS001,CCENT,CYEAR,CMON,CDAY
          GOTO      SPMIS900
.
SPMIS020  MOVE      QRYDATA,PTMIS002
          GOTO      SPMIS900
.
SPMIS030  MOVE      QRYDATA,PTMIS003
          GOTO      SPMIS900
.
SPMIS040  MOVE      QRYDATA,PTMIS004
          GOTO      SPMIS900
.
SPMIS050  MOVE      QRYDATA,PTMIS005
          GOTO      SPMIS900
.
SPMIS060  MOVE      QRYDATA,PTMIS006
          GOTO      SPMIS900
.
SPMIS070  MOVE      QRYDATA,PTMIS007
          MOVE      ONE,CHGATYP
          GOTO      SPMIS900
.
SPMIS080  MOVE      QRYDATA,PTMIS008
          GOTO      SPMIS900
.
SPMIS090  MOVE      QRYDATA,PTMIS009
          GOTO      SPMIS900
.
SPMIS100  MOVE      QRYDATA,PTMIS010
          GOTO      SPMIS900
.
SPMIS110  MOVE      QRYDATA,PTMIS011
          GOTO      SPMIS900
.
SPMIS120  MOVE      QRYDATA,PTMIS012
          GOTO      SPMIS900
.
SPMIS130  MOVE      QRYDATA,PTMIS013
          GOTO      SPMIS900
.
SPMIS140  MOVE      QRYDATA,PTMIS014
          GOTO      SPMIS900
.
SPMIS150  MOVE      QRYDATA,PTMIS015
          GOTO      SPMIS900
.
SPMIS160  MOVE      QRYDATA,PTMIS016
          GOTO      SPMIS900
.
SPMIS170  MOVE      QRYDATA,PTMIS017
          GOTO      SPMIS900
.
SPMIS180  MOVE      QRYDATA,PTMIS018
          GOTO      SPMIS900
.
SPMIS190  MOVE      QRYDATA,PTMIS019
          GOTO      SPMIS900
.
SPMIS200  MOVE      QRYDATA,PTMIS020
          GOTO      SPMIS900
.
SPMIS210  MOVE      QRYDATA,PTMIS021
          GOTO      SPMIS900
.
SPMIS220  MOVE      QRYDATA,PTMIS022
          GOTO      SPMIS900
.
SPMIS230  MOVE      QRYDATA,PTMIS023
          GOTO      SPMIS900
.
SPMIS240  MOVE      QRYDATA,PTMIS024
          GOTO      SPMIS900
.
SPMIS250  MOVE      QRYDATA,PTMIS025
          GOTO      SPMIS900
.
SPMIS260  MOVE      QRYDATA,PTMIS026
          GOTO      SPMIS900
.
SPMIS270  MOVE      QRYDATA,PTMIS027
          GOTO      SPMIS900
.
SPMIS280  MOVE      QRYDATA,PTMIS028
          GOTO      SPMIS900
.
SPMIS290  MOVE      QRYDATA,PTMIS029
          GOTO      SPMIS900
.
SPMIS300  MOVE      QRYDATA,PTMIS030
          GOTO      SPMIS900
.
SPMIS310  MOVE      QRYDATA,PTMIS031
          GOTO      SPMIS900
.
SPMIS320  MOVE      QRYDATA,PTMIS032
          GOTO      SPMIS900
.
SPMIS330  MOVE      QRYDATA,PTMIS033
          GOTO      SPMIS900
.
SPMIS340  MOVE      QRYDATA,PTMIS034
          GOTO      SPMIS900
.
SPMIS350  MOVE      QRYDATA,PTMIS035
          GOTO      SPMIS900
.
SPMIS360  MOVE      QRYDATA,PTMIS036
          GOTO      SPMIS900
.
SPMIS370  MOVE      QRYDATA,PTMIS037
          GOTO      SPMIS900
.
SPMIS380  MOVE      QRYDATA,PTMIS038
          GOTO      SPMIS900
.
SPMIS390  MOVE      QRYDATA,PTMIS039
          GOTO      SPMIS900
.
SPMIS400  MOVE      QRYDATA,PTMIS040
          GOTO      SPMIS900
.
SPMIS410  MOVE      QRYDATA,PTMIS041
          GOTO      SPMIS900
.
SPMIS420  MOVE      QRYDATA,PTMIS042
          GOTO      SPMIS900
.
SPMIS430  MOVE      QRYDATA,PTMIS043
          GOTO      SPMIS900
.
SPMIS440  MOVE      QRYDATA,PTMIS044
          GOTO      SPMIS900
.
SPMIS450  MOVE      QRYDATA,PTMIS045
          GOTO      SPMIS900
.
SPMIS460  MOVE      QRYDATA,PTMIS046
          GOTO      SPMIS900
.
SPMIS470  MOVE      QRYDATA,PTMIS047
          GOTO      SPMIS900
.
SPMIS480  MOVE      QRYDATA,PTMIS048
          GOTO      SPMIS900
.
SPMIS490  MOVE      QRYDATA,PTMIS049
          GOTO      SPMIS900
.
SPMIS500  MOVE      QRYDATA,PTMIS050
          GOTO      SPMIS900
.
SPMIS510  MOVE      QRYDATA,PTMIS051
          GOTO      SPMIS900
.
SPMIS520  MOVE      QRYDATA,PTMIS052
          GOTO      SPMIS900
.
SPMIS530  MOVE      QRYDATA,PTMIS053
          GOTO      SPMIS900
.
SPMIS540  MOVE      QRYDATA,PTMIS054
          GOTO      SPMIS900
.
SPMIS550  MOVE      QRYDATA,PTMIS055
          GOTO      SPMIS900
.
SPMIS560  MOVE      QRYDATA,PTMIS056
          GOTO      SPMIS900
.
SPMIS570  MOVE      QRYDATA,PTMIS057
          GOTO      SPMIS900
.
SPMIS580  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00            * Set CMON from MTHNAM3
          PACK      PTMIS058,CCENT,CYEAR,CMON,CDAY
          GOTO      SPMIS900
.
SPMIS590  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00            * Set CMON from MTHNAM3
          PACK      PTMIS059,CCENT,CYEAR,CMON,CDAY
          GOTO      SPMIS900
.
SPMIS600  MOVE      QRYDATA,PTMIS060
          GOTO      SPMIS900
.
SPMIS610  MOVE      QRYDATA,PTMIS061
          GOTO      SPMIS900
.
SPMIS620  MOVE      QRYDATA,PTMIS062
          GOTO      SPMIS900
.
SPMIS630  MOVE      QRYDATA,PTMIS063
          GOTO      SPMIS900
.
SPMIS640  MOVE      QRYDATA,PTMIS064
          GOTO      SPMIS900
.
SPMIS650  MOVE      QRYDATA,PTMIS065
          GOTO      SPMIS900
.
SPMIS660  MOVE      QRYDATA,PTMIS066
          GOTO      SPMIS900
.
SPMIS670  MOVE      QRYDATA,PTMIS067
          GOTO      SPMIS900
.
SPMIS680  MOVE      QRYDATA,PTMIS068
          GOTO      SPMIS900
.
SPMIS690  MOVE      QRYDATA,PTMIS069
          GOTO      SPMIS900
.
SPMIS700  MOVE      QRYDATA,PTMIS070
          GOTO      SPMIS900
.
SPMIS710  MOVE      QRYDATA,PTMIS071
          GOTO      SPMIS900
.
SPMIS720  MOVE      QRYDATA,PTMIS072
          GOTO      SPMIS900
.
SPMIS730  MOVE      QRYDATA,PTMIS073
          GOTO      SPMIS900
.
SPMIS740  MOVE      QRYDATA,PTMIS074
          GOTO      SPMIS900
.
SPMIS750  MOVE      QRYDATA,PTMIS075
          REP       " 0",PTMIS075
          GOTO      SPMIS900
.
SPMIS760  MOVE      QRYDATA,PTMIS076
          GOTO      SPMIS900
.
SPMIS770  MOVE      QRYDATA,PTMIS077
          GOTO      SPMIS900
.
SPMIS780  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00            * Set CMON from MTHNAM3
          PACK      PTMIS078,CCENT,CYEAR,CMON,CDAY
          GOTO      SPMIS900
.
SPMIS790  PACK      PTMIS079,QRYDATA,SP70
          GOTO      SPMIS900
.
SPMIS800  PACK      PTMIS080,QRYDATA,SP70
          GOTO      SPMIS900
.
SPMIS810  PACK      PTMIS081,QRYDATA,SP70
          GOTO      SPMIS900
.
SPMIS820  PACK      PTMIS082,QRYDATA,SP70
          GOTO      SPMIS900
.
SPMIS830  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00            * Set CMON from MTHNAM3
          PACK      PTMIS083,CCENT,CYEAR,CMON,CDAY
          GOTO      SPMIS900
.
SPMIS900  MOVE      ONE,MISUPDFL
          MOVE      ZERO,EXIT
          GOTO      SPMIS999
.
SPMIS910  MOVE      ONE,EXIT
.
SPMIS999  RETURN
+
.-------------------------------------------------------------------------
. SPASF000 - Set Parameters for Admission special funding/contract Details
. Returns:    EXIT   0
.                    1
.-------------------------------------------------------------------------
.
SPASF000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SPASF010,SPASF020,SPASF030
.
          GOTO      SPASF910
.
SPASF010  MOVE      QRYDATA,PTASF001
          GOTO      SPASF900
.
SPASF020  MOVE      QRYDATA,PTASF002
          GOTO      SPASF900
.
SPASF030  MOVE      QRYDATA,PTASF003
          GOTO      SPASF900
.
SPASF900  MOVE      ONE,MISUPDFL
          MOVE      ZERO,EXIT
          GOTO      SPASF999
.
SPASF910  MOVE      ONE,EXIT
.
SPASF999  RETURN
+
.------------------------------------------------------------
. SPCLM000 - Set Parameters for Claim Details
. Returns:    EXIT  0
.                   1
.------------------------------------------------------------
.
SPCLM000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SPCLM010,SPCLM020,SPCLM030,SPCLM040,SPCLM050:
                       SPCLM060,SPCLM070,SPCLM080,SPCLM090,SPCLM100:
                       SPCLM110,SPCLM120,SPCLM130,SPCLM140,SPCLM150:
                       SPCLM160,SPCLM170,SPCLM180,SPCLM190,SPCLM200:
                       SPCLM210,SPCLM220,SPCLM230,SPCLM240,SPCLM250:
                       SPCLM260,SPCLM270,SPCLM280,SPCLM290,SPCLM300:
                       SPCLM310,SPCLM320,SPCLM330,SPCLM340,SPCLM350:
                       SPCLM360,SPCLM370,SPCLM380,SPCLM390,SPCLM400:
                       SPCLM410,SPCLM420,SPCLM430,SPCLM440,SPCLM450:
                       SPCLM460,SPCLM470,SPCLM480,SPCLM490,SPCLM500:
                       SPCLM510,SPCLM520,SPCLM530,SPCLM540,SPCLM550:
                       SPCLM560,SPCLM570,SPCLM580,SPCLM590,SPCLM600:
                       SPCLM610,SPCLM620,SPCLM630,SPCLM640,SPCLM650:
                       SPCLM660,SPCLM670,SPCLM680,SPCLM690,SPCLM700:
                       SPCLM710,SPCLM720,SPCLM730,SPCLM740,SPCLM750:
                       SPCLM760,SPCLM770,SPCLM780,SPCLM790,SPCLM800:
                       SPCLM810,SPCLM820,SPCLM830,SPCLM840,SPCLM850:
                       SPCLM860,SPCLM870,SPCLM880,SPCLM890
.
          GOTO      SPCLM910
.
SPCLM010  PACK      PTCLM001,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM020  PACK      PTCLM002,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM030  PACK      PTCLM003,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM040  PACK      PTCLM004,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM050  PACK      PTCLM005,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM060  PACK      PTCLM006,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM070  PACK      PTCLM007,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM080  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                *Set CMON from MTHNAM3
          PACK      PTCLM008,CCENT,CYEAR,CMON,CDAY
          GOTO      SPCLM900
.
SPCLM090  PACK      PTCLM009,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM100  PACK      PTCLM010,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM110  PACK      PTCLM011,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM120  PACK      PTCLM012,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM130  PACK      PTCLM013,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM140  PACK      PTCLM014,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM150  PACK      PTCLM015,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM160  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                *Set CMON from MTHNAM3
          PACK      PTCLM016,CCENT,CYEAR,CMON,CDAY
          GOTO      SPCLM900
.
SPCLM170  PACK      PTCLM017,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM180  PACK      PTCLM018,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM190  PACK      PTCLM019,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM200  PACK      PTCLM020,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM210  PACK      PTCLM021,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM220  PACK      PTCLM022,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM230  PACK      PTCLM023,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM240  PACK      PTCLM024,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM250  PACK      PTCLM025,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM260  PACK      PTCLM026,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM270  PACK      PTCLM027,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM280  PACK      PTCLM028,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM290  PACK      PTCLM029,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM300  PACK      PTCLM030,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM310  PACK      PTCLM031,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM320  PACK      PTCLM032,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM330  PACK      PTCLM033,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM340  PACK      PTCLM034,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM350  PACK      PTCLM035,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM360  PACK      PTCLM036,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM370  PACK      PTCLM037,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM380  PACK      PTCLM038,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM390  PACK      PTCLM039,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM400  PACK      PTCLM040,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM410  PACK      PTCLM041,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM420  PACK      PTCLM042,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM430  PACK      PTCLM043,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM440  PACK      PTCLM044,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM450  PACK      PTCLM045,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM460  PACK      PTCLM046,QRYDATA,SP70
          GOTO      SPCLM900
SPCLM470  PACK      PTCLM047,QRYDATA,SP70
          GOTO      SPCLM900
SPCLM480  PACK      PTCLM048,QRYDATA,SP70
          GOTO      SPCLM900
SPCLM490  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                *Set CMON from MTHNAM3
          PACK      PTCLM049,CCENT,CYEAR,CMON,CDAY
          GOTO      SPCLM900
.
SPCLM500  PACK      PTCLM050,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM510  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                *Set CMON from MTHNAM3
          PACK      PTCLM051,CCENT,CYEAR,CMON,CDAY
          GOTO      SPCLM900
.
SPCLM520  PACK      PTCLM052,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM530  PACK      PTCLM053,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM540  PACK      PTCLM054,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM550  PACK      PTCLM055,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM560  PACK      PTCLM056,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM570  PACK      PTCLM057,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM580  PACK      PTCLM058,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM590  PACK      PTCLM059,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM600  PACK      PTCLM060,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM610  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                *Set CMON from MTHNAM3
          PACK      PTCLM061,CCENT,CYEAR,CMON,CDAY
          GOTO      SPCLM900
.
SPCLM620  PACK      PTCLM062,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM630  PACK      PTCLM063,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM640  PACK      PTCLM064,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM650  PACK      PTCLM065,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM660  PACK      PTCLM066,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM670  PACK      PTCLM067,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM680  PACK      PTCLM068,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM690  PACK      PTCLM069,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM700  PACK      PTCLM070,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM710  PACK      PTCLM071,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM720  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                *Set CMON from MTHNAM3
          PACK      PTCLM072,CCENT,CYEAR,CMON,CDAY
          GOTO      SPCLM900
.
SPCLM730  PACK      PTCLM073,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM740  PACK      PTCLM074,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM750  PACK      PTCLM075,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM760  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                *Set CMON from MTHNAM3
          PACK      PTCLM076,CCENT,CYEAR,CMON,CDAY
          GOTO      SPCLM900
.
SPCLM770  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                *Set CMON from MTHNAM3
          PACK      PTCLM077,CCENT,CYEAR,CMON,CDAY
          GOTO      SPCLM900
.
SPCLM780  PACK      PTCLM078,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM790  PACK      PTCLM079,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM800  PACK      PTCLM080,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM810  PACK      PTCLM081,QRYDATA,SP70
          GOTO      SPCLM900
.                                                                   * Car 273294
SPCLM820  PACK      PTCLM082,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM830  PACK      PTCLM083,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM840  PACK      PTCLM084,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM850  PACK      PTCLM085,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM860  PACK      PTCLM086,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM870  PACK      PTCLM087,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM880  PACK      PTCLM088,QRYDATA,SP70
          GOTO      SPCLM900
.
SPCLM890  PACK      PTCLM089,QRYDATA,SP70
          GOTO      SPCLM900
.                
SPCLM900  MOVE      ONE,CLMUPDFL
          MOVE      ZERO,EXIT
          GOTO      SPCLM999
.
SPCLM910  MOVE      ONE,EXIT
.
SPCLM999  RETURN
+
.------------------------------------------------------------
. SCODL000 - Stationary Codes Selection List
.------------------------------------------------------------
.
SCODL000  PACK      KEY6,SP6
          CALL      RSIBTH1
SCODL100  CALL      RKIBTH1
          BRANCH    OVRCD,SCODL999
.
          IF        IBTHSTFM<>SEVEN
                                            * (stationary type 2 = MR5)
            GOTO      SCODL100
          ENDIF
.
          LOAD      F1,IBTHSTFM,TWO,ONE,THREE,THREE,THREE,THREE,ONE
          COMPARE   F1,ONE                  * (Pvitype=1 which is A&E)
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",IBTHSCOD,"#">":
                               IBTHDESC,"</option>";
          ENDIF
          GOTO      SCODL100

SCODL999  RETURN
+
.------------------------------------------------------------
. DHFND000 - Display Selection List for health fund
.------------------------------------------------------------
.
DHFND000  PACK      KEY14,SP70
          CALL      RDSFUND1
DHFND010  CALL      RDKFUND1
          BRANCH    OVRCD,DHFND999
.
          MATCH     HCODE,AFUNDH
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",HCODE,"#" selected> ":
                               HCODE,": ",HFNAME,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=#"",HCODE,"#"> ":
                               HCODE,": ",HFNAME,"</option>"
          ENDIF
          GOTO      DHFND010
.
DHFND999  RETURN
+
.------------------------------------------------------------
. Process Admission Details
. Returns:    EXIT   0 = Ok to continue
.                    1 = Error
.                    2 = Ok to continue with warning
.------------------------------------------------------------
.
PROADM00  MOVE      ZERO,CPAYMFLG
          BRANCH    UPDATETY,PROADM10,PROADM20,PROADM30,PROADM40,PROADM50:
                             PROADM60,PROADM70,PROADM80,PROADM85,PROADM86
          GOTO      PROADM93
.
PROADM10  MATCH     "1",BOARDERF
          IF        @EQUAL
            CALL      WRBL0000
          ENDIF
.
          IF        ADMITBOX=1
            CALL      ISUR0000
            BRANCH    EXIT,PROADM95
            MOVE      ZEROVISN,AADMNO
            MOVE      SP70,SAVADMNO
.
. if super insert admission, no need to call ISIN0000  
.
            MATCH     "1",SUPINSAD
            IF        !@EQUAL
              CALL      ISIN0000
              BRANCH    EXIT,PROADM95
            ENDIF
.
            CALL      CLPATMIS              * Clear file vars before use
            CALL      UPDMIS00
            MOVE      ADMISSNO,SADMISSN
            MOVE      SP70,ADMISSNO
            CALL      UPDVIS00              * Update vis fields with cgi params
            MOVE      SADMISSN,ADMISSNO
            BRANCH    EXIT,PROADM95
            CALL      VDAT0000
            BRANCH    EXIT,PROADM95
.
            CALL      NEWR0000
            BRANCH    EXIT,PROADM95
            CALL      RESCLM00
            BRANCH    EXIT,PROADM95
          ENDIF
.
          CALL      UPPRE000                * Update Pre-Admission
          IF        EXIT <> 1
            CALL      CHKF0000                * Update PMI folder details
            CALL      UPVCM000 
            CALL      PBDM0000
            PROC      BBUP0000                * Bed Board
            CALL      ECLOEC00                * Eclipse OEC
            CALL      DISWAR00
            CALL      WDIET000                * ward diet
            CALL      ADCM0000                * Admission diagnosis comments
            CALL      PTQMH000                * QLD HDP MH
            MATCH     "1",PTCNUNDH
            IF        @EQUAL
              CALL      PREVHS00              * WAHEALTH only
            ENDIF
            CALL      AREQ0000                * Update admission request
.
            MATCH     ADMISNID,SP70
            IF        !@EQUAL
              MOVE      ZERO,F1
              MOVE      TWO,KEY1
              MOVE      AADMNO,KEY8
              PROC      UPEADMVS               * Update eAdmission Details
            ELSE
              MATCH     "1",PTCNEPIS
              IF        @EQUAL
                MOVE      TWO,KEY1
                MOVE      AADMNO,KEY8
                PROC      UPEADSTS             * Update eAdmission Status only
              ENDIF
            ENDIF
.
            MATCH     CORSP001,SP70
            IF        !@EQUAL
              MOVE      ONE,F1
              MOVE      AADMNO,KEY8
              PROC      UPEADMVS               * Update Correspondence
            ENDIF
.
            CALL      UPPRFA00                 * Update PRFA from prev visit
.
            CALL      ABMI0000                * Update Patient Attributes
.
            CALL      AALV0000
            CALL      EDWB0000                * EDWARD Baby details trigger
.
          ENDIF
.
          COMPARE   ONE,COPYPDEF    * Copying an prev defense detail?
          IF        @EQUAL
            MOVE      PTMIS027,ACLAIM
.
            PACK      KEY11,CPYPAMIS,ACLAIM,SP70
            CALL      RDPMEXT1
            IF        OVRCD=0        
              MOVE      ADMISSNO,PMEXVISN
              PACK      KEY11,ADMISSNO,ACLAIM,SP70
              CALL      RAPMEXT1
              IF        OVRCD=1
                CALL      WRPMEXT1
              ENDIF
            ENDIF 
          ENDIF
.
          BRANCH    EXIT,PROADM95,PROADM91
.
          IF        ADMITBOX=1
            MOVE      AADMNO,ADMISSNO
            MOVE      ONE,DISERROR            * dont display errors again
            CALL      ADMP0000                * Admit a Pre-admission
            IF        EXIT=2
              PROC      BBUP0000              * Bed Board
            ENDIF
            CALL      AMHATR00                * Add Mental Health Attributes
            BRANCH    EXIT,PROADM95,PROADM91
            PROC      BBUP0000                * Bed Board
          ENDIF
.
          GOTO      PROADM90
.
PROADM20  CALL      ADMP0000                  * Admit a Pre-admission
          BRANCH    EXIT,PROADM95
.
          CALL      EDWB0000                  * EDWARD Baby details trigger
          CALL      EMER0000                  * Update Emergency if Required
          CALL      UPVS0000                  * Update the visit file
          BRANCH    EXIT,PROADM95
.
          CALL      WRNZP000                  * write NZ procedure details
          CALL      EXPPAY00                  * write expected payor details
.
          CALL      CHKF0000                  * Update PMI folder details
          CALL      UPVCM000 
          CALL      PBDM0000
          PROC      BBUP0000                  * Bed Board
          CALL      ECLOEC00                  * OEC
          CALL      DISWAR00
          CALL      WDIET000                  * ward diet
          CALL      ADCM0000                  * Admission diagnosis comments
          CALL      PTQMH000                  * QLD HDP MH
.
          MOVE      ONE,ADMITBOX
          CALL      ABMI0000
          CALL      AMHATR00                * Add Mental Health Attributes
.
          CALL      AALV0000
.

.
          GOTO      PROADM91
.
PROADM30  CALL      CPADM000                * Cancel Pre-Admission
          BRANCH    EXIT,PROADM95
          GOTO      PROADM90
.
PROADM40  CALL      UPMAD000                * Update Master Details
          BRANCH    EXIT,PROADM95,PROADM91
          GOTO      PROADM90
.
PROADM50  MATCH     "1",SERIFLAG
          IF        @EQUAL
            CALL      OUTCLM00                * Update Claim Details Outpatient
            BRANCH    EXIT,PROADM95,PROADM92  * single HCP series
            GOTO      PROADM56
          ENDIF
.
          MATCH     "2",SERIFLAG
          IF        @EQUAL
            CALL      UPCLMD00                * Update Claim Details Outpatient
            BRANCH    EXIT,PROADM95,PROADM92  * multiple HCP series
            GOTO      PROADM56
          ENDIF
.
          COMPARE   ONE,WAITFLAG
          IF        @EQUAL
            CALL      UPCLMD00                * Update Claim Details Outpatient
            BRANCH    EXIT,PROADM95,PROADM92  * Pre Admit clinic for W/List
            GOTO      PROADM56
          ENDIF
.
          COMPARE   TWO,WAITFLAG
          IF        @EQUAL
            CALL      UPCLMD00               * Update Claim Details Outpatient
            BRANCH    EXIT,PROADM95,PROADM92 * Pre Anaesthetic clinic for W/List
            GOTO      PROADM56
          ENDIF
.
          CALL      UPCLMD00                * Update Claim Details
          BRANCH    EXIT,PROADM95
.
          IF        EXIT=2
            MATCH     "1",PTCNXCOM
            IF        !@EQUAL
              MATCH     "D",CLAIMTYP
              CALL      FPRA0000 IF EQUAL
              MOVE      "&shwprint=1",REDIREC1
              MATCH     "Y",RETDFRAE
              IF        @EQUAL
                CALL      RDIREC00
              ELSE
                CALL      PDIREC00
              ENDIF
              GOTO      PROADM90
            ELSE
              MOVE      "&shwprint=1",REDIREC1
              MATCH     "Y",RETDFRAE
              IF        @EQUAL
                CALL      RDIREC00
              ELSE
                CALL      PDIREC00
              ENDIF
            ENDIF
          ENDIF
.
PROADM56  MATCH     "1",PTCNXCOM
          IF        !@EQUAL
            MATCH     "D",CLAIMTYP
            CALL      FPRA0000 IF EQUAL
            GOTO      PROADM90
          ENDIF
.
          MATCH     "H",CLAIMTYP
          IF        @EQUAL
            CALL      STAD0000         * Update health fund details
          ENDIF
.
          MATCH     "E",CLAIMTYP
          GOTO      PROADM58 IF EQUAL
          MATCH     "G",CLAIMTYP
          GOTO      PROADM59 IF NOT EQUAL
.
PROADM58  CALL      UCTL0000           * Update Local addrss to pmscex(Contact)
          CALL      UMST0000           * Update overseas address to patma1af
.
PROADM59  CALL      FPRA0000           * Updating prfa
.
          MATCH     SP70,UPDATPMI
          IF        !@EQUAL
            CALL      URES0000         * Update pmi residency from extra compen.
          ENDIF
.
          MOVE      ZERO,COUNTER
PROAD591  ADD       ONE,COUNTER
          COMPARE   THREE,COUNTER
          GOTO      PROADM90 IF EQUAL
.
          MATCH     "1",PRTFOARR[COUNTER]
          IF        !@EQUAL
            MATCH     "1",PRNTFORM
            GOTO      PROAD591 IF NOT EQUAL
.
            CALL      ADDPRN00
            MOVE      "ELECTFRM",SETDFPRG
            CALL      UPDEFP00
.
            GOTO      PROADM90
          ENDIF
.
          MOVE      SCHDPARR[COUNTER],SCHDPRNT
          MOVE      SCHDCARR[COUNTER],SCHDCOPY
          MOVE      STATNARR[COUNTER],STATNCOD
          CALL      ADDPRN00              * print form
.
          MOVE      "ELECTFRM",SETDFPRG
          MATCH     "342",TEMPLATE
          IF        @EQUAL
            SUB       ONE,COUNTER
            MOVE      COUNTER,COUNTERD
            SQUEEZE   COUNTERD
            PACK      KEY2,COUNTERD,X1
            ADD       ONE,COUNTER
          ELSE
            PACK      KEY2,ZERO,CLAIMTYP
          ENDIF
          CALL      UPDEFP00
.
          GOTO      PROAD591
.
PROADM60  MATCH     "032",TEMPLATE          * Change pre admission screen
          IF        @EQUAL
            MOVE      ADMISSNO,KEY8
            CALL      RDMISS1
            IF        OVRCD = 1
              MOVE      "Invalid Admission Number",WEBTITLE
              CALL      DEMOGR00
              GOTO      PROADM95
            ENDIF
.
            IF        ASTAT<>1
              MOVE      "Patient is not pre-admitted",WEBTITLE
              CALL      DEMOGR00
              GOTO      PROADM95
            ENDIF
.
            CALL      VALDWB00              * Validate ward/bed on update
            BRANCH    EXIT,PROADM95         * pre admission
            CALL      VALDPO00            * Validate Post Op ward/bed on update
            BRANCH    EXIT,PROADM95         * pre admission
          ENDIF
.
          MATCH     "030",TEMPLATE
          IF        @EQUAL
            CALL      VALDPO00            * Validate Post Op ward/bed on update
            BRANCH    EXIT,PROADM95         * pre admission
          ENDIF
.
          MATCH     "036",TEMPLATE
          IF        @EQUAL
            MATCH     "0",UPDTADMN               * only update OEC details
            GOTO      PROADM65 IF EQUAL
            MOVE      ADMISSNO,KEY8
            CALL      RDMISS1                    * CAR 228545
            IF        OVRCD = 1
              MOVE      "Invalid Admission Number",WEBTITLE
              CALL      WEBERR00
              GOTO      PROADM95
            ELSE
              MATCH     PTMIS026,Z70
              IF        !@EQUAL
                PACK      AMBS,PTMIS026,SP70
              ENDIF
              CALL      UPMISS1
            ENDIF
.
            COMPARE   ONE,ASTAT
            IF        !@EQUAL
              PACK      KEY8,ADMISSNO,SP70
              CALL      RDPMVX11
              IF        OVRCD=0
                MOVE      PTVIS109,PMVXPOEC
                MOVE      PTVIS111,PMVXPILC
                CALL      UPPMVX11
              ENDIF
              GOTO      PROADM65
            ENDIF
          ENDIF
.
          MATCH     "136",TEMPLATE
          IF        @EQUAL
            MATCH     "0",UPDTADMN               * only update OECW details
            GOTO      PROADM65 IF EQUAL
.
            COMPARE   ONE,ASTAT
            IF        !@EQUAL
              PACK      KEY8,ADMISSNO,SP70
              CALL      RDPMVX11
              IF        OVRCD=0
                MOVE      PTVIS109,PMVXPOEC
                CALL      UPPMVX11
              ENDIF
              GOTO      PROADM65
            ENDIF
          ENDIF
.
          CALL      UPADM000                * Update Admission Details
          BRANCH    EXIT,PROADM95
.
          CALL      WRPATR20                * Write Reason for Discharge delay
.
          MOVE      "14 ",ALTTYPE
          MOVE      SP70,ALTOLDVL
          MOVE      SP70,ALTNEWVL
          CALL      WEAL0000                * Write EDWARD alteration record
.
          CALL      EDWB0000                * EDWARD Baby details trigger
.
          MATCH     ADMISNID,SP70
          IF        !@EQUAL
            MOVE      ZERO,F1
            MOVE      TWO,KEY1
            MOVE      AADMNO,KEY8
            PROC      UPEADMVS               * Update eAdmission details
          ENDIF
.
          MATCH     CORSP001,SP70
          IF        !@EQUAL
            MOVE      ONE,F1
            MOVE      AADMNO,KEY8
            PROC      UPEADMVS               * Update Correspondence
          ENDIF
.
          CALL      WRNZP000                * write NZ procedure details
          CALL      EXPPAY00                * write expected payor details
.
          CALL      CHKF0000                * Update PMI folder details
          CALL      UPVCM000 
          CALL      WORKD000
.
          MATCH     "030",TEMPLATE
          IF        @EQUAL
            MOVE      AWARD,PTMIS004
            MOVE      ABED,PTMIS005
            CALL      PBDM0000
          ENDIF
.
          MATCH     "032",TEMPLATE
          IF        @EQUAL
            MOVE      PTMIS068,PTMIS004
            MOVE      PTMIS076,PTMIS005
            CALL      PBDM0000
            MATCH     ADMISNID,SP70         * Update PRFA for eAdmission 286548
            IF        !@EQUAL
              CALL      UPDPRA00            * move pra cgi params into vars
              CALL      UPPRA000            * Update Person Respons for Acc
            ENDIF
            CALL      UPNZP000            * Update NZ Procedures 
          ENDIF
.
          CALL      UXDC0000      * Update visxdcaf extra discharge details
.
PROADM65  MATCH     "036",TEMPLATE          * Eclipse OEC Single Request
          IF        @EQUAL
            CALL      ECLOEC00
            GOTO      PROADM91
          ENDIF
.
          MATCH     "136",TEMPLATE          * Eclipse OEC Single Request
          IF        @EQUAL
            CALL      ECLOEM00
            GOTO      PROADM91
          ENDIF
.
          MATCH     "032",TEMPLATE
          IF        @EQUAL
            CALL      ABMI0000
          ENDIF
.
          MATCH     "030",TEMPLATE
          IF        @EQUAL
            CALL      UBMI0000
            CALL      AMHATR00                * Add Mental Health Attributes
          ENDIF
.
          PROC      BBUP0000                * Bed Board
          CALL      ECLOEC00                * OEC
          CALL      DISWAR00
          CALL      WDIET000                * ward diet
          CALL      ADCM0000                * Admission diagnosis comments
          CALL      PTQMH000                * QLD HDP MH
          CALL      AALV0000
.
          MATCH     "030",TEMPLATE          * Update admission
          IF        @EQUAL
            CALL      NOBD0000              * Check no bed file
          ENDIF
. 
          IF        PTCNHDPS=1
            CALL      WRPORD00              * write acc purchase order no if req
          ENDIF
.
          GOTO      PROADM91
.
PROADM70  CALL      UPDALI00                * Update Alias
          BRANCH    EXIT,PROADM95
          GOTO      PROADM90
.
PROADM80  PROC      CANUR000                * Cancel U/R Number
          BRANCH    EXIT,PROADM95
          CALL      PREDIR00
.
          GOTO      PROADM90
.
PROADM85  BRANCH    UPDATET2,PROADM87,PROADM88
          CALL      UPADM000                * Update Provisional Diagnosis
          CALL      WINCLS00
          GOTO      PROADM90
.
PROADM86  CALL      ACCD0000                * ACC Details
          GOTO      PROADM99
.
PROADM87  CALL      UPVCM000 
          GOTO      PROADM90
.
PROADM88  CALL      UPUCM000                * Update U/R Comments
          GOTO      PROADM90
.
PROADM90  MOVE      ZERO,EXIT
          GOTO      PROADM99
.
PROADM91  CALL      WEBWAR00                * Display Warnings
          GOTO      PROADM98
.
PROADM92  CALL      OUTWAR00                * Display Warnings
          GOTO      PROADM98
.
PROADM93  MOVE      "Invalid Update Type",WEBTITLE
          CALL      ADMERR00
PROADM95  MOVE      ONE,EXIT
          GOTO      PROADM99
.
PROADM98  MOVE      TWO,EXIT
          CALL      UPPHSP00
          GOTO      PROADM99
.
PROADM99  CLOSE     COMAIJAF,DELETE
          CLOSE     COMCIJAF,DELETE
          CLOSE     COMAWKAF,DELETE
          RETURN
+
.**********************************************************************
.         Update NZ Procedures 
.**********************************************************************
UPNZP000  COMPARE   FIVE,CFEETYP
          GOTO      UPNZP999 IF NOT EQUAL
.
          MOVE      ADMISSNO,KEY8
          CALL      RDMISS1                    * CAR 228545
          BRANCH    OVRCD,UPNZP999
          COMPARE   ONE,ASTAT
          GOTO      UPNZP999 IF NOT EQUAL
.
          PACK      KEY11,ADMISSNO,SP70
          CALL      RSNZSPR1
UPNZP100  CALL      RKNZSPR1
          BRANCH    OVRCD,UPNZP999
.
          MATCH     ADMISSNO,NZSPADMN
          GOTO      UPNZP999 IF NOT EQUAL
.
          MATCH     ACLAIM,NZSPCLMN
          GOTO      UPNZP100 IF NOT EQUAL
.
          PACK      KEY5,ANSC,ANSL,NZSPCLMN
          CALL      RDCODE1
          BRANCH    OVRCD,UPNZP100
.
          MOVE      ONE,OVRCD
          MATCH     NZSPR017,Z70
          IF        !@EQUAL
            MOVE      NZSPR017,NZSPCLNO      * Claim number
            MOVE      ZERO,OVRCD
          ENDIF
          MATCH     NZSPR015,Z70
          IF        !@EQUAL
            MOVE      NZSPR015,NZSPAPRV      * Approval number
            MOVE      ZERO,OVRCD
          ENDIF
          MATCH     NZSPR024,Z70
          IF        !@EQUAL
            MOVE      NZSPR024,NZSPADTE      * Approval date
            MOVE      ZERO,OVRCD
          ENDIF
          BRANCH    OVRCD,UPNZP999
          CALL      UPNZSPR1
.
UPNZP999  RETURN
+
.**********************************************************************
.         Set admission fields for Private
.**********************************************************************
STAD0000  MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,STAD1000
.
          MOVE      ONE,OVRCD
          MATCH     PTMIS013,Z70
          IF        !@EQUAL
            MOVE      PTMIS013,AFUNDH          * health fund
            PACK      AFUNDH,AFUNDH,SP70
            MOVE      ZERO,OVRCD
          ENDIF
          MATCH     PTMIS014,Z70
          IF        !@EQUAL
            MOVE      PTMIS014,AFNDTB          * health fund table
            PACK      AFNDTB,AFNDTB,SP70
            MOVE      ZERO,OVRCD
          ENDIF
          MATCH     PTMIS015,Z70
          IF        !@EQUAL
            MOVE      PTMIS015,AFNDMM          * health fund membership
            PACK      AFNDMM,AFNDMM,SP70
            MOVE      ZERO,OVRCD
          ENDIF
          BRANCH    OVRCD,STAD2000
          CALL      UPMISS1
          GOTO      STAD2000
.
.         Check for outpatient
.
STAD1000  CALL      RDPMVX11
          BRANCH    OVRCD,STAD9999
          CALL      RDBOKB1
          MOVE      OVRCD,F1
.
          MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,STAD2000
.
          MOVE      ONE,OVRCD
          MATCH     Z70,PTMAS036
          IF        !@EQUAL
            MOVE      PTMAS036,PFUNDH          * health fund
            PACK      PFUNDH,PFUNDH,SP70
            MOVE      ZERO,OVRCD
          ENDIF
          MATCH     PTMAS037,Z70
          IF        !@EQUAL
            MOVE      PTMAS037,PFNDTB          * health fund table
            PACK      PFNDTB,PFNDTB,SP70
            MOVE      ZERO,OVRCD
          ENDIF
          MATCH     PTMAS038,Z70
          IF        !@EQUAL
            MOVE      PTMAS038,PFNDMM          * health fund membership
            PACK      PFNDMM,PFNDMM,SP70
            MOVE      ZERO,OVRCD
          ENDIF
          BRANCH    OVRCD,STAD2000
          CALL      UPMAST1
          IF        F1=0
            MOVE      PFUNDH,OTBBFUND          * HF
            MOVE      PFNDTB,OTBBTBLE          * HF table
            CALL      UPBOKB1
.
            PACK      KEY8,OBAOUTNO,SP70
            CALL      RDPMVX11
            IF        OVRCD=0
                CALL      IBACLOCK
                PACK      PMVXLUPD,CCC,CYY,CMM,CDD
                REP       " 0",PMVXLUPD
                MOVE      CTIMEIS,PMVXLUPT
                MOVE      USERID,PMVXWEBU
                CALL      UPPMVX11
            ENDIF
.
          ENDIF
.
          MATCH     PMSVX142,Z70
          IF        !@EQUAL
            MOVE      URNUMBER,KEY8
            CALL      RDPMPX21
            IF        OVRCD=0
              MOVE      PMSVX142,PMPXHFCN        * Contributor name
              PACK      PMPXHFCN,PMPXHFCN,SP70
              CALL      UPPMPX21
            ENDIF
          ENDIF
.
.         Check if Contributor name is changed
.
STAD2000  MOVE      ADMISSNO,KEY8
          CALL      RDPMVX11
          BRANCH    OVRCD,STAD9999
.
          MOVE      ONE,OVRCD
          MATCH     PTMAS038,Z70
          IF        !@EQUAL
            MOVE      PTMAS038,PMVXFNDM        * health fund membership
            PACK      PMVXFNDM,PMVXFNDM,SP70
            MOVE      ZERO,OVRCD
          ENDIF
.
          MATCH     PMSVX142,Z70
          IF        !@EQUAL
            MOVE      PMSVX142,PMVXCONM        * Contributor name
            PACK      PMVXCONM,PMVXCONM,SP70
            MOVE      ZERO,OVRCD
          ENDIF
          BRANCH    OVRCD,STAD9999
          CALL      UPPMVX11
STAD9999  RETURN
+
.-------------------------------------------------------------------------
. PROCLM00 - Process Claim details
.-------------------------------------------------------------------------
PROCLM00  MOVE      ONE,CLMUPDFL
          CALL      UPCLMD00                * Update Claim Details Outpatient
          BRANCH    EXIT,PROCLM99,PROCLM92
.
PROCLM90  MOVE      ZERO,EXIT
          GOTO      PROCLM99
.
PROCLM92  CALL      WEBWAR00                * Display Warnings
          MOVE      ONE,EXIT
          GOTO      PROCLM99
.
PROCLM99  RETURN
+
.-------------------------------------------------------------------------
. Default date and time for EMR admission
.-------------------------------------------------------------------------
EMRCTP00  MOVE      ONE,EXIT               * use current date/time
          COMPARE   THREE,PTCNHDPS         * If not vistoria don't check for a
          GOTO      EMRCTP99 IF NOT EQUAL  * Short stay ED location
.
          CALL      CHKWHO00
          MOVE      ZERO,EXIT              * default adm.date/time
.
EMRCTP99  RETURN
+
.----------------------------------------------------------------------
. CHKWHO00 - Check if the patient has been in a short stay ED location.
. If they have default that date/time as the admission date/time
. else use the current date/time
.----------------------------------------------------------------------
.
CHKWHO00  MOVE      SP70,CTYPDATE
          MOVE      SP70,CTYPTIME
.
          OPEN      EMRLOCA1,"emrlocaf"
.
          IF        REPORTNO=4
            PACK      KEY22,EMRVISIT,SP70        * Admit a pre admission
          ELSE
            PACK      KEY22,ADMISSNO,SP70        * Admission
          ENDIF
.
          CALL      RSEMHIS1
CHKWHO10  CALL      RKEMHIS1                     * Read history records
          BRANCH    OVRCD,CHKWHO50
.
          IF        REPORTNO=4
            MATCH     EMRVISIT,EMHIVIS           * Admit a pre admission
            GOTO      CHKWHO50 IF NOT EQUAL
          ELSE
            MATCH     ADMISSNO,EMHIVIS           * Admission
            GOTO      CHKWHO50 IF NOT EQUAL
          ENDIF
.
          MATCH     "MOVEL",EMHIUPT              * Move location
          GOTO      CHKWHO10 IF NOT EQUAL
.
          MATCH     SP70,EMHILOC                 * Location populated
          GOTO      CHKWHO10 IF EQUAL
          GOTO      CHKWHO10 IF EOS
.
          PACK      KEY3,EMHILOC,SP70
          CALL      RDEMLOC1                     * Read ED location
          BRANCH    OVRCD,CHKWHO10
.
          MATCH     "1",EMLOSSIN                 * Shot stay location
          GOTO      CHKWHO10 IF NOT EQUAL
.
          MATCH     SP70,EMHIDAT                 * Date must not be blank
          GOTO      CHKWHO50 IF EQUAL
.
          MATCH     SP70,EMHITIM                 * Time must not be blank
          GOTO      CHKWHO50 IF EQUAL
.
          MOVE      EMHIDAT,CTYPDATE        * Use short stay location date/time
.
          UNPACK    EMHITIM,DIM2,DIM2A,DIM2B
          PACK      CTYPTIME,DIM2,COLON,DIM2A,COLON,DIM2B
          GOTO      CHKWHO99
.
CHKWHO50  PACK      CTYPDATE,CCC,CYY,CMM,CDD    * Default the adm date/time
          REP       " 0",CTYPDATE               * to the current date/time
          CLOCK     TIME,CTYPTIME
.
CHKWHO99  CLOSE     EMRLOCA1
          RETURN
+
.----------------------------------------------------------------------
. FSDDT000 - Output first seen doctor date/time for admit from ED
.----------------------------------------------------------------------
.
FSDDT000  PACK      KEY22,ADMISSNO,SP70
          CALL      RSEMHIS1
FSDDT010  CALL      RKEMHIS1                     * Read history records
          BRANCH    OVRCD,FSDDT999
.
          MATCH     ADMISSNO,EMHIVIS
          GOTO      FSDDT999 IF NOT EQUAL
.
          MATCH     SP70,EMHIDSD                 * Date seen by doctor
          GOTO      FSDDT010 IF EQUAL
.
          MATCH     SP70,EMHIDST                 * Time must not be blank
          GOTO      FSDDT010 IF EQUAL
.
          MATCH     "1",KEY1
          IF        @EQUAL
            GOTO      FSDDT300
          ENDIF
.
          UNPACK    EMHIDSD,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      FSDDT999
.
FSDDT300  UNPACK    EMHIDST,DIM2,DIM2A,DIM2B
          WRITE     HTMLFILE;DIM2,COLON,DIM2A,COLON,DIM2B;
          GOTO      FSDDT9999
.
FSDDT999  RETURN
+
.------------------------------------------------------------------------
. EMRINP00 - Write the same records for a EMR patient to a Inpatint Visit
.------------------------------------------------------------------------
.
EMRINP00  MATCH     SP70,EMADMISS
          GOTO      EMRINP99 IF EQUAL
.
          MATCH     "1",PTCNXCOM            * Using extra compensable details
          GOTO      EMRINP30 IF EQUAL
.
          MOVE      EMADMISS,KEY8
          CALL      RDWMAB1
          BRANCH    OVRCD,EMRINP10
.
          MOVE      ADMISSNO,MADMNO
          MOVE      MADMNO,KEY8
          CALL      RDAWMAB1
          IF        OVRCD=1
            MOVE      EMVIURNO,PTWMURNO
            MOVE      EMVIDATE,PTWMVDAT
            CALL      WRWMAB1
          ENDIF
          GOTO      EMRINP99
.
EMRINP10  MOVE      EMADMISS,KEY8
          CALL      RDWCOM1
          BRANCH    OVRCD,EMRINP20
.
          MOVE      ADMISSNO,WCADMNO
          MOVE      WCADMNO,KEY8
          CALL      RDAWCOM1
          IF        OVRCD=1
            MOVE      EMVIURNO,PTWCURNO
            MOVE      EMVIDATE,PTWCVDAT
            CALL      WRWCOM1
.
.           If we are sending ACC details in PV1-20, then we need to
.           trigger an A08 message for the visit to reflect that this is
.           now an ACC patient
.
            MATCH     "1",PTCNH7AC
            IF        @EQUAL
              CALL      PMIGTNID               * get national id for dgate write
              MOVE      NMPNUMB,PTNINMPI
              IF        ASTAT = 1
                MOVE      ONE,HL7TRGID
                MOVE      SP8,HL7INCLD
                PROC      DGCLICCP               * send update Pre-adm details
              ELSE
                MOVE      TWO,HL7TRGID
                MOVE      SP8,HL7INCLD
                PROC      DGCLICAC               * send update I/P details
              ENDIF
            ENDIF
          ENDIF
.
          MOVE       EMADMISS,KEY8
          CALL       RDPMWX11
          IF         OVRCD=0
            MOVE       ADMISSNO,PMWXVISN
            MOVE       PMWXVISN,KEY8
            CALL       RAPMWX11
            IF         OVRCD=1
              CALL      IBACLOCK
              PACK      PMWXCDTE,CCC,CYY,CMM,CDD       * Current Date
              REP       " 0",PMWXCDTE
              MOVE      CTIMEIS,PMWXCTIM               * Current Time
              MOVE      USERID,PMWXWEBC                * Current WebID
              CALL      WRPMWX11
            ENDIF
          ENDIF
          GOTO      EMRINP99
.
EMRINP20  MOVE      EMADMISS,KEY8
          CALL      RDWVET1
          BRANCH    OVRCD,EMRINP30
.
          MOVE      ADMISSNO,VADMNO
          MOVE      VADMNO,KEY8
          CALL      RDAWVET1
          IF        OVRCD=1
            CALL      WRWVET1
          ENDIF
          GOTO      EMRINP99
.
EMRINP30  PACK      KEY11,EMADMISS,ACLAIM,SP70
          CALL      RDPMEXT1                     * Copy compensable details
          BRANCH    OVRCD,EMRINP99               * from ED to IP if same claim
.                                                * code
          MOVE      ADMISSNO,PMEXVISN
.
          PACK      KEY11,PMEXVISN,PMEXCLAM,SP70
          CALL      RAPMEXT1
          IF        OVRCD=1
            MOVE      EMVIDATE,PMEXVDAT
            CALL      WRPMEXT1
          ENDIF
          GOTO      EMRINP99
.
EMRINP99  RETURN
+
.------------------------------------------------------------
. EMER0000 - Check for an EMR admission
.------------------------------------------------------------
.
EMER0000  MATCH     SP70,EMADMISS
          GOTO      EMER9999 IF EQUAL
.
          MOVE      EMADMISS,KEY8
          CALL      RDEMVIS1
          BRANCH    OVRCD,EMER9999
.
          COMPARE   FOUR,EMVISTAT
          GOTO      EMER9999 IF EQUAL
.
          MOVE      ADMISSNO,EMVIPADM       * Save inpatient admissno
.         MOVE      PTMIS068,EMVIEWRD       * Save Expected ward
.
          MATCH     PTMIS068,Z70
          IF        !@EQUAL
            MOVE      PTMIS068,EMVIEWRD
          ENDIF
.
          MATCH     PTMIS076,Z70
          IF        !@EQUAL
            MOVE      PTMIS076,EMVIEBED
          ENDIF
.
          BRANCH    IPADMDAT,EMER0500       * No IP ADM Date default
.
          COMPARE   ZERO,EMVIYN02     * Check to see if this a c-type
          IF        @EQUAL
            MOVE      PTMIS001,EMVIDDAT       * Discharge Date in EMR
            MOVE      PTMIS002,EMVIDTIM       * Discharge Time in EMR
          ENDIF
.
EMER0500  CALL      UPEMVIS1
.
          CALL      EMRINP00           * Create the same data for INP and EMR
.
          PACK      KEY6,PTMIS068,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,EMER1000
.
          MATCH     SP70,WEFRBT
          GOTO      EMER1000 IF EQUAL
.
          PACK      KEY5,ANSB,ANST,WEFRBT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,EMER1000
.
          MATCH     ANSE,TCINDC12
          GOTO      EMER9999 IF EQUAL     * don't update ED
.
          MATCH     ANSE,TCINDC11         * Emergency ward - leave on map
          IF        @EQUAL
            MATCH     ANSS,THCSCOD
            IF        @EQUAL
              CALL      IBACLOCK
              PACK      EMVIDDAT,CCC,CYY,CMM,CDD * Discharge date/time set to
              REP       " 0",EMVIDDAT            * the current date and time if
              MOVE      CTIMEIS,EMVIDTIM         * the admission is directly to
              GOTO      EMER9000                 * EOU
            ENDIF
            GOTO      EMER9999
          ENDIF
.
EMER1000  BRANCH    ASTAT,EMER9000        * Don't clear ED location for linked
.                                         * pre admissions
          MOVE      ONE,EMVIYN09          * Set Flag for all done
          MOVE      SP70,EMVILOCN         * Booked into ward other than
          MOVE      SP70,EMVIPRLO
          MOVE      SP70,EMVIPRTM
.
EMER9000  CALL      UPEMVIS1
.
EMER9999  RETURN
+
.------------------------------------------------------------
. UPVS0000 - Update the visit file after admitting
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
.
.         Write/Update Visits file if we have a U/R Number
.
UPVS0000  MATCH     ZEROUR,PURNO
          GOTO      UPVS9000 IF EQUAL
.
          MOVE      AADMNO,PVIBILL
          MOVE      PURNO,PVIURNO
          PACK      PVIDATE,ADATE
          REP       " 0",PVIDATE
          MOVE      THREE,PVITYPE
.
          MOVE      ZERO,TCINDC1
          PACK      KEY5,ANSA,SP1,ATYPE
          CALL      RDCODE1
.
          MOVE      ZERO,FORM1              * in case TCINDC1 is not numeric
          MOVE      TCINDC1,FORM1
          MOVE      TWO,PVISTAT             * Default Public Patient
          LOAD      PVISTAT,FORM1,TWO,ONE
          MOVE      ONE,PVITRAN             * initialise transaction number
          MOVE      SP2,PVILOCK
          PACK      PVISITE,SP70
          PACK      PTVITYPE,SP70
          MOVE      SP20,PVISPAR
.
          MOVE      ADOCTA,PVIDOCT
          MOVE      PTYPE,PVIRESI
.
          MOVE      PVIBILL,KEY8
          CALL      RLPTVIS1                * visit record found ?
          BRANCH    OVRCD,UPVS1000:         * no
                          UPVS9100          * yes, but already locked
.
.         Update current record
.
          MOVE      ADOCTA,PVIDOCT
          MOVE      PTYPE,PVIRESI
          MOVE      TWO,PVISTAT             * Default Public Patient
          LOAD      PVISTAT,FORM1,TWO,ONE
          PACK      PVIDATE,ADATE
          REP       " 0",PVIDATE
          CALL      UPVISA1                 * update visit record
          CALL      UUPTVIS1
          GOTO      UPVS9000
.
.         Write a new record
.
UPVS1000  PACK      PVIUNQE,SP70
.
          MATCH     "1",PTCNXCOM
          IF        @EQUAL
            MOVE      WBSESIT,PVISITE
          ENDIF
.
          CALL      WRVISA1                 * write a record
          CALL      ADDVIS00                * Adds a record to MR Visit Link
          CALL      AEXP0000                * write adm based expected payors
.
UPVS9000  MOVE      ZERO,EXIT
          GOTO      UPVS9999
.
.         Visit record locked
.
UPVS9100  CLEAR     WEBTITLE
          APPEND    "Visit ",WEBTITLE
          APPEND    PVIBILL,WEBTITLE
          APPEND    " is Locked on Port ",WEBTITLE
          APPEND    PVILOCK,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPVS9999
.
UPVS9999  RETURN
+
.------------------------------------------------------------
. WEBWAR00 - Display Warnings
.------------------------------------------------------------
.
WEBWAR00  BRANCH    FHIRTYPE,WEBWAR90
.
          CALL      OPENHTML
          BRANCH    EXIT,WEBWAR95
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             "src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             "src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#"> "
.
          IF        RECURRFL=1
            CALL      WRRC0000           * Write to recurring care table
            IF        DISCFLAG=1
              CALL      DISCH000         * Discharge Patient
            ENDIF
          ENDIF
.
          MATCH     SP70,SVHAONPR
          IF        !@EQUAL
            MATCH     SP70,SVHAWBWR
            IF        !@EQUAL
              MATCH     SP70,ADMISCKI
              IF        !@EQUAL
                CALL      UPPRCS00
              ENDIF
            ENDIF
          ENDIF
.
          COMPARE   ZERO,WARCOUNT
          GOTO      WEBWAR20 IF EQUAL
.
          MOVE      ONE,COUNTER
WEBWAR10  WRITE     HTMLFILE;"    alert(#"",WEBWARNG[COUNTER],"#");",012
          ADD       ONE,COUNTER
          COMPARE   COUNTER,WARCOUNT
          GOTO      WEBWAR20 IF LESS
          GOTO      WEBWAR10
.
WEBWAR20  IF        RECURRFL=1
            GOTO      WEBWAR30
          ENDIF
.
          IF        CPAYMFLG=1
            MOVE      AADMNO,ADMISSNO
            REP       " +",URNUMBER
            REP       " +",ADMISSNO
            CLEAR     REDIRECT
            APPEND    "patweb71.pbl?reportno=04&template=008&urnumber=",REDIRECT
            APPEND    URNUMBER,REDIRECT
            APPEND    "&mvmedrec=",REDIRECT
            APPEND    MVMEDREC,REDIRECT
            APPEND    "&admissno=",REDIRECT
            APPEND    ADMISSNO,REDIRECT
            APPEND    SP70,REDIRECT
            RESET     REDIRECT
            REP       "+ ",URNUMBER
            REP       "+ ",ADMISSNO
            MOVE      ZERO,CPAYMFLG
          ELSE
            MATCH     "1",SHOWFLAG
            GOTO      WEBWAR30 IF EQUAL
.
            MATCH     SP70,CPMISKEY
            GOTO      WEBWAR30 IF NOT EQUAL
.
            MOVE      REDIRECT,KEY200
            MOVE      AADMNO,ADMISSNO
            REP       " +",ADMISSNO
            PACK      REDIRECT,KEY200,ADMISSNO,SP70
            COMPARE   ONE,REGIFLAG
            IF        @EQUAL
              ENDSET    REDIRECT
              APPEND    "&regiflag=1",REDIRECT
              RESET     REDIRECT
            ENDIF
          ENDIF

.
          COMPARE     "13",REPORTNO
          IF          @EQUAL
            MOVE      AADMNO,ADMISSNO
            REP       " +",URNUMBER
            REP       " +",ADMISSNO
            CLEAR     REDIRECT
            APPEND    "patweb89.pbl?reportno=01&template=030&urnumber=",REDIRECT
            APPEND    URNUMBER,REDIRECT
            APPEND    "&admissno=",REDIRECT
            APPEND    ADMISSNO,REDIRECT
            APPEND    "&mvmedrec=",REDIRECT
            APPEND    MVMEDREC,REDIRECT
            APPEND    "&defstatd=1",REDIRECT               *T0874934
            APPEND    SP70,REDIRECT
            RESET     REDIRECT
            REP       "+ ",URNUMBER
            REP       "+ ",ADMISSNO
          ENDIF

WEBWAR30  PACK      REDIRECT,REDIRECT,SP70
          WRITE     HTMLFILE;" if (self.name.match(/PopUpFrame/)) {":
                             "  redirectParentFrame(#"",REDIRECT,"#");}":
                             " else {":
                             "  location.href=#"",REDIRECT,"#"}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      WEBWAR99
.
WEBWAR90  PACK      FILNAM,HTMLDIR,WEBPID,HTMLEXT,SP70
          SQUEEZE   FILNAM
          MOVE      ZERO,OVRCD
          MOVE      SP70,KEY60
          TRAP      OVERCOND GIVING KEY60 IF IO
          OPEN      HTMLFILE,FILNAM,WRONLY
          TRAPCLR   IO
          MOVE      OVRCD,EXIT
          BRANCH    EXIT,WEBWAR99
.
          WRITE     HTMLFILE;"Content-Type: application/json+fhir",012:
                             "Cache-Control: no-cache",012:
                             "Location: %BASEURL/",FHIRLOCH,012,012;
         
.        
          WRITE     HTMLFILE;*+,"{ #"resourceType#": #"OperationOutcome#",";
.                    " #"extension#": [":
.                    " { #"url#":#"%BASEURL/extension/webPASService#"":
.                        " ,#"valueString#":#"",PRGID,SP1,PRGNAM,SP1,VERSION,"#"},":
.                    " { #"url#":#"%BASEURL/extension/webPASTemplate#"":
.                        " ,#"valueString#":#"%TEMPLATEHOME/",WBTPFIL," %TEMPLATEVERSION#"}":
.                    " ],";
          COMPARE   ZERO,WARCOUNT
          GOTO      WEBWAR93 IF EQUAL
.
          MOVE      ONE,COUNTER
          WRITE     HTMLFILE;*+," #"id#": #"warnings#", ":
                    "  #"text#": { ":
                    "    #"status#": #"additional#", ":
                    "    #"div#": #"<div>Warnings</div>#" ":
                    "  } ";
WEBWAR92  WRITE     HTMLFILE;*+,"  ,#"issue#": [ { ":
                    "      #"severity#": #"warning#", ":
                    "      #"code#": #"warning#", ":
                    "      #"details#": { ":
                    "        #"text#": #"",WEBWARNG[COUNTER],"#"":
                    "     } } ] ";
          ADD       ONE,COUNTER
          COMPARE   COUNTER,WARCOUNT
          GOTO      WEBWAR94 IF LESS
          GOTO      WEBWAR92
.
WEBWAR93  WRITE     HTMLFILE;*+," #"id#": #"allok#", ":
                    "  #"text#": { ":
                    "    #"status#": #"additional#", ":
                    "    #"div#": #"<div>All OK</div>#" ":
                    "  } ":
                    "  ,#"issue#": [ { ":
                    "      #"severity#": #"informational#", ":
                    "      #"code#": #"informational#", ":
                    "      #"details#": { ":
                    "        #"text#": #"All Ok#"":
                    "     } } ] ";
.
WEBWAR94  WRITE     HTMLFILE;*+," }"  
.
          CALL      CLOSHTML     * End of Document
          GOTO      WEBWAR99
.
WEBWAR95  DISPLAY   "*** Fifo Not Found ***"
          GOTO      WEBWAR99
.
WEBWAR99  RETURN
+
.------------------------------------------------------------
. OUTWAR00 - Display Warnings
.------------------------------------------------------------
.
OUTWAR00  CALL      OPENHTML
          BRANCH    EXIT,OUTWAR95
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             "src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             "src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#"> ":
          "var Red=GetOutCookie('",REDIRECT,"','",REDIREC1,"','MultipleHCP');"
.
          COMPARE   ZERO,WARCOUNT
          GOTO      OUTWAR20 IF EQUAL
.
          MOVE      ONE,COUNTER
OUTWAR10  WRITE     HTMLFILE;"    alert(#"",WEBWARNG[COUNTER],"#");",012
          ADD       ONE,COUNTER
          COMPARE   COUNTER,WARCOUNT
          GOTO      OUTWAR20 IF LESS
          GOTO      OUTWAR10
.
OUTWAR20  COMPARE   ONE,WAITFLAG
          GOTO      OUTWAR30 IF EQUAL
.
          COMPARE   TWO,WAITFLAG
          GOTO      OUTWAR30 IF EQUAL
.
          MATCH     "1",SERIFLAG            * Sigle HCP series
          GOTO      OUTWAR30 IF EQUAL
.
          WRITE     HTMLFILE;" if (self.name.match(/PopUpFrame/)) {":
                             " redirectParentFrame(Red); }":
                             " else {":
                             "  location.href=Red;}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      OUTWAR99
.
OUTWAR30  MOVE      REDIRECT,REDIR254
          STRIP     REDIR254
          ENDSET    REDIR254
          APPEND    REDIREC1,REDIR254
          RESET     REDIR254
.
          WRITE     HTMLFILE;" if (self.name.match(/PopUpFrame/)) {":
                             "  redirectParentFrame(#"",REDIR254,"#");}":
                             " else {":
                             "  location.href=#"",REDIR254,"#"}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      OUTWAR99
.
OUTWAR95  DISPLAY   "*** Fifo Not Found ***"
.
OUTWAR99  RETURN
+
.------------------------------------------------------------
. UPPRE000 - Update Pre-Admission
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.                  2 = Ok to continue with warning
.------------------------------------------------------------
.
UPPRE000  CALL      VALDWB00                * Validate Ward Bed
          BRANCH    EXIT,UPPRE910
.
          CALL      VALDPO00                * Validate Post OP Ward Bed
          BRANCH    EXIT,UPPRE910
.
          CALL      INIVAR00                * Initialise variables
.
          BRANCH    PREADBOK,UPPRE010
.
.         Pre-Admit by U/R Number
.
          MOVE      TWO,XOPTION             * Pre-admit by U/R Number
          CALL      URDET000                * get the U/R Details
          BRANCH    EXIT,UPPRE910,UPPRE920  * Invalid U/R Number
.
          CALL      GPAD0000                * Get previous admission
          GOTO      UPPRE020
.
.         Pre-Admit by Booking Number
.
UPPRE010  MOVE      ONE,XOPTION             * Pre-Admit by Booking
          CALL      CHKB0000                * Check Booking
          BRANCH    EXIT,UPPRE910
.
          CALL      RSETB000                * Reset defaults from booking system
.
UPPRE020  CALL      UPDMAS00                * Move mast cgi param into mast vars
          CALL      UPVPMI00                * Move mast ext2 parm into file vars
          CALL      CHKDOB00                * Check Admitting not b4 DOB
          BRANCH    EXIT,UPPRE910
.
          CALL      PPMI0000                * Post PMI details
          BRANCH    EXIT,UPPRE910
.
          CALL      PREG0000
          BRANCH    EXIT,UPPRE910
.
          MOVE      "N",PTMICMXP
          LOAD      PTMICMXP,PTCNCMYN,ANSY   * Default for C/P from paramter
          CALL      UPDMIS00                * Move miss cgi param into miss vars
          IF        ADMITBOX=1
            CALL      GBED0000
            BRANCH    EXIT,UPPRE910
          ENDIF
.
          MATCH     "1",PTCNXCOM
          IF        !@EQUAL
            CALL      RESCLM00
            BRANCH    EXIT,UPPRE910
          ENDIF
.
          CALL      PPRE0000                * Post pre-admission details
          BRANCH    EXIT,UPPRE910
.
          MOVE      AADMNO,ADMISSNO
          CALL      WRNZP000               * write NZ procedure details
.
          CALL      UUPTMAS1                * Unlock Master
          CALL      UUPTMIS1                * Unlock Admission
          CALL      EMER0000                * Update Emergency if Required
.
.          MATCH     "1",PTCNUNET
.          IF        @EQUAL
.            MOVE      "01",KEY2                 * IHI Validation
.            PACK      KEY11,WBSEUID,SP70        * User ID
.            PACK      KEY50,URNUMBER,SP70
.            CALL      WIPL0000                  * Write to polling table
.          ENDIF
.
          IF        NOMESSAG<>1
            MOVE      "Patient Pre-Admitted Successfully",WEBTITLE
            ADD       ONE,WARCOUNT
            MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
          ENDIF
.
          MATCH     SP70,SVHAONPR
          IF        !@EQUAL
            MOVE      "1",SVHAWBWR
          ENDIF
.
          IF        RECURRFL=1
            CALL      RECATR00 
          ELSE
            CALL      PRVS0000                * Check for Previous visit
          ENDIF
.
          COMPARE   ONE,ADMITBOX
          GOTO      UPPRE920 IF NOT EQUAL
.
          MOVE      ONE,PRECOMPL          * Pre-Admission Complete
          MOVE      ZERO,EXIT
          GOTO      UPPRE999
.
UPPRE910  MOVE      ONE,EXIT
          GOTO      UPPRE999
.
UPPRE920  MOVE      TWO,EXIT
.
UPPRE999  RETURN
+
.------------------------------------------------------------
. RSETB000 - Reset defaults available from booking system
.------------------------------------------------------------
.
RSETB000  MOVE      BKREURNO,AURNO                * U/R Number
          MOVE      BKRECLSS,ACLSS                * Patient Category/Classificat
          MOVE      BKREATYP,ATYPE                * Admission Type/Specialty
          MOVE      BKREDEPT,ACLSSFT              * Department
          MOVE      BKREADOC,ADOCTA               * Attending Doctor
          LOAD      ADOCTT,CASSOCD,BKRETDOC       * Associated Doctor
          MOVE      BKRECLMT,ACLAIM               * Claim Type/Admin Cat.
          MOVE      BKRXASRC,ASRCE                * Default Referral Source
          MOVE      BKRXUDF5,PMVXIDUS             * Intended stay
.... D CAR 39616
.         MATCH     SP70,BKREWARD
.         IF        @EQUAL
.           MOVE      BKRXPOWD,EMVIEWRD
.         ELSE
.           MOVE      BKREWARD,EMVIEWRD             * Expected Ward
.         ENDIF
... END D CAR 39616
          MOVE      BKREEBED,ABED                 * Expected Bed
... I CAR 39616
          IF        PTCNDWAW=0
            MOVE      BKRXPOWD,EMVIEWRD
            MOVE      BKRXPOBD,EMVIEBED
            MOVE      BKRXPOBD,ABED
          ELSE
            MOVE      BKREWARD,EMVIEWRD             * Expected Ward
            MOVE      BKREEBED,EMVIEBED
            MOVE      BKREEBED,ABED                 * Expected Bed
          ENDIF
.... END I CAR 39616
.  Added below 2 if statements for CAR  295474 - stv fill in post op ward on
. theatre but expected ward on bookings (day oncology)
          MATCH     SP70,EMVIEWRD
          IF        @EQUAL
            MOVE      BKREWARD,EMVIEWRD             * Expected Ward
            MOVE      BKREEBED,EMVIEBED
            MOVE      BKREEBED,ABED                 * Expected Bed
          ENDIF
.
          MATCH     SP70,EMVIEWRD
          IF        @EQUAL
            MOVE      BKRXPOWD,EMVIEWRD             * Expected Ward
            MOVE      BKRXPOBD,EMVIEBED
            MOVE      BKRXPOBD,ABED
          ENDIF
.
          MOVE      BKREGPFA,PTMSFHAN             * GPFH Approval Number
          MOVE      BKREECRA,PTMSECRA             * ECR Approval Number
          MOVE      BKREGPPC,PMVXRH1G             * GP Practice code
          MOVE      BKRERFGP,PMVXRHC1             * Referring GP
          MOVE      BKREELOS,ASTAY                * Expected Length of Stay
          MOVE      BKREEATY,ACARE                * Cat CC
          MOVE      BKRESDOC,ADOCTR               * Referring Doctor
          MATCH     BKREEDAT,ADATE
          IF        !@EQUAL
            MOVE      BKREEDAT,ADATE              * Expected Due Date
            MOVE      SP70,PTMIDMOV              * If pre adm date changed reset
          ENDIF                                  * mr pulled flag
.
          MOVE      BKREATIM,ATIME                * Expected Time
          MOVE      BKREDOFR,PTMIDOFR             * District of residence
          CALL      MBDEF000                      * Default ambs code
.
          CALL      GXDF0000                      * get extra default data
.
          MOVE      BKRXADWD,PMVXAPWD
.
.   * new defaults for CAR 164652
.
          MOVE      BKRXPOWD,PMVXPOWD
          MOVE      BKRXPOBD,PMVXPOBD
          MOVE      BKRXPSTY,PMVXPSTY
          MOVE      BKRXFORM,PMVXFRMS
          MOVE      BKRXEDC1,PMVXEDC1
          MOVE      BKRXEDC2,PMVXEDC2
          MOVE      BKRXEDC3,PMVXEDC3
          MOVE      BKREACCM,PMVXPACC
.
....      CALL      MY6KB000
.
          IF        CFEETYP=5
            CALL      NZDEF000
            MATCH     SP70,BKREPROC
            GOTO      RSETB999 IF EQUAL
            GOTO      RSETB100
          ENDIF
.
          MATCH     SP70,BKREPROC
          GOTO      RSETB999 IF EQUAL
.
          MOVE      BKREPROC,AMBS
.
RSETB100  OPEN      WATTX1A1,"wattx1af"
          PACK      KEY19,URNUMBER,BKREPROC,DBKRECNT,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,RSETB999
          CALL      RDWTTX11
          BRANCH    OVRCD,RSETB999
          CLOSE     WATTX1A1
.
          MOVE      WMSTAY,ASTAY
          MOVE      WTWMPHSP,PTMIPHPU
          MATCH     SP70,ASRCE
          IF        @EQUAL
            MOVE      WTWMSRCR,ASRCE                 * Referral Source
          ENDIF
.
          MATCH     SP70,ACLSS
          IF        @EQUAL
            MOVE      WTWMCLSS,ACLSS            * Patient Category/Classificat
          ENDIF
.
          MATCH     SP70,ACLSS
          GOTO      RSETB200 IF NOT EQUAL
.
          MOVE      "P ",CATEGORY
          PACK      KEY5,CATEGORY,SP70
          CALL      RDSCODE1
RSETB150  CALL      RDKCODE1
          BRANCH    OVRCD,RSETB200
.
          MATCH     CATEGORY,TCODE
          GOTO      RSETB200 IF NOT EQUAL
.
          MATCH     "3",THCSCOD
          GOTO      RSETB150 IF NOT EQUAL
          PACK      ACLSS,ACODE,SP70
.
RSETB200  MATCH     SP70,PMVXRH1G
          IF        @EQUAL
            MOVE      WTTXRCLP,PMVXRH1G             * GP Practice code
          ENDIF
.
          MATCH     SP70,PMVXRHC1
          IF        @EQUAL
            MOVE      WTTXRCLI,PMVXRHC1             * Referring GP
          ENDIF
.
          MATCH     SP70,PMVXRH1C
          IF        @EQUAL
            MOVE      WTWMGPPT,PMVXRH1C             * Referring GP Count
          ENDIF
.
          MATCH     SP70,PMVXRH1C
          IF        @EQUAL
            MOVE      WTWMGPPT,PMVXRH1C             * Referring GP Count
          ENDIF
.
          MATCH     SP70,PMVXTEAM
          IF        @EQUAL
            MOVE      WTTXTEAM,PMVXTEAM             * Team
          ENDIF
.
          MATCH     SP70,ACARE
          IF        @EQUAL
            MOVE      WTWMEATY,ACARE               * Care type
          ENDIF
.
          MATCH     SP70,ATYPE
          IF        @EQUAL
            MOVE      WMPCAT,ATYPE                 * Category A
          ENDIF
.
          MATCH     SP70,PMVXIDUS
          IF        @EQUAL
            MOVE      WTTXINTD,PMVXIDUS            * Intended Stay
          ENDIF
.
          MATCH     SP70,ADIAG1
          IF        @EQUAL
            MOVE      WMREASON,ADIAG1            * Diagnosis
          ENDIF
.
          MATCH     SP70,PMVXPACC
          IF        @EQUAL
            MOVE      WTTXPREF,PMVXPACC            * Preferred Accomm.
          ENDIF
.
          MATCH     SP70,PMVXEDDT
          IF        @EQUAL
            MOVE      WTTXEXPD,PMVXEDDT            * Expected delivery date
          ENDIF
.
          MATCH     SP70,PMVXFSRC
          IF        @EQUAL
            MOVE      WTTXFUND,PMVXFSRC            * Funding Source
          ENDIF
.
          MATCH     SP70,PMVXNWHC
          IF        @EQUAL
            MOVE      WTTXNWHC,PMVXNWHC            * Non WA Contact
          ENDIF
.
          MOVE      WTTXNTGP,PMVXINGP            * Inform GP
.
RSETB999  RETURN
+
.------------------------------------------------------------
. NZDEF000 - Get NZ Private default values
.------------------------------------------------------------
NZDEF000  PACK      OPDAPROV,SP70
          PACK      OPDAPRV2,SP70
          PACK      OPDAPRV3,SP70
          PACK      KEY31,ADMISSNO,SP70
          CALL      RSOPDEA2
          CALL      RKOPDEA2
          BRANCH    OVRCD,NZDEF999          * not a theatre booking
.
          MATCH     ADMISSNO,DBKREBOO
          GOTO      NZDEF999 IF NOT EQUAL
.
          PACK      AMBS,OPDAPROV,SP70
          PACK      NZSPPDES,OPDADES1,SP70
.
          MATCH     SP70,NZSPPDES
          GOTO      NZDEF999 IF NOT EQUAL
.
          COMPARE   TWO,OPCNCPOD
          GOTO      NZDEF999 IF NOT EQUAL
.
          MATCH     SP70,OPDAPROV
          GOTO      NZDEF999 IF EQUAL
.
          PACK      KEY17,OPDAPROV,OPDADATE,SP70
          CALL      PATITMRD
          IF        OVRCD<>1
            PACK      NZSPPDES,IDESC
          ENDIF
.
NZDEF999  RETURN
.------------------------------------------------------------
. MBDEF000 - Get the default ambs code
.------------------------------------------------------------
MBDEF000  PACK      OPDAPROV,SP70
          PACK      OPDAPRV2,SP70
          PACK      OPDAPRV3,SP70
.
          PACK      KEY31,ADMISSNO,SP70
          CALL      RSOPDEA2
          CALL      RKOPDEA2
          BRANCH    OVRCD,MBDEF999          * not a theatre booking
.
          MATCH     ADMISSNO,OPDAADMN
          GOTO      MBDEF999 IF NOT EQUAL
.
          PACK      AMBS,OPDAPROV,SP70
.
          MOVE      OPDAAPRC,PMVXADMP       * Adm paperword received
          MATCH     ANSY,OPDACSST
          IF        @EQUAL
            MOVE      ONE,PMVXCONO          * Consent form received
          ENDIF
          MOVE      OPDAMHRC,PMVXMEDH       * Medical history received
.
MBDEF999  RETURN
+
.------------------------------------------------------------
. VALDWB00 - Validate Ward Bed
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
.
VALDWB00  MATCH     SP70,ACLAIM
          GOTO      VALDWB10 IF EQUAL
.
          PACK      KEY5,ANSC,ANSL,ACLAIM,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,VALDWB93
.
          MATCH     ANSI,PTCOACTV
          GOTO      VALDWB93 IF EQUAL
.
VALDWB10  MATCH     SP70,PTMIS068                * Expected ward populated
          GOTO      VALDWB90 IF EQUAL
          GOTO      VALDWB90 IF EOS
.
          MATCH     Z70,PTMIS068
          GOTO      VALDWB90 IF EQUAL
.
          MATCH     SP70,PTMIS076                * Expected bed populated
          GOTO      VALDWB80 IF EQUAL
          GOTO      VALDWB80 IF EOS
.
          MATCH     Z70,PTMIS076
          GOTO      VALDWB80 IF EQUAL
.
          PACK      KEY6,PTMIS068,PTMIS076,SP70  * Validate ward and bed
          CALL      RDWARD1
          BRANCH    OVRCD,VALDWB92
.
          GOTO      VALDWB90
.
VALDWB80  PACK      KEY6,PTMIS068,SP70           * Validate ward only
          CALL      RDWARD1
          BRANCH    OVRCD,VALDWB91
.
VALDWB90  MOVE      ZERO,EXIT
          GOTO      VALDWB99
.
VALDWB91  MOVE      "Invalid Expected Ward",WEBTITLE
          CALL      ADMERR00
          MOVE      ONE,EXIT
          GOTO      VALDWB99
.
VALDWB92  MOVE      "Invalid Expected Ward/Bed",WEBTITLE
          CALL      ADMERR00
          MOVE      ONE,EXIT
          GOTO      VALDWB99
.
VALDWB93  MOVE      "Invalid Claim Code",WEBTITLE
          CALL      ADMERR00
          MOVE      ONE,EXIT
          GOTO      VALDWB99
.
VALDWB99  RETURN
+
.------------------------------------------------------------
. VALDPO00 - Validate Post Op Ward Bed
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
.
VALDPO00  MATCH     SP70,PTVIS048                * Post Op ward populated
          GOTO      VALDPO90 IF EQUAL
          GOTO      VALDPO90 IF EOS
.
          MATCH     Z70,PTVIS048
          GOTO      VALDPO90 IF EQUAL
.
          MATCH     SP70,PTVIS049                * Post Op bed populated
          GOTO      VALDPO80 IF EQUAL
          GOTO      VALDPO80 IF EOS
.
          MATCH     Z70,PTVIS049
          GOTO      VALDPO80 IF EQUAL
.
          PACK      KEY6,PTVIS048,PTVIS049,SP70  * Validate Post Op ward and bed
          CALL      RDWARD1
          BRANCH    OVRCD,VALDPO92
.
          GOTO      VALDPO90
.
VALDPO80  PACK      KEY6,PTVIS048,SP70           * Validate ward only
          CALL      RDWARD1
          BRANCH    OVRCD,VALDPO91
.
VALDPO90  MOVE      ZERO,EXIT
          GOTO      VALDPO99
.
VALDPO91  MOVE      "Invalid Post Op Ward",WEBTITLE
          CALL      ADMERR00
          MOVE      ONE,EXIT
          GOTO      VALDPO99
.
VALDPO92  MOVE      "Invalid Post Op Ward/Bed",WEBTITLE
          CALL      ADMERR00
          MOVE      ONE,EXIT
          GOTO      VALDPO99
.
VALDPO99  RETURN
+
.------------------------------------------------------------
. Post the PMI details - From PATPRG31
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
.
PPMI0000  COMPARE   THREE,PSTAT             * Master not yet allocated ?
          GOTO      PPMI6000 IF EQUAL       * yes
.
          MATCH     ZEROUR,PURNO            * U/R=0 ?
          GOTO      PPMI6000 IF EQUAL       * yes
.
          CALL      PMIA0000                * update PMI Audit file
.
          CALL      VALP0000                * PRS2 validation for pmi
          BRANCH    EXIT,PPMI9100
.
.         MOVE      SP8,PTMX3BEX
          PACK      KEY8,PURNO,SP10
          CALL      RDAMAST1
          CALL      UPMAST1                 * update Master with Latest
          CALL      UUPTMAS1
.
          MATCH     ZEROVISN,AADMNO         * Only do this if by admission#
          GOTO      PPMI9000 IF EQUAL
.
          MATCH     SP70,PMEDI
          IF        !@EQUAL
            MATCH     SP70,PTMXMCCD
            IF        @EQUAL
...           MOVE      "Warning: No medicare reference entered.",WEBTITLE
...           CALL      WEBERR00
            ENDIF
          ENDIF
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      THREE,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICUP                * send details to Datagate *C-90223
.
          MOVE      PTMXLS,SAVLEGST         * save for posting (srf 611204)
          MOVE      PTMXLSDT,SAVLSDAT
.
          MOVE      AADMNO,PVIBILL
.
          IF        PCEASE=ONE
            MOVE      AADMNO,DIM8
            CALL      DEAPOL00              * Update the Death Polling Table
            MOVE      DIM8,KEY8
            CALL      RDMISS1
          ENDIF
.
          CALL      UPCOMCRD                 * Update Community Card
.
.         Check if there has been a change of address
.
          CALL      CHAD0000                * change of addess ?
          COMPARE   ONE,PREVADDR
          GOTO      PPMI2000 IF NOT EQUAL   * no
.
. If this is the first change for today, write the previous address
. to the Previous Address file and update any further changes
.
          CALL      UPAD0000
.
. Update the surname file
.
PPMI2000  MOVE      BKREBOOK,ADMISNO        * save the booking number
          CALL      UPDSUR                  * Update any name changes (PATCOMN2)
          MOVE      ADMISNO,BKREBOOK        * restore the booking number
.
. Post the changes to the audit file if necessary
.
          BRANCH    CAUDM,PPMI2500          * audits turned on?
          MOVE      ANSB,ACTION
          CALL      WRMAUD
          MOVE      "CM",ACTION
          CALL      AMSV0000                * save Master file vars.
          CALL      WRMAUD
.
PPMI2500  MATCH     ZEROVISN,AADMNO
          GOTO      PPMI8500 IF EQUAL
.
. Don't post P.R.A details for pre-admission bookings yet.
.
          COMPARE   ONE,CBOOK               * using Booking option ?
          GOTO      PPMI3000 IF NOT EQUAL
          BRANCH    XOPTION,PPMI8500,PPMI3000,PPMI3000,PPMI3000,PPMI8500
.
PPMI3000  PACK      KEY8,ADMISSNO,SP70
          CALL      RDRESP1
          IF        OVRCD=1
            CALL      CLPATRE1              * Clear PRFA variables
          ENDIF
.
          CALL      PRAV0000                * save keyin-ed variables
          MOVE      AADMNO,PKADMN
          MOVE      PKADMN,KEY8
.
          MATCH     ADMISNID,SP70           * Update PRFA for eAdmission 286548
          IF        !@EQUAL
            CALL      UPDPRA00              * move pra cgi params into vars
            GOTO      PPMI3200
          ENDIF
.
.         restore SFORMATted variables after opening patrespf
.
          MOVE      SPKADD1,PKADD1
          MOVE      SPKADD2,PKADD2
          MOVE      SPKSUBR,PKSUBR
          MOVE      SPKPOST,PKPOST
          MOVE      SPKTELP,PKTELEP
          MOVE      SPKTELB,PKTELEB
          MOVE      SPKRELP,PKRELP
          MOVE      SPKMOBL,PTREMOBL
.
PPMI3200  MATCH     "1",PTCNNEWC            * using new contacts ?
          IF        @EQUAL
            CALL     UPRF0000               * Get Contact for Usual PRFA
          ENDIF
.
          MATCH     SP70,PKNAME             * if no name don't write a record
          GOTO      PPMI4000 IF EQUAL
.
          CALL      RDARESP1
          BRANCH    OVRCD,PPMI3500
          CALL      UPRESP1
.
          GOTO      PPMI8500
.
PPMI3500  CALL      WRRESP1
          GOTO      PPMI8500
.
PPMI4000  CALL      RDRESP1
          IF        OVRCD=1
            CALL      CLPATRE1              * Clear PRFA variables
            GOTO      PPMI8500
          ENDIF
          CALL      DERESP1
          GOTO      PPMI8500
.
. updating pre-admission data
.
PPMI6000  MOVE      AADMNO,KEY8
          MOVE      AADMNO,PURNO            * Pram use AADMNO as PURNO
.
          CALL      RDAPRAM1
          CALL      UPPRAM1
.
          MOVE      ZEROUR,PURNO
.
. Update the Surname Index File if necessary
.
          MOVE      BKREBOOK,ADMISNO        * save the booking number
          CALL      UPDSUR                  * update any name changes (PATCOMN2)
          MOVE      ADMISNO,BKREBOOK        * restore the booking number
.
          MOVE      AADMNO,PKADMN
          MOVE      PKADMN,KEY8
.
. Handle Person Responsible for Account file (P.R.A)
. Don't post P.R.A details for pre-admission bookings yet.
.
          BRANCH    XOPTION,PPMI8500,PPMI6500,PPMI6500,PPMI6500,PPMI8500
.
PPMI6500  MATCH     "1",PTCNNEWC            * using new contacts ?
          IF        @EQUAL
            CALL     UPRF0000               * Get Contact for Usual PRFA
          ENDIF
.
          MATCH     SP70,PKNAME             * If no name don't write a record
          GOTO      PPMI8000 IF EQUAL
.
          CALL      RDARESP1
          BRANCH    OVRCD,PPMI7000
          CALL      UPRESP1
          GOTO      PPMI8500
.
PPMI7000  CALL      WRRESP1
          GOTO      PPMI8500
.
PPMI8000  CALL      RDRESP1
          IF        OVRCD=1
            CALL      CLPATRE1       * Clear PRFA variables
            GOTO      PPMI8500
          ENDIF
          CALL      DERESP1
.
PPMI8500  CALL      UPRI0000         * Update private practice prfa
.
PPMI9000  MOVE      ZERO,EXIT
          GOTO      PPMI9999
.
PPMI9100  MOVE      ONE,EXIT
.
PPMI9999  RETURN
+
.***********************************************************************
.* VALP0000 - Routine for PRS2 validations before updating pmi         *
.* Returns:  EXIT   0 = Ok to continue                                 *
.*                  1 = Error                                          *
.***********************************************************************
.
VALP0000  COMPARE   THREE,PTCNHDPS
          GOTO      VALP9000 IF NOT EQUAL   * Not in Victoria
.
          CALL      CHKLAN00                * check interpreter/language
          BRANCH    EXIT,VALP9900
.
          UNPACK    PBDATE,CCENT,CYEAR,CMON,CDAY
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          CALL      CALCAGE
          COMPARE   TEN4,PSAGEYRS
          GOTO      VALP9000 IF NOT LESS
.
          PACK      PMSTAT,PMSTAT,SP70
          MATCH     SP70,PMSTAT
          GOTO      VALP9000 IF EQUAL
.
          PACK      KEY5,ANSM,SP1,PMSTAT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,VALP9100
.
          UNPACK    THCSCOD,DIM1A,DIM1
          TYPE      DIM1                         * is HPD Equiv numeric ?
          GOTO      VALP9100 IF NOT EQUAL        * no
          MATCH     "1",DIM1
          GOTO      VALP9100 IF NOT EQUAL
.
VALP9000  MOVE      ZERO,EXIT
          GOTO      VALP9999
.
VALP9100  MOVE      "Invalid Marital status",WEBTITLE
          CALL      WEBERR00
VALP9900  MOVE      ONE,EXIT
          GOTO      VALP9999
.
VALP9999  RETURN
.
+
.***********************************************************************
.* CHOS0000 - Check for multi hospital processing. The user id must    *
.*            have a hospital to create medical records from.          *
.* Returns:  EXIT   0 = Ok to continue                                 *
.*                  1 = Error                                          *
.***********************************************************************
.
CHOS0000  COMPARE   ONE,IBCNMHOS            * Using multi hospital
          GOTO      CHOS9000 IF NOT EQUAL
.
          BRANCH    TEMPORAR,CHOS9000,CHOS9000 * dont create medical record for
.                                            temporary UR
          COMPARE   ONE,CRMEDREC         * Create MR checkbox - Yes
          GOTO      CHOS1000 IF EQUAL
.
          COMPARE   ONE,MRCNACRR
          GOTO      CHOS9000 IF NOT EQUAL
.
CHOS1000  MATCH     SP70,WBSEHOSP
          GOTO      CHOS9100 IF EQUAL
.
CHOS9000  MOVE      ZERO,EXIT
          GOTO      CHOS9999
.
CHOS9100  CLEAR     WEBTITLE
          APPEND    "Please select a hospital ID before processing ",WEBTITLE
          APPEND    "new registrations.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHOS9999
.
CHOS9999  RETURN
+
.***********************************************************************
.* CHKLAN00 - Routine for PRS2 validations (interpreter/language)      *
.* Returns:   EXIT  0 = Ok to continue                                 *
.*                  1 = Error                                          *
.***********************************************************************
.
CHKLAN00  MATCH     SP70,PMPXLNG1
          GOTO      CHKLAN90 IF EQUAL
.
          PACK      KEY5,ANSL,ANSA,PMPXLNG1,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CHKLAN90
.
          MATCH     "19",THCSCOD
          GOTO      CHKLAN10 IF NOT EQUAL
.
          MATCH     "0",PMPXINTR
          GOTO      CHKLAN91 IF NOT EQUAL
.
CHKLAN10  MATCH     "98",THCSCOD
          GOTO      CHKLAN90 IF NOT EQUAL
.
          MATCH     SP70,PMPXINTR
          GOTO      CHKLAN95 IF NOT EQUAL
.
CHKLAN90  MOVE      ZERO,EXIT
          GOTO      CHKLAN99
.
CHKLAN91  CLEAR     WEBTITLE
          APPEND    "Preferred Language 1 is English, Interpreter ",WEBTITLE
          APPEND    "Required Invalid",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKLAN99
.
CHKLAN95  CLEAR     WEBTITLE
          APPEND    "Preferred Language Not Stated, Interpreter ",WEBTITLE
          APPEND    "Required Invalid",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKLAN99
.
CHKLAN99  RETURN
+
.----------------------------------------------------------------------------
. PREG0000 - Alloc U/R# & post dets if Pat. Regist screen on - From PATPRG31
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.----------------------------------------------------------------------------
.
PREG0000  COMPARE   ONE,PTCNPREG            * Using Registration Screen
          GOTO      PREG9000 IF NOT EQUAL
.
          IF        XOPTION >= 5 & XOPTION <=8
            GOTO      PREG9000               * Mental Health Stuff
          ENDIF
.
          MATCH     ZEROUR,PURNO            * Check if adding
          GOTO      PREG1000 IF NOT EQUAL
.
          GOTO      PREG9000
.
PREG1000  CALL      UPAD0000                * Update Previous Address File
          CALL      UPMI0000                * Update PMI Audit
          CALL      UMAS0000                * Update Master File
          BRANCH    EXIT,PREG9100
.
          CALL      UPCOMCRD                * Update Community Card
          BRANCH    CAUDM,PREG9000          * Check Audit is on
.
          MOVE      "B",ACTION              * Set Audit Action to Before Change
          CALL      WRMAUD                  * Write Audtis
          MOVE      "C",ACTION              * Set Audit Action to After Change
          CALL      ACTMSAV                 * Move in New Audit Fields
          CALL      WRMAUD
.
PREG9000  MOVE      ZERO,EXIT
          GOTO      PREG9999
.
PREG9100  MOVE      ONE,EXIT
.
PREG9999  RETURN
+
.------------------------------------------------------------
. PPRE0000 - Pre-adm details
. Returns:    EXIT  0 = Ok to continue
.                   1 = Error
.------------------------------------------------------------
.
PPRE0000  MOVE      SP3,ABED
          MOVE      SP3,AWARD
.
. get booking options only
.
          BRANCH    PREADBOK,PPRE1000
.
PPRE0200  MATCH     ZEROUR,PURNO            * zero U/R?
          GOTO      PPRE0500 IF NOT EQUAL
.
. we require a U/R so generate one
.
          BRANCH    CGENRUR,PPRE0500,PPRE0900 * computer generate U/R ?
.
.         Don't generate a U/R Number
.
PPRE0500  CALL      NXTA0000                * get next admission number
          MOVE      PURNO,AURNO
          GOTO      PPRE2000
.
.         Generate a U/R Number
.
PPRE0900  CALL      NXTA0000
          MOVE      THREE,CPSYSTEM
          CALL      GNXTUR
          MOVE      PURNO,AURNO
          GOTO      PPRE2000
.
.         Booking Option(s) only
.
PPRE1000  MOVE      BKREBOOK,KEY8
          CALL      RDBKREC1                * Re-read booking record
          BRANCH    OVRCD,PPRE9100
.
          MOVE      BKREURNO,AURNO          * Waiting Lists
          MOVE      BKREURNO,PURNO          * Waiting Lists
.
          MATCH     ZEROUR,BKREURNO         * U/R = 0?
          GOTO      PPRE1400 IF NOT EQUAL   * no
.
          BRANCH    CGENRUR,PPRE1400,PPRE1200 * Computer generate U/R No. ?
          GOTO      PPRE1400
.
PPRE1200  MOVE      THREE,CPSYSTEM          * get the next Inpatient U/R
          CALL      GNXTUR
.
          MATCH     ZEROVISN,AADMNO             * is this a booking ?
          IF        @EQUAL
            MOVE      BKREBOOK,KEY8
          ELSE
            MOVE      AADMNO,KEY8
          ENDIF
.
          CALL      DEPRAM1                 * remove record from patpramf
          CALL      DPNI0000                * remove PATPNI
.
          MOVE      BKREBOOK,KEY8           * update Booking record
          CALL      RDBKREC1
          MOVE      PURNO,BKREURNO
          CALL      UPBKREC1
.
          MOVE      PURNO,AURNO
.
PPRE1400  MOVE      BKREBOOK,AADMNO         * Booking system
          MOVE      ONE,ASTAT               * Pre-Admission status
          CALL      UBOK0000                * fix booking status
.
PPRE2000  MOVE      ONE,ASTAT
          MATCH     Z70,PTMIS036
          IF        @EQUAL
            MOVE      ZERO,APLUR            * make sure it isnt a baby pat
          ENDIF
. Removed lines below for CAR 289926
...       CALL      UPDPRA00                * move pra cgi params into vars
...       CALL      UPPRA000                * Update Person Respons for Acc
.
          MATCH     ZEROUR,PURNO            * U/R = 0 ?
          GOTO      PPRE3200 IF NOT EQUAL   * no
.
          MOVE      ZEROUR,AURNO
          MOVE      AADMNO,KEY8
          MOVE      AADMNO,PURNO            * Pram use AADMNO as PURNO
          CALL      RDAPRAM1
          BRANCH    OVRCD,PPRE3000          * no Pram record found
.
          MOVE      TRUE,PRAEXIST           * Admission Number Existed
          CALL      UPPRAM1                 * Update pram file
          MOVE      AADMNO,PVIBILL
          MOVE      ZEROUR,PURNO
.
          CALL      SIPR0000                * see if patient registered
          BRANCH    EXIT,PPRE4600           * patient registered on national
.
          CALL      PNMP0000                * post NMPI Number
          GOTO      PPRE5000
.
.         use AADMNO Number as U/R no in key of pre - ads
.
PPRE3000  MOVE      THREE,PSTAT             * U/R not yet allocated
          CALL      WRPRAM1
          MOVE      FALSE,PRAEXIST          * Admission Number did not exist
          MOVE      AADMNO,PVIBILL
          MOVE      ZEROUR,PURNO
.
          CALL      SIPR0000                * see if patient registered
          BRANCH    EXIT,PPRE4600           * patient registered on national
.
          CALL      PNMP0000                * post NMPI Number
.
.         Update Surname Index file
.
PPRE3100  CALL      UZDS0000                * Update surname file with UR=0
          GOTO      PPRE5000
.
.         Write or update the master file
.
PPRE3200  CALL      OCRD0000                * reload original kiwi card details
          CALL      UPCOMCRD                * Update Community Card
          CALL      NCRD0000                * restore new kiwi card details
.
          MOVE      PURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,PPRE4500
.
          CALL      RDPMPX21
          MOVE      ZERO,PSTAT
          MOVE      AADMNO,PVIBILL
          CALL      PNMP0000                * post to national UR file
          GOTO      PPRE5000
.
PPRE4500  MOVE      ZERO,PSTAT
          MOVE      CHOSPNUM,PINITHOS       * Initiating Hospital Number
          MOVE      AADMNO,PVIBILL          * Parameter for WRTUR
          MOVE      THREE,PVITYPE           * Parameter for WRTUR
.
          CALL      VALP0000                * PRS2 validation
          BRANCH    EXIT,PPRE9100
.
          CALL      CHOS0000                * Check Hospitla for user
          BRANCH    EXIT,PPRE9100
.
          MOVE      WBSEHOSP,PMPXIHOS
          MOVE      WBSEUID,PMPXWBID
          CALL      WRTUR                   * Write the new U/R (PATCOMN2)
          BRANCH    EXIT,PPRE9100
          CALL      CRMED000                * Create medical record
          CALL      WEXP0000                * Write expected payor details
.
PPRE4600  PACK      PUSR1,PUSR1,SP3
          MATCH     SP3,PUSR1
          IF        !@EQUAL
            MOVE      SP20,TDESC
            PACK      KEY5,ANSP,ONE,PUSR1
            CALL      RDCODE1
          ENDIF
          MOVE      AADMNO,PVIBILL
          CALL      PNMP0000                * post to National UR file
.
PPRE5000  CALL      PADM0000                * process admission details
          BRANCH    EXIT,PPRE9100
.
          PROC      ADMAUDIT                * post data to the audit file
PPRE6000  CALL      ADTD0000
.
          MOVE      ZERO,EXIT
          GOTO      PPRE9999
.
PPRE9100  MOVE      ONE,EXIT
.
PPRE9999  RETURN
+
.------------------------------------------------------------
. PADM0000 - Process Admission Details - From PATPRG31
. Returns:    EXIT   0 = Ok to continue
.                    1 = Error
.------------------------------------------------------------
.
PADM0000  IF        CFEETYP=6
            CALL      WRPR0000              * Write person response for Acc dets
          ENDIF
.
          CALL      PRAD0000
          IF        XOPTION=11
            CALL      CDST0000              * Update Admission Stats file
            BRANCH    EXIT,PADM9800
          ENDIF
.
.         Write/Update the visit extension table (so that the visit extension
.         variables are populated before any broadcast messages are sent).
.
          MOVE      ADMISSNO,SADMISSN
          MOVE      AADMNO,ADMISSNO
          CALL      UPDVIS00
          MOVE      SADMISSN,ADMISSNO
          BRANCH    EXIT,PADM9100
.
          MOVE      AADMNO,KEY8
          CALL      RAPMVX11                     * visit extension rec. found ?
          BRANCH    OVRCD,PADM0100               * no
.
          PACK      KEY6,PTMIXWRD,SP70           * set default Ward
          CALL      SVXDF000                     * set Visit Extn. defaults
.
          CALL      IBACLOCK
          MOVE      WBSEUID,PMVXWEBU
          PACK      PMVXLUPD,CCC,CYY,CMM,CDD
          REP       " 0",PMVXLUPD
          CLOCK     TIME,PMVXLUPT
          MATCH     PMSVX142,Z70
          IF        !@EQUAL
            MOVE      PMSVX142,PMVXCONM        * Contributor name
            PACK      PMVXCONM,PMVXCONM,SP70
          ENDIF
.
          MATCH     PMSVX125,Z70
          IF        !@EQUAL
            MOVE      PMSVX125,PMVXUDF7
            PACK      PMVXUDF7,PMVXUDF7,SP70
          ENDIF
.
          IF        PTCNHDPS=9 | PTCNHDPS=2
            MATCH     Z70,PTVIS105
            IF        @EQUAL
              MOVE      SP70,PMVXQASN       * Clear Contract Hospital UR
            ENDIF
          ENDIF
.
          MATCH     Z70,PMSVX146
          IF        !@EQUAL
            MOVE      PMSVX146,PMVXCASE
          ENDIF
.
          CALL      UPPMVX11                     * update the record
          GOTO      PADM0200
.
PADM0100  MOVE      ADATE,PMVXVSDT       * Visit Date
          MOVE      AADMNO,PMVXVISN
          PACK      KEY8,PMVXVISN
.
          PACK      KEY6,PTMIXWRD,SP70           * set default Ward
          CALL      SVXDF000                     * set Visit Extn. defaults
.
          MATCH     PMSVX142,Z70
          IF        !@EQUAL
            MOVE      PMSVX142,PMVXCONM        * Contributor name
            PACK      PMVXCONM,PMVXCONM,SP70
          ENDIF
.
          MATCH     PMSVX125,Z70
          IF        !@EQUAL
            MOVE      PMSVX125,PMVXUDF7
            PACK      PMVXUDF7,PMVXUDF7,SP70
          ENDIF
.
          CALL      IBACLOCK
          PACK      PMVXCDTE,CCC,CYY,CMM,CDD * current date
          REP       " 0",PMVXCDTE
          CLOCK     TIME,CTIMEIS
          MOVE      CTIMEIS,PMVXCTIM
          MOVE      WBSEUID,PMVXWEBC
.
          MATCH     Z70,PMSVX146
          IF        !@EQUAL
            MOVE      PMSVX146,PMVXCASE
          ENDIF
.
          CALL      WRPMVX11
.
.         Write/Update admission record
.
PADM0200  MOVE      AADMNO,KEY8
          CALL      RDAMISS1
          IF        OVRCD=0
            PACK      PTMIWEBU,WBSEUID,SP70
            CALL      UPMISS1
            PROC      WRWATR00             * write to wa triggers
            CALL      UUPTMIS1
            CALL      CKCLMD00             * Remove claim details if necessary
            CALL      WRCPT000             * update current patient table
            CALL      WRINT000
            IF        ASTAT<>1 & ASTAT<>5
              CALL      WIPG0000           * Write new program to patient
              PROC      WARPRG00           * Warning if program changes required
            ENDIF
.
            IF        (ASTAT <> 1) & (CHGDOCTR=1|CHGDEPT=1|CHGATYPE=1|CHGTEAM=1|CHGRSTR=1|CHGRESI=1)
              CALL      TRNUPD00
              BRANCH    EXIT,PADM9800
            ENDIF
.
            IF        ASTAT<>1 & CHGCCLSS=1
               CALL     CARUPD00             * care class changed
            ENDIF
.
.           If the patient has been pre-admitted/admitted, broadcast the change
.           of details
.
            IF        ASTAT <> 5
              CALL      PMIGTNID            * get national id for dgate write
              MOVE      NMPNUMB,PTNINMPI
              IF        ASTAT = 1
                MOVE      FOUR,HL7TRGID
                MOVE      SP8,HL7INCLD
                PROC      DGCLICCP          * broadcast change Pre-admission
              ELSE
                PACK      KEY30,AADMNO,Z70
                CALL      RDSTRAN2                     * position in file
                CALL      RDPTRAN2                     * read previous record
                IF        OVRCD=0
                  MATCH     AADMNO,TADMN               * same admission still ?
                  IF        @EQUAL
                    MOVE      FIVE,HL7TRGID
                    MOVE      SP8,HL7INCLD
                    PROC      DGCLICAC          * broadcast change admission
                  ELSE
                    CALL      CLPATTRN
                  ENDIF
                ELSE
                  CALL      CLPATTRN
                ENDIF
              ENDIF
            ENDIF
          ELSE
            MOVE      ZERO,ADSCHI
            MOVE      ZERO,AINVPRT
            MOVE      PREVADMN,PTMIPANO
            MOVE      PREVADMD,PTMIPADT
            PACK      PTMIWEBC,WBSEUID,SP70
            CALL      WRMISS1
            MATCH     "1",PREVDETA
            IF        @EQUAL
              CALL      CPBOK000            * write to bokrc1af and bokrx1af
              CALL      CPMH0000            * Update MH from prev visit
            ENDIF
            COMPARE   ONE,RESIDADM
            IF        @EQUAL
              CALL      WRAR0000            * write to AH residential adm table
            ENDIF
            CALL      LCLM0000              * get the default claim details
            CALL      WRCPT000              * write to current patient table
            CALL      WRINT000              * write interpreter details
            IF        ASTAT<>1 & ASTAT<>5
              CALL      WIPG0000              * Write new program to patient
              PROC      WARPRG00           * Warning if program changes required
            ENDIF
.
            CALL      BRDPRE00              * broadcast pre-admission
          ENDIF
.
          PACK      KEY11,ADMISSNO,ACLAIM
          CALL      RDPMEXT1
          IF        OVRCD=0
            MATCH     "0",PMEXT049
            IF        @EQUAL
              MOVE      PMEXT049,PMEXUYN1
              CALL      UPPMEXT1
            ENDIF
.
            MATCH     "1",PMEXT049
            IF        @EQUAL
              MOVE      PMEXT049,PMEXUYN1
              CALL      UPPMEXT1
            ENDIF
          ENDIF
.
.         Check if we need to write a patpeiaf record for ADM changes
.
          MOVE      "13",HDPEQUIV
          CALL      WPEI0000                * Write patpeiaf record
.
.         write/update admission extension record
.
          CALL      WASF0000                * Write admin SFA file stuff
          CALL      ADTD0000                * update admission transfer dest.
          CALL      PNZB0000                * post to Kiwi Card file
          CALL      PNMP0000                * post to National UR file
.
          IF        PTCNHDPS=1
            PACK      SAVADMIS,ADMISSNO,SP70   * save existing admissno
            PACK      ADMISSNO,AADMNO,SP70
            CALL      WRPORD00              * write acc purchase order no if req
            PACK      ADMISSNO,SAVADMIS,SP70   * restore admissno
          ENDIF
.
.         Write/Update Visits file if we have a U/R Number
.
          MATCH     ZEROUR,PURNO
          GOTO      PADM1000 IF EQUAL
.
          MOVE      AADMNO,PVIBILL
          MOVE      PURNO,PVIURNO
          PACK      PVIDATE,ADATE
          REP       " 0",PVIDATE
          MOVE      THREE,PVITYPE
.
          MOVE      ZERO,TCINDC1
          PACK      KEY5,ANSA,SP1,ATYPE
          CALL      RDCODE1
.
          MOVE      ZERO,FORM1              * in case TCINDC1 is not numeric
          MOVE      TCINDC1,FORM1
          MOVE      TWO,PVISTAT             * Default Public Patient
          LOAD      PVISTAT,FORM1,TWO,ONE
          MOVE      ONE,PVITRAN             * initialise transaction number
          PACK      PVISITE,SP70
          PACK      PTVITYPE,SP70
          MOVE      SP2,PVILOCK
          MOVE      SP20,PVISPAR
.
          MOVE      ADOCTA,PVIDOCT
          MOVE      PTYPE,PVIRESI
.
PADM0500  MOVE      PVIBILL,KEY8
          CALL      RLPTVIS1                * record found ?
          BRANCH    OVRCD,PADM0600:         * no
                          PADM9100          * yes, but already locked
.
.         Update current record
.
          MOVE      ADOCTA,PVIDOCT
          MOVE      PTYPE,PVIRESI
          MOVE      TWO,PVISTAT             * Default Public Patient
          LOAD      PVISTAT,FORM1,TWO,ONE
          PACK      PVIDATE,ADATE
          REP       " 0",PVIDATE
          CALL      UPVISA1                 * update visit record
          CALL      UUPTVIS1
          GOTO      PADM1000
.
.         Write a new record
.
PADM0600  PACK      PVIUNQE,SP70
.
          MATCH     "1",PTCNXCOM
          IF        @EQUAL
            MOVE      WBSESIT,PVISITE
          ENDIF
.
          CALL      WRVISA1                 * write a record
          CALL      ADDVIS00                * Adds a record to MR Visit Link
          CALL      AEXP0000                * write adm based expected payors
.
. Update Master file with Resident Status, and any other changed
. NB. 5.04 changes required that kiwi card details retain their original
. values and not be updated at admission (only via PAT01).  As the program
. sometimes calls this routine again if there is a second admission screen, the
. current details need to be reloaded again immediately after the master file
. is updated.
.
PADM1000  MATCH     ZEROUR,PURNO
          GOTO      PADM1100 IF EQUAL
.
          MOVE      PURNO,KEY8
          CALL      RDAMAST1
          IF        OVRCD = 0
            CALL      OCRD0000              * reload original kiwi card details
.                                                              *T0861841-Start
            MATCH     Z70,PTMSX048
            IF        !@EQUAL
              MOVE      PTMSX048,PTMXSLAC
            ENDIF
.                                                              *T0861841-End
            CALL      UPMAST1               * update Master file
            CALL      UUPTMAS1
.
            CALL      PMIGTNID              * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      SEVEN,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICUP              * send details to Datagate *C-90223
            CALL      NCRD0000              * restore new kiwi card details
          ENDIF
          GOTO      PADM1500
.
.         Update zero U/R master details if appropriate
.
PADM1100  MATCH     ZEROVISN,AADMNO             * do we have an Admission No. ?
          GOTO      PADM1500 IF EQUAL       * no, do nothing
.
          MOVE      AADMNO,PURNO
          MOVE      PURNO,KEY8
          CALL      RDAPRAM1
          IF        OVRCD = 0
            CALL      UPPRAM1               * update Pre-Admission Master file
            MOVE      AADMNO,PVIBILL
            MOVE      ZEROUR,PURNO
            CALL      PNMP0000              * post NMPI Number
          ENDIF
          MOVE      ZEROUR,PURNO
.
. see if a Mental health admission
.
PADM1500  CALL      CLMEHVIS
          CALL      CLMEHDIA
          COMPARE   ONE,MHCNUSE             * not using MH?
          GOTO      PADM9000 IF NOT EQUAL
.
          COMPARE   ONE,MHADMFLG            * mental health admission
          GOTO      PADM1600 IF EQUAL
.
          COMPARE   TWO,MHADMFLG            * mental health adm (prev detail)
          GOTO      PADM9000 IF NOT EQUAL
.
. Post data to the Mental Health Visit file (mehvisaf)
.
PADM1600  MOVE      AADMNO,MHVIADMN
          MOVE      PURNO,MHVIURNO
          IF        PREADMEH=1
            PACK      KEY8,ADMISSNO,SP70    * default previous details
            CALL      RDMHVIS1
            BRANCH    OVRCD,PADM1700
.
            PACK      KEY21,ADMISSNO,Z70    * I SRF 33698
            CALL      RSMHLEG1              * default previous mental health
            CALL      RPMHLEG1              * legal status
            BRANCH    OVRCD,PADM1700
.
            PACK      KEY16,ADMISSNO,Z70    * default previous mental health
            CALL      RSMHDIA1              * diagnosis
            CALL      RPMHDIA1
            BRANCH    OVRCD,PADM1700
.
            MATCH     ADMISSNO,DMHDIADM
            GOTO      PADM1700 IF EQUAL     * clear defaulted diag vars if the
            CALL      CLMEHDIA              * admission number is not the same
          ENDIF                             * end I SRF 33698
.
PADM1700  MOVE      AADMNO,MHVIADMN
          MOVE      PURNO,MHVIURNO
          PACK      KEY8,MHVIADMN           * Write or Update ?
          CALL      RAMHVIS1
          IF        OVRCD = 1
            MOVE      ZERO,MHVISTAT         * Pre-admitted
            CALL      WRMHVIS1
          ENDIF
.
. If Pre-admission, update MEHLEGFD with legal status & legal status date
.
PADM2000  COMPARE   ZERO,MHVISTAT
          GOTO      PADM9000 IF NOT EQUAL   * in hospital/Discharged etc
.
          MOVE      AADMNO,MHDIADMN
          MOVE      ADATE,MHDIDATE
          MOVE      "0",MHDIMOHR            * Unsent
          PACK      KEY16,MHDIADMN,MHDIDATE,SP70
          CALL      RAMHDIA1
          IF        OVRCD = 0
            PACK      MHDIUDAT,CCC,CYY,CMM,CDD
            REP       " 0",MHDIUDAT
            CLOCK     TIME,MHDIUTIM
            MOVE      USERID,MHDIUUID
            CALL      UPMHDIA1
          ELSE
            PACK      MHDICDAT,CCC,CYY,CMM,CDD
            REP       " 0",MHDICDAT
            CLOCK     TIME,MHDICTIM
            MOVE      USERID,MHDICUID
            CALL      WRMHDIA1
          ENDIF                             * end I SRF 33698
.
PADM9000  CALL      UPBKD000             * Update booking with predmit detail
          CALL      UNUT0000                * Nutrition record update
          MOVE      ZERO,EXIT
          GOTO      PADM9999
.
PADM9100  CLEAR     WEBTITLE
          APPEND    "Visit ",WEBTITLE
          APPEND    PVIBILL,WEBTITLE
          APPEND    " is Locked on Port ",WEBTITLE
          APPEND    PVILOCK,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
PADM9800  MOVE      ONE,EXIT
          GOTO      PADM9999
.
PADM9999  RETURN
+
.*************************************************************************
. SVXDF000 - Set Visit Extension defaults (MHos,Visitors & Phone calls)
.*************************************************************************
SVXDF000  MATCH     "030",TEMPLATE               * update admission details
          GOTO      SVXDF999 IF EQUAL
.
          MOVE      SP1,KEY1
          IF        ASTAT=2
            PACK      KEY6,AWARD,SP70            * set current Ward
          ENDIF
.
          CALL      RDWARD1
          IF        OVRCD<>1
            PACK      PMVXMHOS,PTWDHOSN,SP70
            IF        ASTAT = 1 | ASTAT = 2
              MOVE      PTWDDFVS,PMVXVALW        * Ward defaults
              MOVE      PTWDDFPH,PMVXPALW
              IF        ASTAT = 1
                PACK      KEY6,PTMIXWRD,PTMIEBED,SP6
              ENDIF
              IF        ASTAT = 2
                PACK      KEY6,AWARD,ABED,SP6
              ENDIF
              CALL      RDWARD1
              IF        OVRCD<>1
                MATCH     SP1,PTWDDFVS
                IF        !@EQUAL
                  MOVE      PTWDDFVS,PMVXVALW    * Bed default
                ENDIF
                MATCH     SP1,PTWDDFPH
                IF      !@EQUAL
                  MOVE      PTWDDFPH,PMVXPALW
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
SVXDF999  RETURN
.
.*************************************************************************
. CPBOK000 - Copy previous booking record
.*************************************************************************
CPBOK000  PACK      KEY5,ANSC,ANSC,ACARE,SP70
          CALL      RDCODE1              * check for oncology booking
          BRANCH    OVRCD,CPBOK999
.
          MATCH     ANSO,TCINDC2
          GOTO      CPBOK999 IF NOT EQUAL
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDBKREC1
          BRANCH    OVRCD,CPBOK999
.
          CALL      RDBKRX11
          BRANCH    OVRCD,CPBOK999
.
          PACK      BKREEDAT,ADATE
          PACK      BKREATIM,ATIME
          MOVE      AADMNO,BKREBOOK
          PACK      KEY8,BKREBOOK,SP70
          MOVE      ONE,BKRESTAT
          LOAD      BKRESTAT,ASTAT,ONE,THREE,FOUR
          CALL      RABKREC1
          IF        OVRCD=1
            CALL      WRBKREC1
            PACK      KEY5,ANSB,ANSK,BKRETYPE,SP70
            CALL      RDCODE1          * allow usage if indicator 3=1
            BRANCH    OVRCD,CPBOK100
.
            MATCH     "1",TCINDC3
            GOTO      CPBOK100 IF NOT EQUAL
.
            CALL      WRUSG000         * write theatre usage unique id table
          ENDIF
.
CPBOK100  PACK      BKRXBNUM,AADMNO,SP70
          PACK      KEY8,BKRXBNUM,SP70
          CALL      RABKRX11
          IF        OVRCD=1
            CALL      WRBKRX11
          ENDIF
.
CPBOK999  RETURN
+
.-----------------------------------------------------------
.        Update Mental health from previous visit
.-----------------------------------------------------------
CPMH0000  COMPARE   FOUR,PTCNHDPS
          GOTO      CPMH9999 IF NOT EQUAL      * Queensland only
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPTQMH1
          BRANCH    OVRCD,CPMH9999
.
          MOVE      AADMNO,PTQMADMN
          MOVE      AADMNO,KEY8
          CALL      RAPTQMH1
          IF        OVRCD=1
            CALL      WRPTQMH1
          ENDIF
.
CPMH9999  RETURN
+
.------------------------------------------------------------
. URDET000 - Get U/R Details
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.                  2 = Ok to continue with warnings
.------------------------------------------------------------
.
URDET000  MOVE      ZEROUR,PURNO
          MOVE      ZEROUR,AURNO
          MOVE      SP20,NMPNUMB
          MOVE      ZEROVISN,AADMNO
          IF        SRCHPCKL=1
            MOVE      ONE,SRCHOPT
          ELSE
            MOVE      TWO,SRCHOPT
          ENDIF
          MOVE      ZERO,SRCHSYS            * search ALL systems
          MOVE      ZERO,CREGOPT            * don't allow (R)egister
          MOVE      PTCNRPIK,CREGOPT        * depends on param. for (R)egister
.
          CALL      VALUR000                * Validate U/R
          BRANCH    EXIT,URDET910,URDET920
.
          MOVE      ZERO,EXIT
          GOTO      URDET999
.
URDET910  MOVE      ONE,EXIT
          GOTO      URDET999
.
URDET920  MOVE      TWO,EXIT
.
URDET999  RETURN
+
.------------------------------------------------------------
. Validate the U/R - from routine KURN
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.                  2 = Ok to continue with warning
.------------------------------------------------------------
.
VALUR000  MOVE      URNUMBER,PURNO          * Move to the master file variable
.
          MOVE      PURNO,KEY8
          CALL      RDMAST1                 * Validate U/R number against PMI
          COMPARE   ZERO,OVRCD
          GOTO      VALUR030 IF EQUAL       * Valid UR so Continue
.
          MOVE      ZERO,OVRCD
          COMPARE   ZERO,PTCNNMPI
          PROC      VALURNMP IF NOT EQUAL   * check if on patnmpaf
          BRANCH    OVRCD,VALUR990,VALUR990
.
. Check if this is an associated U/R number
.-------------------------------------------
VALUR030  MOVE      PURNO,KEY8
          CALL      RDPMPX21
          BRANCH    OVRCD,VALUR990
.
          COMPARE   ONE,PSTAT               * Is this an associated U/R number ?
          GOTO      VALUR900 IF NOT EQUAL   * No
.
. ***** VINAH needs to update merged UR details *****
          MATCH     "1",VINAHUPD
          GOTO      VALUR9000 IF EQUAL
.
          CALL      ASSURN00                * Yes, Get Associated UR Details
          BRANCH    EXIT,VALUR991
.
          GOTO      VALUR995
.
VALUR900  MOVE      ZERO,EXIT
          GOTO      VALUR999
.
VALUR990  CLEAR     WEBTITLE
          APPEND    "Invalid U/R Number - ",WEBTITLE
          APPEND    URNUMBER,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
VALUR991  MOVE      ONE,EXIT
          GOTO      VALUR999
.
VALUR995  CLEAR     WEBTITLE
          APPEND    "This U/R Number is merged with ",WEBTITLE
          APPEND    PURNO,WEBTITLE
          RESET     WEBTITLE
          ADD       ONE,WARCOUNT
          MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
          MOVE      TWO,EXIT
          GOTO      VALUR999
.
VALUR999  RETURN
+
.-------------------------------------------------------------
. Validate sex. Can only be (I)ndeter if age less than 90 days
. Returns:    EXIT  0 = Ok to continue
.                   1 = Error
.-------------------------------------------------------------
.
VLSEX000  MATCH     "I",PSEX
          GOTO      VLSEX900 IF NOT EQUAL
.
          MATCH     SP70,PBDATE
          GOTO      VLSEX900 IF EQUAL
.
          UNPACK    PBDATE,CCENT,CYEAR,CMON,CDAY
          MATCH     "00",CDAY
          GOTO      VLSEX900 IF EQUAL
.
          CALL      IBACLOCK
          IF        PCEASE=1
            MOVE      PDECDTE,AGEDATE            * Date of Death
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE
          IF        PTCNHDPS=6
            IF        PSAGEDAY <= 365
              GOTO      VLSEX900
            ENDIF
          ELSE
            COMPARE   PSAGEDAY,NINTY
            GOTO      VLSEX900 IF NOT LESS
          ENDIF
.
          MOVE      "Invalid sex for age",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VLSEX999
.
VLSEX900  MOVE      ZERO,EXIT
.                                                * age is greater than 90 days
VLSEX999  RETURN
+
.------------------------------------------------------------
. GPAD0000 - Get previous admission
.------------------------------------------------------------
.
GPAD0000  MOVE      ZEROVISN,PREVADMN
          MOVE      SP70,PREVADMD
          PACK      KEY24,PURNO,Z70
          CALL      RSPTVIS2                * position on U/R
GPAD1000  CALL      RPPTVIS2
          BRANCH    OVRCD,GPAD5000
.
          MATCH     PURNO,PVIURNO           * same U/R
          GOTO      GPAD5000 IF NOT EQUAL
.
          COMPARE   THREE,PVITYPE
          GOTO      GPAD1000 IF NOT EQUAL   * only want inpatient visits
.
          PACK      KEY8,PVIBILL,SP8
          CALL      RDPTMIS1                * read admission file
          BRANCH    OVRCD,GPAD5000
.
          COMPARE   THREE,ASTAT             * check if discharged
          GOTO      GPAD1000 IF NOT EQUAL
.
          MOVE      AADMNO,PREVADMN         * save prevous adm. number
          PACK      PREVADMD,ADATE,SP8      * save pervious adm. date
.
GPAD5000  CALL      CLPATMIS
          CALL      CLRAS000                * Clear funding arranging
.
GPAD9999  RETURN
+
.------------------------------------------------------------
. ISUR0000 - Check by U/R if admitted
. Returns:    EXIT  0 = Ok to continue
.                   1 = Error
.------------------------------------------------------------
.
ISUR0000  IF        CONTMULT=1
            GOTO      ISIN9999             * allow multiple admissions if
          ENDIF                            * override was selected at admission
.
          PACK      KEY17,PURNO,TWO,SP20
          CALL      RSPTMI18
ISUR1000  CALL      RKPTMI18
          BRANCH    OVRCD,ISUR9900          * not on file
.
          MATCH     PURNO,AURNO           * same U/R Number?
          GOTO      ISUR9900 IF NOT EQUAL   * No
.
          COMPARE   TWO,ASTAT
          GOTO      ISUR9100 IF EQUAL
.
          PACK      KEY17,PURNO,FOUR,SP70
          CALL      RSPTMI18
          CALL      RKPTMI18
          BRANCH    OVRCD,ISUR9900          * not on file
.
          MATCH     PURNO,AURNO           * same U/R Number?
          GOTO      ISUR9900 IF NOT EQUAL   * No
.
          COMPARE   FOUR,ASTAT
          GOTO      ISUR9900 IF NOT EQUAL
.
ISUR9100  BRANCH    DISERROR,ISUR9900
          CLEAR     WEBTITLE
          APPEND    "Patient Already in Hospital Under Admission - ",WEBTITLE
          APPEND    AADMNO,WEBTITLE
          RESET     WEBTITLE
          CALL      ADMERR00
          IF        ADMITBOX=1
            MOVE      ONE,EXIT
          ELSE
            GOTO      ISUR9900
          ENDIF
          GOTO      ISUR9999
.
ISUR9900  CALL      CLPV0000                * clear visit details
          CALL      CLPATMIS                * clear admission vars
          CALL      CLRAS000                * Clear funding arranging
          MOVE      ZERO,EXIT
.
ISUR9999  RETURN
.
.------------------------------------------------------------
. CURI0000 - Check by U/R if admitted
.------------------------------------------------------------
.
CURI0000  MOVE      ZERO,CURRFLAG
          MOVE      SP70,CURRHOSP
          MOVE      SP70,CURRADMN
.
          PACK      KEY17,URNUMBER,TWO,SP20
          CALL      RSPTMI18
CURI1000  CALL      RKPTMI18
          BRANCH    OVRCD,CURI2000          * not on file
.
          MATCH     URNUMBER,AURNO             * same U/R Number?
          GOTO      CURI2000 IF NOT EQUAL   * No
.
          COMPARE   TWO,ASTAT
          IF        @EQUAL
            MOVE      ONE,CURRFLAG
            GOTO      CURI9000
          ENDIF
.
CURI2000  PACK      KEY17,URNUMBER,FOUR,SP20
          CALL      RSPTMI18
CURI2100  CALL      RKPTMI18
          BRANCH    OVRCD,CURI9500          * not on file
.
          MATCH     URNUMBER,AURNO             * same U/R Number?
          GOTO      CURI9500 IF NOT EQUAL   * No
.
          COMPARE   FOUR,ASTAT
          GOTO      CURI9500 IF NOT EQUAL
.
          MOVE      TWO,CURRFLAG
.
CURI9000  PACK      CURRADMN,DAADMNO,SP70
          PACK      KEY3,PMVXMHOS,SP70
          CALL      RDPTHSP1
          BRANCH    OVRCD,CURI9600
          PACK      CURRHOSP,PTHSNAME,SP70
.
          GOTO      CURI9600
.
CURI9500  CALL      CLPV0000                * clear visit details
          CALL      CLPATMIS                * clear admission vars
.
CURI9600  PACK      KEY8,ADMISSNO
          CALL      RDMISS1
          CALL      RSETB000
          CALL      RDVISA1
          CALL      RDPMVX11
.
CURI9999  RETURN
+
.------------------------------------------------------------
. INIVAR00 - Initialise Pre-admission variables
.------------------------------------------------------------
.
INIVAR00  CALL      CLPATMAS                      * Clear Master Var's
          CALL      CLPATMSX                      * Clear Master Extension Var's
          CALL      CLPATMIS                      * Clear Admission Var's
          CALL      CLRAS000                * Clear funding arranging
          CALL      CLPATMWS                      * Clear all Medical Warnings
          CALL      CLPATDNR                      * Clear all Donor Det Var's
          CALL      CLPMSPX2                * clear mast ext2 details
          CALL      CLMR0000                * clear medical records
          CALL      CLWATTR1                * clear wattr1af variables
          CALL      CLWATTX1                * clear wattx1af variables
.
INIVAR99  RETURN
+
.------------------------------------------------------------
. LCLM0000 - Get default claim details from previous visit
.------------------------------------------------------------
.
LCLM0000  MATCH     SP3,ACLAIM
          GOTO      LCLM7000 IF EQUAL       * no claim code
.
          MATCH     ANSN,PTCNLCLM
          GOTO      LCLM7000 IF EQUAL       * no default required
.
.         Set the claim type indicator if this is a claim
.
          PACK      KEY5,CODECL,ACLAIM
          CALL      RDCODE1
          BRANCH    OVRCD,LCLM7000
.
.         Check the indicators for a W, M, or V (these are the claims)
.
          MOVE      ZERO,FORM2
LCLM3000  ADD       ONE,FORM2
          COMPARE   SIX,FORM2
          GOTO      LCLM7000 IF NOT LESS
.
          LOAD      ANS,FORM2,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
          CMATCH    "W",ANS
          GOTO      LCLM4000 IF EQUAL
.
          CMATCH    "M",ANS
          GOTO      LCLM5000 IF EQUAL
.
          CMATCH    "D",ANS
          GOTO      LCLM6000 IF EQUAL
.
          GOTO      LCLM3000
.
.         We have a workers comp. claim
.
LCLM4000  OPEN      PATWC1A2,"patwc1af"
          PACK      KEY16,URNUMBER,Z70
          CALL      RDSWCOM2
LCLM4200  CALL      RDPWCOM2
          BRANCH    OVRCD,LCLM7000
.
          MATCH     PTWCURNO,URNUMBER
          GOTO      LCLM7000 IF NOT EQUAL
.
          MATCH     ANSI,PTCNLCLM             * Inpatient only?
          IF        @EQUAL
            MOVE      WCADMNO,KEY8
            CALL      RDVISA1
            BRANCH    OVRCD,LCLM4200          * missing visit record
.
            COMPARE   THREE,PVITYPE
            GOTO      LCLM4200 IF NOT EQUAL   * not an inpatient
.
            MOVE      ADMISSNO,KEY8
            CALL      RDVISA1                 * restore the visit record
          ENDIF
          MOVE      WCADMNO,KEY8
          CALL      RDPMWX11
          MOVE      "W",CLAIMTYP
          GOTO      LCLM9999
.
.         We have a motors accident claim
.
LCLM5000  OPEN      PATWMAB2,"patwmabf"
          PACK      KEY16,URNUMBER,Z70
          CALL      RDSWMAB2           * read claim details for previous visit
LCLM5200  CALL      RDPWMAB2
          BRANCH    OVRCD,LCLM7000
.
          MATCH     PTWMURNO,URNUMBER
          GOTO      LCLM7000 IF NOT EQUAL
.
          MATCH     ANSI,PTCNLCLM             * Inpatient only?
          IF        @EQUAL
            MOVE      MADMNO,KEY8
            CALL      RDVISA1
            BRANCH    OVRCD,LCLM5200          * missing visit record
.
            COMPARE   THREE,PVITYPE
            GOTO      LCLM5200 IF NOT EQUAL   * not an inpatient
.
            MOVE      ADMISSNO,KEY8
            CALL      RDVISA1                 * restore the visit record
          ENDIF
          MOVE      "M",CLAIMTYP
          GOTO      LCLM9999
.
LCLM6000  PACK      KEY19,URNUMBER,Z70
          CALL      RSPMEXT2
LCLM6200  CALL      RPPMEXT2
          BRANCH    OVRCD,LCLM7000
.
          MATCH     URNUMBER,PMEXURNO
          GOTO      LCLM7000 IF NOT EQUAL
.
          MATCH     ANSI,PTCNLCLM             * Inpatient only?
          IF        @EQUAL
            MOVE      PMEXVISN,KEY8
            CALL      RDVISA1
            BRANCH    OVRCD,LCLM6200          * missing visit record
.
            COMPARE   THREE,PVITYPE
            GOTO      LCLM6200 IF NOT EQUAL   * not an inpatient
.
            MOVE      ADMISSNO,KEY8
            CALL      RDVISA1                 * restore the visit record
          ENDIF

          MOVE      "D",CLAIMTYP
          GOTO      LCLM9999
.
LCLM7000  CALL      CLRCLM00
.
LCLM9999  RETURN
+
.------------------------------------------------------------
. UPADM000 - Update Admission
. Returns:    EXIT  2 = Ok to continue with warning
.                   1 = Error
.------------------------------------------------------------
.
UPADM000  CALL      CLPATMIS                * Clear admission file fields
          CALL      CLRAS000                * Clear funding arranging
          MOVE      ADMISSNO,KEY8           * Read in current values
          CALL      RDMISS1
          BRANCH    OVRCD,UPADM910
.
          COMPARE   FIVE,ASTAT
          GOTO      UPADM920 IF EQUAL
.
          CALL      SAVNZ000    *  Save NZ NMBS fields
.
          PACK      WAABWGHT,ABWGHT,SP70
          PACK      WAACLSS,ACLSS,SP70
          PACK      WAASRCE,ASRCE,SP70
          PACK      SAVPPDRG,PTMIPDRG,SP70
.
          MOVE      ADMISSNO,KEY8           * Read in current values
          CALL      RDDSCH1
          IF        OVRCD<>1
            MATCH     "20140701",DDATE
            IF        @LESS
              MOVE      ZERO,DOYR2014
              GOTO      UPADM010
            ELSE
              MOVE      ONE,DOYR2014
              GOTO      UPADM010
            ENDIF
          ENDIF
.
          MATCH     "20140701",ADATE
          IF        !@LESS
            MOVE      ONE,DOYR2014
            GOTO      UPADM010
          ENDIF
.
UPADM010  IF        ASTAT=1
            MATCH     PTMIS001,Z70
            IF        !@EQUAL
              MATCH     PTMIS001,ADATE
              IF        !@EQUAL
                MOVE      SP70,PTMIDMOV     * If pre adm date changed reset
              ENDIF                         * mr pulled flag
            ENDIF
          ENDIF
.
          CALL      UPDMIS00                * Update adm fields with cgi params
          CALL      UPDVIS00                * Update vis fields with cgi params
          BRANCH    EXIT,UPADM980
.
          CALL      UNUT0000                * Nutrition record update
.
          MOVE      ADMISSNO,AADMNO
          MOVE      URNUMBER,AURNO
          MOVE      "11",XOPTION
          MATCH     "032",TEMPLATE
          IF        !@EQUAL
            MATCH     "036",TEMPLATE
            IF        !@EQUAL
              CALL      NEWR0000
              BRANCH    EXIT,UPADM980
            ENDIF
          ENDIF
          CALL      PADM0000
          BRANCH    EXIT,UPADM980
.
          CALL      CGTU0000                * Write to Unknown GST file if req.
.
          CALL      PRDT0000                * Update booking pre admission date
          CALL      UBOK0000                * Update wattr1af
          CALL      CHKNZ000      * Check NZ fields - update aelig if required.
.
          IF        CCCNSVHM = 1
            OPEN      CCIEX7A1,"cciex7af"
            CALL      TRNSII00
            CLOSE     CCIEX7A1
          ENDIF
.
          MOVE      "Admission Details Successfully Updated",WEBTITLE
.
          ADD       ONE,WARCOUNT
          MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
          MOVE      TWO,EXIT
.
          MATCH     TEMPLATE,ZERO45
          IF        @EQUAL
            CALL      REMTR000    * Remove trigger for nz aelig
            GOTO      UPADM980
          ENDIF
.
          GOTO      UPADM999
.
UPADM910  MOVE      "Invalid Admission Number",WEBTITLE
          CALL      WEBERR00
          GOTO      UPADM980
.
UPADM920  MOVE      "Admission Cancelled",WEBTITLE
          CALL      WEBERR00
          GOTO      UPADM980
.
UPADM980  MOVE      ONE,EXIT
          GOTO      UPADM999
.
UPADM999  RETURN
+
.------------------------------------------------------------
. SAVNZ000 - Save NZ NMDS fields
.------------------------------------------------------------
SAVNZ000  PACK      NMDSAELI,AELIG      * Save existing AELIG value
          PACK      NMDSASRC,ASRCE      * Admission Source
          PACK      NMDSPHSP,PTMIPHPU   * Principal Health Service Purchaser
          PACK      NMDSACLS,ACLSS      * Patient Type
          PACK      NMDSAGNC,PTMIAGNC   * Agency Code
.
SAVNZ999  RETURN
+
.------------------------------------------------------------
. CHKNZ000 - Check if NZ NMDS fields have changed, and require resubmission
.------------------------------------------------------------
CHKNZ000  COMPARE   ONE,PTCNHDPS
          GOTO      CHKNZ999 IF NOT EQUAL   * NZ
.
          COMPARE   ONE,AELIG               * has this record been submitted?
          GOTO      CHKNZ999 IF NOT EQUAL
.
          MATCH     NMDSASRC,ASRCE          * has admission source changed?
          GOTO      CHKNZ100 IF NOT EQUAL
.
          MATCH     NMDSPHSP,PTMIPHPU       * has health serv purchaser changed?
          GOTO      CHKNZ100 IF NOT EQUAL
.
          MATCH     NMDSACLS,ACLSS          * has Patient type changed?
          GOTO      CHKNZ100 IF NOT EQUAL
.
          MATCH     NMDSAGNC,PTMIAGNC       * has Health Agency changed?
          GOTO      CHKNZ100 IF NOT EQUAL
.
          GOTO      CHKNZ999                * no changes
.
CHKNZ100  MOVE      ADMISSNO,KEY8           * Read in current admission
          CALL      RDMISS1
          BRANCH    OVRCD,CHKNZ999
.
          MOVE      "4",AELIG               * update resubmit flag
          CALL      UPMISS1
.
          OPEN      PMSWTRA1,"pmswtraf"
.
          PACK      KEY19,PMVXMHOS,AADMNO,SP70
          CALL      RDPMWTR1
          IF        OVRCD<>1
            GOTO      CHKNZ999    * record is already on file to be resent
          ENDIF
.
          CALL      IBACLOCK                * Get the current date
          PACK      PMWTCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMWTCDAT
          MOVE      CTIMEIS,PMWTCTIM
.
          PACK      PMWTHOSP,PMVXMHOS,SP70
          PACK      PMWTVISN,AADMNO,SP70
          PACK      PMWTSDAT,SP70
          PACK      PMWTMDAT,SP70
          PACK      PMWTWEBC,WBSEUID,SP70
.
          PACK      KEY19,PMWTHOSP,PMWTVISN,PMWTSDAT,SP70
          CALL      RAPMWTR1
          IF        OVRCD=1
            CALL      WRPMWTR1
          ENDIF
.
CHKNZ999  CLOSE     PMSWTRA1
.
          RETURN
+
.*******************************************************************************
. RMDIS000 - Remove disaster details when cancelling preadmission
.*******************************************************************************
..  First, delete the disaster link record if there is one
RMDIS000  PACK     SAVDISKY,SP70
          PACK     KEY25,URNUMBER,SP70
          CALL     RSDSPTL1
RMDIS100  CALL     RKDSPTL1
          BRANCH   OVRCD,RMDIS999
.
          MATCH    DSPLURNO,URNUMBER
          GOTO     RMDIS999 IF NOT EQUAL
.
          MATCH    DSPLVISN,DAADMNO
          GOTO     RMDIS100 IF NOT EQUAL
.
          PACK     KEY25,DSPLURNO,DSPLCODE,DSPLVISN,SP70
          CALL     DEDSPTL1
          PACK     SAVDISKY,DSPLURNO,DSPLCODE,SP70
.
..  If this was the only disaster link record, delete the patient level record
.
          PACK     KEY25,URNUMBER,SP70
          CALL     RSDSPTL1
          CALL     RKDSPTL1
          BRANCH   OVRCD,RMDIS200
.
          MATCH    DSPLURNO,URNUMBER
          GOTO     RMDIS200 IF NOT EQUAL
          GOTO     RMDIS999
.
RMDIS200  PACK     KEY17,SAVDISKY,SP70
          CALL     DEDSPAT1
          CALL     DELALT00
.
RMDIS999  RETURN
+
.*******************************************************************************
. INTDEL00 - Delete Interpreter Table Record
. Input  - DAADMNO
.          AURNO
.*******************************************************************************
.
INTDEL00  PACK      KEY8,AURNO,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,INTDEL99
.
          MATCH     "1",PMPXINTR
          GOTO      INTDEL99 IF NOT EQUAL
.
          PACK      KEY8,DAADMNO
          CALL      RDVSINT1
          IF        OVRCD=0
            CALL      DEVSINT1           * Delete record from Int.Table(Cancel)
            MOVE      "D",INTAUDTY
            CALL      INTAUD00           * Add record to Int.Audit after Delete
          ENDIF
          MOVE      ZERO,EXIT
.
INTDEL99  RETURN
+
.------------------------------------------------------------
. UPMAD000 - Update Master Details
. Returns:   EXIT  1 = Error
.                  2 = Ok to continue with warning
.------------------------------------------------------------
.
UPMAD000  REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.         REP       "+ ",REDIRECT
          MOVE      ZERO,PURNO
          MOVE      ZERO,NZIBVNEW           * clear NMPI sel after search flag
          CALL      CLPATMAS                * clear patmasfd vars
          CALL      CLPMSPX2                * clear mast ext2 details
          MOVE      SP20,NMPNUMB            * clear NMPI number
          CALL      ZKIN0000                * initialize Next of Kin Variables
          CALL      VALUR000                * Validate U/R Number
          BRANCH    EXIT,UPMAD996,UPMAD997
.
          CALL      RDSURN00                * Readin the surname index record
          MOVE      "0",OLDCEASE            * reset Deceased indicator
.
          COMPARE   "999",LASTITM1          * more than 999 lines of comments
          GOTO      UPMAD990 IF EQUAL
.
          MOVE      PURNO,KEY8
          CALL      RLPTMAS1                * record found ?
          BRANCH    OVRCD,UPMAD994:         * no
                          UPMAD991          * yes, but already locked
.
          PACK      KEY8,PURNO
          CALL      RDPMPX21
          BRANCH    OVRCD,UPMAD993
.
          MOVE      PMPXPEML,SPPEML         * save email for prev adress check
          MOVE      PMPXCONP,SPPXCONP       * save Usual Contact for PRFA
          MOVE      PMPXSN16,SPPXSN16       * save Status Indicator 16
          MOVE      PMPXUSR9,SAVEUSR9
. 
          MATCH     "1",ADDRAUDT
          IF        @EQUAL
            CALL      DEATHA00
          ENDIF
.
          CALL      SJGSAV00
.
          MOVE      PCEASE,OLDCEASE
          REP       " N",PTMAUKDD
          PACK      OLDDEATH,PDECDTE,PTMAUKDD,PMPXDETY,PTMADCNO,SP70 Death det.
          CALL      VALADM00                * check birth date to other adms.
          BRANCH    EXIT,UPMAD996           * if age less than 90 days
.
          CALL      AMSV0000                * save master file variables
          CALL      SPRS0000                * save PRS2 PMI trigger variables
          CALL      SH7VP000           * Save PMI HL7 visit trigger variables
.                                           * save Interpreter/Language vars
          MOVE      PMPXINTR,SVPXINTR                                  *I-40489
          MOVE      PMPXLNG1,SVPXLNG1                                  *I-40489
          MOVE      PFUNDH,SAVPFUND         * Save hfund for expected payor
.     
          CALL      UPDMAS00                * Move mast cgi param into mast vars
.
          CALL      IBACLOCK
          PACK      XDATE,CCC,CYY,CMM,CDD
          REP       " 0",XDATE
.
          MATCH     PDECDTE,XDATE
          GOTO      UPMAD995 IF LESS
.
          CALL      VALDEC00                * validate deceased date >= DOB
          BRANCH    EXIT,UPMAD996
.
          CALL      UPVPMI00                * Move mast ext2 parm into file vars
          CALL      ALPR0000
.
          CALL      VLSEX000                * Validate sex. Can only be Indeter
          BRANCH    EXIT,UPMAD996           * if age less than 90 days
.
          CALL      VALP0000                * Validate PRS2 for pmi
          BRANCH    EXIT,UPMAD996           * if age less than 90 days
.
          CALL      UPUCM000                * input comments
          IF        PREVADDR=1
            CALL      UPAD0000              * update previous address file
          ENDIF
.
          RESET     ADMISSNO
          MATCH     SP70,ADMISSNO           * Is Visit No found?
          IF        !@EQUAL
            CALL      VISPST00              * Update Visit Ext with (postcode)
            IF        CFEETYP<>5
              CALL      UPMEMB00            * Update Admission file (member num)
            ENDIF
          ENDIF
.
          IF        PCEASE=0
            MOVE      SP8,PDECDTE           * Clear Deceased Date
            MOVE      SP10,PTMADCNO         * clear death cert.
            MOVE      ZERO,PAUTOPY          * no autopsy
            MOVE      SP70,PMPXI017         * Clear Death Type
          ELSE
            CALL      ENDBRD00
            MATCH     ANSY,PTMAUKDD
            IF        @EQUAL
              MATCH     Z70,PTMAS061
              IF        !@EQUAL
                PACK      PDECDTE,PTMAS061,SP70
              ENDIF
            ENDIF
            MATCH     "1",PTCNDEES
            IF        @EQUAL
              MATCH     SP70,ADMISSNO
              GOTO      UPMAD050 IF EQUAL
              GOTO      UPMAD050 IF EOS
.
              PACK      KEY8,ADMISSNO,SP70
              CALL      RDPTRES1
              IF        OVRCD=1
UPMAD050        CALL      CLRRES00
              ELSE
                CALL      CIND0000           * Check Claim code indicator
                BRANCH    EXIT,UPMAD200
.
                MOVE      SP1,ANS
                MOVE      PGNAME,ANS
                PACK      PKNAME,DLCHAR,SP1,ANS,DOT,PTMASNAM,SP70
                MATCH     SP70,PTCNDDES
                IF        !@EQUAL
                  STRIP     PTCNDDES
                  MOVE      PTCNDDES,KEY20
                  UNPACK    PKNAME,DIM2,KEY78      * ignore "$ "
                  PACK      PKNAME,KEY20,SP1,KEY78,SP70
                ENDIF
                CALL      UPPTRES1
              ENDIF
            ENDIF
          ENDIF
.
UPMAD200
          MOVE      THREE,URSYST
          MOVE      PURNO,GSRURNO           * Ensure GSRURNO is set correctly
          CALL      UPCOMCRD                * Update Community Card
          CALL      VALP0000                * PRS2 validation for pmi details
          BRANCH    EXIT,UPMAD996
.
          CALL      UPDUR
          BRANCH    EXIT,UPMAD996
          IF        SAVEALIA=1
            MOVE      "28",PMEWTYPE
            PACK      PMEWOLDV,SP70
            PACK      PMEWNEWV,SAVPSNAM,SP1,SAVPFGNM,SP1,SAVPSGNM,SP70
            CALL      WREDW000
          ENDIF
          CALL      WRUPD000  * write to demographics updated table
.
          CALL      PNMP0000                * post NMPI details if needed
.
          CALL      DEAPOL00                * Update the Death Polling Table
.
          RESET     PRGID                   * Reset PRGID after scan for WEB
          MATCH     SP70,ADMISSNO
          IF        !@EQUAL
            PACK      KEY8,ADMISSNO,SP70
            CALL      RDRESP1
            IF        OVRCD=1
              CALL      CLPATRE1            * Clear PRFA variables
            ENDIF
            CALL      UPDPRA00              * Update PRA variables
            CALL      UPPRA000              * Update Person Responsible for acc
          ENDIF
.
          CALL      UPVPMI00                * Update PMI Extension variables
          CALL      UPPMI000                * Update PMI Extension file
          CALL      UPRES000                * Update residency details
          CALL      UPALIA00                * Update Preferred Name alias
.
          MATCH     "1",PTMXOSMS            * Opt out of SMS
          IF        @EQUAL
            CALL      OSMS0000              * Write opt of of SMS record
          ELSE
            CALL      DSMS0000              * Delete opt of of SMS record
          ENDIF
.
          CALL      UUPTMAS1
          CALL      UTPRFA00
.
.         Check if Deceased status has changed
.
          PACK       KEY30,PDECDTE,PTMAUKDD,PMPXDETY,PTMADCNO,SP70  *death det
          MATCH      OLDDEATH,KEY30
          IF         !@EQUAL
            MOVE       "001",D3
            CALL       WDAU0000            * Write to Death details audit file
          ENDIF
.
UPMAD210  MATCH      SAVEUSR9,PMPXUSR9
          IF         !@EQUAL
.            MOVE       "003",D3
.            CALL       WDAU0000            * Write to Advance Care Plan Audit
            CALL       WAUDT300 
          ENDIF
.
          MATCH     "1",SJOGAUDT
          IF        @EQUAL
            CALL      SJGAU200
          ELSE
            CALL      WAUDT800 
          ENDIF
.
.          MATCH     "1",PTCNUNET
.          IF        @EQUAL
.            COMPARE   ONE,CHNGMADE
.            IF        @EQUAL
.              MOVE      "01",KEY2                 * IHI Validation
.              PACK      KEY11,WBSEUID,SP70        * User ID
.              PACK      KEY50,URNUMBER,SP70
.              CALL      WIPL0000                  * Write to polling table
.            ENDIF
.          ENDIF
.
          MATCH     "3",PTCNUNET
          IF        @EQUAL
            CALL      CHKCHG00
            COMPARE   ZERO,FORM2
            IF         !@EQUAL
              CALL      WPMNPL00                 * Write to NIHC IHI polling
            ENDIF
          ENDIF
.
          CALL      CHEDW000              * write any EDWARD PMI detail changes
          CALL      PRS2T000              * write any PRS2 PMI detail changes
          CALL      WESIS000              * write any ESIS PMI detail changes
          CALL      CH7VP000              * Check for PMI HL7 visit triggers
.
          CALL      UEXP0000              * Update expected payor
.
          CALL      BEDN0000              * Update bed board/expected patient
.
          CALL      AADR0000              * Update alternate address
.
          MATCH     Z70,PMPXI110
          IF        !@EQUAL
            MATCH     PMPXI110,SPPXSN16
            IF        !@EQUAL
              MATCH     "0",PMPXI110
              IF        @EQUAL
                CALL      MHRI0000       * Update current/future episodes with
                CALL      UPMHRI00       * Update already admitted patient visit
                MATCH     SP70,ADMISSNO
                IF        !@EQUAL
                  PACK      KEY8,ADMISSNO
                  CALL      RDVISA1
                  CALL      RDMISS1
                ENDIF
              ENDIF
            ENDIF
          ENDIF 
.
          CALL      NDIS0000
.
          CALL      UPABK000              * Update interpreter
          BRANCH    EXIT,UPMAD996
.
          MOVE      TWO,EXIT
          GOTO      UPMAD999
.
UPMAD990  CLEAR     WEBTITLE
          APPEND    "Patient U/R ",WEBTITLE
          APPEND    URNUMBER,WEBTITLE
          APPEND    " has too many comments - 999 maximum available.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPMAD999
.
UPMAD991  CLEAR     WEBTITLE
          APPEND    "Patient U/R ",WEBTITLE
          APPEND    URNUMBER,WEBTITLE
          APPEND    " is Locked on port ",WEBTITLE
          APPEND    PPORT,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPMAD999
.
UPMAD993  CLEAR     WEBTITLE
          APPEND    "Patient U/R ",WEBTITLE
          APPEND    URNUMBER,WEBTITLE
          APPEND    " missing extension file.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          CALL      UUPTMAS1
          MOVE      ONE,EXIT
          GOTO      UPMAD999
.
UPMAD994  CLEAR     WEBTITLE
          APPEND    "Patient U/R ",WEBTITLE
          APPEND    URNUMBER,WEBTITLE
          APPEND    " missing from master file.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPMAD999
.
UPMAD995  CLEAR     WEBTITLE
          APPEND    "Patient cannot ",WEBTITLE
          APPEND    " be deceased in the future.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
UPMAD996  CALL      UUPTMAS1
          MOVE      ONE,EXIT
          GOTO      UPMAD999
.
UPMAD997  MOVE      TWO,EXIT
          GOTO      UPMAD999
.
UPMAD999  RETURN
.
.------------------------------------------------------------
. Update Preferred Name alias                 
.------------------------------------------------------------
UPALIA00  MATCH     "0",PTCNNMPR             * Preferred Names not displayed on 
                                             * Demographics screens
          GOTO      UPALIA99 IF EQUAL
.
          PACK      PMPXPFGN,PMPXPFGN,SP70
          PACK      PMPXPFSN,PMPXPFSN,SP70
.
          MATCH     SP70,PMPXPFGN      
          IF        !@EQUAL
            PACK      GSRGNAM,PMPXPFGN,SP70      * if Pref GN not blank
            MATCH     SP70,PMPXPFSN
            IF        !@EQUAL
              PACK      GSRSNAM,PMPXPFSN,SP70    * if Pref GN & SN not blank
            ELSE
              PACK      GSRSNAM,PTMASNAM,SP70    * if Pref SN blank
            ENDIF
          ELSE
            PACK      GSRGNAM,PMPXFNAM,SP70      * if Pref GN blank    
            MATCH     SP70,PMPXPFSN
            IF        !@EQUAL
              PACK      GSRSNAM,PMPXPFSN,SP70    * if Pref SN not blank
            ELSE
              GOTO      UPALIA99                 * if Pref GN & SN blank
            ENDIF
          ENDIF
.
          PACK      PTGSGNM2,PMPXSNAM,SP70   * Second Name
          MOVE      PBDATE,GSRDOB            * Date of birth
          MOVE      PSEX,GSRSEX              * Sex
          MOVE      PURNO,GSRURNO            * DOB
          MOVE      ZEROVISN,GSRBILL             * Billing Number
          MOVE      ZERO,GSRSYS              * System
          CALL      SOUNDEX                  * get soundex key for surname
          CALL      SOUNDX2                  * get soundex key for given names
.
          PACK      KEY115,GSRURNO,GSRBILL,GSRSNAM,GSRGNAM,PTGSGNM2,GSRDOB:
                           GSRSEX
          CALL      RDPTGSR1                 * check if its already there
          IF        OVRCD = 1
            CALL      WRPTGSR1
            MOVE      "28",PMEWTYPE
            PACK      PMEWOLDV,SP70
            PACK      DIM40,GSRSNAM,SP70
            PACK      KEY40,GSRGNAM,SP70
            PACK      PMEWNEWV,DIM40,SP1,KEY40,SP1,PTGSGNM2,SP70
            CALL      WREDW000 
          ENDIF
.
UPALIA99  RETURN
.
.------------------------------------------------------------
. Write out pmsdauaf for changes details
.------------------------------------------------------------
DEATHA00  MOVE      ZERO,FORM2
.
. Type 011
.
          MATCH     PTMSX040,PTMXADD1
          IF        @EQUAL
            MOVE      SP70,PPMXADD1
          ELSE
            MOVE      PTMXADD1,PPMXADD1
            ADD       ONE,FORM2
          ENDIF
.
          MATCH     PTMSX041,PTMXADD2
          IF        @EQUAL
            MOVE      SP70,PPMXADD2
          ELSE
            MOVE      PTMXADD2,PPMXADD2
            ADD       ONE,FORM2
          ENDIF
.
          MATCH     PTMSX042,PTMXADD3
          IF        @EQUAL
            MOVE      SP70,PPMXADD3
          ELSE
            MOVE      PTMXADD3,PPMXADD3
            ADD       ONE,FORM2
          ENDIF
.
          MATCH     PTMSX043,PTMXADD4
          IF        @EQUAL
            MOVE      SP70,PPMXADD4
          ELSE
            MOVE      PTMXADD4,PPMXADD4
            ADD       ONE,FORM2
          ENDIF
.
          MATCH     PTMSX044,PTMXPOST
          IF        @EQUAL
            MOVE      SP70,PPMXPOST
          ELSE
            MOVE      PTMXPOST,PPMXPOST
            ADD       ONE,FORM2
          ENDIF
.
          COMPARE   ZERO,FORM2
          IF        @EQUAL
            GOTO      DEATHA99
          ENDIF
.
          MOVE      "011",D3
          CALL      WDAU0000
.
DEATHA99  RETURN
.
.------------------------------------------------------------------------
. Update Person Responsible for Account address when
.------------------------------------------------------------------------
UTPRFA00  MATCH     "1",PRFANEWA
          GOTO      UTPRFA99 IF NOT EQUAL        
.
          MATCH     SP70,ADMISSNO
          GOTO      UTPRFA99 IF EQUAL
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPTRES1
          BRANCH    OVRCD,UTPRFA99
.
          MOVE      PADD1,PKADD1
          MOVE      PADD2,PKADD2
          MOVE      PSUBRB,PKSUBR
          MOVE      PADD4,PKADD4
          MOVE      PPOST,PKPOST
.
          CALL      UPPTRES1
.
UTPRFA99  RETURN
+
.------------------------------------------------------------------------------
.         Check claim code indicator17 - No prefix for Deceased patient
.------------------------------------------------------------------------------
CIND0000  MOVE      SP70,ACLAIM
          CALL      GCLM0000               * Get claim code
          BRANCH    EXIT,CIND9000
.
          MATCH     SP70,ACLAIM
          GOTO      CIND9000 IF EQUAL
.
          PACK      KEY5,ANSC,ANSL,ACLAIM
          CALL      RDCODE1
          BRANCH    OVRCD,CIND9000
.
          MATCH     "1",PTCNXCOM
          GOTO      CIND0800 IF NOT EQUAL
.
          MATCH     "Parent of",PKNAME
          GOTO      CIND8000 IF EQUAL          * No prefix
.
.         The following Claim codes don't have pmsextaf record
.
          MATCH     "H",TCINDC1
          GOTO      CIND8000 IF EQUAL          * Private - No prefix
          MATCH     SP70,TCINDC1
          GOTO      CIND2000 IF EQUAL          * Blank
          MATCH     "J",TCINDC1
          GOTO      CIND2000 IF EQUAL          * Private Uninsured
          MATCH     "P",TCINDC1
          GOTO      CIND2000 IF EQUAL          * Public/All Funding Source
.
          PACK      KEY11,ADMISSNO,ACLAIM,SP70
          CALL      RDPMEXT1
          BRANCH    OVRCD,CIND9000
.
.         INDIC1=Blank,O,E,G,J,P & INDIC17=Blank -Proceed with the Estate prefix
.
CIND0800
          MATCH     "O",TCINDC1
          GOTO      CIND1000 IF EQUAL          * Compsensable
          MATCH     "E",TCINDC1
          GOTO      CIND1000 IF EQUAL          * Overseas Student
          MATCH     "G",TCINDC1
          GOTO      CIND1000 IF EQUAL          * Overseas Visitor
.
          MATCH     "V",TCINDC1
          GOTO      CIND1000 IF EQUAL          * Veterans Affairs
.
.         INDIC1=A,F,M,H,S,W & INDIC17=D - Ignore the Estate prefix
.
          MATCH     "A",TCINDC1
          GOTO      CIND3200 IF EQUAL          * ADF
          MATCH     "F",TCINDC1
          GOTO      CIND3200 IF EQUAL          * Foreign Defence
          MATCH     "M",TCINDC1
          GOTO      CIND3200 IF EQUAL          * Motor Vehicle
          MATCH     "S",TCINDC1
          GOTO      CIND8000 IF EQUAL          * Shipping
          MATCH     "W",TCINDC1
          GOTO      CIND8000 IF EQUAL          * Workers Compensation
          GOTO      CIND9000
.
CIND1000
          MATCH     "O",TCINDC1
          GOTO      CIND2000 IF NOT EQUAL
.
.         If Billing address is not blank, No Prefix
.
          MATCH     "1",PMEXPOLC
          GOTO      CIND8000 IF EQUAL         * Police Officer checked(NoPrefix)
.
          MATCH     SP70,PMEXICOD
          GOTO      CIND8000 IF NOT EQUAL     * Insurance Code entered(NoPrefix)
.
CIND2000  MATCH     SP70,TCINDC17
          GOTO      CIND9000 IF EQUAL          * Proceed with the prefix
          GOTO      CIND8000
.
.------------------------------------------------------------------------------
.         ADF,Motor Vehicle,Foreign Defence
.
CIND3200  MATCH     SP70,PMEXICOD
          GOTO      CIND8000 IF NOT EQUAL      * has Insurance details
          MATCH     SP70,PMEXCAD1
          GOTO      CIND5000 IF NOT EQUAL
          GOTO      CIND8000
.
CIND5000  MATCH     "D",TCINDC17
          GOTO      CIND9000 IF NOT EQUAL      * Proceed with the prefix
.
CIND8000  MOVE      ONE,EXIT               * No prefix
          GOTO      CIND9999
.
CIND9000  MOVE      ZERO,EXIT              * Proceed with Deceased Estate Desc.
          GOTO      CIND9999
.
CIND9999  RETURN
+
.------------------------------------------------------------------------------
. VISPST00 - Update Visit extension file with postcode if postcode has changed.
.------------------------------------------------------------------------------
.
VISPST00  PACK      KEY8,ADMISSNO,SP70     * Check if Visit exists?
          CALL      RDVISA1
          BRANCH    OVRCD,VISPST10
.
          IF        PVITYPE=1
            MATCH     "1",VEMDRESI         * Don't update ED visit resident
            GOTO      VISPST10 IF EQUAL    * status on pmi update
          ENDIF
.
          MOVE      PTYPE,PVIRESI          * Set Resident Status
          CALL      UPPTVIS1
.
VISPST10  PACK      KEY8,ADMISSNO,SP70     * Read Visit Extension File?
          CALL      RDPMVX11
          BRANCH    OVRCD,VISPST90
.
          MOVE      PPOST,PMVXPOST         * Set Post Code
          MOVE      PMPXABRG,PMVXABRG      * Set Resident Status
          MOVE      PMPXINTR,PMVXINTR      * Interpreter required
          MOVE      PMPXLNG1,PMVXLNG1      * Preferred Language 1
          CALL      GTASGC00               * SLA/ASGC code
          MOVE      PMPXPRVI,PMVXPIND      * Privacy Indicator
          MOVE      PMPXCRIN,PMVXCSNR      * Consent Release of info
          MOVE      PMPXHOML,PMVXHOME      * Homeless status
.
          IF        PTCNUEDI=1
            MOVE      PMPXHFGN,PMVXHFGN    * H/F given name
            MOVE      PMPXHFSN,PMVXHFSN    * H/F surname
            MOVE      PMPXFUPI,PMVXFUPI    * H/F UPI
          ENDIF
.
          CALL      IBACLOCK
          MOVE      WBSEUID,PMVXWEBU
          PACK      PMVXLUPD,CCC,CYY,CMM,CDD
          REP       " 0",PMVXLUPD
          CLOCK     TIME,PMVXLUPT
.
          CALL      UPPMVX11
          GOTO      VISPST99
.
VISPST90  PACK      KEY8,ADMISSNO,SP70     * Check if Visit exists?
          CALL      RDVISA1
          BRANCH    OVRCD,VISPST99
.
          CALL      CLRVXS00               * Clear Visit Extension Variables
          MOVE      ADMISSNO,PMVXVISN      * Visit No
          MOVE      PPOST,PMVXPOST         * Set Post Code
          MOVE      PVIDATE,PMVXVSDT       * Visit Date
          CALL      GTASGC00               * SLA/ASGC code
          MOVE      PMPXPRVI,PMVXPIND      * Privacy Indicator
          MOVE      PMPXCRIN,PMVXCSNR      * Consent Release of info
          MOVE      PMPXHOML,PMVXHOME      * Homeless status
.
          PACK      KEY8,PMVXVISN,SP70
          CALL      RAPMVX11
          IF        OVRCD=1
            CALL      IBACLOCK
            PACK      PMVXCDTE,CCC,CYY,CMM,CDD * current date
            REP       " 0",PMVXCDTE
            CLOCK     TIME,CTIMEIS
            MOVE      CTIMEIS,PMVXCTIM
            MOVE      WBSEUID,PMVXWEBC
            CALL      WRPMVX11
          ENDIF
.
VISPST99  RETURN
+
.--------------------------------------------------------------------
. UPMEMB00 - Update Admission file with Health Fund Member number.
.--------------------------------------------------------------------
.
UPMEMB00  PACK      KEY8,ADMISSNO,SP70     * Check if Admission exists?
          CALL      RDMISS1
          BRANCH    OVRCD,UPMEMB99
.
          COMPARE   PCEASE,SPCEASE
          GOTO      UPMEMB99 IF NOT EQUAL  * Patient has died
.
          COMPARE   FIVE,ASTAT
          GOTO      UPMEMB99 IF EQUAL      * patient cancelled
          COMPARE   ZERO,AINVPRT
          GOTO      UPMEMB99 IF NOT EQUAL  * Invoice raised
.
          MATCH     "1",PTCNVSHF           * Option to Update Visit HF ?
          GOTO      UPMEMB10 IF NOT EQUAL  * default to Update Visit HF
.
          COMPARE   THREE,ASTAT
          GOTO      UPMEMB10 IF NOT EQUAL  * Not discharged
.
          MATCH     "1",UPDHFUND
          GOTO      UPMEMB99 IF EQUAL      * Not to Update Visit HF
.
UPMEMB10  MOVE      PFNDMM,AFNDMM          * Set Member Number
          MOVE      PFNDTB,AFNDTB          * HF Table
          MOVE      PFUNDH,AFUNDH          * HF
.
          PACK      PTMIWEBU,WBSEUID,SP70
          CALL      UPMISS1
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,UPADMN99
.
          MOVE      PFNDMM,PMVXFNDM        * Set Member Number
          MOVE      PMPXHFCN,PMVXCONM      * Contributor
.
          CALL      IBACLOCK
          MOVE      WBSEUID,PMVXWEBU
          PACK      PMVXLUPD,CCC,CYY,CMM,CDD
          REP       " 0",PMVXLUPD
          CLOCK     TIME,PMVXLUPT
.
          CALL      UPPMVX11
.
.         Public hospital, changed HF - check if inv.pending need tobe updated
.
          IF        CHOSTYP=1 & CFEETYP=0
            CLOSE     CONTROLF
            CLOSE     PRSPMIA1
.
            MOVE      ONE,PTIPRSTA                * Admission
            CALL      CINVP000                    * Check invoice pending
            OPEN      PRSPMIA1,"prspmiaf"
          ENDIF
.
UPMEMB99  RETURN
+
.------------------------------------------------------------------------------
. MHRI0000 -Update current/future episode with new PMI level MyHR consent value
.------------------------------------------------------------------------------
.
MHRI0000  CALL      IBACLOCK                * get TODAY's date
          PACK      TODAY,CCC,CYY,CMM,CDD
          REP       " 0",TODAY
.
          PACK      KEY24,URNUMBER,TODAY,SP70
          CALL      RSPTVIS2
MHRI0100  CALL      RKPTVIS2
          BRANCH    OVRCD,MHRI9999
.
          MATCH     URNUMBER,PVIURNO
          GOTO      MHRI9999 IF NOT EQUAL
.
          COMPARE   THREE,PVITYPE
          GOTO      MHRI0100 IF NOT EQUAL   * visit type is not inpatient
.
MHRI0200  PACK      KEY8,DPVIBILL,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,MHRI0100
.
          MATCH     PMPXI110,Z70
          IF        !@EQUAL
            MOVE      PMPXI110,PMVXUDF7
            CALL      UPPMVX11
          ENDIF
          GOTO      MHRI0100
.
MHRI9999  RETURN
+
.------------------------------------------------------------------------------
. UPMHRI00 - Update already admitted patient visit  
.------------------------------------------------------------------------------
.
UPMHRI00  MOVE      TWO,FORM1    * Current
.
UPMHRI05  PACK      KEY17,URNUMBER,FORM1,SP70
          CALL      RSPTMI18
UPMHRI10  CALL      RKPTMI18
          BRANCH    OVRCD,UPMHRI99
.
          MATCH     URNUMBER,AURNO
          GOTO      UPMHRI99 IF NOT EQUAL
.
          COMPARE   FORM1,ASTAT
          GOTO      UPMHRI80 IF NOT EQUAL
.
UPMHRI20  PACK      KEY8,DAADMNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,UPMHRI10
.
          MATCH     PMPXI110,Z70
          IF        !@EQUAL
            MOVE      PMPXI110,PMVXUDF7
            CALL      UPPMVX11
          ENDIF
          GOTO      UPMHRI10
.
UPMHRI80  IF       FORM1=2
            MOVE     FOUR,FORM1    On Leave
            GOTO     UPMHRI05
          ENDIF
.
UPMHRI99  RETURN
+
.---------------------------------------------------------------------
. TRNSII00 - Check to see if the CCIEX7AF table needs to be written to
.---------------------------------------------------------------------
.
TRNSII00  COMPARE   SIX,UPDATETY
          GOTO      TRNSII10 IF EQUAL
.
          GOTO      TRNSII99
.
TRNSII10  PACK      KEY8,AADMNO
          CALL      RDMISS1           * get the latest details
.
          MATCH     ADATE,SVMIADAT
          GOTO      TRNSII80 IF NOT EQUAL
.
          MATCH     ATIME,SVMIATIM
          GOTO      TRNSII80 IF NOT EQUAL
.
          MATCH     ACLSS,SVMICLSS
          GOTO      TRNSII80 IF NOT EQUAL
.
          MATCH     ACLAIM,SVMIACLM
          GOTO      TRNSII80 IF NOT EQUAL
.
          MATCH     ASRCE,SVMISRCE
          GOTO      TRNSII80 IF NOT EQUAL
.
          MATCH     ABWGHT,SVMIBWHT
          GOTO      TRNSII80 IF NOT EQUAL
.
          MATCH     ACARE,SVMICARE
          GOTO      TRNSII80 IF NOT EQUAL
.
          COMPARE   AVISIT,SVMIVIST
          GOTO      TRNSII80 IF NOT EQUAL
.
          MATCH     PMVXRHC1,SVMIRFGP
          GOTO      TRNSII80 IF NOT EQUAL
.
          PACK      KEY8,AADMNO
          CALL      RDPMVX11
          IF        OVRCD = 0
            MATCH     PMVXMDAV,SVVXMDAV
            GOTO      TRNSII80 IF NOT EQUAL
.
            MATCH     PMVXIRAD,SVVXIRAD
            GOTO      TRNSII80 IF NOT EQUAL
.
            MATCH     PMVXCADM,SVVXCADM
            GOTO      TRNSII80 IF NOT EQUAL
.
            MATCH     PMVXIDUS,SVVXIDUS
            GOTO      TRNSII80 IF NOT EQUAL
          ENDIF
.
          COMPARE   ONE,CHGATYPE
          GOTO      TRNSII80 IF EQUAL
.
          COMPARE   ONE,CHGDEPT
          GOTO      TRNSII80 IF EQUAL
.
          GOTO      TRNSII99
.
TRNSII80  MOVE      AADMNO,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD,TRNSII99
.
          MOVE      ANST,CLEXSTAT
          MOVE      PVITYPE,CLEXTYPE
          MOVE      PVIBILL,CLEXVISN
          PACK      KEY11,CLEXSTAT,CLEXTYPE,CLEXVISN
          CALL      RDCLEX71
          IF        OVRCD=1
            CALL      WRCLEX71
          ENDIF
.
TRNSII99  RETURN
+
.------------------------------------------------------------
. VALADM00 - Validate the date of birth if changed
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
.
VALADM00  MATCH     Z70,PTMAS017               * not changed
          GOTO      VALADM90 IF EQUAL
.
          MATCH     PTMAS017,PBDATE
          GOTO      VALADM90 IF EQUAL
.
          MATCH     PBDATE,PTMAS017
          GOTO      VALADM90 IF LESS
.
          PACK      KEY24,URNUMBER,SP70
          CALL      RSPTVIS2
VALADM10  CALL      RKPTVIS2
          BRANCH    OVRCD,VALADM90
.
          MATCH     URNUMBER,PVIURNO
          GOTO      VALADM90 IF NOT EQUAL
.
          COMPARE   THREE,PVITYPE
          GOTO      VALADM10 IF NOT EQUAL
.
          MATCH     "00000000",PVIDATE
          GOTO      VALADM10 IF EQUAL
.
          PACK      KEY8,PVIBILL
          CALL      RDMISS1
          BRANCH    OVRCD,VALADM10
.
          BRANCH    ASTAT,VALADM10
          IF        ASTAT=5
            GOTO      VALADM10
          ENDIF
          MATCH     ADATE,PTMAS017
          GOTO      VALADM10 IF LESS
          GOTO      VALADM10 IF EQUAL
.
          MOVE      "Patient has admissions before date of birth.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VALADM99
.
VALADM90  MOVE      ZERO,EXIT
.
VALADM99  RETURN
+
.------------------------------------------------------------
. Readin the surname index record
.------------------------------------------------------------
.
RDSURN00  MOVE      SP1,VCASE
          LOAD      VCASE,PCASE,CCNOTES
.
RDSURN20  CALL      NEWS0000                * using new soundex file
.
RDSURN99  RETURN
+
.------------------------------------------------------------
. OUTCLM00 - Update or Write Claim Details
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.                  2 = Ok to continue with warning
.------------------------------------------------------------
.
OUTCLM00  PACK      KEY24,URNUMBER,ADMISSNO,SP70
          CALL      RDOTLKB1
          BRANCH    OVRCD,OUTCLM91
.
          MATCH     ANSA,ACCFLAG1
          IF        @EQUAL
            CALL      ADET0000
          ELSE
            CALL      UPCLMD00                * Process claim details for all
          ENDIF
          BRANCH    EXIT,OUTCLM95
.
          MOVE      ADMISSNO,PARNTBOK
OUTCLM10  CALL      RKOTLKB1
          BRANCH    OVRCD,OUTCLM80
.
          MATCH     OTLKURNO,URNUMBER       * Same U/R
          GOTO      OUTCLM80 IF NOT EQUAL
.
          MATCH     OTLKOBOK,PARNTBOK       * Same series booking original
          GOTO      OUTCLM80 IF NOT EQUAL   * admission number
.
          MATCH     "1",OTLKBSTA            * Skip cancelled bookings
          GOTO      OUTCLM10 IF EQUAL
.
          MATCH     SP70,OTLKLBOK
          GOTO      OUTCLM80 IF EQUAL
.
          MOVE      OTLKLBOK,ADMISSNO
          MOVE      OTLKLBOK,PMEXT001
.
          MATCH     ANSA,ACCFLAG1
          IF        @EQUAL
            CALL      ADET0000
          ELSE
            CALL      UPCLMD00                * Process claim details for all
          ENDIF
          BRANCH    EXIT,OUTCLM95           * bookings in this series
.
          GOTO      OUTCLM10
.
OUTCLM80  MOVE      PARNTBOK,ADMISSNO       * Restore the original admission no
          MOVE      TWO,EXIT
          GOTO      OUTCLM99
.
OUTCLM91  MOVE      "Invalid Admission number claim details",WEBTITLE
          CALL      ADMERR00
OUTCLM95  MOVE      ONE,EXIT
          GOTO      OUTCLM99
.
OUTCLM98  MOVE      TWO,EXIT
          GOTO      OUTCLM99
.
OUTCLM99  RETURN
+
.------------------------------------------------------------
. UPCLMD00 - Update or Write Claim Details
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.                  2 = Ok to continue with warning
.------------------------------------------------------------
.
UPCLMD00  MOVE      ZERO,WARCOUNT
          COMPARE   ONE,CLMUPDFL
          GOTO      UPCLMD90 IF NOT EQUAL
.
          MATCH     "1",PTCNXCOM
          GOTO      UPCLMD06 IF NOT EQUAL    * Using Extra Compensable
.
          MATCH     "A",CLAIMTYP
          GOTO      UPCLMD50 IF EQUAL       * Australian defence force
          MATCH     "O",CLAIMTYP            * Other Compensable
          GOTO      UPCLMD50 IF EQUAL
          MATCH     "F",CLAIMTYP            * Foreign Defence
          GOTO      UPCLMD50 IF EQUAL
          MATCH     "H",CLAIMTYP            * Private
          GOTO      UPCLMD50 IF EQUAL
          MATCH     "S",CLAIMTYP            * Shipping
          GOTO      UPCLMD50 IF EQUAL
          MATCH     "X",CLAIMTYP            * WA - Motor Vehicle
          GOTO      UPCLMD50 IF EQUAL
          MATCH     "Y",CLAIMTYP            * WA - Veterans Affairs
          GOTO      UPCLMD50 IF EQUAL
          MATCH     "Z",CLAIMTYP            * WA - Workers Comp.
          GOTO      UPCLMD50 IF EQUAL
          MATCH     "E",CLAIMTYP
          GOTO      UPCLMD50 IF EQUAL       * Overseas student
          MATCH     "G",CLAIMTYP
          GOTO      UPCLMD50 IF EQUAL       * Overseas visitor
.
          GOTO      UPCLMD91
.
UPCLMD06  MATCH    "W",CLAIMTYP
          GOTO     UPCLMD10 IF EQUAL
.
          MATCH    "M",CLAIMTYP
          GOTO     UPCLMD20 IF EQUAL
.
          MATCH    "V",CLAIMTYP
          GOTO     UPCLMD30 IF EQUAL
.
          MATCH    "C",CLAIMTYP
          GOTO     UPCLMD40 IF EQUAL
.
          MATCH    "D",CLAIMTYP
          GOTO     UPCLMD50 IF EQUAL       * Defence force  (CAR: 288417)
.
          GOTO     UPCLMD91
.
.         Workers comp.
.
UPCLMD10  MOVE      TWO,MESSFLAG                 * set flag for error
          MOVE      ADMISSNO,KEY8
          CALL      RDWCOM1
          IF        OVRCD=1
            CALL      UPCLV000
            MOVE      ADMISSNO,WCADMNO
            MOVE      URNUMBER,PTWCURNO
            MOVE      ADMISSNO,KEY8
            CALL      RDVISA1
            IF        OVRCD=0
              MOVE      PVIDATE,PTWCVDAT
              MOVE      ZERO,MESSFLAG            * set flag for general visit
            ELSE
              MOVE      SP70,PTWCVDAT
              PACK      KEY36,ADMISSNO,SP20,SP20
              CALL      RDSBOKA6
              CALL      RDKBOKA6
              IF        OVRCD=0
                MATCH     ADMISSNO,DOBAOUTN
                IF        @EQUAL
                  MOVE      OBADATE,PTWCVDAT
                  MOVE      ONE,MESSFLAG         * set flag for O/P visit
                ENDIF
              ENDIF
            ENDIF
.
            CALL      WRWCOM1
.
.           If we are sending ACC details in PV1-20, then we need to
.           trigger an A08 message for the visit to reflect that this is
.           now an ACC patient
.
            MATCH     "1",PTCNH7AC
            IF        @EQUAL
              CALL      TACC0000                 * send update message
            ENDIF
.
            MOVE      THREE,FOLDERTY             * Set default to Work Cover
            CALL      UPFOLD00                   * Update PMI folder details
          ELSE
            CALL      UPCLV000
            MOVE      ADMISSNO,KEY8
            CALL      RDVISA1
            IF        OVRCD=0
              MOVE      PVIDATE,PTWCVDAT
              MOVE      ZERO,MESSFLAG            * set flag for general visit
            ELSE
              MOVE      SP70,PTWCVDAT
              PACK      KEY36,ADMISSNO,SP20,SP20
              CALL      RDSBOKA6
              CALL      RDKBOKA6
              IF        OVRCD=0
                MATCH     ADMISSNO,DOBAOUTN
                IF        @EQUAL
                  MOVE      OBADATE,PTWCVDAT
                  MOVE      ONE,MESSFLAG         * set flag for O/P visit
                ENDIF
              ENDIF
            ENDIF
            CALL      UPWCOM1
.
.           If we are sending ACC details in PV1-20, then we need to
.           trigger an A08 message for the visit to reflect that this is
.           now an ACC patient
.
            MATCH     "1",PTCNH7AC
            IF        @EQUAL
              CALL      TACC0000                 * send update message
            ENDIF
.
            MOVE      THREE,FOLDERTY             * Set default to Work Cover
            CALL      UPFOLD00                   * Update PMI folder details
          ENDIF
.
          MOVE      ADMISSNO,KEY8
          CALL      RDPMWX11
          IF        OVRCD=1
            CALL      UPCLV000
            MOVE      ADMISSNO,KEY8
            CALL      IBACLOCK
            PACK      PMWXCDTE,CCC,CYY,CMM,CDD       * Current Date
            REP       " 0",PMWXCDTE
            MOVE      CTIMEIS,PMWXCTIM               * Current Time
            MOVE      USERID,PMWXWEBC                * Current WebID
.
            CALL      WRPMWX11
          ELSE
            CALL      UPCLV000
            CALL      IBACLOCK
            PACK      PMWXLUPD,CCC,CYY,CMM,CDD       * Current Date
            REP       " 0",PMWXLUPD
            MOVE      CTIMEIS,PMWXLUPT               * Current Time
            MOVE      USERID,PMWXWEBU                * Current WebID
            CALL      UPPMWX11
          ENDIF
.
          CALL      DOCLMN00                * Delete any other claim details
          CALL      FPRA0000                * Fix PRA file            *I-119915
          GOTO      UPCLMD94
.
.         Motor Accident/TAC
.
UPCLMD20  MOVE      ADMISSNO,KEY8
          CALL      RDWMAB1
          COMPARE   ZERO,OVRCD
          GOTO      UPCLMD22 IF EQUAL
.
          CALL      UPCLV000
.
          MATCH     "1",TACINDCT
          IF        !@EQUAL
            MATCH     "19010101",MACDAT
            IF        !@EQUAL
              MATCH     SP70,MACDAT
              IF        !@EQUAL
                MATCH     PBDATE,MACDAT
                GOTO      UPCLMD92 IF LESS
              ENDIF
            ENDIF
          ENDIF
.
.... C CAR 55923
.... For NSW, there is no format requirement for TAC(MREFNO) number. Therefore,
.... no need to do the following checking on TAC number.
          IF        PTCNHDPS=3
            CALL      CLAIMN00
            BRANCH    ERRFLAG,UPCLMD93,UPCLMD93,UPCLMD93
            IF        ERRFLAG=4
              CLEAR     WEBTITLE
              APPEND    "Warning: Accident Date is more than 3 years ",WEBTITLE
              APPEND    "before the Claim date.",WEBTITLE
              APPEND    SP70,WEBTITLE
              RESET     WEBTITLE
              ADD       ONE,WARCOUNT
              MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
            ENDIF
          ENDIF
.
          MOVE      URNUMBER,PTWMURNO
          MOVE      ADMISSNO,KEY8
          CALL      RDVISA1
          IF        OVRCD=0
            MOVE      PVIDATE,PTWMVDAT
          ELSE
            MOVE      SP70,PTWMVDAT
            PACK      CFNAME,CFILEPRE,FILBOKA6
            OPEN      OUTBOKA6,CFNAME           * Open the file
            PACK      KEY36,ADMISSNO,Z70
            CALL      RDSBOKA6
            CALL      RDPBOKA6
            IF        OVRCD=0
              MATCH     ADMISSNO,DOBAOUTN
              IF        @EQUAL
                MOVE      OBADATE,PTWMVDAT
              ENDIF
            ENDIF
          ENDIF
.
          CALL      WRWMAB1
          MOVE      TWO,FOLDERTY               * Set default to TAC
          CALL      UPFOLD00                   * Update PMI folder details
          GOTO      UPCLMD24
.
.         TAC - record already exists
.
UPCLMD22  CALL      UPCLV000
.
          MATCH     "1",TACINDCT
          IF        !@EQUAL
            MATCH     "19010101",MACDAT
            IF        !@EQUAL
              MATCH     SP70,MACDAT
              IF        !@EQUAL
                MATCH     PBDATE,MACDAT
                GOTO      UPCLMD92 IF LESS
              ENDIF
            ENDIF
          ENDIF
.
.... C CAR 55923
.... For NSW, there is no format requirement for TAC(MREFNO) number. Therefore,
.... no need to do the following checking on TAC number.
          IF        PTCNHDPS=3
            CALL      CLAIMN00
            BRANCH    ERRFLAG,UPCLMD93,UPCLMD93,UPCLMD93
            IF        ERRFLAG=4
              CLEAR     WEBTITLE
              APPEND    "Warning: Accident Date is more than 3 years ",WEBTITLE
              APPEND    "before the Claim date.",WEBTITLE
              APPEND    SP70,WEBTITLE
              RESET     WEBTITLE
              ADD       ONE,WARCOUNT
              MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
            ENDIF
          ENDIF
.
          MOVE      ADMISSNO,KEY8
          CALL      RDVISA1
          IF        OVRCD=0
            MOVE      PVIDATE,PTWMVDAT
          ENDIF
          CALL      UPWMAB1
          MOVE      TWO,FOLDERTY            * Set default to TAC
          CALL      UPFOLD00                * Update PMI folder details
.
.         Check if we need to write a patpeiaf record for TAC changes
.
UPCLMD24  MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,UPCLMD25          * no adm record
.
          COMPARE   THREE,ASTAT
          GOTO      UPCLMD25 IF NOT EQUAL   * not discharged
.
          MOVE      ADMISSNO,KEY8
          CALL      RDDSCH1                 * need disch.date
          BRANCH    OVRCD,UPCLMD25
.
          MOVE      "13",HDPEQUIV
          CALL      WPEI0000                * Write patpeiaf record
.
UPCLMD25  CALL      DOCLMN00                * Delete any other claim details
          CALL      UPATAC00                * Update all Same MABs     *I-41560
          CALL      FPRA0000                * Fix PRA file            *I-119915
          GOTO      UPCLMD94
.
.         Veteran Affairs
.
UPCLMD30  MOVE      ADMISSNO,KEY8
          CALL      RDWVET1
          IF        OVRCD=1
            CALL      UPCLV000
            MOVE      ADMISSNO,KEY8
            CALL      WRWVET1
            MOVE      VCLMNO,PREPAT         * Write DVA number back to PMI
            CALL      UPMAST1
            MOVE      ONE,FOLDERTY               * Set default to DVA
            CALL      UPFOLD00                   * Update PMI folder details
          ELSE
            CALL      UPCLV000
            CALL      UPWVET1
            MOVE      VCLMNO,PREPAT         * Write DVA number back to PMI
            CALL      UPMAST1
            MOVE      ONE,FOLDERTY               * Set default to DVA
            CALL      UPFOLD00                   * Update PMI folder details
          ENDIF
          CALL      DOCLMN00                * Delete any other claim details
          CALL      FPRA0000                * Fix PRA file            *I-119915
          GOTO      UPCLMD94
.
.         Civil Tort
.
UPCLMD40  MOVE      ADMISSNO,KEY8
          CALL      RDPMCTC1
          IF        OVRCD=1
            CALL      UPCLV000
            MOVE      ADMISSNO,PMCTADMN
            MOVE      PVIURNO,PMCTURNO
            MOVE      PVIDATE,PMCTVDAT
            CALL      WRPMCTC1
            MOVE      FIVE,FOLDERTY               * Set default to TAC
            CALL      UPFOLD00                   * Update PMI folder details
          ELSE
            CALL      UPCLV000
            CALL      UPPMCTC1
            MOVE      FIVE,FOLDERTY               * Set default to TAC
            CALL      UPFOLD00                   * Update PMI folder details
          ENDIF
          CALL      DOCLMN00                * Delete any other claim details
          GOTO      UPCLMD94
.
. Extra compensable details
.
.
UPCLMD50  PACK      KEY11,PMEXT001,PMEXT002,SP70
          CALL      RDPMEXT1
          IF        OVRCD=1
            PACK      WAEXAUTH,SP70
            PACK      WAEXAUDA,SP70
            CALL      CLPMSEXT                    * Clear file vars
            CALL      MVPMEX00
            CALL      SCHA0000                    * Free format school Address
.
            PACK      PMEXCDAT,CCC,CYY,CMM,CDD
            REP       " 0",PMEXCDAT
            CLOCK     TIME,PMEXCTIM
            MOVE      USERID,PMEXCUID
.
            CALL      WRPMEXT1
.
            MATCH     "3",PMEXT055
            IF        @EQUAL
              PACK      KEY11,PMEXT001,PMEXT002,SP70
              CALL      RDPMEXT1
              BRANCH    OVRCD,UPCLMD90
              CALL      UPCLTY00   * if ICWA Status Confirmed update Claim Type
            ENDIF
          ELSE
            PACK      WAEXAUTH,PMEXAUTH,SP70
            PACK      WAEXAUDA,PMEXAUDA,SP70
            CALL      MVPMEX00
            CALL      SCHA0000                    * Free format school Address
.
            PACK      PMEXUDAT,CCC,CYY,CMM,CDD
            REP       " 0",PMEXUDAT
            CLOCK     TIME,PMEXUTIM
            MOVE      USERID,PMEXUUID
.
            CALL      UPPMEXT1
.
            MATCH     "3",PMEXT055
            IF        @EQUAL
              CALL      UPCLTY00   * if ICWA Status Confirmed update Claim Type
            ENDIF
          ENDIF
          MATCH     "1",PTCNSZEC             * sending ZEC Extra Compensible Details?
          IF        @EQUAL
            MOVE      PMEXT001,KEY8
            CALL      RDVISA1
            MOVE      OVRCD,MESSFLAG
            IF        OVRCD=1
              PACK      KEY36,PMEXT001,SP20,SP20
              CALL      RDSBOKA6                 * Booked (Not attended) op
              CALL      RDKBOKA6                 * visit
              IF        OVRCD=0
                MATCH     PMEXT001,DOBAOUTN
                IF        @EQUAL
                  MOVE      ONE,MESSFLAG         * set flag for O/P visit
                ENDIF
              ENDIF
            ENDIF
            CALL      TACC0000
          ENDIF
.
          MATCH     "Y",CLAIMTYP
          IF        @EQUAL
            PACK      KEY8,ADMISSNO,SP70
            CALL      RDMISS1
            IF        OVRCD<>1
              PROC      WRWATR00              * write to wa triggers (for DVA)
            ENDIF
          ENDIF
          CALL      DOCLMN00                * Delete any other claim details
          GOTO      UPCLMD94
.
UPCLMD90  MOVE      ZERO,EXIT
          GOTO      UPCLMD99
.
UPCLMD91  MOVE      "Invalid Claim Type",WEBTITLE
          CALL      ADMERR00
          MOVE      ONE,EXIT
          GOTO      UPCLMD99
.
UPCLMD92  MOVE      "Date of Accident cannot be before date of birth",WEBTITLE
          CALL      ADMERR00
          MOVE      ONE,EXIT
          GOTO      UPCLMD99
.
UPCLMD93  CLEAR     WEBTITLE
          IF        ERRFLAG=1
            APPEND    "Claim Number must be 7 or 8 digits.",WEBTITLE
          ENDIF

          IF          ERRFLAG=2
            APPEND    "Invalid Claim Number -",WEBTITLE
            APPEND    " Accident date cannot be after Claim year.",WEBTITLE
          ENDIF
.
          IF          ERRFLAG=3
            APPEND    "Invalid Claim Number -",WEBTITLE
            APPEND    " Accident date cannot be > 20",WEBTITLE
            APPEND    " years before Claim year.",WEBTITLE
          ENDIF
          CALL      ADMERR00
          MOVE      ONE,EXIT
          GOTO      UPCLMD99
.
UPCLMD94  MOVE      "Claim Details Updated",WEBTITLE
          MOVE      TWO,EXIT
          GOTO      UPCLMD99
.
UPCLMD99  RETURN
+
.---------------------------------------------------------------
. Update Claim Type to ALternate Election if ICWA Status is Confirmed
.---------------------------------------------------------------
UPCLTY00  PACK      KEY8,PMEXVISN,SP70
          CALL      RDPTVIS1
          BRANCH    OVRCD,UPCLTY99
.
          COMPARE   ONE,PVITYPE
          GOTO      UPCLTY10 IF EQUAL     * Emergency visit
.
          COMPARE   TWO,PVITYPE
          GOTO      UPCLTY20 IF EQUAL     * Outpatient visit
.
          COMPARE   THREE,PVITYPE
          GOTO      UPCLTY30 IF EQUAL     * Inpatient visit
.
          GOTO      UPCLTY99
.
UPCLTY10  PACK      KEY8,PMEXVISN,SP70
          CALL      RDEMVIS1              * read Emergency Visit file
          BRANCH    OVRCD,UPCLTY99
.
          MATCH     "2",DEMVISTA          * EMR Discharged Incomplete
          IF        @EQUAL
            PACK      VISITTYP,ANSE,ANSD,SP70  * Visit Type
            GOTO      UPCLTY40
          ENDIF
.
          MATCH     "3",DEMVISTA          * EMR Discharged Complete
          IF        @EQUAL
            PACK      VISITTYP,ANSE,ANSD,SP70  * Visit Type
            GOTO      UPCLTY40
          ENDIF
.
          GOTO      UPCLTY99
.
UPCLTY20  PACK      KEY36,PMEXVISN,SP70
          CALL      RDSBOKA6              * read Outpatients file
UPCLTY25  CALL      RDKBOKA6
          BRANCH    OVRCD,UPCLTY99
.
          MATCH     PMEXVISN,DOBAOUTN
          GOTO      UPCLTY99 IF NOT EQUAL
.
          MATCH     "4",DOBASTAT          * Booking Attended
          IF        @EQUAL
            PACK      VISITTYP,ANSO,ANSP,SP70  * Visit Type
            GOTO      UPCLTY40
          ENDIF
.
          GOTO      UPCLTY25              * read next record
.
UPCLTY30  PACK      KEY8,PMEXVISN,SP70
          CALL      RDPTMIS1              * read Patient Admissions file
          BRANCH    OVRCD,UPCLTY99
.
          MATCH     "2",DASTAT            * Inpatient Current Admission
          IF        @EQUAL
            PACK      VISITTYP,ANSI,ANSP,SP70  * Visit Type
            GOTO      UPCLTY40
          ENDIF
.
          MATCH     "3",DASTAT            * Inpatient Discharged
          IF        @EQUAL
            PACK      VISITTYP,ANSI,ANSP,SP70  * Visit Type
            GOTO      UPCLTY40
          ENDIF
.
          GOTO      UPCLTY99              * read next record
.
UPCLTY40  MATCH     "IP",VISITTYP
          IF        @EQUAL
            PACK      KEY8,PMEXVISN,SP70
            CALL      RDPTMIS1                    * read patmi1af
            BRANCH    OVRCD,UPCLTY45
            PACK      ACLAIM,PMEXALEL,SP70
            PACK      PTMIWEBU,USERID,SP70
            CALL      UPPTMIS1                    * update patmi1af
.
UPCLTY45    CALL      UPINSU00                  * set new insurance company
            PACK      PMEXCLAM,PMEXALEL,SP70
            CALL      UPPMEXT1                  * update pmsextaf
            CALL      UPTRAN00                  * update supervisor claim type
            CALL      UPHMDS00                  * update HMDS extract flag
            CALL      IPMESS00                    * send HL7 message
.
            PACK      KEY30,PMEXVISN,Z70
            CALL      RDSTRAN2
UPCLTY46    CALL      RDPTRAN2                  * read pattranf
            BRANCH    OVRCD,UPTRAN99
.
            MATCH     PMEXVISN,DTADMN           * match visit numbers
            GOTO      UPCLTY99 IF NOT EQUAL
.
            MATCH     PTTRCLTY,PMEXALEL         * is current & new CL different
            GOTO      UPCLTY46 IF EQUAL
.
            PACK      PTTRCLTY,PMEXALEL,SP70
            CALL      UPTRAN2                   * update pattranf
.
            GOTO      UPCLTY99
          ENDIF
.
          MATCH     "ED",VISITTYP
          IF        @EQUAL
            PACK      KEY8,PMEXVISN,SP70
            CALL      RDEMVIS1                    * read emrvisaf
            BRANCH    OVRCD,UPCLTY99
            PACK      EMVICOMP,PMEXALEL,SP70
            CALL      UPEMVIS1                    * update emrvisaf
.
            PACK      KEY8,EMVIADMN,SP70
            CALL      RDDETA1
            IF        OVRCD=0
              MOVE      EMVICOMP,ADACOMP
              CALL      UPDETA1                   * upate aaede1af
            ENDIF
.
            CALL      UPINSU00                    * set new insurance company
            PACK      PMEXCLAM,PMEXALEL,SP70
            CALL      UPPMEXT1                    * update pmsextaf
            CALL      EDMESS00                    * send HL7 message
            GOTO      UPCLTY99
          ENDIF
.
          MATCH     "OP",VISITTYP
          IF        @EQUAL
            PACK      KEY8,PMEXVISN,SP70
            CALL      RDBOKB1                     * read outbb1af
            BRANCH    OVRCD,UPCLTY50
            PACK      OBACOMP,PMEXALEL,SP70
            CALL      UPBOKB1                     * update outbb1af
            CALL      UPINSU00                    * set new insurance company
            PACK      PMEXCLAM,PMEXALEL,SP70
            CALL      UPPMEXT1                    * update pmsextaf
            CALL      OPMESS00                    * send HL7 message
.
UPCLTY50    PACK      KEY16,PMEXVISN,SP70
            CALL      RSALLNK2
UPCLTY55    CALL      RKALLNK2                    * read alllnkaf
            BRANCH    OVRCD,UPCLTY99
.
            MATCH     PMEXVISN,ALLNLNKV
            GOTO      UPCLTY99 IF NOT EQUAL
.
            PACK      KEY8,ALLNVISN,SP70
            CALL      RDALREF1                    * read allrefaf
            BRANCH    OVRCD,UPCLTY99
            PACK      ALRECOMP,PMEXALEL,SP70
            CALL      UPALREF1                    * update allrefaf
            CALL      LKMESS00                    * send HL7 message
            GOTO      UPCLTY55                    * next alllnkaf record
          ENDIF
.
UPCLTY99  RETURN
+
.--------------------------------------------------------------------------
. Update Insurance Company when MVIT Status is Confirmed
.--------------------------------------------------------------------------
UPINSU00  PACK      KEY6,SP70
          CALL      RDSINSR1                      * position on first record
UPINSU10  CALL      RDKINSR1                      * read next record
          BRANCH    OVRCD,UPINSU99
.
          MATCH     PTINCLAI,PMEXALEL
          GOTO      UPINSU10 IF NOT EQUAL
.
          PACK      PMEXICOD,ICODE,SP70           * save new insurance code for
          GOTO      UPINSU99                      * alt election ready for when
                                                  * pmsextaf is updated
.
UPINSU99  RETURN
+
.--------------------------------------------------------------------------
. Mimic Supervisor Claim Type Change - update pattranf & write to pmschaaf
.--------------------------------------------------------------------------
UPTRAN00  PACK      KEY30,PMEXVISN,Z70
          CALL      RDSTRAN2
UPTRAN10  CALL      RDPTRAN2                    * read pattranf
          BRANCH    OVRCD,UPTRAN99
.
          MATCH     PMEXVISN,DTADMN             * match visit numbers
          GOTO      UPTRAN99 IF NOT EQUAL
.
          MATCH     PTTRCLTY,PMEXALEL           * is current & new CL different
          GOTO      UPTRAN99 IF EQUAL
.
          PACK      SAVCLCD,PTTRCLTY,SP70       * save old claim type
          PACK      PTTRCLTY,PMEXALEL,SP70
          CALL      UPTRAN2                     * update pattranf
.
          PACK      PMCHADMN,DTADMN,SP70
          PACK      PMCHTDAT,TDATE,SP70
          PACK      PMCHTTIM,TTIME,SP70
          PACK      PMCHTWAR,TWARD,SP70
          PACK      PMCHTBED,TBED,SP70
          PACK      PMCHCDAT,CCC,CYY,CMM,CDD,SP70
          PACK      PMCHCTIM,CTIMEIS,SP70
          MOVE      "002",KEY3
          PACK      PMCHCTYP,KEY3,SP70
          PACK      PMCHREAS,REASCHNG,SP70
          PACK      PMCHOVAL,SAVCLCD,SP70
          PACK      PMCHNVAL,PTTRCLTY,SP70
          PACK      PMCHWEBC,USERID,SP70
          PACK      PMCHDATC,CCC,CYY,CMM,CDD,SP70
          PACK      PMCHTIMC,CTIMEIS,SP70
.
          PACK      KEY46,PMCHADMN,PMCHTDAT,PMCHTTIM,PMCHTWAR,PMCHTBED,PMCHCDAT,PMCHCTIM,SP70
          CALL      RAPMCHA1
          IF        OVRCD=1
            CALL      WRPMCHA1                  * write transfer audit record
          ENDIF
.
          CALL      CLPATTRN                    * clear pattranf variables
.
UPTRAN99  RETURN
+
.--------------------------------------------------------------------------
. Update HMDS Extract Flag for IP events
.--------------------------------------------------------------------------
UPHMDS00  PACK      KEY8,PMEXVISN,SP70
          CALL      RDPTMIS1                    * read patmi1af
          BRANCH    OVRCD,UPHMDS99
.
          COMPARE   ONE,AELIG
          IF        @EQUAL
            MOVE      ZERO,AELIG                  * reset HMDS extract flag
            CALL      UPPTMIS1                    * update patmi1af
          ENDIF
.
UPHMDS99  RETURN
+
.--------------------------------------------------------------------------
. Send A08 HL7 message for IP events
.--------------------------------------------------------------------------
IPMESS00  CALL      IBACLOCK                     * current date/time
.
.         Read the relevant records for the patient and
.         broadcast an HL7 update visit message (A08)
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPTMIS1                     * admission on file ?
          BRANCH    OVRCD,IPMESS99               * no - finish
.
          MOVE      AURNO,KEY8
          CALL      RDMAST1                      * pmi record on file ?
          BRANCH    OVRCD,IPMESS99               * no - finish
.
          MOVE      AURNO,KEY8
          CALL      RDPMPX21                     * get pmi extension record
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPTRES1                     * get PRA record
          IF        OVRCD=1
            CALL      CLPATRE1
          ENDIF
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDDSCH1                      * check for discharge record
          IF        OVRCD=1
            CALL      CLPATDSC
          ENDIF
.
.         Get the last transfer record
.
          PACK      KEY30,AADMNO,TILDA35
          CALL      RDSTRAN2                     * pos'n after last tran record
          CALL      RDPTRAN2                     * read previous record
          BRANCH    OVRCD,IPMESS99               * eof - finish
.
          MATCH     AADMNO,TADMN                 * same admission still ?
          GOTO      IPMESS99 IF NOT EQUAL        * no - finish
.
          CALL      PMIGTNID              * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      FORTY5,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICAC              * broadcast change admission details
.
IPMESS99  RETURN
+
.--------------------------------------------------------------------------
. Send A08 HL7 message for OP events
.--------------------------------------------------------------------------
OPMESS00  MOVE      PMEXURNO,KEY8
          CALL      RDMAST1                    * PMI record found ?
          BRANCH    OVRCD,OPMESS99             * no - don't send message
.
          MOVE      PMEXURNO,KEY8
          CALL      RDPMPX21                   * PMI extension record found ?
          BRANCH    OVRCD,OPMESS99             * no - don't send message
.
          MATCH     PMEXVISN,SP70
          GOTO      OPMESS99 IF EQUAL          * blank visit ?
.
          MOVE      PMEXVISN,D8                * visit number
.
          MOVE      FORTY6,HL7TRGID
.
          PACK      KEY36,D8,SP20,SP20
          CALL      RDSBOKA6                   * position on visit number
          CALL      RDKBOKA6                   * read next record
          BRANCH    OVRCD,OPMESS99             * eof - finished
.
          MATCH     DOBAOUTN,D8                * same visit number ?
          GOTO      OPMESS99 IF NOT EQUAL      * no - finished
.
.         Get the outbb1af record
.
          MOVE      D8,KEY8
          CALL      RDBOKB1                    * outbb1af record found ?
          BRANCH    OVRCD,OPMESS99             * no
.
          CALL      CLOUTRSH                   * clear unused variables
          CALL      CLOUTCAN
.
.         Set up the message for sending
.
          CALL      PMIGTNID                   * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      SP8,HL7INCLD
          PROC      DGCLICOB                   * send update visit details
.
OPMESS99  RETURN
+
.--------------------------------------------------------------------------
. Send A08 HL7 message for ED events
.--------------------------------------------------------------------------
EDMESS00  MOVE      EMVIURNO,KEY8               * get PMI details
          CALL      RDMAST1
          BRANCH    OVRCD,EDMESS99
.
          MOVE      EMVIURNO,KEY8
          CALL      RDPMPX21
          BRANCH    OVRCD,EDMESS99
.
          MOVE      EMVIADMN,KEY8
          CALL      RDPMVX11
          BRANCH    OVRCD,EDMESS99
.
          CALL      PMIGTNID
          MOVE      NMPNUMB,PTNINMPI
          MOVE      FORTY7,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICEC                    * send A08
.
EDMESS99  RETURN
+
.--------------------------------------------------------------------------
. Send I13 HL7 message for Linked Referral events
.--------------------------------------------------------------------------
LKMESS00  MOVE      ALLNVISN,KEY8
          CALL      RDALREF1                     * Admission record found ?
          BRANCH    OVRCD,LKMESS99               * no
          MOVE      PMEXURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,LKMESS99
          CALL      RDPMPX21
          BRANCH    OVRCD,LKMESS99
.
.         Set up the message for sending
.
          CALL      PMIGTNID                   * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      FORTY8,HL7TRGID
          MOVE      SP8,HL7INCLD
          CALL      DGCLII13                     * send update referral details
.
LKMESS99  RETURN
+
.------------------------------------------------------------
.         Fix up free format school address
.------------------------------------------------------------
SCHA0000  MATCH     "E",CLAIMTYP
          GOTO      SCHA9999 IF NOT EQUAL
          MATCH     Z70,PMEXT143
          IF        @EQUAL
            MOVE      SP70,PMEXSCHL
          ENDIF
          MATCH     Z70,PMEXT078
          IF        @EQUAL
            UNPACK    SP70,PMEXCAD1,PMEXCAD2
            UNPACK    SP70,PMEXCAD3,PMEXCAD4
            UNPACK    SP70,PMEXCPCD,PMEXCNAM
            UNPACK    SP70,PMEXECON,PMEXCPHN
          ENDIF
SCHA9999  RETURN
+
.------------------------------------------------------------
.  Fixed Person responsible for account
. Note:- copied from PATWEB98 (routine FPRA0000) to be applied
.        whenever Admission Claim Type is altered
.------------------------------------------------------------
FPRA0000 CALL       CLRRES00                * clear person responsible vars
.....    CALL       UPCLV000                * not used                 D-119915
         MOVE       ZERO,RESPFLAG
         MOVE       ADMISSNO,KEY8
         CALL       RDRESP1
         MOVE       OVRCD,RESPFLAG
         IF         OVRCD=1
           CALL      CLPATRE1               * Clear PRFA variables
         ENDIF
         MOVE       ADMISSNO,PKADMN
.
         MOVE       PMEXT002,KEY3      * Claim code
         CALL       PRFAINSR           * Copy Claim insurance details to PRFFA
         IF         OVRCD=0
           GOTO       FPRA9000
         ENDIF
.
         MATCH      "1",PTCNXCOM
         GOTO       FPRA0100 IF NOT EQUAL   * Not using extra compensable
.
         PACK       KEY11,ADMISSNO,PMEXT002,SP70       * CAR 275366
         CALL       RDPMEXT1
         BRANCH     OVRCD,FPRA9900
.
         MATCH      "A",CLAIMTYP
         GOTO       FPRA7000 IF EQUAL       * Australian Defence Force
         MATCH      "O",CLAIMTYP
         GOTO       FPRA5000 IF EQUAL       * Use Organisation for Other Comp.
         MATCH      "F",CLAIMTYP
         GOTO       FPRA7000 IF EQUAL       * Foreign Defence Force
         MATCH      "S",CLAIMTYP
         GOTO       FPRA6000 IF EQUAL       * Shipping Agent
         MATCH      "E",CLAIMTYP
         GOTO       FPRA7300 IF EQUAL       * Overseas Student
         MATCH      "G",CLAIMTYP
         GOTO       FPRA7300 IF EQUAL       * Overseas Student
.
         REP        "XMYVZW",CLAIMTYP
         MATCH      "M",CLAIMTYP
         GOTO       FPRA7000 IF EQUAL       * Motor Vehicle
         MATCH      "W",CLAIMTYP
         GOTO       FPRA7250 IF EQUAL       * Workers Comp - Employer details
         MATCH      "V",CLAIMTYP
         GOTO       FPRA7500 IF EQUAL       * Vet.Affairs default to Local Addr.
.
         PACK       ACLAIM,ACLAIM,SP70
         MATCH      SP70,ACLAIM
         IF         !@EQUAL
           PACK       KEY5,ANSC,ANSL,ACLAIM
           CALL       RDCODE1
           IF         OVRCD=0
             MOVE       TCINDC1,CLAIMTYP
           ENDIF
         ENDIF
         MATCH      SP70,CLAIMTYP
         GOTO       FPRA7500 IF EQUAL       * Use patient details
         MATCH      "P",CLAIMTYP
         GOTO       FPRA7500 IF EQUAL       * Public
         MATCH      "H",CLAIMTYP
         GOTO       FPRA6200 IF EQUAL       * Private
         MATCH      "J",CLAIMTYP
         GOTO       FPRA7500 IF EQUAL       * Private Uninsured
         MATCH      SP70,CLAIMTYP
         GOTO       FPRA7500 IF EQUAL       * Bulk Billing/Aff Funding/Unknown
.
         GOTO       FPRA9000
.
.        PTPCLRES - 0 use insurance company, 1 use patient details
.                   2 use prfa details, 3 use TAC, MAB or DVA details
.
FPRA0100 BRANCH     PTPCLRES,FPRA3000,FPRA9900
.
         MATCH      "M",CLAIMTYP
         GOTO       FPRA1000 IF EQUAL       * TAC
         MATCH      "V",CLAIMTYP
         GOTO       FPRA2000 IF EQUAL       * Veteran affair
         MATCH      "W",CLAIMTYP
         GOTO       FPRA0500 IF EQUAL       * W/C
.
         MATCH      "D",CLAIMTYP            * Defence Force
         IF         @EQUAL
           PACK       KEY11,ADMISSNO,PMEXT002,SP70
           CALL       RDPMEXT1
           BRANCH     OVRCD,FPRA9900
           GOTO       FPRA7000
         ENDIF
.
         GOTO       FPRA3000
.
.        Set W/C claim details
.
.                                           * start of code added from V6.14
FPRA0500  COMPARE   THREE,PTPCLRES
          GOTO      FPRA0700 IF NOT EQUAL
.
          COMPARE   ONE,WCACCPT             * Check if accepted by insurance
          GOTO      FPRA0700 IF NOT EQUAL   * no
          MATCH     SP6,WCICODE             * check for insurance code
          GOTO      FPRA0700 IF EQUAL       * no insurance code
          MOVE      WCICODE,KEY6
          CALL      RDINSR1                 * read insurance detail
          BRANCH    OVRCD,FPRA0700
.
          PACK      PKNAME,INAME,SP70,SP10
          MOVE      IADD1,PKADD1
          MOVE      IADD2,PKADD2
          MOVE      IADD3,PKSUBR
          MOVE      IADD4,PKADD4
          MOVE      IPOST,PKPOST
          MOVE      ITELEB,PKTELEB
          MOVE      "EMPL'S INS",PKRELP
          MOVE      SP20,PKTELEP
          MOVE      SP20,PTREMOBL
          MOVE      ADMISSNO,PKADMN          * was WCADMNO            *C-140841
          MOVE      SP70,PTRESNAM
          MOVE      SP70,PTREGNAM
          GOTO      FPRA9000
.                                           * end of code added from V6.14
FPRA0700 PACK       PKNAME,WCENAME,SP70,SP10
         MOVE       WCEADD1,PKADD1
         MOVE       WCEADD2,PKADD2
         MOVE       WCEADD3,PKSUBR
         MOVE       WCEADD4,PKADD4
         MOVE       WCEPOST,PKPOST
         MOVE       WCETELE,PKTELEB
         MOVE       "Employer  ",PKRELP
         MOVE       SP20,PKTELEP
         MOVE       SP20,PTREMOBL
         MOVE       ADMISSNO,PKADMN
         MOVE       SP70,PTRESNAM
         MOVE       SP70,PTREGNAM
         GOTO       FPRA9000
.
.        Set TAC claim details
.
FPRA1000 MOVE       CMABINS,KEY6
         CALL       RDINSR1
         COMPARE    ZERO,OVRCD
         GOTO       FPRA9900 IF NOT EQUAL
.
         PACK       PKNAME,INAME,SP70,SP10
         MOVE       IADD1,PKADD1
         MOVE       IADD2,PKADD2
         MOVE       IADD3,PKSUBR
         MOVE       IADD4,PKADD4
         MOVE       IPOST,PKPOST
         MOVE       ITELEB,PKTELEB
         MOVE       "T.A.C.    ",PKRELP
         MOVE       SP20,PKTELEP
         MOVE       SP20,PTREMOBL
         MOVE       ADMISSNO,PKADMN
         MOVE       SP70,PTRESNAM
         MOVE       SP70,PTREGNAM
         GOTO       FPRA9000
.
.        Set up Veteran affairs claim details
.
FPRA2000 MOVE       CVETINS,KEY6
         CALL       RDINSR1
         COMPARE    ZERO,OVRCD
         GOTO       FPRA9900 IF NOT EQUAL
.
         PACK       PKNAME,INAME,SP70,SP10
         MOVE       IADD1,PKADD1
         MOVE       IADD2,PKADD2
         MOVE       IADD3,PKSUBR
         MOVE       IADD4,PKADD4
         MOVE       IPOST,PKPOST
         MOVE       ITELEB,PKTELEB
         MOVE       "Vet.Affair",PKRELP
         MOVE       SP20,PKTELEP
         MOVE       SP20,PTREMOBL
         MOVE       ADMISSNO,PKADMN
         MOVE       SP70,PTRESNAM
         MOVE       SP70,PTREGNAM
         GOTO       FPRA9000
.
FPRA3000 CALL      CPRT0000                  * Check 'Parent of Option

         PACK      PKADD1,PADD1,SP30,SP20
         PACK      PKADD2,PADD2,SP30,SP20
         PACK      PKSUBR,PSUBRB,SP20,SP30
         PACK      PKADD4,PADD4,SP30,SP10
         PACK      PKPOST,PPOST,SP10,SP20
         PACK      PKTELEP,PTELEP,SP20
         PACK      PKTELEB,PTELEB,SP20
         PACK      PTREMOBL,PTMXCELL,SP20
         MOVE      ADMISSNO,PKADMN
         MOVE      PGNAME,PTREGNAM
         MOVE      PTMASNAM,PTRESNAM
         GOTO      FPRA9000
.
.        Use Organisation details for PRFA
.
FPRA5000 MATCH     SP70,PMEXPOLC
         GOTO      FPRA5500 IF EQUAL
         GOTO      FPRA5500 IF EOS
.
         MATCH     SP70,PMEXSCHL
         GOTO      FPRA5500 IF EQUAL
         GOTO      FPRA5500 IF EOS
.
         OPEN      PATEORA1,"pateoraf"
         MOVE      "O",KEY1
         PACK      KEY7,KEY1,PMEXSCHL,SP70
         CALL      RDPTEOR1
         BRANCH    OVRCD,FPRA5500
.
         PACK      PKNAME,PTERNAME,SP70,SP10
         MOVE      PTERADD1,PKADD1
         MOVE      PTERADD2,PKADD2
         MOVE      PTERADD3,PKSUBR
         MOVE      PTERADD4,PKADD4
         MOVE      PTERPOST,PKPOST
         MOVE      PTERTELP,PKTELEB
         MOVE      SP70,PKRELP
         MOVE      SP20,PKTELEP
         MOVE      SP20,PTREMOBL
         MOVE      ADMISSNO,PKADMN       * CAR 275366
         PACK      PTRESNAM,PTERCONT,SP70
         MOVE      SP70,PTREGNAM
         GOTO      FPRA9000
.
FPRA5500 MATCH     SP70,PMEXICOD
         GOTO      FPRA5800 IF EQUAL
         GOTO      FPRA5800 IF EOS
.
         PACK      KEY6,PMEXICOD,SP70
         CALL      RDINSR1
         BRANCH    OVRCD,FPRA5800
.
         PACK      PKNAME,INAME,SP70,SP10
         MOVE      IADD1,PKADD1
         MOVE      IADD2,PKADD2
         MOVE      IADD3,PKSUBR
         MOVE      IADD4,PKADD4
         MOVE      IPOST,PKPOST
         MOVE      ITELEB,PKTELEB
         MOVE      SP70,PKRELP
         MOVE      SP70,PKTELEP
         MOVE      SP70,PTREMOBL
         MOVE      ADMISSNO,PKADMN       * CAR 275366
         PACK      PTRESNAM,ICONT,SP70
         MOVE      SP70,PTREGNAM
         GOTO      FPRA9000
.
FPRA5800 MOVE      "2",KEY1                 * Postal Address
         CALL      DADR0000
         IF        EXIT=1
           MOVE      "7",KEY1               * Local Address
           CALL      DADR0000
           BRANCH    EXIT,FPRA3000
         ENDIF
         GOTO      FPRA8800
.
.-------------------------------------------------------------------------------
.        Shipping Agent
.-------------------------------------------------------------------------------
FPRA6000 MATCH     SP70,PMEXCAD1
         GOTO      FPRA8000 IF EQUAL
         GOTO      FPRA8000 IF EOS
.
         PACK      PKNAME,PMEXSAGN,SP70,SP10
         MOVE      PMEXCAD1,PKADD1
         MOVE      PMEXCAD2,PKADD2
         MOVE      PMEXCAD3,PKSUBR
         MOVE      PMEXCAD4,PKADD4
         MOVE      PMEXCPCD,PKPOST
         MOVE      PMEXCPHN,PKTELEB
         MOVE      SP70,PKRELP
         MOVE      SP20,PKTELEP
         MOVE      SP20,PTREMOBL
         MOVE      ADMISSNO,PKADMN       * CAR 275366
         PACK      PTRESNAM,PMEXCNAM,SP70
         MOVE      SP70,PTREGNAM
         GOTO      FPRA9000
.
.-------------------------------------------------------------------------------
.        Private
.-------------------------------------------------------------------------------
FPRA6200 MOVE      PFUNDH,HCODE
         MOVE      ADMISSNO,KEY8
         CALL      RDVISA1
         IF        OVRCD=0
           IF        PVITYPE=3
             MOVE      AFUNDH,HCODE       * Use Admission health fund
           ENDIF
         ENDIF
         MATCH     SP70,HCODE
         GOTO      FPRA0100 IF EQUAL
.
         PACK      KEY14,HCODE,ZERO8
         CALL      RDFUND1
         BRANCH    OVRCD,FPRA0100
.
         PACK      PKNAME,HFNAME,SP70
         PACK      PKADD1,HFADD1,SP70
         PACK      PKADD2,HFADD2,SP70
         PACK      PKSUBR,HFADD3,SP70
         PACK      PKADD4,HFADD4,SP70
         PACK      PKPOST,HFPCODE,SP70
.
         MOVE      HFTELE,PKTELEB
         MOVE      SP70,PKRELP
         MOVE      SP20,PKTELEP
         MOVE      SP20,PTREMOBL
         MOVE      ADMISSNO,PKADMN       * CAR 275366
         PACK      PTRESNAM,PTHFCNAM,SP70
         MOVE      SP70,PTREGNAM
         GOTO      FPRA9000
.
.-------------------------------------------------------------------------------
.
.        WA Extra Comp Australian Defence Force / Foreign Defence Force /
.        Workers Comp
.
FPRA7000 MATCH     SP70,PMEXICOD
         GOTO      FPRA7100 IF NOT EQUAL        * insurance company
.
         MATCH     SP70,PMEXCAD1
         GOTO      FPRA7200 IF NOT EQUAL        * insurance company
.
         GOTO      FPRA8000                     * patient details
.
FPRA7100 PACK      KEY6,PMEXICOD,SP70
         CALL      RDINSR1
         BRANCH    OVRCD,FPRA3000
.
         PACK      PKNAME,INAME,SP70,SP10
         MOVE      IADD1,PKADD1
         MOVE      IADD2,PKADD2
         MOVE      IADD3,PKSUBR
         MOVE      IADD4,PKADD4
         MOVE      IPOST,PKPOST
         MOVE      ITELEB,PKTELEB
         MOVE      SP70,PKRELP
         MOVE      SP70,PKTELEP
         MOVE      SP70,PTREMOBL
         MOVE      ADMISSNO,PKADMN       * CAR 275366
         PACK      PTRESNAM,ICONT,SP70
         MOVE      SP70,PTREGNAM
.
         GOTO      FPRA9000
.
FPRA7200 CALL      CPRT0000                  * Check 'Parent of Option
.
         MOVE      PMEXCAD1,PKADD1
         MOVE      PMEXCAD2,PKADD2
         MOVE      PMEXCAD3,PKSUBR
         MOVE      PMEXCPCD,PKPOST
         MOVE      PMEXCAD4,PKADD4
         MOVE      PMEXCPHN,PKTELEB
         MOVE      SP70,PKTELEP
         MOVE      SP70,PTREMOBL
         MOVE      ADMISSNO,PKADMN       * CAR 275366
         PACK      PTRESNAM,PMEXCNAM,SP70
         MOVE      SP70,PTREGNAM
.
         GOTO      FPRA9000
.
.-------------------------------------------------------------------------------
.        Workers Comp - default the Employer as PRFA
.-------------------------------------------------------------------------------
FPRA7250 PACK      PKNAME,PMEXNAME,SP70,SP10
         MOVE      PMEXADD1,PKADD1
         MOVE      PMEXADD2,PKADD2
         MOVE      PMEXADD3,PKSUBR
         MOVE      PMEXADD4,PKADD4
         MOVE      PMEXPOST,PKPOST
         MOVE      PMEXEPHN,PKTELEB
         MOVE      "Employer  ",PKRELP
         MOVE      SP70,PKTELEP
         MOVE      SP70,PTREMOBL
         MOVE      ADMISSNO,PKADMN
         PACK      PTRESNAM,PMEXCNAM,SP70
         MOVE      SP70,PTREGNAM

         GOTO      FPRA9000
.
.-------------------------------------------------------------------------------
.        Overseas Student or Overseas Visitor
.        Try Local and Overseas/patient Address
.-------------------------------------------------------------------------------
FPRA7300 MOVE      "7",KEY1               * Local Address
         CALL      DADR0000
         BRANCH    EXIT,FPRA3000          * default to patient details
.
         MATCH      "E",CLAIMTYP
         GOTO       FPRA8800 IF EQUAL     * Overseas student default to Local
.
.      If 'Send bill to Local' is ticked, PRFA will be the Local address
.      If 'Send bill to Local' is not ticked, PRFA will be PMI/Overseas Address
.
         MATCH     "1",PMEXSBIL           * Send bill to Local address
         GOTO      FPRA3000 IF NOT EQUAL
.
         GOTO      FPRA8800
.
.        Try Postal address if no Postal default to patient's address
.
FPRA7500 MOVE      "2",KEY1               * Postal Address
         CALL      DADR0000
         BRANCH    EXIT,FPRA3000          * default to patient details
.
         GOTO      FPRA8800
.
.-------------------------------------------------------------------------------
.        If indicator18=B - Leave PRFA blank
.-------------------------------------------------------------------------------
FPRA8000 PACK      KEY5,ANSC,ANSL,PMEXCLAM,SP70
         CALL      RDCODE1
         IF        OVRCD=0
           MATCH     "B",TCINDC18
           IF        @EQUAL
             CALL      CLPATRE1              * Clear PRFA
             GOTO      FPRA9000
           ENDIF
         ENDIF
         GOTO      FPRA3000                  * Patient details
.
.-------------------------------------------------------------------------------
.        Default PRFA to use the Extra Contract details
.-------------------------------------------------------------------------------
FPRA8800 CALL      CPRT0000                  * Check 'Parent of Option
         MOVE      PMCEADD1,PKADD1
         MOVE      PMCEADD2,PKADD2
         MOVE      PMCEADD3,PKSUBR
         MOVE      PMCEADD4,PKADD4
         MOVE      PMCEPOST,PKPOST
         MOVE      PMCETELB,PKTELEB
         MOVE      PMCETELP,PKTELEP
         MOVE      PMCETELM,PTREMOBL
         MOVE      ADMISSNO,PKADMN       * CAR 275366
         MOVE      PGNAME,PTREGNAM
         MOVE      PTMASNAM,PTRESNAM
         GOTO      FPRA9000
.
FPRA9000 IF        RESPFLAG=1
           PACK      KEY8,ADMISSNO,SP70
           CALL      WRRESP1
         ELSE
           CALL      UPRESP1
         ENDIF
         CALL      TACC0000                   * send HL7 message
.
FPRA9900 MOVE      ZERO,EXIT
FPRA9999 RETURN
+
.------------------------------------------------------------
.        Check if we are using 'Parent of' Option
.------------------------------------------------------------
CPRT0000 MOVE      URNUMBER,KEY8
         CALL      RDMAST1
         BRANCH    OVRCD,CPRT9999
.
         COMPARE   ONE,PTCNPAOF              * Using 'Parent of' option?
         GOTO      CPRT8000 IF NOT EQUAL     * no
.
         PACK      AGEDATE,CCC,CYY,CMM,CDD
         CALL      CALCAGE                   * CALCAGE uses PBDATE
         COMPARE   PSAGEYRS,CAGECOFF         * Child?
         GOTO      CPRT8000 IF LESS          * No
.
.-------- Setup 'Parent of' as Person Responsible for Account
.
         MOVE      SP1,ANS
         MOVE      PGNAME,ANS
         PACK      PKNAME,SP70,SP10
.
         CLEAR     PKNAME
         APPEND    "Parent of ",PKNAME
         APPEND    ANS,PKNAME
         APPEND    DOT,PKNAME
         APPEND    SP1,PKNAME
         APPEND    PTMASNAM,PKNAME
         APPEND    SP70,PKNAME
         RESET     PKNAME
         MOVE      "Parent    ",PKRELP
         GOTO      CPRT9999
.
.-------- Use self as P.R.A.
CPRT8000 MOVE      SP1,ANS
         MOVE      PGNAME,ANS
         PACK      PKNAME,PTITL,SP1,ANS,DOT,PTMASNAM,SP70
         MOVE      SP70,PKRELP
.        MOVE      "SELF      ",PKRELP
.
CPRT9999 RETURN
+
.------------------------------------------------------------
.        Default Address from Extra Contract file
.------------------------------------------------------------
DADR0000  PACK      KEY14,URNUMBER,SP70
          CALL      RSPMCEX1
DADR1000  CALL      RKPMCEX1
          BRANCH    OVRCD,DADR9000
          MATCH     URNUMBER,PMCEURNO         * Same U/R?
          GOTO      DADR9000 IF NOT EQUAL
.
          MATCH     SP70,PMCETYPE
          GOTO      DADR1000 IF EQUAL
          MOVE      "tc",KEY2
          PACK      KEY5,KEY2,PMCETYPE
          CALL      RDCODE1
          BRANCH    OVRCD,DADR1000
          MATCH     KEY1,TCINDC1
          GOTO      DADR1000 IF NOT EQUAL
.
          MATCH     "1",PMCEACTV
          IF        @EQUAL
            MATCH     PMCEDINA,ADATE          * Check Inactive date
            GOTO      DADR1000 IF NOT LESS
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      DADR99999
.
DADR9000  MOVE      ONE,EXIT
DADR9999  RETURN
+
.-----------------------------------------------------------------------------
.         Get Usual PRFA details
.-----------------------------------------------------------------------------
UPRF0000  MATCH     SP70,PMPXUPRF
          GOTO      UPRF9000 IF EQUAL
.
          PACK      KEY14,URNUMBER,PMPXUPRF,Z70
          CALL      RSPMCEX1
UPRF1000  CALL      RPPMCEX1
          BRANCH    OVRCD,UPRF9000
.
          MATCH     URNUMBER,PMCEURNO            * Same U/R
          GOTO      UPRF9000 IF NOT EQUAL
.
          MATCH     PMPXUPRF,PMCETYPE            * Same Contact Type
          GOTO      UPRF9000 IF NOT EQUAL
.
          MATCH     "1",PMCEACTV                 * Skip if Inactive
          GOTO      UPRF1000 IF EQUAL
.
.         Default to Patient's name if Contact name is blank
.
          PACK      KEY80,PMCESNAM,PMCEGNAM,SP70
          MATCH     SP70,KEY80
          IF        @EQUAL
            MOVE      PTMASNAM,PACSNAMX
            MOVE      PGNAME,ANS
            PACK      PACGNAME,ANS,DOT
            MOVE      PTITL,PACTITLE
          ELSE
            MOVE      PMCESNAM,PACSNAMX
            MOVE      PMCEGNAM,ANS
            PACK      PACGNAME,ANS,DOT
            MOVE      PMCETITL,PACTITLE
          ENDIF
          MOVE      THREE,PACFRMT
          CALL      PACNAME
          PACK      PKNAME,PACFNAMX,SP70,SP10
.
          MOVE      PMCEADD1,PKADD1         * Address line 1
          MOVE      PMCEADD2,PKADD2         * Address line 2
          MOVE      PMCEADD3,PKSUBR         * Address line 3
          MOVE      PMCEADD4,PKADD4         * Address line 4
          MOVE      PMCEPOST,PKPOST
          MOVE      PMCETELP,PKTELEP
          MOVE      PMCETELB,PKTELEB
          MOVE      PMCERELP,PKRELP
          MOVE      PMCETELM,PTREMOBL
          MOVE      PMCESNAM,PTRESNAM
          MOVE      PMCEGNAM,PTREGNAM
.
          MOVE      ZERO,EXIT
          GOTO      UPRF9999
.
UPRF9000  MOVE      ONE,EXIT
UPRF9999  RETURN
+
.-----------------------------------------------------------------------------
.         Update all TAC claims with the same MAB number               *I-41560
.-----------------------------------------------------------------------------
UPATAC00  MATCH     "C-U",PTCLM015
          GOTO      UPATAC99 IF EQUAL
.
          PACK      KEY44,PTCLM015,URNUMBER,SP70
          CALL      RDSWMAB3
UPATAC10  CALL      RDKWMAB3
          BRANCH    OVRCD,UPATAC99
.
          MATCH     SP70,MREFNO
          GOTO      UPATAC99 IF EQUAL
          GOTO      UPATAC99 IF EOS
.
          MATCH     PTCLM015,MREFNO
          GOTO      UPATAC99 IF NOT EQUAL
.
          MATCH     PTWMURNO,URNUMBER
          GOTO      UPATAC99 IF NOT EQUAL
.
          CALL      UPCLV000
.
UPATAC20  CALL      UPWMAB3
          GOTO      UPATAC10
.
UPATAC99  RETURN
+
.-----------------------------------------------------------------------------
. DOCLMN00 - Delete any other claim details
.-----------------------------------------------------------------------------
DOCLMN00  MATCH     "1",PTCNXCOM
          GOTO      DOCLMN99 IF EQUAL  * Using Extra Compensable
.
          MATCH     "W",CLAIMTYP
          IF        @EQUAL
            CALL      DEWMAB00         * Delete TAC
            CALL      DEWVET00         * Delete Veteran affairs
            CALL      DEWCTC00         * Delete Civil Tort
          ENDIF
.
          MATCH     "M",CLAIMTYP
          IF        @EQUAL
            CALL      DEWCOM00         * Delete Workers Comp.
            CALL      DEWVET00         * Delete Veteran affairs
            CALL      DEWCTC00         * Delete Civil Tort
          ENDIF
.
          MATCH     "V",CLAIMTYP
          IF        @EQUAL
            CALL      DEWMAB00         * Delete TAC
            CALL      DEWCOM00         * Delete Workers Comp.
            CALL      DEWCTC00         * Delete Civil Tort
          ENDIF
.
          MATCH     "C",CLAIMTYP
          IF        @EQUAL
            CALL      DEWMAB00         * Delete TAC
            CALL      DEWCOM00         * Delete Workers Comp.
            CALL      DEWVET00         * Delete Veteran affairs
          ENDIF
.
DOCLMN99  RETURN
+
.-----------------------------------------------------------------------------
. CKCLMD00 - Check claim details
. If claim code changed to non-compensabile, remove all comp.details
.-----------------------------------------------------------------------------
.
CKCLMD00  MATCH     "1",PTCNXCOM
          GOTO      CKCLMD99 IF EQUAL  * Using Extra Compensable
.
          PACK      KEY5,CODECL,ACLAIM
          CALL      RDCODE1
          BRANCH    OVRCD,CKCLMD99
.
.         Check the indicators for a W, M, or V (these are the claims)
.
          MOVE      ZERO,FORM2
CKCLMD10  ADD       ONE,FORM2
          COMPARE   SIX,FORM2
          GOTO      CKCLMD90 IF NOT LESS
.
          LOAD      ANS,FORM2,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
          CMATCH    "W",ANS
          GOTO      CKCLMD99 IF EQUAL
.
          CMATCH    "M",ANS
          GOTO      CKCLMD99 IF EQUAL
.
          CMATCH    "V",ANS
          GOTO      CKCLMD99 IF EQUAL
.
          CMATCH    "C",ANS
          GOTO      CKCLMD99 IF EQUAL
.
          GOTO      CKCLMD10
.
CKCLMD90  CALL      DEWMAB00         * Delete TAC
          CALL      DEWCOM00         * Delete Workers Comp.
          CALL      DEWVET00         * Delete Veteran affairs
          CALL      DEWCTC00         * Delete Civil Tort
.
CKCLMD99  RETURN
+
.-----------------------------------------------------------------------------
. DEWCOM00 - Delete Workers comp. details
.-----------------------------------------------------------------------------
.
DEWCOM00  COMPARE   ONE,PTCNHDPS           * Is it for NZ?
          GOTO      DEWCOM10 IF NOT EQUAL  * Not NZ; proceed to delete WC record
.
          MOVE      AURNO,CHWCURNO
          MOVE      AADMNO,CHWCADMN
          PROC      CHKWCCLM           * check for multiple WC claims records
          BRANCH    EXIT,DEWCOM10
.
.         Only one record with the ACC number, so we just update the
.         Claim Status to "Cancelled" instead of deleting the patwc1af record.
.
          COMPARE   ONE,FORM1            * one record found in CHKWCCLM
          IF        @EQUAL
            MOVE      AADMNO,KEY8
            CALL      RDPMWX11
            BRANCH    OVRCD,DEWCOM99
.
            MOVE      THREE,PMWXCSTA     * set Claim Status to "Cancelled"
            CALL      UPPMWX11
          ENDIF
          CALL      MVACCREM           * Add record ACC Audit file
          GOTO      DEWCOM99
.
DEWCOM10  MOVE      AADMNO,KEY8
          CALL      RDWCOM1
          COMPARE   ZERO,OVRCD
          IF        @EQUAL
            IF        PTCNHDPS=1
              CALL      MVACCREM           * Add record ACC Audit file
            ENDIF
            CALL      DEWCOM1                    * delete patwc1af record
.
.           If we are sending ACC details in PV1-20, then we need to
.           trigger an A08 message for the visit to reflect that this is
.           no longer an ACC patient
.
            MOVE      AADMNO,KEY8
            CALL      RDEMVIS1
            BRANCH    OVRCD,DEWCOM50           * don't send A08 if not emr vis
.
            MATCH     "1",PTCNH7AC
            IF        @EQUAL
              CALL      PMIGTNID               * get national id for dgate write
              MOVE      NMPNUMB,PTNINMPI
              MOVE      NINE,HL7TRGID
              MOVE      SP8,HL7INCLD
              PROC      DGCLICEC                 * send update emr details
            ENDIF
          ENDIF
.
DEWCOM50  MOVE      AADMNO,KEY8
          CALL      RDPMWX11
          COMPARE   ZERO,OVRCD
          CALL      DEPMWX11 IF EQUAL
.
DEWCOM99  RETURN
+
.-----------------------------------------------------------------------------
. DEWMAB00 - Delete TAC details
.-----------------------------------------------------------------------------
.
DEWMAB00  MOVE      AADMNO,KEY8
          CALL      RDWMAB1
          COMPARE   ZERO,OVRCD
          CALL      DEWMAB1 IF EQUAL
.
DEWMAB99  RETURN
+
.-----------------------------------------------------------------------------
. DEWVET00 - Delete Veteran Affairs details
.-----------------------------------------------------------------------------
.
DEWVET00  MOVE      AADMNO,KEY8
          CALL      RDWVET1
          COMPARE   ZERO,OVRCD
          CALL      DEWVET1 IF EQUAL
.
DEWVET99  RETURN
+
.-----------------------------------------------------------------------------
. DEWCTC00 - Delete Civil Tort details
.-----------------------------------------------------------------------------
.
DEWCTC00  MOVE      AADMNO,KEY8
          CALL      RDPMCTC1
          COMPARE   ZERO,OVRCD
          CALL      DEPMCTC1 IF EQUAL
.
DEWCTC99  RETURN
+
.-----------------------------------------------------------------------------
. CLAIMN00   : Check claim number
.              If claim number is not blank, then must be in format YYNNNNN
.              where YY is year of the accident date and NNNNN is numeric or
.              C-U if the claim number is unknown
.
.  Error/Reject  - if the accident date is more than 20 years b/f claim date
.                - if claim number is not numeric
.  Warning - if the accident date is more than 3 years b/f claim date
.-----------------------------------------------------------------------------
.
CLAIMN00  MOVE      ZERO,ERRFLAG
          MATCH     SP70,MACDAT
          GOTO      CLAIMN99 IF EQUAL
.
          UNPACK    MACDAT,XCENT,XYEAR,XMON,XDAY
          ENDSET    MREFNO
          APPEND    SP70,MREFNO
          RESET     MREFNO
.
          MATCH     "1",TACINDCT
          IF        !@EQUAL
            MATCH     SP8,MREFNO
            IF        @EQUAL
              MOVE      "C-U     ",MREFNO
            ENDIF
          ENDIF
.
          MATCH     "1",TACINDCT
          IF        !@EQUAL
            MATCH     "C-U     ",MREFNO
          ELSE
            MATCH     SP70,MREFNO
          ENDIF
          IF        !@EQUAL
            UNPACK    SP70,KEY2,KEY6,KEY20
            UNPACK    MREFNO,KEY2,KEY1,KEY6,KEY20
            MATCH     KEY1,SLASH
            IF        !@EQUAL
              UNPACK    SP70,KEY2,KEY1,KEY6,KEY20
              UNPACK    MREFNO,KEY2,KEY6,KEY20
            ENDIF
            TYPE      KEY2                          * I CAR 47395
            GOTO      CLAIMN10 IF NOT EQUAL         * I CAR 47395
            MATCH     "19010101",MACDAT
            IF        !@EQUAL
              MATCH     SP20,KEY20
              GOTO      CLAIMN10 IF NOT EQUAL
              CALL      CYER0000           * Check year of Acc.date/TAC no
            ENDIF
.
            SQUEEZE   KEY6
            TYPE      KEY6
            GOTO      CLAIMN10 IF NOT EQUAL
          ENDIF
          GOTO      CLAIMN99
.
CLAIMN10  MOVE      ONE,ERRFLAG             * must be 5 digits
.
CLAIMN99  RETURN
+
.------------------------------------------------------------
. CYER0000  : Check TAC year against TAC number
.------------------------------------------------------------
.
.         Work out the financial year of claim using fist two digit of TAC no
.
CYER0000  MOVE      ZERO,FORM2
          MOVE      KEY2,FORM2         * First two digit of TAC claim no
          IF        FORM2>50
            MOVE      "19",CCENT       * if year > 50, make century = 19
          ELSE
            MOVE      "20",CCENT       * if year < 50, make century = 20
          ENDIF
          PACK      KEY4A,CCENT,KEY2
          REP       " 0",KEY4A          * Financial year of claim
.
.         Get the financial year of the accident date
.
          UNPACK    MACDAT,XCENT,XYEAR,XMON,XDAY   * Accident date
          MOVE      ZERO,FORM2
          MOVE      XMON,FORM2
          IF        FORM2>=7
            PACK      KEY4,XCENT,XYEAR
          ELSE
            PACK      DIM4,XCENT,XYEAR
            REP       " 0",DIM4
            MOVE      ZERO,FORM4
            MOVE      DIM4,FORM4
            SUB       ONE,FORM4
            MOVE      FORM4,KEY4      * Financial year of accident date
          ENDIF
.
.         Get the number of years difference b/w financial year of
.         accident date and claim (ie the first two digits of TAC claim no)
.
          MOVE      ZERO,FORM4
          MOVE      ZERO,FORM4A
.
          MOVE      KEY4,FORM4         * year from Accident date
          MOVE      KEY4A,FORM4A       * financial year from TAC Claim no
          SUB       FORM4,FORM4A       * sub accident year from claim year
          IF        FORM4A<0
            MOVE      TWO,ERRFLAG      * Reject; Claim date before Accident date
          ENDIF
.
.         Reject if date difference b/w accident date and claim date is more
.         than 20 years, Warning if more than 3 years.
.
          IF        FORM4A>20
            MOVE      THREE,ERRFLAG    * Reject; Accident > 20 yrs before Claim
            GOTO      CYER9999
          ENDIF
.
          IF        FORM4A>3
            MOVE      FOUR,ERRFLAG     * Warning; Accident > 3 yrs before Claim
            GOTO      CYER9999
          ENDIF
.
CYER9999  RETURN
+
.------------------------------------------------------------
. ASSURN00 : We have an associated U/R number.
.            Now find the correct U/R number.
. From PATCOMN1
. Returns:    EXIT  0 = Ok to continue
.                   1 = Error
.----------------------------------------------------------------------
.
ASSURN00  MOVE      PPSNAME,CPPURNO     * This is where the new U/R is hidden
.
.         We have to check this new U/R number, just in case it is also
.         associated to another U/R number. eg. A->B->C->D->...->H
.
          MOVE      CPPURNO,KEY8        * Key for new U/R number
          CALL      RDMAST1             * Read in the new PMI record
          BRANCH    OVRCD,ASSURN91      * New U/R number missing
          BRANCH    PSTAT,ASSURN00      * Another associated U/R number
.
.         We have the correct U/R number
.
          MOVE      ZERO,EXIT
          GOTO      ASSURN99            * Return the U/R
.
.         Error in the data files. Tell the user, and ask for another U/R
.
ASSURN91  CLEAR     WEBTITLE
          APPEND    "Error: U/R merged with ",WEBTITLE
          APPEND    CPPURNO,WEBTITLE
          APPEND    " which is missing. ",WEBTITLE
          RESET     WEBTITLE
          CALL      ADMERR00
          MOVE      ONE,EXIT
.
ASSURN99  RETURN
+
.------------------------------------------------------------
. UPDMAS00 - Update Master Details
.------------------------------------------------------------
.
UPDMAS00  MATCH     PTMAS001,Z70
          IF        !@EQUAL
            MOVE      PTMAS001,PTITL
          ENDIF
.
          COMPARE   PTMAS002,ZERO
          IF        !@EQUAL
            MOVE      PTMAS002,PHOSP
          ENDIF
.
          COMPARE   PTMAS003,ZERO
          IF        !@EQUAL
            MOVE      PTMAS003,PLDAYS
          ENDIF
.
          MATCH     PTMAS004,Z70
          IF        !@EQUAL
            MOVE      PTMAS004,PBDEBT
          ENDIF
.
          MATCH     PTMAS005,Z70
          IF        !@EQUAL
            PACK      PSNAME,PTMAS005,SP70
            PACK      PTMASNAM,PTMAS005,SP70
          ENDIF
.
          MATCH     PTMAS006,Z70
          IF        !@EQUAL
            PACK      PGNAME,PTMAS006,SP70
          ENDIF
.
          MATCH     PTMAS007,Z70
          IF        !@EQUAL
            PACK      PPSNAME,PTMAS007,SP70
          ENDIF
.
          MATCH     PTMAS008,Z70
          IF        !@EQUAL
            MOVE      PTMAS008,PADD1
          ENDIF
.
          MATCH     PTMAS009,Z70
          IF        !@EQUAL
            MOVE      PTMAS009,PADD2
          ENDIF
.
          MATCH     PTMAS010,Z70
          IF        !@EQUAL
            MOVE      PTMAS010,PSUBRB
          ENDIF
.
          MATCH     PTMAS011,Z70
          IF        !@EQUAL
            MOVE      PTMAS011,PADD4
          ENDIF
.
          MATCH     PTMAS012,Z70
          IF        !@EQUAL
            MOVE      PTMAS012,PPOST
          ENDIF
.
          MATCH     PTMAS013,Z70
          IF        !@EQUAL
            MOVE      PTMAS013,PTELEP
          ENDIF
.
          MATCH     PTMAS014,Z70
          IF        !@EQUAL
            MOVE      PTMAS014,PTELEB
          ENDIF
.
          MATCH     PTMAS015,Z70
          IF        !@EQUAL
            MOVE      PTMAS015,PSEX
          ENDIF
.
          MATCH     PTMAS016,Z70
          IF        !@EQUAL
            MOVE      PTMAS016,PMSTAT
          ENDIF
.
          MATCH     PTMAS017,Z70
          IF        !@EQUAL
            MOVE      PTMAS017,PBDATE
          ENDIF
.
          COMPARE   PTMAS018,ZERO
          IF        !@EQUAL
            MOVE      PTMAS018,PSAGE
          ENDIF
.
          MATCH     PTMAS019,Z70
          IF        !@EQUAL
            MOVE      PTMAS019,PCONT
          ENDIF
.
          MATCH     PTMAS020,Z70
          IF        !@EQUAL
            MOVE      PTMAS020,PREG
          ENDIF
.
          MATCH     PTMAS021,Z70
          IF        !@EQUAL
            MOVE      PTMAS021,PTYPE
          ENDIF
.
          MATCH     PTMAS022,Z70
          IF        !@EQUAL
            MOVE      PTMAS022,POCCUP
          ENDIF
.
          MATCH     PTMAS023,Z70
          IF        !@EQUAL
            MOVE      PTMAS023,PMEDI
          ENDIF
.
          MATCH     PTMAS024,Z70
          IF        !@EQUAL
            MOVE      PTMAS024,PPENNO
          ENDIF
.
          MATCH     PTMAS025,Z70
          IF        !@EQUAL
            MOVE      PTMAS025,PPNDTE
          ENDIF
.
          MATCH     PTMAS026,Z70
          IF        !@EQUAL
            MOVE      PTMAS026,PREPAT
          ENDIF
.
          COMPARE   PTMAS027,ZERO
          IF        !@EQUAL
            MOVE      PTMAS027,PSMOK
          ENDIF
.
          MATCH     PTMAS028,Z70
          IF        !@EQUAL
            MOVE      PTMAS028,PMICRO
          ENDIF
.
          MATCH     PTMAS029,Z70
          IF        !@EQUAL
            MOVE      PTMAS029,PCEASE
          ENDIF
.
          COMPARE   PTMAS030,ZERO
          IF        !@EQUAL
            MOVE      PTMAS030,PCASE
          ENDIF
.
          COMPARE   PTMAS031,ZERO
          IF        !@EQUAL
            MOVE      PTMAS031,PAUTOPY
          ELSE
            MOVE      ZERO,PAUTOPY
          ENDIF
.
          MATCH     PTMAS032,Z70
          IF        !@EQUAL
            MOVE      PTMAS032,PHIGH1
          ENDIF
.
          MATCH     PTMAS033,Z70
          IF        !@EQUAL
            MOVE      PTMAS033,PHIGH2
          ENDIF
.
          MATCH     PTMAS034,Z70
          IF        !@EQUAL
            MOVE      PTMAS034,PHIGH3
          ENDIF
.
          MATCH     PTMAS035,Z70
          IF        !@EQUAL
            MOVE      PTMAS035,PLOCDOC
          ENDIF
.
          MATCH     PTMAS036,Z70
          IF        !@EQUAL
            MOVE      PTMAS036,PFUNDH
          ENDIF
.
          MATCH     PTMIS013,Z70
          IF        !@EQUAL
            IF        CFEETYP<>5
              MATCH     "1",UPDHFUND
              GOTO      UPDMAS10 IF EQUAL    * Not to Update PMI HF
              CALL      EDWH0000             * EDWARD Health Fund trigger
              MOVE      PTMIS013,PFUNDH
            ENDIF
            PACK      PFUNDH,PFUNDH,SP70
          ENDIF
.
UPDMAS10  MATCH     PTMAS037,Z70
          IF        !@EQUAL
            MOVE      PTMAS037,PFNDTB
          ENDIF
.
          MATCH     PTMIS014,Z70
          IF        !@EQUAL
            MATCH     "1",UPDHFUND
            GOTO      UPDMAS20 IF EQUAL    * Not to Update PMI HF
            MOVE      PTMIS014,PFNDTB
            PACK      PFNDTB,PFNDTB,SP70
          ENDIF
.
UPDMAS20  MATCH     PTMAS038,Z70
          IF        !@EQUAL
            MOVE      PTMAS038,PFNDMM
          ENDIF
.
          MATCH     PTMIS015,Z70
          IF        !@EQUAL
            MATCH     "1",UPDHFUND
            GOTO      UPDMAS30 IF EQUAL
            MOVE      PTMIS015,PFNDMM
          ENDIF
.
UPDMAS30  MATCH     PTMAS039,Z70
          IF        !@EQUAL
            MOVE      PTMAS039,PUSR1
          ENDIF
.
          MATCH     PTMAS040,Z70
          IF        !@EQUAL
            MOVE      PTMAS040,PUSR2
          ENDIF
.
          MATCH     PTMAS041,Z70
          IF        !@EQUAL
            MOVE      PTMAS041,PUSR3
          ENDIF
.
          MATCH     PTMAS042,Z70
          IF        !@EQUAL
            MOVE      PTMAS042,PUSR4
          ENDIF
.
          MATCH     PTMAS043,Z70
          IF        !@EQUAL
            MOVE      PTMAS043,PUSR5
          ENDIF
.
          MATCH     PTMAS044,Z70
          IF        !@EQUAL
            MOVE      PTMAS044,PUSR6
          ENDIF
.
          MATCH     PTMAS045,Z70
          IF        !@EQUAL
            MOVE      PTMAS045,PUYN1
          ENDIF
.
          MATCH     PTMAS046,Z70
          IF        !@EQUAL
            MOVE      PTMAS046,PUYN2
          ENDIF
.
          MATCH     PTMAS047,Z70
          IF        !@EQUAL
            MOVE      PTMAS047,PUYN3
          ENDIF
.
          MATCH     PTMAS048,Z70
          IF        !@EQUAL
            MOVE      PTMAS048,PYRRES
          ENDIF
.
          MATCH     PTMAS049,Z70
          IF        !@EQUAL
            MOVE      PTMAS049,PNKNAME
          ENDIF
.
          MATCH     PTMAS050,Z70
          IF        !@EQUAL
            MOVE      PTMAS050,PNKADD1
          ENDIF
.
          MATCH     PTMAS051,Z70
          IF        !@EQUAL
            MOVE      PTMAS051,PNKADD2
          ENDIF
.
          MATCH     PTMAS052,Z70
          IF        !@EQUAL
            MOVE      PTMAS052,PNKSUBR
          ENDIF
.
          MATCH     PTMAS053,Z70
          IF        !@EQUAL
            MOVE      PTMAS053,PNKADD4
          ENDIF
.
          MATCH     PTMAS054,Z70
          IF        !@EQUAL
            MOVE      PTMAS054,PNKPOST
          ENDIF
.
          MATCH     PTMAS055,Z70
          IF        !@EQUAL
            MOVE      PTMAS055,PNKTELP
          ENDIF
.
          MATCH     PTMAS056,Z70
          IF        !@EQUAL
            MOVE      PTMAS056,PNKTELB
          ENDIF
.
          MATCH     PTMAS057,Z70
          IF        !@EQUAL
            MOVE      PTMAS057,PNKRELP
          ENDIF
.
          COMPARE   PTMAS058,ZERO
          IF        !@EQUAL
            MOVE      PTMAS058,PNXRAY
          ENDIF
.
          MATCH     PTMAS059,Z70
          IF        !@EQUAL
            MOVE      PTMAS059,PFNDYY
          ENDIF
.
          MATCH     PTMAS060,Z70
          IF        !@EQUAL
            MOVE      PTMAS060,PFNDCG
          ENDIF
.
          MATCH     PTMAS061,Z70
          IF        !@EQUAL
            MOVE      PTMAS061,PDECDTE
            MATCH     SP70,PTMAS061
            IF        !@EQUAL
              MOVE      ONE,PCEASE
            ENDIF
          ENDIF
.
          MATCH     PTMAS062,Z70
          IF        !@EQUAL
            MOVE      PTMAS062,PDIET
          ENDIF
.
          MATCH     PTMAS063,Z70
          IF        !@EQUAL
            MOVE      PTMAS063,PINITHOS
          ENDIF
.
          MATCH     PTMAS064,Z70
          IF        !@EQUAL
            MOVE      PTMAS064,PTMAEMPC
          ENDIF
.
          MATCH     PTMAS065,Z70
          IF        !@EQUAL
            MOVE      PTMAS065,PTMANOKO
          ENDIF
.
          MATCH     PTMAS066,Z70
          IF        !@EQUAL
            MOVE      PTMAS066,PTMANOKE
          ENDIF
.
          MATCH     PTMAS067,ANSY
          IF        @EQUAL
            MOVE     ANSY,PTMAUKDD
            MOVE     ONE,PCEASE
          ELSE
            MOVE     ANSN,PTMAUKDD
          ENDIF
.
          CALL      UPMSX000                * Update Master File Extension
.
          MATCH     Z70,PTMAS068
          IF        !@EQUAL
            READ      CONTROLF,EIGHTY8;*237,PTCNEMPL
            MOVE      SP10,ACODE
            MOVE      ZERO,FORM1
            UNPACK    SP2,DIM1,DIM1A
            UNPACK    PTCNEMPL,DIM1,DIM1A
            MOVE      DIM1A,FORM1
            MATCH     ANSU,DIM1
            IF        @EQUAL
              STORE     PTMAS068,FORM1,AUSR1,AUSR2,AUSR3,AUSR4,AUSR5,AUSR6,AUSR7
            ENDIF
.
            MATCH     ANSP,DIM1
            IF        @EQUAL
              STORE     PTMAS068,FORM1,PUSR1,PUSR2,PUSR3,PUSR4,PUSR5,PUSR6
            ENDIF
          ENDIF
.
UPDMAS3   MATCH     Z70,PTMAS069
          IF        !@EQUAL
            MATCH     PTMAS069,PTMADCDT
            IF        !@EQUAL
              PACK      PTMADCUD,CCC,CYY,CMM,CDD * Set demographics confirmed
              REP       " 0",PTMADCUD            * updated by date,time and user
              CLOCK     TIME,PTMADCUT
              MOVE      USERID,PTMADCUU
            ENDIF
.
            MATCH     "1",CONFDEMO
            IF        @EQUAL
              PACK      KEY8,CCC,CYY,CMM,CDD
              REP       " 0",KEY8
              MATCH     KEY8,PTMAS069              * Today
              IF        @EQUAL
                PACK      PTMADCUD,CCC,CYY,CMM,CDD * Set demographics confirmed
                REP       " 0",PTMADCUD            * updated by date,time user
                CLOCK     TIME,PTMADCUT
                MOVE      USERID,PTMADCUU
              ENDIF
            ENDIF
.
            MOVE      PTMAS069,PTMADCDT
          ENDIF
.
          CLOCK     TIME,PTMAUTIM
          MOVE      USERID,PTMAUUID
.
          MATCH     PTMAS070,Z70                  * Additional HCP 1
          IF        !@EQUAL
            MOVE      PTMAS070,PTMAHCP1
          ENDIF
.
          MATCH     PTMAS071,Z70                  * Additional Practice 1
          IF        !@EQUAL
            MOVE      PTMAS071,PTMAHCL1
          ENDIF
.
          MATCH     PTMAS072,Z70                  * Additional Grp Count 1
          IF        !@EQUAL
            MOVE      PTMAS072,PTMAHCG1
          ENDIF
.
          MATCH     PTMAS073,Z70                  * Additional HCP 2
          IF        !@EQUAL
            MOVE      PTMAS073,PTMAHCP2
          ENDIF
.
          MATCH     PTMAS074,Z70                  * Additional Practice 2
          IF        !@EQUAL
            MOVE      PTMAS074,PTMAHCL2
          ENDIF
.
          MATCH     PTMAS075,Z70                  * Additional Grp Count 2
          IF        !@EQUAL
            MOVE      PTMAS075,PTMAHCG2
          ENDIF
.
          MATCH     PTMAS076,Z70                  * Additional HCP 3
          IF        !@EQUAL
            MOVE      PTMAS076,PTMAHCP3
          ENDIF
.
          MATCH     PTMAS077,Z70                  * Additional Practice 3
          IF        !@EQUAL
            MOVE      PTMAS077,PTMAHCL3
          ENDIF
.
          MATCH     PTMAS078,Z70                  * Additional Grp Count 3
          IF        !@EQUAL
            MOVE      PTMAS078,PTMAHCG3
          ENDIF
.
          MATCH     PTMAS079,Z70                  * Additional HCP 4
          IF        !@EQUAL
            MOVE      PTMAS079,PTMAHCP4
          ENDIF
.
          MATCH     PTMAS080,Z70                  * Additional Practice 4
          IF        !@EQUAL
            MOVE      PTMAS080,PTMAHCL4
          ENDIF
.
          MATCH     PTMAS081,Z70                  * Additional Grp Count 4
          IF        !@EQUAL
            MOVE      PTMAS081,PTMAHCG4
          ENDIF
.
          MATCH     PTMAS082,Z70                  * Additional HCP 5
          IF        !@EQUAL
            MOVE      PTMAS082,PTMAHCP5
          ENDIF
.
          MATCH     PTMAS083,Z70                  * Additional Practice 5
          IF        !@EQUAL
            MOVE      PTMAS083,PTMAHCL5
          ENDIF
.
          MATCH     PTMAS084,Z70                  * Additional Grp Count 5
          IF        !@EQUAL
            MOVE      PTMAS084,PTMAHCG5
          ENDIF
.
          MATCH     PTMAS085,Z70                  * Death Certificate number
          IF        !@EQUAL
            MOVE      PTMAS085,PTMADCNO
          ENDIF
.
UPDMAS99  RETURN
+
.------------------------------------------------------------
. UPMSX000  Update master file extension vars
.------------------------------------------------------------
.
UPMSX000  MATCH     Z70,PTMSX001
          IF        !@EQUAL
            MOVE      PTMSX001,PTMXRDAT
          ENDIF
.
          MATCH     Z70,PTMSX002
          IF        !@EQUAL
            MOVE      PTMSX002,PTMXMEAL
          ENDIF
.
          MATCH     Z70,PTMSX003
          IF        !@EQUAL
            MOVE      PTMSX003,PTMXLGA
          ENDIF
.
          MATCH     Z70,PTMSX004
          IF        !@EQUAL
            MOVE      PTMSX004,PTMXLS
          ENDIF
.
          MATCH     Z70,PTMSX005
          IF        !@EQUAL
            MOVE      PTMSX005,PTMXLSDT
          ENDIF
.
          MATCH     Z70,PTMSX006
          IF        !@EQUAL
            MOVE      PTMSX006,PTMXFHMD
          ENDIF
.
          MATCH     Z70,PTMSX007
          IF        !@EQUAL
            MOVE      PTMSX007,PTMXMHU1
          ENDIF
.
          MATCH     Z70,PTMSX008
          IF        !@EQUAL
            MOVE      PTMSX008,PTMXMHU2
          ENDIF
.
          MATCH     Z70,PTMSX009
          IF        !@EQUAL
            MOVE      PTMSX009,PTMXMHU3
          ENDIF
.
          MATCH     Z70,PTMSX010
          IF        !@EQUAL
            MOVE      PTMSX010,PTMXECNM
          ENDIF
.
          MATCH     Z70,PTMSX011
          IF        !@EQUAL
            MOVE      PTMSX011,PTMXECA1
          ENDIF
.
          MATCH     Z70,PTMSX012
          IF        !@EQUAL
            MOVE      PTMSX012,PTMXECA2
          ENDIF
.
          MATCH     Z70,PTMSX013
          IF        !@EQUAL
            MOVE      PTMSX013,PTMXECA3
          ENDIF
.
          MATCH     Z70,PTMSX014
          IF        !@EQUAL
            MOVE      PTMSX014,PTMXECA4
          ENDIF
.
          MATCH     Z70,PTMSX015
          IF        !@EQUAL
            MOVE      PTMSX015,PTMXECPC
          ENDIF
.
          MATCH     Z70,PTMSX016
          IF        !@EQUAL
            MOVE      PTMSX016,PTMXECPP
          ENDIF
.
          MATCH     Z70,PTMSX017
          IF        !@EQUAL
            MOVE      PTMSX017,PTMXECBP
          ENDIF
.
          MATCH     Z70,PTMSX018
          IF        !@EQUAL
            MOVE      PTMSX018,PTMXECRE
          ENDIF
.
          MATCH     Z70,PTMSX019
          IF        !@EQUAL
            MOVE      PTMSX019,PTMXNRNM
          ENDIF
.
          MATCH     Z70,PTMSX020
          IF        !@EQUAL
            MOVE      PTMSX020,PTMXNRA1
          ENDIF
.
          MATCH     Z70,PTMSX021
          IF        !@EQUAL
            MOVE      PTMSX021,PTMXNRA2
          ENDIF
.
          MATCH     Z70,PTMSX022
          IF        !@EQUAL
            MOVE      PTMSX022,PTMXNRA3
          ENDIF
.
          MATCH     Z70,PTMSX023
          IF        !@EQUAL
            MOVE      PTMSX023,PTMXNRA4
          ENDIF
.
          MATCH     Z70,PTMSX024
          IF        !@EQUAL
            MOVE      PTMSX024,PTMXNRPC
          ENDIF
.
          MATCH     Z70,PTMSX025
          IF        !@EQUAL
            MOVE      PTMSX025,PTMXNRPP
          ENDIF
.
          MATCH     Z70,PTMSX026
          IF        !@EQUAL
            MOVE      PTMSX026,PTMXNRBP
          ENDIF
.
          MATCH     Z70,PTMSX027
          IF        !@EQUAL
            MOVE      PTMSX027,PTMXNRRE
          ENDIF
.
          MATCH     Z70,PTMSX028
          IF        !@EQUAL
            MOVE      PTMSX028,PTMX3BEX
          ENDIF
.
          MATCH     Z70,PTMSX029
          IF        !@EQUAL
            MOVE      PTMSX029,PTMXCARD
          ENDIF
.
          MATCH     Z70,PTMSX030
          IF        !@EQUAL
            MOVE      PTMSX030,PTMXCEXP
          ENDIF
.
          MATCH     Z70,PTMSX031
          IF        !@EQUAL
            MOVE      PTMSX031,PTMXCXMP
          ENDIF
.
          MATCH     Z70,PTMSX032
          IF        !@EQUAL
            MOVE      PTMSX032,PTMXFMLY
          ENDIF
.
          MATCH     Z70,PTMSX033
          IF        !@EQUAL
            MOVE      PTMSX033,PTMXDOFR
          ENDIF
.
          MATCH     Z70,PTMSX034
          IF        !@EQUAL
            MOVE      PTMSX034,PTMXREGP
          ENDIF
.
          MATCH     Z70,PTMSX035
          IF        !@EQUAL
            MOVE      PTMSX035,PTMXGPPC
          ENDIF
.
          MATCH     Z70,PTMSX036
          IF        !@EQUAL
            MOVE      PTMSX036,PTMXSPID
          ENDIF
.
          MATCH     Z70,PTMSX037
          IF        !@EQUAL
            MOVE      PTMSX037,PTMXGPPT
          ENDIF
.
          MATCH     Z70,PTMSX038
          IF        !@EQUAL
            MOVE      PTMSX038,PTMXUKDO
          ENDIF
.
          MATCH     Z70,PTMSX039
          IF        !@EQUAL
            MOVE      PTMSX039,PTMXCELL
          ENDIF
.
          MATCH     Z70,PTMSX040
          IF        !@EQUAL
            MOVE      PTMSX040,PTMXADD1
          ENDIF
.
          MATCH     Z70,PTMSX041
          IF        !@EQUAL
            MOVE      PTMSX041,PTMXADD2
          ENDIF
.
          MATCH     Z70,PTMSX042
          IF        !@EQUAL
            MOVE      PTMSX042,PTMXADD3
          ENDIF
.
          MATCH     Z70,PTMSX043
          IF        !@EQUAL
            MOVE      PTMSX043,PTMXADD4
          ENDIF
.
          MATCH     Z70,PTMSX044
          IF        !@EQUAL
            MOVE      PTMSX044,PTMXPOST
          ENDIF
.
          MATCH     Z70,PTMSX045
          IF        !@EQUAL
            MOVE      PTMSX045,PTMXMCCD
          ENDIF
.
          MATCH     Z70,PTMSX047
          IF        !@EQUAL
            MOVE      PTMSX047,PTMXDEAF
          ENDIF
.
          MATCH     Z70,PTMSX048
          IF        !@EQUAL
            MOVE      PTMSX048,PTMXSLAC
          ENDIF
.
          MATCH     Z70,PTMSX049
          IF        !@EQUAL
            MOVE      PTMSX049,PTMXDEAF
          ENDIF
.
          MATCH     Z70,PTMSX050
          IF        !@EQUAL
            MOVE      PTMSX050,PTMXOSMS
          ENDIF
.
          MATCH     Z70,PTMSX051
          IF        !@EQUAL
            MOVE      PTMSX051,PTMXESPF
          ENDIF
.
          MATCH     Z70,PTMSX046
          IF        !@EQUAL
            MOVE      PTMSX046,PTMXSPAR
          ENDIF
.
UPMSX999  RETURN
+
.------------------------------------------------------------
. UPDMIS00 - Update admission file details
.------------------------------------------------------------
.
UPDMIS00  MOVE      ZERO,CHGDOCTR
          MOVE      ZERO,CHGATYPE
          MOVE      ZERO,CHGDEPT
          MOVE      ZERO,CHGCCLSS
          MOVE      ZERO,CHGTEAM
          MOVE      ZERO,CHGRSTR
          MOVE      ZERO,CHGRESI
          MOVE      ZERO,EDWDBABY
.
          MATCH     PTMIS001,Z70
          IF        !@EQUAL
            MOVE      ADATE,OLDADATE             * save date for diet info
            MOVE      PTMIS001,ADATE
            REP       " 0",ADATE
            MOVE      ADATE,ALACDTE
          ENDIF
.
          MATCH     PTMIS002,Z70
          IF        !@EQUAL
            MOVE      PTMIS002,ATIME
          ENDIF
.
          MATCH     PTMIS003,Z70
          IF        !@EQUAL
            MOVE      PTMIS003,ACANCEL
          ENDIF
.
          MATCH     PTMIS004,Z70
          IF        !@EQUAL
            MOVE      PTMIS004,AWARD
          ENDIF
.
          MATCH     PTMIS005,Z70
          IF        !@EQUAL
            MOVE      PTMIS005,ABED
          ENDIF
.
          MATCH     PTMIS006,Z70
          IF        !@EQUAL
            MOVE      PTMIS006,ADOCTR
          ENDIF
.
          MATCH     PTMIS007,Z70
          IF        !@EQUAL
            MATCH     PTMIS007,ADOCTA
            IF        !@EQUAL
              MOVE      ONE,CHGDOCTR
              MOVE      PTMIS007,TADOCT
            ENDIF
            MOVE      PTMIS007,ADOCTA
          ENDIF
.
          MATCH     PTMIS008,Z70
          IF        !@EQUAL
            MOVE      PTMIS008,ADOCTL
          ENDIF
.
          MATCH     PTMIS009,Z70
          IF        !@EQUAL
            MOVE      PTMIS009,ASRCE
          ENDIF
.
          MATCH     PTMIS010,Z70
          IF        !@EQUAL
            MATCH     PTMIS010,ATYPE
            IF        !@EQUAL
              MOVE      ATYPE,OTYPE
              MOVE      PTMIS010,TATYPE
              MOVE      ONE,CHGATYPE
            ENDIF
            PACK      ATYPE,PTMIS010,SP70
          ENDIF
.
          MATCH     PTMIS011,Z70
          IF        !@EQUAL
            MOVE      PTMIS011,ACLSS
          ENDIF
.
          MATCH     PTMIS012,Z70
          IF        !@EQUAL
            MATCH     PTMIS012,ACARE
            IF        !@EQUAL
              MOVE      ACARE,CHCODE          * Move the old care class
              MOVE      ACARE,SAVCARE
              MOVE      ONE,CHGCCLSS
            ENDIF
            MOVE      PTMIS012,ACARE
          ENDIF
.
          MATCH     PTMIS013,Z70
          IF        !@EQUAL
            MOVE      AFUNDH,OFUNDH                   * (HPSA01I)
            MOVE      PTMIS013,AFUNDH
            PACK      AFUNDH,AFUNDH,SP70
            PACK      PFUNDH,PFUNDH,SP70
.
.           don't update pmi hf if nzprivate
.
            IF        CFEETYP<>5
              MATCH     "1",PTCNPMHF           * Update PMI HF ?
              IF        @EQUAL
                MATCH     "1",UPDHFUND
                GOTO      UPDMIS10 IF EQUAL    * Not to Update PMI HF
              ENDIF
              CALL      EDWH0000             * EDWARD Health Fund trigger
              MOVE      AFUNDH,PFUNDH
              PACK      PFUNDH,PFUNDH,SP70
            ENDIF
          ENDIF
.
UPDMIS10  MATCH     PTMIS014,Z70
          IF        !@EQUAL
            MOVE      AFNDTB,OFNDTB                   * (HPSA01I)
            MOVE      PTMIS014,AFNDTB
            PACK      AFNDTB,AFNDTB,SP70
.
            MATCH     "1",PTCNPMHF           * Option to Update PMI HF ?
            IF        @EQUAL
              MATCH     "1",UPDHFUND
              GOTO      UPDMIS20 IF EQUAL    * Not to Update PMI HF
            ENDIF
            MOVE      AFNDTB,PFNDTB
            PACK      PFNDTB,PFNDTB,SP70
            PACK      PTMAS037,PFNDTB,SP70
          ENDIF
.
UPDMIS20  MATCH     PTMIS015,Z70
          IF        !@EQUAL
            MOVE      PTMIS015,AFNDMM
            MOVE      PTMIS015,PMVXFNDM
.
            MATCH     "1",PTCNPMHF           * Option to Update PMI HF ?
            IF        @EQUAL
              MATCH     "1",UPDHFUND
              GOTO      UPDMIS30 IF EQUAL    * Not to Update PMI HF
            ENDIF
.
            MOVE      PMVXFNDM,PFNDMM
            PACK      PTMAS038,PFNDMM,SP70
          ENDIF
.
UPDMIS30  MATCH     PTMIS016,Z70
          IF        !@EQUAL
            MOVE      PTMIS016,AELIG
          ENDIF
.
          COMPARE   PTMIS017,ZERO
          IF        !@EQUAL
            MOVE      PTMIS017,AVISIT
          ELSE
            MOVE      TWO,AVISIT
          ENDIF
.
          COMPARE   PTMIS018,ZERO
          IF        !@EQUAL
            MOVE      PTMIS018,AALERG
          ENDIF
.
          COMPARE   PTMIS019,ZERO
          IF        !@EQUAL
            MOVE      PTMIS019,AILLN
          ENDIF
.
          MATCH     PTMIS020,Z70
          IF        !@EQUAL
            MOVE      PTMIS020,ADIAG1
            REP       "' ",ADIAG1
          ENDIF
.
          MATCH     PTMIS021,Z70
          IF        !@EQUAL
            MOVE      PTMIS021,ADIAG2
            REP       "' ",ADIAG2
          ENDIF
.
          COMPARE   PTMIS022,ZERO
          IF        !@EQUAL
            MOVE      PTMIS022,ADISC
          ENDIF
.
          MATCH     PTMIS023,Z70
          IF        !@EQUAL
            MOVE      PTMIS023,ADOCTT
          ENDIF
.
          MATCH     PTMIS024,Z70
          IF        !@EQUAL
            MATCH     PTMIS024,ACLSSFT
            IF        !@EQUAL
              MOVE      PTMIS024,TDEPT
              MOVE      ONE,CHGDEPT
            ENDIF
            MOVE      PTMIS024,ACLSSFT
          ENDIF
.
          MATCH     PTMIS025,Z70
          IF        !@EQUAL
            MOVE      PTMIS025,AALLOW
          ENDIF
.
          MATCH     PTMIS026,Z70
          IF        !@EQUAL
            MOVE      PTMIS026,AMBS
          ENDIF
.
          MATCH     PTMIS027,Z70
          IF        !@EQUAL
            MOVE      ACLAIM,OCLAIM                   * (REVO1)
            MOVE      PTMIS027,ACLAIM
          ENDIF
.
          MATCH     PTMIS028,Z70
          IF        !@EQUAL
            MOVE      PTMIS028,ADIET
            MOVE      PTMIS028,PDIET
          ENDIF
.
          MATCH     PTMIS029,Z70
          IF        !@EQUAL
            MOVE      PTMIS029,APLOCCR
          ENDIF
.
          MATCH     PTMIS030,Z70
          IF        !@EQUAL
            MOVE      PTMIS030,ASTAY
          ENDIF
.
          MATCH     PTMIS031,Z70
          IF        !@EQUAL
            MOVE      PTMIS031,ADYHOSP
          ENDIF
.
          COMPARE   PTMIS032,ZERO
          IF        !@EQUAL
            MOVE      PTMIS032,AMEMB
          ENDIF
.
          COMPARE   PTMIS033,ZERO
          IF        !@EQUAL
            MOVE      PTMIS033,AMEMBNO
          ENDIF
.
          MATCH     PTMIS034,Z70
          IF        !@EQUAL
            MOVE      PTMIS034,ACOMM1
          ENDIF
.
          MATCH     PTMIS035,Z70
          IF        !@EQUAL
            MOVE      PTMIS035,ACOMM2
          ENDIF
.
          MATCH     PTMIS036,Z70
          IF        !@EQUAL
            MOVE      APLUR,F1
            MOVE      PTMIS036,APLUR
.
            IF        APLUR<>F1
              MOVE      ONE,EDWDBABY
            ENDIF     
          ENDIF
.
          MATCH     PTMIS037,Z70
          IF        !@EQUAL
            MOVE      PTMIS037,AUSR1
          ENDIF
.
          MATCH     PTMIS038,Z70
          IF        !@EQUAL
            MOVE      PTMIS038,AUSR2
          ENDIF
.
          MATCH     PTMIS039,Z70
          IF        !@EQUAL
            MOVE      PTMIS039,AUSR3
          ENDIF
.
          MATCH     PTMIS040,Z70
          IF        !@EQUAL
            MOVE      PTMIS040,AUSR4
          ENDIF
.
          MATCH     PTMIS041,Z70
          IF        !@EQUAL
            MOVE      PTMIS041,AUSR5
          ENDIF
.
          MATCH     PTMIS042,Z70
          IF        !@EQUAL
            MOVE      AUSR6,D3
            MOVE      PTMIS042,AUSR6
.
            MATCH     AUSR6,D3
            IF        !@EQUAL
              MOVE      ONE,EDWDBABY
            ENDIF
          ENDIF
.
          MATCH     PTMIS043,Z70
          IF        !@EQUAL
            MOVE      PTMIS043,AUSR7
          ENDIF
.
          MATCH     PTMIS044,Z70
          IF        !@EQUAL
            MOVE      PTMIS044,ARDRNAM
          ENDIF
.
          MATCH     PTMIS045,Z70
          IF        !@EQUAL
            MOVE      PTMIS045,AFNDYY
          ENDIF
.
          MATCH     PTMIS046,Z70
          IF        !@EQUAL
            MOVE      PTMIS046,AFNDCG
          ENDIF
.
          MATCH     PTMIS047,Z70
          IF        !@EQUAL
            MOVE      PTMIS047,AOCCDTE
          ENDIF
.
          MATCH     PTMIS048,Z70
          IF        !@EQUAL
            MOVE      PTMIS048,ACODDTE
          ENDIF
.
          MATCH     PTMIS049,Z70
          IF        !@EQUAL
            MOVE      PTMIS049,ARETDTE
          ENDIF
.
          MATCH     PTMIS050,Z70
          IF        !@EQUAL
            MATCH     ZEROVISN,PTMIS050
            IF        !@EQUAL
              MOVE      PTMIS050,AMUMADM
            ENDIF
          ENDIF
.
.                                                                     *C-214541
          MATCH     PTMIS051,Z70            * ensure Baby Weight right aligned
          IF        !@EQUAL
            MOVE      ABWGHT,D6
.
            SQUEEZE   PTMIS051
            IF        @EOS
              MOVE      SP6,ABWGHT          * PTMIS051 is blank
            ELSE
              MOVE      ZERO,FORM6
              MOVE      PTMIS051,FORM6
              MOVE      FORM6,ABWGHT
            ENDIF
.
            MATCH     ABWGHT,D6
            IF        !@EQUAL
              MOVE      ONE,EDWDBABY
            ENDIF
          ENDIF                                                 * end *C-214541
.
          MATCH     PTMIS052,Z70
          IF        !@EQUAL
            MOVE      PTMIS052,PTMSRFGP
          ENDIF
.
          MATCH     PTMIS053,Z70
          IF        !@EQUAL
            MOVE      PTMIS053,PTMSGPPC
          ENDIF
.
          MATCH     PTMIS054,Z70
          IF        !@EQUAL
            MOVE      PTMIS054,PTMSFHAN
          ENDIF
.
          MATCH     PTMIS055,Z70
          IF        !@EQUAL
            MOVE      PTMIS055,PTMSECRA
          ENDIF
.
          MATCH     PTMIS056,Z70
          IF        !@EQUAL
            MOVE      PTMIS056,PTMSMGIN
          ENDIF
.
          MATCH     PTMIS057,Z70
          IF        !@EQUAL
            MOVE      PTMIS057,PTMIDOFR
          ENDIF
.
          MATCH     PTMIS058,Z70
          IF        !@EQUAL
            MOVE      PTMIS058,PTMIREFD
          ENDIF
.
          MATCH     PTMIS059,Z70
          IF        !@EQUAL
            MOVE      PTMIS059,PTMIDFCN
          ENDIF
.
          MATCH     PTMIS060,Z70
          IF        !@EQUAL
            MOVE      PTMIS060,PTMIPHPU
          ENDIF
.
          MATCH     PTMIS061,Z70
          IF        !@EQUAL
            MOVE      PTMIS061,PTMIAGNC
          ENDIF
.
          MATCH     PTMIS062,Z70
          IF        !@EQUAL
            MOVE      PTMIS062,PTMIESSF
          ENDIF
.
          MATCH     PTMIS063,Z70
          IF        !@EQUAL
            MOVE      PTMIS063,PTMIUSR8
          ENDIF
.
          MATCH     PTMIS064,Z70
          IF        !@EQUAL
            MOVE      PTMIS064,PTMIUSR9
          ENDIF
.
          MATCH     PTMIS065,Z70
          IF        !@EQUAL
            MOVE      PTMIS065,PTMIUSR0
          ENDIF
.
          MATCH     PTMIS066,Z70
          IF        !@EQUAL
            MOVE      PTMIS066,PTMIPDRG
          ENDIF
.
          MATCH     PTMIS067,Z70
          IF        !@EQUAL
            MOVE      PTMIS067,PTMIOPER
          ENDIF
.
          MATCH     PTMIS068,Z70
          IF        !@EQUAL
            MOVE      PTMIS068,PTMIXWRD
          ENDIF
.
          MATCH     PTMIS069,Z70
          IF        !@EQUAL
            MOVE      PTMIS069,PTMIADOC
          ENDIF
.
          MATCH     PTMIS070,Z70
          IF        !@EQUAL
            MOVE      PTMIS070,PTMIREGS
          ENDIF
.
          MATCH     PTMIS071,Z70
          IF        !@EQUAL
            MOVE      PTMIS071,PTMIUYN1
          ENDIF
.
          MATCH     PTMIS072,Z70
          IF        !@EQUAL
            MOVE      PTMIS072,PTMIUYN2
          ENDIF
.
          MATCH     PTMIS073,Z70
          IF        !@EQUAL
            MOVE      PTMIS073,PTMIPCMX
          ENDIF
.
          MATCH     PTMIS074,Z70
          IF        !@EQUAL
            MOVE      PTMIS074,PTMIGSTA
          ENDIF
.
          MATCH     PTMIS075,Z70
          IF        !@EQUAL
            MOVE      PTMIS075,PTMICMXP
            MATCH     "1",PTMIS075
            IF        @EQUAL
              MOVE      "Y",PTMICMXP
            ELSE
              REP       " 0",PTMIS075
              MATCH     "0",PTMIS075
              IF        @EQUAL
                MOVE      "N",PTMICMXP
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     Z70,PTMIS077
          IF        !@EQUAL
            READ      CONTROLF,SEVENTY9;*81,PTCNGEST
            STORE     PTMIS077,PTCNGEST,AUSR1,AUSR2,AUSR3,AUSR4,AUSR5,AUSR6:
                                  AUSR7,PTMIUSR8,PTMIUSR9
            IF        PTCNGEST = 0
              MOVE      PTMIS077,PTMIUSR0
            ENDIF
          ENDIF
.
          MATCH     PTMIS076,Z70
          IF        !@EQUAL
            MOVE      PTMIS076,PTMIEBED
          ENDIF
.
          MATCH     PTMIS078,Z70
          IF        !@EQUAL
            MOVE      PTMIS078,PTMIDFAS
          ENDIF
.
          MATCH     PTMIS079,Z70
          IF        !@EQUAL
            MOVE      PTMIS079,PTMICRCD
          ENDIF
.
          MATCH     PTMIS080,Z70
          IF        !@EQUAL
            MOVE      PTMIS080,PTMIFINV
          ENDIF
.
          MATCH     PTMIS081,Z70
          IF        !@EQUAL
            MOVE      PTMIS081,PTMICONB
          ENDIF
.
          MATCH     PTMIS082,Z70
          IF        !@EQUAL
            SQUEEZE   PTMIS082
            MOVE      ZERO,F4
            MOVE      PTMIS082,F4
            MOVE      F4,PTMI3BDY
          ENDIF
.
          MATCH     PTMIS083,Z70
          IF        !@EQUAL
            MOVE      PTMIS083,PTMI3BAD
          ENDIF
.
          MATCH     PTASF001,Z70
          IF        !@EQUAL
            PACK      PTAFCTYP,PTASF001,SP70
          ENDIF
.
          MATCH     PTASF002,Z70
          IF        !@EQUAL
            PACK      PTAFCROL,PTASF002,SP70
          ENDIF
.
          MATCH     PTASF003,Z70
          IF        !@EQUAL
            PACK      PTAFCSID,PTASF003,SP70
          ENDIF
.
UPDMIS99  RETURN
+
.----------------------------------------------------------------------
. TRNUPD00 - Update Transfer file if Record is changed in Patient Admn
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.-----------------------------------------------------------------------
.
TRNUPD00  PACK      KEY30,AADMNO,Z70
          CALL      RDSTRAN2             * position on the last transfer record
          CALL      RDPTRAN2
          BRANCH    OVRCD,TRNUPD91
.
          MATCH     AADMNO,TADMN
          GOTO      TRNUPD91 IF NOT EQUAL
.
          IF        CHGDOCTR=1
            MOVE      PTMIS007,TADOCT   * attending doctor changed
          ENDIF
.
          IF        CHGATYPE=1
            MOVE      PTMIS010,TATYPE   * admission type changed
          ENDIF
.
          IF        CHGDEPT=1
            MOVE      PTMIS024,TDEPT    * dept changed
          ENDIF
.
          IF        CHGTEAM=1
            MOVE      PTVIS124,PTTRTEAM * team changed
          ENDIF
.
          IF        CHGRSTR=1
            MOVE      PTVIS062,PTTRRSTR * registrar changed
          ENDIF
.
          IF        CHGRESI=1
            MOVE      PTVIS061,PTTRRESI * resident changed
          ENDIF
.
          PACK      TDATE,CCC,CYY,CMM,CDD
          REP       " 0",TDATE
          MOVE      CTIMEIS,TTIME
          MOVE      "C",TMOVE
          MOVE      AADMNO,TADMN
          PACK      KEY30,TADMN,TDATE,TTIME,TWARD,TBED
          CALL      RDATRAN2
          IF        OVRCD=1
            MOVE      ACLAIM,PTTRCLTY
            PACK      PTTRCDAT,CCC,CYY,CMM,CDD
            REP       " 0",PTTRCDAT
            CLOCK     TIME,PTTRCTIM
            MOVE      WBSEUID,PTTRUCID
            UNPACK    SP70,TRCDATE,TRCTIME,PTTRUUID
            CALL      WRTRAN2
          ENDIF
.
TRNUPD90  MOVE      ZERO,EXIT
          GOTO      TRNUPD99
.
TRNUPD91  MOVE      "Transfer file record missing",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      TRNUPD99
.
TRNUPD99  RETURN
+
.-----------------------------------------------------------
. CARUPD00 - Update Code change file
.-----------------------------------------------------------
.
CARUPD00  PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",CHDATE
          MOVE      CTIMEIS,KEY8A
          REP       " 0",CHTIME
.                                           * establish next Episode No.
CARUPD10  MOVE      ZERO,F2
          PACK      KEY24,AADMNO,Z70
          CALL      RDSCHCO1
          CALL      RDPCHCO1
.
          MATCH     AADMNO,CHADMN
          IF        !@EQUAL
            MOVE      ONE,F2
          ELSE
            MOVE      CHEPISNO,F2
            ADD       ONE,F2
          ENDIF
.
.                                           * create/update Episode record
CARUPD20  PACK      KEY24,AADMNO,KEY8,KEY8A,SP70
          CALL      RDCHCO1
          IF        OVRCD <> 1
            MOVE      "CC",CHCATG
            MOVE      SAVCARE,CHCODE
            MOVE      F2,CHEPISNO
            MOVE      SP10,CHCODCMP
            MOVE      WBSEPCD,CHUPUSID
            MOVE      KEY8,CHUPDATE
            MOVE      KEY8A,CHUPTIME
            CALL      UPCHCO1
          ELSE
            MOVE      AADMNO,CHADMN
            MOVE      KEY8,CHDATE
            MOVE      KEY8A,CHTIME
            MOVE      "CC",CHCATG
            MOVE      SAVCARE,CHCODE
            MOVE      F2,CHEPISNO
            MOVE      SP10,CHCODCMP
            MOVE      WBSEPCD,CHCRUSID
            MOVE      KEY8,CHUPDATE
            MOVE      CTIMEIS,CHCRTIME
            MOVE      SP70,CHUPDATE
            MOVE      SP70,CHUPTIME
            MOVE      SP70,CHUPUSID
            UNPACK    SP70,CHCODCMP,CHSPARE
            CALL      WRCHCO1
          ENDIF
.
CARUPD99  RETURN
+
.------------------------------------------------------------
. UPDVIS00 -  Update Visit Ext file details
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
.
UPDVIS00  PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMVX11                     * visit record found ?
          BRANCH    OVRCD,UPDVIS10               * no - clear variables
.
          GOTO      UPDVIS20                     * yes - locked
.
UPDVIS10  CALL      CLRVXS00
.
UPDVIS20  MOVE      PPOST,PMVXPOST
          MATCH     PTVIS015,Z70
          IF        !@EQUAL
            MOVE      PTVIS015,PMVXDOCA
          ENDIF
.
          MATCH     PTMIS015,Z70
          IF        !@EQUAL
            MOVE      PTMIS015,PMVXFNDM
          ENDIF
.
          MATCH     PTVIS016,Z70
          IF        !@EQUAL
            MOVE      PTVIS016,PMVXDOCT
          ENDIF
.
          MATCH     PTVIS017,Z70
          IF        !@EQUAL
            MOVE      PTVIS017,PMVXCSNR
          ENDIF
.
          MATCH     PTVIS018,Z70
          IF        !@EQUAL
            MOVE      PTVIS018,PMVXPOST
          ENDIF
.
          MATCH     PTVIS019,Z70
          IF        !@EQUAL
            MOVE      PTVIS019,PMVXPIND
          ENDIF
.
          MATCH     PTVIS020,Z70
          IF        !@EQUAL
            MOVE      PTVIS020,PMVXVLOC
          ENDIF
.
          MATCH     PTVIS021,Z70
          IF        !@EQUAL
            MOVE      PTVIS021,PMVXCFSG
          ENDIF
.
          MATCH     PTVIS022,Z70
          IF        !@EQUAL
            MOVE      PTVIS022,PMVXINGP
          ELSE
            MOVE      ZERO,PMVXINGP
          ENDIF
.
          MATCH     PTVIS023,Z70
          IF        !@EQUAL
            MOVE      PTVIS023,PMVXCPTH
          ENDIF
.
          MATCH     PTVIS024,Z70
          IF        !@EQUAL
            MOVE      PTVIS024,PMVXHCP1
          ENDIF
.
          MATCH     PTVIS025,Z70
          IF        !@EQUAL
            MOVE      PTVIS025,PMVXHCP2
          ENDIF
.
          MATCH     PTVIS026,Z70
          IF        !@EQUAL
            MOVE      PTVIS026,PMVXHCP3
          ENDIF
.
          MATCH     PTVIS027,Z70
          IF        !@EQUAL
            MOVE      PTVIS027,PMVXHCP4
          ENDIF
.
          MATCH     PTVIS028,Z70
          IF        !@EQUAL
            MOVE      PTVIS028,PMVXRHC1
          ENDIF
.
          MATCH     PTVIS029,Z70
          IF        !@EQUAL
            MOVE      PTVIS029,PMVXRH1G
          ENDIF
.
          MATCH     PTVIS030,Z70
          IF        !@EQUAL
            MOVE      PTVIS030,PMVXRH1C
          ENDIF
.
          MATCH     PTVIS031,Z70
          IF        !@EQUAL
            MOVE      PTVIS031,PMVXRHC2
          ENDIF
.
          MATCH     PTVIS032,Z70
          IF        !@EQUAL
            MOVE      PTVIS032,PMVXRH2G
          ENDIF
.
          MATCH     PTVIS033,Z70
          IF        !@EQUAL
            MOVE      PTVIS033,PMVXRH2C
          ENDIF
.
          MATCH     PTVIS034,Z70
          IF        !@EQUAL
            MOVE      PTVIS034,PMVXRHC3
          ENDIF
.
          MATCH     PTVIS035,Z70
          IF        !@EQUAL
            MOVE      PTVIS035,PMVXRH3G
          ENDIF
.
          MATCH     PTVIS036,Z70
          IF        !@EQUAL
            MOVE      PTVIS036,PMVXRH3C
          ENDIF
.
          MATCH     PTVIS037,Z70
          IF        !@EQUAL
            MOVE      PTVIS037,PMVXRHC4
          ENDIF
.
          MATCH     PTVIS038,Z70
          IF        !@EQUAL
            MOVE      PTVIS038,PMVXRH4G
          ENDIF
.
          MATCH     PTVIS039,Z70
          IF        !@EQUAL
            MOVE      PTVIS039,PMVXRH4C
          ENDIF
.
          MATCH     PTVIS040,Z70
          IF        !@EQUAL
            MOVE      PTVIS040,PMVXABRG
          ENDIF
.
          MATCH     PTVIS041,Z70
          IF        !@EQUAL
            MOVE      PTVIS041,PMVXCADM
          ENDIF
.
          MATCH     PTVIS042,Z70
          IF        !@EQUAL
            MOVE      PTVIS042,PMVXIRAD
          ENDIF
.
          MATCH     PTVIS043,Z70
          IF        !@EQUAL
            MOVE      PTVIS043,PMVXIDUS
          ENDIF
.
          MATCH     PTVIS044,Z70
          IF        !@EQUAL
            MOVE      PTVIS044,PMVXCRAV
          ENDIF
.
          MATCH     PTVIS045,Z70
          IF        !@EQUAL
            MOVE      PTVIS045,PMVXRCCT
          ENDIF
.
          MATCH     PTVIS046,Z70
          IF        !@EQUAL
            MOVE      PTVIS046,PMVXAPWD
          ENDIF
.
          MATCH     PTVIS047,Z70
          IF        !@EQUAL
            MOVE      PTVIS047,PMVXAPBD
          ENDIF
.
          MATCH     PTVIS048,Z70
          IF        !@EQUAL
            MOVE      PTVIS048,PMVXPOWD
            IF        PTCNDWAW=0
              MATCH     "1",STOPDWAW
              IF        !@EQUAL
                MOVE      PMVXPOWD,PTMIXWRD
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     PTVIS049,Z70
          IF        !@EQUAL
            MOVE      PTVIS049,PMVXPOBD
          ENDIF
.
          MATCH     PTVIS050,Z70
          IF        !@EQUAL
            MOVE      PTVIS050,PMVXPSTY
          ENDIF
.
          MATCH     PTVIS051,Z70
          IF        !@EQUAL
            MOVE      PTVIS051,PMVXVALW
          ENDIF
.
          MATCH     PTVIS052,Z70
          IF        !@EQUAL
            MOVE      PTVIS052,PMVXPALW
          ENDIF
.
          MATCH     PTVIS053,Z70
          IF        !@EQUAL
            MOVE      PTVIS053,PMVXINDC
          ENDIF
.
          MATCH     PTVIS054,Z70
          IF        !@EQUAL
            MOVE      PTVIS054,PMVXMDAV
          ENDIF
.
          MATCH     PTVIS055,Z70
          IF        !@EQUAL
            MOVE      PTVIS055,PMVXFRMS
          ENDIF
.
          MATCH     PTVIS056,Z70
          IF        !@EQUAL
            MOVE      PTVIS056,PMVXCSNG
          ENDIF
.
          MATCH     PTVIS057,Z70
          IF        !@EQUAL
            SQUEEZE   PTVIS057
            MOVE      ZERO,F6P2
            MOVE      PTVIS057,F6P2
            MULT      "100",F6P2
            MOVE      F6P2,PMVXPWGT
          ENDIF
.
          MATCH     PTVIS058,Z70
          IF        !@EQUAL
            SQUEEZE   PTVIS058
            MOVE      ZERO,PMVXPHGT
            MOVE      PTVIS058,PMVXPHGT
          ENDIF
.
          MATCH     PTVIS059,Z70
          IF        !@EQUAL
            MOVE      PTVIS059,PMVXDHWR
          ENDIF
.
          MATCH     PTVIS060,Z70
          IF        !@EQUAL
            MOVE      PTVIS060,PMVXEDC1
          ENDIF
.
          MATCH     PTVIS061,Z70
          IF        !@EQUAL
            MATCH     PTVIS061,PMVXEDC2
            IF        !@EQUAL
              MOVE      PTVIS061,PTTRRESI
              MOVE      ONE,CHGRESI
            ENDIF
            MOVE      PTVIS061,PMVXEDC2
          ENDIF
.
          MATCH     PTVIS062,Z70
          IF        !@EQUAL
            MATCH     PTVIS062,PMVXEDC3
            IF        !@EQUAL
              MOVE      PTVIS062,PTTRRSTR
              MOVE      ONE,CHGRSTR
            ENDIF
            MOVE      PTVIS062,PMVXEDC3
          ENDIF
.
          MATCH     PTVIS063,Z70
          IF        !@EQUAL
            MOVE      PTVIS063,PMVXHOME
          ENDIF
.
          MATCH     PTVIS064,Z70
          IF        !@EQUAL
            MOVE      PTVIS064,PMVXUDF1
          ENDIF
.
          MATCH     PTVIS065,Z70
          IF        !@EQUAL
            MOVE      PTVIS065,PMVXUDF2
          ENDIF
.
          MATCH     PTVIS066,Z70
          IF        !@EQUAL
            MOVE      PTVIS066,PMVXUDF3
          ENDIF
.
          MATCH     PTVIS067,Z70
          IF        !@EQUAL
            MOVE      PTVIS067,PMVXUDF4
          ENDIF
.
          MATCH     PTVIS068,Z70
          IF        !@EQUAL
            MOVE      PTVIS068,PMVXUDT1
          ENDIF
.
          MATCH     PTVIS069,Z70
          IF        !@EQUAL
            MOVE      PTVIS069,PMVXUDT2
          ENDIF
.
          MATCH     PTVIS070,Z70
          IF        !@EQUAL
            MOVE      PTVIS070,PMVXUDT3
          ENDIF
.
          MATCH     PTVIS071,Z70
          IF        !@EQUAL
            MOVE      PTVIS071,PMVXUDT4
          ENDIF
.
          MATCH     PTVIS072,Z70
          IF        !@EQUAL
            MOVE      PTVIS072,PMVXUDT5
          ENDIF
.
          MATCH     PTVIS073,Z70
          IF        !@EQUAL
            MOVE      PTVIS073,PMVXUDT6
          ENDIF
.
          MATCH     PTVIS074,Z70
          IF        !@EQUAL
            MOVE      PTVIS074,PMVXMHLS
          ENDIF
.
          MATCH     PTVIS075,Z70
          IF        !@EQUAL
            MOVE      PTVIS075,PMVXPICD
          ENDIF
.
          MATCH     PTVIS076,Z70
          IF        !@EQUAL
            MOVE      PTVIS076,PMVXUDIN
          ENDIF
.
          MATCH     PTVIS077,Z70
          IF        !@EQUAL
            MOVE      PTVIS077,PMVXPALC
          ENDIF
.
          MATCH     PTVIS078,Z70
          IF        !@EQUAL
            MOVE      PTVIS078,PMVXUREA
          ENDIF
.
          MATCH     PTVIS079,Z70
          IF        !@EQUAL
            MOVE      PTVIS079,PMVXUVTH
          ENDIF
.
          MATCH     PTVIS080,Z70
          IF        !@EQUAL
            MOVE      PTVIS080,PMVXPPAL
          ENDIF
.
          MATCH     PTVIS081,Z70
          IF        !@EQUAL
            MOVE      PTVIS081,PMVXELPS
          ENDIF
.
          MATCH     PTVIS082,Z70
          IF        !@EQUAL
            MOVE      PTVIS082,PMVXPRMI
          ENDIF
.
          MATCH     PTVIS083,Z70
          IF        !@EQUAL
            MOVE      PTVIS083,PMVXPRAI
          ENDIF
.
          MATCH     PTVIS084,Z70
          IF        !@EQUAL
            MOVE      PTVIS084,PMVXPRES
          ENDIF
.
          MATCH     PTVIS085,Z70
          IF        !@EQUAL
            MOVE      PTVIS085,PMVXUITR
          ENDIF
.
          MATCH     PTVIS086,Z70
          IF        !@EQUAL
            MOVE      PTVIS086,PMVXRPOA
          ENDIF
.
          MATCH     PTVIS087,Z70
          IF        !@EQUAL
            MOVE      PTVIS087,PMVXRCN1
          ENDIF
.
          MATCH     PTVIS088,Z70
          IF        !@EQUAL
            MOVE      PTVIS088,PMVXRCN2
          ENDIF
.
          MATCH     PTVIS089,Z70
          IF        !@EQUAL
            MOVE      PTVIS089,PMVXRHFU
          ENDIF
.
          MATCH     PTVIS090,Z70
          IF        !@EQUAL
            MOVE      PTVIS090,PMVXRDVA
          ENDIF
.
          MATCH     PTVIS091,Z70
          IF        !@EQUAL
            MOVE      PTVIS091,PMVXRSLO
          ENDIF
.
          MATCH     PTVIS092,Z70
          IF        !@EQUAL
            MOVE      PTVIS092,PMVXMLOC
          ENDIF
.
          MATCH     PTVIS093,Z70
          IF        !@EQUAL
            MOVE      PTVIS093,PMVXPACC
          ENDIF
.
          MATCH     PTVIS094,Z70                                       *I-53371
          IF        !@EQUAL
            MOVE      PTVIS094,PMVXREAD
          ENDIF
.
          MATCH     PTVIS095,Z70                                       *I-53371
          IF        !@EQUAL
            MOVE      PTVIS095,PMVXUSAC
          ENDIF
.
          MATCH     PTVIS096,Z70
          IF        !@EQUAL
            MOVE      PTVIS096,PMVXEDU1
          ENDIF
.
          MATCH     PTVIS097,Z70
          IF        !@EQUAL
            MOVE      PTVIS097,PMVXEDU2
          ENDIF
.
          MATCH     PTVIS098,Z70
          IF        !@EQUAL
            MOVE      PTVIS098,PMVXEDU3
          ENDIF
.
          MATCH     PTVIS099,Z70                                       *I-86040
          IF        !@EQUAL
            MOVE      PTVIS099,PMVXPRGM
          ENDIF
.
          MATCH     PTVIS100,Z70
          IF        !@EQUAL
            MOVE      PTVIS100,PMVXEOCL
          ENDIF
.
          MATCH     PTVIS101,Z70
          IF        !@EQUAL
            MOVE      PTVIS101,PMVXSLOC
          ENDIF
.
          MATCH     PTVIS102,Z70
          IF        !@EQUAL
            MOVE      PTVIS102,PMVXSCLI
          ENDIF
.
          MATCH     PTVIS103,Z70
          IF        !@EQUAL
            MOVE      PTVIS103,PMVXSTRA
          ENDIF
.
          MATCH     PTVIS104,Z70
          IF        !@EQUAL
            MOVE      PTVIS104,PMVXEMPL
          ENDIF
.
          MATCH     PTVIS105,Z70
          IF        !@EQUAL
            MOVE      PTVIS105,PMVXQASN
          ENDIF
.
          MATCH     PTVIS106,Z70
          IF        !@EQUAL
            MOVE      PTVIS106,PMVXPSOS
          ENDIF
.
          MATCH     PTVIS107,Z70
          IF        !@EQUAL
            MOVE      PTVIS107,PMVXASUT
          ENDIF
.
          MATCH     PTVIS108,Z70
          IF        !@EQUAL
            MOVE      PTVIS108,PMVXPPPT
          ENDIF
.
          MATCH     PTVIS109,Z70
          IF        !@EQUAL
            MOVE      PTVIS109,PMVXPOEC
          ENDIF
.
          MATCH     PTVIS110,Z70
          IF        !@EQUAL
            MOVE      PTVIS110,PMVXPGID
          ENDIF
.
          MATCH     PTVIS111,Z70
          IF        !@EQUAL
            MOVE      PTVIS111,PMVXPILC
          ENDIF
.
          MATCH     PTVIS112,Z70
          IF        !@EQUAL
            MOVE      PTVIS112,PMVXFVIO
          ENDIF
.
          MATCH     PTVIS113,Z70
          IF        !@EQUAL
            MOVE      PTVIS113,PMVXUDF5
          ENDIF
.
          MATCH     PTVIS114,Z70
          IF        !@EQUAL
            MOVE      PTVIS114,PMVXUDF6
          ENDIF
.
          MATCH     PTVIS115,Z70
          IF        !@EQUAL
            MOVE      PTVIS115,PMVXUDF7
          ENDIF
.
          MATCH     PTVIS116,Z70
          IF        !@EQUAL
            MOVE      PTVIS116,PMVXUDF8
          ENDIF
.
          MATCH     PTVIS117,Z70
          IF        !@EQUAL
            MOVE      PTVIS117,PMVXUDF9
          ENDIF
.
          MATCH     PTVIS118,Z70
          IF        !@EQUAL
            MOVE      PTVIS118,PMVXUD10
          ENDIF
.
          MATCH     PTVIS119,Z70
          IF        !@EQUAL
            MOVE      PTVIS119,PMVXUD11
          ENDIF
.
          MATCH     PTVIS120,Z70
          IF        !@EQUAL
            MOVE      PTVIS120,PMVXUD12
          ENDIF
.
          MATCH     PTVIS121,Z70
          IF        !@EQUAL
            MOVE      PTVIS121,PMVXUD13
          ENDIF
.
          MATCH     PTVIS122,Z70
          IF        !@EQUAL
            MOVE      PTVIS122,PMVXUD14
          ENDIF
.
          MATCH     PTVIS123,Z70
          IF        !@EQUAL
            MOVE      PTVIS123,PMVXUD15
          ENDIF
.
          MATCH     PTVIS124,Z70
          IF        !@EQUAL
            MATCH     PTVIS124,PMVXTEAM
            IF        !@EQUAL
              MOVE      PTVIS124,PTTRTEAM
              MOVE      ONE,CHGTEAM
            ENDIF
            MOVE      PTVIS124,PMVXTEAM
          ENDIF
.
          MATCH     PTVIS125,Z70
          IF        !@EQUAL
            MOVE      PTVIS125,PMVXNWHC
          ENDIF
.
          MATCH     PTVIS126,Z70
          IF        !@EQUAL
            MOVE      PTVIS126,PMVXEDDT
          ENDIF
.
          MATCH     PTVIS127,Z70
          IF        !@EQUAL
            MOVE      PTVIS127,PMVXPHLD
          ENDIF
.
          MATCH     PTVIS128,Z70
          IF        !@EQUAL
            MOVE      PTVIS128,PMVXPLOC
          ENDIF
.
          MATCH     PTVIS129,Z70
          IF        !@EQUAL
            MOVE      PTVIS129,PMVXDTRT
          ENDIF
.
          MATCH     PTVIS130,Z70
          IF        !@EQUAL
            MOVE      PTVIS130,PMVXDFLG
          ENDIF
.
          MATCH     PTVIS131,Z70
          IF        !@EQUAL
            MOVE      PTVIS131,PMVXFSRC
            MATCH     PTVIS131,PTTRFSRC
            IF        !@EQUAL
              MOVE      PTVIS131,PTTRFSRC
            ENDIF
          ENDIF
.
          MATCH     PTVIS132,Z70
          IF        !@EQUAL
            MOVE      PTVIS132,PMVXCONM
          ENDIF
.
          MATCH     PTVIS133,Z70
          IF        !@EQUAL
            MOVE      PTVIS133,PMVXPBMI
          ENDIF
.
          MATCH     PTVIS134,Z70
          IF        !@EQUAL
            MOVE      PTVIS134,PMVXUDF6
          ENDIF
.
          MOVE      SP70,PMVXSPAR
          MOVE      PMPXABRG,PMVXABRG
.
          MATCH     "1",PTCNINTR
          IF        @EQUAL
            MATCH     PTVIS135,Z70
            IF        !@EQUAL
              MOVE      PTVIS135,PMVXINTR    * Interpreter required
            ENDIF
          ELSE
            MOVE      PMPXINTR,PMVXINTR      * Interpreter required
            MOVE      PMPXLNG1,PMVXLNG1      * Preferred Language 1
          ENDIF
.
          MATCH     PTVIS136,Z70
          IF        !@EQUAL
            MOVE      PTVIS136,PMVXADMP      * Adm Paperwork Receive
          ENDIF
.
          MATCH     PTVIS137,Z70
          IF        !@EQUAL
            MOVE      PTVIS137,PMVXCONO      * Consent Obtained
          ENDIF
.
          MATCH     PTVIS138,Z70
          IF        !@EQUAL
            MOVE      PTVIS138,PMVXMEDH      * Medical History Received
          ENDIF
.
          CALL      GTASGC00               * SLA/ASGC code
          MOVE      PMPXPRVI,PMVXPIND      * Privacy Indicator
          MOVE      PMPXCRIN,PMVXCSNR      * Consent Release of info
          MOVE      PMPXHOML,PMVXHOME      * Homeless status
          MATCH     Z70,PMSVX146
          IF        !@EQUAL
            MOVE      PMSVX146,PMVXCASE      * Case Team
          ENDIF
.
UPDVIS90  MOVE      ZERO,EXIT
          PACK      KEY8,ADMISSNO,SP70
          CALL      RAPMVX11                   * pmsvx1 record found ?
          BRANCH    OVRCD,UPDVIS99
.
          CALL      UPPMVX11                   * update the pmsvx1 record
.
UPDVIS99  RETURN
+
.------------------------------------------------------------
. UPWRK000 - Update Work Capacity Details
.------------------------------------------------------------
UPWRK000  COMPARE   ONE,CLMUPDFL
          GOTO      UPWRK999 IF NOT EQUAL
.
          MATCH     Z70,PTCLM067
          IF        !@EQUAL
            MOVE      PTCLM067,PMWXASST
          ENDIF
.
          MATCH     Z70,PTCLM068
          IF        !@EQUAL
            MOVE      PTCLM068,PMWXNEED
          ENDIF
.
          MATCH     Z70,PTCLM069
          IF        !@EQUAL
            MOVE      PTCLM069,PMWXCONT
          ENDIF
.
          MATCH     Z70,PTCLM070
          IF        !@EQUAL
            MOVE      PTCLM070,PMWXALTW
          ENDIF
.
          MATCH     Z70,PTCLM071
          IF        !@EQUAL
            MOVE      PTCLM071,PMWXTYPA
          ENDIF
.
          MATCH     Z70,PTCLM072
          IF        !@EQUAL
            MOVE      PTCLM072,PMWXSALT
          ENDIF
.
          MATCH     Z70,PTCLM073
          IF        !@EQUAL
            MOVE      PTCLM073,PMWXHPDA
          ENDIF
.
          MATCH     Z70,PTCLM074
          IF        !@EQUAL
            MATCH     "0",PTCLM074
            IF        @EQUAL
              MOVE      SP70,PTCLM074
            ENDIF
            MOVE      PTCLM074,PMWXUNFD
          ENDIF
.
          MATCH     Z70,PTCLM075
          IF        !@EQUAL
            MOVE      PTCLM075,PMWXUNFT
          ENDIF
.
          MATCH     Z70,PTCLM076
          IF        !@EQUAL
            MOVE      PTCLM076,PMWXFISD
          ENDIF
.
          MATCH     Z70,PTCLM077
          IF        !@EQUAL
            MOVE      PTCLM077,PMWXRNWD
          ENDIF
.
          MATCH     Z70,PTCLM083
          IF        !@EQUAL
            MOVE      PTCLM083,PMWXECOD
          ENDIF
.
          MATCH     Z70,PTCLM087
          IF        !@EQUAL
            MOVE      PTCLM087,PMWXAPPR
          ENDIF
UPWRK999  RETURN
.------------------------------------------------------------
. UPCLV000 - Update Claim variable's
.------------------------------------------------------------
.
UPCLV000  COMPARE   ONE,CLMUPDFL
          GOTO      UPCLV999 IF NOT EQUAL
.
.                   (PTCLM001 to PTCLM010 moved into CPCLV000)
.
          MATCH     Z70,PTCLM011
          IF        !@EQUAL
            MOVE      PTCLM011,WCCLMNO
          ENDIF
.
.                   (PTCLM012 to PTCLM013 moved into CPCLV000)
.
          MATCH     Z70,URNUMBER
          IF        !@EQUAL
            MOVE      URNUMBER,PTWCURNO
          ENDIF
.
          MATCH     Z70,PTCLM014
          IF        !@EQUAL
            MOVE      PTCLM014,VCLMNO
          ENDIF
.
          MATCH     Z70,PTCLM015
          IF        !@EQUAL
            MOVE      PTCLM015,MREFNO
          ENDIF
.
          MATCH     Z70,PTCLM016
          IF        !@EQUAL
            MOVE      PTCLM016,MACDAT
          ENDIF
.
          MATCH     Z70,PTCLM017
          IF        !@EQUAL
            MOVE      PTCLM017,MPOLIC
          ENDIF
.
          MATCH     Z70,PTCLM018
          IF        !@EQUAL
            MOVE      PTCLM018,MCREGO
          ENDIF
.
          MATCH     Z70,PTCLM019
          IF        !@EQUAL
            MOVE      PTCLM019,MOTHDET1
          ENDIF
.
          MATCH     Z70,PTCLM020
          IF        !@EQUAL
            MOVE      PTCLM020,MOTHDET2
          ENDIF
.
          MATCH     Z70,PTCLM021
          IF        !@EQUAL
            MOVE      PTCLM021,MOTHDET3
          ENDIF
.
          MATCH     Z70,PTCLM022
          IF        !@EQUAL
            MOVE      PTCLM022,MMDTRANS
          ENDIF
.
          MATCH     Z70,PTCLM023
          IF        !@EQUAL
            MOVE      PTCLM023,MDPINDIC
          ENDIF
.
          MATCH     Z70,PTCLM024
          IF        !@EQUAL
            MOVE      PTCLM024,MENGAGED
          ENDIF
.
          MATCH     Z70,PTCLM025
          IF        !@EQUAL
            MOVE      PTCLM025,MPINJURE
          ENDIF
.
          MATCH     Z70,PTCLM026
          IF        !@EQUAL
            MOVE      PTCLM026,MMECHSEV
          ENDIF
.
          MATCH     Z70,PTCLM027
          IF        !@EQUAL
            MOVE      PTCLM027,MREGNSEV
          ENDIF
.
          MATCH     Z70,PTCLM028
          IF        !@EQUAL
            MOVE      PTCLM028,MSNAME
          ENDIF
.
          MATCH     Z70,PTCLM029
          IF        !@EQUAL
            MOVE      PTCLM029,MSTELE
          ENDIF
.
          MATCH     Z70,PTCLM030
          IF        !@EQUAL
            MOVE      PTCLM030,MACLOC
          ENDIF
.
          MATCH     Z70,PTCLM031
          IF        !@EQUAL
            MOVE      PTCLM031,PTWMTACF
          ELSE
            MOVE      ZERO,PTWMTACF
          ENDIF
.
          MATCH     Z70,PTCLM032
          IF        !@EQUAL
            MOVE      PTCLM032,PTWMTYPE
          ENDIF
.
          MATCH     Z70,URNUMBER
          IF        !@EQUAL
            MOVE      URNUMBER,PTWMURNO
          ENDIF
.                                                                   * Car 273294
          MATCH     Z70,PTCLM082
          IF        !@EQUAL
            MOVE      PTCLM082,PTWMICDE
          ENDIF
.
.                   (PTCLM033 to PTCLM036 moved into CPCLV000)
.
. Move the remaining fields of Extension file
.
          MOVE      ADMISSNO,PMWXVISN              * Visit No.
.
          MATCH     Z70,PTCLM037
          IF        !@EQUAL
            MOVE      PTCLM037,PMCTSNAM
          ENDIF
.
          MATCH     Z70,PTCLM038
          IF        !@EQUAL
            MOVE      PTCLM038,PMCTSAD1
          ENDIF
.
          MATCH     Z70,PTCLM039
          IF        !@EQUAL
            MOVE      PTCLM039,PMCTSAD2
          ENDIF
.
          MATCH     Z70,PTCLM040
          IF        !@EQUAL
            MOVE      PTCLM040,PMCTSAD3
          ENDIF
.
          MATCH     Z70,PTCLM041
          IF        !@EQUAL
            MOVE      PTCLM041,PMCTSAD4
          ENDIF
.
          MATCH     Z70,PTCLM042
          IF        !@EQUAL
            MOVE      PTCLM042,PMCTSPCO
          ENDIF
.
          MATCH     Z70,PTCLM043
          IF        !@EQUAL
            MOVE      PTCLM043,PMCTSPHN
          ENDIF
.
          MATCH     Z70,PTCLM044
          IF        !@EQUAL
            MOVE      PTCLM044,PMCTCONT
          ENDIF
.
          MATCH     Z70,PTCLM045
          IF        !@EQUAL
            MOVE      PTCLM045,PMCTREFN
          ENDIF
.
.                   (PTCLM046 to PTCLM049 moved into CPCLV000)
.
          MATCH     Z70,PTCLM050
          IF        !@EQUAL
            MOVE      PTCLM050,PTWVAUTH
          ENDIF
.
          MATCH     Z70,PTCLM051
          IF        !@EQUAL
            MOVE      PTCLM051,PTWVDATE
          ENDIF
.
.                   (PTCLM052 to PTCLM066 moved into CPCLV000)
.
.                   (PTCLM078 to PTCLM081 moved into CPCLV000)
.
          MATCH     Z70,PTCLM088
          IF        !@EQUAL
            MOVE      PTCLM088,PMWXPORD
          ENDIF
.
.
          CALL      CPCLV000                * load data for PATWC1af & PMSWX1af
.
UPCLV999  RETURN
+
.------------------------------------------------------------
. CPCLV000 - Copy ACC fields to all other records for this ACC No.
.------------------------------------------------------------
CPCLV000  MOVE      ZERO,EXIT
          MATCH     Z70,PTCLM001
          IF        !@EQUAL
            MOVE      PTCLM001,WCENAME
          ENDIF
.
          MATCH     Z70,PTCLM002
          IF        !@EQUAL
            MOVE      PTCLM002,WCEADD1
          ENDIF
.
          MATCH     Z70,PTCLM003
          IF        !@EQUAL
            MOVE      PTCLM003,WCEADD2
          ENDIF
.
          MATCH     Z70,PTCLM004
          IF        !@EQUAL
            MOVE      PTCLM004,WCEADD3
          ENDIF
.
          MATCH     Z70,PTCLM005
          IF        !@EQUAL
            MOVE      PTCLM005,WCEADD4
          ENDIF
.
          MATCH     Z70,PTCLM006
          IF        !@EQUAL
            MOVE      PTCLM006,WCEPOST
          ENDIF
.
          MATCH     Z70,PTCLM007
          IF        !@EQUAL
            MOVE      PTCLM007,WCETELE
          ENDIF
.
          MATCH     Z70,PTCLM008
          IF        !@EQUAL
            MOVE      PTCLM008,WCACDAT
          ENDIF
.
          MATCH     Z70,PTCLM009
          IF        !@EQUAL
            MOVE      PTCLM009,WCACCPT
          ENDIF
.
          MATCH     Z70,PTCLM010
          IF        !@EQUAL
            MOVE      PTCLM010,WCICODE
          ENDIF
.
          MATCH     Z70,PTCLM012
          IF        !@EQUAL
            MOVE      PTCLM012,WCCOMN1
          ENDIF
.
          MATCH     Z70,PTCLM013
          IF        !@EQUAL
            MOVE      PTCLM013,WCCOMN2
          ENDIF
.
          MATCH     Z70,PTCLM033
          IF        !@EQUAL
            MOVE      PTCLM033,PMWXALOC
          ENDIF
.
          MATCH     Z70,PTCLM034
          IF        !@EQUAL
            MOVE      PTCLM034,PMWXCINJ
          ENDIF
.
          MATCH     Z70,PTCLM035
          IF        !@EQUAL
            MOVE      PTCLM035,PMWXICOD
          ENDIF
.
          MATCH     Z70,PTCLM036
          IF        !@EQUAL
            MOVE      PTCLM036,PMWXCNAM
          ENDIF
.
          MATCH     Z70,PTCLM046
          IF        !@EQUAL
            MOVE      PTCLM046,PMWXACCF
          ENDIF
.
          MATCH     Z70,PTCLM047
          IF        !@EQUAL
            MOVE      PTCLM047,PMWXPLIN
          ENDIF
.
          MATCH     Z70,PTCLM048
          IF        !@EQUAL
            MOVE      PTCLM048,PMWXACTI
          ENDIF
.
          MATCH     Z70,PTCLM049
          IF        !@EQUAL
            MOVE      PTCLM049,PMWXADTE
          ENDIF
.
          MATCH     Z70,PTCLM052
          IF        !@EQUAL
            MOVE      PTCLM052,PMWXATME
          ENDIF
.
          MATCH     Z70,PTCLM053
          IF        !@EQUAL
            MOVE      PTCLM053,PMWXACLC
          ENDIF
.
          MATCH     Z70,PTCLM054
          IF        !@EQUAL
            MOVE      PTCLM054,PMWXAINZ
          ENDIF
.
          MATCH     Z70,PTCLM055
          IF        !@EQUAL
            MOVE      PTCLM055,PMWXMOVV
          ENDIF
.
          MATCH     Z70,PTCLM056
          IF        !@EQUAL
            MOVE      PTCLM056,PMWXSPTI
          ENDIF
.
          MATCH     Z70,PTCLM057
          IF        !@EQUAL
            MOVE      PTCLM057,PMWXSPRT
          ENDIF
.
          MATCH     Z70,PTCLM058
          IF        !@EQUAL
            MOVE      PTCLM058,PMWXRECI
          ENDIF
.
          MATCH     Z70,PTCLM059
          IF        !@EQUAL
            MOVE      PTCLM059,PMWXTRIC
          ENDIF
.
          MATCH     Z70,PTCLM060
          IF        !@EQUAL
            MOVE      PTCLM060,PMWXESTA
          ENDIF
.
          MATCH     Z70,PTCLM061
          IF        !@EQUAL
            MOVE      PTCLM061,PMWXPDDT
          ENDIF
.
          MATCH     Z70,PTCLM062
          IF        !@EQUAL
            MOVE      PTCLM062,PMWXARG1
          ENDIF
.
          MATCH     Z70,PTCLM063
          IF        !@EQUAL
            MOVE      PTCLM063,PMWXARG2
          ENDIF
.
          MATCH     Z70,PTCLM064
          IF        !@EQUAL
            MOVE      PTCLM064,PMWXARSN
          ENDIF
.
          MATCH     Z70,PTCLM065
          IF        !@EQUAL
            MOVE      PTCLM065,PMWXARTL
          ENDIF
.
          MATCH     Z70,PTCLM066
          IF        !@EQUAL
            MOVE      PTCLM066,PMWXARRP
          ENDIF
.
          MATCH     Z70,PTCLM078
          IF        !@EQUAL
            MOVE      PTCLM078,PMWXCSTA
          ENDIF
.
          MATCH     Z70,PTCLM079
          IF        !@EQUAL
            MOVE      PTCLM079,PMWXTWRK
          ENDIF
.
          MATCH     Z70,PTCLM080
          IF        !@EQUAL
            MOVE      PTCLM080,PMWXOEST
          ENDIF
.
          MATCH     Z70,PTCLM081
          IF        !@EQUAL
            MOVE      PTCLM081,PMWXTPRO
          ENDIF
.
          MATCH     Z70,PTCLM083
          IF        !@EQUAL
            MOVE      PTCLM083,PMWXECOD
          ENDIF
.
          MATCH     Z70,PTCLM084
          IF        !@EQUAL
            MOVE      PTCLM084,PMWXGRAD
          ENDIF
.
          MATCH     Z70,PTCLM085
          IF        !@EQUAL
            MOVE      PTCLM085,PMWXAHOS
          ENDIF
.
          MATCH     Z70,PTCLM086
          IF        !@EQUAL
            MOVE      PTCLM086,PMWXVCON
          ENDIF
.
          MATCH     Z70,PTCLM087
          IF        !@EQUAL
            MOVE      PTCLM087,PMWXAPPR
          ENDIF
.
          MATCH     Z70,PTCLM089
          IF        !@EQUAL
            MOVE      PTCLM089,PMWXVHCP
          ENDIF
.
CPCLV999  RETURN
+
.------------------------------------------------------------
. NXTA0000 - Get Next Admission Number -  From PATPRG31
.------------------------------------------------------------
.
NXTA0000  READ      CONTROLF,HUND30;*75,PTCNUANV      * Using AN Visit Numbers
.
          MATCH     "1",PTCNUANV
          IF        @EQUAL
            CALL      GANV0000                * Get next AN visit number
            MOVE      PTCNNXTV,AADMNO
          ELSE
            MOVE      " 10",PRXCODE
            CALL      GETSLK00
            READ      CONTROLF,TEN;*1,FORM8V
            ADD       ONE,FORM8V
            WRITAB    CONTROLF,TEN;*1,FORM8V
            CALL      RELSLK00
            SUB       ONE,FORM8V
            MOVE      FORM8V,AADMNO
          ENDIF
.
. Check with visit file, make sure it does not exist already
.
          MOVE      AADMNO,PVIBILL
          MOVE      PVIBILL,KEY8
          CALL      RDAVISA1
          COMPARE   ZERO,OVRCD
          GOTO      NXTA0000 IF EQUAL       * get the next Admission Number
.
          CALL      RDAMISS1
          COMPARE   ZERO,OVRCD
          GOTO      NXTA0000 IF EQUAL       * get the next Admission Number
.
NXTA9999  RETURN
+
.------------------------------------------------------------
. UPPRA000 - Update person responsible for account
.------------------------------------------------------------
.
UPPRA000  MATCH     "1",PTCNNEWC            * using new contacts ?
          IF        @EQUAL
            CALL      UPRF0000              * Get Contact for Usual PRFA
            COMPARE   ZERO,EXIT
            GOTO      UPPRA010 IF EQUAL
          ENDIF
          COMPARE   ZERO,PRAUPDFL
          GOTO      UPPRA999 IF EQUAL
.
UPPRA010  MOVE      ADMISSNO,PKADMN
          MOVE      PKADMN,KEY8
.
          MATCH     SP70,PKNAME             * If no name don't write a record
          GOTO      UPPRA200 IF EQUAL
.
          CALL      RDARESP1
          BRANCH    OVRCD,UPPRA100
.
          IF        PCEASE=1
            MATCH     "1",PTCNDEES
            IF        @EQUAL
              UNPACK    PKNAME,KEY2
              MATCH     DLCHAR,KEY2
              IF        @EQUAL
                MATCH     SP70,PTCNDDES
                IF        !@EQUAL
                  STRIP     PTCNDDES
                  MOVE      PTCNDDES,KEY20
                  UNPACK    PKNAME,DIM2,KEY78      * ignore "$ "
                  PACK      PKNAME,KEY20,SP1,KEY78,SP70
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
UPPRA020  CALL      UPRESP1
          GOTO      UPPRA900
.
UPPRA100  CALL      WRRESP1
          GOTO      UPPRA900
.
UPPRA200  CALL      RDRESP1
          IF        OVRCD=1
            CALL      CLPATRE1       * Clear PRFA variables
            GOTO      UPPRA900
          ENDIF
          CALL      DERESP1
.
UPPRA900  CALL      TACC0000                   * send HL7 message
          CALL      UPRI0000         * Update private practice prfa
.
UPPRA999  RETURN
+
.------------------------------------------------------------
. UPPMI000 - Update PMI Extension details
.------------------------------------------------------------
.
UPPMI000  MOVE      URNUMBER,PMPXURNO
          MOVE      PMPXURNO,KEY8
          CALL      RAPMPX21
          IF        OVRCD=1
            CALL      WRPMPX21          * write a new record
          ELSE
            CALL      UPPMPX21          * update the record
          ENDIF
.
UPPMI999  RETURN
+
.----------------------------------------------------------------------
. UPAD0000 - Update address details save last address change for today
.----------------------------------------------------------------------
UPAD0000  PACK      PADATE,CCC,CYY,CMM,CDD
          REP       " 0",PADATE
          CLOCK     TIME,PATIME
.
          PACK      KEY24,PURNO,PADATE,PATIME
          CALL      RDPADD1                 * Read previous address file
          IF        OVRCD = 1
            MOVE      PURNO,PAURNO
            MOVE      SPADD1,PAADD1
            MOVE      SPADD2,PAADD2
            MOVE      SPSUBRB,PASUBR
            MOVE      SPADD4,PAADD4
            MOVE      SPPOST,PAPOST
            MOVE      SPTELEP,PATELEP
            MOVE      SPTELEB,PATELEB
            MOVE      SPCELL,PTPAMOBL
            MOVE      SPPEML,PTPAEMAL
            MOVE      SPOSMS,PTPAOSMS
            CALL      IBACLOCK
            PACK      PTPACDTE,CCC,CYY,CMM,CDD
            REPLACE   " 0",PTPACDTE
            CLOCK     TIME,PTPACTIM
            MOVE      USERID,PTPAWEBC
            MOVE      SP70,PTPALUPD
            MOVE      SP70,PTPALUPT
            MOVE      USERID,PTPAWEBU         * Updated by
            MOVE      SP70,PTPASPAR
            CALL      WRPADD1                 * Write to previous address file
          ELSE
            MOVE      PURNO,PAURNO
            MOVE      SPADD1,PAADD1
            MOVE      SPADD2,PAADD2
            MOVE      SPSUBRB,PASUBR
            MOVE      SPADD4,PAADD4
            MOVE      SPPOST,PAPOST
            MOVE      SPTELEP,PATELEP
            MOVE      SPTELEB,PATELEB
            MOVE      SPCELL,PTPAMOBL
            MOVE      SPPEML,PTPAEMAL
            MOVE      SPOSMS,PTPAOSMS
            CALL      IBACLOCK
            PACK      PTPALUPD,CCC,CYY,CMM,CDD
            REPLACE   " 0",PTPALUPD
            CLOCK     TIME,PTPALUPT
            MOVE      USERID,PTPAWEBU
            MOVE      SP70,PTPASPAR
            CALL      UPPADD1                 * Write to previous address file
          ENDIF
.
UPAD9999  RETURN
+
.------------------------------------------------------------
. PNMP0000  :  Post NMPI Number
.              Parameter : PURNO   (U/R Number)
.                          PVIBILL (Visit Number)
.                          NMPNUMB (NMPI Number)
. from KEYINPMI
.------------------------------------------------------------
.
PNMP0000  COMPARE   ZERO,PTCNNMPI
          GOTO      PNMP9999 IF EQUAL            * not using link
.
          COMPARE   ONE,PTCNNHII
          GOTO      PNMP9999 IF EQUAL            * using NZ link
.
.         Check whether a nmpi number has been inputed, if one has
.         write it to the PNI/NID/NMP file, otherwise do nothing
.
          MATCH     NMPNUMB,SP20
          GOTO      PNMP5000 IF EQUAL            * no number entered
.
          MATCH     ZEROUR,PURNO
          GOTO      PNMP3000 IF NOT EQUAL
.
.         Zero U/R :: post to PATPNI file
.
          MATCH     ZEROVISN,PVIBILL
          GOTO      PNMP9999 IF EQUAL
.
.         Zero Billing Number DO NOT POST TO PNI FILE OR NMP FILE
.
          PACK      KEY10,CHOSINDX,PVIBILL   * Hospital No. and visit No.
          CALL      RDPTPNI1
          MOVE      CHOSINDX,PTPNHNUM        * Hospital No.
          MOVE      PVIBILL,PTPNADNO         * Admission No.
          MOVE      NMPNUMB,PTPNNMPI         * National Id
          IF        OVRCD = ONE
            CALL      WRPTPNI1               * Write record does not exist
          ELSE
            CALL      UPPTPNI1               * Update record exists
          ENDIF
          GOTO      PNMP9999
.
.         A valid U/R :: post to PATNMP/PATNID file
.
PNMP3000  PACK      KEY10,CHOSINDX,PURNO
          CALL      RDPTNID1
          BRANCH    OVRCD,PNMP4000
.
          MOVE      NMPNUMB,PTNINMPI         * National Id
          CALL      UPPTNID1                * Update File
          GOTO      PNMP9999
.
PNMP4000  PACK      KEY10,CHOSINDX,PVIBILL
          CALL      RDPTPNI1                  * Exist on PNI file ?
          IF        OVRCD = ONE
            MOVE      CHOSINDX,PTNIHNUM       * No. hospital number
            MOVE      PURNO,PTNILNUM          *     local U/R Number
.
            SQUEEZE   NMPNUMB                 * left justify field
            PACK      NMPNUMB,NMPNUMB,SP20    * clear rest of field
            STRIP     NMPNUMB                 * remove blanks
            MOVELPTR  NMPNUMB,FORM2           * get the actual length
.
            MOVE      SP20,PTNINMPI           * clear the actual field
            ASSIGN    20-FORM2,IMON           * get the No. blanks at start
            RESET     PTNINMPI,IMON           * reset actual field
            APPEND    NMPNUMB,PTNINMPI        * add items entered
            RESET     PTNINMPI                * this field is now Right Just.
            MOVE      SP10,PTNISPAR           *     set spare variable
            PACK      KEY10,CHOSINDX,PURNO    *     Reset Key
            CALL      WRPTNID1                *     Write NMP record
          ELSE
            MOVE      PTPNHNUM,PTNIHNUM       * Yes. copy hospital number
            MOVE      PURNO,PTNILNUM          *      copy local U/R Number
            MOVE      PTPNNMPI,PTNINMPI       *      copy nmpi U/R No.
            MOVE      SP10,PTNISPAR           *      set spare variable
            PACK      KEY10,CHOSINDX,PURNO    *      Reset Key
            CALL      WRPTNID1                *      Write NMP record
            PACK      KEY10,CHOSINDX,PVIBILL   * Hospital No. and visit No.
            CALL      DEPTPNI1                *      delete PNI record
          ENDIF
          GOTO      PNMP9999
.
.         Nothing input. Check if there was previously details, and if so,
.         delete them
.
PNMP5000  MATCH     ZEROUR,PURNO             * Zero U/R Number
          IF        @EQUAL
            PACK      KEY10,CHOSINDX,PVIBILL
            CALL      DEPTPNI1
          ENDIF
          PACK      KEY10,CHOSINDX,PURNO   * All other countries
          CALL      DEPTNID1
.
PNMP9999  RETURN
+
.------------------------------------------------------------
. CLPV0000 - Clear patient visit variables
.------------------------------------------------------------
.
CLPV0000  MOVE      SP70,PVIDATE
          MOVE      SP70,PVIDOCT
          MOVE      SP70,PVILOCK
          MOVE      SP70,PVISITE
          MOVE      SP70,PVIRESI
          MOVE      ZERO,PVITYPE
          MOVE      ZERO,PVITRAN
          MOVE      ZERO,PVISTAT
          PACK      PTVITYPE,SP70

          MOVE      SP70,PVISYST
          MOVE      SP70,PMVXVISN
          MOVE      SP70,PMVXVSDT
          MOVE      SP70,PMVXDOCA
          MOVE      SP70,PMVXDOCT
          MOVE      SP70,PMVXCSNR
          MOVE      SP70,PMVXPOST
          MOVE      SP70,PMVXPIND
          MOVE      SP70,PMVXVLOC
          MOVE      SP70,PMVXCFSG
          MOVE      SP70,PMVXINGP
          MOVE      SP70,PMVXCPTH
          MOVE      SP70,PMVXHCP1
          MOVE      SP70,PMVXHCP2
          MOVE      SP70,PMVXHCP3
          MOVE      SP70,PMVXHCP4
          MOVE      SP70,PMVXRHC1
          MOVE      SP70,PMVXRH1G
          MOVE      SP70,PMVXRH1C
          MOVE      SP70,PMVXRHC2
          MOVE      SP70,PMVXRH2G
          MOVE      SP70,PMVXRH2C
          MOVE      SP70,PMVXRHC3
          MOVE      SP70,PMVXRH3G
          MOVE      SP70,PMVXRH3C
          MOVE      SP70,PMVXRHC4
          MOVE      SP70,PMVXRH4G
          MOVE      SP70,PMVXRH4C
          MOVE      SP70,PMVXABRG
          MOVE      SP70,PMVXCADM
          MOVE      SP70,PMVXIRAD
          MOVE      SP70,PMVXIDUS
          MOVE      SP70,PMVXCRAV
          MOVE      SP70,PMVXRCCT
          MOVE      SP70,PMVXAPWD
          MOVE      SP70,PMVXAPBD
          MOVE      SP70,PMVXPOWD
          MOVE      SP70,PMVXPOBD
          MOVE      SP70,PMVXPSTY
          MOVE      SP70,PMVXVALW
          MOVE      SP70,PMVXPALW
          MOVE      SP70,PMVXINDC
          MOVE      SP70,PMVXMDAV
          MOVE      SP70,PMVXFRMS
          MOVE      SP70,PMVXCSNG
          MOVE      ZERO,PMVXPWGT
          MOVE      ZERO,PMVXPHGT
          MOVE      SP70,PMVXDHWR
          MOVE      SP70,PMVXEDC1
          MOVE      SP70,PMVXEDC2
          MOVE      SP70,PMVXEDC3
          MOVE      SP70,PMVXHOME
          MOVE      SP70,PMVXUDF1
          MOVE      SP70,PMVXUDF2
          MOVE      SP70,PMVXUDF3
          MOVE      SP70,PMVXUDF4
          MOVE      SP70,PMVXUDT1
          MOVE      SP70,PMVXUDT2
          MOVE      SP70,PMVXUDT3
          MOVE      SP70,PMVXUDT4
          MOVE      SP70,PMVXUDT5
          MOVE      SP70,PMVXUDT6
          MOVE      SP70,PMVXCDTE
          MOVE      SP70,PMVXCTIM
          MOVE      SP70,PMVXWEBC
          MOVE      SP70,PMVXLUPD
          MOVE      SP70,PMVXLUPT
          MOVE      SP70,PMVXWEBU
          MOVE      SP70,PMVXPICD
          MOVE      SP70,PMVXREAD                                      *I-53371
          MOVE      SP70,PMVXMHLS
          MOVE      SP70,PMVXUDIN
          MOVE      SP70,PMVXUREA
          MOVE      SP70,PMVXUSAC
          MOVE      SP70,PMVXUVTH
          MOVE      SP70,PMVXPALC
          MOVE      SP70,PMVXPPAL
          MOVE      SP70,PMVXELPS
          MOVE      ZERO,PMVXINTR
          MOVE      SP70,PMVXLNG1
          MOVE      SP70,PMVXASGC
          MOVE      SP70,PMVXMHOS
          MOVE      SP70,PMVXDSPD
          MOVE      SP70,PMVXDSIF
          MOVE      SP70,PMVXPRMI
          MOVE      SP70,PMVXPRAI
          MOVE      SP70,PMVXPRES
          MOVE      SP70,PMVXUITR
          MOVE      SP70,PMVXRPOA
          MOVE      SP70,PMVXRCN1
          MOVE      SP70,PMVXRCN2
          MOVE      SP70,PMVXRHFU
          MOVE      SP70,PMVXRDVA
          MOVE      SP70,PMVXRSLO
          MOVE      SP70,PMVXMLOC
          MOVE      SP70,PMVXPACC
          MOVE      SP70,PMVXEDU1
          MOVE      SP70,PMVXEDU2
          MOVE      SP70,PMVXEDU3
          MOVE      SP70,PMVXPRGM
          MOVE      SP70,PMVXEOCL
          MOVE      SP70,PMVXSLOC
          MOVE      SP70,PMVXSCLI
          MOVE      SP70,PMVXSTRA
          MOVE      SP70,PMVXQASN
          MOVE      SP70,PMVXATCP
          MOVE      SP70,PMVXEMPL
          MOVE      SP70,PMVXPSOS
          MOVE      SP70,PMVXASUT
          MOVE      SP70,PMVXPPPT
          MOVE      SP70,PMVXPOEC
          MOVE      SP70,PMVXPGID
          MOVE      SP70,PMVXPILC
          MOVE      SP70,PMVXATIM                                      *I-199979
          MOVE      SP70,PMVXITIM                                      *I-199979
          MOVE      SP70,PMVXHFGN
          MOVE      SP70,PMVXHFSN
          MOVE      SP70,PMVXFUPI
          MOVE      SP70,PMVXTICM
          MOVE      SP70,PMVXUDF5
          MOVE      SP70,PMVXUDF6
          MOVE      SP70,PMVXUDF7
          MOVE      SP70,PMVXUDF8
          MOVE      SP70,PMVXUDF9
          MOVE      SP70,PMVXUD10
          MOVE      SP70,PMVXUD11
          MOVE      SP70,PMVXUD12
          MOVE      SP70,PMVXUD13
          MOVE      SP70,PMVXUD14
          MOVE      SP70,PMVXUD15
          MOVE      SP70,PMVXTEAM
          MOVE      SP70,PMVXNWHC
          MOVE      SP70,PMVXEDDT
          MOVE      SP70,PMVXPHLD
          MOVE      SP70,PMVXPLOC
          MOVE      SP70,PMVXDTRT
          MOVE      SP70,PMVXDFLG
          MOVE      SP70,PMVXFSRC
          MOVE      SP70,PMVXCONM
          MOVE      SP70,PMVXCPDD
          MOVE      SP70,PMVXPBMI
          MOVE      SP70,PMVXCNID
          MOVE      SP70,PMVXCNDT
          MOVE      SP70,PMVXCASE
          MOVE      SP70,PMVXEAFL
          MOVE      SP70,PMVXCONF      * Appointment Confirmed (used by SMS)
          MOVE      SP70,PMVXADMP
          MOVE      SP70,PMVXCONO
          MOVE      SP70,PMVXMEDH
.
          MOVE      SP70,PMVXSPAR
.
CLPV9999  RETURN
+
.------------------------------------------------------------
. CLMR0000 - Clear mrtvisaf defaults
.------------------------------------------------------------
.
CLMR0000  MOVE      SP70,MRMAS001
          MOVE      SP70,MRMAS002
          MOVE      SP70,MRMAS003
.
CLMR9999  RETURN
+
.------------------------------------------------------------
. CLSVHM00 - Clear SVHM save variables
.------------------------------------------------------------
.
CLSVHM00  MOVE      SP70,SVMASNAM
          MOVE      SP70,SVMAGNAM
          MOVE      SP70,SVMABDAT
          MOVE      SP70,SVMAPOST
          MOVE      SP70,SVMAPSEX
          MOVE      SP70,SVMAMSTA
          MOVE      SP70,SVMAPREG
          MOVE      SP70,SVMASUBB
          MOVE      SP70,SVMACONT
          MOVE      SP70,SVMAMEDI
          MOVE      SP70,SVMIADAT
          MOVE      SP70,SVMIATIM
          MOVE      SP70,SVMICLSS
          MOVE      SP70,SVMIACLM
          MOVE      SP70,SVMISRCE
          MOVE      SP70,SVMIBWHT
          MOVE      SP70,SVMICARE
          MOVE      ZERO,SVMIVIST
          MOVE      SP70,SVMIRFGP
          MOVE      SP70,SVVXMDAV
          MOVE      SP70,SVVXIRAD
          MOVE      SP70,SVVXCADM
          MOVE      SP70,SVVXIDUS
          MOVE      SP70,SVPXHOML
          MOVE      SP70,SVPXINTR
          MOVE      SP70,SVPXLNG1                                      *I-40489
          MOVE      SP70,SVPXABRG
.
CLSVHM99  RETURN
+
.------------------------------------------------------------
. SIPR0000 - From PATPRG31.
.         this routine checks the following....
.          - if we are storing the NMPI number in the UR field
.          - if we have a NMPI number (patient selected from nat. system)
.          - if the patient didnt previously have a UR
.            then write a UR record for the patient to IBA files
.                 and set up the NMPNUMB variable (done in GNXTUR)
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
.
SIPR0000  COMPARE   ONE,PTCNNZUR
          GOTO      SIPR9000 IF NOT EQUAL   * not storing NMPI in UR
.
          MATCH     SP20,NMPNUMB
          GOTO      SIPR9000 IF EQUAL       * no national number generated
.
          MATCH     ZEROUR,PURNO
          GOTO      SIPR9000 IF NOT EQUAL   * already had a UR number
.
.         have chosen a person from the national system
.         generate a UR and write to UR files
.
          MOVE      AADMNO,KEY8
          CALL      DEPRAM1                  * delete pram record if it exists
.
          CALL      VALP0000                * PRS2 validation for pmi
          BRANCH    EXIT,SIPR9100
.
          CALL      CHOS0000                * Check Hospitla for user
          BRANCH    EXIT,SIPR9100
.
          MOVE      THREE,CPSYSTEM           * Use inpatient range of U/R's
          CALL      GNXTUR                   * Get the next available U/R
          MOVE      PURNO,AURNO              * Save the U/R Number
.
          MOVE      ZERO,PSTAT
          MOVE      CHOSPNUM,PINITHOS        * Initiating Hospital Number
          MOVE      AADMNO,PVIBILL           * Parameter for WRTUR
.
          MOVE      THREE,PVITYPE            * Parameter for WRTUR
          MOVE      WBSEHOSP,PMPXIHOS
          MOVE      WBSEUID,PMPXWBID
          CALL      WRTUR                    * Post this new U/R Number
          BRANCH    EXIT,SIPR9100
          CALL      CRMED000                 * Create medical record
          CALL      WEXP0000                * Write expected payor details
.
          GOTO      SIPR9100
.
SIPR9000  MOVE      ZERO,EXIT
          GOTO      SIPR9999
.
SIPR9100  MOVE      ONE,EXIT
.
SIPR9999  RETURN
+
.-----------------------------------------------------------------------------
. UZDS0000 - Read and write to the double soundex surname file - From PATPRG31
.-----------------------------------------------------------------------------
.
UZDS0000  MOVE      PTMASNAM,GSRSNAM
          MOVE      PMPXFNAM,GSRGNAM
          MOVE      PMPXSNAM,PTGSGNM2
          MOVE      PBDATE,GSRDOB            * Date of birth
          MOVE      PSEX,GSRSEX              * Sex
          MOVE      ZEROUR,GSRURNO
          MOVE      AADMNO,GSRBILL
          MOVE      THREE,GSRSYS
.
          CALL      SOUNDEX                  * get soundex key for surname
          CALL      SOUNDX2                  * get soundex key for given names
.
          PACK      KEY115,GSRURNO,GSRBILL,GSRSNAM,GSRGNAM,PTGSGNM2,GSRDOB:
                           GSRSEX
          CALL      RAPTGSR1                 * check if its already there
          COMPARE   ONE,OVRCD
          GOTO      UZDS9999 IF NOT EQUAL
.
          CALL      WRPTGSR1
.
UZDS9999  RETURN
+
.------------------------------------------------------------
. Required by WEBEMCM2
.------------------------------------------------------------
.
ACTMSAV   CALL      AMSV0000
          RETURN
+
.------------------------------------------------------------
. AMSV0000 - Subroutine to save master variables - From PATPRG31
.------------------------------------------------------------
.
AMSV0000  MOVE      PMICRO,SPMICRO
          MOVE      PUSR1,SPUSR1
          MOVE      PUSR2,SPUSR2
          MOVE      PUSR3,SPUSR3
          MOVE      PUSR4,SPUSR4
          MOVE      PUSR5,SPUSR5
          MOVE      PUSR6,SPUSR6
          MOVE      PUYN1,SPUYN1
          MOVE      PUYN2,SPUYN2
          MOVE      PUYN3,SPUYN3
.
          MOVE      PURNO,SPURNO
          MOVE      PTITL,SPTITL
          MOVE      PSNAME,SPSNAME
          MOVE      PTMASNAM,SPTMASNM
          MOVE      PGNAME,SPGNAME
          MOVE      PMPXFNAM,SPMPXFNM
          MOVE      PMPXSNAM,SPMPXSNM
          MOVE      PPSNAME,SPPSNAME
          MOVE      PSMOK,SPSMOK
          MOVE      PSEX,SPSEX
          MOVE      PMSTAT,SPMSTAT
          MOVE      PBDATE,SPBDATE
          MOVE      PSAGE,SPSAGE
          MOVE      PCONT,SPCONT
          MOVE      PREG,SPREG
          MOVE      PTYPE,SPTYPE
          MOVE      POCCUP,SPOCCUP
          MOVE      PMEDI,SPMEDI
          MOVE      PPENNO,SPPENNO
          MOVE      PPNDTE,SPPNDTE
          MOVE      PREPAT,SPREPAT
          MOVE      PCHGDTE,SPCHGDTE
          MOVE      PLOCDOC,SPLOCDOC
          MOVE      PCEASE,SPCEASE
.
          MOVE      PNKNAME,SPNKNAME
          MOVE      PNKADD1,SPNKADD1
          MOVE      PNKADD2,SPNKADD2
          MOVE      PNKSUBR,SPNKSUBR
          MOVE      PNKADD4,SPNKADD4
          MOVE      PNKPOST,SPNKPOST
          MOVE      PNKTELP,SPNKTELP
          MOVE      PNKTELB,SPNKTELB
          MOVE      PNKRELP,SPNKRELP
.
          CALL      PRAV0000                * Person Responsible A/C variables
.
          MOVE      PADD1,SPADD1
          MOVE      PADD2,SPADD2
          MOVE      PSUBRB,SPSUBRB
          MOVE      PADD4,SPADD4
          MOVE      PPOST,SPPOST
          MOVE      PTELEP,SPTELEP
          MOVE      PTELEB,SPTELEB
          MOVE      PTMXCELL,SPCELL
          MOVE      PTMXDOFR,SPDOR
          MOVE      PMPXRHC1,SPREGP
          MOVE      PMPXRH1G,SPGPPC
          MOVE      PMPXR1GC,SPGPPT
          MOVE      PMPXRHC1,SAVEPHCP
          MOVE      PMPXRH1G,SAVEPRAC
          MOVE      PMPXR1GC,SAVEPCTR
          MOVE      PTMXOSMS,SPOSMS
.
          MOVE      PHIGH1,SPHIGH1
          MOVE      PHIGH2,SPHIGH2
          MOVE      PHIGH3,SPHIGH3
          MOVE      PAUTOPY,SPAUTOPY
          MOVE      PDECDTE,SPDECDTE
          MOVE      PYRRES,SPYRRES
.
.-------- Save Community Card Details ---------------------------------
.
          MOVE      PTMXCARD,SPCARD
          MOVE      PTMXCEXP,SPCEXP
          MOVE      PTMXCXMP,SPCXMP
          MOVE      PTMXFMLY,SPFMLY
.
AMSV9999  RETURN
+
.------------------------------------------------------------
. PRAV0000  : save person responsible for account variables
.------------------------------------------------------------
.
PRAV0000  MOVE      PKNAME,SPKNAME
          MOVE      PKADD1,SPKADD1
          MOVE      PKADD2,SPKADD2
          MOVE      PKSUBR,SPKSUBR
          MOVE      PKADD4,SPKADD4
          MOVE      PKPOST,SPKPOST
          MOVE      PKTELEP,SPKTELP
          MOVE      PKTELEB,SPKTELB
          MOVE      PKRELP,SPKRELP
          MOVE      PTREMOBL,SPKMOBL
.
PRAV9999  RETURN
+
.------------------------------------------------------------
. NCRD0000 - Restore new kiwi card details
.------------------------------------------------------------
.
NCRD0000  MOVE      PTVKCARD,PTMXCARD
          MOVE      PTVKCEXP,PTMXCEXP
          MOVE      PTVKCXMP,PTMXCXMP
          MOVE      PTVKFMLY,PTMXFMLY
.
NCRD9999  RETURN
+
.----------------------------------------------------------------------------
. OCRD0000 - Reload original kiwi card details
. (this is done as kiwi card details on the patient master file are not being
. updated at admission.)
.----------------------------------------------------------------------------
.
OCRD0000  MOVE      SAVKCARD,PTMXCARD
          MOVE      SAVKCEXP,PTMXCEXP
          MOVE      SAVKCXMP,PTMXCXMP
          MOVE      SAVKFMLY,PTMXFMLY
.
OCRD9999  RETURN
+
.------------------------------------------------------------
.                  PNZB0000
.        Maintain all the files for the NZ Billing Changes
.------------------------------------------------------------
.
PNZB0000  COMPARE   ONE,PTCNUCRD
          GOTO      PNZB9999 IF NOT EQUAL   * not using card information
.
          OPEN      PATVCHA1,"patvchaf"
          PACK      KEY5,CODECL,ACLAIM
          CALL      RDCODE1
          PACK      KEY5,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
          SCAN      ANSE,KEY5
          IF        !@EQUAL
            MOVE      SP3,PTMXCXMP          * should be no exemption code
          ENDIF
.
          MOVE      AADMNO,PTVKBILL         * visit number
          MOVE      PTVKBILL,KEY8           * key
          CALL      RDPTVKC1
          IF        OVRCD = ZERO
            MOVE      "2",FORM1             * before change audit
            CALL      AVKC0000              * write audit record
            MOVE      PTMXCARD,PTVKCARD     * card number
            MOVE      PTMXCEXP,PTVKCEXP     * card expiry date
            MOVE      PTMXCXMP,PTVKCXMP     * exemption code
            MOVE      PTMXFMLY,PTVKFMLY     * family id
            MOVE      ACLAIM,PTVKCOMP       * claim code
            CALL      UPPTVKC1              * update record
            MOVE      THREE,FORM1           * after change audit
            CALL      AVKC0000              * write audit record
          ELSE
            MOVE      PTMXCARD,PTVKCARD     * card number
            MOVE      PTMXCEXP,PTVKCEXP     * card expiry date
            MOVE      PTMXCXMP,PTVKCXMP     * exemption code
            MOVE      PTMXFMLY,PTVKFMLY     * family id
            MOVE      ACLAIM,PTVKCOMP       * claim code
            CALL      WRPTVKC1              * write record
            MOVE      ONE,FORM1             * add audit
            CALL      AVKC0000              * write audit record
          ENDIF
.
.         maintain PATKWCFD file
.
          COMPARE   ONE,ASTAT               * pre-admission ?
          GOTO      PNZB9999 IF NOT EQUAL   * no, don't update the file
.
          CALL      OPFI0000                * open correct file
          BRANCH    EXIT,PNZB0700           * file not there
.
          UNPACK    SP70,PTKWCARD,PTKWURNO  * initialize to blanks
.
          MATCH     SP20,PTVKCARD           * do we have a card number ?
          GOTO      PNZB0500 IF EQUAL       * no, special case
.
          CMATCH    ANSC,PTVKCARD           * valid card ?
          GOTO      PNZB0700 IF NOT EQUAL   * no.
.
          MOVE      PTVKCARD,PTKWCARD       * yes, set card number
          MOVE      SP8,PTKWURNO            * no U/R Number
          GOTO      PNZB0600
.
PNZB0500  MATCH     ZEROUR,AURNO            * do we have a U/R Number ?
          GOTO      PNZB0700 IF EQUAL       * no, don't post anything
.
          MOVE      SP20,PTKWCARD           * no card number
          MOVE      AURNO,PTKWURNO          * U/R Number
.
PNZB0600  PACK      KEY28,PTKWCARD,PTKWURNO
          CALL      RDPTKWC1                * read kiwicard file
          IF        OVRCD = ZERO
            MOVE      ADYHOSP,PTKWVISI      * set the value
            MOVE      PTMIPVIS,PTKWVISI     * set the value
            CALL      UPPTKWC1              * update value
          ELSE
            MOVE      ADYHOSP,PTKWDAYS      * number of days
            MOVE      PTMIPVIS,PTKWVISI     * number of visits
            MOVE      SP20,PTKWSPAR         * spare
            CALL      WRPTKWC1              * write new record
          ENDIF
.
.         see if to maintain the PATVCHFD file
.
PNZB0700  PACK      KEY28,PTKWCARD,PTKWURNO,SP70
          MATCH     KEY28,SP70
          GOTO      PNZB9999 IF EQUAL       * nothing to audit
.
          IF        ORIGDAYS <> ADYHOSP | ORIGVISI <> PTMIPVIS
            CALL      IBACLOCK
            MOVE      PTKWCARD,PTVCCARD     * card number
            MOVE      PTKWURNO,PTVCURNO     * event number
            PACK      PTVCDATE,CCC,CYY,CMM,CDD
            REP       " 0",PTVCDATE
            MOVE      CTIMEIS,PTVCTIME
            MOVE      PORT,PTVCPORT
            MOVE      CHOSINDX,PTVCHOSP
            MOVE      PASSCODE,PTVCOPER
            ASSIGN    (ADYHOSP-ORIGDAYS),PTVCDCHG  * amount days changed
            ASSIGN    (PTMIPVIS-ORIGVISI),PTVCVCHG * amount visits changed
.
            PACK      KEY48,PTVCCARD,PTVCURNO,PTVCDATE,PTVCTIME:
                            PTVCPORT,PTVCHOSP
            CALL      RAPTVCH1
            IF        OVRCD = 1
              CALL      WRPTVCH1
            ENDIF
          ENDIF
.
PNZB9999  CLOSE       PATVCHA1
          RETURN
+
.------------------------------------------------------------
. OPFI0000 : Open the appropriate kiwicard file
.------------------------------------------------------------
.
OPFI0000  PACK      XDATE,ADATE,SP8
          MATCH     SP8,XDATE                * check if we have a date
          IF        @EQUAL
            PACK      XDATE,CCC,CYY,CMM,CDD
            REP       "0 ",XDATE
          ENDIF
.
          UNPACK    XDATE,CCENT,CYEAR
          MATCH     PTCNBCUT,KEY4
          IF        ! @LESS
            MOVE      CYEAR,FORM2            * year of kiwicard
          ELSE
            MOVE      CYEAR,FORM2
            SUB       ONE,FORM2              * calculate start of kiwicard year
            IF        FORM2 < 0
              MOVE     "99",FORM2            * allow for the year 2000
            ENDIF
          ENDIF
.
          PACK      CFNAME,KWCFIL,FORM2      * name of kiwicard file
          REP       " 0",CFNAME
.
          MOVE      ZERO,OVRCD               * assume file exists
          TRAP      OVERCOND IF IO            * trap for error openning file
          OPEN      PATKWCA1,CFNAME           * open kiwicard file
          TRAPCLR   IO
          BRANCH    OVRCD,OPFI9100            * open failed
.
          MOVE      ZERO,EXIT
          GOTO      OPFI9999
.
OPFI9100  MOVE      ONE,EXIT
.
OPFI9999  RETURN
+
.------------------------------------------------------------
.                  AVKC0000
.        Write audit record for PATVKCFD
.------------------------------------------------------------
.
AVKC0000  BRANCH    PTCNVKCA,AVKC9999       * audits not on
.
          COMPARE   FIVE,FORM1
          GOTO      AVKC5000 IF EQUAL       * delete before change audit
.
          COMPARE   THREE,FORM1
          GOTO      AVKC1000 IF EQUAL       * after change audit
.
          PACK      PTVKAUDD,CCC,CYY,CMM,CDD
          REP       " 0",PTVKAUDD
          MOVE      CTIMEIS,PTVKAUDT
.
AVKC1000  MOVE      PORT,PTVKAUDP
          MOVE      FORM1,PTVKAUDR
          REP       "1A2B3C4D",PTVKAUDR
          MOVE      ONE,PTVKAUDS
          MOVE      PASSCODE,PTVKAUDO
.
          PACK      KEY19,PTVKAUDD,PTVKAUDT,PTVKAUDP,PTVKAUDR
          CALL      AWPTVKC
          GOTO      AVKC9999
.
.         delete before change audit
.
AVKC5000  MOVE      ANSB,PTVKAUDR
          PACK      KEY19,PTVKAUDD,PTVKAUDT,PTVKAUDP,PTVKAUDR
          CALL      ADPTVKC
.
AVKC9999  RETURN
+
.------------------------------------------------------------
. ADTD0000 - Update/Write Admission/Discharge Transfer
.            Destination file - From PATPRG31
.------------------------------------------------------------
.
ADTD0000  COMPARE   ONE,PTCNUADT              * Parameter turned on ?
          GOTO      ADTD9999 IF NOT EQUAL
.
          MOVE      TRNSFSRC,PTDAADTS         * move cgi param into file var
          MATCH     SP5,PTDAADTS              * Transfer Source = spaces ?
          GOTO      ADTD2000 IF NOT EQUAL     * no
.
          MOVE      AADMNO,KEY8               * yes
          CALL      RDPTDAD1                  * read PTDADFD record
          BRANCH    OVRCD,ADTD9999
.
          MATCH     SP5,PTDADCTS              * Dschg Transfer Source = spaces ?
          GOTO      ADTD1000 IF NOT EQUAL
.
          CALL      DEPTDAD1                  * delete a PTDADFD record
          MOVE      SP10,PTDAADTS
          MOVE      SP10,PTDADCTS
          GOTO      ADTD9999
.
ADTD1000  MOVE      SP5,PTDAADTS
          GOTO      ADTD3000
.
ADTD2000  MOVE      PTDAADTS,TFRSRCE          * save Transfer Source
.
          MOVE      AADMNO,KEY8
          CALL      RDPTDAD1                  * read PTDADFD record
          BRANCH    OVRCD,ADTD4000            * record not found
          MOVE      TFRSRCE,PTDAADTS          * set Trans Source = saved T/Srce
.
ADTD3000  CALL      UPPTDAD1                  * update PTDADFD record
          GOTO      ADTD9999
.
ADTD4000  MOVE      SP5,PTDADCTS
          MOVE      SP20,PTDASPAR
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          CALL      WRPTDAD1                  * write a PTDADFD record
          TRAPCLR   IO
.
ADTD9999  RETURN
+
.------------------------------------------------------------
. WASF0000 - Write admission SFA file stuff - From PATPRG31
.------------------------------------------------------------
.
WASF0000  COMPARE   NINE,PTCNHDPS           * ACT
          GOTO      WASF0070 IF EQUAL
          COMPARE   TWO,PTCNHDPS            * NSW
          GOTO      WASF0070 IF EQUAL
.
          COMPARE   FOUR,PTCNHDPS           * I SRF 22829
          GOTO      WASF0050 IF EQUAL       * Queensland
.
          COMPARE   THREE,PTCNHDPS
          GOTO      WASF0010 IF EQUAL       * Victoria
.
          COMPARE   SIX,PTCNHDPS
          IF        @EQUAL
            MATCH     "1",PTCNWAUC          * WA
            GOTO      WASF9000 IF NOT EQUAL
          ENDIF
.
WASF0010  PACK      KEY5,CODEA,ATYPE
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      "0",ANS
            MOVE      ZERO,FORM1
            UNPACK    THCSCOD,ANS
            UNPACK    THCSCOD,ANS2
            IF        PTCNHDPS=3
              REP       "C1S2H3R5E6P7B8F1",ANS
            ENDIF
            IF        PTCNHDPS=6
              MATCH     "10",ANS2
              IF        @EQUAL
                MOVE    ONE,ANS
              ELSE
                REP       "5191",ANS
              ENDIF
            ENDIF
            MOVE      ANS,PTAFCODE                            * Funding arrmnt
            MOVE      ANS,FORM1
            BRANCH    FORM1,WASF0075,WASF0075,WASF0075:
                            WASF1000,WASF0075,WASF0075:
                            WASF0075,WASF0075
.           GOTO      WASF1000            * remove the reord
.
            MATCH     "1",PTCNWAUC
            IF        @EQUAL
              IF        FORM1=ZERO
                GOTO      WASF0075
              ELSE
                GOTO      WASF1000
              ENDIF
            ELSE
              GOTO      WASF1000
            ENDIF
.
          ENDIF
          GOTO      WASF0075
.
WASF0050  MATCH     "S ",PTCNQCCT           * Using Cat S for contract details?
          GOTO      WASF0060 IF EQUAL       * yes
.
          PACK      KEY5,ANSC,ANSL,ACLAIM      * I SRF 22829
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      "0",ANS
            MOVE      ZERO,FORM1
            UNPACK    TCINDC9,ANS
            REP       "P1",ANS
            MOVE      ANS,FORM1
            BRANCH    FORM1,WASF0100      * valid contract
            GOTO      WASF1000            * remove the reord
          ENDIF                           * end I SRF 22829
.
          GOTO      WASF0100                * I CAR 42820
.
WASF0060  PACK      KEY5,ANSS,SP1,ASRCE
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      "0",ANS
            MOVE      ZERO,FORM1
            UNPACK    TCINDC8,ANS
            REP       "P1",ANS
            MOVE      ANS,FORM1
            BRANCH    FORM1,WASF0100      * valid contract
            GOTO      WASF1000            * remove the reord
          ENDIF                           * end I SRF 22829
.
          GOTO      WASF0100                * I CAR 42820
.
.         ACT
.
WASF0070  PACK      KEY5,ANSC,ANSL,ACLAIM      * I SRF 22829
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      SP70,ANS
            UNPACK    TCINDC21,ANS
            MATCH     "C",ANS
            GOTO      WASF0100 IF EQUAL
            GOTO      WASF1000            * remove the reord
          ENDIF
.
          GOTO      WASF0100
.
WASF0075  MATCH     "5",PTAFCODE
          GOTO      WASF0080 IF EQUAL
.
          MATCH     "6",PTAFCODE
          GOTO      WASF0080 IF EQUAL
.
          MATCH     "7",PTAFCODE
          GOTO      WASF0080 IF EQUAL
.
          MATCH     "8",PTAFCODE
          GOTO      WASF0080 IF EQUAL
.
          GOTO      WASF0100
.
WASF0080  PACK      PTAFCTYP,SP70
          PACK      PTAFCROL,SP70
          PACK      PTAFCSID,SP70
          GOTO      WASF0200                * end I CAR 42820
.
WASF0100  MATCH     SP1,PTAFCTYP
          GOTO      WASF0200 IF NOT EQUAL   * Blank contract type, delete record
.
          MATCH     SP1,PTAFCROL
          GOTO      WASF0200 IF NOT EQUAL   * Blank contract type, delete record
.
          COMPARE   FOUR,PTCNHDPS           * I SRF 22829
          GOTO      WASF0200 IF EQUAL       * Queensland
.
          MATCH     SP5,PTAFCSID
          GOTO      WASF1000 IF EQUAL
.
WASF0200  MOVE      AADMNO,PTAFADMN
          MOVE      "A",PTAFTYPE
          MOVE      SP8,PTAFDATE
          MOVE      SP8,PTAFTIME
          MOVE      SP70,PTAFSPAR
          PACK      KEY25,PTAFADMN,PTAFTYPE,PTAFDATE,PTAFTIME
          CALL      RAPTASF1                * Read an admin SFA file record
          IF        OVRCD=1
            CALL      WRPTASF1              * Write an admin SFA file record
          ELSE
            CALL      UPPTASF1              * Update an admin SFA file record
          ENDIF
          GOTO      WASF9000
.
WASF1000  PACK      KEY25,AADMNO,ANSA,SP70
          CALL      RDPTASF1                * Read an admin SFA file record
          IF        OVRCD=0
            PACK      KEY25,AADMNO,ANSA,PTAFDATE,PTAFTIME
            CALL      DEPTASF1              * Delete an admin SFA file record
          ENDIF
.
WASF9000  MOVE      ZERO,EXIT
.
WASF9999  RETURN
+
.------------------------------------------------------------------------
.  WRPR0000  :  Write the Person Responsible for Account Details for mta
.  Returns:   EXIT  0 = Ok to continue
.                   1 = Error
.------------------------------------------------------------------------
.
WRPR0000  PACK      KEY5,ANSC,ANSL,ACLAIM,SP10
          CALL      RDCODE1
          BRANCH    OVRCD,WRPR9100
.
          MATCH     "1",TCINDC1
          GOTO      WRPR2000 IF EQUAL
.
          MATCH     "4",TCINDC1
          GOTO      WRPR3000 IF NOT EQUAL
.
. patient is responsible for account
.
WRPR2000  MOVE      PTMASNAM,PACSNAMX
          MOVE      PGNAME,ANS
          PACK      PACGNAME,ANS,DOT
          MOVE      PTITL,PACTITLE
          MOVE      THREE,PACFRMT
          CALL      PACNAME
.
          MOVE      AADMNO,PKADMN
          MOVE      PACFNAMX,PKNAME
          MOVE      PADD1,PKADD1
          MOVE      PADD2,PKADD2
          MOVE      PSUBRB,PKSUBR
          MOVE      PADD4,PKADD4
          MOVE      PPOST,PKPOST
          MOVE      PTELEP,PKTELEP
          MOVE      PTELEB,PKTELEB
          MOVE      PTMXCELL,PTREMOBL
          MOVE      "SELF      ",PKRELP
.
          GOTO      WRPR7000
.
WRPR3000  MATCH     "2",TCINDC1
          GOTO      WRPR4000 IF EQUAL
.
          MATCH     "3",TCINDC1
          GOTO      WRPR9500 IF NOT EQUAL
.
. insurance company/ employer is responsible for account
.
WRPR4000  MOVE      AADMNO,PKADMN
          PACK      PKNAME,HFNAME,SP70,SP10
          MOVE      HFADD1,PKADD1
          MOVE      HFADD2,PKADD2
          MOVE      HFADD3,PKSUBR
          MOVE      HFADD4,PKADD4
          MOVE      HFPCODE,PKPOST
          MOVE      SP20,PKTELEP
          MOVE      HFTELE,PKTELEB
          MOVE      SP20,PTREMOBL
          MOVE      SP10,PKRELP
.
WRPR7000  PACK      KEY8,AADMNO,SP10
          CALL      RDARESP1
          IF        OVRCD=1
            CALL      WRRESP1
          ELSE
            CALL      UPRESP1
          ENDIF
.>>>>     CALL      TACC0000                   * send HL7 message
.
          GOTO      WRPR9500
.
WRPR9100  CLEAR     WEBTITLE
          APPEND    "Claim Code ",WEBTITLE
          APPEND    ACLAIM,WEBTITLE
          APPEND    " not found",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      WRPR9999
.
WRPR9500  MOVE      ZERO,EXIT
          GOTO      WRPR9999
.
WRPR9999  RETURN
+
.------------------------------------------------------------
.  PRAD0000  :  Write the Person Responsible for Account Details for RCH
.------------------------------------------------------------
.
PRAD0000  MOVE      ZERO,UPPRAFLG
          PACK      KEY8,AADMNO,SP10
          CALL      RDRESP1
          IF        OVRCD=1
            CALL      CLPATRE1         * Clear PRFA variables
          ELSE
            MATCH     SP70,PKNAME
            IF        @EQUAL
              MOVE      ONE,UPPRAFLG
            ENDIF
          ENDIF
.
          MATCH     SP70,ADMISNID    * coming from eAdmission?
          IF        !@EQUAL
            MATCH     Z70,PTPRA001  * has a value for PRFA name?
            IF        !@EQUAL
              CALL      UPDPRA00
              GOTO      PRAD7000
            ENDIF
          ENDIF
.
         MOVE       ACLAIM,KEY3      * Claim code
         CALL       PRFAINSR           * Copy Claim insurance details to PRFFA
         IF         OVRCD=0
           MOVE       AADMNO,PKADMN
           GOTO       PRAD7000
         ENDIF
.
          MATCH     "1",PTCNNEWC            * using new contacts ?
          IF        @EQUAL
            CALL      UPRF0000              * Get Contact for Usual PRFA
            BRANCH    EXIT,PRAD0250
            MOVE      AADMNO,PKADMN
            COMPARE   ZERO,EXIT
            GOTO      PRAD7000 IF EQUAL
            GOTO      PRAD9500              * No change to PRFA
          ENDIF
.
PRAD0250  MOVE      ZERO,F1
          MOVE      PMPXCONP,F1
          BRANCH    F1,PRAD1000,PRAD2000,PRAD3000,PRAD4000,PRAD5000,PRAD0500:
                       PRAD0500
.
. patient is responsible for account
.
PRAD0500  MOVE      PTMASNAM,PACSNAMX
          MOVE      PGNAME,ANS
          PACK      PACGNAME,ANS,DOT
          MOVE      PTITL,PACTITLE
          MOVE      THREE,PACFRMT
          CALL      PACNAME
.
          MOVE      AADMNO,PKADMN
          MOVE      PACFNAMX,PKNAME
          MOVE      "SELF      ",PKRELP
.
          COMPARE   ONE,PTCNPAOF              * Using 'Parent of' option?
          GOTO      PRAD0800 IF NOT EQUAL     * no
.
....      COMPARE   PSAGE,CAGECOFF            * Child?                *C-145752
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          CALL      CALCAGE                   * CALCAGE uses PBDATE
          COMPARE   PSAGEYRS,CAGECOFF         * Child?
          GOTO      PRAD0800 IF LESS          * No
.
          MOVE      SP1,ANS
          MOVE      PGNAME,ANS
          PACK      PKNAME,SP70,SP10
.         PACK      PKNAME,ATCHAR,SP1,ANS,DOT,PTMASNAM
.
          CLEAR     PKNAME
          APPEND    "Parent of ",PKNAME
          APPEND    ANS,PKNAME
          APPEND    DOT,PKNAME
          APPEND    SP1,PKNAME
          APPEND    PTMASNAM,PKNAME
          APPEND    SP70,PKNAME
          RESET     PKNAME
          MOVE      "Parent    ",PKRELP
.
PRAD0800  MOVE      ZERO,F1
          MOVE      PMPXCONP,F1
. *** using postal address? ***
          IF        F1=7
            MOVE      PTMXADD1,PKADD1
            MOVE      PTMXADD2,PKADD2
            MOVE      PTMXADD3,PKSUBR
            MOVE      PTMXADD4,PKADD4
            MOVE      PTMXPOST,PKPOST
            MOVE      PTELEP,PKTELEP
            MOVE      PTELEB,PKTELEB
            MOVE      PTMXCELL,PTREMOBL
            GOTO      PRAD7000
          ENDIF
.
          MOVE      PADD1,PKADD1
          MOVE      PADD2,PKADD2
          MOVE      PSUBRB,PKSUBR
          MOVE      PADD4,PKADD4
          MOVE      PPOST,PKPOST
          MOVE      PTELEP,PKTELEP
          MOVE      PTELEB,PKTELEB
          MOVE      PTMXCELL,PTREMOBL
.
          GOTO      PRAD7000
.
. contact 1 is responsible for account
.
PRAD1000  MOVE      AADMNO,PKADMN
          MOVE      PMPXMSNA,PACSNAMX
          MOVE      PMPXMGNA,ANS
          PACK      PACGNAME,ANS,DOT
          MOVE      PMPXMTLE,PACTITLE
          MOVE      THREE,PACFRMT
          CALL      PACNAME
.
          PACK      PKNAME,PACFNAMX,SP70,SP10
          MOVE      PMPXMAD1,PKADD1
          MOVE      PMPXMAD2,PKADD2
          MOVE      PMPXMAD3,PKSUBR
          MOVE      PMPXMAD4,PKADD4
          MOVE      PMPXMPOS,PKPOST
          MOVE      PMPXMPNO,PKTELEP
          MOVE      PMPXMBNO,PKTELEB
          MOVE      PMPXMREL,PKRELP
          MOVE      PMPXMMNO,PTREMOBL
.
          GOTO      PRAD7000
.
. contact 2 is responsible for account
.
PRAD2000  MOVE      AADMNO,PKADMN
          MOVE      PMPXFSNA,PACSNAMX
          MOVE      PMPXFGNA,ANS
          PACK      PACGNAME,ANS,DOT
          MOVE      PMPXFTLE,PACTITLE
          MOVE      THREE,PACFRMT
          CALL      PACNAME
.
          PACK      PKNAME,PACFNAMX,SP70,SP10
          MOVE      PMPXFAD1,PKADD1
          MOVE      PMPXFAD2,PKADD2
          MOVE      PMPXFAD3,PKSUBR
          MOVE      PMPXFAD4,PKADD4
          MOVE      PMPXFPOS,PKPOST
          MOVE      PMPXFPNO,PKTELEP
          MOVE      PMPXFBNO,PKTELEB
          MOVE      PMPXFREL,PKRELP
          MOVE      PMPXFMNO,PTREMOBL
.
          GOTO      PRAD7000
.
. contact 3 is responsible for account
.
PRAD3000  MOVE      AADMNO,PKADMN
          MOVE      PNKNAME,PKNAME
          MOVE      PNKADD1,PKADD1
          MOVE      PNKADD2,PKADD2
          MOVE      PNKSUBR,PKSUBR
          MOVE      PNKADD4,PKADD4
          MOVE      PNKPOST,PKPOST
          MOVE      PNKTELP,PKTELEP
          MOVE      PNKTELB,PKTELEB
          MOVE      PNKRELP,PKRELP
          MOVE      PMPXKMOB,PTREMOBL
.
          GOTO      PRAD7000
.
. contact 4 is responsible for account
.
PRAD4000  MOVE      AADMNO,PKADMN
          PACK      PKNAME,PTMXECNM,SP70,SP10
          MOVE      PTMXECA1,PKADD1
          MOVE      PTMXECA2,PKADD2
          MOVE      PTMXECA3,PKSUBR
          MOVE      PTMXECA4,PKADD4
          MOVE      PTMXECPC,PKPOST
          MOVE      PTMXECPP,PKTELEP
          MOVE      PTMXECBP,PKTELEB
          MOVE      PTMXECRE,PKRELP
          MOVE      PMPXCMOB,PTREMOBL
.
          GOTO      PRAD7000
.
. contact 5 is responsible for account
.
PRAD5000  MOVE      AADMNO,PKADMN
          PACK      PKNAME,PTMXNRNM,SP70,SP10
          MOVE      PTMXNRA1,PKADD1
          MOVE      PTMXNRA2,PKADD2
          MOVE      PTMXNRA3,PKSUBR
          MOVE      PTMXNRA4,PKADD4
          MOVE      PTMXNRPC,PKPOST
          MOVE      PTMXNRPP,PKTELEP
          MOVE      PTMXNRBP,PKTELEB
          MOVE      PTMXNRRE,PKRELP
          MOVE      PMPXRMOB,PTREMOBL
.
          GOTO      PRAD7000
.
PRAD7000  PACK      KEY8,AADMNO,SP10
          CALL      RDARESP1
          IF        OVRCD=1
            CALL      WRRESP1
          ELSE
            IF        UPPRAFLG=1
              CALL      UPRESP1
            ELSE
              GOTO      PRAD9500
            ENDIF
          ENDIF
.>>>>     CALL      TACC0000                   * send HL7 message
.
          CALL      UPRI0000         * Update private practice prfa
.
PRAD9500  MOVE      ZERO,EXIT
.
PRAD9999  RETURN
+
.------------------------------------------------------------
. UPRI0000 - Check for private practice, get the unique number
.------------------------------------------------------------
.
UPRI0000  OPEN      PRIHDBT1,"prihdbtf"
          OPEN      PRIHREF1,"prihreff"
.
          PACK      KEY27,URNUMBER,SP70       * Private Practice Holding Header
          CALL      RSPRHD1
          CALL      RKPRHD1
          BRANCH    OVRCD,UPRI9999
.
          MATCH     AURNO,PRHDDEBT
          GOTO      UPRI9999 IF NOT EQUAL      * no private practice
.
          PACK      KEY27,PRHDUNIQ,SP70
          CALL      RSPRHR1
UPRI2000  CALL      RKPRHR1
          BRANCH    OVRCD,UPRI9999
.
          COMPARE   PRHDUNIQ,PRHRUNIQ         * same unique number ?
          GOTO      UPRI9999 IF NOT EQUAL
.
          COMPARE   ONE,PRHRPINV
          GOTO      UPRI2000 IF NOT EQUAL     * invoice printed already
.
          MOVE      PKNAME,PRHRNAME
          MOVE      PKADD1,PRHRADD1
          MOVE      PKADD2,PRHRADD2
          MOVE      PKSUBR,PRHRADD3
          MOVE      PKPOST,PRHRPOST
          MOVE      PKTELEP,PRHRTELP
          MOVE      PKTELEB,PRHRTELB
          MOVE      PKRELP,PRHRRELP
....      MOVE      PTREMOBL,PRHRMOBL       * field required in PRIHREFD
          CALL      UPPRHR1
          GOTO      UPRI2000
.
UPRI9999  RETURN
+
.---------------------------------------------------------------------------
. CDST0000  :  Subroutine to update the Admission/Discharge statistics file
. Returns:    EXIT   0 = Ok to continue
.                    1 = Error
.---------------------------------------------------------------------------
.
CDST0000  COMPARE   ONE,ASTAT
          GOTO      CDST9000 IF EQUAL
.
          MATCH     ASRCE,SASRCE
          GOTO      CDST9000 IF EQUAL
.
          COMPARE   ONE,PTCNSTAU        * Return if using the new admission
          GOTO      CDST9000 IF EQUAL     and discharge stats report
.
. Only the Admission source may be changed after admission
. Admission date may only be changed in Operator Error Corrections
. Admission type may only be changed in Bed Transfer Maintenance
.
          PACK      CPTDATE,ADATE
          REP       " 0",CPTDATE
          CALL      GPERD
          BRANCH    EXIT,CDST9100
.
          MOVE      DRGYR,SADYEAR
          MOVE      DRGNUM,FORM2
.
          PACK      KEY8,SADYEAR,ANSB,SASRCE
          MATCH     SP3,SASRCE
          GOTO      CDST1000 IF NOT EQUAL
.
          PACK      KEY8,SADYEAR,ANSB,CODEUNK
CDST1000  CALL      RDSTAD1
          BRANCH    OVRCD,CDST4000
.
          MOVE      SEQ,COUNT
          CALL      UVST0000
          GOTO      CDST4000
.
CDST4000  PACK      KEY8,SADYEAR,ANSB,ASRCE
          MATCH     SP3,ASRCE
          GOTO      CDST4500 IF NOT EQUAL
.
          PACK      KEY8,SADYEAR,ANSB,CODEUNK
CDST4500  CALL      RDSTAD1
          BRANCH    OVRCD,CDST4800
.
          MOVE      ONE,COUNT
          CALL      UVST0000
          GOTO      CDST9000
.
CDST4800  MOVE      ANSB,SADTYPE
          MOVE      ASRCE,SADCODE
.
          MATCH     SP3,ASRCE
          GOTO      CDST5000 IF NOT EQUAL
          MOVE      CODEUNK,SADCODE
.
CDST5000  CALL      ANST0000
.
CDST9000  MOVE      ZERO,EXIT
          GOTO      CDST9999
.
CDST9100  UNPACK    CPTDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          CLEAR     WEBTITLE
          APPEND    CPCDATE,WEBTITLE
          APPEND    " not in Period File",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CDST9999
.
CDST9999  RETURN
+
.---------------------------------------------------------------------
.  ANST0000  :  Subroutine to add a new record to the Statistics file
.---------------------------------------------------------------------
.
ANST0000  MOVE      ZERO,SADMTH1
          MOVE      ZERO,SADMTH2
          MOVE      ZERO,SADMTH3
          MOVE      ZERO,SADMTH4
          MOVE      ZERO,SADMTH5
          MOVE      ZERO,SADMTH6
          MOVE      ZERO,SADMTH7
          MOVE      ZERO,SADMTH8
          MOVE      ZERO,SADMTH9
          MOVE      ZERO,SADMTH10
          MOVE      ZERO,SADMTH11
          MOVE      ZERO,SADMTH12
          MOVE      ZERO,SADMTH13
          MOVE      ONE,NADM
          STORE     NADM,FORM2,SADMTH1,SADMTH2,SADMTH3,SADMTH4,SADMTH5:
                               SADMTH6,SADMTH7,SADMTH8,SADMTH9,SADMTH10:
                               SADMTH11,SADMTH12,SADMTH13
          CALL      WRSTAD1
.
ANST9999  RETURN
+
.------------------------------------------------------------
. UVST0000 - Routine to update the approp. variable in the
.            stats file - From PATPRG31
.------------------------------------------------------------
.
UVST0000  LOAD      NADM,FORM2,SADMTH1,SADMTH2,SADMTH3,SADMTH4,SADMTH5:
                               SADMTH6,SADMTH7,SADMTH8,SADMTH9,SADMTH10:
                               SADMTH11,SADMTH12,SADMTH13
          ADD       COUNT,NADM
.
          STORE     NADM,FORM2,SADMTH1,SADMTH2,SADMTH3,SADMTH4,SADMTH5:
                               SADMTH6,SADMTH7,SADMTH8,SADMTH9,SADMTH10:
                               SADMTH11,SADMTH12,SADMTH13
          CALL      UPSTAD1
.
UVST9999  RETURN
+
.------------------------------------------------------------
.                          NEWS0000
.         maintenance of the double soundex surname file
.------------------------------------------------------------
.
NEWS0000  MOVE      PTMASNAM,GSRSNAM
          MOVE      PMPXFNAM,GSRGNAM
          MOVE      PMPXSNAM,PTGSGNM2
          MOVE      PBDATE,GSRDOB            * Date of birth
          MOVE      PSEX,GSRSEX              * Sex
          MOVE      PURNO,GSRURNO
          MOVE      ZEROVISN,GSRBILL
          MOVE      ZERO,GSRSYS
          CALL      SOUNDEX                  * get soundex key for surname
          CALL      SOUNDX2                  * get soundex key for given names
.
          PACK      KEY115,GSRURNO,GSRBILL,GSRSNAM,GSRGNAM,PTGSGNM2,GSRDOB:
                           GSRSEX
          CALL      RDPTGSR1                 * check if its already there
          IF        OVRCD = 1
            IF        SAVEALIA=1
              CALL      WRPTGSR1
              MOVE      "28",PMEWTYPE
              PACK      PMEWOLDV,SP70
              PACK      PMEWNEWV,SAVPSNAM,SP1,SAVPFGNM,SP1,SAVPSGNM,SP70
              CALL      WREDW000
            ENDIF
          ENDIF
.
NEWS9999  RETURN
+
.------------------------------------------------------------
. PMIA0000 - Update PMI Audit file - From PATPRG31
.------------------------------------------------------------
.
PMIA0000  COMPARE   ZERO,CHGUR
          GOTO      PMIA1000 IF EQUAL
.
          PACK      PUSR1,PUSR1,SP3
          MATCH     SP3,PUSR1
          IF        !@EQUAL
            MOVE      SP20,TDESC
            PACK      KEY5,ANSP,ONE,PUSR1
            CALL      RDCODE1
          ENDIF
.
PMIA1000  COMPARE   ONE,CPMIAD
          GOTO      PMIA9999 IF NOT EQUAL
.
          COMPARE   ZERO,CHGUR
          GOTO      PMIA9999 IF EQUAL
.
          PACK      URDATE,CCC,CYY,CMM,CDD
          REP       " 0",URDATE
          MOVE      PURNO,URURNO
          MOVE      THREE,URSYST
.
          BRANCH    CHGUR,PMIA3000
.
.        Insert mode
.
          MOVE      ANSA,URRTYPE
          MOVE      SP8,PCHGDTE
.
          PACK      KEY17,URRTYPE,URDATE,URURNO
          CALL      RDAURAD1
          IF        OVRCD=1
            CALL      WRURAD1
          ENDIF
          GOTO      PMIA9999
.
.        Change Mode
.
PMIA3000  MOVE      ANSC,URRTYPE
.
          OPEN      PATURAD2,"paturadf"
          PACK      KEY17,URURNO,URRTYPE,Z70
          MOVE      URDATE,PCHGDTE
.
.         See if a change record already exists.
.
          CALL      RDSURAD2                  * position on last record
          CALL      RDPURAD2                  * read last record
          BRANCH    OVRCD,PMIA5000
.
          MATCH     PURNO,URURNO
          GOTO      PMIA5000 IF NOT EQUAL
.
          MATCH     ANSC,URRTYPE
          GOTO      PMIA5000 IF NOT EQUAL
.
.         We have found the last change record. Update with latest information
.
          MOVE      PCHGDTE,URDATE
          MOVE      THREE,URSYST
.
          CALL      UPURAD2                  * update on 2nd index
.
          CLOSE     PATURAD2
          GOTO      PMIA9999
.
.         Write a change record. We repack the date of change because at the
.         moment the I/O include changes the value of URDATE on a read (whether
.         or not it is successful
.
PMIA5000  CLOSE     PATURAD2
          PACK      URDATE,CCC,CYY,CMM,CDD        * restore current details
          REP       " 0",URDATE
.
          MOVE      ANSC,URRTYPE
          MOVE      PURNO,URURNO
          MOVE      THREE,URSYST
.
          PACK      KEY17,URRTYPE,URDATE,URURNO
          CALL      RDURAD1
          BRANCH    OVRCD,PMIA7000
.
          GOTO      PMIA9999
.
PMIA7000  CALL      WRURAD1
.
PMIA9999  RETURN
+
.------------------------------------------------------------
. UMAS0000 - Update the master file record - From PATPRG31
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
.
UMAS0000  MOVE      PURNO,KEY8
          CALL      RDAMAST1
          BRANCH    OVRCD,UMAS9100
.
          CALL      UPMAST1
          CALL      UUPTMAS1
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TEN,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICUP                * send details to Datagate *C-90223
.
          MOVE      SPTMASNM,GSRSNAM
          MOVE      SPMPXFNM,GSRGNAM
          MOVE      SPMPXSNM,PTGSGNM2
          MOVE      PURNO,GSRURNO
          MOVE      ZEROVISN,GSRBILL
          MOVE      ZERO,GSRSYS
          CALL      SOUNDEX
.
          CALL      UPDSUR
          MOVE      ZERO,EXIT
          GOTO      UMAS9999
.
UMAS9100  MOVE      "U/R Number not on File",WEBTITLE
          CALL      ADMERR00
UMAS9900  MOVE      ONE,EXIT
.
UMAS9999  RETURN
+
.-------------------------------------------------------------------
.  STRNA000 - Set up transfer file record - From PATPRG31
.  Parameters:  TWARD and TBED, all other variables are set in here
.-------------------------------------------------------------------
.
STRNA000  MOVE      AURNO,TURNO
          MOVE      AADMNO,TADMN
          MOVE      ATIME,TTIME
          MOVE      ANSA,TMOVE
.
          UNPACK    ADATE,XCENT,XYEAR,XMON,XDAY
          PACK      TDATE,XCENT,XYEAR,XMON,XDAY
          REP       " 0",TDATE
          RESET     TDATE
.
          MOVE      SAVEND,TRBEND
          MOVE      ADDEND,PTTRAEND
          MOVE      ADISC,TDISC
          MOVE      ALWAMT,TALLW
          MOVE      HFPORT,TRATEH
          MOVE      MAXDISC,TRATEF
          MOVE      SAVEXTR,TEXTRA
          MOVE      AUSR2,TCHSTAT
.
          COMPARE   ZERO,CFEETYP
          GOTO      STRNA400 IF NOT EQUAL     * not using bed fees
.
. The following field is not used by Hospitals using bed fees
.
          MOVE      SP3,TCHSTAT
.
STRNA400  MOVE      ZERO,TRATEG
          MOVE      ATYPE,TATYPE
          MOVE      ADOCTA,TADOCT
          MOVE      ACLSSFT,TDEPT           * set up department
          MOVE      PMVXTEAM,PTTRTEAM       * team
          MOVE      PMVXEDC3,PTTRRSTR       * registrar
          MOVE      PMVXEDC2,PTTRRESI       * resident
          MOVE      SAVBTYP,TRBTYP
          MOVE      LUMPAT,PTTRLSPT          * lumpsum (patient)
          MOVE      LUMHF,PTTRLSRB           * lumpsum (rebate)
          MOVE      ADDPAT,PTTRADPT          * additional charge (patient)
          MOVE      ADDHF,PTTRADRB           * additional charge (rebate)
          MOVE      ZERO,PTTREPSD
.         IF        ADYHOSP<>0
.           MOVE      ONE,PTTREPSD
.         ENDIF
          MOVE      SP3,PTTRLTYP            * clear type of leave
          MOVE      ONE,PTTREPNO
          MOVE      PASSCODE,PTTROPER       * operator Id
          MOVE      PMVXCASE,PTTRCASE       * Case Team
          PACK      PTTRSPAR,SP70
.
.         Write Transfer File Record
.
          PACK      KEY30,TADMN,TDATE,TTIME,TWARD,TBED
          CALL      RDATRAN2
          IF        OVRCD=0
            PACK      TRCDATE,CCC,CYY,CMM,CDD
            REP       " 0",TRCDATE
            CLOCK     TIME,TRCTIME
            MOVE      WBSEUID,PTTRUUID
            CALL      UPTRAN2
          ELSE
            MOVE      ACLAIM,PTTRCLTY
            PACK      PTTRCDAT,CCC,CYY,CMM,CDD
            REP       " 0",PTTRCDAT
            CLOCK     TIME,PTTRCTIM
            MOVE      WBSEUID,PTTRUCID
            UNPACK    SP70,TRCDATE,TRCTIME,PTTRUUID
            CALL      WRTRAN2
.
            CALL      IPMCHA00 
          ENDIF
.
STRNA999  RETURN
.
.----------------------------------------------------------------------
. Insert new pmschaaf record
.----------------------------------------------------------------------
IPMCHA00  MATCH     "1",PTCNEIVS
          GOTO      IPMCHA99 IF NOT EQUAL
.
          MATCH     Z70,CHNGREAS
          GOTO      IPMCHA99 IF EQUAL          
.
          CALL      CLPMSCHA
.
          MOVE      AADMNO,PMCHADMN
          MOVE      TDATE,PMCHTDAT
          MOVE      TTIME,PMCHTTIM
          MOVE      TWARD,PMCHTWAR
          MOVE      TBED,PMCHTBED
          MOVE      PTTRCDAT,PMCHCDAT
          MOVE      PTTRCTIM,PMCHCTIM
          MOVE      "008",PMCHCTYP
          MOVE      CHNGREAS,PMCHREAS
          PACK      PMCHOVAL,SP70,SP70
          PACK      PMCHNVAL,SP70,SP70
          MOVE      PTTRUCID,PMCHWEBC
          MOVE      PTTRCDAT,PMCHDATC
          MOVE      PTTRCTIM,PMCHTIMC
.
          CALL      WRPMCHA1
.
IPMCHA99  RETURN
+
.----------------------------------------------------------------------
. CPAL0000 - Update the aliases with the new u/r number - From PATPRG31
.----------------------------------------------------------------------
.
CPAL0000  MOVE      AADMNO,GSRBILL
          MOVE      ZEROUR,GSRURNO
.
          PACK      KEY115,GSRURNO,GSRBILL,SP70,SP70
          CALL      RSPTGSR1
          CALL      RKPTGSR1
          BRANCH    OVRCD,CPAL9999
.
          MATCH     AADMNO,GSRBILL
          GOTO      CPAL9999 IF NOT EQUAL
.
          MOVE      PURNO,GSRURNO
          MOVE      ZEROVISN,GSRBILL
          CALL      UPPTGSR1
          GOTO      CPAL0000
.
CPAL9999  RETURN
+
.------------------------------------------------------------
. UPMI0000 - Update the PMI alterations file - From PATPRG31
.------------------------------------------------------------
.
UPMI0000  COMPARE   ZERO,PATRGPMI
          GOTO      UPMI0100 IF EQUAL
.
          PACK      PUSR1,PUSR1,SP3
          MATCH     SP3,PUSR1
          IF        !@EQUAL
            MOVE      SP20,TDESC
            PACK      KEY5,ANSP,ONE,PUSR1
            CALL      RDCODE1
          ENDIF

UPMI0100  BRANCH    CPMIAD,UPMI0200
          GOTO      UPMI0999
.
UPMI0200  COMPARE   ZERO,PATRGPMI
          GOTO      UPMI0999 IF EQUAL
.
          CALL      IBACLOCK
          PACK      URDATE,CCC,CYY,CMM,CDD
          REP       " 0",URDATE
.
          MOVE      PURNO,URURNO
          MOVE      THREE,URSYST
          MOVE      ANSC,URRTYPE
.
          PACK      KEY17,URRTYPE,URDATE,URURNO
          CALL      RDAURAD1
          BRANCH    OVRCD,UPMI0400
.
          CALL      UPURAD1
          MOVE      URDATE,PCHGDTE
          GOTO      UPMI0999
.
UPMI0400  PACK      KEY17,URRTYPE,URDATE,URURNO
          CALL      WRURAD1
          MOVE      URDATE,PCHGDTE
.
UPMI0999  RETURN
+
.------------------------------------------------------------
. ADMP0000 - Admit a Pre-Admission - From PATPRG31
. Returns:   EXIT  2 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
.
ADMP0000  MOVE      ZERO,NOBEDFLG
          CALL      GADM0000                * Get the admission number
          BRANCH    EXIT,ADMP9800
.
          CALL      GASF0000                * get admission SFA details
.
          CALL      VALDPO00                * Validate Post OP Ward Bed
          BRANCH    EXIT,ADMP9800
.
.
. if super insert admission, no need to call ISIN0000
.
          MATCH     "1",SUPINSAD
          IF        !@EQUAL
            CALL      ISIN0000              * Check if already in Hosp.
            BRANCH    EXIT,ADMP9800
          ENDIF
.
          CALL      UPDMIS00                * Move mis cgi params into vars
          CALL      UPDVIS00                * Move mis cgi params into vars
          BRANCH    EXIT,ADMP9500
          CALL      WASF0000                * Write admin SFA file stuff
.
          CALL      VDAT0000                * Validate date and time
          BRANCH    EXIT,ADMP9500
.
          CALL      RESCLM00                * Validate ClaimCode Vs Residence
          BRANCH    EXIT,ADMP9500
.
          CALL      NEWR0000                * Validate Pre-adm details
          BRANCH    EXIT,ADMP9500
.
          CALL      CMIXA000                * Check for casemix patient
          BRANCH    EXIT,ADMP9500
.
          CALL      VALX0000                * check claim code & exemption
          BRANCH    EXIT,ADMP9500           * No. Try again?
.
          CALL      GBED0000                * Validate the Ward/Bed
          BRANCH    EXIT,ADMP9500           * Invalid rate combination
.
.         Finish admitting the patient
.
          CALL      CELG0000                * Check for Eligibility
          PROC      ITMELGCK                * Check item from Elg.Check page
          CALL      WCSL0000                * write to Case Notes Loc file
          CALL      ADTD0000                * update Transfer Dest. file
          CALL      DOAD0000                * Update admission record
          BRANCH    EXIT,ADMP9500
.
          CALL      PRVS0000                * Check for Previous visit
          CALL      UPPHSP00                * Update Prev.hospitalisation
          CALL      CASR0000                * Check Adm.source and prev.dayhosp.
          CALL      CGTU0000                * Write to Unknown GST file if req.
          CALL      CKCLMD00                * Remove claim details if necessary
          CALL      ADMH0000                * Admit Mental Health patient
          IF        ASTAT<>1 & ASTAT<>5
            CALL      WIPG0000              * Write new program to patient
            PROC      WARPRG00            * Warning if program changes required
          ENDIF
          CALL      XADM0000                * Update extra Admission crap
          BRANCH    EXIT,ADMP9500
.
          CALL      BEDR0000                * Check ward/bed requests
.
          IF        ASTAT=2
            CALL      WNUT0000              * Nutrition record update
          ENDIF
.
          CALL      CPEXTC00
.
          CALL      FINA0000                * Finish admitting patient.
          BRANCH    EXIT,ADMP9500,ADMP8000
.
ADMP8000  CALL      PNMP0000                * post to National UR file
.
          MOVE      AADMNO,KEY8
          CALL      UUPTMIS1
          MOVE      AADMNO,ADMISSNO
.
.          MATCH     "1",PTCNUNET
.          IF        @EQUAL
.            MOVE      "01",KEY2                 * IHI Validation
.            PACK      KEY11,WBSEUID,SP70        * User ID
.            PACK      KEY50,URNUMBER,SP70
.            CALL      WIPL0000                  * Write to polling table
.          ENDIF
.
          MATCH     "1",AUTOMVMR  * Auto track (move) MR to admitting ward
          IF        @EQUAL
            CALL      MVMED000    * Move the medical record
          ENDIF
.
          BRANCH    BEDRFLAG,ADMP9000           * don't send bed request A08
.
.         Send an A08 message after completing a Bed Request if
.         "Send ZBR segment" parameter is turned on
.
          MATCH     "1",PTCNSZBR                 * sending ZBR ?
          GOTO      ADMP9000 IF NOT EQUAL        * no
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      SIX,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICAC                     * trigger A08 HL7 message
.
ADMP9000  MOVE      TWO,EXIT               * Finished with patient
          GOTO      ADMP9999
.
. Error admitting patient. Return a flag so the user can alter the admission
. details if they want
.
ADMP9500  CALL      OCRD0000                * reload original kiwi card details
          MOVE      AADMNO,KEY8
          CALL      UUPTMIS1
ADMP9800  MOVE      ONE,EXIT                * Try again
          GOTO      ADMP9999
.
ADMP9999  RETURN
+
.------------------------------------------------------------------------------
.         Move medical record to Admitting Ward on admission
.------------------------------------------------------------------------------
MVMED000  OPEN      CONTROLF,"controlf"
          READ      CONTROLF,SIXTY;*139,MRCNMOVP  * Pre-admission reason
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDMRVS1
          BRANCH    OVRCD,MVMED999
.
          PACK      KEY10,MRVSMKEY,SP70    * get current MR
          CALL      RDMRMAS2
          BRANCH    OVRCD,MVMED999
.
          PACK      KEY6,AWARD,SP70        * get new ward location
          CALL      RDWARD1
          BRANCH    OVRCD,MVMED999
.
          COMPARE   ONE,IBCNMHOS           * multi hospital ?
          GOTO      MVMED100 IF NOT EQUAL
.
          MATCH     MRMACHOS,PTWDHOSN
          GOTO      MVMED100 IF EQUAL
.
          GOTO      MVMED200
.
MVMED100  MATCH     MRMACLOC,PTWDLOCN      * Don't move if it's already in the
          GOTO      MVMED999 IF EQUAL      * destination location

MVMED200  MATCH     SP70,PTWDLOCN          * Location to move to not set up
          GOTO      MVMED999 IF EQUAL
.
          CALL      CLMRTHIS               * clear MRT History record
          MOVE      MRMAKEY,MRHIKEY        * move record
          CALL      IBACLOCK
          PACK      MRHIDATE,CCC,CYY,CMM,CDD  * movement date
          REP       " 0",MRHIDATE
          CLOCK     TIME,MRHITIME          * movement time
          IF        IBCNMHOS=1
            MOVE      PTWDHOSN,MRHIDHOS    * new hospital
          ELSE
            UNPACK    SP70,MRHIDHOS
          ENDIF
          MOVE      PTWDLOCN,MRHILOC       * new location
          MOVE      USERID,MRHIRECV        * requested by
          MOVE      WBSENAM,MRHIREQB       * requested by (free text)
          MOVE      MRCNMOVP,MRHIREAS      * reason
          MOVE      SP70,MRHIOPER          * operator
          CALL      CALDUE00               * calculate due date
          CALL      CALSTA00               * calculate status
.
          UNPACK    SP70,MRHIRCST,MRHIRCUI,MRHIRCDT,MRHIRCTM
.
          MATCH     "1",MRCNTREC            * System Using Tracking Receipt
          IF        @EQUAL
            MATCH     "1",MRLOTREC          * Location Using Tracking Receipt
            IF        @EQUAL
              MOVE      "1",MRHIRCST        * In Transit
            ELSE
              MOVE      "3",MRHIRCST        * Sent Direct
            ENDIF
          ENDIF
.
          MOVE      USERID,MRHIUSID        * userid
.
          PACK      KEY26,MRHIKEY,MRHIDATE,MRHITIME,SP70
          CALL      RAMRHIS1
          IF        OVRCD=1
            CALL      WRMRHIS1
          ENDIF
.
          MOVE      THIRTY2,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICRM       * Pass Med.Recs.Movement to DG
.
          PACK      KEY10,MRVSMKEY,SP70    * current location
          CALL      RDMRMAS2
          BRANCH    OVRCD,MVMED999
.
          IF        IBCNMHOS=1
            MOVE      PTWDHOSN,MRMACHOS    * new hospital
          ELSE
            UNPACK    SP70,MRMAHHOS,MRMACHOS,MRMAOHOS
          ENDIF
          MOVE      PTWDLOCN,MRMACLOC      * new location
          CALL      IBACLOCK
          PACK      MRMADTUP,CCC,CYY,CMM,CDD
          REP       " 0",MRMADTUP
          MOVE      CTIMEIS,MRMATMUP
          MOVE      WBSEUID,MRMAUUID
          CALL      UPMRMAS2
.
MVMED999  RETURN
+
.------------------------------------------------------------
. ISIN0000 - Check if already in Hosp.
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
.
ISIN0000  BRANCH    STATDISC,ISIN9050   ***** allow stat discharges to overlap
.                                       ***** future visits CAR 285046
          IF        CONTMULT=1
            MOVE      AADMNO,SAVADMNO         * Save the admission number
            MOVE      PTMIS001,SAVADATE          * Save the admission date
            MOVE      PTMIS002,SAVATIME          * Save the admission date
            GOTO      ISIN0900             * allow multiple admissions if
          ENDIF                            * override was selected at admission
.
          MATCH     ZEROVISN,AADMNO
          GOTO      ISIN0100 IF EQUAL
.
          MOVE      AADMNO,KEY8
          CALL      RDMISS1
          MATCH     ZEROUR,AURNO            * U/R No. = 0?
          GOTO      ISIN9050 IF EQUAL       * Yes
.
          MOVE      AURNO,PURNO
          MOVE      PURNO,PVIURNO
          MOVE      AADMNO,SAVADMNO         * Save the admission number
ISIN0100  MOVE      PTMIS001,SAVADATE          * Save the admission date
          MOVE      PTMIS002,SAVATIME          * Save the admission date
.
          PACK      KEY17,PURNO,TWO,SP20
          CALL      RSPTMI18
ISIN0500  CALL      RKPTMI18
          BRANCH    OVRCD,ISIN0900          * no current admission
.
          MATCH     PURNO,AURNO             * same U/R Number?
          GOTO      ISIN0900 IF NOT EQUAL   * No
.
          COMPARE   TWO,ASTAT
          GOTO      ISIN9100 IF EQUAL
.
          PACK      KEY17,PURNO,FOUR,SP70
          CALL      RSPTMI18
          CALL      RKPTMI18
          BRANCH    OVRCD,ISIN0900          * not on file
.
          MATCH     PURNO,AURNO             * same U/R Number?
          GOTO      ISIN0900 IF NOT EQUAL   * No
.
          COMPARE   FOUR,ASTAT
          GOTO      ISIN9100 IF EQUAL
.
ISIN0900  CALL      IBACLOCK
          PACK      XDATE,CCC,CYY,CMM,CDD
          REP       " 0",XDATE
.
          IF        RECURRFL=1
            PACK      XDATE,PTMIS001
          ENDIF
.
          PACK      KEY24,PURNO,XDATE,Z70
          CALL      RDSVISA2
ISIN1000  CALL      RDPVISA2
          BRANCH    OVRCD,ISIN9000          * Not on file
.
          MATCH     PURNO,PVIURNO           * same U/R
          GOTO      ISIN9000 IF NOT EQUAL   * No
.
          MATCH     SAVADMNO,DPVIBILL
          GOTO      ISIN1000 IF EQUAL
.
          MOVE      PVIBILL,AADMNO
          MOVE      AADMNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,ISIN1000          * ignore
.
          IF        CONTMULT=1
            BRANCH    ASTAT,ISIN1000,ISIN1000,ISIN8000,ISIN1000,ISIN1000
          ELSE
            BRANCH    ASTAT,ISIN1000,ISIN9100,ISIN8000,ISIN9100,ISIN1000
          ENDIF
          GOTO      ISIN1000
.
ISIN8000  MOVE      AADMNO,KEY8
          CALL      RDDSCH1
          BRANCH    OVRCD,ISIN1000
.
          MATCH     SAVADATE,DDATE
          GOTO      ISIN9000 IF LESS
          GOTO      ISIN9300 IF NOT EQUAL
.
          MATCH     SAVATIME,DTIME
          GOTO      ISIN9000 IF LESS
          GOTO      ISIN9300 IF EQUAL
          GOTO      ISIN9300 IF NOT EQUAL
.
ISIN9000  MOVE      SAVADMNO,KEY8
          CALL      RDMISS1
.
ISIN9050  MOVE      ZERO,EXIT               * Patient is not in Hospital
          GOTO      ISIN9999
.
ISIN9100  CLEAR     WEBTITLE
          APPEND    "Patient Already in Hospital Under Adm. ",WEBTITLE
          APPEND    AADMNO,WEBTITLE
          RESET     WEBTITLE
          CALL      ADMERR00
          MOVE      ONE,EXIT
          GOTO      ISIN9999
.
ISIN9300  CLEAR     WEBTITLE
          APPEND    "Admission Date/Time Cannot Overlap",WEBTITLE
          APPEND    " Discharge Date/Time",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ISIN9999
.
ISIN9999  RETURN
+
.------------------------------------------------------------
. VDAT0000 - Validate Admission date and time - From PATPRG31
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
.
VDAT0000  MOVE      ATIME,A5TIME                  * save time
          MATCH     SP70,ACLAIM
          GOTO      VDAT1000 IF EQUAL
.
          PACK      KEY5,ANSC,ANSL,ACLAIM,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,VDAT9300
.
          MATCH     ANSI,PTCOACTV
          GOTO      VDAT9300 IF EQUAL
.
.
.         ADATE and ATIME must be less than current date and time
.
VDAT1000  CALL      IBACLOCK
          PACK      XDATE,CCC,CYY,CMM,CDD
          REP       " 0",XDATE
.
          MATCH     XDATE,ADATE
          GOTO      VDAT7000 IF EQUAL
          GOTO      VDAT9000 IF LESS
.
          GOTO      VDAT9200
.
VDAT7000  CLOCK     TIME,DATIME
          MATCH     A5TIME,DATIME
          GOTO      VDAT9100 IF LESS
.
VDAT9000  MOVE      ZERO,EXIT                     * Date and time are Ok.
          GOTO      VDAT9999
.
VDAT9100  MOVE      "Patient Cannot be Admitted Ahead of Today's Time.",WEBTITLE
          CALL      ADMERR00
          MOVE      ONE,EXIT
          GOTO      VDAT9999
.
VDAT9200  MOVE      "Patient Cannot be Admitted Ahead of Today's Date.",WEBTITLE
          CALL      ADMERR00
          MOVE      ONE,EXIT
          GOTO      VDAT9999
.
VDAT9300  MOVE      "Invalid Claim Code.",WEBTITLE
          CALL      ADMERR00
          MOVE      ONE,EXIT
          GOTO      VDAT9999
.
VDAT9999  RETURN
+
.------------------------------------------------------------
. CMIXA000 - Check for casemix patient - From PATPRG31
. Casemix funding is only for private hospital using bed fees file
. Returns:    EXIT  0 = Ok to continue
.                   1 = Error
.------------------------------------------------------------
.
CMIXA000  COMPARE   ZERO,CFEETYP
          GOTO      CMIXA900 IF NOT EQUAL    * not bed fees
          PACK      CMCODE,PTMIPCMX,SP70
.
          COMPARE   ZERO,PTCNCMXF          * Dont check for casemix code
          GOTO      CMIXA900 IF EQUAL
.
          MATCH     ANSY,PTMICMXP
          GOTO      CMIXA050 IF NOT EQUAL    * not casemix
.
.         A casemix admission type, check for the casemix code
.
          MATCH     SP9,PTMIPCMX
          GOTO      CMIXA910 IF EQUAL       * Error
          GOTO      CMIXA100
.
CMIXA050  MATCH     SP9,PTMIPCMX
          GOTO      CMIXA100 IF NOT EQUAL
.
          PACK      KEY14,AFUNDH,ZERO8
          CALL      RDFUND1
          BRANCH    OVRCD,CMIXA100
.
          COMPARE   ONE,PTHFUCMX           * Use matrix
          GOTO      CMIXA100 IF EQUAL
.
          OPEN      PATCFAA1,"patcfaaf"
          MOVE      ACLAIM,KEY3
          CALL      RDPTCFA1
          IF        OVRCD=0
            MATCH     "3",PTCFCEFR            * Not in use?
            IF        !@EQUAL
              MATCH     "1",PTCFMCPS
              GOTO      CMIXA100 IF EQUAL     * Using matrix
            ENDIF
          ENDIF
          GOTO      CMIXA900
.
.         Check if patient was admitted after the casemix funding specified date
.
CMIXA100  MOVE      "9999",BDAY        * Assume it's an overnight patient
.
          MATCH     ANSY,PTMICMXP
          GOTO      CMIXA900 IF NOT EQUAL  * not a casemix
.
          PACK      KEY9,ACLAIM,AFUNDH
          CALL      GETCNEFF               * Get Contract Effective From
          BRANCH    EXIT,CMIXA930
.
          PACK      CMCODE,PTMIPCMX,SP70
          PACK      KEY18,ACLAIM,AFUNDH,CMCODE,SP70
          MOVE      ADATE,CEFFDATE
          LOAD      CEFFDATE,CNTRCEFR,ADATE,DDATE
          CALL      VALCMXFN              * get the contract ID (CONTRCID)
          BRANCH    EXIT,CMIXA930
.
          MOVE      SP3,SAVBTYP
          MOVE      "9999",BDAY        * Assume it's an overnight patient
          PACK      CMDRG,PTMIPCMX,SP20   * Set casemix code
          MOVE      ONE,ADMFLAG        * Set one to admission flag
          MOVE      ONE,MSGFLAG        * no to display error message
          PROC      PATGNCMX           * to generate casemix funding
          IF        NOFEE = 1
            GOTO      CMIXA950              * Error
          ENDIF
.
CMIXA900  MOVE      ZERO,EXIT
          GOTO      CMIXA999
.
CMIXA910  CLEAR     WEBTITLE
          APPEND    "Casemix code is not entered for",WEBTITLE
          APPEND    " Casemix Funding patient.",WEBTITLE
          CALL      ADMERR00
          MOVE      ONE,EXIT
          GOTO      CMIXA999
.
CMIXA930  MOVE      "Patient will not be funded by Casemix Funding. ",WEBTITLE
          CALL      ADMERR00
          MOVE      ONE,EXIT
          GOTO      CMIXA999
.
CMIXA950  MOVE      "Rates not setup for Casemix Funding Patient.",WEBTITLE
          CALL      ADMERR00
          MOVE      ONE,EXIT
.
CMIXA999  RETURN
+
.---------------------------------------------------------------------
. VALX0000 - Do extra validation on the claim code and check if there
. should be an exemption code
. Returns:    EXIT  0 = Ok to continue
.                   1 = Error
.---------------------------------------------------------------------
.
VALX0000  COMPARE   ONE,PTCNUCRD
          GOTO      VALX9000 IF NOT EQUAL   * not using card details
.
          PACK      KEY5,CODECL,SP3
          CALL      RDCODE1
          MOVE      TDESC,DIM20
          STRIP     DIM20
.
          PACK      KEY5,CODECL,ACLAIM
          CALL      RDCODE1
          PACK      DETNFILE,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
          MOVE      PTVKCARD,ANS
.
. ******* check a: if card type = G or H, claim code must be an exemption
.
          MATCH     ANSG,ANS
          GOTO      VALX1000 IF EQUAL
          MATCH     ANSH,ANS
          GOTO      VALX2000 IF NOT EQUAL
.
. ------- claim code must be an exemption -------
.
VALX1000  SCAN      ANSE,DETNFILE
          GOTO      VALX5000 IF EQUAL       * an exemption code
          GOTO      VALX9100                * Error
.
.         check b: if a non-resident, claim code must have an indicator "I"
.
VALX2000  COMPARE   ONE,PTCNNHII
          GOTO      VALX2500 IF NOT EQUAL
.
          OPEN      NHIMASA2,"nhimasaf"
          MOVE      PURNO,KEY8
          CALL      RDNHMAS2
          BRANCH    OVRCD,VALX2500
.
          MATCH     ANSY,NHMARES
          GOTO      VALX2100 IF EQUAL       * Resident
          RESET     DETNFILE                * Non-Resident must claim code
          SCAN      ANSI,DETNFILE           * "I" for an indicator
          GOTO      VALX5000 IF EQUAL       * valid code
          GOTO      VALX9200                * Error
.
VALX2100  RESET     DETNFILE
          SCAN      ANSI,DETNFILE
          GOTO      VALX4000 IF NOT EQUAL   * doesn't have an "I"
          GOTO      VALX9300                * Error
.
VALX2500  PACK      KEY5,CODET,PTYPE
          CALL      RDCODE1
          BRANCH    OVRCD,VALX3000          * invalid resident status
.
          MATCH     "2",TCINDC1
          GOTO      VALX3000 IF NOT EQUAL   * not a non-resident
.
. ------- claim code must have an "I" for an indicator -------
.
          SCAN      ANSI,DETNFILE
          GOTO      VALX5000 IF EQUAL       * valid code
.
          PACK      KEY5,CODET,SP3
          CALL      RDCODE1
          STRIP     TDESC
          GOTO      VALX9400                * Error
.
.         check c: if claim code has an indicator "I", must be a non-resident
.
VALX3000  SCAN      ANSI,DETNFILE
          GOTO      VALX4000 IF NOT EQUAL   * doesn't have an "I"
.
. ------- patient must be a non-resident -------
.
          PACK      KEY5,CODET,PTYPE
          CALL      RDCODE1
          BRANCH    OVRCD,VALX9500          * invalid resident status
.
          MATCH     "2",TCINDC1
          GOTO      VALX5000 IF EQUAL       * is a non-resident
          PACK      KEY5,CODET,SP3
          CALL      RDCODE1
          STRIP     TDESC
          GOTO      VALX9600

.         check d: ((if card number is blank) and (claim code <> PTCNDCLM) and
.                   (claim code is not an exemption) and (patient is non-res))
.         ie. if they don't have a card number, they must be chargeable
.             or exempt or a non-resident
.
VALX4000  MATCH     SP20,PTVKCARD
          GOTO      VALX5000 IF NOT EQUAL   * have a card number
.
          SCAN      ANSD,DETNFILE
          GOTO      VALX5000 IF EQUAL       * they are chargeable
.
          SCAN      ANSE,DETNFILE
          GOTO      VALX5000 IF EQUAL       * an exemption
.
          SCAN      ANSI,DETNFILE
          GOTO      VALX5000 IF EQUAL       * non-resident
.
          PACK      KEY5,CODET,SP3
          CALL      RDCODE1
          STRIP     TDESC
.
.         do checks to see if they should have an exemption code
.
VALX5000  MATCH     SP3,ACLAIM
          GOTO      VALX9000 IF EQUAL       * don't have to check it
.
          PACK      KEY5,CODECL,ACLAIM
          CALL      RDCODE1
          BRANCH    OVRCD,VALX9000          * invalid code
.
          PACK      KEY5,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
          SCAN      ANSE,KEY5
          GOTO      VALX9000 IF NOT EQUAL   * no exemption code needed
.
          SCAN      ANSY,KEY5
          GOTO      VALX9000 IF EQUAL       * no exemption code needed
.
.         there should be an exemption code
.
          MATCH     SP3,PTVKCXMP
          GOTO      VALX9000 IF NOT EQUAL   * they have an exemption code
.
          PACK      KEY5,CODEXM,SP3
          CALL      RDCODE1
          STRIP     TDESC
          GOTO      VALX9700
.
.         set exit flags
.
VALX9000  MOVE      ZERO,EXIT               * continue
          GOTO      VALX9999
.
VALX9100  CLEAR     WEBTITLE
          APPEND    DIM20,WEBTITLE
          APPEND    " Must be an Exemption Code",WEBTITLE
          RESET     WEBTITLE
          CALL      ADMERR00
          MOVE      ONE,EXIT                * do not continue
          GOTO      VALX9999
.
VALX9200  CLEAR     WEBTITLE
          APPEND    DIM20,WEBTITLE
          APPEND    " is not valid for NHI Resident Status Y",WEBTITLE
          RESET     WEBTITLE
          CALL      ADMERR00
          MOVE      ONE,EXIT
          GOTO      VALX9999
.
VALX9300  CLEAR     WEBTITLE
          APPEND    "NHI Resident Status N is not valid for ",WEBTITLE
          APPEND    DIM20,WEBTITLE
          RESET     WEBTITLE
          CALL      ADMERR00
          MOVE      ONE,EXIT
          GOTO      VALX9999
.
VALX9400  CLEAR     WEBTITLE
          APPEND    DIM20,WEBTITLE
          APPEND    " is Not Valid for ",WEBTITLE
          APPEND    TDESC,WEBTITLE
          RESET     WEBTITLE
          CALL      ADMERR00
          MOVE      ONE,EXIT
          GOTO      VALX9999
.
VALX9500  MOVE      "Invalid Resident Status",WEBTITLE
          CALL      ADMERR00
          MOVE      ONE,EXIT
          GOTO      VALX9999
.
VALX9600  CLEAR     WEBTITLE
          APPEND    TDESC,WEBTITLE
          APPEND    " is Not Valid for ",WEBTITLE
          APPEND    DIM20,WEBTITLE
          RESET     WEBTITLE
          CALL      ADMERR00
          MOVE      ONE,EXIT
          GOTO      VALX9999
.
VALX9700  CLEAR     WEBTITLE
          APPEND    "Patient Must have an ",WEBTITLE
          APPEND    TDESC,WEBTITLE
          RESET     WEBTITLE
          CALL      ADMERR00
          MOVE      ONE,EXIT
          GOTO      VALX9999
.
VALX9999  RETURN
+
.------------------------------------------------------------
. GBED0000 - Validate for the Ward/Bed - From PATPRG31
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
.
GBED0000  PACK      AWARD,PTMIS004,SP70
          PACK      ABED,PTMIS005,SP70
.
          MOVE      SP3,SAVBTYP
          IF        PTCNDBWB = 1
            PACK      KEY8,AADMNO
            CALL      RDBKREC1
            BRANCH    OVRCD,GBED1100
.
            MOVE      BKREWARD,AWARD
            MOVE      BKREEBED,ABED
          ENDIF
.
.         validate the Ward keyed in against the Ward file
.
GBED1100  PACK      KEY6,AWARD,SP3
          CALL      RDWARD1
          BRANCH    OVRCD,GBED9800                * Ward doesn't exist
.
          BRANCH    WACTIVE,GBED9810              * Ignore non-active wards
.
          CALL      CWCL0000                      * Check ward specialty
.
          IF        WINPUT=1
            MOVE      SP3,ABED                    * Ward only input, clear bed
            GOTO      GBED1500
          ENDIF
          IF        WINPUT=2
            MATCH     SP3,ABED
            GOTO      GBED1500 IF EQUAL
          ENDIF
.
. validate the Ward and Bed keyed in against the Ward file
.
          PACK      KEY6,AWARD,ABED
          CALL      RDWARD1
          BRANCH    OVRCD,GBED9800
.
          BRANCH    WACTIVE,GBED9820              * Ignore non-active wards
          IF        WINPUT=0
            PACK      ABED,ABED,SP70
            MATCH     SP70,ABED                   * Invalid Bed
            GOTO      GBED9840 IF EQUAL
          ENDIF
.
GBED1500  COMPARE   ZERO,CLUNTNO                  * Using Clinic Unit No.?
          GOTO      GBED2000 IF EQUAL             * No.
.
GBED2000  CALL      CWSX0000                      * Check intended patient sex
.
          MOVE      WEFRBT,SAVBTYP
          MOVE      AWARD,NWARD
          MOVE      ABED,NBED
          MOVE      SP3,AWARD
          MOVE      SP3,ABED                      * Just in case DATAB is called
.
          MOVE      ZERO,LUMPAT        * lumpsum (patient)
          MOVE      ZERO,LUMHF         * lumpsum (rebate)
          MOVE      ZERO,ADDPAT        * additional charge (patient)
          MOVE      ZERO,ADDHF         * additional charge (rebate)
.
          COMPARE   ZERO,CFEETYP
          GOTO      GBED2400 IF NOT EQUAL    * not bed fees
.
          MOVE      "9999",BDAY        * Assume it's an overnight patient
          PACK      CMDRG,PTMIPCMX,SP20   * Set casemix code
.
.         Check if this hfund using matrix
.
          PACK      KEY14,AFUNDH,ZERO8
          CALL      RDFUND1
          IF        OVRCD=0
            IF        PTHFUCMX=1 & STATDISC <>1
. Ignore health fund case patment for stat discharge 
              MOVE      ANSY,PTMICMXP  * set this patient to use casemix
            ENDIF
          ENDIF
.
          MATCH     ANSY,PTMICMXP
          GOTO      GBED2400 IF NOT EQUAL  * not a casemix
.
          PACK      KEY9,ACLAIM,AFUNDH
          CALL      GETCNEFF               * Get Contract Effective From
          BRANCH    EXIT,GBED2400
.
          PACK      PTMIPCMX,CMCODE,SP70
          PACK      KEY18,ACLAIM,AFUNDH,CMCODE,SP70
          MOVE      ADATE,CEFFDATE
          LOAD      CEFFDATE,CNTRCEFR,ADATE,DDATE
          CALL      VALCMXFN              * get the contract ID (CONTRCID)
          BRANCH    EXIT,GBED2400
.
          MOVE      ONE,ADMFLAG        * Set one to admission flag
          MOVE      ONE,MSGFLAG       * display error message
          PROC      PATGNCMX           * to generate casemix funding
          BRANCH    NOFEE,GBED2400     * Use normal charges
.
          MOVE      DAYEND,SAVEND      * ending day for daily rate
          MOVE      DAYPAT,MAXDISC     * use for transfer file
          MOVE      DAYHF,HFPORT
          GOTO      GBED3000
.
. check the Bed rate
.
GBED2400  CALL      BRAT0000
          BRANCH    CFEETYP,GBED2500,GBED3000,GBED3000
.
. Private hospital
.
          BRANCH    NOFEE,GBED9100                * Fatal Error. Exit
          BRANCH    OVRCD,GBED9100                * Fatal Error. Exit
          GOTO      GBED3000
.
. Public Hospital
.
GBED2500  BRANCH    NOFEE,GBED9850                * Fatal Error. Try again
          BRANCH    OVRCD,GBED9850                * Fatal Error. Try again
.
GBED3000  MOVE      NWARD,AWARD
          MOVE      NBED,ABED
.
          MATCH     SP3,ABED                      * Does Ward have Beds in it?
          GOTO      GBED4000 IF NOT EQUAL
.
. This is a Ward only bed - put into the PATNOBE file
.
          MOVE      APLUR,NBPLUR
          MOVE      SP3,NBROOM
          PACK      KEY13,AWARD,AADMNO,NBPLUR
          CALL      RDNOBE1
          IF        OVRCD=1
            MOVE      ONE,NOBEDFLG
          ENDIF
.
          PACK      KEY6,AWARD,ABED
          CALL      RDWARD1                       * Get description again
          GOTO      GBED9000
.
. Put the patient into this bed
.
GBED4000  PACK      KEY6,AWARD,ABED
          CALL      RDWARD1
.
          MATCH     ZEROVISN,WADMNO               * has bed been taken?
          GOTO      GBED5000 IF NOT EQUAL         * Yes.
.
. Bed has not been taken by anyone
.
          MOVE      AADMNO,WADMNO
          MOVE      APLUR,WPLUR
          CALL      UPWARD1
          GOTO      GBED9000
.
. Put Patient on standby if bed doesn't already have a patient on standby
.
GBED5000  MATCH     ZEROVISN,WSTBY                * another pat. on standby?
          GOTO      GBED7000 IF EQUAL             * No.
          GOTO      GBED9830                      * invalid Ward/Bed
.
. Put the Patient on Stand-by
.
GBED7000  MATCH     AADMNO,WADMNO                 * Patient already in bed?
          GOTO      GBED9831 IF EQUAL
.
          MOVE      AADMNO,WSTBY
          CALL      UPWARD1
.
          BRANCH    DISERROR,GBED8000
          BRANCH    NOMESSAG,GBED8000
          CLEAR     WEBTITLE
          MOVE      "This Patient is Now Placed on Standby",WEBTITLE
          ADD       ONE,WARCOUNT
          MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
.
GBED8000  MOVE      SP3,AWARD
          MOVE      SP3,ABED
.
          MOVE      WWARD,TWARD
          MOVE      WBED,TBED
          GOTO      GBED9050
.
GBED9000  MOVE      AWARD,TWARD                    * restore ward/bed
          MOVE      ABED,TBED
.
GBED9050  MOVE      ZERO,EXIT
          GOTO      GBED9999
.
GBED9100  MOVE      AWARD,TWARD                    * restore ward/bed
          MOVE      ABED,TBED
.
          MOVE      ONE,EXIT
          GOTO      GBED9999
.
GBED9800  MOVE      "Ward/Bed Does Not Exist",WEBTITLE
          CALL      ADMERR00
          CALL      UUPTMAS1
          MOVE      ONE,EXIT
          GOTO      GBED9999
.
GBED9810  MOVE      "Ward is Not Active",WEBTITLE
          CALL      ADMERR00
          CALL      UUPTMAS1
          MOVE      ONE,EXIT
          GOTO      GBED9999
.
GBED9820  MOVE      "Bed is Not Active",WEBTITLE
          CALL      ADMERR00
          CALL      UUPTMAS1
          MOVE      ONE,EXIT
          GOTO      GBED9999
.
GBED9830  CLEAR     WEBTITLE
          APPEND    "The Bed is Already on Standby for Adm ",WEBTITLE
          APPEND    WSTBY,WEBTITLE
          APPEND    " & Cannot be Used",WEBTITLE
          RESET     WEBTITLE
          CALL      ADMERR00
          CALL      UUPTMAS1
          MOVE      ONE,EXIT
          GOTO      GBED9999
.
GBED9831  CLEAR     WEBTITLE
          APPEND    "Patient already admitted to this Bed",WEBTITLE
          RESET     WEBTITLE
          MOVE      ONE,EXIT
          GOTO      GBED9999
.
GBED9840  MOVE      "Invalid Bed",WEBTITLE
          CALL      ADMERR00
GBED9850  CALL      UUPTMAS1
          MOVE      ONE,EXIT
          GOTO      GBED9999
.
GBED9999  RETURN
+
.***************************************************************************
.*  BRAT0000  :  Subroutine to calculate the bed rate (from PATPRG31)      *
.*  Returns:    NOFEE 0 = Bed Fee found                                    *
.*                    1 = Bed Fee not set up                               *
.***************************************************************************
.
BRAT0000  MOVE      ZERO,SAVHF
          MOVE      ZERO,SAVPAT
          MOVE      ZERO,MAXDISC
          MOVE      ZERO,HFPORT
          MOVE      ZERO,ADISC
          MOVE      ZERO,ALWAMT
          MOVE      SP2,AALLOW
          MOVE      ZERO,SAVEND
          MOVE      ZERO,SAVEXTR
          MOVE      ZERO,NOFEE
.
.        Check the indicator saying what type of charging we are doing
.
          COMPARE   EIGHT,CFEETYP
          GOTO      BRAT9000 IF EQUAL
          COMPARE   NINE,CFEETYP
          GOTO      BRAT1000 IF EQUAL       * Johns Hopkins uses bed fees
          COMPARE   FIVE,CFEETYP
          GOTO      BRAT1000 IF EQUAL       * Southern Cross bed fees
.
          COMPARE   ZERO,CFEETYP            * bed fee charging ?
          GOTO      BRAT7500 IF NOT EQUAL   * no, use the standard routine
.
BRAT1000  OPEN      PATBFEE1,"patbfeef"
          OPEN      NZPBFEA1,"nzpbfeaf"
          OPEN      PATFN1A1,"patfn1af"
.
          MATCH     "1",PTCNUABF
          GOTO      BRAT2000 IF NOT EQUAL
.
          PACK      KEY5,ANSC,ANSL,ACLAIM
          CALL      RDCODE1
          BRANCH    OVRCD,BRAT2000
          MATCH     "A",TCINDC2
          GOTO      BRAT2000 IF NOT EQUAL    * Not an ABF Funding
.
          CALL      CABF0000                 * Check for ABF
          BRANCH    NOFEE,BRAT9300
.
          GOTO      BRAT9000
.
.         Display the daily Bed Fee
.
BRAT2000  MOVE      ADYHOSP,NOHOSP
.
.         Display the current bed fee and also option to change bed type
.
          MOVE      ATYPE,SAVATYP
          MOVE      ZERO,COMFLAG            * Generate computer rate
          CALL      PATDSBFE
          MOVE      SAVCOL,DEFCOL           * Save the default column number
.
          COMPARE   ONE,NOFEE               * Bed Fee not set
          GOTO      BRAT9100 IF EQUAL
.
          MOVE      "IR",MODE
          MOVE      DEFCOL,SAVCOL
.
          MOVE      SAVPAT,MAXDISC          * save for TRANS file
          MOVE      SAVHF,HFPORT
          GOTO      BRAT9000
.
.       Get the rate to be charged (non-bed fee file)
.
BRAT7500  PACK      NEWTDATE,ADATE
          MOVE      NWARD,NEWTWARD
          MOVE      ATYPE,NEWTATYP
          MOVE      SAVBTYP,NEWTBTYP
          MOVE      AUSR2,NEWTCHST
          MOVE      ACLSSFT,NEWTDEPT
          PROC      PATTRRAT                 * calculate new rate
          BRANCH    EXIT,BRAT9200            * invalid rate
.
          MOVE      NEWTPPOR,MAXDISC
          MOVE      NEWTPPOR,SAVPAT
          MOVE      NEWTRPOR,SAVHF
          MOVE      NEWTRPOR,HFPORT
          MOVE      ZERO,TRATEG
          MOVE      NEWTXTRA,SAVEXTR
          ADD       NEWTXTRA,SAVPAT
          MOVE      NEWTBEND,SAVEND
.
BRAT9000  MOVE      ZERO,OVRCD
          MOVE      ZERO,NOFEE
          GOTO      BRAT9999
.
BRAT9100  CLEAR     WEBTITLE
          APPEND    "Bed Fee not set up:",WEBTITLE
          APPEND    PMVXMHOS,WEBTITLE
          APPEND    ACLAIM,WEBTITLE
          APPEND    AFUNDH,WEBTITLE
          APPEND    AFNDTB,WEBTITLE
          APPEND    SAVATYP,WEBTITLE
          APPEND    SAVBTYP,WEBTITLE
          APPEND    SP70,WEBTITLE
          RESET     WEBTITLE
.
          CALL      ADMERR00
          CALL      UUPTMAS1
          MOVE      ONE,NOFEE
          GOTO      BRAT9999
.
BRAT9200  MOVE      "Invalid Rate Combination",WEBTITLE
          CALL      ADMERR00
          CALL      UUPTMAS1
          MOVE      ONE,NOFEE
          GOTO      BRAT9999
.
BRAT9300  CLEAR     WEBTITLE
          APPEND    "ABF Admitted Acute Price Weight not set up for ",WEBTITLE
          APPEND    "Provisional DRG :",WEBTITLE
          APPEND    PTMIPDRG,WEBTITLE
          APPEND    SP70,WEBTITLE
          RESET     WEBTITLE
.
          CALL      ADMERR00
          CALL      UUPTMAS1
          MOVE      ONE,NOFEE
          GOTO      BRAT9999
.
BRAT9999  RETURN
+
.------------------------------------------------------------
.         Check for ABF charge
.------------------------------------------------------------
CABF0000  MATCH     SP70,PTMIPDRG
          GOTO      CABF9000 IF EQUAL      * Blank provisional DRG
.
.         Look for a Contract ID
.
          PACK      KEY9,ACLAIM,AFUNDH,SP70
          CALL      GETCNEFF               * Get Contract Effective From
          BRANCH    EXIT,CABF9000
.
          MOVE      ADATE,CEFFDATE         * default to admission date
.         LOAD      CEFFDATE,CNTRCEFR,ADATE,DDATE
.
          OPEN      PMSPWAA2,"pmspwaaf"
.
          PACK      KEY10,PTMIPDRG,SP70
          CALL      RSPMPWA2
CABF1000  CALL      RKPMPWA2
          BRANCH    OVRCD,CABF9000
.
          MATCH     PMPWDRGC,PTMIPDRG
          GOTO      CABF9000 IF NOT EQUAL     * Different DRG Code
.
          MOVE      PMPWCNTR,KEY6
          CALL      VALCONTR                * Validate Contract ID
          BRANCH    EXIT,CABF1000
.
          MOVE      PMPWCNTR,CONTRCID
          MOVE      ZERO,NOFEE
          GOTO      CABF9999
.
CABF9000  MOVE      ONE,NOFEE
CABF9999  RETURN
+
.------------------------------------------------------------
. WCSL0000 - Write a record to the Case notes Location file
.            if necessary - From PATPRG31
.------------------------------------------------------------
.
WCSL0000  MOVE      ONE,PCASE                     * Will have case notes
          MOVE      PCASE,SAVCASE                 * save Case notes indicator
.
          COMPARE   ZERO,PTCNUCSL                 * using case notes loc. file ?
          GOTO      WCSL9999 IF EQUAL             * no
.
          PACK      KEY11,PURNO,Z70
          CALL      RSPTCSL1
          CALL      RPPTCSL1
          BRANCH    OVRCD,WCSL7000                * patient has no record
.
          MATCH     PURNO,PTCLURNO                * same U/R No. ?
          GOTO      WCSL7000 IF NOT EQUAL         * no
          ADD       ONE,PTCLUNIQ                  * yes, increment Unique Id.
          GOTO      WCSL8000
.
WCSL7000  MOVE      ONE,PTCLUNIQ
WCSL8000  MOVE      PURNO,PTCLURNO
          MOVE      CNAME,PTCLDESC
          PACK      KEY11,PTCLURNO,PTCLUNIQ
          CALL      WRPTCSL1
.
WCSL9999  RETURN
+
.------------------------------------------------------------
. DOAD0000 - Update the Admission Record
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
.
DOAD0000  MOVE      AADMNO,KEY8
          CALL      RDAMISS1
          MOVE      TWO,ASTAT
          CALL      UPLMISS1
          CALL      WASF0000                * Write admin SFA file stuff
          MOVE      AADMNO,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD,DOAD1000
          CALL      ADDVIS00                * Adds a record to MR Visit Link
.
.         Write/Update the visit extension table
.
          MOVE      AADMNO,KEY8
          CALL      RAPMVX11                     * visit extension rec. found ?
          BRANCH    OVRCD,DOAD1000               * no
.
...       CALL      RDPMVX11                     * visit ext. record found ?
...       BRANCH    OVRCD,DOAD1000               * no
.
          PACK      KEY6,PTMIXWRD,SP70           * set default Ward
          CALL      SVXDF000                     * set Visit Extn. Defaults
.
          CALL      IBACLOCK
          MOVE      WBSEUID,PMVXWEBU
          PACK      PMVXLUPD,CCC,CYY,CMM,CDD
          REP       " 0",PMVXLUPD
          CLOCK     TIME,PMVXLUPT
.
          IF        PTCNHDPS=9 | PTCNHDPS=2
            MATCH     Z70,PTVIS105
            IF        @EQUAL
              MOVE      SP70,PMVXQASN       * Clear Contract Hospital UR
            ENDIF
          ENDIF
.
          MATCH     PMSVX125,Z70
          IF        !@EQUAL
            MOVE      PMSVX125,PMVXUDF7
            PACK      PMVXUDF7,PMVXUDF7,SP70
          ENDIF
.
          CALL      UPPMVX11                     * update the record
          GOTO      DOAD2000
.
DOAD1000  MOVE      ADATE,PMVXVSDT               * Visit Date
          MOVE      AADMNO,PMVXVISN
          PACK      KEY8,PMVXVISN
.
          PACK      KEY6,AWARD,SP70              * set default Ward
          CALL      SVXDF000                     * set Visit Extn. Defaults
.
          CALL      IBACLOCK
          PACK      PMVXCDTE,CCC,CYY,CMM,CDD * current date
          REP       " 0",PMVXCDTE
          CLOCK     TIME,CTIMEIS
          MOVE      CTIMEIS,PMVXCTIM
          MOVE      WBSEUID,PMVXWEBC
          CALL      WRPMVX11
.
DOAD2000  MOVE      PURNO,KEY8                                 *T0861841-Start
          CALL      RDAMAST1
          IF        OVRCD = 0
            MATCH     Z70,PTMSX048
            IF        !@EQUAL
              MOVE      PTMSX048,PTMXSLAC
            ENDIF
.                                                              
            CALL      UPMAST1               * update Master file
            CALL      UUPTMAS1
          ENDIF
.                                                              *T0861841-End
          IF        CCCNSVHM=1
            OPEN      CCIEX7A1,"cciex7af"
.
            MOVE      ANST,CLEXSTAT
            MOVE      THREE,CLEXTYPE
            MOVE      AADMNO,CLEXVISN
.
            PACK      KEY11,CLEXSTAT,CLEXTYPE,CLEXVISN,SP10
            CALL      RDCLEX71
            IF        OVRCD = 1
.
. No record with status "T" has been written to cciexaf table, write one
.
              CALL      WRCLEX71
            ENDIF
            CLOSE    CCIEX7A1
          ENDIF
.
          CALL      WRCPT000
          CALL      WRINT000
.
          CALL      CPRA0000             * Updating prfa
          CALL      WCARE000
          CALL      WORKD000
.
          CALL      UPBKD000             * update booking with admission details
          IF        PTCNHDPS=1
            PACK      SAVADMIS,ADMISSNO,SP70   * save existing admissno
            PACK      ADMISSNO,AADMNO,SP70
            CALL      WRPORD00              * write acc purchase order no if req
            PACK      ADMISSNO,SAVADMIS,SP70   * restore admissno
          ENDIF
.

          MOVE      ZERO,EXIT
          GOTO      DOAD9999
.
DOAD9999  RETURN
+
.------------------------------------------------------------
.         Check if we need to update PRFA
.------------------------------------------------------------
CPRA0000  MATCH     "1",PTCNXCOM
          GOTO      CPRA8000 IF NOT EQUAL    * Not using Extra Compensable
.
          PACK      KEY5,ANSC,ANSL,ACLAIM,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CPRA8000
.
          MOVE      SP70,DIM1
          MOVE      TCINDC1,DIM1
          REP       "P~J~ ~",DIM1
          MATCH     "~",DIM1
          GOTO      CPRA8000 IF NOT EQUAL    * Not Public
.
          MOVE      "2",KEY1                 * Postal Address
          CALL      DADR0000
          BRANCH    EXIT,CPRA8000
.
          MOVE      PMCEADD1,PKADD1
          MOVE      PMCEADD2,PKADD2
          MOVE      PMCEADD3,PKSUBR
          MOVE      PMCEADD4,PKADD4
          MOVE      PMCEPOST,PKPOST
          MOVE      PMCETELB,PKTELEB
          MOVE      PMCETELP,PKTELEP
          MOVE      PMCETELM,PTREMOBL
          MOVE      ADMISSNO,PKADMN       * CAR 275366
          MOVE      PGNAME,PTREGNAM
          MOVE      PTMASNAM,PTRESNAM
.
          PACK      KEY8,ADMISSNO,SP10
          CALL      RDARESP1
          IF        OVRCD=1
            CALL      WRRESP1
          ELSE
            CALL      UPRESP1
          ENDIF
          GOTO      CPRA9000
.
CPRA8000  CALL      PRAD0000
CPRA9000  MOVE      ZERO,EXIT
.
CPRA9999  RETURN
+
.------------------------------------------------------------
. ADMH0000 - Admit Mental Health Patient - From PATPRG31
.------------------------------------------------------------
.
ADMH0000  COMPARE   ONE,MHCNUSE                   * Using Mental Health system?
          GOTO      ADMH9999 IF NOT EQUAL
.
. update Master Extension file with Legal status
.
          MOVE      SAVLEGST,PTMXLS               * restore Legal stat keyed in
          MOVE      SAVLSDAT,PTMXLSDT             * restore legal status date
.
          PACK      KEY8,PURNO
          CALL      RDAMAST1
          BRANCH    OVRCD,ADMH1000
.
          CALL      OCRD0000                * reload original kiwi card details
          CALL      UPMAST1
          CALL      UUPTMAS1
          CALL      NCRD0000                * restore new kiwi card details
.
. update the Mental Health Visit file
.
ADMH1000  MOVE      AADMNO,MHVIADMN
          PACK      KEY8,MHVIADMN
          CALL      RAMHVIS1
          IF        OVRCD=ONE
            CALL      WRMHVS00
          ENDIF
.
          PACK      KEY8,MHVIADMN
          CALL      RAMHVIS1
          BRANCH    OVRCD,ADMH9999
.
          MOVE      ONE,MHVISTAT                  * In hospital
          CALL      UPMHVIS1
.
ADMH9999  RETURN
+
.------------------------------------------------------------
. XADM0000 - Miscellaneous extras when admitting patients
. Returns:   EXIT   0 = Ok to continue
.                   1 = Error
.------------------------------------------------------------
.
XADM0000  IF        NOBEDFLG=1
            MOVE      APLUR,NBPLUR
            MOVE      SP3,NBROOM
            PACK      KEY13,AWARD,AADMNO,NBPLUR,SP70
            CALL      RDNOBE1
            IF        OVRCD=1
              CALL      WRNOBE1
            ENDIF
          ENDIF
.
. update the patdayaf files if appropriate
.
          CALL      PATD0000                      * update the patdayaf files
.
. Add Admission No to the Invoices Pending File
. If Using the Invoice Pending File
.
          COMPARE   ZERO,PTCNIPEN
          GOTO      XADM0200 IF NOT EQUAL
.
.         Public hospital, check if there is bed fees amount
.
          IF        CHOSTYP=1 & CFEETYP=0
            CALL      CLMC0000                    * Check Claim code
            BRANCH    EXIT,XADM0200               * No charge
.           MOVE      ONE,PTIPRSTA                * Admission
.           MOVE      ADATE,PENDSDAT              * as at date
.           CALL      CINVP000                    * Check invoice pending
.           GOTO      XADM0200
          ENDIF
.
          MOVE      AADMNO,IPADMNO
          MOVE      THREE,IPSYSTM
          PACK      IPSITE,SP70
.
          MOVE      SP70,PENDHOSP
          IF        IBCNMHOS=1
            MOVE      IPADMNO,KEY8
            CALL      RDPMVX11
            IF        OVRCD=0
              MOVE      PMVXMHOS,PENDHOSP         * Hospital ID
            ENDIF
          ENDIF
          MOVE      " 3",PENDSYST                 * Inpatient
.
          MOVE      ADATE,PENDSDAT                * as at date
          MOVE      ADATE,PENDADAT                * admission date
          MOVE      SP70,PENDDDAT
          IF        ASTAT=3
            CALL      RDDSCH1
            IF        OVRCD=0
              MOVE      DDATE,PENDDDAT            * discharged date
            ENDIF
          ENDIF
          MOVE      AFUNDH,PENDFUND
          MOVE      ACLAIM,PENDCLAM
          CALL      IPRH0000
          MOVE      ONE,PTIPRSTA
          MOVE      SP70,PTIPSVAR
.
          PACK      KEY8,IPADMNO,SP70
          CALL      RAIPEN1
          IF        OVRCD=1
            CALL      WRIPEN1
          ELSE
            CALL      UPIPEN1
          ENDIF
.
. Update the Statistics file
.
XADM0200  CALL      USTA0000
          BRANCH    EXIT,XADM9900
.
. Update backdata indicators in the control file
.
          MOVE      ADATE,TDATE
          CALL      UCNT0000
.
. Write to Rate Change Audit file if system parameter is switched on (0)
.
          BRANCH    CAUDQ,XADM5000
.
XADM0500  OPEN      PATRCAUD,"patrcaud"
          CALL      RDSRCA
.
          COMPARE   ZERO,RSTATUS
          GOTO      XADM9100 IF NOT EQUAL
.
          CALL      WRIRCA
          MOVE      AADMNO,RADMNO
          MOVE      PGNAME,ANS
          PACK      RNAME,ANS,DOT,PSNAME
          MOVE      ACLAIM,RCLAIM
          MOVE      AFUNDH,RFUND
          MOVE      AFNDTB,RHFTAB
          MOVE      SAVBTYP,RBTYPE
.
          MOVE      ZERO,ROPAT
          MOVE      SAVPAT,RNPAT
          SUB       ADISC,RNPAT
          SUB       ALWAMT,RNPAT
          MOVE      SAVHF,RNFUND                  * from  PATDSBFE
          MOVE      TDATE,RDATE
          MOVE      ATYPE,RATYPE
          MOVE      SP3,RCLSS
          MOVE      SP3,RCHST
          MOVE      PASSCODE,ROPER                * Operator code
.
          COMPARE   NINE,CFEETYP
          GOTO      XADM2000 IF EQUAL       * Johns Hopkins uses bed fees
          COMPARE   ZERO,CFEETYP
          GOTO      XADM2000 IF EQUAL
.
. The following fields are only used for hospital not using bed fees
.
          MOVE      SP3,RFUND
          MOVE      SP6,RHFTAB
          MOVE      SP3,RBTYPE
          MOVE      ZERO,RCGPAT
          MOVE      ZERO,RCGHF
          MOVE      ZERO,RNFUND
          MOVE      ZERO,REDAYS
.
          MOVE      ACLSS,RCLSS
          MOVE      AUSR2,RCHST
          GOTO      XADM3000
.
. The computer generate rate figures is done in PATDSBFE include
. Initialy REDAYS is saved in PATDSBFE
.
XADM2000  SUB       ADYHOSP,REDAYS
          MOVE      ADATE,FROMDATE
          MOVE      TDATE,TODATE
....      CALL      NHOSPDAY
....      SUB       NBRDAYS,REDAYS
          MOVE      ONE,REDAYS
.
. have to restore ward and bed as it can change in NHOSPDAY
.
.....     MOVE      AWARD,TWARD             * restore WARD
.....     MOVE      ABED,TBED               * restore BED
.
XADM3000  CALL      WRRCA
.
. Write a record to the In-patient Location file
.
XADM5000  MOVE      SP10,LPCONDC          * Initialise Patient condition code
          PACK      LPCONDD,SP20,SP20     * Initialize Patient condition desc.
          MOVE      SP10,LPCDATE          * Initialize Patient condition date
          MOVE      SP10,LPCTIME          * Initialize Patient condition time
          MOVE      SP10,LPCONAM          * Initialize Patient amb status
          PACK      LOCSPAR,SP20,SP10     * Initialize spare variable
          PACK      KEY88,PTMASNAM,PMPXFNAM,AADMNO
          CALL      RDLOCA1
          IF        OVRCD=1
            MOVE      AURNO,LURNO
            PACK      KEY88,PTMASNAM,PMPXFNAM,AADMNO
            CALL      WRLOCA1
          ENDIF
.
. Update the booking and waiting list statuses
.
          CALL      UBOK0000
.
. Write an "A" record to pataaud if system parameter is switched on
. (This is added for V5.01.41)
.
          PROC      ADMAUDIT
.
          MOVE      ZERO,EXIT
          GOTO      XADM9999
.
XADM9100  MOVE      "Rate Change Audit in Use",WEBTITLE
          CALL      WEBERR00
XADM9900  MOVE      ONE,EXIT
          GOTO      XADM9999
.
XADM9999  RETURN
+
.------------------------------------------------------------
.         Check Claim code if it's chargeable
.------------------------------------------------------------
CLMC0000  PACK      ACLAIM,ACLAIM,SP70
          MATCH     SP70,ACLAIM
          GOTO      CLMC9000 IF EQUAL      * no charge
.
          PACK      KEY5,CODECL,ACLAIM
          CALL      RDCODE1
          BRANCH    OVRCD,CLMC8000
.
          MATCH     "P",TCINDC12
          GOTO      CLMC9000 IF EQUAL      * Public - no charge
          MATCH     "R",TCINDC12
          GOTO      CLMC9000 IF EQUAL      * Reciprocal - no charge
          MATCH     "J",TCINDC12
          GOTO      CLMC9000 IF EQUAL      * Prisoner - no charge
.
CLMC8000  MOVE      ZERO,EXIT              * chargeable
          GOTO      CLMC9999
.
CLMC9000  MOVE      ONE,EXIT               * no charge
CLMC9999  RETURN
+
.------------------------------------------------------------
. UBOK0000 - Update Booking file - From PATPRG31
.------------------------------------------------------------
.
UBOK0000  MOVE      AADMNO,KEY8
          CALL      RDBKREC1
          BRANCH    OVRCD,UBOK9999
.
          PACK      KEY5,ANSB,ANSK,BKRETYPE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,UBOK0300
.
....      MATCH     "THE",THCSCOD
....      GOTO      UBOK0300 IF NOT EQUAL
.
          CALL      THET0000
....      GOTO      UBOK9999
.
UBOK0300  COMPARE   ONE,CBOOK
          GOTO      UBOK9999 IF NOT EQUAL
.
          MOVE      AADMNO,KEY8
          CALL      RDBKREC1
          BRANCH    OVRCD,UBOK9999
.
          MATCH     "1",KEEPBKTM
          GOTO      UBOK1000 IF EQUAL
.
          COMPARE   THREE,PTCNHDPS          * Don't update confirmed admission
          GOTO      UBOK0500 IF NOT EQUAL   * for victorian public hospitals
.
          COMPARE   ONE,CHOSTYP             * Public
          GOTO      UBOK1000 IF EQUAL
.
UBOK0500  MATCH     PTMIS001,Z70
          IF        !@EQUAL
            MOVE      PTMIS001,BKREEDAT     * Confirmed admission date
            REP       " 0",BKREEDAT
          ENDIF
.
          MATCH     PTMIS002,Z70
          IF        !@EQUAL
            MOVE      PTMIS002,BKREATIM     * Confirmed admission time
          ENDIF
.
UBOK1000  COMPARE   TWO,BKRESTAT
          GOTO      UBOK9999 IF EQUAL
.
.         IF        BKRESTAT<>2
            LOAD      BKRESTAT,ASTAT,ONE,THREE,FOUR,FOUR,ZERO
.         ENDIF
          CALL      UPBKREC1
.
. waiting Lists WMSTAT SET TO 4 AS ADMITTED
.
          COMPARE   ONE,HBWAIT
          GOTO      UBOK9999 IF NOT EQUAL
.
          PACK      KEY19,BKREURNO,BKREPROC,BKRECNT
          CALL      RDTREA1
          BRANCH    OVRCD,UBOK9999
          IF        WMSTAT <= 6
.. **** check if any change required, otherwise exit *****
            MOVE      ZERO,F1
            MOVE      WMSTAT,F1
            LOAD      WMSTAT,ASTAT,THREE,FOUR,FIVE
            COMPARE   F1,WMSTAT
            GOTO      UBOK9999 IF EQUAL
.
            MATCH     SP70,ATYPE
            IF        !@EQUAL
              CALL      SAVHIS00
              MOVE      ATYPE,WMPCAT
              CALL      WRTHIS00
            ENDIF
            LOAD      WMSTAT,ASTAT,THREE,FOUR,FIVE
            CALL      UPTREA1
            IF        WMSTAT=4
              IF        UPDATETY<>6
                CALL      SAVHIS00
                MOVE      ZERO,NBRFLAG
                MOVE      "33",WTWMBSCD
                MOVE      WMBOOK,SAVEBOOK
                CALL      WRTHIS00
                CALL      WRCHA000          * write change audit admission
              ENDIF
            ENDIF
            CALL      PMIGTNID              * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      FORTY4,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLIUWL              * HL7 - Update Waiting List Entry
          ENDIF
.
UBOK9999  RETURN
+
.------------------------------------------------------------
. UCNT0000 - Update the control file with the transfer date
.            if neccessary -From PATPRG31
.------------------------------------------------------------
.
UCNT0000  READ      CONTROLF,EIGHTY8;*148,CFRDTE
.
          MATCH     CFRDTE,TDATE
          GOTO      UCNT9999 IF NOT LESS
.
          MOVE      TDATE,CFRDTE
          WRITAB    CONTROLF,EIGHTY8;*148,CFRDTE
.
UCNT9999  RETURN
+
.---------------------------------------------------------------------
. USTA0000 - Add new Admission data to statistics file - From PATPRG31
. Returns:    EXIT  0 = Ok to continue
.                   1 = Error
.---------------------------------------------------------------------
.
USTA0000  COMPARE   ONE,PTCNSTAU             * Return if using the new admission
          GOTO      USTA9000 IF EQUAL          and discharge stats report
.
          PACK      CPTDATE,ADATE
          REP       " 0",CPTDATE
          CALL      GPERD                   * period on file ?
          BRANCH    EXIT,USTA9100           * no - error
.
          MOVE      DRGYR,SADYEAR
          MOVE      DRGNUM,FORM2
.
          PACK      KEY8,SADYEAR,ANSA,ATYPE
          MATCH     SP3,ATYPE
          GOTO      USTA2500 IF NOT EQUAL
.
          PACK      KEY8,SADYEAR,ANSA,CODEUNK
USTA2500  CALL      RDSTAD1
          BRANCH    OVRCD,USTA3000
.
          MOVE      ONE,COUNT
          CALL      UVST0000
          GOTO      USTA4000
.
USTA3000  MOVE      ANSA,SADTYPE
          MOVE      ATYPE,SADCODE
.
          MATCH     SP3,ATYPE
          GOTO      USTA3500 IF NOT EQUAL
          MOVE      CODEUNK,SADCODE
.
USTA3500  CALL      ANST0000
.
USTA4000  PACK      KEY8,SADYEAR,ANSB,ASRCE
          MATCH     SP3,ASRCE
          GOTO      USTA4500 IF NOT EQUAL
.
          PACK      KEY8,SADYEAR,ANSB,CODEUNK
USTA4500  CALL      RDSTAD1
          BRANCH    OVRCD,USTA4800
          MOVE      ONE,COUNT
          CALL      UVST0000
          GOTO      USTA9000
.
USTA4800  MOVE      ANSB,SADTYPE
          MOVE      ASRCE,SADCODE
.
          MATCH     SP3,ASRCE
          GOTO      USTA5000 IF NOT EQUAL
          MOVE      CODEUNK,SADCODE
.
USTA5000  CALL      ANST0000
.
USTA9000  MOVE      ZERO,EXIT
          GOTO      USTA9999
.
USTA9100  UNPACK    CPTDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          CLEAR     WEBTITLE
          APPEND    CPCDATE,WEBTITLE
          APPEND    " not in Period File",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      USTA9999
.
USTA9999  RETURN
+
.-------------------------------------------------------------------
. PATD0000 - Update the patdayaf files if neccessary - From PATPRG31
.-------------------------------------------------------------------
.
PATD0000  COMPARE   ZERO,PTCNDAYF         * skip if not using patdayaf file
          GOTO      PATD9999 IF EQUAL       for statistics
.
          READ      CONTROLF,FIFTY9;*174,PTCNNDAT
.
          MATCH     SP8,PTCNNDAT          * Don't update patdayaf if the update
          GOTO      PATD9999 IF EQUAL       has not been run before
.
          MATCH     "00000000",PTCNNDAT
          GOTO      PATD9999 IF EQUAL
.
          PACK      STRTDATE,ADATE
          REP       " 0",STRTDATE
.
          MATCH     PTCNNDAT,STRTDATE       * Don't process if adm. date is >=
          GOTO      PATD9999 IF NOT LESS      date for next update
.
          UNPACK    PTCNNDAT,CCENT,CYEAR,CMON,CDAY
.
          CALL      SUBD0000                * subtract a day from PTCNNDAT
.
          PACK      ENDDATE,CC,YY,MM,DD
          REP       " 0",ENDDATE
          MOVE      AADMNO,ADMISNO
.
          CALL      PATDAYAD                * add records to the patdayaf files
.
PATD9999  RETURN
+
.------------------------------------------------------------
. SUBD0000 - Routine to subtract one from a given date
. Requires : CYEAR, CMON, CDAY
. Returns  : YY, MM, DD
.------------------------------------------------------------
.
SUBD0000  MOVE      CCENT,CC
          MOVE      CYEAR,YY
          MOVE      CMON,MM
          MOVE      CDAY,DD
          CALL      DMYCON           * convert to julian date
.
.------ subtract one daye and set up the return date -------
.
          SUB       ONE,JULDAY
          MOVE      JULDAY,JWKDAY
          MOVE      JULYR,JWKYER
          MOVE      JULCC,JWKCC
          CALL      JULCON
.
SUBD9999  RETURN
+
.--------------------------------------------------------------------
. FINA0000 - Normal Admission (Patient has a U/R No.) - From PATPRG31
. Returns:   EXIT   2 = Ok to continue
.                   1 = Error
.--------------------------------------------------------------------
.
. Branch on whether the patient registration screen is being used
. or the normal patient master screen
.
FINA0000  BRANCH    PTCNPREG,FINA2000
          GOTO      FINA2500
.
FINA2000  COMPARE   ONE,PTCNICAD                  * using current address
          GOTO      FINA2500 IF NOT EQUAL
.
. Update the MHMS adjustments file if necessary
.
FINA2500  MOVE      AADMNO,PVIBILL
          MOVE      PVIBILL,KEY8
          CALL      RDVISA1                       * Make sure visit file is read
.
.         The patient should not have any change record in unadmit change
.         audit file
.
FINA5000  CALL      STRNA000                      * write tran record
          CALL      WRDTC000                      * write pmsdtcaf record
.
          MOVE      AURNO,PURNO
          MOVE      PURNO,KEY8
          CALL      RDMAST1                       * Make sure got correct rec.
          CALL      RDPMPX21                      * Make sure got correct rec.
          MOVE      ONE,PCASE                     * Will have case notes
          MOVE      SP8,PTMX3BEX
          MOVE      ZERO,PSTAT
          CALL      UPMAST1
          CALL      UUPTMAS1
.
.         Broadcast to Datagate
.
          IF        STATFLAG=0
            CALL      PMIGTNID              * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      TEN2,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICAD              * broadcast admission      *C-90223
          ELSE
            MOVE      TWO,STATFLAG          * broadcast statistical admission
          ENDIF
.
          CALL      CMXF0000              * Check if casemix fees setup
          BRANCH    EXIT,FINA8000
          MOVE      ONE,CPAYMFLG
.
FINA8000  MOVE      TWO,EXIT
          BRANCH    NOMESSAG,FINA9999
          MOVE      "Patient is Now Admitted ",WEBTITLE
          ADD       ONE,WARCOUNT
          MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
          MOVE      TWO,EXIT
          GOTO      FINA9999
.
FINA9100  MOVE      ONE,EXIT
          GOTO      FINA9999
.
FINA9999  RETURN
+
.------------------------------------------------------------
. WRDTC000 - Write to secondary doctor table if required
.------------------------------------------------------------
WRDTC000  MATCH     Z70,PTVIS060
          GOTO      WRDTC999 IF EQUAL
.
          MATCH     SP70,PTVIS060
          GOTO      WRDTC999 IF EQUAL
          GOTO      WRDTC999 IF EOS
.
          PACK      PMDTVISN,AADMNO,SP70
          PACK      PMDTDOCT,PTVIS060,SP70
          PACK      PMDTUNIT,PTVIS096,SP70
          PACK      PMDTSDAT,ADATE,SP70
          MOVE      ATIME,PMDTSTIM
          PACK      PMDTEDAT,SP70
          MOVE      SP70,PMDTETIM
          PACK      KEY24,PMDTVISN,PMDTSDAT,PMDTSTIM,SP70
          CALL      RAPMDTC1
          IF        OVRCD<>1
            GOTO      WRDTC999
          ENDIF
.
          CALL      IBACLOCK
          PACK      PMDTCDAT,CCC,CYY,CMM,CDD       * Current Date
          REP       " 0",PMDTCDAT
          MOVE      CTIMEIS,PMDTCTIM               * Current Time
          MOVE      USERID,PMDTCUID                * Current WebID
.
          CALL      WRPMDTC1
WRDTC999  RETURN
+
.------------------------------------------------------------
. GADM0000 - Get an Admission Number - From PATPRG31
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
.
GADM0000  MOVE      ADMISSNO,KEY8                 * check for record on Adm file
          CALL      RDMISS1
          BRANCH    OVRCD,GADM9100                * No Admission record found
.
          MOVE      ADATE,SAVADATE
          MOVE      ATIME,SAVATIME
          MOVE      AURNO,SAVURNO                 * save U/R No.
          MOVE      PTMIPVIS,ORIGVISI             * set original visits
          MOVE      ADYHOSP,ORIGDAYS              * set original days
          CALL      CHKWB000                      * check for WL or booking
.
          BRANCH    ASTAT,GADM1000,GADM9900,GADM9300,GADM9400,GADM9500
.                         PreAdm   Admiss   Disch    Leave    Cancelled
          GOTO      GADM9100
.
GADM1000  MOVE      AADMNO,KEY8
          CALL      RDVISA1                       * Make sure visit file exists
          BRANCH    OVRCD,GADM9100                * no Visit file record
.
. now get Master file record
.
GADM1500  MOVE      AURNO,KEY8
          CALL      RLPTMAS1                      * record found ?
          BRANCH    OVRCD,GADM9200:               * no
                          GADM9150                * yes, but already locked
          MOVE      AURNO,KEY8
          CALL      RDPMPX21
.
.            * stat adm can be deceased
          IF        REPORTNO<>13
            IF        PCEASE=1
              PACK      KEY5,ANSC,ANSC,PTMIS012,SP70
              CALL      RDCODE1                  * check care type
              BRANCH    OVRCD,GADM9600
.
              MATCH     "D",TCINDC12             * organ procurement admission ?
              GOTO      GADM9600 IF NOT EQUAL    * no
            ENDIF
          ENDIF
.
. now check the Patients status
.
          BRANCH    PSTAT,GADM9800,GADM9700            * display error messages
.
. Check to see if file in use
.
          MOVE      AADMNO,KEY8
          CALL      RLPTMIS1                     * record found ?
          BRANCH    OVRCD,GADM9100:              * no
                          GADM9250               * yes, but already locked
.
          CALL      AMSV0000                      * save vars before audit write
          COMPARE   ONE,MHCNUSE
          GOTO      GADM9000 IF NOT EQUAL
.
          PACK      KEY8,AADMNO
          CALL      RDMHVIS1
          CALL      RCJA0000                    * read the mehcjaaf file
.
GADM9000  MOVE      ZERO,EXIT                     * Valid Adm No. input
          CALL      UUPTMIS1
          CALL      UUPTMAS1
          GOTO      GADM9999
.
. Display appropriate Error Messages
.
GADM9100  MOVE      "Patient Has Not Been Pre-admitted",WEBTITLE
          CALL      ADMERR00
          MOVE      ONE,EXIT
          CALL      UUPTMAS1
          GOTO      GADM9999
.
GADM9150  CLEAR     WEBTITLE
          APPEND    "Patient U/R No. ",WEBTITLE
          APPEND    AURNO,WEBTITLE
          APPEND    " Busy on Terminal ",WEBTITLE
          APPEND    PPORT,WEBTITLE
          RESET     WEBTITLE
          CALL      ADMERR00
          MOVE      ONE,EXIT
          GOTO      GADM9999
.
GADM9200  MOVE      "Patient Master Index Record Missing. Contact IBA ",WEBTITLE
          CALL      ADMERR00
          MOVE      ONE,EXIT
          GOTO      GADM9999
.
GADM9250  CLEAR     WEBTITLE
          APPEND    "Patient Admission ",WEBTITLE
          APPEND    ADMISSNO,WEBTITLE
          APPEND    " Busy on Terminal ",WEBTITLE
          APPEND    APORT,WEBTITLE
          RESET     WEBTITLE
          CALL      ADMERR00
          CALL      UUPTMAS1
          MOVE      ONE,EXIT
          GOTO      GADM9999
.
GADM9300  MOVE      "Patient is Discharged",WEBTITLE
          CALL      ADMERR00
          MOVE      ONE,EXIT
          GOTO      GADM9999
.
GADM9400  MOVE      "Patient is Currently on Leave",WEBTITLE
          CALL      ADMERR00
          MOVE      ONE,EXIT
          GOTO      GADM9999
.
GADM9500  MOVE      "Pre-admission Has Been Cancelled",WEBTITLE
          CALL      ADMERR00
          MOVE      ONE,EXIT
          GOTO      GADM9999
.
GADM9600  MOVE      "Patient is Deceased",WEBTITLE
          CALL      CHKDED00                * patient is not organ procurement
          MOVE      ONE,EXIT
          CALL      UUPTMAS1
          GOTO      GADM9999
.
GADM9700  MOVE      "U/R has been Cancelled",WEBTITLE
          CALL      ADMERR00
          MOVE      ONE,EXIT
          CALL      UUPTMAS1
          GOTO      GADM9999
.
GADM9800  CLEAR     WEBTITLE
          APPEND    "U/R Number",WEBTITLE
          APPEND    PURNO,WEBTITLE
          APPEND    " has an Associated U/R",WEBTITLE
          RESET     WEBTITLE
          CALL      ADMERR00
          MOVE      ONE,EXIT
          CALL      UUPTMAS1
          GOTO      GADM9999
.
GADM9900  MOVE      "Patient is Currently Admitted",WEBTITLE
          CALL      ADMERR00
          MOVE      ONE,EXIT
          GOTO      GADM9999
.
GADM9999  RETURN
+
.----------------------------------------------------------------
. CHKWB000 - Check if this patient has a WL procedure or booking
.----------------------------------------------------------------
.
CHKWB000  MOVE      ZERO,WLFLAG
          MOVE      ZERO,BKFLAG
.
          PACK      KEY19,URNUMBER,SP20
          OPEN      WATTR1A1,"wattr1af"
          CALL      RDSTREA1
CHKWB100  CALL      RDKTREA1
          BRANCH    OVRCD,CHKWB500          * no procedures
.
          MATCH     URNUMBER,WMURNO
          GOTO      CHKWB500 IF NOT EQUAL   * no procedures
.
          COMPARE   "3",WMSTAT
          GOTO      CHKWB100 IF NOT LESS    * not a valid status
          GOTO      CHKWB900
.
CHKWB500  OPEN      BOKRC1A6,"bokrc1af"
          PACK      KEY16,URNUMBER,SP20
          CALL      RSBKREC6
CHKWB600  CALL      RKBKREC6
          BRANCH    OVRCD,CHKWB999
.
          MATCH     URNUMBER,BKREURNO
          GOTO      CHKWB999 IF NOT EQUAL
.
          COMPARE   ONE,BKRESTAT
          GOTO      CHKWB600 IF NOT LESS
.
CHKWB800  MOVE      ONE,BKFLAG
          GOTO      CHKWB999
.
CHKWB900  MOVE      ONE,WLFLAG
          GOTO      CHKWB999
.
CHKWB999  RETURN
+
.------------------------------------------------------------
. Check Emergency Visit Details
. Returns:    EXIT   0 = Ok to continue
.                    1 - Error
.------------------------------------------------------------
.
CHKEM000  IF        REPORTNO=4
            PACK      KEY8,EMRVISIT,SP70
          ELSE
            PACK      KEY8,ADMISSNO,SP70
          ENDIF
.
          CALL      RDEMVIS1
          BRANCH    OVRCD,CHKEM090
.
          COMPARE   FOUR,EMVISTAT
          GOTO      CHKEM910 IF EQUAL
.
          GOTO      CHKEM200
.
CHKEM090  PACK      KEY16,URNUMBER,Z70
          CALL      RSEMVIS3
CHKEM100  CALL      RPEMVIS3
          BRANCH    OVRCD,CHKEM910
.
          MATCH     URNUMBER,EMVIURNO       * See if its the right patient
          GOTO      CHKEM910 IF NOT EQUAL
.
          COMPARE   FOUR,EMVISTAT
          GOTO      CHKEM910 IF EQUAL
.
CHKEM200  COMPARE   THREE,PTCNHDPS          * If not victoria don't check for a
          GOTO      CHKEM900 IF NOT EQUAL   * unit or C-Type admission
.
          COMPARE   ZERO,CHOSTYP            * Private hospital
          GOTO      CHKEM900 IF EQUAL
.
          MATCH     SP70,EMVIUNIT           * Has Expected Unit
          GOTO      CHKEM900 IF NOT EQUAL   * Yes
.
          COMPARE   ONE,EMVIYN02            * C-Type
          GOTO      CHKEM900 IF EQUAL       * Yes
.
          GOTO      CHKEM920
.
CHKEM900  MOVE      ZERO,EXIT
          GOTO      CHKEM999
.
CHKEM910  CLEAR     WEBTITLE
          APPEND    "Invalid Emergency Visit. ",WEBTITLE
          APPEND    "Please select an ED Visit to proceed.",WEBTITLE
          RESET     WEBTITLE
          CALL      ADMERR00
          MOVE      ONE,EXIT
          GOTO      CHKEM999
.
CHKEM920  MOVE      "Unit/C-Type Missing.  Can't Admit Patient.",WEBTITLE
          CALL      ADMERR00
          MOVE      ONE,EXIT
          GOTO      CHKEM999
.
CHKEM999  RETURN
+
.------------------------------------------------------------
. RCJA0000 - Read the mehcjaaf file - From PATPRG31
.------------------------------------------------------------
.
RCJA0000  PACK      KEY21,AADMNO,SP20,SP10
          CALL      RSMHCJA1
          CALL      RKMHCJA1
          BRANCH    OVRCD,RCJA9999
.
          MATCH     AADMNO,MHCJADMN
          GOTO      RCJA9999 IF EQUAL
.
          MOVE      SP10,MHCJDATE
          MOVE      SP3,MHCJSTAT
          MOVE      SP5,MHCJTIME
          MOVE      ZEROVISN,MHCJADMN
.
RCJA9999  RETURN
+
.------------------------------------------------------------
. GASF0000 - Get admission SFA file stuff - From PATPRG31
.------------------------------------------------------------
.
GASF0000  MOVE      ADMISSNO,AADMNO
          PACK      KEY25,ADMISSNO,ANSA,SP70
          CALL      RDPTASF1                * Read an admin SFA file record
          BRANCH    OVRCD,GASF1000
.
          MATCH     AADMNO,PTAFADMN
          GOTO      GASF1000 IF NOT EQUAL   * Different admin no
.
          MATCH     ANSA,PTAFTYPE
          GOTO      GASF8000 IF EQUAL       * An admin SFA type
.
GASF1000  MOVE      ZEROVISN,PTAFADMN
          UNPACK    SP70,PTAFTYPE,PTAFDATE,PTAFTIME,PTAFCODE,PTAFCTYP
          UNPACK    SP70,PTAFCROL,PTAFCSID,PTAFSPAR
.
GASF8000  MOVE      ZERO,ASFFLG             * Admin SFA flag - no
GASF9000  MOVE      ZERO,EXIT
.
GASF9999  RETURN
+
.------------------------------------------------------------
PATICOKY  RETURN
+
.------------------------------------------------------------
. NEWREG00 - New Registration
.------------------------------------------------------------
NEWREG00  MATCH     SP70,FORMACTN
          GOTO      NEWREG50 IF EQUAL
.
          MATCH     "NR",FORMACTN
          IF        @EQUAL
            CALL      VEDU0000           * Check ED visit has a zero U/R
            BRANCH    EXIT,NEWREG99
.
            CALL      REGNEW00           * Register a new patient
.
            MATCH     "1",PTMXOSMS            * Opt out of SMS
            IF        @EQUAL
              CALL      OSMS0000              * Write opt of of SMS record
            ELSE
              CALL      DSMS0000              * Delete opt of of SMS record
            ENDIF
.
            MATCH     "1",THEAFLAG
            IF        @EQUAL
             CLEAR     REDIRECT
             APPEND    "oprweb01.pbl?reportno=9&template=2&sesskeys=",REDIRECT
             APPEND    SESSKEYS,REDIRECT
             APPEND    "&noofdays=",REDIRECT
             APPEND    NOOFDAYS,REDIRECT
             APPEND    "&urnumber=",REDIRECT
             APPEND    URNUMBER,REDIRECT
             RESET     REDIRECT
            ENDIF
            MATCH     "1",OTPTFLAG
            IF        @EQUAL
             CLEAR     REDIRECT
             APPEND    "outweb02.pbl?reportno=5&template=1&casekeys=",REDIRECT
             APPEND    CASEKEYS,REDIRECT
             APPEND    "&urnumber=",REDIRECT
             APPEND    URNUMBER,REDIRECT
             RESET     REDIRECT
            ENDIF
            MATCH     "2",THEAFLAG
            IF        @EQUAL
             CLEAR     REDIRECT
             APPEND    "watweb01.pbl?reportno=2&template=023",REDIRECT
             APPEND    "&defturno=",REDIRECT
             APPEND    URNUMBER,REDIRECT
             RESET     REDIRECT
            ENDIF
            MATCH     "3",THEAFLAG
            IF        @EQUAL
             CLEAR     REDIRECT
             APPEND    "watweb01.pbl?reportno=2&template=023",REDIRECT
             APPEND    "&defturno=",REDIRECT
             APPEND    URNUMBER,REDIRECT
             RESET     REDIRECT
             MOVE      ONE,NEXTPAGE
            ENDIF
            MATCH     SP70,REQUESTN
            IF        !@EQUAL & !@EOS
             CALL       THRQ0000
            ENDIF
            BRANCH    EXIT,NEWREG98
          ENDIF
.
          MATCH     SP70,ADMISSNO        * Check for emergency visit
          IF        !@EQUAL
            PACK      KEY8,ADMISSNO,SP70
            CALL      RDEMVIS1
            BRANCH    OVRCD,NEWREG10
.
            COMPARE   FOUR,EMVISTAT
            GOTO      NEWREG10 IF EQUAL
.
            MOVE      PURNO,EMVIURNO     * Associate the new urnumber to visit
.
            PACK      KEY8,ADMISSNO,SP70 * Write record with new key
            CALL      UPEMVIS1
.
            CALL      RDDETA1
            IF        OVRCD=0
              MOVE      PURNO,ADAURNO    * Link new UR to A&E visit (aaede1af)
              CALL      UPDETA1
            ENDIF
.
            OPEN      EMRUNKA1,"emrunkaf"
            PACK      KEY8,ADMISSNO,SP70   * need to delete unknown record
            CALL      RDEMUNK1
            IF        OVRCD=0
              CALL      DEEMUNK1                   * delete emrunkaf record
            ENDIF
            CLOSE     EMRUNKA1
            PACK      KEY8,ADMISSNO,SP70
            CALL      RDPMCUR1
            IF        OVRCD=0
              MOVE      PURNO,PMCUURNO
              CALL      UPPMCUR1
            ENDIF
            CALL      UPPMCU00                     * update current patients

            PACK      KEY8,ADMISSNO,SP70
            CALL      RDVISA1
            COMPARE   ZERO,OVRCD
            GOTO      NEWREG10 IF EQUAL
.
            MOVE      PURNO,PVIURNO
            MOVE      EMVIDATE,PVIDATE
            MOVE      DEMVIADM,PVIBILL
            MOVE      "1",PVITYPE
            MOVE      EMVIDOCT,PVIDOCT
            MOVE      "2",PVISTAT
            MOVE      "1",PVITRAN
            MOVE      WBSESIT,PVISITE
            MOVE      ADMISSNO,DPVIBILL
            CALL      WRPTVIS1              * Write to the patvisaf file
.
            MOVE      ADMISSNO,PMVXVISN     * Write to Visit extension table
            MOVE      EMVIDATE,PMVXVSDT
            MOVE      EMVIDOCT,PMVXDOCA
            MOVE      "0",PMVXCSNR
            MOVE      PPOST,PMVXPOST
            MOVE      "0",PMVXCFSG
            MOVE      SP70,PMVXINGP
            MOVE      "0",PMVXHCP1
            MOVE      "0",PMVXHCP2
            MOVE      "0",PMVXHCP3
            MOVE      "0",PMVXHCP4
            MOVE      SP70,PMVXRHC1
            MOVE      SP70,PMVXRH1G
            MOVE      " 1",PMVXRH1C
            MOVE      "0",PMVXPSTY
            MOVE      "0",PMVXVALW
            MOVE      "0",PMVXPALW
            MOVE      "0",PMVXINDC
            MOVE      "0",PMVXHOME
            MOVE      PMPXABRG,PMVXABRG
            MOVE      PMPXINTR,PMVXINTR      * Interpreter required
            MOVE      PMPXLNG1,PMVXLNG1      * Preferred Language 1
            MOVE      PMPXPRVI,PMVXPIND      * Privacy Indicator
            MOVE      PMPXCRIN,PMVXCSNR      * Consent Release of info
            MOVE      PMPXHOML,PMVXHOME      * Homeless status
            CALL      IBACLOCK
            PACK      PMVXCDTE,CCC,CYY,CMM,CDD * current date
            REP       " 0",PMVXCDTE
            MOVE      CTIMEIS,PMVXCTIM
            MOVE      WBSEUID,PMVXWEBC
            CALL      GTASGC00               * Get SLA/ASGC code
.
            PACK      KEY3,EMVISITE,SP70
            CALL      RDEMSIT1
            IF        OVRCD<>1
              PACK      PMVXMHOS,EMSTHSNO,SP70
            ENDIF
.
            PACK      KEY8,ADMISSNO,SP70
            CALL      RAPMVX11                * write to the Visit Ext. file
            IF        OVRCD=1
              CALL      WRPMVX11              * write to the Visit Ext. file
            ENDIF
.
            PACK      KEY8,ADMISSNO,SP70
            CALL      RDPMVX11                * read pmsvx1 for hl7 0931586
            IF        OVRCD=1
              CALL      CLPMSVX1
            ENDIF
.
            CALL      ADDALR00                * Add Alerts to EMR Patient
.
.           Broadcast registration message   * CAR 273793 (wahealth)
.
            CALL      PMIGTNID               * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      THIRTY6,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICAE               * send emr visit message
.
.           Broadcast discharge message      * CAR 274402 (wahealth)
.
            IF        EMVISTAT = 2 | EMVISTAT = 3
              CALL      PMIGTNID             * get national id for dgate write
              MOVE      NMPNUMB,PTNINMPI
              MOVE      THIRTY7,HL7TRGID
              MOVE      SP8,HL7INCLD
              PROC      DGCLICDI             * send emr discharge message
            ENDIF
          ENDIF
.
          CALL      ADDVIS00                  * Adds a record to MR Visit Link
.
          MATCH     SP70,ADMISSNO             * Check for emergency visit
          IF        !@EQUAL
            CALL      TEMR0000                * Track medical record to ED
          ENDIF
.
NEWREG10  MATCH     SP70,ADMISSNO
          IF        @EQUAL | @EOS
            MATCH     "1",UPEMMRIN            * Check if registration from ED
            IF        @EQUAL
              CALL      TMRR0000              * Track medical record to ED
.                                             without triage
            ENDIF
          ENDIF
          IF         PCEASE=1
            MOVE       "001",D3
            CALL       WDAU0000            * Write to Death details audit file
          ENDIF
.
          MATCH     SP70,PMPXUSR9
          IF        !@EQUAL & !@EOS
            MOVE       "003",D3
            CALL       WDAU0000            * Write to Advance Care Plan Audit
          ENDIF
.
          IF        FHIRTYPE=1
            MATCH     "NR",FORMACTN
            IF        @EQUAL
              MOVE      URNUMBER,KEY8
              REP       " -",KEY8
              CLEAR     FHIRLOCH           * FHIR Location Header
              APPEND    "Patient",FHIRLOCH
              APPEND    "/",FHIRLOCH
              APPEND    KEY8,FHIRLOCH
              RESET     FHIRLOCH
              STRIP     FHIRLOCH
            ENDIF
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      NEWREG99
.
NEWREG50  CALL      CLPATMAS
          CALL      CLPMSPX2                * clear mast ext2 details
          MOVE      "New Registration",WEBTITLE
          MOVE      SRCHSNAM,PSNAME
          MOVE      SRCHSNAM,PTMASNAM
          MOVE      SRCHGNAM,PGNAME
          MOVE      SRCHGNAM,PMPXFNAM
          MOVE      SRCHPDOB,PBDATE
          MOVE      SRCHPAGE,PSAGEYRS
          MOVE      SRCHPSEX,PSEX
          MATCH     "u",PSEX
          IF        @EQUAL
            PACK     PSEX,SP70
          ENDIF
.
          CALL      WEBHED00
          BRANCH    EXIT,NEWREG98
.
          CALL      WEBBOD00
          CALL      WEBEND00
NEWREG98  MOVE      ONE,EXIT
.
NEWREG99  RETURN
+
.------------------------------------------------------------
. Check to see if a U/R has already been allocated to ED 
.------------------------------------------------------------
VEDU0000  PACK      ADMISSNO,ADMISSNO,SP70
          MATCH     SP70,ADMISSNO           * Check for emergency visit
          GOTO      VEDU8000 IF EQUAL
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDEMVIS1
          BRANCH    OVRCD,VEDU8000
.
          MATCH     ZEROUR,EMVIURNO         * u/r number zero?
          GOTO      VEDU9000 IF NOT EQUAL
.
VEDU8000  MOVE      ZERO,EXIT
          GOTO      VEDU9999
.
VEDU9000  CLEAR     WEBTITLE
          APPEND    "Visit ",WEBTITLE
          APPEND    ADMISSNO,WEBTITLE
          APPEND    " has been registered to U/R ",WEBTITLE
          APPEND    EMVIURNO,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VEDU9999
.
VEDU9999  RETURN
+
.------------------------------------------------------------
. GTASGC00 - Get SLA/ASGC code from ibapostf
.------------------------------------------------------------
.
GTASGC00  OPEN      IBAPOST1,"ibapostf"
          MOVE      PPOST,D8
          SQUEEZE   D8
          MOVE      D8,F4
          MOVE      F4,D4
          REP       " 0",D4
          PACK      PPOST,D4,SP10
          PACK      KEY56,PPOST,PSUBRB,SP10,PADD4,SP70                *C-240184
          CALL      RDIBPOS1
          IF        OVRCD=0
            MOVE      IBPOASGC,PMVXASGC
          ELSE                                                        *I-240184
            PACK      KEY56,PPOST,PSUBRB,SP70
            CALL      RSIBPOS1
            CALL      RKIBPOS1
            BRANCH    OVRCD,GTASGC99
            MATCH     PPOST,IBPOPCOD
            IF        @EQUAL
              MATCH     PSUBRB,IBPOSUBR
              IF        @EQUAL
                MOVE      IBPOASGC,PMVXASGC
              ENDIF
            ENDIF
          ENDIF
.
GTASGC99  CLOSE     IBAPOST1
          RETURN
+
.------------------------------------------------------------
. CHKEMA00 - Check for Alerts in EMR
.------------------------------------------------------------
.
CHKEMA00  PACK      KEY8,ADMISSNO
          CALL      RDEMVIS1
          BRANCH    OVRCD,CHKEMA99
.
          COMPARE   FOUR,EMVISTAT
          GOTO      CHKEMA99 IF EQUAL
.
          PACK      KEY8,ADMISSNO,SP70           * Check for Alerts
          CALL      RDPRAM1
          BRANCH    OVRCD,CHKEMA99
.
          MOVE      ZEROUR,PURNO
.
CHKEMA99  RETURN
+
.------------------------------------------------------------
. ADDALR00 - Add Alerts to EMR Patient
.------------------------------------------------------------
.
ADDALR00  PACK      KEY16,ADMISSNO,SP70      * Key is ADMISSNO number
          CALL      RSPTALT1                 * Read alerts code file
ADDALR10  CALL      RKPTALT1                 * Read next record
          BRANCH    OVRCD,ADDALR90           * no more alerts ?
.
          MATCH     ADMISSNO,PTALURNO        * For this patient ?
          GOTO      ADDALR90 IF NOT EQUAL    * no, read all alerts
.
          MOVE      PURNO,PTALURNO
          PACK      KEY16,PURNO,PTALCATG,PTALCODE,PTALCNTR,SP70
          CALL      RAPTALR1
          IF        OVRCD=1
            CALL      WRPTALR1
.
            CALL      PMIGTNID                 * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      TWENTY8,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICUP                   * trigger PMI update message
          ENDIF
.
          PACK      KEY16,ADMISSNO,PTALCATG,PTALCODE,PTALCNTR,SP70
          CALL      DEPTALT1
          GOTO      ADDALR10
.
ADDALR90  CALL      ALCMA000
.
ADDALR99  RETURN
+
.------------------------------------------------------------
. ALCMA000 - Update Alert Comments Admisson number based
.------------------------------------------------------------
.
ALCMA000  OPEN      PMSALAA1,"pmsalaaf"
          PACK      KEY19,ADMISSNO,SP70
          CALL      RSPMALA1
ALCMA100  CALL      RKPMALA1
          BRANCH    OVRCD,ALCMA999          * end of file
.
          MATCH     ADMISSNO,PMANURNO       * same U/R Number?
          GOTO      ALCMA999 IF NOT EQUAL
.
          PACK      SAVKEY19,PMANURNO,PMANACAT,PMANACOD,PMANCNTR,PMANLNNO,SP70
          CALL      ADDNEW00
.
          PACK      KEY19,SAVKEY19,SP70
          CALL      DEPMALA1
          PACK      KEY19,SAVKEY19,SP70
          CALL      RSPMALA1
          GOTO      ALCMA100
.
ALCMA999  CLOSE     PMSALAA1
          RETURN
+
.---------------------------------------------------------------------.
. ADDNEW00 - now write the new comments back
.----------------------------------------------------------------------.
.
ADDNEW00  OPEN      PMSALNA1,"pmsalnaf"
          MOVE      PURNO,PMANURNO          * set U/R Number
.
          PACK      KEY19,PMANURNO,PMANACAT,PMANACOD,PMANCNTR,PMANLNNO,SP70
          CALL      RAPMALN1
          IF        OVRCD=1
            CALL      WRPMALN1
          ENDIF
.
ADDNEW99  CLOSE     PMSALNA1
          RETURN
+
.------------------------------------------------------------
. REGNEW00 - Register a new patient
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
.
REGNEW00  REP       "+ ",SESSKEYS
          REP       "+ ",THEAFLAG
          CALL      CLPATMAS
          CALL      CHKEMA00                * Check for EMR Alerts
          CALL      UPDMAS00                * Update Master Details
          CALL      CLPMSPX2                * Clear mast ext2 details
          CALL      UPVPMI00                * Move mast ext2 parm into file vars
.          CALL      CALCAGE                 * Calculate the patient age
.          MOVE      PSAGEYRS,PSAGE
.
          MATCH     "1",HEANBHFL
          IF        @EQUAL
            CALL      DFGEN000
          ENDIF
.
          IF        ALTIDFLG=1
            CALL      SETALT00              * set alternate ID UR number
            BRANCH    EXIT,REGNEW99
          ENDIF
.
          IF        ALTIDFLG=2
            CALL      SETALI00              * set alternate ID
            BRANCH    EXIT,REGNEW99
          ENDIF
.
          BRANCH    TEMPORAR,REGNEW10,REGNEW10    * temporary registration
          BRANCH    URGENOVR,REGNEW05
          BRANCH    CGENRUR,REGNEW10,REGNEW10
.
.  Manual U/R allocation
.
REGNEW05  RESET     URNUMBER,EIGHT
          MATCH     SP8,URNUMBER            * Invalid U/R
          GOTO      REGNEW92 IF EQUAL
.
          RESET     URNUMBER
          MOVE      URNUMBER,PURNO
          MOVE      PURNO,KEY8
          CALL      RDAMAST1
          COMPARE   ZERO,OVRCD              * U/R Number already exists
          GOTO      REGNEW93 IF EQUAL
.
          RESET     URNUMBER
          IF        ALTIDFLG<>1 & ALTIDFLG<>2
            CALL      VALDUR                  * Validate the format of the U/R
            BRANCH    EXIT,REGNEW92           * Invalid U/R Number
          ENDIF
.
          CALL      VLSEX000                * Validate sex. Can only be Indeter
          BRANCH    EXIT,REGNEW98           * if age less than 90 days
.
          GOTO      REGNEW20
.
. Computer Generated U/R
.
REGNEW10  CALL      VLSEX000                * Validate sex. Can only be Indeter
          BRANCH    EXIT,REGNEW98           * if age less than 90 days
.
          CALL      VALP0000                * PRS2 validation for pmi
          BRANCH    EXIT,REGNEW98
.
          CALL      CHOS0000                * Check Hospitla for user
          BRANCH    EXIT,REGNEW98
.
          MOVE      THREE,CPSYSTEM
          IF        TEMPORAR=1 | TEMPORAR=2
            CALL      GATUR000             * temporary registration
            IF        TEMPORAR=2
              MOVE     FOUR,PSTAT          * EBS temp U/R number
              GOTO     REGNEW20
            ENDIF
          ELSE
            CALL      GNXTUR
          ENDIF
.
          MOVE      ZERO,PSTAT
.
REGNEW20  MOVE      SP70,PHCNOTES           * Zero Fill Case Notes Indicator
          REP       " 0",PHCNOTES
.
          MOVE      CHOSPNUM,PINITHOS       * Initiating Hospital Number
          MOVE      ZEROVISN,PVIBILL        * No pre-attendance record to update
          MOVE      THREE,PVITYPE
          PACK      PTMXRDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTMXRDAT
.
          MOVE      WBSEHOSP,PMPXIHOS
          MOVE      WBSEUID,PMPXWBID
          MATCH     "UNKNOWN",PSNAME
          IF        @EQUAL
            MATCH     "1",QUICKREG
            IF        @EQUAL
              PACK      PSNAME,UNKNOWN,SP1,PURNO,SP70
            ENDIF
          ENDIF
          MATCH     "UNKNOWN",PTMASNAM
          IF        @EQUAL
            MATCH     "1",QUICKREG
            IF        @EQUAL
              PACK      PTMASNAM,UNKNOWN,SP1,PURNO,SP70
            ENDIF
          ENDIF
.
          UNPACK    PBDATE,CCENT,CYEAR,CMON,CDAY
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          CALL      CALCAGE                 * Calculate the patient age
          MOVE      PSAGEYRS,PSAGE
.
.         Task: 0873749
.         Below code has been moved so that it occurs immediately before the
.         patma1af record has been created, so that when the A28 message is
.         triggered in WRTUR, the UPI alternate ID record will already exist
.         and therefore the UPI will be sent in the A28 message.
.
          READ      CONTROLF,HUND25;*155,PTCNEPMI
          MATCH     "1",PTCNEPMI
          IF        @EQUAL
            MATCH     SP70,UPINUMBR
            IF        !@EQUAL
              CALL      ADDUAI00              * Add UPI as Alternate ID
            ENDIF
          ENDIF
.
          CALL      WRTUR
          BRANCH    EXIT,REGNEW98
.
          MATCH     SP70,ADMISSNO        * Check for emergency visit
          IF        !@EQUAL
            PACK      KEY8,ADMISSNO,SP70
            CALL      RDEMVIS1
            IF        OVRCD=0 & EMVISTAT<>4
              MOVE      PURNO,EMVIURNO           * Allocate U/R to ED visit 
              CALL      UPEMVIS1                 * to stop duplicate U/R's.    
            ENDIF                                * Other file will be
          ENDIF                                  * updated on NEWREG00
.                                           * Update eAdmission Head if reqd
          MATCH     SP70,ADMISNID
          IF        !@EQUAL
            CALL      UPDEHB00
          ENDIF
.
          MATCH     SP70,EREFRLID           * Update eReferral header
          IF        !@EQUAL
            CALL      UPDERH00
          ENDIF
.
          CALL      CRMED000                 * Create medical record
          BRANCH    EXIT,REGNEW91:
                         REGNEW91
.
          MOVE      PURNO,KEY8
          CALL      RDMAST1
          CALL      RDPMPX21
.
          IF        PTCNNHII=1
            CALL      TMPNHI00            * write Temp number to nhimasaf
            BRANCH    EXIT,REGNEW98
          ENDIF
.
          CALL      PPRV0000                * post previous surname as alias
          CALL      ALPR0000
          CALL      UPALIA00                * update preferred name alias
          CALL      UPUCM000                * input comments
.
          CALL      WEXP0000                * Write expected payor details
.
          MATCH     Z70,PTMAS086
          IF        !@EQUAL     
            MATCH     SP70,PTMAS086
            IF        !@EQUAL
              CALL      MBRTH000              * Write multiple birth details
            ENDIF
          ENDIF
.
          MATCH     Z70,PTMSX052
          IF        !@EQUAL
            MATCH     SP70,PTMSX052
            IF        !@EQUAL
              CALL      ANDIS000              * Write NDIS details
            ENDIF
          ENDIF
.
          COMPARE   ONE,ALTIDFLG
          GOTO      REGNEW40 IF EQUAL
.
          COMPARE   TWO,ALTIDFLG
          GOTO      REGNEW40 IF EQUAL
          GOTO      REGNEW50
.
REGNEW40  CALL      NWALID00              * Write a new alternate ID record
.
REGNEW50  CALL      DEAPOL00              * Update the Death Polling Table
.
          MOVE      PURNO,URNUMBER
          REP       " +",URNUMBER
          ENDSET    REDIRECT
          APPEND    "&urnumber=",REDIRECT
          APPEND    URNUMBER,REDIRECT
          RESET     REDIRECT
          SQUEEZE   REDIRECT
          REP       "+ ",URNUMBER
.
          MATCH     SP70,ADMISSNO
          IF        !@EQUAL
            REP       " +",ADMISSNO
            ENDSET    REDIRECT
            APPEND    "&admissno=",REDIRECT
            APPEND    ADMISSNO,REDIRECT
            RESET     REDIRECT
            SQUEEZE   REDIRECT
            REP       "+ ",ADMISSNO
          ENDIF
.
          COMPARE   ZERO,REGIFLAG
          IF        !@EQUAL
            ENDSET    REDIRECT
            APPEND    "&regiflag=1",REDIRECT
            RESET     REDIRECT
            SQUEEZE   REDIRECT
          ENDIF
.
.          MATCH     "1",PTCNUNET
.          IF        @EQUAL
.            MOVE      "01",KEY2                 * IHI Validation
.            PACK      KEY11,WBSEUID,SP70        * User ID
.            PACK      KEY50,URNUMBER,SP70
.            CALL      WIPL0000                  * Write to polling table
.          ENDIF
.
.                            * Do not allow auto NIHC IHI lookup on Quick Reg
.
          MATCH     "1",QUICKREG
          IF        !@EQUAL
            CALL      WPMNPL00                    * Write to NIHC IHI polling
          ENDIF
.
          CLEAR     WEBTITLE
          APPEND    "The allocated U/R number is : ",WEBTITLE
          APPEND    URNUMBER,WEBTITLE
          RESET     WEBTITLE
          MOVE      ZERO,EXIT
          GOTO      REGNEW99
.
REGNEW91  MOVE      "Error writing new U/R record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      REGNEW99
.
REGNEW92  MOVE      "Invalid U/R Number Entered",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      REGNEW99
.
REGNEW93  MOVE      "U/R Number Entered Already Exists",WEBTITLE
          CALL      WEBERR00
REGNEW98  MOVE      ONE,EXIT
          GOTO      REGNEW99
.
REGNEW99  RETURN
+
.-------------------------------------------------------------------------------
. ADDUAI00 - Add a new Alternte ID record using the first Cat AI code
.            found with Indicator 4=U and the UPI as the Alternate ID.
.-------------------------------------------------------------------------------
ADDUAI00  PACK      KEY5,ANSA,ANSI,SP70
          CALL      RDSCODE1
ADDUAI10  CALL      RDKCODE1
          BRANCH    OVRCD,ADDUAI91
.
          MATCH     "AI",TCODE
          GOTO      ADDUAI91 IF NOT EQUAL
.
          MATCH     "U",TCINDC4
          GOTO      ADDUAI10 IF NOT EQUAL
.
          MOVE      PURNO,PMAIURNO
          MOVE      ACODE,PMAITYPE
          PACK      PMAIALID,SP10,UPINUMBR,SP70
.
          PACK      KEY31,PMAIURNO,PMAITYPE,PMAIALID,SP70
          CALL      RAPMAID1
          IF        OVRCD<>1
            GOTO      ADDUAI99
          ENDIF
.
          PACK      PMAIDISU,SP70
          PACK      PMAIHOSP,SP70
          READ      CONTROLF,HUND10;*249,PTCNDAUR
          MATCH     "1",PTCNDAUR
          IF        @EQUAL
            MOVE      "1",PMAIDISU
          ENDIF
.
          MOVE      USERID,PMAICRUD
          CALL      IBACLOCK
          PACK      PMAICRDT,CCC,CYY,CMM,CDD
          REP       " 0",PMAICRDT
          MOVE      CTIMEIS,PMAICRTM
          MOVE      SP70,PMAIUPDT
          MOVE      SP70,PMAIUPTM
          MOVE      SP70,PMAIUPUD
.
          CALL      WRPMAID1
.  write nsw edw record for UPI added
          PACK      KEY5,ANSA,ANSI,PMAITYPE,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            MATCH     ANSU,TCINDC4
            IF        @EQUAL
              MOVE      "16",PMEWTYPE
              PACK      PMEWNEWV,PMAIURNO,PMAITYPE,PMAIALID,SP70
              CALL      WREDW000
            ENDIF
          ENDIF
.
ADDUAI90  MOVE      ZERO,EXIT
          GOTO      ADDUAI99
.
ADDUAI91  MOVE      ONE,EXIT
          GOTO      ADDUAI99
.
ADDUAI99  RETURN
.
.-------------------------------------------------------------------------------
. Add patient attribute type 022 for multiple birth type
.-------------------------------------------------------------------------------
MBRTH000  CALL      CLPATATR
.
          MOVE      PURNO,PTARURNO
          PACK      PTARVISN,SP7,ZERO
          CALL      IBACLOCK
          PACK      PTARDATE,CCC,CYY,CMM,CDD
          REP       " 0",PTARDATE
          CLOCK     TIME,PTARTIME
          MOVE      ATYPE022,PTARTYPE
          MOVE      PTMAS087,PTARVAL1 
          MOVE      PTMAS086,PTARCOD1 
          MOVE      USERID,PTARCUSR 
          MOVE      PTARDATE,PTARCDTE 
          MOVE      PTARTIME,PTARCTME 
.
          PACK      KEY35,PTARURNO,PTARDATE,PTARTIME,PTARTYPE,PTARVISN,SP70
          CALL      WRPTATR1
.
          MOVE      PTARURNO,KEY8
          CALL      RAPMPX21
          BRANCH    OVRCD,MBRTH999
.
          MOVE      "1",PMPXSN20  
          CALL      UPPMPX21          * update the record
.
MBRTH999  RETURN
.
.-------------------------------------------------------------------------------
. Add patient attribute type 025 for Recurring Care Specified Admission
.-------------------------------------------------------------------------------
RECATR00  CLOSE     PRSPMIA1
          OPEN      PATATRA3,"patatraf"
          MOVE      "025",ATRTYPE
          PACK      KEY35,URNUMBER,SP8,ATRTYPE,Z70
          CALL      RSPTATR3
RECATR02  CALL      RPPTATR3
          BRANCH    OVRCD,RECATR07
.
          MATCH     URNUMBER,PTARURNO
          GOTO      RECATR07 IF NOT EQUAL
.
          MATCH     SP70,PTARVISN
          GOTO      RECATR07 IF NOT EQUAL
.
          MATCH     ATRTYPE,PTARTYPE
          GOTO      RECATR07 IF NOT EQUAL
.
          MATCH     ATRTYPE,PTARTYPE
          GOTO      RECATR02 IF NOT EQUAL
.
          MATCH     "1",PTARDELR
          GOTO      RECATR02 IF EQUAL
.
          MATCH     PTARVAL1,PTMIXWRD              * match ward 
          GOTO      RECATR02 IF NOT EQUAL
.
          MATCH     PTARCOD1,ACLSSFT               * match unit 
          GOTO      RECATR02 IF NOT EQUAL
.
          MATCH     PTARCOD3,PMVXIDUS              * match intend stay duration
          GOTO      RECATR02 IF NOT EQUAL
.
          CALL      IBACLOCK
          PACK      PTARDATE,CCC,CYY,CMM,CDD
          REP       " 0",PTARDATE
          CLOCK     TIME,PTARTIME
          MOVE      PTMIXWRD,PTARVAL1
          MOVE      ACLSSFT,PTARCOD1
          MOVE      ACLAIM,PTARCOD2
          MOVE      PMVXIDUS,PTARCOD3
          MOVE      PRVADMIS,PTARTXT1
          MOVE      USERID,PTARUUSR
          MOVE      PTARDATE,PTARUDTE
          MOVE      PTARTIME,PTARUTME
          CALL      UPPTATR3
.
          GOTO      RECATR90 
.
RECATR07  CALL      CLPATATR
          MOVE      URNUMBER,PTARURNO
          PACK      PTARVISN,SP70
          CALL      IBACLOCK
          PACK      PTARDATE,CCC,CYY,CMM,CDD
          REP       " 0",PTARDATE
          CLOCK     TIME,PTARTIME
          MOVE      "025",PTARTYPE
          MOVE      PTMIXWRD,PTARVAL1
          MOVE      ACLSSFT,PTARCOD1
          MOVE      ACLAIM,PTARCOD2
          MOVE      PMVXIDUS,PTARCOD3
          MOVE      PRVADMIS,PTARTXT1
          MOVE      0,PTARDELR
          MOVE      USERID,PTARCUSR
          MOVE      PTARDATE,PTARCDTE
          MOVE      PTARTIME,PTARCTME
.
          PACK      KEY35,PTARURNO,PTARVISN,PTARTYPE,PTARDATE,PTARTIME,SP70
          CALL      WRPTATR3
.
RECATR90  CLOSE     PATATRA3
          OPEN      PRSPMIA1,"prspmiaf" 
.
RECATR99  RETURN
+
.-------------------------------------------------------------------------------
. Add NDIS details into pmsccdaf table 
.-------------------------------------------------------------------------------
ANDIS000  MOVE      "ct",KEY2
          PACK      KEY5,KEY2,SP70
          CALL      RDSCODE1
ANDIS200  CALL      RDKCODE1
          BRANCH    OVRCD,ANDIS999
.
          MATCH     KEY2,TCODE
          GOTO      ANDIS999 IF NOT EQUAL
.
          MATCH     "7",TCINDC1
          GOTO      ANDIS200 IF NOT EQUAL
.
          OPEN      PMSCCDA1,"pmsccdaf"
.
          MOVE      PURNO,PMCDURNO
          MOVE      ACODE,PMCDCTYP
          MOVE      PTMSX052,PMCDCNUM
          MOVE      SP70,PMCDEXDT  
.
          CALL      IBACLOCK
          PACK      PMCDCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMCDCDAT
          CLOCK     TIME,PMCDCTIM
          MOVE      USERID,PMCDCUID
          MOVE      PMCDCDAT,PMCDUDAT
          MOVE      PMCDCTIM,PMCDUTIM
          MOVE      PMCDCUID,PMCDUUID
.
          MOVE      SP70,PMCDDVAC
          MOVE      SP70,PMCDSPAR          
.
          PACK      KEY19,PMCDURNO,PMCDEXDT,PMCDCTYP,SP70
          CALL      RDPMCCD1
          IF        OVRCD=0
            GOTO      ANDIS910
          ENDIF            
.
          CALL      WRPMCCD1 
.
          GOTO      ANDIS990 
.
ANDIS910  MOVE      "pmsccdaf row already existed",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ANDIS990    
.
ANDIS990  CLOSE     PMSCCDA1     
.
ANDIS999  RETURN
.
.-------------------------------------------------------------------------------
. Maintain NDIS details  
.-------------------------------------------------------------------------------
NDIS0000  MATCH     "1",KIDSFLAG
          GOTO      NDIS9999 IF NOT EQUAL
.
          OPEN      PMSCCDA1,"pmsccdaf"
.
          MATCH     SP70,PTMSX052
          GOTO      NDIS5000 IF EQUAL
.
. Update PMCDCNUM if pmsccdaf row existed, otherwise insert a new row
.
NDIS2000  PACK      KEY19,PURNO,SP70
          CALL      RSPMCCD1
NDIS2200  CALL      RKPMCCD1
          BRANCH    OVRCD,NDIS2800
.
          MATCH     PURNO,PMCDURNO
          GOTO      NDIS2800 IF NOT EQUAL
.
          MOVE      "ct",KEY2
          PACK      KEY5,KEY2,PMCDCTYP,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,NDIS2200
.
          MATCH     "7",TCINDC1
          GOTO      NDIS2200 IF NOT EQUAL
.
          PACK      KEY19,PMCDURNO,PMCDEXDT,PMCDCTYP,SP70
          CALL      RDPMCCD1
.
          MOVE      PTMSX052,PMCDCNUM
          CALL      UPPMCCD1
          GOTO      NDIS8000
.
. Insert new row
.
NDIS2800  CLOSE     PMSCCDA1 
          CALL      ANDIS000  
          GOTO      NDIS9999
.
. Delete pmsccdaf row if existed
.
NDIS5000  PACK      KEY19,PURNO,SP70
          CALL      RSPMCCD1
NDIS5200  CALL      RKPMCCD1
          BRANCH    OVRCD,NDIS8000
.
          MATCH     PURNO,PMCDURNO
          GOTO      NDIS8000 IF NOT EQUAL
.
          MOVE      "ct",KEY2
          PACK      KEY5,KEY2,PMCDCTYP,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,NDIS5200
.
          MATCH     "7",TCINDC1
          GOTO      NDIS5200 IF NOT EQUAL
.
          PACK      KEY19,PMCDURNO,PMCDEXDT,PMCDCTYP,SP70
          CALL      DEPMCCD1
.
NDIS8000  CLOSE     PMSCCDA1    
.
NDIS9999  RETURN
.
.------------------------------------------------------------
. SETALT00 - Set an alternate ID UR number
.---------------------------------------------------------------------
SETALT00  MOVE      ZERO,EXIT
          PACK      KEY5,ANSA,ANSI,ALTIDTYP,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,SETALT90
.
          MATCH     SP70,TCINDC1
          GOTO      SETALT95 IF EQUAL
.
          PACK      LJUSCODE,SP70
.         PACK      DIM10,TCINDC1,URNUMBER,SP70
          CLEAR     DIM10
          APPEND    TCINDC1,DIM10
          MATCH     TCINDC3,SP1
          GOTO      SETALT10 IF EOS
          GOTO      SETALT10 IF EQUAL
.
          APPEND    TCINDC3,DIM10
SETALT10  APPEND    URNUMBER,DIM10
          RESET     DIM10
          SQUEEZE   DIM10
          MOVE      DIM10,LJUSCODE
          MOVE      "8",JUSTNO
          CALL      RJUS0000
          MOVE      RJUSCODE,URNUMBER
          GOTO      SETALT99
.
SETALT90  MOVE      "Invalid Alternate ID Type",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SETALT99
.
SETALT95  MOVE      "Indicator not set up for Alternate ID Type",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SETALT99
.
SETALT99  RETURN
+
.------------------------------------------------------------
. SETALI00 - Set an alternate ID
.---------------------------------------------------------------------
SETALI00  MOVE      ZERO,EXIT
          PACK      KEY5,ANSA,ANSI,ALTIDTYP,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,SETALI90
.
          MATCH     SP70,TCINDC1
          GOTO      SETALI95 IF EQUAL
.
          PACK      LJUSCODE,SP70
.         PACK      DIM21,TCINDC1,ALTERNID,SP70
          CLEAR     DIM21
          APPEND    TCINDC1,DIM21
          MATCH     TCINDC3,SP1
          GOTO      SETALI10 IF EOS
          GOTO      SETALI10 IF EQUAL
.
          APPEND    TCINDC3,DIM21
SETALI10  APPEND    ALTERNID,DIM21
          RESET     DIM21
          SQUEEZE   DIM21
          MOVE      DIM21,LJUSCODE
          MOVE      "20",JUSTNO
          CALL      RJUS0000
          MOVE      RJUSCODE,ALTERNID
.
          IF        CGENRUR=0
            MATCH     SP70,URNUMBER
            IF        @EQUAL
              MOVE      "8",JUSTNO
              CALL      RJUS0000
              MOVE      RJUSCODE,URNUMBER
            ENDIF
          ENDIF
          GOTO      SETALI99
.
SETALI90  MOVE      "Invalid Alternate ID Type",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SETALI99
.
SETALI95  MOVE      "Indicator not set up for Alternate ID Type",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SETALI99
.
SETALI99  RETURN
+
.------------------------------------------------------------
. NWALID00 - Write a new alternate ID record
.---------------------------------------------------------------------
NWALID00  PACK      PMAIURNO,PURNO,SP70
          PACK      PMAITYPE,ALTIDTYP,SP70
          IF        ALTIDFLG=1
            PACK      PMAIALID,SP12,PURNO,SP70
          ELSE
            PACK      PMAIALID,ALTERNID,SP70
          ENDIF
          PACK      PMAIDISU,SP70
          PACK      PMAIHOSP,SP70
          READ      CONTROLF,HUND10;*249,PTCNDAUR
          MATCH     "1",PTCNDAUR
          IF        @EQUAL
            MOVE      "1",PMAIDISU
          ENDIF
          PACK      PMAIRDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMAIRDAT
          UNPACK    SP70,PMAISPAR
.
          PACK      KEY31,PMAIURNO,PMAITYPE,PMAIALID,SP70
          CALL      RAPMAID1
          IF        OVRCD<>1
            GOTO      NWALID99
          ENDIF
.
          MOVE      USERID,PMAICRUD
          CALL      IBACLOCK
          PACK      PMAICRDT,CCC,CYY,CMM,CDD
          REP       " 0",PMAICRDT
          MOVE      CTIMEIS,PMAICRTM
          MOVE      SP70,PMAIUPDT
          MOVE      SP70,PMAIUPTM
          MOVE      SP70,PMAIUPUD
.
          CALL      WRPMAID1
.  write nsw edw record for UPI added
          PACK      KEY5,ANSA,ANSI,PMAITYPE,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            MATCH     ANSU,TCINDC4
            IF        @EQUAL
              MOVE      "16",PMEWTYPE
              PACK      PMEWNEWV,PMAIURNO,PMAITYPE,PMAIALID,SP70
              CALL      WREDW000
            ENDIF
          ENDIF
.
          CALL      PMIGTNID                   * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      THIRTY,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICUP                     * trigger PMI update message
.
NWALID99  RETURN
+
.------------------------------------------------------------
. GATUR000 - Generate Temporary U/R
.---------------------------------------------------------------------
.
GATUR000  COMPARE   ONE,PTCNNHII
          GOTO      GATUR500 IF EQUAL
.
          MOVE      " 80",PRXCODE
          CALL      GETSLK00
          READ      CONTROLF,EIGHTY;*223,PTCNNXTT   * Next temp NMPI
          ADD       ONE,PTCNNXTT                    * increment
          WRITAB    CONTROLF,EIGHTY;*223,PTCNNXTT   * write back to controlf
          CALL      RELSLK00
          MOVE      PTCNNXTT,F6
          MOVE      F6,KEY6
          REP       " 0",KEY6
          MOVE      "T-",KEY2            * Temp NHI Number Prefix with a #
          PACK      KEY8,KEY2,KEY6
          CALL      RDAMAST1            * Check for Temp Number on National
          COMPARE   ZERO,OVRCD
          GOTO      GATUR000 IF EQUAL   * U/R already exists
.
          MOVE      KEY8,PURNO
          GOTO      GATUR999
.
GATUR500  MOVE      " 80",PRXCODE
          CALL      GETSLK00
          READ      CONTROLF,EIGHTY;*223,PTCNNXTT   * Next temp NMPI
          ADD       ONE,PTCNNXTT                    * increment
          WRITAB    CONTROLF,EIGHTY;*223,PTCNNXTT   * write back to controlf
          CALL      RELSLK00
          MOVE      PTCNNXTT,F5
          MOVE      F5,KEY5
          REP       " 0",KEY5
          MOVE      "T-",KEY2            * Temp NHI Number Prefix with a #
          PACK      KEY7,KEY2,KEY5
          CALL      RANHMAS1            * Check for Temp Number on National
          COMPARE   ZERO,OVRCD
          GOTO      GATUR500 IF EQUAL   * U/R already exists
.
          PACK      KEY8,SP1,KEY2,KEY5
          CALL      RDAMAST1            * Check for Temp Number on National
          COMPARE   ZERO,OVRCD
          GOTO      GATUR500 IF EQUAL   * U/R already exists
.
          PACK      PURNO,SP1,KEY7
          MOVE      KEY7,NZIBNMPI
.
GATUR999  RETURN
+
.------------------------------------------------------------
. TMPNHI00 - Write new Temporary number to nhimasaf
. Returns:  EXIT  0 = Ok to continue
.                 1 = Error
.------------------------------------------------------------
.
TMPNHI00  MOVE      NZIBNMPI,KEY7
          MOVE      NZIBNMPI,NHMANMPI
          PACK      NHMAURNO,SP1,NZIBNMPI
.
          PACK      KEY8,NHMAURNO,SP70
          CALL      RANHMAS2
          COMPARE   ZERO,OVRCD
          GOTO      TMPNHI91 IF EQUAL
.
          CALL      RANHMAS1
          COMPARE   ZERO,OVRCD
          GOTO      TMPNHI92 IF EQUAL
.
          CALL      MVNHI000
          CLOCK     TIME,NHMATIM
          PACK      NHMADAT,CCC,CYY,CMM,CDD
          REP       " 0",NHMADAT
          CALL      WRNHMAS1      * Got there now write the record.
          MOVE      ONE,AUDTTYPE
          CALL      WANHMA00
.
          MOVE      ZERO,EXIT
          GOTO      TMPNHI99
.
TMPNHI91  CLEAR     WEBTITLE
          APPEND    "ERROR: Local UR ",WEBTITLE
          APPEND    KEY8,WEBTITLE
          APPEND    " Already Exists. - ",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      TMPNHI99
.
TMPNHI92  CLEAR     WEBTITLE
          APPEND    "ERROR: NHI HCU ID ",WEBTITLE
          APPEND    KEY7,WEBTITLE
          APPEND    " Already Exists. - ",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      TMPNHI99
.
TMPNHI99  RETURN
+
.------------------------------------------------------------
. MVNHI000 - Move NHI parameters for nhimasaf
.------------------------------------------------------------
.
MVNHI000  MOVE      PSNAME,NHMASURN
          MOVE      PGNAME,NHMAGIV1
          MOVE      PPSNAME,NHMAGIV2
          MOVE      SP70,NHMAGIV3
          MOVE      ONE,NHMAPREI
          MOVE      PADD1,NHMAADD1
          MOVE      PADD2,NHMAADD2
          MOVE      PSUBRB,NHMAADD3
          MOVE      PADD4,NHMAADD4
          MOVE      SP70,NHMAADD5
          MOVE      PBDATE,NHMADOB
          IF        PCEASE=0
            MOVE      SP70,NHMADDTH
          ELSE
            MOVE      PDECDTE,NHMADDTH
          ENDIF
          MOVE      PPOST,NHMADOMC
          MOVE      "Y",NHMARES
          MOVE      PSEX,NHMASEX
.
          MATCH     Z70,ETHNCTY1
          IF        !@EQUAL
            MOVE      ETHNCTY1,NHMAETH
          ELSE
            MOVE      SP70,NHMAETH
          ENDIF
.
          MATCH     Z70,ETHNCTY2
          IF        !@EQUAL
            MOVE      ETHNCTY2,NHMAETH2
          ELSE
            MOVE      SP70,NHMAETH2
          ENDIF
.
          MATCH     Z70,ETHNCTY3
          IF        !@EQUAL
            MOVE      ETHNCTY3,NHMAETH3
          ELSE
            MOVE      SP70,NHMAETH3
          ENDIF
.
MVNHI999  RETURN
+
.------------------------------------------------------------------------
. PPRV0000 - Post previous surname as an alias if desired - From PATPRG01
.------------------------------------------------------------------------
.
PPRV0000  BRANCH    PTPRVALS,PPRV0100        * parameter switched on
          GOTO      PPRV9999                 * parameter off
.
.         Check if we have a previous surname
.
PPRV0100  PACK      GSRSNAM,PPSNAME,SP70     * surname
          MATCH     GSRSNAM,SP70             * surname blank ?
          GOTO      PPRV9999 IF EQUAL        * yes, do nothing
.
.         Given name soundex file
.
PPRV5000  MOVE      PMPXFNAM,GSRGNAM
          MOVE      PMPXSNAM,PTGSGNM2
          MOVE      PBDATE,GSRDOB            * Date of birth
          MOVE      PSEX,GSRSEX              * Sex
          MOVE      PURNO,GSRURNO
          MOVE      ZEROVISN,GSRBILL
          MOVE      ZERO,GSRSYS
          CALL      SOUNDEX                  * get soundex key for surname
          CALL      SOUNDX2                  * get soundex key for given names
.
          PACK      KEY115,GSRURNO,GSRBILL,GSRSNAM,GSRGNAM,PTGSGNM2,GSRDOB:
                           GSRSEX
          CALL      RDPTGSR1                 * check if its already there
          BRANCH    OVRCD,PPRV6000
          GOTO      PPRV9999
.
.         Record does not exist, post it away
.
PPRV6000  CALL      WRPTGSR1
          MOVE      "28",PMEWTYPE
          PACK      PMEWOLDV,SP70
          PACK      DIM40,GSRSNAM,SP70
          PACK      KEY40,GSRGNAM,SP70
          PACK      PMEWNEWV,DIM40,SP1,KEY40,SP1,PTGSGNM2,SP70
          CALL      WREDW000
.
          MOVE      ONE,FORM1                     * inserting alias flag
          PACK      KEY115,GSRURNO,GSRBILL,GSRSNAM,GSRGNAM,PTGSGNM2,GSRDOB:
                           GSRSEX
.
          MOVE      TEN3,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICUA                      * send details to DG *C-90223
.
PPRV9999  RETURN
+
.-----------------------------------------------------------------
. Insert new U/R Comments - pmsuchaf/pmsucdaf for pre-admission.
. It first deletes all the comments and then copies them back
.-----------------------------------------------------------------
.
UPUCM000  IF        URCMTFLG <> 1
            GOTO      UPUCM999
          ENDIF
.
          MOVE      URCMTTYP,KEY3
          CALL      DLUCM000                  * delete ur comments
.
          IF        URCMTLIN = 0
            GOTO      UPUCM990
          ENDIF
.
          CALL      IBACLOCK
          PACK      CURRDATX,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATX
          CLOCK     TIME,CTIMEIS              * Set created timestamp
.
.         Insert UR comment header
.
UPUCM200  MOVE      PURNO,PMUHURNO            * set ur number
          MOVE      URCMTTYP,PMUHCTYP
          MOVE      ONE,F6
          MOVE      F6,PMUHCNUM
          MOVE      USERID,PMUHCUID  
          MOVE      CURRDATX,PMUHCDAT         * comment date
          MOVE      CTIMEIS,PMUHCTIM          * comment time
.
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          IF        OVRCD = 0
            MOVE      WBSEOCG,PMUHOCCG      * Occupation Group
          ELSE
            MOVE      SP70,PMUHOCCG
          ENDIF
.          
          MOVE      ZERO,PMUHDELT
          MOVE      SP70,PMUHDUID
          MOVE      SP70,PMUHDDAT
          MOVE      SP70,PMUHDTIM
          MOVE      SP70,PMUHDOCG
          MOVE      SP70,PMUHSPAR
.
          CALL      WRPMUCH1
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      COMFILAF,COMFILNM
          TRAPCLR   IO
          BRANCH    OVRCD,UPUCM999
.
.         Insert UR comment detail
.
          MOVE      ZERO,F3
          MOVE      F3,URTXUNIQ
UPUCM400  READ      COMFILAF,SEQ;PMUCCOMM
          GOTO      UPUCM990 IF OVER
.
          ADD       ONE,URTXUNIQ            * add to line number
.
          MOVE      PMUHURNO,PMUCURNO       * set admission number
          MOVE      PMUHCTYP,PMUCCTTY
          MOVE      PMUHCNUM,PMUCCNUM
          MOVE      URTXUNIQ,PMUCLNUM
          MOVE      SP70,PMUCSPAR
.
          PACK      KEY20,PMUCURNO,PMUCCTTY,PMUCCNUM,PMUCLNUM,SP70
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          CALL      WRPMUCD1
          TRAPCLR   IO
.
          IF        URTXUNIQ = 99
            GOTO      UPUCM990
          ENDIF
.
          GOTO      UPUCM400
.
UPUCM990  CLOSE     COMFILAF,DELETE
.
UPUCM999  RETURN
.
.-----------------------------------------------------------------------
. Delete all ur comments for a given ur type
.-----------------------------------------------------------------------
.
DLUCM000  PACK      KEY17,PURNO,KEY3,SP70
          CALL      RSPMUCH1
DLUCM100  CALL      RKPMUCH1
          BRANCH    OVRCD,DLUCM999
.
          MATCH     PURNO,PMUHURNO           * same ur Number?
          GOTO      DLUCM999 IF NOT EQUAL
.
          MATCH     PMUHCTYP,KEY3
          GOTO      DLUCM999 IF NOT EQUAL
.
          PACK      KEY17,PMUHURNO,PMUHCTYP,PMUHCNUM,SP70
          CALL      DEPMUCH1
.
          PACK      KEY20,PMUHURNO,PMUHCTYP,PMUHCNUM,SP70
          CALL      RSPMUCD1
DLUCM400  CALL      RKPMUCD1
          BRANCH    OVRCD,DLUCM100          * end of file
.
          MATCH     PMUHURNO,PMUCURNO       * same ur Number?
          GOTO      DLUCM100 IF NOT EQUAL
.
          MATCH     PMUHCTYP,PMUCCTTY
          GOTO      DLUCM100 IF NOT EQUAL
.
          MATCH     PMUHCNUM,PMUCCNUM
          GOTO      DLUCM100 IF NOT EQUAL
.
          PACK      KEY20,PMUCURNO,PMUCCTTY,PMUCCNUM,PMUCLNUM,SP70
          CALL      DEPMUCD1
          GOTO      DLUCM400
.
DLUCM999  RETURN
.
.-----------------------------------------------------------------
. Insert new Visit Comments - vismdtaf/vismtxaf for pre-admission.
. It first deletes all the comments and then copies them back
.-----------------------------------------------------------------
.
UPVCM000  IF        VSCMTFLG <> 1
            GOTO      UPVCM999
          ENDIF
.
          MOVE      VSCMTTYP,KEY3
.
          MATCH     "1",VISCOMIN
          IF        !@EQUAL
            CALL      DLVCM000                  * delete visit comments
          ENDIF
.
          IF        VSCMTLIN = 0
            GOTO      UPVCM999
          ENDIF
.
          CALL      IBACLOCK
          PACK      CURRDATX,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATX
          CLOCK     TIME,CTIMEIS              * Set created timestamp
.
.         Insert visit comment header
.
UPVCM200  MOVE      ONE,F6                  * Set note number
.
          MATCH     "1",VISCOMIN
          IF        @EQUAL
            PACK      KEY17,ADMISSNO,KEY3,Z70
            CALL      RSVSMDT1
            CALL      RPVSMDT1              * Find last note number
            BRANCH    OVRCD,UPVCM300
.
            MATCH    ADMISSNO,VSMDVISN
            GOTO     UPVCM300 IF NOT EQUAL
.
            MATCH    KEY3,VSMDTYPE
            GOTO     UPVCM300 IF NOT EQUAL
.
            MOVE     VSMDNOTE,F6
            ADD      ONE,F6
          ENDIF
.
UPVCM300  MOVE      ADMISSNO,VSMDVISN        * set admission number
          MOVE      VSCMTTYP,VSMDTYPE
          MOVE      F6,VSMDNOTE
.
          MOVE      CURRDATX,VSMDDATE           * Visit date
          MOVE      CTIMEIS,VSMDTIME           * Visit time
          MOVE      USERID,VSMDUSER 
.
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          IF        OVRCD = 0
            MOVE      WBSEOCG,VSMDOCCG      * Occupation Group
          ELSE
            MOVE      SP70,VSMDOCCG
          ENDIF
.          
          MOVE      ZERO,VSMDDELT
          MOVE      SP70,VSMDDDAT
          MOVE      SP70,VSMDDTIM
          MOVE      SP70,VSMDDUSE
          MOVE      SP70,VSMDDOCC
          MOVE      SP70,VSMDSPAR
.
          PACK      KEY17,VSMDVISN,VSMDTYPE,VSMDNOTE,SP70
          CALL      RAVSMDT1
          IF        OVRCD=1
            CALL      WRVSMDT1
          ENDIF
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      COMVISAF,COMVISNM
          TRAPCLR   IO
          BRANCH    OVRCD,UPVCM999
.
.         Insert visit comment details
.
          MOVE      ZERO,F3
          MOVE      F3,VSTXUNIQ
UPVCM400  READ      COMVISAF,SEQ;VSMTCMNT
          GOTO      UPVCM990 IF OVER
.
          ADD       ONE,VSTXUNIQ            * add to line number
.
          MOVE      VSMDVISN,VSMTVISN       * set admission number
          MOVE      VSMDTYPE,VSMTTYPE
          MOVE      VSMDNOTE,VSMTNOTE
          MOVE      VSTXUNIQ,VSMTUNIQ
          MOVE      SP70,VSMTSPAR

          PACK      KEY20,VSMTVISN,VSMTTYPE,VSMTNOTE,VSMTUNIQ,SP70
          CALL      RAVSMTX1
          IF        OVRCD=1
            CALL      WRVSMTX1
          ENDIF
.
          IF        VSTXUNIQ = 99
            GOTO      UPVCM990
          ENDIF
.
          GOTO      UPVCM400
.
UPVCM990  CLOSE     COMVISAF,DELETE
.
UPVCM999  RETURN
.
.-----------------------------------------------------------------------
. Delete all visit comments for a given visit type
.-----------------------------------------------------------------------
.
DLVCM000  PACK      KEY17,ADMISSNO,KEY3,SP70
          CALL      RSVSMDT1
DLVCM100  CALL      RKVSMDT1
          BRANCH    OVRCD,DLVCM999
.
          MATCH     ADMISSNO,VSMDVISN       * same Admission Number?
          GOTO      DLVCM999 IF NOT EQUAL
.
          MATCH     VSMDTYPE,KEY3
          GOTO      DLVCM999 IF NOT EQUAL
.
          PACK      KEY17,VSMDVISN,VSMDTYPE,VSMDNOTE,SP70
          CALL      DEVSMDT1
.
          PACK      KEY20,VSMDVISN,VSMDTYPE,VSMDNOTE,SP70
          CALL      RSVSMTX1
DLVCM400  CALL      RKVSMTX1
          BRANCH    OVRCD,DLVCM100          * end of file
.
          MATCH     VSMDVISN,VSMTVISN       * same Admission Number?
          GOTO      DLVCM100 IF NOT EQUAL
.
          MATCH     VSMDTYPE,VSMTTYPE
          GOTO      DLVCM100 IF NOT EQUAL
.
          MATCH     VSMDNOTE,VSMTNOTE
          GOTO      DLVCM100 IF NOT EQUAL
.
          PACK      KEY20,VSMTVISN,VSMTTYPE,VSMTNOTE,VSMTUNIQ,SP70
          CALL      DEVSMTX1
          GOTO      DLVCM400
.
DLVCM999  RETURN
+
.------------------------------------------------------------
. UPDALI00 - Add or Delete Alias
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
.
UPDALI00  MOVE      URNUMBER,KEY8
          CALL      RLPTMAS1                     * record found ?
          BRANCH    OVRCD,UPDALI94:              * no
                          UPDALI93               * yes, but already locked
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          BRANCH    OVRCD,UPDALI94
.
          MATCH     "D",ADDORDEL
          GOTO      UPDALI50 IF EQUAL
.
          MATCH     "A",ADDORDEL
          GOTO      UPDALI92 IF NOT EQUAL
.
          MATCH     SP70,SRCHSNAM
          GOTO      UPDALI92 IF EQUAL
.
          MATCH     SP70,SRCHGNAM
          GOTO      UPDALI92 IF EQUAL
.
          PACK      GSRSNAM,SRCHSNAM,SP70
          PACK      GSRGNAM,SRCHGNAM,SP70
          PACK      PTGSGNM2,SRCHMNAM,SP70
.
          MOVE      PURNO,GSRURNO
          MOVE      ZEROVISN,GSRBILL
.
.         If DOB is not entered, they should be default from master details
.
          PACK      SRCHPDOB,SRCHPDOB,SP70
          MATCH     SP70,SRCHPDOB
          IF        @EQUAL
            MOVE      PBDATE,GSRDOB           * Date of birth from master file
          ELSE
            MOVE      SRCHPDOB,GSRDOB         * Date of birth
          ENDIF
.
.         If Sex is not entered, they should be default from master details
.
          PACK      SRCHPSEX,SRCHPSEX,SP70
          MATCH     SP1,SRCHPSEX
          IF        @EQUAL
            MOVE      PSEX,GSRSEX                * Sex from master file
          ELSE
            MOVE      SRCHPSEX,GSRSEX            * Sex
          ENDIF
.
          CALL      SOUNDEX               * get surname soundex
          CALL      SOUNDX2               * get given name soundex
.
          PACK      KEY115,GSRURNO,GSRBILL,GSRSNAM,GSRGNAM,PTGSGNM2,GSRDOB:
                           GSRSEX
          CALL      RDPTGSR1
          BRANCH    OVRCD,UPDALI40
.
          GOTO      UPDALI91
.
UPDALI40  CALL      WRPTGSR1
.
          MOVE      "005",D3
          MOVE      ANSA,ALIASSTS
          CALL      WDAU0000       
.
          CALL      PMIGTNID                   * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TWENTY7,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICUP                     * trigger PMI update message
.
.          PACK      KEY8,PURNO,SP70
.          CALL      RDPMPX21
.          IF        OVRCD=0
.            MOVE      GSRSNAM,PMPXPFSN
.            MOVE      GSRGNAM,PMPXPFGN
.            CALL      UPPMPX21
.          ENDIF
.
          MOVE      ONE,FORM1                     * inserting alias flag
          PACK      KEY115,GSRURNO,GSRBILL,GSRSNAM,GSRGNAM,PTGSGNM2,GSRDOB:
                           GSRSEX
          MOVE      TEN4,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICUA                      * send details to DG *C-90223
.
          MOVE      "28",PMEWTYPE
          PACK      PMEWOLDV,SP70
          PACK      DIM40,GSRSNAM,SP70
          PACK      KEY40,GSRGNAM,SP70
          PACK      PMEWNEWV,DIM40,SP1,KEY40,SP1,PTGSGNM2,SP70
          CALL      WREDW000
.
          GOTO      UPDALI90
.
UPDALI50  CALL      DELNEW00
.
          MOVE      "005",D3
          MOVE      ANSD,ALIASSTS
          CALL      WDAU0000
.
UPDALI90  CALL      UUPTMAS1
          MOVE      ZERO,EXIT
          GOTO      UPDALI99
.
UPDALI91  MOVE      "This Alias is Already on File",WEBTITLE
          CALL      WEBERR00
          CALL      UUPTMAS1
          MOVE      ONE,EXIT
          GOTO      UPDALI99
.
UPDALI92  MOVE      "Surname & Given name required",WEBTITLE
          CALL      WEBERR00
          CALL      UUPTMAS1
          MOVE      ONE,EXIT
          GOTO      UPDALI99
.
UPDALI93  CLEAR     WEBTITLE
          APPEND    "Patient is Locked on Port ",WEBTITLE
          APPEND    PPORT,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDALI99
.
UPDALI94  MOVE      "Patient master record not found",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDALI99
.
UPDALI99  RETURN
+
.------------------------------------------------------------
. DELNEW00 - Delete Alias new index
.------------------------------------------------------------
.
DELNEW00  MOVE      PURNO,GSRURNO
          PACK      KEY115,GSRURNO,SP70,SP70
          CALL      RSPTGSR1
DELNEW10  CALL      RKPTGSR1
          BRANCH    OVRCD,DELNEW99
.
          MATCH     GSRURNO,PURNO
          GOTO      DELNEW99 IF NOT EQUAL
.
.                                      * substitute apostrophe with    *I-44617
.                                      * %60 for comparison as         *I-44617
.                                      * Srch strings were substituted *I-44617
.                                      * earlier.                      *I-44617
          MOVE      GSRSNAM,SURNAME                                    *I-44617
          MOVE      GSRGNAM,GIVNAME                                    *I-44617
          MOVE      PTGSGNM2,GIVNAM2
          CALL      JAVNAM00                                           *I-44617
          MATCH     JAVSNAME,SRCHSNAM                                  *I-44617
          GOTO      DELNEW10 IF NOT EQUAL                              *I-44617
.
          MATCH     JAVGNAME,SRCHGNAM                                  *I-44617
          GOTO      DELNEW10 IF NOT EQUAL                              *I-44617
.                                                                      *D-44617
          MATCH     JAVGNAM2,SRCHMNAM
          GOTO      DELNEW10 IF NOT EQUAL
.
          MATCH     GSRDOB,DELALDOB
          GOTO      DELNEW10 IF NOT EQUAL
.
          MATCH     GSRSEX,SRCHPSEX
          IF        !@EQUAL
            MATCH     SP70,SRCHPSEX
            GOTO      DELNEW10 IF NOT EQUAL
          ENDIF
.
          CALL      PMIGTNID                   * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TWENTY6,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICUP                     * trigger PMI update message
.
          PACK      KEY115,GSRURNO,GSRBILL,GSRSNAM,GSRGNAM,PTGSGNM2,GSRDOB:
                           GSRSEX
          CALL      DEPTGSR1
.  write nsw edw record for alias deleted
            MOVE      "27",PMEWTYPE
            PACK      PMEWOLDV,GSRSNAM,GSRGNAM,PTGSGNM2,GSRDOB,GSRSEX,SP70
            PACK      PMEWNEWV,SP70
            CALL      WREDW000
.
.
.          MATCH     GSRSNAM,PMPXPFSN
.          IF        @EQUAL
.            MATCH     GSRGNAM,PMPXPFGN
.            IF        @EQUAL
.              PACK      KEY8,PURNO,SP70
.              CALL      RDPMPX21
.              IF        OVRCD=0
.                MOVE      SP70,PMPXPFSN
.                MOVE      SP70,PMPXPFGN
.                CALL      UPPMPX21
.              ENDIF
.            ENDIF
.          ENDIF
.
          MOVE      TWO,FORM1                     * deleting alias flag
          PACK      KEY115,GSRURNO,GSRBILL,GSRSNAM,GSRGNAM,PTGSGNM2,GSRDOB:
                           GSRSEX
          MOVE      TEN5,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICUA                      * send details to DG *C-90223
.
          MOVE      ZERO,EXIT
.
DELNEW99  RETURN
+
.------------------------------------------------------
. TABL0000 - Routine used to list the Aliases
.------------------------------------------------------
.
TABL0000  BRANCH    FLDITMNO,TABL0100,TABL0200,TABL0300,TABL0400,TABL0500
          GOTO      TABL9999
.
TABL0100  CALL      LSTALI00
          GOTO      TABL9999
.
TABL0200  WRITE     HTMLFILE;URNUMBER
          GOTO      TABL9999
.
TABL0300  CALL      LSTALB00    *alias table without DOB & Sex
          GOTO      TABL9999
.
TABL0400  CALL      LSTALV00    * List Alias View Only Records
          GOTO      TABL9999
.
TABL0500  CALL      LMDCLD00
          GOTO      TABL9999
.
TABL9999  RETURN

+
.----------------------------------
. SFAL0000
.----------------------------------
.
SFAL0000  BRANCH    FLDITMNO,SFAL0100,SFAL0200,SFAL0300,SFAL0400,SFAL0500:
                             SFAL0600,SFAL0700,SFAL0800,SFAL0900,SFAL1000:
                             SFAL1100,SFAL1200,SFAL1300,SFAL1400,SFAL1500:
                             SFAL1600,SFAL1700,SFAL1800,SFAL1900,SFAL2000:
                             SFAL2100,SFAL2200,SFAL2300,SFAL2400,SFAL2500:
                             SFAL2600,SFAL2700,SFAL2800,SFAL2900,SFAL3000:
                             SFAL3100,SFAL3200,SFAL3300,SFAL3400,SFAL3500:
                             SFAL3600,SFAL3700,SFAL3800,SFAL3900,SFAL4000:
                             SFAL4100,SFAL4200,SFAL4300,SFAL4400,SFAL4500:
                             SFAL4600,SFAL4700,SFAL4800,SFAL4900,SFAL5000:
                             SFAL5100,SFAL5200,SFAL5300,SFAL5400,SFAL5500:
                             SFAL5600,SFAL5700,SFAL5800,SFAL5900,SFAL6000:
                             SFAL6100,SFAL6200,SFAL6300,SFAL6400,SFAL6500:
                             SFAL6600,SFAL6700,SFAL6800,SFAL6900,SFAL7000:
                             SFAL7100,SFAL7200,SFAL7300,SFAL7400,SFAL7500:
                             SFAL7600,SFAL7700,SFAL7800,SFAL7900,SFAL8000:
                             SFAL8100,SFAL8200,SFAL8300,SFAL8400,SFAL8500:
                             SFAL8600,SFAL8700,SFAL8800,SFAL8900,SFAL9000:
                             SFAL9100,SFAL9200,SFAL9300,SFAL9400,SFAL9500:
                             SFAL9600,SFAL9700,SFAL9800,SFAL9900
.
SFAL0100  MOVE      AADMNO,PTAFADMN
          OPEN      PATSFAA1,"patsfaaf"
          MOVE      "A",PTAFTYPE
          MOVE      SP8,PTAFDATE
          MOVE      SP8,PTAFTIME
          MOVE      SP70,PTAFSPAR
.
          PACK      KEY25,PTAFADMN,PTAFTYPE,PTAFDATE,PTAFTIME
          CALL      RSPTASF1                * Read an admin SFA file record
SFAL0110  CALL      RKPTASF1                * Reading the next record
          BRANCH    OVRCD,SFAL9999
.
          PACK      KEY1,PTAFCODE,SP3
          CALL      RDPTSFA1
          BRANCH    OVRCD,SFAL9999
.
          WRITE     HTMLFILE;"<option value=",PTAFCODE,">",PTSFDESC,"</option>";
          GOTO      SFAL0110
.
SFAL0200  WRITE     HTMLFILE;MVMEDREC;
          GOTO      SFAL9999
.
SFAL0300  WRITE     HTMLFILE;WLFLAG;
          GOTO      SFAL9999
.
SFAL0400  WRITE     HTMLFILE;BKFLAG;
          GOTO      SFAL9999
.
SFAL0500  WRITE     HTMLFILE;CURRFLAG;
          GOTO      SFAL9999
.
SFAL0600  OPEN      CONTROLF,"controlf"
          READ      CONTROLF,SIXTY;*105,MRCNHMTY
          PACK      KEY7,SP70                                         *C-240724
          CALL      RSMRLOC1
SFAL0610  CALL      RKMRLOC1
          BRANCH    OVRCD,SFAL9999
.
          MATCH     MRLOTYPE,MRCNHMTY
          GOTO      SFAL0610 IF NOT EQUAL
.
          MATCH     WBSEHLOC,MRLOCODE
          IF        @EQUAL
            MATCH     SP4,MRLOHOSP                                    *I-240724
            GOTO      SFAL0611 IF NOT EQUAL
            WRITE     HTMLFILE;"<option value=#"",MRLOCODE,"#" selected>":
                               MRLODESC,"</option>"
          ELSE
SFAL0611    IF        IBCNMHOS=1
              MATCH     WBSEHOSP,MRLOHOSP
              GOTO      SFAL0610 IF NOT EQUAL
            ENDIF
            WRITE     HTMLFILE;"<option value=#"",MRLOCODE,"#">",MRLODESC:
                               "</option>"
          ENDIF
          GOTO      SFAL0610
.
SFAL0700  WRITE     HTMLFILE;CASEKEYS;
          GOTO      SFAL9999
.
SFAL0800  WRITE     HTMLFILE;PREAFLAG;
          GOTO      SFAL9999
.
SFAL0900  READ      CONTROLF,TWENTY1;*238,PTCNAGEC
          WRITE     HTMLFILE;PTCNAGEC;
          GOTO      SFAL9999
.
SFAL1000  MATCH     "1",PMPXEDOB
          IF        @EQUAL
            WRITE     HTMLFILE;"Yes";
          ELSE
            WRITE     HTMLFILE;"No";
          ENDIF
          GOTO      SFAL9999
.
SFAL1100  PACK      KEY6,SP70
          CALL      RDSWARD1
SFAL1120  CALL      RDKWARD1
          BRANCH    OVRCD,SFAL9999
.
          MATCH     SP70,WEFRBT
          GOTO      SFAL1120 IF EQUAL
.
          PACK      KEY5,ANSB,ANST,WEFRBT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,SFAL1120
.
          MATCH     ANSE,TCINDC11
          GOTO      SFAL1120 IF NOT EQUAL
.
          WRITE     HTMLFILE;WWARD;
          GOTO      SFAL9999
.
SFAL1200  CALL      CANDET00                * Process Cancellation Details
          GOTO      SFAL9999
.
SFAL1300  WRITE     HTMLFILE;WTCNUSBC;
          GOTO      SFAL9999
.
. Tags for Admission in Emergency
.
SFAL1400  MOVE      "AC",CATEGORY
          MOVE      EMVIUNIT,CODE
          CALL      CODITM00
          GOTO      SFAL9999
.
SFAL1500  MOVE      "CL",CATEGORY
          MOVE      EMVICOMP,CODE
          CALL      CODITM00
          GOTO      SFAL9999
.
SFAL1600  MOVE      EMVIDOCT,DOCTCODE
          CALL      DOCDET00
          GOTO      SFAL9999
.
SFAL1700  WRITE     HTMLFILE;EMVIEWRD;
          GOTO      SFAL9999
.
SFAL1800  WRITE     HTMLFILE;SESSKEYS;
          GOTO      SFAL9999
.
SFAL1900  WRITE     HTMLFILE;NOOFDAYS;
          GOTO      SFAL9999
.
SFAL2000  WRITE     HTMLFILE;THEAFLAG;
          GOTO      SFAL9999
.
SFAL2100  WRITE     HTMLFILE;OTHRCONT;
          GOTO      SFAL9999
.
SFAL2200  WRITE     HTMLFILE;MHCNUDSA;
          GOTO      SFAL9999
.
SFAL2300  COMPARE   ONE,MHCNUSE
          GOTO      SFAL2350 IF NOT EQUAL
.
          PACK      KEY8,AADMNO
          CALL      RAMHVIS1
          BRANCH    OVRCD,SFAL2350
.
          WRITE     HTMLFILE;ONE;
          GOTO      SFAL9999
.
SFAL2350  WRITE     HTMLFILE;ZERO;
          GOTO      SFAL9999
.
SFAL2400  WRITE     HTMLFILE;ASTAT;
          GOTO      SFAL9999
.
SFAL2500  WRITE     HTMLFILE;PTCNUEOC;          * Using episode of care
          GOTO      SFAL9999
.
SFAL2600  WRITE     HTMLFILE;EMRVISIT;          * Emr visit number for admit a
          GOTO      SFAL9999                    * pre admission
.
SFAL2700  WRITE     HTMLFILE;SERIFLAG;          * Outpatient series booking flag
          GOTO      SFAL9999                    * to post multiple claim details
.
SFAL2800  WRITE     HTMLFILE;FIRSTADM;          * Outpatient multiple HCP
          GOTO      SFAL9999                    * first booking admiss no
.
SFAL2900  WRITE     HTMLFILE;PTCNHDPS;          * I CAR 43413
          GOTO      SFAL9999
.
SFAL3000  WRITE     HTMLFILE;PTCNHPCD;          * I CAR 44809
          GOTO      SFAL9999
.
SFAL3100  WRITE     HTMLFILE;WAITFLAG;
          GOTO      SFAL9999
.
SFAL3200  MOVE      ZERO,FORM1                 * default to No bedfee display
          COMPARE   ZERO,CFEETYP
          GOTO      SFAL3280 IF NOT EQUAL      * not using bed fees
          MOVE      CFINAN,FORM1
SFAL3280  WRITE     HTMLFILE;FORM1;
          GOTO      SFAL9999
.
SFAL3300  WRITE     HTMLFILE;RETURNCD;          * return code indicator
          GOTO      SFAL9999
.
SFAL3400  MOVE      ZERO,BLANKEXP      * allow blank expiry date (1=yes/0=no)
          PROC      CHKCCD00
          WRITE     HTMLFILE;EXIT;              * concession card indicator
          GOTO      SFAL9999
.
SFAL3500  CALL      EMRCTP00                    * default EMR adm.date
          BRANCH    EXIT,SFAL3510
          UNPACK    CTYPDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      SFAL9999
SFAL3510  MOVE      CMM,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          MOVE      CYY,CYEAR
          REP       " 0",CYEAR
          MOVE      CDD,KEY2
          REP       " 0",KEY2
          WRITE     HTMLFILE;KEY2,SP1,MTHNAM3,SP1,CCC,CYEAR;
          GOTO      SFAL9999
.
SFAL3600  CALL      EMRCTP00                    * default EMR adm.time
          BRANCH    EXIT,SFAL3610
          WRITE     HTMLFILE;CTYPTIME;
          GOTO      SFAL9999
SFAL3610  CLOCK     TIME,CTIMEIS
          WRITE     HTMLFILE;CTIMEIS;
          GOTO      SFAL9999
.
SFAL3700  MOVE      "N",PTMICMXP
          LOAD      PTMICMXP,PTCNCMYN,ANSY   * Default for C/P from paramter
.
          MATCH     "Y",PTMICMXP
          IF        @EQUAL
            WRITE    HTMLFILE;"<option value='1' selected>":
                              "Yes</option>":
                              "<option value='0'>":
                              "No</option>";
          ELSE
            WRITE    HTMLFILE;"<option value='0' selected>":
                              "No</option>":
                              "<option value='1'>":
                              "Yes</option>";
          ENDIF
          GOTO      SFAL9999
.
SFAL3800  UNPACK    PBDATE,CCENT,CYEAR,CMON,CDAY
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          CALL      CALCAGE
          WRITE     HTMLFILE;PSAGEYRS;
          GOTO      SFAL9999
.
SFAL3900  WRITE     HTMLFILE;SHOWFLAG;
          GOTO      SFAL9999
.
SFAL4000  WRITE     HTMLFILE;REFRFLAG;
          GOTO      SFAL9999
.
SFAL4100  WRITE     HTMLFILE;NEWBORNF;
          GOTO      SFAL9999
.
SFAL4200  WRITE     HTMLFILE;OTPTFLAG;
          GOTO      SFAL9999
.
SFAL4300  MOVE      "C ",CATEGORY
          MOVE      PMRSCONT,CODE
          CALL      CODITM00
          GOTO      SFAL9999
.
SFAL4400  MATCH     SP70,PMRSTEXP
          GOTO      SFAL9999 IF EQUAL
          UNPACK    PMRSTEXP,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      SFAL9999
.
SFAL4500  MATCH     SP70,PMRSGRDT
          GOTO      SFAL9999 IF EQUAL
          UNPACK    PMRSGRDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      SFAL9999
.
SFAL4600  WRITE     HTMLFILE;PMRSCOMM;
          GOTO      SFAL9999
.
SFAL4700  CALL      CHKRES00             * Check for residency expiry
          WRITE     HTMLFILE;EXIT;
          GOTO      SFAL9999
.                                                                      *I-86040
SFAL4800  PROC      CHKCER00
          WRITE     HTMLFILE;EXIT;              * Certificate indicator
          GOTO      SFAL9999
.
SFAL4900  WRITE     HTMLFILE;ALEMRFLG;
          GOTO      SFAL9999
.
SFAL5000  WRITE     HTMLFILE;AINVPRT;
          GOTO      SFAL9999
.
SFAL5100  MATCH     SP70,PMRSVISN
          GOTO      SFAL9999 IF EQUAL
.
          WRITE     HTMLFILE;PMRSVISN;
          GOTO      SFAL9999
.
SFAL5200  WRITE     HTMLFILE;ALTERNAT;
          GOTO      SFAL9999
.
SFAL5300  WRITE     HTMLFILE;REGIFLAG;
          GOTO      SFAL9999
.
SFAL5400  MATCH     "1",PTCNEPAY
          GOTO      SFAL9999 IF NOT EQUAL
.
          PACK      KEY14,URNUMBER,SP70
          CALL      RSPMPAY1
          CALL      RKPMPAY1
          BRANCH    OVRCD,SFAL9999
.
          MATCH     URNUMBER,PMPAURNO
          GOTO      SFAL9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;ONE;
.
          GOTO      SFAL9999
.
SFAL5500  UNPACK    DIM127,KEY1,FLDITEM,DIM127
          MOVE      FLDITEM,FLDITMNO
          CALL      NZSP0000            * Output nzpspraf fields
          GOTO      SFAL9999
.
SFAL5600  WRITE     HTMLFILE;PTCNDEES;
          GOTO      SFAL9999
.
SFAL5700  WRITE     HTMLFILE;REFRLVIS;
          GOTO      SFAL9999
.
SFAL5800  WRITE     HTMLFILE;BOOKFLAG;
          GOTO      SFAL9999
.
SFAL5900  WRITE     HTMLFILE;RESIDADM;
          GOTO      SFAL9999
.
SFAL6000  WRITE     HTMLFILE;REFVISNO;
          GOTO      SFAL9999
.
SFAL6100  CALL      TABD0000                  * ACC Diagnosis List
          GOTO      SFAL9999
.
SFAL6200  CALL      NEXTDD00                  * Next Diagnosis List
          GOTO      SFAL9999
.
SFAL6300  CALL      PREVDD00                  * Prev Diagnosis List
          GOTO      SFAL9999
.
SFAL6400  CALL      TABR0000                  * ACC Referral List
          GOTO      SFAL9999
.
SFAL6500  CALL      NEXTRD00                  * Next Referral List
          GOTO      SFAL9999
.
SFAL6600  CALL      PREVRD00                  * Prev Referral List
          GOTO      SFAL9999
.
SFAL6700  CALL      GETV0000                  * Get Diagnosis/Ref FD values
          GOTO      SFAL9999
.
SFAL6800  MOVE      "001",COMMTYPE
          CALL      GETACC00                 * Get Cause of Injury Comments
          GOTO      SFAL9999
.
SFAL6900  MOVE      "002",COMMTYPE
          CALL      GETACC00                 * Get Additional Injury Comments
          GOTO      SFAL9999
.
SFAL7000  MOVE      "003",COMMTYPE
          CALL      GETACC00                 * Get Alt Work Restrictions Cmts
          GOTO      SFAL9999
.
SFAL7100  ******* Removed     **********
          GOTO      SFAL9999
.
SFAL7200  WRITE     HTMLFILE;SYSTFLAG;
          GOTO      SFAL9999
.
SFAL7300  CALL      GETRGM00
          GOTO      SFAL9999
.
SFAL7400  WRITE     HTMLFILE;ACCFFLAG;
          GOTO      SFAL9999
.
SFAL7500  PACK      KEY23,WCCLMNO,SP70       * injury diagnosis flag
          CALL      RSACDIA1
          CALL      RKACDIA1
          BRANCH    OVRCD,SFAL9999
.
          MATCH     WCCLMNO,ACDIACCN      * same ACC Number?
          GOTO      SFAL9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;ONE;
          GOTO      SFAL9999
.
SFAL7600  PACK      KEY23,WCCLMNO,SP70       * referral details flag
          CALL      RSACRFP1
          CALL      RKACRFP1
          BRANCH    OVRCD,SFAL9999
.
          MATCH     WCCLMNO,ACRFACCN      * same ACC Number?
          GOTO      SFAL9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;ONE;
          GOTO      SFAL9999
.
SFAL7700  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,SFAL7710,SFAL7720
.
          MOVE      PTELSPEA,KEY1
          CALL      SPEA0000
          GOTO      SFAL9999
.
SFAL7710  MOVE      SP70,KEY5
          MATCH     "1",PTELSPEA
          IF        @EQUAL
            MOVE      YES,KEY5
          ENDIF
          MATCH     "0",PTELSPEA
          IF        @EQUAL
            MOVE      NO,KEY5
          ENDIF
          MATCH     "2",PTELSPEA
          IF        @EQUAL
            MOVE      "Query",KEY5
          ENDIF
          WRITE     HTMLFILE;KEY5;
          GOTO      SFAL9999
.
SFAL7720  WRITE     HTMLFILE;PTELSPEA;
          GOTO      SFAL9999
.
SFAL7800  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,SFAL7810,SFAL7820
.
          MOVE      PTELEADM,KEY1
          CALL      DNOYES00              * Yes/No option
          GOTO      SFAL9999
.
SFAL7810  MOVE      SP3,YESNO
          MATCH     "1",PTELEADM
          IF        @EQUAL
            MOVE      YES,YESNO
          ENDIF
          MATCH     "0",PTELEADM
          IF        @EQUAL
            MOVE      NO,YESNO
          ENDIF
          WRITE     HTMLFILE;YESNO;
          GOTO      SFAL9999
.
SFAL7820  WRITE     HTMLFILE;PTELEADM;
          GOTO      SFAL9999
.
SFAL7900  WRITE     HTMLFILE;WCFLAG;
          GOTO      SFAL9999
.
SFAL8000  UNPACK    DIM127,D1,KEY3,DIM127
          MOVE      KEY3,FLDITMNO
          CALL      PMCE0000                * Extra contact tags
          GOTO      SFAL9999
.
SFAL8100  MATCH     SP70,PTCNAADR
          GOTO      SFAL9999 IF EQUAL
.
          MATCH     "000",PTCNAADR
          GOTO      SFAL9999 IF EQUAL
.
          PACK      KEY5,CATTC,PTCNAADR,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,SFAL9999
.
          WRITE     HTMLFILE;TDESC;         * Extra contact category
          GOTO      SFAL9999
.
SFAL8200  WRITE     HTMLFILE;MOTHADMN;
          GOTO      SFAL9999
.
SFAL8300  WRITE     HTMLFILE;BOARDERF;
          GOTO      SFAL9999
.
SFAL8400  CALL      LEMR0000                * Check for link to ed visit
          GOTO      SFAL9999
.
SFAL8500  PACK      KEY14,ADMISSNO,ZERO,ZERO,FIVE,SP70
          CALL      RSEMVCD1
SFAL8510  CALL      RKEMVCD1
          BRANCH    OVRCD,SFAL9999
.
          MATCH     ADMISSNO,EMVCVIST
          GOTO      SFAL9999 IF NOT EQUAL
.
          MATCH     "005",EMVCTYPE          * Emergency diagnosis ?
          GOTO      SFAL9999 IF NOT EQUAL
.
          MATCH     "000",EMVCSEQU          * Primary diagnosis
          GOTO      SFAL9999 IF NOT EQUAL
.
          MATCH     SP100,EMVCFTXT
          GOTO      SFAL8520 IF EQUAL
          GOTO      SFAL8520 IF EOS
.
          WRITE     HTMLFILE;EMVCFTXT;
          GOTO      SFAL9999
.
SFAL8520  MOVE      EMVCMNCD,KEY9
          CALL      RDEMICD1
          BRANCH    OVRCD,SFAL9999
.
          WRITE     HTMLFILE;EMICDESC;
          GOTO      SFAL9999
.
SFAL8600  PACK      KEY20,ADMISSNO,VSCMTTYP,SP70 
          CALL      RSVSMTX1
SFAL8610  CALL      RKVSMTX1
          BRANCH    OVRCD,SFAL8650
.
          MATCH     ADMISSNO,VSMTVISN 
          GOTO      SFAL8650 IF NOT EQUAL
.
          MATCH     VSCMTTYP,VSMTTYPE
          GOTO      SFAL8650 IF NOT EQUAL
.
          WRITE     HTMLFILE;VSMTCMNT
          GOTO      SFAL8610
.
SFAL8650  PACK      KEY31,ADMISSNO,SP70
          CALL      RSOPDEA2
          CALL      RKOPDEA2
          BRANCH    OVRCD,SFAL9999
. 
          MATCH     ADMISSNO,OPDAADMN
          GOTO      SFAL9999 IF NOT EQUAL
.
          OPEN      OPRDEDA1,"oprdedaf"
          MOVE      "009",DIM3
          PACK      KEY16,OPDAUNIQ,DIM3,SP70
          CALL      RSOPDED1
SFAL8660  CALL      RKOPDED1
          BRANCH    OVRCD,SFAL8699
.
          MATCH     OPDDUNIQ,OPDAUNIQ
          GOTO      SFAL8699 IF NOT EQUAL
.
          MATCH     "009",OPDDTYPE
          GOTO      SFAL8699 IF NOT EQUAL
.
          STRIP     OPDDDATA
          MOVELPTR  OPDDDATA,LENGTH
.
          SFORMAT   VAR,LENGTH
          MOVE      OPDDDATA,VAR
.
          WRITE     HTMLFILE;VAR
          SFORMAT   VAR,127
.
          GOTO      SFAL8660
.
SFAL8699  CLOSE     OPRDEDA1
          GOTO      SFAL9999
.
SFAL8700  MATCH     SP70,OBADATE
          GOTO      SFAL9999 IF EQUAL
.
          UNPACK    OBADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      SFAL9999
.
SFAL8800  MOVE      "CL",CATEGORY
          MOVE      OBACOMP,CODE
          CALL      CODITM00
          GOTO      SFAL9999
.
SFAL8900  MATCH     SP70,EMVIDATE
          GOTO      SFAL9999 IF EQUAL
.
          UNPACK    EMVIDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      SFAL9999
.

SFAL9000  PACK      KEY32,URNUMBER,Z70
          CALL      RSMHDLS1
          CALL      RPMHDLS1
          BRANCH    OVRCD,SFAL9999
.
          MATCH     MHDLURNO,URNUMBER
          GOTO      SFAL9999 IF NOT EQUAL
.
          UNPACK    MHDLSDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
.
          GOTO      SFAL9999
.
SFAL9100  WRITE     HTMLFILE;RECURRFL;
          GOTO      SFAL9999
.
SFAL9200  WRITE     HTMLFILE;BATCHNUM;
          GOTO      SFAL9999
.
SFAL9300  WRITE     HTMLFILE;WBSESIT;
          GOTO      SFAL9999
.
SFAL9400  WRITE     HTMLFILE;DISCFLAG;
          GOTO      SFAL9999
.
SFAL9500  CALL      DISSEL00
          GOTO      SFAL9999
.
SFAL9600  CALL      DISCOD00
          GOTO      SFAL9999
.
SFAL9700  WRITE     HTMLFILE;PTMIS068;
          GOTO      SFAL9999
.
SFAL9800  WRITE     HTMLFILE;PTMIS024;
          GOTO      SFAL9999
.
SFAL9900  UNPACK    DIM127,D1,KEY3,DIM127
          MOVE      KEY3,FLDITMNO
          CALL      SFAX0000
          GOTO      SFAL9999
.
SFAL9999  RETURN
+
.----------------------------------------------------------------------------
. SFAX0000
.----------------------------------------------------------------------------
SFAX0000  BRANCH    FLDITMNO,SFAX0100,SFAX0200,SFAX0300,SFAX0400,SFAX0500:
                             SFAX0600,SFAX0700,SFAX0800,SFAX0900,SFAX1000: *10
                             SFAX1100,SFAX1200,SFAX1300,SFAX1400,SFAX1500:
                             SFAX1600,SFAX1700,SFAX1800,SFAX1900,SFAX2000: *20
                             SFAX2100,SFAX2200,SFAX2300,SFAX2400,SFAX2500:
                             SFAX2600,SFAX2700,SFAX2800,SFAX2900,SFAX3000: *30
                             SFAX3100,SFAX3200,SFAX3300,SFAX3400,SFAX3500:
                             SFAX3600,SFAX3700,SFAX3800,SFAX3900,SFAX4000: *40
                             SFAX4100,SFAX4200,SFAX4300,SFAX4400,SFAX4500:
                             SFAX4600,SFAX4700,SFAX4800,SFAX4900,SFAX5000: *50
                             SFAX5100,SFAX5200,SFAX5300,SFAX5400,SFAX5500:
                             SFAX5600,SFAX5700,SFAX5800,SFAX5900,SFAX6000: *60
                             SFAX6100,SFAX6200,SFAX6300,SFAX6400,SFAX6500:
                             SFAX6600,SFAX6700,SFAX6800,SFAX6900,SFAX7000: *70
                             SFAX7100,SFAX7200,SFAX7300,SFAX7400,SFAX7500:
                             SFAX7600,SFAX7700,SFAX7800,SFAX7900,SFAX8000: *80
                             SFAX8100,SFAX8200,SFAX8300,SFAX8400,SFAX8500:
                             SFAX8600,SFAX8700,SFAX8800,SFAX8900,SFAX9000: *90
                             SFAX9100,SFAX9200,SFAX9300,SFAX9400,SFAX9500:
                             SFAX9600,SFAX9700,SFAX9800,SFAX9900,SFA10000: *100
                             SFA10100,SFA10200,SFA10300,SFA10400,SFA10500:
                             SFA10600,SFA10700,SFA10800,SFA10900,SFA11000: *110
                             SFA11100,SFA11200,SFA11300,SFA11400,SFA11500:
                             SFA11600,SFA11700,SFA11800,SFA11900,SFA12000: *120
                             SFA12100,SFA12200,SFA12300,SFA12400,SFA12500:
                             SFA12600,SFA12700,SFA12800,SFA12900,SFA13000: *130
                             SFA13100,SFA13200,SFA13300,SFA13400,SFA13500:
                             SFA13600,SFA13700
.
SFAX0100  WRITE     HTMLFILE;CPMISKEY;
          GOTO      SFAX9999
.
SFAX0200  PROC      CHKDVA00
          WRITE     HTMLFILE;EXIT;              * Dva concession card exits?
          GOTO      SFAX9999
.
SFAX0300  UNPACK    DIM127,D1,KEY3,DIM127
          MOVE      KEY3,FLDITMNO
          CALL      RESD0000               * Residency details
          GOTO      SFAX9999
.
SFAX0400  CALL      DSTN0000          * Get Stationery code for the claim code
          GOTO      SFAX9999
.
SFAX0500  CALL      CPEX0000          * Check if Extra Comp.record already exist
          GOTO      SFAX9999
.
SFAX0600  MOVE      SP70,PMCDCNUM
          OPEN      PMSCCDA1,"pmsccdaf"
          PACK      KEY19,URNUMBER,SP70
          CALL      RSPMCCD1
SFAX0610  CALL      RKPMCCD1
          BRANCH    OVRCD,SFAX9999
.
          MATCH     URNUMBER,PMCDURNO
          GOTO      SFAX9999 IF NOT EQUAL
.
          PACK      KEY5,CATCT,PMCDCTYP,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,SFAX0610
.
          MATCH     "3",TCINDC1
          GOTO      SFAX0610 IF NOT EQUAL
.
          WRITE     HTMLFILE;PMCDCNUM;
          GOTO      SFAX9999
.
SFAX0700  MOVE      SP70,PMCDDVAC
          OPEN      PMSCCDA1,"pmsccdaf"
          PACK      KEY19,URNUMBER,SP70
          CALL      RSPMCCD1
SFAX0710  CALL      RKPMCCD1
          BRANCH    OVRCD,SFAX0720
.
          MATCH     URNUMBER,PMCDURNO
          GOTO      SFAX0720 IF NOT EQUAL
.
          PACK      KEY5,CATCT,PMCDCTYP,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,SFAX0710
.
          MATCH     "3",TCINDC1
          GOTO      SFAX0710 IF NOT EQUAL
.
          MOVE      "DX",CATEGORY
          MOVE      PMCDDVAC,CODE
          CALL      CODITM00
          GOTO      SFAX9999
.
SFAX0720  UNPACK    DIM127,D1,KEY1,DIM127
          WRITE     HTMLFILE;"&nbsp;";
          GOTO      SFAX9999
.
SFAX0800  MOVE      ZERO,F1
          COMPARE   ONE,MHCNUSE
          GOTO      SFAX0820 IF NOT EQUAL
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMHVIS1
          BRANCH    OVRCD,SFAX0820
          MOVE      ONE,F1
SFAX0820  WRITE     HTMLFILE;F1;
          GOTO      SFAX9999
.
SFAX0900  MOVE      "CL",CATEGORY
          MOVE      ALRECOMP,CODE
          CALL      CODITM00
          GOTO      SFAX9999
.
SFAX1000  MATCH     SP70,ALRERDAT
          GOTO      SFAX9999 IF EQUAL
.
          UNPACK    ALRERDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      SFAX9999
.
SFAX1100  CALL      LINS0000           * List of insurance for a claim code
          GOTO      SFAX9999
.
SFAX1200  CALL      SXIN0000           * SX insurer free text
          GOTO      SFAX9999
.
SFAX1300  MOVE      "Ve",CATEGORY
          MOVE      PMEXSERV,CODE
          CALL      DSRV0000                 * Selection for DF Service code
          GOTO      SFAX9999
.
SFAX1400  CALL      LIN10000           * List of Insurance Companies for Other
          GOTO      SFAX9999           * Compensable Details Screen
.
SFAX1500  CALL      LSREF000           * Check MH LS Referral management
          GOTO      SFAX9999           * Compensable Details Screen
.
SFAX1600  MOVE      ONE,BLANKEXP       * allow blank expiry date (1=yes/0=no)
          PROC      CHKCCD00
          WRITE     HTMLFILE;EXIT;     * concession card indicator
          GOTO      SFAX9999
.
SFAX1700  WRITE     HTMLFILE;CURRHOSP;
          GOTO      SFAX9999
.
SFAX1800  WRITE     HTMLFILE;CURRADMN;
          GOTO      SFAX9999
.
SFAX1900  MOVE      SP70,PMCDCNUM
          OPEN      PMSCCDA1,"pmsccdaf"
          PACK      KEY19,URNUMBER,Z70
          CALL      RSPMCCD1
SFAX1950  CALL      RPPMCCD1
          BRANCH    OVRCD,SFAX9999
          MATCH     URNUMBER,PMCDURNO
          IF        @EQUAL
            MOVE      "ct",KEY2
            PACK      KEY5,KEY2,PMCDCTYP,SP70
            CALL      RDCODE1
            BRANCH    OVRCD,SFAX1950
            MATCH     "3",TCINDC1
            GOTO      SFAX1950 IF NOT EQUAL     * Not for DVA
            WRITE     HTMLFILE;PMCDCNUM;
          ENDIF
          GOTO      SFAX9999
.
SFAX2000  MOVE      SP70,PMCDDVAC
          OPEN      PMSCCDA1,"pmsccdaf"
          PACK      KEY19,URNUMBER,Z70
          CALL      RSPMCCD1
SFAX2050  CALL      RPPMCCD1
          BRANCH    OVRCD,SFAX2060
          MATCH     URNUMBER,PMCDURNO
          GOTO      SFAX2060 IF NOT EQUAL
.
          MOVE      "ct",KEY2
          PACK      KEY5,KEY2,PMCDCTYP,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,SFAX2050
          MATCH     "3",TCINDC1
          GOTO      SFAX2050 IF NOT EQUAL     * Not for DVA
.
          UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      KEY1,F1
          BRANCH    F1,SFAX2055
.
          MOVE      "DX",CATEGORY
          MOVE      PMCDDVAC,CODE
          CALL      CODITM00
          GOTO      SFAX9999
.
SFAX2055  WRITE     HTMLFILE;PMCDCNUM;
          GOTO      SFAX9999
.
SFAX2060  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      "&nbsp;",KEY6
          WRITE     HTMLFILE;KEY6;
          GOTO      SFAX9999
.
SFAX2100  MOVE      "0",KEY1
          PACK      KEY20,URNUMBER,WBSEHOSP,SP20
          CALL      RSMRMAS1
          CALL      RKMRMAS1
          BRANCH    OVRCD,SFAX2199
          MATCH     URNUMBER,MRMAURNO
          GOTO      SFAX2199 IF NOT EQUAL
          MATCH     WBSEHOSP,MRMAHHOS
          GOTO      SFAX2190 IF EQUAL
.                                           * try for a different Home Hospital
          PACK      KEY3,WBSEHOSP,SP70
          CALL      RDPTHSP1
          MATCH     PTHSHOSP,PTHSHHOS       * MR home hospital different to
          GOTO      SFAX2199 IF EQUAL
          PACK      KEY20,URNUMBER,PTHSHHOS,SP20
          CALL      RSMRMAS1
          CALL      RKMRMAS1
          BRANCH    OVRCD,SFAX2199
          MATCH     URNUMBER,MRMAURNO
          GOTO      SFAX2199 IF NOT EQUAL
          MATCH     PTHSHHOS,MRMAHHOS
          GOTO      SFAX2199 IF NOT EQUAL
.
SFAX2190  MOVE      "1",KEY1
SFAX2199  WRITE     HTMLFILE;KEY1;
          GOTO      SFAX9999
.
SFAX2200  PACK      KEY16,URNUMBER,Z70
          CALL      RSEMVIS3
SFAX2250  CALL      RPEMVIS3
          BRANCH    OVRCD,SFAX9999
.
          MATCH     URNUMBER,EMVIURNO
          GOTO      SFAX9999 IF NOT EQUAL
.
          MATCH     EMVIPADM,ADMISSNO
          GOTO      SFAX2250 IF NOT EQUAL
.
          WRITE     HTMLFILE;EMVIADMN;      * Linked ED visit for IP
          GOTO      SFAX9999
.
SFAX2300  PACK      KEY20,SP70
          CALL      RDSCLIA1
SFAX2310  CALL      RDKCLIA1
          BRANCH    OVRCD,SFAX9999
.
          MATCH     "1",OTCLIACT
          GOTO      SFAX2310 IF EQUAL
.
          MATCH     PVISITE,OCASITE
          GOTO      SFAX2310 IF NOT EQUAL
.
          CALL      IBACLOCK                * Get the current date
          PACK      XDATE,CCC,CYY,CMM,CDD
          REP       " 0",XDATE
.
          MATCH     OCADATE,XDATE
          GOTO      SFAX2310 IF LESS
.
          MATCH     SP70,OCADOCT
          GOTO      SFAX2310 IF EQUAL
          GOTO      SFAX2310 IF EOS
.
          PACK      KEY6,OCADOCT,SP70
          CALL      RDDOCT1
          BRANCH    OVRCD,SFAX2310
.
          MATCH     SP70,DRTYPE
          IF        !@EQUAL
            PACK      KEY5,ANSD,ANST,DRTYPE,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MATCH     ANSL,TCINDC1
              GOTO      SFAX2350 IF EQUAL
            ENDIF
          ENDIF
.
          MATCH     SP70,DRTYPE2
          IF        !@EQUAL
            PACK      KEY5,ANSD,ANST,DRTYPE2,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MATCH     ANSL,TCINDC1
              GOTO      SFAX2350 IF EQUAL
            ENDIF
          ENDIF
.
          MATCH     SP70,DRTYPE3
          IF        !@EQUAL
            PACK      KEY5,ANSD,ANST,DRTYPE3,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MATCH     ANSL,TCINDC1
              GOTO      SFAX2350 IF EQUAL
            ENDIF
          ENDIF
.
          MATCH     SP70,DRTYPE4
          IF        !@EQUAL
            PACK      KEY5,ANSD,ANST,DRTYPE4,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MATCH     ANSL,TCINDC1
              GOTO      SFAX2350 IF EQUAL
            ENDIF
          ENDIF
.
          MATCH     SP70,DRTYPE5
          IF        !@EQUAL
            PACK      KEY5,ANSD,ANST,DRTYPE5,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MATCH     ANSL,TCINDC1
              GOTO      SFAX2350 IF EQUAL
            ENDIF
          ENDIF
.
          GOTO      SFAX2310
.
SFAX2350  MATCH     MHVIPYCL,OCACLIN
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",OCACLIN,"#" selected> ":
                               OCADESC,"</option>";
          ELSE
            WRITE     HTMLFILE;"<option value=#"",OCACLIN,"#"> ":
                               OCADESC,"</option>";
          ENDIF
.
          GOTO      SFAX2310
.
SFAX2400  WRITE     HTMLFILE;MHVIPYCL;
          GOTO      SFAX9999
.
SFAX2500  CALL      DISDSC00
          GOTO      SFAX9999
.
SFAX2600  PACK      KEY20,WBSESIT,MHVIPYCL,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          BRANCH    OVRCD,SFAX9999
.
          MATCH     WBSESIT,OCASITE
          GOTO      SFAX9999 IF NOT EQUAL
.
          MATCH     MHVIPYCL,OCACLIN
          GOTO      SFAX9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;OCADESC;
.
          GOTO      SFAX9999
.
SFAX2700  CALL      GMHTRN00                     * Get Mental Health Transfer
          GOTO      SFAX9999
.
SFAX2800  WRITE     HTMLFILE;SAVTDEPT;
          GOTO      SFAX9999
.
SFAX2900  PACK      KEY19,URNUMBER,SP20     * Get Waiting List procedure
          CALL      RDSTREA1
SFAX2901  CALL      RDKTREA1
          BRANCH    OVRCD,SFAX9999          * no procedures
.
          MATCH     URNUMBER,WMURNO         * same UR?
          GOTO      SFAX9999 IF NOT EQUAL   * no; get next WL patient procedure
.
          MATCH     AADMNO,WMBOOK           * same booking?
          GOTO      SFAX2901 IF NOT EQUAL   * no; get next WL patient procedure
.
          WRITE     HTMLFILE;WMDESC         * Principal Procedure description
          GOTO      SFAX9999
.
SFAX3000  PACK      KEY19,URNUMBER,SP20     * Get Waiting List procedure
          CALL      RDSTREA1
SFAX3001  CALL      RDKTREA1
          BRANCH    OVRCD,SFAX9999          * no procedures
.
          MATCH     URNUMBER,WMURNO         * same UR?
          GOTO      SFAX9999 IF NOT EQUAL   * no; get next WL patient procedure
.
          MATCH     AADMNO,WMBOOK           * same booking?
          GOTO      SFAX3001 IF NOT EQUAL   * no; get next WL patient procedure
.
          PACK      KEY9,WTWMPRO2,SP20
          CALL      RDPROA1
          BRANCH    OVRCD,SFAX9999
.
          WRITE     HTMLFILE;WPDESC
          GOTO      SFAX9999
.
SFAX3100  PACK      KEY19,URNUMBER,SP20     * Get Waiting List procedure
          CALL      RDSTREA1
SFAX3101  CALL      RDKTREA1
          BRANCH    OVRCD,SFAX9999          * no procedures
.
          MATCH     URNUMBER,WMURNO         * same UR?
          GOTO      SFAX9999 IF NOT EQUAL   * no; get next WL patient procedure
.
          MATCH     AADMNO,WMBOOK           * same booking?
          GOTO      SFAX3101 IF NOT EQUAL   * no; get next WL patient procedure
.
          PACK      KEY9,WTWMPRO3,SP20
          CALL      RDPROA1
          BRANCH    OVRCD,SFAX9999
.
          WRITE     HTMLFILE;WPDESC
          GOTO      SFAX9999
.
SFAX3200  WRITE     HTMLFILE;BYPASSCV;
          GOTO      SFAX9999
.
SFAX3300  CALL      EORIG000
          IF        CALCTOTD=0
            WRITE     HTMLFILE;" ";
          ELSE
            WRITE     HTMLFILE;CALCTOTD;
          ENDIF
          GOTO      SFAX9999
.
SFAX3400  CALL      EORIG000
          MOVE      SP70,DIM8
          MOVE      SAVEADAT,DIM8
          MATCH     DIM8,SP70
          GOTO      SFAX9999 IF EQUAL
          UNPACK    DIM8,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          GOTO      SFAX9999
.
SFAX3500  WRITE     HTMLFILE;ISEDLITE;
          GOTO      SFAX9999
.
SFAX3600  WRITE     HTMLFILE;ADMISNID;
          GOTO      SFAX9999
.
SFAX3700  WRITE     HTMLFILE;ADMREQNO;
          GOTO      SFAX9999
.
SFAX3800  WRITE     HTMLFILE;PMWXASST;
          GOTO      SFAX9999
.
SFAX3900  WRITE     HTMLFILE;PTARVAL1;
          GOTO      SFAX9999
.
SFAX4000  WRITE     HTMLFILE;PTARVAL2;
          GOTO      SFAX9999
.
SFAX4100  MATCH     SP70,PTARVAL3
          IF        @EQUAL
            CALL      CLCBMI00
          ELSE
            PACK      BODMASIN,PTARVAL3,SP70
          ENDIF
.
          CALL      RNGBMI00
          WRITE     HTMLFILE;BODMASRN;
          GOTO      SFAX9999
.
SFAX4200  MATCH     SP70,PTARUDTE
          GOTO      SFAX4210 IF EQUAL
.
          UNPACK    PTARUDTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP1,PTARUTME;
          GOTO      SFAX9999
.
SFAX4210  MATCH     SP70,PTARCDTE
          GOTO      SFAX9999 IF EQUAL
.
          UNPACK    PTARCDTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP1,PTARCTME;
          GOTO      SFAX9999
.
SFAX4300  WRITE     HTMLFILE;BMIINDIC;
          GOTO      SFAX9999
.
SFAX4400  WRITE     HTMLFILE;WBSEGENR;
          GOTO      SFAX9999
.
SFAX4500  CALL      PRPRFA00
          GOTO      SFAX9999
.
SFAX4600  MOVE      ONE,FORM2
          CALL      PTATRV00
          GOTO      SFAX9999
.
SFAX4700  MOVE      TWO,FORM2
          CALL      PTATRV00
          GOTO      SFAX9999
.
SFAX4800  MOVE      THREE,FORM2
          CALL      PTATRV00
          GOTO      SFAX9999
.
SFAX4900  MOVE      FOUR,FORM2
          CALL      PTATRV00
          GOTO      SFAX9999
.
SFAX5000  WRITE     HTMLFILE;VINAHUPD;
          GOTO      SFAX9999
.
SFAX5100  CALL      GETQKR00
          WRITE     HTMLFILE;QCKREGHD;
          GOTO      SFAX9999
.
SFAX5200  MOVE      "DC",CATEGORY
          MOVE      BKRXDIET,CODE
          CALL      CODITM00
          GOTO      SFAX9999
.
SFAX5300  OPEN      PMSDAUA2,"pmsdauaf"
          PACK      KEY27,URNUMBER,ZERO,ZERO,TWO,Z70
          CALL      RDPMDAU2
          CALL      RPPMDAU2
          BRANCH    OVRCD,SFAX5310
.
          MATCH     URNUMBER,PMDEURNO
          GOTO      SFAX5310 IF NOT EQUAL
.
          MATCH     "002",PMDERTYP
          GOTO      SFAX5310 IF NOT EQUAL
.
          MOVE      ONE,D1
          GOTO      SFAX5320
.
SFAX5310  MOVE      ZERO,D1
          GOTO      SFAX5320
.
SFAX5320  SQUEEZE   D1
          WRITE     HTMLFILE;D1;
          CLOSE     PMSDAUA2
          GOTO      SFAX9999
.
SFAX5400  UNPACK    DIM127,D1,KEY1,DIM127    * first seen doctor date or time
          CALL      FSDDT000
          GOTO      SFAX9999
.
SFAX5500  WRITE     HTMLFILE;PTCNBEAD;
          GOTO      SFAX9999
.
SFAX5600  CALL      LSRE1000           * Check MH LS Referral management
          GOTO      SFAX9999           * SJOG
.
SFAX5700  OPEN      IBAALVA1,"ibaalvaf"
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDIBALV1
          IF        OVRCD=1
            MOVE      SP70,IBAVVISN
            MOVE      SP70,IBAVAVIS
            MOVE      SP70,IBAVTYPE
            GOTO      SFAX5799
          ENDIF
.
          WRITE     HTMLFILE;IBAVAVIS;
          GOTO      SFAX5799
.
SFAX5799  CLOSE     IBAALVA1
          GOTO      SFAX9999
.
SFAX5800  READ      CONTROLF,HUND19;*182,PTCNEPIS
          MATCH     "1",PTCNEPIS    * using episoft interface
          GOTO      SFAX9999 IF NOT EQUAL
.
          MATCH     SP70,ADMISSNO
          GOTO      SFAX9999 IF EQUAL
.
          OPEN      PMSEHBA5,"pmsehbaf"
.
          PACK      KEY28,ADMISSNO,SP70
          CALL      RSPMEHB5
SFAX5810  CALL      RKPMEHB5
          BRANCH    OVRCD,SFAX5890
.
          MATCH     ADMISSNO,PMHBVISN
          GOTO      SFAX5890 IF NOT EQUAL
.
          MATCH     "7",PMHBSTAT
          GOTO      SFAX5810 IF NOT EQUAL
.
          WRITE     HTMLFILE;PMHBUNIQ;
          GOTO      SFAX5890
.
SFAX5890  CLOSE     PMSEHBA5
          GOTO      SFAX9999
.
SFAX5900  WRITE     HTMLFILE;EMERFLAG;
          GOTO      SFAX9999
.
SFAX6000  IF        IBCNMHOS<>1
            WRITE    HTMLFILE;PTCNACTR;
            GOTO     SFAX9999
          ENDIF
.
          PACK      KEY3,WBSEHOSP,SP70
          CALL      RDPTHSP1
          BRANCH    OVRCD,SFAX9999
.
          WRITE     HTMLFILE;PTHSACTR;
          GOTO      SFAX9999
.
SFAX6100  WRITE     HTMLFILE;EMEXP001;
          GOTO      SFAX9999
.
SFAX6200  MATCH     "1",PTCNDWDC
          GOTO      SFAX9999 IF NOT EQUAL
.
          OPEN      PMSNUTA1,"pmsnutaf"
.
          PACK      KEY16,AADMNO,ADATE,SP70
          CALL      RDPMNUT1
          IF        OVRCD = 1
            MOVE      SP70,CODE
          ELSE
            MOVE      PMNUDTYP,CODE
          ENDIF
.
          MOVE      "MJ",CATEGORY
          CALL      CODITM00
.
SFAX6250  CLOSE     PMSNUTA1
          GOTO      SFAX9999
.
SFAX6300  MATCH     "1",PTCNDWDC
          GOTO      SFAX9999 IF NOT EQUAL
.
          OPEN      PMSNUTA1,"pmsnutaf"
.
          PACK      KEY16,AADMNO,ADATE,SP70
          CALL      RDPMNUT1
          BRANCH    OVRCD,SFAX6350
.
          MATCH     SP70,PMNUCOM1
          IF        !@EQUAL
            WRITE     HTMLFILE;PMNUCOM1;
          ENDIF
.
SFAX6350  CLOSE     PMSNUTA1
          GOTO      SFAX9999
.
SFAX6400  CALL      PMAU0000
          GOTO      SFAX9999
.
SFAX6500  MOVE      FIVE,FORM2
          CALL      PTATRV00
          GOTO      SFAX9999
.
SFAX6600  MOVE      SIX,FORM2
          CALL      PTATRV00
          GOTO      SFAX9999
.
SFAX6700  READ      CONTROLF,HUND17;*216,PTCNDSID
          MATCH     SP70,ACDICSYC
          IF        @EOS | @EQUAL
            MOVE      PTCNDSID,CODSYSID
          ELSE
            MOVE      ACDICSYC,CODSYSID
          ENDIF
          CALL      VSCSEL00
          GOTO      SFAX9999
.
SFAX6800  UNPACK    DIM127,D1,KEY3,D1,D3,DIM127
          MOVE      ZERO,F3
          MOVE      D3,F3
          PACK      KEY14,ADMISSNO,KEY3,F3,SP70
          CALL      RDVSCMT1
          IF        OVRCD<>1
            STRIP    VSCTDATA
            MATCH    SP70,VSCTDATA
            IF       !@EQUAL & !@EOS
              WRITE    HTMLFILE;*+,VSCTDATA,SP1;
            ENDIF
          ENDIF
          GOTO      SFAX9999
.
SFAX6900  PACK      KEY6,ADOCTA,SP6
          CALL      RDDOCT1                 * Read the doctors file
          BRANCH    OVRCD,SFAX9999
.
          MATCH     SP3,DRTYPE
          GOTO      SFAX9999 IF EQUAL
.
          PACK      KEY5,ANSD,ANST,DRTYPE,SP70
          CALL      RDCODE1                 * Read the codes file
          BRANCH    OVRCD,SFAX9999
.
          MATCH     PYAA,THCSCOD
          GOTO      SFAX9999 IF LESS        * < PYAA
.
          MATCH     THCSCOD,PYZZ
          GOTO      SFAX9999 IF LESS        * PYZZ <
.
          WRITE     HTMLFILE;ONE;           * MH attending doctor

          GOTO      SFAX9999
.
SFAX7000  MOVE      ONE,FORM2
          CALL      PTATRU00
          GOTO      SFAX9999
.
SFAX7100  MOVE      TWO,FORM2
          CALL      PTATRU00
          GOTO      SFAX9999
.
SFAX7200  MOVE      THREE,FORM2
          CALL      PTATRU00
          GOTO      SFAX9999
.
SFAX7300  MOVE      FOUR,FORM2
          CALL      PTATRU00
          GOTO      SFAX9999
.
SFAX7400  MOVE      FIVE,FORM2
          CALL      PTATRU00
          GOTO      SFAX9999
.
SFAX7500  MOVE      SIX,FORM2
          CALL      PTATRU00
          GOTO      SFAX9999
.
SFAX7600  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          IF        REPORTNO=4
            PACK      KEY25,EMRVISIT,TWO,SP70    
          ELSE
            PACK      KEY25,ADMISSNO,TWO,SP70    
          ENDIF
          CALL      RSPMBRQ2                     * Visits allocated bed
          CALL      RKPMBRQ2                     * request ward/bed
          BRANCH    OVRCD,SFAX9999
.
          IF        REPORTNO=4
            MATCH     EMRVISIT,PMBRVISN
            GOTO      SFAX9999 IF NOT EQUAL
          ELSE
            MATCH     ADMISSNO,PMBRVISN
            GOTO      SFAX9999 IF NOT EQUAL
          ENDIF
.
          MATCH     "2",PMBRRSTA
          GOTO      SFAX9999 IF NOT EQUAL
.
          IF        F1=0
            WRITE     HTMLFILE;PMBREWRD;           * Expected ward
          ENDIF 
. 
          IF        F1=1
            WRITE     HTMLFILE;PMBREBED;           * Expected bed
          ENDIF
.
          IF        F1=2
            WRITE     HTMLFILE;PMBREWRD,PMBREBED;  * Expected ward/bed
          ENDIF
          GOTO      SFAX9999
.
SFAX7700  CALL      CMBS0000                  * Check for multiple MBS
          WRITE     HTMLFILE;F1;
          GOTO      SFAX9999
.
SFAX7800  CALL      DMBS0000                  * Display extra MBS items
          GOTO      SFAX9999
.
SFAX7900  CALL      DMBH0000                  * Display extra MBS items
          GOTO      SFAX9999                  * Different header
.
SFAX8000  CALL      DMBC0000                  * Display extra MBS items
          GOTO      SFAX9999                  * Indicator
.
SFAX8100  WRITE     HTMLFILE;EREFRLID;        *eReferral ID
          GOTO      SFAX9999
.
SFAX8200  WRITE     HTMLFILE;BKRXUFF1;
          GOTO      SFAX9999
.
SFAX8300  WRITE     HTMLFILE;BKRXUFF2;
          GOTO      SFAX9999
.
SFAX8400  WRITE     HTMLFILE;BKRXUFF3;
          GOTO      SFAX9999
.
SFAX8500  WRITE     HTMLFILE;PTQMTOUA;
          GOTO      SFAX9999
.
SFAX8600  WRITE     HTMLFILE;PTQMEMPS;
          GOTO      SFAX9999
.
SFAX8700  WRITE     HTMLFILE;PTQMPSNS;
          GOTO      SFAX9999
.
SFAX8800  WRITE     HTMLFILE;PTQMPRMS;
          GOTO      SFAX9999
.
SFAX8900  WRITE     HTMLFILE;PTQMRTFC;
          GOTO      SFAX9999
.
SFAX9000  WRITE     HTMLFILE;PTQMMLSI;
          GOTO      SFAX9999
.
SFAX9100  WRITE     HTMLFILE;PTQMPSNT;
          GOTO      SFAX9999
.
SFAX9200  CALL      RECD0000                * Recurring care Dr
          GOTO      SFAX9999
.
SFAX9300  PACK      KEY20,WCCLMNO,SP70        * Check if any Diagnosis has blank
          CALL      RSACDIA1                  * value for Side
SFAX9310  CALL      RKACDIA1
          BRANCH    OVRCD,SFAX9999
.
          MATCH     WCCLMNO,ACDIACCN           * same ACC Number?
          GOTO      SFAX9999 IF NOT EQUAL
.
          MATCH     ACDISIDE,SP70              * Is Side value blank
          IF        @EQUAL
            WRITE     HTMLFILE;ONE;            * Yes
          ELSE
            GOTO      SFAX9310                 * No
          ENDIF
          GOTO      SFAX9999
.
SFAX9400  PACK      KEY6,EMVIUR01,SP6
          CALL      RDDOCT1                 * Read the doctors file
          BRANCH    OVRCD,SFAX9999
.
          MATCH     SP3,DRTYPE
          GOTO      SFAX9999 IF EQUAL
.
          PACK      KEY5,ANSD,ANST,DRTYPE,SP70
          CALL      RDCODE1                 * Read the codes file
          BRANCH    OVRCD,SFAX9999
.
          MATCH     PYAA,THCSCOD
          GOTO      SFAX9999 IF LESS        * < PYAA
.
          MATCH     THCSCOD,PYZZ
          GOTO      SFAX9999 IF LESS        * PYZZ <
.
          WRITE     HTMLFILE;ONE;           * MH attending doctor

          GOTO      SFAX9999
.
SFAX9500  WRITE     HTMLFILE;UPINUMBR;      * UPI Number
          GOTO      SFAX9999
.
SFAX9600  WRITE     HTMLFILE;SRCHMNAM;      * Middle Name (Second Given Name)
          GOTO      SFAX9999
.
SFAX9700  WRITE     HTMLFILE;SRCHMEDI;      * Medicare No.
          GOTO      SFAX9999
.
SFAX9800  WRITE     HTMLFILE;UPINSPID;      * NSLHD Person ID
          GOTO      SFAX9999
.
SFAX9900  UNPACK    DIM127,D1,KEY3,DIM127
          MOVE      KEY3,FLDITMNO
          CALL      MISX0000
          GOTO      SFAX9999
.
SFA10000  CALL      WTPACM00
          GOTO      SFAX9999
.
SFA10100  WRITE     HTMLFILE;REFRDATE;       * Residential Adm Referral Date
          GOTO      SFAX9999
.
SFA10200  CALL      BQEXST00
          WRITE     HTMLFILE;PMBRFLAG;       * Bed Request Exist Flag
.                                            * status = 1, 2 or SPACE
          GOTO      SFAX9999
.
SFA10300  CALL      BQEXST00
          IF        PMBRFLAG = ONE 
            WRITE     HTMLFILE;PMBREWRD;     * Expected Ward 
          ENDIF
          GOTO      SFAX9999
.
SFA10400  CALL      BQEXST00
          IF        PMBRFLAG = ONE 
            WRITE     HTMLFILE;PMBREBED;     * Expected Bed 
          ENDIF
          GOTO      SFAX9999
.
SFA10500  CALL      BQEXST00
          IF        PMBRFLAG = ONE 
            WRITE     HTMLFILE;PMBRRHCP;     * Requesting HCP 
          ENDIF
          GOTO      SFAX9999
.
SFA10600  CALL      BQEXST00
          IF        PMBRFLAG = ONE 
            CALL      BQDIAG00               * Diagnosis 
          ENDIF
          GOTO      SFAX9999
.
SFA10700  CALL      BQEXST00
          IF        PMBRFLAG = ONE 
            MATCH     SP70,PMBRSBED
            GOTO      SFAX9999 IF EQUAL
            MOVE      "CG",CATEGORY
            MOVE      PMBRSBED,CODE
            CALL      CODITM00
            GOTO      SFAX9999
          ENDIF
          GOTO      SFAX9999
.
SFA10800  WRITE     HTMLFILE;SUPERLEV;      * Supervisor menu flag
          GOTO      SFAX9999
.
.-------------------------------------------------------------------------
. Return a flag to indicate if the multiple birth attribute (022) exists
. for an ur number. 
.-------------------------------------------------------------------------
SFA10900  OPEN      PATATRA3,"patatraf"
          MOVE      "0",DIM1
          MOVE      ATYPE022,KEY3
          PACK      KEY8,SP7,ZERO 
          PACK      KEY35,URNUMBER,KEY8,KEY3,Z70
          CALL      RSPTATR3
SFA10902  CALL      RPPTATR3
          BRANCH    OVRCD,SFA10908
.
          MATCH     URNUMBER,PTARURNO
          GOTO      SFA10908 IF NOT EQUAL
.
          MATCH     KEY8,PTARVISN
          GOTO      SFA10908 IF NOT EQUAL
.
          MATCH     KEY3,PTARTYPE
          GOTO      SFA10908 IF NOT EQUAL
.
          MATCH     "1",PTARDELR
          GOTO      SFA10902 IF EQUAL
.
          MATCH     SP70,PTARFDTE     
          GOTO      SFA10902 IF NOT EQUAL
.
          MATCH     SP70,PTARFTME
          GOTO      SFA10902 IF NOT EQUAL
.
          MOVE      "1",DIM1
.
SFA10908  WRITE     HTMLFILE;DIM1;
          CLOSE     PATATRA3
          GOTO      SFAX9999
.
.-------------------------------------------------------------------------
. Return multiple order details (022) 
.-------------------------------------------------------------------------
SFA11000  OPEN      PATATRA3,"patatraf"
          MOVE      "Order Not Stated",DIM16
          MOVE      ATYPE022,KEY3
          PACK      KEY8,SP7,ZERO
          PACK      KEY35,URNUMBER,KEY8,KEY3,Z70
          CALL      RSPTATR3
SFA11002  CALL      RPPTATR3
          BRANCH    OVRCD,SFA11008
.
          MATCH     URNUMBER,PTARURNO
          GOTO      SFA11008 IF NOT EQUAL
.
          MATCH     KEY8,PTARVISN
          GOTO      SFA11008 IF NOT EQUAL
.
          MATCH     KEY3,PTARTYPE
          GOTO      SFA11008 IF NOT EQUAL
.
          MATCH     "1",PTARDELR
          GOTO      SFA11002 IF EQUAL
.
          MATCH     SP70,PTARFDTE
          GOTO      SFA11002 IF NOT EQUAL
.
          MATCH     SP70,PTARFTME
          GOTO      SFA11002 IF NOT EQUAL
.
          MATCH     SP70,PTARVAL1
          IF        !@EQUAL
            MATCH     "0",PTARVAL1
            IF        !@EQUAL
              MOVE      PTARVAL1,DIM16  
            ENDIF
          ENDIF
.
          MOVE      "mX",KEY2 
          PACK      KEY5,KEY2,PTARCOD1
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      PTARCOD1,TDESC
          ENDIF
          STRIP     TDESC
.
          CLEAR     DIM37
          APPEND    TDESC,DIM37
          APPEND    SP1,DIM37
          APPEND    DIM16,DIM37
          RESET     DIM37
.          
          WRITE     HTMLFILE;DIM37;
          CLOSE     PATATRA3
          GOTO      SFAX9999  
.
SFA11008  WRITE     HTMLFILE;"";
          CLOSE     PATATRA3
          GOTO      SFAX9999
.
SFA11100  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          PACK      KEY14,ADMISSNO,ZERO,ZERO,FIVE,SP70
          CALL      RSEMVCD1
SFA11110  CALL      RKEMVCD1
          BRANCH    OVRCD,SFAX9999
.
          MATCH     ADMISSNO,EMVCVIST
          GOTO      SFAX9999 IF NOT EQUAL
.
          MATCH     "005",EMVCTYPE          * Emergency diagnosis ?
          GOTO      SFAX9999 IF NOT EQUAL
.
          MATCH     "000",EMVCSEQU          * Primary diagnosis
          GOTO      SFAX9999 IF NOT EQUAL
.
          MATCH     SP100,EMVCFTXT
          GOTO      SFA11120 IF EQUAL
          GOTO      SFA11120 IF EOS
.
          IF        F1=1
            MOVE      ADIAG1,SAVKEY80       * Save existing adiag1
            MOVE      EMVCFTXT,ADIAG1       
            PROC      REFADM00              * Reads pmsvscaf table using adiag1
            MOVE      SAVKEY80,ADIAG1       * Restore adiag1    
            BRANCH    EXIT,SFAX9999         * Exit, not found
            WRITE     HTMLFILE;KEY80;       * Value of pmsvscaf.pmvcptrm
          ELSE	    
            WRITE     HTMLFILE;EMVCFTXT;
          ENDIF
          GOTO      SFAX9999
.
SFA11120  MOVE      EMVCMNCD,KEY9
          CALL      RDEMICD1
          BRANCH    OVRCD,SFAX9999
.
          IF        F1=1
            MOVE      ADIAG1,SAVKEY80       * Save existing adiag1
            MOVE      EMICDESC,ADIAG1        
            PROC      REFADM00              * Reads pmsvscaf table using adiag1
            MOVE      SAVKEY80,ADIAG1       * Restore adiag1
            BRANCH    EXIT,SFAX9999         * Exit, not found
            WRITE     HTMLFILE;KEY80;       * Value of pmsvscaf.pmvcptrm
          ELSE	    
            WRITE     HTMLFILE;EMICDESC;
          ENDIF
          GOTO      SFAX9999	  
.
SFA11200  OPEN      PMSCCDA1,"pmsccdaf"  
          PACK      KEY19,URNUMBER,SP70
          CALL      RSPMCCD1
SFA11220  CALL      RKPMCCD1
          BRANCH    OVRCD,SFA11280
.
          MATCH     URNUMBER,PMCDURNO
          GOTO      SFA11280 IF NOT EQUAL
.
          MOVE      "ct",KEY2
          PACK      KEY5,KEY2,PMCDCTYP,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,SFA11280
.
          MATCH     "7",TCINDC1
          GOTO      SFA11220 IF NOT EQUAL
.
          WRITE     HTMLFILE;PMCDCNUM;
          GOTO      SFA11290
.
SFA11280  WRITE     HTMLFILE;"";
.
SFA11290  CLOSE     PMSCCDA1
          GOTO      SFAX9999
.
SFA11300  WRITE     HTMLFILE;SUPRFUNC;
          GOTO      SFAX9999
.
SFA11400  WRITE     HTMLFILE;PTMXCTIM;
          GOTO      SFAX9999
.
SFA11500  MOVE      "ct",KEY2
          PACK      KEY5,KEY2,SP70
          CALL      RDSCODE1                * Position on & read a codes file
SFA11520  CALL      RDKCODE1                  record
          BRANCH    OVRCD,SFA11580
.
          MATCH     KEY2,TCODE
          GOTO      SFA11580 IF NOT EQUAL
.
          MATCH     SP70,ACODE
          GOTO      SFA11520 IF EQUAL
.
          MATCH     "7",TCINDC1
          GOTO      SFA11520 IF NOT EQUAL
.
          WRITE     HTMLFILE;ACODE;
          GOTO      SFA11590
.
SFA11580  WRITE     HTMLFILE;"";
.
SFA11590  GOTO      SFAX9999
.
SFA11600  CALL      GARM0000      * Get ACC45 Claim API Response Message (JSON)
          GOTO      SFAX9999
.
SFA11700  OPEN      PMSDAUA2,"pmsdauaf"
          PACK      KEY27,URNUMBER,SP70
          CALL      RDPMDAU2
          CALL      RKPMDAU2
          BRANCH    OVRCD,SFA11710
.
          MATCH     URNUMBER,PMDEURNO
          GOTO      SFA11710 IF NOT EQUAL
.
          MOVE      ONE,D1
          GOTO      SFA11720
.
SFA11710  MOVE      ZERO,D1
          GOTO      SFA11720
.
SFA11720  SQUEEZE   D1
          WRITE     HTMLFILE;D1;
          CLOSE     PMSDAUA2
          GOTO      SFAX9999
.
SFA11800  CALL      OBSV0000          * Check for clinical documents
          GOTO      SFAX9999
.
SFA11900  UNPACK    DIM127,D1,KEY3,DIM127
          MOVE      KEY3,FLDITMNO
          PACK      KEY8,ADMISSNO,SP70    * Patient must be discharged!
          CALL      RDDSCH1
          IF        OVRCD=1
            CALL      CLPATDSC
          ENDIF
          CALL      DSCF0000 
          GOTO      SFAX9999
.
SFA12000  CALL      DISWRD00              * discharge ward
          MATCH     SP70,DISWARD
          IF        @EQUAL
            WRITE     HTMLFILE;DISWARD;
          ELSE
            PACK      KEY6,DISWARD,SP70
            CALL      RDWARD1
            IF        OVRCD=0
              WRITE     HTMLFILE;WBDESC;
            ELSE
              WRITE     HTMLFILE;DISWARD;
            ENDIF
          ENDIF
          GOTO      SFAX9999
.
SFA12100  CALL      DISWRD00              * discharge unit
          MATCH     SP70,DISUNIT
          IF        @EQUAL
            PACK      DIM127,SP70,SP70 
            WRITE     HTMLFILE;DISUNIT;
          ELSE
            MOVE      "AC",CATEGORY
            MOVE      DISUNIT,CODE
            CALL      CODITM00
          ENDIF
          GOTO      SFAX9999 
.
SFA12200  MOVE      ADMISSNO,VSXDC001       * Visit Number
          MOVE      TWO,VSTYPIND            * Type of Data
          MOVE      ONE,VSDATIND            * Date Field index (1-10)
          CALL      GETVDT00
          MATCH     SP70,VSDATVAL
          IF        !@EQUAL
            UNPACK    VSDATVAL,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          ENDIF
          GOTO      SFAX9999
.
SFA12300  WRITE     HTMLFILE;REFREJCT;   
          GOTO      SFAX9999
.
.         Check if Valid NDIS
.
SFA12400  CLOSE     PMSELFA1
          OPEN      PMSCCDA1,"pmsccdaf"           *Load Concession Cards
.
          CALL      IBACLOCK                      *Get current date
          PACK      XDATE,CC,CYY,CMM,CDD
          REP       " 0",XDATE
.
          PACK      KEY19,URNUMBER,SP70
          CALL      RSPMCCD1
SFA12410  CALL      RKPMCCD1
          BRANCH    OVRCD,SFA12490
.
          MATCH     URNUMBER,PMCDURNO
          GOTO      SFA12490 IF NOT EQUAL
.
          PACK      KEY5,CATCT,PMCDCTYP,SP70      *Get Concession Card Type
          CALL      RDCODE1
          BRANCH    OVRCD,SFA12410
.
          MATCH     "7",TCINDC1                   *Is Card NDIS?
          GOTO      SFA12410 IF NOT EQUAL
.
          MATCH     SP70,PMCDEXDT                 *Is expiry blank?
          IF        @EQUAL
            GOTO      SFA12485
          ELSE
            MATCH     XDATE,PMCDEXDT              *Has Concession Expired?
            IF        @LESS
              GOTO      SFA12410
            ENDIF
          ENDIF
.
SFA12485  WRITE     HTMLFILE;"1";                 *Valid Concession
          GOTO      SFA12495
.
SFA12490  WRITE     HTMLFILE;"0";                 *Not Valid Concession
.
SFA12495  CLOSE     PMSCCDA1
          OPEN      PMSELFA1,"pmselfaf"
          GOTO      SFAX9999
.
SFA12500  MATCH     "044",TEMPLATE
          IF        @EQUAL
            PACK      KEY11,DEMVIADM,EMVICOMP
          ELSE
            PACK      KEY11,ADMISSNO,ACLAIM       * ACLAIM holds IP/ED/OP/AH
          ENDIF                                   * claim code - GCLM0000
          CALL      RDPMEXT1
.
          UNPACK    DIM127,D1,KEY3,DIM127
          MOVE      ZERO,FLDITMNO
          MOVE      KEY3,FLDITMNO           
          CALL      PMEX0000               *Claim Extension Details
          GOTO      SFAX9999
.
SFA12600  WRITE     HTMLFILE;PMEXT049;
          GOTO      SFAX9999
.
SFA12700  PACK      KEY46,ADMISSNO,Z70
          CALL      RDPMCHA1
          CALL      RPPMCHA1
.
          MATCH     ADMISSNO,PMCHADMN
          GOTO      SFAX9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;PMCHREAS;
.
          GOTO      SFAX9999
.
SFA12800  PACK      KEY8,ADMISSNO
          CALL      RDBOKB1
          BRANCH    OVRCD,SFAX9999
.
          WRITE     HTMLFILE;"1";
          GOTO      SFAX9999
.
SFA12900  PROC      MVCONF00
          UNPACK    D2,MVITTYPE,MVITSTAT
.
          UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,SFA12910
.
          WRITE     HTMLFILE;MVITTYPE;             * .0 Visit Type
          GOTO      SFAX9999
.
SFA12910  WRITE     HTMLFILE;MVITSTAT;             * .1 Visit Status
          GOTO      SFAX9999
.
SFA13000  WRITE     HTMLFILE;URNUMBER;
          GOTO      SFAX9999
.
SFA13100  WRITE     HTMLFILE;ADMISSNO;
          GOTO      SFAX9999
.
SFA13200  CALL      ATRFA000
          GOTO      SFAX9999
.
SFA13300  MOVE      ADMISSNO,VSXDC001       * Visit Number
          MOVE      TWO,VSTYPIND            * Type of Data
          MOVE      TWO,VSCODIND            * Code Field index (1-10)
          CALL      GETVCV00
.
          MATCH     SP70,VSCODVAL
          IF        !@EQUAL
            WRITE     HTMLFILE;VSCODVAL;
          ENDIF
          GOTO      SFAX9999
.
. Read patmi1af for admission status = 2. If no record found, return Blank.
. If patmi1af record found, read patre1af for admission number.
. If no record found,return Blank. Otherwise, return patre1af data with
. pipe delimiter
.
SFA13400  MATCH     SP70,ADMISSNO
          GOTO      SFA13480 IF EQUAL
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,SFA13480          * no current admission
.
          MATCH     "2",DASTAT
          GOTO      SFA13480 IF NOT EQUAL
.
          PACK      KEY8,ADMISSNO,KEY8,SP70
          CALL      RDRESP1
          BRANCH    OVRCD,SFA13480          
.
          CLEAR     WARNMESS
          APPEND    DPKADMN,WARNMESS             *  0        
          APPEND    "|",WARNMESS
          APPEND    PKNAME,WARNMESS              *  1
          APPEND    "|",WARNMESS
          APPEND    PKADD1,WARNMESS              *  2
          APPEND    "|",WARNMESS
          APPEND    PKADD2,WARNMESS              *  3
          APPEND    "|",WARNMESS
          APPEND    PKSUBR,WARNMESS              *  4
          APPEND    "|",WARNMESS
          APPEND    PKADD4,WARNMESS              *  5
          APPEND    "|",WARNMESS
          APPEND    PKPOST,WARNMESS              *  6
          APPEND    "|",WARNMESS
          APPEND    PKTELEP,WARNMESS             *  7
          APPEND    "|",WARNMESS
          APPEND    PKTELEB,WARNMESS             *  8
          APPEND    "|",WARNMESS
          APPEND    PKRELP,WARNMESS              *  9
          APPEND    "|",WARNMESS
          APPEND    PTREMOBL,WARNMESS            * 10
          APPEND    "|",WARNMESS
          APPEND    PTRESNAM,WARNMESS            * 11
          APPEND    "|",WARNMESS
          APPEND    PTREGNAM,WARNMESS            * 12
          APPEND    "|",WARNMESS
.
          WRITE     HTMLFILE;WARNMESS;
          GOTO      SFAX9999
.
SFA13480  WRITE     HTMLFILE;"";
          GOTO      SFAX9999
.
SFA13500  MOVE      "RB",CATEGORY
          PACK      CODE,SP70
          CALL      CODITM00
          GOTO      SFAX9999
.
SFA13600  WRITE     HTMLFILE;CHCKCOMP;
          GOTO      SFAX9999
.
SFA13700  WRITE     HTMLFILE;SCRNAME;
          GOTO      SFAX9999
.
SFAX9999  RETURN
+
.--------------------------------------------------------------------
.         Get the ACC45 Claim API Response Message (from .resp file)
.--------------------------------------------------------------------
GARM0000  MATCH     SP70,WCCLMNO
          GOTO      GARM9999 IF EQUAL
.
          CALL      TFILENAM                * get new temp filename
          PREP      ACCTMPFL,TFILNAME       * create the file to store file path
.
          READ      CONTROLF,HUND12;*179,PTCNACPT
          STRIP     PTCNACPT
          STRIP     WCCLMNO
.
          CLEAR     CMDLINE
.
.         APPEND    "find -L ",CMDLINE
.         APPEND    PTCNACPT,CMDLINE
.         APPEND    " -name '",CMDLINE
.         APPEND    WCCLMNO,CMDLINE
.         APPEND    ".resp' > ",CMDLINE
.         APPEND    TFILNAME,CMDLINE
.         APPEND    ".txt",CMDLINE
.         RESET     CMDLINE
.
          APPEND    "ls -l ",CMDLINE
          APPEND    PTCNACPT,CMDLINE
.
          RESET     CMDLINE
          STRIP     CMDLINE
          ENDSET    CMDLINE
          CMATCH    "/",CMDLINE
          IF        !@EQUAL
            APPEND    "/",CMDLINE
          ENDIF
.
          IF        IBCNMHOS=1
            MOVE      PMVXMHOS,DIM3
            STRIP     DIM3
            APPEND    DIM3,CMDLINE
            APPEND    "/",CMDLINE
          ENDIF
.
          APPEND    WCCLMNO,CMDLINE
          APPEND    ".resp 2>/dev/null | awk '{print $9}' > ",CMDLINE
          APPEND    TFILNAME,CMDLINE
          APPEND    ".txt",CMDLINE
          RESET     CMDLINE
.
          EXECUTE   CMDLINE,TASKID
          MATCH     "1",TASKID
          GOTO      GARM9100 IF EQUAL   * shell command failed
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      ACCTMPFL,TFILNAME   * open the temp file
          TRAPCLR   IO
          BRANCH    OVRCD,GARM9100
.
          READ      ACCTMPFL,SEQ;ACCFILNP
          GOTO      GARM9100 IF OVER
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      ACCRESAF,ACCFILNP   * open the '.resp' file
          TRAPCLR   IO
          BRANCH    OVRCD,GARM9100
.
          CLEAR     ACCRESPM
          MOVE      ZERO,COUNTER
          WHILE     COUNTER < 40
            ADD       ONE,COUNTER
            APPEND    SP100,ACCRESPM
          DO
          RESET     ACCRESPM
.
          READ      ACCRESAF,SEQ;ACCRESPM
          GOTO      GARM9100 IF OVER
.
          WRITE     HTMLFILE;ACCRESPM
.
GARM9100  CLOSE     ACCTMPFL,DELETE     * Delete temp file
GARM9999  RETURN
+
.--------------------------------------------------------------------
. Check if there is any bed requests row wirg status = 1, 0 or SPACE
. Return: PMBRFLAG
.--------------------------------------------------------------------
BQEXST00  MOVE      ZERO,PMBRFLAG
          PACK      KEY25,ADMISSNO,SP70
          CALL      RSPMBRQ2
BQEXST20  CALL      RKPMBRQ2
          BRANCH    OVRCD,BQEXST99
.
          MATCH     ADMISSNO,PMBRVISN
          GOTO      BQEXST99 IF NOT EQUAL
.
          MATCH     " ",PMBRRSTA
          GOTO      BQEXST30 IF EQUAL
.
          MATCH     "1",PMBRRSTA
          GOTO      BQEXST30 IF EQUAL
.
          MATCH     "2",PMBRRSTA
          GOTO      BQEXST30 IF EQUAL
.
          GOTO      BQEXST20
.
BQEXST30  MOVE      ONE,PMBRFLAG
.
BQEXST99  RETURN
.
.--------------------------------------------------------------------
. Write out bed request diagnosis code or description
.--------------------------------------------------------------------
BQDIAG00  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,BQDIAG20
.
          MATCH     SP70,PMBRDIAG
          GOTO      BQDIAG99 IF EQUAL
.
          CLOSE     PRSPMIA1                     * Free up some open files
          CLOSE     PMSIPLA1 
          CLOSE     ALLCASA1
          CLOSE     MRTLOCA1
.
          OPEN      PATICDD1,"paticddf"
          OPEN      PATD11A1,"patd11af"
.
          MOVE      ZERO,OVRCD               
          TRAP      OVERCOND IF IO
          OPEN      PATD12A1,"patd12af"
          TRAPCLR   IO
.
          MOVE      ZERO,OVRCD               
          TRAP      OVERCOND IF IO
          OPEN      PATD13A1,"patd13af"
          TRAPCLR   IO
.
          MOVE      PMBRREQD,ICDRDDTE
          PACK      KEY9,PMBRDIAG,SP70
          CALL      RDPTICD1
          BRANCH    OVRCD,BQDIAG90
.
          WRITE     HTMLFILE;DDESC;
          GOTO      BQDIAG90 
.
BQDIAG20  WRITE     HTMLFILE;PMBRDIAG;
          GOTO      BQDIAG99
.
BQDIAG90  CLOSE     PATICDD1
          CLOSE     PATD11A1
          CLOSE     PATD12A1
          CLOSE     PATD13A1
.
          OPEN      PRSPMIA1,"prspmiaf"          * Re open original files
          OPEN      PMSIPLA1,"pmsiplaf"
          OPEN      ALLCASA1,"allcasaf"
          OPEN      MRTLOCA1,"mrtlocaf"
.
BQDIAG99  RETURN
.
.--------------------------------------------------------------------
. MISX0000 - Miscellaneous extra tags
.--------------------------------------------------------------------
.
MISX0000  BRANCH    FLDITMNO,MISX0100,MISX0200,MISX0300,MISX0400
.
          WRITE     HTMLFILE;"Invalid IBA Tag MISX0000";
          GOTO      MISX9999
.
MISX0100  CALL      MHLSR000           * Check MH LS Referral management
          GOTO      MISX9999           * Compensable Details Screen
.
MISX0200  WRITE     HTMLFILE;ADMTFLAG;
          GOTO      MISX9999
.
MISX0300  WRITE     HTMLFILE;DEFSTATD;                     *T0874934
          GOTO      MISX9999
.
MISX0400  READ      CONTROLF,HUND28;*226,PTCNNMPR
          WRITE     HTMLFILE;PTCNNMPR;
          GOTO      MISX9999
.
MISX9999  RETURN
+
.------------------------------------------------------------
. Recurring care admission
. Get last trasfter records doctor code for unit in PTMIS024
.------------------------------------------------------------
RECD0000  MATCH     Z70,PTMIS024                 * Recurring care unit
          GOTO      RECD9000 IF EQUAL
.
          MATCH     SP70,PTMIS024                * recurring care unit
          GOTO      RECD9000 IF EQUAL
.
          PACK      KEY30,AADMNO,Z70
          CALL      RDSTRAN2                     * position on admission number
RECD1000  CALL      RDPTRAN2                     * read previous record
          BRANCH    OVRCD,RECD9000
.
          MATCH     TADMN,AADMNO                 * same admission still ?
          GOTO      RECD9000 IF NOT EQUAL        * no - finished
.
          MATCH     PTMIS024,TDEPT               * Correct unit
          GOTO      RECD1000 IF NOT EQUAL
.
          WRITE     HTMLFILE;TADOCT;             * User transfer file doctor
          GOTO      RECD9999
.
RECD9000  WRITE     HTMLFILE;ADOCTA;             * Use attending doctor
.
RECD9999  RETURN
+
.------------------------------------------------------------
.         PMAU0000 - Deceased Details Audit Output
.------------------------------------------------------------
PMAU0000  OPEN      PMSDAUA2,"pmsdauaf"
          UNPACK    DIM127,D1,KEY2,DIM127
          MOVE      KEY2,F2
          BRANCH    F2,PMAU0010
.
          WRITE     HTMLFILE;"Invalid IBA Tag"
          GOTO      PMAU9999
.
PMAU0010  PACK      KEY27,URNUMBER,ZERO,ZERO,ONE,Z70
          CALL      RSPMDAU2
PMAU0011  CALL      RPPMDAU2
          BRANCH    OVRCD,PMAU9999
.
          MATCH     "001",PMDERTYP
          GOTO      PMAU9999 IF NOT EQUAL
.
          MATCH     URNUMBER,PMDEURNO
          GOTO      PMAU9999 IF NOT EQUAL
.
          UNPACK    PMDECDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          WRITE     HTMLFILE;"<tr><td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR," ",PMDECTIM,"</td>";
.
          MATCH     SP8,PMDEFL01
          IF        !@EQUAL
            UNPACK    PMDEFL01,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          ELSE
            UNPACK      SP70,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MOVE      SP70,KEY3
          MATCH     "Y",PMDEFL02
          IF        @EQUAL
            MOVE      "Yes",KEY3
          ENDIF
          MATCH     "N",PMDEFL02
          IF        @EQUAL
            MOVE      "No",KEY3
          ENDIF
.
          MATCH     SP3,PMDEFL03
          IF        !@EQUAL
            PACK      KEY5,CATDY,PMDEFL03
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      SP70,TDESC
            ENDIF
          ELSE
            MOVE      SP70,TDESC
          ENDIF
.
          MATCH     SP10,PMDECUID
          IF        !@EQUAL
            PACK      KEY10,PMDECUID,SP70
            CALL      RDWBSE1
            IF        OVRCD=1
              MOVE     SP70,WBSENAM
            ENDIF
          ELSE
            PACK     WBSENAM,SP70
          ENDIF
.
          WRITE     HTMLFILE;"<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td><td>",KEY3:
                    "</td><td>",TDESC,"</td><td>",WBSENAM,"</td></tr>";
.
          GOTO      PMAU0011
.
PMAU9999  CLOSE     PMSDAUA2
          RETURN
.------------------------------------------------------------
.         Checking MH LS Referral Management
.------------------------------------------------------------
LSREF000  OPEN      MEHHLSA2,"mehhlsaf"
          MOVE      SP70,KEY8
          PACK      KEY32,URNUMBER,Z70
          CALL      RSMHHLS2
LSREF100  CALL      RPMHHLS2
          BRANCH    OVRCD,LSREF800
          MATCH     URNUMBER,MHHLURNO
          GOTO      LSREF800 IF NOT EQUAL
.
          MATCH     SP70,MHHLOREF
          GOTO      LSREF100 IF EQUAL
.
          PACK      KEY5,CATtm,MHHLOREF,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,LSREF100
.
          MATCH     ANSI,TCINDC1
          GOTO      LSREF100 IF NOT EQUAL
.
.         Check if it's an Open Legal status
.
          MATCH     "1",MHHLSTAT
          GOTO      LSREF100 IF EQUAL
.
          MATCH     SP70,MHHLEDAT
          GOTO      LSREF100 IF NOT EQUAL         * Not opened
.
          MOVE      MHHLUNIQ,KEY8
.
LSREF800  WRITE     HTMLFILE;KEY8;
LSREF999  RETURN
+
.------------------------------------------------------------
. Checking MH LS Referral Management (non-WA - doesn't use cat tm)
.------------------------------------------------------------
MHLSR000  OPEN      MEHHLSA2,"mehhlsaf"
          MOVE      SP70,KEY8
          PACK      KEY32,URNUMBER,Z70
          CALL      RSMHHLS2
MHLSR100  CALL      RPMHHLS2
          BRANCH    OVRCD,MHLSR800
.
          MATCH     URNUMBER,MHHLURNO
          GOTO      MHLSR800 IF NOT EQUAL
.
.-------- Check Referral Source (Cat S ind7=I) 
MHLSR200  MATCH     SP70,MHHLSREF
          GOTO      MHLSR100 IF EQUAL
.
          PACK      KEY5,ANSS,SP1,MHHLSREF,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,MHLSR100
.
          MATCH     ANSI,TCINDC7
          GOTO      MHLSR100 IF NOT EQUAL
          GOTO      MHLSR600 IF EQUAL
.
.         Check if it's an Open Legal status
.
MHLSR600  MATCH     "1",MHHLSTAT
          GOTO      MHLSR100 IF EQUAL
.
          MATCH     SP70,MHHLEDAT
          GOTO      MHLSR100 IF NOT EQUAL         * Not opened
.
          MOVE      MHHLUNIQ,KEY8
.
MHLSR800  WRITE     HTMLFILE;KEY8;
MHLSR999  RETURN
+
.------------------------------------------------------------
. Defence force service code selection
.------------------------------------------------------------
DSRV0000  UNPACK    DIM127,D1,KEY2,DIM127        * Indicator Number (F2)
          MOVE      ZERO,F2
          MOVE      KEY2,F2
.
          UNPACK    DIM127,D1,KEY1,DIM127        * Include / Exclude (F1)
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          UNPACK    SP70,KEY4,KEY1
          IF        F2=99
            UNPACK    DIM127,D1,KEY4             * Indicator Value (KEY4)
          ELSE
            IF        F1<>0
              UNPACK    DIM127,D1,KEY1,DIM127    * Indicator Value (KEY1)
            ENDIF
          ENDIF
.
          MOVE      SP70,TDESC
          PACK      KEY5,CATEGORY,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      CATEGORY,TCODE
            MOVE      "Invalid Category",TDESC
          ENDIF
          REP       " _",TCODE
          REP       " _",THCSCOD
          WRITE     HTMLFILE;"<!--<cat-c category=#"",TCODE,"#" name=#"",TDESC:
                             "#" map=#"",THCSCOD,"#"><cat-c>-->"
.
          PACK      PTCDKEY2,CATEGORY,SP70
          CALL      RDSCODE2
DSRV1000  CALL      RDKCODE2
          BRANCH    OVRCD,DSRV9999
          MATCH     CATEGORY,TCODE
          GOTO      DSRV9999 IF NOT EQUAL
.
          MATCH     SP70,ACODE
          GOTO      DSRV1000 IF EQUAL
.
          MATCH     "A",TCINDC3
          GOTO      DSRV1000 IF NOT EQUAL      * Not for Aust.Defence
.
          PACK      KEY35,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5:
                          TCINDC6,TCINDC7,TCINDC8,TCINDC9,TCINDC10:
                          TCINDC11,THCSCOD,PTCDNHCP,TCFORM6:
                          TCINDC12,TCINDC13,TCINDC14,TCINDC15,TCINDC16:
                          TCINDC17,TCINDC18,TCINDC19,TCINDC20,TCINDC21
.
          PACK      KEY40,QUOTE,ACODE,KEY35,QUOTE
          MATCH     CODE,ACODE
          GOTO      DSRV2000 IF NOT EQUAL
.
          WRITE     HTMLFILE;"<option value=",KEY40," selected>":
                             TDESC,"</option>"
          GOTO      DSRV1000
.
DSRV2000  MATCH     "I",PTCOACTV
          GOTO      DSRV1000 IF EQUAL
.
          IF        IBCNMHOS=1
            MATCH    "1",PTCDHOSS
            IF       @EQUAL
              PACK     KEY8,WBSEHOSP,TCODE,ACODE,SP70
              CALL     RDMLCOD1
              BRANCH   OVRCD,DSRV1000
            ENDIF
          ENDIF
.
          LOAD      D1,F2,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5:
                          TCINDC6,TCINDC7,TCINDC8,TCINDC9,TCINDC10:
                          TCINDC11,TCINDC12,TCINDC13,TCINDC14,TCINDC15:
                          TCINDC16,TCINDC17,TCINDC18,TCINDC19,TCINDC20,TCINDC21
.
          IF        F1=0
            MATCH     SP1,D1                   * Only display if ind F2 blank
            GOTO      DSRV1000 IF NOT EQUAL
          ENDIF
.
          IF        F1=1
            MATCH     KEY1,D1                  * Only display if ind F2=KEY1
            GOTO      DSRV1000 IF NOT EQUAL
          ENDIF
.
          IF        F1=2
            MATCH     KEY1,D1                  * Skip if ind F2=KEY1
            GOTO      DSRV1000 IF EQUAL
          ENDIF
.
          WRITE     HTMLFILE;"<option value=",KEY40,">",TDESC,"</option>"
          GOTO      DSRV1000
.
DSRV9999  RETURN
+
.*****************************************************************************
.         SX Insurer free text field
.*****************************************************************************
SXIN0000  MATCH     SP70,NZSPINSR
          GOTO      SXIN9999 IF EQUAL
.
          MOVE      "I ",KEY2
          PACK      KEY5,KEY2,NZSPINSR,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,SXIN9999
.
          MATCH     "O",TCINDC1
          GOTO      SXIN9999 IF NOT EQUAL    * Not Other Insurer
.
          MOVE      ADMISSNO,VSCTVIST
          MOVE      "006",VSCTTYPE
          MOVE      "  1",VSCTLINE
.
          MATCH     Z70,NZSPR005
          GOTO      SXIN2000 IF EQUAL
.
          PACK      KEY11,ADMISSNO,NZSPR005,SP70
          CALL      RDNZSPR1
          IF        OVRCD=0
            MOVE      NZSPUNIQ,VSCTLINE
          ENDIF
          PACK      KEY14,VSCTVIST,VSCTTYPE,VSCTLINE,SP70
          CALL      RDVSCMT1
          BRANCH    OVRCD,SXIN9999
          GOTO      SXIN8000
.
SXIN2000  PACK      KEY14,VSCTVIST,VSCTTYPE,Z70
          CALL      RSVSCMT1
          CALL      RPVSCMT1
          BRANCH    OVRCD,SXIN9999
.
          MATCH     ADMISSNO,VSCTVIST
          GOTO      SXIN9999 IF NOT EQUAL
.
SXIN8000  UNPACK    VSCTDATA,KEY50
          WRITE     HTMLFILE;KEY50;
SXIN9999  RETURN
+
.------------------------------------------------------------
.         Check if Extra Comp.record already exist
.------------------------------------------------------------
CPEX0000  MOVE      ZERO,F1
          CALL      GCLM0000           * Get claim code
          PACK      KEY11,ADMISSNO,ACLAIM,SP70
          CALL      RDPMEXT1
          MOVE      OVRCD,F1
          WRITE     HTMLFILE;F1;
CPEX9999  RETURN
+
.------------------------------------------------------------
. Get claim code for a visit
.------------------------------------------------------------
GCLM0000  MOVE      ADMISSNO,KEY8
          PACK      KEY8,ADMISSNO,SP70     * Read Visit Extension File?
          CALL      RDPMVX11
          BRANCH    OVRCD,GCLM9000
.
          MOVE      ZERO,PVITYPE
          CALL      RDVISA1
          BRANCH    OVRCD,GCLM2000
          BRANCH    PVITYPE,GCLM1000,GCLM2000,GCLM3000
          IF        PVITYPE=9
            MATCH     " 2",PVISYST               * AH Referral
            GOTO      GCLM4000 IF EQUAL
          ENDIF
          GOTO      GCLM2000
.
GCLM1000  CALL      RDEMVIS1              * try emergency file
          IF        OVRCD=1
            CALL      RDDETA1             * try aae file
            IF        OVRCD=0
              MOVE      ADACOMP,ACLAIM
              MOVE      ADACOMP,EMVICOMP
            ENDIF
          ELSE
            IF        EMVISTAT<>FOUR
              MOVE      EMVICOMP,ACLAIM
            ENDIF
          ENDIF
          GOTO      GCLM8000
.
GCLM2000  CALL      RDBOKB1
          BRANCH    OVRCD,GCLM9999
          MOVE      OBACOMP,ACLAIM
          GOTO      GCLM8000
.
GCLM3000  CALL      RDMISS1
          BRANCH    OVRCD,GCLM9999
          GOTO      GCLM8000
.
GCLM4000  CALL      RDALREF1
          BRANCH    OVRCD,GCLM9999
          MOVE      ALRECOMP,ACLAIM
.
GCLM8000  MOVE      ZERO,EXIT
          GOTO      GCLM9999
.
GCLM9000  MOVE      ONE,EXIT
GCLM9999  RETURN
+
.*****************************************************************************
.         External organisation
.*****************************************************************************
PTEO0000  BRANCH    FLDITMNO,PTEO0100,PTEO0200,PTEO0300,PTEO0400,PTEO0500
.
PTEO0100  WRITE     HTMLFILE;PTERADD1;  * Address
          GOTO      PTEO9999
.
PTEO0200  WRITE     HTMLFILE;PTERADD2;  * Address
          GOTO      PTEO9999
.
PTEO0300  WRITE     HTMLFILE;PTERADD3;  * Address
          GOTO      PTEO9999
.
PTEO0400  WRITE     HTMLFILE;PTERADD4;  * Address
          GOTO      PTEO9999
.
PTEO0500  WRITE     HTMLFILE;PTERPOST;  * Postcode
          GOTO      PTEO9999
.
PTEO9999  RETURN
+
.*****************************************************************************
.*  CPEMR000
.*  Function to Copy EMR Diagnosis Details
.*****************************************************************************
CPEMR000  READ      CONTROLF,HUND17;*216,PTCNDSID
          MOVE      "0",IGNWRNFL
          MOVE      ONE,ACCOUNT
          PACK      KEY23,PTCLM011,SP70
          CALL      RSACDIA1
CPEMR100  CALL      RKACDIA1
          BRANCH    OVRCD,CPEMR110
.
          MATCH     PTCLM011,ACDIACCN               * Same ACC number?
          GOTO      CPEMR110 IF NOT EQUAL
.
          ADD       ONE,ACCOUNT
          GOTO      CPEMR100
.
CPEMR110  PACK      KEY14,ADMISSNO,SP70
          CALL      RSEMVCD1
CPEMR210  CALL      RKEMVCD1
          BRANCH    OVRCD,CPEMR999
.
          MATCH     ADMISSNO,EMVCVIST               * Same Visit Number?
          GOTO      CPEMR999 IF NOT EQUAL
.
          MATCH     "005",EMVCTYPE
          GOTO      CPEMR210 IF NOT EQUAL
.
          MOVE      EMVCMNCD,KEY9
          CALL      RDEMICD1
          BRANCH    OVRCD,CPEMR210
.
          COMPARE   ONE,EMICACTV
          GOTO      CPEMR210 IF EQUAL
.
          COMPARE   TWO,EMICACTV
          IF        @EQUAL
            MOVE      "1",IGNWRNFL 
            GOTO      CPEMR210 
          ENDIF
.
          PACK      ACDIACCN,PTCLM011,SP70
          MOVE      EMVCMNCD,ACDIDIAG
          MOVE      SP70,ACDICSYC
          MOVE      SP70,ACDISIDE
.
.         NZ only...
          IF        PTCNHDPS=1
            MOVE      THREE,F1                     * Default to 3 = N/A
            MOVE      EMVCUDC1,F1
            MOVE      F1,ACDISIDE
            MOVE      PTCNDSID,ACDICSYC
          ENDIF
.
          MOVE      ACCOUNT,ACDICONT
          PACK      KEY23,ACDIACCN,ACDICONT,SP70
          CALL      WRACDIA1                        * Write record to accdiaaf
          ADD       ONE,ACCOUNT
          GOTO      CPEMR210
.
CPEMR999  MATCH     "1",IGNWRNFL
          IF        @EQUAL  
            PACK      WEBTITLE,WRNMESS1,WRNMESS2
            CALL      WEBERR00
          ENDIF
          CALL      NXTPAG00
          RETURN
.
.*****************************************************************************
.*  CHKCCD00
.*  Procedure to check if a patient has a concession card
.*  Exit=0  No concession cards exist
.*      =1  Valid concession card(s) exist
.*      =2  Only expired concession card(s) exist
.*****************************************************************************
          DEFPROC   CHKCCD00
.
          INC       PMSCCDFD/INC
.
          CALL      IBACLOCK                * Get the current date
          PACK      XDATE,CCC,CYY,CMM,CDD
          REP       " 0",XDATE
.
          MOVE      ZERO,EXIT               * default to no ccards
          OPEN      PMSCCDA1,"pmsccdaf"
.
          PACK      KEY19,PURNO,SP70
          CALL      RSPMCCD1           * Read concession card table
CHKCCD10  CALL      RKPMCCD1
          BRANCH    OVRCD,CHKCCD99
.
          MATCH     PURNO,PMCDURNO     * Check same UR
          GOTO      CHKCCD99 IF NOT EQUAL
.
          IF        BLANKEXP = 1
            MATCH     SP70,PMCDEXDT    * check if exp. date is blank
            IF        @EQUAL
              MOVE      ONE,EXIT       * valid ccard exists
              GOTO      CHKCCD99
            ENDIF
          ENDIF
.
          MATCH     XDATE,PMCDEXDT     * check if exp. date is >= current date
          IF        !@LESS
            MOVE      ONE,EXIT         * valid ccard exists
            GOTO      CHKCCD99
          ENDIF
.
          MOVE      TWO,EXIT           * only expired ccard(s) exist
          GOTO      CHKCCD10
.
          INC       PMSCCDIO/INC
          INC       IBAOVRIO/INC
.
CHKCCD99  CLOSE     PMSCCDA1
.
          ENDPROC
+
.*****************************************************************************
.*  CHKDVA00
.*  Procedure to check if a patient has a DVA concession card
.*  Exit=0  No concession cards exist
.*      =1  Valid DVA concession card(s) exist
.*****************************************************************************
          DEFPROC   CHKDVA00
.
          INC       PMSCCDFD/INC
.
          CALL      IBACLOCK                * Get the current date
          PACK      XDATE,CCC,CYY,CMM,CDD
          REP       " 0",XDATE
.
          MOVE      ZERO,EXIT               * default to no ccards
          OPEN      PMSCCDA1,"pmsccdaf"
.
          PACK      KEY19,PURNO,SP70
          CALL      RSPMCCD1           * Read concession card table
CHKDVA10  CALL      RKPMCCD1
          BRANCH    OVRCD,CHKDVA99
.
          MATCH     PURNO,PMCDURNO     * Check same UR
          GOTO      CHKDVA99 IF NOT EQUAL
.
          MATCH     SP70,PMCDEXDT
          IF        !@EQUAL & !@EOS
            MATCH     XDATE,PMCDEXDT     * check if exp. date is >= current date
            IF        @LESS
              GOTO      CHKDVA10
            ENDIF
          ENDIF
.
          MATCH     SP70,PMCDDVAC
          GOTO      CHKDVA10 IF EQUAL
.
          PACK      KEY5,ANSD,ANSX,PMCDDVAC,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CHKDVA10
.
          MATCH     ANSG,THCSCOD
          GOTO      CHKDVA10 IF NOT EQUAL
.
          MOVE      ONE,EXIT
          GOTO      CHKDVA99
.
          INC       PMSCCDIO/INC
          INC       IBAOVRIO/INC
.
CHKDVA99  CLOSE     PMSCCDA1
.
          ENDPROC
+
.*****************************************************************************
.*  CHKCER00
.*  Procedure to check if a patient has a Certificates
.*  Exit=0  No Certificates exist
.*      =1  Certificates do exist
.*****************************************************************************
          DEFPROC   CHKCER00
.
          INC       PATCERFD/INC
.
          MOVE      ZERO,EXIT               * default to no certificates
          OPEN      PATCERA1,"patceraf"
.
          PACK      KEY19,PURNO,SP70
          CALL      RSPTCER1                * read certificates
CHKCER10  CALL      RKPTCER1
          BRANCH    OVRCD,CHKCER99
.
          MATCH     PURNO,PTCEURNO          * Check same UR
          GOTO      CHKCER99 IF NOT EQUAL
.
          MOVE      ONE,EXIT                * Certificate/s exist
          GOTO      CHKCER99
.
          INC       PATCERIO/INC
          INC       IBAOVRIO/INC
.
CHKCER99  CLOSE     PATCERA1
.
          ENDPROC
+
.------------------------------------------------------------
. PREA0000 - Check if patient has a preadmission record
.------------------------------------------------------------
PREA0000  MOVE      ZERO,PREAFLAG
.
          PACK      KEY17,URNUMBER,ONE,SP20
          CALL      RSPTMI18
PREA1000  CALL      RKPTMI18
          BRANCH    OVRCD,PREA9999          * not on file
.
          MATCH     URNUMBER,AURNO          * same U/R Number?
          GOTO      PREA9999 IF NOT EQUAL   * No
.
          COMPARE   ONE,ASTAT
          GOTO      PREA9999 IF NOT EQUAL
.
          MOVE      ONE,PREAFLAG
.
PREA9999  RETURN
+
.------------------------------------------------------------
. LSTALI00 - List Aliases
.------------------------------------------------------------
.
LSTALI00  MOVE      URNUMBER,GSRURNO
          PACK      KEY115,GSRURNO,SP70,SP70
          CALL      RSPTGSR1
LSTALI10  CALL      RKPTGSR1
          BRANCH    OVRCD,LSTALI99
.
          MATCH     GSRURNO,PURNO
          GOTO      LSTALI99 IF NOT EQUAL
.
          MATCH     GSRSNAM,PTMASNAM
          GOTO      LSTALI20 IF NOT EQUAL
.
          MATCH     GSRGNAM,PMPXFNAM
          GOTO      LSTALI20 IF NOT EQUAL
.
          MATCH     PTGSGNM2,PMPXSNAM
          GOTO      LSTALI20 IF NOT EQUAL
.
          MATCH     GSRDOB,PBDATE
          GOTO      LSTALI20 IF NOT EQUAL
.
          MATCH     GSRSEX,PSEX
          GOTO      LSTALI10 IF EQUAL
.
LSTALI20  UNPACK    GSRDOB,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
.
          MOVE      SP70,KEY13
.
.* ****************************************** Start of Changes         *C-49016
          MOVE      GSRSEX,DSEXCHAR
          CALL      SEXDSC00                * get sex description (in IBACOMN)
.                                           *       returns DSEXDESC & DSEXNO
          PACK      KEY13,DSEXDESC,SP20
.* ******************************************   End of Changes         *C-49016
.
          MOVE      GSRSNAM,SURNAME
          MOVE      GSRGNAM,GIVNAME
          MOVE      PTGSGNM2,GIVNAM2
          CALL      JAVNAM00
.
          WRITE     HTMLFILE;*+,"<tr><td>",GSRSNAM,"</td>":
                             "<td>",GSRGNAM," ",PTGSGNM2,"</td>":
                             "<td>",CPCDATE,"</td>":
                             "<td>",KEY13,"</td>":
                             "<td>":
                             "<input type=button class=button value=Delete ":
                             "onClick='DeleteAlias(#"",JAVSNAME:
                             "#",#"",JAVGNAME:
                             "#",#"",GSRDOB:
                             "#",#"",GSRSEX:
                             "#",#"",JAVGNAM2:
                             "#");'></td>":
                             "</tr>";
          GOTO      LSTALI10
.
LSTALI99  RETURN
+
.------------------------------------------------------------
. LSTALV00 - List Aliases (View Only)
.------------------------------------------------------------
LSTALV00  MOVE      URNUMBER,GSRURNO
          PACK      KEY115,GSRURNO,SP70,SP70
          CALL      RSPTGSR1
LSTALV10  CALL      RKPTGSR1
          BRANCH    OVRCD,LSTALV99
.
          MATCH     GSRURNO,PURNO
          GOTO      LSTALV99 IF NOT EQUAL
.
          MATCH     GSRSNAM,PTMASNAM
          GOTO      LSTALV20 IF NOT EQUAL
.
          MATCH     GSRGNAM,PMPXFNAM
          GOTO      LSTALV20 IF NOT EQUAL
.
          MATCH     PTGSGNM2,PMPXSNAM
          GOTO      LSTALV20 IF NOT EQUAL
.
          MATCH     GSRDOB,PBDATE
          GOTO      LSTALV20 IF NOT EQUAL
.
          MATCH     GSRSEX,PSEX
          GOTO      LSTALV10 IF EQUAL
.
LSTALV20  UNPACK    GSRDOB,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
.
          MOVE      SP70,KEY13
.
.* ****************************************** Start of Changes         *C-49016
          MOVE      GSRSEX,DSEXCHAR
          CALL      SEXDSC00                * get sex description (in IBACOMN)
.                                           *       returns DSEXDESC & DSEXNO
          PACK      KEY13,DSEXDESC,SP20
.* ******************************************   End of Changes         *C-49016
.
          MOVE      GSRSNAM,SURNAME
          MOVE      GSRGNAM,GIVNAME
          MOVE      PTGSGNM2,GIVNAM2
          CALL      JAVNAM00
          WRITE     HTMLFILE;"<tr><td>",GSRSNAM,"</td>":
                             "<td>",GSRGNAM,SP1,PTGSGNM2,"</td>":
                             "<td>",CPCDATE,"</td>":
                             "<td>",KEY13,"</td>":
                             "<td>":
                             "</tr>";
          GOTO      LSTALV10
.
LSTALV99  RETURN
+
.----------------------------------------------------------------------
. JAVNAM00
. Format Patient Name (for Javascript)  <b>SURNAME</b>Title Given Names
.*** format the surname and given name by changing any ' to %60
.----------------------------------------------------------------------
.
JAVNAM00  CLEAR     DISPNAME
          MOVE      SP70,JAVFNAME
.
          MOVE      SURNAME,JAVSNAME          * surname
          SCAN      "'",JAVSNAME             * find any apostrophies
          GOTO      JAVNAM10 IF NOT EQUAL
.
          MOVE      JAVSNAME,ENDNAME
          REP       "' ",ENDNAME             * remove the apostrophy
.
          LENSET    JAVSNAME
          RESET     JAVSNAME                 * get all characters before '
          MOVE      JAVSNAME,STRTNAME
.
          REP       "'%",STRTNAME
          STRIP     STRTNAME
          PACK      JAVSNAME,STRTNAME,SIXTY,ENDNAME,SP70 * formatted surname
.
JAVNAM10  MOVE      SP70,STRTNAME
          MOVE      SP70,ENDNAME
.
          MOVE      GIVNAME,JAVGNAME     * given name
          SCAN      "'",JAVGNAME        * find any apostrophies
          GOTO      JAVNAM20 IF NOT EQUAL
.
          MOVE      JAVGNAME,ENDNAME    * store all chars after apostrophy
          REP       "' ",ENDNAME        * remove the apostrophy
.
          LENSET    JAVGNAME
          RESET     JAVGNAME
          MOVE      JAVGNAME,STRTNAME   * store all chars before the '
.
          REP       "'%",STRTNAME
          STRIP     STRTNAME
          PACK      JAVGNAME,STRTNAME,SIXTY,ENDNAME,SP70  * formatted given name
.
JAVNAM20  MOVE      SP70,STRTNAME
          MOVE      SP70,ENDNAME
.
          MOVE      GIVNAM2,JAVGNAM2     * given name 2
          SCAN      "'",JAVGNAM2        * find any apostrophies
          GOTO      JAVNAM30 IF NOT EQUAL
.
          MOVE      JAVGNAM2,ENDNAME    * store all chars after apostrophy
          REP       "' ",ENDNAME        * remove the apostrophy
.
          LENSET    JAVGNAM2
          RESET     JAVGNAM2
          MOVE      JAVGNAM2,STRTNAME   * store all chars before the '
.
          REP       "'%",STRTNAME
          STRIP     STRTNAME
          PACK      JAVGNAM2,STRTNAME,SIXTY,ENDNAME,SP70  * formatted given name
.
JAVNAM30  REP       "#" ",JAVSNAME        * format the name for display
          REP       "#" ",JAVGNAME
          REP       "#" ",JAVGNAM2
          MOVE      SP70,JAVFNAME
          REP       UPPLOW,JAVSNAME
          PACK      NAME35,PTITL,SP70
          CALL      NAMSTR00
          PACK      NAME35,JAVGNAME,SP70
          CALL      NAMSTR00
          PACK      NAME35,JAVGNAM2,SP70
          CALL      NAMSTR00
          REP       UPPLOW,JAVSNAME
          APPEND    JAVSNAME,DISPNAME
          APPEND    SP70,DISPNAME
          RESET     DISPNAME
          MOVE      DISPNAME,JAVFNAME
          STRIP     JAVFNAME
.
JAVNAM99  RETURN
+
.-----------------------------------------------------------------
. LSTALB00 - List Aliases (without displaying date of birth & sex)
.-----------------------------------------------------------------
.
LSTALB00  MOVE      URNUMBER,GSRURNO
          PACK      KEY115,GSRURNO,SP70,SP70
          CALL      RSPTGSR1
LSTALB10  CALL      RKPTGSR1
          BRANCH    OVRCD,LSTALB99
.
          MATCH     GSRURNO,PURNO
          GOTO      LSTALB99 IF NOT EQUAL
.
          MATCH     GSRSNAM,PTMASNAM
          GOTO      LSTALB20 IF NOT EQUAL
.
          MATCH     GSRGNAM,PMPXFNAM
          GOTO      LSTALB20 IF NOT EQUAL
.
          MATCH     PTGSGNM2,PMPXSNAM
          GOTO      LSTALB20 IF NOT EQUAL
.
          MATCH     GSRDOB,PBDATE
          GOTO      LSTALB20 IF NOT EQUAL
.
          MATCH     GSRSEX,PSEX
          GOTO      LSTALB10 IF EQUAL
.
LSTALB20  MOVE      GSRSNAM,SURNAME
          MOVE      GSRGNAM,GIVNAME
          MOVE      PTGSGNM2,GIVNAM2
          CALL      JAVNAM00
          WRITE     HTMLFILE;"<tr><td>",GSRSNAM,"</td>":
                             "<td>",GSRGNAM,"</td>":
                             "<td> &nbsp;</td>":
                             "<td> &nbsp;</td>":
                             "<td>":
                             "<input type=button class=button value=Delete ":
                             "onClick='DeleteAlias(#"",JAVSNAME:
                             "#",#"",JAVGNAME:
                             "#",#"",GSRDOB:
                             "#",#"",GSRSEX:
                             "#",#"",JAVGNAM2:
                             "#");'></td>":
                             "</tr>";
          GOTO      LSTALB10
.
LSTALB99  RETURN
+
.-----------------------------------------------------------
. CANUR000 - Cancel U/R Number
. Returns:   EXIT   0 = Ok to continue
.                   1 = Error
.-----------------------------------------------------------
          DEFPROC   CANUR000
.
          INC       CCIUTLFD/INC
          INC       LEGALTFD/INC
          INC       LEGVISFD/INC
          INC       OUTBOAFD/INC
          INC       PATLINFD/INC
          INC       PRIHDBFD/INC
          INC       PRIDTRFD/INC
.
CANUR000  CALL      INTMAS00
          OPEN      PRIHDBT1,"prihdbtf"
          OPEN      PRIDTRA3,"pridtraf"
          OPEN      CCIUTLL5,"cciutlaf"
          OPEN      PATLINK1,"patlinkf"
          OPEN      PATVISA2,"patvisaf"
          OPEN      WATTR1A1,"wattr1af"
          OPEN      PATMWSA1,"patmwsaf"
          OPEN      PATDNRA1,"patdnraf"
          OPEN      PATLOCA1,"patlocaf"
          OPEN      MRTMASA1,"mrtmasaf"
          OPEN      BOKRC1A6,"bokrc1af"
          OPEN      PATPA1A1,"patpa1af"
          OPEN      PATGSRN1,"patgsrnf"
          OPEN      PATURAD1,"paturadf"
.
          MOVE      "out",CFILEPRE
          PACK      CFNAME,CFILEPRE,FILBOKA3
          OPEN      OUTBOKA3,CFNAME
.
          CALL      OPPTAUU1
          MOVE      URNUMBER,KEY8            * Validate UR Number
          CALL      RDMAST1
          BRANCH    OVRCD,CANUR910
.
          CALL      RDPMPX21
          BRANCH    OVRCD,CANUR910
.
. Check for the U/R number in different files,if exists then DON'T CANCEL
.
          PACK      KEY24,URNUMBER,SP70       * Patient Visit File
          CALL      RDSVISA2
CANUR005  CALL      RDKVISA2
          BRANCH    OVRCD,CANUR010
.
          MATCH     URNUMBER,PVIURNO          * Make sure the only visits left
          IF        @EQUAL
            MATCH     " 3",PTVITYPE           * are cancelled admissions
            GOTO      CANUR920 IF NOT EQUAL
.
            PACK      KEY8,PVIBILL,SP70
            CALL      RDMISS1
            BRANCH    OVRCD,CANUR920
.
            COMPARE   FIVE,ASTAT
            GOTO      CANUR005 IF EQUAL
            GOTO      CANUR920
          ENDIF
.
CANUR010  PACK      KEY19,URNUMBER,SP70       * Waiting List File
          CALL      RDSTREA1
          CALL      RDKTREA1
          BRANCH    OVRCD,CANUR020
.
          MATCH     URNUMBER,WMURNO
          GOTO      CANUR920 IF EQUAL
.
CANUR020  PACK      KEY27,URNUMBER,SP70       * Private Practice Holding Header
          CALL      RSPRHD1
          CALL      RKPRHD1
          BRANCH    OVRCD,CANUR030
.
          MATCH     URNUMBER,PRHDDEBT
          GOTO      CANUR920 IF EQUAL
.
CANUR030  PACK      KEY24,URNUMBER,SP70       * Private Practice Tranasaction
          CALL      RSPRDT3
          CALL      RKPRDT3
          BRANCH    OVRCD,CANUR040
.
          MATCH     URNUMBER,PRDTDEBT
          GOTO      CANUR920 IF EQUAL
.
CANUR040  PACK      KEY42,URNUMBER,SP70       * Clinic Costing Interface
          CALL      RSCCUTL5
          CALL      RKCCUTL5
          BRANCH    OVRCD,CANUR050
.
          MATCH     URNUMBER,CCUTURNO
          GOTO      CANUR920 IF EQUAL
.
CANUR050  PACK      KEY36,URNUMBER,SP70       * OutPatient Booking File
          CALL      RDSBOKA3
          CALL      RDKBOKA3
          BRANCH    OVRCD,CANUR060
.
          MATCH     URNUMBER,OBAURNO
          GOTO      CANUR920 IF EQUAL
.
CANUR060  MOVE      ZERO,OVRCD                * assume file exists
          TRAP      OVERCOND IF IO            * trap for error openning file
          OPEN      LEGVISA2,"legvisaf"
          TRAPCLR   IO
          BRANCH    OVRCD,CANUR070            * open failed
.
          PACK      KEY24,URNUMBER,SP70       * Legacy Visit File
          CALL      RSLGVIS2
          CALL      RKLGVIS2
          BRANCH    OVRCD,CANUR070
.
          MATCH     URNUMBER,LVIURNO
          GOTO      CANUR920 IF EQUAL
.
CANUR070  MOVE      ZERO,OVRCD                * assume file exists
          TRAP      OVERCOND IF IO            * trap for error openning file
          OPEN      LEGALTA1,"legaltaf"
          TRAPCLR   IO
          BRANCH    OVRCD,CANUR080            * open failed
.
          PACK      KEY32,URNUMBER,SP70       * Alternate Legacy System
          CALL      RSLGALT1
          CALL      RKLGALT1
          BRANCH    OVRCD,CANUR080
.
          MATCH     URNUMBER,LGATURNO
          GOTO      CANUR920 IF EQUAL
.
CANUR080  PACK      KEY16,URNUMBER,SP70       * Booking File
          CALL      RSBKREC6
CANUR085  CALL      RKBKREC6
          BRANCH    OVRCD,CANUR190
.
          MATCH     URNUMBER,BKREURNO
          GOTO      CANUR190 IF NOT EQUAL
.
          COMPARE   TWO,BKRESTAT
          GOTO      CANUR920 IF NOT EQUAL
          GOTO      CANUR085
.
. No Records found in any of the files. Start deleting records
.
CANUR190  MOVE      URNUMBER,KEY8               * Patient Master File
          CALL      RDMAST1
          BRANCH    OVRCD,CANUR910
.
CANUR195  PACK      KEY24,URNUMBER,SP70         * Should only be cancelled
          CALL      RDSVISA2                    * preadmissions left
          CALL      RDKVISA2
          BRANCH    OVRCD,CANUR200
.
          MATCH     URNUMBER,PVIURNO
          GOTO      CANUR200 IF NOT EQUAL
.
          PACK      KEY8,PVIBILL,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,CANUR200
.
          COMPARE   FIVE,ASTAT                  * Delete cancelled
          GOTO      CANUR200 IF NOT EQUAL       * pre admissions
.
          PACK      KEY8,AADMNO,SP70
          CALL      DEPTMIS1
.
          PACK      KEY8,PVIBILL,SP70            * Delete visit record
          CALL      DEVISA1                     * of cancelled pre admission
.
          GOTO      CANUR195
.
CANUR200  PACK      KEY14,URNUMBER,SP70         * Medical Warning File
          CALL      RSPTMWS1
          CALL      RKPTMWS1
          BRANCH    OVRCD,CANUR210
.
          MATCH     URNUMBER,PTMWURNO
          GOTO      CANUR210 IF NOT EQUAL
.
          PACK      KEY14,PTMWURNO,PTMWCLSS,PTMWCNT
          CALL      DEPTMWS1
          GOTO      CANUR200
.
CANUR210  PACK      KEY10,URNUMBER,SP70         * Patient Donor Details
          CALL      RSPTDNR1
          CALL      RKPTDNR1
          BRANCH    OVRCD,CANUR220
.
          MATCH     URNUMBER,PTDNURNO
          GOTO      CANUR220 IF NOT EQUAL
.
          PACK      KEY10,PTDNURNO,PTDNCNT
          CALL      DEPTDNR1
          GOTO      CANUR210
.
CANUR220  PACK      KEY16,URNUMBER,SP70         * Patient U/R Linkage
          CALL      RDSLINK1
          CALL      RDKLINK1
          BRANCH    OVRCD,CANUR230
.
          MATCH     URNUMBER,LINKFUR
          GOTO      CANUR230 IF NOT EQUAL
.
          MOVE      LINKFUR,DUMURNO
          PACK      KEY16,LINKFUR,LINKTUR
          CALL      DELINK1
.
          PACK      KEY16,DUMURNO,SP70
          CALL      RDSLINK1
          CALL      RDKLINK1
          BRANCH    OVRCD,CANUR230
.
          MATCH     DUMURNO,LINKFUR
          GOTO      CANUR230 IF NOT EQUAL
.
          PACK      KEY16,LINKFUR,LINKTUR
          CALL      DELINK1
.
CANUR230  PACK      KEY88,SP70,SP70              * Patient Location File
          CALL      RDSLOCA1
          CALL      RDKLOCA1
          BRANCH    OVRCD,CANUR240
.
          MATCH     URNUMBER,LURNO
          GOTO      CANUR240 IF NOT EQUAL
.
          PACK      KEY88,LSNAME,LGNAME,LADMNO
          CALL      DELOCA1
          GOTO      CANUR230
.
CANUR240  MOVE      URNUMBER,PURNO            * Patient U/R Comments
          MOVE      URCMTTYP,KEY3
          CALL      DLUCM000                  * delete ur comments
.                                                                *c-240724
CANUR250  PACK      KEY20,URNUMBER,SP70         * Patient Tracking Master
          CALL      RSMRMAS1
          CALL      RKMRMAS1
          BRANCH    OVRCD,CANUR260
.
          MATCH     URNUMBER,MRMAURNO
          GOTO      CANUR260 IF NOT EQUAL
.                                                                *c-240724
          PACK      KEY20,MRMAURNO,MRMAHHOS,MRMAHLOC,MRMADOTY,MRMAVOLN
          CALL      DETMAS1
          CALL      DELHIS00
          GOTO      CANUR250
.
CANUR260  PACK      KEY16,URNUMBER,SP70         * Patient Booking Master
          CALL      RSBKREC6
          CALL      RKBKREC6
          BRANCH    OVRCD,CANUR270
.
          MATCH     URNUMBER,BKREURNO
          GOTO      CANUR270 IF NOT EQUAL
.
          PACK      KEY16,BKREURNO,BKREBOOK,SP70
          CALL      DEBKREC6
.
          PACK      KEY8,BKREBOOK,SP70
          CALL      DEBKRX11
          GOTO      CANUR260
.
CANUR270  OPEN      PATNIDA1,"patnidaf"
          PACK      KEY10,CHOSINDX,URNUMBER,SP70    * Patient NMPI file
          CALL      RSPTNID1
          CALL      RKPTNID1
          BRANCH    OVRCD,CANUR280
.
          MATCH     URNUMBER,PTNILNUM
          IF        @EQUAL
            PACK      KEY10,PTNIHNUM,PTNILNUM
            CALL      DEPTNID1
            GOTO      CANUR270
          ENDIF
.
CANUR280  PACK      KEY16,URNUMBER,SP70         * Patient Alert File
          CALL      RSPTALR1
          CALL      RKPTALR1
          BRANCH    OVRCD,CANUR290
.
          MATCH     URNUMBER,PTALURNO
          GOTO      CANUR290 IF NOT EQUAL
.
          PACK      KEY16,PTALURNO,PTALCATG,PTALCODE,PTALCNTR
          CALL      DEPTALR1
          GOTO      CANUR280
.
CANUR290  OPEN      PATURAD2,"paturadf"
          PACK      KEY17,URNUMBER,SP70         * Patient U/R Audit File
          CALL      RDSURAD2
          CALL      RDKURAD2
          BRANCH    OVRCD,CANUR300
.
          MATCH     URNUMBER,URURNO
          GOTO      CANUR300 IF NOT EQUAL
.
          PACK      KEY17,URRTYPE,URDATE,URURNO
          CALL      DEURAD1
          GOTO      CANUR290
.
CANUR300  CLOSE     PATURAD2
          PACK      KEY24,URNUMBER,SP70         * Patient Address Entries
          CALL      RDSPADD1
          CALL      RDKPADD1
          BRANCH    OVRCD,CANUR310
.
          MATCH     URNUMBER,PAURNO
          GOTO      CANUR310 IF NOT EQUAL
.
          PACK      KEY24,PAURNO,PADATE,PATIME
          CALL      DEPADD1
          GOTO      CANUR300
.
CANUR310  PACK      KEY115,URNUMBER,SP70,SP70
          CALL      RSPTGSR1                  * Patient Surname File
          CALL      RKPTGSR1
          BRANCH    OVRCD,CANUR315
.
          MATCH     URNUMBER,GSRURNO
          GOTO      CANUR315 IF NOT EQUAL
.
          PACK      KEY115,GSRURNO,GSRBILL,GSRSNAM,GSRGNAM,PTGSGNM2,GSRDOB:
                           GSRSEX
          CALL      DEPTGSR1
          GOTO      CANUR310
.
CANUR315  PACK      KEY14,URNUMBER,SP20
          CALL      RSPMCEX1                  * Contact details 
          CALL      RKPMCEX1
          BRANCH    OVRCD,CANUR320
.
          MATCH     URNUMBER,PMCEURNO
          GOTO      CANUR320 IF NOT EQUAL
.
          PACK      KEY14,PMCEURNO,PMCETYPE,PMCECNTR
          CALL      DEPMCEX1                  * delete record
          GOTO      CANUR315
.
. Update U/R Cancellation Audit File if PMI Deletion Parameter is ONE
.
CANUR320  COMPARE   ONE,CURDEL
          GOTO      CANUR330 IF NOT EQUAL
.
          MOVE      "PU1",PRXCODE
          CALL      GETSLK00
          CALL      RDSAUDU
          COMPARE   TWO,AUSTAT
          GOTO      CANUR930 IF EQUAL
.
          MOVE      ONE,AUSTAT
          CALL      WRSAUDUX
          CALL      RELSLK00
          MOVE      URNUMBER,AUURNO
          MOVE      PTITL,AUTITL
          MOVE      PSNAME,AUSNAM
          MOVE      PGNAME,AUGNAM
          MOVE      PADD1,AUADD1
          MOVE      PADD2,AUADD2
          MOVE      PSUBRB,AUSUBR
          MOVE      PADD4,AUADD4
          MOVE      PPOST,AUPOST
          MOVE      PMEDI,AUMEDI
          MOVE      PTELEP,AUTELP
          MOVE      PSEX,AUSEX
          PACK      AUBDAT,PBDATE
.
          PACK      AUDATE,CCC,CYY,CMM,CDD
          REP       " 0",AUDATE
          CLOCK     TIME,AUTIME
.
          MOVE      PASSCODE,AUOPID
          MOVE      SECUSER,AUOPER
          CALL      UPAUDU
.
. Finally Delete the Master Record....
.
CANUR330  CALL      UNLE0000    * unlink from eadmission if required
          PACK      KEY8,URNUMBER
          CALL      DEMAST1
          CALL      DEPMPX21
.......   MOVE      "U/R Number has been cancelled",WEBTITLE
.......   CALL      WEBERR00
          MOVE      ZERO,EXIT
          GOTO      CANUR999
.
CANUR910  MOVE      "Invalid UR Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CANUR999
.
CANUR920  MOVE      "U/R Number can't be Cancelled",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CANUR999
.
CANUR930  CALL      RELSLK00
          MOVE      "Please wait till Audit file is free",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CANUR999
.
          INC       IBAOVRIO/INC
          INC       CCIUTLIO/INC
          INC       LEGALTIO/INC
          INC       LEGVISIO/INC
          INC       OUTBOAIO/INC
          INC       PATLINIO/INC
          INC       PRIHDBIO/INC
          INC       PRIDTRIO/INC
.
CANUR999  ENDPROC
+
.---------------------------------------------------------------------------
. Delete History Details records for deleted Medical Record
.---------------------------------------------------------------------------
DELHIS00  PACK      KEY26,MRMAKEY,SP70
          CALL      RSMRHIS1
          CALL      RKMRHIS1
          BRANCH    OVRCD,DELHIS99
.
          MATCH     MRMAKEY,MRHIKEY
          GOTO      DELHIS99 IF NOT EQUAL
.
          PACK      KEY26,MRHIKEY,MRHIDATE,MRHITIME,SP70
          CALL      DEMRHIS1
.
          GOTO      DELHIS00
.
DELHIS99  RETURN
.------------------------------------------------------------
. Delete PATPNI record
.------------------------------------------------------------
.
DPNI0000  COMPARE   ZERO,PTCNNMPI            * no link between U/R & NMPI
          GOTO      DPNI9999 IF EQUAL
.
          PACK      KEY10,CHOSPNUM,AADMNO
          CALL      DEPTPNI1                 * delete record
.
DPNI9999  RETURN
+
.------------------------------------------------------------
.  CHKB0000  :  Validate Booking Number input
.               Returns: EXIT   0=Valid,  1=Invalid   Requires: BKREBOOK
.------------------------------------------------------------
.
CHKB0000  MOVE      ADMISSNO,KEY8
          CALL      RDBKREC1
          BRANCH    OVRCD,CHKB9100                * not on file
.
. make sure we have the correct Booking Status (=0)
.
          BRANCH    BKRESTAT,CHKB9200,CHKB9300,CHKB9400,CHKB9500
.
          PACK      KEY5,CODEBK,BKRETYPE
          CALL      RDCODE1
          BRANCH    OVRCD,CHKB9050
.
.         we have a valid Booking Record
.
          MOVE      BKREURNO,PURNO                * U/R Number
          MOVE      BKREURNO,AURNO                * U/R Number
          MOVE      BKRECLSS,ACLSS                * Patient Category
          MOVE      BKREATYP,ATYPE                * Admission Type
          MOVE      BKREDEPT,ACLSSFT              * Department
          MOVE      BKREADOC,ADOCTA               * Attending Doctor
          MOVE      ZEROVISN,AADMNO
          LOAD      ADOCTT,CASSOCD,BKRETDOC       * Associated Doctor
          MOVE      SP9,AMBS
          CALL      GXDF0000                      * get extra default data
.
          MOVE      BKRERESI,PTYPE                * Resident Status
          MOVE      BKRERESI,PVIRESI              * Resident Status
          MOVE      BKRECLMT,ACLAIM               * Claim Type/Admin Cat.
          MOVE      BKREGPFA,PTMSFHAN             * GPFH Approval Number
          MOVE      BKREECRA,PTMSECRA             * ECR Approval Number
          MOVE      BKREGPPC,PMVXRH1G             * GP Practice code
          MOVE      BKRERFGP,PMVXRHC1             * Referring GP
.
.         Get Master details
.
CHKB4000  MOVE      URNUMBER,PURNO
          PACK      KEY8,PURNO
          CALL      RDMAST1
          CALL      RDPMPX21
          COMPARE   ZERO,OVRCD                    * record exists
          GOTO      CHKB9000 IF EQUAL
.
. try getting master details from Pre-admission file
.
          MOVE      BKREBOOK,KEY8
          CALL      RDPRAM1
          BRANCH    OVRCD,CHKB9600                * Not on file
          MOVE      ZEROUR,PURNO
.
CHKB9000  MOVE      ZERO,EXIT                     * Valid Booking No. selected
          GOTO      CHKB9999
.
CHKB9050  MOVE      "Invalid Booking Type",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKB9999
.
CHKB9100  MOVE      "Booking Number Does Not Exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKB9999
.
CHKB9200  MOVE      "Booking is Pre-admitted",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKB9999
.
CHKB9300  MOVE      "Booking is Cancelled",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKB9999
.
CHKB9400  MOVE      "Booking is Admitted",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKB9999
.
CHKB9500  MOVE      "Booking is Discharged",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKB9999
.
CHKB9600  MOVE      "Patient Master Details Missing",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKB9999
.
CHKB9999  RETURN
+
.------------------------------------------------------------
. GXDF0000
.------------------------------------------------------------
. Get any extra DeFault information for the booking
. if possible, default the admission type to prov. item classification
. and if a non-theatre booking, default details from bokdiafd if there
.
GXDF0000  COMPARE   ONE,CBOOK
          GOTO      GXDF2000 IF NOT EQUAL   * not using theatre
.
          COMPARE   ONE,OPCNSGCL
          GOTO      GXDF2000 IF NOT EQUAL   * not using default class.
.
          COMPARE   ONE,OPCNCODE
          GOTO      GXDF2000 IF NOT EQUAL   * not using MBS codes
.
.         see if this is a theatre booking
.
          PACK      KEY31,BKREBOOK,SP70
          CALL      RSOPDEA2
          CALL      RKOPDEA2
          BRANCH    OVRCD,GXDF2000          * not a theatre booking
.
          MOVE      OPDAADMN,DIM8VISN
          RJUSTIFY  DIM8VISN
          MATCH     DIM8VISN,BKREBOOK
          GOTO      GXDF2000 IF NOT EQUAL   * not a theatre booking
.
          MATCH     SP9,OPDAPROV
          GOTO      GXDF2000 IF EQUAL       * no provisional item
.
          PACK      KEY17,OPDAPROV,OPDADATE
          CALL      PATITMRD
          BRANCH    OVRCD,GXDF2000          * invalid code
          MOVE      ICLSS,ATYPE             * set up admission type
          PACK      AMBS,OPDAPROV,SP70      * Default MBS code     *T0888079     
.         GOTO      GXDF9999
.
.         this is a normal booking (not theatre),
.         so check if any details on bokdiaaf
.
GXDF2000  PACK      KEY18,BKREBOOK,SP70
          CALL      RSBKDIA1
          CALL      RKBKDIA1
          BRANCH    OVRCD,GXDF9999          * no details on file
.
          MATCH     BKREBOOK,BKDIBOOK
          GOTO      GXDF9999 IF NOT EQUAL
.
.         default admitting diagnosis details if they are on file
.
          MATCH     SP70,BKDIDES1
          GOTO      GXDF2100 IF EQUAL       * no code to default
          MOVE      BKDIDES1,ADIAG1         * default diagnosis desc 1
          REP       "' ",ADIAG1
.
GXDF2100  MATCH     SP70,BKDIDES2
          GOTO      GXDF2200 IF EQUAL       * no code to default
          MOVE      BKDIDES2,ADIAG2         * default diagnosis desc 2
          REP       "' ",ADIAG2
.
GXDF2200  MATCH     SP9,BKDICODE
          GOTO      GXDF9999 IF EQUAL       * no code to default to
.
          COMPARE   ONE,OPCNSGCL
          GOTO      GXDF9999 IF EQUAL       * already defaulted
.
.         get the default admission type
.
.---------MOVE      BKDICODE,AMBS           * Commented out for T0888079
          IF        CKMBS = 1
            PACK      KEY17,BKDICODE,BKREEDAT  * diagnosis is the key
            CALL      PATITMRD
            MOVE      ICLSS,ATYPE           * default admission type
          ENDIF
.
GXDF9999  RETURN
+
.------------------------------------------------------------
. CHAD0000 :  Check for a change in address
. Returns:   PREVADDR  0 = no address change
.                      1 = address has changed
.------------------------------------------------------------
.
CHAD0000  MOVE      ZERO,PREVADDR            * assume no change
.
          MATCH     PADD1,SPADD1             * change in address line 1 ?
          GOTO      CHAD8000 IF NOT EQUAL    * Yes. Post to previous add. file
.
          MATCH     PADD2,SPADD2             * change in address line 2 ?
          GOTO      CHAD8000 IF NOT EQUAL    * Yes. Post to previous add. file
.
          MATCH     PSUBRB,SPSUBRB           * change in suburb ?
          GOTO      CHAD8000 IF NOT EQUAL    * Yes. Post to previous add. file
.
          MATCH     PADD4,SPADD4             * change in address line 4 ?
          GOTO      CHAD8000 IF NOT EQUAL    * Yes Post to previous add. file
.
          MATCH     PPOST,SPPOST             * change in postcode ?
          GOTO      CHAD8000 IF NOT EQUAL    * Yes. Post to previous add. file
.
          MATCH     PTELEP,SPTELEP           * change in private telephone ?
          GOTO      CHAD8000 IF NOT EQUAL    * Yes. Post to previous add. file
.
          MATCH     PTELEB,SPTELEB           * change in business telephone ?
          GOTO      CHAD8000 IF NOT EQUAL    * No
.
          MATCH     PTMXCELL,SPCELL          * change in Cellular telephone ?
          GOTO      CHAD8000 IF NOT EQUAL    * No
.
          MATCH     PMPXPEML,SPPEML          * change in Email Adddress?
          GOTO      CHAD8000 IF NOT EQUAL    * No
.
          MATCH     PTMXOSMS,SPOSMS          * change in Opt out of SMS ?
          GOTO      CHAD8000 IF NOT EQUAL    * No
.
          IF        PTCNDORP=1
            MATCH     PTMXDOFR,SPDOR         * change in DOR ?
            GOTO      CHAD9999 IF EQUAL      * No
          ENDIF
          GOTO      CHAD9999                 * no change
.
CHAD8000  MOVE      ONE,PREVADDR             * change of address
.
CHAD9999  RETURN
+
.-----------------------------------------------------------------
. CHKDOB00 - Check (Pre)Admission date is not before date of birth
. Returns:   EXIT 0 = Ok to continue
.                 1 = Error
.-----------------------------------------------------------------
.
CHKDOB00  MATCH     PBDATE,PTMIS001
          GOTO      CHKDOB90 IF LESS
.
          MOVE      ZERO,EXIT
          GOTO      CHKDOB99
.
CHKDOB90  MOVE      "Admission Date must be after Date of Birth",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
CHKDOB99  RETURN
+
.***********************************************************************
.* RESCLM00 - Get the claim code and validate with resident status     *
.* Returns:  EXIT   0 = Ok to continue                                 *
.*                  1 = Error                                          *
.***********************************************************************
.
RESCLM00  COMPARE   ONE,PTCNHDPS
          GOTO      RESCLM90 IF EQUAL   * NZ
.
          PACK      ACLAIM,ACLAIM,SP70
          MATCH     SP70,ACLAIM
          GOTO      RESCLM99 IF EQUAL
.
          MATCH     "1",PTCNXCOM
          GOTO      RESCLM60 IF EQUAL       * Using Extra Compensable
.
          PACK      KEY5,ANSC,ANSL,ACLAIM,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,RESCLM91
.
          PACK      KEY5,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5,SP70
          SCAN      ANSM,KEY5               * test for Motor Accident Board
          GOTO      RESCLM90 IF EQUAL
          RESET     KEY5                                              *I-265541
          SCAN      ANSW,KEY5               * Test for Workers Comp.
          GOTO      RESCLM90 IF EQUAL
.
          MATCH     "1",TCINDC16
          GOTO      RESCLM90 IF EQUAL        * no checking for Resident status
.
          MATCH     "1",TCINDC1
          GOTO      RESCLM30 IF EQUAL    * check for Resident
.
          MATCH     "11",PTCDNHCP
          GOTO      RESCLM40 IF EQUAL    * check for Reciprocal
.
          GOTO      RESCLM50
.
RESCLM30  PACK      KEY5,ANST,SP1,PTYPE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,RESCLM91
.
          MATCH     "2",TCINDC1
          GOTO      RESCLM94 IF NOT EQUAL    * Resident
.
          GOTO      RESCLM90
.
RESCLM40  PACK      KEY5,ANST,SP1,PTYPE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,RESCLM91
.
          MATCH     "2",TCINDC1
          GOTO      RESCLM96 IF NOT EQUAL    * Resident
.
          GOTO      RESCLM90
.
.         Not Overseas Claim code must have Resident status
.
RESCLM50  PACK      KEY5,ANST,SP1,PTYPE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,RESCLM92
.
          MATCH     "2",TCINDC1
          GOTO      RESCLM93 IF EQUAL        * Non-resident
.
          GOTO      RESCLM90
.
.-----------------------------------------------------------------------------
.         Validation using Extra Compensable indicator
.-----------------------------------------------------------------------------
RESCLM60  PACK      KEY5,ANSC,ANSL,ACLAIM,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,RESCLM91
.
          MATCH     "1",TCINDC16
          GOTO      RESCLM90 IF EQUAL        * no checking for Resident status
.
          MATCH     "G",TCINDC1              * Overseas Visitor?
          GOTO      RESCLM70 IF EQUAL
          MATCH     "E",TCINDC1              * Overseas Student?
          GOTO      RESCLM70 IF EQUAL        * Overseas Student
.
          GOTO      RESCLM80                 * Check for resident
.
.         Overseas Claim code, must be Non Resident
.
RESCLM70  PACK      KEY5,ANST,SP1,PTYPE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,RESCLM92
.
          MATCH     "O",TCINDC3
          GOTO      RESCLM90 IF EQUAL        * Overseas Visit
          MATCH     "S",TCINDC3
          GOTO      RESCLM90 IF EQUAL        * Overseas Student
.
          GOTO      RESCLM95
.
.         Not Overseas Claim code, must be Resident
.
RESCLM80  PACK      KEY5,ANST,SP1,PTYPE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,RESCLM92
.
          MATCH     "O",TCINDC3
          GOTO      RESCLM93 IF EQUAL        * Overseas Visit
          MATCH     "S",TCINDC3
          GOTO      RESCLM93 IF EQUAL        * Overseas Student
.
          GOTO      RESCLM90
.
RESCLM90  MOVE      ZERO,EXIT
          GOTO      RESCLM99
.
RESCLM91  MOVE      "Invalid Claim code",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RESCLM99
.
RESCLM92  MOVE      "Invalid Resident Status",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RESCLM99
.
RESCLM93  MOVE      "ERROR: Claim Code must be OVERSEAS/INELIGIBLE",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RESCLM99
.
RESCLM94  MOVE      "ERROR: Claim code cannot be OVERSEAS/INELIGIBLE",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RESCLM99
.
RESCLM95  MOVE      "ERROR: Claim Type cannot be OVERSEAS/INELIGIBLE. ",WEBTITLE
          ENDSET    WEBTITLE
          APPEND    "Review Resident Status.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RESCLM99
.
RESCLM96  MOVE      "ERROR: Claim code cannot be RECIPROCAL",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RESCLM99
.
RESCLM99  RETURN
+
.***************************************************************************
.* NEWR0000 - Routine for the validations before admitting a preadmission  *
.* Returns:   EXIT  0 = Ok to continue                                     *
.*                  1 = Error
.***************************************************************************
.
NEWR0000  CALL      CTRN0000                     * Check transfer source
          BRANCH    EXIT,NEWR9910
.
          CALL      VDOC0000                     * Validate doctors active dates
          BRANCH    EXIT,NEWR9910
.
          COMPARE   THREE,PTCNHDPS
          GOTO      NEWR9000 IF NOT EQUAL   * Not in Victoria
.
. * do not do VAED validations for boarders as they are not sent
          MATCH     SP3,ATYPE
          IF        !@EQUAL
            PACK      KEY5,ANSA,SP1,ATYPE,SP70
            CALL      RDCODE1
            BRANCH    OVRCD,NEWR9330
.
            MATCH     "X",TCINDC12                 * Ignore patient with X
            GOTO      NEWR9000 IF EQUAL
.
            MATCH     "B",TCINDC3                  * check if a boarder
            GOTO      NEWR9000 IF EQUAL
          ENDIF
.
          MATCH     "20140701",ADATE
          IF        !@LESS
            MOVE      ONE,DOYR2014
          ENDIF
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDVISA1
          IF        OVRCD = 0
            MOVE      SP3,PVIRESI
          ENDIF
.
.          MATCH     ANSU,PSEX
.          GOTO      NEWR9390 IF EQUAL
.
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY   * Admission date
          PACK      AGEDATE,CCENT,CYEAR,CMON,CDAY
          REP       " 0",AGEDATE
          CALL      CALCAGE                 * get the age in days
.
          MATCH     SP3,PVIRESI
          IF        !@EQUAL
            PACK      KEY5,ANST,SP1,PVIRESI,SP70
          ELSE
            PACK      KEY5,ANST,SP1,PTYPE,SP70
          ENDIF
          CALL      RDCODE1
          BRANCH    OVRCD,NEWR9330
.
          MATCH     "1",TCINDC1
          GOTO      NEWR0500 IF NOT EQUAL
.
. ------  GET the claim code and validate with resident status ------
.
NEWR0500  CALL      RESCLM00
          BRANCH    EXIT,NEWR9910
.
          CALL      CHKLAN00
          BRANCH    EXIT,NEWR9910
.
. ------  Check Age @ admission  ------
.
NEWR1000  PACK      KEY5,ANSC,ANSC,ACARE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,NEWR9340
.
          UNPACK    THCSCOD,CARETYPE,DIM2                              *C-49016
.
          CMATCH    "U",CARETYPE                                       *C-49016
          IF        @EQUAL
            IF        PSAGEDAY >= 9
              GOTO      NEWR9030
            ENDIF
          ENDIF
.
          IF        PSAGEDAY < 10
            CMATCH    "4",CARETYPE                                     *C-49016
            IF        !@EQUAL
              CMATCH    ANSU,CARETYPE                                  *C-49016
              GOTO      NEWR9040 IF NOT EQUAL
            ENDIF
          ENDIF
.
          COMPARE   PSAGEYRS,HUND20
          GOTO      NEWR9045 IF LESS
.
. ------  Valdating Admission type and Admission Source ------
.
NEWR4000  PACK      KEY5,ANSP,SP1,ACLSS,SP70    * Replace cc with variable
          CALL      RDCODE1
          MATCH     SP1,THCSCOD
          IF        @EQUAL
            MOVE      "X",ADMITYPE
          ELSE
            MOVE      THCSCOD,ADMITYPE        * ADMITYPE - DIM 1
          ENDIF
.
          MOVE      SP70,TEMPVAR
          IF        DOYR2014=1
            MOVE      "KSYMCOP",TEMPVAR        * July 2014
          ELSE
            MOVE      "SYMLXCOK",TEMPVAR        * pre July 2014
          ENDIF
          REP       " _",TEMPVAR
          SCAN      ADMITYPE,TEMPVAR
          GOTO      NEWR9440 IF NOT EQUAL
.
          PACK      KEY5,ANSS,SP1,ASRCE,SP70    * Replace cc with variable
          CALL      RDCODE1
          UNPACK    THCSCOD,DIM1,DIM1A,DIM2
          MATCH     SP1,DIM1A
          IF        @EQUAL
            MOVE      DIM1,ADMISRC
          ELSE
            MOVE      DIM1A,ADMISRC
          ENDIF
.
          MOVE      SP70,TEMPVAR
          MOVE      "SYTBNAHK",TEMPVAR         *C-60167  ... added K for 2012
          REP       " _",TEMPVAR
          SCAN      ADMISRC,TEMPVAR
          GOTO      NEWR9450 IF NOT EQUAL
.
          PACK      KEY5,ANSV,ANSB,PMVXCADM
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      SP70,TEMPVAR
            MOVE      "YTH",TEMPVAR
            REP       " _",TEMPVAR
.
            MATCH     ANSU,THCSCOD
            IF        @EQUAL
              SCAN      ADMISRC,TEMPVAR
              GOTO      NEWR9360 IF NOT EQUAL
            ENDIF
            MATCH     ANSN,THCSCOD
            IF        @EQUAL
              COMPARE   TEN,PSAGEDAY
              GOTO      NEWR9380 IF NOT LESS
              SCAN      ADMISRC,TEMPVAR
              GOTO      NEWR9360 IF NOT EQUAL
            ENDIF
          ENDIF
.
          MATCH     "M",ADMITYPE
          GOTO      NEWR4002 IF NOT EQUAL
          MATCH     "F",PSEX
          GOTO      NEWR9140 IF NOT EQUAL
          IF        PSAGEYRS >= 11 & PSAGEYRS <= 54
            GOTO      NEWR4002
          ELSE
            GOTO      NEWR9140
          ENDIF
.
NEWR4002  MATCH     "Y",ADMITYPE
          GOTO      NEWR4003 IF NOT EQUAL
          IF        PSAGEDAY > 10
            GOTO      NEWR9160
          ENDIF
          GOTO      NEWR4004
.
NEWR4003  IF        PSAGEDAY < 10
            IF        DOYR2014=0
              MATCH     ANSL,ADMITYPE       * not valid after July 2014
              GOTO      NEWR4004 IF EQUAL
            ENDIF
.
            IF        DOYR2014=0
              MATCH     ANSX,ADMITYPE       * not valid after July 2014
              GOTO      NEWR4004 IF EQUAL
            ENDIF
.
            MATCH     ANSC,ADMITYPE
            GOTO      NEWR4004 IF EQUAL
.
            MATCH     ANSO,ADMITYPE
            GOTO      NEWR4004 IF EQUAL
.
            IF        DOYR2014=1
              MATCH     ANSP,ADMITYPE       * IS valid after July 2014
              GOTO      NEWR4004 IF EQUAL
            ENDIF
.
          ENDIF
.
NEWR4004  CALL      VASAT000                * validate admission source & type
          BRANCH    EXIT,NEWR9910
.
          CALL      VATCA000
          BRANCH    EXIT,NEWR9910         * invalid admission type
          CALL      VASCT000
          BRANCH    EXIT,NEWR9910         * invalid admission source/care type
          CALL      VASCA000
          BRANCH    EXIT,NEWR9910
          CALL      V2012000              * additional 2012 mods
          BRANCH    EXIT,NEWR9910
          CALL      VCAAG000
          BRANCH    EXIT,NEWR9910
          CALL      VCACT000
          BRANCH    EXIT,NEWR9910
          GOTO      NEWR5000
.
NEWR4005  MOVE      SP70,TEMPVAR
          MOVE      "CLTNAZY",TEMPVAR
          REP       " _",TEMPVAR
          SCAN      ADMISRC,TEMPVAR          * Admission Source is C,L,T,N,A,Z,Y
          GOTO      NEWR5000 IF NOT EQUAL
          MATCH     "S",ADMITYPE
          GOTO      NEWR4006  IF EQUAL
          IF        PSAGEDAY < 10
            MOVE      SP70,TEMPVAR
            MOVE      "HTYZ",TEMPVAR                                   *C-60167
            REP       " _",TEMPVAR
            SCAN      ADMISRC,TEMPVAR
            GOTO      NEWR9190 IF NOT EQUAL
          ENDIF
.
          MATCH     "S",ADMITYPE            * Admission type is S
          GOTO      NEWR9200 IF EQUAL

          MATCH     "M",ADMITYPE
          GOTO      NEWR4006 IF NOT EQUAL
          MOVE      SP70,TEMPVAR
          MOVE      "CTNAZ",TEMPVAR
          REP       " _",TEMPVAR
          SCAN      ADMISRC,TEMPVAR
          GOTO      NEWR9200 IF NOT EQUAL
.
NEWR4006  MATCH     "G",ADMITYPE
          GOTO      NEWR4007 IF NOT EQUAL
          MATCH     "Z",ADMISRC
          GOTO      NEWR9200 IF NOT EQUAL
.
NEWR4007  MATCH     "C",ADMITYPE
          GOTO      NEWR4008 IF NOT EQUAL
          MOVE      SP70,TEMPVAR
          MOVE      "YMIRO",TEMPVAR
          REP       " _",TEMPVAR
          SCAN      ADMISRC,TEMPVAR
          GOTO      NEWR9200 IF NOT EQUAL
.
NEWR4008  MATCH     "G",ADMITYPE
          GOTO      NEWR4009 IF NOT EQUAL
          MATCH     "X",ADMISRC
          GOTO      NEWR9200 IF NOT EQUAL
.
NEWR4009  MATCH     "L",ADMITYPE
          GOTO      NEWR4010 IF NOT EQUAL
          MOVE      SP70,TEMPVAR
          MOVE      "MSDXZ",TEMPVAR
          REP       " _",TEMPVAR
          SCAN      ADMISRC,TEMPVAR
          GOTO      NEWR9200 IF NOT EQUAL
.
NEWR4010  MATCH     "Y",ADMISRC
          GOTO      NEWR5000 IF NOT EQUAL
          IF        PSAGEDAY >= 10
            GOTO      NEWR9210
          ENDIF
.
NEWR5000  PACK      KEY5,ANSA,SP1,ATYPE,SP70    * Replace cc with variable
          CALL      RDCODE1
          MATCH     SP1,THCSCOD
          IF        @EQUAL
            MOVE      "X",QUALSTAT
          ELSE
            MOVE      THCSCOD,QUALSTAT
          ENDIF
.
          MOVE      SP70,TEMPVAR
          MOVE      "PCSREBHN",TEMPVAR
          REP       " _",TEMPVAR
          SCAN      QUALSTAT,TEMPVAR
          IF        @EQUAL
            MOVE      "X",QUALSTAT
          ENDIF
.
NEWR5001  MOVE      SP70,TEMPVAR
          MOVE      "NU",TEMPVAR
          REP       " _",TEMPVAR
          SCAN      QUALSTAT,TEMPVAR
          GOTO      NEWR5002 IF NOT EQUAL
          IF        PSAGEDAY > 9
            GOTO      NEWR9220
          ENDIF
.
NEWR5002  MATCH     "X",QUALSTAT
          GOTO      NEWR5003 IF NOT EQUAL
          IF        PSAGEDAY < 10
            MOVE      "N",QUALSTAT
          ENDIF
.
NEWR5003  MATCH     "Y",ADMITYPE
          GOTO      NEWR5004 IF NOT EQUAL
          MOVE      SP70,TEMPVAR
          MOVE      "NU",TEMPVAR
          REP       " _",TEMPVAR
          SCAN      QUALSTAT,TEMPVAR
          GOTO      NEWR9230 IF NOT EQUAL
.
NEWR5004  MOVE      SP70,TEMPVAR
          MOVE      "NU",TEMPVAR
          REP       " _",TEMPVAR
          SCAN      QUALSTAT,TEMPVAR
          GOTO      NEWR6000 IF NOT EQUAL
          MOVE      "TYHS",TEMPVAR
          REP       " _",TEMPVAR
          SCAN      ADMISRC,TEMPVAR
          GOTO      NEWR9240 IF NOT EQUAL
.
NEWR6000  MATCH     PBDATE,ADATE
          GOTO      NEWR9005 IF LESS
.
          PACK      KEY5,ANSC,ANSL,ACLAIM
          CALL      RDCODE1
          IF        OVRCD=0
            UNPACK    THCSCOD,DIM1,DIM2,DIM1
            MATCH     "11",DIM2
            IF        @EQUAL
              MOVE      PPOST,KEY4
              MATCH     "OS ",PADD4           * check if OverSeas
              IF        @EQUAL
                MOVE      "8888",KEY4
              ENDIF
              MATCH     "8888",KEY4
              GOTO      NEWR9350 IF NOT EQUAL
            ENDIF
          ENDIF
          MATCH     ANSZ,TCINDC9
          IF        @EQUAL
            PACK      KEY14,AFUNDH,AFNDTB,SP70
            CALL      RDFUND1
            IF        OVRCD=0
              MATCH     "6",HFHDPE
              GOTO      NEWR9400 IF EQUAL
            ENDIF
          ENDIF
.
          PACK      KEY5,ANSV,ANSB,PMVXCADM
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      THCSCOD,DIM1
            PACK      KEY5,ANSV,ANSI,PMVXIDUS
            CALL      RDCODE1
            IF        OVRCD=0
              MATCH     DIM1,ANSO
              IF        @EQUAL
                COMPARE   PSAGEDAY,NINE
                GOTO      NEWR9380 IF NOT LESS
                MATCH     "1",TCINDC1
                GOTO      NEWR9370 IF NOT EQUAL
              ENDIF
              MATCH     DIM1,ANSB
              IF        @EQUAL
                MATCH     "2",TCINDC1
                GOTO      NEWR9370 IF NOT EQUAL
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     SP70,PCONT
          GOTO      NEWR9410 IF EQUAL
.
          MATCH     SP70,PMPXABRG
          GOTO      NEWR9420 IF EQUAL
.
          MATCH     SP70,PTYPE
          GOTO      NEWR9430 IF EQUAL
.
          CALL      VCAQS000
          BRANCH    EXIT,NEWR9910
.
NEWR9000  MOVE      ZERO,EXIT
          GOTO      NEWR9999
.
NEWR9005  MOVE     "Admission Date cannot be before birth date.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NEWR9999
.
NEWR9030  MOVE      "Unqualified Newborn Care Type but age at ",WEBTITLE
          ENDSET    WEBTITLE
          APPEND    "admission > 9 days.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NEWR9999
.
NEWR9040  MOVE      "Age at admission less than 10 days but care is ",WEBTITLE
          ENDSET    WEBTITLE
          APPEND    "not 4 or U",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NEWR9999
.
NEWR9045  MOVE      "Age at Admission is >= 120 years",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NEWR9999
.
NEWR9060  MOVE      "Admission has invalid Program Funding Source Code",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NEWR9999
.
NEWR9140  MOVE      "Patient with Admission Type must be female ",WEBTITLE
          ENDSET    WEBTITLE
          APPEND    "between 11 and 60 years old.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NEWR9999
.
NEWR9150  MOVE      "Patient with Admission Type must be > 11 years",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NEWR9999
.
NEWR9160  MOVE      "Patient, with admission type is a newborn ",WEBTITLE
          ENDSET    WEBTITLE
          APPEND    "(age at admission > 10 days).",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NEWR9999
.
NEWR9170  MOVE      "Invalid Qualification Status for newborn ",WEBTITLE
          ENDSET    WEBTITLE
          APPEND    "at admission < 10 days.)",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NEWR9999
.
NEWR9190  MOVE      "Invalid admission source for a newborn (age at ",WEBTITLE
          ENDSET    WEBTITLE
          APPEND    "admission < 10 days) for admission",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NEWR9999
.
NEWR9200  MOVE      SP70,TDESC
          PACK      KEY5,ANSP,SP70
          CALL      RDCODE1
          PACK      WEBTITLE,INVALID,TDESC
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NEWR9999
.
NEWR9210  MOVE      "Invalid Admission Source not a newborn (age at ",WEBTITLE
          ENDSET    WEBTITLE
          APPEND    "admission < 10 days) for admission.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NEWR9999
.
NEWR9220  MOVE      "Invalid qualification status, not a newborn ",WEBTITLE
          ENDSET    WEBTITLE
          APPEND    "(age at admission > 9 days).",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NEWR9999
.
NEWR9230  MOVE      "Invalid qualification status for newborn ",WEBTITLE
          ENDSET    WEBTITLE
          APPEND    "admission type Y.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NEWR9999
.
NEWR9240  MOVE      "Invalid Qualification status for admission",WEBTITLE
          ENDSET    WEBTITLE
          APPEND    " source.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NEWR9999
.
NEWR9330  MOVE      "Invalid Resident Status",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NEWR9999
.
NEWR9340  MOVE      "Invalid Care Type",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NEWR9999
.
NEWR9350  MOVE      "Admission has a reciprocal health care agreement ",WEBTITLE
          ENDSET    WEBTITLE
          APPEND    "and not an overseas postcode",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NEWR9999
.
NEWR9360  MOVE      "Invalid Criterion for Admission for ",WEBTITLE
          ENDSET    WEBTITLE
          APPEND    "Admission source",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NEWR9999
.
NEWR9370  MOVE      "Invalid Criterion for Admission for ",WEBTITLE
          ENDSET    WEBTITLE
          APPEND    "Intended stay",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NEWR9999
.
NEWR9380  MOVE      "Invalid Criterion for Admission for Age",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NEWR9999
.
NEWR9390  MOVE      "Unknown sex for Admission",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NEWR9999
.
NEWR9400  MOVE      "An Uninsured patient cannot be admitted as a ",WEBTITLE
          ENDSET    WEBTITLE
          APPEND    "Private patient",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NEWR9999
.
NEWR9410  MOVE      "Country of Birth is Mandatory for Admission",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NEWR9999
.
NEWR9420  MOVE      "Aboriginality is Mandatory for Admission",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NEWR9999
.
NEWR9430  MOVE      "Resident Status is Mandatory for Admission",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NEWR9999
.
NEWR9440  PACK      KEY5,ANSP,SP4
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      "Invalid Category",WEBTITLE
          ELSE
            PACK      WEBTITLE,INVADMTP,TDESC
          ENDIF
.
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NEWR9999
.
NEWR9450  MOVE      "Invalid Admission Source",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NEWR9999
.
NEWR9910  MOVE      ONE,EXIT
          GOTO      NEWR9999
.
NEWR9999  RETURN
+
.**************************************************************************
.* VASAT000  :  Subroutine to validate admission source & type for PRS2   *
.* Returns:    EXIT  0 = Ok to continue                                   *
.*                   1 = Error                                            *
.**************************************************************************
.
VASAT000  MATCH     ANSC,ADMISRC             * before 2003
          GOTO      VASAT020 IF NOT EQUAL
.
VASAT010  MATCH     ANSY,ADMITYPE
          GOTO      VASAT900 IF EQUAL
.
          MATCH     ANSM,ADMITYPE
          GOTO      VASAT900 IF EQUAL
.
          MATCH     ANSR,ADMITYPE
          GOTO      VASAT900 IF EQUAL
.
          MATCH     ANSI,ADMITYPE
          GOTO      VASAT900 IF EQUAL
.
          MATCH     ANSC,ADMITYPE                                      *I-60167
          GOTO      VASAT900 IF EQUAL
.
          MATCH     ANSL,ADMITYPE                                      *I-60167
          GOTO      VASAT900 IF EQUAL
.
          MATCH     ANSX,ADMITYPE                                      *I-60167
          GOTO      VASAT900 IF EQUAL
.
          MATCH     ANSO,ADMITYPE
          GOTO      VASAT910 IF NOT EQUAL
.
VASAT020  MATCH     ANSS,ADMITYPE
          GOTO      VASAT040 IF NOT EQUAL
.
VASAT030  MATCH     ANSS,ADMISRC
          GOTO      VASAT910 IF NOT EQUAL
.
VASAT040  MATCH     ANSY,ADMISRC
          GOTO      VASAT050 IF NOT EQUAL
.
          MATCH     ANSY,ADMITYPE
          GOTO      VASAT900 IF EQUAL
          GOTO      VASAT910
.
VASAT050  MATCH     ANSL,ADMISRC             * before 2003
          GOTO      VASAT060 IF NOT EQUAL
.
          MATCH     ANSW,ADMITYPE
          GOTO      VASAT900 IF EQUAL
.
          MATCH     ANSX,ADMITYPE
          GOTO      VASAT910 IF NOT EQUAL
.
VASAT060  MATCH     ANSS,ADMISRC
          GOTO      VASAT070 IF NOT EQUAL
.
          MATCH     ANSS,ADMITYPE
          GOTO      VASAT910 IF NOT EQUAL
.
VASAT070  MATCH     ANSY,ADMITYPE
          GOTO      VASAT140 IF NOT EQUAL
.
          MATCH     ANSY,ADMISRC
          GOTO      VASAT910 IF NOT EQUAL
          GOTO      VASAT900
.
VASAT140  MOVE      SP70,TEMPVAR
          MOVE      "BTNAH",TEMPVAR
          REP       " _",TEMPVAR
          SCAN      ADMISRC,TEMPVAR
          GOTO      VASAT900 IF NOT EQUAL
.
          MOVE      SP70,TEMPVAR
          IF        DOYR2014=1
            MOVE      "MCOP",TEMPVAR
          ELSE
            MOVE      "MLXCO",TEMPVAR
          ENDIF
          REP       " _",TEMPVAR
          SCAN      ADMITYPE,TEMPVAR
          GOTO      VASAT910 IF NOT EQUAL
.
          MOVE      SP70,TEMPVAR
          IF        DOYR2014=1
            MOVE      "MCOP",TEMPVAR
          ELSE
            MOVE      "MLXCO",TEMPVAR
          ENDIF
.
          REP       " _",TEMPVAR
          SCAN      ADMITYPE,TEMPVAR
          GOTO      VASAT900 IF NOT EQUAL
.
          MOVE      "BTNAH",TEMPVAR
          REP       " _",TEMPVAR
          SCAN      ADMISRC,TEMPVAR
          GOTO      VASAT910 IF NOT EQUAL
.
          MATCH     ANSB,ADMISRC
          GOTO      VASAT900 IF NOT EQUAL
.
          MATCH     ANSM,ADMITYPE
          GOTO      VASAT910 IF EQUAL
.
VASAT900  MOVE      ZERO,EXIT
          GOTO      VASAT999
.
VASAT910  MOVE      SP70,TDESC
          PACK      KEY5,ANSP,SP70
          CALL      RDCODE1
          PACK      WEBTITLE,INVALID,TDESC
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VASAT999
.
VASAT999  RETURN
+
.**************************************************************************
.* VATCA000  :  Subroutine to validate admission type & criteria          *
.* Returns:    EXIT  0 = Ok to continue                                   *
.*                   1 = Error                                            *
.**************************************************************************
.
VATCA000  PACK      KEY5,ANSV,ANSB,PMVXCADM
          CALL      RDCODE1
          BRANCH    OVRCD,VATCA910
.
          MOVE      THCSCOD,ADMICRIT
          MOVE      "BCNUOSERKX",TEMPVAR         *C-49016 ... added R,K for 2012
          REP       " _",TEMPVAR
          SCAN      ADMICRIT,TEMPVAR
          GOTO      VATCA910 IF NOT EQUAL
.
          MATCH     ANSC,ADMITYPE
          GOTO      VATCA050 IF EQUAL
.
          MATCH     ANSO,ADMITYPE
          GOTO      VATCA050 IF EQUAL
.
          MATCH     ANSP,ADMITYPE
          GOTO      VATCA050 IF EQUAL
.
          GOTO      VATCA100 
.
VATCA050  MOVE      "BCNUOSEX",TEMPVAR                                  *C-49016
          REP       " _",TEMPVAR
          SCAN      ADMICRIT,TEMPVAR
          GOTO      VATCA920 IF NOT EQUAL
.
VATCA100  MATCH     ANSS,ADMITYPE
          GOTO      VATCA200 IF NOT EQUAL
          MOVE      "BCOEX",TEMPVAR                                     *C-49016
          REP       " _",TEMPVAR
          SCAN      ADMICRIT,TEMPVAR
          GOTO      VATCA920 IF NOT EQUAL
.
VATCA200  MATCH     ANSY,ADMITYPE
          GOTO      VATCA300 IF NOT EQUAL
          MOVE      "NU",TEMPVAR
          REP       " _",TEMPVAR
          SCAN      ADMICRIT,TEMPVAR
          GOTO      VATCA920 IF NOT EQUAL
.
VATCA300  MATCH     ANSM,ADMITYPE
          GOTO      VATCA400 IF NOT EQUAL
          MOVE      "BCOEX",TEMPVAR                                     *C-49016
          REP       " _",TEMPVAR
          SCAN      ADMICRIT,TEMPVAR
          GOTO      VATCA920 IF NOT EQUAL
.
VATCA400  MATCH     ANSK,ADMITYPE
          GOTO      VATCA450 IF NOT EQUAL
          MOVE      "K",TEMPVAR                                     *C-49016
          REP       " _",TEMPVAR
          SCAN      ADMICRIT,TEMPVAR
          GOTO      VATCA920 IF NOT EQUAL
.
VATCA450  MATCH     ANSB,ADMICRIT
          GOTO      VATCA500 IF EQUAL
.
          MATCH     ANSE,ADMICRIT                                       *I-49016
          GOTO      VATCA500 IF EQUAL
.
          MATCH     ANSC,ADMICRIT
          GOTO      VATCA500 IF EQUAL
.
          MATCH     ANSO,ADMICRIT
          GOTO      VATCA500 IF EQUAL
.
          MATCH     ANSX,ADMICRIT
          GOTO      VATCA600 IF NOT EQUAL
.
VATCA500  MOVE      SP70,TEMPVAR
          IF        DOYR2014=1
            MOVE      "SMCOPX",TEMPVAR      * July 2014
          ELSE
            MOVE      "SMLXCO",TEMPVAR
          ENDIF
          REP       " _",TEMPVAR
          SCAN      ADMITYPE,TEMPVAR
          GOTO      VATCA920 IF NOT EQUAL
.
VATCA600  MATCH     ANSN,ADMICRIT
          IF        !@EQUAL
            MATCH     ANSU,ADMICRIT
            GOTO      VATCA700 IF NOT EQUAL
          ENDIF
.
          MOVE      SP70,TEMPVAR
          IF        DOYR2014=1
            MOVE      "YCOP",TEMPVAR    * July 2014
          ELSE
            MOVE      "YLXCO",TEMPVAR
          ENDIF
          REP       " _",TEMPVAR
          SCAN      ADMITYPE,TEMPVAR
          GOTO      VATCA920 IF NOT EQUAL
.
VATCA700  MATCH     ANSS,ADMICRIT
          GOTO      VATCA800 IF NOT EQUAL
.
          MOVE      SP70,TEMPVAR
          IF        DOYR2014=1
            MOVE      "COP",TEMPVAR
          ELSE
            MOVE      "LXOC",TEMPVAR
          ENDIF
          REP       " _",TEMPVAR
          SCAN      ADMITYPE,TEMPVAR
          GOTO      VATCA920 IF NOT EQUAL
.
VATCA800  MATCH     ANSR,ADMICRIT
          GOTO      VATCA850 IF NOT EQUAL            * 2012 mods
.
          MOVE      SP70,TEMPVAR
          MOVE      "SCLOX",TEMPVAR
          REP       " _",TEMPVAR
          SCAN      ADMITYPE,TEMPVAR
          GOTO      VATCA920 IF NOT EQUAL
.
VATCA850  MATCH     ANSK,ADMICRIT
          GOTO      VATCA900 IF NOT EQUAL
.
          MOVE      SP70,TEMPVAR
          MOVE      "K",TEMPVAR
          REP       " _",TEMPVAR
          SCAN      ADMITYPE,TEMPVAR
          GOTO      VATCA920 IF NOT EQUAL
.
VATCA900  MOVE      ZERO,EXIT
          GOTO      VATCA999
.
VATCA910  MOVE      "Invalid Criterion for Admission",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VATCA999
.
VATCA920  PACK      KEY5,ANSP,SP4
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      "Invalid Category",WEBTITLE
          ELSE
            PACK      WEBTITLE,INVADMTP,TDESC
          ENDIF
.
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VATCA999
.
VATCA999  RETURN
+
.**************************************************************************
.*  VASCT000  :  Subroutine to validate admission source & care type      *
.*  Returns:    0 = Ok to continue                                        *
.*              1 = Error                                                 *
.**************************************************************************
.
VASCT000  MATCH     ANSS,ADMISRC
          GOTO      VASCT050 IF NOT EQUAL
.
          MOVE      SP70,TEMPVAR
          IF        DOYR2014=1
            MOVE      "M1P68594",TEMPVAR
          ELSE
            MOVE      "PFE1267K58934R",TEMPVAR
          ENDIF
          UNPACK    CARETYPE,KEY1,DIM1                                 *I-49016
          SCAN      KEY1,TEMPVAR                                       *C-49016
          GOTO      VASCT910 IF NOT EQUAL
.
VASCT050  MATCH     ANSY,ADMISRC
          GOTO      VASCT100 IF NOT EQUAL
.
          MOVE      SP70,TEMPVAR
          MOVE      "4U",TEMPVAR
          UNPACK    CARETYPE,KEY1,DIM1                                 *I-49016
          SCAN      KEY1,TEMPVAR                                       *C-49016
          GOTO      VASCT910 IF NOT EQUAL
          GOTO      VASCT999
.
VASCT100  MATCH     ANSN,ADMISRC
          IF        !@EQUAL
            MATCH     ANSA,ADMISRC
            IF        !@EQUAL
              MATCH     ANSB,ADMISRC                                   *I-60167
              GOTO      VASCT150 IF NOT EQUAL
            ENDIF
          ENDIF
.
          MOVE      SP70,TEMPVAR
          IF        DOYR2014=1
            MOVE      "M1P685904",TEMPVAR
          ELSE
            MOVE      "PFE1267K85904R",TEMPVAR
          ENDIF
          UNPACK    CARETYPE,KEY1,DIM1                                 *I-49016
          SCAN      KEY1,TEMPVAR                                       *C-49016
          GOTO      VASCT910 IF NOT EQUAL
.
.******************************************** Start of Changes         *C-49016
VASCT150  UNPACK    CARETYPE,KEY1,DIM1
.
          MATCH     "10",CARETYPE
          IF        @EQUAL
            MATCH     ANSK,ADMISRC
            GOTO      VASCT910 IF NOT EQUAL
            GOTO      VASCT999
          ENDIF
.
          MATCH     "5",KEY1
          IF        @EQUAL
            REP       "E-T-K-G-S-A-",DIM1   * CARETYPE "5x" sub-codes
            MATCH     "-",DIM1
            GOTO      VASCT200 IF EQUAL
            GOTO      VASCT910              * error sub-code
          ENDIF
.
          IF        DOYR2014=1
            REP       "M-P-1-6-K-5-9-8-",KEY1
          ELSE
            REP       "P-F-E-1-2-6-7-K-5-9-8-R-",KEY1
          ENDIF
          MATCH     "-",KEY1
          GOTO      VASCT200 IF EQUAL
.
          MATCH     "0",KEY1                                            *I-49016
          GOTO      VASCT250 IF EQUAL
.
          IF        DOYR2014=0
            MATCH     "3",KEY1
            GOTO      VASCT300 IF EQUAL
          ENDIF
.
          MATCH     "U",KEY1
          GOTO      VASCT250 IF EQUAL
.
          GOTO      VASCT999
.
.
.
VASCT200  MOVE      SP70,TEMPVAR
          MOVE      "STBNAH",TEMPVAR                                   *C-60167
          REP       " _",TEMPVAR
          SCAN      ADMISRC,TEMPVAR
          GOTO      VASCT910 IF NOT EQUAL
          GOTO      VASCT999
.
VASCT250  MOVE      SP70,TEMPVAR            * CARETYPE = 0
          MOVE      "TNBAH",TEMPVAR
          REP       " _",TEMPVAR
          SCAN      ADMISRC,TEMPVAR
          GOTO      VASCT910 IF NOT EQUAL
          GOTO      VASCT999
.
VASCT300  MOVE      SP70,TEMPVAR            * CARETYPE = 3
          MOVE      "STH",TEMPVAR
          REP       " _",TEMPVAR
          SCAN      ADMISRC,TEMPVAR
          GOTO      VASCT910 IF NOT EQUAL
          GOTO      VASCT999
.
VASCT350  MOVE      SP70,TEMPVAR            * CARETYPE = U
          MOVE      "YTH",TEMPVAR
          REP       " _",TEMPVAR
          SCAN      ADMISRC,TEMPVAR
          GOTO      VASCT910 IF NOT EQUAL
.********************************************   End of Changes         *C-49016
.
VASCT900  MOVE      ZERO,EXIT
          GOTO      VASCT999
.
VASCT910  MOVE      "Invalid Admission Source for Care Type",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VASCT999
.
VASCT999  RETURN
+
.**************************************************************************
.*  VASCA000  :  Subroutine to validate admission source & criteria       *
.*  Returns:   EXIT  0 = Ok to continue                                   *
.*                   1 = Error                                            *
.**************************************************************************
.
VASCA000  MATCH     ANSS,ADMISRC
          GOTO      VASCA100 IF EQUAL
.
          MATCH     ANSN,ADMISRC
          GOTO      VASCA100 IF EQUAL
.
          MATCH     ANSB,ADMISRC                                       *I-60167
          GOTO      VASCA100 IF EQUAL
.
          MATCH     ANSA,ADMISRC
          GOTO      VASCA150 IF NOT EQUAL
.
VASCA100  MOVE      SP70,TEMPVAR
          MOVE      "BCOEX",TEMPVAR                                     *C-49016
          REP       " _",TEMPVAR
          SCAN      ADMICRIT,TEMPVAR
          GOTO      VASCA910 IF NOT EQUAL
.
VASCA150  MATCH     ANSY,ADMISRC
          GOTO      VASCA175 IF NOT EQUAL
.
          MOVE      SP70,TEMPVAR
          MOVE      "NU",TEMPVAR
          REP       " _",TEMPVAR
          SCAN      ADMICRIT,TEMPVAR
          GOTO      VASCA910 IF NOT EQUAL
.
VASCA175  MATCH     ANST,ADMISRC
          GOTO      VASCA180 IF EQUAL
.
          MATCH     ANSH,ADMISRC
          GOTO      VASCA180 IF EQUAL
.
          GOTO      VASCA200
.
VASCA180  MOVE      SP70,TEMPVAR
          MOVE      "NUOBEXCS",TEMPVAR
          REP       " _",TEMPVAR
          SCAN      ADMICRIT,TEMPVAR
          GOTO      VASCA910 IF NOT EQUAL
.
VASCA200  MATCH     ANSK,ADMISRC
          GOTO      VASCA205 IF EQUAL
.
          GOTO      VASCA210
.
VASCA205  MOVE      SP70,TEMPVAR
          MOVE      "K",TEMPVAR
          REP       " _",TEMPVAR
          SCAN      ADMICRIT,TEMPVAR
          GOTO      VASCA910 IF NOT EQUAL
.
VASCA210  MATCH     ANSB,ADMICRIT
          IF        !@EQUAL
            MATCH     ANSO,ADMICRIT
            GOTO      VASCA225 IF NOT EQUAL
          ENDIF
.
          MOVE      SP70,TEMPVAR
          MOVE      "STBNAH",TEMPVAR                                   *C-60167
          REP       " _",TEMPVAR
          SCAN      ADMISRC,TEMPVAR
          GOTO      VASCA910 IF NOT EQUAL
.
VASCA225  MATCH     ANSN,ADMICRIT                                       *I-49016
          IF        !@EQUAL
            MATCH     ANSU,ADMICRIT
            GOTO      VASCA250 IF NOT EQUAL
          ENDIF
.
          MOVE      SP70,TEMPVAR
          MOVE      "YTH",TEMPVAR
          REP       " _",TEMPVAR
          SCAN      ADMISRC,TEMPVAR
          GOTO      VASCA910 IF NOT EQUAL                           *end I-49016
.
VASCA250  MATCH     ANSC,ADMICRIT
          IF        !@EQUAL
            MATCH     ANSE,ADMICRIT                                     *I-49016
            GOTO      VASCA300 IF NOT EQUAL
          ENDIF
.
          MOVE      SP70,TEMPVAR
          MOVE      "STBNAH",TEMPVAR                                    *C-60167
          REP       " _",TEMPVAR
          SCAN      ADMISRC,TEMPVAR
          GOTO      VASCA910 IF NOT EQUAL
.
VASCA300  MATCH     ANSS,ADMICRIT
          GOTO      VASCA400 IF NOT EQUAL
.
          MOVE      SP70,TEMPVAR
          MOVE      "TH",TEMPVAR
          REP       " _",TEMPVAR
          SCAN      ADMISRC,TEMPVAR
          GOTO      VASCA910 IF NOT EQUAL
.
VASCA400  MATCH     ANSX,ADMICRIT        
          GOTO      VASCA500 IF NOT EQUAL
.
          MOVE      SP70,TEMPVAR
          MOVE      "STBNAH",TEMPVAR    
          REP       " _",TEMPVAR
          SCAN      ADMISRC,TEMPVAR
          GOTO      VASCA910 IF NOT EQUAL
.
VASCA500  MATCH     ANSK,ADMICRIT
          GOTO      VASCA900 IF NOT EQUAL
.
          MOVE      SP70,TEMPVAR
          MOVE      "K",TEMPVAR
          REP       " _",TEMPVAR
          SCAN      ADMISRC,TEMPVAR
          GOTO      VASCA910 IF NOT EQUAL
.
VASCA900  MOVE      ZERO,EXIT
          GOTO      VASCA999
.
VASCA910  MOVE    "Invalid Admission Source for Criteria for Admission",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VASCA999
.
VASCA999  RETURN
+
.**************************************************************************
.*  V2012000  :  Subroutine to validate 2012 mods                         *
.*  Returns:    0 = Ok to continue                                        *
.*              1 = Error                                                 *
.**************************************************************************
V2012000  UNPACK    CARETYPE,KEY1,DIM1
.
          IF        DOYR2014=0
            MATCH     "R",KEY1
            IF        @EQUAL
              REP       "1-2-",DIM1
              MATCH     "-",DIM1              * check for "R1" or "R2"
              GOTO      V2012900 IF EQUAL
              GOTO      V2012920              * error sub-code
            ENDIF
          ENDIF
.
          MATCH     "10",CARETYPE
          IF        @EQUAL
            MATCH     "K",ADMISRC           * if caretype = 10, admit src = K
            GOTO      V2012920 IF NOT EQUAL
            MATCH     "K",ADMICRIT          * if caretype = 10, admit crit = K
            GOTO      V2012930 IF NOT EQUAL
            MATCH     "K",ADMITYPE          * if caretype = 10, admit type = K
            GOTO      V2012940 IF NOT EQUAL
          ENDIF
.
          MATCH     "K",ADMISRC
          IF        @EQUAL
            MATCH     "10",CARETYPE          * if admit src = K, caretype = 10
            GOTO      V2012920 IF NOT EQUAL
          ENDIF
.
          MATCH     "K",ADMICRIT
          IF        @EQUAL
            MATCH     "10",CARETYPE          * if admit crit = K, caretype = 10
            GOTO      V2012930 IF NOT EQUAL
          ENDIF
.
          MATCH     "K",ADMITYPE
          IF        @EQUAL
            MATCH     "10",CARETYPE          * if admit type = K, caretype = 10
            GOTO      V2012940 IF NOT EQUAL
          ENDIF
.
V2012900  MOVE      ZERO,EXIT
          GOTO      V2012999
.
V2012910  MOVE      "Invalid Care Type",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      V2012999
.
V2012920  MOVE      "Invalid Admission Source / Care Type combination",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      V2012999
.
V2012930  MOVE      "Invalid Criteria for Admission / Care Type combination",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      V2012999
.
V2012940  PACK      KEY5,ANSP,SP4
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      "Invalid Category",WEBTITLE
          ELSE
            PACK      WEBTITLE,INVADMTP,TDESC
          ENDIF
.
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      V2012999
.
V2012999  RETURN
+
.***************************************************************************
.*  UPDEHB00  :  Update eAdmission with URNO if required                   *
.***************************************************************************
UPDEHB00  OPEN      PMSEHBA1,"pmsehbaf"
.
          PACK      KEY20,ADMISNID,SP20
          CALL      RDPMEHB1
          BRANCH    OVRCD,UPDEHB90
.
          MOVE      PURNO,PMHBURNO
          MOVE      THREE,PMHBSTAT
.
          CALL      UPPMEHB1
.
UPDEHB90  CLOSE     PMSEHBA1
.
UPDEHB99  RETURN
.
+
.***************************************************************************
.*  UPDEHB00  :  Update eAdmission with URNO if required                   *
.***************************************************************************
UPDERH00  OPEN      COMERHA1,"comerhaf"
.
          PACK      KEY20,EREFRLID,SP20
          CALL      RDCMERH1
          BRANCH    OVRCD,UPDERH90
.
          MOVE      PURNO,CMRHURNO
          MOVE      " 3",CMRHSTAT
.
          CALL      UPCMERH1
.
UPDERH90  CLOSE     PMSEHBA1
.
UPDERH99  RETURN
+
.***************************************************************************
.*  UPABK000  :  Update preadmissions admissions and bookings if           *
.*               interpreter required                                      *
.***************************************************************************
UPABK000  MATCH     SVPXINTR,PMPXINTR       * Interpreter reqd change? *I-40489
          GOTO      UPABK005 IF NOT EQUAL                              *I-40489
.
          MATCH     SVPXLNG1,PMPXLNG1       * Language change?         *I-40489
          GOTO      UPABK005 IF NOT EQUAL                              *I-40489
.
          GOTO      UPABK900                * no language changes      *I-40489
.
UPABK005  CLOSE     OUTSITA1                * Close indexes not used and open
          OPEN      OUTSITA3,"outsitaf"     * open indexes used by this label
          OPEN      OUTARTA1,"outartaf"
          CLOSE     ALLREFA1
          OPEN      ALLREFA2,"allrefaf"
.
          PACK      KEY16,URNUMBER,SP70                 * change label *C-40489
          CALL      RSBKREC6
UPABK010  CALL      RKBKREC6
          BRANCH    OVRCD,UPABK100
.
          MATCH     URNUMBER,BKREURNO
          GOTO      UPABK100 IF NOT EQUAL
.
          COMPARE   ZERO,BKRESTAT
          GOTO      UPABK010 IF NOT EQUAL
.
          MATCH     "1",PMPXINTR
          IF        @EQUAL
            CALL      CLVISINT
            MOVE      BKREBOOK,VSINVISN
            MOVE      BKREEDAT,VSINDATE
            MOVE      BKREATIM,VSINTIME
            MOVE      "3",VSINTYPE
            MOVE      SP70,VSINSUBK
            MOVE      USERID,VSINWUID
            MOVE      ZERO,VSINNOTF
            PACK      KEY8,BKREBOOK,SP70
            CALL      WRBKIN00
          ELSE
            PACK      KEY8,BKREBOOK,SP70
            CALL      RDVSINT1
            IF        OVRCD=0
              CALL      DEVSINT1
              MOVE      "D",INTAUDTY
              CALL      INTAUD00
            ENDIF
          ENDIF
          GOTO      UPABK010
.
UPABK100  PACK      KEY24,URNUMBER,SP70
          CALL      RSPTVIS2
UPABK110  CALL      RKPTVIS2
          BRANCH    OVRCD,UPABK200
.
          MATCH     URNUMBER,PVIURNO
          GOTO      UPABK200 IF NOT EQUAL
.
          COMPARE   THREE,PVITYPE
          GOTO      UPABK110 IF NOT EQUAL
.
          PACK      KEY8,PVIBILL,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,UPABK110
.
          BRANCH    ASTAT,UPABK150,UPABK150
          GOTO      UPABK110
.
UPABK150  MATCH     "1",PMPXINTR
          IF        @EQUAL
            CALL      CLVISINT
            MOVE      DAADMNO,VSINVISN
            MOVE      ADATE,VSINDATE
            MOVE      ATIME,VSINTIME
            MOVE      "3",VSINTYPE
            MOVE      SP70,VSINSUBK
            MOVE      USERID,VSINWUID
            MOVE      ZERO,VSINNOTF
            PACK      KEY8,AADMNO,SP70
            CALL      WRINT000
          ELSE
            PACK      KEY8,AADMNO,SP70
            CALL      RDVSINT1
            IF        OVRCD=0
              CALL      DEVSINT1
              MOVE      "D",INTAUDTY
              CALL      INTAUD00
            ENDIF
          ENDIF
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPMVX11
          IF        OVRCD=0
            MATCH     "1",PMPXINTR
            IF        @EQUAL
              MOVE      "1",PMVXINTR
              MOVE      PMPXLNG1,PMVXLNG1
            ELSE
              MOVE      "0",PMVXINTR
              MOVE      PMPXLNG1,PMVXLNG1
            ENDIF
            CALL      UPPMVX11
          ENDIF
.
          GOTO      UPABK110
.
UPABK200  PACK      KEY16,URNUMBER,SP70
          CALL      RSALREF2
UPABK210  CALL      RKALREF2
          BRANCH    OVRCD,UPABK300
.
          MATCH     ALREURNO,URNUMBER
          GOTO      UPABK300 IF NOT EQUAL
.
          MATCH     "0",ALRESTAT
          IF        !@EQUAL
            MATCH     "1",ALRESTAT
            GOTO      UPABK210 IF NOT EQUAL      * Waiting and active referrals
          ENDIF
.
          PACK      KEY8,ALREVISN,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,UPABK210
.
          MATCH     "1",PMPXINTR
          IF        @EQUAL
            MOVE      "1",PMVXINTR
            MOVE      PMPXLNG1,PMVXLNG1
          ELSE
            MOVE      "0",PMVXINTR
            MOVE      PMPXLNG1,PMVXLNG1
          ENDIF
.
          CALL      UPPMVX11
          GOTO      UPABK210
.
UPABK300  PACK      KEY32,URNUMBER,SP70
          CALL      RSOTART1
UPABK310  CALL      RKOTART1
          BRANCH    OVRCD,UPABK400
.
          MATCH     OTARURNO,URNUMBER
          GOTO      UPABK400 IF NOT EQUAL
.
          MATCH     "0",OTARSTAT                 * Requested only
          GOTO      UPABK310 IF NOT EQUAL
.
          MATCH     "1",PMPXINTR
          IF        @EQUAL
            MOVE      "1",OTARINTR
            MOVE      PMPXLNG1,OTARLNG1
          ELSE
            MOVE      "0",OTARINTR
            MOVE      SP70,OTARLNG1
          ENDIF
.
          CALL      UPOTART1
          GOTO      UPABK310
.
UPABK400  PACK      CURDTE8,CCC,CYY,CMM,CDD      * Check bookings from today
          REP       " 0",CURDTE8
.
          MOVE      SP70,SAVESITE
.
          PACK      KEY9,SP70
          CALL      RDSSITA3                 * Loop all site file prefixes
UPABK500  CALL      RDKSITA3
          BRANCH    OVRCD,UPABK800
.
          MATCH     SP70,SAVESITE
          GOTO      UPABK600 IF EQUAL
.
          MATCH     SAVESITE,OSTFILE
          GOTO      UPABK500 IF EQUAL

UPABK600  MOVE      OSTFILE,SAVESITE         * Save current site file prefix
.
          MATCH     OSTFILE,CFILEPRE
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open prefixed Outpatient Files
          ENDIF

          PACK      KEY36,URNUMBER,CURDTE8,SP70
          CALL      RDSBOKA3
UPABK700  CALL      RDKBOKA3
          BRANCH    OVRCD,UPABK500
.
          MATCH     OBAURNO,URNUMBER
          GOTO      UPABK500 IF NOT EQUAL
.
          COMPARE   ONE,OBASTAT
          GOTO      UPABK700 IF NOT EQUAL
.
          MATCH     "1",PMPXINTR
          IF        @EQUAL
            PACK      CASEKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,DOBASLOT,SP70
            CALL      INTUPD00
          ELSE
            PACK      KEY8,OBAOUTNO,SP70
            CALL      RDVSINT1
            IF        OVRCD=0
              CALL      DEVSINT1
              MOVE      "D",INTAUDTY
              CALL      INTAUD00
            ENDIF
          ENDIF
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDPMVX11
          IF        OVRCD=0
            MATCH     "1",PMPXINTR
            IF        @EQUAL
              MOVE      "1",PMVXINTR
              MOVE      PMPXLNG1,PMVXLNG1
            ELSE
              MOVE      "0",PMVXINTR
              MOVE      PMPXLNG1,PMVXLNG1
            ENDIF
            CALL      UPPMVX11
          ENDIF
.
          GOTO      UPABK700
.
UPABK800  MATCH     SP70,ADMISSNO
          IF        !@EQUAL
            PACK      KEY8,ADMISSNO,SP70     * Read Visit Extension File?
            CALL      RDPMVX11
            IF        OVRCD=1
              CALL      CLPMSVX1
            ENDIF
          ENDIF
.
          CLOSE     OUTSITA3            * Close files only used by this label
          OPEN      OUTSITA1,"outsitaf" * and re open original indexes
          CLOSE     OUTARTA1
          CLOSE     ALLREFA2
          OPEN      ALLREFA1,"allrefaf"
.
          CALL      OUTFIL00           * Restore correct OP files that are open
          BRANCH    EXIT,UPABK999
.
UPABK900  MOVE      ZERO,EXIT
          GOTO      UPABK999
.
UPABK999  RETURN
+
.*******************************************************************************
. INTUPD00 - Update Interpreter Table
. Input  - OBAURNO
.        - OBAOUTNO
.        - CASEKEYS - for New Booking
.*******************************************************************************
.
INTUPD00  MATCH     "1",PMPXINTR
          GOTO      INTUPD99 IF NOT EQUAL
.
          CALL      CLVISINT
          MOVE      ZERO,DATACHNG                                      *I-40489
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDVSINT1
.******************************************** Start of Change          *C-40489
....      IF        OVRCD=0
....        MOVE      "B",INTAUDTY
....        CALL      INTAUD00
....      ENDIF
          BRANCH    OVRCD,INTUPD50          * new record - DATACHNG=0
.
          MOVE      ONE,DATACHNG
.
INTUPD50  IF        DATACHNG = 1
            MOVE      "B",INTAUDTY          * "before change"
            CALL      INTAUD00
          ENDIF
.
.********************************************   End of Change          *C-40489
.
          MOVE      OBAOUTNO,VSINVISN
          MOVE      OBADATE,VSINDATE
          PACK      VSINTIME,OBATIME,KSECONDS
          MOVE      "2",VSINTYPE
          MOVE      CASEKEYS,VSINSUBK
          MOVE      USERID,VSINWUID
          MOVE      ZERO,VSINNOTF                                      *I-40489
          MOVE      ZERO,VSINCONF
.
....      PACK      KEY8,OBAOUTNO,SP70                                  D-40489
....      CALL      RAVSINT1                                            D-40489
....      IF        OVRCD=0                                             D-40489
.                                           * test data change flag    *I-40489
          IF        DATACHNG = 1
            CALL      UPVSINT1
            MOVE      "C",INTAUDTY
            CALL      INTAUD00
          ELSE
            MOVE      ZERO,VSINNOTF
            MOVE      SP70,VSINUDC1
            MOVE      SP70,VSINUDC2
            MOVE      SP70,VSINUDC3
            MOVE      SP70,VSINUDC4
            MOVE      SP70,VSININTP
            MOVE      SP70,VSINCHON
            MOVE      ZERO,VSINCONF
            MOVE      SP70,VSINSPAR
            CALL      WRVSINT1
            MOVE      "A",INTAUDTY
            CALL      INTAUD00
          ENDIF
          MOVE      ZERO,EXIT
.
INTUPD99  RETURN
+
.**************************************************************************
.*  WRBKIN00  :  Write booking interpreter record                         *
.**************************************************************************
.
WRBKIN00  CALL      RAVSINT1
          IF        OVRCD=1
            CALL      WRVSINT1
            MOVE      "A",INTAUDTY
            CALL      INTAUD00
          ELSE
            CALL      UPVSINT1
            MOVE      "C",INTAUDTY
            CALL      INTAUD00
          ENDIF
.
WRBKIN99  RETURN
+
.*******************************************************************************
. CRMED000 - Create a medical record
.*******************************************************************************
.
CRMED000  BRANCH    TEMPORAR,CRMED999,CRMED999 * dont create medical record for
.                                            temporary UR
          COMPARE   ONE,CRMEDREC         * Create MR checkbox - Yes
          GOTO      CRMED100 IF EQUAL
.
          COMPARE   ONE,MRCNACRR
          GOTO      CRMED999 IF NOT EQUAL
.
CRMED100  MOVE      SP70,MRMAURNO
          MOVE      SP70,MRMAHHOS                                     *I-240724
          MOVE      SP70,MRMAHLOC
          MOVE      SP70,MRMADOTY
          MOVE      ZERO,MRMAVOLN
          MOVE      SP70,MRMASTAT
          MOVE      SP70,MRMACOMM
          MOVE      SP70,MRMAKEY
          MOVE      SP70,MRMAFILM
.
          OPEN      MRTMASA1,"mrtmasaf"
          OPEN      MRTMASA2,"mrtmasaf"
          MOVE      PURNO,MRMAURNO
.
          READ      CONTROLF,NINTY7;*154,MRCNUSRD
.
          IF        IBCNMHOS=1
            PACK      KEY3,WBSEHOSP,SP70
            CALL      RDPTHSP1
            BRANCH    OVRCD,CRMED999
.
            MOVE      PTHSHHOS,MRMAHHOS            * Home Hospital    *I-240724
            MOVE      PTHSHLOC,MRMAHLOC            * Home Location
            MOVE      PTHSHHOS,MRMACHOS            * Current Hospital *I-240724
            MOVE      PTHSHLOC,MRMACLOC            * Current Location
            MOVE      PTHSRCTY,MRMADOTY            * Document Type
            MOVE      PTHSSTAT,MRMASTAT            * Status
            MOVE      PTHSHHOS,MRMAOHOS            * Originating Hospital
            SQUEEZE   PTHSVOLM
            MOVE      PTHSVOLM,MRMAVOLN
          ELSE
            READ      CONTROLF,SIXTY;*84,MRCNHLOC
            READ      CONTROLF,SIXTY;*88,MRCNRCTY
            READ      CONTROLF,SIXTY;*91,MRCNVOLM
            READ      CONTROLF,SIXTY;*108,MRCNSTAT
            UNPACK    SP70,MRMAHHOS,MRMACHOS,MRMAOHOS                 *I-240724
            MOVE      MRCNHLOC,MRMAHLOC
            MOVE      MRCNHLOC,MRMACLOC
            MOVE      MRCNRCTY,MRMADOTY
            MOVE      MRCNSTAT,MRMASTAT
            SQUEEZE   MRCNVOLM
            MOVE      MRCNVOLM,MRMAVOLN
          ENDIF
.
          COMPARE   ONE,MRCNUSRD                 * Using websecaf auto create
          GOTO      CRMED200 IF NOT EQUAL        * MR defaults
.
          MATCH     SP70,WBSEDTYP
          IF        !@EQUAL
            MOVE      WBSEDTYP,MRMADOTY
          ENDIF
.
          IF        IBCNMHOS=1
            MATCH     SP70,WBSEHHOS
            GOTO      CRMED200 IF EQUAL
          ENDIF
.
          MATCH     SP70,WBSEHLOC
          IF        !@EQUAL
            MOVE      WBSEHHOS,MRMAHHOS                             *I-240724
            MOVE      WBSEHLOC,MRMAHLOC
            MOVE      WBSEHHOS,MRMACHOS                             *I-240724
            MOVE      WBSEHLOC,MRMACLOC
            MOVE      WBSEHHOS,MRMAOHOS                             *I-240724
          ENDIF
.
CRMED200  MATCH     SP70,MRMAS001
          IF        !@EQUAL
            MATCH     Z70,MRMAS001
            IF        !@EQUAL
              MOVE      MRMAS001,MRMADOTY
            ENDIF
          ENDIF
.
          MATCH     SP70,MRMAS002
          IF        !@EQUAL
            MATCH     Z70,MRMAS002
            IF        !@EQUAL
              MOVE      MRMAS002,MRMAHLOC
              MOVE      MRMAS002,MRMACLOC
            ENDIF
          ENDIF
.
          MATCH     SP70,MRMAS003                                     *I-240724
          IF        !@EQUAL
            MATCH     Z70,MRMAS003
            IF        !@EQUAL
              MOVE      MRMAS003,MRMAHHOS
              MOVE      MRMAS003,MRMACHOS
              MOVE      MRMAS003,MRMAOHOS
            ENDIF
          ENDIF
.
          MATCH     SP70,MRMAHLOC
          GOTO      CRMED999 IF EQUAL
.
          MATCH     SP70,MRMADOTY
          GOTO      CRMED999 IF EQUAL
.                                                                     *C-240724
          PACK      KEY20,MRMAURNO,MRMAHHOS,MRMAHLOC,MRMADOTY,MRMAVOLN,SP70
          CALL      RAMRMAS1
          COMPARE   ONE,OVRCD
          GOTO      CRMED400 IF NOT EQUAL
.
CRMED300  READ      CONTROLF,SIXTY;*95,MRCNUKEY
          ADD       ONE,MRCNUKEY
          WRITAB    CONTROLF,SIXTY;*95,MRCNUKEY
          SUB       ONE,MRCNUKEY
          MOVE      MRCNUKEY,MRMAKEY
          CALL      IBACLOCK
          PACK      MRMADTCR,CCC,CYY,CMM,CDD
          REP       " 0",MRMADTCR
          MOVE      CTIMEIS,MRMATMCR
          MOVE      WBSEUID,MRMACUID
          MOVE      SP70,MRMADTUP
          MOVE      SP70,MRMATMUP
          MOVE      SP70,MRMAUUID
.
          PACK      KEY10,MRMAKEY,SP70
          CALL      RAMRMAS2                * Read a master file record
          COMPARE   ONE,OVRCD
          GOTO      CRMED300 IF NOT EQUAL   * Record exists, get next unq key
.
          CALL      IBACLOCK
          PACK      MRMADTCR,CCC,CYY,CMM,CDD
          REP       " 0",MRMADTCR
          MOVE      CTIMEIS,MRMATMCR
          MOVE      WBSEUID,MRMACUID
          MOVE      SP70,MRMADTUP
          MOVE      SP70,MRMATMUP
          MOVE      SP70,MRMAUUID
          CALL      WRTMAS1
.                                                                     *C-240724
CRMED400  PACK      SAVKEY18,MRMAURNO,MRMAHHOS,MRMAHLOC,MRMADOTY,SP70
          PACK      KEY20,MRMAURNO,MRMAHHOS,MRMAHLOC,MRMADOTY,Z70     *C-240724
          CALL      RSMRMAS1
          CALL      RPMRMAS1                * Find the highest volume
          BRANCH    OVRCD,CRMED999
.
          PACK      KEY18,MRMAURNO,MRMAHHOS,MRMAHLOC,MRMADOTY,SP70    *C-240724
          MATCH     SAVKEY18,KEY18                                    *C-240724
          GOTO      CRMED999 IF NOT EQUAL
.
          MATCH     "1",MRCNRRED
          IF        @EQUAL
            CALL      MRWRT000                * Request the highest volume
          ENDIF
.
CRMED999  RETURN
+
.------------------------------------------------------------
. Loop through UR numbers and save Requests
.------------------------------------------------------------
MRWRT000  OPEN      MRTRQDR1,"mrtrqdaf"
          OPEN      MRTRQHR1,"mrtrqhaf"
          OPEN      MRTRQHR2,"mrtrqhaf"
          OPEN      MRTRQDR2,"mrtrqdaf"
.
          MOVE      ADMISSNO,KEY8
          CALL      RDEMVIS1
          IF         OVRCD = 1
            CALL      CLEMRVIS
          ENDIF
.
          PACK      KEY3,EMVISITE,SP70
          CALL      RDEMSIT1
          IF        OVRCD<>1
            PACK      PMVXMHOS,EMSTHSNO,SP70
          ENDIF
.
          MATCH     SP70,EMVITRIG
          GOTO      MRWRT999 IF EQUAL
          GOTO      MRWRT999 IF EOS
.
          MATCH     EMSTHSNO,MRMACHOS       * is this needed ?   MLMLMLML
.
          MATCH     EMSTDRLC,MRMACLOC
          GOTO      MRWRT999 IF EQUAL
.
          PACK      KEY20,MRMAKEY,SP70
          CALL      RSMRRQD2
MRWRT010  CALL      RKMRRQD2
          BRANCH    OVRCD,MRWRT030
.
          MATCH     MRMAKEY,MRRDRKEY
          GOTO      MRWRT030 IF NOT EQUAL
.

          PACK      DIM5,EMVITIME,SP70
.
          PACK      KEY23,EMVIDATE,DIM5,MRRDRQNO,SP70
          CALL      RDMRRQH2
          BRANCH    OVRCD,MRWRT010
.
          MOVE      EMVITRIG,MRRQTRIG
.         CLOCK     TIME,MRRQTMUP
.         PACK      MRRQDTUP,CCC,CYY,CMM,CDD
.         REP       " 0",MRRQDTUP
          MOVE      WBSEUID,MRRQUSUP
.
          CALL      UPMRRQH2
.
          GOTO      MRWRT999
.
MRWRT030  READ      CONTROLF,FIFTY9;*182,PTCNORNO
          ADD       ONE,PTCNORNO
          WRITAB    CONTROLF,FIFTY9;*182,PTCNORNO
.
          MOVE      PTCNORNO,KEY10
          CALL      RDMRRQH1
          COMPARE   ZERO,OVRCD
          GOTO      MRWRT000 IF EQUAL
.
          MOVE      PTCNORNO,MRRQRQNO
.         CALL      IBACLOCK
.         PACK      MRRQDTRQ,CCC,CYY,CMM,CDD
.         REP       " 0",MRRQDTRQ
.         MOVE      CTIMEIS,MRRQTMRQ
          MOVE      EMVIDATE,MRRQDTRQ
          MOVE      EMVITIME,MRRQTMRQ
          MOVE      EMSTDRLC,MRRQLOCR
          MOVE      WBSENAM,MRRQPERS
          MOVE      EMSTDRES,MRRQMOVR
          MOVE      SP70,MRRQURGY
          MOVE      SP70,MRRQEXTN
          MOVE      SP70,MRRQCOMM
          MOVE      EMSTHSNO,MRRQHOSC
          MOVE      SP70,MRRQPAGE
          MOVE      EMVITRIG,MRRQTRIG
.
          CLOCK     TIME,MRRQTIYM
          PACK      MRRQDAYE,CCC,CYY,CMM,CDD
          REP       " 0",MRRQDAYE
          MOVE      WBSEUID,MRRQUSID
.
          MOVE      MRRQRQNO,KEY10
          CALL      WRMRRQH1      * write to the medical record request Header
.
          MOVE      "N",MRRDFILL
          MOVE      SP70,MRRDSPAR

          PACK      KEY20,MRRQRQNO,MRMAKEY,SP70
          UNPACK    KEY20,MRRDRQNO,MRRDRKEY
          CALL      RAMRRQD1
          IF        OVRCD=0
            CALL      UPMRRQD1
          ELSE
            CALL      WRMRRQD1     * write to the medical record request Details
          ENDIF
.
MRWRT999  CLOSE     MRTRQHR2
          CLOSE     MRTRQDR1
          CLOSE     MRTRQDR2
          RETURN
+
.------------------------------------------------------------
. CLRAS000 - Clear contract arrangement
.------------------------------------------------------------
.
CLRAS000  MOVE      ZEROVISN,PTAFADMN
          UNPACK    SP70,PTAFTYPE,PTAFDATE,PTAFTIME,PTAFCODE,PTAFCTYP
          UNPACK    SP70,PTAFCROL,PTAFCSID,PTAFSPAR
.
CLRAS999  RETURN
+
.------------------------------------------------------------
. CLRVXS00 - Clear Visit Extension
.------------------------------------------------------------
.
CLRVXS00  MOVE      SP70,PMVXDOCA
          MOVE      SP70,PMVXDOCT
          MOVE      SP70,PMVXCSNR
          MOVE      SP70,PMVXPOST
          MOVE      SP70,PMVXPIND
          MOVE      SP70,PMVXVLOC
          MOVE      SP70,PMVXCFSG
          MOVE      SP70,PMVXINGP
          MOVE      SP70,PMVXCPTH
          MOVE      SP70,PMVXHCP1
          MOVE      SP70,PMVXHCP2
          MOVE      SP70,PMVXHCP3
          MOVE      SP70,PMVXHCP4
          MOVE      SP70,PMVXRHC1
          MOVE      SP70,PMVXRH1G
          MOVE      SP70,PMVXRH1C
          MOVE      SP70,PMVXRHC2
          MOVE      SP70,PMVXRH2G
          MOVE      SP70,PMVXRH2C
          MOVE      SP70,PMVXRHC3
          MOVE      SP70,PMVXRH3G
          MOVE      SP70,PMVXRH3C
          MOVE      SP70,PMVXRHC4
          MOVE      SP70,PMVXRH4G
          MOVE      SP70,PMVXRH4C
          MOVE      SP70,PMVXABRG
          MOVE      SP70,PMVXCADM
          MOVE      SP70,PMVXIRAD
          MOVE      SP70,PMVXIDUS
          MOVE      SP70,PMVXCRAV
          MOVE      SP70,PMVXRCCT
          MOVE      SP70,PMVXAPWD
          MOVE      SP70,PMVXAPBD
          MOVE      SP70,PMVXPOWD
          MOVE      SP70,PMVXPOBD
          MOVE      SP70,PMVXPSTY
          MOVE      SP70,PMVXVALW
          MOVE      SP70,PMVXPALW
          MOVE      SP70,PMVXINDC
          MOVE      SP70,PMVXMDAV
          MOVE      SP70,PMVXFRMS
          MOVE      SP70,PMVXCSNG
          MOVE      SP70,PMVXPWGT
          MOVE      SP70,PMVXPHGT
          MOVE      SP70,PMVXDHWR
          MOVE      SP70,PMVXEDC1
          MOVE      SP70,PMVXEDC2
          MOVE      SP70,PMVXEDC3
          MOVE      SP70,PMVXHOME
          MOVE      SP70,PMVXUDF1
          MOVE      SP70,PMVXUDF2
          MOVE      SP70,PMVXUDF3
          MOVE      SP70,PMVXUDF4
          MOVE      SP70,PMVXUDT1
          MOVE      SP70,PMVXUDT2
          MOVE      SP70,PMVXUDT3
          MOVE      SP70,PMVXUDT4
          MOVE      SP70,PMVXUDT5
          MOVE      SP70,PMVXUDT6
          MOVE      SP70,PMVXCDTE
          MOVE      SP70,PMVXCTIM
          MOVE      SP70,PMVXWEBC
          MOVE      SP70,PMVXLUPD
          MOVE      SP70,PMVXLUPT
          MOVE      SP70,PMVXWEBU
          MOVE      SP70,PMVXMHLS
          MOVE      SP70,PMVXPICD
          MOVE      SP70,PMVXRMOR
          MOVE      SP70,PMVXASUT
          MOVE      SP70,PMVXELPS
          MOVE      SP70,PMVXEMPL
          MOVE      SP70,PMVXFINP
          MOVE      SP70,PMVXOCCP
          MOVE      SP70,PMVXPALC
          MOVE      SP70,PMVXPPAL
          MOVE      SP70,PMVXPPPT
          MOVE      SP70,PMVXPSOS
          MOVE      SP70,PMVXPYSP
          MOVE      SP70,PMVXQLDB
          MOVE      SP70,PMVXREAD
          MOVE      SP70,PMVXUDIN
          MOVE      SP70,PMVXUREA
          MOVE      SP70,PMVXUSAC
          MOVE      SP70,PMVXUVTH
          MOVE      ZERO,PMVXINTR
          MOVE      SP70,PMVXLNG1
          MOVE      SP70,PMVXASGC
          MOVE      SP70,PMVXMHOS
          MOVE      SP70,PMVXDSPD
          MOVE      SP70,PMVXDSIF
          MOVE      SP70,PMVXPRMI
          MOVE      SP70,PMVXPRAI
          MOVE      SP70,PMVXPRES
          MOVE      SP70,PMVXUITR
          MOVE      SP70,PMVXRPOA
          MOVE      SP70,PMVXRCN1
          MOVE      SP70,PMVXRCN2
          MOVE      SP70,PMVXRHFU
          MOVE      SP70,PMVXRDVA
          MOVE      SP70,PMVXRSLO
          MOVE      SP70,PMVXMLOC
          MOVE      SP70,PMVXPACC
          MOVE      SP70,PMVXEDU1
          MOVE      SP70,PMVXEDU2
          MOVE      SP70,PMVXEDU3
          MOVE      SP70,PMVXPRGM
          MOVE      SP70,PMVXEOCL
          MOVE      SP70,PMVXSLOC
          MOVE      SP70,PMVXSCLI
          MOVE      SP70,PMVXSTRA
          MOVE      SP70,PMVXQASN
          MOVE      SP70,PMVXATCP
          MOVE      SP70,PMVXPOEC
          MOVE      SP70,PMVXPGID
          MOVE      SP70,PMVXPILC
          MOVE      SP70,PMVXATIM                                      *I-199979
          MOVE      SP70,PMVXITIM                                      *I-199979
          MOVE      SP70,PMVXATCP
          MOVE      SP70,PMVXHFGN
          MOVE      SP70,PMVXHFSN
          MOVE      SP70,PMVXFUPI
          MOVE      SP70,PMVXTICM
          MOVE      SP70,PMVXUDF5
          MOVE      SP70,PMVXUDF6
          MOVE      SP70,PMVXUDF7
          MOVE      SP70,PMVXUDF8
          MOVE      SP70,PMVXUDF9
          MOVE      SP70,PMVXUD10
          MOVE      SP70,PMVXUD11
          MOVE      SP70,PMVXUD12
          MOVE      SP70,PMVXUD13
          MOVE      SP70,PMVXUD14
          MOVE      SP70,PMVXUD15
          MOVE      SP70,PMVXTEAM
          MOVE      SP70,PMVXNWHC
          MOVE      SP70,PMVXEDDT
          MOVE      SP70,PMVXPHLD
          MOVE      SP70,PMVXPLOC
          MOVE      SP70,PMVXDTRT
          MOVE      SP70,PMVXDFLG
          MOVE      SP70,PMVXFSRC
          MOVE      SP70,PMVXCONM
          MOVE      SP70,PMVXCPDD
          MOVE      SP70,PMVXPBMI
          MOVE      SP70,PMVXCNID
          MOVE      SP70,PMVXCNDT
          MOVE      SP70,PMVXCASE
          MOVE      SP70,PMVXEAFL
          MOVE      SP70,PMVXCONF      * Appointment Confirmed (used by SMS)
          MOVE      SP70,PMVXADMP
          MOVE      SP70,PMVXCONO
          MOVE      SP70,PMVXMEDH
.
          MOVE      SP70,PMVXSPAR
.
CLRVXS99  RETURN
+
.-----------------------------------------------------------------------------
. CANDET00 - Check for Booking/Waiting List/Theatre records - output indicator
.-----------------------------------------------------------------------------
.
CANDET00  UNPACK    DIM127,KEY1,FLDPARA,DIM127
          MOVE      FLDPARA,F1
          BRANCH    F1,CANDET10,CANDET20,CANDET30,CANDET40,CANDET50,CANDET51
          GOTO      CANDET99
.
CANDET10  COMPARE   CBOOK,ONE
          GOTO      CANDET99 IF NOT EQUAL
.
          MOVE      AADMNO,KEY8             * Output booking indicator
          CALL      RDBKREC1
          BRANCH    OVRCD,CANDET99
          WRITE     HTMLFILE;ONE;
          GOTO      CANDET99
.
CANDET20  COMPARE   HBWAIT,ONE
          GOTO      CANDET99 IF NOT EQUAL
.
          MOVE      AADMNO,KEY8
          CALL      RDBKREC1
          BRANCH    OVRCD,CANDET99
.
          PACK      KEY19,BKREURNO,BKREPROC,BKRECNT *Output W/L Indicator
          CALL      RDTREA1
          BRANCH    OVRCD,CANDET99
.
.
          WRITE     HTMLFILE;ONE;
          GOTO      CANDET99
.
CANDET30  COMPARE   CTHETR,ONE
          GOTO      CANDET99 IF NOT EQUAL
.
          PACK      KEY31,AADMNO,SP70
          CALL      RSOPDEA2
          CALL      RKOPDEA2
          BRANCH    OVRCD,CANDET99          * not a theatre booking
          MATCH     OPDAADMN,DAADMNO
          GOTO      CANDET99 IF NOT EQUAL
          WRITE     HTMLFILE;ONE;
          GOTO      CANDET99                                  *T0845646-start
.
.------- Visit with Post Discharge Coding will be identified as those where
.------- the Pre-admission number being cancelled has a record in either
.------- of the Post Discharge Coding tables, "patecdaf.dptedadm" or
.------- "patecoaf.dpteoadm"
CANDET40  OPEN      PATECDA1,"patecdaf"
          OPEN      PATECOA1,"patecoaf"
          PACK      KEY13,AADMNO,SP70
          CALL      RSPTECD1
          CALL      RKPTECD1                             * patecdaf
          BRANCH    OVRCD,CANDET41
          MATCH     DPTEDADM,DAADMNO
          GOTO      CANDET41 IF NOT EQUAL
          WRITE     HTMLFILE;ONE;
          GOTO      CANDET42
.
CANDET41  PACK      KEY13,AADMNO,SP70
          CALL      RSPTECO1 
          CALL      RKPTECO1                            * patecoaf
          BRANCH    OVRCD,CANDET42
          MATCH     DPTEOADM,DAADMNO
          GOTO      CANDET42 IF NOT EQUAL
          WRITE     HTMLFILE;ONE;
          GOTO      CANDET42
.
CANDET42  CLOSE     PATECDA1
          CLOSE     PATECOA1
          GOTO      CANDET99
.
.-------- Visit with Bookings will be identified as those where the 
.-------- Pre-admission being cancelled has a record in either the Booking
.-------- table "bokrc1af.bkrestat" (that does not have a Status of 2-Cancelled)
.-------- or Theatre Booking table "oprdetaf.dopdasta" (that does not have a
.-------- Status of 3-Cancelled)
CANDET50  MOVE      AADMNO,KEY8     
          CALL      RDBKREC1                            * bokrc1af
          BRANCH    OVRCD,CANDET51
          COMPARE   TWO,BKRESTAT                        * Status cancelled
          GOTO      CANDET51 IF EQUAL
          WRITE     HTMLFILE;ONE;
          GOTO      CANDET99
.
CANDET51  PACK      KEY31,AADMNO,SP70
          CALL      RSOPDEA2
          CALL      RKOPDEA2                            * oprdetaf
          BRANCH    OVRCD,CANDET99
          MATCH     OPDAADMN,DAADMNO
          GOTO      CANDET99 IF NOT EQUAL
          MATCH     "3",DOPDASTA                        * Status cancelled
          GOTO      CANDET99 IF EQUAL
          WRITE     HTMLFILE;ONE;
          GOTO      CANDET99                                      *T0845646-End
.
CANDET99  RETURN
+
.------------------------------------------------------------
. Open Outpatient Files
.------------------------------------------------------------
.
OPNOUT00  PACK      CFNAME,CFILEPRE,FILBOKA3  * Get the name of the BOKA3 file
          OPEN      OUTBOKA3,CFNAME           * Open the file
          PACK      CFNAME,CFILEPRE,FILBOKA6  * Get the name of the BOKA6 file
          OPEN      OUTBOKA6,CFNAME           * Open the file
.
          OPEN      OUTPREA1,"outpreaf"
.
          PACK      CFNAME,CFILEPRE,FILLKBA1  * Get the name of the LKBA1 file
          OPEN      OUTLKBA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILCLIA1  * Get the name of the LKBA1 file
          OPEN      OUTCLIA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILBB1A1
          CLOSE     OUTBB1A1
          CALL      OPOTBB11               * Open the file
.
OPNOUT99  RETURN
+
.------------------------------------------------------------
. PRDT0000 - Update booking pre admission date and time
.------------------------------------------------------------
.
PRDT0000  COMPARE   ONE,CBOOK
          GOTO      PRDT9999 IF NOT EQUAL
.
          MOVE      ADMISSNO,KEY8
          CALL      RDBKREC1
          BRANCH    OVRCD,PRDT9999
.
          MATCH     "1",KEEPBKTM
          GOTO      PRDT9999 IF EQUAL
.
          COMPARE   THREE,PTCNHDPS          * Don't update confirmed admission
          GOTO      PRDT0500 IF NOT EQUAL   * for victorian public hospitals
.
          COMPARE   ONE,CHOSTYP             * Public
          GOTO      PRDT9999 IF EQUAL
.
PRDT0500  MATCH     PTMIS001,Z70
          IF        !@EQUAL
            MOVE      PTMIS001,BKREEDAT     * Confirmed admission date
            REP       " 0",BKREEDAT
          ENDIF
.
          MATCH     PTMIS002,Z70
          IF        !@EQUAL
            MOVE      PTMIS002,BKREATIM     * Confirmed admission time
          ENDIF
.
          CALL      UPBKREC1
.
PRDT9999  RETURN
+
.-----------------------------------------------------------------------------
. CELG0000 - Checking for Eligibility information
.-----------------------------------------------------------------------------
CELG0000  COMPARE   ONE,PTCNCELG
          GOTO      CELG9999 IF NOT EQUAL
.
          PACK      KEY8,ADMISSNO,SP20
          CALL      RDPTELG1            * check for eligibility information
          BRANCH    OVRCD,CELG7000
.
          MATCH     "1",PTELCMPL
          GOTO      CELG7000 IF NOT EQUAL     * Not completed
.
          COMPARE   ZERO,PTELXCSS
          GOTO      CELG8000 IF NOT EQUAL     * got payment excess
.
          MATCH     "1",PTELQEXS              * Quote Exists ?
          GOTO      CELG9999 IF NOT EQUAL
.
.         Check if there is a Fees Estimate Link
.
          OPEN      PMSAELA1,"pmsaelaf"
          PACK      KEY20,ADMISSNO,SP70
          CALL      RSPMAEL1
          CALL      RKPMAEL1
          BRANCH    OVRCD,CELG9999
          CLOSE     PMSAELA1
.
          MATCH     ADMISSNO,PMAEVISN         * Different admission
          GOTO      CELG9999 IF NOT EQUAL
.
          MATCH     "1",PTELQACC              * Quote Accepted ?
          GOTO      CELG9999 IF NOT EQUAL
.
          PACK      KEY5,CODECL,ACLAIM
          CALL      RDCODE1
          BRANCH    OVRCD,CELG9999
.
          MATCH     "3",TCINDC5
          GOTO      CELG9999 IF NOT EQUAL
.
.         Self Insured
.
          CALL      CDEP0000                  * Check for Deposit
          COMPARE   PTELTOOP,FORM12P2
          GOTO      CELG8200 IF LESS          * Deposit is less than OOPs
.
          GOTO      CELG9999
.
CELG7000  MOVE      "Warning: Eligibility Check is Incomplete.",WEBTITLE
          ADD       ONE,WARCOUNT
          MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
          GOTO      CELG9999
.
CELG8000  CLEAR     WEBTITLE
          APPEND    "Warning: Payment of Excess is required ",WEBTITLE
          APPEND    "before Admission.",WEBTITLE
          APPEND    SP70,WEBTITLE
          RESET     WEBTITLE
          ADD       ONE,WARCOUNT
          MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
          GOTO      CELG9999
.
CELG8200  CLEAR     WEBTITLE
          APPEND    "Warning: Total OOPs still outstanding.",WEBTITLE
          APPEND    SP70,WEBTITLE
          RESET     WEBTITLE
          ADD       ONE,WARCOUNT
          MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
          GOTO      CELG9999
.
CELG9999  RETURN
+
.-----------------------------------------------------------------------------
.         Check if patient has any deposits
.-----------------------------------------------------------------------------
CDEP0000  OPEN      RCPDTEA6,"rcpdteaf"
          OPEN      RCPBNKA1,"rcpbnkaf"
.
          MOVE      ZERO,FORM12P2
          MOVE      AADMNO,DAADMNO
          PACK      KEY25,AADMNO,SP70          * unreleased cash
          CALL      RSRCDTE6
CDEP1000  CALL      RKRCDTE6
          BRANCH    OVRCD,CDEP9999
.
          MATCH     DAADMNO,RCDTVIST
          GOTO      CDEP9999 IF NOT EQUAL
.
          MATCH     SP70,RCDTINVN
          GOTO      CDEP1000 IF NOT EQUAL      * Not a deposit
.
          PACK      KEY12,RCDTRECN,SP70
          CALL      RDRCBNK1
          BRANCH    OVRCD,CDEP1000
.
          MATCH     "1",RCBNSTAT
          GOTO      CDEP1000 IF EQUAL            * Already cancelled
.
          ADD       RCDTAMNT,FORM12P2
          GOTO      CDEP1000
.
CDEP9999  CLOSE     RCPDTEA6
          CLOSE     RCPBNKA1
          RETURN
+
.-----------------------------------------------------------------------------
. CGTU0000 - Update Unknown GST file if necessary
.-----------------------------------------------------------------------------
CGTU0000  COMPARE   TWO,ASTAT
          GOTO      CGTU9999 IF NOT EQUAL
.
          OPEN      PATGTUA1,"patgtuaf"
          MATCH     "U",PTMIGSTA
          GOTO      CGTU1000 IF NOT EQUAL
.
          PACK      KEY8,AADMNO
          CALL      RDPTGTU1
          IF        OVRCD=0
            MOVE      ONE,PTGTGSTA           * Unknown Accommodation GST
            CALL      UPPTGTU1
          ELSE
            MOVE      AADMNO,PTGTADMN
            MOVE      ONE,PTGTGSTA           * Unknown Accommodation GST
            MOVE      ZERO,PTGTGSTM
            CALL      WRPTGTU1
          ENDIF
          GOTO       CGTU9000
.
.         GST is Yes or No (not Unknown)
.
CGTU1000  PACK       KEY8,AADMNO
          CALL       RDPTGTU1
          BRANCH     OVRCD,CGTU9000
.
.         If Item has unknown GST, do not remove Unknown GST record
.
          IF         PTGTGSTM=1
            MOVE       ZERO,PTGTGSTA         * Accommmodation GST is not unknown
            CALL       UPPTGTU1
          ELSE
            CALL       DEPTGTU1              * delete Unknown GST record
          ENDIF
.
CGTU9000  CLOSE      PATGTUA1
CGTU9999  RETURN
+
.******************************************************************************
.*                                 WPEI0000                                   *
.*                        Write A Record To patpeiaf                          *
.******************************************************************************
.
WPEI0000  READ      CONTROLF,EIGHTY8;*116,CHCSDTE,*124,CHCSST,*132,CHCSED
.
          COMPARE   THREE,PTCNHDPS
          GOTO      WPEI9999 IF NOT EQUAL   * Not in Victoria
.
          COMPARE   THREE,ASTAT
          GOTO      WPEI9000 IF NOT EQUAL   * Not discharged
.
          MATCH     CHCSDTE,DDATE
          GOTO      WPEI9000 IF LESS        * Discharge date < start HDP date
.
          MATCH     CHCSST,ADATE
          GOTO      WPEI9000 IF NOT LESS    * Adm date >= PRS2 extract start dte
.
          PACK      KEY16,SP8,AADMNO
          CALL      RDPTPEI1                * Read a PRS2 inc/exc file record
          COMPARE   ONE,OVRCD
          GOTO      WPEI9000 IF NOT EQUAL   * Record exists, dont write
.
          PACK      KEY16,CHCSST,AADMNO
          CALL      RDPTPEI1                * Read a PRS2 inc/exc file record
          COMPARE   ONE,OVRCD
          GOTO      WPEI9000 IF NOT EQUAL   * Record exists, dont write
.
          MOVE      SP8,PTPESTDT
          MOVE      AADMNO,PTPEADMN
          MOVE      TWO,PTPESTAT
          CALL      IBACLOCK                * Get the current date
          PACK      PTPEDATE,CCC,CYY,CMM,CDD
          REP       " 0",PTPEDATE
          MOVE      USERID,PTPEOPER
.
          MOVE      SP3,PTPERESN
          PACK      KEY5,ANSR,ANSN,SP3
          CALL      RDSCODE1                * Position on & read a codes file
WPEI1000  CALL      RDKCODE1                  record
          BRANCH    OVRCD,WPEI2000
.
          MATCH     "RN",TCODE
          GOTO      WPEI2000 IF NOT EQUAL   * Different category
.
          MATCH     HDPEQUIV,THCSCOD
          GOTO      WPEI1000 IF NOT EQUAL   * Different HDP equivalent
.
          MOVE      ACODE,PTPERESN
.
WPEI2000  MOVE      PASSCODE,PTPEOPER
          PACK      KEY16,PTPESTDT,PTPEADMN,SP70
          CALL      WRPTPEI1                * Write a PRS2 inc/exc file record
.
WPEI9000  MOVE      ZERO,EXIT
.
WPEI9999  RETURN
+
.******************************************************************************
.*                                 PRS2T000                                   *
.*                Check for any PRS2 PMI trigger variable changes             *
.******************************************************************************
.
PRS2T000  READ      CONTROLF,EIGHTY8;*116,CHCSDTE,*124,CHCSST,*132,CHCSED
.
          COMPARE   SIX,PTCNHDPS
          GOTO      PRS2T800 IF EQUAL       * write if WA
.
          COMPARE   THREE,PTCNHDPS
          GOTO      PRS2T999 IF NOT EQUAL   * Not in Victoria
.
          OPEN      PATDSCH3,"patdschf"
          PACK      KEY24,PURNO,Z70
          CALL      RDSDSCH3
PRS2T100  CALL      RDPDSCH3
          BRANCH    OVRCD,PRS2T999          * must have discharged visits
.
          MATCH     PURNO,DURNO
          GOTO      PRS2T999 IF NOT EQUAL   * same u/r?
.
          MATCH     CHCSDTE,DDATE
          GOTO      PRS2T999 IF LESS        * Ddate must be >= start HDP date
.
PRS2T800  CALL      CPRST000                * check PRS2 trigger variables
.
PRS2T999  CLOSE     PATDSCH3
          RETURN
+
.******************************************************************************
.*                                 SPRS0000                                   *
.*        Save PRS2 and EDWARD PMI trigger variables                          *
.******************************************************************************
.
SPRS0000  MOVE      PBDATE,SAVPBDAT
          MOVE      PMPXABRG,SAVXABRG
          MOVE      PMPXRHC1,SAVPXGPC
          MOVE      PMPXRH1G,SAVPGPRC
          MOVE      PMPXPRVI,SAVPPRVI
          MOVE      PCONT,SAVPCONT
          MOVE      PMPXLNG1,SAVXLNG1
          MOVE      PSEX,SAVPPSEX
          MOVE      PMSTAT,SAVPMSTA
          MOVE      PTYPE,SAVPTYPE
          MOVE      PMPXINTR,SAVXINTR
          MOVE      PADD2,SAVPADD2
          MOVE      PSUBRB,SAVPSUBR
          MOVE      PPOST,SAVPPOST
          MOVE      PMEDI,SAVPMEDI
          MOVE      PTMXMCCD,SAVPMCCD
.
          MOVE      PCEASE,SAVPCEAS
          MOVE      PREG,SAVPREG
          MOVE      POCCUP,SAVPOCCU
          MOVE      PTMASNAM,SAVPSNAM
          MOVE      PMPXFNAM,SAVPFGNM
          MOVE      PMPXSNAM,SAVPSGNM
.
          MOVE      PFUNDH,SAVFUNDH 
.
SPRS2999  RETURN
+
.******************************************************************************
.*                                 CPRST000                                   *
.*             Check if any PRS2 trigger variables have changed               *
.******************************************************************************
.
CPRST000  MATCH     SAVPBDAT,PBDATE
          IF        !@EQUAL
            MOVE      "1",P2PMUNIQ
            MOVE      PBDATE,P2PMVALU
            CALL      WPRSP000
          ENDIF
          MATCH     SAVPTYPE,PTYPE
          IF        !@EQUAL
            MOVE      "7",P2PMUNIQ
            MOVE      PTYPE,P2PMVALU
            CALL      WPRSP000
          ENDIF
.
          COMPARE   SIX,PTCNHDPS
          GOTO      CPRST999 IF EQUAL
.
          MATCH     SAVXABRG,PMPXABRG
          IF        !@EQUAL
            MOVE      "2",P2PMUNIQ
            MOVE      PMPXABRG,P2PMVALU
            CALL      WPRSP000
          ENDIF
          MATCH     SAVPCONT,PCONT
          IF        !@EQUAL
            MOVE      "3",P2PMUNIQ
            MOVE      PCONT,P2PMVALU
            CALL      WPRSP000
          ENDIF
          MATCH     SAVXLNG1,PMPXLNG1
          IF        !@EQUAL
            MOVE      "4",P2PMUNIQ
            MOVE      PMPXLNG1,P2PMVALU
            CALL      WPRSP000
          ENDIF
          MATCH     SAVPPSEX,PSEX
          IF        !@EQUAL
            MOVE      "5",P2PMUNIQ
            MOVE      PSEX,P2PMVALU
            CALL      WPRSP000
          ENDIF
          MATCH     SAVPMSTA,PMSTAT
          IF        !@EQUAL
            MOVE      "6",P2PMUNIQ
            MOVE      PMSTAT,P2PMVALU
            CALL      WPRSP000
          ENDIF
          MATCH     SAVPTYPE,PTYPE
          IF        !@EQUAL
            MOVE      "7",P2PMUNIQ
            MOVE      PTYPE,P2PMVALU
            CALL      WPRSP000
          ENDIF
          MATCH     SAVXINTR,PMPXINTR
          IF        !@EQUAL
            MOVE      "8",P2PMUNIQ
            MOVE      PMPXINTR,P2PMVALU
            CALL      WPRSP000
          ENDIF
.
          IF        CNSWLOC=2
            MATCH     SAVPADD2,PADD2
            IF        !@EQUAL
              MOVE      "9",P2PMUNIQ
              MOVE      PADD2,P2PMVALU           * using address line 2
              CALL      WPRSP000
            ENDIF
          ELSE
            MATCH     SAVPSUBR,PSUBRB
            IF        !@EQUAL
              MOVE      "9",P2PMUNIQ
              MOVE      PSUBRB,P2PMVALU          * using suburb field
              CALL      WPRSP000
            ENDIF
          ENDIF
.
          MATCH     SAVPPOST,PPOST
          IF        !@EQUAL
            MOVE      "10",P2PMUNIQ
            MOVE      PPOST,P2PMVALU
            CALL      WPRSP000
          ENDIF
          MATCH     SAVPMEDI,PMEDI
          IF        !@EQUAL
            MOVE      "11",P2PMUNIQ
            PACK      P2PMVALU,PMEDI,SP1,PTMXMCCD
            CALL      WPRSP000
          ENDIF
          MATCH     SAVPMCCD,PTMXMCCD
          IF        !@EQUAL
            MOVE      "11",P2PMUNIQ
            PACK      P2PMVALU,PMEDI,SP1,PTMXMCCD
            CALL      WPRSP000
          ENDIF
CPRST999  RETURN
+
.******************************************************************************
.*                                 WPRSP000                                   *
.* If any of the PRS2 trigger variables have changed, write/update prspmiaf   *
.******************************************************************************
.
WPRSP000  MOVE      PURNO,P2PMURNO
          PACK      P2PMSPAR,SP70
          PACK      KEY11,P2PMURNO,P2PMUNIQ,SP70
          CALL      RAP2PMI1
          IF        OVRCD=1
            CALL      WRP2PMI1
          ELSE
            CALL      UPP2PMI1
          ENDIF
WPRSP999  RETURN
.
.******************************************************************************
.*                                 CHEDW000                                   *
.* If sending EDWARD, check if any EDWARD  variables have changed             *
.******************************************************************************
.
CHEDW000  READ      CONTROLF,HUND25;*93,PTCNNSSI
          MATCH     SP70,PTCNNSSI        * no edward source system
          GOTO      CHEDW999 IF EQUAL
.
          MATCH     ZERO20,PTCNNSSI        * no edward source system
          GOTO      CHEDW999 IF EQUAL
.
          MATCH     SAVPPSEX,PSEX
          IF        !@EQUAL
            MOVE      "1",PMEWTYPE
            MOVE      SAVPPSEX,PMEWOLDV
            MOVE      PSEX,PMEWNEWV
            CALL      WREDW000
          ENDIF
.
          MATCH     SAVPBDAT,PBDATE
          IF        !@EQUAL
            MOVE      "2",PMEWTYPE
            MOVE      SAVPBDAT,PMEWOLDV
            MOVE      PBDATE,PMEWNEWV
            CALL      WREDW000
          ENDIF
.
          MATCH     SAVPCONT,PCONT
          IF        !@EQUAL
            MOVE      "3",PMEWTYPE
            MOVE      SAVPCONT,PMEWOLDV
            MOVE      PCONT,PMEWNEWV
            CALL      WREDW000
          ENDIF
.
          COMPARE   SAVPCEAS,PCEASE
          IF        !@EQUAL
            MOVE      "4",PMEWTYPE
            MOVE      SAVPCEAS,PMEWOLDV
            MOVE      PCEASE,PMEWNEWV
            CALL      WREDW000
          ENDIF
.
          MATCH     SAVXABRG,PMPXABRG
          IF        !@EQUAL
            MOVE      "5",PMEWTYPE
            MOVE      SAVXABRG,PMEWOLDV
            MOVE      PMPXABRG,PMEWNEWV
            CALL      WREDW000
          ENDIF
.
          MATCH     SAVPMSTA,PMSTAT
          IF        !@EQUAL
            MOVE      "6",PMEWTYPE
            MOVE      SAVPMSTA,PMEWOLDV
            MOVE      PMSTAT,PMEWNEWV
            CALL      WREDW000
          ENDIF
.
          MATCH     SAVPMEDI,PMEDI
          IF        !@EQUAL
            MOVE      "7",PMEWTYPE
            PACK      PMEWOLDV,SAVPMEDI,SP1,SAVPMCCD
            PACK      PMEWNEWV,PMEDI,SP1,PTMXMCCD
            CALL      WREDW000
          ELSE
            PACK      PTMXMCCD,PTMXMCCD,SP70
            MATCH     SAVPMCCD,PTMXMCCD
            IF        !@EQUAL
              MOVE      "7",PMEWTYPE
              PACK      PMEWOLDV,SAVPMEDI,SP1,SAVPMCCD
              PACK      PMEWNEWV,PMEDI,SP1,PTMXMCCD
              CALL      WREDW000
            ENDIF
          ENDIF
.
          MATCH     SAVXLNG1,PMPXLNG1
          IF        !@EQUAL
            MOVE      "8",PMEWTYPE
            MOVE      SAVXLNG1,PMEWOLDV
            MOVE      PMPXLNG1,PMEWNEWV
            CALL      WREDW000
          ENDIF
.
          MATCH     SAVPREG,PREG
          IF        !@EQUAL
            MOVE      "9",PMEWTYPE
            MOVE      SAVPREG,PMEWOLDV
            MOVE      PREG,PMEWNEWV
            CALL      WREDW000
          ENDIF
.
          MATCH     SAVPOCCU,POCCUP
          IF        !@EQUAL
            MOVE      "10",PMEWTYPE
            MOVE      SAVPOCCU,PMEWOLDV
            MOVE      POCCUP,PMEWNEWV
            CALL      WREDW000
          ENDIF
.
          MATCH     SAVXINTR,PMPXINTR
          IF        !@EQUAL
            MOVE      "11",PMEWTYPE
            MOVE      SAVXINTR,PMEWOLDV
            MOVE      PMPXINTR,PMEWNEWV
            CALL      WREDW000
          ENDIF
.
          MATCH     SAVPXGPC,PMPXRHC1
          IF        !@EQUAL
            MOVE      "20",PMEWTYPE
            PACK      PMEWOLDV,SAVPXGPC,SP70
            PACK      PMEWNEWV,PMPXRHC1,SP70
            CALL      WREDW000
          ENDIF
.
          MATCH     SAVPGPRC,PMPXRH1G
          IF        !@EQUAL
            MOVE      "21",PMEWTYPE
            PACK      PMEWOLDV,SAVPGPRC,SP70
            PACK      PMEWNEWV,PMPXRH1G,SP70
            CALL      WREDW000
          ENDIF
.
          PACK      PMPXPRVI,PMPXPRVI,SP70
          MATCH     SAVPPRVI,PMPXPRVI
          IF        !@EQUAL
            MOVE      "22",PMEWTYPE
            PACK      PMEWOLDV,SAVPPRVI,SP70
            PACK      PMEWNEWV,PMPXPRVI,SP70
            CALL      WREDW000
          ENDIF
.
          MATCH     SAVPSNAM,PTMASNAM
          IF        !@EQUAL
            MOVE      "17",PMEWTYPE
            PACK      PMEWOLDV,SAVPSNAM,SP1,SAVPFGNM,SP1,SAVPSGNM,SP70
            PACK      PMEWNEWV,PTMASNAM,SP1,PMPXFNAM,SP1,PMPXSNAM,SP70
            CALL      WREDW000
            GOTO      CHEDW100
          ENDIF
.
          MATCH     SAVPFGNM,PMPXFNAM
          IF        !@EQUAL
            MOVE      "17",PMEWTYPE
            PACK      PMEWOLDV,SAVPSNAM,SP1,SAVPFGNM,SP1,SAVPSGNM,SP70
            PACK      PMEWNEWV,PTMASNAM,SP1,PMPXFNAM,SP1,PMPXSNAM,SP70
            CALL      WREDW000
            GOTO      CHEDW100
          ENDIF
.
          MATCH     SAVPSGNM,PMPXSNAM
          IF        !@EQUAL
            MOVE      "17",PMEWTYPE
            PACK      PMEWOLDV,SAVPSNAM,SP1,SAVPFGNM,SP1,SAVPSGNM,SP70
            PACK      PMEWNEWV,PTMASNAM,SP1,PMPXFNAM,SP1,PMPXSNAM,SP70
            CALL      WREDW000
            GOTO      CHEDW100
          ENDIF
.
          PACK      SAVFUNDH,SAVFUNDH,SP70
          PACK      PFUNDH,PFUNDH,SP70
          PACK      PFNDTB,PFNDTB,SP70
.
          MATCH     SAVFUNDH,PFUNDH
          IF        !@EQUAL
            MATCH     SP70,SAVFUNDH
            IF        @EQUAL
              MOVE      "25",PMEWTYPE       * Health Fund Added 
            ELSE
              MOVE      "26",PMEWTYPE       * Health Fund Changed
            ENDIF
            PACK      PMEWOLDV,SAVFUNDH,SP70
            PACK      PMEWNEWV,PFUNDH,SP70
            CALL      WREDW000
            GOTO      CHEDW100
          ENDIF
.
CHEDW100
CHEDW999  RETURN
+
.******************************************************************************
.*                                EDWH0000                                    *
.******************************************************************************
EDWH0000  READ      CONTROLF,HUND25;*93,PTCNNSSI
          MATCH     SP70,PTCNNSSI           * no edward source system
          GOTO      EDWH9999 IF EQUAL
.
          MATCH     ZERO20,PTCNNSSI         * no edward source system
          GOTO      EDWH9999 IF EQUAL
.
          MATCH     Z70,PTMIS013            * No Health Fund Received
          GOTO      EDWH9999 IF EQUAL
.
          PACK      PTMIS013,PTMIS013,SP70  * Pad with spaces if EOS
          PACK      PFUNDH,PFUNDH,SP70      * Pad with spaces if EOS
.
          MATCH     PFUNDH,PTMIS013         * Different Health Fund
          GOTO      EDWH9999 IF EQUAL
.
          MATCH     SP70,PFUNDH
          IF        @EQUAL
            MOVE      "25",PMEWTYPE       * Health Fund Added
          ELSE
            MOVE      "26",PMEWTYPE       * Health Fund Changed
          ENDIF
          PACK      PMEWOLDV,PFUNDH,SP70
          PACK      PMEWNEWV,PTMIS013,SP70
          CALL      WREDW000
.
EDWH9999  RETURN
+
.******************************************************************************
.*                                 WREDW000                                   *
.* If any of the EDWWARD variables have changed, write/update pmsedwaf        *
.******************************************************************************
.
WREDW000  CLOSE     PRSPMIA1
          READ      CONTROLF,HUND25;*93,PTCNNSSI
          MATCH     SP70,PTCNNSSI        * no edward source system
          GOTO      WREDW999 IF EQUAL
.
          MATCH     ZERO20,PTCNNSSI        * no edward source system
          GOTO      WREDW999 IF EQUAL
.
          OPEN      PMSEDWA2,"pmsedwaf"
.
          MOVE      PURNO,PMEWURNO
          CALL      IBACLOCK
          PACK      PMEWCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMEWCDAT
          CLOCK     TIME,PMEWCTIM
          PACK      PMEWCUID,USERID
          PACK      PMEWTYPE,PMEWTYPE,SP70
          PACK      PMEWSPAR,SP70,SP70
.
          PACK      KEY27,PMEWURNO,PMEWTYPE,PMEWCDAT,PMEWCTIM,SP70
          CALL      RAPMEDW2
          IF        OVRCD=1
            CALL      WRPMEDW2
          ELSE
            CALL      UPPMEDW2
          ENDIF
.
WREDW999  CLOSE     PMSEDWA2
          OPEN      PRSPMIA1,"prspmiaf"
          RETURN
.
.******************************************************************************
.*                                 WESIS000                                   *
.*                           Write/update watespaf                            *
.******************************************************************************
.
WESIS000  READ      CONTROLF,EIGHTY;*250,PTCNHDPS
.
          COMPARE   THREE,PTCNHDPS
          GOTO      WESIS999 IF NOT EQUAL   * Not in Victoria
.
          PACK      KEY16,PURNO,Z70
          CALL      RSWTESP1
          CALL      RPWTESP1
          BRANCH    OVRCD,WESIS999
.
          MATCH     PURNO,WTEPURNO
          GOTO      WESIS999 IF NOT EQUAL
.
          CALL      CHKESI00
          BRANCH    EXIT,WESIS999   * no changes
          GOTO      WESIS200
.
WESIS200  PACK      WTEPURNO,PURNO
          PACK      WTEPEDAT,SP70
          PACK      WTEPPDOB,PBDATE,SP70
          PACK      WTEPEDOB,PMPXEDOB,SP70
          PACK      WTEPPSEX,PSEX,SP70
          PACK      WTEPMEDI,PMEDI,SP70
          SQUEEZE   PTMXMCCD
          PACK      WTEPMREF,PTMXMCCD,SP70
          PACK      WTEPRESI,PTYPE,SP70
          PACK      WTEPPOST,PPOST,SP70
          PACK      WTEPSUBR,PSUBRB,SP70
          PACK      WTEPABRG,PMPXABRG,SP70
          PACK      WTEPPGEN,PMPXUCC4,SP70
.
          CALL      IBACLOCK
          PACK      XDATE,CCC,CYY,CMM,CDD
          REP       " 0",XDATE
.
          OPEN      PMSCCDA1,"pmsccdaf"
          PACK      KEY19,URNUMBER,SP70
          CALL      RSPMCCD1
WESIS280  CALL      RKPMCCD1
          BRANCH    OVRCD,WESIS300
.
          MATCH     URNUMBER,PMCDURNO
          GOTO      WESIS300 IF NOT EQUAL
.
          MATCH     XDATE,PMCDEXDT
          IF        !@LESS
            MATCH     "NDI",PMCDCTYP
            IF        @EQUAL
              PACK    WTEPNDIS,PMCDCNUM,SP70
            ENDIF
          ENDIF
          GOTO      WESIS280
.
WESIS300  PACK      WTEPSPAR,SP70
.
          PACK      KEY16,PURNO,SP70
          CALL      RAWTESP1
          IF        OVRCD=1
            PACK      WTEPWEBC,WBSEUID,SP70
            PACK      WTEPCDAT,CCC,CYY,CMM,CDD,SP70
            REP       " 0",WTEPCDAT
            PACK      WTEPCTIM,CTIMEIS,SP70
            REP       " 0",WTEPCTIM
            CALL      WRWTESP1
          ELSE
            PACK      WTEPWEBU,WBSEUID,SP70
            PACK      WTEPUDAT,CCC,CYY,CMM,CDD,SP70
            REP       " 0",WTEPUDAT
            PACK      WTEPUTIM,CTIMEIS,SP70
            REP       " 0",WTEPUTIM
            CALL      UPWTESP1
          ENDIF
.
WESIS999  CLOSE     PMSCCDA1
          RETURN
.
.******************************************************************************
.*                                 CHKESI00                                   *
.*                 Check if any ESIS have changed since last sent             *
.******************************************************************************
.
CHKESI00  MOVE      ZERO,EXIT
.
          MATCH     WTEPPDOB,PBDATE
          GOTO      CHKESI90 IF NOT EQUAL
.
          MATCH     WTEPEDOB,PMPXEDOB
          GOTO      CHKESI90 IF NOT EQUAL
.
          MATCH     WTEPPSEX,PSEX
          GOTO      CHKESI90 IF NOT EQUAL
.
          MATCH     WTEPMEDI,PMEDI
          GOTO      CHKESI90 IF NOT EQUAL
.
          SQUEEZE   PTMXMCCD
          MATCH     WTEPMREF,PTMXMCCD
          GOTO      CHKESI90 IF NOT EQUAL
.
          MATCH     WTEPRESI,PTYPE
          GOTO      CHKESI90 IF NOT EQUAL
.
          MATCH     WTEPPOST,PPOST
          GOTO      CHKESI90 IF NOT EQUAL
.
          MATCH     WTEPSUBR,PSUBRB
          GOTO      CHKESI90 IF NOT EQUAL
.
          MATCH     WTEPABRG,PMPXABRG
          GOTO      CHKESI90 IF NOT EQUAL
.
          MATCH     WTEPPGEN,PMPXUCC4
          GOTO      CHKESI90 IF NOT EQUAL
.
          MOVE      ONE,EXIT                 * No Changes
.
CHKESI90  GOTO      CHKESI99
.
CHKESI99  RETURN
+
CLRWTESI  PACK      WTEPURNO,SP70
          PACK      WTEPEDAT,SP70
          PACK      WTEPPDOB,SP70
          PACK      WTEPEDOB,SP70
          PACK      WTEPPSEX,SP70
          PACK      WTEPMEDI,SP70
          PACK      WTEPRESI,SP70
          PACK      WTEPPOST,SP70
          PACK      WTEPSUBR,SP70
          PACK      WTEPABRG,SP70
          PACK      WTEPWEBC,SP70
          PACK      WTEPCDAT,SP70
          PACK      WTEPCTIM,SP70
          PACK      WTEPWEBU,SP70
          PACK      WTEPUDAT,SP70
          PACK      WTEPUTIM,SP70
          PACK      WTEPPGEN,SP70
          PACK      WTEPNDIS,SP70
          PACK      WTEPSPAR,SP70
.
          RETURN
.******************************************************************************
.*                                 WESE0000                                   *
.*                Write/update wateseaf (episode details)                     *
.******************************************************************************
.............. Procedure must have occurred - now called from theatre --------
.
WESE0000  READ      CONTROLF,EIGHTY;*250,PTCNHDPS
.
          COMPARE   THREE,PTCNHDPS
          GOTO      WESE9999 IF NOT EQUAL   * Not in Victoria
.
          PACK      KEY17,WTWMECNT,Z70
          CALL      RSWTESE1
          CALL      RPWTESE1
          BRANCH    OVRCD,WESE9999
.
          MATCH     WTEEUNIQ,WTWMECNT
          GOTO      WESE9999 IF NOT EQUAL
.
          CALL      CHKESE00
          BRANCH    EXIT,WESE9999   * no changes
.
          PACK      WTEEADAT,ADATE
          PACK      WTEEINSD,ACLAIM
          PACK      WTEEWEBU,SP70
          PACK      WTEEUDAT,SP70
          PACK      WTEEUTIM,SP70
.
          PACK      KEY17,WTEEUNIQ,WTEEEDAT,SP70
          CALL      RAWTESE1
          IF        OVRCD=0
            PACK      WTEEWEBU,WBSEUID,SP70
            CALL      IBACLOCK
            PACK      WTEEUDAT,CCC,CYY,CMM,CDD
            REP       " 0",WTEEUDAT
            CLOCK     TIME,WTEEUTIM
            REP       " 0",WTEEUTIM
            CALL      UPWTESE1
          ENDIF
.
WESE9999  RETURN
+
.******************************************************************************
.*                                 CHKESE00                                   *
.*                Check if any wateseaf details have changed                  *
.******************************************************************************
CHKESE00  MOVE      ZERO,EXIT
.
          MATCH     WTEEADAT,ADATE
          GOTO      CHKESE90 IF NOT EQUAL
.
          MATCH     WTEEINSD,ACLAIM
          GOTO      CHKESE90 IF NOT EQUAL
.
          MOVE      ONE,EXIT                 * No Changes
.
CHKESE90  GOTO      CHKESE99
.
CHKESE99  RETURN
.
CLRWTESE  PACK      WTEEUNIQ,SP70
          PACK      WTEEURNO,SP70
          PACK      WTEEADAT,SP70
          PACK      WTEEDEST,SP70
          PACK      WTEEINSD,SP70
          PACK      WTEEPLOS,SP70
          PACK      WTEEPROC,SP70
          PACK      WTEEPDES,SP70
          PACK      WTEERREM,SP70
          PACK      WTEERDAT,SP70
          PACK      WTEEREMD,SP70
          PACK      WTEESREF,SP70
          PACK      WTEESSPC,SP70
          PACK      WTEEWEBC,SP70
          PACK      WTEECDAT,SP70
          PACK      WTEECTIM,SP70
          PACK      WTEEWEBU,SP70
          PACK      WTEEUDAT,SP70
          PACK      WTEEUTIM,SP70
          PACK      WTEEARDT,SP70
          PACK      WTEESPAR,SP70
          PACK      WTEEMANU,SP70
          PACK      WTEEPTWT,SP70
          PACK      WTEESGID,SP70
          PACK      WTEERADT,SP70
          PACK      WTEETCMP,SP70
.
          RETURN
.-----------------------------------------------------------------------------
. CTRN0000 - Check transfer source
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.-----------------------------------------------------------------------------
.
CTRN0000  MATCH     Z70,TRNSFSRC                 * No transfer source
          GOTO      CTRN9000 IF EQUAL
.
          PACK      TRNSCODE,TRNSFSRC,SP70
.
          MATCH     SP70,TRNSFSRC                * No transfer source
          GOTO      CTRN9000 IF EQUAL
.
          PACK      TRNSDATE,ADATE,SP70
.
          MATCH     SP70,ADATE                   * No Visit date
          GOTO      CTRN9000 IF EQUAL
.
          CALL      CVAD0000                     * Validate transfer source
          BRANCH    EXIT,CTRN9100
.
CTRN9000  MOVE      ZERO,EXIT
          GOTO      CTRN9999
.
CTRN9100  MOVE      ONE,EXIT
.
CTRN9999  RETURN
+
.-----------------------------------------------------------------------------
. VDOC0000 - Check doctors active dates
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.-----------------------------------------------------------------------------
.
VDOC0000  MATCH     SP70,ADOCTR             * Referring
          GOTO      VDOC1000 IF EQUAL
.
          PACK      CHCKDOCT,ADOCTR,SP70
          PACK      CHCKDATE,ADATE,SP70
          MOVE      TWO,CHCKTYPE
.
          CALL      ACTDOC00
          BRANCH    EXIT,VDOC9100
.
VDOC1000  MATCH     SP70,ADOCTA             * Attending
          GOTO      VDOC2000 IF EQUAL
.
          PACK      CHCKDOCT,ADOCTA,SP70
          PACK      CHCKDATE,ADATE,SP70
          MOVE      ONE,CHCKTYPE
.
          CALL      ACTDOC00
          BRANCH    EXIT,VDOC9100
.
VDOC2000  MATCH     SP70,ADOCTT             * Treating
          GOTO      VDOC9000 IF EQUAL
.
          PACK      CHCKDOCT,ADOCTT,SP70
          PACK      CHCKDATE,ADATE,SP70
          MOVE      ONE,CHCKTYPE
.
          CALL      ACTDOC00
          BRANCH    EXIT,VDOC9100
.
VDOC9000  MOVE      ZERO,EXIT
          GOTO      VDOC9999
.
VDOC9100  MOVE      ONE,EXIT
.
VDOC9999  RETURN
+
.-----------------------------------------------------------------------------
. VSAD0000 - Checks the Statistical Admission doctor's active dates
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.-----------------------------------------------------------------------------
.
VSAD0000  MATCH     SP70,PTMIS007
          GOTO      VSAD9000 IF EQUAL
.
          PACK      CHCKDATE,PTMIS001,SP70    * Discharge date
          PACK      CHCKDOCT,PTMIS007,SP70    * Admission doctor
          MOVE      ONE,CHCKTYPE
.
          CALL      ACTDOC00
          BRANCH    EXIT,VSAD9100
.
VSAD9000  MOVE      ZERO,EXIT
          GOTO      VSAD9999
.
VSAD9100  MOVE      ONE,EXIT
.
VSAD9999  RETURN
+
.-----------------------------------------------------------------------------
. CWSX0000 - Check ward file intended sex and Report warnings if appropriate
.-----------------------------------------------------------------------------
.
CWSX0000  MATCH     ANSF,PTWDSEX            * Ward/Bed female intended sex
          GOTO      CWSX2000 IF EQUAL
.
          MATCH     ANSM,PTWDSEX            * Ward/Bed male intended sex
          GOTO      CWSX2000 IF EQUAL
.
          GOTO      CWSX9999
.
CWSX2000  MATCH     PSEX,PTWDSEX
          GOTO      CWSX9999 IF EQUAL
.
          CLEAR     WEBTITLE
          APPEND    "Warning: Patient ward/bed intended sex ",WEBTITLE
          APPEND    "mismatch.",WEBTITLE
          APPEND    SP70,WEBTITLE
          RESET     WEBTITLE
          ADD       ONE,WARCOUNT
          MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
.
CWSX9999  RETURN
+
.-----------------------------------------------------------------------------
. CWCL0000 - Check ward file specialty and Report warnings if appropriate
.-----------------------------------------------------------------------------
CWCL0000  MATCH     SP70,WCLASS             * Check for ward classification
          GOTO      CWCL9999 IF EQUAL
.
CWCL2000  PACK      KEY5,ANSC,ANSG,WCLASS,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CWCL9999
.
          MATCH     ANSM,TCINDC1            * (M)edical
          GOTO      CWCL3000 IF EQUAL
.
          MATCH     ANSS,TCINDC1            * (S)urgical
          GOTO      CWCL3000 IF EQUAL
.
          GOTO      CWCL9999                * specialty
.
CWCL3000  MOVE      TCINDC1,WARDTYPE
.
          MATCH     Z70,PTMIS024            * Is there an admission unit
          GOTO      CWCL9999 IF EQUAL
.
          MATCH     SP70,PTMIS024
          GOTO      CWCL9999 IF EQUAL
.
          PACK      KEY5,ANSA,ANSC,PTMIS024,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CWCL9999
.
          MATCH     SP70,TCINDC1            * Check for (S)urgical/(M)edical
          GOTO      CWCL9999 IF EQUAL       * specialty
.
          MATCH     WARDTYPE,TCINDC1
          GOTO      CWCL9999 IF EQUAL
.
          CLEAR     WEBTITLE
          APPEND    "Warning: Patient ward specialty mismatch",WEBTITLE
          APPEND    SP70,WEBTITLE
          RESET     WEBTITLE
          ADD       ONE,WARCOUNT
          MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
.
CWCL9999  RETURN
+
.------------------------------------------------------------
. ACTDOC00 - Validate doctors active dates
.
. CHCKDOCT - Doctors code to validate
. CHKCDATE - Admission date to validate
. CHCKTYPE - Doctors type to validate 1= Attending 2=Referring + Attending
. Returns:  EXIT   0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
.
ACTDOC00  MATCH     SP70,CHCKDOCT           * No doctors code so exit
          GOTO      ACTDOC90 IF EQUAL
.
          PACK      KEY6,CHCKDOCT,SP70
          CALL      RDDOCT1
          BRANCH    OVRCD,ACTDOC93
.
          IF         CHCKTYPE=1
            COMPARE   TWO,DRSTAT              * Active Outside
            GOTO      ACTDOC92 IF EQUAL
          ENDIF
.
          IF        IBCNMHOS=1
            MATCH    "1",PTDOHOSS
            IF       @EQUAL
              PACK     KEY13,WBSEHOSP,DCODE,SP70
              CALL     RDMLHCP1               * use mlthcp dates if they exist
              IF        OVRCD=0
                MATCH     SP70,MLHCSDAT
                IF        !@EQUAL
                  MOVE      MLHCSDAT,PTDOSDAT    * start date
                ENDIF
                MATCH     SP70,MLHCEDAT
                IF        !@EQUAL
                  MOVE      MLHCEDAT,PTDOEDAT    * end date
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     "030",TEMPLATE
          IF        !@EQUAL
.
            MATCH     PTDOSDAT,CHCKDATE       * Doctors start date
            GOTO      ACTDOC91 IF LESS
.
            MATCH     SP70,PTDOEDAT           * Still active if no end date
            GOTO      ACTDOC90 IF EQUAL
.
            MATCH     PTDOEDAT,CHCKDATE       * Doctors end date
            GOTO      ACTDOC91 IF NOT LESS
.
          ENDIF
.
ACTDOC90  MOVE      ZERO,EXIT               * Valid doctor code
          GOTO      ACTDOC99
.
ACTDOC91  CLEAR     WEBTITLE
          APPEND    "This doctor was inactive at this admission ",WEBTITLE
          APPEND    "date - ",WEBTITLE
          APPEND    KEY6,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ACTDOC99
.
ACTDOC92  CLEAR     WEBTITLE
          APPEND    "This doctor was active outside (Referring) at ",WEBTITLE
          APPEND    "this admission date - ",WEBTITLE
          APPEND    KEY6,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ACTDOC99
.
ACTDOC93  CLEAR     WEBTITLE
          APPEND    "Invalid doctor code - ",WEBTITLE
          APPEND    KEY6,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ACTDOC99
.
ACTDOC99  RETURN
+
.******************************************************************************
.*                                  RJUS0000              Called by: GDAT0000 *
.*                            Right Justify The Code                          *
.******************************************************************************
RJUS0000  PACK      RJUSCODE,SP70,SP70
          RESET     LJUSCODE,JUSTNO
          MOVE      ZERO,CHRCOUNT
RJUS1000  CMATCH    SP1,LJUSCODE
          GOTO      RJUS2000 IF NOT EQUAL
.
          ADD       ONE,CHRCOUNT
          BUMP      LJUSCODE,-1
          GOTO      RJUS2000 IF EOS
.
          COMPARE   JUSTNO,CHRCOUNT
          GOTO      RJUS1000 IF LESS
.
RJUS2000  RESET     LJUSCODE
          CLEAR     RJUSCODE
          RESET     RJUSCODE,CHRCOUNT
          APPEND    LJUSCODE,RJUSCODE
          RESET     RJUSCODE
.
RJUS9000  MOVE      ZERO,EXIT
RJUS9999  RETURN
+
.******************************************************************************
.         Check if casemix fees setup
.******************************************************************************
CMXF0000  MOVE      ONE,EXIT
          MOVE      ZERO,CPAYMFLG
          COMPARE   ONE,CFINAN
          GOTO      CMXF9999 IF NOT EQUAL
          MOVE      "9999",BDAY        * Assume it's an overnight patient
          PACK      CMDRG,PTMIPCMX,SP20   * Set casemix code
.
.         Check if this hfund using matrix
.
          PACK      KEY14,AFUNDH,ZERO8
          CALL      RDFUND1
          IF        OVRCD=0
            IF        PTHFUCMX=1
              MOVE      ANSY,PTMICMXP  * set this patient to use casemix
            ENDIF
          ENDIF
          MATCH     ANSY,PTMICMXP
          GOTO      CMXF8000 IF NOT EQUAL  * not a casemix
          MATCH     SP10,PTMIPCMX
          GOTO      CMXF8000 IF EQUAL
.
          PACK      KEY9,ACLAIM,AFUNDH
          CALL      GETCNEFF               * Get Contract Effective From
          BRANCH    EXIT,CMXF8000
.
          PACK      PTMIPCMX,CMCODE,SP70
          PACK      KEY18,ACLAIM,AFUNDH,CMCODE,SP70
          MOVE      ADATE,CEFFDATE
          LOAD      CEFFDATE,CNTRCEFR,ADATE,DDATE
          CALL      VALCMXFN              * get the contract ID (CONTRCID)
          IF        PTCNCMXF=1
            BRANCH    EXIT,CMXF8000
          ENDIF
.
          MOVE      ONE,ADMFLAG        * Set one to admission flag
          MOVE      ONE,MSGFLAG        * not display error message
          PROC      PATGNCMX           * to generate casemix funding
          BRANCH    NOFEE,CMXF8000     * Use normal charges
          MOVE      ZERO,EXIT          * Use casemix fees
          GOTO      CMXF9999
.
CMXF8000  MOVE      ONE,EXIT           * Use normal bed fees
CMXF9999  RETURN
+
.******************************************************************************
.*                           UPRES000                    Called by : UPMAD000 *
.*            Update/write residency details                                  *
.******************************************************************************
.
UPRES000  PACK      KEY8,URNUMBER,SP70
.
          CALL      RDPMRES1
          BRANCH    OVRCD,UPRES100
.
          PACK      PMRSURNO,URNUMBER,SP70
          CALL      MVPMSRES
.
          PACK      PMRSUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMRSUDAT
          CLOCK     TIME,PMRSUTIM
          MOVE      USERID,PMRSUUID
          CALL      UPPMRES1
          GOTO      UPRES999
.
UPRES100  CALL      CLPMSRES
          PACK      PMRSURNO,URNUMBER,SP70
          CALL      MVPMSRES
          PACK      PMRSCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMRSCDAT
          CLOCK     TIME,PMRSCTIM
          MOVE      USERID,PMRSCUID
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RAPMRES1
          IF        OVRCD=1
            CALL      WRPMRES1
          ENDIF
.
UPRES999  RETURN
+
.******************************************************************************
.         Update PRFA for resident if neccesary
.******************************************************************************
UPRFA000  MATCH     SP70,ADMISSNO
          GOTO      UPRFA999 IF EQUAL
.
          PACK      KEY8,ADMISSNO,SP10
          CALL      RDRESP1
          MOVE      OVRCD,RESPFLAG
          IF        OVRCD=1
            CALL      CLPATRE1         * Clear PRFA variables
          ENDIF
.
.         Overseas Student or Overseas Visitor
.         Try Local and Overseas/patient Address
.
          CALL      CPRT0000           * Check 'Parent of Option
          MOVE      "7",KEY1           * Local Address
          CALL      DADR0000
          BRANCH    EXIT,UPRFA200      * default to patient details
.
          PACK      KEY5,ANSC,ANSL,ACLAIM
          CALL      RDCODE1
          IF        OVRCD=0
            MATCH     "E",TCINDC1
            GOTO      UPRFA100 IF EQUAL
          ENDIF
.
          MATCH     "1",PMRSSBIL       * Send bill to Local address
          GOTO      UPRFA200 IF NOT EQUAL
.
UPRFA100  MOVE      PMCEADD1,PKADD1
          MOVE      PMCEADD2,PKADD2
          MOVE      PMCEADD3,PKSUBR
          MOVE      PMCEADD4,PKADD4
          MOVE      PMCEPOST,PKPOST
          MOVE      PMCETELB,PKTELEB
          MOVE      PMCETELP,PKTELEP
          MOVE      PMCETELM,PTREMOBL
          MOVE      ADMISSNO,PKADMN       * CAR 275366
          MOVE      PGNAME,PTREGNAM
          MOVE      PTMASNAM,PTRESNAM
          GOTO      UPRFA800
.
UPRFA200  PACK      PKADD1,PADD1,SP30,SP20
          PACK      PKADD2,PADD2,SP30,SP20
          PACK      PKSUBR,PSUBRB,SP20,SP30
          PACK      PKADD4,PADD4,SP30,SP10
          PACK      PKPOST,PPOST,SP10,SP20
          PACK      PKTELEP,PTELEP,SP20
          PACK      PKTELEB,PTELEB,SP20
          PACK      PTREMOBL,PTMXCELL,SP20
          MOVE      ADMISSNO,PKADMN       * CAR 275366
          MOVE      PGNAME,PTREGNAM
          MOVE      PTMASNAM,PTRESNAM
.
UPRFA800  IF        RESPFLAG=1
            PACK      KEY8,PKADMN,SP70
            CALL      WRRESP1
          ELSE
            CALL      UPRESP1
          ENDIF
          MOVE       ZERO,EXIT
.
UPRFA999  RETURN
+
.******************************************************************************
.*                           CHKRES00                                         *
.*            Check if expiry warning is required                             *
.******************************************************************************
.
CHKRES00  MOVE      ZERO,EXIT
          CALL      IBACLOCK
          PACK      TODAY,CCC,CYY,CMM,CDD
          REP       " 0",TODAY
          MATCH     SP70,PTYPE
          GOTO      CHKRES99 IF EQUAL
.
          PACK      KEY5,ANST,SP1,PTYPE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CHKRES99
.
          MATCH     ANST,TCINDC3
          GOTO      CHKRES10 IF EQUAL
.
          MATCH     ANSV,TCINDC3
          GOTO      CHKRES99 IF NOT EQUAL
.
CHKRES10  PACK      KEY8,URNUMBER,SP70
          CALL      RDPMRES1
          BRANCH    OVRCD,CHKRES99
.
          MATCH     TODAY,PMRSTEXP
          IF        @LESS
             MOVE     TWO,EXIT
             GOTO     CHKRES99
          ENDIF
.
          MOVE      PMRSTEXP,EXPDATE
          SUB       TCFORM6,EXPDATE
.
          MATCH     TODAY,EXPDATE
          IF        @LESS
             MOVE     ONE,EXIT
          ENDIF
.
CHKRES99  RETURN
.******************************************************************************
.*  Write attending doctor to care team table as admitting doctor             *
.******************************************************************************
WCARE000  OPEN      ALLPCTA1,"allpctaf"
          MOVE      PURNO,ALPCURNO
          MOVE      " 1",ALPCTYPE
          MOVE      ADOCTA,ALPCCODE
          MOVE      SP70,ALPCSITE
.
          PACK      KEY26,ALPCURNO,ALPCTYPE,ALPCCODE,ALPCSITE,SP70
          CALL      RDALPCT1
          IF        OVRCD=1
            MOVE      ONE,ALPCADFL
            PACK      ALPCCDAT,CCC,CYY,CMM,CDD
            REP       " 0",ALPCCDAT
            CLOCK     TIME,ALPCCTIM
            MOVE      USERID,ALPCCUID
            MOVE      SP70,ALPCSPAR
.
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            CALL      WRALPCT1
            TRAPCLR   IO
          ENDIF
.
WCARE999  CLOSE     ALLPCTA1
          RETURN
+
.*****************************************************************************
.*                              TACC0000           Called by: UPCLMD00       *
.*        Trigger a broadcast message where an ACC record has changed.       *
.*        Read all the relevant visit records for the visit type, so that    *
.*        the holding table data will be populated with the relevant visit   *
.*        data when sending the broadcast message.                           *
.*        message.                                                           *
.* Requires: MESSFLAG - message flag                                         *
.*                0 = standard visit on patvisaf                             *
.*                1 = O/P booking with no patvisaf record                    *
.*                2 = error getting data, so don't send message as data      *
.*                    may be from another visit/patient.                     *
.*           valid read on patvisaf record (where MESSFLAG = 0)              *
.*           valid read on outbokaf record (where MESSFLAG = 1)              *
.*****************************************************************************
.
TACC0000  BRANCH    MESSFLAG,TACC2500:           * O/P Booking
                             TACC9999            * error - don't send
.
          BRANCH    PVITYPE,TACC1000:            * Emergency
                            TACC2000:            * Outpatient
                            TACC3000:            * Inpatient
                            TACC9999:            * Ignore
                            TACC9999:            * Ignore
                            TACC9999:            * Ignore
                            TACC9999:            * Ignore
                            TACC9999:            * Ignore
                            TACC9000             * Referral
.
          GOTO      TACC9999                     * visit type not relevant
.
.         Emergency visit
.
TACC1000  MOVE      ADMISSNO,KEY8
          CALL      RDEMVIS1                     * Emergency visit record found?
          BRANCH    OVRCD,TACC9999               * no
.
          COMPARE   FOUR,EMVISTAT
          GOTO      TACC9999 IF EQUAL
.
          MOVE      EMVIADMN,KEY8
          CALL      RDPMVX11
          BRANCH    OVRCD,TACC9999
.
.         Set up the message for sending
.
          CALL      PMIGTNID                   * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TEN7,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICEC                     * send update visit details
.
          GOTO      TACC9999                     * finished
.
.         Outpatient visit
.
TACC2000  PACK      KEY36,ADMISSNO,SP20,SP20
          CALL      RDSBOKA6                     * position on visit number
          CALL      RDKBOKA6                     * read next record
          BRANCH    OVRCD,TACC9999               * eof - finished
.
          MATCH     OBAOUTNO,ADMISSNO            * same visit number ?
          GOTO      TACC9999 IF NOT EQUAL        * no - get next O/P record
.
TACC2500  MOVE      ADMISSNO,KEY8
          CALL      RDBOKB1                      * outbb1af record found ?
          BRANCH    OVRCD,TACC9999               * no
.
.         Set up the message for sending
.
          CALL      PMIGTNID                   * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TEN8,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICOB                     * send update visit details
.
          GOTO      TACC9999
.
.         Inpatient visit
.
TACC3000  MOVE      ADMISSNO,KEY8
          CALL      RDMISS1                      * Admission record found ?
          BRANCH    OVRCD,TACC9999               * no
.
          MOVE      ADMISSNO,KEY8
          CALL      RDPMVX11                     * visit extension found ?
          BRANCH    OVRCD,TACC9999               * no
.
          IF        ASTAT = 3
            MOVE      ADMISSNO,KEY8
            CALL      RDDSCH1                    * discharge record found ?
            BRANCH    OVRCD,TACC9999             * no
          ENDIF
.
.         Get the last transfer record for the admission
.
          PACK      KEY30,ADMISSNO,TILDA30
          CALL      RDSTRAN2                     * position on admission number
          CALL      RDPTRAN2                     * read previous record
          BRANCH    OVRCD,TACC9999               * eof - finished
.
          MATCH     TADMN,ADMISSNO               * same admission still ?
          GOTO      TACC9999 IF NOT EQUAL        * no - finished
.
.         Set up the message for sending
.
          CALL      PMIGTNID                   * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TEN9,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICAC                     * send update visit details
.
          GOTO      TACC9999
.
.         Referral
.
TACC9000  MOVE      ADMISSNO,KEY8
          CALL      RDALREF1                     * Admission record found ?
          BRANCH    OVRCD,TACC9999               * no
          MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,TACC9999
          CALL      RDPMPX21
          BRANCH    OVRCD,TACC9999
.
.         Set up the message for sending
.
          CALL      PMIGTNID                   * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      FORTY,HL7TRGID
          MOVE      SP8,HL7INCLD
          CALL      DGCLII13                     * send update referral details
.
          GOTO      TACC9999
.
TACC9999  RETURN
+
.******************************************************************************
.*  Get NZ Procedure details if required                                      *
.******************************************************************************
GETNZP00  COMPARE   FIVE,CFEETYP            * NZ Private only
          GOTO      GETNZP90 IF NOT EQUAL
.
          PACK      KEY11,ADMISSNO,SP70
          CALL      RSNZSPR1
GETNZP10  CALL      RKNZSPR1
          BRANCH    OVRCD,GETNZP90
.
          MATCH     ADMISSNO,NZSPADMN
          GOTO      GETNZP90 IF NOT EQUAL
.
          COMPARE   "1",NZSPPRIM
          GOTO      GETNZP10 IF NOT EQUAL
.
          MOVE      ADMISSNO,VSCTVIST
          MOVE      "006",VSCTTYPE
          MOVE      NZSPUNIQ,VSCTLINE
          PACK      KEY14,VSCTVIST,VSCTTYPE,VSCTLINE,SP70
          CALL      RDVSCMT1
          IF        OVRCD=1
            PACK      VSCTDATA,SP70,SP70
          ENDIF
.
          GOTO      GETNZP999
.
GETNZP90  CALL      CLNZSP00
          PACK      VSCTDATA,SP70,SP70
.
GETNZP99  RETURN
+
.******************************************************************************
.*  Write NZ Procedure details if required                                    *
.******************************************************************************
WRNZP000  COMPARE   FIVE,CFEETYP            * NZ Private only
          GOTO      WRNZP999 IF NOT EQUAL
.
          CALL      GETTH000
          MOVE      ZERO,F1
          CALL      CLNZSP00
.
          PACK      KEY11,DAADMNO,SP70
          CALL      RSNZSPR1
WRNZP050  CALL      RKNZSPR1
          BRANCH    OVRCD,WRNZP100
.
          MATCH     DAADMNO,NZSPADMN
          GOTO      WRNZP100 IF NOT EQUAL
.
          COMPARE   "1",NZSPPRIM
          GOTO      WRNZP050 IF NOT EQUAL
          GOTO      WRNZP200
.
WRNZP100  MOVE      ONE,F1
          CALL      CLNZSP00
.
WRNZP200  PACK      NZSPADMN,DAADMNO,SP70
          PACK      NZSPCLMN,ACLAIM,SP70
          PACK      NZSPSURG,ADOCTA,SP70
          PACK      NZSPPROC,AMBS,SP70
          MATCH     SP70,NZSPUNIQ
          IF        @EQUAL
            PACK      NZSPUNIQ,SP1,SP1,ONE,SP70
          ENDIF
          PACK      NZSPCNTR,AFUNDH,SP70
          MOVE      "1",NZSPPRIM
          CALL      MVNZSP00
.
          PACK      KEY11,NZSPADMN,NZSPUNIQ,SP70
          CALL      RANZSPR1
          IF        OVRCD<>1
            MATCH     "1",THEATREF      * multiple theatre bookings exist
            IF        !@EQUAL
              MATCH     SP70,OPDAPROV
              IF        !@EQUAL
                PACK      NZSPUNTH,OPDAUNIQ,SP70
              ENDIF
            ENDIF
            CALL      UPNZSPR1
            GOTO      WRNZP800
          ENDIF
.
          MATCH     SP70,OPDAPROV
          IF        !@EQUAL
            PACK      NZSPUNTH,OPDAUNIQ,SP70
          ENDIF
          CALL      IBACLOCK
          PACK      NZSPCDAT,CCC,CYY,CMM,CDD * Date created
          REP       " 0",NZSPCDAT
          MOVE      CTIMEIS,NZSPCTIM         * Time created
          PACK      NZSPCUID,WBSEUID,SP70
.
          MOVE      ZERO,NZSPINVD
          MOVE      ZERO,NZSPFFEE
          MOVE      ZERO,NZSPHPAY
          MOVE      ZERO,NZSPCPAY
          MOVE      ZERO,NZSPFADJ
          MOVE      ZERO,NZSPHADJ
          MOVE      ZERO,NZSPCADJ
          MOVE      SP70,NZSPCONT
.
          MATCH     SP70,OPDAPROV
          IF        !@EQUAL
            PACK      NZSPUNTH,OPDAUNIQ,SP70
          ENDIF
.
          CALL      WRNZSPR1
.
          COMPARE   ONE,F1
          GOTO      WRNZP800 IF NOT EQUAL
.
          MOVE      "0",NZSPPRIM
          CALL      NZDEF000
          MOVE      ACLAIM,NZSPCLMN
          MOVE      AFUNDH,NZSPCNTR
          MOVE      SP70,NZSPCPRC
          MOVE      SP70,NZSPAPRV
.
          MATCH     SP70,OPDAPRV2
          GOTO      WRNZP600 IF EQUAL
.
          MOVE      OPDAPRV2,NZSPPROC
          PACK      NZSPUNTH,OPDAUNIQ,SP70
          PACK      NZSPPDES,OPDADES2,SP70
.
          MATCH     SP70,NZSPPDES
          GOTO      WRNZP500 IF NOT EQUAL
.
          COMPARE   TWO,OPCNCPOD
          GOTO      WRNZP500 IF NOT EQUAL
.
          MATCH     SP70,OPDAPRV2
          GOTO      WRNZP500 IF EQUAL
.
          PACK      KEY17,OPDAPRV2,OPDADATE,SP70
          CALL      PATITMRD
          IF        OVRCD<>1
            PACK      NZSPPDES,IDESC
          ENDIF
.
WRNZP500  MOVE      TWO,F3
          MOVE      F3,NZSPUNIQ
          PACK      NZSPUNTH,OPDAUNIQ,SP70
          PACK      KEY11,NZSPADMN,NZSPUNIQ,SP70
          CALL      RANZSPR1
          IF        OVRCD=1
            CALL      WRNZSPR1
          ENDIF
.
WRNZP600  MATCH     SP70,OPDAPRV3
          GOTO      WRNZP800 IF EQUAL
          MOVE      THREE,F3
          MOVE      OPDAPRV3,NZSPPROC
          PACK      NZSPUNTH,OPDAUNIQ,SP70
          PACK      NZSPPDES,OPDADES3,SP70
.
          MATCH     SP70,NZSPPDES
          GOTO      WRNZP650 IF NOT EQUAL
.
          COMPARE   TWO,OPCNCPOD
          GOTO      WRNZP650 IF NOT EQUAL
.
          MATCH     SP70,OPDAPRV3
          GOTO      WRNZP650 IF EQUAL
.
          PACK      KEY17,OPDAPRV3,OPDADATE,SP70
          CALL      PATITMRD
          IF        OVRCD<>1
            PACK      NZSPPDES,IDESC
          ENDIF
.
WRNZP650  MOVE      F3,NZSPUNIQ
          PACK      KEY11,NZSPADMN,NZSPUNIQ,SP70
          CALL      RANZSPR1
          IF        OVRCD=1
            CALL      WRNZSPR1
          ENDIF
.
WRNZP800  CALL      UPIS0000            * Update Insurer free text
          CALL      UFCN0000            * Update Funder Contribution
.
WRNZP999  RETURN
+
.------------------------------------------------------------
.         Update insurer free text
.------------------------------------------------------------
UPIS0000  PACK      NZSPINSR,NZSPINSR,SP70
.
          MOVE      ADMISSNO,VSCTVIST
          MOVE      "006",VSCTTYPE
          MOVE      NZSPUNIQ,VSCTLINE
          PACK      KEY14,VSCTVIST,VSCTTYPE,VSCTLINE,SP70
.
          MATCH     SP70,NZSPINSR
          GOTO      UPIS6000 IF EQUAL        * Not Insurer for 'Other'
.
          MOVE      "I ",KEY2
          PACK      KEY5,KEY2,NZSPINSR,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,UPIS6000
.
          MATCH     "O",TCINDC1
          GOTO      UPIS6000 IF NOT EQUAL    * Not Other Insurer
.
          MATCH     Z70,ICOMMENT
          GOTO      UPIS9999 IF EQUAL
.
          CALL      RDVSCMT1
          BRANCH    OVRCD,UPIS4000
.
          PACK      VSCTDATA,ICOMMENT,SP70
          CALL      UPVSCMT1
          GOTO      UPIS9999
.
UPIS4000  UNPACK    KEY14,VSCTVIST,VSCTTYPE,VSCTLINE
          PACK      VSCTDATA,ICOMMENT,SP70
          CALL      IBACLOCK
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          PACK      VSCTUKEY,KEY8,CTIMEIS,WBSEUID,SP70
          MOVE      SP70,VSCTSPAR
          CALL      WRVSCMT1
          GOTO      UPIS9999
.
UPIS6000  CALL      DEVSCMT1
UPIS9999  RETURN
+
.------------------------------------------------------------
. NZ Private procedure/funder details
.------------------------------------------------------------
NZPR0000  MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,NZPR9500
          MOVE      ZERO,PRIMTIME
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MATCH     SP70,ADMISSNO
          IF        !@EQUAL
            PACK      KEY8,ADMISSNO,SP70
            CALL      RDMISS1
            BRANCH    OVRCD,NZPR9600
            CALL      RDVISA1
            IF        OVRCD=1
              CALL       CLPV0000
            ENDIF
            CALL      RDPMVX11
            IF        OVRCD=1
              CALL       CLPV0000
            ENDIF
            CALL      GETTH000
          ENDIF
.
          CALL      CLOPRARD
          MATCH     Z70,UNIQUEKY
          IF        !@EQUAL
            PACK      KEY10,UNIQUEKY,SP70
            CALL      RDOPARD1
            IF        OVRCD=1
              CALL      CLOPRARD
            ENDIF
          ENDIF
.
          MATCH     Z70,NZSPR025
          IF        !@EQUAL
            MATCH     SP70,NZSPR025
            IF        !@EQUAL
              PACK      KEY10,NZSPR025,SP70
              CALL      RDOPARD1
              IF        OVRCD=1
                CALL      CLOPRARD
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     SP70,UPDTTYPE      * Display
          GOTO      NZPR8000 IF EQUAL
          MATCH     "A",UPDTTYPE       * Add New
          GOTO      NZPR1000 IF EQUAL
          MATCH     "U",UPDTTYPE       * Update
          GOTO      NZPR2000 IF EQUAL
          MATCH     "D",UPDTTYPE       * Delete
          GOTO      NZPR3000 IF EQUAL
          MATCH     "P",UPDTTYPE       * Set as primary
          GOTO      NZPR4000 IF EQUAL
          MATCH     "S",UPDTTYPE       * Search
          GOTO      NZPR5000 IF EQUAL
          MOVE      "Invalid Update Type",WEBTITLE
          CALL      WEBERR00
          GOTO      NZPR9999
.
NZPR1000  CALL      ADDSPR00
          CALL      EXPPAY00                * write expected payor details
          GOTO      NZPR9999
.
NZPR2000  CALL      UPDSPR00
          BRANCH    EXIT,NZPR9999
          CALL      EXPPAY00                * write expected payor details
          CALL      CHPR0000           * check if a primary record still exists
          GOTO      NZPR9999
.
NZPR3000  CALL      DELSPR00
          CALL      EXPPAY00                * write expected payor details
          GOTO      NZPR9999
.
NZPR4000  CALL      SETSPR00    * set as primary procedure
          CALL      EXPPAY00                * write expected payor details
          GOTO      NZPR9999
.
NZPR5000  CALL      SCHSPR00    * search for procedure
          GOTO      NZPR9999
.
NZPR8000  CALL      CLNZSP00
          MATCH     Z70,NZSPR001
          IF        !@EQUAL
            PACK      KEY11,NZSPR001,NZSPR005,SP70
            CALL      RDNZSPR1
            CALL      CHKTIM00
            PACK      KEY11,NZSPR001,NZSPR005,SP70
            CALL      RDNZSPR1
          ENDIF
.
          CALL      PATNAM00
          CLEAR     WEBTITLE
          APPEND    PATFNAME,WEBTITLE
          APPEND    " - Procedure Details",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00
          BRANCH    EXIT,NZPR9999
          CALL      WEBBOD00
          CALL      WEBEND00
          MOVE      ONE,EXIT
          GOTO      NZPR9999
.
NZPR9500  MOVE      "Invalid Patient",WEBTITLE
          CALL      WINALT00
          GOTO      NZPR9999
.
NZPR9600  MOVE      "Invalid admission number",WEBTITLE
          CALL      WEBERR00
          GOTO      NZPR9999
.
NZPR9999  RETURN
.
SCHSPR00  RETURN
.------------------------------------------------------------
. Get theatre details for nzpspraf
.------------------------------------------------------------
GETTH000  MOVE      ZERO,F1
          MOVE      SP70,THEATREF
          MOVE      SP70,THEATREK
          MATCH     SP70,ADMISSNO
          GOTO      GETTH999 IF EQUAL
.
          CALL      CLOPRDEA
          PACK      KEY31,ADMISSNO,SP70
          CALL      RSOPDEA2
GETTH100  CALL      RKOPDEA2
          BRANCH    OVRCD,GETTH900
.
          MATCH     ADMISSNO,OPDAADMN
          GOTO      GETTH900 IF NOT EQUAL
.
          MATCH     "3",DOPDASTA
          GOTO      GETTH100 IF EQUAL
.
          ADD       ONE,F1
          PACK      THEATREK,OPDAUNIQ,SP70
.
          GOTO      GETTH100
.
GETTH900  IF        F1>1
            MOVE      "1",THEATREF      * multiple theatre bookings exist
          ENDIF
          IF        F1=0
            CALL      CLOPRDEA
          ENDIF
.
          PACK      KEY10,THEATREK,SP70
          CALL      RDOPDEA3
          IF        OVRCD<>1
            GOTO      GETTH999
          ENDIF
.
          PACK      KEY31,ADMISSNO,SP70
          CALL      RSOPDEA2
          CALL      RKOPDEA2
          IF        OVRCD=1
            CALL      CLOPRDEA
            GOTO      GETTH999
          ENDIF
.
          MATCH     ADMISSNO,OPDAADMN
          IF        !@EQUAL
            CALL      CLOPRDEA
          ENDIF
.
GETTH999  RETURN
+
.------------------------------------------------------------
. Add NZ Private procedure/funder details
.------------------------------------------------------------
ADDSPR00  MOVE      ZERO,PRIFOUND
.
          MOVE      ZERO,F3
          PACK      KEY11,NZSPR001,SP70
          CALL      RSNZSPR1
ADDSPR02  CALL      RKNZSPR1
          BRANCH    OVRCD,ADDSPR05
.
          MATCH     NZSPR001,NZSPADMN
          GOTO      ADDSPR05 IF NOT EQUAL
          COMPARE   ONE,NZSPPRIM
          IF        @EQUAL
            COMPARE   TWO,NZSPPIND         * not performed
            IF        @EQUAL
              MOVE      ZERO,NZSPPRIM
              MOVE      ZERO,NZSPTDUR
              CALL      UPNZSPR1
              GOTO      ADDSPR02
            ENDIF
            MOVE      ONE,PRIFOUND
            GOTO      ADDSPR05
          ENDIF
          GOTO      ADDSPR02
.
ADDSPR05  CALL      CLNZSP00
          CALL      CHKTIM00
          BRANCH    EXIT,ADDSPR99
          CALL      CLNZSP00
.
          MOVE      ZERO,F3
          PACK      KEY11,NZSPR001,Z70
          CALL      RSNZSPR1
          CALL      RPNZSPR1
          BRANCH    OVRCD,ADDSPR10
.
          MATCH     NZSPR001,NZSPADMN
          GOTO      ADDSPR10 IF NOT EQUAL
          GOTO      ADDSPR20
.
ADDSPR10  MOVE      ZERO,NZSPUNIQ
.
ADDSPR20  MOVE      NZSPUNIQ,F3
          ADD       ONE,F3
          MOVE      F3,NZSPR005
.
          COMPARE   "1",PRIFOUND
          IF        !@EQUAL
            MATCH     "2",NZSPR008
            GOTO      ADDSPR92 IF EQUAL
            MOVE      ONE,NZSPPRIM
            MOVE      ZERO,NZSPR020
            CALL      CHKTIM00
            MOVE      PRIMTIME,NZSPR020
          ENDIF
.
          CALL      CLNZSP00
          CALL      MVNZSP00      * Moves input variables to file variables
.
          COMPARE   "1",PRIFOUND
          IF        !@EQUAL
            MOVE      ONE,NZSPPRIM
            MOVE      PRIMTIME,NZSPTDUR
          ENDIF
.
          PACK      KEY17,NZSPPROC,SP70
          PACK      KEY10,NZSPUNTH,SP70
          CALL      RDOPDEA3
          IF        OVRCD=0
            PACK      KEY17,NZSPPROC,OPDADATE,SP70
          ENDIF
          CALL      PATITMRD
          IF        OVRCD<>1
            MATCH     SP70,NZSPPDES
            IF        @EQUAL
              PACK      NZSPPDES,IDESC,SP70  * default admission type
            ENDIF
          ENDIF
          CALL      IBACLOCK
.
          MOVE      ZERO,NZSPFFEE
          MOVE      ZERO,NZSPHPAY
          MOVE      ZERO,NZSPCPAY
          MOVE      ZERO,NZSPFADJ
          MOVE      ZERO,NZSPHADJ
          MOVE      ZERO,NZSPCADJ
          MOVE      SP70,NZSPCONT
.
          PACK      KEY8,NZSPADMN,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,ADDSPR40
.
          IF        NZSPPRIM=1
            PACK      ADIAG1,NZSPPDES,SP70
            REP       "' ",ADIAG1
            PACK      ADOCTA,NZSPSURG,SP70
            PACK      AMBS,NZSPPROC,SP70
            PACK      PTMIPCMX,NZSPCPRC,SP70
            PACK      ACLAIM,NZSPCLMN,SP70
            PACK      AFUNDH,NZSPCNTR,SP70
            PACK      PTMIWEBU,WBSEUID,SP70
            CALL      UPMISS1
.
            MOVE      NZSPUNTH,KEY10
            CALL      RDOPDEA3
            IF        OVRCD=0
              MATCH     "1",THEATREF      * multiple theatre bookings exist
              IF        !@EQUAL
                PACK      OPDAPROV,NZSPPROC,SP70
                PACK      OPDADES1,NZSPPDES,SP70
                CALL      UPOPDEA3
              ENDIF
            ENDIF
          ELSE
            IF        NZSPPRIM=2
              PACK      NZSPCLMN,ACLAIM,SP70
              PACK      NZSPCNTR,AFUNDH,SP70
            ENDIF
.
            IF        NZSPPIND=1
              PACK      KEY8,NZSPADMN,SP70
              CALL      RDMISS1
              IF        OVRCD=0
                MATCH     SP70,ADIAG2
                IF        @EQUAL
                  PACK      ADIAG2,NZSPPDES,SP70
                  REP       "' ",ADIAG2
                  PACK      PTMIWEBU,WBSEUID,SP70
                  CALL      UPMISS1
                ENDIF
              ENDIF
.
              MATCH     "1",THEATREF      * multiple theatre bookings exist
              IF        !@EQUAL
                MOVE      NZSPUNTH,KEY10
                CALL      RDOPDEA3
                IF        OVRCD=0
                  MATCH     SP70,OPDAPRV2
                  IF        @EQUAL
                    PACK      OPDAPRV2,NZSPPROC,SP70
                    PACK      OPDADES2,NZSPPDES,SP70
                    CALL      UPOPDEA3
                  ELSE
                    MATCH     SP70,OPDAPRV3
                    IF        @EQUAL
                      PACK      OPDAPRV3,NZSPPROC,SP70
                      PACK      OPDADES3,NZSPPDES,SP70
                      CALL      UPOPDEA3
                    ENDIF
                  ENDIF
                ENDIF
              ENDIF
.
            ENDIF
          ENDIF
.
ADDSPR40  PACK      KEY11,NZSPR001,NZSPR005,Z70
          CALL      RANZSPR1
          IF        OVRCD=1
            PACK      NZSPCDAT,CCC,CYY,CMM,CDD * Date created
            REP       " 0",NZSPCDAT
            MOVE      ZERO,NZSPINVD
            MOVE      CTIMEIS,NZSPCTIM         * Time created
            PACK      NZSPCUID,WBSEUID,SP70
.
            MATCH     SP70,NZSPUNTH
            IF        @EQUAL
              MATCH     Z70,UNIQUEKY
              IF        !@EQUAL
                PACK      NZSPUNTH,UNIQUEKY,SP70
              ENDIF
            ENDIF
            CALL      WRNZSPR1      * Writes away the data
          ENDIF
          CALL      UPIS0000        * Update Insurer free text
.
          COMPARE   ONE,UPPRIM
          GOTO      ADDSPR60 IF NOT EQUAL
.
          PACK      KEY11,NZSPR001,SP70
          CALL      RSNZSPR1
ADDSPR50  CALL      RKNZSPR1
          BRANCH    OVRCD,ADDSPR60
.
          COMPARE   ONE,NZSPPRIM
          GOTO      ADDSPR50 IF NOT EQUAL
.
          MOVE      PRIMTIME,NZSPTDUR
          CALL      UPNZSPR1
.
ADDSPR60  CALL      UFCN0000            * Update Funder Contribution
          MOVE      ZERO,EXIT
          GOTO      ADDSPR99
.
ADDSPR90  MOVE      "No matrix record found",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
ADDSPR92  MOVE      "Error: No Primary Procedure for this admission",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
ADDSPR99  RETURN
+
.------------------------------------------------------------
. Update NZ Private procedure/funder details
.------------------------------------------------------------
UPDSPR00  CALL      CHKTIM00
          BRANCH    EXIT,UPDSPR99
.
          PACK      KEY11,NZSPR001,NZSPR005,SP70
          CALL      RDNZSPR1
          BRANCH    OVRCD,UPDSPR90
          CALL      MVNZSP00      * Moves input variables to file variables
          CALL      IBACLOCK
          PACK      NZSPUDAT,CCC,CYY,CMM,CDD * Date created
          REP       " 0",NZSPUDAT
          MOVE      CTIMEIS,NZSPUTIM         * Time created
          PACK      NZSPUUID,WBSEUID,SP70
          MATCH     SP70,NZSPUNTH
          IF        @EQUAL
            MATCH     Z70,UNIQUEKY
            IF        !@EQUAL
              PACK      NZSPUNTH,UNIQUEKY,SP70
            ENDIF
          ENDIF
.
          IF        NZSPPIND=2
            MOVE      ZERO,NZSPTDUR
            MOVE      ZERO,NZSPPRIM
          ENDIF
          CALL      UPNZSPR1      * Writes away the data
          CALL      UPIS0000      * Update Insurer free text
.
          IF        NZSPPRIM=1
            CALL      PRIP0000    * set primary procedures code
          ELSE
            CALL      CKDE0000    * Update oprdetaf and patmi1af  if necessary
          ENDIF
.
          COMPARE   ONE,UPPRIM
          GOTO      UPDSPR60 IF NOT EQUAL
.
          PACK      KEY11,NZSPR001,SP70
          CALL      RSNZSPR1
UPDSPR50  CALL      RKNZSPR1
          BRANCH    OVRCD,UPDSPR60
.
          MATCH     NZSPR001,NZSPADMN
          GOTO      UPDSPR60 IF NOT EQUAL
.
          COMPARE   ONE,NZSPPRIM
          GOTO      UPDSPR50 IF NOT EQUAL
.
          MOVE      PRIMTIME,NZSPTDUR
          CALL      UPNZSPR1
.
UPDSPR60  CALL      UFCN0000            * Update Funder Contribution
          MOVE      ZERO,EXIT
          GOTO      UPDSPR99
.
UPDSPR90  MOVE      "Record does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
UPDSPR99  RETURN
+
.------------------------------------------------------------
.         Update oprdetaf after procedure being unperformed
.------------------------------------------------------------
CKDE0000  COMPARE   TWO,NZSPPIND
          GOTO      CKDE9999 IF NOT EQUAL
.
          MATCH     "1",THEATREF      * multiple theatre bookings exist
          GOTO      CKDE9999 IF EQUAL
.
.         Blank out OPDAPRV and OPDADES for the Unperformed procedure
.
          MOVE      NZSPUNTH,KEY10
          CALL      RDOPDEA3
          BRANCH    OVRCD,CKDE9999
.
          MATCH     NZSPPROC,OPDAPRV2
          IF        @EQUAL
            PACK      OPDAPRV2,SP70,SP70
            MATCH     SP70,OPDAPRV3
            IF        !@EQUAL
              PACK      OPDAPRV2,OPDAPRV3,SP70
              MOVE      SP70,OPDAPRV3
            ENDIF
          ELSE
            MATCH     NZSPPROC,OPDAPRV3
            IF        @EQUAL
              PACK      OPDAPRV3,SP70,SP70
            ENDIF
          ENDIF
.
          MATCH     NZSPPDES,OPDADES2
          IF        @EQUAL
            PACK      OPDADES2,SP70,SP70
            MATCH     SP70,OPDADES3
            IF        !@EQUAL
              PACK      OPDADES2,OPDADES3,SP70
              MOVE      SP70,OPDADES3
            ENDIF
          ELSE
            MATCH     NZSPPDES,OPDADES3
            IF        @EQUAL
              PACK      OPDADES3,SP70,SP70
            ENDIF
          ENDIF
          CALL      UPOPDEA3
CKDE9999  RETURN
+
.------------------------------------------------------------
.         Set next perform/plan procedure to Primary Procedure
.------------------------------------------------------------
SPRM0000  PACK      KEY8,NZSPADMN,SP70
          CALL      RDMISS1
          IF        OVRCD=0
            PACK      ACLAIM,NZSPCLMN,SP70
            PACK      ADIAG1,NZSPPDES,SP70
            REP       "' ",ADIAG1
            MATCH     ADIAG1,ADIAG2
            IF        @EQUAL
              PACK      ADIAG2,SP70,SP70     * clear it if same diagnosis
            ENDIF
            PACK      ADOCTA,NZSPSURG,SP70
            PACK      AMBS,NZSPPROC,SP70
            PACK      AFUNDH,NZSPCNTR,SP70
            PACK      PTMIPCMX,NZSPCPRC,SP70
            PACK      PTMIWEBU,WBSEUID,SP70
            CALL      UPMISS1
.
          ENDIF
.
          MOVE      NZSPUNTH,KEY10
          CALL      RDOPDEA3
          IF        OVRCD=0
            PACK      OPDAPROV,NZSPPROC,SP70
            MATCH     OPDAPROV,OPDAPRV2
            IF        @EQUAL
              PACK      OPDAPRV2,SP70,SP70     * clear it if same diagnosis
            ELSE
              MATCH     OPDAPROV,OPDAPRV3
              IF        @EQUAL
                PACK      OPDAPRV3,SP70,SP70     * clear it if same diagnosis
              ENDIF
            ENDIF
            PACK      OPDADES1,NZSPPDES,SP70
            MATCH     OPDADES1,OPDADES2
            IF        @EQUAL
              PACK      OPDADES2,SP70,SP70     * clear it if same diagnosis
            ELSE
              MATCH     OPDADES1,OPDADES3
              IF        @EQUAL
                PACK      OPDADES3,SP70,SP70     * clear it if same diagnosis
              ENDIF
            ENDIF
            CALL      UPOPDEA3
          ENDIF
.
SPRM9999  RETURN
+
.------------------------------------------------------------
.         Update Primary Procedure
.------------------------------------------------------------
PRIP0000  PACK      KEY8,NZSPADMN,SP70
          CALL      RDMISS1
          IF        OVRCD=0
            PACK      ACLAIM,NZSPCLMN,SP70
            PACK      ADIAG1,NZSPPDES,SP70
            REP       "' ",ADIAG1
            PACK      ADOCTA,NZSPSURG,SP70
            PACK      AMBS,NZSPPROC,SP70
            PACK      AFUNDH,NZSPCNTR,SP70
            PACK      PTMIPCMX,NZSPCPRC,SP70
            PACK      PTMIWEBU,WBSEUID,SP70
            CALL      UPMISS1
          ENDIF
.
          MATCH     "U",UPDTTYPE       * Update
          GOTO      PRIP9999 IF EQUAL
.
          PACK      KEY8,NZSPADMN,SP70
          CALL      RDBKRX11
          IF        OVRCD=0
            PACK      BKRXUFF1,NZSPPDES,SP70
            CALL      UPBKRX11
          ENDIF
.
          MOVE      NZSPUNTH,KEY10
          CALL      RDOPDEA3
          IF        OVRCD=0
            PACK      OPDAPROV,NZSPPROC,SP70
            PACK      OPDADES1,NZSPPDES,SP70
            CALL      UPOPDEA3
.
            PACK      KEY18,OPDAADMN,OPDAUNIQ,SP70
            CALL      RDBKDIA1
            IF        OVRCD=0
              PACK      BKDICODE,NZSPPROC,SP70
              PACK      BKDIDES1,NZSPPDES,SP70
              CALL      UPBKDIA1
            ENDIF
          ENDIF
.
PRIP9999  RETURN
+
.------------------------------------------------------------
.         Check for Primary/Plan/Perform Procedure
.------------------------------------------------------------
CPROC000  MOVE      ONE,EXIT
          PACK      KEY11,NZSPR001,SP70
          CALL      RSNZSPR1
CPROC100  CALL      RKNZSPR1
          BRANCH    OVRCD,CPROC999
.
          MATCH     NZSPR001,NZSPADMN
          GOTO      CPROC999 IF NOT EQUAL
.
          PACK      UNIQUEKY,UNIQUEKY,SP70
          MATCH     NZSPUNTH,UNIQUEKY
          GOTO      CPROC100 IF NOT EQUAL
.
          COMPARE   ONE,NZSPPRIM              * check for primary
          GOTO      CPROC900 IF EQUAL
.
          BRANCH    NZSPPIND,CPROC900,CPROC100
.
CPROC900  MOVE      ZERO,EXIT                 * found planned/performed/primary
CPROC999  RETURN
+
.------------------------------------------------------------
.         Update Secondary Procedure
.------------------------------------------------------------
SECP0000  MATCH     NZSPUNTH,UNIQUEKY
          GOTO      SECP9999 IF NOT EQUAL
.
          COMPARE   TWO,NZSPPIND
          GOTO      SECP9999 IF EQUAL         * Not performed
.
          PACK      KEY8,NZSPADMN,SP70
          CALL      RDMISS1
          IF        OVRCD=0
            PACK      ADIAG2,NZSPPDES,SP70
            REP       "' ",ADIAG2
            PACK      PTMIWEBU,WBSEUID,SP70
            CALL      UPMISS1
          ENDIF
.
          MATCH     "U",UPDTTYPE       * Update
          GOTO      SECP9999 IF EQUAL
.
.         PACK      KEY8,NZSPADMN,SP70
.         CALL      RDBKRX11
.         IF        OVRCD=0
.           PACK      BKRXUFF2,NZSPPDES,SP70
.           CALL      UPBKRX11
.         ENDIF
.
          MOVE      NZSPUNTH,KEY10
          CALL      RDOPDEA3
          IF        OVRCD=0
            PACK      OPDAPRV2,NZSPPROC,SP70
            PACK      OPDADES2,NZSPPDES,SP70
.
            MATCH     OPDAPROV,OPDAPRV2
            IF        @EQUAL
              PACK      OPDAPRV2,SP70,SP70     * clear it if same diagnosis
            ENDIF
            MATCH     OPDADES1,OPDADES2
            IF        @EQUAL
              PACK      OPDADES2,SP70,SP70     * clear it if same diagnosis
            ENDIF
.
            MATCH     OPDAPRV2,OPDAPRV3
            IF        @EQUAL
              PACK      OPDAPRV3,SP70,SP70     * clear it if same diagnosis
            ENDIF
            MATCH     OPDADES2,OPDADES3
            IF        @EQUAL
              PACK      OPDADES3,SP70,SP70     * clear it if same diagnosis
            ENDIF
            CALL      UPOPDEA3
.
.           PACK      KEY18,OPDAADMN,OPDAUNIQ,SP70
.           CALL      RDBKDIA1
.           IF        OVRCD=0
.             PACK      BKDIDES2,NZSPPDES,SP70
.             CALL      UPBKDIA1
.           ENDIF
          ENDIF
.
SECP9999  RETURN
+
.------------------------------------------------------------
. Check if a primary record still exists
.------------------------------------------------------------
CHPR0000  MOVE      ZERO,PRIFOUND
          CALL      CPROC000         * Check for Primary/Plan/Performed proc.
.T0881450 BRANCH    EXIT,CHPR0820    * No Primary/Plan/Performed procedure found
          BRANCH    EXIT,CHPR0900    * T0881450
.
          MOVE      ZERO,F1
          PACK      KEY11,NZSPR001,SP70
          CALL      RSNZSPR1
CHPR0100  CALL      RKNZSPR1
          BRANCH    OVRCD,CHPR0200
.
          MATCH     NZSPR001,NZSPADMN
          GOTO      CHPR0200 IF NOT EQUAL
.
          COMPARE   ONE,NZSPPRIM              * primary exists
          GOTO      CHPR0120 IF EQUAL
.
          MOVE      ONE,F1
          CALL      SECP0000                  * set secondary procedures code
          CALL      NPPR0000                  * check for Not Performed proc.
          GOTO      CHPR0100
.
CHPR0120  BRANCH    F1,CHPR9999
.
.         Next record must be a secondary procedure
.
          CALL      RKNZSPR1
          BRANCH    OVRCD,CHPR9999
.
          MATCH     NZSPR001,NZSPADMN
          GOTO      CHPR9999 IF NOT EQUAL
.
          CALL      SECP0000                  * set secondary procedures code
          CALL      NPPR0000                  * check for Not Performed proc.
.
.         Check for any other Not-Performed procedures
.
CHPR0140  CALL      RKNZSPR1
          BRANCH    OVRCD,CHPR9999
          MATCH     NZSPR001,NZSPADMN
          GOTO      CHPR9999 IF NOT EQUAL
.
          CALL      NPPR0000                  * check for Not Performed proc.
.
          IF        NZSPPIND=1
            MATCH     SP70,ADIAG2
            IF        @EQUAL
              PACK      KEY8,NZSPADMN,SP70
              CALL      RDMISS1
              IF        OVRCD=0
                PACK      ADIAG2,NZSPPDES,SP70
                REP       "' ",ADIAG2
                PACK      PTMIWEBU,WBSEUID,SP70
                CALL      UPMISS1
              ENDIF
            ENDIF
          ENDIF
.
          GOTO      CHPR0140
.
. **** no primary record exists - find a new one ***
. **** find first performed procedure if there is one****
CHPR0200  PACK      KEY11,NZSPR001,SP70
          CALL      RSNZSPR1
CHPR0250  CALL      RKNZSPR1
          BRANCH    OVRCD,CHPR0300
.
          MATCH     NZSPR001,NZSPADMN
          GOTO      CHPR0300 IF NOT EQUAL
.
          COMPARE   ONE,NZSPPIND               * is it performed?
          GOTO      CHPR0250 IF NOT EQUAL
.
          MOVE      ONE,NZSPPRIM
          CALL      UPNZSPR1
          PACK      SAVKEY11,NZSPADMN,NZSPUNIQ,SP70
          GOTO      CHPR0800
.
. **** find first planned procedure if there is one****
CHPR0300  PACK      KEY11,NZSPR001,SP70
          CALL      RSNZSPR1
CHPR0350  CALL      RKNZSPR1
          BRANCH    OVRCD,CHPR0900
.
          MATCH     NZSPR001,NZSPADMN
          GOTO      CHPR0900 IF NOT EQUAL
.
          COMPARE   ZERO,NZSPPIND               * is it planned?
          GOTO      CHPR0350 IF NOT EQUAL
.
          MOVE      ONE,NZSPPRIM
          CALL      UPNZSPR1
          PACK      SAVKEY11,NZSPADMN,NZSPUNIQ,SP70
          GOTO      CHPR0800
.
CHPR0800  MOVE      ZERO,NZSPR020
          CALL      CHKTIM00
          PACK      KEY11,SAVKEY11
          CALL      RDNZSPR1
          BRANCH    OVRCD,CHPR9999
          MOVE      PRIMTIME,NZSPTDUR
          CALL      UPNZSPR1
.
.         CALL      PRIP0000                  * set primary procedures code
.
.         Setup the primary procedure to oprdetaf and patmi1af
.
          CALL      SPRM0000                  * set primary procedures code
          GOTO      CHPR0900
.
.--------*T0881450-Start------------------------------------------------------
.--------Commented out the following lines in label CHPR0820 as they were
.--------updating the wrong visit number after calling routine CPROC000 when
.--------No Primary/Plan/Performed procedure is found
.CHPR0820  PACK      ADIAG1,SP70,SP70
.          PACK      ADIAG2,SP70,SP70
.          CALL      UPMISS1
..
.          MOVE      NZSPUNTH,KEY10
.          CALL      RDOPDEA3
.          IF        OVRCD=0
.            PACK      OPDAPROV,SP70,SP70
.            PACK      OPDADES1,SP70,SP70
.            MATCH     SP70,OPDAPRV2
.            IF        @EQUAL
.              PACK      OPDADES2,SP70,SP70
.            ENDIF
.            MATCH     SP70,OPDAPRV3
.            IF        @EQUAL
.              PACK      OPDADES3,SP70,SP70
.            ENDIF
.            CALL      UPOPDEA3
.          ENDIF
.--------*T0881450-End--------------------------------------------------------
.
CHPR0900  MOVE      ZERO,EXIT
.
CHPR9999  RETURN
.
.------------------------------------------------------------------
.         Check admission diagnosis for the Not-Performed procedure
.------------------------------------------------------------------
NPPR0000  MATCH     NZSPUNTH,UNIQUEKY
          GOTO      NPPR9999 IF NOT EQUAL
.
          COMPARE   TWO,NZSPPIND            * check for Not-Performed procedure
          GOTO      NPPR9999 IF NOT EQUAL
.
          PACK      KEY8,NZSPADMN,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,NPPR9999
.
          MATCH     ADIAG2,NZSPPDES
          GOTO      NPPR9999 IF NOT EQUAL
.
          PACK      ADIAG2,SP70,SP70
          PACK      PTMIWEBU,WBSEUID,SP70
          CALL      UPMISS1
.
NPPR9999  RETURN
+
.------------------------------------------------------------
. Check existing theatre times
.------------------------------------------------------------
CHKTIM00  MOVE      ZERO,FORM5
          MOVE      ZERO,CALCTIME
          MOVE      NZSPR020,FORM5
          MOVE      ZERO,PRIMTIME
          MOVE      ZERO,F1
          MOVE      UNIQUEKY,SAVUNQUE
          MOVE      ZERO,UPPRIM
          MATCH     Z70,NZSPR025
          GOTO      CHKTIM05 IF EQUAL
.
          MATCH     SP70,NZSPR025
          GOTO      CHKTIM05 IF EQUAL
.
          PACK      UNIQUEKY,NZSPR025
.
CHKTIM05  MATCH     Z70,UNIQUEKY
          GOTO      CHKTIM99 IF EQUAL
.
          PACK      KEY11,NZSPR001,NZSPR005,SP70
          CALL      RDNZSPR1
          BRANCH    OVRCD,CHKTIM10
          COMPARE   ONE,NZSPPRIM      * dont include primary as this will change
          IF        @EQUAL
            MOVE      ZERO,FORM5
          ENDIF
.
CHKTIM10  MATCH     "1",THEADURA
          GOTO      CHKTIM99 IF EQUAL * No checking for theatre duration
.
          PACK      KEY10,UNIQUEKY,SP70
          CALL      RDOPARD1
          BRANCH    OVRCD,CHKTIM92
.
          PACK      KEY10,UNIQUEKY,SP70
          CALL      RDOPDEA3
          BRANCH    OVRCD,CHKTIM92
.
. check if session went overnight
.
          PACK      KEY11,UNIQUEKY,SP70
          CALL      RSOPSRG1
          CALL      RKOPSRG1
          BRANCH    OVRCD,CHKTIM20
          MATCH     UNIQUEKY,OPSGUNID
          GOTO      CHKTIM20 IF NOT EQUAL
.
...       MATCH     "1",OPSGUY02
...       IF        @EQUAL
...         MOVE      ONE,F1
...       ENDIF
          MOVE      ZERO,F1
          MATCH     FIRSTIME,LASTTIME
          IF        @LESS
            MOVE      ONE,F1
          ENDIF
.
CHKTIM20  PACK      FIRSTDAT,OPDADATE,SP70
          MOVE      OPARANAP,DIM5
          REP       ": ",DIM5
          SQUEEZE   DIM5
          PACK      FIRSTIME,DIM5,SP70
.
          MATCH     SP70,OPARTIRD
          GOTO      CHKTIM40 IF EQUAL        * Blank 'Time in recovery'
.
          PACK      LASTDATE,OPDADATE,SP70
          MOVE      OPARTIRD,DIM5
          REP       ": ",DIM5
          SQUEEZE   DIM5
          PACK      LASTTIME,DIM5,SP70
          IF        F1=1
            MOVE      OPDADATE,DATECALC
            ADD       ONE,DATECALC
            MOVE      DATECALC,LASTDATE
          ENDIF
          CALL      TIMEDIFF
.
CHKTIM40  PACK      KEY11,NZSPR001,SP70
          CALL      RSNZSPR1
CHKTIM50  CALL      RKNZSPR1
          BRANCH    OVRCD,CHKTIM80
.
          MATCH     NZSPR001,NZSPADMN
          GOTO      CHKTIM80 IF NOT EQUAL
.
          MATCH     NZSPR005,NZSPUNIQ
          GOTO      CHKTIM50 IF EQUAL
.
          MATCH     UNIQUEKY,NZSPUNTH
          GOTO      CHKTIM50 IF NOT EQUAL
.
          COMPARE   ONE,NZSPPRIM      * dont include primary as this will change
          IF        @EQUAL
            MOVE      ONE,UPPRIM
            GOTO      CHKTIM50
          ENDIF
.
          ADD       NZSPTDUR,FORM5    * add all durations for this uniqueky
          GOTO      CHKTIM50
.
CHKTIM80  COMPARE   FORM5,CALCTIME
          GOTO      CHKTIM99 IF EQUAL
          GOTO      CHKTIM90 IF LESS
          ASSIGN    (CALCTIME-FORM5),PRIMTIME
          GOTO      CHKTIM99
.
CHKTIM90  CLEAR     WEBTITLE
          APPEND    "Duration invalid, sum of procedures ",WEBTITLE
          APPEND    "will be greater \nthan total duration.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKTIM99
.
CHKTIM91  MOVE      "Missing theatre key",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKTIM99
.
CHKTIM92  MOVE      "Missing theatre details",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKTIM99
.
CHKTIM99  MOVE      UNIQUEKY,SAVUNQUE
          RETURN
+
.------------------------------------------------------------
. Delete NZ Private procedure/funder details
.------------------------------------------------------------
DELSPR00  PACK      KEY11,NZSPR001,NZSPR005,Z70
          CALL      RDNZSPR1
          BRANCH    OVRCD,DELSPR90
          CALL      DENZSPR1      * Writes away the data
          MOVE      SP70,NZSPINSR
          CALL      UPIS0000      * Delete Insurer free text
.
          MOVE      ZERO,NZSPR005
          MOVE      ZERO,NZSPR020
          CALL      CHKTIM00
          BRANCH    EXIT,DELSPR99
.
          COMPARE   ONE,UPPRIM
          GOTO      DELSPR60 IF NOT EQUAL
.
          PACK      KEY11,NZSPR001,SP70
          CALL      RSNZSPR1
DELSPR50  CALL      RKNZSPR1
          BRANCH    OVRCD,DELSPR60
.
          COMPARE   ONE,NZSPPRIM
          GOTO      DELSPR50 IF NOT EQUAL
.
          MOVE      PRIMTIME,NZSPTDUR
          CALL      UPNZSPR1
.
DELSPR60  MOVE      ZERO,EXIT
          GOTO      DELSPR99
.
DELSPR90  MOVE      "Record does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
DELSPR99  RETURN
+
.------------------------------------------------------------
. Set Primary procedure for NZ Private procedure/funder details
.------------------------------------------------------------
SETSPR00  PACK      KEY11,ADMISSNO,SP70
          CALL      RSNZSPR1
SETSPR05  CALL      RKNZSPR1
          BRANCH    OVRCD,SETSPR99
.
          MATCH     ADMISSNO,NZSPADMN
          GOTO      SETSPR10 IF NOT EQUAL
.
          MATCH     "0",NZSPINVD
          GOTO      SETSPR87 IF NOT EQUAL
.
          COMPARE   ONE,NZSPPRIM
          GOTO      SETSPR05 IF NOT EQUAL
.
.....     COMPARE   TWO,NZSPPIND
.....     GOTO      SETSPR05 IF EQUAL
.
          MATCH     "2",NZSPINVD
          IF        @EQUAL
            GOTO      SETSPR85
          ENDIF
.
          MATCH     "3",NZSPINVD
          IF        @EQUAL
            GOTO      SETSPR85
          ENDIF
.
SETSPR10  PACK      KEY11,NZSPR001,NZSPR005,SP70
          PACK      DIM11,KEY11
          CALL      RDNZSPR1
          BRANCH    OVRCD,UPDSPR90
.
          MOVE      ONE,NZSPPRIM             * set to primary procedure
          CALL      UPNZSPR1
.
          CALL      PRIP0000                  * set primary procedures code
.
          MOVE      SP70,SKEY11
          PACK      KEY11,ADMISSNO,SP70
          CALL      RSNZSPR1
SETSPR50  CALL      RKNZSPR1
          BRANCH    OVRCD,SETSPR60
.
          MATCH     ADMISSNO,NZSPADMN
          GOTO      SETSPR60 IF NOT EQUAL
.
          PACK      DIM11A,NZSPADMN,NZSPUNIQ,SP70
          MATCH     DIM11A,DIM11
          GOTO      SETSPR50 IF EQUAL
.
          IF        NZSPPRIM=1
            PACK      SKEY11,NZSPADMN,NZSPUNIQ,SP70     * old primary procedure
            CALL      SECP0000                  * set secondary procedures code
          ENDIF
.
          MOVE      ZERO,NZSPPRIM
          CALL      UPNZSPR1
          GOTO      SETSPR50
.
.         Set uniq number to one for primary procedure
.
SETSPR60
.....     CALL      FSEQ0000             * fix sequence number of primary proc.
          MOVE      ZERO,NZSPR005
          MOVE      ZERO,NZSPR020
          CALL      CHKTIM00
          BRANCH    EXIT,SETSPR80
.
.         No duration update if the surgery time is blank
.
          MATCH     SP70,OPSGTISE
          GOTO      SETSPR80 IF EQUAL
.
          PACK      KEY11,NZSPR001,SP70
          CALL      RSNZSPR1
SETSPR65  CALL      RKNZSPR1
          BRANCH    OVRCD,SETSPR80
.
          COMPARE   ONE,NZSPPRIM
          GOTO      SETSPR65 IF NOT EQUAL
.
          MOVE      PRIMTIME,NZSPTDUR
          CALL      UPNZSPR1
.
SETSPR80  MOVE      ZERO,EXIT
          GOTO      UPDSPR99
.
SETSPR85  MOVE      "Cannot change, primary already invoiced",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SETSPR99
.
SETSPR87  MOVE      "Cannot change, invoices have already been printed",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SETSPR99
.
SETSPR90  MOVE      "Record does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SETSPR99
.
SETSPR99  RETURN
+
.------------------------------------------------------
.         Fix sequence number of new primary procedure
.------------------------------------------------------
FSEQ0000  PACK      KEY11,NZSPR001,NZSPR005,SP70
          CALL      RDNZSPR1
          BRANCH    OVRCD,SETSPR80
          MOVE      NZSPUNIQ,SAVEUNIQ    * save uniq number of new primary proc.
          CALL      DENZSPR1
          MOVE      "  0",NZSPUNIQ                 * write the new primary proc
          PACK      KEY11,NZSPR001,NZSPUNIQ,SP70   * with zero uniq no temporary
          CALL      RANZSPR1
          IF        OVRCD=1
            CALL      WRNZSPR1
          ENDIF
.
.         Set the old primary procedure
.
          MOVE      SKEY11,KEY11
          CALL      RDNZSPR1
          BRANCH    OVRCD,SETSPR80
          CALL      DENZSPR1
          MOVE      SAVEUNIQ,NZSPUNIQ
          PACK      KEY11,NZSPR001,NZSPUNIQ,SP70
          CALL      RANZSPR1
          IF        OVRCD=1
            CALL      WRNZSPR1
          ENDIF
.
.         set the uniq number of primary procedure to one
.
          MOVE      "  0",KEY3
          PACK      KEY11,NZSPR001,KEY3,SP70
          CALL      RDNZSPR1
          BRANCH    OVRCD,SETSPR80
          CALL      DENZSPR1
          MOVE      "  1",NZSPUNIQ
          PACK      KEY11,NZSPR001,NZSPUNIQ,SP70
          CALL      RANZSPR1
          IF        OVRCD=1
            CALL      WRNZSPR1
          ENDIF
.
FSEQ9999  RETURN
+
.------------------------------------------------------
. NZLT0000 - Routine used to display nzpspraf records
.------------------------------------------------------
.
NZLT0000  BRANCH    FLDITMNO,NZLT0100,NZLT0200,NZLT0300,NZLT0400,NZLT0500:
                             NZLT0600,NZLT0700,NZLT0800,NZLT0900,NZLT1000:
                             NZLT1100,NZLT1200
          GOTO      NZLT9999
.
NZLT0100  CALL      NZLS0000          * procedure list
          GOTO      NZLT9999
.
NZLT0200  MOVE      ZERO,CNTRFLAG
          CALL      NZPC0000          * procedure search
          GOTO      NZLT9999
.
NZLT0300  WRITE     HTMLFILE;UNIQUEKY;
          GOTO      NZLT9999
.
NZLT0400  MOVE      ZERO,STAFFDEF     * No to case staff only default
          CALL      DEFANA00          * get default anaesthetist
          GOTO      NZLT9999
.
NZLT0500  WRITE     HTMLFILE;PRIMTIME;* primary proc calculated time
          GOTO      NZLT9999
.
NZLT0600  WRITE     HTMLFILE;THEATREF;   * 1=multiple theatre bookings exist
          GOTO      NZLT9999
.
NZLT0700  WRITE     HTMLFILE;THEATREK;   * opdauniq if only 1 booking exists
          GOTO      NZLT9999
.
NZLT0800  PACK      KEY10,THEATREK,SP70
          CALL      GSES0000             * Get Session details
          GOTO      NZLT9999
.
NZLT0900  PACK      KEY10,UNIQUEKY,SP70
          CALL      GSES0000             * Get Session details
          GOTO      NZLT9999
.
NZLT1000  MOVE      ONE,STAFFDEF      * Yes to case staff only default
          CALL      DEFANA00          * get default anaesthetist
          GOTO      NZLT9999
.
NZLT1100  MOVE      ONE,CNTRFLAG
          CALL      NZPC0000          * procedure search
          GOTO      NZLT9999
.
NZLT1200  CALL      GSRG0000          * get surgeon
          GOTO      NZLT9999
.
NZLT9999  RETURN
+
.*******************************************************************************
.         Get surgeon
.*******************************************************************************
GSRG0000  MOVE      ADOCTA,KEY6
          MATCH     "1",THEATREF      * multiple theatre bookings exist
          IF        @EQUAL
            PACK      KEY10,UNIQUEKY,SP70
            CALL      RDOPDEA3
            IF        OVRCD=0
              MOVE      OPDACLIN,KEY6
            ENDIF
          ENDIF
          MOVE      KEY6,DOCTCODE
          CALL      DOCDET00
          GOTO      MISF9999
.
GSRG9999  RETURN
+
.*******************************************************************************
.         Get session details
.*******************************************************************************
GSES0000  CALL      RDOPDEA3
          BRANCH    OVRCD,GSES9999
.
          OPEN      OPRSESA1,"oprsesaf"
          PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,SP70
          CALL      RDOPSES1
          BRANCH    OVRCD,GSES9999
.
          UNPACK    OPSEDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR," at ",OPDATIME;
          GOTO      GSES9999
.
GSES9999  CLOSE     OPRSESA1
          RETURN
+
.*******************************************************************************
. Get default anaesthetist
. Try team surgical details, session, session master
.*******************************************************************************
DEFANA00  MATCH     SP70,UNIQUEKY
          GOTO      DEFANA99 IF EQUAL
.
          OPEN      OPRTSMA1,"oprtsmaf"
          OPEN      OPRSEMA1,"oprsemaf"
          PACK      KEY5,ANSO,ANSP,SP70
          CALL      RDSCODE1
DEFANA05  CALL      RDKCODE1
          BRANCH    OVRCD,DEFANA20
.
          MATCH     "OP",TCODE
          GOTO      DEFANA20 IF NOT EQUAL
.
          MATCH     ANSN,TCINDC1
          GOTO      DEFANA05 IF NOT EQUAL
.
          PACK      KEY3,ACODE          * save category OP anaesthetist code
.
          PACK      KEY35,UNIQUEKY,SP70
          CALL      RSOPTSM1
DEFANA10  CALL      RKOPTSM1
          BRANCH    OVRCD,DEFANA20
.
          MATCH     UNIQUEKY,OPTSUNID
          GOTO      DEFANA20 IF NOT EQUAL
.
          MATCH     KEY3,OPTSSTYP
          GOTO      DEFANA10 IF NOT EQUAL
.
          WRITE     HTMLFILE;OPTSSCDE;
          GOTO      DEFANA99
.
DEFANA20  BRANCH    STAFFDEF,DEFANA99       * Only defaulty from cases staff
.                                           * members
          PACK      KEY10,UNIQUEKY,SP70
          CALL      RDOPDEA3
          BRANCH    OVRCD,DEFANA99
.
          OPEN      OPRSESA1,"oprsesaf"
          PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,SP70
          CALL      RDOPSES1
          BRANCH    OVRCD,DEFANA99
.
          MATCH     SP70,OPSEANAE
          GOTO      DEFANA30 IF EQUAL
.
          WRITE     HTMLFILE;OPSEANAE;
          CLOSE     OPRSESA1
          GOTO      DEFANA99
.
DEFANA30  MATCH     "1",OPSEADTS
          GOTO      DEFANA99 IF EQUAL      * Adhoc Theatre Session
.
          UNPACK    OPSEDATE,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          DAYSEP    KEY8,OPSEDATE,FORM2
          PACK      KEY21,OPSEHOSP,OPSECLIN,WEEKDAY,OPSETIME,OPSETHET,SP70
          CALL      RDOPSEM1
          BRANCH    OVRCD,DEFANA99
.
          WRITE     HTMLFILE;OPSMANAE;
          GOTO      DEFANA99
.
DEFANA99  CLOSE     OPRTSMA1
          CLOSE     OPRSEMA1
          RETURN
.*******************************************************************************
. List NZ Procedure records
.*******************************************************************************
NZLS0000  PACK      KEY11,ADMISSNO,SP70
          CALL      RSNZSPR1
NZLS1000  CALL      RKNZSPR1
          BRANCH    OVRCD,NZLS9999
.
          MATCH     ADMISSNO,NZSPADMN
          GOTO      NZLS9999 IF NOT EQUAL
.
          PACK      NZCLDESC,SP70
          MATCH     SP70,NZSPCLMN
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSL,NZSPCLMN,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              PACK      NZCLDESC,TDESC,SP70
            ENDIF
          ENDIF
.
          PACK      KEY17,NZSPPROC,SP70
          PACK      KEY10,NZSPUNTH,SP70
          CALL      RDOPDEA3
          IF        OVRCD=0
            PACK      KEY17,NZSPPROC,OPDADATE,SP70
          ENDIF
          CALL      PATITMRD
          IF        OVRCD=1
            PACK      IDESC,SP70
          ENDIF
.
          PACK      KEY14,NZSPCNTR,ZERO,ZERO,ZERO,ZERO,SP70
          CALL      RDFUND1
          IF        OVRCD=1
            PACK      HFNAME,SP70
          ENDIF
.
          PACK      ANAFNAME,SP70
          PACK      KEY10,NZSPANAE,SP70
          CALL      RDPMHCP1
          IF        OVRCD<>1
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
            MOVE      DOCFNAME,ANAFNAME
          ENDIF
.
          PACK      DOCFNAME,SP70
          PACK      KEY10,NZSPSURG,SP70
          CALL      RDPMHCP1
          IF        OVRCD<>1
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
          ENDIF
.
          MOVE      DNO,PRIMARY
          COMPARE   ONE,NZSPPRIM
          IF        @EQUAL
            MOVE      DYES,PRIMARY
          ENDIF
.
          MOVE      DNO,PATINS
          COMPARE   ONE,NZSPPINS
          IF        @EQUAL
            MOVE      DYES,PATINS
          ENDIF
.
          MOVE      DNO,APPSIGHT
          COMPARE   ONE,NZSPAPSI
          IF        @EQUAL
            MOVE      DYES,APPSIGHT
          ENDIF
.
          MOVE      PLANNED,PROCSTAT
          COMPARE   ONE,NZSPPIND
          IF        @EQUAL
            MOVE      PERFORMD,PROCSTAT
          ENDIF
.
          COMPARE   TWO,NZSPPIND
          IF        @EQUAL
            MOVE      NOTPERFD,PROCSTAT
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:updateProcedure('",HTMLLINK
          APPEND    NZSPADMN,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    NZSPUNIQ,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    NZSPUNTH,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",NZCLDESC,"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",IDESC,"#",":
                             "#"",HFNAME,"#",":
                             "#"",PRIMARY,"#",":
                             "#"",NZSPCPRC,"#",":
                             "#"",ANAFNAME,"#",":
                             "#"",NZSPTDUR,"#",":
                             "#"",PATINS,"#",":
                             "#"",APPSIGHT,"#",";
.
          IF        NZSPPRIM=1
            WRITE     HTMLFILE;"#"<font color=red>",NZSPPROC,"</font>#",";
          ELSE
            WRITE     HTMLFILE;"#"",NZSPPROC,"#",";
          ENDIF
.
          WRITE     HTMLFILE;"#"",PROCSTAT,"#",":
                             "#"",NZSPPDES,"#",";
.
          MOVE      SP70,CPCDATE
          MOVE      SP70,OPDADATE
          MOVE      SP70,OPDATIME
          MATCH     SP70,NZSPUNTH
          GOTO      NZLS2000 IF EQUAL
.
          PACK      KEY10,NZSPUNTH,SP70
          CALL      RDOPDEA3
          BRANCH    OVRCD,NZLS2000
.
          UNPACK    OPDADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          WRITE     HTMLFILE;"#"",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"<br>":
                             "at ",OPDATIME,"<br>#",":
                             "#"",NZSPUNTH,"#");"
          GOTO      NZLS1000
.
NZLS2000  WRITE     HTMLFILE;"#"",SP1,"#",":
                             "#"",SP1,"#");"
          GOTO      NZLS1000
.
NZLS9999  RETURN
+
.*******************************************************************************
. NZ Procedure records
.*******************************************************************************
NZPC0000  UNPACK    DIM127,D1,KEY1,DIM127    * flag to display All Procedure
          MOVE      ZERO,F1
          MOVE      KEY1,F1
.
          PACK      KEY11,ADMISSNO,SP70
          CALL      RSNZSPR1
NZPC1000  CALL      RKNZSPR1
          BRANCH    OVRCD,NZPC9999
.
          MATCH     ADMISSNO,NZSPADMN
          GOTO      NZPC9999 IF NOT EQUAL
.
          BRANCH    F1,NZPC2000                 * All procedures
.
          COMPARE   ONE,NZSPPIND                * not performed?
          GOTO      NZPC1000 IF NOT EQUAL
.
NZPC2000  PACK      NZCLDESC,SP70
          PACK      KEY5,ANSC,ANSL,NZSPCLMN,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            PACK      NZCLDESC,TDESC,SP70
          ENDIF
.
          PACK      KEY17,NZSPPROC,SP70
          PACK      KEY10,NZSPUNTH,SP70
          CALL      RDOPDEA3
          IF        OVRCD=0
            PACK      KEY17,NZSPPROC,OPDADATE,SP70
          ENDIF
          CALL      PATITMRD
          IF        OVRCD=1
            PACK      IDESC,SP70
          ENDIF
.
          PACK      KEY14,NZSPCNTR,ZERO,ZERO,ZERO,ZERO,SP70
          CALL      RDFUND1
          IF        OVRCD=1
            PACK      HFNAME,SP70
          ENDIF
.
          PACK      ANAFNAME,SP70
          PACK      KEY10,NZSPANAE,SP70
          CALL      RDPMHCP1
          IF        OVRCD<>1
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
            MOVE      DOCFNAME,ANAFNAME
          ENDIF
.
          PACK      DOCFNAME,SP70
          PACK      KEY10,NZSPSURG,SP70
          CALL      RDPMHCP1
          IF        OVRCD<>1
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
          ENDIF
.
          MOVE      DNO,PRIMARY
          COMPARE   ONE,NZSPPRIM
          IF        @EQUAL
            MOVE      DYES,PRIMARY
          ENDIF
.
          MOVE      DNO,PATINS
          COMPARE   ONE,NZSPPINS
          IF        @EQUAL
            MOVE      DYES,PATINS
          ENDIF
.
          MOVE      DNO,APPSIGHT
          COMPARE   ONE,NZSPAPSI
          IF        @EQUAL
            MOVE      DYES,APPSIGHT
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "'selectProcedure(#"",HTMLLINK
          APPEND    NZSPADMN,HTMLLINK
          APPEND    "#",#"",HTMLLINK
          APPEND    NZSPUNIQ,HTMLLINK
          APPEND    "#",#"",HTMLLINK
          APPEND    NZSPPROC,HTMLLINK
          APPEND    "#",#"",HTMLLINK
          APPEND    NZSPCLMN,HTMLLINK
          IF        CNTRFLAG=1
            APPEND    "#",#"",HTMLLINK
            APPEND    NZSPCNTR,HTMLLINK
          ENDIF
          APPEND    "#",#"",HTMLLINK
          APPEND    NZSPPDES,HTMLLINK
          APPEND    "#")'>",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"<tr><td><img src=../images/MaintenanceIcon.gif":
                             " class=ListIcon onclick=",HTMLLINK;
.
          IF        NZSPPRIM=1
            WRITE     HTMLFILE;"<font color=red>",NZSPPROC,"</font></td>";
          ELSE
            WRITE     HTMLFILE;NZSPPROC,"</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td>",NZSPPDES,"&nbsp;</td>":
                             "<td>",NZCLDESC,"&nbsp;</td>":
                             "<td>",DOCFNAME,"&nbsp;</td>":
                             "<td>",HFNAME,"&nbsp;</td>":
                             "<td>",PRIMARY,"&nbsp;</td>":
                             "<td>",NZSPCPRC,"&nbsp;</td></tr>"
.
          GOTO      NZPC1000
.
NZPC9999  RETURN
+
.------------------------------------------------------------
. Output Next Page Based on CGI Parameter nextpage
.------------------------------------------------------------
NXTPAG00  MOVE      ZERO,F1
          MOVE      NEXTPAGE,F1
          BRANCH    F1,NXTPAG10,NXTPAG20,NXTPAG30,NXTPAG40,NXTPAG50
.
          CALL      WINCLS00
          GOTO      NXTPAG99
.
NXTPAG10  CALL      RDIREC00
          GOTO      NXTPAG99
.
NXTPAG20  CALL      PREDIR00      * Redirect Parent
          GOTO      NXTPAG99
.
NXTPAG30  CALL      PDIREC00      * Redirect Parent
          GOTO      NXTPAG99
.
NXTPAG40  CALL      PPARDR00      * Redirect Parent Parent
          GOTO      NXTPAG99
.
NXTPAG50  CALL      FHREXT00      * FHIR API POST/PUT All Ok Successful Response
          GOTO      NXTPAG99
.
NXTPAG99  RETURN
.
.*************************************************************************
. WORKD000 - Write working diagnosis details
.*************************************************************************
WORKD000  MATCH     "1",CHDISDTE
          GOTO      WORKD999 IF EQUAL
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPMWOR1
          IF        OVRCD=1
            CALL      CLPMWO00
            MOVE      AADMNO,PMWOADMN
.
            COMPARE   "999",ASTAY
            IF        !@EQUAL
              MOVE      ADATE,EXPDDAT
              ADD       ASTAY,EXPDDAT
              MOVE      EXPDDAT,PMWOEDAT
            ENDIF
.
            PACK      PMWOCDAT,CCC,CYY,CMM,CDD
            REP       " 0",PMWOCDAT
            CLOCK     TIME,PMWOCTIM
            MOVE      USERID,PMWOCUID
.
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            CALL      WRPMWOR1
            TRAPCLR   IO
          ELSE
.
            MATCH     "1",CHDISDT2
            IF        @EQUAL
              MATCH     SP70,PMWOEDAT
              GOTO      WORKD999 IF NOT EQUAL
            ENDIF
.
            COMPARE   "999",ASTAY
            IF        !@EQUAL
              MOVE      ADATE,EXPDDAT
              ADD       ASTAY,EXPDDAT
              MOVE      EXPDDAT,PMWOEDAT
            ENDIF
.
            PACK      PMWOUDAT,CCC,CYY,CMM,CDD
            REP       " 0",PMWOUDAT
            CLOCK     TIME,PMWOUTIM
            MOVE      USERID,PMWOUUID
            CALL      UPPMWOR1
          ENDIF
.
WORKD999  RETURN
+
.*************************************************************************
. EXPPAY00 - Write expected payor details
.*************************************************************************
EXPPAY00  COMPARE   FIVE,CFEETYP
          GOTO      EXPPAY99 IF NOT EQUAL
.
.         Remove all current expected payors with no invoice raised
.
          PACK      KEY14,ADMISSNO,SP70
EXPPAY10  CALL      RSVSPAY1
EXPPAY20  CALL      RKVSPAY1
          BRANCH    OVRCD,EXPPAY40
.
          MATCH     ADMISSNO,VSPAVISN
          GOTO      EXPPAY40 IF NOT EQUAL
.
          BRANCH    VSPAISEN,EXPPAY20           * Invoice sent
.
          PACK      KEY14,VSPAVISN,VSPAPAYC,SP70
          CALL      DEVSPAY1
          GOTO      EXPPAY10
.
EXPPAY40  PACK      KEY11,ADMISSNO,SP70
          CALL      RSNZSPR1
EXPPAY50  CALL      RKNZSPR1
          BRANCH    OVRCD,EXPPAY99
.
          MATCH     ADMISSNO,NZSPADMN
          GOTO      EXPPAY99 IF NOT EQUAL
          MATCH     SP70,NZSPCNTR
          GOTO      EXPPAY50 IF EQUAL            * no funder
.
          MATCH     "3",NZSPINVD
          GOTO      EXPPAY50 IF EQUAL            * All invoice raised
          MATCH     "2",NZSPINVD
          GOTO      EXPPAY50 IF EQUAL            * Funder invoice raised
.
.         do not write to payor file if claim code with tcindc7=P
.         as the payor will be the patient
.
          PACK      KEY5,ANSC,ANSL,NZSPCLMN
          CALL      RDCODE1
          BRANCH    OVRCD,EXPPAY50
          MATCH     "P",TCINDC7
          GOTO      EXPPAY50 IF EQUAL             * patient responsible for Acc.
          MATCH     "F",TCINDC7
          GOTO      EXPPAY58 IF EQUAL             * set up funder as payee
.
          MATCH     SP70,NZSPCNTR
          GOTO      EXPPAY50 IF EQUAL             * No funder, prfa
.
          MATCH     SP70,NZSPCPRC                 * check for contract proc.
          GOTO      EXPPAY50 IF NOT EQUAL         * patient responsible for Acc.
.
.         If no contract, charge to Primary funder
.
          BRANCH    NZSPPRIM,EXPPAY58
          GOTO      EXPPAY50                      * Patient responsible for Acc.
.
EXPPAY58  PACK      KEY14,ADMISSNO,NZSPCNTR,SP70
          CALL      RAVSPAY1
          COMPARE   ZERO,OVRCD
          GOTO      EXPPAY50 IF EQUAL
.
          MOVE      ONE,F2
          PACK      KEY10,ADMISSNO,Z70
          CALL      RSVSPAY2                     * Generate sequence number
          CALL      RPVSPAY2
          BRANCH    OVRCD,EXPPAY60
.
          MATCH     ADMISSNO,VSPAVISN
          GOTO      EXPPAY60 IF NOT EQUAL
.
          MOVE      VSPASEQN,F2
          ADD       ONE,F2
.
EXPPAY60  CALL      CLVISPAY                     * Clear file vars
.
          PACK      VSPAVISN,ADMISSNO,SP70
          PACK      VSPAPAYC,NZSPCNTR,SP70
          MOVE      F2,VSPASEQN                  * Allocate sequence number
          PACK      VSPACOMM,SP70
          MOVE      ZERO,VSPAACTV
          MOVE      ZERO,VSPAISEN
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,VSPACDAT                * System date
          CLOCK     TIME,VSPACTIM                * System time
          MOVE      USERID,VSPACUID              * web user id
.
          PACK      KEY14,ADMISSNO,NZSPCNTR,SP70
          CALL      WRVSPAY1                     * Writes the data
          GOTO      EXPPAY50
.
EXPPAY99  RETURN
+
.------------------------------------------------------------
.                          ALPR0000
.------------------------------------------------------------
.
ALPR0000  COMPARE   ONE,SAVEALPR
          GOTO      ALPR9999 IF NOT EQUAL
.
          MATCH     SP70,PMPXPFSN
          IF        @EQUAL | @EOS
            MATCH     SP70,PMPXPFGN
            IF        @EQUAL | @EOS
              GOTO      ALPR9999
            ENDIF
          ENDIF
.
          PACK      GSRSNAM,PMPXPFSN,SP70
          PACK      FULLGNAM,PMPXPFGN,SP70,SP70
          CALL      SEPRNAME
          PACK      GSRGNAM,FRSTGNAM,SP70
          PACK      PTGSGNM2,SCNDGNAM,SP70
          MOVE      PBDATE,GSRDOB            * Date of birth
          MOVE      PSEX,GSRSEX              * Sex
          MOVE      PURNO,GSRURNO
          MOVE      ZEROVISN,GSRBILL
          MOVE      ZERO,GSRSYS
          CALL      SOUNDEX                  * get soundex key for surname
          CALL      SOUNDX2                  * get soundex key for given names
.
          PACK      KEY115,GSRURNO,GSRBILL,GSRSNAM,GSRGNAM,PTGSGNM2,GSRDOB:
                           GSRSEX
          CALL      RDPTGSR1                 * check if its already there
          IF        OVRCD = 1
            CALL      WRPTGSR1
          ENDIF
.
          MOVE      "28",PMEWTYPE
          PACK      PMEWOLDV,SP70
          PACK      DIM40,GSRSNAM,SP70
          PACK      KEY40,GSRGNAM,SP70
          PACK      PMEWNEWV,DIM40,SP1,KEY40,SP1,PTGSGNM2,SP70
          CALL      WREDW000
.
ALPR9999  RETURN
+
.------------------------------------------------------------
.        WRAR0000 - Write to residential admission table (AH)
.------------------------------------------------------------
WRAR0000  CALL      LNKINP00
          BRANCH    EXIT,WRAR9999
.
          OPEN      ALLRSAA1,"allrsaaf"
          PACK      ALRAVISN,REFVISNO,SP70
          PACK      ALRALADM,AADMNO,SP70
          CALL      IBACLOCK
          PACK      ALRACDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALRACDAT
          CLOCK     TIME,ALRACTIM
          MOVE      WBSEUID,ALRACUID
          PACK      KEY16,ALRAVISN,ALRALADM,SP70
          CALL      RAALRSA1
          IF        OVRCD=1
            CALL      WRALRSA1                * write to the file
          ENDIF
.
WRAR9998  CLOSE     ALLRSAA1
.
WRAR9999  RETURN
.
.-------------------------------------------------------------------------
. When a waiting referral is linked to Inpatient, Update the status of
. referral from Waiting to Active
.-------------------------------------------------------------------------
LNKINP00  MOVE      ZERO,EXIT
          PACK      KEY8,AADMNO,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,LNKINP99
.
          PACK      KEY8,REFVISNO,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,LNKINP99
.
          MATCH     "0",ALRESTAT                 * check if waiting status
          GOTO      LNKINP99 IF NOT EQUAL
.
          PACK      KEY8,REFVISNO,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,LNKINP99
.
          MOVE      "1",ALRESTAT
          PACK      ALREUDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALREUDAT
          CLOCK     TIME,ALREUTIM
          MOVE      USERID,ALREUUID
          CALL      UPALREF1
.
. Temporarily close EMRICDA1 so that 1 file is available to be used in
. AMAS0000 to prevent the maximum number of files can be opened error
.   
          CLOSE     EMRICDA1 
.
          MOVE      ALREVISN,CHECKREF
          CALL      AMAS0000                * Auto activate master referral
.
          OPEN      EMRICDA1,"emricdaf"
.
LNKINP99  RETURN
.
.*******************************************************************************
. Activate a waiting master referral if the linked internal referral is active
. Requires CHECKREF - Internal Referral Number
.*******************************************************************************
AMAS0000  MATCH     "1",ALCNDAMR
          GOTO      AMAS9999 IF EQUAL
.
          PACK      KEY8,CHECKREF,SP70
          CALL      RDALREF1                * Read the referral to see if it's
          BRANCH    OVRCD,AMAS9999          * an internal referral
.
          MATCH     "1",ALREUYN4            * Exit if not an internal referral
          GOTO      AMAS9999 IF EQUAL
.
          MATCH     "1",ALRESTAT            * Exit if not active
          GOTO      AMAS9999 IF NOT EQUAL
.
          MOVE      ALREDACT,SAVIADAT       * Save internal referral date active
          MOVE      SP70,MASTREFN           * Clear master referral number
.
          OPEN      ALLRLNA2,"allrlnaf"
          PACK      KEY16,CHECKREF,SP70
          CALL      RSALRLN2                * Determine master referral number
          CALL      RKALRLN2
          BRANCH    OVRCD,AMAS9999
          CLOSE     ALLRLNA2
.
          MATCH     CHECKREF,ALRLLNKV       * Linked referrals
          GOTO      AMAS9999 IF NOT EQUAL
.
          MOVE      ALRLVISN,MASTREFN       * Save master referral number

          PACK      KEY8,MASTREFN,SP70
          CALL      RDALREF1                * Read the master referral
          BRANCH    OVRCD,AMAS9999
.
          MATCH     "1",ALREUYN4            * Exit if not an master referral
          GOTO      AMAS9000 IF NOT EQUAL
.
          MATCH     "0",ALRESTAT            * Exit if not waiting
          GOTO      AMAS9000 IF NOT EQUAL
.
          OPEN      ALLAUDRE,"allaudre"
          MOVE      TWO,AUDTTYPE            * before history record
          CALL      WAALRE00
          CLOSE     ALLAUDRE 
.
          MOVE      ZERO,RACTVFLG
          MOVE      "1",ALRESTAT            * Set status to active
          MOVE      SAVIADAT,ALREDACT
.
          PACK      ALREUDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALREUDAT
          CLOCK     TIME,ALREUTIM
          MOVE      USERID,ALREUUID
.
          CALL      URMHI000                * Set MHINC indicator
          CALL      UPALREF1                * Update referral Table (allrefaf)
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      ONE,HL7TRGID
          MOVE      "PATWEB89",HL7INCLD
          CALL      DGCLII13                * broadcast Update Ref
.
          OPEN      ALLAUDRE,"allaudre"
          MOVE      THREE,AUDTTYPE          * after history record
          CALL      WAALRE00
          CLOSE     ALLAUDRE
.
          OPEN      ALLSTSA1,"allstsaf" 
          MOVE      ALREDACT,ALSTSDAT
          CALL      WRTRSH00                * write a record to allstsaf
          CLOSE     ALLSTSA1
.
           OPEN      ALLAUDA1,"allaudaf"
           MOVE      "T",UPDTTYPE            * Update type
           CALL      WRTRAU00                * write to the referral audit table
           CLOSE     ALLAUDA1
.
AMAS9000  PACK      KEY8,CHECKREF,SP70
          CALL      RDALREF1                * Re read original referral
          IF        OVRCD=1
            CALL      CLALLREF
          ENDIF
.
AMAS9999  RETURN
.
.******************************************************************************
.         MHINC - Update Referral
.******************************************************************************
URMHI000  PACK      KEY5,ANSC,ANSG,ALREDEPT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,URMHI900
.
          MATCH     "M",TCINDC4
          GOTO      URMHI900 IF NOT EQUAL      * Not a Mental Health department
.
          MATCH     "1",ALREUYN4
          GOTO      URMHI900 IF NOT EQUAL      * Not Primary Referral
.
          MATCH     "0",ALREMOHR
          GOTO      URMHI200 IF EQUAL          * Unsent
.
          MATCH     "1",ALREMOHR
          GOTO      URMHI400 IF EQUAL          * Sent
.
          GOTO      URMHI900
.
.         if Closing referral for Unsent - then set indicator to 4
.
URMHI200  MATCH     "2",ALRESTAT
          GOTO      URMHI900 IF NOT EQUAL     * not Close status
.
          MOVE      "4",ALREMOHR              * 'Send RF and Discharge required'
          GOTO      URMHI900
.
.         Already sent
.
URMHI400  MATCH     "2",ALRESTAT
          GOTO      URMHI500 IF EQUAL          * Close Referral
.
          MATCH     "4",ALRESTAT
          GOTO      URMHI600 IF EQUAL          * Cancelled
.
          MATCH     "5",ALRESTAT
          GOTO      URMHI600 IF EQUAL          * Rejected
.
          MOVE      "0",ALREMOHR               * Unsent/Resend
.
.         If this was re-actived from Closed sent Referral - set indicator to 5
.
          IF        RACTVFLG=1
            MOVE      "5",ALREMOHR             * 'Send Delete Discharge'
          ENDIF

          GOTO      URMHI900
.
URMHI500  MOVE      "3",ALREMOHR               * Send Discharge required
          GOTO      URMHI900
.
URMHI600  MOVE      "2",ALREMOHR               * Send delete
          GOTO      URMHI900
.
URMHI900  MOVE      ZERO,RACTVFLG
URMHI999  RETURN
+
.******************************************************************************
.      write a record to the Referral Status History Table
.******************************************************************************
WRTRSH00  MOVE      ALREVISN,ALSTVISN       * Populate all the fields and write
          MOVE      ALRESTAT,ALSTSTAT
          PACK      ALSTCDAT,CCC,CYY,CMM,CDD
          REP       " 0",ALSTCDAT
          CLOCK     TIME,ALSTCTIM
          MOVE      WBSEUID,ALSTCUID
          PACK      KEY17,ALSTVISN,ALSTSTAT,ALSTSDAT,SP70
          CALL      RAALSTS1
          IF        OVRCD=0
            CALL      UPALSTS1                * update to the file
          ELSE
            CALL      WRALSTS1                * write to the file
          ENDIF
.
WRTRSH99  RETURN
+
.******************************************************************************
.      write a record to the Referral Audit Table
.      Requires - UPDTTYPE - update type for allaudaf
.******************************************************************************
WRTRAU00  CALL      CLALLAUD                     * clear allaudaf variables
.
          MOVE      ALREVISN,ALAUVISN
          PACK      ALAUADAT,CCC,CYY,CMM,CDD
          MOVE      UPDTTYPE,ALAUUPDT
          REP       " 0",ALAUADAT
          CLOCK     TIME,ALAUATIM
          MOVE      WBSEUID,ALAUAUID
          PACK      AUDITKEY,ALAUVISN,ALAUADAT,ALAUATIM,SP70
          PACK      KEY24,ALAUVISN,ALAUADAT,ALAUATIM,SP70
          CALL      RDALAUD1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            CALL      WRALAUD1                * write to the file
            TRAPCLR   IO
            BRANCH    OVRCD,WRTRAU99
          ENDIF
WRTRAU99  RETURN
.
.------------------------------------------------------------
. WCAP0000 - Work Capacity Details
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
WCAP0000  PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMWX11
          BRANCH    OVRCD,WCAP8000
.
.         NZ only...
          IF        PTCNHDPS=1 
            MATCH     SP70,PMWXASST
            IF        @EQUAL
              MOVE      "A",AUDITYPE
            ELSE
              MOVE      "U",AUDITYPE
            ENDIF
            CALL      MVACCWRK
          ENDIF
.
          CALL      UPWRK000                       * Move CGI to file vars
          CALL      IBACLOCK
          PACK      PMWXLUPD,CCC,CYY,CMM,CDD       * Current Date
          REP       " 0",PMWXLUPD
          MOVE      CTIMEIS,PMWXLUPT               * Current Time
          MOVE      USERID,PMWXWEBU                * Current WebID
          CALL      UPPMWX11                       * Update pmswx1af
          CALL      AWCMN000                       * Alt Wrk Restriction Cmts
          IF        PTCNHDPS=1 
            CALL      UPALWC00       * Upd all visits WC details linked to ACCNo
          ENDIF
          CALL      NXTPAG00
          MOVE      ONE,EXIT
          GOTO      WCAP9999
.
WCAP8000  IF        PTCNHDPS=1         
            MOVE      "A",AUDITYPE
            CALL      MVACCWRK
          ENDIF
.
          CALL      UPWRK000                        * Move CGI to file vars
          CALL      IBACLOCK
          PACK      PMWXCDTE,CCC,CYY,CMM,CDD        * Current Date
          REP       " 0",PMWXCDTE
          MOVE      CTIMEIS,PMWXCTIM                * Current Time
          MOVE      USERID,PMWXWEBC                 * Current WebID
          CALL      WRPMWX11                        * Write to pmswx1af
          CALL      AWCMN000                        * Alt Wrk Restriction Cmts
          IF        PTCNHDPS=1 
            CALL      UPALWC00       * Upd all visits WC details linked to ACCNo
          ENDIF
          CALL      NXTPAG00
          MOVE      ONE,EXIT
          GOTO      WCAP9999
.
WCAP9000  MOVE      ONE,EXIT                        * Error?
          GOTO      WCAP9999
.
WCAP9999  RETURN
+
.-------------------------------------------------------------------------
. UPALWC00 - Copy Work Capacity details of an ACC number to all its linked
.            visits
.-------------------------------------------------------------------------
UPALWC00  PACK      KEY44,PTCLM011,URNUMBER,SP70
          CALL      RDSWCOM3
UPALWC10  CALL      RDKWCOM3
          BRANCH    OVRCD,UPALWC99
.
          MATCH     ADMISSNO,DWCADMNO              * don't have to update this
          GOTO      UPALWC10 IF EQUAL
          MATCH     PTCLM011,WCCLMNO               * Same ACC Number?
          GOTO      UPALWC99 IF NOT EQUAL
          MATCH     URNUMBER,PTWCURNO              * Same U/R?
          GOTO      UPALWC99 IF NOT EQUAL
.
          PACK      KEY8,DWCADMNO,SP70
          CALL      RDPMWX11                       * read WC1 extension file
          BRANCH    OVRCD,UPALWC10
.
          CALL      UPWRK000                       * Move CGI to file vars
          PACK      PMWXLUPD,CCC,CYY,CMM,CDD       * Current Date
          REP       " 0",PMWXLUPD
          MOVE      CTIMEIS,PMWXLUPT               * Current Time
          MOVE      USERID,PMWXWEBU                * Current WebID
          CALL      UPPMWX11
          GOTO      UPALWC10
.
UPALWC99  RETURN
+
.------------------------------------------------------------
. ADET0000 - Accident Details
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
ADET0000  CALL      CLRCLM00
          PACK      KEY44,PTCLM011,URNUMBER,ADMISSNO,SP70
          CALL      RDWCOM3
          IF        OVRCD<>1
            GOTO      ADET0600
          ENDIF

          CALL      RDSWCOM3
ADET0500  CALL      RDKWCOM3
          BRANCH    OVRCD,ADET1500
.
          MATCH     PTCLM011,WCCLMNO               * Same ACC Number?
          GOTO      ADET1500 IF NOT EQUAL
.
          MATCH     URNUMBER,PTWCURNO              * Same U/R?
          GOTO      ADET3000 IF NOT EQUAL
.
          MATCH     ADMISSNO,DWCADMNO              * Same admission Number?
          GOTO      ADET0500 IF NOT EQUAL
.
ADET0600  CALL      AICMN000                       * Additional Injury Comments
          CALL      CICMN000                       * Cause of Injury Cmts
          PACK      KEY8,ADMISSNO,SP70
          CALL      UPCLV000                       * Move CGI to file vars
          CALL      UPWCOM3                        * Update patwc1af
          MOVE      ZERO,EXIT
.
ADET0700  PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMWX11                       * Read extension file
          BRANCH    OVRCD,ADET2000
.
ADET1000  CALL      UPCLV000                       * Move CGI to file vars
          CALL      IBACLOCK
          PACK      PMWXLUPD,CCC,CYY,CMM,CDD       * Current Date
          REP       " 0",PMWXLUPD
          MOVE      CTIMEIS,PMWXLUPT               * Current Time
          MOVE      USERID,PMWXWEBU                * Current WebID
          CALL      UPPMWX11                       * Update pmswx1af
          MOVE      ZERO,EXIT
          GOTO      ADET7000                                          *C-230468
.
.                                           * new ACC Number - add/update data
.                                           * (write Workers Comp. if required)
ADET1500  CALL      CKACCAUD                         * Check ACC Audit file
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDWCOM1
          IF        OVRCD=1
            CALL      UPCLV000                       * Move CGI to file vars
            CALL      GWCDAT00
            CALL      WRWCOM1                        * Write new record
          ELSE
            CALL      UPCLV000                       * Move CGI to file vars
            CALL      GWCDAT00
            CALL      UPWCOM1                        * Update record
          ENDIF
.
.
          CALL      CICMN000                       * Cause of Injury Cmts
          CALL      AICMN000                       * Additional Injury Comments
          GOTO      ADET0700
.
.                                           * create a Visit Extension record
ADET2000  PACK      KEY8,ADMISSNO,SP70
          CALL      UPCLV000                       * Move CGI to file vars
          CALL      IBACLOCK
          PACK      PMWXCDTE,CCC,CYY,CMM,CDD       * Current Date
          REP       " 0",PMWXCDTE
          MOVE      CTIMEIS,PMWXCTIM               * Current Time
          MOVE      USERID,PMWXWEBC                * Current WebID
          CALL      WRPMWX11                       * Write new record
          MOVE      ZERO,EXIT
          GOTO      ADET7000                                          *C-230468
.
ADET3000  MOVE      "ACC No Exists for Another Patient",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADET9999
.
.                                      * update all ACC Accident data *I-230468
ADET7000  CALL      CLRCLM00
          IF        PTCNHDPS=1    
            MATCH     "S",ACCFLAG1
            IF        @EQUAL
              CALL      MVACCXML
            ELSE
              MATCH     "1",CHECKACC
              IF        !@EQUAL
                CALL      MVACCUPD
              ENDIF
            ENDIF
.
            MATCH     "I",ACCAUFLG
            IF        @EQUAL 
              CALL      MVACCINJ
            ENDIF
.
            MATCH     "W",ACCAUFLG
            IF        @EQUAL
              CALL      MVACCWRK
            ENDIF
.
            MATCH     "R",ACCAUFLG
            IF        @EQUAL
              CALL      MVACCREF
            ENDIF
          ENDIF
.
          PACK      KEY44,PTCLM011,URNUMBER,SP70
          CALL      RDSWCOM3
ADET7500  CALL      RDKWCOM3
          BRANCH    OVRCD,ADET7600
.
          MATCH     ADMISSNO,DWCADMNO              * don't have to update this
          GOTO      ADET7500 IF EQUAL
          MATCH     PTCLM011,WCCLMNO               * Same ACC Number?
          GOTO      ADET7600 IF NOT EQUAL
          MATCH     URNUMBER,PTWCURNO              * Same U/R?
          GOTO      ADET7600 IF NOT EQUAL
.
          PACK      KEY8,DWCADMNO,SP70
          CALL      RDPMWX11                       * read WC1 extension file
          BRANCH    OVRCD,ADET7500
.
          CALL      CPCLV000                       * Move CGI to file vars
          PACK      PMWXLUPD,CCC,CYY,CMM,CDD       * Current Date
          REP       " 0",PMWXLUPD
          MOVE      CTIMEIS,PMWXLUPT               * Current Time
          MOVE      USERID,PMWXWEBU                * Current WebID
          CALL      UPPMWX11
.
          CALL      UPWCOM3                        * Update the WC1 record
          GOTO      ADET7500                       * read next  * end *I-230468
.
ADET7600  CALL      UPWC0000                 * Update WC for a new visit
.
ADET8000  CALL      UPOC0000                 * Update Master file for occupation
          PACK      KEY8,ADMISSNO,SP70                                *I-153670
          CALL      RDPMVX11
          BRANCH    OVRCD,ADET9000
.
          MATCH     PTVIS016,Z70
          GOTO      ADET9000 IF EQUAL
.
          MATCH     PTVIS016,PMVXDOCT            * change of Treating Doctor?
          IF        !@EQUAL
            MOVE      PTVIS016,PMVXDOCT
            CALL      UPPMVX11
          ENDIF
.
ADET9000  MOVE      THREE,FOLDERTY
          CALL      UPFOLD00
.
.         If we are sending ACC details in PV1-20, then trigger HL7 message
.
          MATCH     "1",PTCNH7AC
          IF        @EQUAL
            MOVE      TWO,MESSFLAG               * set flag for error
            MOVE      ADMISSNO,KEY8
            CALL      RDVISA1
            IF        OVRCD=0
              MOVE      ZERO,MESSFLAG            * set flag for general visit
            ELSE
              PACK      KEY36,ADMISSNO,SP20,SP20
              CALL      RDSBOKA6
              CALL      RDKBOKA6
              IF        OVRCD=0
                MATCH     ADMISSNO,DOBAOUTN
                IF        @EQUAL
                  MOVE      ONE,MESSFLAG         * set flag for O/P visit
                ENDIF
              ENDIF
            ENDIF
            CALL      TACC0000                   * send HL7 update (0915902)
          ENDIF
.
ADET9999  RETURN
.------------------------------------------------------------
. Check if Same ACC Number already exists in ACC Audit file
.------------------------------------------------------------
CKACCAUD  IF        PTCNHDPS=1            
            PACK      KEY44,PTCLM011,SP70
            CALL      RDSWCOM3
            CALL      RDKWCOM3
            MATCH     PTCLM011,WCCLMNO             * Same ACC Number?
            IF        !@EQUAL 
              CALL      MVACCADD                   * Add record to Audit file
              MOVE      "1",CHECKACC               * New ACC Number
            ELSE
              MOVE      "0",CHECKACC               * Already exists
            ENDIF
          ENDIF
.
CKACC999  RETURN
.------------------------------------------------------------------
. WC details copied over from other visit linked to same ACC Number
.------------------------------------------------------------------
UPWC0000  IF        PTCNHDPS=1
              PACK      KEY44,PTCLM011,URNUMBER,SP70
              CALL      RDSWCOM3
UPWC0010      CALL      RDKWCOM3
              BRANCH    OVRCD,UPWC9999
.
              MATCH     ADMISSNO,DWCADMNO            * don't have to update this
              GOTO      UPWC0010 IF EQUAL
              MATCH     PTCLM011,WCCLMNO             * Same ACC Number?
              GOTO      UPWC9999 IF NOT EQUAL
              MATCH     URNUMBER,PTWCURNO            * Same U/R?
              GOTO      UPWC9999 IF NOT EQUAL
.
              PACK      KEY8,DWCADMNO,SP70
              CALL      RDPMWX11
              BRANCH    OVRCD,UPWC0010
.
              PACK      SAVENEED,PMWXNEED,SP70
              PACK      SAVEASST,PMWXASST,SP70
              PACK      SAVECONT,PMWXCONT,SP70
              PACK      SAVEAPPR,PMWXAPPR,SP70
              PACK      SAVEALTW,PMWXALTW,SP70
              PACK      SAVEUNFD,PMWXUNFD,SP70
              PACK      SAVEUNFT,PMWXUNFT,SP70
              PACK      SAVEFISD,PMWXFISD,SP70
              PACK      SAVERNWD,PMWXRNWD,SP70
              PACK      SAVETYPA,PMWXTYPA,SP70
              PACK      SAVESALT,PMWXSALT,SP70
              PACK      SAVEHPDA,PMWXHPDA,SP70
.
              PACK      KEY8,ADMISSNO,SP70
              CALL      RDPMWX11
              BRANCH    OVRCD,UPWC9999
.
              PACK      PMWXNEED,SAVENEED,SP70
              PACK      PMWXASST,SAVEASST,SP70
              PACK      PMWXCONT,SAVECONT,SP70
              PACK      PMWXAPPR,SAVEAPPR,SP70
              PACK      PMWXALTW,SAVEALTW,SP70
              PACK      PMWXUNFD,SAVEUNFD,SP70
              PACK      PMWXUNFT,SAVEUNFT,SP70
              PACK      PMWXFISD,SAVEFISD,SP70
              PACK      PMWXRNWD,SAVERNWD,SP70
              PACK      PMWXTYPA,SAVETYPA,SP70
              PACK      PMWXSALT,SAVESALT,SP70
              PACK      PMWXHPDA,SAVEHPDA,SP70
.
              PACK      KEY8,ADMISSNO,SP70
              CALL      UPPMWX11
              BRANCH    OVRCD,UPWC9999
          ENDIF
.
UPWC9999  RETURN            
.------------------------------------------------------------
. GWCDAT00 - Get ptwcvdat
.------------------------------------------------------------
GWCDAT00    MOVE      ADMISSNO,KEY8
            CALL      RDVISA1
            IF        OVRCD=0
              MOVE      PVIDATE,PTWCVDAT
              GOTO      GWCDAT99
            ENDIF
.
            MOVE      SP70,PTWCVDAT
            PACK      KEY36,ADMISSNO,SP20,SP20
            CALL      RDSBOKA6
            CALL      RDKBOKA6
            IF        OVRCD=0
              MATCH     ADMISSNO,DOBAOUTN
              IF        @EQUAL
                MOVE      OBADATE,PTWCVDAT
                GOTO      GWCDAT99
              ENDIF
            ENDIF
            MATCH     SP70,CASEKEYS
            IF        !@EQUAL
              PACK      KEY19,CASEKEYS,SP70
              CALL      RDTREA1
              IF        OVRCD<>1
                MOVE      WMDATE1,PTWCVDAT
              ENDIF
            ENDIF
.
GWCDAT99  RETURN
+
.------------------------------------------------------------
. UPOC0000 - Update Occupation in Master file
.------------------------------------------------------------
UPOC0000  PACK      KEY8,URNUMBER,SP10
          CALL      RDMAST1
          BRANCH    OVRCD,UPOC9999
.
          MATCH     PTMAS044,Z70
          IF        !@EQUAL
            MOVE      PTMAS044,PUSR6
            CALL      UPMAST1             * update Master with Latest Occupation
          ENDIF
.
UPOC9999  RETURN
+
.------------------------------------------------------------
. DIAG0000 - ACC Diagnosis details
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
DIAG0000  MATCH     SP70,UPDTTYPE      * Display
          GOTO      DIAG8000 IF EQUAL
          MATCH     "A",UPDTTYPE       * Add New
          GOTO      DIAG1000 IF EQUAL
          MATCH     "U",UPDTTYPE       * Update
          GOTO      DIAG2000 IF EQUAL
          MATCH     "D",UPDTTYPE       * Delete
          GOTO      DIAG3000 IF EQUAL
.
.         Add Formaction
.
DIAG1000  PACK      KEY23,PTCLM011,Z70
          CALL      RSACDIA1
DIAG1100  CALL      RPACDIA1
          BRANCH    OVRCD,DIAG1130
.
          MATCH     PTCLM011,ACDIACCN               * Same ACC Number?
          GOTO      DIAG1130 IF NOT EQUAL
.
DIAG1120  ADD       ONE,ACDICONT                    * get Next Count value
          GOTO      DIAG1140
.
DIAG1130  MOVE      ONE,ACDICONT
.
DIAG1140  CALL      MVACCD00
          CALL      WRACDIA1
          IF        PTCNHDPS=1   
            CALL      MVACCINJ                     * Move data to ACC Audit File
          ENDIF
          MOVE      ZERO,EXIT
          GOTO      DIAG9999
.
.         Update Formaction
.
DIAG2000  PACK      KEY23,PTCLM011,ACCDG002,SP70
          CALL      RDACDIA1
          BRANCH    OVRCD,DIAG9800
.
          CALL      MVACCD00
          CALL      UPACDIA1
          IF        PTCNHDPS=1 
            CALL      MVACCINJ                     * Move data to ACC Audit File
          ENDIF
          MOVE      ZERO,EXIT
          GOTO      DIAG9999
.
.         Delete Formaction
.
DIAG3000  PACK      KEY23,PTCLM011,ACCDG002,SP70
          CALL      RDACDIA1
          BRANCH    OVRCD,DIAG9800
.
          CALL      DEACDIA1
          IF        PTCNHDPS=1 
            CALL      MVACCINJ                     * Move data to ACC Audit File
          ENDIF
          MOVE      ZERO,EXIT
          GOTO      DIAG9999
.
DIAG8000  MATCH     SP70,PTCLM011
          IF        !@EQUAL
            PACK      KEY23,PTCLM011,ACCDG002,SP70
            CALL      RDACDIA1
            IF        OVRCD=1
              CALL      CLACCDIA
            ENDIF
          ENDIF
.
DIAG8200  CALL      PATNAM00
          CLEAR     WEBTITLE
          APPEND    PATFNAME,WEBTITLE
          APPEND    " - Diagnosis Details",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00
          BRANCH    EXIT,DIAG9999
          CALL      WEBBOD00
          CALL      WEBEND00
          MOVE      ONE,EXIT
          GOTO      DIAG9999
.
DIAG9800  MOVE      "Record does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DIAG9999
.
DIAG9900  MOVE      "Record already exists for this patient",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DIAG9999
.
DIAG9999  RETURN
.
.------------------------------------------------------------
.  Table of ACC Diagnosis Details
.------------------------------------------------------------
TABD0000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          CALL      DIAHED00              * Output Table Heading
.
          IF        NORECORD=0
            MOVE      "10",NORECORD       * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          PACK      KEY23,WCCLMNO,SP70
          CALL      RSACDIA1
TABD1000  CALL      RKACDIA1
          BRANCH    OVRCD,TABD9999
.
          MATCH     WCCLMNO,ACDIACCN      * same ACC Number?
          GOTO      TABD9999 IF NOT EQUAL
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      TABD1000            * get Next record
          ENDIF
.
          CALL      DIAROW00              * Display Diagnosis Details Row
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      TABD1000 IF NOT EQUAL
.
TABD9999  RETURN
.------------------------------------------------------------
. Diagnosis Details (TABLE HEADING)
.------------------------------------------------------------
DIAHED00  WRITE     HTMLFILE;"<tr>":
                               "<td class=HeadingCell width=20%>":
                               "Diagnosis Code</td>":
                               "<td class=HeadingCell width=30%>":
                               "Description</td>":
                               "<td class=HeadingCell width=30%>":
                               "Coding Sytem Code</td>":
                               "<td class=HeadingCell width=20%>":
                               "Side</td>":
                             "</tr>"
.
DIAHED99  RETURN
.------------------------------------------------------------
. Diagnosis Details (TABLE ROW)
.------------------------------------------------------------
DIAROW00  PACK      KEY9,ACDIDIAG,SP70
          CALL      RDEMICD1              * get Diagnosis Description
.
          MOVE      "&nbsp;",DIM50
          BRANCH    PTCNHDPS,DIAROW11     * NZ ?
.
          MATCH     "1  ",ACDICSYC
          IF        @EQUAL
            MOVE      "ICD9",DIM50
          ENDIF
.
          MATCH     "2  ",ACDICSYC
          IF        @EQUAL
            MOVE      "ICD10",DIM50
          ENDIF
.
          MATCH     "3  ",ACDICSYC
          IF        @EQUAL
            MOVE      "READ",DIM50
          ENDIF
.
          GOTO      DIAROW12
.
.         NZ only...
DIAROW11  MATCH     SP70,ACDICSYC
          GOTO      DIAROW12 IF EQUAL
.
          PACK      KEY3,ACDICSYC,SP70
          CALL      RDPMVST1
          IF        OVRCD=0
            MOVE      PMVTVSNM,DIM50
          ENDIF
.
DIAROW12  MOVE      SP70,SIDEDESC
          MATCH     "1",ACDISIDE
          IF        @EQUAL
            MOVE      "Left",SIDEDESC
          ENDIF
          MATCH     "2",ACDISIDE
          IF        @EQUAL
            MOVE      "Right",SIDEDESC
          ENDIF
          MATCH     "3",ACDISIDE
          IF        @EQUAL
            MOVE      "N/A",SIDEDESC
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td nowrap><A HREF='javascript:ShowDetail04":
                             "(#"",LINKPRG,"#.pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&ptclm011=",ACDIACCN:
                             "&accdg002=",DACDICNT,"#")'>":
                            "<img src='../images/MaintenanceIcon.gif' hspace=4":
                             " border=0 align=absmiddle></a>":
                             ACDIDIAG,"</td>":
                             "<td>&nbsp;",EMICDESC,"</td>":
                             "<td>&nbsp;",DIM50,"</td>":
                             "<td>&nbsp;",SIDEDESC,"&nbsp;</td>":
                             "</tr>"
.
DIAROW99  RETURN
.------------------------------------------------------------
. Link to Next Group of Diagnosis Details
.-----------------------------------------------------------
NEXTDD00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
          REP       " +",ACDIACCN
.
          WRITE     HTMLFILE;"patweb89.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&ptclm011=",WCCLMNO:
                                 "&urnumber=",URNUMBER:
                                 "&admissno=",ADMISSNO;
.
          REP       "+ ",ACDIACCN
.
NEXTDD99  RETURN
.-------------------------------------------------------------
. Link to Prev Group of Diagnosis Details
.-------------------------------------------------------------
PREVDD00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM-NORECORD,F3
          IF        F3<0
            MOVE      ZERO,F3
          ENDIF
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
          REP       " +",ACDIACCN
.
          WRITE     HTMLFILE;"patweb89.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&ptclm011=",WCCLMNO:
                                 "&urnumber=",URNUMBER:
                                 "&admissno=",ADMISSNO;
.
          REP       "+ ",ACDIACCN
.
PREVDD99  RETURN
.------------------------------------------------------------
.  Table of ACC Referrals Details
.------------------------------------------------------------
TABR0000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          CALL      REFHED00              * Output Table Heading
.
          IF        NORECORD=0
            MOVE      "10",NORECORD       * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          PACK      KEY23,WCCLMNO,SP70
          CALL      RSACRFP1
TABR1000  CALL      RKACRFP1
          BRANCH    OVRCD,TABR9999
.
          MATCH     WCCLMNO,ACRFACCN      * same ACC Number?
          GOTO      TABR9999 IF NOT EQUAL
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      TABR1000            * get Next record
          ENDIF
.
          CALL      REFROW00              * Display Referral Details Row
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      TABR1000 IF NOT EQUAL
.
TABR9999  RETURN
.------------------------------------------------------------
. Referral Details (TABLE HEADING)
.------------------------------------------------------------
REFHED00  WRITE     HTMLFILE;"<tr>":
                               "<td class=HeadingCell width=20%>":
                               "Referral Provider Type</td>":
                               "<td class=HeadingCell width=30%>":
                               "Other Provider Type</td>":
                               "<td class=HeadingCell width=30%>":
                               "Treatment</td>":
                             "</tr>"
.
REFHED99  RETURN
.------------------------------------------------------------
. Referral Details (TABLE ROW)
.------------------------------------------------------------
REFROW00  MATCH     SP70,ACRFOPRT
          IF        @EQUAL
            MOVE      "&nbsp;",ACRFOPRT
          ENDIF
.
          PACK      SGTRCMNT,SP70
          STRIP     ACRFSTC1
          APPEND    ACRFSTC1,SGTRCMNT         * Suggested Treatment Cmnt Line 1
          APPEND    SP1,SGTRCMNT
          STRIP     ACRFSTC2
          APPEND    ACRFSTC2,SGTRCMNT         * Suggested Treatment Cmnt Line 2
          APPEND    SP1,SGTRCMNT
          STRIP     ACRFSTC3
          APPEND    ACRFSTC3,SGTRCMNT         * Suggested Treatment Cmnt Line 3
          RESET     SGTRCMNT
.
          MATCH     SP70,SGTRCMNT
          IF        @EQUAL
            MOVE      "&nbsp;",SGTRCMNT
          ENDIF
.
          PACK      KEY5,ANSI,ANSW,ACRFRPRT,SP70
          CALL      RDCODE1
          IF        OVRCD<>0
            PACK      TDESC,SP70
          ENDIF
          WRITE     HTMLFILE;"<tr><td nowrap><A HREF='javascript:ShowDetail04":
                             "(#"",LINKPRG,"#.pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&ptclm011=",ACRFACCN:
                             "&accrd002=",DACRFCNT,"#")'>":
                             "<img src=../images/MaintenanceIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             TDESC,"</td>":
                             "<td>",ACRFOPRT,"</td>":
                             "<td>",SGTRCMNT,"</td>":
                             "</tr>"
.
REFROW99  RETURN
.-----------------------------------------------------------
. Link to Next Group of Referral Details
.-----------------------------------------------------------
NEXTRD00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
          REP       " +",ACRFACCN
.
          WRITE     HTMLFILE;"patweb89.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&ptclm011=",WCCLMNO:
                                 "&urnumber=",URNUMBER:
                                 "&admissno=",ADMISSNO:
                                 "&systflag=",SYSTFLAG;
.
          REP       "+ ",ACRFACCN
.
NEXTRD99  RETURN
.-------------------------------------------------------------
. Link to Prev Group of Referral Details
.-------------------------------------------------------------
PREVRD00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM-NORECORD,F3
          IF        F3<0
            MOVE      ZERO,F3
          ENDIF
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
          REP       " +",ACRFACCN
.
          WRITE     HTMLFILE;"patweb89.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&ptclm011=",WCCLMNO:
                                 "&urnumber=",URNUMBER:
                                 "&admissno=",ADMISSNO:
                                 "&systflag=",SYSTFLAG;
.
          REP       "+ ",ACRFACCN
.
PREVRD99  RETURN
.------------------------------------------------------------
.  Update ACCDIAFD file
.------------------------------------------------------------
MVACCD00  MATCH     PTCLM011,Z70
          IF        !@EQUAL
            MOVE      PTCLM011,ACDIACCN
          ENDIF
.
          MATCH     ACCDG003,Z70
          IF        !@EQUAL
            MOVE      ACCDG003,ACDICSYC
          ENDIF
.
          MATCH     ACCDG004,Z70
          IF        !@EQUAL
            MOVE      ACCDG004,ACDIDIAG
          ENDIF
.
          MATCH     ACCDG005,Z70
          IF        !@EQUAL
            MOVE      ACCDG005,ACDISIDE
          ENDIF
.
MVACCD99  RETURN
.
.--------------------------------------------------------------
.  Add record to ACC Audit file (accaudaf) for Injury Diagnosis
.--------------------------------------------------------------
MVACCINJ  CALL      CLACCAUD
          MATCH     PTCLM011,Z70
          IF        !@EQUAL
            MOVE      PTCLM011,ACAUCLMN             * ACC Claim Number
          ENDIF
.
          MATCH     ADMISSNO,Z70
          IF        !@EQUAL
            MOVE      ADMISSNO,ACAUADMN             * Visit Number
          ENDIF
.
          MOVE      "D",ACAUTREC                    * ACC Type of Record
.
          MATCH     "A",UPDTTYPE
          IF        @EQUAL
            MOVE      "A",ACAUAUTY                  * Audit Type for ADD
          ENDIF
.
          MATCH     "U",UPDTTYPE
          IF        @EQUAL
            MOVE      "U",ACAUAUTY                  * Audit Type for UPDATE 
          ENDIF
.
          MATCH     "D",UPDTTYPE
          IF        @EQUAL
            MOVE      "D",ACAUAUTY                  * Audit Type for DELETE
          ENDIF
.
          MATCH     SP70,UPDTTYPE
          IF        @EQUAL
            MOVE      "V",ACAUAUTY                  * Audit Type For VISIT
          ELSE
            MATCH     ACCDG003,Z70
            IF        !@EQUAL
              MOVE      ACCDG003,ACAUDIGV           * Diagnosis Value SetID
            ENDIF
.
            MATCH     ACCDG004,Z70
            IF        !@EQUAL
              MOVE      ACCDG004,ACAUDIGC           * Diagnosis Code
            ENDIF
.  
            MATCH     ACCDG005,Z70     
            IF        !@EQUAL
              MOVE      ACCDG005,ACAUDIGS           * Diagnosis Side (L/R/NA)
            ENDIF
          ENDIF
.
          CALL      WRTACAUD                        * Write record to accaudaf  
.
MVACCI99  RETURN
.
.------------------------------------------------------------
.  Add record to ACC Audit file (accaudaf) for Work Capacity
.------------------------------------------------------------
MVACCWRK  CALL      CLACCAUD
.
          MATCH     PTCLM011,Z70
          IF        !@EQUAL
            MOVE      PTCLM011,ACAUCLMN
          ENDIF
.
          MATCH     ADMISSNO,Z70
          IF        !@EQUAL
            MOVE      ADMISSNO,ACAUADMN
          ENDIF
.
          MATCH     "A",AUDITYPE
          IF        @EQUAL
            MOVE      "A",ACAUAUTY                  * Audit Type for ADD
          ELSE
            MATCH     "U",AUDITYPE                  
            IF        @EQUAL
              MOVE      "U",ACAUAUTY                * Audit Type for UPDATE
            ELSE
              MOVE      "V",ACAUAUTY                * Audit Type for VISIT
            ENDIF
          ENDIF
.
          MOVE      "W",ACAUTREC                    * ACC Type of Record
          CALL      WRTACAUD                        * Write record to accaudaf
.
MVACCW99  RETURN
.
.--------------------------------------------------------------
. Add record to ACC Audit file (accaudaf) for Referral Details
.--------------------------------------------------------------
MVACCREF  CALL      CLACCAUD
.
          MATCH     PTCLM011,Z70
          IF        !@EQUAL
            MOVE      PTCLM011,ACAUCLMN             * ACC Claim Number
          ENDIF
.
          MATCH     ADMISSNO,Z70
          IF        !@EQUAL
            MOVE      ADMISSNO,ACAUADMN             * Visit Number
          ENDIF
.
          MOVE      "R",ACAUTREC                    * ACC Type of Record
.
          MATCH     "A",UPDTTYPE
          IF        @EQUAL
            MOVE      "A",ACAUAUTY                  * Audit Type for ADD
          ENDIF
.
          MATCH     "U",UPDTTYPE
          IF        @EQUAL
            MOVE      "U",ACAUAUTY                  * Audit Type for UPDATE
          ENDIF
.
          MATCH     "D",UPDTTYPE
          IF        @EQUAL
            MOVE      "D",ACAUAUTY                  * Audit Type for DELETE
          ENDIF
.
          MATCH     SP70,UPDTTYPE
          IF        @EQUAL
            MOVE      "V",ACAUAUTY                  * Audit Type For VISIT
          ELSE
            MATCH     ACCRD003,SP70
            IF        !@EQUAL
              MOVE      ACCRD003,ACAURPTY       * Referral Provider Type(cat IW)
            ENDIF
          ENDIF
.
          CALL      WRTACAUD                        * Write record to accaudaf
.
MVACC999  RETURN
.
.--------------------------------------------------------------
.  Add record to ACC Audit file (accaudaf) for ACC Xmit status
.--------------------------------------------------------------
MVACCXML  CALL      CLACCAUD
.
          MATCH     ACCNUMBR,SP70
          IF        !@EQUAL
            MOVE      ACCNUMBR,ACAUCLMN
          ELSE
            MOVE      PTCLM011,ACAUCLMN
          ENDIF
.
          MATCH     ADMISSNO,Z70
          IF        !@EQUAL
            MOVE      ADMISSNO,ACAUADMN
          ENDIF
.
          MOVE      "S",ACAUAUTY                    * Audit Type 
          MOVE      "A",ACAUTREC                    * ACC Type of Record
          CALL      WRTACAUD                        * Write record to accaudaf
.
MVACCX99  RETURN
.
.-------------------------------------------------------------------------------
.  Add record to ACC Audit file (accaudaf) for an existing Claim Number update
.-------------------------------------------------------------------------------
MVACCUPD  CALL      CLACCAUD
.
          MATCH     ACCNUMBR,SP70
          IF        !@EQUAL
            MOVE      ACCNUMBR,ACAUCLMN
          ELSE
            MOVE      PTCLM011,ACAUCLMN
          ENDIF
.
          MATCH     ADMISSNO,Z70
          IF        !@EQUAL
            MOVE      ADMISSNO,ACAUADMN
          ENDIF
.
          MOVE      "U",ACAUAUTY                    * Audit Type 
          MOVE      "A",ACAUTREC                    * ACC Type of Record
          CALL      WRTACAUD                        * Write record to accaudaf
.
MVACCU99  RETURN
.-----------------------------------------------------------------
.  Add record to ACC Audit file (accaudaf) for a New ACC Number 
.-----------------------------------------------------------------
MVACCADD  CALL      CLACCAUD
.
          MATCH     PTCLM011,SP70
          IF        !@EQUAL
            MOVE      PTCLM011,ACAUCLMN
          ELSE
            MOVE      PTCLM011,ACAUCLMN
          ENDIF
.
          MATCH     ADMISSNO,Z70
          IF        !@EQUAL
            MOVE      ADMISSNO,ACAUADMN
          ENDIF
.
          MOVE      "A",ACAUAUTY                    * Audit Type 
          MOVE      "A",ACAUTREC                    * ACC Type of Record
          CALL      WRTACAUD                        * Write record to accaudaf
.
MVACCA99  RETURN
.-----------------------------------------------------------------------------
. Add record to ACC Audit file when patient changed to non-comp. claim
.-----------------------------------------------------------------------------
MVACCREM  PACK      KEY8,ADMISSNO,SP70
          CALL      RDWCOM1
          BRANCH    OVRCD,MVACR999
.
          CALL      CLACCAUD
          MATCH     WCCLMNO,Z70
          IF        !@EQUAL
            MOVE      WCCLMNO,ACAUCLMN              * Claim Number
          ENDIF
.
          MATCH     ADMISSNO,Z70
          IF        !@EQUAL
            MOVE      ADMISSNO,ACAUADMN             * Admission No
          ENDIF
.
          MOVE      "D",ACAUAUTY                    * Audit Type
          MOVE      "A",ACAUTREC                    * ACC Type of Record
          CALL      WRTACAUD                        * Write record to accaudaf
.
MVACR999  RETURN
.-------------------------------------------------------------------------
. Write record to ACC Audit File (accaudaf)
.-------------------------------------------------------------------------
WRTACAUD  CALL      IBACLOCK
          PACK      ACAUDATE,CCC,CYY,CMM,CDD        * Date
          REP       " 0",ACAUDATE
          MOVE      CTIMEIS,ACAUTIME
          MOVE      USERID,ACAUWUID                 * Web UserId
.
WRTACA10  PACK      KEY54,ACAUCLMN,ACAUADMN,ACAUDATE,ACAUTIME,ACAUWUID
          CALL      RAACAUD1
          IF        OVRCD=1
            CALL      WRACAUD1
            GOTO      WRTACA99
          ELSE
            CALL      IBACLOCK                    * Set new date and time and
            PACK      ACAUDATE,CCC,CYY,CMM,CDD    * try write again
            REP       " 0",ACAUDATE
            CLOCK     TIME,CTIMEIS
            PACK      ACAUTIME,CTIMEIS
            REP       " 0",ACAUTIME
            GOTO      WRTACA10
          ENDIF
.
WRTACA99  RETURN
.
.------------------------------------------------------------
. REFR0000 - ACC Referral details
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
REFR0000  MATCH     SP70,UPDTTYPE      * Display
          GOTO      REFR8000 IF EQUAL
          MATCH     "A",UPDTTYPE       * Add New
          GOTO      REFR1000 IF EQUAL
          MATCH     "U",UPDTTYPE       * Update
          GOTO      REFR2000 IF EQUAL
          MATCH     "D",UPDTTYPE       * Delete
          GOTO      REFR3000 IF EQUAL
.
.         Add Formaction
.
REFR1000  PACK      KEY23,PTCLM011,Z70
          CALL      RSACRFP1
REFR1100  CALL      RPACRFP1
          BRANCH    OVRCD,REFR1130
.
          MATCH     PTCLM011,ACRFACCN         * same ACC Number?
          GOTO      REFR1130 IF NOT EQUAL
.
REFR1120  ADD       ONE,ACRFCONT              * get Next Count value
          GOTO      REFR1140
.
REFR1130  MOVE      ONE,ACRFCONT
.
REFR1140  CALL      MVACCR00
          CALL      WRACRFP1
          IF        PTCNHDPS=1 
            CALL      MVACCREF                * Move data to Audit File
          ENDIF
          MOVE      ZERO,EXIT
          GOTO      REFR9999
.
.         Update Formaction
.
REFR2000  PACK      KEY23,PTCLM011,ACCRD002,SP70
          CALL      RDACRFP1
          BRANCH    OVRCD,REFR9800
.
          CALL      MVACCR00
          CALL      UPACRFP1
          IF        PTCNHDPS=1            
            CALL      MVACCREF                * Move data to Audit File
          ENDIF
          MOVE      ZERO,EXIT
          GOTO      REFR9999
.
.         Delete Formaction
.
REFR3000  PACK      KEY23,PTCLM011,ACCRD002,SP70
          CALL      RDACRFP1
          BRANCH    OVRCD,REFR9800
.
          CALL      DEACRFP1
          IF        PTCNHDPS=1            
            CALL      MVACCREF                * Move data to Audit File
          ENDIF
          MOVE      ZERO,EXIT
          GOTO      REFR9999
.
REFR8000  MATCH     SP70,PTCLM011
          IF        !@EQUAL
            PACK      KEY23,PTCLM011,ACCRD002,SP70
            CALL      RDACRFP1
          ENDIF
.
          CALL      PATNAM00
          CLEAR     WEBTITLE
          APPEND    PATFNAME,WEBTITLE
          APPEND    " - Referral Details",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00
          BRANCH    EXIT,REFR9999
          CALL      WEBBOD00
          CALL      WEBEND00
          MOVE      ONE,EXIT
          GOTO      REFR9999
.
REFR9800  MOVE      "Record does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      REFR9999
.
REFR9900  MOVE      "Record already exists for this patient",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      REFR9999
.
REFR9999  RETURN
+
.------------------------------------------------------------
.  Update ACCRFPFD file
.   Move CGI Variables to file variables
.------------------------------------------------------------
MVACCR00  MATCH     PTCLM011,Z70
          IF        !@EQUAL
            MOVE      PTCLM011,ACRFACCN
          ENDIF
.
          MATCH     ACCRD003,SP70
          IF        !@EQUAL
            MOVE      ACCRD003,ACRFRPRT
          ENDIF
.
          MATCH     ACCRD004,Z70
          IF        !@EQUAL
            MOVE      ACCRD004,ACRFOPRT
          ENDIF
.
          MATCH     ACCRD005,Z70
          IF        !@EQUAL
            MOVE      ACCRD005,ACRFSTC1
          ENDIF
.
          MATCH     ACCRD006,Z70
          IF        !@EQUAL
            MOVE      ACCRD006,ACRFSTC2
          ENDIF
.
          MATCH     ACCRD007,Z70
          IF        !@EQUAL
            MOVE      ACCRD007,ACRFSTC3
          ENDIF
.
MVACCR99  RETURN
.------------------------------------------------------------
. GETV0000 - Get Diagnosis/ Referral/Xmit Values
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
GETV0000  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,GETV0100,GETV0200,GETV0300,GETV0400,GETV0500:
                       GETV0600,GETV0700,GETV0800,GETV0900
.
          GOTO      GETV9999
.
GETV0100  WRITE     HTMLFILE;DACDICNT;
          GOTO      GETV9999
.
GETV0200  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,GETV0210,GETV0220
.
GETV0210  WRITE     HTMLFILE;ACDIDIAG       * Diagnosis Code
          GOTO      GETV9999
.
GETV0220  PACK      KEY9,ACDIDIAG
          CALL      RDEMICD1
          BRANCH    OVRCD,GETV9999
.
          WRITE     HTMLFILE;EMICDESC       * Diagnosis Description
          GOTO      GETV9999
.
GETV0300  WRITE     HTMLFILE;ACDICSYC
          GOTO      GETV9999
.
GETV0400  WRITE     HTMLFILE;ACDISIDE
          GOTO      GETV9999
.
GETV0500  WRITE     HTMLFILE;DACRFCNT;
          GOTO      GETV9999
.
GETV0600  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,GETV0610,GETV0620,GETV0630
.
GETV0610  WRITE     HTMLFILE;ACRFRPRT;
          GOTO      GETV9999
.
GETV0620  MOVE      "IW",CATEGORY
          MOVE      ACRFRPRT,CODE
          CALL      CODSEL00
          GOTO      GETV9999
.
GETV0630  MOVE      "IW",CATEGORY
          MOVE      SP70,CODE
          CALL      CODSEL00
          GOTO      GETV9999
.
GETV0700  WRITE     HTMLFILE;ACRFOPRT;
          GOTO      GETV9999
.
GETV0800  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,GETV0810,GETV0820,GETV0830
.
GETV0810  WRITE     HTMLFILE;ACRFSTC1;
          GOTO      GETV9999
.
GETV0820  WRITE     HTMLFILE;ACRFSTC2;
          GOTO      GETV9999
.
GETV0830  WRITE     HTMLFILE;ACRFSTC3;
          GOTO      GETV9999
.
GETV0900  MOVE      ZERO,EXIT                    * ACC Xmit status
          OPEN      ACCLODA1,"acclodaf"
          PACK      KEY20,ACCNUMBR,SP20
          CALL      RDACLOD1
          BRANCH    OVRCD,GETV9999
          UNPACK    DIM127,D1,KEY1,DIM127        * ACC Xmit status
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,GETV0901,GETV0902,GETV0903
          WRITE     HTMLFILE;ACLOSTAT;
          GOTO      GETV9999
GETV0901  MOVE      ACLOSTAT,F1
          ADD       ONE,F1
          LOAD      DIM50,F1,SUBMITED,SENT,RECEIPTD,FAILED,FAILED1:
                             FAILED2,FAILED3,FAILED4,FAILED5
          WRITE     HTMLFILE;DIM50;
          GOTO      GETV9999
GETV0902  MOVE      ACLOSTAT,F1
          IF        F1 = 0
            WRITE    HTMLFILE;"<option value=0 selected>",SUBMITED,"</option>":
                              "<option value=1>",SENT,"</option>":
                              "<option value=2>",RECEIPTD,"</option>":
                              "<option value=3>",FAILED,"</option>";
          ENDIF
          IF        F1 = 1
            WRITE    HTMLFILE;"<option value=0>",SUBMITED,"</option>":
                              "<option value=1 selected>",SENT,"</option>":
                              "<option value=2>",RECEIPTD,"</option>":
                              "<option value=3>",FAILED,"</option>";
          ENDIF
          IF        F1 = 2
            WRITE    HTMLFILE;"<option value=0>",SUBMITED,"</option>":
                              "<option value=1>",SENT,"</option>":
                              "<option value=2 selected>",RECEIPTD,"</option>":
                              "<option value=3>",FAILED,"</option>";
          ENDIF
          IF        F1 = 3
            WRITE    HTMLFILE;"<option value=0>",SUBMITED,"</option>":
                              "<option value=1>",SENT,"</option>":
                              "<option value=2>",RECEIPTD,"</option>":
                              "<option value=3 selected>",FAILED,"</option>";
          ENDIF
          GOTO      GETV9999
.
GETV0903  WRITE    HTMLFILE;"<option value=0 selected>",SUBMITED,"</option>":
                            "<option value=1>",SENT,"</option>":
                            "<option value=2>",RECEIPTD,"</option>":
                            "<option value=3>",FAILED,"</option>":
                            "<option value=4>",FAILED1,"</option>":
                            "<option value=5>",FAILED2,"</option>":
                            "<option value=6>",FAILED3,"</option>":
                            "<option value=7>",FAILED4,"</option>":
                            "<option value=9>",FAILED5,"</option>";
          GOTO      GETV9999
.
GETV9999  RETURN
+
.------------------------------------------------------------
.  GETACC00 - Get ACC Comments
.------------------------------------------------------------
GETACC00  PACK      KEY26,WCCLMNO,COMMTYPE,SP70
          CALL      RSACCMT1
GETACC10  CALL      RKACCMT1
          BRANCH    OVRCD,GETACC99
.
          MATCH     WCCLMNO,ACCMACCN           * same ACC Number?
          GOTO      GETACC99 IF NOT EQUAL
.
          MATCH     COMMTYPE,ACCMTYPE          * same Comment Type?
          GOTO      GETACC99 IF NOT EQUAL
.
          IF        @EQUAL
            STRIP     ACCMDATA
            MOVELPTR  ACCMDATA,TXTLEN
            IF        TXTLEN>0
              SFORMAT   VAR,TXTLEN
            ELSE
              SFORMAT   VAR,ONE
            ENDIF
            MOVE      ACCMDATA,VAR
            WRITE     HTMLFILE;VAR             * Line Details
            SFORMAT   VAR,127
          ENDIF
          GOTO      GETACC10
.
GETACC99  RETURN
.------------------------------------------------------------
. AICMN000 - Additional Injury Comments
.------------------------------------------------------------
.         copy the comments back to file
.         first delete existing comments
.
AICMN000  MOVE      "002",COMMTYPE
          PACK      KEY26,PTCLM011,COMMTYPE,SP70
          CALL      RSACCMT1
AICMN100  CALL      RKACCMT1
          BRANCH    OVRCD,AICMN500             * end of file
.
          MATCH     PTCLM011,ACCMACCN          * same ACC Number?
          GOTO      AICMN500 IF NOT EQUAL
.
          MATCH     COMMTYPE,ACCMTYPE          * same Count Type?
          GOTO      AICMN500 IF NOT EQUAL
.
          PACK      KEY26,ACCMACCN,ACCMTYPE,DACCMLIN
          CALL      DEACCMT1
          GOTO      AICMN100
.
.         now write the new comments back
.
AICMN500  MOVE      PTCLM011,ACCMACCN          * set ACC Number
          MOVE      COMMTYPE,ACCMTYPE
          MOVE      ZERO,ACCMLINE
          MOVE      ZERO,F3
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      COMAIJAF,COMAIJNM
          TRAPCLR   IO
          BRANCH    OVRCD,AICMN999
.
AICMN510  ADD       ONE,ACCMLINE               * add to line number
          ADD       ONE,F3
          READ      COMAIJAF,SEQ;ACCMDATA
.
          MATCH     SP70,ACCMDATA
          IF        @EQUAL
            IF        F3>=LASTITM4
              GOTO      AICMN999
            ELSE
              GOTO      AICMN510
            ENDIF
          ENDIF
.
          MOVE      ACCMLINE,DACCMLIN          * Move line number
          PACK      KEY26,ACCMACCN,ACCMTYPE,DACCMLIN
          CALL      WRACCMT1
          IF        F3>=LASTITM4
            GOTO      AICMN999
          ENDIF
          GOTO      AICMN510
.
AICMN999  RETURN
+
.------------------------------------------------------------
. CICMN000 - Cause of Injury Comments
.------------------------------------------------------------
.         copy the comments back to file
.         first delete existing comments
.
CICMN000  MOVE      "001",COMMTYPE
          PACK      KEY26,PTCLM011,COMMTYPE,SP70
          CALL      RSACCMT1
CICMN100  CALL      RKACCMT1
          BRANCH    OVRCD,CICMN500             * end of file
.
          MATCH     PTCLM011,ACCMACCN          * same ACC Number?
          GOTO      CICMN500 IF NOT EQUAL
.
          MATCH     COMMTYPE,ACCMTYPE          * same Count Type?
          GOTO      CICMN500 IF NOT EQUAL
.
          PACK      KEY26,ACCMACCN,ACCMTYPE,DACCMLIN
          CALL      DEACCMT1
          GOTO      CICMN100
.
.         now write the new comments back
.
CICMN500  MOVE      PTCLM011,ACCMACCN          * set ACC Number
          MOVE      COMMTYPE,ACCMTYPE
          MOVE      ZERO,ACCMLINE
          MOVE      ZERO,F3
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      COMCIJAF,COMCIJNM
          TRAPCLR   IO
          BRANCH    OVRCD,CICMN999
.
CICMN510  ADD       ONE,ACCMLINE               * add to line number
          ADD       ONE,F3
          READ      COMCIJAF,SEQ;ACCMDATA
.
          MATCH     SP70,ACCMDATA
          IF        @EQUAL
            IF        F3>=LASTITM5
              GOTO      CICMN999
            ELSE
              GOTO      CICMN510
            ENDIF
          ENDIF
.
          MOVE      ACCMLINE,DACCMLIN          * Move line number
          PACK      KEY26,ACCMACCN,ACCMTYPE,DACCMLIN
          CALL      WRACCMT1
          IF        F3>=LASTITM5
            GOTO      CICMN999
          ENDIF
          GOTO      CICMN510
.
CICMN999  RETURN
+
.------------------------------------------------------------
. AWCMN000 - Alternative Work Restriction Comments
.------------------------------------------------------------
.         copy the comments back to file
.         first delete existing comments
.
AWCMN000  MOVE      "003",COMMTYPE
          PACK      KEY26,PTCLM011,COMMTYPE,SP70
          CALL      RSACCMT1
AWCMN100  CALL      RKACCMT1
          BRANCH    OVRCD,AWCMN500             * end of file
.
          MATCH     PTCLM011,ACCMACCN          * same ACC Number?
          GOTO      AWCMN500 IF NOT EQUAL
.
          MATCH     COMMTYPE,ACCMTYPE          * same Count Type?
          GOTO      AWCMN500 IF NOT EQUAL
.
          PACK      KEY26,ACCMACCN,ACCMTYPE,DACCMLIN
          CALL      DEACCMT1
          GOTO      AWCMN100
.
.         now write the new comments back
.
AWCMN500  MOVE      PTCLM011,ACCMACCN          * set ACC Number
          MOVE      COMMTYPE,ACCMTYPE
          MOVE      ZERO,ACCMLINE
          MOVE      ZERO,F3
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      COMAWKAF,COMAWKNM
          TRAPCLR   IO
          BRANCH    OVRCD,AWCMN999
.
AWCMN510  ADD       ONE,ACCMLINE               * add to line number
          ADD       ONE,F3
          READ      COMAWKAF,SEQ;ACCMDATA
.
          MATCH     SP70,ACCMDATA
          IF        @EQUAL
            IF        F3>=LASTITM6
              GOTO      AWCMN999
            ELSE
              GOTO      AWCMN510
            ENDIF
          ENDIF
.
          MOVE      ACCMLINE,DACCMLIN          * Move line number
          PACK      KEY26,ACCMACCN,ACCMTYPE,DACCMLIN
          CALL      WRACCMT1
          IF        F3>=LASTITM6
            GOTO      AWCMN999
          ENDIF
          GOTO      AWCMN510
.
AWCMN999  RETURN
+
.-------------------------------------------------------------------------
. SPRGM000 - Set Parameters for Admission Multiple Regime Codes
. Returns:    EXIT   0
.                    1
.-------------------------------------------------------------------------
.
SPRGM000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SPRGM010,SPRGM020,SPRGM030
.
          GOTO      SPRGM910
.
SPRGM010  MOVE      QRYDATA,PTRGM001
          GOTO      SPRGM900
.
SPRGM020  MOVE      QRYDATA,PTRGM002
          GOTO      SPRGM900
.
SPRGM030  MOVE      QRYDATA,PTRGM003
          GOTO      SPRGM900
.
SPRGM900  MOVE      ZERO,EXIT
          GOTO      SPRGM999
.
SPRGM910  MOVE      ONE,EXIT
.
SPRGM999  RETURN
+
.-------------------------------------------------------------------------
. UPPRGM00 - Write Multiple Regime Codes to patrgmaf.
.-------------------------------------------------------------------------
UPPRGM00  MOVE      ONE,F1
.
UPPRGM10
.         LOAD      PTRGREGM,F1,PTRGM001,PTRGM002,PTRGM003
          MOVE      AADMNO,PTRGADMN
          PACK      PTRGCNTR,SP1,F1
.         MOVE      WBSEUID,PTRGCUID
.         CALL      IBACLOCK
.         PACK      PTRGCDAT,CCC,CYY,CMM,CDD
.         REP       " 0",PTRGCDAT
.         MOVE      CTIMEIS,PTRGCTIM
.         MOVE      SP70,PTRGSPAR
.
          PACK      KEY10,PTRGADMN,PTRGCNTR,SP70
          CALL      RAPTRGM1
          IF        OVRCD=0
            LOAD      PTRGREGM,F1,PTRGM001,PTRGM002,PTRGM003
            CALL      UPPTRGM1
          ELSE
            LOAD      PTRGREGM,F1,PTRGM001,PTRGM002,PTRGM003
            MOVE      WBSEUID,PTRGCUID
            CALL      IBACLOCK
            PACK      PTRGCDAT,CCC,CYY,CMM,CDD
            REP       " 0",PTRGCDAT
            MOVE      CTIMEIS,PTRGCTIM
            MOVE      SP70,PTRGSPAR
            CALL      WRPTRGM1
          ENDIF
.
          COMPARE   THREE,F1
          GOTO      UPPRGM99 IF EQUAL
          ADD       ONE,F1
          GOTO      UPPRGM10
.
UPPRGM99  RETURN
.-------------------------------------------------------------------------
. GETRGM00 - Get Multiple Regime Code for Admission Number
.-------------------------------------------------------------------------
GETRGM00  UNPACK    DIM127,D1,KEY2,DIM127
.
          PACK      KEY10,ADMISSNO,KEY2,DIM127
          CALL      RDPTRGM1
          BRANCH    OVRCD,GETRGM99
.
          WRITE     HTMLFILE;PTRGREGM;
.
GETRGM99  RETURN
.
.-------------------------------------------------------------------------
.UPPBMN00 - Write/update the bed management table
.-------------------------------------------------------------------------
UPPBMN00  PACK      PTMIS004,PTMIS004,SP70
          PACK      PTMIS005,PTMIS005,SP70
          MATCH     SP70,PTMIS004
          GOTO      UPPBMN99 IF EQUAL
          GOTO      UPPBMN99 IF EOS
          MOVE      SP70,SAVEBRQN
.
          CALL      DELBMD00
.
          MOVE      ZERO,LOSDINDC              * Write/update patbmdaf
          MOVE      ADATE,SAVEDATE             * Bed management Detail Tab
          MOVE      ATIME,SAVETIME             * Length of Stay days
          MATCH     "1",KEEPBKTM
          IF        @EQUAL
            PACK      SAVEDATE,BKREEDAT,SP70
            PACK      SAVETIME,BKREATIM,SP70
          ENDIF
.
          MOVE      ZERO,LOOPDAYS
          SQUEEZE   PTMIS030
          MOVE      PTMIS030,LOOPDAYS
.
          IF        ASTAT=2
            PACK      KEY8,AADMNO,SP70
            CALL      RDPMWOR1                 
            IF        OVRCD=1
              CALL      CLPMWO00                 * Use the expected discharge
            ENDIF                                * date if a current admission
.                                                * instead of SAVEDATE plus
            MATCH     SP70,PMWOEDAT              * ASTAY
            IF        !@EQUAL
              DAYSEP    SAVEDATE,PMWOEDAT,LOOPDAYS
            ENDIF
          ENDIF
.
. Restrict to latest 12 weeks to avoid timeout error from old admissions etc.
.
          IF        LOOPDAYS>84
            UNPACK    SAVEDATE,CCENT,CYEAR,CMON,CDAY
            ASSIGN    LOOPDAYS-84,ADJDAYS
            CALL      ADJDAT00
            PACK      SAVEDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      84,LOOPDAYS
          ENDIF
.
UPPBMN30  COMPARE   ZERO,LOOPDAYS
          GOTO      UPPBMN50 IF EQUAL
.
          MOVE      TWO,LOSDINDC
.
          MATCH     "030",TEMPLATE
          IF        @EQUAL
            PACK      KEY30,AADMNO,SAVEDATE,Z70
            CALL      RDSTRAN2
            CALL      RDPTRAN2
            BRANCH    OVRCD,UPPBMN35
.
            MATCH     DAADMNO,DTADMN
            GOTO      UPPBMN35 IF NOT EQUAL
.
            MOVE      TWARD,PTBDWARD
            MOVE      TBED,PTBDWBED
          ELSE
UPPBMN35    MOVE      PTMIS004,PTBDWARD
            MOVE      PTMIS005,PTBDWBED
          ENDIF
.
          MOVE      SAVEDATE,PTBDDATE
          MOVE      SAVETIME,PTBDADTM
          MOVE      LOOPDAYS,PTBDLOSD
          CALL      GTTOTM00
          MOVE      ADJTIME,PTBDLOSM
          MOVE      SP70,PTBDOPPE
          MOVE      AADMNO,PTBDADMN
.
          IF        ASTAT=1
            IF        ADMITBOX=1
              MOVE      "3",PTBDSTAT
            ELSE
              MOVE      "2",PTBDSTAT
            ENDIF
          ENDIF
.
          IF        ASTAT=2
            MOVE      "3",PTBDSTAT
          ENDIF
.
          MOVE      "0",PTBDOVER
          MOVE      SAVEBRQN,PTBDBRQN
          MOVE      SP70,PTBDSPAR
.
          PACK      KEY30,PTBDWARD,PTBDWBED,PTBDDATE,PTBDADTM,SP3,PTBDADMN,SP70
          CALL      RAPTBMD1
          IF        OVRCD=1
            TRAP      OVERCOND IF IO
            CALL      WRPTBMD1
            TRAPCLR   IO
          ELSE
            CALL      UPPTBMD1
          ENDIF
.
          SUB       ONE,LOOPDAYS
          UNPACK    SAVEDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      "1",ADJDAYS
          CALL      ADJDAT00
          PACK      SAVEDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      "00:00",SAVETIME
          GOTO      UPPBMN30
.
UPPBMN50  CALL      GTTOTM00                       * Write/update patbmdaf
          COMPARE   TWO,LOSDINDC
          IF        @EQUAL
            MOVE      SAVEDATE,PTBDDATE
            MOVE      SAVETIME,PTBDADTM
          ELSE
            MOVE      ADATE,PTBDDATE
            MOVE      ATIME,PTBDADTM
            MATCH     "1",KEEPBKTM
            IF        @EQUAL
              MOVE      BKREEDAT,PTBDDATE
              MOVE      BKREATIM,PTBDADTM
            ENDIF
            MOVE      ONE,LOSDINDC
          ENDIF
.
          MATCH     "030",TEMPLATE
          IF        @EQUAL
            PACK      KEY30,AADMNO,PTBDDATE,Z70
            CALL      RDSTRAN2
            CALL      RDPTRAN2
            BRANCH    OVRCD,UPPBMN55
.
            MATCH     DAADMNO,DTADMN
            GOTO      UPPBMN55 IF NOT EQUAL
            MOVE      TWARD,PTBDWARD
            MOVE      TBED,PTBDWBED
          ELSE
UPPBMN55    MOVE      PTMIS004,PTBDWARD
            MOVE      PTMIS005,PTBDWBED
          ENDIF
.
          MOVE      ADJTIME,PTBDLOSM
          MOVE      "  0",PTBDLOSD
          MOVE      SP70,PTBDOPPE
          MOVE      AADMNO,PTBDADMN
.
          IF        ASTAT=1
            IF        ADMITBOX=1
              MOVE      "3",PTBDSTAT
            ELSE
              MOVE      "2",PTBDSTAT
            ENDIF
          ENDIF
.
          IF        ASTAT=2
            MOVE      "3",PTBDSTAT
          ENDIF
.
          MOVE      "0",PTBDOVER
          MOVE      SAVEBRQN,PTBDBRQN
          MOVE      SP70,PTBDSPAR
.
          PACK      KEY30,PTBDWARD,PTBDWBED,PTBDDATE,PTBDADTM,SP3,PTBDADMN,SP70
          CALL      RAPTBMD1
          IF        OVRCD=1
            TRAP      OVERCOND IF IO
            CALL      WRPTBMD1
            TRAPCLR   IO
          ELSE
            CALL      UPPTBMD1
          ENDIF
.
          MOVE      PTBDDATE,SAVEDATE
.
UPPBMN70  COMPARE   ZERO,LOSDINDC                         * Override previous
          GOTO      UPPBMN99 IF EQUAL                     * Records in patbmdaf
.
          MATCH     SP70,PTMIS005
          GOTO      UPPBMN99 IF EQUAL
          GOTO      UPPBMN99 IF EOS
.
          MOVE      ATIME,DIM5
          PACK      KEY30,PTMIS004,PTMIS005,ADATE,DIM5,SP3,AADMNO,SP70
          MATCH     "1",KEEPBKTM
          IF        @EQUAL
            PACK      KEY30,PTMIS004,PTMIS005,BKREEDAT,BKREATIM,SP3,AADMNO,SP70
          ENDIF
          CALL      RDPTBMD1
          BRANCH    OVRCD,UPPBMN99
.
          MOVE      PTBDDATE,SAVEDATE
          MOVE      PTBDADTM,SAVETIME
          MOVE      PTBDLOSD,SAVELOSD
          MOVE      PTBDLOSM,SAVELOSM
.
UPPBMN73  CALL      RPPTBMD1
          BRANCH    OVRCD,UPPBMN80
.
          MATCH     PTMIS004,PTBDWARD
          GOTO      UPPBMN80 IF NOT EQUAL
.
          MATCH     PTMIS005,PTBDWBED
          GOTO      UPPBMN80 IF NOT EQUAL
.
          MATCH     SAVEDATE,PTBDDATE
          GOTO      UPPBMN80 IF NOT EQUAL
.
          MOVE      PTBDDATE,STRTDATE
          MOVE      PTBDADTM,STRTTIME
          MOVE      PTBDLOSM,ADJTIME
          MOVE      PTBDLOSD,ADJDAYS
          CALL      GETEDT00
.
          MATCH     EXPDSDTE,SAVEDATE
          IF        @LESS
            GOTO      UPPBMN78
          ENDIF
          GOTO      UPPBMN73 IF NOT EQUAL
.
          MATCH     EXPDSTME,SAVETIME
          IF        @EQUAL | @LESS
            GOTO      UPPBMN78
          ENDIF
.
          GOTO      UPPBMN73
.
UPPBMN78  MOVE      ONE,PTBDOVER
          CALL      UPPTBMD1
.
          GOTO      UPPBMN73
.
UPPBMN80  PACK      KEY30,PTMIS004,PTMIS005,AADMNO,Z70    * Override following
          CALL      RSPTBMD3                              * Records in patbmdaf
          CALL      RPPTBMD3
          BRANCH    OVRCD,UPPBMN99
.
          MATCH     DAADMNO,PTBDADMN
          GOTO      UPPBMN99 IF NOT EQUAL
.
          MOVE      SAVEDATE,STRTDATE
          MOVE      SAVETIME,STRTTIME
          MOVE      PTBDLOSM,ADJTIME
          MOVE      SAVELOSD,ADJDAYS
          CALL      GETEDT00
.
          PACK      KEY30,PTMIS004,PTMIS005,SAVEDATE,SAVETIME,SP3,DAADMNO,SP70
          CALL      RDPTBMD1
          BRANCH    OVRCD,UPPBMN99
.
UPPBMN85  CALL      RKPTBMD1
          BRANCH    OVRCD,UPPBMN99
.
          MATCH     PTMIS004,PTBDWARD
          GOTO      UPPBMN99 IF NOT EQUAL
.
          MATCH     PTMIS005,PTBDWBED
          GOTO      UPPBMN99 IF NOT EQUAL
.
          MATCH     DAADMNO,PTBDADMN
          GOTO      UPPBMN85 IF EQUAL
.
          MATCH     EXPDSDTE,PTBDDATE
          IF        @LESS
            GOTO      UPPBMN88
          ENDIF
          GOTO      UPPBMN85 IF NOT EQUAL
.
          MATCH     EXPDSTME,PTBDADTM
          IF        @EQUAL | @LESS
            GOTO      UPPBMN88
          ENDIF
          GOTO      UPPBMN85
.
UPPBMN88  MOVE      "1",PTBDOVER
          CALL      UPPTBMD1
          GOTO      UPPBMN85
.
UPPBMN99  RETURN
+
.-------------------------------------------------------------------------
.GTTOTM00 - Get total time for regime codes
.-------------------------------------------------------------------------
GTTOTM00  OPEN      PMSREGA1,"pmsregaf"
          MOVE      ZERO,ADJTIME
          MOVE      ONE,F1
          MOVE      SP70,DIM10
GTTOTM10  COMPARE   F1,FOUR
          GOTO      GTTOTM99 IF EQUAL
          LOAD      DIM10,F1,PTRGM001,PTRGM002,PTRGM003
.
          PACK      DIM10,DIM10,SP70
          MATCH     SP70,DIM10
          IF        @EQUAL|@EOS
            ADD       ONE,F1
            GOTO      GTTOTM10
          ENDIF
.
          PACK      KEY13,DIM10,SP1,SP1,ZERO,SP70
          CALL      RDPMREG1
          IF        OVRCD=1
            ADD       ONE,F1
            GOTO      GTTOTM10
          ENDIF
.
          MOVE      ZERO,FORM3
          SQUEEZE   PMREELOS
          MOVE      PMREELOS,FORM3
          ADD       FORM3,ADJTIME
          ADD       ONE,F1
          GOTO      GTTOTM10
.
GTTOTM99  CLOSE     PMSREGA1
          RETURN
.
.-------------------------------------------------------------------------
.GETEDT00 - Get Expected Discharge Date and Time
.-------------------------------------------------------------------------
GETEDT00  COMPARE   ZERO,ADJDAYS
          IF        @EQUAL
            MOVE      STRTDATE,EXPDSDTE
            GOTO      GETEDT50
          ENDIF
.
          UNPACK    STRTDATE,CCENT,CYEAR,CMON,CDAY
          CALL      ADJDAT00
          PACK      EXPDSDTE,CCENT,CYEAR,CMON,CDAY
.
GETEDT50  COMPARE   ZERO,ADJTIME
          IF        @EQUAL
            MOVE      STRTTIME,EXPDSTME
            GOTO      GETEDT99
          ENDIF
.
          CALL      CLDUR000
          MOVE      KEY5,EXPDSTME
.
GETEDT99  RETURN
.
.-----------------------------------------------------------------------------
. CLDUR000 - Calculate Expected Discharge Time
.-----------------------------------------------------------------------------
.
CLDUR000  UNPACK    STRTTIME,CHOUR,ANS,CMIN * unpack the start time
          MOVE      CMIN,FORM2              * minutes as a form2
          MOVE      FORM2,FORM4A            * set up work variable
          ADD       ADJTIME,FORM4A          * the total minutes to add
.
CLDUR200  COMPARE   ZERO,FORM4A
          GOTO      CLDUR300 IF NOT LESS    * positve amount
.
          ADD       "60",FORM4A             * make it positive
          MOVE      CHOUR,OPTION
          SUB       ONE,OPTION
          MOVE      OPTION,CHOUR            * sub 1 hour off time
          GOTO      CLDUR200
.
CLDUR300  MOVE      FORM4A,FORM4B           * save the minutes
.
          DIV       "60",FORM4A             * the total hours to add
          MOVE      CHOUR,FORM2             * hours as a form
          ADD       FORM4A,FORM2            * add the hours
.
CLDUR400  COMPARE   "24",FORM2
          GOTO      CLDUR500 IF LESS        * below 24 hours
.
          SUB       "24",FORM2              * get back to 24 hour time
.
          UNPACK    EXPDSDTE,CCENT,CYEAR,CMON,CDAY
          MOVE      "1",ADJDAYS
          CALL      ADJDAT00
          PACK      EXPDSDTE,CCENT,CYEAR,CMON,CDAY
.
          GOTO      CLDUR400
.
CLDUR500  MOVE      FORM2,CHOUR             * set up the hours
.
          MULT      "60",FORM4A             * the total minutes added
          SUB       FORM4A,FORM4B           * the minutes to add
          MOVE      FORM4B,FORM2            * get minutes as form2
.
          COMPARE   ZERO,FORM2
          GOTO      CLDUR800 IF NOT LESS    * not negative
.
          ADD       "60",FORM2              * make it positive
          MOVE      CHOUR,OPTION
          SUB       ONE,OPTION
          MOVE      OPTION,CHOUR            * sub 1 hour off time
.
CLDUR800  MOVE      FORM2,CMIN              * the minutes
.
          PACK      KEY5,CHOUR,COLON,CMIN * the end time
          REP       " 0",KEY5
.
CLDUR999  RETURN
.
.-----------------------------------------------------------------------------
. PBDM0000 - Process Regimes and Bed Management
.-----------------------------------------------------------------------------
PBDM0000  MATCH     SP70,ACARE                            * Regimes
          IF        !@EQUAL & !@EOS
            PACK      KEY5,ANSC,ANSC,ACARE,SP70
            CALL      RDCODE1
            BRANCH    OVRCD,PBDM5000
.
            MATCH     "O",TCINDC2
            GOTO      PBDM5000 IF NOT EQUAL
            CALL      UPPRGM00
          ENDIF
.
PBDM5000  MATCH     "1",PTCNBMAN                          * Bed Management
          IF        @EQUAL
            CALL      UPPBMN00
          ENDIF
.
          IF        UPDRGDAT=1
            MOVE      "6",PTUNTYPE          * Change Provisional DRG
            MOVE      SAVPPDRG,PTUNOPRD
            MOVE      SP70,PTUNODTE
            MOVE      PMVXMHOS,PTUNHOSP
            CALL      WRUNA000
          ENDIF
.
PBDM9999  RETURN
.------------------------------------------------------------
. Check if the expected ward/bed matches the admitted ward/bed
. and update the status to completed.
.------------------------------------------------------------
BEDR0000  MOVE      ONE,BEDRFLAG                 * don't send bed request A08
.
          MATCH     SP70,EMADMISS
          IF        !@EQUAL
            PACK      KEY25,EMADMISS,SP70
          ELSE
            PACK      KEY25,ADMISSNO,SP70
          ENDIF
.
          CALL      RSPMBRQ2
BEDR1000  CALL      RKPMBRQ2
          BRANCH    OVRCD,BEDR9999
.
          MATCH     SP70,EMADMISS
          IF        !@EQUAL
            MATCH     EMADMISS,PMBRVISN
            GOTO      BEDR9999 IF NOT EQUAL
          ELSE
            MATCH     ADMISSNO,PMBRVISN
            GOTO      BEDR9999 IF NOT EQUAL
          ENDIF
.
          MATCH     " ",PMBRRSTA
          GOTO      BEDR2000 IF EQUAL
.
          MATCH     "1",PMBRRSTA
          GOTO      BEDR2000 IF EQUAL
.
          MATCH     "2",PMBRRSTA
          GOTO      BEDR2000 IF EQUAL
.
          GOTO      BEDR1000
.
BEDR2000  MATCH     SP70,AWARD
          IF        !@EQUAL
            PACK      KEY6,AWARD,SP70
            CALL      RDWARD1
            IF        OVRCD=0
              MATCH     SP70,WRTYPE
              IF        !@EQUAL
                MOVE      "RT",CATEGORY
                MOVE      WRTYPE,CODE
                CALL      GETCOD00
                MATCH     "N",TCINDC6
                GOTO      BEDR1000 IF EQUAL
                MATCH     "R",TCINDC6
                IF        @EQUAL
                  MATCH     "1",BEDRQQRY
                  GOTO      BEDR1000 IF NOT EQUAL
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      "3",PMBRRSTA            * Update status to completed
          CALL      UPPMBRQ2
.
          MOVE      ZERO,BEDRFLAG                * send bed request A08
.
          MATCH     SP70,EMADMISS
          IF        !@EQUAL
            MOVE      ADMISSNO,SAVEADMN
            MOVE      EMADMISS,ADMISSNO
            CALL      EXCL0000                * Clear expected patient
            MOVE      SAVEADMN,ADMISSNO
          ELSE
            CALL      EXCL0000                * Clear expected patient
          ENDIF
.
BEDR2900  MATCH     SP70,PMBREWRD
          GOTO      BEDR9999 IF EQUAL
.
          MATCH     AWARD,PMBREWRD
          GOTO      BEDR3000 IF NOT EQUAL
.
          MATCH     SP70,PMBREBED
          GOTO      BEDR9999 IF NOT EQUAL
.
          MATCH     ABED,PMBREBED
          GOTO      BEDR3000 IF NOT EQUAL
.
          GOTO      BEDR9999
.
BEDR3000  CLEAR     WEBTITLE
          APPEND    "Ward/Bed request mismatch - Please notify the",WEBTITLE
          APPEND    " bed allocator",WEBTITLE
          RESET     WEBTITLE
          ADD       ONE,WARCOUNT
          MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
.
BEDR9999  RETURN
.
.******************************************************************************
.         Update NZP funder contribution if not invoiced
.******************************************************************************
UFCN0000  COMPARE   FIVE,CFEETYP            * NZ Private only
          GOTO      UFCN9999 IF NOT EQUAL
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,UFCN9999
.
          OPEN      NZPPFEA1,"nzppfeaf"
          PACK      KEY11,ADMISSNO,SP70
          CALL      RSNZSPR1
UFCN2000  CALL      RKNZSPR1
          BRANCH    OVRCD,UFCN9000
.
          MATCH     ADMISSNO,NZSPADMN
          GOTO      UFCN9000 IF NOT EQUAL
.
          MATCH     "0",NZSPINVD             * Not invoice raised yet?
          GOTO      UFCN2000 IF NOT EQUAL
.
          MATCH     SP70,NZSPCPRC
          GOTO      UFCN2000 IF EQUAL        * No contract procedure
.
          CALL      NZCT0000                 * Check procedure if funder contr.
          IF        OVRCD=0
            MOVE      NZPFCONT,NZSPCONT
            CALL      UPNZSPR1
          ENDIF
.
          GOTO      UFCN2000
.
UFCN9000  CLOSE     NZPPFEA1
UFCN9999  RETURN
+
.******************************************************************************
.         Routine to setup NZP Funder Contribution flag
.******************************************************************************
NZCT0000  MOVE      ZERO,USEDEF
          PACK      KEY29 WITH PMVXMHOS,NZSPCLMN,NZSPCNTR,SP8,NZSPCPRC,SP70
.
NZCT1000  CALL      PEFD0000                * Get effective date
          MATCH     SP70,EFTDATE
          GOTO      NZCT2000 IF EQUAL
.
          PACK      KEY37,KEY29,EFTDATE,SP70
          CALL      RDNZPFE1
          COMPARE   ZERO,OVRCD
          GOTO      NZCT8000 IF EQUAL       * found the valid proc.fee record
.
NZCT2000  ADD       ONE,USEDEF
          BRANCH    USEDEF,NZCT3000,NZCT4000,NZCT5000
          MOVE      ONE,OVRCD
          GOTO      NZCT9999
.
NZCT3000  PACK      KEY29 WITH PMVXMHOS,NZSPCLMN,SP6,SP8,NZSPCPRC,SP70
          GOTO      NZCT1000
.
NZCT4000  OPEN      CONTROLF,"controlf"
          READ      CONTROLF,TWENTY;*193,PTCNDCLM
          CALL      CCLM0000        * Check Hospital claim code charging
          PACK      KEY29 WITH PMVXMHOS,PTCNDCLM,NZSPCNTR,SP8,NZSPCPRC,SP70
          GOTO      NZCT1000
.
NZCT5000  PACK      KEY29 WITH PMVXMHOS,PTCNDCLM,SP6,SP8,NZSPCPRC,SP70
          GOTO      NZCT1000
.
NZCT8000  MOVE      ZERO,OVRCD
NZCT9999  RETURN
+
.*******************************************************************************
.         PEFD0000 - Get Procedure fee effective date
.*******************************************************************************
PEFD0000  MOVE      SP70,EFTDATE
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          PACK      KEY37,KEY29,KEY8,SP70
          CALL      RDNZPFE1
          COMPARE   ZERO,OVRCD
          GOTO      PEFD4000 IF EQUAL
.
          CALL      RPNZPFE1                  * check for previous record
          BRANCH    OVRCD,PEFD9999
.
          PACK      DIM29 WITH NZPFHOSP,NZPFCLMC,NZPFCNTR,NZPFFTAB,NZPFCPRC:
                               SP70
          MATCH     DIM29,KEY29
          GOTO      PEFD9999 IF NOT EQUAL
.
PEFD4000  MOVE      NZPFEFDT,EFTDATE         * Save the effective date
PEFD9999  RETURN
.
.*******************************************************************************
.         Get default claim code charging
.*******************************************************************************
CCLM0000  OPEN      CONTROLF,"controlf"
.
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          IF        IBCNMHOS=1
            OPEN      PATHSPA1,"pathspaf"
            MOVE      PMVXMHOS,KEY3
            CALL      RDPTHSP1
            IF        OVRCD=0
              MOVE      PTHSDCLM,PTCNDCLM     * default claim code charging
            ENDIF
          ENDIF
.
          MATCH     SP70,PTCNDCLM
          IF        @EQUAL
            MOVE      "0  ",PTCNDCLM          * Use zero claim code
          ENDIF
.
CCLM9999  RETURN
+
.*******************************************************************************
.         Update booking details with preadmission details
.*******************************************************************************
UPBKD000  READ      CONTROLF,HUND14;*86,PTCNUBAP
.
          IF        PTCNHDPS=1
            COMPARE   ONE,ASTAT               * If NZ only update the booking if
            GOTO      UPBKD999 IF NOT EQUAL   * it's a pre admission
          ENDIF
.
          MATCH     "1",PTCNUBAP              * update both pread to booking
          IF        !@EQUAL
            MATCH     "3",PTCNUBAP            * update pread to booking
            IF        !@EQUAL
              MATCH     "4",PTCNUBAP          * Update Both, no diagnosis
              IF        !@EQUAL
                MATCH     "5",PTCNUBAP        * Upd Both, no diagnosis/procedure
                GOTO      UPBKD999 IF NOT EQUAL
              ENDIF
            ENDIF
          ENDIF
.
          PACK      KEY8,DAADMNO,SP70
          CALL      RDBKREC1
          BRANCH    OVRCD,UPBKD999
.
          MATCH     Z70,PTMIS007
          IF        !@EQUAL
            MOVE      ADOCTA,BKREADOC
          ENDIF
.
          MATCH     Z70,PTMIS006
          IF        !@EQUAL
            MOVE      ADOCTR,BKRESDOC
          ENDIF
.
          MATCH     Z70,PTMIS010
          IF        !@EQUAL
            MOVE      ATYPE,BKREATYP
          ENDIF
.
          MATCH     Z70,PTMIS011
          IF        !@EQUAL
            MOVE      ACLSS,BKRECLSS
          ENDIF
.
          MATCH     Z70,PTMIS012
          IF        !@EQUAL
            MOVE      ACARE,BKREEATY
          ENDIF
.
          MATCH     Z70,PTMIS024
          IF        !@EQUAL
            MOVE      ACLSSFT,BKREDEPT
          ENDIF
.
          MATCH     Z70,PTMIS027
          IF        !@EQUAL
            MOVE      ACLAIM,BKRECLMT
          ENDIF
.
          MATCH     Z70,PTMIS030
          IF        !@EQUAL
            MOVE      ASTAY,BKREELOS
          ENDIF
.
          MATCH     Z70,PTMIS057
          IF        !@EQUAL
            MOVE      PTMIDOFR,BKREDOFR
          ENDIF
.
          IF        PTCNHDPS = 1
            IF        ASTAT <> 3
              MATCH     Z70,PTMIS068
              IF        !@EQUAL
                MOVE      PTMIXWRD,BKREWARD
              ENDIF
            ENDIF
          ELSE
            MATCH     Z70,PTMIS068
            IF        !@EQUAL
              MOVE      PTMIXWRD,BKREWARD
            ENDIF
          ENDIF
.
          MATCH     Z70,PTMIS076
          IF        !@EQUAL
            MOVE      PTMIEBED,BKREEBED
          ENDIF
.
          MATCH     Z70,PTVIS093
          IF        !@EQUAL
            MOVE      PMVXPACC,BKREACCM
          ENDIF
.
          CALL      UPBKREC1
.
          PACK      KEY8,DAADMNO,SP70
          CALL      RDBKRX11
          BRANCH    OVRCD,UPBKD999
.
          MATCH     Z70,PTMIS009
          IF        !@EQUAL
            MOVE      ASRCE,BKRXASRC
          ENDIF
.
          MATCH     Z70,PTVIS046
          IF        !@EQUAL
            MOVE      PMVXAPWD,BKRXADWD
          ENDIF
.
          MATCH     Z70,PTMIS068
          IF        !@EQUAL
            IF        PTCNDWAW=0
              MOVE      PTMIXWRD,BKRXPOWD
            ENDIF
          ENDIF
.
          MATCH     Z70,PTVIS048
          IF        !@EQUAL
            MOVE      PMVXPOWD,BKRXPOWD
            IF        PTCNDWAW=0
              MOVE      PMVXPOWD,PTMIXWRD
            ENDIF
          ENDIF
.
          MATCH     Z70,PTVIS049
          IF        !@EQUAL
            MOVE      PMVXPOBD,BKRXPOBD
          ENDIF
.
          MATCH     Z70,PTVIS050
          IF        !@EQUAL
            MOVE      PMVXPSTY,BKRXPSTY
          ENDIF
.
          MATCH     Z70,PTVIS055
          IF        !@EQUAL
            MOVE      PMVXFRMS,BKRXFORM
          ENDIF
.
          MATCH     Z70,PTVIS060
          IF        !@EQUAL
            MOVE      PMVXEDC1,BKRXEDC1
          ENDIF
.
          MATCH     Z70,PTVIS061
          IF        !@EQUAL
            MOVE      PMVXEDC2,BKRXEDC2
          ENDIF
.
          MATCH     Z70,PTVIS062
          IF        !@EQUAL
            MOVE      PMVXEDC3,BKRXEDC3
          ENDIF
.
          IF        PTCNHDPS=1
            MATCH     "4",PTCNUBAP
            IF        !@EQUAL
              PACK      BKRXUFF1,ADIAG1,SP70
              PACK      BKRXUFF2,ADIAG2,SP70
            ENDIF
          ENDIF
.
          CALL      UPBKRX11
.
          PACK      KEY18,DAADMNO,SP70
          CALL      RSBKDIA1
          CALL      RKBKDIA1
          BRANCH    OVRCD,UPBKD999
.
          MATCH     DAADMNO,DBKDIBOO
          GOTO      UPBKD999 IF NOT EQUAL
.
          PACK      SAVKEY18,BKDIBOOK,BKDIUNIQ,SP70
          CALL      RKBKDIA1
          BRANCH    OVRCD,UPBKD100
.
          MATCH     DBKDIBOO,DAADMNO
          GOTO      UPBKD999 IF EQUAL       * don't update if multiple bookings
.
UPBKD100  PACK      KEY18,SAVKEY18,SP70
          CALL      RDBKDIA1
          BRANCH    OVRCD,UPBKD999
.
          MATCH     "4",PTCNUBAP
          IF        !@EQUAL
            MATCH     "5",PTCNUBAP
            IF        !@EQUAL
              PACK      BKDIDES1,ADIAG1,SP70
              PACK      BKDIDES2,ADIAG2,SP70
            ENDIF
          ENDIF
.
          PACK      BKDICODE,AMBS,SP70
.
          CALL      UPBKDIA1                * update file
.
          PACK      KEY31,DAADMNO,SP70
          CALL      RSOPDEA2
          CALL      RKOPDEA2
          BRANCH    OVRCD,UPBKD999
.
          MATCH     DAADMNO,OPDAADMN
          GOTO      UPBKD999 IF NOT EQUAL
.
        PACK SAVKEY31,OPDAADMN,DOPDASTA,OPDADATE,OPDATIME,OPDACLIN,OPDACASE,SP70
          CALL      RKOPDEA2
          BRANCH    OVRCD,UPBKD200
.
          MATCH     OPDAADMN,DAADMNO
          GOTO      UPBKD999 IF EQUAL       * don't update if multiple bookings
.
UPBKD200  PACK      KEY31,SAVKEY31,SP70
          CALL      RDOPDEA2
          BRANCH    OVRCD,UPBKD999
.
          MATCH     "4",PTCNUBAP
          IF        !@EQUAL
            MATCH     "5",PTCNUBAP
            IF        !@EQUAL
              PACK      OPDADES1,ADIAG1,SP70
              PACK      OPDADES2,ADIAG2,SP70
            ENDIF
          ENDIF
.
          MATCH     Z70,PTMIS009
          IF        !@EQUAL
            MATCH     "5",PTCNUBAP        * Upd Both, no diagnosis/procedure
            IF        @EQUAL
              MOVE      ASRCE,OPDAASRC
            ENDIF
          ENDIF
.
          PACK      OPDAPROV,AMBS,SP70
          PACK      OPDAATYP,BKRECLSS,SP70
          PACK      OPDACTYP,BKRECLMT,SP70
          PACK      OPDAPOWD,BKRXPOWD,SP70
          PACK      OPDAPOBD,BKRXPOBD,SP70
.
          CALL      UPOPDEA2
          MOVE      TWENTY,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLIS14                * send update booking message
.
UPBKD999  RETURN
+
.*******************************************************************************
.         Update Eligibility Details
.*******************************************************************************
UPELG000  MATCH     PTELG014,Z70
          IF        !@EQUAL
            MOVE      PTELG014,PTELSPEA
          ENDIF
.
          MATCH     PTELG033,Z70
          IF        !@EQUAL
            MOVE      PTELG033,PTELEADM
          ENDIF
.
UPELG999  RETURN
.*******************************************************************************
.        Get Next pmsoecaf report counter
.*******************************************************************************
GNXOEC00  MOVE      "  1",KEY3
          PACK      KEY11,ADMISSNO,Z70
          CALL      RSPMOEC1
          CALL      RPPMOEC1
          BRANCH    OVRCD,GNXOEC99
.
          MATCH     ADMISSNO,PMOEVISN
          GOTO      GNXOEC99 IF NOT EQUAL
.
          MOVE      ZERO,FORM3
          SQUEEZE   PMOECNTR
          MOVE      PMOECNTR,FORM3
.
          ADD       ONE,FORM3
          MOVE      FORM3,KEY3
.
GNXOEC99  RETURN
.*******************************************************************************
.        Eclipse OEC
.*******************************************************************************
ECLOEC00    MOVE      ZERO,OECREQIN
.
            MATCH     "1",PTVIS109            * if oec indicator = 1
            IF        @EQUAL
              MOVE      ADMISSNO,KEY8
              CALL      RDPTELG1
              IF        OVRCD=1
                CALL      CLPATELG              * Write new patelgaf record
                CALL      UPELG000
                MOVE      ADMISSNO,PTELVISN
                CALL      WRPTELG1
              ELSE
                CALL      UPELG000
                CALL      UPPTELG1
              ENDIF
.
              MOVE      SP70,SAVFPRIM
              CALL      REQOEC00                 * OEC Request
              CALL      REWOEC00
              PACK      SAVFPRIM,PTMIS026,SP70   * save
.
              MATCH     SP70,OECEPROV
              IF        !@EQUAL & !@EOS
                MOVE      EXTRPROV,PTMIS026
                CALL      REQOEC00            * OEC Request
                CALL      REWOEC00
              ENDIF
.
              MATCH     SP70,OECEPRV2
              IF        !@EQUAL & !@EOS
                MOVE      EXTRPRV2,PTMIS026
                CALL      REQOEC00            * OEC Request
                CALL      REWOEC00
              ENDIF
.
              MATCH     SP70,OECEPRV3
              IF        !@EQUAL & !@EOS
                MOVE      EXTRPRV3,PTMIS026
                CALL      REQOEC00            * OEC Request
                CALL      REWOEC00
              ENDIF
.
              PACK      EXTRPRV4,EXTRPRV4,SP70
              MATCH     SP70,EXTRPRV4
              IF        !@EQUAL & !@EOS
                MOVE      EXTRPRV4,PTMIS026
                CALL      REQOEC00            * OEC Request
                CALL      REWOEC00
              ENDIF
.
              PACK      EXTRPRV5,EXTRPRV5,SP70
              MATCH     SP70,EXTRPRV5
              IF        !@EQUAL & !@EOS
                MOVE      EXTRPRV5,PTMIS026
                CALL      REQOEC00            * OEC Request
                CALL      REWOEC00
              ENDIF
.
              MOVE      ONE,CNTITEM
              WHILE     CNTITEM<=LASTITEM
                MATCH     SP70,OECMB[CNTITEM]
                IF        !@EQUAL
                  PACK      KEY13,MCNTR[CNTITEM],SP70
                  CALL      RDOPMBS1
                  IF        OVRCD=0
                    MOVE      OPMBMBSI,PTMIS026
                    CALL      REQOEC00            * OEC Request
                    CALL      REWOEC00
                  ENDIF
                ENDIF
                ADD       ONE,CNTITEM
              DO
              MOVE      SAVFPRIM,PTMIS026       * restore
.
            ENDIF
.
            IF        OECREQIN = ONE
              MOVE      "Online Eligibility Check Request Generated.",WEBTITLE
.
              IF        WARCOUNT <= 11
                ADD       ONE,WARCOUNT
                MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
              ENDIF
            ENDIF
.
ECLOEC99  RETURN
+
.*******************************************************************************
.         Generate OEC Request
.*******************************************************************************
REQOEC00  MATCH     "1",PTCNOECE
          GOTO      REQOEC99 IF EQUAL
.
          CALL      GNXOEC00
          CALL      CLPMSOEC              * Write new pmsoecaf record
          CALL      UPPMOC00
.
          MOVE      ADMISSNO,PMOEVISN
          MOVE      KEY3,PMOECNTR
          MOVE      " 0",PMOESTAT
          MOVE      URNUMBER,PMOEURNO
          MOVE      ADMISSNO,PMOEARID
          PACK      PMOEARID,PMOEARID,SP70
          LJUSTIFY  PMOEARID
          MOVE      SP70,PMOETRID
          CALL      IBACLOCK
          PACK      PMOERQDT,CCC,CYY,CMM,CDD
          REP       " 0",PMOERQDT
          MOVE      SP70,PMOEETYP
          MOVE      SP70,PMOEERRC
          MOVE      SP70,PMOEERRD
          PACK      PMOECDTE,CCC,CYY,CMM,CDD
          REP       " 0",PMOECDTE
          CLOCK     TIME,CTIMEIS
          MOVE      CTIMEIS,PMOECTIM
          MOVE      SP70,PMOEUDTE
          MOVE      SP70,PMOEUTIM
          MOVE      SP70,PMOEHOSP
          MOVE      SP70,PMOEELEG
.
          IF        IBCNMHOS=1
            PACK      KEY8,ADMISSNO,SP70     * Update pmsvx1af.pmvxpoec
            CALL      RDPMVX11               * OEC Consent
            IF        OVRCD=0
              MOVE      PMVXMHOS,PMOEHOSP
            ENDIF
          ENDIF
.
          PACK      KEY11,PMOEVISN,PMOECNTR,SP70
          CALL      RAPMOEC1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            CALL      WRPMOEC1
            TRAPCLR   IO
            BRANCH    OVRCD,REQOEC00
          ELSE
            GOTO      REQOEC00
          ENDIF
.
          MOVE      ONE,F2A
          MOVE      ONE,F2                * Write new pmsoesaf record
          WHILE     F2 <= 5
            CALL      CLPMSOES
            CALL      UPPMOS00
.
            MATCH     SP70,PMOSITEM
            GOTO      REQOEC60 IF EQUAL
            GOTO      REQOEC60 IF EOS
.
            MOVE      ADMISSNO,PMOSVISN
            MOVE      PMOECNTR,PMOSCNTR
            MOVE      F2A,PMOSSCNT
            PACK      PMOSSCNT,PMOSSCNT,SP70
            RJUSTIFY  PMOSSCNT
            CALL      IBACLOCK
            PACK      PMOSCDTE,CCC,CYY,CMM,CDD
            REP       " 0",PMOSCDTE
            CLOCK     TIME,CTIMEIS
            MOVE      CTIMEIS,PMOSCTIM
.
            PACK      KEY14,ADMISSNO,PMOSCNTR,PMOSSCNT,SP70
            CALL      RAPMOES1
            IF        OVRCD=1
              CALL      WRPMOES1
            ELSE
              CALL      UPPMOES1
            ENDIF
.
            ADD       ONE,F2A
REQOEC60    ADD       ONE,F2
          DO
.
.         MOVE      "Online Eligibility Check Request Generated.",WEBTITLE
.
.         IF        WARCOUNT <= 11
.           ADD       ONE,WARCOUNT
.           MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
.         ENDIF
.
          MOVE      ONE,OECREQIN
.
          CALL      HOEC0000
.
REQOEC99  RETURN
.
.------------------------------------------------------------------------------
.         Yes/No option
.------------------------------------------------------------------------------
DNOYES00  MATCH     "1",KEY1
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",ZERO,">":
                               "No</option>":
                               "<option value=",ONE," selected>":
                               "Yes</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",ZERO," selected>":
                               "No</option>":
                               "<option value=",ONE,">":
                               "Yes</option>"
          ENDIF
DNOYES99  RETURN
.
.------------------------------------------------------------------------------
. Track medical record to ED on pmi registration
.------------------------------------------------------------------------------
TEMR0000  MATCH     "1",MRCNEMRT                 * Auto track record to ED
          GOTO      TEMR9999 IF NOT EQUAL
.
          PACK      KEY8,ADMISSNO,SP70           * Linked medical record for
          CALL      RDMRVS1                      * this visit
          BRANCH    OVRCD,TEMR9999
.
          PACK      KEY10,MRVSMKEY,SP70          * Read medical record
          CALL      RDMRMAS2
          BRANCH    OVRCD,TEMR9999
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDEMVIS1
          BRANCH    OVRCD,TEMR9999
.
          PACK      KEY3,EMVISITE,SP70
          CALL      RDEMSIT1
          BRANCH    OVRCD,TEMR9999
.
          MATCH     SP70,EMSTDRES          * Movement Reason
          GOTO      TEMR9999 IF EQUAL
.
          MATCH     SP70,EMSTDRLC          * No tracking location for site
          GOTO      TEMR9999 IF EQUAL
.
          MATCH     MRMACHOS,EMSTHSNO      * is this needed ?   MLMLMLML
.
          MATCH     MRMACLOC,EMSTDRLC      * compare current loc to current ward
          GOTO      TEMR9999 IF EQUAL
.
          CALL      CLMRTHIS               * clear MRT History record
          MOVE      MRMAKEY,MRHIKEY        * move record
          CALL      IBACLOCK
          PACK      MRHIDATE,CCC,CYY,CMM,CDD   * movement date
          REP       " 0",MRHIDATE
          CLOCK     TIME,MRHITIME          * movement time
          MOVE      EMSTHSNO,MRHIDHOS      * new Hospital             *I-240124
          MOVE      EMSTDRLC,MRHILOC       * new location
          MOVE      EMSTDRES,MRHIREAS      * reason
          CALL      CALDUE00               * calculate due date
          CALL      CALSTA00               * calculate status
.
          UNPACK    SP70,MRHIRCST,MRHIRCUI,MRHIRCDT,MRHIRCTM
.
          MATCH     "1",MRCNTREC            * System Using Tracking Receipt
          IF        @EQUAL
            MATCH     "1",MRLOTREC          * Location Using Tracking Receipt
            IF        @EQUAL
              MOVE      "1",MRHIRCST        * In Transit
            ELSE
              MOVE      "3",MRHIRCST        * Sent Direct
            ENDIF
          ENDIF
.
          MOVE      USERID,MRHIUSID        * userid
.
          PACK      KEY26,MRHIKEY,MRHIDATE,MRHITIME,SP70
          CALL      RAMRHIS1
          IF        OVRCD=1
            CALL      WRMRHIS1
          ENDIF
          MOVE      TWENTY1,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICRM       * Pass Med.Recs.Movement to DG
.
          PACK      KEY10,MRVSMKEY,SP70    * current location
          CALL      RDMRMAS2
          BRANCH    OVRCD,TEMR9999
.
          MOVE      EMSTHSNO,MRMACHOS      * new Hospital             *I-240124
          MOVE      EMSTDRLC,MRMACLOC      * new location
          CALL      IBACLOCK
          PACK      MRMADTUP,CCC,CYY,CMM,CDD
          REP       " 0",MRMADTUP
          MOVE      CTIMEIS,MRMATMUP
          MOVE      WBSEUID,MRMAUUID
          CALL      UPMRMAS2
.
TEMR9999  RETURN
.
.-------------------------------------------------------------------------------
. Calculate Due Date - returns MRHIDDUE
.-------------------------------------------------------------------------------
CALDUE00  MOVE      SP70,MRHIDDUE
          OPEN      MRTMOVA1,"mrtmovaf"
.
          PACK      KEY4,MRHIREAS,SP70
          CALL      RDMRMOV1            * Get Borrowing Period
          BRANCH    OVRCD,CALDUE99
.
          UNPACK    MRHIDATE,CCENT,CYEAR,CMON,CDAY  * Date of Movement
          MOVE      CCENT,CC
          MOVE      CYEAR,YY
          MOVE      CMON,MM
          MOVE      CDAY,DD
          CALL      DMYCON
          ADD       MRMOPERD,JULDAY
          MOVE      JULDAY,JWKDAY
          MOVE      JULYR,JWKYER
          MOVE      JULCC,JWKCC
          CALL      JULCON
          PACK      MRHIDDUE,CC,YY,MM,DD           * Calculated Due Date
          REP       " 0",MRHIDDUE
.
CALDUE99  CLOSE     MRTMOVA1
          RETURN
+
.-------------------------------------------------------------------------------
. Calculate Status - returns MRHISTAT
.-------------------------------------------------------------------------------
CALSTA00  PACK      KEY7,MRMACHOS,MRMACLOC,SP70                       *C-240724
          CALL      RDMRLOC1        * Read Location File for Indicator
          BRANCH    OVRCD,CALSTA99
.
          MATCH     "2",MRLOINDC
          IF        @EQUAL
            MOVE      ONE,MRHISTAT   * 1-Out
          ELSE
            MOVE      TWO,MRHISTAT   * 2-In
          ENDIF
.
CALSTA99  RETURN
+
.------------------------------------------------------------------------------
. Track medical record to ED on pmi registration without triage
.------------------------------------------------------------------------------
TMRR0000  MATCH     "1",MRCNEMRT                 * Auto track record to ED
          GOTO      TMRR9999 IF NOT EQUAL
.
          MATCH     SP70,WBSEESC
          GOTO      TMRR9999 IF EQUAL
          GOTO      TMRR9999 IF EOS
.
          PACK      KEY3,WBSEESC,SP70
          CALL      RDEMSIT1
          BRANCH    OVRCD,TMRR9999
.
          MATCH     SP70,EMSTDRES          * Movement Reason
          GOTO      TMRR9999 IF EQUAL
.
          MATCH     SP70,EMSTDRLC          * No tracking location for site
          GOTO      TMRR9999 IF EQUAL
.
          MATCH     MRMACHOS,EMSTHSNO      * is this needed ?  MLMLMLML
.
          MATCH     MRMACLOC,EMSTDRLC      * compare current loc to current ward
          GOTO      TMRR9999 IF EQUAL
.
          CALL      CLMRTHIS               * clear MRT History record
          MOVE      MRMAKEY,MRHIKEY        * move record
          CALL      IBACLOCK
          PACK      MRHIDATE,CCC,CYY,CMM,CDD   * movement date
          REP       " 0",MRHIDATE
          CLOCK     TIME,MRHITIME          * movement time
          MOVE      EMSTHSNO,MRHIDHOS      * new hospital             *I-240724
          MOVE      EMSTDRLC,MRHILOC       * new location
          MOVE      SP70,MRHIRECV          * receiver
          MOVE      EMSTDRES,MRHIREAS      * reason
          CALL      CALDUE00               * calculate due date
          CALL      CALSTA00               * calculate status
.
          UNPACK    SP70,MRHIRCST,MRHIRCUI,MRHIRCDT,MRHIRCTM
.
          MATCH     "1",MRCNTREC            * System Using Tracking Receipt
          IF        @EQUAL
            MATCH     "1",MRLOTREC          * Location Using Tracking Receipt
            IF        @EQUAL
              MOVE      "1",MRHIRCST        * In Transit
            ELSE
              MOVE      "3",MRHIRCST        * Sent Direct
            ENDIF
          ENDIF
.
          MOVE      USERID,MRHIUSID        * userid
.
          PACK      KEY26,MRHIKEY,MRHIDATE,MRHITIME,SP70
          CALL      RAMRHIS1
          IF        OVRCD=1
            CALL      WRMRHIS1
          ENDIF
          MOVE      TWENTY2,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICRM       * Pass Med.Recs.Movement to DG
.
          PACK      KEY10,MRMAKEY,SP70    * current location
          CALL      RDMRMAS2
          BRANCH    OVRCD,TMRR9999
.
          MOVE      EMSTHSNO,MRMACHOS      * new hospital             *I-240724
          MOVE      EMSTDRLC,MRMACLOC      * new location
          CALL      IBACLOCK
          PACK      MRMADTUP,CCC,CYY,CMM,CDD
          REP       " 0",MRMADTUP
          MOVE      CTIMEIS,MRMATMUP
          MOVE      WBSEUID,MRMAUUID
          CALL      UPMRMAS2
.
TMRR9999  RETURN
.-----------------------------------------------------------------------------
. Check if Previous admissions exists warning is required
.-------------------------------------------------------------------------------
PRVS0000  COMPARE   ZERO,C3BDAYS
          GOTO      PRVS9999 IF EQUAL
          BRANCH    DISERROR,PRVS9999
          MATCH     SP70,PTMIPANO
          GOTO      PRVS9999 IF EQUAL
.
          MOVE      ADATE,DIM8                    * Current Admission date
          REP       " 0",DIM8
          MOVE      PTMIPANO,KEY8                 * Previous visit no
          CALL      RDDSCH1
          BRANCH    OVRCD,PRVS9999
.
          MOVE      ZERO,F3
          REP       " 0",DDATE
          DAYSEP    DDATE,DIM8,F3
.
          COMPARE   C3BDAYS,F3
          GOTO      PRVS9000 IF LESS
          GOTO      PRVS9999
.
PRVS9000  CLEAR     WEBTITLE
          APPEND    "Warning: This patient has been an inpatient",WEBTITLE
          APPEND    " within the last ",WEBTITLE
          APPEND    C3BDAYS,WEBTITLE
          APPEND    " Days",WEBTITLE
          APPEND    SP70,WEBTITLE
          RESET     WEBTITLE
          ADD       ONE,WARCOUNT
          MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
          GOTO      PRVS9999
.
PRVS9999  RETURN
+
.-------------------------------------------------------------------------------
.         Check adm.source (transfer from other hospital) or prev.day hosp.
.-------------------------------------------------------------------------------
CASR0000  IF        CFEETYP=8
            GOTO      CASR9999          * not charging
          ENDIF
          MATCH     SP70,ASRCE
          GOTO      CASR2000 IF EQUAL
          MOVE      "S ",KEY2
          PACK      KEY5,KEY2,ASRCE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CASR2000
.
          MATCH     "W",TCINDC9
          GOTO      CASR2000 IF NOT EQUAL
.
          CLEAR     WEBTITLE
          APPEND    "Warning: Patient Transferred from Other Hospital.",WEBTITLE
          APPEND    " Check Billing Details ",WEBTITLE
          APPEND    SP70,WEBTITLE
          RESET     WEBTITLE
          ADD       ONE,WARCOUNT
          MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
.
CASR2000  COMPARE   ZERO,ADYHOSP
          GOTO      CASR9999 IF EQUAL
.
          CLEAR     WEBTITLE
          APPEND    "Warning: Previous Days in Hospital exist.",WEBTITLE
          APPEND    " Check Billing Details ",WEBTITLE
          APPEND    SP70,WEBTITLE
          RESET     WEBTITLE
          ADD       ONE,WARCOUNT
          MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
.
CASR9999  RETURN
+
.-------------------------------------------------------------------------------
. Update Alternate adddress details (pmscexcaf) if required
.-------------------------------------------------------------------------------
AADR0000  MATCH     "   ",PTCNAADR          * Alternate address contact type
          GOTO      AADR9999 IF EQUAL       * not setup
.
          MATCH     "000",PTCNAADR          * Alternate address contact type
          GOTO      AADR9999 IF EQUAL       * not setup
.
          MATCH     Z70,PMCEX001            * Alternate address not on screen
          GOTO      AADR9999 IF EQUAL
.
          MATCH     Z70,PMCEX002            * Alternate address not on screen
          GOTO      AADR9999 IF EQUAL
.
          MATCH     Z70,PMCEX007            * Alternate address not on screen
          GOTO      AADR9999 IF EQUAL
.
          MATCH     SP70,PMCEX007
          IF        !@EQUAL & !@EOS
            GOTO      AADR3000              * Only write a record if alternate
          ENDIF                             * address details are populated
.
          MATCH     SP70,PMCEX008
          IF        !@EQUAL & !@EOS
            GOTO      AADR3000
          ENDIF
.
          MATCH     SP70,PMCEX009
          IF        !@EQUAL & !@EOS
            GOTO      AADR3000
          ENDIF
.
          MATCH     SP70,PMCEX010
          IF        !@EQUAL & !@EOS
            GOTO      AADR3000
          ENDIF
.
          MATCH     SP70,PMCEX011
          IF        !@EQUAL & !@EOS
            GOTO      AADR3000
          ENDIF
.
          GOTO      AADR5000
.
AADR3000  CALL      CONC0000                      * Calculate contact counter
.                                                 * for add if required
          PACK      KEY14,PMCEX001,PMCEX002,SP70
          CALL      RSPMCEX1
ADDR3100  CALL      RKPMCEX1
          BRANCH    OVRCD,ADDR3500
.
          MATCH     PMCEX001,PMCEURNO            * Same U/R
          GOTO      ADDR3500 IF NOT EQUAL
.
          MATCH     PMCEX002,PMCETYPE            * Same Contact Type
          GOTO      ADDR3500 IF NOT EQUAL
.
          MATCH     "1",PMCEACTV                 * Skip if Inactive
          GOTO      ADDR3100 IF EQUAL
.
          MOVE      PMCECNTR,PMCEX003            * Store contact counter
          MOVE      TWO,AUDTTYPE                 * write before audit record
          CALL      WAPMCE00
.
ADDR3500  PACK      KEY14,PMCEX001,PMCEX002,PMCEX003,SP70
          CALL      RDPMCEX1
          IF        OVRCD=1
            CALL      CLPMSCEX              * Clear extra contact details
            CALL      MVPMCE00              * Move cgi to file vars
            PACK      PMCECDAT,CCC,CYY,CMM,CDD
            REP       " 0",PMCECDAT
            CLOCK     TIME,PMCECTIM
            MOVE      USERID,PMCECUID
.
            CALL      CONU0000              * Get contact webPAS unique id
.
            CALL      WRPMCEX1              * Write record
.  write nsw edw record for contact added
            MOVE      "14",PMEWTYPE
            PACK      PMEWNEWV,PMCEURNO,PMCETYPE,PMCECNTR,SP70
            CALL      WREDW000
.
            MOVE      ONE,AUDTTYPE            * write add audit record
            CALL      WAPMCE00
          ELSE
            CALL      MVPMCE00              * Move cgi to file vars
            PACK      PMCEUDAT,CCC,CYY,CMM,CDD
            REP       " 0",PMCEUDAT
            CLOCK     TIME,PMCEUTIM
            MOVE      USERID,PMCEUUID
            CALL      UPPMCEX1              * Update record
.  write nsw edw record for contact updated
            MOVE      "15",PMEWTYPE
            PACK      PMEWNEWV,PMCEURNO,PMCETYPE,PMCECNTR,SP70
            CALL      WREDW000
.
            MOVE      THREE,AUDTTYPE               * write after audit record
            CALL      WAPMCE00
          ENDIF
.
.         If we are using the new contacts table (pmscexaf), then
.         trigger a PMI update message so that the latest contact details
.         will be sent in a broadcast message.
.
          MATCH     "1",PTCNNEWC            * using new contacts ?
          GOTO      AADR9999 IF NOT EQUAL   * no
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TWENTY3,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICUP                * send HL7 message
          GOTO      AADR9999
.
AADR5000  PACK      KEY14,PMCEX001,PMCEX002,SP70
          CALL      RSPMCEX1
ADDR5500  CALL      RKPMCEX1
          BRANCH    OVRCD,ADDR8000
.
          MATCH     PMCEX001,PMCEURNO            * Same U/R
          GOTO      ADDR8000 IF NOT EQUAL
.
          MATCH     PMCEX002,PMCETYPE            * Same Contact Type
          GOTO      ADDR8000 IF NOT EQUAL
.
          MATCH     "1",PMCEACTV                 * Skip if Inactive
          GOTO      ADDR5500 IF EQUAL

          PACK      KEY14,PMCEURNO,PMCETYPE,PMCECNTR,SP70
          CALL      DEPMCEX1                * Delete alternate address if
.                                           * the details are blank
          MOVE      FOUR,AUDTTYPE           * write delete audit record
          CALL      WAPMCE00
.
.         If we are using the new contacts table (pmscexaf), then
.         trigger a PMI update message so that the latest contact details
.         will be sent in a broadcast message.
.
ADDR8000  MATCH     "1",PTCNNEWC            * using new contacts ?
          GOTO      AADR9999 IF NOT EQUAL   * no
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TWENTY4,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICUP                * send HL7 message
.
AADR9999  RETURN
+
.------------------------------------------------------------
. WRBL0000 - Write boarder link
.---------------------------------------------------------------------
WRBL0000  PACK      KEY8,MOTHADMN,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,WRBL9999
          PACK      MURNO,AURNO,SP70
          CALL      CLPATMIS
          PACK      BURNO,URNUMBER,SP70
.
          MOVE      MURNO,LINKFUR
          MOVE      BURNO,LINKTUR
          PACK      LINKSPR,SP20,SP20
          PACK      KEY16,LINKFUR,LINKTUR,SP70
          CALL      IBACLOCK
          PACK      LINKDAT,CCENT,CYEAR,CMON,CDAY
          REP       " 0",LINKDAT
.
          PACK      KEY5,ANSL,ANSU,SP70
          CALL      RDSCODE1
WRBL100   CALL      RDKCODE1
          BRANCH    OVRCD,WRBL9999
.
          MATCH     "LU",TCODE
          GOTO      WRBL9999 IF NOT EQUAL
.
          MATCH     ANSB,TCINDC2
          GOTO      WRBL100 IF NOT EQUAL
.
          PACK      LINKREA,ACODE,SP70
          MOVE      ZERO,FROMLINK
          MOVE      ZERO,TOLINK
          CALL      RDLINK1
          IF        OVRCD=1
             MOVE      ONE,FROMLINK
          ENDIF
.
          PACK      KEY16,LINKTUR,LINKFUR
          CALL      RDLINK1
          IF        OVRCD=1
             MOVE      ONE,TOLINK
          ENDIF
.
          IF        FROMLINK=0
              IF        TOLINK=0
                  GOTO      WRBL9999     * FROM rec. & TO rec. exists
              ELSE
                  CALL      DELINK1      * FROM rec. exists & TO rec. not exist
                  CALL      WRLINK1
              ENDIF
          ELSE
              IF        TOLINK=1
                  CALL      WRLINK1      * FROM rec. & TO rec. not exist
              ELSE
                  CALL      DELINK1      * FROM rec. not exist & TO rec. exists
                  CALL      WRLINK1
              ENDIF
          ENDIF
.
          GOTO      WRBL9999
.
WRBL9999  RETURN
+
.*************************************************************************
. Write unique id to bokunqaf to allow usage to be entered
.*************************************************************************
WRUSG000  MOVE      "42",FORM2              * get previous unique record
          MOVE      " 42",PRXCODE   * System Lock Sector 42
          CALL      GETSLK00        * Get System Lock of Sector 42
          READ      CONTROLF,FORM2;*32,OPCNUNIQ
          ADD       ONE,OPCNUNIQ            * set it to next unique number
          WRITAB    CONTROLF,FORM2;*32,OPCNUNIQ
          CALL      RELSLK00        * Release System Lock of Sector 42
          MOVE      OPCNUNIQ,OPDAUNIQ
.
          PACK      KEY18,BKREBOOK,OPDAUNIQ,SP70
          CALL      RDBKUNQ1
          IF        OVRCD<>1
            GOTO      WRUSG999
          ENDIF
.
          PACK      BKUNVISN,BKREBOOK,SP70
          PACK      BKUNUNIQ,OPDAUNIQ,SP70
          PACK      BKUNLADM,SP70
          PACK      BKUNWEBL,SP70
          PACK      BKUNDATL,SP70
          PACK      BKUNTIML,SP70
          PACK      KEY18,BKUNVISN,BKUNUNIQ,SP70
          CALL      WRBKUNQ1
.
WRUSG999  RETURN
.
.------------------------------------------------------------
. Check if this patient has a EMR Visit that is linked to
. this pre admission.
.------------------------------------------------------------
LEMR0000  PACK      KEY16,URNUMBER,Z70
          CALL      RSEMVIS3
LEMR1000  CALL      RPEMVIS3
          BRANCH    OVRCD,LEMR9000
.
          MATCH     URNUMBER,EMVIURNO  * See if its the right patient
          GOTO      LEMR9000 IF NOT EQUAL
.
          MATCH     EMVIPADM,ADMISSNO
          GOTO      LEMR9000 IF NOT EQUAL
.
          COMPARE   FOUR,EMVISTAT           * Cancelled ed visit
          GOTO      LEMR1000 IF EQUAL
.
LEMR8000  WRITE    HTMLFILE;ONE;            * Yes linked to ed visit
          GOTO     LEMR9999
.
LEMR9000  WRITE    HTMLFILE;ZERO;           * No linked to ed visit
          GOTO     LEMR9999
.
LEMR9999  RETURN
.
.------------------------------------------------------------------------
.         PEA - Yes/No/Query option
.------------------------------------------------------------------------
SPEA0000  MATCH     "1",KEY1
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",ZERO,">":
                               "No</option>":
                               "<option value=",ONE," selected>":
                               "Yes</option>":
                               "<option value=",TWO,">":
                               "Query</option>"
          ELSE
            MATCH     "2",KEY1
            IF        @EQUAL
              WRITE     HTMLFILE;"<option value=",ZERO,">":
                                 "No</option>":
                                 "<option value=",ONE,">":
                                 "Yes</option>":
                                 "<option value=",TWO," selected>":
                                 "Query</option>"
            ELSE
              WRITE     HTMLFILE;"<option value=",ZERO," selected>":
                                 "No</option>":
                                 "<option value=",ONE,">":
                                 "Yes</option>":
                                 "<option value=",TWO,">":
                                 "Query</option>"
            ENDIF
          ENDIF
SPEA9999  RETURN
.-------------------------------------------------------------------------------
. Write to Mental Health Visit file
.-------------------------------------------------------------------------------
WRMHVS00  CALL      CLMEHVIS
          CALL      CLMEHDIA
.
          COMPARE   ONE,MHADMFLG
          GOTO      WRMHVS99 IF NOT EQUAL
.
          MOVE      AADMNO,MHVIADMN
          MOVE      PURNO,MHVIURNO
          PACK      KEY8,MHVIADMN
          CALL      RAMHVIS1
          IF        OVRCD=1
            MOVE      ZERO,MHVISTAT
            CALL      WRMHVIS1
          ENDIF
.
          COMPARE   ZERO,MHVISTAT
          GOTO      WRMHVS99 IF NOT EQUAL
.
          MOVE      AADMNO,MHDIADMN
          MOVE      ADATE,MHDIDATE
          MOVE      "0",MHDIMOHR
.
          PACK      KEY16,MHDIADMN,MHDIDATE,SP70
          CALL      RAMHDIA1
          IF        OVRCD=0
            PACK      MHDIUDAT,CCC,CYY,CMM,CDD
            REP       " 0",MHDIMOHR
            CLOCK     TIME,MHDIUTIM
            MOVE      USERID,MHDIUUID
            CALL      UPMHDIA1
          ELSE
            PACK      MHDICDAT,CCC,CYY,CMM,CDD
            REP       " 0",MHDICDAT
            CLOCK     TIME,MHDICTIM
            MOVE      USERID,MHDICUID
            CALL      WRMHDIA1
          ENDIF
.
WRMHVS99  RETURN
.------------------------------------------------------------
. WRRC0000 - Write to recurring care batch table
.------------------------------------------------------------
WRRC0000  MATCH     SP70,BATCHNUM
          GOTO      WRRC9999 IF EQUAL
.
          PACK      PMRCBATC,BATCHNUM,SP70
          PACK      PMRCADMN,ADMISSNO,SP70
          MATCH     Z70,PRVADMIS
          IF        !@EQUAL
            PACK      PMRCPREV,PRVADMIS,SP70
          ENDIF
          REP       "+ ",PMRCADMN
.
          OPEN      PMSRCBA1,"pmsrcbaf"
          PACK      KEY16,PMRCBATC,PMRCADMN,SP70
          CALL      RAPMRCB1
          IF        OVRCD=1
             CALL     WRPMRCB1
          ENDIF
.
WRRC9999  CLOSE      PMSRCBA1
          RETURN
+
.------------------------------------------------------------
. DISCH000 - Automatically discharge patients for recurring care
.------------------------------------------------------------
DISCH000  MOVE      ZERO,UPDATETY
          PACK      KEY8,PMRCPREV,SP70
          CALL      RDDSCH1
          BRANCH    OVRCD,DISCH999
          CALL      RDPMVX11
          BRANCH    OVRCD,DISCH999
          PACK      KEY8,PMRCPREV,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,DISCH999
.
          PACK      DSCHSTAT,DSTAT,SP70
          PACK      DSCHDEST,DDEST,SP70
          PACK      DSCHDIA1,DDIAG,SP70
          PACK      DSCHDIA2,DDIAG2,SP70
          PACK      DSCHUSR1,DUSD1,SP70
          PACK      DSCHUSR2,DUSD2,SP70
          PACK      DSCHUSR3,DUSD3,SP70
          PACK      DSCHUSR4,DUSD4,SP70
          PACK      DSCHUSR5,DUSD5,SP70
          PACK      DSCHMBSC,DFMBS,SP70
.
          PACK      DSCHIRAD,PMVXIRAD,SP70
          PACK      DSCHSREF,PTDSSREF,SP70
          PACK      DSCHCOM1,ACOMM1,SP70
          PACK      DSCHCOM2,ACOMM2,SP70
          PACK      DSCHDETY,PMPXDETY,SP70
          PACK      DSCHCRAV,PMVXCRAV,SP70
          PACK      DSCHRCCT,PMVXRCCT,SP70
          PACK      DSCHMHLS,PMVXMHLS,SP70
          PACK      DSCHPALC,PMVXPALC,SP70
          PACK      DSCHPYSP,PMVXPYSP,SP70
          PACK      DSCHFINP,PMVXFINP,SP70
.
          PACK      KEY8,PMRCPREV,SP70
          CALL      RDPTDAD1
          IF        OVRCD=1
            UNPACK    SP70,PTDAADTS,PTDADCTS
          ENDIF
          PACK      TRNSFSRC,PTDADCTS
.
          PACK      KEY8,PMRCADMN,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,DISCH999
.
          PACK      KEY8,AURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,DISCH910
.
          PACK      TRANDATE,ADATE,SP70
          CALL      WBMHMS00
          CALL      WRDS0000        * Write discharge record
          BRANCH    EXIT,DISCH900
.
          CALL      GTRNS000                * Generate Discharge Transfer Record
          BRANCH    EXIT,DISCH900
.
          CALL      DEADST00                * Update deceased status if req
.
          CALL      UPLMAST1                * Update Master file
.
          CALL      DEAPOL00                * Update Patient Death Polling Table
.
          CALL      UPADMN00                * Update Admission/Master/NHOSDAYS
.
.         Broadcast Datagate Message
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      THIRTY4,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICDS                * send discharge notif'n
.
          CALL      UPDCFR00                * Update Control file
.
          CALL      RMPLT000                * Remove Patient Location Record
.
          CALL      CMIX0000                * Check Casemix / MHMS Adjust
.
          CALL      DELPAT00                * Update Current Patient Search
.                                           * I CAR 23608
.
          MOVE      FOUR,UPBMSTAT
          CALL      UPPBMD00                * Update Bed Management file
.
          PROC      BBUP0000                * Bed Board
.
          MATCH     "1",PTCNCHOD
          IF        @EQUAL
            MATCH     "1",NOTIFYHS
            IF        @EQUAL
              CALL      HREQ0000            * Housekeeping request
            ENDIF
          ENDIF
.
          PROC      CALCCODE                * Recalculate hrs of ICU/NCU/CCU
.
DISCH900  MOVE      AADMNO,KEY8
          CALL      UUPTMIS1
          MOVE      AURNO,KEY8
          CALL      UUPTMAS1
          MOVE      ZERO,EXIT
.
          PACK      KEY5,ANSA,ANSC,ACLSSFT,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            MATCH     ANSA,TCINDC5
            IF        @EQUAL
              PACK      CPYADMNO,PMRCPREV
              PACK      ADMISSNO,PMRCADMN
              MOVE      SP70,CODERROR
              PROC      COPYMCOD
.
              CALL      PMIGTNID            * get national id for dgate write
              MOVE      NMPNUMB,PTNINMPI
              MOVE      THIRTY1,HL7TRGID
              MOVE      SP8,HL7INCLD
              PROC      DGCLICAC            * trigger I/P visit update message
            ENDIF
          ENDIF
.
          GOTO      DISCH999
.
DISCH910  MOVE      "Invalid UR Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DISCH999
.
DISCH999  RETURN
+
.------------------------------------------------------------
. DISS0000 - Perform statistical discharge and statistical admission
.------------------------------------------------------------
DISS0000  MOVE      ZERO,UPDATETY
          MOVE      ZERO,EXIT
.
          CALL      VSAD0000        * Validate stat adm doctor's active dates
          BRANCH    EXIT,DISS9999
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,DISS9999
.
. * patient staying in same ward/bed?  Don't check bed is available
          MATCH     AWARD,PTMIS005
          IF        @EQUAL
            MATCH     ABED,PTMIS004
            GOTO      DISS2000 IF EQUAL
          ENDIF
.
          CALL      SBED0000
          BRANCH    EXIT,DISS9999
.
DISS2000  CALL      WBMHMS00
          BRANCH    EXIT,DISS9010
.
          CALL      WRDS0000        * Write discharge record
          BRANCH    EXIT,DISS9020
.
          CALL      GTRNS000                * Generate Discharge Transfer Record
          BRANCH    EXIT,DISS9030
.
          PACK      KEY8,AURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,DISS9100
.
          CALL      DEADST00                * Update deceased status if req
.
          CALL      UPLMAST1                * Update Master file
.
          CALL      DEAPOL00                * Update Patient Death Polling Table
.
          CALL      UPADMN00                * Update Admission/Master/NHOSDAYS
.
.         Broadcast Datagate Message
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      THIRTY5,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICDS                * send discharge notif'n
.
          CALL      UPDCFR00                * Update Control file
.
          CALL      CMIX0000                * Check Casemix / MHMS Adjust
.
          CALL      DELPAT00                * Update Current Patient Search
.                                           * I CAR 23608
          PROC      WRWATR00              * write to WA triggers table
.
          MOVE      FOUR,UPBMSTAT
          CALL      UPPBMD00                * Update Bed Management file
.
          CALL      CHKSTB00                * Check for Standby Patient
.
          PROC      BBUP0000                * Bed Board
.
          MATCH     "1",PTCNCHOD
          IF        @EQUAL
            MATCH     "1",NOTIFYHS
            IF        @EQUAL
              CALL      HREQ0000            * Housekeeping request
            ENDIF
          ENDIF
.
          PROC      CALCCODE                * Recalculate hrs of ICU/NCU/CCU
          MOVE      ZERO,EXIT
.
DISS9000  MOVE      AADMNO,KEY8
          CALL      UUPTMIS1
          MOVE      AURNO,KEY8
          CALL      UUPTMAS1
.
          GOTO      DISS9999
.
DISS9010  MOVE      "Error on ward/bed file for statistical admission",WEBTITLE 
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DISS9999
.
DISS9020  MOVE      "Error on writing discharge for statistical admission",WEBTITLE 
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DISS9999
.
DISS9030  MOVE      "Error on writing discharge transfer record",WEBTITLE 
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DISS9999
.
DISS9100  MOVE      "Invalid UR Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DISS9999
.
DISS9999  RETURN
+
.------------------------------------------------------------
. ADMS0000 - Perform Statistical Admission
.------------------------------------------------------------
ADMS0000  MOVE      AADMNO,DISCADMN     * save statistical discharge admissno
          MOVE      ACLAIM,PRECLAIM     * save statistical discharge aclaim
.
          MOVE      ZERO,PTMIS031
          MOVE      ZERO,PTMIS082
.
          PACK      KEY5,ANSD,ANSD,DSCHDEST
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      SP70,TCINDC9
          ENDIF
          MOVE      TCINDC9,DDIND9
.
          MOVE      ADATE,FROMDATE
          MOVE      DDATE,TODATE
          CALL      NHOSPDAY
.          ADD       NBRDAYS,ADYHOSP
.
          MOVE      PTMI3BDY,DD3BDY 
          MATCH     "3",DDIND9
          IF        @EQUAL
            MOVE      0,FORM4
            MOVE      PTMI3BDY,FORM4
            ADD       NBRDAYS,FORM4
            MOVE      FORM4,DD3BDY
          ELSE
            MATCH     "B",DDIND9
            IF        @EQUAL
              MOVE      0,FORM4
              MOVE      PTMI3BDY,FORM4
              ADD       NBRDAYS,FORM4
              MOVE      FORM4,DD3BDY
              ADD       NBRDAYS,ADYHOSP
            ELSE
              ADD       NBRDAYS,ADYHOSP
            ENDIF
          ENDIF
          PACK      PTMIS031,ADYHOSP
.
          BRANCH    CHOSTYP,ADMS1000        * Public Hospital
.
.         WA health has Hospital type as Private...check Daily charge parameter
.
          IF        CHOSTYP=0
            COMPARE   EIGHT,CFEETYP
            GOTO      ADMS1000 IF EQUAL     * Private with No charging
          ENDIF
          GOTO      ADMS1200
.
ADMS1000  PACK      PTMIS082,ADYHOSP    * Public Hospital
.
ADMS1200  MATCH     Z70,PTVIS022
          IF        @EQUAL
            PACK      PTVIS022,PMVXINGP * Default inform GP from current adm
          ENDIF                         * if not received 
.
          PACK      PTMIS072,PTMIUYN2
.
          MOVE      PTMIOGNO,ORIGADMN   * save original admissno
.
          MATCH     SP70,STATVTYP       * Link to visit type
          GOTO      ADMS1300 IF EQUAL
.
          MATCH     SP70,STATVISN       * Link to visit number
          GOTO      ADMS1300 IF EQUAL
.
          MATCH     "BOK",STATVTYP      * Linking to a booking
          GOTO      ADMS1250 IF NOT EQUAL
.
          PACK      KEY8,STATVISN,SP70
          CALL      RDBKREC1
          IF        OVRCD=1
            MOVE      "Invalid link to booking number",WEBTITLE
            CALL      ADMERR00
            GOTO      ADMS9900
          ENDIF
.
          MATCH     BKREURNO,URNUMBER
          IF        !@EQUAL
            MOVE      "Link to booking number U/R mismatch",WEBTITLE
            CALL      ADMERR00
            GOTO      ADMS9900
          ENDIF
.
          COMPARE   ZERO,BKRESTAT
          IF        !@EQUAL
            MOVE      "Invalid link to booking status",WEBTITLE
            CALL      ADMERR00
            GOTO      ADMS9900
          ENDIF
.
          MOVE      STATVISN,ADMISSNO
          MOVE      ONE,UPDATETY
          MOVE      ONE,PREADBOK
          GOTO      ADMS1400
.
ADMS1250  MATCH     "PRE",STATVTYP      * Linking to an IP visit
          GOTO      ADMS1300 IF NOT EQUAL
.
          PACK      KEY8,STATVISN,SP70
          CALL      RDMISS1
          IF        OVRCD=1
            MOVE      "Invalid link to visit number",WEBTITLE
            CALL      ADMERR00
            GOTO      ADMS9900
          ENDIF
.
          MATCH     AURNO,URNUMBER
          IF        !@EQUAL
            MOVE      "Link to admission number U/R mismatch",WEBTITLE
            CALL      ADMERR00
            GOTO      ADMS9900
          ENDIF
.
          IF        ASTAT=1
            MOVE      TWO,UPDATETY      * Admit a pre admission
            MOVE      STATVISN,ADMISSNO
            GOTO      ADMS1400
          ENDIF
.
          MOVE      "Invalid link to admission status",WEBTITLE
          CALL      ADMERR00
          GOTO      ADMS9900
.
ADMS1300  MOVE      ONE,UPDATETY
          MOVE      ZERO,PREADBOK
.
ADMS1400  MOVE      ONE,ADMITBOX
          MOVE      ONE,CONTMULT
          MOVE      ONE,STATFLAG        * flag for HL7 broadcast
.
          CALL      CLPATATR            * called to clear disch time&date value
.
          MOVE      ZERO,EXIT
          CALL      PROADM00
          BRANCH    EXIT,ADMS9900
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDMISS1
          IF        OVRCD=0
            MOVE      DISCADMN,PTMILSDN
            MOVE      ORIGADMN,PTMIOGNO
            MATCH     SP70,PTMIOGNO
            IF        @EQUAL
              PACK      PTMIOGNO,DISCADMN
            ENDIF

            MATCH     "3",DDIND9
            IF        @EQUAL
              MOVE      DD3BDY,PTMI3BDY
            ELSE
              MATCH     "B",DDIND9
              IF        @EQUAL
                MOVE      DD3BDY,PTMI3BDY
              ENDIF
            ENDIF 

            CALL      UPMISS1
          ENDIF
.
. *** copy claim condition information from previous admission
          CALL      CPCOND00
.
.
. *** copy claim details from previous admission, if same claim type this adm
.
          MATCH     ACLAIM,PRECLAIM
          GOTO      ADMS2000 IF NOT EQUAL
.
          PACK      KEY11,DISCADMN,ACLAIM,SP70
          CALL      RDPMEXT1
          BRANCH    OVRCD,ADMS2000
.
          PACK      PMEXVISN,AADMNO
          PACK      KEY11,AADMNO,PMEXCLAM,SP70
          CALL      RAPMEXT1
          IF        OVRCD=1
            CALL      WRPMEXT1
          ENDIF
.
ADMS2000  PACK      KEY8,DISCADMN,SP70
          CALL      RDDSCH1
          IF        OVRCD=0
            MOVE      AADMNO,PTDSLSDN
            CALL      UPDSCH1
          ENDIF
.
.         Get the last transfer record
.
          PACK      KEY30,AADMNO,TILDA35
          CALL      RDSTRAN2                     * pos'n after last tran record
          CALL      RDPTRAN2                     * read previous record
          BRANCH    OVRCD,ADMS8000               * eof - finish
.
          MATCH     AADMNO,TADMN                 * same admission still ?
          GOTO      ADMS8000 IF NOT EQUAL        * no - finish
.
          IF        STATFLAG=2
            CALL      PMIGTNID              * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      THIRTY3,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICAD              * broadcast statistical admission
          ENDIF
.
ADMS8000  MOVE      ZERO,STATFLAG
.
          CALL      UPDBRD00
.
          GOTO      ADMS9999
.
ADMS9900  MOVE      ONE,EXIT
.
ADMS9999  RETURN
+
.------------------------------------------------------------
. CPCOND00 - Copy condition from previous visit for statistical admission
.------------------------------------------------------------
CPCOND00  PACK      KEY88,PTMASNAM,PMPXFNAM,DISCADMN,SP70
          CALL      RDLOCA1
          BRANCH    OVRCD,CPCOND10
.
          PACK      KEY3,LPCONDC
          PACK      KEY35,LPCONDD
.
          MOVE      AADMNO,DLADMNO
          PACK      KEY88,LSNAME,LGNAME,DLADMNO,SP70
          CALL      RDLOCA1
          IF        OVRCD<>1
            PACK      LPCONDC,KEY3,SP70
            PACK      LPCONDD,KEY35,SP70
            CALL      UPLOCA1
          ENDIF
.
. *** remove the old admission condition record ***
          PACK      KEY88,PTMASNAM,PMPXFNAM,DISCADMN,SP70
          CALL      DELOCA1
.
. *** Copy working diagnosis from original record ***
CPCOND10  PACK      KEY8,DISCADMN,SP70
          CALL      RDPMWOR1
          BRANCH    OVRCD,CPCOND20
.
.
          PACK      KEY35,PMWOWDI1,SP70
          PACK      KEY35A,PMWOWDI2,SP70
          PACK      KEY35B,PMWOWDI3,SP70
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPMWOR1
          BRANCH    OVRCD,CPCOND20
.
          PACK      PMWOWDI1,KEY35,SP70
          PACK      PMWOWDI2,KEY35A,SP70
          PACK      PMWOWDI3,KEY35B,SP70
.
          CALL      UPPMWOR1
.
.
. *** Copy working diagnosis user defined comments original record ***
CPCOND20  MOVE      "018",DIM3
          PACK      KEY14,DISCADMN,DIM3,SP70
          CALL      RSVSCMT1
CPCOND25  CALL      RKVSCMT1
          BRANCH    OVRCD,CPCOND30
.
          MATCH     DISCADMN,VSCTVIST
          GOTO      CPCOND30 IF NOT EQUAL
.
          MATCH     "018",VSCTTYPE
          GOTO      CPCOND30 IF NOT EQUAL
.
          PACK      SAVKEY14,VSCTVIST,VSCTTYPE,VSCTLINE   * save position on
.                                                         * old record
.
          MOVE      AADMNO,VSCTVIST
          PACK      KEY14,VSCTVIST,VSCTTYPE,VSCTLINE
          CALL      RAVSCMT1
          IF        OVRCD=1
            CALL      WRVSCMT1
          ENDIF
.
          PACK      KEY14,SAVKEY14
          CALL      RDVSCMT1
          GOTO      CPCOND25
.
. *** Copy nutrition details from original record ***
CPCOND30  OPEN      PMSNUTA1,"pmsnutaf"       * Open nutrition file
          PACK      KEY16,DISCADMN,ADATE,Z70
          CALL      RDPMNUT1
          IF        OVRCD<>1
            GOTO      CPCOND35
          ENDIF
.
          PACK      KEY16,DISCADMN,ADATE,Z70
          CALL      RSPMNUT1
          CALL      RPPMNUT1
          BRANCH    OVRCD,CPCOND40
.
          MATCH     DISCADMN,PMNUADMN
          GOTO      CPCOND40 IF NOT EQUAL
.
CPCOND35  PACK      PMNUUPDU,WBSEUID,SP70
          PACK      PMNUUPDD,CURRDATE,CTIMEIS
          PACK      PMNUCRTU,WBSEUID,SP70
          PACK      PMNUCRTD,CURRDATE,CTIMEIS
.
          MOVE      AADMNO,PMNUADMN
          PACK      KEY16,PMNUADMN,PMNUDATE,SP70
          CALL      RAPMNUT1
          IF        OVRCD=1
            CALL      WRPMNUT1
          ENDIF
.
CPCOND40  CALL      CPCAT000
.
CPCOND99  RETURN
+
.------------------------------------------------------------
. Update Extra Diet Details (catcomaf)
.------------------------------------------------------------
CPCAT000  MATCH     "1",PTCNUTOM
          GOTO      CPCAT999 IF NOT EQUAL
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      CATCOMA1,"catcomaf"
          TRAPCLR   IO
          BRANCH    OVRCD,CPCAT999
.
          PACK      KEY17,DISCADMN,ADATE,Z70
          CALL      RSCTCOM1
CPCAT100  CALL      RPCTCOM1
          BRANCH    OVRCD,CPCAT999
.
          MATCH     DISCADMN,DCTCOADM
          GOTO      CPCAT999 IF NOT EQUAL
.
          PACK      SAVKEY17,CTCOADMN,CTCODATE,CTCOMEAL,SP70
          MOVE      AADMNO,CTCOADMN
          MOVE      ADATE,CTCODATE
.
          PACK      KEY17,CTCOADMN,CTCODATE,CTCOMEAL,SP70
          CALL      RACTCOM1
          IF        OVRCD=1
            CALL      WRCTCOM1
          ENDIF
          PACK      KEY17,SAVKEY17
          CALL      RSCTCOM1
          GOTO      CPCAT100                * check for another meal type
.
CPCAT999  CLOSE     CATCOMA1
          RETURN
+
.------------------------------------------------------------
. DISSEL00 - Display Selection List for Disasters
.------------------------------------------------------------
.
DISSEL00  PACK      KEY9,SP70
          CALL      RSDSMAS1
DISSEL10  CALL      RKDSMAS1
          BRANCH    OVRCD,DISSEL99
.
          MATCH     "3",DSMAACTV
          GOTO      DISSEL10 IF EQUAL
.
          WRITE     HTMLFILE;"<option value=#"",DSMACODE,"#">":
                             DSMADESC,"</option>"
          GOTO      DISSEL10
.
DISSEL99  RETURN
+
.------------------------------------------------------------
. DISCOD00 - Get Disaster Code for UR/Visit No
.------------------------------------------------------------
DISCOD00  PACK      KEY25,URNUMBER,SP70
          CALL      RSDSPTL1
DISCOD10  CALL      RKDSPTL1
          BRANCH    OVRCD,DISCOD99
.
          MATCH     URNUMBER,DSPLURNO
          GOTO      DISCOD99 IF NOT EQUAL
.
          MATCH     ADMISSNO,DSPLVISN
          GOTO      DISCOD10 IF NOT EQUAL
.
          MATCH     SP70,DSPLCODE
          IF        !@EQUAL & !@EOS
            WRITE     HTMLFILE;DSPLCODE;
          ENDIF
.
DISCOD99  RETURN
.------------------------------------------------------------
. DISDSC00 - Get Disaster Desc for UR/Visit No
.------------------------------------------------------------
DISDSC00  PACK      KEY25,URNUMBER,SP70
          CALL      RSDSPTL1
DISDSC10  CALL      RKDSPTL1
          BRANCH    OVRCD,DISDSC99
.
          MATCH     URNUMBER,DSPLURNO
          GOTO      DISDSC99 IF NOT EQUAL
.
          MATCH     ADMISSNO,DSPLVISN
          GOTO      DISDSC10 IF NOT EQUAL
.
          MATCH     SP70,DSPLCODE
          IF        !@EQUAL & !@EOS
            PACK      KEY9,DSPLCODE,SP70
            CALL      RDDSMAS1
            BRANCH    OVRCD,DISDSC99
.
            WRITE     HTMLFILE;DSMADESC;
          ENDIF
.
DISDSC99  RETURN
.------------------------------------------------------------
. BLKD0000 - Bulk discharge for patients input via recurring care page
.------------------------------------------------------------
BLKD0000  MOVE      ZERO,EXIT
          OPEN      PMSRCBA2,"pmsrcbaf"
          PACK      KEY16,ADMISSNO,SP70
          CALL      RSPMRCB2
          CALL      RKPMRCB2
          BRANCH    OVRCD,BLKD9000
.
          MATCH     ADMISSNO,PMRCADMN
          GOTO      BLKD9000 IF NOT EQUAL
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,BLKD9000
.
          PACK      URNUMBER,AURNO,SP70
          PACK      PTMIS001,ADATE,SP70
.
          COMPARE   "2",ASTAT
          GOTO      BLKD9100 IF NOT EQUAL
.
          PACK      KEY30,ADMISSNO,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,BLKD9000
.
          MATCH     ADMISSNO,DTADMN
          GOTO      BLKD9000 IF NOT EQUAL
.
          PACK      BEDTRKEY,TADMN,TDATE,TTIME,TWARD,TBED,SP70
          PACK      TESTKEY,TADMN,ADATE,TRANTIME,TWARD,TBED,SP70
          MATCH     TESTKEY,BEDTRKEY
          GOTO      BLKD9300 IF NOT LESS
.
          PACK      KEY8,AURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,BLKD9200
          CALL      RDPMPX21
          BRANCH    OVRCD,BLKD9200
.
          CALL      DISCH000           * Discharge
          GOTO      BLKD9999
.
BLKD9000  MOVE      "Invalid Admission Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      BLKD9999
.
BLKD9100  MOVE      "Invalid Admission Status",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      BLKD9999
.
BLKD9200  MOVE      "Invalid UR Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      BLKD9999
.
BLKD9300  MOVE      "Must be after last transfer record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      BLKD9999
.
BLKD9999  CLOSE     PMSRCBA2
          RETURN
+
.------------------------------------------------------------
. STAT0000 - Statistical Discharge/Re-admission
.------------------------------------------------------------
STAT0000  MOVE      ZERO,EXIT
          MOVE      ONE,NOMESSAG
          MOVE      ONE,DISERROR
          MOVE      ONE,STATDISC
.
          MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,STAT9200
          CALL      RDPMPX21
          BRANCH    OVRCD,STAT9200
.
. ----  Validate new admission time and claim code before discharging ---
          PACK      ADATE,PTMIS001,SP70
          PACK      ATIME,PTMIS002,SP70
          PACK      ACLAIM,PTMIS027,SP70
          CALL      VDAT0000
          BRANCH    EXIT,STAT9999
          CALL      CHKBTR00
          BRANCH    EXIT,STAT9999
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,STAT9000
          CALL      RDPMVX11
          BRANCH    OVRCD,STAT9000
.
          CALL      CHKDDS00   * check if discharge date overlaps next adm date
          BRANCH    EXIT,STAT9999
.
          CALL      CHKINT00                * Check intention to readmit
          BRANCH    EXIT,STAT9999
.
          COMPARE   "2",ASTAT
          GOTO      STAT0100 IF EQUAL
.
          COMPARE   "4",ASTAT
          GOTO      STAT9100 IF NOT EQUAL
.
STAT0100  CALL      DISS0000           * Perform Statistical Discharge
          BRANCH    EXIT,STAT9900
          CALL      ADMS0000           * Perform Statistical Admission
          BRANCH    EXIT,STAT9900
          IF        MHADMFLG=1
            CALL      MEHVIS00
          ENDIF
          GOTO      STAT9999
.
STAT9000  MOVE      "Invalid Admission Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      STAT9999
.
STAT9100  MOVE      "Invalid Admission Status",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      STAT9999
.
STAT9200  MOVE      "Invalid U/R Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      STAT9999
.
STAT9900  MOVE      ONE,EXIT    * error on readmission - message already output
.                               * from proadm00
          GOTO      STAT9999
.
STAT9999  CLOSE     COMAIJAF,DELETE
          CLOSE     COMCIJAF,DELETE
          CLOSE     COMAWKAF,DELETE
          RETURN
+
.------------------------------------------------------------
. CHKINT00 - Check intention to readmit
. Returns:    EXIT  0 = Ok to continue
.                   1 = Error
.------------------------------------------------------------
.
CHKINT00  MOVE      ZERO,FORM1
.
          COMPARE   THREE,PTCNHDPS
          GOTO      CHKINT90 IF NOT EQUAL
.
          MATCH     SP70,DSCHIRAD
          GOTO      CHKINT90 IF EQUAL
          GOTO      CHKINT90 IF EOS
.
          PACK      KEY5,ANSV,ANSR,DSCHIRAD
          CALL      RDCODE1
          BRANCH    OVRCD,CHKINT91
.
          MOVE      THCSCOD,DIM1
          MOVE      DIM1,FORM1
.
          PACK      KEY5,ANSD,ANSD,DSCHDEST
          CALL      RDCODE1
          BRANCH    OVRCD,CHKINT91
.
          MOVE      THCSCOD,DIM1A
          MATCH     "20030701",TRANDATE
          IF        @LESS
            REP       "2131415161718191D1T1Z1N2A2H2K2",DIM1A
          ELSE
            MATCH     "20190701",TRANDATE
            IF        @LESS
              REP       "S1D1T1Z1B2N2A2H2R2G1",DIM1A                   *C-60167
            ELSE
              REP       "S1D1T2Z1B2N2A2H2G1",DIM1A
            ENDIF
          ENDIF
.
          IF        FORM1=0
            MATCH     "1",DIM1A
            GOTO      CHKINT90 IF EQUAL
          ENDIF
.
          IF        FORM1>0 & FORM1<5 | FORM1=9
            MATCH     "2",DIM1A
            GOTO      CHKINT90 IF EQUAL
          ENDIF
.
          MATCH     "2",DIM1A
          GOTO      CHKINT91 IF NOT EQUAL
.
          BRANCH    FORM1,CHKINT90:              * readmit with booking
                          CHKINT90:              * readmit - no booking
                          CHKINT90:              * readmit with booking
                          CHKINT90:              * readmit - no booking
                          CHKINT91:
                          CHKINT91:
                          CHKINT91:
                          CHKINT91:
                          CHKINT90               * no plan to readmit
          GOTO      CHKINT91
.
CHKINT90  MOVE      ZERO,EXIT
          GOTO      CHKINT99
.
CHKINT91  CLEAR     WEBTITLE
          APPEND    "Invalid discharge destination for intention",WEBTITLE
          APPEND    " to readmit.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
CHKINT99  RETURN
+
.------------------------------------------------------------
. RESI0000 - Resident details
.------------------------------------------------------------
RESI0000  MOVE      ZERO,EXIT
.
          MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,RESI9100
          CALL      RDPMPX21
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDPMRES1
          IF        OVRCD=1
            CALL      CLPMSRES
          ENDIF
.
          MOVE      "7",KEY1           * Local address
          CALL      CNTY0000           * Get contact type for Local
          BRANCH    EXIT,RESI9200
.
          CALL      GLOC0000           * Get local address
.
          MOVE      SP70,KEY3
          PACK      ADMISSNO,ADMISSNO,SP70
          MATCH     SP70,ADMISSNO
          IF        !@EQUAL
            CALL      GCLM0000           * Get claim code
            IF        EXIT=0
              MOVE      ACLAIM,KEY3      * Current Claim
            ENDIF
          ENDIF
          MATCH     Z70,PMEXT002
          IF        !@EQUAL
            MOVE      PMEXT002,KEY3
          ENDIF
.
          CALL      REXT0000         * default Resident to Extra compensable
          BRANCH    UPDATETY,RESI1000
          GOTO      RESI8000
.
.         Updating PMI screen details
.
RESI1000  CALL      UCTL0000           * Update Contact details for Local addrss
          CALL      UMST0000           * Update overseas address to patma1af
          CALL      UPRES000           * Update residency details
          CALL      UPRFA000           * Update PRFA
.
.         Clear School Address is not blank then free format name of school
.         must be blank
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDPMRES1
          BRANCH    OVRCD,RESI9000
.
          MATCH     Z70,PMRES015
          IF        @EQUAL
            MOVE      SP70,PMRSSCHL
          ENDIF
          MATCH     Z70,PMRES033
          IF        @EQUAL
            UNPACK    SP70,PMRSSAD1,PMRSSAD2
            UNPACK    SP70,PMRSSAD3,PMRSSAD4
            UNPACK    SP70,PMRSSPCD,PMRSSCNT
            UNPACK    SP70,PMRSFSCH,PMRSSPHN
          ENDIF
          PACK      PMRSUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMRSUDAT
          CLOCK     TIME,PMRSUTIM
          MOVE      USERID,PMRSUUID
          CALL      UPPMRES1
          GOTO      RESI9000
.
RESI8000  MOVE      "Resident Details",WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,RESI9999
.
          CALL      WEBBOD00
          CALL      WEBEND00
          MOVE      ONE,EXIT
          GOTO      RESI9999
.
RESI9000  MOVE      ZERO,EXIT
          GOTO      RESI9999
.
RESI9100  MOVE      "Invalid U/R Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RESI9999
.
RESI9200  CLEAR     WEBTITLE
          APPEND    "Contact Type for Local Address not Setup ",WEBTITLE
          APPEND    "for Overseas",WEBTITLE
          APPEND    SP70,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RESI9999
.
RESI9999  RETURN
+
.
.******************************************************************************
.                    REMOTE SCRIPTING FUNCTION
.******************************************************************************
REMOTE00  CALL      XMLHED00
          BRANCH    EXIT,REMOTE99
.
REMOTE05  BRANCH    REMOTENO,REMOTE10,REMOTE20
          GOTO      REMOTE95
.
REMOTE10  CLEAR     CMDLINE
          APPEND    "accnoleft.us1",CMDLINE  * Send email if ACC number left are
          APPEND    SP70,CMDLINE             * less than 200
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
          GOTO      REMOTE95
.
.         Verify that the 'MR Current Location' (master tracking) is the same as
.         the ED Site 'Default MR Request Location' for auto tracking of MR from
.         ED to admitting ward.
REMOTE20  PACK      KEY8,ADMISSNO,SP70
          CALL      RDEMVIS1
          BRANCH    OVRCD,REMOTE21
.
          PACK      KEY3,EMVISITE,SP70
          CALL      RDEMSIT1
          BRANCH    OVRCD,REMOTE21
.
          CALL      RDMRVS1
          BRANCH    OVRCD,REMOTE21
.
          PACK      KEY10,MRVSMKEY,SP70    * get the medical record master
          CALL      RDMRMAS2
          BRANCH    OVRCD,REMOTE21
.
.         Verify whether the 'MR Current Location' (master tracking record)
.         is the same as the 'Default MR Request Location' of the ED Site ?
.
          MATCH     MRMACLOC,EMSTDRLC      * same location ?
          GOTO      REMOTE22 IF EQUAL
.
REMOTE21  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>0</RETURN_VALUE>"  * NO
          GOTO      REMOTE95
.
REMOTE22  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>1</RETURN_VALUE>"  * YES
          GOTO      REMOTE95
.
REMOTE95  CALL      XMLEND00
.
REMOTE99  RETURN
+
.-------------------------------------------------------------------------------
.         Check pmi resident status
.-------------------------------------------------------------------------------
VRES0000  MOVE      ZERO,F1
          PACK      KEY5,ANSC,ANSL,ACLAIM
          CALL      RDCODE1
          BRANCH    OVRCD,VRES9100
          MATCH     "E",TCINDC1
          GOTO      VRES2000 IF NOT EQUAL
.
          MOVE      ONE,F1
          COMPARE   THREE,F3
          GOTO      VRES8000 IF EQUAL
          COMPARE   FOUR,F3
          GOTO      VRES9100 IF NOT EQUAL    * overseas student visit
.
          GOTO      VRES8000
.
VRES2000  MATCH     "G",TCINDC1
          GOTO      VRES9100 IF NOT EQUAL
.
          MOVE      TWO,F1
          COMPARE   SEVEN,F3
          GOTO      VRES8000 IF EQUAL
          COMPARE   EIGHT,F3
          GOTO      VRES9100 IF NOT EQUAL    * overseas visitor visit
.
VRES8000  MOVE      ZERO,EXIT
          GOTO      VRES9999
.
VRES9100  MOVE      ONE,EXIT
          GOTO      VRES9999
.
VRES9999  RETURN
+
.-------------------------------------------------------------------------------
.         Update Contact details for Local address
.-------------------------------------------------------------------------------
UCTL0000  MOVE      "7",KEY1                * Local address
          CALL      CNTY0000                * Get contact type for Local
.
          MOVE      URNUMBER,PMCEX001
          MOVE      ACODE,PMCEX002
          PACK      PMCEX004,PTITL,SP70
          PACK      PMCEX005,PTMASNAM,SP70
          PACK      PMCEX006,PMPXFNAM,SP70
          PACK      PMCEX019,PMPXSNAM,SP70
.
          PACK      KEY14,PMCEX001,PMCEX002,SP70
          CALL      RSPMCEX1
UCTL1000  CALL      RKPMCEX1
          BRANCH    OVRCD,UCTL4000
.
          MATCH     PMCEX001,PMCEURNO
          GOTO      UCTL4000 IF NOT EQUAL
.
          MATCH     PMCEX002,PMCETYPE
.
          MATCH     PMCEX002,PMCETYPE
          GOTO      UCTL4000 IF NOT EQUAL
.
          MATCH     "1",PMCEACTV          * Skip if inactive
          GOTO      UCTL1000 IF EQUAL
.
          MOVE      PMCECNTR,PMCEX003
.
          MOVE      TWO,AUDTTYPE                 * write before audit record
          CALL      WAPMCE00
.
          CALL      MVPMCE00              * Move cgi to file vars
          PACK      PMCEUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMCEUDAT
          CLOCK     TIME,PMCEUTIM
          MOVE      USERID,PMCEUUID
          CALL      UPPMCEX1              * Update record
.  write nsw edw record for contact updated
          MOVE      "15",PMEWTYPE
          PACK      PMEWNEWV,PMCEURNO,PMCETYPE,PMCECNTR,SP70
          CALL      WREDW000
.
          MOVE      THREE,AUDTTYPE               * write after audit record
          CALL      WAPMCE00
.
          GOTO      UCTL6000
.
UCTL4000  CALL      CONC0000              * Calculate contact counter
.
          CALL      CLPMSCEX              * Clear extra contact details
.
          CALL      MVPMCE00              * Move cgi to file vars
.
          MATCH     SP70,PMCEADD1
          GOTO      UCTL6000 IF EQUAL
.
          PACK      PMCECDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMCECDAT
          CLOCK     TIME,PMCECTIM
          MOVE      USERID,PMCECUID
.
          CALL      CONU0000              * Get contact webPAS unique id
.
          PACK      KEY14,PMCEX001,PMCEX002,PMCEX003,SP70
          CALL      WRPMCEX1              * Write record
.  write nsw edw record for contact added
          MOVE      "14",PMEWTYPE
          PACK      PMEWNEWV,PMCEURNO,PMCETYPE,PMCECNTR,SP70
          CALL      WREDW000
.
          MOVE      ONE,AUDTTYPE            * write add audit record
          CALL      WAPMCE00
.
.         If we are using the new contacts table (pmscexaf), then
.         trigger a PMI update message so that the latest contact details
.         will be sent in a broadcast message.
.
UCTL6000  MATCH     "1",PTCNNEWC            * using new contacts ?
          GOTO      UCTL9999 IF NOT EQUAL   * no
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TWENTY5,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICUP                * send HL7 message
.
UCTL9999  RETURN
+
.-----------------------------------------------------------------
.     Get the first Contact type code for a particular indicator
.-----------------------------------------------------------------
CNTY0000  MOVE      ONE,EXIT
          MOVE      "tc",KEY2
          PACK      KEY5,KEY2,SP70
          CALL      RDSCODE1
CNTY1000  CALL      RDKCODE1
          BRANCH    OVRCD,CNTY9999
          MATCH     KEY2,TCODE
          GOTO      CNTY9999 IF NOT EQUAL
          MATCH     "A",PTCOACTV
          GOTO      CNTY1000 IF NOT EQUAL      * Not active
.
          MATCH     KEY1,TCINDC1
          GOTO      CNTY1000 IF NOT EQUAL      * Indicator for Local address
          MOVE      ZERO,EXIT
CNTY9999  RETURN
+
.**********************************************************************
.         Update Default Printer File for User
.**********************************************************************
UPDEFP00  OPEN      IBAPDFA1,"ibapdfaf"
          PACK      KEY20,SETDFPRG,KEY2,WBSEUID,SP70
          UNPACK    KEY20,IBPDPID,IBPDREP,IBPDUID
          REP       " 0",IBPDREP
          MOVE      SCHDPRNT,IBPDPRT
          MOVE      SCHDCOPY,IBPDCOP         * no of copies
          MOVE      STATNCOD,IBPDDOC        * save stat code to document code
          MOVE      SP70,IBPDNUM
          MOVE      SP70,IBPDSPA
          CALL      RAIBPD1
          IF        OVRCD=0
            CALL      UPIBPD1
          ELSE
            CALL      WRIBPD1
          ENDIF
UPDEFP99  RETURN
+
.*************************************************************************
.         Default Resident record to Extra compensable
.*************************************************************************
REXT0000  MOVE      ONE,F1
          PACK      KEY11,ADMISSNO,KEY3
          CALL      RDPMEXT1
          COMPARE   ZERO,OVRCD
          GOTO      REXT9999 IF EQUAL
.
          CALL      CLPMSEXT                     * Clear extra compensable
          MOVE      SP70,KEY1
          PACK      KEY5,ANSC,ANSL,KEY3
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TCINDC1,KEY1
          ENDIF
          MOVE      KEY3,PMEXCLAIM               * Claim code
          MATCH     "H",KEY1
          GOTO      REXT0200 IF EQUAL            * Private
          MATCH     "E",KEY1
          GOTO      REXT1000 IF EQUAL            * Overseas student
          MATCH     "G",KEY1
          GOTO      REXT2000 IF EQUAL            * Overseas visitor
          GOTO      REXT9999
.
REXT0200  PACK      KEY8,URNUMBER
          CALL      RDPMPX21
          BRANCH    OVRCD,REXT9999
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          IF        OVRCD=0
            MOVE      PFUNDH,AFUNDH          * default Health Fund from Master
            MOVE      PFNDTB,AFNDTB
            MOVE      PFNDMM,AFNDMM
            CALL      UPMISS1
            CALL      RDPMVX11
            IF        OVRCD=0
              PACK      PMVXFNDM,AFNDMM,SP70
              PACK      PMVXCONM,PMPXHFCN,SP70
              CALL      UPPMVX11
            ENDIF
          ENDIF
          GOTO      REXT9999
.
REXT1000  MOVE      PMRSSTDN,PMEXIDNO            * Student id
          MOVE      PMRSSCHL,PMEXSCHL            * Name of School
          MOVE      PMRSINFM,PMEXOMEM            * Insurance/Fund Membership no
.
          MOVE      PMRSFSCH,PMEXECON            * free format Name of School
          MOVE      PMRSSAD1,PMEXCAD1            * school Address
          MOVE      PMRSSAD2,PMEXCAD2
          MOVE      PMRSSAD3,PMEXCAD3
          MOVE      PMRSSAD4,PMEXCAD4
          MOVE      PMRSSPCD,PMEXCPCD
          MOVE      PMRSSCNT,PMEXCNAM            * school contact
          MOVE      PMRSSPHN,PMEXCPHN            * school phone
          GOTO      REXT8000
.
REXT2000  MOVE      PMRSSBIL,PMEXSBIL            * send bill to local address
          MOVE      PMRSVTYP,PMEXVTYP            * visa type
.
          MOVE      PMRSECON,PMEXECON            * employer name
          MOVE      PMRSCAD1,PMEXCAD1            * employer Address
          MOVE      PMRSCAD2,PMEXCAD2
          MOVE      PMRSCAD3,PMEXCAD3
          MOVE      PMRSCAD4,PMEXCAD4
          MOVE      PMRSCPCD,PMEXCPCD
          MOVE      PMRSCCNT,PMEXCNAM            * employer contact
          MOVE      PMRSCPHN,PMEXCPHN            * employer phone
.
          MOVE      PMRSTINS,PMEXTINS            * travel insurance
          MOVE      PMRSIPOL,PMEXIPOL            * travel insurance policy no
.
REXT8000  MOVE      PMRSINCD,PMEXICOD            * Insurance code
          MOVE      PMRSINEX,PMEXIEDT            * Insurance Expiry date
          MOVE      PMRSPNUM,PMEXPASN            * Passport no
          MOVE      PMRSPCOU,PMEXPASC            * Passport country
          MOVE      PMRSVEXP,PMEXVEXP            * Visa expiry date
.
          MOVE      PMRSUCM1,PMEXUCM1            * Comments 1
          MOVE      PMRSUCM2,PMEXUCM2            * Comments 2
          MOVE      PMRSUCM3,PMEXUCM3            * Comments 3
.
REXT9999  RETURN
+
.-------------------------------------------------------------------------------
.         Update (pmi)residency from extra compensable
.-------------------------------------------------------------------------------
URES0000  PACK      KEY8,URNUMBER,SP70
          CALL      RDPMRES1
          IF        OVRCD=1
            CALL      CLPMSRES
            PACK      PMRSURNO,URNUMBER,SP70
            PACK      PMRSCDAT,CCC,CYY,CMM,CDD
            REP       " 0",PMRSCDAT
            CLOCK     TIME,PMRSCTIM
            MOVE      USERID,PMRSCUID
.
            PACK      KEY8,URNUMBER,SP70
            CALL      RAPMRES1
            IF        OVRCD=1
              CALL      WRPMRES1
            ENDIF
.
            CALL      RDPMRES1
          ENDIF
.
          PACK      KEY5,ANST,SP1,PTYPE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,URES9999
          MATCH     "S",TCINDC3
          GOTO      URES1000 IF EQUAL            * Overseas student
          MATCH     "O",TCINDC3
          GOTO      URES2000 IF EQUAL            * Overseas visitor
          GOTO      URES9999
.
.         Updating overseas student from visit to pmi details
.
URES1000  MOVE      PMEXIDNO,PMRSSTDN            * Student id
          MOVE      PMEXSCHL,PMRSSCHL            * Name of School
          MOVE      PMEXOMEM,PMRSINFM            * Insurance/Fund Membership no
.
          MOVE      PMEXECON,PMRSFSCH            * free format Name of School
          MOVE      PMEXCAD1,PMRSSAD1            * school Address
          MOVE      PMEXCAD2,PMRSSAD2
          MOVE      PMEXCAD3,PMRSSAD3
          MOVE      PMEXCAD4,PMRSSAD4
          MOVE      PMEXCPCD,PMRSSPCD
          MOVE      PMEXCNAM,PMRSSCNT            * school contact
          MOVE      PMEXCPHN,PMRSSPHN            * school phone
          GOTO      URES8000
.
.         Updating overseas visitor from visit to pmi details
.
URES2000  MOVE      PMEXSBIL,PMRSSBIL            * send bill to local address
          MOVE      PMEXVTYP,PMRSVTYP            * visa type
.
          MOVE      PMEXECON,PMRSECON            * employer name
          MOVE      PMEXCAD1,PMRSCAD1            * employer Address
          MOVE      PMEXCAD2,PMRSCAD2
          MOVE      PMEXCAD3,PMRSCAD3
          MOVE      PMEXCAD4,PMRSCAD4
          MOVE      PMEXCPCD,PMRSCPCD
          MOVE      PMEXCNAM,PMRSCCNT            * employer contact
          MOVE      PMEXCPHN,PMRSCPHN            * employer phone
.
          MOVE      PMEXTINS,PMRSTINS            * travel insurance
          MOVE      PMEXIPOL,PMRSIPOL            * travel insurance policy no
.
URES8000  MOVE      PMEXICOD,PMRSINCD            * Insurance code
          MOVE      PMEXIEDT,PMRSINEX            * Insurance Expiry date
          MOVE      PMEXPASN,PMRSPNUM            * Passport no
          MOVE      PMEXPASC,PMRSPCOU            * Passport country
          MOVE      PMEXVEXP,PMRSVEXP            * Visa expiry date
.
          MOVE      PMEXUCM1,PMRSUCM1            * Comments
          MOVE      PMEXUCM2,PMRSUCM2
          MOVE      PMEXUCM3,PMRSUCM3
.
          PACK      PMRSUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMRSUDAT
          CLOCK     TIME,PMRSUTIM
          MOVE      USERID,PMRSUUID
          CALL      UPPMRES1
.
          GOTO      URES9999
.
URES9999  RETURN
+
.-------------------------------------------------------------------------------
.         Update Overseas address to master file
.-------------------------------------------------------------------------------
UMST0000  PACK      KEY8,URNUMBER
          CALL      RDMAST1
          BRANCH    OVRCD,UMST9999
.
          MOVE      ONE,F1
          MATCH     PTMAS008,Z70
          IF        !@EQUAL
            MOVE      PTMAS008,PADD1
            MOVE      ZERO,F1
          ENDIF
          MATCH     PTMAS009,Z70
          IF        !@EQUAL
            MOVE      PTMAS009,PADD2
            MOVE      ZERO,F1
          ENDIF
          MATCH     PTMAS010,Z70
          IF        !@EQUAL
            MOVE      PTMAS010,PSUBRB
            MOVE      ZERO,F1
          ENDIF
          MATCH     PTMAS011,Z70
          IF        !@EQUAL
            MOVE      PTMAS011,PADD4
            MOVE      ZERO,F1
          ENDIF
          MATCH     PTMAS012,Z70
          IF        !@EQUAL
            MOVE      PTMAS012,PPOST
            MOVE      ZERO,F1
          ENDIF
          BRANCH    F1,UMST9999
          CALL      UPMAST1
.
UMST9999  RETURN
+
.-------------------------------------------------------------------------------
.  DISWAR00 - Disaster Validations and Warnings
.-------------------------------------------------------------------------------
DISWAR00  MATCH     SP70,DISPT001
          GOTO      DISWAR99 IF EQUAL
          GOTO      DISWAR99 IF EOS
.
          PACK      KEY9,DISPT001,SP70
          CALL      RDDSMAS1
          IF        OVRCD=ONE
            MOVE      "Disaster Master Record not found.",WEBTITLE
            ADD       ONE,WARCOUNT
            MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
            GOTO      DISWAR99
          ENDIF
.
          MATCH     SP70,DSMASDAT
          IF        !@EQUAL & !@EOS
            MATCH     DSMASDAT,PVIDATE
            IF        @LESS
              MOVE      "Visit Date is not on or after the Disaster Start Date. Disaster Record not posted.",WEBTITLE
              ADD       ONE,WARCOUNT
              MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
              GOTO      DISWAR99
            ENDIF
          ENDIF
.
          MATCH     "1",PTCNUDPD
          IF        @EQUAL
            MATCH     SP70,DSMAEDAT
            IF        !@EQUAL & !@EOS
              MATCH     PVIDATE,DSMAEDAT
              IF        @LESS
                MOVE      "Visit Date is not prior to the Disaster End Date. Disaster Record not posted.",WEBTITLE
                ADD       ONE,WARCOUNT
                MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
                GOTO      DISWAR99
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      PURNO,DSPTURNO
          MOVE      DISPT002,DSPTDIID
          MOVE      DISPT001,DSPTCODE
.         MOVE      DSMASDAT,DSPTSDAT
          MOVE      PVIDATE,DSPTSDAT
          MOVE      DSMAEDAT,DSPTEDAT
          MOVE      SP70,DSPTOTCM
          MOVE      " 3",DSPTFICA
          MOVE      SP70,DSPTSPAR
.
          PACK      KEY17,PURNO,DISPT001,SP70
          CALL      RADSPAT1
          IF        OVRCD=1
            MOVE      WBSEUID,DSPTCUSR
            CALL      IBACLOCK
            PACK      DSPTCDAT,CCC,CYY,CMM,CDD
            REP       " 0",DSPTCDAT
            CLOCK     TIME,CTIMEIS
            MOVE      CTIMEIS,DSPTCTIM
            MOVE      SP70,DSPTUUSR
            MOVE      SP70,DSPTUDAT
            MOVE      SP70,DSPTUTIM
            CALL      WRDSPAT1
          ELSE
            MOVE      WBSEUID,DSPTUUSR
            CALL      IBACLOCK
            PACK      DSPTUDAT,CCC,CYY,CMM,CDD
            REP       " 0",DSPTUDAT
            CLOCK     TIME,CTIMEIS
            MOVE      CTIMEIS,DSPTUTIM
            CALL      UPDSPAT1
          ENDIF
.
          MOVE      PURNO,DSPLURNO
          MOVE      DISPT001,DSPLCODE
          MOVE      DPVIBILL,DSPLVISN
          MOVE      SP70,DSPLSPAR
          PACK      KEY25,PURNO,DISPT001,DPVIBILL,SP70
          CALL      RADSPTL1
          IF        OVRCD=1
            MOVE      WBSEUID,DSPLCUSR
            CALL      IBACLOCK
            PACK      DSPLCDAT,CCC,CYY,CMM,CDD
            REP       " 0",DSPLCDAT
            CLOCK     TIME,CTIMEIS
            MOVE      CTIMEIS,DSPLCTIM
            MOVE      SP70,DSPLUUSR
            MOVE      SP70,DSPLUDAT
            MOVE      SP70,DSPLUTIM
            CALL      WRDSPTL1
          ELSE
            MOVE      WBSEUID,DSPLUUSR
            CALL      IBACLOCK
            PACK      DSPLUDAT,CCC,CYY,CMM,CDD
            REP       " 0",DSPLUDAT
            CLOCK     TIME,CTIMEIS
            MOVE      CTIMEIS,DSPTUTIM
            CALL      UPDSPTL1
          ENDIF
.
          CALL     NWDALT00
.
DISWAR99  RETURN
.
.---------------------------------------------------------------------
. NWDALT00 - Write a new alternate ID record for disaster patients
.---------------------------------------------------------------------
NWDALT00  PACK      PMAIURNO,PURNO,SP70
.
          MATCH     SP70,DSMAAICD
          GOTO      NWDALT99 IF EQUAL
          GOTO      NWDALT99 IF EOS
.
          PACK      PMAITYPE,DSMAAICD,SP70
.
          MATCH     SP70,DSPTDIID
          GOTO      NWDALT99 IF EQUAL
          GOTO      NWDALT99 IF EOS
.
          PACK      KEY5,ANSA,ANSI,DSMAAICD,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MATCH     SP70,TCINDC1
            IF        !@EQUAL & !@EOS
              MATCH     SP70,TCINDC3
              IF        !@EQUAL & !@EOS
                PACK      PMAIALID,TCINDC1,TCINDC3,DSPTDIID,SP70
              ELSE
                PACK      PMAIALID,TCINDC1,DSPTDIID,SP70
              ENDIF
            ELSE
              PACK      PMAIALID,DSPTDIID,SP70
            ENDIF
          ELSE
            PACK      PMAIALID,DSPTDIID,SP70
          ENDIF
.
          RJUSTIFY  PMAIALID
          PACK      PMAIDISU,SP70
          PACK      PMAIHOSP,SP70
          READ      CONTROLF,HUND10;*249,PTCNDAUR
          MATCH     "1",PTCNDAUR
          IF        @EQUAL
            MOVE      "1",PMAIDISU
          ENDIF
          PACK      PMAIRDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMAIRDAT
          UNPACK    SP70,PMAISPAR
.
          PACK      KEY31,PMAIURNO,PMAITYPE,PMAIALID,SP70
          CALL      RAPMAID1
          IF        OVRCD<>1
            GOTO      NWDALT99
          ENDIF
.
          MOVE      USERID,PMAICRUD
          CALL      IBACLOCK
          PACK      PMAICRDT,CCC,CYY,CMM,CDD
          REP       " 0",PMAICRDT
          MOVE      CTIMEIS,PMAICRTM
          MOVE      SP70,PMAIUPDT
          MOVE      SP70,PMAIUPTM
          MOVE      SP70,PMAIUPUD
.
          CALL      WRPMAID1
.  write nsw edw record for UPI added
          PACK      KEY5,ANSA,ANSI,PMAITYPE,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            MATCH     ANSU,TCINDC4
            IF        @EQUAL
              MOVE      "16",PMEWTYPE
              PACK      PMEWNEWV,PMAIURNO,PMAITYPE,PMAIALID,SP70
              CALL      WREDW000
            ENDIF
          ENDIF
.
          CALL      PMIGTNID                   * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TWENTY9,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICUP                     * trigger PMI update message
.
NWDALT99  RETURN
+
.---------------------------------------------------------------------
. DELALT00 - Delete alternate ID record for disaster patients
.---------------------------------------------------------------------
DELALT00  UNPACK    SAVDISKY,DIM8,DIM9
          PACK      KEY9,DIM9,SP70
          CALL      RDDSMAS1
          BRANCH    OVRCD,DELALT99
.
          MATCH     SP70,DSMAAICD
          GOTO      DELALT99 IF EQUAL
          GOTO      DELALT99 IF EOS
.
          PACK      KEY31,DIM8,DSMAAICD,SP70
          CALL      RSPMAID1
          CALL      RKPMAID1
          BRANCH    OVRCD,DELALT99
.
          MATCH     PMAIURNO,DIM8
          GOTO      DELALT99 IF NOT EQUAL
.
          MATCH     PMAITYPE,DSMAAICD
          GOTO      DELALT99 IF NOT EQUAL
.
          PACK      KEY31,PMAIURNO,PMAITYPE,PMAIALID,SP70
          CALL      DEPMAID1
.
DELALT99  RETURN
+
.-------------------------------------------------------------------------------
. LIN10000 - List of Insurance Companies for Other Compensable Details Screen
.-------------------------------------------------------------------------------
LIN10000  PACK      KEY6,SP70
          CALL      RDSINSR1
LIN11000  CALL      RDKINSR1
          BRANCH    OVRCD,LIN19999
.
          PACK      KEY8,QUOTE,ICODE,QUOTE
          MATCH     ICODE,PMEXSCHL
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY8," selected>":
                               INAME,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY8,">",INAME,"</option>"
          ENDIF
.
          GOTO      LIN11000
.
LIN19999  RETURN
+
.------------------------------------------------------------
. Update mehhlsaf for WAHealth
.------------------------------------------------------------
UPMHHL00  PACK      KEY32,URNUMBER,Z70
          CALL      RSMHHLS2
UPMHHL10  CALL      RPMHHLS2
          BRANCH    OVRCD,UPMHHL99
.
          MATCH     URNUMBER,MHHLURNO
          GOTO      UPMHHL99 IF NOT EQUAL
.
          PACK      MHHLAMDT,MHVIAMDT,SP70
          PACK      MHHLAMTM,MHVIAMTM,SP70
          PACK      MHHLRODT,MHVIRODT,SP70
          PACK      MHHLROTM,MHVIROTM,SP70
.
.         MOVE      MHVIAMDT,MHHLAMDT
.         MOVE      MHVIAMTM,MHHLAMTM
.         MOVE      MHVIRODT,MHHLRODT
.         MOVE      MHVIROTM,MHHLROTM
.
          CALL      UPMHHLS2
.
.         GOTO      UPMHHL10
.
UPMHHL99  RETURN
.
.------------------------------------------------------------
. Get first active alternate address
.------------------------------------------------------------
GALT0000  PACK      KEY14,URNUMBER,PTCNAADR,SP70
          CALL      RSPMCEX1
GALT1000  CALL      RKPMCEX1
          BRANCH    OVRCD,GALT9000
.
          MATCH     URNUMBER,PMCEURNO
          GOTO      GALT9000 IF NOT EQUAL
.
          MATCH     PTCNAADR,PMCETYPE
          GOTO      GALT9000 IF NOT EQUAL
.
          MATCH     "1",PMCEACTV
          GOTO      GALT1000 IF EQUAL
.
          GOTO      GALT9999
.
GALT9000  CALL      CLPMSCEX
          GOTO      GALT9999
.
GALT9999  RETURN
.
.------------------------------------------------------------
. Get first active local address
.------------------------------------------------------------
GLOC0000  PACK      KEY14,URNUMBER,ACODE,SP70
          CALL      RSPMCEX1
GLOC1000  CALL      RKPMCEX1
          BRANCH    OVRCD,GLOC9000
.
          MATCH     URNUMBER,PMCEURNO
          GOTO      GLOC9000 IF NOT EQUAL
.
          MATCH     ACODE,PMCETYPE
          GOTO      GLOC9000 IF NOT EQUAL
.
          MATCH     "1",PMCEACTV
          GOTO      GLOC1000 IF EQUAL
.
          GOTO      GLOC9999
.
GLOC9000  CALL      CLPMSCEX
          GOTO      GLOC9999
.
GLOC9999  RETURN
.
.*****************************************************************************
.*  WRWATR00
.*  Procedure to write to the WA triggers table if required
.*****************************************************************************
          DEFPROC   WRWATR00
.
          INC       PMSWTRFD/INC
.
          COMPARE   SIX,PTCNHDPS           * If not WA - exit
          GOTO      WRWATR99 IF NOT EQUAL
.
          OPEN      PMSWTRA1,"pmswtraf"
.
          COMPARE   THREE,ASTAT
          GOTO      WRWATR99 IF NOT EQUAL
.
          BRANCH    STATDISC,WRWATR10
.
          MATCH     Z70,WAABWGHT
          IF        !@EQUAL
            MATCH     WAABWGHT,ABWGHT
            GOTO      WRWATR10 IF NOT EQUAL
          ENDIF
.
          MATCH     Z70,WAASRCE
          IF        !@EQUAL
            MATCH     ASRCE,WAASRCE
            GOTO      WRWATR10 IF NOT EQUAL
          ENDIF
.
          MATCH     Z70,WAACLSS
          IF        !@EQUAL
            MATCH     ACLSS,WAACLSS
            GOTO      WRWATR10 IF NOT EQUAL
          ENDIF
.
          MATCH     Z70,WAEXAUTH
          IF        !@EQUAL
            MATCH     PMEXAUTH,WAEXAUTH
            GOTO      WRWATR10 IF NOT EQUAL
          ENDIF
.
          MATCH     Z70,WAEXAUDA
          IF        !@EQUAL
            MATCH     PMEXAUDA,WAEXAUDA
            GOTO      WRWATR10 IF NOT EQUAL
          ENDIF
          GOTO      WRWATR99
.
WRWATR10  PACK      KEY19,WBSEHOSP,AADMNO,SP70
          CALL      RDPMWTR1
          IF        OVRCD<>1
            GOTO      WRWATR99    * record is already on file to be resent
          ENDIF
.
          CALL      IBACLOCK                * Get the current date
          PACK      PMWTCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMWTCDAT
          MOVE      CTIMEIS,PMWTCTIM
.
          PACK      PMWTHOSP,WBSEHOSP,SP70
          PACK      PMWTVISN,AADMNO,SP70
          PACK      PMWTSDAT,SP70
          PACK      PMWTMDAT,SP70
          PACK      PMWTWEBC,WBSEUID,SP70
.
          PACK      KEY19,PMWTHOSP,PMWTVISN,PMWTSDAT,SP70
          CALL      RAPMWTR1
          IF        OVRCD=1
            CALL      WRPMWTR1
          ENDIF
          GOTO      WRWATR99
.
          INC       PMSWTRIO/INC
          INC       IBAOVRIO/INC
.
WRWATR99  CLOSE     PMSWTRA1
.
          ENDPROC
+
.*****************************************************************************
.*  GMHTRN00
.*  Get Mental Health Transfer
.*****************************************************************************
GMHTRN00  PACK      KEY30,AADMNO,SP70
          CALL      RDSTRAN2
GMHTRN10  CALL      RDKTRAN2
          BRANCH    OVRCD,GMHTRN99
.
          MATCH     AADMNO,TADMN
          GOTO      GMHTRN99 IF NOT EQUAL
.
          MATCH     SP70,TDEPT
          GOTO      GMHTRN10 IF EQUAL
.
          PACK      KEY5,ANSA,ANSC,TDEPT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,GMHTRN10
.
          MATCH     "P",TCINDC5
          GOTO      GMHTRN10 IF NOT EQUAL
.
          WRITE     HTMLFILE;ONE;
.
GMHTRN99  RETURN
+
.------------------------------------------------------------
. Write WL Field Change Audit for unadmit (cancel admission)
.------------------------------------------------------------
WRCHU000  OPEN      WATCHAA1,"watchaaf"
.
          PACK      WTCHURNO,WMURNO,SP70
          PACK      WTCHPROC,WMCODE,SP70
          PACK      WTCHPCNT,WMCNT,SP70
.
          CALL      IBACLOCK
          PACK      WTCHDATE,CCC,CYY,CMM,CDD
          REPLACE   " 0",WTCHDATE
          CLOCK     TIME,WTCHTIME
.
          PACK      WTCHUPTY,TEN2,SP70
          PACK      WTCHREAS,PTUNCANC,SP70
          MOVE      USERID,WTCHUSID
          PACK      WTCHOVAL,ADATE,ATIME,SP70
          PACK      WTCHCVAL,SP70
.
          PACK      KEY35,WTCHURNO,WTCHPROC,WTCHPCNT,WTCHDATE,WTCHTIME,SP70
          CALL      RDWTCHA1
          IF        OVRCD=1
            CALL      WRWTCHA1
          ENDIF
.
          CLOSE     WATCHAA1
.
WRCHU999  RETURN
+
.-------------------------------------------------------------
. Validate deceased date is not before the date of birth
. Returns:    EXIT  0 = Ok to continue
.                   1 = Error
.-------------------------------------------------------------
VALDEC00  MATCH     SP70,PBDATE                  * Blank date of birth
          GOTO      VALDEC80 IF EQUAL
.
          MATCH     SP70,PDECDTE                 * Blank deceased date
          GOTO      VALDEC80 IF EQUAL
.
          MATCH     PBDATE,PDECDTE               * Deceased < DOB
          GOTO      VALDEC90 IF LESS
.
VALDEC80  MOVE      ZERO,EXIT
          GOTO      VALDEC99
.
VALDEC90  CLEAR     WEBTITLE
          APPEND    "Patient cannot ",WEBTITLE
          APPEND    " be deceased before their date of birth.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VALDEC99
.
VALDEC99  RETURN
+
.*****************************************************************************
.*                            PREVHS00                                      *
.*         Copy previous hospitalisation details of emeregneyc visit         *
.*****************************************************************************
PREVHS00  OPEN      PMSPHSA1,"pmsphsaf"
          MATCH     SP70,PREVEMRA
          GOTO      PREVHS90 IF EQUAL
          GOTO      PREVHS90 IF EOS
.
          PACK      KEY29,PREVEMRA,SP70
          CALL      RSPMPHS1
PREVHS10  CALL      RKPMPHS1
          BRANCH    OVRCD,PREVHS90
.
          MATCH     PREVEMRA,PMPHADMN
          GOTO      PREVHS90 IF NOT EQUAL
.
          PACK      SAVKEY29,PMPHADMN,PMPHADAT,PMPHDDAT,PMPHPHOS,SP70
.
          MOVE      ADMISSNO,PMPHADMN
.
          PACK      KEY29,PMPHADMN,PMPHADAT,PMPHDDAT,PMPHPHOS,SP70
          CALL      RAPMPHS1
          IF        OVRCD=1
            CALL      WRPMPHS1
          ENDIF
.
          PACK      KEY29,SAVKEY29,SP70
          CALL      RDPMPHS1
.
          GOTO      PREVHS10
.
PREVHS90  CALL      CORIG000
.
PREVHS99  CLOSE     PMSPHSA1
          RETURN
.------------------------------------------------------------
. Calculate original admission date and no. days hospitalisation
.------------------------------------------------------------
CORIG000  MOVE      ZERO,FORM8
          MOVE      ZERO,NODAYS
          MOVE      ZERO,TOTNDAYS
          MOVE      ZERO,TOT3BDAY
          REP       "+ ",ADMISSNO
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,CORIG999
.
          MOVE      ZERO,ADYHOSP
          MOVE      ZERO,PTMI3BDY
          PACK      PTMI3BAD,SP70
          MOVE      ADATE,SAVEADAT
.
          PACK      KEY29,ADMISSNO,ADATE,Z70
          CALL      RSPMPHS1
CORIG100  CALL      RPPMPHS1
          BRANCH    OVRCD,CORIG900
.
          MATCH     ADMISSNO,PMPHADMN
          GOTO      CORIG900 IF NOT EQUAL
.
          MOVE      ZERO,F8
          DAYSEP    PMPHDDAT,SAVEADAT,F8
          IF        F8 > 7
            GOTO      CORIG900
          ENDIF
.
          PACK      PTMI3BAD,PMPHADAT,SP70
          DAYSEP    PMPHADAT,PMPHDDAT,NODAYS
          PACK      DIM8,SAVEADAT,SP70
          MATCH     PMPHDDAT,DIM8
          IF        @EQUAL
            COMPARE   ZERO,NODAYS
            IF        !@LESS
.....         SUB       ONE,NODAYS
            ENDIF
          ENDIF
          MOVE      PMPHADAT,SAVEADAT
          MOVE      ZERO,F8
          SQUEEZE   PMPHLDAY
          MOVE      PMPHLDAY,F8
          SUB       F8,NODAYS
.
          IF        IBCNMHOS=1
            MOVE      AADMNO,KEY8
            CALL      RDPMVX11
            IF        OVRCD=0
              MATCH     SP70,PMVXMHOS           * Hospital id
              IF        !@EQUAL
                OPEN      PATHSPA1,"pathspaf"   * limited no of open files
                PACK      KEY3,PMVXMHOS,SP70
                CALL      RDPTHSP1
                IF        OVRCD=0
                  MATCH     "1",PTHSHOST        * Public hospital
                  GOTO      CORIG800 IF EQUAL
                ENDIF
              ENDIF
            ENDIF
          ELSE
            BRANCH    CHOSTYP,CORIG800          * Public hospital
          ENDIF
.
          MATCH     "1",PMPHINCB
          IF        @EQUAL
            ADD       NODAYS,TOTNDAYS
            MOVE      TOTNDAYS,ADYHOSP
          ENDIF
.
          MATCH     "1",PMPHINCC
          IF        @EQUAL
            ADD       NODAYS,TOT3BDAY
            MOVE      TOT3BDAY,PTMI3BDY
          ENDIF
.
          GOTO      CORIG100
.
.         WA health
.
CORIG800  ADD       NODAYS,TOTNDAYS
          MOVE      TOTNDAYS,ADYHOSP
          MOVE      TOTNDAYS,PTMI3BDY
.
          GOTO      CORIG100
.
CORIG900  CALL      UPMISS1
          GOTO      CORIG999
.
CORIG999  RETURN
.
+
.------------------------------------------------------------
. Emergency Visit - Calculate orig admission date and no. days hospitalisation
.------------------------------------------------------------
EORIG000  OPEN      PMSPHSA1,"pmsphsaf"
          MOVE      ZERO,FORM8
          MOVE      ZERO,NODAYS
          MOVE      ZERO,TOTNDAYS
          MOVE      SP70,SAVEADAT
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDEMVIS1
          BRANCH    OVRCD,EORIG999
.
          MOVE      ZERO,ADYHOSP
          MOVE      ZERO,CALCTOTD
          MOVE      EMVIDATE,SAVEADAT
.
          PACK      KEY29,ADMISSNO,EMVIDATE,Z70
          CALL      RSPMPHS1
EORIG100  CALL      RPPMPHS1
          BRANCH    OVRCD,EORIG900
.
          MATCH     ADMISSNO,PMPHADMN
          GOTO      EORIG900 IF NOT EQUAL
.
          MOVE      ZERO,F8
          DAYSEP    PMPHDDAT,SAVEADAT,F8
          IF        F8 > 7
            GOTO      EORIG900
          ENDIF
.
          DAYSEP    PMPHADAT,PMPHDDAT,NODAYS
          PACK      DIM8,SAVEADAT,SP70
          MATCH     PMPHDDAT,DIM8
          IF        @EQUAL
            COMPARE   ZERO,NODAYS
            IF        !@LESS
.....         SUB       ONE,NODAYS
            ENDIF
          ENDIF
          MOVE      PMPHADAT,SAVEADAT
          MOVE      ZERO,F8
          SQUEEZE   PMPHLDAY
          MOVE      PMPHLDAY,F8
          SUB       F8,NODAYS
          ADD       NODAYS,TOTNDAYS
          MOVE      TOTNDAYS,ADYHOSP
          MOVE      TOTNDAYS,CALCTOTD
.
          GOTO      EORIG100
.
..EORIG900  WRITE     HTMLFILE;CALCTOTD,SAVEADAT;
EORIG900
          GOTO      EORIG999
.
EORIG999  CLOSE     PMSPHSA1
          RETURN
.

.------------------------------------------------------------
. Write an update demographics record (pmsupdaf)
.------------------------------------------------------------
WRUPD000  OPEN      PMSUPDA1,"pmsupdaf"
.
          PACK      PMUDURNO,URNUMBER,SP70
.
          CALL      IBACLOCK
          PACK      PMUDDATE,CCC,CYY,CMM,CDD
          REPLACE   " 0",PMUDDATE
          CLOCK     TIME,PMUDTIME
.
          PACK      KEY8,PMUDURNO,SP70
          CALL      RDPMUPD1
          IF        OVRCD=1
            CALL      IBACLOCK
            PACK      PMUDDATC,CCC,CYY,CMM,CDD
            REPLACE   " 0",PMUDDATC
            CLOCK     TIME,PMUDTIMC
            PACK      PMUDUSER,USERID,SP70
            PACK      PMUDWEBC,USERID,SP70
.
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            CALL      WRPMUPD1
            TRAPCLR   IO

          ELSE
            CALL      IBACLOCK
            PACK      PMUDDATE,CCC,CYY,CMM,CDD
            REPLACE   " 0",PMUDDATE
            CLOCK     TIME,PMUDTIME
            PACK      PMUDUSER,USERID,SP70
            CALL      UPPMUPD1
          ENDIF
.
          CLOSE     PMSUPDA1
.
WRUPD999  RETURN
.
+
.******************************************************************************
.*                                 SH7VP000                                   *
.*                      Save PMI HL7 visit trigger variables                  *
.******************************************************************************
SH7VP000  PACK      SAVXPRVI,PMPXPRVI,SP70
          PACK      SAVXRHC1,PMPXRHC1,SP70
          PACK      SAVXRH1G,PMPXRH1G,SP70
SH7VP999  RETURN
+
.******************************************************************************
.*                                 CH7VP000                                   *
.*                Check for any PMI HL7 visit trigger variable changes        *
.******************************************************************************
CH7VP000  MATCH     "1",PTCNH7VP
          GOTO      CH7VP999 IF NOT EQUAL   * Not using visit based triggers
.
          PACK      PMPXPRVI,PMPXPRVI,SP70
          MATCH     PMPXPRVI,SAVXPRVI
          IF        !@EQUAL
            CALL      WH7VP000
            GOTO      CH7VP999
          ENDIF
          PACK      PMPXRHC1,PMPXRHC1,SP70
          MATCH     PMPXRHC1,SAVXRHC1
          IF        !@EQUAL
            CALL      WH7VP000
            GOTO      CH7VP999
          ENDIF
          PACK      PMPXRH1G,PMPXRH1G,SP70
          MATCH     PMPXRH1G,SAVXRH1G
          IF        !@EQUAL
            CALL      WH7VP000
            GOTO      CH7VP999
          ENDIF
.
CH7VP999  RETURN
+
.******************************************************************************
.*                                 WH7VP000                                   *
.* If any HL7 PMI visit trigger variables have changed, write/update ibapolaf *
.******************************************************************************
.
WH7VP000  OPEN      IBAPOLA1,"ibapolaf"
.
          MOVE      ZERO,FORM10
          PACK      KEY10,Z70
          CALL      RSIBPOL1
          CALL      RPIBPOL1
          BRANCH    OVRCD,WH7VP100
.
          MOVE      IBPLUNIQ,FORM10
WH7VP100  ADD       ONE,FORM10
.
          MOVE      FORM10,IBPLUNIQ
          MOVE      "001",IBPLTYPE     * Visit based HL7 Triggers for a UR
          MOVE      PURNO,IBPLURNO
          MOVE      SP8,IBPLVISN
          MOVE      SP70,IBPLSKEY
          MOVE      SP70,IBPLSPAR
.
          MOVE      FORM10,KEY10
          CALL      RAIBPOL1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            CALL      WRIBPOL1
            TRAPCLR   IO
            BRANCH    OVRCD,WH7VP100
          ELSE
            GOTO      WH7VP100
          ENDIF
.
          CLOSE     IBAPOLA1
.
WH7VP999  RETURN
+
.------------------------------------------------------------
. ENDBRD00 - Update Boarder End Date and Time on deceased patient
.------------------------------------------------------------
ENDBRD00  OPEN     PATBRDA2,"patbrdaf"
          PACK     KEY18,PURNO,SP70
          CALL     RSPTBRD2
ENDBRD10  CALL     RKPTBRD2
          BRANCH   OVRCD,ENDBRD99
.
          MATCH    PURNO,PTBRURNO
          GOTO     ENDBRD99 IF NOT EQUAL
.
          CALL      IBACLOCK
          PACK      PTBREDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTBREDAT
          MOVE      CTIMEIS,PTBRETIM
          REP       " 0",PTBRETIM
.
          CALL     UPPTBRD2
.
          GOTO     ENDBRD10
.
ENDBRD99  CLOSE    PATBRDA2
          RETURN
.
.------------------------------------------------------------
. Update admission request status to processed
.------------------------------------------------------------
AREQ0000  MATCH     SP70,ADMREQNO           * Exit if no admission request
          GOTO      AREQ9999 IF EQUAL
.
          CLOSE     EMRSITA1                * Close some file to free up some
          CLOSE     EMRVISA1                * file handles. They will be re
          CLOSE     EMRDOCA1                * opened at the end of this routine
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSARQA1,"pmsarqaf"
          TRAPCLR   IO
          BRANCH    OVRCD,AREQ9000
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSAMNA1,"pmsamnaf"
          TRAPCLR   IO
          BRANCH    OVRCD,AREQ9000
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSARVA1,"pmsarvaf"
          TRAPCLR   IO
          BRANCH    OVRCD,AREQ9000
.
          PACK      KEY10,ADMREQNO,SP70
          CALL      RDPMARQ1
          BRANCH    OVRCD,AREQ9000
.
          MOVE      "4",PMARSTAT            // processed
          MOVE      AADMNO,PMARVISN         // visit number
          CALL      UPPMARQ1
.
          PACK      KEY15,PMARREQN,SP70
          CALL      RSPMAMN1
AREQ1000  CALL      RKPMAMN1
          BRANCH    OVRCD,AREQ3000
.
          MATCH     PMARREQN,PMAMREQN
          GOTO      AREQ3000 IF NOT EQUAL
.
          MOVE      PMARVISN,PMAMVISN       // visit number
.
          CALL      UPPMAMN1
          GOTO      AREQ1000
.
AREQ3000  PACK      KEY16,PMARREQN,SP70
          CALL      RSPMARV1
AREQ4000  CALL      RKPMARV1
          BRANCH    OVRCD,AREQ9000
.
          MATCH     PMARREQN,PMAVREQN
          GOTO      AREQ9000 IF NOT EQUAL
.
          MOVE      PMARVISN,PMAVVISN       // visit number
.
          CALL      UPPMARV1
          GOTO      AREQ4000
.
AREQ9000  CLOSE     PMSARQA1
          CLOSE     PMSAMNA1
          CLOSE     PMSARVA1
.
          OPEN      EMRSITA1,"emrsitaf"     // Re open closed files
          OPEN      EMRVISA1,"emrvisaf"
          OPEN      EMRDOCA1,"emrdocaf"
.
AREQ9999  RETURN
+
.------------------------------------------------------------
. UPDBRD00 - Update Boarder information
.------------------------------------------------------------
UPDBRD00  OPEN      PATBRDA3,"patbrdaf"
          PACK      KEY26,DISCADMN,SP70
          CALL      RSPTBRD3
UPDBRD10  CALL      RKPTBRD3
          BRANCH    OVRCD,UPDBRD99
.
          MATCH     DISCADMN,PTBRVISN
          GOTO      UPDBRD99 IF NOT EQUAL
.
          MATCH     SP70,PTBREDAT
          GOTO      UPDBRD10 IF NOT EQUAL
.
          PACK      SAVKEY26,PTBRVISN,PTBRBRDN,PTBRURNO,SP70
.
          CALL      GUBN0000
          BRANCH    EXIT,UPDBRD99
.
          MOVE      PTBRBRDN,SAVEBRDN
.
          MOVE      SAVKEY26,KEY26
          CALL      RDPTBRD3
.
          MOVE      SAVEBRDN,PTBRBRDN
          MOVE      AADMNO,PTBRVISN
.
          PACK      KEY26,PTBRVISN,PTBRBRDN,PTBRURNO,SP70
          CALL      RAPTBRD3
          IF        OVRCD=1
            CALL      WRPTBRD3
          ENDIF
.
          MOVE      SAVKEY26,KEY26
          CALL      RDPTBRD3
.
          CALL      IBACLOCK
          PACK      PTBREDAT,CCC,CYY,CMM,CDD   * Date
          REP       " 0",PTBREDAT
.
          CALL      UPPTBRD3
.
          GOTO      UPDBRD10
.
UPDBRD99  CLOSE     PATBRDA3
          RETURN
+
.-----------------------------------------------------------
.        Generate Unique Boarder Number
.-----------------------------------------------------------
GUBN0000  MOVE      "118",PRXCODE
          CALL      GETSLK00
          READ      CONTROLF,HUND18;*140,PTCNUNBN
.
GUBN0100  MOVE      PTCNUNBN,PTBRBRDN
          UNPACK    PTCNUNBN,ANS,KEY9
          MATCH     "a",ANS
          GOTO      GUBN1150 IF LESS
          MOVE      ZERO,F9
          MOVE      KEY9,F9
.
GUBN1100  COMPARE   "999999999",F9               * at the end of the group
          GOTO      GUBN1110 IF NOT EQUAL
.
          MATCH     "z",ANS
          GOTO      GUBN9000 IF EQUAL
.
          REP       REPUNIQ,ANS
          MOVE      ZERO,F9
.
GUBN1110  ADD       ONE,F9
          MOVE      F9,D9
          REP       " 0",D9
.
          PACK      KEY10,ANS,D9,SP70
          CALL      RDPTBRD1
          IF        OVRCD=ONE
            GOTO      GUBN9500
          ENDIF
.
          GOTO      GUBN1100
.
. no records
.
GUBN1150  MOVE      ONE,F9
          MOVE      "a",ANS
.
          MOVE      F9,D9
          REP       " 0",D9
.
          PACK      KEY10,ANS,D9,SP70
          GOTO      GUBN9500
.
GUBN9000  MOVE      ONE,EXIT                  * Passcode allocation full
          GOTO      GUBN9999
.
GUBN9500  MOVE      KEY10,PTCNUNBN
          WRITAB    CONTROLF,HUND18;*140,PTCNUNBN
.
          MATCH     "0000000000",PTBRBRDN
          GOTO      GUBN0100 IF EQUAL
.
GUBN9999  CALL      RELSLK00
          RETURN
.
.-----------------------------------------------------------
.        Get Patient Attributes for BMI
.-----------------------------------------------------------
PATATR00  MOVE      SP70,BMIINDIC
.
          COMPARE   ONE,NOATTRIB
          GOTO      PATATR99 IF EQUAL
.
          MATCH     SP70,URNUMBER
          GOTO      PATATR99 IF EQUAL
          GOTO      PATATR99 IF EOS
.
.         MATCH     SP70,ADMISSNO
.         GOTO      PATATR99 IF EQUAL
.         GOTO      PATATR99 IF EOS
.
          PACK      KEY35,URNUMBER,Z70
          CALL      RSPTATR1
PATATR10  CALL      RPPTATR1
          BRANCH    OVRCD,PATATR90
.
          MATCH     URNUMBER,PTARURNO
          GOTO      PATATR90 IF NOT EQUAL
.
.         MATCH     ADMISSNO,PTARVISN
.         GOTO      PATATR90 IF NOT EQUAL
.
          MATCH     "1",PTARDELR
          GOTO      PATATR10 IF EQUAL
.
          MATCH     "001",PTARTYPE
          GOTO      PATATR10 IF NOT EQUAL
.
          MOVE      "1",BMIINDIC
.
          GOTO      PATATR99
.
PATATR90  CALL      CLPATATR
PATATR99  RETURN
.
.-----------------------------------------------------------
.        Allocate UR to a Theatre Request
.-----------------------------------------------------------
THRQ0000  OPEN      BOKRQ1A1,"bokrq1af"
          OPEN      BOKRAUA1,"bokrauaf"
.
          PACK      KEY10,REQUESTN,SP70
          CALL      RDBKRQ11
          IF        OVRCD=1
            GOTO      THRQ9999
          ENDIF
.
          MOVE      URNUMBER,BKRQURNO
          MOVE      WBSEUID,BKRQUUSR
          CALL      IBACLOCK
          PACK      BKRQUDAT,CCC,CYY,CMM,CDD
          REP       " 0",BKRQUDAT
          MOVE      CTIMEIS,BKRQUTIM
.
          CALL      UPBKRQ11
.
          CALL      CLBOKRAU
          MOVE      SIX,BKRUAUTY
          CALL      MVBOKRAU
.
          PACK      KEY27,BKRUAURQ,BKRUADAT,BKRUATIM,BKRUAUTY,SP70
          CALL      RABKRAU1
          IF        OVRCD=1
            CALL      WRBKRAU1
          ENDIF
.
          CLEAR     REDIRECT
          APPEND    "oprweb01.pbl?reportno=22&template=008",REDIRECT
          APPEND    "&urnumber=",REDIRECT
          APPEND    URNUMBER,REDIRECT
          APPEND    "&requestn=",REDIRECT
          APPEND    REQUESTN,REDIRECT
          RESET     REDIRECT
.
THRQ9999  CLOSE     BOKRQ1A1
          CLOSE     BOKRAUA1
.
          RETURN
+
.------------------------------------------------------------------------
.         Update theatre bookings request audit file
.------------------------------------------------------------------------
MVBOKRAU  PACK      BKRUAURQ,BKRQREQN,SP70
.                   BKRUAUTY - populated before this function depending
.                              on record type
          CALL      IBACLOCK
          PACK      BKRUADAT,CCC,CYY,CMM,CDD
          REP       " 0",BKRUADAT
          MOVE      CTIMEIS,BKRUATIM
          REP       " 0",BKRUATIM
          PACK      BKRUAUSR,WBSEUID,SP70
          PACK      BKRUURNO,BKRQURNO,SP70
          PACK      BKRUVISN,BKRQVISN,SP70
          PACK      BKRUBKTY,BKRQBKTY,SP70
          PACK      BKRUREQN,BKRQREQN,SP70
          PACK      BKRUSTAT,BKRQSTAT,SP70
          PACK      BKRUHOSP,BKRQHOSP,SP70
          PACK      BKRUPRIO,BKRQPRIO,SP70
          PACK      BKRUSNAM,BKRQSNAM,SP70
          PACK      BKRUGNAM,BKRQGNAM,SP70
          PACK      BKRUBDAT,BKRQBDAT,SP70
          PACK      BKRUGEND,BKRQGEND,SP70
          PACK      BKRURDOC,BKRQRDOC,SP70
          PACK      BKRUUNIT,BKRQUNIT,SP70
          PACK      BKRUCSDT,BKRQCSDT,SP70
          PACK      BKRUCSTM,BKRQCSTM,SP70
          PACK      BKRUCTCT,BKRQCTCT,SP70,SP70
          PACK      BKRULOCN,BKRQLOCN,SP70
          PACK      BKRUADPT,BKRQADPT,SP70
          PACK      BKRUEPOW,BKRQEPOW,SP70
          PACK      BKRUSURG,BKRQSURG,SP70
          PACK      BKRUTHET,BKRQTHET,SP70
          PACK      BKRUANAE,BKRQANAE,SP70
          PACK      BKRUMBS1,BKRQMBS1,SP70
          PACK      BKRUMBS2,BKRQMBS2,SP70
          PACK      BKRUMBS3,BKRQMBS3,SP70
          PACK      BKRUMBD1,BKRQMBD1,SP70,SP70
          PACK      BKRUMBD2,BKRQMBD2,SP70,SP70
          PACK      BKRUMBD3,BKRQMBD3,SP70,SP70
          PACK      BKRUPROR,BKRQPROR,SP70
          PACK      BKRUDURA,BKRQDURA,SP70
          PACK      BKRUINFC,BKRQINFC,SP70
          PACK      BKRUEQU1,BKRQEQU1,SP70
          PACK      BKRUEQU2,BKRQEQU2,SP70
          PACK      BKRUEQU3,BKRQEQU3,SP70
          PACK      BKRUCDAT,BKRQCDAT,SP70
          PACK      BKRUCTIM,BKRQCTIM,SP70
          PACK      BKRUCUSR,BKRQCUSR,SP70
          PACK      BKRUUDAT,BKRQUDAT,SP70
          PACK      BKRUUTIM,BKRQUTIM,SP70
          PACK      BKRUUUSR,BKRQUUSR,SP70
          PACK      BKRUCNDT,BKRQCNDT,SP70
          PACK      BKRUCNTM,BKRQCNTM,SP70
          PACK      BKRUCNUS,BKRQCNUS,SP70
          PACK      BKRUCNCD,BKRQCNCD,SP70
          PACK      BKRUOPTY,BKRQOPTY,SP70
          PACK      BKRUTRCD,BKRQTRCD,SP70
          PACK      BKRUATCD,BKRQATCD,SP70
          PACK      BKRUATYP,BKRQATYP,SP70
          PACK      BKRUCTYP,BKRQCTYP,SP70
          PACK      BKRUELOS,BKRQELOS,SP70
          PACK      BKRUCTY6,BKRQCTY6,SP70
          PACK      BKRUCTY7,BKRQCTY7,SP70
          PACK      BKRUCTY8,BKRQCTY8,SP70
          PACK      BKRUCTY9,BKRQCTY9,SP70
          PACK      BKRUASRC,BKRQASRC,SP70
          PACK      BKRUBTYP,BKRQBTYP,SP70
          PACK      BKRUELON,BKRQELON,SP70
          PACK      BKRUCSNT,BKRQCSNT,SP70
          PACK      BKRUCCDT,BKRQCCDT,SP70
.
          RETURN
+
.-----------------------------------------------------------
.        Get Previous Visit PRFA
.-----------------------------------------------------------
PRPRFA00  UNPACK    DIM127,D1,KEY2,DIM127
          MOVE      ZERO,F2
          MOVE      KEY2,F2
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDRESP1
          BRANCH    OVRCD,PRPRFA99
.
          MATCH     SP70,PKNAME
          GOTO      PRPRFA50 IF NOT EQUAL
.
          MATCH     SP70,PKADD1
          GOTO      PRPRFA50 IF NOT EQUAL
.
          MATCH     SP70,PKADD2
          GOTO      PRPRFA50 IF NOT EQUAL
.
          MATCH     SP70,PKSUBR
          GOTO      PRPRFA50 IF NOT EQUAL
.
          MATCH     SP70,PKPOST
          GOTO      PRPRFA50 IF NOT EQUAL
.
          MATCH     SP70,PKADD4
          GOTO      PRPRFA50 IF NOT EQUAL
.
          GOTO      PRPRFA99
.
PRPRFA50  MATCH     SP70,PKRELP
          IF        !@EQUAL
            PACK      KEY10,PKRELP,SP70
            CALL      RDPMREL1
            IF        OVRCD=1
              MOVE      PKRELP,PMRLDESC
            ENDIF
          ENDIF
.
          BRANCH    F2,PRPRFA61,PRPRFA62,PRPRFA63:
                       PRPRFA64,PRPRFA65,PRPRFA66:
                       PRPRFA67,PRPRFA68
.
PRPRFA61  WRITE     HTMLFILE;PKADMN;
          GOTO      PRPRFA99
.
PRPRFA62  WRITE     HTMLFILE;PKADD1;
          GOTO      PRPRFA99
.
PRPRFA63  WRITE     HTMLFILE;PKADD2;
          GOTO      PRPRFA99
.
PRPRFA64  WRITE     HTMLFILE;PKSUBR;
          GOTO      PRPRFA99
.
PRPRFA65  WRITE     HTMLFILE;PKPOST;
          GOTO      PRPRFA99
.
PRPRFA66  WRITE     HTMLFILE;PKADD4;
          GOTO      PRPRFA99
.
PRPRFA67  WRITE     HTMLFILE;PMRLDESC;
          GOTO      PRPRFA99
.
PRPRFA68  WRITE     HTMLFILE;PKNAME;
          GOTO      PRPRFA99
.
PRPRFA99  RETURN
.
.-----------------------------------------------------------
.        Update PRFA from previous visit
.-----------------------------------------------------------
UPPRFA00  MATCH     SP70,PREVPRFA
          GOTO      UPPRFA99 IF EQUAL
          GOTO      UPPRFA99 IF EOS
.
          PACK      KEY8,PREVPRFA,SP70
          CALL      RDRESP1
          BRANCH    OVRCD,UPPRFA99
.
          MOVE      ADMISSNO,PKADMN
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDARESP1
          IF        OVRCD=1
            CALL      WRRESP1
          ELSE
            CALL      UPRESP1
          ENDIF
.
UPPRFA99  RETURN
.
.-------------------------------------------------------------
. Write OEC History Record to pmselfaf (OEC Free Format table)
.-------------------------------------------------------------
HOEC0000  OPEN      PMSELFA1,"pmselfaf"
.
          CALL      CLPMSELF
.
          PACK      SAVKEY11,PMOEVISN,PMOECNTR,SP70
.
HOEC1000  CALL      GELN0000           * Generate Eligibility Number
          BRANCH    GELNFLAG,HOEC9999
.
          MOVE      SAVKEY11,KEY11
          CALL      RDPMOEC1
.
          MOVE      PMOEURNO,PMEFURNO
          MOVE      ZERO,PMEFOECC
          MOVE      PTITL,PMEFTITL
          PACK      PMEFFNAM,PMPXFNAM,SP70
          PACK      PMEFSNAM,PTMASNAM,SP70
          MOVE      SP70,PMEFHFGN
          MOVE      SP70,PMEFHFSN
          MOVE      PSEX,PMEFGEND
          MOVE      PBDATE,PMEFBDAT
          MOVE      PTMIS001,PMEFEADT
          MOVE      SP70,PMEFISTY
          MATCH     PTVIS043,Z70
          IF        !@EQUAL
            MOVE      PTVIS043,PMEFISTY
          ENDIF
          MOVE      PTMIS030,PMEFPLOS
          MOVE      PTVIS076,PMEFDINT
          MOVE      PTELSPEA,PMEFPEAI
          MOVE      PTELEADM,PMEFEMAD
.
          MOVE      SP70,PMEFPRIC
          MATCH     PTVIS111,Z70
          IF        !@EQUAL
            MOVE      PTVIS111,PMEFPRIC
          ENDIF
.
          MOVE      SP70,PMEFPRIM
          MATCH     PTMIS026,Z70
          IF        !@EQUAL
            MOVE      PTMIS026,PMEFPRIM
          ENDIF
.
          MOVE      PTMIS027,PMEFCLTY
          MOVE      PTMIS013,PMEFHFND
          MOVE      PTMIS014,PMEFHFNT
          MOVE      PTMIS015,PMEFHFMN
          MOVE      PTMIS020,PMEFDIAG
.
          MOVE      SP70,PMEFSRV1
          PACK      KEY14,PMOEVISN,PMOECNTR,SP1,SP1,ONE,SP70
          CALL      RDPMOES1
          IF        OVRCD=0
            MOVE      PMOSITEM,PMEFSRV1
          ENDIF
.
          MOVE      SP70,PMEFSRV2
          PACK      KEY14,PMOEVISN,PMOECNTR,SP1,SP1,TWO,SP70
          CALL      RDPMOES1
          IF        OVRCD=0
            MOVE      PMOSITEM,PMEFSRV2
          ENDIF
.
          MOVE      SP70,PMEFSRV3
          PACK      KEY14,PMOEVISN,PMOECNTR,SP1,SP1,THREE,SP70
          CALL      RDPMOES1
          IF        OVRCD=0
            MOVE      PMOSITEM,PMEFSRV3
          ENDIF
.
          MOVE      SP70,PMEFSRV4
          PACK      KEY14,PMOEVISN,PMOECNTR,SP1,SP1,FOUR,SP70
          CALL      RDPMOES1
          IF        OVRCD=0
            MOVE      PMOSITEM,PMEFSRV4
          ENDIF
.
          MOVE      SP70,PMEFSRV5
          PACK      KEY14,PMOEVISN,PMOECNTR,SP1,SP1,FIVE,SP70
          CALL      RDPMOES1
          IF        OVRCD=0
            MOVE      PMOSITEM,PMEFSRV5
          ENDIF
.
          MOVE      WBSEUID,PMEFCUID
          CALL      IBACLOCK
          PACK      PMEFCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMEFCDAT
          CLOCK     TIME,CTIMEIS
          MOVE      CTIMEIS,PMEFCTIM
.
          CALL      CNCE0000                       * DVA conc card on file ?
          IF        EXIT=1
            PACK      PMEFDVAN,PREPAT,SP20         * No
          ELSE
            MOVE      DIM20,PMEFDVAN               * yes
          ENDIF
.
          MOVE      PMOEVISN,PMEFVISN
          MOVE      PMOECNTR,PMEFCNTR
          MOVE      ZERO,PMEFFLAG
          PACK      PMEFSPAR,SP70,SP70
.
          PACK      KEY8,PMEFELGN,SP70
          CALL      RAPMELF1
          IF        OVRCD=0
            GOTO      HOEC1000
          ENDIF
.
          CALL      WRPMELF1
.
          PACK      KEY11,PMOEVISN,PMOECNTR,SP70
          CALL      RDPMOEC1
          IF        OVRCD=0
            MOVE      PMEFELGN,PMOEELEG
            CALL      UPPMOEC1
          ENDIF
.
HOEC9999  CLOSE     PMSELFA1
.
          RETURN
.
.-----------------------------------------------------------
.        Generate Free Format OEC Eligibility Number
.-----------------------------------------------------------
GELN0000  MOVE      ZERO,GELNFLAG
.
          MOVE      "118",PRXCODE
          CALL      GETSLK00
          READ      CONTROLF,HUND18;*117,PTCNELGN
.
GELN0100  MOVE      PTCNELGN,PMEFELGN
          UNPACK    PTCNELGN,ANS,KEY7
          MATCH     "a",ANS
          GOTO      GELN1150 IF LESS
          MOVE      ZERO,F7
          MOVE      KEY7,F7
.
GELN1100  COMPARE   "9999999",F7               * at the end of the group
          GOTO      GELN1110 IF NOT EQUAL
.
          MATCH     "z",ANS
          GOTO      GELN9000 IF EQUAL
.
          REP       REPUNIQ,ANS
          MOVE      ZERO,F7
.
GELN1110  ADD       ONE,F7
          MOVE      F7,D7
          REP       " 0",D7
.
          PACK      KEY8,ANS,D7,SP70
          CALL      RAPMELF1
          IF        OVRCD=ONE
            PACK      KEY11,ANS,D7,SP1,SP1,ONE,SP70
            CALL      RAPMOEC1
            IF        OVRCD=ONE
              PACK      KEY14,ANS,D7,SP1,SP1,ONE,SP70
              CALL      RSPMOES1
              CALL      RKPMOES1
              BRANCH    OVRCD,GELN9500
.
              PACK      KEY8,ANS,D7,SP70
              MATCH     KEY8,PMOSVISN
              GOTO      GELN9500 IF NOT EQUAL
            ENDIF
          ENDIF
.
          GOTO      GELN1100
.
. no records
.
GELN1150  MOVE      ONE,F7
          MOVE      "a",ANS
.
          MOVE      F7,D7
          REP       " 0",D7
.
          PACK      KEY8,ANS,D7,SP70
          GOTO      GELN9500
.
GELN9000  MOVE      ONE,GELNFLAG                  * Passcode allocation full
          GOTO      GELN9999
.
GELN9500  MOVE      KEY8,PTCNELGN
          WRITAB    CONTROLF,HUND18;*117,PTCNELGN
.
          MATCH     "00000000",PMEFELGN
          GOTO      GELN0100 IF EQUAL
.
GELN9999  CALL      RELSLK00
          RETURN
+
.*****************************************************************************
.*                              CNCE0000           Called by: WPAT0000       *
.*     See if the patient has concession card of DVA type on file            *
.* Requires: PURNO - U/R number                                              *
.* Returns:  EXIT  0 = valid concession card found                           *
.*                 1 = no valid concession card found                        *
.*           DIM20 - Concession Card Number                                  *
.*****************************************************************************
.
CNCE0000  CLOSE     PMSELFA1
          OPEN      PMSCCDA1,"pmsccdaf"
.
          PACK      KEY19,PURNO,TILDA40
          CALL      RSPMCCD1                     * position on U/R
CNCE0500  CALL      RPPMCCD1                     * read previous record
          BRANCH    OVRCD,CNCE9100               * eof - nothing found
.
          MATCH     PURNO,PMCDURNO               * same U/R still ?
          GOTO      CNCE9100 IF NOT EQUAL        * no - nothing found
.
.         Check if the card type is DVA (Cat ct, Indicator 1)
.
          PACK      KEY5,CATCT,PMCDCTYP
          CALL      RDCODE1                      * code on file ?
          BRANCH    OVRCD,CNCE0500               * no - ignore record
.
          MATCH     SP1,TCINDC1                  * blank indicator 1 ?
          GOTO      CNCE0500 IF EQUAL            * yes - ignore record
.
          TYPE      TCINDC1                      * numeric indicator 1 ?
          GOTO      CNCE0500 IF NOT EQUAL        * no - ignore record
.
          MATCH     "3",TCINDC1                  * DVA card type ?
          GOTO      CNCE0500 IF NOT EQUAL        * no - ignore record
.
.         A DVA concession card has been found, so check
.         if there is an expiry date
.
          MATCH     SP8,PMCDEXDT                 * expiry date blank ?
          GOTO      CNCE1000 IF EQUAL            * yes - assume valid
.
.         There is an expiry date for the card, so check that the
.         card is current
.
          CALL      IBACLOCK
          PACK      DIM8,CCC,CYY,CMM,CDD
          REP       " 0",DIM8
.
          MATCH     DIM8,PMCDEXDT                * card valid for date ?
          GOTO      CNCE9100 IF LESS             * no - nothing found
.
.         Concession card is current
.
CNCE1000  MATCH     SP20,PMCDCNUM                * card number blank ?
          GOTO      CNCE9100 IF EQUAL            * yes - nothing found
.
          MOVE      PMCDCNUM,DIM20               * load concession card number
.
          MOVE      ZERO,CNCEFLAG
          GOTO      CNCE9999
.
CNCE9100  MOVE      ONE,CNCEFLAG
.
CNCE9999  CLOSE     PMSCCDA1
          OPEN      PMSELFA1,"pmselfaf"
          RETURN
+
.-----------------------------------------------------------
.    Update Patient Attributes from mhaccq admission screens
.-----------------------------------------------------------
ABMI0000  MATCH     "1",BMIINDIC
          GOTO      ABMI9999 IF NOT EQUAL
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDPMPX21
          IF        OVRCD=0
.
            MATCH     PMPXI020,Z70
            IF        !@EQUAL
              MOVE      PMPXI020,PMPXPHEI
            ENDIF
.
            MATCH     PMPXI021,Z70
            IF        !@EQUAL
              MOVE      PMPXI021,PMPXPWEI
            ENDIF
.
            MATCH     PMPXI022,Z70
            IF        !@EQUAL
              MOVE      PMPXI022,PMPXDREC
            ENDIF
.
            CALL      UPPMPX21
.
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMVX11
          IF        OVRCD=0
.
            MOVE      ZERO,FORM4P1
            MOVE      SP70,DIM6
            MOVE      PMPXI020,DIM6
            RJUSTIFY  DIM6
            MOVE      DIM6,FORM4P1
            MOVE      FORM4P1,PMVXPHGT
.
            MOVE      ZERO,FORM4P1
            MOVE      SP70,DIM6
            MOVE      PMPXI021,DIM6
            RJUSTIFY  DIM6
            MOVE      DIM6,FORM4P1
            MULT      "100",FORM4P1
            MOVE      FORM4P1,PMVXPWGT
.
            CALL      IBACLOCK
            PACK      PMVXDHWR,CCC,CYY,CMM,CDD
            REP       " 0",PMVXDHWR
            CALL      UPPMVX11
          ENDIF
.
          IF        ADMITBOX=1
.
            MOVE      URNUMBER,PTATR001
            MOVE      ADMISSNO,PTATR002
            MOVE      PMPXI022,PTATR003
            CALL      IBACLOCK
            MOVE      CTIMEIS,PTATR004
            MOVE      "001",PTATR005
            MOVE      PMPXI020,PTATR006
            MOVE      PMPXI021,PTATR007
            LJUSTIFY  PTATR006
            LJUSTIFY  PTATR007
.
            CALL      ADDATR00
          ENDIF
.
ABMI9999  RETURN
+
.-----------------------------------------------------------
.        Add Patient Attributes
.-----------------------------------------------------------
ADDATR00  COMPARE   ONE,NOATTRIB
          GOTO      ADDATR99 IF EQUAL
.
          MATCH     SP70,PTATR001
          GOTO      ADDATR99 IF EQUAL
          GOTO      ADDATR99 IF EOS
.
          PACK      KEY35,PTATR001,PTATR003,PTATR004,ZERO,ZERO,ONE,WMBOOK,SP70
          CALL      RDPTATR1
          COMPARE   ZERO,OVRCD
          GOTO      ADDATR99 IF EQUAL
.
          CALL      CLPATATR
          CALL      MVPATATR
.
          CALL      CLCBMI00
          PACK      PTARVAL3,BODMASIN,SP70
.
          PACK      PTARTYPE,ZERO,ZERO,ONE,SP70
          MOVE      USERID,PTARCUSR
          MOVE      PTATR003,PTARCDTE
          MOVE      PTATR004,PTARCTME
.
          PACK      KEY35,PTATR001,PTATR003,PTATR004,ZERO,ZERO,ONE,WMBOOK,SP70
          CALL      WRPTATR1
.
ADDATR99  RETURN
+
.-----------------------------------------------------------
.        Add Mental Health Attribute
.-----------------------------------------------------------
AMHATR00  MATCH     SP70,PTCNNSSI        * no edward source system
          GOTO      AMHATR99 IF EQUAL
.
          MATCH     ZERO20,PTCNNSSI        * no edward source system
          GOTO      AMHATR99 IF EQUAL
.
. * no legal status to store ?
          MATCH     SP70,PMVXMHLS
          GOTO      AMHATR99 IF EQUAL
.
. * check for a mental health unit - cat AC indicator 1=L
          MATCH     SP70,ACLSSFT          * no unit?
          GOTO      AMHATR99 IF EQUAL
.
          PACK      KEY5,ANSD,ANST,ACLSSFT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,AMHATR99
.
          MATCH     ANSL,TCINDC1
          GOTO      AMHATR99 IF NOT EQUAL
.
          CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          CLOCK     TIME,CTIMEIS              * Set created timestamp and userid
.
          PACK      PTARURNO,URNUMBER
          PACK      PTARVISN,AADMNO
          PACK      PTARDATE,ADATE,SP70
          PACK      PTARTIME,ATIME,SP70
          PACK      PTARTYPE,ZERO,ONE,NINE,SP70    * MH 
.
          PACK      KEY35,PTARURNO,PTARDATE,PTARTIME,PTARTYPE,PTARVISN,SP70
          CALL      RDPTATR1  
          BRANCH    OVRCD,AMHATR80
.
          MATCH     PTARCOD1,PMVXMHLS
          GOTO      AMHATR99 IF EQUAL
.
. Update if Legal status code changes
.
          PACK      PTARCOD1,PMVXMHLS,SP70
          MOVE      USERID,PTARUUSR
          PACK      PTARUDTE,CURRDATE,SP70
          PACK      PTARUTME,CTIMEIS,SP70
          CALL      UPPTATR1
          GOTO      AMHATR99
.
. Write new row 
.
AMHATR80  PACK      PTARCOD1,PMVXMHLS,SP70
          MOVE      USERID,PTARCUSR
          PACK      PTARCDTE,CURRDATE,SP70
          PACK      PTARCTME,CTIMEIS,SP70
          MOVE      USERID,PTARUUSR
          PACK      PTARUDTE,CURRDATE,SP70
          PACK      PTARUTME,CTIMEIS,SP70
          CALL      WRPTATR1
.
AMHATR99  RETURN
+
.-----------------------------------------------------------
.        Get Patient Attributes with Admission Number
.-----------------------------------------------------------
PTATRV00  COMPARE   ONE,NOATTRIB
          GOTO      PTATRV99 IF EQUAL
.
          MATCH     SP70,URNUMBER
          GOTO      PTATRV99 IF EQUAL
          GOTO      PTATRV99 IF EOS
.
          MATCH     SP70,ADMISSNO
          GOTO      PTATRV99 IF EQUAL
          GOTO      PTATRV99 IF EOS
.
          PACK      KEY35,URNUMBER,Z70
          CALL      RSPTATR1
PTATRV10  CALL      RPPTATR1
          BRANCH    OVRCD,PTATRV90
.
          MATCH     URNUMBER,PTARURNO
          GOTO      PTATRV90 IF NOT EQUAL
.
          MATCH     ADMISSNO,PTARVISN
          GOTO      PTATRV10 IF NOT EQUAL
.
          MATCH     "001",PTARTYPE
          GOTO      PTATRV10 IF NOT EQUAL
.
          MATCH     "1",PTARDELR
          GOTO      PTATRV10 IF EQUAL
.
          BRANCH    FORM2,PTATRV20,PTATRV30,PTATRV40,PTATRV50,PTATRV60:
                          PTATRV70
          GOTO      PTATRV99
.
PTATRV20  MATCH     SP70,PTARDATE
          GOTO      PTATRV99 IF EQUAL
          UNPACK    PTARDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      PTATRV99
.
PTATRV30  WRITE     HTMLFILE;PTARTIME;
          GOTO      PTATRV99
.
PTATRV40  WRITE     HTMLFILE;PTARVAL1;
          GOTO      PTATRV99
.
PTATRV50  WRITE     HTMLFILE;PTARVAL2;
          GOTO      PTATRV99
PTATRV60  MATCH     SP70,PTARVAL3
          IF        @EQUAL
            CALL      CLCBMI00
          ELSE
            PACK      BODMASIN,PTARVAL3,SP70
          ENDIF
.
          CALL      RNGBMI00
          WRITE     HTMLFILE;BODMASRN;
          GOTO      PTATRV99
.
PTATRV70  MATCH     SP70,PTARUDTE
          GOTO      PTATRV71 IF EQUAL
.
          UNPACK    PTARUDTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP1,PTARUTME;
          GOTO      PTATRV99
.
PTATRV71  MATCH     SP70,PTARCDTE
          GOTO      PTATRV99 IF EQUAL
.
          UNPACK    PTARCDTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP1,PTARCTME;
          GOTO      PTATRV99
.
PTATRV90  CALL      CLPATATR
PTATRV99  RETURN
+
.-----------------------------------------------------------
.    Update Patient Attributes from mhaccq admission screens
.-----------------------------------------------------------
UBMI0000  MATCH     "1",BMIINDIC
          GOTO      UBMI9999 IF NOT EQUAL
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDPMPX21
          IF        OVRCD=0
.
            MATCH     PMPXI020,Z70
            IF        !@EQUAL
              MOVE      PMPXI020,PMPXPHEI
            ENDIF
.
            MATCH     PMPXI021,Z70
            IF        !@EQUAL
              MOVE      PMPXI021,PMPXPWEI
            ENDIF
.
            MATCH     PMPXI022,Z70
            IF        !@EQUAL
              MOVE      PMPXI022,PMPXDREC
            ENDIF
.
            CALL      UPPMPX21
.
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMVX11
          IF        OVRCD=0
.
            MOVE      ZERO,FORM4P1
            MOVE      SP70,DIM6
            MOVE      PMPXI020,DIM6
            RJUSTIFY  DIM6
            MOVE      DIM6,FORM4P1
            MOVE      FORM4P1,PMVXPHGT
.
            MOVE      ZERO,FORM4P1
            MOVE      SP70,DIM6
            MOVE      PMPXI021,DIM6
            RJUSTIFY  DIM6
            MOVE      DIM6,FORM4P1
            MULT      "100",FORM4P1
            MOVE      FORM4P1,PMVXPWGT
.
            CALL      IBACLOCK
            PACK      PMVXDHWR,CCC,CYY,CMM,CDD
            REP       " 0",PMVXDHWR
            CALL      UPPMVX11
          ENDIF
.
          MOVE      PMPXI020,PTATR006
          MOVE      PMPXI021,PTATR007
          LJUSTIFY  PTATR006
          LJUSTIFY  PTATR007
.
          CALL      UPDATR00
.
UBMI9999  RETURN
+
.-----------------------------------------------------------
.        Update Patient Attributes
.-----------------------------------------------------------
UPDATR00  COMPARE   ONE,NOATTRIB
          GOTO      UPDATR99 IF EQUAL
.
          MATCH     SP70,PTATR001
          GOTO      UPDATR99 IF EQUAL
          GOTO      UPDATR99 IF EOS
.
          PACK      KEY35,PTATR001,PTATR003,PTATR004,ZERO,ZERO,ONE,PTATR002,SP70
          CALL      RDPTATR1
          BRANCH    OVRCD,UPDATR99
.
          MOVE      PTATR006,PTARVAL1
          MOVE      PTATR007,PTARVAL2
.
          CALL      CLCBMI00
          PACK      PTARVAL3,BODMASIN,SP70
.
          CALL      IBACLOCK
          PACK      PTARUDTE,CCC,CYY,CMM,CDD
          REP       " 0",PTARUDTE
          CLOCK     TIME,PTARUTME
          MOVE      USERID,PTARUUSR
.
          CALL      UPPTATR1
.
UPDATR99  RETURN
+
.-----------------------------------------------------------
.        Get Quick Registration Indicator
.-----------------------------------------------------------
GETQKR00  CLOSE     PMSELFA1
          OPEN      PATVISA4,"patvisaf"
          MOVE      SP70,QCKREGHD
.
          PACK      SAVKEY8,ADMISSNO,SP70
.
          PACK      KEY26,URNUMBER,SP70
          CALL      RSPTVIS4
GETQKR10  CALL      RKPTVIS4
          BRANCH    OVRCD,GETQKR90
.
          MATCH     PVIURNO,URNUMBER
          GOTO      GETQKR90 IF NOT EQUAL
.
          MATCH     " 3",PTVITYPE
          GOTO      GETQKR20 IF EQUAL
.
          MATCH     " 2",PTVITYPE
          GOTO      GETQKR30 IF EQUAL
.
          MATCH     " 1",PTVITYPE
          GOTO      GETQKR40 IF EQUAL
.
          MATCH     "10",PTVITYPE
          GOTO      GETQKR50 IF EQUAL
.
          GOTO      GETQKR10
.
. --- Inpatient ---
.
GETQKR20  PACK      SAVKEY8A,AADMNO,SP70
.
          PACK      KEY8,PVIBILL,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,GETQKR25
.
          COMPARE   TWO,ASTAT
          GOTO      GETQKR24 IF EQUAL
.
          COMPARE   THREE,ASTAT
          GOTO      GETQKR24 IF EQUAL
.
          COMPARE   FOUR,ASTAT
          GOTO      GETQKR24 IF EQUAL
.
          GOTO      GETQKR25
.
GETQKR24  MOVE      SAVKEY8A,KEY8
          CALL      RDMISS1
          IF        OVRCD=1
            CALL       CLPATMIS
          ENDIF
          GOTO      GETQKR99
.
GETQKR25  MOVE      SAVKEY8A,KEY8
          CALL      RDMISS1
          IF        OVRCD=1
            CALL       CLPATMIS
          ENDIF
          GOTO      GETQKR10
.
. --- Outpatient ---
.
GETQKR30  PACK      KEY36,PVIBILL,SP70
          CALL      RDSBOKA6
GETQKR35  CALL      RDKBOKA6
          BRANCH    OVRCD,GETQKR10
.
          MATCH     PVIBILL,OBAOUTNO
          GOTO      GETQKR10 IF NOT EQUAL
.
          COMPARE   FOUR,OBASTAT
          GOTO      GETQKR99 IF EQUAL
.
          GOTO      GETQKR35
.
. --- Emergency ---
.
GETQKR40  PACK      SAVKEY8A,EMVIADMN,SP70
.
          PACK      KEY8,PVIBILL,SP70
          CALL      RDEMVIS1
          BRANCH    OVRCD,GETQKR45
.
          COMPARE   ONE,EMVISTAT
          GOTO      GETQKR44 IF EQUAL
.
          COMPARE   TWO,EMVISTAT
          GOTO      GETQKR44 IF EQUAL
.
          COMPARE   THREE,EMVISTAT
          GOTO      GETQKR44 IF EQUAL
.
          GOTO      GETQKR45
.
GETQKR44  MOVE      SAVKEY8A,KEY8
          CALL      RDEMVIS1
          IF         OVRCD = 1
            CALL      CLEMRVIS
          ENDIF
          GOTO      GETQKR99
.
GETQKR45  MOVE      SAVKEY8A,KEY8
          CALL      RDEMVIS1
          IF         OVRCD = 1
            CALL      CLEMRVIS
          ENDIF
          GOTO      GETQKR10
.
. --- Referrals ---
.
GETQKR50  PACK      SAVKEY8A,ALREVISN,SP70
.
          PACK      KEY8,PVIBILL,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,GETQKR55
.
          MATCH     "1",ALRESTAT
          GOTO      GETQKR54 IF EQUAL
.
          MATCH     "2",ALRESTAT
          GOTO      GETQKR54 IF EQUAL
.
          GOTO      GETQKR55
.
GETQKR54  MOVE      SAVKEY8A,KEY8
          CALL      RDALREF1
          IF         OVRCD = 1
            CALL      CLALLREF
          ENDIF
          GOTO      GETQKR99
.
GETQKR55  MOVE      SAVKEY8A,KEY8
          CALL      RDALREF1
          IF         OVRCD = 1
            CALL      CLALLREF
          ENDIF
          GOTO      GETQKR10
.
GETQKR90  MOVE      ONE,QCKREGHD
.
GETQKR99  CLOSE     PATVISA4
          OPEN      PMSELFA1,"pmselfaf"
.
          MOVE      SAVKEY8,KEY8
          CALL      RDVISA1
          IF        OVRCD=1
            CALL      CLPV0000
          ENDIF
.
          RETURN
+
.-----------------------------------------------------------
. Write admission nutrition record if a pre admission
. nutrition record exists
.-----------------------------------------------------------
WNUT0000  OPEN      PMSNUTA1,"pmsnutaf"       * Open nutrition file
.
          CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          CLOCK     TIME,CTIMEIS              * Set created timestamp and userid
.
          PACK      KEY16,AADMNO,OLDADATE,SP70
          CALL      RDPMNUT1                  * check existing nutrition record
          COMPARE   ZERO,OVRCD
          GOTO      WNUT1000 IF EQUAL
.
          PACK      KEY16,AADMNO,SP70
          CALL      RDPMNUT1                  * Exit if there is no pre adm
          BRANCH    OVRCD,WNUT9000            * nutrition record
.
.         CALL      CLPMSNUT                  * clear all variable
WNUT1000  PACK      PMNUUPDD,CURRDATE,CTIMEIS
          PACK      PMNUUPDU,WBSEUID,SP70
          MOVE      AADMNO,PMNUADMN           * Admission no
          MOVE      ADATE,PMNUDATE            * Use adm date as nutrition date
.
          MATCH     SP70,ADIET
          IF        !@EQUAL
            MOVE      ADIET,PMNUDIET            * Diet Code
          ENDIF
.
          PACK      PMNUCRTU,WBSEUID,SP70
          PACK      PMNUCRTD,CURRDATE,CTIMEIS
.
          PACK      KEY16,PMNUADMN,PMNUDATE,SP70
          CALL      RAPMNUT1
          IF        OVRCD=1
            CALL      WRPMNUT1                * Write adm nutrition record
          ENDIF
.
WNUT9000  CLOSE     PMSNUTA1                  * Close nutrition file
          CALL      UPCAT000                  * update catcomaf (extra diet)
.
WNUT9999  RETURN
+
.-----------------------------------------------------------
. Update admission nutrition record in pmsnutaf
.-----------------------------------------------------------
UNUT0000  OPEN      PMSNUTA1,"pmsnutaf"       * Open nutrition file
.
          CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          CLOCK     TIME,CTIMEIS              * Set created timestamp and userid
.
          IF        ASTAT = 1
            PACK      KEY16,AADMNO,ADATE,SP70
            CALL      RDPMNUT1                * check if new date already exists
            IF        OVRCD = 1
              PACK      KEY16,AADMNO,OLDADATE,SP70
              CALL      RDPMNUT1              * read existing nutrition record
              BRANCH    OVRCD,UNUT0500
.
              MOVE      ADATE,PMNUDATE          * use new date
              PACK      PMNUUPDU,WBSEUID,SP70
              PACK      PMNUUPDD,CURRDATE,CTIMEIS
              CALL      UPPMNUT1
              GOTO      UNUT9000
            ENDIF
          ENDIF
.
UNUT0500  PACK      KEY16,AADMNO,SP70
          CALL      RDPMNUT1                  * Exit if there is no pre adm
          BRANCH    OVRCD,UNUT9500            * nutrition record
.
          PACK      KEY16,AADMNO,CURRDATE,SP70
          CALL      RDPMNUT1                  * Exit if there is no adm
          BRANCH    OVRCD,UNUT2000
.
UNUT1000  MOVE      ADIET,PMNUDIET            * Diet Code
          PACK      PMNUUPDU,WBSEUID,SP70
          PACK      PMNUUPDD,CURRDATE,CTIMEIS
          CALL      UPPMNUT1
          GOTO      UNUT9000
.
.         Create a new record with current date
.
UNUT2000  CALL      CLPMSNUT                  * clear all variable
.
          MOVE      AADMNO,PMNUADMN           * Admission no
          MOVE      ADIET,PMNUDIET            * Diet Code
          MOVE      CURRDATE,PMNUDATE         * Use current date
.
          PACK      PMNUCRTU,WBSEUID,SP70
          PACK      PMNUCRTD,CURRDATE,CTIMEIS
          CALL      WRPMNUT1                * Write adm nutrition record
.
UNUT9000  CALL      UPCAT000                  * update catcomaf (extra diet)
UNUT9500  CLOSE     PMSNUTA1                  * Close nutrition file
.
UNUT9999  RETURN
+
.------------------------------------------------------------
. Update Extra Diet Details with new date (catcomaf)
.------------------------------------------------------------
UPCAT000  MATCH     "1",PTCNUTOM
          GOTO      UPCAT999 IF NOT EQUAL
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      CATCOMA1,"catcomaf"
          TRAPCLR   IO
          BRANCH    OVRCD,UPCAT999
.
          MOVE      ONE,F1
          WHILE     F1 <= 5
            PACK      KEY17,PMNUADMN,OLDADATE,F1
            CALL      RDCTCOM1
            IF        OVRCD = 0
              PACK      KEY17,PMNUADMN,PMNUDATE,F1
              CALL      RACTCOM1                      * Does new date exist
              IF        OVRCD=1
                PACK      KEY17,PMNUADMN,OLDADATE,F1
                CALL      RDCTCOM1                    * Re read old date
                IF        OVRCD = 0
                  MOVE      PMNUDATE,CTCODATE
                  CALL      UPCTCOM1                  * Update with new date
                ENDIF
              ENDIF
            ENDIF
            ADD         TWO,F1
          DO
.
UPCAT900  CLOSE     CATCOMA1
UPCAT999  RETURN
+
.-----------------------------------------------------------
. Write nutrition record if:
. "Display Ward Diet/Diet Comment on pre-admission/admission templates"
. parameter is turned on
.-----------------------------------------------------------
WDIET000  MATCH     "1",PTCNDWDC
          GOTO      WDIET999 IF NOT EQUAL     * save ward diet info?
.
          COMPARE   ONE,STATDISC              * skip if statistical discharge
          GOTO      WDIET999 IF EQUAL
.
          OPEN      PMSNUTA1,"pmsnutaf"       * Open nutrition file
.
          CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          CLOCK     TIME,CTIMEIS              * Set created timestamp and userid
.
          PACK      KEY16,AADMNO,ADATE,SP70
          CALL      RDPMNUT1                  * check existing nutrition record
          BRANCH    OVRCD,WDIET100
.
          PACK      PMNUUPDD,CURRDATE,CTIMEIS
          PACK      PMNUUPDU,WBSEUID,SP70
.
          GOTO      WDIET500
.
WDIET100  CALL      CLPMSNUT                  * clear all variables
          MOVE      AADMNO,PMNUADMN           * Admission no
          MOVE      ADATE,PMNUDATE            * Use adm date as nutrition date
.
          PACK      PMNUCRTD,CURRDATE,CTIMEIS
          PACK      PMNUCRTU,WBSEUID,SP70
.
WDIET500  MATCH     SP70,ADIET
          IF        !@EQUAL
            MOVE      ADIET,PMNUDIET          * Diet Code
          ENDIF
.
          MATCH     Z70,DIETDTYP
          IF        !@EQUAL
            MOVE      DIETDTYP,PMNUDTYP         * Ward Diet
          ENDIF
          MATCH     Z70,DIETCOMM
          IF        !@EQUAL
            MOVE      DIETCOMM,PMNUCOM1         * Ward Comment
          ENDIF
.
          PACK      KEY16,PMNUADMN,PMNUDATE,SP70
          CALL      RAPMNUT1
          IF        OVRCD=1
            CALL      WRPMNUT1                * Write  nutrition record
          ELSE
            CALL      UPPMNUT1                * Update nutrition record
          ENDIF
.
WDIET900  CLOSE     PMSNUTA1                  * Close nutrition file
.
WDIET999  RETURN
+
.******************************************************************************
. Write admission diagnosis/Reason for admission comment lines 1, 2 and 3
.******************************************************************************
ADCM0000  MATCH     Z70,REASADM1
          GOTO      ADCM2000 IF EQUAL
.
          MATCH     SP70,REASADM1
          IF        @EQUAL
            PACK      KEY14,AADMNO,ZERO,TWO,ZERO,SP2,ONE,SP70
            CALL      DEVSCMT1
          ENDIF
.
          MOVE      AADMNO,VSCTVIST
          MOVE      "020",VSCTTYPE
          MOVE      "  1",VSCTLINE
          MOVE      REASADM1,VSCTDATA
          CALL      IBACLOCK
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          PACK      VSCTUKEY,KEY8,CTIMEIS,WBSEUID,SP70
          MOVE      SP70,VSCTSPAR
.
          PACK      KEY14,VSCTVIST,VSCTTYPE,VSCTLINE,SP70
          CALL      RAVSCMT1
          IF        OVRCD=1
            CALL      WRVSCMT1
          ELSE
            CALL      UPVSCMT1
          ENDIF
.
ADCM2000  MATCH     Z70,REASADM2
          GOTO      ADCM3000 IF EQUAL
.
          MATCH     SP70,REASADM2
          IF        @EQUAL
            PACK      KEY14,AADMNO,ZERO,TWO,ZERO,SP2,TWO,SP70
            CALL      DEVSCMT1
          ENDIF
.
          MOVE      AADMNO,VSCTVIST
          MOVE      "020",VSCTTYPE
          MOVE      "  2",VSCTLINE
          MOVE      REASADM2,VSCTDATA
          CALL      IBACLOCK
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          PACK      VSCTUKEY,KEY8,CTIMEIS,WBSEUID,SP70
          MOVE      SP70,VSCTSPAR
.
          PACK      KEY14,VSCTVIST,VSCTTYPE,VSCTLINE,SP70
          CALL      RAVSCMT1
          IF        OVRCD=1
            CALL      WRVSCMT1
          ELSE
            CALL      UPVSCMT1
          ENDIF
.
ADCM3000  MATCH     Z70,REASADM3
          GOTO      ADCM9999 IF EQUAL
.
          MATCH     SP70,REASADM3
          IF        @EQUAL
            PACK      KEY14,AADMNO,ZERO,TWO,ZERO,SP2,THREE,SP70
            CALL      DEVSCMT1
          ENDIF
.
          MOVE      AADMNO,VSCTVIST
          MOVE      "020",VSCTTYPE
          MOVE      "  3",VSCTLINE
          MOVE      REASADM3,VSCTDATA
          CALL      IBACLOCK
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          PACK      VSCTUKEY,KEY8,CTIMEIS,WBSEUID,SP70
          MOVE      SP70,VSCTSPAR
.
          PACK      KEY14,VSCTVIST,VSCTTYPE,VSCTLINE,SP70
          CALL      RAVSCMT1
          IF        OVRCD=1
            CALL      WRVSCMT1
          ELSE
            CALL      UPVSCMT1
          ENDIF
.
ADCM9999  RETURN
.
.------------------------------------------------------------
.   QLD MH Details 
.------------------------------------------------------------
PTQMH000  COMPARE   FOUR,PTCNHDPS           * QLD
          GOTO      PTQMH999 IF NOT EQUAL
.
          PACK      KEY6,ADOCTA,SP6
          CALL      RDDOCT1                 * Read the doctors file
          BRANCH    OVRCD,PTQMH999
.
          MATCH     SP3,DRTYPE
          GOTO      PTQMH999 IF EQUAL
.
          PACK      KEY5,ANSD,ANST,DRTYPE,SP70
          CALL      RDCODE1             * Read the codes file
          BRANCH    OVRCD,PTQMH999
.
          MATCH     PYAA,THCSCOD
          GOTO      PTQMH500 IF LESS        * < PYAA
.
          MATCH     THCSCOD,PYZZ
          GOTO      PTQMH500 IF LESS        * PYZZ <
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPTQMH1          * Read the QLD rehab details file
          IF        OVRCD=1
            CALL      MVPTQM00        * Update the qld MH details fil
            CALL      WRPTQMH1
          ELSE
            CALL      MVPTQM00        * Update the qld MH details fil
            CALL      UPPTQMH1
          ENDIF
.
          GOTO      PTQMH999
.
PTQMH500  PACK      KEY8,ADMISSNO,SP70
          CALL      DEPTQMH1
.
PTQMH999  RETURN
+
.******************************************************************************
.*                                  REMTR000                                  *
.*   Remove trigger records when aelig is getting set to resubmit             *
.******************************************************************************
REMTR000  COMPARE   ONE,PTCNHDPS
          GOTO      REMTR999 IF NOT EQUAL   * NZ
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,REMTR999
.
          OPEN      PMSWTRA1,"pmswtraf"
          PACK      KEY19,PMVXMHOS,ADMISSNO,SP70
          CALL      RDPMWTR1
          BRANCH    OVRCD,REMTR999
.
          CALL      DEPMWTR1
.
REMTR999  CLOSE     PMSWTRA1
          RETURN
+
.******************************************************************************
.*                                  CPEXTC00                                  *
.*   Copy pmsextaf record to new Recurring Care Type visit                    *
.******************************************************************************
CPEXTC00  MATCH     "1",EXTCOMIN
          GOTO      CPEXTC99 IF NOT EQUAL
.
          MATCH     SP70,PRVADMIS
          GOTO      CPEXTC99 IF EQUAL
          GOTO      CPEXTC99 IF EOS
.
          PACK      KEY11,PRVADMIS,ACLAIM,SP70
          CALL      RDPMEXT1
          BRANCH    OVRCD,CPEXTC99
.
          MOVE      ADMISSNO,PMEXVISN
.
          PACK      KEY11,ADMISSNO,ACLAIM,SP70
          CALL      RAPMEXT1
          IF        OVRCD=1
            CALL      WRPMEXT1
          ENDIF
.
CPEXTC99  RETURN
+
.******************************************************************************
.*                                  UPPRCS00                                  *
.*            Call UpdateProcessed() for Online Preadmission                  *
.******************************************************************************
UPPRCS00  WRITE     HTMLFILE;"theURL='preadm01.php'+":
                             "       '?reportno=3' +":
                             "       '&status=3' +":
                             "       '&admissionid=",ADMISCKI,"' +":
                             "       '&urnumber=",URNUMBER,"' +":
                             "       '&admissno=",ADMISSNO,"';":
                             "xmlHttp = createHttpObject();":
                             "xmlHttp.open('GET', theURL, false);":
                             "xmlHttp.send();":
                             "if (!isWhitespace(xmlHttp.responseText)) {":
                             "alert(xmlHttp.responseText)":
                             "}"

UPPRCS99  RETURN
+
.------------------------------------------------------------
.         Checking MH LS Referral Management SJOG
.------------------------------------------------------------
LSRE1000  OPEN      MEHHLSA2,"mehhlsaf"
          MOVE      SP70,KEY8
          PACK      KEY32,URNUMBER,Z70
          CALL      RSMHHLS2
LSRE1100  CALL      RPMHHLS2
          BRANCH    OVRCD,LSRE1800
          MATCH     URNUMBER,MHHLURNO
          GOTO      LSRE1800 IF NOT EQUAL
.
.         MATCH     SP70,MHHLOREF
.         GOTO      LSREF100 IF EQUAL
.
.         PACK      KEY5,CATtm,MHHLOREF,SP70
.         CALL      RDCODE1
.         BRANCH    OVRCD,LSREF100
.
.         MATCH     ANSI,TCINDC1
.         GOTO      LSREF100 IF NOT EQUAL
.
.         Check if it's an Open Legal status
.
          MATCH     "1",MHHLSTAT
          GOTO      LSRE1100 IF EQUAL
.
          MATCH     SP70,MHHLEDAT
          GOTO      LSRE1100 IF NOT EQUAL         * Not opened
.
          MOVE      MHHLUNIQ,KEY8
.
LSRE1800  WRITE     HTMLFILE;KEY8;
LSRE1999  RETURN
.
.-----------------------------------------------------------
. Delete record from the opt out of SMS file - PMSOOSFD
.-----------------------------------------------------------
OSMS0000  MATCH     "1",PTCNSMSN
          GOTO      OSMS9999 IF NOT EQUAL
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSOOSA1,"pmsoosaf"
          TRAPCLR   IO
          BRANCH    OVRCD,OSMS9999
.
          MOVE      URNUMBER,PMOOURNO            * U/R Number
          MOVE      USERID,PMOOCUSR              * User Who Created Record
.
          CALL      IBACLOCK
          PACK      PMOOCDTE,CCC,CYY,CMM,CDD
          REP       " 0",PMOOCDTE                * Date Record Created
          MOVE      CTIMEIS,PMOOCTME             * Time Record Created
.
          MOVE      SP70,PMOOSPAR                * Spare
.
          PACK      KEY8,PMOOURNO,SP70
          CALL      RAPMOOS1
          IF        OVRCD=1
            CALL      WRPMOOS1
          ENDIF
.
          CLOSE     PMSOOSA1
.
OSMS9999  RETURN
.
.-----------------------------------------------------------
. Delete record from the opt out of SMS file - PMSOOSFD
.-----------------------------------------------------------
DSMS0000  MATCH     "1",PTCNSMSN
          GOTO      DSMS9999 IF NOT EQUAL
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSOOSA1,"pmsoosaf"
          TRAPCLR   IO
          BRANCH    OVRCD,DSMS9999
.
          PACK      KEY8,URNUMBER,SP70
          CALL      DEPMOOS1
.
          CLOSE     PMSOOSA1
.
DSMS9999  RETURN

+
.******************************************************************************
.*                                  AALV0000                                  *
.*                        Add/Update ibaalvaf recored                         *
.******************************************************************************
AALV0000  MATCH     "1",IBAALVIN
          GOTO      AALV9999 IF NOT EQUAL
.
          OPEN      IBAALVA1,"ibaalvaf"
          MATCH     SP70,IBALV001
          GOTO      AALV9999 IF EQUAL
          GOTO      AALV9999 IF EOS
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDIBALV1
          IF        OVRCD=0
.
            MATCH     " 1",IBAVTYPE
            GOTO      AALV9999 IF EQUAL
.
            MOVE      IBALV001,IBAVAVIS
.
            CALL      UPIBALV1
.
          ELSE
.
            MOVE      AADMNO,IBAVVISN
            MOVE      IBALV001,IBAVAVIS
            MOVE      SP70,IBAVTYPE
            MOVE      SP70,IBAVSPAR
.
            CALL      WRIBALV1
.
          ENDIF
.
AALV9999  CLOSE     IBAALVA1
          RETURN
+
.******************************************************************************
.*                                  UNLE0000                                  *
.*                        Unlink eadmission record                            *
.******************************************************************************
UNLE0000  MATCH     "1",PTCNEPIS
          GOTO      UNLE9999 IF NOT EQUAL
.
          OPEN      PMSEHBA3,"pmsehbaf"
UNLE1000  PACK      KEY37,URNUMBER,SP70
          CALL      RSPMEHB3
          CALL      RKPMEHB3
          BRANCH    OVRCD,UNLE5000
.
          MATCH     URNUMBER,PMHBURNO
          GOTO      UNLE5000 IF NOT EQUAL
.
          MOVE      SP70,PMHBURNO
          MOVE      SP70,PMHBVISN
          CALL      UPPMEHB3
          GOTO      UNLE1000
.
UNLE5000  CLOSE     PMSEHBA3
.
          OPEN      COMERHA3,"comerhaf"
UNLE6000  PACK      KEY38,URNUMBER,SP70
          CALL      RSCMERH3
          CALL      RKCMERH3
          BRANCH    OVRCD,UNLE9000
.
          MATCH     URNUMBER,CMRHURNO
          GOTO      UNLE9000 IF NOT EQUAL
.
          MOVE      SP70,CMRHURNO
          MOVE      SP70,CMRHPCOD
          MOVE      SP70,CMRHPCNT
          MOVE      SP70,CMRHVISN
          CALL      UPCMERH3
          GOTO      UNLE6000
.
UNLE9000  CLOSE     COMERHA3
.
UNLE9999  RETURN
+
.**************************************************************************
.*  VCAAG000  :  Subroutine to validate admission criteria & age          *
.*  Returns:   EXIT  0 = Ok to continue                                   *
.*                   1 = Error                                            *
.**************************************************************************
.
VCAAG000  COMPARE   TEN,PSAGEDAY
          GOTO      VCAAG100 IF LESS
.
          GOTO      VCAAG150
.
VCAAG100  MOVE      SP70,TEMPVAR
          MOVE      "KNU",TEMPVAR                                     *C-49016
          REP       " _",TEMPVAR
          SCAN      ADMICRIT,TEMPVAR
          GOTO      VCAAG910 IF NOT EQUAL
.
VCAAG150  COMPARE   TEN,PSAGEDAY
          GOTO      VCAAG160 IF NOT LESS
.
          GOTO      VCAAG175
.
VCAAG160  MOVE      SP70,TEMPVAR
          MOVE      "KOBEXCS",TEMPVAR
          REP       " _",TEMPVAR
          SCAN      ADMICRIT,TEMPVAR
          GOTO      VCAAG910 IF NOT EQUAL
.
VCAAG175  MATCH     ANSN,ADMICRIT
          GOTO      VCAAG180 IF EQUAL
.
          MATCH     ANSU,ADMICRIT
          GOTO      VCAAG180 IF EQUAL
.
          GOTO      VCAAG225
.
VCAAG180  COMPARE   TEN,PSAGEDAY
          GOTO      VCAAG910 IF NOT LESS
.
VCAAG225  MATCH     ANSO,ADMICRIT   
          GOTO      VCAAG240 IF EQUAL
.
          MATCH     ANSB,ADMICRIT   
          GOTO      VCAAG240 IF EQUAL
.
          MATCH     ANSE,ADMICRIT
          GOTO      VCAAG240 IF EQUAL
.
          MATCH     ANSX,ADMICRIT
          GOTO      VCAAG240 IF EQUAL
.
          MATCH     ANSC,ADMICRIT
          GOTO      VCAAG240 IF EQUAL
.
          MATCH     ANSS,ADMICRIT
          GOTO      VCAAG240 IF EQUAL
.
          GOTO      VCAAG900
.
VCAAG240  COMPARE   TEN,PSAGEDAY
          GOTO      VCAAG910 IF LESS
.
VCAAG900  MOVE      ZERO,EXIT
          GOTO      VCAAG999
.
VCAAG910  MOVE      "Invalid Age for Criteria for Admission",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VCAAG999
.
VCAAG999  RETURN
+
.**************************************************************************
.*  VCACT000  :  Subroutine to validate admission criteria & caretype     *
.*  Returns:   EXIT  0 = Ok to continue                                   *
.*                   1 = Error                                            *
.**************************************************************************
.
VCACT000  UNPACK    CARETYPE,KEY1,DIM1
.
          MATCH     "10",CARETYPE
          GOTO      VCACT100 IF EQUAL
.
          GOTO      VCACT150
.
VCACT100  MOVE      SP70,TEMPVAR
          MOVE      "K",TEMPVAR
          REP       " _",TEMPVAR
          SCAN      ADMICRIT,TEMPVAR
          GOTO      VCACT910 IF NOT EQUAL
          GOTO      VCACT225
.
VCACT150  MATCH     "1",KEY1
          GOTO      VCACT160 IF EQUAL
.
          MATCH     "P",KEY1
          GOTO      VCACT160 IF EQUAL
.
          MATCH     "6",KEY1
          GOTO      VCACT160 IF EQUAL
.
          MATCH     "8",KEY1
          GOTO      VCACT160 IF EQUAL
.
          MATCH     "5",KEY1
          GOTO      VCACT160 IF EQUAL
.
          MATCH     "9",KEY1
          GOTO      VCACT160 IF EQUAL
.
          MATCH     "MC",CARETYPE
          GOTO      VCACT160 IF EQUAL
.
          MATCH     "0",KEY1
          GOTO      VCACT160 IF EQUAL
.
          GOTO      VCACT175
.
VCACT160  MOVE      SP70,TEMPVAR
          MOVE      "OBEXC",TEMPVAR
          REP       " _",TEMPVAR
          SCAN      ADMICRIT,TEMPVAR
          GOTO      VCACT910 IF NOT EQUAL
.
VCACT175  MATCH     "4",KEY1
          GOTO      VCACT180 IF EQUAL
.
          GOTO      VCACT190
.
VCACT180  MOVE      SP70,TEMPVAR
          MOVE      "NUOBEXCS",TEMPVAR
          REP       " _",TEMPVAR
          SCAN      ADMICRIT,TEMPVAR
          GOTO      VCACT910 IF NOT EQUAL
.
VCACT190  MATCH     "U",KEY1
          GOTO      VCACT200 IF EQUAL
.
          GOTO      VCACT225
.
VCACT200  MOVE      SP70,TEMPVAR
          MOVE      "U",TEMPVAR
          REP       " _",TEMPVAR
          SCAN      ADMICRIT,TEMPVAR
          GOTO      VCACT910 IF NOT EQUAL
.
VCACT225  MATCH     ANSO,ADMICRIT
          GOTO      VCACT240 IF EQUAL
.
          MATCH     ANSB,ADMICRIT
          GOTO      VCACT240 IF EQUAL
.
          MATCH     ANSE,ADMICRIT
          GOTO      VCACT240 IF EQUAL
.
          MATCH     ANSX,ADMICRIT
          GOTO      VCACT240 IF EQUAL
.
          MATCH     ANSC,ADMICRIT
          GOTO      VCACT240 IF EQUAL
.
          GOTO      VCACT300
.
VCACT240  MATCH     "1",KEY1
          GOTO      VCACT300 IF EQUAL
.
          MATCH     "P",KEY1
          GOTO      VCACT300 IF EQUAL
.
          MATCH     "6",KEY1
          GOTO      VCACT300 IF EQUAL
.
          MATCH     "8",KEY1
          GOTO      VCACT300 IF EQUAL
.
          MATCH     "5",KEY1
          GOTO      VCACT300 IF EQUAL
.
          MATCH     "9",KEY1
          GOTO      VCACT300 IF EQUAL
.
          MATCH     "MC",CARETYPE
          GOTO      VCACT300 IF EQUAL
.
          MATCH     "0",KEY1
          GOTO      VCACT300 IF EQUAL
.
          MATCH     "4",KEY1
          GOTO      VCACT300 IF EQUAL
.
          GOTO      VCACT910
.
VCACT300  MATCH     ANSK,ADMICRIT
          GOTO      VCACT350 IF EQUAL
.
          GOTO      VCACT400
.
VCACT350  MATCH     "10",CARETYPE
          GOTO      VCACT400 IF EQUAL
.
          GOTO      VCACT910
.
VCACT400  MATCH     ANSN,ADMICRIT
          GOTO      VCACT450 IF EQUAL
.
          MATCH     ANSS,ADMICRIT
          GOTO      VCACT450 IF EQUAL
.
          GOTO      VCACT500
.
VCACT450  MATCH     "4",KEY1
          GOTO      VCACT500 IF EQUAL
.
          GOTO      VCACT910
.
VCACT500  MATCH     ANSU,ADMICRIT
          GOTO      VCACT550 IF EQUAL
.
          GOTO      VCACT900
.
VCACT550  MATCH     "4",KEY1
          GOTO      VCACT900 IF EQUAL
.
          MATCH     "U",KEY1
          GOTO      VCACT900 IF EQUAL
.
          GOTO      VCACT910
.
VCACT900  MOVE      ZERO,EXIT
          GOTO      VCACT999
.
VCACT910  MOVE      "Invalid Care Type for Criteria for Admission",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VCACT999
.
VCACT999  RETURN
+
.**************************************************************************
.*  VCAQS000  :  Subroutine to validate admission criteria & qual stat    *
.*  Returns:   EXIT  0 = Ok to continue                                   *
.*                   1 = Error                                            *
.**************************************************************************
.
VCAQS000  MATCH     "N",QUALSTAT
          GOTO      VCAQS100 IF EQUAL
.
          MATCH     "U",QUALSTAT
          GOTO      VCAQS100 IF EQUAL
.
          GOTO      VCAQS150
.
VCAQS100  MOVE      SP70,TEMPVAR
          MOVE      "NU",TEMPVAR 
          REP       " _",TEMPVAR
          SCAN      ADMICRIT,TEMPVAR
          GOTO      VCAQS910 IF NOT EQUAL
.
VCAQS150  MATCH     "X",QUALSTAT
          GOTO      VCAQS160 IF EQUAL
.
          MATCH     "A",QUALSTAT
          GOTO      VCAQS160 IF EQUAL
.
          GOTO      VCAQS225
.
VCAQS160  MOVE      SP70,TEMPVAR
          MOVE      "KBCEXOS",TEMPVAR
          REP       " _",TEMPVAR
          SCAN      ADMICRIT,TEMPVAR
          GOTO      VCAQS910 IF NOT EQUAL
.
VCAQS225  MATCH     ANSO,ADMICRIT
          GOTO      VCAQS240 IF EQUAL
.
          MATCH     ANSB,ADMICRIT
          GOTO      VCAQS240 IF EQUAL
.
          MATCH     ANSE,ADMICRIT
          GOTO      VCAQS240 IF EQUAL
.
          MATCH     ANSX,ADMICRIT
          GOTO      VCAQS240 IF EQUAL
.
          MATCH     ANSC,ADMICRIT
          GOTO      VCAQS240 IF EQUAL
.
          MATCH     ANSS,ADMICRIT
          GOTO      VCAQS240 IF EQUAL
.
          MATCH     ANSK,ADMICRIT
          GOTO      VCAQS240 IF EQUAL
.
          GOTO      VCAQS300
.
VCAQS240  MATCH     "X",QUALSTAT 
          GOTO      VCAQS300 IF EQUAL
.
          MATCH     "A",QUALSTAT
          GOTO      VCAQS300 IF EQUAL
.
          GOTO      VCAQS910
.
VCAQS300  MATCH     ANSN,ADMICRIT
          GOTO      VCAQS350 IF EQUAL
.
          MATCH     ANSU,ADMICRIT
          GOTO      VCAQS350 IF EQUAL
.
          GOTO      VCAQS900
.
VCAQS350  MATCH     "N",QUALSTAT
          GOTO      VCAQS900 IF EQUAL
.
          MATCH     "U",QUALSTAT
          GOTO      VCAQS900 IF EQUAL
.
          GOTO      VCAQS910
.
VCAQS900  MOVE      ZERO,EXIT
          GOTO      VCAQS999
.
VCAQS910  MOVE      "Invalid Qualification Status for Criteria for Admission",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      VCAQS999
.
VCAQS999  RETURN
+
.-----------------------------------------------------------
.        Get Patient Attributes
.-----------------------------------------------------------
PTATRU00  COMPARE   ONE,NOATTRIB
          GOTO      PTATRU99 IF EQUAL
.
          MATCH     SP70,URNUMBER
          GOTO      PTATRU99 IF EQUAL
          GOTO      PTATRU99 IF EOS
.
.         MATCH     SP70,ADMISSNO
.         GOTO      PTATRU99 IF EQUAL
.         GOTO      PTATRU99 IF EOS
.
          PACK      KEY35,URNUMBER,Z70
          CALL      RSPTATR1
PTATRU10  CALL      RPPTATR1
          BRANCH    OVRCD,PTATRU90
.
          MATCH     URNUMBER,PTARURNO
          GOTO      PTATRU90 IF NOT EQUAL
.
.         MATCH     ADMISSNO,PTARVISN
.         GOTO      PTATRU10 IF NOT EQUAL
.
          MATCH     "001",PTARTYPE
          GOTO      PTATRU10 IF NOT EQUAL
.
          MATCH     "1",PTARDELR
          GOTO      PTATRU10 IF EQUAL
.
          BRANCH    FORM2,PTATRU20,PTATRU30,PTATRU40,PTATRU50,PTATRU60:
                          PTATRU70
          GOTO      PTATRU99
.
PTATRU20  MATCH     SP70,PTARDATE
          GOTO      PTATRU99 IF EQUAL
          UNPACK    PTARDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      PTATRU99
.
PTATRU30  WRITE     HTMLFILE;PTARTIME;
          GOTO      PTATRU99
.
PTATRU40  WRITE     HTMLFILE;PTARVAL1;
          GOTO      PTATRU99
.
PTATRU50  WRITE     HTMLFILE;PTARVAL2;
          GOTO      PTATRU99
.
PTATRU60  MATCH     SP70,PTARVAL3
          IF        @EQUAL
            CALL      CLCBMI00
          ELSE
            PACK      BODMASIN,PTARVAL3,SP70
          ENDIF
.
          CALL      RNGBMI00
          WRITE     HTMLFILE;BODMASRN;
          GOTO      PTATRU99
.
PTATRU70  MATCH     SP70,PTARUDTE
          GOTO      PTATRU71 IF EQUAL
.
          UNPACK    PTARUDTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP1,PTARUTME;
          GOTO      PTATRU99
.
PTATRU71  MATCH     SP70,PTARCDTE
          GOTO      PTATRU99 IF EQUAL
.
          UNPACK    PTARCDTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP1,PTARCTME;
          GOTO      PTATRU99
.
PTATRU90  CALL      CLPATATR
PTATRU99  RETURN
+
.------------------------------------------------------------
. Checking for multiple MBS codes for this admission
.------------------------------------------------------------
CMBS0000  MOVE      ZERO,F1
          MOVE      ZERO,FORM1
.
          PACK      KEY31,ADMISSNO,SP70
          CALL      RSOPDEA2
CMBS1000  CALL      RKOPDEA2
          BRANCH    OVRCD,CMBS9999
.
          MATCH     ADMISSNO,OPDAADMN
          GOTO      CMBS9999 IF NOT EQUAL
.
          COMPARE   THREE,OPDASTAT
          GOTO      CMBS1000 IF EQUAL       * cancelled
.
          MATCH     SP70,OPDAPROV
          IF        !@EQUAL & !@EOS
            ADD       ONE,FORM1
          ENDIF
.
          MATCH     SP70,OPDAPRV2
          IF        !@EQUAL & !@EOS
            ADD       ONE,FORM1
          ENDIF
.
          MATCH     SP70,OPDAPRV3
          IF        !@EQUAL & !@EOS
            ADD       ONE,FORM1
          ENDIF
.
          COMPARE   FORM1,ONE
          IF        @LESS
            MOVE      ONE,F1
          ENDIF
.
          PACK      KEY13,OPDAUNIQ,SP70
          CALL      RSOPMBS1
CMBS2000  CALL      RKOPMBS1
          BRANCH    OVRCD,CMBS1000
.
          MATCH     OPDAUNIQ,OPMBUNIQ
          GOTO      CMBS1000 IF NOT EQUAL
.
          ADD       ONE,FORM1
          BRANCH    FORM1,CMBS2000
.
          MOVE      ONE,F1                  * multiple MBS Codes
CMBS9999  RETURN
+
.******************************************************************************
.*                Display Extra MBS Items                                     *
.******************************************************************************
DMBS0000  WRITE     HTMLFILE;"<tr><td class=DataLabel colspan=2><b>":
                             "Item/Description</b></td></tr>";
.
          MOVE      ZERO,CNTITEM
          PACK      KEY31,ADMISSNO,SP70
          CALL      RSOPDEA2
DMBS1000  CALL      RKOPDEA2
          BRANCH    OVRCD,DMBS9999
.
          MATCH     ADMISSNO,OPDAADMN
          GOTO      DMBS9999 IF NOT EQUAL
.
          MATCH     "3",DOPDASTA
          GOTO      DMBS1000 IF EQUAL          * Cancelled
.
          MATCH     SP70,OPDAPROV
          IF        !@EQUAL & !@EOS
            MOVE      OPDAPROV,KEY9
            PACK      KEY17,OPDAPROV,OPDADATE
            CALL      CDES0000
.
            WRITE     HTMLFILE;"<tr><td>":
                               "<input type=hidden name=extrprov value=#"":
                               OPDAPROV,"#"></td></tr>";
.
            WRITE     HTMLFILE;"<tr><td class=DataField width=12%>":
                               "<input type=text size=9 maxlength=12 ":
                               "class='Readonly readonly'":
                               " value='",OPDAPROV,"' ></td>":
                               "<td class=DataField width=45%>":
                               "<input type=text size=50 maxlength=70 ":
                               "class='Readonly readonly'":
                               " value='",IDESC,"' ></td>";
.
            WRITE     HTMLFILE;"<td class=DataField>":
                               "<input type=checkbox name=oeceprov":
                               " value='1' checked></td></tr>";
          ENDIF
.
          MATCH     SP70,OPDAPRV2
          IF        !@EQUAL & !@EOS
            MOVE      OPDAPRV2,KEY9
            PACK      KEY17,OPDAPRV2,OPDADATE
            CALL      CDES0000
.
            WRITE     HTMLFILE;"<tr><td>":
                               "<input type=hidden name=extrprv2 value=#"":
                                OPDAPRV2,"#"></td></tr>";
.
            WRITE     HTMLFILE;"<tr><td class=DataField width=12%>":
                               "<input type=text size=9 maxlength=12 ":
                               "class='Readonly readonly'":
                               " value='",OPDAPRV2,"' ></td>":
                               "<td class=DataField width=45%>":
                               "<input type=text size=50 maxlength=70 ":
                               "class='Readonly readonly'":
                               " value='",IDESC,"' ></td>";
.
            WRITE     HTMLFILE;"<td class=DataField>":
                               "<input type=checkbox name=oeceprv2":
                               " value='1' checked></td></tr>";
          ENDIF
.
          MATCH     SP70,OPDAPRV3
          IF        !@EQUAL & !@EOS
            MOVE      OPDAPRV3,KEY9
            PACK      KEY17,OPDAPRV3,OPDADATE
            CALL      CDES0000
.
            WRITE     HTMLFILE;"<tr><td><input type=hidden name=extrprv3":
                               " value=#"":
                                OPDAPRV3,"#"></td></tr>";
.
            WRITE     HTMLFILE;"<tr><td class=DataField width=12%>":
                               "<input type=text size=9 maxlength=12 ":
                               "class='Readonly readonly'":
                               " value='",OPDAPRV3,"' ></td>":
                               "<td class=DataField width=45%>":
                               "<input type=text size=50 maxlength=70 ":
                               "class='Readonly readonly'":
                               " value='",IDESC,"' ></td>";
.
            WRITE     HTMLFILE;"<td class=DataField>":
                               "<input type=checkbox name=oeceprv3":
                               " value='1' checked></td></tr>";
          ENDIF
.
          PACK      KEY13,OPDAUNIQ,SP70
          CALL      RSOPMBS1
DMBS2000  CALL      RKOPMBS1
          BRANCH    OVRCD,DMBS1000
.
          MATCH     OPDAUNIQ,OPMBUNIQ
          GOTO      DMBS1000 IF NOT EQUAL
.
          MOVE      OPMBMBSI,KEY9
          PACK      KEY17,OPMBMBSI,OPDADATE
          CALL      CDES0000                * Get MBS/ICD Operation Code desc.
.
          ADD       ONE,CNTITEM
          MOVE      CNTITEM,KEY3
          REP       " 0",KEY3
.
          WRITE     HTMLFILE;"<tr><td><input type=hidden":
                             " name=mcntr",KEY3," value=#"":
                             OPMBUNIQ,OPMBCNTR,"#"></td></tr>";
.
          WRITE     HTMLFILE;"<tr><td class=DataField width=12%>":
                             "<input type=text size=9 maxlength=12 ":
                             "class='Readonly readonly'":
                             " value='",OPMBMBSI,"' ></td>":
                             "<td class=DataField width=45%>":
                             "<input type=text size=50 maxlength=70 ":
                             "class='Readonly readonly'":
                             " value='",IDESC,"' ></td>";
.
          WRITE    HTMLFILE;"<td class=DataField>":
                            "<input type=checkbox name=oecmb",KEY3:
                            " value='1' checked></td></tr>";
          GOTO      DMBS2000
.
DMBS9999  RETURN
+
.------------------------------------------------------------
. Get MBS/ICD operation description
.------------------------------------------------------------
CDES0000  IF        OPCNCODE=1
            CALL      PATITMRD              * Read MBS code file
            IF        OVRCD=1
              MOVE      SP70,IDESC
            ENDIF
          ELSE
            CALL      RDPTICO1                * Read ICD operation file
            IF        OVRCD=1
              MOVE      SP70,ODESC
            ENDIF
            MOVE      ODESC,IDESC           * Set up description
          ENDIF
CDES9999  RETURN
+
.******************************************************************************
.*                Display Extra MBS Items with Different Header               *
.******************************************************************************
DMBH0000  WRITE     HTMLFILE;"<tr><td class=DataLabel><b>":
                             "Item/Description</b></td>":
"<td align=right>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;":
"Perform OEC Requests for each MBS Items</td></tr>";
.
          MOVE      ZERO,CNTITEM
          PACK      KEY31,ADMISSNO,SP70
          CALL      RSOPDEA2
DMBH1000  CALL      RKOPDEA2
          BRANCH    OVRCD,DMBH9999
.
          MATCH     ADMISSNO,OPDAADMN
          GOTO      DMBH9999 IF NOT EQUAL
.
          MATCH     "3",DOPDASTA
          GOTO      DMBH1000 IF EQUAL          * Cancelled
.
.          MATCH     SP70,OPDAPROV
.          IF        !@EQUAL & !@EOS
.            MOVE      OPDAPROV,KEY9
.            PACK      KEY17,OPDAPROV,SP70
.            CALL      CDES0000
.
.            WRITE     HTMLFILE;"<input type=hidden name=extrprov value=#"":
.                                OPDAPROV,"#">";
.
.            WRITE     HTMLFILE;"<tr><td class=DataField width=12%>":
.                               "<input type=text size=9 maxlength=12 ":
.                               "class='Readonly readonly'":
.                               " value='",OPDAPROV,"' </td>":
.                               "<td class=DataField width=45%>":
.                               "<input type=text size=50 maxlength=70 ":
.                               "class='Readonly readonly'":
.                               " value='",IDESC,"' </td>";
.
.            WRITE     HTMLFILE;"<td class=DataField>":
.                               "<input type=checkbox name=oeceprov":
.                               " value='1' checked></td></tr>";
.          ENDIF
.
          MATCH     SP70,OPDAPRV2
          IF        !@EQUAL & !@EOS
            MOVE      OPDAPRV2,KEY9
            PACK      KEY17,OPDAPRV2,OPDADATE
            CALL      CDES0000
.
            WRITE     HTMLFILE;"<input type=hidden name=extrprv2 value=#"":
                                OPDAPRV2,"#">";
.
            WRITE     HTMLFILE;"<tr><td class=DataField width=12%>":
                               "<input type=text size=9 maxlength=12 ":
                               "class='Readonly readonly'":
                               " value='",OPDAPRV2,"' </td>":
                               "<td class=DataField width=45%>":
                               "<input type=text size=50 maxlength=70 ":
                               "class='Readonly readonly'":
                               " value='",IDESC,"' </td>";
.
            WRITE     HTMLFILE;"<td class=DataField>":
                               "<input type=checkbox name=oeceprv2":
                               " value='1' checked></td></tr>";
          ENDIF
.
          MATCH     SP70,OPDAPRV3
          IF        !@EQUAL & !@EOS
            MOVE      OPDAPRV3,KEY9
            PACK      KEY17,OPDAPRV3,OPDADATE
            CALL      CDES0000
.
            WRITE     HTMLFILE;"<input type=hidden name=extrprv3 value=#"":
                                OPDAPRV3,"#">";
.
            WRITE     HTMLFILE;"<tr><td class=DataField width=12%>":
                               "<input type=text size=9 maxlength=12 ":
                               "class='Readonly readonly'":
                               " value='",OPDAPRV3,"' </td>":
                               "<td class=DataField width=45%>":
                               "<input type=text size=50 maxlength=70 ":
                               "class='Readonly readonly'":
                               " value='",IDESC,"' </td>";
.
            WRITE     HTMLFILE;"<td class=DataField>":
                               "<input type=checkbox name=oeceprv3":
                               " value='1' checked></td></tr>";
          ENDIF
.
          PACK      KEY13,OPDAUNIQ,SP70
          CALL      RSOPMBS1
DMBH2000  CALL      RKOPMBS1
          BRANCH    OVRCD,DMBH1000
.
          MATCH     OPDAUNIQ,OPMBUNIQ
          GOTO      DMBH1000 IF NOT EQUAL
.
          MOVE      OPMBMBSI,KEY9
          PACK      KEY17,OPMBMBSI,OPDADATE
          CALL      CDES0000                * Get MBS/ICD Operation Code desc.
.
          ADD       ONE,CNTITEM
          MOVE      CNTITEM,KEY3
          REP       " 0",KEY3
.
          WRITE     HTMLFILE;"<input type=hidden name=mcntr",KEY3," value=#"":
                             OPMBUNIQ,OPMBCNTR,"#">";
.
          WRITE     HTMLFILE;"<tr><td class=DataField width=12%>":
                             "<input type=text size=9 maxlength=12 ":
                             "class='Readonly readonly'":
                             " value='",OPMBMBSI,"' </td>":
                             "<td class=DataField width=45%>":
                             "<input type=text size=50 maxlength=70 ":
                             "class='Readonly readonly'":
                             " value='",IDESC,"' </td>";
.
          WRITE    HTMLFILE;"<td class=DataField>":
                            "<input type=checkbox name=oecmb",KEY3:
                            " value='1' checked></td></tr>";
          GOTO      DMBH2000
.
DMBH9999  RETURN
+
.******************************************************************************
.*                Display Extra MBS Items Indicator                           *
.******************************************************************************
DMBC0000  MOVE      ZERO,CNTITEM
          PACK      KEY31,ADMISSNO,SP70
          CALL      RSOPDEA2
DMBC1000  CALL      RKOPDEA2
          BRANCH    OVRCD,DMBC9999
.
          MATCH     ADMISSNO,OPDAADMN
          GOTO      DMBC9999 IF NOT EQUAL
.
          MATCH     "3",DOPDASTA
          GOTO      DMBC1000 IF EQUAL          * Cancelled
.
          MATCH     SP70,OPDAPROV
          IF        !@EQUAL & !@EOS
            ADD       ONE,CNTITEM
          ENDIF
.
          MATCH     SP70,OPDAPRV2
          IF        !@EQUAL & !@EOS
            ADD       ONE,CNTITEM
          ENDIF
.
          MATCH     SP70,OPDAPRV3
          IF        !@EQUAL & !@EOS
            ADD       ONE,CNTITEM
          ENDIF
.
          PACK      KEY13,OPDAUNIQ,SP70
          CALL      RSOPMBS1
DMBC2000  CALL      RKOPMBS1
          BRANCH    OVRCD,DMBC1000
.
          MATCH     OPDAUNIQ,OPMBUNIQ
          GOTO      DMBC1000 IF NOT EQUAL
.
          ADD       ONE,CNTITEM
.
          GOTO      DMBC2000
.
DMBC9999  WRITE     HTMLFILE;CNTITEM;
          RETURN
+
.******************************************************************************
.*                Map Category Y6 to Category KB                              *
.******************************************************************************
MY6KB000  MOVE      SP70,PMVXUVTH
          MOVE      SP70,SAVINDC2
.
          PACK      KEY31,ADMISSNO,SP70
          CALL      RSOPDEA2
MY6KB010  CALL      RKOPDEA2
          BRANCH    OVRCD,MY6KB999          * not a theatre booking
.
          MATCH     OPDAADMN,ADMISSNO
          GOTO      MY6KB999 IF NOT EQUAL   * not a theatre booking
.
          MATCH     SP70,OPDAUSR1
          GOTO      MY6KB999 IF EQUAL       * no provisional item
.
          PACK      KEY5,ANSY,SIX,OPDAUSR1,SP70   * Cat Y6
          CALL      RDCODE1
          BRANCH    OVRCD,MY6KB999
.
          MATCH     "1",TCINDC2
          IF        !@EQUAL
            MATCH     "2",TCINDC2
            IF        !@EQUAL
              MATCH     "9",TCINDC2
              IF        !@EQUAL
                GOTO      MY6KB010
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      TCINDC2,SAVINDC2 
.
          PACK      KEY5,ANSK,ANSB,SP70          * map with Cat KB
          CALL      RDSCODE1
MY6KB020  CALL      RDKCODE1
          BRANCH    OVRCD,MY6KB999
.
          MATCH     "KB",TCODE
          GOTO      MY6KB999 IF NOT EQUAL
.
          MATCH     SP70,ACODE
          GOTO      MY6KB020 IF EQUAL
.
          MATCH     SAVINDC2,TCINDC1             * match with TCINDC1
          GOTO      MY6KB020 IF NOT EQUAL
.
          MOVE      ACODE,PMVXUVTH
.
MY6KB999  PACK      KEY31,ADMISSNO,SP70
          CALL      RSOPDEA2
          CALL      RKOPDEA2
          IF        OVRCD=1
            CALL      CLOPRDEA
          ENDIF
.
          RETURN
.
.******************************************************************************
.*                SJOG PMI Audits Update Reg                                  *
.******************************************************************************
SJGAU200  MATCH     "1",SJOGAUDT
          GOTO      SJGAU299 IF NOT EQUAL
.
          MOVE      ZERO,FORM2
.
          PACK      PTMASNAM,PTMASNAM,SP70
          PACK      PMPXFNAM,PMPXFNAM,SP70
          PACK      PGNAME,PGNAME,SP70
          PACK      PMPXSNAM,PMPXSNAM,SP70
          PACK      PTITL,PTITL,SP70
          PACK      PSEX,PSEX,SP70
          PACK      PBDATE,PBDATE,SP70
          PACK      PMPXPFGN,PMPXPFGN,SP70
          PACK      ALIASSTS,ALIASSTS,SP70
.
          MATCH     SAVESNAM,PTMASNAM
          IF        @EQUAL
            MOVE      SP70,SAVESNAM
          ELSE
            ADD       ONE,FORM2
          ENDIF
.
          MATCH     SAVEXFNM,PGNAME
          IF        @EQUAL
            MOVE      SP70,SAVEXFNM
          ELSE
            ADD       ONE,FORM2
          ENDIF
.
          MATCH     SAVEXSNM,PMPXSNAM
          IF        @EQUAL
            MOVE      SP70,SAVEXSNM
          ELSE
            ADD       ONE,FORM2
          ENDIF
.
          MATCH     SAVETITL,PTITL
          IF        @EQUAL
            MOVE      SP70,SAVETITL
          ELSE
            ADD       ONE,FORM2
          ENDIF
.
          MATCH     SAVEPSEX,PSEX
          IF        @EQUAL
            MOVE      SP70,SAVEPSEX
          ELSE
            ADD       ONE,FORM2
          ENDIF
.
          MATCH     SAVEPDOB,PBDATE
          IF        @EQUAL
            MOVE      SP70,SAVEPDOB
          ELSE
            ADD       ONE,FORM2
          ENDIF
.
          MATCH     SAVEPFGN,PMPXPFGN
          IF        @EQUAL
            MOVE      SP70,SAVEPFGN
          ELSE
            ADD       ONE,FORM2
          ENDIF
.
          MATCH     SP70,ALIASSTS
          IF        !@EQUAL
            ADD       ONE,FORM2
          ENDIF
.
          COMPARE    ZERO,FORM2
          IF         @EQUAL
            GOTO       SJGAU240
          ENDIF
.
SJGAU230  MOVE       "005",D3
          CALL       WDAU0000
.
SJGAU240  PACK      PTMADCDT,PTMADCDT,SP70
          PACK      PTMADCUT,PTMADCUT,SP70
          PACK      PTMADCUU,PTMADCUU,SP70
.
          MATCH     "2",PTCNAVCD
            IF        !@EQUAL 
            MATCH     SAVEDCDT,PTMADCDT
            IF         @EQUAL
              MOVE       SP70,SAVEDCDT
            ELSE
              MOVE       "006",D3
              CALL       WDAU0000
              GOTO       SJGAU250
            ENDIF
.
            MATCH     SAVECTIM,PTMADCUT
            IF         @EQUAL
              MOVE       SP70,SAVECTIM
            ELSE
              MOVE       "006",D3
              CALL       WDAU0000
              GOTO       SJGAU250
            ENDIF
.
            MATCH     SAVECUID,PTMADCUU
            IF         @EQUAL
              MOVE       SP70,SAVECUID
            ELSE
              MOVE       "006",D3
              CALL       WDAU0000
              GOTO       SJGAU250
            ENDIF
          ENDIF
.
SJGAU250  MOVE      ZERO,FORM2
.
          PACK      PMSTAT,PMSTAT,SP70
          PACK      PREG,PREG,SP70
          PACK      PCONT,PCONT,SP70
          PACK      PTYPE,PTYPE,SP70
          PACK      PMPXABRG,PMPXABRG,SP70
          PACK      PMPXUSR7,PMPXUSR7,SP70
          PACK      PMEDI,PMEDI,SP70
          PACK      PTMXMCCD,PTMXMCCD,SP70
          PACK      PMPXMEDC,PMPXMEDC,SP70
          PACK      PMPXCONP,PMPXCONP,SP70
.
          MATCH     SAVEPMST,PMSTAT
          IF        @EQUAL
            MOVE      SP70,SAVEPMST
          ELSE
            ADD       ONE,FORM2
          ENDIF
.
          MATCH     SAVEPREG,PREG
          IF        @EQUAL
            MOVE      SP70,SAVEPREG
          ELSE
            ADD       ONE,FORM2
          ENDIF
.
          MATCH     SAVEPCNT,PCONT
          IF        @EQUAL
            MOVE      SP70,SAVEPCNT
          ELSE
            ADD       ONE,FORM2
          ENDIF
.
          MATCH     SAVEPTYP,PTYPE
          IF        @EQUAL
            MOVE      SP70,SAVEPTYP
          ELSE
            ADD       ONE,FORM2
          ENDIF
.
          MATCH     SAVEABRG,PMPXABRG
          IF        @EQUAL
            MOVE      SP70,SAVEABRG
          ELSE
            ADD       ONE,FORM2
          ENDIF
.
.
          MATCH     "P1",PTCNEMPL
          IF        @EQUAL
            MATCH     SAVEUSR7,PUSR1
            IF        @EQUAL
              MOVE      SP70,SAVEUSR7
            ELSE
              ADD       ONE,FORM2
            ENDIF
          ENDIF
.
          MATCH     "P2",PTCNEMPL
          IF        @EQUAL
            MATCH     SAVEUSR7,PUSR2
            IF        @EQUAL
              MOVE      SP70,SAVEUSR7
            ELSE
              ADD       ONE,FORM2
            ENDIF
          ENDIF
.
          MATCH     "P3",PTCNEMPL
          IF        @EQUAL
            MATCH     SAVEUSR7,PUSR3
            IF        @EQUAL
              MOVE      SP70,SAVEUSR7
            ELSE
              ADD       ONE,FORM2
            ENDIF
          ENDIF
.
          MATCH     "P4",PTCNEMPL
          IF        @EQUAL
            MATCH     SAVEUSR7,PUSR4
            IF        @EQUAL
              MOVE      SP70,SAVEUSR7
            ELSE
              ADD       ONE,FORM2
            ENDIF
          ENDIF
.
          MATCH     "P5",PTCNEMPL
          IF        @EQUAL
            MATCH     SAVEUSR7,PUSR5
            IF        @EQUAL
              MOVE      SP70,SAVEUSR7
            ELSE
              ADD       ONE,FORM2
            ENDIF
          ENDIF
.
          MATCH     "P6",PTCNEMPL
          IF        @EQUAL
            MATCH     SAVEUSR7,PUSR6
            IF        @EQUAL
              MOVE      SP70,SAVEUSR7
            ELSE
              ADD       ONE,FORM2
            ENDIF
          ENDIF
.
.
          MATCH     SAVEMEDI,PMEDI
          IF        @EQUAL
            MOVE      SP70,SAVEMEDI
          ELSE
            ADD       ONE,FORM2
          ENDIF
.
          MATCH     SAVEMCCD,PTMXMCCD
          IF        @EQUAL
            MOVE      SP70,SAVEMCCD
          ELSE
            ADD       ONE,FORM2
          ENDIF
.
          MATCH     SAVEMEDC,PMPXMEDC
          IF        @EQUAL
            MOVE      SP70,SAVEMEDC
          ELSE
            ADD       ONE,FORM2
          ENDIF
.
          MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MATCH     SAVEUPRF,PMPXUPRF
            IF        @EQUAL
              MOVE      SP70,SAVEUPRF
            ELSE
              ADD       ONE,FORM2
            ENDIF
          ELSE
            MATCH     SAVECONP,PMPXCONP
            IF        @EQUAL
              MOVE      SP70,SAVECONP
            ELSE
              ADD       ONE,FORM2
            ENDIF
          ENDIF
.
          COMPARE    ZERO,FORM2
          IF         @EQUAL
            GOTO       SJGAU260
          ENDIF
.
. Write out changes data for type 007
.
SJGAU257  MOVE      "007",D3
          CALL      WDAU0000
.
SJGAU260  MOVE      ZERO,FORM2
.
          PACK      PMPXINTR,PMPXINTR,SP70
          PACK      PMPXLNG1,PMPXLNG1,SP70
          PACK      PMPXPRVI,PMPXPRVI,SP70
          PACK      PMPXFLDR,PMPXFLDR,SP70
          PACK      PMPXSN16,PMPXSN16,SP70
.
          MATCH     SAVEINTR,PMPXINTR
          IF        @EQUAL
            MOVE      SP70,SAVEINTR
          ELSE
            ADD       ONE,FORM2
          ENDIF
.
          MATCH     SAVELNG1,PMPXLNG1
          IF        @EQUAL
            MOVE      SP70,SAVELNG1
          ELSE
            ADD       ONE,FORM2
          ENDIF
.
          MATCH     SAVEPRVI,PMPXPRVI
          IF        @EQUAL
            MOVE      SP70,SAVEPRVI
          ELSE
            ADD       ONE,FORM2
          ENDIF
.
          MATCH     SAVEFLDR,PMPXFLDR
          IF        @EQUAL
            MOVE      SP70,SAVEFLDR
          ELSE
            ADD       ONE,FORM2
          ENDIF
.
          MATCH     SAVESN16,PMPXSN16
          IF        @EQUAL
            MOVE      SP70,SAVESN16
          ELSE
            MATCH     SP70,SAVESN16
            IF        @EQUAL
              MOVE      NINE,SAVESN16
            ENDIF
            ADD       ONE,FORM2
          ENDIF
.
          MATCH     SAVEUSR1,PUSR1
          IF        @EQUAL
            MOVE      SP70,SAVEUSR1
          ELSE
            ADD      ONE,FORM2
          ENDIF
.
          MATCH     SPPXUCC4,PMPXUCC4
          IF        @EQUAL
            MOVE      SP70,SPPXUCC4
          ELSE
            ADD       ONE,FORM2
          ENDIF
.
          MATCH     SPPXUCC5,PMPXUCC5
          IF        @EQUAL
            MOVE      SP70,SPPXUCC5
          ELSE
            ADD       ONE,FORM2
          ENDIF
.
          MATCH     SPPXATF1,PMPXATF1
          IF        @EQUAL
            MOVE      SP70,SPPXATF1
          ELSE
            ADD       ONE,FORM2
          ENDIF
.
          MATCH     SPPXATF2,PMPXATF2
          IF        @EQUAL
            MOVE      SP70,SPPXATF2
          ELSE
            ADD       ONE,FORM2
          ENDIF
.
          COMPARE   ZERO,FORM2
          IF        @EQUAL
            GOTO      SJGAU299
          ENDIF
.
SJGAU267  MOVE      "008",D3
          CALL      WDAU0000
.
SJGAU299  RETURN
.
.------------------------------------------------------------------------------
. Write out death audit for type 3
.------------------------------------------------------------------------------
WAUDT300  MOVE      ZERO,FORM2
.
          MATCH     SAVEPHCP,PMPXRHC1
          IF        @EQUAL
            MOVE      SP70,SAVEPHCP
          ELSE
            ADD       ONE,FORM2
          ENDIF
.
          MATCH     SAVEPRAC,PMPXRH1G
          IF        @EQUAL
            MOVE      SP70,SAVEPRAC
          ELSE
            ADD       ONE,FORM2
          ENDIF
.
          MATCH     SAVEPCTR,PMPXR1GC
          IF        @EQUAL
            MOVE      SP70,SAVEPCTR
          ELSE
            ADD       ONE,FORM2
          ENDIF
.
          COMPARE   ZERO,FORM2
          IF        @EQUAL
            GOTO      WAUDT399
          ENDIF
.
WAUDT380  MOVE      "003",D3
          CALL      WDAU0000
.
WAUDT399  RETURN
.
.------------------------------------------------------------------------------
. Write out death audit for type 8
.------------------------------------------------------------------------------
WAUDT800  MOVE      ZERO,FORM2
.
          MOVE      SP70,SAVEINTR
          MOVE      SP70,SAVELNG1
          MOVE      SP70,SAVEPRVI
          MOVE      SP70,SAVEFLDR
          MOVE      SP70,SAVESN16
          MOVE      SP70,SAVEUSR1
.
          MATCH     SPPXUCC4,PMPXUCC4 
          IF        @EQUAL
            MOVE      SP70,SPPXUCC4
          ELSE
            ADD       ONE,FORM2
          ENDIF
.
          MATCH     SPPXUCC5,PMPXUCC5
          IF        @EQUAL
            MOVE      SP70,SPPXUCC5
          ELSE
            ADD       ONE,FORM2
          ENDIF
.
          MATCH     SPPXATF1,PMPXATF1
          IF        @EQUAL
            MOVE      SP70,SPPXATF1
          ELSE
            ADD       ONE,FORM2
          ENDIF
.
          MATCH     SPPXATF2,PMPXATF2
          IF        @EQUAL
            MOVE      SP70,SPPXATF2
          ELSE
            ADD       ONE,FORM2
          ENDIF
.
          COMPARE   ZERO,FORM2
          IF        @EQUAL
            GOTO      WAUDT899
          ENDIF
.
WAUDT880  MOVE      "008",D3
          CALL      WDAU0000
.
WAUDT899  RETURN
+
.******************************************************************************
.*                SJOG PMI Audits Save Variables                              *
.******************************************************************************
SJGSAV00  MATCH     "1",SJOGAUDT
          IF        @EQUAL
            PACK      SAVESNAM,PTMASNAM,SP70
            PACK      SAVEXFNM,PGNAME,SP70
            PACK      SAVEXSNM,PMPXSNAM,SP70
            PACK      SAVETITL,PTITL,SP70
            PACK      SAVEPSEX,PSEX,SP70
            PACK      SAVEPDOB,PBDATE,SP70
            PACK      SAVEPFGN,PMPXPFGN,SP70
            PACK      SAVEPMST,PMSTAT,SP70
            PACK      SAVEPREG,PREG,SP70
            PACK      SAVEPCNT,PCONT,SP70
            PACK      SAVEPTYP,PTYPE,SP70
            PACK      SAVEABRG,PMPXABRG,SP70
.
.
            MATCH     "P1",PTCNEMPL
            IF        @EQUAL
              PACK      SAVEUSR7,PUSR1,SP70
            ENDIF
            MATCH     "P2",PTCNEMPL
            IF        @EQUAL
              PACK      SAVEUSR7,PUSR2,SP70
            ENDIF
            MATCH     "P3",PTCNEMPL
            IF        @EQUAL
              PACK      SAVEUSR7,PUSR3,SP70
            ENDIF
            MATCH     "P4",PTCNEMPL
            IF        @EQUAL
              PACK      SAVEUSR7,PUSR4,SP70
            ENDIF
            MATCH     "P5",PTCNEMPL
            IF        @EQUAL
              PACK      SAVEUSR7,PUSR5,SP70
            ENDIF
            MATCH     "P6",PTCNEMPL
            IF        @EQUAL
              PACK      SAVEUSR7,PUSR6,SP70
            ENDIF
            MATCH     "U1",PTCNEMPL
            IF        @EQUAL
              PACK      SAVEUSR7,SP70
            ENDIF
            MATCH     "U2",PTCNEMPL
            IF        @EQUAL
              PACK      SAVEUSR7,SP70
            ENDIF
            MATCH     "U3",PTCNEMPL
            IF        @EQUAL
              PACK      SAVEUSR7,SP70
            ENDIF
            MATCH     "U4",PTCNEMPL
            IF        @EQUAL
              PACK      SAVEUSR7,SP70
            ENDIF
            MATCH     "U5",PTCNEMPL
            IF        @EQUAL
              PACK      SAVEUSR7,SP70
            ENDIF
            MATCH     "U6",PTCNEMPL
            IF        @EQUAL
              PACK      SAVEUSR7,SP70
            ENDIF
            MATCH     "U7",PTCNEMPL
            IF        @EQUAL
              PACK      SAVEUSR7,SP70
            ENDIF
.
.
            PACK      SAVEMEDI,PMEDI,SP70
            PACK      SAVEUSR1,PUSR1,SP70
            PACK      SAVEMCCD,PTMXMCCD,SP70
            PACK      SAVEMEDC,PMPXMEDC,SP70
.
            MATCH     "1",PTCNNEWC
            IF        @EQUAL
              PACK      SAVEUPRF,PMPXUPRF,SP70
            ELSE
              PACK      SAVECONP,PMPXCONP,SP70
            ENDIF
.
            PACK      SAVEINTR,PMPXINTR,SP70
            PACK      SAVELNG1,PMPXLNG1,SP70
            PACK      SAVEPRVI,PMPXPRVI,SP70
            PACK      SAVEFLDR,PMPXFLDR,SP70
            PACK      SAVESN16,PMPXSN16,SP70
            PACK      SAVECUID,PTMADCUU,SP70
            PACK      SAVECDAT,PTMADCUD,SP70
            PACK      SAVECTIM,PTMADCUT,SP70
            PACK      SAVEDCDT,PTMADCDT,SP70
          ENDIF
.
SJGSAV90  PACK      SPPXUCC4,PMPXUCC4,SP70
          PACK      SPPXUCC5,PMPXUCC5,SP70
          PACK      SPPXATF1,PMPXATF1,SP70
          PACK      SPPXATF2,PMPXATF2,SP70
.
SJGSAV99  RETURN
+
.-----------------------------------------------------------
. Write EDWARD IP visit alteration record
. requires : ALTTYPE
.            ADMISSNO
.            ALTOLDVL
.            ALTNEWVL
.------------------------------------------------------------
WEAL0000  MATCH     SP70,PTCNNSSI        * no edward source system
          GOTO      WEAL9999 IF EQUAL
.
          MATCH     ZERO20,PTCNNSSI        * no edward source system
          GOTO      WEAL9999 IF EQUAL
.
          OPEN      PMSADWA1,"pmsadwaf"
.
          MOVE      ADMISSNO,PMAWVISN
          MOVE      ALTTYPE,PMAWTYPE
          PACK      PMAWOLDV,ALTOLDVL,SP70,SP70,SP70,SP70
          PACK      PMAWNEWV,ALTNEWVL,SP70,SP70,SP70,SP70
.
          CALL      IBACLOCK
          PACK      PMAWCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMAWCDAT
          MOVE      "00:00:00",PMAWCTIM
          PACK      PMAWCUID,USERID
          PACK      PMAWSPAR,SP70,SP70
.
          PACK      KEY27,PMAWCDAT,PMAWCTIM,PMAWVISN,PMAWTYPE,SP70
          CALL      RAPMADW1
          IF        OVRCD=1
            CALL      WRPMADW1
          ELSE
            CALL      UPPMADW1
          ENDIF
.
WEAL9999  CLOSE     PMSADWA1
          RETURN
.
.------------------------------------------------------------
. Display Preadmission Notes
.------------------------------------------------------------
WTPACM00  CLOSE     PRSPMIA1
          OPEN      WATPACA1,"watpacaf"   
          PACK      KEY21,BKREURNO,BKREPROC,DBKRECNT,SP70
          CALL      RSWTPAC1
WTPACM10  CALL      RKWTPAC1
          BRANCH    OVRCD,WTPACM98
          MATCH     BKREURNO,WTPCURNO
          GOTO      WTPACM98 IF NOT EQUAL
          MATCH     BKREPROC,WTPCPCOD
          GOTO      WTPACM98 IF NOT EQUAL
          MATCH     DBKRECNT,WTPCPCNT
          GOTO      WTPACM10 IF NOT EQUAL
          STRIP     WTPCCOMM
          MOVELPTR  WTPCCOMM,F3
          IF        F3>0
            SFORMAT   VAR,F3
          ELSE
            SFORMAT   VAR,1
          ENDIF
          MOVE      WTPCCOMM,VAR
          WRITE     HTMLFILE;VAR
          SFORMAT   VAR,127
.
          GOTO      WTPACM10
.
WTPACM98  CLOSE     WATPACA1
          OPEN      PRSPMIA1,"prspmiaf"
.
WTPACM99  RETURN
+
.------------------------------------------------------------
. SBED0000 - Validate the new Ward/Bed before performing stat discharge
. Returns:   EXIT  0 = Ok to continue
.                  1 = Error
.------------------------------------------------------------
.
.         validate the Ward keyed in against the Ward file
SBED0000  PACK      PTMIS004,PTMIS004,SP70
          PACK      PTMIS005,PTMIS005,SP70
          PACK      KEY6,PTMIS004,SP3
          CALL      RDWARD1
          BRANCH    OVRCD,SBED9800                * Ward doesn't exist
.
          BRANCH    WACTIVE,SBED9810              * Ignore non-active wards
.
          IF        WINPUT=1
            MOVE      SP3,PTMIS005                * Ward only input, clear bed
            GOTO      SBED9999
          ENDIF
          IF        WINPUT=2
            MATCH     SP3,PTMIS005
            GOTO      SBED9999 IF EQUAL
          ENDIF
.
. validate the Ward and Bed keyed in against the Ward file
.
          PACK      KEY6,PTMIS004,PTMIS005
          CALL      RDWARD1
          BRANCH    OVRCD,SBED9800
.
          BRANCH    WACTIVE,SBED9820              * Ignore non-active wards
.
          MATCH     ZEROVISN,WSTBY                * another pat. on standby?
          GOTO      SBED9830 IF NOT EQUAL         * No.
.
          IF        WINPUT=0
            MATCH     SP70,PTMIS005               * Invalid Bed
            GOTO      SBED9840 IF EQUAL
          ENDIF
.
          GOTO      SBED9999
.
SBED9800  MOVE      "Ward/Bed Does Not Exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SBED9999
.
SBED9810  MOVE      "Ward is Not Active",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SBED9999
.
SBED9820  MOVE      "Bed is Not Active",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SBED9999
.
SBED9830  CLEAR     WEBTITLE
          APPEND    "The Bed is Already on Standby for Adm ",WEBTITLE
          APPEND    WSTBY,WEBTITLE
          APPEND    " & Cannot be Used",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SBED9999
.
SBED9831  CLEAR     WEBTITLE
          APPEND    "Patient already admitted to this Bed",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SBED9999
.
SBED9840  MOVE      "Invalid Bed",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      SBED9999
.
SBED9999  RETURN
+
.------------------------------------------------------------
. Check if the no bed file baby PLURARITY needs to be updated
.------------------------------------------------------------
NOBD0000  MATCH     Z70,PTMIS036            * Admission baby
          GOTO      NOBD9999 IF EQUAL       * plurality of baby
.
          COMPARE   TWO,ASTAT               * Current IP
          GOTO      NOBD9999 IF NOT EQUAL
.
          PACK      KEY6,AWARD,SP70
          CALL      RDWARD1                 * Read ward
          BRANCH    OVRCD,NOBD9999
.
          COMPARE   ZERO,WINPUT             * Ward/Bed Type
          GOTO      NOBD9999 IF EQUAL
.
          MATCH     SP70,ABED               * Is the patient
          GOTO      NOBD9999 IF NOT EQUAL   * in a bed
.
          PACK      KEY13,AWARD,AADMNO,APLUR,SP70
          CALL      RDNOBE1
          IF        OVRCD<>1
            GOTO      NOBD9999              * Exit no bed file
          ENDIF                             * record found
.
          PACK      KEY13,AWARD,AADMNO,SP70
          CALL      RDSNOBE1
          CALL      RDKNOBE1                * Find no bed record
          BRANCH    OVRCD,NOBD9999
.
          MATCH     AWARD,NBWARD            * Correct ward
          GOTO      NOBD9999 IF NOT EQUAL
.
          MATCH     AADMNO,NBADMNO          * Correct admission
          GOTO      NOBD9999 IF NOT EQUAL   * number
.
          PACK      KEY13,NBWARD,NBADMNO,NBPLUR,SP70
          CALL      DENOBE1                 * Delete old no bed record
.
          MOVE      APLUR,NBPLUR            * Set new baby plurarity value
.
          PACK      KEY13,NBWARD,NBADMNO,NBPLUR,SP70
          CALL      RANOBE1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            CALL      WRNOBE1               * Write new no bed record
            TRAPCLR   IO
          ENDIF
.
NOBD9999  RETURN
+
.*******************************************************************************
.         Generate OECW Request
.*******************************************************************************
REWOEC00  MATCH     "1",PTCNWSIN
          GOTO      REWOEC99 IF NOT EQUAL
.
          MATCH     "1",PTCNOECW
          GOTO      REWOEC99 IF NOT EQUAL
.
          MATCH     SP70,ADMISSNO
          IF        @EQUAL | @EOS
            GOTO      REWOEC99              * Exit no admission number
          ENDIF
.
          CLOSE     PMSOECA1
          CLOSE     PMSOESA1          
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      WEBELFA1,"webelfaf"
          TRAPCLR   IO
          BRANCH    OVRCD,REWOEC99
          CLOSE     WEBELFA1
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO 
          OPEN      WEBOECA1,"weboecaf"
          TRAPCLR   IO
          BRANCH    OVRCD,REWOEC99
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      WEBOESA1,"weboesaf"
          TRAPCLR   IO
          BRANCH    OVRCD,REWOEC99
.
          CALL      GNWOEC00
          CALL      CLWEBOEC              
          CALL      UPWBOC00
.
          MOVE      ADMISSNO,WBOCVISN
          MOVE      KEY3,WBOCCNTR
          MOVE      " 0",WBOCSTAT
          MOVE      URNUMBER,WBOCURNO
          MOVE      ADMISSNO,WBOCARID
          PACK      WBOCARID,WBOCARID,SP70
          LJUSTIFY  WBOCARID
          MOVE      SP70,WBOCTRID
          CALL      IBACLOCK
          PACK      WBOCRQDT,CCC,CYY,CMM,CDD
          REP       " 0",WBOCRQDT
          MOVE      SP70,WBOCETYP
          MOVE      SP70,WBOCERRC
          MOVE      SP70,WBOCERRD
          PACK      WBOCCDTE,CCC,CYY,CMM,CDD
          REP       " 0",WBOCCDTE
          CLOCK     TIME,CTIMEIS
          MOVE      CTIMEIS,WBOCCTIM
          MOVE      SP70,WBOCUDTE
          MOVE      SP70,WBOCUTIM
          MOVE      SP70,WBOCHOSP
          MOVE      SP70,WBOCELEG
          MOVE      SP70,WBOCMSID
.
          MOVE      USERID,WBOCCUID
          MOVE      SP70,WBOCUUID
.
          IF        IBCNMHOS=1
            PACK      KEY8,ADMISSNO,SP70     * Update pmsvx1af.pmvxpoec
            CALL      RDPMVX11               * OEC Consent
            IF        OVRCD=0
              MOVE      PMVXMHOS,WBOCHOSP
            ENDIF
          ENDIF
.
          PACK      KEY11,WBOCVISN,WBOCCNTR,SP70
          CALL      RAWBOEC1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO

            CALL      IBACLOCK
            PACK      WBOCUDTE,CCC,CYY,CMM,CDD
            REP       " 0",WBOCUDTE
            MOVE      CTIMEIS,WBOCUTIM
            MOVE      USERID,WBOCUUID
            CALL      WRWBOEC1

            TRAPCLR   IO
            BRANCH    OVRCD,REWOEC00
          ELSE
            GOTO      REWOEC00
          ENDIF
.
          MOVE      ONE,F2A
          MOVE      ONE,F2                * Write new pmsoesaf record
          WHILE     F2 <= 5
            CALL      CLWEBOES
            CALL      UPWBOS00
.
            MATCH     SP70,WBOSITEM
            GOTO      REWOEC60 IF EQUAL
            GOTO      REWOEC60 IF EOS
.
            MOVE      ADMISSNO,WBOSVISN
            MOVE      WBOCCNTR,WBOSCNTR
            MOVE      F2A,WBOSSCNT
            PACK      WBOSSCNT,WBOSSCNT,SP70
            RJUSTIFY  WBOSSCNT
            CALL      IBACLOCK
            PACK      WBOSCDTE,CCC,CYY,CMM,CDD
            REP       " 0",WBOSCDTE
            CLOCK     TIME,CTIMEIS
            MOVE      CTIMEIS,WBOSCTIM
.
            PACK      KEY14,ADMISSNO,WBOSCNTR,WBOSSCNT,SP70
            CALL      RAWBOES1
            IF        OVRCD=1
              CALL      WRWBOES1
            ELSE
              CALL      UPWBOES1
            ENDIF
.
            ADD       ONE,F2A
REWOEC60    ADD       ONE,F2
          DO
.
.         MOVE      "Online Eligibility Check Request Generated.",WEBTITLE
.
.         IF        WARCOUNT <= 11
.           ADD       ONE,WARCOUNT
.           MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
.         ENDIF
.
          MOVE      ONE,OECREQIN
.
          CALL      HOEW0000
.
REWOEC99  CLOSE     WEBOECA1
          CLOSE     WEBOESA1
.
          OPEN      PMSOECA1,"pmsoecaf"
          OPEN      PMSOESA1,"pmsoesaf"
.
          RETURN
+
.*******************************************************************************
.        Get Next weboecaf report counter
.*******************************************************************************
GNWOEC00  MOVE      "  1",KEY3
          PACK      KEY11,ADMISSNO,Z70
          CALL      RSWBOEC1
          CALL      RPWBOEC1
          BRANCH    OVRCD,GNWOEC99
.
          MATCH     ADMISSNO,WBOCVISN
          GOTO      GNWOEC99 IF NOT EQUAL
.
          MOVE      ZERO,FORM3
          SQUEEZE   WBOCCNTR
          MOVE      WBOCCNTR,FORM3
.
          ADD       ONE,FORM3
          MOVE      FORM3,KEY3
.
GNWOEC99  RETURN
+
.---------------------------------------------------------------
. Write OECW History Record to webelfaf (OECW Free Format table)
.---------------------------------------------------------------
HOEW0000  OPEN      WEBELFA1,"webelfaf"
.
          CALL      CLWEBELF
.
          PACK      SAVKEY11,WBOCVISN,WBOCCNTR,SP70
.
HOEW1000  CALL      GELW0000           * Generate Eligibility Number
          BRANCH    GELWFLAG,HOEW9999
.
          MOVE      SAVKEY11,KEY11
          CALL      RDWBOEC1
.
          MOVE      WBOCURNO,WBEFURNO
          MOVE      ZERO,WBEFOECC
          MOVE      PTITL,WBEFTITL
          PACK      WBEFFNAM,PMPXFNAM,SP70
          PACK      WBEFSNAM,PTMASNAM,SP70
          MOVE      SP70,WBEFHFGN
          MOVE      SP70,WBEFHFSN
          MOVE      PSEX,WBEFGEND
          MOVE      PBDATE,WBEFBDAT
          MOVE      PTMIS001,WBEFEADT
          MOVE      SP70,WBEFISTY
          MATCH     PTVIS043,Z70
          IF        !@EQUAL
            MOVE      PTVIS043,WBEFISTY
          ENDIF
          MOVE      PTMIS030,WBEFPLOS
          MOVE      PTVIS076,WBEFDINT
          MOVE      PTELSPEA,WBEFPEAI
          MOVE      PTELEADM,WBEFEMAD
.
          MOVE      SP70,WBEFPRIC
          MATCH     PTVIS111,Z70
          IF        !@EQUAL
            MOVE      PTVIS111,WBEFPRIC
          ENDIF
.
          MOVE      SP70,WBEFPRIM
          MATCH     PTMIS026,Z70
          IF        !@EQUAL
            MOVE      PTMIS026,WBEFPRIM
          ENDIF
.
          MOVE      PTMIS027,WBEFCLTY
          MOVE      PTMIS013,WBEFHFND
          MOVE      PTMIS014,WBEFHFNT
          MOVE      PTMIS015,WBEFHFMN
          MOVE      PTMIS020,WBEFDIAG
.
          MOVE      SP70,WBEFSRV1
          PACK      KEY14,WBOCVISN,WBOCCNTR,SP1,SP1,ONE,SP70
          CALL      RDWBOES1
          IF        OVRCD=0
            MOVE      WBOSITEM,WBEFSRV1
          ENDIF
.
          MOVE      SP70,WBEFSRV2
          PACK      KEY14,WBOCVISN,WBOCCNTR,SP1,SP1,TWO,SP70
          CALL      RDWBOES1
          IF        OVRCD=0
            MOVE      WBOSITEM,WBEFSRV2
          ENDIF
.
          MOVE      SP70,WBEFSRV3
          PACK      KEY14,WBOCVISN,WBOCCNTR,SP1,SP1,THREE,SP70
          CALL      RDWBOES1
          IF        OVRCD=0
            MOVE      WBOSITEM,WBEFSRV3
          ENDIF
.
          MOVE      SP70,WBEFSRV4
          PACK      KEY14,WBOCVISN,WBOCCNTR,SP1,SP1,FOUR,SP70
          CALL      RDWBOES1
          IF        OVRCD=0
            MOVE      WBOSITEM,WBEFSRV4
          ENDIF
.
          MOVE      SP70,WBEFSRV5
          PACK      KEY14,WBOCVISN,WBOCCNTR,SP1,SP1,FIVE,SP70
          CALL      RDWBOES1
          IF        OVRCD=0
            MOVE      WBOSITEM,WBEFSRV5
          ENDIF
.
          MOVE      WBSEUID,WBEFCUID
          CALL      IBACLOCK
          PACK      WBEFCDAT,CCC,CYY,CMM,CDD
          REP       " 0",WBEFCDAT
          CLOCK     TIME,CTIMEIS
          MOVE      CTIMEIS,WBEFCTIM
.
          CALL      CNCW0000                       * DVA conc card on file ?
          IF        EXIT=1
            PACK      WBEFDVAN,PREPAT,SP20         * No
          ELSE
            MOVE      DIM20,WBEFDVAN               * yes
          ENDIF
.
          MOVE      WBOCVISN,WBEFVISN
          MOVE      WBOCCNTR,WBEFCNTR
          MOVE      ZERO,WBEFFLAG
          MOVE      SP70,WBEFTRID
          MOVE      SP70,WBEFMSID
          PACK      WBEFSPAR,SP70,SP70
.
          PACK      KEY8,WBEFELGN,SP70
          CALL      RAWBELF1
          IF        OVRCD=0
            GOTO      HOEW1000
          ENDIF
.
          CALL      WRWBELF1
.
          PACK      KEY11,WBOCVISN,WBOCCNTR,SP70
          CALL      RDWBOEC1
          IF        OVRCD=0
            MOVE      WBEFELGN,WBOCELEG
            CALL      IBACLOCK
            PACK      WBOCUDTE,CCC,CYY,CMM,CDD
            REP       " 0",WBOCUDTE
            MOVE      CTIMEIS,WBOCUTIM
            MOVE      USERID,WBOCUUID

            CALL      UPWBOEC1
          ENDIF
.
HOEW9999  CLOSE     WEBELFA1
.
          RETURN
+
.-----------------------------------------------------------
.        Generate Free Format OECW Eligibility Number
.-----------------------------------------------------------
GELW0000  MOVE      ZERO,GELWFLAG
.
          MOVE      "118",PRXCODE
          CALL      GETSLK00
          READ      CONTROLF,HUND18;*117,PTCNELGN
.
GELW0100  MOVE      PTCNELGN,WBEFELGN
          UNPACK    PTCNELGN,ANS,KEY7
          MATCH     "a",ANS
          GOTO      GELW1150 IF LESS
          MOVE      ZERO,F7
          MOVE      KEY7,F7
.
GELW1100  COMPARE   "9999999",F7               * at the end of the group
          GOTO      GELW1110 IF NOT EQUAL
.
          MATCH     "z",ANS
          GOTO      GELW9000 IF EQUAL
.
          REP       REPUNIQ,ANS
          MOVE      ZERO,F7
.
GELW1110  ADD       ONE,F7
          MOVE      F7,D7
          REP       " 0",D7
.
          PACK      KEY8,ANS,D7,SP70
          CALL      RAWBELF1
          IF        OVRCD=ONE
            PACK      KEY11,ANS,D7,SP1,SP1,ONE,SP70
            CALL      RAWBOEC1
            IF        OVRCD=ONE
              PACK      KEY14,ANS,D7,SP1,SP1,ONE,SP70
              CALL      RSWBOES1
              CALL      RKWBOES1
              BRANCH    OVRCD,GELW9500
.
              PACK      KEY8,ANS,D7,SP70
              MATCH     KEY8,WBOSVISN
              GOTO      GELW9500 IF NOT EQUAL
            ENDIF
          ENDIF
.
          GOTO      GELW1100
.
. no records
.
GELW1150  MOVE      ONE,F7
          MOVE      "a",ANS
.
          MOVE      F7,D7
          REP       " 0",D7
.
          PACK      KEY8,ANS,D7,SP70
          GOTO      GELW9500
.
GELW9000  MOVE      ONE,GELWFLAG                  * Passcode allocation full
          GOTO      GELW9999
.
GELW9500  MOVE      KEY8,PTCNELGN
          WRITAB    CONTROLF,HUND18;*117,PTCNELGN
.
          MATCH     "00000000",WBEFELGN
          GOTO      GELW0100 IF EQUAL
.
GELW9999  CALL      RELSLK00
          RETURN
+
.*****************************************************************************
.*                              CNCW0000           Called by: WPAT0000       *
.*     See if the patient has concession card of DVA type on file            *
.* Requires: PURNO - U/R number                                              *
.* Returns:  EXIT  0 = valid concession card found                           *
.*                 1 = no valid concession card found                        *
.*           DIM20 - Concession Card Number                                  *
.*****************************************************************************
.
CNCW0000  CLOSE     WEBELFA1
          OPEN      PMSCCDA1,"pmsccdaf"
.
          PACK      KEY19,PURNO,TILDA40
          CALL      RSPMCCD1                     * position on U/R
CNCW0500  CALL      RPPMCCD1                     * read previous record
          BRANCH    OVRCD,CNCW9100               * eof - nothing found
.
          MATCH     PURNO,PMCDURNO               * same U/R still ?
          GOTO      CNCW9100 IF NOT EQUAL        * no - nothing found
.
.         Check if the card type is DVA (Cat ct, Indicator 1)
.
          PACK      KEY5,CATCT,PMCDCTYP
          CALL      RDCODE1                      * code on file ?
          BRANCH    OVRCD,CNCW0500               * no - ignore record
.
          MATCH     SP1,TCINDC1                  * blank indicator 1 ?
          GOTO      CNCW0500 IF EQUAL            * yes - ignore record
.
          TYPE      TCINDC1                      * numeric indicator 1 ?
          GOTO      CNCW0500 IF NOT EQUAL        * no - ignore record
.
          MATCH     "3",TCINDC1                  * DVA card type ?
          GOTO      CNCW0500 IF NOT EQUAL        * no - ignore record
.
.         A DVA concession card has been found, so check
.         if there is an expiry date
.
          MATCH     SP8,PMCDEXDT                 * expiry date blank ?
          GOTO      CNCW1000 IF EQUAL            * yes - assume valid
.
.         There is an expiry date for the card, so check that the
.         card is current
.
          CALL      IBACLOCK
          PACK      DIM8,CCC,CYY,CMM,CDD
          REP       " 0",DIM8
.
          MATCH     DIM8,PMCDEXDT                * card valid for date ?
          GOTO      CNCW9100 IF LESS             * no - nothing found
.
.         Concession card is current
.
CNCW1000  MATCH     SP20,PMCDCNUM                * card number blank ?
          GOTO      CNCW9100 IF EQUAL            * yes - nothing found
.
          MOVE      PMCDCNUM,DIM20               * load concession card number
.
          MOVE      ZERO,CNCWFLAG
          GOTO      CNCW9999
.
CNCW9100  MOVE      ONE,CNCWFLAG
.
CNCW9999  CLOSE     PMSCCDA1
          OPEN      WEBELFA1,"webelfaf"
          RETURN
+
.*****************************************************************************
.* Dummy Label for PREADCAN                                                  *
.*****************************************************************************
INTINP00  RETURN
+
.*******************************************************************************
.        Eclipse OEC-ECM
.*******************************************************************************
ECLOEM00    MOVE      ZERO,OECREQIN
.
            MATCH     "1",PTVIS109            * if oec indicator = 1
            IF        @EQUAL
              MOVE      ADMISSNO,KEY8
              CALL      RDPTELG1
              IF        OVRCD=1
                CALL      CLPATELG              * Write new patelgaf record
                CALL      UPELG000
                MOVE      ADMISSNO,PTELVISN
                CALL      WRPTELG1
              ELSE
                CALL      UPELG000
                CALL      UPPTELG1
              ENDIF
.
              MOVE      SP70,SAVFPRIM
.             CALL      REQOEC00                 * OEC Request
              CALL      REWOEM00
.              PACK      SAVFPRIM,PTMIS026,SP70   * save
.
.              MATCH     SP70,OECEPROV
.              IF        !@EQUAL & !@EOS
.                MOVE      EXTRPROV,PTMIS026
.                CALL      REQOEC00            * OEC Request
.                CALL      REWOEC00
.              ENDIF
..
.              MATCH     SP70,OECEPRV2
.              IF        !@EQUAL & !@EOS
.                MOVE      EXTRPRV2,PTMIS026
.                CALL      REQOEC00            * OEC Request
.                CALL      REWOEC00
.              ENDIF
..
.              MATCH     SP70,OECEPRV3
.              IF        !@EQUAL & !@EOS
.                MOVE      EXTRPRV3,PTMIS026
.                CALL      REQOEC00            * OEC Request
.                CALL      REWOEC00
.              ENDIF
..
.              PACK      EXTRPRV4,EXTRPRV4,SP70
.              MATCH     SP70,EXTRPRV4
.              IF        !@EQUAL & !@EOS
.                MOVE      EXTRPRV4,PTMIS026
.                CALL      REQOEC00            * OEC Request
.                CALL      REWOEC00
.              ENDIF
..
.              PACK      EXTRPRV5,EXTRPRV5,SP70
.              MATCH     SP70,EXTRPRV5
.              IF        !@EQUAL & !@EOS
.                MOVE      EXTRPRV5,PTMIS026
.                CALL      REQOEC00            * OEC Request
.                CALL      REWOEC00
.              ENDIF
..
.              MOVE      ONE,CNTITEM
.              WHILE     CNTITEM<=LASTITEM
.                MATCH     SP70,OECMB[CNTITEM]
.                IF        !@EQUAL
.                  PACK      KEY13,MCNTR[CNTITEM],SP70
.                  CALL      RDOPMBS1
.                  IF        OVRCD=0
.                    MOVE      OPMBMBSI,PTMIS026
.                    CALL      REQOEC00            * OEC Request
.                    CALL      REWOEC00
.                  ENDIF
.                ENDIF
.                ADD       ONE,CNTITEM
.              DO
.              MOVE      SAVFPRIM,PTMIS026       * restore
.
            ENDIF
.
            IF        OECREQIN = ONE
              MOVE      "Eligibility Check Medicare Request Generated.",WEBTITLE
.
              IF        WARCOUNT <= 11
                ADD       ONE,WARCOUNT
                MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
              ENDIF
            ENDIF
.
ECLOEM99  RETURN
+
.*******************************************************************************
.         Generate OECW-ECM Request
.*******************************************************************************
REWOEM00  MATCH     "1",PTCNWSIN
          GOTO      REWOEM99 IF NOT EQUAL
.
          MATCH     "1",PTCNOECW
          GOTO      REWOEM99 IF NOT EQUAL
.
          CLOSE     PMSOECA1
          CLOSE     PMSOESA1
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      WEBOMFA1,"webomfaf"
          TRAPCLR   IO
          BRANCH    OVRCD,REWOEM99
          CLOSE     WEBOMFA1
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      WEBOEMA1,"weboemaf"
          TRAPCLR   IO
          BRANCH    OVRCD,REWOEM99
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      WEBOMSA1,"webomsaf"
          TRAPCLR   IO
          BRANCH    OVRCD,REWOEM99
.
          CALL      GNWOEM00
          CALL      CLWEBOEM
          CALL      UPWBOM00
.
          MOVE      ADMISSNO,WBOEVISN
          MOVE      KEY3,WBOECNTR
          MOVE      " 0",WBOESTAT
          MOVE      URNUMBER,WBOEURNO
          MOVE      ADMISSNO,WBOEARID
          PACK      WBOEARID,WBOEARID,SP70
          LJUSTIFY  WBOEARID
          MOVE      SP70,WBOETRID
          CALL      IBACLOCK
          PACK      WBOERQDT,CCC,CYY,CMM,CDD
          REP       " 0",WBOERQDT
          MOVE      SP70,WBOEETYP
          MOVE      SP70,WBOEERRC
          MOVE      SP70,WBOEERRD
          PACK      WBOECDTE,CCC,CYY,CMM,CDD
          REP       " 0",WBOECDTE
          CLOCK     TIME,CTIMEIS
          MOVE      CTIMEIS,WBOECTIM
          MOVE      SP70,WBOEUDTE
          MOVE      SP70,WBOEUTIM
          MOVE      SP70,WBOEHOSP
          MOVE      SP70,WBOEELEG
          MOVE      SP70,WBOEMSID
.
          IF        IBCNMHOS=1
            PACK      KEY8,ADMISSNO,SP70     * Update pmsvx1af.pmvxpoec
            CALL      RDPMVX11               * OEC Consent
            IF        OVRCD=0
              MOVE      PMVXMHOS,WBOEHOSP
            ENDIF
          ENDIF
.
          PACK      KEY11,WBOEVISN,WBOECNTR,SP70
          CALL      RAWBOEM1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            CALL      WRWBOEM1
            TRAPCLR   IO
            BRANCH    OVRCD,REWOEM00
          ELSE
            GOTO      REWOEM00
          ENDIF
.
          MOVE      ONE,F2A
          MOVE      ONE,F2                * Write new pmsoesaf record
          WHILE     F2 <= 5
            CALL      CLWEBOMS
            CALL      UPWBMS00
.
            MATCH     SP70,WBOMITMN
            GOTO      REWOEM60 IF EQUAL
            GOTO      REWOEM60 IF EOS
.
            MOVE      ADMISSNO,WBOMVISN
            MOVE      WBOECNTR,WBOMCNTR
            MOVE      F2A,WBOMSCNT
            PACK      WBOMSCNT,WBOMSCNT,SP70
            RJUSTIFY  WBOMSCNT
            CALL      IBACLOCK
            PACK      WBOMCDTE,CCC,CYY,CMM,CDD
            REP       " 0",WBOMCDTE
            CLOCK     TIME,CTIMEIS
            MOVE      CTIMEIS,WBOMCTIM
.
            PACK      KEY14,ADMISSNO,WBOMCNTR,WBOMSCNT,SP70
            CALL      RAWBOMS1
            IF        OVRCD=1
              CALL      WRWBOMS1
            ELSE
              CALL      UPWBOMS1
            ENDIF
.
            ADD       ONE,F2A
REWOEM60    ADD       ONE,F2
          DO
.
.         MOVE      "Online Eligibility Check Request Generated.",WEBTITLE
.
.         IF        WARCOUNT <= 11
.           ADD       ONE,WARCOUNT
.           MOVE      WEBTITLE,WEBWARNG[WARCOUNT]
.         ENDIF
.
          MOVE      ONE,OECREQIN
.
          CALL      HOEM0000
.
REWOEM99  CLOSE     WEBOEMA1
          CLOSE     WEBOMSA1
.
          OPEN      PMSOECA1,"pmsoecaf"
          OPEN      PMSOESA1,"pmsoesaf"
.
          RETURN
+
.-----------------------------------------------------------------------
. Write OECW-ECM History Record to webomfaf (OECW-ECM Free Format table)
.-----------------------------------------------------------------------
HOEM0000  OPEN      WEBOMFA1,"webomfaf"
.
          CALL      CLWEBOMF
.
          PACK      SAVKEY11,WBOEVISN,WBOECNTR,SP70
.
HOEM1000  CALL      GELM0000           * Generate Eligibility Number
          BRANCH    GELWFLAG,HOEM9999
.
          MOVE      SAVKEY11,KEY11
          CALL      RDWBOEM1
.
          MOVE      WBOEURNO,WBOFURNO
          MOVE      ZERO,WBOFOECC
          MOVE      PTITL,WBOFTITL
          PACK      WBOFFNAM,PMPXFNAM,SP70
          PACK      WBOFSNAM,PTMASNAM,SP70
          MOVE      SP70,WBOFHFGN
          MOVE      SP70,WBOFHFSN
          MOVE      PSEX,WBOFGEND
          MOVE      PBDATE,WBOFBDAT
          MOVE      PTMIS001,WBOFEADT
          MOVE      SP70,WBOFISTY
          MATCH     PTVIS043,Z70
          IF        !@EQUAL
            MOVE      PTVIS043,WBOFISTY
          ENDIF
          MOVE      PTMIS030,WBOFPLOS
          MOVE      PTVIS076,WBOFDINT
          MOVE      PTELSPEA,WBOFPEAI
          MOVE      PTELEADM,WBOFEMAD
.
          MOVE      SP70,WBOFPRIC
          MATCH     PTVIS111,Z70
          IF        !@EQUAL
            MOVE      PTVIS111,WBOFPRIC
          ENDIF
.
          MOVE      SP70,WBOFPRIM
          MATCH     PTMIS026,Z70
          IF        !@EQUAL
            MOVE      PTMIS026,WBOFPRIM
          ENDIF
.
          MOVE      PTMIS027,WBOFCLTY
          MOVE      PTMIS013,WBOFHFND
          MOVE      PTMIS014,WBOFHFNT
          MOVE      PTMIS015,WBOFHFMN
          MOVE      PTMIS020,WBOFDIAG
.
          MOVE      SP70,WBOFITM1
          PACK      KEY14,WBOEVISN,WBOECNTR,SP1,SP1,ONE,SP70
          CALL      RDWBOMS1
          IF        OVRCD=0
            MOVE      WBOMITMN,WBOFITM1
          ENDIF
.
          MOVE      SP70,WBOFITM2
          PACK      KEY14,WBOEVISN,WBOECNTR,SP1,SP1,TWO,SP70
          CALL      RDWBOMS1
          IF        OVRCD=0
            MOVE      WBOMITMN,WBOFITM2
          ENDIF
.
          MOVE      SP70,WBOFITM3
          PACK      KEY14,WBOEVISN,WBOECNTR,SP1,SP1,THREE,SP70
          CALL      RDWBOMS1
          IF        OVRCD=0
            MOVE      WBOMITMN,WBOFITM3
          ENDIF
.
          MOVE      SP70,WBOFITM4
          PACK      KEY14,WBOEVISN,WBOECNTR,SP1,SP1,FOUR,SP70
          CALL      RDWBOMS1
          IF        OVRCD=0
            MOVE      WBOMITMN,WBOFITM4
          ENDIF
.
          MOVE      SP70,WBOFITM5
          PACK      KEY14,WBOEVISN,WBOECNTR,SP1,SP1,FIVE,SP70
          CALL      RDWBOMS1
          IF        OVRCD=0
            MOVE      WBOMITMN,WBOFITM5
          ENDIF
.
          MOVE      WBSEUID,WBOFCUID
          CALL      IBACLOCK
          PACK      WBOFCDAT,CCC,CYY,CMM,CDD
          REP       " 0",WBOFCDAT
          CLOCK     TIME,CTIMEIS
          MOVE      CTIMEIS,WBOFCTIM
.
          CALL      CNMW0000                       * DVA conc card on file ?
          IF        EXIT=1
            PACK      WBOFDVAN,PREPAT,SP20         * No
          ELSE
            MOVE      DIM20,WBOFDVAN               * yes
          ENDIF
.
          MOVE      WBOMVISN,WBOFVISN
          MOVE      WBOMCNTR,WBOFCNTR
          MOVE      ZERO,WBOFFLAG
          MOVE      SP70,WBOFTRID
          MOVE      SP70,WBOFMSID
          PACK      WBOFSPAR,SP70,SP70
.
          MOVE      WBOMF001,WBOFSTCD
          MOVE      PMEDI,WBOFMEDI
          MOVE      PTMXMCCD,WBOFMEDR
.
          MOVE      SP70,WBOFPRPR
          MOVE      SP70,WBOFSVPR
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1 
          IF        OVRCD=0
            MOVE      ADOCTA,WBOFPRPR
            MOVE      ADOCTA,WBOFSVPR
          ENDIF  
.
          PACK      KEY8,WBOFELGN,SP70
          CALL      RAWBOMF1
          IF        OVRCD=0
            GOTO      HOEM1000
          ENDIF
.
          CALL      WRWBOMF1
.
          PACK      KEY11,WBOMVISN,WBOMCNTR,SP70
          CALL      RDWBOEM1
          IF        OVRCD=0
            MOVE      WBOFELGN,WBOEELEG
            CALL      UPWBOEM1
          ENDIF
.
HOEM9999  CLOSE     WEBOMFA1
.
          RETURN
+
.-----------------------------------------------------------
.        Generate Free Format OECW-ECM Eligibility Number
.-----------------------------------------------------------
GELM0000  MOVE      ZERO,GELMFLAG
.
          MOVE      "118",PRXCODE
          CALL      GETSLK00
          READ      CONTROLF,HUND18;*117,PTCNELGN
.
GELM0100  MOVE      PTCNELGN,WBOFELGN
          UNPACK    PTCNELGN,ANS,KEY7
          MATCH     "a",ANS
          GOTO      GELM1150 IF LESS
          MOVE      ZERO,F7
          MOVE      KEY7,F7
.
GELM1100  COMPARE   "9999999",F7               * at the end of the group
          GOTO      GELM1110 IF NOT EQUAL
.
          MATCH     "z",ANS
          GOTO      GELM9000 IF EQUAL
.
          REP       REPUNIQ,ANS
          MOVE      ZERO,F7
.
GELM1110  ADD       ONE,F7
          MOVE      F7,D7
          REP       " 0",D7
.
          PACK      KEY8,ANS,D7,SP70
          CALL      RAWBOMF1
          IF        OVRCD=ONE
            PACK      KEY11,ANS,D7,SP1,SP1,ONE,SP70
            CALL      RAWBOEM1
            IF        OVRCD=ONE
              PACK      KEY14,ANS,D7,SP1,SP1,ONE,SP70
              CALL      RSWBOMS1
              CALL      RKWBOMS1
              BRANCH    OVRCD,GELM9500
.
              PACK      KEY8,ANS,D7,SP70
              MATCH     KEY8,WBOMVISN
              GOTO      GELM9500 IF NOT EQUAL
            ENDIF
          ENDIF
.
          GOTO      GELM1100
.
. no records
.
GELM1150  MOVE      ONE,F7
          MOVE      "a",ANS
.
          MOVE      F7,D7
          REP       " 0",D7
.
          PACK      KEY8,ANS,D7,SP70
          GOTO      GELM9500
.
GELM9000  MOVE      ONE,GELMFLAG                  * Passcode allocation full
          GOTO      GELM9999
.
GELM9500  MOVE      KEY8,PTCNELGN
          WRITAB    CONTROLF,HUND18;*117,PTCNELGN
.
          MATCH     "00000000",WBOFELGN
          GOTO      GELM0100 IF EQUAL
.
GELM9999  CALL      RELSLK00
          RETURN
+
.*******************************************************************************
.        Get Next weboemaf report counter
.*******************************************************************************
GNWOEM00  MOVE      "  1",KEY3
          PACK      KEY11,ADMISSNO,Z70
          CALL      RSWBOEM1
          CALL      RPWBOEM1
          BRANCH    OVRCD,GNWOEM99
.
          MATCH     ADMISSNO,WBOEVISN
          GOTO      GNWOEM99 IF NOT EQUAL
.
          MOVE      ZERO,FORM3
          SQUEEZE   WBOECNTR
          MOVE      WBOECNTR,FORM3
.
          ADD       ONE,FORM3
          MOVE      FORM3,KEY3
.
GNWOEM99  RETURN
+
.------------------------------------------------------------
. Check clinical document type cat wi ind 2 to see if there
. are any linked documents for this visit
. cat wi ind 2 = S = PMVXADMP - Adm Paperwork Received
.                C = PMVXCONO - Consent Obtained
.                M = PMVXMEDH - Medical History Received
.------------------------------------------------------------
OBSV0000  CLOSE     EMRSITA1                * Close to free one file open
          OPEN      OBSPCOA1,"obspcoaf"
.
          MOVE      ZERO,YESSADMP           * No Adm Paperwork Received
          MOVE      ZERO,YESSCONO           * No Consent Obtained
          MOVE      ZERO,YESSMEDH           * No Medical History Received
.
          PACK      KEY20,URNUMBER,ADMISSNO,SP70
          CALL      RSOBPC1
OBSV1000  CALL      RKOBPC1                 * Check correspondence records
          BRANCH    OVRCD,OBSV8000
.
          MATCH     URNUMBER,OBPCURNO       * Correct U/R
          GOTO      OBSV8000 IF NOT EQUAL
.
          MATCH     ADMISSNO,OBPCCVIS       * Correct U/R
          GOTO      OBSV8000 IF NOT EQUAL
.
          MATCH     "1",OBPCMDEL            * Deleted ?
          GOTO      OBSV1000 IF EQUAL
.
          MATCH     SP70,OBPCCTYP           * Blank type of Correspondence
          GOTO      OBSV1000 IF EQUAL
.
          PACK      KEY5,CATLWI,OBPCCTYP,SP70   * Type of Correspondence cat wi
          CALL      RDCODE1
          BRANCH    OVRCD,OBSV1000
.
          MATCH     "S",TCINDC2
          IF        @EQUAL
            MOVE      ONE,YESSADMP           * Yes Adm Paperwork Received
          ENDIF
.
          MATCH     "C",TCINDC2
          IF        @EQUAL
            MOVE      ONE,YESSCONO           * Yes Consent Obtained
          ENDIF
.
          MATCH     "M",TCINDC2
          IF        @EQUAL
            MOVE      ONE,YESSMEDH           * Yes Medical History Received
          ENDIF
.
          PACK      KEY3,YESSADMP,YESSCONO,YESSMEDH,SP70
.
          MATCH     "111",KEY3              * All 3 set to Yes so exit loop
          GOTO      OBSV1000 IF NOT EQUAL
.
OBSV8000  WRITE     HTMLFILE;YESSADMP,YESSCONO,YESSMEDH;
.
          CLOSE     OBSPCOA1
          OPEN      EMRSITA1,"emrsitaf"     * Re open after close
.
OBSV9999  RETURN
+
.*****************************************************************************
.*                              CNMW0000           Called by: WPAT0000       *
.*     See if the patient has concession card of DVA type on file            *
.* Requires: PURNO - U/R number                                              *
.* Returns:  EXIT  0 = valid concession card found                           *
.*                 1 = no valid concession card found                        *
.*           DIM20 - Concession Card Number                                  *
.*****************************************************************************
.
CNMW0000  CLOSE     WEBOMFA1
          OPEN      PMSCCDA1,"pmsccdaf"
.
          PACK      KEY19,PURNO,TILDA40
          CALL      RSPMCCD1                     * position on U/R
CNMW0500  CALL      RPPMCCD1                     * read previous record
          BRANCH    OVRCD,CNMW9100               * eof - nothing found
.
          MATCH     PURNO,PMCDURNO               * same U/R still ?
          GOTO      CNMW9100 IF NOT EQUAL        * no - nothing found
.
.         Check if the card type is DVA (Cat ct, Indicator 1)
.
          PACK      KEY5,CATCT,PMCDCTYP
          CALL      RDCODE1                      * code on file ?
          BRANCH    OVRCD,CNMW0500               * no - ignore record
.
          MATCH     SP1,TCINDC1                  * blank indicator 1 ?
          GOTO      CNMW0500 IF EQUAL            * yes - ignore record
.
          TYPE      TCINDC1                      * numeric indicator 1 ?
          GOTO      CNMW0500 IF NOT EQUAL        * no - ignore record
.
          MATCH     "3",TCINDC1                  * DVA card type ?
          GOTO      CNMW0500 IF NOT EQUAL        * no - ignore record
.
.         A DVA concession card has been found, so check
.         if there is an expiry date
.
          MATCH     SP8,PMCDEXDT                 * expiry date blank ?
          GOTO      CNMW1000 IF EQUAL            * yes - assume valid
.
.         There is an expiry date for the card, so check that the
.         card is current
.
          CALL      IBACLOCK
          PACK      DIM8,CCC,CYY,CMM,CDD
          REP       " 0",DIM8
.
          MATCH     DIM8,PMCDEXDT                * card valid for date ?
          GOTO      CNMW9100 IF LESS             * no - nothing found
.
.         Concession card is current
.
CNMW1000  MATCH     SP20,PMCDCNUM                * card number blank ?
          GOTO      CNMW9100 IF EQUAL            * yes - nothing found
.
          MOVE      PMCDCNUM,DIM20               * load concession card number
.
          MOVE      ZERO,CNMWFLAG
          GOTO      CNMW9999
.
CNMW9100  MOVE      ONE,CNMWFLAG
.
CNMW9999  CLOSE     PMSCCDA1
          OPEN      WEBOMFA1,"webomfaf"
          RETURN
.
.------------------------------------------------------------------------
.  Get last patient transfer record info
.------------------------------------------------------------------------
DISWRD00  MOVE      SP8,DISWARD
          MOVE      SP8,DISBED
          MOVE      SP8,DISUNIT
.        
          PACK      KEY30,ADMISSNO,Z70
          CALL      RDSTRAN2
DISWRD10  CALL      RDPTRAN2
          BRANCH    OVRCD,DISWRD90
.
          MATCH     DTADMN,ADMISSNO
          GOTO      DISWRD90 IF NOT EQUAL
.
          MATCH     ANSD,TMOVE
          GOTO      DISWRD90 IF NOT EQUAL
          MOVE      TWARD,DISWARD
          MOVE      TBED,DISBED
          MOVE      TDEPT,DISUNIT
          GOTO      DISWRD99
.
DISWRD90  MOVE      SP8,DISWARD
          MOVE      SP8,DISBED
          MOVE      SP8,DISUNIT
.
DISWRD99  RETURN
.
.**********************************************************************
. Update Past Hospital admissions                         
.
. -Private hospital (HEA) will have 'Include  in Billing Calculations' set
. spaces as they are able to se the field manually from Previous Hosp.template
.
. -Public hospital (WA) does not write the Previous hospitalisation details on
.  Admission
.**********************************************************************
UPPHSP00  MOVE      TWARD,SAVETWRD              * Save TWARD
          MOVE      TBED,SAVETBED               * Save TBED
.
          CLOSE     PATDSCH1
          CLOSE     PATASDA1
          OPEN      PATDSCH3,"patdschf"
          OPEN      PMSPHSA1,"pmsphsaf"
.
          IF        IBCNMHOS=1
            MOVE      AADMNO,KEY8
            CALL      RDPMVX11
            IF        OVRCD=0
              MATCH     SP70,PMVXMHOS           * Hospital id
              IF        !@EQUAL
                OPEN      PATHSPA1,"pathspaf"   * limited no of open files
                PACK      KEY3,PMVXMHOS,SP70
                CALL      RDPTHSP1
                IF        OVRCD=0
                  MATCH     "1",PTHSHOST        * Public hospital
                  GOTO      UPPHSP98 IF EQUAL
                ENDIF
              ENDIF
            ENDIF
          ELSE
            BRANCH    CHOSTYP,UPPHSP98          * Public hospital
          ENDIF
.
          MOVE      ZERO,MTIFLAG              * Flag for record in Prev.Visit
          PACK      KEY24,URNUMBER,SP70
          CALL      RDSDSCH3
UPPHSP10  CALL      RDKDSCH3 
          BRANCH    OVRCD,UPPHSP90
.
          MATCH     DURNO,URNUMBER
          GOTO      UPPHSP90 IF NOT EQUAL
.
          PACK      ADMNDATE,ADATE,SP70
          DAYSEP    DDATE,ADMNDATE,F5 
          COMPARE   C3BDAYS,F5
          IF   @LESS | @EQUAL
            COMPARE ZERO,F5
            IF      !@LESS 
              MOVE      AADMNO,DIM8VISN
              PACK      KEY8,DDADMNO
              CALL      RDMISS1
.
.             Add previous Visits
.
              PACK      KEY29,AADMNO,ADATE,DDATE,PTCNTRSC
              CALL      RAPMPHS1
              IF        OVRCD=1
                MOVE      DIM8VISN,PMPHADMN
                MOVE      PTCNTRSC,PMPHPHOS
                MOVE      ADATE,PMPHADAT
                MOVE      DDATE,PMPHDDAT
                MOVE      ZERO,NOLEVDAY
                MOVE      ZERO,PMPHLDAY
.
.               Determine Leave Days
.
                PACK      KEY30,AADMNO,SP30
                CALL      RDSTRAN2
UPPHSP20        CALL      RDKTRAN2
                BRANCH    OVRCD,UPPHSP30 
.
                MATCH     AADMNO,TADMN          
                GOTO      UPPHSP30 IF NOT EQUAL
.
                MOVE      TMOVE,STMOVE
                REP       " 0",TDATE
                MATCH     "L",TMOVE
                IF        @EQUAL
                  MOVE      TDATE,STDATE
                ENDIF
.
                MATCH     "R",TMOVE
                IF        @EQUAL
                  DAYSEP    STDATE,TDATE,F5A
                  ADD       F5A,NOLEVDAY
                  MOVE      NOLEVDAY,PMPHLDAY
                ENDIF 
                GOTO      UPPHSP20
.
UPPHSP30        CALL      CLPMSPHS            * clear all fields
                CALL      IBACLOCK
                PACK      PMPHCDAT,CCC,CYY,CMM,CDD
                REP       " 0",PMPHCDAT
                MOVE      CTIMEIS,PMPHCTIM
                MOVE      USERID,PMPHCUID
                PACK      KEY29,PMPHADMN,PMPHADAT,PMPHDDAT,PMPHPHOS,SP70
                CALL      RAPMPHS1
                IF        OVRCD=1
                  MOVE      ONE,PMPHINCC      * Include in 3B Cert.Calculation
                  CALL      WRPMPHS1
                  MOVE      ONE,MTIFLAG
                ENDIF
.
                PACK      KEY29,AADMNO,SP70
                CALL      RSPMPHS1
                CALL      RKPMPHS1
                BRANCH    OVRCD,UPPHPS50
.
                MATCH     AADMNO,PMPHADMN
                GOTO      UPPHPS50 IF NOT EQUAL
.
                DAYSEP    PMPHDDAT,ADMNDATE,F5 
                COMPARE   C3BDAYS,F5
                IF   @LESS | @EQUAL
                  COMPARE ZERO,F5
                  IF      !@LESS 
                    MOVE    DIM8VISN,PMPHADMN
                    PACK    KEY29,PMPHADMN,PMPHADAT,PMPHDDAT,PMPHPHOS,SP70
                    CALL    RAPMPHS1
                    IF      OVRCD=1
                      MOVE    ONE,PMPHINCC    * Include in 3B Cert.Calculation
                      CALL    WRPMPHS1
                      MOVE    ONE,MTIFLAG
                    ENDIF
                  ENDIF 
                ENDIF
              ENDIF
            ENDIF
UPPHPS50    MOVE     DIM8VISN,AADMNO
            PACK     KEY8,AADMNO
            CALL     RDMISS1
          ENDIF
          GOTO      UPPHSP10

UPPHSP90  IF        MTIFLAG=1
            CALL      CORIG000       * Recalculate Days of Hospitalisation
          ENDIF
.
UPPHSP98  CLOSE     PATDSCH3
          CLOSE     PMSPHSA1
          OPEN      PATDSCH1,"patdschf"
          OPEN      PATASDA1,"patasdaf"
.
UPPHSP99  MOVE      SAVETWRD,TWARD            * Restore TWARD
          MOVE      SAVETBED,TBED             * Restore TBED
.
          RETURN
.
.**********************************************************************
. Update visxdcaf type 002 extra discharge details record
.**********************************************************************
UXDC0000  MATCH     Z70,MRFDDATE            * No medically ready for discharge
          GOTO      UXDC9999 IF EQUAL       * date received so exit
.
          MATCH     Z70,VSXDC014            * No reason for discharge
          GOTO      UXDC9999 IF EQUAL       * so exit
.
          MOVE      ADMISSNO,VSXDC001       * Visit Number
          MOVE      TWO,VSTYPIND            * Type of Data
          MOVE      ONE,VSDATIND            * Date Field index (1-10)
          MOVE      MRFDDATE,VSDATVAL       * Date Field value (DIM8)

          CALL      UPDVDT00
.
          MOVE      TWO,VSTYPIND
          MOVE      TWO,VSCODIND
          MOVE      VSXDC014,VSCODVAL       
.
          CALL      UPDVCV00
.
UXDC9999  RETURN
.
.-----------------------------------------------------------
. Write EDWARD baby details update trigger
. EDWDBABY = 1, Birth Order, Weight or Plurality changed
. EDWDBABY = 0, No change
.-----------------------------------------------------------
EDWB0000  MATCH     SP70,PTCNNSSI        * no edward source system
          GOTO      EDWB9999 IF EQUAL
.
          MATCH     ZERO20,PTCNNSSI      * no edward source system
          GOTO      EDWB9999 IF EQUAL
.
          COMPARE   ZERO,EDWDBABY        * No change in baby values 
          GOTO      EDWB9999 IF EQUAL
.         
          MATCH     SP70,ACARE           * Blank care type
          GOTO      EDWB9999 IF EQUAL
          GOTO      EDWB9999 IF EOS
.
          PACK      KEY5,ANSC,ANSC,ACARE,SP70
          CALL      RDCODE1              * check newborn care type
          BRANCH    OVRCD,EDWB9999
.
          MATCH     "70",PTCDNHCP        * Baby care type
          GOTO      EDWB9999 IF NOT EQUAL
.
          MOVE      "2",PMEWTYPE         * Date of birth EDWARD trigger
          PACK      PMEWOLDV,PBDATE,SP70
          PACK      PMEWNEWV,PBDATE,SP70
          CALL      WREDW000
.
EDWB9999  RETURN
+
.--------------------------------------------------------------------------
. Write out pmsnplaf record
.--------------------------------------------------------------------------
WPMNPL00  MATCH     "3",PTCNUNET
          GOTO      WPMNPL99 IF NOT EQUAL
.
          CLOSE     PRSPMIA1                     * Free up some open files
          OPEN      PMSNPLA1,"pmsnplaf"
.
          CALL      CLPMSNPL
          MOVE      ZERO,CNTPMSNP
.
          MOVE      "07",PMNPRTYP
          MOVE      URNUMBER,PMNPURNO
          CALL      IBACLOCK
          PACK      PMNPRDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMNPRDAT
          CLOCK     TIME,CTIMEIS
          MOVE      CTIMEIS,PMNPRTIM
          ADD       ONE,CNTPMSNP
          MOVE      CNTPMSNP,PMNPCNTR
          RJUSTIFY  PMNPCNTR
          PACK      KEY28,PMNPURNO,PMNPRDAT,PMNPRTIM,PMNPCNTR
.
          IF        IBCNMHOS=ONE
            MOVE      WBSEHOSP,PMNPHOSP
          ELSE
            PACK      KEY3,SP70
            CALL      RSPTHSP1
            CALL      RKPTHSP1
            IF        OVRCD=0
              MOVE      PTHSHOSP,PMNPHOSP
            ENDIF
          ENDIF
.
          MOVE      USERID,PMNPRUID
          MOVE      "0",PMNPRSTA
          MOVE      PMNPRDAT,PMNPCDAT
          MOVE      PMNPRTIM,PMNPCTIM
          MOVE      PMNPRUID,PMNPCUID
.
WPMNPL10  CALL      RAPMNPL1
          IF        OVRCD=1
            CALL      WRPMNPL1
          ELSE
            ADD       ONE,CNTPMSNP
            MOVE      CNTPMSNP,PMNPCNTR
            RJUSTIFY  PMNPCNTR
            GOTO      WPMNPL10
          ENDIF
.
          CLOSE     PMSNPLA1
          OPEN      PRSPMIA1,"prspmiaf"          * Re open original files/
.
WPMNPL99  RETURN
.
.------------------------------------------------------------
. Check if surname, given name, gender, dob, medicare number
. or medicare IRN have been changed 
.------------------------------------------------------------
CHKCHG00  MOVE      ZERO,FORM2
.
          MATCH     SAVPSNAM,PTMASNAM
          IF        !@EQUAL
            GOTO      CHKCHG80
          ENDIF
.
          MATCH     SAVPFGNM,PMPXFNAM
          IF        !@EQUAL
            GOTO      CHKCHG80
          ENDIF
.
          MATCH     SAVPSGNM,PMPXSNAM
          IF        !@EQUAL
            GOTO      CHKCHG80
          ENDIF
.
          MATCH     SAVPPSEX,PSEX
          IF        !@EQUAL
            GOTO      CHKCHG80
          ENDIF
.
          MATCH     SAVPBDAT,PBDATE
          IF        !@EQUAL
            GOTO      CHKCHG80
          ENDIF
.
          MATCH     SAVPMEDI,PMEDI
          IF        !@EQUAL
            GOTO      CHKCHG80
          ELSE
            PACK      PTMXMCCD,PTMXMCCD,SP70
            MATCH     SAVPMCCD,PTMXMCCD
            IF        !@EQUAL
              GOTO      CHKCHG80
            ENDIF
          ENDIF
.
          GOTO      CHKCHG99 
.
CHKCHG80  MOVE      ONE,FORM2
.
CHKCHG99  RETURN
.
.------------------------------------------------------------
. Medically Cleared for Discharge History
.------------------------------------------------------------
LMDCLD00  CLOSE     PRSPMIA1                     * Free up some open files
          OPEN      PATATRA3,"patatraf"
.
          MOVE      "028",DIM3
          PACK      KEY35,URNUMBER,ADMISSNO,DIM3,Z70
          CALL      RSPTATR3
LMDCLD20  CALL      RPPTATR3
          BRANCH    OVRCD,LMDCLD98
.
          MATCH     URNUMBER,PTARURNO
          GOTO      LMDCLD98 IF NOT EQUAL
.
          MATCH     ADMISSNO,PTARVISN
          GOTO      LMDCLD98 IF NOT EQUAL
.
          MATCH     DIM3,PTARTYPE
          GOTO      LMDCLD98 IF NOT EQUAL
.
          MOVE      SP70,DATRDATM
          MATCH     SP70,PTARTXT1
          IF        !@EQUAL
            MOVE      PTARTXT2,DIM8
            UNPACK    PTARTXT1,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DATRDATM,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,Cat,DIM8
          ENDIF
.
          MOVE      SP70,DCRTDATM
          MATCH     SP70,PTARCDTE
          IF        !@EQUAL
            UNPACK    PTARCDTE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DCRTDATM,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,Cat,PTARCTME
          ENDIF
.
          MOVE      SP70,DDELDATM
          MATCH     SP70,PTARFDTE
          IF        !@EQUAL
            UNPACK    PTARFDTE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DDELDATM,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,Cat,PTARFTME
          ENDIF
.
          MOVE      SP70,DREASLD1
          MATCH     SP70,PTARCOD1
          IF        !@EQUAL
            MOVE      "z1",DIM2
            PACK      KEY5,DIM2,PTARCOD1,SP70
            CALL      RDCODE1
            IF        OVRCD = 1
              MOVE      SP70,PTCDLDES
            ENDIF
            MOVE      PTCDLDES,DREASLD1
          ENDIF
.
          MOVE      SP70,DREASLD2
          MATCH     SP70,PTARCOD2
          IF        !@EQUAL
            MOVE      "z1",DIM2
            PACK      KEY5,DIM2,PTARCOD2,SP70
            CALL      RDCODE1
            IF        OVRCD = 1
              MOVE      SP70,PTCDLDES
            ENDIF
            MOVE      PTCDLDES,DREASLD2
          ENDIF
.
          MOVE      SP70,DCRTUSRN
          MATCH     SP70,PTARCUSR
          IF        !@EQUAL
            PACK      KEY10,PTARCUSR,SP70
            CALL      RDWBSE1
            IF        OVRCD = 1
              MOVE      SP70,WBSENAM
            ENDIF
            MOVE      WBSENAM,DCRTUSRN
          ENDIF
.
          MOVE      SP70,DDELUSRN
          MATCH     SP70,PTARFUSR
          IF        !@EQUAL
            PACK      KEY10,PTARFUSR,SP70
            CALL      RDWBSE1
            IF        OVRCD = 1
              MOVE      SP70,WBSENAM
            ENDIF
            MOVE      WBSENAM,DDELUSRN
          ENDIF
.
          WRITE     HTMLFILE;"<tr>":
                             "<td>",DATRDATM,"</td>":
                             "<td>",DREASLD1,"<br>",DREASLD2,"</td>":
                             "<td>",DCRTUSRN,"</td>":
                             "<td>",DCRTDATM,"</td>":
                             "<td>",DDELUSRN,"</td>":
                             "<td>",DDELDATM,"</td>":
                             "</tr>"
.
          GOTO      LMDCLD20
.
LMDCLD98  PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
.
          CLOSE     PATATRA3
          OPEN      PRSPMIA1,"prspmiaf"          * Re open original files
.
LMDCLD99  RETURN
.
.----------------------------------------------------------------------------
. Get patient attribute details for URNO, admissno and attribute type "028"
.----------------------------------------------------------------------------
ATRFA000  UNPACK    DIM127,D1,D3,DIM127
          MATCH     SP70,D3
          GOTO      ATRFA999 IF EQUAL
          MOVE      ZERO,F3
          MOVE      D3,F3
.
          CLOSE     PRSPMIA1                     * Free up some open files
          OPEN      PATATRA3,"patatraf"
.
          MOVE      "028",DIM3
          CALL      GPTATR00
          IF        EXIT = 1
            CALL      CLPATATR
          ENDIF
.
          CLOSE     PATATRA3
          OPEN      PRSPMIA1,"prspmiaf"          * Re open original files
.
ATRFA008  BRANCH    F3,ATRFA010,ATRFA020,ATRFA030,ATRFA040,ATRFA050:
                       ATRFA060,ATRFA070,ATRFA080,ATRFA090,ATRFA100:
                       ATRFA110,ATRFA120
.
          GOTO      ATRFA999
.
ATRFA010  MOVE      "z1",CATEGORY
          MOVE      PTARCOD1,CODE
          CALL      CODITM00
          GOTO      ATRFA999
.
ATRFA020  MOVE      "z1",CATEGORY
          MOVE      PTARCOD2,CODE
          CALL      CODITM00
          GOTO      ATRFA999
.
ATRFA030  MOVE      PTARCOD3,DIM1
          WRITE     HTMLFILE;DIM1;
          GOTO      ATRFA999
.
ATRFA040  MOVE      PTARCOD4,DIM1
          WRITE     HTMLFILE;DIM1;
          GOTO      ATRFA999
.
ATRFA050  WRITE     HTMLFILE;PTARVAL1;
          GOTO      ATRFA999
.
ATRFA060  WRITE     HTMLFILE;PTARVAL2;
          GOTO      ATRFA999
.
ATRFA070  WRITE     HTMLFILE;PTARVAL3;
          GOTO      ATRFA999
.
ATRFA080  WRITE     HTMLFILE;PTARVAL4;
          GOTO      ATRFA999
.
ATRFA090  MATCH     SP70,PTARTXT1
          GOTO      ATRFA999 IF EQUAL
.
          UNPACK    PTARTXT1,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      ATRFA999
.
ATRFA100  WRITE     HTMLFILE;PTARTXT2;
          GOTO      ATRFA999
.
ATRFA110  WRITE     HTMLFILE;PTARTXT3;
          GOTO      ATRFA999
.
ATRFA120  WRITE     HTMLFILE;PTARTXT4;
          GOTO      ATRFA999
.
ATRFA999  RETURN
.
.------------------------------------------------------------------------------
. Get patatraf data for discharge - Reason for discharge delay (028)
. Input  URNUMBER
.        ADMISSNO
.        DIM3     - Type
. Return EXIT = 0, patatraf record found
.        EXIT = 1, No patatraf record found
.------------------------------------------------------------------------------
GPTATR00  MOVE      ZERO,EXIT
          PACK      KEY35,URNUMBER,ADMISSNO,DIM3,Z70
          CALL      RSPTATR3
          CALL      RPPTATR3
          BRANCH    OVRCD,GPTATR97
.
          MATCH     URNUMBER,PTARURNO
          GOTO      GPTATR97 IF NOT EQUAL
.
          MATCH     ADMISSNO,PTARVISN
          GOTO      GPTATR97 IF NOT EQUAL
.
          MATCH     DIM3,PTARTYPE
          GOTO      GPTATR97 IF NOT EQUAL
.
          MATCH     "1",PTARDELR
          GOTO      GPTATR97 IF EQUAL
.
          GOTO      GPTATR99
.
GPTATR97  MOVE      ONE,EXIT
.
GPTATR99  RETURN
.
.------------------------------------------------------------------------------
. Write patatraf for discharge - Reason for discharge delay (028)
.------------------------------------------------------------------------------
WRPATR20  CLOSE     PRSPMIA1                     * Free up some open files
          OPEN      PATATRA3,"patatraf"
.
          MATCH     SP70,PTDSC003
          GOTO      WRPATR25 IF EQUAL
.
          MOVE      "028",DIM3
          CALL      GPTATR00                     * Get if patatraf exist
          IF        EXIT = 1
            CALL     NWPATR00
            GOTO     WRPATR28
          ENDIF
.
WRPATR22  MATCH     PTARCOD1,PTDSC005            * data changes
          GOTO      WRPATR23 IF NOT EQUAL
.
          MATCH     PTARCOD2,PTDSC006
          GOTO      WRPATR23 IF NOT EQUAL
.
          MATCH     PTARTXT1,PTDSC003
          GOTO      WRPATR23 IF NOT EQUAL
.
          MATCH     PTARTXT2,PTDSC004
          GOTO      WRPATR23 IF NOT EQUAL
.
          GOTO      WRPATR28
.
WRPATR23  CALL      TOPATR00
          CALL      NWPATR00
.
          GOTO      WRPATR28
.
. Reason for discharge delay delete
.
WRPATR25  MOVE      "028",DIM3
          CALL      GPTATR00                     * Get if patatraf exist
          IF        EXIT = 0
            CALL      TOPATR00
          ENDIF
.
WRPATR28  CLOSE     PATATRA3
          OPEN      PRSPMIA1,"prspmiaf"          * Re open original files
.
WRPATR29  RETURN
.
.------------------------------------------------------------------------------
. Turn off patatraf
.------------------------------------------------------------------------------
TOPATR00  MOVE      ONE,PTARDELR
.
          CALL      IBACLOCK
          PACK      PTARUDTE,CCC,CYY,CMM,CDD
          REP       " 0",PTARUDTE
          CLOCK     TIME,PTARUTME
.
          MOVE      USERID,PTARUUSR
          MOVE      PTARUDTE,PTARFDTE
          MOVE      PTARUTME,PTARFTME
          MOVE      PTARUUSR,PTARFUSR
.
          CALL      UPPTATR3
.
TOPATR99  RETURN
.
.------------------------------------------------------------------------------
. Write out new patatraf
.------------------------------------------------------------------------------
NWPATR00  CLOSE     PMSELFA1                     * Free up some open files
          OPEN      PATATRA2,"patatraf"
.
          CALL      CLPATATR
          MOVE      URNUMBER,PTARURNO
          MOVE      ADMISSNO,PTARVISN
.
          CALL      IBACLOCK
          PACK      PTARDATE,CCC,CYY,CMM,CDD
          REP       " 0",PTARDATE
          CLOCK     TIME,PTARTIME
.
          MOVE      "028",PTARTYPE
          MOVE      PTDSC005,PTARCOD1
          MOVE      PTDSC006,PTARCOD2
          MOVE      PTDSC003,PTARTXT1
          MOVE      PTDSC004,PTARTXt2
.
          MOVE      "0",PTARDELR
          MOVE      PTARDATE,PTARCDTE
          MOVE      PTARTIME,PTARCTME
          MOVE      USERID,PTARCUSR
.
          PACK      KEY35,PTARURNO,PTARVISN,PTARDATE,PTARTIME,PTARTYPE,SP70
          CALL      WRPTATR2
.
          CLOSE     PATATRA2
          OPEN      PMSELFA1,"pmselfaf"          * Re open original files
.
NWPATR99  RETURN
+
.------------------------------------------------------------
. FHIR Exit Sucess
.   Return Location Header
.------------------------------------------------------------
FHREXT00  PACK      FILNAM,HTMLDIR,WEBPID,HTMLEXT,SP70
          SQUEEZE   FILNAM
          MOVE      ZERO,OVRCD
          MOVE      SP70,KEY60
          TRAP      OVERCOND GIVING KEY60 IF IO
          OPEN      HTMLFILE,FILNAM,WRONLY
          TRAPCLR   IO
          MOVE      OVRCD,EXIT
          BRANCH    EXIT,FHREXT99
.
          WRITE     HTMLFILE;"Content-Type: application/json+fhir",012:
                             "Cache-Control: no-cache",012:
                             "Location: %BASEURL/",FHIRLOCH,012,012;
.
          WRITE     HTMLFILE;*+,"{ #"resourceType#": #"OperationOutcome#",":
                             "  #"id#": #"allok#", ":
                             "  #"text#": { ":
                             "    #"status#": #"additional#", ":
                             "    #"div#": #"<div>All Ok</div>#" ":
                             "  }, ":
                             "  #"issue#": [ ":
                             "    { ":
                             "      #"severity#": #"information#", ":
                             "      #"code#": #"informational#", ":
                             "      #"details#": { ":
                             "        #"text#": #"All Ok#"":
                             "  } } ] }"
.
          CALL      CLOSHTML
FHREXT99  RETURN
+
.-----------------------------------------------------------
.  Clear  previous admission details file variables
.------------------------------------------------------------
CLPMSPHS  PACK      PMPHADMN,SP70
          PACK      PMPHPHOS,SP70
          PACK      PMPHADAT,SP70
          PACK      PMPHDDAT,SP70
          PACK      PMPHLDAY,SP70
          PACK      PMPHCUID,SP70
          PACK      PMPHCDAT,SP70
          PACK      PMPHCTIM,SP70
          PACK      PMPHUUID,SP70
          PACK      PMPHUDAT,SP70
          PACK      PMPHUTIM,SP70
          PACK      PMPHINCB,SP70
          PACK      PMPHINCC,SP70
.
          RETURN
.
.-----------------------------------------------------------
. Default Identifying Gender and Pronoun
.------------------------------------------------------------
DFGEN000  MATCH     SP70,PSEX
          GOTO      DFGEN999 IF EQUAL
.
          PACK      KEY5,ANSG,SP1,PSEX,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,DFGEN999
.
          MATCH     SP70,PMPXUCC4
          IF        @EQUAL
            MOVE      PTCDAS11,PMPXUCC4
          ENDIF
.
          MATCH     SP70,PMPXUCC5
          IF        @EQUAL
            MOVE      PTCDAS12,PMPXUCC5
          ENDIF
.
DFGEN999  RETURN
.
.-----------------------------------------------------------
          INC       ADMAUDIT
          INC       ACCEXTRA                                          *I-153670
          INC       BEDBDPRO
          INC       BEDBDVCD
          INC       BOKRECTM
          INC       CALCAGE
          INC       CALCCODE
          INC       CALCDLOS
          INC       CALCBMIN
          INC       VALCMXFN
          INC       CLBOKRQ1
          INC       CLBOKRAU
          INC       CLPATRE1                * Clear PRFA vars
          INC       CLMEHDIA                * Clear mental health diag vars
          INC       CLMEHVIS                * Clear mental health visit vars
          INC       CLMEHLEG                * Clear mental health LS vars
          INC       CLMRTMAS
          INC       CLMRTHIS                * clear MRT History record
          INC       CLNHIMAS                * Clear nhimasaf file variables
          INC       CLOPRDEA
          INC       CLOUTCAN
          INC       CLOUTRSH
          INC       CLPATATR
          INC       CLPATDSC
          INC       CLPATELG
          INC       CLPATDNR
          INC       CLPATMAS                   * Clear master file variables
          INC       CLPATMIS                   * Clear admission file variables
          INC       CLPATMSX                   * Clear master extension vars
          INC       CLPATMWS
          INC       CLPATTRN
          INC       CLPATVIS
.
          INC       CLPMSCHA 
          INC       CLPMSELF
          INC       CLPMSEXT
          INC       CLPMSCEX
          INC       CLPMSHRD
          INC       CLPMSUPO
          INC       PMSCEXTM
          INC       CMXMATRX
          INC       CLPMSHCP
          INC       CLPMSOEC
          INC       CLPMSOES
          INC       CLPMSPAY
          INC       CLPMSPX2
          INC       CLPMSVX1
          INC       CLPMSWX1
          INC       CLACCAUD                    * Clear ACC Audit file variables
          INC       CLPMSUPG
          INC       CLVISIAU
          INC       CLVISINT
          INC       CLVISPAY
          INC       CLWATTR1
          INC       CLWATTX1
          INC       CLOPRARD
          INC       CLWEBELF
          INC       CLWEBOEC
          INC       CLWEBOES
          INC       CLWEBOEM
          INC       CLWEBOMS
          INC       CLWEBOMF
.
          INC       COPYMCOD
          INC       DAYOFWEK
          INC       DEATHPOL
          INC       DGCLICAC
          INC       DGCLICAD
          INC       DGCLICCB                * DG API Cancel Booking    *I-90202
          INC       DGCLICCP                * Change Pre-Admission
          INC       DGCLICDC
          INC       DGCLICAE
          INC       DGCLICEC
          INC       DGCLICOB
          INC       DGCLICDI
          INC       DGCLICDS
          INC       DGCLICPA                * DG API Cancel Pre-Admiss *I-90202
          INC       DGCLICPR
          INC       DGCLICPE
          INC       DGCLICRM
          INC       DGCLICTR
          INC       DGCLICUP                                           *C-90223
          INC       DGCLII13
          INC       DGCLIRWL
          INC       DGCLIS14
          INC       DGCLIS15
          INC       DGCLIWLD                * HL7 W/L Cancel Booking
          INC       DGCLIUWL                * HL7 Update W/L Entry
          INC       EMRVISTM
          INC       EXPPAYCD
          INC       EOCDELEV
          INC       GENBOKNO
          INC       GETTFEES
          INC       IBAWEBCD
          INC       MEHVISTM
          INC       MEHLEGTM
          INC       MHAUDVIS
          INC       MRTVISCD
          INC       NAMSTRCD
          INC       NEWBNMAS
          INC       NEWBDMAS
          INC       NHOSPDAY
          INC       OPADDTIM
.....     INC       OPMAKBOK
.....     INC       OPMVSBOK
.....     INC       OPWEBCAN
          INC       PATATRTM
          INC       PATCLMTM
          INC       PATCOMN2                * Copy of WECOMN2
          INC       PATCOMN3
          INC       PATDAYUP
          INC       PATDPATH                                          *I-250985
          INC       PATDISCH
          INC       PATDOCTM
          INC       PATDSBFE
          INC       PATDYCAS
          INC       PATGNCMX
          INC       PATIPERH
          INC       PATMASTM
          INC       PATMISTM
          INC       PATMSXTM
          INC       PATRE1TM                * Person Responsible for Acct
          INC       PATTRRAT
          INC       PATVADCK
          INC       PATVISTM
          INC       PATDSCTM
          INC       PATQMHTM
          INC       NZPSPRTM
          INC       PERRESAC
          INC       PMSEXTTM
          INC       PMSHCGTM
          INC       PMSHCLTM
          INC       PMSHCPTM
          INC       PMSHPGTM
          INC       PMSHRDTM
          INC       PMSOECTM
          INC       PMSOESTM
          INC       PMSWORTM
          INC       PMSPX2TM
          INC       WEBOECTM
          INC       WEBOESTM
          INC       WEBOEMTM
          INC       WEBOMSTM
          INC       PREADCAN
          INC       PREADMIT
          INC       RTIODAYS
          INC       SEPRNAME
          INC       OPRARDTM
          INC       UPDCCARD
          INC       UPDUR
          INC       UPEADMVS             * Update eAdmission Visit Number
          INC       UPEADSTS             * Update eAdmission Status if required
          INC       VALURNMP
          INC       WEBDATCD
          INC       WLHISSUB
          INC       VALCONTR
          INC       GETCNEFF
          INC       CLEMRVIS                * Clear emrvisaf var.
          INC       CLALLREF
          INC       PATCMSTP
          INC       CLPMSRES
          INC       CLMEHHLS
          INC       CLPMSDAU
          INC       CLPATQMH
          INC       PMSRESTM
          INC       IBALPCCD
          INC       DEATHAUD
          INC       CLPMSNPL
          INC       CLPMSNUT
          INC       CINVPEND
          INC       PMSCEXCD
          INC       PATDDHRD
.
          INC       CLVISXDC
          INC       VISXDCTM
.
          INC       IBALPCIO/INC
          INC       AAEDE1IO/INC
          INC       ACCAUDIO/INC
          INC       ACCDIAIO/INC
          INC       ACCCMTIO/INC
          INC       ALLPCTIO/INC
          INC       ALLREFIO/INC
          INC       ALLRLNIO/INC
          INC       ALLSTSIO/INC
          INC       ALLAUDIO/INC
          INC       ALLLNKIO/INC
          INC       ALLRSAIO/INC
          INC       ALLCASIO/INC
          INC       ALLCTMIO/INC
          INC       ACCLODIO/INC        *     ACC Claim Lodgement
          INC       ACCRFPIO/INC
          INC       APSMASIO/INC
          INC       BOKDIAIO/INC
          INC       BOKSTAIO/INC
          INC       BOKRC1IO/INC
          INC       BOKUNQIO/INC
          INC       BOKRX1IO/INC
          INC       BOKRAUIO/INC
          INC       BOKRQ1IO/INC
          INC       CATCOMIO/INC
          INC       CCIEX7IO/INC
          INC       COMDEPIO/INC
          INC       COMERHIO/INC
          INC       DISMASIO/INC
          INC       DISPATIO/INC
          INC       DISPTLIO/INC
          INC       EOCLNKIO/INC
          INC       EMRDOCIO/INC
          INC       EMRGRCIO/INC
          INC       EMRHISIO/INC
          INC       EMRLOCIO/INC
          INC       EMRSITIO/INC
          INC       EMRUNKIO/INC
          INC       EMRVISIO/INC
          INC       EMRVCDIO/INC
          INC       EMRICDIO/INC
          INC       IBAPOLIO/INC
          INC       IBAPOSIO/INC
          INC       IBAALVIO/INC
          INC       MEHCJAIO/INC
          INC       MEHDIAIO/INC
          INC       MEHDLSIO/INC
          INC       MEHLEGIO/INC
          INC       MEHVI1IO/INC
          INC       MEHHLSIO/INC
          INC       MEHDS1IO/INC
          INC       MRTLOCIO/INC
          INC       MRTMASIO/INC
          INC       MRTMOVIO/INC
          INC       MRTHISIO/INC
          INC       MRTVISIO/INC
          INC       NHIETHIO/INC
          INC       NHIMASIO/INC
          INC       NZPSPRIO/INC
          INC       NZPPFEIO/INC
          INC       NZPCMTIO/INC
          INC       NZPCFNIO/INC
          INC       MLTCFNIO/INC
          INC       MLTHCPIO/INC
          INC       OUTARTIO/INC
          INC       OUTBOAIO/INC
          INC       OBSPCOIO/INC
          INC       OUTCLIIO/INC
          INC       OUTLKBIO/INC
          INC       OUTPREIO/INC
          INC       OUTSITIO/INC
          INC       OUTRF1IO/INC
          INC       OUTBB1IO/INC
          INC       OPRDEAIO/INC
          INC       OPRMBSIO/INC
          INC       OPRARDIO/INC
          INC       OPRSRGIO/INC
          INC       OPRDEBIO/INC
          INC       OPRDEDIO/INC
          INC       OPRNURIO/INC
          INC       OPRSESIO/INC
          INC       OPRSEMIO/INC
          INC       OPRTSMIO/INC
          INC       PATATRIO/INC
          INC       PATALRIO/INC
          INC       PATAM1IO/INC
          INC       PATAFEIO/INC
          INC       PATASDIO/INC
          INC       PATASFIO/INC
          INC       PATADBIO/INC
          INC       PATAU1IO/INC
          INC       PATBFEIO/INC
          INC       NZPBFEIO/INC
          INC       PATBMDIO/INC
          INC       PATBRDIO/INC
          INC       PATCFAIO/INC
          INC       PATCHCIO/INC
          INC       PATCMCIO/INC
          INC       VISMDTIO/INC
          INC       VISMTXIO/INC
          INC       PMSUCHIO/INC
          INC       PMSUCDIO/INC
          INC       PATCMXIO/INC
          INC       PATCSLIO/INC
          INC       PMSCIDIO/INC
          INC       PMSLRDIO/INC
          INC       PATCTFIO/INC
          INC       PATDADIO/INC
          INC       PATDAYIO/INC
          INC       PATDGWIO/INC
          INC       PATDNRIO/INC
          INC       PATDO1IO/INC
          INC       PATDRGIO/INC
          INC       PATDSCIO/INC
          INC       PATDTHIO/INC
          INC       PATDTRIO/INC
          INC       PATECDIO/INC
          INC       PATECOIO/INC                                     *T0845646
          INC       PATELGIO/INC
          INC       PATEORIO/INC
          INC       PATFN1IO/INC
          INC       PATFX1IO/INC
          INC       PATFHIIO/INC
          INC       PATGSRIO/INC
          INC       PATGTUIO/INC
          INC       PATHOSIO/INC                                      *I-250985
          INC       PATHSPIO/INC
          INC       PATICDIO/INC
          INC       PATICOIO/INC
          INC       PATIN1IO/INC
          INC       PATINVIO/INC
          INC       PATIPEIO/INC
          INC       PATITMIO/INC
          INC       PATLSDIO/INC
          INC       PATKWCIO/INC
          INC       PATLOCIO/INC
          INC       PMSBRQIO/INC
          INC       PMSNUTIO/INC
          INC       PMSRELIO/INC
          INC       PMSRESIO/INC
          INC       PMSREGIO/INC
          INC       PMSCHAIO/INC
          INC       PATHDFIO/INC
          INC       PATHLFIO/INC
          INC       PATLDFIO/INC
          INC       PATMA1IO/INC
          INC       PATMCHIO/INC
          INC       PATMI1IO/INC
          INC       PATNIDIO/INC
          INC       PATNIPIO/INC
          INC       PATNOBIO/INC
          INC       PATNUMIO/INC
          INC       PATONLIO/INC
          INC       PATPA1IO/INC
          INC       PATPEIIO/INC
          INC       PATPNIIO/INC
          INC       PATPR1IO/INC
          INC       PATRCAIO/INC
          INC       PATRE1IO/INC
          INC       PATRGMIO/INC
          INC       PATSDNIO/INC
          INC       PATSFAIO/INC
          INC       PATSTAIO/INC
          INC       PATTFEIO/INC
          INC       PATTRNIO/INC
          INC       PATURAIO/INC
          INC       PATVISIO/INC
          INC       PATQMHIO/INC
          INC       PATWC1IO/INC
          INC       PATWMAIO/INC
          INC       PATWR1IO/INC
          INC       PATONHIO/INC
          INC       PATWVEIO/INC
          INC       PMSAELIO/INC
          INC       PMSARQIO/INC
          INC       PMSAMNIO/INC
          INC       PMSARVIO/INC
          INC       PMSELFIO/INC
          INC       PATVADIO/INC
          INC       PATVCHIO/INC
          INC       PATVENIO/INC
          INC       PATVKCIO/INC
          INC       PMSAIDIO/INC
          INC       PMSPWAIO/INC
          INC       PMSALAIO/INC
          INC       PMSALNIO/INC
          INC       PMSBBDIO/INC
          INC       PMSCEXIO/INC
          INC       PATCMTIO/INC
          INC       PMSCMTIO/INC
          INC       PMSDAUIO/INC
          INC       PMSCTCIO/INC
          INC       PMSCCDIO/INC
          INC       PMSCURIO/INC
          INC       PMSDTCIO/INC
          INC       PMSADWIO/INC
          INC       PMSEDWIO/INC
          INC       PMSEPBIO/INC
          INC       PMSEHBIO/INC
          INC       PMSEXTIO/INC
          INC       PMSHRDIO/INC
          INC       PMSRCBIO/INC
          INC       PMSUPDIO/INC
          INC       PMSUPGIO/INC
          INC       PMSUPOIO/INC
          INC       PMSHPGIO/INC
          INC       PMSHPOIO/INC
          INC       PMSOECIO/INC
          INC       PMSOESIO/INC
          INC       PMSMTIIO/INC
          INC       PATPGRIO/INC
          INC       PATLINIO/INC
          INC       PATUNAIO/INC
          INC       PMSPHSIO/INC
          INC       PMSPX2IO/INC
          INC       PMSNEWIO/INC
          INC       PMSBORIO/INC
          INC       PMSTLEIO/INC            * Patient Titles table
          INC       PMSPAYIO/INC
          INC       PMSOOSIO/INC
          INC       PMSMORIO/INC
          INC       PMSVX1IO/INC
          INC       PMSWORIO/INC
          INC       PMSWTRIO/INC
          INC       PMSWX1IO/INC
          INC       PMSRLDIO/INC            * doctor role table
          INC       PRIHDBIO/INC
          INC       PRIHREIO/INC
          INC       PRSPMIIO/INC
          INC       RESLNKIO/INC
          INC       RCPBNKIO/INC
          INC       RCPDTEIO/INC
          INC       VISCMTIO/INC
          INC       VISIAUIO/INC
          INC       VISINTIO/INC
          INC       VISPAYIO/INC
          INC       WATCATIO/INC
          INC       WATCHAIO/INC
          INC       WATHISIO/INC
          INC       WATNBRIO/INC
          INC       WATPROIO/INC
          INC       WATTR1IO/INC
          INC       WATTX1IO/INC
          INC       WATESPIO/INC
          INC       WATESEIO/INC
          INC       WATESNIO/INC
          INC       WATPACIO/INC
          INC       WEBELFIO/INC
          INC       WEBOECIO/INC
          INC       WEBOESIO/INC
.
          INC       WEBOMFIO/INC
          INC       WEBOEMIO/INC
          INC       WEBOMSIO/INC
.
          INC       MRTPDSIO/INC
          INC       MRTRQDIO/INC
          INC       MRTRQHIO/INC
          INC       PMSIPLIO/INC
          INC       PMSNPLIO/INC
.
          INC       PMSEDGIO/INC       * Effective DRG Dates
.
          INC       ALLQUEIO/INC
          INC       PMSQPTIO/INC
          INC       HL7CISIO/INC
          INC       HL7INBIO/INC
          INC       BRHLCOMN
.
          INC       TFILENAM
.          INC       PMSIPLCD
          INC       GETEFDRG
          INC       PMSVMTIO/INC       * Clinical Codes Value Mapping
          INC       PMSVSCIO/INC       * Clinical Coding Value Set Codes
          INC       PMSVSTIO/INC       * Clinical Coding Value Set ID
          INC       PMSUKIIO/INC       * Key Words file for Value Set ID
          INC       PMSVSCTM
          INC       CLACCDIA
          INC       CLALLAUD
          INC       VISXDCIO/INC
          INC       PATDDHIO/INC
.
          INC       ITMELGCK
          INC       CHKWCCLM           * Check multiple Workers Comp claims
          INC       GENANVIS
          INC       MVITCONF
          INC       PRFAINSR
