. *----------------------------------------------------------------------
. * Include Name  :   BEDBDVCD.PBL
. *
. * Function      :   Common functions for bed board and expected patients
. *               :   Views                                                 
. *----------------------------------------------------------------------
.  Modifications Done :
.
.  V12.00.01  23/05/2025  PJ Le Febour   TSK 0955096 AlphaNumeric VisitNum 
.             replaced COMPARE TADMN,AADMNO to MATCH TADMN,AADMNO         
.  V11.01.03  13/09/2021  Ebon Clements  TSK 0910279
.             Removed V11.01.02 and V11.01.01 changes are restored original
.             functionality for post op ward/bed
.  V11.01.02  27/08/2021  Ebon Clements  TSK 0910383 - 0909330
.             Don't populate bed board post op ward/bed or expected ward/bed
.             if currently admitted to the post op ward/bed - BBAD0000, EXAD0000
.             Don't populate expected bed board post op ward/bed 
.             if currently admitted to the post op ward/bed - EXAD0000
.  V11.01.01  22/07/2021  Ebon Clements  TSK 0909330
.             Removed clear post of ward label CLPR0000 as it's no longer used.
.  V10.10.01  30/03/2017  Don Nguyen     TSK 0829654
.             Modified BBAD0000 to populate PMBDEWRD & PMBDEBED with
.             Post Op Ward/Bed.
.  V10.08.02  26/07/2016  Jill Parkinson TSK 0296775         
.             Removed V10.08.01 changes
.  V10.08.01  09/06/2016  Jill Parkinson TSK 0296775         
.             Mods to use bed ready date/time if entered when writing a bed
.             request to the expected patient table (instead of requested date)
.  V10.03.01  10/05/2012  Peter Vela             CAR 232137
.             Validate THETFLAG @ EXAP1100
.  V10.01.02  11/01/2011  Ebon Clements          CAR 215701
.             Only set the H/F stepdown indicator if hospital days are greater
.             than the expected LOS, not equal - UPHF0000
.  V10.01.01  21/12/2010  Ebon Clements          CAR 215701
.             Added H/F stepdown update to BBAD0000
.  V10.00.01  06/10/2010  Ebon Clements          CAR 231396
.             If admitted the post op records expected ward/bed will be the 
.             current ward/bed not the pre admissions expected ward/bed EXAP0000
.  V9.12.03   03/12/2009  Ebon Clements          CAR 204362
.             Clear the post op ward/bed for a current admission if they are
.             admitted to the same ward as the post op ward - CLRP0000
.  V9.12.02   11/11/2009  Ebon Clements          CAR 208991
.             If admitted expected due date for post op will be the
.             procedure date EXAP0000
.  V9.12.01   24/06/2009  Ebon Clements          CAR 199232
.             Added PMBDEWRD and PMBDEBED to BBAD0000 and BBCL0000
.             Added clear of PMBDEWRD and PMBDEBED to EXCL0000
.  V9.11.09   12/01/2009  Ebon Clements          CAR 174080
.             Fixed ward bed requests to ward only wards
.  V9.11.08   19/12/2008  Ebon Clements          CAR 174080
.             Added ~~W ward not assigned for non multi hospital 
.             pre admissions and bookings 
.  V9.11.07   17/12/2008  Ebon Clements          CAR 174080
.             Added gender to expected patients file    
.  V9.11.06   11/12/2008  Ebon Clements          CAR 174080
.             Fixed save of theatre booking post op bed
.  V9.11.05   26/11/2008  Ebon Clements          CAR 174057
.             Read ward to get hospital id in EXBK0000
.  V9.11.04   28/10/2008  Ebon Clements          CAR 174077
.             Added gender by room functionality               
.  V9.11.03   24/10/2008  Ebon Clements          CAR 174069
.             Added bed request functionality                  
.  V9.11.02   23/10/2008  Ebon Clements          CAR 174072
.             Added clear patient from bed board table
.  V9.11.01   08/10/2008  Ebon Clements          CAR 174068
.             Added ur number to expected patient and bed board files
.  V9.11.00   06/10/2008  Ebon Clements          CAR 174037
.             Created include
. *----------------------------------------------------------------------
.
.------------------------------------------------------------------------
. Add patient (pre admission) expected ward/bed to expected patient file
.------------------------------------------------------------------------
EXAD0000  IF        IBCNMHOS=1
            MATCH     SP70,PTMIXWRD
            GOTO      EXAD9999 IF EQUAL
          ELSE
            MATCH     SP70,PTMIXWRD
            IF        @EQUAL
              MOVE      "~~W",PTMIXWRD
            ENDIF
          ENDIF
.
          PACK      KEY20,PMVXMHOS,PTMIXWRD,SP70
          CALL      RDPMEPB1
          IF        OVRCD<>1
            GOTO      EXAD1100
          ENDIF
.
          PACK      KEY20,PMVXMHOS,PTMIXWRD,SP70
          CALL      RSPMEPB1
EXAD1000  CALL      RKPMEPB1
          BRANCH    OVRCD,EXAD9999
.
EXAD1100  MATCH     PMVXMHOS,PMEBHOSP
          GOTO      EXAD9999 IF NOT EQUAL
.        
          MATCH     PTMIXWRD,PMEBWARD
          GOTO      EXAD9999 IF NOT EQUAL
.
          MATCH     PTMIEBED,PMEBBEDD
          GOTO      EXAD1000 IF NOT EQUAL
.
          PACK      PMEBADMN,AADMNO,SP70
          MOVE      ADATE,PMEBEDAT
          MOVE      ATIME,PMEBETIM
.
          IF        IBCNMHOS<>1
            MATCH     "~~W",PTMIXWRD 
            IF        @EQUAL
              MOVE      SP70,PTMIXWRD
            ENDIF   
          ENDIF
.
          MOVE      PTMIXWRD,PMEBEWRD
.
          MOVE      PTMIEBED,PMEBEBED
          MOVE      BKREADAT,PMEBTBDT
          MOVE      SP70,PMEBTBTM
          MOVE      PMVXPOWD,PMEBPOWD
          MOVE      PMVXPOBD,PMEBPOBD
          MOVE      SP70,PMEBABRW
          MOVE      SP70,PMEBABRB
          MOVE      PSNAME,PMEBSURN
          MOVE      PGNAME,PMEBGIVN
          MOVE      SP70,PMEBBRPT
          MOVE      PCEASE,PMEBCEAS
          MOVE      PURNO,PMEBURNO
          MOVE      PSEX,PMEBGEND
.
          MOVE      USERID,PMEBWEBU
          PACK      PMEBDATU,CCC,CYY,CMM,CDD
          REP       " 0",PMEBDATU
          CLOCK     TIME,PMEBTIMU
          MOVE      SP70,PMEBSPAR
.
          PACK      KEY20,PMEBHOSP,PMEBWARD,PMEBROOM,PMEBBEDD,PMEBADMN,SP70
          CALL      RAPMEPB1
          IF        OVRCD=1
            CALL      WRPMEPB1
          ENDIF
.
EXAD9999  RETURN
.
.------------------------------------------------------------------------
. Add patient (pre admission) post op ward/bed to expected patient file
.------------------------------------------------------------------------
EXAP0000  MATCH     SP70,PMVXPOWD                    * Post op ward
          GOTO      EXAP9999 IF EQUAL
.
          PACK      KEY20,PMVXMHOS,PMVXPOWD,SP70
          CALL      RDPMEPB1
          IF        OVRCD<>1
            GOTO      EXAP1100
          ENDIF
.
          PACK      KEY20,PMVXMHOS,PMVXPOWD,SP70
          CALL      RSPMEPB1
EXAP1000  CALL      RKPMEPB1
          BRANCH    OVRCD,EXAP9999
.         
EXAP1100  MATCH     PMVXMHOS,PMEBHOSP
          GOTO      EXAP9999 IF NOT EQUAL
.         
          MATCH     PMVXPOWD,PMEBWARD
          GOTO      EXAP9999 IF NOT EQUAL
.         
          MATCH     PMVXPOBD,PMEBBEDD
          GOTO      EXAP1000 IF NOT EQUAL
.
          PACK      PMEBADMN,AADMNO,SP70
.         
          IF        ASTAT=2
            IF        THETFLAG=1
              MOVE      BKREADAT,PMEBEDAT   * If admitted expected due date for
              MOVE      SP70,PMEBETIM       * post op will be the procedure date
            ELSE
              MOVE      ADATE,PMEBEDAT
              MOVE      ATIME,PMEBETIM
            ENDIF
.
            MOVE      AWARD,PMEBEWRD        * Expected ward/bed will be the
            MOVE      ABED,PMEBEBED         * current ward bed
          ELSE
            MOVE      ADATE,PMEBEDAT
            MOVE      ATIME,PMEBETIM
            MOVE      PTMIXWRD,PMEBEWRD
            MOVE      PTMIEBED,PMEBEBED
          ENDIF     
.
          MOVE      BKREADAT,PMEBTBDT
          MOVE      SP70,PMEBTBTM
          MOVE      PMVXPOWD,PMEBPOWD
          MOVE      PMVXPOBD,PMEBPOBD
          MOVE      SP70,PMEBABRW
          MOVE      SP70,PMEBABRB
          MOVE      PSNAME,PMEBSURN
          MOVE      PGNAME,PMEBGIVN
          MOVE      SP70,PMEBBRPT
          MOVE      PCEASE,PMEBCEAS
          MOVE      PURNO,PMEBURNO
          MOVE      PSEX,PMEBGEND
.
          MOVE      USERID,PMEBWEBU
          PACK      PMEBDATU,CCC,CYY,CMM,CDD
          REP       " 0",PMEBDATU
          CLOCK     TIME,PMEBTIMU
          MOVE      SP70,PMEBSPAR
.
          PACK      KEY20,PMEBHOSP,PMEBWARD,PMEBROOM,PMEBBEDD,PMEBADMN,SP70
          CALL      RAPMEPB1
          IF        OVRCD=1
            CALL      WRPMEPB1
          ENDIF
.
EXAP9999  RETURN
.
.------------------------------------------------------------------------
. Add patient (booking) to expected patient file
.------------------------------------------------------------------------
EXBK0000  IF        IBCNMHOS=1
            MATCH     SP70,BKREWARD
            GOTO      EXBK9999 IF EQUAL
          ELSE
            MATCH     SP70,BKREWARD
            IF        @EQUAL
              MOVE      "~~W",BKREWARD
            ENDIF
          ENDIF
.         
          PACK      KEY6,BKREWARD,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,EXBK9999
.
          PACK      KEY20,PTWDHOSN,BKREWARD,SP70
          CALL      RDPMEPB1
          IF        OVRCD<>1
            GOTO      EXBK1100
          ENDIF
.
          PACK      KEY20,PTWDHOSN,BKREWARD,SP70
          CALL      RSPMEPB1
EXBK1000  CALL      RKPMEPB1
          BRANCH    OVRCD,EXBK9999
.         
EXBK1100  MATCH     PTWDHOSN,PMEBHOSP
          GOTO      EXBK9999 IF NOT EQUAL
.
          MATCH     BKREWARD,PMEBWARD
          GOTO      EXBK9999 IF NOT EQUAL
.
          MATCH     BKREEBED,PMEBBEDD
          GOTO      EXBK1000 IF NOT EQUAL
.
          PACK      PMEBADMN,BKREBOOK,SP70
          MOVE      BKREEDAT,PMEBEDAT
          MOVE      BKREATIM,PMEBETIM
.
          IF        IBCNMHOS<>1
            MATCH     "~~W",BKREWARD
            IF        @EQUAL
              MOVE      SP70,BKREWARD
            ENDIF
          ENDIF
.
          MOVE      BKREWARD,PMEBEWRD
.
          MOVE      BKREEBED,PMEBEBED
          MOVE      BKREADAT,PMEBTBDT
          MOVE      SP70,PMEBTBTM
          MOVE      BKRXPOWD,PMEBPOWD
          MOVE      BKRXPOBD,PMEBPOBD
          MOVE      SP70,PMEBABRW
          MOVE      SP70,PMEBABRB
          MOVE      PSNAME,PMEBSURN
          MOVE      PGNAME,PMEBGIVN
          MOVE      SP70,PMEBBRPT
          MOVE      PCEASE,PMEBCEAS
          MOVE      PURNO,PMEBURNO
          MOVE      PSEX,PMEBGEND
.
          MOVE      USERID,PMEBWEBU
          PACK      PMEBDATU,CCC,CYY,CMM,CDD
          REP       " 0",PMEBDATU
          CLOCK     TIME,PMEBTIMU
          MOVE      SP70,PMEBSPAR
.
          PACK      KEY20,PMEBHOSP,PMEBWARD,PMEBROOM,PMEBBEDD,PMEBADMN,SP70
          CALL      RAPMEPB1
          IF        OVRCD=1
            CALL      WRPMEPB1
          ENDIF
.
EXBK9999  RETURN
.
.------------------------------------------------------------------------
. Add patient (booking) post op ward to expected patient file
.------------------------------------------------------------------------
EXBP0000  MATCH     SP70,BKRXPOWD                     * Post op ward
          GOTO      EXBP9999 IF EQUAL
.
          PACK      KEY6,BKRXPOWD,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,EXBK9999
.
          PACK      KEY20,PTWDHOSN,BKRXPOWD,SP70
          CALL      RDPMEPB1
          IF        OVRCD<>1
            GOTO      EXBP1100
          ENDIF
.
          PACK      KEY20,PTWDHOSN,BKRXPOWD,SP70
          CALL      RSPMEPB1
EXBP1000  CALL      RKPMEPB1
          BRANCH    OVRCD,EXBP9999
.
EXBP1100  MATCH     PTWDHOSN,PMEBHOSP
          GOTO      EXBP9999 IF NOT EQUAL
.
          MATCH     BKRXPOWD,PMEBWARD
          GOTO      EXBP9999 IF NOT EQUAL
.
          MATCH     BKRXPOBD,PMEBBEDD   
          GOTO      EXBP1000 IF NOT EQUAL 
.
          PACK      PMEBADMN,BKREBOOK,SP70
          MOVE      BKREEDAT,PMEBEDAT
          MOVE      BKREATIM,PMEBETIM
          MOVE      BKREWARD,PMEBEWRD
          MOVE      BKREEBED,PMEBEBED
          MOVE      BKREADAT,PMEBTBDT
          MOVE      SP70,PMEBTBTM
          MOVE      BKRXPOWD,PMEBPOWD
          MOVE      BKRXPOBD,PMEBPOBD
          MOVE      SP70,PMEBABRW
          MOVE      SP70,PMEBABRB
          MOVE      PSNAME,PMEBSURN
          MOVE      PGNAME,PMEBGIVN
          MOVE      SP70,PMEBBRPT
          MOVE      PCEASE,PMEBCEAS
          MOVE      PURNO,PMEBURNO
          MOVE      PSEX,PMEBGEND
.
          MOVE      USERID,PMEBWEBU
          PACK      PMEBDATU,CCC,CYY,CMM,CDD
          REP       " 0",PMEBDATU
          CLOCK     TIME,PMEBTIMU
          MOVE      SP70,PMEBSPAR
.
          PACK      KEY20,PMEBHOSP,PMEBWARD,PMEBROOM,PMEBBEDD,PMEBADMN,SP70
          CALL      RAPMEPB1
          IF        OVRCD=1
            CALL      WRPMEPB1
          ENDIF
.
EXBP9999  RETURN
.
.------------------------------------------------------------------------
. Add patient to bed board file
.------------------------------------------------------------------------
BBAD0000  PACK      KEY20,PMVXMHOS,AWARD,SP70
          CALL      RDPMBBD1
          IF        OVRCD<>1
            GOTO      BBAD1100
          ENDIF
.
BBAD1000  CALL      RKPMBBD1
          BRANCH    OVRCD,BBAD9999
.
BBAD1100  MATCH     PMBDHOSP,PMVXMHOS
          GOTO      BBAD9999 IF NOT EQUAL
.
          MATCH     PMBDWARD,AWARD
          GOTO      BBAD9999 IF NOT EQUAL
.
          MATCH     PMBDBEDD,ABED
          GOTO      BBAD1000 IF NOT EQUAL
.
          MOVE      AADMNO,PMBDCADM
          MOVE      BKREADAT,PMBDTBDT
          MOVE      SP70,PMBDTBTM
          MOVE      PMVXPOWD,PMBDPOWD
          MOVE      PMVXPOBD,PMBDPOBD
          MOVE      PSNAME,PMBDSURN
          MOVE      PGNAME,PMBDGIVN
          MOVE      PSEX,PMBDGEND
          MOVE      SP70,PMBDHFST
          MOVE      PCEASE,PMBDCEAS
          MOVE      PURNO,PMBDURNO
          MOVE      PMBDPOWD,PMBDEWRD
          MOVE      PMBDPOBD,PMBDEBED
.
          MOVE      USERID,PMBDWEBU
          PACK      PMBDDATU,CCC,CYY,CMM,CDD
          REP       " 0",PMBDDATU
          CLOCK     TIME,PMBDTIMU
.
          MOVE      SP70,PMBDSPAR
.
          CALL      UPHF0000                * Update H/F stepdown indicator
.
          MATCH     SP70,PMBDBEDD
          IF        @EQUAL
            PACK      KEY20,PMBDHOSP,PMBDWARD,PMBDROOM,PMBDBEDD,PMBDCADM,SP70
            CALL      RAPMBBD1
            IF        OVRCD=1
              CALL      WRPMBBD1
            ENDIF
            GOTO    BBAD9999
          ENDIF
.
          CALL      UPPMBBD1
.
BBAD9999  RETURN
.
.--------------------------------------------------------------------------
.  Update HF stepdown
.--------------------------------------------------------------------------
UPHF0000  COMPARE   TWO,ASTAT
          GOTO      UPHF9999 IF NOT EQUAL
.
          MOVE      ADATE,FROMDATE
          PACK      TODATE,CCC,CYY,CMM,CDD
          REP       " 0",TODATE
.
          CALL      NHOSPDAY
.
          MATCH     "Y",PTMICMXP
          GOTO      UPHF6000 IF NOT EQUAL    * Not C/P
.
.         If the Current LOS is greater than Expected LOS, set indicator to 1
.
          COMPARE   NBRDAYS,ASTAY
          GOTO      UPHF8000 IF LESS
.
          GOTO      UPHF9999
.
.         Per diem
.
UPHF6000  PACK      KEY30,AADMNO,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,UPHF9999
          MATCH     TADMN,AADMNO
          GOTO      UPHF9999 IF NOT EQUAL
.
          COMPARE   NBRDAYS,TRBEND
          GOTO      UPHF8000 IF LESS
.
          GOTO      UPHF9999
.
UPHF8000  MOVE      "1",PMBDHFST            * Set H/F Stepdown flag to yes
.
UPHF9999  RETURN
.
.------------------------------------------------------------------------
. Update the bed board and expected patient file patient name, gender
.------------------------------------------------------------------------
BEDN0000  PACK      KEY28,PURNO,SP70
          CALL      RSPMBBD2
BEDN1000  CALL      RKPMBBD2
          BRANCH    OVRCD,BEDN5000
.
          MATCH     PURNO,PMBDURNO
          GOTO      BEDN5000 IF NOT EQUAL
.
          MATCH     PSNAME,PMBDSURN
          GOTO      BEDN2000 IF NOT EQUAL
.
          MATCH     PGNAME,PMBDGIVN
          GOTO      BEDN2000 IF NOT EQUAL
.
          MATCH     PSEX,PMBDGEND
          GOTO      BEDN2000 IF NOT EQUAL
.
          GOTO      BEDN1000
.
BEDN2000  MOVE      PSNAME,PMBDSURN
          MOVE      PGNAME,PMBDGIVN
          MOVE      PSEX,PMBDGEND
.
          CALL      UPPMBBD2
          GOTO      BEDN1000
.
BEDN5000  PACK      KEY28,PURNO,SP70
          CALL      RSPMEPB2
BEDN6000  CALL      RKPMEPB2
          BRANCH    OVRCD,BEDN9999
.
          MATCH     PURNO,PMEBURNO
          GOTO      BEDN9999 IF NOT EQUAL
.
          MATCH     PSNAME,PMEBSURN
          GOTO      BEDN7000 IF NOT EQUAL
.
          MATCH     PGNAME,PMEBGIVN
          GOTO      BEDN7000 IF NOT EQUAL
.
          MATCH     PSEX,PMEBGEND
          GOTO      BEDN7000 IF NOT EQUAL
.
          GOTO      BEDN6000
.
BEDN7000  MOVE      PSNAME,PMEBSURN
          MOVE      PGNAME,PMEBGIVN
          MOVE      PSEX,PMEBGEND
.
          CALL      UPPMEPB2
          GOTO      BEDN6000
.
BEDN9999  RETURN
.
.------------------------------------------------------------------------
. Clear patient from bed board table
.------------------------------------------------------------------------
BBCL0000  PACK      KEY28,URNUMBER,ADMISSNO,SP70
          CALL      RSPMBBD2
BBCL1000  CALL      RKPMBBD2
          BRANCH    OVRCD,BBCL9999
.
          MATCH     URNUMBER,PMBDURNO
          GOTO      BBCL9999 IF NOT EQUAL
.
          MATCH     ADMISSNO,PMBDCADM
          GOTO      BBCL9999 IF NOT EQUAL
. 
          MATCH     SP70,PMBDBEDD
          IF        @EQUAL
            PACK      KEY28,PMBDURNO,PMBDCADM,PMBDHOSP,PMBDWARD,PMBDROOM:
                            PMBDBEDD,SP70
            CALL      DEPMBBD2
            GOTO      BBCL0000
          ENDIF
.
          MOVE      SP70,PMBDCADM      * Current Admission Number
          MOVE      SP70,PMBDTBDT      * Theatre booking date (ccyymmdd)
          MOVE      SP70,PMBDTBTM      * Theatre booking time (hh:mm:ss)
          MOVE      SP70,PMBDPOWD      * Exp Post Op ward
          MOVE      SP70,PMBDPOBD      * Exp Post Op Bed
          MOVE      SP70,PMBDSURN      * Surname
          MOVE      SP70,PMBDGIVN      * Given name
          MOVE      SP70,PMBDGEND      * Gender
          MOVE      SP70,PMBDHFST      * Health Fund Stepdown reached
          MOVE      SP70,PMBDCEAS      * Deceased
          MOVE      SP70,PMBDURNO      * U/R Number
          MOVE      SP70,PMBDEWRD      * Expected Ward (Bed Request)
          MOVE      SP70,PMBDEBED      * Expected Bed (Bed Request)
          PACK      PMBDDATU,CCC,CYY,CMM,CDD
          REP       " 0",PMBDDATU      * Updated by details
          CLOCK     TIME,PMBDTIMU
          MOVE      USERID,PMBDWEBU
.
          CALL      UPPMBBD2
          GOTO      BBCL0000
.
BBCL9999  RETURN
.
.------------------------------------------------------------------------
. Clear patient from expected patient table
.------------------------------------------------------------------------
EXCL0000  PACK      KEY28,URNUMBER,ADMISSNO,SP70
          CALL      RSPMEPB2
EXCL1000  CALL      RKPMEPB2
          BRANCH    OVRCD,EXCL5000
.
          MATCH     URNUMBER,PMEBURNO
          GOTO      EXCL5000 IF NOT EQUAL
.
          MATCH     ADMISSNO,PMEBADMN
          GOTO      EXCL5000 IF NOT EQUAL
.
          PACK      KEY28,PMEBURNO,PMEBADMN,PMEBHOSP,PMEBWARD:
                          PMEBROOM,PMEBBEDD,SP70
          CALL      DEPMEPB2
          GOTO      EXCL0000
.
EXCL5000  PACK      KEY28,URNUMBER,ADMISSNO,SP70
          CALL      RSPMBBD2
          CALL      RKPMBBD2
          BRANCH    OVRCD,EXCL9999
.
          MATCH     URNUMBER,PMBDURNO
          GOTO      EXCL9999 IF NOT EQUAL
.
          MATCH     ADMISSNO,PMBDCADM
          GOTO      EXCL9999 IF NOT EQUAL
.
          MOVE      SP70,PMBDEWRD           * Clear bed request expected ward
          MOVE      SP70,PMBDEBED           * Clear bed request expected bed
.
          CALL      UPPMBBD2
.
EXCL9999  RETURN
.
.------------------------------------------------------------------------
. Add patient (Bed Request) to expected patient file
. Ward = ~~B
.------------------------------------------------------------------------
EXBR0000  PACK      KEY8,ADMISSNO,SP70
          CALL      RDVISA1
          BRANCH    OVRCD,EXBR9999
.         
          CALL      RDPMVX11
          BRANCH    OVRCD,EXBR9999
.         
          PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,EXBR9999
.
          PACK      KEY20,PMVXMHOS,BEDRWARD,SP70
          CALL      RDPMEPB1
          IF        OVRCD<>1
            GOTO      EXBR1100
          ENDIF
EXBR1000  CALL      RKPMEPB1
          BRANCH    OVRCD,EXBR9999
.         
EXBR1100  MATCH     PMVXMHOS,PMEBHOSP
          GOTO      EXBR9999 IF NOT EQUAL
.         
          MATCH     BEDRWARD,PMEBWARD
          GOTO      EXBR9999 IF NOT EQUAL
.
          MATCH     SP70,PMEBROOM
          GOTO      EXBR9999 IF NOT EQUAL
.         
          MATCH     SP70,PMEBBEDD
          GOTO      EXBR9999 IF NOT EQUAL
.         
          PACK      PMEBADMN,ADMISSNO,SP70
          MOVE      PMBRREQD,PMEBEDAT
          MOVE      PMBRREQT,PMEBETIM
          MOVE      SP70,PMEBEWRD
          MOVE      SP70,PMEBEBED
          MOVE      SP70,PMEBTBDT
          MOVE      SP70,PMEBTBTM
          MOVE      SP70,PMEBPOWD
          MOVE      SP70,PMEBPOBD
          MOVE      SP70,PMEBABRW
          MOVE      SP70,PMEBABRB
          MOVE      PSNAME,PMEBSURN
          MOVE      PGNAME,PMEBGIVN
          MOVE      ONE,PMEBBRPT
          MOVE      PCEASE,PMEBCEAS
          MOVE      PURNO,PMEBURNO
          MOVE      PSEX,PMEBGEND
.
          MOVE      USERID,PMEBWEBU
          PACK      PMEBDATU,CCC,CYY,CMM,CDD
          REP       " 0",PMEBDATU
          CLOCK     TIME,PMEBTIMU
          MOVE      SP70,PMEBSPAR
.
          PACK      KEY20,PMEBHOSP,PMEBWARD,PMEBROOM,PMEBBEDD,PMEBADMN,SP70
          CALL      RAPMEPB1
          IF        OVRCD=1
            CALL      WRPMEPB1
          ENDIF
.
EXBR9999  RETURN
.
.------------------------------------------------------------------------
. Add patient (Bed Request with allocated ward/bed ) to expected patient file
. Ward = ~~B
.------------------------------------------------------------------------
EXAL0000  PACK      KEY8,ADMISSNO,SP70
          CALL      RDVISA1
          BRANCH    OVRCD,EXAL9999
.         
          CALL      RDPMVX11
          BRANCH    OVRCD,EXAL9999
.         
          PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,EXAL9999
.
          PACK      KEY20,PMVXMHOS,PMBREWRD,SP70
          CALL      RDPMEPB1
          IF        OVRCD<>1
            GOTO      EXAL1100
          ENDIF
EXAL1000  CALL      RKPMEPB1
          BRANCH    OVRCD,EXAL9999
.
EXAL1100  MATCH     PMVXMHOS,PMEBHOSP
          GOTO      EXAL9999 IF NOT EQUAL
.
          MATCH     PMBREWRD,PMEBWARD
          GOTO      EXAL9999 IF NOT EQUAL
.
          MATCH     PMBREBED,PMEBBEDD
          GOTO      EXAL1000 IF NOT EQUAL
.
          PACK      PMEBADMN,ADMISSNO,SP70
          MOVE      PMBRREQD,PMEBEDAT
          MOVE      PMBRREQT,PMEBETIM
.
          MOVE      SP70,PMEBEWRD
          MOVE      SP70,PMEBEBED
          MOVE      SP70,PMEBTBDT
          MOVE      SP70,PMEBTBTM
          MOVE      SP70,PMEBPOWD
          MOVE      SP70,PMEBPOBD
          MOVE      SP70,PMEBABRW
          MOVE      SP70,PMEBABRB
          MOVE      PSNAME,PMEBSURN
          MOVE      PGNAME,PMEBGIVN
          MOVE      ONE,PMEBBRPT
          MOVE      PCEASE,PMEBCEAS
          MOVE      PURNO,PMEBURNO
          MOVE      PSEX,PMEBGEND
.
          MOVE      USERID,PMEBWEBU
          PACK      PMEBDATU,CCC,CYY,CMM,CDD
          REP       " 0",PMEBDATU
          CLOCK     TIME,PMEBTIMU
          MOVE      SP70,PMEBSPAR
.
          PACK      KEY20,PMEBHOSP,PMEBWARD,PMEBROOM,PMEBBEDD,PMEBADMN,SP70
          CALL      RAPMEPB1
          IF        OVRCD=1
            CALL      WRPMEPB1
          ENDIF
.
          PACK      KEY28,URNUMBER,ADMISSNO,SP70
          CALL      RSPMBBD2
          CALL      RKPMBBD2
          BRANCH    OVRCD,EXAL9999
.
          MATCH     URNUMBER,PMBDURNO
          GOTO      EXAL9999 IF NOT EQUAL
.
          MATCH     ADMISSNO,PMBDCADM
          GOTO      EXAL9999 IF NOT EQUAL
.
          MOVE      PMBREWRD,PMBDEWRD
          MOVE      PMBREBED,PMBDEBED 
.
          CALL      UPPMBBD2
.
EXAL9999  RETURN
.
.------------------------------------------------------------------------
. Clear the post op ward/bed for a current admission if they are
. admitted to the same ward as the post op ward - CLRP0000
.------------------------------------------------------------------------
CLRP0000  COMPARE   TWO,ASTAT                        * Current admission
          GOTO      CLRP9999 IF NOT EQUAL
.
          MATCH     SP70,PMVXPOWD                    * Post op ward
          GOTO      CLRP9999 IF EQUAL
.
          MATCH     AWARD,PMVXPOWD
          GOTO      CLRP9999 IF NOT EQUAL
.
          MOVE      SP70,PMVXPOWD                    * Clear post op ward
          MOVE      SP70,PMVXPOBD                    * Clear post op bed
.
          CALL      UPPMVX11
.
CLRP9999  RETURN
