.******************************************************************************
.*                                                                            *
.*      PATHFCF.PBL - User Defined Health Fund Claim Form Stationery          *
.*      -----------                                                           *
.*                                                                            *
.*      This include assumes the IBATMDFD, IBATMHFD, files have been read with*
.*      a valid stationery code. This must be done each time this include is  *
.*      called.                                                               *
.*      Also the PATMA1FD, PATMI1FD & PATDSCFD must have been read in with a  *
.*      valid admission.                                                      *
.*                                                                            *
.*      This include was initially copied from PRTSHT6.                       *
.*                                                                            *
.*      Modifications      :                                                  *
.*----------------------------------------------------------------------------*
.*        V12.00.01 22/05/2025  Alina Bhari   TSK 0955096                     *
.*                  Added alpanumeric visit number generation                 *
.*                  -PHFC4121,PHFC5473,PHFC5482,PHFC5501,PHFC5503,PHFC5521    * 
.*                  -RDDTR100,RKMDI000,RDMOP800,RKMOP000,CKINV100,CUICF010    *
.*                  -CNTR1000,CPRAR000,VALTR000,OPETM050,GTAMT100,GTANA050    *
.*                  -GTSER000,GTLOS000,GTCER100,PHFC5922,CUICF020,GTTHE000    *
.*        V11.04.01 27/11/2023  Peter Vela     TSK 0935874                    *
.*                  Added validation for PTCNUNET = 3                         *
.*        V11.03.01 07/08/2023  J.Tan           TSK 0935137                   *
.*                  Mod checking cat FI indc6=1 for printing
.*        V11.02.01 25/01/2022  Jacob Jackson   TSK 0864505                   *
.*                  Added preferred name option fields -                      *
.*                  PHFC7320, PHFC7325, PHFC7330, PHFC7335, PHFC7340          *
.*        V11.01.02 28/10/2021  Sunny           TSK 0896110                   *
.*                  Changed PHFC4850 - Added WADIM6 to convert DIM6 to FORM6  * 
.*                  for Admission Weight (ABWGHT)                             *
.*        V11.01.01 17/02/2021  J.Tan           TSK 0888639                   *
.*                  Changed Counter PATMMBFD to DIM 3                         *
.*        V11.00.11 08/12/2020  J.Tan          Task 0896778                   *
.*                  Added saved variables for DTRAMTT,DTRITEM                 *
.*        V11.00.10 26/10/2020  J.Tan          Task 0896778                   *
.*                  Fixed MBS Item desc.(field 203,204,205,206)               *
.*        V11.00.09 06/10/2020  J.Tan          Task 0897709                   *
.*                  Mod to allow more than 15 ICD codes                       *
.*        V11.00.08 14/09/2020  J.Tan          Task 0888394                   *
.*                  Removed checking FRSTFLAG for PRFA Addres4,Relationships  *
.*        V11.00.07 31/08/2020  Tracey Nguyen  Task 0896149                   *
.*                  Commented out PHFC6712 to revert changes to Care Type     *
.*                  cat CC to use User Defined Field 3 as per pre 01/07/2020  *
.*        V11.00.06 21/07/2020  J.Tan          Task 0888394                   *
.*                  Mod to print for text and field no 1-71 & 90-96 (PRFA)    *
.*                  on second and subsequent pages                            *
.*        V11.00.05 05/06/2020  Jill Parkinson Task 0892648                   *
.*                  Changed 2020 start date to 1 July                         *
.*        V11.00.04 18/05/2020  J.Tan          TSK 0891113                    *
.*                  Added var 402 for PKADD4                                  *
.*        V11.00.03 08/04/2020  Tracey Nguyen  TSK 0889652                    *
.*                  Statutory Changes 2020-2021                               *
.*                  1)Added DTYR2020                                          *
.*                  2)Care Type  - cat CC to use User Defined Field 4         *
.*                    - PHFC6710,PHFC6712                                     *
.*                  3)Inter-Hospital Contracted Care - cat S to use ind14     *
.*                    - PHFC6750,PHFC6751                                     *
.*        V11.00.04 03/04/2020  Thanh T        TSK 0879163                    *
.*                  Changed PHFC4290, PHFC4300 for Sex category               *
.*        V11.00.03 02/04/2020  J.Tan          TSK 0868813                    *
.*                  Changed PKNAME to DIM80                                   *
.*        V11.00.02 05/03/2020  Tracey Nguyen  TSK 0848746                    *
.*                  Added Insurance Company (PHFC7300) and Insurance Policy   *
.*                  Number/Fund Membership Number (PHFC7310)                  *
.*        V11.00.01 04/03/2020  J.Tan          TSK 0838262                    *
.*                  Added Effective from and to date to MBS Item file         *
.*----------------------------------------------------------------------------*
.*        V10.14.03 06/12/2019  Jill Parkinson Task 0884621                   *
.*                  Added check for A or H in indicator 13 for Cat BT         *
.*        V10.14.02 29/07/2019  Don Nguyen        TSK 0877726                 *
.*                  Modified Mental Health Legal Status to use User Defined   *
.*                  Field 5 (PTCDUDF5) instead of PTCDUDF4.                   *
.*        V10.14.01 25/07/2019  Don Nguyen        TSK 0877726                 *
.*                  Modified logic around Bed Type, Care Class and Mental     *
.*                  Health Legal Status to validate Admission Date against    *
.*                  1st July 2019 (DTYR2019) and use indicator 13 (TCINDC13), *
.*                  User Defined Field 3 (PTCDUDF3) or User Defined Field 4   *
.*                  (PTCDUDF4) values respectively.                           *
.*                  Added code to process PTCNCSTA=7 (MH Legal Status).       *
.*        V10.10.01 17/03/2017  Thanh T.          TSK 0832066                 *
.*                  Changed DVA PREPAT/PMPXDVAC fields to use the new         *
.*                  concession card PMCDCNUM/PMCDDVAC fields                  * 
.*        V10.08.02 24/11/2016  J.Tan            TSK 0825330                  *
.*                  Fixed Printing 5th Accom.line after Contract ID changed   *
.*        V10.08.01 31/08/2016  J.Tan            TSK 0321465 & 0319749        *
.*                  Fixed Accom.date when Contract ID changed                 *
.*        V10.06.01 02/09/2015  Peter Vela       CAR 320878                   *
.*                  Added PRFA Mbile Number                                   *
.*        V10.05.02 22/10/2014  J.Tan            CAR 306503                   *
.*                  Fixed invoice with multiple Contract ID                   *
.*        V10.05.01 29/09/2014  Davin            CAR 305951                   *
.*                  Changed fund membership number to use pmvxfndm (phfc4350) *
.*        V10.04.01 18/02/2014  Don Nguyen       CAR 291879                   *
.*                  Added variable 398 (PHFC7280) - IHI Number                *
.*        V10.03.07 22/03/2013  Ania P           CAR 281663                   *
.*                  Added vars 386-397 inclusive                              *
.*        V10.03.06 05/03/2013  Patrick Adair    CAR 281898                   *
.*                  Corrected key patecda1 and patecoa1 from KEY14 to KEY13   *
.*        V10.03.05 13/02/2013  Jill Parkinson   CAR 278327                   *
.*                  Fixed RDMOP000 to pack key16 with admission,spaces so that*
.*                  either pteocnt OR pteounqn can be used                    *
.*        V10.03.04 12/02/2013  Peter Vela       CAR 278327                   *
.*                  Added validation for 0 unique number @ RMMOP00            *
.*        V10.03.03 24/01/2013  Peter Vela       CAR 278327                   *
.*                  Added validation for 0 unique number @ RDMDI00	      *
.*        V10.03.02 20/08/2012  Steve Armstrong  CAR 501539                   *
.*                  Added check to ignore cancelled bookings in GTANA000.     *
.*        V10.03.01 09/02/2012  J.Tan            CAR 259025                   *
.*                  Added new var 384 - Alternate Election                    *
.*        V10.02.05 03/10/2011  Davin            CAR 248953                   *
.*                  Added new var 383 - Adm.Time                              *
.*        V10.02.04 19/09/2011  Davin            CAR 248749                   *
.*                  Added new vars 353-382                                    *
.*        V10.02.03 01/09/2011  Jill Parkinson   CAR 249381                   *
.*                  Changed RDMOP000 AND RDMDI000 to use form3 instead of 2   *
.*        V10.02.02 02/06/2011  Saroeun Soeur  CAR LANDESK 500457             *
.*                  changed   PHFC5620,PHFC5640,PHFC5660,PHFC5680             *
.*        V10.02.01 25/03/2011  Mike Laming   CAR 240107                      *
.*                  Mods to PATECDaf & PATECOaf variables & Keys - file change*
.*        V9.12.03  01/02/2010  Peter Vela     CAR 204672                     *
.*                  Added PRFA Description parameter for deceased patient     *
.*        V9.12.02  17/06/2009  Saroeun Soeur  CAR 198035                     *
.*                  set INVFLAG to orginal state                              *
.*                  INVFLAG > 0 if you want to print NCF by invoice           *
.*        V9.12.01  28/05/2009  Saroeun Soeur  CAR 196987                     *
.*                 PHFC4320- commented out FRSTFLAG so health fund is on      *
.*                  multiple pages                                            *
.******************************************************************************
.*        V9.10.02  18/06/2008  Ebon Clements  CAR 169830                     *
.*                  Added vars 343 to 352                                     *
.*        V9.10.01  15/05/2008  Ebon Clements  CAR 166566                     *
.*                  Fixed format of current year var 107                      *
.*        V9.09.02  28/09/2007  Davin        CAR 149173                       *
.*                  Added fields 334-342 for Visit Based Referring HCP Info:  *
.*                     334 - Referring HCP Code (visit)     10                *
.*                     335 - Referring HCP Name (visit)     60                *
.*                     336 - Referring HCP Addr 1 (visit)   60                *
.*                     337 - Referring HCP Addr 2 (visit)   60                *
.*                     338 - Referring HCP Addr 3 (visit)   60                *
.*                     339 - Referring HCP Addr 4 (visit)   60                *
.*                     340 - Referring HCP Postcode (visit)  8                *
.*                     341 - Referring HCP Telephon (visit) 20                *
.*                     342 - Referring HCP Fax Numb (visit) 20                *
.*        V9.09.01  01/08/2007  J.Tan        CAR 145438                       *
.*                  Added fields 330 331 332 333 for Total bed fee charges    *
.*                  02/08/2007  J.Tan        CAR 145810                       *
.*                  Mods checking for Credit notes                            *
.*        V9.08.07  01/06/2007  Mike Laming  CAR 140164                       *
.*                  Correct DDEST/DSTAT Indicator selection at PHFC5460,      *
.*                  PHFC6170 and PHFC6970                                     *
.*        ........  04/05/2007  Mike Laming  CAR 137125 HDP 2007 DRG 5.2      *
.*                  Mods to PATDGWFD - Add field PTDWDRGV (add to Keys)       *
.*        V9.08.06  27/04/2007  Peter Vela    CAR 139080                      *
.*                  Removed validation of accomodation code and daily rate    *
.*        V9.08.05  10/04/2007  Peter Vela    CAR ??????                      *
.*                  Fixed multipage printing of MBS items                     *
.*        V9.08.04  26/02/2007  Peter Vela    CAR 124542                      *
.*                  Changed Type B indicator functionality                    *
.*        V9.08.03  23/02/2007  Peter Vela    CAR 124542                      *
.*                  Changed Type B and C indicator functionality              *
.*        V9.08.02  05/02/2007  Peter Vela    CAR 124542                      *
.*                  Changed Type B and C indicator functionality              *
.*        V9.08.01  01/02/2007  Peter Vela    CAR 124542                      *
.*                  Added Type B or Type C indicator for MBS Items            *
.*        V9.07.03  04/09/2006  Peter Vela    CAR 113181                      *
.*                  Added DVA Service Category Code                           *
.*                  Cat CC Ind 11 PATMI1FD.ACARE                              *
.*                  Added DVA Admission Type Code                             *
.*                  Cat AC ACODE PATMI1FD.ACLSSFT                             *
.*                  Added DVA Admission Type Code Description                 *
.*                  Cat AC TDESC PATMI1FD.ACLSSFT                             *
.*                  Added DVA Discharge Intention Code                        *
.*                  Cat KN Ind 1 PMSVX1FD.PMVXUDIN                            *
.*                  Added DVA Separation Code                                 *
.*                  Cat DD Ind 6 PATDSCFD.DDEST                               *
.*        V9.07.02  14/07/2006  Mike Laming   CAR 112161                      *
.*                  Correct "Last Invoice" print - fix Disch.Date & Bed Fees  *
.*        V9.07.01  05/07/2006  Peter Vela    CAR 111267                      *
.*                  Added latest open subroutines for ICD V5                  *
.*                  OPICO1, OPICD1                                            *
.*        V9.05.01  24/03/2006  Peter Vela    CAR 61299                       *
.*                  Increased field no size from DIM3 to DIM5                 *
.*        V9.05.B01 14/02/2006  Mike Laming   CAR 94247                       *
.*                  Add code to find last Tran for-the-day in VALTR000        *
.*        V9.04.10  25/11/2005  J.Tan         CAR 81634                       *
.*                  Fixed setting MBS Amount                                  *
.*        V9.04.09  20/10/2005  Mike Laming   CAR 65745                       *
.*                  Change to read only PINVTYP=0 & 1 from "patinvrf"         *
.*                  Also correct reading DTRs in PHFC5480 - Bed Fees          *
.*        V9.04.08  01/09/2005  Mike Laming   CAR 62428                       *
.*                  Add New-born Baby routine NEWBB000 to PATHFCF             *
.*        V9.04.07  23/08/2005  Peter Vela CAR 70714                          *
.*                  Extract hospital name from pthsname.pathspaf if           *
.*                  mutli hospital indicator is yes                           *
.*        V9.04.06  12/08/2005  J.Tan      CAR 71717                          *
.*                  Fixed problem with missing MBS item from patmmbsf         *
.*        V9.04.05  20/07/2005  J.Tan      CAR 68001                          *
.*                  Fixed problem with missing mbs items                      *
.*        V9.04.04  22/02/2005  Peter Vela CAR 57547                          *
.*                  New fields for National Claim Form.                       *
.*                  1) Add 2 new items for Unplanned Theatre Visit check box  *
.*                     for yes and no.          *C-V-001                      *
.*                  2) Check Unplanned re-admission within 28 days            *
.*                     User code.               *C-V-002                      *
.*                  3) New Hospital in the Home.*C-V-003                      *
.*                  4) New Discharge code       *C-V-004                      *
.*                  5) Add new item for                                       *
.*                     Payment type code        *C-V-005                      *
.*                  6) New Other Services Code  *C-V-006                      *
.*                  7) Add new item for                                       *
.*                     Urgency of Admission code*C-V-007                      *
.*                  8) Add new item for                                       *
.*                     Care Type                *C-V-008                      *
.*                  9) Add new item for                                       *
.*                     ICU Hours                *C-V-009                      *
.*                  10) Add new item for                                      *
.*                      Source of Referral      *C-V-010                      *
.*                  11) Add new item for                                      *
.*                      Mental Health Leg. Stat.*C-V-011                      *
.*                  12) Add new item for                                      *
.*                      Inter-Hosp Cont Patients*C-V-012                      *
.*                  13) Add new item for                                      *
.*                      Provider Number Xfr From*C-V-013                      *
.*                      Provider Number Xfr To  *C-V-014                      *
.*                  14) Add new item for                                      *
.*                      Theat Arrival Time 1,2,3*C-V-015                      *
.*                      Theat Exit Time 1,2,3   *C-V-015                      *
.*                  15) Add new item for                                      *
.*                      Acute cert. check Box   *C-V-016                      *
.*                  16) Add new item for                                      *
.*                      Psy. Adm. Type check box*C-V-017                      *
.*                  17) Add new item for                                      *
.*                      Rehabilitation Check Box*C-V-018                      *
.*                  18) Add new item for                                      *
.*                      ICU Hours Check Box     *C-V-019                      *
.*                  19) Add new item for                                      *
.*                      NICU Hours Check Box    *C-V-020                      *
.*                  20) Add new item for                                      *
.*                      Patient Email Address   *C-V-023                      *
.*                  21) Add new item for                                      *
.*                      Patient Mobile Number   *C-V-024                      *
.*                  22) Add new item for                                      *
.*                      Other Charge Code1,2,3,4*C-V-021                      *
.*                  23) Add new item for                                      *
.*                      Day case Banding Ass6   *C-V-022                      *
.*        V9.04.03  17/11/2004  Peter Vela CAR 55723                          *
.*                  Added Marital Status                                      *
.*                  Added Country of birth                                    *
.*                  Added Country of Birth Description                        *
.*                  Added Language at Home                                    *
.*                  Added Language at Home Description                        *
.*                  Added Payment Status on Separation                        *
.*                  Added Readmission within 28 days                          *
.*                  Added Admission Type                                      *
.*                  Added Claim Type                                          *
.*                  Added Service Category on Admission                       *
.*                  Added Transfer to Hospital Code                           *
.*                  Added Source of Referral                                  *
.*                  Added Separation Mode (code only)                         *
.*                  Added Contract Status on Admission                        *
.*                  Added Primary Diagnosis Description                       *
.*                  Added 15 secondary diagnosis descriptions                 *
.*                  Added Primary Procedure Description                       *
.*                  Added 15 secondary procedure descriptions                 *
.*                  Added Primary Procedure Block Code                        *
.*                  Added 15 secondary procedure block codes                  *
.*        V9.04.02  26/11/2004  Peter Vela CAR 55477                          *
.*                  Added Arrival Time for first theatre session              *
.*                  oprardaf.oparatim                                         *
.*                  Added Exit time for first theatre session                 *
.*                  oprardaf.opartetc                                         *
.*                  07/10/2004  Jill Habasque CAR 53798                       *
.*                  Mods to print pthsappr for multi hospital                 *
.*        V9.04.01  27/09/2004  J.Tan    CAR 53750                            *
.*                  Check for cancelled invoice for printing MBS items        *
.*        V9.03.04  26/05/2004  Pat Dirito    CAR 50035                       *
.*                  Added Mechanical Ventilation Billing to "Other Services". *
.*                  Exclude any mv billing days from "Days Claimed" in the    *
.*                  accommodation section.                                    *
.*        V9.03.03  29/03/2004  Mike Laming   CAR 45023                       *
.*                  Add code to test PTEOTYPE at RDMOP000                     *
.*        V9.03.02  28/11/2003  Mike Laming  CAR 37514                        *
.*                  Add Discharge Ind "Z" to PHFC5460                         *
.*        V9.03.01  19/08/2003  CAR 42308   Mike Laming                       *
.*                  1) Removed use of SKEY22 and corrected use of SAVKEY22    *
.*                  2) Removed changes made for CAR 23456 in CKMBS000         *
.*                  3) Changed testing of line number flags TRANFLAG,MMBSFLAG *
.*                     & SERVFLAG at label PHFC4000 to correct printing of    *
.*                     second page of Claim Form                              *
.* ***************                                                            *
.*        V9.02.13  04/03/2003 J.Tan  SRF 36875                               *
.*                  Fixed print multiple MBS items                            *
.*        V9.02.12  04/12/2002  Tonii SRF 33987 (rebound)                     *
.*                  Problem: MBS amount was not showing for 3rd MBS item      *
.*                           Wrong values displaying for 2nd MBS item         *
.*                  - Added SKEY10 as working variable in CKMBS000, restored  *
.*                    SAVKEY10 to how it originally was                       *
.*        V9.02.11  29/11/2002  Tonii SRF 33987                               *
.*                  Problem: when printing multiple forms with theatre details*
.*                           the theatre times for previous patients are      *
.*                           carrying over to the next patient                *
.*                  - Mods to clear out working variables in theatre TO and   *
.*                    FROM time routines                                      *
.*        V9.02.10  27/11/2002  Tonii SRF 23456                               *
.*                  Problem: the same amount for MBS item printed for multiple*
.*                           MBS items                                        *
.*                  - Mods to only increment MMBSFLAG when the last item on a *
.*                    line is reached for an MBS item                         *
.*                  - Mods to how SAVKEY10 and MBSKEY22 are saved, these keys *
.*                    are now only saved once whilst printing and not eveytime*
.*                    CKMBS000 is called                                      *
.*        V9.02.09  12/11/2002  Guomin Fu    SRF 21995                        *
.*                  Fixed discharge code not printed correctly for deseased   *
.*                  patient
.*        V9.02.08  20/09/2002  Peter Vela   SRf 17859                        *
.*                  Fixed MBS Items display. When patmmbsf validates against  *
.*                  patdtraf, the code did not loop back to look through prev *
.*                  records.                                                  *
.*        V9.02.07  09/09/2002  Peter Vela   SRF 17859                        *
.*                  Fixed the bug: reading the wrong bed fees from "patdtraf" *
.*                  This bug resulted in bed fees not matching between        *
.*                  printing invoice (IBABIL20) and printing h/f claim forms  *
.*        V9.02.06  29/07/2002  Dean Cramer  SRF 17680                        *
.*                  Change so multiple other services print extrapolated      *
.*                  amount.                                                   *
.*        V9.02.05  03/07/2002  Mike Laming  SRF 18067 & 17203                *
.*                  Change to read "Bed Fees" from "patdtraf" (rather than    *
.*                  patranaf). Also added "Interim Claims" routines from V6.10*
.*                  Alter Warning message in line.                            *
.*        V9.02.04  14/03/2002  Dean Cramer                                   *
.*                  Include Transfer In (221) and Transfer Out (222) via      *
.*                  patdadaf & patvadaf                                       *
.*                  Make DRG Code 4 long                                      *
.*        V9.02.03  08/03/2002  J.Tan                                         *
.*                  Mods U/R and admission number not to move to  form field  *
.*                  Fixed patient age at admission                            *
.*        V9.02.02  06/12/2001  Tonii                                         *
.*                  Removed Episode flag for casemix funding                  *
.*        V9.02.01  01/11/2001  Greg Horvat                                   *
.*                  Added xtra option to the parameter PTCNDSCI               *
.*        V5.09.B02 17/04/2001  Steve Downing  SRF 7552                       *
.*                  Mods to use GETDRG routine when getting Grouper version   *
.*        V5.09.B01 09/02/2001  Greg Horvat      SRF 8390                     *
.*                  Recompiled for GETDRG - Changed to return the DRG version *
.*        V5.08.03  02/11/2000  Dean Cramer      SRF 6909                     *
.*                  Comments for changes to GETDRG as follows :               *
.*                  Clear DRG & MDC code variables so previously read codes   *
.*                  are not returned when none are detected by the get process*
.*                  Also extract these codes from the discharge file for use  *
.*                  as default values.                                        *
.*        V5.08.02  06/09/2000  Tonii                                         *
.*                  Added new branch to accept Indeterminate(PHFC5990) and    *
.*                  Unknown (PHFC6000) valid patient sex description          *
.*        V5.08.01  06/06/2000  Jill Habasque                                 *
.*                  Changed from key10 to key14 for the health fund file      *
.*        V5.08.B01 14/03/2000  Greg Horvat                                   *
.*                  Changed to get the coding from the episode coding files   *
.*        V5.07.03  25/11/1999  Davin                                         *
.*                  Changed for 4 character drgs                              *
.*        V5.07.02  13/07/1999  Greg Horvat                                   *
.*                  Replaced certain variables & with KEY variables           *
.*        V5.07.01  08/04/1999  Davin                                         *
.*                  Ported from 6.06 (& put PRTHFCF in procedure)             *
.*                  Added address line 4 to HFCF (fields 172-175)             *
.******************************************************************************
.*        V6.04.14  30/07/98 Katie Nelson                                     *
.*                  Ignore display statements if using web server             *
.*        V6.04.13  05/03/98 J.Tan   SRF 624528                               *
.*                  Casemix daycase has no daily charge                       *
.*        V6.04.12  28/01/98 J.Tan    SRF 623522                              *
.*                  Fixed generate the lumpsum payments                       *
.*        V6.04.11  25/07/97 J.Tan    SRF 620315                              *
.*                  Added casemix code                                        *
.*        V6.04.10  20/05/97 J.Tan                                            *
.*                  Added lumpsum payments                                    *
.*        V6.04.09  23/04/1997  Greg Horvat      SRF 619783 619665            *
.*                  Changed to get the health fund from the admission file    *
.*                  23/04/1997  Greg Horvat      Quote 8839                   *
.*                  Added items 212 - 215                                     *
.*        V6.04.08  08/04/1997  Greg Horvat      SRF 619533                   *
.*                  Changed to print accomodation records for daycase patients*
.*        V6.04.07  26/03/1997  Greg Horvat                                   *
.*                  Fixed a problem printing a new page when not required.  I *
.*                  hope this is the last time this has to be fixed.          *
.*        V6.04.06  20/03/1997  Greg Horvat      SRF 618919 619381            *
.*                  Changed to only print the last transfer record on the     *
.*                  discharge date & changed to print 5 or MBS codes correctly*
.*        V6.04.05  11/03/1997  Greg Horvat                                   *
.*                  Changed to print the correct MBS details on the last page *
.*        V6.04.04  26/02/1997  Greg Horvat                                   *
.*                  Changed to print attending doctor type code               *
.*        V6.04.03  19/02/1997  Greg Horvat      SRF 617399                   *
.*                  Changed the accom type to be extracted by either the bed  *
.*                  type or the admin type, depending on PTCNNCFB             *
.*        V6.04.02  19/02/1997  Greg Horvat      SRF 618814                   *
.*                  Changed to only print a new page if required              *
.*        V6.04.01  09/01/1997  Greg Horvat      SRF 618417                   *
.*                  Added MBS code descriptions & daycase bandings            *
.*                                                                            *
.*        V6.03.11  19/09/1996  Greg Horvat      SRF 616783                   *
.*                  Changed to print the correct operation start & end times  *
.*        V6.03.10  31/04/96 J.Tan                                            *
.*                  Fixed printing the daycase accomodation                   *
.*        V6.03.09  29/04/96 J.Tan    SRF 615021                              *
.*                  Fixed the amount of same MMS codes with same date         *
.*        V6.03.08  17/04/96 J.Tan    SRF 614903                              *
.*                  Fixed paper length of stationary for multiple pages       *
.*        V6.03.07  15/04/1996  Greg Horvat      SRF 614771                   *
.*                  Changed to get the attending doctor from the admission    *
.*                  file if preadmitted                                       *
.*        V6.03.06  06/02/1996  Steve Armstrong  SRF 613695                   *
.*                  Mods to replace spaces with zeroes in dtr dates.          *
.*        V6.03.05  19/01/1996  Steve Armstrong  SRF 613601                   *
.*                  Mods to check for status of 5 at end of first page        *
.*                  before printing subsequent pages.                         *
.*        V6.03.04  20/12/1995  Steve Armstrong                               *
.*                  Fixed printing of date for Other Services.                *
.*                  Fixed number of services for Other Services to print "1"  *
.*                  if TSERVS is "0".                                         *
.*                  Fixed Other Services Charges to divide by number of       *
.*                  services.                                                 *
.*                  Fixed Patient DOB Year to be YY instead of CCYY.          *
.*                  Removed check on ttype in DTR for MBS items.              *
.*                  Mods to check if accommodation records are invoiced.      *
.*        V6.03.03  28/11/1995  Steve Armstrong                               *
.*                  Mods for new template variables for National Claim Form.  *
.*                  Also mods to logic of program to handle multiple pages.   *
.*        V6.03.02  27/10/1995  Greg Horvat      SRF 612064 612205 612206     *
.*                  Recompiled for changes to STEPDOWN                        *
.*        V6.03.01  11/10/1995  Greg Horvat      SRF 611811                   *
.*                  Changed to use CALCDAYS instead of CALC when calculating  *
.*                  the difference between two dates                          *
.*        V6.03.B01 12/01/1995  Greg Horvat      New Release 6.03             *
.*                  Changed the patients age to display in days if less than  *
.*                  one year old. Added the following new variables, the      *
.*                  patients DRG, MDC, the seperation mode & the first 15     *
.*                  medical records disease & operation codes for a patient.  *
.*        V6.03.B00 12/01/1995  Greg Horvat      New Release 6.03             *
.*                  Recompiled for PATMA1FD - Changed PBDATE to be CCYYMMDD   *
.*                                                                            *
.******************************************************************************
+
. ---- Print Lineup for Health Fund Claim Form ----
.
LNUPHFCF  PROC      LHFC0000
          RETURN
+
. ---- Print Health Fund Claim Form ----
.
PRTHFCF   PROC      PHFC0000
          RETURN
+
.*******************************************************************************
.*                                 LHFC0000                                    *
.*                    Print Line Up Health Fund Claim Form                     *
.*******************************************************************************
.
          DEFPROC   LHFC0000
.
          INC       IBATMDFD/INC
          INC       IBATMHFD/INC
.
VARIABLE  DIM       127
+
LHFC0000  OPEN      IBATMHA1,"ibatmhaf"
          OPEN      IBATDET1,"ibatmdaf"
.
          PACK      KEY6,STATNCOD           * re-read header file
          CALL      RDIBTH1
.
          PACK      KEY12,STATNCOD,SP20     * re-read first detail field
          CALL      RSIBDET1
          CALL      RKIBDET1
.
          CALL      OPNPRINT                * Open spool file
          MOVE      ONE,CURRROW             * Initialize current row counter
LHFC0500  COMPARE   CURRROW,IBDTROW         * Current row up to required row ?
          GOTO      LHFC2000 IF EQUAL       * Yes - print data
          PRINT     *N;                     * Else print 1 extra line
          ADD       ONE,CURRROW             * Increment counter
          GOTO      LHFC0500                * Check counter again
.
. ----- Read through the details file -----
.
LHFC1000  CALL      RKIBDET1                * Read next detail record
          BRANCH    OVRCD,LHFC9000          * No more records - pad out form
.
          MATCH     STATNCOD,IBDTSCOD       * Same form ?
          GOTO      LHFC9000 IF NOT EQUAL   * No - pad out rest of form
.
LHFC1500  COMPARE   CURRROW,IBDTROW         * Are we at the required row ?
          GOTO      LHFC2000 IF EQUAL       * Yes - print data
          PRINT     *N;                     * Else pad out to required row
          ADD       ONE,CURRROW             * One more row printed
          GOTO      LHFC1500                * Check row count
.
. ----- Print actual data lines -----
.
LHFC2000  BRANCH    IBDTINDC,LHFC3000:      * Text field
                             LHFC4000       * Data field
.
. ----- Print text field -----
.
LHFC3000  RESET     IBDTTXFL,IBDTPLEN
          LENSET    IBDTTXFL
          RESET     IBDTTXFL
          PRINT     *IBDTCOL,*+,IBDTTXFL;   * Print data
          MOVE      IBDTROW,CURRROW         * Row printed is current row
          GOTO      LHFC1000                * Read next record
.
. ----- Print data field -----
.
LHFC4000  MOVE      IBDTTXFL,KEY5           * Data number 1st 3 chars of field
          MOVE      KEY5,FORM5              * Move to a FORM field for BRANCH
.
          PACK      VARIABLE,SP30,SP30,SP30,SP30,SP30
          BRANCH    FORM5,LHFC4180,LHFC4120,LHFC4080,LHFC4170,LHFC4170:   *   5
                          LHFC5020,LHFC4170,LHFC4170,LHFC5020,LHFC5040:   *  10
                          LHFC5040,LHFC5040,LHFC4060,LHFC4160,LHFC4150:   *  15
                          LHFC4210,LHFC4160,LHFC4160,LHFC4140,LHFC5020:   *  20
                          LHFC4130,LHFC4130,LHFC4020,LHFC5000,LHFC5000:   *  25
                          LHFC5000,LHFC4060,LHFC4030,LHFC4030,LHFC4030:   *  30
                          LHFC4080,LHFC4170,LHFC4100,LHFC4170,LHFC4110:   *  35
                          LHFC4030,LHFC4030,LHFC4010,LHFC5000,LHFC5000:   *  40
                          LHFC5000,LHFC4010,LHFC5000,LHFC5000,LHFC5000:   *  45
                          LHFC4070,LHFC4070,LHFC4210,LHFC4130,LHFC4170:   *  50
                          LHFC4170,LHFC4140,LHFC5020,LHFC4210,LHFC4130:   *  55
                          LHFC4170,LHFC4170,LHFC4140,LHFC5020,LHFC4210:   *  60
                          LHFC4130,LHFC4170,LHFC4170,LHFC4140,LHFC5020:   *  65
                          LHFC4200,LHFC4200,LHFC4110,LHFC4200,LHFC4200:   *  70
                          LHFC4110,LHFC4110,LHFC5060,LHFC4010,LHFC4110:   *  75
                          LHFC5060,LHFC4010,LHFC4110,LHFC5060,LHFC4010:   *  80
                          LHFC4110,LHFC5060,LHFC4010,LHFC4050,LHFC5020:   *  85
                          LHFC5010,LHFC4990,LHFC4030,LHFC5010,LHFC4180:   *  90
                          LHFC4160,LHFC4160,LHFC4140,LHFC5020,LHFC4130:   *  95
                          LHFC4130,LHFC5050,LHFC5050,LHFC5050,LHFC5020:   * 100
                          LHFC4030,LHFC4030,LHFC4030,LHFC4010,LHFC5000:   * 105
                          LHFC5000,LHFC5000,LHFC4060,LHFC4050,LHFC5000:   * 110
                          LHFC4110,LHFC4110,LHFC4110,LHFC4110,LHFC4110:   * 115
                          LHFC4110,LHFC4110,LHFC4110,LHFC4110,LHFC4110:   * 120
                          LHFC4110,LHFC4110,LHFC4110,LHFC4110,LHFC4110:   * 125
                          LHFC4110,LHFC4110,LHFC4110,LHFC4110,LHFC4110:   * 130
                          LHFC4110,LHFC4110,LHFC4110,LHFC4110,LHFC4110:   * 135
                          LHFC4110,LHFC4110,LHFC4110,LHFC4110,LHFC4110:   * 140
                          LHFC4120,LHFC4990,LHFC5000,LHFC4010,LHFC4010:   * 145
                          LHFC4990,LHFC5030,LHFC5060,LHFC5000,LHFC5000:   * 150
                          LHFC4010,LHFC4010,LHFC4990,LHFC5030,LHFC5060:   * 155
                          LHFC5000,LHFC5000,LHFC4010,LHFC4010,LHFC4990:   * 160
                          LHFC5030,LHFC5060,LHFC4990,LHFC5000,LHFC4010:   * 165
                          LHFC4010,LHFC4990,LHFC5030,LHFC5060,LHFC4070:   * 170
                          LHFC4070,LHFC4180,LHFC4180,LHFC4180,LHFC4180:   * 175
                          LHFC4030,LHFC4030,LHFC4030,LHFC4030,LHFC4030:   * 180
                          LHFC4050,LHFC4990,LHFC4010,LHFC5025,LHFC5060:   * 185
                          LHFC4990,LHFC4010,LHFC5025,LHFC5060,LHFC4990:   * 190
                          LHFC4010,LHFC5025,LHFC5060,LHFC4990,LHFC4010:   * 195
                          LHFC5025,LHFC5060,LHFC5010,LHFC5010,LHFC5020:   * 200
                          LHFC4030,LHFC4110,LHFC4190,LHFC4190,LHFC4190:   * 205
                          LHFC4190,LHFC4030,LHFC4030,LHFC4030,LHFC4030:   * 210
                          LHFC4050,LHFC4120,LHFC4120,LHFC4030,LHFC4150:   * 215
                          LHFC5050,LHFC4110,LHFC4215,LHFC4030,LHFC4030:   * 220
                          LHFC4170,LHFC4170,LHFC4070,LHFC4070,LHFC4050:   * 225
                          LHFC4050,LHFC4150,LHFC4050,LHFC4150,LHFC4050:   * 230
                          LHFC4050,LHFC4050,LHFC4050,LHFC4050,LHFC4070:   * 235
                          LHFC4050,LHFC4050,LHFC4030,LHFC4220,LHFC4220:   * 240
                          LHFC4220,LHFC4220,LHFC4220,LHFC4220,LHFC4220:   * 245
                          LHFC4220,LHFC4220,LHFC4220,LHFC4220,LHFC4220:   * 250
                          LHFC4220,LHFC4220,LHFC4220,LHFC4220,LHFC4220:   * 255
                          LHFC4220,LHFC4220,LHFC4220,LHFC4220,LHFC4220:   * 260
                          LHFC4220,LHFC4220,LHFC4220,LHFC4220,LHFC4220:   * 265
                          LHFC4220,LHFC4220,LHFC4220,LHFC4220,LHFC4220:   * 270
                          LHFC4060,LHFC4060,LHFC4060,LHFC4060,LHFC4060:   * 275
                          LHFC4060,LHFC4060,LHFC4060,LHFC4060,LHFC4060:   * 280
                          LHFC4060,LHFC4060,LHFC4060,LHFC4060,LHFC4060:   * 285
                          LHFC4060,LHFC4030,LHFC4030,LHFC4990,LHFC4990:   * 290
                          LHFC4990,LHFC4990,LHFC4990,LHFC4050,LHFC5020:   * 295
                          LHFC4990,LHFC4990,LHFC4990,LHFC4100,LHFC4100:   * 300
                          LHFC4025,LHFC4025,LHFC4025,LHFC4025,LHFC4025:   * 305
                          LHFC4025,LHFC4030,LHFC4030,LHFC4030,LHFC4030:   * 310
                          LHFC4030,LHFC4110,LHFC4110,LHFC4110,LHFC4110:   * 315
                          LHFC4030,LHFC4225,LHFC4150,LHFC4150,LHFC4160:   * 320
                          LHFC4020,LHFC4030,LHFC4030,LHFC4050,LHFC4150:   * 325
                          LHFC4030,LHFC4030,LHFC4100,LHFC4100,LHFC5060:   * 330
                          LHFC5060,LHFC5060,LHFC5060,LHFC4120,LHFC4215:   * 335
                          LHFC4215,LHFC4215,LHFC4215,LHFC4215,LHFC4100:   * 340
                          LHFC4150,LHFC4150,LHFC4150
.
          GOTO      LHFC1000                                           *C-57547
.
. ----- Date - MM/DD/YY -----
.
LHFC4010  MOVE      "99/99/99",VARIABLE
          GOTO      LHFC7000
.
. ----- Date - MM/DD/CCYY -----
.
LHFC4020  MOVE      "99/99/9999",VARIABLE
          GOTO      LHFC7000
.
. ----- Time - 99:99 -----                                             *C-57547
.
LHFC4025  MOVE      "99:99",VARIABLE
          GOTO      LHFC7000
.
. ----- Alpha Numeric - Dim 1 -----
.
LHFC4030  MOVE      "X",VARIABLE
          GOTO      LHFC7000
.
. ----- Alpha Numeric - Dim 2 -----
.
LHFC4040  MOVE      "XX",VARIABLE
          GOTO      LHFC7000
.
. ----- Alpha Numeric - Dim 3 -----
.
LHFC4050  MOVE      "XXX",VARIABLE
          GOTO      LHFC7000
.
. ----- Alpha Numeric - Dim 4 -----
.
LHFC4060  MOVE      "XXXX",VARIABLE
          GOTO      LHFC7000
.
. ----- Alpha Numeric - Dim 5 -----
.
LHFC4070  MOVE      "XXXXX",VARIABLE
          GOTO      LHFC7000
.
. ----- Alpha Numeric - Dim 6 -----
.
LHFC4080  MOVE      "XXXXXX",VARIABLE
          GOTO      LHFC7000
.
. ----- Alpha Numeric - Dim 7 -----
.
LHFC4090  MOVE      "XXXXXXX",VARIABLE
          GOTO      LHFC7000
.
. ----- Alpha Numeric - Dim 8 -----
.
LHFC4100  MOVE      "XXXXXXXX",VARIABLE
          GOTO      LHFC7000
.
. ----- Alpha Numeric - Dim 9 -----
.
LHFC4110  MOVE      "XXXXXXXXX",VARIABLE
          GOTO      LHFC7000
.
. ----- Alpha Numeric - Dim 10 -----
.
LHFC4120  MOVE      "XXXXXXXXXX",VARIABLE
          GOTO      LHFC7000
.
. ----- Alpha Numeric - Dim 12 -----
.
LHFC4130  MOVE      "XXXXXXXXXXXX",VARIABLE
          GOTO      LHFC7000
.
. ----- Alpha Numeric - Dim 15 -----
.
LHFC4140  MOVE      "XXXXXXXXXXXXXXX",VARIABLE
          GOTO      LHFC7000
.
. ----- Alpha Numeric - Dim 20 -----
.
LHFC4150  MOVE      "XXXXXXXXXXXXXXXXXXXX",VARIABLE
          GOTO      LHFC7000
.
. ----- Alpha Numeric - Dim 25 -----
.
LHFC4160  MOVE      "XXXXXXXXXXXXXXXXXXXXXXXXX",VARIABLE
          GOTO      LHFC7000
.
. ----- Alpha Numeric - Dim 30 -----
.
LHFC4170  MOVE      "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",VARIABLE
          GOTO      LHFC7000
.
. ----- Alpha Numeric - Dim 35 -----
.
LHFC4180  MOVE      "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",VARIABLE
          GOTO      LHFC7000
.
. ----- Alpha Numeric - Dim 40 -----
.
LHFC4190  MOVE      "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",VARIABLE
          GOTO      LHFC7000
.
. ----- Alpha Numeric - Dim 50 -----
.
LHFC4200  CLEAR     VARIABLE
          APPEND    "XXXXXXXXXXXXXXXXXXXXXXXXX",VARIABLE
          APPEND    "XXXXXXXXXXXXXXXXXXXXXXXXX",VARIABLE
          RESET     VARIABLE
          GOTO      LHFC7000
.
. ----- Alpha Numeric - Dim 65 -----
.
LHFC4210  CLEAR     VARIABLE
          APPEND    "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",VARIABLE
          APPEND    "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",VARIABLE
          RESET     VARIABLE
          GOTO      LHFC7000
.
. ----- Alpha Numeric - Dim 60 -----                                   *I-57547
.
LHFC4215  CLEAR     VARIABLE
          APPEND    "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",VARIABLE
          APPEND    "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",VARIABLE
          RESET     VARIABLE
          GOTO      LHFC7000
.
. ----- Alpha Numeric - Dim 70 -----
.
LHFC4220  CLEAR     VARIABLE
          APPEND    "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",VARIABLE
          APPEND    "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",VARIABLE
          RESET     VARIABLE
          GOTO      LHFC7000
.
. ----- Alpha Numeric - Dim 80 -----                                   *I-57547
.
LHFC4225  CLEAR     VARIABLE
          APPEND    "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",VARIABLE
          APPEND    "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",VARIABLE
          RESET     VARIABLE
          GOTO      LHFC7000
.
. ----- Numeric - Form 1 -----
.
LHFC4990  MOVE      "9",VARIABLE
          GOTO      LHFC7000
.
. ----- Numeric - Form 2 -----
.
LHFC5000  MOVE      "99",VARIABLE
          GOTO      LHFC7000
.
. ----- Numeric - Form 3 -----
.
LHFC5010  MOVE      "999",VARIABLE
          GOTO      LHFC7000
.
. ----- Numeric - Form 4 -----
.
LHFC5020  MOVE      "9999",VARIABLE
          GOTO      LHFC7000
.
. ----- Numeric - Form 5 -----
.
LHFC5025  MOVE      "99999",VARIABLE
          GOTO      LHFC7000
.
. ----- Numeric - Form 6 -----
.
LHFC5030  MOVE      "999999",VARIABLE
          GOTO      LHFC7000
.
. ----- Numeric - Form 8 -----
.
LHFC5040  MOVE      "99999999",VARIABLE
          GOTO      LHFC7000
.
. ----- Numeric - Form 8.2 -----
.
LHFC5050  MOVE      "99999999.99",VARIABLE
          GOTO      LHFC7000
.
. ----- Numeric - Form 6.2 -----
.
LHFC5060  MOVE      "999999.99",VARIABLE
          GOTO      LHFC7000
.
. ----- Format the variable -----
.
LHFC7000  RESET     VARIABLE,IBDTPLEN
          LENSET    VARIABLE
          RESET     VARIABLE
          PRINT     *IBDTCOL,*+,VARIABLE;
          GOTO      LHFC1000                * Read next record
.
. ----- End of HFCF, Print new lines until the end of page is reached -----
.
LHFC9000  COMPARE   CURRROW,IBTHLENG        * Test page length
          GOTO      LHFC9999 IF LESS
.
          PRINT     *N;
          ADD       ONE,CURRROW
          GOTO      LHFC9000
.
LHFC9999  CALL      CLSPRINT                * Close the spool file
          GOTO      ENDLHFCF
.
          INC       IBATMDIO/INC
          INC       IBATMHIO/INC
          INC       IBAOVRIO/INC
.
ENDLHFCF  ENDPROC                           * Finished
+
.*******************************************************************************
.*                                  PHFC0000                                   *
.*                        Print Health Fund Claim Form                         *
.*******************************************************************************
.
          DEFPROC   PHFC0000
.
          INC       OPRCONFD/INC
          INC       OPRDEAFD/INC
          INC       OPRDECFD/INC
          INC       PATDTRFD/INC
          INC       PATDADFD/INC
          INC       PATECDFD/INC
          INC       PATECOFD/INC
          INC       PATICDFD/INC
          INC       PATICOFD/INC
          INC       PATICUFD/INC
          INC       PATPGRFD/INC
          INC       PATMMBFD/INC
          INC       PATTRNFD/INC
          INC       PATVADFD/INC
          INC       PATHFCVR/INC
.         INC       PATDO1FD/INC
.         INC       PATHSPFD/INC
.         INC       PMSVX1FD/INC
          INC       PATIN1FD/INC            * Insurance file
          INC       PMSRESFD/INC            * Patient Residence Details file
          INC       IBATMHFD/INC
          INC       IBATMDFD/INC
          INC       IBAVARFD/INC
+
VARIABLE  DIM       127
DTYR2019  DIM       8
DTYR2020  DIM       8
.
SP27      INIT      "                           "
SP100     INIT      "                                                  ":
                    "                                                  "
ZED10     INIT      "zzzzzzzzzz"
+
PHFC0000  OPEN      PATDADA1,"patdadaf"
          OPEN      PATDTRA1,"patdtraf"
          OPEN      PATECDA1,"patecdaf"
          OPEN      PATECDA2,"patecdaf"
          OPEN      PATECOA1,"patecoaf"
          OPEN      PATECOA2,"patecoaf"
          OPEN      PATICUA1,"paticuaf"
          OPEN      PATMMBS1,"patmmbsf"
          OPEN      PATTRAN2,"pattranf"
          OPEN      PATVADA1,"patvadaf"
          OPEN      IBATMHA1,"ibatmhaf"
          OPEN      IBATDET1,"ibatmdaf"
.         OPEN      PMSVX1A1,"pmsvx1af"
.         OPEN      PATHSPA1,"pathspaf"
.         OPEN      PATDO1A1,"patdo1af"
          OPEN      PATIN1A1,"patin1af"      * Insurance Details
          OPEN      PMSRESA1,"pmsresaf"      * Residence Details
.
          MOVE      "20190701",DTYR2019
          MOVE      "20200701",DTYR2020      *T0889652
.
          CALL      OPICO1
          CALL      OPICD1
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      OPRDETA2,"oprdetaf"
          TRAPCLR   IO
          MOVE      OVRCD,OPRFOUND
          BRANCH    OVRCD,PHFC0100
.
          OPEN      OPRDETC1,"oprdetcf"
.
PHFC0100  IF        ASTAT = 3
            MATCH     DDATE,ALACDTE
            IF        @LESS
              MATCH     "PATWEB73",PRGID
              IF        !@EQUAL
.....           DISPLAY   *P1:24,*EL,*B,"Warning: Patient not invoiced ":
.....                     "to discharge date.  ";
                DISPLAY   *P1:23,*EL,*B,"Warning: Patient not invoiced": *90205
                          *P1:24,*EL,"Bed Fees will be blank          "; *90205
                CALL      HITENTER
                DISPLAY   *P1:23,*EL
              ENDIF
            ENDIF
          ELSE
            MATCH     "PATWEB73",PRGID
            IF        !@EQUAL
              DISPLAY   *P1:24,*EL,*B,"Warning: Patient not discharged.  ";
              CALL      HITENTER
            ENDIF
          ENDIF
.
          CALL      CUICF000                * handle interim forms     *I-90205
.
          MOVE      ZERO,DSCHFLAG           * initialise discharge flag
          MOVE      ZERO,SAVRATE            *     "      saved daily rate
          MOVE      SP1,SAVACOM             *     "      saved accomm. code
          MOVE      ZERO,FRSTFLAG           *     "      loop flag
          MOVE      ONE,CPAGENO             *     "      page count
          MOVE      SP30,SAVKEY30
          MOVE      ZERO,DTGTNTRD           * Dont get next tran record - no
.
          MOVE      ZERO,CHGCONTR
          MOVE      ZERO,SKIPFLAG
          MOVE      SP70,SAVDATE
.
          CALL      IBACLOCK                * get current date - century
.                                             required for transfer dates
          CALL      OPNPRINT                * Open spool file
          MOVE      ZERO,TRANFLAG           * set to no transfer fields found
          MOVE      ZERO,MMBSFLAG           * set to no transfer fields found
          MOVE      ZERO,SERVFLAG           * set to no transfer fields found
          MOVE      ZERO,DIAGFLAG           * flag for Diagnosis
          MOVE      ZERO,PROCFLAG           * flag for Procedures
          MOVE      ZERO,COUNT
          MOVE      ZERO,THETIMES           * set to no Theater times  *C-V-015
          MOVE      ZERO,BABYFLAG           * set to 6 when finished   *I-62428
          MOVE      SP30,PREVSTTM           * MBS theatre time         *C-V-015
.
          MOVE      SP70,DTRDATE
          MOVE      SP70,DTRIDESC
          MOVE      SP70,DTRITEM
          MOVE      ZERO,DTRAMTT
.
          MOVE      ZERO,DAYCLAIM[1]
          MOVE      ZERO,DAYCLAIM[2]
          MOVE      ZERO,DAYCLAIM[3]
          MOVE      ZERO,DAYCLAIM[4]
.
          CALL      GTCER000
.
          PACK      KEY6,STATNCOD           * re-read header file
          CALL      RDIBTH1
.
          PACK      KEY12,STATNCOD,SP20     * re-read first detail field
          CALL      RSIBDET1
          CALL      RKIBDET1
.
PHFC0200  MOVE      ONE,CURRROW             * Initialize current row counter
PHFC0500  COMPARE   CURRROW,IBDTROW         * Current row up to required row ?
          GOTO      PHFC2000 IF EQUAL       * Yes - print data
          PRINT     *N;                     * Else print 1 extra line
          ADD       ONE,CURRROW             * Increment counter
          GOTO      PHFC0500                * Check counter again
.
. ----- Read through the details file -----
.
PHFC1000  CALL      RKIBDET1                * Read next detail record
          BRANCH    OVRCD,PHFC9000          * No more records - pad out form
.
          MATCH     STATNCOD,IBDTSCOD       * Same form ?
          GOTO      PHFC9000 IF NOT EQUAL   * No - pad out rest of form
.
PHFC1500  COMPARE   CURRROW,IBDTROW         * Are we at the required row ?
          GOTO      PHFC2000 IF EQUAL       * Yes - print data
          PRINT     *N;                     * Else pad out to required row
          ADD       ONE,CURRROW             * One more row printed
          GOTO      PHFC1500                * Check row count
.
. ----- Print actual data lines -----
.
PHFC2000  BRANCH    IBDTINDC,PHFC3000:      * Text field
                             PHFC4000       * Data field
.
. ----- Print text field -----
.
PHFC3000  
.         BRANCH    FRSTFLAG,PHFC1000       * not first loop so dont print text
.
          RESET     IBDTTXFL,IBDTPLEN
          LENSET    IBDTTXFL
          RESET     IBDTTXFL
          PRINT     *IBDTCOL,*+,IBDTTXFL;   * Print data
          MOVE      IBDTROW,CURRROW         * Row printed is current row
          GOTO      PHFC1000                * Read next record
.
. ----- Print data field -----
.
PHFC4000  MOVE      IBDTTXFL,KEY5           * Data number 1st 3 chars of field
          MOVE      KEY5,FORM5              * Move to a FORM field for BRANCH
.
.                                           * Flag values - 5=more, 6=eof
          COMPARE   FIVE,TRANFLAG           * have we printed 4 ACCOM lines?
          CALL      CKTRN000 IF LESS        * No - read next transfer record
.
          COMPARE   FIVE,MMBSFLAG           * have we printed 4 MBS lines?
          CALL      CKMBS000 IF LESS        * No - read next MBS record
.
          COMPARE   FIVE,SERVFLAG           * have we printed 4 Serv. lines?
          CALL      CKSER000 IF LESS        * No - read next transfer record
.
          COMPARE   FOUR,THETIMES           * have we printed 3 Thet.  *C-V-015
          CALL      CKTHT000 IF LESS        * No - read next Thet record
.
          COMPARE   ONE,BABYFLAG            * read linked babies?      *I-62428
          CALL      NEWBB000 IF LESS        * No - read them           *I-62428
.
          PACK      VARIABLE,SP100,SP27     * Initialize variable
          BRANCH    FORM5,PHFC4010,PHFC4020,PHFC4030,PHFC4040,PHFC4050:   *   5
                          PHFC4060,PHFC4070,PHFC4080,PHFC4090,PHFC4100:   *  10
                          PHFC4110,PHFC4120,PHFC4130,PHFC4140,PHFC4150:   *  15
                          PHFC4160,PHFC4170,PHFC4180,PHFC4190,PHFC4200:   *  20
                          PHFC4210,PHFC4220,PHFC4230,PHFC4240,PHFC4250:   *  25
                          PHFC4260,PHFC4270,PHFC4280,PHFC4290,PHFC4300:   *  30
                          PHFC4310,PHFC4320,PHFC4330,PHFC4340,PHFC4350:   *  35
                          PHFC4360,PHFC4370,PHFC4380,PHFC4390,PHFC4400:   *  40
                          PHFC4410,PHFC4420,PHFC4430,PHFC4440,PHFC4450:   *  45
                          PHFC4460,PHFC4470,PHFC4480,PHFC4490,PHFC4500:   *  50
                          PHFC4510,PHFC4520,PHFC4530,PHFC4540,PHFC4550:   *  55
                          PHFC4560,PHFC4570,PHFC4580,PHFC4590,PHFC4600:   *  60
                          PHFC4610,PHFC4620,PHFC4630,PHFC4640,PHFC4650:   *  65
                          PHFC4660,PHFC4670,PHFC4680,PHFC4690,PHFC4700:   *  70
                          PHFC4710,PHFC4720,PHFC4730,PHFC4740,PHFC4720:   *  75
                          PHFC4730,PHFC4740,PHFC4720,PHFC4730,PHFC4740:   *  80
                          PHFC4720,PHFC4730,PHFC4740,PHFC4840,PHFC4850:   *  85
                          PHFC4860,PHFC4870,PHFC4880,PHFC4890,PHFC4900:   *  90
                          PHFC4910,PHFC4920,PHFC4930,PHFC4940,PHFC4950:   *  95
                          PHFC4960,PHFC4970,PHFC4980,PHFC4990,PHFC5000:   * 100
                          PHFC5010,PHFC5020,PHFC5030,PHFC5040,PHFC5050:   * 105
                          PHFC5060,PHFC5070,PHFC5080,PHFC5090,PHFC5100:   * 110
                          PHFC5110,PHFC5120,PHFC5130,PHFC5140,PHFC5150:   * 115
                          PHFC5160,PHFC5170,PHFC5180,PHFC5190,PHFC5200:   * 120
                          PHFC5210,PHFC5220,PHFC5230,PHFC5240,PHFC5250:   * 125
                          PHFC5260,PHFC5270,PHFC5280,PHFC5290,PHFC5300:   * 130
                          PHFC5310,PHFC5320,PHFC5330,PHFC5340,PHFC5350:   * 135
                          PHFC5360,PHFC5370,PHFC5380,PHFC5390,PHFC5400:   * 140
                          PHFC5410,PHFC5420,PHFC5430,PHFC5440,PHFC5450:   * 145
                          PHFC5460,PHFC5470,PHFC5480,PHFC5420,PHFC5430:   * 150
                          PHFC5440,PHFC5450,PHFC5460,PHFC5470,PHFC5480:   * 155
                          PHFC5420,PHFC5430,PHFC5440,PHFC5450,PHFC5460:   * 160
                          PHFC5470,PHFC5480,PHFC5420,PHFC5430,PHFC5440:   * 165
                          PHFC5450,PHFC5460,PHFC5470,PHFC5480,PHFC5500:   * 170
                          PHFC5520,PHFC5950,PHFC5960,PHFC5970,PHFC5980:   * 175
                          PHFC5620,PHFC5640,PHFC5660,PHFC5680,PHFC5700:   * 180
                          PHFC5720,PHFC5730,PHFC5740,PHFC5750,PHFC5760:   * 185
                          PHFC5730,PHFC5740,PHFC5750,PHFC5760,PHFC5730:   * 190
                          PHFC5740,PHFC5750,PHFC5760,PHFC5730,PHFC5740:   * 195
                          PHFC5750,PHFC5760,PHFC5770,PHFC5780,PHFC5790:   * 200
                          PHFC5800,PHFC5810,PHFC5820,PHFC5820,PHFC5820:   * 205
                          PHFC5820,PHFC5830,PHFC5840,PHFC5850,PHFC5860:   * 210
                          PHFC5870,PHFC5880,PHFC5890,PHFC5900,PHFC5910:   * 215
                          PHFC5920,PHFC5930,PHFC5940,PHFC5990,PHFC6000:   * 220
                          PHFC6010,PHFC6020,PHFC6030,PHFC6040,PHFC6050:   * 225
                          PHFC6060,PHFC6070,PHFC6080,PHFC6090,PHFC6100:   * 230
                          PHFC6110,PHFC6120,PHFC6130,PHFC6140,PHFC6150:   * 235
                          PHFC6160,PHFC6170,PHFC6180,PHFC6190,PHFC6200:   * 240
                          PHFC6210,PHFC6220,PHFC6230,PHFC6240,PHFC6250:   * 245
                          PHFC6260,PHFC6270,PHFC6280,PHFC6290,PHFC6300:   * 250
                          PHFC6310,PHFC6320,PHFC6330,PHFC6340,PHFC6350:   * 255
                          PHFC6360,PHFC6370,PHFC6380,PHFC6390,PHFC6400:   * 260
                          PHFC6410,PHFC6420,PHFC6430,PHFC6440,PHFC6450:   * 265
                          PHFC6460,PHFC6470,PHFC6480,PHFC6490,PHFC6500:   * 270
                          PHFC6510,PHFC6520,PHFC6530,PHFC6540,PHFC6550:   * 275
                          PHFC6560,PHFC6570,PHFC6580,PHFC6590,PHFC6600:   * 280
                          PHFC6610,PHFC6620,PHFC6630,PHFC6640,PHFC6650:   * 285
                          PHFC6660,PHFC6670,PHFC6680,PHFC6690,PHFC6690:   * 290
                          PHFC6690,PHFC6690,PHFC6700,PHFC6710,PHFC6720:   * 295
                          PHFC6730,PHFC6740,PHFC6750,PHFC6760,PHFC6770:   * 300
                          PHFC6780,PHFC6790,PHFC6780,PHFC6790,PHFC6780:   * 305
                          PHFC6790,PHFC6800,PHFC6810,PHFC6820,PHFC6830:   * 310
                          PHFC6840,PHFC6850,PHFC6850,PHFC6850,PHFC6850:   * 315
                          PHFC6860,PHFC6870,PHFC6880,PHFC6890,PHFC6900:   * 320
                          PHFC6910,PHFC6920,PHFC6930,PHFC6940,PHFC6950:   * 325
                          PHFC6960,PHFC6970,PHFC6980,PHFC6990,PHFC5480:   * 330
                          PHFC5480,PHFC5480,PHFC5480,PHFC6995,PHFC6995:   * 335
                          PHFC6995,PHFC6995,PHFC6995,PHFC6995,PHFC6995:   * 340
                          PHFC6995,PHFC6995,PHFC7000,PHFC7005,PHFC7010:   * 345
                          PHFC7015,PHFC7020,PHFC7025,PHFC7030,PHFC7035:   * 350
                          PHFC7040,PHFC7045,PHFC7050,PHFC7055,PHFC7060:   * 355
                          PHFC7065,PHFC7070,PHFC7075,PHFC7080,PHFC7085:   * 360
                          PHFC7090,PHFC7095,PHFC7100,PHFC7105,PHFC7110:   * 365
                          PHFC7115,PHFC7120,PHFC7125,PHFC7130,PHFC7135:   * 370
                          PHFC7140,PHFC7145,PHFC7150,PHFC7155,PHFC7160:   * 375
                          PHFC7165,PHFC7170,PHFC7175,PHFC7180,PHFC7185:   * 380
                          PHFC7190,PHFC7195,PHFC7200,PHFC7205,PHFC7210:   * 385
                          PHFC7215,PHFC7220,PHFC7225,PHFC7230,PHFC7235:   * 390
                          PHFC7240,PHFC7245,PHFC7250,PHFC7255,PHFC7260:   * 395
                          PHFC7265,PHFC7270,PHFC7280,PHFC7290,PHFC7300:   * 400
                          PHFC7310,PHFC7315,PHFC7320,PHFC7325,PHFC7330:   * 405
                          PHFC7335,PHFC7340
.
          GOTO            PHFC1000                                     *C-57547
.
. ----- Hospital name -----
.
PHFC4010  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      CNAME,VARIABLE
          IF        IBCNMHOS=1
            PACK      VARIABLE,PTHSNAME,SP70
          ENDIF
          GOTO      PHFC7500
.
. ----- Hospital approval number -----
.
PHFC4020  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      CAPPRVNO,VARIABLE
          IF        IBCNMHOS=1
            PACK      VARIABLE,PTHSAPPR,SP70
          ENDIF
          GOTO      PHFC7500
.
. ----- Hospital file number -----
.
PHFC4030  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      CFILENO,VARIABLE
          GOTO      PHFC7500
.
. ----- Hospital address line 1 -----
.
PHFC4040  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      CHADD1,VARIABLE
          GOTO      PHFC7500
.
. ----- Hospital address line 2 -----
.
PHFC4050  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      CHADD2,VARIABLE
          GOTO      PHFC7500
.
. ----- Hospital postcode -----
.
PHFC4060  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      CHPOST,VARIABLE
          GOTO      PHFC7500
.
. ----- Hospital postal address line 1 -----
.
PHFC4070  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      CHPADD1,VARIABLE
          GOTO      PHFC7500
.
. ----- Hospital postal address line 2 -----
.
PHFC4080  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      CHPADD2,VARIABLE
          GOTO      PHFC7500
.
. ----- Hospital postal postcode -----
.
PHFC4090  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      CHPPOST,VARIABLE
          GOTO      PHFC7500
.
. ----- Patient U/R number -----
.
PHFC4100
          MOVE      AURNO,VARIABLE
          MOVE      EIGHT,PRNTSTRT
          SUB       IBDTPLEN,PRNTSTRT
          GOTO      PHFC8000
.
. ----- Patient admission number -----
.
PHFC4110  
.         BRANCH    FRSTFLAG,PHFC1000
.
          MOVE      AADMNO,VARIABLE
          MOVE      EIGHT,PRNTSTRT
          SUB       IBDTPLEN,PRNTSTRT
          GOTO      PHFC8000
.
. ----- Patient's last invoice number -----
.
PHFC4120  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      AADMNO,PINVADM
          PACK      KEY16,PINVADM,ZED10
          CALL      RDSINV3                 * Position at the end of the invoice
.                                             to get the last invoice number
PHFC4121  CALL      RDPINV3                 * Read the invoice file
          IF        OVRCD=1
            MOVE      ZERO,PINVNO
          ENDIF
          MATCH     AADMNO,PINVADM
          IF        !@EQUAL 
            MOVE      ZERO,PINVNO
          ENDIF
.
          COMPARE   TWO,PINVTYP             * "Patient Portion" Invoice?
          GOTO      PHFC4121 IF EQUAL       * then bypass              *I-65745
.
          MOVE      PINVNO,VARIABLE
          IF        INVFLAG > 0
            MOVE      HFCFINVN,VARIABLE
          ENDIF
.
          MOVE      EIGHT,PRNTSTRT
          SUB       IBDTPLEN,PRNTSTRT
          GOTO      PHFC8000
.
. ----- Patient title -----
.
PHFC4130  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      PTITL,VARIABLE
          GOTO      PHFC7500
.
. ----- Patient given name -----
.
PHFC4140  MOVE      PGNAME,VARIABLE
          GOTO      PHFC7500
.
. ----- Patient surname -----
.
PHFC4150  MATCH     SP70,PTMASNAM
          IF        !@EQUAL
            MOVE      PTMASNAM,VARIABLE        * Surname
          ELSE
            MOVE      PSNAME,VARIABLE          * Surname
          ENDIF
          GOTO      PHFC7500
.
. ----- Formatted patient's name -----
.
PHFC4160  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      PSNAME,PACSNAME
          MOVE      PGNAME,PACGNAME
          MOVE      PTITL,PACTITLE
          MOVE      TWO,PACFRMT
          CALL      PACNAME                 * Format patient's name
          MOVE      PACFNAME,VARIABLE
          GOTO      PHFC7500
.
. ----- Patient address line 1 -----
.
PHFC4170  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      PADD1,VARIABLE
          GOTO      PHFC7500
.
. ----- Patient address line 2 -----
.
PHFC4180  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      PADD2,VARIABLE
          GOTO      PHFC7500
.
. ----- Patient address line 3 (suburb) -----
.
PHFC4190  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      PSUBRB,VARIABLE
          GOTO      PHFC7500
.
. ----- Patient postcode -----
.
PHFC4200  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      PPOST,VARIABLE
          GOTO      PHFC7500
.
. ----- Patient home telephone -----
.
PHFC4210  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      PTELEP,VARIABLE
          GOTO      PHFC7500
.
. ----- Patient work telephone -----
.
PHFC4220  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      PTELEB,VARIABLE
          GOTO      PHFC7500
.
. ----- Patient birth date -----
.
PHFC4230  
.         BRANCH    FRSTFLAG,PHFC1000
          UNPACK    PBDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE                 * Format patient's birth date
          MOVE      CPCDATE,VARIABLE
          GOTO      PHFC7500
.
. ----- Patient day of birth -----
.
PHFC4240  
.         BRANCH    FRSTFLAG,PHFC1000
          UNPACK    PBDATE,XCENT,XYEAR,XMON,XDAY
          MOVE      XDAY,VARIABLE
          GOTO      PHFC7500
.
. ----- Patient month of birth -----
.
PHFC4250  
.         BRANCH    FRSTFLAG,PHFC1000
          UNPACK    PBDATE,XCENT,XYEAR,XMON,XDAY
          MOVE      XMON,VARIABLE
          GOTO      PHFC7500
.
. ----- Patient year of birth -----
.
PHFC4260  
.         BRANCH    FRSTFLAG,PHFC1000 
          UNPACK    PBDATE,XCENT,XYEAR,XMON,XDAY
          IF        IBDTPLEN = 2
            MOVE      XYEAR,VARIABLE
          ELSE
            PACK      VARIABLE,XCENT,XYEAR
          ENDIF
          GOTO      PHFC7500
.
. ----- Patient age at admission -----
.
PHFC4270  
.         BRANCH    FRSTFLAG,PHFC1000
          PACK      AGEDATE,ADATE
          CALL      CALCAGE                 * Calculate patients age at admin
          IF        PSAGEDAY<365
            MOVE      ZERO,FORM3
            MOVE      PSAGEDAY,FORM3
            PACK      VARIABLE,FORM3,CHARD * < 1 year old, use days
            MOVE      "4",IBDTPLEN
            GOTO      PHFC7500
          ELSE
            MOVE      PSAGEYRS,VARIABLE     * > 1 year old, use years
            MOVE      THREE,PRNTSTRT
            SUB       IBDTPLEN,PRNTSTRT
          ENDIF
          GOTO      PHFC8000
.
. ----- Patient sex -----
.
PHFC4280  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      PSEX,VARIABLE
          GOTO      PHFC7500
.
. ----- 'X' if male -----
.
PHFC4290  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      PSEX,VARIABLE
          GOTO      PHFC7500
.
. ----- 'X' if female -----
.
PHFC4300  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      PSEX,VARIABLE
          GOTO      PHFC7500
.
. ----- Health fund code -----
.
PHFC4310  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      AFUNDH,VARIABLE
          GOTO      PHFC7500
.
. ----- Health fund code description -----
.
PHFC4320  
.         BRANCH    FRSTFLAG,PHFC1000       * commented out, display on multiple pages
          PACK      KEY14,AFUNDH,ZERO4,SP10
          CALL      RDFUND1                 * Read the health fund file
          IF        OVRCD=1
            GOTO      PHFC7500
          ENDIF
          MOVE      HFNAME,VARIABLE
          GOTO      PHFC7500
.
. ----- Health fund table code -----
.
PHFC4330  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      AFNDTB,VARIABLE
          GOTO      PHFC7500
.
. ----- Health fund table code description -----
.
PHFC4340  
.         BRANCH    FRSTFLAG,PHFC1000
          PACK      KEY14,AFUNDH,AFNDTB,SP10
          CALL      RDFUND1                 * Read the health fund file
          IF        OVRCD=1
            GOTO      PHFC7500
          ENDIF
          MOVE      HFNAME,VARIABLE
          GOTO      PHFC7500
.
. ----- Health fund membership number -----
.
PHFC4350  
.         BRANCH    FRSTFLAG,PHFC1000
          MATCH     SP70,PMVXFNDM
          IF        @EQUAL
            MOVE      AFNDMM,VARIABLE
          ELSE
            MOVE      PMVXFNDM,VARIABLE
          ENDIF
          GOTO      PHFC7500
.
. ----- 'X' if day case -----
.
PHFC4360  
.         BRANCH    FRSTFLAG,PHFC1000
          IF        ASTAT<>3
            GOTO      PHFC7500
          ENDIF
.
          MATCH     ADATE,DDATE
          IF        @EQUAL
            MOVE      ANSX,VARIABLE
          ENDIF
          GOTO      PHFC7500
.
. ----- 'X' if overnight -----
.
PHFC4370  
.         BRANCH    FRSTFLAG,PHFC1000
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MATCH     KEY8,ADATE
          IF        !@LESS
            GOTO      PHFC7500
          ENDIF
          MATCH     ADATE,DDATE
          IF        !@EQUAL
            MOVE      ANSX,VARIABLE
          ENDIF
          GOTO      PHFC7500
.
. ----- Admission date -----
.
PHFC4380  
.         BRANCH    FRSTFLAG,PHFC1000
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE                 * Format admission date
          IF        IBDTPLEN = 8
            MOVE      CPDATE,VARIABLE
          ELSE
            MOVE      CPCDATE,VARIABLE
          ENDIF
          GOTO      PHFC7500
.
. ----- Day of admission -----
.
PHFC4390  
.         BRANCH    FRSTFLAG,PHFC1000
          UNPACK    ADATE,XCENT,XYEAR,XMON,XDAY
          MOVE      XDAY,VARIABLE
          GOTO      PHFC7500
.
. ----- Month of admission -----
.
PHFC4400  
.         BRANCH    FRSTFLAG,PHFC1000
          UNPACK    ADATE,XCENT,XYEAR,XMON,XDAY
          MOVE      XMON,VARIABLE
          GOTO      PHFC7500
.
. ----- Year of admission -----
.
PHFC4410  
.         BRANCH    FRSTFLAG,PHFC1000
          UNPACK    ADATE,XCENT,XYEAR,XMON,XDAY
          IF        IBDTPLEN = 2
            MOVE      XYEAR,VARIABLE
          ELSE
            PACK      VARIABLE,XCENT,XYEAR
          ENDIF
          GOTO      PHFC7500
.
. ----- Discharge date -----
.
PHFC4420  
.         BRANCH    FRSTFLAG,PHFC1000
          IF        ASTAT<>3
            GOTO      PHFC7500              * No discharge record
          ENDIF
          UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE                 * Format admission date
          IF        IBDTPLEN = 8
            MOVE      CPDATE,VARIABLE
          ELSE
            MOVE      CPCDATE,VARIABLE
          ENDIF
          GOTO      PHFC7500
.
. ----- Day of discharge -----
.
PHFC4430  
.         BRANCH    FRSTFLAG,PHFC1000
          IF        ASTAT<>3
            GOTO      PHFC7500              * No discharge record
          ENDIF
          UNPACK    DDATE,XCENT,XYEAR,XMON,XDAY
          MOVE      XDAY,VARIABLE
          GOTO      PHFC7500
.
. ----- Month of discharge -----
.
PHFC4440  
.         BRANCH    FRSTFLAG,PHFC1000
          IF        ASTAT<>3
            GOTO      PHFC7500              * No discharge record
          ENDIF
          UNPACK    DDATE,XCENT,XYEAR,XMON,XDAY
          MOVE      XMON,VARIABLE
          GOTO      PHFC7500
.
. ----- Year of discharge -----
.
PHFC4450  
.         BRANCH    FRSTFLAG,PHFC1000
          IF        ASTAT<>3
            GOTO      PHFC7500              * No discharge record
          ENDIF
          UNPACK    DDATE,XCENT,XYEAR,XMON,XDAY
          IF        IBDTPLEN = 2
            MOVE      XYEAR,VARIABLE
          ELSE
            PACK      VARIABLE,XCENT,XYEAR
          ENDIF
          GOTO      PHFC7500
.
. ----- Time of admission -----
.       Only printed for a same day patient
.
PHFC4460  
.         BRANCH    FRSTFLAG,PHFC1000
.
          CALL      SAMDY000                     * same day patient ?
          BRANCH    EXIT,PHFC1000                * no - ignore
.
          MOVE      ATIME,KEY5
          MOVE      KEY5,VARIABLE
          GOTO      PHFC7500
.
. ----- Time of discharge -----
.       Only printed for a same day patient
.
PHFC4470  
.         BRANCH    FRSTFLAG,PHFC1000
.
          CALL      SAMDY000                     * same day patient ?
          BRANCH    EXIT,PHFC1000                * no - ignore
.
          MOVE      DTIME,KEY5
          MOVE      KEY5,VARIABLE
          GOTO      PHFC7500
.
. ----- Attending doctor name (admission) -----
.
PHFC4480  
.         BRANCH    FRSTFLAG,PHFC1000
          CALL      DOCTAD00                * Get the doctors record for this
.                                             admission
          BRANCH    EXIT,PHFC7500
.
          MOVE      DSNAME,PACSNAME
          MOVE      DGNAME,PACGNAME
          MOVE      DTITL,PACTITLE
          MOVE      TWO,PACFRMT
          CALL      PACNAME                 * Format doctors name
          MOVE      PACFNAME,VARIABLE
          GOTO      PHFC7500
.
. ----- Attending doctor phone number (admission) -----
.
PHFC4490  
.         BRANCH    FRSTFLAG,PHFC1000
          CALL      DOCTAD00                * Get the doctors record for this
.                                             admission
          BRANCH    EXIT,PHFC7500
.
          MOVE      DTELES,VARIABLE
          GOTO      PHFC7500
.
. ----- Attending doctor surgery address line 1 (admission) -----
.
PHFC4500  
.         BRANCH    FRSTFLAG,PHFC1000
          CALL      DOCTAD00                * Get the doctors record for this
.                                             admission
          BRANCH    EXIT,PHFC7500
.
          MOVE      DSADD1,VARIABLE
          GOTO      PHFC7500
.
. ----- Attending doctor surgery address line 2 (admission) -----
.
PHFC4510  
.         BRANCH    FRSTFLAG,PHFC1000
          CALL      DOCTAD00                * Get the doctors record for this
.                                             admission
          BRANCH    EXIT,PHFC7500
.
          MOVE      DSADD2,VARIABLE
          GOTO      PHFC7500
.
. ----- Attending doctor surgery address line 3 (admission) -----
.
PHFC4520  
.         BRANCH    FRSTFLAG,PHFC1000
          CALL      DOCTAD00                * Get the doctors record for this
.                                             admission
          BRANCH    EXIT,PHFC7500
.
          MOVE      DSADD3,VARIABLE
          GOTO      PHFC7500
.
. ----- Attending doctor surgery postcode (admission) -----
.
PHFC4530  
.         BRANCH    FRSTFLAG,PHFC1000
          CALL      DOCTAD00                * Get the doctors record for this
.                                             admission
          BRANCH    EXIT,PHFC7500
.
          MOVE      DSPOST,VARIABLE
          GOTO      PHFC7500
.
. ----- Attending doctor name (discharge) -----
.
PHFC4540  
.         BRANCH    FRSTFLAG,PHFC1000
          CALL      DOCTDS00                * Get the doctors record for this
.                                             discharge
          IF        OVRCD=1
            GOTO      PHFC7500
          ENDIF
.
          MOVE      DSNAME,PACSNAME
          MOVE      DGNAME,PACGNAME
          MOVE      DTITL,PACTITLE
          MOVE      TWO,PACFRMT
          CALL      PACNAME                 * Format doctors name
          MOVE      PACFNAME,VARIABLE
          GOTO      PHFC7500
.
. ----- Attending doctor telephone (discharge) -----
.
PHFC4550  
.         BRANCH    FRSTFLAG,PHFC1000
          CALL      DOCTDS00                * Get the doctors record for this
.                                             discharge
          IF        OVRCD=1
            GOTO      PHFC7500
          ENDIF
.
          MOVE      DTELES,VARIABLE
          GOTO      PHFC7500
.
. ----- Attending doctor surgery address line 1 (discharge) -----
.
PHFC4560  
.         BRANCH    FRSTFLAG,PHFC1000
          CALL      DOCTDS00                * Get the doctors record for this
.                                             discharge
          IF        OVRCD=1
            GOTO      PHFC7500
          ENDIF
.
          MOVE      DSADD1,VARIABLE
          GOTO      PHFC7500
.
. ----- Attending doctor surgery address line 2 (discharge) -----
.
PHFC4570  
.         BRANCH    FRSTFLAG,PHFC1000
          CALL      DOCTDS00                * Get the doctors record for this
.                                             discharge
          IF        OVRCD=1
            GOTO      PHFC7500
          ENDIF
.
          MOVE      DSADD2,VARIABLE
          GOTO      PHFC7500
.
. ----- Attending doctor surgery address line 3 (discharge) -----
.
PHFC4580  
.         BRANCH    FRSTFLAG,PHFC1000
          CALL      DOCTDS00                * Get the doctors record for this
.                                             discharge
          IF        OVRCD=1
            GOTO      PHFC7500
          ENDIF
.
          MOVE      DSADD3,VARIABLE
          GOTO      PHFC7500
.
. ----- Attending doctor surgery postcode (discharge) -----
.
PHFC4590  
.         BRANCH    FRSTFLAG,PHFC1000
          CALL      DOCTDS00                * Get the doctors record for this
.                                             discharge
          IF        OVRCD=1
            GOTO      PHFC7500
          ENDIF
.
          MOVE      DSPOST,VARIABLE
          GOTO      PHFC7500
.
. ----- Referring doctor name -----
.
PHFC4600  
.         BRANCH    FRSTFLAG,PHFC1000
          IF        CRDRTYP=1
            MOVE      ARDRNAM,VARIABLE
          ELSE
            PACK      KEY6,ADOCTR
            CALL      RDDOCT1               * Read the doctors file
            IF        OVRCD=1
              GOTO      PHFC7500
            ENDIF
.
            MOVE      DSNAME,PACSNAME
            MOVE      DGNAME,PACGNAME
            MOVE      DTITL,PACTITLE
            MOVE      TWO,PACFRMT
            CALL      PACNAME               * Format doctors name
            MOVE      PACFNAME,VARIABLE
          ENDIF
          GOTO      PHFC7500
.
. ----- Referring doctor telephone -----
.
PHFC4610  
.         BRANCH    FRSTFLAG,PHFC1000
          IF        CRDRTYP<>1
            PACK      KEY6,ADOCTR
            CALL      RDDOCT1               * Read the doctors file
            IF        OVRCD=1
              GOTO      PHFC7500
            ENDIF
.
            MOVE      DTELES,VARIABLE
          ENDIF
          GOTO      PHFC7500
.
. ----- Referring doctor address line 1 -----
.
PHFC4620  
.         BRANCH    FRSTFLAG,PHFC1000
          IF        CRDRTYP<>1
            PACK      KEY6,ADOCTR
            CALL      RDDOCT1               * Read the doctors file
            IF        OVRCD=1
              GOTO      PHFC7500
            ENDIF
.
            MOVE      DSADD1,VARIABLE
          ENDIF
          GOTO      PHFC7500
.
. ----- Referring doctor address line 2 -----
.
PHFC4630  
.         BRANCH    FRSTFLAG,PHFC1000
          IF        CRDRTYP<>1
            PACK      KEY6,ADOCTR
            CALL      RDDOCT1               * Read the doctors file
            IF        OVRCD=1
              GOTO      PHFC7500
            ENDIF
.
            MOVE      DSADD2,VARIABLE
          ENDIF
          GOTO      PHFC7500
.
. ----- Referring doctor address line 3 -----
.
PHFC4640  
.         BRANCH    FRSTFLAG,PHFC1000
          IF        CRDRTYP<>1
            PACK      KEY6,ADOCTR
            CALL      RDDOCT1               * Read the doctors file
            IF        OVRCD=1
              GOTO      PHFC7500
            ENDIF
.
            MOVE      DSADD3,VARIABLE
          ENDIF
          GOTO      PHFC7500
.
. ----- Referring doctor postcode -----
.
PHFC4650  
.         BRANCH    FRSTFLAG,PHFC1000
          IF        CRDRTYP<>1
            PACK      KEY6,ADOCTR
            CALL      RDDOCT1               * Read the doctors file
            IF        OVRCD=1
              GOTO      PHFC7500
            ENDIF
.
            MOVE      DSPOST,VARIABLE
          ENDIF
          GOTO      PHFC7500
.
. ----- Admitting diagnosis line 1 -----
.
PHFC4660  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      ADIAG1,VARIABLE
          GOTO      PHFC7500
.
. ----- Admitting diagnosis line 2 -----
.
PHFC4670  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      ADIAG2,VARIABLE
          GOTO      PHFC7500
.
. ----- Admitting diagnosis code -----
.
PHFC4680  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      AMBS,VARIABLE
          GOTO      PHFC7500
.
. ----- Discharge diagnosis line 1 -----
.
PHFC4690  
.         BRANCH    FRSTFLAG,PHFC1000
          IF        ASTAT<>3
            GOTO      PHFC7500              * No discharge record
          ENDIF
          MOVE      DDIAG,VARIABLE
          GOTO      PHFC7500
.
. ----- Discharge diagnosis line 2 -----
.
PHFC4700  
.         BRANCH    FRSTFLAG,PHFC1000
          IF        ASTAT<>3
            GOTO      PHFC7500              * No discharge record
          ENDIF
          MOVE      DDIAG2,VARIABLE
          GOTO      PHFC7500
.
. ----- Discharge diagnosis code -----
.
PHFC4710  
.         BRANCH    FRSTFLAG,PHFC1000
          IF        ASTAT<>3
            GOTO      PHFC7500              * No discharge record
          ENDIF
          MOVE      DFMBS,VARIABLE
          GOTO      PHFC7500
.
. ----- MBS code -----
.
PHFC4720  COMPARE   SIX,MMBSFLAG
          GOTO      PHFC1000 IF EQUAL
.
          MOVE      DTRITEM,VARIABLE
          GOTO      PHFC7500
.
. ----- MBS Amount Charged -----
.
PHFC4730  COMPARE   SIX,MMBSFLAG
          GOTO      PHFC1000 IF EQUAL
.
          MOVE      DTRAMTT,FORM6P2
          MOVE      FORM6P2,VARIABLE
          GOTO      PHFC7500
.
. ----- 1st MBS Date of Service -----
.
PHFC4740  COMPARE   SIX,MMBSFLAG
          GOTO      PHFC1000 IF EQUAL
.
          UNPACK    DTRDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE                 * Format the MBS date
          IF        IBDTPLEN = 8
            MOVE      CPDATE,VARIABLE
          ELSE
            MOVE      CPCDATE,VARIABLE
          ENDIF
          GOTO      PHFC7500
.
. ----- Version of Grouper -----
.
PHFC4840  BRANCH    FRSTFLAG,PHFC1000
.
          COMPARE   THREE,ASTAT                  * discharged ?
          GOTO      PHFC1000 IF NOT EQUAL        * no
.
          CALL      GETDRG
          MOVE      DRGVER,VARIABLE
          GOTO      PHFC7500
.
. ----- Admission weight -----
.
PHFC4850  BRANCH    FRSTFLAG,PHFC1000
.
          MOVE      ABWGHT,WADIM6
          LJUSTIFY  WADIM6
          MOVE      WADIM6,VARIABLE
          GOTO      PHFC7500
.
. ----- Age in Days -----
.
PHFC4860  BRANCH    FRSTFLAG,PHFC1000 
.
          PACK      KEY8,AADMNO
          CALL      RDVISA1                      * visit record on file ?
          BRANCH    OVRCD,PHFC1000               * no - ignore
.
          MOVE      PVIDATE,CDYSTDTE             * yes - load to date
          MOVE      PBDATE,CDYSFDTE              * load from date
          CALL      CALCDAYS                     * get age in days
.
          SUB       ONE,CDYSDAYS                 * get difference
          COMPARE   "365",CDYSDAYS               * less than 365 days old ?
          GOTO      PHFC1000 IF NOT LESS         * no - ignore
          MOVE      CDYSDAYS,FORM3
          MOVE      FORM3,VARIABLE
          GOTO      PHFC7500
.
. -----  Same Day Status -----
.
PHFC4870  BRANCH    FRSTFLAG,PHFC1000
.
          IF        PTCNDSCI = 0
            MATCH     SP3,ACLSS                  * admission class blank ?
            GOTO      PHFC1000 IF EQUAL          * yes - ignore
.
            PACK      KEY5,CATP,ACLSS
          ELSE
            LOAD      TCODE,PTCNDSCI,CATU1,CATU2,CATU3,CATU4,CATU5,CATVI
            LOAD      ACODE,PTCNDSCI,AUSR1,AUSR2,AUSR3,AUSR4,AUSR5,PMVXIDUS
            MATCH     SP3,ACODE                  * admission class blank ?
            GOTO      PHFC1000 IF EQUAL          * yes - ignore
.
            PACK      KEY5,TCODE,ACODE
          ENDIF
          CALL      RDCODE1                      * code on file ?
          BRANCH    OVRCD,PHFC1000               * no - ignore
.
          CALL      SAMDY000                     * same day patient ?
          IF        EXIT = 0
            MOVE     ONE,VARIABLE
          ELSE
            MATCH    "2",TCINDC1
            IF       @EQUAL
              MOVE     ZERO,VARIABLE
            ELSE
              MOVE     TWO,VARIABLE
            ENDIF
          ENDIF
.
          GOTO      PHFC7500
.
. ----- Transfer In -----
.
PHFC4880  BRANCH    FRSTFLAG,PHFC1000
.
          PACK      TCODE,ANSU,PTCNADTT
          LOAD      ACODE,PTCNADTT,AUSR1,AUSR2,AUSR3,AUSR4,AUSR5,AUSR6,AUSR7
.
          MATCH     SP3,ACODE                    * transfer code blank ?
          GOTO      PHFC1000 IF EQUAL            * yes - ignore
.
          PACK      KEY5,TCODE,ACODE
          CALL      RDCODE1                      * code on file ?
          BRANCH    OVRCD,PHFC1000               * no - ignore
.
          MOVE      THCSCOD,VARIABLE
          GOTO      PHFC7500
.
. -----  Acute Length of Stay -----
.
PHFC4890  BRANCH    FRSTFLAG,PHFC1000
.
          MATCH     SP3,ATYPE                    * admission type blank ?
          GOTO      PHFC1000 IF EQUAL            * yes - ignore
.
          PACK      KEY5,CATA,ATYPE
          CALL      RDCODE1                      * codes record on file ?
          BRANCH    OVRCD,PHFC1000               * no - ignore
.
          MATCH     TCINDC2,ANSN                 * acute stay ?
          GOTO      PHFC1000 IF EQUAL            * no - ignore
.
          MOVE      ZERO,FORM1
          CALL      GTLOS000                     * get length of stay
.
          MOVE      LOSDAYS,VARIABLE
          GOTO      PHFC7500
.
. ----- P.R.A. name -----
.
PHFC4900  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      SP70,KEY80
          PACK      PKNAME,SP70,SP10
.
          PACK      KEY8,AADMNO
          CALL      RDRESP1                 * Position on the P.R.A. file
          IF        OVRCD=1
            GOTO      PHFC7500
          ENDIF
.
          MATCH     "1",PTCNDEES
          GOTO      PHFC4905 IF NOT EQUAL
.
          CMATCH    "$",PKNAME
          IF        @EQUAL
            STRIP     PTCNDDES
            MOVE      PTCNDDES,KEY80
.
            UNPACK    PKNAME,DIM2,KEY78
            PACK      KEY80,KEY80,SP1,KEY78,SP70
            MOVE      KEY80,VARIABLE
.
            GOTO      PHFC7500
          ENDIF
.
PHFC4905  MOVE      PKNAME,VARIABLE
          GOTO      PHFC7500
.
. ----- P.R.A. address line 1 -----
.
PHFC4910  
.         BRANCH    FRSTFLAG,PHFC1000
          PACK      KEY8,AADMNO
          CALL      RDRESP1                 * Position on the P.R.A. file
          IF        OVRCD=1
            GOTO      PHFC7500
          ENDIF
          MOVE      PKADD1,VARIABLE
          GOTO      PHFC7500
.
. ----- P.R.A. address line 2 -----
.
PHFC4920 
.         BRANCH    FRSTFLAG,PHFC1000
          PACK      KEY8,AADMNO
          CALL      RDRESP1                 * Position on the P.R.A. file
          IF        OVRCD=1
            GOTO      PHFC7500
          ENDIF
          MOVE      PKADD2,VARIABLE
          GOTO      PHFC7500
.
. ----- P.R.A. address line 3 (suburb) -----
.
PHFC4930  
.         BRANCH    FRSTFLAG,PHFC1000
          PACK      KEY8,AADMNO
          CALL      RDRESP1                 * Position on the P.R.A. file
          IF        OVRCD=1
            GOTO      PHFC7500
          ENDIF
          MOVE      PKSUBR,VARIABLE
          GOTO      PHFC7500
.
. ----- P.R.A. postcode -----
.
PHFC4940  
.         BRANCH    FRSTFLAG,PHFC1000
          PACK      KEY8,AADMNO
          CALL      RDRESP1                 * Position on the P.R.A. file
          IF        OVRCD=1
            GOTO      PHFC7500
          ENDIF
          MOVE      PKPOST,VARIABLE
          GOTO      PHFC7500
.
. ----- P.R.A. home telephone -----
.
PHFC4950  
.         BRANCH    FRSTFLAG,PHFC1000
          PACK      KEY8,AADMNO
          CALL      RDRESP1                 * Position on the P.R.A. file
          IF        OVRCD=1
            GOTO      PHFC7500
          ENDIF
          MOVE      PKTELEP,VARIABLE
          GOTO      PHFC7500
.
. ----- P.R.A. work telephone -----
.
PHFC4960  
.         BRANCH    FRSTFLAG,PHFC1000
          PACK      KEY8,AADMNO
          CALL      RDRESP1                 * Position on the P.R.A. file
          IF        OVRCD=1
            GOTO      PHFC7500
          ENDIF
          MOVE      PKTELEB,VARIABLE
          GOTO      PHFC7500
.
. ----- Total accomodation -----
.
PHFC4970  BRANCH    FRSTFLAG,PHFC1000
          MOVE      ONE,FORM1
          CALL      RDDTR000                * Read through the DTR file for
.                                             the accomodation charges invoiced
          MOVE      FORM82,VARIABLE
          MOVE      "11",PRNTSTRT
          SUB       IBDTPLEN,PRNTSTRT
          GOTO      PHFC8000
.
. ----- Total theatre fees -----
.
PHFC4980  BRANCH    FRSTFLAG,PHFC1000
          MOVE      TWO,FORM1
          CALL      RDDTR000                * Read through the DTR file for
.                                             the theatre fee charges invoiced
          MOVE      FORM82,VARIABLE
          MOVE      "11",PRNTSTRT
          SUB       IBDTPLEN,PRNTSTRT
          GOTO      PHFC8000
.
. ----- Total other fees (miscellaneous) -----
.
PHFC4990  BRANCH    FRSTFLAG,PHFC1000
          MOVE      "3",FORM1
          CALL      RDDTR000                * Read through the DTR file for
.                                             the other fee charges invoiced
          MOVE      FORM82,VARIABLE
          MOVE      "11",PRNTSTRT
          SUB       IBDTPLEN,PRNTSTRT
          GOTO      PHFC8000
.
. ----- Length of stay -----
.
PHFC5000  BRANCH    FRSTFLAG,PHFC1000
          MOVE      ADATE,FROMDATE
          REP       " 0",FROMDATE
          IF        ASTAT=3
            MOVE      DDATE,TODATE
          ELSE
            PACK      TODATE,CCC,CYY,CMM,CDD
          ENDIF
          REP       " 0",TODATE
          CALL      NHOSPDAY                * Calculate the number of days in
.                                             hospital
          MOVE      NBRDAYS,VARIABLE
          MOVE      "4",PRNTSTRT
          SUB       IBDTPLEN,PRNTSTRT
          GOTO      PHFC8000
.
. ----- 'X' if D.V.A. patient -----
.
PHFC5010  BRANCH    FRSTFLAG,PHFC1000
          MOVE      ANSV,KEY1               * Veterans affairs claim
          CALL      GETCLM00                * Get claim code
          GOTO      PHFC7500
.
. ----- 'X' if workcare patient -----
.
PHFC5020  BRANCH    FRSTFLAG,PHFC1000
          MOVE      ANSW,KEY1               * Workers compensation claim
          CALL      GETCLM00                * Get claim code
          GOTO      PHFC7500
.
. ----- 'X' if T.A.C. patient -----
.
PHFC5030  BRANCH    FRSTFLAG,PHFC1000
          MOVE      ANSM,KEY1               * Motor accident claim
          CALL      GETCLM00                * Get claim code
          GOTO      PHFC7500
.
. ----- Current date -----
.
PHFC5040  BRANCH    FRSTFLAG,PHFC1000
          REP       " 0",CDATE
          MOVE      CDATE,VARIABLE
          GOTO      PHFC7500
.
. ----- Current day -----
.
PHFC5050  BRANCH    FRSTFLAG,PHFC1000
          MOVE      CDD,VARIABLE
          REP       " 0",VARIABLE
          MOVE      TWO,PRNTSTRT
          SUB       IBDTPLEN,PRNTSTRT
          GOTO      PHFC8000
.
. ----- Current month -----
.
PHFC5060  BRANCH    FRSTFLAG,PHFC1000
          MOVE      CMM,VARIABLE
          REP       " 0",VARIABLE
          MOVE      TWO,PRNTSTRT
          SUB       IBDTPLEN,PRNTSTRT
          GOTO      PHFC8000
.
. ----- Current year -----
.
PHFC5070  BRANCH    FRSTFLAG,PHFC1000
          IF        IBDTPLEN = 2
            MOVE      CYY,VARIABLE
            MOVE      TWO,PRNTSTRT
            SUB       IBDTPLEN,PRNTSTRT
          ELSE
            PACK      VARIABLE,CCC,CYY
            REP       " 0",VARIABLE
            MOVE      FOUR,PRNTSTRT
            SUB       IBDTPLEN,PRNTSTRT
          ENDIF
          GOTO      PHFC8000
.
. ----- DRG -----
.
PHFC5080  BRANCH    FRSTFLAG,PHFC1000
          CALL      GETDRG
          MOVE      DDRGCODE,VARIABLE
.......   MOVE      PTDSDDRG,VARIABLE
          GOTO      PHFC7500
.
. ----- MDC -----
.
PHFC5090  BRANCH    FRSTFLAG,PHFC1000
          CALL      GETDRG
          MOVE      DMDCCODE,VARIABLE
.......   MOVE      PTDSDMDC,VARIABLE
          GOTO      PHFC7500
.
. ----- Seperation mode -----
.
PHFC5100  BRANCH    FRSTFLAG,PHFC1000
          MOVE      ONE,THCSCOD
          IF        PTCNDRSM=1
            MATCH     SP3,DSTAT                  * code blank ?
            GOTO      PHFC1000 IF EQUAL          * yes
.
            PACK      KEY5,ANSD,SP1,DSTAT
          ELSE
            MATCH     SP3,DDEST                  * code blank ?
            GOTO      PHFC1000 IF EQUAL          * yes
.
            PACK      KEY5,ANSD,ANSD,DDEST
          ENDIF
          CALL      RDCODE1                 * Read the codes file
          PACK      KEY2,TCINDC5
          MOVE      KEY2,VARIABLE
          GOTO      PHFC7500
.
. ----- 1st medical records disease code -----
.
PHFC5110  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      ONE,FORM3               * Loop through the MDI file x times
          CALL      RDMDI000                * Loop through the MDI file
          BRANCH    EXIT,PHFC7500
.
          MOVE      PTEDCODE,VARIABLE
.
          GOTO      PHFC7500
.
. ----- 2nd medical records disease code -----
.
PHFC5120  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      "2",FORM3               * Loop through the MDI file x times
          CALL      RDMDI000                * Loop through the MDI file
          BRANCH    EXIT,PHFC7500
.
          MOVE      PTEDCODE,VARIABLE
          GOTO      PHFC7500
.
. ----- 3rd medical records disease code -----
.
PHFC5130  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      "3",FORM3               * Loop through the MDI file x times
          CALL      RDMDI000                * Loop through the MDI file
          BRANCH    EXIT,PHFC7500
.
          MOVE      PTEDCODE,VARIABLE
          GOTO      PHFC7500
.
. ----- 4th medical records disease code -----
.
PHFC5140  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      "4",FORM3               * Loop through the MDI file x times
          CALL      RDMDI000                * Loop through the MDI file
          BRANCH    EXIT,PHFC7500
.
          MOVE      PTEDCODE,VARIABLE
          GOTO      PHFC7500
.
. ----- 5th medical records disease code -----
.
PHFC5150  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      "5",FORM3               * Loop through the MDI file x times
          CALL      RDMDI000                * Loop through the MDI file
          BRANCH    EXIT,PHFC7500
.
          MOVE      PTEDCODE,VARIABLE
          GOTO      PHFC7500
.
. ----- 6th medical records disease code -----
.
PHFC5160  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      "6",FORM3               * Loop through the MDI file x times
          CALL      RDMDI000                * Loop through the MDI file
          BRANCH    EXIT,PHFC7500
.
          MOVE      PTEDCODE,VARIABLE
          GOTO      PHFC7500
.
. ----- 7th medical records disease code -----
.
PHFC5170  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      "7",FORM3               * Loop through the MDI file x times
          CALL      RDMDI000                * Loop through the MDI file
          BRANCH    EXIT,PHFC7500
.
          MOVE      PTEDCODE,VARIABLE
          GOTO      PHFC7500
.
. ----- 8th medical records disease code -----
.
PHFC5180  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      "8",FORM3               * Loop through the MDI file x times
          CALL      RDMDI000                * Loop through the MDI file
          BRANCH    EXIT,PHFC7500
.
          MOVE      PTEDCODE,VARIABLE
          GOTO      PHFC7500
.
. ----- 9th medical records disease code -----
.
PHFC5190  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      "9",FORM3               * Loop through the MDI file x times
          CALL      RDMDI000                * Loop through the MDI file
          BRANCH    EXIT,PHFC7500
.
          MOVE      PTEDCODE,VARIABLE
          GOTO      PHFC7500
.
. ----- 10th medical records disease code -----
.
PHFC5200  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      "10",FORM3              * Loop through the MDI file x times
          CALL      RDMDI000                * Loop through the MDI file
          BRANCH    EXIT,PHFC7500
.
          MOVE      PTEDCODE,VARIABLE
          GOTO      PHFC7500
.
. ----- 11th medical records disease code -----
.
PHFC5210  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      "11",FORM3              * Loop through the MDI file x times
          CALL      RDMDI000                * Loop through the MDI file
          BRANCH    EXIT,PHFC7500
.
          MOVE      PTEDCODE,VARIABLE
          GOTO      PHFC7500
.
. ----- 12th medical records disease code -----
.
PHFC5220  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      "12",FORM3              * Loop through the MDI file x times
          CALL      RDMDI000                * Loop through the MDI file
          BRANCH    EXIT,PHFC7500
.
          MOVE      PTEDCODE,VARIABLE
          GOTO      PHFC7500
.
. ----- 13th medical records disease code -----
.
PHFC5230  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      "13",FORM3              * Loop through the MDI file x times
          CALL      RDMDI000                * Loop through the MDI file
          BRANCH    EXIT,PHFC7500
.
          MOVE      PTEDCODE,VARIABLE
          GOTO      PHFC7500
.
. ----- 14th medical records disease code -----
.
PHFC5240  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      "14",FORM3              * Loop through the MDI file x times
          CALL      RDMDI000                * Loop through the MDI file
          BRANCH    EXIT,PHFC7500
.
          MOVE      PTEDCODE,VARIABLE
          GOTO      PHFC7500
.
. ----- 15th medical records disease code -----
.
PHFC5250  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      "15",FORM3              * Loop through the MDI file x times
          CALL      RDMDI000                * Loop through the MDI file
          BRANCH    EXIT,PHFC7500
.
          MOVE      PTEDCODE,VARIABLE
.
          GOTO      PHFC7500
.
. ----- 1st medical records operation code -----
.
PHFC5260  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      ONE,FORM3               * Loop through the MOP file x times
          CALL      RDMOP000                * Loop through the MOP file
          BRANCH    EXIT,PHFC7500
.
          MOVE      PTEOCODE,VARIABLE
          GOTO      PHFC7500
.
. ----- 2nd medical records operation code -----
.
PHFC5270  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      "2",FORM3               * Loop through the MOP file x times
          CALL      RDMOP000                * Loop through the MOP file
          BRANCH    EXIT,PHFC7500
.
          MOVE      PTEOCODE,VARIABLE
          GOTO      PHFC7500
.
. ----- 3rd medical records operation code -----
.
PHFC5280  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      "3",FORM3               * Loop through the MOP file x times
          CALL      RDMOP000                * Loop through the MOP file
          BRANCH    EXIT,PHFC7500
.
          MOVE      PTEOCODE,VARIABLE
          GOTO      PHFC7500
.
. ----- 4th medical records operation code -----
.
PHFC5290  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      "4",FORM3               * Loop through the MOP file x times
          CALL      RDMOP000                * Loop through the MOP file
          BRANCH    EXIT,PHFC7500
.
          MOVE      PTEOCODE,VARIABLE
          GOTO      PHFC7500
.
. ----- 5th medical records operation code -----
.
PHFC5300  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      "5",FORM3               * Loop through the MOP file x times
          CALL      RDMOP000                * Loop through the MOP file
          BRANCH    EXIT,PHFC7500
.
          MOVE      PTEOCODE,VARIABLE
          GOTO      PHFC7500
.
. ----- 6th medical records operation code -----
.
PHFC5310  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      "6",FORM3               * Loop through the MOP file x times
          CALL      RDMOP000                * Loop through the MOP file
          BRANCH    EXIT,PHFC7500
.
          MOVE      PTEOCODE,VARIABLE
          GOTO      PHFC7500
.
. ----- 7th medical records operation code -----
.
PHFC5320  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      "7",FORM3               * Loop through the MOP file x times
          CALL      RDMOP000                * Loop through the MOP file
          BRANCH    EXIT,PHFC7500
.
          MOVE      PTEOCODE,VARIABLE
          GOTO      PHFC7500
.
. ----- 8th medical records operation code -----
.
PHFC5330  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      "8",FORM3               * Loop through the MOP file x times
          CALL      RDMOP000                * Loop through the MOP file
          BRANCH    EXIT,PHFC7500
.
          MOVE      PTEOCODE,VARIABLE
          GOTO      PHFC7500
.
. ----- 9th medical records operation code -----
.
PHFC5340  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      "9",FORM3               * Loop through the MOP file x times
          CALL      RDMOP000                * Loop through the MOP file
          BRANCH    EXIT,PHFC7500
.
          MOVE      PTEOCODE,VARIABLE
          GOTO      PHFC7500
.
. ----- 10th medical records operation code -----
.
PHFC5350  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      "10",FORM3              * Loop through the MOP file x times
          CALL      RDMOP000                * Loop through the MOP file
          BRANCH    EXIT,PHFC7500
.
          MOVE      PTEOCODE,VARIABLE
          GOTO      PHFC7500
.
. ----- 11th medical records operation code -----
.
PHFC5360  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      "11",FORM3              * Loop through the MOP file x times
          CALL      RDMOP000                * Loop through the MOP file
          BRANCH    EXIT,PHFC7500
.
          MOVE      PTEOCODE,VARIABLE
          GOTO      PHFC7500
.
. ----- 12th medical records operation code -----
.
PHFC5370  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      "12",FORM3              * Loop through the MOP file x times
          CALL      RDMOP000                * Loop through the MOP file
          BRANCH    EXIT,PHFC7500
.
          MOVE      PTEOCODE,VARIABLE
          GOTO      PHFC7500
.
. ----- 13th medical records operation code -----
.
PHFC5380  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      "13",FORM3              * Loop through the MOP file x times
          CALL      RDMOP000                * Loop through the MOP file
          BRANCH    EXIT,PHFC7500
.
          MOVE      PTEOCODE,VARIABLE
          GOTO      PHFC7500
.
. ----- 14th medical records operation code -----
.
PHFC5390  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      "14",FORM3              * Loop through the MOP file x times
          CALL      RDMOP000                * Loop through the MOP file
          BRANCH    EXIT,PHFC7500
.
          MOVE      PTEOCODE,VARIABLE
          GOTO      PHFC7500
.
. ----- 15th medical records operation code -----
.
PHFC5400  
.         BRANCH    FRSTFLAG,PHFC1000
          MOVE      "15",FORM3              * Loop through the MOP file x times
          CALL      RDMOP000                * Loop through the MOP file
          BRANCH    EXIT,PHFC7500
.
          MOVE      PTEOCODE,VARIABLE
          GOTO      PHFC7500
.
. ----- P.R.A. relationship -----
.
PHFC5410  
.         BRANCH    FRSTFLAG,PHFC1000
          PACK      KEY8,AADMNO
          CALL      RDRESP1                 * Position on the P.R.A. file
          IF        OVRCD=1
            GOTO      PHFC7500
          ENDIF
          MOVE      PKRELP,VARIABLE
          GOTO      PHFC7500
.
. ----- Admission Code -----
.
PHFC5420  COMPARE   SIX,TRANFLAG                 * printed all TRN recs ?
          GOTO      PHFC1000 IF EQUAL            * yes - ignore item
.
.         Reposition in tran file in case another routine has read another
.         record in the tran file
.
          MOVE      SAVKEY30,KEY30
          CALL      RDTRAN2
.
.         Check if Category KO for unplanned re-admission           *C-V-002
.         within 28 days has been set.
.
          PACK      KEY5,ANSK,ANSO,PMVXUREA,SP5
          CALL      RDCODE1                      * code on file ?
          BRANCH    OVRCD,PHFC5421               * no do regular checks
.
          UNPACK    THCSCOD,DIM1A,DIM1           * 2nd pos.
          MATCH     ANSY,DIM1
          IF        @EQUAL
            MOVE     THREE,VARIABLE              * yes
            GOTO     PHFC7500
          ENDIF
          MATCH     ANSN,DIM1
          IF        @EQUAL
            MOVE     SIX,VARIABLE                * No
          ELSE
            GOTO     PHFC5421                    * anything else
          ENDIF
.
          GOTO     PHFC7500
.
.
PHFC5421  MATCH     SP3,ASRCE                    * blank source code ?
          GOTO      PHFC5422 IF EQUAL            * yes
.
          PACK      KEY5,CATS,ASRCE
          CALL      RDCODE1                      * source code on file ?
          BRANCH    OVRCD,PHFC1000               * no - ignore
.
          MATCH     "1",TCINDC2                  * transfer from another hosp ?
          IF        @EQUAL
            MOVE      FIVE,VARIABLE              * yes
            GOTO      PHFC7500
          ENDIF
.
PHFC5422  IF        ADYHOSP > 0 & ADYHOSP < 8
            MOVE      THREE,VARIABLE             * re-admission
            GOTO      PHFC7500
          ENDIF
.
          COMPARE   THREE,ASTAT                  * patient discharged ?
          IF        @EQUAL
            MATCH     DDATE,ADATE                * yes - same day ?
            IF        @EQUAL
              MOVE      FOUR,VARIABLE            * yes
              GOTO      PHFC7500
            ENDIF
          ENDIF
          MOVE      ONE,VARIABLE                 * admission
.
          GOTO      PHFC7500
.
. ----- Accommodation Code -----
.
PHFC5430  COMPARE   SIX,TRANFLAG                 * printed all TRN recs ?
          GOTO      PHFC1000 IF EQUAL            * yes - ignore item
.
.         Reposition in tran file in case another routine has read another
.         record in the tran file
.
          MOVE      SAVKEY30,KEY30
          CALL      RDTRAN2
          CALL      GACCM000                     * get accommodation code
          GOTO      PHFC7500
.
. ----- Transfer Date From -----
.
PHFC5440  COMPARE   SIX,TRANFLAG                 * printed all TRN recs ?
          GOTO      PHFC1000 IF EQUAL            * yes - ignore item
.
.         Reposition in tran file in case another routine has read another
.         record in the tran file
.
          MOVE      SAVKEY30,KEY30
          CALL      RDTRAN2
.
          IF        INVFLAG > 0 & TRANFLAG = 1 & FRSTFLAG = 0
            MOVE      HFCFDTE,TDATE              * only on first page  *I-65745
          ENDIF                                                        *I-65745
          IF        SKIPFLAG=1
            MOVE      SAVDATE,TDATE
          ENDIF
.
          UNPACK    TDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      TDATE,SAVDAT1
          CALL      PACDATE
          IF        IBDTPLEN = 8
            MOVE      CPDATE,VARIABLE
          ELSE
            MOVE      CPCDATE,VARIABLE
          ENDIF
          GOTO      PHFC7500
.
. ----- Transfer Date To -----
.
PHFC5450  COMPARE   SIX,TRANFLAG                 * printed all TRN recs ?
          GOTO      PHFC1000 IF EQUAL            * yes - ignore item
.
.         Reposition in tran file in case another routine has read another
.         record in the tran file
.
          MOVE      SAVKEY30,KEY30
          CALL      RDTRAN2
.
          BRANCH    DTGTNTRD,PHFC5452       * Dont get next transfer record
.
          IF        SKIPFLAG=1
            MOVE      SAVDATE,TDATE
          ENDIF
          CALL      GTTRN000                     * get next tran record
          IF        EXIT<>1 | EXIT <>2
            CALL      CHCN0000                     * Check contract id
          ENDIF
.
          BRANCH    EXIT,PHFC5453:               * eof
                         PHFC5453:               * diff. admission number
                         PHFC5452:               * discharge - overnight
                         PHFC5452:               * discharge - daycase
                         PHFC5451                * after last invoice date
          GOTO      PHFC5452                     * valid record
.
PHFC5451  UNPACK    ALACDTE,CCENT,CYEAR,CMON,CDAY
          IF        INVFLAG > 0
           MATCH     ANSD,TMOVE
            IF        @EQUAL
              UNPACK    HFCTDTE,CCENT,CYEAR,CMON,CDAY            *I-65745
            ENDIF                                                *I-65745
          ENDIF
          GOTO      PHFC5455
.
PHFC5452  UNPACK    TDATE,CCENT,CYEAR,CMON,CDAY
          IF        INVFLAG > 0
            MATCH     ANSD,TMOVE                                       *I-112161
            IF        @EQUAL
              UNPACK    HFCTDTE,CCENT,CYEAR,CMON,CDAY
            ENDIF                                                     *I-112161
          ENDIF
          GOTO      PHFC5455
.
PHFC5453  MOVE      CYY,CYEAR
          MOVE      CMM,CMON
          MOVE      CDD,CDAY
          MOVE      CCC,CCENT
          IF        INVFLAG > 0
            MATCH     ANSD,TMOVE
            IF        @EQUAL
              UNPACK    HFCTDTE,CCENT,CYEAR,CMON,CDAY                    *I-65745
            ENDIF
          ENDIF                                                        *I-65745
.
PHFC5455  CALL      PACDATE
          IF        IBDTPLEN = 8
            MOVE      CPDATE,VARIABLE
          ELSE
            MOVE      CPCDATE,VARIABLE
          ENDIF
.
          MOVE      SAVKEY30,KEY30
          CALL      RDTRAN2
          GOTO      PHFC7500
.
. ----- Discharge Code -----
.
.         Reposition in tran file in case another routine has read another
.         record in the tran file
.
PHFC5460  IF        TRANFLAG=6 & DSCPFLAG=1
            GOTO      PHFC1000
          ENDIF
.
          MOVE      SP70,VARIABLE
.
          MOVE      SAVKEY30,KEY30
          CALL      RDTRAN2
          BRANCH    OVRCD,PHFC1000
          IF        SKIPFLAG=1
            MOVE      SAVDATE,TDATE
          ENDIF
.
.         If this is the last transfer record before a discharge record,
.         then set the discharge code to the appropriate value.
.
          IF        DSCHFLAG = 1
            MOVE      ONE,DSCPFLAG
            MATCH     DSTAT,SP3                  * discharge status blank ?
.                                                                     *C-140164
            IF        !@EQUAL
              PACK      KEY5,CATD,DSTAT
            ELSE
              MATCH     SP3,DDEST
              GOTO      PHFC1000 IF EQUAL        * yes - ignore
              PACK      KEY5,CATDD,DDEST
            ENDIF
.
            CALL      RDCODE1                    * disch. cat/code on file ?
            IF        OVRCD = 0
              MATCH     "1",TCINDC2              * is ind. "1" - transfer
              IF        @EQUAL
                MOVE      FIVE,VARIABLE          * yes
                GOTO      PHFC7500
              ENDIF
.
              MATCH     ANSS,TCINDC1             * yes - is ind. "discharged" ?
              IF        @EQUAL
                MOVE      ONE,VARIABLE           * yes
                GOTO      PHFC7500
              ENDIF
.
              MATCH     ANSZ,TCINDC1             * yes - is ind. "disch.home" ?
              IF        @EQUAL
                MOVE      ONE,VARIABLE           * yes
                GOTO      PHFC7500
              ENDIF
.
              MATCH     ANSD,TCINDC1             * is ind. "Deceased" ?
              IF        @EQUAL
                MOVE      THREE,VARIABLE         * yes
                GOTO      PHFC7500
              ENDIF
.
              MATCH     "6",TCINDC1              * is ind."6"-Erly dsc.*C-V-004
              IF        @EQUAL
                MOVE      SIX,VARIABLE          * yes
                GOTO      PHFC7500
              ENDIF
.
            ENDIF
            GOTO      PHFC7500
          ENDIF
.
          MATCH     ANSL,TMOVE                   * on - leave record
          IF        @EQUAL
            MOVE      FOUR,VARIABLE              * yes
            GOTO      PHFC7500
          ENDIF
.
          MOVE      TWO,VARIABLE                 * set to "Interim Claim"
          GOTO      PHFC7500
.
. ----- Days Claimed -----
.
PHFC5470  COMPARE   SIX,TRANFLAG                 * printed all TRN recs ?
          GOTO      PHFC1000 IF EQUAL            * yes - ignore item
.
.         Reposition in tran file in case another routine has read another
.         record in the tran file
.
          MOVE      SAVKEY30,KEY30
          CALL      RDTRAN2
.
          IF        INVFLAG > 0 & TRANFLAG = 1 & FRSTFLAG = 0
            MOVE      HFCFDTE,TDATE              * only on first page  *I-65745
          ENDIF                                                        *I-65745
.
          PACK      CDYSFDTE,TDATE           * load fromdate
          BRANCH    DTGTNTRD,PHFC5472       * Dont get next transfer record
.
          IF        SKIPFLAG=1
            MOVE      SAVDATE,TDATE
            PACK      CDYSFDTE,TDATE           * load fromdate
            PACK      KEY30,TADMNO,TDATE,SP70
            CALL      RDSTRAN2
          ENDIF
.
          CALL      GTTRN000                     * get next tran record
          IF        EXIT<>1 | EXIT <>2
            CALL      CHCN0000                     * Check contract id
            MOVE      PTDTCNID,SAVCONTR
          ENDIF
.
          BRANCH    EXIT,PHFC5476:               * eof
                         PHFC5476:               * not same admission #
                         PHFC5472:               * discharge - overnight
                         PHFC5472:               * discharge - daycase
                         PHFC5471                * after last invoice date
.
          GOTO      PHFC5472                     * valid record
.
PHFC5471  MOVE      ZERO,EXIT
          UNPACK    ALACDTE,CCENT,CYEAR,CMON,CDAY
          IF        INVFLAG > 0
            UNPACK    HFCTDTE,CCENT,CYEAR,CMON,CDAY                    *I-65745
          ENDIF                                                        *I-65745
          PACK      CDYSTDTE,CCENT,CYEAR,CMON,CDAY * load todate
          GOTO      PHFC5477
.
PHFC5472  PACK      CDYSTDTE,TDATE           * load todate
          IF        INVFLAG > 0
            MATCH     "D",TMOVE                                       *I-112161
            IF        @EQUAL
              MOVE      HFCTDTE,CDYSTDTE
            ENDIF                                                     *I-112161
          ENDIF
.
          MOVE      ZERO,MVDAYS              * init mech. vent. billing days
          IF        PTCNMVCP=1
            MATCH     TDATE,DDATE
            IF        @EQUAL
              PACK      KEY16,AADMNO,ZED30
              CALL      RDSINV3
PHFC5473      CALL      RDPINV3                      * read last invoice
              BRANCH    OVRCD,PHFC5477
.
              MATCH     AADMNO,PINVADM               * check same adm.
              GOTO      PHFC5477 IF NOT EQUAL
.
              COMPARE   TWO,PINVTYP                 * "Patient Portion" Invoice?
              GOTO      PHFC5473 IF EQUAL            * then bypass     *I-65745
.
              MOVE      PTINMVDY,MVDAYS              * save mv billing days
            ENDIF
          ENDIF
.
          GOTO      PHFC5477
.
PHFC5476  PACK      CDYSTDTE,CCC,CYY,CMM,CDD
          IF        INVFLAG > 0
            MOVE      HFCTDTE,CDYSTDTE                                 *I-65745
          ENDIF
.
PHFC5477  CALL      CALCDAYS                     * calculate days between dates
.
          MATCH     ADATE,DDATE                  * day case ?
          IF        !@EQUAL
            SUB       ONE,CDYSDAYS
            SUB       MVDAYS,CDYSDAYS            * subtract any mv billing days
          ENDIF
.
.         Save day claims on the array for calculating total charges
.         for field no (FORM5)=330 331 332 333
.
          MOVE      CDYSDAYS,VARIABLE
          IF        FORM5=147
            MOVE      CDYSDAYS,DAYCLAIM[1]
          ELSE
            IF        FORM5=154
              MOVE      CDYSDAYS,DAYCLAIM[2]
            ELSE
              IF        FORM5=161
                MOVE      CDYSDAYS,DAYCLAIM[3]
              ELSE
                IF        FORM5=168
                  MOVE      CDYSDAYS,DAYCLAIM[4]
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      SAVKEY30,KEY30
          CALL      RDTRAN2
          GOTO      PHFC7500
.
. ----- Daily Bed Charge -----
.
PHFC5480  COMPARE   SIX,TRANFLAG                 * printed all TRN recs ?
          GOTO      PHFC1000 IF EQUAL            * yes - ignore item
.
.         Reposition in tran file in case another routine has read another
.         record in the tran file
.
          MOVE      SAVKEY30,KEY30
          CALL      RDTRAN2
          IF        SKIPFLAG=1
            MOVE      SAVDATE,TDATE
          ENDIF
.
.            All patients, get rates from DTR file (leave blank if not Invoiced)
.                                           * All Bed Charges are now read from
.                                           * "patdtraf" - after being Invoiced
.
          MOVE      ZERO,FORM1
          PACK      KEY22,AADMNO,SP30       * position on first DTR      
          CALL      RDSDTRN1
PHFC5482  CALL      RDKDTRN1                     * read through dtr file
          BRANCH    OVRCD,PHFC1000
.
          MATCH     AADMNO,TADMNO
          GOTO      PHFC1000 IF NOT EQUAL        * Different admission
.
          COMPARE   ZERO,TINVPRT
          GOTO      PHFC5482 IF EQUAL            * Not invoiced
.
          COMPARE   ONE,TRECTYPE
          GOTO      PHFC5482 IF NOT EQUAL        * not accomodation record
.
          IF        INVFLAG > 0
            MATCH     TREF,HFCFINVN
            GOTO      PHFC5482 IF NOT EQUAL      * must be on last invoice
            PACK      DTRTDATE,DTFCENT,DTFYEAR,DTFMONTH,DTFDAY
            REP       " 0",DTRTDATE
            MATCH     TDATE,DTRTDATE
            GOTO      PHFC5482 IF LESS
          ENDIF
.
.                                           * check this is a HF Invoice
          PACK      KEY16,DAADMNO,TREF,SP20
          CALL      RDINV3                  * Find the Invoice
          BRANCH    OVRCD,PHFC5482
.
          COMPARE   TWO,PINVTYP
          GOTO      PHFC5482 IF EQUAL
.
          PACK      KEY22,TADMNO,TREF,TTRANSN1,SP70
          CALL      CRNT0000
          BRANCH    EXIT,PHFC5482           * Credit note
.
.                                           * printing by Invoice, so print rate
          IF        INVFLAG > 0
            GOTO      PHFC5486              * print the Rate          *I-112161
          ENDIF                                                       *I-112161
.
.                                           * DTR "From" date
PHFC5483  PACK      DTRTDATE,DTFCENT,DTFYEAR,DTFMONTH,DTFDAY
          REP       " 0",DTRTDATE
          MATCH     TDATE,DTRTDATE
          GOTO      PHFC5486 IF EQUAL
.
          MOVE      DTRTDATE,FDTRTDAT
.
.                                           * DTR "To" date
          PACK      DTRDDATE,TTCENT,TTYEAR,TTMONTH,TTDAY
          REP       " 0",DTRDDATE
          MOVE      DTRDDATE,FDTRDDAT
          MOVE      TDATE,FSTDATE
.
          IF        FSTDATE>FDTRTDAT
            IF        FSTDATE<FDTRDDAT
              GOTO      PHFC5486
            ENDIF
          ENDIF
.
          GOTO      PHFC5482
.
PHFC5486  MOVE      TPATAMTI,FORM6P2
.
          IF        FORM5=330
            MULT      DAYCLAIM[1],FORM6P2
          ELSE
            IF        FORM5=331
              MULT      DAYCLAIM[2],FORM6P2
            ELSE
              IF        FORM5=332
                MULT      DAYCLAIM[3],FORM6P2
              ELSE
                IF        FORM5=333
                  MULT      DAYCLAIM[4],FORM6P2
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      FORM6P2,VARIABLE
.
          GOTO      PHFC7500
.
. ----- From Time in Theatre -----
.       Only printed for a same day patient
.
PHFC5500  BRANCH    FRSTFLAG,PHFC1000
.
          CALL      SAMDY000                     * same day patient ?
          BRANCH    EXIT,PHFC1000                * no - ignore
.
          MOVE      SP5,SSTTIMED            * Saved starting operation time
          MOVE      ZERO,SSTTIMEF           * Saved starting operation time
.
          IF        OPRFOUND = 0
            CALL      OPSTM000                   * get theatre op start time
          ENDIF
.
.         Now check times on the medical records operations file
.
          PACK      KEY16,AADMNO,SP20
          CALL      RSPTECO2                * Position on & read a patient
PHFC5501  CALL      RKPTECO2                  episode operation file record
          BRANCH    OVRCD,PHFC5502
.
          MATCH     AADMNO,PTEOADMN
          GOTO      PHFC5502 IF NOT EQUAL   * Different admin no
.
          MOVE      PTEOSTTM,SRTTIMED
          CALL      GOST0000                     * get the operation start time
          GOTO      PHFC5501                     * get next record
.
.         Now check times on the patmmbsf file
.
PHFC5502  PACK      KEY11,AADMNO,SP10
          CALL      RDSMMBS1                     * position in file
PHFC5503  CALL      RDKMMBS1                     * read next record
          BRANCH    OVRCD,PHFC5504               * eof
.
          MATCH     AADMNO,MMADMN                * same admission number ?
          GOTO      PHFC5504 IF NOT EQUAL        * no
.
          MOVE      MMSTIM,SRTTIMED
          CALL      GOST0000                     * get the operation start time
          GOTO      PHFC5503                     * get next record
.
PHFC5504  MOVE      SSTTIMED,VARIABLE
          GOTO      PHFC7500
.
. ----- To Time in Theatre -----
.       Only printed for a same day patient
.
PHFC5520  BRANCH    FRSTFLAG,PHFC1000
.
          CALL      SAMDY000                     * same day patient ?
          BRANCH    EXIT,PHFC1000                * no - ignore
.
          MOVE      SP5,SEDTIMED            * Saved starting operation time
          MOVE      ZERO,SEDTIMEF           * Saved starting operation time
.
          MOVE      SP5,ENDTIMED            * srf 33985                *I-90301
          MOVE      ZERO,ENDTIMEF           * srf 33985                *I-90301
.
          IF        OPRFOUND = 0
            CALL      OPETM000                   * get theatre op. end time
          ENDIF
.
.         Now check times on the medical records operations file
.
          PACK      KEY16,AADMNO,SP20
          CALL      RSPTECO2                * Position on & read a patient
PHFC5521  CALL      RKPTECO2                  episode operation file record
          BRANCH    OVRCD,PHFC5522               * eof
.
          MATCH     AADMNO,PTEOADMN
          GOTO      PHFC5522 IF NOT EQUAL   * Different admin no
.
          MOVE      PTEOEDTM,ENDTIMED
          CALL      GOET0000                     * get the operation end time
          GOTO      PHFC5521                     * get next record
.
.         Now check times on the patmmbsf file
.
PHFC5522  PACK      KEY11,AADMNO,SP10
          CALL      RDSMMBS1                     * position in file
PHFC5523  CALL      RDKMMBS1                     * read next record
          BRANCH    OVRCD,PHFC5524               * eof
.
          MATCH     AADMNO,MMADMN                * same admission number ?
          GOTO      PHFC5524 IF NOT EQUAL        * no
.
          MOVE      MMETIM,ENDTIMED
          CALL      GOET0000                     * get the operation end time
          GOTO      PHFC5523                     * get next record
.
PHFC5524  MOVE      SEDTIMED,VARIABLE
          GOTO      PHFC7500
.
. ----- Anaesthetic Type - None -----
.       Only printed for a same day patient
.
PHFC5620  BRANCH    FRSTFLAG,PHFC1000
.
          MOVE      SP70,VARIABLE
.
          CALL      SAMDY000                     * same day patient ?
          BRANCH    EXIT,PHFC1000                * no - ignore
.
          MOVE      FIVE,ANATYPE
          CALL      GTANA000                     * get anaesthetic type
          BRANCH    EXIT,PHFC1000                * not found
.
          MOVE      ANSX,VARIABLE
          GOTO      PHFC7500
.
. ----- Anaesthetic Type - Local -----
.       Only printed for a same day patient
.
PHFC5640  BRANCH    FRSTFLAG,PHFC1000
.
          MOVE      SP70,VARIABLE
.
          CALL      SAMDY000                     * same day patient ?
          BRANCH    EXIT,PHFC1000                * no - ignore
.
          MOVE      ONE,ANATYPE
          CALL      GTANA000                     * get anaesthetic type
          BRANCH    EXIT,PHFC1000                * not found
.
          MOVE      ANSX,VARIABLE
          GOTO      PHFC7500
.
. ----- Anaesthetic Type - Intravenous -----
.       Only printed for a same day patient
.
PHFC5660  BRANCH    FRSTFLAG,PHFC1000
.
          MOVE      SP70,VARIABLE
.
          CALL      SAMDY000                     * same day patient ?
          BRANCH    EXIT,PHFC1000                * no - ignore
.
          MOVE      FOUR,ANATYPE
          CALL      GTANA000                     * get anaesthetic type
          BRANCH    EXIT,PHFC1000                * not found
.
          MOVE      ANSX,VARIABLE
          GOTO      PHFC7500
.
. ----- Anaesthetic Type - Regional -----
.       Only printed for a same day patient
.
PHFC5680  BRANCH    FRSTFLAG,PHFC1000
.
          MOVE      SP70,VARIABLE
.
          CALL      SAMDY000                     * same day patient ?
          BRANCH    EXIT,PHFC1000                * no - ignore
.
          MOVE      THREE,ANATYPE
          CALL      GTANA000                     * get anaesthetic type
          BRANCH    EXIT,PHFC1000                * not found
.
          MOVE      ANSX,VARIABLE
          GOTO      PHFC7500
.
. ----- Anaesthetic Type - General -----
.       Only printed for a same day patient
.
PHFC5700  BRANCH    FRSTFLAG,PHFC1000
.
          MOVE      SP70,VARIABLE
.
          CALL      SAMDY000                     * same day patient ?
          BRANCH    EXIT,PHFC1000                * no - ignore
.
          MOVE      TWO,ANATYPE
          CALL      GTANA000                     * get anaesthetic type
          BRANCH    EXIT,PHFC1000                * not found
.
          MOVE      ANSX,VARIABLE
          GOTO      PHFC7500
.
. ----- Same Day Band -----
.       Only printed for a same day patient
.
PHFC5720  BRANCH    FRSTFLAG,PHFC1000
.
          CALL      SAMDY000                     * same day patient ?
          BRANCH    EXIT,PHFC1000                * no - ignore
.
          MOVE      ATYPE,VARIABLE
          GOTO      PHFC7500
.
. ----- Other Services Code -----
.
PHFC5730  COMPARE   SIX,SERVFLAG
          GOTO      PHFC1000 IF EQUAL
.
.         Reposition in DTR file in case another routine has read another
.         record in the DTR file
.
          MOVE      SAVKEY22,KEY22
          CALL      RDDTRN1
.                                      * should read patcodes again in case!!!
.                                      * Happens to work because other serv
.                                      * are grouped in 4 lines.
.
          PACK      KEY5,CATFI,TMISGRP
          CALL      RDCODE1                      * code on file ?
          BRANCH    OVRCD,PHFC1000               * no - ignore
.
          MATCH     "1",TCINDC6                  * indicator set to print ?
          GOTO      PHFC1000 IF NOT EQUAL        * No - ignore
.
          CALL      CRNT0000           * Check Credit note
          BRANCH    EXIT,PHFC1000      * Credited
.
          MOVE      TCINDC3,VARIABLE                                   *C-V-006
          GOTO      PHFC7500
.
. ----- Other Services Date -----
.
PHFC5740  COMPARE   SIX,SERVFLAG
          GOTO      PHFC1000 IF EQUAL
.
.         Reposition in DTR file in case another routine has read another
.         record in the DTR file
.
          MOVE      SAVKEY22,KEY22
          CALL      RDDTRN1
.
          COMPARE   "1",PTDTEPSD            * don't display date for mv billing
          GOTO      PHFC1000 IF EQUAL
.
          PACK      KEY5,CATFI,TMISGRP
          CALL      RDCODE1                      * code on file ?
          BRANCH    OVRCD,PHFC1000               * no - ignore
.
          MATCH     "1",TCINDC6                  * indicator set to print ?
          GOTO      PHFC1000 IF NOT EQUAL        * No - ignore
.
          CALL      CRNT0000                * Check Credit note
          BRANCH    EXIT,PHFC1000           * Credited
.
          MOVE      DTFCENT,CCENT
          MOVE      DTFYEAR,CYEAR
          MOVE      DTFMONTH,CMON
          MOVE      DTFDAY,CDAY
          CALL      PACDATE
.
          IF        IBDTPLEN = 8
            MOVE      CPDATE,VARIABLE
          ELSE
            MOVE      CPCDATE,VARIABLE
          ENDIF
          GOTO      PHFC7500
.
. ----- Other Services Number -----
.
PHFC5750  COMPARE   SIX,SERVFLAG
          GOTO      PHFC1000 IF EQUAL
.
.         Reposition in DTR file in case another routine has read another
.         record in the DTR file
.
          MOVE      SAVKEY22,KEY22
          CALL      RDDTRN1
.
          PACK      KEY5,CATFI,TMISGRP
          CALL      RDCODE1                      * code on file ?
          BRANCH    OVRCD,PHFC1000               * no - ignore
.
          MATCH     "1",TCINDC6                  * indicator set to print ?
          GOTO      PHFC1000 IF NOT EQUAL        * No - ignore
.
          CALL      CRNT0000                     * Check Credit note
          BRANCH    EXIT,PHFC1000                * Credited
.
          COMPARE   "1",PTDTEPSD                 * check for mv billing
          GOTO      PHFC5755 IF NOT EQUAL
.
          PACK      KEY16,AADMNO,ZED30
          CALL      RDSINV3
PHFC5751  CALL      RDPINV3                      * read last invoice
          BRANCH    OVRCD,PHFC5755
.
          MATCH     AADMNO,PINVADM               * check same adm.
          GOTO      PHFC5755 IF NOT EQUAL
.
          COMPARE   TWO,PINVTYP                  * "Patient Portion" Invoice?
          GOTO      PHFC5473 IF EQUAL            * then bypass         *I-65745
.
          MOVE      PTINMVDY,TSERVS              * save mv billing days
.
PHFC5755  IF        TSERVS = 0
            MOVE      ONE,TSERVS
          ENDIF
          MOVE      TSERVS,VARIABLE
          GOTO      PHFC7500
.
. ----- Other Services Amount Charged -----
.
PHFC5760  COMPARE   SIX,SERVFLAG
          GOTO      PHFC1000 IF EQUAL
.
.         Reposition in DTR file in case another routine has read another
.         record in the DTR file
.
          MOVE      SAVKEY22,KEY22
          CALL      RDDTRN1
.
          PACK      KEY5,CATFI,TMISGRP
          CALL      RDCODE1                      * code on file ?
          BRANCH    OVRCD,PHFC1000               * no - ignore
.
          MATCH     "1",TCINDC6                  * indicator set to print ?
          GOTO      PHFC1000 IF NOT EQUAL        * No - ignore
.
          CALL      CRNT0000                     * Check Credit note
          BRANCH    EXIT,PHFC1000                * Credited
          IF        EXIT=2
            SUB       FORM12P2,TPATAMTT
          ENDIF
.
.          IF        TSERVS > 1
.            DIV       TSERVS,TPATAMTT
.          ENDIF
.
          MOVE      TPATAMTT,FORM6P2
          MOVE      FORM6P2,VARIABLE
          GOTO      PHFC7500
.
. -----  Non-Acute Length of Stay -----
.
PHFC5770  BRANCH    FRSTFLAG,PHFC1000
.
          MATCH     SP3,ATYPE                    * code blank ?
          GOTO      PHFC1000 IF EQUAL            * yes
.
          PACK      KEY5,CATA,ATYPE
          CALL      RDCODE1                      * codes record on file ?
          BRANCH    OVRCD,PHFC1000               * no - ignore
.
          MATCH     TCINDC2,ANSN                 * non-acute stay ?
          GOTO      PHFC1000 IF NOT EQUAL        * no - ignore
.
          MOVE      ZERO,FORM1
          CALL      GTLOS000                     * get length of stay
.
          MOVE      LOSDAYS,VARIABLE
          GOTO      PHFC7500
.
. -----  Leave Days -----
.
PHFC5780  BRANCH    FRSTFLAG,PHFC1000
.
          MOVE      ONE,FORM1
          CALL      GTLOS000                     * get leave days
.
          MOVE      LOSDAYS,VARIABLE
          GOTO      PHFC7500
.
. ----- Hours on Mechanical Ventilation -----
.
PHFC5790  BRANCH    FRSTFLAG,PHFC1000
.
          PACK      KEY8,AADMNO
          CALL      RDPTICU1
          BRANCH    OVRCD,PHFC1000
.
          MOVE      PTICUMEC,VARIABLE
          GOTO      PHFC7500
.
. ----- Transfer Out -----
.
PHFC5800  BRANCH    FRSTFLAG,PHFC1000 
.
          PACK      TCODE,ANSD,PTCNDSTT
          LOAD      ACODE,PTCNDSTT,DUSD1,DUSD2,DUSD3,DUSD4,DUSD5
.
          MATCH     SP3,ACODE                    * transfer code blank ?
          GOTO      PHFC1000 IF EQUAL            * yes - ignore
.
          PACK      KEY5,TCODE,ACODE
          CALL      RDCODE1                      * code on file ?
          BRANCH    OVRCD,PHFC1000               * no - ignore
.
          MOVE      THCSCOD,VARIABLE
          GOTO      PHFC7500
.
PHFC5810  PACK      VARIABLE,PAGEDESC,CPAGENO
          GOTO      PHFC7500
.
. ----- MBS code description -----
.
PHFC5820  COMPARE   SIX,MMBSFLAG
          GOTO      PHFC1000 IF EQUAL
.
          MOVE      DTRIDESC,VARIABLE
          GOTO      PHFC7500
.
. ----- Daycase banding 1 -----
.
PHFC5830  BRANCH    FRSTFLAG,PHFC1000 
.
          PACK      KEY5,ANSA,SP1,ATYPE
          CALL      RDCODE1                 * Read the codes file
          IF        OVRCD<>1
            IF        TCFORM6=1
              MOVE      "X",VARIABLE
            ENDIF
          ENDIF
          GOTO      PHFC7500
.
. ----- Daycase banding 2 -----
.
PHFC5840  BRANCH    FRSTFLAG,PHFC1000 
.
          PACK      KEY5,ANSA,SP1,ATYPE
          CALL      RDCODE1                 * Read the codes file
          IF        OVRCD<>1
            IF        TCFORM6=2
              MOVE      "X",VARIABLE
            ENDIF
          ENDIF
          GOTO      PHFC7500
.
. ----- Daycase banding 3 -----
.
PHFC5850  BRANCH    FRSTFLAG,PHFC1000 
.
          PACK      KEY5,ANSA,SP1,ATYPE
          CALL      RDCODE1                 * Read the codes file
          IF        OVRCD<>1
            IF        TCFORM6=3
              MOVE      "X",VARIABLE
            ENDIF
          ENDIF
          GOTO      PHFC7500
.
. ----- Daycase banding 4 -----
.
PHFC5860  BRANCH    FRSTFLAG,PHFC1000 
.
          PACK      KEY5,ANSA,SP1,ATYPE
          CALL      RDCODE1                 * Read the codes file
          IF        OVRCD<>1
            IF        TCFORM6=4
              MOVE      "X",VARIABLE
            ENDIF
          ENDIF
          GOTO      PHFC7500
.
. ----- Attending doctor type -----
.
PHFC5870  BRANCH    FRSTFLAG,PHFC1000 
.
          MATCH     SP6,ADOCTA
          IF        !@EQUAL
            PACK      KEY6,ADOCTA
            CALL      RDDOCT1               * Read a doctor file record
            IF        OVRCD<>1
              MOVE      DRTYPE,VARIABLE
            ENDIF
          ENDIF
          GOTO      PHFC7500
.
. ----- Repat no -----
.
PHFC5880  BRANCH    FRSTFLAG,PHFC1000
          MOVE      THREE,DIM1
          CALL      GCCARD00
          MOVE      PMCDCNUM,VARIABLE
          GOTO      PHFC7500
.
. ----- Attending doctor provider no -----
.
PHFC5890  BRANCH    FRSTFLAG,PHFC1000
.
          MATCH     SP6,ADOCTA
          IF        !@EQUAL
            PACK      KEY6,ADOCTA
            CALL      RDDOCT1               * Read a doctor file record
            IF        OVRCD<>1
              MOVE      DPROV,VARIABLE
            ENDIF
          ENDIF
          GOTO      PHFC7500
.
. ----- 'Z' if discharged home -----
.
PHFC5900  BRANCH    FRSTFLAG,PHFC1000
.
          PACK      TCODE,ANSD,ANSD
          PACK      KEY2,ANSD,SP2
          LOAD      TCODE,PTCNDRSM,KEY2
          MOVE      DDEST,ACODE
          LOAD      ACODE,PTCNDRSM,DSTAT
.
          MATCH     SP3,ACODE
          IF        !@EQUAL
            PACK      KEY5,TCODE,ACODE
            CALL      RDCODE1               * Read a codes file record
            IF        OVRCD<>1
              MATCH     ANSZ,TCINDC1
              IF        @EQUAL
                MOVE      ANSZ,VARIABLE
              ENDIF
            ENDIF
          ENDIF
          GOTO      PHFC7500
.
. ----- Discharge status / destination description -----
.
PHFC5910  BRANCH    FRSTFLAG,PHFC1000
.
          PACK      TCODE,ANSD,ANSD
          PACK      KEY2,ANSD,SP2
          LOAD      TCODE,PTCNDRSM,KEY2
          MOVE      DDEST,ACODE
          LOAD      ACODE,PTCNDRSM,DSTAT
.
          MATCH     SP3,ACODE
          IF        !@EQUAL
            PACK      KEY5,TCODE,ACODE
            CALL      RDCODE1               * Read a codes file record
            IF        OVRCD<>1
              MOVE      TDESC,VARIABLE
            ENDIF
          ENDIF
          GOTO      PHFC7500
.
. ----- Lumpsum payments -----
.
PHFC5920  BRANCH    FRSTFLAG,PHFC1000
          MOVE      ONE,FORM1
          MOVE      ZERO,FORM82
          MOVE      AADMNO,TADMNO
          PACK      KEY22,TADMNO,SP20
          CALL      RDSDTRN1                * Position on the DTR file
PHFC5922  CALL      RDKDTRN1                * Read the DTR file
          BRANCH    OVRCD,PHFC7500
.
          MATCH     AADMNO,TADMNO
          GOTO      PHFC7500 IF NOT EQUAL   * Different admission
.
          COMPARE   ZERO,TINVPRT
          GOTO      PHFC5922 IF EQUAL       * Not invoiced
.
          IF        INVFLAG > 0
            MATCH     TREF,HFCFINVN
            GOTO      PHFC5922 IF NOT EQUAL      * must be on last invoice
          ENDIF
.
          COMPARE   TRECTYPE,FORM1
          GOTO      PHFC5922 IF NOT EQUAL   * not accommodation record
.
          PACK      KEY22,TADMNO,TREF,TTRANSN1,SP70
          CALL      CRNT0000
          BRANCH    EXIT,PHFC5922           * Credit note
.
          MOVE      PTDTLSRB,FORM82         * lumpsum
          ADD       PTDTLSPT,FORM82
          COMPARE   ZERO,FORM82
          GOTO      PHFC5922 IF EQUAL
.
          MOVE      FORM82,VARIABLE
          MOVE      "11",PRNTSTRT
          SUB       IBDTPLEN,PRNTSTRT
          GOTO      PHFC8000
.
. ----- Print provisional casemix code ----
.
PHFC5930  BRANCH    FRSTFLAG,PHFC1000
          MOVE      PTMIPCMX,VARIABLE
          GOTO      PHFC7500
.
. ----- Print provisional casemix code description -----
.
PHFC5940  BRANCH    FRSTFLAG,PHFC1000
          MATCH     SP9,PTMIPCMX
          GOTO      PHFC1000 IF EQUAL       * no casemix code
.
          UNPACK    SP10,KEY4,KEY5
          UNPACK    PTMIPCMX,KEY4,KEY5
          MATCH     SP5,KEY5
          IF        @EQUAL
            OPEN      PATDGWA1,"patdgwaf"
            MOVE      "999",KEY3
            PACK      KEY7,KEY4,KEY3,SP10   * last DRG version        *I-137125
            CALL      RSPTDGW1
            CALL      RPPTDGW1                                        *C-127125
            BRANCH    OVRCD,PHFC1000
            MATCH     KEY4,PTDWDRGC         * correct DRG code ?      *I-137125
            GOTO      PHFC1000 IF NOT EQUAL                           *I-137125
            MOVE      PTDWDESC,VARIABLE
          ELSE
            MOVE      PTMIPCMX,KEY9
            PACK      KEY17,KEY9,ADATE,SP70
            CALL      PATITMRD
            BRANCH    OVRCD,PHFC1000
            MOVE      IDESC,VARIABLE
          ENDIF
          GOTO      PHFC7500
.
. ----- Patient address line 4 -----
.
PHFC5950  BRANCH    FRSTFLAG,PHFC1000
          MOVE      PADD4,VARIABLE
          GOTO      PHFC7500
.
. ----- Attending doctor surgery address line 4 (admission) -----
.
PHFC5960  BRANCH    FRSTFLAG,PHFC1000                       
          CALL      DOCTAD00                * Get the doctors record for this
.                                             admission
          BRANCH    EXIT,PHFC7500
.
          MOVE      DSADD4,VARIABLE
          GOTO      PHFC7500                                
.
. ----- Attending doctor surgery address line 4 (discharge) -----
.
PHFC5970  BRANCH    FRSTFLAG,PHFC1000
          CALL      DOCTDS00                * Get the doctors record for this
.                                             discharge
          IF        OVRCD=1
            GOTO      PHFC7500
          ENDIF
.
          MOVE      DSADD4,VARIABLE
          GOTO      PHFC7500
.
. ----- Referring doctor address line 4 -----
.
PHFC5980  BRANCH    FRSTFLAG,PHFC1000
          IF        CRDRTYP<>1
            PACK      KEY6,ADOCTR
            CALL      RDDOCT1               * Read the doctors file
            IF        OVRCD=1
              GOTO      PHFC7500
            ENDIF
.
            MOVE      DSADD4,VARIABLE
          ENDIF
          GOTO      PHFC7500
.
. ----- 'X' if indeterminate -----
.
PHFC5990  BRANCH    FRSTFLAG,PHFC1000
          MATCH     ANSI,PSEX
          IF        @EQUAL
            MOVE      ANSX,VARIABLE         * Indeterminate
          ENDIF
          GOTO      PHFC7500
.
. ----- 'X' if unknown -----
.
PHFC6000  BRANCH    FRSTFLAG,PHFC1000
          MATCH     ANSU,PSEX
          IF        @EQUAL
            MOVE      ANSX,VARIABLE         * Unknown 
          ENDIF
          GOTO      PHFC7500
.
. ----- Transfer In via paptdadaf & patvadaf
.
PHFC6010  PACK      KEY8,AADMNO,SP8         
          CALL      RDPTDAD1  
          BRANCH    OVRCD,PHFC7500
.
          PACK      KEY5,PTDAADTS,SP5
          CALL      RDPTVAD1
          BRANCH    OVRCD,PHFC7500
.
          MOVE      PTVADESC,VARIABLE   
          GOTO      PHFC7500
.
. ----- Transfer Out via paptdadaf & patvadaf
.
PHFC6020  PACK      KEY8,AADMNO,SP8         
          CALL      RDPTDAD1  
          BRANCH    OVRCD,PHFC7500
.
          PACK      KEY5,PTDADCTS,SP5
          CALL      RDPTVAD1
          BRANCH    OVRCD,PHFC7500
.
          MOVE      PTVADESC,VARIABLE   
          GOTO      PHFC7500
.
. ----- Arrival Time for first Theatre session for an Admission Number
.
PHFC6030  BRANCH    FRSTFLAG,PHFC1000
          MOVE      ZERO,FORM1                                         *I-55477
          CALL      GTTHT000
          GOTO      PHFC7500
.
. ----- Exit Time for First Theatre session for an Admission Number
.
PHFC6040  BRANCH    FRSTFLAG,PHFC1000
          MOVE      ONE,FORM1                                          *I-55477
          CALL      GTTHT000
          GOTO      PHFC7500
.
. ----- Patient Marital Status
.
PHFC6050  BRANCH    FRSTFLAG,PHFC1000
          MOVE      PMSTAT,VARIABLE                                    *I-55723
          GOTO      PHFC7500
.
. ----- Patient Country of Birth
.
PHFC6060  BRANCH    FRSTFLAG,PHFC1000
          MOVE      PCONT,VARIABLE                                     *I-55723
          GOTO      PHFC7500
.
. ----- Patient Country of Birth Description
.
PHFC6070  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
.
          MATCH     SP3,PCONT                    * country of birth blank
          GOTO      PHFC1000 IF EQUAL            * yes - ignore
.
          PACK      KEY5,CATC,PCONT
          CALL      RDCODE1                      * codes record on file ?
          BRANCH    OVRCD,PHFC1000               * no - ignore
.
          MOVE      TDESC,VARIABLE
          GOTO      PHFC7500
.
. ----- Language at Home
.
PHFC6080  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      PMPXLNG1,VARIABLE
          GOTO      PHFC7500
.
. ----- Language at Home Description
.
PHFC6090  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
.
          MATCH     SP3,PMPXLNG1                 * language at home blank
          GOTO      PHFC1000 IF EQUAL            * yes - ignore
.
          PACK      KEY5,CATLA,PMPXLNG1
          CALL      RDCODE1                      * codes record on file ?
          BRANCH    OVRCD,PHFC1000               * no - ignore
.
          MOVE      TDESC,VARIABLE
          GOTO      PHFC7500
.
. ----- Payment Status on Separation
.
PHFC6100  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      PMVXPYSP,VARIABLE
          GOTO      PHFC7500
.
. ----- Readmission within 28 days
.
PHFC6110  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      PMVXREAD,VARIABLE
          GOTO      PHFC7500
.
. ----- Admission Type
.
PHFC6120  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      ATYPE,VARIABLE
          GOTO      PHFC7500
.
. ----- Claim Type
.
PHFC6130  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      ACLAIM,VARIABLE
          GOTO      PHFC7500
.
. ----- Service Category on Admission
.
PHFC6140  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      ACARE,VARIABLE
          GOTO      PHFC7500
.
. ----- Transfer Out via patdadaf (code only)
.
PHFC6150  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          PACK      KEY8,AADMNO,SP8
          CALL      RDPTDAD1
          BRANCH    OVRCD,PHFC1000
.
          MOVE      PTDADCTS,VARIABLE
          GOTO      PHFC7500
.
. ----- Source of Referral
.
PHFC6160  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      ASRCE,VARIABLE
          GOTO      PHFC7500
.
. ----- Separation Mode (code only)
.
PHFC6170  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
.                                                                     *C-140164
          IF        PTCNDRSM=1
            MOVE      DSTAT,VARIABLE
          ELSE
            MOVE      DDEST,VARIABLE
          ENDIF
          GOTO      PHFC7500
.
. ----- Contract Status on Admission
.
PHFC6180  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
.
          MATCH     SP3,ASRCE
          GOTO      PHFC1000 IF EQUAL
.
          PACK      KEY5,CATS,ASRCE
          CALL      RDCODE1
          BRANCH    OVRCD,PHFC1000
.
          UNPACK    THCSCOD,DIM1                      * first position of 
          MOVE      DIM1,VARIABLE                     * admission source
          GOTO      PHFC7500                          * contains contract status
.
. ----- Principal Diagnosis (Description) Episode 1
.
PHFC6190  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      "1",FORM3                                         *C-240107
          CALL      GETD0000
          BRANCH    EXIT,PHFC1000
          GOTO      PHFC7500
.
. ----- Secondary Diagnosis 1 (Description) Episode 1
.
PHFC6200  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      "2",FORM3                                         *C-240107
          CALL      GETD0000
          BRANCH    EXIT,PHFC1000
          GOTO      PHFC7500
.
. ----- Secondary Diagnosis 2 (Description) Episode 1
.
PHFC6210  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      "3",FORM3                                         *C-240107
          CALL      GETD0000
          BRANCH    EXIT,PHFC1000
          GOTO      PHFC7500
.
. ----- Secondary Diagnosis 3 (Description) Episode 1
.
PHFC6220  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      "4",FORM3                                         *C-240107
          CALL      GETD0000
          BRANCH    EXIT,PHFC1000
          GOTO      PHFC7500
.
. ----- Secondary Diagnosis 4 (Description) Episode 1
.
PHFC6230  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      "5",FORM3                                         *C-240107
          CALL      GETD0000
          BRANCH    EXIT,PHFC1000
          GOTO      PHFC7500
.
. ----- Secondary Diagnosis 5 (Description) Episode 1
.
PHFC6240  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      "6",FORM3                                         *C-240107
          CALL      GETD0000
          BRANCH    EXIT,PHFC1000
          GOTO      PHFC7500
.
. ----- Secondary Diagnosis 6 (Description) Episode 1
.
PHFC6250  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      "7",FORM3                                         *C-240107
          CALL      GETD0000
          BRANCH    EXIT,PHFC1000
          GOTO      PHFC7500
.
. ----- Secondary Diagnosis 7 (Description) Episode 1
.
PHFC6260  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      "8",FORM3                                         *C-240107
          CALL      GETD0000
          BRANCH    EXIT,PHFC1000
          GOTO      PHFC7500
.
. ----- Secondary Diagnosis 8 (Description) Episode 1
.
PHFC6270  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      "9",FORM3                                         *C-240107
          CALL      GETD0000
          BRANCH    EXIT,PHFC1000
          GOTO      PHFC7500
.
. ----- Secondary Diagnosis 9 (Description) Episode 1
.
PHFC6280  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      "10",FORM3                                        *C-240107
          CALL      GETD0000
          BRANCH    EXIT,PHFC1000
          GOTO      PHFC7500
.
. ----- Secondary Diagnosis 10 (Description) Episode 1
.
PHFC6290  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      "11",FORM3                                        *C-240107
          CALL      GETD0000
          BRANCH    EXIT,PHFC1000
          GOTO      PHFC7500
.
. ----- Secondary Diagnosis 11 (Description) Episode 1
.
PHFC6300  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      "12",FORM3                                        *C-240107
          CALL      GETD0000
          BRANCH    EXIT,PHFC1000
          GOTO      PHFC7500
.
. ----- Secondary Diagnosis 12 (Description) Episode 1
.
PHFC6310  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      "13",FORM3                                        *C-240107
          CALL      GETD0000
          BRANCH    EXIT,PHFC1000
          GOTO      PHFC7500
.
. ----- Secondary Diagnosis 13 (Description) Episode 1
.
PHFC6320  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      "14",FORM3                                        *C-240107
          CALL      GETD0000
          BRANCH    EXIT,PHFC1000
          GOTO      PHFC7500
.
. ----- Secondary Diagnosis 14 (Description) Episode 1
.
PHFC6330  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      "15",FORM3                                        *C-240107
          CALL      GETD0000
          BRANCH    EXIT,PHFC1000
          GOTO      PHFC7500
.
. ----- Secondary Diagnosis 15 (Description) Episode 1
.
PHFC6340  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      "16",FORM3                                        *C-240107
          CALL      GETD0000
          BRANCH    EXIT,PHFC1000
          GOTO      PHFC7500
.
. ----- Primary Procedure (Description) Episode 1
.
PHFC6350  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      "1",FORM3                                         *C-240107
          CALL      GETP0000
          BRANCH    EXIT,PHFC1000
          GOTO      PHFC7500
.
. ----- Secondary Procedure 1 (Description) Episode 1
.
PHFC6360  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      "2",FORM3                                         *C-240107
          CALL      GETP0000
          BRANCH    EXIT,PHFC1000
          GOTO      PHFC7500
.
. ----- Secondary Procedure 2 (Description) Episode 1
.
PHFC6370  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      "3",FORM3                                         *C-240107
          CALL      GETP0000
          BRANCH    EXIT,PHFC1000
          GOTO      PHFC7500
.
. ----- Secondary Procedure 3 (Description) Episode 1
.
PHFC6380  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      "4",FORM3                                         *C-240107
          CALL      GETP0000
          BRANCH    EXIT,PHFC1000
          GOTO      PHFC7500
.
. ----- Secondary Procedure 4 (Description) Episode 1
.
PHFC6390  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      "5",FORM3                                         *C-240107
          CALL      GETP0000
          BRANCH    EXIT,PHFC1000
          GOTO      PHFC7500
.
. ----- Secondary Procedure 5 (Description) Episode 1
.
PHFC6400  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      "6",FORM3                                         *C-240107
          CALL      GETP0000
          BRANCH    EXIT,PHFC1000
          GOTO      PHFC7500
.
. ----- Secondary Procedure 6 (Description) Episode 1
.
PHFC6410  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      "7",FORM3                                         *C-240107
          CALL      GETP0000
          BRANCH    EXIT,PHFC1000
          GOTO      PHFC7500
.
. ----- Secondary Procedure 7 (Description) Episode 1
.
PHFC6420  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      "8",FORM3                                         *C-240107
          CALL      GETP0000
          BRANCH    EXIT,PHFC1000
          GOTO      PHFC7500
.
. ----- Secondary Procedure 8 (Description) Episode 1
.
PHFC6430  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      "9",FORM3                                         *C-240107
          CALL      GETP0000
          BRANCH    EXIT,PHFC1000
          GOTO      PHFC7500
.
. ----- Secondary Procedure 9 (Description) Episode 1
.
PHFC6440  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      "10",FORM3                                        *C-240107
          CALL      GETP0000
          BRANCH    EXIT,PHFC1000
          GOTO      PHFC7500
.
. ----- Secondary Procedure 10 (Description) Episode 1
.
PHFC6450  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      "11",FORM3                                        *C-240107
          CALL      GETP0000
          BRANCH    EXIT,PHFC1000
          GOTO      PHFC7500
.
. ----- Secondary Procedure 11 (Description) Episode 1
.
PHFC6460  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      "12",FORM3                                        *C-240107
          CALL      GETP0000
          BRANCH    EXIT,PHFC1000
          GOTO      PHFC7500
.
. ----- Secondary Procedure 12 (Description) Episode 1
.
PHFC6470  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      "13",FORM3                                        *C-240107
          CALL      GETP0000
          BRANCH    EXIT,PHFC1000
          GOTO      PHFC7500
.
. ----- Secondary Procedure 13 (Description) Episode 1
.
PHFC6480  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      "14",FORM3                                        *C-240107
          CALL      GETP0000
          BRANCH    EXIT,PHFC1000
          GOTO      PHFC7500
.
. ----- Secondary Procedure 14 (Description) Episode 1
.
PHFC6490  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      "15",FORM3                                        *C-240107
          CALL      GETP0000
          BRANCH    EXIT,PHFC1000
          GOTO      PHFC7500
.
. ----- Secondary Procedure 15 (Description) Episode 1
.
PHFC6500  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      "16",FORM3                                        *C-240107
          CALL      GETP0000
          BRANCH    EXIT,PHFC1000
          GOTO      PHFC7500
.
. ----- Principal Procedure (Block Code) Episode 1
.
PHFC6510  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      " 1",DIM2
          CALL      GTBC0000
          BRANCH    EXIT,PHFC1000
          GOTO      PHFC7500
.
. ----- Secondary Procedure 1 (Block Code) Episode 1
.
PHFC6520  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      " 2",DIM2
          CALL      GTBC0000
          BRANCH    EXIT,PHFC1000
          GOTO      PHFC7500
.
. ----- Secondary Procedure 2 (Block Code) Episode 1
.
PHFC6530  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      " 3",DIM2
          CALL      GTBC0000
          BRANCH    EXIT,PHFC1000
          GOTO      PHFC7500
.
. ----- Secondary Procedure 3 (Block Code) Episode 1
.
PHFC6540  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      " 4",DIM2
          CALL      GTBC0000
          BRANCH    EXIT,PHFC1000
          GOTO      PHFC7500
.
. ----- Secondary Procedure 4 (Block Code) Episode 1
.
PHFC6550  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      " 5",DIM2
          CALL      GTBC0000
          BRANCH    EXIT,PHFC1000
          GOTO      PHFC7500
.
. ----- Secondary Procedure 5 (Block Code) Episode 1
.
PHFC6560  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      " 6",DIM2
          CALL      GTBC0000
          BRANCH    EXIT,PHFC1000
          GOTO      PHFC7500
.
. ----- Secondary Procedure 6 (Block Code) Episode 1
.
PHFC6570  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      " 7",DIM2
          CALL      GTBC0000
          BRANCH    EXIT,PHFC1000
          GOTO      PHFC7500
.
. ----- Secondary Procedure 7 (Block Code) Episode 1
.
PHFC6580  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      " 8",DIM2
          CALL      GTBC0000
          BRANCH    EXIT,PHFC1000
          GOTO      PHFC7500
.
. ----- Secondary Procedure 8 (Block Code) Episode 1
.
PHFC6590  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      " 9",DIM2
          CALL      GTBC0000
          BRANCH    EXIT,PHFC1000
          GOTO      PHFC7500
.
. ----- Secondary Procedure 9 (Block Code) Episode 1
.
PHFC6600  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      "10",DIM2
          CALL      GTBC0000
          BRANCH    EXIT,PHFC1000
          GOTO      PHFC7500
.
. ----- Secondary Procedure 10 (Block Code) Episode 1
.
PHFC6610  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      "11",DIM2
          CALL      GTBC0000
          BRANCH    EXIT,PHFC1000
          GOTO      PHFC7500
.
. ----- Secondary Procedure 11 (Block Code) Episode 1
.
PHFC6620  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      "12",DIM2
          CALL      GTBC0000
          BRANCH    EXIT,PHFC1000
          GOTO      PHFC7500
.
. ----- Secondary Procedure 12 (Block Code) Episode 1
.
PHFC6630  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      "13",DIM2
          CALL      GTBC0000
          BRANCH    EXIT,PHFC1000
          GOTO      PHFC7500
.
. ----- Secondary Procedure 13 (Block Code) Episode 1
.
PHFC6640  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      "14",DIM2
          CALL      GTBC0000
          BRANCH    EXIT,PHFC1000
          GOTO      PHFC7500
.
. ----- Secondary Procedure 14 (Block Code) Episode 1
.
PHFC6650  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      "15",DIM2
          CALL      GTBC0000
          BRANCH    EXIT,PHFC1000
          GOTO      PHFC7500
.
. ----- Secondary Procedure 15 (Block Code) Episode 1
.
PHFC6660  BRANCH    FRSTFLAG,PHFC1000                                  *I-55723
          MOVE      "16",DIM2
          CALL      GTBC0000
          BRANCH    EXIT,PHFC1000
          GOTO      PHFC7500
.
. ----- Print X if Unplanned Visit During episode is YES -----         *C-V-001
.
PHFC6670  PACK      KEY5,ANSK,ANSB,PMVXUVTH,SP5
          CALL      RDCODE1                      * code on file ?
          BRANCH    OVRCD,PHFC1000               * no - ignore
.
          UNPACK    THCSCOD,DIM1
          MATCH     "1",DIM1                     * 1st pos 1
          GOTO      PHFC1000 IF NOT EQUAL        * ignore if not 1
          MOVE      ANSX,VARIABLE                * set to X if 1
.
          GOTO      PHFC7500
.
. ----- Print X if Unplanned Visit During episode is NO -----          *C-V-001
.
PHFC6680  PACK      KEY5,ANSK,ANSB,PMVXUVTH,SP5
          CALL      RDCODE1                      * code on file ?
          BRANCH    OVRCD,PHFC1000               * no - ignore
.
          UNPACK    THCSCOD,DIM1
          MATCH     "2",DIM1                     * 1st pos 2
          GOTO      PHFC1000 IF NOT EQUAL        * ignore if not 2
          MOVE      ANSX,VARIABLE                * set to X if 2
.
          GOTO      PHFC7500
.
. ----- Payement Type Code -----                                       *C-V-005
.
PHFC6690  COMPARE   SIX,TRANFLAG                 * printed all TRN recs ?
          GOTO      PHFC1000 IF EQUAL            * yes - ignore item
.
          MATCH     SP1,PTMICMXP
          GOTO      PHFC1000 IF EQUAL            * no casepayment
.
          MATCH     ANSN,PTMICMXP
          IF        @EQUAL
            MOVE      ONE,VARIABLE               * Per Diem
            GOTO      PHFC7500
          ENDIF
.
          MATCH     ANSY,PTMICMXP
          IF        @EQUAL
            MOVE      TWO,VARIABLE               * Casepayment
            GOTO      PHFC7500
          ENDIF
.
          GOTO      PHFC1000
.
. ----- Urgency of Admission code ----                                 *C-V-007
.
PHFC6700  BRANCH    FRSTFLAG,PHFC1000
          MOVE      NINE,VARIABLE                * default
.
          PACK      ACODE,SP2
          PACK      TCODE,ANSP,SP1
          PACK      ACODE,ACLSS,SP3
          PACK      KEY5,TCODE,ACODE,SP5
          CALL      RDCODE1                      * code on file ?
          BRANCH    OVRCD,PHFC7500               * no - default
.
          UNPACK    THCSCOD,DIM2,DIM1            * 3rd pos.
          MATCH     SP1,DIM1
          GOTO      PHFC7500 IF EQUAL            * sp1 - default
.
          MOVE      DIM1,VARIABLE
          GOTO      PHFC7500
.
. ----- Care Class Code ----                                           *C-V-008
.
PHFC6710  BRANCH    FRSTFLAG,PHFC1000
          MATCH     SP3,ACARE
          GOTO      PHFC1000 IF EQUAL            * no care class
.
          PACK      ACODE,SP2
          PACK      TCODE,CATCC
          PACK      ACODE,ACARE,SP3
          PACK      KEY5,TCODE,ACODE,SP5
          CALL      RDCODE1                      * code on file ?
          BRANCH    OVRCD,PHFC1000               * no - ignore
.
.-------- *T0889652 - use User Defined Field 4 for adm after 01/07/2020
.--------- MATCH     DTYR2020,ADATE
.--------- GOTO      PHFC6712 IF NOT LESS
.
          MATCH     DTYR2019,ADATE               * admission before our date?
          GOTO      PHFC6711 IF NOT LESS
.
.         For admissions before 1st July 2019 use HDP Equiv.
          MATCH     SP4,PTCDNHCP
          GOTO      PHFC1000 IF EQUAL            * no HDP Equiv.
.
          MOVE      PTCDNHCP,VARIABLE
          GOTO      PHFC7500
.
.         For admissions on OR after 1st July 2019, use User Defined Field 3
PHFC6711  MOVE      PTCDUDF3,VARIABLE            * use User Defined Field 3
          GOTO      PHFC7500
.
.-------- *T0889652 - use User Defined Field 4 for adm after 01/07/2020 
.PHFC6712  MOVE      PTCDUDF4,VARIABLE            * use User Defined Field 4
.--------  GOTO      PHFC7500
.
. ----- ICU Hours ----                                                 *C-V-009
.
PHFC6720  BRANCH    FRSTFLAG,PHFC1000
          PACK      KEY8,AADMNO
          CALL      RDPTICU1
          BRANCH    OVRCD,PHFC1000
.
          MOVE      PTICUINT,VARIABLE
          GOTO      PHFC7500
.
. ----- Source of Referral -----                                       *C-V-010
.
PHFC6730  BRANCH    FRSTFLAG,PHFC1000
          MATCH     SP3,ASRCE
          GOTO      PHFC1000 IF EQUAL            * no Source of ref
.
          PACK      ACODE,SP2
          PACK      TCODE,ANSS,SP1
          PACK      ACODE,ASRCE,SP3
          PACK      KEY5,TCODE,ACODE,SP5
          CALL      RDCODE1                      * code on file ?
          BRANCH    OVRCD,PHFC1000               * no - ignore
.
          MATCH     SP1,TCINDC3
          GOTO      PHFC1000 IF EQUAL            * no Source of ref
.
          MOVE      TCINDC3,VARIABLE
          GOTO      PHFC7500
.
. ----- Mental Health Legal Status ----                                *C-V-011
.
PHFC6740  BRANCH    FRSTFLAG,PHFC1000
          PACK      ACODE,SP2
.
          IF        PTCNCSTA=7
            PACK      KEY8,DAADMNO,SP70
            CALL      RDPMVX11
            BRANCH    OVRCD,PHFC1000
.
            PACK      TCODE,CATLS                * if 7 use cat LS
            PACK      ACODE,PMVXMHLS,SP3
          ELSE
            IF        PTCNCSTA=6
              PACK      TCODE,CATCC              * if 6 use cat CC
              PACK      ACODE,ACARE,SP3
            ELSE
              PACK      TCODE,ANSD,PTCNCSTA      * user Def 1-5
              LOAD      ACODE,PTCNCSTA,DUSD1,DUSD2,DUSD3,DUSD4,DUSD5
            ENDIF
          ENDIF
.
          PACK      KEY5,TCODE,ACODE,SP5
          CALL      RDCODE1                      * code on file ?
          BRANCH    OVRCD,PHFC1000               * no - ignore
.
          MATCH     DTYR2019,ADATE               * admission before our date?
          GOTO      PHFC6741 IF NOT LESS
.
.         For admissions before 1st July 2019 use HCP Equiv (pos. 1)
          UNPACK    THCSCOD,DIM1                 * 1st pos.
          MATCH     SP1,DIM1
          GOTO      PHFC1000 IF EQUAL            * sp1 - ignore
.
          MOVE      DIM1,VARIABLE
          GOTO      PHFC7500
.
.         For admissions on OR after 1st July 2019, use User Defined Field 5
PHFC6741  MOVE      PTCDUDF5,VARIABLE            * use User Defined Field 5
          GOTO      PHFC7500
.
. ----- Inter-Hospital Contracted Patient ----                         *C-V-012
.
PHFC6750  BRANCH    FRSTFLAG,PHFC1000
          MOVE      NINE,VARIABLE                * default
.
          PACK      ACODE,SP2
          PACK      TCODE,ANSS,SP1
          PACK      ACODE,ASRCE,SP3
          PACK      KEY5,TCODE,ACODE,SP5
          CALL      RDCODE1                      * code on file ?
          BRANCH    OVRCD,PHFC7500               * no - default
.
.-------- *T0889652 - Use Indicator 14 for adm after 01/07/2020
          MATCH     DTYR2020,ADATE
          GOTO      PHFC6751 IF NOT LESS
.     
          MATCH     SP1,TCINDC6
          GOTO      PHFC7500 IF EQUAL            * sp1 - use default
.
          MOVE      TCINDC6,VARIABLE
          GOTO      PHFC7500
.
.-------- *T0889652 - Use Indicator 14 for adm after 01/07/2020
PHFC6751  MATCH     SP1,TCINDC14                 * use default 
          GOTO      PHFC7500 IF EQUAL
.
          MOVE      TCINDC14,VARIABLE            * use ind14    
          GOTO      PHFC7500
.
. ----- Provider Number of Hospital Tranferred From -----              *C-V-013
.
PHFC6760  BRANCH    FRSTFLAG,PHFC1000
          PACK      KEY8,AADMNO,SP8
          CALL      RDPTDAD1
          BRANCH    OVRCD,PHFC1000
.
          PACK      KEY5,PTDAADTS,SP5
          CALL      RDPTVAD1
          BRANCH    OVRCD,PHFC1000
.
          MOVE      PTVAPROV,VARIABLE
          GOTO      PHFC7500
.
. ----- Provider Number of Hospital Tranferred To -----                *C-V-014
.
PHFC6770  BRANCH    FRSTFLAG,PHFC1000
          PACK      KEY8,AADMNO,SP8
          CALL      RDPTDAD1
          BRANCH    OVRCD,PHFC1000
.
          PACK      KEY5,PTDADCTS,SP5
          CALL      RDPTVAD1
          BRANCH    OVRCD,PHFC1000
.
          MOVE      PTVAPROV,VARIABLE
          GOTO      PHFC7500
.
. ----- Theatre Arrivals Time -----                                    *C-V-015
.
PHFC6780  COMPARE   SIX,THETIMES
          GOTO      PHFC1000 IF EQUAL
.
          MOVE      SAVTHT11,KEY11
          CALL      RDMMBS1
          IF        OVRCD=0
            MOVE      MMSTIM,VARIABLE
          ENDIF
          GOTO      PHFC7500
.
. ----- Theatre Exit Time -----                                        *C-V-015
.
PHFC6790  COMPARE   SIX,THETIMES
          GOTO      PHFC1000 IF EQUAL
.
          MOVE      SAVTHT11,KEY11
          CALL      RDMMBS1
          IF        OVRCD=0
            MOVE      MMETIM,VARIABLE
          ENDIF
          GOTO      PHFC7500
.
. ----- Acute Certificates Required Check Box -----                    *C-V-016
.
PHFC6800  BRANCH    FRSTFLAG,PHFC1000
          MATCH     SP3,ATYPE                    * admission type blank ?
          GOTO      PHFC1000 IF EQUAL            * yes - ignore
.
          PACK      KEY5,CATA,ATYPE
          CALL      RDCODE1                      * codes record on file ?
          BRANCH    OVRCD,PHFC1000               * no - ignore
.
          MATCH     TCINDC2,ANSN                 * acute stay ?
          GOTO      PHFC1000 IF EQUAL            * no - ignore
.
          MOVE      ZERO,FORM1
          CALL      GTLOS000                     * get length of stay
.
          IF        PT3BHOSP = 1
            ADD       ADYHOSP,LOSDAYS            * inc days hosp
          ENDIF
.
          IF        LOSDAYS > 35
            MOVE      ANSX,VARIABLE              * > than 35 days
          ENDIF
.
          GOTO      PHFC7500
.
. ----- Psychiatric Admission Type Check Box ----                      *C-V-017
.
PHFC6810  BRANCH    FRSTFLAG,PHFC1000
          MATCH     SP3,ATYPE                    * admission type blank ?
          GOTO      PHFC1000 IF EQUAL            * yes - ignore
.
          PACK      KEY5,CATA,ATYPE
          CALL      RDCODE1                      * codes record on file ?
          BRANCH    OVRCD,PHFC1000               * no - ignore
.
          IF        TCFORM6 = 10
            MOVE      ANSX,VARIABLE              * Psyc stay
          ENDIF
.
          GOTO      PHFC7500
.
. ----- Rehabilitation Check Box -----                                 *C-V-018
.
PHFC6820  BRANCH    FRSTFLAG,PHFC1000
          MATCH     SP3,ACARE                    * Care Class type blank ?
          GOTO      PHFC1000 IF EQUAL            * yes - ignore
.
          PACK      KEY5,CATCC,ACARE
          CALL      RDCODE1                      * codes record on file ?
          BRANCH    OVRCD,PHFC1000               * no - ignore
.
          MATCH     "2",TCINDC6                  * Rehabiliation?
          GOTO      PHFC1000 IF NOT EQUAL        * no - ignore
.
          MOVE      ANSX,VARIABLE
.
          GOTO      PHFC7500
.
. ----- ICU Hours Check Box -----                                      *C-V-019
.
PHFC6830  BRANCH    FRSTFLAG,PHFC1000
          PACK      KEY8,AADMNO
          CALL      RDPTICU1
          BRANCH    OVRCD,PHFC1000
.
          IF        PTICUINT > 0
            MOVE      ANSX,VARIABLE
          ENDIF
.
          GOTO      PHFC7500
.
. ----- NICU Hours Check Box -----                                     *C-V-020
. * does not exist in 5. actually only done in 9
.
PHFC6840  BRANCH    FRSTFLAG,PHFC1000
          PACK      KEY8,AADMNO
          CALL      RDPTICU1
          BRANCH    OVRCD,PHFC1000
.
          IF        PTICHNCU > 0
            MOVE      ANSX,VARIABLE
          ENDIF
.
          GOTO      PHFC7500
.
. ----- Other Charge code -----                                        *C-V-021
.
PHFC6850  COMPARE   SIX,SERVFLAG
          GOTO      PHFC1000 IF EQUAL
.
.         Reposition in DTR file in case another routine has read another
.         record in the DTR file
.
          MOVE      SAVKEY22,KEY22
          CALL      RDDTRN1
.
          PACK      KEY5,CATFI,TMISGRP
          CALL      RDCODE1                      * code on file ?
          BRANCH    OVRCD,PHFC1000               * no - ignore
.
          MATCH     "1",TCINDC6                  * indicator set to print ?
          GOTO      PHFC1000 IF NOT EQUAL        * No - ignore
.
          MOVE      TITEMNO,VARIABLE
.
          GOTO      PHFC7500
.
. ----- Day Case Banding Associate Code6 -----                         *C-V-022
.
PHFC6860  BRANCH    FRSTFLAG,PHFC1000
.
          CALL      SAMDY000                     * same day patient ?
          BRANCH    EXIT,PHFC1000                * no - ignore

          PACK      KEY5,ANSA,SP1,ATYPE
          CALL      RDCODE1                 * Read the codes file
          IF        OVRCD<>1
            MOVE      TCFORM6,DIM6
            SQUEEZE   DIM6
            MOVE      DIM6,VARIABLE
          ENDIF
          GOTO      PHFC7500
.
. ----- Patient Email Address                                          *C-V-023
.
PHFC6870  BRANCH    FRSTFLAG,PHFC1000
.
          MATCH     SP70,PMPXCONP
          IF        @EQUAL
            MOVE      ZERO,PMPXCONP
          ENDIF
.
          MOVE      PMPXCONP,FORM1
          BRANCH    FORM1,PHFC6873,PHFC6874,PHFC6875,PHFC6876,PHFC6877
          MOVE      PMPXPEML,VARIABLE
          GOTO      PHFC7500
.
PHFC6873  MOVE      PMPXMEML,VARIABLE
          GOTO      PHFC7500
.
PHFC6874  MOVE      PMPXFEML,VARIABLE
          GOTO      PHFC7500
.
PHFC6875  MOVE      PMPXKEML,VARIABLE
          GOTO      PHFC7500
.
PHFC6876  MOVE      PMPXCEML,VARIABLE
          GOTO      PHFC7500
.
PHFC6877  MOVE      PMPXREML,VARIABLE
          GOTO      PHFC7500
.
. ----- Patient Mobile Phone Number                                    *C-V-024
.
PHFC6880  BRANCH    FRSTFLAG,PHFC1000
.
          MATCH     SP70,PMPXCONP
          IF        @EQUAL
            MOVE      ZERO,PMPXCONP
          ENDIF
.
          MOVE      PMPXCONP,FORM1
          BRANCH    FORM1,PHFC6883,PHFC6884,PHFC6885,PHFC6886,PHFC6887
          MOVE      PTMXCELL,VARIABLE    
          GOTO      PHFC7500
.
PHFC6883  MOVE      PMPXMMNO,VARIABLE
          GOTO      PHFC7500
.
PHFC6884  MOVE      PMPXFMNO,VARIABLE
          GOTO      PHFC7500
.
PHFC6885  MOVE      PMPXKMOB,VARIABLE
          GOTO      PHFC7500
.
PHFC6886  MOVE      PMPXCMOB,VARIABLE
          GOTO      PHFC7500
.
PHFC6887  MOVE      PMPXRMOB,VARIABLE
          GOTO      PHFC7500
.
. ******************************************* start of addition        *I-62428
. ----- New-born Baby - Surname       -----
.                                           * Item 319
PHFC6890  COMPARE   CPAGENO,BBYNO
          GOTO      PHFC1000 IF LESS
.
          MOVE      BBYSNAME[CPAGENO],VARIABLE
          GOTO      PHFC7500
.
. ----- New-born Baby - Given Names   -----
.                                           * Item 320
PHFC6900  COMPARE   CPAGENO,BBYNO
          GOTO      PHFC1000 IF LESS
.
          MOVE      BBYGNAME[CPAGENO],VARIABLE
          GOTO      PHFC7500
.
. ----- New-born Baby - Date of Birth -----
.                                           * Item 321
PHFC6910  COMPARE   CPAGENO,BBYNO
          GOTO      PHFC1000 IF LESS
.
          UNPACK    BBYDOB[CPAGENO],CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE                      * Format baby's birth date
          IF        IBDTPLEN=8
            MOVE      CPDATE,VARIABLE
          ELSE
            MOVE      CPCDATE,VARIABLE
          ENDIF
          GOTO      PHFC7500
.
. ----- New-born Baby - Sex           -----
.                                           * Item 322
PHFC6920  COMPARE   CPAGENO,BBYNO
          GOTO      PHFC1000 IF LESS
.
          MOVE      BBYSEX[CPAGENO],VARIABLE
          GOTO      PHFC7500
.
. *******************************************   end of addition        *I-62428
.
. ----- DVA Service Category Code -----
.
PHFC6930  BRANCH    FRSTFLAG,PHFC1000
          MATCH     SP70,ACARE
          GOTO      PHFC1000 IF EQUAL
.
          PACK      ACODE,SP70
          PACK      TCODE,CATCC
          PACK      ACODE,ACARE,SP70
          PACK      KEY5,TCODE,ACODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,PHFC1000
.
          MATCH     SP70,TCINDC11
          GOTO      PHFC1000 IF EQUAL
.
          MOVE      TCINDC11,VARIABLE
          GOTO      PHFC7500
.
. ----- DVA Admission Type Code -----
.
PHFC6940  BRANCH    FRSTFLAG,PHFC1000
          MOVE      ACLSSFT,VARIABLE
          GOTO      PHFC7500,ACLSSFT
.
. ----- DVA Admission Type Code Description -----
.
PHFC6950  BRANCH    FRSTFLAG,PHFC1000
          MATCH     SP70,ACLSSFT
          GOTO      PHFC1000 IF EQUAL
.
          PACK      ACODE,SP70
          PACK      TCODE,CATAC
          PACK      ACODE,ACLSSFT,SP70
          PACK      KEY5,TCODE,ACODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,PHFC1000
.
          MATCH     SP70,TDESC
          GOTO      PHFC1000 IF EQUAL
.
          MOVE      TDESC,VARIABLE
          GOTO      PHFC7500
.
. ----- DVA Discharge Intention Code -----
.
PHFC6960  BRANCH    FRSTFLAG,PHFC1000
          MATCH     SP70,PMVXUDIN
          GOTO      PHFC1000 IF EQUAL
.
          PACK      ACODE,SP70
          PACK      TCODE,CATKN
          PACK      ACODE,PMVXUDIN,SP70
          PACK      KEY5,TCODE,ACODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,PHFC1000
.
          MATCH     SP70,TCINDC1
          GOTO      PHFC1000 IF EQUAL
.
          MOVE      TCINDC1,VARIABLE
          GOTO      PHFC7500
.
. ----- DVA Separation Code -----
.
PHFC6970  BRANCH    FRSTFLAG,PHFC1000
          PACK      ACODE,SP70                                        *C-140164
          IF        PTCNDRSM=1
            MATCH     SP70,DSTAT
            GOTO      PHFC1000 IF EQUAL
            PACK      TCODE,CATD,SP2
            PACK      ACODE,DSTAT,SP70
          ELSE
            MATCH     SP70,DDEST
            GOTO      PHFC1000 IF EQUAL
            PACK      TCODE,CATDD
            PACK      ACODE,DDEST,SP70
          ENDIF
.
          PACK      KEY5,TCODE,ACODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,PHFC1000
.
          MATCH     SP70,TCINDC6
          GOTO      PHFC1000 IF EQUAL
.
          MOVE      TCINDC6,VARIABLE
          GOTO      PHFC7500
.
. ----- MBS code Type B or Type C indicator-----
.
.PHFC6980  COMPARE   SIX,MMBSFLAG
.          GOTO      PHFC1000 IF EQUAL
.
.         PACK      KEY17,TITEMNO,SP70
.         CALL      PATITMRD
.
.         PACK      KEY5,CATCR,PTITTCER,SP70
.         CALL      RDCODE1
.         IF        OVRCD=0
.           IF        TCFORM6=1
.             MOVE      "(Type B)",VARIABLE
.           ENDIF
.           IF        TCFORM6=2
.             MOVE      "(Type C)",VARIABLE
.           ENDIF
.         ENDIF
.         GOTO      PHFC7500
.
PHFC6980  MOVE      BCCERINB,VARIABLE
          GOTO      PHFC7500
.
PHFC6990  MOVE      BCCERINC,VARIABLE
          GOTO      PHFC7500
.
PHFC6995  BRANCH    FRSTFLAG,PHFC1000
          CALL      GVRHCP00            * get visit referring hcp info (334-342)
          GOTO      PHFC7500
.
PHFC7000  CLOCK     TIME,VARIABLE                * Current Time
          GOTO      PHFC7500
.
. ---- Web user name ----
.
PHFC7005  MOVE      SP70,WBSENAM                 * Web user name
          MOVE      IBLPRUID,KEY10
          CALL      RDWBSE1

          MOVE      WBSENAM,VARIABLE
          GOTO      PHFC7500
.
. ---- Web user free format department ----
.
PHFC7010  MOVE      SP70,VARIABLE
          PACK      KEY10,IBLPRUID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,PHFC1000
.
          MOVE      WBSEFDEP,VARIABLE 
          GOTO      PHFC7500
.
. ---- Web user occupational group ---
.
PHFC7015  MOVE      SP70,VARIABLE
          PACK      KEY10,IBLPRUID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,PHFC1000
.
          MATCH     SP70,WBSEOCG
          GOTO      PHFC1000 IF EQUAL
.
          PACK      KEY5,CATW0,WBSEOCG,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      PTCDLDES,VARIABLE
          ENDIF
          GOTO      PHFC7500
.
. ----- Attending doctor title (admission) -----
.
PHFC7020  BRANCH    FRSTFLAG,PHFC1000
          CALL      DOCTAD00                * Get the doctors record for this
.                                             admission
          BRANCH    EXIT,PHFC7500
.
          MOVE      DTITL,VARIABLE
          GOTO      PHFC7500
.
. ----- Attending doctor first name (admission) -----
.
PHFC7025  BRANCH    FRSTFLAG,PHFC1000
          CALL      DOCTAD00                * Get the doctors record for this
.                                             admission
          BRANCH    EXIT,PHFC7500
.
          MOVE      DGNAME,VARIABLE
          GOTO      PHFC7500
.
. ----- Attending doctor surname (admission) -----
.
PHFC7030  BRANCH    FRSTFLAG,PHFC1000
          CALL      DOCTAD00                * Get the doctors record for this
.                                             admission
          BRANCH    EXIT,PHFC7500
.         
          MOVE      DSNAME,VARIABLE
          GOTO      PHFC7500
.
. ----- Attending doctor provider number (admission) -----
.
PHFC7035  BRANCH    FRSTFLAG,PHFC1000
          CALL      DOCTAD00                * Get the doctors record for this
.                                             admission
          BRANCH    EXIT,PHFC7500
.         
          MOVE      DPROV,VARIABLE
          GOTO      PHFC7500
.
. ----- Attending doctor type code (admission) -----
.
PHFC7040  BRANCH    FRSTFLAG,PHFC1000
          CALL      DOCTAD00                * Get the doctors record for this
.                                             admission
          BRANCH    EXIT,PHFC7500
.
          MOVE      DRTYPE,VARIABLE
          GOTO      PHFC7500
.
. ----- Admitting diagnosis code Description-----
.
PHFC7045  BRANCH    FRSTFLAG,PHFC1000
          PACK      IDESC,SP30,SP30
          PACK      KEY17,AMBS,ADATE,SP70
          CALL      PATITMRD
.
          MOVE      IDESC,VARIABLE
          GOTO      PHFC7500
.
.------- Patient Title Description -------
.
PHFC7050  PACK      KEY4,PTITL,SP10
          CALL      RDPMTLE1
          IF        OVRCD=1
            MOVE      PTITL,PMTLDESC
          ENDIF
          MOVE      PMTLDESC,VARIABLE
          GOTO      PHFC7500
.
.------ Patient First Name
.
PHFC7055  MOVE      PMPXFNAM,VARIABLE
          GOTO      PHFC7500
.
.------ Patient Second Name
.
PHFC7060  MOVE      PMPXSNAM,VARIABLE
          GOTO      PHFC7500
.
.------ Claim Type Description
.
PHFC7065  BRANCH    FRSTFLAG,PHFC1000
          MATCH     SP70,ACLAIM
          GOTO      PHFC1000 IF EQUAL
.
          MOVE      "CL",TCODE
          PACK      KEY5,TCODE,ACLAIM,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      PTCDLDES,VARIABLE
          ENDIF
          GOTO      PHFC7500
.
. ----- Ward code only
.
PHFC7070  BRANCH    FRSTFLAG,PHFC1000
          COMPARE   ONE,ASTAT                * Ward - check for pre-adm
          IF        @EQUAL
            MOVE      PTMIXWRD,VARIABLE      * Use Expected Ward for Pre-Adm.
          ELSE
            MOVE      AWARD,VARIABLE
          ENDIF
          GOTO      PHFC7500
.
. ------- ward only short description -------
.
PHFC7075  BRANCH    FRSTFLAG,PHFC1000
          COMPARE   ONE,ASTAT                * Ward - check for pre-adm
          IF        @EQUAL
            PACK      KEY6,PTMIXWRD,SP6      * Use Expected Ward for Pre-Adm.
          ELSE
            PACK      KEY6,AWARD,SP70
          ENDIF
          CALL      RDWARD1
          BRANCH    OVRCD,PHFC1000
          PACK      VARIABLE,PTWDSDES,SP30,SP30,SP30
          GOTO      PHFC7500
.
. ------- ward/bed short description -------
.
PHFC7080  BRANCH    FRSTFLAG,PHFC1000
          COMPARE   ONE,ASTAT                * Ward - check for pre-adm
          IF        @EQUAL
            PACK      KEY6,PTMIXWRD,SP6      * Use Expected Ward for Pre-Adm.
          ELSE
            PACK      KEY6,AWARD,ABED,SP70
          ENDIF     
          CALL      RDWARD1
          BRANCH    OVRCD,PHFC1000
          PACK      VARIABLE,PTWDSDES,SP30,SP30,SP30
          GOTO      PHFC7500
.
. ----- Preferred Accommodation Code (Cat BP)
.
PHFC7085  BRANCH    FRSTFLAG,PHFC1000
          MOVE      PMVXPACC,VARIABLE
          GOTO      PHFC7500
.
.------ Preferred Accommodation Description (Cat BP)
.
PHFC7090  BRANCH    FRSTFLAG,PHFC1000
          MATCH     SP70,PMVXPACC
          GOTO      PHFC1000 IF EQUAL
.
          MOVE      "BP",TCODE
          PACK      KEY5,TCODE,PMVXPACC,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      PTCDLDES,VARIABLE
          ENDIF
          GOTO      PHFC7500
.
.------ Concession Card Type Code --------
.
PHFC7095  MOVE      ONE,DIM1
          CALL      GCCARD00
          MOVE      PMCDCTYP,VARIABLE
          GOTO      PHFC7500
.
.------ Concession Card Type Description --------
.
PHFC7100  MOVE      ONE,DIM1
          CALL      GCCARD00
          MOVE      SP70,VARIABLE
          MATCH     SP70,PMCDCTYP
          IF        !@EQUAL & !@EOS
            MOVE      "ct",DIM2
            PACK      KEY5,DIM2,PMCDCTYP,SP10
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,VARIABLE
            ENDIF
          ENDIF
          GOTO      PHFC7500
.
.------ Concession Card Number --------
.
PHFC7105  MOVE      ONE,DIM1
          CALL      GCCARD00
          MOVE      PMCDCNUM,VARIABLE
          GOTO      PHFC7500
.
.------ Concession Card Expiry Date --------
.
PHFC7110  MOVE      ONE,DIM1
          CALL      GCCARD00
          UNPACK    PMCDEXDT,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          IF        IBDTPLEN=8
            MOVE      CPDATE,VARIABLE
          ELSE
            MOVE      CPCDATE,VARIABLE
          ENDIF
          GOTO      PHFC7500
.
.------ Safety Net Card Type Code --------
.
PHFC7115  MOVE      TWO,DIM1
          CALL      GCCARD00
          MOVE      PMCDCTYP,VARIABLE
          GOTO      PHFC7500
.
.------ Safety Net Card Type Description --------
.
PHFC7120  MOVE      TWO,DIM1
          CALL      GCCARD00
          MOVE      SP70,VARIABLE
          MATCH     SP70,PMCDCTYP
          IF        !@EQUAL & !@EOS
            MOVE      "ct",DIM2
            PACK      KEY5,DIM2,PMCDCTYP,SP10
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,VARIABLE
            ENDIF
          ENDIF
          GOTO      PHFC7500
.
.------ Safert Net Card Number --------
.
PHFC7125  MOVE      TWO,DIM1
          CALL      GCCARD00
          MOVE      PMCDCNUM,VARIABLE
          GOTO      PHFC7500
.
.------ Safety Net Card Expiry Date --------
.
PHFC7130  MOVE      TWO,DIM1
          CALL      GCCARD00
          UNPACK    PMCDEXDT,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          IF        IBDTPLEN=8
            MOVE      CPDATE,VARIABLE
          ELSE
            MOVE      CPCDATE,VARIABLE
          ENDIF
          GOTO      PHFC7500
.
.------ DVA Card Type Code --------
.
PHFC7135  MOVE      THREE,DIM1
          CALL      GCCARD00
          MOVE      PMCDCTYP,VARIABLE
          GOTO      PHFC7500
.
.------ DVA Card Type Description --------
.
PHFC7140  MOVE      THREE,DIM1
          CALL      GCCARD00
          MOVE      SP70,VARIABLE
          MATCH     SP70,PMCDCTYP
          IF        !@EQUAL & !@EOS
            MOVE      "ct",DIM2
            PACK      KEY5,DIM2,PMCDCTYP,SP10
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,VARIABLE
            ENDIF
          ENDIF
          GOTO      PHFC7500
.
.------ DVA Card Number --------
.
PHFC7145  MOVE      THREE,DIM1
          CALL      GCCARD00
          MOVE      PMCDCNUM,VARIABLE
          GOTO      PHFC7500
.
.------ DVA Card Expiry Date --------
.
PHFC7150  MOVE      THREE,DIM1
          CALL      GCCARD00
          UNPACK    PMCDEXDT,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          IF        IBDTPLEN=8
            MOVE      CPDATE,VARIABLE
          ELSE
            MOVE      CPCDATE,VARIABLE
          ENDIF
          GOTO      PHFC7500
.
.------ Pension Card Type Code --------
.
PHFC7155  MOVE      FOUR,DIM1
          CALL      GCCARD00
          MOVE      PMCDCTYP,VARIABLE
          GOTO      PHFC7500
.
.------ Pension Card Type Description --------
.
PHFC7160  MOVE      FOUR,DIM1
          CALL      GCCARD00
          MOVE      SP70,VARIABLE
          MATCH     SP70,PMCDCTYP
          IF        !@EQUAL & !@EOS
            MOVE      "ct",DIM2
            PACK      KEY5,DIM2,PMCDCTYP,SP10
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,VARIABLE
            ENDIF
          ENDIF
          GOTO      PHFC7500
.
.------ Pension Card Number --------
.
PHFC7165  MOVE      FOUR,DIM1
          CALL      GCCARD00
          MOVE      PMCDCNUM,VARIABLE
          GOTO      PHFC7500
.
.------ Pension Card Expiry Date --------
.
PHFC7170  MOVE      FOUR,DIM1
          CALL      GCCARD00
          UNPACK    PMCDEXDT,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          IF        IBDTPLEN=8
            MOVE      CPDATE,VARIABLE
          ELSE
            MOVE      CPCDATE,VARIABLE
          ENDIF
          GOTO      PHFC7500
.
.------ DVA Card Colour --------
.
PHFC7175  MOVE      THREE,DIM1
          CALL      GCCARD00
          MOVE      SP70,VARIABLE
          MATCH     SP70,PMCDDVAC
          IF        !@EQUAL & !@EOS
            MOVE      "DX",DIM2
            PACK      KEY5,DIM2,PMCDDVAC,SP10
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,VARIABLE
            ENDIF
          ENDIF
          GOTO      PHFC7500
.
.-------- Medicare Number -------------
.
PHFC7180  PACK      VARIABLE,SP70,SP70
          MOVE      PMEDI,VARIABLE
          GOTO      PHFC7500
.
.-------- Medicare Reference Number -------------
.
PHFC7185  PACK      VARIABLE,SP70,SP70
          MOVE      PTMXMCCD,VARIABLE
          GOTO      PHFC7500
.
.-------- Medicare Expiry Date  --------
.
PHFC7190  PACK      VARIABLE,SP70,SP70
          UNPACK    PMPXMEDC,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          IF        IBDTPLEN=8
            MOVE      CPDATE,VARIABLE
          ELSE
            MOVE      CPCDATE,VARIABLE
          ENDIF
          GOTO      PHFC7500
.
.-------- Health Fund Contributor Name -------------
.
PHFC7195  BRANCH    FRSTFLAG,PHFC1000
          PACK      VARIABLE,SP70,SP70
          MOVE      PMVXCONM,VARIABLE
          GOTO      PHFC7500
.
. ------- Admission Time -------
.
PHFC7200  BRANCH    FRSTFLAG,PHFC1000
.
          MOVE      ATIME,KEY5
          MOVE      KEY5,VARIABLE
          GOTO      PHFC7500
.
. ------- Alternate Election code -------
.
PHFC7205  BRANCH    FRSTFLAG,PHFC1000
          MOVE      PMEXALEL,VARIABLE
          GOTO      PHFC7500
.
. ------- Alternate Election description -------
.
PHFC7210  BRANCH    FRSTFLAG,PHFC1000
          MATCH     SP70,PMEXALEL
          GOTO      PHFC1000 IF EQUAL
.
          MOVE      "CL",TCODE
          PACK      KEY5,TCODE,PMEXALEL,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      PTCDLDES,VARIABLE
          ENDIF
          GOTO      PHFC7500
.
PHFC7215  PACK      KEY8,DAADMNO,SP70                * Hospital Posting Account
          CALL      RDPMVX11
          PACK      KEY3,PMVXMHOS,SP70
          CALL      RDPTHSP1
          IF        OVRCD=1
            PACK      VARIABLE,SP70
          ELSE
            MOVE      PTHSPACT,VARIABLE            
          ENDIF
          GOTO      PHFC7500
.
PHFC7220  PACK      KEY8,DAADMNO,SP70                * Organisation ID
          CALL      RDPMVX11
          PACK      KEY3,PMVXMHOS,SP70
          CALL      RDPTHSP1
          IF        OVRCD=1
            PACK      VARIABLE,SP70
          ELSE
            MOVE      PTHSORID,VARIABLE 
          ENDIF
          GOTO      PHFC7500
.
PHFC7225  PACK      KEY6,ADOCTA,SP70                 * Current Attending Doctor
          CALL      RDDOCT1
          IF        OVRCD=1
            PACK      VARIABLE,SP70
          ELSE
            MOVE      DSNAME,PACSNAME
            MOVE      DGNAME,PACGNAME
            MOVE      DTITL,PACTITLE
            MOVE      TWO,PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,VARIABLE
          ENDIF
          GOTO      PHFC7500
.
PHFC7230  PACK      KEY6,ADOCTA,SP70                 * Current AD Phone Number
          CALL      RDDOCT1
          IF        OVRCD=1
            PACK      VARIABLE,SP70
          ELSE
            MOVE      DTELES,VARIABLE
          ENDIF
          GOTO      PHFC7500
.
PHFC7235  PACK      KEY6,ADOCTA,SP70                 * Current AD Title
          CALL      RDDOCT1
          IF        OVRCD=1
            PACK      VARIABLE,SP70
          ELSE
            MOVE      DTITL,VARIABLE
          ENDIF
          GOTO      PHFC7500
.
PHFC7240  PACK      KEY6,ADOCTA,SP70                 * Current AD First Name
          CALL      RDDOCT1
          IF        OVRCD=1
            PACK      VARIABLE,SP70
          ELSE
            MOVE      DGNAME,VARIABLE
          ENDIF
          GOTO      PHFC7500
.
PHFC7245  PACK      KEY6,ADOCTA,SP70                 * Current AD Surname
          CALL      RDDOCT1
          IF        OVRCD=1
            PACK      VARIABLE,SP70
          ELSE
            MOVE      DSNAME,VARIABLE
          ENDIF
          GOTO      PHFC7500
.
PHFC7250  PACK      KEY6,ADOCTA,SP70                 * Current AD Address 1
          CALL      RDDOCT1
          IF        OVRCD=1
            PACK      VARIABLE,SP70
          ELSE
            MOVE      DSADD1,VARIABLE
          ENDIF
          GOTO      PHFC7500
.
PHFC7255  PACK      KEY6,ADOCTA,SP70                 * Current AD Address 2
          CALL      RDDOCT1
          IF        OVRCD=1
            PACK      VARIABLE,SP70
          ELSE
            MOVE      DSADD2,VARIABLE
          ENDIF
          GOTO      PHFC7500
.
PHFC7260  PACK      KEY6,ADOCTA,SP70                 * Current AD Address 3
          CALL      RDDOCT1
          IF        OVRCD=1
            PACK      VARIABLE,SP70
          ELSE
            MOVE      DSADD3,VARIABLE
          ENDIF
          GOTO      PHFC7500
.
PHFC7265  PACK      KEY6,ADOCTA,SP70                 * Current AD Address 4
          CALL      RDDOCT1
          IF        OVRCD=1
            PACK      VARIABLE,SP70
          ELSE
            MOVE      DSADD4,VARIABLE
          ENDIF
          GOTO      PHFC7500
.
PHFC7270  PACK      KEY6,ADOCTA,SP70                 * Current AD Postcode
          CALL      RDDOCT1
          IF        OVRCD=1
            PACK      VARIABLE,SP70
          ELSE
            MOVE      DSPOST,VARIABLE                  
          ENDIF
          GOTO      PHFC7500
.
PHFC7280  PACK      VARIABLE,SP70
          MATCH     "1",PTCNUNET
          IF        @EQUAL
            CALL      GTIHINUM
            MOVE      IHINUMBR,VARIABLE       * IHI Number
          ELSE
            MATCH     "3",PTCNUNET
            IF        @EQUAL
              CALL      GTIHINUM                   * IHI Number
              LJUSTIFY  IHINUMBR
              UNPACK    IHINUMBR,DIM4,DIM4A,DIM4B,DIM4C
              PACK      VARIABLE,DIM4,SP1,DIM4A,SP1,DIM4B,SP1,DIM4C
            ENDIF
          ENDIF
          GOTO      PHFC7500
.
. ----- P.R.A. Mobile Number -----
.
PHFC7290  
.         BRANCH    FRSTFLAG,PHFC1000
          PACK      KEY8,AADMNO
          CALL      RDRESP1                 * Position on the P.R.A. file
          IF        OVRCD=1
            GOTO      PHFC7500
          ENDIF
          MOVE      PTREMOBL,VARIABLE
          GOTO      PHFC7500
.
. ----- Insurance Company Name -----
.
PHFC7300  BRANCH    FRSTFLAG,PHFC1000
          PACK      KEY8,AURNO      
          CALL      RDPMRES1                * Patient Residency Details file
          BRANCH    OVRCD,PHFC7500
.      
          PACK      KEY6,PMRSINCD
          CALL      RDINSR1
          BRANCH    OVRCD,PHFC7500
.
          MOVE      INAME,VARIABLE
          GOTO      PHFC7500
.
. ----- Insurance Policy Number / Insurance Fund Membership Number -----
.
PHFC7310  BRANCH    FRSTFLAG,PHFC1000
          PACK      KEY8,AURNO
          CALL      RDPMRES1               * Patient Residency Details file
          BRANCH    OVRCD,PHFC7500
.
          PACK      KEY5,ANST,SP1,PTYPE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,PHFC7500
.
          MATCH     ANSS,TCINDC3           * Overseas Student
          IF        @EQUAL
            MOVE      PMRSINFM,VARIABLE    * Insurance Fund Membership Number
            GOTO      PHFC7500
          ENDIF
.
          MATCH     ANSO,TCINDC3           * Overseas Visitor
          IF        @EQUAL
            MOVE      PMRSIPOL,VARIABLE    * Insurance Policy Number
            GOTO      PHFC7500
          ENDIF
.
          GOTO      PHFC7500
.
. ----- P.R.A. address line 4 -----
.
PHFC7315  
.         BRANCH    FRSTFLAG,PHFC1000
          PACK      KEY8,AADMNO
          CALL      RDRESP1                 * Position on the P.R.A. file
          IF        OVRCD=1
            GOTO      PHFC7500
          ENDIF
          MOVE      PKADD4,VARIABLE
          GOTO      PHFC7500
.
.
.
PHFC7320  PACK      VARIABLE,PMPXPFSN,SP70   * Preferred Surname
          GOTO      PHFC7500
.
PHFC7325  PACK      VARIABLE,PMPXPFGN,SP70   * Preferred Given Name
          GOTO      PHFC7500
.
PHFC7330  PACK      VARIABLE,PSNAME,SP70     * Pref Surname instead of Actual SN
          MATCH     "1",PTCNPFSN
          IF        @EQUAL
            MATCH     SP70,PMPXPFSN
            IF        !@EQUAL & !@EOS
              PACK      VARIABLE,PMPXPFSN,SP70,SP10
            ENDIF
          ENDIF
          GOTO      PHFC7500
.
PHFC7335  PACK      VARIABLE,PGNAME,SP70     * Pref GN instead of Actual GN
          MATCH     "1",PTCNPFGN
          IF        @EQUAL
            MATCH     SP70,PMPXPFGN
            IF        !@EQUAL & !@EOS
              PACK      VARIABLE,PMPXPFGN,SP70,SP10
            ENDIF
          ENDIF
          GOTO      PHFC7500
.
PHFC7340  PACK      VARIABLE,PTMASNAM,SP70   * Pref Surname instead of 40char SN
          MATCH     "1",PTCNPFSN
          IF        @EQUAL
            MATCH     SP70,PMPXPFSN
            IF        !@EQUAL & !@EOS
              PACK      VARIABLE,PMPXPFSN,SP70,SP10
            ENDIF
          ENDIF
          GOTO      PHFC7500
.
. ----- Format the variable -----
.
PHFC7500  RESET     VARIABLE,IBDTPLEN
          LENSET    VARIABLE
          RESET     VARIABLE
          PRINT     *IBDTCOL,*+,VARIABLE;
          GOTO      PHFC1000                * Read next record
.
. ----- Formatting for form fields and right justified variables -----
.
PHFC8000  COMPARE   ZERO,PRNTSTRT           * Don't bump if printing full length
          GOTO      PHFC8500 IF EQUAL
.
          BUMP      VARIABLE,PRNTSTRT       * Bump to starting position
          RESET     VARIABLE,IBDTPLEN
          LENSET    VARIABLE
          RESET     VARIABLE
.
. ----- Print the variable -----
.
PHFC8500  PRINT     *IBDTCOL,*+,VARIABLE;
          GOTO      PHFC1000                * Read next record
.
. ----- End of HFCF, Print new lines until the end of page is reached -----
.
PHFC9000  COMPARE   CURRROW,IBTHLENG        * Test page length
          GOTO      PHFC9500 IF LESS
.
          PRINT     *N;
          ADD       ONE,CURRROW
          GOTO      PHFC9000
.
.         If there are still more tran, mbs or other services records to print,
.         loop through template file again.
.
PHFC9500  CALL      CKFNP000                * Check for a new page
          BRANCH    EXIT,PHFC9999
.
          MOVE      ONE,FRSTFLAG            * set flag for subsequent loop
          ADD       ONE,CPAGENO             * increment page count
          PACK      KEY12,STATNCOD,SP10
          CALL      RSIBDET1                * position in template file
          CALL      RKIBDET1                * position in template file
          GOTO      PHFC0200                * start second loop
.
PHFC9999  CALL      CLSPRINT                * Close the spool file
          GOTO      ENDPHFCF                * Finished
+
.******************************************************************************
.         Check if Contract id has changed or expired
.******************************************************************************
CHCN0000  MOVE     TDATE,STRTDAT8
          CALL     CNTR0000                     * get contract id
          MATCH    SP70,PTDTCNID
          IF       !@EQUAL
            MATCH    PTDTCNID,SAVCONTR
            IF       !@EQUAL
              MOVE     "C",TMOVE
              PACK     TDATE,DTFCENT,DTFYEAR,DTFMONTH,DTFDAY
              REP      " 0",TDATE
              MOVE     TDATE,SAVDATE
              MOVE     ONE,CHGCONTR
            ELSE
              MOVE     ZERO,CHGCONTR
            ENDIF
          ENDIF
CHCN9999  RETURN
+
.******************************************************************************
.*        Check for Credit note amount                                        *
.******************************************************************************
CRNT0000  MATCH     "1",PTDTCRST
          GOTO      CRNT9000 IF EQUAL        * Fully credited
.
          MATCH     "2",PTDTCRST
          GOTO      CRNT8000 IF NOT EQUAL    * Credit by item
.
          OPEN      PMSFCIA1,"pmsfciaf"
          MOVE      ZERO,FORM12P2
          PACK      KEY30,KEY22,SP70
          CALL      RSPMFCI1
CRNT2000  CALL      RKPMFCI1
          BRANCH    OVRCD,CRNT4000
.
          PACK      DIM22,PMFCVISN,PMFCINVN,PMFCTRAN,SP70
          MATCH     DIM22,KEY22
          GOTO      CRNT4000 IF NOT EQUAL
.
          ADD       PMFCCAMT,FORM12P2
          GOTO      CRNT2000
.
CRNT4000  MULT      "-1",FORM12P2
          COMPARE   TPATAMTT,FORM12P2
          GOTO      CRNT9000 IF EQUAL         * Items had been credited
          MOVE      TWO,EXIT
          GOTO      CRNT9999
.
CRNT8000  MOVE      ZERO,EXIT
          GOTO      CRNT9999
.
CRNT9000  MOVE      ONE,EXIT
CRNT9999  RETURN
+
.******************************************************************************
.*                                  CKFNP000              Called by: PHFC9500 *
.*                            Check For A New Page                            *
.******************************************************************************
CKFNP000  MOVE      ZERO,EXIT
.
          IF (TRANFLAG=5 & DSCHFLAG=0) | MMBSFLAG=5 | SERVFLAG=5 | THETIMES=4
.
. ----- Check the transfer record -----
.
            IF        TRANFLAG=5
              MOVE      SAVKEY30,KEY30
              CALL      RDTRAN2
.
              CALL      GTTRN000            * Get next transfer record
              IF        EXIT<>0
                MOVE      SIX,TRANFLAG
              ELSE
                MOVE      ZERO,TRANFLAG
              ENDIF
.
              MOVE      SAVKEY30,KEY30
              CALL      RDTRAN2
            ELSE
              MOVE      SIX,TRANFLAG
            ENDIF
.
. ----- Check the MBS item -----
.
            IF        MMBSFLAG=5
              MOVE      MBSKEY22,KEY22      * reposition on DTR        *I-90301
              CALL      RDDTRN1
.
              CALL      GTAMT000
              IF        EXIT=1
                MOVE      SIX,MMBSFLAG
              ELSE
                MOVE      ZERO,MMBSFLAG
              ENDIF
               MOVE      MBSKEY22,KEY22
               CALL      RDDTRN1
            ELSE
              MOVE      SIX,MMBSFLAG
            ENDIF
.
. ----- Check the service record -----
.
            IF        SERVFLAG=5
              MOVE      SAVKEY22,KEY22      * reposition on DTR
              CALL      RDDTRN1
.
              CALL      GTSER000            * Get next service record
              IF        EXIT=1
                MOVE      SIX,SERVFLAG
              ELSE
                MOVE      ZERO,SERVFLAG
              ENDIF
.
              MOVE      SAVKEY22,KEY22
              CALL      RDDTRN1
            ELSE
              MOVE      SIX,SERVFLAG
            ENDIF
.
. ----- Check the Theatre Times -----                                  *C-V-015
.
            IF        THETIMES=4
              MOVE      SAVTHT11,KEY11
              CALL      RDMMBS1
              IF        OVRCD=0
                MOVE      MMSTIM,PREVSTTM
              ENDIF
.
              CALL      GTTHE000
              IF        EXIT=1
                MOVE      SIX,THETIMES
              ELSE
                MOVE      ZERO,THETIMES
              ENDIF
.
              MOVE      SAVTHT11,KEY11
              CALL      RDMMBS1
              IF        OVRCD=0
                MOVE      MMSTIM,PREVSTTM
              ENDIF
            ELSE
              MOVE      SIX,THETIMES
            ENDIF
.
            MOVE      ONE,EXIT
            IF        TRANFLAG=0 | MMBSFLAG=0 | SERVFLAG=0 | THETIMES=0
              MOVE      ZERO,EXIT
            ENDIF
          ELSE
            MOVE      ONE,EXIT
          ENDIF
.
.******************************************** start of addition        *I-62428
          COMPARE   BBYNO,CPAGENO
          IF        @LESS
            MOVE      ZERO,EXIT             * still Baby info to print
          ENDIF
.********************************************   end of addition        *I-62428
.
.
          IF        DIAGFLAG>0
            MOVE      ZERO,EXIT             * more Diagnosis code to print
          ENDIF
.
          IF        PROCFLAG>0
            MOVE      ZERO,EXIT             * more Procedure code to print
          ENDIF
.
CKFNP999  RETURN
+
.******************************************************************************
.*                                 DOCTAD00                                   *
.*             Read the doctors file to get the admission record              *
.******************************************************************************
DOCTAD00  COMPARE   ONE,ASTAT
          GOTO      DOCTAD10 IF EQUAL       * Only pre-admitted
.
          MOVE      AADMNO,TADMN
          PACK      KEY30,TADMN,SP30
          CALL      RDSTRAN2                * Position on & read the transfer
          CALL      RDKTRAN2                  file to get the attending doctor
          BRANCH    OVRCD,DOCTAD10
.
          PACK      KEY6,TADOCT             * Use transfer attending doctor
          MATCH     ANSA,TMOVE              * Looking for admission record
          GOTO      DOCTAD20 IF EQUAL       * Admission record found
.
DOCTAD10  PACK      KEY6,ADOCTA             * Use admission attending doctor
DOCTAD20  MATCH     SP6,KEY6
          GOTO      DOCTAD95 IF EQUAL       * Invalid attending doctor
.
          CALL      RDDOCT1                 * Read the doctors file
          BRANCH    OVRCD,DOCTAD95
.
DOCTAD90  MOVE      ZERO,EXIT               * Valid attending doctor
          GOTO      DOCTAD98
.
DOCTAD95  MOVE      ONE,EXIT                * Invalid attending doctor
.
DOCTAD98  MOVE      SAVKEY30,KEY30
          CALL      RDTRAN2
DOCTAD99  RETURN
+
.******************************************************************************
.*                                 DOCTDS00                                   *
.*             Read the doctors file to get the discharge record              *
.******************************************************************************
DOCTDS00  IF        ASTAT<>3
            MOVE      ONE,OVRCD             * Patient not discharged, exit
            GOTO      DOCTDS99
          ENDIF
.
          MOVE      DADMNO,TADMN
          PACK      KEY30,TADMN,SP30
          CALL      RDSTRAN2                * Position on the transfer file to
.                                             get the attending doctor at disch
DOCTDS10  CALL      RDKTRAN2                * Read the transfer file until
.                                             TMOVE=D (discharge record)
          IF        OVRCD=1
            GOTO      DOCTDS99
          ENDIF
.
          MATCH     ANSD,TMOVE              * Looking for discharge record
          GOTO      DOCTDS10 IF NOT EQUAL   * Not discharge record, read next
.
          PACK      KEY6,TADOCT
          CALL      RDDOCT1                 * Read the doctors file to get
.                                             doctors name
DOCTDS99  RETURN
+
.******************************************************************************
.*                                 RDDTR000                                   *
.*                             Read the DTR file                              *
.******************************************************************************
.
RDDTR000  MOVE      ZERO,FORM82
          MOVE      AADMNO,TADMNO
          PACK      KEY22,TADMNO,SP20
          CALL      RDSDTRN1                * Position on the DTR file
RDDTR100  CALL      RDKDTRN1                * Read the DTR file
          BRANCH    OVRCD,RDDTR999
.
          MATCH     AADMNO,TADMNO
          GOTO      RDDTR999 IF NOT EQUAL   * Different admission
.
          COMPARE   ZERO,TINVPRT
          GOTO      RDDTR100 IF EQUAL       * Not invoiced
.
          COMPARE   TRECTYPE,FORM1
          GOTO      RDDTR100 IF NOT EQUAL   * Different record type
.
          IF        INVFLAG > 0
            MATCH     TREF,HFCFINVN
            GOTO      RDDTR100 IF NOT EQUAL      * must be on last invoice
          ENDIF
.
          PACK      KEY22,TADMNO,TREF,TTRANSN1,SP70
          CALL      CRNT0000
          BRANCH    EXIT,RDDTR100           * Credit note
          IF        EXIT=2
            SUB       FORM12P2,TPATAMTT
          ENDIF
.
          ADD       TPATAMTT,FORM82         * Add total amount
          GOTO      RDDTR100
.
RDDTR999  RETURN
+
.******************************************************************************
.*                                 GETCLM00                                   *
.*                              Get claim code                                *
.******************************************************************************
.
GETCLM00  UNPACK    SP5,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
          MOVE      "CL",TCODE
          PACK      KEY5,TCODE,ACLAIM
          CALL      RDCODE1                 * Read the patient codes file
          MOVE      ZERO,FORM2
.
. ----- See what type of claim we have if any exists -----
.
GETCLM10  ADD       ONE,FORM2
          COMPARE   SIX,FORM2
          GOTO      GETCLM99 IF NOT LESS
.
          LOAD      ANS,FORM2,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
.
          MATCH     KEY1,ANS
          IF        !@EQUAL
            GOTO      GETCLM10
          ELSE
            MOVE      ANSX,VARIABLE
          ENDIF
GETCLM99  RETURN
+
.******************************************************************************
.*                                 RDMDI000                                   *
.*                   Read the Medical Records Disease file                    *
.******************************************************************************
RDMDI000  COMPARE   ZERO,FRSTFLAG
          GOTO      RDMDI700 IF EQUAL
.
          MOVE      CPAGENO,F3
          SUB       ONE,F3
          MULT      "15",F3
          ADD       FORM3,F3
          MOVE      F3,FORM3
.
RDMDI700  PACK      KEY16,AADMNO,SP70
          CALL      RSPTECD2                * Position on & read a patient
RDMDI800  CALL      RKPTECD2                  episode disease file record
          BRANCH    OVRCD,RDMDI950
.
          MATCH     AADMNO,PTEDADMN
          GOTO      RDMDI950 IF NOT EQUAL   * Different admin no
.
          IF        PTEDUNQN=ZERO
            COMPARE   FORM3,PTEDCNT
            GOTO      RDMDI800 IF NOT EQUAL
          ELSE
            COMPARE   FORM3,PTEDUNQN
            GOTO      RDMDI800 IF NOT EQUAL   * Different unique no
          ENDIF
.
          MATCH     SP9,PTEDCODE
          GOTO      RDMDI950 IF EQUAL       * Blank code
.
RDMDI900  MOVE      ZERO,EXIT
          CALL      RKMDI0000
          GOTO      RDMDI999
.
RDMDI950  MOVE      ONE,EXIT
          MOVE      ZERO,DIAGFLAG
RDMDI999  RETURN
+
.******************************************************************************
.         Check next Diagnosis record
.******************************************************************************
RKMDI000  PACK      KEY16,DPTEDADM,DPTEDUNQ,DPTEDEPN,DPTEDCNT,SP70
.
          CALL      RKPTECD2                  episode disease file record
          BRANCH    OVRCD,RKMDI800
.
          MATCH     AADMNO,PTEDADMN
          GOTO      RKMDI800 IF NOT EQUAL   * Different admin no
.
          MOVE      ONE,DIAGFLAG
          GOTO      RKMDI900
.
RKMDI800  MOVE      ZERO,DIAGFLAG
.
RKMDI900  CALL      RDPTECD2                  * Restore
RKMDI999  RETURN
+
.******************************************************************************
.*                                 RDMOP000                                   *
.*                 Read the Medical Records Operation file                    *
.******************************************************************************
RDMOP000  COMPARE   ZERO,FRSTFLAG
          GOTO      RDMOP700 IF EQUAL
.
          MOVE      CPAGENO,F3
          SUB       ONE,F3
          MULT      "15",F3
          ADD       FORM3,F3
          MOVE      F3,FORM3
.
RDMOP700  PACK      KEY16,AADMNO,SP70
          CALL      RSPTECO2                * Position on & read a patient
RDMOP800  CALL      RKPTECO2                  episode operation file record
          BRANCH    OVRCD,RDMOP950
.
          MATCH     AADMNO,PTEOADMN
          GOTO      RDMOP950 IF NOT EQUAL   * Different admin no
.
          IF        PTEOUNQN=ZERO
            COMPARE   FORM3,PTEOCNT
            GOTO      RDMOP800 IF NOT EQUAL  
          ELSE
            COMPARE   FORM3,PTEOUNQN
            GOTO      RDMOP800 IF NOT EQUAL   * Different unique no
          ENDIF
.
          MATCH     SP9,PTEOCODE
          GOTO      RDMOP950 IF EQUAL       * Blank code
.
.                                           * add code to select "O" Oper Type
          REP       "O0I1N1X1",PTEOTYPE                                *I-45023
          MOVE      PTEOTYPE,FORM1                                     *I-45023
          BRANCH    FORM1,RDMOP950          * reject I, N or X         *I-45023
.
RDMOP900  MOVE      ZERO,EXIT
          CALL      RKMOP000
          GOTO      RDMOP999
.
RDMOP950  MOVE      ONE,EXIT
          MOVE      ZERO,PROCFLAG
RDMOP999  RETURN
+
.******************************************************************************
.         Check next Procedure record
.******************************************************************************
RKMOP000  PACK      KEY16,DPTEOADM,DPTEOUNQ,DPTEOEPN,DPTEOCNT,SP70
.
          CALL      RKPTECO2                  episode operation file record
          BRANCH    OVRCD,RKMOP800
.
          MATCH     AADMNO,PTEOADMN
          GOTO      RKMOP800 IF NOT EQUAL   * Different admin no
.
          MOVE      ONE,PROCFLAG
          GOTO      RKMOP900
.
RKMOP800  MOVE      ZERO,PROCFLAG
.
RKMOP900  CALL      RDPTECO2                * Restore
RKMOP999  RETURN
+
.****************************************************************************
.*                            CKINV000                                      *
.*              Check if MBS item is on last invoice.                       *
.****************************************************************************
CKINV000  PACK      KEY22,AADMNO,HFCFINVN,SP30   * last invoice for this adm
          CALL      RDSDTRN1
CKINV100  CALL      RDKDTRN1                     * read through dtr file
          BRANCH    OVRCD,CKINV950
.
          MATCH     AADMNO,TADMNO                * same adm?
          GOTO      CKINV950 IF NOT EQUAL
.
          MATCH     HFCFINVN,TREF                * same invoice?
          GOTO      CKINV950 IF NOT EQUAL
.
          PACK      KEY22,TADMNO,TREF,TTRANSN1,SP70
          CALL      CRNT0000
          BRANCH    EXIT,CKINV100                * Credit note
.
          MATCH     MMCODE,TITEMNO               * check for item
          GOTO      CKINV900 IF EQUAL
.
          GOTO      CKINV100                     * get next record
.
CKINV900  MOVE      ZERO,MBINVFLG                * item is on invoice
          GOTO      CKINV999
.
CKINV950  MOVE      ONE,MBINVFLG                 * item is not on invoice
CKINV999  RETURN
+
.****************************************************************************
.*                            CUICF000                                      *
.*                Check if using interim claim forms.                       *
.****************************************************************************
CUICF000  COMPARE   ONE,PTCNUICF                 * using interim forms? (1=Yes)
          GOTO      CUICF999 IF NOT EQUAL
.
          MOVE      ZERO,INVFLAG
.
          PACK      KEY16,AADMNO,ZED30
          CALL      RDSINV3
CUICF010  CALL      RDPINV3                      * read last invoice
          BRANCH    OVRCD,CUICF999
.
          MATCH     AADMNO,PINVADM               * check same adm.
          GOTO      CUICF999 IF NOT EQUAL        * only 1 invoice
.
.******************************************** start of addition        *I-65745
          MATCH     SP8,PINVCANC                 * is Invoice cancelled?
          GOTO      CUICF010 IF NOT EQUAL        * then bypass
          COMPARE   TWO,PINVTYP                  * "Patient Portion" Invoice?
          GOTO      CUICF010 IF EQUAL            * then bypass
.********************************************   end of addition        *I-65745
.
          MOVE      PINVNO,HFCFINVN              * save last invoice number
          MOVE      PINVDTE,HFCTDTE              * save Inv. to-date   *I-65745
          MOVE      ADATE,HFCFDTE                * default FromDate to AdmnDate
.
CUICF020  CALL      RDPINV3                      * read second last invoice
          BRANCH    OVRCD,CUICF999               * no more invoices
.
.******************************************** start of addition        *I-65745
          MATCH     SP8,PINVCANC                 * is Invoice cancelled?
          GOTO      CUICF020 IF NOT EQUAL        * then bypass
          COMPARE   TWO,PINVTYP                  * "Patient Portion" Invoice?
          GOTO      CUICF020 IF EQUAL            * then bypass
.********************************************   end of addition        *I-65745
.
          MATCH     AADMNO,PINVADM               * check same adm.
          GOTO      CUICF999 IF NOT EQUAL        * only 1 invoice
.
          MOVE      PINVDTE,HFCFDTE              * save 2nd last invoice date
  	  MATCH     "IBARSH",PGM
          GOTO      CUICF900 IF EQUAL
.
. ---- Only allow interim claims if more than 1 invoice ----
.
          UNPACK    HFCFDTE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
.******************************************** start of changes         *I-65745
          MOVE      CPCDATE,DIM10
          UNPACK    HFCTDTE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
.
          DISPLAY   *P1:23,*EL,*B,*V2LON,"Patient last invoiced from ",DIM10:
                    " to ",CPCDATE,"  (Invoice No. ",HFCFINVN,")";
.
CUICF500  KEYIN     *P1:24,*EL,"Print claim from ":
                          "last (",*V2LON,"D",*HOFF,")ate, ":
                          "from (",*V2LON,"A",*HOFF,")dmission date, ":
                          "or for (",*V2LON,"I",*HOFF,")nvoice dates ? ",ANS
.********************************************   end of changes         *I-65745
.
          REP       UPPLOW,ANS
          MATCH     "A",ANS
          GOTO      CUICF900 IF EQUAL
.
          MATCH     "D",ANS
          GOTO      CUICF950 IF EQUAL
.
          MATCH     "I",ANS
          GOTO      CUICF970 IF EQUAL
.
          BEEP
          GOTO      CUICF500
.
CUICF900  MOVE      ZERO,INVFLAG            * claim from admission date
          MOVE      ADATE,HFCFDTE                                      *I-65745
          PACK      HFCTDTE,CCC,CYY,CMM,CDD                            *I-65745
          REP       " 0",HFCTDTE                                       *I-65745
          GOTO      CUICF999
.
CUICF950  MOVE      ONE,INVFLAG             * claim from last inv. start date
          MOVE      HFCTDTE,HFCFDTE                                    *I-65745
          PACK      HFCTDTE,CCC,CYY,CMM,CDD                            *I-65745
          REP       " 0",HFCTDTE                                       *I-65745
          GOTO      CUICF999
.
CUICF970  MOVE      ONE,INVFLAG             * claim for last inv.dates *I-65745
.
CUICF999  RETURN
+
.****************************************************************************
.*                            CKTRN000                 Called by:           *
.*             Check if we have a transfer record field.                    *
.****************************************************************************
.
CKTRN000  MOVE      ZERO,COUNTR                  * initialise counter
          WHILE     COUNTR < 8
            ADD       ONE,COUNTR                 * increment counter
.
            BRANCH    TRANFLAG,CKTRN100:         * processing first row
                               CKTRN200:         * processing second row
                               CKTRN300:         * processing third row
                               CKTRN600          * processing fourth row
.
            LOAD      FLDNUM,COUNTR,ONE42,ONE43,ONE44,ONE45,ONE46,ONE47,ONE48
            GOTO      CKTRN500
.
CKTRN100    LOAD      FLDNUM,COUNTR,ONE49,ONE50,ONE51,ONE52,ONE53,ONE54,ONE55
            GOTO      CKTRN500
.
CKTRN200    LOAD      FLDNUM,COUNTR,ONE56,ONE57,ONE58,ONE59,ONE60,ONE61,ONE62
            GOTO      CKTRN500
.
CKTRN300    LOAD      FLDNUM,COUNTR,ONE63,ONE64,ONE65,ONE66,ONE67,ONE68,ONE69
.
CKTRN500    COMPARE   FLDNUM,FORM5               * transfer record field ?
            IF        @EQUAL 
              IF        TRANFLAG = 0 & FRSTFLAG = 0
                PACK      KEY30,AADMNO,SP30
                CALL      RDSTRAN2               * position in file
                IF        INVFLAG > 0
                  PACK      KEY30,AADMNO,HFCFDTE,ZED10,SP30
                  CALL      RDSTRAN2             * read past Inv.Date
                  CALL      RDPTRAN2             * backup to Inv.Date
                  CALL      RDPTRAN2             * retrieve Tran before Inv.Date
                ENDIF
                MOVE        HFCFDTE,STRTDAT8
                CALL        CNTR0000             * get contract id
                MOVE        PTDTCNID,SAVCONTR
                MOVE        ZERO,SKIPFLAG
.
              ELSE
                MOVE      SAVKEY30,KEY30
                CALL      RDTRAN2
.
                MOVE      CHGCONTR,SKIPFLAG
                IF        CHGCONTR=1
                  MOVE      ZERO,CHGCONTR
                  ADD       ONE,TRANFLAG         * set for next transfer row
                  GOTO      CKTRN9999
                ENDIF
              ENDIF
.
              MOVE      ZERO,CHGCONTR
              ADD       ONE,TRANFLAG             * set for next transfer row
.
CKTRN600      IF        SKIPFLAG=1
                MOVE      SAVDATE,TDATE
                IF        TRANFLAG = 4
                  MOVE      FIVE,TRANFLAG
                ENDIF
                GOTO      CKTRN999
              ENDIF
.
              CALL      GTTRN000                 * read the next transfer rec.
.
              BRANCH    EXIT,CKTRN950:           * eof
                             CKTRN950:           * no more transfer records
                             CKTRN950:           * discharge - overnight
                             CKTRN800:           * discharge - daycase
                             CKTRN950            * after last inv. date
.
              CALL      VALTR000                 * valid transfer record ?
              BRANCH    EXIT,CKTRN600            * no - get next tran record
.
              IF        TRANFLAG = 4
                MOVE      FIVE,TRANFLAG
              ENDIF
.
.             Save the current key as another routine may reposition in the 
.             tran file and we need to keep track of where we are for items 
.             142 to 169
.
              PACK      SAVKEY30,TADMN,TDATE,TTIME,TWARD,TBED
              GOTO      CKTRN999                 * valid transfer record found
            ENDIF
          DO
          GOTO      CKTRN999
.
CKTRN800  CALL      CPRAR000                * Check if prev rec was admin rec
          BRANCH    EXIT,CKTRN999
.
CKTRN950  MOVE      SIX,TRANFLAG                 * set flag to finished
CKTRN999  RETURN
+
.****************************************************************************
.         Get Contract id
.****************************************************************************
CNTR0000  PACK      KEY22,AADMNO,SP70
          CALL      RDSDTRN1
CNTR1000  CALL      RDKDTRN1
          BRANCH    OVRCD,CNTR9000
.
          MATCH     AADMNO,TADMNO
          GOTO      CNTR9000 IF NOT EQUAL
.
          COMPARE   ONE,TRECTYPE
          GOTO      CNTR1000 IF NOT EQUAL  * Not accommodation record
.
          MATCH     "1",PTDTCRST
          GOTO      CNTR1000 IF EQUAL      * Credit note
.
          PACK      KEY8,DTFCENT,DTFYEAR,DTFMONTH,DTFDAY
          REP       " 0",KEY8
          MATCH     KEY8,STRTDAT8
          GOTO      CNTR1000 IF LESS
.
          PACK      KEY8,TTCENT,TTYEAR,TTMONTH,TTDAY
          REP       " 0",KEY8
          MATCH     STRTDAT8,KEY8
          GOTO      CNTR1000 IF LESS
.
          GOTO      CNTR9999
.
CNTR9000  MOVE      SP70,PTDTCNID
CNTR9999  RETURN
+
.****************************************************************************
.*                             GTTRN000                Called by:           *
.*            get the next valid TRAN record for printing                   *
.* Returns:  EXIT 0 = valid tran record read                                *
.*                1 = EOF reached                                           *
.*                2 = invalid tran record                                   *
.*                3 = discharge record found - overnight                    *
.*                4 = discharge record found - daycase                      *
.
.*                5 = after last invoice date                               *
.****************************************************************************
GTTRN000  CALL      RDKTRAN2                     * read next record
          BRANCH    OVRCD,GTTRN910               * eof - finished
.
          MATCH     TADMN,AADMNO                 * same admission number still ?
          GOTO      GTTRN920 IF NOT EQUAL        * no - finished
.
          MOVE      TDATE,SAVDAT1            * save current transfer date
          PACK      KEY30,TADMN,TDATE,ZED10,ZED10
          CALL      RDSTRAN2                * Position on & read a transfer
          CALL      RDPTRAN2                  file record
          BRANCH    OVRCD,GTTRN910
.
          MATCH     TADMN,AADMNO
          GOTO      GTTRN920 IF NOT EQUAL   * Different admin no
.
          MATCH     TDATE,SAVDAT1
          GOTO      GTTRN920 IF NOT EQUAL   * Different transfer date
.
...       MATCH     TDATE,ALACDTE                * last inv. date < transfer dte
...       GOTO      GTTRN950 IF LESS             * yes
.
.         IF        INVFLAG > 0
.           GOTO      GTTRN950 IF LESS                                 *I-65745
.         ENDIF                                                        *I-65745
.
          MATCH     ANSD,TMOVE                   * discharge record ?
          IF        @EQUAL
            MATCH     TDATE,ADATE
            GOTO      GTTRN930 IF NOT EQUAL      * discharge - overnight
            GOTO      GTTRN940                   * discharge - daycase
          ENDIF
          GOTO      GTTRN900
.
GTTRN900  MOVE      ZERO,EXIT                    * valid tran record
          GOTO      GTTRN999
.
GTTRN910  MOVE      ONE,EXIT                     * eof
          GOTO      GTTRN999
.
GTTRN920  MOVE      TWO,EXIT                     * invalid tran record
          GOTO      GTTRN999
.
GTTRN930  MOVE      THREE,EXIT                   * discharge - overnight
          GOTO      GTTRN999
.
GTTRN940  MOVE      FOUR,EXIT                    * discharge - daycase
          GOTO      GTTRN999
.
GTTRN950  MOVE      FIVE,EXIT                    * after last invoice date
GTTRN999  RETURN
+
.******************************************************************************
.*                                  CPRAR000              Called by: CKTRN000 *
.*              Check If Previous Record Was An Admission Record              *
.******************************************************************************
CPRAR000  MOVE      ZERO,DTGTNTRD           * Dont get next tran record - no
          MATCH     ADATE,TDATE
          GOTO      CPRAR900 IF NOT EQUAL   * Overnight patient, exit
.
          PACK      KEY30,TADMN,ADATE,SP30
          CALL      RDSTRAN2                * Position on & read a transfer
          CALL      RDKTRAN2                  file record
          BRANCH    OVRCD,CPRAR100
.
          MATCH     AADMNO,TADMN
          GOTO      CPRAR100 IF NOT EQUAL   * Different admin no
.
          MATCH     ADATE,TDATE
          GOTO      CPRAR100 IF NOT EQUAL   * Different transfer date
.
          MATCH     ANSA,TMOVE
          GOTO      CPRAR100 IF NOT EQUAL   * Not an admin record
.
          MOVE      ONE,DTGTNTRD            * Dont get next tran record - yes
          PACK      KEY30,TADMN,TDATE,ZED10,ZED10
          CALL      RDSTRAN2                * Position on & read a transfer
          CALL      RDPTRAN2                  file record
.
          PACK      SAVKEY30,TADMN,TDATE,TTIME,TWARD,TBED
          MOVE      ONE,DSCHFLAG            * Discharge record
          GOTO      CPRAR950
.
CPRAR100  PACK      KEY30,TADMN,TDATE,ZED10,ZED10
          CALL      RDSTRAN2                * Position on & read a transfer
          CALL      RDPTRAN2                  file record
.
CPRAR900  MOVE      ZERO,EXIT
          GOTO      CPRAR999
.
CPRAR950  MOVE      ONE,EXIT
CPRAR999  RETURN
+
.*****************************************************************************
.*                               GACCM000              Called by:            *
.*                  Get the accommodation code for this record               *
.* Returns: EXIT  0 = indicator found                                        *
.*                1 = no ward found/no code record found                     *
.*****************************************************************************
GACCM000  IF        PTCNNCFB<>1
            GOTO      GACCM100
          ENDIF
.
          MATCH     SP3,TATYPE                   * blank admission type ?
          GOTO      GACCM950 IF EQUAL            * yes - ignore
.
          PACK      KEY5,ANSA,SP1,TATYPE
          CALL      RDCODE1                      * admission type on file ?
          BRANCH    OVRCD,GACCM950               * no - ignore
.
          MATCH     ANSA,TCINDC8                 * load indicator 8
          IF        @EQUAL
            MOVE      TEN,VARIABLE
          ELSE
            MATCH     "4",TCINDC1                * Hosp in home      *C-V-003
            IF        @EQUAL
              MOVE      TEN1,VARIABLE
            ELSE
              MOVE      TCINDC8,VARIABLE
            ENDIF
          ENDIF
          GOTO      GACCM900
.
GACCM100  MATCH     SP3,TRBTYP                   * blank bed type ?
          GOTO      GACCM950 IF EQUAL            * yes - ignore
.
          PACK      KEY5,CATBT,TRBTYP
          CALL      RDCODE1                      * bed type on file ?
          BRANCH    OVRCD,GACCM950               * no - ignore
.
          MOVE      DTADMN,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,GACCM950
.
          MATCH     DTYR2019,ADATE               * admission before our date?
          GOTO      GACCM200 IF NOT LESS
.
.           For admissions before 1st July 2019 use indicator 3
          MATCH     ANSA,TCINDC3                 * load indicator 3
          IF        @EQUAL
            MOVE      TEN,VARIABLE
          ELSE
            MATCH     ANSH,TCINDC1               * Hosp in home      *C-V-003
            IF        @EQUAL
              MOVE      TEN1,VARIABLE
            ELSE
              MOVE      TCINDC3,VARIABLE
            ENDIF
          ENDIF
          GOTO      GACCM900
.
.           For admissions on OR after 1st July 2019, use indicator 13
GACCM200  MATCH     ANSA,TCINDC13                 * load indicator 13
          IF        @EQUAL
            MOVE      TEN,VARIABLE
          ELSE
            MATCH     ANSH,TCINDC13              * Hosp in home      *C-V-003
            IF        @EQUAL
              MOVE      TEN1,VARIABLE
            ELSE
              MOVE      TCINDC13,VARIABLE
            ENDIF
          ENDIF
          GOTO      GACCM900
.
GACCM900  MOVE      ZERO,EXIT
          GOTO      GACCM999
.
GACCM950  MOVE      ONE,EXIT
GACCM999  RETURN
+
.****************************************************************************
.*                              VALTR000               Called by:           *
.*              Validate tran record and set variables.                     *
.*              A transfer record will be written if accommodation code     *
.*              changes or if the daily rate changes.                       *
.* Returns: EXIT 0 = write tran record                                      *
.*               1 = ignore tran record                                     *
.****************************************************************************
VALTR000  MOVE      ZERO,EXIT
          PACK      SAVKY30B,TADMN,TDATE,TTIME,TWARD,TBED              *I-94247
.
          CALL      RDKTRAN2                  * read next tran record
          BRANCH    OVRCD,VALTR100            * eof
.
          MATCH      AADMNO,TADMN
          IF         @EQUAL  
            PACK      KEY30,TADMN,TDATE,ZED10,ZED10                    *I-94247
            CALL      RDSTRAN2                * position on last tran  *I-94247
            CALL      RDPTRAN2                * for that day           *I-94247
.
            MATCH    ANSD,TMOVE
            IF       @EQUAL
              MOVE     ONE,DSCHFLAG           * Discharge record
            ENDIF
          ENDIF
.
....      CALL      RDPTRAN2                  * re-pos on prev record   D-94247
          MOVE      SAVKY30B,KEY30            * re-pos on correct recd *I-94247
          CALL      RDTRAN2                                            *I-94247
.
VALTR100   CALL     GACCM000                     * get accommodation code
           BRANCH   EXIT,VALTR950                * no - ignore record
.
.          MATCH    SAVACOM,TCINDC3              * same accommodation code ?
.          GOTO     VALTR900 IF NOT EQUAL        * no - write tran record
.
.      ASSIGN   (TRATEF + TRATEH + PTTRADPT + PTTRADRB - TDISC - TALLW),FORM6P2
.          COMPARE  FORM6P2,SAVRATE              * same daily rate ?
.          GOTO     VALTR950 IF EQUAL            * yes - ignore record
.
VALTR900   MOVE     ZERO,EXIT
           GOTO     VALTR999
.
VALTR950   MOVE     ONE,EXIT
.
VALTR999   RETURN
+
.****************************************************************************
.*                         SAMDY000                    Called by:           *
.*                 Check if same day patient                                *
.****************************************************************************
.
SAMDY000  COMPARE   THREE,ASTAT                  * patient discharged ?
          GOTO      SAMDY950 IF NOT EQUAL        * no
.
          PACK      DISDATE,DDATE
.
          PACK      KEY8,AADMNO
          CALL      RDVISA1                      * visit record on file ?
          BRANCH    OVRCD,SAMDY950               * no - leave blank
.
          MATCH     PVIDATE,DISDATE              * same day patient ?
          GOTO      SAMDY950 IF NOT EQUAL        * no - ignore
.
          MOVE      ZERO,EXIT                    * yes
          GOTO      SAMDY999
.
SAMDY950  MOVE      ONE,EXIT
.
SAMDY999  RETURN
+
.****************************************************************************
.*                             OPSTM0000               Called by:           *
.*        Get the operation start time from theatre input usage             *
.****************************************************************************
.
OPSTM000  PACK      KEY31,AADMNO,SP30,SP20
          CALL      RSOPDEA2                     * position in op. details file
OPSTM050  CALL      RKOPDEA2                     * read next record
          BRANCH    OVRCD,OPSTM999               * eof
.
          MATCH     AADMNO,OPDAADMN              * same admission number ?
          GOTO      OPSTM999 IF NOT EQUAL        * no
.
          PACK      KEY11,OPDAUNIQ,SP20
          CALL      RSOPDEC1                     * position in op. usage file
OPSTM100  CALL      RKOPDEC1                     * read next record
          BRANCH    OVRCD,OPSTM050               * eof - get next detail rec.
.
          MATCH     OPDAUNIQ,OPDCUNIQ            * same unique id still ?
          GOTO      OPSTM050 IF NOT EQUAL        * no - get next detail rec.
.
          LOAD      SRTTIMED,OPCNFOTM,OPDCOTM1,OPDCOTM2,OPDCOTM3,OPDCOTM4
          CALL      GOST0000                     * get the operation start time
          GOTO      OPSTM100                     * get next usage record
.
OPSTM999  RETURN
+
.******************************************************************************
.*                                  GOST0000              Called by:          *
.*                        Get The Operation Start Time                        *
.******************************************************************************
GOST0000  MATCH     SP5,SRTTIMED
          GOTO      GOST9999 IF EQUAL       * Blank start time, exit
.
          UNPACK    SRTTIMED,DIM2,KEY1,KEY2
          PACK      KEY4,DIM2,KEY2
          TYPE      KEY4
          GOTO      GOST9999 IF NOT EQUAL   * Non numeric start time, exit
.
          REP       " 0",KEY4
          MOVE      KEY4,SRTTIMEF
.
          MATCH     SP5,SSTTIMED
          IF        @EQUAL
            MOVE      SRTTIMED,SSTTIMED     * Blank save time
            MOVE      SRTTIMEF,SSTTIMEF
          ELSE
            IF        SSTTIMEF<SRTTIMEF
              MOVE      SRTTIMED,SSTTIMED   * Saved time < start time
              MOVE      SRTTIMEF,SSTTIMEF
            ENDIF
          ENDIF
GOST9999  RETURN
+
.****************************************************************************
.*                             OPETM0000               Called by:           *
.*        Get the operation end time from theatre input usage               *
.****************************************************************************
.
OPETM000  PACK      KEY31,AADMNO,SP30,SP20
          CALL      RSOPDEA2                     * position in op. details file
OPETM050  CALL      RKOPDEA2                     * read next record
          BRANCH    OVRCD,OPETM999               * eof
.
          MOVE      OPDAADMN,DIM8VISN
          MATCH     AADMNO,DIM8VISN              * same admission number ?
          GOTO      OPETM999 IF NOT EQUAL        * no
.
          PACK      KEY11,OPDAUNIQ,SP20
          CALL      RSOPDEC1                     * position in op. usage file
OPETM100  CALL      RKOPDEC1                     * read next record
          BRANCH    OVRCD,OPETM050               * eof - get next detail rec.
.
          MATCH     OPDAUNIQ,OPDCUNIQ            * same unique id still ?
          GOTO      OPETM050 IF NOT EQUAL        * no - get next detail rec.
.
          LOAD      ENDTIMED,OPCNTOTM,OPDCOTM1,OPDCOTM2,OPDCOTM3,OPDCOTM4
          CALL      GOET0000                     * get the operation end time
          GOTO      OPETM100                     * get next usage record
.
OPETM999  RETURN
+
.******************************************************************************
.*                                  GOET0000              Called by:          *
.*                         Get The Operation End Time                         *
.******************************************************************************
GOET0000  MATCH     SP5,ENDTIMED
          GOTO      GOET9999 IF EQUAL       * Blank end time, exit
.
          UNPACK    ENDTIMED,DIM2,KEY1,KEY2
          PACK      KEY4,DIM2,KEY2
          TYPE      KEY4
          GOTO      GOET9999 IF NOT EQUAL   * Non numeric end time, exit
.
          REP       " 0",KEY4
          MOVE      KEY4,ENDTIMEF
.
          MATCH     SP5,SEDTIMED
          IF        @EQUAL
            MOVE      ENDTIMED,SEDTIMED     * Blank save time
            MOVE      ENDTIMEF,SEDTIMEF
          ELSE
            IF        SEDTIMEF<ENDTIMEF
              MOVE      ENDTIMED,SEDTIMED   * Saved time < end time
              MOVE      ENDTIMEF,SEDTIMEF
            ENDIF
          ENDIF
GOET9999  RETURN
+
.****************************************************************************
.*                            CKMBS000                 Called by:           *
.*             Check if we have an MBS record field.                        *
.****************************************************************************
.
CKMBS000  MOVE      ZERO,COUNTR                  * initialise counter
          WHILE     COUNTR < 3
            ADD       ONE,COUNTR                 * increment counter
.
            BRANCH    MMBSFLAG,CKMBS100:         * processing first row
                               CKMBS200:         * processing second row
                               CKMBS300:         * processing third row
                               CKMBS600          * processing fourth row
.
            COMPARE   "203",FORM5
            GOTO      CKMBS520 IF EQUAL           * Item 1 Description
.
            LOAD      FLDNUM,COUNTR,SEVENTY2,SEVENTY3,SEVENTY4
            GOTO      CKMBS500
.
CKMBS100    COMPARE   "204",FORM5
            GOTO      CKMBS520 IF EQUAL           * Item 2 Description
.
            LOAD      FLDNUM,COUNTR,SEVENTY5,SEVENTY6,SEVENTY7
            GOTO      CKMBS500
.
CKMBS200    COMPARE   "205",FORM5
            GOTO      CKMBS520 IF EQUAL           * Item 3 Description
.
            LOAD      FLDNUM,COUNTR,SEVENTY8,SEVENTY9,EIGHTY
            GOTO      CKMBS500
.
CKMBS300    COMPARE   "206",FORM5
            GOTO      CKMBS520 IF EQUAL           * Item 4 Description
.
            LOAD      FLDNUM,COUNTR,EIGHTY1,EIGHTY2,EIGHTY3
.
CKMBS500    COMPARE   FLDNUM,FORM5               * MBS record field ?
            IF        @EQUAL 
CKMBS520
              IF        MMBSFLAG = 0 & FRSTFLAG = 0
                PACK      KEY22,AADMNO,SP20
                CALL      RDSDTRN1               * Position on the DTR file
              ELSE
                MOVE      MBSKEY22,KEY22
                CALL      RDSDTRN1
              ENDIF
.                                                * set for next MBS row
              ADD       ONE,MMBSFLAG             *         re-inserted *I-90301
.
CKMBS600      CALL      GTAMT000                 * validate and get amount
              BRANCH    EXIT,CKMBS950            * no more MBS records
.
CKMBS800      IF        MMBSFLAG = 4
                MOVE      FIVE,MMBSFLAG
              ENDIF
.
              PACK      MBSKEY22,TADMNO,TREF,TTRANSN1,SP30  
              GOTO      CKMBS999                                       *I-90301
            ENDIF                                                      *I-90301
          DO                                * end WHILE COUNTR < 3     *I-90301
.
          GOTO      CKMBS999                                           *I-90301
.
CKMBS950  MOVE      SIX,MMBSFLAG                 * set flag to finished
.
CKMBS999  RETURN
+
.******************************************************************************
.*                                 GTAMT000             Called by:            *
.*               get the amount charged for the MBS item from DTR             *
.* Returns: TPATAMTT - amount charged for item                                *
.******************************************************************************
.
GTAMT000  MOVE      ZERO,FORM6P2
GTAMT100  CALL      RDKDTRN1                     * Read next DTR record
          BRANCH    OVRCD,GTAMT950               * eof
.
          MATCH     AADMNO,TADMNO                * same admission number still ?
          GOTO      GTAMT950 IF NOT EQUAL        * no
.
          COMPARE   ZERO,TINVPRT                 * invoiced ?
          GOTO      GTAMT100 IF EQUAL            * no - ignore
.
          COMPARE   TRECTYPE,TWO                 * theatre record ?
          GOTO      GTAMT100 IF NOT EQUAL        * no - ignore
.         *
.         *         check to see if msb item belongs to the invoice, patdtra
.         *
          IF        INVFLAG > 0
            MATCH   TREF,HFCFINVN
            GOTO      GTAMT100 IF NOT EQUAL
          ENDIF
.
          PACK      DTRDATE,DTFCENT,DTFYEAR,DTFMONTH,DTFDAY
          REP       " 0",DTRDATE
          PACK      DTRIDESC,TDDESC,SP70
          MOVE      TITEMNO,DTRITEM
          MOVE      TPATAMTT,DTRAMTT
.
          PACK      KEY22,TADMNO,TREF,TTRANSN1,SP70
          CALL      CRNT0000
          BRANCH    EXIT,GTAMT100                * Credit note
          IF        EXIT=2
            SUB       FORM12P2,TPATAMTT
          ENDIF
.*                                               * found matching DTR save KEY
.         PACK      MBSKEY22,TADMNO,TREF,TTRANSN1,SP30                 *I-90301
.
          MOVE      ZERO,EXIT
          GOTO      GTAMT999
.
GTAMT950  MOVE      ONE,EXIT
.
GTAMT999  RETURN
+
.****************************************************************************
.*                             GTANA000                Called by:           *
.*                       Get anaesthetic type                               *
.* Returns:  EXIT  0 = valid type found                                     *
.*                 1 = invalid type                                         *
.****************************************************************************
.
GTANA000  BRANCH    OPRFOUND,GTANA950            * not using opr - so ignore
.
.         As this is only a day patient, I assume that there will only be
.         one oprdetaf record for this admission
.
          PACK      KEY31,AADMNO,SP30,SP20
          CALL      RSOPDEA2                     * position in op. details file
GTANA050  CALL      RKOPDEA2                     * read next record
          BRANCH    OVRCD,GTANA950               * eof
.
          MOVE      OPDAADMN,DIM8VISN
          MATCH     AADMNO,DIM8VISN              * same admission number ?
          GOTO      GTANA950 IF NOT EQUAL        * no
.
          COMPARE   THREE,OPDASTAT               * cancelled booking ?
          GOTO      GTANA050 IF EQUAL            * yes - get next record
.
          MATCH     OPDAANAE,SP3                 * anaesthetic type blank ?
          GOTO      GTANA950 IF EQUAL            * yes - ignore
.
          PACK      KEY5,CATOA,OPDAANAE
          CALL      RDCODE1                      * code on file ?
          BRANCH    OVRCD,GTANA950               * no
.
          MATCH     TCINDC1,ANATYPE              * same anaesthetic type ?
          GOTO      GTANA950 IF NOT EQUAL        * no - ignore
.
          MOVE      ZERO,EXIT
          GOTO      GTANA999
.
GTANA950  MOVE      ONE,EXIT
.
GTANA999  RETURN
+                                                                      *C-V-015
.****************************************************************************
.*                            CKTHT000                 Called by:           *
.*             Check if we have Theatre items.                              *
.*             Note: Theatre times are based on the MBS items and           *
.*                   the only way to tell if its a new session is           *
.*                   by the times. All MBS items belonging to the same      *
.*                   theatre session should have the same times.            *
.*                                                                          *
.****************************************************************************
.
CKTHT000  MOVE      ZERO,COUNTR                  * initialise counter
          WHILE     COUNTR < 2
            ADD       ONE,COUNTR                 * increment counter
.
            BRANCH    THETIMES,CKTHT100:         * processing second row
                               CKTHT200:         * processing third row
                               CKTHT500          * processing done
.
            LOAD      FLDNUM,COUNTR,THREE01,THREE02
            GOTO      CKTHT500
.
CKTHT100    LOAD      FLDNUM,COUNTR,THREE03,THREE04
            GOTO      CKTHT500
.
CKTHT200    LOAD      FLDNUM,COUNTR,THREE05,THREE06
            GOTO      CKTHT500
.
CKTHT500    COMPARE   FLDNUM,FORM5               * theatre record field
            IF        @EQUAL
              IF        THETIMES = 0 & FRSTFLAG = 0
                PACK      KEY11,AADMNO,SP8
                CALL      RDSMMBS1               * position in file
              ELSE
                MOVE      SAVTHT11,KEY11
                CALL      RDMMBS1
                IF        OVRCD=0
                  MOVE      MMSTIM,PREVSTTM
                ENDIF
              ENDIF
              ADD       ONE,THETIMES             * set for next Thet row
.
CKTHT600      CALL      GTTHE000                 * read the next services rec.
              BRANCH    EXIT,CKTHT950            * no more services records
.
              IF        THETIMES = 3
                MOVE      FOUR,THETIMES
              ENDIF
.
              PACK      SAVTHT11,MMADMN,MMRECN,SP10
              GOTO      CKTHT999                 * valid Thet record found
            ENDIF
          DO
          GOTO      CKTHT999
.
CKTHT950  MOVE      SIX,THETIMES                 * set flag to finished
.
CKTHT999  RETURN
+
+                                                                      *C-V-015
.****************************************************************************
.*                             GTTHE000                Called by:           *
.*            get the next valid MBS record for printing                    *
.*            we are getting the theatre session times from the MBS Items   *
.* Returns:  EXIT 0 = valid MBS record read                                 *
.*                1 = no more records                                       *
.****************************************************************************
.
GTTHE000  CALL      RDKMMBS1                     * read next Current record
          BRANCH    OVRCD,GTTHE950               * eof - finished
.
          MATCH     MMADMN,AADMNO                * same admission number still
          GOTO      GTTHE950 IF NOT EQUAL        * no - finished
.
.         * check against previous time as this is the only way
.         * we know its a new theater session.
.
.******************************************** start of addition        *I-65745
          IF        INVFLAG > 0
            MOVE      KEY22,DIM22                * save key
            CALL      CKINV000                   * check if item on invoice
            BRANCH    MBINVFLG,GTTHT000          * 1 = no -> don't put on form
            MOVE      DIM22,KEY22                * restore key
            CALL      RDSDTRN1                   * reposition on dtr file
          ENDIF
.********************************************   end of addition        *I-65745
          MATCH     PREVSTTM,MMSTIM
          GOTO      GTTHE000 IF EQUAL            * Same Thet session
.
GTTHE900  MOVE      ZERO,EXIT                    * valid MBS record
          GOTO      GTTHE999
.
GTTHE950  MOVE      ONE,EXIT
.
GTTHE999  RETURN
+
.****************************************************************************
.*                            CKSER000                 Called by:           *
.*             Check if we have an Other Services record field.             *
.****************************************************************************
.
CKSER000  MOVE      ZERO,COUNTR                  * initialise counter
          WHILE     COUNTR < 5
            ADD       ONE,COUNTR                 * increment counter
.
            BRANCH    SERVFLAG,CKSER100:         * processing first row
                               CKSER200:         * processing second row
                               CKSER300:         * processing third row
                               CKSER600          * processing fourth row
.
            LOAD      FLDNUM,COUNTR,ONE82,ONE83,ONE84,ONE85,THREE12    *C-V-021
            GOTO      CKSER500
.
CKSER100    LOAD      FLDNUM,COUNTR,ONE86,ONE87,ONE88,ONE89,THREE13    *C-V-021
            GOTO      CKSER500
.
CKSER200    LOAD      FLDNUM,COUNTR,ONE90,ONE91,ONE92,ONE93,THREE14    *C-V-021
            GOTO      CKSER500
.
CKSER300    LOAD      FLDNUM,COUNTR,ONE94,ONE95,ONE96,ONE97,THREE15    *C-V-021
.
CKSER500    COMPARE   FLDNUM,FORM5               * Other Services record field ?
            IF        @EQUAL 
              IF        SERVFLAG = 0 & FRSTFLAG = 0
                PACK      KEY22,AADMNO,SP20
                CALL      RDSDTRN1               * Position on the DTR file
              ELSE
                MOVE      SAVKEY22,KEY22
                CALL      RDDTRN1
              ENDIF
              ADD       ONE,SERVFLAG             * set for next services row
.
CKSER600      CALL      GTSER000                 * read the next services rec.
              BRANCH    EXIT,CKSER950            * no more services records
.
              IF        SERVFLAG = 4
                MOVE      FIVE,SERVFLAG
              ENDIF
.
              PACK      SAVKEY22,TADMNO,TREF,TTRANSN1
              GOTO      CKSER999                 * valid services record found
            ENDIF
          DO
          GOTO      CKSER999
.
CKSER950  MOVE      SIX,SERVFLAG                 * set flag to finished
.
CKSER999  RETURN
+
.****************************************************************************
.*                             GTSER000                Called by:           *
.*            get the next valid services record for printing               *
.* Returns:  EXIT 0 = valid services record read                            *
.*                1 = no more records                                       *
.****************************************************************************
.
GTSER000  CALL      RDKDTRN1                     * Read next DTR record
          BRANCH    OVRCD,GTSER950               * eof - finished
.
          MATCH     AADMNO,TADMNO                * same admission number still ?
          GOTO      GTSER950 IF NOT EQUAL        * no - finished
.
          COMPARE   ZERO,TINVPRT                 * invoiced ?
          GOTO      GTSER000 IF EQUAL            * no - ignore
.
          IF        INVFLAG > 0
            MATCH     TREF,HFCFINVN                                    *I-65745
            GOTO      GTSER000 IF NOT EQUAL      * must be on last inv. I-65745
          ENDIF                                                        *I-65745
.
          COMPARE   THREE,TRECTYPE               * Miscellaneous charge ?
          GOTO      GTSER000 IF NOT EQUAL        * no - ignore
.
          MATCH     SP3,TMISGRP                  * blank misc. group code ?
          GOTO      GTSER000 IF EQUAL            * yes - ignore
.
          PACK      KEY5,CATFI,TMISGRP
          CALL      RDCODE1                      * code on file ?
          BRANCH    OVRCD,GTSER000               * no - ignore
.
          MATCH     SP1,TCINDC3                  * indicator blank ?
          GOTO      GTSER000 IF EQUAL            * yes - ignore
.
          PACK      KEY22,TADMNO,TREF,TTRANSN1,SP70
          CALL      CRNT0000
          BRANCH    EXIT,GTSER000                * Credit note
.
          MOVE      ZERO,EXIT                    * valid services record
          GOTO      GTSER999
.
GTSER950  MOVE      ONE,EXIT                     * eof
.
GTSER999  RETURN
+
.****************************************************************************
.*                             GTLOS000                Called by:           *
.*                       Get length of stay                                 *
.* Parameters: FORM1  0 = Length of Stay                                    *
.*                    1 = Leave Days                                        *
.****************************************************************************
GTLOS000  MOVE      ZERO,LOSDAYS                 * initialise day count
          MOVE      SP8,CDYSFDTE                 * initialise from date
.
          PACK      KEY30,AADMNO,SP30
          CALL      RDSTRAN2                     * position in file
          CALL      RDKTRAN2                     * read next tran record
          BRANCH    OVRCD,GTLOS900               * eof - finished
.
          MATCH     AADMNO,TADMN                 * same admission number ?
          GOTO      GTLOS900 IF NOT EQUAL        * no - finished
.
          MATCH     ANSA,TMOVE                   * first record admission ?
          GOTO      GTLOS900 IF NOT EQUAL        * no - error
.
          BRANCH    FORM1,GTLOS050               * leave days only
          PACK      CDYSFDTE,TDATE               * save admission date
.
GTLOS050  CALL      RDKTRAN2                     * read next record
          BRANCH    OVRCD,GTLOS800               * eof - finished
.
          MATCH     AADMNO,TADMN                 * same admission number ?
          GOTO      GTLOS800 IF NOT EQUAL        * no - finished
.
          MATCH     ANSD,TMOVE                   * discharge record ?
          IF        @EQUAL
            MATCH     SP8,CDYSFDTE               * blank from date ?
            GOTO      GTLOS900 IF EQUAL          * yes - finished
.
            PACK      CDYSTDTE,DDATE             * yes - load to date
            CALL      CALCDAYS                   * calculate days
            SUB       ONE,CDYSDAYS               * get difference
            ADD       CDYSDAYS,LOSDAYS           * update length of stay days
            GOTO      GTLOS900                   * finished
          ENDIF
.
          MATCH     ANSL,TMOVE                   * on-leave record ?
          IF        @EQUAL
            IF        FORM1 = 0
              PACK      CDYSTDTE,TDATE           * load to date
              CALL      CALCDAYS                 * calculate days
              SUB       ONE,CDYSDAYS             * get difference
              ADD       CDYSDAYS,LOSDAYS         * update length of stay days
              MOVE      SP8,CDYSFDTE
            ELSE
              PACK      CDYSFDTE,TDATE
            ENDIF
            GOTO      GTLOS050
          ENDIF
.
          MATCH     ANSR,TMOVE                   * return record ?
          IF        @EQUAL
            IF        FORM1 = 0
              PACK      CDYSFDTE,TDATE           * load to date
            ELSE
              PACK      CDYSTDTE,TDATE           * load to date
              CALL      CALCDAYS                 * calculate days
              SUB       ONE,CDYSDAYS             * get difference
              ADD       CDYSDAYS,LOSDAYS         * update length of stay days
              MOVE      SP8,CDYSFDTE
            ENDIF
            GOTO      GTLOS050
          ENDIF
.
          GOTO      GTLOS050                     * get next transfer record
.
GTLOS800  MATCH     SP8,CDYSFDTE                 * from date blank ?
          GOTO      GTLOS900 IF EQUAL            * yes - finished
.
          PACK      CDYSTDTE,CCC,CYY,CMM,CDD
          CALL      CALCDAYS                     * calculate days
          SUB       ONE,CDYSDAYS                 * get difference
          ADD       CDYSDAYS,LOSDAYS             * update length of stay days
.
GTLOS900  MOVE      SAVKEY30,KEY30
          CALL      RDTRAN2
GTLOS999  RETURN
+
.****************************************************************************
.*                             GTTHT000                Called by:           *
.*                       Get Theatre Times (Arrival and Exit)      *I-55477 *
.* Parameters: FORM1  0 = Arrival                                           *
.*                    1 = Exit                                              *
.****************************************************************************
GTTHT000  PACK      KEY31,AADMNO,SP70
          CALL      RSOPDEA2
GTTHT010  CALL      RKOPDEA2
          BRANCH    OVRCD,GTTHT999
.
          MATCH     DAADMNO,OPDAADMN
          GOTO      GTTHT999 IF NOT EQUAL
.
          MATCH     "3",DOPDASTA
          GOTO      GTTHT010 IF EQUAL
.
          PACK      KEY10,OPDAUNIQ,SP70
          CALL      RDOPARD1
          BRANCH    OVRCD,GTTHT999
.
          IF        FORM1=ZERO
            MOVE      OPARATIM,VARIABLE
          ELSE
            MOVE      OPARTETC,VARIABLE
          ENDIF
.
GTTHT999  RETURN
+
.****************************************************************************
.*                             GETD0000                Called by:           *
.*                       Get Diagnosis Description                 *I-55723 *
.* Parameters: DIM2 - Diagnosis Number                                      *
.****************************************************************************
GETD0000  MOVE      ZERO,EXIT
          MOVE      " 1",KEY2                                         *C-240107
          MOVE      FORM3,KEY3                                        *C-240107
          PACK      KEY13,AADMNO,KEY2,KEY3,SP20
          CALL      RDPTECD1
          BRANCH    OVRCD,GETD9000
.
          MATCH     SP70,PTEDDESC
          IF        @EQUAL
            PACK      KEY9,PTEDCODE,SP70
            CALL      RDPTICD1
            BRANCH    OVRCD,GETD9000
.
            MOVE      DDESC,VARIABLE
          ELSE
            MOVE      PTEDDESC,VARIABLE
          ENDIF
          GOTO      GETD9999
.
GETD9000  MOVE      ONE,EXIT
GETD9999  RETURN
+
.****************************************************************************
.*                             GETP0000                Called by:           *
.*                       Get Procedure Description                 *I-55723 *
.* Parameters: DIM2 - Procedure Number                                      *
.****************************************************************************
GETP0000  MOVE      ZERO,EXIT
          MOVE      " 1",KEY2                                         *C-240107
          MOVE      FORM3,KEY3                                        *C-240107
          PACK      KEY13,AADMNO,KEY2,KEY3,SP20
          CALL      RDPTECO1
          BRANCH    OVRCD,GETP9000
.
          MATCH     SP70,PTEODESC
          IF        @EQUAL
            PACK      KEY9,PTEOCODE,SP70
            CALL      RDPTICO1
            BRANCH    OVRCD,GETP9000
.
            MOVE      DDESC,VARIABLE
          ELSE
            MOVE      PTEODESC,VARIABLE
          ENDIF
          GOTO      GETP9999
.
GETP9000  MOVE      ONE,EXIT
GETP9999  RETURN
+
.****************************************************************************
.*                             GTBC0000                Called by:           *
.*                       Get Procedure Block Code                  *I-55723 *
.* Parameters: DIM2 - Procedure Number                                      *
.****************************************************************************
GTBC0000  MOVE      ZERO,EXIT
          PACK      KEY13,AADMNO,SP1,ONE,DIM2,SP70
          CALL      RDPTECO1
          BRANCH    OVRCD,GTBC9000
.
          PACK      KEY9,PTEOCODE,SP70
          CALL      RDPTICO1
          BRANCH    OVRCD,GTBC9000
.
          MOVE      PT0OBLKN,VARIABLE
          GOTO      GTBC9999
.
GTBC9000  MOVE      ONE,EXIT
GTBC9999  RETURN
+
. ******************************************* start of addition        *I-62428
.****************************************************************************
.*                             NEWBB000                Called by:           *
.*                      Check if New-born Baby                              *
.*        (logic taken from NCGSEGMT.PBL at label WRANB000)                 *
.****************************************************************************
NEWBB000  MOVE      ONE,EXIT
          MOVE      ZERO,BBYNO
          MATCH     "F",PSEX
          GOTO      NEWBB999 IF NOT EQUAL
.
          MOVE      PURNO,SAVKEY8                * save the original UR No.
          MOVE      AADMNO,SAVKEY8A              * save the original Admiss.No
          MOVE      ADATE,SAVDAT1                * save orig. Admission date
          IF        ASTAT = 3
            MOVE      DDATE,SAVDAT2              * save discharge date
          ELSE
            PACK      SAVDAT2,CCC,CYY,CMM,CDD
            REP       " 0",SAVDAT2
          ENDIF
.
.         The patient is female, so check if there are any linked U/R's
.
          PACK      KEY16,PURNO,SP20
          CALL      RDSLINK1                     * position in link file for U/R
NEWBB100  CALL      RDKLINK1                     * read next record
          BRANCH    OVRCD,NEWBB900               * eof - finished
.
          MATCH     SAVKEY8,LINKFUR              * same U/R still ?
          GOTO      NEWBB900 IF NOT EQUAL        * no - finished
.
.         A linked U/R has been found for this patient, so check if
.         the link reason code is for a Mother/Child relationship (Indicator 1,
.         Category LU = "M").
.
          MATCH     SP3,LINKREA                  * link reason blank ?
          GOTO      NEWBB100 IF EQUAL            * yes - ignore
.
          PACK      KEY5,ANSL,ANSU,LINKREA
          CALL      RDCODE1                      * code on file ?
          BRANCH    OVRCD,NEWBB100               * no - ignore
.
          MATCH     ANSM,TCINDC1                 * Indicator 1 set to "M" ?
          GOTO      NEWBB100 IF NOT EQUAL        * no - ignore
.
.         Check if we are using unquailified status or date of birth to
.         validate a mother/baby link.
.
          COMPARE   ONE,PTCNMBRL                 * using DOB validation ?
          GOTO      NEWBB300 IF EQUAL            * yes
.
. - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
.         Using unqualified status to validate mother/baby link.
.         The link reason is a valid mother/baby link, so check if this
.         patient was admitted during the mother's inpatient stay
.
          PACK      KEY16,SAVDAT1,SP20
          CALL      RDSMISS3                     * position in admission file
NEWBB200  CALL      RDKMISS3                     * read next record
          BRANCH    OVRCD,NEWBB100               * eof - get next linked U/R
.
          MATCH     ADATE,SAVDAT2                * moth. disch. date < admit dte
          GOTO      NEWBB100 IF LESS             * yes - get next linked U/R
.
          MATCH     LINKTUR,AURNO                * same U/R number ?
          GOTO      NEWBB200 IF NOT EQUAL        * no - ignore admission
.
.         This linked U/R was admitted while the patient was admitted, so
.         check if it was an unqualified baby (Category A, Indicator 2 = "U")
.
          MATCH     SP3,ATYPE                    * blank admission type ?
          GOTO      NEWBB200 IF EQUAL            * yes - ignore admission
.
          PACK      KEY5,ANSA,SP1,ATYPE
          CALL      RDCODE1                      * admission type found ?
          BRANCH    OVRCD,NEWBB200               * no - ignore admission
.
          MATCH     ANSU,TCINDC2                 * unqualified baby ?
          GOTO      NEWBB200 IF NOT EQUAL        * no - ignore admission
. - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
.
.         The linked U/R is a valid unqualifed newborn, or we are using
.         DOB to validate the mother/baby link, so get the baby's PMI details
.
NEWBB300  MOVE      LINKTUR,KEY8
          CALL      RDMAST1                      * PMI record found ?
          BRANCH    OVRCD,NEWBB100               * no - ignore this UR  
.
          COMPARE   ONE,PTCNMBRL                 * using DOB validation ?
          IF        @EQUAL
            MATCH     SAVDAT1,PBDATE             * mother admit date vs d-o-b
            GOTO      NEWBB100 IF LESS           * yes - no match
.
            IF        ASTAT = 3
              MATCH     SAVDAT2,PBDATE           * mother disch date vs d-o-b
              GOTO      NEWBB100 IF NOT LESS
            ENDIF
          ENDIF
.
NEWBB400  COMPARE   "9",BBYNO                    * maximum of 9 Babies
          GOTO      NEWBB900 IF NOT LESS
.                                                * save linked baby info.
          ADD       ONE,BBYNO
          MOVE      PURNO,BBYURNO[BBYNO]
          MOVE      PSNAME,BBYSNAME[BBYNO]
          MOVE      PGNAME,BBYGNAME[BBYNO]
          MOVE      PBDATE,BBYDOB[BBYNO]
          MOVE      PSEX,BBYSEX[BBYNO]
          GOTO      NEWBB100
.
.
.
NEWBB900  MATCH     SAVKEY8,PURNO                * Have we got correct Master ?
          GOTO      NEWBB950 IF EQUAL
          MOVE      SAVKEY8,KEY8                 * reposition on original mast.
          CALL      RDMAST1
.
NEWBB950  UNPACK    SAVKEY8A,KEY8 
          MATCH     KEY8,DAADMNO
          GOTO      NEWBB999 IF EQUAL
          CALL      RDMISS1                      * reposition on orig. Admiss.
.
NEWBB999  MOVE      ONE,BABYFLAG                 * New Babies have been read
          RETURN
. *******************************************   end of addition        *I-62428
+
.****************************************************************************
.*                             GTCER000                Called by:           *
.*            Get the Type B or C Indicator for the MBS Items               *
.****************************************************************************
GTCER000  MOVE      ZERO,BCCERCNT
          MOVE      SP70,BCCERINB
          MOVE      SP70,BCCERINC
.
          PACK      KEY22,AADMNO,SP70
          CALL      RDSDTRN1
GTCER100  CALL      RDKDTRN1
          BRANCH    OVRCD,GTCER999
.
          MATCH     AADMNO,TADMNO
          GOTO      GTCER999 IF NOT EQUAL
.
          COMPARE   ZERO,TINVPRT
          GOTO      GTCER100 IF EQUAL
.
          COMPARE   TRECTYPE,TWO
          GOTO      GTCER100 IF NOT EQUAL
.
          PACK      KEY22,TADMNO,TREF,TTRANSN1,SP70
          CALL      CRNT0000
          BRANCH    EXIT,GTCER100           * Credit note
.
          ADD       ONE,BCCERCNT
          IF        ONE<BCCERCNT
            GOTO      GTCER9999
          ENDIF
.
          PACK      KEY8,DTFCENT,DTFYEAR,DTFMONTH,DTFDAY,SP70
          REP       " 0",KEY8
          PACK      KEY17,TITEMNO,KEY8,SP70
          CALL      PATITMRD
          BRANCH    OVRCD,GTCER100
.
          PACK      KEY5,CATCR,PTITTCER,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            IF        TCFORM6=1
              CALL      SAMDY000
              IF        EXIT=1
                MOVE      "X",BCCERINB
              ENDIF 
            ENDIF
            IF        TCFORM6=2
              MOVE      "X",BCCERINC
            ENDIF
          ENDIF
.
          GOTO      GTCER100
.
GTCER999  RETURN
+
.****************************************************************************
.*                             GVRHCP00                                     *
.*            Get Visit Based Referring HCP Information                     *
.****************************************************************************
GVRHCP00  PACK      KEY10,PMVXRHC1,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,GVRHCP99
.
          ASSIGN    (FORM5 - 333),FORM4
          BRANCH    FORM4,GVRHCP10,GVRHCP20,GVRHCP30,GVRHCP40,GVRHCP50:
                          GVRHCP60,GVRHCP70,GVRHCP80,GVRHCP90
.
          GOTO      GVRHCP99
.
GVRHCP10  MOVE      PMVXRHC1,VARIABLE       * 334 HCP Code
          GOTO      GVRHCP99
.
GVRHCP20  MOVE      PMHCSNAM,PACSNAME
          MOVE      PMHCGNAM,PACGNAME
          MOVE      PMHCTITL,PACTITLE
          MOVE      TWO,PACFRMT
          CALL      PACNAME
          MOVE      PACFNAME,VARIABLE       * 335 HCP Name
          GOTO      GVRHCP99
.
GVRHCP30  MOVE      PMHCADR1,VARIABLE       * 336 HCP Address 1
          GOTO      GVRHCP99
.
GVRHCP40  MOVE      PMHCADR2,VARIABLE       * 337 HCP Address 2
          GOTO      GVRHCP99
.
GVRHCP50  MOVE      PMHCADR3,VARIABLE       * 338 HCP Address 3
          GOTO      GVRHCP99
.
GVRHCP60  MOVE      PMHCADR4,VARIABLE       * 339 HCP Address 4
          GOTO      GVRHCP99
.
GVRHCP70  MOVE      PMHCPOST,VARIABLE       * 340 HCP Postcode
          GOTO      GVRHCP99
.
GVRHCP80  MOVE      PMHCSTEL,VARIABLE       * 341 HCP Telephone
          GOTO      GVRHCP99
.
GVRHCP90  MOVE      PMHCFAXN,VARIABLE       * 342 HCP Fax Number
          GOTO      GVRHCP99
.
GVRHCP99  RETURN
+
.--------------------------------------------------------------------
. Get concession card details
. DIM1 = 1 - Concession Card
.        2 - Safety Net Card
.        3 - DVA Card
.        4 - Pension Card
.--------------------------------------------------------------------
GCCARD00  MOVE      "ct",DIM2
          PACK      KEY19,PURNO,SP70
          CALL      RSPMCCD1
GCCARD20  CALL      RKPMCCD1
          BRANCH    OVRCD,GCCARD80
.
          MATCH     PURNO,PMCDURNO
          GOTO      GCCARD80 IF NOT EQUAL
.
          PACK      KEY5,DIM2,PMCDCTYP
          CALL      RDCODE1
          BRANCH    OVRCD,GCCARD20
.
          MATCH     DIM1,TCINDC1
          GOTO      GCCARD99 IF EQUAL
.
          GOTO      GCCARD20
.
GCCARD80  MOVE      SP70,PMCDCNUM
          MOVE      SP70,PMCDCTYP
          MOVE      SP70,PMCDEXDT
          MOVE      SP70,PMCDDVAC
          GOTO      GCCARD99
.
GCCARD99  RETURN
+
.******************************************************************************
          INC       GETDRG      
          INC       OPRDEAIO/INC
          INC       OPRDECIO/INC
          INC       PATDADIO/INC
          INC       PATDTRIO/INC
          INC       PATECDIO/INC
          INC       PATECOIO/INC
          INC       PATICDIO/INC
          INC       PATICOIO/INC
          INC       PATICUIO/INC
          INC       PATMMBIO/INC
          INC       PATPGRIO/INC
          INC       PATTRNIO/INC
          INC       PATVADIO/INC
          INC       PATDO1IO/INC
          INC       PATHSPIO/INC
          INC       PMSVX1IO/INC
          INC       PATIN1IO/INC            * Insurance Details file  
          INC       PMSRESIO/INC            * Patient Residence Details file
          INC       IBAOVRIO/INC
          INC       IBATMHIO/INC
          INC       IBATMDIO/INC
          INC       IBAVARIO/INC
.
ENDPHFCF  ENDPROC
+
