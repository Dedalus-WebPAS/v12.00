.******************************************************************************
.* System         : theatre                                                   *
.* Program        : IBAOPR66                                                  *
.* Description    : Daily Operating Room List                                 *
.******************************************************************************
.* Programmer     : Peter Eddey                                               *
.* Date           : 16/01/1991                                                *
.* Mod's          :                                                           *
.*                                                                            *
.******************************************************************************
.* V12.00.03 27/06/2025  Thanh T        TSK 0955755                           *
.*           Added report layout 10                                           *
.* V12.00.02 10/06/2025  Thanh T        TSK 0955755                           *
.*           Added report layout 10                                           *
.******************************************************************************
.* V12.00.01 19/05/2025 Thanh T         TSK 0955096                           *
.*           Changed for alphanumeric visit number                            *
.******************************************************************************
.* V11.03.03 06/06/2023  Thanh T        TSK 0933298                           *
.*           Changed PRBP0000, PRBT0000, PRBC0000 and PRBS0000 to call        *
.*           RDOPSES7 when it is single hospital mode                         * 
.* V11.03.02 20/04/2023  Thanh T        TSK 0909393                           *
.*           Changed PRBP0000 to use RSOPSES7 instead of RDOPSES1             * 
.* V11.03.01 20.03.2023  PJ Le Febour   TSK 0909393a                          *
.*           Amended KEY19 to KEY22 for theatre index changes                 *
.* V11.02.01 19.05.2022  DA Sarkies     TSK 0919067                           *
.*           Added calls to the read functions to make sure that the key      *
.*           isn't already being used                                         *
.* V11.01.01 27/04/2021  Thanh T        TSK 0895165                           *
.*           Recompiled for OPRARDFD changes                                  *
.* V11.00.01 10/03/2020  Jill Parkinson Task 0879163                          *
.*           Added SEXDSCIO include                                           *
.******************************************************************************
.*       V10.13.02  16/01/2019 Richa Phogat    TSK 0868795                    *
.*                  Added BKRXUDF5 to display Intended LOS entered at the time*
.*                  of Theatre Booking but is not printing on Theatre List    *
.*                  until the patient has been pre-admitted                   *
.*       V10.13.01  02/08/2018 Ebon Clements   TSK 0853101                    *
.*                  Added hospital to theatre comments key - oprcomaf         *
.*       V10.11.02  27/11/2017 Thanh T.        TSK 0821710                    *
.*                  Recompiled as PATMISTD changed                            *
.*       V10.11.01  07/09/2017 Thanh T.        TSK 0821710                    *
.*                  Audit Amission/outpatient visit comments                  *
.******************************************************************************
.*       V10.10.03  30/05/2017 Thanh T.        TSK 0837930                    *
.*                  For Printing report layout 8, prints out all the comment  *
.*                  lines after the 2nd line. Currently it only prints out    *
.*                  the first 2 lines. (HEC)                                  * 
.*       V10.10.02  04/05/2017 Tracey Nguyen   TSK 0835652                    *
.*                  Fixed by operating surgeon report to only print when      *
.*                  there is a session scheduled for the doctor regardless    * 
.*                  whether there is any theatre booking made or not for the  *
.*                  scheduled session                                         *
.*       V10.10.01  01/05/2017 Tracey Nguyen   TSK 0835652                    *
.*                  Removed call to CLOPRSES in PRBS8000 to not blank out the *
.*                  header details when there is no data in the open session  *
.*                  when printing the Daily Operating Room List - by          *
.*                  Operating Surgeon                                         *
.*       V10.08.03  03/10/2016 Ebon Clements   TSK 0824651                    *
.*                  Print blank heading if no sessions found. Added CLOPRSES  *
.*                  at PRBP8000 PRBD8000 PRBT8000 PRBS8000 and PRBC8000       *
.*       V10.08.02  01/09/2016 Ebon Clements   TSK 0824952                    *
.*                  Fixed display of PAC Required - Read booking at SRDS0400  *
.*       V10.08.01  14/04/2016 Ebon Clements   TSK 0313944                    *
.*                  Added fluid time & medical history received to            *
.*                  layout 9 - HEA                                            *
.*       V10.06.04  06/07/2015 Sandra Barcham  CAR 319028                     *
.*                  Fix DOB Printing                                          *
.*       V10.06.03  03/07/2015  Jill Parkinson CAR 318979                     *
.*                  Mods to only ask medical booking question for layout 9    *
.*       V10.06.02  18/06.2015 Peter Vela     CAR 313764                      *
.*                  Added read of BOKRX1 in SRDS3000                          *
.*       V10.06.01  10/06/2015 Ebon Clements  CAR 311911                      *
.*                  Added include medical booking option to layout 9 - HEA    *
.*       V10.05.13  21/01/2015 Ebon Clements  CAR 311390                      *
.*                  Fixed hospital filter for medical bookings - MEDB0000     *
.*       V10.05.12  12/11/2014 Ebon Clements  CAR 306383                      *
.*                  Force new page if sub heading is after line 50 as there   *
.*                  will be not enough lines to print a patient               *
.*       V10.05.11  29/10/2014 Ebon Clements  CAR 306383                      *
.*                  Changed all CLNO checks to 55                             *
.*       V10.05.10  20/10/2014 Ebon Clements  CAR 283332                      *
.*                  Fixed comments print for layout 9                         *
.*       V10.05.09  07/10/2014 Ebon Clements  CAR 283332                      *
.*                  Fixed expected ward display for layout 9 bookings         *
.*       V10.05.08  25/09/2014 Ebon Clements  CAR 304743                      *
.*                  Fixed operation description print on layout 4             *
.*       V10.05.07  23/09/2014 Ebon Clements  CAR 283332                      *
.*                  Fixed spelling of title in layout 9 heading               *
.*                  Fixed display issues on layout 9 heading                  *
.*       V10.05.06  16/09/2014 Jill Parkinson CAR 298930                      *
.*                  Increased CLNO check to 55 not 50 in PRBS000,PRBT000,PRBC00*
.*       V10.05.05  16/09/2014 Jill Parkinson CAR 298930                      *
.*                  Moved checks for CLNO to 50 in PRBS000,PRBT000,PRBC000    *
.*       V10.05.04  02/09/2014 Ebon Clements  CAR 283332                      *
.*                  Added hea layout 9 from layout 8                          *
.*       V10.05.03  05/08/2014 Jill Parkinson CAR 298930                      *
.*                  Added values to CLNO in TOPH000 so headings increase count*
.*       V10.05.02  30/07/2014 Ebon Clements     CAR 283332                   *
.*                  Added functionality to run by a date range                *
.*       V10.05.01  28/07/2014 Ebon Clements     CAR 303451                   *
.*                  Fixed print of description lines for layout 8 - PRDS0000  *
.*       V10.04.02  07/07/2014 Sandra Barcham    CAR 302598                   *
.*                  Allow 80 character descriptions                           *
.*       V10.04.01  23/06/2014   J.Tan           CAR 261630                   *
.*                  Removed port number from temp file name                   *
.*       V10.03.04  26/11/2013  J.Tan         CAR 291790                      *
.*                  Fixed error with 'No Session on this Date'                *
.*                  Mods to define CATACTIV for PATCODTM                      *
.*       V10.03.03  19/11/2013  Ania P        CAR 285291                      *
.*                  Changed Equipment1-3 fields to use 1st 10 characters      *
.*                  of category code description                              *
.*       V10.03.02  18/09/2012  Patrick Adair CAR 271728                      *
.*                  Reduce OPADES1/2/3 to 55 chars before writing             *
.*       V10.03.01  27/04/2012  Saroeun Soeur CAR 263847                      *
.*                  GANA0000 match for empty variable                         *
.*       V10.02.03  22/08/2011  Saroeun Soeur CAR  247788                     *
.*                  fixed display by theatre session PRBT0000                 *
.*       V10.02.02  21/07/2011  Saroeun Soeur CAR  243592                     *
.*                  added functionality to prevent page break on print        *
.*       V10.02.01  29/04/2011  Saroeun Soeur CAR 242276                      *
.*                  added multi hospital filters                              *
.*       V10.00.04  13/08/2010  J.Tan         CAR 227672                      *
.*                  Fixed option one page breaking on surgeon                 *
.*       V10.00.03  05/08/2010  J.Tan         CAR 227672                      *
.*                  Mods to print Operation description line 2 and 3          *
.*       V10.00.02  29/07/2010  J.Tan         CAR 200396                      *
.*                  Fixed printing layout 8                                   *
.*       V10.00.01  05/07/2010  J.Tan         CAR 200396                      *
.*                  Added report layout 8 for Healthscope                     *
.*       V9.12.02   23/07/2009  WeeLee Koo    CAR 187709                      *
.*                  Separated Session/Theatre Title with Report Heading       *
.*                  and edit programs for PRBD0000,PRBT0000,PRBS0000 and      *
.*                  PRBC0000                                                  *
.*       V9.12.01   07/07/2009  Jill Habasque CAR 198528                      *
.*                  Mods to use bkreward if bkrxpowd is blank                 *
.*       V9.09.01   21/08/2007  Peter Vela    CAR 140355                      *
.*                  Added Report Layout 7                                     *
.*                  Added operation details status to clinic temp file and    *
.*                  period temp file                                          *
.*       V9.08.03   23/04/2007  Peter Vela    CAR 136525                      *
.*                  Added functionality for Ward/Bed Indicator @ SRDS0470     *
.*       V9.08.02   20/04/2007  Peter Vela    CAR 136525                      *
.*                  Added read and functionality for Ward/Bed Indicator       *
.*                  (OPCNOP66) @ SRDS0450                                     *
.*       V9.08.01   06/03/2007  Peter Vela    CAR 135352                      *
.*                  Changed index used to OPDEA5 @ RDEA0000                   *
.*       V9.05.01   06/03/2006  Peter Vela    CAR 95558                       *
.*                  Added GANA0000 get anaesthetist/ default anaesthetist     *
.*                  Added functionality to print 10 booking comments lines    *
.*       V9.04.03   22/12/2004  Jill Habasque CAR 55265 and 55907             *
.*                  Mods to print bkrxpowd in post op ward column and fixed   *
.*                  "By Theatre" option to include all patients               *
.*       V9.04.02   16/09/2004  J.Tan   CAR 53534                             *
.*                  Mods to print admitting point under ward from booking file*
.*       V9.04.01   15/09/2004  J.Tan   CAR 53534                             *
.*                  Mods to print admitting point under ward                  *
.*       V9.03.01   17/05/2004  Jill Habasque                                 *
.*                  Mods for multiple theatre bookings                        *
.*       V9.02.06   13/03/2003  Tonii  CAR 37274                              *
.*                  Problem: Total number of sessions for Option5 incorrect   *
.*                  Fix: Mods to only add one to SESSTOTL if a different      *
.*                       session (PRBP0000)                                   *
.*       V9.02.05   12/03/2003  Tonii  CAR 37209                              *
.*                  No. of sessions showing zero when reporting by date range *
.*                  - Mods to add one to SESSTOTL when a valid session record *
.*                    is read                                                 *
.*       V9.02.04   14/02/2003  Tonii  SRS No: 36667                          *
.*                  Mods to use new tables if a record exists in oprsrgaf     *
.*       V9.02.03   15/08/2002 Ebon Clements SRF 19612                        *
.*                  Fixed display of bed details for pre-admissions           *
.*       V9.02.02   09/08/2002 Ebon Clements SRF 19612                        *
.*                  Changed the report to display the bookings operation      *
.*                  description if the surgical details description is blank  *
.*                  Changes the report to display the pre-admissions ward/bed *
.*                  if the patient is pre-admitted                            *
.*       V9.02.01   29/07/2002 Ebon Clements SRF 19612                        *
.*                  Added Admission time and date of birth to report number 4 *
.*       V9.01.01   10/08/2001  Dean Cramer                                   *
.*                  Fixed keyin display error for Theatre range.              *
.******************************************************************************
.*       V5.08.01   23/08/2000  Caleb Sharman                                 *
.*                  Changed Health Fund table variables to 8 chars            *
.*       V5.08.B01  11/01/2000  J Habasque SRF 636529                         *
.*                  Fixed printing of report when a new period begins         *
.*       V5.07.03   28/05/1999  Jill Habasque                                 *
.*                  Fixed display after error message, added test for starting*
.*                  and ending period                                         *
.*       V5.07.02   30/04/1999    Jim Stathopoulos                            *
.*                  Display Modification                                      *
.*       V5.07.01   25/02/1999  Jill Habasque                                 *
.*                  Added test for active/inactive theatre codes              *
.*       V5.07.B02  21/01/1999  Nicole Harrington 507 rebound 091             *
.*                  Mods to print century on reports                          *
.*       V5.07.00   28/10/1998    Jim Stathopoulos                            *
.*                  507 Changes                                               *
.******************************************************************************
.*                  07/02/91  ROD                                             *
.*                    Changed "Theatre" & "Clinic" to sys parameters          *
.*                    OPCNODSC & OPCNCDSC respectively                        *
.*        V5.01.02  06/05/1991    Justin Coates  SRF 108546                   *
.*                  Clear doctor/anaesth codes if none set up and treat       *
.*                  this as a valid selection                                 *
.*        V5.01.03  06/05/1991    Justin Coates                               *
.*                  Made by OPCNCLSU option available always                  *
.*        V5.01.04  07/05/1991    Graeme Williams                             *
.*                  Changed theatre option to check theatre code for          *
.*                  the booking before the theatre code for the session       *
.*        V5.01.05  09/05/1991    Graeme Williams                             *
.*                  Added report layout 4 for Southland                       *
.*        V5.01.06  13/05/1991    Graeme Williams                             *
.*                  Ward will default to ward on booking record               *
.*        V5.01.07  25/07/91   ROD                                            *
.*                  Recompiled for OPRSESFD.INC                               *
.*        V5.01.08  27/12/1991    Justin Coates  (Modbury Changes)            *
.*                  Added Report Layout 5                                     *
.*        V5.01.09  30/10/92      Graeme Williams          Quote 7468         *
.*                  Added new report layout 6 for St Andrews Ipswich          *
.*                  Print age in months if <1 year old, and days if <1 month  *
.*        V5.01.10  02/02/93 J.Tan   SRF 120243                               *
.*                  Mods to allow backdate                                    *
.*        V5.01.11  07/12/93 Rob Leonard  SRF 600702                          *
.*                  Fix non printing of Start/End times and Overtime/Delay    *
.*                  codes on reports                                          *
.*        V5.01.12  24/05/1995  Matt Surridge                                 *
.*                  Fixed bugs for global recompile.                          *
.*        V5.01.13  22/07/1994  Rob Leonard  SRF 130787                       *
.*                  Fixed report showing Admit time of prev patient if no adm *
.*        V5.01.14  05/08/1994  Rob Leonard                                   *
.*                  Fixed report showing erreneous data in header for surgeon *
.*        V5.02.01  01/05/1995  Graeme Williams   SRF 136262                  *
.*                  Allow for possibility that the bed will be on bokrc1af    *
.*        V5.03.01  10/08/1995  ROD               SRF 640611                  *
.*                  Print "Anaesthetist" if OPCNSESS<>1  (Layout 5)           *
.*        V5.04.01  26/06/1997  Howellsy         505                          *
.*                  Use PATDOCKY instead of PATDOCDS                          *
.******************************************************************************
.
          INC       STD001FD
          INC       IBASEQFD/INC            * Sequential Numbers File
          INC       TFILEVAR/INC            * Generate Temp File Name
          INC       WEBERRFD/INC            * Web Server Error Logging
.
          INC       BOKDIAFD/INC
          INC       BOKRC1FD/INC
          INC       BOKRX1FD/INC
          INC       OPRCLIFD/INC 
          INC       OPRCONFD/INC
          INC       OPRARDFD/INC
          INC       OPRCOMFD/INC
          INC       OPRDEAFD/INC
          INC       OPRDEBFD/INC
          INC       OPRDEDFD/INC
          INC       OPROPRFD/INC
          INC       OPRORUFD/INC
          INC       OPRSESFD/INC
          INC       OPRSRGFD/INC
          INC       OPRTSMFD/INC
          INC       PATCALAG/INC
          INC       VISMDTFD/INC
          INC       VISMTXFD/INC
          INC       PATMISTD/INC
          INC       PATCODFD/INC
          INC       MLTCODFD/INC
          INC       PATCONFD/INC
          INC       PATDO1FD/INC
          INC       PATMA1FD/INC
          INC       PATMI1FD/INC
          INC       PATWR1FD/INC
          INC       PATPR1FD/INC
          INC       PATTRNFD/INC
          INC       PMSPX2FD/INC
          INC       PMSTLEFD/INC
          INC       PMSVX1FD/INC
          INC       PATHSPFD/INC
          INC       PATDHEAD/INC
          INC       WEBSECFD/INC
.
.***********************************************************************
.*                          VARIABLES                                  *
.***********************************************************************
.
ADMNWORK  DIM       3
ANAEFLAG  FORM      1
ANAEDESC  DIM       20
ANAEDES1  DIM       12
IANAETHS  DIM       25
ANAETHCD  DIM       6
ANAETHST  DIM       25
ADMNDATE  DIM       10
ASSSURG   DIM       25
ASSSURG2  DIM       25
ASSURGCD  DIM       6
ASSURGC2  DIM       6
ANAETWOD  DIM       40
.
BY        INIT      "- By "
.
CATACTIV  FORM      "0"
COMNFLAG  FORM      1
CASETOTL  FORM      5
CATEGORY  DIM       2
CATEGOR1  DIM       20
CATA      INIT      "A "
CATOA     INIT      "OA"
CATOP     INIT      "OP"
CATOR     INIT      "OR"
CATOY     INIT      "OY"
CATST     INIT      "ST"
CATY9     INIT      "Y9"
CHG       DIM       1
CJDAY     FORM      3
BJDAY     FORM      3
CMDLINE   DIM       70
CODE      DIM       3
CODE1     DIM       2
CONSFORM  DIM       3
COUNTER   FORM      1
COUNTER2  FORM      1
COMMCNTR  FORM      2
COMLINE1  DIM       70
COMLINE2  DIM       70
.
DAYDESC   DIM       9
DCODE1    DIM       6
DCODE2    DIM       6
DAGE      DIM       3
DATEOFOP  DATE      8
DATRANTO  DATE      8
DEFAULTF  FORM      1
DIM3      DIM       3
DIM6      DIM       6
DIM10     DIM       10  
DIM16     DIM       16
DIM127    DIM       127
DIM18     DIM       18
DIM30     DIM       30
DIM30A    DIM       30
DIM30B    DIM       30
DIM30C    DIM       30
DIM66A    DIM       66
DIM66B    DIM       66
DIM66C    DIM       66
DIM90     DIM       90
DISPLDOB  DIM       10
DOCFNAME  DIM       19
DOCTOR    DIM       6
DOCCODE   DIM       6
INCLMEDB  DIM       1
PAGBREAK  DIM       1
PACREQYN  DIM       3
PACATTYN  DIM       3
PRNTCOM1  DIM       19
PRNTCOM2  DIM       19 
PRNTDES1  DIM       26
PRNTDES2  DIM       26
PRNTTIME  DIM       5
PRNTNAME  DIM       20
PRNTWARD  DIM       7
.
ECODE     DIM       6
ECLIN     DIM       6
ECLIDESC  DIM       40
EMPTYSES  FORM      1       
ENDPERI   DIM       25
EPERIOD   DIM       3
EPERDESC  DIM       20
ESURG     DIM       6
ESURDESC  DIM       40
ETHET     DIM       6
ETHEDESC  DIM       40
EQUAL50   INIT      "=================================================="
EQUAL32   INIT      "================================"
.
FASTTIME  DIM       5
FLUDTIME  DIM       5
FORM3     FORM      3
FLDFLAG   FORM      2
FULLCOMM  DIM       140
FULLDIAG  DIM       80
.
HTMLFILE  FIFO      ASCII, FIXED=250
IBCNMHOS  FORM      1
.
LANAETHS  DIM       40
LSURGEON  DIM       40
LINENUM   FORM      2
LOOPCNTR  FORM      1
. 
MEDICHST  DIM       3
.
NAME25    DIM       25
NAME40    DIM       40
NEGONE    FORM      "-1"
NORECFLG  FORM      1
.
OLDPERI   DIM       3
OLDROOM   DIM       6
OLDTIME   DIM       5
OLDCLIN   DIM       6
OLDANAE   DIM       6
OLDASST   DIM       6
OLDSURG   DIM       6
OPERTYPE  DIM       20
POSTOP    DIM       24
POSTOPWB  DIM       7
PRTFLAG   FORM      1
.
QUOTE     INIT      "#""
.
REP8DESC  DIM       242
REP8DES1  DIM       55
REP8DES2  DIM       55
REP8DES3  DIM       55
REP8DES4  DIM       55
REP8DES5  DIM       55
ROW       FORM      2
.
SAV8DESC  DIM       242
SAVPCOMM  DIM       140
SAVEDIAG  DIM       80
SAVLNGTH  FORM      3
SCODE     DIM       6
SCLIN     DIM       6
SCLIDESC  DIM       40
SESSCLIN  DIM       40
SESSCORD  DIM       40
SESSTOTL  FORM      5
SKEY22    DIM       22
SKEY26    DIM       26
SP18      DIM       18
SP55      INIT      "                                                       "
SSURG     DIM       6
SSURDESC  DIM       40
SPERIOD   DIM       3
SPERDESC  DIM       20
STARTPER  DIM       25 
STHET     DIM       6
STHEDESC  DIM       40
SURGEON   DIM       25
ISURGEON  DIM       25
SURGNCD   DIM       6
.
TIME      DIM       5
ADMNTIME  DIM       5
TODAY     DIM       8
TOTALBOK  FORM      5
TOTLNGTH  FORM      3
TRANTYPE  DIM       20
TYPE      DIM       3 
.
VCHFLAG   FORM      1
WARDBED   DIM       7
XEDESC    DIM       15
.
REPDATE   DIM       10
.
TEMPTHET  DIM       8
TEMPSURG  DIM       8
TEMPCLIN  DIM       8
TEMPPERI  DIM       8
.
HOSNAME   DIM       50
HOSCODE   DIM       3
.
TCOMLINE  DIM       132
NEWTCOMM  DIM       200
COMFSTLN  FORM      1
TEMPFLD   DIM       70
TEMPFLD1  DIM       70
TEMPFLD2  DIM       70
TEMPFLD3  DIM       70
.
.
.-------------------------------< CONSTANTS >---------------------------------
.
MONDAY    INIT      "Monday"
TUESDAY   INIT      "Tuesday"
WEDNSDAY  INIT      "Wednesday"
THURSDAY  INIT      "Thursday"
FRIDAY    INIT      "Friday"
SATURDAY  INIT      "Saturday"
SUNDAY    INIT      "Sunday"
.
.
.**** REPORT BY THEATRE TEMP FILE *****
.
TMPTHET1  IFILE     SQL, FIXED=31, KEY="u1-6,7-11,12-17,18-20,21-30"
.
.Name     Type     Size    Physical   Start       Description
.----     ----     ----    --------   -----       -----------
THETROOM  DIM       6         6         1         Operating room code
THETTIME  DIM       5         5         7         Session Start time
THETCLIN  DIM       6         6         12        Session Surgeon/Clinic
THETCASE  DIM       3         3         18        Case Number
THETUNIQ  DIM       10        10        21        Unique Number
.
. End of record                         31
.
.**** REPORT BY SURGEON TEMP FILE *****
.
TMPSURG1  IFILE     SQL, FIXED=30, KEY="u1-6,7-11,12-17,18-20,21-28"
.
.Name     Type     Size    Physical   Start       Description
.----     ----     ----    --------   -----       -----------
SURGCODE  DIM       6         6         1         Operating surgeon  
SURGTIME  DIM       5         5         7         Session Start time
SURGCLIN  DIM       6         6         12        Session Surgeon/Clinic
SURGCASE  DIM       3         3         18        Case Number
SURGADMN  DIM       8         8         21        Patient Addmission No.
SURGSTAT  DIM       1         1         29        Status
.
. End of record                         30
.
.**** REPORT BY CLINIC FILE ****
.
TMPCLIN1  IFILE     SQL, FIXED=24, KEY="u1-6,7-11,12-14,15-22"         
.
.Name     Type     Size    Physical   Start       Description
.----     ----     ----    --------   -----       -----------
CLINCODE  DIM       6         6         1         Operating surgeon  
CLINTIME  DIM       5         5         7         Session Start time
CLINCASE  DIM       3         3         12        Case Number
CLINADMN  DIM       8         8         15        Patient Addmission No.
CLINSTAT  DIM       1         1         23        Status
.
. End of record                         24
.
.****  REPORT BY PERIOD/THEATRE/SESSION ****
.
TMPPERI1  IFILE     SQL, FIXED=25, KEY="u1-3,4-9,10-14,15-20,21-23"
.
.Name     Type     Size    Physical   Start       Description
.----     ----     ----    --------   -----       -----------
PERICODE  DIM       3        3         1          Period code
PERITHET  DIM       6        6         4          Theatre
PERITIME  DIM       5        5         10         Session start time
PERICLIN  DIM       6        6         15         Clinic
PERICASE  DIM       3        3         21         Case Number
PERISTAT  DIM       1        1         24         Status
.
.                                      25
.
.-----------------------------------------------------------------------
PRGID     INIT      "IBAOPR66"
PRGNAM    INIT      "Daily Operating Room List"
VERSION   INIT      "V12.00.03"
.-----------------------------------------------------------------------
.
.**********************************************************************
.*                            MAIN LINE                               *
.**********************************************************************
ML0000    CALL      INIT0000            
.
ML0100    CALL      OPTN0000                * Get the option
          BRANCH    EXIT,ML9999             * exit?
          BRANCH    MOPTION,ML1000,ML2000,ML3000,ML4000,ML5000
.
.*****  By Date/Time *****
.
ML1000    CALL      SCRN0000             * display the screen
          CALL      KDOO0000             * Keyin date of operation
          BRANCH    EXIT,ML9999
.
          MOVE      ZERO,EXIT
          CALL      KHOS0000            * keyin hospital
          BRANCH    EXIT,ML1000
.
          CALL      PGBR0000          
          CALL      IMED0000            * Print medical booking on payout 9
.
          CALL      CONTQST
          BRANCH    CEXIT,ML1100,ML1000,ML0100
          GOTO      ML0100
.
ML1100    CALL      PRBD0000            * print the report by date
          CALL      KILL0000
.
          CALL      MEDB0000            * Print medical bookings
.
          CALL      RANG0000            * Check if running a date range
          BRANCH    EXIT,ML0100
.
          GOTO      ML1100
.
.***** By Theatre *****
.
ML2000    CALL      SCRN0000             * display the screen
          CALL      KDOO0000             * Keyin date of operation
          BRANCH    EXIT,ML9999
.
          CALL      KSTH0000             * keyin starting theatre
          CALL      KETH0000             * keyin ending theatre
.
          MOVE      ZERO,EXIT
          CALL      KHOS0000            * keyin hospital
          BRANCH    EXIT,ML1000
.          
          CALL      PGBR0000
          CALL      IMED0000            * Print medical booking on payout 9
.
          CALL      CONTQST
          BRANCH    CEXIT,ML2100,ML2000,ML0100
          GOTO      ML0100
.
ML2100    CALL      CRTF0000             * create the temp file
          CALL      WTTH0000             * write the temp theatre file 
          CALL      PRBT0000             * print the report by theatre
          CALL      KILL0000
.
          CALL      MEDB0000            * Print medical bookings
.
          CALL      RANG0000            * Check if running a date range
          BRANCH    EXIT,ML0100
.
          GOTO      ML2100
.
.***** By Operating Surgeon *****
.
ML3000    CALL      SCRN0000             * display the screen
          CALL      KDOO0000             * Keyin date of operation
          BRANCH    EXIT,ML9999
.
          CALL      KSSU0000             * Keyin start surgeon
          CALL      KESU0000             * Keyin ending surgeon
.
          MOVE      ZERO,EXIT
          CALL      KHOS0000            * keyin hospital
          BRANCH    EXIT,ML1000
.
          CALL      PGBR0000
          CALL      IMED0000            * Print medical booking on payout 9
.
          CALL      CONTQST
          BRANCH    CEXIT,ML3100,ML3000,ML0100
          GOTO      ML0100
.
ML3100    CALL      CRTF0000             * create the temp file
          CALL      WTSU0000             * write the temp surgeon file
          CALL      PRBS0000             * print report by surgeon
          CALL      KILL0000
.
          CALL      MEDB0000            * Print medical bookings
.
          CALL      RANG0000            * Check if running a date range
          BRANCH    EXIT,ML0100
.
          GOTO      ML3100
.
.***** By Surgeon/Clinic *****
.
ML4000    CALL      SCRN0000             * display the screen
          CALL      KDOO0000             * Keyin date of operation
          BRANCH    EXIT,ML9999
.
          CALL      KSCL0000             * keyin starting clinic
          CALL      KECL0000             * keyin ending clinic
.
          MOVE      ZERO,EXIT
          CALL      KHOS0000            * keyin hospital
          BRANCH    EXIT,ML1000
.
          CALL      PGBR0000
          CALL      IMED0000            * Print medical booking on payout 9
.
          CALL      CONTQST
          BRANCH    CEXIT,ML4100,ML4000,ML0100
          GOTO      ML0100
.
ML4100    CALL      CRTF0000             * create the temp file
          CALL      WTCL0000             * write the temp clinic file
          CALL      PRBC0000             * print report by clinic
          CALL      KILL0000
.
          CALL      MEDB0000            * Print medical bookings
.
          CALL      RANG0000            * Check if running a date range
          BRANCH    EXIT,ML0100
.
          GOTO      ML4100
.
.****** By Period/Theatre/session *****
.
ML5000    CALL      SCRN0000             * display the screen
          CALL      KDOO0000             * Keyin date of operation
          BRANCH    EXIT,ML9999
          
          CALL      PERI0000             * Keyin the period
.
          MOVE      ZERO,EXIT
          CALL      KHOS0000            * keyin hospital
          BRANCH    EXIT,ML1000
.
          CALL      PGBR0000
          CALL      IMED0000            * Print medical booking on payout 9
.
          CALL      CONTQST
          BRANCH    CEXIT,ML5100,ML5000,ML0100
          GOTO      ML0100
.
ML5100    CALL      CRTF0000             * create the temp file
          CALL      WTPE0000             * write the data to the temp file
          CALL      PRBP0000             * Print report by Period
          CALL      KILL0000
.
          CALL      MEDB0000            * Print medical bookings
.
          CALL      RANG0000            * Check if running a date range
          BRANCH    EXIT,ML0100
.
          GOTO      ML5100
.
ML9999    CHAIN     PGM
.
.**********************************************************************
.*                             INIT0000                                *
.*           Display head, open file and read control file             *
.***********************************************************************
.
INIT0000  MOVE      ONE,CNOUNDLN
          MOVE      ONE,CNEWDS
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,TEMPTHET
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,TEMPSURG
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,TEMPCLIN
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,TEMPPERI
.
          CALL      DISPHEAD
.
.
INIT1000  DISPLAY   *P50:24,"oproruaf"
          OPEN      OPRORUA1,"oproruaf"
.
          DISPLAY   *P50:24,"vismdtaf";
          OPEN      VISMDTA1,"vismdtaf"
          DISPLAY   *P50:24,"vismtxaf";
          OPEN      VISMTXA1,"vismtxaf"
.
          DISPLAY   *P50:24,"patdo1af"
          OPEN      PATDO1A1,"patdo1af"
          OPEN      PATDO1A2,"patdo1af"
.
          DISPLAY   *P50:24,"opropraf"
          OPEN      OPROPRA1,"opropraf"
          OPEN      OPROPRA2,"opropraf"
.
          DISPLAY   *P50:24,"patcodes"
          OPEN      PATCODE1,"patcodes"
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
          ENDIF
.
          DISPLAY   *P50:24,"oprcliaf"
          OPEN      OPRCLIA1,"oprcliaf"
          OPEN      OPRCLIA2,"oprcliaf"
.
          DISPLAY   *P50:24,"oprsesaf"
          OPEN      OPRSESA1,"oprsesaf"
          OPEN      OPRSESA2,"oprsesaf"
          OPEN      OPRSESA7,"oprsesaf"
.
          DISPLAY   *P50:24,"oprardaf"
          OPEN      OPRARDA1,"oprardaf"
.
          DISPLAY   *P50:24,"oprdetaf"
          OPEN      OPRDETA1,"oprdetaf"
          OPEN      OPRDETA2,"oprdetaf"
          OPEN      OPRDETA3,"oprdetaf"
          OPEN      OPRDETA5,"oprdetaf"
          OPEN      OPRDETA6,"oprdetaf"
.
          DISPLAY   *P50:24,"oprdetbf"
          OPEN      OPRDETB1,"oprdetbf"
.
          DISPLAY   *P50:24,"oprdedaf"
          OPEN      OPRDEDA1,"oprdedaf"
.
          DISPLAY   *P50:24,"oprsrgaf"
          OPEN      OPRSRGA1,"oprsrgaf"
.
          DISPLAY   *P50:24,"oprtsmaf"
          OPEN      OPRTSMA1,"oprtsmaf"
.
          DISPLAY   *P50:24,"oprcomaf"
          OPEN      OPRCOMA1,"oprcomaf"
.
          DISPLAY   *P50:24,"patpramf"
          OPEN      PATPR1A1,"patpr1af"
          OPEN      PATPX1A1,"patpx1af"
.
          DISPLAY   *P50:24,"patma1af"
          OPEN      PATMA1A1,"patma1af"
.
          DISPLAY   *P50:24,"patmx1af"
          OPEN      PATMX1A1,"patmx1af"
.
          DISPLAY   *P50:24,"pmspx2af"
          OPEN      PMSPX2A1,"pmspx2af"
.
          DISPLAY   *P50:24,"pmstleaf"
          OPEN      PMSTLEA1,"pmstleaf"
.
          DISPLAY   *P50:24,"patmi1af"
          OPEN      PATMI1A1,"patmi1af"
.
          DISPLAY   *P50:24,"patwr1af"
          OPEN      PATWR1A1,"patwr1af"
.
          DISPLAY   *P50:24,"pmsvx1af"
          OPEN      PMSVX1A1,"pmsvx1af"
.
          DISPLAY   *P50:24,"pattranf"
          OPEN      PATTRAN2,"pattranf"
.
          DISPLAY   *P50:24,"bokrc1af"
          OPEN      BOKRC1A1,"bokrc1af"
          OPEN      BOKRC1A4,"bokrc1af"
.
          DISPLAY   *P50:24,"bokrx1af"
          OPEN      BOKRX1A1,"bokrx1af"
.
          DISPLAY   *P50:24,"bokdiaaf"
          OPEN      BOKDIAA1,"bokdiaaf"
.
          DISPLAY   *P50:24,"websecaf"
          OPEN      WEBSECA1,"websecaf"
.
          DISPLAY   *P50:24,"controlf"
          OPEN      CONTROLF,"controlf"
.
          READ      CONTROLF,FORTY;*81,OPCNODSC,*96,OPCNCDSC:
                             *111,OPCNCLSU,*114,OPCNSESS
          READ      CONTROLF,FORTY2;*56,OPCNR66A,*71,OPCNUSAN,OPCNDSAN:
                                    *247,OPCNOP66
          READ      CONTROLF,FIFTY9;*27,CPERMTH
          READ      CONTROLF,SIXTY8;*1,OPCNDPR1,OPCNDPR2,OPCNDPR3:
                             OPCNDPR4,OPCNDPR5:
                             *163,OPCNDPS1,OPCNDPS2,OPCNDPS3,OPCNDPS4
          READ      CONTROLF,ZERO;*43,IBCNMHOS
.
INIT9999  RETURN
.
.********************************************************************
.*                        TODY0000                                  *
.*                 Format todays date                               *
.********************************************************************
TODY0000  CALL      IBACLOCK
          PACK      TODAY,CCC,CYY,CMM,CDD
          REP       " 0",TODAY 
TODY9999  RETURN
.
.**********************************************************************
.*                        KDOO0000                                    *
.*              Get date of operation                                 *
.**********************************************************************
KDOO0000  MOVE      ZERO,EXIT
          CALL      TODY0000
.
          UNPACK    TODAY,CCENT,CYEAR,CMON,CDAY
.
          MOVE      "32",CCOL
          MOVE      FOUR,CVERT
          MOVE      ONE,CCENTRY
          MOVE      ZERO,CHIGHLT
          MOVE      ONE,CCANLDTE
.
          CALL      KEYDATE
          BRANCH    CQUEST,KDOO9000
.
          MATCH     SP2,CDAY
          GOTO      KDOO9500 IF EQUAL
.
          PACK      DATEOFOP,CCENT,CYEAR,CMON,CDAY
          REP       " 0",DATEOFOP
.
          CALL      PACDATE
          MOVE      CPCDATE,REPDATE         * Report date for heading
.
          MOVE      "48",CCOL
          MOVE      FOUR,CVERT
          MOVE      ONE,CCENTRY
          MOVE      ZERO,CHIGHLT
          MOVE      ONE,CCANLDTE
.
          CALL      KEYDATE
          BRANCH    CQUEST,KDOO9000
.
          MATCH     SP2,CDAY
          GOTO      KDOO9500 IF EQUAL
.
          PACK      DATRANTO,CCENT,CYEAR,CMON,CDAY
          REP       " 0",DATRANTO
.
          MATCH      DATEOFOP,DATRANTO
          GOTO       KDOO9999 IF NOT LESS
.
          DISPLAY    *P1:24,*EL,*B,"2nd Range Must Be Greater Than 1st ":
                     "Range - Hit <",*V2LON,"ENTER",*HOFF,"> To Continue ";
          KEYIN      ANS;
          DISPLAY    *P1:24,*EL;
          GOTO       KDOO0000
.
KDOO9000  BEEP
          GOTO      KDOO0000
.
KDOO9500  MOVE      ONE,EXIT
          GOTO      KDOO9999
.
KDOO9999  RETURN
.
.**********************************************************************
.*                        RANG0000                                    *
.* Check if running a date range. New date starts on a new page       *
.**********************************************************************
RANG0000  MATCH     DATEOFOP,DATRANTO   * Check if to date printed
          GOTO      RANG9000 IF EQUAL
.
          ADD       ONE,DATEOFOP        * Add one day to date and
          UNPACK    DATEOFOP,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          MOVE      CPCDATE,REPDATE     * Set report date for heading
.
RANG8000  MOVE      ZERO,EXIT           * Yes another day to print
          GOTO      RANG9999
.
RANG9000  MOVE      ONE,EXIT            * End date reached report finished
          GOTO      RANG9999
.
RANG9999  RETURN
.
.**********************************************************************
.*                         KSTH0000                                   *
.*                  Keyin the starting theatre                        *
.**********************************************************************
KSTH0000  KEYIN     *P32:6,*DV,UNDLN6:
                    *P32:6,*V2LON,STHET:
                    *P32:6,*DV,STHET
.
          PACK      STHET,STHET,SP6
          MATCH     SP6,STHET
          GOTO      KSTH1000 IF NOT EQUAL
          MOVE      "Start ",STHET
          DISPLAY   *P32:6,*V2LON,STHET
          CLEAR     STHEDESC
          GOTO      KSTH9999
.
KSTH1000  MATCH     QUEST,STHET
          GOTO      KSTH5000 IF EQUAL
.
          PACK      KEY6,STHET,SP6
          CALL      RDOPOPR1
          BRANCH    OVRCD,KSTH4000
.
          COMPARE   ONE,OPRMSTAT                  * active/inactive code
          IF        @EQUAL
            DISPLAY   *P1:24,*EL,*V2LON,"Inactive code ",*HOFF;
            CALL      HITENTER
            GOTO      KSTH0000
          ENDIF
.
          MOVE      OPRMDESC,STHEDESC
          DISPLAY   *P40:6,*EL,STHEDESC
          GOTO      KSTH9999
.
KSTH4000  BEEP
          DISPLAY  *P1:24,*EL,"Code is not on file. ";
          CALL     HITENTER
          GOTO     KSTH0000
.
.***** handle ? on operating room *******
.
KSTH5000  CALL      OPROPRDS
.
KSTH6000  DISPLAY   *P1:24,*EL,"Starting ",OPCNODSC," : "
          KEYIN     *P28:24,*DV,UNDLN6:
                    *P28:24,*V2LON,STHET:
                    *P28:24,*DV,STHET
.
          PACK      STHET,STHET,SP6
          MATCH     SP6,STHET
          GOTO      KSTH7000 IF NOT EQUAL
          MOVE      "Start ",STHET
          CLEAR     STHEDESC
          GOTO      KSTH8000
KSTH7000
          MATCH     QUEST,STHET
          GOTO      KSTH5000 IF EQUAL
.
          PACK      KEY6,STHET,SP6
          CALL      RDOPOPR1
          BRANCH    OVRCD,KSTH7500
.
          COMPARE   ONE,OPRMSTAT                * active/inactive
          IF        @EQUAL
            DISPLAY   *P1:24,*EL,*V2LON,"Inactive Code ",*HOFF;
            CALL      HITENTER
            GOTO      KSTH6000
          ENDIF
.
          MOVE      OPRMDESC,STHEDESC
          GOTO      KSTH8000
.
KSTH7500
          BEEP
          DISPLAY   *P1:24,*EL,"Code is not on file. ";
          CALL      HITENTER
          GOTO      KSTH6000
KSTH8000  
          CALL      SCRN0000
          DISPLAY   *P32:4,*V2LON,REPDATE:
                    *P32:6,*V2LON,STHET,*HOFF:
                    *P40:6,*EL,STHEDESC
KSTH9999  RETURN
.
.**********************************************************************
.*                         KETH0000                                   *
.*                  Keyin the ending theatre                          *
.**********************************************************************
.
KETH0000
          DISPLAY   *P32:8,*EL
          KEYIN     *P32:8,*DV,UNDLN6:
                    *P32:8,*V2LON,ETHET:
                    *P32:8,*DV,ETHET
.
          PACK      ETHET,ETHET,SP6
          MATCH     SP6,ETHET
          GOTO      KETH1000 IF NOT EQUAL
          MOVE      "Finish",ETHET
          DISPLAY   *P32:8,*V2LON,ETHET 
          CLEAR     ETHEDESC
          GOTO      KETH9999
.
KETH1000
          MATCH     QUEST,ETHET
          GOTO      KETH5000 IF EQUAL
.
          PACK      KEY6,ETHET,SP6
          CALL      RDOPOPR1
          BRANCH    OVRCD,KETH4000
.
          COMPARE   ONE,OPRMSTAT               * active/inactive codes
          IF        @EQUAL
            DISPLAY   *P1:24,*EL,*V2LON,"Inactive Code ",*HOFF;
            CALL      HITENTER
            GOTO      KETH0000
          ENDIF
.
          MOVE      OPRMDESC,ETHEDESC
          DISPLAY   *P40:8,*EL,ETHEDESC
.
.**** test that end code >= start code ****
.
          MATCH     "Start ",STHET
          GOTO      KETH9999 IF EQUAL
.
          MATCH     ETHET,STHET
          GOTO      KETH9999 IF LESS
          GOTO      KETH9999 IF EQUAL
          BEEP
          DISPLAY   *P1:24,*EL,"Starting code must be > or = ending code. ";
          CALL      HITENTER
          
          GOTO      KETH0000
.
KETH4000
          BEEP
          DISPLAY  *P1:24,*EL,"Code is not on file. ";
          CALL     HITENTER
          GOTO     KETH0000
.
.***** handle ? on operating room *******
.
KETH5000
          CALL      OPROPRDS
.
KETH6000
          DISPLAY   *P1:24,*EL,"Starting ",OPCNODSC," : "
          KEYIN     *P28:24,*DV,UNDLN6:
                    *P28:24,*V2LON,ETHET:
                    *P28:24,*DV,ETHET
.
          PACK      ETHET,ETHET,SP6
          MATCH     SP6,ETHET
          GOTO      KETH7000 IF NOT EQUAL
          MOVE      "Finish",ETHET
          CLEAR     ETHEDESC
          GOTO      KETH8000
KETH7000
          MATCH     QUEST,ETHET
          GOTO      KETH5000 IF EQUAL
.
          PACK      KEY6,ETHET,SP6
          CALL      RDOPOPR1
          BRANCH    OVRCD,KETH7500
.
          COMPARE   ONE,OPRMSTAT              * active/inactive
          IF        @EQUAL
            DISPLAY   *P1:24,*EL,*V2LON,"Inactive Code ",*HOFF;
            CALL      HITENTER
            GOTO      KETH6000
          ENDIF
.
          MOVE      OPRMDESC,ETHEDESC
.
.**** test that end code >= start code ****
.
          MATCH     "Start ",STHET
          GOTO      KETH8000 IF EQUAL
.
          MATCH     ETHET,STHET
          GOTO      KETH8000 IF LESS
          GOTO      KETH8000 IF EQUAL
          BEEP
          DISPLAY   *P1:24,*EL,"Starting code must be > or = ending code. ";
          CALL      HITENTER
          
          GOTO      KETH6000
.
KETH7500
          BEEP
          DISPLAY   *P1:24,*EL,"Code is not on file. ";
          CALL      HITENTER
          GOTO      KETH6000
KETH8000  
          CALL      SCRN0000
          DISPLAY   *P32:4,*V2LON,REPDATE:
                    *P32:6,STHET,*HOFF:
                    *P40:6,STHEDESC:
                    *P32:8,*V2LON,ETHET,*HOFF:
                    *P40:8,*EL,ETHEDESC
KETH9999  RETURN
.
.**********************************************************************
.*                         KSSU0000                                   *
.*                  Keyin the starting Surgeon                        *
.**********************************************************************
.
KSSU0000  MOVE      SP10,SSURG
          MOVE      "32",ECOL
          MOVE      "06",EVERT
          MOVE      ZERO,CKYIMAND
          MOVE      SP6,CKYIDEF6
          CALL      PATDOCKY
          BRANCH    EXIT,KSSU0500,KSSU0000
.
          MOVE      DCODE,SSURG
          GOTO      KSSU1000
.
KSSU0500  MOVE      "Start ",SSURG
          DISPLAY   *P32:6,*V2LON,SSURG
          CLEAR     SSURDESC
          GOTO      KSSU9999
.
KSSU1000  PACK      KEY6,SSURG,SP6
          CALL      FDOC0000             * Format doctors name
.
          MOVE      PACFNAME,SSURDESC
          DISPLAY   *P32:6,*EL,*V2LON,SSURG:
                    *P40:6,*HOFF,SSURDESC
          GOTO      KSSU9999
.
KSSU4000
          BEEP
          DISPLAY  *P1:24,*EL,"Code is not on file. ";
          CALL     HITENTER
          GOTO     KSSU0000
.
KSSU9999  RETURN
.
.
.**********************************************************************
.*                         KESU0000                                   *
.*                  Keyin the ending surgeon                          *
.**********************************************************************
KESU0000  MOVE      SP10,ESURG
          MOVE      "32",ECOL
          MOVE      "08",EVERT
          MOVE      ZERO,CKYIMAND
          MOVE      SP6,CKYIDEF6
          CALL      PATDOCKY
          BRANCH    EXIT,KESU0500,KESU0000
.
          MOVE      DCODE,ESURG
          GOTO      KESU1000
.
KESU0500  MOVE      "Finish",ESURG
          DISPLAY   *P32:8,*V2LON,ESURG
          CLEAR     ESURDESC
          GOTO      KESU9999
.
KESU1000  PACK      KEY6,ESURG,SP6
          CALL      FDOC0000
          MOVE      PACFNAME,ESURDESC
          DISPLAY   *P32:8,*EL,*V2LON,ESURG:
                    *P40:8,*HOFF,ESURDESC
.
.**** test that end code >= start code ****
.
          MATCH     "Start",SSURG
          GOTO      KESU9999 IF EQUAL
.
          MATCH     ESURG,SSURG
          GOTO      KESU9999 IF LESS
          GOTO      KESU9999 IF EQUAL
          BEEP
          DISPLAY   *P1:24,*EL,"Starting code must be > or = ending code. ";
          CALL      HITENTER
          DISPLAY   *P40:8,SP30   
          
          GOTO      KESU0000
.
KESU9999  RETURN
.
.
.**********************************************************************
.*                         KSCL0000                                   *
.*                  Keyin the starting Clinic                         *
.**********************************************************************
.
KSCL0000
          KEYIN     *P32:6,*DV,UNDLN6:
                    *P32:6,*V2LON,SCLIN:
                    *P32:6,*DV,SCLIN
.
          PACK      SCLIN,SCLIN,SP6
          MATCH     SP6,SCLIN
          GOTO      KSCL1000 IF NOT EQUAL
.
KSCL0500  MOVE      "Start ",SCLIN
          DISPLAY   *P32:6,*V2LON,SCLIN
          CLEAR     SCLIDESC
          GOTO      KSCL9999
.
KSCL1000
          MATCH     QUEST,SCLIN
          GOTO      KSCL5000 IF EQUAL
.
          BRANCH    OPCNCLSU,KSCL2000
.
          PACK      KEY6,SCLIN,SP6
          CALL      RDOPCLI1
          BRANCH    OVRCD,KSCL4000
.
          PACK      OPCLDOCT,OPCLDOCT,SP6
          MATCH     SP6,OPCLDOCT
          GOTO      KSCL3000 IF NOT EQUAL
          MOVE      OPCLDESC,SCLIDESC
          DISPLAY   *P32:6,*EL,*V2LON,OPCLDOCT:
                    *P40:6,*HOFF,SCLIDESC
          GOTO      KSCL9999
.
KSCL2000
          MOVE      SCLIN,OPCLDOCT
.
KSCL3000
          PACK      KEY6,OPCLDOCT,SP6
          CALL      RDDOCT1
          BRANCH    OVRCD,KSCL4000
.
          CALL      FDOC0000             * Format doctors name
.
          MOVE      PACFNAME,SCLIDESC
          DISPLAY   *P32:6,*EL,*V2LON,OPCLDOCT:
                    *P40:6,*HOFF,SCLIDESC
          GOTO      KSCL9999
.
KSCL4000
          BEEP
          DISPLAY  *P1:24,*EL,"Code is not on file. ";
          CALL     HITENTER
          GOTO     KSCL0000
.
.***** handle ? on operating room *******
.
KSCL5000
          BRANCH    OPCNCLSU,KSCL5100
          CALL      OPRCLIDS
          GOTO      KSCL6000
KSCL5100
          CALL      GETSCR00  
          MOVE      SP10,SCLIN
          CALL      PATDOCDS
          CALL      PUTSCR00                      * restore screen
          BRANCH    EXIT,KSCL0500
          MOVE      DOCCODE,SCLIN
          PACK      KEY6,SCLIN
          CALL      RDDOCT1
          GOTO      KSCL2000 
.
KSCL6000
          DISPLAY   *P1:24,*EL,"Starting ",OPCNCDSC," : "
          KEYIN     *P28:24,*DV,UNDLN6:
                    *P28:24,*V2LON,SCLIN:
                    *P28:24,*DV,SCLIN
.
          PACK      SCLIN,SCLIN,SP6
          MATCH     SP6,SCLIN
          GOTO      KSCL7000 IF NOT EQUAL
          MOVE      "Start ",SCLIN
          CLEAR     SCLIDESC
          GOTO      KSCL8000
KSCL7000
          MATCH     QUEST,SCLIN
          GOTO      KSCL5000 IF EQUAL
.
          BRANCH    OPCNCLSU,KSCL7100
.
          PACK      KEY6,SCLIN,SP6
          CALL      RDOPCLI1
          BRANCH    OVRCD,KSCL7500
.
          PACK      OPCLDOCT,OPCLDOCT,SP6
          MATCH     SP6,OPCLDOCT
          GOTO      KSCL7200 IF NOT EQUAL
          MOVE      OPCLDESC,SCLIDESC
          GOTO      KSCL8000
.
KSCL7100
          MOVE      SCLIN,OPCLDOCT
.
KSCL7200
          PACK      KEY6,OPCLDOCT,SP6
          CALL      RDDOCT1
          BRANCH    OVRCD,KSCL7500
.
          CALL      FDOC0000             * Format doctors name
.
          MOVE      PACFNAME,SCLIDESC
          GOTO      KSCL8000
.
KSCL7500
          BEEP
          DISPLAY   *P1:24,*EL,"Code is not on file. ";
          CALL      HITENTER
          GOTO      KSCL6000
KSCL8000  
          CALL      SCRN0000
          DISPLAY   *P32:4,*V2LON,REPDATE:
                    *P32:6,*V2LON,SCLIN,*HOFF:
                    *P40:6,*EL,SCLIDESC
KSCL9999  RETURN
.
.**********************************************************************
.*                         KECL0000                                   *
.*                  Keyin the ending clinic                           *
.**********************************************************************
.
KECL0000
          DISPLAY   *P32:8,*EL:
                    *P32:8,UNDLN6
          KEYIN     *P32:8,*V2LON,ECLIN
.
          PACK      ECLIN,ECLIN,SP6
          MATCH     SP6,ECLIN
          GOTO      KECL1000 IF NOT EQUAL
.
KECL0500  MOVE      "Finish",ECLIN
          DISPLAY   *P32:8,*EL,*V2LON,ECLIN
          CLEAR     ECLIDESC
          GOTO      KECL9999
.
KECL1000
          MATCH     QUEST,ECLIN
          GOTO      KECL5000 IF EQUAL
.
          BRANCH    OPCNCLSU,KECL1100
.
          PACK      KEY6,ECLIN,SP6
          CALL      RDOPCLI1
          BRANCH    OVRCD,KECL4000
.
          MATCH     SP6,OPCLDOCT
          GOTO      KECL1500 IF NOT EQUAL
          MOVE      OPCLDESC,ECLIDESC
          DISPLAY   *P40:8,*EL,ECLIDESC 
          GOTO      KECL2000
.
KECL1100
          MOVE      ECLIN,OPCLDOCT
KECL1500
          PACK      KEY6,OPCLDOCT,SP6
          CALL      RDDOCT1
          BRANCH    OVRCD,KECL4000
.
          CALL      FDOC0000
.
          MOVE      PACFNAME,ECLIDESC
          DISPLAY   *P32:8,*EL,*V2LON,OPCLDOCT:
                    *P40:8,*HOFF,ECLIDESC
.
.**** test that end code >= start code ****
.
KECL2000
          MATCH     "Start ",SCLIN
          GOTO      KECL9999 IF EQUAL
.
          MATCH     ECLIN,SCLIN
          GOTO      KECL9999 IF LESS
          GOTO      KECL9999 IF EQUAL
          BEEP
          DISPLAY   *P1:24,*EL,"Starting code must be > or = ending code. ";
          CALL      HITENTER
          
          GOTO      KECL0000
.
KECL4000
          BEEP
          DISPLAY  *P1:24,*EL,"Code is not on file. ";
          CALL     HITENTER
          GOTO     KECL0000
.
.***** handle ? on operating room *******
.
KECL5000
          BRANCH    OPCNCLSU,KECL5100
          CALL      OPRCLIDS
          GOTO      KECL6000
KECL5100
          CALL      GETSCR00  
          MOVE      SP10,ECLIN
          CALL      PATDOCDS
          CALL      PUTSCR00                      * restore screen
          BRANCH    EXIT,KECL0500
          MOVE      DOCCODE,ECLIN
          PACK      KEY6,ECLIN
          CALL      RDDOCT1
          GOTO      KECL1100 
.
KECL6000
          DISPLAY   *P1:24,*EL,"Ending ",OPCNCDSC," : "
          KEYIN     *P26:24,*DV,UNDLN6:
                    *P26:24,*V2LON,ECLIN:
                    *P26:24,*DV,ECLIN
.
          PACK      ECLIN,ECLIN,SP6
          MATCH     SP6,ECLIN
          GOTO      KECL7000 IF NOT EQUAL
          MOVE      "Finish",ECLIN
          CLEAR     ECLIDESC
          GOTO      KECL8000
KECL7000
          MATCH     QUEST,ECLIN
          GOTO      KECL5000 IF EQUAL
.
          BRANCH    OPCNCLSU,KECL7100
.
          PACK      KEY6,ECLIN,SP6
          CALL      RDOPCLI1
          BRANCH    OVRCD,KECL7500
.
          MATCH     SP6,OPCLDOCT
          GOTO      KECL7200 IF NOT EQUAL
          MOVE      OPCLDESC,ECLIDESC
          GOTO      KECL7300
KECL7100
          MOVE      ECLIN,OPCLDOCT
KECL7200
          PACK      KEY6,OPCLDOCT,SP6
          CALL      RDDOCT1
          BRANCH    OVRCD,KECL7500
.
          CALL      FDOC0000
.
          MOVE      PACFNAME,ECLIDESC
.
.**** test that end code >= start code ****
.
KECL7300
          MATCH     "Start ",SCLIN
          GOTO      KECL8000 IF EQUAL
.
          MATCH     ECLIN,SCLIN
          GOTO      KECL8000 IF LESS
          GOTO      KECL8000 IF EQUAL
          BEEP
          DISPLAY   *P1:24,*EL,"Starting code must be > or = ending code. ";
          CALL      HITENTER
          
          GOTO      KECL6000
.
KECL7500
          BEEP
          DISPLAY   *P1:24,*EL,"Code is not on file. ";
          CALL      HITENTER
          GOTO      KECL6000
KECL8000  
          CALL      SCRN0000
          DISPLAY   *P32:4,*V2LON,REPDATE:
                    *P32:6,SCLIN,*HOFF:
                    *P40:6,SCLIDESC:
                    *P32:8,*V2LON,ECLIN,*HOFF:
                    *P40:8,*EL,ECLIDESC
KECL9999  RETURN
+
.*****************************************************************************
.*                                PERI0000                                   *
.*                         Keyin the period range                            *
.*****************************************************************************
.
PERI0000  MOVE      SP3,SPERIOD
          MOVE      SP3,EPERIOD
          MOVE      "SP",CODE1
.
          MOVE      SIX,ROW
.
          CALL      KPER0000                * Keyin the starting period
.
          COMPARE   ONE,EXIT
          GOTO      PERI0500 IF NOT EQUAL
.
.*******  Qustion mark was performed so redisplay the data *****
.
          CALL      SCRN0000
          DISPLAY   *P32:4,*V2LON,REPDATE

PERI0500  MATCH     ACODE,SP3
          GOTO      PERI1000 IF NOT EQUAL

          MOVE      SP3,SPERIOD
          MOVE      SP20,SPERDESC
          DISPLAY   *P32:6,*V2LON,"Start"
          MOVE      "Start",STARTPER
          PACK      STARTPER,STARTPER,SP30
          GOTO      PERI4000

PERI1000  MOVE      ACODE,SPERIOD
          DISPLAY   *P32:6,*V2LON,ACODE,*HOFF,*P37:6,TDESC
          MOVE      TDESC,SPERDESC 
          PACK      STARTPER,ACODE,SP2,TDESC,SP30
.
PERI4000  MOVE      EIGHT,ROW
          CALL      KPER0000                * Keyin the ending period
.
          COMPARE   ONE,EXIT
          GOTO      PERI4500 IF NOT EQUAL
.
.*******  Qustion mark was performed so redisplay the data *****
.
          CALL      SCRN0000
          MATCH     SP3,SPERIOD
          GOTO      PERI4200 IF EQUAL
          DISPLAY   *P32:4,*V2LON,REPDATE:
                    *P32:6,SPERIOD,*HOFF,*P37:6,SPERDESC
          GOTO      PERI4500
.
PERI4200  DISPLAY   *P32:4,*V2LON,REPDATE:
                    *P32:6,"Start"

PERI4500  MATCH     ACODE,SP3
          GOTO      PERI5000 IF NOT EQUAL
.
          MOVE      "zzz",EPERIOD
          MOVE      SP20,EPERDESC
          DISPLAY   *P32:8,*V2LON,"Finish"
          MOVE      "Finish",ENDPERI
          GOTO      PERI9999
.
PERI5000  MOVE      ACODE,EPERIOD
          MOVE      TDESC,EPERDESC
          DISPLAY   *P32:8,*V2LON,ACODE,*HOFF,*P37:8,TDESC
          PACK      ENDPERI,ACODE,SP2,TDESC
          MATCH     "Start ",SPERIOD
          GOTO      PERI9999 IF EQUAL
.
          MATCH     EPERIOD,SPERIOD
          GOTO      PERI9999 IF LESS
          GOTO      PERI9999 IF EQUAL
          BEEP
          DISPLAY   *P1:24,*EL,"Starting code must be > or = ending code. ";
          CALL      HITENTER
.
          DISPLAY   *P35:6,SP30
          DISPLAY   *P32:8,SP30
          GOTO      PERI0000
.
PERI9999  RETURN
            
.
.****************************************************************************
.*                            KPER0000                                      *
.*                    Keyin the period codes ...                            *
.****************************************************************************

KPER0000  KEYIN     *P32:ROW,*DV,UNDLN3:
                    *P32:ROW,*V2LON,ACODE:
                    *P32:ROW,*DV,ACODE
.
          PACK      ACODE,ACODE,SP3
          MATCH     SP3,ACODE
          GOTO      KPER9999 IF EQUAL
.
          MATCH     QUEST,ACODE
          GOTO      KPER5000 IF EQUAL
.
          PACK      KEY5,CODE1,ACODE
          CALL      RDCODE1
          BRANCH    OVRCD,KPER4000 
.
          GOTO      KPER9999
.
KPER4000  BEEP
          DISPLAY   *P1:24,*EL,"Code is not on file. ";
          CALL      HITENTER
          GOTO      KPER0000
.
.******  Handle the question mark option for period codes **********
.
KPER5000  CALL      PATCODDS
          DISPLAY   *P1:24,*EL,"Period Code : " 
          KEYIN     *P15:24,*DV,UNDLN3:
                    *P15:24,*V2LON,ACODE:
                    *P15:24,*DV,ACODE
.
          PACK      ACODE,ACODE,SP3
          MATCH     SP3,ACODE
          GOTO      KPER8000 IF EQUAL
.
          MATCH     QUEST,ACODE
          GOTO      KPER5000 IF EQUAL
.
          PACK      KEY5,CODE1,ACODE
          CALL      RDCODE1
          BRANCH    OVRCD,KPER7000
          GOTO      KPER8000
.
KPER7000  BEEP
          DISPLAY   *P1:24,*EL,"Code is not on file. ";
          CALL      HITENTER
          GOTO      KPER5000
.
KPER8000  MOVE      ONE,EXIT

KPER9999  RETURN
.
.*********************************************************************
.*                        FDOC0000                                   *
.*                 Format the doctors name                           *
.*********************************************************************
.
FDOC0000
          MOVE      DSNAME,PACSNAME
          MOVE      DGNAME,PACGNAME
          MOVE      DTITL,PACTITLE
          MOVE      ONE,PACFRMT
          CALL      PACNAME
FDOC9999  RETURN
.**********************************************************************
.*                         SCRN0000                                   *
.*                  Display the date prompt screen                    *
.********************************************************************** 
.
SCRN0000
          BRANCH    MOPTION,SCRN1000,SCRN2000,SCRN3000,SCRN4000,SCRN5000
.
SCRN1000
          DISPLAY   *P1:3,*EF:
                    *P5:4,"Date of Operation From   : ":
                    *P43:4,"To : "
          GOTO      SCRN9999
.
SCRN2000
          DISPLAY   *P1:3,*EF:
                    *P5:4,"Date of Operation From   : ":
                    *P43:4,"To : ":
                    *P5:6,"Starting ",OPCNODSC,*P30:6,": ":
                    *P5:8,"Ending ",OPCNODSC,*P30:8,": "

          GOTO      SCRN9999
.
SCRN3000
          DISPLAY   *P1:3,*EF:
                    *P5:4,"Date of Operation From   : ":
                    *P43:4,"To : ":
                    *P5:6,"Starting Surgeon Code    : ":    
                    *P5:8,"Ending Surgeon Code      : " 
          GOTO      SCRN9999
.
SCRN4000
          DISPLAY   *P1:3,*EF:
                    *P5:4,"Date of Operation From   : ":
                    *P43:4,"To : ":
                    *P5:6,"Starting ",OPCNCDSC,*P30:6,": ":
                    *P5:8,"Ending ",OPCNCDSC,*P30:8,": "
          GOTO      SCRN9999
.
SCRN5000  DISPLAY   *P1:3,*EF:
                    *P5:4,"Date of Operation From   : ":
                    *P43:4,"To : ":
                    *P5:6,"Starting Period",*P30:6,": ":
                    *P5:8,"Ending Period",*P30:8,": "
.
SCRN9999  RETURN
.
.**********************************************************************
.*                         CRTF0000                                   *
.*                Create the appropriate tempfile                     *
.**********************************************************************
.
CRTF0000  CALL      KILL0000
          BRANCH    MOPTION,CRTF9999,CRTF2000,CRTF3000,CRTF4000,CRTF5000

CRTF2000  CLEAR     CMDLINE
          APPEND    "isbuild ",CMDLINE
          APPEND    TEMPTHET,CMDLINE
          APPEND    " 31 U1-6,7-11,12-17,18-20,21-30",CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          OPEN      TMPTHET1,TEMPTHET
          GOTO      CRTF9999
.
CRTF3000  CLEAR     CMDLINE
          APPEND    "isbuild ",CMDLINE
          APPEND    TEMPSURG,CMDLINE
          APPEND    " 30 U1-6,7-11,12-17,18-20,21-28",CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          OPEN      TMPSURG1,TEMPSURG
          GOTO      CRTF9999
.
CRTF4000  CLEAR     CMDLINE
          APPEND    "isbuild ",CMDLINE
          APPEND    TEMPCLIN,CMDLINE
          APPEND    " 24 U1-6,7-11,12-14,15-22",CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          OPEN      TMPCLIN1,TEMPCLIN
          GOTO      CRTF9999
.
CRTF5000  CLEAR     CMDLINE
          APPEND    "isbuild ",CMDLINE
          APPEND    TEMPPERI,CMDLINE
          APPEND    " 25 u1-3,4-9,10-14,15-20,21-23",CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
          OPEN      TMPPERI1,TEMPPERI
          GOTO      CRTF9999
.
CRTF9999  RETURN
.
.**********************************************************************
.*                              KILL0000                              *
.*                  Kill the Tempfile if it Already Exists            *
.**********************************************************************
KILL0000  
.
          BRANCH    MOPTION,KILL9999,KILL2000,KILL3000,KILL4000,KILL5000
.
KILL2000
          CLOSE     TMPTHET1
          CLEAR     CMDLINE
          APPEND    "iserase ",CMDLINE
          APPEND    TEMPTHET,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
          GOTO      KILL9999
.
KILL3000
          CLOSE     TMPSURG1
          CLEAR     CMDLINE
          APPEND    "iserase ",CMDLINE
          APPEND    TEMPSURG,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
          GOTO      KILL9999
.
KILL4000
          CLOSE     TMPCLIN1
          CLEAR     CMDLINE
          APPEND    "iserase ",CMDLINE
          APPEND    TEMPCLIN,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
          GOTO      KILL9999
.
KILL5000  CLOSE     TMPPERI1
          CLEAR     CMDLINE
          APPEND    "iserase ",CMDLINE
          APPEND    TEMPPERI,CMDLINE
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
          GOTO      KILL9999
.
KILL9999  RETURN
+
.**********************************************************************
.*                            OPTN0000                                *
.*                Select the option to be run                         *
.**********************************************************************
OPTN0000  MOVE      ZERO,EXIT
          HLINE     *G37,2,53,80
          DISPLAY   *P1:3,*EF:
                    *P1:4,*V2LON,ZERO,*HOFF," = Exit":
                    *P1:5,*V2LON,ONE,*HOFF," = By Date/Time":
                    *P1:6,*V2LON,TWO,*HOFF," = By ",OPCNODSC:
                    *P1:7,*V2LON,THREE,*HOFF," = By Operating Surgeon":
                    *P1:8,*V2LON,FOUR,*HOFF," = By ",OPCNCDSC:
                    *P1:9,*V2LON,FIVE,*HOFF," = By Period/Theatre/Session"
.
OPTN1000  KEYIN     *P1:13,*EL,"Select Option : _":
                    *P17:13,*V2LON,MOPTION
.
          COMPARE   ZERO,MOPTION
          GOTO      OPTN9000 IF EQUAL
.
          BRANCH    MOPTION,OPTN8100,OPTN8200,OPTN8300,OPTN8400,OPTN8500
.
OPTN2000  BEEP                              * invalid selection 
          GOTO      OPTN1000
.
OPTN8100  DISPLAY   *P53:2,*V2LON,"- By Date/Time "
          CLEAR     CPHDROPT
          MOVE      "- By Date/Time",CPHDROPT
          GOTO      OPTN9999
.
OPTN8200  DISPLAY   *P53:2,*V2LON,"- By ",*+,OPCNODSC,SP1
          CLEAR     CPHDROPT
          APPEND    BY,CPHDROPT
          APPEND    OPCNODSC,CPHDROPT
          GOTO      OPTN9999
.
OPTN8300  DISPLAY   *P53:2,*V2LON,"- By Operating Surgeon "
          CLEAR     CPHDROPT
          MOVE      "- By Operating Surg",CPHDROPT
          GOTO      OPTN9999
.
OPTN8400  DISPLAY   *P53:2,*V2LON,"- By ",*+,OPCNCDSC,SP1
          CLEAR     CPHDROPT
          APPEND    BY,CPHDROPT
          APPEND    OPCNCDSC,CPHDROPT
          GOTO      OPTN9999
.
OPTN8500  DISPLAY   *P53:2,*V2LON,"- By Period/Theatre/Session "
          CLEAR     CPHDROPT
          MOVE      "- By Period/Thet/Sess",CPHDROPT
          GOTO      OPTN9999
.
OPTN9000  MOVE      ONE,EXIT                * chose exit
.
OPTN9999  RETURN
.
.**********************************************************************
.*                         WTTH0000                                   *
.*              Write the temporary theatre file                      *
.**********************************************************************
.
WTTH0000
          MOVE      STHET,SCODE
          MOVE      ETHET,ECODE
.
          MATCH     "Start ",STHET
          GOTO      WTTH1000 IF NOT EQUAL
.
          PACK      SCODE,SP20
.
WTTH1000
          MATCH     "Finish",ETHET
          GOTO      WTTH2000 IF NOT EQUAL
.
          MOVE      "zzzzzz",ECODE
.
WTTH2000
          PACK      KEY22,DATEOFOP,SP20
          CALL      RSOPSES7
WTTH3000
          CALL      RKOPSES7
          BRANCH    OVRCD,WTTH9999
.
          MATCH     DATEOFOP,OPSEDATE    * test for required date
          GOTO      WTTH9999 IF NOT EQUAL
.
          COMPARE   ZERO,OPSESTAT        * test if session is cancelled
          GOTO      WTTH3000 IF EQUAL
.
          PACK      KEY26,OPSEHOSP,OPSEDATE,OPSETIME,OPSECLIN,SP70
          CALL      RSOPDEA1
WTTH4000
          CALL      RKOPDEA1
          BRANCH    OVRCD,WTTH3000
.
          IF        IBCNMHOS=1
            MATCH     OPSEHOSP,OPDAHOSP    * test for hospital id
            GOTO      WTTH3000 IF NOT EQUAL
          ENDIF
.
          MATCH     OPSEDATE,OPDADATE    * test for required date
          GOTO      WTTH3000 IF NOT EQUAL
.
          MATCH     OPSETIME,OPDATIME    * test for required sess time
          GOTO      WTTH3000 IF NOT EQUAL
.
          MATCH     OPSECLIN,OPDACLIN    * test for correct clinic
          GOTO      WTTH3000 IF NOT EQUAL
.
          COMPARE   THREE,OPDASTAT
          GOTO      WTTH4000 IF EQUAL
.
.---- Check if we have a theatre code for this booking, or should we ----
.---- use the session default                                        ----
.
          MATCH     SP6,OPDATHET
          GOTO      WTTH4500 IF NOT EQUAL
.
          MOVE      OPSETHET,OPDATHET    * use the session theatre code
.
.---- Check if this theatre is one of the ones we want
.
WTTH4500  MATCH     SCODE,OPDATHET       * test >= start code
          GOTO      WTTH4000 IF LESS
.
          MATCH     OPDATHET,ECODE       * test <= end code
          GOTO      WTTH4000 IF LESS
.
.---- Set up the temporary file Variables ----
.
          MOVE      OPDATHET,THETROOM
          MOVE      OPDATIME,THETTIME
          MOVE      OPDACASE,THETCASE
          MOVE      OPDACLIN,THETCLIN
          MOVE      OPDAUNIQ,THETUNIQ
.
.---- write the record ----
.
          PACK      KEY30,THETROOM,THETTIME,THETCLIN,THETCASE,THETUNIQ
          CALL      RATHET1
          IF        OVRCD=1
            CALL      WRTHET1
          ENDIF
.
          GOTO      WTTH4000
.
WTTH9999  RETURN
          
.
.**********************************************************************
.*                         WTCL0000                                   *
.*              Write the temporary clinic file                       *
.**********************************************************************
.
WTCL0000  MOVE      SCLIN,SCODE
          MOVE      ECLIN,ECODE
.
          MATCH     "Start ",SCLIN
          GOTO      WTCL1000 IF NOT EQUAL
.
          PACK      SCODE,SP20
.
WTCL1000
          MATCH     "Finish",ECLIN
          GOTO      WTCL2000 IF NOT EQUAL
.
          MOVE      "zzzzzz",ECODE
.
WTCL2000
          PACK      KEY22,DATEOFOP,SP20         
          CALL      RSOPSES7
WTCL3000
          CALL      RKOPSES7
          BRANCH    OVRCD,WTCL9999
.
          MATCH     DATEOFOP,OPSEDATE    * test for required date
          GOTO      WTCL9999 IF NOT EQUAL
.
          COMPARE   ZERO,OPSESTAT
          GOTO      WTCL3000 IF EQUAL
.
          MATCH     SCODE,OPSECLIN       * test >= start code
          GOTO      WTCL3000 IF LESS
.
          MATCH     OPSECLIN,ECODE       * test <= end code
          GOTO      WTCL3000 IF LESS
.
          PACK      KEY26,OPSEHOSP,OPSEDATE,OPSETIME,OPSECLIN,SP70
          CALL      RSOPDEA1
WTCL4000
          CALL      RKOPDEA1
          BRANCH    OVRCD,WTCL3000
.
          MATCH     OPSEHOSP,OPDAHOSP    * test for hospital id
          GOTO      WTCL3000 IF NOT EQUAL
.
          MATCH     OPSEDATE,OPDADATE    * test for required date
          GOTO      WTCL3000 IF NOT EQUAL
.
          MATCH     OPSETIME,OPDATIME    * test for required sess time
          GOTO      WTCL3000 IF NOT EQUAL
.
          MATCH     OPSECLIN,OPDACLIN    * test for correct clinic
          GOTO      WTCL3000 IF NOT EQUAL
.
          COMPARE   THREE,OPDASTAT
          GOTO      WTCL4000 IF EQUAL
.
.---- Set up the temporary file Variables ----
.
          MOVE      OPSECLIN,CLINCODE
          MOVE      OPSETIME,CLINTIME
          MOVE      OPDACASE,CLINCASE
          MOVE      OPDAADMN,CLINADMN
          MOVE      OPDASTAT,CLINSTAT
.
.---- write the record ----
.
          PACK      KEY22,CLINCODE,CLINTIME,CLINCASE,CLINADMN
          CALL      RACLIN1
          IF        OVRCD=1       
            CALL      WRCLIN1
          ENDIF
.
          GOTO      WTCL4000
.
WTCL9999  RETURN
          
.**********************************************************************
.*                         WTSU0000                                   *
.*              Write the temporary surgeon file                      *
.**********************************************************************
.
WTSU0000
          MOVE      SSURG,SCODE
          MOVE      ESURG,ECODE
.
          MATCH     "Start ",SSURG
          GOTO      WTSU1000 IF NOT EQUAL
.
          MOVE      SP6,SCODE               * start at start of file
.
WTSU1000  MATCH     "Finish",ESURG
          GOTO      WTSU2000 IF NOT EQUAL
.
          MOVE      "zzzzzz",ECODE
.
.         get the data
.
WTSU2000  PACK      KEY22,DATEOFOP,SP20           
          CALL      RSOPSES7
.
.         loop over session file for the entered date
.
WTSU3000  CALL      RKOPSES7
          BRANCH    OVRCD,WTSU9999
.
          MATCH     DATEOFOP,OPSEDATE    * test for required date
          GOTO      WTSU9999 IF NOT EQUAL
.
          COMPARE   ZERO,OPSESTAT
          GOTO      WTSU3000 IF EQUAL
.
          MOVE      ZERO,EMPTYSES           * Reset empty session flag
.
          PACK      KEY26,OPSEHOSP,OPSEDATE,OPSETIME,OPSECLIN,SP70
          CALL      RSOPDEA1
.
.         loop over operation details file
.
WTSU4000  CALL      RKOPDEA1
          BRANCH    OVRCD,WTSU4100          * EOF, check empty session
.
          MATCH     OPSEHOSP,OPDAHOSP       * test for hospital id
          GOTO      WTSU4100 IF NOT EQUAL
.
          MATCH     OPSEDATE,OPDADATE 
          GOTO      WTSU4100 IF NOT EQUAL   * wrong date, check empty session
.
          MATCH     OPSETIME,OPDATIME
          GOTO      WTSU4100 IF NOT EQUAL   * wrong time, check empty session
.
          MATCH     OPSECLIN,OPDACLIN
          GOTO      WTSU4100 IF NOT EQUAL   * wrong clinic, check empty session
. 
          GOTO      WTSU4200                * check cancelled booking   
.
WTSU4100  COMPARE   ZERO,EMPTYSES           * Is this an empty session?    
          GOTO      WTSU5200 IF EQUAL       * Yes, write temp file
.          
          GOTO      WTSU3000                * No, read next session record
.
WTSU4200  COMPARE   THREE,OPDASTAT
          GOTO      WTSU4000 IF EQUAL       * cancelled booking
.
          MOVE      ZERO,DEFAULTF           * set flag to use default team
          PACK      KEY10,OPDAUNIQ
          CALL      RDOPARD1
          BRANCH    OVRCD,WTSU5000
.
.***  Get surgical details from oprsrgaf ***
.
          PACK      KEY11,OPDAUNIQ,ONE
          CALL      RDOPSRG1
          BRANCH    OVRCD,WTSU5000
          MOVE      ONE,DEFAULTF
.
WTSU5000  CALL      GOSU0000                * get the operating surgeon
.
          MATCH     SCODE,DOCTOR            * test >= start code
          GOTO      WTSU4000 IF LESS        * code too early
.
          MATCH     DOCTOR,ECODE            * test <= end code
          GOTO      WTSU4000 IF LESS
.
.---- Set up the temporary file Variables ----
.
WTSU5100  MOVE      DOCTOR,SURGCODE
          MOVE      OPSETIME,SURGTIME
          MOVE      OPDACLIN,SURGCLIN
          MOVE      OPDACASE,SURGCASE
          MOVE      OPDAADMN,SURGADMN
          MOVE      OPDASTAT,SURGSTAT
.          
          MOVE      ONE,EMPTYSES             * not an empty session
.
.---- write the record ----
.
          PACK      KEY28,SURGCODE,SURGTIME,SURGCLIN,SURGCASE,SURGADMN
          CALL      RASURG1
          IF        OVRCD=1
            CALL      WRSURG1
          ENDIF
          GOTO      WTSU4000
.
.
.---- Write temp file for Session without patients
.
WTSU5200  CALL      GOSU0000                * get operating surgeon
.
          MATCH     SCODE,DOCTOR            * Is Current Dr < Start Dr?
          GOTO      WTSU3000 IF LESS        * Yes, read next session rec
.
          MATCH     DOCTOR,ECODE            * Is End Dr < Current Dr?
          GOTO      WTSU3000 IF LESS        * Yes, read next session rec
.
          MOVE      DOCTOR,SURGCODE         * Surgeon code
          MOVE      OPSETIME,SURGTIME       * Surgery time
          MOVE      OPSECLIN,SURGCLIN       * Clinic/Surgeon
          MOVE      SP70,SURGCASE           * No - Case number
          MOVE      SP70,SURGADMN           * No - Patient Admission No.
          MOVE      OPSESTAT,SURGSTAT       * Status
.
          PACK      KEY28,SURGCODE,SURGTIME,SURGCLIN,SURGCASE,SURGADMN
          CALL      RASURG1
          IF        OVRCD=1
            CALL      WRSURG1                 * Write temp record
          ENDIF
          GOTO      WTSU3000                * Read next session rec              
.
WTSU9999  RETURN
.         
.**********************************************************************
.*                        GOSU0000                                    *
.*                 Get the operating surgeon                          *
.**********************************************************************
.
GOSU0000  MOVE      SP6,DOCTOR              * clear doctor code
          MOVE      ZERO,COUNTER
.
          BRANCH    DEFAULTF,GOSU6000    * not using the default team
.
.         use the default team from the session file
.
GOSU1000  ADD       ONE,COUNTER
.
          COMPARE   NINE,COUNTER
          GOTO      GOSU9000 IF EQUAL
.
          LOAD      TYPE,COUNTER,OPSETYD1,OPSETYD2,OPSETYD3,OPSETYD4:
                                 OPSETYD5,OPSETYD6,OPSETYD7,OPSETYD8
.
          PACK      TYPE,TYPE,SP3
          MATCH     SP3,TYPE
          GOTO      GOSU1000 IF EQUAL
.
          PACK      KEY5,CATOP,TYPE
          CALL      RDCODE1
          BRANCH    OVRCD,GOSU1000
.
          MATCH     "S",TCINDC1
          GOTO      GOSU1000 IF NOT EQUAL
.
          LOAD      DOCTOR,COUNTER,OPSEDCC1,OPSEDCC2,OPSEDCC3,OPSEDCC4:
                                   OPSEDCC5,OPSEDCC6,OPSEDCC7,OPSEDCC8
          GOTO      GOSU9999
.
.         Using new tables for surgeon details
.
GOSU6000  PACK      KEY35,OPSGUNID,OPSGTMNO,SP1,ZERO,SP30
          CALL      RSOPTSM1
GOSU6500  CALL      RKOPTSM1
          BRANCH    OVRCD,GOSU9999
.
          MATCH     OPSGUNID,OPTSUNID
          GOTO      GOSU9000 IF NOT EQUAL
.
          MATCH     OPSGTMNO,OPTSTMNO
          GOTO      GOSU9000 IF NOT EQUAL
.
          COMPARE   ZERO,OPTSSIND
          GOTO      GOSU9000 IF NOT EQUAL
.
          PACK      KEY5,CATOP,OPTSSTYP
          CALL      RDCODE1
          BRANCH    OVRCD,GOSU6500
.
          MATCH     "S",TCINDC1
          GOTO      GOSU6500 IF NOT EQUAL
.
          MOVE      OPTSSCDE,DOCTOR
          GOTO      GOSU9999
.
.         If no team details, and using surgeons, default doctor code to
.         the doctor in charge of the session.
.
GOSU9000  LOAD      DOCTOR,OPCNCLSU,OPSECLIN
.
GOSU9999  RETURN
.
.**********************************************************************
.*                         WTPE0000                                   *
.*              Write the temporary theatre file                      *
.**********************************************************************
WTPE0000 
          PACK      KEY22,DATEOFOP,SP20
          CALL      RSOPSES7
.
WTPE3000  CALL      RKOPSES7
          BRANCH    OVRCD,WTPE9999
.
          MATCH     DATEOFOP,OPSEDATE    * test for required date
          GOTO      WTPE9999 IF NOT EQUAL
.
          COMPARE   ZERO,OPSESTAT        * test if session is cancelled
          GOTO      WTPE3000 IF EQUAL
.
.------ Test if the session is for the correct period ------
.
          MATCH     SPERIOD,OPSETPER
          GOTO      WTPE3000 IF LESS
.
          MATCH     OPSETPER,EPERIOD
          GOTO      WTPE3000 IF LESS
.
          PACK      KEY26,OPSEHOSP,OPSEDATE,OPSETIME,OPSECLIN,SP70
          CALL      RSOPDEA1
.
WTPE4000  CALL      RKOPDEA1
          BRANCH    OVRCD,WTPE3000
.
          MATCH     OPSEHOSP,OPDAHOSP       * test for hospital id
          GOTO      WTPE30000 IF NOT EQUAL
.
          MATCH     OPSEDATE,OPDADATE    * test for required date
          GOTO      WTPE3000 IF NOT EQUAL
.
          MATCH     OPSETIME,OPDATIME    * test for required sess time
          GOTO      WTPE3000 IF NOT EQUAL
.
          MATCH     OPSECLIN,OPDACLIN    * test for correct clinic
          GOTO      WTPE3000 IF NOT EQUAL
.
          COMPARE   THREE,OPDASTAT
          GOTO      WTPE4000 IF EQUAL
.
.---- Check if we have a theatre code for this booking, or should we ----
.---- use the session default                                        ----
.
          PACK      OPDATHET,OPDATHET,SP6
          MATCH     SP6,OPDATHET
          GOTO      WTPE4500 IF NOT EQUAL
.
          MOVE      OPSETHET,OPDATHET    * use the session theatre code
.
.---- Set up the temporary file Variables ----
.
WTPE4500  
          MOVE      OPSETPER,PERICODE
          MOVE      OPDATHET,PERITHET 
          MOVE      OPSETIME,PERITIME
          MOVE      OPDACASE,PERICASE
          MOVE      OPDACLIN,PERICLIN
          MOVE      OPDASTAT,PERISTAT
.
.---- write the record ----
.
          PACK      KEY23,PERICODE,PERITHET,PERITIME,PERICLIN:
                          PERICASE
          CALL      RAPERI1
          IF        OVRCD=1       
            CALL      WRPERI1
          ENDIF
          GOTO      WTPE4000
.
WTPE9999  RETURN
.
.
.*********************************************************************
.*                         PRBP0000                                  *
.*               Print the report by period                          *
.*********************************************************************
PRBP0000  MOVE      ZERO,SESSTOTL
          MOVE      ZERO,CASETOTL
          MOVE      ZERO,NORECFLG
          MOVE      ZERO,CPAGENO
          UNPACK    SP30,OLDTIME,OLDCLIN,OLDROOM,OLDPERI
          UNPACK    SP30,OLDSURG,OLDANAE,OLDASST
          PACK      SKEY22,SP30
.
          PACK      KEY23,SP20,SP20
          CALL      RSPERI1
PRBP1000  CALL      RKPERI1
          BRANCH    OVRCD,PRBP8000
.
.          PACK      KEY22,DATEOFOP,PERITIME,PERICLIN
.          CALL      RDOPSES1
.          BRANCH    OVRCD,PRBP1000
.
          IF        IBCNMHOS=1
            PACK      KEY22,DATEOFOP,PERITIME,PERICLIN,SP70
            CALL      RSOPSES7
PRBP1200    CALL      RKOPSES7
            BRANCH    OVRCD,PRBP1000
.
            MATCH     DATEOFOP,OPSEDATE    * check date
            GOTO      PRBP1000 IF NOT EQUAL
.
            MATCH     PERITIME,OPSETIME    * check time
            GOTO      PRBP1000 IF NOT EQUAL
.
            MATCH     PERICLIN,OPSECLIN    * check clinic
            GOTO      PRBP1000 IF NOT EQUAL
.
            MATCH     SP70,HOSCODE            * All Hospitals
            IF        !@EQUAL
              MATCH     OPSEHOSP,HOSCODE      * Correct hospital
              GOTO      PRBP1200 IF NOT EQUAL
            ENDIF
          ELSE
            PACK      KEY22,DATEOFOP,PERITIME,PERICLIN,SP70
            CALL      RDOPSES7
            BRANCH    OVRCD,PRBP1000
          ENDIF
.
          COMPARE   ZERO,OPSESTAT        * test if session is cancelled
          GOTO      PRBP1000 IF EQUAL
.
          PACK      KEY26,OPSEHOSP,OPSEDATE,OPSETIME,OPSECLIN,PERISTAT:
                          PERICASE,SP70
          CALL      RDOPDEA1
          BRANCH    OVRCD,PRBP1000
.
          MATCH     SKEY22,KEY22          *** CAR 37265
          IF        !@EQUAL
            ADD       ONE,SESSTOTL
          ENDIF
          MOVE      KEY22,SKEY22          * save session key
.
          MOVE      ZERO,DEFAULTF
          PACK      KEY10,OPDAUNIQ
          CALL      RDOPARD1
          BRANCH    OVRCD,PRBP2500
.
.***  Get surgical details from oprsrgaf ***
.
          PACK      KEY11,OPDAUNIQ,ONE
          CALL      RDOPSRG1
          BRANCH    OVRCD,PRBP2500
          MOVE      ONE,DEFAULTF
.
PRBP2500  CALL      GOSU0000                * get the surgeon
          CLEAR     NAME25
          CALL      GPMI0000                * get PMI details
          CALL      SRDS0000                * set-up report descriptions
          ADD       ONE,CASETOTL
.
          COMPARE   ZERO,NORECFLG           * 1st time through ?
          GOTO      PRBP3000 IF EQUAL       * yes, start a new page
.
          MATCH     ANSN,PAGBREAK
          IF        @EQUAL
            CALL      TVCH0000                * Test which vars have changed
            IF        OPCNR66A=8 | OPCNR66A=9 |OPCNR66A=10
              BRANCH    VCHFLAG,PRBP3050:       * change in period
                                PRBP3050:       * change in theatre
                                PRBP3050:       * change in session
                                PRBP3050        * change in team
            ELSE
              BRANCH    VCHFLAG,PRBP3050:       * change in period
                                PRBP3100:       * change in theatre
                                PRBP3200:       * change in session
                                PRBP3300        * change in team
            ENDIF

            COMPARE   CLNO,FIFTY5             * test if page is full
            GOTO      PRBP4100 IF NOT LESS
.
            GOTO    PRBP4050
.
          ENDIF
.
          CALL      TVCH0000                * Test which vars have changed
          IF        OPCNR66A=8 | OPCNR66A=9 | OPCNR66A=10
            BRANCH    VCHFLAG,PRBP3000:       * change in period
                              PRBP3000:       * change in theatre
                              PRBP3000:       * change in session
                              PRBP3000        * change in team
          ELSE
            BRANCH    VCHFLAG,PRBP3000:       * change in period
                              PRBP3100:       * change in theatre
                              PRBP3200:       * change in session
                              PRBP3300        * change in team
          ENDIF
.
          GOTO      PRBP4000
.
.         Change in period code
.
PRBP3000  CALL      HEAD132
          CALL      TOPH0000
PRBP3050  CALL      HEAD0000
          MOVE      ONE,NORECFLG
          COMPARE   EIGHT,OPCNR66A
          GOTO      PRBP4000 IF EQUAL       * Layout 8 for HEA
.
          COMPARE   NINE,OPCNR66A
          GOTO      PRBP4000 IF EQUAL       * Layout 9 for HEA
.
          COMPARE   TEN,OPCNR66A
          GOTO      PRBP4000 IF EQUAL       * Layout 10 for HEA
.
          CALL      HDPE0000                * heading for new period
          CALL      HDTH0000                * heading for new theatre
          CALL      HDSE0000                * heading for new session
          GOTO      PRBP4000
.
.         Change in theatre
.
PRBP3100  CALL      HDTH0000                * heading for new theatre
          CALL      HDSE0000                * heading for new session
          GOTO      PRBP4000
.
.         Change in session
.
PRBP3200  CALL      HDSE0000                * heading for new session
          GOTO      PRBP4000
.
.         Change in operating team
.
PRBP3300  CALL      HDTE0000                * heading for new session
.
.         have new theatre time or clinic or code so print new page
.
PRBP4000  COMPARE   CLNO,FIFTY5             * test if page is full
          GOTO      PRBP4500 IF NOT LESS
.
PRBP4050  CALL      HEAD132
          CALL      TOPH0000
          CALL      HEAD0000
.
PRBP4100  COMPARE   EIGHT,OPCNR66A
          GOTO      PRBP4500 IF EQUAL       * Layout 8 for HEA
.
          COMPARE   NINE,OPCNR66A
          GOTO      PRBP4500 IF EQUAL       * Layout 9 for HEA
.
          COMPARE   TEN,OPCNR66A
          GOTO      PRBP4500 IF EQUAL       * Layout 10 for HEA
.
          CALL      HDPE0000                * heading for new period
          CALL      HDTH0000                * heading for new theatre
          CALL      HDSE0000                * heading for new session
.
PRBP4500  CALL      PLNS0000                * print the lines
          MOVE      PERITIME,OLDTIME 
          MOVE      PERITHET,OLDROOM
          MOVE      PERICLIN,OLDCLIN
          MOVE      PERICODE,OLDPERI
          MOVE      SURGNCD,OLDSURG
          MOVE      ANAETHCD,OLDANAE
          MOVE      ASSURGCD,OLDASST
          GOTO      PRBP1000
.
.         End of Report
.
PRBP8000  BRANCH    NORECFLG,PRBP9000
          CALL      HEAD132
          CALL      TOPH0000
          CALL      CLOPRSES
          CALL      HEAD0000
.
PRBP9000  BRANCH    OPCNR66A,PRBP9800,PRBP9800,PRBP9100,PRBP9800,PRBP9800:
                             PRBP9900,PRBP9900,PRBP9800,PRBP9800,PRBP9800
.
PRBP9100  PRINT     *N,*44,"List Approved by : ",*N,*N,*44,UNDLN,*N,*N:
                    *44,"For Medical Administrator"
.
PRBP9800  PRINT     *N,"Number of Sessions  : ",SESSTOTL,*N:
                       "Number of Cases     : ",CASETOTL
PRBP9900  IF         OPCNR66A=9 | OPCNR66A=10
            PRINT     *N,"*** End of Theatre Sessions ***",*N
          ELSE
            PRINT     *N,"*** End of Report ***",*N
          ENDIF
.
PRBP9999  RETURN
.
.****************************************************************************
.*                            TVCH0000                                      *
.*                 Test which variables have changed                        *
.****************************************************************************
.
TVCH0000  MOVE      ZERO,VCHFLAG
.
.VCH0200  MATCH     PERITIME,OLDTIME
.         GOTO      TVCH0210 IF NOT EQUAL
.         MATCH     PERICLIN,OLDCLIN
.         GOTO      TVCH0300 IF EQUAL
TVCH0210                          
.
TVCH0300  MATCH     PERICODE,OLDPERI
          GOTO      TVCH1000 IF EQUAL
          MOVE      ONE,VCHFLAG
          GOTO      TVCH9999
.
TVCH1000  MATCH     PERITHET,OLDROOM 
          GOTO      TVCH2000 IF EQUAL   * new theatre
          MOVE      TWO,VCHFLAG
          GOTO      TVCH9999
.
TVCH2000  MATCH     PERITIME,OLDTIME
          GOTO      TVCH2100 IF NOT EQUAL
          MATCH     PERICLIN,OLDCLIN
          GOTO      TVCH3000 IF EQUAL
TVCH2100  MOVE      THREE,VCHFLAG
          GOTO      TVCH9999
.
TVCH3000  MATCH     SURGNCD,OLDSURG
          GOTO      TVCH3100 IF NOT EQUAL
          MATCH     ANAETHCD,OLDANAE
          GOTO      TVCH3100 IF NOT EQUAL
          MATCH     ASSURGCD,OLDASST
          GOTO      TVCH9999 IF EQUAL
TVCH3100  MOVE      FOUR,VCHFLAG
          GOTO      TVCH9999
.
TVCH9999  RETURN
.
.****************************************************************************
.*                            HDPE0000                                      *
.*                 Print the period sub - heading for option 5              *
.****************************************************************************
HDPE0000  MOVE      "No Period Code",TDESC
          MATCH     SP3,PERICODE
          GOTO      HDPE1000 IF EQUAL
          MOVE      "Unknown Period Code",TDESC
          MOVE      "SP",CODE1
          PACK      KEY5,CODE1,PERICODE
          CALL      RDCODE1
HDPE1000  PRINT     "Period : ",*10,PERICODE,SP2,TDESC,*10,PERICODE,SP2:
                       TDESC
          ADD       ONE,CLNO
HDPE9999  RETURN
.
.****************************************************************************
.*                            HDTH0000                                      *
.*                 Print the theatre sub - heading for option 5             *
.****************************************************************************
.
HDTH0000  COMPARE   CLNO,FIFTY5
          GOTO      HDTH6100 IF NOT LESS
.
          MATCH     ANSN,PAGBREAK
          GOTO      HDTH0500 IF EQUAL
.
          CALL      HEAD132
          CALL      TOPH0000
          CALL      HEAD0000
HDTH0500  CALL      HDPE0000
.
HDTH6100  MOVE      "No Theatre Code Allocated",OPRMDESC
          MATCH     SP6,PERITHET
          GOTO      HDTH6200 IF EQUAL
.
          MOVE      "Unknown Theatre Code",OPRMDESC
          PACK      KEY6,PERITHET
          CALL      RDOPOPR1
HDTH6200  PRINT     *N,*1,OPRMDESC,*1,OPRMDESC
          ADD       TWO,CLNO
          GOTO      HDTH9999
.
HDTH9999  RETURN
.
.****************************************************************************
.*                            HDSE0000                                      *
.*                 Print the session sub - heading for option 5             *
.****************************************************************************
.
HDSE0000  BRANCH    OPCNR66A,HDSE9999,HDSE9999,HDSE9999,HDSE9999,HDSE9999:
                             HDSE6000,HDSE6000,HDSE9999,HDSE9999,HDSE9999
          GOTO      HDSE9999
.
.         Report layout 6
.
HDSE6000  COMPARE   CLNO,FIFTY5
          GOTO      HDSE6050 IF NOT LESS
.
          MATCH     ANSN,PAGBREAK
          GOTO      HDSE6010 IF EQUAL
.
          CALL      HEAD132
          CALL      TOPH0000
          CALL      HEAD0000
HDSE6010  CALL      HDPE0000
          CALL      HDTH0000
.
HDSE6050  MATCH     SP25,ASSSURG 
          GOTO      HDSE6100 IF EQUAL
          MATCH     SP25,IANAETHS
          GOTO      HDSE6200 IF EQUAL
          PRINT     *N,*7,PERITIME,*14,*+,ISURGEON,SP1,SLASH,SP1,*+,ASSSURG,SP1:
                    SLASH,SP1,*+,IANAETHS:
                    *14,*+,ISURGEON,SP1,SLASH,SP1,*+,ASSSURG,SP1:
                    SLASH,SP1,*+,IANAETHS
          PACK      DIM90,PERITIME,SP2,ISURGEON,SP3,IANAETHS,SP3,ASSSURG
          GOTO      HDSE6500
.
HDSE6100  MATCH     SP25,IANAETHS
          GOTO      HDSE6300 IF EQUAL
          PRINT     *N,*7,PERITIME,*14,*+,ISURGEON,SP1,SLASH,SP1:
                    *+,IANAETHS:
                    *14,*+,ISURGEON,SP1,SLASH,SP1:
                    *+,IANAETHS
          PACK      DIM90,PERITIME,SP2,ISURGEON,SP3,IANAETHS
          GOTO      HDSE6500
.
HDSE6200  MATCH     SP25,ASSSURG
          GOTO      HDSE6300 IF EQUAL
          PRINT     *N,*7,PERITIME,*14,*+,ISURGEON,SP1,SLASH,SP1,*+,ASSSURG,SP1:
                    *14,*+,ISURGEON,SP1,SLASH,SP1,*+,ASSSURG,SP1
          ADD       TWO,CLNO
          PACK      DIM90,PERITIME,SP2,ISURGEON,SP3,ASSSURG
          GOTO      HDSE6500
.
HDSE6300  PRINT     *N,*7,PERITIME,*14,*+,ISURGEON:
                    *14,*+,ISURGEON
          PACK      DIM90,PERITIME,SP2,ISURGEON
.
HDSE6500  MOVELPTR  DIM90,FORM3
          PACK      DIM90,UNDLN20,UNDLN20,UNDLN20,UNDLN20,UNDLN20
          SETLPTR   DIM90,FORM3
          PRINT     *7,*+,DIM90,*N
          ADD       FOUR,CLNO
          GOTO      HDSE9999
.
HDSE9999  RETURN
.
.****************************************************************************
.*                            HDTE0000                                      *
.*                 Print the team sub - heading for option 5                *
.****************************************************************************
.
HDTE0000  BRANCH    OPCNR66A,HDTE9999,HDTE9999,HDTE9999,HDTE9999,HDTE9999:
                             HDTE6000,HDTE6000,HDTE9999,HDTE9999,HDTE9999
          GOTO      HDTE9999
.
.         Report layout 6
.
HDTE6000  COMPARE   CLNO,FIFTY5
          GOTO      HDTE6050 IF NOT LESS
.
          MATCH     ANSN,PAGBREAK
          GOTO      HDTE6010 IF EQUAL
.
          CALL      HEAD132
          CALL      TOPH0000
          CALL      HEAD0000
HDTE6010  CALL      HDPE0000
          CALL      HDTH0000
.
HDTE6050  MATCH     SP25,ASSSURG 
          GOTO      HDTE6100 IF EQUAL
          MATCH     SP25,IANAETHS
          GOTO      HDTE6200 IF EQUAL
          PRINT     *N,*14,*+,ISURGEON,SP1,SLASH,SP1,*+,ASSSURG,SP1:
                    SLASH,SP1,*+,IANAETHS:
                    *14,*+,ISURGEON,SP1,SLASH,SP1,*+,ASSSURG,SP1:
                    SLASH,SP1,*+,IANAETHS
          PACK      DIM90,ISURGEON,SP3,IANAETHS,SP3,ASSSURG
          GOTO      HDTE6500
.
HDTE6100  MATCH     SP25,IANAETHS
          GOTO      HDTE6300 IF EQUAL
          PRINT     *N,*14,*+,ISURGEON,SP1,SLASH,SP1:
                    *+,IANAETHS:
                    *14,*+,ISURGEON,SP1,SLASH,SP1:
                    *+,IANAETHS
          PACK      DIM90,ISURGEON,SP3,IANAETHS
          GOTO      HDTE6500
.
HDTE6200  MATCH     SP25,ASSSURG
          GOTO      HDTE6300 IF EQUAL
          PRINT     *N,*14,*+,ISURGEON,SP1,SLASH,SP1,*+,ASSSURG,SP1:
                    *14,*+,ISURGEON,SP1,SLASH,SP1,*+,ASSSURG,SP1
          ADD       TWO,CLNO
          PACK      DIM90,ISURGEON,SP3,ASSSURG
          GOTO      HDTE6500
.
HDTE6300  PRINT     *N,*14,*+,ISURGEON:
                    *14,*+,ISURGEON
          PACK      DIM90,ISURGEON
.
HDTE6500  MOVELPTR  DIM90,FORM3
          PACK      DIM90,UNDLN20,UNDLN20,UNDLN20,UNDLN20,UNDLN20
          SETLPTR   DIM90,FORM3
          PRINT     *14,*+,DIM90,*N
          ADD       FOUR,CLNO
          GOTO      HDTE9999
.
HDTE9999  RETURN
.
.         
.**********************************************************************
.*                        GASS0000                                    *
.*                 Get the assistant surgeon                          *
.**********************************************************************
GASS0000  MOVE      SP6,DIM6    
          UNPACK    SP70,DCODE1,DCODE2
          MOVE      ZERO,EXIT
          MOVE      ZERO,COUNTER
          MOVE      ZERO,F1
          PACK      ASSSURG,SP20,SP20
          PACK      ASSSURG2,SP20,SP20
          MOVE      SP6,ASSURGCD
          MOVE      SP6,ASSURGC2
.
          BRANCH    DEFAULTF,GASS6000    * not using the default team
.
.         use details from session file -> OPRSESFD
.
GASS1000  ADD       ONE,COUNTER
.
          COMPARE   NINE,COUNTER
          GOTO      GASS9999 IF EQUAL
.
          LOAD      TYPE,COUNTER,OPSETYD1,OPSETYD2,OPSETYD3,OPSETYD4:
                                 OPSETYD5,OPSETYD6,OPSETYD7,OPSETYD8
.
          PACK      TYPE,TYPE,SP3
          MATCH     SP3,TYPE
          GOTO      GASS1000 IF EQUAL
.
          PACK      KEY5,CATOP,TYPE
          CALL      RDCODE1
          BRANCH    OVRCD,GASS1000
.
          MATCH     "A",TCINDC1
          GOTO      GASS1000 IF NOT EQUAL
.
          LOAD      DIM6,COUNTER,OPSEDCC1,OPSEDCC2,OPSEDCC3,OPSEDCC4:
                                   OPSEDCC5,OPSEDCC6,OPSEDCC7,OPSEDCC8
          PACK      KEY6,DIM6
          CALL      RDDOCT1
          BRANCH    OVRCD,GASS1000
.
          ADD       ONE,F1
          BRANCH    F1,GASS2000,GASS3000
          GOTO      GASS9999
.
GASS2000  PACK      KEY6,DCODE
          CALL      RDDOCT1
          MOVE      DCODE,ASSURGCD
          MOVE      DSNAME,PACSNAME
          MOVE      DTITL,PACTITLE
          MOVE      DGNAME,ANS
          PACK      PACGNAME,ANS,DOT
          MOVE      ONE,PACFRMT
          CALL      PACNAME
          CALL      SPFN0000            * Strip trailing blanks off Pacfname
          PACK      ASSSURG,PACFNAME
          GOTO      GASS1000
.
GASS3000  PACK      KEY6,DCODE
          CALL      RDDOCT1
          MOVE      DCODE,ASSURGC2
          MOVE      DSNAME,PACSNAME
          MOVE      DTITL,PACTITLE
          MOVE      DGNAME,ANS
          PACK      PACGNAME,ANS,DOT
          MOVE      ONE,PACFRMT
          CALL      PACNAME
          CALL      SPFN0000            * Strip trailing blanks off Pacfname
          PACK      ASSSURG2,PACFNAME
          GOTO      GASS9999
.
.         Using new tables for details
.
GASS6000  PACK      KEY35,OPSGUNID,OPSGTMNO,SP1,ONE,SP30
          CALL      RSOPTSM1
GASS6500  CALL      RKOPTSM1
          BRANCH    OVRCD,GASS9999
.
          MATCH     OPSGUNID,OPTSUNID
          GOTO      GASS9999 IF NOT EQUAL
.
          MATCH     OPSGTMNO,OPTSTMNO
          GOTO      GASS9999 IF NOT EQUAL
.
          COMPARE   ONE,OPTSSIND
          GOTO      GASS9999 IF NOT EQUAL
.
          PACK      KEY5,CATOP,OPTSSTYP
          CALL      RDCODE1
          BRANCH    OVRCD,GASS6500
.
          MATCH     "A",TCINDC1
          GOTO      GASS6500 IF NOT EQUAL
.
          PACK      KEY6,OPTSSCDE
          CALL      RDDOCT1
          BRANCH    OVRCD,GASS6500
          MOVE      DCODE,DCODE1
.
GASS9999  RETURN
.
.*********************************************************************
.*                         PRBD0000                                  *
.*               Print the report by date                            *
.*********************************************************************
PRBD0000  MOVE      ZERO,SESSTOTL
          MOVE      ZERO,CASETOTL
          MOVE      ZERO,NORECFLG
          MOVE      ZERO,CPAGENO
          MOVE      SP70,OLDCLIN
          MOVE      SP70,OLDTIME
          MOVE      SP70,SKEY26
.
          PACK      KEY22,DATEOFOP,SP20
          CALL      RSOPSES7
PRBD1000  CALL      RKOPSES7
          BRANCH    OVRCD,PRBD8000
.
          MATCH     DATEOFOP,OPSEDATE    * test if correct date
          GOTO      PRBD8000 IF NOT EQUAL
.
          COMPARE   ZERO,OPSESTAT        * test if session is cancelled
          GOTO      PRBD1000 IF EQUAL
.
          PACK      KEY26,OPSEDATE,OPSETIME,OPSECLIN,SP70
          CALL      RSOPDEA6
PRBD2000  CALL      RDEA0000            * read DEA details
          BRANCH    EXIT,PRBD1000
.
          MATCH     SKEY26,KEY26
          IF        !@EQUAL
            ADD       ONE,SESSTOTL
          ENDIF
          MOVE      KEY26,SKEY26
.
          MOVE      ZERO,DEFAULTF
          PACK      KEY10,OPDAUNIQ
          CALL      RDOPARD1
          BRANCH    OVRCD,PRBD2500
.
.***  Get surgical details from oprsrgaf ***
.
          PACK      KEY11,OPDAUNIQ,ONE
          CALL      RDOPSRG1
          BRANCH    OVRCD,PRBD2500
          MOVE      ONE,DEFAULTF
.
PRBD2500  CALL      GOSU0000
          CLEAR     NAME25
          CALL      GPMI0000           * get PMI details
          CALL      SRDS0000           * set-up report descriptions
          ADD       ONE,CASETOTL
.
          COMPARE   ZERO,NORECFLG
          GOTO      PRBD3000 IF EQUAL
.       
          MATCH     ANSN,PAGBREAK
          IF        @EQUAL
             MATCH     OPSECLIN,OLDCLIN
             GOTO      PRBD3100 IF NOT EQUAL
.
             MATCH     OPSETIME,OLDTIME
             GOTO      PRBD3100 IF NOT EQUAL  

             COMPARE   CLNO,FIFTY5        * test if page is full
             GOTO      PRBD4500 IF NOT LESS

             GOTO      PRBD3000
          ENDIF         
.  
          MATCH     OPSECLIN,OLDCLIN
          GOTO      PRBD3000 IF NOT EQUAL
.
          MATCH     OPSETIME,OLDTIME
          GOTO      PRBD3000 IF NOT EQUAL
.
          COMPARE   CLNO,FIFTY5        * test if page is full
          GOTO      PRBD4500 IF NOT LESS
.
PRBD3000  CALL      HEAD132
          CALL      TOPH0000
PRBD3100  IF        CLNO>=50
            GOTO      PRBD3000
          ENDIF
.
          CALL      HEAD0000
.
PRBD4500  CALL      PLNS0000
          MOVE      ONE,NORECFLG
          MOVE      OPSECLIN,OLDCLIN
          MOVE      OPSETIME,OLDTIME
          GOTO      PRBD2000
.
PRBD8000  BRANCH    NORECFLG,PRBD9000
          CALL      HEAD132
          CALL      TOPH0000
          CALL      CLOPRSES
          CALL      HEAD0000
.
PRBD9000  BRANCH    OPCNR66A,PRBD9800,PRBD9800,PRBD9100,PRBD9800,PRBD9800:
                             PRBD9900,PRBD9900,PRBD9800,PRBD9800,PRBD9800
.
PRBD9100  PRINT     *N,*44,"List Approved by : ",*N,*N,*44,UNDLN,*N,*N:
                    *44,"For Medical Administrator"
.
PRBD9800  PRINT     *N,"Number of Sessions  : ",SESSTOTL,*N:
                       "Number of Cases     : ",CASETOTL
PRBD9900  IF         OPCNR66A=9 | OPCNR66A=10
            PRINT     *N,"*** End of Theatre Sessions ***",*N
          ELSE
            PRINT     *N,"*** End of Report ***",*N
          ENDIF

.
PRBD9999  RETURN
.
.*********************************************************************
.*                         PRBT0000                                  *
.*               Print the report by theatre                         *
.*********************************************************************
PRBT0000  MOVE      ZERO,SESSTOTL
          MOVE      ZERO,CASETOTL
          MOVE      ZERO,NORECFLG
          MOVE      ZERO,CPAGENO
          UNPACK    SP70,SKEY22,OLDTIME,OLDCLIN,OLDROOM
          MOVE      "99",CLNO
.
          PACK      KEY30,SP70
          CALL      RSTHET1
PRBT1000  CALL      RKTHET1
          BRANCH    OVRCD,PRBT8000
.
.          PACK      KEY22,DATEOFOP,THETTIME,THETCLIN
.          CALL      RDOPSES1
.          BRANCH    OVRCD,PRBT1000
.
          IF        IBCNMHOS=1
            PACK      KEY22,DATEOFOP,THETTIME,THETCLIN,SP70
            CALL      RSOPSES7
PRBT1200    CALL      RKOPSES7
            BRANCH    OVRCD,PRBT1000
.
            MATCH     DATEOFOP,OPSEDATE    * check date
            GOTO      PRBT1000 IF NOT EQUAL
.
            MATCH     THETTIME,OPSETIME    * check time
            GOTO      PRBT1000 IF NOT EQUAL
.
            MATCH     THETCLIN,OPSECLIN    * check clinic
            GOTO      PRBT1000 IF NOT EQUAL
.
            MATCH     SP70,HOSCODE            * All Hospitals
            IF        !@EQUAL
              MATCH     OPSEHOSP,HOSCODE      * Correct hospital
              GOTO      PRBT1200 IF NOT EQUAL
            ENDIF
          ELSE 
            PACK      KEY22,DATEOFOP,THETTIME,THETCLIN,SP70
            CALL      RDOPSES7
            BRANCH    OVRCD,PRBT1000
          ENDIF
.
          COMPARE   ZERO,OPSESTAT        * test if session is cancelled
          GOTO      PRBT1000 IF EQUAL
.
          PACK      KEY10,THETUNIQ,SP70
          CALL      RDOPDEA3
          BRANCH    OVRCD,PRBT1000
.
          MATCH     SKEY22,KEY22
          IF        !@EQUAL
            ADD       ONE,SESSTOTL
          ENDIF
          MOVE      KEY22,SKEY22
.
          MOVE      OPDAADMN,KEY8
          CALL      RDBKREC1
          CALL      RDBKRX11
.
          MOVE      ZERO,DEFAULTF
          PACK      KEY10,OPDAUNIQ
          CALL      RDOPARD1
          BRANCH    OVRCD,PRBT2500
.
.***  Get surgical details from oprsrgaf ***
.
          PACK      KEY11,OPDAUNIQ,ONE
          CALL      RDOPSRG1
          BRANCH    OVRCD,PRBT2500
          MOVE      ONE,DEFAULTF
.
PRBT2500  CALL      GOSU0000
          CLEAR     NAME25
          CALL      GPMI0000           * get PMI details
          CALL      SRDS0000           * set-up report descriptions
          ADD       ONE,CASETOTL
.
          COMPARE   ZERO,NORECFLG
          GOTO      PRBT3000 IF EQUAL
.
          MATCH     ANSN,PAGBREAK
          IF        @EQUAL
             COMPARE   CLNO,FIFTY5        * test if page is full
             GOTO      PRBT4500 IF NOT LESS

             MATCH     THETCLIN,OLDCLIN
             GOTO      PRBT3100 IF NOT EQUAL
.
             MATCH     THETTIME,OLDTIME
             GOTO      PRBT3100 IF NOT EQUAL
.
             MATCH     THETROOM,OLDROOM
             GOTO      PRBT3100 IF NOT EQUAL

             GOTO      PRBT3000
          ENDIF
.
          MATCH     THETTIME,OLDTIME
          GOTO      PRBT3000 IF NOT EQUAL

.
          MATCH     THETCLIN,OLDCLIN
          GOTO      PRBT3000 IF NOT EQUAL
.
          MATCH     THETROOM,OLDROOM
          GOTO      PRBT3000 IF NOT EQUAL
.
          COMPARE   CLNO,FIFTY5        * test if page is full
          GOTO      PRBT4500 IF NOT LESS
.
PRBT3000  CALL      HEAD132
          CALL      TOPH0000
PRBT3100  IF        CLNO>=50
            GOTO      PRBT3000 
          ENDIF
.
          CALL      HEAD0000
.
PRBT4500  CALL      PLNS0000
          MOVE      THETTIME,OLDTIME
          MOVE      THETROOM,OLDROOM
          MOVE      THETCLIN,OLDCLIN
          MOVE      ONE,NORECFLG
          GOTO      PRBT1000
.
PRBT8000  BRANCH    NORECFLG,PRBT9000
          CALL      HEAD132
          CALL      TOPH0000
          CALL      CLOPRSES
          CALL      HEAD0000
.
PRBT9000  BRANCH    OPCNR66A,PRBT9800,PRBT9800,PRBT9100,PRBT9800,PRBT9800:
                             PRBT9900,PRBT9900,PRBT9800,PRBT9800,PRBT9800
.
PRBT9100  PRINT     *N,*44,"List Approved by : ",*N,*N,*44,UNDLN,*N,*N:
                    *44,"For Medical Administrator"
.
PRBT9800  PRINT     *N,"Number of Sessions  : ",SESSTOTL,*N:
                       "Number of Cases     : ",CASETOTL
PRBT9900  IF         OPCNR66A=9 | OPCNR66A=10
            PRINT     *N,"*** End of Theatre Sessions ***",*N
          ELSE
            PRINT     *N,"*** End of Report ***",*N
          ENDIF
.
PRBT9999  RETURN
.
.
.*********************************************************************
.*                         PRBS0000                                  *
.*               Print the report by surgeon                         *
.*********************************************************************
.
PRBS0000  MOVE      ZERO,SESSTOTL
          MOVE      ZERO,CASETOTL
          MOVE      ZERO,NORECFLG
          MOVE      ZERO,CPAGENO
          UNPACK    SP70,SKEY22,OLDTIME,OLDCLIN,OLDROOM
.
          PACK      KEY28,SP20,SP10
          CALL      RSSURG1
PRBS1000  CALL      RKSURG1
          BRANCH    OVRCD,PRBS8000
.
.          PACK      KEY22,DATEOFOP,SURGTIME,SURGCLIN
.          CALL      RDOPSES1
.          BRANCH    OVRCD,PRBS1000
.
          IF        IBCNMHOS=1
            PACK      KEY22,DATEOFOP,SURGTIME,SURGCLIN,SP70
            CALL      RSOPSES7
PRBS1200    CALL      RKOPSES7
            BRANCH    OVRCD,PRBS1000
.
            MATCH     DATEOFOP,OPSEDATE    * check date
            GOTO      PRBS1000 IF NOT EQUAL
.
            MATCH     SURGTIME,OPSETIME    * check time
            GOTO      PRBS1000 IF NOT EQUAL
.
            MATCH     SURGCLIN,OPSECLIN    * check clinic
            GOTO      PRBS1000 IF NOT EQUAL
.
            MATCH     SP70,HOSCODE            * All Hospitals
            IF        !@EQUAL
              MATCH     OPSEHOSP,HOSCODE      * Correct hospital
              GOTO      PRBS1200 IF NOT EQUAL
            ENDIF
          ELSE
            PACK      KEY22,DATEOFOP,SURGTIME,SURGCLIN,SP70
            CALL      RDOPSES7
            BRANCH    OVRCD,PRBS1000
          ENDIF
.
          COMPARE   ZERO,OPSESTAT        * test if session is cancelled
          GOTO      PRBS1000 IF EQUAL
.
          MATCH     SP70,SURGADMN              * Session without patient?
          GOTO      PRBS7000 IF EQUAL          * Yes,print empty session 
.    
          PACK      KEY31,SURGADMN,SURGSTAT,DATEOFOP,SURGTIME,SURGCLIN,SURGCASE
          CALL      RDOPDEA2
          BRANCH    OVRCD,PRBS1000
.
          MATCH     SKEY22,KEY22
          IF        !@EQUAL
            ADD       ONE,SESSTOTL
          ENDIF
          MOVE      KEY22,SKEY22
.
          MOVE      OPDAADMN,KEY8
          CALL      RDBKREC1
          CALL      RDBKRX11
.
          MOVE      ZERO,DEFAULTF
          PACK      KEY10,OPDAUNIQ
          CALL      RDOPARD1
          BRANCH    OVRCD,PRBS2500
.
.***  Get surgical details from oprsrgaf ***
.
          PACK      KEY11,OPDAUNIQ,ONE
          CALL      RDOPSRG1
          BRANCH    OVRCD,PRBS2500
          MOVE      ONE,DEFAULTF
.
PRBS2500  MOVE      SURGCODE,DOCTOR
          CLEAR     NAME25
          CALL      GPMI0000           * get PMI details
          CALL      SRDS0000           * set-up report descriptions
          ADD       ONE,CASETOTL
.
          COMPARE   ZERO,NORECFLG
          GOTO      PRBS3000 IF EQUAL
.
          MATCH     ANSN,PAGBREAK
          IF        @EQUAL
             COMPARE   CLNO,FIFTY5        * test if page is full
             GOTO      PRBS4500 IF NOT LESS

             MATCH     SURGTIME,OLDTIME
             GOTO      PRBS3100 IF NOT EQUAL
.
             MATCH     SURGCLIN,OLDCLIN
             GOTO      PRBS3100 IF NOT EQUAL

             GOTO      PRBS3000
          ENDIF
.
          MATCH     SURGTIME,OLDTIME
          GOTO      PRBS3000 IF NOT EQUAL
.
          MATCH     SURGCLIN,OLDCLIN
          GOTO      PRBS3000 IF NOT EQUAL
.
          MATCH     SURGCODE,OLDROOM
          GOTO      PRBS3000 IF NOT EQUAL
.
          COMPARE   CLNO,FIFTY5        * test if page is full
          GOTO      PRBS4500 IF NOT LESS
.
PRBS3000  CALL      HEAD132
          CALL      TOPH0000
PRBS3100  IF        CLNO>50
            GOTO      PRBS3000
          ENDIF
.
          CALL      HEAD0000
.
PRBS4500  CALL      PLNS0000
          MOVE      ONE,NORECFLG
          MOVE      SURGTIME,OLDTIME
          MOVE      SURGCODE,OLDROOM
          MOVE      SURGCLIN,OLDCLIN
          GOTO      PRBS1000
.
.  Print Session details without patients - empty session
.
PRBS7000  COMPARE   ZERO,SESSTOTL            * Previous session has data?
          GOTO      PRBS7500 IF EQUAL        * No, print empty session summary
                                             * Yes, print previous session data
                                             * then print the empty session
. 
          BRANCH    OPCNR66A,PRBS7080,PRBS7080,PRBS7010,PRBS7080,PRBS7080:
                             PRBS7090,PRBS7090,PRBS7080,PRBS7080,PRBS7080
.
PRBS7010  PRINT     *N,*44,"List Approved by : ",*N,*N,*44,UNDLN,*N,*N:
                    *44,"For Medical Administrator"
.
PRBS7080  PRINT     *N,"Number of Sessions  : ",SESSTOTL,*N:
                       "Number of Cases     : ",CASETOTL
PRBS7090  IF         OPCNR66A=9 | OPCNR66A=10
            PRINT     *N,"*** End of Theatre Sessions ***",*N
          ELSE
            PRINT     *N,"*** End of Report ***",*N
          ENDIF
.
PRBS7500  CALL      HEAD132
          CALL      TOPH0000
          CALL      HEAD0000
          MOVE      ZERO,SESSTOTL
          MOVE      ZERO,CASETOTL 
          BRANCH    OPCNR66A,PRBS7580,PRBS7580,PRBS7510,PRBS7580,PRBS7580:
                             PRBS7590,PRBS7590,PRBS7580,PRBS7580,PRBS7580
.
PRBS7510  PRINT     *N,*44,"List Approved by : ",*N,*N,*44,UNDLN,*N,*N:
                    *44,"For Medical Administrator"
.
PRBS7580  PRINT     *N,"Number of Sessions  : ",SESSTOTL,*N:
                       "Number of Cases     : ",CASETOTL
PRBS7590  IF         OPCNR66A=9 | OPCNR66A=10
            PRINT     *N,"*** End of Theatre Sessions ***",*N
          ELSE
            PRINT     *N,"*** End of Report ***",*N
          ENDIF

          GOTO      PRBS1000                   * Get next temp record 
.
PRBS8000  COMPARE   ZERO,SESSTOTL              * No sessions for the day?
          GOTO      PRBS9999 IF EQUAL          * Yes, then do not print
.
          BRANCH    NORECFLG,PRBS9000
          CALL      HEAD132
          CALL      TOPH0000
          CALL      CLOPRSES                
          CALL      HEAD0000
.
PRBS9000  BRANCH    OPCNR66A,PRBS9800,PRBS9800,PRBS9100,PRBS9800,PRBS9800:
                             PRBS9900,PRBS9900,PRBS9800,PRBS9800,PRBS9800
.
PRBS9100  PRINT     *N,*44,"List Approved by : ",*N,*N,*44,UNDLN,*N,*N:
                    *44,"For Medical Administrator"
.
PRBS9800  PRINT     *N,"Number of Sessions  : ",SESSTOTL,*N:
                       "Number of Cases     : ",CASETOTL
PRBS9900  IF         OPCNR66A=9 | OPCNR66A=10
            PRINT     *N,"*** End of Theatre Sessions ***",*N
          ELSE
            PRINT     *N,"*** End of Report ***",*N
          ENDIF
.
PRBS9999  RETURN
.
.
.*********************************************************************
.*                         PRBC0000                                  *
.*               Print the report by surgeon                         *
.*********************************************************************
.
PRBC0000  MOVE      ZERO,SESSTOTL
          MOVE      ZERO,CASETOTL
          MOVE      ZERO,NORECFLG
          MOVE      ZERO,CPAGENO
          UNPACK    SP70,SKEY22,OLDTIME,OLDCLIN,OLDROOM
.
          PACK      KEY22,SP20,SP10
          CALL      RSCLIN1
PRBC1000  CALL      RKCLIN1
          BRANCH    OVRCD,PRBC8000
.
.          PACK      KEY22,DATEOFOP,CLINTIME,CLINCODE
.          CALL      RDOPSES1
.          BRANCH    OVRCD,PRBC1000
.
          IF        IBCNMHOS=1
            PACK      KEY22,DATEOFOP,CLINTIME,CLINCODE,SP70
            CALL      RSOPSES7
PRBC1200    CALL      RKOPSES7
            BRANCH    OVRCD,PRBC1000
.
            MATCH     DATEOFOP,OPSEDATE    * check date
            GOTO      PRBC1000 IF NOT EQUAL
.
            MATCH     CLINTIME,OPSETIME    * check time
            GOTO      PRBC1000 IF NOT EQUAL
.
            MATCH     CLINCODE,OPSECLIN    * check clinic
            GOTO      PRBC1000 IF NOT EQUAL
.
            MATCH     SP70,HOSCODE            * All Hospitals
            IF        !@EQUAL
              MATCH     OPSEHOSP,HOSCODE      * Correct hospital
              GOTO      PRBC1200 IF NOT EQUAL
            ENDIF
          ELSE
            PACK      KEY22,DATEOFOP,CLINTIME,CLINCODE,SP70
            CALL      RDOPSES7
            BRANCH    OVRCD,PRBC1000
          ENDIF
.
          COMPARE   ZERO,OPSESTAT        * test if session is cancelled
          GOTO      PRBC1000 IF EQUAL
.
          PACK      KEY31,CLINADMN,CLINSTAT,DATEOFOP,CLINTIME,CLINCODE,CLINCASE
          CALL      RDOPDEA2
          BRANCH    OVRCD,PRBC1000
.
          MATCH     SKEY22,KEY22
          IF        !@EQUAL
            ADD       ONE,SESSTOTL
          ENDIF
          MOVE      KEY22,SKEY22
.
          MOVE      OPDAADMN,KEY8
          CALL      RDBKREC1
          CALL      RDBKRX11
.
          MOVE      ZERO,DEFAULTF
          PACK      KEY10,OPDAUNIQ
          CALL      RDOPARD1
          BRANCH    OVRCD,PRBC2500
.
.***  Get surgical details from oprsrgaf ***
.
          PACK      KEY11,OPDAUNIQ,ONE
          CALL      RDOPSRG1
          BRANCH    OVRCD,PRBC2500
          MOVE      ONE,DEFAULTF
.
PRBC2500  CALL      GOSU0000           * get operating surgeon
          CLEAR     NAME25
          CLEAR     NAME40
          CALL      GPMI0000           * get PMI details
          CALL      SRDS0000           * set-up report descriptions
          ADD       ONE,CASETOTL
.
          COMPARE   ZERO,NORECFLG
          GOTO      PRBC3000 IF EQUAL
.
          MATCH     ANSN,PAGBREAK
          IF        @EQUAL
             COMPARE   CLNO,FIFTY5         * test if page is full
             GOTO      PRBC4500 IF NOT LESS

             MATCH     CLINTIME,OLDTIME
             GOTO      PRBC3100 IF NOT EQUAL
.
             MATCH     CLINCODE,OLDCLIN
             GOTO      PRBC3100 IF NOT EQUAL

             GOTO      PRBC3000
          ENDIF
.
          MATCH     CLINTIME,OLDTIME
          GOTO      PRBC3000 IF NOT EQUAL
.
          MATCH     CLINCODE,OLDCLIN
          GOTO      PRBC3000 IF NOT EQUAL
.
          MATCH     CLINCODE,OLDROOM
          GOTO      PRBC3000 IF NOT EQUAL
.
          COMPARE   CLNO,FIFTY5        * test if page is full
          GOTO      PRBC4500 IF NOT LESS
.
PRBC3000  CALL      HEAD132
          CALL      TOPH0000
PRBC3100  IF        CLNO>=50
            GOTO      PRBC3000
          ENDIF
.
          CALL      HEAD0000
.
PRBC4500  CALL      PLNS0000
          MOVE      CLINTIME,OLDTIME
          MOVE      CLINCODE,OLDROOM
          MOVE      CLINCODE,OLDCLIN
          MOVE      ONE,NORECFLG
          GOTO      PRBC1000
.
PRBC8000  BRANCH    NORECFLG,PRBC9000
          CALL      HEAD132
          CALL      TOPH0000
          CALL      CLOPRSES
          CALL      HEAD0000
.
PRBC9000  BRANCH    OPCNR66A,PRBC9800,PRBC9800,PRBC9100,PRBC9800,PRBC9800:
                             PRBC9900,PRBC9900,PRBC9800,PRBC9800,PRBC9800
.
PRBC9100  PRINT     *N,*44,"List Approved by : ",*N,*N,*44,UNDLN,*N,*N:
                    *44,"For Medical Administrator"
.
PRBC9800  PRINT     *N,"Number of Sessions  : ",SESSTOTL,*N:
                       "Number of Cases     : ",CASETOTL
PRBC9900  IF         OPCNR66A=9 | OPCNR66A=10
            PRINT     *N,"*** End of Theatre Sessions ***",*N
          ELSE
            PRINT     *N,"*** End of Report ***",*N
          ENDIF
.
          GOTO      PRBC9999
.
PRBC9999  RETURN
.
.*********************************************************************
.*                        RDEA0000                                   *
.*                  Read the DEA file                                *
.*********************************************************************
.
RDEA0000  MOVE      ZERO,EXIT
RDEA1000  CALL      RKOPDEA6
          BRANCH    OVRCD,RDEA9000
.
          IF        IBCNMHOS=1
            MATCH     SP70,HOSCODE            * All Hospitals
            IF        !@EQUAL
              MATCH     OPSEHOSP,HOSCODE    * Correct hospital
              GOTO      RDEA1000 IF NOT EQUAL
            ENDIF
          ENDIF
.
          MATCH     OPSEDATE,OPDADATE
          GOTO      RDEA9000 IF NOT EQUAL
.
          MATCH     OPSECLIN,OPDACLIN
          GOTO      RDEA9000 IF NOT EQUAL
.
          MATCH     OPSETIME,OPDATIME
          GOTO      RDEA9000 IF NOT EQUAL
.
          COMPARE   THREE,OPDASTAT        * test if session is cancelled
          GOTO      RDEA0000 IF EQUAL
.
          GOTO      RDEA9999

RDEA9000  MOVE      ONE,EXIT
.
RDEA9999  RETURN
.
.*********************************************************************
.*                         TOPH0000                                  *
.*                 Print the report heading                          *
.*********************************************************************
.
TOPH0000  BRANCH    MOPTION,TOPH1000,TOPH2000,TOPH3000,TOPH4000,TOPH4500
.
.***** Heading for report by date ******
.
TOPH1000  PRINT     *40,"For Operations on",*63,": ",REPDATE
          ADD       ONE,CLNO
          GOTO      TOPH9000
.
.***** Heading for report by theatre ******
.
TOPH2000  PRINT     *40,"For Operations on",*63,": ",REPDATE,*N:
                    *40,OPCNODSC,*56,"from   : ",STHET,*74,STHEDESC,*N:
                    *56,"to     : ",ETHET,*74,ETHEDESC,*N
          ADD       TWO,CLNO
          GOTO      TOPH9000
.
.***** Heading for report by surgeon ******
.
TOPH3000  PRINT     *40,"For Operations on",*63,": ",REPDATE,*N:
                    *40,"Operating Surgeon from : ",SSURG,*74,SSURDESC,*N:
                    *58,"to   : ",ESURG,*74,ESURDESC,*N
          ADD       TWO,CLNO
          GOTO      TOPH9000
.
.***** Heading for report by clinic ******
.
TOPH4000  PRINT     *40,"For Operations on",*63,": ",REPDATE,*N:
                    *40,OPCNCDSC,*56,"from   : ",SCLIN,*74,SCLIDESC,*N:
                    *56,"to     : ",ECLIN,*74,ECLIDESC,*N
          ADD       TWO,CLNO
          GOTO      TOPH9000
.
.***** Heading for report by period/theatre session ******
.
TOPH4500  PRINT     *40,"For Operations on",*63,": ",REPDATE,*N:
                    *N,*40,"Period from   : ",STARTPER,*N: 
                    *49,"to   : ",ENDPERI,*N
          ADD       TWO,CLNO
          GOTO      TOPH9000
.
TOPH9000  IF        IBCNMHOS=1
            ADD       ONE,CLNO
            PRINT     *40,"Hospital Id ",*63,": ",PTHSNAME
            ADD       ONE,CLNO
          ENDIF
          GOTO      TOPH9999
.
TOPH9999  RETURN
.                                
.*********************************************************************
.*                         HEAD0000                                  *
.*                 Print the report heading                          *
.*********************************************************************
HEAD0000  BRANCH    OPCNR66A,HEAD1000,HEAD2000,HEAD3000,HEAD4000,HEAD5000:
                             HEAD6000,HEAD6000,HEAD8000,HEAD9000,HEAD9000
.
.****** Report layout 1  - heading ******
.
HEAD1000  CALL      SUSD0000             * set up session details
          PRINT     *N:
                    *10,OPCNODSC,*26,": ",OPSETHET,SP2,OPRMDESC,*N:
                    *10,"Session Time",*26,": ",OPSETIME,"-",OPSEENDT:
                    *72,"Start Time",*86,":",*90,OPSEACTS,*104,"End Time":
                    *115,":",*120,OPSEACTE,*N:
                    *10,"Session Type",*26,": ",TDESC,*72:
                    "Overtime Code :",OPSEOVER,*104,"Delay Code :",OPSEDELA,*N:
                    *10,OPCNCDSC,*26,": ",SESSCLIN;
          BRANCH    OPCNSESS,HEAD1200
          PRINT     " ",*N
          GOTO      HEAD1400
.
HEAD1200  PRINT     *72,"Sess'n Co-ord.  : ",SESSCORD,*N
.
HEAD1400  ADD       FIVE,CLNO 
          PRINT     EQUAL50,EQUAL50,EQUAL32,*N:
                    "Patient",*30,"Adm No.",*39,"Case",*45,"Age":
                    *50,"Sex",*58,"Surgeon / Anaesthetist":
                    *93,"Provs Code",*108,"Actl Code":
                    *119,"Special Charge"
          CALL      UND132
          ADD       FOUR,CLNO
          GOTO      HEAD9999
.
.****** Report layout 2  - heading ******
.
HEAD2000  CALL      SUSD0000             * set up session details
          PRINT     *N:
                    *10,OPCNODSC,*26,": ",OPSETHET,SP2,OPRMDESC,*N:
                    *10,"Session Time",*26,": ",OPSETIME,"-",OPSEENDT:
                    *72,"Start Time",*86,":",*90,OPSEACTS,*104,"End Time":
                    *115,":",*120,OPSEACTE,*N:
                    *10,"Session Type",*26,": ",TDESC,*72:
                    "Overtime Code :",OPSEOVER,*104,"Delay Code :",OPSEDELA,*N:
                    *10,OPCNCDSC,*26,": ",SESSCLIN;
          BRANCH    OPCNSESS,HEAD2200
          PRINT     " ",*N
          GOTO      HEAD2400
.
HEAD2200  PRINT     *72,"Sess'n Co-ord.  : ",SESSCORD,*N
.
HEAD2400  ADD       FIVE,CLNO 
          PRINT     EQUAL50,EQUAL50,EQUAL32,*N:
                    "Patient",*28,"Ward/Bed",*38,"Case",*44,"Age":
                    *49,"Sex",*56,"Adm Date",*67,"Provs Code":
                    *79,"Anaesthetic",*103,"Operation Description"
          CALL      UND132
          ADD       THREE,CLNO 
          GOTO      HEAD9999
.
.****** Report layout 3  - heading ******
.
HEAD3000  CALL      SUSD0000             * set up session details
          PRINT     *N:
                    *10,OPCNODSC,*26,": ",OPSETHET,SP2,OPRMDESC:
                   *72,"Session Time",*88,": ",OPSETIME,"-",OPSEENDT,*N:
                    *10,OPCNCDSC,*26,": ",SESSCLIN:
                    *72,"Session Type",*88,": ",TDESC,*N 
          BRANCH    OPCNSESS,HEAD3200
          GOTO      HEAD3400
.
HEAD3200  PRINT     *10,"Sess'n Co-ord.  : ",SESSCORD,*N
.
HEAD3400  ADD       FOUR,CLNO 
          PRINT     EQUAL50,EQUAL50,EQUAL32,*N:
                    "Patient",*28,"Ward/Bed",*38,"Case":
                    *44,"Category",*56,"Operation Type":
                    *77,"Anaesthetic",*101,"Operation Description" 
          CALL      UND132
          ADD       THREE,CLNO 
          GOTO      HEAD9999
.
.****** Report layout 4  - heading ******
.
HEAD4000  CALL      SUSD0000             * set up session details
          PRINT     *N:
                    *10,OPCNODSC,*26,": ",OPSETHET,SP2,OPRMDESC,*N:
                    *10,"Session Time",*26,": ",OPSETIME,"-",OPSEENDT,*N:
                    *10,"Session Type",*26,": ",TDESC,*N:
                    *10,OPCNCDSC,*26,": ",SESSCLIN;
          BRANCH    OPCNSESS,HEAD4200
          PRINT     *72,"Anaesthetist    : ",SESSCORD
          GOTO      HEAD4400
.
HEAD4200  PRINT     *72,"Sess'n Co-ord.  : ",SESSCORD
.
HEAD4400  COMPARE   ONE,OPCNUSAN                  * using 2nd anaesthetist?
          GOTO      HEAD4500 IF NOT EQUAL
          PRINT     *72,OPCNDSAN,*88,": ",ANAETWOD
.
HEAD4500  PRINT     *N;
          ADD       FIVE,CLNO 
          PRINT     EQUAL50,EQUAL50,EQUAL32,*N:
                    "Patient",*28,"Ward/Bed",*38,"Case",*44,"Age":
                    *48,"Sex",*52,"Dur",*56,"Adm Date":
                    *67,"Operation Description"
          CALL      UND132
          ADD       THREE,CLNO 
          GOTO      HEAD9999
.
.         heading for report layout 5 - Modbury
.
HEAD5000  CALL      SUSD0000                * set up session details
          PRINT     *N,*10,OPCNODSC,*26,": ",OPSETHET,SP2,OPRMDESC:
                    *80,"Session Time : ",OPSETIME," - ",OPSEENDT:
                    *N,*10,OPCNCDSC,*26,": ",SESSCLIN:
                    *80,"Session Type : ",TDESC
.
          IF        OPCNSESS=1
            PRINT   *10,"Sess'n Co-ord.  : ",SESSCORD
          ELSE
            PRINT   *10,"Anaesthetist    : ",SESSCORD
          ENDIF
.
          PRINT     *N,EQUAL50,EQUAL50,EQUAL32:
                    *N,"Patient",*28,"Ward/Bed  Case  Category    ":
                    "Operation Type       Anaesthetic",*105,"Post Op Ward"
          CALL      UND132
          MOVE      "15",CLNO
          GOTO      HEAD9999
.
.------   Report layout 6 - St Andrews Ipswich -----
.
HEAD6000  CALL      UND132
          PRINT     "Start Doctor's Name/Patients Name   Admn No. Age  ":
                    "Operation",*107,"Anaesthetic",*120,"Ward    Admit",*N:
                    "Time",*120,"Bed",*129,"Time"
          CALL      UND132
          ADD       SIX,CLNO
          GOTO      HEAD9999
.
.****** Report layout 8  - heading ******
.
HEAD8000  CALL      SUSD0000                * set up session details
          UNPACK    SESSCLIN,KEY30
          PRINT     *N:
                    *1,OPCNODSC,*16,": ",OPSETHET,SP2,OPRMDESC,*N:
                    *1,"Session Time",*16,": ",OPSETIME," to ",OPSEENDT:
                    *48,"Session Type : ",TDESC,*N:
                    *1,OPCNCDSC,*16,": ",KEY30;
.
          UNPACK    SESSCORD,KEY30
          PRINT     *48,"Anaesthetist : ",KEY30;
.
          PRINT     *95,"Assistant : ",ASSSURG
.
          MATCH     SP70,ASSSURG2
          IF        !@EQUAL
            PRINT     *107,ASSSURG2
          ELSE
            PRINT     "  "
          ENDIF
.
          MOVE      "  1",KEY3
          PACK      KEY25,OPSEDATE,OPSETIME,OPSECLIN,KEY3,OPSEHOSP,SP70
          CALL      RDOPCOM1
          IF        OVRCD=0
            PRINT     *1,"Session Comments : ",OPCMTEXT
          ENDIF
.
          ADD       FIVE,CLNO
          PRINT     EQUAL50,EQUAL50,EQUAL32,*N:
                    *1,"No.",*4,"Time",*9,"Patient Name":
                    *64,"Description",*110,"IntendedStay",*123,"Admit Date":
                    *N,*110,"    Ward/Bed",*123,"Admit Time"
          CALL      UND132
          ADD       THREE,CLNO
          GOTO      HEAD9999
.
.****** Report layout 9  - heading ******
.
HEAD9000  CALL      SUSD0000                * set up session details
          UNPACK    SESSCLIN,KEY30
          PRINT     *N:
                    *1,OPCNODSC,*16,": ",OPSETHET,SP2,OPRMDESC,*N:
                    *1,"Session Time",*16,": ",OPSETIME," to ",OPSEENDT:
                    *48,"Session Type : ",TDESC,*N:
                    *1,OPCNCDSC,*16,": ",KEY30;
.
          UNPACK    SESSCORD,KEY30
          PRINT     *48,"Anaesthetist : ",KEY30;
.
          PRINT     *95,"Assistant : ",ASSSURG
.
          MATCH     SP70,ASSSURG2
          IF        !@EQUAL
            PRINT     *107,ASSSURG2
          ELSE
            PRINT     "  "
          ENDIF
.
          MOVE      "  1",KEY3
          PACK      KEY25,OPSEDATE,OPSETIME,OPSECLIN,KEY3,OPSEHOSP,SP70
          CALL      RDOPCOM1
          IF        OVRCD=0
            PRINT     *1,"Session Comments : ",OPCMTEXT
          ELSE
            PACK      KEY25,OPSEDATE,OPSETIME,OPSECLIN,KEY3,SP70
            CALL      RDOPCOM1              * Pre V10.13 day comments
            IF        OVRCD=0
              PRINT     *1,"Session Comments : ",OPCMTEXT
            ENDIF
          ENDIF
.
          ADD       FIVE,CLNO
          PRINT     EQUAL50,EQUAL50,EQUAL32,*N:
                    *1,"No.",*4,"Time",*9,"Patient Name":
                    *64,"Description",*110,"IntendedStay",*123,"Admit Date":
                    *N,*110,"    Ward/Bed",*123,"Admit Time":
                    *N,*117,"Post Op Ward/Bed":
                    *N,*108,"Fasting Time / Fluid Time"
          CALL      UND132
          ADD       FIVE,CLNO
          GOTO      HEAD9999
.
HEAD9999  RETURN
.
.*********************************************************************
.*                        SUSD0000                                   *
.*                 Set up session detail descriptions                *
.*********************************************************************
.
.         For option 2 only, the theatre code will be theatre of the patient,
.         not the session.
.
SUSD0000  LOAD      OPSETHET,MOPTION,OPSETHET,THETROOM
.
          CLEAR     OPRMDESC
          PACK      KEY6,OPSETHET,SP6
          CALL      RDOPOPR1
.
          CALL      GANA0000
          CALL      RDDOCT1
          BRANCH    OVRCD,SUSD0500
.
          CALL      FDOC0000
          MOVE      PACFNAME,SESSCORD
.
. get the 2nd anaesthetist description if turned on
.
SUSD0500  COMPARE   ONE,OPCNUSAN 
          GOTO      SUSD1000 IF NOT EQUAL
.
          CLEAR     ANAETWOD
          PACK      KEY6,OPSEXDOC
          CALL      RDDOCT1
          BRANCH    OVRCD,SUSD1000
.
          CALL      FDOC0000
          MOVE      PACFNAME,ANAETWOD
.
SUSD1000
          CLEAR     SESSCLIN
          BRANCH    OPCNCLSU,SUSD2000
.
          PACK      KEY6,OPSECLIN
          CALL      RDOPCLI1
          BRANCH    OVRCD,SUSD9999
.
          MOVE      OPCLDESC,SESSCLIN
.
          MATCH     OPCLDOCT,SP70
          GOTO      SUSD9999 IF EQUAL
          GOTO      SUSD3000
.
SUSD2000
          MOVE      OPSECLIN,OPCLDOCT
.
SUSD3000
          CLEAR     SESSCLIN
          PACK      KEY6,OPCLDOCT
          CALL      RDDOCT1
          BRANCH    OVRCD,SUSD9999
.
          CALL      FDOC0000
          MOVE      PACFNAME,SESSCLIN
          
SUSD9999  CLEAR     TDESC
          MATCH     SP70,OPSETYPE
          IF        !@EQUAL
            PACK      KEY5,CATST,OPSETYPE
            CALL      RDCODE1
          ENDIF
          RETURN
.
.
.********************************************************************
.*                        GPMI0000                                  *
.*                      Get patient name                            *
.********************************************************************
GPMI0000  MOVE      OPDAADMN,AADMNO
          MOVE      TWO,PACFRMT
          UNPACK    SP20,ADATE,ATIME,ACLAIM,AFUNDH
          UNPACK    SP20,PTMIXWRD,PTMIEBED
          MOVE      ZERO,ASTAT
.
          PACK      KEY8,AADMNO
          CALL      RDMISS1              * read admiisions file
          BRANCH    OVRCD,GPMI5000       * if not there try booking file
.
          MATCH     ZEROUR,AURNO         * test if u/r is 0
          GOTO      GPMI7000 IF EQUAL    * read pre-ad file if zero
.
.----- Valid read on the admissions file & u/r os not zero
.
          PACK      KEY8,AURNO
          CALL      RDMAST1              * read master file
          BRANCH    OVRCD,GPMI9500       * error if over
.
          CALL      RDPMPX21             * read master ext 2 file
          BRANCH    OVRCD,GPMI9500       * error if over
.
          GOTO      GPMI9000             * set up name
.
.--- try bookings file
.
GPMI5000  PACK      KEY8,OPDAADMN
          CALL      RDBKREC1             * read bookings file
          BRANCH    OVRCD,GPMI9500
.
          MOVE      BKREURNO,AURNO       * read master file
.
          MATCH     ZEROUR,BKREURNO      * test if u/r is zero
          GOTO      GPMI6900 IF EQUAL    * read pre-ad file if zero
.
          MOVE      BKREEDAT,ADATE
          MOVE      BKREATIM,ATIME
          MOVE      BKRECLMT,ACLAIM
.
          PACK      KEY8,AURNO
          CALL      RDMAST1              * read master file
          BRANCH    OVRCD,GPMI9500       * error if over
.
          CALL      RDPMPX21             * read master ext 2 file
          BRANCH    OVRCD,GPMI9500       * error if over
.
          MOVE      PFUNDH,AFUNDH
          GOTO      GPMI9000             * set up name
.
GPMI6900  MOVE      BKREBOOK,AADMNO
.
.----  Read the pre-addmissions file 
.
GPMI7000  PACK      KEY8,AADMNO
          CALL      RDPRAM1
          BRANCH    OVRCD,GPMI9500
          MOVE      PFUNDH,AFUNDH
.
GPMI9000  MOVE      PSNAME,PACSNAME
          MOVE      PGNAME,PACGNAME
          MOVE      PTITL,PACTITLE
.
          UNPACK    PBDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          MOVE      CPCDATE,DISPLDOB
.
          CALL      PACNAME
          MOVE      PACFNAME,NAME25
          MOVE      PACFNAME,NAME40
          GOTO      GPMI9999
.
GPMI9500  MOVE      SP3,ATYPE
          MOVE      ZEROUR,AURNO
          MOVE      SP8,ADATE
          MOVE      "** Missing PMI details **",NAME25
          CLEAR     PSEX
          MOVE      DATEOFOP,PBDATE
          MOVE      ZERO,PSAGE
          MOVE      SP70,DISPLDOB
.
GPMI9999  RETURN
.
.**********************************************************************
.*                         PLNS0000                                   *
.*                  Print the report lines                            *
.**********************************************************************
PLNS0000  PACK      SP18,SP20
          BRANCH    OPCNR66A,PLNS1000,PLNS2000,PLNS3000,PLNS4000,PLNS5000:
                             PLNS6000,PLNS7000,PLNS8000,PLNS9000,PLN10000
.
.****** Report Layout 1 ********
.
PLNS1000  MOVE      OPDADES1,DIM30A
          MOVE      OPDADES2,DIM30B
          MOVE      OPDADES3,DIM30C
          PRINT     NAME25,*30,OPDAADMN,*40,OPDACASE,*45,DAGE,*51,PSEX:
                    *58,SURGEON,*93,OPDAPROV,*N:
                    "Operation Description : ",DIM30A,*58,ANAETHST,*N:
                    *25,DIM30B;
.
          ADD       THREE,CLNO
.
          MOVE      ZERO,COUNTER
          MOVE      ZERO,COUNTER2
          CALL      PSPD0000             * print system parameters
.
          PRINT     *25,DIM30C;
          CALL      PSPD0000
          PRINT     "Comments     : ",OPDACOMM;
          CALL      PSPD0000             * print system parameters
          PRINT     "Anaesthetic  : ",ANAEDESC;
          CALL      PSPD0000
          CALL      PSPD0000
          CALL      UND132
          GOTO      PLNS9999
.
.****** Report Layout 2 ********
.
PLNS2000  MOVE      OPDADES1,DIM30A
          MOVE      OPDADES2,DIM30B
          MOVE      OPDADES3,DIM30C
          PRINT     NAME25,*28,WARDBED,*40,OPDACASE,*45,DAGE,*50,PSEX:
                    *56,ADMNDATE,*67,OPDAPROV,*79,ANAEDESC,*103,DIM30A,*N:
                    "U/R : ",AURNO,*103,DIM30B,*N:
                    "Adm : ",OPDAADMN,*103,DIM30C,*N:
                    "SURGEON",*22,": ",LSURGEON,*79,"Comments    : ":
                    OPDACOMM,*N:
                    "ANAESTHETIST",*22,": ",LANAETHS:
                    *79,"Transport Type : ",TRANTYPE
.
          ADD       FIVE,CLNO
          CALL      UND132
          GOTO      PLNS9999
.
.****** Report Layout 3 ********
.
PLNS3000  MOVE      CATEGOR1,DIM10
          MOVE      OPDADES1,DIM30A
          MOVE      OPDADES2,DIM30B
          MOVE      OPDADES3,DIM30C
          PRINT     NAME25,*28,WARDBED,*38,OPDACASE,*44,DIM10,*56,OPERTYPE:
                    *77,ANAEDESC,*101,DIM30A,*N:
                    "U/R : ",AURNO,*101,DIM30B,*N:
                    "Adm : ",OPDAADMN,*101,DIM30C,*N:
                    "SURGEON",*22,": ",LSURGEON,*77,"Comments    : ":
                    OPDACOMM,*N:
                    "ANAESTHETIST",*22,": ",LANAETHS:
                    *77,"Transport Type : ",TRANTYPE
          CALL      UND132
          ADD       FIVE,CLNO
          GOTO      PLNS9999
.
.****** Report Layout 4 ********
.
PLNS4000  MOVE      OPDADES1,DIM66A
          MOVE      OPDADES2,DIM66B
          MOVE      OPDADES3,DIM66C
          PRINT     NAME25,*28,WARDBED,*39,OPDACASE,*44,DAGE,*49,PSEX:
                    *51,OPDAEXPD,*56,ADMNDATE,*67,DIM66A,*N:
                    "U/R : ",AURNO:
                    *45,"Adm Time : ",ADMNTIME,*67,DIM66B,*N:
                    "Adm : ",OPDAADMN,*22,"DOB : ",DISPLDOB:
                    *67,DIM66C,*N:
                    "Prosthetic : ",OPDACOMM:
                    *77,"Anaesthetic : ",ANAEDESC
.
          ADD       FIVE,CLNO
.
          PACK      KEY16,OPDAUNIQ,ZERO,ZERO,NINE,SP1,SP1,ONE
          CALL      RDOPDED1
          BRANCH    OVRCD,PLNS4100
.
          PRINT     "Comments   : ",OPDDDATA
          ADD       ONE,CLNO
          MOVE      ONE,COMMCNTR
.
PLNS4050  CALL      RKOPDED1
          BRANCH    OVRCD,PLNS4100
.
          MATCH     OPDAUNIQ,OPDDUNIQ
          GOTO      PLNS4100 IF NOT EQUAL
.
          MATCH     "009",OPDDTYPE
          GOTO      PLNS4100 IF NOT EQUAL
.
          PRINT     *14,OPDDDATA
          ADD       ONE,CLNO
          ADD       ONE,COMMCNTR
.
          COMPARE   TEN,COMMCNTR
          GOTO      PLNS4100 IF EQUAL
.
          GOTO      PLNS4050
.
PLNS4100  CALL      UND132
          GOTO      PLNS9999
.
.         print a line for layout 5
.
PLNS5000  MOVE      CATEGOR1,KEY11
          PRINT     NAME25,*28,WARDBED,*39,OPDACASE,*44,KEY11,*56,OPERTYPE:
                    *77,ANAEDESC,*105,POSTOP
          PRINT     "U/R : ",AURNO,*31,OPDADES1
          PRINT     "Adm : ",AADMNO,*31,OPDADES2
          PRINT     "Age : ",DAGE,*31,OPDADES3
          PRINT     "SURGEON",*29,": ",LSURGEON,*75,"Comments : ",OPDACOMM
          PRINT     "ANAESTHETIST",*29,": ",LANAETHS:
                    *75,"Transport Type : ",TRANTYPE
          CALL      UND132
          ADD       "7",CLNO
          GOTO      PLNS9999
.
.         Print a line for layout 6 
.
PLNS6000  PRINT     *1,OPDAEXPS,*7,NAME25,*37,OPDAADMN,*46,DAGE,*51,OPDADES1:
                    *107,ANAEDES1,*120,WARDBED,*128,TIME
          ADD       ONE,CLNO
          MATCH     SP55,OPDADES2
          GOTO      PLNS6100 IF EQUAL
          PRINT     *51,OPDADES2
          ADD       ONE,CLNO
PLNS6100  MATCH     SP55,OPDADES3
          GOTO      PLNS9999 IF EQUAL
          PRINT     *51,OPDADES3
          ADD       ONE,CLNO
          GOTO      PLNS9999
.
.         Print a line for layout 7
.
PLNS7000  PRINT     *1,OPDAEXPS,*7,NAME25,*37,OPDAADMN,*46,DAGE,*51,OPDADES1:
                    *107,ANAEDES1,*120,WARDBED,*128,TIME
          ADD       ONE,CLNO
          MATCH     SP55,OPDADES2
          GOTO      PLNS7100 IF EQUAL
          PRINT     *51,OPDADES2
          ADD       ONE,CLNO
PLNS7100  MATCH     SP55,OPDADES3
          GOTO      PLNS9999 IF EQUAL
          PRINT     *51,OPDADES3
          ADD       ONE,CLNO
          GOTO      PLNS9999
.
.***************************************************************************
.         Print a line for layout 8
.***************************************************************************
PLNS8000  PACK      KEY5,ANSX,ANSE,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,XEDESC
          ELSE
            MOVE      "Equipment ",XEDESC
          ENDIF
.
          MOVE      ONE,LINENUM
          MOVE      ONE,FLDFLAG
          MOVE      ZERO,ANAEFLAG
          MOVE      ZERO,COMNFLAG
          MOVE      OPDACASE,KEY3
          SQUEEZE   KEY3
          PACK      KEY3,KEY3,SP70
          UNPACK    NAME40,KEY39
          PRINT     *1,KEY3,*4,OPDAEXPS,*10,KEY39:
                    *49,"ADM:",OPDAADMN;
          CALL      PRDS0000              * Print operation description
          IF        OPDASTAT=1
            PRINT     *121,PMVXIDUS;
          ELSE
            PRINT     *121,BKRXUDF5;
          ENDIF
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          PRINT     *125,CPDATE
          ADD       ONE,CLNO
.
          UNPACK    PTELEP,KEY12
          PRINT     *10,"Ph: ",KEY12:
                    *30,"Age : ",DAGE:
                    *49,"UR: ",AURNO;
          CALL      PRDS0000              * Print operation description
          PRINT     *120,WARDBED,*128,TIME
          ADD       ONE,CLNO
.
          MATCH     SP70,AFUNDH
          GOTO      PLNS8200 IF NOT EQUAL
.
          MATCH     SP70,ACLAIM
          GOTO      PLNS8400 IF EQUAL
.
PLNS8200  PRINT     *30,"DOB : ",DISPLDOB:
                    *49,"Fund:",ACLAIM,"/",AFUNDH;
.
PLNS8400  CALL      PRDS0000              * Print description
          PRINT     " "
          ADD       ONE,CLNO
.
          MOVE      ZERO,F2
          WHILE     F2<10
            MOVE      ZERO,PRTFLAG
            CALL      PRDS0000              * Print description
            IF        PRTFLAG=1
              PRINT     " "
              ADD       ONE,CLNO
            ENDIF
            ADD       ONE,F2
          DO
          CALL      UND132
          GOTO      PLNS9999
.
.***************************************************************************
.         Print a line for layout 9
.***************************************************************************
PLNS9000  PACK      KEY5,ANSX,ANSE,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,XEDESC
          ELSE
            MOVE      "Equipment ",XEDESC
          ENDIF
.
          MOVE      ONE,LINENUM
          MOVE      ONE,FLDFLAG
          MOVE      ZERO,ANAEFLAG
          MOVE      ZERO,COMNFLAG
          MOVE      OPDACASE,KEY3
          SQUEEZE   KEY3
          PACK      KEY3,KEY3,SP70
          UNPACK    NAME40,KEY39
          PRINT     *1,KEY3,*4,OPDAEXPS,*10,KEY39:
                    *49,"ADM:",OPDAADMN;
          CALL      PRDS0000              * Print operation description
          IF        OPDASTAT=1
            PRINT     *121,PMVXIDUS;
          ELSE
            PRINT     *121,BKRXUDF5;
          ENDIF
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          PRINT     *125,CPDATE
          ADD       ONE,CLNO
.
          UNPACK    PTELEP,KEY12
          PRINT     *10,"Ph: ",KEY12:
                    *30,"Age : ",DAGE:
                    *49,"UR: ",AURNO;
          CALL      PRDS0000              * Print operation description
          PRINT     *120,WARDBED,*128,TIME
          ADD       ONE,CLNO
.
          UNPACK    PBDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          MOVE      PTMXCELL,DIM16
          PRINT     *10,"Mob:",DIM16,*30,"DOB:",CPDATE;
.
          MATCH     SP70,AFUNDH
          GOTO      PLNS9200 IF NOT EQUAL
.
          MATCH     SP70,ACLAIM
          GOTO      PLNS9400 IF EQUAL
.
PLNS9200  PRINT     *49,"Fund:",ACLAIM,"/",AFUNDH;
.
PLNS9400  CALL      PRDS0000              * Print operation description
          PRINT     *126,POSTOPWB
          ADD       ONE,CLNO
.
          MOVE      PSEX,DSEXCHAR
          CALL      SEXDSC00                * get sex description (in IBACOMN)
          PRINT     *30,"Sex:",DSEXDESC;
.
          CALL      PRDS0000              * Print description
          PRINT     *120,FASTTIME," / ",FLUDTIME
.
          ADD       ONE,CLNO
.
          MOVE      ZERO,F2
          WHILE     F2<10
            MOVE      ZERO,PRTFLAG
            CALL      PRDS0000              * Print description
            IF        PRTFLAG=1
              PRINT     " "
              ADD       ONE,CLNO
            ENDIF
            ADD       ONE,F2
          DO
.
          PRINT     *1,"PAC Required: ",PACREQYN:
                    *30,"PAC Attended: ",PACATTYN:
                    *49,"Admission Paperwork Rec: ",ADMNWORK:
                    *82,"Consent Form Rec: ",CONSFORM:
                    *109,"Medical History Rec: ",MEDICHST
          ADD       ONE,CLNO
.
          CALL      UND132
          GOTO      PLNS9999
.
PLNS9999  RETURN
.
.***************************************************************************
.         Print a line for layout 10
.***************************************************************************
PLN10000  PACK      KEY5,ANSX,ANSE,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,XEDESC
          ELSE
            MOVE      "Equipment ",XEDESC
          ENDIF
.
          MOVE      ONE,LINENUM
          MOVE      ONE,FLDFLAG
          MOVE      ZERO,ANAEFLAG
          MOVE      ZERO,COMNFLAG
          MOVE      OPDACASE,KEY3
          SQUEEZE   KEY3
          PACK      KEY3,KEY3,SP70
          UNPACK    NAME40,KEY39
          PRINT     *1,KEY3,*4,OPDAEXPS,*10,KEY39:
                    *49,"ADM:",OPDAADMN;
          CALL      PRDS0000              * Print operation description
          IF        OPDASTAT=1
            PRINT     *121,PMVXIDUS;
          ELSE
            PRINT     *121,BKRXUDF5;
          ENDIF
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          PRINT     *125,CPDATE
          ADD       ONE,CLNO
.
          UNPACK    PTELEP,KEY12
          PRINT     *10,"Ph: ",KEY12:
                    *30,"Age : ",DAGE:
                    *49,"UR: ",AURNO;
PLN10100  CALL      PRDS0000              * Print operation description
          PRINT     *120,WARDBED,*128,TIME
          ADD       ONE,CLNO
.
          UNPACK    PBDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          MOVE      PTMXCELL,DIM16
          PRINT     *10,"Mob:",DIM16,*30,"DOB:",CPDATE;
.
          MATCH     SP70,AFUNDH
          GOTO      PLN10200 IF NOT EQUAL
.
          MATCH     SP70,ACLAIM
          GOTO      PLN10400 IF EQUAL
.
PLN10200  PRINT     *49,"Fund:",ACLAIM,"/",AFUNDH;
.
PLN10400  CALL      PRDS0000              * Print operation description
          PRINT     *126,POSTOPWB
          ADD       ONE,CLNO
.
          MOVE      PSEX,DSEXCHAR
          CALL      SEXDSC00                * get sex description (in IBACOMN)
          PRINT     *30,"Sex:",DSEXDESC;
.
          CALL      PRDS0000              * Print description
          PRINT     *120,FASTTIME," / ",FLUDTIME
.
          ADD       ONE,CLNO
          MOVE      ZERO,PRTFLAG
          CALL      PRDS0000              * Print description
          IF        PRTFLAG=1
            PRINT     " "
            ADD       ONE,CLNO
          ENDIF
.
          CALL      ACOMM000
.
          PRINT     *1,"PAC Required: ",PACREQYN:
                    *30,"PAC Attended: ",PACATTYN:
                    *49,"Admission Paperwork Rec: ",ADMNWORK:
                    *82,"Consent Form Rec: ",CONSFORM:
                    *109,"Medical History Rec: ",MEDICHST
          ADD       ONE,CLNO
.
          CALL      UND132
          GOTO      PLN10999
.
PLN10999  RETURN
.
ACOMM000  PACK      TCOMLINE,SP70,SP70
          PACK      NEWTCOMM,SP70,SP70,SP70
          MOVE      ZERO,COMFSTLN
. 
          MOVE      "009",DIM3 
          PACK      KEY16,OPDAUNIQ,DIM3,SP70
          CALL      RSOPDED1
ACOMM200  CALL      RKOPDED1
          BRANCH    OVRCD,ACOMM800
.
          MATCH     OPDAUNIQ,OPDDUNIQ
          GOTO      ACOMM800 IF NOT EQUAL
.
          MATCH     DIM3,OPDDTYPE
          GOTO      ACOMM800 IF NOT EQUAL 
.
          IF        COMFSTLN = 0
            MOVE      "Comments   : ",TCOMLINE
            MOVE      ONE,COMFSTLN 
          ENDIF
.
          STRIP     OPDDDATA
.
          PACK      NEWTCOMM,TCOMLINE,SP1,OPDDDATA 
          RESET     NEWTCOMM
          MOVELPTR  NEWTCOMM,F3
          IF        F3 > 132
            GOTO      ACOMM400
          ENDIF
.
          MOVE      NEWTCOMM,TCOMLINE
          GOTO      ACOMM200
.
ACOMM400  MOVE      OPDDDATA,TEMPFLD
          MOVE      TEMPFLD,TEMPFLD1        
.
ACOMM420  SCAN      SP1,TEMPFLD1
          GOTO      ACOMM600 IF NOT EQUAL
.
          BUMP      TEMPFLD1 
          MOVEFPTR  TEMPFLD1,FORM2
          MOVE      TEMPFLD1,TEMPFLD2
          SUB       TWO,FORM2
          MOVE      TEMPFLD,TEMPFLD1
          SETLPTR   TEMPFLD1,FORM2
          MOVE      TEMPFLD1,TEMPFLD3
.        
          STRIP     TEMPFLD3
          PACK      NEWTCOMM,TCOMLINE,SP1,TEMPFLD3
          MOVELPTR  NEWTCOMM,F3
          IF        F3 > 132
            GOTO      ACOMM500
          ENDIF 
. 
          MOVE      NEWTCOMM,TCOMLINE 
          MOVE      TEMPFLD2,TEMPFLD
          MOVE      TEMPFLD,TEMPFLD1
.
          GOTO      ACOMM420
.
ACOMM500  PRINT     *1,TCOMLINE
          ADD       ONE,CLNO
          MOVE      TEMPFLD1,TCOMLINE
          MOVE      TEMPFLD2,TEMPFLD
          MOVE      TEMPFLD,TEMPFLD1  
          GOTO      ACOMM420
.
ACOMM600  STRIP     TEMPFLD1
          PACK      NEWTCOMM,TCOMLINE,SP1,TEMPFLD1
          MOVELPTR  NEWTCOMM,F3
          IF        F3 > 132
            GOTO      ACOMM620
          ENDIF
.
          MOVE      NEWTCOMM,TCOMLINE
          GOTO      ACOMM200
.
ACOMM620  PRINT     *1,TCOMLINE
          ADD       ONE,CLNO
.
          MOVE      TEMPFLD1,TCOMLINE
          GOTO      ACOMM200
. 
ACOMM800  MATCH     SP70,TCOMLINE
          GOTO      ACOMM999 IF EQUAL
.
          PRINT     *1,TCOMLINE
          ADD       ONE,CLNO
.
ACOMM999  RETURN
.
.**********************************************************************
.         Print operation Description lines for report layout 8
.**********************************************************************
PRDS0000  BRANCH    FLDFLAG,PRDS1000,PRDS1500,PRDS2000,PRDS2500,PRDS3000:
                            PRDS4000,PRDS5000,PRDS6000,PRDS7000,PRDS8000:
                            PRDS9000
          GOTO      PRDS9999
.
PRDS1000  ADD       ONE,FLDFLAG
          CALL      FMTD0000           * Format operation description 
...... Mater only
......    CALL      FMTT0000           * Format operation description
.
          MATCH     SP70,REP8DES1
          GOTO      PRDS1500 IF EQUAL
.
          PRINT     *64,REP8DES1;
          ADD       ONE,LINENUM
          MOVE      ONE,PRTFLAG
          GOTO      PRDS9999
.
PRDS1500  ADD       ONE,FLDFLAG
          MATCH     SP70,REP8DES2
          GOTO      PRDS2000 IF EQUAL
.
          PRINT     *64,REP8DES2;
          ADD       ONE,LINENUM
          MOVE      ONE,PRTFLAG
          GOTO      PRDS9999
.
PRDS2000  ADD       ONE,FLDFLAG
          MATCH     SP70,REP8DES3
          GOTO      PRDS2500 IF EQUAL
.
          PRINT     *64,REP8DES3;
          ADD       ONE,LINENUM
          MOVE      ONE,PRTFLAG
          GOTO      PRDS9999
.
PRDS2500  ADD       ONE,FLDFLAG
          MATCH     SP70,REP8DES4
          GOTO      PRDS3000 IF EQUAL
.
          PRINT     *64,REP8DES4;
          ADD       ONE,LINENUM
          MOVE      ONE,PRTFLAG
          GOTO      PRDS9999
.
PRDS3000  ADD       ONE,FLDFLAG
          MATCH     SP70,REP8DES5
          GOTO      PRDS4000 IF EQUAL
.
          PRINT     *64,REP8DES5;
          ADD       ONE,LINENUM
          MOVE      ONE,PRTFLAG
          GOTO      PRDS9999
.
PRDS4000  ADD       ONE,FLDFLAG
          MATCH     SP70,OPDACOMM
          GOTO      PRDS5000 IF EQUAL
.
          PRINT     *64,"Prosthetic Req:",OPDACOMM;
          ADD       ONE,LINENUM
          MOVE      ONE,PRTFLAG
          GOTO      PRDS9999
.
PRDS5000  IF        OPCNR66A=9 | OPCNR66A=10
            COMPARE   FIVE,LINENUM
            GOTO      PRDS5200 IF LESS
          ELSE
            COMPARE   THREE,LINENUM
            GOTO      PRDS5200 IF LESS
          ENDIF
.
          ADD       ONE,FLDFLAG
          MATCH     SP70,OPDAEQR1
          GOTO      PRDS6000 IF EQUAL
.
          MOVE      "XE",KEY2
          PACK      KEY5,KEY2,OPDAEQR1
          CALL      RDCODE1
          IF        OVRCD=0
            PRINT     *64,XEDESC," 1:",TDESC;
          ENDIF
          IF        ANAEFLAG=0
            PRINT     *107,"Anaes:",ANAEDESC;
            MOVE      ONE,ANAEFLAG
          ENDIF
.
PRDS5200  ADD       ONE,LINENUM
          MOVE      ONE,PRTFLAG
          GOTO      PRDS9999
.
PRDS6000  IF        OPCNR66A=9 | OPCNR66A=10
            COMPARE   FIVE,LINENUM
            GOTO      PRDS6200 IF LESS
          ELSE
            COMPARE   THREE,LINENUM
            GOTO      PRDS6200 IF LESS
          ENDIF
.
          ADD       ONE,FLDFLAG
          MATCH     SP70,OPDAEQR2
          GOTO      PRDS7000 IF EQUAL
.
          MOVE      "XE",KEY2
          PACK      KEY5,KEY2,OPDAEQR2
          CALL      RDCODE1
          IF        OVRCD=0
            PRINT     *64,XEDESC," 2:",TDESC;
          ENDIF
          IF        ANAEFLAG=0
            PRINT     *107,"Anaes:",ANAEDESC;
            MOVE      ONE,ANAEFLAG
          ENDIF
.
PRDS6200  ADD       ONE,LINENUM
          MOVE      ONE,PRTFLAG
          GOTO      PRDS9999
.
PRDS7000  IF        OPCNR66A=9 | OPCNR66A=10
            COMPARE   FIVE,LINENUM
            GOTO      PRDS7200 IF LESS
          ELSE
            COMPARE   THREE,LINENUM
            GOTO      PRDS7200 IF LESS
          ENDIF
.
          ADD       ONE,FLDFLAG
          MATCH     SP70,OPDAEQR3
          GOTO      PRDS8000 IF EQUAL
.
          MOVE      "XE",KEY2
          PACK      KEY5,KEY2,OPDAEQR3
          CALL      RDCODE1
          IF        OVRCD=0
            PRINT     *64,XEDESC," 3:",TDESC;
          ENDIF
          IF        ANAEFLAG=0
            PRINT     *107,"Anaes:",ANAEDESC;
            MOVE      ONE,ANAEFLAG
          ENDIF
.
PRDS7200  ADD       ONE,LINENUM
          MOVE      ONE,PRTFLAG
          GOTO      PRDS9999
.
PRDS8000  IF        OPCNR66A=9 | OPCNR66A=10
            COMPARE   FIVE,LINENUM
            GOTO      PRDS8200 IF LESS
          ELSE
            COMPARE   THREE,LINENUM
            GOTO      PRDS8200 IF LESS
          ENDIF
.
          COMPARE   ZERO,ANAEFLAG
          GOTO      PRDS8200 IF EQUAL
.
          ADD       ONE,FLDFLAG
          PACK      KEY16,OPDAUNIQ,ZERO,ZERO,NINE,SP1,SP1,ONE
          CALL      RDOPDED1
          BRANCH    OVRCD,PRDS9000
          PRINT     *49,"Comments   : ",OPDDDATA;
          MOVE      ONE,COMNFLAG
          GOTO      PRDS8400
.
PRDS8200  IF        ANAEFLAG=0
            PRINT     *107,"Anaes:",ANAEDESC;
            MOVE      ONE,ANAEFLAG
          ENDIF
.
PRDS8400  ADD       ONE,LINENUM
          MOVE      ONE,PRTFLAG
          GOTO      PRDS9999
.
PRDS9000  IF        OPCNR66A=9 | OPCNR66A=10
            COMPARE   FIVE,LINENUM
            GOTO      PRDS9200 IF LESS
          ELSE
            COMPARE   THREE,LINENUM
            GOTO      PRDS9200 IF LESS
          ENDIF
.
          COMPARE   ZERO,ANAEFLAG
          GOTO      PRDS9200 IF EQUAL
.
          ADD       ONE,FLDFLAG
          PACK      KEY16,OPDAUNIQ,ZERO,ZERO,NINE,SP1,SP1,TWO
          PACK      KEY13,OPDAUNIQ,ZERO,ZERO,NINE
          CALL      RDOPDED1
          BRANCH    OVRCD,PRDS9999
          IF        COMNFLAG=0
            PRINT     *49,"Comments   : ",OPDDDATA;
          ELSE
            IF        OPCNR66A=8
              PRINT     *49,"             ",OPDDDATA
              CALL      PRDSCM00
              GOTO      PRDS9999
            ELSE
              PRINT     *49,"             ",OPDDDATA;
            ENDIF
          ENDIF
          GOTO      PRDS9400
.
PRDS9200  IF        ANAEFLAG=0
            PRINT     *107,"Anaes:",ANAEDESC;
            MOVE      ONE,ANAEFLAG
          ENDIF
.
PRDS9400  ADD       ONE,LINENUM
          MOVE      ONE,PRTFLAG
.
PRDS9999  RETURN
+
.********************************************************************
.         For OPCNR66A=8 (Report Layout), print out all the comment
.         lines starting from the 3rd line. Currently it Only prints 
.         out the first 2 lines
.********************************************************************
PRDSCM00  ADD       ONE,LINENUM
.
PRDSCM10  CALL      RKOPDED1
          BRANCH    OVRCD,PRDSCM99
. 
          PACK      KEY16,OPDDUNIQ,OPDDTYPE,OPDDLINE
          MATCH     KEY13,KEY16
          GOTO      PRDSCM99 IF NOT EQUAL
.
          PRINT     *49,"             ",OPDDDATA
          ADD       ONE,LINENUM
          GOTO      PRDSCM10 
.
PRDSCM99  RETURN
+
.**********************************************************************
.*                        FMTD0000                                    *
.* Format 3 X 80 character operation description vars into a max of   *
.* 5 X 55 character lines. This will only split lines between words   *
.**********************************************************************
FMTD0000  PACK      REP8DESC,SP70,SP70,SP70,SP70
          MOVE      SP70,REP8DES1          * Clear description vars
          MOVE      SP70,REP8DES2
          MOVE      SP70,REP8DES3
          MOVE      SP70,REP8DES4
          MOVE      SP70,REP8DES5
.
          STRIP     OPDADES1                * Remove trailing white space
          STRIP     OPDADES2
          STRIP     OPDADES3                * Save 242 character description
.
          PACK      REP8DESC,OPDADES1,SP1,OPDADES2,SP1,OPDADES3  * 
.
          MOVE      ZERO,LOOPCNTR           * Loop count
.
FMTD1000  ADD       ONE,LOOPCNTR            * Add one to loop count
.
          STRIP     REP8DESC                * Remove trailing spaces
          MOVELPTR  REP8DESC,TOTLNGTH       * Save LL
.
          COMPARE   ZERO,TOTLNGTH           * LL = 0 Description string empty
          GOTO      FMTD9000 IF EQUAL       * so exit
.
          IF        TOTLNGTH<=55
            STORE     REP8DESC,LOOPCNTR,REP8DES1,REP8DES2:
                               REP8DES3,REP8DES4,REP8DES5
            GOTO      FMTD9000              * Exit no more description
          ENDIF
.
          BUMP      REP8DESC,55             * Set FP to 55th characters
.
FMTD1200  MATCH     SP1,REP8DESC            * Check if last character is a space
          IF        !@EQUAL
            BUMP      REP8DESC,-1           * Search for a space prior to 55th
            GOTO      FMTD1200 IF NOT EOS   * character 1 at a time
.
            MOVE      FIFTY5,SAVLNGTH       * No spaces in the 55 characters so
            GOTO      FMTD1300              * use all 55
          ENDIF
.
          MOVEFPTR  REP8DESC,SAVLNGTH       * Store FP position of last space
.
FMTD1300  RESET     REP8DESC                * Reset FP to zero and set LL to 
          SETLPTR   REP8DESC,SAVLNGTH       * the position of the last space
.
          STORE     REP8DESC,LOOPCNTR,REP8DES1,REP8DES2:   * Store description
                             REP8DES3,REP8DES4,REP8DES5          
.
          RESET     REP8DESC                * Reset FP and set the 
          SETLPTR   REP8DESC,TOTLNGTH       * LL to the total length
          BUMP      REP8DESC,SAVLNGTH       * Set FP to position of last space
.
          MOVE      REP8DESC,SAV8DESC       * Save remaining description
.
          RESET     REP8DESC                * Reset description and populate
          PACK      REP8DESC,SAV8DESC,SP70: * with the remaining description
                             SP70,SP70,SP70
.
          GOTO      FMTD1000                * loop back to start
.
FMTD9000  PACK      REP8DES1,REP8DES1,SP70  * Pack all descriptions with spaces
          PACK      REP8DES2,REP8DES2,SP70
          PACK      REP8DES3,REP8DES3,SP70
          PACK      REP8DES4,REP8DES4,SP70
          PACK      REP8DES5,REP8DES5,SP70
.
          LJUSTIFY  REP8DES1                * Left justify to remove leading
          LJUSTIFY  REP8DES2                * spaces
          LJUSTIFY  REP8DES3
          LJUSTIFY  REP8DES4
          LJUSTIFY  REP8DES5
.
FMTD9999  RETURN
+
.**********************************************************************
.*                        FMTT0000                                    *
.* Format 3 X 80 character operation description vars into a max of   *
.* 5 X 55 character lines. This will only split lines between words   *
.**********************************************************************
FMTT0000  PACK      REP8DESC,SP70,SP70,SP70,SP70
          MOVE      SP70,REP8DES1          * Clear description vars
          MOVE      SP70,REP8DES2
          MOVE      SP70,REP8DES3
          MOVE      SP70,REP8DES4
          MOVE      SP70,REP8DES5
.
          MOVE      ZERO,LOOPCNTR
          STRIP     OPDADES1                * Remove trailing white space
          STRIP     OPDADES2
          STRIP     OPDADES3                * Save 242 character description
.
          STRIP     OPDADES1                * Remove trailing spaces
          MOVELPTR  OPDADES1,TOTLNGTH       * Save LL
.
          COMPARE   ZERO,TOTLNGTH           * LL = 0 Description string empty
          GOTO      FMTT2000 IF EQUAL       * so exit
.
          MATCH     SP70,OPDADES1
          GOTO      FMTT2000 IF EQUAL
.
          ADD       ONE,LOOPCNTR
          STORE     OPDADES1,LOOPCNTR,REP8DES1,REP8DES2:   * Store description
                             REP8DES3,REP8DES4,REP8DES5
.
          IF        TOTLNGTH<55
            GOTO      FMTT2000
          ENDIF
          BUMP      OPDADES1,55             * Set FP to 55th characters
          MATCH     SP70,OPDADES1
          GOTO      FMTT2000 IF EQUAL
          GOTO      FMTT2000 IF EOS
.
          ADD       ONE,LOOPCNTR
          STORE     OPDADES1,LOOPCNTR,REP8DES1,REP8DES2:   * Store description
                             REP8DES3,REP8DES4,REP8DES5
.
FMTT2000  STRIP     OPDADES2                * Remove trailing spaces
          MOVELPTR  OPDADES2,TOTLNGTH       * Save LL
.
          COMPARE   ZERO,TOTLNGTH           * LL = 0 Description string empty
          GOTO      FMTT3000 IF EQUAL       * so exit
.
          MATCH     SP70,OPDADES2
          GOTO      FMTT3000 IF EQUAL
.
          ADD       ONE,LOOPCNTR
          STORE     OPDADES2,LOOPCNTR,REP8DES1,REP8DES2:   * Store description
                             REP8DES3,REP8DES4,REP8DES5
.
          MOVE      OPDADES2,REP8DES3
          IF        TOTLNGTH<55
            GOTO      FMTT3000
          ENDIF
          BUMP      OPDADES2,55             * Set FP to 55th characters
          MATCH     SP70,OPDADES2
          GOTO      FMTT3000 IF EQUAL
.
          ADD       ONE,LOOPCNTR
          STORE     OPDADES2,LOOPCNTR,REP8DES1,REP8DES2:   * Store description
                             REP8DES3,REP8DES4,REP8DES5
.
FMTT3000  ADD       ONE,LOOPCNTR
          STORE     OPDADES3,LOOPCNTR,REP8DES1,REP8DES2:   * Store description
                             REP8DES3,REP8DES4,REP8DES5
.
FMTT9000  PACK      REP8DES1,REP8DES1,SP70  * Pack all descriptions with spaces
          PACK      REP8DES2,REP8DES2,SP70
          PACK      REP8DES3,REP8DES3,SP70
          PACK      REP8DES4,REP8DES4,SP70
          PACK      REP8DES5,REP8DES5,SP70
.
          LJUSTIFY  REP8DES1                * Left justify to remove leading
          LJUSTIFY  REP8DES2                * spaces
          LJUSTIFY  REP8DES3
          LJUSTIFY  REP8DES4
          LJUSTIFY  REP8DES5
.
FMTT9999  RETURN
+
.**********************************************************************
.*                        SRDS0000                                    *
.*               Set-up the report descriptions                       *
.**********************************************************************
.
.   This routine sets up all descriptions regardless of whether it is
.   required by the specified report layout or not (sys pram OPCNR66A)
.
SRDS0000  CLEAR     WARDBED
          CLEAR     ADMNWORK
          CLEAR     ANAEDESC
          CLEAR     ANAETHST
          CLEAR     CONSFORM
          CLEAR     SURGEON
          CLEAR     ADMNDATE
          CLEAR     ADMNTIME
          CLEAR     MEDICHST
          CLEAR     TRANTYPE
          CLEAR     CATEGOR1
          CLEAR     FASTTIME
          CLEAR     FLUDTIME
          CLEAR     OPERTYPE
          CLEAR     LANAETHS
          CLEAR     LSURGEON
          CLEAR     PACREQYN
          CLEAR     PACATTYN
          CLEAR     POSTOP
          CLEAR     POSTOPWB
.
          MATCH     SP8,ADATE
          GOTO      SRDS0100 IF EQUAL
.
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          PACK      ADMNDATE,CDAY,SLASH,CMON,SLASH,CCENT,CYEAR
          REP       " 0",ADMNDATE
.
SRDS0100
          MATCH     SP3,OPDATRAN
          GOTO      SRDS0200 IF EQUAL
.
          PACK      KEY5,CATOR,OPDATRAN
          CALL      RDCODE1
          BRANCH    OVRCD,SRDS0200
.
          MOVE      TDESC,TRANTYPE       * Transport type
.
SRDS0200
          MATCH     SP3,ATYPE
          GOTO      SRDS0300 IF EQUAL
.
          PACK      KEY5,CATA,ATYPE
          CALL      RDCODE1
          BRANCH    OVRCD,SRDS0300
.
          MOVE      TDESC,CATEGOR1      * patient addmission category
.
SRDS0300
          MATCH     SP3,OPDATYPE
          GOTO      SRDS0400 IF EQUAL
.
          PACK      KEY5,CATOY,OPDATYPE
          CALL      RDCODE1
          BRANCH    OVRCD,SRDS0400
.
          MOVE      TDESC,OPERTYPE       * Operation type
.
SRDS0400  MOVE      SP7,WARDBED
          MOVE      OPDAADMN,AADMNO
          PACK      KEY30,AADMNO,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,SRDS0450
.
          MATCH     AADMNO,TADMN
          GOTO      SRDS0450 IF NOT EQUAL
.
          MATCH     SP3,TBED
          IF        @EQUAL
            PACK      WARDBED,TWARD,SP7         * patient ward
          ELSE
            PACK      WARDBED,TWARD,SLASH,TBED  * patient ward / bed
          ENDIF
          PACK      KEY8,AADMNO,SP70
          CALL      RDPMVX11
          CALL      RDBKREC1
          CALL      RDBKRX11
          GOTO      SRDS0500
.
SRDS0450  COMPARE   ONE,ASTAT                   * Get ward/bed for pre-adm
          GOTO      SRDS0470 IF NOT EQUAL       * as they are not in the
.
          MOVE      OPDAADMN,KEY8
          CALL      RDPMVX11
          CALL      RDBKREC1
          CALL      RDBKRX11
.
          MATCH     "1",OPCNOP66
          IF        @EQUAL
            MATCH     SP3,PTMIEBED
            IF        @EQUAL
              PACK      WARDBED,PTMIXWRD,SP7         * patient ward
            ELSE
              PACK      WARDBED,PTMIXWRD,SLASH,PTMIEBED  * patient ward / bed
            ENDIF
          ELSE
            IF        OVRCD=0
              PACK      WARDBED,PMVXAPWD,SP70      * pack with admitting point
            ENDIF
          ENDIF
.
          IF        OPCNR66A=9 | OPCNR66A=10
            MATCH     SP3,PTMIEBED
            IF        @EQUAL
              PACK      WARDBED,PTMIXWRD,SP7         * patient ward
            ELSE
              PACK      WARDBED,PTMIXWRD,SLASH,PTMIEBED  * patient ward / bed
            ENDIF
          ENDIF
.
          GOTO      SRDS0500
.
SRDS0470  MOVE      SP3,BKREWARD
          MOVE      SP3,BKREEBED
          MOVE      AADMNO,KEY8
          CALL      RDBKREC1
          CALL      RDBKRX11
.
.         MATCH     SP3,BKREEBED
.         IF        @EQUAL
.           PACK      WARDBED,BKREWARD,SP7      * patient ward
.         ELSE
.           PACK      WARDBED,BKREWARD,SLASH,BKREEBED * patient ward / bed
.         ENDIF
.
          MATCH     "1",OPCNOP66
          IF        @EQUAL
            PACK      WARDBED,BKRXPOWD,SP70        * pack with Exp Post Op Ward 
            MATCH     SP70,BKRXPOWD
            IF        @EQUAL
              MATCH     SP3,BKREEBED
              IF        @EQUAL
                PACK      WARDBED,BKREWARD,SP7      * patient ward
              ELSE
                PACK      WARDBED,BKREWARD,SLASH,BKREEBED * patient ward / bed
              ENDIF
            ENDIF
          ELSE
            PACK      WARDBED,BKRXADWD,SP70        * pack with admitting point
          ENDIF
.
          IF        OPCNR66A=9 | OPCNR66A=10
            MATCH     SP3,BKREEBED
            IF        @EQUAL
              PACK      WARDBED,BKREWARD,SP7         * patient ward
            ELSE
              PACK      WARDBED,BKREWARD,SLASH,BKREEBED  * patient ward / bed
            ENDIF
          ENDIF

.
SRDS0500  MOVE      DATEOFOP,AGEDATE
          CALL      CALCAGE              * calculate patient age
          MOVE      PSAGEYRS,DAGE
          COMPARE   ZERO,PSAGEYRS
          GOTO      SRDS0550 IF NOT EQUAL
.
          MOVE      PSAGEMNT,FORM2
          PACK      DAGE,FORM2,ANSM
.
          COMPARE   ZERO,PSAGEMNT
          GOTO      SRDS0550 IF NOT EQUAL
.
          MOVE      PSAGEDAY,FORM2
          PACK      DAGE,FORM2,ANSD
.
.         get the surgeon description
.
SRDS0550  
          SQUEEZE   DAGE 
          PACK      SURGEON,SP20,SP20
          PACK      LSURGEON,SP20,SP20
          PACK      ISURGEON,SP20
          MOVE      DOCTOR,SURGNCD           * save surgeon code
          MATCH     SP6,DOCTOR
          GOTO      SRDS1000 IF EQUAL
.
          PACK      KEY6,DOCTOR
          CALL      RDDOCT1
          BRANCH    OVRCD,SRDS1000
.
          CALL      FDOC0000
          MOVE      PACFNAME,SURGEON     * Surgeon
          MOVE      PACFNAME,LSURGEON    * (long description)
.
. ----- Format surgeon name with initial -----
.
          MOVE      DSNAME,PACSNAME
          MOVE      DTITL,PACTITLE
          MOVE      DGNAME,ANS
          PACK      PACGNAME,ANS,DOT
          MOVE      ONE,PACFRMT
          CALL      PACNAME
          CALL      SPFN0000            * Strip trailing blanks off Pacfname
          PACK      ISURGEON,PACFNAME
.
.         get the anaesthetist description
.
SRDS1000  PACK      ANAETHST,SP20,SP20
          PACK      LANAETHS,SP20,SP20
          PACK      IANAETHS,SP20,SP20
          MOVE      SP6,ANAETHCD
          CALL      GANE0000             * get anaesthetist
          BRANCH    EXIT,SRDS2000
          MOVE      DCODE,ANAETHCD
          CALL      FDOC0000
          MOVE      PACFNAME,ANAETHST
          MOVE      PACFNAME,LANAETHS
.
. ----- Format surgeon name with initial -----
.
          MOVE      DSNAME,PACSNAME
          MOVE      DTITL,PACTITLE
          MOVE      DGNAME,ANS
          PACK      PACGNAME,ANS,DOT
          MOVE      ONE,PACFRMT
          CALL      PACNAME
          CALL      SPFN0000            * Strip trailing blanks off Pacfname
          PACK      IANAETHS,PACFNAME
.
.         get the anaesthetic description
.
SRDS2000  MOVE      SP20,ANAEDESC
          MOVE      SP20,ANAEDES1
          MATCH     SP3,OPDAANAE
          GOTO      SRDS3000 IF EQUAL
.
          PACK      KEY5,CATOA,OPDAANAE
          CALL      RDCODE1
          BRANCH    OVRCD,SRDS3000
.
          MOVE      TDESC,ANAEDESC       * anaesthetic description
          MOVE      TDESC,ANAEDES1       * anaesthetic description
.
.         get post-op ward
.
SRDS3000  PACK      POSTOP,SP70
          PACK      POSTOPWB,SP70
.
          PACK      KEY8,OPDAADMN,SP70
          CALL      RDBKRX11
          IF        OVRCD=0
            MATCH     SP3,BKRXPOBD
            IF        @EQUAL
              PACK      POSTOPWB,BKRXPOWD,SP70            * post op ward
            ELSE
              PACK      POSTOPWB,BKRXPOWD,SLASH,BKRXPOBD  * Post op ward / bed
            ENDIF
.
            PACK      KEY6,BKRXPOWD,SP30
            CALL      RDWARD1
            BRANCH    OVRCD,SRDS4000
            PACK      POSTOP,WBDESC,SP70
          ENDIF
.
SRDS4000  CALL      GASS0000             * get Assistant surgeon
.
.------ Set up expected admission time ----
.
          MOVE      SP5,TIME
          MOVE      SP5,ADMNTIME
          MATCH     SP5,ATIME
          GOTO      SRDS5100 IF EQUAL
          MOVE      ATIME,TIME
          MOVE      ATIME,ADMNTIME
          GOTO      SRDS5500
.
SRDS5100  MATCH     SP5,BKREATIM
          GOTO      SRDS5500 IF EQUAL
          MOVE      BKREATIM,TIME
.
SRDS5500  MATCH     SP70,OPDADES1           * Use booking desc if the surgical
          GOTO      SRDS6000 IF NOT EQUAL   * details desc is blank
.
          PACK      KEY8,AADMNO
          CALL      RDBKRX11
          IF        OVRCD = 0
            MOVE      BKRXUFF1,OPDADES1
            MOVE      BKRXUFF2,OPDADES2
            MOVE      BKRXUFF3,OPDADES3
          ENDIF
.
SRDS6000  MOVE      OPDAFAST,FASTTIME       * Setup fasting time
          MOVE      OPDAPRE5,FLUDTIME       * Setup fluid time
.
          MATCH     SP70,BKREPDAT           * PAC Required
          IF        @EQUAL
            MOVE     DNO,PACREQYN
          ELSE
            MOVE     DYES,PACREQYN
          ENDIF
.
          MATCH     "1",BKRXPACA           * PAC Attended
          IF        @EQUAL
            MOVE     DYES,PACATTYN
          ELSE
            MOVE     DNO,PACATTYN
          ENDIF
.
          MATCH     "1",OPDAAPRC           * Adm paperwork received
          IF        @EQUAL
            MOVE     DYES,ADMNWORK
          ELSE
            MOVE     DNO,ADMNWORK
          ENDIF
.
          MATCH     ANSY,OPDACSST           * Consent form received
          IF        @EQUAL
            MOVE     DYES,CONSFORM
          ELSE
            MOVE     DNO,CONSFORM
          ENDIF
.
          MATCH     "1",OPDAMHRC           * Medical history received
          IF        @EQUAL
            MOVE     DYES,MEDICHST
          ELSE
            MOVE     DNO,MEDICHST
          ENDIF
.
SRDS9999  RETURN
.
.****************************************************************************
.*                              SPFN0000                                    *
.*                       Strip trailing spaces from pacfname                *
.****************************************************************************
.
SPFN0000
          ENDSET    PACFNAME
.
SPFN1000  CMATCH    SP1,PACFNAME
          GOTO      SPFN2000 IF NOT EQUAL
          BUMP      PACFNAME,NEGONE
          GOTO      SPFN2000 IF EOS
          GOTO      SPFN1000
.
SPFN2000  LENSET    PACFNAME
          RESET     PACFNAME
.
SPFN9999  RETURN
.
.**********************************************************************
.*                        GANE0000                                    *
.*                 Get the anaesthetist                               *
.**********************************************************************
.
GANE0000  MOVE      SP6,DIM6
          MOVE      ZERO,EXIT
          MOVE      ZERO,COUNTER
          BRANCH    DEFAULTF,GANE6000
.
GANE1000  ADD       ONE,COUNTER
.
          COMPARE   NINE,COUNTER
          GOTO      GANE7000 IF EQUAL
.
          LOAD      TYPE,COUNTER,OPSETYD1,OPSETYD2,OPSETYD3,OPSETYD4:
                                 OPSETYD5,OPSETYD6,OPSETYD7,OPSETYD8
.
          PACK      TYPE,TYPE,SP3
          MATCH     SP3,TYPE
          GOTO      GANE1000 IF EQUAL
.
          PACK      KEY5,CATOP,TYPE
          CALL      RDCODE1
          BRANCH    OVRCD,GANE1000
.
          MATCH     "N",TCINDC1
          GOTO      GANE1000 IF NOT EQUAL
.
          LOAD      DIM6,COUNTER,OPSEDCC1,OPSEDCC2,OPSEDCC3,OPSEDCC4:
                                   OPSEDCC5,OPSEDCC6,OPSEDCC7,OPSEDCC8
.
          PACK      KEY6,DIM6
          CALL      RDDOCT1
          BRANCH    OVRCD,GANE9000
          GOTO      GANE9999
.
.         Using new tables for details
.
GANE6000  PACK      KEY35,OPSGUNID,OPSGTMNO,SP1,ONE,SP30
          CALL      RSOPTSM1
GANE6500  CALL      RKOPTSM1
          BRANCH    OVRCD,GANE7000
.
          MATCH     OPSGUNID,OPTSUNID
          GOTO      GANE7000 IF NOT EQUAL
.
          MATCH     OPSGTMNO,OPTSTMNO
          GOTO      GANE7000 IF NOT EQUAL
.
          COMPARE   ONE,OPTSSIND
          GOTO      GANE7000 IF NOT EQUAL
.
          PACK      KEY5,CATOP,OPTSSTYP
          CALL      RDCODE1
          BRANCH    OVRCD,GANE6500
.
          MATCH     "N",TCINDC1
          GOTO      GANE6500 IF NOT EQUAL
.
          PACK      KEY6,OPTSSCDE
          CALL      RDDOCT1
          BRANCH    OVRCD,GANE9000
.
          GOTO      GANE9999
.
.
.         No anaesthetist on team. Try the default anaesthetist for session
.
GANE7000  MOVE      OPSEANAE,KEY6
          CALL      RDDOCT1
          BRANCH    OVRCD,GANE9000
          GOTO      GANE9999
.
GANE9000  MOVE      ONE,EXIT
.
GANE9999  RETURN
.
.**********************************************************************
.*                        PSPD0000                                    *
.*           Print the system parameter descriptions                  *
.********************************************************************** 
.
PSPD0000
          ADD       ONE,COUNTER
.
          COMPARE   COUNTER,FIVE
          GOTO      PSPD5000 IF LESS
.
          LOAD      DIM18,COUNTER,OPCNDPR1,OPCNDPR2,OPCNDPR3,OPCNDPR4:
                                  OPCNDPR5
.
          MATCH     SP18,DIM18
          GOTO      PSPD0000 IF EQUAL
.
          PRINT     *58,DIM18,*78,":   :";
PSPD5000
          ADD       ONE,COUNTER2
          MOVE      SP20,DIM18
.
          COMPARE   COUNTER2,FOUR
          GOTO      PSPD9000 IF LESS
.
          LOAD      DIM18,COUNTER2,OPCNDPS1,OPCNDPS2,OPCNDPS3,OPCNDPS4
.
          MATCH     SP18,DIM18
          GOTO      PSPD5000 IF EQUAL
.
          PRINT     *88,DIM18,*108,":   :"
.
          ADD       ONE,CLNO
          GOTO      PSPD9999
PSPD9000
          ADD       ONE,CLNO
          PRINT     " "
PSPD9999
          RETURN
.------------------------------------------------------------------------------
.         PGBR0000  Enter page break required
.------------------------------------------------------------------------------
PGBR0000  MOVE      ANSY,PAGBREAK
          DISPLAY   *P1:22,*EL,"Page Break Required (Y/N) : "
          KEYIN     *P28:22,*DV,UNDLN6:
                    *P28:22,*V2LON,PAGBREAK:
                    *P28:22,*DV,PAGBREAK
.        
          RESET     PAGBREAK 
          MATCH     SP70,PAGBREAK
          IF        @EQUAL
            PACK      PAGBREAK,ANSY
            GOTO      PGBR9999
          ELSE
            REP       "nNyY",PAGBREAK
.      
            MATCH     ANSY,PAGBREAK
            GOTO      PGBR9999 IF EQUAL
.
            MATCH     ANSN,PAGBREAK
            GOTO      PGBR9999 IF EQUAL
.
            GOTO      PGBR0000
          ENDIF
.
PGBR9999  RETURN
.
.------------------------------------------------------------------------------
.         IMED0000  Printe medical bookings on layout 9/10
.------------------------------------------------------------------------------
IMED0000  IF        OPCNR66A=9 | OPCNR66A=10
            GOTO      IMED2000
          ENDIF
.
          GOTO      IMED9999
.
IMED2000  MOVE      ANSY,INCLMEDB
          DISPLAY   *P1:23,*EL,"Include Medical Bookings (Y/N) : "
          KEYIN     *P34:23,*DV,UNDLN6:
                    *P34:23,*V2LON,INCLMEDB:
                    *P34:23,*DV,INCLMEDB
.
          RESET     INCLMEDB
          MATCH     SP70,INCLMEDB
          IF        @EQUAL
            PACK      INCLMEDB,ANSY
            GOTO      IMED9999
          ELSE
            REP       "nNyY",INCLMEDB
.
            MATCH     ANSY,INCLMEDB
            GOTO      IMED9999 IF EQUAL
.
            MATCH     ANSN,INCLMEDB
            GOTO      IMED9999 IF EQUAL
.
            GOTO      IMED0000
          ENDIF
.
IMED9999  RETURN
.------------------------------------------------------------------------------
.         KHOS0000
.         Enter The Hospital
.------------------------------------------------------------------------------
KHOS0000  COMPARE   ONE,IBCNMHOS
          GOTO      KHOS9999 IF NOT EQUAL
.
          DISPLAY   *P1:21,*EL,"Hospital Id : ";
          MOVE      TEN5,ECOL
          MOVE      TWENTY1,EVERT
          MOVE      SP3,CKYIDEF3
          MOVE      ZERO,CKYIMAND           * Not Mandatory
          OPEN      PATHSPA1,"pathspaf"
.
          CALL      PATHSPKY
          BRANCH    EXIT,KHOS2000,KHOS9500
          GOTO      KHOS3000
.
KHOS2000  MOVE      "All Hospitals",PTHSNAME
          MOVE      SP10,PTHSHOSP
          MOVE      ZERO,EXIT
.
KHOS3000  CLOSE     PATHSPA1
.
          DISPLAY   *P20:21,*V2LON,PTHSNAME;
          PACK      HOSNAME,PTHSNAME,SP70
          PACK      HOSCODE,PTHSHOSP,SP70
.
          GOTO      KHOS9999
.
KHOS9500  MOVE      ONE,EXIT
KHOS9999  RETURN
+
.*********************************************************************
.*                        GANA0000                                   *
.*                 Get anaesthetist description                      *
.*********************************************************************
GANA0000  CLEAR     SESSCORD
          PACK      KEY6,SP70
          MATCH     OPSEANAE,SP70
          IF        @EQUAL | @EOS
            MOVE      "OP",CATEGORY
.
            MATCH     OPSETYD8,SP70
            IF        !@EQUAL
              MOVE      OPSETYD8,CODE
              CALL      GETCOD00
              MATCH     ANSA,TCINDC2
              IF        @EQUAL
                MOVE      OPSEDCC8,KEY6
              ENDIF 
            ENDIF
.
            MATCH     OPSETYD7,SP70
            IF        !@EQUAL
              MOVE      OPSETYD7,CODE
              CALL      GETCOD00
              MATCH     ANSA,TCINDC2
              IF        @EQUAL
                MOVE      OPSEDCC7,KEY6
              ENDIF
            ENDIF
.
            MATCH     OPSETYD6,SP70
            IF        !@EQUAL
              MOVE      OPSETYD6,CODE
              CALL      GETCOD00
              MATCH     ANSA,TCINDC2
              IF        @EQUAL
                MOVE      OPSEDCC6,KEY6
              ENDIF
            ENDIF
. 
            MATCH     OPSETYD5,SP70
            IF        !@EQUAL
              MOVE      OPSETYD5,CODE
              CALL      GETCOD00
              MATCH     ANSA,TCINDC2
              IF        @EQUAL
                MOVE      OPSEDCC5,KEY6
              ENDIF
            ENDIF
.
            MATCH     OPSETYD4,SP70
            IF        !@EQUAL
              MOVE      OPSETYD4,CODE
              CALL      GETCOD00
              MATCH     ANSA,TCINDC2
              IF        @EQUAL
                MOVE      OPSEDCC4,KEY6
              ENDIF
            ENDIF
.
            MATCH     OPSETYD3,SP70
            IF        !@EQUAL
              MOVE      OPSETYD3,CODE
              CALL      GETCOD00
              MATCH     ANSA,TCINDC2
              IF        @EQUAL
                MOVE      OPSEDCC3,KEY6
              ENDIF
            ENDIF
.
            MATCH     OPSETYD2,SP70
            IF        !@EQUAL 
              MOVE      OPSETYD2,CODE
              CALL      GETCOD00
              MATCH     ANSA,TCINDC2
              IF        @EQUAL
                MOVE      OPSEDCC2,KEY6
              ENDIF
            ENDIF
.
            MATCH     OPSETYD1,SP70
            IF        !@EQUAL
              MOVE      OPSETYD1,CODE
              CALL      GETCOD00
              MATCH     ANSA,TCINDC2
              IF        @EQUAL
                MOVE      OPSEDCC1,KEY6
              ENDIF
            ENDIF
.
          ELSE
            PACK      KEY6,OPSEANAE
          ENDIF
          LOAD      KEY6,OPCNSESS,OPSECORD
.
GANA9999  RETURN
+
.*********************************************************************
.* Print medical bookings at the end of each day for layout 9/10     *
.*********************************************************************
MEDB0000  IF        OPCNR66A=9 | OPCNR66A=10 
            GOTO      MEDB0500
          ENDIF
.
          GOTO      MEDB9999
.
MEDB0500  MATCH     ANSY,INCLMEDB           * Print medical bookings
          GOTO      MEDB9999 IF NOT EQUAL
.
          MATCH     ANSY,PAGBREAK
          IF        @EQUAL
            MOVE      "99",CLNO             * Force page break 
          ENDIF
.
          MOVE      ZERO,TOTALBOK
          CALL      MEDH0000                * Medical bookings header
.
          PACK      KEY16,DATEOFOP,SP70
          CALL      RSBKREC4
MEDB1000  CALL      RKBKREC4
          BRANCH    OVRCD,MEDB9000
.
          MATCH     DATEOFOP,BKREEDAT       * test if correct date
          GOTO      MEDB9000 IF NOT EQUAL
.
          PACK      KEY5,ANSB,ANSK,BKRETYPE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,MEDB1000
.
          MATCH     "NOR",THCSCOD           * Include HDP or NOR only
          GOTO      MEDB1000 IF NOT EQUAL
.
          COMPARE   ZERO,BKRESTAT           * Include status of booked
          GOTO      MEDB2000 IF EQUAL
.
          COMPARE   ONE,BKRESTAT            * Include status of pre admitted
          GOTO      MEDB2000 IF EQUAL
.
          COMPARE   THREE,BKRESTAT          * Include status of admitted
          GOTO      MEDB2000 IF EQUAL
.
          GOTO      MEDB1000
.
MEDB2000  PACK      KEY8,BKREBOOK,KEY8
          CALL      RDBKRX11                * Read booking extn
          BRANCH    OVRCD,MEDB1000
.
          PACK      KEY8,BKREURNO,SP70
          CALL      RDMAST1                 * Read pmi details
          BRANCH    OVRCD,MEDB1000
.
          CALL      RDPMPX21                * Read pmi extn table
          BRANCH    OVRCD,MEDB1000
.
          PACK      KEY4,PTITL,SP70
          CALL      RDPMTLE1
          IF        OVRCD=1
            MOVE      PTITL,PMTLDESC
          ENDIF
.
          STRIP     PMTLDESC                * Remove trailing space from names
          STRIP     PMPXFNAM
          STRIP     PMPXSNAM
.
          CLEAR     PRNTNAME
          APPEND    PMTLDESC,PRNTNAME
          APPEND    SP1,PRNTNAME
          APPEND    PMPXFNAM,PRNTNAME
          APPEND    SP1,PRNTNAME
          APPEND    PMPXSNAM,PRNTNAME
          APPEND    SP70,PRNTNAME           * Set title, first and second name
.
          MOVE      DATEOFOP,AGEDATE
          CALL      CALCAGE                 * calculate patient age
          MOVE      PSAGEYRS,DAGE
.
          COMPARE   ZERO,PSAGEYRS
          GOTO      MEDB1200 IF NOT EQUAL
.
          MOVE      PSAGEMNT,FORM2
          PACK      DAGE,FORM2,ANSM
.
          COMPARE   ZERO,PSAGEMNT
          GOTO      MEDB1200 IF NOT EQUAL
.
          MOVE      PSAGEDAY,FORM2
          PACK      DAGE,FORM2,ANSD
.
MEDB1200  CALL      FMDG0000                * Format diagnosis for print
          CALL      FMTC0000                * Format comments for printing
.
          MOVE      BKREATIM,PRNTTIME       * Expected time
.
          MOVE      SP70,DOCFNAME
          PACK      KEY6,BKREADOC,SP70
          CALL      RDDOCT1
          IF        OVRCD<>1
            MOVE      DTITL,PACTITLE
            MOVE      DGNAME,D1
            MOVE      D1,PACGNAME
            MOVE      DSNAME,PACSNAME
            CALL      PACNAME
            MOVE      PACFNAME,DOCFNAME
          ENDIF
.
          MOVE      SP70,PRNTWARD
          MATCH     SP3,BKREEBED
          IF        @EQUAL
            PACK      PRNTWARD,BKREWARD,SP7            * patient ward
          ELSE
            PACK      PRNTWARD,BKREWARD,SLASH,BKREEBED * patient ward / bed
          ENDIF
.
          IF        IBCNMHOS=1
            MATCH     SP70,BKREWARD           * Get hospital from expected ward
            GOTO      MEDB1000 IF EQUAL
.
            MATCH     SP70,HOSCODE            * All Hospitals
            IF        !@EQUAL
              PACK      KEY6,BKREWARD,SP70
              CALL      RDWARD1               * Read ward 
              BRANCH    OVRCD,MEDB1000
.
              MATCH     PTWDHOSN,HOSCODE      * Correct hospital
              GOTO      MEDB1000 IF NOT EQUAL
            ENDIF
          ENDIF
.
          IF        BKRESTAT=1 | BKRESTAT=3
            PACK      KEY8,BKREBOOK,SP70   * Pre adm or admistted
            CALL      RDMISS1              * read admisions file
            IF        OVRCD<>1
              MATCH     SP3,PTMIEBED
              IF        @EQUAL
                PACK      PRNTWARD,PTMIXWRD,SP7            * patient ward
              ELSE
                PACK      PRNTWARD,PTMIXWRD,SLASH,PTMIEBED * patient ward / bed
              ENDIF
            ENDIF
          ENDIF
.
          CALL      MEDL0000                * Print medical booking line
          GOTO      MEDB1000
.
MEDB9000  CALL      UND132
          PRINT     *N,"Number of bookings : ",TOTALBOK:
                    *N,*N,"*** End of Report ***"
.
MEDB9999  RETURN
+
.*********************************************************************
.* Print medical bookings heading for layout 9                       *
.*********************************************************************
MEDH0000  COMPARE   CLNO,FIFTY5
          GOTO      MEDH1000 IF NOT LESS
.
          CALL      HEAD132

MEDH1000  CALL      UND132
.
          UNPACK    DATEOFOP,CCENT,CYEAR,CMON,CDAY
          CALL      DATECONV
          LOAD      DAYDESC,WEEKDAY,MONDAY,TUESDAY,WEDNSDAY,THURSDAY:
                                    FRIDAY,SATURDAY,SUNDAY
.        
          PRINT     *1,DAYDESC,*15,REPDATE,*30,"Medical Bookings"
          CALL      UND132
.
          PRINT     *1,"|Adm",*7,"|Expected",*16,"|POP",*20,"|H":
                    *27,"|CL",*31,"|Surname":
                    *52,"|Sex",*56,"|U/R No.",*65,"|Att Doctor":
                    *85,"|Diagnosis",*112,"|Booking",*132,"|":
.
                    *N,*1,"|Time",*7,"|Ward/Bed",*16,"|Wrd",*20,"|Fnd":
                    *27,"|Typ",*31,"|Title, Given Name":
                    *52,"|Age",*56,"|Book No.",*65,"|":
                    *85,"|",*112,"|Comments",*132,"|"
.
          ADD       TWO,CLNO
          CALL      UND132
.
MEDH9999 RETURN
.
.*********************************************************************
.* Print medical bookings line for layout 9                          *
.*********************************************************************
MEDL0000 ADD       ONE,TOTALBOK            * Booking counter
.
         COMPARE   CLNO,FIFTY5             * test if page is full
         CALL      MEDH0000 IF LESS
.
         PRINT     *1,"|",PRNTTIME,*7,"|",PRNTWARD,*16,"|",BKRXPOWD:
                   *20,"|",PFUNDH:
                   *27,"|",BKRECLMT,*31,"|",PSNAME:
                   *52,"|",PSEX,*56,"|",BKREURNO,*65,"|",DOCFNAME:
                   *85,"|",PRNTDES1,*112,"|",PRNTCOM1,*132,"|"
.
         PRINT     *1,"|",SP1,*7,"|",SP1,*16,"|",SP1:
                   *20,"|",SP1:
                   *27,"|",SP1,*31,"|",PRNTNAME:
                   *52,"|",DAGE,*56,"|",BKREBOOK,*65,"|",SP1:
                   *85,"|",PRNTDES2,*112,"|",PRNTCOM2,*132,"|"
.
         ADD        ONE,CLNO    
.
MEDL9999 RETURN
.
.*********************************************************************
.* Format booking comments for printing in layout 9                  *
.* 2 by 19 character fields. This will only split lines between words*
.*********************************************************************
FMTC0000  MOVE      SP70,COMLINE1
          MOVE      SP70,COMLINE2
          CALL      VSCMNT00 
.
          PACK      FULLCOMM,SP70,SP70
          MOVE      SP70,PRNTCOM1          * Clear comment vars
          MOVE      SP70,PRNTCOM2
.
          STRIP     COMLINE1                * Remove trailing white space
          STRIP     COMLINE2
.
          PACK      FULLCOMM,COMLINE1,SP1,COMLINE2  *
.
          MOVE      ZERO,LOOPCNTR           * Loop count
.
FMTC1000  ADD       ONE,LOOPCNTR            * Add one to loop count
.
          STRIP     FULLCOMM                * Remove trailing spaces
          MOVELPTR  FULLCOMM,TOTLNGTH       * Save LL
.
          COMPARE   ZERO,TOTLNGTH           * LL = 0 comment string empty
          GOTO      FMTC9000 IF EQUAL       * so exit
.
          IF        TOTLNGTH<=19
            STORE     FULLCOMM,LOOPCNTR,PRNTCOM1,PRNTCOM2
            GOTO      FMTC9000              * Exit no more comment
          ENDIF
.
          BUMP      FULLCOMM,19             * Set FP to 19th characters
.
FMTC1200  MATCH     SP1,FULLCOMM            * Check if last character is a space
          IF        !@EQUAL
            BUMP      FULLCOMM,-1           * Search for a space prior to 19th
            GOTO      FMTC1200 IF NOT EOS   * character 1 at a time
.
            MOVE      TEN9,SAVLNGTH         * No spaces in the 19th characters 
            GOTO      FMTC1300              * so use all 19
          ENDIF
.
          MOVEFPTR  FULLCOMM,SAVLNGTH       * Store FP position of last space
.
FMTC1300  RESET     FULLCOMM                * Reset FP to zero and set LL to
          SETLPTR   FULLCOMM,SAVLNGTH       * the position of the last space
.
          STORE     FULLCOMM,LOOPCNTR,PRNTCOM1,PRNTCOM2    * Store description
.
          RESET     FULLCOMM                * Reset FP and set the
          SETLPTR   FULLCOMM,TOTLNGTH       * LL to the total length
          BUMP      FULLCOMM,SAVLNGTH       * Set FP to position of last space
.
          MOVE      FULLCOMM,SAVPCOMM       * Save remaining comment
.
          RESET     FULLCOMM                * Reset comment and populate
          PACK      FULLCOMM,SAVPCOMM,SP70: * with the remaining comment
                             SP70
.
          COMPARE   TWO,LOOPCNTR
          GOTO      FMTC1000 NOT EQUAL      * loop back to start
.
FMTC9000  PACK      PRNTCOM1,PRNTCOM1,SP70  * Pack all comments with spaces
          PACK      PRNTCOM2,PRNTCOM2,SP70
.
          LJUSTIFY  PRNTCOM1                * Left justify to remove leading
          LJUSTIFY  PRNTCOM2                * spaces
.
FMTC9999  RETURN
.
.----------------------------------------------------------------------
. Retrieve the 1st 2 comment text lines of the latest active visit
. comment details
.----------------------------------------------------------------------
VSCMNT00  MOVE      BKREBOOK,KEY8
          PACK      KEY17,KEY8,VSCMTTYP,Z70      * Key for start of comment
          CALL      RSVSMDT1
VSCMNT20  CALL      RPVSMDT1
          BRANCH    OVRCD,VSCMNT99
.
          MATCH     KEY8,VSMDVISN
          GOTO      VSCMNT99 IF NOT EQUAL
.
          MATCH     VSCMTTYP,VSMDTYPE
          GOTO      VSCMNT99 IF NOT EQUAL
.
          MATCH     "1",VSMDDELT          * is comment deleted
          GOTO      VSCMNT20 IF EQUAL
.
. Retrieve the comment text line details
.
          MOVE      ZERO,F1
          PACK      KEY20,VSMDVISN,VSMDTYPE,VSMDNOTE,SP70
          CALL      RSVSMTX1
VSCMNT60  CALL      RKVSMTX1
          BRANCH    OVRCD,VSCMNT99
.
          MATCH     VSMDVISN,VSMTVISN
          GOTO      VSCMNT99 IF NOT EQUAL
.
          MATCH     VSMDTYPE,VSMTTYPE
          GOTO      VSCMNT99 IF NOT EQUAL
.
          MATCH     VSMDNOTE,VSMTNOTE
          GOTO      VSCMNT99 IF NOT EQUAL
.
          ADD       ONE,F1
          IF        F1 = ONE
            MOVE      VSMTCMNT,COMLINE1   * get 1st comment line
          ENDIF
.
          IF        F1 = TWO
            MOVE      VSMTCMNT,COMLINE2   * get 2nd comment line
          ENDIF
.
          COMPARE   TWO,F1                * only 2 comment text is used
          GOTO      VSCMNT60 IF NOT EQUAL
.
VSCMNT99  RETURN
.
.*********************************************************************
.* Format booking diagnosis for printing in layout 9                 *
.* 2 by 26 character fields. This will only split lines between words*
.*********************************************************************
FMDG0000  PACK      KEY18,BKREBOOK,SP9,ONE,SP70
          CALL      RDBKDIA1
          IF        OVRCD=1
            PACK      BKDIDES1,SP70,SP70    * Display diagnosis
          ENDIF
.
          PACK      FULLDIAG,SP70,SP70
          MOVE      SP70,PRNTDES1          * Clear diag vars
          MOVE      SP70,PRNTDES2
.
          STRIP     BKDIDES1                * Remove trailing white space
.
          PACK      FULLDIAG,BKDIDES1
.
          MOVE      ZERO,LOOPCNTR           * Loop count
.
FMDG1000  ADD       ONE,LOOPCNTR            * Add one to loop count
.
          STRIP     FULLDIAG                * Remove trailing spaces
          MOVELPTR  FULLDIAG,TOTLNGTH       * Save LL
.
          COMPARE   ZERO,TOTLNGTH           * LL = 0 diag string empty
          GOTO      FMDG9000 IF EQUAL       * so exit
.
          IF        TOTLNGTH<=26
            STORE     FULLDIAG,LOOPCNTR,PRNTDES1,PRNTDES2
            GOTO      FMDG9000              * Exit no more diag
          ENDIF
.
          BUMP      FULLDIAG,26             * Set FP to 19th characters
.
FMDG1200  MATCH     SP1,FULLDIAG            * Check if last character is a space
          IF        !@EQUAL
            BUMP      FULLDIAG,-1           * Search for a space prior to 26th
            GOTO      FMDG1200 IF NOT EOS   * character 1 at a time
.
            MOVE      TWENTY6,SAVLNGTH      * No spaces in the 19th characters
            GOTO      FMDG1300              * so use all 26
          ENDIF
.
          MOVEFPTR  FULLDIAG,SAVLNGTH       * Store FP position of last space
.
FMDG1300  RESET     FULLDIAG                * Reset FP to zero and set LL to
          SETLPTR   FULLDIAG,SAVLNGTH       * the position of the last space
.
          STORE     FULLDIAG,LOOPCNTR,PRNTDES1,PRNTDES2    * Store description
.
          RESET     FULLDIAG                * Reset FP and set the
          SETLPTR   FULLDIAG,TOTLNGTH       * LL to the total length
          BUMP      FULLDIAG,SAVLNGTH       * Set FP to position of last space
.
          MOVE      FULLDIAG,SAVEDIAG       * Save remaining diag
.
          RESET     FULLDIAG                * Reset diag and populate
          PACK      FULLDIAG,SAVEDIAG,SP70: * with the remaining diag
                             SP70
.
          COMPARE   TWO,LOOPCNTR
          GOTO      FMDG1000 NOT EQUAL      * loop back to start
.
FMDG9000  PACK      PRNTDES1,PRNTDES1,SP70  * Pack all diag with spaces
          PACK      PRNTDES2,PRNTDES2,SP70
.
          LJUSTIFY  PRNTDES1                * Left justify to remove leading
          LJUSTIFY  PRNTDES2                * spaces
.
FMDG9999  RETURN

.
.**********************************************************************
.*                         I/O                                        *
.*             I/O routines for temp file                             *
.**********************************************************************
.
.------ I/O Routines for temp file ------
.
RATHET1   MOVE      ZERO,OVRCD
          RESET     KEY30
          READ      TMPTHET1,KEY30;ANS
          GOTO      OVERCOND IF OVER
          RETURN
.
RSTHET1   MOVE      ZERO,OVRCD
          RESET     KEY30
          READ      TMPTHET1,KEY30;;
          RETURN
.
RDTHET1   MOVE      ZERO,OVRCD
          RESET     KEY30
          READ      TMPTHET1,KEY30;THETROOM,THETTIME,THETCLIN,THETCASE,THETUNIQ
          GOTO      OVERCOND IF OVER
          RETURN
.
RKTHET1   MOVE      ZERO,OVRCD
          RESET     KEY30
          READKS    TMPTHET1;THETROOM,THETTIME,THETCLIN,THETCASE,THETUNIQ
          GOTO      OVERCOND IF OVER
          RETURN
.
RPTHET1   MOVE      ZERO,OVRCD
          RESET     KEY30
          READKP    TMPTHET1;THETROOM,THETTIME,THETCLIN,THETCASE,THETUNIQ
          GOTO      OVERCOND IF OVER
          RETURN
.
WRTHET1   MOVE      ZERO,OVRCD
          RESET     KEY30
          WRITE     TMPTHET1,KEY30;THETROOM,THETTIME,THETCLIN,THETCASE,THETUNIQ
          RETURN
.
UPTHET1   UPDATE    TMPTHET1;THETROOM,THETTIME,THETCLIN,THETCASE,THETUNIQ
          RETURN
.
DETHET1   RESET     KEY30
          DELETE    TMPTHET1,KEY30
          RETURN
.
.*******  REPORT BY SURGEON I/O *******
.
.
RASURG1   MOVE      ZERO,OVRCD
          RESET     KEY28
          READ      TMPSURG1,KEY28;ANS
          GOTO      OVERCOND IF OVER
          RETURN
.
RSSURG1   MOVE      ZERO,OVRCD
          RESET     KEY28
          READ      TMPSURG1,KEY28;;
          RETURN
.
RDSURG1   MOVE      ZERO,OVRCD
          RESET     KEY28
          READ      TMPSURG1,KEY28;SURGCODE,SURGTIME,SURGCLIN,SURGCASE:
                                   SURGADMN,SURGSTAT
          GOTO      OVERCOND IF OVER
          RETURN
.
RKSURG1   MOVE      ZERO,OVRCD
          RESET     KEY28
          READKS    TMPSURG1;SURGCODE,SURGTIME,SURGCLIN,SURGCASE:
                            SURGADMN,SURGSTAT
          GOTO      OVERCOND IF OVER
          RETURN
.
RPSURG1   MOVE      ZERO,OVRCD
          RESET     KEY28
          READKP    TMPSURG1;SURGCODE,SURGTIME,SURGCLIN,SURGCASE:
                             SURGADMN,SURGSTAT
          GOTO      OVERCOND IF OVER
          RETURN
.
WRSURG1   MOVE      ZERO,OVRCD
          RESET     KEY28
          WRITE     TMPSURG1,KEY28;SURGCODE,SURGTIME,SURGCLIN,SURGCASE:
                                   SURGADMN,SURGSTAT
          RETURN
.
UPSURG1   UPDATE    TMPSURG1;SURGCODE,SURGTIME,SURGCLIN,SURGCASE:
                             SURGADMN,SURGSTAT
          RETURN
.
DESURG1   RESET     KEY28
          DELETE    TMPSURG1,KEY28
          RETURN
.
.
.****** REPORT BY CLINIC I/O ******
.
RACLIN1   MOVE      ZERO,OVRCD
          RESET     KEY22
          READ      TMPCLIN1,KEY22;ANS
          GOTO      OVERCOND IF OVER
          RETURN
.
RSCLIN1   MOVE      ZERO,OVRCD
          RESET     KEY22
          READ      TMPCLIN1,KEY22;;
          RETURN
.
RDCLIN1   MOVE      ZERO,OVRCD
          RESET     KEY22
          READ      TMPCLIN1,KEY22;CLINCODE,CLINTIME,CLINCASE,CLINADMN,CLINSTAT
          GOTO      OVERCOND IF OVER
          RETURN
.
RKCLIN1   MOVE      ZERO,OVRCD
          RESET     KEY22
          READKS    TMPCLIN1;CLINCODE,CLINTIME,CLINCASE,CLINADMN,CLINSTAT
          GOTO      OVERCOND IF OVER
          RETURN
.
RPCLIN1   MOVE      ZERO,OVRCD
          RESET     KEY22
          READKP    TMPCLIN1;CLINCODE,CLINTIME,CLINCASE,CLINADMN,CLINSTAT
          GOTO      OVERCOND IF OVER
          RETURN
.
WRCLIN1   MOVE      ZERO,OVRCD
          RESET     KEY22
          WRITE     TMPCLIN1,KEY22;CLINCODE,CLINTIME,CLINCASE,CLINADMN,CLINSTAT
          RETURN
.
UPCLIN1   UPDATE    TMPCLIN1;CLINCODE,CLINTIME,CLINCASE,CLINADMN,CLINSTAT
          RETURN
.
DECLIN1   RESET     KEY22
          DELETE    TMPCLIN1,KEY22
          RETURN
.
.*****   Period I/O *****
.
RAPERI1   MOVE      ZERO,OVRCD
          RESET     KEY23
          READ      TMPPERI1,KEY23;ANS
          GOTO      OVERCOND IF OVER
          RETURN
.
RSPERI1   MOVE      ZERO,OVRCD
          RESET     KEY23
          READ      TMPPERI1,KEY23;;
          RETURN
.
RDPERI1   MOVE      ZERO,OVRCD
          RESET     KEY23
          READ      TMPPERI1,KEY23;PERICODE,PERITHET,PERITIME,PERICLIN,PERICASE:
                                   PERISTAT 
          GOTO      OVERCOND IF OVER
          RETURN
.
RKPERI1   MOVE      ZERO,OVRCD
          RESET     KEY23
          READKS    TMPPERI1;PERICODE,PERITHET,PERITIME,PERICLIN,PERICASE:
                             PERISTAT 
          GOTO      OVERCOND IF OVER
          RETURN
.
RPPERI1   MOVE      ZERO,OVRCD
          RESET     KEY23
          READKP    TMPPERI1;PERICODE,PERITHET,PERITIME,PERICLIN,PERICASE:
                             PERISTAT 
          GOTO      OVERCOND IF OVER
          RETURN
.
WRPERI1   MOVE      ZERO,OVRCD
          RESET     KEY23
          WRITE     TMPPERI1,KEY23;PERICODE,PERITHET,PERITIME,PERICLIN,PERICASE:
                                   PERISTAT
          RETURN
.
UPPERI1   UPDATE    TMPPERI1;PERICODE,PERITHET,PERITIME,PERICLIN,PERICASE:
                             PERISTAT
          RETURN
.
DEPERI1   RESET     KEY23
          DELETE    TMPPERI1,KEY23
          RETURN
.
.***********************************************************************
.
          INC       STD001IO
          INC       CLOPRSES
          INC       DATECONV
          INC       SEXDSCIO
          INC       TFILENAM                * Generate Temp File Name
          INC       IBASEQIO/INC            * Sequential Numbers File
          INC       WEBERRIO/INC            * Web Server Error Logging
.
          INC       BOKDIAIO/INC
          INC       BOKRC1IO/INC
          INC       BOKRX1IO/INC
          INC       CALCAGE
          INC       OPRCLIDS
          INC       OPRCLIIO/INC
          INC       OPRARDIO/INC
          INC       OPRCOMIO/INC
          INC       OPRDEAIO/INC
          INC       OPRDEBIO/INC
          INC       OPRDEDIO/INC
          INC       OPROPRDS
          INC       OPROPRIO/INC
          INC       OPRORUIO/INC
          INC       OPRSESIO/INC
          INC       OPRSRGIO/INC
          INC       OPRTSMIO/INC
          INC       PATCODKY
          INC       PATHSPKY
          INC       PATDOCKY
          INC       PATDOCDS
          INC       PATCODTM
          INC       PATCODIO/INC
          INC       MLTCODIO/INC
          INC       VISMDTIO/INC
          INC       VISMTXIO/INC
          INC       PATDO1IO/INC
          INC       PATMA1IO/INC
          INC       PATMI1IO/INC
          INC       PATWR1IO/INC
          INC       PATPR1IO/INC
          INC       PATHSPIO/INC
          INC       PMSPX2IO/INC
          INC       PMSTLEIO/INC
          INC       PMSVX1IO/INC
          INC       PATTRNIO/INC
          INC       WEBSECIO/INC
...............................................................................
