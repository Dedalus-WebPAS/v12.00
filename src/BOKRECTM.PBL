.-------------------------------------------------------------------------------
. Program       : BOKRECTM
.
. Function      : Profield for Booking file
.
. Modifications  :
.----------------------------------------------------------------------
. V12.00.01 22/05/2025  Alina Bhari    TSK 0955096
.                       Added alpanumeric visit number generation 
.                       -BREC3100,BREC3200,BREC3300,BREC3400
.V11.05.03  16.04.2025 PJ Le Febour    TSK 0958055
.                      BREC4220 added test of WACTIVE when 0 display bed
.V11.05.02  19.12.2024 DA Sarkies      TSK 0954547
.           Commented out <cat> tags to prevent browser incompatibility
.V11.05.01  26.11.2024 Ebon Clements  Task 0954547
.                      Added <cat-c> start and end tag to category=XX tag
.V10.03.01  13/08/2012 Patrick Adair  CAR 253988
.                      Added PATWR1FD/IO to PROC BKWLP000 to insulate parent
.                      code from close statement
.V10.02.01  27/06/2011 Peter McMullen CAR 240725
.                      Change ward seletion list to sort by name,not code
. V9.12.01  26/08/2009 Peter McMullen CAR 171901
.                      remove MAPCAT00 call
. V9.11.01  01.12.2008 Ebon Clements CAR 174057
.                      Added BKREWARD and BKREEBED selection list tags
. V9.10.01  19.05.2008 Ebon Clements CAR 162051
.                      Added BKREDOFR
. V9.09.01  09.01.2007 Jill Habasque CAR 158212
.                      Added BKSEL000 - output of cat BK with hdp=THE
. V9.08.01  20.10.2006 Ebon Clements             CAR 120991
.                      Added referring GP tag
. V9.04.01  13.09.2005 Jill Habasque             CAR 75973
.                      Added call to coditm00 for bkreaccm
. V9.03.02  18.03.2004 Peter Vela                CAR 13038
.                      Changed call DOCNAM00 to DOCNM000 (parameter driven 
.                      doctor name format) for sort lists.
. V9.03.01  22.07.2003 Jill Habasque             SRF 21760
.                      Changed key for bokdiaaf
. V9.02.02  21.10.2002 Pat Dirito                SRF 23689
.                      Fixed Tag added by HPS-BREC3600
. V9.02.01  28.02.2002 Jill Habasque
.                      Added tag for bkrebkdt
. V9.01.01  14.08.2001 Sachin -HPS 
.                      Modified for ward description.
.------------------------------------------------------------
. Add Field
.------------------------------------------------------------
BREC0000  MOVE      FLDITEM,F3
          BRANCH    F3,BREC0100,BREC0200,BREC0300,BREC0400,BREC0500:
                       BREC0600,BREC0700,BREC0800,BREC0900,BREC1000:
                       BREC1100,BREC1200,BREC1300,BREC1400,BREC1500:
                       BREC1600,BREC1700,BREC1800,BREC1900,BREC2000:
                       BREC2100,BREC2200,BREC2300,BREC2400,BREC2500:
                       BREC2600,BREC2700,BREC2800,BREC2900,BREC3000:
                       BREC3100,BREC3200,BREC3300,BREC3400,BREC3500:
                       BREC3600,BREC3700,BREC3800,BREC3900,BREC4000:
                       BREC4100,BREC4200
.
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      BREC9999
.
BREC0100  WRITE     HTMLFILE;BKREBOOK;
          GOTO      BREC9999
.
BREC0200  WRITE     HTMLFILE;BKREURNO;
          GOTO      BREC9999
.
BREC0300  WRITE     HTMLFILE;BKRESNAM;
          GOTO      BREC9999
.
BREC0400  MOVE      BKREADOC,DOCTCODE  
          CALL      DOCDET00
          GOTO      BREC9999
.
BREC0500  MOVE      BKRESDOC,DOCTCODE
          CALL      DOCDET00
          GOTO      BREC9999
.
BREC0600  MATCH     SP70,BKREEDAT
          GOTO      BREC9999 IF EQUAL
          UNPACK    BKREEDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      BREC9999
.
BREC0700  MATCH     SP70,BKREATIM
          GOTO      BREC9999 IF EQUAL
          WRITE     HTMLFILE;BKREATIM;
          GOTO      BREC9999
.
BREC0800  MATCH     SP70,BKREPDAT
          GOTO      BREC9999 IF EQUAL
          UNPACK    BKREPDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      BREC9999
.
BREC0900  MATCH     SP70,BKREPTIM
          GOTO      BREC9999 IF EQUAL
          WRITE     HTMLFILE;BKREPTIM;
          GOTO      BREC9999
.
BREC1000  MATCH     SP70,BKREADAT
          GOTO      BREC9999 IF EQUAL
          UNPACK    BKREADAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      BREC9999
.
BREC1100  MOVE      "BK",CATEGORY
          MOVE      BKRETYPE,CODE
          CALL      CODITM00
          GOTO      BREC9999
.
BREC1200  MOVE      "BC",CATEGORY
          MOVE      BKRECANC,CODE
          CALL      CODITM00
          GOTO      BREC9999
.
BREC1300  BRANCH    BKRESTAT,BREC1310,BREC1320,BREC1330,BREC1340
          WRITE     HTMLFILE;"Booked";
          GOTO      BREC9999
BREC1310  WRITE     HTMLFILE;"Pre-admitted";
          GOTO      BREC9999
BREC1320  WRITE     HTMLFILE;"Cancelled";
          GOTO      BREC9999
BREC1330  WRITE     HTMLFILE;"Admitted";
          GOTO      BREC9999
BREC1340  WRITE     HTMLFILE;"Discharged";
          GOTO      BREC9999
.
BREC1400  WRITE     HTMLFILE;BKREOMEM;
          GOTO      BREC9999
.
BREC1500  WRITE     HTMLFILE;BKREPREV;
          GOTO      BREC9999
.
BREC1600  MOVE      "BP",CATEGORY
          MOVE      BKREACCM,CODE
          CALL      CODITM00
          GOTO      BREC9999
.
BREC1700  WRITE     HTMLFILE;BKREPROC;
          GOTO      BREC9999
.
BREC1800  WRITE     HTMLFILE;BKRECNT;
          GOTO      BREC9999
.
BREC1900  WRITE     HTMLFILE;BKREWARD;
          GOTO      BREC9999
.
BREC2000  WRITE     HTMLFILE;BKREADMN;
          GOTO      BREC9999
.
BREC2100  WRITE     HTMLFILE;BKREPREA;
          GOTO      BREC9999
.
BREC2200  WRITE     HTMLFILE;BKREEBED;
          GOTO      BREC9999
.
BREC2300  MOVE      "P ",CATEGORY
          MOVE      BKRECLSS,CODE
          CALL      CODITM00
          GOTO      BREC9999
.
BREC2400  MOVE      "A ",CATEGORY
          MOVE      BKREATYP,CODE
          CALL      CODITM00
          GOTO      BREC9999
.
BREC2500  MOVE      "AC",CATEGORY
          MOVE      BKREDEPT,CODE
          CALL      CODITM00
          GOTO      BREC9999
.
BREC2600  MOVE      BKRETDOC,DOCTCODE
          CALL      DOCDET00
          GOTO      BREC9999
.
BREC2700  MOVE      "CL",CATEGORY
          MOVE      BKRECLMT,CODE
          CALL      CODITM00
          GOTO      BREC9999
.
BREC2800  MOVE      "CC",CATEGORY
          MOVE      BKREEATY,CODE
          CALL      CODITM00
          GOTO      BREC9999
.
BREC2900  WRITE     HTMLFILE;HWDSOUR;
          GOTO      BREC9999
.
BREC3000  WRITE     HTMLFILE;DBKREELO;
          GOTO      BREC9999
.
BREC3100  PACK      KEY18,BKREBOOK,SP70
          CALL      RSBKDIA1
          CALL      RKBKDIA1
          BRANCH    OVRCD,BREC9999
          MATCH     BKREBOOK,BKDIBOOK
          GOTO      BREC9999 IF NOT EQUAL
          MATCH     SP70,BKDICODE
          GOTO      BREC9999 IF EQUAL
          WRITE     HTMLFILE;BKDICODE;
          GOTO      BREC9999
.
BREC3200  PACK      KEY18,BKREBOOK,SP70
          CALL      RSBKDIA1
          CALL      RKBKDIA1
          BRANCH    OVRCD,BREC9999
          MATCH     BKREBOOK,BKDIBOOK
          GOTO      BREC9999 IF NOT EQUAL
          MATCH     SP70,BKDIDES1
          GOTO      BREC9999 IF EQUAL
          WRITE     HTMLFILE;BKDIDES1;
          GOTO      BREC9999
.
BREC3300  PACK      KEY18,BKREBOOK,SP70
          CALL      RSBKDIA1
          CALL      RKBKDIA1
          BRANCH    OVRCD,BREC9999
          MATCH     BKREBOOK,BKDIBOOK
          GOTO      BREC9999 IF NOT EQUAL
          MATCH     SP70,BKDIDES2
          GOTO      BREC9999 IF EQUAL
          WRITE     HTMLFILE;BKDIDES2;
          GOTO      BREC9999
.
BREC3400  PACK      KEY18,BKREBOOK,SP70
          CALL      RSBKDIA1
          CALL      RKBKDIA1
          BRANCH    OVRCD,BREC9999
          MATCH     BKREBOOK,BKDIBOOK
          GOTO      BREC9999 IF NOT EQUAL
          MATCH     SP70,BKDICOMM
          GOTO      BREC9999 IF EQUAL
          WRITE     HTMLFILE;BKDICOMM;
          GOTO      BREC9999
.
BREC3500  CALL      BOKSTB00
          GOTO      BREC9999
.
BREC3600  PACK      KEY6,BKREWARD,SP70         * Get Ward description  
          CALL      RDWARD1
          BRANCH    OVRCD,BREC9999
.
          WRITE     HTMLFILE;WBDESC;
          GOTO      BREC9999
.
BREC3700  MATCH     SP70,BKREBKDT
          GOTO      BREC9999 IF EQUAL
          UNPACK    BKREBKDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      BREC9999
.
BREC3800  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,BREC3810
.
          PACK      KEY10,BKRERFGP,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,BREC9999
.
          MOVE      PMHCTITL,FMTTITLE
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000
          WRITE     HTMLFILE;DOCFNAME;
          GOTO      BREC9999
.
BREC3810  WRITE     HTMLFILE;BKRERFGP;
          GOTO      BREC9999
.
BREC3900  MOVE      "BK",CATEGORY
          MOVE      BKRETYPE,CODE
          CALL      BKSEL000
          GOTO      BREC9999
.
BREC4000  MOVE      "DA",CATEGORY
          MOVE      BKREDOFR,CODE
          CALL      CODITM00
          GOTO      BREC9999
.
BREC4100  PACK      KEY3,BKREWARD
          PROC      BKWLP000 
          GOTO      BREC9999
.
BREC4200  MATCH     SP70,BKREWARD
          GOTO      BREC9999 IF EQUAL
.
          PACK      KEY6,BKREWARD,SP70
          CALL      RDSWARD1
BREC4220  CALL      RDKWARD1
          BRANCH    OVRCD,BREC9999
.
          MATCH     BKREWARD,WWARD
          GOTO      BREC9999 IF NOT EQUAL
.
          MATCH     SP70,WBED
          GOTO      BREC4220 IF EQUAL
.
          PACK      KEY5,QUOTE,WBED,QUOTE
.
          COMPARE   WACTIVE,ZERO                 *List only active wards
          GOTO      BREC4220 IF NOT EQUAL
.
          MATCH     BKREEBED,WBED
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY5,"selected>",WBED:
                               "</option>";
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY5,">",WBED:
                               "</option>";
          ENDIF
.
          GOTO      BREC4220
.
BREC9999  RETURN
.------------------------------------------------------------
. Add Selection Options to Form (code value)
.------------------------------------------------------------
BKSEL000  MOVE      SP70,TDESC
          PACK      KEY5,CATEGORY,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      CATEGORY,TCODE
            MOVE      "Invalid Category",TDESC
          ENDIF
          REP       " _",TCODE
          REP       " _",THCSCOD
          WRITE     HTMLFILE;"<!--<cat-c category=#"",TCODE,"#" name=#"",TDESC:
                             "#" map=#"",THCSCOD,"#"></cat-c>-->"
.
          PACK      PTCDKEY2,CATEGORY,SP70
          CALL      RDSCODE2
BKSEL100  CALL      RDKCODE2
          BRANCH    OVRCD,BKSEL999
          MATCH     CATEGORY,TCODE
          GOTO      BKSEL999 IF NOT EQUAL
          MATCH     SP70,ACODE
          GOTO      BKSEL100 IF EQUAL
.
          MATCH     "THE",THCSCOD
          GOTO      BKSEL100 IF NOT EQUAL
.
          PACK      KEY25,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5:
                          TCINDC6,TCINDC7,TCINDC8,TCINDC9,TCINDC10:
                          TCINDC11,THCSCOD,PTCDNHCP,TCFORM6
          PACK      KEY30,QUOTE,ACODE,KEY25,QUOTE
          MATCH     CODE,ACODE
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY30," selected>":
                               TDESC,"</option>"
          ELSE
            MATCH     "I",PTCOACTV
            GOTO      BKSEL100 IF EQUAL
.
            IF        IBCNMHOS=1
              MATCH    "1",PTCDHOSS
              IF       @EQUAL
                PACK     KEY8,WBSEHOSP,TCODE,ACODE,SP70
                CALL     RDMLCOD1
                BRANCH   OVRCD,BKSEL100
              ENDIF
            ENDIF
.
            WRITE     HTMLFILE;"<option value=",KEY30,">",TDESC,"</option>"
          ENDIF
          GOTO      BKSEL100
BKSEL999  RETURN
+
.------------------------------------------------------------
. Table for Bookings for a Patient
.------------------------------------------------------------
BOKSTB00  PACK      KEY16,URNUMBER,SP70
          CALL      RSBKREC6
BOKSTB10  CALL      RPBKREC6
          BRANCH    OVRCD,BOKSTB90
          MATCH     URNUMBER,BKREURNO
          GOTO      BOKSTB90 IF NOT EQUAL
.
          CLEAR     HTMLLINK
          APPEND    "javascript:BookingLink('",HTMLLINK
          APPEND    BKREBOOK,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          MOVE      "BK",CATEGORY
          MOVE      BKRETYPE,CODE
          CALL      GETCOD00
          MOVE      TDESC,BTYPDESC
.
          MOVE      "CL",CATEGORY
          MOVE      BKRECLMT,CODE
          CALL      GETCOD00
          MOVE      TDESC,CTYPDESC
.
          MOVE      "A ",CATEGORY
          MOVE      BKREATYP,CODE
          CALL      GETCOD00
          MOVE      TDESC,ATYPDESC
.
          MOVE      BKREADOC,KEY6    
          CALL      RDDOCT1 
          IF        OVRCD=1
            MOVE      SP70,DOCFNAME
          ELSE
.           CALL      DOCNAM00                * Format Doctor Name  
            MOVE      DTITL,FMTTITLE          * I CAR 13038
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000                * end I CAR 13038
          ENDIF
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",BKREBOOK,"#",":
                             "#"",BKREEDAT,BKREATIM,"#",":
                             "#"",ATYPDESC,"#",":
                             "#"",BTYPDESC,"#",":
                             "#"",CTYPDESC,"#",":
                             "#"",DOCFNAME,"#",";
          BRANCH    BKRESTAT,BOKSTB11,BOKSTB12,BOKSTB13,BOKSTB14
          WRITE     HTMLFILE;"#"Booked#")"
          GOTO      BOKSTB10
BOKSTB11  WRITE     HTMLFILE;"#"Pre-Admitted#")"
          GOTO      BOKSTB10
BOKSTB12  WRITE     HTMLFILE;"#"Cancelled#")"
          GOTO      BOKSTB10
BOKSTB13  WRITE     HTMLFILE;"#"Admitted#")"
          GOTO      BOKSTB10
BOKSTB14  WRITE     HTMLFILE;"#"Discharged#")"
          GOTO      BOKSTB10
.
BOKSTB90  MOVE      ADMISSNO,KEY8
          CALL      RDBKREC1
.
BOKSTB99  RETURN
+
.*****************************************************************************
.*  BKWLP000
.*  Procedure to build a ward selection list.
.*  This is packaged as a procedure to insulate parent code
.*  from patwr1af index 7 (bed,hospital,description,ward)
.*  KEY3 contains the current ward code (if any)
.*****************************************************************************
          DEFPROC   BKWLP000
.
          INC       PATWR1FD/INC
.
          OPEN      PATWR1A7,"patwr1af"
          PACK      KEY29,SP70
          IF        IBCNMHOS = 1
            PACK      KEY29,SP3,WBSEHOSP,SP70
          ENDIF
          CALL      RDSWARD7
BKWLP010  CALL      RDKWARD7
          BRANCH    OVRCD,BKWLP900
.
.                         if we have a bed number we have passed all the ward
.                         master records, so exit
          MATCH     SP70,WBED
          GOTO      BKWLP900 IF NOT EQUAL
.
          COMPARE   WACTIVE,ZERO                 *List only active wards
          GOTO      BKWLP010 IF NOT EQUAL
.
          IF        IBCNMHOS = 1
            MATCH      SP3,WBSEHOSP
            IF        !@EQUAL
              MATCH     WBSEHOSP,PTWDHOSN
              GOTO      BKWLP900 IF NOT EQUAL
            ENDIF
          ENDIF
.
.                       write the select option.
          WRITE     HTMLFILE;"<option value=#"",WWARD,"#"";
          MATCH     KEY3,WWARD
          IF        @EQUAL
            WRITE     HTMLFILE;" selected";
          ENDIF
          WRITE     HTMLFILE;">",WBDESC;
.
          IF        IBCNMHOS = 1
            MATCH      SP3,WBSEHOSP
            IF        @EQUAL
              WRITE     HTMLFILE;" - ",PTWDHOSN;
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"</option>"
          GOTO      BKWLP010
.
          INC       PATWR1IO/INC
          INC       IBAOVRIO/INC
.
BKWLP900  CLOSE     PATWR1A7
.
          ENDPROC
+
