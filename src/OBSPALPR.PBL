. Program       : OBSPALPR 
.
. Function      : Patient Alert Table
.               : This procedure is called from PATWEB98    
.
. Modifications :
. V11.05.02 17.01.2025  DA Sarkies     TSK 0954697
.           Updated RESLOC00 to produce validated JSON when hospital doesn't
.           contain either a phone, a fax, or both
. V11.05.01 13.01.2025  DA Sarkies     TSK 0954697
.           Fixed JSON Malfunction where hospital with no fax breaks JSON
. V11.04.02 17.01.2025  DA Sarkies     TSK 0954697
.           Updated RESLOC00 to produce validated JSON when hospital doesn't
.           contain either a phone, a fax, or both
. V11.04.01 13.01.2025  DA Sarkies     TSK 0954697
.           Fixed JSON Malfunction where hospital with no fax breaks JSON
. V11.03.06 24/08/2023  Peter Vela     TSK 0927262
.           Fixed hospital validation around RESLOC00
. V11.03.05 21/08/2023  Peter Vela     TSK 0927262
.           Added pmshcpaf direct read validation around RESASS00
. V11.03.04 15/08/2023  Peter Vela     TSK 0927262
.           Added space validation around RESLOC00 for PTALHOSP
. V11.03.03 31/07/2023  Peter Vela     TSK 0927262
.           Added dxc-hc-hcp and dxc-hc-speciality extensions
.           to Practitioner User resource
. V11.03.02 27/06/2023  Peter Vela     TSK 0927262
.           ClinicalAide FHIR API
.           Added Subject include FHRSUBIN functionality
.           Added Location include FHRLOCIN functionality
.           Added Practitioner include FHRPARIN functionality
. V11.03.01 29/05/2023  Peter Vela     TSK 0927262
.           ClinicalAide FHIR API
.           Added Patient include FHRPATIN functionality
.           Added Recorder include FHRRECIN functionality
.           Added Asserter include FHRASSIN functionality
. V11.02.02 01/09/2022  Alina Bhari    TSK 0913316
.           Displayed last updated by field as "AutoEndPgm" if record is
.           updated through "Auto-End Selected Alert Code" - ALTROW10
. V11.02.01 24/08/2022  Alina Bhari    TSK 0913316
.           Displayed last updated by field as "Auto Script" if record is
.           updated through "Auto-End Selected Alert Code" - ALTROW00
. V10.14.02 28/05/2019  Jill Parkinson Task 0875431
.           Removed order by end date - caused loop of entire alert table
. V10.14.01 27/02/2019  Nicole Torrisi TSK 0869561
.           Added Inactive/End Date column to HEADIN00 and ALTROW00
.           Changed output order of Alert Table in ALTS0000
. V10.12.01 24/04/2018  Richa Phogat TSK 0856013
.           Updated HEADIN00 to display column heading from Cat 'wn' 
. V10.11.03 23.10.2017  Ania P         TSK 0846812
.           Added missing DB read ALTROW17/ALTROW18
. V10.11.02 28.08.2017  B.G.Ackland    TSK 0835482 
.           FHIR Output Change to Patient Reference ID to strip spaces
.           FHIR Change Extension Naming
. V10.11.01 24.07.2017  B.G.Ackland    TSK 0835482 
.           Fix FHIR Output after Testing for ClinicalAide
.------------------------------------------------------------------------------- 
.                V10.10.06 11.07.2017  B.G.Ackland    TSK 0835482 
.                          FHIR Output Testing for ClinicalAide
.                V10.10.05 31/05/2017  Nicole Torrisi  TSK 0835656
.                          Changed ALTROW00 to show all comments 
.                V10.10.04 09/05/2017  Davin        TSK 0321570
.                          Don't allow adding of alert if tcindc8=1 (catl0000)
.                V10.10.03 08.05.2017  B.G.Ackland    TSK 0835482 
.                          FHIR Output Resolve Testing Issues Incorporate Version Control
.                V10.10.02 13.04.2017  B.G.Ackland    TSK 0835482 
.                          FHIR Interface Add webPAS Meta Data
.                V10.10.01 21/01/2017  B.G.Ackland    TSK 0835482 
.                          FHIR Interface for AllergyIntolerance and Flag Resource
.                V10.08.02 22/11/2016  Davin        TSK 0299197
.                          Added output of PTALRQBY (HCP DOCFNAME) @ altrow00
.                V10.08.01 11/05/2016  Jill Parkinson          
.                          Removed redundant matches to 0000 dates in altrow00
.                V10.06.01 25/06/2015  Don Nguyen   CAR 318419
.                          Added ALTROW04 to loop file for matching counter
.                V10.03.06 23/07/2013 Ania P        CAR 288806
.                          Added output for Updated By column.
.                V10.03.05 14/03/2013 Patrick Adair CAR 240163
.                          Only display active H1-H9 category codes
.                V10.03.04 13/11/2012  Jill Parkinson  CAR 272598
.                          Added reset of ALRCOMM to fix rep of "
.                V10.03.03 16/04/2012 Don Nguyen     CAR 263514
.                          Fixed output value of description for audit record
.                V10.03.02 09/12/2011 Jill Parkinson CAR 249362
.                          Added output of inactive and end date for alerts
.                V10.03.01 23/11/2011 Jill Parkinson CAR 249362
.                          Changed alert file key from KEY13 to KEY16
.                V10.02.02 30/09/2011 Saroeun Soeur CAR 208854
.                           added PTCNCUDA
.                V10.02.01 05/05/2011 Davin         CAR 239539
.                          Added option to use indc5 for alert icons
.                          (ALTS0000 & DELL0000)
.                          03/05/2011 Davin         CAR 239543
.                          Added category based security functionality for
.                          viewing alert lists (ALTS0000 & DELL0000)
.                 V9.07.02 21/09/2006 Ebon Clements CAR 107243
.                          Added deleted alerts functionality
.                 V9.07.01 11/07/2006 Manjunath N   CAR 110218
.                          Added filter on Category for Patient Alerts
.                 V9.04.02 17/03/2005 Ebon Clements CAR 58443
.                          Added security alert - AlertIconBlack.gif
.                 V9.04.01 04/02/2005 Ebon Clements CAR 56056
.                          Fixed alert icon display for non table sort list
.                 V9.04.00 21/12/2004 Ebon Clements CAR 56056
.                          Mods for alert icon display
.                 V9.02.05 02/04/2003 Jill Habasque SRF 37768
.                          Added output of review date in ALTROW00
.                 V9.02.04 30/09/2002 Peter Vela SRF 22514
.                          Added in validation for View Alert Security Level 
.                 V9.02.03 21/04/2001 Jill Habasque
.                          Changed comments to Remove "
.                 V9.02.02 17/11/2001 Jill Habasque
.                          Changed comments to display 100 characters   
.                 V9.02.01 03/11/2001 Jill Habasque
.                          Added read of pmsalnaf                       
.                 V5.10.00 05.03.2001 Ebon Clements
.                          Changed table output to User Name            
.                 V5.09.00 03.01.2001 Pat Dirito 
.                          Table now outputs User ID                     
.                 V5.07.02 04.03.2000 Pat Dirito 
.                          Changed javascript to output report instance  
.                 V5.07.01 15.12.1999 B.G.Ackland
.                          Changed Alerts to work of CLIWEB07 Sec Level
.                 V5.06.00 05.03.1999 Pat Dirito
.                          Created Program
.
.-------------------------------------------------------------------------------
.-------------------------------------------------------------------
. Output Patient Alert Table
.-------------------------------------------------------------------
          DEFPROC   ALTAB000
.         
          INC       OBSALTFD/INC
          INC       PATALRFD/INC      * Patient Alerts Code File
          INC       PMSALNFD/INC      * Patient Alerts Comments 
          INC       PMSALAFD/INC      * Patient Alerts Comments 
          INC       OBSPCOFD/INC 
.
. varaible declarations 
.
DATE      DIM       11           * Alert Date
D1        DIM       1            * "." seperator from DIM127 
DIM30     DIM       30
DIM02     DIM       2
AENDDATE  DIM       12
ALRTCATD  DIM       20
ALRTCODD  DIM       20
ALRTREAD  DIM       20
ALRCOMM   DIM       100
ALERTDOC  DIM       3
ALERTSEC  DIM       1            * alert security level
HTMLLINK  DIM       70
NOTSORT   FORM      1
ICONNAME  DIM       5             
INACTDAT  DIM       12
LENGTH    FORM      1
AFRM1     FORM      1
RECTYPE   DIM       20
TESTSL    DIM       1
FHIRFLAG  FORM      1
SAVFORM1  FORM      1
.
.-------------------------------------------------------------------
. MAIN
.-------------------------------------------------------------------
ML0000    CALL      INIT0000  * file opens 
.
ML1000    UNPACK    DIM127,D1,KEY1,DIM127    * KEY1 delimits function call 
          MOVE      ZERO,FHIRFLAG
          MOVE      KEY1,F1
          IF        F1=3
            MOVE      ONE,NOTSORT
            MOVE      ONE,F1
          ENDIF
.
          IF        F1=4
            CALL      CATG0000
          ENDIF
.
          IF        F1=5
            CALL      DELL0000
          ENDIF
.
          IF        F1=6
            CALL      AUDD0000
          ENDIF
.
          IF        F1=7
            CALL      ALTS0000
            CALL      DELL0000
          ENDIF
.
          IF        F1=8
            MOVE      ONE,FHIRFLAG
            CALL      ALTS0000
          ENDIF
.
          PERFORM   F1,ALTS0000,CATL0000
.
ML9999    GOTO      ALTAB999 
.-------------------------------------------------------------------
. file opens  
.-------------------------------------------------------------------
INIT0000  OPEN      OBSALTA1,"obsaltaf"
          OPEN      WEBSTEA1,"websteaf" 
.
          OPEN      PATALRT1,"patalrtf"
          OPEN      PATALTT1,"pataltaf"
          OPEN      PMSALNA1,"pmsalnaf"
          OPEN      PMSALAA1,"pmsalaaf"
          OPEN      OBSPCOA6,"obspcoaf"
          MOVE      ZERO,NOTSORT
          MOVE      ZERO,DISNUMB
          CALL      OPPASS1
. 
          READ      CONTROLF,TEN;*250,CAUDA1
          READ      CONTROLF,HUND14;*250,PTCNCUDA
.
          IF        CAUDA1<>1
            OPEN      PATAUDAL,"pataudal"
            OPEN      PATAUDA2,"pataudal"
            OPEN      PMSAUDAN,"pmsaudan"
            OPEN      PMSAUDA2,"pmsaudan"
          ENDIF
.
INIT9999  RETURN
.******************************************************************************
.*                              ALTS0000                  Called by: ML0000   *
.*        Display all the alert records for this patient.                     *
.*                                                                            *
.*        This is achieved by reading through the alert file and displaying   *
.*        each valid record.                                                  *
.*        If the alert security is on, check the users security level.        *
.*                                                                            *
.* Parameters: URNUMBER = Patient UR number                                   *
.******************************************************************************
ALTS0000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
.          CALL      ALHEAD00    * Output table heading
           IF        NOTSORT=1
             CALL      HEADIN00    * Output table heading
           ENDIF
.
.         * Loop through the alerts file, getting all the alert records
.         * for this patient.
.
          MATCH     "       0",URNUMBER
          IF        @EQUAL
            PACK      KEY16,ADMISSNO,ALRTFLTR,SP30      * Key is ADMISSNO number
            CALL      RSPTALT1                           * Read alerts code file
          ELSE
            PACK      KEY16,URNUMBER,ALRTFLTR,SP30      * Key is UR number
            CALL      RSPTALR1                          * Read alerts code file
          ENDIF
.
ALTS1000  MATCH     "       0",URNUMBER
          IF        @EQUAL
            CALL      RKPTALT1                 * Read next record
            BRANCH    OVRCD,ALTS9999           * no more alerts ?
            MATCH     ADMISSNO,PTALURNO        * For this patient ?
            GOTO      ALTS9999 IF NOT EQUAL    * no, read all alerts
            MATCH     SP30,ALRTFLTR
            IF        !@EQUAL
              MATCH     PTALCATG,ALRTFLTR
              GOTO      ALTS9999 IF NOT EQUAL
            ENDIF
          ELSE
            CALL      RKPTALR1                 * Read next record
            BRANCH    OVRCD,ALTS9999           * no more alerts ?
            MATCH     URNUMBER,PTALURNO        * For this patient ?
            GOTO      ALTS9999 IF NOT EQUAL    * no, read all alerts
            MATCH     SP30,ALRTFLTR
            IF        !@EQUAL
              MATCH     PTALCATG,ALRTFLTR
              GOTO      ALTS9999 IF NOT EQUAL
            ENDIF
          ENDIF
.
          MOVE      SP70,ICONNAME
          PACK      KEY5,PTALCATG,PTALCODE   * Key is cat and code
          CALL      RDCODE1                  * Read patient codes file
          BRANCH    OVRCD,ALTS1000           * no record, get next alert
          MOVE      TDESC,ALRTCODD           * Save the code description
.
          UNPACK    PTALCATG,KEY1,DIM1
          MOVE      DIM1,AFRM1               * save alert category
.
          REP       "S2 1",TCINDC4           * Security Alert
.
          MATCH     SP1,TCINDC5              * using indc5 for alert icons?
          IF        !@EQUAL
            PACK      ICONNAME,TCINDC5,SP70
          ELSE
            PACK      ICONNAME,TCINDC4,SP70  * if not, default to indc4
          ENDIF
          SQUEEZE   ICONNAME
.
          MOVE      SP1,ALERTSEC
          MOVE      USERID,KEY10             * I SRF 22514
          CALL      RDWBSE1                  * Obtain current user id 
          BRANCH    OVRCD,ALTS1500           * and get View Alert Security Level
.
.         check if category based alert security is being used
.
          LOAD      ALERTSEC,AFRM1,WBSEVH1L,WBSEVH2L,WBSEVH3L,WBSEVH4L,WBSEVH5L:
                                   WBSEVH6L,WBSEVH7L,WBSEVH8L,WBSEVH9L
.
          MATCH     ALERTSEC,SP1
          IF        @EQUAL
            MOVE      WBSEVWSL,ALERTSEC      * default to standard security
          ENDIF
.
ALTS1500  MATCH     ALERTSEC,TCINDC2         * Compare Sec Level to Indicator 2
          GOTO      ALTS2000 IF EQUAL
          GOTO      ALTS2000 IF LESS
          GOTO      ALTS1000                 * end I SRF 22514
.
ALTS2000  CALL      ALTROW00
          GOTO      ALTS1000                 * Don't display alert
.
.
ALTS9999  RETURN
.-------------------------------------------------------------
. Patient Alerts (TABLE HEADING)
.-------------------------------------------------------------
HEADIN00  PACK      KEY5,ANSWN,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,HEADIN99
.
          WRITE     HTMLFILE;"<tr><td class=HeadingCell>Type</td>":
                               "<td class=HeadingCell>":
                               "Description</td>":
                               "<td class=HeadingCell>":
                               "",TDESC,"</td>":       
                               "<td class=HeadingCell>":
                               "Reaction Comment/Lab No</td>":
                               "<td class=HeadingCell>":
                               "Requested By HCP</td>":
                               "<td class=HeadingCell>":
                               "Created By</td>":
                               "<td class=HeadingCell>":
                               "Updated By</td>":
                               "<td class=HeadingCell>":
                               "Date Activated</td>":
                               "<td class=HeadingCell>":
                               "Inactive/End Date</td>":
                               "<td class=HeadingCell>":
                               "Level</td>":
                               "<td class=HeadingCell>":
                               "Document</td>":
                               "</tr>"
HEADIN99  RETURN
.
. Patient Alerts (TABLE HEADING)
.-------------------------------------------------------------
ALHEAD00  WRITE    HTMLFILE;"<tr><td class=HeadingCell>Alert</td>":
                               "<td class=HeadingCell>":
                               "Reaction/Comment</td>":
                               "<td align=center class=HeadingCell>Date</td>":
                               "<td align=center class=HeadingCell>":
                               "Severity</td>":
                               "</tr>"
.
ALHEAD99  RETURN
.--------------------------------------------------------------------------
. Patient Alert Details (TABLE ROW)
.         Read the codes file using this category as the key.
.         This is done to get the category description.
.--------------------------------------------------------------------------
ALTROW00  MOVE      SP70,INACTDAT
          MOVE      SP70,AENDDATE
          MOVE      SP70,TESTSL
          PACK      KEY5,PTALCATG,SP3        * Key is category
          CALL      RDCODE1                  * Read patient codes file
          MOVE      TDESC,ALRTCATD
.
          MATCH     SP70,ICONNAME            * Setif not a security alert
          IF        @EQUAL
            MOVE      THCSCOD,ICONNAME       * AlertIconXXXX.gif
          ENDIF
.
          SQUEEZE   ICONNAME                 * Remove white space
.
          MATCH     SP70,PTCNCUDA
          IF        !@EQUAL
            PACK     DIM02,ANSH,PTCNCUDA,SP70
            MATCH    DIM02,PTALCATG
            IF       @EQUAL
              MOVE     "DIS",ICONNAME
              SQUEEZE   ICONNAME
            ENDIF
          ENDIF
.
          MOVE      SP70,ALRTREAD
          MATCH     SP70,PTALREAC
          IF        !@EQUAL
            MOVE      "wn",KEY2
            PACK      KEY5,KEY2,PTALREAC       * Key is category
            CALL      RDCODE1                  * Read patient codes file
            IF        OVRCD=0
              MOVE      TDESC,ALRTREAD
            ENDIF
          ENDIF
.
          PACK      KEY10,PTALUSID
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      "Invalid User",WBSENAM
          ENDIF
.
          MATCH     "0",PTALDATE
          IF        @EQUAL
            MOVE      SP70,PTALDATE
          ENDIF
.
          MOVE      "No ",ALERTDOC
          PACK      KEY25,PTALURNO,PTALCATG,PTALCODE,SP70
          CALL      RSOBPC6
ALTROW04  CALL      RKOBPC6
          BRANCH    OVRCD,ALTROW05
.
          MATCH     OBPCURNO,PTALURNO
          GOTO      ALTROW05 IF NOT EQUAL
.
          MATCH     OBPCACAT,PTALCATG
          GOTO      ALTROW05 IF NOT EQUAL
.
          MATCH     OBPCACOD,PTALCODE
          GOTO      ALTROW05 IF NOT EQUAL
.
          MATCH     OBPCCNTR,PTALCNTR
          GOTO      ALTROW04 IF NOT EQUAL
.
          MOVE      "Yes",ALERTDOC
.
ALTROW05  MOVE      SP70,DOCFNAME
          MOVE      PTALRQBY,KEY10
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
          ENDIF
.
          BRANCH    NOTSORT,ALTROW15
          CLEAR     HTMLLINK
          APPEND    "javascript:ShowAlert01('",HTMLLINK
          APPEND    PTALCATG,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PTALCODE,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PTALCNTR,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          REP       "#"'",ALRCOMM
.
          MATCH     SP70,PTALDTIN
          IF        !@EQUAL
            REP       " 0",PTALDTIN
            UNPACK    PTALDTIN,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      INACTDAT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MATCH     SP70,PTALEDAT
          IF        !@EQUAL
            REP       " 0",PTALEDAT
            UNPACK    PTALEDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      AENDDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MATCH     SP70,PTALDTIN
          IF        !@EQUAL
            MATCH     SP70,PTALEDAT
            IF        !@EQUAL
              MOVE      "/",TESTSL
            ENDIF
          ENDIF
.
          IF        FHIRTYPE=1
            IF        FHIRFLAG=0
              CALL      ALTFHR00  * FHIR Resource AllergyIntolerance
            ELSE
              CALL      FLGFHR00  * FHIR Resource Flag
            ENDIF
            GOTO      ALTROW99 
          ENDIF
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",ALRTCATD,"#",":
                             "#"",ALRTCODD,"#",":
                             "#"",ALRTREAD,"#",":
                             "#"";

          MOVE      SP70,ALRCOMM
          MATCH     "       0",URNUMBER
          IF        @EQUAL
            PACK      KEY19,PTALURNO,PTALCATG,PTALCODE,PTALCNTR,SP70
            CALL      RSPMALA1
ALTROW07    CALL      RKPMALA1
            IF        OVRCD=0
              MATCH     PTALURNO,PMANURNO
              GOTO      ALTROW10 IF NOT EQUAL
              MATCH     PTALCATG,PMANACAT
              GOTO      ALTROW10 IF NOT EQUAL
              MATCH     PTALCODE,PMANACOD
              GOTO      ALTROW10 IF NOT EQUAL
              MATCH     PTALCNTR,PMANCNTR
              GOTO      ALTROW10 IF NOT EQUAL
              MOVE      PMANCOMM,ALRCOMM
              REP       "#"'",ALRCOMM
              RESET     ALRCOMM
              WRITE     HTMLFILE;ALRCOMM;
              GOTO      ALTROW07
            ENDIF
          ELSE
            PACK      KEY19,PTALURNO,PTALCATG,PTALCODE,PTALCNTR,SP70
            CALL      RSPMALN1
ALTROW08    CALL      RKPMALN1
            IF        OVRCD=0
              MATCH     PTALURNO,PMANURNO
              GOTO      ALTROW10 IF NOT EQUAL
              MATCH     PTALCATG,PMANACAT
              GOTO      ALTROW10 IF NOT EQUAL
              MATCH     PTALCODE,PMANACOD
              GOTO      ALTROW10 IF NOT EQUAL
              MATCH     PTALCNTR,PMANCNTR
              GOTO      ALTROW10 IF NOT EQUAL
              MOVE      PMANCOMM,ALRCOMM
              REP       "#"'",ALRCOMM
              RESET     ALRCOMM
              WRITE     HTMLFILE;ALRCOMM;
              GOTO      ALTROW08
            ENDIF
          ENDIF
.
ALTROW10  WRITE     HTMLFILE;"#",":
                             "#"",WBSENAM,"#",":
                             "#"",PTALDATE,"#",":
                             "#"",PTALLSEV,"#",":
                             "#"",PTALRDTE,"#",":
                             "#"",*+,ICONNAME,"#",":
                             "#"",ALERTDOC,"#",":
                             "#"",SP1,"#",":     * dummy so it matches DELROW00
                             "#"",SP1,"#",":     * dummy so it matches DELROW00
                             "#"","No","#",":    * deleted
                             "#"",INACTDAT,SP1,TESTSL,SP1,AENDDATE,"#",";
.
          MOVE      SP70,WBSENAM
          PACK      KEY10,PTALUUID,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MATCH     SP70,PTALUUID
            IF        !@EQUAL
              PACK      WBSENAM,PTALUUID,SP70   * Update user recorded but not 
            ENDIF                               * found in websecaf (ie deleted)
          ENDIF    
.
          WRITE     HTMLFILE;"#"",WBSENAM,"#",";   
.
          WRITE     HTMLFILE;"#"",DOCFNAME,"#")"
.
          GOTO      ALTROW99
..                           
ALTROW15  CLEAR     HTMLLINK
          APPEND    PTALCATG,HTMLLINK
          APPEND    "#",#"",HTMLLINK
          APPEND    PTALCODE,HTMLLINK
          APPEND    "#",#"",HTMLLINK
          APPEND    PTALCNTR,HTMLLINK
          UNPACK    SP70,CCENT,CYEAR,CMON,CDAY,MTHNAM3
          MATCH     SP70,PTALDATE
          IF        !@EQUAL
            REP       " 0",PTALDATE
            UNPACK    PTALDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          ENDIF
.
          MATCH     SP70,ICONNAME
          IF        @EQUAL   
            WRITE     HTMLFILE;"<tr><td><img src=../images/AlertIcon.gif ";
          ELSE
            WRITE     HTMLFILE;"<tr><td><img src=../images/AlertIcon":
                               *+,ICONNAME,".gif ";
          ENDIF
.
          WRITE     HTMLFILE;"border=0 hspace=4 align=absmiddle ":
                             "onclick='ShowAlert01(#"",HTMLLINK,"#")'>":
                              ALRTCATD,"</td>":
                             "<td>",ALRTCODD,"</td>":
                             "<td>",ALRTREAD,"</td>":
                             "<td>"
.
          MOVE      SP70,ALRCOMM
          MATCH     "       0",URNUMBER
          IF        @EQUAL
            PACK      KEY19,PTALURNO,PTALCATG,PTALCODE,PTALCNTR,SP70
            CALL      RSPMALA1
ALTROW17    CALL      RKPMALA1
            IF        OVRCD=0
              MATCH     PTALURNO,PMANURNO
              GOTO      ALTROW19 IF NOT EQUAL
              MATCH     PTALCATG,PMANACAT
              GOTO      ALTROW19 IF NOT EQUAL
              MATCH     PTALCODE,PMANACOD
              GOTO      ALTROW19 IF NOT EQUAL
              MATCH     PTALCNTR,PMANCNTR
              GOTO      ALTROW19 IF NOT EQUAL
              MOVE      PMANCOMM,ALRCOMM
              REP       "#"'",ALRCOMM
              RESET     ALRCOMM
              WRITE     HTMLFILE;ALRCOMM;
              GOTO      ALTROW17
            ENDIF
          ELSE
            PACK      KEY19,PTALURNO,PTALCATG,PTALCODE,PTALCNTR,SP70
            CALL      RSPMALN1
ALTROW18    CALL      RKPMALN1
            IF        OVRCD=0
              MATCH     PTALURNO,PMANURNO
              GOTO      ALTROW19 IF NOT EQUAL
              MATCH     PTALCATG,PMANACAT
              GOTO      ALTROW19 IF NOT EQUAL
              MATCH     PTALCODE,PMANACOD
              GOTO      ALTROW19 IF NOT EQUAL
              MATCH     PTALCNTR,PMANCNTR
              GOTO      ALTROW19 IF NOT EQUAL
              MOVE      PMANCOMM,ALRCOMM
              REP       "#"'",ALRCOMM
              RESET     ALRCOMM
              WRITE     HTMLFILE;ALRCOMM;
              GOTO      ALTROW18
            ENDIF
          ENDIF
.
ALTROW19  WRITE     HTMLFILE;"&nbsp;</td>":
                             "<td>",DOCFNAME,"</td>":
                             "<td>",WBSENAM,"</td>";

          MOVE      SP70,WBSENAM
          PACK      KEY10,PTALUUID,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MATCH     SP70,PTALUUID
            IF        !@EQUAL
              PACK      WBSENAM,PTALUUID,SP70   * Update user recorded but not
            ENDIF                               * found in websecaf (ie deleted)
          ENDIF
.
          WRITE     HTMLFILE;"<td>",WBSENAM,"</td>":
                             "<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>"
.
          UNPACK    SP70,CCENT,CYEAR,CMON,CDAY,MTHNAM3
          MATCH     SP70,PTALEDAT
          IF        !@EQUAL
            REP       " 0",PTALEDAT
            UNPACK    PTALEDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          ENDIF
          WRITE     HTMLFILE;"<td>",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</td>":
                             "<td>",PTALLSEV,"</td>":
                             "<td>",ALERTDOC,"</td></tr>"
.
ALTROW99  RETURN
.------------------------------------------------------------
. Output FHIR Format AllergyIntolerance - Allergies
.------------------------------------------------------------
ALTFHR00  STRIP     ALRTCATD
          MATCH     "Allerg",ALRTCATD
          GOTO      ALTFHR99 IF NOT EQUAL
          IF        DISNUMB>0
            WRITE     HTMLFILE;",";
          ENDIF
          PACK      KEY16,PTALURNO,PTALCATG,PTALCODE,PTALCNTR,SP70
          REP       " -",KEY16
.
          WRITE     HTMLFILE;*+,"{ #"fullUrl#" : #"%BASEURL/AllergyIntolerance/",KEY16,"#", ":
                    " #"resource#" : ";
.
          CALL      RESALL00
.
          WRITE     HTMLFILE;*+," } ";
          ADD       ONE,DISNUMB
.
          IF       FHRPATIN=1
.
            WRITE     HTMLFILE;*+,",{ #"fullUrl#" : #"%BASEURL/Patient/",FHRPATID,"#", ":
                      " #"resource#" : ";
            CALL     RESPAT00            * FHIR Resource Patient
            WRITE    HTMLFILE;*+,"}"
.
          ENDIF
.
          IF       FHRLOCIN=1
.
            CALL      CLPATHSP
            MATCH     SP70,PTALHOSP
            IF        !@EQUAL
              PACK      KEY3,PTALHOSP,SP70
              CALL      RDPTHSP1
              IF        OVRCD=0
.
                WRITE     HTMLFILE;*+,",{ #"fullUrl#" : #"%BASEURL/Location/Hospital-",PTALHOSP,"#", ":
                          " #"resource#" : ";
                CALL     RESLOC00         * FHIR Resource Location Hospital
                WRITE    HTMLFILE;*+,"}"
.
              ENDIF
.
            ENDIF
.
          ENDIF
.
          IF       FHRRECIN=1
.
            WRITE     HTMLFILE;*+,",{ #"fullUrl#" : #"%BASEURL/Practitioner/User-",PTALUSID,"#", ":
                      " #"resource#" : ";
            CALL     RESPRA00         * FHIR Resource Practitioner Recorder
            WRITE    HTMLFILE;*+,"}"
.
          ENDIF
.
          IF       FHRASSIN=1
.
            MATCH     SP70,PTALRQBY
            IF        !@EQUAL
.
              PACK      KEY10,PTALRQBY,SP70
              CALL      RDPMHCP1
              IF        OVRCD=0
.
                WRITE     HTMLFILE;*+,",{ #"fullUrl#" : #"%BASEURL/Practitioner/HCP-",PTALRQBY,"#", ":
                          " #"resource#" : ";
                CALL     RESASS00         * FHIR Resource Practitioner Asserter
                WRITE    HTMLFILE;*+,"}"
.
              ENDIF
.
            ENDIF
.
          ENDIF
.
ALTFHR99  RETURN
.
. Output FHIR Format Flag - NON Allergies
.
FLGFHR00  STRIP     ALRTCATD
          MATCH     "Allerg",ALRTCATD
          GOTO      FLGFHR99 IF EQUAL
          IF        DISNUMB>0
            WRITE     HTMLFILE;",";
          ENDIF
          PACK      KEY16,PTALURNO,PTALCATG,PTALCODE,PTALCNTR,SP70
          REP       " -",KEY16
.
          WRITE     HTMLFILE;*+,"{ #"fullUrl#" : #"%BASEURL/Flag/",KEY16,"#", ":
                    " #"resource#" : ";
          CALL      RESFLG00
.
          WRITE     HTMLFILE;*+," } ";
          ADD       ONE,DISNUMB
.
          IF       FHRSUBIN=1
.
            MOVE      F1,SAVFORM1
.
            WRITE     HTMLFILE;*+,",{ #"fullUrl#" : #"%BASEURL/Patient/",FHRPATID,"#", ":
                      " #"resource#" : ";
            CALL      RESPAT00            * FHIR Resource Patient
            WRITE     HTMLFILE;*+,"}"
.
            MOVE      SAVFORM1,F1
.
          ENDIF
.
          IF       FHRLOCIN=1
.
            CALL      CLPATHSP
            MATCH     SP70,PTALHOSP
            IF        !@EQUAL
              PACK      KEY3,PTALHOSP,SP70
              CALL      RDPTHSP1
              IF        OVRCD=0
.               
                WRITE     HTMLFILE;*+,",{ #"fullUrl#" : #"%BASEURL/Location/Hospital-",PTALHOSP,"#", ":
                          " #"resource#" : ";
                CALL     RESLOC00         * FHIR Resource Location Hospital
                WRITE    HTMLFILE;*+,"}"
.
              ENDIF
            ENDIF
.
          ENDIF
.
          IF       FHRPARIN=1
.
            WRITE     HTMLFILE;*+,",{ #"fullUrl#" : #"%BASEURL/Practitioner/User-",PTALUSID,"#", ":
                      " #"resource#" : ";
            CALL     RESPRA00         * FHIR Resource Practitioner Recorder
            WRITE    HTMLFILE;*+,"}"
.
          ENDIF
.
FLGFHR99  RETURN
.---------------------------------------------------------------------
.                            CATL0000
.  Displays Selection List of Categories H1-H9 with link to ADD Page
.                                                    called by: ML0000
.-----------------------------------------------------------------------
CATL0000  MOVE      ONE,F1
.
CATL0100  PACK      KEY5,ANSH,F1,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CATL0200
.
          MATCH     ANSI,PTCOACTV
          GOTO      CATL0200 IF EQUAL
.
          MATCH     "1",TCINDC8
          GOTO      CATL0200 IF EQUAL
.
          MOVE      TDESC,KEY20
          PACK      KEY4,QUOTE,TCODE,QUOTE
          WRITE     HTMLFILE;"<option value=",KEY4,">",KEY20,"</option>"
.
CATL0200  COMPARE   NINE,F1
          GOTO      CATL9999 IF EQUAL
          ADD       ONE,F1   
          GOTO      CATL0100
.
CATL9999  RETURN
.-------------------------------------------------------------------------------
.                           CATG0000
. Displays Selection List of Categories H1-H9 to view alerts based on categories
.                                                          called by: ML0000
.-------------------------------------------------------------------------------
CATG0000  MOVE      ONE,F1
.
CATG0100  PACK      KEY5,ANSH,F1,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CATG0200
.
          UNPACK    DIM127,D1,DIM1,DIM127      
          MOVE      TDESC,KEY20
          PACK      KEY4,QUOTE,TCODE,QUOTE
          MATCH     TCODE,ALRTFLTR
.
          IF        @EQUAL  
            WRITE     HTMLFILE;"<option value=",KEY4," selected>":
                               KEY20,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY4,">",KEY20,"</option>"
          ENDIF
.
CATG0200  COMPARE   NINE,F1
          GOTO      CATG9999 IF EQUAL
          ADD       ONE,F1
          GOTO      CATG0100
.
CATG9999  RETURN
.
.******************************************************************************
.*                              DELL0000                  Called by: ML0000   *
.*        Display all the deleted alert audit records for this patient.       *
.*                                                                            *
.*        This is achieved by reading through the alert audit file and        *
.*        displaying records with an audit type of (D)elete                   *
.*        If the alert security is on, check the users security level.        *
.*                                                                            *
.* Parameters: URNUMBER = Patient UR number                                   *
.******************************************************************************
DELL0000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          READ      CONTROLF,TEN;*250,CAUDA1
          BRANCH    CAUDA1,DELL9999                   * Using alert audits
.
          PACK      KEY27,URNUMBER,SP70              * Key is URNUMBER number
          CALL      ASPTALR2                         * Read alerts code file
DELL1000  CALL      AKPTALR2                 * Read next record
          BRANCH    OVRCD,DELL9999           * no more alerts ?
.
          MATCH     URNUMBER,PTALURNO        * For this patient ?
          GOTO      DELL9999 IF NOT EQUAL    * no, read all alerts
.
          MATCH     ANSD,PTALAUDR            * only display deleted alerts
          GOTO      DELL1000 IF NOT EQUAL
.
          MATCH     SP30,ALRTFLTR
          IF        !@EQUAL
            MATCH     PTALCATG,ALRTFLTR
            GOTO      DELL1000 IF NOT EQUAL
          ENDIF
.
          MOVE      SP70,ICONNAME
          PACK      KEY5,PTALCATG,PTALCODE   * Key is cat and code
          CALL      RDCODE1                  * Read patient codes file
          BRANCH    OVRCD,DELL1000           * no record, get next alert
          MOVE      TDESC,ALRTCODD           * Save the code description
.
          UNPACK    PTALCATG,KEY1,DIM1
          MOVE      DIM1,AFRM1               * save alert category
.
          REP       "S2",TCINDC4             * Security Alert
.
          MATCH     SP1,TCINDC5              * using indc5 for alert icons?
          IF        !@EQUAL
            PACK      ICONNAME,TCINDC5,SP70
          ELSE
            PACK      ICONNAME,TCINDC4,SP70  * if not, default to indc4
          ENDIF
          SQUEEZE   ICONNAME
.   
          MOVE      SP1,ALERTSEC
          MATCH     SP70,PTCNCUDA
          IF        !@EQUAL
            PACK     DIM02,ANSH,PTCNCUDA,SP70
            MATCH    DIM02,PTALCATG
            IF       @EQUAL
              MOVE     "DIS",ICONNAME
              SQUEEZE   ICONNAME
            ENDIF
          ENDIF

          MOVE      USERID,KEY10             * I SRF 22514
          CALL      RDWBSE1                  * Obtain current user id
          BRANCH    OVRCD,DELL1500           * and get View Alert Security Level
.
.         check if category based alert security is being used
.
          LOAD      ALERTSEC,AFRM1,WBSEVH1L,WBSEVH2L,WBSEVH3L,WBSEVH4L,WBSEVH5L:
                                   WBSEVH6L,WBSEVH7L,WBSEVH8L,WBSEVH9L
.
          MATCH     ALERTSEC,SP1
          IF        @EQUAL
            MOVE      WBSEVWSL,ALERTSEC      * default to standard security
          ENDIF
.
DELL1500  MATCH     ALERTSEC,TCINDC2         * Compare Sec Level to Indicator 2
          GOTO      DELL2000 IF EQUAL
          GOTO      DELL2000 IF LESS
          GOTO      DELL1000                 * end I SRF 22514
.
DELL2000  CALL      DELROW00
          GOTO      DELL1000                 * Don't display alert
.
DELL9999  RETURN
.
.--------------------------------------------------------------------------
. Patient Deleted Alert Details (TABLE ROW)
.         Read the codes file using this category as the key.
.         This is done to get the category description.
.--------------------------------------------------------------------------
DELROW00  MOVE      SP70,INACTDAT
          MOVE      SP70,AENDDATE
          PACK      KEY5,PTALCATG,SP3        * Key is category
          CALL      RDCODE1                  * Read patient codes file
          MOVE      TDESC,ALRTCATD
.
          MATCH     SP70,ICONNAME            * Setif not a security alert
          IF        @EQUAL
            MOVE      THCSCOD,ICONNAME       * AlertIconXXXX.gif
          ENDIF
.
          SQUEEZE   ICONNAME                 * Remove white space
.
          MATCH     SP70,PTCNCUDA
          IF        !@EQUAL
            PACK     DIM02,ANSH,PTCNCUDA,SP70
            MATCH    DIM02,PTALCATG
            IF       @EQUAL
              MOVE     "DIS",ICONNAME
              SQUEEZE   ICONNAME
            ENDIF
          ENDIF
.
          MOVE      SP70,ALRTREAD
          MATCH     SP70,PTALREAC
          IF        !@EQUAL
            MOVE      "wn",KEY2
            PACK      KEY5,KEY2,PTALREAC       * Key is category
            CALL      RDCODE1                  * Read patient codes file
            IF        OVRCD=0
              MOVE      TDESC,ALRTREAD
            ENDIF
          ENDIF
.
          MOVE      SP70,DIM30
          PACK      KEY14,PTALAUDO,SP70
          CALL      RSWBSE3
          CALL      RKWBSE3
          IF        OVRCD=0
            MATCH     WBSEPCD,PTALAUDO
            IF        @EQUAL
              MOVE      WBSENAM,DIM30
            ENDIF
          ENDIF
.
          PACK      KEY10,PTALUSID
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      "Invalid User",WBSENAM
          ENDIF
.
          MATCH     "0",PTALDATE
          IF        @EQUAL
            MOVE      SP70,PTALDATE
          ENDIF
.
          MOVE      "No ",ALERTDOC
          PACK      KEY25,PTALURNO,PTALCATG,PTALCODE,SP70
          CALL      RSOBPC6
          CALL      RKOBPC6
          BRANCH    OVRCD,DELROW05
.
          MATCH     OBPCURNO,PTALURNO
          GOTO      DELROW05 IF NOT EQUAL
.
          MATCH     OBPCACAT,PTALCATG
          GOTO      DELROW05 IF NOT EQUAL
.
          MATCH     OBPCACOD,PTALCODE
          GOTO      DELROW05 IF NOT EQUAL
.
          MATCH     OBPCCNTR,PTALCNTR
          GOTO      DELROW05 IF NOT EQUAL
.
          MOVE      "Yes",ALERTDOC
.
DELROW05  MOVE      SP70,ALRCOMM
          PACK      KEY27,PTALURNO,PTALAUDD,PTALAUDT,SP70
          CALL      ASPMALN2
DELROW06  CALL      AKPMALN2
          IF        OVRCD=0
            MATCH     PTALURNO,PMANURNO
            GOTO      DELROW10 IF NOT EQUAL
            MATCH     PTALAUDD,PMANAUDD
            GOTO      DELROW10 IF NOT EQUAL
            MATCH     PTALAUDT,PMANAUDT
            GOTO      DELROW10 IF NOT EQUAL
            MATCH     ANSD,PMANAUDR
            GOTO      DELROW06 IF NOT EQUAL
.
            MATCH     PTALCATG,PMANACAT
            GOTO      DELROW06 IF NOT EQUAL
            MATCH     PTALCODE,PMANACOD
            GOTO      DELROW06 IF NOT EQUAL
            MATCH     PTALCNTR,PMANCNTR
            GOTO      DELROW06 IF NOT EQUAL
            MOVE      PMANCOMM,ALRCOMM
          ENDIF
DELROW07  CALL      AKPMALN2
          IF        OVRCD=0
            MATCH     PTALURNO,PMANURNO
            GOTO      DELROW10 IF NOT EQUAL
            MATCH     PTALAUDD,PMANAUDD
            GOTO      DELROW10 IF NOT EQUAL
            MATCH     PTALAUDT,PMANAUDT
            GOTO      DELROW10 IF NOT EQUAL
            MATCH     ANSD,PMANAUDR
            GOTO      DELROW07 IF NOT EQUAL
.
            MATCH     PTALCATG,PMANACAT
            GOTO      DELROW07 IF NOT EQUAL
            MATCH     PTALCODE,PMANACOD
            GOTO      DELROW07 IF NOT EQUAL
            MATCH     PTALCNTR,PMANCNTR
            GOTO      DELROW07 IF NOT EQUAL
            ENDSET    ALRCOMM
            APPEND    PMANCOMM,ALRCOMM
          ENDIF
.
DELROW10  CLEAR     HTMLLINK
          APPEND    "javascript:ShowAlert01('",HTMLLINK
          APPEND    PTALCATG,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PTALCODE,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PTALCNTR,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PTALAUDD,HTMLLINK
          APPEND    PTALAUDT,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          REP       "#"'",ALRCOMM
.
          MATCH     SP70,PTALDTIN
          IF        !@EQUAL
            REP       " 0",PTALDTIN
            UNPACK    PTALDTIN,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            MATCH     "00",CDAY
            IF        @EQUAL
              MATCH     SP70,CDAY
            ENDIF
            MATCH     "00",CMON
            IF        @EQUAL
              MATCH     SP70,MTHNAM3
            ENDIF
            PACK      KEY4,CCENT,CYEAR
            MATCH     "0000",KEY4
            IF        @EQUAL
              MATCH     SP70,CCENT
              MATCH     SP70,CYEAR
            ENDIF
            PACK      INACTDAT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MATCH     SP70,PTALEDAT
          IF        !@EQUAL
            REP       " 0",PTALEDAT
            UNPACK    PTALEDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            MATCH     "00",CDAY
            IF        @EQUAL
              MATCH     SP70,CDAY
            ENDIF
            MATCH     "00",CMON
            IF        @EQUAL
              MATCH     SP70,MTHNAM3
            ENDIF
            PACK      KEY4,CCENT,CYEAR
            MATCH     "0000",KEY4
            IF        @EQUAL
              MATCH     SP70,CCENT
              MATCH     SP70,CYEAR
            ENDIF
            PACK      AENDDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MATCH     SP70,PTALDTIN
          IF        !@EQUAL
            MATCH     SP70,PTALEDAT
            IF        !@EQUAL
              MOVE      "/",TESTSL
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",ALRTCATD,"#",":
                             "#"",ALRTCODD,"#",":
                             "#"",ALRTREAD,"#",":
                             "#"",ALRCOMM,"#",":
                             "#"",WBSENAM,"#",":
                             "#"",PTALDATE,"#",":
                             "#"",PTALLSEV,"#",":
                             "#"",PTALRDTE,"#",":
                             "#"",*+,ICONNAME,"#",":
                             "#"",ALERTDOC,"#",":
                             "#"",PTALAUDD,"#",":
                             "#"",DIM30,"#",":
                             "#"","Yes","#",":    * deleted
                             "#"",INACTDAT,SP1,TESTSL,SP1,AENDDATE,"#")" 
.
DELROW99  RETURN
+
.******************************************************************************
.*                              AUDD0000                  Called by: ML0000   *
.*        Display all the alert audit records for this patient.               *
.*                                                                            *
.*        This is achieved by reading through the alert audit file and        *
.*        displaying records with an audit type of (B) and (D)                *
.*        If the alert security is on, check the users security level.        *
.*                                                                            *
.* Parameters: URNUMBER = Patient UR number                                   *
.******************************************************************************
AUDD0000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          READ      CONTROLF,TEN;*250,CAUDA1
          BRANCH    CAUDA1,AUDD9999                   * Using alert audits
.
          PACK      KEY27,URNUMBER,SP70              * Key is URNUMBER number
          CALL      ASPTALR2                         * Read alerts code file
AUDD1000  CALL      AKPTALR2                 * Read next record
          BRANCH    OVRCD,AUDD9999           * no more alerts ?
.
          MATCH     URNUMBER,PTALURNO        * For this patient ?
          GOTO      AUDD9999 IF NOT EQUAL    * no, read all alerts
.
          MATCH     ALERT001,PTALCATG
          GOTO      AUDD1000 IF NOT EQUAL
.
          MATCH     ALERT002,PTALCODE
          GOTO      AUDD1000 IF NOT EQUAL
.
          MATCH     ALERT013,PTALCNTR
          GOTO      AUDD1000 IF NOT EQUAL
.
          MATCH     ANSD,PTALAUDR            * display deleted alerts
          GOTO      AUDD1100 IF EQUAL
.
          MATCH     ANSB,PTALAUDR            * display before change records
          GOTO      AUDD1000 IF NOT EQUAL
.
AUDD1100  MATCH     SP30,ALRTFLTR
          IF        !@EQUAL
            MATCH     PTALCATG,ALRTFLTR
            GOTO      AUDD1000 IF NOT EQUAL
          ENDIF
.
          MOVE      SP70,RECTYPE
          MATCH     ANSB,PTALAUDR
          IF        @EQUAL
            MOVE      "Before      ",RECTYPE
          ENDIF
.
          MATCH     ANSD,PTALAUDR
          IF        @EQUAL
            MOVE      "Delete     ",RECTYPE
          ENDIF
          MOVE      SP70,ICONNAME
          PACK      KEY5,PTALCATG,PTALCODE   * Key is cat and code
          CALL      RDCODE1                  * Read patient codes file
          BRANCH    OVRCD,AUDD1000           * no record, get next alert
.
          UNPACK    PTALCATG,KEY1,DIM1
          MOVE      DIM1,AFRM1               * save alert category
.
          REP       "S2",TCINDC4             * Security Alert
.
          MATCH     SP1,TCINDC5              * using indc5 for alert icons?
          IF        !@EQUAL
            PACK      ICONNAME,TCINDC5,SP70
          ELSE
            PACK      ICONNAME,TCINDC4,SP70  * if not, default to indc4
          ENDIF
          SQUEEZE   ICONNAME
.
          MOVE      SP1,ALERTSEC
          MATCH     SP70,PTCNCUDA
          IF        !@EQUAL
            PACK     DIM02,ANSH,PTCNCUDA,SP70
            MATCH    DIM02,PTALCATG
            IF       @EQUAL
              MOVE     "DIS",ICONNAME
              SQUEEZE   ICONNAME
            ENDIF
          ENDIF

          MOVE      USERID,KEY10             * I SRF 22514
          CALL      RDWBSE1                  * Obtain current user id
          BRANCH    OVRCD,AUDD1500           * and get View Alert Security Level
.
.         check if category based alert security is being used
.
          LOAD      ALERTSEC,AFRM1,WBSEVH1L,WBSEVH2L,WBSEVH3L,WBSEVH4L,WBSEVH5L:
                                   WBSEVH6L,WBSEVH7L,WBSEVH8L,WBSEVH9L
.
          MATCH     ALERTSEC,SP1
          IF        @EQUAL
            MOVE      WBSEVWSL,ALERTSEC      * default to standard security
          ENDIF
.
AUDD1500  MATCH     ALERTSEC,TCINDC2         * Compare Sec Level to Indicator 2
          GOTO      AUDD2000 IF EQUAL
          GOTO      AUDD2000 IF LESS
          GOTO      AUDD1000                 * end I SRF 22514
.
AUDD2000  CALL      AUDROW00
          GOTO      AUDD1000                 * Don't display alert
.
AUDD9999  RETURN
.
.--------------------------------------------------------------------------
. Patient Alert Audit Details (TABLE ROW)
.         Read the codes file using this category as the key.
.         This is done to get the category description.
.--------------------------------------------------------------------------
AUDROW00  MOVE      SP70,INACTDAT
          MOVE      SP70,AENDDATE
          PACK      KEY5,PTALCATG,SP3        * Key is category
          CALL      RDCODE1                  * Read patient codes file
          MOVE      TDESC,ALRTCATD           * Alert Type
.
          MATCH     SP70,ICONNAME            * Setif not a security alert
          IF        @EQUAL
            MOVE      THCSCOD,ICONNAME       * AlertIconXXXX.gif
          ENDIF
.
          SQUEEZE   ICONNAME                 * Remove white space
.
          MATCH     SP70,PTCNCUDA
          IF        !@EQUAL
            PACK     DIM02,ANSH,PTCNCUDA,SP70
            MATCH    DIM02,PTALCATG
            IF       @EQUAL
              MOVE     "DIS",ICONNAME
              SQUEEZE   ICONNAME
            ENDIF
          ENDIF
.
          MOVE      SP70,ALRTREAD
          MATCH     SP70,PTALREAC
          IF        !@EQUAL
            MOVE      "wn",KEY2
            PACK      KEY5,KEY2,PTALREAC       * Key is category
            CALL      RDCODE1                  * Read patient codes file
            IF        OVRCD=0
              MOVE      TDESC,ALRTREAD
            ENDIF
          ENDIF
.
          MOVE      SP70,DIM30
          PACK      KEY14,PTALAUDO,SP70
          CALL      RSWBSE3
          CALL      RKWBSE3
          IF        OVRCD=0
            MATCH     WBSEPCD,PTALAUDO
            IF        @EQUAL
              MOVE      WBSENAM,DIM30
            ENDIF
          ENDIF
.
          PACK      KEY10,PTALUSID
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      "Invalid User",WBSENAM
          ENDIF
.
          MATCH     "0",PTALDATE
          IF        @EQUAL
            MOVE      SP70,PTALDATE
          ENDIF
.
          MOVE      "No ",ALERTDOC
          PACK      KEY25,PTALURNO,PTALCATG,PTALCODE,SP70
          CALL      RSOBPC6
          CALL      RKOBPC6
          BRANCH    OVRCD,AUDROW05
.
          MATCH     OBPCURNO,PTALURNO
          GOTO      AUDROW05 IF NOT EQUAL
.
          MATCH     OBPCACAT,PTALCATG
          GOTO      AUDROW05 IF NOT EQUAL
.
          MATCH     OBPCACOD,PTALCODE
          GOTO      AUDROW05 IF NOT EQUAL
.
          MATCH     OBPCCNTR,PTALCNTR
          GOTO      AUDROW05 IF NOT EQUAL
.
          MOVE      "Yes",ALERTDOC
.
AUDROW05  MOVE      SP70,ALRCOMM
          PACK      KEY27,PTALURNO,PTALAUDD,PTALAUDT,SP70
          CALL      ASPMALN2
AUDROW06  CALL      AKPMALN2
          IF        OVRCD=0
            MATCH     PTALURNO,PMANURNO
            GOTO      AUDROW10 IF NOT EQUAL
            MATCH     PTALAUDD,PMANAUDD
            GOTO      AUDROW10 IF NOT EQUAL
            MATCH     PTALAUDT,PMANAUDT
            GOTO      AUDROW10 IF NOT EQUAL
            MATCH     ANSD,PMANAUDR
            GOTO      AUDROWA1 IF EQUAL
            MATCH     ANSB,PMANAUDR
            GOTO      AUDROW06 IF NOT EQUAL
.
AUDROWA1    MATCH     PTALCATG,PMANACAT
            GOTO      AUDROW06 IF NOT EQUAL
            MATCH     PTALCODE,PMANACOD
            GOTO      AUDROW06 IF NOT EQUAL
            MATCH     PTALCNTR,PMANCNTR
            GOTO      AUDROW06 IF NOT EQUAL
            MOVE      PMANCOMM,ALRCOMM
          ENDIF
AUDROW07  CALL      AKPMALN2
          IF        OVRCD=0
            MATCH     PTALURNO,PMANURNO
            GOTO      AUDROW10 IF NOT EQUAL
            MATCH     PTALAUDD,PMANAUDD
            GOTO      AUDROW10 IF NOT EQUAL
            MATCH     PTALAUDT,PMANAUDT
            GOTO      AUDROW10 IF NOT EQUAL
            MATCH     ANSD,PMANAUDR
            GOTO      AUDROW08 IF EQUAL
            MATCH     ANSB,PMANAUDR
            GOTO      AUDROW07 IF NOT EQUAL
.
AUDROW08    MATCH     PTALCATG,PMANACAT
            GOTO      AUDROW07 IF NOT EQUAL
            MATCH     PTALCODE,PMANACOD
            GOTO      AUDROW07 IF NOT EQUAL
            MATCH     PTALCNTR,PMANCNTR
            GOTO      AUDROW07 IF NOT EQUAL
            ENDSET    ALRCOMM
            APPEND    PMANCOMM,ALRCOMM
          ENDIF
.
AUDROW10  CLEAR     HTMLLINK
          APPEND    "javascript:ShowAlert01('",HTMLLINK
          APPEND    PTALCATG,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PTALCODE,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PTALCNTR,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PTALAUDD,HTMLLINK
          APPEND    PTALAUDT,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          REP       "#"'",ALRCOMM
.
          MOVE      SP70,DOCFNAME
          MOVE      PTALRQBY,KEY10
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE       * I CAR 13038
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000             * end I CAR 13038
          ENDIF
.
          MATCH     SP70,PTALDTIN
          IF        !@EQUAL
            REP       " 0",PTALDTIN
            UNPACK    PTALDTIN,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            MATCH     "00",CDAY
            IF        @EQUAL
              MATCH     SP70,CDAY
            ENDIF
            MATCH     "00",CMON
            IF        @EQUAL
              MATCH     SP70,MTHNAM3
            ENDIF
            PACK      KEY4,CCENT,CYEAR
            MATCH     "0000",KEY4
            IF        @EQUAL
              MATCH     SP70,CCENT
              MATCH     SP70,CYEAR
            ENDIF
            PACK      INACTDAT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MATCH     SP70,PTALEDAT
          IF        !@EQUAL
            REP       " 0",PTALEDAT
            UNPACK    PTALEDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            MATCH     "00",CDAY
            IF        @EQUAL
              MATCH     SP70,CDAY
            ENDIF
            MATCH     "00",CMON
            IF        @EQUAL
              MATCH     SP70,MTHNAM3
            ENDIF
            PACK      KEY4,CCENT,CYEAR
            MATCH     "0000",KEY4
            IF        @EQUAL
              MATCH     SP70,CCENT
              MATCH     SP70,CYEAR
            ENDIF
            PACK      AENDDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MATCH     SP70,PTALDTIN
          IF        !@EQUAL
            MATCH     SP70,PTALEDAT
            IF        !@EQUAL
              MOVE      "/",TESTSL
            ENDIF
          ENDIF
.
          PACK      KEY5,PTALCATG,PTALCODE   * Key is category and code
          CALL      RDCODE1                  * Read patient codes file
          IF        OVRCD = 1
            MOVE      SP70,TDESC
          ENDIF     
          MOVE      TDESC,ALRTCODD           * Alert Description
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",ALRTCATD,"#",":
                             "#"",ALRTCODD,"#",":
                             "#"",ALRTREAD,"#",":
                             "#"",ALRCOMM,"#",":
                             "#"",WBSENAM,"#",":
                             "#"",PTALDATE,"#",":
                             "#"",PTALLSEV,"#",":
                             "#"",PTALRDTE,"#",":
                             "#"",*+,ICONNAME,"#",":
                             "#"",ALERTDOC,"#",":
                             "#"",PTALAUDD,PTALAUDT,"#",":
                             "#"",DIM30,"#",":
                             "#"",RECTYPE,"#",":
                             "#"",PTALDTIN,"#",":
                             "#"",PTALEDAT,"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",PTALHOSP,"#",":
                             "#"","No","#",":
                             "#"",INACTDAT,SP1,TESTSL,SP1,AENDDATE,"#")" 
.
AUDROW99  RETURN
+
RESLOC00  STRIP     PTHSNAME
          STRIP     PTHSHOSP
          CLEAR     KEY16
          APPEND    "Hospital-",KEY16
          APPEND    PTHSHOSP,KEY16
          APPEND    SP70,KEY16
          RESET     KEY16
          STRIP     KEY16
          STRIP     WBTPFIL  *  Template
          WRITE     HTMLFILE;*+," { #"resourceType#": #"Location#",":
                    "   #"id#": #"",KEY16,"#",":
                    " #"extension#": [":
                    " { #"url#":#"%BASEURL/extension/webPASService#"":
                        " ,#"valueString#":#"",PRGID,SP1,PRGNAM,SP1,VERSION,"#"},":
                    " { #"url#":#"%BASEURL/extension/webPASTemplate#"":
                        " ,#"valueString#":#"%TEMPLATEHOME/",WBTPFIL," %TEMPLATEVERSION#"}":
                    " ],":
                    " #"identifier#": {":
                    "   #"value#": #"",KEY16,"#"":
                    " },";
          MATCH     SP70,PTHSTELE
          IF        !@EQUAL
             WRITE     HTMLFILE;*+," #"telecom#": [":
                       "{ #"system#": #"phone#",":
                       "  #"value#": #"",PTHSTELE,"#" }";
          ELSE
             MATCH     SP70,PTHSFAXN
             IF        !@EQUAL
                WRITE    HTMLFILE;*+," #"telecom#": [";
             ENDIF
          ENDIF
          MATCH     SP70,PTHSFAXN
          IF        !@EQUAL
             MATCH     SP70,PTHSTELE
             IF        !@EQUAL
               WRITE     HTMLFILE;*+,",";
             ENDIF
             WRITE     HTMLFILE;*+,"{ #"system#": #"fax#",":
                       "  #"value#": #"",PTHSFAXN,"#" } ],";
          ELSE
             MATCH     SP70,PTHSTELE
             IF        !@EQUAL
               WRITE     HTMLFILE;*+,"],";
             ENDIF
          ENDIF
          WRITE     HTMLFILE;*+," #"name#": #"",PTHSNAME,"#", ":
                    " #"physicalType#": {":
                    "  #"coding#": [ {":
                    "   #"system#": #"http://hl7.org/fhir/location-physical-type#",":
                    "   #"code#": #"si#",":
                    "   #"display#": #"Site#"  } ] }":
                    "  } ";
RESLOC99  RETURN
+
.------------------------------------------------------------------------------
. FHIR Encounter Resource Recorder
.------------------------------------------------------------------------------
RESPRA00  MATCH     SP70,WBSEOCG
          IF        !@EQUAL
            MOVE      SP70,DIM20
            MOVE      "w0",CATEGORY
            PACK      KEY5,CATEGORY,WBSEOCG,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,DIM20
            ENDIF
          ENDIF
.
          MOVE      SP70,KEY10
          MATCH     SP70,WBSEDOC
          IF        !@EQUAL
            PACK      KEY10,WBSEDOC,SP70
          ELSE
            MATCH     SP70,WBSEGPCD
            IF        !@EQUAL
              PACK      KEY10,WBSEGPCD,SP70
            ENDIF
          ENDIF
.
          MATCH     SP70,KEY10
          IF        !@EQUAL & !@EOS
            MOVE      SP70,TDESC
            CALL      RDPMHCP1
            IF        OVRCD=0
              MATCH     SP70,PMHCSPC1
              IF        !@EQUAL
                MOVE      "DT",KEY2
                PACK      KEY5,KEY2,PMHCSPC1,SP70
                CALL      RDCODE1
                IF        OVRCD=1
                  MOVE      SP70,TDESC
                ENDIF
              ENDIF
            ENDIF
            STRIP     KEY10 
          ENDIF
.
          STRIP     WBTPFIL  *  Template
          WRITE     HTMLFILE;*+," { #"resourceType#": #"Practitioner#",":
                    "   #"id#": #"User-",PTALUSID,"#",":
                    " #"extension#": [":
                    " { #"url#":#"%BASEURL/extension/webPASService#"":
                        " ,#"valueString#":#"",PRGID,SP1,PRGNAM,SP1,VERSION,"#"},":
                    " { #"url#":#"%BASEURL/extension/webPASTemplate#"":
                        " ,#"valueString#":#"%TEMPLATEHOME/",WBTPFIL," %TEMPLATEVERSION#"},":
                    " { #"url#":#"%BASEURL/extension/dxc-hc-role#"":
                        " ,#"valueString#":#"",DIM20,"#"}";

          MATCH     SP70,KEY10
          IF        !@EQUAL & !@EOS
            WRITE     HTMLFILE;*+,",{ #"url#": #"%BASEURL/extension/dxc-hc-hcp#"":
                                "  ,#"valueReference#" : #"Practitioner/HCP-",KEY10,"#"}";
          ENDIF
.
          MATCH     SP70,TDESC
          IF        !@EQUAL & !@EOS
            WRITE     HTMLFILE;*+,",{#"url#":#"%BASEURL/extension/dxc-hc-speciality#"":
                                  ",#"valueString#" : #"",TDESC,"#"}";
          ENDIF

          WRITE     HTMLFILE;" ],":
                    " #"identifier#": {":
                    "   #"use#": #"official#",":
                    "   #"system#": #"%BASEURL#",":
                    "   #"value#": #"",WBSELOGN,"#"":
                    " },";
          WRITE     HTMLFILE;*+," #"name#": [":
                    "{ #"use#": #"usual#",":
                    "  #"text#": #"",WBSENAM,"#",": 
                    "  #"family#": #".#",": 
                    "  #"given#": [#"",WBSENAM,"#"] ":
                    "} ]";
.
          MATCH     SP70,WBSEEMAI
          IF        !@EQUAL
             WRITE     HTMLFILE;*+,",";
             WRITE     HTMLFILE;*+," #"telecom#": [":
                       "{ #"system#": #"email#",":
                       "  #"value#": #"",WBSEEMAI,"#" } ]";
          ENDIF
.
          WRITE     HTMLFILE;*+,"  } ";
.
RESPRA99  RETURN
+
.------------------------------------------------------------------------------
. FHIR Encounter Resource Asserter
.------------------------------------------------------------------------------
RESASS00  MOVE      PMHCADR1,PRACNAME       * use hcp details
          MOVE      PMHCADR2,PRACADD1
          MOVE      SP70,PRACADD2
          MOVE      PMHCADR3,PRACADD3
          MOVE      PMHCADR4,PRACADD4
          MOVE      PMHCPOST,PRACPOST
          MOVE      PMHCSEML,PRACPEML
          MOVE      PMHCSTEL,PRACPTEL
          MOVE      PMHCFAXN,PRACPFAX
          MOVE      PMHCPRV1,PRACPROV
          PACK      DISPPRAC,SP70
          PACK      DISPPNAM,SP70,SP70
          PACK      DISPPCNT,SP70
.
          MOVE      "DT",TCODE
          PACK      KEY5,TCODE,PMHCSPC1,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      SP70,TDESC
          ENDIF
          CALL      HCPNAM00
          WRITE     HTMLFILE;*+," { #"resourceType#": #"Practitioner#",":
                    "   #"id#": #"HCP-",PMHCHCPC,"#",":
                    " #"extension#": [":
                    " { #"url#":#"%BASEURL/extension/webPASService#"":
                        " ,#"valueString#":#"",PRGID,SP1,PRGNAM,SP1,VERSION,"#"},":
                    " { #"url#":#"%BASEURL/extension/webPASTemplate#"":
                        " ,#"valueString#":#"%TEMPLATEHOME/",WBTPFIL," %TEMPLATEVERSION#"},":
                    " { #"url#":#"%BASEURL/extension/dxc-hc-speciality#"":
                        " ,#"valueString#":#"",TDESC,"#"}":
                    " ],":
                    " #"identifier#": [ ":
                    "  {#"type#": { #"text#" : #"HCP ID#" },":
                    "   #"value#": #"",PMHCHCPC,"#" },":
                    "  {#"type#": { #"text#" : #"Provider Number#" },":
                    "   #"value#": #"",PRACPROV,"#" }":
                    "    ] ,":
                    " #"name#": [ { ":
                    "  #"use#": #"usual#",":
                    "  #"text#": #"",DOCFNAME,"#" ,":
                    "  #"prefix#":[ #"",PMHCTITL,"#" ],":
                    "  #"given#": [ #"",PMHCGNAM,"#" ],":
                    "  #"family#": #"",PMHCSNAM,"#" } ],":
                    "  #"telecom#": [ ":
                    "   { #"system#": #"phone#", #"use#": #"work#", ":
                    "     #"value#": #"",PRACPTEL,"#" },":
                    "   { #"system#": #"email#", #"use#": #"work#", ":
                    "     #"value#": #"",PRACPEML,"#" },":
                    "   { #"system#": #"phone#", #"use#": #"mobile#", ":
                    "     #"value#": #"",PMHCMOBN,"#" },":
                    "   { #"system#": #"fax#",   #"use#": #"work#", ":
                    "     #"value#": #"",PRACPFAX,"#" } ],":
                    " #"address#": [ {":
                    "  #"use#": #"work#",":
                    "  #"line#": [#"",PRACNAME,"#"":
                    ",#"",PRACADD1,"#"";
          MATCH     SP70,PRACADD2
          IF        !@EQUAL
            STRIP     PRACADD2
            WRITE     HTMLFILE;*+,",#"",PRACADD2,"#"";
          ENDIF
          WRITE     HTMLFILE;*+,"],":
                      "       #"city#": #"",PRACADD3,"#",":
                      "       #"state#": #"",PRACADD4,"#",":
                      "       #"postalCode#": #"",PRACPOST,"#"":
                      "      }":
                      "    ]";
          WRITE     HTMLFILE;*+,"  }";
RESASS99  RETURN
+
          INC       OBSFHRCD
          INC       OBSALTIO/INC
          INC       PATALRIO/INC      * Patient Alerts Code File IO
          INC       PMSALNIO/INC      * Patient Alerts Comments     
          INC       PMSALAIO/INC      * Patient Alerts Comments     
          INC       IBAPASIO/INC      * Passcode File IO
          INC       IBAOVRIO/INC
          INC       OBSPCOIO/INC
.
ALTAB999  ENDPROC
