.*****************************************************************************
.*    Program      : FX121542                                                *
.*    Description  : Clear diagnostic onset type for morphology codes in     *
.*                   patecdaf                                                *
.*    Author       : Davin                                                   *
.*    Date         : 25/10/2006                                              *
.*    Modifications:                                                         *
.*****************************************************************************
. V12.00.01 16/05/2025  Nikitha B       TSK 0955096                          *
.           Alphanumeric changes.                                            *
.*****************************************************************************
.
          INC       STD001FD
          INC       PATCONFD/INC
          INC       PATDSCFD/INC
          INC       PATECDFD/INC
          INC       PATICDFD/INC
.
RECNUM    FORM      8
STRTDATE  INIT      "20060701"
.
PRGNAM    INIT      "Fix morpholgy codes"
PRGID     INIT      "FX121542"
VERSION   INIT      "V12.00.01"
.
. Start of Program
.
MAIN0000  CALL      INIT0000                      * init and open files
          BRANCH    EXIT,MAIN9999                 * init failure
.
          CALL      CONTQST                       * Ok to continue ?
          BRANCH    CEXIT,MAIN1000,MAIN0000,MAIN9999 * Yes, no, cancel
.
. Loop thru file and update ptedoset for morphology codes
.
MAIN1000  CALL      READ0000                      * read old records and write
.
MAIN9999  CHAIN     PGM
+
.********************************************************************
.*                          INIT0000                                *
.*  Display heading and check that the files needed exist&open them *
.********************************************************************
INIT0000  CALL      DISPHEAD
.
          CALL      OPICD1
          OPEN      PATDSCH2,"patdschf"
          OPEN      PATECDA1,"patecdaf"
          MOVE      ZERO,RECNUM
INIT9999  RETURN
+
.**********************************************************************
.*                               READ0000                             *
.*             loop thru old file and write each record               *
.**********************************************************************
READ0000  DISPLAY   *P1:20,*EL,"Records Updated : ";
.
          PACK      KEY16,STRTDATE,SP70           * start at 01/07/2006
          CALL      RDSDSCH2
READ0600  CALL      RDKDSCH2                      * loop thru disch file
          BRANCH    OVRCD,READ6000                * finish
.
          MOVE      DDATE,ICDRDDTE          * Used for reading ICD files
.
          PACK      KEY12,DADMNO,SP70
          CALL      RSPTECD1
READ1000  CALL      RKPTECD1                      * loop for this admno
          BRANCH    OVRCD,READ0600                * get next discharge record
.
          MATCH     DADMNO,PTEDADMN
          GOTO      READ0600 IF NOT EQUAL         * different admn
.
          PACK      KEY9,PTEDCODE,SP10
          CALL      RDPTICD1                * Read ICD file based on Disch dte
          BRANCH    OVRCD,READ1000
.
          MATCH     "4",PT0DACRQ            * morphology code?
          GOTO      READ1000 IF NOT EQUAL       
.         
          MATCH     SP70,PTEDOSET
          IF        !@EQUAL
            PACK      PTEDOSET,SP70
            CALL      UPPTECD1              * update record
            ADD       ONE,RECNUM            * update record counter
          ENDIF
.
          IF        (RECNUM%500) = 0
            DISPLAY   *P19:20,*V2LON,RECNUM,PTEDADMN
          ENDIF
.
          GOTO      READ1000                      * check next code record
.
READ6000  CLOSE     PATDSCH2                      * close files
          CLOSE     PATECDA1
          CLOSE     PATI10D1
.
          CALL      IBACLOCK
          CLOCK     TIME,CTIMEIS
          DISPLAY   *P1:20,*EL,"Records Updated  : ",RECNUM
          DISPLAY   *P1:22,"Ended  : ",CDATE,SP1,CTIMEIS
          DISPLAY   *P1:24,*EL;
          CALL      HITENTER
.
READ9999  RETURN
.
+
.**********************************************************************
.
          INC       PATDSCIO/INC
          INC       PATECDIO/INC
          INC       PATICDIO/INC
          INC       STD001IO
