.******************************************************************************
.* System         : Outpatients                                               *
.* Program        : IBAOUT27.PBL                                              *
.* Name           : Copy Outpatient Appointments                              *
.******************************************************************************
.* Date           : 21.04.2009                                                *
.* Author         : Ebon Clements                                             *
.* Function       : Copy outpatients appointments from a date to another      *
.*                                                                            *
.* Modifications  :                                                           *
.******************************************************************************
.* V12.00.01 23/05/2025  Bella Turco    TSK 0955096                           *
.*           Added alphanumeric changes                                       *
.*           13/05/2025  Ebon Clements  TSK 0955096                           *
.*           Added alphanumeric visit number generation - RFOL0000 - GENANVIS *
.* V11.02.03 19/05/2022 J.Tan           TSK 0837128                           *
.*           Recompiled for PRFAINSR - to use Cat CL indic 24                 *
.* V11.02.02 20/04/2022 J.Tan           TSK 0837128                           *
.*           Mod Default PRFA based on Claim type (PRFAINSR)                  *
.* V11.02.01 09/02/2022 Thanh T         TSK 0905641                           *
.*           Added Additional HCP Code (1-4) for outhedaf                     *
.******************************************************************************
.*       V11.00.02 22/04/2020  Ebon Clements     TSK 0850105                  *
.*                 Clear PMCUTSTA and PMCUTLOC before write to pmscuraf       *
.*       V11.00.01 09/04/2020  J.Tan             TSK 0868813                  *
.*                 Mod to set PACFRMT to 3 for PKNAME                         *
.*       V10.11.02 27/11/2017 Thanh T.           TSK 0821710                  *
.*                 Recompiled as PATMISTD changed                             *
.*       V10.11.01 20/09/2017 Thanh T.           TSK 0821710                  *
.*                 Audit Amission/outpatient visit comments                   *
.******************************************************************************
.*       V10.07.01 30/10/2015  Ebon Clements     CAR 268970                   *
.*                 Change to use OUTCLIFD index 1 instead of index 2          *
.*       V10.06.02 10/06/2015  Steve Armstrong   CAR 313856                   *
.*                 Mods to use CLVISINT & CLVISIAU instead of internal        *
.*                 clear routines                                             *
.*       V10.06.01 12/03/2015  Steve Armstrong   CAR 314108                   *
.*                 Removed reference to PATCGPFD (No Longer in use)           *
.******************************************************************************
.*       V10.05.01 12/09/2014  J.Tan             CAR 274958                   *
.*                 Added Employer code to pmswx1af file                       *
.******************************************************************************
.*       V10.04.01 21/03/2014  Steve Armstrong   CAR 298483                   *
.*                 Recompiled for changes to DGCLICON & DGCLICOB              *
.******************************************************************************
.*       V10.03.06 11/12/2013  Ebon Clements   CAR 293092                     *
.*                 Added notified and confirmed to interpreter audit          *
.*       V10.03.05 14/10/2013  Ania P          CAR 278232                     *
.*                 Refactored code - now using COUNTSLT for session           *
.*                 recalculation                                              *
.*       V10.03.04 30/06/2013  Davin           CAR 283202                     *
.*                 Recompiled for changes to hl7 messaging                    *
.*       V10.03.03 31/01/2013  Ebon Clements   CAR 262292                     *
.*                 Added language to interpreter audit                        * 
.*       V10.03.02 31/08/2012  Peter Vela      CAR 266428                     *
.*                  Added VSINCHON before write to visintaf                   *
.*       V10.03.01 18/11/2011  Mike Laming     CAR 240184                     *
.*                 Changes to IBAPOSTF Post Code table - added State to Keys  *
.*       V10.02.01 01/07/2011  Steve Armstrong   CAR 240722                   *
.*                 Mods to cater for changes to PMSCURFD:                     *
.*                      - PMCUSURN & PMCUGNAM extended to 40 chars.           *
.*                      - PMCUGNM2 added.                                     *
.******************************************************************************
.*        V10.00.01 19/03/2010  Steve Armstrong   CAR 135505                  *
.*                  Added HL7TRGID & HL7INCLD setting for all broadcast       *
.*                  messages                                                  *
.******************************************************************************
.*        V9.12.06  21/01/2010  Ebon Clements    CAR 214121                   *
.*                  Added OTCNINTR - Using visit based interpreter required   *
.*        V9.12.05  16/09/2009  Peter Vela       CAR 205412                   *
.*                  Fixed patcodes read of CAT SA OTBBSPCA Special Arr        *
.*                  Fixed copy of presenting complaint and interpreter req    *
.*                  Fixed copy of diagnosis                                   *
.*                  Fixed copy of extra appointment details                   *
.*        V9.12.04  10/08/2009  Ebon Clements    CAR 190940                   * 
.*                  Fixed unavailable slot test for NEWSLOTK                  *
.*        V9.12.03  07/08/2009  Jill Habasque    CAR 190940                   * 
.*                  Added in transport details                                *
.*        V9.12.02  06/08/2009  Ebon Clements    CAR 190940                   * 
.*                  Added total bookings and copy session slots to next week  *
.*        V9.12.01  06/08/2009  Ebon Clements    CAR 190940                   * 
.*                  Added total missing slots count                           *
.*        V9.12.00  21/04/2009  Ebon Clements    CAR 190940                   * 
.*                  Created program                                           *
.******************************************************************************
.
          INC       STD001FD
.
          INC       ALLCONFD/INC            * A/H control file
          INC       ALLLNKFD/INC            * A/H Referral Links 
          INC       CCICONFD/INC            * CCI Control File
          INC       CCIEX7FD/INC            * Clinical Costing Extract 7
          INC       EOCLNKFD/INC            * EOC linked events
          INC       HICCLMFD/INC            * HIC Claims
          INC       IBACONFD/INC            * Control file
          INC       IBAPOSFD/INC
          INC       MRTCONFD/INC            * MRT control file
          INC       NHIMASFD/INC            * NHI Master
          INC       OUTBOAFD/INC            * Clinic session booking file A
          INC       OUTBB1FD/INC            * Clinic session booking file B
          INC       OUTBOCFD/INC            * Clinic Session Booking Table C
          INC       OUTCANFD/INC            * Cancelled bookings
          INC       OUTCLIFD/INC            * Clinic file
          INC       OUTCTYFD/INC            * Clinic type
          INC       OUTCONFD/INC            * Outpatient Control File
          INC       OUTDIAFD/INC            * Outpatinet diagnosis
          INC       OUTHEDFD/INC            * Clinic master header file
          INC       OUTMA1FD/INC            * Clinic master file
          INC       OUTMSPFD/INC            * Clinic master suspensions
          INC       OUTRAPFD/INC            * Re-Appointments
          INC       OUTRSHFD/INC            * Referral List
          INC       OUTSITFD/INC            * Site file
          INC       OUTSESFD/INC            * Session file
          INC       OUTPREFD/INC            * Outpatient Pre-attendance fil
          INC       OUTXSCFD/INC            * Extension File
          INC       PATDO1FD/INC            * Doctors file
          INC       PATCALAG/INC            * Age vars
          INC       VISMDTFD/INC
          INC       VISMTXFD/INC
          INC       PATMISTD/INC
          INC       PATCODFD/INC            * Category codes
          INC       PATCONFD/INC            * Patient control file
          INC       PATICDFD/INC            * ICD10 Disease
          INC       PATICOFD/INC            * ICD10 Operation
          INC       PATIN1FD/INC            * Insurance file
          INC       PATHSPFD/INC            * Hospital file
          INC       PATMA1FD/INC            * Patient master file
          INC       PATNIDFD/INC            * National ID
          INC       PATRE1FD/INC            * PRA   
          INC       PATVISFD/INC            * Visit file
          INC       PATWC1FD/INC            * Workers comp
          INC       PATWMAFD/INC            * TAC
          INC       PATWVEFD/INC            * Veteran Affairs
          INC       PMSHCPFD/INC            * National HCP file
          INC       PMSCURFD/INC            * Current Patients
          INC       PMSPX2FD/INC            * Patient Master Extn File 2
          INC       PMSTSPFD/INC            * Transport Details     
          INC       PMSVX1FD/INC            * Visit Extension Table 
          INC       PMSWX1FD/INC            * Workers comp extn
          INC       PRIPRAFD/INC            * Medical practice
          INC       VISIAUFD/INC            * Interpreter audit
          INC       VISINTFD/INC            * Interpreter visit file
          INC       WATTR1FD/INC            * Waiting list
          INC       WATTX1FD/INC            * Waiting list extn
          INC       WEBSECFD/INC
.
. ----- Program Variables -----
.
ADMISSNO  DIM       8                       * Admission number
AUDIFLAG  FORM      1                       * Audit flag
BJDAY     FORM      3
CJDAY     FORM      3
CATEGORY  DIM       2
CASEKEYS  DIM       28                      * Current appointment case key
CHKGRPIN  FORM      1 
CLINICID  DIM       6                       * Clinic id
CLINICDS  DIM       30                      * Clinic Description
CODE      DIM       3
CPFRDATE  DATE      8                       * Copy from date (ccyymmdd)
CPTODATE  DATE      8                       * Copy to date (ccyymmdd)
CNTSLOTS  FORM      3
CURRDATE  DIM       8
CWEBSDAY  FORM      4                       * Current Admission Day Range
DATACHNG  FORM      1
DAYCOUNT  FORM      1                       * Day count for weekly option
DIAGOVR   FORM      1                       * Diagnosis overcondition
DIM40     DIM       40
DISPDATE  DIM       10                      * Format display date
DISPDAT1  DIM       10                      * Format display date
FROMWDAY  FORM      1                       * From week day
HBWAIT    FORM      1 
HOSPCODE  DIM       3                       * Hospital
HOSPNAME  DIM       50                      * Hospital name
HOUR      FORM      2                       * Hour Variable
KSECONDS  INIT      ":00"
LASTOUTN  DIM       8                       * Last visit number 
LASTDATE  DIM       8
LINKOUTN  DIM       8                       * Linked visit number
LOCKCNT   FORM      2
NMPNUMB   DIM       20                      * actual number keyed in
MIN       DIM       2                       * Minutes Variable
MINUTES   FORM      6                       * Minutes Variable
NEWSLOTN  DIM       3                       * New slot
NEWSLOTM  DIM       5                       * New slot time
NEWSTYPE  DIM       3                       * New slot type
NEWMESSG  DIM       45                      * New slot error message
NEWSKEYS  DIM       25                      * New Session key
NEWSLOTK  DIM       28                      * New slot key
NEWVTYP   DIM       3                       * New visit type
NEWSLOTS  FORM      3
OLDSLOTS  FORM      3
OLDVTYP   DIM       3                       * Old visit type
OLDADCS   DIM       6                       * Old doctor seen
PACFNAM   DIM       35                      * Short format name
PARNSLOT  FORM      3
PRFRDATE  DIM       10                      * Display date to
PRTODATE  DIM       10                      * Display date from
PSAGECON  DIM       3
PSAGETYP  DIM       1
REVWFLAG  FORM      1
SVXSDTE1  DIM       8
SVXSDTE2  DIM       8
SVXSDTE3  DIM       8
SVXSDTE4  DIM       8
SVXSDTE5  DIM       8
SVXSDTE6  DIM       8
SVXSCO01  DIM       3
SVXSCO02  DIM       3
SVXSCO03  DIM       3
SVXSCO04  DIM       3
SVXSCO05  DIM       3
SVXSCO06  DIM       3
SVXSCO07  DIM       3
SVXSCO08  DIM       3
SVXSCO09  DIM       3
SVXSCO10  DIM       3
SVXSCO11  DIM       3
SVXSCO12  DIM       3
SVXSCO13  DIM       3
SVXSCO14  DIM       3
SVXSCO15  DIM       3
SVXSCO16  DIM       3
SVXSCO17  DIM       3
SVXSCO18  DIM       3
SVXSCO19  DIM       3
SVXSCO20  DIM       3
SVXSDOC1  DIM       6
SVXSDOC2  DIM       6
SVXSDOC3  DIM       6
SVXSAMT1  FORM     12.2
SVXSAMT2  FORM     12.2
SVXSDSC1  DIM       40 
SVXSDSC2  DIM       40 
SVXSDSC3  DIM       40 
SVXSDSC4  DIM       40 
SVXSDSC5  DIM       40 
SVXSDSC6  DIM       40 
SVXSTIM1  DIM       5  
SVXSTIM2  DIM       5  
SVXSTIM3  DIM       5  
SVXSTIM4  DIM       5  
SVXSTIM5  DIM       5  
SVXSTIM6  DIM       5  
SAVKEY10  DIM       10
SAVOUTNO  DIM        8
SAVICODE  DIM        9
SAVIDESC  DIM       50
SAVICOD2  DIM        9
SAVIDES2  DIM       50
SAVICOD3  DIM        9
SAVIDES3  DIM       50
SAVICOD4  DIM        9
SAVIDES4  DIM       50
SAVICOD5  DIM        9
SAVIDES5  DIM       50
SAVUDF1   DIM       50
SAVINTR   DIM       1
SAVADMNO  DIM       8                       * Saved Admission number
SAVBCOMP  DIM       3                       * Saved Claim code
SAVECASE  DIM       28                      * Save current appointment case key
SAVKEY17  DIM       17
SAVKEY20  DIM       20
SAVKEY28  DIM       28
SAVCDESC  DIM       30                      * Save clinic description
SAVECLIN  DIM       6                       * Save clinic id
SAVECTYP  DIM       6                       * Save clinic type
SAVCTDES  DIM       30                      * Save clinic type desc
SAVEDATE  DIM       8                       * Save clinic date
SAVESTRT  DIM       5                       * Save clinic start time
SAVKEY19  DIM       19                      
SAVRFDAT  DIM       8                       * Save referral date
SAVRFOUT  DIM       8                       * Save referral visit
SAVSLOT   DIM       3                       * Save slot
SAVSKEYS  DIM       25                      * Save Session key
SAVTIME   DIM       5                       * Save slot time
SAVVISIT  DIM       3                       * Save visit type
SESSKEYS  DIM       25                      * Session key
SLOTOPT   DIM       3
STRTDATE  DIM       8 
SITECODE  DIM       6                       * Site code
TOTLBOOK  FORM      5                       * Total invalid slots 
TOTLERRB  FORM      5                       * Total invalid slots 
TOTLERRS  FORM      5                       * Total invalid slots status
TOTLERRV  FORM      5                       * Total invalid slots visit type
URNUMBER  DIM       8                       * U/R number
INTAUDTY  DIM       1
VSLOT     DIM       3
WRITEBOK  FORM      1                       * Write bookings or report only
.
.-----------------------------------------------------------------------
PRGID     INIT      "IBAOUT27"
PRGNAM    INIT      "Copy Appointments"
VERSION   INIT      "V12.00.01"
.-----------------------------------------------------------------------
.
.******************************************************************************
.*                                   ML0000                                   *
.*                                 Main Module                                *
.******************************************************************************
ML0000    CALL      INIT0000                * Initialise variables & open files
.
ML1000    CALL      OPTN0000                * Choose main option
          BRANCH    OPTION,ML2000,ML2000
          BRANCH    EXIT,ML9999
.
ML2000    CALL      DATE0000                * Keyin the date range
          BRANCH    EXIT,ML1000
.
          CALL      CLIN0000                * Keyin the clinic
          BRANCH    EXIT,ML1000
.
          CALL      KHOS0000                * Keyin hospital
          BRANCH    EXIT,ML1000
.
          CALL      WBOK0000                * Write bookings
.
          GOTO      ML6000
.
ML6000    CALL      CONTQST                 * Ok to continue (Y/N/C) ?
          BRANCH    CEXIT,ML7000,ML1000,ML9999
          GOTO      ML1000
.
ML7000    CALL      PROC0000                * Process report
          CALL      ENDD0000                * End of report
          GOTO      ML1000
.
ML9999    CHAIN     PGM
.
.******************************************************************************
.*                                   INIT0000                                 *
.*                        Initialise Variable & Open Files                    *
.******************************************************************************
INIT0000  CALL      DISPHEAD                * Display screen heading
.
          DISPLAY   *P56:24,"Opening controlf";
          OPEN      CONTROLF,"controlf"
.
          READ      CONTROLF,THIRTY1;*51,HOAUDA,*52,HOAUDB
          READ      CONTROLF,TWENTY;*193,PTCNDCLM
          READ      CONTROLF,TWENTY1;*45,PTCNDRSM,PTCNBAGE,*180,PTCNCDRS:
                                     *209,PTCNADMT
          READ      CONTROLF,TWENTY1;*13,PTCNUNAK,*56,PTCNDEFT,*119,PTCNRPIK:
                             *138,PTCNNHII,PTCNNHID,PTCNDONR,PTCNMEDW,PTCNUDNG:
                             *178,PTCNMPTR,PTCNCDRS,PTCNLNCD,PTCNLP01:
                             *189,PTCNUONL:
                             PTCNPCON,PTCNNHIF,*204,PTCNAWRN,*226,PTCNMWAD:
                             *237,PTCNPAOF,*238,PTCNAGEC
          READ      CONTROLF,TWENTY7;*46,HBWAIT
          READ      CONTROLF,THIRTY1;*163,OTCNFTYP,*187,OTCNCSRR:
                                     *239,OTCNOCRD,*242,OTCNOCDD
          READ      CONTROLF,THIRTY2;*108,OTCNCREV,OTCNCSUM,*111,OTCNAUPD:
                                     *115,OTCNRSST,*122,OTCNMTVS,*124,OTCNMTVE:
                                     *131,OTCNINTR
          READ      CONTROLF,SIXTY1;*219,MRCNUCRG
          READ      CONTROLF,SEVENTY1;*200,CCCNSVHM
          READ      CONTROLF,SEVENTY9;*120,PTCNUEOC
          READ      CONTROLF,TEN;*244,CHOSPNUM
          READ      CONTROLF,SEVENTY9;*248,PTCNIPEN
          READ      CONTROLF,NINTY8;*149,PTCNGDV2
          READ      CONTROLF,HUND03;*220,PTCNDEES,*221,PTCNDDES
          READ      CONTROLF,HUND09;*151,PTCNGDV3
          READ      CONTROLF,HUND05;*104,PTCNDGET,*147,CMDISM,*158,PTCNDGPV:
                                    *173,PTCNICUT,*210,PTCNLCLM
          READ      CONTROLF,ZERO;*43,IBCNMHOS:
                                  *85,IBCNUGST,*132,IBCNUMCI
          READ      CONTROLF,HUND06;*27,ALCNRAUD,*28,ALCNEAUD,*213,ALCNLAUD
          READ      CONTROLF,HUND10;*248,PTCNEPAY
          READ      CONTROLF,HUND12;*96,PTCNH7AC,*101,PTCNUFFR
.
          DISPLAY   *P64:24,"ibapostf";
          OPEN      IBAPOST1,"ibapostf"
.
          DISPLAY   *P64:24,"pathspaf";
          OPEN      PATHSPA1,"pathspaf"
.
          DISPLAY   *P64:24,"patdo1af";
          OPEN      PATDO1A1,"patdo1af"
.
          DISPLAY   *P64:24,"patcodes";
          OPEN      PATCODE1,"patcodes"
.
          DISPLAY   *P64:24,"patma1af"
          OPEN      PATMA1A1,"patma1af"
.
          DISPLAY   *P64:24,"patma1af"
          OPEN      PATMX1A1,"patmx1af"
.
          DISPLAY   *P64:24,"pmspx2af";
          OPEN      PMSPX2A1,"pmspx2af"
.
          DISPLAY   *P64:24,"pmshcpaf";
          OPEN      PMSHCPA1,"pmshcpaf"
.
          DISPLAY   *P64:24,"pmstspaf"
          OPEN      PMSTSPA1,"pmstspaf"
.
          DISPLAY   *P64:24,"alllnkaf";
          OPEN      ALLLNKA1,"alllnkaf"
          OPEN      ALLLNKA2,"alllnkaf"
.
          DISPLAY   *P64:24,"pmsvx1af";
          OPEN      PMSVX1A1,"pmsvx1af"
.
          DISPLAY   *P64:24,"patvisaf";
          OPEN      PATVISA1,"patvisaf"
.

.
          DISPLAY   *P64:24,"patre1af";
          OPEN      PATRE1A1,"patre1af"
.
          DISPLAY   *P64:24,"pripracf";
          OPEN      PRIPRAC1,"pripracf"
.
          DISPLAY   *P64:24,"patwvetf";
          OPEN      PATWVET1,"patwvetf"
.
          DISPLAY   *P64:24,"patwmabf";
          OPEN      PATWMAB1,"patwmabf"
.
          DISPLAY   *P64:24,"patwc1af";
          OPEN      PATWC1A1,"patwc1af"
.
          DISPLAY   *P64:24,"vismdtaf";
          OPEN      VISMDTA1,"vismdtaf"
          DISPLAY   *P64:24,"vismtxaf";
          OPEN      VISMTXA1,"vismtxaf"
.
          DISPLAY   *P64:24,"hicclmaf";
          OPEN      HICCLMA1,"hicclmaf"
.
          DISPLAY   *P64:24,"pmswx1af";
          OPEN      PMSWX1A1,"pmswx1af"
.
          DISPLAY   *P64:24,"eoclnkaf";
          OPEN      EOCLNKA2,"eoclnkaf"
.
          DISPLAY   *P64:24,"visintaf";
          OPEN      VISINTA1,"visintaf"
.
          DISPLAY   *P64:24,"visiauaf";
          OPEN      VISIAUA1,"visiauaf"
.
          DISPLAY   *P64:24,"nhimasaf";
          OPEN      NHIMASA1,"nhimasaf"
.
          DISPLAY   *P64:24,"pmscuraf";
          OPEN      PMSCURA1,"pmscuraf"
.
          IF        HBWAIT=1
            OPEN      WATTR1A1,"wattr1af"
            OPEN      WATTX1A1,"wattx1af"
          ENDIF
.
          DISPLAY   *P64:24,"outpreaf";
          OPEN      OUTPREA1,"outpreaf"
.
          CALL      OPICD1             * Open ICD Disease files
          CALL      OPICO1             * Open ICD Operation files
.
          DISPLAY   *P64:24,"outsitaf";
          OPEN      OUTSITA1,"outsitaf"
          MOVE      IDDD,SITECODE
          MOVE      IDDD,KEY6
          CALL      RDSITA1
.
          PACK      CFNAME WITH UID,FILBOKA1        * OUTBOKFD
          DISPLAY   *P64:24,CFNAME;
          OPEN      OUTBOKA1,CFNAME
.
          PACK      CFNAME WITH UID,FILBB1A1        * OUTBB1FD
          DISPLAY   *P64:24,CFNAME;
          OPEN      OUTBB1A1,CFNAME
.
          PACK      CFNAME WITH UID,FILBOKC1        * OUTBOCFD
          DISPLAY   *P64:24,CFNAME;
          OPEN      OUTBOKC1,CFNAME
.
          PACK      CFNAME WITH UID,FILCLIA1        * OUTCLIFD
          DISPLAY   *P64:24,CFNAME;
          OPEN      OUTCLIA1,CFNAME
.
          PACK      CFNAME WITH UID,FILSESA6        * OUTSESFD
          DISPLAY   *P64:24,CFNAME;
          OPEN      OUTSESA6,CFNAME
.
          PACK      CFNAME WITH UID,FILSESA1        * OUTSESFD
          DISPLAY   *P64:24,CFNAME;
          OPEN      OUTSESA1,CFNAME
.
          PACK      CFNAME WITH UID,FILMA1A1        * OUTMA1FD
          DISPLAY   *P64:24,CFNAME;
          OPEN      OUTMA1A1,CFNAME
.
          PACK      CFNAME WITH UID,FILHEDA1        * OUTHEDFD
          DISPLAY   *P64:24,CFNAME;
          OPEN      OUTHEDA1,CFNAME
.
          PACK      CFNAME WITH UID,FILMSPA1        * OUTMSPFD
          DISPLAY   *P64:24,CFNAME;
          OPEN      OUTMSPA1,CFNAME
.
          PACK      CFNAME WITH UID,FILCTYA1        * OUTCTYFD
          DISPLAY   *P64:24,CFNAME;
          OPEN      OUTCTYA1,CFNAME
.
          PACK      CFNAME WITH UID,FILDIAG1        * OUTDIAFD
          DISPLAY   *P64:24,CFNAME;
          OPEN      OUTDIAG1,CFNAME
.
          PACK      CFNAME WITH UID,FILXSCA1        * OUTXSCFD
          DISPLAY   *P64:24,CFNAME;
          OPEN      OUTXSCA1,CFNAME
.
          PACK      CFNAME WITH UID,FILRSHA1        * OUTRSHFD
          DISPLAY   *P64:24,CFNAME;
          OPEN      OUTRSHA1,CFNAME
.
          PACK      CFNAME WITH UID,FILCANA1        * OUTCANFD
          DISPLAY   *P64:24,CFNAME;
          OPEN      OUTCANA1,CFNAME
.
          PACK      CFNAME WITH UID,FILRAPA1        * OUTRAPFD
          DISPLAY   *P64:24,CFNAME;
          OPEN      OUTRAPA1,CFNAME
.
INIT9999  RETURN
.
.******************************************************************************
.*                                  OPTN0000                                  *
.*                                Choose Option                               *
.******************************************************************************
OPTN0000  MOVE      ZERO,OPTION
          DISPLAY   *P1:3,*EF:
                    *P1:4,*V2LON,"0",*HOFF," = Exit":
                    *P1:5,*V2LON,"1",*HOFF," = Copy Day":
                    *P1:6,*V2LON,"2",*HOFF," = Copy Week":
                    *P1:8,"Select Option : ";
OPTN1000  KEYIN     *P17:8,*V2LON,*DV,UNDLN2,*P17:8,OPTION;
.
          COMPARE   ZERO,OPTION
          GOTO      OPTN9500 IF EQUAL
.
          BRANCH    OPTION,OPTN9000,OPTN9100
.
          BEEP
          GOTO      OPTN1000
.
OPTN9000  MOVE      "- Copy Day",CPHDROPT
          MOVE      ZERO,EXIT
          GOTO      OPTN9999
.
OPTN9100  MOVE      "- Copy Week",CPHDROPT
          MOVE      ZERO,EXIT
          GOTO      OPTN9999
.
OPTN9500  MOVE      ONE,EXIT
OPTN9999  RETURN
.
.******************************************************************************
.*                                   CLIN0000                                 *
.*                             Keyin The Clinic Code                          *
.******************************************************************************
CLIN0000  DISPLAY   *P1:13,*EF,"Clinic Id   : ";
          MOVE      SP6,CLINICID
          MOVE      SP6,CLINICDS
          MOVE      "17",ECOL
          MOVE      "13",EVERT
          MOVE      SP6,CKYIDEF6
          MOVE      ZERO,CKYIMAND
          CALL      KYOUTCLI                * Keyin the clinic id
          BRANCH    EXIT,CLIN1000,CLIN9500,CLIN1000
.
          MOVE      OCACLIN,CLINICID
          MOVE      OCADESC,CLINICDS
.
          DISPLAY   *P17:13,*EL,*V2LON,CLINICID,*P25:13,OCADESC;
          GOTO      CLIN9000
.
CLIN1000  MOVE      SP6,CLINICID
          MOVE      "All Clinics",CLINICDS
          DISPLAY   *P17:13,*EL,*V2LON,"All Clinics";
.
CLIN9000  MOVE      ZERO,EXIT
          GOTO      CLIN9999
.
CLIN9500  MOVE      ONE,EXIT
CLIN9999  RETURN
.
.******************************************************************************
.*                                  KHOS0000                                  *
.*                      Keyin hospital ID                                     *
.******************************************************************************
KHOS0000  MOVE       ZERO,EXIT
          MOVE       SP70,HOSPCODE
          MOVE       SP70,HOSPNAME
          COMPARE    ONE,IBCNMHOS
          GOTO       KHOS9999 IF NOT EQUAL
.
          MOVE       SP70,PTHSHOSP
          DISPLAY    *P1:14,*EL,"Hospital Id : ";
          MOVE       TEN5,ECOL
          MOVE       TEN4,EVERT
          MOVE       SP3,CKYIDEF3
          MOVE       ONE,CKYIMAND           * Mandatory
          OPEN       PATHSPA1,"pathspaf"
.
          CALL       PATHSPKY
          BRANCH     EXIT,KHOS9000,KHOS9000
.
KHOS3000  MOVE       PTHSHOSP,HOSPCODE
          MOVE       PTHSNAME,HOSPNAME
          DISPLAY   *P20:14,*V2LON,PTHSNAME;
          MOVE       ZERO,EXIT
          GOTO       KHOS9999
.
KHOS9000  MOVE       ONE,EXIT
KHOS9999  RETURN
.
.******************************************************************************
.*                                  DATE0000                                  *
.*                            Keyin The Date Range                            *
.******************************************************************************
DATE0000  MOVE      "17",CCOL
.
          IF        OPTION=1
            DISPLAY   *P1:11,"From Date : ",*EF:
                      *P1:12,"To Date   : ";
          ELSE
            DISPLAY   *P1:11,"From Week Start: ",*EF:
                      *P1:12,"To Week Start  : ";
          ENDIF
.
          MOVE      ONE,CCANLDTE            * Blank cancel default
.
. ----- Keyin start date -----
.
DATE1000  MOVE      "11",CVERT
          MOVE      CCC,CCENT
          UNPACK    SP6,CYEAR,CMON,CDAY
          CALL      KEYDATE                 * Keyin date
          BRANCH    OVRCD,DATE9500          * Nothing entered
          BRANCH    CQUEST,DATE1000
.
          PACK      CPFRDATE,CCENT,CYEAR,CMON,CDAY
          REP       " 0",CPFRDATE
.
          CALL      DAYOFWEK
          MOVE      WEEKDAY,FROMWDAY
.
. ----- Keyin end date -----
.
DATE2000  MOVE      "12",CVERT
          UNPACK    CPFRDATE,CCENT,CYEAR,CMON,CDAY
          CALL      KEYDATE                 * Keyin date
          BRANCH    OVRCD,DATE1000          * Nothing entered
          BRANCH    CQUEST,DATE2000
.
          PACK      CPTODATE,CCENT,CYEAR,CMON,CDAY
          REP       " 0",CPTODATE
          CALL      DAYOFWEK
.
          MATCH     CPFRDATE,CPTODATE
          IF        @EQUAL
            DISPLAY   *P1:24,*B,*EL,"Copy from and to date must be different. ";
            CALL      HITENTER 
            GOTO      DATE2000
          ENDIF
.
          COMPARE   FROMWDAY,WEEKDAY
          IF        !@EQUAL
            DISPLAY   *P1:24,*B,*EL,"Copy from and to day of week must be ":
                                    "the same. ";
            CALL      HITENTER 
            GOTO      DATE2000
          ENDIF
.
DATE9000  MOVE      ZERO,EXIT
          GOTO      DATE9999
.
DATE9500  MOVE      ONE,EXIT
DATE9999  RETURN
.
.------------------------------------------------------------
. Write bookings or just run validateion report
.------------------------------------------------------------
WBOK0000  DISPLAY   *P1:15,*EF
          KEYIN     *P1:15,*EL,"Create Bookings":
                    " (",*V2LON,"Y",*HOFF,"/":
                    *V2LON,"N",*HOFF,") ? ",*V2LON,ANS;
.
          REP       UPPLOW,ANS
          MATCH     ANSY,ANS
          IF        @EQUAL
            MOVE      ONE,WRITEBOK
            GOTO      WBOK9999
          ENDIF
.
          MATCH     ANSN,ANS
          IF        @EQUAL
            MOVE      ZERO,WRITEBOK
            GOTO      WBOK9999
          ENDIF
.
          BEEP
          GOTO      WBOK0000
.
WBOK9999  RETURN
.
.******************************************************************************
.*                                  PROC0000                                  *
.* Process copy of appointments                                               *
.******************************************************************************
PROC0000  MOVE      "60",CLNO                   * Print heading for page 1
          CALL      IBACLOCK
.
          MOVE      ONE,DAYCOUNT
.
          MOVE      ZERO,TOTLBOOK
          MOVE      ZERO,TOTLERRB
          MOVE      ZERO,TOTLERRS
          MOVE      ZERO,TOTLERRV
.
          MOVE      SP70,SAVECLIN
          MOVE      SP70,SAVEDATE
          MOVE      SP70,SAVESTRT
.
PROC0500  PACK      KEY25,SITECODE,CPFRDATE,SP70
          CALL      RDSSESA6
PROC1000  CALL      RDKSESA6
          BRANCH    OVRCD,PROC9000
.
          MATCH     SITECODE,OSESITE            * Correct Site
          GOTO      PROC9000 IF NOT EQUAL
.
          MATCH     OSEDATE,CPFRDATE            * Check session date
          GOTO      PROC9000 IF NOT EQUAL
.
          MATCH     SP70,CLINICID               * Clinic filter
          IF        !@EQUAL
            MATCH     CLINICID,OSECLIN
            GOTO      PROC1000 IF NOT EQUAL
          ENDIF
.
          PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,PROC1000
.
          BRANCH    OMASTAT,PROC1000            * Clinic Inactive
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,PROC1000
.
          IF        IBCNMHOS=1
            MATCH     HOSPCODE,OTHEHOSP
            GOTO      PROC1000 IF NOT EQUAL
          ENDIF
.
          MATCH     OTMADTCO,OSEDATE
          GOTO      PROC1000 IF LESS
.
          MATCH     SP70,OTMADTCC
          IF        !@EQUAL
            MATCH     OSEDATE,OTMADTCC
            GOTO      PROC1000 IF LESS
          ENDIF
.
          CALL      CHKSUS00
          BRANCH    EXIT,PROC1000
.
          PACK      KEY20,OSESITE,OSECLIN,OSEDATE,SP70
          CALL      RDCLIA1
          IF        OVRCD=1
            PACK      KEY20,OSESITE,OSECLIN,OSEDATE,Z70
            CALL      RDSCLIA1          * Read Clinic Record
            CALL      RDPCLIA1          * Read Clinic Record
            BRANCH    OVRCD,PROC1000
.             
            MATCH     OSESITE,OCASITE
            GOTO      PROC1000 IF NOT EQUAL
.             
            MATCH     OSECLIN,OCACLIN             
            GOTO      PROC1000 IF NOT EQUAL
          ENDIF
.
          PACK      KEY12,OTHESITE,OTHECTYP,SP70
          CALL      RDCTYA1
          BRANCH    OVRCD,PROC1000
.
          MOVE      ZEROVISN,LASTOUTN
          PACK      SAVSKEYS,OSESITE,OSECLIN,OSEDATE,OSESTRT,SP70
          PACK      SESSKEYS,OSESITE,OSECLIN,OSEDATE,OSESTRT,SP70
.
.  Check copy to session exists
.
          MOVE      SP70,NEWSKEYS
          PACK      KEY25,OSESITE,OSECLIN,CPTODATE,OSESTRT,SP70
          CALL      RDSESA1
          IF        OVRCD<>1
            PACK      NEWSKEYS,OSESITE,OSECLIN,OSEDATE,OSESTRT,SP70 
          ENDIF
.
          IF        WRITEBOK=1
            CALL      COPY0000             * Copy clinic layout to next week
          ENDIF
.
          PACK      KEY25,SAVSKEYS,SP70    * Re Read copy from session
          CALL      RDSESA1
          BRANCH    OVRCD,PROC1000
.
          CALL      PHED0000                * Print clinic heading
.
          PACK      KEY28,SAVSKEYS,SP70
          CALL      RDSBOKA1
PROC2000  CALL      RDKBOKA1                * next read on details file
          BRANCH    OVRCD,PROC1000          * end of session
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT
          MATCH     SAVSKEYS,KEY25
          GOTO      PROC1000 IF NOT EQUAL   * different session
.         
          COMPARE   SIX,OBASTAT             * Suspended
          GOTO      PROC2000 IF EQUAL
.
          COMPARE   THREE,OBASTAT           * Extended
          GOTO      PROC2000 IF EQUAL
.
          COMPARE   TWO,OBASTAT             * No used
          GOTO      PROC2000 IF EQUAL
.         
          MATCH     ZEROVISN,OBAOUTNO   
          IF        !@EQUAL
            MATCH     LASTOUTN,OBAOUTNO
            GOTO      PROC2000 IF EQUAL
          ENDIF
          MOVE      OBAOUTNO,LASTOUTN
.
          COMPARE   ZERO,OBASTAT             * No booked
          GOTO      PROC2000 IF EQUAL
.
          COMPARE   NINE,OBASTAT             * Reserved
          GOTO      PROC2000 IF EQUAL
.
          COMPARE   SEVEN,OBASTAT            * No unavailable
          GOTO      PROC2000 IF EQUAL
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDBOKB1
          BRANCH    OVRCD,PROC2000
.
          MATCH     SP70,OTBBSPCA
          IF        !@EQUAL & !@EOS
            PACK      KEY5,ANSS,ANSA,OTBBSPCA,SP70
            CALL      RDCODE1
            BRANCH    OVRCD,PROC20000
.
            MATCH     ANSN,TCINDC1          * Do not copy booking
            GOTO      PROC2000 IF EQUAL
          ENDIF
.
          MATCH     "1",OTBBFLUP            * Followup already made
          GOTO      PROC2000 IF EQUAL
.
          MOVE      OBAURNO,URNUMBER
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,PROC2000
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,PROC2000
.
          BRANCH    PCEASE,PROC2000
.
          UNPACK    PBDATE,CDAY,CMON,CYEAR,CCENT
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
          MOVE      OBASLOT,SAVSLOT         * Save original booking details
          MOVE      OBATIME,SAVTIME
          MOVE      OBAVISIT,SAVVISIT
.
          ADD       ONE,TOTLBOOK
.
          MATCH     SP70,NEWSKEYS           * No copy to session 
          GOTO      PROC4000 IF EQUAL
.
          PACK      SAVECASE,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
          PACK      CASEKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
.
          PACK      NEWSLOTK,NEWSKEYS,OBASLOT,SP70 * New session slot key
          CALL      NEWS0000                       * Validate new slot key
.
          MOVE      SP70,SAVOUTNO
          PACK      KEY28,SAVECASE,SP70     * Re read original booking record
          CALL      RDBOKA1
          BRANCH    OVRCD,PROC2000
.
          MOVE      OBAOUTNO,SAVOUTNO
.           
          MOVE      SP70,SAVUDF1
          MOVE      SP70,SAVINTR
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDPMVX11
          IF        OVRCD=0
            MOVE      PMVXUDF1,SAVUDF1
            MOVE      PMVXINTR,SAVINTR
          ENDIF     
.           
          CALL      CLSODI00
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDDIAG1
          IF        OVRCD=0
            MOVE      OPDICODE,SAVICODE
            MOVE      OPDIDESC,SAVIDESC
            MOVE      OPDICOD2,SAVICOD2
            MOVE      OPDIDES2,SAVIDES2
            MOVE      OPDICOD3,SAVICOD3
            MOVE      OPDIDES3,SAVIDES3
            MOVE      OPDICOD4,SAVICOD4
            MOVE      OPDIDES4,SAVIDES4
            MOVE      OPDICOD5,SAVICOD5
            MOVE      OPDIDES5,SAVIDES5
          ENDIF
.
          CALL      CLSXSC00
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDOTXSC1
          IF        OVRCD=0
            MOVE      OTXSDTE1,SVXSDTE1
            MOVE      OTXSDTE2,SVXSDTE2
            MOVE      OTXSDTE3,SVXSDTE3
            MOVE      OTXSDTE4,SVXSDTE4
            MOVE      OTXSDTE5,SVXSDTE5
            MOVE      OTXSDTE6,SVXSDTE6
            MOVE      OTXSCO01,SVXSCO01
            MOVE      OTXSCO02,SVXSCO02
            MOVE      OTXSCO03,SVXSCO03
            MOVE      OTXSCO04,SVXSCO04
            MOVE      OTXSCO05,SVXSCO05
            MOVE      OTXSCO06,SVXSCO06
            MOVE      OTXSCO07,SVXSCO07
            MOVE      OTXSCO08,SVXSCO08
            MOVE      OTXSCO09,SVXSCO09
            MOVE      OTXSCO10,SVXSCO10
            MOVE      OTXSCO11,SVXSCO11
            MOVE      OTXSCO12,SVXSCO12
            MOVE      OTXSCO13,SVXSCO13
            MOVE      OTXSCO14,SVXSCO14
            MOVE      OTXSCO15,SVXSCO15
            MOVE      OTXSCO16,SVXSCO16
            MOVE      OTXSCO17,SVXSCO17
            MOVE      OTXSCO18,SVXSCO18
            MOVE      OTXSCO19,SVXSCO19
            MOVE      OTXSCO20,SVXSCO20
            MOVE      OTXSDOC1,SVXSDOC1
            MOVE      OTXSDOC2,SVXSDOC2
            MOVE      OTXSDOC3,SVXSDOC3
            MOVE      OTXSAMT1,SVXSAMT1
            MOVE      OTXSAMT2,SVXSAMT2
            MOVE      OTXSDSC1,SVXSDSC1
            MOVE      OTXSDSC2,SVXSDSC2
            MOVE      OTXSDSC3,SVXSDSC3
            MOVE      OTXSDSC4,SVXSDSC4
            MOVE      OTXSDSC5,SVXSDSC5
            MOVE      OTXSDSC6,SVXSDSC6
            MOVE      OTXSTIM1,SVXSTIM1
            MOVE      OTXSTIM2,SVXSTIM2
            MOVE      OTXSTIM3,SVXSTIM3
            MOVE      OTXSTIM4,SVXSTIM4
            MOVE      OTXSTIM5,SVXSTIM5
            MOVE      OTXSTIM6,SVXSTIM6
          ENDIF
.
          COMPARE   ONE,WRITEBOK            * Write bookings
          GOTO      PROC4000 IF NOT EQUAL
.
          MATCH     SP70,NEWSLOTK
          IF        !@EQUAL
            CALL      BFOL0000
          ENDIF
.
          PACK      KEY28,SAVECASE,SP70     * Re read original booking record
          CALL      RDBOKA1
          BRANCH    OVRCD,PROC2000
.
          PACK      KEY25,SAVSKEYS,SP70     * Re read original session record
          CALL      RDSESA1
          BRANCH    OVRCD,PROC1000
.
PROC4000  CALL      PAPP0000                * Print appointment details
.
          GOTO      PROC2000
.
PROC9000  COMPARE   TWO,OPTION              * Weekly option
          GOTO      PROC9999 IF NOT EQUAL
.
          COMPARE   SEVEN,DAYCOUNT          * Finished the week
          GOTO      PROC9999 IF EQUAL
.
          ADD       ONE,DAYCOUNT
          ADD       ONE,CPFRDATE            * Increase day from by 1 day
          ADD       ONE,CPTODATE            * In crease copy day to by 1 day
          GOTO      PROC0500

PROC9999  RETURN
.
.
.------------------------------------------------------------
. Copy the clinic layout for this session to next weeks session.
. First delete all slots from next weeks session that have a 
. status of NOT BOOKED. Then write all of this weeks slots
. to next weeks session with a status of NOT BOOKED    
.------------------------------------------------------------
COPY0000  MATCH     SP70,NEWSKEYS           * Next weeks session
          GOTO      COPY9999 IF EQUAL
.
          PACK      KEY25,NEWSKEYS,SP70     * Re Read copy to session
          CALL      RDSESA1
          BRANCH    OVRCD,COPY9999
.
. Delete all empty slot from next weeks session
.
COPY0500  PACK      KEY28,NEWSKEYS,SP70
          CALL      RDSBOKA1
COPY1000  CALL      RDKBOKA1                * next read on details file
          BRANCH    OVRCD,COPY4000          * end of session
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT
          MATCH     NEWSKEYS,KEY25
          GOTO      COPY4000 IF NOT EQUAL   * different session
.
          COMPARE   ZERO,OBASTAT
          GOTO      COPY1000 IF NOT EQUAL
.
          MOVE      OBASLOT,VSLOT
          PACK      KEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
          CALL      DEBOKA1
.
COPY2000  PACK      KEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
          CALL      RDSBOKA1
          CALL      RDKBOKA1                * next read on details file
          BRANCH    OVRCD,COPY0500          * end of session
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT
          MATCH     NEWSKEYS,KEY25
          GOTO      COPY0500 IF NOT EQUAL   * different session
.
          COMPARE   THREE,OBASTAT
          GOTO      COPY0500 IF NOT EQUAL
.
          MOVE      OBAEXSL,SLOTOPT          * Parent slot no to a dim field
          MATCH     SLOTOPT,VSLOT
          GOTO      COPY0500 IF NOT EQUAL
.
          PACK      KEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
          CALL      DEBOKA1
.
          GOTO      COPY2000
.
. Copy all this weeks session to next weeks session with a 
. status of booked.
.
COPY4000  PACK      KEY28,SESSKEYS,SP70
          CALL      RDSBOKA1
COPY5000  CALL      RDKBOKA1                * next read on details file
          BRANCH    OVRCD,COPY9999          * end of session
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT
          MATCH     SESSKEYS,KEY25
          GOTO      COPY9999 IF NOT EQUAL   * different session
.
          PACK      SAVKEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
.
          MOVE      CPTODATE,OBADATE
          MOVE      ZEROUR,OBAURNO
          MOVE      ZEROVISN,OBAOUTNO
          MOVE      ZERO,OBASTAT
          MOVE      SP70,OBAFINST
          MOVE      SP70,OBALOCK
          MOVE      ZERO,OBAPXRAY
          MOVE      SP70,OBABKDTE
          MOVE      ZERO,OBAPULL
          MOVE      SP70,OBASESST
          MOVE      SP70,OBADISCH
          MOVE      ZERO,OTBARESV
          MOVE      SP70,OBASPARA
.
          PACK      KEY28,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
          CALL      RDABOKA1
          IF        OVRCD=1
            CALL      WRBOKA1
          ENDIF
.
          PACK      KEY28,SAVKEY28
          CALL      RDBOKA1
          
          GOTO      COPY5000
.
COPY9999  RETURN
.
.------------------------------------------------------------
. Create followup appointment    
.------------------------------------------------------------
BFOL0000  MOVE      CASEKEYS,KEY28
          CALL      RLOTBOA1
          BRANCH    OVRCD,BFOL9500,BFOL9300
.
          MOVE      OBAURNO,URNUMBER
          MOVE      OBAOUTNO,ADMISSNO
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,BFOL9600
.         
          MOVE      OBALADMN,LINKOUTN
.         
          MOVE      OBAOUTNO,KEY8
          CALL      RDOTXSC1
          IF        OVRCD=1
            CALL      CLOUTXSC         * Clear File fileds
          ENDIF
.
          MATCH     SP70,NEWSLOTK
          GOTO      BFOL9800 IF EQUAL
.
.         The following save varaibles are used by EOCACC00 procedure
.
          MOVE      OBAOUTNO,SAVADMNO     * Save original admission number
          MOVE      OBACOMP,SAVBCOMP      * Save original claim code
.
          MOVE      ONE,OTBBFLUP          * Follow Up Appointment Made
          CALL      UPBOKB1
          MOVE      SP70,OTBBFLUP
.
          MOVE      OBAURNO,URNUMBER
          CALL      RFOL0000              * Re-appoint for bulk follow up
          BRANCH    EXIT,BFOL9999
.
.         Get claim details of the original admission no and copy to the new
.         appointment outpatient number
.
          CALL      GCLM0000              * Write claim details
          CALL      EOCACC00
.
BFOL7900  CALL      BOKUPD00
          BRANCH    EXIT,BFOL9500,BFOL9600
.
BFOL8200  CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      ONE,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICON    * DG API O/P New Appoint.
.
          MOVE      CASEKEYS,KEY28
          CALL      UUOTBOA1
          CALL      UUOTBOB1
.
          MOVE      ZERO,EXIT
          GOTO      BFOL9999
.
BFOL9300  MOVE      "Booking Record Locked",NEWMESSG
          CALL      UUOTBOB1
          CALL      UUOTBOA1
          MOVE      ZERO,EXIT
          GOTO      BFOL9999
.
BFOL9500  MOVE      "Invalid Appointment",NEWMESSG
          CALL      UUOTBOB1
          CALL      UUOTBOA1
          MOVE      ZERO,EXIT
          GOTO      BFOL9999
.
BFOL9600  MOVE      "Invalid Booking Status",NEWMESSG
          CALL      UUOTBOB1
          CALL      UUOTBOA1
          MOVE      ZERO,EXIT
          GOTO      BFOL9999
.
BFOL9800  MOVE      "New Slot Key is Reserved",NEWMESSG
          CALL      UUOTBOB1
          CALL      UUOTBOA1
          MOVE      ZERO,EXIT
          GOTO      BFOL9999
.
BFOL9999  RETURN
.
.
.*******************************************************************************
.            RFOL0000: Generate and post a new outpatient number for
.                      bulk followup
.*******************************************************************************
RFOL0000  COMMIT
          BEGIN
.
          READ      CONTROLF,HUND30;*75,PTCNUANV      * Using AN Visit Numbers
.
          MATCH     "1",PTCNUANV
          IF        @EQUAL
            CALL      GANV0000                * Get next AN visit number
            MOVE      PTCNNXTV,OPROUTN
          ELSE
            MOVE      " 10",PRXCODE
            CALL      GETSLK00
            READ      CONTROLF,TEN;*1,FORM8V  * Get the next Outpatient number
            ADD       ONE,FORM8V              * Increment next Outpatient No.
            WRITAB    CONTROLF,TEN;*1,FORM8V  * Post new outpatient no
            SUB       ONE,FORM8V              * Go back to original O/P Number
            MOVE      FORM8V,OPROUTN 
            CALL      RELSLK00
          ENDIF
.
          COMMIT
          BEGIN
.
RFOL0500  PACK      KEY8,OPROUTN             * Key for visit file
          CALL      RDVISA1                  * Check if visit record exists
          COMPARE   ZERO,OVRCD               * Does this record exist ?
          GOTO      RFOL0000 IF EQUAL        * Yes. Try again
.
          PACK      KEY8,OPROUTN             * Key for pre-attendance file
          CALL      RDPREA1                  * Check if record already exists
          COMPARE   ZERO,OVRCD               * Does this record exist ?
          GOTO      RFOL0000 IF EQUAL        * Yes. Try again
.
          PACK      KEY8,OPROUTN             * Key for bokb file
          CALL      RDABOKB1
          COMPARE   ZERO,OVRCD               * Does this record exist ?
          GOTO      RFOL0000 IF EQUAL        * Yes. Try again
.
.         We have a valid outpatient number. Post the Boka data
.
RFOL0700  PACK      KEY28,NEWSLOTK,SP70      * Key for selected booking
          CALL      RDBOKA1                  * Read in the booking record
          BRANCH    OVRCD,RFOL9020
.
.         Update this record with the booking data
.
          COMPARE   ZERO,OBASTAT             * Make sure record isn't booked
          GOTO      RFOL1000 IF EQUAL
.
RFOL1000  MOVE      OPROUTN,OBAOUTNO         * Outpatient number
          MOVE      URNUMBER,OBAURNO         * U/R Number
          MOVE      ONE,OBASTAT              * Status = Booked
          MOVE      ZERO,OBAPULL             * Clear pulling list flag
          CLOCK     TIME,CTIMEIS             * Get the current time
          PACK      OBABKDTE,CCC,CYY,CMM,CDD,CTIMEIS
          REP       " 0",OBABKDTE            * Zero-fill booking date/time
          CALL      UPBOKA1
.
          PACK      SESSKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      ADDBOK00                 * Increment Booking Count
.
          CALL      PPRE0000                 * Updating the pre-attend file data
.
          MOVE      ZERO,REVWFLAG
          CALL      REVD0000                 * Update waiting list review date
.
          PACK      KEY8,OBAOUTNO,SP70       * Key for bokb file
          CALL      RDABOKB1                 * Write the bokb record
          IF        OVRCD=1
            MOVE      LINKOUTN,OBALADMN
            MOVE      OBACTYP,OBBCTYP        * Store Clinic Type (SRF 103335)
            MOVE      SP10,OTBBADCS
            MOVE      SP10,OTBBCITM
            MOVE      SP10,OTBBASTM
            MOVE      SP10,OTBBDPTM
            MOVE      SP10,OTBBOUTC
            MOVE      SP70,OTBBCIND          * Clear before write
            MOVE      SP70,OTBBHCP1
            MOVE      SP70,OTBBHCP2
            MOVE      SP70,OTBBHCP3
            MOVE      SP70,OTBBHCP4
            CALL      WRBOKB1
            CALL      WRCPAT00           * write to current patient file
            CALL      PRAD0000           * write to person responsible file
          ENDIF
.
          CALL      WRAP0000
.
          CALL      WRTR0000             * write to transport file
.
          MATCH     OLDVTYP,NEWVTYP
          GOTO      RFOL8900 IF EQUAL
.
          CALL      EXTSLT00
          GOTO      RFOL8900
.
RFOL8900  PACK      KEY28,NEWSLOTK,SP70      * Key for selected booking
          CALL      RDBOKA1                  * Read in the booking record
          MOVE      ZERO,EXIT
          GOTO      RFOL9999                * Finished posting data
.
.         Booking record has the wrong status
.
RFOL9010  MOVE      "Invalid Booking Status",NEWMESSG
          MOVE      ZERO,EXIT
          GOTO      RFOL9999
.
RFOL9020  MOVE      "Invalid Slot Key",NEWMESSG
          MOVE      ZERO,EXIT
          GOTO      RFOL9999
.
RFOL9999  COMMIT
          BEGIN
          RETURN
.
.------------------------------------------------------------
. Extend Slots
.  Input - NEWVTYP New Visit Type            
.          OLDVTYP old Visit Type
.          NEWSLOTK - Slot Key
.------------------------------------------------------------
EXTSLT00  MOVE      NEWVTYP,CODE
          CALL      GETSCT00   * Get Slot Count
          MOVE      CNTSLOTS,NEWSLOTS
.
          MOVE      OLDVTYP,CODE
          CALL      GETSCT00   * Get Slot Count
          MOVE      CNTSLOTS,OLDSLOTS        
.           
          PACK      KEY28,NEWSLOTK,SP70      * Key for selected booking
          CALL      RDBOKA1                  * Read in the booking record
          MOVE      NEWVTYP,OBAVISIT         * Update to New Visit Type
          CALL      UPBOKA1
          SUB       ONE,OLDSLOTS
          SUB       ONE,NEWSLOTS
.
          MOVE      OBASLOT,PARNSLOT         * Set Parent Slot
.
EXTSLT10  CALL      RDKBOKA1                 * Check the next record
          BRANCH    OVRCD,EXTSLT90           * Finished
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT
          MATCH     KEY25,NEWSLOTK         * Correct session ?
          GOTO      EXTSLT90 IF NOT EQUAL    * No. Finished
          COMPARE   ZERO,NEWSLOTS
          GOTO      EXTSLT30 IF EQUAL
.
          MATCH     OLDVTYP,OBAVISIT
          IF        !@EQUAL
            MOVE      OBAVISIT,CODE          * Check Slot is not Extended
            CALL      GETSCT00               * Get Slot Count
            COMPARE   ONE,CNTSLOTS           * Exit if This Slot Extended
            GOTO      EXTSLT90 IF NOT EQUAL
          ENDIF
.
          MATCH     ANSU,TCINDC6
          GOTO      EXTSLT90 IF EQUAL        * Ignore unavailable slots
.
          MATCH     ANSZ,TCINDC2
          GOTO      EXTSLT90 IF EQUAL        * Ignore over bookings slots
.
          MATCH     ZEROVISN,OBAOUTNO        * Outpatient number
          GOTO      EXTSLT90 IF NOT EQUAL    * Exit if Slot has Booking
.
          SUB       ONE,OLDSLOTS
          SUB       ONE,NEWSLOTS
          MOVE      THREE,OBASTAT            * Update as Extended Slot
          MOVE      NEWVTYP,OBAVISIT
          MOVE      PARNSLOT,OBAEXSL
          CALL      UPBOKA1
          GOTO      EXTSLT10
.
EXTSLT20  CALL      RDKBOKA1     * Read Next Slot
          BRANCH    OVRCD,EXTSLT90
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT
          MATCH     KEY25,NEWSLOTK          * Correct session ?
          GOTO      EXTSLT90 IF NOT EQUAL   * No. Finished
.
EXTSLT30  COMPARE   PARNSLOT,OBAEXSL
          GOTO      EXTSLT90 IF NOT EQUAL
.
          SUB       ONE,OLDSLOTS
          MOVE      ZEROVISN,OBAOUTNO       * Outpatient number
          MOVE      ZEROUR,OBAURNO          * Outpatient number
          MOVE      "R  ",OBAVISIT
          MOVE      ZERO,OBAEXSL            * Update as Not Extended
          MOVE      ZERO,OBASTAT            * Update as Not Extended
          CALL      UPBOKA1
          GOTO      EXTSLT20
.
EXTSLT90  PACK      KEY28,NEWSLOTK,SP70      * Key for selected booking
          CALL      RDBOKA1                  * Read in the booking record
          RETURN
.
.---------------------------------------------------
. Increment Booking Count on Session
.---------------------------------------------------
ADDBOK00  MOVE      ZERO,LOCKCNT
          PACK      KEY5,ANSC,ANSV,OBAVISIT
          CALL      RDCODE1
          BRANCH    OVRCD,ADDBOK98
          IF        TCFORM6=0
            MOVE      ONE,TCFORM6
          ENDIF
.
ADDBOK10  PACK      KEY25,SESSKEYS,SP70
          CALL      RLOTSES1
          BRANCH    OVRCD,ADDBOK98,ADDBOK90
          ADD       TCFORM6,OSESLOTB
          MATCH     ANSN,TCINDC1
          IF        @EQUAL
            ADD       ONE,OSEBNEW
          ENDIF
          MATCH     ANSR,TCINDC1
          IF        @EQUAL
            ADD       ONE,OSEBRV
          ENDIF
          MATCH     ANSS,TCINDC1
          IF        @EQUAL
            ADD       ONE,OSEBSPC
          ENDIF
          CALL      RDSLT000
          CALL      ADDTIM00
          CALL      UPSESA1
          CALL      UUOTSES1
          MOVE      ZERO,EXIT
          GOTO      ADDBOK99
ADDBOK90  DISPLAY   *W
          ADD       ONE,LOCKCNT
          IF        LOCKCNT<5
            GOTO      ADDBOK10
          ENDIF
ADDBOK98  MOVE      ONE,EXIT
ADDBOK99  RETURN
.
.------------------------------------------------------------
. Get claim details from the original visit
.------------------------------------------------------------
GCLM0000  CALL      CLRCLM00
          MATCH     SP3,SAVBCOMP
          GOTO      GCLM9999 IF EQUAL       * no claim code
.
.         Set the claim type indicator if this is a claim
.
          PACK      KEY5 WITH ANSC,ANSL,SAVBCOMP
          CALL      RDCODE1
          BRANCH    OVRCD OF GCLM9999
.
.         Check the indicators for a W, M, or V (these are the claims)
.
          MOVE      ZERO,FORM2
GCLM3000  ADD       ONE,FORM2
          COMPARE   SIX,FORM2
          GOTO      GCLM9999 IF NOT LESS
.
          LOAD      ANS USING FORM2 OF TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
          CMATCH    "W",ANS
          GOTO      GCLM4000 IF EQUAL
          CMATCH    "M",ANS
          GOTO      GCLM5000 IF EQUAL
          CMATCH    "V",ANS
          GOTO      GCLM6000 IF EQUAL
          GOTO      GCLM3000
.
GCLM4000  MOVE      SAVADMNO,KEY8
          CALL      RDWCOM1            * read previous Workers Comp details
          IF        OVRCD=0
            MOVE      OBAOUTNO,KEY8
            MOVE      OBAOUTNO,WCADMNO
            MOVE      OBADATE,PTWCVDAT
            CALL      RDAWCOM1
            IF        OVRCD=1
              CALL      WRWCOM1
.
.             If we are sending ACC details in PV1-20, then we need to
.             trigger an A08 message for the visit to reflect that this is
.             now an ACC patient
.
              MATCH     "1",PTCNH7AC
              IF        @EQUAL
                CALL      PMIGTNID             * get national id for dgate write
                MOVE      NMPNUMB,PTNINMPI
                MOVE      TWO,HL7TRGID
                MOVE      SP8,HL7INCLD
                PROC      DGCLICOB               * send update O/P details
              ENDIF
            ENDIF
          ENDIF
          MOVE      SAVADMNO,KEY8
          CALL      RDPMWX11           * read ext.workers comp file(prev adm)
          IF        OVRCD=0
            MOVE      OBAOUTNO,KEY8
            MOVE      OBAOUTNO,PMWXVISN
            CALL      RAPMWX11
            IF        OVRCD=1
              CALL      WRPMWX11
            ENDIF
          ENDIF
          GOTO      GCLM9999
.
GCLM5000  MOVE      SAVADMNO,KEY8
          CALL      RDWMAB1            * read previous TAC details
          IF        OVRCD=0
            MOVE      OBAOUTNO,KEY8
            MOVE      OBAOUTNO,MADMNO
            MOVE      OBADATE,PTWMVDAT
            CALL      RDAWMAB1
            IF        OVRCD=1
              CALL      WRWMAB1
            ENDIF
          ENDIF
          GOTO      GCLM9999
.
GCLM6000  MOVE      SAVADMNO,KEY8
          CALL      RDWVET1
          IF        OVRCD=0
            MOVE      OBAOUTNO,KEY8
            CALL      RDAWVET1
            IF        OVRCD=1
              CALL      WRWVET1
            ENDIF
          ENDIF
.
GCLM9999  RETURN
.
.
.*****************************************************************************
.*  EOCACC00  - Link the Follow-Up Appointment with the Episodes of Care
.*              Accident Data. The link is performed only when the following
.*              conditions are met:
.*              1. Control flag for Using Epsiodes of care is set (PTCNUEOC)
.*              2. The original Appointment has an ACC (Accident) claim code
.*              3. The original Appointment is linked to an Episode of Care
.*              If these conditions are met then the Follow-Up Appointment is
.*              linked to the same EOC as the original Appointment.
.*****************************************************************************
EOCACC00  COMPARE   ONE,PTCNUEOC            * Using Episodes Of Care?
          GOTO      EOCACC99 IF NOT EQUAL   * No, return
.
          MOVE      "CL",CATEGORY           * Check Claim Code of orig App
          MOVE      SAVBCOMP,CODE
          CALL      GETCOD00
          MATCH     ANSA,TCINDC3            * Is it an ACC Appointment?
          GOTO      EOCACC99 IF NOT EQUAL   * No, return
.
          PACK      KEY10,CHOSPNUM,SAVADMNO,SP70
          CALL      RDECLNK2
          BRANCH    OVRCD,EOCACC99          * Orig App not linked to EOC
.
          MOVE      OBAOUTNO,ECLNVISI
          PACK      KEY10,CHOSPNUM,OBAOUTNO,SP70
          CALL      RAECLNK2
          IF        OVRCD=1
            CALL      WRECLNK2              * Link Follow-Up App with EOC
          ENDIF
.
EOCACC99  RETURN
.
.------------------------------------------------------------
. Update Booking
.------------------------------------------------------------
BOKUPD00  MOVE      SP70,OLDADCS
          MATCH     SP70,NEWSLOTK
          IF        !@EQUAL
            MOVE      NEWSLOTK,CASEKEYS
            MOVE      CASEKEYS,KEY28
            CALL      RDBOKA1
          ENDIF
.
          PACK      CASEKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,DOBASLOT,SP70
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDPMVX11
          IF        OVRCD=1
            CALL      CLPMSVX1
            MOVE      OBAOUTNO,PMVXVISN 
            MOVE      SP70,PMVXWEBC
            PACK      PMVXCDTE,CCC,CYY,CMM,CDD
            REP       " 0",PMVXCDTE
            CLOCK     TIME,PMVXCTIM
            MOVE      PPOST,PMVXPOST
.
            IF        IBCNMHOS=1
              MOVE      OTHEHOSP,PMVXMHOS
            ENDIF
.
            CALL      GTASGC00                 * get SLA/ASGC code
            MOVE      SP70,PMVXPOEC
            MOVE      SP70,PMVXPGID
            MOVE      SP70,PMVXPILC
            MOVE      SAVUDF1,PMVXUDF1
            MOVE      SAVINTR,PMVXINTR
            CALL      WRPMVX11
          ENDIF
.
          CALL      INTUPD00                 * Interpreter Table Processing
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDDIAG1
          IF        OVRCD=1
            MOVE      OBAOUTNO,OPDIOUTN
            MOVE      SAVICODE,OPDICODE
            MOVE      SAVIDESC,OPDIDESC
            MOVE      SAVICOD2,OPDICOD2
            MOVE      SAVIDES2,OPDIDES2
            MOVE      SAVICOD3,OPDICOD3
            MOVE      SAVIDES3,OPDIDES3
            MOVE      SAVICOD4,OPDICOD4
            MOVE      SAVIDES4,OPDIDES4
            MOVE      SAVICOD5,OPDICOD5
            MOVE      SAVIDES5,OPDIDES5
            CALL      WRDIAG1
          ENDIF
.
          MATCH     SP70,SAVOUTNO
          IF        !@EQUAL & !@EOS
            CALL      CPCMDT00            * copy appointment comments
          ENDIF
.
BOKUPD90  PACK      KEY8,OBAOUTNO,SP70
          CALL      RAOTXSC1
          IF        OVRCD=1
            MOVE      OBAOUTNO,OTXSOUTN
            MOVE      SVXSDTE1,OTXSDTE1
            MOVE      SVXSDTE2,OTXSDTE2
            MOVE      SVXSDTE3,OTXSDTE3
            MOVE      SVXSDTE4,OTXSDTE4
            MOVE      SVXSDTE5,OTXSDTE5
            MOVE      SVXSDTE6,OTXSDTE6
            MOVE      SVXSCO01,OTXSCO01
            MOVE      SVXSCO02,OTXSCO02
            MOVE      SVXSCO03,OTXSCO03
            MOVE      SVXSCO04,OTXSCO04
            MOVE      SVXSCO05,OTXSCO05
            MOVE      SVXSCO06,OTXSCO06
            MOVE      SVXSCO07,OTXSCO07
            MOVE      SVXSCO08,OTXSCO08
            MOVE      SVXSCO09,OTXSCO09
            MOVE      SVXSCO10,OTXSCO10
            MOVE      SVXSCO11,OTXSCO11
            MOVE      SVXSCO12,OTXSCO12
            MOVE      SVXSCO13,OTXSCO13
            MOVE      SVXSCO14,OTXSCO14
            MOVE      SVXSCO15,OTXSCO15
            MOVE      SVXSCO16,OTXSCO16
            MOVE      SVXSCO17,OTXSCO17
            MOVE      SVXSCO18,OTXSCO18
            MOVE      SVXSCO19,OTXSCO19
            MOVE      SVXSCO20,OTXSCO20
            MOVE      SVXSDOC1,OTXSDOC1
            MOVE      SVXSDOC2,OTXSDOC2
            MOVE      SVXSDOC3,OTXSDOC3
            MOVE      SVXSAMT1,OTXSAMT1
            MOVE      SVXSAMT2,OTXSAMT2
            MOVE      SVXSDSC1,OTXSDSC1
            MOVE      SVXSDSC2,OTXSDSC2
            MOVE      SVXSDSC3,OTXSDSC3
            MOVE      SVXSDSC4,OTXSDSC4
            MOVE      SVXSDSC5,OTXSDSC5
            MOVE      SVXSDSC6,OTXSDSC6
            MOVE      SVXSTIM1,OTXSTIM1
            MOVE      SVXSTIM2,OTXSTIM2
            MOVE      SVXSTIM3,OTXSTIM3
            MOVE      SVXSTIM4,OTXSTIM4
            MOVE      SVXSTIM5,OTXSTIM5
            MOVE      SVXSTIM6,OTXSTIM6
            MOVE      SP70,OTXSSPAR 
            CALL      WROTXSC1
          ENDIF
.
          MOVE      ZERO,EXIT
BOKUPD99  RETURN
.
.----------------------------------------------------------------------
. Copy appointment comments
.----------------------------------------------------------------------
CPCMDT00  PACK      KEY17,SAVOUTNO,VSCMTTYP,SP70      * Key for start of comment
CPCMDT20  CALL      RSVSMDT1
          CALL      RKVSMDT1
          BRANCH    OVRCD,CPCMDT99
.
          MATCH     SAVOUTNO,VSMDVISN
          GOTO      CPCMDT99 IF NOT EQUAL
.
          MATCH     VSCMTTYP,VSMDTYPE
          GOTO      CPCMDT99 IF NOT EQUAL
.
          PACK      SAVKEY17,VSMDVISN,VSMDTYPE,VSMDNOTE
.
          MATCH     "1",VSMDDELT          * is comment deleted
          IF        @EQUAL
            MOVE      SAVKEY17,KEY17
            GOTO      CPCMDT20
          ENDIF
.
. Read the copy to comment, skips if it already exists
.
          MOVE      OBAOUTNO,VSMDVISN 
          PACK      KEY17,VSMDVISN,VSMDTYPE,VSMDNOTE
          CALL      RAVSMDT1
          IF        OVRCD = 0
            MOVE      SAVKEY17,KEY17
            GOTO      CPCMDT20
          ENDIF
.
          CALL      WRVSMDT1
          CALL      CPCMTX00
.
          MOVE      SAVKEY17,KEY17
          GOTO      CPCMDT20
.
CPCMDT99  RETURN          
.            
.----------------------------------------------------------------------
. Copy appointment comments text
.----------------------------------------------------------------------
CPCMTX00  PACK      KEY20,SAVOUTNO,VSMDTYPE,VSMDNOTE,SP70
CPCMTX20  CALL      RSVSMTX1
          CALL      RKVSMTX1
          BRANCH    OVRCD,CPCMTX99
.
          MATCH     SAVOUTNO,VSMTVISN
          GOTO      CPCMTX99 IF NOT EQUAL
.
          MATCH     VSMDTYPE,VSMTTYPE
          GOTO      CPCMTX99 IF NOT EQUAL
.
          MATCH     VSMDNOTE,VSMTNOTE
          GOTO      CPCMTX99 IF NOT EQUAL
.
          PACK      SAVKEY20,VSMTVISN,VSMTTYPE,VSMTNOTE,VSMTUNIQ
.
          MOVE      OBAOUTNO,VSMTVISN 
          PACK      KEY20,VSMTVISN,VSMTTYPE,VSMTNOTE,VSMTUNIQ
          CALL      WRVSMTX1
.
          MOVE      SAVKEY20,KEY20
          GOTO      CPCMTX20
.
CPCMTX99  RETURN
.
.------------------------------------------------------------
. Get SLA/ASGC code from ibapostf
.------------------------------------------------------------
GTASGC00  MOVE      PPOST,D8
          SQUEEZE   D8
          MOVE      D8,F4
          MOVE      F4,D4
          REP       " 0",D4
          PACK      PPOST,D4,SP10
          PACK      KEY56,PPOST,PSUBRB,SP10,PADD4,SP70                *C-240184
          CALL      RDIBPOS1
          IF        OVRCD=0
            MOVE      IBPOASGC,PMVXASGC
          ELSE                                                        *I-240184
            MOVE      SP10,PMVXASGC
            PACK      KEY56,PPOST,PSUBRB,SP70
            CALL      RSIBPOS1
            CALL      RKIBPOS1
            BRANCH    OVRCD,GTASGC99
            MATCH     PPOST,IBPOPCOD
            IF        @EQUAL
              MATCH     PSUBRB,IBPOSUBR
              IF        @EQUAL
                MOVE      IBPOASGC,PMVXASGC
              ENDIF
            ENDIF
          ENDIF                                                 * end *I-240184
.
GTASGC99  RETURN
.
.------------------------------------------------------------
. Print change of clinic heading
.------------------------------------------------------------
PHED0000  MATCH     SAVECLIN,OSECLIN
          GOTO      PHED1000 IF NOT EQUAL
.
          MATCH     SAVEDATE,OSEDATE
          GOTO      PHED1000 IF NOT EQUAL
.
          MATCH     SAVESTRT,OSESTRT
          GOTO      PHED1000 IF NOT EQUAL
.
          GOTO      PHED9999 
.
PHED1000  MOVE      OSECLIN,SAVECLIN
          MOVE      OSEDATE,SAVEDATE
          MOVE      OSESTRT,SAVESTRT
.
          COMPARE   "48",CLNO
          CALL      HEAD0000 IF NOT LESS
.
.         Read copy from clinic details
.
          PACK      KEY25,SESSKEYS,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,PHED1200
.
          PACK      KEY20,OSESITE,OSECLIN,OSEDATE,SP70
          CALL      RDCLIA1
          IF        OVRCD=1
            PACK      KEY20,OSESITE,OSECLIN,OSEDATE,Z70
            CALL      RDSCLIA1          * Read Clinic Record
            CALL      RDPCLIA1          * Read Clinic Record
            BRANCH    OVRCD,PHED1200
.
            MATCH     OSESITE,OCASITE
            GOTO      PHED1200 IF NOT EQUAL
.
            MATCH     OSECLIN,OCACLIN
            GOTO      PHED1200 IF NOT EQUAL
          ENDIF
          MOVE      OCADESC,SAVCDESC
.
          PACK      KEY12,OSESITE,OSESCTYP,SP70
          CALL      RDCTYA1
          BRANCH    OVRCD,PHED1200
.
          MOVE      OSESCTYP,SAVECTYP
          MOVE      OCTDESC,SAVCTDES
.
          UNPACK    OSEDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          MOVE      CPCDATE,DISPDATE         * formatted start date
.
.         Read copy to clinic details
.
PHED1200  MATCH     SP70,NEWSKEYS
          GOTO      PHED1250 IF EQUAL
.
          PACK      KEY25,NEWSKEYS,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,PHED1250
.
          PACK      KEY20,OSESITE,OSECLIN,OSEDATE,SP70
          CALL      RDCLIA1
          IF        OVRCD=1
            PACK      KEY20,OSESITE,OSECLIN,OSEDATE,Z70
            CALL      RDSCLIA1          * Read Clinic Record
            CALL      RDPCLIA1          * Read Clinic Record
            BRANCH    OVRCD,PHED1250
.
            MATCH     OSESITE,OCASITE
            GOTO      PHED1250 IF NOT EQUAL
.
            MATCH     OSECLIN,OCACLIN
            GOTO      PHED1250 IF NOT EQUAL
          ENDIF
.
          PACK      KEY12,OSESITE,OSESCTYP,SP70
          CALL      RDCTYA1
          BRANCH    OVRCD,PHED1250
.
          UNPACK    OSEDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          MOVE      CPCDATE,DISPDAT1         * formatted start date
.
          GOTO      PHED1300
.
PHED1250  MOVE     "No Clinic Available",OSECLIN
          MOVE     SP70,OCADESC
          MOVE     SP70,OSESCTYP
          MOVE     SP70,OCTDESC
          MOVE     SP70,OSESTRT 
          MOVE     SP70,DISPDAT1
.
PHED1300  CALL      UND132                         * print line
.
          PRINT     *1,"| Clinic From : ",SAVECLIN,*28,SAVCDESC;
.
          PRINT     *65,"| Clinic To : ",OSECLIN,*90,OCADESC,*132,"|"
.
          PRINT     *1,"| Type        : ",SAVECTYP,*28,SAVCTDES;

          PRINT     *65,"| Type      : ",OSESCTYP,*90,OCTDESC,*132,"|"
.
          PRINT     *1,"| Date        : ",DISPDATE,*28,"Start Time : ":
                    SAVESTRT;
.
          PRINT     *65,"| Date      : ",DISPDAT1,*90,"Start Time : ",OSESTRT:
                    *132,"|"
.
          ADD       THREE,CLNO                      * increment line count
.
          CALL      UND132                         * print line
.
          PRINT     *1,"|Slot",*6,"|Time",*12,"|Visit":
                    *18,"| U/R No.",*28,"| Patients Name":
                   *65,"|Slot",*70,"|Time",*76,"|Visit",*82,"| Message",*132,"|"
.
          ADD       ONE,CLNO                      * increment line count
          CALL      UND132                         * print line
.
PHED9999  RETURN
.
.------------------------------------------------------------
. Print appointment details
.------------------------------------------------------------
PAPP0000  COMPARE   "48",CLNO
          IF        !@LESS
            CALL      PHED0000
          ENDIF
.
.         Read copy from clinic details
.
PAPP2000  MOVE      PSNAME,PACSNAME
          MOVE      PGNAME,PACGNAME
          MOVE      SP4,PACTITLE
          MOVE      ONE,PACFRMT
          CALL      PACNAME
          MOVE      PACFNAME,PACFNAM
.
          PRINT     *1,"|",SAVSLOT,*6,"|",SAVTIME,*12,"| ",SAVVISIT:
                    *18,"|",URNUMBER,*28,"| ",PACFNAM:
                    *65,"| ",NEWSLOTN,*70,"|",NEWSLOTM:
                     *76,"| ",NEWSTYPE,*82,"| ",NEWMESSG,*132,"|"
.
PAPP9999  RETURN
.
.------------------------------------------------------------
. Check for Master Suspension
.------------------------------------------------------------
CHKSUS00  MOVE      ZERO,EXIT
.
          PACK      KEY24,OSESITE,OSECLIN,OSEDAY,Z70
          CALL      RSOTMSP1
CHKSUS10  CALL      RPOTMSP1
          BRANCH    OVRCD,CHKSUS99
.
          MATCH     OSESITE,OTMSSITE
          GOTO      CHKSUS99 IF NOT EQUAL
.
          MATCH     OSECLIN,OTMSCLIN
          GOTO      CHKSUS99 IF NOT EQUAL
.
          MOVE      OSEDAY,KEY1
          MATCH     KEY1,OTMSDOWK
          GOTO      CHKSUS99 IF NOT EQUAL
.
          MATCH     OSESTRT,OTMSSTIM             * Same session start time
          GOTO      CHKSUS10 IF NOT EQUAL
.
          MATCH     OTMSFDAT,OSEDATE
          GOTO      CHKSUS10 IF LESS
          GOTO      CHKSUS20 IF EQUAL
.
          MATCH     OSEDATE,OTMSTDAT
          GOTO      CHKSUS10 IF LESS
.
CHKSUS20  MOVE      ONE,EXIT
.
CHKSUS99  RETURN
.
.---------------------------------------------------------------------
.         print a new page heading
.---------------------------------------------------------------------
HEAD0000  CALL      HEAD132
.
          UNPACK    CPFRDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          MOVE      CPCDATE,PRFRDATE         * formatted start date
.
          UNPACK    CPTODATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          MOVE      CPCDATE,PRTODATE         * formatted start date
.
          IF        OPTION=1
            PRINT     *30,"From : ",PRFRDATE," to ",PRTODATE
          ELSE
            PRINT     *30,"From Week: ",PRFRDATE," to ",PRTODATE
          ENDIF
          ADD       ONE,CLNO
.
          PRINT     *30,"Clinic : ",CLINICDS
          ADD       ONE,CLNO
.
          IF        WRITEBOK=1
            PRINT     *30,"Create Bookings : Yes"
          ELSE
            PRINT     *30,"Create Bookings : No"
          ENDIF
          ADD       ONE,CLNO
.
          IF        IBCNMHOS=1
            PRINT     *30,"Hospital : ",HOSPNAME
            ADD       ONE,CLNO
          ENDIF
.
HEAD9999  RETURN
.
.**********************************************************************
.*                         END0000                                    *
.*                      End of Report                                 *
.**********************************************************************
ENDD0000  COMPARE   ZERO,CPAGENO
          GOTO      ENDD2000 IF NOT EQUAL
.
.         No data selected
.
          PRINT     *N,*40,"  ***  No Records Selected  ***"
          DISPLAY   *P1:23,*EL,*P1:24,*EL,*V2LON:
                    "** No Records Selected ** ";
          GOTO      ENDD9999
.
ENDD2000  CALL      UND132
          PRINT     *1,"| Total Bookings                  : ",TOTLBOOK,*132,"|"
          PRINT     *1,"| Total Booking Errors            : ",TOTLERRB,*132,"|"
          PRINT     *1,"| Total Booking Status Errors     : ",TOTLERRS,*132,"|"
          PRINT     *1,"| Total Booking Visit Type Errors : ",TOTLERRV,*132,"|"
          CALL      UND132
.
          PRINT     *N,*40,"  ***  END OF REPORT  ***"
          DISPLAY   *P1:23,*EL,*P1:24,*EL,*V2LON:
                    "** Report Generation Completed ** ";
.
          GOTO      ENDD9999
.
ENDD9999  RETURN
.
.---------------------------------------------------------------------
. Validate New Slot key and slot status
.---------------------------------------------------------------------
NEWS0000  MOVE      SP70,NEWSLOTN
          MOVE      SP70,NEWSLOTM
          MOVE      SP70,NEWSTYPE
          MOVE      SP70,NEWMESSG
.
          PACK      KEY28,NEWSLOTK,SP70      * Key for selected booking
          CALL      RDBOKA1                  * Read in the booking record
          BRANCH    OVRCD,NEWS9000
.
          MOVE      OBASLOT,NEWSLOTN
          MOVE      OBATIME,NEWSLOTM
          MOVE      OBAVISIT,NEWSTYPE
          MOVE      OBAVISIT,NEWVTYP
.
          COMPARE   ZERO,OBASTAT             * Make sure record isn't booked
          GOTO      NEWS9100 IF NOT EQUAL    * Record isn't vacant !!
.
          MATCH     SAVVISIT,OBAVISIT
          GOTO      NEWS9200 IF NOT EQUAL
.
NEWS8000  MOVE      SP70,NEWMESSG 
          GOTO      NEWS9999
.
NEWS9000  MOVE      "Invalid Booking",NEWMESSG
          ADD       ONE,TOTLERRB
          MOVE      SP70,NEWSLOTK
          GOTO      NEWS9999
.
NEWS9100  MOVE      "Invalid Booking Status",NEWMESSG
          ADD       ONE,TOTLERRS
          MOVE      SP70,NEWSLOTK
          GOTO      NEWS9999
.
NEWS9200  MOVE      "Invalid Booking Visit Type",NEWMESSG
          ADD       ONE,TOTLERRV
          MOVE      SP70,NEWSLOTK
          GOTO      NEWS9999
.
NEWS9999  RETURN
.
.------------------------------------------------------------
. Get Code Description
.------------------------------------------------------------
GETCOD00  MOVE      SP70,TDESC
          MOVE      SP70,ACODE
          UNPACK    SP70,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5:
                                TCINDC6,TCINDC7,TCINDC8,TCINDC9,TCINDC10:
                                TCINDC11
          MATCH     SP70,CODE
          GOTO      GETCOD99 IF EQUAL
.
          PACK      KEY5,CATEGORY,CODE
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      SP70,ACODE
            MOVE      SP70,TDESC
            UNPACK    SP70,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5:
                           TCINDC6,TCINDC7,TCINDC8,TCINDC9,TCINDC10:
                           TCINDC11
          ENDIF
.
GETCOD99  RETURN
.
.*******************************************************************************
. Update Interpreter Table
. Input  - OBAURNO
.        - OBAOUTNO
.        - CASEKEYS - for New Booking
.*******************************************************************************
INTUPD00  PACK      KEY8,OBAURNO,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,INTUPD99
.
          MATCH     "1",OTCNINTR            * Using visit based interpreter req
          IF        @EQUAL
            MATCH     "1",PMVXINTR
            GOTO      INTUPD10 IF EQUAL   
            GOTO      INTUPD99
          ENDIF
.
          MATCH     "1",PMPXINTR
          GOTO      INTUPD99 IF NOT EQUAL
.
INTUPD10  CALL      CLVISINT
          MOVE      ZERO,DATACHNG    
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDVSINT1
          BRANCH    OVRCD,INTUPD50          * new record - DATACHNG=0
.
          MOVE      ONE,DATACHNG
.                                           * has data changed?
          MATCH     OBADATE,VSINDATE
          GOTO      INTUPD50 IF NOT EQUAL
          MATCH     OBATIME,VSINTIME
          GOTO      INTUPD50 IF NOT EQUAL
          MATCH     CASEKEYS,VSINSUBK
          GOTO      INTUPD50 IF NOT EQUAL
.
          MOVE      ZERO,DATACHNG           * no data changed - end it all
          GOTO      INTUPD99
.
INTUPD50  IF        DATACHNG = 1
            MOVE      "B",INTAUDTY          * "before change"
            CALL      INTAUD00
          ENDIF
.
          MOVE      OBAOUTNO,VSINVISN
          MOVE      OBADATE,VSINDATE
          PACK      VSINTIME,OBATIME,KSECONDS
          MOVE      "2",VSINTYPE
          MOVE      CASEKEYS,VSINSUBK
          MOVE      SP70,VSINWUID
.
          IF        DATACHNG = 1
            MOVE      ZERO,VSINNOTF  
            CALL      UPVSINT1
            MOVE      "C",INTAUDTY
            CALL      INTAUD00
          ELSE
            MOVE      ZERO,VSINNOTF
            MOVE      SP70,VSINUDC1
            MOVE      SP70,VSINUDC2
            MOVE      SP70,VSINUDC3
            MOVE      SP70,VSINUDC4
            MOVE      SP70,VSININTP
            MOVE      SP70,VSINCHON
            MOVE      SP70,VSINSPAR
            MOVE      ZERO,VSINCONF
            CALL      WRVSINT1
            MOVE      "A",INTAUDTY
            CALL      INTAUD00
          ENDIF
          MOVE      ZERO,EXIT
.
INTUPD99  RETURN
+
.*******************************************************************************
. Update Interpreter Audit Table
.  Input - CASEKEYS  Key To Booking
.          INTAUDTY  Audit Type
.*******************************************************************************
INTAUD00  CALL      CLVISIAU
.
          PACK      VSIACDAT,CCC,CYY,CMM,CDD
          REP       " 0",VSIACDAT
          MOVE      CTIMEIS,VSIACTIM
          MOVE      INTAUDTY,VSIARTYP
.
          MOVE      VSINVISN,VSIAVISN
          MOVE      VSINDATE,VSIADATE
          MOVE      VSINTIME,VSIATIME
          MOVE      VSINTYPE,VSIATYPE 
          MOVE      VSINSUBK,VSIASUBK
          MOVE      VSINWUID,VSIAWUID
          MOVE      PMPXLNG1,VSIALNG1
          MOVE      PMPXLNG2,VSIALNG2
          MOVE      PMPXLNG3,VSIALNG3
          MOVE      VSINNOTF,VSIANOTF
          MOVE      VSINCONF,VSIACONF
.
          PACK      KEY25,VSIACDAT,VSIACTIM,VSIARTYP,VSIAVISN,SP70
          CALL      RAVSIAU1
          IF        OVRCD=0
            CALL      UPVSIAU1
          ELSE
            CALL      WRVSIAU1
          ENDIF
          MOVE      ZERO,EXIT
.
INTAUD99  RETURN
+
.------------------------------------------------------------
.     Clear Claim Details
.------------------------------------------------------------
CLRCLM00  MOVE      SP70,WCENAME
          MOVE      SP70,WCEADD1
          MOVE      SP70,WCEADD2
          MOVE      SP70,WCEADD3
          MOVE      SP70,WCEADD4
          MOVE      SP70,WCEPOST
          MOVE      SP70,WCETELE
          MOVE      SP70,WCACDAT
          MOVE      SP70,WCACCPT
          MOVE      SP70,WCICODE
          MOVE      ZERO,WCCLMNO
.
          MOVE      SP70,VCLMNO
.
          MOVE      ZERO,PTWMTACF
          MOVE      SP70,PTWMTYPE
          MOVE      SP70,MREFNO
          MOVE      SP70,MACDAT
          MOVE      SP70,MPOLIC
          MOVE      SP70,MCREGO
          MOVE      SP70,MOTHDET1
          MOVE      SP70,MOTHDET2
          MOVE      SP70,MOTHDET3
          MOVE      SP70,MMDTRANS
          MOVE      SP70,MENGAGED
          MOVE      SP70,MPINJURE
          MOVE      SP70,MMECHSEV
          MOVE      SP70,MREGNSEV
          MOVE      SP70,MSNAME
          MOVE      SP70,MSTELE
          MOVE      SP70,MACLOC
          MOVE      SP70,PMWXVISN           * Visit Number
          MOVE      SP70,PMWXALOC           * Accident Location
          MOVE      SP70,PMWXCINJ           * of Injury (Cat IK)
          MOVE      SP70,PMWXICOD           * Injury Code (Cat IJ)
          MOVE      SP70,PMWXCNAM           * Contact Name
          MOVE      SP70,PMWXECOD           * Employer code
          MOVE      SP70,PMWXCDTE           * Date Record Created (ccyymmdd)
          MOVE      SP70,PMWXCTIM           * Time Record Created (hh:mm:ss)
          MOVE      SP70,PMWXWEBC           * WEB User Id rec. creator(websecaf)
          MOVE      SP70,PMWXLUPD           * Last Update Date (ccyymmdd)
          MOVE      SP70,PMWXLUPT           * Last Update Time (hh:mm:ss)
          MOVE      SP70,PMWXWEBU           * WEB User Id rec. updater(websecaf)
          MOVE      SP70,PMWXSPAR           * Spare Variable
.
CLRCLM99  RETURN
.
.******************************************************************************
.*          WRAP0000: write to the outrapaf file (Re-appointments File)       *
.******************************************************************************
WRAP0000  READ      CONTROLF,THIRTY1;*226,OTCNRAPA
          IF        OTCNRAPA=1
            MOVE      ADMISSNO,OTRPOBKN   * Old
            MOVE      OBAOUTNO,OTRPRBKN   * New
            PACK      OTRPDATE,CCC,CYY,CMM,CDD
            REP       " 0",OTRPDATE
            CLOCK     TIME,OTRPTIME
            MOVE      PASSCODE,OTRPLOGI
            MOVE      SP30,OTRPSPAR
            PACK      KEY16,OTRPOBKN,OTRPRBKN
            CALL      RDOTRAP1
            IF        OVRCD=1
              CALL      WROTRAP1
            ENDIF
          ENDIF
.
WRAP9999  RETURN
.
.******************************************************************************
.*          WRTR0000: write to the transport file                             *
.******************************************************************************
WRTR0000    PACK      KEY19,OBAURNO,ADMISSNO,SP70
            CALL      RSPMTSP1
WRTR1000    CALL      RKPMTSP1
            BRANCH    OVRCD,WRTR9999
.
            MATCH     OBAURNO,PMTSURNO
            GOTO      WRTR9999 IF NOT EQUAL
.
            MATCH     ADMISSNO,PMTSVISN
            GOTO      WRTR9999 IF NOT EQUAL
.
            PACK      SAVKEY19,PMTSURNO,PMTSVISN,PMTSUNIQ,SP70
.
            PACK      PMTSTDAT,OBADATE,SP70
.
            PACK      PMTSCDAT,CCC,CYY,CMM,CDD
            REP       " 0",PMTSTDAT
            CLOCK     TIME,PMTSCTIM
            MOVE      PASSCODE,PMTSCUID
.
            PACK      PMTSVISN,OBAOUTNO,SP70
.
            PACK      KEY19,PMTSURNO,PMTSVISN,PMTSUNIQ,SP70
            CALL      RAPMTSP1
            IF        OVRCD=1
              CALL      WRPMTSP1
            ENDIF
.
            PACK      KEY19,SAVKEY19,SP70
            CALL      RSPMTSP1
            GOTO      WRTR1000
.
WRTR9999  RETURN
.
.------------------------------------------------------------------------------
. Update waiting list review date
. OTCNAUPD - Update waiting list outpatient review date set to yes
. REVWFLAG - 0 = Update review date
.            1 = Delete review date
.------------------------------------------------------------------------------
REVD0000  COMPARE   ONE,HBWAIT                   * Using w/list
          GOTO      REVD9999 IF NOT EQUAL
.
          MATCH     "1",OTCNAUPD                 * Not using auto update review
          GOTO      REVD9999 IF NOT EQUAL        * date
.
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          MATCH     CURRDATE,OBADATE             * Exit if booking date is
          GOTO      REVD9999 IF LESS             * less than today
.
          PACK      KEY12,OBASITE,OBACTYP,SP70
          CALL      RDCTYA1                      * Exit if invalid clinic type
          BRANCH    OVRCD,REVD9999
.
          MATCH     SP70,OCTWUNIT                * Exit if no W/List unit
          GOTO      REVD9999 IF EQUAL
.
          PACK      KEY19,OBAURNO,SP70
          CALL      RDSTREA1
REVD1000  CALL      RDKTREA1
          BRANCH    OVRCD,REVD9999
.
          MATCH     WMURNO,OBAURNO               * Select records that are
          GOTO      REVD9999 IF NOT EQUAL        * Unscheduled, Scheduled or
.                                                * Pre-Admitted
          BRANCH    WMSTAT,REVD2000,REVD2000,REVD2000
.
          GOTO      REVD1000
.
REVD2000  BRANCH    REVWFLAG,REVD6000            * Cancel booking
.
          MATCH     SP70,WMDATE2                 * Update if no review date
          GOTO      REVD5000 IF EQUAL
.
          MATCH     WMDATE2,OBADATE              * Skip if booking date is
          GOTO      REVD1000 IF EQUAL            * equal to review date
.
          MATCH     WMDATE2,OBADATE              * Exit if booking date is
          GOTO      REVD1000 IF LESS             * less than review date
.
REVD5000  MOVE      OBADATE,WMDATE2              * Set review date to book date
          GOTO      REVD8000
.
REVD6000  MATCH     SP70,WMDATE2                 * Skip if no review date to
          GOTO      REVD1000 IF EQUAL            * clear on cancel
.
          MOVE      SP70,WMDATE2                 * Clear review date
.
REVD8000  CALL      UPTREA1                      * Update waiting list
.
          GOTO      REVD1000                     * Check next record
.
REVD9999  RETURN
.
.------------------------------------------------------------
. Get Slot Count from Code File
.------------------------------------------------------------
GETSCT00  MOVE      ONE,CNTSLOTS
          MOVE      "CV",CATEGORY
          PACK      KEY5,CATEGORY,CODE
          CALL      RDCODE1
          BRANCH    OVRCD,GETSCT99
          IF        TCFORM6=0
            MOVE      ONE,TCFORM6
          ENDIF
          MOVE      TCFORM6,CNTSLOTS
.
GETSCT99  RETURN
+
.*******************************************************************************
.  PRAD0000  :  Write the Person Responsible for Account Details for RCH
.*******************************************************************************
PRAD0000  PACK      KEY3,OBACOMP,SP70
          CALL      PRFAINSR              * Copy Claim Insurance details to PRFA
          IF        OVRCD=0
            MOVE      OBAOUTNO,PKADMN
            GOTO      PRAD7000
          ENDIF
.
          MOVE      ZERO,F1
          MOVE      PMPXCONP,F1
          BRANCH    F1,PRAD1000,PRAD2000,PRAD3000,PRAD4000,PRAD5000
.
. patient is responsible for account
.
          MOVE    PTMASNAM,PACSNAMX
          MOVE    PGNAME,ANS
          PACK    PACGNAME,ANS,DOT
          MOVE    PTITL,PACTITLE
          MOVE    THREE,PACFRMT
          CALL    PACNAME
.
          MOVE    OBAOUTNO,PKADMN
          MOVE    PACFNAMX,PKNAME
          MOVE    PADD1,PKADD1
          MOVE    PADD2,PKADD2
          MOVE    PSUBRB,PKSUBR
          MOVE    PADD4,PKADD4
          MOVE    PPOST,PKPOST
          MOVE    PTELEP,PKTELEP
          MOVE    PTELEB,PKTELEB
          MOVE    "SELF      ",PKRELP
.
          GOTO    PRAD7000
.
. contact 1 is responsible for account
.
PRAD1000  MOVE    OBAOUTNO,PKADMN
          MOVE    PMPXMSNA,PACSNAMX
          MOVE    PMPXMGNA,ANS
          PACK    PACGNAME,ANS,DOT
          MOVE    PMPXMTLE,PACTITLE
          MOVE    THREE,PACFRMT
          CALL    PACNAME
.
          MOVE    PACFNAMX,PKNAME
          MOVE    PMPXMAD1,PKADD1
          MOVE    PMPXMAD2,PKADD2
          MOVE    PMPXMAD3,PKSUBR
          MOVE    PMPXMAD4,PKADD4
          MOVE    PMPXMPOS,PKPOST
          MOVE    PMPXMPNO,PKTELEP
          MOVE    PMPXMBNO,PKTELEB
          MOVE    PMPXMREL,PKRELP
.
          GOTO    PRAD7000
.
. contact 2 is responsible for account
.
PRAD2000  MOVE    OBAOUTNO,PKADMN
          MOVE    PMPXFSNA,PACSNAMX
          MOVE    PMPXFGNA,ANS
          PACK    PACGNAME,ANS,DOT
          MOVE    PMPXFTLE,PACTITLE
          MOVE    THREE,PACFRMT
          CALL    PACNAME
.
          MOVE    PACFNAMX,PKNAME
          MOVE    PMPXFAD1,PKADD1
          MOVE    PMPXFAD2,PKADD2
          MOVE    PMPXFAD3,PKSUBR
          MOVE    PMPXFAD4,PKADD4
          MOVE    PMPXFPOS,PKPOST
          MOVE    PMPXFPNO,PKTELEP
          MOVE    PMPXFBNO,PKTELEB
          MOVE    PMPXFREL,PKRELP
.
          GOTO    PRAD7000
.
. contact 3 is responsible for account
.
PRAD3000  MOVE    OBAOUTNO,PKADMN
          MOVE    PNKNAME,PKNAME
          MOVE    PNKADD1,PKADD1
          MOVE    PNKADD2,PKADD2
          MOVE    PNKSUBR,PKSUBR
          MOVE    PNKADD4,PKADD4
          MOVE    PNKPOST,PKPOST
          MOVE    PNKTELP,PKTELEP
          MOVE    PNKTELB,PKTELEB
          MOVE    PNKRELP,PKRELP
.
          GOTO    PRAD7000
.
. contact 4 is responsible for account
.
PRAD4000  MOVE    OBAOUTNO,PKADMN
          MOVE    PTMXECNM,PKNAME
          MOVE    PTMXECA1,PKADD1
          MOVE    PTMXECA2,PKADD2
          MOVE    PTMXECA3,PKSUBR
          MOVE    PTMXECA4,PKADD4
          MOVE    PTMXECPC,PKPOST
          MOVE    PTMXECPP,PKTELEP
          MOVE    PTMXECBP,PKTELEB
          MOVE    PTMXECRE,PKRELP
.
          GOTO    PRAD7000
.
. contact 5 is responsible for account
.
PRAD5000  MOVE    OBAOUTNO,PKADMN
          MOVE    PTMXNRNM,PKNAME
          MOVE    PTMXNRA1,PKADD1
          MOVE    PTMXNRA2,PKADD2
          MOVE    PTMXNRA3,PKSUBR
          MOVE    PTMXNRA4,PKADD4
          MOVE    PTMXNRPC,PKPOST
          MOVE    PTMXNRPP,PKTELEP
          MOVE    PTMXNRBP,PKTELEB
          MOVE    PTMXNRRE,PKRELP
.
          GOTO    PRAD7000
.
PRAD7000  PACK    KEY8,OBAOUTNO,SP10
          CALL    RDARESP1
          IF      OVRCD=1
            CALL    WRRESP1
          ELSE
            CALL    UPRESP1
          ENDIF
.
PRAD9500  MOVE      ZERO,EXIT
.
PRAD9999  RETURN
.
.------------------------------------------------------------
. Write to the current patient list
.------------------------------------------------------------
WRCPAT00  CALL      CALRAN00
.
          MATCH     STRTDATE,OBADATE        * before start date
          GOTO      WRCPAT99 IF LESS
.
          MATCH     OBADATE,LASTDATE        * after end date
          GOTO      WRCPAT99 IF LESS
.
          MOVE      DOBAOUTN,PMCUVISN
          MOVE      OBADATE,PMCUDATE
          MOVE      PTMASNAM,PMCUSURN
          MOVE      PMPXFNAM,PMCUGNAM
          MOVE      PMPXSNAM,PMCUGNM2
          MOVE      PURNO,PMCUURNO
          MOVE      "2",PMCUSYST
          MOVE      SP70,PMCULOCN
          MOVE      OBASITE,PMCUOSIT
          MOVE      OTHEHOSP,PMCUHOSP
          MOVE      SP70,PMCUTSTA
          MOVE      SP70,PMCUTLOC
.
          PACK      KEY8,PMCUVISN,SP70
          CALL      RAPMCUR1
          IF        OVRCD=1
            CALL      WRPMCUR1
          ENDIF
.
WRCPAT99  RETURN
.
+
.------------------------------------------------------------
. Calculate the date range for current patient records
.------------------------------------------------------------
CALRAN00  READ      CONTROLF,HUND01;*49,CWEBSDAY  * no of days for search
          MOVE      SP70,STRTDATE
          MOVE      SP70,LASTDATE
.
. ---  calculate starting date ---
.
          CALL      IBACLOCK
          CALL      DMYCON
          SUB       CWEBSDAY,JULDAY
          MOVE      JULDAY,JWKDAY
          MOVE      JULYR,JWKYER
          MOVE      JULCC,JWKCC
          CALL      JULCON
          PACK      STRTDATE,CC,YY,MM,DD
          REP       " 0",STRTDATE
.
. ---  calculate last date ---
.
          CALL      IBACLOCK
          CALL      DMYCON
          ADD       CWEBSDAY,JULDAY
          MOVE      JULDAY,JWKDAY
          MOVE      JULYR,JWKYER
          MOVE      JULCC,JWKCC
          CALL      JULCON
          PACK      LASTDATE,CC,YY,MM,DD
          REP       " 0",LASTDATE
.
CALRAN99  RETURN
.
.*******************************************************************************
.             PPRE0000 : Post the pre-attendance file data
.*******************************************************************************
PPRE0000  MOVE      OBAOUTNO,KEY8
          CALL      RDPREA1
          BRANCH    OVRCD,PPRE5000
.
          MOVE      OBACLIN,OPRCLIN
          MOVE      OBADATE,OPRDATE
          MOVE      OBASTRT,OPRSTRT
          MOVE      OBASLOT,OPRSLOT
          MOVE      OBATIME,OPRTIME
          MOVE      OBACTYP,OPRCTYP
          CALL      UPPREA1
          GOTO      PPRE9999
.
PPRE5000  MOVE      OBAOUTNO,OPROUTN
          MOVE      OBASITE,OPRSITE
          MOVE      OBACLIN,OPRCLIN
          MOVE      OBADATE,OPRDATE
          MOVE      OBASTRT,OPRSTRT
          MOVE      OBASLOT,OPRSLOT
          MOVE      OBATIME,OPRTIME
          MOVE      OBACTYP,OPRCTYP
          MOVE      SP20,OPRSPAR
          MOVE      OPROUTN,KEY8
          CALL      WRPREA1
.
PPRE9999  RETURN
.
.*******************************************************************************
.             CLSODI00 : Clear the OUTDIAFD save variables
.*******************************************************************************
CLSODI00  MOVE      SP70,SAVICODE
          MOVE      SP70,SAVIDESC
          MOVE      SP70,SAVICOD2
          MOVE      SP70,SAVIDES2
          MOVE      SP70,SAVICOD3
          MOVE      SP70,SAVIDES3
          MOVE      SP70,SAVICOD4
          MOVE      SP70,SAVIDES4
          MOVE      SP70,SAVICOD5
          MOVE      SP70,SAVIDES5
.
CLSODI99  RETURN
.
.*******************************************************************************
.             CLSXSC00 : Clear the OUTXSCFD save variables
.*******************************************************************************
CLSXSC00  MOVE      SP70,SVXSDTE1
          MOVE      SP70,SVXSDTE2
          MOVE      SP70,SVXSDTE3
          MOVE      SP70,SVXSDTE4
          MOVE      SP70,SVXSDTE5
          MOVE      SP70,SVXSDTE6
          MOVE      SP70,SVXSCO01
          MOVE      SP70,SVXSCO02
          MOVE      SP70,SVXSCO03
          MOVE      SP70,SVXSCO04
          MOVE      SP70,SVXSCO05
          MOVE      SP70,SVXSCO06
          MOVE      SP70,SVXSCO07
          MOVE      SP70,SVXSCO08
          MOVE      SP70,SVXSCO09
          MOVE      SP70,SVXSCO10
          MOVE      SP70,SVXSCO11
          MOVE      SP70,SVXSCO12
          MOVE      SP70,SVXSCO13
          MOVE      SP70,SVXSCO14
          MOVE      SP70,SVXSCO15
          MOVE      SP70,SVXSCO16
          MOVE      SP70,SVXSCO17
          MOVE      SP70,SVXSCO18
          MOVE      SP70,SVXSCO19
          MOVE      SP70,SVXSCO20
          MOVE      SP70,SVXSDOC1
          MOVE      SP70,SVXSDOC2
          MOVE      SP70,SVXSDOC3
          MOVE      SP70,SVXSAMT1
          MOVE      SP70,SVXSAMT2
          MOVE      SP70,SVXSDSC1
          MOVE      SP70,SVXSDSC2
          MOVE      SP70,SVXSDSC3
          MOVE      SP70,SVXSDSC4
          MOVE      SP70,SVXSDSC5
          MOVE      SP70,SVXSDSC6
          MOVE      SP70,SVXSTIM1
          MOVE      SP70,SVXSTIM2
          MOVE      SP70,SVXSTIM3
          MOVE      SP70,SVXSTIM4
          MOVE      SP70,SVXSTIM5
          MOVE      SP70,SVXSTIM6
.
CLSXSC99  RETURN
.
          INC       CALCAGE
          INC       CLOUTCAN
          INC       CLOUTRSH
          INC       CLOUTXSC
          INC       CLPMSVX1
          INC       CLVISINT
          INC       CLVISIAU
          INC       CLPATRE1
          INC       COUNTSLT                * Clinic/Slot recalculations
          INC       DAYOFWEK
          INC       DGCLICOB                * DG O/P Change Booking Details
          INC       DGCLICON                * DG O/P New Appointment   *I-90203
          INC       GENANVIS
          INC       PMIGTNID
          INC       STD001IO
          INC       KYOUTCLI                * Keyin the clinic id
          INC       OUTDSCLN                * Display the clinic ids
          INC       PATHSPKY                * Hospital keyin
          INC       PRFAINSR                * Default PRFA based on claim code
.
          INC       ALLLNKIO/INC            * A/H Referral Links 
          INC       CCIEX7IO/INC            * Clinical Costing Extract 7
          INC       EOCLNKIO/INC            * EOC linked events
          INC       HICCLMIO/INC            * HIC Claims
          INC       IBAPOSIO/INC
          INC       NHIMASIO/INC            * NHI Master 
          INC       OUTBOAIO/INC            * Clinic session booking file A
          INC       OUTBB1IO/INC            * Clinic session booking file B
          INC       OUTBOCIO/INC            * Clinic Session Booking Table C
          INC       OUTCANIO/INC            * Cancelled bookings
          INC       OUTCLIIO/INC            * Clinic file
          INC       OUTCTYIO/INC            * Clinic type
          INC       OUTDIAIO/INC            * Outpatinet diagnosis
          INC       OUTHEDIO/INC            * Clinic master header file
          INC       OUTMA1IO/INC            * Clinic Master file
          INC       OUTMSPIO/INC            * Clinic master suspensions
          INC       OUTPREIO/INC            * Outpatient Pre-attendance file
          INC       OUTRAPIO/INC            * Re-Appointments
          INC       OUTSITIO/INC            * Site file
          INC       OUTSESIO/INC            * Session file
          INC       OUTRSHIO/INC            * Referral List
          INC       OUTXSCIO/INC            * Extension File
          INC       PATDO1IO/INC            * Doctors file
          INC       PATCODIO/INC            * Category codes
          INC       VISMDTIO/INC
          INC       VISMTXIO/INC
          INC       PATHSPIO/INC            * Hospital file
          INC       PATICDIO/INC            * ICD10 Disease
          INC       PATICOIO/INC            * ICD10 Operation
          INC       PATIN1IO/INC            * Insurance file
          INC       PATMA1IO/INC            * Patient master file
          INC       PATRE1IO/INC            * PRA       
          INC       PATNIDIO/INC            * National ID
          INC       PATVISIO/INC            * Visit file
          INC       PATWC1IO/INC            * Workers comp
          INC       PATWMAIO/INC            * TAC
          INC       PATWVEIO/INC            * Veteran Affairs
          INC       PMSHCPIO/INC            * National HCP file
          INC       PMSCURIO/INC            * Current Patients
          INC       PMSPX2IO/INC            * Patient Master Extn File 2
          INC       PMSTSPIO/INC            * Transport Details
          INC       PMSVX1IO/INC            * Visit Extension Table 
          INC       PMSWX1IO/INC            * Workers comp extn
          INC       PRIPRAIO/INC            * Medical practice
          INC       VISIAUIO/INC            * Interpreter audit
          INC       VISINTIO/INC            * Interpreter visit file
          INC       WATTR1IO/INC            * Waiting list
          INC       WATTX1IO/INC            * Waiting list extn
          INC       WEBSECIO/INC
.
