.**************************************************************************
.*  DGSRVPMI  :  Wait for & Read an incoming PMI message & determine what *
.*               kind of message it is.      ~~~                          *
.*                                                                        *
.*  Author    :  Mike Laming - Cloned from DGSRVPMI.PBL (18/06/2001)      *
.*                                                                        *
.*  Mod's     :                                                           *
.**************************************************************************
.* V12.00.02 27/07/2025  Nikitha B      TSK 0963585                       *
.*           Recompiled for WEBCHGUR                                      *
.* V12.00.01 16/05/2025  Bella Turco    TSK 0955096                       *
.*           Alphanumeric changes                                         *
.* V11.04.02 27/03/2024  Ebon Clements  TSK 0944691                       *
.*           Recompiled for WEBCHGUR - Future end dated alerts            *
.* V11.04.01 22/01/2024  Ebon Clements TSK 0932545                        *
.*           Recompiled for PMSCEXTM - Added VAR, TEXTAREA and            *
.*           CONFFILE                                                     *
.* V11.02.02 01/04/2022  Thanh T       TSK 0903453                        *
.*           Added SPPXUCC4, SPPXUCC5, SPPXATF1 and SPPXATF2 for          *
.*           DEATHAUD changes                                             * 
.* V11.02.01 10/02/2022  Thanh T       TSK 0889899                        *
.*           Recompiled as WATTR1FD changes                               *
.* V11.01.03 20/12/2021  Thanh T        TSK 0877055                       *
.*           Added DEATHATD for common variables to be used in DEATHAUD   *
.* V11.01.02 15/09/2021  Thanh T         TSK 0889595                      *
.*           Recompiled for PMSDAUFD/DEATHAUD changes                     *
.* V11.01.01 31/03/2021  Tracey Nguyen   TSK 0904417                      *
.*           Recompiled for MEHPATFD in WEBCHGUR - added MHPTFAMW         *
.*           Family/Whanau Involvement                                    *
.*------------------------------------------------------------------------*
.* V11.00.05 30/12/2020  Thanh T         TSK 0878747                      *
.*           Recompiled for WEBCHGUR changes                              *
.* V11.00.04 09/09/2020  Peter Vela      TSK 0895969                      *
.*           Recompiled for WEBCHGUR                                      *
.* V11.00.03 23/06/2020  Peter Vela      TSK 0878550                      *
.*           Recompiled for DEATHAUD                                      *
.* V11.00.02 10/06/2020  Peter Vela      TSK 0878550                      *
.*           Recompiled for DEATHAUD                                      *
.* V11.00.01 07/05/2020  Thanh T         TSK 0876574                      *
.*           Recompiled for PMSCEXTM/PMSCEXTD changes                     *
.* V10.14.04 12/07/2019  Richa Phogat    TSK 0864951                      *
.*           Recompiled for WEBCHGUR                                      *
.* V10.14.03 10/07/2019  Richa Phogat    TSK 0864951                      *
.*           Recompiled for WEBCHGUR                                      *
.* V10.14.02 03/07/2019  Steve Armstrong  TSK 0870017                     *
.*           Recompiled for changes to DGPMISER.                          *
.* V10.14.01 13/06/2019  Peter Vela       Task 0871798                    *
.*           Recompiled for DEATHAUD                                      *
.**************************************************************************
.*        V10.13.01 13/08/2018  Peter Vela       Task 0845218             *
.*                  Recompiled for DEATHAUD                               *
.**************************************************************************
.*        V10.12.04 11/07/2018  Peter Vela       TSK 0845218              *
.*                  Recompiled for DEATHAUD                               *
.*        V10.12.03 25/06/2018  Ebon Clements    TSK 0845295              *
.*                  Recompiled for WEBCHGUR - eReferrals                  *
.*        V10.12.02 25/05/2018  Thanh T.         TSK 0856102              *
.*                  Added PMSEHB00 for pmsehbaf in WEBCHGUR               *
.*        V10.12.01 05/04/2018  Steve Armstrong  TSK 0844685              *
.*                  Recompiled for changes to WEBCHGUR                    *    
.*                  06/04/2018  Davin            TSK 0844685              *
.*                  Recompiled for changes to WEBCHGUR                    *    
.**************************************************************************
.*        V10.11.02 21/09/2017  Thanh T.         TSK 0821710              *
.*                  Recompiled for WEBCHGUR                               *    
.*        V10.11.01 14/09/2017  Thanh T.         TSK 0821710              *
.*                  Recompiled for WEBCHGUR                               *    
.**************************************************************************
.*        V10.10.01 12/04/2017  Peter Vela       TSK 0836016              *
.*                  Recompiled for WEBCHGUR - Always keep bad debt in     *
.*                  FIXMAS                                                *
.*        V10.08.06 18/08/2016  Ebon Clements    TSK 0260691              *
.*                  Recompiled for WEBCHGUR - A/H equipment loans         *
.*        V10.08.05 08/08/2016  Davin            TSK 0321234              *
.*                  Recompiled for WEBCHGUR - Added chronic alert(savesn11)
.*        V10.08.04 29/07/2016  Don Nguyen       TSK 0809271              *
.*                  Recompiled for WEBCHGUR - Modified FXBKRES1 to call UPESIS00
.*        V10.08.03 17/06/2016  Peter Vela       TSK 0820868              *
.*                  Recompiled for MRGURPRI                               *
.*        V10.08.02 13/05/2016  Don Nguyen       TSK 0319664              *
.*                  Recompiled for WEBCHGUR - added FIXOBSNT              *
.*                  18/04/2016  Peter Vela       TSK 0294177              *
.*                  Recompiled for MRGURPRI                               *
.*        V10.08.01 01/04/2016  Steve Armstrong  TSK 0324703              *
.*                  Recompiled for changes to PATURCFD & WEBCHGUR         *
.**************************************************************************
.*        V10.07.03 04/02/2016  Peter Vela       CAR 0809659              *
.*                  Recompiled for WEBCHGUR                               *
.*        V10.07.02 02/02/2016  Peter Vela       CAR 0809659              *
.*                  Recompiled for SVRSPMI                                *
.*        V10.07.01 05/11/2015  Steve Armstrong  CAR 303363               *
.*                  Recompiled for changes to RESHEAFD                    *
.**************************************************************************
.*        V10.06.07 30/09/2015  Ania P           CAR 321333               *
.*                  Recompiled for changes to WEBCHGUR                    *
.*        V10.06.06 06/07/2015  Peter Vela       CAR 316928               *
.*                  Recompiled for MRGURWEB                               *
.*        V10.06.05 03/07/2015  J.Tan            CAR 316441               *
.*                  Recompiled for changes to WEBCHGUR - pmsdauaf file    *
.*        V10.06.04 20/06/2015 Steve Armstrong  CAR 313856                *
.*                  Recompiled for changes to WEBCHGUR                    *
.*        V10.06.03 18/05/2015 Patrick Adair  CAR 208170                  *
.*                  Recompiled for changes to UPDUR                       *
.*        V10.06.02 15/04/2015  Peter Vela       CAR 312723               *
.*                  Recompiled for DEATHAUD                               *
.*        V10.06.01 12/03/2015  Steve Armstrong   CAR 314108              *
.*                  Removed definition of PTCGDATE as PATCGPFD is no      *
.*                  longer in use                                         *
.**************************************************************************
.*        V10.05.01 14/10/2014  Peter Vela       CAR 301518               *
.*                  Recompiled for MRGURWEB                               *
.**************************************************************************
.*        V10.04.04 16/06/2014  Steve Armstrong   CAR 301639              *
.*                  Moved calls to TFILENAM from DGPMIEAL & DGPMISER      *
.*                  into DGINI000 and created separate filename           *
.*                  variables (FNAMEA & FNAMEB for DGPMIEAL & DGPMISER    *
.*                  respectively).                                        *
.*                  Recompiled for changes to DGPMIEAL & DGPMISER.        *
.*        V10.04.03 05/06/2014  Steve Armstrong  CAR 299293               *
.*                  Recompiled for changes to WEBCHGUR                    *
.*        V10.04.02 30/04/2014  Steve Armstrong  CAR 261630               *
.*                  Mods for non-port based tempfile use.                 *
.*                  Recompiled for changes to DGPMIEAL & DGPMISER.        *
.*        V10.04.01 09/12/2013  Peter Vela       CAR 286158               *
.*                  Recompiled for changes to DGPMIEAL & DGPMISER         *
.**************************************************************************
.*        V10.03.21 09/12/2013  Peter Vela       CAR 286158               *
.*                  Recompiled for WEBCHGUR - Added PATATRFD              *
.*        V10.03.20 26/07/2013  Steve Armstrong  CAR 287787               *
.*                  Recompiled for changes to DGCLICUA.                   *
.*        V10.03.19 30/06/2013  Davin             CAR 283202              *
.*                  Recompiled for changes to hl7 messaging               *
.*        V10.03.18 09/07/2013 Sandra Barcham    CAR 288188               *
.*                  Recompiled for changes to WEBCHGUR                    *
.*        V10.03.17 28/06/2013  Patrick Adair    CAR 286757               *
.*                  Recompiled for changes to MRGURWEB (in WEBCHGUR)      *
.*        V10.03.16 01/05/2013  Steve Armstrong   CAR 284376              *
.*                  Recompiled for changes to BRHLCOMN so that PMI        *
.*                  messages can use H7CIHOSP for Facility Code.          *
.*                  Recompiled for changes to DGCLICUP.                   *
.*        V10.03.15 12/04/2013  Steve Armstrong   CAR 283973              *
.*                  Recompiled for changes to WEBCHGUR                    *
.*        V10.03.14 05/03/2013  Jill Parkinson   CAR 257831               *
.*                  Recompiled for changes to WEBCHGUR, added pmsupdaf    *
.*        V10.03.13 10/12/2012  Steve Armstrong  CAR 275430               *
.*                  Recompiled for changes to WEBCHGUR                    *
.*        V10.03.12 02/11/2012  Saroeun Soeur    CAR 275430               *
.*                  Recompiled for changes to WEBCHGUR                    *
.*        V10.03.11 14/08/2012  Steve Armstrong  CAR 256888               *
.*                  Recompiled for changes to WEBCHGUR.                   *
.*        V10.03.10 23/07/2012 Patrick Adair     CAR 269159               *
.*                  Recompiled for changes to PATCOMN2                    *
.*        V10.03.09 19/07/2012  Steve Armstrong  CAR 268870               *
.*                  Recompiled for changes to PATCOMN2 & UPDUR            *
.*        V10.03.08 09/07/2012  Steve Armstrong  CAR 267675               *
.*                  Recompiled for changes to PATCOMN2.                   *
.*        V10.03.07 29/05/2012  J.Tan            CAR 259554               *
.*                  Recompiled for WEBCHGUR - Event visit to upd patinvrf *
.*        V10.03.06 23/05/2012  Ebon Clements     CAR 265676              *
.*                  Recompiled for WEBCHGUR                               *
.*        V10.03.05 11/04/2012  Steve Armstrong   CAR 263369              *
.*                  Recompiled for WEBCHGUR                               *
.*        V10.03.04 04/04/2012  Peter Vela        CAR 262395              *
.*                  Recompiled for WEBCHGUR                               *
.*        V10.03.03 03/04/2012  Don Nguyen        CAR 262735              *
.*                  Recompiled for changes to WEBCHGUR.                   *
.*        V10.03.02 29/11/2011 Steve Armstrong   CAR 253264               *
.*                  Recompiled for changes to WEBCHGUR.                   *
.*        V10.03.01 09/11/2011  Steve Armstrong   CAR 254774              *
.*                  Recompiled for changes to UPDUR.                      *
.**************************************************************************
.*        V10.02.04 26/07/2011 Steve Armstrong    CAR 240684              *
.*                  Recompiled for changes to LEGALTFD and WEBCHGUR.      *
.*        V10.02.03 25/06/2011 Steve Armstrong    CAR 240722              *
.*                  - Recompiled for changes to PATLOCFD.                 *
.*                  - Recompiled for changes to PMSCURFD.                 *
.*                  - Recompiled for changes to DGPMIEAL, DGPMIREG,       *
.*                    DGPMISER, DGPMIUAL & DGPMIUPD.                      *
.*        V10.02.02 05/05/2011  Mike Laming   CAR 240720                  *
.*                  Recompiled for WEBCHGUR - added OP App'nt Request     *
.*        V10.02.01 21/04/2011  Mike Laming   CAR 233229                  *
.*                  Recompiled for WEBCHGUR - added Patient Debt Indicat.s*
.*        V10.01.01 02/02/2011  Steve Armstrong   CAR 237520              *
.*                  Mods to remove Detente interface (PATDETNT).          *
.*                  Also recompiled for changes to DGPMIREG.              *
.**************************************************************************
.*        V10.00.02 27/10/2010 Steve Armstrong   CAR 232111               *
.*                  Recompiled for changes to WEBCHGUR.                   *
.*        V10.00.01 09/04/2010 Steve Armstrong   CAR 219045               *
.*                  Recompiled for changes PATMRGFD.                      *
.**************************************************************************
.*        V9.12.02  01/03/2009  Steve Armstrong  CAR 217090               *
.*                  Recompiled for WEBCHGUR                               *
.*        V9.12.01  09/10/2009  WeeLee Koo       CAR 181371               *
.*                  Recompiled for changes to WEBCHGUR.                   *
.**************************************************************************
.*        V9.11.03  02/04/2009  Mike Laming       CAR 166690              *
.*                  Recompiled for changes to WEBCHGUR.	                  *
.*                   - Added NZ PRIMHD Hist. Tables                       *
.*        V9.11.02  19/02/2009  Steve Armstrong   CAR 190455              *
.*                  Recompiled for (Eclipse) changes to WEBCHGUR.         *
.*        V9.11.01  20/11/2008  Steve Armstrong  CAR 181373               *
.*                  Recompiled for changes to PMSPTDFD and WEBCHGUR.      *
.*                  Added read of PTCNTRPR.                               *
.**************************************************************************
.*        V9.09.05  30.01.2008  Peter Vela       CAR 155334               *
.*                  Recompiled for WEBCHGUR. Added PMSPTDFD, IO           *
.*        V9.09.04  18/01/2008  Steve Armstrong  CAR 159429               *
.*                  Recompiled for changes to WEBCHGUR                    *
.*        V9.09.03  01/10/2007  Sandra Barcham CAR 151255                 *
.*                  Recompiled for WEBCHGUR - fix loop of alllon I * U    *
.*        V9.09.02  28/09/2007  Sandra Barcham CAR 151255                 *
.*                  Recompiled for WEBCHGUR - fix loop of allpct I * U    *
.*                  27/09/2007  Mike Laming   CAR 146598                  *
.*                  Added LEGALTFD/IO for WEBCHGUR                        *
.*        V9.09.01  27/08/2007  Peter Vela   CAR 147747                   *
.*                  Added variables for PATCOMN2 Cabrini Health UR format *
.**************************************************************************
.*        V9.08.03  20/04/2007  Steve Armstrong  CAR 111005               *
.*                  Recompiled for WEBCHGUR                               *
.*        V9.08.02  31/01/2007  Peter Vela    CAR 127930                  *
.*                  Recompled for MRTCONFD                                *
.*        V9.08.01  13/10/2006  Peter Vela       CAR 120583               *
.*                  Recompiled for WEBCHGUR - Defaulted MRMACOMM to SP70  *
.*                  in CRMED000                                           *
.*        V9.06.01  08/06/2006  Steve Armstrong  CAR 108060               *
.*                  Recompiled for changes to UPDUR                       *
.**************************************************************************
.*        V9.05.B03 20/02/2006  Ebon Clements     CAR 76341               *
.*                  Added referral and encounter file audit               *
.*        V9.05.B02 21/12/2005  Steve Armstrong   CAR 89329               *
.*                  Recompiled for changes to MRGURRES                    *
.**************************************************************************
.*        V9.04.09  11/10/2005  J.Tan         CAR 64037                   *
.*                  Recompiled for PATURAFD - U/R audit file              *
.*        V9.04.08  27/05/2005  J.Tan         CAR 56699                   *
.*                  Recompiled for WEBCHGUR - update HIC files            *
.*        V9.04.07  02/05/2005  Mike Laming   CAR 60976                   *
.*                  Recompiled for WEBCHGUR - Fix "Intepreter Visit Dets" *
.*        V9.04.06  29/04/2005  Peter Vela    CAR 55214                   *
.*                  Recompiled for MRTCONFD                               *
.*                  29/04/2005  Mike Laming   CAR 61101                   *
.*                  Recompiled for WEBCHGUR - Fix "Previous Address"      *
.*        V9.04.05  17/03/2005  Steve Armstrong   CAR 59565               *
.*                  Recompiled for changes to DGPMIUPD                    *
.*                  16/03/2005  Steve Armstrong   CAR 59524               *
.*                  Recompiled for changes to WRTUR in PATCOMN2           *
.*        V9.04.04  07/03/2005  Steve Armstrong    CAR 59137              *
.*                  Recompiled for changes to CISINADT, HL7CISIN &        *
.*                  HL7CISVR                                              *
.*        V9.04.03  03/02/2005  Peter Vela           CAR 56906            *
.*                  Recompiled for WEBCHGUR                               *
.*        V9.04.02  06/10/2004  Peter Vela               CAR 49647        *
.*                  Recompiled for UPDUR                                  *
.*        V9.04.01  27/09/2004  Ebon Clements            CAR 53266        *
.*                  Multi hospital changes for CRMED000 - medical record  *
.*                  link                                                  *
.*        V9.03.07  14/07/2004  Steve Armstrong      CAR 51769            *
.*                  Removed reference to PATHCSUC.                        *
.*        V9.03.06  09/06/2004  Sylvek Litewka  CAR 50371                 *
.*                  Recompiled for FIXPFA (Patient Future Actions)        *
.*                  in WEBCHGUR.                                          *
.*        V9.03.05  13/05/2004  Steve Armstrong      CAR 49679            *
.*                  PAS-CIS Product Integration                           *
.*                  Recompiled for WRTUR in PATCOMN2 (added call to       *
.*                  CISA28BR)                                             *
.*        V9.03.04  16/03/2004  Steve Armstrong  HosClaims Phase 1 (48280)*
.*                  Recompiled for WEBCHGUR                               *
.*        V9.03.03  18/12/2003 Peter Vela    CAR 43134                    *
.*                  Recompiled for MRTCONFD                               *
.*        V9.03.02  05/11/2003 Peter Vela    CAR 41829                    *
.*                  Recompiled for WEBCHGUR - Added variables MRGURDAT and*
.*                  MRGODDAT                                              *
.*        V9.03.01  22/05/2003 Ebon Clements CAR 39351                    *
.*                  Added update of ALLLINFD for allied health change ur  *
.*                  function.                                             *
.*        V9.02.07  06/12/2002  Davin                                     *
.*                  Fixed I*M on an audit file                            *
.*        V9.02.06  14/11/2002  Davin                                     *
.*                  Removed reference to $$DBASE WEB compile option       *
.*        V9.02.05  06/07/2002  Jill Habasque SRF 19273                   *
.*                  Recompiled for PATCOMN2                               *
.*        V9.02.04  28/05/2002  Mike Laming      srf 15999                *
.*                  Recompiled for OUTRF1IO.INC                           *
.*        V9.02.03  24/05/2002  Steve Armstrong  srf 18019                *
.*                  Recompiled for mods to DGPMIREG (to allow U/R to be   *
.*                  passed).                                              *
.*        V9.02.02  11/04/2002 Mike Laming  New DG APIs                   *
.*                  1) Add code for new API DGAPMIMRG (Merge URs)         *
.*            ~     2) Replace PMEDI with Composite variable PMEDIXX (which*
.*                  contains PMEDI+PTMXMCCD) Add call (SPLTPMED)to split  *
.*                  these.                                                *
.*        V9.02.01  08/11/2001  Mike Laming                               *
.*                  Rename DGCLIUPM to DGCLICUP                           *
.*        V9.02.00  18/06/2001  Mike Laming                               *
.*                  Add new Data Fields to the following Message Types:   *
.*                  REG - DGPMIREG - 69 fields from PMSPX2                *
.*                  ENQ - DGPMIENQ - 69 fields from PMSPX2                *
.*                  UPD - DGPMIUPD - 69 fields from PMSPX2                *
.*                  EAL - DGPMIEAL -  2 fields from PATGSR                *
.*                  UAL - DGPMIUAL -  2 fields                            *
.*                  Add PMSPX2FD/IO - Using $$DBASE Compile option for    *
.*                      WEB processing                                    *
.*        V5.10.B01 26/03/2001  Glenn Saunders                            *
.*                  Remove access to PTCNSNDX and associated processing.  *
.*                  Remove all references to PATSUR file (old surname ).  *
.*        V5.08.03  21/08/2000  Jill Habasque                             *
.*                  Added variables for patdetnt                          *
.*        V5.08.02  16/08/2000  Caleb Sharman                             *
.*                  Changed Health Fund variables to be 8 chars           *
.*        V5.08.01  24/07/2000  Steve Armstrong                           *
.*                  Recompiled for DGPMIREG & DGPMIUPD                    *
.*        V5.08.B03 29/02/2000  Steve Armstrong                           *
.*                  Recompiled for PATCOMN2                               *
.*        V5.08.B02 28/01/2000  Steve Armstrong                           *
.*                  Recompiled for DGPMIREG                               *
.*                  Recompiled for DGCOMMFD (Y2K changes)                 *
.*        V5.08.B01 19/01/2000  Steve Armstrong                           *
.*                  Recompiled for changes to DGPMISER                    *
.**************************************************************************
.*        V5.07.08  21/09/1999  Steve Armstrong                           *
.*                  Recompiled for changes to PATCOMN2 (GNXTUR)           *
.*        V5.07.07  08/09/1999  Steve Armstrong                           *
.*                  Recompiled for changes to DGPMIUPD                    *
.*        V5.07.06  03/09/1999  Steve Armstrong                           *
.*                  Recompiled for changes to DGPMIALR                    *
.*        V5.07.05  02/08/1999  Steve Armstrong                           *
.*                  Recompiled for changes to DGPMIUPD                    *
.*        V5.07.04  02/08/1999  Steve Armstrong                           *
.*                  Recompiled for changes to PATDETNT                    *
.*               V5.07.03  21/07/1999  Steve Downing                      *
.*                         Recompiled for DGPMISER                        *
.*               V5.07.02  08/07/1999  Nicole Harrington                  *
.*                         Recompiled for DGCLIREG and DGCLIUAL           *
.*               V5.07.B03 14/01/1999  Davin                              *
.*                         Fixed errors for global recompile              *
.*               V5.07.B02 22/12/1998  Davin                              *
.*                         Y2K mods                                       *
.*               V5.07.B01 22/12/1998  Davin                              *
.*                         507 mods                                       *
.**************************************************************************
.*               V5.06.01  10/08/1998  Steve Armstrong                    *
.*                         Fixed display of number of alerts              *
.*                         Also recompiled for changes to DGPMIUPD (to    *
.*                         only validate non-blank ethnicity fields)      *
.**************************************************************************
.*               V5.05.05  05/05/1998  Steve Armstrong   WHL Mods         *
.*                         Recompiled for changes to DGPMIALR             *
.*               V5.05.04  20/02/1998  Steve Armstrong   WHL Mods         *
.*                         Added DGPMIALR                                 *
.*               V5.05.03  16/12/1997  Steve Armstrong                    *
.*                         Recompiled for changes to DGPMIREG             *
.*               V5.05.02  27/10/1997  Steve Armstrong                    *
.*                         Recompiled for changes to WRTUR for DGCLIREG   *
.*               V5.05.01  13/10/1997  Steve Armstrong   WHL              *
.*                         Recompiled for nhi master file variables       *
.*                         and new master extension file variables.       *
.**************************************************************************
.*               V5.04.03  16/04/1997  Steve Armstrong                    *
.*                         Mods to use input & output socket (DGATEIN &   *
.*                         DGATEOUT).                                     *
.*               V5.04.01  12/07/96  Changed to use STD002FD so program   *
.*                                   can be run from command line.        *
.*                                                                        *
.**************************************************************************
.
 IFGE     $$VER,7
          INC       STD002FD       * use this to set up common
          INC       MRTCONFD/INC            * MRG                      *I-90202
          INC       PATCOMM/INC
          INC       PATDHEAD/INC         reqd for surname search
          INC       PATCALAG/INC         reqd for surname search
          INC       SAVPX2FD/INC            * MRG                      *I-90202
.
          INC       AAEDE1FD/INC            * MRG                      *I-90202
          INC       ALLCONFD/INC
          INC       ALLEDTFD/INC
          INC       ALLETXFD/INC
          INC       ALLLINFD/INC
          INC       ALLLONFD/INC
          INC       ALLPCTFD/INC
          INC       ALLREFFD/INC            * MRG                      *I-90202
          INC       BOKRC1FD/INC
          INC       DGCOMMFD/INC
          INC       DGTRPLFD/INC   * not used but required by ECSRVPMI
          INC       DEATHATD/INC
          INC       ECLINTFD/INC
          INC       EMRVISFD/INC            * MRG                      *I-90202
          INC       LEGALTFD/INC
          INC       LEGBOAFD/INC
          INC       LEGDEAFD/INC
          INC       LEGDSCFD/INC
          INC       LEGINVFD/INC
          INC       LEGMISFD/INC
          INC       LEGTRNFD/INC
          INC       LEGVISFD/INC
          INC       MEHVI1FD/INC
          INC       MRTMASFD/INC            * MRG                      *I-90202
          INC       NHIETHFD/INC
          INC       NHIMASFD/INC
          INC       OUTARTFD/INC
          INC       OUTCLIFD/INC
          INC       OUTPREFD/INC         reqd for surname search
.
          INC       PATALRFD/INC
          INC       PATAM1FD/INC
          INC       PATAXEFD/INC            * MRG                      *I-90202
          INC       PATCODFD/INC
          INC       PATCONFD/INC
          INC       PATDO1FD/INC
          INC       PATDSCFD/INC
          INC       PATFN1FD/INC
          INC       PATGSRFD/INC
          INC       PATHSPFD/INC
          INC       PATINVFD/INC
          INC       PATLOCFD/INC
          INC       PATMA1FD/INC
          INC       PATMI1FD/INC            reqd for surname search
          INC       PATMRGFD/INC
          INC       PATNIDFD/INC                                        D-90202
          INC       PATPNIFD/INC
          INC       PATPR1FD/INC            reqd for surname search
          INC       PATTRNFD/INC            *MRG                       *I-90202
          INC       PATURAFD/INC
          INC       PATURCFD/INC            * MRG                      *I-90202
          INC       PATVISFD/INC
          INC       PMSHCPFD/INC
          INC       PMSCEXFD/INC
          INC       PMSCEXTD/INC
          INC       PMSCURFD/INC
          INC       PMSDAUFD/INC
          INC       PMSEDWFD/INC
          INC       PMSPX2FD/INC            * PMI Master Extn.2          * I900
          INC       PMSPTDFD/INC
          INC       PMSRELFD/INC
          INC       PMSTLEFD/INC
          INC       PMSVX1FD/INC
          INC       TFILEVAR/INC
          INC       WATTR1FD/INC            * MRG                      *I-90202
          INC       WATTX1FD/INC            * MRG                      *I-90202
          INC       WEBERRFD/INC
          INC       WEBSECFD/INC
          INC       PMSTSPFD/INC
          INC       PMSUPDFD/INC
          INC       PMSEHBFD/INC
.
ACTION    DIM       1
ADD       DIM       2
AMM       DIM       2
AYY       DIM       2
ACC       DIM       2
ADMISSNO  DIM       8
ALTKEY35  DIM       35
BJDAY     FORM      3
CATEGORY  DIM       2
CATTC     INIT      "tc"
CJDAY     FORM      3
CMDLINE   DIM       70
CONFFILE  FILE      ASCII, FIXED=250
CURRDATE  DIM       8
DETNTREC  FORM      2
DIM4      DIM       4
DIM8      DIM       8
DIM10     DIM       10
DIM16     DIM       16
DIM20     DIM       20
DIM127    DIM       127
DBLQUOTE  INIT      "#"#""
F3A       FORM      3
FLDITMNO  FORM      3
FNAMEA    DIM       8
FNAMEB    DIM       8
FORM3     FORM      3
FORM8     FORM      8
FORMURNO  FORM      8
HTMLFILE  FIFO      ASCII, FIXED=250
LEGCFLAG  FORM      1
MESSPROC  INIT      "DGSRVPMI - Message Processed"    * dummy processed message
MRGURDAT  FORM      1                       * I CAR 41829
MRGODDAT  DIM       8                       * I CAR 41829
MTHNAM3   DIM       3
NMPNUMB   DIM       20
NZIBOLDA  FORM      1
NZIBVNEW  FORM      1
NZIBDOBS  FORM      1
NZOPTION  FORM      1
OLDURNO   DIM       8
OPERCODE  DIM       4
PMEDIXX   DIM       12                      * Composite of PMEDI+PTMXMCCD
QRYDATA   DIM       240
QRYNAME   DIM       9
SAVEDETL  FORM      1                                                    * I900
SAVEHOSP  DIM       3
SAVEPCTR  DIM       2
SAVEPHCP  DIM       10
SAVEPRAC  DIM       10
SAVERETN  FORM      1
SAVKEY16  DIM       16
SAVKEY19  DIM       19
SAVKEY25  DIM       25
SAVKEY28  DIM       28
SAVKEY32  DIM       32
SAVKEY35  DIM       35
ALIASSTS  DIM       1
SAVEUSR1  DIM       3
.
SAVESNAM  DIM       40
SAVEXFNM  DIM       40
SAVEXSNM  DIM       40
SAVETITL  DIM       4
SAVEPSEX  DIM       1
SAVEPDOB  DIM       8
SAVEPFGN  DIM       25
SAVEPMST  DIM       3
SAVEPREG  DIM       3
SAVEPCNT  DIM       3
SAVEPTYP  DIM       3
SAVEABRG  DIM       3
SAVEUSR7  DIM       3
SAVEMEDI  DIM       10
SAVEMCCD  DIM       2
SAVEMEDC  DIM       8
SAVECONP  DIM       1
SAVEUPRF  DIM       3
SAVEINTR  DIM       1
SAVELNG1  DIM       3
SAVEPRVI  DIM       3
SAVEFLDR  DIM       3
SAVESN16  DIM       1
SPPXUCC4  DIM       3
SPPXUCC5  DIM       3
SPPXATF1  DIM       80
SPPXATF2  DIM       80
SAVECUID  DIM       8
SAVECDAT  DIM       8
SAVECTIM  DIM       8
.
SVKEY115  DIM       115
SEC1      FORM      "00001"
SHUTDOWN  FORM      1
TEXTAREA  FORM      1
TILDA35   INIT      "~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~"
TIMEIS    DIM       8
URNUMBER  DIM       8
USERID    DIM       10
USERNAME  DIM       10
URCHKDGT  FORM      4
URWTARAY  INIT      "234567"
URNLNGTH  FORM      2
URCHKPRD  FORM      2
URNOWGHT  FORM      1
VAR       DIM       127
WLOTANAE  DIM       8
WLOTPACN  DIM       8
. ----------------------------------------------- * Start of addition   I-90202
. ----------------------------------------------- * reqd for WEBCHGUR  *I-90202
CODE      DIM       3
EXISTFL   FORM      1
LOGERR    FORM      "0"
NCCURNO   DIM       8
NEWURNO   DIM       8
NEWURNUM  DIM       8
OCCURNO   DIM       8
OTCNULET  FORM      1                  * Using Outpatient Referral
OURNO     DIM       8
SAVESIN7  DIM       1
SAVESIN8  DIM       1
SAVESIN9  DIM       1
SAVESN11  DIM       1
SAVEURNO  DIM       8
SAVNMPI   DIM       20
WEBTITLE  DIM       80
XXDESC    DIM       80
XXFILE    DIM       8
. ----------------------------------------------- * End of addition     I-90202
.
DGNUMENQ  FORM      5       * no. enquiry requests
DGNUMREG  FORM      5       * no. register requests
DGNUMUPD  FORM      5       * no. update requests
DGNUMEAL  FORM      5       * no. enquiry alias requests
DGNUMUAL  FORM      5       * no. update alias requests
DGNUMSER  FORM      5       * no. surname search requests
DGNUMALR  FORM      6       * no. alerts requests
DGNUMMRG  FORM      5       * no. merge URs                            *I-90202
.
JAN       INIT      "January"
FEB       INIT      "February"
MAR       INIT      "March"
APR       INIT      "April"
MAY       INIT      "May"
JUN       INIT      "June"
JUL       INIT      "July"
AUG       INIT      "August"   
SEP       INIT      "September"
OCT       INIT      "October"  
NOV       INIT      "November"
DEC       INIT      "December"
.
.
.-----------------------------------------------------------------------
PRGID     INIT      "DGSRVPMI"                                           * C900
PRGNAM    INIT      "PROCESS DATAGATE MESSAGE REQUESTS"
VERSION   INIT      "V12.00.02"
.-----------------------------------------------------------------------
+
.*************************************************************************
.*  Start of Program                                      Go Tigers!     *
.*************************************************************************
DGRED000  CALL      SETX0000                      * set up common
.
          CALL      DISPHEAD                      * IBA CarrotCare header
          CALL      DGINI000                      * initialisation
          BRANCH    EXIT,DGRED900                 * initialisation failure
          CALL      DRAW0000                      * draw box & screen layout
.
DGRED010  CALL      USTAT000                      * update stats on screen
.
. sit & wait for an incoming message from the outbound comms client
.
          READ      DGATEOUT;CCENCODE:
                             DGMISC1,DGMISC2,DGMISC3;  * get message type
          GOTO      DGRED900 IF OVER              * Shutdown performed?
          UNPACK    CCENCODE,CCDATE,CCSRC,CCDST,CCNAME,MESSTYPE
.
.>>>>>    BEGIN                                   * start of commit/rollback
.
          DISPLAY   *P23:10,*V2LON,*HON,"Processing":
                    *HOFF,SP1,*V2LON,"(",MESSTYPE,")"
.
. check type of message
.
          MATCH     "REG",MESSTYPE                * Register?
          GOTO      DGRED120 IF EQUAL
          MATCH     "ENQ",MESSTYPE                * Enquiry?
          GOTO      DGRED130 IF EQUAL
          MATCH     "UPD",MESSTYPE                * Update?
          GOTO      DGRED140 IF EQUAL
          MATCH     "EAL",MESSTYPE                * Enquiry Alias?
          GOTO      DGRED150 IF EQUAL
          MATCH     "UAL",MESSTYPE                * Update Alias?
          GOTO      DGRED160 IF EQUAL
          MATCH     "SER",MESSTYPE                * Patient Search?
          GOTO      DGRED170 IF EQUAL
          MATCH     "ALR",MESSTYPE                * Alerts?
          GOTO      DGRED180 IF EQUAL
          MATCH     "MRG",MESSTYPE                * Merge URs          *I-90202
          GOTO      DGRED190 IF EQUAL                                  *I-90202
.
. invalid message type sent
.     NB.  SP1 at end of reply has been added because the interpreter does
.     not place a "|" after the last field, and Datagate requires this.  By
.     putting an extra field on the end (which is blank), a "|" will then
.     be added after the last field.
.
          READ      DGATEOUT;CDGMBUFF            * clear message buffer
.
          MOVE      "00010",RPLYCODE
          MOVE      "Invalid Message type",RPLYDESC
          PACK      CCENCODE,CCDATE,CCDST,CCSRC,CCNAME,REPLYRPL
          WRITE     DGATEIN;CCENCODE:
                            RPLYHEAD,RPLYCODE,RPLYDESC,DGMISC1,DGMISC2,DGMISC3:
                            SP1
.
          WRITE     DGATEOUT;MESSPROC       * tell Dgate that message processed
          GOTO      DGRED010                * get next message
.
. --- process each message type ---
.
DGRED120  CALL      DGPMIREG                      * Register patient
          ADD       ONE,DGNUMREG                  * # register counter
          GOTO      DGRED600
.
DGRED130  CALL      DGPMIENQ                      * Patient Enquiry
          ADD       ONE,DGNUMENQ                  * # enquiry counter
          GOTO      DGRED600
.
DGRED140  PROC      DGPMIUPD                      * Update patient details
          ADD       ONE,DGNUMUPD                  * # update counter
          GOTO      DGRED600
.
DGRED150  PROC      DGPMIEAL                      * Enquiry on Alias's
          ADD       ONE,DGNUMEAL                  * # enquiry alias counter
          GOTO      DGRED600
.
DGRED160  PROC      DGPMIUAL                      * Update Alias's
          ADD       ONE,DGNUMUAL                  * # update alias counter
          GOTO      DGRED600
.
DGRED170  PROC      DGPMISER                      * Patient Search
          ADD       ONE,DGNUMSER                  * # update search counter
          GOTO      DGRED600
.
DGRED180  PROC      DGPMIALR                      * Patient Alerts
          ADD       ONE,DGNUMALR                  * # update alerts counter
          GOTO      DGRED600
.
DGRED190  PROC      DGPMIMRG                      * Merge URs          *I-90202
          ADD       ONE,DGNUMMRG                  * # update merge counter
          GOTO      DGRED600                                           *I-90202
.
. if all is ok write/update (COMMIT), else if error along the way (ROLLBACK)
.
DGRED600  
.>>>>>    MATCH     "00000",RPLYCODE              * successful?
.>>>>>    IF        @EQUAL
.>>>>>      COMMIT                                * write/update all files
.>>>>>    ELSE
.>>>>>      ROLLBACK                              * error. DONT write/update
.>>>>>    ENDIF
.
          WRITE     DGATEOUT;MESSPROC       * tell DGate that message processed
          GOTO      DGRED010                * get next message
.
. finished
.
DGRED900  CALL      SHUTM000                      * shutdown message if shutdown
          TRAPCLR   INT                           * clear traps
          CLOSE     DGATEIN                       * close inbound datagate file
          CLOSE     DGATEOUT                      * close outbound datagate file
.
DGRED999  STOP
+
.************************************************************************
.*  SHUTM000  :  give user shutdown message if server has gone down     *
.************************************************************************
SHUTM000  IF        SHUTDOWN=0
            DISPLAY   *P1:24,*EL,*B,"Server has been shutdown.  ";
            CALL      HITENTER
          ENDIF
.
SHUTM999  RETURN
+
.************************************************************************
.*  DGINI000  :  initialisation                                         *
.************************************************************************
DGINI000  DISPLAY   *P1:4,*EF
.
          BOX       16,23,10,57,14
          DISPLAY   *P26:12,"Opening Server... Please Wait"
.
          OPEN      CONTROLF,"controlf"
.
. read system parameters
.
          READ      CONTROLF,TEN;*213,CAUDM
          READ      CONTROLF,TEN9;*208,CPMIAD
          READ      CONTROLF,TWENTY1;*138,PTCNNHII
          READ      CONTROLF,FIFTY9;*86,CDETENTE,*216,PTPRVALS,*234,PTCNNMPI 
          READ      CONTROLF,SEVENTY9;*139,PTCNDPSI,*159,PTCNDPSO
          READ      CONTROLF,HUND12;*118,PTCNTRPR
.
. open files for pmi requests
.
          OPEN      PATMA1A1,"patma1af"
          OPEN      PATMA1A2,"patma1af"
          OPEN      PATMX1A1,"patmx1af"
          OPEN      PMSPX2A1,"pmspx2af"                                  * I900
          OPEN      PATCODE1,"patcodes"
....      OPEN      PATNIDA1,"patnidaf"                                 D-90202
          OPEN      PATNIDA2,"patnidaf"
          OPEN      PATVISA2,"patvisaf"
          OPEN      PATHSPA1,"pathspaf"
.
          OPEN      PATGSRN1,"patgsrnf"
          OPEN      PATGSRN2,"patgsrnf"
          OPEN      PATGSRN3,"patgsrnf"
          OPEN      PATGSRN4,"patgsrnf"
.
          IF        CAUDM<>1
            OPEN      PATAM1A1,"patam1af"
            OPEN      PMSAUDPX,"pmsaudpx"                                * I900
          ENDIF
.
. initialise vars
.
          MOVE      ZERO,SUCCPROC
          MOVE      ZERO,ERRRPROC
.
          MOVE      ZERO,DGNUMREG
          MOVE      ZERO,DGNUMENQ
          MOVE      ZERO,DGNUMUPD
          MOVE      ZERO,DGNUMEAL
          MOVE      ZERO,DGNUMUAL
          MOVE      ZERO,DGNUMSER
          MOVE      ZERO,DGNUMALR
          MOVE      ZERO,DGNUMMRG
.
          MOVE      CDATE,APSTDATE                * application start date
          CLOCK     TIME,APSTTIME                 * application start time
.
. open the inbound data gate file
.
          MOVE      ZERO,OVRCD              * assume open succeeds
          STRIP     PTCNDPSI
          TRAP      OVERCOND IF IO          * trap if open fails
          OPEN      DGATEIN,PTCNDPSI
          TRAPCLR   IO
          BRANCH    OVRCD,DGINI900
.
. open the outbound data gate file
.
          MOVE      ZERO,OVRCD              * assume open succeeds
          STRIP     PTCNDPSO
          TRAP      OVERCOND IF IO          * trap if open fails
          OPEN      DGATEOUT,PTCNDPSO
          TRAPCLR   IO
          BRANCH    OVRCD,DGINI910
.
          MOVE      ZERO,SHUTDOWN                 * assume no shutdown
          TRAP      FINDE000 IF INT
.
. trap IO errors (ie. I*C, I*D, I*L etc... & PARITY & SPOOL & CHAIN & etc...)
.
          TRAP      ADTER000 NORESET GIVING RPLYDESC IF ALL
.
          CALL      TFILENAM                     * get new tempfile name
          MOVE      TFILNAME,FNAMEA
.
          CALL      TFILENAM                     * get new tempfile name
          MOVE      TFILNAME,FNAMEB
.
          MOVE      ZERO,EXIT               * initialisation succeeded
          GOTO      DGINI999
.
.         Initialisation failure - datagate inbound service
.
DGINI900  DISPLAY   *P1:24,*EL,*B,"Service [",*+,PTCNDPSI:
                    "] not currently available.  ";
          CALL      HITENTER
          MOVE      ONE,EXIT
          GOTO      DGINI9999
.
.         Initialisation failure - datagate outbound service
.
DGINI910  DISPLAY   *P1:24,*EL,*B,"Service [",*+,PTCNDPSO:
                    "] not currently available.  ";
          CALL      HITENTER
          MOVE      ONE,EXIT
          GOTO      DGINI9999
.
DGINI999  RETURN
+
.************************************************************************
.*  DRAW0000  :  draw box                                               *
.************************************************************************ 
DRAW0000  DISPLAY   *P1:4,*EF
          BOX       16,3,6,78,23
          DISPLAY   *P30:6,*HON,*V2LON," MESSAGE STATISTICS "
.
          DISPLAY   *P5:8,"Application Activated on ",*V2LON,APSTDATE,*HOFF:
                    "  @  ",*V2LON,APSTTIME,*HOFF:
                    *P5:10,"Current status... ",*V2LON,*HON,"Waiting"
          HLINE     *G37,11,3,78
          HLINE     *G33,11,3,3
          HLINE     *G34,11,78,78
          DISPLAY   *P5:12,*V2LON,*ULON,"Number of requests       ",*HOFF:
                    *P41:12,*V2LON,*ULON,"Number of requests       ",*HOFF:
                    *P5:13,"Register          : ",*V2LON,DGNUMREG,*HOFF:
                    *P5:14,"Update PMI        : ",*V2LON,DGNUMUPD,*HOFF:
                    *P5:15,"Update Alias      : ",*V2LON,DGNUMUAL,*HOFF:
                    *P5:16,"Enquiry PMI       : ",*V2LON,DGNUMENQ,*HOFF:
                    *P5:17,"Enquiry Alias     : ",*V2LON,DGNUMEAL,*HOFF:
                    *P5:18,"Surname search    : ",*V2LON,DGNUMSER,*HOFF:
                    *P5:19,"Lock PMI          : ",*V2LON,DGNUMUPD,*HOFF:
                    *P41:13,"Update Alerts        : ",*V2LON,DGNUMALR,*HOFF:
                    *P41:14,"Merge URs            : ",*V2LON,DGNUMMRG,*HOFF
.
          MOVE      ZERO,SUCCPERC
          IF        !(SUCCPROC=0 & ERRRPROC=0)
            ASSIGN    (SUCCPROC/(SUCCPROC+ERRRPROC)*100.0),SUCCPERC
          ENDIF
.
          DISPLAY   *P5:21,"Successfully Processed   : ",*V2LON,SUCCPROC,*HOFF:
                    *P5:22,"Unsuccessfully Processed : ",*V2LON,ERRRPROC,*HOFF:
                    *P45:22,"Successful % = ",*V2LON,SUCCPERC
.
DRAW9999  RETURN
+
.************************************************************************
.*  FINDE000  :  draw box & display stats                               *
.************************************************************************ 
FINDE000  MOVE      ONE,SHUTDOWN                  * shutdown recieved
.
FINDE999  RETURN
+
.************************************************************************
.*  USTAT000  :  update stats on screen                                 *
.************************************************************************ 
USTAT000  DISPLAY   *P23:10,*V2LON,*HON,"Waiting",*HOFF,SP30:
                    *P25:13,*V2LON,DGNUMREG:
                    *P25:14,DGNUMUPD:
                    *P25:15,DGNUMUAL:
                    *P25:16,DGNUMENQ:
                    *P25:17,DGNUMEAL:
                    *P25:18,DGNUMSER:
                    *P25:19,DGNUMUPD:
                    *P64:13,DGNUMALR:
                    *P64:14,DGNUMMRG                                   *I-90202
.
          MOVE      ZERO,SUCCPERC
          IF        !(SUCCPROC=0 & ERRRPROC=0)
            ASSIGN    (SUCCPROC/(SUCCPROC+ERRRPROC)*100.0),SUCCPERC
          ENDIF
.
          DISPLAY   *P34:21,*V2LON,SUCCPROC:
                    *P34:22,ERRRPROC:
                    *P60:22,SUCCPERC
USTAT999  RETURN
+
.******************************************************************************
. PNMP0000  :  Post NMPI Number
.              Parameter : PURNO   (U/R Number) 
.                          PVIBILL (Visit Number) 
.                          NMPNUMB (NMPI Number)
.******************************************************************************
PNMP0000  COMPARE   ZERO,PTCNNMPI
          GOTO      PNMP9999 IF EQUAL            * not using link
          COMPARE   ONE,PTCNNHII
          GOTO      PNMP9999 IF EQUAL            * using NZ link
.
          OPEN      PATPNIA1,"patpniaf"          * Zero U/R Number 
          OPEN      PATNIDA1,"patnidaf"          * all other countries
.
.         Check whether a nmpi number has been input, if one has 
.         write it to the PNI/NID/NMP file, otherwise do nothing
.
          MATCH     NMPNUMB,SP20
          GOTO      PNMP5000 IF EQUAL            * no number entered
.
          MATCH     ZEROUR,PURNO
          GOTO      PNMP3000 IF NOT EQUAL
.
.         Zero U/R :: post to PATPNI file
.
          MATCH     ZEROVISN,PVIBILL
          GOTO      PNMP9000 IF EQUAL
.
.         Zero Billing Number DO NOT POST TO PNI FILE OR NMP FILE
.
          PACK      KEY10,CHOSINDX,PVIBILL   * Hospital No. and visit No.
          CALL      RDPTPNI1
          MOVE      CHOSINDX,PTPNHNUM        * Hospital No.
          MOVE      PVIBILL,PTPNADNO         * Admission No.
          MOVE      NMPNUMB,PTPNNMPI         * National Id
          IF        OVRCD = ONE
            CALL      WRPTPNI1               * Write record does not exist
          ELSE
            CALL      UPPTPNI1               * Update record exists
          ENDIF
          GOTO      PNMP9000
.
.         A valid U/R :: post to PATNMP/PATNID file
.
PNMP3000  PACK      KEY10,CHOSINDX,PURNO
          CALL      RDPTNID1
          BRANCH    OVRCD,PNMP4000
.
          MOVE      NMPNUMB,PTNINMPI         * National Id
          CALL      UPPTNID1                * Update File
          GOTO      PNMP9000
.
PNMP4000  PACK      KEY10,CHOSINDX,PVIBILL
          CALL      RDPTPNI1                  * Exist on PNI file ?
          IF        OVRCD = ONE
            MOVE      CHOSINDX,PTNIHNUM       * No. hospital number
            MOVE      PURNO,PTNILNUM          *     local U/R Number
.
            SQUEEZE   NMPNUMB                 * left justify field
            PACK      NMPNUMB,NMPNUMB,SP20    * clear rest of field 
            STRIP     NMPNUMB                 * remove blanks
            MOVELPTR  NMPNUMB,FORM2           * get the actual length
.
            MOVE      SP20,PTNINMPI           * clear the actual field
            ASSIGN    20-FORM2,IMON           * get the No. blanks at start
            RESET     PTNINMPI,IMON           * reset actual field
            APPEND    NMPNUMB,PTNINMPI        * add items entered
            RESET     PTNINMPI                * this field is now Right Just.
            MOVE      SP10,PTNISPAR           *     set spare variable
            PACK      KEY10,CHOSINDX,PURNO    *     Reset Key
            CALL      WRPTNID1                *     Write NMP record
          ELSE
            MOVE      PTPNHNUM,PTNIHNUM       * Yes. copy hospital number
            MOVE      PURNO,PTNILNUM          *      copy local U/R Number
            MOVE      PTPNNMPI,PTNINMPI       *      copy nmpi U/R No.
            MOVE      SP10,PTNISPAR           *      set spare variable
            PACK      KEY10,CHOSINDX,PURNO    *      Reset Key
            CALL      WRPTNID1                *      Write NMP record
            PACK      KEY10,CHOSINDX,PVIBILL   * Hospital No. and visit No.
            CALL      DEPTPNI1                *      delete PNI record
          ENDIF  
          GOTO      PNMP9000
.
.         Nothing input. Check if there was previously details, and if so,
.         delete them
.
PNMP5000  MATCH     ZEROUR,PURNO             * Zero U/R Number
          IF        @EQUAL
            PACK      KEY10,CHOSINDX,PVIBILL
            CALL      DEPTPNI1
          ENDIF
          PACK      KEY10,CHOSINDX,PURNO   * All other countries
          CALL      DEPTNID1
.
PNMP9000  CLOSE     PATPNIA1                 * Zero U/R
          CLOSE     PATNIDA1                 * all other countries
.
PNMP9999  RETURN
+
.****************************************************************************
.*  SPLTPMED  :  Routine to split PMEDI & PTMXCCD from PMEDIXX              *
.****************************************************************************
SPLTPMED  UNPACK    PMEDIXX,PMEDI,PTMXMCCD  *
          RJUSTIFY  PTMXMCCD                * Right justify PTMXCCD
.
SPLT9999  RETURN
.
.************************************************************************
.*  ADTER000  :  send general error reply and shutdown                  *
.************************************************************************ 
.
. this routine will be executed when there is a TBL error, ie. I*C...
. and send an error reply to datagate and then exit the TBL application
.
ADTER000  ROLLBACK
.
          ENDSET    RPLYDESC
          APPEND    SP4,RPLYDESC
          APPEND    PRGID,RPLYDESC
          APPEND    SP2,RPLYDESC
          APPEND    VERSION,RPLYDESC
          APPEND    "(",RPLYDESC
          APPEND    MESSTYPE,RPLYDESC
          APPEND    ")",RPLYDESC
          RESET     RPLYDESC
.
          MOVE      "00100",RPLYCODE             * general error (TBL error)
          PACK      CCENCODE,CCDATE,CCDST,CCSRC,CCNAME,REPLYRPL
          WRITE     DGATEIN;CCENCODE:
                            RPLYHEAD,RPLYCODE,RPLYDESC:
                            DGMISC1,DGMISC2,DGMISC3,SP1
.
          RESET     ANS
          BOXCLR    8,9,72,15
          BOX       16,10,10,70,14
          DISPLAY   *P19:11,*V2LON,"FATAL ERROR!   Transaction not processed.":
                    *P15:12,*ULON,RPLYDESC:
                    *P17:13,*HOFF,*V2LON,"Please Contact IBA Support.  ":
                    "<< Hit any key >>";
          KEYIN     *ESON,*+,ANS
.
          CLOSE     DGATEIN                 * close inbound datagate file
          CLOSE     DGATEOUT                * close outbound datagate file
.
ADTER999  STOP
.
.
. End of Program
.
          INC       STD002IO
          INC       ACTMSAV
          INC       CLPATMIS                * MRG                      *I-90202
          INC       CLPMSDAU
          INC       CLPMSPX2                * MRG                      *I-90202
          INC       DEATHAUD
          INC       SVPMSPX2                * MRG                      *I-90202
          INC       TFILENAM
.
          INC       AAEDE1IO/INC            * MRG                      *I-90202
          INC       ALLEDTIO/INC
          INC       ALLETXIO/INC
          INC       ALLLINIO/INC
          INC       ALLLONIO/INC
          INC       ALLPCTIO/INC
          INC       ALLREFIO/INC            * MRG                      *I-90202
          INC       BOKRC1IO/INC
          INC       DGTRPLIO/INC
          INC       EMRVISIO/INC            * MRG                      *I-90202
          INC       LEGALTIO/INC
          INC       LEGBOAIO/INC
          INC       LEGDEAIO/INC
          INC       LEGDSCIO/INC
          INC       LEGINVIO/INC
          INC       LEGMISIO/INC
          INC       LEGTRNIO/INC
          INC       LEGVISIO/INC
          INC       MEHVI1IO/INC
          INC       MRTMASIO/INC            * MRG                      *I-90202
          INC       NHIETHIO/INC
          INC       OUTARTIO/INC
          INC       PATALRIO/INC
          INC       PATAM1IO/INC
          INC       PATAXEIO/INC            * MRG                      *I-90202
          INC       PATCODIO/INC
          INC       PATDO1IO/INC
          INC       PATDSCIO/INC            * MRG                      *I-90202
          INC       PATECDIO/INC
          INC       PATFN1IO/INC
          INC       PATGSRIO/INC
          INC       PATHSPIO/INC
          INC       PATINVIO/INC
          INC       PATLOCIO/INC
          INC       PATMA1IO/INC
          INC       PATNIDIO/INC                                        D-90202
          INC       PATPNIIO/INC
          INC       PATTRNIO/INC            * MRG                      *I-90202
          INC       PATURAIO/INC
          INC       PATURCIO/INC            * MRG                      *I-90202
          INC       PATVISIO/INC
          INC       PMSDAUIO/INC
          INC       PMSEDWIO/INC
          INC       PMSHCPIO/INC
          INC       PMSCURIO/INC
          INC       PMSPX2IO/INC            * Extn 2 of PATMA1           * I900
          INC       PMSPTDIO/INC
          INC       PMSVX1IO/INC
          INC       WATTR1IO/INC            * MRG                      *I-90202
          INC       WATTX1IO/INC            * MRG                      *I-90202
          INC       WEBERRIO/INC
          INC       WEBSECIO/INC
          INC       PMSTSPIO/INC
          INC       PMSUPDIO/INC
          INC       WEBCHGUR                * MRG                      *I-90202
          INC       PATCOMN2
          INC       PMSEHBIO/INC
.
          INC       PMSOSDTM
          INC       DGPMIENQ
          INC       DGPMIREG
          INC       DGPMIUPD
          INC       DGPMIEAL
          INC       DGPMIUAL
          INC       DGPMISER
          INC       DGPMIALR
          INC       DGPMIMRG                * MRG                      *I-90202
          INC       SEPRNAME
NZIBSRCH
GETSVAR
NZCLR000
 RETURN
.
 INC PATSRCH
 INC CLPATMAS
 INC CALCAGE
 INC OUTPREIO/INC
 INC       PATPR1IO/INC
 INC       PATMI1IO/INC
 INC NHIMASIO/INC
     INC DGCLICUP                                                      *C-90201
     INC PMIGTNID
. ----------------------------------------------- * Start of addition   I-90202
.****************************************************************************
.*  WERR0000  :  Dummy routine to bypass WEB Browser                        *
.****************************************************************************
WERR0000
WEBERR00  MOVE      ZERO,OVRCD
          RETURN
.
.*****************************************************************************
.*                        DUMMY DG Broadcast Procedures
.*      This allows use of standard Production code to update Databases, but
.*      to stop that code re-broadcasting the change back to Datagate
.*****************************************************************************
          DEFPROC   DGCLICMR                * Medical Records Broadcast Msg
...       MOVE      ZERO,OVRCD
          ENDPROC
. ----------------------------------------------- * End of addition     I-90202
 XIF
.
