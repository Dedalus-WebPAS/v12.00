.******************************************************************************
.*               P R O G R A M  S U M M A R Y                                 *
.*               -------------  -------------                                 *
.*                                                                            *
.*      PROGRAM NAME:     NZPBIL23                                            *
.*                                                                            *
.*      FUNCTION:         AGED TRIAL BALANCE                                  *
.*                                                                            *
.*      DATE WRITTEN:     02/06/86                                            *
.*                                                                            *
.*      AUTHOR:           MALCOLM HAYSE (I.B.A)                               *
.*                                                                            *
.*      MODIFICATIONS:                                                        *
.******************************************************************************
.*        V12.00.01 19/05/2025  J.Tan          TSK 0955096                    *
.*                  Added alpanumeric visit number generation                 *
.*        V11.04.01 06.02.2024  DA Sarkies    TSK 0936282                     *
.*                  Increased size of space going into Health Fund Number     *
.*                  Added truncation to the printout                          * 
.******************************************************************************
.*        V10.11.02 27/11/2017  Thanh T.      TSK 0821710                     *
.*                  Recompiled as PATMISTD changed                            *
.*        V10.11.01 15/09/2017  Thanh T.      TSK 0821710                     *
.*                  Audit Amission/outpatient visit comments                  *
.******************************************************************************
.*        V10.04.01 08/04/2013 J.Tan          CAR 261630                      *
.*                  Removed port number from temp file name                   *
.*        V10.00.01 13/05/2010  Saroeun Soeur CAR 221737                      *
.*                  fixed age trial balance comment error, clear VSCTDATA if  *
.*                  blank
.*        V9.12.01  21/08/2009  Saroeun Soeur CAR 203057                      *
.*                  fixed billing comment repeating on other admissions       *
.*        V9.10.01  17/07/2008  J.Tan         CAR                             *
.*                  Mods to eff.date or released date for Cash cutoff date    *
.*        V9.08.03  30/04/2007  J.Tan         CAR 167215                      *
.*                  Mods to incl.Credit notes for checking outstanding balance*
.*        V9.08.02  23/02/2007  J.Tan         CAR 130462                      *
.*                  Mods to JH GST                                            *
.*        V9.08.01  09/02/2007  J.Tan         CAR 120001                      *
.*                  Mods for NZ Private billing                               *
.*        V9.07.02  12/09/2006  Jill Habasque CAR 109852                      *
.*                  Mods to output alternate ID if PTCNDAUR=1                 *
.*        V9.07.01  18/08/2007  J.Tan  CAR 103365                             *
.*                  Mods for Johns Hopkins discount                           *
.*        V9.05.01  10/03/2006  Mike Laming   CAR 79281                       *
.*                  Increase PATFACT1 to KEY19 & add FACODE to key string     *
.*        V9.04.06  14/10/05 J.Tan    CAR 77320                               *
.*                  Fixed setting as at date                                  *
.*        V9.04.05  03/08/05 J.Tan    CAR 62750                               *
.*                  Removed redefined amount variables                        *
.*                  02/09/2005  J.Tan             CAR 74612                   *
.*                  Added parameter to print billing comments                 *
.*        V9.04.04  29/07/2004 J.Tan  CAR 67940                               *
.*                  Fixed outstanding invoice amount with GST journals        *
.*        V9.04.03  14/09/2004 J.Tan  CAR 52687                               *
.*                  Mods to default health fund from master file              *
.*        V9.04.02  23/08/2004 J.Tan   CAR 52835                              *
.*                  Mods for multi hospital                                   *
.*        V9.04.01  13/08/2004 J.Tan   CAR 52603                              *
.*                  Mods checking for credit notes date                       *
.******************************************************************************
.*        V9.03.03  13/08/2003 Lina Vo      CAR 41196                         *
.*                  Recompiled for big change in PATSELFN.                    *
.*        V9.03.02  03/07/2003 Dean Cramer  CAR 38200                         *
.*                  Fix claim total and overall totals re overlap             *
.*        V9.03.01  04/06/2003 Dean Cramer  CAR 38200                         *
.*                  Fix where embedded spaces sometimes in date               *
.*                  Fix print overlaps for web                                *
.*                  Reformat amount lines to fit larger amounts               *
.*        V9.02.05  25/04/2003 Dean Cramer  CAR 38200                         *
.*                  Make totals print vertically rather than horizontally due *
.*                  to space considerations                                   *
.*        V9.02.04  04/04/2003 Dean Cramer  CAR 36515                         *
.*                  Tidy entry screens for web                                *
.*        V9.02.03  24/12/2002 J.Tan  SRF 34844                               *
.*                  Mods PRCM0000 to print 1st line of comment(latest)on full *
.*        V9.02.02  29/09/2001  J.Tan                                         *
.*                  Commented out validating aaedet file                      *
.*        V9.02.01  28/09/2001  Davin  SRF 12322                              *
.*                  Copied correct version from tran 508!                     *
.*        V5.08.08  01/06/2001  Caleb Sharman                                 *
.*                  Mods to use CNYRKYIN & CNYRPAT (dim 4's instead of form 2)*
.*                  within the URLOOP3                                        *
.*        V5.08.07  06/03/2001  Jill Habasque SRF 8634                        *
.*                  Added check for TRECTYPE=6                                *
.*        V5.08.06  06/03/2001  Jill Habasque SRF 8634                        *
.*                  Fixed F*I - health fund table length                      *
.*        V5.08.05  06/12/2000  Caleb Sharman                                 *
.*                  Mods to use keyin routines for claim and health funds     *
.*        V5.08.04  16/08/2000  Caleb Sharman                                 *
.*                  Changed Health Fund variables to be 8 chars               *
.*        V5.08.03  06/06/2000  Jill Habasque                                 *
.*                  Changed from key10 to key14 for the health fund file      *
.*        V5.08.02  01/05/2000  J.Tan                                         *
.*                  Fixed report for not using Aust.GST                       *
.*        V5.08.B04 14/04/2000  Jill Habasque                                 *
.*                  Fixed printing of Start & Finish                          *
.*        V5.08.B03 29/03/2000  Steve Downing                                 *
.*                  Fixed surname sequence for names longer than 6 letters    *
.*        V5.08.B02 18/02/2000  J.Tan                                         *
.*                  Mods to include GST                                       *
.*        V5.08.B01 24/01/2000  Steve Armstrong                               *
.*                  Fixed global recompile errors                             *
.******************************************************************************
.*        V5.07.04  12/11/1999  J.Tan                                         *
.*                  Mods to check outstanding for 30,60,90 breakup(WRTEFUL)   *
.*        V5.07.03  23/07/1999  Steve Downing                                 *
.*                  Included century in invoice date calculations             *
.*        V5.07.02  13/07/1999  Greg Horvat                                   *
.*                  Replaced certain variables & with KEY variables           *
.*        V5.07.01  19/02/1999  Jim Stathopoulos                              *
.*                  Report Modifications                                      *
.*     V5.07.B02&3  22/01/1999  Nicole Harrington  507 rebound 115            *
.*                  Mods to print century on dates                            *
.*       V5.07.B01  10/11/1998  Jim Stathopoulos                              *
.*                  507 Changes                                               *
.******************************************************************************
.*        V5.04.01  15/04/97 J.Tan                                            *
.*                  Mods to set endnam                                        *
.*        V5.03.04  20/12/95 J.Tan         SRF 613189                         *
.*                  Fixed to print aae discharge date                         *
.*        V5.03.03  14/11/1995  Greg Horvat      Quote 8486 (Rebound)         *
.*                  Changed to print the admin comments at the end of each    *
.*                  admin when printing a report layout other than the full   *
.*                  report layout                                             *
.*        V5.03.02  03/10/95  MATT                          QUOTE 8486        *
.*                  Added option to print last line from patient comments     *
.*                  file after patient details.                               *
.*        V5.03.B1  06/06/95  Paul Howells                  SRF 136735        *
.*                  Recompiled for PATSELFN                                   *
.*                                                                            *
.* ************************************************************************** *
.*                                                                            *
.*                     V5.01.01 05/07/89  S. O'Gorman                         *
.*                              Converted for N.Z.                            *
.*                     V5.01.02 04.09.89 S.Barcham                            *
.*                              Fix Looping                                   *
.*                     V5.01.03 26/09/89 Graeme Williams                      *
.*                              Changed totals only option as per user group  *
.*                              specs  SRF 102283                             *
.*                     V5.01.04 09/10/89 J.Tan                                *
.*                              Fix Separate page for each                    *
.*                              H.F. Option    SRF 102523                     *
.*                     V5.01.05 20/11/89 J.Tan                                *
.*                              Add financial option in PATSELFN   SRF 102252 *
.*                     V5.01.06 05/04/90 D.Di.Paola                           *
.*                              Fixed keying of range if using surname seq    *
.*                              09/04/90 D.Di.Paola                           *
.*                              Default surname range from Start to Finish    *
.*                              SRF 104533                                    *
.*                              11/04/90 D.Di.Paola                           *
.*                              Default claim type range from Start to Finish *
.*                     V5.01.07 23/05/90 J.Tan  SRF 104901                    *
.*                              Mods PATFN1FD                                 *
.*                     V5.01.08 11/07/90 Paul Duncan                          *
.*                              recomp for OUTBOA & OUTBOB                    *
.*                    V5.01.121 22/10/90 J.Tan   SRF 105269                   *
.*                              Added range of health fund                    *
.*                    V5.01.122 27/11/90 Glen Hobby                           *
.*                              Recompiled for changes to PATMX1FD            *
.*                    V5.01.123 15/05/92 DIG    SRF 113970                    *
.*                              Changed the keyin of as at date to use KEYDATE*
.*                    V5.01.124 22/05/1992  Graeme Williams                   *
.*                              Make sure is invoice is balanced if PINVBLCD  *
.*                              is set (just in case it's wrong)   SRF 114421 *
.*        V5.01.125 12/06/92  Graeme Williams               SRF 114865        *
.*                  Changes for 9 character misc items                        *
.*        V5.01.126 05/09/94  ROD                           SRF 132017        *
.*                  Fix F*I - Assumes PTELEP 12 chars but new file = 20 chars *
.*                  NB: This prgm needs to be modified for New Master file    *
.*                                                                            *
.******************************************************************************
.
+
          INC           STD001FD
          INC           IBASECFD/INC
          INC           IBAPASFD/INC
          INC           IBACONFD/INC
          INC           IBASEQFD/INC                 * Sequential Numbers File
          INC           TFILEVAR/INC                 * Generate Temp File Name
          INC           WEBERRFD/INC                 * Web Server Error Loggin
.
          INC           PATMI1FD/INC
          INC           VISMDTFD/INC
          INC           VISMTXFD/INC
          INC           PATMISTD/INC
          INC           VISCMTFD/INC
          INC           PATCODFD/INC
          INC           PATMA1FD/INC

          INC           PATDSCFD/INC
.
          INC           OUTSITFD/INC
          INC           OUTBOAFD/INC
          INC           OUTBB1FD/INC
          INC           AAEDE1FD/INC
          INC           AAEDEBFD/INC
          INC           AAEDI1FD/INC
.
          INC           PATHSPFD/INC
          INC           PATINVFD/INC
          INC           PATDTRFD/INC
          INC           OUTDTRFD/INC
          INC           AAEDTRFD/INC
.
          INC           PATREMFD/INC
          INC           PATFACFD/INC
          INC           PATFN1FD/INC
          INC           PATVISFD/INC
          INC           PMSVX1FD/INC
          INC           PMSCNOFD/INC
+
          INC           PATSELDT/INC
.
.                WORK AREA
.
SORTSTR   DIM       25
TEMPFILE  IFILE     SQL, FIXED=297, KEY=SORTSTR
PSTROL    FILE      ASCII, FIXED=256
TEMPSEQ   FILE      SQL, FIXED=297
.SORT1     INIT      "U1-17,71-79"
SORT1     INIT      "U1-25,71-79"
.SORT2     INIT      "U1-9,26-79,18-25"
SORT2     INIT      "U1-9,26-70,18-25,71-79"
SORT3     INIT      "U1-9,18-25,71-79"
.
.         Temporary file for detailed Aged Trial Balance
.
.Name     Type      Size   Physical  Start
.----     ----      ----   --------  -----
.ACLAIM   DIM        3        3        1
.HFUND    DIM        6        6        4
.XAURNO   DIM        8        8       10
.XAADMNO  DIM        8        8       18
.PSNAME   DIM        20       20      26
.PGNAME   DIM        25       25      46
.SORTDIM  DIM        1        1       71
.XUNIQUE  DIM        8        8       72
.PTITL    DIM        4        4       80
.PTELEP   DIM        12       12      84
.PINVAMT  FORM      12.2      8       96
.TINVNO   DIM        8        8      104
.XDAY     DIM        2        2      112
.XMON     DIM        2        2      114
.XYEAR    DIM        2        2      116
.XCENT    DIM        2        2      118
XTINVAMT  FORM      12.2      8      120
.AFUNDH   DIM        6        6      128
.AFNDTB   DIM        8        8      134
.AFNDMM   DIM        10       10     142
.PTELEB   DIM        12       12     152
.DDDAY    FORM       2        2      164
.DDMON    FORM       2        2      166
.DDYER    FORM       2        2      168
.DDCEN    FORM       2        2      170
CMNTLINE  DIM        70       70     172
.REMLSTL  DIM        3        3      242
.LSTLDAT  DIM        8        8      245
.SPINVTYP FORM       1        2      253
.SPINVSYS FORM       1        2      255
TEMP40    DIM        40       40     257
.                             EOR    297
.
.          Temporary file for full Aged Trial Balance
.
.Name     Type      Size   Physical  Start
.----     ----      ----   --------  -----
.ACLAIM   DIM        3        3        1
.HFUND    DIM        6        6        4
.XAURNO   DIM        8        8       10
.XAADMNO  DIM        8        8       18
.PSNAME   DIM        20       20      26
.PGNAME   DIM        25       25      46
.SORTDIM  DIM        1        1       71
.XUNIQUE  DIM        8        8       72
.DDDAY    FORM       2        2       80
.DDMON    FORM       2        2       82
.DDYER    FORM       2        2       84
.DDCEN    FORM       2        2       86
XTOTPAID  FORM      12.2      8       88
XTOTCURR  FORM      12.2      8       96
XTOT30    FORM      12.2      8      104
XTOT60    FORM      12.2      8      112
XTOT90    FORM      12.2      8      120
XTOT120   FORM      12.2      8      128
XTOT1YR   FORM      12.2      8      136
XTOT2YR   FORM      12.2      8      144
.ATYPE    DIM        3        3      152
.ADDAY    FORM       2        2      155
.ADMON    FORM       2        2      157
.ADYER    FORM       2        2      159
.ADCEN    FORM       2        2      161
XTOTOUT   FORM      12.2      8      163
.PINVREB  FORM      12.2      8      171
PINVPAT   FORM      12.2      8      179
XTREBCUR  FORM      12.2      8      187
XTPATCUR  FORM      12.2      8      195
XTREB30   FORM      12.2      8      203
XTPAT30   FORM      12.2      8      211
XTREB60   FORM      12.2      8      219
XTPAT60   FORM      12.2      8      227
XTREB90   FORM      12.2      8      235
XTPAT90   FORM      12.2      8      243
XTREB120  FORM      12.2      8      251
XTPAT120  FORM      12.2      8      259
XTSUBREB  FORM      12.2      8      267
XTSUBPAT  FORM      12.2      8      275
.SHFUND   DIM          9      9      283
.SACLM    DIM          3      3      292
.DIM2     DIM          2      2      295
.                             EOR    297
.
ADDAY     FORM      2
ADMON     FORM      2
ADYER     FORM      2
ADCEN     FORM      2
ASATDAY   FORM      3
ASATYER   FORM      2
ASATCC    FORM      2
ASATDATE  DIM       4 
CURRDATE  DIM       4
.
BD        INIT      "B-"
.
CATBLAY   FORM      1
CFEETYP   FORM      1                   * used for PATFNDKY
CHOSTYP   FORM      1
CJRNREP   FORM      1
CLMFUND   DIM       9
CMDLINE   DIM       80
CNYRKYIN  DIM       4
CNYRPAT   DIM       4
CODE      DIM       2
CODECL    INIT      "CL"
COUNT     FORM      3
XCT30     FORM     12.2
XCT60     FORM     12.2
XCT90     FORM     12.2
XCT120    FORM     12.2
XCT1YR    FORM     12.2
XCT2YR    FORM     12.2
XCTCURR   FORM     12.2
XCTPAID   FORM     12.2
XCTTOT    FORM     12.2
.
.CT30      FORM      8.2
.CT60      FORM      8.2
.CT90      FORM      8.2
.CT120     FORM      8.2
.CT1YR     FORM      8.2
.CT2YR     FORM      8.2
.CTCURR    FORM      8.2
.CTPAID    FORM      8.2
.CTTOT     FORM      8.2
.
CURSYS    FORM      1
CURSITE   DIM       6
.
D12PTELP  DIM       12
D12PTELB  DIM       12
DALERG    DIM       3 
DANS      DIM       3
DAYSINYR  FORM      5
DDDAY     FORM      2
DDMON     FORM      2
DDYER     FORM      2
DDCEN     FORM      2
DHOSP     DIM       3
DILLN     DIM       3
DIM2A     DIM       2
DIM3      DIM       3
DIM5      DIM       5
DIM6      DIM       6
DIM8      DIM       8
DIM9      DIM       9
DIM10     DIM       10
DIM11     DIM       11
DIM13     DIM       13
DIM14     DIM       14
DIM31     DIM       31
DIM37     DIM       37
DIM64     DIM       64
DINS      INIT      "(I)"
DSYST     DIM       30
DSYST0    INIT      "CONSOLIDATED REPORT           "
DSYST1    INIT      "ACCIDENT & EMERGENCY REPORT   "
DSYST2    INIT      "OUTPATIENTS REPORT            "
DSYST3    INIT      "INPATIENTS REPORT             "
DSYST4    INIT      "OTHER FINANCIAL REPORT        "
DOUTXTRA  DIM       30
DOUTALL   INIT      "ALL SITES                     "
DOUTSIT   INIT      "SITE : "
DOUTDEP   INIT      "DEPT : "
.
EDCLM     DIM       3
EDHFN     DIM       6
ENDFLAG   FORM      1
ENDNAM    DIM       20
.
FIVE9     FORM      "59"
FIRST     FORM      1
FNAMET    DIM       8
FORM5DAY  FORM      5
FORM12P2  FORM      12.2
FROMDATE  DIM       8        * FROM DATE IN (CCYYMMDD) FORMAT
FRCLM     DIM       6        * From Claim Code output
FRHFN     DIM       6        * From Health Fund output
FINISH    INIT      "Finish"
.
HD        INIT      "H-"
HFUND     DIM       6
XHT30     FORM     12.2
XHT60     FORM     12.2
XHT90     FORM     12.2
XHT120    FORM     12.2
XHT1YR    FORM     12.2
XHT2YR    FORM     12.2
XHTCURR   FORM     12.2
XHTPAID   FORM     12.2
XHTTOT    FORM     12.2
.
.HT30      FORM      8.2
.HT60      FORM      8.2
.HT90      FORM      8.2
.HT120     FORM      8.2
.HT1YR     FORM      8.2
.HT2YR     FORM      8.2
.HTCURR    FORM      8.2
.HTPAID    FORM      8.2
.HTTOT     FORM      8.2
.
LSTLDAT   DIM       8
.
OPCND     FORM      1
OPTION1   FORM      1
.
PDIM8     DIM       8
PDIM10    DIM       10
PNAME     DIM       22         * PGNAME.PSNAME
PGNAMEDS  DIM       12         * PGNAME SHORTENED
PGNAMED2  DIM       21         * PGNAME SHORTENED
PNAMEDIS  DIM       18         * PNAME SHORTENED
PNAMEDS2  DIM       20         * PNAME SHORTENED
PSNAMEDS  DIM       17         * PSNAME SHORTENED
PRTADCOM  FORM      1          * PRINT COMMENTS FLAG
PAGFUND   FORM      1
PTCNCATB  FORM      1
PTCNDAUR  DIM       1
.
SHFUND    DIM       9
SACLM     DIM       3
SAVADMNO  DIM       8
SAVCLM    DIM       3
SAVFUND   DIM       9          * Contains ACLAIM,HFUND
SEPCLM    FORM      1
SEPFUND   FORM      1
SORTDIM   DIM       1
SP12      INIT      "            "
STARTNM   DIM       20
STATUS    FORM      1
STCLM     DIM       3
STHFN     DIM       6
START     INIT      "Start "
STAR      INIT      "*"
.
.
TDATE     DIM       8        * ACTUAL TRANSLATED DATE (CCYYMMDD)
TDAY      FORM      3
TINVAMT   FORM      8.2
TINVNO    DIM       8
TMPPAID   FORM      12.2
TOCLM     DIM       6        * To Claim code output
TOHFN     DIM       6        * To Health Fund output
TODATE    DIM       8        * TO DATE IN (CCYYMMDD) FORMAT
.TOT30     FORM      7.2
.TOT60     FORM      7.2
.TOT90     FORM      7.2
.TOT120    FORM      7.2
.TOT1YR    FORM      7.2
.TOT2YR    FORM      7.2
.TOTCURR   FORM      7.2
TOTDAYS   FORM      12.2
TOTONLY   FORM      1
.TOTOUT    FORM      7.2
.TOTPAID   FORM      7.2
.
XTTOT30   FORM     12.2
XTTOT60   FORM     12.2
XTTOT90   FORM     12.2
XTTOT120  FORM     12.2
XTTOT1YR  FORM     12.2
XTTOT2YR  FORM     12.2
XTTOTCUR  FORM     12.2
XTTOTOUT  FORM     12.2
XTTOTPAY  FORM     12.2
.
.TTOT30    FORM      8.2
.TTOT60    FORM      8.2
.TTOT90    FORM      8.2
.TTOT120   FORM      8.2
.TTOT1YR   FORM      8.2
.TTOT2YR   FORM      8.2
.TTOTCURR  FORM      8.2
.TTOTOUT   FORM      8.2
.TTOTPAID  FORM      8.2
TYR       FORM      2
.
.    Melbourne clinic
.
PATPAID   FORM      12.2
HFPAID    FORM      12.2
.TREBCUR   FORM      7.2
.TPATCUR   FORM      7.2
.TREB30    FORM      7.2
.TPAT30    FORM      7.2
.TREB60    FORM      7.2
.TPAT60    FORM      7.2
.TREB90    FORM      7.2
.TPAT90    FORM      7.2
.TREB120   FORM      7.2
.TPAT120   FORM      7.2
.TSUBREB   FORM      7.2
.TSUBPAT   FORM      7.2
.
XCREBCUR  FORM     12.2
XCPATCUR  FORM     12.2
XCREB30   FORM     12.2
XCPAT30   FORM     12.2
XCREB60   FORM     12.2
XCPAT60   FORM     12.2
XCREB90   FORM     12.2
XCPAT90   FORM     12.2
XCREB120  FORM     12.2
XCPAT120  FORM     12.2
XCSUBREB  FORM     12.2
XCSUBPAT  FORM     12.2
.
.CREBCUR   FORM      7.2
.CPATCUR   FORM      7.2
.CREB30    FORM      7.2
.CPAT30    FORM      7.2
.CREB60    FORM      7.2
.CPAT60    FORM      7.2
.CREB90    FORM      7.2
.CPAT90    FORM      7.2
.CREB120   FORM      7.2
.CPAT120   FORM      7.2
.CSUBREB   FORM      7.2
.CSUBPAT   FORM      7.2
.COTHSFN   FORM      1
.
XHREBCUR  FORM     12.2
XHPATCUR  FORM     12.2
XHREB30   FORM     12.2
XHPAT30   FORM     12.2
XHREB60   FORM     12.2
XHPAT60   FORM     12.2
XHREB90   FORM     12.2
XHPAT90   FORM     12.2
XHREB120  FORM     12.2
XHPAT120  FORM     12.2
XHSUBREB  FORM     12.2
XHSUBPAT  FORM     12.2
.
.HREBCUR   FORM      7.2
.HPATCUR   FORM      7.2
.HREB30    FORM      7.2
.HPAT30    FORM      7.2
.HREB60    FORM      7.2
.HPAT60    FORM      7.2
.HREB90    FORM      7.2
.HPAT90    FORM      7.2
.HREB120   FORM      7.2
.HPAT120   FORM      7.2
.HSUBREB   FORM      7.2
.HSUBPAT   FORM      7.2
.
XTTREBCR  FORM     12.2
XTTPATCR  FORM     12.2
XTTREB30  FORM     12.2
XTTPAT30  FORM     12.2
XTTREB60  FORM     12.2
XTTPAT60  FORM     12.2
XTTREB90  FORM     12.2
XTTPAT90  FORM     12.2
XTTRE120  FORM     12.2
XTTPA120  FORM     12.2
XTTSUBRE  FORM     12.2
XTTSUBPA  FORM     12.2
.
.TTREBCUR  FORM      7.2
.TTPATCUR  FORM      7.2
.TTREB30   FORM      7.2
.TTPAT30   FORM      7.2
.TTREB60   FORM      7.2
.TTPAT60   FORM      7.2
.TTREB90   FORM      7.2
.TTPAT90   FORM      7.2
.TTREB120  FORM      7.2
.TTPAT120  FORM      7.2
.TTSUBREB  FORM      7.2
.TTSUBPAT  FORM      7.2
.
UNIQUE    FORM      8
.
XDAY1     DIM       2
XDAY2     DIM       2
XMON1     DIM       2
XMON2     DIM       2
XYEAR1    DIM       2
XYEAR2    DIM       2
XCENT1    DIM       2
XCENT2    DIM       2
XUNIQUE   DIM       8
XAURNO    DIM       8
XAADMNO   DIM       8
.
ZERO00    FORM      "0.00"
NINETY1   FORM      "91"
ONE21     FORM      "121"
ONE51     FORM      "151"
ONE81     FORM      "181"
THREE65   FORM      "365"
THREE66   FORM      "366"
SEVEN31   FORM      "731"
Z30       INIT      "zzzzzzzzzzzzzzzzzzzzzzzzzzzzzz"
.
.-----------------------------------------------------------------------
PRGID     INIT      "NZPBIL23"
PRGNAM    INIT      "Aged Trial Balance"
VERSION   INIT      "V12.00.01"
.-----------------------------------------------------------------------
+
.         START OF PROGRAM
.
          CALL          DISPHEAD
.
          DISPLAY       *P56:24,"Opening patmi1af";
          OPEN      PATMI1A1,"patmi1af"
.
          DISPLAY       *P64:24,"patma1af";
          OPEN      PATMA1A1,"patma1af"
.
          DISPLAY       *P64:24,"patmx1af";
          OPEN      PATMX1A1,"patmx1af"
.
          DISPLAY       *P64:24,"patinvrf";
          OPEN          PATINVR4,"patinvrf"
.
          DISPLAY       *P64:24,"patdschf";
          OPEN          PATDSCH1,"patdschf"
.
          DISPLAY       *P64:24,"patdtraf";
          OPEN          PATDTRA1,"patdtraf"
.
          DISPLAY       *P64:24,"aaedtref";
          OPEN          AAEDTRE1,"aaedtref"
.
          DISPLAY       *P64:24,"outsitaf";
          OPEN          OUTSITA1,"outsitaf"
.
          DISPLAY       *P64:24,"aaede1af";
          OPEN      AAEDE1A1,"aaede1af"
.
          DISPLAY       *P64:24,"aaedi1af";
          OPEN      AAEDI1A1,"aaedi1af"
.
          DISPLAY       *P64:24,"vismdtaf";
          OPEN          VISMDTA1,"vismdtaf"
          DISPLAY       *P64:24,"vismtxaf";
          OPEN          VISMTXA1,"vismtxaf"
.
          DISPLAY       *P64:24,"viscmtaf";
          OPEN          VISCMTA1,"viscmtaf"
.
          DISPLAY       *P64:24,"patremdf";
          OPEN          PATREMD1,"patremdf"
.
          DISPLAY       *P64:24,"patcodes";
          OPEN          PATCODE1,"patcodes"
.
          DISPLAY       *P64:24,"pmsvx1af";
          OPEN          PMSVX1A1,"pmsvx1af"
.
          DISPLAY       *P64:24,"patfactf";
          OPEN          PATFACT1,"patfactf"
.
          DISPLAY       *P64:24,"patfn1af";
          OPEN          PATFN1A1,"patfn1af"
.
          DISPLAY       *P64:24,"patvisaf";
          OPEN          PATVISA1,"patvisaf"
.
          DISPLAY       *P64:24,"pmscnoaf";
          OPEN          PMSCNOA3,"pmscnoaf"
.
          DISPLAY       *P64:24,"controlf";
          OPEN          CONTROLF,"controlf"
.
          READ          CONTROLF,ZERO;*43,IBCNMHOS,*85,IBCNUGST
          READ          CONTROLF,TEN3;*185,CATBLAY:
                                          *245,CHOSTYP
          READ          CONTROLF,TEN8;*255,CJRNREP
          READ          CONTROLF,TEN9;*212,CFEETYP
          READ          CONTROLF,HUND09;*243,PTCNCATB
+
.
.        START OF PROGRAM
.
.
START   MOVE      ZERO,CPAGENO
        MOVE      SIXTY TO CLNO
        MOVE      SP20 TO STARTNM
        MOVE      "zzzzzzzzzzzzzzzzzzzz" TO ENDNAM
        MOVE      SP6,FRCLM
        MOVE      SP6,TOCLM
        MOVE      SP6,FRHFN
        MOVE      SP6,TOHFN
.
        HLINE     *G37,2,49,80
        DISPLAY   *P1:3,*EF:
                  *P1:4,*V2LON,ZERO,*HOFF," = Exit":
                  *P1:5,*V2LON,ONE,*HOFF," = U/R Number Sequence":
                  *P1:6,*V2LON,TWO,*HOFF," = Patient Surname Sequence":
                  *P1:7,*V2LON,THREE,*HOFF," = Admission Number Sequence"
.
KEYSEQ  KEYIN     *P1:9,"Option : ",*EL,*V2LON,OPTION
.
        COMPARE   ZERO TO OPTION
        GOTO      ENDIT IF EQUAL
.
REPEAT  BRANCH    OPTION OF URSEQU,SURNAM,ADMSEQ
        BEEP
        GOTO      KEYSEQ
.
URSEQU  DISPLAY   *P49:2,*V2LON,"- U/R Sequence ",*P1:3,*EF
        MOVE      SORT1,SORTSTR
        GOTO      KEYCLM
.
ADMSEQ  DISPLAY   *P49:2,*V2LON,"- Admission Sequence ",*P1:3,*EF
        MOVE      SORT3,SORTSTR
        GOTO      KEYCLM
.
SURNAM  DISPLAY   *P49:2,*V2LON,"- Surname Sequence ",*P1:3,*EF
        MOVE      SORT2,SORTSTR
.
        MATCH     "IBARSH",PGM
        GOTO      KEYCLM IF EQUAL
.
        MOVE      SP20 TO STARTNM
        KEYIN     *P1:4,"Surname From : ":
                  *P1:5,*EL,"Surname To   : ",*P16:4,*V2LON,STARTNM
        RESET     STARTNM
        GOTO      KEYENDN IF NOT EOS
.
        MATCH    SP20,STARTNM
        GOTO     KEYENDN IF NOT EQUAL
.
        MOVE     SP20,STARTNM
        DISPLAY  *P16:4,*V2LON,"START ";
.
KEYENDN MOVE     SP20,ENDNAM
        KEYIN    *P16:5,*V2LON,ENDNAM;
        RESET    ENDNAM
        GOTO     CORRECT IF NOT EOS
.
        MATCH    SP20,ENDNAM
        GOTO     CORRECT IF NOT EQUAL
.
        MOVE     "zzzzzzzzzzzzzzzzzzzz" TO ENDNAM
        DISPLAY  *P16:5,*V2LON,"FINISH"; 
.
CORRECT
        RESET    STARTNM TO 20
        RESET    STARTNM
        RESET    ENDNAM TO 20
        RESET    ENDNAM
.
        MATCH    ENDNAM TO STARTNM
        GOTO     OK IF EQUAL
        GOTO     OK IF LESS
.
        DISPLAY  *P1:24,*EL,*B,*V2LON,"*** START MUST BE LESS THAN END ***":
                 *W2;
        GOTO     SURNAM
.
OK      KEYIN    *P1:7,*EL,"OK (",*V2LON,"Y",*HOFF,"/",*V2LON,"N":
                 *HOFF,") ? ",*V2LON,ANS
        RESET    ANS
        CMATCH   "Y" TO ANS
        GOTO     START IF NOT EQUAL
.
KEYCLM  MOVE     SP3,STCLM
        DISPLAY  *P1:9,*EL,*P1:8,*EL:
                 *P1:7,*EL,"Starting Claim Type  : "
.
        MOVE     SEVEN,EVERT
        MOVE     TWENTY4,ECOL 
        MOVE     ZERO,CKYIMAND
        MOVE     "CL",CODE
        CALL     PATCODKY
.
        MOVE     ACODE,STCLM
.
        MATCH    SP3,STCLM
        GOTO     KEYCLM1 IF NOT EQUAL
.
        MOVE     START,FRCLM              * Save for printout
        DISPLAY  *P24:7,*V2LON,START;
        GOTO     KEYCLM2
.
KEYCLM1 MOVE     STCLM,FRCLM
        DISPLAY  *P24:7,*V2LON,STCLM
.
KEYCLM2 MOVE     SP3,EDCLM
        DISPLAY  *P41:7,*EL,"Ending Claim Type    : "
.
        MOVE     SEVEN,EVERT
        MOVE     SIXTY4,ECOL 
        MOVE     "CL",CODE
        CALL     PATCODKY
.
        MOVE     ACODE,EDCLM
.
        MATCH    SP3,EDCLM
        GOTO     ECHK1 IF NOT EQUAL
.
        MOVE     "zzz",EDCLM
        MOVE     FINISH,TOCLM         * Save for printout
        DISPLAY  *P64:7,*V2LON,FINISH;
        GOTO     ECHK2
.
ECHK1   MOVE     EDCLM,TOCLM
        DISPLAY  *P64:7,*V2LON,EDCLM
.
ECHK2   MATCH    STCLM,EDCLM
        GOTO     KEYHFN IF NOT LESS
.
        DISPLAY  *P40:8,*EL,*B,*V2LON:
                 "** Ending Claim < Starting Claim **",*W2
        GOTO     KEYCLM
.
.       Keyin range of health fund
.
KEYHFN  MOVE     SP3,STHFN
        DISPLAY  *P1:8,*EF,"Starting Health Fund : ";
.
        MOVE     EIGHT,EVERT
        MOVE     TWENTY4,ECOL
        MOVE     ZERO,CKYIMAND
        CALL     PATFNDKY
.
        MOVE     HCODE,STHFN
        MATCH    SP6,STHFN
        GOTO     KEYHFN1 IF NOT EQUAL
.
        MOVE     START,FRHFN           * Save for printout
        DISPLAY  *P24:8,*V2LON,START;
        GOTO     KEYHFN2
.
KEYHFN1 MOVE     STHFN,FRHFN
        DISPLAY  *P24:8,*V2LON,STHFN;
.
KEYHFN2 MOVE     SP3,EDHFN
        DISPLAY  *P41:8,*EL,"Ending Health Fund   : ";
.
        MOVE     EIGHT,EVERT
        MOVE     SIXTY4,ECOL
        MOVE     ZERO,CKYIMAND
        CALL     PATFNDKY
.
        MOVE     HCODE,EDHFN
        MATCH    SP6,EDHFN
        GOTO     KEYHFN3 IF NOT EQUAL
.
        MOVE     "zzz",EDHFN
        MOVE     FINISH,TOHFN                 * save for printout
        DISPLAY  *P64:8,*V2LON,FINISH;
        GOTO     KEYHFN4
.
KEYHFN3 MOVE     EDHFN,TOHFN                  * save for printout
        DISPLAY  *P64:8,*V2LON,EDHFN
.
KEYHFN4 MATCH    STHFN,EDHFN
        GOTO     KEYALL IF NOT LESS
.
        DISPLAY  *P1:10,*EL,*B,*V2LON:
                 "** Ending Health Fund must be greater":
                 " than or equal to Starting Health Fund **",*W2,*P1:10,*EL
        GOTO     KEYHFN
.
.
.       Ask if each claim type is to be on a separate page
.
KEYALL  KEYIN    *P1:10,*EL,"Do you want each claim code on a separate page (":
                 *V2LON,"Y",*HOFF,"/",*V2LON,"N",*HOFF,") ? ",*V2LON,ANS
.  
        REP      UPPLOW,ANS
        CMATCH   "Y",ANS
        GOTO     SEPCLMY IF EQUAL
.
        CMATCH   "N",ANS
        GOTO     SEPCLMN IF EQUAL
.
        BEEP
        GOTO     KEYALL
.
SEPCLMY MOVE     ONE,SEPCLM
        GOTO     KEYFND
.
SEPCLMN MOVE     TWO,SEPCLM
.
.       Check if a break-up of Health Funds is wanted
.
KEYFND  KEYIN    *P1:11,*EL,"Do you want a break-up of Health Funds (":
                 *V2LON,"Y",*HOFF,"/",*V2LON,"N",*HOFF,") ? ",*V2LON,ANS
.
        REP      UPPLOW,ANS
        CMATCH   "Y",ANS
        GOTO     SEPFNDY IF EQUAL
.
        CMATCH   "N",ANS
        GOTO     SEPFNDN IF EQUAL
.
        bEEP
        GOTO     KEYFND
.
SEPFNDY MOVE     ONE,SEPFUND
        GOTO     KEYPAGE
.
SEPFNDN MOVE     TWO,SEPFUND
.
.       A separate page for a new health fund
.
KEYPAGE   KEYIN     *P1:12,*EL,"Do you want a new page for each Health Funds (":
                    *V2LON,"Y",*HOFF,"/",*V2LON,"N",*HOFF,") ? ",*V2LON,ANS
.
          REP      UPPLOW,ANS
          CMATCH    "Y",ANS
          GOTO      NPAGEY IF EQUAL
.
          CMATCH    "N",ANS
          GOTO      NPAGEN IF EQUAL
          BEEP
          GOTO      KEYPAGE
.
NPAGEY    MOVE      ONE,PAGFUND
          BRANCH    CATBLAY,KEYCOMM,KEYCOMM,KEYCOMM,KEYCOMM
          GOTO      KEYCOMM
.
NPAGEN    MOVE      TWO,PAGFUND
          BRANCH    CATBLAY,KEYCOMM,KEYCOMM,KEYCOMM,KEYCOMM
.
KEYCOMM   KEYIN     *P1:13,*EL,"Do you want to print admission comments (":
                    *V2LON,"Y",*HOFF,"/",*V2LON,"N",*HOFF,") ? ",*V2LON,ANS
.
          MOVE     ZERO,PRTADCOM
          REP      UPPLOW,ANS
          CMATCH   ANSY,ANS
          GOTO     COMMY IF EQUAL
.
          CMATCH   ANSN,ANS
          GOTO     KADATE IF EQUAL
          BEEP
          GOTO     KEYCOMM
.
COMMY     MOVE     ONE,PRTADCOM
.
KADATE    DISPLAY   *P1:4,*EF,*P1:11,"Keyin As At Date : ";
.
          MOVE      ZERO,CHIGHLT
          MOVE      ZERO,CDEFDTE
          MOVE      TEN1,CVERT
          MOVE      TWENTY,CCOL
          UNPACK    SP6,CYEAR,CMON,CDAY
          MOVE      CCC,CCENT
          CALL      KEYDATE
          BRANCH    OVRCD,START
.
          PACK      FROMDATE,CCENT,CYEAR,CMON,CDAY
          REP       " 0",FROMDATE
.
          MOVE      ICENT,CC
          MOVE      IYEAR,YY
          MOVE      IMON,MM
          MOVE      IDAY,DD
.
CHKTOTS KEYIN      *P1:13,*EL,"Totals Only to be Printed (":
                   *V2LON,"Y",*HOFF,*DV,SLASH:
                   *V2LON,"N",*HOFF,") ? ",*V2LON,ANS;
.
        CMATCH     "N",ANS
        GOTO       CHKTOTN IF EQUAL
.
        CMATCH     "Y",ANS
        GOTO       CHKTOTY IF EQUAL
        BEEP
        GOTO       CHKTOTS
.
CHKTOTN MOVE       ZERO,TOTONLY
        GOTO       KEYHOSP
.
CHKTOTY MOVE       ONE,TOTONLY
.
KEYHOSP COMPARE    ONE,IBCNMHOS
        GOTO       KEYOPT IF NOT EQUAL
.
        DISPLAY    *P1:15,*EL,"Hospital Id : ";
        MOVE       TEN5,ECOL
        MOVE       "15",EVERT
        MOVE       SP3,CKYIDEF3
        MOVE       ZERO,CKYIMAND           * Not Mandatory
        OPEN       PATHSPA1,"pathspaf"
.
        CALL       PATHSPKY
        BRANCH     EXIT,ALLHOSP,START
        GOTO       KEYOPT  
.
ALLHOSP MOVE       "All Hospitals",PTHSNAME
        MOVE       SP10,PTHSHOSP
.
KEYOPT  DISPLAY   *P1:17,*EF:
                  *P1:17,*V2LON,ZERO,*HOFF," = Exit":
                  *P1:18,*V2LON,ONE,*HOFF," = Full Report":
                  *P1:19,*V2LON,TWO,*HOFF," = Current Only":
                  *P1:20,*V2LON,THREE,*HOFF," = 30 Days Only":
		  *P1:21,*V2LON,FOUR,*HOFF," = 60 Days Only":
                  *P1:22,*V2LON,FIVE,*HOFF," = Over 90 Days"
.
KEYOPT1 KEYIN     *P1:24,"Option : ",*EL,*V2LON,OPTION1
.
        COMPARE   ZERO TO OPTION1
        GOTO      START IF EQUAL
.
REPEAT1 BRANCH    OPTION1 TO OPTFULL,OPTCUR,OPT30,OPT60,OPT90  
        BEEP
        GOTO      KEYOPT
.
OPTFULL DISPLAY   *P64:2,*V2LON,"- Full Report ",*HOFF
        GOTO      KPATSEL
.
OPTCUR  DISPLAY   *P64:2,*V2LON,"- Current ",*HOFF
        MOVE      "CURRENT  " TO DIM9
        GOTO      KPATSEL
.
OPT30   DISPLAY   *P64:2,*V2LON,"- 30 Days ",*HOFF
        MOVE      "30 DAYS  " TO DIM9
        GOTO      KPATSEL
.
OPT60   DISPLAY   *P64:2,*V2LON,"- 60 Days ",*HOFF
        MOVE      "60 DAYS  " TO DIM9
        GOTO      KPATSEL
.
OPT90   DISPLAY   *P64:2,*V2LON,"- 90+ Days ",*HOFF
        MOVE      "90+ DAYS " TO DIM9
        GOTO      KPATSEL
.
.       Subroutine to get the starting claim code
.
GETSCLM PACK     KEY5 WITH CODECL,STCLM
        CALL     RDCODE1
        COMPARE  ZERO,OVRCD
        RETURN   IF EQUAL
.
        CALL     RDSCODE1
        CALL     RDKCODE1
        RETURN
+
.
.       Get the financial options
.
KPATSEL CALL     PATSELFN
        BRANCH   EXIT,START
.
.       Set up heading variables
.
        MOVE     DSYST0,DSYST
        LOAD     DSYST,FSTSYS,DSYST1,DSYST2,DSYST3,DSYST4
.
        MOVE     SP30,DOUTXTRA
.
        COMPARE  TWO,FSTSYS
        GOTO     REKEY IF NOT EQUAL
.
        MATCH    SP6,FSTSITE
        GOTO     SINGSITE IF NOT EQUAL
.
        MATCH    SP3,FSTDEPT
        GOTO     SINGDEPT IF NOT EQUAL
.
        MOVE     DOUTALL,DOUTXTRA
        GOTO     REKEY 
.
SINGSITE PACK     DOUTXTRA,DOUTSIT,FSTSITE,SP2,OSTDESC   * Desc already read in
        GOTO     REKEY 
.
SINGDEPT PACK     DOUTXTRA,DOUTDEP,FSTDEPT,SP2,TDESC     * Desc already read in
.
REKEY   KEYIN           *P1:24,*EF,"Ok to continue (":
                        *V2LON,"Y",*HOFF,*DV,SLASH:
                        *V2LON,"N",*HOFF,") ? ",*V2LON,ANS;
.
        MATCH           "N" TO ANS
        GOTO            START IF EQUAL
.
        MATCH           "Y" TO ANS
        GOTO            CHKCNT IF EQUAL
.
        BEEP
        GOTO            REKEY
.
CHKCNT  PACK            FROMDATE,CCENT,CYEAR,CMON,CDAY
        REP             " 0",FROMDATE
        MOVE            ICENT,CC
        MOVE            IYEAR,YY
        MOVE            IMON,MM
        MOVE            IDAY,DD
        CALL            DMYCON
.
        MOVE            JULDAY TO ASATDAY
        MOVE            JULYR TO ASATYER
        MOVE            JULCC, ASATCC
        PACK            ASATDATE,ASATCC,ASATYER
        REP             " 0",ASATDATE
.
        CLEAR           FNAMET  
        CALL            TFILENAM              * Generate temporary file name
        MOVE            TFILNAME,FNAMET
.
.       CHECK IF PREVIOUSLY EXISTS..IF SO DELETED IT 
.
        CALL            KILLIDZ
.
        PREP            TEMPSEQ,FNAMET
        CLOSE           TEMPSEQ
        PREP            TEMPSEQ,FNAMET
        MOVE            ZEROVISN TO SAVADMNO
        MOVE            ZERO TO XTOTPAID
        MOVE            ZERO TO XTOTCURR
        MOVE            ZERO TO XTOT30
        MOVE            ZERO TO XTOT60
        MOVE            ZERO TO XTOT90
        MOVE            ZERO TO XTOT120
        MOVE            ZERO TO XTOT1YR
        MOVE            ZERO TO XTOT2YR
        MOVE            ZERO TO UNIQUE
        MOVE            SP10 TO XUNIQUE
        MOVE            SP10 TO XAADMNO
        MOVE            SP10 TO XAURNO
.
        MOVE            ZERO TO HFPAID
        MOVE            ZERO TO PATPAID
        MOVE            ZERO TO XTREBCUR
        MOVE            ZERO TO XTPATCUR
        MOVE            ZERO TO XTREB30
        MOVE            ZERO TO XTPAT30
        MOVE            ZERO TO XTREB60
        MOVE            ZERO TO XTPAT60
        MOVE            ZERO TO XTREB90
        MOVE            ZERO TO XTPAT90
        MOVE            ZERO TO XTREB120
        MOVE            ZERO TO XTPAT120
        MOVE            ZERO TO XTSUBREB
        MOVE            ZERO TO XTSUBPAT
        MOVE            SP70,TEMP40
.
        CLOCK           TIME,CTIMEIS
.
.       Initialise the key variables for the loop over the invoice file
.
        MOVE            FSTSYS,CURSYS
        MOVE            FSTSITE,CURSITE
.
.       Read in first claim details
.
FRSTCLM  CALL            GETSCLM
.
         DISPLAY     *P1:24,*EL,*P5:24,"Claim : ",*P20:24,"Surname : ":
                                *P50:24,"Admission Number :";
.
.        Initialise the key for the fourth index of the invoice file
.
REPACK   MOVE        STARTNM,DIM6
         PACK        KEY32,CURSYS,CURSITE,ACODE,DIM6,SP30
         CALL        RDSINV4
URLOOP   CALL        RDKINV4
         BRANCH      OVRCD TO SORTD
.
.        Ignore cancelled invoices
.
         MATCH       ZEROVISN,PINVADM
         GOTO        URLOOP IF EQUAL        * Cancelled Invoice
.
.        Display invoice details
.
         DISPLAY     *P13:24,*V2LON,PINVCLM:
                     *P31:24,PINALPHA,*P70:24,PINVADM
.
.        Check for a change in system
.
         COMPARE     PINVSYS,CURSYS
         GOTO        CHKSITE IF EQUAL
.
.        Go to the next system
.
NEXTSYS  ADD         ONE,CURSYS
.
.        New system. Check if we are outside the request range
.
         COMPARE     CURSYS,FEDSYS
         GOTO        SORTD IF LESS
.
.        Initialise for reposition
.
         MOVE        FSTSITE,CURSITE
         CALL        GETSCLM
         GOTO        REPACK
.
.        Same system, check for a change in site
.
CHKSITE  MATCH       PINVSITE,CURSITE
         GOTO        CHKCLM IF EQUAL
.
.        Go to the next site code
.
NEXTSITE MOVE        CURSITE,KEY6
         CALL        RDSSITA1
NEXTSITL CALL        RDKSITA1
         BRANCH      OVRCD,NEXTSYS
.
.        New site. Check if we are outside the request range
.
         MATCH       OSTSITE,FEDSITE
         GOTO        NEXTSYS IF LESS
.
.        Check for a valid department
.
         MATCH       FSTDEPT,OSTSYST
         GOTO        NEXTSITL IF LESS
.
         MATCH       OSTSYST,FEDDEPT
         GOTO        NEXTSITL IF LESS
.
.        Initialise for reposition
.
         MOVE        OSTSITE,CURSITE
         CALL        GETSCLM
         GOTO        REPACK
.
.        Same system/site. Check for a new claim code
.
CHKCLM   MATCH       PINVCLM,ACODE
         GOTO        CHKSUR IF EQUAL
.
.        Go to the next claim code
.
NEXTCLM  CALL        RDKCODE1
         BRANCH      OVRCD,NEXTSITE
.
         MATCH       CODECL,TCODE
         GOTO        NEXTSITE IF NOT EQUAL
.
         MATCH       ACODE,EDCLM
         GOTO        NEXTSITE IF LESS
.
.        Initialise for reposition
.
         GOTO        REPACK
.
.        Same system/site/claim code. Check for a surname in the valid range
.
CHKSUR   MOVE        STARTNM,DIM6
         MATCH       DIM6,PINALPHA
         GOTO        REPACK IF LESS
.
         MOVE        ENDNAM,DIM6
         MATCH       PINALPHA,DIM6
         GOTO        NEXTCLM IF LESS
.
.        Check for a invalid invoice date
.
         MATCH       PINVDTE,FROMDATE            * Invoice after cut-off date
         GOTO        URLOOP IF LESS
.
         BRANCH      IBCNUGST,URLP0700,URLP0800,URLP0800
.
URLP0700 SUB         PTINGSTA,PINVAMT      * exclude GST amount
.
URLP0800  IF          IBCNMHOS=1
            MATCH       SP10,PTHSHOSP
            IF          !@EQUAL
              PACK        KEY8,PINVADM,SP8
              CALL        RDPMVX11
              BRANCH      OVRCD,URLOOP
              MATCH       PMVXMHOS,PTHSHOSP
              GOTO        URLOOP IF NOT EQUAL
            ENDIF
          ENDIF
.
         MATCH       PINVBLCD,FROMDATE
         GOTO        URLP2000 IF LESS
.
.         Invoice should be balanced. Check it just in case (this is because
.         at one stage the centralised cash receipting module did not update
.         the PINVBLCD variable, and so occassionally PINVBLCD said the invoice
.         was balanced, even though it wasn't).
.
          MOVE      PINVAMT,FORM12P2
          ADD       PINVPATA,FORM12P2
          ADD       PINVHFDA,FORM12P2
          ADD       PINVOTHA,FORM12P2
          ADD       PINVJOUR,FORM12P2
          ADD       PTINCRTT,FORM12P2
          IF        IBCNUGST=2 | IBCNUGST=3
            ADD       PTINGSTJ,FORM12P2
          ENDIF
.
          COMPARE   ZERO00,FORM12P2          * invoice balanced ?
          GOTO      URLOOP IF EQUAL          * yes, ignore invoice
.
.         Invoice is not really balanced. Report the error, and then include
.         the invoice in the report, to make sure the report will balance.
.
          UNPACK    PINVBLCD,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
.
          DISPLAY   *P1:17,*V2LON,*EL,*B:
                    "** Invoice ",PINVNO," has an incorrect balanced date ":
                    CPCDATE," **",*W2;
.
          COMPARE   "56",CLNO
          CALL      HEAD IF NOT LESS
          PRINT     *1,"** Invoice ",PINVNO," has on incorrect balanced date ":
                    CPDATE,". Contact I.B.A. Immediately **",*N
          ADD       TWO,CLNO
.
.         Determine if this invoice is fully paid or not
.
URLP2000  MOVE      ZERO,TMPPAID
          MOVE      ZERO,HFPAID
          MOVE      ZERO,PATPAID
.
        PACK        KEY22 WITH PINVADM,PINVNO,SP6
.
.       Loop over the appropriate DTRAN file
.
        BRANCH      PINVSYS OF AAEDTR,OTHDTR,INPDTR,OTHDTR,URLOOP
.
.       In-patient invoice
.
INPDTR  CALL        RDSDTRN1
.
PYLOOP1 CALL        RDKDTRN1
        BRANCH      OVRCD OF PYEND1
.
        MATCH       TREF,PINVNO
        GOTO        PYEND1 IF NOT EQUAL
.
.       We are only interested in cash and journals
.
        BRANCH      TRECTYPE,PYLOOP1,PYLOOP1,PYLOOP1,PYLOOP1,PYCSH1,PYJRN1
        GOTO        PYLOOP1
.
.       If the Transaction date is used for journals, then treat as cash
.       otherwise use the last modification date as the journal date for
.       determining if the journal was done before or after cutoff date
.
PYJRN1  
.       BRANCH      CJRNREP,PYCSH1
.
        MATCH       PTDTEFFD,FROMDATE
        GOTO        PYLOOP1 IF LESS
.
        GOTO        MPAY00
.
.       Use the cash released date to determine if this transaction was done
.       before or after the cutoff date.
.
PYCSH1  PACK        TDATE WITH TFCENT,TFYEAR,TFMONTH,TFDAY
        REP         " 0",TDATE
.
.       MATCH       TDATE,FROMDATE
        MATCH       PTDTEFFD,FROMDATE
        GOTO        PYLOOP1 IF LESS
.
.       Valid payment for this report
.
MPAY00  MATCH       "H",TTYPEDEB
        GOTO        MPAY10 IF NOT EQUAL
.
        ADD         TPATAMTT,HFPAID          * Health Fund Payment
        GOTO        MPAY20
.
MPAY10  ADD         TPATAMTT,PATPAID         * Patient Payment
        COMPARE     SIX,TRECTYPE
        GOTO        MPAY20 IF NOT EQUAL
.
        IF          IBCNUGST=2 | IBCNUGST=3
          ADD         PTDTGSTM,PATPAID
        ENDIF
.
MPAY20  ADD         TPATAMTT,TMPPAID
        COMPARE     SIX,TRECTYPE
        GOTO        PYLOOP1 IF NOT EQUAL
.
        IF          IBCNUGST=2 | IBCNUGST=3
          ADD         PTDTGSTM,TMPPAID          * GST Journal
        ENDIF
        GOTO        PYLOOP1
.
.       Other financial invoice and Outpatient invoice
.
OTHDTR  MOVE        "out",OSTFILE
        MOVE        PVISITE,KEY6
        CALL        RDSITA1
.
        PACK        CFNAME,OSTFILE,FILDTRO1
        OPEN        OUTDTRO1,CFNAME
.
        CALL        RDSDTRO1
.
PYLOOP2 CALL        RDKDTRO1
        BRANCH      OVRCD OF ENDDTRO
.
        MATCH       OTINVNO,PINVNO
        GOTO        ENDDTRO IF NOT EQUAL
.
        BRANCH      OTRECTYP,PYLOOP2,PYCSH2,PYJRN2
        GOTO        PYLOOP2
.
.       If the Transaction date is used for journals, then treat as cash
.       otherwise use the last modification date as the journal date for
.       determining if the journal was done before or after cutoff date
.
PYJRN2  
.       BRANCH      CJRNREP,PYCSH2
.
        MATCH       OTDTEFFD,FROMDATE
        GOTO        PYLOOP2 IF LESS
.
        ADD         OTPATAMT,TMPPAID
.
        IF          IBCNUGST=2 | IBCNUGST=3
          ADD         OTDTGSTM,TMPPAID          * GST Journal
        ENDIF
        GOTO        PYLOOP2
.
.       Use the released date to determine if this transaction was done
.       before or after the cutoff date.
.
PYCSH2  
.       MATCH       OTDDATE,FROMDATE
        MATCH       OTDTEFFD,FROMDATE
        GOTO        PYLOOP2 IF LESS
.
        ADD         OTPATAMT,TMPPAID
        IF          IBCNUGST=2 | IBCNUGST=3
          ADD         OTDTGSTM,TMPPAID
        ENDIF
        GOTO        PYLOOP2
.
ENDDTRO CLOSE       OUTDTRO1
        GOTO        PYEND1
.
.       A + E invoice
.
AAEDTR  
        CALL        RDSDTRE1
.
PYLOOP3 CALL        RDKDTRE1
        BRANCH      OVRCD OF PYEND1
.
        MATCH       ATINVNO,PINVNO
        GOTO        PYEND1 IF NOT EQUAL
.
        BRANCH      ATRECTYP,PYLOOP3,PYCSH3,PYJRN3
        GOTO        PYLOOP3
.
.       If the Transaction date is used for journals, then treat as cash
.       otherwise use the last modification date as the journal date for
.       determining if the journal was done before or after cutoff date
.
PYJRN3  
.       BRANCH      CJRNREP,PYCSH3
.
        MATCH       ATDTEFFD,FROMDATE
        GOTO        PYLOOP3 IF LESS
.
        ADD         ATPATAMT,TMPPAID
        GOTO        PYLOOP3
.
.       Use the released date to determine if this transaction was done
.       before or after the cutoff date.
.
PYCSH3  
.       MATCH       ATDDATE,FROMDATE
        MATCH       ATDTEFFD,FROMDATE
        GOTO        PYLOOP3 IF LESS
.
        ADD         ATPATAMT,TMPPAID
        GOTO        PYLOOP3
.
.       Add the total payments to the invoice total to get the outstanding amt
.
PYEND1  CALL        CRDN0000              * Check credit note
        ADD         FORM12P2,PINVAMT
.
        MOVE        PINVAMT,FORM12P2
        ADD         TMPPAID,FORM12P2
.
        COMPARE     ZERO00 TO FORM12P2
        GOTO        URLOOP IF EQUAL
.
        MOVE        PINVAMT,PINVPAT
.
.       Check for a change in admission number
.
        MATCH       PINVADM TO SAVADMNO
        GOTO        URLOOP3 IF EQUAL
.
        BRANCH      OPTION1 TO URLOOP1,URLOOP0,URLOOP0,URLOOP0,URLOOP0
        GOTO        URLOOP1
.
URLOOP0  CALL        WRTEHED
.
URLOOA0  MOVE        ZERO TO TOTDAYS
         MOVE        PINVADM TO SAVADMNO
         GOTO        URLOOP2
.
WRTEHED  MATCH       ZEROVISN TO SAVADMNO
         RETURN       IF EQUAL
.
         COMPARE     ZERO TO TOTDAYS
         RETURN      IF EQUAL
.
         MOVE        TOTDAYS TO XTINVAMT
         MOVE        SP1 TO SORTDIM
         ADD         ONE TO UNIQUE
.
         COMPARE     ONE,PTCNCATB        * print billing comments?
         GOTO        ADMCOM10 IF NOT EQUAL
.
         PACK        VSCTDATA,SP70,SP70
         MOVE        "  1",VSCTLINE
         MOVE        "003",VSCTTYPE      * Billing comments
         PACK        KEY14,AADMNO,VSCTTYPE,VSCTLINE
         CALL        RDVSCMT1
         IF          OVRCD=1
           MOVE        SP70,VSCTDATA
         ENDIF
.
         MOVE        VSCTDATA,CMNTLINE
         GOTO        ADMCOM20
.
ADMCOM10 MOVE        AADMNO,KEY8 
         CALL        VSCMTX00 
         MOVE        VSMTCMNT,CMNTLINE
.
ADMCOM20 MOVE        SP3,REMLSTL
         MOVE        SP8,LSTLDAT
         MOVE        AADMNO,KEY8
         CALL        RDREMD1
         BRANCH      OVRCD OF CHKSCL
.
         MATCH       SP8,REMLDTE
         GOTO        CHKSCL IF EQUAL
.
         UNPACK      REMLDTE WITH XCENT1,XYEAR1,XMON1,XDAY1
         PACK        LSTLDAT WITH XDAY1,SLASH,XMON1,SLASH,XYEAR1
.
CHKSCL   BRANCH      SEPCLM OF CHKSHF
         MOVE        "ZZZ",ACLAIM
.
CHKSHF   MOVE        AFUNDH,HFUND
         BRANCH      SEPFUND OF WRTT
         MOVE        "ZZZZZZ",HFUND
.
WRTT     MOVE        UNIQUE,XUNIQUE
         MOVE        AURNO,XAURNO
         MOVE        AADMNO,XAADMNO
         MOVE        PTELEP,D12PTELP     * since PTELEP/b = 20 chars (new file)
         MOVE        PTELEB,D12PTELB
         WRITE       TEMPSEQ,SEQ;ACLAIM,HFUND,XAURNO,XAADMNO,PSNAME,PGNAME:
                                 SORTDIM,XUNIQUE,PTITL,D12PTELP:
                                 PINVAMT,TINVNO,XDAY,XMON,XYEAR,XCENT,XTINVAMT:
                                 AFUNDH,AFNDTB,AFNDMM:
                                 D12PTELB,DDDAY,DDMON,DDYER,DDCEN,CMNTLINE:
                                 REMLSTL,LSTLDAT,SPINVTYP,SPINVSYS,TEMP40
.
        RETURN
.
URLOOP1 CALL        WRTEFUL
.
.       Get the details for this invoice
.
URLOOP2 MOVE        ZERO TO DDDAY
        MOVE        ZERO TO DDMON
        MOVE        ZERO TO DDYER
        MOVE        ZERO TO DDCEN
.
.       Get the master file details
.
        MOVE        PINVUR TO KEY8
        CALL        RDMAST1
        BRANCH      OVRCD TO NOMAST
.
        BRANCH      PINVSYS OF AAEDET,OUTDET,INPDET,OTHDET,URLOOP
.
.       Inpatient details
.
INPDET  MOVE        PINVADM TO KEY8
        CALL        RDMISS1
        BRANCH      OVRCD TO INVADM
.
        COMPARE     ONE TO ASTAT
        GOTO        NOPREAD IF EQUAL
        COMPARE     FIVE TO ASTAT
        GOTO        NOCANAD IF EQUAL
.
        UNPACK      ADATE TO XCENT,XYEAR,XMON,XDAY
        MOVE        XDAY TO ADDAY
        MOVE        XMON TO ADMON
        MOVE        XYEAR TO ADYER
        MOVE        XCENT,ADCEN
.
        MOVE        AADMNO TO KEY8
        CALL        RDDSCH1
        BRANCH      OVRCD TO URLOOP3
.
        UNPACK      DDATE TO XCENT,XYEAR,XMON,XDAY
        MOVE        XDAY TO DDDAY
        MOVE        XMON TO DDMON
        MOVE        XYEAR TO DDYER
        MOVE        XCENT,DDCEN
.
        MATCH       SP10,AFUNDH
        IF          @EQUAL
          MOVE        PFUNDH,AFUNDH
          MOVE        PFNDTB,AFNDTB
          MOVE        PFNDMM,AFNDMM
        ENDIF
        GOTO        URLOOP3
.
.       Outpatient details
.
OUTDET  MOVE        PINVADM TO OBAOUTNO
        MOVE        OBAOUTNO,KEY8
        CALL        RDVISA1
        BRANCH      OVRCD OF INVADM
.
        MOVE        "out",OSTFILE
        MOVE        PVISITE,KEY6
        CALL        RDSITA1
.
        PACK        CFNAME WITH OSTFILE,FILBB1A1
        CALL       OPOTBB11
.
        MOVE        OBAOUTNO,KEY8
        CALL        RDBOKB1
        CLOSE     OUTBB1A1
        BRANCH      OVRCD TO INVADM
.
        UNPACK      OBADATE TO XCENT,XYEAR,XMON,XDAY
        MOVE        XDAY TO ADDAY
        MOVE        XMON TO ADMON
        MOVE        XYEAR TO ADYER
        MOVE        XCENT,ADCEN
.
        MOVE        OBACLASS,ATYPE
        MOVE        OBACOMP,ACLAIM
        MOVE        PINVUR,AURNO
        MOVE        PINVADM,AADMNO
        MOVE        PFUNDH,AFUNDH
        MOVE        PFNDTB,AFNDTB
        MOVE        PFNDMM,AFNDMM
        GOTO        URLOOP3
.
.       A + E details
.
AAEDET  MOVE        PINVADM TO ADANUMB
        MOVE        ADANUMB,KEY8
        CALL        RDDETA1
.       BRANCH      OVRCD TO INVADM
.
        UNPACK      ADADATE TO XCENT,XYEAR,XMON,XDAY
        MOVE        XDAY TO ADDAY
        MOVE        XMON TO ADMON
        MOVE        XYEAR TO ADYER
        MOVE        XCENT,ADCEN
.
        MOVE        ADACLASS,ATYPE
        MOVE        ADACOMP,ACLAIM
        MOVE        PINVUR,AURNO
        MOVE        PINVADM,AADMNO
        MOVE        PFUNDH,AFUNDH
        MOVE        PFNDTB,AFNDTB
        MOVE        PFNDMM,AFNDMM
.
        MOVE        ADANUMB,KEY8
        CALL        RDDISA1
        BRANCH      OVRCD,URLOOP3
.
        UNPACK      ADSDATE,XCENT,XYEAR,XMON,XDAY
        MOVE        XDAY,DDDAY
        MOVE        XMON,DDMON
        MOVE        XYEAR,DDYER
        MOVE        XCENT,DDCEN
.
        GOTO        URLOOP3
.
.       Other Financial details
.
OTHDET  UNPACK      PINVDTE TO XCENT,XYEAR,XMON,XDAY
        MOVE        XDAY TO ADDAY
        MOVE        XMON TO ADMON
        MOVE        XYEAR TO ADYER
        MOVE        XCENT,ADCEN
.
        MOVE        SP3,ATYPE
        MOVE        PINVCLM,ACLAIM
        MOVE        PINVUR,AURNO
        MOVE        PINVADM,AADMNO
        MOVE        PFUNDH,AFUNDH
        MOVE        PFNDTB,AFNDTB
        MOVE        PFNDMM,AFNDMM
.
.       Save invoice details
.
URLOOP3 MOVE        PINVSYS,SPINVSYS
        MOVE        PINVTYP,SPINVTYP
        UNPACK      PINVDTE INTO XCENT,XYEAR,XMON,XDAY
        MOVE        XCENT,CC
        MOVE        XYEAR TO YY
        MOVE        XMON TO MM
        MOVE        XDAY TO DD
.
        CALL        DMYCON
.
        PACK        CNYRKYIN,ASATCC,ASATYER,SP4
        PACK        CNYRPAT,CC,YY
        REP         " 0",CNYRKYIN
        REP         " 0",CNYRPAT
.
        MOVE        ASATDAY TO FORM5DAY
        MOVE        JULDAY TO TDAY
        MOVE        JULYR TO TYR
.
        ADD         TMPPAID,PINVAMT
        MOVE        PINVAMT TO XTINVAMT
        MULT        SEQ BY TMPPAID
        ADD         TMPPAID TO XTOTPAID
.
.       Calculate the outstanding amount for H.F. and Patient
.
        SUB         PINVREB,PINVPAT          * Patient invoice amount
        ADD         PATPAID,PINVPAT
.
        ADD         HFPAID,PINVREB            * Health Fund
. 
        PACK        CURRDATE,CC,YY
        REP         " 0",CURRDATE
        BRANCH      OPTION1 TO URFULL,URCUR,UR30,UR60,UR90       
.
URFULL  COMPARE     ASATCC,CC              *Are dates in same century
        GOTO        URF0 IF EQUAL          *Continue
        GOTO        URF1 IF LESS           *Year As at year
.
        GOTO        URLOOP                 *Date is higher, go to next record
.
URF0    COMPARE     ASATYER TO YY          *Same year?
        GOTO        URF2 IF EQUAL          *Yes, go on to dates
        GOTO        URF1 IF LESS           *Less, work out days difference
.
        GOTO        URLOOP
.
URF1    MOVE        ASATYER TO DAYSINYR
        COMPARE     YY,DAYSINYR
        IF          @LESS
          ADD         HUNDRED,DAYSINYR     *If year lower, add century
        ENDIF
        IF          @EQUAL
          MOVE        HUNDRED, DAYSINYR    *If equal, 100 years difference
          MULT        THREE65,DAYSINYR     *Convert to days
          ADD         TWENTY5,DAYSINYR     *Leap years
          ADD         DAYSINYR,FORM5DAY    
          GOTO        URF2        *This is not likely to happen but can't hurt!
        ENDIF
.
        SUB         YY FROM DAYSINYR       *Calculate years difference
        MULT        THREE65 BY DAYSINYR    *Convert to days
        ADD         DAYSINYR TO FORM5DAY
.
URF2    SUB         TDAY FROM FORM5DAY 
.
        COMPARE     ZERO TO FORM5DAY
        GOTO        URLOOP IF LESS
.
        ADD         PINVAMT TO XTOTOUT 
.
.       0-30 days
.
        COMPARE     THIRTY1 TO FORM5DAY
        GOTO        URF30 IF NOT LESS
.
        ADD         PINVAMT TO XTOTCURR
        ADD         PINVREB,XTREBCUR            * Melbourne clinic
        ADD         PINVPAT,XTPATCUR
        GOTO        URLOOP
.
.       31-60 days
.
URF30   COMPARE     SIXTY1 TO FORM5DAY
        GOTO        URF60 IF NOT LESS
.
        ADD         PINVAMT TO XTOT30
        ADD         PINVREB,XTREB30            * Melbourne clinic
        ADD         PINVPAT,XTPAT30
        GOTO        URLOOP
.
.       61-90 days
.
URF60   COMPARE     NINETY1 TO FORM5DAY
        GOTO        URF90 IF NOT LESS
.
        ADD         PINVAMT TO XTOT60
        ADD         PINVREB,XTREB60            * Melbourne clinic
        ADD         PINVPAT,XTPAT60
        GOTO        URLOOP
.
.       Check if we want a breakup past 90+ days
.
URF90   BRANCH      CATBLAY OF URF90A,URF90B,URF90C,URF90B
.
.       Over 90 days
.
URF90A  ADD         PINVAMT TO XTOT90
        ADD         PINVREB,XTREB90           * Melbourne clinic
        ADD         PINVPAT,XTPAT90
        GOTO        URLOOP
.
.       For Mercy only, 121+ days
.
URF90B  COMPARE     ONE21 TO FORM5DAY
        GOTO        URF120 IF NOT LESS
        GOTO        URF90A
.
URF120  COMPARE     FOUR,CATBLAY
        GOTO        URF120M IF EQUAL         * Melbourne clinic
.
        COMPARE     THREE66 TO FORM5DAY
        GOTO        URF1YR IF NOT LESS
.
        ADD         PINVAMT TO XTOT120
        GOTO        URLOOP
.
.       Melbourne clinic only
.
URF120M ADD         PINVAMT,XTOT120
        ADD         PINVREB,XTREB120
        ADD         PINVPAT,XTPAT120
        GOTO        URLOOP
.
.       For Mercy only, 1yr+ days
.
URF1YR  COMPARE     SEVEN31 TO FORM5DAY
        GOTO        URF2YR IF NOT LESS
.
        ADD         PINVAMT TO XTOT1YR
        GOTO        URLOOP
.
.       For Mercy only, 2yr+ days
.
URF2YR  ADD         PINVAMT TO XTOT2YR
        GOTO        URLOOP
.
.       For St.Andrews (Ipswich) we want a break up of 120,150,180+
.
URF90C  COMPARE     ONE21 TO FORM5DAY
        GOTO        URF120A IF NOT LESS
        GOTO        URF90A
.
URF120A COMPARE     ONE51 TO FORM5DAY
        GOTO        URF150 IF NOT LESS
.
        ADD         PINVAMT TO XTOT120
        GOTO        URLOOP
.
.       This is 151-180 days - use the same variable name as for mercy
.
URF150  COMPARE     ONE81 TO FORM5DAY
        GOTO        URF180 IF NOT LESS
.
        ADD         PINVAMT TO XTOT1YR
        GOTO        URLOOP
.
.       This is 181+ days - use the same variable name as for mercy
.
URF180  ADD         PINVAMT TO XTOT2YR
        GOTO        URLOOP
+
.       Detailed Report check.
.
URCUR   MATCH       CNYRKYIN,CNYRPAT
        GOTO        URCU2 IF EQUAL
        GOTO        URCU1 IF LESS
        GOTO        URLOOP
.
URCU1   MOVE        CNYRKYIN TO DAYSINYR
        MOVE        CNYRPAT,FORM4
        SUB         FORM4 FROM DAYSINYR
        MULT        THREE65 BY DAYSINYR
        ADD         DAYSINYR TO FORM5DAY
.
URCU2   SUB         TDAY FROM FORM5DAY 
.
        COMPARE     ZERO TO FORM5DAY
        GOTO        URLOOP IF LESS
.
        COMPARE     THIRTY1 TO FORM5DAY
        CALL        WRTEDAY IF LESS    
.
        GOTO        URLOOP
.
UR30    MATCH       CNYRKYIN,CNYRPAT
        GOTO        UR32 IF EQUAL
        GOTO        UR31 IF LESS
        GOTO        URLOOP
.
UR31    MOVE        CNYRKYIN TO DAYSINYR
        MOVE        CNYRPAT,FORM4
        SUB         FORM4 FROM DAYSINYR
        MULT        THREE65 BY DAYSINYR
        ADD         DAYSINYR TO FORM5DAY
.
UR32    SUB         TDAY FROM FORM5DAY 
.
        COMPARE     ZERO TO FORM5DAY
        GOTO        URLOOP IF LESS
.
        COMPARE     THIRTY1 TO FORM5DAY
        GOTO        URLOOP IF LESS
.
        COMPARE     SIXTY1 TO FORM5DAY
        CALL        WRTEDAY IF LESS    
.
        GOTO        URLOOP
.
UR60    MATCH       CNYRKYIN,CNYRPAT
        GOTO        UR62 IF EQUAL
        GOTO        UR61 IF LESS
        GOTO        URLOOP
.
UR61    MOVE        CNYRKYIN TO DAYSINYR
        MOVE        CNYRPAT,FORM4
        SUB         FORM4 FROM DAYSINYR
        MULT        THREE65 BY DAYSINYR
        ADD         DAYSINYR TO FORM5DAY
.
UR62    SUB         TDAY FROM FORM5DAY 
.
        COMPARE     ZERO TO FORM5DAY
        GOTO        URLOOP IF LESS
.
        COMPARE     SIXTY1 TO FORM5DAY
        GOTO        URLOOP IF LESS
.
        COMPARE     NINETY1 TO FORM5DAY
        CALL        WRTEDAY IF LESS
.
        GOTO        URLOOP
.
UR90    MATCH       CNYRKYIN,CNYRPAT
        GOTO        UR92 IF EQUAL
        GOTO        UR91 IF LESS
.
        GOTO        URLOOP
.
UR91    MOVE        CNYRKYIN TO DAYSINYR
        MOVE        CNYRPAT,FORM4
        SUB         FORM4 FROM DAYSINYR
        MULT        THREE65 BY DAYSINYR
        ADD         DAYSINYR TO FORM5DAY
.
UR92    SUB         TDAY FROM FORM5DAY 
.
        COMPARE     ZERO TO FORM5DAY
        GOTO        URLOOP IF LESS
.
        COMPARE     NINETY1 TO FORM5DAY
        CALL        WRTEDAY IF NOT LESS
        GOTO        URLOOP
.
INVADM  DISPLAY     *P1:17,*V2LON,*EL,*B:
                    "** Invoice ",PINVNO," has invalid admission number ":
                    PINVADM," **",*W2;
        COMPARE      "54" TO CLNO
        CALL         HEAD IF NOT LESS
        PRINT       *1,"** Invoice ",PINVNO," has invalid admission number ":
                    PINVADM,". Contact I.B.A. Immediately **",*N
        ADD         TWO,CLNO
        MOVE        ZEROVISN,SAVADMNO
        GOTO        URLOOP
.
NOPREAD DISPLAY     *P1:17,*V2LON,*EL,*B:
                    "** Invoice ",PINVNO," allocated to pre-admission":
                    " number ":
                    PINVADM," **",*W2;
        COMPARE      "54" TO CLNO
        CALL         HEAD IF NOT LESS
        PRINT       *1,"** Invoice ",PINVNO," allocated to pre-admission":
                    " number ":
                    PINVADM,". Contact I.B.A. Immediately **",*N
        ADD         TWO,CLNO
        MOVE        ZEROVISN,SAVADMNO
        GOTO        URLOOP
.
NOCANAD DISPLAY     *P1:17,*V2LON,*EL,*B:
                    "** Invoice ",PINVNO," has cancelled admission number ":
                    PINVADM," **",*W2;
        COMPARE      "54" TO CLNO
        CALL         HEAD IF NOT LESS
        PRINT       *1,"** Invoice ",PINVNO," has cancelled admission number ":
                    PINVADM,". Contact I.B.A. Immediately **",*N
        ADD         TWO,CLNO
        MOVE        ZEROVISN,SAVADMNO
        GOTO        URLOOP
.
NOMAST  DISPLAY     *P1:17,*V2LON,*EL,*B:
                    "** Invoice ",PINVNO," missing master file record ":
                    PINVUR," **",*W2;
        COMPARE      "54" TO CLNO
        CALL         HEAD IF NOT LESS
        PRINT       *1,"** Invoice ",PINVNO," missing master file record ":
                    PINVUR,". Contact I.B.A. Immediately **",*N
        ADD         TWO,CLNO
        MOVE        ZEROVISN,SAVADMNO
        GOTO        URLOOP
.
WRTEFUL                                   
        MOVE        XTOTCURR TO XTOTOUT
        ADD         XTOT30 TO XTOTOUT
        ADD         XTOT60 TO XTOTOUT
        ADD         XTOT90 TO XTOTOUT
        ADD         XTOT120 TO XTOTOUT
        ADD         XTOT1YR TO XTOTOUT
        ADD         XTOT2YR TO XTOTOUT
.
        MATCH       ZEROVISN TO SAVADMNO
        GOTO        WRTEFU1 IF EQUAL
.
.         Mods to check if any outstanding amount of each breakup
.
        COMPARE     ZERO,XTOTCURR
        GOTO        WRTE100 IF NOT EQUAL
        COMPARE     ZERO,XTOT30
        GOTO        WRTE100 IF NOT EQUAL
        COMPARE     ZERO,XTOT60
        GOTO        WRTE100 IF NOT EQUAL
        COMPARE     ZERO,XTOT90
        GOTO        WRTE100 IF NOT EQUAL
.
        COMPARE     ZERO TO XTOTOUT
        GOTO        WRTEFU1 IF EQUAL
.
WRTE100 MOVE        ONE TO SORTDIM
        ADD         ONE TO UNIQUE
.
.       MOVE        AFUNDH,SHFUND         * Melbourne clinic
        PACK        SHFUND,AFUNDH,SP70
.
        MOVE        ACLAIM,SACLM
.
        MOVE        AFUNDH,HFUND
        BRANCH      SEPFUND OF CSEPC
        MOVE        "ZZZZZZ",HFUND
.
CSEPC   BRANCH      SEPCLM OF WRTFT
        MOVE        "ZZZ",ACLAIM
.
WRTFT   MOVE        XTREBCUR,XTSUBREB
        ADD         XTREB30,XTSUBREB
        ADD         XTREB60,XTSUBREB
        ADD         XTREB90,XTSUBREB
        ADD         XTREB120,XTSUBREB
.
        MOVE        XTPATCUR,XTSUBPAT
        ADD         XTPAT30,XTSUBPAT
        ADD         XTPAT60,XTSUBPAT
        ADD         XTPAT90,XTSUBPAT
        ADD         XTPAT120,XTSUBPAT
.
        MOVE        UNIQUE,XUNIQUE
        MOVE        AURNO,XAURNO
        MOVE        AADMNO,XAADMNO
        WRITE       TEMPSEQ,SEQ;ACLAIM,HFUND,XAURNO,XAADMNO,PSNAME,PGNAME:
                                SORTDIM,XUNIQUE:
                                DDDAY,DDMON,DDYER,DDCEN,XTOTPAID:
                                XTOTCURR,XTOT30,XTOT60,XTOT90:
                                XTOT120,XTOT1YR,XTOT2YR:
                                ATYPE,ADDAY,ADMON,ADYER,ADCEN:
                                XTOTOUT,PINVREB,PINVPAT,XTREBCUR,XTPATCUR:
                                XTREB30,XTPAT30,XTREB60,XTPAT60,XTREB90,XTPAT90:
                                XTREB120,XTPAT120,XTSUBREB,XTSUBPAT:
                                SHFUND,SACLM,KEY2
.
WRTEFU1 MOVE        ZERO TO XTOTPAID
        MOVE        ZERO TO XTOTCURR
        MOVE        ZERO TO XTOT30
        MOVE        ZERO TO XTOT60
        MOVE        ZERO TO XTOT90
        MOVE        ZERO TO XTOT120
        MOVE        ZERO TO XTOT1YR
        MOVE        ZERO TO XTOT2YR
        MOVE        PINVADM TO SAVADMNO
.
.       MOVE        ZERO TO HFPAID
.       MOVE        ZERO TO PATPAID
.
        MOVE        ZERO TO XTREBCUR
        MOVE        ZERO TO XTPATCUR
        MOVE        ZERO TO XTREB30
        MOVE        ZERO TO XTPAT30
        MOVE        ZERO TO XTREB60
        MOVE        ZERO TO XTPAT60
        MOVE        ZERO TO XTREB90
        MOVE        ZERO TO XTPAT90
        MOVE        ZERO TO XTREB120
        MOVE        ZERO TO XTPAT120
        MOVE        ZERO TO XTSUBREB
        MOVE        ZERO TO XTSUBPAT
        RETURN
.
WRTEDAY MOVE        PINVNO TO TINVNO
.
WRTEDA1 MOVE        ONE TO SORTDIM
        ADD         ONE TO UNIQUE
.
        COMPARE     ONE,PTCNCATB
        GOTO        WRTEDA2 IF NOT EQUAL
.
        PACK        VSCTDATA,SP70,SP70
        MOVE        "  1",VSCTLINE
        MOVE        "003",VSCTTYPE      * Billing comments
        PACK        KEY14,AADMNO,VSCTTYPE,VSCTLINE
        CALL        RDVSCMT1
        IF          OVRCD=1
          MOVE        SP70,VSCTDATA
        ENDIF       
.
        MOVE        VSCTDATA,CMNTLINE
        GOTO        WRTEDA3
.
WRTEDA2  MOVE        AADMNO,KEY8 
         CALL        VSCMTX00 
         MOVE        VSMTCMNT,CMNTLINE
.
WRTEDA3  MOVE        SP3,REMLSTL
         MOVE        SP8,LSTLDAT
         MOVE        AADMNO,KEY8
         CALL        RDREMD1
         BRANCH      OVRCD OF CHKSCL2
.
         MATCH       SP6,REMLDTE
         GOTO        CHKSCL2 IF EQUAL
.
         UNPACK      REMLDTE WITH XCENT1,XYEAR1,XMON1,XDAY1
         PACK        LSTLDAT WITH XDAY1,SLASH,XMON1,SLASH,XYEAR1
.
CHKSCL2  BRANCH      SEPCLM OF CHKSHFA
         MOVE        "ZZZ",ACLAIM
.
CHKSHFA  MOVE        AFUNDH,HFUND
         BRANCH      SEPFUND OF WRTTDY
         MOVE        "ZZZZZZ",HFUND
.
WRTTDY   MOVE        UNIQUE,XUNIQUE
         MOVE        AURNO,XAURNO
         MOVE        AADMNO,XAADMNO
         MOVE        PTELEP,D12PTELP     * since PTELEP/b = 20 chars (new file)
         MOVE        PTELEB,D12PTELB
         WRITE       TEMPSEQ,SEQ;ACLAIM,HFUND,XAURNO,XAADMNO,PSNAME,PGNAME:
                                SORTDIM,XUNIQUE,PTITL,D12PTELP:
                                PINVAMT,TINVNO,XDAY,XMON,XYEAR,XCENT,XTINVAMT:
                                AFUNDH,AFNDTB,AFNDMM:
                                D12PTELB,DDDAY,DDMON,DDYER,DDCEN,CMNTLINE:
                                REMLSTL,LSTLDAT,SPINVTYP,SPINVSYS,TEMP40
.
        ADD         XTINVAMT TO TOTDAYS
        MOVE        ZERO TO XTOTPAID
        MOVE        ZERO TO XTOTCURR 
        MOVE        ZERO TO XTOT30
        MOVE        ZERO TO XTOT60
        MOVE        ZERO TO XTOT90
        RETURN
+
..........................................................................
.      SORT THE DATA FILE
.
SORTD   MOVE            ZERO,STATUS
        BRANCH          OPTION1 TO SORTD1
.
        CALL            WRTEHED
        GOTO            SORTD2
.
SORTD1  CALL            WRTEFUL
.
SORTD2  DISPLAY    *P1:24,*EL,*P20:24,"** PROCESSING STATISTICS **",*W;
.
        WEOF          TEMPSEQ,SEQ
        CLOSE         TEMPSEQ
.
        CLEAR         CMDLINE
        APPEND        "isbuild ",CMDLINE
        APPEND        FNAMET,CMDLINE
        APPEND        " 297 ",CMDLINE
        APPEND        SORTSTR,CMDLINE
        APPEND        SP70,CMDLINE
        RESET         CMDLINE
        EXECUTE       CMDLINE,TASKID
.
        CLEAR         CMDLINE
        APPEND        "isbload ",CMDLINE
        APPEND        FNAMET,CMDLINE
        APPEND        ".txt ",CMDLINE
        APPEND        FNAMET,CMDLINE
        APPEND        SP70,CMDLINE
        RESET         CMDLINE
        EXECUTE       CMDLINE,TASKID
.
        MOVE          ONE,STATUS
        DISPLAY       *P1:12,*EF
        MOVE         ZERO TO OPCND
.
        BRANCH       STATUS OF SORTFI
.
        BEEP
        MOVE       ONE,OPCND
        DISPLAY    *P20:24,"** THE STATISTICS FILE IS EMPTY **",*W2;
.
        GOTO       ENDP   
.
NOOPEN  MOVE          ONE,OPCND
        BEEP
        DISPLAY       *P1:24,*EL,"** TEMPORARY STATISTICS  FILE ":
                      FNAMET," NOT FOUND **",*W2;
        RETURN
.
SORTFI  
        TRAP          NOOPEN IF IO
        OPEN          TEMPFILE,FNAMET
        TRAPCLR       IO
.
        DISPLAY       *P1:12,*EF
.
        COMPARE       ONE TO OPCND
        GOTO          ENDP IF EQUAL
.
        MOVE          ZERO TO XTTOTPAY
        MOVE          ZERO TO XTOTPAID
        MOVE          ZERO TO XTTOTCUR
        MOVE          ZERO TO XTTOT30
        MOVE          ZERO TO XTTOT60
        MOVE          ZERO TO XTTOT90
        MOVE          ZERO TO XTTOT120
        MOVE          ZERO TO XTTOT1YR
        MOVE          ZERO TO XTTOT2YR
        MOVE          ZERO TO XTTOTOUT
        MOVE          ZERO TO XCTPAID
        MOVE          ZERO TO XCTCURR
        MOVE          ZERO TO XCT30
        MOVE          ZERO TO XCT60
        MOVE          ZERO TO XCT90
        MOVE          ZERO TO XCT120
        MOVE          ZERO TO XCT1YR
        MOVE          ZERO TO XCT2YR
        MOVE          ZERO TO XCTTOT
        MOVE          ZERO TO XHTPAID
        MOVE          ZERO TO XHTCURR
        MOVE          ZERO TO XHT30
        MOVE          ZERO TO XHT60
        MOVE          ZERO TO XHT90
        MOVE          ZERO TO XHT120
        MOVE          ZERO TO XHT1YR
        MOVE          ZERO TO XHT2YR
        MOVE          ZERO TO XHTTOT
        MOVE          SIXTY TO CLNO
        MOVE          ZERO TO ENDFLAG
        MOVE          ZEROVISN TO SAVADMNO
        MOVE          SP6,HFUND
        MOVE          SP30,HFNAME
.
.       Initialize variables used for Melbourne clinic ATB
.
        MOVE          ZERO,XTTREBCR
        MOVE          ZERO,XTTPATCR
        MOVE          ZERO,XTTREB30
        MOVE          ZERO,XTTPAT30
        MOVE          ZERO,XTTREB60
        MOVE          ZERO,XTTPAT60
        MOVE          ZERO,XTTREB90
        MOVE          ZERO,XTTPAT90
        MOVE          ZERO,XTTRE120
        MOVE          ZERO,XTTPA120
        MOVE          ZERO,XTTSUBRE
        MOVE          ZERO,XTTSUBPA
        MOVE          ZERO,XCREBCUR
        MOVE          ZERO,XCPATCUR
        MOVE          ZERO,XCREB30
        MOVE          ZERO,XCPAT30
        MOVE          ZERO,XCREB60
        MOVE          ZERO,XCPAT60
        MOVE          ZERO,XCREB90
        MOVE          ZERO,XCPAT90
        MOVE          ZERO,XCREB120
        MOVE          ZERO,XCPAT120
        MOVE          ZERO,XCSUBREB
        MOVE          ZERO,XCSUBPAT
        MOVE          ZERO,XHREBCUR
        MOVE          ZERO,XHPATCUR
        MOVE          ZERO,XHREB30
        MOVE          ZERO,XHPAT30
        MOVE          ZERO,XHREB60
        MOVE          ZERO,XHPAT60
        MOVE          ZERO,XHREB90
        MOVE          ZERO,XHPAT90
        MOVE          ZERO,XHREB120
        MOVE          ZERO,XHPAT120
        MOVE          ZERO,XHSUBREB
        MOVE          ZERO,XHSUBPAT
.
        DISPLAY     *P1:24,*EL,*P20:24,"Admission Number : ":
                               *P48:24,"Name : ";
.
        READ          TEMPFILE,SP70;;
.  
        BRANCH        OPTION1 TO FULLREP,DAYREP,DAYREP,DAYREP,DAYREP
.
FULLREP READKS        TEMPFILE;ACLAIM,HFUND,XAURNO,XAADMNO,PSNAME,PGNAME:
                               SORTDIM,XUNIQUE:
                               DDDAY,DDMON,DDYER,DDCEN,XTOTPAID:
                               XTOTCURR,XTOT30,XTOT60,XTOT90:
                               XTOT120,XTOT1YR,XTOT2YR:
                               ATYPE,ADDAY,ADMON,ADYER,ADCEN:
                               XTOTOUT,PINVREB,PINVPAT,XTREBCUR,XTPATCUR:
                               XTREB30,XTPAT30,XTREB60,XTPAT60,XTREB90,XTPAT90:
                               XTREB120,XTPAT120,XTSUBREB,XTSUBPAT:
                               SHFUND,SACLM,KEY2
        GOTO          FULLEND IF OVER
.
.       Check for health fund range
.
        MOVE          SHFUND,DIM6
        MATCH         STHFN,DIM6
        GOTO          FULLREP IF LESS
.
        MATCH         DIM6,EDHFN
        GOTO          FULLREP IF LESS
.
        MOVE          XUNIQUE,UNIQUE
        MOVE          XAURNO,AURNO
        MOVE          XAADMNO,AADMNO
.
        MOVE          PGNAME TO ANS
        PACK          PNAME WITH ANS,DOT,PSNAME
        RESET         PNAME
        MOVE          PNAME,PNAMEDIS
        MOVE          PNAME,PNAMEDS2
        MOVE          PGNAME,PGNAMEDS
        MOVE          PGNAME,PGNAMED2
        MOVE          PSNAME,PSNAMEDS
.
        DISPLAY       *P39:24,*V2LON,AADMNO,*P55:24,PNAME;
.
        CALL          PRINTFUL
.
        GOTO          FULLREP
.
FULLEND MOVE         SP3,ACLAIM       * To prevent the health fund title print
.
        COMPARE      "48" TO CLNO
        CALL         HEAD IF NOT LESS
.
        BRANCH        SEPFUND OF PRTHTTS,CHKCTTS
.
PRTHTTS CALL          HFTOT
.
CHKCTTS BRANCH        SEPCLM OF PRTCTTS,PRTTTS
.
PRTCTTS CALL          CLMTOT
.
PRTTTS   BRANCH        CATBLAY OF FEND1,FEND2,FEND2,FEND4
.
FEND0  
.        PRINT         *N,*N,*N,*54,"----------",*65,"----------":
.                         *76,"----------",*87,"----------":
.                         *98,"----------",*113,"----------";
.                      *N,*36,"OVERALL TOTAL : ",*53,TTOTPAID,*64,TTOTCURR:
.                         *75,TTOT30,*86,TTOT60,*97,TTOT90:
.                         *112,TTOTOUT:
.                      *N,*54,"----------",*65,"----------":
.                         *76,"----------",*87,"----------":
.                         *98,"----------",*113,"----------"
.
        PRINT          *N,*1,"OVERALL TOTALS";
        PRINT          *N,*1,"----------------------";
        PRINT          *N,*1,"Paid     : ",XTTOTPAY;               
        PRINT          *N,*1,"Current  : ",XTTOTCUR;               
        PRINT          *N,*1,"30 Days  : ",XTTOT30;               
        PRINT          *N,*1,"60 Days  : ",XTTOT60;               
        PRINT          *N,*1,"90+ Days : ",XTTOT90;               
        PRINT          *N,*1,"--------------------------";
        PRINT          *N,*1,"Total    : ",XTTOTOUT;              
        GOTO          ENDP
.
FEND1   PRINT         *N,*N,*N,*63,"----------",*78,"----------":
                         *93,"----------",*108,"----------":
                         *123,"----------",*N:
                         *37,"OVERALL TOTAL : ",*58,XTTOT90,*73,XTTOT60:
                         *88,XTTOT30,*103,XTTOTCURR,*118,XTTOTOUT,*N:
                         *63,"----------",*78,"----------":
                         *93,"----------",*108,"----------":
                         *123,"----------"
        GOTO          ENDP
.
FEND2   PRINT         *N,*N,*N:
                        *18,"----------",*33,"----------":
                        *48,"----------",*63,"----------":
                        *78,"----------",*93,"----------":
                        *108,"----------",*123,"----------",*N:
                        *1,"OVERALL TOTAL":
                        *13,XTTOTCUR,*28,XTTOT30,*43,XTTOT60:
                        *58,XTTOT90,*73,XTTOT120,*88,XTTOT1YR:
                        *103,XTTOT2YR,*118,XTTOTOUT,*N:
                        *18,"----------",*33,"----------":
                        *48,"----------",*63,"----------":
                        *78,"----------",*93,"----------":
                        *108,"----------",*123,"----------"
        GOTO          ENDP
.
FEND4   PRINT       *N,*N,*N:
                      *33,"----------":
                      *48,"----------",*63,"----------":
                      *78,"----------",*93,"----------",*108,"----------":
                      *123,"-----------",*N:
                      *10,"OVERALL TOTAL":
                      *28,XTTRE120,*43,XTTREB90,*58,XTTREB60:
                      *73,XTTREB30,*88,XTTREBCUR,*103,XTTSUBRE:
                      *118,XTTOTOUT,*N:
                      *28,XTTPA120,*43,XTTPAT90,*58,XTTPAT60:
                      *73,XTTPAT30,*88,XTTPATCUR,*103,XTTSUBPA:
                      *N,*33,"----------":
                      *48,"----------",*63,"----------":
                      *78,"----------",*93,"----------",*108,"----------":
                      *123,"----------"
        GOTO          ENDP
.
DAYREP  MOVE          ZEROVISN TO AADMNO
        READKS        TEMPFILE;ACLAIM,HFUND,XAURNO,XAADMNO,PSNAME,PGNAME:
                               SORTDIM,XUNIQUE,PTITL,D12PTELP:
                               PINVAMT:
                               TINVNO,XDAY,XMON,XYEAR,XCENT:
                               XTINVAMT:
                               AFUNDH,AFNDTB,AFNDMM:
                               D12PTELB,DDDAY,DDMON,DDYER,DDCEN,CMNTLINE:
                               REMLSTL,LSTLDAT,SPINVTYP,SPINVSYS,TEMP40
        GOTO          DAYEND IF OVER
        MOVE          D12PTELP,PTELEP
        MOVE          D12PTELB,PTELEB
        MOVE          SPINVTYP,PINVTYP
        MOVE          SPINVSYS,PINVSYS
.
.       Check for health fund range
.
        MATCH         STHFN,AFUNDH
        GOTO          DAYREP IF LESS
.
        MATCH         AFUNDH,EDHFN
        GOTO          DAYREP IF LESS
.
        MOVE          XUNIQUE,UNIQUE
        MOVE          XAURNO,AURNO
        MOVE          XAADMNO,AADMNO
        MOVE          PGNAME,PGNAMEDS
        MOVE          PGNAME,PGNAMED2
        MOVE          PSNAME,PSNAMEDS
.
        DISPLAY       *P39:24,*V2LON,AADMNO,*P55:24,PSNAME,*HOFF;
.
        MATCH         AADMNO TO SAVADMNO
        GOTO          CALCINV9 IF EQUAL
.
        MATCH         ZEROVISN,SAVADMNO
        GOTO          DAYREP0 IF EQUAL
.
        PACK          FADATE WITH CCC,CYY,CMM,CDD
        REP           " 0",FADATE
.
        PACK          KEY19 WITH SAVADMNO,FADATE,SP10                  *C-79281
        CALL          RDSFACT1                                         *C-79281
....    BRANCH        OVRCD OF TRNXTFA
....    GOTO          PRTFAC
.
TRNXTFA CALL          RDKFACT1
        BRANCH        OVRCD OF DAYREP0
.
        MATCH         FADMNO,SAVADMNO
        GOTO          DAYREP0 IF NOT EQUAL
.
PRTFAC  UNPACK        FADATE WITH XCENT1,XYEAR1,XMON1,XDAY1
        PRINT         *105,"FUTURE ACTION DATE: ",XDAY1,"/",XMON1,"/",XYEAR1
        ADD           ONE,CLNO
.
DAYREP0 MOVE          XTINVAMT TO XTOTOUT
        ADD           XTOTOUT TO XTTOTOUT
.
.         IF        OPTION1<>1
.           MOVE      SAVADMNO,DIM8VISN
.           PERFORM   PRTADCOM,PRCM0000     * Check if printing comments
.         ENDIF
.
        MOVE          AADMNO TO SAVADMNO
.
        MATCH        ACLAIM TO SAVCLM
        CALL         HEAD IF NOT EQUAL
.
        PACK         CLMFUND WITH ACLAIM,HFUND
.
        MATCH        CLMFUND TO SAVFUND
        CALL         HFTOT IF NOT EQUAL
.
        BRANCH       TOTONLY OF DAYREP3
.
        MOVE         CMNTLINE,DIM64
.
        MOVE         SP8 TO DIM8
        COMPARE      ZERO,DDDAY
        GOTO         DAYREP1 IF EQUAL
.
        PACK         DIM8 WITH DDDAY,SLASH,DDMON,SLASH,DDYER
.
DAYREP1 MOVE         SP20 TO DIM14
        MOVE         SP20,DIM13
        MATCH        SP12 TO PTELEP
        GOTO         DAYREP2 IF EQUAL
.
        PACK         DIM14 WITH HD,PTELEP
        MOVE         DIM14,DIM13
.
DAYREP2 COMPARE      "54" TO CLNO
        CALL         HEAD IF NOT LESS
        REP          " 0",DIM8
        UNPACK       PSNAMEDS,KEY12
        OPEN         CONTROLF,"controlf"
        READ         CONTROLF,HUND10;*249,PTCNDAUR
        PACK         DIM9,AURNO,SP70
        MATCH        "1",PTCNDAUR
        IF           @EQUAL
          MOVE         AURNO,PURNO
          PACK         KEY20,SP70
          PROC         GETALIDS
          MATCH        SP70,KEY20
          IF           !@EQUAL
            UNPACK       KEY20,DIM11,DIM9
          ENDIF
        ENDIF
.
        PRINT        *N,DIM9,*10,AADMNO,*19,KEY12,SP1,DIM8:
                     *40,XTOTOUT:
                     *56,DIM13,*69,DIM64
.
        ADD          TWO TO CLNO
        MOVE         ZERO TO COUNT
.
DAYREP3 MOVE         ACLAIM TO SAVCLM
        PACK         SAVFUND WITH ACLAIM,HFUND
        ADD          XTOTOUT TO XCTTOT
        ADD          XTOTOUT TO XHTTOT
        GOTO         DAYREP
.
CALCINV9
        CALL          PRINTDAY
        MOVE          AADMNO TO SAVADMNO
        GOTO          DAYREP
.
DAYEND  MOVE         SP3,ACLAIM
.
        COMPARE      "48" TO CLNO
        CALL         HEAD IF NOT LESS
.
        BRANCH        SEPFUND OF PRTHDTS,CHKCDTS
.
PRTHDTS CALL          HFTOT
.
CHKCDTS BRANCH        SEPCLM OF PRTCDTS,PRTDTS
.
PRTCDTS CALL          CLMTOT
.
PRTDTS  PRINT         *N,*39,"----------------":
                      *N,*23,"OVERALL TOTAL : $",*40,XTTOTOUT:
                      *N,*39,"----------------"
.
        GOTO          ENDP
+
.           OVER CONDITION FOUND..PRINT LAST LINE OF -- AND DISPLAY MESSAGE
.
ENDP     
         COMPARE   ZERO TO XTTOTOUT
         GOTO      END10 IF NOT EQUAL
.
         CALL      HEAD
         PRINT     *N,*N,"  ***  END OF REPORT  ***"
         DISPLAY   *P10:24,*EL,*V2LON:
                   "** No Report Generated **",*W2;
         GOTO      DELFILE
.
END10    PRINT     *N,"  ***  END OF REPORT  ***"
.
         DISPLAY   *P10:24,*EL,*V2LON:
                   "** Report Generation Completed **",*W2;
.
DELFILE
.        CALL      KILLIDZ 
.        CLOSE     TEMPSEQ
.        PREP      TEMPSEQ,FNAMET
.        CLOSE     TEMPSEQ
         GOTO      START
+
.     PRINT ACTUAL DATA 
.
PRINTDAY  BRANCH    TOTONLY OF DAYRET
          COMPARE   "55",CLNO
          CALL      HEAD IF NOT LESS
.
          MOVE      SP20 TO DIM14
          MOVE      SP20,DIM13
          ADD       ONE TO COUNT
          COMPARE   ONE TO COUNT
          GOTO      FIRSTON IF EQUAL
.
          MOVE      SP6 TO PTITL
          MOVE      SP30 TO PGNAME
          MOVE      SP30,PGNAMEDS
          MOVE      SP30,PGNAMED2
          MOVE      SP6 TO AFUNDH
          MOVE      SP8 TO AFNDTB
          MOVE      SP70 TO AFNDMM
          MOVE      SP3,REMLSTL
          MOVE      SP8,LSTLDAT
          GOTO      PRNTDAY1
.
FIRSTON   MATCH     SP12 TO PTELEB
          GOTO      PRNTDAY1 IF EQUAL
.
          PACK      DIM14 WITH BD,PTELEB
          MOVE      DIM14,DIM13
.
PRNTDAY1  MOVE      SP3,DIM3
          LOAD      DIM3 USING PINVTYP OF DINS
.
          MOVE      AFNDTB,DIM5
          MOVE      XTINVAMT,TINVAMT
          UNPACK    AFNDMM,DIM10,DIM9
          MATCH     SP70,DIM9
          IF        !@EQUAL
            MOVE      AFNDMM,DIM9
            PACK      DIM10,DIM9,STAR
          ENDIF
          PRINT     *19,PTITL,SP1,PGNAMEDS,*41,DIM13:
                    *61,DIM3,TINVNO,*73,XDAY,SLASH,XMON,SLASH,XYEAR:
                    *81,XTINVAMT,*98,AFUNDH,SP1,DIM5:
                    *110,DIM10:
                    *121,REMLSTL,*125,LSTLDAT
          ADD       ONE,CLNO
DAYRET    RETURN
.
PRINTFUL  MATCH     ACLAIM TO SAVCLM
          CALL      HEAD IF NOT EQUAL
.
          PACK      CLMFUND WITH ACLAIM,HFUND
.
          MATCH     CLMFUND TO SAVFUND
          CALL      HFTOT IF NOT EQUAL
.
          BRANCH    TOTONLY OF ACCTOTS
.
          COMPARE   "48",CLNO
          CALL      HEAD IF NOT LESS
.
          MOVE      SP8 TO PDIM8
          MOVE      SP8 TO DIM8
          MOVE      SP10 TO PDIM10
          MOVE      SP10 TO DIM10
.
          COMPARE   ZERO TO ADDAY
          GOTO      FULBRNCH IF EQUAL
.
          PACK      DIM8 WITH ADDAY,SLASH,ADMON,SLASH,ADYER
          REP       " 0",DIM8
          PACK      DIM10 WITH ADDAY,SLASH,ADMON,SLASH,ADCEN,ADYER
          REP       " 0",DIM10
.
          COMPARE   ZERO,DDDAY
          GOTO      FULBRNCH IF EQUAL
.
          PACK      PDIM8 WITH DDDAY,SLASH,DDMON,SLASH,DDYER
          REP       " 0",PDIM8
          PACK      PDIM10 WITH DDDAY,SLASH,DDMON,SLASH,DDCEN,DDYER
          REP       " 0",PDIM10
.
FULBRNCH  BRANCH    CATBLAY OF PRINTFU1,PRINTFU2,PRINTFU2,PRINTFU4
.
PRINTFU0  UNPACK    PNAME,KEY13
          OPEN      CONTROLF,"controlf"
          READ      CONTROLF,HUND10;*249,PTCNDAUR
          PACK      DIM9,AURNO,SP70
          MATCH     "1",PTCNDAUR
          IF        @EQUAL
            MOVE      AURNO,PURNO
            PACK      KEY20,SP70
            PROC      GETALIDS
            MATCH     SP70,KEY20
            IF        !@EQUAL
              UNPACK    KEY20,DIM11,DIM9
            ENDIF
          ENDIF
.
          PRINT     *1,DIM9,*10,AADMNO,*19,KEY13,*32,PDIM10:
                    *43,XTOTPAID,*58,XTOTCURR,*73,XTOT30:
                    *88,XTOT60,*103,XTOT90,*118,XTOTOUT
          ADD       ONE,CLNO
.
          IF        OPTION1=1
            MOVE      AADMNO,DIM8VISN
            PERFORM   PRTADCOM,PRCM0000     * Check if printing comments
          ENDIF
          GOTO      ACCTOTS
.
.
PRINTFU1  UNPACK    PSNAME,KEY10
          UNPACK    PGNAMED2,KEY11
          PRINT     *1,AADMNO,*10,KEY10,SP1,KEY11,*33,ATYPE:
                    *37,DIM10,*48,PDIM10:
                    *58,XTOT90,*73,XTOT60:
                    *88,XTOT30,*103,XTOTCURR,*118,XTOTOUT
          ADD       ONE,CLNO
.
          GOTO      ACCTOTS
.
PRINTFU2  OPEN      CONTROLF,"controlf"
          READ      CONTROLF,HUND10;*249,PTCNDAUR
          PACK      DIM9,AURNO,SP70
          MATCH     "1",PTCNDAUR
          IF        @EQUAL
            MOVE      AURNO,PURNO
            PACK      KEY20,SP70
            PROC      GETALIDS
            MATCH     SP70,KEY20
            IF        !@EQUAL
              UNPACK    KEY20,DIM11,DIM9
            ENDIF
          ENDIF
.
          PRINT     *1,DIM9:
                    *13,XTOTCURR:
                    *28,XTOT30,*43,XTOT60,*58,XTOT90,*73,XTOT120:
                    *88,XTOT1YR,*103,XTOT2YR,*118,XTOTOUT
.
          PRINT     *1,AADMNO,*10,PNAMEDIS
          ADD       ONE,CLNO
.
          GOTO      ACCTOTS
.
.         Melbourne Clinic ATB
.
PRINTFU4  UNPACK    PNAMEDS2,KEY13
          OPEN      CONTROLF,"controlf"
          READ      CONTROLF,HUND10;*249,PTCNDAUR
          PACK      DIM9,AURNO,SP70
          MATCH     "1",PTCNDAUR
          IF        @EQUAL
            MOVE      AURNO,PURNO
            PACK      KEY20,SP70
            PROC      GETALIDS
            MATCH     SP70,KEY20
            IF        !@EQUAL
              UNPACK    KEY20,DIM11,DIM9
            ENDIF
          ENDIF
.
          PRINT     *1,DIM9,*10,KEY13,*24,SACLM:
                    *28,XTREB120,*43,XTREB90,*58,XTREB60,*73,XTREB30:
                    *88,XTREBCUR,*103,XTSUBREB,*118,XTOTOUT:
                    *N,*1,AADMNO:
                    *22,SHFUND:
                    *28,XTPAT120,*43,XTPAT90,*58,XTPAT60,*73,XTPAT30:
                    *88,XTPATCUR,*103,XTSUBPAT,*N:
                    *10,DIM10,"->",PDIM10
          ADD       THREE,CLNO
.
ACCTOTS   ADD       XTOTPAID TO XTTOTPAY
          ADD       XTOTCURR TO XTTOTCUR
          ADD       XTOT30 TO XTTOT30
          ADD       XTOT60 TO XTTOT60
          ADD       XTOT90 TO XTTOT90
          ADD       XTOT120 TO XTTOT120
          ADD       XTOT1YR TO XTTOT1YR
          ADD       XTOT2YR TO XTTOT2YR
          ADD       XTOTOUT TO XTTOTOUT
          ADD       XTOTPAID TO XCTPAID
          ADD       XTOTCURR TO XCTCURR
          ADD       XTOT30 TO XCT30
          ADD       XTOT60 TO XCT60
          ADD       XTOT90 TO XCT90
          ADD       XTOT120 TO XCT120
          ADD       XTOT1YR TO XCT1YR
          ADD       XTOT2YR TO XCT2YR
          ADD       XTOTOUT TO XCTTOT
          ADD       XTOTPAID TO XHTPAID
          ADD       XTOTCURR TO XHTCURR
          ADD       XTOT30 TO XHT30
          ADD       XTOT60 TO XHT60
          ADD       XTOT90 TO XHT90
          ADD       XTOT120 TO XHT120
          ADD       XTOT1YR TO XHT1YR
          ADD       XTOT2YR TO XHT2YR
          ADD       XTOTOUT TO XHTTOT
          MOVE      ACLAIM TO SAVCLM
          PACK      SAVFUND WITH ACLAIM,HFUND
.
.         Melbourne clinic
.
          ADD       XTREBCUR,XTTREBCR
          ADD       XTPATCUR,XTTPATCR
          ADD       XTREB30,XTTREB30
          ADD       XTPAT30,XTTPAT30
          ADD       XTREB60,XTTREB60
          ADD       XTPAT60,XTTPAT60
          ADD       XTREB90,XTTREB90
          ADD       XTPAT90,XTTPAT90
          ADD       XTREB120,XTTRE120
          ADD       XTPAT120,XTTPA120
          ADD       XTSUBREB,XTTSUBRE
          ADD       XTSUBPAT,XTTSUBPA
.
          ADD       XTREBCUR,XCREBCUR
          ADD       XTPATCUR,XCPATCUR
          ADD       XTREB30,XCREB30
          ADD       XTPAT30,XCPAT30
          ADD       XTREB60,XCREB60
          ADD       XTPAT60,XCPAT60
          ADD       XTREB90,XCREB90
          ADD       XTPAT90,XCPAT90
          ADD       XTREB120,XCREB120
          ADD       XTPAT120,XCPAT120
          ADD       XTSUBREB,XCSUBREB
          ADD       XTSUBPAT,XCSUBPAT
.
          ADD       XTREBCUR,XHREBCUR
          ADD       XTPATCUR,XHPATCUR
          ADD       XTREB30,XHREB30
          ADD       XTPAT30,XHPAT30
          ADD       XTREB60,XHREB60
          ADD       XTPAT60,XHPAT60
          ADD       XTREB90,XHREB90
          ADD       XTPAT90,XHPAT90
          ADD       XTREB120,XHREB120
          ADD       XTPAT120,XHPAT120
          ADD       XTSUBREB,XHSUBREB
          ADD       XTSUBPAT,XHSUBPAT
          RETURN
+
.                 HEADINGS FOR OUTPUT
.
HEAD      COMPARE   ZERO TO CPAGENO
          GOTO      ADDPAGE IF EQUAL
.
          PACK      CLMFUND WITH ACLAIM,HFUND
.
          MATCH     CLMFUND TO SAVFUND
          CALL      HFTOT IF NOT EQUAL
.
          MATCH     ACLAIM TO SAVCLM
          CALL      CLMTOT IF NOT EQUAL
.
ADDPAGE   MOVE      ONE,CNOUNDLN
          CALL      IBACLOCK
.
          BRANCH    TOTONLY OF PRNTD
.
          BRANCH    OPTION OF PRNTA,PRNTB,PRNTC
.
PRNTA     MOVE      "U/R NUMBER SEQUENCE",CPHDROPT
          GOTO      PRTCONT
.
PRNTB     MOVE      "SURNAME SEQUENCE",CPHDROPT
          GOTO      PRTCONT
.
PRNTC     MOVE      "ADM NUMBER SEQUENCE",CPHDROPT
          GOTO      PRTCONT
.
PRNTD     MOVE      "TOTALS ONLY SELECTED",CPHDROPT
.
PRTCONT   CALL      HEAD132                 
          IF        IBCNMHOS =1
            PRINT     *40,"Hospital : ",PTHSHOSP,"    ",PTHSNAME
            MOVE      THREE,CLNO
          ELSE
            MOVE      TWO,CLNO
          ENDIF
.
          CLOCK     TIME,CTIMEIS
.
          MOVE      SP30 TO TDESC
.
          COMPARE   ONE,SEPCLM
          GOTO      PRTC10 IF NOT EQUAL
.
          PACK      KEY5 WITH CODECL,ACLAIM
          CALL      RDCODE1
.
PRTC10    BRANCH    OPTION1 TO PRTCONT1
.
          PACK      DIM10,IDAY,SLASH,IMON,SLASH,ICENT,IYEAR
          REP       " 0",DIM10
.
          BRANCH    SEPCLM OF PRTSCL1,PRTCRG1
.
PRTSCL1   PRINT     *1,"Claim Type : ",ACLAIM," ",TDESC:
                    *45,"DEBTORS OUTSTANDING FOR ",DIM9:
                    "    AS AT : ",DIM10:
                    *N,"Health Fund Range : ",FRHFN," to ",TOHFN;
          ADD       ONE,CLNO
          GOTO      PRTBRCH1
.
PRTCRG1   PRINT     *1,"Claim Range : ",FRCLM," to ",TOCLM:
                    *45,"DEBTORS OUTSTANDING FOR ",DIM9:
                    "    AS AT : ",DIM10:
                    *N,"Health Fund Range : ",FRHFN," to ",TOHFN;
          ADD       ONE,CLNO
.
PRTBRCH1  BRANCH    OPTION TO PRTCONTD,PRTCONTE,PRTCONTD
.
PRTCONTD  PRINT     *N,*45,DSYST:
                    *N,*45,DOUTXTRA
          ADD       THREE,CLNO
          GOTO      PRTCONTF
.
PRTCONTE  MATCH     SP30,STARTNM
          IF        @EQUAL
            PRINT     *N,"Starting Surname : Start",*45,DSYST
          ELSE
            PRINT     *N,"Starting Surname : ",STARTNM,*45,DSYST
          ENDIF
          MATCH     Z30,ENDNAM
          IF        @EQUAL
            PRINT     "Ending Surname   : Finish",*45,DOUTXTRA
          ELSE
            PRINT     "Ending Surname   : ",ENDNAM,*45,DOUTXTRA
          ENDIF
          ADD       THREE,CLNO
.
PRTCONTF  PRINT    *N,*3,"U/R",*12,"Adm.",*32,"Dischrge":
                   *48,DIM9,*56,"Tel.",*65,"Invoice":
                   *73,"Invoice":
                   *89,"Invoice",*98,"Membership Details":
                   *121,"Last Letter",*N:
                   *1," Number   Number ",*19,"Patient Name",*35," Date":
                   *44,"Outstanding",*56,"Number":
                   *65,"Number",*76,"Date":
                   *85,"Outstanding",*98,"Fund  Table":
                   *110,"Mem.No.",*121,"Code Sent",*N:
                   *1,"-------- --------",*19,"------------":
                   *32,"--------":
                   *44,"--------------",*56,"--------",*65,"-------":
                   *73,"--------":
                   *85,"------------",*98,"----  -----":
                   *110,"-------",*121,"------------"
.
          ADD       FOUR,CLNO
          GOTO      HEADEXIT
.
PRTCONT1  PACK      DIM10,IDAY,SLASH,IMON,SLASH,ICENT,IYEAR
          REP       " 0",DIM10
          BRANCH    SEPCLM OF PRTSCL2,PRTCRG2
.
PRTSCL2   PRINT     *1,"Claim Type : ",ACLAIM," ",TDESC:
                    *45,"AS AT : ",DIM10,*N:
                    *1,"Health Fund Range : ",*+,FRHFN," to ",TOHFN
          ADD       TWO,CLNO
          GOTO      PRTBRCH2
.
PRTCRG2   PRINT     *1,"Claim Range : ",FRCLM," to ",TOCLM:
                    *45,"AS AT : ",DIM10,*N:
                    *1,"Health Fund Range : ",*+,FRHFN," to ",TOHFN
          ADD       TWO,CLNO
.
PRTBRCH2  BRANCH    OPTION TO PRTCONT3,PRTCONT4,PRTCONT3
.
PRTCONT3  PRINT     *45,DSYST:
                    *N,*45,DOUTXTRA
          ADD       TWO,CLNO
          GOTO      PRTCONT5
.
PRTCONT4  MATCH     SP30,STARTNM
          IF        @EQUAL
            PRINT     *N,"Starting Surname : Start",*45,DSYST
          ELSE
            PRINT     *N,"Starting Surname : ",STARTNM,*45,DSYST
          ENDIF
          MATCH     Z30,ENDNAM
          IF        @EQUAL
            PRINT     "Ending Surname   : Finish",*45,DOUTXTRA
          ELSE
            PRINT     "Ending Surname   : ",ENDNAM,*45,DOUTXTRA
          ENDIF
          ADD       TWO,CLNO
.
PRTCONT5  BRANCH    CATBLAY OF PRTHDF1,PRTHDF2,PRTHDF3,PRTHDF4
.
PRTHDF0   PRINT     *N,*3,"U/R",*12,"Adm.":
                    *19,"Patient Name",*32,"Discharge":
                    *N:
                    *1," Number   Number ",*19,"Comment":
                    *32,"Date",*50,"    Paid",*65," Current":
                    *81,"30 Days",*96,"60 Days",*110,"90+ Days":
                    *128,"Total",*N:
                    *1,"-------- --------"," ------------":
                    *32,"----------",*50,"    ----":
                    *65," -------",*81,"-------":
                    *96,"-------",*110,"--------":
                    *128,"-----",*N
          ADD       FIVE,CLNO
          GOTO      HEADEXIT
.
PRTHDF1   BRANCH    CHOSTYP OF PRTPUB
.
PRTPRV    PRINT     *N,*3,"Adm.",*32,"Adm":
                      *36,"Admission",*47,"Discharge",*N:
                      *1,"Number",*10,"Patient Name":
                      *32,"Typ",*36,"Date",*47,"Date":
                      *65,"90+ Days",*81,"60 Days",*96,"30 Days":
                      *111,"Current",*128,"Total",*N:
                      *1,"--------":
                      *10,"---------------------":
                      *32,"----",*36,"----------",*47,"----------":
                      *65,"-------",*81,"-------":
                      *96,"-------",*111,"-------":
                      *128,"-----",*N
.
          ADD       FIVE,CLNO
          GOTO      HEADEXIT
. 
PRTPUB    PRINT     *N,*3,"Adm.",*52,"Pat.":
                    *57,"Admission",*68,"Discharge",*N:
                    *1," Number ",*10,"Patient Name":
                    *52,"Cls.",*59,"Date",*70,"Date":
                    *81,"90+ Days",*93,"60 Days",*104,"30 Days":
                    *115,"Current",*128,"Total",*N:
                    *1,"--------":
                    *10,"-----------------------------------------":
                    *52,"----",*57,"----------",*68,"----------":
                    *79,"----------",*90,"----------":
                    *101,"----------",*112,"----------":
                    *123,"----------",*N
.
          ADD       FIVE,CLNO
          GOTO      HEADEXIT
.
PRTHDF2   PRINT     *N,*1," U/R No ":
                    *18,"   Current",*33,"   30 Days",*48,"   60 Days":
                    *63,"   90 Days",*78,"  120 Days",*93,"    1 Year":
                    *108,"  2+ Years",*123,"     Total",*N:
                    *1," Adm No ",*10,"Patient Name",*N:
                    *1,"-------- --------":
                    *18,"----------",*33,"----------":
                    *48,"----------",*63,"----------":
                    *78,"----------",*93,"----------":
                    *108,"----------",*123,"----------"
.
          ADD       FIVE,CLNO
          GOTO      HEADEXIT
.
PRTHDF3   PRINT     *N,*1," U/R No ":
                    *18,"   Current",*33,"   30 Days",*48,"   60 Days":
                    *63,"   90 Days",*78,"  120 Days",*93,"  150 Year":
                    *108,"  180 Days",*123,"     Total",*N:
                    *1," Adm No ",*10,"Patient Name",*N:
                    *1,"-------- --------":
                    *18,"----------",*33,"----------":
                    *48,"----------",*63,"----------":
                    *78,"----------",*93,"----------":
                    *108,"----------",*123,"----------"
          ADD       FOUR,CLNO
          GOTO      HEADEXIT
.
.         Melbourne Clinic ATB
.
PRTHDF4   PRINT     *N,*1," U/R No ",*10,"Debtor",*24,"Clm.":
                    *33," 120+ Days":
                    *48,"   90 Days",*63,"   60 Days":
                    *78,"   30 Days",*93,"   Current",*108," Sub-Total":
                    *122,"Total Owing":
                    *N,*1," Adm No ",*24,"Fund":
                    *N,*1,"--------",*10,"------------":
                    *24,"----",*33,"----------":
                    *48,"----------",*63,"----------":
                    *78,"----------",*93,"----------",*108,"----------":
                    *123,"----------",*N
          ADD       FIVE,CLNO
.
HEADEXIT  CALL      HFTITLE
          RETURN
.
.         Subroutine to print the claim totals for each claim type
.
CLMTOT    COMPARE   TWO,SEPCLM
          RETURN    IF EQUAL
.
          BRANCH    OPTION1 TO CLMTOTA
.
          PRINT     *N,*39,"----------------":
                    *N,*23,"CLAIM TOTAL : $ ",*40,XCTTOT:
                    *N,*39,"----------------"
          MOVE      ZERO TO XCTTOT
          RETURN
.
CLMTOTA   BRANCH    CATBLAY OF CLMTOT1,CLMTOT2,CLMTOT2,CLMTOT4
.
CLMTOT0   PRINT       *N,*47,"----------":
                         *63,"----------",*78,"----------":
                         *93,"----------",*108,"----------":
                         *123,"----------":
                      *N,*24,"CLAIM TOTAL : ",*43,XCTPAID,*58,XCTCURR:
                         *73,XCT30,*88,XCT60,*103,XCT90:
                         *118,XCTTOT:
                      *N,*47,"----------":
                         *63,"----------",*78,"----------":
                         *93,"----------",*108,"----------":
                         *123,"----------"
          GOTO        CLMTOTZ
.
CLMTOT1   PRINT       *N,*63,"----------",*78,"----------":
                         *93,"----------",*108,"----------":
                         *123,"----------",*N:
                         *37,"CLAIM TOTAL : ",*58,XCT90,*73,XCT60:
                         *88,XCT30,*103,XCTCURR,*118,XCTTOT,*N:
                         *63,"----------",*78,"----------":
                         *93,"----------",*108,"----------":
                         *123,"----------"
          GOTO        CLMTOTZ
.
CLMTOT2   PRINT       *N,*18,"----------",*33,"----------":
                         *48,"----------",*63,"----------":
                         *78,"----------",*93,"----------":
                         *108,"----------",*123,"----------",*N:
                         *1,"CLAIM TOTAL":
                         *13,XCTCURR,*28,XCT30,*43,XCT60:
                         *58,XCT90,*73,XCT120,*88,XCT1YR:
                         *103,XCT2YR,*118,XCTTOT,*N:
                         *18,"----------",*33,"----------":
                         *48,"----------",*63,"----------":
                         *78,"----------",*93,"----------":
                         *108,"----------",*123,"----------",*N
          GOTO        CLMTOTZ
.
.         Melbourne Clinic ATB
.
CLMTOT4   PRINT    *N,*33,"----------":
                   *48,"----------",*63,"----------":
                   *78,"----------",*93,"----------",*108,"----------":
                   *123,"----------",*N:
                   *10,"CLAIM TOTAL":
                   *28,XCREB120,*43,XCREB90,*58,XCREB60,*73,XCREB30:
                   *88,XCREBCUR,*103,XCSUBREB,*118,XCTTOT:
                   *N,*28,XCPAT120,*43,XCPAT90,*58,XCPAT60,*73,XCPAT30:
                   *88,XCPATCUR,*103,XCSUBPAT:
                   *N,*33,"----------":
                   *48,"----------",*63,"----------":
                   *78,"----------",*93,"----------",*108,"----------":
                   *123,"----------"
.
CLMTOTZ   MOVE        ZERO TO XCTPAID
          MOVE        ZERO TO XCTCURR
          MOVE        ZERO TO XCT30
          MOVE        ZERO TO XCT60
          MOVE        ZERO TO XCT90
          MOVE        ZERO TO XCT120
          MOVE        ZERO TO XCT1YR
          MOVE        ZERO TO XCT2YR
          MOVE        ZERO TO XCTTOT
.
.         Melbourne Clinic
.
          MOVE        ZERO,XCREB120
          MOVE        ZERO,XCPAT120
          MOVE        ZERO,XCREB90
          MOVE        ZERO,XCPAT90
          MOVE        ZERO,XCREB60
          MOVE        ZERO,XCPAT60
          MOVE        ZERO,XCREB30
          MOVE        ZERO,XCPAT30
          MOVE        ZERO,XCREBCUR
          MOVE        ZERO,XCPATCUR
          MOVE        ZERO,XCSUBREB
          MOVE        ZERO,XCSUBPAT
          RETURN
.
.         Print Health Fund Total
.
HFTOT     COMPARE     TWO,SEPFUND
          RETURN      IF EQUAL
.
          BRANCH    OPTION1 TO HFTOTA
.
          MOVE      HFNAME,DIM31
.
          UNPACK    DIM31,KEY25
          PRINT     *N,*40,"---------------":
                    *N,*2,"TOTAL (",KEY25,") : $ ",*40,XHTTOT:
                    *N,*40,"---------------",*N
.
          GOTO      ENDHFTOT
.
HFTOTA    BRANCH    CATBLAY OF HFTOT1,HFTOT2,HFTOT2,HFTOT4
.
HFTOT0    MOVE      HFNAME,DIM37
          UNPACK    DIM37,KEY30
          PRINT     *N,*48,"----------":
                    *63,"----------",*78,"----------":
                    *93,"----------",*108,"----------":
                    *123,"----------":
                    *N,*1,"TOTAL (",KEY30,") : ",*43,XHTPAID,*58,XHTCURR:
                    *73,XHT30,*88,XHT60,*103,XHT90:
                    *118,XHTTOT:
                    *N,*48,"----------":
                    *63,"----------",*78,"----------":
                    *93,"----------",*108,"----------":
                    *123,"----------",*N
          GOTO        HFTOTZ
.
HFTOT1    UNPACK      HFNAME,KEY30
          PRINT       *N,*63,"----------",*78,"----------":
                      *93,"----------",*108,"----------":
                      *123,"----------",*N:
                      *15,"TOTAL (",KEY30,") : ",*58,XHT90,*73,XHT60:
                      *88,XHT30,*103,XHTCURR,*118,XHTTOT,*N:
                      *63,"----------",*78,"----------":
                      *93,"----------",*108,"----------":
                      *123,"----------",*N
.
          GOTO        HFTOTZ
.
HFTOT2    PRINT       *N,*18,"----------",*33,"----------":
                      *48,"----------",*63,"----------":
                      *78,"----------",*93,"----------":
                      *108,"----------",*123,"----------",*N:
                      *1,"FUND TOTAL":
                      *13,XHTCURR,*28,XHT30,*43,XHT60:
                      *58,XHT90,*73,XHT120,*88,XHT1YR:
                      *103,XHT2YR,*118,XHTTOT,*N:
                      *18,"----------",*33,"----------":
                      *48,"----------",*63,"----------":
                      *78,"----------",*93,"----------":
                      *108,"----------",*123,"----------",*N
.
          GOTO        HFTOTZ
.
.         Melbourne clinic
.
HFTOT4    PRINT    *N,*33,"----------":
                      *48,"----------",*63,"----------":
                      *78,"----------",*93,"----------",*108,"----------":
                      *123,"----------":
                      *N,*10,"FUND TOTAL":
                      *28,XHREB120,*43,XHREB90,*58,XHREB60:
                      *73,XHREB30,*88,XHREBCUR,*103,XHSUBREB,*118,XHTTOT:
                      *N,*28,XHPAT120,*43,XHPAT90,*58,XHPAT60:
                      *73,XHPAT30,*88,XHPATCUR,*103,XHSUBPAT,*N:
                      *33,"----------":
                      *48,"----------",*63,"----------":
                      *78,"----------",*93,"----------",*108,"----------":
                      *123,"----------",*N
          ADD         ONE,CLNO         * Extra line
.
          MOVE        ZERO TO XHREB120
          MOVE        ZERO TO XHREB90
          MOVE        ZERO TO XHREB60
          MOVE        ZERO TO XHREB30
          MOVE        ZERO TO XHREBCUR
          MOVE        ZERO TO XHSUBREB
          MOVE        ZERO TO XHPAT120
          MOVE        ZERO TO XHPAT90
          MOVE        ZERO TO XHPAT60
          MOVE        ZERO TO XHPAT30
          MOVE        ZERO TO XHPATCUR
          MOVE        ZERO TO XHSUBPAT
.
HFTOTZ    MOVE        ZERO TO XHTPAID
          MOVE        ZERO TO XHTCURR
          MOVE        ZERO TO XHT30
          MOVE        ZERO TO XHT60
          MOVE        ZERO TO XHT90
          MOVE        ZERO TO XHT120
          MOVE        ZERO TO XHT1YR
          MOVE        ZERO TO XHT2YR
.
ENDHFTOT  MOVE        ZERO TO XHTTOT
          PACK        SAVFUND WITH ACLAIM,HFUND
          ADD         FIVE,CLNO
.
          MATCH       ACLAIM,SAVCLM
          RETURN      IF NOT EQUAL
.
          COMPARE     "52",CLNO
          GOTO        FORCEFF IF NOT LESS
.
.         Check for option of new page for each fund
.
          COMPARE     ONE,PAGFUND
          GOTO        FORCEFF IF EQUAL
.
          CALL        HFTITLE
          RETURN
.
FORCEFF   CALL        HEAD
          RETURN
.
.         Subroutine to print the Health Fund subtitle
.
HFTITLE   BRANCH    SEPFUND OF PRTSHF1,ENDHFTTL
.
PRTSHF1   MATCH     SP6,HFUND
          GOTO      NOFUND1 IF EQUAL
.
          PACK      KEY14 WITH HFUND,ZERO,ZERO,ZERO,ZERO,SP10
          CALL      RDFUND1
          COMPARE   ZERO,OVRCD
          GOTO      PRTSHF2 IF EQUAL
.
          CLEAR     HFNAME
          APPEND    "UNKNOWN HEALTH FUND - ",HFNAME
          APPEND    HFUND,HFNAME
          APPEND    SP30,HFNAME
          RESET     HFNAME
          GOTO      PRTSHF2
.
NOFUND1   MOVE      "NO HEALTH FUND                ",HFNAME
.
PRTSHF2   COMPARE   "52",CLNO
          CALL      HEAD IF NOT LESS
.
          PRINT     *1,HFNAME," (",HFUND,")":
                    *N,"-------------------------------------------------"
          ADD       TWO,CLNO
.
ENDHFTTL  PACK      SAVFUND WITH ACLAIM,HFUND
          RETURN
+
.*************************************************************************
.
.       Deleting an indexed file 
.
KILLIDZ MOVE        ZERO,STATUS
        CLOSE       TEMPFILE
.
        CLEAR         CMDLINE
        APPEND        "iserase ",CMDLINE
        APPEND        FNAMET,CMDLINE
        RESET         CMDLINE
        EXECUTE       CMDLINE,TASKID
.
        DISPLAY       *P1:3,*EF,*P1:10
        RETURN
.
+
.******************************************************************************
.*        PRCM0000 - Print first line of patient comments                     *
.*        Parameters - DIM8VISN - admission number                            *
.******************************************************************************
.
PRCM0000  COMPARE   ONE,PTCNCATB
          GOTO      PRCM1000 IF NOT EQUAL   * Print admission comments
.
          MOVE      "003",VSCTTYPE      * Billing comments
          PACK      KEY14,DIM8VISN,VSCTTYPE,SP70
          CALL      RSVSCMT1
          CALL      RKVSCMT1
          BRANCH    OVRCD,PRCM9999          * No comments
.
          MOVE      DIM8VISN,KEY8
          MATCH     KEY8,VSCTVIST           * same admission?
          GOTO      PRCM9999 IF NOT EQUAL   * No Comments
.
          MOVE      VSCTDATA,KEY70    
          PRINT     *19,KEY70               * Print the comments under other
          GOTO      PRCM2000
.
PRCM1000  MOVE      DIM8VISN,KEY8 
          CALL      VSCMTX00 
. 
          MATCH     SP70,VSMTCMNT
          GOTO      PRCM9999 IF EQUAL       * No Comments
          PRINT     *19,VSMTCMNT            * Print the comments under other
.
PRCM2000  ADD       ONE,CLNO                * details
PRCM9999  RETURN
.
.-----------------------------------------------------------------------
. Retrieve the 1st comment text line of the latest active visit
. comment details
.-----------------------------------------------------------------------
.
VSCMTX00  MOVE      SP70,VSMTCMNT   
          PACK      KEY17,KEY8,VSCMTTYP,Z70
          CALL      RSVSMDT1
VSCMTX10  CALL      RPVSMDT1
          BRANCH    OVRCD,VSCMTX99
.
          MATCH     KEY8,VSMDVISN
          GOTO      VSCMTX99 IF NOT EQUAL
.
          MATCH     VSCMTTYP,VSMDTYPE
          GOTO      VSCMTX99 IF NOT EQUAL
.
          MATCH     "1",VSMDDELT          * is comment deleted
          GOTO      VSCMTX10 IF EQUAL
.
. Retrieve the 1st comment text line details
.
          PACK      KEY20,VSMDVISN,VSMDTYPE,VSMDNOTE,SP70
          CALL      RSVSMTX1
          CALL      RKVSMTX1
          BRANCH    OVRCD,VSCMTX10
.
          MATCH     VSMDVISN,VSMTVISN
          GOTO      VSCMTX10 IF NOT EQUAL
.
          MATCH     VSMDTYPE,VSMTTYPE
          GOTO      VSCMTX10 IF NOT EQUAL
.
          MATCH     VSMDNOTE,VSMTNOTE
          GOTO      VSCMTX10 IF NOT EQUAL
.
VSCMTX99  RETURN
+
.******************************************************************************
.*        CRDN0000 - Credit for credit note                                   *
.******************************************************************************
CRDN0000  MOVE      ZERO,FORM12P2
          PACK      KEY16,PINVNO,SP70
          CALL      RSPMCNO3
CRDN1000  CALL      RKPMCNO3
          BRANCH    OVRCD,CRDN9000
          MATCH     PMCNINVN,PINVNO         * Same invoice number?
          GOTO      CRDN9000 IF NOT EQUAL   * No
.
          MATCH     PMCNDATE,FROMDATE
          GOTO      CRDN1000 IF LESS
          ADD       PMCNAMNT,FORM12P2
          GOTO      CRDN10000
.
CRDN9000  COMPARE   ZERO,FORM12P2
          GOTO      CRDN9999 IF EQUAL       * No credit note
          SUB       PTINROUN,FORM12P2
CRDN9999  RETURN
+
.*****************************************************************************
.*  GETALTID
.*  Procedure to get an alternate ID
.*  Exit=0  No alternate ID
.*       1  Alternate ID's exist
.*****************************************************************************
          DEFPROC   GETALIDS
.
          INC       PMSAIDFD/INC
.
          MOVE      ZERO,EXIT
          PACK      KEY20,SP70
          OPEN      PMSAIDA1,"pmsaidaf"
.
          PACK      KEY31,PURNO,SP70
          CALL      RSPMAID1           * Read alternate id Table
GETALI10  CALL      RKPMAID1
          BRANCH    OVRCD,GETALI99
.
          MATCH     PURNO,PMAIURNO     * Check same UR
          GOTO      GETALI99 IF NOT EQUAL
.
          MATCH     "1",PMAIDISU
          GOTO      GETALI10 IF NOT EQUAL
.
          PACK      KEY20,PMAIALID,SP70
          MOVE      ONE,EXIT
          GOTO      GETALI99
.
          INC       PMSAIDIO/INC
          INC       IBAOVRIO/INC
.
GETALI99  CLOSE     PMSAIDA1
.
          ENDPROC
.
          INC       STD001IO
          INC       PATCODKY
          INC       PATFNDKY
          INC       PATHSPKY
          INCLUDE   PATSELFN
          INC       TFILENAM                     * Generate Temp File Name
. 
          INC       IBASEQIO/INC                 * Sequential Numbers File
          INC       WEBERRIO/INC                 * Web Server Error Logging
          INC       AAEDE1IO/INC
          INC       AAEDTRIO/INC
          INC       AAEDI1IO/INC
          INC       IBAPASIO/INC
          INC       IBASECIO/INC
          INC       OUTBB1IO/INC
          INC       OUTDTRIO/INC
          INC       OUTSITIO/INC
          INC       VISMDTIO/INC
          INC       VISMTXIO/INC
          INC       VISCMTIO/INC
          INC       PATCODIO/INC
          INC       PATDSCIO/INC
          INC       PATDTRIO/INC
          INC       PATFACIO/INC
          INC       PATFN1IO/INC
          INC       PATHSPIO/INC
          INC       PATINVIO/INC     
          INC       PATMA1IO/INC
          INC       PATMI1IO/INC
          INC       PATREMIO/INC
          INC       PATVISIO/INC
          INC       PMSVX1IO/INC
          INC       PMSCNOIO/INC
.
.
ENDIT     CHAIN      PGM
          STOP
