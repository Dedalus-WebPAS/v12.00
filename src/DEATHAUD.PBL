.*****************************************************************************
.*        DEATHAUD.PBL                                                       *
.* Routine to write Death or HCP details to Audit file (pmsdauaf)            *
.*                                                                           *
.* Mods:                                                                     *
.*****************************************************************************
.*  V11.02.02 31/03/0222  Thanh T        TSK 0903453                         *
.*            Changed WDAU8000 to update the identifying gender and          *
.*  V11.02.01 02/02/0222  Thanh T        TSK 0877055                         *
.*            Changed to update PMDECUID with web userid for type 009, 010   *
.*            and 011                                                        *
.*  V11.01.03 17/12/2021  Thanh T        TSK 0877055                         *
.*            Changed to write out pmsaudaf for type 009, 010 and 011        *
.*  V11.01.02 2/09/2021 Thanh T        TSK 0889595                           *
.*            Changed WDAU8000 to write out "BLANK" for PMDEFL05 when        *
.*            SAVESN16 is blank                                              *
.*  V11.01.01 07/09/2021 Thanh T        TSK 0889595                          *
.*            Changed WDAU5000 for Alias status field PMDEFL08               * 
.*  V11.00.02 23/06/2020 Peter Vela     Task 0878550                         *
.*            Added vlidation for "Blank" previous value for SAVESN16        *
.*  V11.00.01 10/06/2020 Peter Vela     Task 0878550                         *
.*            Added PMPXSN16 My HR Consent                                   *
.*  V10.14.01 17/06/2019 Peter Vela     Task 0871798                         *
.*            Added PTCNEMPL Employment Status validation                    *
.*  V10.13.01 13/08/2018 Peter Vela     Task 0845218                         *
.*            Fixed PMI Audit to include new contacts                        *
.*            Fixed folder selection audit                                   *
.*            Fixed Interpreter required display                             *
.*  V10.12.01 17/07/2018 Peter Vela     TSK 0845218                          *
.*            Added PMI Audit functionality                                  *
.*  V10.06.01 14/04/2015 Peter Vela     CAR 312723                           *
.*            Added audit functionality for PMSPX2FD.PMPXUSR9                *
.*            Advance Care Plan Alert                                        *
.*  V10.05.01 10/02/2015 Patrick Adair  CAR 208170                           *
.*            Amended routine to write Death or HCP details to audit file    *
.*            Included new HCP save variables as SVMAS variables are too     *
.*            small for new fields                                           *
.*  V10.04.01 25/03/2014 J.Tan          CAR 279251                           *
.*            Created routine to write to Death audit file                   *
.*                                                                           *
.*****************************************************************************
.
WDAU0000  OPEN      PMSDAUA1,"pmsdauaf"
          CALL      CLPMSDAU
          MOVE      URNUMBER,PMDEURNO
          MOVE      D3,PMDERTYP
.
WDAU1000  CALL      IBACLOCK
          PACK      PMDECDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMDECDAT
          PACK      PMDECTIM,CTIMEIS
.
          PACK      KEY27,URNUMBER,PMDECDAT,PMDECTIM,PMDERTYP,SP70
          CALL      RDPMDAU1
          COMPARE   ZERO,OVRCD
          GOTO      WDAU1000 IF EQUAL
.
          MATCH     "001",PMDERTYP                    * Death Details
          GOTO      WDAU2000 IF EQUAL  
.
          MATCH     "002",PMDERTYP                    * HCP Details
          GOTO      WDAU3000 IF EQUAL  
.
          MATCH     "003",PMDERTYP                    * Advance Care Plan Flag
          GOTO      WDAU4000 IF EQUAL
.
          MATCH     "005",PMDERTYP                    * PMI Name Detail
          GOTO      WDAU5000 IF EQUAL
.
          MATCH     "006",PMDERTYP                    * PMI Name Detail
          GOTO      WDAU6000 IF EQUAL
.
          MATCH     "007",PMDERTYP                    * PMI Name Detail
          GOTO      WDAU7000 IF EQUAL
.
          MATCH     "008",PMDERTYP                    * PMI Name Detail
          GOTO      WDAU8000 IF EQUAL
.
          MATCH     "009",PMDERTYP                    * Ethicity
          GOTO      WDAU8100 IF EQUAL
.
          MATCH     "010",PMDERTYP                    * Residency
          GOTO      WDAU8200 IF EQUAL
.
          MATCH     "011",PMDERTYP                    * Patient Postal Address
          GOTO      WDAU8300 IF EQUAL
.
          GOTO      WDAU9800
.
WDAU2000  PACK      PMDEFL01,PDECDTE,SP70,SP70        * Date of death
          PACK      PMDEFL02,PTMAUKDD,SP70,SP70       * Unknown date of death
          PACK      PMDEFL03,PMPXDETY,SP70,SP70       * Death type
          PACK      PMDEFL04,PTMADCNO,SP70,SP70       * Death Certificate no
          GOTO      WDAU9000  
.
WDAU3000  PACK      PMDEFL01,SAVEPHCP,SP70,SP70       * HCP
          PACK      PMDEFL02,SAVEPRAC,SP70,SP70       * HCP Practice
          PACK      PMDEFL03,SAVEPCTR,SP70,SP70       * HCP Practice Count
          GOTO      WDAU9000
.
WDAU4000  PACK      PMDEFL01,PMPXUSR9,SP70,SP70       * Advance Care Plan Flag
          GOTO      WDAU9000
.
WDAU5000  PACK      PMDEFL01,SAVESNAM,SP70,SP70       * Surname
          PACK      PMDEFL02,SAVEXFNM,SP70,SP70       * Given 1
          PACK      PMDEFL03,SAVEXSNM,SP70,SP70       * Given 2
          PACK      PMDEFL04,SAVETITL,SP70,SP70       * Title
          PACK      PMDEFL05,SAVEPSEX,SP70,SP70       * Gender
          PACK      PMDEFL06,SAVEPDOB,SP70,SP70       * DOB
          PACK      PMDEFL07,SAVEPFGN,SP70,SP70       * Preferred Given Names 
.
          PACK      ALIASSTS,ALIASSTS,SP70,SP70       * Alias Status
          MATCH     "A",ALIASSTS                      
          IF        @EQUAL
            MOVE      "Added",DIM10
            PACK      PMDEFL08,DIM10,SP70,SP70
          ENDIF
          MATCH     "D",ALIASSTS                      
          IF        @EQUAL
            MOVE      "Deleted",DIM10
            PACK      PMDEFL08,DIM10,SP70,SP70
          ENDIF
          MATCH     "S",ALIASSTS                      
          IF        @EQUAL
            MOVE      "Saved",DIM10
            PACK      PMDEFL08,DIM10,SP70,SP70
          ENDIF
          MATCH     "N",ALIASSTS                      
          IF        @EQUAL
            MOVE      "Not Saved",DIM10
            PACK      PMDEFL08,DIM10,SP70,SP70
          ENDIF
.
          GOTO      WDAU9000
.
WDAU6000  PACK      PMDECUID,PTMADCUU,SP70,SP70       * User Name 
          PACK      PMDECDAT,PTMADCUD,SP70,SP70       * Date Created
          PACK      PMDECTIM,PTMADCUT,SP70,SP70       * Time Created
          GOTO      WDAU9500
.
WDAU7000  MATCH     SP70,SAVEPMST
          IF        !@EQUAL
            PACK      KEY5,ANSM,SP1,SAVEPMST,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              PACK      PMDEFL01,SAVEPMST,SP1,TDESC,SP70,SP70
            ELSE
              PACK      PMDEFL01,SAVEPMST,SP70,SP70
            ENDIF
          ENDIF
.
          MATCH     SP70,SAVEPREG
          IF        !@EQUAL
            PACK      KEY5,ANSR,SP1,SAVEPREG,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              PACK      PMDEFL02,SAVEPREG,SP1,TDESC,SP70,SP70
            ELSE
              PACK      PMDEFL02,SAVEPREG,SP70,SP70
            ENDIF
          ENDIF
.
          MATCH     SP70,SAVEPCNT
          IF        !@EQUAL
            PACK      KEY5,ANSC,SP1,SAVEPCNT,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              PACK      PMDEFL03,SAVEPCNT,SP1,TDESC,SP70,SP70
            ELSE
              PACK      PMDEFL03,SAVEPCNT,SP70,SP70
            ENDIF
          ENDIF
.
          MATCH     SP70,SAVEPTYP
          IF        !@EQUAL
            PACK      KEY5,ANST,SP1,SAVEPTYP,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              PACK      PMDEFL04,SAVEPTYP,SP1,TDESC,SP70,SP70
            ELSE
              PACK      PMDEFL04,SAVEPTYP,SP70,SP70
            ENDIF
          ENDIF
.
          MATCH     SP70,SAVEABRG           * Indigenous Status
          IF        !@EQUAL
            PACK      KEY5,ANSV,ANSA,SAVEABRG,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              PACK      PMDEFL05,SAVEABRG,SP1,TDESC,SP70,SP70
            ELSE
              PACK      PMDEFL05,SAVEABRG,SP70,SP70
            ENDIF
          ENDIF
.
.
          PACK      PMDEFL06,SP70,SP70
.
          MATCH     SP70,SAVEUSR7           * Employment Status
          IF        !@EQUAL
.
            MATCH     "P1",PTCNEMPL
            IF        @EQUAL
              PACK      KEY5,ANSP,ONE,SAVEUSR7,SP70
              CALL      RDCODE1
              IF        OVRCD=0
                PACK      PMDEFL06,SAVEUSR7,SP1,TDESC,SP70,SP70
              ELSE
                PACK      PMDEFL06,SAVEUSR7,SP70,SP70
              ENDIF
            ENDIF
.
            MATCH     "P2",PTCNEMPL
            IF        @EQUAL
              PACK      KEY5,ANSP,TWO,SAVEUSR7,SP70
              CALL      RDCODE1
              IF        OVRCD=0
                PACK      PMDEFL06,SAVEUSR7,SP1,TDESC,SP70,SP70
              ELSE
                PACK      PMDEFL06,SAVEUSR7,SP70,SP70
              ENDIF
            ENDIF
.
            MATCH     "P3",PTCNEMPL
            IF        @EQUAL
              PACK      KEY5,ANSP,THREE,SAVEUSR7,SP70
              CALL      RDCODE1
              IF        OVRCD=0
                PACK      PMDEFL06,SAVEUSR7,SP1,TDESC,SP70,SP70
              ELSE
                PACK      PMDEFL06,SAVEUSR7,SP70,SP70
              ENDIF
            ENDIF
.
            MATCH     "P4",PTCNEMPL
            IF        @EQUAL
              PACK      KEY5,ANSP,FOUR,SAVEUSR7,SP70
              CALL      RDCODE1
              IF        OVRCD=0
                PACK      PMDEFL06,SAVEUSR7,SP1,TDESC,SP70,SP70
              ELSE
                PACK      PMDEFL06,SAVEUSR7,SP70,SP70
              ENDIF
            ENDIF
.
            MATCH     "P5",PTCNEMPL
            IF        @EQUAL
              PACK      KEY5,ANSP,FIVE,SAVEUSR7,SP70
              CALL      RDCODE1
              IF        OVRCD=0
                PACK      PMDEFL06,SAVEUSR7,SP1,TDESC,SP70,SP70
              ELSE
                PACK      PMDEFL06,SAVEUSR7,SP70,SP70
              ENDIF
            ENDIF
.
            MATCH     "P6",PTCNEMPL
            IF        @EQUAL
              PACK      KEY5,ANSP,SIX,SAVEUSR7,SP70
              CALL      RDCODE1
              IF        OVRCD=0
                PACK      PMDEFL06,SAVEUSR7,SP1,TDESC,SP70,SP70
              ELSE
                PACK      PMDEFL06,SAVEUSR7,SP70,SP70
              ENDIF
            ENDIF
.
          ENDIF
.
.
          PACK      PMDEFL07,SAVEMEDI,SP70,SP70
          PACK      PMDEFL08,SAVEMCCD,SP70,SP70     * Medicare Number
          PACK      PMDEFL09,SAVEMEDC,SP70,SP70
.
          MATCH     "1",PTCNNEWC
          IF        @EQUAL
            MATCH     SP70,SAVEUPRF
            IF        !@EQUAL
              PACK      KEY5,CATTC,SAVEUPRF,SP70
              CALL      RDCODE1
              IF        OVRCD=0
                PACK      PMDEFL10,SAVEUPRF,SP1,TDESC,SP70,SP70
              ELSE
                PACK      PMDEFL10,SAVEUPRF,SP70,SP70
              ENDIF
            ELSE
              PACK      PMDEFL10,SAVEUPRF,SP70,SP70
            ENDIF
          ELSE
            PACK      PMDEFL10,SAVECONP,SP70,SP70
          ENDIF
.
          GOTO      WDAU9000
.
WDAU8000  MATCH     "0",SAVEINTR
          IF        @EQUAL
            MOVE      "No",DIM20
            PACK      DIM20,DIM20,SP70
            PACK      PMDEFL01,DIM20,SP70,SP70
          ELSE
            MATCH     "1",SAVEINTR
            IF        @EQUAL
              MOVE      "Yes",DIM20
              PACK      DIM20,DIM20,SP70
              PACK      PMDEFL01,DIM20,SP70,SP70
            ELSE
              MATCH     "U",SAVEINTR
              IF        @EQUAL
                MOVE      "Unknown",DIM20
                PACK      DIM20,DIM20,SP70
                PACK      PMDEFL01,DIM20,SP70,SP70
              ELSE
                PACK      DIM20,SP70
                PACK      PMDEFL01,DIM20,SP70,SP70
              ENDIF
            ENDIF
          ENDIF
.          
          MATCH     SP70,SAVELNG1
          IF        !@EQUAL
            PACK      KEY5,ANSL,ANSA,SAVELNG1,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              PACK      PMDEFL02,SAVELNG1,SP1,TDESC,SP70,SP70
            ELSE
              PACK      PMDEFL02,SAVELNG1,SP70,SP70
            ENDIF
          ENDIF
.
          MATCH     SP70,SAVEPRVI
          IF        !@EQUAL
            PACK      KEY5,ANSP,ANSV,SAVEPRVI,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              PACK      PMDEFL03,SAVEPRVI,SP1,TDESC,SP70,SP70
            ELSE
              PACK      PMDEFL03,SAVEPRVI,SP70,SP70
            ENDIF
          ENDIF
.
          MATCH     SP70,SAVEFLDR
          IF        !@EQUAL
            PACK      KEY5,ANSF,ANSS,SAVEFLDR,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              PACK      PMDEFL04,SAVEFLDR,SP1,TDESC,SP70,SP70
            ELSE
              PACK      PMDEFL04,SAVEFLDR,SP70,SP70
            ENDIF
          ENDIF
.
          MATCH     SP70,SAVESN16           * MyHR Consent
          IF        !@EQUAL & !@EOS
            MATCH     "0",SAVESN16
            IF        @EQUAL
              MOVE      "No ",KEY3
              PACK      PMDEFL05,KEY3,SP70,SP70
            ELSE
              MATCH     "9",SAVESN16
              IF        @EQUAL
                MOVE      "Blank",KEY5
                PACK      PMDEFL05,KEY5,SP70,SP70 
              ELSE
                MOVE      "Yes",KEY3
                PACK      PMDEFL05,KEY3,SP70,SP70
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     SP70,SAVEUSR1                 * PMI User Defined 1 
          IF        !@EQUAL & !@EOS
            PACK      KEY5,ANSP,ONE,SAVEUSR1,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              PACK      PMDEFL06,SAVEUSR1,SP1,TDESC,SP70,SP70
            ELSE
              PACK      PMDEFL06,SAVEUSR1,SP70,SP70
            ENDIF
          ENDIF
.
          MATCH     SP70,SPPXUCC4
          IF        !@EQUAL
            MOVE      "Gi",DIM2
            PACK      KEY5,DIM2,SPPXUCC4,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              PACK      PMDEFL07,SPPXUCC4,SP1,TDESC,SP70,SP70
            ELSE
              PACK      PMDEFL07,SPPXUCC4,SP70,SP70
            ENDIF
          ENDIF
.
          MOVE      SPPXATF1,PMDEFL08 
.
          MATCH     SP70,SPPXUCC5
          IF        !@EQUAL
            MOVE      "Gp",DIM2
            PACK      KEY5,DIM2,SPPXUCC5,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              PACK      PMDEFL09,SPPXUCC5,SP1,TDESC,SP70,SP70
            ELSE
              PACK      PMDEFL09,SPPXUCC5,SP70,SP70
            ENDIF
          ENDIF
.
          MOVE      SPPXATF2,PMDEFL10
.
          GOTO      WDAU9000
.
WDAU8100  MATCH     SP70,PNHETHN1
          IF        !@EQUAL
            PACK      KEY5,PNHETHN1,SP70
            CALL      RDNHETH1  
            IF        OVRCD=0
              PACK      PMDEFL01,PNHETHN1,SP1,NHETDES,SP70,SP70
            ELSE
              PACK      PMDEFL01,PNHETHN1,SP70,SP70
            ENDIF
          ENDIF
.
          MATCH     SP70,PNHETHN2
          IF        !@EQUAL
            PACK      KEY5,PNHETHN2,SP70
            CALL      RDNHETH1
            IF        OVRCD=0
              PACK      PMDEFL02,PNHETHN2,SP1,NHETDES,SP70,SP70
            ELSE
              PACK      PMDEFL02,PNHETHN2,SP70,SP70
            ENDIF
          ENDIF
.
          MATCH     SP70,PNHETHN3
          IF        !@EQUAL
            PACK      KEY5,PNHETHN3,SP70
            CALL      RDNHETH1
            IF        OVRCD=0
              PACK      PMDEFL03,PNHETHN3,SP1,NHETDES,SP70,SP70
            ELSE
              PACK      PMDEFL03,PNHETHN3,SP70,SP70
            ENDIF
          ENDIF
.
          PACK      PMDECUID,WBSEUID,SP70
          GOTO      WDAU9500
.
WDAU8200  MATCH     SP70,PPTYPE
          IF        !@EQUAL
            PACK      KEY5,ANST,SP1,PPTYPE,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              PACK      PMDEFL01,PPTYPE,SP1,TDESC,SP70,SP70
            ELSE
              PACK      PMDEFL01,PPTYPE,SP70,SP70
            ENDIF
          ENDIF
.
          MATCH     SP70,PPRSCONT
          IF        !@EQUAL
            PACK      KEY5,ANSC,SP1,PPRSCONT,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              PACK      PMDEFL02,PPRSCONT,SP1,TDESC,SP70,SP70
            ELSE
              PACK      PMDEFL02,PPRSCONT,SP70,SP70
            ENDIF
          ENDIF
.
          MATCH     SP70,PPRSTEXP
          IF        !@EQUAL
            PACK      PMDEFL03,PPRSTEXP,SP70
          ENDIF
.
          MATCH     SP70,PPRSVISN
          IF        !@EQUAL
            PACK      PMDEFL04,PPRSVISN,SP70
          ENDIF
.
          MATCH     SP70,PPRSSTDN
          IF        !@EQUAL
            PACK      PMDEFL05,PPRSSTDN,SP70
          ENDIF
.
          PACK      BLNKCOMM,SP70,SP70
          MATCH     BLNKCOMM,PPRSCOMM
          IF        !@EQUAL
            UNPACK    PPRSCOMM,PPRSCOM1,PPRSCOM2
            PACK      PMDEFL06,PPRSCOM1,SP70,SP70
            PACK      PMDEFL07,PPRSCOM2,SP70,SP70
          ENDIF
.
          PACK      PMDECUID,WBSEUID,SP70
          GOTO      WDAU9500
.
WDAU8300  MATCH     SP70,PPMXADD1
          IF        !@EQUAL
            PACK      PMDEFL01,PPMXADD1,SP70
          ENDIF
.
          MATCH     SP70,PPMXADD2
          IF        !@EQUAL
            PACK      PMDEFL02,PPMXADD2,SP70
          ENDIF
.
          MATCH     SP70,PPMXADD3
          IF        !@EQUAL
            PACK      PMDEFL03,PPMXADD3,SP70
          ENDIF
.
          MATCH     SP70,PPMXADD4
          IF        !@EQUAL
            PACK      PMDEFL04,PPMXADD4,SP70
          ENDIF
.
          MATCH     SP70,PPMXPOST
          IF        !@EQUAL
            PACK      PMDEFL05,PPMXPOST,SP70
          ENDIF
.
          PACK      PMDECUID,WBSEUID,SP70
          GOTO      WDAU9500
.
.
WDAU9000  PACK      USERNAME,USERNAME,SP70            * Write Audit Record
          MATCH     SP70,USERNAME
          IF        @EQUAL
            PACK      PMDECUID,WBSEUID,SP70
          ELSE
            PACK      PMDECUID,USERNAME,SP70
          ENDIF
.
WDAU9500  CALL      WRPMDAU1
.
WDAU9800  CLOSE     PMSDAUA1
.
WDAU9999  RETURN
