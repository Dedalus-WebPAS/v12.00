.-----------------------------------------------------------------------------
. Program       : PATWEB92
.
. Author        : Jim Stathopoulos
.
. Function      : Hospital List Server  
.
. Modifications :
.
.------------------------------------------------------------------------
. V12.00.03 20/10/2025  Bella Turco    TSK 0955574
.           Added changes to Nursing Pre-assessment ASSCON00 UPPREA00
.           New report no 21 for Pre-assessment History
. V12.00.02 09/10/2025  Ebon Clements  TSK 0968096
.           Added custom print-key attribute for bulk A4 labels sheet
.           printing - BPEA0000
. V12.00.01 26/05/2025  Bella Turco    TSK 0955096
.           Alphanumeric changes                                  
. V11.05.03 07.01.2025 DA Sarkies      TSK 0954547
.            Commented out <cat> tags to prevent browser incompatibility
. V11.05.02 26/11/2024  Ebon Clements  TSK 0954547
.           Added <cat-c> start and end tag to category=XX tag
. V11.05.01 18/11/2024  Alina Bhari    Task 0953293
.           Fixed the array bound issue with bulk eligibility request
.           - TOEC5000,TOEW5000
. V11.04.07 26/07/2024  Peter Vela     Task 0949702
.           Recompiled for FHRDATCD
. V11.04.06 09/05/2024  Ebon Clements  TSK 0946472
.           Clear booking diagnosis BKDIDES1, BKDIDES2 and BKDIDES3
.           before allocating values for pre admission display - TOPB5600
. V11.04.05 10/01/2024 Thanh T         TSK 0936263
.           Recompiled for DGCLIUWL changes
. V11.04.04 13/12/2023  Peter Vela     TSK 0938130
.           Fixed validation for blank ADIAG2 at BKTABC10, if PTCNUDF1 = 1
.           Fixed porting of functionality between 11.03 and 11.04
. V11.04.03 30/11/2023  Ebon Clements  TSK 0925492
.           Recompile for BEDBDPRO - Multiple theatre bookings per admission
. V11.04.02 24.11.2023  DA Sarkies     TSK 0939511
.           Added code to move expected ward/bed to ward/bed if ward/bed 
.           Empty
. V11.04.01 22.11.2023  DA Sarkies     TSK 0938130
.           Reconfigured code so that correct diagnosis detail feilds are
.           displayed
. V11.03.27 24.11.2023  DA Sarkies     TSK 0939511
.           Added code to move expected ward/bed to ward/bed if ward/bed 
.           Empty
. V11.03.26 22.11.2023  DA Sarkies     TSK 0938130
.           Reconfigured code so that correct diagnosis detail feilds are
.           displayed
. V11.03.25 14/11/2023  Jacob Jackson  TSK 0914658
.           Insert new Vh description value into row for CAROWA50 
. V11.03.24 31/10/2023  Thanh T        TSK 0935081
.           Added PBOK5500, PBOK5600 and PBOK5700 to save type of printer 1,
.           2 and 3
. V11.03.23 31/10/2023  Thanh T        TSK 0935081
.           Added PBOK5200, PBOK5300 and PBOK5400 to save type of label,
.           stationery code 1 and stationery code 2
. V11.03.22 27/10/2023  Thanh T        TSK 0935081
.           Added PBOK5200, PBOK5300 and PBOK5400 to save type of label, 
.           stationery code 1 and stationery code 2  
. V11.03.21 12.10.2023  DA Sarkies     TSK 0935072
.           Added Check for Pre-Admissions and use expected Ward/Bed instead
. V11.03.20 09.10.2023  DA Sarkies     TSK 0935072
.           Added if switch to look for preadmissions based on ward.
. V11.03.19 03/10/2023  Thanh T        TSK 0935071
.           Changed CABCFR11 to filter out status for FHIR
. V11.03.18 29/08/2023  Thanh T        TSK 0935071
.           Added CABCFR00 to check FRSTDATE/LASTDATE filter against
.           admission date for FHIR Encounter
. V11.03.17 17/08/2023  Peter Vela     TSK 0933025
.           Moved position of UPPMI000 in UPDINT00
. V11.03.16 11/08/2023  Peter Vela     TSK 0927262
.           Added FHRCON00 - Patient Resource contacts object for FHIR api
. V11.03.15 01/08/2023  Peter Vela     TSK 0927262
.           Recompiled for FHRDATCD
.           Added dxc-hc-hcp and dxc-hc-speciality extensions
. V11.03.14 21/07/2023 Jacob Jackson   TSK 0927731
.           Fix issue where certain queries would not return multiple
.           location objects
. V11.03.13 13/07/2023 Jacob Jackson   TSK 0929712
.           Modify DISFLD00, BKTABC00 and TOEC0000/TOEW0000 to add DISPCLSS/
.           DISPALTD to the tables
. V11.03.12 19/06/2023 Sunny           TSK 0927431
.           Added change in CABCOD00 for PTSTATUS onleave for fhir response
. V11.03.11 22/06/2023 Jacob Jackson   TSK 0927731
.           Add changes so that FHIR Response contains a location object
.           for Ward and an object for Bed
. V11.03.10 16/06/2023  Nikitha B      TSK 0933113
.           Save and restore value of F1 when calling PATLN000 in DISFLD00
.           to stop corruption of F1 in EXPA0000
. V11.03.09 01/06/2023 Sunny           TSK 0927431
.           Added filter for FHIR patient Encounter search based on status
. V11.03.08 23/05/2023  Peter Vela     TSK 0927399
.           Recompiled for FHRDATCD - Changed gender validation to
.           Indicator 7
. V11.03.07 04/05/2023  Peter Vela     TSK 0927262
.           ClinicalAide FHIR API
.           Added Participant include FHRPARIN functionality
.           Added Location include  FHRLOCIN functionality
. V11.03.06 27/04/2023  Jacob Jackson     TSK 0931595
.           Modify table output data within BKTABC00 (tabcol 95) to allow
.           it to sortable by date
. V11.03.05 28/02/2023  Peter Vela TSK 0909393
.           Changed KEY for oprsesaf reads
. V11.03.04 04/01/2023  Peter Vela        TSK 0922752
.           Added validation for REJECT and HEALTH_FUND_UNAVAILABLE
.           against webeehaf.wbehpscd in TOEW0000,BOEW0000,BOPW0000,BOBW0000
.           COEW0000,COPW0000,COBW0000 (Bulk OECW screens
.           patweb9219001.html, patweb9219003.html, patweb9219004.html)
.           Added REJECTED and HEALTH_FUND_UNAVAILABLE displays in the same
.           functions for the same bulk oecw templates. 
. V11.03.03 05/12/2022  Ebon Clements     TSK 0900727
.           Removed WINCLS00 call after DELBOK00 if nextpage is 1
.           as it then called NXTPAG00. This caused bouble writes and close
.           of HTMLFILE
. V11.03.02 22.11.2022  DA Sarkies           0920756
.           Shorted keep alive time and moved one before a goto
. V11.03.01 21/11/2022  Peter Vela           0884414
.           Added validation for clearing PATMIS and WEBELF variables in
.           BOBW0000 and COBW0000
. V11.02.06 28/07/2022  Peter Vela           0884414
.           Added initialize spaces for HTMLLNK4 
. V11.02.05 26/07/2022  Jill Parkinson                
.           Corrected use of WBSENAM
. V11.02.04 04/07/2022  Peter Vela           0884414
.           Added BOPW0000 (Bulk OECW Pre Admitted Only/Theatre Date)
.           Added BOBW0000 (Bulk OECW Theatre Booking Only/Theatre Date)
.           Added COPW0000 (Bulk OECW Pre Admitted Only/Booking Date)
.           Added COBW0000 (Bulk OECW Theatre Booking Only/Booking Date)
. V11.02.03 01.04.2022  DA Sarkies       TSK 0918429
.           Changed move to pack for z70
. V11.02.02 30/03/2022  Alina Bhari      TSK 0912792
.           Display External Visit ID if the
.           "Show the External Visit ID in Patient Search,Banner and
.           Selected Visit Lists" parameter is set to yes.
.           - TOPR2000, CHKEID00, BKTABC90
. V11.02.01 10/02/2022  Thanh T          TSK 0905641
.           Recompiled as OUTHEDFD/OUTMA1FD changes
. V11.01.29 13/09/2021  Ebon Clements  TSK 0910279
.           Recompiled for BEDBDVCD (BEDBDPRO) - Post Op Ward 
. V11.01.28 03/09/2021  Jill Parkinson Task 0910957
.           Added leavereg to PREV0000 and NEXT0000
. V11.01.27 30/08/2021  Davin          TSK 0909365
.           Save and restore value of F1 when calling SEXDSC00 in GETPAT00
.           to stop corruption of F1 in EXPA0000
. V11.01.26 27/08/2021  Jill Parkinson Task 0910463
.           Removed default of lastdate to yesterday for leave history 136
. V11.01.25 27/08/2021  Ebon Clements  TSK 0910383
.           Recompiled for BEDBDVCD (BEDBDPRO) - Post Op / Expected Ward
. V11.01.24 13/08/2021  Thanh T        TSK 0909984
.           Changed BPEA0000 to show procedure description when hdp state
.           is NZ (1)
. V11.01.23 03/08/2021  Jill Parkinson Task 0909796
.           Added clear of carer name and phone if returned
. V11.01.22 22/07/2021  Ebon Clements  TSK 0909330
.           Recompiled for BEDBDPRO - Post op ward 
. V11.01.21 21/07/2021  Jill Parkinson Task 0900650
.           Fixed enddte check for leave register history
. V11.01.20 20/07/2021  Jill Parkinson Task 0900650
.           Fixed output of on leave time
. V11.01.19 20/07/2021  Jill Parkinson Task 0900650
.           Added output of return date/time on leave register history list
. V11.01.18 19/07/2021  Jill Parkinson Task 0900650
.           Added output of Record Type for leave register history list
. V11.01.17 16/07/2021  Jill Parkinson Task 0900650
.           Added output of LEAVEREG 
. V11.01.16 14/07/2021  Jill Parkinson Task 0900650
.           Fixed leave type display
. V11.01.15 14/07/2021  Jill Parkinson Task 0900650
.           Fixed overdue red for leave register
. V11.01.14 12/07/2021  Peter Vela     TSK 0908845
.           Added user id to IBAPMS84 keystrokes
. V11.01.13 09/07/2021  Thanh T        TSK 0905755
.           Recompiled for BEDBDPRO changes
.           12/07/2021  Jill Parkinson Task 0900650
.           Added red for on leave late ptcnoldr
. V11.01.12 05/07/2021  Jill Parkinson TSK 0900650
.           Added check for multi hospital in leave register view
. V11.01.11 01/07/2021  Jill Parkinson TSK 0900650
.           Added leave register history view
. V11.01.10 25/06/2021  Jill Parkinson TSK 0900650
.           Mods to clear leave destination if returned from leave
. V11.01.09 22/06/2021  Jill Parkinson TSK 0900650
.           Fixed leave minutes calculation              
. V11.01.08 18/06/2021  Jill Parkinson TSK 0900650
.           Corrected Status filter for leave register
. V11.01.07 13/06/2021  Jill Parkinson TSK 0900650
.           Added privacy functionlity for leave register
. V11.01.06 08/06/2021  Jill Parkinson TSK 0900650
.           Added calculations for leave time
. V11.01.05 02/06/2021  Jill Parkinson TSK 0900650
.           Added leave register clear
. V11.01.04 28/05/2021  Jill Parkinson TSK 0900650
.           Added leave register management list
. V11.01.03 20/04/2021  Jill Parkinson TSK 0892649
.           Recompile for IBACOMM/IBAWEBDF - Changed DSEXDESC/DISPSEX to DIM 20
. V11.01.02 25/02/2021  Ebon Clements  Task 0903090
.           Changed CIPED000 to a procedure (Reversed V11.00.01 changes)
. V11.01.01 23/02/2021  Ebon Clements  Task 0903090
.           Save ward and bed for booking records as they have no admission
.           file record  - CIPED900
. V11.00.18 18/12/2020  Jill Parkinson Task 0892987
.           Added class=Icon for search/eraser icon
. V11.00.17 10/12/2020  Sunny          TSK 0892649
.           Recompile for IBACOMM/IBAWEBDF - Changed DSEXDESC/DISPSEX to DIM 16
. V11.00.16 10/12/2020  Peter Vela     TSK 0884414
.           Added COEC0000 - Bulk Eligibility Requests for Theatre Bookings/
.           Pre Admissions (Sorted by Date Booking Created)
. V11.00.15 09/12/2020  Thanh T        TSK 0872840
.           Added PMSCCDFD/PMSCCDIO as PMSPX2TM changes
. V11.00.14 07/12/2020  Peter Vela     TSK 0884414
.           Added BOEC0000 - Bulk Eligibility Requests for Theatre Bookings/
.           Pre Admissions
. V11.00.13 23/11/2020  Peter Vela     TSK 0884414
.           Fixed PTCNOECE validation in BOEREQ15 
. V11.00.12 14/10/2020  Ebon Clements  TSK 0890602
.           Added SUPERLEV cgi for MOSAIQ supervisor menu options
. V11.00.11 06/10/2020  Peter Vela     TSK 0895969
.           Fixed Response Date and Time display in TOEW0000
. V11.00.10 30/09/2020  Thanh T        TSK 0893522
.           Recompiled for PMSSMHCD changes
. V11.00.09 09/09/2020  Peter Vela     Task 0895969
.           Added WebServices OECW 
. V11.00.08 08/09/2020  Tracey Nguyen  Task 0888315
.           Added 'onclick=return false;' for IP/ED icons to stop auto redirect
.           to patweb9801003.html and updated 'alt' values in CIPED000
. V11.00.07 01/09/2020  Peter Vela     Task 0884414
.           Added PMVXPILC/AMBS validation for Request Eligibility checkbox in
.           TOEC0000
. V11.00.06 27/08/2020  Tracey Nguyen  Task 0888315
.           Added ALRTIMG5 to display current IP/ED alert icon - CIPED000 
. V11.00.05 05/08/2020  Peter Vela     Task 0884414
.           Added Health Fund filter to TOEC0000
.           Added Claim Type filter to TOEC0000
.           Added Booking Type filter to TOEC0000
.           Added ADIAG1 to TOEC0000
.           Added Hospital Check checkbox to TOEC0000
.           Added OEC Response Details to TOEC0000
.           Removed PTELSPEA validation in VOEC0000
.           Added Presenting Illness and MBS columns to TOEC0000
. V11.00.04 22/06/2020  Jill Parkinson Task 0893510
.           Added replace of \ with spaces for email to stop js error
. V11.00.03 15/04/2020  Peter Vela     TSK 0890104
.           Recompiled for PATNAMCD - Preferred name formats
. V11.00.02 20/03/2020  Peter Vela     TSK 0889143
.           Fixed OUTLET IO calls
. V11.00.01 18/03/2020  Peter Vela     TSK 0889143
.           Recompiled for OUTLETFD
.           Recompiled for WATLETFD
. V10.15.02 20/12/2019  Ebon Clements     TSK 0886447
.           Fixed bulk print expected admission loop. Added last date end loop
.           test -  BPEA0000
. V10.15.01 14/10/2019  Peter Vela        TSK 0878964
.           Added CLPMSVX1 to BKTABC00
. V10.14.13 26/08/2019  Thanh T           TSK 0879452
.           Added SNDTETIM for SMSS0000 changes to include checking for booking
.           date/time against date message was sent
. V10.14.12 07/08/2019  Ebon Clements     Task 0878131
.           Added exit branch after DELBOK00 call - MAIN2000
. V10.14.11 16/07/2019  Jill Parkinson    Task 0877204   
.           Fixed clear of bokrx1af in TOPB5000 for preadmissions           
. V10.14.10 10/07/2019  Jill Parkinson Task 0877204   
.           Added loop by bokrx1af in TOPB5000 for preadmissions           
. V10.14.09 08/07/2019  Ebon Clements     TSK 0876246
.           Created LDVTMP00 from CRVTMP00 and stopped loop of entire file
. V10.14.08 29/05/2019  Tracey Nguyen     TSK 0870496
.           Initialize BOOKCRDT in CLRPAR00 
. V10.14.07 23/05/2019  Peter Vela     TSK 0872559
.           Added CLPMATMIS, CLPMXVX1 to BKTABC10
. V10.14.06 21/05/2019  Ebon Clements   TSK 0874508
.           Changed to use common clear of WATOPAFD - CLWATOPA
. V10.14.05 17/05/2019  Tracey Nguyen     TSK 0870496
.           New Date Booking Created filter to the Expected Patients 
.           Pre-Assessment View (hea/patweb9206015.html)
.           1)Added FILBCRDT, BOOKCRDT, DFDTVIEW variables/CGI variables
.           2)Added PBOK4800, PBOK4900 and PBOK5000 tags
.           3)Added Table columns 95,96,97 in BKTABC00
.           4)Added FILBCRDT and DFDTVIEW in NEXT0000 and PREV0000
. V10.14.04 24/04/2019  Richa Phogat   TSK 0869550
.           Added PROFL202
. V10.14.03 08/04/2019  Tracey Nguyen     TSK 0871443
.           Recompiled for PATATRTD/PATARTM
. V10.14.02 12/03/2019  Richa Phogat   TSK 0869550
.           Added ACCAUDFD/IO, CLACCAUD, ACCAUD00, MVACCSTS, AUDITTYP, ACCTYREC,
.           AUDITYPE, ACCTYPRE, ACCT0800, ACCT0900, ACCT1000 to add a record in
.           ACC Audit file
.           20/03/2019  J.Tan            TSK 0857392
.           Changed RCP Transaction count from DIM3 to DIM5
. V10.14.01 01/03/2019  Peter Vela     TSK 0865640
.           Fixed VOEC0000 to check for PMVXPILC or AMBS
.------------------------------------------------------------------------
. V10.13.09 25.01.2019  B.G.Ackland    TSK 0835482
.           Recompile for change to FHIR Encounter Reason in FHRDATCD
. V10.13.08 06/12/2018  Jill Parkinson Tsk 0867095
.           Added NEWOVR00 to calculate wait list over due date
. V10.13.07 27/11/2018  Nicole Torrisi TSK 0864647
.           Modified VOEC0000 to set OECRFLAG=1 if no patelgaf record exists
. V10.13.06 12.11.2017  B.G.Ackland    TSK 0835482
.           FHIR Recompile for change to FHRDATCD
. V10.13.05 07/11/2018  Don Nguyen     TSK 0853817
.           Modified ACC Status update code (UPDACC00) to update all linked
.           visits with the same ACC Number.
. V10.13.04 06.11.2018  B.G.Ackland    TSK 0835482
.           FHIR Output Change for Boolean values to not have quotes
. V10.13.03 17/10/2018  Don Nguyen     TSK 0838558
.           Deleted temp file (VSCTTFIL) after processing.
.           Moved temp file creation (CLRVCM00) to comments processing section
.           rather than on server startup.
.           01.11.2018  B.G.Ackland    TSK 0835482
.           Added deceased section to patient FHR resource in FHRDATCD
. V10.13.02 21/09/2018  Don Nguyen     TSK 0853817
.           Modified ACCLST00 (report 20) to allow for ACC Status update.
.           Modified PACC0000 to output Claim Status string/value for
.           Parked ACC List (Sort Table).
.           Added more ACC tag output in ACCT0000.
. V10.13.01 11/09/2018  Richa Phogat     TSK 0862704
.           Changed Date & Time fields displayed under pre-assessemnt
. V10.12.08 17/07/2018  Richa Phogat     TSK 0850937
.           Updated condition for Pre-assessment under BKTABC00
. V10.12.07 16/07/2018  Richa Phogat     TSK 0850937
.           Updated condition for Pre-assessment under BKTABC00
. V10.12.06 26/06/2018  Ebon Clements    TSK 0845295
.           Added update of eReferral WL booking number - ERVS0000
. V10.12.05 30/05/2018  Richa Phogat     TSK 0850937
.           Added field 'PACAFLAG'
. V10.12.04 09/05/2018  J.Tan            TSK 0839842
.           Added Print IFC from Eligibility list
. V10.12.03 04/04/2018  Peter Vela     TSK 0853121
.           Added parameter function PTCNUDF1
. V10.12.02 22/03/2018  Richa Phogat   TSK 0854297
.           Updated PACC0000 to include O/P and W/L parked ACC records on
.           'Parked ACC List' screen
. V12.12.01 14/03/2018  Richa Phogat   TSK 0852546
.           Added Discharge Date & Time under NROW3000 to display on report
.------------------------------------------------------------------------
. V10.11.10 20/12/2017  Peter Vela     TSK 0850365
.           Initialise spaces into BKDIDES3 TOPB0000
. V10.11.09 27/11/2017  Thanh Tieu     Task 0821710
.           Recompiled as PATMASTM changed
. V10.11.08 10.10.2017  B.G.Ackland    TSK 0835482
.           FHIR Dummy include for Extra Details
. V10.11.07 03.10.2017  B.G.Ackland    TSK 0835482 
.           FHIR Dummy include for Contact Details (Not included in List Functions)
. V10.11.06 18.09.2017  B.G.Ackland    TSK 0835482 
.           FHIR Output Encounters by Category AC
. V10.11.05 18.09.2017  B.G.Ackland    TSK 0835482 
.           FHIR Output Change to Patient Reference ID to strip spaces
. V10.11.04 24/08/2017  Davin          TSK 0837617
.           Added new I13 message trigger for Update Waiting List (DGCLIUWL)
. V10.11.03  25/08/2017  Thanh T.       TSK 0821710
.            Audit Amission/outpatient visit comments
. V10.11.02  25/08/2017  Ania P         TSK 0842897
.            Added test for BKRESTAT 3 & 4 after TOPO2000
. V10.11.01  28/07/2017  Thanh T.       TSK 0821710
.            Audit Amission/outpatient visit comments
.------------------------------------------------------------------------
.  V10.10.04 06/07/2017  Thanh T.       TSK 0839330
.            Fixed MNDS extract functionality for Single hospital
.  V10.10.03 29/03/2017  Tracey Nguyen     TSK 0833454
.            Recompiled for PATATRTD/PATARTM
.  V10.10.02 23/03/2017  Don Nguyen     TSK 0808741
.            Modified CRVTMP00 to use KEY27
.  V10.10.01 06/03/2017  Don Nguyen     TSK 0808741
.            Added CAVENT00 as alternative for CMVENT00; indexed start date/time
.            Fixed CMVENT00 to output the correct start/end date/time
.-----------------------------------------------------------------------------
.  V10.09.02 17/01/2017  J.Tan          TSK 0808741
.            Added Current Adm with Ventilations hours list (CMVENT00)
.  V10.09.01 05/12/2016  Ebon Clements  TSK 0825435
.            Added report 20 - ACC Lists
.-----------------------------------------------------------------------------
.  V10.08.13 21/10/2016  Davin          TSK 0814504
.            Added BKREEDAT and DietIcon to NUTRLINK for bookings @ BKTABC00
.  V10.08.12 19/10/2016  Peter Vela     TSK 0827811
.            Recompiled for CLPMSOEC
.            19/10/2016  Ania P         CAR 809766
.            Added output of OPDACASE in BKTABC00
.  V10.08.11 10/10/2016  Don Nguyen     TSK 0320573
.            Added BKTYPCOL ('Booking Type' column flag). Modified BKTABC00.
.  V10.08.10 26/09/2016  Peter Vela     TSK 0822764
.            Added working diagnosis from patatraf for stv in GETCON00 
.  V10.08.09 09/08/2016  Davin          TSK 0321234
.            Recompiled for LSTALERT - added ALRTIMG4 for Chronic Alerts
.  V10.08.08 15/07/2016  Ebon Clements     TSK 0294154
.            Added sms response to confimed appointment list - BKTABC00
.  V10.08.07 07/07/2016  Jill Parkinson TSK 0821774
.            Added output of SP1 after diagnosis to stop javascript error if  
.            80th character is \
.  V10.08.06 31/05/2016  Nicole Torrisi TSK 0314161
.            Added DOB, Consultant and Regime to Oncology Bookings list - TOPO0000
.  V10.08.05 30/05/2016  Ebon Clements  TSK 0294154
.            Added SMS confirm appointment to booking list - TOPB0000
.  V10.08.04 23/05/2016  Ebon Clements  TSK 0316587
.            Fixed post op ward display/filer on booking list - TOPB5000
.  V10.08.03 13/05/2016  Peter Vela     TSK 0315884
.            Added Admissions by Diet (Check All Diets) functionality
.  V10.08.02 28/04/2016  Don Nguyen     TSK 0316489 
.            Recompiled for PATATRFD/IO
.  V10.08.01 18/04/2016  Ebon Clements  TSK 0316587 
.            Added filters for post op ward, intended stay and ignore OP wards
.            to the booking list - TOPB0000
.  V10.07.05 11/02/2016  Davin          CAR 0809370
.            Don't link to new diet screen for bookings if PTCNUTOM=1 (BKTABC00)
.  V10.07.04 10/02/2016  Davin          CAR 0809370
.            Added meal date to NUTRLINK if PTCNUTOM=1 (BKTABC00)
.  V10.07.03 10/12/2015  Peter Vela     CAR 317276
.            Added validation for ADIET in BKTABC00
.  V10.07.02 27/11/2015  Peter Vela     CAR 317276
.            Added validation for PMNUDIET in CABCOD00 for hea
.            27/11/2015  Davin          CAR 310749
.            Added diet (column 27) to preadmission sort list (topr0000)
.  V10.07.01 30/10/2015  Don Nguyen     CAR 320394
.            Recompiled for changes to WATTX1FD/IO
.-----------------------------------------------------------------------------
.  V10.06.17 25/09/2015  Don Nguyen     CAR 321237
.            Recompiled for WEBDATCD - Modified CURVYM00 and added "id=lastdate"
.  V10.06.16 06.08.2015  B.G.Ackland    CAR 320470 
.            Remove PATBMHAF table updates
.            Restrict Number of Records Written to PATBMDAF to 12 weeks
.  V10.06.15 23/07/2015  Peter Vela     CAR 319518
.            Added BKREWARD to number 68 in BKTABC00
.  V10.06.14 22/07/2015  Peter Vela     CAR 318234
.            Added loopcntr functionality to TOPB5000
.  V10.06.13 22/07/2015  Peter Vela     CAR 318234
.            Added loopcntr functionality to TOPB0000
.  V10.06.12 15/07/2015  Davin          CAR 305377
.            Add Colour Coded Care Type to Oncology Bookings (TOPO0000/col.12)
.            Show Colour Coded Care Type for bookings (use bkreeaty/bkrestat=0)
.  V10.06.11 10/07/2015  Peter Vela     CAR 319208
.            Added BKDIDES1,2,3 in one column in BKTABC0000
.  V10.06.10 07/07/2015  Don Nguyen     CAR 318486
.            Modified UPDINT00 to branch on EXIT after CHKLAN00
.  V10.06.09 02/07/2015  Jill Parkinson CAR 313321
.            Added viewlink
.  V10.06.08 10/06/2015  Steve Armstrong   CAR 313856
.            Mods to use CLVISIAU instead of internal clear routine
.  V10.06.07 15/06/2015  J.Tan          CAR 306901
.            Added Post Op Ward to Booking List (BKTABC00)
.  V10.06.06 03/06/2015  Patrick Adair  CAR 305377
.            Add Colour Coded Care Type in BKTABC00 and BPEA1500
.  V10.06.05 09/06/2015  Peter Vela     CAR 316349
.            Fixed Post Op Ward filter in TOPR1500
.  V10.06.04 30/05/2015  Jill Parkinson CAR 313321
.            Added list for aelig values of 4 or 5
.  V10.06.03 29/05/2015  Peter Vela     CAR 316349
.            Check for BKRXPOWD if PMVXPOWD is blank TOPR0000
.  V10.06.02 12/03/2015  Steve Armstrong  CAR 314108
.            Removed definition of PTCGDATE as PATCGPFD is no longer
.            in use.
.  V10.06.01 06/03/2015  Ebon Clements  CAR 312636
.            Display the booking post op ward if the pre adm post op ward
.            is blank - TOPB6000
.-----------------------------------------------------------------------------
.  V10.05.11 03/02/2015  Jill Parkinson CAR 311980
.            Fixed redirect for TOPO000 for pre-adm/adm and discharged patients
.  V10.05.10 03/02/2015  Jill Parkinson CAR 311980
.            Changed TOPO0000 to show all oncology bookings except cancelled 
.            (previously only showed 'booked' status)
.  V10.05.09 23/10/2014  Ebon Clements  CAR 307379
.            Fixed ward display when no bed allocated - FWBD5000
.  V10.05.08 13/10/2014  Ebon Clements  CAR 300196
.            Added BMI output to booking list
.  V10.05.07 06/10/2014  Ebon Clements  CAR 268970
.            Change to use OUTCLIFD index 1 instead of index 2
.  V10.05.06 23/09/2014  Ebon Clements  CAR 283332 
.            Fixed PAC check box display on pre assessment list - TASS0000
.  V10.05.05 12/09/2014  Don Nguyen     CAR 296697
.            Added Disability Alert icons (AlertIconDIS.gif) where applicable
.  V10.05.04 04/09/2014  Don Nguyen     CAR 296697
.            Modified BKTABC00 to display other Alert icons (Med, Micro & Risk)
.  V10.05.03 11/08/2014  Don Nguyen     CAR 297774
.            Recompiled for changes to PMSBRQFD/IO
.  V10.05.02 31/07/2014  Peter Vela     CAR 299131
.            Added drug orders to TOPR0000
.            Added Oncology Booking List TOPO0000
.  V10.05.01 31/07/2014  Ebon Clements  CAR 283332 
.            Added PAC fields to pre assessment list - TASS0000
.  V10.04.06 03/07/2014  Jill Parkinson CAR 303003 
.            Added output of aclss description in TODP0000
.  V10.04.05 04/06/2014  Peter Vela      CAR 301670
.            Added claimtyp to NEXT0000 and PREV0000
.  V10.04.04 07/04/2014  Peter Vela      CAR 286258
.            Recompiled for PATMASTM
.  V10.04.03 31.03.2014  B.G.Ackland  CAR 299363
.            Replace META Tag Redirect with Javascript in Common RDIREC00
.            Routine
.  V10.04.02 26/02/2014  J.Tan            CAR 297103
.            Added Claimtyp filter for Expected Admissions - TOPB0000
.  V10.04.01 31/12/2013  Don Nguyen       CAR 294389
.            Recompiled for changes to WATLETFD & WATLETIO
.-----------------------------------------------------------------------------
.  V10.03.35 11/12/2013  Ebon Clements    CAR 293092 
.            Added notified and confirmed to interpreter audit
.  V10.03.34 27/11/2013  Ebon Clements    CAR 294586
.            Fixed display of admitting point cat ap - TOPR0000 & DISFLD00
.  V10.03.33 20/11/2013  Patrick Adair    CAR 286048
.            Add Colour Coded Care Type in TOPR0000
.            Added Colour Coded Care Type Mapping SETL0000
.  V10.03.32 19/09/2013  Peter Vela       CAR 290822
.            Removed update to pmi interpreter in UPDINT00
.  V10.03.31 27/08/2013  Ebon Clements    CAR 275205
.            Recompiled for WATTX1FD - New fields WTTXPSAH and WTTXPHOS
.  V10.03.30 17/09/2013  Jill Parkinson CAR 291727  
.            Fixed read of bokrx1af in TOPB1000 before using bkrx values
.  V10.03.29 06/09/2013  Peter Vela       CAR 288891
.            Fixed bed telephone extn line display in FWBD0000
.  V10.03.28 06/08/2013  Ania P           CAR 285035
.            Added output AFUNDH/AFUNDTB to CAROWA50
.  V10.03.27 30/07/2013  Ebon Clements    CAR 283202
.            Recompiled for PMSPX2TM - Preferred method of contact
.  V10.03.26 30/06/2013  Davin             CAR 283202
.            Recompiled for changes to hl7 messaging
.  V10.03.25 12/07/2013  Peter Vela       CAR 286471
.            Added coloured folders to Bulk OEC Requests table
.  V10.03.24 10/07/2013  Ania P           CAR 287385
.            Fixed population of UR number in PROAUD20 before call to GETPAT00
.  V10.03.23 10/07/2013  Don Nguyen       CAR 288247
.            Fixed FWBD9000 to only append bed desc if there is a bed code.
.            Also cleared PTMIEBED in TOPB0000 so that Inpatient Event bookings 
.            displays correct Ward/Bed.
.  V10.03.22 18/06/2013  Peter Vela       CAR 286939
.            Fixed Telephone Extension diaply in CAROWA00 and FWBD0000
.  V10.03.21 06/06/2013  Peter Vela       CAR 286471
.            Added patient folders to TOEC0000
.  V10.03.20 27/05/2013  Don Nguyen       CAR 285352
.            Modified PROAUD00 so the correct patient U/R is used for GETPAT00
.  V10.03.19 24/05/2013  Don Nguyen       CAR 285352
.            Added PROAUD00 to process Interpreter Visit Audit record if there
.            is no corresponding Interpreter Visit Details.
.  V10.03.18 01/05/2013  Steve Armstrong  CAR 284376
.            Recompiled for changes to DGCLICUP.
.  V10.03.17 23/04/2013  J.Tan            CAR 261630
.            Removed port number from temp file name
.  V10.03.16 03/04/2013  Davin          CAR 270648
.            Recompiled for changes to HL7 messaging includes
.  V10.03.15 21/02/2013  Jill Parkinson CAR 276675
.            Changed TOPB0000(booking and pre-admission list) to check for 
.            matching hospital ID first instead of after numerous other file
.            reads
.  V10.03.14 31/01/2013  Ebon Clements  CAR 262292
.            Display language from audit if populated
.  V10.03.13 23/01/2013  Jeni Tan     CAR 278338
.            Added multi hospital validation to CANC0000            
.  V10.03.12 19/11/2012  Jill Parkinson CAR 276566
.            Added match of WBSEHOSP to PTWDHOSN in TOPS0000
.  V10.03.11 26/10/2012  Saroeun Soeur  CAR 272722
.            NOBOKMOD - change to update eveything except update details.
.  V10.03.10 17/10/2012  Saroeun Soeur  CAR 272722
.            add NOBOKMOD cgi to prevent update on booking file
.  V10.03.09 31/08/2012  Peter Vela     CAR 266428
.            Added Chart Only validation to OUTALH00 - Outpatient Int List
.  V10.03.08 10/08/2012  Ebon Clements  CAR 253592
.            Added multi hospital tests to interpreter lists
.  V10.03.07 30/05/2012  Ebon Clements  CAR 257542
.            Allow udpate of cancelled booking pre assessment - UPPREA00
.  V10.03.06 24/05/2012  Ebon Clements  CAR 257542
.            Include cancelled bookings in pre assessment list - TASS0000
.  V10.03.05 10/05/2012  Peter Vela     CAR 232137
.            Recompiled for BEDBDVCD
.  V10.03.04 19/03/2012  J.Tan          CAR 259019
.            Fixed preadmission list to print primary procedure
.  V10.03.03 27/01/2012  Ebon Clements   CAR 259157
.            Fixed ward bed display on standby list - STBCON00
.  V10.03.02 27/01/2012  Ebon Clements   CAR 259160
.            Recompiled for PATMASTM - Name field lengths
.  V10.03.01 16/01/2012  Sandra Barcham  CAR 256563
.            Recompiled for PATMASTM
.  V10.02.08 30/09/2011  Jill Parkinson CAR 248486
.            Recompiled for IBAWEBCD - Restrict Hospital Access
.  V10.02.07 04/08/2011  Peter Vela     CAR 240719
.            Changed ONLV0000 to display red Exp return date if current day
.            is past exp return date
.  V10.02.06 03/08/2011  Jill Parkinson CAR 240713
.            Changed ONLV0000 to only output patients in current hosital
.  V10.02.05 08/07/2011  Mike Laming       CAR 240724
.            Mods to MRT Tables to add Hospital Id. (MRTMASaf) for WA Health    
.            25/06/2011 Steve Armstrong    CAR 240722
.            Mods to cater for changes to PATLOCFD.
.                 - LSNAME & LGNAME extended to 40 chars.
.                 - PTLCGNM2 added.
.            05/07/2011 PMcM    Car 240725
.            Mods to respont to PTCNWBDS=2 (short ward/bed names) 
.  V10.02.04 24/05/2011  Peter McMullen CAR 240725 WA Health
.             Change waed select list to sort by name, not code   
.  V10.02.03 24/05/2011  Peter McMullen CAR 240725 WA Health
.            Show ward short decription instead of ward code.                  
.  V10.02.02 10/05/2011  Davin          CAR 239539 WA Health
.            Changed to allow 3 alert indicators to be displayed (BKTABC25)
.  V10.02.01 27/04/2011  Peter Vela     CAR 240719
.            Added Consecutive Leave Days @ ONLV0000
.-----------------------------------------------------------------------------
.  V10.01.04 11/01/2011  Ebon Clements  CAR 215701
.            Recompiled for BEDBDVCD -  H/F stepdown
.  V10.01.03 30/11/2010  Jill Parkinson   LANDESK 500246 
.            Added RDMAST1 in TOPB1000
.  V10.01.02 19/11/2010  Steve Armstrong   CAR 234061
.            Recompiled for changes to PMSNUTFD.
.            Changed CALL's to PMSNUTIO.
.  V10.01.01 04/11/2010  Ebon Clements  CAR 232614
.            Update bed board when cancelling a booking - DELBOK00
.-----------------------------------------------------------------------------
.  V10.00.09 15/10/2010  Ebon Clements  CAR 229932
.            Allow pre assessment update on current admissions - UPPREA00
.  V10.00.08 07/10/2010  Ebon Clements  LanDesk 500075
.            Added post op ward filter and display to pre adm list - TOPR0000
.  V10.00.07 06/10/2010  Ebon Clements  CAR 231396
.            Recompiled for BEDBDVCD - Post op records expected ward/bed
.  V10.00.06 28/09/2010  Jill Parkinson CAR 220454 
.            Added deftflag to NEXT0000 and PREV0000
.  V10.00.05 07/09/2010  J.Tan          CAR 205381 
.            Mods to display Out of Pocket for Eligibility view
.  V10.00.04 12/08/2010  Saroeun Soeur  CAR 228004 
.            Commented out  MOVE OPDAEXPS,BKREATIM
.  V10.00.03 31/05/2010  Ebon Clements  CAR 222988
.            Change CLRPAR00 to set deftview to zero not SP70
.  V10.00.02 23/04/2010  Ebon Clements  CAR 220501
.            Fixed the alert icon display in TOPR0000
.  V10.00.01 19/03/2010  Steve Armstrong   CAR 135505
.            Added HL7TRGID & HL7INCLD setting for all broadcast messages
.-------------------------------------------------------------------------------
.  V9.12.26  09/03/2010  Jill Parkinson CAR 216639
.            Added deftview
.  V9.12.25  04/03/2010  Jill Parkinson CAR 216639
.            Added admsourc filter
.  V9.12.24  21/01/2010  Jill Parkinson CAR 212740
.            Added patient alert link to TOPR0000
.  V9.12.23  06/01/2010  Ebon Clements  CAR 212539
.            Added surgeon to CLRPAR00
.  V9.12.22  14/12/2009  Jill Parkinson CAR 209658
.            Fixed if statement for output of BKREPDAT in TOPB0000 if blank
.  V9.12.21  07/12/2009  Peter McMullen CAR 210130
.            Convert remaining DOCNAM00 calls to DOCNM000                 
.  V9.12.20  04/12/2009  Ebon Clements  CAR 203148
.            Added ~~~ to adpoints filter to select blank admitting points
.  V9.12.19  12/11/2009  Davin          CAR 209427
.            Added default ward flag and new tag for ward seln. list (pbok3600)
.  V9.12.18  21/10/2009  Jill Habasque  CAR 203988
.            Mods to check PTCNDWAW instead of always check bkrxpowd in TASS0000
.  V9.12.17  07/10/2009  Saroeun Soeur  CAR 203443
.            changed booking list date from string to date format - BOKDAT00
.  V9.12.16  29/09/2009  WeeLee Koo     CAR 205346
.            Added Dsc Ward/Bed and Religion to Morgue Mgmt List (TOMP0000)
.  V9.12.14  23/09/2009  Saroeun Soeur  CAR 203443
.            Changed  BKTABC00 - to read BKREEDAT when BKRESTAT is 0
.            instead of BKREADAT (procedure date)
.  V9.12.13  26/08/2009  Peter McMullen CAR 171901
.             remove MAPCAT00 call
.  V9.12.12  17/07/2009  Davin          CAR 176242
.            Set 'surgflag=1' in table output tag rather than cgi variable
.  V9.12.11  29/07/2009  Ebon Clements  CAR 200342
.            Added using cat D or DD test PTCNDRSM to DISCON00
.  V9.12.10  20/07/2009  Saroeun Soeur  CAR 174448
.            added new column to table BPEA1500
.            added new surgeon filter SURGEON,SURG0000
.  V9.12.09  13/07/2009  Mike Laming    CAR 174484
.            Added Southern Cross NZ fields to TOPR0000
.  V9.12.08  10/07/2009  Ebon Clements  CAR 199752
.            Added LinkPatient() to TOPB0000 and TOPR0000
.  V9.12.07  29/06/2009  Davin Sloan    CAR 190927
.            Added output of DOSA (for NZ screens) in booking list (BKTABC00)
.  V9.12.06  24/06/2009  Ebon Clements  CAR 199232
.            Recompiled for BEDBDVCD
.  V9.12.05  18/06/2009  Ebon Clements  CAR 197317
.            Reinstated the hospital test on the Incomplete Eligibility
.            list if multi hospital and all wards selected - PIEL6000
.  V9.12.04  15/06/2009  Ebon Clements  CAR 159088
.            Added OERTIME - Expected return from leave time
.  V9.12.03  28/05/2009  Ebon Clements  CAR 197329
.            Added combined AWARD/ABED output to BKTABC00 and populated ABED
.            for bookings that have a status of booked
.  V9.12.02  18/05/2009  Davin          CAR 176242
.            Only show operation date in BKTABC00 if booking is surgical (based
.            on parameter surgflag from template)
.  V9.12.01  08/05/2009  Ebon Clements  CAR 195390
.            Added EXPTLINK to BKTABC00
.  V9.11.12  29/04/2009  Jill Habasque  CAR 193525
.            Added links to patweb81 for event bookings
.  V9.11.11  21/04/2009  Davin          CAR 183976
.            Added option 19 - bulk eligibility request list (eclipse)
.  V9.11.10  03/03/2009  Ebon Clements  CAR 191233
.            Fixed alert icon display in BKTABC00
.  V9.11.09  20/02/2009  Jill Habasque  CAR 153759
.            Mods to output Health fund in BKTABC00
.  V9.11.08  28/01/2009  Jill Habasque  CAR 85182 
.            Mods to output PAC and PAS appointments in BKTABC00
.  V9.11.07  20/01/2009  Ebon Clements  CAR 187174
.            Don't allow update of future arrival/interview time - BKTABC00
.  V9.11.06  12/01/2009  Jill Habasque  CAR 187234
.            Mods to use ptmiebed in bktabc00 if predmitted 
.  V9.11.05  09/01/2009  Jill Habasque  CAR 187163
.            Mods to use adate or bkreadat to calculate expdscdt in BKTABC00
.  V9.11.04  10/12/2008  Jill Habasque  CAR 184679
.            Mods to output ptmiebed in BKTABC00
.  V9.11.03  04/12/2008  Ebon Clements  CAR 174086
.            Added post op ward/bed to booking list - TOPB0000 - PTCNBBAP
.  V9.11.02  06/11/2008  Peter McMullen CAR 174725
.            convert internal javascript to W3C standards
.  V9.11.01  23/10/2008  Ebon Clements  CAR 174072
.            Remove patient from bed board when morgue location added
.  V9.10.03  15/07/2008  Ebon Clements  CAR 160213
.            Recompiled for update fee estimate functionality changes
.  V9.10.02  08/07/2008  Jill Habasque  CAR 162660
.            Mods to use ptmxsin1 for AlertIcon             
.  V9.10.01  01/05/2008  Jill Habasque  CAR 166097
.            Mods to populate WTWMASSR                      
.  V9.09.11  13/12/2007  Jill Habasque  CAR 153370
.            Added output of time in BKTABC00               
.  V9.09.10  28/11/2007  Peter McMullen CAR 154850
.            Limit hospital filter to authorised hospitals
.  V9.09.09  12/11/2007  Peter Vela    CAR 151199
.            Added new Emergency Cancellation status
.  V9.09.08  09/11/2007  Jill Habasque CAR 151908
.            Added arrival/interview times to booking list
.  V9.09.07  01/11/2007  Peter Vela    CAR 151949
.            Added option 17 - Morgue List
.            Added option 18 - Update Morgue Details
.  V9.09.06  30/10/2007  Davin         CAR 151917
.            Added option 15 - Incomplete Eligibility List
.            31/10/2007  Jill Habasque CAR 151922
.            Added update of pre-assessment details
.  V9.09.05  17/10/2007  Peter Vela    CAR 148954
.            Added delete patbmdaf records on Cancel/Delete booking
.  V9.09.04  12/10/2007  Davin         CAR 151896
.            Display ward/bed description (based on parameter)
.  V9.09.03  02/10/2007  Jill Habasque CAR 151325
.            Mods to use bkreward or bkrxpowd at TOPB1200
.  V9.09.02  21/06/2007  Jill Habasque CAR 143141
.            Added pack of WTENWEBC with userid
.  V9.09.01  20/06/2007  Jill Habasque CAR 142298
.            Added check for hospital in TASS0000
.  V9.08.07  20/04/2007  Ebon Clements CAR 132858
.            Recompiled for PMSWORFD file change
.  V9.08.06  27.02.2007 Ebon Clements   CAR 120004 
.            Changed BKTABC30 to not move line 1 desc to line 2 
.  V9.08.05  09.02.2007 Sandra Barcham  CAR 133235
.            Used 24hr time on discharge list for sorting
.  V9.08.04  31/01/2007  Peter Vela    CAR 127930
.            Recompled for MRTCONFD
.  V9.08.03  05.12.2006  Peter Vela     CAR 127319
.            Added functionality for Interpreter Lists
.            Selection List Cat VA Nationality field Singapore
.            patweb9211001.html patweb9211003.html
.  V9.08.02  24.11.2006  Ebon Clements  CAR 125956
.            Added alert flag and url to BKTABC00
.  V9.08.01  31.10.2006  Ebon Clements  CAR 121802
.            Added srchtype=33 for the admissions by religion list CABCOD00
.  V9.07.02  15.09.2006  Ebon Clements  CAR 118287
.            Added religious visit test to admissions by religion list
.  V9.07.01  12.07.2006  Jill Habasque  CAR 110312
.            Changed to write "05" nbrs record instead of 30 when cancelling
.  V9.06.01  09/06/2006  Neelkamal Pyla CAR 107443
.                        Added HospitalId filter
.  V9.05.02  18/04/2006  Ebon Clements CAR 60975
.            Added tmotfrst and tmotnext to NEXT0000 and PREV0000
.  V9.05.01  09/03/2006  Ebon Clements CAR 78533
.           Mods for PATCODTM - Hospital specific category codes
.  V9.05.B06 20/02/2006  Ebon Clements     CAR 76341
.           Added referral and encounter file audit   
.  V9.05.B05 02/02/2006  Peter Vela CAR 86548
.           Fixed multihospital validation at CABCOD11 (Provisional Diagnosis
.           table display)
.  V9.05.B04 02/02/2006  Peter Vela CAR 89644
.           Recompiled for BOKRX1TM
.  V9.05.B03 30/01/2006  Ebon Clements CAR 93186
.           Mods for REDIRECT length change. Recompiled for IBAWEBDF
.  V9.05.B02 15/12/2005  Davin      CAR 76341
.           Added 'interpreter confirmed' (vsinconf/vsins002)
.  V9.04.24 01/12/2005  Peter Vela CAR 76021
.           Added a read to bokrx1af and populated PROCTIME TOPB5000
.  V9.04.23 30/11/2005  J.Tan    CAR 58666
.           Mods for Eligibility
.  V9.04.22 24/11/2005 J.Tan     CAR 85648
.           Added Payment Recieved column to Booking list
.  V9.04.21 09/09/2005 J.Tan     CAR 58666
.           Added Eligibility check table
.  V9.04.20 30/09/2005  Ebon Clements CAR 58657
.           Added Pre-Admitted/Booked status to TOPB0000
.  V9.04.19 14/09/2005  Ebon Clements CAR 76051
.           Set manually added record to no before write to watesnaf
.  V9.04.18 02/08/2005  Davin         CAR 64087
.           Mods for PAS/CIS and proprietary interface changes
.  V9.04.17 02/09/2005  Jill Habasque CAR 70497
.           Changed to pack wtenevdt with bkreedat
.  V9.04.16 10/08/2005  Jill Habasque CAR 64735
.           Added WINPAR00
.  V9.04.15 14/07/2004  Jill Habasque CAR 59005
.           Fixed branch from going to ONLV0035 to ONLV0040
.  V9.04.14 08/06/2005  Jill Habasque CAR 60165
.           Added update of WTENSADI
.  V9.04.13 08/03/2005  Peter Vela CAR 23312
.           Added display functionality for Expected Discharge Date in pmsworaf
.  V9.04.12 29/04/2005  Peter Vela       CAR 55214
.           Recompiled for MRTCONFD
.  V9.04.11 07/03/2005  Steve Armstrong    CAR 59137
.           Recompiled for changes to CISINADT, HL7CISIN & HL7CISVR
.  V9.04.10 01/03/2005  Peter Vela    CAR 57547
.           Recompiled for PATVADFD and PATVADIO
.  V9.04.09 02/03/2005  Mike Laming       CAR 46977
.           Add further Qualification in OP type code. (from V9.03)
.  V9.04.08 31/01/2005  Ebon Clements     CAR 53466
.           Recompiled for VISCMTCD
.  V9.04.07 10/12/2004  Jill Habasque     CAR 54731
.           Added write to watesnaf
.  V9.04.06 23/11/2004  Davin             CAR 34707
.           Changed CHKCCD00 to return "1" if at least one valid concession
.           card exists
.  V9.04.05 08/11/2004  Guomin Fu         CAR 54257
.           Added working diagnosis to patient condition in admission lists
.  V9.04.04 12/10/2004  Ebon Clements     CAR 53466
.           Recompiled for removal of changes in V9.03.43 VISCMTCD
.  V9.04.03 17/09/2004  Peter Vela CAR 53466
.           Recompiled for VISCMTCD
.           Declared BLNKFLAG
.           15/09/2004  J.Tan     CAR 53539      
.           Mods to print booking number for exp.booking list
.           20/09/2004  Jill Habasque            CAR 53540
.           Recompiled for IBAWEBCD
.  V9.04.02 30/08/2004  Jill Habasque CAR 53046 
.           Added more checks for multihospital indicator
.  V9.04.01 27/08/2004  Jill Habasque CAR 53046 
.           Added checks for multihospital indicator
.-----------------------------------------------------------------------------
.  V9.03.23 10/08/2004  Mike Laming    CAR 40489
.           Changes to Interpreter Visit Details "visintaf" & Audit "visiauaf"
.  V9.03.22 30/07/2004  Davin             CAR  34707
.           Added concession card check
.  V9.03.21 28/06/2004  Ebon Clements CAR 51144                       
.           Moved date check to before booking extn file read on TOPB1000
.           28/06/2004  Steve Armstrong    CAR 51167
.           Recompiled for changes to HL7CISIN
.  V9.03.20 11/06/2004  Mike Laming   CAR 49016  July 2004 PRS/2      
.           - Add Sex Description routine SEXDSC00 with Code "R" - "Intersex"
.  V9.03.19 07/06/2004 Peter Vela CAR 49016
.           2004 Statutory Changes - recompiled for PMSPX2TM
.  V9.03.18 12/05/2004  Steve Armstrong   PAS-CIS Product Integration
.           Added call to cisa31br routine and included relevant variables
.           for PAS-CIS Interface  CAR   49679
.  V9.03.17 20/05/2004  Ebon Clements CAR 49926                         
.           Added OPCNDORD to booking list for diagnosis/procedure display order
.  V9.03.16 16/03/2004  Peter Vela    CAR 13038
.           Changed call DOCNAM00 to DOCNM000 (parameter driven doctor name 
.           format) for sort lists.
.  V9.03.15 20/12/2003  Ebon Clements CAR 44720
.           Added gobtform cgi to TOPA0000
.  V9.03.14 18/12/2003  Peter Vela    CAR 43134
.           Recompiled for MRTCONFD
.  V9.03.13 11/12/2003  Peter Vela    CAR 40355
.           Recompiled for PATNAMCD
.  V9.03.12 09/12/2003  Ebon Clements CAR 45477
.           Fixed outpatient interpreter list for multiple sites
.  V9.03.11 20/11/2003  J.Tan  CAR  44167
.           Mods to check for credit note for cancel pre-admission
.  V9.03.10 13/10/2003  Davin         CAR 39038
.           Recompiled for change to viscmtfd
.  V9.03.09 10/10/2003 Sandra Barcham    43422
.           Recompiled for CLBOKRX1
.  V9.03.08 01/10/2003 Jill Habasque CAR 43054 
.           Fixed output of unit description for standby list
.  V9.03.07 30/09/2003 Ebon Clements  CAR 43674
.           Close files before opening in OPNOUT00
.  V9.03.06 12/09/2003 Sandra Barcham     43010
.           Remove file prefix on opens of outpreaf & outphoaf
.  V9.03.05 06/08/2003 Guomin Fu                           SRF/CAR 42083
.           At label OLVCON00 moved TDESC to UNITDESC after call to GETCOD00
.           to save the Unit Description.  Previously the TDESC was overwritten
.           with the Residential Status from another call prior to outputting.
.           24/07/2003 Peter Vela      CAR 41298
.           Added column (Clinic Type) in Interpreter List Outpatients and
.           Allied Health (patweb9211003.html)
.  ........ 22/07/2003 Jill Habasque   CAR 21760  
.           Changed read of bokdiaaf records        
.  V9.03.04 17/07/2003 Jill Habasque   CAR 40995  
.           Added output of Specialty for NZ lists
.  V9.03.03 14/07/2003 Sylvek Litewka  CAR 39213  
.           Added report numbers 13 and 14 for Infection Control processing.
.           Modified procedure EXDCON00 to display Claim Type and Patient Type
.           on the Expected Discharge List.
.  V9.03.02 06/06/2003 Jill Habasque SRF 38102
.           Added CHKLAN00 to validate interpreter/language
.           26/05/2003 Sylvek Litewka  CAR 39213
.           Added procedures EXDS0000 and EXDCON00 to output the Expected
.           Discharge List.
.  V9.03.01 09/05/2003 Ebon Clements CAR 38921
.           Fixed ADMCON00 category code read for the Unit description
.-----------------------------------------------------------------------------
.  V9.02.69 03/04/2003 Jill Habasque SRF 37856
.           Fixed output of URNUMBER in TOPR0000
.  V9.02.68 01/04/2003 Tracey Nguyen                       SRF/CAR 37632
.           At label TOPR2000 moved TDESC to UNITDESC after call to GETCOD00
.           to save the Unit Description.  Previously the TDESC was overwritten
.           with the Residential Status from another call prior to outputting.
.
.           26/03/2003 Tracey Nguyen                       SRF/CAR 37387
.           Move current date to PCHGDTE before call to UPMAST1 to capture
.           date of last change made.  Use STATUS20 instead of KEY20 to 
.           display the patient status.
.  V9.02.67 20/03/2003 J.Tan   SRF 37381
.           Fixed displaying fields for Interpreter List Pre-admission
.  V9.02.66 07/03/2003 Tracey Nguyen SRF 34880
.           Call PATFLD00 to display the correct colour for patient folder.
.           Note: A call to PATFLD00 returns KEY3 which contains the colour
.                 code for the patient folder.
.  V9.02.65 09/12/2002 Jill Habasque SRF 34157  
.           Added call to DGCLICUP after updating patient details             
.  V9.02.64 05/12/2002 Lina Vo       SRF 22709  
.           Changed program to open outpreaf with site prefix.                
.  V9.02.63 29/11/2002 Jill Habasque SRF 34062  
.           Changed Admission list to display admitting doctor not current doc
.  V9.02.62 13/11/2002 Peter Vela    SRF 22732
.           Added functionality for Mental Health On Leave Patients list 
.           (patweb9208002.html)
.  V9.02.61 01/11/2002 Jill Habasque SRF 20260  
.           Changed Admission list to display admitting unit not current unit
.  V9.02.60 24/10/2002 Lina Vo                  
.           Recompile for EOCREFFD
.  V9.02.59 16/10/2002 Peter Vela    SRF 22686
.           Added diet comments to "Condition" column in "Current Inpatients by
.           DIET CODE" list (NZ patweb9201120).
.  V9.02.58 11/10.2002 Lina Vo       SRF 22693
.           Made Claim Code (CL) with ind3=A display Accident number
.           and date. Add new GETACC00 section.
.  V9.02.57 03/10/2002 Peter Vela    SRF 17693
.           Mods to read Admitting Point from patcodes 
.           03/10/2002 Ebon Clements SRF 18640 
.           Made suspended outpatient appointment visit types display red
.           in all interpreter lists 
.  V9.02.56 09/09/2002 Jill Habasque SRF 19046 
.           Added output of BKDIDES1 in BKTABC00                             
.  V9.02.55 05/09/2002 Jill Habasque SRF 21791 
.           Fixed display of location for bookings                           
.  V9.02.54 18.07.2002 Ebon Clements SRF 17676 
.           Fixed internal server error caused by CLBOKRX1 in CLRPAR00       
.  V9.02.53 11.07.2002 Ebon Clements SRF 17676 
.           Added call to CLBOKRX1 to CLRPAR00                       
.  V9.02.52 10.07.2002 Ebon Clements SRF 17676 
.           Fixed up details written to waiting list history file
.  V9.02.51 29.06.2002 Ebon Clements SRF 19105
.           Recompiled for sigpipe trap  
.  V9.02.50 24.06.2002 Jill Habasque 18920  
.           Changed TOPA0000 to use admitting ward instead of current ward
.  V9.02.49 31.05.2002 Ebon Clements 18229  
.           Added trap if sigpipe
.  V9.02.48 10.05.2002 Jill Habasque        
.           Added clear of ward for booking list new
.  V9.02.47 29.04.2002 Jill Habasque 3631
.           Fixed unit filter
.  V9.02.46 21.04.2002 Ebon Clements
.           Mods to GLOC0000 for interpreter list patient location
.  V9.02.45 27.03.2002 Pat Dirito 
.           Routine OUTFIL00 was calling WEBERR00!
.  V9.02.44 26.03.2002 Jill Habasque 3420
.           Fixed output of diagnosis for theatre bookings
.  V9.02.43 21.03.2002 Jill Habasque 
.           Fixed update of pmspx2af in UPDINT00
.  V9.02.42 07.03.2002 Jill Habasque 
.           Added output of notified for interpreter history
.  V9.02.41 19.02.2002 Jill Habasque 
.           Fixed output of interpreter audit
.  V9.02.40 18.02.2002 Jill Habasque 
.           Fixed output of provisional diagnosis list
.  V9.02.39 12.02.2002 Ebon Clements 
.           Added admitting point to bulk print of expected admission for kids
.  V9.02.38 11.02.2002 J.Habasque
.           Move check for blank SRCHCODE                       
.           11.02.2002 Ebon Clements
.           Added ACLIAM to the admission list table sort option ADMCON00
.  V9.02.37 06.02.2002 J.Habasque
.           Added check for All except DSU on booking list new
.  V9.02.36 03.02.2002 B.Ackland 
.           Fix Current Adm by Ward & Diet
.  V9.02.35 02.02.3002 J.Habasque 
.           Added move of one to bkrestat for preadmissions (to fix cancel)
.  V9.02.34 21.01.2002 J.Habasque 
.           Changed BKTABC00 to output the current location instead of home
.           location of medical record
.  V9.02.33 17.01.2002 J.Habasque
.           Fixed preadmissions from the booking list
.  V9.02.32 16.01.2002 J.Tan
.           Mods to display patient type description on discharge list
.  V9.02.31 14.01.2002 Jill Habasque   
.           Fixed unit for booking list
.  V9.02.30 11.01.2002 Ebon Clements   
.           Clear the proposed admission time when a booking is cancelled
.  V9.02.29 10.01.2002 Jill Habasque   
.           Added new fields to BKTABC00
.  V9.02.28 09.01.2002 Ebon Clements   
.           Added details for parameter WTCNUSBC - using cat BC for booking canc
.  V9.02.27 27.12.2001 Jill Habasque   
.           Added bookings to the interpreter list                    
.  V9.02.26 21.12.2001 Glenn Saunders  
.           Output Diagnoses separated by line break for RCH.         
.  V9.02.25 17.12.2001 Pat Dirito      
.           Now outputting a variable for Provisional ICD10 - PMVXPICD
.           was using AMBS. Routine CAROWB00        
.  V9.02.24 10.12.2001 Jill Habasque
.           Added Indicators to be output for deceased,alerts,results & notes
.  V9.02.23 05.12.2001 B.G.Ackland
.           Revised Interpretor Views
.  V9.02.22 03.12.2001 Jill Habasque 
.           Added bookings for bulk print list
.  V9.02.21 29.11.2001 Glenn Saunders
.           Support Admissions by Diet extras for RCH.                     
.  V9.02.20 27.11.2001 Jill Habasque
.           Added output of admission and discharge time in 24 hour format
.  V9.02.19 26.11.2001 Jill Habasque
.           Fixed post op ward for booking list
.  V9.02.18 22.11.2001 Sai
.           Fixed Confirmation date and rearranged the filter routine
.  V9.02.17 20.11.2001 Sai
.           Fixed Interpreter update and added outpatient letters
.  V9.02.16 19.11.2001 Jill Habasque
.           Added output of UR and Adm time for discharge list
.  V9.02.15 15.11.2001 Jill Habasque
.           Added ward selection for Admissions by diet  
.           17.11.2001 Sai
.           Added Interpreter Lists       
.  V9.02.14 10.11.2001 Jill Habasque
.           Added CHKPRV00 to check for anonymous patients         
.  V9.02.13 08.11.2001 Jill Habasque
.           Fixed filter for ward on preadmission list (TOPR0000)
.  V9.02.12 07.11.2001 Jill Habasque
.           Fixed admitting point filter in BKTABC00                 
.  V9.02.11 03.11.2001 Jill Habasque
.           Changed discharge list to use PMVXIDUS instead of U5 for 
.           the patient type
.  V9.02.10 02.11.2001 Ashwin
.           Move data to display Diagnosis,Form and Admitting Point,
.           Add New Report to Delete a booked patient
.  V9.02.09 23.10.2001 Bronko Sosic              
.           Changed display of current inpatients to filter on date
.  V9.02.08 19.10.2001 J.Habasque                
.           Fixed redirect to admission screen
.  V9.02.07 10.10.2001 J.Habasque                
.           Fixed redirect for booking fields when a preadmission is selected
.           from the booking list
.  V9.02.06 10.10.2001 J.Tan (Copied from 5.09)
.           Replace " in Diag Fields for Table Sort
.  V9.02.05  04.10/2001 Jill Habasque 
.            Added JAVNAM00 for names with apostrophies                     
.  V9.02.04  28.09.2001 Ebon Clements 
.            Corrected format of ward description in ward bed selection list
.  V9.02.03  10.09.2001 Glenn Saunders
.            Mods to support enhancements to pre-admission template:-
.            - Support 04.12   (Combo box for Unit)
.            - Support 04.13.2 (combox box for Ward)
.            - Support 04.14.2 (combo box for Admitting Point)
.            - Change title to "Expected Admission List"
.            - New columns to display :- Unit; Post-op Ward; Admitting Point
.            - New column  to display :- Parents Staying (only for RCH)     
.  V9.02.02  08.09.2001 Jill Habasque
.            Mods in DISCON00 to read patdadaf & patvadaf for hospital 
.            transferred to
.  V9.02.01  21.08.2001 Jill Habasque
.            Commented out check for SRCHTYPE=15 (V9.00.B01 changes)
.  V9.01.03  20.08.2001 Ebon Clements
.            Fixed display of deceased status in TOCS0000 current admission
.  V9.01.02  15.08.2001 Saiprasad Mishra
.            Added filter for Ward in routine  TOPA0000,TODP0000
.  V9.00.01  14.08.2001 J.Tan
.            Recompiled for PATMASTM
.  V9.00.00  06/08/01 J.Tan
.            Added Admission number on Current admission (TOCA0000)
.  V9.00.B04 24/06/01 HPS
.            Modified for claim form signed
.  V9.00.B03 22/06/01 Ebon Clements 
.            Add status of bed back to print of current patients. It had been
.            removed some time after R5.08. eg (L)eave
.  V9.00.B02 20/06/01 HPS
.            Removed the check for claim code and operation date
.  V9.00.B01 12/05/01 By HPS - ODC
.            Provisional Diagnosis Update by Unit   
.            Added modifications in the following items as per the 
.            Specifications. Screen 20, Screen 30, 
.            Other Details - Current I/P by claim code
.  V5.10.B04 20/03/2001 Bronko Sosic
.            Added check for Patient death in GETPAT00 
.  V5.10.B02 27/02/2001 Ebon Clements
.            Mods for Admissions List  - output Diet and Department codes
.  V5.09.04 22/02/2001 Bronko Sosic
.           Mods for Stand-by List & On-Leave List
.           Added PATNAMCD and changed all displays of 
.           Patient name to FORMATNM
.  V5.09.03 14/02/2001 J.Tan
.           Mods for Discharge List
.  V5.09.02 15/01/2001 Bronko Sosic
.           Recompiled For PATMASTM
.  V5.08.12 17.11.2000 B.G.Ackland  
.           Add Diagnosis as new column for Admissions by Code
.           Enable Current Admissions by Blank Code
.  V5.08.11 31.10.2000 B.G.Ackland  
.           Show Expected Admission Ward in Booking List
.  V5.08.10 30.10.2000 B.G.Ackland  
.           Show Expected Admission Ward
.  V5.08.09 27.10.2000 B.G.Ackland  
.           Show Indicator for Patients on Leave
.  V5.08.08 20/09/2000 Katie Nelson
.           509 Changes
.  V5.08.07 11/09/2000 Katie Nelson
.           SRF 647242.  Replace plus with space on urnumber.
.           Fixed the sex from appearing always as 'unknown'.
.  V5.08.06 05/09/2000  Tonii
.           Mods to accept Unknown and Indeterminate as valid patient sex desc.
.  V5.08.05  16/08/2000  Caleb Sharman
.           Changed Health Fund variables to be 8 chars
.  V5.08.04 23/06/2000 Katie Nelson 
.           Added display of Update Date/Time against Patient Condition
.  V5.08.03 22/06/2000 Bronko Sosic
.           Added table for Pre-Admission Cancellations
.  V5.08.03 08/06/2000 Katie Nelson
.           Fixed the display of Patient Condition to have comments below.
.  V5.08.02 05.06.2000 K.C Nelson     
.           Removed PATMASTM, added WRTAGE00 and PATNAM00       
.           Added Standby, On-Leave and Pre-Assessment Tables 
.  V5.08.01 10.04.2000 B.G.Ackland    
.           Added Column for U/R in all Table Sort Outputs
.  V5.07.08 15.02.2000 B.G.Ackland    
.           Table Sort Admissions by Code
.  V5.07.07 02.02.2000 B.G.Ackland    
.           Fix Patient Age Output
.  V5.07.06 05.01.2000 K.C.Nelson     
.           Recompiled for WEBDATCD Y2K date corrections and PATMASTM changes 
.  V5.07.05 20.12.1999 K.C.Nelson     
.           Recompiled for IBAWEBCD/IBAWEBDF                              
.  V5.07.04 03.11.1999 K.C.Nelson     
.           Recompiled for WEBDATCD/DAYOFWEK                              
.  v5.07.03 11.10.1999 B.G.Ackland    
.           Fixed Booking Doctor in Pres-Admission List                   
.
.  v5.07.02 24.09.1999 Katie Nelson   
.           Changed DIV attribute class to id                             
.  v5.07.01 28.06.1999 Katie Nelson   
.           Port from 6.06 to 5.07                              
.           12.09.1999 Katie Nelson   
.           Added consultant and diagnosis to Bookings list
.----------------------------------------------------------------------
.  v6.06.02 25.06.1999 Katie Nelson   
.           Changed routines to output javascript sort tables 
.
.  v6.05.03 01.02.1999 Farhana Mannan
.           Added Booking list option to Hospital List Server
.
.  V6.05.02 18.01.1999 B.G.Ackland
.           Changed Patient Name format, Fixed Admission Date
.
.  V6.05.01 16.01.1999 B.G.Ackland
.           Added Extention to Hospital Search Current Adm
.
.  V6.04.00 11.02.1998 B.G.Ackland
.           Created Program
.
.----------------------------------------------------------------------
          INC       IBAWEBDF  
          INC       WEBDATDF
          INC       FHRDATDF
          INC       RSHWEBDF
          INC       GTCMPATD/INC
.
          INC       TFILEVAR/INC
          INC       COMPARFD/INC
          INC       OBSPCOFD/INC       * Patient Correspondence
          INC       ACCCMTFD/INC
          INC       ACCAUDFD/INC       * New ACC Audit file
          INC       ALLCONFD/INC
          INC       ALLREFFD/INC            * Allied Health for interpreters
          INC       APSMASFD/INC
          INC       BOKDIAFD/INC
          INC       BOKRC1FD/INC         *For patient booking
          INC       BOKRX1FD/INC
          INC       BOKRX1TD/INC
          INC       CATCOMFD/INC
          INC       COMERHFD/INC
          INC       EMRVISFD/INC            * Emergency
          INC       EOCACCFD/INC
          INC       EOCLNKFD/INC
          INC       EOCREFFD/INC
          INC       IBAPHNFD/INC 
          INC       MEHVI1FD/INC
          INC       MLTSECFD/INC
          INC       MLTHCPFD/INC
          INC       MRTCONFD/INC
          INC       MRTMASFD/INC
          INC       MRTVISFD/INC
          INC       NHIETHFD/INC
          INC       NHIMASFD/INC
          INC       NZPSPRFD/INC            * NZ Priv Subseq't Proc/Funder Det
          INC       OBSPCTFD/INC
          INC       OPRDEAFD/INC
          INC       OPRSESFD/INC
          INC       OUTBB1FD/INC
          INC       OUTBOAFD/INC            * outpatient booking
          INC       OUTCANFD/INC            * reqd for outpatient cancellations
          INC       OUTCLIFD/INC            * Reqd for showing clinic id desc
          INC       OUTCTYFD/INC            * Reqd for showing unit(clinic typ)
          INC       OUTDIAFD/INC            * diagnosis for outpatient
          INC       OUTLETFD/INC            * Outpatient letters
          INC       OUTLHIFD/INC            * Outpatient letter history
          INC       OUTMA1FD/INC            * reqd for outpatient location
          INC       OUTPREFD/INC            * outpatient booking
          INC       OUTSITFD/INC
          INC       PATALRFD/INC
          INC       PATATRFD/INC
          INC       PATATRTD/INC
          INC       PATBMDFD/INC
          INC       PATCALAG/INC
          INC       PMSUCHFD/INC
          INC       PMSUCDFD/INC
          INC       PATCONFD/INC
          INC       PATDADFD/INC
          INC       PATDHEAD/INC
          INC       PATDO1FD/INC 
          INC       PATDSCFD/INC
          INC       PATECDFD/INC
          INC       PATELGFD/INC
          INC       PATFN1FD/INC
          INC       PATHSPFD/INC
          INC       PATIN1FD/INC
          INC       PATLOCFD/INC 
          INC       PATMA1FD/INC
          INC       PATMI1FD/INC
          INC       PATMISTD/INC
          INC       PATNIDFD/INC
          INC       PATONLFD/INC
          INC       PATPR1FD/INC
          INC       PATTRNFD/INC
          INC       PATVADFD/INC
          INC       PATVENFD/INC
          INC       PATVISFD/INC 
          INC       PATWC1FD/INC
          INC       PATWR1FD/INC 
          INC       PATRGMFD/INC
.
          INC       PMSCCDFD/INC   * Concession Card Details
          INC       PMSLRDFD/INC 
          INC       PMSLRDTD/INC 
          INC       PMSREGFD/INC
          INC       PMSAIDFD/INC                                      *I-174484
          INC       PMSBBDFD/INC
          INC       PMSBRQFD/INC
          INC       PMSEPBFD/INC
          INC       PMSELFFD/INC
          INC       PMSCNOFD/INC
          INC       PMSHCGFD/INC
          INC       PMSHCGTD/INC
          INC       PMSHCPFD/INC
          INC       PMSHCPTD/INC
          INC       PMSIFTFD/INC
          INC       PMSIFTTD/INC
          INC       PMSMORFD/INC
          INC       PMSMORTD/INC
          INC       PMSNUTFD/INC
          INC       PMSOECFD/INC
          INC       PMSOECTD/INC
          INC       PMSPX2FD/INC
          INC       PMSCEXFD/INC
          INC       PMSRELFD/INC
          INC       PMSTLEFD/INC
          INC       PMSPX2TD/INC            * PMI Details
          INC       PMSSMHFD/INC
          INC       PMSSRMFD/INC
          INC       PMSSRRFD/INC
          INC       PMSVX1FD/INC
          INC       PMSWORFD/INC            * I-54257
          INC       PMSWTRFD/INC
          INC       PMSWORTD/INC            * I-54257
          INC       PMSWX1FD/INC
          INC       VISCMTDF
          INC       VISCMTFD/INC            * visit comments file
          INC       VISIAUFD/INC            * Interpreter Audit
          INC       VISINTFD/INC            * Added for interpreter views
          INC       WATCONFD/INC
          INC       WATHISFD/INC
          INC       WATLETFD/INC
          INC       WATMESFD/INC
          INC       WATTR1FD/INC
          INC       WATESEFD/INC
          INC       WATSUSFD/INC
          INC       WATCATFD/INC
          INC       WATESNFD/INC
          INC       WATTX1FD/INC
          INC       WATOPAFD/INC
          INC       WATOPSFD/INC
          INC       WEBOECFD/INC
          INC       WEBOECTD/INC
          INC       WEBELFFD/INC
          INC       WEBEEHFD/INC
          INC       OPRCONFD/INC
          INC       RCPDTEFD/INC
          INC       RCPBNKFD/INC
          INC       PATMASTD/INC
          INC       PMSEXTFD/INC
          INC       PMSEXTTD/INC
.
.
CMMFILAF  FILE      ASCII, FIXED=127
COMFILAF  FILE      ASCII, FIXED=127
.
.
. LOCAL VARIABLES
. ---------------
.
ACCIDTDT  DIM       8         * Accident date
ACCIDTNO  DIM       20        * Accident number
ALRTLINK  DIM       127       * Link to the patient alerts page
ARRTLINK  DIM       127
ALRTIMGE  DIM       127       * Link to the patient alerts page
ALRTIMG1  DIM       127       * Link to the patient alerts page (Medical Alerts)
ALRTIMG2  DIM       127       * Link to the patient alerts page (Micro Alerts)
ALRTIMG3  DIM       127       * Link to the patient alerts page (Risk Alerts)
ALRTIMG4  DIM       127       * Link to the patient alerts page (Chronic Alerts)
ALRTIMG5  DIM       127       * Link to the patient alerts page (IP/ED Alerts)
ALRTDISA  DIM       127       * Link to the patient alerts page (Disability)
ALRTIMGT  DIM       650       * Link to the patient alerts page
ACTVDESC  DIM       3
ROOMDESC  DIM       25
BEDTDESC  DIM       25
ADMDCTR1  DIM       4
ADMDDATE  DIM       13
ADMICTR1  FORM      4
ADMISFLG  FORM      1
ADMNDATE  DIM       11                      * Formatted Admission Date
ADMNDATT  DIM       20                      * Formatted Admission Date and Time
ADMTIME   DIM       10
ADPOINTS  DIM       3
ADMSOURC  DIM       3
ALTIDFLG  FORM      1                                                 *I-174484
APOIDESC  DIM       20
ATYPDESC  DIM       20
ATYPE030  INIT      "030"
ASRCDESC  DIM       20
ACLSDESC  DIM       20
.
AUORDATE  DIM       8         * Original Date (Interpreter Change Audit)
AUORTIME  DIM       8         * Original Time (Interpreter Change Audit)
AUAMDATE  DIM       8         * Amended Time (Interpreter Change Audit)
AUAMTIME  DIM       8         * Amended Time (Interpreter Change Audit)
.
BEDRWARD  INIT      "~~B"
BK        DIM       3
BKTYPCOL  DIM       1         * Booking Type column; 1=Show
BKREC009  DIM       3         * Cancellation reason (Cat "BC")
BLNKFLAG  FORM      1
BOOKFLAG  FORM      1                      * Patient has a booking flag
BOOKING   DIM       21                     * Patient booking status var 
BOOKCRDT  FORM      1         * List booking by date booking created *T0870496
BOOKLNEW  FORM      1
BTYPDESC  DIM       25
BMIINDIC  DIM       1
BMIPLINK  DIM       127
BODMASRN  DIM       60
BODMASIN  DIM       5
BUTTONCO  DIM       6
BUTTONNA  DIM       10
BODMASUW  INIT      "<font color=purple>"
BODMASHE  INIT      "<font color=black>"
BODMASFT  INIT      "<font color=red>"
BOLD      INIT      "<b>"
ENDBOLD   INIT      "</b>"
ENDFONT   INIT      "</font>"
GREEN     INIT      "00FF00"
YELLOW    INIT      "FFFF00"
RED       INIT      "FF0000"
ORANGE    INIT      "FFA500"
ONLCOUNT  FORM      3
TOTCOUNT  FORM      3
FONTORNG  INIT      "<font color=orange><b>"
F12       FORM      12
FONTRED   INIT      "<font color=red><b>"
.
CARETYPE  DIM       25
CALDAYS   FORM      4
CATBW     INIT      "BW"
CATTC     INIT      "tc"
CATPN     INIT      "Pn"
CASEKEYS  DIM       19                      * Used for waiting list bookings
CATASSGN  FORM      5
CATCHGFL  FORM      1
CFILEPRE  DIM       3
CFSIGND   DIM       3         * Claim form signed   
CHECKALL  DIM       1
CHALDIET  DIM       1
CHNGTYPE  DIM       1                       * for change type interpreter audit
CHRQDATE  DIM       8                       * Date reqd./change
CHRQTIME  DIM       8                       * Time reqd./change
CLAIMTYP  DIM       3
CLAIMCOD  DIM       3
CLAIMDES  DIM       25                      * For claim code
CLILDESC  DIM       25                      * for clinic location outpatient
CLINID    DIM       30                      * Clinic ID                *I-46977
CLURCTDT  DIM       8
CMMFILNM  DIM       8
CMNTSFLG  DIM       1
HISTRECV  DIM       1
CNLVDAYS  FORM      4
CNLVDATE  DIM       8
COLDAT02  DIM       43
COLDAT03  DIM       30
COLDAT04  DIM       30
COLHED01  DIM       30
COLHED02  DIM       30
COLHED03  DIM       30
COMFILNM  DIM       8
COMMCNT   FORM      3
CONDESC   DIM       25
CONFIRMD  DIM       3
COUNTLEV  FORM      3
CTYPDESC  DIM       25
CURLVMIN  FORM      4
CURLVDIM  DIM       8
CURRDATE  DIM       8
CURRDATX  DIM       8
CHKCOMPL  DIM       1
CHKEXTVD  DIM       8           * Variable for CHKEID00 proc
.
DASH      INIT      "-"
DAYSON    FORM      4         * Days on leave 
DAYTIME   DIM       3
DBOKADMN  DIM       8
DBOKURNO  DIM       8
DEFTFLAG  FORM      1
DEFTVIEW  DIM       1
DESTDESC  DIM       20            
DESCUDF3  DIM       20
DFDTVIEW  DIM       1          *Default date view               *T0870496
DTFASTNG  DIM       6
DFLTWARD  DIM       3         * ward to be pre-selected on select list 
DFLTHOSP  DIM       3                                                 *I-240724
DFLTLOCN  DIM       4                                                 *I-240724
DIETDESC  DIM       100
DIAGDES1  DIM       50
DIAGDES2  DIM       50
NBSP8     INIT      "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"
DIM2A     DIM       2
DIM2B     DIM       2
DIM2C     DIM       2
DIM2D     DIM       2
DIM3      DIM       3
DIM3A     DIM       3
DIM4      DIM       4
DIM5      DIM       5
DIM8      DIM       8
DIM11     DIM       11
D11       DIM       11
DIM15     DIM       15
DIM20A    DIM       20
DIM20B    DIM       20
DIM25     DIM       25
DIM320    DIM       320
SP320     DIM       320
ENDDTE    DIM       8
EXTVSTID  DIM      632          * Vist No + External Visit No + Html Character
SAVDATA1  DIM       200
SAVINDC3  DIM       1
SP80      DIM       80
SUPERLEV  DIM       1
SHOWFLAG  FORM      1
PHISFLAG  DIM       1
DIM100A   DIM       100
DIM100B   DIM       100
DIM200C   DIM       200
DISPALTD  DIM       50
DISPACCO  DIM       20        * Display preferred accommodation
DISPCLSS  DIM       11
DISPCOMP  DIM       8
DISPDATE  DIM       13        * display variable for patient condition date
DISPDAT1  DIM       23                      * Display date
EDITICON  DIM       100
DISPSTAY  DIM       20        * Intended stay description
DISPTDAT  DIM       16        * Theatre booking date and time
DISPPCNT  DIM       2
DISPPNAM  DIM       80
DISPPRAC  DIM       10
PRACNAME  DIM       80
PRACADD1  DIM       60
PRACADD2  DIM       60
PRACADD3  DIM       60
PRACADD4  DIM       60
PRACPOST  DIM       8
PRACPEML  DIM       80
PRACPTEL  DIM       20
PRACPFAX  DIM       20
PRACPROV  DIM       10
PTSTATUS  FORM      1
DOCCOD    DIM       6
DOCLOC    DIM       20
DOCTCODE  DIM       6
DOCTYPE   DIM       20
DOSASTAT  DIM       3                       * DOSA status Yes/No/Unkown
DRECCNT   DIM       3
DRORDESC  DIM       20
DSCHDATE  DIM       11                      * Formatted Discharge Date
DSCHTIME  DIM       10
DSDTWORK  DIM       8
DSPOECST  DIM       20
DSWOECST  DIM       70
DSTMWORK  DIM       8
.
ENDNAME   DIM       70
ENDOFLST  DIM       8
EPHFUND   DIM       6
EXDDTE    DIM       8                      * Expected discharge date
EXDSCDTE  DIM       8                       * Expected Disch Date (CCYYMMDD)
EXDSCFLD  DIM       50
EXPCTDSC  DIM       11                      * Expected Disch Date (Display Form)
EXPDDATE  DIM       13
EXPDSCDT  DIM       11                     * Expected Discharge Date
EXPTLINK  DIM       127
EXPTWARD  DIM       3
EXPTBEDD  DIM       3
EXPTWTXT  DIM       20
.
FIRSTBOK  DIM       1
F1A       FORM      1
F1B       FORM      1
FADMDATE  DIM       12
FADMDTTM  DIM       24
ACAUDTTM  DIM       24
FATHCOBD  DIM       20
FBOKDATE  DIM       12
FBOKDTTM  DIM       24
FILBCRDT  DIM       1          *Date Booking Created Filter     *T0870496
FILTBOOK  DIM       3
FILTFLAG  FORM      1
FILTFUND  DIM       6
FILTHOSP  DIM       3
FILTOWRD  DIM       1
FILTPWRD  DIM       3
FILTSTAY  DIM       3
FILTWARD  DIM       3                       * Ward Code
FLAGS001  DIM       1                       * Flag to distinguish change filter
FLINKTYP  FORM      1
FLTRECTY  DIM       1
FLTVISTY  FORM      1
FORM2A    FORM      2
FORM2B    FORM      2
FORM2C    FORM      2
FORM2P1   FORM      2.1
FORM2P1A  FORM      2.1
FORM3     FORM      3
FORM4P2   FORM      4.2
FORM5     FORM      5
FORM6     FORM      6
FORM6A    FORM      6
FORM6P1   FORM      6.1
FORM6P1A  FORM      6.1
FORM8     FORM      8 
FORM12P2  FORM      12.2
FROMDATE  DIM       8
FUTRADMN  FORM      1
.
GOBTFORM  DIM       1                       * Go button display page cgi flag
GOTGFLAG  FORM      1                       * Go button tag flag
HEAVIEW   FORM      1
HOSPDESC  DIM       40
HOSPOST   FORM      3
HOSPTEXT  DIM       50
HEALTHFN  DIM       6
.
HTMLLNK3  DIM       227
HTMLLNK4  DIM       227
HTMLLNK5  DIM       227
.
IFSTDESC  DIM       25
.
OECRFLAG  FORM      1                       * able to send OEC request (1=yes)
OECRPRNT  FORM      1                       * OECR print indicator (1=yes)
OVERDATE  DATE      8
OVERSTAT  DIM       1
PRIODATE  DATE      8
PRIVACYO  FORM      1
HOSPCOMP  FORM      1                       * hospital (elig) check complete
.
ICONFLAG  FORM      1
IMGSRC    DIM       20
INTVLINK  DIM       127
INTAUDTY  DIM       1                                                  *I-40489
.
JAVFNAME  DIM       70
JAVGNAME  DIM       25
JAVSNAME  DIM       20
.
KEY1A     DIM       1
KEY3A     DIM       3
KEY3B     DIM       3
KEY3C     DIM       3
KEY3D     DIM       3
KEY3E     DIM       3
KIDSONLY  FORM      1                       * Kids only flag for tags
.
.
LASTITEM  FORM      3
LBED      DIM       3
LEAVETYP  DIM       20
LEAVTIME  DIM       20
LEAVCARE  DIM       3
LEAVEARR  DIM       25
LEAVEREG  DIM       1
LEAVWARD  DIM       3
LEAVRISK  DIM       3
LEAVHHMM  DIM       8
LEAVSTAT  DIM       1
LESTDESC  DIM       10
LEVMINUT  FORM      8
LEVDAYSF  DATE      8
LEVDAYST  DATE      8
LINKTYP   DIM       1
LNK2PRT   FORM      1
LOCATION  DIM       30
LOOPCNTR  FORM      8
LSNRFCRE  FORM      5
LSTDAYS   FORM      5
LWARD     DIM       3
.
MIN       DIM       2
MEDLBOOK  FORM      1
MNHLONLV  FORM      1
MOTHCOBD  DIM       20
MORGACDT  DIM       11
MORGACCB  DIM       20
MORGECDT  DIM       11
MORGEXCB  DIM       20
MORGLOCN  DIM       20
MULTADMN  DIM       1
.
NAWARD    DIM       3
NBRDAYS   FORM      4
NEWTITLE  DIM       30
NEXTPAGE  FORM      1
NMPNUMB   DIM       20
NOLEAVRG  FORM      1
NOPATATR  DIM       1
NOTIFIED  DIM       3
NUTRLINK  DIM       127
NRFCDAYS  FORM      5
.
OECWINDC  FORM      1
OECCOUNT  FORM      3
OECRECKY  DIM       9[99]                   * OEC array (visitno+request flag)
ONLVDATE  DIM       8
ONLVTYPE  DIM       25
ONLVRETR  DIM       8 
OPDATE    DIM       8         * Operation date
OUTALFLG  DIM       1                       * Outpatient & Allied Health Flag
XRETCLAS  DIM       3
.
DOCEXIST  FORM      1
PACAFLAG  DIM       4         * Menuflag               
LINKDOC   DIM       100
PRIFC     DIM       1[999]
PATAPT01  DIM       3
PATFRM01  DIM       3
PATLINK   DIM       127                     * Link to the next patient info
HISTLINK  DIM       127
COMMLINK  DIM       127
PATPRC01  DIM       9
PATPST01  DIM       3
PATRFG01  FORM      1
PATTYPES  DIM       3
PATUNT01  DIM       15        * unit description
PATUNT02  DIM       3         * unit code
PERFNAME  DIM       60
PMPGI002  DIM       20                      * cgi param for lang 1
PMPGI003  DIM       20                      * cgi param for lang 2
PMPGI065  DIM       20                      * cgi param for nationality
POSTWARD  DIM       3
POSTBEDD  DIM       6
PREFLANG  DIM       3                       * Preferred Language Filter
PREFLNG1  DIM       20                      * for preferred lang 1 desc
PREFLNG2  DIM       20                      * for preferred lang 2 desc
PREFLNG3  DIM       20                      * for preferred lang 3 desc
ABRGNATN  DIM       20                      * for nationality/ethn desc
PROCTIME  DIM       5
POSTWTXT  DIM       20
PTMAS008  DIM       35
PTMAS009  DIM       35
PTMAS010  DIM       35
PTMAS011  DIM       35
PTMAS012  DIM       8
PTMAS013  DIM       20
PTYPDESC  DIM       20            
.
RECCNT    FORM      3
RECDTYPE  DIM       12
RECORDTY  DIM       15
RECVMESG  DIM       50
REGCOUNT  FORM      2
RELICODE  DIM       3         * Religion Code`
REQUFLAG  FORM      1
PELFFLAG  FORM      1
RETNPAST  FORM      1 * 0=not past 1=past 2=red (overdue)
REQUSTAT  DIM       2
ROWCLASS  DIM       13
RETNTIME  DIM       20
RETNDATE  DIM       8
RETURNDT  DIM       20
.
SAVDTIME  DIM       8
SAVKEY9   DIM       9
SAVREPTN  FORM      2
SAVPRGID  DIM       8
SAVTXWRD  DIM       3
SAVWEXTN  DIM       20
.
SCHDPRN1  DIM       8
SCHDPRN2  DIM       8
SCHDPRN3  DIM       8
LABELTYP  DIM       10
STATNCO1  DIM       6
STATNCO2  DIM       6
SCHDCOP1  DIM       3
SCHDCOP2  DIM       3
SCHDCOP3  DIM       3
.
SSCHDPR1  DIM       8
SSCHDPR2  DIM       8
SSCHDPR3  DIM       8
SLABELTY  DIM       10
SSTATNC1  DIM       6
SSTATNC2  DIM       6
.
SNDTETIM  DIM       16
SETDFPRG  DIM       8
SHOWCANC  FORM      1
SETDFRPT  FORM      2
SRCHCODE  DIM       3
SRCHDEPT  DIM       3
SRCHEXTN  DIM       6
SRCHFLAG  FORM      1
SRCHGIVN  DIM       30
SRCHSURN  DIM       25
SRCHTITL  DIM       20
SRCHTYPE  FORM      2
STARTLST  DIM       8
STATUS20  DIM       20                      * Save status of patient for display
STATUS25  DIM       25
STRTNAME  DIM       70
SURGBOOK  FORM      1
SURGFLAG  FORM      1
SURGEON   DIM       10
SVCNLVDT  DIM       8
SVCNLVTM  DIM       8
SVCNLVIN  DIM       3
SVLVDYIN  DIM       3
SVCNLVAN  FORM      6
SVLVDAYS  FORM      6
SVPXINTR  DIM       1                                                  *I-40489
SVPXLNG1  DIM       3                                                  *I-40489
SVPXLNG2  DIM       3
SVPXLNG3  DIM       3
SVINNOTF  DIM       1                                                  *I-40489
SVINCONF  DIM       1
SUSPFLAG  FORM      1                       * Suspended Appointment Flag
.
TABLDESC  DIM       20        * Description for display
TABLEFMT  FORM      1
TESTDAT1  DIM       14
TESTDAT2  DIM       14
THETFLAG  FORM      1
TITLFLAG  FORM      1
TODATE    DIM       8
TMPDSDAT  DIM       8
TMPDSTIM  DIM       8
TODAY     DIM       8
TODAYONL  FORM      1
TOTALCNT  FORM      3
TOTLTIME  DIM       10
TYPECODE  DIM       3                       * Type of Leave Code
.
UNITCODE  DIM       3
UNITDESC  DIM       20
UPDATEKY  DIM       22                      * admissno,ccyymmdd,hhmmss
UPDLINK   DIM       127
UPDTTYPE  DIM       1                       * Update Type
NOBOKMOD  DIM       1                       * dont update booking file
URNO      FORM      6
URCMTFLG  FORM      1
URCMTLIN  FORM      3
URRFCDAY  FORM      5
URTXUNIQ  FORM      3
.
VIEWLINK  DIM       127
VISITNUM  DIM       8
VISITTYP  DIM       6
VISTLOC   DIM       70
VSINS001  DIM       1                       * Notified
VSINS002  DIM       1                       * Confirmed
VSTATUS   DIM       45
.
WARDCODE  DIM       3                       * Ward Code		
WARDKEY   DIM       3                       * Ward Code		
WARDTEXT  DIM       20
WLCATEGY  DIM       3
BEDKEY    DIM       3                       * Bed Code		
WARDBED   DIM       43
BEDTEXT   DIM       25 
WBEDTEXT  DIM       43
WATCOUNT  DIM       2                       * Procedure Count
WATTR001  DIM       9                       * Procedure code
WBEDDESC  FORM      1
WLWMPTY   DIM       25
WLRFCDAY  DIM       5
WLHIP     DIM       5
WTMEEND   FORM      2
WORKDFLG  FORM      1         * I-54257
WORKFLAG  DIM       1         * I-54257
WORKDESC  DIM       125       * I-54257
WORKDES2  DIM       300
FRWRDTXT  DIM       40
FRBEDTXT  DIM       40
VHCODNAM  DIM       20
.
.
. Ventilation work variables...
.
VENTVISN  DIM       8        * Visit Number
VENTVTYP  DIM       3        * Ventilation Type (Cat VE)
VENTSDAT  DIM       8        * Start Date
VENTSTIM  DIM       8        * Start Time
VENTEDAT  DIM       8        * End Date
VENTETIM  DIM       8        * End Time
VENTHOUR  FORM      5.2      * Hours
VENTICUS  DIM       3        * ICU Status (Catg IU)
VENTISIT  DIM       3        * Initiation Site (Catg II)
.
.
VENTMPFN  DIM       8        * Ventilation temp filename
VENINDC1  INIT      " 55 UC1-8,9-16,17-24"
.
CMDLINE   DIM       127
ISBUILD   INIT      "isbuild "
ISERASE   INIT      "iserase "
RETURNCD  DIM       8        * Unix command return code
.
.---------------------------------------------------------------------
.         Ventilation Details temp file (indexed by Start Date/Time)
.---------------------------------------------------------------------
VTMPIND1  IFILE    SQL, FIXED=55, KEY="U1-8,9-16,17-24"
.
.NAME     TYPE     LENGTH  PHYSICAL START DESCRIPTION
.----     ----     ------  -------- ----- -----------
VTMPVISN  DIM      8       8        1     Visit Number
VTMPSDAT  DIM      8       8        9     Start Date
VTMPSTIM  DIM      8       8        17    Start Time
VTMPVTYP  DIM      3       3        25    Ventilation Type - Catg VE
.                                         TCINDC1 = 1 (CPAP), 2 (Mechanical)
VTMPEDAT  DIM      8       8        28    End Date
VTMPETIM  DIM      8       8        36    End Time
VTMPHOUR  FORM     5.2     5        44    Hours
VTMPICUS  DIM      3       3        49    ICU Status - Catg IU
VTMPISIT  DIM      3       3        52    Initiation Site - Catg II
.
.End of Record                      55
.
.
. PROGRAM CONSTANTS
. -----------------
.
ALLEDSU   INIT      "A~D"
AT        INIT      "at"
CATA      INIT      "A "
CATAC     INIT      "AC"
CATC      INIT      "C "
CATCC     INIT      "CC"
CATCL     INIT      "CL"
CATDC     INIT      "DC"
CATD      INIT      "D "
CATDD     INIT      "DD"
CATH1     INIT      "H1"
CATH2     INIT      "H2"
CATH3     INIT      "H3"
CATM      INIT      "M "
CATP      INIT      "P "
CATP1     INIT      "P1"
CATP2     INIT      "P2"
CATP3     INIT      "P3"
CATP4     INIT      "P4"
CATP5     INIT      "P5"
CATP6     INIT      "P6"
CATPO     INIT      "PO"
CATR      INIT      "R "
CATS      INIT      "S "
CATT      INIT      "T "
CATTL     INIT      "TL"
CATU1     INIT      "U1"
CATU2     INIT      "U2"
CATU3     INIT      "U3"
CATU4     INIT      "U4"
CATU5     INIT      "U5"
CATU6     INIT      "U6"
CATU7     INIT      "U7"
CATU8     INIT      "U8"
CATU9     INIT      "U9"
CATV0     INIT      "V0"
CATV1     INIT      "V1"
CATwi     INIT      "wi"
CATXG     INIT      "XG"
CODEA     INIT      "A" 
CODEAC    INIT      "AC"
CODEBK    INIT      "BK"
CODECL    INIT      "CL"
CODECO    INIT      "CO"
CODECY    INIT      "cy"
CODEDZ    INIT      "DZ"
CODEMU    INIT      "mu"
CODEVI    INIT      "VI"
CODEVH    INIT      "Vh"
CODEWI    INIT      "wi"
LOWVD     INIT      "vd"
LOWVE     INIT      "ve"
CODSAC    INIT      "ac"
DVISIT    INIT      "Visit"
DCODING   INIT      "Coding"
STATL     INIT      "On-Leave"
STATR     INIT      "Return"
STATA     INIT      "Abscond"
STATO     INIT      "Discharged On-Leave"
.
INPSTAT1  INIT      "Pre-adm"
INPSTAT2  INIT      "Current IP"
INPSTAT3  INIT      "Discharged"
INPSTA3A  INIT      "Disc-"
INPSTA3B  INIT      "Cancelled"
INPSTAT4  INIT      "Leave"
INPSTAT5  INIT      "Cancel"
.
LBRACKT   INIT      "("
ONCLCLSS  INIT      "CareColour"
PIPE      INIT      "|"
RBRACKT   INIT      ")"
STANDBYD  INIT      "(Standby)"
TITLE01   INIT      "Current Inpatients"
TITLE02   INIT      "Patient Discharges" 
TITLE03   INIT      "Patient Admissions" 
TITLE04   INIT      "Preadmission List"
TITLE05   INIT      "Internal Phone List" 
TITLE06   INIT      "Expected Admission List"
TITLE07   INIT      "Standby Patients"
TITLE08   INIT      "On-Leave Patients"
TITLE09   INIT      "Pre-Assesments"
TITLE10   INIT      "Leave Register Management List"
TITLE11   INIT      "Leave Register History List"
TITLE12   INIT      "Pre-assessment History"
TWOEONE   INIT      "218"
SP100     INIT      "                                   ":
                    "                                   ":
                    "                              "
FHRSUBIN  FORM      1      * _include=Encounter:subject
FHRLOCIN  FORM      1      * _include=Encounter:location
FHRPARIN  FORM      1      * _include=Encounter:participant
.
.
ENSTATUS  DIM       20  * Enocunter Status
LCSTATUS  DIM       20  * Location Status
ID        DIM       8
TIMEZONE  DIM       6
TZFILE    FILE      ASCII, FIXED=256
WDBEDTXT  DIM     40         40              17     Ward/Bed description
DIM12     DIM       12
ELCHFLAG  FORM      1
.
AUDITTYP  DIM       1             * Audit Type
ACCTYREC  DIM       1             * ACC Type of Record
AUDITYPE  DIM       20            * Audit type 
ACCTYPRE  DIM       30            * ACC Type of Record
CLAIMSTA  DIM       1             * Claim Status
CLAIMNUM  DIM       20            * Claim Number
FILTSTAT  DIM       1             * Status filter
WCSTDESC  DIM       20            * Workers Comp. Claim Status description
WCESTAT0  INIT      "Existing"
WCESTAT1  INIT      "Parked"
WCESTAT2  INIT      "Completed"
WCESTAT3  INIT      "Cancelled"
RSDATTIM  DIM       25
ATTEXT    INIT      "at"
.
.-----------------------------------------------------------
PRGID     INIT      "PATWEB92" 
VERSION   INIT      "V12.00.03"
PRGNAM    INIT      "Hospital List Server"
.-----------------------------------------------------------
.
MAIN0000  CALL      WEBINT00       * Initialise Fifo Etc.
          CALL      INIT0000       * Open Files
.
MAIN1000  CALL      WEBRED00       * Read Fifo WEBPID and USERID
.
          CALL      OUTFIL00       * Check Correct Site Files Are Open
          BRANCH    EXIT,MAIN1000
.
          COMPARE   "999",REPORTNO * End Server Process on Report Option 999
          GOTO      MAIN9999 IF EQUAL
.
          BRANCH    REPORTNO,MAIN1100,MAIN1200,MAIN1300,MAIN1400,MAIN1500:
                             MAIN1600,MAIN1700,MAIN1800,MAIN1900,MAIN2000:
                             MAIN2100,MAIN2200,MAIN2300,MAIN2400,MAIN2500:
                             MAIN2600,MAIN2700,MAIN2800,MAIN2900,MAIN3000:
                             MAIN3100
.
          PACK      WEBTITLE,PRGID,SP1,VERSION,SP1,PRGNAM,SP70
          MOVE      "INVALID OPTION",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          GOTO      MAIN1000
.
MAIN1100  CALL      CURADM00   
          GOTO      MAIN1000
.
MAIN1200  CALL      DSCLST00  
          GOTO      MAIN1000
.
MAIN1300  CALL      HEADER00  
          GOTO      MAIN1000
.
MAIN1400  CALL      HEADER00  
          GOTO      MAIN1000
.
MAIN1500  CALL      HEADER00  
          GOTO      MAIN1000
.
MAIN1600  CALL      HEADER00
          GOTO      MAIN1000
.
MAIN1700  CALL      HEADER00
          GOTO      MAIN1000
.
MAIN1800  CALL      HEADER00
          GOTO      MAIN1000
.
MAIN1900  CALL      HEADER00
          GOTO      MAIN1000
.
MAIN2000  CALL      DELBOK00
          BRANCH    EXIT,MAIN1000
.
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2100  CALL      INTVIS00                * Interpreter Lists
          GOTO      MAIN1000
.
MAIN2200  CALL      INTDET00                * Interpreter Details 
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.   
MAIN2300  CALL      INFCNT00                * Infection Control 
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.   
MAIN2400  CALL      HEADER00
          GOTO      MAIN1000
.
MAIN2500  CALL      HEADER00                * Incomplete Eligibility
          GOTO      MAIN1000
.
MAIN2600  CALL      UPPREA00                * Update pre-assessment details
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2700  CALL      HEADER00                * Morgue List
          GOTO      MAIN1000
.
MAIN2800  CALL      UPMORG00                * Update morgue details
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2900  CALL      BOEREQ00                * Bulk Online Eligibility Request
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN3000  CALL      ACCLST00                * ACC Lists
          GOTO      MAIN1000
.
MAIN3100  CALL      PREHIS00                * Pre-assessment History
          GOTO      MAIN1000
.
MAIN9999  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      WEBERR00
          STOP
.------------------------------------------------------------
. Open Files and Initialize Variables
.------------------------------------------------------------
INIT0000  OPEN      ACCCMTA1,"acccmtaf"
          OPEN      ACCAUDA1,"accaudaf"
          OPEN      COMERHA3,"comerhaf"
          OPEN      PATDADA1,"patdadaf"
          OPEN      PATATRA1,"patatraf"
          OPEN      PATATRA2,"patatraf"
          OPEN      PATATRA3,"patatraf"
          OPEN      PATVADA1,"patvadaf"
          OPEN      PATVENA1,"patvenaf"
          OPEN      PATVISA1,"patvisaf"
          OPEN      PATVISA2,"patvisaf"
          OPEN      PATWC1A1,"patwc1af"
          OPEN      PATWC1A2,"patwc1af"
          OPEN      PATWC1A3,"patwc1af"
          OPEN      OBSPCOA1,"obspcoaf"
          OPEN      PATBMDA2,"patbmdaf"
          OPEN      PATMA1A1,"patma1af"
          OPEN      PMSBRQA1,"pmsbrqaf"
          OPEN      PMSPX2A1,"pmspx2af"
          OPEN      PATMX1A1,"patmx1af"
          OPEN      PATHSPA1,"pathspaf"
          OPEN      PATPX1A1,"patpx1af"
          OPEN      PATMI1A1,"patmi1af"
          OPEN      PATDO1A1,"patdo1af"
          OPEN      PATPR1A1,"patpr1af"
          OPEN      PATWR1A1,"patwr1af"
          OPEN      PATWR1A7,"patwr1af"
          OPEN      PMSBBDA2,"pmsbbdaf"
          OPEN      PMSEPBA1,"pmsepbaf"
          OPEN      PMSEPBA2,"pmsepbaf"
          OPEN      PMSELFA1,"pmselfaf"
          OPEN      PMSELFA2,"pmselfaf"
          OPEN      PMSELFA3,"pmselfaf"
          OPEN      PMSELFA4,"pmselfaf"
          OPEN      PMSEXTA1,"pmsextaf"
          OPEN      PMSHCPA1,"pmshcpaf"
          OPEN      PMSOECA1,"pmsoecaf"
          OPEN      PMSWORA1,"pmsworaf"       * I -54257
          OPEN      PMSWX1A1,"pmswx1af"
          OPEN      PMSWX1A2,"pmswx1af"
          OPEN      MLTSECA1,"mltsecaf"
          OPEN      MLTHCPA1,"mlthcpaf"
          OPEN      MEHVI1A1,"mehvi1af"
          OPEN      MRTMASA1,"mrtmasaf"
          OPEN      MRTMASA2,"mrtmasaf"
          OPEN      MRTVISA1,"mrtvisaf"
          OPEN      WATESNA1,"watesnaf"
          OPEN      WATCATA2,"watcataf"
          OPEN      WATTR1A1,"wattr1af"
          OPEN      WATESEA1,"wateseaf"
          OPEN      WATSUSA1,"watsusaf"
          OPEN      WATSUSA2,"watsusaf"
          OPEN      WATHISA1,"wathisaf"
          OPEN      WATTX1A1,"wattx1af"
          OPEN      WATOPAA1,"watopaaf"
          OPEN      WATOPSA1,"watopsaf"
.
          OPEN      PATFN1A2,"patfn1af"
          OPEN      PMSAIDA1,"pmsaidaf"                               *I-174484
          OPEN      PMSCEXA1,"pmscexaf"
          OPEN      PMSRELA1,"pmsrelaf"
          OPEN      PMSTLEA1,"pmstleaf"          * open Patient Titles table
          OPEN      PMSTLEA2,"pmstleaf"
          OPEN      PATALRT1,"patalrtf"                               *I-174484
          OPEN      PATDO1A2,"patdo1af" 
          OPEN      PATMI1A1,"patmi1af" 
          OPEN      PATMI1A2,"patmi1af" 
          OPEN      PATMI1A3,"patmi1af" 
          OPEN      PATMI1A8,"patmi1af" 
          OPEN      PATTRAN2,"pattranf"
          OPEN      PATONLV1,"patonlvf"
          OPEN      PATONLV2,"patonlvf"
          OPEN      PATWR1A4,"patwr1af" 
          OPEN      BOKRC1A6,"bokrc1af"
          OPEN      BOKRC1A5,"bokrc1af" 
          OPEN      BOKRC1A4,"bokrc1af" 
          OPEN      BOKRC1A2,"bokrc1af" 
          OPEN      BOKRC1A1,"bokrc1af" 
          OPEN      BOKDIAA1,"bokdiaaf"
          OPEN      PATCODE1,"patcodes"
          OPEN      PATCODE2,"patcodes"
          OPEN      PATDSCH1,"patdschf"
          OPEN      PATDSCH2,"patdschf"
          OPEN      PATELGA1,"patelgaf"
          OPEN      PATLOCA1,"patlocaf"
          OPEN      IBAPHON1,"ibaphnaf"
          OPEN      IBAPHON2,"ibaphnaf"
          OPEN      IBAPHON3,"ibaphnaf"
          OPEN      IBAPHON4,"ibaphnaf"
          OPEN      IBAPHON5,"ibaphnaf"
          OPEN      OPRDETA2,"oprdetaf"
          OPEN      OPRSESA1,"oprsesaf"
          OPEN      OBSPCTA1,"obspctaf"
          OPEN      RCPDTEA6,"rcpdteaf"
          OPEN      RCPBNKA1,"rcpbnkaf"
          OPEN      PATTRAN2,"pattranf"
.
          OPEN      VISCMTA1,"viscmtaf"     * Visit Comments Table
          OPEN      VISINTA1,"visintaf"
          OPEN      VISINTA2,"visintaf"
          OPEN      VISIAUA1,"visiauaf"
          OPEN      VISIAUA2,"visiauaf"
.
          MOVE      "out",CFILEPRE       * Save Current File Prefix
          CALL      OPNOUT00             * Open Outpatient Files
.
          MOVE      ZERO,NOLEAVRG
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMSLRDA1,"pmslrdaf"
          IF        OVRCD=1
            MOVE      ONE,NOLEAVRG
          ELSE
            OPEN      PMSLRDA4,"pmslrdaf"
          ENDIF
.
          OPEN      ALLREFA1,"allrefaf"
          OPEN      CATCOMA1,"catcomaf"
          OPEN      EMRVISA1,"emrvisaf"
          OPEN      EMRVISA3,"emrvisaf"
          OPEN      PMSNUTA1,"pmsnutaf"
          OPEN      PMSWTRA1,"pmswtraf"
          OPEN      PMSMORA1,"pmsmoraf"
          OPEN      PMSMORA2,"pmsmoraf"
          OPEN      WATMESA1,"watmesaf"
.
          OPEN      EOCLNKA3,"eoclnkaf"  * Episode of Care linkage 
          OPEN      EOCREFA1,"eocrefaf"  * Episode of care referral
          OPEN      EOCACCA1,"eocaccaf"  * Episode of care Accident
.
          OPEN      PMSIFTA1,"pmsiftaf"
          OPEN      PMSIFTA3,"pmsiftaf"
.
          OPEN      IBAPDFA1,"ibapdfaf"        * For default printer selection
.
          OPEN      PATRGMA1,"patrgmaf"
          OPEN      PMSREGA1,"pmsregaf"
.
          CALL      INTMAS00
.
.---------V9.00.B01----------------------------------------------------        
.
          OPEN      PMSVX1A1,"pmsvx1af"
          OPEN      BOKRX1A1,"bokrx1af"
          OPEN      BOKRX1A2,"bokrx1af"                         *T0870496
          OPEN      PATMI1A6,"patmi1af"
          OPEN      IBATMHA1,"ibatmhaf"
.
          OPEN      CONTROLF,"controlf"
          READ      CONTROLF,THIRTY7;*241,WTCNUSBC
          READ      CONTROLF,EIGHTY;*250,PTCNHDPS
          READ      CONTROLF,FORTY2;*240,OPCNDORD
          READ      CONTROLF,ZERO;*43,IBCNMHOS        * Multi Hosp Indicator
          READ      CONTROLF,HUND05;*216,PTCNDWAW
          READ      CONTROLF,HUND14;*137,PTCNBBAP
          READ      CONTROLF,TWENTY1;*45,PTCNDRSM
          READ      CONTROLF,HUND19;*182,PTCNEPIS
          READ      CONTROLF,HUND20;*132,PTCNUNDW,*137,PTCNHEFR:
                                    *142,PTCNHETO,*147,PTCNOVRW,*152,PTCNOBES:
                                    *243,PTCNSMSN
          READ      CONTROLF,HUND23;*209,PTCNUTOM,*210,PTCNUESD
          READ      CONTROLF,HUND25;*171,PTCNUDF1
          READ      CONTROLF,HUND29;*61,PTCNWSIN,*71,PTCNOECW,*72,PTCNOECE
          READ      CONTROLF,HUND28;*230,PTCNALTV
.
          MATCH     "1",PTCNSMSN
          IF        @EQUAL
            OPEN      PMSSMHA5,"pmssmhaf"
            OPEN      PMSSRRA1,"pmssrraf"
            OPEN      PMSSRMA2,"pmssrmaf"
          ENDIF
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
          ENDIF
.
          READ      CONTROLF,HUND12;*104,PTCNWBDS
          MOVE      PTCNWBDS,WBEDDESC            * CAR 151896
.
          COMPARE   ONE,PTCNHDPS            * NZ tables               *I-174484
          IF        @EQUAL
            OPEN      NZPSPRA1,"nzpspraf"   * NZ Priv Subseq't Proc/Funder Det
          ENDIF
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,COMFILNM
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,CMMFILNM
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,VENTMPFN       * Assign to Ventilation temp file
.
          CALL      GETTZ000
.
          MOVE      ONE,OECWINDC
          MATCH     "1",PTCNOECW
          IF         @EQUAL
.
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            OPEN      WEBOECA1,"weboecaf"
            TRAPCLR   IO
            IF        OVRCD=1
              MOVE      ZERO,OECWINDC
            ENDIF
.
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            OPEN      WEBELFA1,"webelfaf"
            TRAPCLR   IO
            IF        OVRCD=1
              MOVE      ZERO,OECWINDC
            ENDIF
.
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            OPEN      WEBELFA2,"webelfaf"
            TRAPCLR   IO
            IF        OVRCD=1
              MOVE      ZERO,OECWINDC
            ENDIF
.
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            OPEN      WEBELFA3,"webelfaf"
            TRAPCLR   IO
            IF        OVRCD=1
              MOVE      ZERO,OECWINDC
            ENDIF
.
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            OPEN      WEBELFA4,"webelfaf"
            TRAPCLR   IO
            IF        OVRCD=1
              MOVE      ZERO,OECWINDC
            ENDIF
.
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            OPEN      WEBEEHA2,"webeehaf"
            TRAPCLR   IO
            IF        OVRCD=1
              MOVE      ZERO,OECWINDC
            ENDIF
.
          ENDIF
.
          MOVE      THIRTY,PTCNOLDR
.
INIT9999  RETURN
.------------------------------------------------------------
. Get Time Zone
.------------------------------------------------------------
GETTZ000  MOVE      ZERO,OVRCD
          MOVE      "+0000",KEY5
          TRAP      OVERCOND IF IO
          OPEN      TZFILE,"timezone"
          TRAPCLR   IO
          IF        OVRCD=0
            READ      TZFILE,SEQ;KEY5
          ELSE
            EXECUTE   "date +#"%z#">timezone.txt",TASKID
            TRAP      OVERCOND IF IO
            OPEN      TZFILE,"timezone"
            TRAPCLR   IO
            IF        OVRCD=0
              READ      TZFILE,SEQ;KEY5
            ENDIF
          ENDIF
          CLOSE     TZFILE
          UNPACK    KEY5,KEY3,KEY2
          PACK      TIMEZONE,KEY3,COLON,KEY2
          RETURN
.
.*******************************************************************************
. OUTFIL00 - Check if the user id has an outpatienty site. If they do open
.            the correct outpatient files according to the site. If they do not
.            have a site make sure the default prefix of out is is used to
.            open the files.
.*******************************************************************************
OUTFIL00  MATCH     SP70,WBSESIT             * Does the user have a site
          GOTO      OUTFIL50 IF NOT EQUAL
.
OUTFIL10  MATCH     "out",CFILEPRE           * Is out currently open
          IF        !@EQUAL
            MOVE      "out",OSTFILE          * open default prefix of out
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open out Outpatient Files
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      OUTFIL99
.
OUTFIL50  MOVE      WBSESIT,KEY6
          CALL      RDSITA1
          BRANCH    OVRCD,OUTFIL90           * error invalid site code
.
          MATCH     OSTFILE,CFILEPRE         * Save Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open prefixed Outpatient Files
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      OUTFIL99
.
OUTFIL90  MOVE      "Outpatient Site Invalid",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
OUTFIL99  RETURN
.------------------------------------------------------------
. Open Outpateint Files
.------------------------------------------------------------
OPNOUT00  PACK      CFNAME,CFILEPRE,FILBOKA1  * Get the name
          CLOSE     OUTBOKA1
          OPEN      OUTBOKA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILBOKA6  * Get the name
          CLOSE     OUTBOKA6
          OPEN      OUTBOKA6,CFNAME
.
          PACK      CFNAME,CFILEPRE,FILCLIA1  * Get the name
          CLOSE     OUTCLIA1
          OPEN      OUTCLIA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILCTYA1  * Get the name
          CLOSE     OUTCTYA1
          OPEN      OUTCTYA1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILDIAG1  * Get the name 
          CLOSE     OUTDIAG1
          OPEN      OUTDIAG1,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILMA1A1
          CLOSE     OUTMA1A1
          CALL      OPOTMA11                * Open the file
          CLOSE     OUTMA1A2
          CALL      OPOTMA12                * Open the file
.
          PACK      CFNAME,CFILEPRE,FILBB1A1
          CLOSE     OUTBB1A1
          CALL      OPOTBB11               * Open the file
.
          PACK      CFNAME,CFILEPRE,FILLHIA1
          CLOSE     OUTLHIA1
          OPEN      OUTLHIA1,CFNAME       * outpatients letter file
.
          OPEN      OUTLETR1,"outletrf"
.
          OPEN      OUTPREA1,"outpreaf"    
.
          PACK      CFNAME,CFILEPRE,FILCANA1
          RESET     CFNAME,3
          APPEND    FILCANA1,CFNAME
          RESET     CFNAME
          CLOSE     OUTCANA1
          OPEN      OUTCANA1,CFNAME
.
OPNOUT99  RETURN
.------------------------------------------------------------
. Clear Parameters
.------------------------------------------------------------
CLRPAR00  MOVE      ZERO,REPORTNO
          MOVE      ZERO,ONLCOUNT
          MOVE      ZERO,TOTCOUNT
          MOVE      SP70,ADMISSNO
          MOVE      SP70,URNUMBER
          MOVE      SP70,BKREC009
          MOVE      SP70,TEMPLATE
          MOVE      SP70,FRSTDATE
          MOVE      SP70,LASTDATE
          MOVE      SP70,VIEWTYPE
          MOVE      ZERO,DEFTVIEW
          MOVE      SP70,VYEARMTH
          MOVE      SP70,KEYWORDS
          MOVE      SP70,LEAVEREG
          MOVE      SP70,LEAVCARE
          MOVE      Z70,LEAVWARD
          MOVE      SP70,LEAVRISK
          MOVE      SP70,LEAVSTAT
          MOVE      ZERO,PRIVACYO
          PACK      REDIRECT,SP70,SP70,SP70,SP70
          MOVE      ZERO,NEXTPAGE
          MOVE      ZERO,STARTNUM
          MOVE      ZERO,NORECORD
          MOVE      SP70,SRCHDEPT
          MOVE      SP70,SRCHSURN
          MOVE      SP70,SRCHGIVN
          MOVE      SP70,SRCHEXTN
          MOVE      SP70,SRCHTITL
          MOVE      SP70,SRCHCODE
          MOVE      ZERO,SRCHTYPE
          MOVE      ZERO,MEDLBOOK
          MOVE      SP70,CLAIMTYP
          MOVE      SP70,CLAIMCOD
          MOVE      SP70,UNITCODE
          MOVE      SP70,WARDCODE
          MOVE      SP70,FILTWARD
          MOVE      SP70,TYPECODE
          MOVE      SP70,PATTYPES
          MOVE      SP70,ADMSOURC
.
          MOVE      SP70,SCHDPRN1
          MOVE      SP70,SCHDPRN2
          MOVE      SP70,SCHDPRN3
          MOVE      SP70,LABELTYP
          MOVE      SP70,STATNCO1
          MOVE      SP70,STATNCO2
          MOVE      SP70,SCHDCOP1
          MOVE      SP70,SCHDCOP2
          MOVE      SP70,SCHDCOP3
.
          MOVE      SP70,SSCHDPR1
          MOVE      SP70,SSCHDPR2
          MOVE      SP70,SSCHDPR3
          MOVE      SP70,SLABELTY
          MOVE      SP70,SSTATNC1
          MOVE      SP70,SSTATNC2
.
          MOVE      SP70,UPDTTYPE
          MOVE      SP70,NOBOKMOD
          MOVE      SP70,WATTR001
          MOVE      SP70,WATCOUNT
          MOVE      SP70,OUTALFLG
          MOVE      SP70,FLAGS001
          CALL      CVPMI000                * Clear PMI vars
          MOVE      ZERO,FLTVISTY           * for language 1
          MOVE      SP70,FLTRECTY           * for language 1
          MOVE      SP70,PREFLANG           * for language 1
          MOVE      SP70,PMPGI002           * for language 1
          MOVE      SP70,PMPGI003           * for language 2
          MOVE      SP70,PMPGI065           * for nationality
          MOVE      SP70,VSINS001           * Notified
          MOVE      SP70,VSINS002           * Confirmed
          MOVE      SP70,CASEKEYS
          MOVE      Z70,PTMAS008
          MOVE      Z70,PTMAS009
          MOVE      Z70,PTMAS010
          MOVE      Z70,PTMAS011
          MOVE      Z70,PTMAS012
          MOVE      Z70,PTMAS013
          MOVE      SP70,EXDSCFLD
          MOVE      SP70,EXPCTDSC
          MOVE      SP70,EXDSCDTE
          MOVE      SP70,GOBTFORM
          MOVE      SP70,LOCATION
          MOVE      SP70,CLINID                                        *I-46977
          MOVE      ZERO,FILTFLAG
          MOVE      SP70,FILTHOSP
          MOVE      SP70,FILTBOOK
          MOVE      SP70,FILTFUND
          MOVE      SP70,REQUSTAT
          MOVE      ZERO,HOSPCOMP
          MOVE      SP70,DOSASTAT
          MOVE      SP70,SURGEON
          MOVE      ZERO,SHOWCANC
          MOVE      ZEROVISN,MULTADMN
          MOVE      ZERO,LNK2PRT
          MOVE      SP70,FILTSTAY
          MOVE      ZERO,FILTOWRD
          MOVE      SP70,FILTPWRD
          MOVE      SP70,FILBCRDT                          *T0870496 
          MOVE      ZERO,DFDTVIEW                          *T0870496 
          MOVE      ZERO,BOOKCRDT                          *T0870496 
          MOVE      SP70,HEALTHFN
          MOVE      SP70,WLCATEGY
          MOVE      SP70,PACAFLAG
          MOVE      SP70,PHISFLAG
          MOVE      SP70,OVERDATE
          MOVE      SP70,WLWMPTY
          MOVE      SP70,WLRFCDAY
          MOVE      SP70,WLHIP
          MOVE      ZERO,PTSTATUS
          MOVE      "Z",CHKCOMPL
.
          CALL      CPPMIF00
.
          MOVE      ONE,OECCOUNT
          WHILE     OECCOUNT <= 99
            MOVE      SP70,OECRECKY[OECCOUNT]
            ADD       ONE,OECCOUNT
          DO
          MOVE      ZERO,OECCOUNT
.
          MOVE      ZERO,OECRPRNT
          MOVE      SP70,SELPRINT
          MOVE      SP70,STARTLST
          MOVE      SP70,ENDOFLST
          MOVE      ZERO,DEFTFLAG
.
          MOVE      ZERO,FHRSUBIN
          MOVE      ZERO,FHRLOCIN
          MOVE      ZERO,FHRPARIN

          CALL      CPMOC000                * pmsoecaf
.
.---------V9.00.B01----------------------------------------------------        
.
          MOVE      SP70,ADPOINTS 
.
          CALL      CPBKRX00
          CALL      CLRATR00
          CALL      CLPATMAS
          CALL      CLPMSPX2
          CALL      CLPATMIS
          CALL      CLPATATR
.
          CALL      CPMORG00
.
          MOVE      SP70,CHECKALL
          MOVE      SP70,CHALDIET
          MOVE      SP70,BKTYPCOL
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          MOVE      ONE,F3
          WHILE     F3 <= 100
            MOVE      SP70,PRIFC[F3]
            ADD       ONE,F3
          DO
.
          MOVE      SP70,AUDITTYP
          MOVE      SP70,ACCTYREC
          MOVE      SP70,FILTSTAT
          MOVE      SP70,CLAIMSTA
          MOVE      SP70,CLAIMNUM
          MOVE      SP70,SUPERLEV
          MOVE      ZERO,SHOWFLAG
.
CLRPAR99  RETURN
+
.------------------------------------------------------------
. Set Parameters
.------------------------------------------------------------
SETPAR00  MATCH     "pacaflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PACAFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "phisflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PHISFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "viewtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VIEWTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "deftview=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DEFTVIEW
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nextpage=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTPAGE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "redirect=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REDIRECT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "privacyo=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRIVACYO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "frstdate=",QRYNAME 
          IF        @EQUAL
            MOVE      QRYDATA,FRSTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "leavward=",QRYNAME 
          IF        @EQUAL
            PACK      LEAVWARD,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "leavrisk=",QRYNAME 
          IF        @EQUAL
            PACK      LEAVRISK,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "leavstat=",QRYNAME 
          IF        @EQUAL
            PACK      LEAVSTAT,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "leavereg=",QRYNAME 
          IF        @EQUAL
            PACK      LEAVEREG,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "leavcare=",QRYNAME 
          IF        @EQUAL
            PACK      LEAVCARE,QRYDATA,SP70 
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "bkrec009=",QRYNAME 
          IF        @EQUAL
            MOVE      QRYDATA,BKREC009
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "lastdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LASTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "vyearmth=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VYEARMTH
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "keywords=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,KEYWORDS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startnum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTNUM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "norecord=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NORECORD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nextpage=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTPAGE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "urnumber=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,URNUMBER
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admissno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMISSNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "medlbook=",QRYNAME
          IF        @EQUAL
            MOVE       QRYDATA,MEDLBOOK
            GOTO       SETPAR99
          ENDIF
.
          MATCH     "srchdept=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SRCHDEPT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchsurn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SRCHSURN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchgivn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SRCHGIVN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchextn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SRCHEXTN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchtitl=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SRCHTITL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchtype=",QRYNAME
          IF        @EQUAL
            SQUEEZE   QRYDATA
            MOVE      QRYDATA,SRCHTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SRCHCODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "unitcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UNITCODE
            PACK      UNITCODE,UNITCODE,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtstay=",QRYNAME
          IF        @EQUAL
            PACK      FILTSTAY,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtowrd=",QRYNAME
          IF        @EQUAL
            PACK      FILTOWRD,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtpwrd=",QRYNAME
          IF        @EQUAL
            PACK      FILTPWRD,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILTFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filthosp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILTHOSP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtbook=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILTBOOK
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtfund=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILTFUND
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filbcrdt=",QRYNAME                    *T0870496
          IF        @EQUAL
            PACK      FILBCRDT,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dfdtview=",QRYNAME                    *T0870496
          IF        @EQUAL
            PACK      DFDTVIEW,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "wardcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,WARDCODE
            PACK      WARDCODE,WARDCODE,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtward=",QRYNAME
          IF        @EQUAL
            PACK      FILTWARD,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "surgeon1=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SURGEON
            PACK      SURGEON,SURGEON,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "typecode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TYPECODE
            PACK      TYPECODE,TYPECODE,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "claimtyp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CLAIMTYP
            PACK      CLAIMTYP,CLAIMTYP,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "claimcod=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CLAIMCOD
            PACK      CLAIMCOD,CLAIMCOD,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admsourc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMSOURC
            PACK      ADMSOURC,ADMSOURC,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pattypes=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PATTYPES
            PACK      PATTYPES,PATTYPES,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "healthfn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,HEALTHFN
            PACK      HEALTHFN,HEALTHFN,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "wlcategy=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,WLCATEGY
            PACK      WLCATEGY,WLCATEGY,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "chkcompl=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CHKCOMPL
            PACK      CHKCOMPL,CHKCOMPL,SP70
            GOTO      SETPAR99
          ENDIF
.---------V9.00.B01----------------------------------------------------        
.
          MATCH     "adpoints=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADPOINTS
            PACK      ADPOINTS,ADPOINTS,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "schdprn1=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SCHDPRN1
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "schdprn2=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SCHDPRN2
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "schdprn3=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SCHDPRN3
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "labeltyp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LABELTYP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "statnco1=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STATNCO1
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "statnco2=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STATNCO2
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "sschdpr1=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SSCHDPR1
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "sschdpr2=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SSCHDPR2
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "sschdpr3=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SSCHDPR3
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "slabelty=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SLABELTY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "sstatnc1=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SSTATNC1
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "sstatnc2=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SSTATNC2
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "schdcop1=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SCHDCOP1
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "schdcop2=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SCHDCOP2
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "schdcop3=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SCHDCOP3
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "preflang=",QRYNAME     * for language 1
          IF        @EQUAL
            PACK      PREFLANG,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fltvisty=",QRYNAME     * for language 1
          IF        @EQUAL
            MOVE      QRYDATA,FLTVISTY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fltrecty=",QRYNAME     * for language 1
          IF        @EQUAL
            PACK      FLTRECTY,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmpgi002=",QRYNAME     * for language 1
          IF        @EQUAL
            PACK      PMPGI002,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmpgi003=",QRYNAME     * for language 2
          IF        @EQUAL
            PACK      PMPGI003,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmpgi065=",QRYNAME     * for nationality
          IF        @EQUAL
            PACK      PMPGI065,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "chngtype=",QRYNAME     * type of change in interpreter aud
          IF        @EQUAL
            MOVE      QRYDATA,CHNGTYPE
            PACK      CHNGTYPE,CHNGTYPE,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updttype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDTTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nobokmod=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NOBOKMOD
            GOTO      SETPAR99
          ENDIF
.

          MATCH     "pmpmi",QRYNAME
          IF        @EQUAL
            CALL      SVPMI000             * Save pmi vars
            COMPARE   ZERO,EXIT
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "ptmas008=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PTMAS008
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "ptmas009=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PTMAS009
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "ptmas010=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PTMAS010
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "ptmas011=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PTMAS011
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "ptmas012=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PTMAS012
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "ptmas013=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PTMAS013
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "urcommnt=",QRYNAME
          IF        @EQUAL
            CALL      GETCOM00              * Read in U/R Comments
          ENDIF
.
          MATCH     "wattr001=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,WATTR001
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "watcount=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,WATCOUNT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "outalflg=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OUTALFLG
            PACK      OUTALFLG,OUTALFLG,SP70
            GOTO      SETPAR99
          ENDIF
.
         MATCH     "flags001=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FLAGS001
            PACK      FLAGS001,FLAGS001,SP70
            GOTO      SETPAR99
          ENDIF 
.
         MATCH     "vsins001=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VSINS001
            PACK      VSINS001,VSINS001,SP70
            GOTO      SETPAR99
          ENDIF
.
         MATCH     "vsins002=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VSINS002
            PACK      VSINS002,VSINS002,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "casekeys=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CASEKEYS
            PACK      CASEKEYS,CASEKEYS,SP70
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "bokrx",QRYNAME
          IF        @EQUAL
            CALL      SPBKRX00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptatr",QRYNAME
          IF        @EQUAL
            CALL      SPTATR00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "wattrcom",QRYNAME
          IF        @EQUAL
            CALL      GETEXT00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmift",QRYNAME
          IF        @EQUAL
            CALL      SPIFT000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "vicmt003",QRYNAME              * For Infection notes
          IF        @EQUAL
            CALL      CLRVCM00           * Create comments temp file
            CALL      SETVCM00
            GOTO      SETPAR99
          ENDIF
.
         MATCH     "icflunit=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ICFLUNIT
            PACK      ICFLUNIT,ICFLUNIT,SP70
            GOTO      SETPAR99
          ENDIF
.
         MATCH     "icflityp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ICFLITYP
            PACK      ICFLITYP,ICFLITYP,SP70
            GOTO      SETPAR99
          ENDIF
.
         MATCH     "icfldoct=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ICFLDOCT
            PACK      ICFLDOCT,ICFLDOCT,SP70
            GOTO      SETPAR99
          ENDIF
.
         MATCH     "icflward=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ICFLWARD
            PACK      ICFLWARD,ICFLWARD,SP70
            GOTO      SETPAR99
          ENDIF
.
.
          MATCH     "gobtform=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,GOBTFORM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmsmr",QRYNAME
          IF        @EQUAL
            CALL      SPMORG00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "requstat=",QRYNAME
          IF        @EQUAL
            PACK      REQUSTAT,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "hospcomp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,HOSPCOMP
            GOTO      SETPAR99
          ENDIF
.
          MATCH      "oecreqno",QRYNAME
          IF         @EQUAL
            COMPARE   "99",OECCOUNT
            GOTO      SETPAR99 IF EQUAL
            ADD       ONE,OECCOUNT
            PACK      OECRECKY[OECCOUNT],QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "oecrprnt=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OECRPRNT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "selprint=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SELPRINT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startlst=",QRYNAME 
          IF        @EQUAL
            MOVE      QRYDATA,STARTLST
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "endoflst=",QRYNAME 
          IF        @EQUAL
            MOVE      QRYDATA,ENDOFLST
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmsoc",QRYNAME
          IF        @EQUAL
            CALL      SPMOC000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "deftflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DEFTFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "showcanc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SHOWCANC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "checkall=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CHECKALL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "chaldiet=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CHALDIET
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "bktypcol=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,BKTYPCOL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fhrsubin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FHRSUBIN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fhrlocin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FHRLOCIN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fhrparin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FHRPARIN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "audittyp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,AUDITTYP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "acctyrec=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ACCTYREC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtstat=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILTSTAT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "claimsta=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CLAIMSTA
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "claimnum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CLAIMNUM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "prifc",QRYNAME
          IF        @EQUAL
            CALL      STIFC000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "superlev=",QRYNAME
          IF        @EQUAL
            PACK      SUPERLEV,QRYDATA,SP70
          ENDIF
.
          MATCH     "showflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SHOWFLAG
          ENDIF
.
          MATCH     "ptstatus=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PTSTATUS
            GOTO      SETPAR99
          ENDIF
.
SETPAR99  RETURN
+
.------------------------------------------------------------
. Set parameters for Print IFC
.------------------------------------------------------------
STIFC000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STIFC999 IF EQUAL
          MOVE      QRYDATA,PRIFC[F3]
STIFC999  RETURN
+
.------------------------------------------------------------
. Output Next Page Based on CGI Parameter nextpage
.------------------------------------------------------------
NXTPAG00  MOVE      ZERO,F1
          MOVE      NEXTPAGE,F1
          BRANCH    F1,NXTPAG10,NXTPAG20,NXTPAG30,NXTPAG40,NXTPAG50,NXTPAG60
.
          CALL      WINCLS00
          GOTO      NXTPAG99
.
NXTPAG10  CALL      RDIREC00
          GOTO      NXTPAG99
.
NXTPAG20  CALL      GOBACK00
          GOTO      NXTPAG99
.
NXTPAG30  CALL      GOBACK00
          GOTO      NXTPAG99
.
NXTPAG40  CALL      GOBACK00
          GOTO      NXTPAG99
.
NXTPAG50  CALL      WINPAR00
          GOTO      NXTPAG99
.
NXTPAG60  CALL      WINPR200
          GOTO      NXTPAG99
.
NXTPAG99  RETURN
.*******************************************************************************
.                Close Window or Frame and Goto New Location
.*******************************************************************************
WINPAR00  CALL      OPENHTML
          BRANCH    EXIT,WINPAR99
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             "src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             "src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#"> ":
                             " if (self.name==#"PopUpFrame#") {":
                             "  redirectParentFrame(#"",REDIRECT,"#"); }":
                             " else if (self.name==#"PopUpFrame1#") {":
                             "  reload2ParentFrame(#"",REDIRECT,"#"); }":
                             " else { ":
                             "  opener.location.href=#"",REDIRECT,"#";":
                             "  self.close(); }":
                             "</script>"
          CALL      CLOSHTML
WINPAR99  RETURN
.*******************************************************************************
.                Close Window or Frame and Goto New Location
.*******************************************************************************
WINPR200  CALL      OPENHTML
          BRANCH    EXIT,WINPR299
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             "src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             "src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#"> ":
                             " if (self.name==#"PopUpFrame#") {":
                             "  reload2ParentFrame(#"",REDIRECT,"#"); }":
                             " else if (self.name==#"PopUpFrame1#") {":
                             "  reload2ParentFrame(#"",REDIRECT,"#"); }":
                             " else { ":
                             "  opener.location.href=#"",REDIRECT,"#";":
                             "  self.close(); }":
                             "}":
                             "</script>"
          CALL      CLOSHTML
WINPR299  RETURN
.-------------------------------------------------------------------------------
.  Goes back x number of pages
.-------------------------------------------------------------------------------
GOBACK00  CALL      OPENHTML
          BRANCH    EXIT,GOBACK99
.
          MOVE      NEXTPAGE,F1
          SUB       TWO,F1
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "    alert(#"",WEBTITLE,"#");":
.                            "    self.close();":
                             "    window.history.go(-",F1,");":
                             "}":
                             "</script>"
          CALL      CLOSHTML
GOBACK99  RETURN
.------------------------------------------------------------
. Current Admissions by Code eg Religion, 
.------------------------------------------------------------
CURADM00  MOVE      "Current Inpatients",WEBTITLE
          MATCH     "135",TEMPLATE
          IF        @EQUAL
            MOVE      "Leave Register Management List",WEBTITLE
          ENDIF
          MATCH     "136",TEMPLATE
          IF        @EQUAL
            MOVE      "Leave Register History List",WEBTITLE
            MATCH     SP70,LASTDATE
            IF        @EQUAL
.             CALL       IBACLOCK        * default to yesterdays leave history
.             CALL       DMYCON
.             SUB        ONE,JULDAY
.             MOVE       JULDAY,JWKDAY
.             MOVE       JULYR,JWKYER
.             MOVE       JULCC,JWKCC
.             CALL       JULCON
.             PACK       LASTDATE,CC,YY,MM,DD
.             REP        " 0",LASTDATE
            ENDIF
          ENDIF
          CALL      CURPER00   * Determine Current Period
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.         
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,CURADM99
.
          CALL      WEBBOD00   * Process Web Body
.
          CALL      WEBEND00   * Process End of HTML File
.
CURADM99  RETURN
.------------------------------------------------------------
. Discharges by Date
.------------------------------------------------------------
DSCLST00  MOVE      "Discharged Patient List",WEBTITLE
          CALL      CURPER00   
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,DSCLST99
.
          CALL      WEBBOD00   * Process Web Body
.
          CALL      WEBEND00   * Process End of HTML File
.
DSCLST99  RETURN
.-------------------------------------------------------------
. Heading and Current Date
.---------------------------------------------------------   
HEADER00  COMPARE   "5",REPORTNO
          IF        !@EQUAL
            CALL      CURPER00   
            CALL      CALCDT00   * Calculate Next and Last Period Dates
          ENDIF
.
          MOVE      URNUMBER,DBOKURNO
          MOVE      ADMISSNO,DBOKADMN
.
          CLEAR     WEBTITLE 
          LOAD      NEWTITLE,REPORTNO,TITLE01,TITLE02,TITLE03:
                    TITLE04,TITLE05,TITLE06,TITLE07,TITLE08,TITLE09
          MOVE      NEWTITLE,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,HEADER99
.
          CALL      WEBBOD00   * Process Web Body
.
          CALL      WEBEND00   * Process End of HTML File
.
HEADER99  RETURN
.---------------------------------------------------------------
. Delete Booking if the status is booked
.---------------------------------------------------------------
DELBOK00  PACK      KEY8,ADMISSNO,SP70
          CALL      RLBKREC1                * Read booking file
          BRANCH    OVRCD,DELBOK90,DELBOK92
.
          COMPARE   ZERO,BKRESTAT
          GOTO      DELBOK93 IF NOT EQUAL
.
          MOVE      TWO,BKRESTAT            * Cancel booking
          UNPACK    KEY8,DBKREBOO 
.
          MOVE      BKREC009,BKRECANC
          CALL      UPBKREC1                * Update booking extn file
          CALL      UUBKREC1
.
          PACK      KEY8,BKREBOOK,SP70
          CALL      RDBKRX11                * Read booking extn file
          BRANCH    OVRCD,DELBOK90
.
          CALL      MVBKRX00                * Set extension file fields
          PACK      BKRXLUPD,CCC,CYY,CMM,CDD
          REP       " 0",BKRXLUPD
          CLOCK     TIME,BKRXLUPT
          MOVE      USERID,BKRXWEBU
.         MOVE      SP70,BKRXODTE           * Move spaces to Date
.         MOVE      SP70,BKRXCNDT           * Move spaces to Date
          CALL      UPBKRX11                * Update booking extn file
.
          CALL      DLBMD000
          PROC      BBUP0000                * Bed Board Update
.
          PACK      KEY19,BKREURNO,BKREPROC,BKRECNT,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,DELBOK80
.
          IF        WTCNUSBC = 1
            MOVE      ONE,WMSTAT                   * Unscheduled
          ELSE
            MOVE      NINE,WMSTAT                  * Cancelled Booking
          ENDIF
          MOVE      SP70,WMDATE3            * Removing proposed admission date
          CALL      GENBOKNO                * Get WL Booking Number
          CALL      UPTREA1
          IF        WMSTAT<>9
            CALL      IBACLOCK
            PACK      WTENEVDT,CCC,CYY,CMM,CDD * Write ESIS Intra Episode Record
            REP       " 0",WTENEVDT
            MATCH     WTENEVDT,BKREEDAT
            IF        @LESS
              PACK      WTENEVDT,BKREEDAT
              REP       " 0",WTENEVDT
            ENDIF
            PACK      WTENEVAL,BKRECANC
            MOVE      ANSP,WTENETYP
            MOVE      DBKREBOO,WTENSADI
            CALL      WSAD0000
          ENDIF
.
          CALL      ERVS0000              * Update eReferral
.
          PACK      KEY19,BKREURNO,BKREPROC,BKRECNT,SP70
          CALL      RDWTTX11
          IF        OVRCD=1
            CALL      CLWATTX1
            GOTO      DELBOK70
          ENDIF
.
          MOVE      SP70,WTTXPATM           * Removing proposed admission time
          CALL      UPWTTX11
.          
          CALL      WRCOM000                * Update W/List comments
.
          CALL      WLHIS000
.
DELBOK70  PACK      KEY8,BKREURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,DELBOK80
.
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLRMAS00
          ENDIF
.
          CALL      PMIGTNID              * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TWO,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLIUWL              * HL7 - Update Waiting List Entry
.
DELBOK80  MOVE      ZERO,EXIT
          GOTO      DELBOK99
.
DELBOK90  MOVE      "Invalid booking number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DELBOK99
.
DELBOK92  MOVE      "Booking Number locked",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DELBOK99
.
DELBOK93  MOVE      "Invalid booking status for cancellation",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DELBOK99
.
DELBOK99  CLOSE     CMMFILAF,DELETE
          RETURN
.
WLHIS000  PACK      KEY8,CCC,CYY,CMM,CDD,SP10
          REP       " 0",KEY8
          PACK      KEY31,WMURNO,WMCODE,WMCNT,KEY8,Z70
          CALL      RSWTHIS1
          CALL      RPWTHIS1
          BRANCH    OVRCD,WLHIS100
          PACK      WTHIADTE,SP70
          PACK      WTHIADTE,CCC,CYY,CMM,CDD  * set alteration date
          REP       " 0",WTHIADTE
          MATCH     WMURNO,WTHIURNO
          GOTO      WLHIS100 IF NOT EQUAL
          MATCH     WMCODE,WTHIPROC
          GOTO      WLHIS100 IF NOT EQUAL
          COMPARE   WMCNT,WTHIPCNT
          GOTO      WLHIS100 IF NOT EQUAL
          MATCH     KEY8,WTHIEDAT
          GOTO      WLHIS100 IF NOT EQUAL
          ADD       ONE,WTHIUCNT
          GOTO      WLHIS200
.
WLHIS100  MOVE      WMURNO,WTHIURNO
          MOVE      WMCODE,WTHIPROC
          MOVE      WMCNT,WTHIPCNT
          PACK      WTHIEDAT,CCC,CYY,CMM,CDD,SP10
          REP       " 0",WTHIEDAT
          PACK      WTHIRCDT,SP8
          MOVE      ONE,WTHIUCNT
WLHIS200  MOVE      WBSEUID,WTHIWEBI
          MOVE      CTIMEIS,WTHIETIM
          MOVE      WMPTY,WTHIPRIO
          MOVE      WTWMRANK,WTHIRANK
          MOVE      WTWMDTAD,WTHIDCGV
          MOVE      WMDATE2,WTHIDAT2
          MOVE      WMDATE3,WTHIDAT3
          MOVE      "05",WTHIBSCD
          MOVE      BKRECANC,WTHIBCAN
          MOVE      BKRXUDF1,WTHIBOKC
          MOVE      WMUNIT,WTHIUNIT
          MOVE      SP70,WTHIPLST
          MOVE      WMSTAT,WTHISTAT
          MOVE      WMDATE1,WTHIDAT1
          MOVE      WTWMDTAD,WTHIDTAD
          MOVE      SP70,WTHICODT
          MOVE      WTWMASSR,WTHIASSR
.
          PACK      KEY31,WTHIURNO,WTHIPROC,WTHIPCNT,WTHIEDAT,WTHIUCNT,SP20
          CALL      RAWTHIS1
          IF        OVRCD=1
            CALL      WRWTHIS1
          ENDIF
          RETURN

.-------------------------------------------------------------
.Interpreter views for inpatient,outpatient and allied health
.-------------------------------------------------------------
INTVIS00  MOVE      "Interpreter List",WEBTITLE
          CALL      CURPER00
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,INTVIS99
.
          CALL      WEBBOD00   * Process Web Body
.
          CALL      WEBEND00   * Process End of HTML File
.
INTVIS99  RETURN
.-------------------------------------------------------------
.         Interpreter Details
.-------------------------------------------------------------
INTDET00  RESET     UPDTTYPE
          MATCH     SP70,UPDTTYPE
          GOTO      INTDET80 IF EQUAL
.
          MATCH     "U",UPDTTYPE
          GOTO      INTDET10 IF EQUAL
.
INTDET10  CALL      UPDINT00
          GOTO      INTDET99
.
INTDET80  PACK      KEY8,ADMISSNO,SP70
          CALL      RDVSINT1
          BRANCH    OVRCD,INTDET91
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,INTDET92
.
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLRMAS00
          ENDIF
.
          CALL      INTRRD00                * reads interpreter details
          CALL      GETPAT00
.
          MOVE      SP70,LPCONDD
          MOVE      SP70,CONDESC
          PACK      KEY88,PTMASNAM,PMPXFNAM,AADMNO
          CALL      RDLOCA1
          IF        OVRCD=0
            CALL      GETCON00
          ENDIF
.
          MOVE      "Interpreter Details",WEBTITLE
          CALL      WEBHED00                * Create Output & Write HTML Header
          BRANCH    EXIT,INTDET99
          CALL      WEBBOD00                * Process Web Body (calls PROFLD00)
          CALL      WEBEND00                * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      INTDET99
.
INTDET91  MOVE      "Can't Find Interpreter Details",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      INTDET99
.
INTDET92  MOVE      "Can't Find Master Record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      INTDET99
.
INTDET99  CLOSE     COMFILAF,DELETE
          RETURN
.-------------------------------------------------------------
.         Read Interpreter Details
.-------------------------------------------------------------
INTRRD00  BRANCH    VSINTYPE,INTRRD99,INTRRD10,INTRRD20,INTRRD30
.
INTRRD10  PACK      KEY28,VSINSUBK,SP70
          CALL      RDBOKA1
          IF        OVRCD=1
            MOVE      SP70,ADATE
            MOVE      SP70,ATIME
          ELSE
            MOVE      OBADATE,ADATE
            MOVE      OBATIME,ATIME
          ENDIF
.
.********  MOVE      "Outpatient",KEY20
          MOVE      "Outpatient",STATUS20

          MOVE      SP70,BKRXCNDT
          MOVE      SP70,AWARD
          MOVE      SP70,PATUNT01            * Unit/department
          MOVE      SP70,PATUNT02            * Unit/department
          MOVE      SP70,BKRECLMT
          MOVE      SP70,CASEKEYS
.
          PACK      KEY8,OBAOUTNO,SP70      * for diagnosis
          CALL      RDDIAG1
          IF        OVRCD=1
            MOVE      SP70,ADIAG1
            MOVE      SP70,ADIAG2
          ELSE
            MOVE      OPDIDESC,ADIAG1
            MOVE      OPDIDES2,ADIAG2
          ENDIF
.
          CALL      RDBOKB1
          IF        OVRCD=0
            MOVE      "CL",CATEGORY           * Claim code Description
            MOVE      OBACOMP,CODE
            CALL      GETCOD00
            MOVE      TDESC,CLAIMDES
          ELSE
            MOVE      SP70,CLAIMDES
          ENDIF
.          
          MOVE      SP70,CLINID             *get Clinic id             *I-46977
.
          PACK      KEY20,OBASITE,OBACLIN,OBADATE,SP70
          CALL      RDCLIA1
          IF        OVRCD=1
            PACK      KEY20,OBASITE,OBACLIN,OBADATE,Z70
            CALL      RDSCLIA1          * Read Clinic Record
            CALL      RDPCLIA1          * Read Clinic Record
            BRANCH    OVRCD,INTRRD99
.
            MATCH     OBASITE,OCASITE
            GOTO      INTRRD99 IF NOT EQUAL
.
            MATCH     OBACLIN,OCACLIN
            GOTO      INTRRD99 IF NOT EQUAL
          ENDIF
.
          MOVE      OCADESC,CLINID
          GOTO      INTRRD99
.
INTRRD20  PACK      KEY8,ADMISSNO,SP70
          CALL      RDBKREC1
          IF        OVRCD=1
            GOTO      INTRRD21             
          ELSE
            COMPARE   ZERO,BKRESTAT
            GOTO      INTRRD21 IF NOT EQUAL
          ENDIF
.
.********  MOVE      "Expected Admission",KEY20
          MOVE      "Expected Admission",STATUS20
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDBKRX11
          IF        OVRCD=1
            MOVE      SP70,BKRXCNDT         * Confirmation date
          ENDIF
.
          PACK      KEY18,BKREBOOK,SP70      * Read the diagnosis file
          CALL      RSBKDIA1
          CALL      RKBKDIA1
          IF        OVRCD=0
            MATCH     BKREBOOK,BKDIBOOK
            IF        @EQUAL
              MOVE      BKDIDES1,ADIAG1
              MOVE      BKDIDES2,ADIAG2
            ENDIF
          ENDIF
.
          MOVE      BKREWARD,AWARD          * For Ward
.
          MOVE      "AC",CATEGORY           * Unit Description
          MOVE      BKREDEPT,PATUNT02
          MOVE      BKREDEPT,CODE
          CALL      GETCOD00
          MOVE      TDESC,PATUNT01
.
          MOVE      "CL",CATEGORY           * Claim code Description
          MOVE      BKRECLMT,CODE
          CALL      GETCOD00
          MOVE      TDESC,CLAIMDES
.
          GOTO      INTRRD99
.
INTRRD21  CALL      RDMISS1
          BRANCH    OVRCD,INTRRD99
.
          COMPARE   ONE,ASTAT
          IF        @EQUAL
.********    MOVE      "Expected Admission",KEY20
            MOVE      "Expected Admission",STATUS20
            MOVE      PTMIXWRD,AWARD
            MOVE      SP70,CASEKEYS
            MOVE      SP70,BKRXCNDT
            GOTO      INTRRD22         
          ENDIF
.
          COMPARE   TWO,ASTAT 
          IF        @EQUAL
.********    MOVE      "Current Admission",KEY20
            MOVE      "Current Admission",STATUS20
            MOVE      SP70,CASEKEYS
            MOVE      SP70,BKRXCNDT
          ELSE
.********    MOVE      SP70,KEY20 
            MOVE      SP70,STATUS20
            MOVE      SP70,PATUNT01
            MOVE      SP70,PATUNT02
            MOVE      SP70,AWARD
            MOVE      SP70,CLAIMDES
            MOVE      SP70,CASEKEYS
            MOVE      SP70,BKRXCNDT
            GOTO      INTRRD99
          ENDIF
.
INTRRD22  MOVE      "AC",CATEGORY           * Unit Description
          MOVE      ACLSSFT,PATUNT02
          MOVE      ACLSSFT,CODE
          CALL      GETCOD00
          MOVE      TDESC,PATUNT01
.
          MOVE      "CL",CATEGORY           * Claim code Description
          MOVE      ACLAIM,CODE
          CALL      GETCOD00
          MOVE      TDESC,CLAIMDES
.
          GOTO      INTRRD99
.
INTRRD30  PACK      KEY8,ADMISSNO,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,INTRRD99
.
.********  MOVE      "Allied Health",KEY20
          MOVE      "Allied Health",STATUS20
          MOVE      ALRERDAT,ADATE
          MOVE      SP70,BKRXCNDT
          MOVE      SP70,ATIME
.
          MOVE      SP70,AWARD
          MOVE      ALREDIA1,ADIAG1
          MOVE      ALREDIA2,ADIAG2
.
          MOVE      "AC",CATEGORY           * Unit Description
          MOVE      ALREUNIT,PATUNT02
          MOVE      ALREUNIT,CODE
          CALL      GETCOD00
          MOVE      TDESC,PATUNT01
.
          MOVE      "CL",CATEGORY           * Claim code Description
          MOVE      ALRECOMP,CODE
          CALL      GETCOD00
          MOVE      TDESC,CLAIMDES
.
          GOTO      INTRRD99
.
INTRRD91 
          GOTO      INTRRD99
.
INTRRD99  RETURN
+
.-------------------------------------------------------------
. UPDINT00 - Update Interpreter Details
. Returns:  EXIT  0 = Ok to continue
.                 1 = Error
.-------------------------------------------------------------
.
UPDINT00  PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,UPDINT91
.
          CALL      RDPMPX21
          BRANCH    OVRCD,UPDINT92
.
          MOVE      PMPXINTR,SVPXINTR                                  *I-40489
          MOVE      PMPXLNG1,SVPXLNG1                                  *I-40489
          MOVE      PMPXLNG2,SVPXLNG2
          MOVE      PMPXLNG3,SVPXLNG3
.
          CALL      CLRMAS00
          CALL      SVMAS000
.
          CALL      CHKLAN00
          BRANCH    EXIT,UPDINT99
.
          CALL      IBACLOCK                * get current date for last updated
          PACK      PCHGDTE,CCC,CYY,CMM,CDD
          REP       " 0",PCHGDTE
.
          CALL      UPMAST1
.
          MOVE      SVPXINTR,PMPXINTR
          MOVE      SVPXLNG1,PMPXLNG1
          MOVE      SVPXLNG2,PMPXLNG2
          MOVE      SVPXLNG3,PMPXLNG3
.
...          CALL      UPPMI000
.
          MATCH     PMPXI001,Z70
            IF        !@EQUAL
              MOVE       PMPXI001,PMPXINTR
          ENDIF
.
          MATCH     PMPXI002,Z70
          IF        !@EQUAL
            MOVE      PMPXI002,PMPXLNG1
          ENDIF
.
          MATCH     PMPXI003,Z70
          IF        !@EQUAL
            MOVE      PMPXI003,PMPXLNG2
          ENDIF
.
          MATCH     PMPXI004,Z70
          IF        !@EQUAL
            MOVE      PMPXI004,PMPXLNG3
          ENDIF
.
          CALL      UPPMI000
.
          CALL      PMIGTNID                * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      ONE,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICUP                * send details to Datagate *C-90223
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDVSINT1
          IF        OVRCD=0
            MOVE      VSINNOTF,SVINNOTF                                *I-40489
            MATCH     SP70,VSINS001
            IF        @EQUAL
              MOVE      "0",VSINNOTF
            ELSE
              MOVE      "1",VSINNOTF
            ENDIF
            MOVE      VSINCONF,SVINCONF                                *I-40489
            MATCH     SP70,VSINS002
            IF        @EQUAL
              MOVE      "0",VSINCONF
            ELSE
              MOVE      "1",VSINCONF
            ENDIF
******************************************** Start of Addition        *I-40489
            MATCH     PMPXINTR,SVPXINTR
            GOTO      UPDINT20 IF NOT EQUAL
            MATCH     PMPXLNG1,SVPXLNG1
            GOTO      UPDINT20 IF NOT EQUAL
            MATCH     PMPXLNG2,SVPXLNG2
            GOTO      UPDINT20 IF NOT EQUAL
            MATCH     PMPXLNG3,SVPXLNG3
            GOTO      UPDINT20 IF NOT EQUAL
            MATCH     VSINNOTF,SVINNOTF
            GOTO      UPDINT20 IF NOT EQUAL
            MATCH     VSINCONF,SVINCONF
            GOTO      UPDINT20 IF NOT EQUAL
            GOTO      UPDINT50              * no Language changes
.
UPDINT20    MATCH     "0",PMPXINTR
            IF        @EQUAL
              CALL      DEVSINT1
              MOVE      "D",INTAUDTY
              CALL      INTAUD00
              GOTO      UPDINT50
            ENDIF
.********************************************   End of Addition        *I-40489
            CALL      UPVSINT1
            MOVE      "C",INTAUDTY                                     *I-40489
            CALL      INTAUD00                                         *I-40489
          ENDIF
.
UPDINT50  MOVE      ZERO,EXIT                             * add label  *C-40489
          GOTO      UPDINT99
.
UPDINT91  MOVE      "Can't Find Master Record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDINT99
.
UPDINT92  MOVE      "Can't Find Master Extension Record",WEBTITLE
          CALL      WEBERR00
UPDINT98  MOVE      ONE,EXIT
          GOTO      UPDINT99
.
UPDINT99  RETURN
+
.******************************************** Start of addition        *I40489
.-------------------------------------------------------------
. Update Interpreter Audit Table
.  Input - INTAUDTY  Audit Type
.-------------------------------------------------------------
INTAUD00  CALL      CLVISIAU
          PACK      VSIACDAT,CCC,CYY,CMM,CDD
          REP       " 0",VSIACDAT
          MOVE      CTIMEIS,VSIACTIM
          MOVE      INTAUDTY,VSIARTYP       * A=add B=before C=after change
.
          MOVE      VSINVISN,VSIAVISN
          MOVE      VSINDATE,VSIADATE
          MOVE      VSINTIME,VSIATIME
          MOVE      VSINTYPE,VSIATYPE
          MOVE      VSINSUBK,VSIASUBK
          MOVE      VSINWUID,VSIAWUID
          MOVE      PMPXLNG1,VSIALNG1
          MOVE      PMPXLNG2,VSIALNG2
          MOVE      PMPXLNG3,VSIALNG3
          MOVE      VSINNOTF,VSIANOTF
          MOVE      VSINCONF,VSIACONF
          PACK      KEY25,VSIACDAT,VSIACTIM,VSIARTYP,VSIAVISN,SP70
          CALL      RAVSIAU1
          IF        OVRCD=0
            CALL      UPVSIAU1
          ELSE
            CALL      WRVSIAU1
          ENDIF
          MOVE      ZERO,EXIT
INTAUD99  RETURN
+
.-------------------------------------------------------------
.         Infection Control
.-------------------------------------------------------------
INFCNT00  RESET     UPDTTYPE
          MATCH     SP70,UPDTTYPE
          GOTO      INFCNT40 IF EQUAL
.
          MATCH     "U",UPDTTYPE
          GOTO      INFCNT10 IF EQUAL
.
INFCNT10  CALL      UPDINF00
          GOTO      INFCNT99
.
INFCNT40  PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,INFCNT91
.
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLRMAS00
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMIFT1                * Read Infection Control file
          IF        OVRCD=1
            CALL      CLPMIF00              * Clear file variables
          ENDIF
.
          MOVE      "Infection Control Details",WEBTITLE
          CALL      WEBHED00                * Create Output & Write HTML Header
          BRANCH    EXIT,INFCNT99
          CALL      WEBBOD00                * Process Web Body (calls PROFLD00)
          CALL      WEBEND00                * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      INFCNT99
.
INFCNT91  MOVE      "Can't Find Master Record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      INFCNT99
.
INFCNT99  RETURN
.
.-------------------------------------------------------------
.         Update Infection Control Details
.-------------------------------------------------------------
UPDINF00  PACK      KEY8,ADMISSNO,SP70
          CALL      RDPTVIS1
          BRANCH    OVRCD,UPDINF91
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPTMIS1
          BRANCH    OVRCD,UPDINF92
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMIFT1                * Read Infection Control file
          IF        OVRCD=1
            CALL      CLPMIF00              * Clear file variables
            CALL      MVPMIF00              * Move CGI vars to file vars
            MOVE      URNUMBER,PMIFURNO
            MOVE      ADMISSNO,PMIFADMN
            MOVE      PVITYPE,PMIFVTYP      * Set Visit Type
            PACK      PMIFCLOC,AWARD,ABED   * Set Patient Location
            MOVE      "H1",PMIFICAT         * Set Category for Infection Type
            CALL      WRPMIFT1
          ELSE
            CALL      MVPMIF00
            CALL      UPPMIFT1
          ENDIF
.
.         Update comments table
.
          PACK      UPDATEKY,ADMISSNO,SP70    * used by UPVCM000
          CALL      UPVCM000
.
          MOVE      ZERO,EXIT
          GOTO      UPDINF99
.
UPDINF91  MOVE      "Can't Find Patient Visit Record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDINF99
.
UPDINF92  MOVE      "Can't Find Patient Admission Record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDINF99
.
UPDINF99  CLOSE     VSCTTFIL,DELETE    * Delete temp file created by CLRVCM00
          RETURN
+
.***********************************************************************
.*        Routine for PRS2 validations (interpreter/language)          *
.***********************************************************************
CHKLAN00  MOVE      ZERO,EXIT
.
          COMPARE   THREE,PTCNHDPS
          GOTO      CHKLAN99 IF NOT EQUAL   * Not in Victoria
.
          MATCH     SP70,PMPXLNG1
          GOTO      CHKLAN99 IF EQUAL
.
          PACK      KEY5,ANSL,ANSA,PMPXLNG1,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CHKLAN99
.
          MATCH     "19",THCSCOD
          GOTO      CHKLAN10 IF NOT EQUAL
.
          MATCH     "0",PMPXINTR
          GOTO      CHKLAN90 IF NOT EQUAL
.
CHKLAN10  MATCH     "98",THCSCOD
          GOTO      CHKLAN99 IF NOT EQUAL
.
          MATCH     SP70,PMPXINTR
          GOTO      CHKLAN95 IF NOT EQUAL
          GOTO      CHKLAN99
.
CHKLAN90  CLEAR     WEBTITLE
          APPEND    "Preferred Language 1 is English, Interpreter ",WEBTITLE
          APPEND    "Required Invalid",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKLAN99
.
CHKLAN95  CLEAR     WEBTITLE
          APPEND    "Preferred Language Not Stated, Interpreter ",WEBTITLE
          APPEND    "Required Invalid",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKLAN99
.
CHKLAN99  RETURN
.
.------------------------------------------------------------
.         Clear PMI and master file vars
.------------------------------------------------------------
CLRMAS00  MOVE      ZERO,PMPXINTR           * Interpreter Reqd.
          MOVE      SP70,PMPXLNG1           * Pref. Language 1
          MOVE      SP70,PMPXLNG2           * Pref. Language 2
          MOVE      SP70,PMPXLNG3           * Pref. Language 3
          PACK      PADD1,SP30,SP30         * address 1
          PACK      PADD2,SP30,SP30         * address 2
          PACK      PSUBRB,SP30,SP30        * address 3
          PACK      PADD4,SP30,SP30         * address 4
          MOVE      SP20,PPOST              * post code
          MOVE      SP20,PTELEP             * Telephone Private
          MOVE      SP20,VSINNOTF           * Notified Indicator
          MOVE      SP20,VSINCONF           * Confirmed Indicator
.
CLRMAS99  RETURN
.------------------------------------------------------------
.         Save cgi vars to file vars for PMI and Master file
.------------------------------------------------------------
SVMAS000  MATCH     PTMAS008,Z70
          IF        !@EQUAL
            MOVE      PTMAS008,PADD1
          ENDIF
.
          MATCH     PTMAS009,Z70
          IF        !@EQUAL
            MOVE      PTMAS009,PADD2
          ENDIF
.
          MATCH     PTMAS010,Z70
          IF        !@EQUAL
            MOVE      PTMAS010,PSUBRB
          ENDIF
.
          MATCH     PTMAS011,Z70
          IF        !@EQUAL
            MOVE      PTMAS011,PADD4
          ENDIF
.
          MATCH     PTMAS012,Z70
          IF        !@EQUAL
            MOVE      PTMAS012,PPOST
          ENDIF
.
          MATCH     PTMAS013,Z70
          IF        !@EQUAL
            MOVE      PTMAS013,PTELEP
          ENDIF
.
          CALL      UPVPMI00                * Saves the PMI vars
.
SVMAS999  RETURN
.------------------------------------------------------------
.   Update PMI Extension details
.------------------------------------------------------------
UPPMI000  MOVE      URNUMBER,PMPXURNO
          MOVE      PMPXURNO,KEY8
          CALL      RAPMPX21
          IF        OVRCD=1
            CALL      WRPMPX21          * write a new record
          ELSE
            CALL      UPPMPX21          * update the record
          ENDIF
UPPMI999  RETURN
.------------------------------------------------------------
. Get U/R Comments
.------------------------------------------------------------
GETCOM00  PREP      COMFILAF,COMFILNM
          MOVE      ONE,F3
          WRITE     COMFILAF,SEQ;QRYDATA
.
GETCOM10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETCOM90 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETCOM80 IF NOT EQUAL
          ADD       ONE,F3
          WRITE     COMFILAF,SEQ;QRYDATA
          GOTO      GETCOM10
.
GETCOM80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETCOM90  MOVE      F3,LASTITEM
          OPEN      COMFILAF,COMFILNM
GETCOM99  RETURN
.-------------------------------------------------------------
.Process Fields From Template Body
.-------------------------------------------------------------
PROFLD00  BRANCH    REPORTNO,PROFLD10,PROFLD20,PROFLD30,PROFLD40,PROFLD50:
                             PROFLD60,PROFLD70,PROFLD80,PROFLD90,PROFL100:
                             PROFL110,PROFL120,PROFL130,PROFL140,PROFL150:
                             PROFL160,PROFL170,PROFL180,PROFL190,PROFL200:
                             PROFL210
.
. Current Admissions
.--------------------
PROFLD10  BRANCH    FLDSETNO,PROFLD11,PROFLD12
          GOTO      PROFLD99
.
PROFLD11  CALL      CPAT0000
          GOTO      PROFLD99
.
PROFLD12  CALL      LVMN0000         * Leave register management
          GOTO      PROFLD99
.
. Discharged Patients by Date Range
.-----------------------------------
PROFLD20  BRANCH    FLDSETNO,PROFLD21
          GOTO      PROFLD99
.
PROFLD21  CALL      PADI0000 
          GOTO      PROFLD99
.
. Patient Admission by Date Range
.---------------------------------
PROFLD30  BRANCH    FLDSETNO,PROFLD31
          GOTO      PROFLD99
.
PROFLD31  CALL      PAAD0000
          GOTO      PROFLD99
.
. Patient Pre-Admission by Date Range
.-------------------------------------
PROFLD40  BRANCH    FLDSETNO,PROFLD41
          GOTO      PROFLD99
.
PROFLD41  CALL      PAPR0000
          GOTO      PROFLD99
.
. Search Internal Phone List         
.-------------------------------------
PROFLD50  BRANCH    FLDSETNO,PROFLD51
          GOTO      PROFLD99
.
PROFLD51  CALL      PHON0000
          GOTO      PROFLD99
.
.Patient Bookings by Date Range
.-------------------------------
PROFLD60  BRANCH    FLDSETNO,PROFLD61
          GOTO      PROFLD99
.
PROFLD61  CALL      PBOK0000
          GOTO      PROFLD99 
.
. Standby Patients
.-------------------------------
PROFLD70  BRANCH    FLDSETNO,PROFLD71
          GOTO      PROFLD99
.
PROFLD71  CALL      PSTB0000
          GOTO      PROFLD99 
.
. OnLeave Patients
.-------------------------------
PROFLD80  BRANCH    FLDSETNO,PROFLD81,PROFLD82
          GOTO      PROFLD99
.
PROFLD81  MOVE      ZERO,MNHLONLV         * I SRF 22732
          CALL      ONLV0000
          GOTO      PROFLD99 
.                                         
PROFLD82  CALL      MHLV0000
          GOTO      PROFLD99              * end I SRF 22732
.
.PROFLD82  MOVE      ONE,MNHLONLV         * Flag for Mental Health On Leave List
.          CALL      ONLV0000             * Display Table
.          GOTO      PROFLD99
.
.PROFLD83  BRANCH    FLDITMNO,PROFLD84   
.          GOTO      PROFLD99
.
.PROFLD84  MOVE      "TL",CATEGORY
.          MOVE      SP70,CODE
.          CALL      CODITM00
.          GOTO      PROFLD99
.
. Pre-Assesments
.-------------------------------
PROFLD90  BRANCH    FLDSETNO,PROFLD91,PROFLD92
          GOTO      PROFLD99
.
PROFLD91  CALL      PASS0000
          GOTO      PROFLD99 
.
PROFLD92  CALL      NMDS0000
          GOTO      PROFLD99
.
PROFL100
          GOTO      PROFLD99
.
PROFL110  BRANCH    FLDSETNO,PROFL111
          GOTO      PROFLD99
.
PROFL111  CALL      IDET0000                * Admissions based on Interpreter
          GOTO      PROFLD99
.
PROFL120  BRANCH    FLDSETNO,PROFL121,PROFL122,PROFL123
          GOTO      PROFLD99           
.
PROFL121  CALL      MASF0000
          GOTO      PROFLD99
.
PROFL122  CALL      PMIX0000
          GOTO      PROFLD99
.
PROFL123  CALL      LDET0000                * Lists Interpreter Details
          GOTO      PROFLD99
.
PROFL130  BRANCH    FLDSETNO,PROFL131,PROFL132,PROFL133
          GOTO      PROFLD99           
.
PROFL131  CALL      MASF0000
          GOTO      PROFLD99
.
PROFL132  CALL      PIFT0000
          GOTO      PROFLD99
.
PROFL133  CALL      MISC0000
          GOTO      PROFLD99
.
PROFL140  BRANCH    FLDSETNO,PROFL141,PROFL142
          GOTO      PROFLD99           
.
PROFL141  CALL      PIFT0000
          GOTO      PROFLD99
.
PROFL142  CALL      MISC0000
          GOTO      PROFLD99
.
PROFL150  BRANCH    FLDSETNO,PROFL151
          GOTO      PROFLD99
.
PROFL151  CALL      INEL0000                * incomplete eligibility
          GOTO      PROFLD99
.
PROFL160  BRANCH    FLDSETNO,PROFL161,PROFL162,PROFL163,PROFL164
          GOTO      PROFLD99
.
PROFL161  CALL      BREC0000                * booking details
          GOTO      PROFLD99
.
PROFL162  CALL      BKRX0000                * booking extension
          GOTO      PROFLD99
.
PROFL163  CALL      LDET0000
          GOTO      PROFLD99
.
PROFL164  CALL      MASF0000
          GOTO      PROFLD99
.
PROFL170  BRANCH    FLDSETNO,PROFL171
          GOTO      PROFLD99
.
PROFL171  CALL      MORG0000                * morgue list
          GOTO      PROFLD99
.
PROFL180  BRANCH    FLDSETNO,PROFL181
          GOTO      PROFLD99
.
PROFL181  CALL      PMMR0000                * morgue details
          GOTO      PROFLD99
.
PROFL190  BRANCH    FLDSETNO,PROFL191,PROFL192,PROFL193
          GOTO      PROFLD99
.
PROFL191  CALL      BERL0000                * bulk eligibility request
          GOTO      PROFLD99
.
PROFL192  CALL      PMOC0000                * eligibility request tags
          GOTO      PROFLD99
.
PROFL193  CALL      PBOK0000
          GOTO      PROFLD99
.
PROFL200  BRANCH    FLDSETNO,PROFL201,PROFL202
          GOTO      PROFLD99
.
PROFL201  CALL      ACCT0000                * ACC List tags
          GOTO      PROFLD99
.
PROFL202  CALL      MASF0000 
          GOTO      PROFLD99
.
PROFL210  BRANCH    FLDSETNO,PROFL211,PROFL212
          GOTO      PROFLD99
.
PROFL211  CALL      MASF0000
          GOTO      PROFLD99
.
PROFL212  CALL      PHIS0000                * Pre-assessment History
          GOTO      PROFLD99
.
PROFLD99  RETURN
.
.-------------------------------------------------------------
.     Leave register management                                              
.-------------------------------------------------------------
LVMN0000  BRANCH    FLDITMNO,LVMN0100,LVMN0200,LVMN0300,LVMN0400,LVMN0500:
                             LVMN0600,LVMN0700,LVMN0800,LVMN0900
.
          GOTO      LVMN9999
.
LVMN0100  MATCH     Z70,LEAVWARD
          IF        @EQUAL
            IF        SHOWFLAG=0
              MOVE      WBSEWRD,LEAVWARD    * default to user id ward
            ENDIF
          ENDIF
          PACK      DFLTWARD,LEAVWARD
          CALL      WSEL0000                * Ward selection list
          GOTO      LVMN9999
.
LVMN0200  WRITE     HTMLFILE;SHOWFLAG;
          GOTO      LVMN9999
.
LVMN0300  MOVE      "CC",CATEGORY
          MOVE      LEAVCARE,CODE
          CALL      CODITM00
          GOTO      LVMN9999
.
LVMN0400  MOVE      "vd",CATEGORY
          MOVE      LEAVRISK,CODE
          CALL      CODITM00
          GOTO      LVMN9999
.
LVMN0500  WRITE     HTMLFILE;LEAVSTAT;
          GOTO      LVMN9999
.
LVMN0600  WRITE     HTMLFILE;PRIVACYO;
          GOTO      LVMN9999
.
LVMN0700  WRITE     HTMLFILE;ONLCOUNT;
          GOTO      LVMN9999
.
LVMN0800  WRITE     HTMLFILE;TOTCOUNT;
          GOTO      LVMN9999
.
LVMN0900  WRITE     HTMLFILE;LEAVEREG;
          GOTO      LVMN9999
.
LVMN9999  RETURN
+
.-------------------------------------------------------------
.     Miscellaneous fields                                                   
.-------------------------------------------------------------
.
MISC0000  BRANCH    FLDITMNO,MISC0100,MISC0200,MISC0300,MISC0400,MISC0500
.
          GOTO      MISC9999
.
MISC0100  CALL      VCMHTM00
          GOTO      MISC9999
.
MISC0200  CALL      PREV0000
          GOTO      MISC9999
.
MISC0300  CALL      NEXT0000
          GOTO      MISC9999
.
MISC0400  CALL      SELV0000
          GOTO      MISC9999
.
MISC0500  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      MISC9999
.
MISC9999  RETURN
.
.-------------------------------------------------------------
.     Mental Health On Leave Table and Associated Tags       * I SRF 22732
.-------------------------------------------------------------
MHLV0000  BRANCH    FLDITMNO,MHLV0100,MHLV0200
.
          GOTO      MHLV9999
.
MHLV0100  MOVE      ONE,MNHLONLV         * Flag for Mental Health On Leave List
          CALL      ONLV0000             * Display Table
          GOTO      MHLV9999
.
MHLV0200  MOVE      "TL",CATEGORY        * Selection list for Type of Leave
          MOVE      TYPECODE,CODE
          CALL      TYPSEL00
          GOTO      MHLV9999
.
MHLV9999  RETURN                                             
.------------------------------------------------------------
.     Display Selection List for Type of leave
.------------------------------------------------------------
TYPSEL00  MOVE      SP70,TDESC
          PACK      KEY5,CATEGORY,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      CATEGORY,TCODE
            MOVE      "Invalid Category",TDESC
          ENDIF
          REP       " _",TCODE
          REP       " _",THCSCOD
          WRITE     HTMLFILE;"<!--<cat-c category=#"",TCODE,"#" name=#"",TDESC:
                             "#" map=#"",THCSCOD,"#"></cat-c>-->"
.
          PACK      PTCDKEY2,CATEGORY,SP70
          CALL      RDSCODE2
TYPSEL10  CALL      RDKCODE2
          BRANCH    OVRCD,TYPSEL99
          MATCH     CATEGORY,TCODE
          GOTO      TYPSEL99 IF NOT EQUAL
          MATCH     SP70,ACODE
          GOTO      TYPSEL10 IF EQUAL
          MATCH     "I",PTCOACTV
          GOTO      TYPSEL10 IF EQUAL
          MATCH     SP70,TCINDC1              * Do not list type of leave if
          GOTO      TYPSEL10 IF EQUAL
          PACK      KEY19,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5:
                          TCINDC6,TCINDC7,TCINDC8,TCINDC9,TCINDC10:
                          TCINDC11,THCSCOD,PTCDNHCP
          PACK      KEY24,QUOTE,ACODE,KEY19,QUOTE
          MATCH     CODE,ACODE
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY24," selected>":
                               TDESC,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY24,">",TDESC,"</option>"
          ENDIF
          GOTO      TYPSEL10
TYPSEL99  RETURN                                              * end I SRF 22732
.------------------------------------------------------------
.Admission details based on Interpreter
.------------------------------------------------------------
IDET0000  BRANCH    FLDITMNO,IDET0100,IDET0200,IDET0300,IDET0400,IDET0500:
                             IDET0600,IDET0700,IDET0800,IDET0900,IDET1000:
                             IDET1100,IDET1200,IDET1300,IDET1400,IDET1500:
                             IDET1600,IDET1700,IDET1800,IDET1900,IDET2000:
                             IDET2100,IDET2200,IDET2300,IDET2400,IDET2500:
                             IDET2600,IDET2700,IDET2800
.
          GOTO      IDET9999
.
IDET0100  CALL      NEXT0000
          GOTO      IDET9999
.
IDET0200  CALL      PREV0000
          GOTO      IDET9999
.
IDET0300  CALL      CURSTD00
          GOTO      IDET9999
.
IDET0400  CALL      CUREND00
          GOTO      IDET9999
.
IDET0500  CALL      CURYR000
          GOTO      IDET9999
.
IDET0600  CALL      CURMON00
          GOTO      IDET9999
.
IDET0700  CALL      SELV0000
          GOTO      IDET9999
.
IDET0800  CALL      EXPA0000                *  Admissions(Expected adm and adm)
          GOTO      IDET9999
.
IDET0900  WRITE     HTMLFILE;TEMPLATE;
          GOTO      IDET9999
.
IDET1000  WRITE     HTMLFILE;REPORTNO;
          GOTO      IDET9999
.
IDET1100  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      IDET9999  
.
IDET1200  CALL      CHAD0000                * Admissions based on change type
          GOTO      IDET9999 
.
IDET1300  MOVE      "LA",CATEGORY           * selection list for pref.lang 1
          MOVE      PMPGI002,CODE
          CALL      CODITM00
          GOTO      IDET9999
.
IDET1400  MOVE      "LA",CATEGORY           * selection list for pref.lang 2
          MOVE      PMPGI003,CODE
          CALL      CODITM00
          GOTO      IDET9999
.
IDET1500  CALL      OUTALH00
          GOTO      IDET9999
.
IDET1600  WRITE     HTMLFILE;FLAGS001;
          GOTO      IDET9999
.
IDET1700  WRITE     HTMLFILE;CHNGTYPE;
          GOTO      IDET9999
.
IDET1800  CALL      CHGOUT00
          GOTO      IDET9999
.
IDET1900  WRITE     HTMLFILE;OUTALFLG;
          GOTO      IDET9999
.
IDET2000  CALL      INTTAB00    * Interpretor Table Output
          GOTO      IDET9999
.
IDET2100  MOVE      "LA",CATEGORY           * selection list for pref.lang 1
          MOVE      PREFLANG,CODE
          CALL      CODITM00
          GOTO      IDET9999
.
IDET2200  IF        FLTVISTY=3
            WRITE     HTMLFILE;"<option value=3 selected>Inpatients</option>";
          ELSE
            WRITE     HTMLFILE;"<option value=3>Inpatients</option>";
          ENDIF
          IF        FLTVISTY=2
            WRITE     HTMLFILE;"<option value=2 selected>Outpatients</option>";
          ELSE
            WRITE     HTMLFILE;"<option value=2>Outpatients</option>";
          ENDIF
          IF        FLTVISTY=1
            WRITE     HTMLFILE;"<option value=1 selected>Emergency</option>";
          ELSE
            WRITE     HTMLFILE;"<option value=1>Emergency</option>";
          ENDIF
          GOTO      IDET9999
.
IDET2300  CALL      NXTPER00
          GOTO      IDET9999
.
IDET2400  CALL      PREPER00
          GOTO      IDET9999
.
IDET2500  CALL      INTTAD00
          GOTO      IDET9999
.
IDET2600  CALL      INTATB00
          GOTO      IDET9999
.
IDET2700  MATCH     "A",FLTRECTY
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=A selected>Inpatients</option>";
          ELSE
            WRITE     HTMLFILE;"<option value=A>Add</option>";
          ENDIF
          MATCH     "B",FLTRECTY
          IF        @EQUAL
            WRITE    HTMLFILE;"<option value=B selected>Before Change</option>";
          ELSE
            WRITE     HTMLFILE;"<option value=B>Before Change</option>";
          ENDIF
          MATCH     "C",FLTRECTY
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=C selected>After Change</option>";
          ELSE
            WRITE     HTMLFILE;"<option value=C>After Change</option>";
          ENDIF
          MATCH     "D",FLTRECTY
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=D selected>Deleted</option>";
          ELSE
            WRITE     HTMLFILE;"<option value=D>Deleted</option>";
          ENDIF
          GOTO      IDET9999
.
IDET2800  MOVE      "VA",CATEGORY
          MOVE      PMPGI065,CODE
          CALL      CODITM00
          GOTO      IDET9999
.
IDET9999  RETURN
.------------------------------------------------------------
.         Lists Interpreter Details
.------------------------------------------------------------
LDET0000  BRANCH    FLDITMNO,LDET0100,LDET0200,LDET0300,LDET0400,LDET0500:
                             LDET0600,LDET0700,LDET0800,LDET0900,LDET1000:
                             LDET1100,LDET1200,LDET1300,LDET1400,LDET1500:
                             LDET1600,LDET1700,LDET1800,LDET1900,LDET2000:
                             LDET2100,LDET2200,LDET2300,LDET2400,LDET2500:
                             LDET2600,LDET2700,LDET2800,LDET2900,LDET3000:
                             LDET3100,LDET3200,LDET3300,LDET3400
.
          GOTO      LDET9999
.
LDET0100  CALL      LISHIS00                * Interpreter History table
          GOTO      LDET9999
.
.*LDET0200  WRITE     HTMLFILE;KEY20;
LDET0200  WRITE     HTMLFILE;STATUS20;
          GOTO      LDET9999
.
LDET0300  MATCH     SP70,ADATE
          GOTO      LDET9999 IF EQUAL
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      LDET9999
.
LDET0400  MATCH     SP70,BKRXCNDT
          GOTO      LDET9999 IF EQUAL
          UNPACK    BKRXCNDT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      LDET9999
.
LDET0500  WRITE     HTMLFILE;ADIAG1,ADIAG2,SP1;
          GOTO      LDET9999
.
LDET0600  WRITE     HTMLFILE;AWARD;
          GOTO      LDET9999
.
LDET0700  WRITE     HTMLFILE;PATUNT01
          GOTO      LDET9999 
.
LDET0800  WRITE     HTMLFILE;CLAIMDES
          GOTO      LDET9999
.
LDET0900  MATCH     SP70,ATIME
          GOTO      LDET9999 IF EQUAL
          WRITE     HTMLFILE;ATIME;
          GOTO      LDET9999
.
LDET1000  WRITE     HTMLFILE;CONDESC,SP1,LPCONDD
          GOTO      LDET9999
.
LDET1100  WRITE     HTMLFILE;VSINNOTF;
          GOTO      LDET9999
.
LDET1200  WRITE     HTMLFILE;CASEKEYS;
          GOTO      LDET9999
.
LDET1300  CALL      LETHIS00                * Outpatient Letter history
          GOTO      LDET9999
.
LDET1400  MOVE      NO,YESNO
          MATCH     "1",VSINNOTF
          IF        @EQUAL
            MOVE      YES,YESNO
          ENDIF
          WRITE     HTMLFILE;YESNO;
          GOTO      LDET9999
.
LDET1500  PROC      CHKCCD00
          WRITE     HTMLFILE;EXIT;              * concession card indicator
          GOTO      LDET9999
.
LDET1600  WRITE     HTMLFILE;CLINID;        * Clinic ID                *I-46977
          GOTO      LDET9999                                           *I-46977
.
LDET1700  MOVE      URNUMBER,PURNO
          UNPACK    DIM127,D1,KEY3,DIM127
          MOVE      KEY3,FLDITMNO
          CALL      MASF0000                * Booking U/R Comments 
          GOTO      LDET9999
.
LDET1800  WRITE     HTMLFILE;VSINCONF;
          GOTO      LDET9999
.
LDET1900  MOVE      NO,YESNO
          MATCH     "1",VSINCONF
          IF        @EQUAL
            MOVE      YES,YESNO
          ENDIF
          WRITE     HTMLFILE;YESNO;
          GOTO      LDET9999
.
LDET2000  MATCH     SP70,ADIAG1
          IF        !@EQUAL
            WRITE     HTMLFILE;ADIAG1;     * Reason for Admission
          ENDIF
          GOTO      LDET9999
.
LDET2100  MATCH     SP70,PTELEP
          IF        !@EQUAL
            WRITE     HTMLFILE;PTELEP;     * Home phone
          ENDIF
          GOTO      LDET9999
.
LDET2200  MATCH     SP70,PTELEB
          IF        !@EQUAL
            WRITE     HTMLFILE;PTELEB;     * Work phone
          ENDIF
          GOTO      LDET9999
.
LDET2300  MATCH     SP70,PTMXCELL
          IF        !@EQUAL
            WRITE     HTMLFILE;PTMXCELL    * Mobile phone
          ENDIF
          GOTO      LDET9999
.
LDET2400  MATCH     SP70,BKREEDAT
          IF        !@EQUAL
            UNPACK    BKREEDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP1,ATTEXT,SP1:
                      BKREATIM;
          ENDIF
          GOTO      LDET9999
.
LDET2500  MATCH     SP70,ASRCE
          IF        !@EQUAL
            PACK      KEY5,ANSS,SP1,ASRCE,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              WRITE     HTMLFILE;TDESC;      * Admission Source
            ENDIF
          ENDIF
          GOTO      LDET9999
.
LDET2600  MATCH     SP70,PMPXPMCN
          IF        !@EQUAL
            PACK      KEY5,CATPN,PMPXPMCN,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              WRITE     HTMLFILE;TCINDC1;      * Preferred method contact
            ENDIF
          ENDIF
          GOTO      LDET9999
.
LDET2700  MATCH     SP70,PTARTXT1
          IF        !@EQUAL
            WRITE     HTMLFILE;PTARTXT1;
          ENDIF
          GOTO      LDET9999
.
LDET2800  MATCH     SP70,PTARTXT2
          IF        !@EQUAL
            WRITE     HTMLFILE;PTARTXT2;
          ENDIF
          GOTO      LDET9999
.
LDET2900  MATCH     SP70,PTARTXT3
          IF        !@EQUAL
            WRITE     HTMLFILE;PTARTXT3;
          ENDIF
          GOTO      LDET9999
.
LDET3000  MATCH     SP70,PTARTXT4
          IF        !@EQUAL
            WRITE     HTMLFILE;PTARTXT4;
          ENDIF
          GOTO      LDET9999
.
LDET3100  WRITE     HTMLFILE;PTARDELR;
          GOTO      LDET9999
.
LDET3200  MATCH     "1",PTARDELR
          IF        @EQUAL
            MATCH     SP70,PTARDATE
            GOTO      LDET9999 IF EQUAL
            UNPACK    PTARDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP70
            WRITE     HTMLFILE;KEY11;
          ELSE
            MATCH     SP70,BKRXUDD1
            GOTO      LDET9999 IF EQUAL
            UNPACK    BKRXUDD1,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP70
            WRITE     HTMLFILE;KEY11;
          ENDIF
          GOTO      LDET9999
.
LDET3300  MATCH     "1",PTARDELR
          IF        @EQUAL
            WRITE     HTMLFILE;PTARTIME;
          ELSE
            WRITE     HTMLFILE;BKRXUDT1;
          ENDIF
          GOTO      LDET9999
.
LDET3400  MATCH     "1",PTARDELR
          IF        @EQUAL
            MOVE      "BG",CATEGORY
            MOVE      PTARCOD1,CODE
            CALL      CODITM00
          ELSE
            MOVE      "BG",CATEGORY
            MOVE       BKRXUDF3,CODE
            CALL      CODITM00
          ENDIF
          GOTO      LDET9999
.
LDET9999  RETURN
.
.*****************************************************************************
.*  CHKEID00
.*  Procedure to get an alternate Visit ID
.*  KEY20 - External Visit Number
.*****************************************************************************
          DEFPROC   CHKEID00
.
          INC       IBAALVFD/INC
.
          PACK      KEY20,SP70
          OPEN      IBAALVA1,"ibaalvaf"
.
          MATCH     "0",PTCNALTV
          GOTO      CHKEID99 IF EQUAL
.
          MATCH     "       0",CHKEXTVD
          GOTO      CHKEID99 IF EQUAL
.
          PACK      KEY8,CHKEXTVD,SP70
          CALL      RDIBALV1
          BRANCH    OVRCD,CHKEID99
.
          PACK      KEY20,IBAVAVIS,SP70
          GOTO      CHKEID99
.
          INC       IBAALVIO/INC
          INC       IBAOVRIO/INC
.
CHKEID99  CLEAR     CHKEXTVD
          CLOSE     IBAALVA1
.
          ENDPROC
.
.*****************************************************************************
.*  CHKCCD00
.*  Procedure to check if a patient has a concession card
.*  Exit=0  No concession cards exist
.*      =1  Valid concession card(s) exist
.*      =2  Only expired concession card(s) exist
.*****************************************************************************
          DEFPROC   CHKCCD00
.
          INC       PMSCCDFD/INC
.
          CALL      IBACLOCK                * Get the current date
          PACK      XDATE,CCC,CYY,CMM,CDD
          REP       " 0",XDATE
.
          MOVE      ZERO,EXIT               * default to no ccards
          OPEN      PMSCCDA1,"pmsccdaf"
.
          PACK      KEY19,PURNO,SP70
          CALL      RSPMCCD1           * Read concession card table
CHKCCD10  CALL      RKPMCCD1
          BRANCH    OVRCD,CHKCCD99
.
          MATCH     PURNO,PMCDURNO     * Check same UR
          GOTO      CHKCCD99 IF NOT EQUAL
.
          MATCH     XDATE,PMCDEXDT     * check if exp. date is >= current date
          IF        !@LESS
            MOVE      ONE,EXIT         * valid ccard exists
            GOTO      CHKCCD99
          ENDIF
.
          MOVE      TWO,EXIT           * only expired ccard(s) exist
          GOTO      CHKCCD10
.
          INC       PMSCCDIO/INC
          INC       IBAOVRIO/INC
.
CHKCCD99  CLOSE     PMSCCDA1
.
          ENDPROC
+
.------------------------------------------------------------
. Current Admission
.------------------------------------------------------------
CPAT0000  BRANCH    FLDITMNO,CPAT0100,CPAT0200,CPAT0300,CPAT0400:
                             CPAT0500,CPAT0600,CPAT0700,CPAT0800:
.
.---------V9.00.B01----------------------------------------------------        
.
                             CPAT0900,CPAT1000,CPAT1100,CPAT1200: 
                             CPAT1300,CPAT1400,CPAT1500,CPAT1600: 
                             CPAT1700,CPAT1800,CPAT1900,CPAT2000:
                             CPAT2100,CPAT2200,CPAT2300,CPAT2400:
                             CPAT2500,CPAT2600,CPAT2700,CPAT2800:
                             CPAT2900,CPAT3000
.
CPAT0100  MOVE      ZERO,LNK2PRT
          CALL      TOCA0000
          GOTO      CPAT9999
.
CPAT0200  MOVE      ONE,LNK2PRT
          CALL      TOCA0000
          GOTO      CPAT9999
.
CPAT0300  MOVE      ZERO,LNK2PRT
          CALL      TOPL0000
          GOTO      CPAT9999
.
CPAT0400  MOVE      ONE,LNK2PRT
          CALL      TOPL0000
          GOTO      CPAT9999
.
CPAT0500  MOVE      ZERO,LNK2PRT
          CALL      TOCS0000
          GOTO      CPAT9999
.
CPAT0600  MOVE      ONE,LNK2PRT
          CALL      TOCS0000
          GOTO      CPAT9999
.
.---------V9.00.B01----------------------------------------------------        
.
CPAT0700  MOVE      ONE,TABLEFMT
          MOVE      ZERO,HEAVIEW
          CALL      CABCOD00
          GOTO      CPAT9999
.
CPAT0800  CALL      CABSEL00
          GOTO      CPAT9999
.
CPAT0900  MOVE      TWO,TABLEFMT 
          MOVE      ZERO,HEAVIEW
          CALL      CABCOD00
          GOTO      CPAT9999
.
CPAT1000  CALL      NEXT0000
          GOTO      CPAT9999
.
CPAT1100  CALL      PREV0000
          GOTO      CPAT9999
.
CPAT1200  CALL      CURSTD00
          GOTO      CPAT9999
.
CPAT1300  CALL      CUREND00
          GOTO      CPAT9999
.
CPAT1400  CALL      CURYR000
          GOTO      CPAT9999
.
CPAT1500  CALL      CURMON00
          GOTO      CPAT9999
.
CPAT1600  CALL      SELV0000
          GOTO      CPAT9999
.
CPAT1700  WRITE     HTMLFILE;TEMPLATE;
          GOTO      CPAT9999
.
CPAT1800  WRITE     HTMLFILE;REPORTNO;
          GOTO      CPAT9999
.
CPAT1900  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      CPAT9999
.
CPAT2000  PACK      DFLTWARD,WARDCODE
          WRITE     HTMLFILE;"<option value=#"    #">All</option>"
          CALL      WSEL0000      * Ward Select Options
          GOTO      CPAT9999 
.
CPAT2100  CALL      DOPT0000      * Diet Code Options with all
          GOTO      CPAT9999 
.
CPAT2200  MOVE      THREE,TABLEFMT 
          MOVE      ZERO,HEAVIEW
          CALL      CABCOD00
          GOTO      CPAT9999
.
CPAT2300  MOVE      ONE,TABLEFMT
          MOVE      ONE,MULTADMN
          CALL      CABCOD00
          GOTO      CPAT9999
.
CPAT2400  MATCH     SP70,FILTHOSP
          IF        @EQUAL
            IF        FILTFLAG=0
              MOVE      WBSEHOSP,FILTHOSP
            ENDIF
          ENDIF
          CALL      HSEL0000                * Hospital Selection List
          GOTO      CPAT9999
.
CPAT2500  MOVE      ONE,TABLEFMT
          MOVE      ONE,HEAVIEW
          CALL      CABCOD00
          GOTO      CPAT9999
.
CPAT2600  WRITE     HTMLFILE;CHECKALL;
          GOTO      CPAT9999
.
CPAT2700  WRITE     HTMLFILE;CHALDIET;
          GOTO      CPAT9999
.
CPAT2800  CALL      CAVENT00    * Current patients with Vent.Details (temp file)
.         CALL      CMVENT00              * Current patient with MV
          GOTO      CPAT9999
.
CPAT2900  CALL      LEVL0000    * Leave register details 
          GOTO      CPAT9999
.
CPAT3000  CALL      LEVH0000    * Leave register history
          GOTO      CPAT9999
.
CPAT9999  RETURN
.
.------------------------------------------------------------
.               Rotuine for Diet code selection
.------------------------------------------------------------
DOPT0000  MATCH     "All",SRCHCODE
          IF        @EQUAL
           WRITE  HTMLFILE;"<option value=",QUOTE,"All",QUOTE:
                            "selected>","All","</option>";
          ELSE
            WRITE     HTMLFILE;"<option value=","All",">","All","</option>";
          ENDIF
          MOVE      "DC",CATEGORY           * Selection List of Documents
          MOVE      SRCHCODE,CODE
          CALL      CODITM00
DOPT9999  RETURN
.
.------------------------------------------------------------
.  Outpatient letter history
.------------------------------------------------------------
LETHIS00  PACK      KEY27,URNUMBER,SP70
          CALL      RSOTLHI1
LETHIS10  CALL      RKOTLHI1
          BRANCH    OVRCD,LETHIS99
          MATCH     URNUMBER,OTLHURNO
          GOTO      LETHIS99 IF NOT EQUAL
.
          MOVE      DOTLHLNU,OTLTLTNO
          MOVE      ZERO,OTLTLINO
          PACK      KEY6,OTLTLTNO,OTLTLINO,SP70
          CALL      RDOTLET1
          IF        OVRCD=1
            MOVE      SP70,OTLTTEXT
          ENDIF
.
          PACK      KEY12,OBASITE,OBACTYP,SP70
          CALL      RDCTYA1
          IF        OVRCD=1
            MOVE      SP70,PATUNT01
            MOVE      SP70,PATUNT02
          ELSE
            MOVE      OCTDESC,PATUNT01
          ENDIF
.
          MOVE      SP70,WBSENAM
          MATCH     SP70,OTLHPUID
          IF        !@EQUAL
            PACK      KEY10,OTLHPUID,SP70
            CALL      RDWBSE1
            IF        OVRCD=1
              MOVE      OTLHPUID,WBSENAM
            ENDIF
          ENDIF
          MOVE      SP70,OCADESC
.
          PACK      KEY20,OTLHSITE,OTLHCLIN,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          BRANCH    OVRCD,LETHIS20
.
          MATCH     OTLHSITE,OCASITE
          IF        !@EQUAL
            MOVE      SP70,OCADESC
            GOTO      LETHIS20
          ENDIF
.
          MATCH     OTLHCLIN,OCACLIN
          IF        !@EQUAL
            MOVE      SP70,OCADESC
            GOTO      LETHIS20
          ENDIF
.
LETHIS20  MOVE      OTLHCTIM,DIM5
.
          CLEAR     HTMLLINK
          APPEND    "javascript:UpdateLetter('",HTMLLINK
          APPEND    DOTLHLNU,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",OTLHDATE,"#",":
                             "#"",OTLTTEXT,"#",":
                             "#"",PATUNT01,"#",":
                             "#"",OCADESC,"#",":
                             "#"",DIM5,"#",":
                             "#"",WBSENAM,"#");"
.
          GOTO      LETHIS10          
.
LETHIS99  RETURN
+
.------------------------------------------------------------
. Table of Interpreter Visit Change Audits
.------------------------------------------------------------
INTATB00  PACK      KEY25,FRSTDATE,SP70
          CALL      RSVSIAU1
INTATB10  CALL      RKVSIAU1
          BRANCH    OVRCD,INTATB99
.
          MATCH     VSIACDAT,LASTDATE
          GOTO      INTATB99 IF LESS
.
          MATCH     SP70,FLTRECTY
          IF        !@EQUAL
            MATCH     FLTRECTY,VSIARTYP
            GOTO      INTATB10 IF NOT EQUAL
          ENDIF
          IF        FLTVISTY<>0
            IF        FLTVISTY<>VSIATYPE
              GOTO      INTATB10            * Correct Visit Type NO
            ENDIF
          ENDIF
.
          MOVE      VSIAVISN,KEY8
          CALL      RDVSINT1
          IF        OVRCD=1
.           CALL      CANDET00
            CALL      PROAUD00
            BRANCH    EXIT,INTATB10
          ELSE
            CALL      INTREC00              * Get Details for Patient
            BRANCH    EXIT,INTATB10
          ENDIF
.
          MATCH     SP70,VSIALNG1
          IF        !@EQUAL
            MOVE      "LA",CATEGORY
            MOVE      VSIALNG1,CODE
            CALL      GETCOD00
            MOVE      TDESC,PREFLNG1
.
            MOVE      "LA",CATEGORY
            MOVE      VSIALNG2,CODE
            CALL      GETCOD00
            MOVE      TDESC,PREFLNG2
.
            MOVE      "LA",CATEGORY
            MOVE      VSIALNG3,CODE
            CALL      GETCOD00
            MOVE      TDESC,PREFLNG3
          ENDIF
.
          MATCH     "1",VSIANOTF
          IF        @EQUAL
            MOVE      "Yes",NOTIFIED
          ELSE
            MOVE      "No",NOTIFIED
          ENDIF
.
          MATCH     "1",VSIACONF
          IF        @EQUAL
            MOVE      "Yes",CONFIRMD
          ELSE
            MOVE      "No",CONFIRMD
          ENDIF
.
          CALL      LNGFLT00                * Check Filter
          BRANCH    EXIT,INTATB10
.
          MOVE      VSIADATE,AUORDATE
          MOVE      VSIATIME,AUORTIME
          MOVE      VSIADATE,AUAMDATE
          MOVE      VSIATIME,AUAMTIME
.
          MATCH     "B",VSIARTYP            * Audit Record type of 'Before'?
          IF        @EQUAL
            CALL      RKVSIAU1
            BRANCH    OVRCD,INTATB50
.
            MOVE      VSIADATE,AUAMDATE
            MOVE      VSIATIME,AUAMTIME
            CALL      RPVSIAU1
          ENDIF
.
INTATB50  CALL      AUDROW00                * Output Row
          GOTO      INTATB10
.
INTATB99  RETURN
+
.------------------------------------------------------------
. Process Interpreter Vist Audit record
.------------------------------------------------------------
PROAUD00  MOVE      VSIASUBK,WBSESIT
          CALL      OUTFIL00
          BRANCH    EXIT,PROAUD91
.
          PACK      KEY8,VSIAVISN,SP70
          CALL      RDBOKB1
          IF        OVRCD=1
            CALL      CANDET00              * No session; Cancelled booking?
            BRANCH    EXIT,PROAUD91
            GOTO      PROAUD90
          ENDIF
.
          MOVE      OBADATE,DIM8            * Save outpatient booking date
.
          PACK      KEY28,VSIASUBK,SP70
          CALL      RDBOKA1                 * Get corresponding clinic session
          BRANCH    OVRCD,PROAUD91
.
          MOVE      OBAOUTNO,KEY8
          MATCH     KEY8,VSIAVISN           * Same outpatient visit as audit?
          GOTO      PROAUD10 IF NOT EQUAL   * No; Find patient by other means
          GOTO      PROAUD20                * Got correct outpatient booking
.
PROAUD10  PACK      KEY36,VSIAVISN,SP70     * Find matching clinic session
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,PROAUD91
.
          MOVE      OBAOUTNO,KEY8
          MATCH     KEY8,VSIAVISN
          GOTO      PROAUD91 IF NOT EQUAL
.
          MATCH     OBADATE,DIM8            * Clinic date matches booking date?
          GOTO      PROAUD91 IF NOT EQUAL   * No; can't find matching patient
.
          MOVE      "OP    ",VISITTYP
          MOVE      OBAOUTNO,ADMISSNO
          MOVE      OBAURNO,URNUMBER
.
PROAUD20  PACK      KEY18,OBASITE,OBACLIN,OBADAY,OBASTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,PROAUD91
.
          PACK      KEY8,VSIAVISN,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,PROAUD91
.
          IF        IBCNMHOS=1
            MATCH     WBSEHOSP,PMVXMHOS
            GOTO      PROAUD91 IF NOT EQUAL
          ENDIF
.
          MOVE      OBAURNO,URNUMBER
          CALL      GETPAT00      * Get Patient Details
          CALL      PATLN000      * Format Patient Name with System Paramater
.
PROAUD90  MOVE      ZERO,EXIT
          GOTO      PROAUD99
.
PROAUD91  MOVE      ONE,EXIT
.
PROAUD99  RETURN
+
.------------------------------------------------------------
. Output Table Row - Interpreter Visit Audit
.
.  Input: AUORDATE - Audit Original Date
.         AUORTIME - Audit Original Time
.         AUAMDATE - Audit Amended Date
.         AUAMTIME - Audit Amended Date
.------------------------------------------------------------
AUDROW00  CLEAR     PATLINK
          APPEND    "javascript:LinkTo('",PATLINK
          APPEND    URNUMBER,PATLINK
          APPEND    "','",PATLINK
          APPEND    VSIAVISN,PATLINK
          APPEND    "')",PATLINK
          RESET     PATLINK
          MATCH     "A",VSIARTYP
          IF        @EQUAL
            MOVE      "Add",RECORDTY
          ENDIF
.
          MATCH     "B",VSIARTYP
          IF        @EQUAL
            MOVE      "Before",RECORDTY
          ENDIF
.
          MATCH     "C",VSIARTYP
          IF        @EQUAL
            MOVE      "After",RECORDTY
          ENDIF
.
          MATCH     "D",VSIARTYP
          IF        @EQUAL
            MOVE      "Delete",RECORDTY
          ENDIF
.
          WRITE     HTMLFILE;"t.addRow(#"",PATLINK,"#",":            * 0
                             "#"",URNUMBER,"#",":
                             "#"",VSIAVISN,"#",":
                             "#"",FORMATNM,"#",":
                             "#"",VSIACDAT,VSIACTIM,"#",":
                             "#"",RECORDTY,"#",":                    * 5
                             "#"",AUORDATE,AUORTIME,"#",":
                             "#"",AUAMDATE,AUAMTIME,"#",";
          IF        SUSPFLAG = 1
            WRITE     HTMLFILE;"#"<font color=red>",VISITTYP,"</font>#",";
          ELSE
            WRITE     HTMLFILE;"#"",VISITTYP,"#",";
          ENDIF
.
          CALL      PATFLD00               *Returns KEY3 for folder colour code
.
          WRITE     HTMLFILE;"#"",PREFLNG1,"#",":
                             "#"",PREFLNG2,"#",":                    * 10
                             "#"",PREFLNG3,"#",":
                             "#"",NOTIFIED,"#",":
                             "#"",VSININTP,"#",":
                             "#"",LOCATION,"#",":
                             "#"",OCADESC,"#",":                     * 15
                             "#"",CONDESC,SP1,LPCONDD,"#",":
                             "#"",DIAGDES1,SP1,DIAGDES2,SP1,"#",":
                             "#"",MOTHCOBD,"#",":
                             "#"",FATHCOBD,"#",":
                             "#"",CLAIMDES,"#",":                    * 20
                             "#"",UNITDESC,"#",":
                             "#"",SP1,"#",":
                             "#"",KEY3,"#",":
                             "#"",VSIACDAT,VSIACTIM,VSIARTYP,"#");"  * 24
AUDROW99  RETURN
+
.------------------------------------------------------------
. Output Table Row
.------------------------------------------------------------
CANDET00  PACK      KEY8,VSIAVISN,SP70
          COMPARE   THREE,VSIATYPE
          GOTO      CANDET10 IF NOT EQUAL
.
          CALL      RDMISS1
          BRANCH    OVRCD,CANDET90
          MOVE      DAADMNO,ADMISSNO
          MOVE      AURNO,URNUMBER
          IF        ASTAT=1|ASTAT=5
            MOVE      "Pre Ad",VISITTYP
          ELSE
            MOVE      "IP",VISITTYP
          ENDIF
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,CANDET90
.
          IF        IBCNMHOS=1
            MATCH     WBSEHOSP,PMVXMHOS
            GOTO      CANDET90 IF NOT EQUAL
          ENDIF
.
          GOTO      CANDET20
.
CANDET10  CALL      RDOTCAN1
          BRANCH    OVRCD,CANDET90
.
          MOVE      DOPCNOUT,ADMISSNO
          MOVE      OPCNURNO,URNUMBER
          MOVE      "OP    ",VISITTYP
.
          UNPACK    OPCNDATE,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
.
          PACK      KEY18,OPCNSITE,OPCNCLIN,WEEKDAY,OPCNSTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,CANDET90
.
          IF        IBCNMHOS=1
            MATCH     WBSEHOSP,OTMAHOSP
            GOTO      CANDET90 IF NOT EQUAL
          ENDIF
.
CANDET20  CALL      GETPAT00      * Get Patient Details
          CALL      PATLN000      * Format Patient Name with System Paramater
.
          MOVE      "LA",CATEGORY
          MOVE      PMPXLNG1,CODE
          CALL      GETCOD00
          MOVE      TDESC,PREFLNG1
.
          MOVE      "LA",CATEGORY
          MOVE      PMPXLNG2,CODE
          CALL      GETCOD00
          MOVE      TDESC,PREFLNG2
.
          MOVE      "LA",CATEGORY
          MOVE      PMPXLNG3,CODE
          CALL      GETCOD00
          MOVE      TDESC,PREFLNG3
.
          MOVE      "C ",CATEGORY
          MOVE      PMPXMCNT,CODE
          CALL      GETCOD00
          MOVE      TDESC,MOTHCOBD
.
          MOVE      "C ",CATEGORY
          MOVE      PMPXFCNT,CODE
          CALL      GETCOD00
          MOVE      TDESC,FATHCOBD
.
          MOVE      "CL",CATEGORY
          MOVE      CLAIMCOD,CODE
          CALL      GETCOD00
          MOVE      TDESC,CLAIMDES
.
          MOVE      "AC",CATEGORY          * Unit Description
          MOVE      UNITCODE,CODE
          CALL      GETCOD00
          MOVE      TDESC,UNITDESC
.
          MATCH     "1",VSINNOTF
          IF        @EQUAL
            MOVE      "Yes",NOTIFIED
          ELSE
            MOVE      "No",NOTIFIED
          ENDIF
.
          MATCH     "1",VSINCONF
          IF        @EQUAL
            MOVE      "Yes",CONFIRMD
          ELSE
            MOVE      "No",CONFIRMD
          ENDIF
.
          MOVE      SP70,LPCONDD
          MOVE      SP70,CONDESC
          MOVE      ZERO,TCINDC1
          PACK      KEY88,PTMASNAM,PMPXFNAM,AADMNO
          CALL      RDLOCA1
          IF        OVRCD=0
            CALL      GETCON00
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      CANDET99
.
CANDET90  MOVE      ONE,EXIT
.
CANDET99  RETURN
+
.------------------------------------------------------------
.Table of Current Admission for Interpreter
.------------------------------------------------------------
INTTAD00  PACK      KEY9,TWO,SP70
          CALL      RDSMISS2
INTTAD10  CALL      RDKMISS2
          BRANCH    OVRCD,INTTAD99
          COMPARE   "2",ASTAT
          GOTO      INTTAD99 IF NOT EQUAL
.
          MOVE      AADMNO,KEY8
          CALL      RDVSINT1
          BRANCH    OVRCD,INTTAD10
.
          CALL      INTREC00   * Get Details for Patient
          BRANCH    EXIT,INTTAD10
          CALL      INTFLT00   * Check Filter
          BRANCH    EXIT,INTTAD10
.
          CALL      INTROW00   * Output Row
.
          GOTO      INTTAD10
.
INTTAD99  RETURN
.------------------------------------------------------------
.Table for Interpreter
.------------------------------------------------------------
INTTAB00  PACK      KEY24,FRSTDATE,SP70
          CALL      RSVSINT2
INTTAB10  CALL      RKVSINT2
          BRANCH    OVRCD,INTTAB99
          MATCH     VSINDATE,LASTDATE
          GOTO      INTTAB99 IF LESS
.
          IF        FLTVISTY<>0
            IF        FLTVISTY<>VSINTYPE
              GOTO      INTTAB10             * Correct Visit Type NO
            ENDIF
          ENDIF
.
          CALL      INTREC00   * Get Details for Patient
          BRANCH    EXIT,INTTAB10
          CALL      INTFLT00   * Check Filter
          BRANCH    EXIT,INTTAB10
.
          CALL      INTROW00   * Output Row
.
          GOTO      INTTAB10
.
INTTAB99  RETURN
.------------------------------------------------------------
. Output Table Row
.------------------------------------------------------------
INTROW00
          CLEAR     PATLINK
          APPEND    "javascript:LinkTo('",PATLINK
          APPEND    URNUMBER,PATLINK
          APPEND    "','",PATLINK
          APPEND    VSINVISN,PATLINK
          APPEND    "')",PATLINK
          RESET     PATLINK
          WRITE     HTMLFILE;"t.addRow(#"",PATLINK,"#",":
                             "#"",URNUMBER,"#",":
                             "#"",VSINVISN,"#",":
                             "#"",FORMATNM,"#",":
                             "#"",VSINDATE,VSINTIME,"#",";
.
          IF        SUSPFLAG = 1
            WRITE     HTMLFILE;"#"<font color=red>",VISITTYP,"</font>#",";
          ELSE
            WRITE     HTMLFILE;"#"",VISITTYP,"#",";
          ENDIF
.
          CALL      PATFLD00               *Returns KEY3 for folder colour code
.
          WRITE     HTMLFILE;"#"",PREFLNG1,"#",":
                             "#"",PREFLNG2,"#",":
                             "#"",PREFLNG3,"#",":
                             "#"",NOTIFIED,"#",":
                             "#"",VSININTP,"#",":
                             "#"",LOCATION,"#",":
                             "#"",OCADESC,"#",":
                             "#"",CONDESC,SP1,LPCONDD,"#",":
                             "#"",DIAGDES1,SP1,DIAGDES2,SP1,"#",":
                             "#"",MOTHCOBD,"#",":
                             "#"",FATHCOBD,"#",":
                             "#"",CLAIMDES,"#",":
                             "#"",UNITDESC,"#",":
                             "#"",SP1,"#",":
                             "#"",KEY3,"#",":
                             "#"",CONFIRMD,"#");"          * 21
INTROW99  RETURN
.------------------------------------------------------------
. Get the Interpreter Patient Details
.------------------------------------------------------------
INTREC00  MOVE      SP70,OCADESC
          MOVE      SP70,DIAGDES1
          MOVE      SP70,DIAGDES2
          MOVE      SP70,MOTHCOBD
          MOVE      SP70,FATHCOBD
          MOVE      SP70,CLAIMDES
          MOVE      SP70,CLAIMCOD
          MOVE      SP70,UNITCODE
          MOVE      SP70,UNITDESC
          MOVE      ZERO,SUSPFLAG
          MOVE      VSINVISN,ADMISSNO
          BRANCH    VSINTYPE,INTREC10,INTREC20,INTREC30
          GOTO      INTREC90
. Emergency
INTREC10  MOVE      VSINVISN,KEY8
          CALL      RDEMVIS1
          BRANCH    OVRCD,INTREC90
.
          COMPARE   FOUR,EMVISTAT
          GOTO      INTREC90 IF EQUAL
.
          PACK      KEY8,EMVIADMN,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,INTREC90
.
          IF        IBCNMHOS=1
            MATCH     WBSEHOSP,PMVXMHOS
            GOTO      INTREC90 IF NOT EQUAL
          ENDIF
.
          MOVE      EMVIURNO,URNUMBER
          MOVE      "EM",VISITTYP
          MOVE      "Emergency",LOCATION
          MOVE      EMVICOM1,DIAGDES1
          MOVE      EMVICOM2,DIAGDES2
          MOVE      EMVICOMP,CLAIMCOD
          MOVE      EMVIUNIT,UNITCODE
          GOTO      INTREC80
. Outpatients
INTREC20  MOVE      VSINSUBK,WBSESIT
          CALL      OUTFIL00
          BRANCH    EXIT,INTREC90
.
          PACK      KEY8,VSINVISN,SP70
          CALL      RDBOKB1
          BRANCH    OVRCD,INTREC90
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,INTREC90
.
          IF        IBCNMHOS=1
            MATCH     WBSEHOSP,PMVXMHOS
            GOTO      INTREC90 IF NOT EQUAL
          ENDIF
.
          MOVE      OBACOMP,CLAIMCOD
          MOVE      OTBBDEPT,UNITCODE
.
          PACK      KEY28,VSINSUBK,SP70
          CALL      RDBOKA1
          BRANCH    OVRCD,INTREC90
          MOVE      OBAOUTNO,KEY8
          MATCH     KEY8,VSINVISN
          GOTO      INTREC25 IF EQUAL
.
          PACK      KEY8,VSINVISN,SP70
          CALL      RDPREA1
          BRANCH    OVRCD,INTREC90
          PACK      KEY28,OPRSITE,OPRCLIN,OPRDATE,OPRSTRT,OPRSLOT,SP70
          CALL      RDBOKA1
          BRANCH    OVRCD,INTREC90
          MOVE      OBAOUTNO,KEY8
          MATCH     KEY8,VSINVISN
          GOTO      INTREC90 IF NOT EQUAL
.
INTREC25  MOVE      OBAURNO,URNUMBER
          COMPARE   SIX,OBASTAT
          IF        @EQUAL
            MOVE      ONE,SUSPFLAG          * Display suspended Appointment red
          ENDIF
          MOVE      "OP",VISITTYP
          MATCH     SP70,OBAVISIT           * Do you have a visit type *C-46977
          IF        !@EQUAL
            ENDSET    VISITTYP                                         *C-46977
            APPEND    "-",VISITTYP          * Append booking visit tp  *C-46977
            APPEND    OBAVISIT,VISITTYP                                *C-46977
          ENDIF                                                        *C-46977
          LJUSTIFY  VISITTYP                                           *C-46977
          MOVE      SP70,LOCATION
          PACK      KEY18,OBASITE,OBACLIN,OBADAY,OBASTRT,SP70
          CALL      RDMASA1                 * for location
          BRANCH    OVRCD,INTREC80
          MOVE      OTMACLOC,LOCATION
          MATCH     SP70,LOCATION
          IF        @EQUAL
            MOVE      "CT",CATEGORY
            MOVE      OTMALTYP,CODE
            CALL      GETCOD00
            MOVE      TDESC,LOCATION
          ENDIF
.
          PACK      KEY8,VSINVISN,SP70
          CALL      RDDIAG1
          IF        OVRCD=0
            MOVE      OPDIDESC,DIAGDES1
            MOVE      OPDIDES2,DIAGDES2
          ENDIF
.
          PACK      KEY20,OBASITE,OBACLIN,OBADATE,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          BRANCH    OVRCD,INTREC80
.
          MATCH     OBASITE,OCASITE
          IF        !@EQUAL
            MOVE      SP70,OCADESC
            GOTO      INTREC80
          ENDIF
.
          MATCH     OBACLIN,OCACLIN
          IF        !@EQUAL
            MOVE      SP70,OCADESC
            GOTO      INTREC80
          ENDIF
.
          MATCH     SP70,LOCATION
          IF        @EQUAL
            MOVE      OCADESC,LOCATION
            GOTO      INTREC80
          ENDIF
.
          GOTO      INTREC80
. Inpatient
INTREC30  PACK      KEY8,VSINVISN,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,INTREC35
          MOVE      AURNO,URNUMBER
          IF        ASTAT=1|ASTAT=5
            MOVE      "Pre Ad",VISITTYP
          ELSE
            MOVE      "IP    ",VISITTYP
          ENDIF
          MOVE      ADIAG1,DIAGDES1
          MOVE      ADIAG2,DIAGDES2
          MOVE      ACLAIM,CLAIMCOD
          MOVE      ACLSSFT,UNITCODE
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,INTREC90
.
          IF        IBCNMHOS=1
            MATCH     WBSEHOSP,PMVXMHOS
            GOTO      INTREC90 IF NOT EQUAL
          ENDIF
.
          CALL      GLOC0000
.
          GOTO      INTREC80
.
INTREC35  PACK      KEY8,VSINVISN,SP70
          CALL      RDBKREC1
          BRANCH    OVRCD,INTREC90
          CALL      RDBKRX11
          BRANCH    OVRCD,INTREC90
.
          IF        IBCNMHOS<>1
            GOTO      INTREC40
          ENDIF
.
          MATCH     SP70,BKREWARD
          IF        @EQUAL
            MATCH     SP70,BKRXPOWD
            GOTO      INTREC40 IF EQUAL
          ENDIF
.
          MATCH     SP70,BKREWARD
          IF        @EQUAL
            PACK      KEY6,BKRXPOWD,SP70
          ELSE
            PACK      KEY6,BKREWARD,SP70
          ENDIF
.
          CALL      RDWARD1
          BRANCH    OVRCD,INTREC90
.
          MATCH     WBSEHOSP,PTWDHOSN
          GOTO      INTREC90 IF NOT EQUAL
.
INTREC40  MOVE      BKREURNO,URNUMBER
          IF        BKRESTAT<2
            MOVE      "Pre Ad",VISITTYP
          ELSE
            MOVE      "IP    ",VISITTYP
          ENDIF
          IF        BKRESTAT=0
            MOVE      "Booked",VISITTYP
          ENDIF
          MOVE     SP70,LOCATION
          MATCH    SP70,BKRXADWD
          IF       !@EQUAL
            PACK     KEY6,BKRXADWD
            CALL     RDWARD1
            IF       OVRCD<>1        
              PACK     LOCATION,WBDESC
            ENDIF
          ENDIF
.
          PACK      KEY18,BKREBOOK,SP70
          CALL      RSBKDIA1
          CALL      RKBKDIA1
          IF        OVRCD=0
            MATCH     BKREBOOK,BKDIBOOK
            IF        @EQUAL
              MOVE      BKDIDES1,DIAGDES1
              MOVE      BKDIDES2,DIAGDES2
            ENDIF
          ENDIF
          MOVE      BKRECLMT,CLAIMCOD
          MOVE      BKREDEPT,UNITCODE
.
          GOTO      INTREC80
.
INTREC80  CALL      GETPAT00      * Get Patient Details
          CALL      PATLN000      * Format Patient Name with System Paramater
.
          MOVE      "LA",CATEGORY
          MOVE      PMPXLNG1,CODE
          CALL      GETCOD00
          MOVE      TDESC,PREFLNG1
.
          MOVE      "LA",CATEGORY
          MOVE      PMPXLNG2,CODE
          CALL      GETCOD00
          MOVE      TDESC,PREFLNG2
.
          MOVE      "LA",CATEGORY
          MOVE      PMPXLNG3,CODE
          CALL      GETCOD00
          MOVE      TDESC,PREFLNG3
.
          MOVE      "C ",CATEGORY
          MOVE      PMPXMCNT,CODE
          CALL      GETCOD00
          MOVE      TDESC,MOTHCOBD
.
          MOVE      "C ",CATEGORY
          MOVE      PMPXFCNT,CODE
          CALL      GETCOD00
          MOVE      TDESC,FATHCOBD
.
          MOVE      "CL",CATEGORY
          MOVE      CLAIMCOD,CODE
          CALL      GETCOD00
          MOVE      TDESC,CLAIMDES
.
          MOVE      "AC",CATEGORY          * Unit Description
          MOVE      UNITCODE,CODE
          CALL      GETCOD00
          MOVE      TDESC,UNITDESC
.
          MATCH     "1",VSIANOTF
          IF        @EQUAL
            MOVE      "Yes",NOTIFIED
          ELSE
            MOVE      "No",NOTIFIED
          ENDIF
.
          MATCH     "1",VSIACONF
          IF        @EQUAL
            MOVE      "Yes",CONFIRMD
          ELSE
            MOVE      "No",CONFIRMD
          ENDIF
.
          MOVE      SP70,LPCONDD
          MOVE      SP70,CONDESC
          MOVE      ZERO,TCINDC1
          PACK      KEY88,PTMASNAM,PMPXFNAM,AADMNO
          CALL      RDLOCA1
          IF        OVRCD=0
            CALL      GETCON00
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      INTREC99
.
INTREC90  MOVE      ONE,EXIT
.
INTREC99  RETURN
.
.------------------------------------------------------------
.   Get patient location
.------------------------------------------------------------
GLOC0000  MOVE     SP70,LOCATION
          BRANCH   ASTAT,GLOC1000,GLOC2000,GLOC3000,GLOC4000,GLOC5000
          GOTO     GLOC9999
.
GLOC1000  MOVE     "Pre-admission",LOCATION
          GOTO     GLOC9999
.
GLOC2000  PACK     KEY6,AWARD,SP70
          MATCH    SP70,AWARD
          IF       @EQUAL
            PACK      KEY14,AADMNO,SP70
            CALL      RDSWARD4
            CALL      RDKWARD4
            BRANCH    OVRCD,GLOC9999
            MATCH     WSTBY,AADMNO
            GOTO      GLOC9999 IF NOT EQUAL
            PACK      KEY6,WWARD,SP70
            CALL      RDWARD1
            CLEAR     LOCATION
            SQUEEZE   WBDESC
            PACK      LOCATION,WBDESC,SLASH,WBED,STANDBYD
            GOTO      GLOC9999
          ENDIF
          CALL     RDWARD1
          BRANCH   OVRCD,GLOC9999
          SQUEEZE   WBDESC
          PACK     LOCATION,WBDESC,SLASH,ABED
          GOTO     GLOC9999
.
GLOC3000  MOVE     "Discharged",LOCATION
          GOTO     GLOC9999
.
GLOC4000  MOVE     "On Leave",LOCATION
          GOTO     GLOC9999
.
GLOC5000  MOVE     "Cancelled",LOCATION
          GOTO     GLOC9999
.
GLOC9999  RETURN
.
.------------------------------------------------------------
.   Language filter for interpreter
.------------------------------------------------------------
INTFLT00  MATCH     "1",PMPXINTR
          GOTO      INTFLT90 IF NOT EQUAL
.
          MATCH     SP70,PREFLANG           * filter on pref language 1
          GOTO      INTFLT50 IF EQUAL
          MATCH     PMPXLNG1,PREFLANG
          GOTO      INTFLT50 IF EQUAL
          MATCH     PMPXLNG2,PREFLANG
          GOTO      INTFLT50 IF EQUAL
          MATCH     PMPXLNG3,PREFLANG
          GOTO      INTFLT90 IF NOT EQUAL
.
INTFLT50
          MOVE      ZERO,EXIT
          GOTO      INTFLT99
.
INTFLT90  MOVE      ONE,EXIT
          GOTO      FILTER99
.
INTFLT99  RETURN
.------------------------------------------------------------
.Table for Admissions
.------------------------------------------------------------
EXPA0000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,KEY1,DIM127
          UNPACK    DIM127,D1,KEY1A,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          MOVE      ZERO,F1A
          MOVE      KEY1A,F1A
. 
          PACK      KEY24,FRSTDATE,SP70
          CALL      RSVSINT2
EXPA1000  CALL      RKVSINT2
          BRANCH    OVRCD,EXPA9999
          MATCH     VSINDATE,LASTDATE
          GOTO      EXPA9999 IF LESS
.
          MOVE      SP10,NAWARD
          PACK      KEY8,VSINVISN,SP70     * Read Visit Extension File
          CALL      RDPMVX11               * for admitting point
          IF        OVRCD=1
            MOVE      SP70,PMVXAPWD
          ENDIF
.
          BRANCH    F1,EXPA5000
.
          PACK      KEY8,VSINVISN,SP70
          CALL      RDBKREC1          
          IF        OVRCD=1
            GOTO      EXPA5000              
          ELSE
            COMPARE   ZERO,BKRESTAT
            GOTO      EXPA5000 IF NOT EQUAL
          ENDIF
.
          IF        IBCNMHOS<>1
            GOTO      EXPA2000
          ENDIF
.
          MATCH     SP70,BKREWARD
          IF        @EQUAL
            MATCH     SP70,BKRXPOWD
            GOTO      EXPA2000 IF EQUAL
          ENDIF
.
          MATCH     SP70,BKREWARD
          IF        @EQUAL
            PACK      KEY6,BKRXPOWD,SP70
          ELSE
            PACK      KEY6,BKREWARD,SP70
          ENDIF
.
          CALL      RDWARD1
          BRANCH    OVRCD,EXPA1000
.
          MATCH     WBSEHOSP,PTWDHOSN
          GOTO      EXPA1000 IF NOT EQUAL
.
EXPA2000  PACK      KEY8,BKREURNO,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,EXPA1000
.
          CALL      FILTER00                * Filter for pref. languages
          BRANCH    EXIT,EXPA1000
.
          MOVE      TWO,F1                  * Flag to be used for waiting list
          MOVE      VSINDATE,CHRQDATE
          MOVE      VSINTIME,CHRQTIME
          MOVE      BKREBOOK,ADMISSNO
.
          CALL      EXPBOK00                * Calls booking read data
          CALL      DISFLD00
          GOTO      EXPA1000 
.
EXPA5000  PACK      KEY8,VSINVISN,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,EXPA1000
.
          MOVE      "AC",CATEGORY           * Unit Description
          MOVE      ACLSSFT,PATUNT02
          MOVE      ACLSSFT,CODE
          CALL      GETCOD00
          MOVE      TDESC,PATUNT01
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,EXPA1000
.
          IF        IBCNMHOS=1
            MATCH     WBSEHOSP,PMVXMHOS
            GOTO      EXPA1000 IF NOT EQUAL
          ENDIF
.
          BRANCH    F1,EXPA7000             * To check whether pre-adm/adm
.
EXPA6000  COMPARE   ONE,ASTAT
          GOTO      EXPA1000 IF NOT EQUAL
.
          PACK      KEY8,AURNO,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,EXPA1000
.
          CALL      FILTER00                * Filter for pref. languages
          BRANCH    EXIT,EXPA1000
.
          MOVE      AURNO,URNUMBER
          MOVE      AADMNO,ADMISSNO
          MOVE      VSINDATE,CHRQDATE
          MOVE      VSINTIME,CHRQTIME
          MOVE      PTMIXWRD,NAWARD
          MOVE      "Pre-Admitted",BOOKING
.
          CALL      ADMDAT00
.
          CALL      DISFLD00
          GOTO      EXPA1000
.
EXPA7000  COMPARE   TWO,ASTAT
          GOTO      EXPA1000 IF NOT EQUAL
.
          PACK      KEY8,AURNO,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,EXPA1000
.
          CALL      FILTER00                * Filter for pref. languages
          BRANCH    EXIT,EXPA1000
.
          MOVE      AWARD,NAWARD
          MOVE      AURNO,URNUMBER
          MOVE      AADMNO,ADMISSNO
          MOVE      VSINDATE,CHRQDATE
          MOVE      VSINTIME,CHRQTIME
          MOVE      "Admitted",BOOKING
.
          CALL      ADMDAT00
.
          CALL      DISFLD00
          GOTO      EXPA1000
.
EXPA9999  RETURN
.-------------------------------------------------------------
.         Common read routine for booking
.-------------------------------------------------------------
EXPBOK00  CALL      RDBKRX11
          IF        OVRCD=1
            MOVE      SP70,BKRXCNDT         * Confirmation date
          ENDIF
.
          MOVE      "Booked",BOOKING
          MOVE      BKREURNO,URNUMBER
          MOVE      BKREBOOK,ADMISSNO
          MOVE      BKREEDAT,ADATE
          MOVE      BKREATIM,ATIME
          MOVE      BKREWARD,AWARD
          MOVE      BKREWARD,NAWARD
.
          CALL      ADMDAT00
.
          MOVE      "AC",CATEGORY           * Unit Description
          MOVE      BKREDEPT,PATUNT02
          MOVE      BKREDEPT,CODE
          CALL      GETCOD00
          MOVE      TDESC,PATUNT01
.
          PACK      KEY18,BKREBOOK,SP70      * Read the diagnosis file
          CALL      RSBKDIA1
          CALL      RKBKDIA1
          IF        OVRCD=0
            MATCH     BKREBOOK,BKDIBOOK
            IF        @EQUAL
              MOVE      BKDIDES1,ADIAG1
              MOVE      BKDIDES2,ADIAG2      
            ENDIF
          ENDIF
.
          CALL      RDAP0000                * For adm. point/ward  
.
EXPBOK99  RETURN
.------------------------------------------------------------
.Table for Outpatient and Allied Health Interpreters   
.------------------------------------------------------------
OUTALH00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,KEY1A,DIM127
          MOVE      ZERO,F1A
          MOVE      KEY1A,F1A
.
          PACK      KEY24,FRSTDATE,SP70
          CALL      RSVSINT2
OUTALH10  CALL      RKVSINT2
          BRANCH    OVRCD,OUTALH99
          MATCH     VSINDATE,LASTDATE
          GOTO      OUTALH99 IF LESS
.
          MOVE      ZERO,SUSPFLAG           * Clear suspended appointment flag
.
          MATCH     "2",OUTALFLG
          IF        @EQUAL
            GOTO      OUTALH30 
          ELSE 
            GOTO      OUTALH20
          ENDIF
.
          GOTO      OUTALH99
.
OUTALH20  COMPARE   TWO,VSINTYPE            * outpatient or not?
          GOTO      OUTALH10 IF NOT EQUAL
.
          MATCH     "1",VSINCHON
          GOTO      OUTALH10 IF EQUAL
.
          MOVE      VSINSUBK,WBSESIT
          CALL      OUTFIL00
          BRANCH    EXIT,OUTALH10
.
          PACK      KEY28,VSINSUBK,SP70
          CALL      RDBOKA1
          BRANCH    OVRCD,OUTALH10
.
          COMPARE   SIX,OBASTAT
          IF        @EQUAL
            MOVE      ONE,SUSPFLAG          * Display suspended appointment red
          ENDIF
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,OUTALH10
.
          IF        IBCNMHOS=1
            MATCH     WBSEHOSP,PMVXMHOS
            GOTO      OUTALH10 IF NOT EQUAL 
          ENDIF
.
          PACK      KEY8,OBAURNO,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,OUTALH10
.
          CALL      FILINT00                * Filter for pref. languages
          BRANCH    EXIT,OUTALH10
.
          MOVE      VSINDATE,CHRQDATE
          MOVE      VSINTIME,CHRQTIME
.
          CALL      OUTBOK00
          CALL      DISFLD00
          GOTO      OUTALH10
.
OUTALH30  COMPARE   FOUR,VSINTYPE            * Allied Health or not?
          GOTO      OUTALH10 IF NOT EQUAL
.
          PACK      KEY8,VSINVISN,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,OUTALH10
.
          PACK      KEY8,ALREURNO,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,OUTALH10
.
          PACK      KEY8,ALREVISN,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,OUTALH10
.
          IF        IBCNMHOS=1
            MATCH     WBSEHOSP,PMVXMHOS
            GOTO      OUTALH10 IF NOT EQUAL 
          ENDIF
.
          CALL      FILTER00                * Filter for pref. languages
          BRANCH    EXIT,OUTALH10
.
          MOVE      ALREURNO,URNUMBER
          MOVE      ALREVISN,ADMISSNO
          MOVE      "AlliedHealth",BOOKING
          MOVE      ALRERDAT,ADATE
          MOVE      SP70,ATIME
          MOVE      ALREDIA1,ADIAG1
          MOVE      ALREDIA2,ADIAG2
          MOVE      ALRECTYP,CLILDESC
          MOVE      ALREPRO1,PMVXUDF1
          MOVE      VSINDATE,CHRQDATE
          MOVE      VSINTIME,CHRQTIME
.
          CALL      ADMDAT00                * formatting appointment date/time
.
          MOVE      "AC",CATEGORY           * Unit Description
          MOVE      ALREUNIT,PATUNT02
          MOVE      ALREUNIT,CODE
          CALL      GETCOD00
          MOVE      TDESC,PATUNT01
.
          CALL      DISFLD00                * display row
          GOTO      OUTALH10
.
OUTALH99  RETURN
.------------------------------------------------------------
.         Admissions based on date and type of change
.------------------------------------------------------------
CHAD0000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,KEY1,DIM127
          UNPACK    DIM127,D1,KEY1A,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          MOVE      ZERO,F1A
          MOVE      KEY1A,F1A
.
          PACK      KEY25,FRSTDATE,SP70
          CALL      RSVSIAU1
CHAD1000  CALL      RKVSIAU1
          BRANCH    OVRCD,CHAD9999
          MATCH     VSIACDAT,LASTDATE
          GOTO      CHAD9999 IF LESS
.
          MOVE      SP10,NAWARD
          PACK      KEY8,VSIAVISN,SP70     * Read Visit Extension File
          CALL      RDPMVX11               * for admitting point
          IF        OVRCD=1
            MOVE      SP70,PMVXAPWD
          ENDIF
.
          BRANCH    F1,CHAD5000
.
          MATCH     SP70,CHNGTYPE           * filter on Type of Change
          IF        !@EQUAL
            MATCH     VSIARTYP,CHNGTYPE
            GOTO      CHAD1000 IF NOT EQUAL
          ENDIF
.
          PACK      KEY8,VSIAVISN,SP70
          CALL      RDBKREC1
          IF        OVRCD=1
            GOTO      CHAD5000
          ELSE
            COMPARE   ZERO,BKRESTAT
            GOTO      CHAD5000 IF NOT EQUAL
          ENDIF
.
          IF        IBCNMHOS<>1
            GOTO      CHAD2000
          ENDIF
.
          MATCH     SP70,BKREWARD
          IF        @EQUAL
            MATCH     SP70,BKRXPOWD
            GOTO      CHAD2000 IF EQUAL
          ENDIF
.
          MATCH     SP70,BKREWARD
          IF        @EQUAL
            PACK      KEY6,BKRXPOWD,SP70
          ELSE
            PACK      KEY6,BKREWARD,SP70
          ENDIF
.
          CALL      RDWARD1
          BRANCH    OVRCD,CHAD1000
.
          MATCH     WBSEHOSP,PTWDHOSN
          GOTO      CHAD1000 IF NOT EQUAL
.
CHAD2000  PACK      KEY8,BKREURNO,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,CHAD1000
.
          CALL      FILTER00                * Filter for pref. languages
          BRANCH    EXIT,CHAD1000 
.
          MOVE      TWO,F1                  * Flag to be used for waiting list
          MOVE      VSIACDAT,CHRQDATE
          MOVE      VSIACTIM,CHRQTIME
.
          CALL      EXPBOK00                * Calls booking read data
          CALL      DISFLD00
          GOTO      CHAD1000
.
CHAD5000  PACK      KEY8,VSIAVISN,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,CHAD1000
.
          MOVE      "AC",CATEGORY           * Unit Description
          MOVE      ACLSSFT,PATUNT02
          MOVE      ACLSSFT,CODE
          CALL      GETCOD00
          MOVE      TDESC,PATUNT01
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,CHAD1000
.
          IF        IBCNMHOS=1
            MATCH     WBSEHOSP,PMVXMHOS
            GOTO      CHAD1000 IF NOT EQUAL
          ENDIF
.
          BRANCH    F1,CHAD7000             * To check whether pre-adm/adm
.
CHAD6000  COMPARE   ONE,ASTAT
          GOTO      CHAD1000 IF NOT EQUAL
.
          PACK      KEY8,AURNO,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,CHAD1000
.
          CALL      FILTER00                * Filter for pref. languages
          BRANCH    EXIT,CHAD1000
.
          MOVE      AURNO,URNUMBER
          MOVE      AADMNO,ADMISSNO
          MOVE      VSIACDAT,CHRQDATE
          MOVE      VSIACTIM,CHRQTIME
          MOVE      PTMIXWRD,NAWARD
          MOVE      "Pre-Admitted",BOOKING
.
          CALL      ADMDAT00
.
          CALL      DISFLD00
          GOTO      CHAD1000
.
CHAD7000  COMPARE   TWO,ASTAT
          GOTO      CHAD1000 IF NOT EQUAL
.
          PACK      KEY8,AURNO,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,CHAD1000
.
          CALL      FILTER00                * Filter for pref. languages
          BRANCH    EXIT,CHAD1000
.
          MOVE      AWARD,NAWARD
          MOVE      AURNO,URNUMBER
          MOVE      AADMNO,ADMISSNO
          MOVE      VSIACDAT,CHRQDATE
          MOVE      VSIACTIM,CHRQTIME
          MOVE      "Admitted",BOOKING
.
          CALL      ADMDAT00
.
          CALL      DISFLD00
          GOTO      CHAD1000
.
CHAD9999  RETURN
.------------------------------------------------------------
.Table for Outpatient and Allied Health Interpreters
.------------------------------------------------------------
CHGOUT00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,KEY1A,DIM127
          MOVE      ZERO,F1A
          MOVE      KEY1A,F1A
.
          PACK      KEY25,FRSTDATE,SP70
          CALL      RSVSIAU1
CHGOUT10  CALL      RKVSIAU1
          BRANCH    OVRCD,CHGOUT99
          MATCH     VSIACDAT,LASTDATE
          GOTO      CHGOUT99 IF LESS
.
          MATCH     SP70,CHNGTYPE           * filter on Type of Change
          IF        !@EQUAL
            MATCH     VSIARTYP,CHNGTYPE
            GOTO      CHGOUT10 IF NOT EQUAL
          ENDIF
.
          MATCH     "2",OUTALFLG
          IF        @EQUAL
            GOTO      CHGOUT30
          ELSE
            GOTO      CHGOUT20
          ENDIF
.
          GOTO      CHGOUT99
.
CHGOUT20  COMPARE   TWO,VSIATYPE            * outpatient or not?
          GOTO      CHGOUT10 IF NOT EQUAL
.
          MOVE      VSINSUBK,WBSESIT        * Open correct site booking files
          CALL      OUTFIL00
          BRANCH    EXIT,CHGOUT10
.
          PACK      KEY28,VSIASUBK,SP70
          CALL      RDBOKA1
          BRANCH    OVRCD,CHGOUT10
.
          PACK      KEY8,OBAURNO,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,CHGOUT10
.
          PACK      KEY8,OBAOUTNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,CHGOUT10
.
          IF        IBCNMHOS=1
            MATCH     WBSEHOSP,PMVXMHOS
            GOTO      CHGOUT10 IF NOT EQUAL
          ENDIF
.
          CALL      FILTER00                * Filter for pref. languages
          BRANCH    EXIT,CHGOUT10
.
          MOVE      VSIACDAT,CHRQDATE
          MOVE      VSIACTIM,CHRQTIME
.
          CALL      OUTBOK00
          CALL      DISFLD00
          GOTO      CHGOUT10
.
CHGOUT30  COMPARE   FOUR,VSIATYPE            * Allied Health or not?
          GOTO      CHGOUT10 IF NOT EQUAL
.
          PACK      KEY8,VSIAVISN,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,CHGOUT10
.
          PACK      KEY8,ALREURNO,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,CHGOUT10
.
          PACK      KEY8,ALREVISN,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,CHGOUT10
.
          IF        IBCNMHOS=1
            MATCH     WBSEHOSP,PMVXMHOS
            GOTO      CHGOUT10 IF NOT EQUAL
          ENDIF
.
          CALL      FILTER00                * Filter for pref. languages
          BRANCH    EXIT,CHGOUT10
.
          MOVE      ALREURNO,URNUMBER
          MOVE      ALREVISN,ADMISSNO
          MOVE      "AlliedHealth",BOOKING
          MOVE      ALRERDAT,ADATE
          MOVE      SP70,ATIME
          MOVE      ALREDIA1,ADIAG1
          MOVE      ALREDIA2,ADIAG2
          MOVE      ALRECTYP,CLILDESC
          MOVE      ALREPRO1,PMVXUDF1
          MOVE      VSINDATE,CHRQDATE
          MOVE      VSINTIME,CHRQTIME
.
          CALL      ADMDAT00                * formatting appointment date/time
.
          MOVE      "AC",CATEGORY           * Unit Description
          MOVE      ALREUNIT,PATUNT02
          MOVE      ALREUNIT,CODE
          CALL      GETCOD00
          MOVE      TDESC,PATUNT01
.
          CALL      DISFLD00                * display row
          GOTO      CHGOUT10 
.
CHGOUT99  RETURN
.-----------------------------------------------------------
.         Common read for outpatient         
.-----------------------------------------------------------
OUTBOK00  MOVE      OBAURNO,URNUMBER
          MOVE      OBAOUTNO,ADMISSNO
          MOVE      OBADATE,ADATE
          MOVE      OBATIME,ATIME
.
          CALL      ADMDAT00                * formatting appointment date/time
.
          MOVE      "Outpatient",BOOKING
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMVX11
          IF        OVRCD=1
            MOVE      SP70,PMVXUDF1
          ENDIF
.
          PACK      KEY8,OBAOUTNO,SP70      * for diagnosis
          CALL      RDDIAG1
          IF        OVRCD=1
            MOVE      SP70,ADIAG1
            MOVE      SP70,ADIAG2
          ELSE
            MOVE      OPDIDESC,ADIAG1
            MOVE      OPDIDES2,ADIAG2
          ENDIF
.
          PACK      KEY18,OBASITE,OBACLIN,OBADAY,OBASTRT,SP70
          CALL      RDMASA1                 * for location
          IF        OVRCD=1
            MOVE      SP70,CLILDESC
          ELSE
            MOVE      "CT",CATEGORY
            MOVE      OTMALTYP,CODE
            CALL      GETCOD00
            MOVE      TDESC,CLILDESC
          ENDIF
.
OUTBOK99  RETURN
.------------------------------------------------------------
.         Display fields for Expected admissions for interpreter
.------------------------------------------------------------
DISFLD00  CALL      GETPAT00
          MOVE      F1,F1B                       * save value in F1 (0933113)
.* ****************************************** Start of Changes
          CALL      PATLN000
.* ******************************************   End of Changes
          MOVE      F1B,F1                       * restore value in F1 (0933113)
.
          MOVE      SP70,LPCONDD
          MOVE      SP70,CONDESC
          MOVE      ZERO,TCINDC1
          PACK      KEY88,PTMASNAM,PMPXFNAM,ADMISSNO
          CALL      RDLOCA1
          IF        OVRCD=0
            CALL      GETCON00
          ENDIF
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDPMPX21
          IF        OVRCD=1
            MOVE      SP70,PREFLNG1
            MOVE      SP70,PREFLNG2
            MOVE      SP70,ABRGNATN
          ELSE
            MATCH     SP70,PMPXLNG1         * For first language
            IF        @EQUAL
              MOVE      SP70,PREFLNG1
            ELSE
              MOVE      "LA",CATEGORY
              MOVE      PMPXLNG1,CODE
              CALL      GETCOD00
              MOVE      TDESC,PREFLNG1
            ENDIF
            MATCH     SP70,PMPXLNG2         * For 2nd language
            IF        @EQUAL
              MOVE      SP70,PREFLNG2
            ELSE
              MOVE      "LA",CATEGORY
              MOVE      PMPXLNG2,CODE
              CALL      GETCOD00
              MOVE      TDESC,PREFLNG2
            ENDIF
            MATCH     SP70,PMPXABRG         * For Nationality/ethnicity
            IF        @EQUAL
              MOVE      SP70,ABRGNATN
            ELSE
              MOVE      "VA",CATEGORY
              MOVE      PMPXABRG,CODE
              CALL      GETCOD00
              MOVE      TDESC,ABRGNATN
            ENDIF
          ENDIF
.
          MATCH     "1",VSINNOTF
          IF        @EQUAL
            MOVE      "Yes",DIM3
          ELSE
            MOVE      "No",DIM3
          ENDIF
.
          MATCH     "1",VSINCONF
          IF        @EQUAL
            MOVE      "Yes",DIM3A
          ELSE
            MOVE      "No",DIM3A
          ENDIF
.
          PACK      DIM1,SP20
          PACK      DISPCLSS,SP20
          PACK      DISPALTD,SP70
          PACK      KEY5,ANSC,ANSC,ACARE,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            UNPACK      TCINDC21,DIM1
          ENDIF
          MATCH     DIM1,SP70
          IF        !@EQUAL
            PACK      DISPCLSS,ONCLCLSS,DIM1,SP70
            PACK      DISPALTD,PTCDLDES,SP70
          ENDIF
          SQUEEZE   DISPCLSS
          STRIP     DISPALTD
.
          PACK      KEY12,OBASITE,OBACTYP,SP70         * I CAR 41298
          CALL      RDCTYA1
          IF        OVRCD=1
            MOVE      SP70,OCTDESC
          ENDIF
.                                                      * end I CAR 41298
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
.
          IF        F1=2
            PACK      CASEKEYS,BKREURNO,BKREPROC,DBKRECNT,SP70
            REP       " +",CASEKEYS
            CLEAR     PATLINK
            APPEND    LINKPRG,PATLINK
            APPEND    ".pbl?reportno=",PATLINK
            APPEND    LINKREP,PATLINK
            APPEND    "&template=",PATLINK
            APPEND    LINKTEM,PATLINK
            APPEND    "&urnumber=",PATLINK
            APPEND    URNUMBER,PATLINK
            APPEND    "&admissno=",PATLINK
            APPEND    ADMISSNO,PATLINK
            APPEND    "&casekeys=",PATLINK
            APPEND    CASEKEYS,PATLINK
            RESET     PATLINK
            REP       "+ ",CASEKEYS
          ELSE
            CLEAR     PATLINK
            APPEND    LINKPRG,PATLINK
            APPEND    ".pbl?reportno=",PATLINK
            APPEND    LINKREP,PATLINK
            APPEND    "&template=",PATLINK
            APPEND    LINKTEM,PATLINK
            APPEND    "&urnumber=",PATLINK
            APPEND    URNUMBER,PATLINK
            APPEND    "&admissno=",PATLINK
            APPEND    ADMISSNO,PATLINK
            RESET     PATLINK
          ENDIF 
.
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
          WRITE     HTMLFILE;"t.addRow(#"",PATLINK,"#",":
                             "#"",FORMATNM,"#",":
                             "#"",URNUMBER,"#",":
                             "#"",ADATE,ATIME,"#",":
                             "#"",DIM3,"#",":
                             "#"",DISPSEX,"#",":
                             "#"";
          CALL      WRTAGE00
          CALL      PATFLD00               *Returns KEY3 for folder colour code
.
          REP       "#" ",ADIAG1
          REP       "#" ",ADIAG2
          WRITE     HTMLFILE;"#",":
                             "#"",CHRQDATE,CHRQTIME,"#",":
                             "#"",ADIAG1,ADIAG2,"#",":
                             "#"",CONDESC,SP1,LPCONDD,"#",":
                             "#"",PATUNT01,"#","; 
          PACK      KEY6,NAWARD,SP70
          CALL      FWBD0000
          WRITE     HTMLFILE;*+,"#"",WARDTEXT,"#",";
.
          MOVE      "ap",CATEGORY
          MOVE      PMVXAPWD,CODE      * Admitting point Cat ap
          CALL      GETCOD00
          MOVE      TDESC,APOIDESC
.
          WRITE     HTMLFILE;*+,"#"",APOIDESC,"#",":
                             "#"",BKRXCNDT,"#",":
                             "#"",PREFLNG1,"#",":
                             "#"",PREFLNG2,"#",";
          IF        SUSPFLAG = 1
            WRITE     HTMLFILE;"#"<font color=red>",BOOKING,"</font>#",";
          ELSE
            WRITE     HTMLFILE;"#"",BOOKING,"#",";
          ENDIF
.
          WRITE     HTMLFILE;"#"",OBACLIN,"#",":
                             "#"",CLILDESC,"#",":
                             "#"",PMVXUDF1,"#",":
                             "#"",VSINSUBK,"#",":
                             "#"",KEY3,"#",":
                             "#"",OCTDESC,"#",":
                             "#"",DIM3A,"#",":
                             "#"",ABRGNATN,"#",":  * 24
                             "#"",DISPCLSS,"#",":
                             "#"",DISPALTD,"#");"                  
.
DISFLD99  RETURN
.------------------------------------------------------------
.         Lists Interpreter History
.------------------------------------------------------------
LISHIS00  PACK      KEY25,ADMISSNO,Z70
          CALL      RSVSIAU2
LISHIS10  CALL      RPVSIAU2
          BRANCH    OVRCD,LISHIS99
          MATCH     VSIAVISN,ADMISSNO
          GOTO      LISHIS99 IF NOT EQUAL
.
          CALL      DISHIS00
.
          WRITE     HTMLFILE;"t.addRow(#"",VSIACDAT,VSIACTIM,"#",":
                             "#"",RECDTYPE,"#",":
                             "#"",PREFLNG1,"#",":
                             "#"",PREFLNG2,"#",":
                             "#"",PREFLNG3,"#",":
                             "#"",VISITTYP,"#",":
                             "#"",ADATE,ATIME,"#",":
                             "#"",VSIAVISN,"#",":
                             "#"",NOTIFIED,"#");"
.
          GOTO      LISHIS10 
.
LISHIS99  RETURN
.------------------------------------------------------------
.  Dispaly for Interpreter History
.------------------------------------------------------------
DISHIS00  BRANCH    VSIATYPE,DISHIS10,DISHIS20,DISHIS30,DISHIS40
          GOTO      DISHIS50 
.
. Emergency
.
DISHIS10  PACK      KEY8,VSIAVISN,SP70
          CALL      RDEMVIS1
          IF        OVRCD=1
            MOVE      SP70,ADATE
            MOVE      SP70,ATIME
          ELSE
            IF        EMVISTAT=FOUR
              MOVE      SP70,ADATE
              MOVE      SP70,ATIME
            ELSE
              MOVE      EMVIDATE,ADATE
              MOVE      EMVITIME,ATIME 
            ENDIF
          ENDIF
          MOVE      "EM",VISITTYP
          GOTO      DISHIS50 
.
. Outpatients
.
DISHIS20  PACK      KEY28,VSINSUBK,SP70
          CALL      RDBOKA1
          IF        OVRCD=1
            MOVE      SP70,ADATE
            MOVE      SP70,ATIME
          ELSE
            MOVE     OBADATE,ADATE
            MOVE     OBATIME,ATIME 
          ENDIF
          MOVE      "OP    ",VISITTYP
          GOTO      DISHIS50
.
DISHIS30  PACK      KEY8,VSIAVISN,SP70
          CALL      RDMISS1 
          BRANCH    OVRCD,DISHIS35
          IF        ASTAT=1|ASTAT=5
            MOVE      "Pre Ad",VISITTYP
          ELSE
            MOVE      "IP    ",VISITTYP
          ENDIF
          GOTO      DISHIS50
.
DISHIS35  PACK      KEY8,VSIAVISN,SP70
          MOVE      SP70,ADATE
          MOVE      SP70,ATIME
          CALL      RDBKREC1
          IF        OVRCD=0
            MOVE      BKREADAT,ADATE
            MOVE      BKREATIM,ATIME
          ENDIF   
          IF        BKRESTAT<2
            MOVE      "Pre Ad",VISITTYP
          ELSE
            MOVE      "IP    ",VISITTYP
          ENDIF
          GOTO      DISHIS50
.
. Allied Health
.
DISHIS40  PACK      KEY8,VSIAVISN,SP70
          CALL      RDALREF1
          IF        OVRCD=1
            MOVE      SP70,ADATE
            MOVE      SP70,ATIME
          ENDIF
          MOVE      "AH",VISITTYP
          GOTO      DISHIS50
.
DISHIS50  PACK      KEY8,URNUMBER,SP70
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MOVE      "LA",CATEGORY
          MOVE      PMPXLNG1,CODE
          CALL      GETCOD00
          MOVE      TDESC,PREFLNG1
.
          MOVE      "LA",CATEGORY
          MOVE      PMPXLNG2,CODE
          CALL      GETCOD00
          MOVE      TDESC,PREFLNG2
.
          MOVE      "LA",CATEGORY
          MOVE      PMPXLNG3,CODE
          CALL      GETCOD00
          MOVE      TDESC,PREFLNG3
.
          MATCH     SP70,VSIALNG1
          IF        !@EQUAL
            MOVE      "LA",CATEGORY
            MOVE      VSIALNG1,CODE
            CALL      GETCOD00
            MOVE      TDESC,PREFLNG1
.
            MOVE      "LA",CATEGORY
            MOVE      VSIALNG2,CODE
            CALL      GETCOD00
            MOVE      TDESC,PREFLNG2
.
            MOVE      "LA",CATEGORY
            MOVE      VSIALNG3,CODE
            CALL      GETCOD00
            MOVE      TDESC,PREFLNG3
          ENDIF
.
          MATCH     "A",VSIARTYP
          IF        @EQUAL
            MOVE      "Add",RECDTYPE
          ENDIF
          MATCH     "B",VSIARTYP
          IF        @EQUAL
            MOVE      "Before Change",RECDTYPE
          ENDIF
          MATCH     "C",VSIARTYP
          IF        @EQUAL
            MOVE      "After Change",RECDTYPE
          ENDIF
          MATCH     "D",VSIARTYP
          IF        @EQUAL
            MOVE      "Deleted",RECDTYPE
          ENDIF
.
          MATCH     "1",VSIANOTF
          IF        @EQUAL
            MOVE      "Yes",NOTIFIED
          ELSE
            MOVE      "No",NOTIFIED
          ENDIF
.
          MATCH     "1",VSIACONF
          IF        @EQUAL
            MOVE      "Yes",NOTIFIED
          ELSE
            MOVE      "No",CONFIRMD
          ENDIF
.
          PACK      KEY8,VSIAVISN,SP70
          CALL      RDVSINT1
.
DISHIS99  RETURN
.------------------------------------------------------------
.   Language filter for interpreter
.------------------------------------------------------------
FILTER00  MATCH     "1",PMPXINTR
          GOTO      FILTER90 IF NOT EQUAL
.
          MATCH     SP70,PMPGI002           * filter on pref language 1
          IF        !@EQUAL
            MATCH     PMPXLNG1,PMPGI002
            GOTO      FILTER90 IF NOT EQUAL
          ENDIF
.
          IF        F1A=1
            MATCH     SP70,PMPGI065           * filter on nationality
            IF        !@EQUAL
              MATCH     PMPXABRG,PMPGI065
              GOTO      FILTER90 IF NOT EQUAL
            ENDIF
          ELSE
            MATCH     SP70,PMPGI003           * filter on pref language 2
            IF        !@EQUAL
              MATCH     PMPXLNG2,PMPGI003
              GOTO      FILTER90 IF NOT EQUAL
            ENDIF
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      FILTER99
.
FILTER90  MOVE      ONE,EXIT
          GOTO      FILTER99
.
FILTER99  RETURN
.------------------------------------------------------------
. Table of Current Admissions
.------------------------------------------------------------
TOCA0000  MOVE      "Ward/Bed",COLHED02 
          MOVE      "Adm. Date",COLHED03
          CALL      TABHED00  
          PACK      KEY9,TWO,SP70
          CALL      RDSMISS2
TOCA1000  CALL      RDKMISS2
          BRANCH    OVRCD,TOCA9000
          COMPARE   "2",ASTAT
          GOTO      TOCA9000 IF NOT EQUAL
.
...          PACK      COLDAT02,AWARD,SLASH,ABED
          PACK      KEY6,AWARD,ABED
          CALL      FWBD0000
          PACK      COLDAT02,WBEDTEXT,SP70
.
          CALL      ADMDAT00
          PACK      COLDAT03,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          PACK      URNUMBER,AURNO 
          PACK      ADMISSNO,AADMNO 
          MOVE      AURNO,URNO
.        
          CALL      TABCON00
          GOTO      TOCA1000
.
TOCA9000  
.
TOCA9999  RETURN
.------------------------------------------------------------
. Table of Patients on Leave 
.------------------------------------------------------------
TOPL0000  MOVE      "Ward/Bed",COLHED02 
          MOVE      "Adm. Date",COLHED03
          MOVE      ONE,TITLFLAG 
          CALL      TABHED00  
          MOVE      ZERO,TITLFLAG
          PACK      KEY9,FOUR,SP70
          CALL      RDSMISS2
TOPL1000  CALL      RDKMISS2
          BRANCH    OVRCD,TOPL9000
. 
          COMPARE   "4",ASTAT
          GOTO      TOPL9000 IF NOT EQUAL
.
..          PACK      COLDAT02,AWARD,SLASH,ABED
          PACK      KEY6,AWARD,ABED
          CALL      FWBD0000
          PACK      COLDAT02,WBEDTEXT,SP70
.
.
          CALL      ADMDAT00
          PACK      COLDAT03,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          PACK      URNUMBER,AURNO 
          PACK      ADMISSNO,AADMNO 
          MOVE      AURNO,URNO
          CALL      TABCON00
          GOTO      TOPL1000
TOPL9000  
TOPL9999  RETURN
.------------------------------------------------------------
. Table of Current Admissions by Surname Search
.------------------------------------------------------------
TOCS0000  COMPARE   ONE,LNK2PRT
          GOTO      TOCS0100 IF EQUAL
.
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
TOCS0100  
          WRITE     HTMLFILE;"<div class=HeadingDivision>":
                             "<table class=TableHeading>":
                             "<tr><td class=TableCol1>Name</td>":
                                 "<td class=TableCol2>Adm. No.</td>":
                                 "<td class=TableCol3>Ext.</td>":
                                 "<td class=TableCol4>Ward/Bed</td>":
                                 "<td class=TableCol5>Adm. Date</td>":
                                 "<td class=TableCol6>Sex</td>":
                                 "<td class=TableCol7>Age</td>":
                                 "<td class=TableCol8>Patient Condition</td>":
                             "</tr>":
                             "</table></div>"
          WRITE     HTMLFILE;"<div class=BodyDivision>":
                             "<table class=TableBody>"
          STRIP     KEYWORDS 
          PACK      KEY88,KEYWORDS,SP70,SP70
          CALL      RDSLOCA1
TOCS1000  CALL      RDKLOCA1
          BRANCH    OVRCD,TOCS9000
          MATCH     KEYWORDS,LSNAME
          GOTO      TOCS9000 IF NOT EQUAL
.
          MOVE      LADMNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,TOCS1000         
          CALL      ADMDAT00
.
          MOVE      AURNO,URNUMBER
          MOVE      AADMNO,ADMISSNO
          CALL      GETPAT00  
.
          MOVE      SP70,LPCONDD
          MOVE      SP70,CONDESC
          CALL      GETCON00
.
          MOVE      SP70,KEY4
          MATCH     SP70,AWARD
          IF        @EQUAL
            PACK      KEY14,AADMNO,SP70
            CALL      RDSWARD4
            CALL      RDKWARD4
.
            IF        OVRCD=0
              MATCH     AADMNO,WSTBY
              IF        @EQUAL
                MOVE      "(S) ",KEY4
                GOTO      TOCS1150
              ENDIF
            ENDIF
            MOVE      SP70,WWARD
            MOVE      SP70,WBED
          ELSE
            MOVE      SP70,WWARD
            MOVE      SP70,WBED
            MOVE      SP70,WEXTN
            PACK      KEY6,AWARD,ABED,SP70
            CALL      RDWARD1
          ENDIF
TOCS1150  IF        ASTAT=4
            MOVE      "(L) ",KEY4
          ENDIF
.
          MOVE      SP70,DOCFNAME
          MOVE      ADOCTA,KEY6
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000
          ENDIF
.
          MATCH     SP70,CONDESC
          IF        !@EQUAL
            UNPACK    LPCDATE,CCENT,CYEAR,CMON,CDAY
            PACK      DISPDATE,LBRACKT,CDAY,SLASH,CMON,SP1,LPCTIME,RBRACKT
          ELSE
            CLEAR     DISPDATE
          ENDIF
.
          CALL      PATLN000       * Format Patient Name from System Parameter
.
          COMPARE   ONE,LNK2PRT
          GOTO      TOCS1100 IF EQUAL
.
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
.
.
          WRITE     HTMLFILE;"<tr><td class=TableCol1>":
                             "<A HREF=",LINKPRG,".pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO,">";
.
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
          GOTO      TOCS1200
.
TOCS1100  CALL      JAVNAM00
          WRITE     HTMLFILE;"<tr><td class=TableCol1>":
                               "<a href=#"#" ":
                               "OnClick=#"updateParent('",JAVFNAME:
                               "','",ADMISSNO,"')#">";
.
TOCS1200  REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
          PACK      KEY6,WWARD,WBED
          CALL      FWBD0000
          WRITE     HTMLFILE;*+,"<img src=../images/patweb92-1.gif ":
                         "align=absmiddle border=0 hspace=4></a>":
                         FORMATNM,"</td>":
                         "<td class=TableCol2>",ADMISSNO,"</td >":
                         "<td class=TableCol3><b>",WEXTN,"&nbsp;":
                         "</b></td>":
                         "<td class=TableCol4>",WBEDTEXT,"&nbsp;",KEY4,"</td >":
                         "<td class=TableCol5>",FADMDATE,"</td>":
                         "<td class=TableCol6>",DISPSEX,"</td>":
                         "<td class=TableCol7>";
          CALL      WRTAGE00
          MATCH     SP70,LPCONDD
          IF        @EQUAL
            WRITE     HTMLFILE;"</td>":
                               "<td class=TableCol8>":
                               "<img src=../images/",IMGSRC," hspace=4 ":
                               "align=absmiddle border=0 ></a>":
                               CONDESC,DISPDATE,"</td></tr>"
          ELSE
            WRITE     HTMLFILE;"</td>":
                               "<td class=TableCol8>":
                               "<img src=../images/",IMGSRC," hspace=4 ":
                               "align=absmiddle border=0 ></a>":
                               CONDESC,DISPDATE,"<br>":
                               "<img src=../images/spacer1.gif hspace=4 ":
                               "align=absmiddle border=0 >":
                               LPCONDD,"</td></tr>"
          ENDIF
.
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
          GOTO      TOCS1000
.
TOCS9000  MOVE      ZERO,SRCHFLAG
          WRITE     HTMLFILE;"</table></div>"
.
          RETURN
.------------------------------------------------------------
. Patient Discharges 
.------------------------------------------------------------
PADI0000  BRANCH    FLDITMNO,PADI0100,PADI0200,PADI0300,PADI0400:
                             PADI0500,PADI0600,PADI0700,PADI0800:
                             PADI0900,PADI1000,PADI1100,PADI1200:
                             PADI1300,PADI1400,PADI1500,PADI1600:
                             PADI1700,PADI1800
.
PADI0100  CALL      NEXT0000
          GOTO      PADI9999
.
PADI0200  CALL      PREV0000
          GOTO      PADI9999
.
PADI0300  CALL      CURSTD00
          GOTO      PADI9999
.
PADI0400  CALL      CUREND00
          GOTO      PADI9999
.
PADI0500  CALL      CURYR000
          GOTO      PADI9999
.
PADI0600  CALL      CURMON00
          GOTO      PADI9999
.
PADI0700  CALL      SELV0000
          GOTO      PADI9999
.
PADI0800  CALL      TODP0000
          GOTO      PADI9999
.
PADI0900  WRITE     HTMLFILE;TEMPLATE;
          GOTO      PADI9999
.
PADI1000  WRITE     HTMLFILE;REPORTNO;
          GOTO      PADI9999
.
PADI1100  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      PADI9999
.
PADI1200  MOVE      CODEAC,CATEGORY         * unit code
          MOVE      UNITCODE,CODE
          CALL      CODSEL00
          GOTO      PADI9999
.
PADI1300  MOVE      CODECL,CATEGORY         * claim code
          MOVE      CLAIMCOD,CODE
          CALL      CODSEL00
          GOTO      PADI9999
.
PADI1400  MOVE      CODEVI,CATEGORY         * patient type
          MOVE      PATTYPES,CODE
          CALL      CODSEL00
          GOTO      PADI9999
.
PADI1500  PACK      DFLTWARD,WARDCODE                                 
          CALL      WSEL0000                * Ward selection list
          GOTO      PADI9999
.
PADI1600  MATCH     SP70,FILTHOSP
          IF        @EQUAL
            IF        FILTFLAG=0
              MOVE      WBSEHOSP,FILTHOSP
            ENDIF
          ENDIF
          CALL      HSEL0000                * Hospital Selection List
          GOTO      PADI9999
.
PADI1700  PACK      CATEGORY,ANSS,SP70         * Admission source
          MOVE      ADMSOURC,CODE
          CALL      CODSEL00
          GOTO      PADI9999
.
PADI1800  WRITE     HTMLFILE;DEFTVIEW;
          GOTO      PADI9999
.
PADI9999  RETURN
.------------------------------------------------------------
. Table of Patient Discharges 
.------------------------------------------------------------
TODP0000  CALL      TABHED00  
          PACK      KEY16,FRSTDATE,SP70 
          CALL      RDSDSCH2
TODP1000  CALL      RDKDSCH2
          BRANCH    OVRCD,TODP9999
          MATCH     DDATE,LASTDATE
          GOTO      TODP9999 IF LESS
.
          MOVE      DADMNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,TODP1000
.
          MOVE      DADMNO,KEY8
          CALL      RDPMVX11
          BRANCH    OVRCD,TODP1000
.
          MATCH     SP3,CLAIMCOD
          IF        !@EQUAL
            MATCH     ACLAIM,CLAIMCOD           * Check claim code
            GOTO      TODP1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP3,UNITCODE
          IF        !@EQUAL
            CALL      RTRN0000                 * read transfer file to get unit
            MATCH     TDEPT,UNITCODE
            GOTO      TODP1000 IF NOT EQUAL    * Check department
          ENDIF
.
          PACK      PATTYPES,PATTYPES,SP70
          MATCH     SP3,PATTYPES
          IF        !@EQUAL
            MATCH     PMVXIDUS,PATTYPES
            GOTO      TODP1000 IF NOT EQUAL       * Check department
          ENDIF
.
          PACK      ADMSOURC,ADMSOURC,SP70
          MATCH     SP3,ADMSOURC
          IF        !@EQUAL
            MATCH     ASRCE,ADMSOURC
            GOTO      TODP1000 IF NOT EQUAL       * Check admission source
          ENDIF
.
          IF        IBCNMHOS=1
            MATCH     SP70,FILTHOSP
            IF        !@EQUAL
              MATCH     FILTHOSP,PMVXMHOS
              GOTO      TODP1000 IF NOT EQUAL
            ELSE
              PACK      KEY13,USERID,SP70              * All hospital access
              CALL      RDMLSEC1
              IF        OVRCD=1
                PACK      KEY13,USERID,PMVXMHOS,SP70   * This hospital access
                CALL      RDMLSEC1
                BRANCH    OVRCD,TODP1000
              ENDIF
            ENDIF
          ENDIF
.
          PACK      WARDCODE,WARDCODE,SP70
          MATCH     SP3,WARDCODE
          IF        !@EQUAL
            MATCH     PTDSDWRD,WARDCODE
            GOTO      TODP1000 IF NOT EQUAL       * Check Wrad
          ENDIF
. 
          CALL      DISDAT00
          PACK      DSCHDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          CALL      DISTIM00
          PACK      DSCHTIME,DIM2,DIM1,DIM2A,SP2,DIM2B
.
          CALL      ADMDAT00
          PACK      ADMNDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          MOVE      AURNO,URNO
.
          MOVE      DTIME,SAVDTIME
          MOVE      ATIME,DTIME
          CALL      DISTIM00
          PACK      ADMTIME,DIM2,DIM1,DIM2A,SP2,DIM2B
.
          PACK      URNUMBER,AURNO 
          PACK      ADMISSNO,AADMNO
.
          CALL      DISCON00
          GOTO      TODP1000
.
TODP9999  RETURN
.------------------------------------------------------------
. Patient Admission by Date    
.------------------------------------------------------------
PAAD0000  BRANCH    FLDITMNO,PAAD0100,PAAD0200,PAAD0300,PAAD0400:
                             PAAD0500,PAAD0600,PAAD0700,PAAD0800:
                             PAAD0900,PAAD1000,PAAD1100,PAAD1200:
                             PAAD1300,PAAD1400,PAAD1500,PAAD1600
.
PAAD0100  CALL      NEXT0000
          GOTO      PAAD9999
.
PAAD0200  CALL      PREV0000
          GOTO      PAAD9999
.
PAAD0300  CALL      CURSTD00
          GOTO      PAAD9999
.
PAAD0400  CALL      CUREND00
          GOTO      PAAD9999
.
PAAD0500  CALL      CURYR000
          GOTO      PAAD9999
.
PAAD0600  CALL      CURMON00
          GOTO      PAAD9999
.
PAAD0700  CALL      SELV0000
          GOTO      PAAD9999
.
PAAD0800  MOVE      ZERO,GOTGFLAG
          CALL      TOPA0000                * Admission list no goto button
          GOTO      PAAD9999
.
PAAD0900  WRITE     HTMLFILE;TEMPLATE;
          GOTO      PAAD9999
.
PAAD1000  WRITE     HTMLFILE;REPORTNO;
          GOTO      PAAD9999
.
PAAD1100  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      PAAD9999
.
PAAD1200  CALL      CANC0000
          GOTO      PAAD9999
.
PAAD1300  MOVE      CODEAC,CATEGORY         * unit code
          MOVE      UNITCODE,CODE
          CALL      CODSEL00
          GOTO      PAAD9999
.
PAAD1400  PACK      DFLTWARD,WARDCODE  
          CALL      WSEL0000                * Ward Selection List
          GOTO      PAAD9999 
.
PAAD1500  CALL      EXDS0000                * Expected Discharge List
          GOTO      PAAD9999
.
PAAD1600  MOVE      ONE,GOTGFLAG
          CALL      TOPA0000                * Admission list with goto button
          GOTO      PAAD9999
.
PAAD9999  RETURN
.------------------------------------------------------------
. Table of Cancellations         
.------------------------------------------------------------
CANC0000  IF        LNK2PRT<>1
            UNPACK    DIM127,D1,LINKPRG,DIM127
            UNPACK    DIM127,D1,LINKREP,DIM127
            UNPACK    DIM127,D1,LINKTEM,DIM127
          ENDIF
.
          PACK      KEY16,FRSTDATE,SP70
          CALL      RDSMISS3
CANC1000  CALL      RDKMISS3
          BRANCH    OVRCD,CANC9000
          MATCH     ADATE,LASTDATE
          GOTO      CANC9000 IF LESS
          COMPARE   "5",ASTAT
          GOTO      CANC1000 IF NOT EQUAL
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,CANC1000
.
          IF        IBCNMHOS<>1
            GOTO      CANC1500
          ENDIF
.
          MATCH     SP70,WBSEHOSP
          GOTO      CANC1500 IF EQUAL
.
          MATCH     WBSEHOSP,PMVXMHOS
          GOTO      CANC1000 IF NOT EQUAL
.
CANC1500  PACK      URNUMBER,AURNO
          PACK      ADMISSNO,AADMNO
          MOVE      AURNO,URNO
          CALL      GETPAT00      * Get Patient Details
          CALL      GETADC00      * Get Attending Doctor Details
          CALL      ADMDAT00      * Get Admission Date & Time
          CALL      PATLN000      * Format Patient Name with System Paramater
.
          IF        LNK2PRT=1
            CLEAR     PATLINK
            CALL      JAVNAM00
            APPEND    "OnClick=#"updateParent('",PATLINK
            APPEND    JAVFNAME,PATLINK
            APPEND    "','",PATLINK
            APPEND    ADMISSNO,PATLINK
            APPEND    "')#">",PATLINK
          ELSE
            REP       " +",ADMISSNO
            REP       " +",URNUMBER
.
            CLEAR     PATLINK
            APPEND    LINKPRG,PATLINK
            APPEND    ".pbl?reportno=",PATLINK
            APPEND    LINKREP,PATLINK
            APPEND    "&template=",PATLINK
            APPEND    LINKTEM,PATLINK
            APPEND    "&urnumber=",PATLINK
            APPEND    URNUMBER,PATLINK
            APPEND    "&admissno=",PATLINK
            APPEND    ADMISSNO,PATLINK
            RESET     PATLINK
          ENDIF
.
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
          CLEAR     UPDLINK
          APPEND    "javascript:UpdatePatient('",UPDLINK
          APPEND    URNUMBER,UPDLINK
          APPEND    "','",UPDLINK
          APPEND    ADMISSNO,UPDLINK
          APPEND    "')",UPDLINK
          RESET     UPDLINK
.
          MATCH     SP70,ADATE
          IF        @EQUAL
            MOVE      "&nbsp;",KEY11
          ELSE
            UNPACK    ADATE,KEY4,CMON,CDAY
            MOVE      KEY4,F4
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      KEY12,CDAY,SP1,MTHNAM3,SP1,F4
          ENDIF
.
          MOVE      "PC",CATEGORY  
          MOVE      ACANCEL,CODE  
          CALL      GETCOD00     

          WRITE     HTMLFILE;"t.addRow(#"",PATLINK,"#",":
                             "#"",FORMATNM,"#",":
                             "#"",URNUMBER,"#",":
                             "#"",KEY12,"#",":
                             "#"",DISPSEX,"#",":
                             "#"",TDESC,"#",":
                             "#"";
          CALL      WRTAGE00
          CALL      PATFLD00               *Returns KEY3 for folder colour code
.
          REP       "#" ",ADIAG1
          REP       "#" ",ADIAG2
          WRITE     HTMLFILE;"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",ADIAG1,ADIAG2,"#",":
                             "#"",UPDLINK,"#",":
                             "#"",KEY3,"#");"
.
          GOTO      CANC1000
.
CANC9000
CANC9999  RETURN
.------------------------------------------------------------
. Table of Patient Admissions
.------------------------------------------------------------
TOPA0000  CALL      TABHED00  
.
          COMPARE   ONE,GOTGFLAG
          GOTO      TOPA0500 IF NOT EQUAL        * Not using goto button
.   
          MATCH     "1",GOBTFORM                 * Do not display records when
          GOTO      TOPA9000 IF NOT EQUAL        * selected from a menu
.
TOPA0500  PACK      KEY16,FRSTDATE,SP70 
          CALL      RDSMISS3
TOPA1000  CALL      RDKMISS3
          BRANCH    OVRCD,TOPA9000
          MATCH     ADATE,LASTDATE
          GOTO      TOPA9000 IF LESS
          MATCH     "1",DASTAT
          GOTO      TOPA1000 IF EQUAL
          MATCH     "5",DASTAT
          GOTO      TOPA1000 IF EQUAL
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,TOPA1000
.
          IF        IBCNMHOS<>1
            GOTO      TOPA1500
          ENDIF
.
          MATCH     SP70,WBSEHOSP
          GOTO      TOPA1500 IF EQUAL
.
          MATCH     WBSEHOSP,PMVXMHOS
          GOTO      TOPA1000 IF NOT EQUAL
.
TOPA1500  PACK      KEY30,DAADMNO,SP70
          CALL      RDSTRAN2
          CALL      RDKTRAN2
          BRANCH    OVRCD,TOPA2000
.
          MATCH     DTADMN,DAADMNO
          IF        @EQUAL
            MOVE      TWARD,AWARD
            MOVE      TBED,ABED
            MOVE      TDEPT,ACLSSFT
            MOVE      TADOCT,ADOCTA
          ENDIF
.
          MATCH     SP3,UNITCODE
          IF        !@EQUAL
            MATCH     ACLSSFT,UNITCODE
            GOTO      TOPA1000 IF NOT EQUAL    * Check department
          ENDIF
.
TOPA2000  PACK      WARDCODE,WARDCODE,SP70
          MATCH     SP3,WARDCODE
          IF        !@EQUAL
            MATCH     AWARD,WARDCODE
            GOTO      TOPA1000 IF NOT EQUAL    * Check Ward 
          ENDIF
.
.
.
..................          PACK      COLDAT02,AWARD,SLASH,ABED
.
          CALL      ADMDAT00
          PACK      ADMNDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          PACK      ADMNDATT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,DIM4,ATIME
.
          PACK      URNUMBER,AURNO 
          PACK      ADMISSNO,AADMNO
          MOVE      AURNO,URNO
.
          CALL      ADMCON00
.
          GOTO      TOPA1000
.
TOPA9000  
.
TOPA9999  RETURN
.
.------------------------------------------------------------
. Expected Discharge List
.------------------------------------------------------------
EXDS0000  CALL      TABHED00
          PACK      KEY9,TWO,SP70
          CALL      RDSMISS2
EXDS1000  CALL      RDKMISS2
          BRANCH    OVRCD,EXDS9999
          MATCH     "2",DASTAT              * Is it still Current Adm Record?
          GOTO      EXDS9999 IF NOT EQUAL   * No, go to exit
.
          PACK      WARDCODE,WARDCODE,SP70
          MATCH     SP3,WARDCODE
          IF        !@EQUAL
            MATCH     AWARD,WARDCODE        * Check Ward against Filter
            GOTO      EXDS1000 IF NOT EQUAL
          ENDIF
.
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      ASTAY,ADJDAYS
          CALL      ADJDAT00
          PACK      EXDSCDTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      EXPCTDSC,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MATCH     EXDSCDTE,LASTDATE       * Expected to be discharged?
          GOTO      EXDS1000 IF LESS        * No, do not display, next record
.
          CLEAR     EXDSCFLD                * Clear Expected Discharge Field
          MATCH     EXDSCDTE,LASTDATE       * Is Discharge Overdue?
          IF        @EQUAL
            APPEND    EXPCTDSC,EXDSCFLD     * No, Show Disch Date in black font
          ELSE
            APPEND    "<font color=red>",EXDSCFLD
            APPEND    EXPCTDSC,EXDSCFLD     * Yes, Show Disch Date in red font
            APPEND    "</font>",EXDSCFLD
          ENDIF
          RESET     EXDSCFLD
.
          CALL      ADMDAT00
          PACK      ADMNDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          PACK      ADMNDATT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,DIM4,ATIME
.
          PACK      URNUMBER,AURNO
          PACK      ADMISSNO,AADMNO
          MOVE      AURNO,URNO
.
          CALL      EXDCON00
.
          GOTO      EXDS1000
.
EXDS9999  RETURN
.------------------------------------------------------------
. Patient Pre-Admission by Date Range   
.------------------------------------------------------------
PAPR0000  BRANCH    FLDITMNO,PAPR0100,PAPR0200,PAPR0300,PAPR0400,PAPR0500:
                             PAPR0600,PAPR0700,PAPR0800,PAPR0900,PAPR1000:
                             PAPR1100,PAPR1200,PAPR1300,PAPR1400,PAPR1500:
                             PAPR1600,PAPR1700,PAPR1800
.
PAPR0100  CALL      NEXT0000
          GOTO      PAPR9999
.
PAPR0200  CALL      PREV0000
          GOTO      PAPR9999
.
PAPR0300  CALL      CURSTD00
          GOTO      PAPR9999
.
PAPR0400  CALL      CUREND00
          GOTO      PAPR9999
.
PAPR0500  CALL      CURYR000
          GOTO      PAPR9999
.
PAPR0600  CALL      CURMON00
          GOTO      PAPR9999
.
PAPR0700  CALL      SELV0000
          GOTO      PAPR9999
.
PAPR0800  CALL      TOPR0000
          GOTO      PAPR9999
.
PAPR0900  WRITE     HTMLFILE;TEMPLATE;
          GOTO      PAPR9999
.
PAPR1000  WRITE     HTMLFILE;REPORTNO;
          GOTO      PAPR9999
.
PAPR1100  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      PAPR9999
.
PAPR1200  MOVE      CODEAC,CATEGORY         * unit code
          MOVE      UNITCODE,CODE
          CALL      CODSEL00
          GOTO      PAPR9999
.
PAPR1300  PACK      DFLTWARD,WARDCODE
          CALL      WSEL0000                * Ward Selection List
          GOTO      PAPR9999
.
PAPR1400  CALL      ASEC0000                * Admission Point Select List
          GOTO      PAPR9999
.
PAPR1500  MOVE      "ap",CATEGORY           * Admitting point select list
          MOVE      ADPOINTS,CODE
          CALL      CODSEL00
          GOTO      PAPR9999
.
PAPR1600  PACK      DFLTWARD,FILTWARD                                  
          CALL      WSEL0000                * Ward Selection List
          GOTO      PAPR9999
.
PAPR1700  CALL      SETL0000                * Care Type Colour Mapping Legend
          GOTO      PAPR9999
.
PAPR1800  WRITE     HTMLFILE;SUPERLEV;      * Supervisor menu flag
          GOTO      PAPR9999
.
PAPR9999  RETURN
.------------------------------------------------------------
. Table of Patient Pre-Admissions
.------------------------------------------------------------
TOPR0000  IF        LNK2PRT<>1
            UNPACK    DIM127,D1,LINKPRG,DIM127
            UNPACK    DIM127,D1,LINKREP,DIM127
            UNPACK    DIM127,D1,LINKTEM,DIM127
          ENDIF
.
          PACK      KEY16,FRSTDATE,SP70 
          CALL      RDSMISS3
TOPR1000  CALL      RDKMISS3
          BRANCH    OVRCD,TOPR9000
          MATCH     ADATE,LASTDATE
          GOTO      TOPR9000 IF LESS
          COMPARE   "1",ASTAT
          GOTO      TOPR1000 IF NOT EQUAL
.
          MATCH     SP3,UNITCODE
          IF        !@EQUAL
            MATCH     ACLSSFT,UNITCODE
            GOTO      TOPR1000 IF NOT EQUAL    * Check department (unit)
          ENDIF
.
          PACK      WARDCODE,WARDCODE,SP70
          MATCH     SP3,WARDCODE
          IF        !@EQUAL
            MATCH     PTMIXWRD,WARDCODE
            GOTO      TOPR1000 IF NOT EQUAL    * Check Ward
          ENDIF
.
          MOVE      AADMNO,PMVXVISN            * Find Visit extension record
          PACK      KEY8,PMVXVISN,SP70
          CALL      RDPMVX11
          IF        OVRCD=1
            MOVE      SP70,PATPST01 
            GOTO      TOPR2000
          ENDIF
.
          IF        IBCNMHOS<>1
            GOTO      TOPR1500
          ENDIF
.
          MATCH     SP70,WBSEHOSP
          GOTO      TOPR1500 IF EQUAL
.
          MATCH     SP70,PMVXMHOS
          GOTO      TOPR1500 IF EQUAL
.
          MATCH     WBSEHOSP,PMVXMHOS
          GOTO      TOPR1000 IF NOT EQUAL
.
TOPR1500  PACK      ADPOINTS,ADPOINTS,SP70
          MATCH     SP3,ADPOINTS
          IF        !@EQUAL
            MATCH     PMVXAPWD,ADPOINTS
            GOTO      TOPR1000 IF NOT EQUAL    * Check Admission Points
          ENDIF
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDBKRX11
          IF        OVRCD=1
            CALL      CLBOKRX1
          ENDIF
.
          MATCH     SP70,FILTWARD
          IF        !@EQUAL
            MATCH     SP70,PMVXPOWD
            IF        @EQUAL | @EOS
              MATCH     BKRXPOWD,FILTWARD
            ELSE
              MATCH     PMVXPOWD,FILTWARD
            ENDIF
            GOTO      TOPR1000 IF NOT EQUAL    * Check Post Op Ward
          ENDIF
.
          MATCH     "1",PMVXPSTY
          IF        @EQUAL
            MOVE      "Yes",PATPST01        * if Parent staying Yes
          ENDIF
.
TOPR2000  MOVE      SP1,KEY1
          PACK      URNUMBER,AURNO 
          PACK      ADMISSNO,AADMNO 
          MOVE      AURNO,URNO
          CALL      GETPAT00      * Get Patient Details
          CALL      GETADC00      * Get Attending Doctor Details
          CALL      ADMDAT00      * Get Admission Date & Time
          CALL      PATLN000      * Format Patient Name with System Parameter
          CALL      GETNZSP0      * get NZ Priv Proc/Funder Det       *I-174484
          CALL      LSTALR00      * Set alert image and link
          CALL      CHKAID00      * set flag if an Alternate Id exists*I-174484
.
          MOVE      CATAC,CATEGORY          * Unit Description
          MOVE      ACLSSFT,CODE
          CALL      GETCOD00
          MOVE      TDESC,UNITDESC          * save unit description
.
          PACK      CATEGORY,ANSA,SP70      * Specialty Description
          MOVE      ATYPE,CODE
          CALL      GETCOD00
          MOVE      TDESC,ATYPDESC          * save specialty description
.                                           * Get care type colour code
          PACK      DIM1,SP20
          PACK      DISPCLSS,SP20
          PACK      DISPALTD,SP70
          PACK      KEY5,ANSC,ANSC,ACARE,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            UNPACK      TCINDC21,DIM1
          ENDIF
          MATCH     DIM1,SP70
          IF        !@EQUAL
            PACK      DISPCLSS,ONCLCLSS,DIM1,SP70
            PACK      DISPALTD,PTCDLDES,SP70
          ENDIF
          SQUEEZE   DISPCLSS
          STRIP     DISPALTD
.
          MOVE      SP70,DRORDESC
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDBKRX11
          IF        OVRCD=1
            CALL      CLBOKRX1
          ELSE
            MOVE      "Ba",CATEGORY
            MOVE      BKRXDROR,CODE
            CALL      GETCOD00
            MOVE      TDESC,DRORDESC
          ENDIF
.
          IF        LNK2PRT=1
            CLEAR     PATLINK
            CALL      JAVNAM00
            APPEND    "OnClick=#"updateParent('",PATLINK
            APPEND    JAVFNAME,PATLINK
            APPEND    "','",PATLINK
            APPEND    ADMISSNO,PATLINK
            APPEND    "')#">",PATLINK
          ELSE
            REP       " +",ADMISSNO
            REP       " +",URNUMBER
.
            CLEAR     PATLINK
            APPEND    LINKPRG,PATLINK
            APPEND    ".pbl?reportno=",PATLINK
            APPEND    LINKREP,PATLINK
            APPEND    "&template=",PATLINK
            APPEND    LINKTEM,PATLINK
            APPEND    "&urnumber=",PATLINK
            APPEND    URNUMBER,PATLINK
            APPEND    "&admissno=",PATLINK
            APPEND    ADMISSNO,PATLINK
            RESET     PATLINK
.
          ENDIF
.
          CALL      CCRD0000                  * Check for credit notes
.
          CLEAR     UPDLINK
          APPEND    "javascript:UpdatePatient('",UPDLINK
          APPEND    URNUMBER,UPDLINK
          APPEND    "','",UPDLINK
          APPEND    ADMISSNO,UPDLINK
          APPEND    "','",UPDLINK
          APPEND    FORM1,UPDLINK
          APPEND    "')",UPDLINK
          RESET     UPDLINK
.
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
          WRITE     HTMLFILE;"t.addRow(#"",PATLINK,"#",":          * 0
                             "#"",FORMATNM,"#",":                  * 1
                             "#"",URNUMBER,"#",":                  * 2
                             "#"",ADATE,ATIME,"#",":               * 3
                             "#"",PTMIXWRD,"#",":                  * 4
                             "#"",DISPSEX,"#",":                   * 5
                             "#"";
          CALL      WRTAGE00                                       * 6
          CALL      PATFLD00               *Returns KEY3 for folder colour code
.
          REP       "#" ",ADIAG1
          REP       "#" ",ADIAG2
          WRITE     HTMLFILE;"#",":
                             "#"",DOCFNAME,"#",":                  * 7
                             "#"",ADIAG1,ADIAG2,"#",":             * 8
                             "#"",UNITDESC,"#",";                  * 9
          PACK      KEY6,AWARD,SP70
          CALL      FWBD0000
          WRITE     HTMLFILE;"#"",WARDTEXT,"#",";                  * 10
.
          MOVE      "ap",CATEGORY 
          MOVE      PMVXAPWD,CODE      * Admitting point Cat ap 
          CALL      GETCOD00
          MOVE      TDESC,APOIDESC
.
          WRITE     HTMLFILE;"#"",APOIDESC,"#",":                  * 11
                             "#"",PATPST01,"#",":                  * 12
                             "#"",UPDLINK,"#",":                   * 13
                             "#"",KEY3,"#",":                      * 14
                             "#"",ATYPDESC,"#",";                  * 15
          PACK      KEY6,PTMIXWRD,PTMIEBED,SP70
          CALL      FWBD0000
          WRITE     HTMLFILE;"#"",WBEDTEXT,"#",":                  * 16
                             "#"javascript:LinkPatient('",PATLINK,"') #","; *17
.
.                                           ****** start of addition  *I-174484
          REP       "#" ",NZSPPDES
          CLEAR     DIM100A
          APPEND    "<a href=javascript:DoctorViewFrame('",DIM100A
          STRIP     ADOCTA
          APPEND    ADOCTA,DIM100A
          APPEND    "') >",DIM100A
          APPEND    DOCFNAME,DIM100A
          APPEND    "</a>",DIM100A
          RESET     DIM100A
.
.                                           * setup Alt.Id. & Legacy Icons
          CLEAR     DIM100B 
          IF        ALTIDFLG = 1
            APPEND    "<img src=../images/AlternateID_Icon.gif>",DIM100B
          ELSE
            APPEND    "<img src=../images/Blank.gif>",DIM100B
          ENDIF
          MATCH     "1",PTMXSIN5            * Legacy Visits Indic.
          IF        @EQUAL
            APPEND    "&nbsp; &nbsp;",DIM100B
            APPEND    "<img src=../images/legacy.gif>",DIM100B
          ENDIF
          RESET     DIM100B
.
          CLEAR     DIM200C                 * set up Pat.Alerts & Hearing Icons
          MATCH     SP70,ALRTIMGE
          IF        !@EQUAL
            REP       " +",URNUMBER
            REP       " +",ADMISSNO
            APPEND    "<a href=javascript:onclick=viewAlert('",DIM200C
            APPEND    URNUMBER,DIM200C
            APPEND    "','",DIM200C
            APPEND    ADMISSNO,DIM200C
            APPEND    "')>",DIM200C
            APPEND    ALRTIMGE,DIM200C
            APPEND    "</a>",DIM200C
            REP       "+ ",URNUMBER
            REP       "+ ",ADMISSNO
          ELSE
            APPEND    "<img src=../images/Blank.gif>",DIM200C
          ENDIF
          PACK      KEY5,ANSD,ANSK,PTMXDEAF,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            MATCH     TCINDC1,ANSD
            IF        @EQUAL
              APPEND    "&nbsp; &nbsp;",DIM200C
              APPEND    "<img src=../images/deaf.gif>",DIM200C
            ENDIF
          ENDIF
          RESET     DIM200C
.
          WRITE     HTMLFILE;"#"",DIM100A,"#",":                   * 18
                             "#"",NZSPPDES,"#",":                  * 19
                             "#"",DIM100B,"#",":                   * 20
                             "#"",DIM200C,"#",":                   * 21
                             "#"",ASTAY,"#",";                     * 22
          PACK      KEY6,PTMIXWRD,SP70
          CALL      FWBD0000
          WRITE     HTMLFILE;*+,"#"",WARDTEXT;                     * 23 part 1
.
          MATCH     SP70,PMVXPOWD
          IF        @EQUAL | @EOS
            PACK      KEY6,BKRXPOWD,SP70
          ELSE
            PACK      KEY6,PMVXPOWD,SP70
          ENDIF
.
          CALL      FWBD0000
          WRITE     HTMLFILE;*+,"<br />",WARDTEXT,"#",":           * 23 part 2
                             "#"",DISPCLSS,"#",":                  * 24
                             "#"",DISPALTD,"#",":                  * 25
                             "#"",DRORDESC,"#",";                  * 26
.
.------------------------------------------------------------------------------
. CAR 310749
          MOVE      "DC",CATEGORY
          MOVE      ADIET,CODE
          CALL      GETCOD00
.
          WRITE     HTMLFILE;"#"";
.
          REP       " +",TDESC
          WRITE     HTMLFILE;"<input type=hidden name='",TDESC,"'>";
          REP       "+ ",TDESC
.
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
.
          IF        PTCNHDPS = ONE
            WRITE     HTMLFILE;"<img src=../images/DietIcon.gif ":
                               " class=ListIcon onclick=UpdateDiet('":
                               URNUMBER,"','",ADMISSNO,"','",ADATE,"')'>":
                               TDESC,"<br> ",PMVXUDF4,"#",";
          ELSE
            WRITE     HTMLFILE;"<img src=../images/DietIcon.gif ":
                               " class=ListIcon onclick=UpdateDiet('":
                               URNUMBER,"','",ADMISSNO,"','",ADATE,"')>":
                               TDESC,"#",";
          ENDIF
.
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
.------------------------------------------------------------------------------
. External Visit
          CLEAR     EXTVSTID
          CLEAR     CHKEXTVD
          PACK      CHKEXTVD,ADMISSNO,SP70
          PROC      CHKEID00
          MATCH     KEY20,SP70
          IF        @EQUAL
            PACK      EXTVSTID,ADMISSNO
          ELSE
            APPEND    ADMISSNO,EXTVSTID
            APPEND    SP2,EXTVSTID
            APPEND    "<span class='TextBlue'>(",EXTVSTID
            APPEND    KEY20,EXTVSTID
            APPEND    ")</span>",EXTVSTID
          ENDIF
          WRITE     HTMLFILE;"#"",EXTVSTID,"";                      * 27
          WRITE     HTMLFILE;"#");"                                 * 28
.
.------------------------------------------------------------------------------
.
          GOTO      TOPR1000
.
TOPR9000  
TOPR9999  RETURN
.
.------------------------------------------------------------
. Care Type Colour Mapping Legend
.------------------------------------------------------------
SETL0000  PACK      DIM1,SP20
          PACK      DISPCLSS,SP20
          MOVE      ZERO,FORM1
.
          PACK      KEY5,ANSC,ANSC,SP70
          CALL      RDSCODE1
SETL1000  CALL      RDKCODE1
          BRANCH    OVRCD,SETL5000
.
          MATCH     CATCC,TCODE
          GOTO      SETL5000 IF NOT EQUAL
.
          MATCH     "A",PTCOACTV
          GOTO      SETL1000 IF NOT EQUAL
.
          UNPACK    TCINDC21,DIM1
          MATCH     DIM1,SP70
          GOTO      SETL1000 IF EQUAL
.
          MOVE      ONE,FORM1
          PACK      DISPCLSS,ONCLCLSS,DIM1,SP70
          WRITE     HTMLFILE;"<tr>":
                             "<td width=10%>&nbsp;</td>":
                             "<td width=5% class=":
                             "#"",DISPCLSS,"#">&nbsp;</td>":
                             "<td class=#"DataLabel#">&nbsp;&nbsp;",PTCDLDES:
                             "</td></tr>"
          GOTO      SETL1000
.
SETL5000  COMPARE   ONE,FORM1
          GOTO      SETL9999 IF EQUAL
.
          WRITE     HTMLFILE;"<tr>":
                             "<td colspan=3 align=center class=#"DataLabel#">":
                             "No Care Type Colour Mapping Configured":
                             "</td></tr>"
.
SETL9999  RETURN
.
.------------------------------------------------------------
. Get NZ data for Southern Cross                                      *I-174484
.------------------------------------------------------------
GETNZSP0  COMPARE   ONE,PTCNHDPS            * Full Procedure Description
          GOTO      GETNZSP8 IF NOT EQUAL
.
          PACK      KEY11,ADMISSNO,SP20
          CALL      RSNZSPR1
GETNZSP1  CALL      RKNZSPR1
          BRANCH    OVRCD,GETNZSP8
.
          MATCH     NZSPADMN,ADMISSNO
          GOTO      GETNZSP8 IF NOT EQUAL
          COMPARE   ONE,NZSPPRIM
          GOTO      GETNZSP1 IF NOT EQUAL   * Not a primary procedure
          GOTO      GETNZSP9
.
GETNZSP8  MOVE      SP70,NZSPPDES
.
GETNZSP9  RETURN
.------------------------------------------------------------
. Set flag if Alternate Id. exists                                    *I-174484
.------------------------------------------------------------
CHKAID00  MOVE      ZERO,ALTIDFLG
          PACK      KEY31,URNUMBER,SP20
          CALL      RSPMAID1
          CALL      RKPMAID1
          BRANCH    OVRCD,CHKAID99
.
          MATCH     URNUMBER,PMAIURNO
          GOTO      CHKAID99 IF NOT EQUAL
.
          MOVE      ONE,ALTIDFLG
.
CHKAID99  RETURN
.------------------------------------------------------------
. Check for credit note
.------------------------------------------------------------
CCRD0000  MOVE      ZERO,FORM1
          OPEN      PMSCNOA2,"pmscnoaf"
          PACK      KEY16,ADMISSNO,SP20
          CALL      RSPMCNO2
CCRD1000  CALL      RKPMCNO2
          BRANCH    OVRCD,CCRD9000
          MATCH     ADMISSNO,PMCNVISN      * Same admission no?
          GOTO      CCRD9000 IF NOT EQUAL
          MOVE      ONE,FORM1              * found credit note
CCRD9000  CLOSE     PMSCNOA2
CCRD9999  RETURN
+
.------------------------------------------------------------
. Get Attending Doctor
.------------------------------------------------------------
GETADC00  MOVE      SP70,DOCFNAME
          MOVE      ADOCTA,KEY6
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE       * I CAR 13038
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000             * end I CAR 13038
          ENDIF
          RETURN
.------------------------------------------------------------
. Search Internal Phone List            
.------------------------------------------------------------
PHON0000  BRANCH    FLDITMNO,PHON0100,PHON0200,PHON0300,PHON0400
          GOTO      PHON9999
.
PHON0100  MOVE      CODEDZ,CATEGORY
          MOVE      SRCHDEPT,CODE
          CALL      CODSEL00
.
          GOTO      PHON9999
.
PHON0200  UNPACK    DIM127,D1,LINKPRG,DIM127 
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          CALL      TOEN0000
          GOTO      PHON9999
.
. Link to Next Group
.--------------------
.
PHON0300  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          CLEAR     HTMLLINK
          APPEND    "&srchdept=",HTMLLINK
          STRIP     SRCHDEPT
          APPEND    SRCHDEPT,HTMLLINK
          APPEND    "&srchextn=",HTMLLINK
          STRIP     SRCHEXTN
          APPEND    SRCHEXTN,HTMLLINK
          APPEND    "&srchsurn=",HTMLLINK
          STRIP     SRCHSURN
          APPEND    SRCHSURN,HTMLLINK
          APPEND    "&srchgivn=",HTMLLINK
          STRIP     SRCHGIVN
          APPEND    SRCHGIVN,HTMLLINK
          APPEND    "&srchtitl=",HTMLLINK
          STRIP     SRCHTITL
          APPEND    SRCHTITL,HTMLLINK
          RESET     HTMLLINK
          WRITE     HTMLFILE;"patweb92.pbl?reportno=5":
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 HTMLLINK;
          GOTO      PHON9999
.
. Link to Last Group
.--------------------
.
PHON0400  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM-NORECORD,F3
          IF        F3<0
            MOVE      ZERO,F3
          ENDIF
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          CLEAR     HTMLLINK
          APPEND    "&srchdept=",HTMLLINK
          STRIP     SRCHDEPT
          APPEND    SRCHDEPT,HTMLLINK
          APPEND    "&srchextn=",HTMLLINK
          STRIP     SRCHEXTN
          APPEND    SRCHEXTN,HTMLLINK
          APPEND    "&srchsurn=",HTMLLINK
          STRIP     SRCHSURN
          APPEND    SRCHSURN,HTMLLINK
          APPEND    "&srchgivn=",HTMLLINK
          STRIP     SRCHGIVN
          APPEND    SRCHGIVN,HTMLLINK
          APPEND    "&srchtitl=",HTMLLINK
          STRIP     SRCHTITL
          APPEND    SRCHTITL,HTMLLINK
          RESET     HTMLLINK
          WRITE     HTMLFILE;"patweb92.pbl?reportno=5":
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 HTMLLINK;
PHON9999  RETURN
.------------------------------------------------------------
. Table of Extension Numbers 
.------------------------------------------------------------
TOEN0000  WRITE     HTMLFILE;"<tr>":
                               "<td class=HeadingCell><b>Title</b></td>":
                               "<td class=HeadingCell><b>Name</b></td>":
                               "<td class=HeadingCell><b>Department</b></td>":
                               "<td class=HeadingCell><b>Extension</b></td>":
                               "<td class=HeadingCell><b>Pager</b></td>":
                               "<td class=HeadingCell><b>Phone</b></td>":
                             "</tr>";
.
          IF        NORECORD=0
            MOVE      "10",NORECORD       * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          PACK      SRCHDEPT,SRCHDEPT,SP3
          MATCH     SRCHDEPT,SP3
          IF        !@EQUAL
            CALL      SRCDEP00
            GOTO      TOEN9999
          ENDIF
.
          PACK      SRCHEXTN,SRCHEXTN,SP6
          MATCH     SRCHEXTN,SP6
          IF        !@EQUAL
            CALL      SRCEXT00
            GOTO      TOEN9999
          ENDIF
.
          PACK      SRCHSURN,SRCHSURN,SP25
          MATCH     SRCHSURN,SP25
          IF        !@EQUAL
            CALL      SRCSUR00
            GOTO      TOEN9999
          ENDIF
.
          PACK      SRCHTITL,SRCHTITL,SP20
          MATCH     SRCHTITL,SP20
          IF        !@EQUAL
            CALL      SRCTIT00
            GOTO      TOEN9999
          ENDIF
.
          PACK      SRCHGIVN,SRCHGIVN,SP30
          MATCH     SRCHGIVN,SP30
          IF        !@EQUAL
            CALL      SRCGIV00
            GOTO      TOEN9999
          ELSE
            CALL      SRCDEP00
          ENDIF
TOEN9999  RETURN
.-----------------------------------------------------------
. Table Contents of Internal Phone Lists by Department
.-----------------------------------------------------------
SRCDEP00  PACK      KEY67,SRCHDEPT,SRCHSURN,SP70 
          CALL      RSIBPHN2
SRCDEP10  CALL      RKIBPHN2
          BRANCH    OVRCD,SRCDEP90
          MATCH     SP70,SRCHDEPT
          IF        !@EQUAL
            MATCH     IBPHDEPT,SRCHDEPT
            GOTO      SRCDEP90 IF NOT EQUAL
          ENDIF
          PACK      SRCHSURN,SRCHSURN,SP25
          MATCH     SRCHSURN,SP25
          IF        !@EQUAL
            STRIP     SRCHSURN
            MATCH     SRCHSURN,IBPHSNAM
            GOTO      SRCDEP90 IF NOT EQUAL
          ENDIF
          PACK      SRCHTITL,SRCHTITL,SP20
          MATCH     SRCHTITL,SP20
          IF        !@EQUAL
            STRIP     SRCHTITL
            MATCH     SRCHTITL,IBPHTITL
            GOTO      SRCDEP10 IF NOT EQUAL
          ENDIF
          PACK      SRCHGIVN,SRCHGIVN,SP30
          MATCH     SRCHGIVN,SP30
          IF        !@EQUAL
            STRIP     SRCHGIVN
            MATCH     SRCHGIVN,IBPHGNAM
            GOTO      SRCDEP10 IF NOT EQUAL
          ENDIF
          PACK      SRCHEXTN,SRCHEXTN,SP6
          MATCH     SRCHEXTN,SP6
          IF        !@EQUAL
            STRIP     SRCHEXTN
            MATCH     SRCHEXTN,IBPHEXTN
            GOTO      SRCDEP10 IF NOT EQUAL
          ENDIF
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      SRCDEP10
          ENDIF
.
          CALL      TABIPL00
.
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      SRCDEP10 IF NOT EQUAL
.
SRCDEP90  
SRCDEP99  RETURN
.-----------------------------------------------------------
. Table Contents of Internal Phone Lists by Extension
.-----------------------------------------------------------
SRCEXT00  PACK      KEY61,SRCHEXTN,SP70 
          CALL      RSIBPHN4
SRCEXT10  CALL      RKIBPHN4
          BRANCH    OVRCD,SRCEXT90
          STRIP     SRCHEXTN
          MATCH     IBPHEXTN,SRCHEXTN
          GOTO      SRCEXT90 IF NOT EQUAL
          PACK      SRCHTITL,SRCHTITL,SP20
          MATCH     SRCHTITL,SP20
          IF        !@EQUAL
            STRIP     SRCHTITL
            MATCH     SRCHTITL,IBPHTITL
            GOTO      SRCEXT10 IF NOT EQUAL
          ENDIF
          PACK      SRCHSURN,SRCHSURN,SP25
          MATCH     SRCHSURN,SP25
          IF        !@EQUAL
            STRIP     SRCHSURN
            MATCH     SRCHSURN,IBPHSNAM
            GOTO      SRCEXT10 IF NOT EQUAL
          ENDIF
          PACK      SRCHGIVN,SRCHGIVN,SP30
          MATCH     SRCHGIVN,SP30
          IF        !@EQUAL
            STRIP     SRCHGIVN 
            MATCH     SRCHGIVN,IBPHGNAM
            GOTO      SRCEXT10 IF NOT EQUAL
          ENDIF
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      SRCEXT10
          ENDIF
.
          CALL      TABIPL00
.
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      SRCEXT10 IF NOT EQUAL
.
SRCEXT90  
SRCEXT99  RETURN
.-----------------------------------------------------------
. Table Contents of Internal Phone Lists by Surname   
.-----------------------------------------------------------
SRCSUR00  PACK      KEY61,SRCHSURN,SP70 
          CALL      RSIBPHN1
SRCSUR10  CALL      RKIBPHN1
          BRANCH    OVRCD,SRCSUR90
          STRIP     SRCHSURN
          MATCH     IBPHSNAM,SRCHSURN
          GOTO      SRCSUR90 IF NOT EQUAL
          PACK      SRCHTITL,SRCHTITL,SP20
          MATCH     SRCHTITL,SP20
          IF        !@EQUAL
            STRIP     SRCHTITL
            MATCH     SRCHTITL,IBPHTITL
            GOTO      SRCSUR10 IF NOT EQUAL
          ENDIF
          PACK      SRCHGIVN,SRCHGIVN,SP30
          MATCH     SRCHGIVN,SP30
          IF        !@EQUAL
            STRIP     SRCHGIVN
            MATCH     SRCHGIVN,IBPHGNAM
            GOTO      SRCSUR10 IF NOT EQUAL
          ENDIF
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      SRCSUR10
          ENDIF
.
          CALL      TABIPL00
.
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      SRCSUR10 IF NOT EQUAL
          GOTO      SRCSUR90
.
SRCSUR90  
SRCSUR99  RETURN
.-----------------------------------------------------------
. Table Contents of Internal Phone Lists by Title     
.-----------------------------------------------------------
SRCTIT00  PACK      KEY81,SRCHTITL,SP70 
          CALL      RSIBPHN5
SRCTIT10  CALL      RKIBPHN5
          BRANCH    OVRCD,SRCTIT90
          STRIP     SRCHTITL
          MATCH     IBPHTITL,SRCHTITL
          GOTO      SRCTIT90 IF NOT EQUAL
          PACK      SRCHGIVN,SRCHGIVN,SP30
          MATCH     SRCHGIVN,SP30
          IF        !@EQUAL
            STRIP     SRCHGIVN
            MATCH     SRCHGIVN,IBPHGNAM
            GOTO      SRCTIT10 IF NOT EQUAL
          ENDIF
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      SRCTIT10
          ENDIF
.
          CALL      TABIPL00
.
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      SRCTIT10 IF NOT EQUAL
          GOTO      SRCTIT90
.
SRCTIT90  
SRCTIT99  RETURN
.-----------------------------------------------------------
. Table Contents of Internal Phone Lists by Given Name
.-----------------------------------------------------------
SRCGIV00  PACK      KEY61,SRCHGIVN,SP70
          CALL      RSIBPHN3
SRCGIV10  CALL      RKIBPHN3
          BRANCH    OVRCD,SRCGIV90
          STRIP     SRCHGIVN
          MATCH     IBPHGNAM,SRCHGIVN
          GOTO      SRCGIV90 IF NOT EQUAL
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      SRCGIV10
          ENDIF
.
          CALL      TABIPL00
.
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      SRCGIV10 IF NOT EQUAL
          GOTO      SRCGIV90
.
SRCGIV90  
SRCGIV99  RETURN
.-----------------------------------------------------------
. Table Contents of Internal Phone Lists
.-----------------------------------------------------------
TABIPL00  MOVE      CODEDZ,CATEGORY
          MOVE      IBPHDEPT,CODE
          CALL      GETCOD00
          CALL      PERNAM00
.
          WRITE     HTMLFILE;"<tr valign=#"top#">":
                               "<td>&nbsp;",IBPHTITL,"</td>":
                               "<td>&nbsp;",IBPHGNAM,IBPHSNAM,"</td>":
                               "<td>&nbsp;",TDESC,"</td>":
                               "<td>&nbsp;",IBPHEXTN,"</td>";
.
          MATCH     SP70,IBPHPGCD
          IF        @EQUAL        
            WRITE     HTMLFILE;"<td>&nbsp;",IBPHPGNM,"</td>";
          ELSE
            WRITE     HTMLFILE;"<td>",IBPHPGNM," (",IBPHPGCD,")</td>";
          ENDIF
.                    
          WRITE     HTMLFILE;"<td>&nbsp;",IBPHCONT,"</td>":
                             "</tr>";
.
TABIPL99  RETURN
.------------------------------------------------------------
.Patient Booking by Date
.------------------------------------------------------------
PBOK0000  BRANCH    FLDITMNO,PBOK0100,PBOK0200,PBOK0300,PBOK0400,PBOK0500:
                             PBOK0600,PBOK0700,PBOK0800,PBOK0900,PBOK1000: * 10
                             PBOK1100,PBOK1200,PBOK1300,PBOK1400,PBOK1500:
                             PBOK1600,PBOK1700,PBOK1800,PBOK1900,PBOK2000: * 20
                             PBOK2100,PBOK2200,PBOK2300,PBOK2400,PBOK2500:
                             PBOK2600,PBOK2700,PBOK2800,PBOK2900,PBOK3000: * 30
                             PBOK3100,PBOK3200,PBOK3300,PBOK3400,PBOK3500:
                             PBOK3600,PBOK3700,PBOK3800,PBOK3900,PBOK4000: * 40
                             PBOK4100,PBOK4200,PBOK4300,PBOK4400,PBOK4500:
                             PBOK4600,PBOK4700,PBOK4800,PBOK4900,PBOK5000: * 50 
                             PBOK5100,PBOK5200,PBOK5300,PBOK5400,PBOK5500:
                             PBOK5600,PBOK5700
.
PBOK0100  CALL      NEXT0000
          GOTO      PBOK9999
.
PBOK0200  CALL      PREV0000
          GOTO      PBOK9999
.
PBOK0300  CALL      CURSTD00
          GOTO      PBOK9999
.
PBOK0400  CALL      CUREND00
          GOTO      PBOK9999
.
PBOK0500  CALL      CURYR000
          GOTO      PBOK9999
.
PBOK0600  CALL      CURMON00
          GOTO      PBOK9999
.
PBOK0700  CALL      SELV0000
          GOTO      PBOK9999
.
PBOK0800  MOVE      ZERO,BOOKLNEW
          CALL      TOPB0000                * Expected Discharge
          GOTO      PBOK9999
.
PBOK0900  WRITE     HTMLFILE;TEMPLATE;
          GOTO      PBOK9999
.
PBOK1000  WRITE     HTMLFILE;REPORTNO;
          GOTO      PBOK9999
.
PBOK1100  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      PBOK9999
.
.---------V9.00.B01----------------------------------------------------        
.
PBOK1200  PACK      DFLTWARD,WARDCODE
          CALL      WSEL0000                * Ward selection list
          GOTO      PBOK9999
.
PBOK1300  CALL      USEC0000                * Unit Selection List
          GOTO      PBOK9999
.                                           * D SRF 17693
.PBOK1400  CALL      ASEC0000               * Admin. Point Sel List
.          GOTO      PBOK9999               * end D SRF 17693
.
PBOK1400  MOVE      "ap",CATEGORY           * I SRF 17693
.          MOVE      WBSEWRD,CODE            * Set parameter
          MOVE      ADPOINTS,CODE
          CALL      CODITM00                * Look in patcodes for desc
          GOTO      PBOK9999                * end I SRF 17693
.
PBOK1500  MOVE      ZERO,KIDSONLY
          CALL      BPEA0000                * Bulk Printing Exp. Adm.
          GOTO      PBOK9999 
.
PBOK1600  WRITE     HTMLFILE;SCHDPRN1;
          GOTO      PBOK9999
.
PBOK1700  WRITE     HTMLFILE;SCHDPRN2;
          GOTO      PBOK9999
.
PBOK1800  WRITE     HTMLFILE;SCHDPRN3;
          GOTO      PBOK9999
.
PBOK1900  WRITE     HTMLFILE;LABELTYP;
          GOTO      PBOK9999
.
PBOK2000  WRITE     HTMLFILE;STATNCO1;
          GOTO      PBOK9999
.
PBOK2100  WRITE     HTMLFILE;STATNCO2;
          GOTO      PBOK9999
.
PBOK2200  WRITE     HTMLFILE;SCHDCOP1;
          GOTO      PBOK9999
.
PBOK2300  WRITE     HTMLFILE;SCHDCOP2;
          GOTO      PBOK9999
.
PBOK2400  WRITE     HTMLFILE;SCHDCOP3;
          GOTO      PBOK9999
.
PBOK2500  MOVE      "BC",CATEGORY
          MOVE      BKRECANC,CODE
          CALL      CODITM00
          GOTO      PBOK9999
.
PBOK2600  WRITE     HTMLFILE;DBOKURNO;
          GOTO      PBOK9999
.
PBOK2700  WRITE     HTMLFILE;DBOKADMN;
          GOTO      PBOK9999
.
PBOK2800  MOVE      ONE,BOOKLNEW
          CALL      TOPB0000                * Expected Discharge
          GOTO      PBOK9999
.
PBOK2900  WRITE     HTMLFILE;WTCNUSBC;
          GOTO      PBOK9999
.
PBOK3000  MOVE      "BE",CATEGORY
          MOVE      BKRXUDF1,CODE
          CALL      CODITM00
          GOTO      PBOK9999
.
PBOK3100  CALL      WATCOM00                * Waiting list comments
          GOTO      PBOK9999
.
PBOK3200  WRITE     HTMLFILE;ADPOINTS;      * Admitting point filter
          GOTO      PBOK9999
.
PBOK3300  MOVE      ONE,KIDSONLY
          CALL      BPEA0000                * Bulk Printing Exp. Adm.
          GOTO      PBOK9999 
.
PBOK3400  REP       " +",URNUMBER
          UNPACK    DIM127,D1,KEY8,DIM127
          UNPACK    DIM127,D1,KEY2,DIM127
          UNPACK    DIM127,D1,FLDPARA,DIM127
          WRITE     HTMLFILE;KEY8,".pbl?reportno=",KEY2:
                                 "&template=",FLDPARA:
                                 "&urnumber=",URNUMBER
          REP       "+ ",URNUMBER
          GOTO      PBOK9999
.
PBOK3500  CALL      SURG0000
          GOTO      PBOK9999
.
PBOK3600  IF          DEFTFLAG=0
            MOVE        WBSEWRD,WARDCODE    * default to user id ward
          ENDIF
          PACK      DFLTWARD,WARDCODE
          CALL      WSEL0000                * Ward selection list
          GOTO      PBOK9999
.
PBOK3700  MOVE      "CL",CATEGORY
          MOVE      CLAIMTYP,CODE
          CALL      CODITM00
          GOTO      PBOK9999
.
PBOK3800  CALL      TOPO0000
          GOTO      PBOK9999
.
PBOK3900  PACK      DFLTWARD,FILTWARD
          CALL      WSEL0000                * Ward Selection List
          GOTO      PBOK9999
.
PBOK4000  MOVE      "VI",CATEGORY
          MOVE      FILTSTAY,CODE
          CALL      CODITM00
          GOTO      PBOK9999
.
PBOK4100  WRITE     HTMLFILE;FILTOWRD;
          GOTO      PBOK9999
.
PBOK4200  PACK      DFLTWARD,FILTPWRD
          CALL      WSEL0000                * Ward selection list
          GOTO      PBOK9999
.
PBOK4300  WRITE     HTMLFILE;BKTYPCOL;
          GOTO      PBOK9999
.
PBOK4400  CALL      HFLST000                * List of Health fund
          GOTO      PBOK9999
.
PBOK4500  CALL      CCOM0000                * Check Complete selection
          GOTO      PBOK9999
.
PBOK4600  WRITE     HTMLFILE;PACAFLAG;
          GOTO      PBOK9999
.
PBOK4700  MOVE      "TP",CATEGORY
          MOVE      WLCATEGY,CODE
          CALL      CODITM00
          GOTO      PBOK9999
.
PBOK4800  WRITE     HTMLFILE;FILBCRDT;                          *T0870496
          GOTO      PBOK9999
.
PBOK4900  MOVE      ONE,BOOKCRDT                                *T0870496 
          MOVE      ONE,BOOKLNEW
          CALL      TOPB0000
          GOTO      PBOK9999
.
PBOK5000  WRITE     HTMLFILE;DFDTVIEW;                          *T0870496
          GOTO      PBOK9999
.
PBOK5100  WRITE     HTMLFILE;FILTBOOK;
          GOTO      PBOK9999
.
PBOK5200  STRIP     SLABELTY
          WRITE     HTMLFILE;SLABELTY;
          GOTO      PBOK9999
.
PBOK5300  STRIP     SSTATNC1 
          WRITE     HTMLFILE;SSTATNC1;
          GOTO      PBOK9999
.
PBOK5400  STRIP     SSTATNC2
          WRITE     HTMLFILE;SSTATNC2;
          GOTO      PBOK9999
.
PBOK5500  STRIP     SSCHDPR1
          WRITE     HTMLFILE;SSCHDPR1;
          GOTO      PBOK9999
.
PBOK5600  STRIP     SSCHDPR2
          WRITE     HTMLFILE;SSCHDPR2;
          GOTO      PBOK9999
.
PBOK5700  STRIP     SSCHDPR3
          WRITE     HTMLFILE;SSCHDPR3;
          GOTO      PBOK9999
.
PBOK9999  RETURN
.
.---------------------------------------------------------------------
.         List of Health fund
.---------------------------------------------------------------------
HFLST000  PACK      KEY54,SP70
          CALL      RDSFUND2
HFLST100  CALL      RDKFUND2
          BRANCH    OVRCD,HFLST999
          MATCH     SP70,HFTABL
          GOTO      HFLST210 IF EQUAL
          MATCH     "0000",HFTABL
          GOTO      HFLST100 IF NOT EQUAL
.
HFLST210  COMPARE   ONE,PHFTACT
          GOTO      HFLST100 IF EQUAL        * Inactive
.
          MATCH     HEALTHFN,HCODE
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",HCODE," selected>",HFNAME:
                               "</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",HCODE,">",HFNAME,"</option>"
          ENDIF
          GOTO      HFLST100
.
HFLST999  RETURN
+
.---------------------------------------------------------------------
.         Check Complete selection
.---------------------------------------------------------------------
CCOM0000  MATCH     "1",CHKCOMPL
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=Z>All</option>":
                              "<option value=1 selected>Complete</option>":
                              "<option value=2>Incomplete</option>";
          ELSE
            MATCH     "2",CHKCOMPL
            IF        @EQUAL
              WRITE     HTMLFILE;"<option value=Z>All</option>":
                                "<option value=1>Complete</option>":
                                "<option value=2 selected>Incomplete</option>";
            ELSE
              WRITE     HTMLFILE;"<option value=Z selected>All</option>":
                                "<option value=1>Complete</option>":
                                "<option value=2>Incomplete</option>";
            ENDIF
          ENDIF
.
CCOM9999  RETURN
+
.---------------------------------------------------------------------
.                                          called by PB0K0000
.            Routine for populationg Admin. Point combo box 
.-------------------------------------------------------------
ASEC0000  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,ASEC0010,ASEC0020    0=desc, 1=code, 2=select
.
          MATCH     SP70,WBSEWRD            * Description
          GOTO      ASEC9999 IF EQUAL
          PACK      KEY6,WBSEWRD
          CALL      RDWARD1
          BRANCH    OVRCD,ASEC9999
          WRITE     HTMLFILE;WBDESC;
          GOTO      ASEC9999
.
ASEC0010  MATCH     SP70,WBSEWRD            * Code
          GOTO      ASEC9999 IF EQUAL
          WRITE     HTMLFILE;WBSEWRD;
          GOTO      ASEC9999
.
ASEC0020  PACK      DFLTWARD,ADPOINTS                   
          CALL      WSEL0000                * ward select list 
          GOTO      ASEC9999
.
ASEC9999  RETURN
.-------------------------------------------------------------
.                                          called by PBOK0000
.               Routine for populating Unit Option
.-------------------------------------------------------------
USEC0000  MOVE      CODEAC,CATEGORY         * unit code
          MOVE      UNITCODE,CODE
          CALL      CODSEL00
          GOTO      USEC9999
.
USEC9999  RETURN
.------------------------------------------------------------
.               Rotuine for Ward selection
.------------------------------------------------------------
WSEL0000  PACK      KEY29,SP70
          IF        IBCNMHOS = 1
            PACK      KEY29,SP3,WBSEHOSP,SP70
          ENDIF
          CALL      RDSWARD7
WSEL0100  CALL      RDKWARD7
          BRANCH    OVRCD,WSEL9999
.
.                         if we have a bed number we have passed all the ward
.                         master records, so exit
          MATCH     SP70,WBED
          GOTO      WSEL9999 IF NOT EQUAL
.
          COMPARE   WACTIVE,ZERO                 *List only active wards 
          GOTO      WSEL0100 IF NOT EQUAL
.
          IF        IBCNMHOS = 1
            MATCH      SP3,WBSEHOSP
            IF        !@EQUAL
              MATCH     WBSEHOSP,PTWDHOSN
              GOTO      WSEL9999 IF NOT EQUAL
            ENDIF
          ENDIF
.
.                       write the select option.
          WRITE     HTMLFILE;"<option value=#"",WWARD,"#"";
          MATCH     DFLTWARD,WWARD
          IF        @EQUAL
            WRITE     HTMLFILE;" selected";
          ENDIF
          WRITE     HTMLFILE;">",WBDESC;
.
          IF        IBCNMHOS = 1
            MATCH      SP3,WBSEHOSP
            IF        @EQUAL
              WRITE     HTMLFILE;" - ",PTWDHOSN;
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"</option>"
          GOTO      WSEL0100
.
WSEL9999  RETURN
.
.---------V9.00.B01----------------------------------------------------        
.------------------------------------------------------------
.Table of Patient Bookings with Expected Discharge
.------------------------------------------------------------
TOPB0000  MOVE      ZERO,LOOPCNTR
          CALL      TABHED00                             *Table heading 
          MOVE      SP70,AWARD
          MOVE      SP70,PATUNT01
          MOVE      SP70,PATUNT02
          MOVE      SP70,PTMIXWRD
          MOVE      SP70,PTMIEBED
          MOVE      SP70,BKREWARD
          MOVE      SP70,BKRXPOWD
          MOVE      SP70,BKREADAT
          MOVE      SP70,TWARD
          MOVE      ZERO,ADMISFLG
          MOVE      ZERO,FUTRADMN
          MOVE      ZERO,SURGFLAG
          MOVE      ZERO,RECCNT
          MOVE      SP70,OVERDATE
          MOVE      SP70,WLWMPTY
          MOVE      SP70,WLRFCDAY
          MOVE      SP70,WLHIP
.
          MATCH     "S",LINKTYP
          IF        @EQUAL
            MOVE      ONE,SURGFLAG               * only for patweb9206008
            MOVE      "A",LINKTYP                * continue as if type A
          ENDIF
.
          PACK      CURRDATE,CCC,CYY,CMM,CDD     * current date
          REP       " 0",CURRDATE
.
          PACK      KEY16,FRSTDATE,SP70
          IF        BOOKCRDT=1
            CALL      RSBKRX12           * Read booking Ext file
          ELSE
            CALL      RSBKREC4           * Read booking file 
          ENDIF
.
          MOVE      ZERO,PATRFG01
TOPB1000  IF        BOOKCRDT=1
            CALL      RKBKRX12          
          ELSE
            CALL      RKBKREC4
          ENDIF
          BRANCH    OVRCD,TOPB5000
.
.------------------------------------------------------
. Loop counter to prevent timeout internal server error
.
          ADD       ONE,LOOPCNTR
.
          IF        (LOOPCNTR > 50)
            WRITE     HTMLFILE;"// ",LOOPCNTR
            MOVE      ZERO,LOOPCNTR
          ENDIF
.
. -----------------------------------------------------
.
          IF        BOOKCRDT=1
            PACK      KEY8,BKRXBNUM,SP70
            CALL      RDBKREC1                   * Read booking file 
            BRANCH    OVRCD,TOPB1000
.
            MATCH     BKRXCRDT,LASTDATE          * Date booking created
            GOTO      TOPB5000 IF LESS
          ELSE
            PACK      KEY8,DBKREBOO,SP70
            CALL      RDBKRX11                   * Read booking ext file
            BRANCH    OVRCD,TOPB1000
.
            MATCH     BKREEDAT,LASTDATE          * Expected due date
            GOTO      TOPB5000 IF LESS
          ENDIF
.
          IF        BOOKLNEW=1
            IF        BKRESTAT>0
              GOTO      TOPB1000
            ENDIF
          ENDIF
.
          MATCH     SP70,FILTPWRD
          IF        !@EQUAL
            MATCH     BKRXPOWD,FILTPWRD
            GOTO      TOPB1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTSTAY
          IF        !@EQUAL
            MATCH     BKRXUDF5,FILTSTAY
            GOTO      TOPB1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,UNITCODE
          IF        !@EQUAL
            MATCH     BKREDEPT,UNITCODE
            GOTO      TOPB1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,CLAIMTYP
          IF        !@EQUAL
            MATCH     BKRECLMT,CLAIMTYP
            GOTO      TOPB1000 IF NOT EQUAL
          ENDIF
.
          IF        IBCNMHOS<>1
            GOTO      TOPB1500
          ENDIF
.
          MATCH     SP70,WBSEHOSP
          GOTO      TOPB1500 IF EQUAL
.
          MATCH     SP70,BKREWARD
          IF        @EQUAL
            MATCH     SP70,BKRXPOWD
            GOTO      TOPB1500 IF EQUAL
          ENDIF
.
          MATCH     SP70,BKREWARD
          GOTO      TOPB1200 IF EQUAL
.
          PACK      KEY6,BKREWARD,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,TOPB1000
.
          MATCH     WBSEHOSP,PTWDHOSN
          GOTO      TOPB1000 IF NOT EQUAL
          GOTO      TOPB1500
.
TOPB1200  PACK      KEY6,BKRXPOWD,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,TOPB1000
.
          MATCH     WBSEHOSP,PTWDHOSN
          GOTO      TOPB1000 IF NOT EQUAL
.
TOPB1500  PACK      KEY8,BKREURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,TOPB1000
          CALL      RDPMPX21
.
          MATCH     SP70,BKREPROC
          GOTO      TOPB1600 IF EQUAL
.
          PACK      KEY19,BKREURNO,BKREPROC,BKRECNT,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,TOPB1600
.
          MATCH     SP70,WLCATEGY
          IF        !@EQUAL
            MATCH     WLCATEGY,WMPTY
            GOTO      TOPB1000 IF NOT EQUAL    * if WL - match priority
          ENDIF
          PACK      KEY5,ANST,ANSP,WMPTY,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            PACK      WLWMPTY,TDESC,SP70
          ENDIF
          CALL      NEWOVR00
          CALL      DRFCUR00
          MOVE      URRFCDAY,WLRFCDAY
          CALL      WATHPT00
.
TOPB1600  MATCH     SP70,HEALTHFN
          IF        !@EQUAL
            MATCH     HEALTHFN,PFUNDH
            GOTO      TOPB1000 IF NOT EQUAL    * Not for a selected HF
          ENDIF
.
          MATCH     "1",PTCNBBAP
          IF        @EQUAL
            MOVE      BKREWARD,EXPTWARD
            MOVE      BKREEBED,EXPTBEDD
            MOVE      BKRXPOWD,POSTWARD
            MOVE      BKRXPOBD,POSTBEDD
          ELSE
            MOVE      SP70,EXPTWARD
            MOVE      SP70,EXPTBEDD
            MOVE      SP70,POSTWARD
            MOVE      SP70,POSTBEDD
          ENDIF
.
          MOVE      "AC",CATEGORY          * Unit Description
          MOVE      BKREDEPT,PATUNT02
          MOVE      BKREDEPT,CODE
          CALL      GETCOD00
          MOVE      TDESC,PATUNT01
.
          MOVE      SP70,PROCTIME
          MOVE      "SP",CATEGORY          * Operation Period
          MOVE      BKRXOPRD,CODE
          CALL      GETCOD00
          MOVE      TDESC,PROCTIME
.
          MOVE      ZERO,SURGBOOK
          MOVE      SP70,OPDADATE
          PACK      KEY5,ANSB,ANSK,BKRETYPE,SP5
          CALL      RDCODE1                 *Read  patient code file
          BRANCH    OVRCD,TOPB2000
.
          MATCH      "THE",THCSCOD
          GOTO       TOPB2000 IF NOT EQUAL
.
          MOVE       ONE,SURGBOOK           * surgical booking=true
.
          COMPARE    ONE,MEDLBOOK           * only medical bookings
          GOTO       TOPB1000 IF EQUAL
.
          PACK       KEY31,BKREBOOK,SP70
          CALL       RSOPDEA2
          CALL       RKOPDEA2
          BRANCH     OVRCD,TOPB2000
          MOVE       BKREBOOK,KEY8
.          MATCH      KEY8,OPDAADMN
.          IF         @EQUAL
.            MOVE       OPDAEXPS,BKREATIM
.          ENDIF
.
TOPB2000  PACK      KEY18,BKREBOOK,SP70      * Read the diagnosis file
          CALL      RSBKDIA1
          CALL      RKBKDIA1
          IF        OVRCD=0
            MATCH     BKREBOOK,BKDIBOOK
            GOTO      TOPB2100 IF EQUAL
          ENDIF
.
          MOVE      SP70,BKDIDES1
          MOVE      SP70,BKDIDES2
          MOVE      SP70,BKDIDES3
.
TOPB2100  MOVE      LINKTYP,FLINKTYP
          MATCH     "A",LINKTYP
          IF        !@EQUAL
            COMPARE   BKRESTAT,FLINKTYP
            GOTO      TOPB1000 IF NOT EQUAL
          ENDIF
.          
          CALL      RDAP0000              * read rec Admpt/Ps/Forms
.
          MATCH     SP70,BKREWARD
          IF        !@EQUAL
            MOVE      BKREWARD,AWARD
          ELSE
            MOVE      BKRXPOWD,AWARD
          ENDIF
.
          IF        BKRESTAT=3
            PACK      KEY30,BKREBOOK,Z70
            CALL      RDSTRAN2
            CALL      RDPTRAN2
            BRANCH    OVRCD,TOPB3000
            MATCH     TADMN,BKREBOOK
            GOTO      TOPB3000 IF NOT EQUAL
            MOVE      TWARD,AWARD
          ENDIF
.
          MATCH     WARDCODE,SP70
          IF        !@EQUAL
            MATCH     WARDCODE,AWARD
            GOTO      TOPB1000 IF NOT EQUAL
          ENDIF
.
TOPB3000  CALL      CLWATOPA
          CALL      CLWTOS000
          MATCH     SP70,BKREPROC
          GOTO      TOPB4000 IF EQUAL
.
          PACK      KEY19,BKREURNO,BKREPROC,BKRECNT,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,TOPB4000
.
          CALL      PADM0000
          CALL      PANS0000
.
TOPB4000  PACK      EPHFUND,PFUNDH,SP70,SP70
          CALL      BKTABC00
          GOTO      TOPB1000
.
. ------ output pre-admitted patients ------
.
TOPB5000  MOVE      ZERO,LOOPCNTR
          PACK      KEY16,FRSTDATE,SP70
          IF        BOOKCRDT=1
            CALL      RSBKRX12           * Read booking Ext file
          ELSE
            CALL      RDSMISS3
          ENDIF
.
          MOVE      ZERO,PATRFG01
TOPB5500  IF        BOOKCRDT=1
            CALL      RKBKRX12
          ELSE
            CALL      RDKMISS3
          ENDIF
          BRANCH    OVRCD,TOPB9000
.
          ADD       ONE,LOOPCNTR
.
          IF        (LOOPCNTR = 100)
            WRITE     HTMLFILE;"// ",LOOPCNTR
            MOVE      ZERO,LOOPCNTR
          ENDIF
.
          IF        BOOKCRDT=1
            MATCH     BKRXCRDT,LASTDATE          * Date booking created
            GOTO      TOPB9000 IF LESS
            PACK      KEY8,BKRXBNUM,SP70
            CALL      RDMISS1
            BRANCH    OVRCD,TOPB5500
          ELSE
            MATCH     ADATE,LASTDATE
            GOTO      TOPB9000 IF LESS
          ENDIF
.
. -----------------------------------------------------
.
          COMPARE   "1",ASTAT                 * pre-admissions only
          GOTO      TOPB5500 IF NOT EQUAL
.
          MOVE      ONE,ADMISFLG
          IF        IBCNMHOS=1
            MATCH     SP70,WBSEHOSP
            GOTO      TOPB5600 IF EQUAL
.
            MATCH     WBSEHOSP,PMVXMHOS
            GOTO      TOPB5500 IF NOT EQUAL
          ENDIF
.
TOPB5600  MATCH     SP70,CLAIMTYP
          IF        !@EQUAL
            MATCH     ACLAIM,CLAIMTYP
            GOTO      TOPB5500 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,HEALTHFN
          IF        !@EQUAL
            MATCH     HEALTHFN,AFUNDH
            GOTO      TOPB5500 IF NOT EQUAL    * Not for a selected HF
          ENDIF
.
          MATCH     SP70,FILTSTAY
          IF        !@EQUAL
            MATCH     PMVXIDUS,FILTSTAY
            GOTO      TOPB5500 IF NOT EQUAL
          ENDIF
.
          MOVE      SP70,OPDADATE
          MOVE      SP70,PROCTIME
.
          CALL      CLBOKRC1
          MOVE      SP70,BKDIDES1
          MOVE      SP70,BKDIDES2
          MOVE      SP70,BKDIDES3
.
          IF        BOOKCRDT<>1
            CALL      CLBOKRX1
            PACK      KEY8,DAADMNO,SP70
            CALL      RDBKRX11
            BRANCH    OVRCD,TOPB5650
          ENDIF
.
          MOVE      "SP",CATEGORY          * Operation Period
          MOVE      BKRXOPRD,CODE
          CALL      GETCOD00
          MOVE      TDESC,PROCTIME
.
TOPB5650  MATCH     ADATE,CURRDATE
          IF        @LESS
            MOVE      ONE,FUTRADMN            * Admission in the future
          ENDIF
.
          CALL      CLWATOPA
          CALL      CLWTOS000
          MOVE      ZERO,BOOKFLAG             * Set booking flag to no
          MOVE      AADMNO,BKREBOOK
          MOVE      AURNO,BKREURNO
          MOVE      ADOCTA,BKREADOC
          MOVE      ACLSSFT,BKREDEPT
          MOVE      SP70,BKREADAT
          MOVE      ZERO,SURGBOOK
          PACK      KEY8,AADMNO,SP70
          CALL      RDBKREC1
          BRANCH    OVRCD,TOPB6000
.
          PACK      KEY5,ANSB,ANSK,BKRETYPE,SP5
          CALL      RDCODE1                 *Read  patient code file
          IF        OVRCD<>1
            MATCH      "THE",THCSCOD
            IF         @EQUAL
              MOVE       ONE,SURGBOOK           * surgical booking=true
            ENDIF
          ENDIF
.
          MATCH     SP70,BKREPROC
          GOTO      TOPB5700 IF EQUAL
.
          PACK      KEY19,BKREURNO,BKREPROC,BKRECNT,SP70
          CALL      RDTREA1
          BRANCH    OVRCD,TOPB5700
.
          CALL      PADM0000
          CALL      PANS0000
.
TOPB5700  COMPARE   TWO,BKRESTAT
          IF        !@EQUAL
            MOVE      ONE,BOOKFLAG           * Patient has a booking
          ENDIF
.
          PACK      KEY18,BKREBOOK,SP70      * Read the diagnosis file
          CALL      RSBKDIA1
          CALL      RKBKDIA1
          IF        OVRCD=0
            MATCH     BKREBOOK,BKDIBOOK
            GOTO      TOPB6000 IF EQUAL
          ENDIF
.
          MOVE      SP70,BKDIDES1
          MOVE      SP70,BKDIDES2
          MOVE      SP70,BKDIDES3
.
TOPB6000  PACK      KEY8,AADMNO,SP70
          CALL      RDPMVX11
          IF        OVRCD=1
            MOVE      SP70,PMVXAPWD
            MOVE      SP70,PMVXPSTY
            MOVE      SP70,PMVXFRMS
            MOVE      SP70,PMVXPOWD
            MOVE      SP70,PMVXIDUS
          ENDIF
.
          MATCH     "1",PTCNBBAP
          IF        @EQUAL
            MOVE      PTMIXWRD,EXPTWARD
            MOVE      PTMIEBED,EXPTBEDD
            MATCH     SP70,PMVXPOWD
            IF        @EQUAL
              MOVE      BKRXPOWD,POSTWARD
              MOVE      BKRXPOBD,POSTBEDD
            ELSE
              MOVE      PMVXPOWD,POSTWARD
              MOVE      PMVXPOBD,POSTBEDD
            ENDIF
          ELSE
            MOVE      SP70,EXPTWARD
            MOVE      SP70,EXPTBEDD
            MOVE      SP70,POSTWARD
            MOVE      SP70,POSTBEDD
          ENDIF
.
          MATCH     SP70,FILTPWRD
          IF        !@EQUAL
            MATCH     POSTWARD,FILTPWRD
            GOTO      TOPB5500 IF NOT EQUAL
          ENDIF
.
          MOVE      PMVXAPWD,PATAPT01
          MATCH     "1",PMVXPSTY
          IF        @EQUAL
            MOVE      "Yes",PATPST01        * if Parent staying Yes
          ENDIF
.
          MATCH     "0",PMVXPSTY
          IF        @EQUAL
            MOVE      "No",PATPST01
          ENDIF
          MOVE      PMVXFRMS,PATFRM01       * Forms
.
          MOVE      AADMNO,BKREBOOK
          MOVE      AURNO,BKREURNO
          MOVE      ADATE,BKREEDAT
          PACK      EPHFUND,AFUNDH,SP70,SP70
          CALL      BKTABC00
          GOTO      TOPB5500
.
TOPB9000
TOPB9999  RETURN
.-----------------------------------------------------------------------------
. PADM0000 - Check for outpatient pre admission link booking
.-----------------------------------------------------------------------------
PADM0000  PACK      KEY27,WMURNO,WMCODE,WMCNT,SP70
          CALL      RSWTOPA1
PADM1000  CALL      RKWTOPA1
          BRANCH    OVRCD,PADM9000
.
          MATCH     WTOPURNO,WMURNO
          GOTO      PADM9000 IF NOT EQUAL
.
          MATCH     WTOPCODE,WMCODE
          GOTO      PADM9000 IF NOT EQUAL
.
          MATCH     WTOPCOUN,DWMCNT
          GOTO      PADM9000 IF NOT EQUAL
.
          MATCH     "0",WTOPSTAT
          GOTO      PADM9999 IF EQUAL
.
          GOTO      PADM1000
.
PADM9000  CALL      CLWATOPA
          GOTO      PADM9999
.
PADM9999  RETURN
.
.-----------------------------------------------------------------------------
. PANS0000 - Check for outpatient pre anaesthetic link booking
.-----------------------------------------------------------------------------
PANS0000  PACK      KEY27,WMURNO,WMCODE,WMCNT,SP70
          CALL      RSWTOPS1
PANS1000  CALL      RKWTOPS1
          BRANCH    OVRCD,PANS9000
.
          MATCH     WTOSURNO,WMURNO
          GOTO      PANS9000 IF NOT EQUAL
.
          MATCH     WTOSCODE,WMCODE
          GOTO      PANS9000 IF NOT EQUAL
.
          MATCH     WTOSCOUN,DWMCNT
          GOTO      PANS9000 IF NOT EQUAL
.
          MATCH     "0",WTOSSTAT
          GOTO      PANS9999 IF EQUAL
.
          GOTO      PANS1000
.
PANS9000  CALL      CLWTOS00
          GOTO      PANS9999
.
PANS9999  RETURN
.
.-----------------------------------------------------------------------------
. CLWTOS00 - Clear waiting list pre anawsthetic outpatient link file
.-----------------------------------------------------------------------------
CLWTOS00  MOVE      SP70,WTOSURNO
          MOVE      SP70,WTOSCODE
          MOVE      SP70,WTOSCOUN
          MOVE      SP70,WTOSSITE
          MOVE      SP70,WTOSCLIN
          MOVE      SP70,WTOSDATE
          MOVE      SP70,WTOSSTRT
          MOVE      SP70,WTOSSLOT
          MOVE      SP70,WTOSOUTN
          MOVE      SP70,WTOSOSTA
          MOVE      SP70,WTOSPDAT
          MOVE      SP70,WTOSPTIM
          MOVE      SP70,WTOSSTAT
          MOVE      SP70,WTOSCDAT
          MOVE      SP70,WTOSCTIM
          MOVE      SP70,WTOSCUID
          MOVE      SP70,WTOSUDAT
          MOVE      SP70,WTOSUTIM
          MOVE      SP70,WTOSUUID
          MOVE      SP70,WTOSSPAR
.
CLWTOS99  RETURN
.
.---------V9.00.B01----------------------------------------------------        
.

RDUT0000  PACK      KEY8,BKREBOOK,SP70 
          CALL      RDMISS1
          IF        OVRCD=1 
            MOVE      SP70,PTMIPDRG
            MOVE      SP70,ACLSSFT
          ENDIF
          MATCH     SP70,PTMIPDRG
          IF        @EQUAL
            PACK      KEY8,BKREBOOK,SP70
            CALL      RDBKREC1 
            IF        OVRCD=1
              MOVE      SP70,BKREPROC
            ENDIF
            MOVE      BKREPROC,PTMIPDRG    
          ENDIF 
          MOVE      PTMIPDRG,PATPRC01
          MOVE      ACLSSFT,PATUNT01
.
RDUT9999  RETURN
.
.------------------------------------------------------------
.Find Admitting Point, Parent Staying, Ward and Forms for booking list
.------------------------------------------------------------
RDAP0000  MOVE      BKREBOOK,PMVXVISN
          PACK      KEY8,PMVXVISN,SP70 
          CALL      RDPMVX11
          IF        OVRCD=1
            MOVE      SP70,PMVXAPWD
            MOVE      SP70,PMVXPSTY 
            MOVE      SP70,PMVXFRMS
          ENDIF
.
          MATCH     SP3,PMVXAPWD
          IF        @EQUAL
            PACK      KEY8,BKREBOOK,SP70
            CALL      RDBKRX11 
            IF        OVRCD=1
              MOVE      SP70,BKRXADWD
            ENDIF
            MOVE      BKRXADWD,PMVXAPWD
            MOVE      BKRXPOWD,AWARD          * Admin Point/Ward
          ENDIF
          MOVE        PMVXAPWD,PATAPT01
.
          MATCH     SP1,PMVXPSTY
          IF        @EQUAL
            PACK      KEY8,BKREBOOK,SP70
            CALL      RDBKRX11
            IF        OVRCD=1
              MOVE      SP70,BKRXPSTY
            ENDIF
            MOVE      BKRXPSTY,PMVXPSTY 
          ENDIF
.              
          MATCH     "1",PMVXPSTY
          IF        @EQUAL
            MOVE      "Yes",PATPST01        * if Parent staying Yes
          ENDIF
.
          MATCH     "0",PMVXPSTY
          IF        @EQUAL
            MOVE      "No",PATPST01
          ENDIF
          MATCH     SP70,PMVXFRMS
          IF        @EQUAL
            MOVE      BKRXFORM,PMVXFRMS
          ENDIF
          MOVE      PMVXFRMS,PATFRM01       * Forms
.
RDAP9999  RETURN
.
.----------------------------------------------------------------------        
.
.------------------------------------------------------------
.Format patient name,sex and age for the booked patients
.---------------------------------------------------------------------------
FRTPAT00  MOVE      SP8,DISPSEX
.
.* ****************************************** Start of Changes         *C-49016
          MOVE      PSEX,DSEXCHAR
          CALL      SEXDSC00                * get sex description (in IBACOMN)
.                                           *       returns DSEXDESC & DSEXNO
          MOVE      DSEXDESC,DISPSEX
.* ******************************************   End of Changes         *C-49016
.
          UNPACK    PBDATE,CDAY,CMON,CYEAR,CCENT
          CALL      IBACLOCK
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
          CALL      PATNAM00
.
FRTPAT99  RETURN
.------------------------------------------------------------
. Get Patient
.------------------------------------------------------------
GETPAT00  MATCH     "       0",URNUMBER
          IF        !@EQUAL
            MOVE      URNUMBER,KEY8
            CALL      RDMAST1
            MOVE      OVRCD,MASTFLAG
            CALL      RDPMPX21
          ELSE
            MOVE      ADMISSNO,KEY8
            CALL      RDPRAM1
            MOVE      OVRCD,MASTFLAG
          ENDIF
.
          MOVE        PREG,RELICODE
.
          MOVE      F1,F1B                       * save value in F1 (0909365)
.* ****************************************** Start of Changes         *C-49016
          MOVE      PSEX,DSEXCHAR
          CALL      SEXDSC00                * get sex description (in IBACOMN)
.                                           *       returns DSEXDESC & DSEXNO
          MOVE      DSEXDESC,DISPSEX
.* ******************************************   End of Changes         *C-49016
          MOVE      F1B,F1                       * restore value in F1 (0909365)
.
          MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
          IF        OVRCD=0
            UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
            MOVE      ASTAY,ADJDAYS
            CALL      ADJDAT00
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT:
                      NOV,DEC
            PACK      COLDAT04,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR 
          ENDIF
.
          UNPACK    PBDATE,CDAY,CMON,CYEAR,CCENT
          CALL      IBACLOCK
          IF        PCEASE=1
            MOVE      PDECDTE,AGEDATE            * Date of Death
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
          CALL      PATNAM00

GETPAT99  RETURN
.------------------------------------------------------------
. Get Patient Condition Details
.------------------------------------------------------------
GETCON00  PACK      KEY88,PTMASNAM,PMPXFNAM,AADMNO
          CALL      RDLOCA1
          BRANCH    OVRCD,GETCON10
          MATCH     SP70,LPCONDC
          GOTO      GETCON15 IF EQUAL
          PACK      KEY5,CODECO,LPCONDC
          CALL      RDCODE1
          BRANCH    OVRCD,GETCON15
          MOVE      TDESC,CONDESC
          MATCH     SP70,TCINDC1
          IF        @EQUAL
            MOVE      ZERO,TCINDC1
          ENDIF
          GOTO      GETCON20
.
GETCON10  MOVE      SP70,LPCONDD
          MOVE      SP70,LPCONDC
          MOVE      SP70,LPCDATE
          MOVE      SP70,LPCTIME
          MOVE      SP70,LPCONAM
GETCON15  MOVE      SP70,CONDESC
          MOVE      ZERO,TCINDC1
.
GETCON20  CLEAR     IMGSRC
          APPEND    "ConditionIcon_",IMGSRC
          IF        PCEASE=1
            APPEND    "D",IMGSRC
            MOVE      "Deceased",CONDESC
          ELSE
            APPEND    TCINDC1,IMGSRC
          ENDIF
          APPEND    ".gif",IMGSRC
          RESET     IMGSRC
.
GETCON50  PACK      KEY8,AADMNO,SP70
          CALL      RDPMWOR1
          IF        OVRCD=1
            CALL      CLPMWO00
            PACK      WORKDESC,SP70,SP70
            GOTO      GETCON70
          ENDIF
.
          PACK      WORKDESC,SP70,SP70
          CLEAR     WORKDESC
.
          MATCH     SP70,PMWOWDI1
          IF        !@EQUAL
            APPEND    "<br>",WORKDESC
            APPEND    PMWOWDI1,WORKDESC
          ENDIF
.
          MATCH     SP70,PMWOWDI2
          IF        !@EQUAL
            APPEND    "<br>",WORKDESC
            APPEND    PMWOWDI2,WORKDESC
          ENDIF
.
          MATCH     SP70,PMWOWDI3
          IF        !@EQUAL
            APPEND    "<br>",WORKDESC
            APPEND    PMWOWDI3,WORKDESC
          ENDIF
.
          APPEND    "&nbsp;",WORKDESC
          RESET     WORKDESC
.
GETCON70  PACK      WORKDES2,SP70,SP70,SP70,SP70,SP70
.
          PACK      KEY35,URNUMBER,ADMISSNO,SP70
          CALL      RSPTATR3
GETCON80  CALL      RKPTATR3
          BRANCH    OVRCD,GETCON99
.
          MATCH     URNUMBER,PTARURNO
          GOTO      GETCON99 IF NOT EQUAL
.
          MATCH     ADMISSNO,PTARVISN
          GOTO      GETCON99 IF NOT EQUAL
.
          MATCH     "002",PTARTYPE
          GOTO      GETCON80 IF NOT EQUAL
.
          PACK      WORKDES2,SP70,SP70,SP70,SP70,SP70
          CLEAR     WORKDES2
.
          PACK      SP80,SP70,SP70
.
          MATCH     SP80,PTARTXT1
          IF        !@EQUAL
            APPEND    "<br>",WORKDES2
            APPEND    PTARTXT1,WORKDES2
          ENDIF
.
          MATCH     SP80,PTARTXT2
          IF        !@EQUAL
            APPEND    "<br>",WORKDES2
            APPEND    PTARTXT2,WORKDES2
          ENDIF
.
          MATCH     SP70,PTARTXT3
          IF        !@EQUAL
            APPEND    "<br>",WORKDES2
            APPEND    PTARTXT3,WORKDES2
          ENDIF
.
          APPEND    "&nbsp;",WORKDES2
          RESET     WORKDES2
.
GETCON99  RETURN
.
.------------------------------------------------------------
. Next Day, Week, Month
.------------------------------------------------------------
NEXT0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
.
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
.          
          WRITE     HTMLFILE;"patweb92.pbl":
                             "?reportno=",KEY2:    
                             "&template=",KEY3:
                             "&frstdate=",NXTFDATE:
                             "&viewtype=",VIEWTYPE:
                             "&lastdate=",NXTLDATE:
                             "&unitcode=",UNITCODE:
                             "&wardcode=",WARDCODE:
                             "&claimcod=",CLAIMCOD:
                             "&pattypes=",PATTYPES:
                             "&schdprn1=",SCHDPRN1:
                             "&schdprn2=",SCHDPRN2:
                             "&schdprn3=",SCHDPRN3:
                             "&labeltyp=",LABELTYP:
                             "&statnco1=",STATNCO1:
                             "&statnco2=",STATNCO2:
                             "&schdcop1=",SCHDCOP1:
                             "&schdcop2=",SCHDCOP2:
                             "&schdcop3=",SCHDCOP3:
                             "&sschdpr1=",SSCHDPR1:
                             "&sschdpr2=",SSCHDPR2:
                             "&sschdpr3=",SSCHDPR3:
                             "&slabelty=",SLABELTY:
                             "&sstatnc1=",SSTATNC1:
                             "&sstatnc2=",SSTATNC2:
                             "&srchtype=",SRCHTYPE:
                             "&adpoints=",ADPOINTS:
                             "&pmpgi002=",PMPGI002:
                             "&pmpgi003=",PMPGI003:
                             "&chngtype=",CHNGTYPE:
                             "&flags001=",FLAGS001:
                             "&outalflg=",OUTALFLG:
                             "&icflunit=",ICFLUNIT:
                             "&icflityp=",ICFLITYP:
                             "&icfldoct=",ICFLDOCT:
                             "&icflward=",ICFLWARD:
                             "&filtflag=",FILTFLAG:
                             "&filthosp=",FILTHOSP:
                             "&requstat=",REQUSTAT:
                             "&oecrprnt=",OECRPRNT:
                             "&hospcomp=",HOSPCOMP:
                             "&deftflag=",DEFTFLAG:
                             "&filtward=",FILTWARD:
                             "&showcanc=",SHOWCANC:
                             "&claimtyp=",CLAIMTYP:
                             "&filtstay=",FILTSTAY:
                             "&filtowrd=",FILTOWRD:
                             "&filtpwrd=",FILTPWRD:
                             "&chkcompl=",CHKCOMPL:
                             "&healthfn=",HEALTHFN:
                             "&pacaflag=",PACAFLAG:
                             "&leavward=",LEAVWARD:
                             "&leavstat=",LEAVSTAT:
                             "&leavrisk=",LEAVRISK:
                             "&leavcare=",LEAVCARE:
                             "&leavereg=",LEAVEREG:
                             "&superlev=",SUPERLEV;
.
          MATCH     SP70,TMOTFRST
          IF        !@EQUAL
            WRITE     HTMLFILE;"&tmotfrst=",TMOTFRST;
          ENDIF
          MATCH     SP70,TMOTNEXT
          IF        !@EQUAL
            WRITE     HTMLFILE;"&tmotnext=",TMOTNEXT;
          ENDIF
.
          WRITE     HTMLFILE;"&pmpgi065=",PMPGI065;
          WRITE     HTMLFILE;"&bktypcol=",BKTYPCOL;
          WRITE     HTMLFILE;"&filbcrdt=",FILBCRDT;        *T0870496
          WRITE     HTMLFILE;"&dfdtview=",DFDTVIEW;        *T0870496
.
NEXT9999  RETURN
.
.------------------------------------------------------------
. Previous Day, Week, Month
.------------------------------------------------------------
PREV0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
.
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
.          
          WRITE     HTMLFILE;"patweb92.pbl":
                             "?reportno=",KEY2:    
                             "&template=",KEY3:
                             "&frstdate=",PREFDATE:
                             "&lastdate=",PRELDATE:
                             "&viewtype=",VIEWTYPE:
                             "&unitcode=",UNITCODE:
                             "&wardcode=",WARDCODE:
                             "&claimcod=",CLAIMCOD:
                             "&pattypes=",PATTYPES:
                             "&schdprn1=",SCHDPRN1:
                             "&schdprn2=",SCHDPRN2:
                             "&schdprn3=",SCHDPRN3:
                             "&labeltyp=",LABELTYP:
                             "&statnco1=",STATNCO1:
                             "&statnco2=",STATNCO2:
                             "&schdcop1=",SCHDCOP1:
                             "&schdcop2=",SCHDCOP2:
                             "&schdcop3=",SCHDCOP3:
                             "&sschdpr1=",SSCHDPR1:
                             "&sschdpr2=",SSCHDPR2:
                             "&sschdpr3=",SSCHDPR3:
                             "&slabelty=",SLABELTY:
                             "&sstatnc1=",SSTATNC1:
                             "&sstatnc2=",SSTATNC2:
                             "&srchtype=",SRCHTYPE:
                             "&adpoints=",ADPOINTS:
                             "&pmpgi002=",PMPGI002:
                             "&pmpgi003=",PMPGI003:
                             "&chngtype=",CHNGTYPE:
                             "&flags001=",FLAGS001:
                             "&outalflg=",OUTALFLG:
                             "&icflunit=",ICFLUNIT:
                             "&icflityp=",ICFLITYP:
                             "&icfldoct=",ICFLDOCT:
                             "&icflward=",ICFLWARD:
                             "&filtflag=",FILTFLAG:
                             "&filthosp=",FILTHOSP:
                             "&requstat=",REQUSTAT:
                             "&oecrprnt=",OECRPRNT:
                             "&hospcomp=",HOSPCOMP:
                             "&deftflag=",DEFTFLAG:
                             "&filtward=",FILTWARD:
                             "&showcanc=",SHOWCANC:
                             "&claimtyp=",CLAIMTYP:
                             "&filtstay=",FILTSTAY:
                             "&filtowrd=",FILTOWRD:
                             "&filtpwrd=",FILTPWRD:
                             "&chkcompl=",CHKCOMPL:
                             "&healthfn=",HEALTHFN:
                             "&pacaflag=",PACAFLAG:
                             "&leavward=",LEAVWARD:
                             "&leavstat=",LEAVSTAT:
                             "&leavrisk=",LEAVRISK:
                             "&leavcare=",LEAVCARE:
                             "&leavereg=",LEAVEREG:
                             "&superlev=",SUPERLEV;
.
          MATCH     SP70,TMOTFRST
          IF        !@EQUAL
            WRITE     HTMLFILE;"&tmotfrst=",TMOTFRST;
          ENDIF
          MATCH     SP70,TMOTNEXT
          IF        !@EQUAL
            WRITE     HTMLFILE;"&tmotnext=",TMOTNEXT;
          ENDIF
.
          WRITE     HTMLFILE;"&pmpgi065=",PMPGI065;
          WRITE     HTMLFILE;"&bktypcol=",BKTYPCOL;
          WRITE     HTMLFILE;"&filbcrdt=",FILBCRDT;        *T0870496
          WRITE     HTMLFILE;"&dfdtview=",DFDTVIEW;        *T0870496
.
PREV9999  RETURN
.-----------------------------------------------------------
. Select Date From
.-----------------------------------------------------------
SELDAT00  UNPACK    DIM127,D1,LINKPRG,DIM127 
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          MOVE      VIEWTYPE,KEY1
          WRITE     HTMLFILE;"<form name=SelectPeriod action=",LINKPRG,".pbl ":
                         "method=post  >":
                         "<input type=hidden name=reportno value=",LINKREP,">":
                         "<input type=hidden name=template value=",LINKTEM,">":
                         "<input type=hidden name=viewtype id=viewtype value=",KEY1,">";
.
          CALL      SELV0000
.
          WRITE     HTMLFILE;"<input type=submit value=Go>":
                             "</form>";
SELDAT99  RETURN
.-----------------------------------------------------------
. Table Headings
.------------------------------------------------------------
TABHED00  LOAD      NEWTITLE,REPORTNO,TITLE01,TITLE02,TITLE03,TITLE04:
                                      TITLE06,TITLE07,TITLE08,TITLE09
. 
          COMPARE   "6",REPORTNO
          IF        @EQUAL
            GOTO      TABHED50
          ENDIF
.
          COMPARE   ONE,LNK2PRT
          GOTO      TABHED99 IF EQUAL
.
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          GOTO      TABHED99
.
TABHED50  COMPARE   ONE,LNK2PRT
          GOTO      TABHED99   IF EQUAL
.
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,LINKTYP,DIM127
.
TABHED99  RETURN
.------------------------------------------------------------
. Discharge Table Contents 
.------------------------------------------------------------
DISCON00  CALL      GETPAT00  
.
          MOVE      SP70,DOCFNAME
          MOVE      ADOCTA,KEY6
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE       * I CAR 13038
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000             * end I CAR 13038
          ENDIF
.
          CALL      PATLN000      * Format Pateint Name with System Parameter
.
          COMPARE   ONE,LNK2PRT
          GOTO      DISCON20 IF EQUAL
.
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
.
          CLEAR     PATLINK
          APPEND    LINKPRG,PATLINK
          APPEND    ".pbl?reportno=",PATLINK
          APPEND    LINKREP,PATLINK
          APPEND    "&template=",PATLINK
          APPEND    LINKTEM,PATLINK
          APPEND    "&urnumber=",PATLINK
          APPEND    URNUMBER,PATLINK
          APPEND    "&admissno=",PATLINK
          APPEND    ADMISSNO,PATLINK
          RESET     PATLINK
.
          IF        PTCNDRSM=1
            MOVE      CATD,CATEGORY
            MOVE      DSTAT,CODE
          ELSE
            MOVE      CATDD,CATEGORY       * Get Discharge Destination Descrip.
            MOVE      DDEST,CODE
          ENDIF
.
          CALL      GETCOD00
          MOVE      TDESC,DESTDESC
.
          MATCH     "1",TCINDC2
          IF        @EQUAL
            PACK      KEY8,AADMNO,SP70     * transferred to another hospital
            CALL      RDPTDAD1
            BRANCH    OVRCD,DISCON10
            MATCH     SP70,PTDADCTS
            GOTO      DISCON10 IF EQUAL
            PACK      KEY5,PTDADCTS,SP70
            CALL      RDPTVAD1
            IF        OVRCD=0
              MOVE      PTVADESC,DESTDESC
            ENDIF
          ENDIF
           
.
DISCON10  CALL      RTRN0000                * Read transfer file for unit
.
          PACK      KEY6,AWARD,ABED
          CALL      FWBD0000
          WRITE     HTMLFILE;"t.addRow(#"",FORMATNM,"#",":
                             "#"",WARDTEXT,"#",":
                             "#"",BEDTEXT,"#",":
                             "#"",ADATE,"#",":
                             "#"",DDATE,"#",":
                             "#"",DISPSEX,"#",":
                             "#"";
          CALL      WRTAGE00
          CALL      PATFLD00               *Returns KEY3 for folder colour code
.
          REP       "#" ",ADIAG1
          REP       "#" ",ADIAG2
.
          PACK      PTYPDESC,SP70
          MATCH     SP3,PMVXIDUS
          IF        !@EQUAL
            PACK      KEY5,CODEVI,PMVXIDUS
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,PTYPDESC
            ENDIF
          ENDIF
.
          PACK      ACLSDESC,SP70
          MATCH     SP3,ACLSS
          IF        !@EQUAL
            PACK      KEY5,ANSP,SP1,ACLSS,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,ACLSDESC
            ENDIF
          ENDIF
.
          PACK      ATYPDESC,SP70
          MATCH     SP3,ATYPE
          IF        !@EQUAL
            PACK      KEY5,ANSA,SP1,ATYPE,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,ATYPDESC
            ENDIF
          ENDIF
.
          PACK      ASRCDESC,SP70
          MATCH     SP3,ASRCE
          IF        !@EQUAL
            PACK      KEY5,ANSS,SP1,ASRCE,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,ASRCDESC
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",CONDESC,SP1,LPCONDD,"#",":
                             "#"",ADIAG1,ADIAG2,"#",":
                             "#"",WEXTN,"#",":
                             "#"",DESTDESC,"#",":
                             "#"",DTIME,"#",":
                             "#"",ACLAIM,"#",":
                             "#"",TDEPT,"#",":
                             "#"",PMVXIDUS,"#",":
                             "#"",PATLINK,"#",":
                             "#"",URNUMBER,"#",":
                             "#"",AURNO,"#",":
                             "#"",ADMTIME,"#",":
                             "#"",ATIME,"#",":
                             "#"",SAVDTIME,"#",":
                             "#"",PTYPDESC,"#",":
                             "#"",KEY3,"#",":
                             "#"",ATYPDESC,"#",":
                             "#"",ASRCDESC,"#",":
                             "#"",ACLSDESC,"#");"
.
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
          GOTO      DISCON99
.
DISCON20  REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
          CLEAR     PATLINK
          CALL      JAVNAM00
          APPEND    "OnClick=#"updateParent('",PATLINK
          APPEND    JAVFNAME,PATLINK
          APPEND    "','",PATLINK
          APPEND    ADMISSNO,PATLINK
          APPEND    "')#">",PATLINK
.
          PACK      KEY6,AWARD,ABED
          CALL      FWBD0000
          WRITE     HTMLFILE;"t.addRow(#"",FORMATNM,"#",":
                             "#"",WARDTEXT,"#",":
                             "#"",BEDTEXT,"#",":
                             "#"",ADMNDATE,"#",":
                             "#"",DSCHDATE,"#",":
                             "#"",DISPSEX,"#",":
                             "#"";
          CALL      WRTAGE00
          REP       "#" ",ADIAG1
          REP       "#" ",ADIAG2
          WRITE     HTMLFILE;"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",CONDESC,SP1,LPCONDD,"#",":
                             "#"",ADIAG1,ADIAG2,"#",":
                             "#"",WEXTN,"#",":
                             "#"",PATLINK,"#",":
                             "#"",URNUMBER,"#",":
                             "#"",AURNO,"#",":
                             "#"",ADMTIME,"#",":
                             "#"",ATIME,"#",":
                             "#"",SAVDTIME,"#");"
.
DISCON99  RETURN
.------------------------------------------------------------
. Read transfer file to get Unit/Department
.------------------------------------------------------------
RTRN0000  PACK      KEY30,DADMNO,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,RTRN9000
.
          MATCH     DADMNO,TADMN
          GOTO      RTRN9000 IF NOT EQUAL    * different admission
.
          MATCH     ANSD,TMOVE
          GOTO      RTRN9999 IF EQUAL
.
RTRN9000  MOVE      SP10,TDEPT
RTRN9999  RETURN
.------------------------------------------------------------
. Admission Table Contents 
.------------------------------------------------------------
ADMCON00  CALL      GETPAT00  
.
          PACK      KEY30,DAADMNO,SP70
          CALL      RDSTRAN2
          CALL      RDKTRAN2
          BRANCH    OVRCD,TOPA2000
.
          MATCH     DTADMN,DAADMNO
          IF        @EQUAL
            MOVE      TWARD,AWARD
            MOVE      TBED,ABED
            MOVE      TDEPT,ACLSSFT
            MOVE      TADOCT,ADOCTA
          ENDIF
.
          MOVE      SP70,DOCFNAME
          MOVE      ADOCTA,KEY6
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE       * I CAR 13038
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000             * end I CAR 13038
          ENDIF
.
          CALL      PATLN000      * Format Pateint Name with System Parameter
.
          MOVE      CATDC,CATEGORY          * Diet Code Description
          MOVE      ADIET,CODE
          CALL      GETCOD00
          MOVE      TDESC,TABLDESC
.
          MOVE      SP70,ATYPDESC
          MATCH     SP70,ATYPE
          IF        !@EQUAL
            PACK      CATEGORY,ANSA,SP70      * Specialty Code Description
            MOVE      ATYPE,CODE
            CALL      GETCOD00
            MOVE      TDESC,ATYPDESC
          ENDIF
.
          CALL      PATFLD00                *Returns KEY3 for folder colour code
.
          MOVE      CATAC,CATEGORY          * Unit Description
          MOVE      ACLSSFT,CODE
          CALL      GETCOD00
.
          COMPARE   ONE,LNK2PRT
          GOTO      ADMCON20 IF EQUAL
.
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
.
          CLEAR     PATLINK
          APPEND    LINKPRG,PATLINK
          APPEND    ".pbl?reportno=",PATLINK
          APPEND    LINKREP,PATLINK
          APPEND    "&template=",PATLINK
          APPEND    LINKTEM,PATLINK
          APPEND    "&urnumber=",PATLINK
          APPEND    URNUMBER,PATLINK
          APPEND    "&admissno=",PATLINK
          APPEND    ADMISSNO,PATLINK
          RESET     PATLINK
.
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
          PACK      KEY6,AWARD,ABED
          CALL      FWBD0000
          WRITE     HTMLFILE;"t.addRow(#"",FORMATNM,"#",":
                             "#"",WARDTEXT,"#",":
                             "#"",BEDTEXT,"#",":
                             "#"",ADMNDATT,"#",":
                             "#"",DSCHDATE,"#",":
                             "#"",DISPSEX,"#",":
                             "#"";
          CALL      WRTAGE00
.
          REP       "#" ",ADIAG1
          REP       "#" ",ADIAG2
          WRITE     HTMLFILE;"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",CONDESC,SP1,LPCONDD,"#",":
                             "#"",ADIAG1,ADIAG2,"#",":
                             "#"",WEXTN,"#",":
                             "#"",PATLINK,"#",":
                             "#"",URNUMBER,"#",":
                             "#"",TDESC,"#",":
                             "#"",TABLDESC,"#",":
                             "#"",PCEASE,PCASE:
                                  PTMXSIN1,PTMXSIN2,PTMXSIN3,PTMXSIN4:
                                  PTMXSIN5,"#",":
                             "#"",ACLAIM,"#",":
                             "#"",KEY3,"#",":
                             "#"",ATYPDESC,"#");"
.
          GOTO      ADMCON99
.
ADMCON20  REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
          CLEAR     PATLINK
          CALL      JAVNAM00
          APPEND    "OnClick=#"updateParent('",PATLINK
          APPEND    JAVFNAME,PATLINK
          APPEND    "','",PATLINK
          APPEND    ADMISSNO,PATLINK
          APPEND    "')#">",PATLINK
.
          PACK      KEY6,AWARD,ABED
          CALL      FWBD0000
          WRITE     HTMLFILE;"t.addRow(#"",FORMATNM,"#",":
                             "#"",WARDTEXT,"#",":
                             "#"",BEDTEXT,"#",":
                             "#"",ADMNDATT,"#",":
                             "#"",DSCHDATE,"#",":
                             "#"",DISPSEX,"#",":
                             "#"";
          CALL      WRTAGE00
.
          REP       "#" ",ADIAG1
          REP       "#" ",ADIAG2
          WRITE     HTMLFILE;"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",CONDESC,SP1,LPCONDD,"#",":
                             "#"",ADIAG1,ADIAG2,"#",":
                             "#"",WEXTN,"#",":
                             "#"",PATLINK,"#",":
                             "#"",URNUMBER,"#",":
                             "#"",TDESC,"#",":
                             "#"",TABLDESC,"#,":
                             "#"",KEY3,"#");"
.
ADMCON99  RETURN
.
.------------------------------------------------------------
. Expected Discharge Table Contents
.------------------------------------------------------------
EXDCON00  CALL      GETPAT00
.
          MOVE      SP70,DOCFNAME
          MOVE      ADOCTA,KEY6
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE       * I CAR 13038
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000             * end I CAR 13038
          ENDIF
.
          CALL      PATLN000      * Format Pateint Name with System Parameter
.
          MOVE      CATA,CATEGORY           * Pat Admission Type Description
          MOVE      ATYPE,CODE
          CALL      GETCOD00
          MOVE      TDESC,TABLDESC
.
          CALL      PATFLD00                *Returns KEY3 for folder colour code
.
          MOVE      CATCL,CATEGORY          * Claim Code Description
          MOVE      ACLAIM,CODE
          CALL      GETCOD00
.
          COMPARE   ONE,LNK2PRT
          GOTO      EXDCON20 IF EQUAL
.
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
.
          CLEAR     PATLINK
          APPEND    LINKPRG,PATLINK
          APPEND    ".pbl?reportno=",PATLINK
          APPEND    LINKREP,PATLINK
          APPEND    "&template=",PATLINK
          APPEND    LINKTEM,PATLINK
          APPEND    "&urnumber=",PATLINK
          APPEND    URNUMBER,PATLINK
          APPEND    "&admissno=",PATLINK
          APPEND    ADMISSNO,PATLINK
          RESET     PATLINK
.
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
          PACK      KEY6,AWARD,ABED
          CALL      FWBD0000
          WRITE     HTMLFILE;"t.addRow(#"",FORMATNM,"#",":
                             "#"",WARDTEXT,"#",":
                             "#"",BEDTEXT,"#",":
                             "#"",ADMNDATT,"#",":
                             "#"",DSCHDATE,"#",":
                             "#"",DISPSEX,"#",":
                             "#"";
          CALL      WRTAGE00
.
          REP       "#" ",ADIAG1
          REP       "#" ",ADIAG2
          WRITE     HTMLFILE;"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",CONDESC,SP1,LPCONDD,"#",":
                             "#"",ADIAG1,ADIAG2,"#",":
                             "#"",WEXTN,"#",":
                             "#"",PATLINK,"#",":
                             "#"",URNUMBER,"#",":
                             "#"",TDESC,"#",":
                             "#"",TABLDESC,"#",":
                             "#"",PCEASE,PCASE:
                                  PTMXSIN1,PTMXSIN2,PTMXSIN3,PTMXSIN4:
                                  PTMXSIN5,"#",":
                             "#"",ACLAIM,"#",":
                             "#"",KEY3,"#",":
                             "#"",EXDSCFLD,"#");"
.
          GOTO      EXDCON99
.
EXDCON20  REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
          CLEAR     PATLINK
          CALL      JAVNAM00
          APPEND    "OnClick=#"updateParent('",PATLINK
          APPEND    JAVFNAME,PATLINK
          APPEND    "','",PATLINK
          APPEND    ADMISSNO,PATLINK
          APPEND    "')#">",PATLINK
.
          PACK      KEY6,AWARD,ABED
          CALL      FWBD0000
          WRITE     HTMLFILE;"t.addRow(#"",FORMATNM,"#",":
                             "#"",WARDTEXT,"#",":
                             "#"",BEDTEXT,"#",":
                             "#"",ADMNDATT,"#",":
                             "#"",DSCHDATE,"#",":
                             "#"",DISPSEX,"#",":
                             "#"";
          CALL      WRTAGE00
.
          REP       "#" ",ADIAG1
          REP       "#" ",ADIAG2
          WRITE     HTMLFILE;"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",CONDESC,SP1,LPCONDD,"#",":
                             "#"",ADIAG1,ADIAG2,"#",":
                             "#"",WEXTN,"#",":
                             "#"",PATLINK,"#",":
                             "#"",URNUMBER,"#",":
                             "#"",TDESC,"#",":
                             "#"",TABLDESC,"#,":
                             "#"",KEY3,"#,":
                             "#"",EXDSCFLD,"#");"
.
EXDCON99  RETURN
.
.------------------------------------------------------------
. Table Contents 
.------------------------------------------------------------
TABCON00  CALL      GETPAT00  
.
          MOVE      SP70,DOCFNAME
          MOVE      ADOCTA,KEY6
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE       * I CAR 13038
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000             * end I CAR 13038
          ENDIF
.
          CALL      PATLN000         * Patient name format for System Parameter
.
          COMPARE   ONE,LNK2PRT
          GOTO      TABCON20 IF EQUAL
.
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
.
          CLEAR     PATLINK
          APPEND    LINKPRG,PATLINK
          APPEND    ".pbl?reportno=",PATLINK
          APPEND    LINKREP,PATLINK
          APPEND    "&template=",PATLINK
          APPEND    LINKTEM,PATLINK
          APPEND    "&urnumber=",PATLINK
          APPEND    URNUMBER,PATLINK
          APPEND    "&admissno=",PATLINK
          APPEND    ADMISSNO,PATLINK
          RESET     PATLINK
.
          PACK      KEY6,AWARD,ABED
          CALL      FWBD0000
          WRITE     HTMLFILE;"t.addRow(#"",FORMATNM,"#",":
                             "#"",WARDTEXT,"#",":
                             "#"",BEDTEXT,"#",":
                             "#"",CDAY," ",MTHNAM3," ",CCENT,CYEAR,"#",":
                             "#"",EXPDSCDT,"#",":
                             "#"",DISPSEX,"#",":
                             "#"";
          CALL      WRTAGE00
          REP       "#" ",ADIAG1
          REP       "#" ",ADIAG2
          WRITE     HTMLFILE;"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",CONDESC,SP1,LPCONDD,"#",":
                             "#"",ADIAG1,ADIAG2,"#",":
                             "#"",WEXTN,"#",":
                             "#"",PATLINK,"#",":
                             "#"",URNUMBER,"#");"
.
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
          GOTO      TABCON99
.
TABCON20  REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
          CLEAR     PATLINK
          CALL      JAVNAM00
          APPEND    "OnClick=#"updateParent('",PATLINK
          APPEND    JAVFNAME,PATLINK
          APPEND    "','",PATLINK
          APPEND    ADMISSNO,PATLINK
          APPEND    "')#">",PATLINK
.
          PACK      KEY6,AWARD,ABED
          CALL      FWBD0000
          WRITE     HTMLFILE;"t.addRow(#"",FORMATNM,"#",":
                             "#"",WARDTEXT,"#",":
                             "#"",BEDTEXT,"#",":
                             "#"",CDAY," ",MTHNAM3," ",CCENT,CYEAR,"#",":
                             "#"",EXPDSCDT,"#",":
                             "#"",DISPSEX,"#",":
                             "#"";
          CALL      WRTAGE00
          REP       "#" ",ADIAG1
          REP       "#" ",ADIAG2
          WRITE     HTMLFILE;"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",CONDESC,SP1,LPCONDD,"#",":
                             "#"",ADIAG1,ADIAG2,"#",":
                             "#"",WEXTN,"#",":
                             "#"",PATLINK,"#",":
                             "#"",URNUMBER,"#");"
.
TABCON99  RETURN
.------------------------------------------------------------
. Admission Date
.------------------------------------------------------------
ADMDAT00  UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          UNPACK    ATIME,DIM1,DIM4,DIM3
          MATCH     "0",DIM1
          IF        @EQUAL
            REP       "0 ",DIM1
          ENDIF
          PACK      DIM5,DIM1,DIM4 
          UNPACK    DIM5,DIM2,DIM3
          MOVE      DIM2,F2
          IF        F2<12
            MOVE      " am",DAYTIME
          ELSE
            MOVE      " pm",DAYTIME
            SUB       TEN2,F2
          ENDIF
          MOVE      F2,DIM2
          PACK      DIM5,DIM2,DIM3
.
          MOVE      " at ",DIM4
          PACK      FADMDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.          PACK      FADMDTTM,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,DIM4,ATIME
          PACK      FADMDTTM,ADATE,ATIME
.
ADMDAT99  RETURN
.
.---------V9.00.B01----------------------------------------------------        
.
BPEA0000  PACK      KEY16,FRSTDATE,SP70
          MOVE      ONE,ADMICTR1  
          CALL      RDSMISS3 
.                    
BPEA1000  CALL      RDKMISS3
          BRANCH    OVRCD,BPEA2000
.
          MATCH     ADATE,LASTDATE
          GOTO      BPEA2000 IF LESS
.
          MATCH     SP3,WARDCODE
          IF        !@EQUAL
            MATCH     PTMIXWRD,WARDCODE
            GOTO      BPEA1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP10,SURGEON
          IF        !@EQUAL
            MATCH     ADOCTA,SURGEON
            GOTO      BPEA1000 IF NOT EQUAL
          ENDIF
.
          MOVE      AADMNO,KEY8
          CALL      RDPMVX11
          BRANCH    OVRCD,BPEA1000
.
          IF        IBCNMHOS<>1
            GOTO      BPEA1200
          ENDIF
.
          MATCH     SP70,WBSEHOSP
          GOTO      BPEA1200 IF EQUAL
.
          MATCH     WBSEHOSP,PMVXMHOS
          GOTO      BPEA1000 IF NOT EQUAL

BPEA1200  MATCH     ALLEDSU,ADPOINTS
          IF        @EQUAL
            MATCH     "DSU",PMVXAPWD
            GOTO      BPEA1000 IF EQUAL
            GOTO      BPEA1500
          ENDIF
.
          MATCH     SP3,ADPOINTS
          IF        !@EQUAL
            MATCH     PMVXAPWD,ADPOINTS
            GOTO      BPEA1000 IF NOT EQUAL
          ENDIF
.
BPEA1500  IF        ASTAT = 1
            MATCH     ADATE,LASTDATE
            IF        !@LESS
              MOVE      AURNO,URNUMBER      * URNUMBER used in GETPAT
              MOVE      AADMNO,ADMISSNO 
              CALL      PREDAT00            * Format  Pre-Admission Date
              CALL      GETPAT00            * Get patient information
              CALL      PATLN000            * Format Pateint Name
              MOVE      "Pre-admitted",BOOKING
.
              MOVE      SP70,APOIDESC
              MATCH     SP70,PMVXAPWD
              IF        !@EQUAL
.                PACK      KEY6,PMVXAPWD,SP70  *  D SRF 17693
.                CALL      RDWARD1             *  Admitting Point Description
.                BRANCH    OVRCD,BPEA1000      *  if not blank
.                MOVE      WBDESC,APOIDESC     *  end D SRF 17693
                MOVE "ap",CATEGORY             *  I SRF 17693
                MOVE PMVXAPWD,CODE
                CALL GETCOD00
                MOVE TDESC,APOIDESC            *  end I SRF 17693
              ENDIF
.             
              MOVE      SP70,WBDESC
              PACK      KEY6,PTMIXWRD,SP70  *  Ward description 
              CALL      RDWARD1
              BRANCH    OVRCD,BPEA1000
.             
              MOVE      ADMICTR1,ADMDCTR1
              SQUEEZE   ADMDCTR1
.
              PACK      ACARE,SP70
              PACK      KEY8,ADMISSNO,SP70
              CALL      RDMISS1
              IF        OVRCD=1
                MOVE    "&nbsp;",ADIAG1
              ENDIF
.
              MATCH     ADIAG1,SP70
              IF        @EQUAL
                MOVE    "&nbsp;",ADIAG1
              ENDIF
.                                           * Get care type colour code
              PACK      DIM1,SP20
              PACK      DISPCLSS,SP20
              PACK      KEY5,ANSC,ANSC,ACARE,SP70
              CALL      RDCODE1
              IF        OVRCD<>1
                UNPACK      TCINDC21,DIM1
              ENDIF
.
              MATCH     DIM1,SP70
              IF        !@EQUAL
                PACK      DISPCLSS,ONCLCLSS,DIM1,SP70
                SQUEEZE   DISPCLSS
                WRITE     HTMLFILE;"<tr><td>",ADMISSNO,"</td>":
                                   "<td class=",DISPCLSS,">",FORMATNM,"</td>"
              ELSE
                WRITE     HTMLFILE;"<tr><td>",ADMISSNO,"</td>":
                                       "<td>",FORMATNM,"</td>"
              ENDIF
.
              COMPARE   ONE,PTCNHDPS
              IF    @EQUAL
                WRITE     HTMLFILE;"<td width=400>",ADIAG1,"</td>"
              ENDIF
.
              WRITE     HTMLFILE;"<td>",BOOKING,"</td>"
.
              IF        KIDSONLY = 1
                WRITE     HTMLFILE;"<td>&nbsp;",APOIDESC,"</td>"
              ENDIF
.
              WRITE     HTMLFILE;"<td>&nbsp;",WBDESC,"</td>":
                                 "<td>",FBOKDATE,"</td>":
                                 "<td><input type=checkbox":
                                 " print-key='",URNUMBER,"|",ADMISSNO,"'":
                                 " name=admissno":
                                 " value=#"",ADMISSNO,"#" checked></td></tr>"
              ADD       ONE,ADMICTR1   
            ENDIF
          ENDIF
          GOTO      BPEA1000
.
BPEA2000  PACK      KEY16,FRSTDATE,SP70
          CALL      RSBKREC4
.
BPEA3000  CALL      RKBKREC4
          BRANCH    OVRCD,BPEA9990
.
          MATCH     BKREEDAT,LASTDATE
          GOTO      BPEA9990 IF LESS
.
          PACK      KEY8,DBKREBOO,SP70
          CALL      RDBKRX11
          MATCH     SP3,WARDCODE
          IF        !@EQUAL
            MATCH     BKRXPOWD,WARDCODE
            GOTO      BPEA3000 IF NOT EQUAL
          ENDIF
.
          MATCH     ALLEDSU,ADPOINTS
          IF        @EQUAL
            MATCH     "DSU",BKRXADWD
            GOTO      BPEA3000 IF EQUAL
            GOTO      BPEA3050
          ENDIF
.
          MATCH     SP3,ADPOINTS
          IF        !@EQUAL
            MATCH     BKRXADWD,ADPOINTS
            GOTO      BPEA3000 IF NOT EQUAL
          ENDIF
.
BPEA3050  IF        BKRESTAT = 0
            MOVE      "Booked",BOOKING
            MOVE      BKREWARD,AWARD
            MATCH     BKREEDAT,LASTDATE
            IF        !@LESS
              MOVE      BKREBOOK,ADMISSNO
              MOVE      BKREURNO,URNUMBER
              CALL      BOKDAT00
              CALL      GETPAT00
              CALL      PATLN000
.
BPEA3100      MOVE      SP70,APOIDESC
              MATCH     SP70,BKRXADWD
              IF        !@EQUAL
                PACK      KEY6,BKRXADWD,SP70        *  Ward description
                CALL      RDWARD1
                BRANCH    OVRCD,BPEA3000
                MOVE      WBDESC,APOIDESC
              ENDIF

              MOVE      SP70,WBDESC
              MATCH     SP70,BKRXPOWD
              IF        !@EQUAL
                PACK      KEY6,BKRXPOWD,SP70        *  Ward description
                CALL      RDWARD1
                BRANCH    OVRCD,BPEA3000
              ENDIF
.
              PACK      ACARE,SP70
              PACK      KEY8,ADMISSNO,SP70
              CALL      RDMISS1
              IF        OVRCD=1
                MOVE    "&nbsp;",ADIAG1
              ENDIF
.
              MATCH     ADIAG1,SP70
              IF        @EQUAL
                MOVE    "&nbsp;",ADIAG1
              ENDIF
. 
              MOVE      ADMICTR1,ADMDCTR1
              SQUEEZE   ADMDCTR1 
.                                           * Get care type colour code
              IF        BKRESTAT = 0 | BKRESTAT = 1 | BKRESTAT = 3
                PACK      DIM1,SP20
                PACK      DISPCLSS,SP20
                PACK      KEY5,ANSC,ANSC,ACARE,SP70
                IF        BKRESTAT = 0
                  PACK      KEY5,ANSC,ANSC,BKREEATY,SP70       * CAR 305377
                ENDIF
                CALL      RDCODE1
                IF        OVRCD<>1
                  UNPACK      TCINDC21,DIM1
                ENDIF
                MATCH     DIM1,SP70
                IF        !@EQUAL
                  PACK      DISPCLSS,ONCLCLSS,DIM1,SP70
                ENDIF
                SQUEEZE   DISPCLSS
              ENDIF
.
              WRITE     HTMLFILE;"<tr><td>",ADMISSNO,"</td>":
                                 "<td>",FORMATNM,"</td>"
.
              COMPARE   ONE,PTCNHDPS
              IF    @EQUAL
                WRITE     HTMLFILE;"<td width=400>",ADIAG1,"</td>"
              ENDIF
.
              WRITE     HTMLFILE;"<td>",BOOKING,"</td>"
.
              IF        KIDSONLY = 1
                WRITE     HTMLFILE;"<td>&nbsp;",APOIDESC,"</td>"
              ENDIF
.
              WRITE     HTMLFILE;"<td>&nbsp;",WBDESC,"</td>":
                                 "<td>",FBOKDATE,"</td>":
                                 "<td><input type=checkbox":
                                 " print-key='",AURNO,"|",AADMNO,"'":
                                 " name=admissno":
                                 " value=#"",ADMISSNO,"#" checked></td></tr>"
              ADD       ONE,ADMICTR1
            ENDIF
          ENDIF
          GOTO      BPEA3000
.
BPEA9990  WRITE     HTMLFILE;"<tr><td><input type=hidden name=admno":
                             " value=#"",ADMDCTR1,"#"></td>":
                             "<td><input type=hidden name=viewtype id=viewtype":
                             " value=#"",VIEWTYPE,"#"></td>":
                             "<td><input type=hidden name=lastdate id=lastdate":
                             " value=#"",LASTDATE,"#"></td>":
                             "<td><input type=hidden name=frstdate id=frstdate":
                             " value=#"",FRSTDATE,"#"></td></tr>"
.
BPEA9999  RETURN
.
.----------------------------------------------------------------------        
. Format  Pre-Admission Date
.------------------------------------------------------------
PREDAT00  UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          UNPACK    ATIME,DIM2,DIM1,DIM2A
          MOVE      DIM2,F2
          IF        F2>=12
            MOVE      "pm",DIM2B
            IF         F2>=13
              ASSIGN     F2-12,F2
              MOVE       F2,DIM2
            ENDIF
          ELSE
            MOVE      "am",DIM2B
            MOVE      F2,DIM2
          ENDIF
.
          PACK      FBOKDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
..          PACK      FBOKDTTM,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP1:
..                             AT,DIM2,DIM1,DIM2B
          PACK      FBOKDTTM,ADATE,ATIME
.
PREDAT99  RETURN
.
.-----------------------------------------------------------
.Table contents of patient bookings by date
.--------------------------------------------------------------
BKTABC00  MOVE      BKREURNO,URNUMBER
          MOVE      BKREBOOK,ADMISSNO
          MOVE      "patweb89",LINKPRG
          MOVE      SP70,EXPDSCDT           * initialise expected disch. date
          CALL      GETPAT00
. 
          MATCH     SP70,WLCATEGY
          IF        !@EQUAL
            MATCH     SP70,WLWMPTY
            GOTO      BKTABC99 IF EQUAL    * if priority filter has a value
          ENDIF
.
          CALL      BOKDAT00                 *Booking data
.
          PACK      DIM1,SP20
          PACK      DISPCLSS,SP20
          PACK      DISPALTD,SP70
          PACK      KEY5,ANSC,ANSC,ACARE,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            UNPACK      TCINDC21,DIM1
          ENDIF
          MATCH     DIM1,SP70
          IF        !@EQUAL
            PACK      DISPCLSS,ONCLCLSS,DIM1,SP70
            PACK      DISPALTD,PTCDLDES,SP70
          ENDIF
          SQUEEZE   DISPCLSS
          STRIP     DISPALTD
.
          COMPARE  ONE,ADMISFLG
          GOTO     BKTABC10 IF EQUAL
.
          CALL     CLPMSVX1
.
          IF       BKRESTAT = 0 
            MOVE     "Booked",BOOKING
            MOVE     SP70,EXPDSCDT           * initialise expected disch. date
            MATCH    SP70,BKREWARD
            IF       !@EQUAL
              MOVE     BKREWARD,AWARD
              MOVE     BKREEBED,ABED
            ELSE
              MOVE     BKRXPOWD,AWARD
              MOVE     BKRXPOBD,ABED
            ENDIF
            MOVE     "020",LINKTEM
.            UNPACK    BKREADAT,CCENT,CYEAR,CMON,CDAY
            UNPACK     BKREEDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      BKREELOS,ADJDAYS
            CALL      ADJDAT00
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      EXPDSCDT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          PACK     KEY5,ANSB,ANSK,BKRETYPE,SP70
          CALL     RDCODE1
          IF       OVRCD<>1
            MATCH    ANSI,TCINDC4
            IF       @EQUAL
              MOVE     "patweb81",LINKPRG
              MOVE     "01",LINKREP
              MOVE     "009",LINKTEM
            ENDIF
            MATCH    ANSO,TCINDC4
            IF       @EQUAL
              MOVE     "patweb81",LINKPRG
              MOVE     "01",LINKREP
              MOVE     "010",LINKTEM
            ENDIF
            MATCH    ANSI,TCINDC4
            IF       @EQUAL
              MOVE     "patweb81",LINKPRG
              MOVE     "01",LINKREP
              MOVE     "009",LINKTEM
            ENDIF
          ENDIF
.
          IF       BKRESTAT = 1
            MOVE     "Pre-Admitted",BOOKING
            CALL     ADMDAT00
            MOVE     FADMDTTM,FBOKDTTM
            MOVE     PTMIXWRD,AWARD
            MOVE     PTMIEBED,ABED
            MOVE     "001",LINKTEM
            UNPACK   ADATE,CCENT,CYEAR,CMON,CDAY
            MOVE     ASTAY,ADJDAYS
            CALL     ADJDAT00
            MOVE     CMON,F2
            LOAD     MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK     EXPDSCDT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          IF       BKRESTAT = 2
            MOVE     "Cancelled",BOOKING
            MOVE     SP70,EXPDSCDT           * initialise expected disch. date
            MOVE     SP70,AWARD
          ENDIF
.
          IF       BKRESTAT = 3
            MOVE     "Admitted",BOOKING
            CALL     ADMDAT00
            MOVE     FADMDTTM,FBOKDTTM
            UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
            MOVE      ASTAY,ADJDAYS
            CALL      ADJDAT00
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      EXPDSCDT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
            MOVE     "030",LINKTEM
.
.---------V9.00.B01-------------------------------------------------        
.
            PACK     KEY30,BKREBOOK,BKREEDAT,Z70
            CALL     RDSTRAN2
            CALL     RDPTRAN2 
            IF       OVRCD=0
              MATCH    TADMN,BKREBOOK
              IF       @EQUAL
                MOVE     TWARD,AWARD         
              ENDIF
            ENDIF
          ENDIF
.
          IF       BKRESTAT = 4
            MOVE     "Discharged",BOOKING
            CALL     ADMDAT00
            MOVE     FADMDTTM,FBOKDTTM
            CALL     DISDAT00
            PACK     EXPDSCDT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
            MOVE     "001",LINKTEM
          ENDIF 
.
          MOVE      SP70,DISPSTAY
          MATCH     SP70,BKRXUDF5
          IF        !@EQUAL
            PACK      KEY5,ANSV,ANSI,BKRXUDF5,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MOVE      TDESC,DISPSTAY           * Intended stay
            ENDIF
          ENDIF
.
          MOVE      SP70,DISPACCO
          MATCH     SP70,BKREACCM
          IF        !@EQUAL
            PACK      KEY5,ANSB,ANSP,BKREACCM,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MOVE      TDESC,DISPACCO           * Preferred Accommodation
            ENDIF
          ENDIF
.
          GOTO      BKTABC20
.
BKTABC10  PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          IF        OVRCD<>1
            CALL     RDPMVX11
.
            COMPARE   ONE,BOOKFLAG
            IF        @EQUAL
              MOVE     "Pre-Admitted / Booked",BOOKING
            ELSE
              MOVE     "Pre-Admitted",BOOKING
            ENDIF
.
            CALL     ADMDAT00
            MOVE     FADMDTTM,FBOKDTTM
            CALL     DISDAT00
            UNPACK   ADATE,CCENT,CYEAR,CMON,CDAY
            MOVE     ASTAY,ADJDAYS
            CALL     ADJDAT00
            MOVE     CMON,F2
            LOAD     MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK     EXPDSCDT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
            MOVE     "04",LINKREP
            MOVE     "002",LINKTEM
            MOVE     ONE,BKRESTAT
            MOVE     ACLAIM,BKRECLMT
            MOVE     ATIME,BKREATIM
.
            MATCH    "1",PTCNUDF1
            IF       !@EQUAL
              MATCH    SP70,PMVXUDF1
              IF       @EQUAL
                MOVE     ADIAG1,BKDIDES1
.
                MATCH    SP70,ADIAG2
                IF       !@EQUAL & !@EOS
                  MOVE     ADIAG2,BKDIDES2
                ENDIF
.
              ELSE
                MOVE     PMVXUDF1,BKDIDES1
                MOVE     ADIAG1,BKDIDES2
                MOVE     ADIAG2,BKDIDES3
              ENDIF
            ELSE
              MOVE     ADIAG1,BKDIDES1
            ENDIF
          ELSE
            CALL      CLPATMIS
            CALL      CLPMSVX1
          ENDIF
.
          MOVE      SP70,DISPSTAY
          MATCH     SP70,PMVXIDUS
          IF        !@EQUAL
            PACK      KEY5,ANSV,ANSI,PMVXIDUS,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MOVE      TDESC,DISPSTAY           * Intended stay
            ENDIF
          ENDIF
.
          MOVE      SP70,DISPACCO
          MATCH     SP70,PMVXPACC
          IF        !@EQUAL
            PACK      KEY5,ANSB,ANSP,PMVXPACC,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MOVE      TDESC,DISPACCO           * Preferred Accommodation
            ENDIF
          ENDIF
.
BKTABC20  MOVE      SP70,DOCFNAME
          MOVE      SP70,DOCCOD
          PACK      KEY6,BKREADOC
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE       * I CAR 13038
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000             * end I CAR 13038
            MOVE      KEY6,DOCCOD         
          ENDIF
.
          MOVE      SP70,CLAIMCOD
          MOVE      SP70,CLAIMDES
          MATCH     SP70,BKRECLMT
          IF        !@EQUAL
            MOVE      BKRECLMT,CLAIMCOD
          ENDIF
.
          MATCH     SP70,BKREDEPT
          IF        !@EQUAL
            MOVE      BKREDEPT,PATUNT02
            MOVE      "AC",CATEGORY          * Unit Description
            MOVE      BKREDEPT,PATUNT02
            MOVE      BKREDEPT,CODE
            CALL      GETCOD00
            MOVE      TDESC,PATUNT01
          ENDIF
.
          MATCH     SP70,UNITCODE
          IF        !@EQUAL
            MATCH     BKREDEPT,UNITCODE
            GOTO      BKTABC99 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,CLAIMCOD
          IF        !@EQUAL
            MOVE      "CL",CATEGORY
            MOVE      CLAIMCOD,CODE
            CALL      GETCOD00
            MOVE      TDESC,CLAIMDES
          ENDIF
.                                           * Get care type colour code
          PACK      DISPCLSS,SP20
          IF        BKRESTAT = 0 | BKRESTAT = 1 | BKRESTAT = 3
            PACK      DIM1,SP20
            PACK      KEY5,ANSC,ANSC,ACARE,SP70
            IF        BKRESTAT = 0
              PACK      KEY5,ANSC,ANSC,BKREEATY,SP70       * CAR 305377
            ENDIF
            CALL      RDCODE1
            IF        OVRCD<>1
              UNPACK      TCINDC21,DIM1
            ENDIF
            MATCH     DIM1,SP70
            IF        !@EQUAL
              PACK      DISPCLSS,ONCLCLSS,DIM1,SP70
            ENDIF
            SQUEEZE   DISPCLSS
          ENDIF
.
          CALL      PATLN000      * Format Pateint Name with System Parameter
          CALL      MRTDET00      * Get Document Type and Document Location
.
          REP      " +",ADMISSNO
          REP      " +",URNUMBER
.
          CLEAR     PATLINK
          APPEND    LINKPRG,PATLINK
          APPEND    ".pbl?reportno=",PATLINK
          APPEND    LINKREP,PATLINK
          APPEND    "&template=",PATLINK
          APPEND    LINKTEM,PATLINK
          APPEND    "&urnumber=",PATLINK
          APPEND    URNUMBER,PATLINK
          APPEND    "&admissno=",PATLINK
          APPEND    ADMISSNO,PATLINK
          RESET     PATLINK
.
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
          CLEAR     UPDLINK
          APPEND    "javascript:UpdatePatient('",UPDLINK
          APPEND    URNUMBER,UPDLINK
          APPEND    "','",UPDLINK
          APPEND    ADMISSNO,UPDLINK
          APPEND    "','",UPDLINK
          APPEND    BKRESTAT,UPDLINK
          APPEND    "')",UPDLINK
          RESET     UPDLINK
.
          PACK      ALRTLINK,SP70,SP70
          PACK      ALRTIMG1,SP70,SP70
          PACK      ALRTIMG2,SP70,SP70
          PACK      ALRTIMG3,SP70,SP70
          PACK      ALRTIMG4,SP70,SP70
          PACK      ALRTIMG5,SP70,SP70
          PACK      ALRTIMGE,SP70,SP70
          PACK      ALRTDISA,SP70,SP70
          PACK      ALRTIMGT,SP100,SP100,SP100,SP100,SP100,SP100,SP100
.
          MOVE      ZERO,EXIT
          PROC      DISPALRT                * check for Disability Alerts
          IF        EXIT=0 | EXIT=2
            MATCH     "1",PMPXSIN7
            IF        @EQUAL
              CLEAR     ALRTIMG1
              APPEND    "<img border=0 hspace=2 align=absmiddle",ALRTIMG1
              APPEND    " alt='Medical Alerts'",ALRTIMG1
              APPEND    " src='../images/AlertIconM.gif'>",ALRTIMG1
              RESET     ALRTIMG1
            ENDIF
.
            MATCH     "1",PMPXSIN8
            IF        @EQUAL
              CLEAR     ALRTIMG2
              APPEND    "<img border=0 hspace=2 align=absmiddle",ALRTIMG2
              APPEND    " alt='Micro Alerts'",ALRTIMG2
              APPEND    " src='../images/AlertIconB.gif'>",ALRTIMG2
              RESET     ALRTIMG2
            ENDIF
.
            MATCH     "1",PMPXSIN9
            IF        @EQUAL
              CLEAR     ALRTIMG3
              APPEND    "<img border=0 hspace=2 align=absmiddle",ALRTIMG3
              APPEND    " alt='Risk Alerts'",ALRTIMG3
              APPEND    " src='../images/AlertIconR.gif'>",ALRTIMG3
              RESET     ALRTIMG3
            ENDIF
.
            MATCH     "1",PMPXSN11
            IF        @EQUAL
              CLEAR     ALRTIMG4
              APPEND    "<img border=0 hspace=2 align=absmiddle",ALRTIMG4
              APPEND    " alt='Chronic Alerts'",ALRTIMG4
              APPEND    " src='../images/AlertIconC.gif'>",ALRTIMG4
              RESET     ALRTIMG4
            ENDIF
.
            MATCH     "1",PTMXSIN1
            IF        @EQUAL
              CLEAR     ALRTIMGE
              APPEND    "<img border=0 hspace=2 align=absmiddle",ALRTIMGE
              APPEND    " alt='Alerts'",ALRTIMGE
              APPEND    " src='../images/AlertIcon.gif'>",ALRTIMGE
              RESET     ALRTIMGE
              GOTO      BKTABC25
            ENDIF
.
            MATCH     "2",PTMXSIN1
            IF        @EQUAL
              CLEAR     ALRTIMGE
              APPEND    "<img border=0 hspace=2 align=absmiddle",ALRTIMGE
              APPEND    " alt='Alerts'",ALRTIMGE
              APPEND    " src='../images/AlertIconBlack.gif'>",ALRTIMGE
              RESET     ALRTIMGE
              GOTO      BKTABC25
            ENDIF
.
            MATCH     "3",PTMXSIN1
            IF        @EQUAL
              CLEAR     ALRTIMGE
              APPEND    "<img border=0 hspace=2 align=absmiddle",ALRTIMGE
              APPEND    " alt='Alerts'",ALRTIMGE
              APPEND    " src='../images/AlertIconDelete.gif'>",ALRTIMGE
              RESET     ALRTIMGE
              GOTO      BKTABC25
            ENDIF
.
            MATCH     "0",PTMXSIN1
            GOTO      BKTABC25 IF EQUAL
.
            MATCH     SP70,PTMXSIN1
            IF        !@EQUAL
              CLEAR     ALRTIMGE
              APPEND    "<img border=0 hspace=2 align=absmiddle",ALRTIMGE
              APPEND    " alt='Alerts'",ALRTIMGE
              APPEND    " src='../images/AlertIcon",ALRTIMGE
              APPEND    PTMXSIN1,ALRTIMGE
              APPEND    ".gif'>",ALRTIMGE
              RESET     ALRTIMGE
            ENDIF
          ENDIF
.
BKTABC25  IF        EXIT=1 | EXIT=2
            CLEAR     ALRTDISA
            APPEND    "<img border=0 hspace=4 align=absmiddle",ALRTDISA
            APPEND    " alt='Disability Alerts'",ALRTDISA
            APPEND    " src='../images/AlertIconDIS.gif'>",ALRTDISA
            RESET     ALRTDISA
          ENDIF
.
.-------- Check current IP/ED visit for urnumber - set alert image ALRTIMG5
          PROC      CIPED000         
.
          MATCH     SP70,ALRTIMGE
          IF        @EQUAL
            MATCH     SP70,ALRTIMG1
            IF        @EQUAL
              MATCH     SP70,ALRTIMG2
              IF        @EQUAL
                MATCH     SP70,ALRTIMG3
                IF        @EQUAL
                  MATCH     SP70,ALRTIMG4
                  IF        @EQUAL
                    GOTO      BKTABC27
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          CLEAR     ALRTLINK
          APPEND    "javascript:PatientAlerts('",ALRTLINK
          APPEND    URNUMBER,ALRTLINK
          APPEND    "','",ALRTLINK
          APPEND    ADMISSNO,ALRTLINK
          APPEND    "')",ALRTLINK
          RESET     ALRTLINK
.
BKTABC27  MATCH     SP70,AWARD
          IF        @EQUAL
            MOVE      PTMIXWRD,AWARD      * use expected ward
            MOVE      PTMIEBED,ABED       * use expected bed
          ENDIF
.
          IF        BKRESTAT=1
            MOVE      PTMIEBED,ABED       * use expected bed
          ENDIF
.
          MATCH     SP70,WARDCODE
          IF        !@EQUAL
            MATCH     WARDCODE,AWARD
            GOTO      BKTABC99 IF NOT EQUAL
          ENDIF
.
          MATCH     "1",FILTOWRD                 * Ignore OP wards
          GOTO      BKTABC28 IF NOT EQUAL
.
          MATCH     SP70,AWARD                  
          GOTO      BKTABC28 IF EQUAL
.
          PACK      KEY6,AWARD,SP70
          CALL      RDWARD1                      * Read expected ward
          BRANCH    OVRCD,BKTABC28
.
          MATCH     SP70,WCLASS
          GOTO      BKTABC28 IF EQUAL
. 
          PACK      KEY5,ANSC,ANSG,WCLASS,SP70
          CALL      RDCODE1                      * Read ward classification
          BRANCH    OVRCD,BKTABC28
.
          MATCH     ANSO,TCINDC1                 * Skip record if OP ward
          GOTO      BKTABC99 IF EQUAL
.
BKTABC28  MATCH     ALLEDSU,ADPOINTS
          IF        @EQUAL
            MATCH     "DSU",PATAPT01
            GOTO      BKTABC99 IF EQUAL
            GOTO      BKTABC30
          ENDIF
.
          MATCH     "~~~",ADPOINTS
          IF        @EQUAL
            MATCH     SP70,PATAPT01         * Only display visits with a 
            GOTO      BKTABC99 IF NOT EQUAL * blank admitting point
          ELSE
            MATCH     SP70,ADPOINTS
            IF        !@EQUAL
              MATCH     PATAPT01,ADPOINTS
              GOTO      BKTABC99 IF NOT EQUAL
            ENDIF
          ENDIF
.
BKTABC30  COMPARE   ONE,OPCNDORD            * Dont fill desc2 with line 1 if
          GOTO      BKTABC35 IF EQUAL       * displaying line 1 then 2 order
.
...       MATCH     SP70,BKDIDES2
...       IF        @EQUAL
...         MOVE      BKDIDES1,BKDIDES2
...       ENDIF
.
BKTABC35  MOVE      ADMISSNO,KEY8
          CALL      RDPTELG1
          IF        OVRCD=1
            CALL      CLRELG00               * Clear eligibility fields
          ENDIF
.
          MATCH     "Z",CHKCOMPL             * Check Complete field
          IF        !@EQUAL
            MOVE      PTELCMPL,ANS
            REP       " 202",ANS
            MATCH     ANS,CHKCOMPL
            GOTO      BKTABC99 IF NOT EQUAL
          ENDIF
.
          MOVE      SP70,DIM5
          MOVE      BKREATIM,DIM5
          PACK      KEY6,AWARD,ABED
          CALL      FWBD0000
          WRITE     HTMLFILE;*+,"t.addRow(#"",FORMATNM,"#",":    * 01
                             "#"",WARDTEXT,"#",":
                             "#"",BEDTEXT,"#",":
                             "#"",FBOKDTTM,"#",":
                             "#"",EXPDSCDT,"#",":                * 05
                             "#"",DISPSEX,"#",":                 * 06 
                             "#"";
          CALL      WRTAGE00                                     * 07 
          CALL      PATFLD00               *08 Returns KEY3 for folder colour code
.
          WRITE     HTMLFILE;*+,"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",CONDESC,SP1,LPCONDD,"#",":     * 10
                             "#"",BOOKING,"#",":
                             "#"",WEXTN,"#",": 
.                            "#"",BKDIDES1,SP1,BKDIDES2,SP1,"#",":
                             "#"",BKDIDES2,SP1,"#",":  
                             "#"",PATLINK,"#",":                 * 15 
                             "#"",URNUMBER,"#",":
.
.---------V9.00.B01----------------------------------------------------        
.
                             "#"",PATAPT01,"#",":
                             "#"",PATUNT01,"#",":
                             "#"",PATPST01,"#",":
                             "#"",PATFRM01,"#",":                * 20
                             "#"",PATPRC01,"#",":
                             "#"",UPDLINK,"#",":
                             "#"",PCEASE,PCASE:
                                  PTMXSIN1,PTMXSIN2,PTMXSIN3,PTMXSIN4:
                                  PTMXSIN5,"#",":               
                             "#"",PSUBRB,"#",":
                             "#"",PATUNT02,"#",";                * 25
.
          IF        OPCNDORD=1
            WRITE     HTMLFILE;*+,"#"","<nowrap>",BKDIDES1,"<br>",BKDIDES2,SP1,"#",";
          ELSE
            WRITE     HTMLFILE;*+,"#"","<nowrap>",BKDIDES2,"<br>",BKDIDES1,SP1,"#",";
          ENDIF
.
          WRITE     HTMLFILE;*+,"#"",DOCCOD,"#",":                * 26
                             "#"",CLAIMCOD,"#",":
                             "#"",MRMACLOC,"#",":
                             "#"",MRMADOTY,"#",":
                             "#"",PROCTIME,"#",":                * 30 
                             "#"",DIM5,"#",":
                             "#"",BKDIDES1,SP1,"#",":
                             "#"",KEY3,"#",":
                             "#"",ADMISSNO,"#",":
                             "#"",CLAIMDES,"#",";                * 35
.
          MATCH     "1",PTELCMPL
          IF        @EQUAL
            WRITE     HTMLFILE;"#"<input type=checkbox name=dummy ":
                               "checked disabled>#",";
          ELSE
            WRITE     HTMLFILE;"#"<input type=checkbox name=dummy disabled>#",";
          ENDIF
.
          MATCH     "1",PTELXCLS
          IF        @EQUAL
            WRITE     HTMLFILE;"#"<input type=checkbox name=dummy ":
                               "checked disabled>#",";
          ELSE
            WRITE     HTMLFILE;"#"<input type=checkbox name=dummy disabled>#",";
          ENDIF
.
          MATCH     "1",PTELQEXS
          IF        @EQUAL
            WRITE     HTMLFILE;"#"<input type=checkbox name=dummy ":
                               "checked disabled>#",";
          ELSE
            WRITE     HTMLFILE;"#"<input type=checkbox name=dummy disabled>#",";
          ENDIF
.
          MATCH     "1",PTELQACC
          IF        @EQUAL
            WRITE     HTMLFILE;"#"<input type=checkbox name=dummy ":
                               "checked disabled>#",";
          ELSE
            WRITE     HTMLFILE;"#"<input type=checkbox name=dummy disabled>#",";
          ENDIF
.
          CALL      GPAY0000              * Get any payment received
.
          CALL      DOSA0000                * Determine DOSA Status
.
          CLEAR     ARRTLINK
          APPEND    "javascript:UpdateArrTime('",ARRTLINK
          APPEND    ADMISSNO,ARRTLINK
          APPEND    "')",ARRTLINK
          RESET     ARRTLINK
.
          CLEAR     INTVLINK
          APPEND    "javascript:UpdateIntTime('",INTVLINK
          APPEND    ADMISSNO,INTVLINK
          APPEND    "')",INTVLINK
          RESET     INTVLINK
.
          CLEAR     EXPTLINK
          APPEND    "javascript:UpdateExpected('",EXPTLINK
          APPEND    URNUMBER,EXPTLINK
          APPEND    "','",EXPTLINK
          APPEND    ADMISSNO,EXPTLINK
          APPEND    "')",EXPTLINK
          RESET     EXPTLINK
.
          CALL      PATATR00
          MATCH     SP70,PTARVAL3
          IF        @EQUAL
            CALL      CLCBMI00
          ELSE
            PACK      BODMASIN,PTARVAL3,SP70
          ENDIF
          CALL      RNGBMI00
.
          CLEAR     BMIPLINK
          APPEND    "javascript:PatientAttribute('",BMIPLINK
          APPEND    URNUMBER,BMIPLINK
          APPEND    "','",BMIPLINK
          APPEND    ADMISSNO,BMIPLINK
          APPEND    "')",BMIPLINK
          RESET     BMIPLINK
.
          STRIP     ALRTIMG1
          STRIP     ALRTIMG2
          STRIP     ALRTIMG3
          STRIP     ALRTIMG4
          STRIP     ALRTIMG4
          STRIP     ALRTIMGE
          STRIP     ALRTDISA
          PACK      ALRTIMGT,ALRTIMG1,ALRTIMG2,ALRTIMG3,ALRTIMG4,ALRTIMGE:
                             ALRTDISA,ALRTIMG5
.
          WRITE     HTMLFILE;"#"",PTELPPRI," P<br>":
                             PTELPSHA," S<br>":
.                            PTELPTHE," T","#",":
                             PTELPSDY,"SD","#",":
                             "#"",PTELXCSS,"#",":
                             "#"",FORM12P2,"#",":
                             "#"",ALRTLINK,"#",":
                             "#"",ALRTIMGT,"#",";
.
. If template paramater surgflag=1, only display date if booking is surgical
.
          IF        SURGFLAG=1
            IF        SURGBOOK=1
              WRITE     HTMLFILE;"#"",BKREADAT,"#",";
            ELSE
              WRITE     HTMLFILE;"#"",SP1,"#",";
            ENDIF
          ELSE
            WRITE     HTMLFILE;"#"",BKREADAT,"#",";
          ENDIF
.
          IF        ADMISFLAG=1 & FUTRADMN = 0
            WRITE     HTMLFILE;"#"",PMVXATIM,"#",":
                             "#"",PMVXITIM,"#",":
                             "#"",ARRTLINK,"#",":
                             "#"",INTVLINK,"#",":
                             "#"1#",";
          ELSE
            WRITE     HTMLFILE;"#"#",":
                             "#"#",":
                             "#"#",":
                             "#"#",":
                             "#"0#",";
          ENDIF

          PACK      KEY6,EXPTWARD,EXPTBEDD,SP70
          CALL      FWBD0000
          WRITE     HTMLFILE;"#"",WBEDTEXT,"#",";           * 49
          
          PACK      KEY6,POSTWARD,POSTBEDD,SP70
          CALL      FWBD0000
          WRITE     HTMLFILE;"#"",WBEDTEXT,"#",";           * 50
          
          MATCH     SP70,OPDADATE
          IF        !@EQUAL                                 * 51
            WRITE     HTMLFILE;"#"",OPDADATE,"#",";
          ELSE
            MATCH     SP70,BKRXODTE
            IF        !@EQUAL
              WRITE     HTMLFILE;"#"",BKRXODTE,"#",";
            ELSE
              WRITE     HTMLFILE;"#"",SP1,"#",";
            ENDIF
          ENDIF
          MATCH     SP70,WTOPPDAT
          IF        !@EQUAL                                 * 52 
            UNPACK    WTOPPDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            WRITE     HTMLFILE;"#"",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                               SP1,WTOPPTIM,WTOPCLIN,"#",";
          ELSE
            MATCH     SP70,BKREPDAT
            IF        !@EQUAL
              UNPACK    BKREPDAT,CCENT,CYEAR,CMON,CDAY
              MOVE      CMON,F2
              LOAD    MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
              WRITE     HTMLFILE;"#"",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                               SP1,BKREPTIM,"#",";
            ELSE
              WRITE     HTMLFILE;"#"",SP1,"#",";
            ENDIF
          ENDIF
          MATCH     SP70,WTOSPDAT
          IF        !@EQUAL                                 * 53 
            UNPACK    WTOSPDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            WRITE     HTMLFILE;"#"",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                               SP1,WTOSPTIM,WTOSCLIN,"#",";
          ELSE
            WRITE     HTMLFILE;"#"",SP1,"#",";
          ENDIF
.
          WRITE     HTMLFILE;"#"",BKREEDAT,BKREATIM,"#",":  * 54
                             "#"",EPHFUND,"#",": 
                             "#"",EXPTLINK,"#",";
.
          PACK      KEY6,AWARD,ABED 
          CALL      FWBD0000
          WRITE     HTMLFILE;*+,"#"",WBEDTEXT,"#",";       * 57 
.
          WRITE     HTMLFILE;"#"",DOSASTAT,"#",";          * 58
.
          MATCH     "1",PTCNUTOM
          IF        @EQUAL
            PACK      KEY16,ADMISSNO,ADATE,SP70            * use admission date
            IF        BKRESTAT = 0
              PACK      KEY16,ADMISSNO,BKREEDAT,SP70       * use booking date
            ENDIF
          ELSE
            PACK      KEY16,ADMISSNO,SP70
          ENDIF
          CALL      RDPMNUT1
          IF        OVRCD=1
            CALL      CLPMSNUT
          ENDIF
.
          MOVE      SP70,CODE
          PACK      DIETDESC,SP70,SP70
          CLEAR     DIETDESC
          MATCH     "1",PTCNUTOM
          IF        !@EQUAL
            APPEND    "<img border=0 hspace=2 align=absmiddle",DIETDESC
            APPEND    " src='../images/DietIcon.gif'></a>",DIETDESC
          ENDIF
.
          CLEAR     NUTRLINK
          APPEND    "javascript:UpdateNutrition('",NUTRLINK
          APPEND    URNUMBER,NUTRLINK
          APPEND    "','",NUTRLINK
          APPEND    ADMISSNO,NUTRLINK
.
          MATCH     "1",PTCNUTOM
          IF        @EQUAL
            IF        ADMISFLG=1
              APPEND    "','",NUTRLINK
              APPEND    ADATE,NUTRLINK           * use admission date
            ELSE
              APPEND    "','",NUTRLINK
              APPEND    BKREEDAT,NUTRLINK        * use booking date
            ENDIF
            APPEND    "<img border=0 hspace=2 align=absmiddle",DIETDESC
            APPEND    " src='../images/DietIcon.gif'></a>",DIETDESC
          ENDIF
.
          APPEND    "')",NUTRLINK
          RESET     NUTRLINK
.
BKTABC80  MOVE      SP70,DTFASTNG
          MATCH     "1",PMNUFAST
          IF        @EQUAL
            MOVE      "Yes",DTFASTNG                * Patient is Fasting
          ENDIF
.
          MATCH     SP70,PMNUDIET
          IF        @EQUAL
            MATCH     ADMISSNO,DAADMNO
            IF        @EQUAL
              MOVE      ADIET,CODE
            ENDIF
          ELSE
            MOVE      PMNUDIET,CODE
          ENDIF
          MATCH     SP70,CODE
          IF        !@EQUAL
            MOVE      "DC",CATEGORY                   * Diet
            CALL      GETCOD00
            APPEND    TDESC,DIETDESC
          ENDIF
          RESET     DIETDESC
.
          WRITE     HTMLFILE;"#"javascript:LinkPatient('",PATLINK,"');#",":
                             "#"",PTELTOOP,"#",":          * 60
                             "#"",BODMASRN,"#",":          * 61
                             "#"",BMIPLINK,"#",":          * 62
                             "#"",DTFASTNG,"#",":          * 63
                             "#"",PMNUCOM1,"<br>":        * 64
                                  PMNUCOM2,"<br>":               
                                  PMNUCOM3,"<br>":
                                  PMNUCOM4,"<br>":
                                  PMNUCOM5,"#",":               
                             "#"",DIETDESC,"#",":          * 65          
                             "#"",NUTRLINK,"#",":          * 66
                             "#"",DISPCLSS,"#",";          * 67
.
          MATCH     SP70,PTMIXWRD
          IF        @EQUAL | @EOS
            PACK      KEY6,BKREWARD,SP70
          ELSE  
            PACK      KEY6,PTMIXWRD,SP70
          ENDIF
          CALL      FWBD0000
          WRITE     HTMLFILE;*+,"#"",WARDTEXT;                     * 68 part 1
.
          MATCH     SP70,PMVXPOWD
          IF        @EQUAL | @EOS
            PACK      KEY6,BKRXPOWD,SP70
          ELSE
            PACK      KEY6,PMVXPOWD,SP70
          ENDIF
.
          CALL      FWBD0000
.
          WRITE     HTMLFILE;*+,"<br />",WARDTEXT,"#",";
          WRITE     HTMLFILE;"#"",BKDIDES1,"<br>":
                                  BKDIDES2,"<br>":
                                  BKDIDES3,SP1,"#",":
                             "#"",DISPSTAY,"#",":          * 70
                             "#"",DISPACCO,"#",";          * 71
.
          MOVE      SP70,DISPTDAT
.
          PACK      KEY31,BKREBOOK,SP70
          CALL      RSOPDEA2
          CALL      RKOPDEA2
          BRANCH    OVRCD,BKTABC85
.
          MATCH     ADMISSNO,OPDAADMN
          GOTO      BKTABC85 IF NOT EQUAL
.
          PACK      DISPTDAT,OPDADATE,OPDAEXPS,SP70
.
BKTABC85  WRITE     HTMLFILE;"#"",DISPTDAT,"#",":           * 72
                             "#"",PTELEP,"#",":             * 73
                             "#"",PTELEB,"#",":             * 74
                             "#"",PTMXCELL,"#",";           * 75
.
          MOVE      "BG",CATEGORY                   * Pre-Assessment Status
          MOVE      BKRXUDF3,CODE
          CALL      GETCOD00
          APPEND    TDESC,DESCUDF3
.
          WRITE     HTMLFILE;"#"",TDESC,"#",";              * 76
.
          MATCH     "1",PMVXCONF                            * 77
          IF        @EQUAL
            WRITE     HTMLFILE;"#"<input type=checkbox name=dummy ":
                               "checked disabled>#",";
          ELSE
            WRITE     HTMLFILE;"#"<input type=checkbox name=dummy disabled>#",";
          ENDIF
.
          MATCH     "1",PTCNSMSN
          IF        @EQUAL
            PACK      KEY2,SP1,THREE,SP70   * IP visit
            PACK      KEY30,ADMISSNO,SP70   * IP Visit Number
            MOVE      SP70,OBABKDTE 
            CALL      SMSS0000              * Get SMS status for visit
.
            WRITE    HTMLFILE;"#"",KEY50,"#",";             * 78
.
          ELSE
            WRITE    HTMLFILE;"#"#",";                      * 78
          ENDIF
.
.
.         'Booking Type' column...
.
          MATCH    "1",BKTYPCOL             * Output Booking Type short desc?
          IF       @EQUAL
            IF       BKRESTAT=0 | BKRESTAT=1
              MATCH    SP70,BKRETYPE        * No Booking Type?
              IF       @EQUAL
                WRITE    HTMLFILE;"#"#",";                  * 79
              ELSE
                PACK     KEY5,ANSB,ANSK,BKRETYPE,SP70
                CALL     RDCODE1            * Get description
                IF       OVRCD<>1
                  WRITE    HTMLFILE;"#"",TDESC,"#",";       * 79
                ELSE
                  WRITE    HTMLFILE;"#"#",";                * 79
                ENDIF
              ENDIF
            ENDIF
          ELSE
            WRITE     HTMLFILE;"#"#",";                     * 79
          ENDIF
.
          MATCH     SP70,BKREADAT
          IF        !@EQUAL
            WRITE     HTMLFILE;"#"",OPDACASE,"#",";
          ELSE
            WRITE     HTMLFILE;"#"#",";                      * 80
          ENDIF
.
          ADD       ONE,RECCNT
          MOVE      SP70,KEY3
          MOVE      RECCNT,KEY3
          REP       " 0",KEY3
.
          MATCH     "1",PTELCMPL
          IF        @EQUAL
            CALL      CLID0000            * Check Clinical Document
            IF        EXIT=1
              WRITE     HTMLFILE;"#"<input type=checkbox name=prifc",KEY3:
                             " onclick=PrintIFC(this); value='",ADMISSNO:
                             URNUMBER,"' checked>","#",";
            ELSE
              WRITE     HTMLFILE;"#"<input type=checkbox name=prifc",KEY3:
                             " onclick=PrintIFC(this); value='",ADMISSNO:
                             URNUMBER,"'>","#",";
            ENDIF
          ELSE
            WRITE     HTMLFILE;"#"<input type=checkbox name=prifc",KEY3:
                      " disabled>","#",";                        * 81 
          ENDIF
.
.         Intended Stay
          IF       BKRESTAT = 0
            MOVE      CODEVI,CATEGORY             * Claim code Description
            MOVE      BKRXUDF5,CODE
            CALL      GETCOD00
            WRITE     HTMLFILE;"#"",TDESC,"#",";               * 82 
          ELSE 
            IF       BKRESTAT = 1
              MOVE      CODEVI,CATEGORY           * Claim code Description
              MOVE      PMVXIDUS,CODE
              CALL      GETCOD00
              WRITE     HTMLFILE;"#"",TDESC,"#",";             * 82
            ENDIF
          ENDIF
.
.         Pre-assessment 
          PACK     KEY8,ADMISSNO
          CALL     RDBKREC1
          IF        OVRCD=0
            IF       BKRESTAT=0|BKRESTAT=1
              CALL     RDBKRX11
              IF       OVRCD=0
                MOVE      SP70,DISPDAT1                * Visit Date
                UNPACK    BKRXUDD1,CCENT,CYEAR,CMON,CDAY
                MOVE      CMON,F2
                LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
                MATCH     "  ",CDAY
                IF        !@EQUAL
                  PACK      DISPDAT1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP1,AT,SP1,BKRXUDT1
                ENDIF
.
                CLEAR     HTMLLINK
                APPEND    "javascript:UpdatePreAssessment('",HTMLLINK
                APPEND    BKREBOOK,HTMLLINK
                APPEND    "')",HTMLLINK
                RESET     HTMLLINK
.
                CLEAR     EDITICON
                APPEND    "<img src=../images/EditIcon.gif class=Icon></a>",EDITICON
                WRITE      HTMLFILE;"#"",EDITICON,DISPDAT1,"#",":    * 83
                                    "#"",HTMLLINK,"#",";             * 84
              ELSE
                WRITE     HTMLFILE;"#"#",":                          * 83
                                   "#"#",";                          * 84
              ENDIF
            ELSE
              WRITE     HTMLFILE;"#"#",":                          * 83
                                 "#"#",";                          * 84
            ENDIF
          ELSE
            WRITE     HTMLFILE;"#"#",":                            * 83  
                               "#"#",";                            * 84
          ENDIF
.
.         PAC Attended
          MATCH     "1",BKRXPACA                 * PAC attended
          IF        @EQUAL
            WRITE     HTMLFILE;"#"","Yes","#",";                  * 85
          ELSE
            WRITE     HTMLFILE;"#"","No","#",";                   * 85
          ENDIF
.
.         Clinical documents
          MOVE      ZERO,DOCEXIST
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
          CLEAR     LINKDOC 
          APPEND    "javascript:openDocument('",LINKDOC 
          APPEND    URNUMBER,LINKDOC 
          APPEND    "','",LINKDOC
          MOVE      ADMISSNO,DIM8
          MATCH     "00000000",DIM8
          IF        @EQUAL
            MOVE      SP70,DIM8
          ENDIF
          APPEND    DIM8,LINKDOC 
          APPEND    "');",LINKDOC
          RESET     LINKDOC 
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
          OPEN      OBSPCOA2,"obspcoaf"
          PACK      ADMISSNO,ADMISSNO,SP70
          MATCH     SP70,ADMISSNO
          GOTO      BKTABC87 IF NOT EQUAL
.
.         Clinical documents not associated with a visit
.
          MOVE      ADMISSNO,DIM8
          REP       " 0",DIM8
          PACK      KEY20,URNUMBER,DIM8,SP70
          CALL      RSOBPC1
BKTABC86  CALL      RKOBPC1
          BRANCH    OVRCD,BKTABC89
.
          MATCH     URNUMBER,OBPCURNO
          GOTO      BKTABC89 IF NOT EQUAL
          MATCH     DIM8,OBPCCVIS
          GOTO      BKTABC89 IF NOT EQUAL
.
          MOVE      CATwi,CATEGORY           * Get description
          MOVE      OBPCCTYP,CODE
          CALL      GETCOD00
          MATCH     "C",TCINDC3              * Ind3 not equal to "C" so exclude
          GOTO      BKTABC86 IF NOT EQUAL
.
          GOTO      BKTABC88
.
.         Clinical documents associated with a particular visit
.
BKTABC87  PACK      KEY28,ADMISSNO,SP70
          CALL      RSOBPC2
BKTAB87A  CALL      RKOBPC2
          BRANCH    OVRCD,BKTABC89
.
          MATCH     ADMISSNO,OBPCCVIS        * Same visit number
          GOTO      BKTABC89 IF NOT EQUAL
.        
          MOVE      CATwi,CATEGORY           * Get description
          MOVE      OBPCCTYP,CODE
          CALL      GETCOD00
          MATCH     "C",TCINDC3              * Ind3 not equal to "C" so exclude
          GOTO      BKTAB87A IF NOT EQUAL
.
          GOTO      BKTABC88
.
BKTABC88  MOVE      ONE,DOCEXIST
          WRITE     HTMLFILE;"#"",DOCEXIST,"#",":         * 86 - history recvd
                              "#"",LINKDOC,"#",":         * 87
                              "#"#",";
          GOTO      BKTABC90
.
BKTABC89  WRITE     HTMLFILE;"#"",DOCEXIST,"#",":         * 86
                             "#"#",":                     * 87
                             "#"#",";                     * 88

.
.         Contact Details
BKTABC90  WRITE     HTMLFILE;"#"","H: ",PTELEP,"<br>":
                                  "B: ",PTELEB,"<br>":
                                  "M: ",PTMXCELL,"#",":  * 89
                                  "#"",OVERDATE,"#",":   * 90
                                  "#"",WLWMPTY,"#",":    * 91
                                  "#"",WLHIP,"#",":      * 92
                                  "#"",WLRFCDAY,"#",";   * 93
          IF        BKRESTAT=1
             WRITE     HTMLFILE;"#"",ASTAY,"#",";         * 94
          ELSE
             WRITE     HTMLFILE;"#"",BKREELOS,"#",";      * 94
          ENDIF
.
.-------- Tabcol 95 - Admission/Booking date time & Theatre Date *T0870496
          MOVE      SP70,DIM12
          MATCH     SP70,OPDADATE
          IF        !@EQUAL
            UNPACK    OPDADATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP:
                                 OCT,NOV,DEC
            PACK      DIM12,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.         
          WRITE     HTMLFILE;"#"",FBOKDTTM,"<br><br>":
                                  DIM12,"#",";                 * 95
.
.-------- Tabcol 96 - WL PAC Required & PAC Attended            *T0870496
          MOVE      SP70,DIM15
          PACK      KEY19,BKREURNO,BKREPROC,BKRECNT,SP70
          CALL      RDWTTX11
          IF        OVRCD=0
            MOVE      CATXG,CATEGORY           * Get description
            MOVE      WTTXPAST,CODE
            CALL      GETCOD00
            MOVE      TDESC,DIM15            
          ENDIF
.
          MATCH     "1",BKRXPACA                 * PAC attended
          IF        @EQUAL
            WRITE     HTMLFILE;"#"",DIM15,"<br><br>":
                                  "Yes","#",";                  * 96
          ELSE
            WRITE     HTMLFILE;"#"",DIM15,"<br><br>":
                                  "No","#",";                   * 96
          ENDIF
.
.-------- Tabcol 97 - Contact Details - with email address       *T0870496 
          REP       "\ ",PMPXPEML
          WRITE     HTMLFILE;"#"","H: ",PTELEP,"<br>":
                                  "B: ",PTELEB,"<br>":
                                  "M: ",PTMXCELL,"<br>": 
                                  "E: ",PMPXPEML,"#",";          * 97
.
.-------- External Visit 
          CLEAR     EXTVSTID
          CLEAR     CHKEXTVD
          PACK      CHKEXTVD,ADMISSNO,SP70
          PROC      CHKEID00
          MATCH     KEY20,SP70
          IF        @EQUAL
            PACK      EXTVSTID,ADMISSNO
          ELSE
            APPEND    ADMISSNO,EXTVSTID
            APPEND    SP2,EXTVSTID
            APPEND    "<span class='TextBlue'>(",EXTVSTID
            APPEND    KEY20,EXTVSTID
            APPEND    ")</span>",EXTVSTID
          ENDIF
          WRITE     HTMLFILE;"#"",EXTVSTID,"#",";                   * 98
          WRITE     HTMLFILE;"#"",DISPCLSS,"#",":                * 99
                             "#"",DISPALTD,"#");";                * 100
.
.----------------------------------------------------------------------        
.
BKTABC99  MOVE      SP70,AWARD
          MOVE      SP70,PATUNT01
          MOVE      SP70,PATUNT02
          MOVE      SP70,PTMIXWRD
          MOVE      SP70,PTMIEBED
          MOVE      SP70,BKREWARD
          MOVE      SP70,BKRXPOWD
          MOVE      SP70,TWARD
          MOVE      SP70,BKREPDAT
          MOVE      SP70,EPHFUND
          MOVE      SP70,OVERDATE
          MOVE      SP70,WLWMPTY
          MOVE      SP70,WLRFCDAY
          MOVE      SP70,WLHIP
          RETURN
+
.----------------------------------------------------------------------        
.         Check if Clinical document has been printed today
.----------------------------------------------------------------------        
CLID0000  OPEN      OBSPCOA2,"obspcoaf"
          CALL      IBACLOCK
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          PACK      KEY28,ADMISSNO,KEY8,SP70
          CALL      RSOBPC2
          CALL      RKOBPC2
          BRANCH    OVRCD,CLID9000
.
          MATCH     ADMISSNO,OBPCCVIS        * Same visit number
          GOTO      CLID9000 IF NOT EQUAL
.
          MATCH     OBPCINDT,KEY8
          GOTO      CLID9000 IF NOT EQUAL
.
          MOVE      ONE,EXIT                 * Printed today
          GOTO      CLID9999
.
CLID9000  MOVE      ZERO,EXIT
CLID9999  RETURN
+
.----------------------------------------------------------------------        
.         Get payment recieved
.----------------------------------------------------------------------        
GPAY0000  MOVE      ZERO,FORM12P2
          PACK      KEY25,ADMISSNO,SP70
          CALL      RSRCDTE6
GPAY1000  CALL      RKRCDTE6
          BRANCH    OVRCD,GPAY9999
.
          MATCH     ADMISSNO,RCDTVIST
          GOTO      GPAY9999 IF NOT EQUAL
.
          PACK      KEY12,RCDTRECN,SP70
          CALL      RDRCBNK1
          BRANCH    OVRCD,GPAY2000 
.
          MATCH     "1",RCBNSTAT
          GOTO      GPAY1000 IF EQUAL            * Already cancelled
.
GPAY2000  ADD       RCDTAMNT,FORM12P2
          GOTO      GPAY1000
.
GPAY9999  RETURN
+
.-----------------------------------------------------------
.         Clear eligibility fields
.-----------------------------------------------------------
CLRELG00  CALL      CLPATELG
.
CLRELG99  RETURN
+
.------------------------------------------------------------
. Get Document type and location
.------------------------------------------------------------
MRTDET00  PACK      KEY8,ADMISSNO,SP70
          CALL      RDMRVS1
          BRANCH    OVRCD,MRTDET10
.
          PACK      KEY10,MRVSMKEY,SP70
          CALL      RDMRMAS2
          BRANCH    OVRCD,MRTDET10
          GOTO      MRTDET99
.
MRTDET10  READ     CONTROLF,SIXTY;*84,MRCNHLOC
          READ     CONTROLF,SIXTY;*88,MRCNRCTY
.
          MOVE     MRCNHLOC,DFLTLOCN                        * start   *I-240724
          MOVE     SP4,DFLTHOSP
          IF       IBCNMHOS = 1
            MOVE      WBSEHOSP,DFLTHOSP
            MATCH     SP3,WBSEHHOS
            IF        !@EQUAL
              MOVE      WBSEHHOS,DFLTHOSP
              MOVE      WBSEHLOC,DFLTLOCN
            ENDIF
.
            PACK      KEY3,WBSEHOSP,SP10
            CALL      RDPTHSP1
            IF        OVRCD <> 1
              MATCH     SP3,PTHSHHOS
              IF        !@EQUAL
                MOVE      PTHSHHOS,DFLTHOSP
                MOVE      PTHSHLOC,DFLTLOCN
              ENDIF
            ENDIF
          ENDIF                                             * end     *I-240724
            
          PACK     KEY20,URNUMBER,DFLTHOSP,DFLTLOCN,MRCNRCTY,Z70      *C-240724
          CALL     RSMRMAS1
          CALL     RPMRMAS1
          BRANCH   OVRCD,MRTDET90
.
          MATCH    URNUMBER,MRMAURNO
          GOTO     MRTDET20 IF NOT EQUAL
.
          MATCH    DFLTLOCN,MRMAHLOC                                  *C-240724
          GOTO     MRTDET20 IF NOT EQUAL
.
          MATCH    MRCNRCTY,MRMADOTY
          GOTO     MRTDET99 IF EQUAL
.
MRTDET20  PACK     KEY20,URNUMBER,Z70                                  *C-240724
          CALL     RSMRMAS1
          CALL     RPMRMAS1
          BRANCH   OVRCD,MRTDET90
.
          MATCH    URNUMBER,MRMAURNO
          GOTO     MRTDET99 IF EQUAL
.
MRTDET90  MOVE     SP70,DOCTYPE
          MOVE     SP70,DOCLOC
.
MRTDET99  RETURN
+
.------------------------------------------------------------
. Format Booking Date
.------------------------------------------------------------
BOKDAT00  UNPACK    BKREEDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          UNPACK    BKREATIM,DIM2,DIM1,DIM2A
          MOVE      DIM2,F2
          IF        F2>=12
            MOVE      "pm",DIM2B
            IF         F2>=13
              ASSIGN     F2-12,F2
              MOVE       F2,DIM2
            ENDIF
          ELSE
            MOVE      "am",DIM2B
            MOVE      F2,DIM2
          ENDIF 
.  
          PACK      FBOKDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
..          PACK      FBOKDTTM,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP1:
..                             AT,DIM2,DIM1,DIM2A,DIM2B
..          PACK      FBOKDTTM,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP1:
..                             AT,BKREATIM
          PACK      FBOKDTTM,BKREEDAT,BKREATIM
.
BOKDAT99  RETURN
.---------------------------------------------------------------
. Discharge Date
.------------------------------------------------------------
DISDAT00  UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
DISDAT99  RETURN
.
.------------------------------------------------------------
. Discharge Time
.------------------------------------------------------------
DISTIM00  UNPACK    DTIME,DIM2,DIM1,DIM2A
          MOVE      DIM2,F2
          IF        F2>=12
            MOVE      "pm",DIM2B
            IF        F2>=13
              ASSIGN    F2-12,F2
              MOVE      F2,DIM2
            ENDIF
          ELSE
            MOVE      "am",DIM2B 
            MOVE      F2,DIM2
          ENDIF
.
DISTIM99  RETURN
.
.------------------------------------------------------------
. Format Person's Name in Title Text
.------------------------------------------------------------
PERNAM00  CLEAR     DISPNAME
          MOVE      SP70,PERFNAME
          PACK      NAME35,IBPHGNAM,SP70
          CALL      NAMSTR00
          PACK      NAME35,IBPHSNAM,SP70
          CALL      NAMSTR00
          APPEND    SP70,DISPNAME
          RESET     DISPNAME
          MOVE      DISPNAME,PERFNAME
          STRIP     PERFNAME
          RETURN
.------------------------------------------------------------
. Standby Patients
.-----------------------------------------------------------
PSTB0000  BRANCH    FLDITMNO,PSTB0100,PSTB0200
          GOTO      PSTB9999
.
PSTB0100  MOVE      ZERO,LNK2PRT 
          CALL      TOPS0000                * Table of Standby Patients
          GOTO      PSTB9999
.
PSTB0200  PACK      DFLTWARD,WARDCODE
          CALL      WSEL0000                * Ward selection list
          GOTO      PSTB9999
.
PSTB9999  RETURN 
.
.------------------------------------------------------------
. HCP Selection List
.------------------------------------------------------------
SURG0000  PACK      KEY10,SP70
          CALL      RSPMHCP1
SURG1000  CALL      RKPMHCP1
          BRANCH    OVRCD,SURG9999
          MOVE      PMHCSTTS,FORM1
          COMPARE   ZERO,FORM1                 * list only active HCP
          GOTO      SURG1000 IF NOT EQUAL
.
          IF        IBCNMHOS=1
            MATCH     SP70,WBSEHOSP
            GOTO      SURG2000 IF EQUAL
.
            PACK      KEY13,WBSEHOSP,PMHCHCPC,SP70
            CALL      RDMLHCP1
            BRANCH    OVRCD,SURG1000
            
            MATCH     WBSEHOSP,MLHCHOSP            * if current hospital
            GOTO      SURG1000 IF NOT EQUAL
          ENDIF
.
SURG2000  MOVE      PMHCTITL,FMTTITLE
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000
.
          PACK      KEY20,DOCFNAME
          PACK      KEY10,PMHCHCPC
          MATCH     SURGEON,PMHCHCPC
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY10," selected>",KEY20:
                               "   (",PMHCHCPC,")";
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY10,">",KEY20,"   (",PMHCHCPC:
                               ")";
.
          ENDIF
          IF        IBCNMHOS<>1
            GOTO      SURG3000
          ENDIF
.
          MATCH     SP70,WBSEHOSP
          GOTO      SURG3000 IF NOT EQUAL
.
          WRITE     HTMLFILE;" - ",PTWDHOSN;
.
SURG3000  WRITE     HTMLFILE;"</option>"
          GOTO      SURG1000
.
SURG9999  RETURN
.-----------------------------------------------------------
. Table of Standby Patients
.-----------------------------------------------------------
TOPS0000  CALL      TABHED00 
          PACK      KEY14,SP70             
          CALL      RDSWARD4
TOPS0010  CALL      RDKWARD4
          BRANCH    OVRCD,TOPS9999
.
          IF        IBCNMHOS=1
            MATCH     WBSEHOSP,PTWDHOSN
            GOTO      TOPS0010 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,WARDCODE
          IF        !@EQUAL
            MATCH     WARDCODE,WWARD
            GOTO      TOPS0010 IF NOT EQUAL 
          ENDIF
.
          MATCH     ZEROVISN,WSTBY
          GOTO      TOPS0010 IF EQUAL 
          MOVE      SP70,TDESC
.
.         We have a standby admission number. Now get the relevant details
.
TOPS0020  CALL      PATLN000      * Format Pateint Name with System Parameter
          MOVE      SP70,DIM1     * Set up Flag
          MOVE      WSTBY,KEY8
          CALL      RDMISS1             * Read in the admission record
          BRANCH    OVRCD,TOPS8800      * No admission record
.
          PACK      CATEGORY,ANSA,SP70
          MOVE      ATYPE,CODE
          CALL      GETCOD00
          MOVE      TDESC,ATYPDESC
.
          MOVE      "AC",CATEGORY          * Unit Description
          MOVE      ACLSSFT,CODE
          CALL      GETCOD00
          MOVE      TDESC,UNITDESC
.
          MOVE      AURNO,KEY8          * Set up key for PMI record
          CALL      RDMAST1             * Read in the PMI record
          BRANCH    OVRCD,TOPS8900      * No PMI record
          CALL      RDPMPX21
.
          CALL      STBCON00
          GOTO      TOPS0010            
.
.         No admission record
.
TOPS8800  MOVE      ZEROUR,AURNO        * No U/R number
          MOVE      "* Missing Adm Record *",FORMATNM
          MOVE      SP1,PSEX            * No Sex
          MOVE      ZERO,PSAGE          * No Age
          MOVE      SP30,DOCFNAME         * No doctor
          PACK      ADIAG1,SP70         * No diagnosis
          PACK      ADIAG2,SP70         * No diagnosis
          MOVE      "F",DIM1            * Set Flag
          CALL      STBCON00
          GOTO      TOPS0010 
.
.         No PMI record
.
TOPS8900  MOVE      AURNO,PURNO          * Save U/R number
          MOVE      "* Missing Master Record *",FORMATNM
          MOVE      SP1,PSEX            * No Sex
          MOVE      ZERO,PSAGE          * No Age
          MOVE      "F",DIM1            * Set Flag
.
          CALL      STBCON00
          GOTO      TOPS0010 
.
TOPS9999  RETURN
.-----------------------------------------------------------
. Standby Contents
.----------------------------------------------------------- 
STBCON00  MOVE      AURNO,URNUMBER          * URNUMBER used in GETPAT
          MOVE      AADMNO,ADMISSNO         * ADMISSNO used in GETPAT
          MATCH     ZEROUR,URNUMBER
          IF        !@EQUAL
            CALL      GETPAT00              * Get patient information 
          ENDIF
.
          MATCH     DIM1,SP70               * Check to see if Flag is set
          IF        @EQUAL
            MOVE      URNUMBER,PURNO
            CALL      PATLN000      * Format Pateint Name with System Parameter
          ENDIF
.
          MOVE      SP70,DOCFNAME
          MOVE      ADOCTA,KEY6
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE       * I CAR 13038
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000             * end I CAR 13038
          ENDIF
.
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
          CLEAR     PATLINK
          APPEND    LINKPRG,PATLINK
          APPEND    ".pbl?reportno=",PATLINK
          APPEND    LINKREP,PATLINK
          APPEND    "&template=",PATLINK
          APPEND    LINKTEM,PATLINK
          APPEND    "&urnumber=",PATLINK
          APPEND    URNUMBER,PATLINK
          APPEND    "&admissno=",PATLINK
          APPEND    ADMISSNO,PATLINK
          RESET     PATLINK
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
          REP       "#" ",ADIAG1
          REP       "#" ",ADIAG2
.
          CALL      PATFLD00               *Returns KEY3 for folder colour code
.
          PACK      KEY6,WWARD,WBED,SP70
          CALL      FWBD0000
          WRITE     HTMLFILE;"t.addRow(#"",FORMATNM,"#",":
                             "#"",WARDTEXT,"#",":
                             "#"",BEDTEXT,"#",":
                             "#"",UNITDESC,"#",":
                             "#"",ADMISSNO,"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",ADIAG1,ADIAG2,"#",":
                             "#"",PATLINK,"#",":
                             "#"",URNUMBER,"#",":
                             "#"",KEY3,"#",":
                             "#"",ATYPDESC,"#");"
STBCON99  RETURN
.-----------------------------------------------------------
. On Leave Patients
.-----------------------------------------------------------
ONLV0000  CALL      TABHED00 
          PACK      KEY9,FOUR,SP70
          CALL      RDSMISS2
ONLV0010  CALL      RDKMISS2
          BRANCH    OVRCD,ONLV9999
.
          COMPARE   FOUR,ASTAT
          GOTO      ONLV9999 IF NOT EQUAL
.
          IF        IBCNMHOS=1
            MATCH     WBSEHOSP,PMVXMHOS
            GOTO      ONLV0010 IF NOT EQUAL
          ENDIF
.
          COMPARE   MNHLONLV,ONE           * I SRF 22732
          IF        @EQUAL
            PACK      KEY8,AADMNO,SP70     * Find out if this patient is a
            CALL      RDMHVIS1             * Mental Health Patient
            BRANCH    OVRCD,ONLV0010     
          ENDIF
.                                          * end I SRF 22732
          MOVE      "AC",CATEGORY          * Unit Description
          MOVE      ACLSSFT,CODE
          CALL      GETCOD00
.
          MOVE      AURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,ONLV0010 
          CALL      RDPMPX21
.
          MOVE      "LS",CATEGORY          * I SRF 22732
          MOVE      PTMXLS,CODE
          CALL      GETCOD00               * Get description for legal status
          MOVE      TDESC,LESTDESC         * end I SRF 22732
.
          CALL      CNLV0000
.
          PACK      KEY14,AWARD,ABED,AADMNO
          CALL      RDONLV1
.
          MOVE      ZERO,SVLVDAYS
.
          PACK      KEY30,AADMNO,SP70
          CALL      RDSTRAN2
ONLV0020  CALL      RDKTRAN2
          BRANCH    OVRCD,ONLV0030
.
          MATCH     AADMNO,TADMN
          GOTO      ONLV0030 IF NOT EQUAL
.
          MOVE      PTTRLTYP,ACODE          * save last leave type
          MOVE      TADMN,STADMN
          MOVE      TDATE,STDATE
          MOVE      TTIME,STTIME
          GOTO      ONLV0020
.
.         have got to last tran record
.
ONLV0030  MOVE      SP3,LEAVETYP
.
          COMPARE   MNHLONLV,ONE
          IF        @EQUAL                     
            MATCH     SP3,ACODE                * I SRF 22732
            GOTO      ONLV0010 IF EQUAL
          ENDIF                                
.
          MATCH     SP3,ACODE
          GOTO      ONLV0040 IF EQUAL          * no type of leave
.
          PACK      KEY5,CATTL,ACODE
          CALL      RDCODE1
          BRANCH    OVRCD,ONLV0010             * invalid type of leave
.
          MOVE      TDESC,LEAVETYP
          MOVE      TCFORM6,SVLVDAYS
.
          COMPARE   MNHLONLV,ONE               * I SRF 22732
          GOTO      ONLV0040 IF NOT EQUAL
.
          MATCH     SP3,TYPECODE               * 'All' selected
          GOTO      ONLV0034 IF EQUAL
          MATCH     TYPECODE,ACODE             * Only display selected leave 
          GOTO      ONLV0010 IF NOT EQUAL      * type
.
ONLV0034  MATCH     SP1,TCINDC1
          GOTO      ONLV0010 IF EQUAL
          GOTO      ONLV0040                   * end I SRF 22732
.                 
ONLV0035  MATCH     SP1,TCINDC1
          GOTO      ONLV0010 IF NOT EQUAL      * Mental Health leave
.
ONLV0040  CALL      OLVCON00                 
          GOTO      ONLV0010
.
ONLV9999  RETURN  
.-----------------------------------------------------------
. OnLeave Contents
.----------------------------------------------------------- 
OLVCON00  MOVE      AURNO,URNUMBER          * URNUMBER used in GETPAT
          MOVE      AADMNO,ADMISSNO         * ADMISSNO used in GETPAT
          MATCH     ZEROUR,URNUMBER
          IF        !@EQUAL
            CALL      GETPAT00              * Get patient information 
          ENDIF
.          
          MOVE      SP70,DOCFNAME
          MOVE      ADOCTA,KEY6
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE       * I CAR 13038
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000             * end I CAR 13038
          ENDIF
.
          CALL      ADMDAT00                * Format admission date
.
          CALL      ONLDAY00                * Calculates the on leave days
.
          MATCH     SP70,SVCNLVDT
          IF        @EQUAL|@EOS
            MOVE      DAYSON,CNLVDAYS
          ENDIF
.
          MOVE      SP70,SVLVDYIN
          COMPARE   DAYSON,SVLVDAYS
          IF        @LESS
            MOVE      "Red",SVLVDYIN
          ENDIF
.
          CALL      PATLN000                * Patent Name format  
.
          MOVE      CATAC,CATEGORY          * Unit Description
          MOVE      ACLSSFT,CODE
          CALL      GETCOD00
          MOVE      TDESC,UNITDESC          * save unit description
.
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
          CLEAR     PATLINK
          APPEND    LINKPRG,PATLINK
          APPEND    ".pbl?reportno=",PATLINK
          APPEND    LINKREP,PATLINK
          APPEND    "&template=",PATLINK
          APPEND    LINKTEM,PATLINK
          APPEND    "&urnumber=",PATLINK
          APPEND    AURNO,PATLINK
          APPEND    "&admissno=",PATLINK
          APPEND    AADMNO,PATLINK
          RESET     PATLINK
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
          CALL      PATFLD00               *Returns KEY3 for folder colour code
.
          CALL      XRET0000               * Set expected return date class
.
          PACK      KEY6,OWARD,OBED
          CALL      FWBD0000
          WRITE     HTMLFILE;"t.addRow(#"",FORMATNM,"#",":     * 0
                             "#"",WARDTEXT,"#",":              * 1
                             "#"",BEDTEXT,"#",":               * 2
                             "#"",ADMISSNO,"#",":              * 3
                             "#"",STDATE,"#",":                * 4
                             "#"",OERDATE,"#",":               * 5
                             "#"",ADATE,"#",":                 * 6
                             "#"",PATLINK,"#",":               * 7
                             "#"",URNUMBER,"#",":              * 8
                             "#"",UNITDESC,"#",":              * 9
                             "#"",DAYSON,"#",":                * 10
                             "#"",PSEX,"#",":                  * 11
                             "#"",LEAVETYP,"#",":              * 12
                             "#"",LESTDESC,"#",":              * 13
                             "#"",KEY3,"#",":                  * 14
                             "#"",OERDATE,OERTIME,"#",":       * 15
                             "#"",XRETCLAS,"#",":              * 16
                             "#"",CNLVDAYS,"#",":              * 17
                             "#"",SVCNLVIN,"#",":              * 18
                             "#"",SVLVDYIN,"#");"              * 19
OLVCON99  RETURN
+
.--------------------------------------------------------------------
. Set the class of the expected return date/time to red
. if the patient is overdue from the expected return date/time
.--------------------------------------------------------------------
XRET0000  MOVE      SP70,XRETCLAS
.
          MATCH     SP70,OERDATE                 * Expected return date
          GOTO      XRET9999 IF EQUAL
.
          PACK      KEY8,CTIMEIS
          REP       ": ",KEY8
          SQUEEZE   KEY8
          PACK      TESTDAT1,CCC,CYY,CMM,CDD,KEY8
          REP       " 0",TESTDAT1
.
          MATCH     SP70,OERTIME
          IF        @EQUAL
            MOVE      "99:99:99",KEY8
          ELSE
            MOVE      OERTIME,KEY8
          ENDIF
          REP       ": ",KEY8
          SQUEEZE   KEY8
.
          PACK      TESTDAT2,OERDATE,KEY8
          REP       " 0",TESTDAT2
.           
          MATCH     TESTDAT2,TESTDAT1
          GOTO      XRET9999 IF LESS
.
          MOVE      "Red",XRETCLAS
.
XRET9999  RETURN
+
.--------------------------------------------------------------------
.   ONLDAY00 :  Calculates the on leave days
.--------------------------------------------------------------------
ONLDAY00  CALL      IBACLOCK                      * Current Date
          PACK      KEY8,CC,YY,MM,DD,SP70
          REP       " 0",KEY8
.
          DAYSEP    STDATE,KEY8,DAYSON 
.
ONLDAY99  RETURN
.-----------------------------------------------------------
. Pre-Assessments  by Date Range
.-----------------------------------------------------------
PASS0000  BRANCH    FLDITMNO,PASS0100,PASS0200,PASS0300,PASS0400:
                             PASS0500,PASS0600,PASS0700,PASS0800:
                             PASS0900,PASS1000,PASS1100,PASS1200:
                             PASS1300,PASS1400,PASS1500,PASS1600
.
PASS0100  CALL      NEXT0000
          GOTO      PASS9999
.
PASS0200  CALL      PREV0000
          GOTO      PASS9999
.
PASS0300  CALL      CURSTD00
          GOTO      PASS9999
.
PASS0400  CALL      CUREND00
          GOTO      PASS9999
.
PASS0500  CALL      CURYR000
          GOTO      PASS9999
.
PASS0600  CALL      CURMON00
          GOTO      PASS9999
.
PASS0700  CALL      SELV0000
          GOTO      PASS9999
.
PASS0800  CALL      TASS0000                * Table of Assessments
          GOTO      PASS9999
.
PASS0900  WRITE     HTMLFILE;TEMPLATE;
          GOTO      PASS9999
.
PASS1000  WRITE     HTMLFILE;REPORTNO;
          GOTO      PASS9999
.
PASS1100  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      PASS9999
.
PASS1200  WRITE     HTMLFILE;SHOWCANC;
          GOTO      PASS9999
.
PASS1300  MATCH     SP70,FILTHOSP
          IF        @EQUAL
            MOVE      WBSEHOSP,FILTHOSP
          ENDIF
          CALL      HSEL0000
          GOTO      PASS9999
.
PASS1400  WRITE     HTMLFILE;PACAFLAG;
          GOTO      PASS9999
.
PASS1500  CALL      TASS0000                * Table of Assessments
          GOTO      PASS9999
.
PASS1600  MOVE      CODEAC,CATEGORY         * unit code
          MOVE      UNITCODE,CODE
          CALL      CODSEL00
          GOTO      PASS9999
.
PASS9999  RETURN
.-----------------------------------------------------------
. Table of Assessments
.-----------------------------------------------------------
TASS0000  CALL       TABHED00
          PACK       KEY24,FRSTDATE,SP70
          CALL       RSBKREC5
TASS0010  MOVE       "1",NOPATATR
          CALL       RKBKREC5
          BRANCH     OVRCD,TASS9999
          PACK       KEY8,DBKREBOO,SP70
          CALL       RDBKRX11
          BRANCH     OVRCD,TASS0010
          CALL       CLPATATR
          PACK       KEY35,BKREURNO,DBKREBOO,ATYPE030,BKRXUDD1,BKRXUDT1:
                     SP70
          CALL       RDPTATR3
          IF         OVRCD=1
            MOVE     "0",NOPATATR
          ENDIF
          PACK       KEY8,DBKREBOO,SP70
          CALL       RDMISS1
.
          IF         SHOWCANC<>1
            COMPARE    TWO,BKRESTAT               * Cancelled ?
            GOTO       TASS0010 IF EQUAL
          ENDIF
.
          MATCH     SP70,UNITCODE                 * Specialty filter
          IF        !@EQUAL
            MOVE      SP70,DIM3
            MATCH     SP70,ACLSSFT
            IF        !@EQUAL
              MOVE      ACLSSFT,DIM3
            ELSE
              MATCH     SP70,BKREDEPT
              IF        !@EQUAL
                MOVE      BKREDEPT,DIM3
              ENDIF
            ENDIF
.
            MATCH     UNITCODE,DIM3
            GOTO      TASS0010 IF NOT EQUAL
          ENDIF
.
          MATCH      BKREPDAT,LASTDATE
          GOTO       TASS9999 IF LESS
.
          MOVE       BKREURNO,URNUMBER
.
          MATCH      ZEROUR,BKREURNO
          GOTO       TASS0020 IF EQUAL             * Pre-admitted
.
          MOVE       BKREURNO,KEY8
          CALL       RDMAST1
          CALL       RDPMPX21
          COMPARE    ZERO,OVRCD
          GOTO       TASS0030 IF EQUAL
.
TASS0020  MOVE       BKREBOOK,KEY8
          CALL       RDPRAM1
          BRANCH     OVRCD,TASS0010
.
          MOVE       "   N/A",URNUMBER
.
TASS0030  UNPACK    BKREPDAT,XCENT,XYEAR,XMON,XDAY
.
          IF        IBCNMHOS<>1
            GOTO      TASS0040
          ENDIF
.
          MATCH     SP70,WBSEHOSP
          GOTO      TASS0040 IF EQUAL
.
          IF        PTCNDWAW=0 
            MATCH     SP70,BKRXPOWD
            GOTO      TASS0040 IF EQUAL
            PACK      KEY6,BKRXPOWD,SP70
            CALL      RDWARD1
            BRANCH    OVRCD,TASS0040
          ELSE
            MATCH     SP70,BKREWARD
            GOTO      TASS0040 IF EQUAL
            PACK      KEY6,BKREWARD,SP70
            CALL      RDWARD1
            BRANCH    OVRCD,TASS0040
          ENDIF
.
          MATCH     WBSEHOSP,PTWDHOSN
          GOTO      TASS0010 IF NOT EQUAL
.
TASS0040  MOVE      BKREADOC,KEY6
          CALL      RDDOCT1
          IF        OVRCD=0 
            MOVE      DTITL,FMTTITLE       * I CAR 13038
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000             * end I CAR 13038
          ENDIF
.
          CALL      ASSCON00                * Assessment contents
          GOTO      TASS0010
.
TASS9999  RETURN
.-----------------------------------------------------------
. Assesments Contents
.-----------------------------------------------------------
ASSCON00  MOVE      BKREURNO,URNUMBER          * URNUMBER used in GETPAT
          MOVE      BKREBOOK,ADMISSNO          * ADMISSNO used in GETPAT
.
          UNPACK    PBDATE,CDAY,CMON,CYEAR,CCENT
          CALL      IBACLOCK
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
          CALL      PATNAM00
          CALL      PATLN000    * format Name with System Parameter
.
          MOVE      SP70,DOCFNAME
          MOVE      BKREADOC,KEY6
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE       * I CAR 13038
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000             * end I CAR 13038
          ENDIF
.
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
          CLEAR     PATLINK
          APPEND    LINKPRG,PATLINK
          APPEND    ".pbl?reportno=",PATLINK
          APPEND    LINKREP,PATLINK
          APPEND    "&template=",PATLINK
          APPEND    LINKTEM,PATLINK
          APPEND    "&urnumber=",PATLINK
          APPEND    URNUMBER,PATLINK
          APPEND    "&admissno=",PATLINK
          APPEND    ADMISSNO,PATLINK
          RESET     PATLINK
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
          CLEAR     HTMLLINK
          APPEND    "javascript:UpdatePreAssessment('",HTMLLINK
          APPEND    BKREBOOK,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          CLEAR     HISTLINK
          APPEND    "javascript:historyReceived('",HISTLINK
          APPEND    BKREURNO,HISTLINK
          APPEND    "','",HISTLINK
          APPEND    DBKREBOO,HISTLINK
          APPEND    "')",HISTLINK
          RESET     HISTLINK
.
          CLEAR     COMMLINK
          APPEND    "javascript:commentsLink('",COMMLINK
          APPEND    BKREURNO,COMMLINK
          APPEND    "','",COMMLINK
          APPEND    DBKREBOO,COMMLINK
          APPEND    "')",COMMLINK
          RESET     COMMLINK

          WRITE     HTMLFILE;"t.addRow(#"",FORMATNM,"#",";
.
          CALL      PATFLD00               *Returns KEY3 for folder colour code
.
          MOVE      SP70,TDESC
          MOVE      SP70,DIM20A
          MATCH     SP70,BKRXUDF3
          IF        !@EQUAL
            PACK      KEY5,ANSB,ANSG,BKRXUDF3,SP70
            CALL      RDCODE1
            MOVE      TDESC,DIM20A
          ENDIF
.
          IF        BKRESTAT=2
            MOVE    "RedText",ROWCLASS
          ELSE
            MOVE     SP70,ROWCLASS
          ENDIF
.
          MOVE      SP70,TDESC
          MOVE      SP70,DIM20B
          MATCH     SP70,ACLSSFT
          IF        !@EQUAL
            PACK      KEY5,ANSA,ANSC,ACLSSFT,SP70
            CALL      RDCODE1
          ELSE
            MATCH     SP70,BKREDEPT
            IF        !@EQUAL
              PACK      KEY5,ANSA,ANSC,BKREDEPT,SP70
              CALL      RDCODE1
            ENDIF
          ENDIF
          MOVE      TDESC,DIM20B
.
          PACK      SP320,SP70,SP70,SP70,SP70,SP70
          PACK      DIM320,SP70,SP70,SP70,SP70,SP70
          PACK      DIM320,PTARTXT1,PTARTXT2,PTARTXT3,PTARTXT4
          MATCH     DIM320,SP320
          IF        @EQUAL
            MOVE      "0",CMNTSFLG
          ELSE
            MOVE      "1",CMNTSFLG
          ENDIF
.
          MOVE      "0",HISTRECV
          MOVE      SP70,KEY11
          PACK      KEY20,URNUMBER,ADMISSNO,Z70
          CALL      RSOBPC1
ASSCON50  CALL      RPOBPC1
          BRANCH    OVRCD,ASSCON55
.
          MATCH     URNUMBER,OBPCURNO
          GOTO      ASSCON55 IF NOT EQUAL
          MATCH     ADMISSNO,OBPCCVIS
          GOTO      ASSCON55 IF NOT EQUAL
.
          MATCH     SP70,OBPCCTYP
          IF        !@EQUAL
            PACK      KEY5,CODEWI,OBPCCTYP,SP70
            CALL      RDCODE1
            BRANCH    OVRCD,ASSCON50
            MATCH     "M",TCINDC2
            GOTO      ASSCON50 IF NOT EQUAL
            MOVE      "1",HISTRECV
.
            MATCH     SP70,OBPCINDT
            IF        !@EQUAL
              UNPACK    OBPCINDT,CCENT,CYEAR,CMON,CDAY
              MOVE      CMON,F2
              LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
              PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
            ENDIF
            GOTO      ASSCON55
          ENDIF
          GOTO      ASSCON50
.
ASSCON55  MATCH     "0",HISTRECV
          IF        @EQUAL
            PACK      HISTLINK,SP70,SP70,SP70,SP70,SP70
          ENDIF
          MATCH     "0",NOPATATR
          IF        @EQUAL
            PACK      COMMLINK,SP70,SP70,SP70,SP70,SP70
          ENDIF
.
          WRITE     HTMLFILE;"#"",BKREBOOK,"#",":                         * 1
                             "#"",BKREURNO,"#",":                         * 2
                             "#"",BKREPDAT,BKREPTIM,"#",":                * 3
                             "#"",PATLINK,"#",":                          * 4
                             "#"",DOCFNAME,"#",":                         * 5
                             "#"",KEY3,"#",":                             * 6
                             "#"",BKRXUDD1,BKRXUDT1,"&nbsp;#",":          * 7
                             "#"",DIM20A,"&nbsp;#",":                     * 8
                             "#"",HTMLLINK,"#",":                         * 9
                             "#"",ROWCLASS,"#",";                         * 10
.
          MATCH     SP70,BKREPDAT                * PAC required
          IF        !@EQUAL
            WRITE     HTMLFILE;"#"<input type=checkbox name=dummy checked ":
                               "disabled>","#",";
          ELSE
            WRITE     HTMLFILE;"#"<input type=checkbox name=dummy ":
                               "disabled>","#",";
          ENDIF
.
          MATCH     "1",BKRXPACA                 * PAC attended
          IF        @EQUAL
            WRITE     HTMLFILE;"#"<input type=checkbox name=dummy checked ":
                               "disabled>","#",";
          ELSE
            WRITE     HTMLFILE;"#"<input type=checkbox name=dummy ":
                               "disabled>","#",";
          ENDIF
.
          MATCH     "1",CMNTSFLG
          IF        @EQUAL
            WRITE     HTMLFILE;"#"",PTARTXT1,"<br>":                      * 13
                                  PTARTXT2,"<br>":
                                  PTARTXT3,"<br>":
                                  PTARTXT4,"<br>","#",";
          ELSE
            WRITE    HTMLFILE;"#"","&nbsp;","#",";
          ENDIF
.
          WRITE     HTMLFILE;"#"",NOPATATR,"#",";                         * 14
.
          WRITE     HTMLFILE;"#"",DIM20B,"#","                            * 15
.
          WRITE     HTMLFILE;"#"",KEY11,"#",";                            * 16
.
          WRITE     HTMLFILE;"#"",HISTRECV,"#",";                         * 17
.
          WRITE     HTMLFILE;"#"",HISTLINK,"#",";                        * 18
.
          WRITE     HTMLFILE;"#"",COMMLINK,"#");";                        * 19
.
ASSCON99  RETURN
.-----------------------------------------------------------
. NMDS Resubmission
.-----------------------------------------------------------
NMDS0000  BRANCH    FLDITMNO,NMDS0100
          GOTO      NMDS9999
.
NMDS0100  CALL      NRES0000     * NMDS Resubmission required list
          GOTO      NMDS9999
.
NMDS9999  RETURN
+
.-----------------------------------------------------------
. NMDS Resubmission list
.-----------------------------------------------------------
NRES0000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          IF        IBCNMHOS <> 1
            MOVE      "All",FILTHOSP
          ENDIF
.
          MATCH     SP70,FILTHOSP
          IF        !@EQUAL
            PACK      KEY19,FILTHOSP,SP70
          ELSE
            PACK      KEY19,WBSEHOSP,SP70
          ENDIF
.
          MATCH      "All",FILTHOSP
          IF         @EQUAL
            PACK       KEY19,SP70
          ENDIF
.
NRES0500  CALL       RSPMWTR1
NRES1000  CALL       RKPMWTR1
          BRANCH     OVRCD,NRES9999
.
          MATCH      "All",FILTHOSP
          GOTO       NRES1500 IF EQUAL
.
          MATCH      SP70,FILTHOSP
          IF         @EQUAL
            MATCH      WBSEHOSP,PMWTHOSP
            GOTO       NRES9999 IF NOT EQUAL
          ELSE
            MATCH      FILTHOSP,PMWTHOSP
            GOTO       NRES9999 IF NOT EQUAL
          ENDIF
.
NRES1500  PACK       KEY8,PMWTVISN,SP70
          CALL       RDMISS1
          BRANCH     OVRCD,NRES1000
.
          COMPARE    "4",AELIG
          GOTO       NRES2000 IF EQUAL
.
          COMPARE    "5",AELIG
          GOTO       NRES1000 IF NOT EQUAL
.
NRES2000  MOVE       AURNO,URNUMBER
          MOVE       AURNO,KEY8
          CALL       RDMAST1
          CALL       RDPMPX21
          COMPARE    ONE,OVRCD
          GOTO       NRES1000 IF EQUAL
.
          CALL       NROW0000
          GOTO       NRES1000
.
NRES9999  RETURN
+
.-----------------------------------------------------------
. NMDS Row
.-----------------------------------------------------------
NROW0000  MOVE      DAADMNO,ADMISSNO          * ADMISSNO used in GETPAT
.
          UNPACK    PBDATE,CDAY,CMON,CYEAR,CCENT
          CALL      IBACLOCK
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
          CALL      PATNAM00
          CALL      PATLN000    * format Name with System Parameter
.
          MOVE      SP70,DDATE
          MOVE      SP70,DTIME
.
          MOVE      SP70,DOCFNAME
          MOVE      ADOCTA,KEY6
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000
          ENDIF
.
          PACK      KEY6,AWARD,ABED
          PACK      KEY3,AWARD,SP70
          CALL      FWBD0000
          PACK      VISTLOC,WARDBED,SP70
          COMPARE   ONE,IBCNMHOS
          IF        @EQUAL
            PACK      KEY3,PMVXMHOS
            CALL      FHOS0000
            PACK      VISTLOC,HOSPTEXT,DASH,WARDBED,SP70
          ENDIF
.
          LOAD      VSTATUS,ASTAT,INPSTAT1,INPSTAT2,INPSTAT3,INPSTAT4:
                                   INPSTAT5
.
          IF        ASTAT<>3
            GOTO      NROW3000
          ENDIF
.
          PACK      KEY8,DAADMNO,SP70
          CALL      RDDSCH1
          BRANCH    OVRCD,NROW3000
.
          IF        PTCNDRSM=1
            PACK      KEY5,ANSD,SP1,DSTAT,SP70
          ELSE
            PACK      KEY5,ANSD,ANSD,DDEST,SP70
          ENDIF
.
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,KEY8
          ENDIF
.
          PACK      VSTATUS,SP70
          CLEAR     VSTATUS
          APPEND    INPSTA3A,VSTATUS
.
          MATCH     SP10,KEY8
          IF        !@EQUAL
            APPEND    KEY8,VSTATUS
          ENDIF
          APPEND    SP1,VSTATUS
          APPEND    CPCDATE,VSTATUS
          APPEND    SP1,VSTATUS
          APPEND    DTIME,VSTATUS
          APPEND    SP70,VSTATUS
          RESET     VSTATUS
.
NROW3000  REP       " +",URNUMBER
          REP       " +",ADMISSNO
          CLEAR     PATLINK
          APPEND    LINKPRG,PATLINK
          APPEND    ".pbl?reportno=",PATLINK
          APPEND    LINKREP,PATLINK
          APPEND    "&template=",PATLINK
          APPEND    LINKTEM,PATLINK
          APPEND    "&urnumber=",PATLINK
          APPEND    URNUMBER,PATLINK
          APPEND    "&admissno=",PATLINK
          APPEND    ADMISSNO,PATLINK
          RESET     PATLINK
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
          CLEAR     UPDLINK
          APPEND    "javascript:EditNMDS('",UPDLINK
          APPEND    URNUMBER,UPDLINK
          APPEND    "','",UPDLINK
          APPEND    ADMISSNO,UPDLINK
          APPEND    "')",UPDLINK
          RESET     UPDLINK
.
          MOVE      SP70,VIEWLINK
          CLEAR     VIEWLINK
          APPEND    "javascript:viewLink('",VIEWLINK
          APPEND    URNUMBER,VIEWLINK
          APPEND    "','",VIEWLINK
          APPEND    ADMISSNO,VIEWLINK
          APPEND    "')",VIEWLINK
          RESET     VIEWLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",PATLINK,"#",":             *1
                             "#"",FORMATNM,"#",";
.
          CALL      PATFLD00               *Returns KEY3 for folder colour code
.
          PACK      DIM8,DVISIT
          IF        AELIG=5
            PACK      DIM8,DCODING
          ENDIF
.
          WRITE     HTMLFILE;"#"",DAADMNO,"#",":                      *2
                             "#"",AURNO,"#",":                        *3
                             "#"",KEY3,"#",":                         *4
                             "#"IP#",":                               *5
                             "#"",DOCFNAME,"#",":                     *6
                             "#"",AWARD,ABED,"#",":                   *7
                             "#"",ADATE,ATIME,"#",":                  *8
                             "#"",DIM8,"#",":                         *9
                             "#"",UPDLINK,"#",":                      *10
                             "#"",VISTLOC,"#",":                      *11
                             "#"",VSTATUS,"#",":                      *12
                             "#"",VIEWLINK,"#",":                     *13
                             "#"",DDATE,DTIME,"#");"                  *14
.
NROW9999  RETURN
+ 
.------------------------------------------------------------
. Leave register current admission on leave list
.------------------------------------------------------------
LEVL0000  BRANCH    NOLEAVRG,LEVL9999   * exit if pmslrdaf is not created
.
          MOVE      "PTCNOLDR",CPARPARM
          MOVE      IBCNMHOS,CPARMHOS
          MOVE      USERID,CPARUSER
          CALL      GTCMPA00
          IF        CPARERRO=0
            UNPACK    CMPAVALU,KEY12
            MOVE      KEY12,PTCNOLDR
          ENDIF
.
          MOVE      ZERO,ONLCOUNT
          MOVE      ZERO,TOTCOUNT
          PACK      NEWTITLE,TITLE10
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          PACK      KEY9,TWO,SP70    * loop current admissions
          CALL      RDSMISS2
LEVL1000  CALL      RDKMISS2
          BRANCH    OVRCD,LEVL2000
.
          COMPARE   TWO,ASTAT
          GOTO      LEVL2000 IF NOT EQUAL
.
          IF        IBCNMHOS=1
            MATCH     WBSEHOSP,PMVXMHOS
            GOTO      LEVL1000 IF NOT EQUAL
          ENDIF
.
          CALL      LEVR0000
          GOTO      LEVL1000
.
LEVL2000  PACK      KEY9,FOUR,SP70    * loop on leave patients
          CALL      RDSMISS2
LEVL2100  CALL      RDKMISS2
          BRANCH    OVRCD,LEVL9999
.
          COMPARE   FOUR,ASTAT
          GOTO      LEVL9999 IF NOT EQUAL
.
          IF        IBCNMHOS=1
            MATCH     WBSEHOSP,PMVXMHOS
            GOTO      LEVL2100 IF NOT EQUAL
          ENDIF
.
          CALL      LEVR0000
          GOTO      LEVL2100
.
LEVL9999  RETURN
+
.------------------------------------------------------------
. Leave register details admission on leave list
.------------------------------------------------------------
LEVR0000  MATCH     SP70,LEAVWARD
          IF        !@EQUAL
            MATCH     Z70,LEAVWARD
            IF        !@EQUAL
              MATCH     LEAVWARD,AWARD
              GOTO      LEVR9999 IF NOT EQUAL
            ENDIF
          ENDIF
.
          MATCH     SP70,LEAVCARE
          IF        !@EQUAL
            MATCH     LEAVCARE,ACARE
            GOTO      LEVR9999 IF NOT EQUAL
          ENDIF
.
          PACK      KEY5,ANSC,ANSC,ACARE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,LEVR9999
.
          MATCH     SP70,LEAVEREG
          IF        !@EQUAL
            MATCH     LEAVEREG,TCINDC24
            GOTO      LEVR9999 IF NOT EQUAL
          ELSE
            MATCH     SP70,TCINDC24
            GOTO      LEVR9999 IF EQUAL
          ENDIF
.
          PACK      KEY8,DAADMNO,SP70
          CALL      RDPMWOR1
          IF        OVRCD=1
            CALL      CLPMWO00
          ENDIF
.
          MATCH     SP70,LEAVRISK
          IF        !@EQUAL
            MATCH     LEAVRISK,PMWOUDF4
            GOTO      LEVR9999 IF NOT EQUAL
          ENDIF
.
          PACK      KEY27,DAADMNO,Z70
          CALL      RSPMLRD1
LEVR1500  CALL      RPPMLRD1
          BRANCH    OVRCD,LEVR1800
.
          MATCH     PMLRVISN,DAADMNO
          GOTO      LEVR1800 IF NOT EQUAL
.
          MATCH     "1",PMLRACTV
          GOTO      LEVR1500 IF EQUAL
.
          MATCH     "D",PMLRRECS
          GOTO      LEVR1500 IF EQUAL
.
          GOTO      LEVR1900   * valid pmslrdaf in context
.
LEVR1800  CALL      CLPMLD00
.
LEVR1900  MATCH     SP70,LEAVSTAT
          GOTO      LEVR2000 IF EQUAL
.
          MATCH     ANSL,LEAVSTAT
          IF        @EQUAL
            MATCH     "4",DASTAT
            GOTO      LEVR2000 IF EQUAL
            GOTO      LEVR9999
          ENDIF
.
          MATCH     ANSW,LEAVSTAT
          IF        @EQUAL
            MATCH     "2",DASTAT
            GOTO      LEVR2000 IF EQUAL
            GOTO      LEVR9999
          ENDIF
.
          MATCH     LEAVSTAT,PMLRRECS
          GOTO      LEVR9999 IF NOT EQUAL
.
LEVR2000  CALL      LVROW000   * Output the row
          MATCH     "4",DASTAT
          IF        @EQUAL
            ADD       ONE,ONLCOUNT
          ENDIF
          ADD       ONE,TOTCOUNT
.
	  GOTO      LEVR9999
.
LEVR9999  RETURN
+
.------------------------------------------------------------
. Leave register History list
.------------------------------------------------------------
LEVH0000  BRANCH    NOLEAVRG,LEVL9999   * exit if pmslrdaf is not created
.
          MOVE      ZERO,ONLCOUNT
          MOVE      ZERO,TOTCOUNT
          PACK      NEWTITLE,TITLE11
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          PACK      ENDDTE,LASTDATE,SP70
          PACK      KEY28,FRSTDATE,SP70
          CALL      RSPMLRD4
LEVH1000  CALL      RKPMLRD4
          BRANCH    OVRCD,LEVH9999
.
          MATCH     PMLRDATE,ENDDTE
          GOTO      LEVH9999 IF LESS
.
          MATCH     "1",PMLRACTV
          GOTO      LEVH1000 IF EQUAL
.
          MATCH     ANSD,PMLRRECS
          GOTO      LEVH1000 IF EQUAL
.
          MATCH     ANSB,PMLRRECS
          GOTO      LEVH1000 IF EQUAL
.
          MATCH     SP70,LEAVSTAT
          IF        !@EQUAL
            MATCH     LEAVSTAT,PMLRRECS
            GOTO      LEVH1000 IF NOT EQUAL
          ENDIF
.

          PACK      KEY8,PMLRVISN,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,LEVH1000
.
          COMPARE   ONE,IBCNMHOS
          GOTO      LEVH2000 IF NOT EQUAL
.
          MATCH     WBSEHOSP,PMVXMHOS
          IF        !@EQUAL
            GOTO      LEVH1000
          ENDIF
.
LEVH2000  MATCH     SP70,LEAVWARD
          IF        !@EQUAL
            MATCH     Z70,LEAVWARD
            IF        !@EQUAL
              MATCH     LEAVWARD,PMLRWARD
              GOTO      LEVH1000 IF NOT EQUAL
            ENDIF
          ENDIF
.
          MATCH     SP70,LEAVCARE
          IF        !@EQUAL
            MATCH     LEAVCARE,ACARE
            GOTO      LEVH1000 IF NOT EQUAL
          ENDIF
.
          PACK      KEY8,DAADMNO,SP70
          CALL      RDPMWOR1
          IF        OVRCD=1
            CALL      CLPMWO00
          ENDIF
.
          MATCH     SP70,LEAVRISK
          IF        !@EQUAL
            MATCH     LEAVRISK,PMWOUDF4
            GOTO      LEVH1000 IF NOT EQUAL
          ENDIF
.
          CALL      LHROW000   * Output the row
          MATCH     "4",DASTAT
          IF        @EQUAL
            ADD       ONE,ONLCOUNT
          ENDIF
          ADD       ONE,TOTCOUNT
          GOTO      LEVH1000
.
LEVH9999  RETURN
+
.------------------------------------------------------------
. Output leave history  row
.------------------------------------------------------------
LHROW000  MOVE      AURNO,URNUMBER
          MOVE      AADMNO,ADMISSNO
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
          CLEAR     PATLINK
          APPEND    LINKPRG,PATLINK
          APPEND    ".pbl?reportno=",PATLINK
          APPEND    LINKREP,PATLINK
          APPEND    "&template=",PATLINK
          APPEND    LINKTEM,PATLINK
          APPEND    "&urnumber=",PATLINK
          APPEND    URNUMBER,PATLINK
          APPEND    "&admissno=",PATLINK
          APPEND    ADMISSNO,PATLINK
          RESET     PATLINK
.
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
          PACK      KEY8,AURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,LHROW999
.
          CALL      RDPMPX21
          BRANCH    OVRCD,LHROW999
.
          CALL      ADMDAT00
.
          UNPACK    PMLRDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      LEAVTIME,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP1,PMLRTIME,SP70
.
LHROW150  CALL      GETPAT00
          CALL      PATLN000   * Format Patient Name for System Parameter
.
          MOVE      SP70,RETURNDT
          MATCH     ANSR,PMLRRECS
          IF        @EQUAL
            CALL      GETR0000
          ENDIF
          MOVE      SP70,DOCFNAME
          MOVE      ADOCTA,KEY6
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000
          ENDIF
.
          MOVE      SP70,LEAVETYP
          MATCH     SP70,PMLRTLEV
          IF        !@EQUAL
            PACK      KEY5,CATTL,PMLRTLEV,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MOVE      TDESC,LEAVETYP
            ENDIF
          ENDIF
.
          PACK      LEAVEARR,SP70
          PACK      BUTTONCO,SP70
          MOVE      "Risk",BUTTONNA
          MATCH     SP70,PMLRRISK
          IF        !@EQUAL
            PACK      BUTTONNA,PMLRRISK
            PACK      KEY5,LOWVD,PMLRRISK,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              PACK      BUTTONCO,PTCDASC1  * use associated field 1 for colour
            ENDIF
          ENDIF
          MATCH     SP70,PMLRLARR
          IF        !@EQUAL
            PACK      KEY5,LOWVE,PMLRLARR,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              PACK      LEAVEARR,TDESC
            ENDIF
          ENDIF
.
LHROW200  PACK      HTMLLNK3,SP70,SP70,SP70,SP70
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
          CLEAR     HTMLLNK3
          APPEND    "<input type=button class=button ",HTMLLNK3
          APPEND    "value=",HTMLLNK3
          APPEND    BUTTONNA,HTMLLNK3
          MATCH     SP70,BUTTONCO
          IF        !@EQUAL
            APPEND    " style=background-color:##",HTMLLNK3
            APPEND    BUTTONCO,HTMLLNK3
          ENDIF
          APPEND    " onclick=UpdateWorkingDiag('",HTMLLNK3
          APPEND    URNUMBER,HTMLLNK3
          APPEND    "','",HTMLLNK3
          APPEND    ADMISSNO,HTMLLNK3
          APPEND    "')>",HTMLLNK3
          APPEND    "<br>",HTMLLNK3
          APPEND    LEAVEARR,HTMLLNK3
          RESET     HTMLLNK3
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
          PACK      BUTTONNA,SP70
          PACK      BUTTONCO,GREEN,SP70
          MOVE      "Ward",BUTTONNA
.
          MATCH     ANSR,PMLRRECS     * return, on the ward
          GOTO      LHROW250 IF EQUAL
.
          MATCH     ANSA,PMLRRECS
          IF        @EQUAL
            MOVE      "Absconded",BUTTONNA
            PACK      BUTTONCO,RED,SP70
            GOTO      LHROW250
          ENDIF
.
          MOVE      "On Leave",BUTTONNA
          PACK      BUTTONCO,YELLOW,SP70
.
          CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          MATCH     SP70,PMLREXRD
          GOTO      LHROW250 IF EQUAL
.
          MATCH     CURRDATE,PMLREXRD
          IF        @LESS
            PACK      BUTTONCO,ORANGE,SP70
            MOVE      "Late",BUTTONNA
            GOTO      LHROW250
          ENDIF
.
          MATCH     PMLREXRD,CURRDATE
          IF        @LESS
            GOTO      LHROW250
          ENDIF
          CLOCK     TIME,CTIMEIS
          MATCH     CTIMEIS,PMLREXRT
          IF        @LESS
            PACK      BUTTONCO,ORANGE,SP70
            MOVE      "Late     ",BUTTONNA
          ENDIF
.
LHROW250  PACK      HTMLLNK4,SP70,SP70,SP70,SP70
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
          CLEAR     HTMLLNK4
          APPEND    "<input type=button class=button ",HTMLLNK4
          APPEND    "value='",HTMLLNK4
          APPEND    BUTTONNA,HTMLLNK4
          APPEND    "'",HTMLLNK4
          MATCH     SP70,BUTTONCO
          IF        !@EQUAL
            APPEND    " style=background-color:##",HTMLLNK4
            APPEND    BUTTONCO,HTMLLNK4
          ENDIF
          APPEND    " onclick=UpdateLeaveReg('",HTMLLNK4
          APPEND    URNUMBER,HTMLLNK4
          APPEND    "','",HTMLLNK4
          APPEND    ADMISSNO,HTMLLNK4
          APPEND    "','",HTMLLNK4
          APPEND    ASTAT,HTMLLNK4
          APPEND    "')>",HTMLLNK4
          RESET     HTMLLNK4
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
LHROW550  CALL      PATFLD00               *Returns KEY3 for folder colour code
          MOVE      SP70,RETNTIME
          MOVE      ZERO,RETNPAST
          MATCH     "2",DASTAT
          GOTO      LHROW600 IF EQUAL
.
          MATCH     SP70,PMLREXRD
          GOTO      LHROW600 IF EQUAL
.
          CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          MATCH     CURRDATE,PMLREXRD
          IF        @LESS
            MOVE      ONE,RETNPAST
          ENDIF
          MATCH     CURRDATE,PMLREXRD
          IF        !@EQUAL
            UNPACK    PMLREXRD,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD    MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK     RETNTIME,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP1,PMLREXRT,SP70
            PACK      RETNTIME,PMLREXRT
          ELSE
            CLOCK     TIME,CTIMEIS
            MATCH     CTIMEIS,PMLREXRT
            IF        @LESS
              MOVE      ONE,RETNPAST
            ENDIF
          ENDIF
          COMPARE   ONE,RETNPAST
          IF        @EQUAL
            PACK      FIRSTDAT,PMLREXRD
            UNPACK    PMLREXRT,CHOUR,DIM1,CMIN
            PACK      FIRSTIME,CHOUR,CMIN
            PACK      LASTDATE,CURRDATE
            UNPACK    CTIMEIS,CHOUR,DIM1,CMIN
            PACK      LASTTIME,CHOUR,CMIN
            CALL      TIMEDIFF
            COMPARE   CALCTIME,PTCNOLDR
            IF        @LESS
              MOVE      TWO,RETNPAST
            ENDIF
          ENDIF
.
LHROW600  COMPARE   ONE,PRIVACYO
          IF        @EQUAL
            PACK      FORMATNM,SP70,SP70
          ENDIF
          IF        ASTAT=2
            PACK      PMLRDEST,SP70
            PACK      PMLRCARN,SP70
            PACK      PMLRCARC,SP70
          ENDIF
.
          CALL      LVMIN000
          WRITE     HTMLFILE;*+,"t.addRow(#"",PATLINK,"#",":
                             "#"",URNUMBER,"#",":
                             "#"",ADMISSNO,"#",":
                             "#"",KEY3,"#",":
                             "#"",FORMATNM,"#",":
                             "#"",ADATE,"#",":
                             "#"",DISPSEX,"#",":
                             "#"",PMLRWARD,"/",PMLRLBED,"#",":
                             "#"",LEAVETYP,"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",HTMLLNK3,"#",":
                             "#"",LEAVTIME,"#",":
                             "#"",HTMLLNK4,"#",":
                             "#"",PMLRDEST,"#",";
.
          COMPARE   TWO,RETNPAST
          IF        @EQUAL
            WRITE     HTMLFILE;"#"",FONTRED,RETNTIME,"#",":
                               "#"",FONTRED,PMLRCARN,"<br>",PMLRCARC,"#",";
          ELSE
            COMPARE   ONE,RETNPAST
            IF        @EQUAL
              WRITE     HTMLFILE;"#"",FONTORNG,RETNTIME,"#",":
                                 "#"",FONTORNG,PMLRCARN,"<br>",PMLRCARC,"#",";
            ELSE
              WRITE     HTMLFILE;"#"",RETNTIME,"#",":
                              "#"",PMLRCARN,"<br>",PMLRCARC,"#",";
            ENDIF
          ENDIF
.
          MOVE      ONE,TODAYONL
          CALL      CNTLV000 * count leave today
          COMPARE   TWO,RETNPAST
          IF        @EQUAL
            WRITE     HTMLFILE;"#"",FONTRED,COUNTLEV,"#/";
          ELSE
            COMPARE   ONE,RETNPAST
            IF        @EQUAL
              WRITE     HTMLFILE;"#"",FONTORNG,COUNTLEV,"#/";
            ELSE
              WRITE     HTMLFILE;"#"",COUNTLEV,"#/";
            ENDIF
          ENDIF
.
          MOVE      ZERO,TODAYONL
          CALL      CNTLV000 * count total leave
          WRITE     HTMLFILE;COUNTLEV,"#",";
.
          CALL      CNLV0000
          WRITE     HTMLFILE;"#"",CNLVDAYS,"#",";
.
          WRITE     HTMLFILE;"#"",LEAVHHMM;
          CALL      LVDAY000
          WRITE     HTMLFILE;SLASH,LEAVHHMM,"#",";
.
          PROC      CALCLEAV   * calculate leave duration
          ASSIGN    FORM6A/SIXTY,CALCTIME
          MOVE      CALCTIME,FORM6              * Set to Hrs
          MOVE      FORM6,F6                    * save the actual hrs
          ASSIGN    CALCTIME*SIXTY,CALCTIME     * Set hrs back to mins
          ASSIGN    (FORM6A-CALCTIME),FORM6A    * now subtract from sav var
          MOVE      FORM6A,F2                   * Now have remainding mins
          MOVE      F2,D2
          REP       " 0",D2
          PACK      TOTLTIME,F6,COLON,D2
.
          CLEAR     HTMLLNK5
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
          APPEND    "<a href=javascript:",HTMLLNK5
          APPEND    "PatientLeaveReg('",HTMLLNK5
          APPEND    URNUMBER,HTMLLNK5
          APPEND    "','",HTMLLNK5
          APPEND    ADMISSNO,HTMLLNK5
          APPEND    "')>",HTMLLNK5
          APPEND    TOTLTIME,HTMLLNK5
          APPEND    "</a>",HTMLLNK5
          RESET     HTMLLNK5
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
          PACK      KEY20,SP70
          MATCH     ANSL,PMLRRECS
          IF        @EQUAL
            PACK      KEY20,STATL,SP70
          ENDIF
          MATCH     ANSR,PMLRRECS
          IF        @EQUAL
            PACK      KEY20,STATR,SP70
          ENDIF
          MATCH     ANSO,PMLRRECS
          IF        @EQUAL
            PACK      KEY20,STATO,SP70
          ENDIF
          MATCH     ANSA,PMLRRECS
          IF        @EQUAL
            PACK      KEY20,STATA,SP70
          ENDIF
.
          WRITE     HTMLFILE;"#"",HTMLLNK5,"#",":
                             "#"",KEY20,"#",":
                             "#"",RETURNDT,"#");"
.
LHROW999  RETURN
+
.------------------------------------------------------------
. Get return date time          
.------------------------------------------------------------
GETR0000  PACK      KEY30,PMLRVISN,Z70
          CALL      RDSTRAN2
GETR1000  CALL      RDPTRAN2
          BRANCH    OVRCD,GETR9999
.
          MATCH     DTADMN,PMLRVISN
          GOTO      GETR9999 IF NOT EQUAL
.
          MATCH     "R",TMOVE
          GOTO      GETR1000 IF NOT EQUAL
.
          UNPACK    TDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      RETURNDT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP1,TTIME,SP70
.
          CALL      RDPTRAN2
          BRANCH    OVRCD,GETR9000
          MATCH     PMLRDATE,TDATE
          GOTO      GETR1000 IF NOT EQUAL
          MATCH     PMLRTIME,TTIME
          GOTO      GETR1000 IF NOT EQUAL
.
          GOTO      GETR9999
.
GETR9000  MOVE      SP70,RETURNDT
GETR9999  RETURN
+
.------------------------------------------------------------
. Output leave register row     
.------------------------------------------------------------
LVROW000  MOVE      AURNO,URNUMBER
          MOVE      AADMNO,ADMISSNO
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
          CLEAR     PATLINK
          APPEND    LINKPRG,PATLINK
          APPEND    ".pbl?reportno=",PATLINK
          APPEND    LINKREP,PATLINK
          APPEND    "&template=",PATLINK
          APPEND    LINKTEM,PATLINK
          APPEND    "&urnumber=",PATLINK
          APPEND    URNUMBER,PATLINK
          APPEND    "&admissno=",PATLINK
          APPEND    ADMISSNO,PATLINK
          RESET     PATLINK
.
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
          PACK      KEY8,AURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,LVROW999
.
          CALL      RDPMPX21
          BRANCH    OVRCD,LVROW999
.
          CALL      ADMDAT00
.
          MOVE      SP70,LEAVETYP
          MOVE      SP70,LEAVTIME
.
          PACK      KEY30,DAADMNO,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,LVROW150
.    
          MATCH     DTADMN,DAADMNO
          GOTO      LVROW150 IF NOT EQUAL
.
          MATCH     "L",TMOVE
          GOTO      LVROW150 IF NOT EQUAL
.
          CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          MATCH     CURRDATE,TDATE
          IF        !@EQUAL
            UNPACK    TDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      LEAVTIME,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP1,TTIME,SP70
          ELSE
            PACK      LEAVTIME,TTIME
          ENDIF
.
          PACK      KEY5,CATTL,PMLRTLEV,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,LVROW150             * invalid type of leave
.
          MOVE      TDESC,LEAVETYP
.
          MOVE      TCFORM6,SVLVDAYS
.
LVROW150  CALL      GETPAT00
          CALL      PATLN000   * Format Patient Name for System Parameter
.
          MOVE      SP70,DOCFNAME
          MOVE      ADOCTA,KEY6
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE 
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000      
          ENDIF
.
          PACK      LEAVEARR,SP70
          PACK      BUTTONCO,SP70
          MOVE      "Risk",BUTTONNA
          PACK      KEY8,ADMISSNO
          CALL      RDPMWOR1
          BRANCH    OVRCD,LVROW200
          MATCH     SP70,PMWOUDF4
          IF        !@EQUAL
            PACK      BUTTONNA,PMWOUDF4
            PACK      KEY5,LOWVD,PMWOUDF4,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              PACK      BUTTONCO,PTCDASC1  * use associated field 1 for colour
            ENDIF
          ENDIF
          MATCH     SP70,PMWOUDF5
          IF        !@EQUAL
            PACK      KEY5,LOWVE,PMWOUDF5,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              PACK      LEAVEARR,TDESC
            ENDIF
          ENDIF
.
LVROW200  PACK      HTMLLNK3,SP70,SP70,SP70,SP70
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
          CLEAR     HTMLLNK3
          APPEND    "<input type=button class=button ",HTMLLNK3
          APPEND    "value=",HTMLLNK3
          APPEND    BUTTONNA,HTMLLNK3
          MATCH     SP70,BUTTONCO
          IF        !@EQUAL
            APPEND    " style=background-color:##",HTMLLNK3
            APPEND    BUTTONCO,HTMLLNK3
          ENDIF
          APPEND    " onclick=UpdateWorkingDiag('",HTMLLNK3
          APPEND    URNUMBER,HTMLLNK3
          APPEND    "','",HTMLLNK3
          APPEND    ADMISSNO,HTMLLNK3
          APPEND    "')>",HTMLLNK3
          APPEND    "<br>",HTMLLNK3
          APPEND    LEAVEARR,HTMLLNK3
          RESET     HTMLLNK3
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
          PACK      BUTTONNA,SP70
          PACK      BUTTONCO,GREEN,SP70
          MOVE      "Ward",BUTTONNA
.
          MATCH     SP70,LEAVTIME     * not on leave, on the ward
          GOTO      LVROW250 IF EQUAL
.
          MATCH     ANSA,PMLRRECS
          IF        @EQUAL
            MOVE      "Absconded",BUTTONNA
            PACK      BUTTONCO,RED,SP70
            GOTO      LVROW250
          ENDIF
.
          MOVE      "On Leave",BUTTONNA
          PACK      BUTTONCO,YELLOW,SP70
.
          CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          MATCH     SP70,PMLREXRD
          GOTO      LVROW250 IF EQUAL
.
          MATCH     CURRDATE,PMLREXRD
          IF        @LESS
            PACK      BUTTONCO,ORANGE,SP70
            MOVE      "Late",BUTTONNA
            GOTO      LVROW250
          ENDIF
.
          MATCH     PMLREXRD,CURRDATE
          IF        @LESS
            GOTO      LVROW250
          ENDIF
          CLOCK     TIME,CTIMEIS
          MATCH     CTIMEIS,PMLREXRT
          IF        @LESS
            PACK      BUTTONCO,ORANGE,SP70
            MOVE      "Late",BUTTONNA
          ENDIF
.
LVROW250  PACK      HTMLLNK4,SP70,SP70,SP70,SP70
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
          CLEAR     HTMLLNK4
          APPEND    "<input type=button class=button ",HTMLLNK4
          APPEND    "value='",HTMLLNK4
          APPEND    BUTTONNA,HTMLLNK4
          APPEND    "'",HTMLLNK4
          MATCH     SP70,BUTTONCO
          IF        !@EQUAL
            APPEND    " style=background-color:##",HTMLLNK4
            APPEND    BUTTONCO,HTMLLNK4
          ENDIF
          APPEND    " onclick=UpdateLeaveReg('",HTMLLNK4
          APPEND    URNUMBER,HTMLLNK4
          APPEND    "','",HTMLLNK4
          APPEND    ADMISSNO,HTMLLNK4
          APPEND    "','",HTMLLNK4
          APPEND    ASTAT,HTMLLNK4
          APPEND    "')>",HTMLLNK4
          RESET     HTMLLNK4
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
LVROW550  CALL      PATFLD00               *Returns KEY3 for folder colour code
          MOVE      SP70,RETNTIME
          MOVE      ZERO,RETNPAST
          MATCH     "2",DASTAT
          GOTO      LVROW600 IF EQUAL
.
          MATCH     SP70,PMLREXRD
          GOTO      LVROW600 IF EQUAL
.
          CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          MATCH     CURRDATE,PMLREXRD
          IF        @LESS
            MOVE      ONE,RETNPAST
          ENDIF
          MATCH     CURRDATE,PMLREXRD
          IF        !@EQUAL
            UNPACK    PMLREXRD,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD    MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK     RETNTIME,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP1,PMLREXRT,SP70
          ELSE
            PACK      RETNTIME,PMLREXRT
            CLOCK     TIME,CTIMEIS
            MATCH     CTIMEIS,PMLREXRT
            IF        @LESS
              MOVE      ONE,RETNPAST
            ENDIF
          ENDIF
          COMPARE   ONE,RETNPAST
          IF        @EQUAL
            PACK      FIRSTDAT,PMLREXRD
            UNPACK    PMLREXRT,CHOUR,DIM1,CMIN
            PACK      FIRSTIME,CHOUR,CMIN
            PACK      LASTDATE,CURRDATE
            UNPACK    CTIMEIS,CHOUR,DIM1,CMIN
            PACK      LASTTIME,CHOUR,CMIN
            CALL      TIMEDIFF
            COMPARE   CALCTIME,PTCNOLDR
            IF        @LESS
              MOVE      TWO,RETNPAST
            ENDIF
          ENDIF
.
LVROW600  COMPARE   ONE,PRIVACYO
          IF        @EQUAL
            PACK      FORMATNM,SP70,SP70
          ENDIF
          IF        ASTAT=2
            PACK      PMLRDEST,SP70
            PACK      PMLRCARN,SP70
            PACK      PMLRCARC,SP70
          ENDIF
.
          CALL      LVMIN000
          WRITE     HTMLFILE;*+,"t.addRow(#"",PATLINK,"#",":
                             "#"",URNUMBER,"#",":
                             "#"",ADMISSNO,"#",":
                             "#"",KEY3,"#",":
                             "#"",FORMATNM,"#",":
                             "#"",ADATE,"#",":
                             "#"",DISPSEX,"#",":
                             "#"",AWARD,"/",ABED,"#",":
                             "#"",LEAVETYP,"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",HTMLLNK3,"#",":
                             "#"",LEAVTIME,"#",":
                             "#"",HTMLLNK4,"#",":
                             "#"",PMLRDEST,"#",";
.
          COMPARE   TWO,RETNPAST
          IF        @EQUAL
            WRITE     HTMLFILE;"#"",FONTRED,RETNTIME,"#",":
                               "#"",FONTRED,PMLRCARN,"<br>",PMLRCARC,"#",";
          ELSE
            COMPARE   ONE,RETNPAST
            IF        @EQUAL
              WRITE     HTMLFILE;"#"",FONTORNG,RETNTIME,"#",":
                                 "#"",FONTORNG,PMLRCARN,"<br>",PMLRCARC,"#",";
            ELSE
              WRITE     HTMLFILE;"#"",RETNTIME,"#",":
                                "#"",PMLRCARN,"<br>",PMLRCARC,"#",";
            ENDIF
          ENDIF
.
          MOVE      ONE,TODAYONL
          CALL      CNTLV000 * count leave today
          COMPARE   TWO,RETNPAST
          IF        @EQUAL
            WRITE     HTMLFILE;"#"",FONTRED,COUNTLEV,"#/";
          ELSE
            COMPARE   ONE,RETNPAST
            IF        @EQUAL
              WRITE     HTMLFILE;"#"",FONTORNG,COUNTLEV,"#/";
            ELSE
              WRITE     HTMLFILE;"#"",COUNTLEV,"#/";
            ENDIF
          ENDIF
.
          MOVE      ZERO,TODAYONL
          CALL      CNTLV000 * count total leave
          WRITE     HTMLFILE;COUNTLEV,"#",";
.
          CALL      CNLV0000
          WRITE     HTMLFILE;"#"",CNLVDAYS,"#",";
.
          CALL      LVMIN000
          WRITE     HTMLFILE;"#"",LEAVHHMM;
          CALL      LVDAY000
          WRITE     HTMLFILE;SLASH,LEAVHHMM,"#",";
.
          PROC      CALCLEAV   * calculate leave duration
          ASSIGN    FORM6A/SIXTY,CALCTIME
          MOVE      CALCTIME,FORM6              * Set to Hrs
          MOVE      FORM6,F6                    * save the actual hrs
          ASSIGN    CALCTIME*SIXTY,CALCTIME     * Set hrs back to mins
          ASSIGN    (FORM6A-CALCTIME),FORM6A    * now subtract from sav var
          MOVE      FORM6A,F2                   * Now have remainding mins
          MOVE      F2,D2
          REP       " 0",D2
          PACK      TOTLTIME,F6,COLON,D2
.
          CLEAR     HTMLLNK5
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
          APPEND    "<a href=javascript:",HTMLLNK5
          APPEND    "PatientLeaveReg('",HTMLLNK5
          APPEND    URNUMBER,HTMLLNK5
          APPEND    "','",HTMLLNK5
          APPEND    ADMISSNO,HTMLLNK5
          APPEND    "')>",HTMLLNK5
          APPEND    TOTLTIME,HTMLLNK5
          APPEND    "</a>",HTMLLNK5
          RESET     HTMLLNK5
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
          WRITE     HTMLFILE;"#"",HTMLLNK5,"#");"
.
LVROW999  RETURN
+
.------------------------------------------------------------
. count leave             
.------------------------------------------------------------
CNTLV000  MOVE      ZERO,COUNTLEV
          CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          PACK      KEY30,DAADMNO,SP70
          CALL      RDSTRAN2
CNTLV100  CALL      RDKTRAN2
          BRANCH    OVRCD,CNTLV999
.
          MATCH     DTADMN,DAADMNO
          GOTO      CNTLV999 IF NOT EQUAL
.
          MATCH     ANSL,TMOVE
          GOTO      CNTLV100 IF NOT EQUAL
.
          COMPARE   ONE,TODAYONL
          IF        @EQUAL
            MATCH     CURRDATE,TDATE
            GOTO      CNTLV100 IF NOT EQUAL
          ENDIF
          ADD       ONE,COUNTLEV
          GOTO      CNTLV100
.
CNTLV999  RETURN
+
.------------------------------------------------------------
. current leave minutes
.------------------------------------------------------------
LVMIN000  MOVE      ZERO,CURLVMIN  * current leave minutes
          MOVE      ZERO,LEAVHHMM
          CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          CLOCK     TIME,CTIMEIS
.
. find if currently on leave
          PACK      KEY30,DAADMNO,Z70
          CALL      RDSTRAN2
LVMIN100  CALL      RDPTRAN2
          BRANCH    OVRCD,LVMIN999
.
          MATCH     DTADMN,DAADMNO
          GOTO      LVMIN999 IF NOT EQUAL
.
          MATCH     ANSL,TMOVE
          GOTO      LVMIN999 IF NOT EQUAL
.
          PACK      FIRSTDAT,TDATE
          UNPACK    TTIME,CHOUR,DIM1,CMIN
          PACK      FIRSTIME,CHOUR,CMIN
          PACK      LASTDATE,CURRDATE
          UNPACK    CTIMEIS,CHOUR,DIM1,CMIN
          PACK      LASTTIME,CHOUR,CMIN
          CALL      TIMEDIFF
          MOVE      CALCTIME,CURLVMIN
.
LVMIN999  COMPARE   ZERO,CURLVMIN
          IF        !@EQUAL
            ASSIGN    (CURLVMIN/60),IHOUR
            ASSIGN    (CURLVMIN%60),IMIN
            MOVE      IMIN,MIN
            REP       " 0",MIN
            PACK      LEAVHHMM,IHOUR,COLON,MIN
          ENDIF
.
          RETURN

+
.------------------------------------------------------------
. total leave minutes for today only
.------------------------------------------------------------
LVDAY000  MOVE      ZERO,CURLVMIN  * leave minutes
          MOVE      ZERO,CALCTIME
          MOVE      ZERO,LEAVHHMM
          MOVE      ZERO,F1
          CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          CLOCK     TIME,CTIMEIS
.
          PACK      KEY30,DAADMNO,Z70
          CALL      RDSTRAN2
LVDAY100  CALL      RDPTRAN2
          BRANCH    OVRCD,LVDAY999
.
          MATCH     DTADMN,DAADMNO
          GOTO      LVDAY999 IF NOT EQUAL
.
          MATCH     ANSL,TMOVE
          IF        @EQUAL
            MOVE      ONE,F1
            MATCH     CURRDATE,TDATE
            IF        !@EQUAL
              PACK      FIRSTDAT,CURRDATE
              MOVE      "0000",FIRSTIME
            ELSE
              PACK      FIRSTDAT,TDATE
              UNPACK    TTIME,CHOUR,DIM1,CMIN
              PACK      FIRSTIME,CHOUR,CMIN
            ENDIF
            IF        F1=0
              PACK      LASTDATE,CURRDATE
              UNPACK    CTIMEIS,CHOUR,DIM1,CMIN
              PACK      LASTTIME,CHOUR,CMIN
            ENDIF
            CALL      TIMEDIFF
            ADD       CALCTIME,CURLVMIN
          ENDIF
.
          MATCH     ANSR,TMOVE
          IF        @EQUAL
            MATCH     CURRDATE,TDATE
            GOTO      LVDAY999 IF NOT EQUAL
            PACK      LASTDATE,TDATE
            UNPACK    TTIME,CHOUR,DIM1,CMIN
            PACK      LASTTIME,CHOUR,CMIN
          ENDIF
.
          GOTO     LVDAY100
.
LVDAY999  COMPARE   ZERO,CURLVMIN
          IF        !@EQUAL
            ASSIGN    (CURLVMIN/60),IHOUR
            ASSIGN    (CURLVMIN%60),IMIN
            MOVE      IMIN,MIN
            REP       " 0",MIN
            PACK      LEAVHHMM,IHOUR,COLON,MIN
          ENDIF
.
          RETURN
+
.----------------------------------------------------------------------------
. Table of Current Admissions
. Note that there is section CABCFR00 which is a clone version of this
.      section for FHIR. If there is any changes to this section, section
.      CABCFR00 needed to be change accordingly
.----------------------------------------------------------------------------
CABCOD00  IF        FHIRTYPE=1
            CALL      CABCFR00
            GOTO      CABCOD99
          ENDIF
.
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,WORKFLAG,DIM127    * I-54257
.
          MOVE      WORKFLAG,WORKDFLG            * Display working diagnosis
.
          IF        SRCHTYPE<1|SRCHTYPE>33
            GOTO      CABCOD99
          ENDIF
.
          MATCH     TEMPLATE,TWOEONE
          GOTO      CABCOD09 IF NOT EQUAL 
.
          PACK      KEY16,FRSTDATE,SP70
          CALL      RDSMISS3
CABCOD08  CALL      RDKMISS3
          BRANCH    OVRCD,CABCOD90
.
          MATCH     ADATE,LASTDATE
          GOTO      CABCOD90 IF LESS
.
          MATCH     SP70,WARDCODE
          IF        !@EQUAL
            MATCH     WARDCODE,AWARD
            GOTO      CABCOD08 IF NOT EQUAL
          ENDIF
.
          IF        TABLEFMT<>3
            COMPARE   "2",ASTAT
            GOTO      CABCOD08 IF NOT EQUAL
          ELSE
            COMPARE   "2",ASTAT
            GOTO      CABCOD14 IF EQUAL
            COMPARE   "3",ASTAT
            GOTO      CABCOD08 IF NOT EQUAL
          ENDIF
.
          GOTO      CABCOD14
.
CABCOD09  MATCH     "1",MULTADMN
          IF        !@EQUAL
            MATCH     SP70,SRCHCODE          
            GOTO      CABCOD90 IF EQUAL     
          ENDIF
.
          PACK      KEY9,TWO,SP70
          CALL      RDSMISS2
CABCOD10  CALL      RDKMISS2
          BRANCH    OVRCD,CABCOD90
.
          MATCH     "1",MULTADMN
          GOTO      CABCOD12 IF EQUAL
.
          COMPARE   ZERO,PTSTATUS          * fhir - Is there a status filter
          IF        !@EQUAL
            COMPARE   PTSTATUS,ASTAT       * fhir - Is the status selected
            IF        !@EQUAL
              GOTO      CABCOD10
            ENDIF
          ENDIF
.
          IF        TABLEFMT<>3
            COMPARE   "2",ASTAT
            GOTO      CABCOD90 IF NOT EQUAL
          ELSE
            COMPARE   "2",ASTAT
            GOTO      CABCOD14 IF EQUAL
            COMPARE   "3",ASTAT
            GOTO      CABCOD90 IF NOT EQUAL
          ENDIF
.
          GOTO      CABCOD14
.
CABCOD12  COMPARE   "2",ASTAT
          GOTO      CABCOD14 IF EQUAL
          COMPARE   "4",ASTAT
          GOTO      CABCOD14 IF EQUAL
.
          COMPARE   "3",ASTAT
          IF        @EQUAL
           PACK      KEY9,FOUR,SP70
           CALL      RDSMISS2
           GOTO      CABCOD10
          ENDIF
          GOTO      CABCOD90
.
CABCOD14  MATCH      SP70,WARDCODE
          IF         !@EQUAL
            MATCH      WARDCODE,AWARD
            GOTO       CABCOD10 IF NOT EQUAL
          ENDIF
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,CABCOD15
.
          IF        IBCNMHOS<>1
            GOTO      CABCOD15
          ENDIF
.
          MATCH     SP70,FILTHOSP
          IF        !@EQUAL
            MATCH     FILTHOSP,PMVXMHOS
            GOTO      CABCOD10 IF NOT EQUAL
          ELSE
            MATCH     WBSEHOSP,PMVXMHOS
            IF        !@EQUAL
              MATCH     TEMPLATE,TWOEONE
              GOTO      CABCOD08 IF EQUAL
              GOTO      CABCOD10 IF NOT EQUAL
            ENDIF
          ENDIF
.
          MATCH     "1",MULTADMN
          IF        @EQUAL
             CALL     CHKMUL00
             GOTO     CABCOD10
          ENDIF
.
CABCOD15  MOVE      AURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,CABCOD10
.
          CALL      RDPMPX21
          MATCH     "1",MULTADMN
          IF        @EQUAL
            GOTO      CABCOD80
          ENDIF
.
          IF        HEAVIEW=1
            CALL      IBACLOCK
            PACK      KEY8,CCC,CYY,CMM,CDD
            REP       " 0",KEY8
            PACK      KEY16,AADMNO,KEY8
            CALL      RDPMNUT1
             IF        OVRCD=1
               CALL      RPPMNUT1
               IF        OVRCD=1
                 CALL      CLPMSNUT
               ELSE
                 MATCH       PMNUADMN,DAADMNO
                 IF          !@EQUAL
                   CALL         CLPMSNUT
                 ENDIF
               ENDIF
             ENDIF
.
            LOAD      KEY3,SRCHTYPE,PMSTAT,PCONT,PREG,PTYPE,PHIGH1:   *01-05
                                 PHIGH2,PHIGH3,PUSR1,PUSR2,PUSR3:     *06-10
                                 PUSR4,PUSR5,PUSR6,ASRCE,ATYPE:       *11-15
                                 ACLSS,ACARE,ACLSSFT,ACLAIM,PMNUDIET: *16-20
                                 APLOCCR,AUSR1,AUSR2,AUSR3,AUSR4:     *21-25
                                 AUSR5,AUSR6,AUSR7,PTMIUSR8,PTMIUSR9: *16-30
                                 PTMIUSR0,SP3,PREG                    *31-35
          ELSE
            LOAD      KEY3,SRCHTYPE,PMSTAT,PCONT,PREG,PTYPE,PHIGH1:      *01-05
                                    PHIGH2,PHIGH3,PUSR1,PUSR2,PUSR3:     *06-10
                                    PUSR4,PUSR5,PUSR6,ASRCE,ATYPE:       *11-15
                                    ACLSS,ACARE,ACLSSFT,ACLAIM,ADIET:    *16-20
                                    APLOCCR,AUSR1,AUSR2,AUSR3,AUSR4:     *21-25
                                    AUSR5,AUSR6,AUSR7,PTMIUSR8,PTMIUSR9: *16-30
                                    PTMIUSR0,SP3,PREG                    *31-35
          ENDIF
.
          MATCH     TEMPLATE,TWOEONE
          GOTO      CABCOD80 IF EQUAL 
.
          COMPARE   THIRTY3,SRCHTYPE          // By religion
          IF        @EQUAL
            COMPARE   TWO,AVISIT            // Skip if religious visit is no    
            GOTO      CABCOD10 IF EQUAL
          ENDIF
.
          COMPARE   TWENTY,SRCHTYPE
          IF        @EQUAL
            MATCH     "All",SRCHCODE
            GOTO      CABCOD80 IF EQUAL
.
            MATCH     "1",CHECKALL
            GOTO      CABCOD70 IF NOT EQUAL
.
            MATCH     "1",CHALDIET
            GOTO      CABCOD70 IF NOT EQUAL
.
            MATCH     "1",PTCNUTOM
            IF        @EQUAL
.
              CALL      CACM0000
              BRANCH    EXIT,CABCOD10
.
              GOTO      CABCOD80
.
            ELSE
.
              UNPACK    SP70,KEY3A,KEY3B,KEY3C,KEY3D,KEY3E
.
              CALL      CADT0000
.
              MATCH     KEY3A,SRCHCODE
              GOTO      CABCOD80 IF EQUAL
.
              MATCH     KEY3B,SRCHCODE
              GOTO      CABCOD80 IF EQUAL
.
              MATCH     KEY3C,SRCHCODE
              GOTO      CABCOD80 IF EQUAL
.
              MATCH     KEY3D,SRCHCODE
              GOTO      CABCOD80 IF EQUAL
.
              MATCH     KEY3E,SRCHCODE
              GOTO      CABCOD80 IF EQUAL
.
              MATCH     KEY3,SRCHCODE
              GOTO      CABCOD10 IF NOT EQUAL
.
              GOTO      CABCOD80
.
            ENDIF
.
          ENDIF
.
CABCOD70  MATCH     KEY3,SRCHCODE
          GOTO      CABCOD10 IF NOT EQUAL
.
CABCOD80  IF        ASTAT=1
            MOVE     "planned",ENSTATUS
          ENDIF
. 
          IF        ASTAT=2
            MOVE     "arrived",ENSTATUS
          ENDIF 
.
          IF        ASTAT=3
            MOVE     "finished",ENSTATUS
          ENDIF
.            
          IF        ASTAT=4
            MOVE     "onleave",ENSTATUS
          ENDIF
.
          IF        ASTAT=5
            MOVE     "cancelled",ENSTATUS
          ENDIF
.
          PERFORM   TABLEFMT,CAROWA00,CAROWB00,CAROWB00
          BRANCH    EXIT,CABCOD99
.
          MATCH     TEMPLATE,TWOEONE
          GOTO      CABCOD08 IF EQUAL
.
          GOTO      CABCOD10
.
CABCOD90 
.
CABCOD99  RETURN
+
.----------------------------------------------------------------------------
. Table of Current Admissions - FHIR
. This is a clone section from CABCOD00 for FHIR. If there is any changes
. from CABCOD00 section, this section needed to be change accordingly
.----------------------------------------------------------------------------
CABCFR00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,WORKFLAG,DIM127
.
          MOVE      WORKFLAG,WORKDFLG            * Display working diagnosis
.
          PACK      KEY9,ONE,SP70
          CALL      RDSMISS2
CABCFR10  CALL      RDKMISS2
          BRANCH    OVRCD,CABCFR90
.
          MATCH     SP70,FRSTDATE         * check frstdate/lastdate
          GOTO      CABCFR11 IF EQUAL
          GOTO      CABCFR11 IF EOS
          MATCH     FRSTDATE,ADATE
          GOTO      CABCFR10 IF LESS
          MATCH     ADATE,LASTDATE
          GOTO      CABCFR10 IF LESS
.
CABCFR11  COMPARE   ZERO,PTSTATUS          * fhir - Is there a status filter
          IF        !@EQUAL
            COMPARE   PTSTATUS,ASTAT       * fhir - Is the status selected
            IF        !@EQUAL
              GOTO      CABCFR10
            ENDIF
          ENDIF
.
          COMPARE   "3",ASTAT
          IF        @EQUAL
            PACK      KEY9,FOUR,SP70
            CALL      RDSMISS2
            GOTO      CABCFR10
          ENDIF
.
          COMPARE   "1",ASTAT
          GOTO      CABCFR14 IF EQUAL
          COMPARE   "2",ASTAT
          GOTO      CABCFR14 IF EQUAL
          COMPARE   "4",ASTAT
          GOTO      CABCFR14 IF EQUAL
.
          GOTO      CABCFR90
.
CABCFR14  MATCH     SP70,WARDCODE
          IF        !@EQUAL
            COMPARE   "1",ASTAT
            IF        !@EQUAL
              MATCH     WARDCODE,AWARD
              GOTO      CABCFR10 IF NOT EQUAL
            ELSE
              MATCH     WARDCODE,PTMIXWRD
              GOTO      CABCFR10 IF NOT EQUAL
            ENDIF
          ENDIF
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,CABCFR15
.
          IF        IBCNMHOS<>1
            GOTO      CABCFR15
          ENDIF
.
          MATCH     SP70,FILTHOSP
          IF        !@EQUAL
            MATCH     FILTHOSP,PMVXMHOS
            GOTO      CABCFR10 IF NOT EQUAL
          ELSE
            MATCH     WBSEHOSP,PMVXMHOS
            IF        !@EQUAL
              GOTO      CABCFR10 IF NOT EQUAL
            ENDIF
          ENDIF
.
CABCFR15  MOVE      AURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,CABCFR10
.
          CALL      RDPMPX21
.
          LOAD      KEY3,SRCHTYPE,PMSTAT,PCONT,PREG,PTYPE,PHIGH1:         *01-05
                                  PHIGH2,PHIGH3,PUSR1,PUSR2,PUSR3:        *06-10
                                  PUSR4,PUSR5,PUSR6,ASRCE,ATYPE:          *11-15
                                  ACLSS,ACARE,ACLSSFT,ACLAIM,ADIET:       *16-20
                                  APLOCCR,AUSR1,AUSR2,AUSR3,AUSR4:        *21-25
                                  AUSR5,AUSR6,AUSR7,PTMIUSR8,PTMIUSR9:    *16-30
                                  PTMIUSR0,SP3,PREG                       *31-35
.
CABCFR70  MATCH     KEY3,SRCHCODE
          GOTO      CABCFR10 IF NOT EQUAL
.
CABCFR80  IF        ASTAT=1
            MOVE      "planned",ENSTATUS
          ENDIF
.
          IF        ASTAT=2
            MOVE      "arrived",ENSTATUS
          ENDIF
.
          IF        ASTAT=3
            MOVE      "finished",ENSTATUS
          ENDIF
.
          IF        ASTAT=4
            MOVE      "onleave",ENSTATUS
          ENDIF
.
          IF        ASTAT=5
            MOVE      "cancelled",ENSTATUS
          ENDIF
.
          CALL      FHRENC00
.
          GOTO      CABCFR10
.
CABCFR90
.
CABCFR99  RETURN
.
.----------------------------------------------------------------------------
. CAROWA00 
.----------------------------------------------------------------------------
CAROWA00  CALL      ADMDAT00
          MOVE      AURNO,URNUMBER
          MOVE      AADMNO,ADMISSNO
.
          MOVE      SP70,ONLVDATE
          MOVE      SP70,ONLVTYPE
          MOVE      SP70,ONLVRETR
          MOVE      ZERO,CNLVDAYS
.
          MATCH     "4",DASTAT
          GOTO      CAROWA10 IF NOT EQUAL
.
          PACK      KEY30,DAADMNO,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,CAROWA10
.
          MATCH     DTADMN,DAADMNO
          GOTO      CAROWA10 IF NOT EQUAL
.
          MATCH     ANSL,TMOVE
          GOTO      CAROWA10 IF NOT EQUAL
.
          PACK      ONLVDATE,TDATE,SP70
          MATCH     SP70,PTTRLTYP
          IF        !@EQUAL
             PACK      KEY5,ANST,ANSL,PTTRLTYP
             CALL      RDCODE1
             IF        OVRCD<>1
               MOVE      TDESC,ONLVTYPE
             ENDIF
          ENDIF
          CALL      CNLV0000
.
          PACK      KEY14,DAADMNO,SP70
          CALL      RDSONLV2
          CALL      RDKONLV2
          BRANCH    OVRCD,CAROWA10
.
          MATCH     DOADMNO,DAADMNO
          GOTO      CAROWA10 IF NOT EQUAL
.
          MOVE      OERDATE,ONLVRETR
.---------V9.00.B01----------------------------------------------------        
.
CAROWA10  MOVE      SP70,OPDATE
          MOVE      SP70,CFSIGND
          MOVE      SP70,CARETYPE
          MATCH     SP70,ACARE
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSC,ACARE,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              PACK      CARETYPE,TDESC,SP70
            ENDIF
          ENDIF
.          
.         IF        SRCHTYPE=15
.           MOVE      SP70,BKRXODTE
.           MOVE      SP70,OPDATE
.           PACK      KEY8,ADMISSNO,SP70
.           CALL      RDBKRX11
.           BRANCH    OVRCD,CAROWA99
.           MOVE      BKRXODTE,OPDATE
.         ELSE
            IF        SRCHTYPE=19 
              PACK      KEY8,AADMNO,SP70
              MOVE      SP70,CFSIGND
              CALL      RDPMVX11
              BRANCH    OVRCD,CAROWA99
              MATCH     "0",PMVXCFSG
              IF        @EQUAL
                MOVE      "No",CFSIGND
              ENDIF
              MATCH     "1",PMVXCFSG
              IF        @EQUAL
                MOVE      "YES",CFSIGND
              ENDIF
            ENDIF
.         ENDIF 
.
.---------V9.00.B01----------------------------------------------------        
.
          CALL      GETPAT00  
.
          CALL      PATLN000   * Format Patient Name for System Parameter
.
          MOVE      SP70,WARDTEXT
          MOVE      SP70,BEDTEXT
          MOVE      SP70,SAVWEXTN
. 
          MATCH     SP70,AWARD
          IF        @EQUAL
            PACK      KEY14,AADMNO,SP70
            CALL      RDSWARD4
            CALL      RDKWARD4
            PACK      KEY6,WWARD,WBED 
          ELSE
            PACK      KEY6,AWARD,ABED
          ENDIF
          CALL      FWBD0000               * format ward/bed text 
.
          MOVE      SP70,DOCFNAME
          MOVE      ADOCTA,KEY6
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE       * I CAR 13038
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000             * end I CAR 13038
          ENDIF
.
          MOVE      SP70,LPCONDD
          MOVE      SP70,CONDESC
          MOVE      ZERO,TCINDC1
          PACK      KEY88,PTMASNAM,PMPXFNAM,AADMNO
          CALL      RDLOCA1
          CALL      GETCON00
.
          MOVE      SP70,PMNUCOM1 
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          PACK      KEY16,AADMNO,KEY8
          CALL      RDPMNUT1
.
          MATCH     SP70,PMWOEDAT                                      *I-23312
          IF        !@EQUAL
            UNPACK    PMWOEDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      EXPDDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
            PACK      EXDDTE,CCENT,CYEAR,CMON,CDAY
            GOTO      CAROWA50
          ENDIF
.                                                                  *end I-23312
          MOVE      SP70,EXPDDATE
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      ASTAY,ADJDAYS
          CALL      ADJDAT00
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          PACK      EXPDDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          PACK      EXDDTE,CCENT,CYEAR,CMON,CDAY                   
.
.
CAROWA50  MOVE      SP70,ADMDDATE
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          PACK      ADMDDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          CALL      GETACC00                * Accident number & date
.
          MOVE      SP70,KEY8               * I SRF 22686
          PACK      KEY8,AADMNO,SP70        * read visit ext file
          MOVE      SP70,PMVXUDF4           * initialize diet comment field
          CALL      RDPMVX11                * end I SRF 22686
          PACK      HOSPDESC,SP70
          PACK      KEY3,PMVXMHOS,SP70
          CALL      RDPTHSP1
          IF        OVRCD<>1
            PACK      HOSPDESC,PTHSNAME,SP70
          ENDIF
.
          MOVE      SP70,VHCODNAM
.
          PACK      KEY11,ADMISSNO,SRCHCODE
          CALL      RDPMEXT1
          BRANCH    OVRCD,CAROWA60
.
          MATCH     SP3,PMEXCAT2
          GOTO      CAROWA60 IF EQUAL
.
          PACK      KEY5,CODEVH,PMEXCAT2
          CALL      RDCODE1
          MOVE      TDESC,VHCODNAM
.
CAROWA60  REP       " +",URNUMBER
          REP       " +",ADMISSNO
          CLEAR     PATLINK
          APPEND    LINKPRG,PATLINK
          APPEND    ".pbl?reportno=",PATLINK
          APPEND    LINKREP,PATLINK
          APPEND    "&template=",PATLINK
          APPEND    LINKTEM,PATLINK
          APPEND    "&urnumber=",PATLINK
          APPEND    URNUMBER,PATLINK
          APPEND    "&admissno=",PATLINK
          APPEND    ADMISSNO,PATLINK
          RESET     PATLINK
.
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
          WRITE     HTMLFILE;*+,"t.addRow(#"",PATLINK,"#",":
                             "#"",URNUMBER,"#",":
                             "#"",ADMISSNO,"#",":
                             "#"",FORMATNM,"#",":
                             "#"",SAVWEXTN,"#",":
                             *+,"#"",WARDTEXT,"/",BEDTEXT,"#",":
                             "#"",ADATE,"#",":
                             "#"",DISPSEX,"#",":
                             "#"";
          CALL      WRTAGE00
          CALL      PATFLD00               *Returns KEY3 for folder colour code
.
          REP       "#" ",ADIAG1
          REP       "#" ",ADIAG2
          IF        WORKDFLG=1
          WRITE     HTMLFILE;"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",CONDESC,SP1,WORKDESC,"#",":
                             "#"",ADIAG1,ADIAG2,"#",":
                             "#"",PTMXSIN1,PTMXSIN2,PTMXSIN3,"#",":
                             "#"",ACOMM1,ACOMM2,"#",":
.                                                     * HPSB01I
                             "#"",OPDATE,"#",":
                             "#"",CFSIGND,"#",":
                             "#"",EXPDDATE,"#",":
                             "#"",ADMDDATE,"<br>",EXPDDATE,"#",":
                             "#"",CONDESC,SP1,WORKDESC,"<br>":
                                  ADIET,"&nbsp;",PMNUCOM1,"#",":
                             "#"",EXDDTE,"#",":
                             "#"",PCEASE,PCASE:
                                  PTMXSIN1,PTMXSIN2,PTMXSIN3,PTMXSIN4:
                                  PTMXSIN5,"#",":
                             "#"",ADIAG1,"<br>",ADIAG2,"#",":
                             "#"",ACCIDTNO,"#",":
                             "#"",ACCIDTDT,"#",":
                             "#"",CONDESC,SP1,WORKDESC,"<br>":
                                  PMVXUDF4,"#",":
                             "#"",KEY3,"#",":
                             "#"",HOSPDESC,"#",":
                             "#"",ONLVDATE,"#",":
                             "#"",ONLVTYPE,"#",":
                             "#"",ONLVRETR,"#",":
                             "#"",CARETYPE,"#",":
                             "#"",CNLVDAYS,"#",":
                             "#"",AFUNDH,"/",AFNDTB,"#",":
                             "#"",CONDESC,SP1,WORKDES2,"#");"
             GOTO   CAROWA90
          ENDIF
.
              
          WRITE     HTMLFILE;"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",CONDESC,SP1,LPCONDD,"#",":                    
                             "#"",ADIAG1,ADIAG2,"#",":
                             "#"",PTMXSIN1,PTMXSIN2,PTMXSIN3,"#",":
                             "#"",ACOMM1,ACOMM2,"#",":
.                                                     * HPSB01I
                             "#"",OPDATE,"#",":             
                             "#"",CFSIGND,"#",":
                             "#"",EXPDDATE,"#",":
                             "#"",ADMDDATE,"<br>",EXPDDATE,"#",":
                             "#"",CONDESC,SP1,LPCONDD,"<br>":       
                                  ADIET,"&nbsp;",PMNUCOM1,"#",": 
                             "#"",EXDDTE,"#",":
                             "#"",PCEASE,PCASE:
                                  PTMXSIN1,PTMXSIN2,PTMXSIN3,PTMXSIN4:
                                  PTMXSIN5,"#",": 
                             "#"",ADIAG1,"<br>",ADIAG2,"#",":   
                             "#"",ACCIDTNO,"#",":
                             "#"",ACCIDTDT,"#",":
                             "#"",CONDESC,SP1,LPCONDD,"<br>":
                                  PMVXUDF4,"#",":
                             "#"",KEY3,"#",":
                             "#"",HOSPDESC,"#",":
                             "#"",ONLVDATE,"#",":
                             "#"",ONLVTYPE,"#",":
                             "#"",ONLVRETR,"#",":
                             "#"",CARETYPE,"#",":
                             "#"",CNLVDAYS,"#",":
                             "#"",AFUNDH,"/",AFNDTB,"#",":
                             "#"",VHCODNAM,"#");"
.
CAROWA90  MOVE     ZERO,EXIT
.
CAROWA99  RETURN
.
.---------------------------------------------------------------------
.      Check if this admission is currently admitted at another hospital  
.---------------------------------------------------------------------      
CHKMUL00  MOVE      ZERO,EXIT
          PACK      DIM8,AURNO,SP70
          PACK      DIM3,PMVXMHOS,SP70
          PACK      SAVKEY9,ASTAT,DAADMNO,SP70
          MOVE      "2",DIM1
          PACK      KEY17,AURNO,TWO,SP70
          CALL      RSPTMI18
CHKMUL10  CALL      RKPTMI18
          BRANCH    OVRCD,CHKMUL90
.
          MATCH     AURNO,DIM8
          GOTO      CHKMUL90 IF NOT EQUAL
.
          MATCH     DIM1,DASTAT
          GOTO      CHKMUL90 IF NOT EQUAL
.
          MATCH     PMVXMHOS,DIM3
          GOTO      CHKMUL10 IF EQUAL
.
          MOVE      AURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,CHKMUL90
          CALL      RDPMPX21
          CALL      CAROWA00
.
          GOTO      CHKMUL99
.
CHKMUL90  MOVE      ONE,EXIT
          MATCH     "2",DIM1
          IF        @EQUAL
            MOVE      "4",DIM1
            PACK      KEY17,AURNO,FOUR,SP70
            CALL      RSPTMI18
            GOTO      CHKMUL10
          ENDIF
           
.
CHKMUL99  PACK      KEY9,SAVKEY9,SP70
          CALL      RDMISS2
          RETURN
+
.---------------------------------------------------------------------
.      Provisional Diagnosis Table Row Output Routine  Called by CABCOD00 
.---------------------------------------------------------------------      
.
CAROWB00  CALL      ADMDAT00
          MOVE      AURNO,URNUMBER
          MOVE      AADMNO,ADMISSNO
.
.---------V9.00.B01----------------------------------------------------        
.
          MOVE      SP70,OPDATE
          MOVE      SP70,CFSIGND
.          
          IF        SRCHTYPE=15
            MOVE      SP70,BKRXODTE
            MOVE      SP70,OPDATE
            PACK      KEY8,ADMISSNO,SP70
            CALL      RDBKRX11
            BRANCH    OVRCD,CAROWB99
            MOVE      BKRXODTE,OPDATE
          ELSE
            IF        SRCHTYPE=19 
              PACK      KEY8,AADMNO,SP70
              MOVE      SP70,CFSIGND
              CALL      RDPMVX11
              BRANCH    OVRCD,CAROWB99
              MATCH     "0",PMVXCFSG
              IF        @EQUAL
                MOVE      "No",CFSIGND
              ENDIF
              MATCH     "0",PMVXCFSG
              IF        @EQUAL
                MOVE      "No",CFSIGND
              ENDIF
            ENDIF
          ENDIF 
.
.---------V9.00.B01----------------------------------------------------        
.
          CALL      GETPAT00  
.
          CALL      PATLN000   * Format Patient Name for System Parameter
.
          MATCH     SP70,AWARD
          IF        @EQUAL
            PACK      KEY14,AADMNO,SP70
            CALL      RDSWARD4
            CALL      RDKWARD4
          ELSE
            MOVE      SP70,WEXTN
            PACK      KEY6,AWARD,ABED,SP70
            CALL      RDWARD1
          ENDIF
.
          MOVE      SP70,DOCFNAME
          MOVE      ADOCTA,KEY6
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE       * I CAR 13038
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000             * end I CAR 13038
          ENDIF
.
          MOVE      SP70,LPCONDD
          MOVE      SP70,CONDESC
          MOVE      ZERO,TCINDC1
          PACK      KEY88,PTMASNAM,PMPXFNAM,AADMNO
          CALL      RDLOCA1
          CALL      GETCON00
.
          PACK      KEY8,ADMISSNO,SP70     * Read Visit Extension File
          CALL      RDPMVX11              
          BRANCH    OVRCD,CAROWB99
.
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
          CLEAR     PATLINK
	  APPEND    LINKPRG,PATLINK
          APPEND    ".pbl?reportno=",PATLINK
          APPEND    LINKREP,PATLINK
          APPEND    "&template=",PATLINK
          APPEND    LINKTEM,PATLINK
          APPEND    "&urnumber=",PATLINK
          APPEND    URNUMBER,PATLINK
          APPEND    "&admissno=",PATLINK
          APPEND    ADMISSNO,PATLINK
          RESET     PATLINK
.
          CLEAR     UPDLINK
          APPEND    "javascript:UpdateDrg('",UPDLINK 
          APPEND    URNUMBER,UPDLINK
          APPEND    "','",UPDLINK
          APPEND    ADMISSNO,UPDLINK
          APPEND    "')",UPDLINK
          RESET     UPDLINK
.
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
          REP       "#" ",ADIAG1
          REP       "#" ",ADIAG2
          WRITE     HTMLFILE;"t.addRow(#"",PATLINK,"#",":
                             "#"",URNUMBER,"#",":
                             "#"",ADMISSNO,"#",":
                             "#"",FORMATNM,"#",":
                             "#"",ADATE,"#",":
                             "#"",ADIAG1,ADIAG2,"#",":
                             "#"",PMVXPICD,"#",":
                             "#"",UPDLINK,"#");"
.
CAROWB99  RETURN
.---------------------------------------------------------------------
.
CABSEL00  LOAD      CATEGORY,SRCHTYPE,CATM,CATC,CATR,CATT,CATH1:     *01-05
                                      CATH2,CATH3,CATP1,CATP2,CATP3: *06-10
                                      CATP4,CATP5,CATP6,CATS,CATA:   *11-15
                                      CATP,CATCC,CATAC,CATCL,CATDC:  *16-20
                                      CATPO,CATU1,CATU2,CATU3,CATU4: *21-25
                                      CATU5,CATU6,CATU7,CATU8,CATU9: *16-30
                                      CATV0,CATV1,CATR               *31-35
          MOVE      SRCHCODE,CODE
          CALL      CODITM00
          RETURN
.
.------------------------------------------------------------
. Retrieve Accident number and date
.------------------------------------------------------------
GETACC00  MOVE      SP70,ACCIDTNO
          MOVE      SP70,ACCIDTDT

          PACK      KEY5,CODECL,SRCHCODE
          CALL      RDCODE1
          BRANCH    OVRCD,GETACC90
.
          MATCH     TCINDC3,CODEA
          GOTO      GETACC90 IF OVER
.
          PACK      KEY23,AADMNO,AURNO,SP70
          CALL      RSECLNK3
GETACC10  CALL      RKECLNK3
          BRANCH    OVRCD,GETACC90
.
          MATCH     AADMNO,ECLNVISI
          GOTO      GETACC90 IF NOT EQUAL
.
          PACK      KEY13,ECLNURNO,ECLNEPNO
          CALL      RDECREF1
          BRANCH    OVRCD,GETACC90
.
          MOVE      ECRFACCN,KEY20
          CALL      RDECACC1
          BRANCH    OVRCD,GETACC90
          MOVE      ECACACCN,ACCIDTNO
          MOVE      ECACDACC,ACCIDTDT
.
GETACC90
.
GETACC99  RETURN
+
.------------------------------------------------------------
. Table of Current Admissions with Mechanical Ventilation
.------------------------------------------------------------
CMVENT00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          PACK      KEY9,TWO,SP70
          CALL      RDSMISS2
CMVENT10  CALL      RDKMISS2
          BRANCH    OVRCD,CMVENT99
.
          COMPARE   "2",ASTAT
          GOTO      CMVENT99 IF NOT EQUAL
.
          MOVE      ZERO,FORM1                  * reset MV record found flag
          MOVE      TWO,ICONFLAG                * default to Black MV
.
          PACK      KEY27,DAADMNO,SP70          * check if there is MV record
          CALL      RSPTVEN1
CMVENT12  CALL      RKPTVEN1
          BRANCH    OVRCD,CMVENT30
.
          MATCH     PTVEVISN,DAADMNO
          GOTO      CMVENT30 IF NOT EQUAL       * No MV record
.
          MOVE      ONE,FORM1                   * set found flag
.
          MOVE      PTVEVISN,VENTVISN
          MOVE      PTVEVTYP,VENTVTYP
          MOVE      PTVESDAT,VENTSDAT
          MOVE      PTVESTIM,VENTSTIM
          MOVE      PTVEEDAT,VENTEDAT
          MOVE      PTVEETIM,VENTETIM
          MOVE      PTVEHOUR,VENTHOUR
          MOVE      PTVEICUS,VENTICUS
          MOVE      PTVEISIT,VENTISIT
.
          MATCH     SP70,PTVEEDAT               * End Date?
          GOTO      CMVENT20 IF EQUAL           * no; set Red icon
.
          MATCH     SP70,PTVEETIM               * End Time?
          GOTO      CMVENT12 IF NOT EQUAL       * yes; check other records
.
CMVENT20  MOVE      ONE,ICONFLAG                * Red
          GOTO      CMVENT40
.
CMVENT30  COMPARE   ZERO,FORM1
          GOTO      CMVENT10 IF EQUAL           * No MV record
.
CMVENT40  PACK      KEY8,AADMNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,CMVENT10
.
          CALL      ADMDAT00
          MOVE      AURNO,URNUMBER
          MOVE      AADMNO,ADMISSNO
.
          CALL      GETPAT00
          CALL      PATLN000   * Format Patient Name for System Parameter
.
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
          CLEAR     PATLINK
          APPEND    LINKPRG,PATLINK
          APPEND    ".pbl?reportno=",PATLINK
          APPEND    LINKREP,PATLINK
          APPEND    "&template=",PATLINK
          APPEND    LINKTEM,PATLINK
          APPEND    "&urnumber=",PATLINK
          APPEND    URNUMBER,PATLINK
          APPEND    "&admissno=",PATLINK
          APPEND    ADMISSNO,PATLINK
          RESET     PATLINK
.
          PACK      KEY6,AWARD,ABED
          CALL      FWBD0000
.
          REP       " +",VENTVTYP
          REP       " +",VENTSDAT
          REP       " +",VENTSTIM
          CLEAR     DIM200C
          IF        ICONFLAG=1
            APPEND    "<a href=javascript:onclick=gotoMVRed('",DIM200C
          ELSE
            APPEND    "<a href=javascript:onclick=gotoMV('",DIM200C
          ENDIF
          APPEND    URNUMBER,DIM200C
          APPEND    "','",DIM200C
          APPEND    ADMISSNO,DIM200C
          APPEND    "','",DIM200C
          APPEND    VENTVTYP,DIM200C
          APPEND    "','",DIM200C
          APPEND    VENTSDAT,DIM200C
          APPEND    "','",DIM200C
          APPEND    VENTSTIM,DIM200C
          APPEND    "')>",DIM200C
.
          APPEND    "<img src=../images/mv_",DIM200C
          APPEND    ICONFLAG,DIM200C
          APPEND    ".png>",DIM200C
          APPEND    "</a>",DIM200C
          RESET     DIM200C
.
          REP       "+ ",VENTVTYP
          REP       "+ ",VENTSDAT
          REP       "+ ",VENTSTIM
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
          CALL      PATFLD00               *Returns KEY3 for folder colour code
.
          WRITE     HTMLFILE;*+,"t.addRow(#"",PATLINK,"#",":
                             "#"",URNUMBER,"#",":                      *1
                             "#"",ADMISSNO,"#",":                      *2
                             "#"",FORMATNM,"#",":                      *3
                             *+,"#"",WARDTEXT,"/",BEDTEXT,"#",":       *4
                             "#"",ADATE,"#",":                         *5
                             "#"",DIM200C,"#",":                       *6
                             "#"",KEY3,"#",";                          *7
.
          MOVE      SP70,TDESC
          MATCH     SP70,VENTVTYP
          IF        !@EQUAL
            MOVE      "VE",KEY2
            PACK      KEY5,KEY2,VENTVTYP
            CALL      RDCODE1
          ENDIF
          WRITE     HTMLFILE;"#"",TDESC,"#",";                   *8
.
          MOVE      SP70,TDESC
          MATCH     SP70,VENTISIT
          IF        !@EQUAL
            MOVE      "II",KEY2
            PACK      KEY5,KEY2,VENTISIT
            CALL      RDCODE1
          ENDIF
          WRITE     HTMLFILE;"#"",TDESC,"#",";                   *9
.
          MOVE      SP70,TDESC
          MATCH     SP70,VENTICUS
          IF        !@EQUAL
            MOVE      "IU",KEY2
            PACK      KEY5,KEY2,VENTICUS
            CALL      RDCODE1
          ENDIF
          WRITE     HTMLFILE;"#"",TDESC,"#",";                   *10
.
          WRITE     HTMLFILE;"#"javascript:LinkPatient('",PATLINK,"') #",": *11
                             "#"",VENTSDAT,VENTSTIM,"#",":       *12
                             "#"",VENTEDAT,VENTETIM,"#");"       *13
.
          GOTO       CMVENT10
.
CMVENT99  RETURN
+
.------------------------------------------------------------------------------
.         Create temp file and populate it with Ventilation Details;
.           Index: Visit Number, Date/Time, Type
.------------------------------------------------------------------------------
CRVTMP00  CALL      KILTMP00                * Delete existing temp file
.
          CLEAR     CMDLINE
          PACK      CMDLINE,ISBUILD,VENTMPFN,VENINDC1
          EXECUTE   CMDLINE,RETURNCD        * Create temporary index file
.
          OPEN      VTMPIND1,VENTMPFN       * Open first index
.
CRVTMP99  RETURN
+
.------------------------------------------------------------------------------
. Populate the temp file with the visits ventilation details
.------------------------------------------------------------------------------
LDVTMP00  PACK      KEY27,DAADMNO,SP70
          CALL      RSPTVEN1
LDVTMP10  CALL      RKPTVEN1
          BRANCH    OVRCD,LDVTMP99
.
          MATCH     PTVEVISN,DAADMNO
          GOTO      LDVTMP99 IF NOT EQUAL
.
          PACK      VTMPVISN,PTVEVISN,SP70
          PACK      VTMPSDAT,PTVESDAT,SP70
          PACK      VTMPSTIM,PTVESTIM,SP70
          PACK      VTMPVTYP,PTVEVTYP,SP70
          PACK      VTMPEDAT,PTVEEDAT,SP70
          PACK      VTMPETIM,PTVEETIM,SP70
          MOVE      PTVEHOUR,VTMPHOUR
          PACK      VTMPICUS,PTVEICUS,SP70
          PACK      VTMPISIT,PTVEISIT,SP70
.
          PACK      KEY24,VTMPVISN,VTMPSDAT,VTMPSTIM,SP70
          CALL      RAVTEMP1
          IF        OVRCD=1
            CALL      WRVTEMP1
          ENDIF
          GOTO      LDVTMP10
.
LDVTMP99  RETURN
+
.------------------------------------------------------------------------------
.         Delete temp file
.------------------------------------------------------------------------------
KILTMP00  CLOSE     VTMPIND1
          CLEAR     CMDLINE
          PACK      CMDLINE,ISERASE,VENTMPFN
          EXECUTE   CMDLINE,RETURNCD             * Remove the file with ierase
.
KILTMP99  RETURN
+
.------------------------------------------------------------------------------
.         IO Routines for temp file
.------------------------------------------------------------------------------
RAVTEMP1  RESET     KEY24
          MOVE      ZERO,OVRCD
          READ      VTMPIND1,KEY24;ANS
          GOTO      OVERCOND IF OVER
          RETURN
.
RSVTEMP1  RESET     KEY24
          READ      VTMPIND1,KEY24;;
          RETURN
.
RKVTEMP1  MOVE      ZERO,OVRCD
          READKS    VTMPIND1;VTMPVISN,VTMPSDAT,VTMPSTIM,VTMPVTYP,VTMPEDAT:
                        VTMPETIM,VTMPHOUR,VTMPICUS,VTMPISIT
          GOTO      OVERCOND IF OVER
          RETURN
.
RPVTEMP1  MOVE      ZERO,OVRCD
          READKP    VTMPIND1;VTMPVISN,VTMPSDAT,VTMPSTIM,VTMPVTYP,VTMPEDAT:
                        VTMPETIM,VTMPHOUR,VTMPICUS,VTMPISIT
          GOTO      OVERCOND IF OVER
          RETURN
.
WRVTEMP1  RESET     KEY24
          WRITE     VTMPIND1,KEY24;VTMPVISN,VTMPSDAT,VTMPSTIM,VTMPVTYP,VTMPEDAT:
                        VTMPETIM,VTMPHOUR,VTMPICUS,VTMPISIT
          RETURN
+
.------------------------------------------------------------------------------
.         Clear Ventilation Details work variables
.------------------------------------------------------------------------------
CLVENT00  MOVE      SP70,VENTVISN
          MOVE      SP70,VENTVTYP
          MOVE      SP70,VENTSDAT
          MOVE      SP70,VENTSTIM
          MOVE      SP70,VENTEDAT
          MOVE      SP70,VENTETIM
          MOVE      SP70,VENTHOUR
          MOVE      SP70,VENTICUS
          MOVE      SP70,VENTISIT
.
CLVENT99  RETURN
+
.------------------------------------------------------------------------------
.         Store temp file values into Ventilation Details work variables
.------------------------------------------------------------------------------
MVVENT00  MOVE      VTMPVISN,VENTVISN
          MOVE      VTMPVTYP,VENTVTYP
          MOVE      VTMPSDAT,VENTSDAT
          MOVE      VTMPSTIM,VENTSTIM
          MOVE      VTMPEDAT,VENTEDAT
          MOVE      VTMPETIM,VENTETIM
          MOVE      VTMPHOUR,VENTHOUR
          MOVE      VTMPICUS,VENTICUS
          MOVE      VTMPISIT,VENTISIT
.
MVVENT99  RETURN
+
.------------------------------------------------------------------------------
. Table of Current Admissions with Mechanical Ventilation (using temp file)
.------------------------------------------------------------------------------
CAVENT00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          CALL      CRVTMP00           * Create Ventilation Details temp file
.
          PACK      KEY9,TWO,SP70
          CALL      RDSMISS2
CAVENT10  CALL      RDKMISS2
          BRANCH    OVRCD,CAVENT99
.
          COMPARE   "2",ASTAT
          GOTO      CAVENT99 IF NOT EQUAL
.
          CALL      LDVTMP00                * Load ventilation details temp file
.
          MOVE      ZERO,FORM1              * reset MV record found flag
          MOVE      TWO,ICONFLAG            * default to Black MV
.
          CALL      CLVENT00                * clear work variables
.
.
.         Get the most recent Ventilation Details record that either
.         does/not have an End Date/Time.
.
          PACK      KEY24,DAADMNO,Z70
          CALL      RSVTEMP1
CAVENT11  CALL      RPVTEMP1
          BRANCH    OVRCD,CAVENT20
.
          MATCH     VTMPVISN,DAADMNO
          GOTO      CAVENT20 IF NOT EQUAL   * No MV record
.
          MOVE      ONE,FORM1               * set found flag
.
          MATCH     SP70,VENTVISN           * work variables not set?
          IF        @EQUAL
            CALL      MVVENT00              * Since we only want the last record
          ENDIF
.
          MATCH     SP70,VTMPEDAT           * End Date?
          IF        @EQUAL
            MOVE      ONE,ICONFLAG          * no; set Red icon
            CALL      MVVENT00
            GOTO      CAVENT20
          ENDIF
.
          MATCH     SP70,VTMPETIM           * End Time?
          IF        @EQUAL
            MOVE      ONE,ICONFLAG          * no; set Red icon
            CALL      MVVENT00
            GOTO      CAVENT20
          ENDIF
.
          GOTO      CAVENT11                * Get next Vent. record
.
CAVENT20  COMPARE   ZERO,FORM1
          GOTO      CAVENT10 IF EQUAL       * No MV record
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,CAVENT10
.
          CALL      ADMDAT00
          MOVE      AURNO,URNUMBER
          MOVE      AADMNO,ADMISSNO
.
          CALL      GETPAT00
          CALL      PATLN000   * Format Patient Name for System Parameter
.
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
          CLEAR     PATLINK
          APPEND    LINKPRG,PATLINK
          APPEND    ".pbl?reportno=",PATLINK
          APPEND    LINKREP,PATLINK
          APPEND    "&template=",PATLINK
          APPEND    LINKTEM,PATLINK
          APPEND    "&urnumber=",PATLINK
          APPEND    URNUMBER,PATLINK
          APPEND    "&admissno=",PATLINK
          APPEND    ADMISSNO,PATLINK
          RESET     PATLINK
.
          PACK      KEY6,AWARD,ABED
          CALL      FWBD0000
.
          REP       " +",VENTVTYP
          REP       " +",VENTSDAT
          REP       " +",VENTSTIM
          CLEAR     DIM200C
          IF        ICONFLAG=1
            APPEND    "<a href=javascript:onclick=gotoMVRed('",DIM200C
          ELSE
            APPEND    "<a href=javascript:onclick=gotoMV('",DIM200C
          ENDIF
          APPEND    URNUMBER,DIM200C
          APPEND    "','",DIM200C
          APPEND    ADMISSNO,DIM200C
          APPEND    "','",DIM200C
          APPEND    VENTVTYP,DIM200C
          APPEND    "','",DIM200C
          APPEND    VENTSDAT,DIM200C
          APPEND    "','",DIM200C
          APPEND    VENTSTIM,DIM200C
          APPEND    "')>",DIM200C
.
          APPEND    "<img src=../images/mv_",DIM200C
          APPEND    ICONFLAG,DIM200C
          APPEND    ".png>",DIM200C
          APPEND    "</a>",DIM200C
          RESET     DIM200C
.
          REP       "+ ",VENTVTYP
          REP       "+ ",VENTSDAT
          REP       "+ ",VENTSTIM
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
          CALL      PATFLD00               *Returns KEY3 for folder colour code
.
          WRITE     HTMLFILE;*+,"t.addRow(#"",PATLINK,"#",":
                             "#"",URNUMBER,"#",":                      *1
                             "#"",ADMISSNO,"#",":                      *2
                             "#"",FORMATNM,"#",":                      *3
                             *+,"#"",WARDTEXT,"/",BEDTEXT,"#",":       *4
                             "#"",ADATE,"#",":                         *5
                             "#"",DIM200C,"#",":                       *6
                             "#"",KEY3,"#",";                          *7
.
          MOVE      SP70,TDESC
          MATCH     SP70,VENTVTYP
          IF        !@EQUAL
            MOVE      "VE",KEY2
            PACK      KEY5,KEY2,VENTVTYP,SP70
            CALL      RDCODE1
          ENDIF
          WRITE     HTMLFILE;"#"",TDESC,"#",";                   *8
.
          MOVE      SP70,TDESC
          MATCH     SP70,VENTISIT
          IF        !@EQUAL
            MOVE      "II",KEY2
            PACK      KEY5,KEY2,VENTISIT
            CALL      RDCODE1
          ENDIF
          WRITE     HTMLFILE;"#"",TDESC,"#",";                   *9
.
          MOVE      SP70,TDESC
          MATCH     SP70,VENTICUS
          IF        !@EQUAL
            MOVE      "IU",KEY2
            PACK      KEY5,KEY2,VENTICUS
            CALL      RDCODE1
          ENDIF
          WRITE     HTMLFILE;"#"",TDESC,"#",";                   *10
.
          WRITE     HTMLFILE;"#"javascript:LinkPatient('",PATLINK,"') #",": *11
                             "#"",VENTSDAT,VENTSTIM,"#",":       *12
                             "#"",VENTEDAT,VENTETIM,"#");"       *13
.
          GOTO       CAVENT10
.
CAVENT99  CALL      KILTMP00                * Delete temp file
          RETURN
+
.------------------------------------------------------------
. Write Patient Age in Y,M,W or D
.------------------------------------------------------------
.WRTAGE00  MATCH     "y",PSAGETYP
.          GOTO      WRTAGE10 IF NOT EQUAL
.          WRITE     HTMLFILE;PSAGEYRS," yrs";
.          GOTO      WRTAGE99
.
.WRTAGE10  MATCH     "d",PSAGETYP
.          GOTO      WRTAGE20 IF NOT EQUAL
.          WRITE     HTMLFILE;PSAGEDAY," days";
.          GOTO      WRTAGE99
.
.WRTAGE20  MATCH     "m",PSAGETYP
.          GOTO      WRTAGE30 IF NOT EQUAL
.          WRITE     HTMLFILE;PSAGEMNT," mths";
.          GOTO      WRTAGE99
..
..WRTAGE30  MATCH     "w",PSAGETYP
.          GOTO      WRTAGE99 IF NOT EQUAL
.          WRITE     HTMLFILE;PSAGEWKS," wks";
..
..WRTAGE99  RETURN
.
.------------------------------------------------------------
. CHKPRV00 - Check Patient Privacy
.------------------------------------------------------------
CHKPRV00  MATCH      SP70,PMPXPRVI            Privacy code populated ?
.
          IF         !@EQUAL
            MOVE       "PV",KEY2              Y - Set up the category
            PACK       KEY5,KEY2,PMPXPRVI       - Read to see if it's valid
            CALL       RDCODE1
.
            IF         OVRCD = 0
              MATCH      "P",TCINDC1            Y - Its there - Privacy set ?
.
              IF         @EQUAL
                MOVE      SP30,PTITL              Y - Set names to anonymous
                MOVE      SP30,PGNAME
                MOVE      "ANONYMOUS",PSNAME
              ENDIF
            ENDIF
          ENDIF
CHKPRV99  RETURN
.------------------------------------------------------------
. Format Patient Name <b>SURNAME</b>Title Given Names
.------------------------------------------------------------
.PATNAM00  CALL      CHKPRV00
.          CLEAR     DISPNAME
...       REP       "' ",PSNAME
.          REP       "#" ",PSNAME
...       REP       "' ",PGNAME
.          REP       "#" ",PGNAME
.          MOVE      SP70,PATFNAME
.          REP       UPPLOW,PSNAME
.          APPEND    "<b>",DISPNAME
.          APPEND    PSNAME,DISPNAME
.          APPEND    "</b>",DISPNAME
.          PACK      NAME35,PTITL,SP70
.          CALL      NAMSTR00
.          PACK      NAME35,PGNAME,SP70
.          CALL      NAMSTR00
.          APPEND    SP70,DISPNAME
.          RESET     DISPNAME
.          MOVE      DISPNAME,PATFNAME
.          STRIP     PATFNAME
.          RETURN
.+
.------------------------------------------------------------
. Format Patient Name (for Javascript)  <b>SURNAME</b>Title Given Names
.*** format the surname and given name by changing any ' to %60
.------------------------------------------------------------
JAVNAM00  CLEAR     DISPNAME
          MOVE      SP70,JAVFNAME
.
          MOVE      PSNAME,JAVSNAME          * surname
          SCAN      "'",JAVSNAME             * find any apostrophies
          GOTO      JAVNAM10 IF NOT EQUAL
.
          MOVE      JAVSNAME,ENDNAME
          REP       "' ",ENDNAME             * remove the apostrophy
.
          LENSET    JAVSNAME
          RESET     JAVSNAME                 * get all characters before '
          MOVE      JAVSNAME,STRTNAME
.
          REP       "'%",STRTNAME
          STRIP     STRTNAME
          PACK      JAVSNAME,STRTNAME,SIXTY,ENDNAME,SP70 * formatted surname
.
JAVNAM10  MOVE      SP70,STRTNAME
          MOVE      SP70,ENDNAME
.
          MOVE      PGNAME,JAVGNAME     * given name
          SCAN      "'",JAVGNAME        * find any apostrophies
          GOTO      JAVNAM20 IF NOT EQUAL
.
          MOVE      JAVGNAME,ENDNAME    * store all chars after apostrophy
          REP       "' ",ENDNAME        * remove the apostrophy
.
          LENSET    JAVGNAME
          RESET     JAVGNAME
          MOVE      JAVGNAME,STRTNAME   * store all chars before the '
.
          REP       "'%",STRTNAME
          STRIP     STRTNAME
          PACK      JAVGNAME,STRTNAME,SIXTY,ENDNAME,SP70  * formatted given name
.
JAVNAM20  REP       "#" ",JAVSNAME
          REP       "#" ",JAVGNAME
          MOVE      SP70,JAVFNAME
          REP       UPPLOW,JAVSNAME
          APPEND    "<b>",DISPNAME
          APPEND    JAVSNAME,DISPNAME
          APPEND    "</b>",DISPNAME
          PACK      NAME35,PTITL,SP70
          CALL      NAMSTR00
          PACK      NAME35,PGNAME,SP70
          CALL      NAMSTR00
          APPEND    SP70,DISPNAME
          RESET     DISPNAME
          MOVE      DISPNAME,JAVFNAME
          STRIP     JAVFNAME
.
JAVNAM99  RETURN
.
.------------------------------------------------------------
. Display Comments
.------------------------------------------------------------
WATCOM00  PACK      KEY8,ADMISSNO,SP70
          CALL      RDBKREC1
          BRANCH    OVRCD,WATCOM99
.
          PACK      KEY21,BKREURNO,BKREPROC,BKRECNT,SP70
          CALL      RDSMESA1
WATCOM10  CALL      RDKMESA1
          BRANCH    OVRCD,WATCOM99
          MATCH     BKREURNO,WAURNO
          GOTO      WATCOM99 IF NOT EQUAL
          MATCH     BKREPROC,WAPROC
          GOTO      WATCOM99 IF NOT EQUAL
          COMPARE   BKRECNT,WACNT
          GOTO      WATCOM99 IF NOT EQUAL
          STRIP     WATEXT
          MOVELPTR  WATEXT,F3
          IF        F3>0
            SFORMAT   VAR,F3
          ELSE
            SFORMAT   VAR,1
          ENDIF
          MOVE      WATEXT,VAR
          WRITE     HTMLFILE;VAR
          SFORMAT   VAR,127
.
          GOTO      WATCOM10
WATCOM99  RETURN
.
.-------------------------------------------------------------------
. Get Text Waiting List Comment
.------------------------------------------------------------
GETEXT00  PREP      CMMFILAF,CMMFILNM
          ADD       ONE,WTMEEND
          WRITE     CMMFILAF,SEQ;QRYDATA
.
GETEXT10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA * Read CONFFILE sequentially
          GOTO      GETEXT80 IF OVER             * If end of file
          MATCH     SP70,QRYNAME                 * If next CGI parameter
          GOTO      GETEXT80 IF NOT EQUAL
          ADD       ONE,WTMEEND                    * Increment Array Counter
          WRITE     CMMFILAF,SEQ;QRYDATA
          GOTO      GETEXT10
.
GETEXT80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
          OPEN      CMMFILAF,CMMFILNM
GETEXT99  RETURN
.
.------------------------------------------------------------
. Write Comment to File
.------------------------------------------------------------
WRCOM000  COMPARE   ZERO,WTMEEND
          GOTO      WRCOM999 IF EQUAL
          PACK      KEY21,WMURNO,WMCODE,WMCNT,SP70
          CALL      RDSMESA1
WRCOM010  CALL      RDKMESA1
          BRANCH    OVRCD,WRCOM100
          MATCH     WMURNO,WAURNO
          GOTO      WRCOM100 IF NOT EQUAL
          MATCH     WMCODE,WAPROC
          GOTO      WRCOM100 IF NOT EQUAL
          COMPARE   WMCNT,WACNT
          GOTO      WRCOM100 IF NOT EQUAL
          PACK      KEY21,WAURNO,WAPROC,WACNT,WACNT2,SP70
          CALL      DEMESA1
          PACK      KEY21,WMURNO,WMCODE,WMCNT,SP70
          CALL      RDSMESA1
          GOTO      WRCOM010
.
WRCOM100  MOVE      ZERO,F2
WRCOM110  ADD       ONE,F2
          MOVE      WMURNO,WAURNO
          MOVE      WMCODE,WAPROC
          MOVE      WMCNT,WACNT
          MOVE      F2,WACNT2
          PACK      KEY21,WAURNO,WAPROC,WACNT,WACNT2,SP70
          CALL      RDMESA1
          IF        OVRCD=0
            READ      CMMFILAF,SEQ;WATEXT
            MOVE      SP70,WASPARE
            CALL      UPMESA1
          ELSE
            READ      CMMFILAF,SEQ;WATEXT
            MOVE      SP70,WASPARE
            CALL      WRMESA1
          ENDIF
          COMPARE   F2,WTMEEND
          GOTO      WRCOM110 IF NOT EQUAL
.
WRCOM999  RETURN
+
.------------------------------------------------------------------------
. Write ESIS SAD record
.------------------------------------------------------------------------
WSAD0000  READ      CONTROLF,EIGHTY;*250,PTCNHDPS
          COMPARE   THREE,PTCNHDPS
          GOTO      WSAD9999 IF NOT EQUAL
.
          PACK      WTENUNIQ,WTWMECNT,SP70
          PACK      WTENEDAT,SP70
          PACK      WTENWEBC,USERID,SP70
          CALL      IBACLOCK
          PACK      WTENCDAT,CCC,CYY,CMM,CDD
          REP       " 0",WTENCDAT
          CLOCK     TIME,WTENCTIM
          REP       " 0",WTENCTIM
          PACK      WTENWEBU,SP70
          PACK      WTENUDAT,SP70
          PACK      WTENUTIM,SP70
          MOVE      ZERO,WTENMANU
.
          PACK      KEY36,WTENUNIQ,WTENETYP,WTENEVDT,WTENEDAT,WTENSADI,SP70
          CALL      RAWTESN1
          IF        OVRCD=1
            CALL      WRWTESN1
          ELSE
            CALL      UPWTESN1
          ENDIF
.
WSAD9999  RETURN
+
.------------------------------------------------------------
. Hospital Selection
.------------------------------------------------------------
HSEL0000  PACK      KEY3,SP70
          CALL      RSPTHSP1
HSEL0100  CALL      RKPTHSP1
          BRANCH    OVRCD,HSEL9999
.
          PACK      KEY13,USERID,SP70                * All hospital access
          CALL      RDMLSEC1
          IF        OVRCD=1
            PACK      KEY13,USERID,PTHSHOSP,SP70     * This hospital access
            CALL      RDMLSEC1
            BRANCH    OVRCD,HSEL0100
          ENDIF
.
          MOVE      PTHSNAME,KEY50
          PACK      KEY5,QUOTE,PTHSHOSP,QUOTE
          MATCH     FILTHOSP,PTHSHOSP
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY5," selected>":
                               KEY50,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY5,">",KEY50,"</option>"
          ENDIF
          GOTO      HSEL0100
.
HSEL9999  RETURN
+
.-------------------------------------------------------------------------
.DLBMD000 - Delete old patbmdaf records
.-------------------------------------------------------------------------
DLBMD000  PACK      KEY30,ADMISSNO,SP70
          CALL      RSPTBMD2
DLBMD100  CALL      RKPTBMD2
          BRANCH    OVRCD,DLBMD999
          MATCH     ADMISSNO,PTBDADMN
          GOTO      DLBMD999 IF NOT EQUAL
.
          PACK      KEY30,PTBDADMN,PTBDDATE,PTBDADTM,PTBDWARD,PTBDWBED,PTBDOPPE,SP70
          CALL      DEPTBMD2
          GOTO      DLBMD100
.
DLBMD999  RETURN
+
.------------------------------------------------------------
. Bulk Eligibility Request
.-----------------------------------------------------------
BERL0000  BRANCH    FLDITMNO,BERL0100,BERL0200,BERL0300,BERL0400,BERL0500:
                             BERL0600,BERL0700,BERL0800,BERL0900,BERL1000:
                             BERL1100,BERL1200,BERL1300,BERL1400,BERL1500:
                             BERL1600,BERL1700,BERL1800,BERL1900
          GOTO      BERL9999
.
BERL0100  CALL      NEXT0000
          GOTO      BERL9999
.
BERL0200  CALL      PREV0000
          GOTO      BERL9999
.
BERL0300  CALL      CURSTD00
          GOTO      BERL9999
.
BERL0400  CALL      CUREND00
          GOTO      BERL9999
.
BERL0500  CALL      CURYR000
          GOTO      BERL9999
.
BERL0600  CALL      CURMON00
          GOTO      BERL9999
.
BERL0700  CALL      SELV0000
          GOTO      BERL9999
.
BERL0800  CALL      TOEC0000                * Table of Online Elig. Requests
          GOTO      BERL9999
.
BERL0900  WRITE     HTMLFILE;TEMPLATE;
          GOTO      BERL9999
.
BERL1000  WRITE     HTMLFILE;REPORTNO;
          GOTO      BERL9999
.
BERL1100  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      BERL9999
.
BERL1200  CALL      HSEL0000                * Hospital Selection List
          GOTO      BERL9999
.
BERL1300  WRITE     HTMLFILE;HOSPCOMP;      * Hospital Check Complete
          GOTO      BERL9999
.
BERL1400  WRITE     HTMLFILE;REQUSTAT;      * Request Status filter
          GOTO      BERL9999
.
BERL1500  WRITE     HTMLFILE;OECRPRNT;      * Print Bulk Elig. Request Report
          GOTO      BERL9999
.
BERL1600  WRITE     HTMLFILE;FRSTDATE;      * Starting date for list
          GOTO      BERL9999
.
BERL1700  WRITE     HTMLFILE;LASTDATE;      * Ending date for list
          GOTO      BERL9999
.
BERL1800  CALL      BOEC0000                * Table of Online Elig. Requests
          GOTO      BERL9999
.
BERL1900  CALL      COEC0000                * Table of Online Elig. Requests
          GOTO      BERL9999
.
BERL9999  RETURN
+
.------------------------------------------------------------
. Table of Pre-Admissions for Online Eligibility Request
.------------------------------------------------------------
TOEC0000  IF        LNK2PRT<>1
            UNPACK    DIM127,D1,LINKPRG,DIM127
            UNPACK    DIM127,D1,LINKREP,DIM127
            UNPACK    DIM127,D1,LINKTEM,DIM127
          ENDIF
          MOVE      ZERO,RECCNT
.
          MATCH     "1",PTCNWSIN 
          GOTO      TOEC0500 IF NOT EQUAL
.
          MATCH     "1",PTCNOECW
          GOTO      TOEC0500 IF NOT EQUAL
.
          COMPARE   ONE,OECWINDC
          GOTO      TOEC0500 IF NOT EQUAL
.
          CALL      TOEW0000
.
TOEC0500  MATCH     "1",PTCNOECE
          GOTO      TOEC9000 IF EQUAL
.
          PACK      KEY16,FRSTDATE,SP70
          CALL      RDSMISS3
TOEC1000  CALL      RDKMISS3
          BRANCH    OVRCD,TOEC9000
          MATCH     ADATE,LASTDATE
          GOTO      TOEC9000 IF LESS
          COMPARE   "1",ASTAT
          GOTO      TOEC1000 IF NOT EQUAL
.
          MATCH     SP70,HEALTHFN
          IF        !@EQUAL 
            MATCH     HEALTHFN,AFUNDH
            GOTO      TOEC1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,CLAIMTYP
          IF        !@EQUAL
            MATCH     ACLAIM,CLAIMTYP
            GOTO      TOEC1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTBOOK
          IF        !@EQUAL
            PACK      KEY8,AADMNO,SP70
            CALL      RDBKREC1
            BRANCH    OVRCD,TOEC1000
.
            MATCH     FILTBOOK,BKRETYPE
            GOTO      TOEC1000 IF NOT EQUAL
.
          ENDIF
.
          MOVE      SP70,DISPCOMP
          MOVE      ZERO,ELCHFLAG
          PACK      KEY8,DAADMNO,SP70
          CALL      RDPTELG1
          BRANCH    OVRCD,TOEC1500
.
          IF        HOSPCOMP=1
            MATCH     "1",PTELCMPL
            IF        @EQUAL
              MOVE      "Complete",DISPCOMP   * display if elig. complete
              MOVE      TWO,ELCHFLAG
            ELSE
              MOVE      ONE,ELCHFLAG
            ENDIF
          ELSE
            MATCH     "1",PTELCMPL            * don't display if elig. complete
            GOTO      TOEC1000 IF EQUAL
.
            MOVE      ONE,ELCHFLAG
          ENDIF
.
TOEC1500  PACK      DIM1,SP20
          PACK      DISPCLSS,SP20
          PACK      DISPALTD,SP70
          PACK      KEY5,ANSC,ANSC,ACARE,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            UNPACK      TCINDC21,DIM1
          ENDIF
          MATCH     DIM1,SP70
          IF        !@EQUAL
            PACK      DISPCLSS,ONCLCLSS,DIM1,SP70
            PACK      DISPALTD,PTCDLDES,SP70
          ENDIF
          SQUEEZE   DISPCLSS
          STRIP     DISPALTD
.
          PACK      KEY11,DAADMNO,Z70
          CALL      RSPMOEC1
          CALL      RPPMOEC1                   * get last OEC request
          IF        OVRCD=1
            MOVE      "99",PMOESTAT            * no request status exists
            MOVE      SP70,PMOEUDTE
          ENDIF
.
          MATCH     DAADMNO,PMOEVISN
          IF        !@EQUAL
            MOVE      "99",PMOESTAT            * no request status exists
            MOVE      SP70,PMOEUDTE
          ENDIF
.
          MATCH     SP70,REQUSTAT
          GOTO      TOEC2000 IF EQUAL          * filter by request status ?
.
          MATCH     REQUSTAT,PMOESTAT
          GOTO      TOEC1000 IF NOT EQUAL      * yes (filter)
.
TOEC2000  MOVE      AADMNO,PMVXVISN            * Find Visit extension record
          PACK      KEY8,PMVXVISN,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,TOEC5000
.
          IF        IBCNMHOS<>1
            GOTO      TOEC5000
          ENDIF
.
          MATCH     SP70,FILTHOSP
          IF        !@EQUAL
            MATCH     FILTHOSP,PMVXMHOS       
            GOTO      TOEC1000 IF NOT EQUAL
          ELSE
            PACK      KEY13,USERID,SP70              * All hospital access
            CALL      RDMLSEC1
            IF        OVRCD=1
              PACK      KEY13,USERID,PMVXMHOS,SP70   * This hospital access
              CALL      RDMLSEC1
              BRANCH    OVRCD,TOEC1000
            ENDIF
          ENDIF
.
. Display the visit
.
TOEC5000  PACK      URNUMBER,AURNO
          PACK      ADMISSNO,AADMNO
          MOVE      AURNO,URNO
          CALL      GETPAT00      * Get Patient Details
          CALL      ADMDAT00      * Get Admission Date & Time
          CALL      PATLN000      * Format Patient Name with System Parameter
.
          MOVE      "Pre-admitted",STATUS20
.
          PACK      DSPOECST,SP70
          MOVE      PMOESTAT,F2
          LOAD      DSPOECST,F2,DSPPMOE1,DSPPMOE2,DSPPMOE3,DSPPMOE4,DSPPMOE5:
                                DSPPMOE6,DSPPMOE7
.
          MATCH     " 0",PMOESTAT
          IF        @EQUAL
            MOVE      DSPPMOE0,DSPOECST
          ENDIF
.
          MOVE      "CL",CATEGORY           * Claim code Description
          MOVE      ACLAIM,CODE   
          CALL      GETCOD00
          MOVE      TDESC,CLAIMDES
.
          CALL      VOEC0000                * Validate criteria (set oecrflag)
.
          CALL      GETELF00
.
          MOVE      ZERO,REQUFLAG
          PACK      HTMLLINK,SP70,SP70,SP70,SP70
          CLEAR     HTMLLINK
          PACK      HTMLLNK3,SP70,SP70,SP70,SP70
          CLEAR     HTMLLNK3
          MATCH     "99",PMOESTAT
          IF        !@EQUAL
            MOVE      ONE,REQUFLAG          * display icon if request exists
            APPEND    "javascript:ViewRequest('",HTMLLINK
            APPEND    PMOEVISN,HTMLLINK
            APPEND    "','",HTMLLINK
            APPEND    PMOECNTR,HTMLLINK
            APPEND    "')",HTMLLINK
            RESET     HTMLLINK
.
            REP       " +",PMOEVISN
            REP       " +",PMOECNTR       
.
            APPEND    "<img src=../images/MaintenanceIcon.gif ",HTMLLNK3
            APPEND    "onclick=ViewRequest('",HTMLLNK3
            APPEND    PMOEVISN,HTMLLNK3
            APPEND    "','",HTMLLNK3
            APPEND    PMOECNTR,HTMLLNK3
            APPEND    "');>&nbsp;",HTMLLNK3
            APPEND    DSPOECST,HTMLLNK3
            RESET     HTMLLNK3
.
            REP       "+ ",PMOEVISN
            REP       "+ ",PMOECNTR
.
          ENDIF
.
          MOVE      ZERO,PELFFLAG
          CLEAR     HTMLLNKL
          MATCH     "99",PMOESTAT
          IF        !@EQUAL
.            MATCH     SP70,PMEFELGN
.            IF        !@EQUAL
              MOVE      ONE,PELFFLAG
.
              REP       " +",PMOEURNO
              REP       " +",PMOEVISN
              REP       " +",PMOECNTR
.
              APPEND    "<img src=../images/MaintenanceIcon.gif ",HTMLLNKL
              APPEND    "onclick=disOEC('",HTMLLNKL
              APPEND    PMOEURNO,HTMLLNKL
              APPEND    "','",HTMLLNKL
              APPEND    PMOEVISN,HTMLLNKL
              APPEND    "','",HTMLLNKL
              APPEND    PMOECNTR,HTMLLNKL
              APPEND    "');>",HTMLLNKL
              RESET     HTMLLNKL
.
              REP       "+ ",PMOEURNO
              REP       "+ ",PMOEVISN
              REP       "+ ",PMOECNTR
.            ENDIF
          ENDIF
.
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
          CLEAR     PATLINK
          APPEND    LINKPRG,PATLINK
          APPEND    ".pbl?reportno=",PATLINK
          APPEND    LINKREP,PATLINK
          APPEND    "&template=",PATLINK
          APPEND    LINKTEM,PATLINK
          APPEND    "&urnumber=",PATLINK
          APPEND    URNUMBER,PATLINK
          APPEND    "&admissno=",PATLINK
          APPEND    ADMISSNO,PATLINK
          RESET     PATLINK
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":        * 0
                             "#"",ADMISSNO,"#",":                 * 1
                             "#"",FORMATNM,"#",":                 * 2
                             "#"",CLAIMDES,"#",":                 * 3
                             "#"",AFUNDH,"#",":                   * 4
                             "#"",STATUS20,"#",":                 * 5
                             "#"",ADATE,"#",":                    * 6
                             "#"",DISPCOMP,"#",":                 * 7
                             "#"",DSPOECST,"#",":                 * 8
                    "#"",PMOECDTE,PMOECTIM,"#",":                 * 9
                             "#"",REQUFLAG,"#",";                 * 10
.
. Request checkbox: disable if mandatory fields incomplete (oecrflag=0)
.                   otherwise default to ticked (oecrflag=1)
.
          ADD       ONE,RECCNT                                    * 11
          MOVE      RECCNT,DRECCNT
          REP       " 0",DRECCNT
.
          MATCH     SP70,PMVXPILC
          IF        !@EQUAL & !@EOS
            MATCH     SP70,AMBS
            IF        !@EQUAL & !@EOS
              MOVE      ZERO,OECRFLAG
            ENDIF
          ENDIF
.
          IF        OECRFLAG<>1
            WRITE     HTMLFILE;"#"<input type=checkbox name=oereq",DRECCNT:
                      " disabled>";
          ELSE
            WRITE     HTMLFILE;"#"<input type=checkbox checked=true name=oereq":
                      DRECCNT:
                      " onClick=UpdateArray(this.value); value='",ADMISSNO:
                      OECRFLAG,"'>";
          ENDIF
.
.>>>>>    IF        OECRFLAG=1
            WRITE     HTMLFILE;"#",#"",PATLINK;
            CALL      PATFLD00
            WRITE     HTMLFILE;"#",#"",KEY3;
            WRITE     HTMLFILE;"#",#"",ADIAG1;            
.
            MOVE      SP70,DOCFNAME
            MOVE      ADOCTA,KEY6
            CALL      RDDOCT1
            IF        OVRCD=0
              MOVE      DTITL,FMTTITLE
              MOVE      DGNAME,FMTGNAME
              MOVE      DSNAME,FMTSNAME
              CALL      DOCNM000
            ENDIF
.
            WRITE     HTMLFILE;"#",#"",DOCFNAME;
.
            IF        ELCHFLAG=ZERO
              WRITE     HTMLFILE;"#",#"<input test=1 type=checkbox name=oechk",DRECCNT:
                                  " disabled>"; 
            ELSE
              IF        ELCHFLAG=ONE 
                WRITE     HTMLFILE;"#",#"<input type=checkbox name=oechk":
                                   DRECCNT:
                                   " onclick='UpdateElgCheck(this);'": 
                                   " value='",ADMISSNO,"'>";
              ELSE
                WRITE     HTMLFILE;"#",#"<input type=checkbox checked name=oechk":
                                   DRECCNT:
                                   " onclick='UpdateElgCheck(this);'":
                                   " value='",ADMISSNO,"'>";
              ENDIF
            ENDIF
.
            WRITE     HTMLFILE;"#",#"",HTMLLNKL;
            WRITE     HTMLFILE;"#",#"",HTMLLNK3;
.
            CALL      PRILL000
            CALL      MBSC0000
.
.           IF        OECRFLAG<>1
.             WRITE     HTMLFILE;"#",#"<input type=checkbox name=oeccn":
.                                  DRECCNT:
.                                  " disabled>";
.           ELSE
              MATCH     "1",PMVXPOEC
              IF        @EQUAL
              WRITE     HTMLFILE;"#",#"<input type=checkbox checked name=oeccn":
                                   DRECCNT:
                                   " onclick='UpdateOECConsent(this);'":
                                   " value='",ADMISSNO,"'>";
              ELSE
                WRITE     HTMLFILE;"#",#"<input type=checkbox name=oeccn":
                                   DRECCNT:
                                   " onclick='UpdateOECConsent(this);'":
                                   " value='",ADMISSNO,"'>";
              ENDIF
.           ENDIF
.
          WRITE     HTMLFILE;"#",#"",DISPCLSS;
          WRITE     HTMLFILE;"#",#"",DISPALTD;
.
          IF        OECRFLAG=1
            WRITE     HTMLFILE;"#");":
                               " UpdateArray('",ADMISSNO,OECRFLAG,"');"
          ELSE
            WRITE     HTMLFILE;"#");"
          ENDIF
.
          IF        RECCNT>=90
            WRITE     HTMLFILE;"alert('Limit of 90 records reached');"
            GOTO      TOEC9000
          ENDIF
.
          GOTO      TOEC1000
.
TOEC9000
TOEC9999  RETURN
+
.------------------------------------------------------------
. Incomplete Eligibility
.-----------------------------------------------------------
INEL0000  BRANCH    FLDITMNO,INEL0100,INEL0200
          GOTO      INEL9999
.
INEL0100  CALL      PIEL0000                * Table of Incomplete Eligibility
          GOTO      INEL9999
.
INEL0200  PACK      DFLTWARD,WARDCODE                                      
          CALL      WSEL0000                * Ward selection list
          GOTO      INEL9999
.
INEL9999  RETURN
.-----------------------------------------------------------
. Patient Incomplete Eligibility List
.-----------------------------------------------------------
PIEL0000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          PACK      KEY9,TWO,SP70
          CALL      RDSMISS2
PIEL5000  CALL      RDKMISS2
          BRANCH    OVRCD,PIEL9999
.
          COMPARE   "2",ASTAT
          GOTO      PIEL9999 IF NOT EQUAL
.
.>>>>     COMPARE   "4",ASTAT
.>>>>     GOTO      PIEL9999 IF NOT EQUAL
.
PIEL5500  MATCH     SP70,WARDCODE
          IF        !@EQUAL
            MATCH     WARDCODE,AWARD
            GOTO      PIEL5000 IF NOT EQUAL
          ENDIF
.
PIEL6000  PACK      KEY8,AADMNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,PIEL5000
.
          COMPARE   ONE,IBCNMHOS
          GOTO      PIEL7000 IF NOT EQUAL
.
          MATCH     SP70,WBSEHOSP
          GOTO      PIEL7000 IF EQUAL
.
          MATCH     WBSEHOSP,PMVXMHOS
          GOTO      PIEL5000 IF NOT EQUAL
.
PIEL7000  MOVE      AADMNO,KEY8
          CALL      RDPTELG1
          IF        OVRCD=1
            CALL      CLRELG00              * Clear eligibility fields
          ENDIF
.
          MATCH     "1",PTELCMPL
          GOTO      PIEL5000 IF EQUAL       * only want incompletes
.
          CALL      IELCON00
          GOTO      PIEL5000
.
PIEL9999  RETURN
+
.-----------------------------------------------------------
. Incomplete Eligibility Contents
.-----------------------------------------------------------
IELCON00  MOVE      AURNO,URNUMBER          * URNUMBER used in GETPAT
          MOVE      AADMNO,ADMISSNO         * ADMISSNO used in GETPAT
          MOVE      SP70,EXPDSCDT           * initialise expected disch. date
          MATCH     ZEROUR,URNUMBER
          IF        !@EQUAL
            CALL      GETPAT00              * Get patient information
          ENDIF
.
          CALL      PATLN000      * Format Patient Name with System Parameter
.
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
          CLEAR     PATLINK
          APPEND    LINKPRG,PATLINK
          APPEND    ".pbl?reportno=",PATLINK
          APPEND    LINKREP,PATLINK
          APPEND    "&template=",PATLINK
          APPEND    LINKTEM,PATLINK
          APPEND    "&urnumber=",PATLINK
          APPEND    URNUMBER,PATLINK
          APPEND    "&admissno=",PATLINK
          APPEND    ADMISSNO,PATLINK
          RESET     PATLINK
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
          CALL      PATFLD00               * Returns KEY3 for folder colour code
.
          MOVE      "CL",CATEGORY           * Claim code Description
          MOVE      ACLAIM,CODE
          CALL      GETCOD00
          MOVE      TDESC,CLAIMDES
.
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      ASTAY,ADJDAYS
          CALL      ADJDAT00
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      EXPDSCDT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          PACK      KEY6,AWARD,ABED
          CALL      RDWARD1
          CALL      FWBD0000
          PACK      KEY6,AWARD,SP70
          CALL      RDWARD1
          MOVE      PTWDSDES,KEY10    * get short name of ward
          MOVE      SP70,WBDESC
          PACK      KEY6,AWARD,ABED,SP70
          CALL      RDWARD1
.
          WRITE     HTMLFILE;"t.addRow(#"",PATLINK,"#",":       * 0
                             "#"",URNUMBER,"#",":               * 1
                             "#"",ADMISSNO,"#",":               * 2
                             "#"",FORMATNM,"#",":               * 3
                             "#"",CLAIMDES,"#",":               * 4
                             "#"",AFUNDH,"/",AFNDTB,"#",":      * 5
                             "#"",EXPDSCDT,"#",":               * 6
                             "#"",WBEDTEXT,"#",":               * 7
                             "#"",KEY3,"#",";                   * 8
.
          MATCH     "1",PTELXCLS
          IF        @EQUAL
            WRITE     HTMLFILE;"#"<input type=checkbox name=dummy ":
                               "checked disabled>#",";
          ELSE
            WRITE     HTMLFILE;"#"<input type=checkbox name=dummy disabled>#",";
          ENDIF
.
          MATCH     "1",PTELQEXS
          IF        @EQUAL
            WRITE     HTMLFILE;"#"<input type=checkbox name=dummy ":
                               "checked disabled>#",";
          ELSE
            WRITE     HTMLFILE;"#"<input type=checkbox name=dummy disabled>#",";
          ENDIF
.
          MATCH     "1",PTELQACC
          IF        @EQUAL
            WRITE     HTMLFILE;"#"<input type=checkbox name=dummy ":
                               "checked disabled>#",";
          ELSE
            WRITE     HTMLFILE;"#"<input type=checkbox name=dummy disabled>#",";
          ENDIF
.
          CALL      GPAY0000              * Get any payment received
          WRITE     HTMLFILE;"#"",PTELPPRI," P<br>":
                             PTELPSHA," S<br>":
                             PTELPTHE," T","#",":
                             "#"",PTELXCSS,"#",":
                             "#"",FORM12P2,"#");"
.
IELCON99  RETURN
+
.---------------------------------------------------------------
. Update Pre-assessment details
.---------------------------------------------------------------
UPPREA00  PACK      KEY8,ADMISSNO,SP70
          CALL      RDBKREC1                * Read booking file
          BRANCH    OVRCD,UPPREA90,UPPREA93
.
          PACK      KEY8,BKREBOOK,SP70
          CALL      RDBKRX11                * Read booking extn file
          BRANCH    OVRCD,UPPREA90
.
          PACK      KEY8,BKREURNO,SP70
          CALL      RDAMAST1
          BRANCH    OVRCD,UPPREA10
          CALL      RDMAST1                 * Read Patient Master if exists
.
UPPREA10  PACK      KEY8,ADMISSNO,SP70
          CALL      RDAMISS1
          BRANCH    OVRCD,UPPREA12
          CALL      RDMISS1                 * Read Patient Admission if exists
.
UPPREA12  PACK      KEY8,BKREURNO,SP70
          CALL      RAPMPX21
          BRANCH    OVRCD,UPPREA13
          CALL      RDPMPX21                * Read PMI Extension if exists
.
UPPREA13  MATCH     "1",PHISFLAG
          IF        @EQUAL
            PACK      KEY35,BKREURNO,ADMISSNO,ATYPE030,PTATR003,PTATR004:
                      SP70
          ELSE
            PACK      KEY35,BKREURNO,ADMISSNO,ATYPE030,BKRXUDD1,BKRXUDT1:
                      SP70
          ENDIF
          CALL      RDPTATR3
          BRANCH    OVRCD,UPPREA15
.
UPPREA15  MATCH     SP70,UPDTTYPE
          GOTO      UPPREA70 IF EQUAL
.
          MATCH     ANSU,UPDTTYPE
          GOTO      UPPREA94 IF NOT EQUAL
.
          MATCH     "1",NOBOKMOD
           IF        @EQUAL
            PACK      BOKRX029,Z70            * modified time
            PACK      BOKRX028,Z70            * modified date
            PACK      BOKRX030,Z70            * updater
            CALL      MVBKRX00                * Set extension file fields
            CALL      UPBKRX11                * Update booking extn file
            CALL      PTATTR00                * Write Patient Attribute "030"
            GOTO      UPPREA99
          ENDIF
.
          CALL      MVBKRX00                * Set extension file fields
          PACK      BKRXLUPD,CCC,CYY,CMM,CDD
          REP       " 0",BKRXLUPD
          CLOCK     TIME,BKRXLUPT
          MOVE      USERID,BKRXWEBU
          CALL      UPBKRX11                * Update booking extn file
          CALL      PTATTR00                * Write Patient Attribute "030"
          GOTO      UPPREA99
.
UPPREA70  MOVE      "Pre-Assessment Details",WEBTITLE
          CALL      WEBHED00                * Create Output & Write HTML Header
          BRANCH    EXIT,UPPREA99
          CALL      WEBBOD00                * Process Web Body (calls PROFLD00)
          CALL      WEBEND00                * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      UPPREA99
.
UPPREA80  MOVE      ZERO,EXIT
          GOTO      UPPREA99
.
UPPREA90  MOVE      "Invalid booking number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPPREA99
.
UPPREA93  MOVE      "Booking record locked",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPPREA99
.
UPPREA94  MOVE      "Invalid update type",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPPREA99
.
UPPREA99  RETURN
+
.------------------------------------------------------------
. Morgue Management
.------------------------------------------------------------
MORG0000  BRANCH    FLDITMNO,MORG0100,MORG0200,MORG0300,MORG0400:
                             MORG0500,MORG0600,MORG0700,MORG0800:
                             MORG0900,MORG1000,MORG1100,MORG1200
.
MORG0100  CALL      NEXT0000
          GOTO      MORG9999
.
MORG0200  CALL      PREV0000
          GOTO      MORG9999
.
MORG0300  CALL      CURSTD00
          GOTO      MORG9999
.
MORG0400  CALL      CUREND00
          GOTO      MORG9999
.
MORG0500  CALL      CURYR000
          GOTO      MORG9999
.
MORG0600  CALL      CURMON00
          GOTO      MORG9999
.
MORG0700  CALL      SELV0000
          GOTO      MORG9999
.
MORG0800  CALL      TOMP0000
          GOTO      MORG9999
.
MORG0900  WRITE     HTMLFILE;TEMPLATE;
          GOTO      MORG9999
.
MORG1000  WRITE     HTMLFILE;REPORTNO;
          GOTO      MORG9999
.
MORG1100  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      MORG9999
.
MORG1200  MATCH     SP70,FILTHOSP
          IF        @EQUAL
            IF        FILTFLAG=0
              MOVE      WBSEHOSP,FILTHOSP
            ENDIF
          ENDIF
          CALL      HSEL0000                * Hospital Selection List
          GOTO      MORG9999
.
MORG9999  RETURN
.
.------------------------------------------------------------
. Morgue Management Table
.------------------------------------------------------------
TOMP0000  CALL      TABHED00
          PACK      KEY24,FRSTDATE,SP70
          CALL      RSPMMOR2
TOMP1000  CALL      RKPMMOR2
          BRANCH    OVRCD,TOMP9999
.
          MATCH     PMMRARDT,LASTDATE                   * Within the date range
          GOTO      TOMP9999 IF LESS
.
          PACK      KEY8,PMMRADMN,SP70
          CALL      RDVISA1
          BRANCH    OVRCD,TOMP1000
.
          MOVE      SP70,DSDTWORK
          MOVE      SP70,DSTMWORK
          MOVE      SP70,DOCFNAME
.
          IF        PVITYPE=1
            PACK      KEY8,PMMRADMN,SP70                  * Check for Discharge
            CALL      RDEMVIS1                            * Emergency
            BRANCH    OVRCD,TOMP1000
.
            MOVE      EMVIDDAT,DSDTWORK
            MOVE      EMVIDTIM,DSTMWORK
.
            PACK      KEY10,EMVIDOCT,SP70
            CALL      RDPMHCP1
            IF        OVRCD<>1
              MOVE      PMHCTITL,FMTTITLE
              MOVE      PMHCGNAM,FMTGNAME
              MOVE      PMHCSNAM,FMTSNAME
              CALL      DOCNM000
            ENDIF
            GOTO      TOMP2000
          ENDIF
.
          IF        PVITYPE=3           
            PACK      KEY8,PMMRADMN,SP70                  * Check for admission
            CALL      RDMISS1                             * Inpatient
            BRANCH    OVRCD,TOMP1000
.
            PACK      KEY8,PMMRADMN,SP70                  * Check for discharge
            CALL      RDDSCH1                             * Inpatient
            BRANCH    OVRCD,TOMP1000
.
            MOVE      DDATE,DSDTWORK
            MOVE      DTIME,DSTMWORK
.
            PACK      KEY10,ADOCTA,SP70
            CALL      RDPMHCP1
            IF        OVRCD<>1
              MOVE      PMHCTITL,FMTTITLE
              MOVE      PMHCGNAM,FMTGNAME
              MOVE      PMHCSNAM,FMTSNAME
              CALL      DOCNM000
            ENDIF
            GOTO      TOMP2000
          ENDIF
.
          GOTO      TOMP1000
.
TOMP2000  MOVE      SP70,DSCHDATE                           * Format Date
          UNPACK    DSDTWORK,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DSCHDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          PACK      KEY8,PMMRADMN,SP70                  * Visit Ex Hospital var
          CALL      RDPMVX11
          BRANCH    OVRCD,TOMP1000 
.
          IF        IBCNMHOS=1
            MATCH     SP70,FILTHOSP
            IF        !@EQUAL
              MATCH     FILTHOSP,PMVXMHOS               * Check Hospital ID
              GOTO      TOMP1000 IF NOT EQUAL
            ENDIF
          ENDIF
.
          MOVE      SP70,MORGLOCN
          MATCH     SP70,PMMRLOCA
          IF        !@EQUAL
            PACK      KEY5,CODEMU,PMMRLOCA,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,MORGLOCN
            ENDIF
          ENDIF
.
          MOVE      SP70,MORGEXCB
          MATCH     SP70,PMMRECBY
          IF        !@EQUAL & !@EOS
            PACK      KEY5,CODECY,PMMRECBY,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,MORGEXCB
            ENDIF
          ENDIF
.
          MOVE      SP70,MORGECDT                           * Format Date
          MATCH     SP70,PMMRECDT
          IF        !@EQUAL
            UNPACK    PMMRECDT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      MORGECDT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MOVE      SP70,MORGACCB
          MATCH     SP70,PMMRACBY
          IF        !@EQUAL & !@EOS
            PACK      KEY5,CODSAC,PMMRACBY,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,MORGACCB
            ENDIF   
          ENDIF
.
          MOVE      SP70,MORGACDT                           * Format Date
          MATCH     SP70,PMMRACDT
          IF        !@EQUAL
            UNPACK    PMMRACDT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      MORGACDT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR 
          ENDIF
.
          MOVE      SP70,WARDTEXT
          MOVE      SP70,BEDTEXT
          PACK      KEY30,PMMRADMN,SP70
          CALL      RDSTRAN2
TOMP3000  CALL      RDKTRAN2
          BRANCH    OVRCD,TOMP4000
.
          MATCH     DTADMN,PMMRADMN
          GOTO      TOMP4000 IF NOT EQUAL
.
          MATCH     "D",TMOVE
          GOTO      TOMP3000 IF NOT EQUAL
.
          MOVE      TWARD,AWARD
          MOVE      TBED,ABED
.
          PACK      KEY6,TWARD,TBED        
          CALL      FWBD0000      * format ward/bed text   
.
TOMP4000  PACK      URNUMBER,PMMRURNO
          PACK      ADMISSNO,PMMRADMN
.
          CALL      DISMRG00
          GOTO      TOMP1000
.
TOMP9999  RETURN
.------------------------------------------------------------
. Morgue Management Table Row
.------------------------------------------------------------
DISMRG00  CALL      GETPAT00
          CALL      PATLN000
          CALL      PATFLD00 
.
          REP      " +",URNUMBER
          REP      " +",ADMISSNO
.
.         CLEAR     PATLINK
.         APPEND    LINKPRG,PATLINK
.         APPEND    ".pbl?reportno=",PATLINK
.         APPEND    LINKREP,PATLINK
.         APPEND    "&template=",PATLINK
.         APPEND    LINKTEM,PATLINK
.         APPEND    "&urnumber=",PATLINK
.         APPEND    URNUMBER,PATLINK
.         APPEND    "&admissno=",PATLINK
.         APPEND    ADMISSNO,PATLINK
.         RESET     PATLINK
.
          CLEAR     PATLINK
          APPEND    "javascript:UpdateMorgue('",PATLINK
          APPEND    URNUMBER,PATLINK
          APPEND    "#',#'",PATLINK
          APPEND    ADMISSNO,PATLINK
          APPEND    "')",PATLINK
          RESET     PATLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",FORMATNM,"#",":
                             "#"",DSCHDATE,"#",":                * 1
                             "#"",DSTMWORK,"#",":                * 2
                             "#"",DOCFNAME,"#",":                * 3
                             "#"",MORGLOCN,"#",":                * 4
                             "#"",MORGEXCB,"#",":                * 5
                             "#"",MORGECDT,"#",":                * 6
                             "#"",MORGACCB,"#",":                * 7
                             "#"",MORGACDT," ",PMMRACTM,"#",":   * 8
                             *+,"#"",WARDTEXT,BEDTEXT,"#",",*-:  * 9
                             "#"",RELICODE,"#",":                * 10
                             "#"",PATLINK,"#",":                 * 11
                               "#"",KEY3,"#");"                    * 12
. 
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
DISMRG99  RETURN
.
.---------------------------------------------------------------
. Update Morgue details
.---------------------------------------------------------------
UPMORG00  REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMMOR1                * Read morgue file
          BRANCH    OVRCD,UPMORG90,UPMORG93
.
          MATCH     SP70,UPDTTYPE
          GOTO      UPMORG70 IF EQUAL
.
          MATCH     ANSU,UPDTTYPE
          GOTO      UPMORG60 IF EQUAL
.
          MATCH     ANSD,UPDTTYPE
          GOTO      UPMORG50 IF EQUAL
.
          GOTO      UPMORG94    
.
UPMORG50  CALL      DEPMMOR1                * Delete morgue details record
          CALL      BBCL0000                * Remove patient from bed board
          GOTO      UPMORG99
.
UPMORG60  PACK      KEY8,ADMISSNO
          CALL      RDDSCH1
          BRANCH    OVRCD,UPMORG65
.
          MOVE      SP70,KEY16
          PACK      KEY16,DDATE,DTIME
          MATCH     SP70,KEY16
          GOTO      UPMORG69 IF EQUAL
          GOTO      UPMORG69 IF EOS
.
          UNPACK    SP70,TMPDSDAT,TMPDSTIM
          MOVE      DDATE,TMPDSDAT
          MOVE      DTIME,TMPDSTIM
.
          GOTO      UPMORG67
.
UPMORG65  PACK      KEY8,ADMISSNO
          CALL      RDEMVIS1
          BRANCH    OVRCD,UPMORG69
.
          COMPARE   FOUR,EMVISTAT
          GOTO      UPMORG69 IF EQUAL
.
          MOVE      SP70,KEY16
          PACK      KEY16,EMVIDDAT,EMVIDTIM
          MATCH     SP70,KEY16
          GOTO      UPMORG69 IF EQUAL
          GOTO      UPMORG69 IF EOS
.
          UNPACK    SP70,TMPDSDAT,TMPDSTIM
          MOVE      EMVIDDAT,TMPDSDAT
          MOVE      EMVIDTIM,TMPDSTIM
.
UPMORG67  MATCH     TMPDSDAT,PMSMR003       * Validate Discharge Date/Time
          GOTO      UPMORG91 IF LESS        * against Morgue Arrival Date/Time
          IF        @EQUAL
            MATCH     TMPDSTIM,PMSMR004
            GOTO      UPMORG91 IF LESS
          ENDIF
.
UPMORG69  CALL      MVMORG00                * Set morgue file fields
          CALL      UPPMMOR1                * Update morgue file
.
          MATCH     SP70,PMMRLOCA
          IF        !@EQUAL
            CALL      BBCL0000              * Remove patient from bed board
          ENDIF
.
          GOTO      UPMORG99
.
UPMORG70  MOVE      "Morgue Details",WEBTITLE
          CALL      WEBHED00                * Create Output & Write HTML Header
          BRANCH    EXIT,UPMORG99
          CALL      WEBBOD00                * Process Web Body (calls PROFLD00)
          CALL      WEBEND00                * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      UPMORG99
.
UPMORG80  MOVE      ZERO,EXIT
          GOTO      UPMORG99
.
UPMORG90  MOVE      "Invalid Visit number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPMORG99
.
UPMORG91  MOVE      "Arrival Date/Time cannot be before Discharge Date/Time.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPMORG99
.
UPMORG93  MOVE      "Morgue record locked",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPMORG99
.
UPMORG94  MOVE      "Invalid update type",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPMORG99
.
UPMORG99  RETURN
+
.------------------------------------------------------------------------------
. Bulk Online Eligibility Request (option 19)
.------------------------------------------------------------------------------
BOEREQ00  MATCH     SP70,UPDTTYPE
          GOTO      BOEREQ70 IF EQUAL
.
          MATCH     "D",UPDTTYPE            * Display Request Info
          GOTO      BOEREQ10 IF EQUAL
.
          MATCH     "R",UPDTTYPE            * Bulk Online Eligibility Request
          GOTO      BOEREQ20 IF EQUAL
.
          GOTO      BOEREQ90
.
BOEREQ10  MATCH     "1",PTCNWSIN
          GOTO      BOEREQ15 IF NOT EQUAL
.
          MATCH     "1",PTCNOECW
          GOTO      BOEREQ15 IF NOT EQUAL
.
          COMPARE   ONE,OECWINDC
          GOTO      BOEREQ15 IF NOT EQUAL
.
          PACK      KEY11,PMSOC001,PMSOC002,SP70
          CALL      RDWBOEC1                * read eligibility request file
          BRANCH    OVRCD,BOEREQ92 
.
          MOVE      WBOCVISN,PMOEVISN
          MOVE      WBOCCNTR,PMOECNTR
          MOVE      WBOCSTAT,PMOESTAT
          MOVE      WBOCURNO,PMOEURNO
          MOVE      WBOCARID,PMOEARID
          MOVE      WBOCTRID,PMOETRID
          MOVE      WBOCRQDT,PMOERQDT
          MOVE      WBOCETYP,PMOEETYP
          MOVE      WBOCERRC,PMOEERRC
          MOVE      WBOCERRD,PMOEERRD
          MOVE      WBOCCDTE,PMOECDTE
          MOVE      WBOCCTIM,PMOECTIM
          MOVE      WBOCUDTE,PMOEUDTE
          MOVE      WBOCUTIM,PMOEUTIM
          MOVE      WBOCHOSP,PMOEHOSP
          MOVE      WBOCELEG,PMOEELEG
.
          GOTO      BOEREQ70
.
BOEREQ15  MATCH     "1",PTCNOECE
          GOTO      BOEREQ70 IF EQUAL
.
          PACK      KEY11,PMSOC001,PMSOC002,SP70
          CALL      RDPMOEC1                * read eligibility request file
          BRANCH    OVRCD,BOEREQ91
.
          GOTO      BOEREQ70
.
BOEREQ20  CALL      SOEC0000                * Schedule OECs for selected visits
          MOVE      ZERO,EXIT
          GOTO      BOEREQ99
.
.         ************ DISPLAY FORMACTION **********
.
BOEREQ70  CLEAR     WEBTITLE
          MOVE      "Bulk Online Eligibility Request",WEBTITLE
          RESET     WEBTITLE
.
          CALL      CURPER00   * Determine Current Period
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,BOEREQ99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      BOEREQ99
.
BOEREQ90  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      BOEREQ99
.
BOEREQ91  MOVE      "OEC Eligibility Request details not found.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      BOEREQ99
.
BOEREQ92  MOVE      "OECW Eligibility Request details not found.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      BOEREQ99
.
BOEREQ99  RETURN
+
.******************************************************************************
.         Validate eligibility criteria for OEC
.******************************************************************************
. Exclude all preadmissions not meeting the following criteria:
.
VOEC0000  MATCH     "1",PMVXPOEC
          GOTO      VOEC9500 IF NOT EQUAL
.
          MOVE      AURNO,KEY8
          CALL      RDMAST1
          IF        OVRCD=1
            GOTO      VOEC9500
          ENDIF
.
          MATCH     SP70,PSNAME            * surname set?
          IF        @EQUAL
            GOTO      VOEC9500
          ENDIF
.
          MATCH     SP70,PGNAME            * given name set?
          IF        @EQUAL
            GOTO      VOEC9500
          ENDIF
.
          MATCH     SP70,PBDATE            * DOB set?
          IF        @EQUAL
            GOTO      VOEC9500
          ENDIF
.
          MATCH     SP70,AFUNDH            * Health fund set ?
          IF        @EQUAL
            GOTO      VOEC9500
          ENDIF
.
          MATCH     SP70,AFNDTB            * Health fund table set ?
          IF        @EQUAL
            GOTO      VOEC9500
          ENDIF
.
          MATCH     SP70,ADATE             * Admission date set ?
          IF        @EQUAL
            GOTO      VOEC9500
          ENDIF
.
          MATCH     SP70,ACLAIM            * claim type set ?
          IF        @EQUAL
            GOTO      VOEC9500
          ENDIF
.
.         MATCH     SP70,ADIAG1            * admitting diagnosis set ?
.         IF        @EQUAL
.           MATCH     SP70,AMBS            * admitting mbs set ?
.           IF        @EQUAL
.             GOTO      VOEC9500
.           ENDIF
.         ENDIF
.
          MATCH     SP70,PMVXIDUS      * Intended stay (sameday) indicator set?
          IF        @EQUAL
            GOTO      VOEC9500
          ENDIF
.
          MATCH     SP70,PMVXPILC      * Presenting Illness Code CAT (il) ?
          IF        @EQUAL | @EOS
             MATCH     SP70,AMBS            * admitting mbs set ?
             IF        @EQUAL | @EOS
               GOTO      VOEC9500
             ENDIF
          ENDIF
.
          MOVE      AADMNO,KEY8
          CALL      RDPTELG1
          IF        OVRCD=1
            GOTO      VOEC9000
          ENDIF
.
          MATCH     "1",PTELCMPL          * eligibility Check Complete ?
          IF        @EQUAL
            GOTO      VOEC9500
          ENDIF
.
.         MATCH     SP70,PTELSPEA          * Pre-Existing Ailment indicator set?
.         IF        @EQUAL
.           GOTO      VOEC9500
.         ENDIF
.
.         MATCH     SP70,PMVXIDUS      * Intended stay (sameday) indicator set?
.         IF        @EQUAL
.           GOTO      VOEC9500
.         ENDIF
.
.         MATCH     SP70,PMVXPILC      * Presenting Illness Code CAT (il) ?
.         IF        @EQUAL
.           GOTO      VOEC9500
.         ENDIF
.
VOEC9000  MOVE      ONE,OECRFLAG            * send OEC
          GOTO      VOEC9999
.
VOEC9500  MOVE      ZERO,OECRFLAG           * don't send OEC
VOEC9999  RETURN
+
.******************************************************************************
.         Schedule OECs for selected visits (IBAPMS84)
.******************************************************************************
SOEC0000  MOVE      "IBAPMS84",SCHDPGID
          MOVE      "Health Fund Eligibility Check",SCHDDESC
          PACK      SCHDDATE,CCC,CYY,CMM,CDD
          REP       " 0",SCHDDATE
          CLOCK     TIME,SCHDTIME
          MOVE      "S  ",SCHDPRNT           * initialise to spool
          MATCH     SP70,SELPRINT
          IF        !@EQUAL
            MOVE      SELPRINT,SCHDPRNT      * printer code
          ENDIF
          MOVE      "IBAPMS84",SETDFPRG
          MOVE      "19",SETDFRPT
          CALL      SETDEF00                 * save default printer
.
.         Write Keyin parameters
.
          MOVE      ONE,TOTALCNT
          MOVE      "1",KEYSTARR[TOTALCNT]        * processing type 1
.
          ADD       ONE,TOTALCNT
          MOVE      OECRPRNT,KEYSTARR[TOTALCNT]   * print report flag (1=print)
.
          ADD       ONE,TOTALCNT
          MOVE      STARTLST,KEYSTARR[TOTALCNT]   * start date for report
.
          ADD       ONE,TOTALCNT
          MOVE      ENDOFLST,KEYSTARR[TOTALCNT]   * end date for report
.
          ADD       ONE,TOTALCNT
          MOVE      WBSEUID,KEYSTARR[TOTALCNT]    * User id
.
          ADD       ONE,TOTALCNT
          MOVE      FILTHOSP,KEYSTARR[TOTALCNT]   * hospital filter
.
          ADD       ONE,TOTALCNT
          MOVE      ONE,OECCOUNT                    * visit array counter
SOEC1000  MATCH     SP70,OECRECKY[OECCOUNT]
          GOTO      SOEC2000 IF EQUAL
.
          MOVE      OECRECKY[OECCOUNT],KEYSTARR[TOTALCNT]  * to be processed
          ADD       ONE,TOTALCNT
          ADD       ONE,OECCOUNT
          GOTO      SOEC1000
.
SOEC2000  PACK      KEYSTARR[TOTALCNT],SP70      * blank record to signal exit
.
          ADD       ONE,TOTALCNT
          PACK      KEYSTARR[TOTALCNT],SP70      * program exit
.
          MOVE      TOTALCNT,KEYSTCNT            * Number of Keyins
.
          CALL      SCHPRO00   * Schedule Extract
.
SOEC9999  RETURN
+
.------------------------------------------------------------
. Set Default Printer
.------------------------------------------------------------
SETDEF00  MOVE      PRGID,SAVPRGID
          MOVE      REPORTNO,SAVREPTN
.
          MOVE      SCHDPRNT,SELPRINT
          MOVE      SETDFPRG,PRGID
          MOVE      SETDFRPT,REPORTNO
          CALL      UPDFPT00
.
          MOVE      SAVPRGID,PRGID
          MOVE      SAVREPTN,REPORTNO
          RETURN
+
.------------------------------------------------------------
. Determine DOSA Status
.------------------------------------------------------------
DOSA0000  COMPARE   TWO,BKRESTAT
          GOTO      DOSA9000 IF EQUAL       * only show DOSA for non cancelled
.
          PACK      KEY31,BKREBOOK,SP70
          CALL      RSOPDEA2
          CALL      RKOPDEA2
          BRANCH    OVRCD,DOSA9000
.
          MATCH     DBKREBOO,OPDAADMN
          GOTO      DOSA9000 IF NOT EQUAL
.
          MATCH     "Y  ",OPDAUSR2
          GOTO      DOSA9000 IF NOT EQUAL
.
          MOVE      OPDAUSR2,DOSASTAT
          GOTO      DOSA9999
.
DOSA9000  MOVE      SP70,DOSASTAT
          CALL      CLOPRDEA                * clear oprdet variables
DOSA9999  RETURN
+
.-------------------------------------------------------------------------------
. Calculate Consecutive Leave Days
.-------------------------------------------------------------------------------
CNLV0000  MOVE      ZERO,CNLVDAYS
          MOVE      SP70,CNLVDATE
          MOVE      SP70,SVCNLVDT
          MOVE      SP70,SVCNLVTM
          MOVE      SP70,SVCNLVIN
          MOVE      ZERO,SVCNLVAN
.
          PACK      KEY30,DAADMNO,Z70
          CALL      RDSTRAN2
CNLV0010  CALL      RDPTRAN2
          BRANCH    OVRCD,CNLV9999
.
          MATCH     DAADMNO,DTADMN
          GOTO      CNLV9999 IF NOT EQUAL
.
          MATCH     "L",TMOVE
          IF        @EQUAL
            MOVE      TDATE,SVCNLVDT
            MOVE      TTIME,SVCNLVTM
.
            MATCH     SP70,PTTRLTYP
            IF        !@EQUAL & !@EOS
              PACK      KEY5,ANST,ANSL,PTTRLTYP,SP70
              CALL      RDCODE1
              IF        OVRCD=ZERO
                MOVE      TCFORM6,SVCNLVAN
              ENDIF
            ELSE
              MOVE    ZERO,SVCNLVAN
            ENDIF 
.
            GOTO      CNLV0010
          ENDIF
.
          MATCH     "R",TMOVE
          IF        @EQUAL
            MATCH     TDATE,SVCNLVDT
            IF        @EQUAL
              MOVE      SP70,DIM1
              MOVE      SP70,DIM2A
              MOVE      SP70,DIM2B
              UNPACK    TTIME,DIM2A,DIM1,DIM2B
              UNPACK    SVCNLVTM,DIM2C,DIM1,DIM2D
              MATCH     DIM2A,DIM2C
              IF        @EQUAL
                MOVE      ZERO,FORM2A
                MOVE      ZERO,FORM2B
                MOVE      ZERO,FORM2C
                SQUEEZE   DIM2B
                SQUEEZE   DIM2D
                MOVE      DIM2B,FORM2A
                MOVE      DIM2D,FORM2B
                ASSIGN    FORM2B-FORM2A,FORM2C
                IF        FORM2C=ONE
                  GOTO      CNLV0010
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          CALL       IBACLOCK
          PACK       KEY8,CC,YY,MM,DD,SP70
          REP        " 0",KEY8
          MATCH      SP70,SVCNLVDT
          GOTO       CNLV9999 IF EQUAL
          DAYSEP     SVCNLVDT,KEY8,CNLVDAYS
.
          MOVE       SP70,SVCNLVIN
          COMPARE    CNLVDAYS,SVCNLVAN
          IF         @LESS
            MOVE       "Red",SVCNLVIN
.           MOVE       ZERO,FORM6
.           MOVE       CNLVDAYS,FORM6
.           COMPARE    SVCNLVAN,FORM6
.           IF         @LESS
.             MOVE       SP70,SVCNLVIN
.           ENDIF
          ENDIF 
.
CNLV9999
+
.-------------------------------------------------------------------------------
. Calculate Consecutive Leave Days
.-------------------------------------------------------------------------------
FWBD0000  MOVE      SP70,WBEDTEXT
          MOVE      SP70,WARDTEXT
          MOVE      SP70,BEDTEXT
          MOVE      SP70,SAVWEXTN
          MATCH     SP70,KEY6
          GOTO      FWBD9999 IF EQUAL
.
          PACK      KEY8,WWARD,WBED,SP70   * save current patwr1af key
          UNPACK    KEY6,WARDKEY,BEDKEY
.
          IF        WBEDDESC = 0
            PACK      KEY6,WARDKEY,BEDKEY,SP70
            CALL      RDWARD1
            IF        OVRCD=0
              MOVE      WEXTN,SAVWEXTN
            ENDIF
.
            GOTO      FWBD5000
          ENDIF 
.
          PACK      KEY6,WARDKEY,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,FWBD5000
. 
          IF        WBEDDESC = 2
            PACK      WARDTEXT,PTWDSDES,SP70 
          ELSE
            PACK      WARDTEXT,WBDESC,SP70
          ENDIF 
          MOVE      WEXTN,SAVWEXTN
.
          MATCH     SP70,BEDKEY  
          GOTO      FWBD8000 IF EQUAL
          PACK      KEY6,WARDKEY,BEDKEY
          CALL      RDWARD1
          IF        OVRCD<>0
            APPEND    BEDKEY,BEDTEXT
            GOTO      FWBD8000
          ENDIF
          IF        WBEDDESC = 2
            APPEND    PTWDSDES,BEDTEXT
          ELSE
            APPEND    WBDESC,BEDTEXT
          ENDIF 
          MOVE      WEXTN,SAVWEXTN
          GOTO      FWBD8000
.
FWBD5000  MOVE      WARDKEY,WARDTEXT
          MATCH     SP70,BEDKEY
          GOTO      FWBD9000 IF EQUAL
          MOVE      BEDKEY,BEDTEXT
          GOTO      FWBD9000 
.
FWBD8000  PACK      KEY6,KEY8
          CALL      RDWARD1           * reset Ward file just in case
.
FWBD9000  CLEAR     WBEDTEXT
          STRIP     WARDTEXT
          APPEND    WARDTEXT,WBEDTEXT
.
          RESET     BEDTEXT
          MATCH     SP20,BEDTEXT
          IF        !@EQUAL
            APPEND    "/",WBEDTEXT
            APPEND    BEDTEXT,WBEDTEXT
          ENDIF
          RESET     WBEDTEXT
.
FWBD9999  RETURN
+
.------------------------------------------------------------
.   Language filter for interpreter
.------------------------------------------------------------
FILINT00  MATCH     SP70,PMPGI002           * filter on pref language 1
          IF        !@EQUAL
            MATCH     PMPXLNG1,PMPGI002
            GOTO      FILINT90 IF NOT EQUAL
          ENDIF
.
          IF        F1A=1
            MATCH     SP70,PMPGI065           * filter on nationality
            IF        !@EQUAL
              MATCH     PMPXABRG,PMPGI065
              GOTO      FILINT90 IF NOT EQUAL
            ENDIF
          ELSE
            MATCH     SP70,PMPGI003           * filter on pref language 2
            IF        !@EQUAL
              MATCH     PMPXLNG2,PMPGI003
              GOTO      FILINT90 IF NOT EQUAL
            ENDIF
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      FILINT99
.
FILINT90  MOVE      ONE,EXIT
          GOTO      FILINT99
.
FILINT99  RETURN
.------------------------------------------------------------
.   Language filter
.------------------------------------------------------------
LNGFLT00  MATCH     SP70,PREFLANG           * filter on pref language 1
          GOTO      LNGFLT50 IF EQUAL
          MATCH     PMPXLNG1,PREFLANG
          GOTO      LNGFLT50 IF EQUAL
          MATCH     PMPXLNG2,PREFLANG
          GOTO      LNGFLT50 IF EQUAL
          MATCH     PMPXLNG3,PREFLANG
          GOTO      LNGFLT90 IF NOT EQUAL
.
LNGFLT50
          MOVE      ZERO,EXIT
          GOTO      LNGFLT99
.
LNGFLT90  MOVE      ONE,EXIT
          GOTO      FILTER99
.
LNGFLT99  RETURN
.------------------------------------------------------------
.Table of Patient Oncology Bookings
.------------------------------------------------------------
TOPO0000  CALL      TABHED00                             *Table heading
.
          MOVE     "patweb89",LINKPRG
          MOVE     "01",LINKREP
          MOVE     "020",LINKTEM
.
          PACK      CURRDATE,CCC,CYY,CMM,CDD     * current date
          REP       " 0",CURRDATE
.
          PACK      KEY16,FRSTDATE,SP70
          CALL      RSBKREC4                             *Read booking file
TOPO1000  CALL      RKBKREC4
          BRANCH    OVRCD,TOPO9000
.
          PACK      KEY8,DBKREBOO,SP70
          CALL      RDBKRX11
          BRANCH    OVRCD,TOPO1000
.
          MATCH     BKREEDAT,LASTDATE
          GOTO      TOPO9000 IF LESS
.
          IF        BKRESTAT=2
            GOTO      TOPO1000
          ENDIF
.
          IF        BKRESTAT=1
            MOVE     "patweb89",LINKPRG
            MOVE     "04",LINKREP
            MOVE     "002",LINKTEM
          ENDIF
.
          IF        BKRESTAT=3|BKRESTAT=4
            MOVE     "patweb98",LINKPRG
            MOVE     "01",LINKREP
            MOVE     "002",LINKTEM
          ENDIF
.
          MATCH     SP70,UNITCODE
          IF        !@EQUAL
            MATCH     BKREDEPT,UNITCODE
            GOTO      TOPO1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,ADPOINTS
          IF        !@EQUAL
            MATCH     BKRXADWD,ADPOINTS
            GOTO      TOPO1000 IF NOT EQUAL
          ENDIF
.
          MATCH     WARDCODE,SP70
          IF        !@EQUAL
            MATCH     BKREWARD,WARDCODE
            GOTO      TOPO1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTWARD
          IF        !@EQUAL
            MATCH     BKRXPOWD,FILTWARD
            GOTO      TOPO1000 IF NOT EQUAL
          ENDIF
.
          PACK      KEY5,ANSB,ANSK,BKRETYPE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,TOPO1000
.
          MATCH     "O",TCINDC1
          GOTO      TOPO1000 IF NOT EQUAL
.
          MOVE      BKREURNO,URNUMBER
          MOVE      BKREBOOK,ADMISSNO
.
          PACK      KEY8,BKREURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,TOPO1000
          CALL      RDPMPX21
.
          CALL      GETPAT00
          CALL      PATLN000
.
          PACK      KEY18,BKREBOOK,SP70
          CALL      RSBKDIA1
          CALL      RKBKDIA1
          IF        OVRCD=0
            MATCH     BKREBOOK,BKDIBOOK
            GOTO      TOPO2000 IF EQUAL
          ENDIF
.
          MOVE      SP70,BKDIDES1
          MOVE      SP70,BKDIDES2
.
TOPO2000  MOVE      SP70,PATUNT01
          MOVE      "AC",CATEGORY
          MOVE      BKREDEPT,CODE
          CALL      GETCOD00
          MOVE      TDESC,PATUNT01
.
          MOVE      SP70,DRORDESC
          MOVE      "Ba",CATEGORY
          MOVE      BKRXDROR,CODE
          CALL      GETCOD00
          MOVE      TDESC,DRORDESC
.
          MOVE      SP70,APOIDESC
          MOVE      "ap",CATEGORY 
          MOVE      BKRXADWD,CODE
          CALL      GETCOD00
          MOVE      TDESC,APOIDESC
.
          MOVE      SP70,EXPTWTXT
          PACK      KEY6,BKREWARD,SP70
          CALL      FWBD0000
          MOVE      WARDTEXT,EXPTWTXT  
.
          MOVE      SP70,POSTWTXT
          PACK      KEY6,BKRXPOWD,SP70
          CALL      FWBD0000
          MOVE      WARDTEXT,POSTWTXT
.                                           * Get care type colour code
          PACK      DISPCLSS,SP20
          IF        BKRESTAT = 0 | BKRESTAT = 1 | BKRESTAT = 3
            PACK      DIM1,SP20
            PACK      KEY5,ANSC,ANSC,BKREEATY,SP70         * CAR 305377
            CALL      RDCODE1
            IF        OVRCD<>1
              UNPACK      TCINDC21,DIM1
            ENDIF
            MATCH     DIM1,SP70
            IF        !@EQUAL
              PACK      DISPCLSS,ONCLCLSS,DIM1,SP70
            ENDIF
            SQUEEZE   DISPCLSS
          ENDIF
.
          MOVE      SP70,DOCFNAME
          MOVE      SP70,KEY6
.
          IF        BKRESTAT=0
            MOVE      BKREADOC,KEY6
          ENDIF
.
          IF        BKRESTAT=1 | BKRESTAT=3 | BKRESTAT=4
            PACK      KEY8,DBKREBOO,SP70
            CALL      RDAMISS1
            IF        OVRCD=0
              MOVE      ADOCTA,KEY6
            ENDIF
          ENDIF
.
          MATCH     SP70,KEY6
          IF        !@EQUAL
            CALL      RDDOCT1
            IF        OVRCD=0
              MOVE      DTITL,FMTTITLE 
              MOVE      DGNAME,FMTGNAME
              MOVE      DSNAME,FMTSNAME
              CALL      DOCNM000
            ENDIF
          ENDIF
.
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
.
          CLEAR     PATLINK
          APPEND    LINKPRG,PATLINK
          APPEND    ".pbl?reportno=",PATLINK
          APPEND    LINKREP,PATLINK
          APPEND    "&template=",PATLINK
          APPEND    LINKTEM,PATLINK
          APPEND    "&urnumber=",PATLINK
          APPEND    URNUMBER,PATLINK
          APPEND    "&admissno=",PATLINK
          APPEND    ADMISSNO,PATLINK
          RESET     PATLINK
.
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
          WRITE     HTMLFILE;"t.addRow(#"",FORMATNM,"#",":
                             "#"javascript:LinkPatient('",PATLINK,"');#",";
.
          CALL      PATFLD00
.
          WRITE     HTMLFILE;"#"",KEY3,"#",":
                             "#"",BKREEDAT,BKREATIM,"#",":
                             "#"",DISPSEX,"#",":
                             "#"",PBDATE,"#",":
                             "#"",BKDIDES1,SP1,BKDIDES2,SP1,"#",":
                             "#"";
          CALL      LRGM0000
          WRITE     HTMLFILE;"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",PATUNT01,"#",":
                             "#"";
.         WRITE     HTMLFILE;DRORDESC;
          CALL      DRUGSL00
          WRITE     HTMLFILE;"#",":
                             "#"",SP1,"#",":
                             "#"",DISPCLSS,"#");"
.
          GOTO      TOPO1000
.
TOPO9000
TOPO9999  RETURN
.------------------------------------------------------------
. Drug Orders Selection List (with booking number)         
.------------------------------------------------------------
DRUGSL00  MOVE      "Ba",CATEGORY
          MOVE      BKRXDROR,CODE
.
          WRITE     HTMLFILE;"<select onchange='submitDrugs(this);'>":
                             "<option value='   ",BKRXBNUM,"'></option>";
.
          PACK      PTCDKEY2,CATEGORY,SP70
          CALL      RDSCODE2 
DRUGSL10  CALL      RDKCODE2
          BRANCH    OVRCD,DRUGSL90
.
          MATCH     CATEGORY,TCODE
          GOTO      DRUGSL90 IF NOT EQUAL
.
          MATCH     SP70,ACODE
          GOTO      DRUGSL10 IF EQUAL
.
          MATCH     CODE,ACODE
          IF        @EQUAL
            IF        CATACTIV=1
              MATCH     "I",PTCOACTV               * Display active only
              GOTO      DRUGSL10 IF EQUAL
            ENDIF
.
            WRITE     HTMLFILE;"<option value=#'",ACODE,BKRXBNUM,"#' selected>":
                               TDESC,"</option>";
          ELSE
            MATCH     "I",PTCOACTV
            GOTO      DRUGSL10 IF EQUAL
.
            IF        IBCNMHOS=1
              MATCH    "1",PTCDHOSS
              IF       @EQUAL
                PACK     KEY8,WBSEHOSP,TCODE,ACODE,SP70
                CALL     RDMLCOD1
                BRANCH   OVRCD,DRUGSL10
              ENDIF
            ENDIF
.
            WRITE     HTMLFILE;"<option value=#'",ACODE,BKRXBNUM,"#'>",TDESC:
                               "</option>";
          ENDIF
.
          GOTO      DRUGSL10
.
DRUGSL90  WRITE     HTMLFILE;"</select>";
.
DRUGSL99  RETURN
.
.------------------------------------------------------------
. List of Patient Regimes
.------------------------------------------------------------
LRGM0000  MOVE      ZERO,REGCOUNT
          PACK      KEY10,ADMISSNO,SP70
          CALL      RSPTRGM1
LRGM1000  CALL      RKPTRGM1
          BRANCH    OVRCD,LRGM9999
.
          MATCH     ADMISSNO,PTRGADMN
          GOTO      LRGM9999 IF NOT EQUAL
.
          MOVE      PTRGREGM,PMREREGM
          PACK      KEY13,PTRGREGM,SP1,SP1,ZERO,SP70
          CALL      RDPMREG1
          BRANCH    OVRCD,LRGM9999
.
          IF        REGCOUNT=1|REGCOUNT=2
            WRITE     HTMLFILE;"<br>";
          ENDIF
.
          WRITE     HTMLFILE;PMREDESC;
          ADD       ONE,REGCOUNT
.
          IF        REGCOUNT=3
            GOTO      LRGM9999
          ENDIF
.
          GOTO      LRGM1000
.
LRGM9999  RETURN
.
.-----------------------------------------------------------
.        Get Patient Attributes
.-----------------------------------------------------------
PATATR00  MOVE      SP70,BMIINDIC
.
          MATCH     SP70,URNUMBER
          GOTO      PATATR99 IF EQUAL
          GOTO      PATATR99 IF EOS
.
.         MATCH     SP70,ADMISSNO
.         GOTO      PATATR99 IF EQUAL
.         GOTO      PATATR99 IF EOS
.
          PACK      KEY35,URNUMBER,Z70
          CALL      RSPTATR1
PATATR10  CALL      RPPTATR1
          BRANCH    OVRCD,PATATR90
.
          MATCH     URNUMBER,PTARURNO
          GOTO      PATATR90 IF NOT EQUAL
.
.         MATCH     ADMISSNO,PTARVISN
.         GOTO      PATATR90 IF NOT EQUAL
.
          MATCH     "1",PTARDELR
          GOTO      PATATR10 IF EQUAL
.
          MOVE      "1",BMIINDIC
.
          GOTO      PATATR99
.
PATATR90  CALL      CLPATATR
PATATR99  RETURN
.------------------------------------------------------------------------
.  Format hospital text  HOSPTEXT According to the
.  PTCNWBDS parameter (code, long name,short name)
.------------------------------------------------------------------------
FHOS0000  PACK      HOSPTEXT,SP70
          CLEAR     HOSPTEXT
          MATCH     KEY3,SP3
          GOTO      FHOS9999 IF EQUAL
          IF        IBCNMHOS <> 1
                 GOTO      FHOS9999
          ENDIF
          MOVE      PTCNWBDS,F1  * name option none,long,short
          CALL      RDPTHSP1
          IF        OVRCD = 1 | F1 = 0
            APPEND    KEY3,HOSPTEXT         * Hospital code
.           APPEND    DASH,HOSPTEXT
          ELSE
            IF       F1 = 2
              STRIP    PTHSSNAM
              APPEND   PTHSSNAM,HOSPTEXT    * Hospital short name
            ELSE
              STRIP    PTHSNAME
              APPEND   PTHSNAME,HOSPTEXT    * Hospital long name
            ENDIF
          ENDIF
          RESET      HOSPTEXT
          STRIP      HOSPTEXT
FHOS9999  RETURN
+
.-----------------------------------------------------------
.        Get All Diet Types for Admission by Diet Screen
.-----------------------------------------------------------
CADT0000  IF        HEAVIEW=1
            CALL      IBACLOCK
            PACK      KEY8,CCC,CYY,CMM,CDD
            REP       " 0",KEY8
            PACK      KEY16,AADMNO,KEY8
            CALL      RDPMNUT1
            IF        OVRCD=1
              CALL      RPPMNUT1
              IF        OVRCD=1
                CALL      CLPMSNUT
              ELSE
                MATCH       PMNUADMN,DAADMNO
                IF          !@EQUAL
                  CALL         CLPMSNUT
                ENDIF
              ENDIF
            ENDIF
.
            MOVE      PMNUDIET,KEY3
            MOVE      PMNUML01,KEY3A
            MOVE      PMNUML03,KEY3B
            MOVE      PMNUML05,KEY3C
            MOVE      PMNUML07,KEY3D
            MOVE      SP70,KEY3E
.
          ELSE
            CALL      IBACLOCK
            PACK      KEY8,CCC,CYY,CMM,CDD
            REP       " 0",KEY8
            PACK      KEY16,AADMNO,KEY8
            CALL      RDPMNUT1
            IF        OVRCD=1
              CALL      RPPMNUT1
              IF        OVRCD=1
                CALL      CLPMSNUT
              ELSE
                MATCH       PMNUADMN,DAADMNO
                IF          !@EQUAL
                  CALL         CLPMSNUT
                ENDIF
              ENDIF
            ENDIF
.
            MOVE      ADIET,KEY3
            MOVE      PMNUDIET,KEY3A
            MOVE      PMNUML01,KEY3B
            MOVE      PMNUML03,KEY3C
            MOVE      PMNUML05,KEY3D
            MOVE      PMNUML07,KEY3E
.
          ENDIF
.
CADT9999  RETURN
.
.----------------------------------------------------------------------
.        Get All matching Completed Menus  for Admission by Diet Screen
.----------------------------------------------------------------------
CACM0000  MOVE      ZERO,EXIT
          MOVE      SP70,KEY3A
.
          CALL      IBACLOCK
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
.
          PACK      KEY17,AADMNO,KEY8,SP70
          CALL      RSCTCOM1
CACM0100  CALL      RKCTCOM1
          BRANCH    OVRCD,CACM9000
.
          MATCH     AADMNO,CTCOADMN
          GOTO      CACM9000 IF NOT EQUAL
.
          MATCH     KEY8,CTCODATE
          GOTO      CACM9000 IF NOT EQUAL
.
          MOVE      CTCOIT01,KEY3A
          MATCH     KEY3A,SRCHCODE
          GOTO      CACM9999 IF EQUAL
.
          MOVE      CTCOIT02,KEY3A
          MATCH     KEY3A,SRCHCODE
          GOTO      CACM9999 IF EQUAL
.
          MOVE      CTCOIT03,KEY3A
          MATCH     KEY3A,SRCHCODE
          GOTO      CACM9999 IF EQUAL
.
          MOVE      CTCOIT04,KEY3A
          MATCH     KEY3A,SRCHCODE
          GOTO      CACM9999 IF EQUAL
.
          MOVE      CTCOIT05,KEY3A
          MATCH     KEY3A,SRCHCODE
          GOTO      CACM9999 IF EQUAL
.
          GOTO      CACM0100
.
CACM9000  MATCH     KEY3,SRCHCODE
          GOTO      CACM9999 IF EQUAL
.
          MOVE      ONE,EXIT
.
CACM9999  RETURN
+
.------------------------------------------------------------
.         Pre-assessment History
.------------------------------------------------------------
PREHIS00  PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,PREHIS90
          CALL      RDPMPX21
.
          CLEAR     WEBTITLE
          MOVE      TITLE12,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,PREHIS99
.
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
.
          GOTO      PREHIS99
.
PREHIS90  MOVE      "Invalid UR number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PREHIS99
.
PREHIS99  RETURN
+
.------------------------------------------------------------
.         ACC List
.------------------------------------------------------------
ACCLST00  MOVE      "ACC List",WEBTITLE
          CALL      CURPER00
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.
          RESET     UPDTTYPE
          MATCH     SP70,UPDTTYPE
          GOTO      ACCLST70 IF EQUAL
.
          MATCH     "U",UPDTTYPE
          GOTO      ACCLST30 IF EQUAL
.
          GOTO      ACCLST91
.
ACCLST30  CALL      UPDACC00      * Update ACC Status
          IF        PTCNHDPS=1            
            CALL      MVACCSTS
          ENDIF
          IF        NEXTPAGE=1
            CALL      WINCLS00
          ENDIF
          GOTO      ACCLST99

ACCLST70  MOVE      ADMISSNO,KEY8
          CALL      RDWCOM1
          IF        OVRCD=1
            CALL      CLPATWC1
          ENDIF
.
          CALL      RDPMWX11
          IF        OVRCD=1
            CALL      CLPMSWX1
          ENDIF
.
          CALL      GETPAT00      * Get Patient Details
          CALL      PATNME00
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,ACCLST99
.
          CALL      WEBBOD00   * Process Web Body
.
          CALL      WEBEND00   * Process End of HTML File
          GOTO      ACCLST99
.
ACCLST91  MOVE      "Invalid Update Type",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ACCLST99
.
ACCLST99  RETURN
+
.------------------------------------------------------------------------------
.         Update ACC Status (Workers Compensation extension record)
.------------------------------------------------------------------------------
UPDACC00  PACK      KEY44,CLAIMNUM,SP70
          CALL      RDSWCOM3
UPDACC10  CALL      RDKWCOM3
          BRANCH    OVRCD,UPDACC99
.
          MATCH     WCCLMNO,CLAIMNUM
          GOTO      UPDACC90 IF NOT EQUAL
.
          MATCH     PTWCURNO,URNUMBER
          GOTO      UPDACC90 IF NOT EQUAL
.
          MOVE      DWCADMNO,KEY8
          CALL      RDPMWX11
          BRANCH    OVRCD,UPDACC10
.
          MOVE      CLAIMSTA,PMWXCSTA
          CALL      UPPMWX11
.
          GOTO      UPDACC10
.
UPDACC90  MOVE      ZERO,EXIT
          GOTO      UPDACC99
.
UPDACC99  RETURN
+
.------------------------------------------------------------
.  Update ACCAUDFD file for ACC Status Change
.------------------------------------------------------------
MVACCSTS  CALL      CLACCAUD
.
          MATCH     CLAIMNUM,Z70
          IF        !@EQUAL
            MOVE      CLAIMNUM,ACAUCLMN
          ENDIF
.
          MATCH     ADMISSNO,Z70
          IF        !@EQUAL
            MOVE      ADMISSNO,ACAUADMN
          ENDIF
.
          CALL      IBACLOCK
          PACK      ACAUDATE,CCC,CYY,CMM,CDD        * Date
          REP       " 0",ACAUDATE
          MOVE      CTIMEIS,ACAUTIME
          MOVE      USERID,ACAUWUID                 * Web UserId
.
          MOVE      "U",ACAUAUTY                    * Audit Type for ADD
          MOVE      "A",ACAUTREC                    * ACC Type of Record
.
          PACK      KEY54,ACAUCLMN,ACAUADMN,ACAUDATE,ACAUTIME,ACAUWUID
          CALL      RAACAUD1
          IF        OVRCD=1
            CALL      WRACAUD1
          ENDIF
.
MVACCW99  RETURN
.
.------------------------------------------------------------
. Format Patient Name <b>SURNAME</b>, Title Given Names
.------------------------------------------------------------
PATNME00  CLEAR     DISPNAME
          REP       "#" ",PSNAME
          REP       "#" ",PTMASNAM
          REP       "#" ",PGNAME
          MOVE      SP70,PATFNAME
          REP       UPPLOW,PSNAME
          REP       UPPLOW,PTMASNAM
          APPEND    "<b>",DISPNAME
          MATCH     SP70,PTMASNAM
          IF        !@EQUAL
            STRIP     PTMASNAM
            APPEND    PTMASNAM,DISPNAME
          ELSE
            STRIP     PSNAME
            APPEND    PSNAME,DISPNAME
          ENDIF
          APPEND    "</b>,&nbsp;",DISPNAME
          PACK      NAME35,PTITL,SP70
          CALL      NAMSTR00
          STRIP     PGNAME
          PACK      NAME35,PGNAME,SP70
          STRIP     NAME35
          CALL      NAMSTR00
          APPEND    SP70,DISPNAME
          RESET     DISPNAME
          MOVE      DISPNAME,PATFNAME
          STRIP     PATFNAME
.
          PACK      PTMASNAM,PTMASNAM,SP70       * Set name field back to
          PACK      PSNAME,PSNAME,SP70           * full length
          PACK      PGNAME,PGNAME,SP70
.
PATNME99  RETURN
+
.-------------------------------------------------------------
.  Report 20 - ACC tags
.-------------------------------------------------------------
ACCT0000  BRANCH    FLDITMNO,ACCT0100,ACCT0200,ACCT0300,ACCT0400,ACCT0500:
                             ACCT0600,ACCT0700,ACCT0800,ACCT0900,ACCT1000:
                             ACCT1100
          GOTO      ACCT9999
.
ACCT0100  CALL      PACC0000                * Parked ACC List
          GOTO      ACCT9999
.
ACCT0200  WRITE     HTMLFILE;FILTSTAT;      * List Status filter value
          GOTO      ACCT9999
.
ACCT0300  WRITE     HTMLFILE;PTWCURNO;      * UR Number
          GOTO      ACCT9999
.
ACCT0400  WRITE     HTMLFILE;WCADMNO;       * Admission Number
          GOTO      ACCT9999
.
ACCT0500  WRITE     HTMLFILE;WCCLMNO;       * ACC Claim Number
          GOTO      ACCT9999
.
ACCT0600  WRITE     HTMLFILE;PMWXCSTA;      * Claim Status
          GOTO      ACCT9999
.
ACCT0700  WRITE     HTMLFILE;PATFNAME;      * Patient Full Name
          GOTO      ACCT9999
.
ACCT0800  CALL      ACCAUD00                * ACC Audit List
          GOTO      ACCT9999
.
ACCT0900  WRITE     HTMLFILE;AUDITTYP;     
          GOTO      ACCT9999
.
ACCT1000  WRITE     HTMLFILE;ACCTYREC;     
          GOTO      ACCT9999
.
ACCT1100  WRITE     HTMLFILE;REDIRECT;      * Redirect URL
          GOTO      ACCT9999
.
ACCT9999  RETURN
+
.-------------------------------------------------------------
.  Report 21 - Pre-assessment History
.-------------------------------------------------------------
PHIS0000  BRANCH    FLDITMNO,PHIS0100,PHIS0200
          GOTO      PHIS9999
.
PHIS0100  CALL      PRHIST00                * Pre-assessment History table sort
          GOTO      PHIS9999
.
PHIS0200  CALL      PHLIST00                * Pre-assessment History audit list
          GOTO      PHIS9999
.
PHIS9999  RETURN
+
.-------------------------------------------------------------
.  Pre-assessment History audit list
.-------------------------------------------------------------
PHLIST00  PACK      KEY35,URNUMBER,ADMISSNO,ATYPE030,Z70
          CALL      RSPTATR3
PHLIST10  CALL      RPPTATR3
          BRANCH    OVRCD,PHLIST99
.
          MATCH     URNUMBER,PTARURNO
          GOTO      PHLIST99 IF NOT EQUAL
          MATCH     ADMISSNO,PTARVISN
          GOTO      PHLIST99 IF NOT EQUAL
          MATCH     ATYPE030,PTARTYPE
          GOTO      PHLIST99 IF NOT EQUAL
.
          MOVE      SP70,KEY11
          MATCH     SP70,PTARDATE
          IF        !@EQUAL
            UNPACK    PTARDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MOVE      SP70,DIM11
          MATCH     SP70,PTARCDTE
          IF        !@EQUAL
            UNPACK    PTARCDTE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DIM11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MOVE      SP70,D11
          MATCH     SP70,PTARUDTE
          IF        !@EQUAL
            UNPACK    PTARUDTE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      D11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MOVE      SP70,TDESC
          MATCH     SP70,PTARCOD1
          IF        !@EQUAL
            PACK      KEY5,ANSB,ANSG,PTARCOD1,SP70
            CALL      RDCODE1
          ENDIF
.
          MOVE      SP70,KEY30
          MATCH     SP70,PTARCUSR                 * Web User Created By
          IF        !@EQUAL
            PACK      KEY10,PTARCUSR,SP70
            CALL      RDWBSE1
            IF        OVRCD<>1
              MOVE      WBSENAM,KEY30
            ELSE
              MOVE      PTARCUSR,KEY30
            ENDIF
          ENDIF
.
          MOVE      SP70,KEY31
          MATCH     SP70,PTARUUSR                 * Web User Updated By
          IF        !@EQUAL
            PACK      KEY10,PTARUUSR,SP70
            CALL      RDWBSE1
            IF        OVRCD<>1
              MOVE      WBSENAM,KEY31
            ELSE
              MOVE      PTARUUSR,KEY31
            ENDIF
          ENDIF
.
PHLIST80  WRITE     HTMLFILE;"<tr>":
                    "<td>",KEY11," at ",PTARTIME,"</td>":
                    "<td>",TDESC,"</td>":
                    "<td>"
.
          PACK      SP80,SP70,SP70
          MATCH     SP80,PTARTXT1
          IF        !@EQUAL
            WRITE     HTMLFILE;PTARTXT1;
          ENDIF
          MATCH     SP80,PTARTXT2
          IF        !@EQUAL
            WRITE     HTMLFILE;"<br>",PTARTXT2;
          ENDIF
          MATCH     SP80,PTARTXT3
          IF        !@EQUAL
            WRITE     HTMLFILE;"<br>",PTARTXT3;
          ENDIF
          MATCH     SP80,PTARTXT4
          IF        !@EQUAL
            WRITE     HTMLFILE;"<br>",PTARTXT4;
          ENDIF
.
          WRITE     HTMLFILE;"</td>":
                    "<td>",KEY30,"</td>":
                    "<td>",DIM11," at ",PTARCTME,"</td>":
                    "<td>",KEY31,"</td>":
                    "<td>",D11," at ",PTARUTME,"</td>":
                    "</tr>"
          GOTO      PHLIST10
.
PHLIST99  RETURN
+
.-------------------------------------------------------------
.  Pre-assessment History table sort
.-------------------------------------------------------------
PRHIST00  CALL      TABHED00
          PACK      KEY35,URNUMBER,ADMISSNO,ATYPE030,Z70
          CALL      RSPTATR3
PRHIST10  CALL      RPPTATR3
          BRANCH    OVRCD,PRHIST99
.
          MATCH     URNUMBER,PTARURNO
          GOTO      PRHIST99 IF NOT EQUAL
          MATCH     ADMISSNO,PTARVISN
          GOTO      PRHIST99 IF NOT EQUAL
          MATCH     ATYPE030,PTARTYPE
          GOTO      PRHIST99 IF NOT EQUAL
.
          MOVE      SP70,TDESC
          MATCH     SP70,PTARCOD1
          IF        !@EQUAL
            PACK      KEY5,ANSB,ANSG,PTARCOD1,SP70
            CALL      RDCODE1
          ENDIF
.
          PACK      SP320,SP70,SP70,SP70,SP70,SP70
          PACK      DIM320,SP70,SP70,SP70,SP70,SP70
          PACK      DIM320,PTARTXT1,PTARTXT2,PTARTXT3,PTARTXT4
          MATCH     DIM320,SP320
          IF        @EQUAL
            MOVE      "0",CMNTSFLG
          ELSE
            MOVE      "1",CMNTSFLG
          ENDIF
.
          MOVE      SP70,KEY30
          MATCH     SP70,PTARCUSR                 * Web User Created By
          IF        !@EQUAL
            PACK      KEY10,PTARCUSR,SP70
            CALL      RDWBSE1
            IF        OVRCD<>1
              MOVE      WBSENAM,KEY30
            ELSE
              MOVE      PTARCUSR,KEY30
            ENDIF
          ENDIF
.
          MOVE      SP70,KEY31
          MATCH     SP70,PTARUUSR                 * Web User Updated By
          IF        !@EQUAL
            PACK      KEY10,PTARUUSR,SP70
            CALL      RDWBSE1
            IF        OVRCD<>1
              MOVE      WBSENAM,KEY31
            ELSE
              MOVE      PTARUUSR,KEY31
            ENDIF
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:UpdatePreAssessment('",HTMLLINK
          APPEND    ADMISSNO,HTMLLINK
          APPEND    "','",HTMLLINK
          UNPACK    PTARDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          APPEND    KEY11,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PTARTIME,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PTARDELR,HTMLLINK
          APPEND    "');",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",FORMATNM,"#",";
          WRITE     HTMLFILE;"#"",PTARDATE,PTARTIME,"#",";                 * 1
          WRITE     HTMLFILE;"#"",TDESC,"#",";                             * 2
.
          MATCH     "1",CMNTSFLG
          IF        @EQUAL
            WRITE     HTMLFILE;"#"",PTARTXT1,"<br>":                       * 3
                                  PTARTXT2,"<br>":
                                  PTARTXT3,"<br>":
                                  PTARTXT4,"<br>","#",";
          ELSE
            WRITE    HTMLFILE;"#"","&nbsp;","#",";
          ENDIF
.
          WRITE     HTMLFILE;"#"",KEY30,"#",";                             * 4
          WRITE     HTMLFILE;"#"",PTARCDTE,PTARCTME,"#",";                 * 5
          WRITE     HTMLFILE;"#"",KEY31,"#",";                             * 6
          WRITE     HTMLFILE;"#"",PTARUDTE,PTARUTME,"#",";                 * 7
          WRITE     HTMLFILE;"#"",HTMLLINK,"#");";                         * 8
          GOTO      PRHIST10
.
PRHIST99  RETURN
+
.-------------------------------------------------------------
.  Parked ACC List      
.-------------------------------------------------------------
PACC0000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          MATCH     SP1,FILTSTAT            * No Status filter?
          IF        @EQUAL
            MOVE      ONE,FILTSTAT          * Default to "Parked"
          ENDIF
.
          PACK      KEY17,FILTSTAT,SP70
          CALL      RSPMWX12
PACC1000  CALL      RKPMWX12                     * Loop worked comp by status
          BRANCH    OVRCD,PACC9999
.
          MATCH     FILTSTAT,PMWXCSTA            * Parked
          GOTO      PACC9999 IF NOT EQUAL
.
          MOVE      PMWXVISN,ADMISSNO            * Save visit number
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDWCOM1                      * Read workers comp record
          BRANCH    OVRCD,PACC1000
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMVX11                     * Read visit ext
          BRANCH    OVRCD,PACC2000          
.
          IF        IBCNMHOS=1
            MATCH     WBSEHOSP,PMVXMHOS          * Skip if not my hospital
            GOTO      PACC1000 IF NOT EQUAL
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDVISA1
          BRANCH    OVRCD,PACC2000               * Read visit to get U/R
.
          MOVE      PVIURNO,URNUMBER             * Save U/R Number
          GOTO      PACC6000
.
PACC2000  PACK      KEY8,ADMISSNO,SP70
          CALL      RDBKREC1
          BRANCH    OVRCD,PACC3000
.
          MOVE      BKREURNO,URNUMBER            * Save U/R Number
          GOTO      PACC6000
.
PACC3000  PACK      KEY36,ADMISSNO,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,PACC4000
.
          MATCH     ADMISSNO,DOBAOUTN
          GOTO      PACC4000 IF NOT EQUAL
.
          MOVE      OBAURNO,URNUMBER            * Save U/R Number
          GOTO      PACC6000
.
PACC4000  PACK      KEY19,PTWCURNO,SP70
          CALL      RDSTREA1
PACC4100  CALL      RDKTREA1
          BRANCH    OVRCD,PACC1000
.
          MATCH     WMURNO,PTWCURNO
          GOTO      PACC1000 IF NOT EQUAL
.
          MOVE      WMBOOK,VISITNUM
          MATCH     VISITNUM,PMWXVISN
          GOTO      PACC4100 IF NOT EQUAL
.
          MOVE      PTWCURNO,URNUMBER
          GOTO      PACC6000
.
PACC6000  PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,PACC1000
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,PACC1000
.
          UNPACK    PBDATE,CDAY,CMON,CYEAR,CCENT
          CALL      IBACLOCK
          IF        PCEASE=1
            MOVE      PDECDTE,AGEDATE            * Date of Death
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
          CALL      PATLN000               * Patent Name format
          CALL      PATFLD00               *Returns KEY3 for folder colour code
.
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
.
          CLEAR     PATLINK
          APPEND    LINKPRG,PATLINK
          APPEND    ".pbl?reportno=",PATLINK
          APPEND    LINKREP,PATLINK
          APPEND    "&template=",PATLINK
          APPEND    LINKTEM,PATLINK
          APPEND    "&urnumber=",PATLINK
          APPEND    URNUMBER,PATLINK
          APPEND    "&admissno=",PATLINK
          APPEND    ADMISSNO,PATLINK
          RESET     PATLINK
.
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
          CLEAR     UPDLINK
          APPEND    "javascript:EditStatus('",UPDLINK
          APPEND    URNUMBER,UPDLINK
          APPEND    "','",UPDLINK
          APPEND    ADMISSNO,UPDLINK
          APPEND    "')",UPDLINK
          RESET     UPDLINK
.
          MOVE      SP70,DOCFNAME
          PACK      KEY6,PMWXTPRO,SP70
          CALL      RDDOCT1
            IF        OVRCD<>1       
            MOVE      DTITL,FMTTITLE
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000
          ENDIF
.
          PACK      SAVDATA1,SP70,SP70,SP70
.
          PACK      KEY26,WCCLMNO,ZERO,ZERO,ONE,SP1,SP1,ONE,SP70
          CALL      RDACCMT1
          BRANCH    OVRCD,PACC7000
.
          MATCH     WCCLMNO,ACCMACCN
          GOTO      PACC7000 IF NOT EQUAL
.
          STRIP     ACCMDATA
          CLEAR     SAVDATA1
          APPEND    ACCMDATA,SAVDATA1
          CALL      RKACCMT1
          BRANCH    OVRCD,PACC7000
.
          MATCH     WCCLMNO,ACCMACCN
          GOTO      PACC7000 IF NOT EQUAL
.
          MATCH     "001",ACCMTYPE
          GOTO      PACC7000 IF NOT EQUAL
.
          ENDSET    SAVDATA1
          APPEND    SP1,SAVDATA1
          STRIP     ACCMDATA
          ENDSET    SAVDATA1
          APPEND    ACCMDATA,SAVDATA1
.
PACC7000  MOVE      ZERO,F1
          MOVE      WCESTAT0,WCSTDESC
.
          MOVE      PMWXCSTA,F1
          LOAD      WCSTDESC,F1,WCESTAT1,WCESTAT2,WCESTAT3
.
          WRITE     HTMLFILE;"t.addRow(#"",FORMATNM,"#",":     * 0
                             "#"",KEY3,"#",":                  * 1
                             "#"",WCCLMNO,"#",":               * 2 
                             "#"",WCACDAT,"#",":               * 3
                             "#"",PMWXADTE,"#",":              * 4 
                             "#"",DOCFNAME,"#",":              * 5
                             "#"",SAVDATA1,"#",":              * 6
                             "#"",PATLINK,"#",":               * 7
                             "#"",ADMISSNO,"#",":              * 8
                             "#"",URNUMBER,"#",":              * 9
                             "#"",WCSTDESC,"#",":              * 10
                             "#"",PMWXCSTA,"#",":              * 11
                             "#"",UPDLINK,"#");"               * 12
.
          GOTO      PACC1000
.
PACC9999  RETURN
+
.------------------------------------------------------------
. ACC Audit Details for ACC Number
.------------------------------------------------------------
ACCAUD00  CALL      CLACCAUD
          PACK      KEY54,CLAIMNUM,SP70
          CALL      RSACAUD1
ACCAUD10  CALL      RKACAUD1
          BRANCH    OVRCD,ACCAUD99
.
          MATCH     ACAUCLMN,CLAIMNUM             * Same ACC Claim number
          GOTO      ACCAUD99 IF NOT EQUAL
.
          MATCH     SP10,AUDITTYP                 * All Audit Type not selected?
          IF        !@EQUAL
            MATCH     ACAUAUTY,AUDITTYP           * Audit Type
            GOTO      ACCAUD10 IF NOT EQUAL
          ENDIF
.
          MATCH     SP10,ACCTYREC                  * Not All ACC Type of Record?
          IF        !@EQUAL
            MATCH     ACAUTREC,ACCTYREC           * ACC Type of Record
            GOTO      ACCAUD10 IF NOT EQUAL
          ENDIF
.
          MATCH     SP10,ACAUWUID                 * Web User Id
          IF        !@EQUAL
            PACK      KEY10,ACAUWUID,SP70
            CALL      RDWBSE1
            IF        OVRCD=1
              PACK     WBSENAM,SP70
            ENDIF
          ELSE
            PACK     WBSENAM,SP70
          ENDIF
.
          PACK      ACAUDTTM,ACAUDATE,ACAUTIME
.
          MOVE      SP70,AUDITYPE
          MATCH     "A",ACAUAUTY
          IF        @EQUAL
            MOVE      "Add",AUDITYPE
          ENDIF
.
          MATCH     "C",ACAUAUTY
          IF        @EQUAL
            MOVE      "Change ACC No",AUDITYPE
          ENDIF
.
          MATCH     "D",ACAUAUTY
          IF        @EQUAL
            MOVE      "Delete",AUDITYPE
          ENDIF
.
          MATCH     "S",ACAUAUTY
          IF        @EQUAL
            MOVE      "Submitted",AUDITYPE
          ENDIF
.
          MATCH     "U",ACAUAUTY
          IF        @EQUAL
            MOVE      "Update",AUDITYPE
          ENDIF
.
          MATCH     "V",ACAUAUTY
          IF        @EQUAL
            MOVE      "View",AUDITYPE
          ENDIF
. 
          MOVE      SP70,ACCTYPRE
          MATCH     "A",ACAUTREC
          IF        @EQUAL
            MOVE      "Accident / Injury Details",ACCTYPRE
          ENDIF
.
          MATCH     "D",ACAUTREC
          IF        @EQUAL
            MOVE      "Injury Diagnosis Details",ACCTYPRE
          ENDIF
.
          MATCH     "P",ACAUTREC
          IF        @EQUAL
            MOVE      "Form Printing",ACCTYPRE
          ENDIF
.
          MATCH     "R",ACAUTREC
          IF        @EQUAL
            MOVE      "Referral Details",ACCTYPRE
          ENDIF
.
          MATCH     "W",ACAUTREC
          IF        @EQUAL
            MOVE      "Work Capacity Details",ACCTYPRE
          ENDIF
.
          WRITE     HTMLFILE;"t.addRow(#"",CLAIMNUM,"#",":     * 0
                             "#"",WBSENAM,"#",":               * 1
                             "#"",ACAUDTTM,"#",":              * 2
                             "#"",ACAUADMN,"#",":              * 3
                             "#"",AUDITYPE,"#",":              * 4
                             "#"",ACCTYPRE,"#",":              * 5
                             "#"",ACAUDIGC,"#",":              * 6
                             "#"",ACAURPTY,"#",":              * 7
                             "#"",ACAUSATC,"#",":              * 8
                             "#"",ACAUOACC,"#");"              * 9
.
          GOTO      ACCAUD10
.
ACCAUD99  RETURN
.
.------------------------------------------------------------
. Output Encounter FHIR JSON Response
.------------------------------------------------------------
FHRENC00  PACK      FHRENCID,AURNO,DAADMNO,SP70
          PACK      FHRPATID,AURNO,SP70
          SQUEEZE   FHRPATID
          REP       " -",FHRENCID
          MOVE      AURNO,URNUMBER
          MOVE      AADMNO,ADMISSNO
          MOVE      AURNO,URNO
          MOVE      SP70,KEY10
          CALL      GETPAT00  
          CALL      PATLN000   * Format Patient Name for System Parameter
          REP       " 0",PTMXSIN1
.
.          CALL      FWDBED00                    * format ward/bed text
.
          CLEAR     FHRWLOCC
          CLEAR     FHRBLOCC
.
          MATCH     SP70,AWARD
          IF        @EQUAL
            MOVE      PTMIXWRD,AWARD
          ENDIF
.
          MATCH     SP70,AWARD
          IF        !@EQUAL
            APPEND    "Ward-",FHRWLOCC
            APPEND    AWARD,FHRWLOCC
          ENDIF
.
          MATCH     SP70,ABED
          IF        @EQUAL
            MOVE      PTMIEBED,ABED
          ENDIF
.
          MATCH     SP70,ABED
          IF        !@EQUAL
            APPEND    "Bed-",FHRBLOCC
            APPEND    AWARD,FHRBLOCC
            APPEND    ABED,FHRBLOCC
          ENDIF
.
          CALL      FWDNAM00
          CALL      FBDNAM00
.
          APPEND    SP70,FHRWLOCC
          APPEND    SP70,FHRBLOCC
          RESET     FHRWLOCC
          RESET     FHRBLOCC
          STRIP     FHRWLOCC
          STRIP     FHRBLOCC
          REP       " -",FHRWLOCC
          REP       " -",FHRBLOCC
.
          MOVE      FRWRDTXT,FHRLOCN
          MOVE      FRBEDTXT,FHRBLOCN
.
          MOVE      ENSTATUS,FHRSTAT     *  Encounter Status
          MOVE      "inpatient",FHRCLAS  *  Encounter Class
          MOVE      FORMATNM,FHRPATN  *  Patient Display Name
.
          PACK      KEY8,DAADMNO,SP70
          CALL      RDPMWOR1
          IF        OVRCD=1
            CALL      CLPMWO00
          ENDIF
.
          CALL      GFRSDT00
          CALL      GFREDT00
          CALL      GFRDOC00
.
          STRIP     ADIAG1
          STRIP     ADIAG2
          CLEAR     FHRREAS  
          APPEND    ADIAG1,FHRREAS 
          APPEND    SP1,FHRREAS 
          APPEND    ADIAG2,FHRREAS 
          RESET     FHRREAS
.
          MOVE      SP70,FHRUNITC
          MOVE      SP70,FHRUNITD
          MATCH     SP3,ACLSSFT
          IF        !@EQUAL
            MOVE      "AC",KEY2
            PACK      KEY5,KEY2,ACLSSFT
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      KEY5,FHRUNITC
              MOVE      TDESC,FHRUNITD
            ENDIF
          ENDIF
          STRIP     FHRUNITC
          STRIP     FHRUNITD
.
          MOVE      "false",FHRVISA
          MATCH     "1",PMVXVALW
          IF        @EQUAL
            MOVE      "true",FHRVISA
          ENDIF
.
          MOVE      "false",FHRPHNA
          MATCH     "1",PMVXPALW
          IF        @EQUAL
            MOVE      "true",FHRPHNA
          ENDIF
.
          IF        RECNUMB>0
            WRITE     HTMLFILE;",";
          ENDIF
          ADD       ONE,RECNUMB
          WRITE     HTMLFILE;*+,"{ #"fullUrl#" : #"%BASEURL/Encounter/",FHRENCID,"#", ":
                    " #"resource#" : ";
          CALL     RESENC00            * FHIR Resource Encounter
          WRITE    HTMLFILE;*+,"}" 
.
          IF       FHRSUBIN=1
            WRITE     HTMLFILE;*+,",{ #"fullUrl#" : #"%BASEURL/Patient/",FHRPATID,"#", ":
                      " #"resource#" : ";
            CALL     RESPAT00            * FHIR Resource Patient
            WRITE    HTMLFILE;*+,"}" 
          ENDIF
.
          IF       FHRPARIN=1
.
            CALL      FHRDO100
.
            MATCH     SP70,FHRDOCC1
            IF        !@EQUAL
.
              WRITE     HTMLFILE;*+,",{ #"fullUrl#" : #"%BASEURL/Practitioner/",FHRDOCC1,"#", ":
                        " #"resource#" : ";
              CALL     RESPRA00         * FHIR Resource Practitioner
              WRITE    HTMLFILE;*+,"}"
.
            ENDIF
.
            CALL      FHRDO200
.
            MATCH     SP70,FHRDOCC2
            IF        !@EQUAL
.
              WRITE     HTMLFILE;*+,",{ #"fullUrl#" : #"%BASEURL/Practitioner/",FHRDOCC2,"#", ":
                        " #"resource#" : ";
              CALL     RESPRA00         * FHIR Resource Practitioner
              WRITE    HTMLFILE;*+,"}"
.
            ENDIF
.
          ENDIF
.
          IF       FHRLOCIN=1
.
.           Check if Looking at pre-admissions
.           Use expected Ward/Bed if actual Ward/Bed blank
            COMPARE   "1",ASTAT
            IF        @EQUAL
              MATCH     AWARD,SP70
              IF        @EQUAL
                MOVE      PTMIXWRD,AWARD
                MOVE      PTMIEBED,ABED
              ENDIF
            ENDIF

            PACK      KEY6,AWARD,ABED,SP70
            CALL      RDWARD1
            IF        OVRCD=0
.
              MATCH     SP70,AWARD
              IF        !@EQUAL
.
                MATCH     SP70,ABED
                IF        !@EQUAL
.
                  WRITE     HTMLFILE;*+,",{ #"fullUrl#" : #"%BASEURL/Location/",FHRBLOCC,"#", ":
                            " #"resource#" : ";
                  CALL     RESBED00         * FHIR Resource Location Bed
                  WRITE    HTMLFILE;*+,"}"
.
                ELSE
.
                  WRITE     HTMLFILE;*+,",{ #"fullUrl#" : #"%BASEURL/Location/",FHRWLOCC,"#", ":
                            " #"resource#" : ";
                  CALL     RESWRD00         * FHIR Resource Location Ward
                  WRITE    HTMLFILE;*+,"}"
.
                ENDIF
.
              ENDIF
.
            ENDIF
.
          ENDIF
.
          RETURN
+
.------------------------------------------------------------------------------
. FHIR Encounter Resource
.------------------------------------------------------------------------------
RESPRA00  MOVE      PMHCADR1,PRACNAME       * use hcp details
          MOVE      PMHCADR2,PRACADD1
          MOVE      SP70,PRACADD2
          MOVE      PMHCADR3,PRACADD3
          MOVE      PMHCADR4,PRACADD4
          MOVE      PMHCPOST,PRACPOST
          MOVE      PMHCSEML,PRACPEML
          MOVE      PMHCSTEL,PRACPTEL
          MOVE      PMHCFAXN,PRACPFAX
          MOVE      PMHCPRV1,PRACPROV
          PACK      DISPPRAC,SP70
          PACK      DISPPNAM,SP70,SP70
          PACK      DISPPCNT,SP70
.
          MOVE      "DT",TCODE
          PACK      KEY5,TCODE,PMHCSPC1,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      SP70,TDESC
          ENDIF
          CALL      HCPNAME0
          WRITE     HTMLFILE;*+," { #"resourceType#": #"Practitioner#",":
                    "   #"id#": #"HCP-",PMHCHCPC,"#",":
                    " #"extension#": [":
                    " { #"url#":#"%BASEURL/extension/webPASService#"":
                        " ,#"valueString#":#"",PRGID,SP1,PRGNAM,SP1,VERSION,"#"},":
                    " { #"url#":#"%BASEURL/extension/webPASTemplate#"":
                        " ,#"valueString#":#"%TEMPLATEHOME/",WBTPFIL," %TEMPLATEVERSION#"},":
                    " { #"url#":#"%BASEURL/extension/dxc-hc-speciality#"":
                        " ,#"valueString#":#"",TDESC,"#"}":
                    " ],":
                    " #"identifier#": [ ":
                    "  {#"type#": { #"text#" : #"HCP ID#" },":
                    "   #"value#": #"",PMHCHCPC,"#" },":
                    "  {#"type#": { #"text#" : #"Provider Number#" },":
                    "   #"value#": #"",PRACPROV,"#" }":
                    "    ] ,":
                    " #"name#": [ { ":
                    "  #"use#": #"usual#",":
                    "  #"text#": #"",DOCFNAME,"#" ,":
                    "  #"prefix#":[ #"",PMHCTITL,"#" ],":
                    "  #"given#": [ #"",PMHCGNAM,"#" ],":
                    "  #"family#": #"",PMHCSNAM,"#" } ],":
                    "  #"telecom#": [ ":
                    "   { #"system#": #"phone#", #"use#": #"work#", ":
                    "     #"value#": #"",PRACPTEL,"#" },":
                    "   { #"system#": #"email#", #"use#": #"work#", ":
                    "     #"value#": #"",PRACPEML,"#" },":
                    "   { #"system#": #"phone#", #"use#": #"mobile#", ":
                    "     #"value#": #"",PMHCMOBN,"#" },":
                    "   { #"system#": #"fax#",   #"use#": #"work#", ":
                    "     #"value#": #"",PRACPFAX,"#" } ],":
                    " #"address#": [ {":
                    "  #"use#": #"work#",":
                    "  #"line#": [#"",PRACNAME,"#"":
                    ",#"",PRACADD1,"#"";
          MATCH     SP70,PRACADD2
          IF        !@EQUAL
            STRIP     PRACADD2
            WRITE     HTMLFILE;*+,",#"",PRACADD2,"#"";
          ENDIF
          WRITE     HTMLFILE;*+,"],":
                      "       #"city#": #"",PRACADD3,"#",":
                      "       #"state#": #"",PRACADD4,"#",":
                      "       #"postalCode#": #"",PRACPOST,"#"":
                      "      }":
                      "    ]";
          WRITE     HTMLFILE;*+,"  }";
          RETURN
+
.------------------------------------------------------------------------------
. Format HCP Name in Title Text
.------------------------------------------------------------------------------
HCPNAME0  MOVE      PMHCTITL,FMTTITLE
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000
          RETURN
.
.--------------------------------------------------------------------------------
. Add Diagnosis Coding to Encounter 
. Not provided for the Encounters Resource Search by Practitioner for performance
.--------------------------------------------------------------------------------
RESDIA00  
RESDIA99  RETURN
.--------------------------------------------------------------------------------
. FHIR Encounter Resource Extra Type Related Data
.--------------------------------------------------------------------------------
RESEXT00
RESEXT99  RETURN
.--------------------------------------------
. Add Contacts to FHIR Patient Resource
.--------------------------------------------
FHRCON00  MOVE      ZERO,F3
          PACK      KEY14,URNUMBER,SP20
          CALL      RSPMCEX1
FHRCON10  CALL      RKPMCEX1
          BRANCH    OVRCD,FHRCON99
          MATCH     URNUMBER,PMCEURNO
          GOTO      FHRCON99 IF NOT EQUAL
          MATCH     "0",PMCEACTV
          GOTO      FHRCON10 IF NOT EQUAL
.
          PACK      KEY5,CATTC,PMCETYPE
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      PMCETYPE,TDESC
          ENDIF
.
          PACK      KEY4,PMCETITL
          CALL      RDPMTLE1
          IF        OVRCD=1
            MOVE      PMCETITL,PMTLDESC
          ENDIF
.
          PACK      KEY10,PMCERELP,SP70
          CALL      RDPMREL1
          IF        OVRCD=1
            MOVE      PMCERELP,PMRLDESC
          ENDIF
.
          IF        F3>0
            WRITE     HTMLFILE;*+,",";
          ELSE
            ADD       ONE,F3
            WRITE     HTMLFILE;*+,",#"contact#" : [ ";
          ENDIF
          WRITE     HTMLFILE;*+,"{#"relationship#": [ {":
                                "  #"coding#":  [ {":
                                "   #"code#": #"",PMCERELP,"#",":
                                "   #"display#": #"",PMRLDESC,"#" } ] } ],":
                                " #"name#" : {":
                                "  #"use#" : #"usual#",":
                                "  #"family#": #"",PMCESNAM,"#",":
                                "  #"given#" : [#"",PMCEGNAM,"#"";
          MATCH     SP70,PMCEGNM2
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",#"",PMCEGNM2,"#"";
          ENDIF
          WRITE     HTMLFILE;*+,"],":
                      "      #"prefix#" : [#"",PMTLDESC,"#"]":
                      "     }, ";
.
          WRITE     HTMLFILE;*+," #"address#": [ {":
                                " #"use#": #"home#",":
                                " #"line#": [#"",PMCEADD1,"#"";
          MATCH     SP70,PMCEADD2
          IF        !@EQUAL
            STRIP     PMCEADD2
            WRITE     HTMLFILE;*+,",#"",PMCEADD2,"#"";
          ENDIF
          WRITE     HTMLFILE;*+,"],":
                                " #"city#": #"",PMCEADD3,"#",":
                                " #"state#": #"",PMCEADD4,"#",":
                                " #"postalCode#": #"",PMCEPOST,"#"":
                                " } ],":
                                "#"telecom#": [ ":
                                "{#"system#": #"email#",":
                                " #"value#": #"",PMCEEMAI,"#"},":
                                "{#"system#": #"phone#",":
                                " #"use#": #"home#",":
                                " #"value#": #"",PMCETELP,"#"},":
                                "{#"system#": #"phone#",":
                                " #"use#": #"work#",":
                                " #"value#": #"",PMCETELB,"#"},":
                                "{#"system#": #"phone#",":
                                " #"use#": #"mobile#",":
                                " #"value#": #"",PMCETELM,"#"} ] }";
          GOTO      FHRCON10

FHRCON99  IF        F3>0
            WRITE     HTMLFILE;*+,"  ]";
          ENDIF
          MATCH     PMPXRHC1,SP70
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",#"generalPractitioner#": [ { #"reference#": #"Practitioner/HCP-",PMPXRHC1,"#" }";
            MATCH     PMPXVGPC,SP70
            IF        !@EQUAL
              WRITE     HTMLFILE;*+,", { #"reference#": #"Practitioner/HCP-",PMPXVGPC,"#" }";
            ENDIF
            WRITE     HTMLFILE;*+," ]";
          ENDIF
          WRITE     HTMLFILE;*+,",#"telecom#": [ ";
          WRITE     HTMLFILE;*+,"{#"system#": #"phone#",":
                                " #"use#": #"home#",":
                                " #"value#": #"",PTELEP,"#"}";
          MATCH     SP70,PMPXPEML
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",{#"system#": #"email#",":
                                  " #"value#": #"",PMPXPEML,"#"}";
          ENDIF
          MATCH     SP70,PTELEB
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",{#"system#": #"phone#",":
                                  " #"use#": #"work#",":
                                  " #"value#": #"",PTELEB,"#"}";
          ENDIF
          MATCH     SP70,PTMXCELL
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",{#"system#": #"phone#",":
                                  " #"use#": #"mobile#",":
                                  " #"value#": #"",PTMXCELL,"#"} ";
          ENDIF
          WRITE     HTMLFILE;*+,"]";
          RETURN
+
.------------------------------------------------------------
. Get Period Start Date for FHIR Response.
.------------------------------------------------------------
GFRSDT00  MOVE      SP70,FHRSTRDT
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MATCH     SP70,ATIME
          IF        @EQUAL
            PACK      FHRSTRDT,CCENT,CYEAR,FHRDASH,CMON,FHRDASH,CDAY
          ELSE
            UNPACK    ATIME,CHOUR,D1,CMIN,D1,KEY2
            REP       " 0",CHOUR
            REP       " 0",CMIN
            REP       " 0",KEY2
            PACK      ATIME,CHOUR,COLON,CMIN,COLON,KEY2
            PACK      FHRSTRDT,CCENT,CYEAR,FHRDASH,CMON,FHRDASH,CDAY:
                      ANST,ATIME,TIMEZONE,SP70
          ENDIF
          RETURN
+
.------------------------------------------------------------
. Get Period End Date for FHIR Response.
.------------------------------------------------------------
GFREDT00  MOVE      SP70,FHRENDDT
          MATCH     SP70,PMWOEDAT
          IF        !@EQUAL
            UNPACK    PMWOEDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      EXPCTDSC,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP1,PMWOEDTM
            MATCH     SP70,PMWOEDTM
            IF        @EQUAL
              PACK      FHRENDDT,CCENT,CYEAR,FHRDASH,CMON,FHRDASH,CDAY
            ELSE
              PACK      FHRENDDT,CCENT,CYEAR,FHRDASH,CMON,FHRDASH,CDAY:
                        ANST,PMWOEDTM,TIMEZONE,SP70
            ENDIF
            GOTO      GFREDT99
          ENDIF
.
          MOVE      CCC,CCENT
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      ASTAY,ADJDAYS
          CALL      ADJDAT00
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      EXPCTDSC,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          PACK      FHRENDDT,CCENT,CYEAR,FHRDASH,CMON,FHRDASH,CDAY
.
GFREDT99  RETURN
+
.------------------------------------------------------------
. Get Doctors for FHIR Response.
.------------------------------------------------------------
GFRDOC00  MOVE      SP70,FHRDOCC1
          MOVE      SP70,FHRDOCT1
          MOVE      SP70,FHRDOCN1
.
          MOVE      SP70,FHRDOCC2
          MOVE      SP70,FHRDOCT2
          MOVE      SP70,FHRDOCN2
.
          PACK      KEY10,ADOCTA,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,GFRDOC99
.
          CLEAR     FHRDOCC1
          APPEND    "HCP-",FHRDOCC1
          APPEND    ADOCTA,FHRDOCC1
          RESET     FHRDOCC1
          MOVE      "ADM",FHRDOCT1 *  Doctor Type
          SQUEEZE   PMHCTITL
          SQUEEZE   PMHCSNAM
          MOVE      PMHCGNAM,DIM1
          PACK      FHRDOCN1,PMHCTITL,SP1,DIM1,DOT,SP1,PMHCSNAM,SP70
.
          MATCH     SP70,PMVXEDC1
          GOTO      GFRDOC99 IF EQUAL
.
          CLEAR     FHRDOCC2
          APPEND    "HCP-",FHRDOCC2
          APPEND    PMVXEDC1,FHRDOCC2
          RESET     FHRDOCC2
          MOVE      "CON",FHRDOCT2
.
          PACK      KEY10,PMVXEDC1
          CALL      RDPMHCP1
          BRANCH    OVRCD,GFRDOC99
.
          SQUEEZE   PMHCTITL
          SQUEEZE   PMHCSNAM
          MOVE      PMHCGNAM,DIM1
          PACK      FHRDOCN2,PMHCTITL,SP1,DIM1,DOT,SP1,PMHCSNAM,SP70
.
GFRDOC99  RETURN
.
.-----------------------------------------------------------
. Format ward/bed text for output 
.-----------------------------------------------------------
FWDBED00  CLEAR     WDBEDTXT
          MOVE      "active",LCSTATUS     * Location Status 
          CLEAR     KEY10
          CALL      STANDP00               * check if standby
.
          MATCH     SP70,AWARD
          GOTO      FWDBED99 IF EQUAL
.  
          PACK      KEY6,AWARD,SP70
          CALL      RDWARD1
          IF        OVRCD=1
            STRIP     AWARD
            APPEND    AWARD,WDBEDTXT
          ELSE    
            STRIP     PTWDSDES
            APPEND    PTWDSDES,WDBEDTXT
          ENDIF
.
          PACK      DIM12,PTWDSDES,SP70
.                         
          MATCH     SP70,ABED
          GOTO      FWDBED90 IF EQUAL
.
          APPEND    "/",WDBEDTXT
.
          PACK      KEY6,AWARD,ABED 
          CALL      RDWARD1        
          BRANCH    OVRCD,FWDBED99
.
          IF        WBEDDESC > 0
            IF        WBEDDESC = 2 
              STRIP     PTWDSDES
              APPEND    PTWDSDES,WDBEDTXT   * use short bed text
            ELSE
              STRIP    WBDESC
              APPEND   WBDESC,WDBEDTXT      * use bed desc, not bed #
            ENDIF   
          ELSE
            STRIP    ABED
            APPEND   ABED,WDBEDTXT
          ENDIF
.
FWDBED90  MATCH     DWSTBY,ADMISSNO
          GOTO      FWDBED99 IF NOT EQUAL
          APPEND    " (s)",WDBEDTXT       * add standby ind. ' (s)'
          MOVE      "planned",LCSTATUS     * Location Status
.
          APPEND    KEY10,WDBEDTXT        * add standby ind. ' (s)'
.
FWDBED99  RESET     WDBEDTXT
          PACK      COLDAT02,WDBEDTXT,SP70
          RETURN
+
.------------------------------------------------------------
. Format FHIR Ward Display Name
.------------------------------------------------------------
FWDNAM00  CLEAR     FRWRDTXT
          MOVE      SP70,FRWRDTXT
.
          MATCH     SP70,AWARD
          GOTO      FWDNAM99 IF EQUAL
.
          PACK      KEY6,AWARD,SP70
          CALL      RDWARD1
          IF        OVRCD=1
            STRIP     AWARD
            MOVE      AWARD,FRWRDTXT
          ELSE
            STRIP     WBDESC
            MOVE      WBDESC,FRWRDTXT
          ENDIF
.
FWDNAM99  RETURN
.
.------------------------------------------------------------
. Format FHIR Bed Display Name
.------------------------------------------------------------
FBDNAM00  CLEAR     FRBEDTXT
          MOVE      SP70,FRBEDTXT
.
          MATCH     SP70,ABED
          GOTO      FBDNAM99 IF EQUAL
.
          PACK      KEY6,AWARD,ABED
          CALL      RDWARD1
          IF        OVRCD=0
            STRIP     WBDESC
            MOVE      WBDESC,FRBEDTXT
          ENDIF
.
FBDNAM99  RETURN
.
.------------------------------------------------------------
. Checks for Patient on standby
.------------------------------------------------------------
STANDP00  PACK     KEY13,ABED,SP70
          PACK     KEY6,AWARD,SP70
          MATCH    SP70,AWARD
          IF       @EQUAL
            PACK      KEY14,AADMNO,SP70
            CALL      RDSWARD4
            CALL      RDKWARD4
            BRANCH    OVRCD,STANDP99
            MATCH     WSTBY,AADMNO
            GOTO      STANDP99 IF NOT EQUAL
            MOVE      WWARD,AWARD
            MOVE      WBED,ABED
            CLEAR     KEY10
            APPEND    SP1,KEY10
            APPEND    "(s)",KEY10
            RESET     KEY10
          ENDIF
          GOTO     STANDP99
.
STANDP99  RETURN
+
.******************************************************************************
.*                                  ERVS0000                                  *
.*  Update eReferral visit number                                             *
.******************************************************************************
ERVS0000  MATCH     "1",PTCNEPIS
          GOTO      ERVS9999 IF NOT EQUAL
.
          PACK      KEY38,WMURNO,SP70
          CALL      RSCMERH3
ERVS1000  CALL      RKCMERH3
          BRANCH    OVRCD,ERVS9999
.
          MATCH     WMURNO,CMRHURNO
          GOTO      ERVS9999 IF NOT EQUAL
.
          MATCH     WMCODE,CMRHPCOD
          GOTO      ERVS1000 IF NOT EQUAL
.
          MOVE      WMCNT,D2
          MATCH     D2,CMRHPCNT
          GOTO      ERVS1000 IF NOT EQUAL
.
          MOVE      WMBOOK,CMRHVISN
.
          CALL      UPCMERH3
.
ERVS9999  RETURN
+
.------------------------------------------------------------
. New overdue date calculation
.------------------------------------------------------------
NEWOVR00  MOVE      ZERO,OVERSTAT
          READ      CONTROLF,HUND11;*11,WTCNERFC
          MOVE      "TP",CATEGORY
          MOVE      WMPTY,CODE
          CALL      GETCOD00
          CALL      GTPC0000
          MOVE      CLURCTDT,OVERDATE
          MOVE      CLURCTDT,PRIODATE
.
          IF        CATCHGFL=0
            MATCH     "1",WTCNERFC
            IF        @EQUAL
              MOVE      WMKEYDT,OVERDATE   * no urgency change, use date on list
              MOVE      WMKEYDT,CLURCTDT
              MOVE      WMKEYDT,PRIODATE   * no urgency change, use date on list
            ELSE
              MOVE      WMDATE1,OVERDATE   * no urgency change, use date on list
              MOVE      WMDATE1,CLURCTDT
              MOVE      WMDATE1,PRIODATE   * no urgency change, use date on list
            ENDIF
          ENDIF
.
          PACK      KEY5,ANST,ANSP,WMPTY,SP70
          CALL      RDCODE1
          ADD       TCFORM6,PRIODATE
          READ      CONTROLF,THIRTY7;*173,WTCNURDY,*177,WTCNSUDY:
                                     *181,WTCNRODY
          MATCH     "U",TCINDC1
          IF        @EQUAL
            ADD       WTCNURDY,OVERDATE
          ENDIF
.
          MATCH     "S",TCINDC1
          IF        @EQUAL
            ADD       WTCNSUDY,OVERDATE
          ENDIF
.
          MATCH     "R",TCINDC1
          IF        @EQUAL
            ADD       WTCNRODY,OVERDATE
          ENDIF
.
          CALL      ADSU0000      * add suspensions within overdue date
          CALL      ADPU0000      * add suspensions within priority overdue date
.
          MATCH     SP70,PRIODATE
          GOTO      NEWOVR99 IF EQUAL
.
          PACK      TODAY,CCC,CYY,CMM,CDD
          REP       " 0",TODAY
          MATCH     TODAY,PRIODATE
          IF        @LESS
            MOVE      ONE,OVERSTAT
          ENDIF
.
NEWOVR99  RETURN
+
.------------------------------------------------------------
. Add suspensions within overdue date
.------------------------------------------------------------
ADSU0000  PACK      CASEKEYS,WMURNO,WMCODE,WMCNT,SP70
          PACK      KEY29,WMURNO,WMCODE,WMCNT,SP70
          CALL      RSWTSUS2
ADSU0010  CALL      RKWTSUS2
          BRANCH    OVRCD,ADSU9999
          PACK      KEY19,WTSUURNO,WTSUCODE,WTSUCNT,SP70
          MATCH     KEY19,CASEKEYS
          GOTO      ADSU9999 IF NOT EQUAL
.
          MATCH     WTSUFDAT,OVERDATE
          GOTO      ADSU9999 IF LESS
.
          MATCH     WTSUFDAT,CLURCTDT
          IF        !@LESS
            MOVE       CLURCTDT,WTSUFDAT
            MATCH      WTSUTDAT,CLURCTDT
            IF         !@LESS
              GOTO       ADSU0010
            ENDIF
          ENDIF
.
          MATCH     SP70,WTSUTDAT
          IF        @EQUAL
            MOVE      SP70,OVERDATE
            GOTO      ADSU9999
          ENDIF
.
          DAYSEP    WTSUFDAT,WTSUTDAT,F6
.
          ADD       F6,OVERDATE
          GOTO      ADSU0010
.
ADSU9999  RETURN
.------------------------------------------------------------
. Add suspensions within priority overdue date
.------------------------------------------------------------
ADPU0000  PACK      CASEKEYS,WMURNO,WMCODE,WMCNT,SP70
          PACK      KEY29,CASEKEYS,SP70
          CALL      RSWTSUS2
ADPU0010  CALL      RKWTSUS2
          BRANCH    OVRCD,ADSU9999
          PACK      KEY19,WTSUURNO,WTSUCODE,WTSUCNT,SP70
          MATCH     KEY19,CASEKEYS
          GOTO      ADPU9999 IF NOT EQUAL
.
          MATCH     WTSUFDAT,PRIODATE
          GOTO      ADPU9999 IF LESS
.
          MATCH     SP70,WTSUTDAT
          IF        @EQUAL
            MOVE      SP70,PRIODATE
            GOTO      ADPU9999
          ENDIF
.
          MATCH     WTSUFDAT,CLURCTDT
          IF        !@LESS
            MOVE       CLURCTDT,WTSUFDAT
            MATCH      WTSUTDAT,CLURCTDT
            IF         !@LESS
              GOTO       ADPU0010
            ENDIF
          ENDIF
.
          DAYSEP    WTSUFDAT,WTSUTDAT,F6
.
          ADD       F6,PRIODATE
          GOTO      ADPU0010
.
ADPU9999  RETURN
+
.******************************************************************************
.*                                  GTPC0000                                  *
.*                    Get Days RFC following urgency increase                 *
.******************************************************************************
GTPC0000  MOVE      ZERO,RECCNT
          MOVE      ZERO,CATASSGN
          CALL      IBACLOCK
          MOVE      ZERO,CATCHGFL
          MOVE      SP1,SAVINDC3
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,ENDDTE
          PACK      CLURCTDT,ENDDTE
.
          IF        WMSTAT<4 | WMSTAT>6
            GOTO      GTPC0500
          ENDIF
.
          IF        WMSTAT=6
            MOVE      WMDATE4,ENDDTE
            MOVE      ENDDTE,CLURCTDT
            GOTO      GTPC0500
          ENDIF
.
          PACK      KEY8,WMBOOK
          CALL      RDMISS1
          BRANCH    OVRCD,GTPC0500
.
          PACK      ENDDTE,ADATE
          PACK      CLURCTDT,ENDDTE
.
GTPC0500  PACK      KEY29,WMURNO,WMCODE,WMCNT,ANST,ANSP,SP20
          CALL      RSWTCAT2                * Position on & read code changes
GTPC1000  CALL      RKWTCAT2                  file record
          BRANCH    OVRCD,GTPC3000
.
          MATCH     WMURNO,WTCAURNO
          GOTO      GTPC3000 IF NOT EQUAL   * Different U/R no
.
          MATCH     WMCODE,WTCAPROC
          GOTO      GTPC3000 IF NOT EQUAL   * Different procedure code
.
          COMPARE   WMCNT,WTCAPCNT
          GOTO      GTPC3000 IF NOT EQUAL   * Different procedure count
.
          MATCH     "TP",WTCACATF
          GOTO      GTPC3000 IF NOT EQUAL   * Different category
.
          MOVE      SP1,TCINDC3
          MATCH     SP3,WTCACODF
          IF        !@EQUAL
.....       PACK      KEY5,ANST,ANSP,WTCACODF
.....       CALL      RDCODE1               * Read a codes file record
          ENDIF
.
.         MOVE      TCINDC3,SAVINDC3        * Save the 3rd indicator
.
          MOVE      SP1,TCINDC3
          MATCH     SP3,WTCACODT
          IF        !@EQUAL
            PACK      KEY5,ANST,ANSP,WTCACODT
            CALL      RDCODE1               * Read a codes file record
          ENDIF
.
GTPC2000  ADD       ONE,RECCNT
          IF        RECCNT=1
            MOVE      TCINDC3,SAVINDC3        * Save the 3rd indicator
            GOTO      GTPC1000
          ENDIF
.
          MATCH     TCINDC3,SAVINDC3
          GOTO      GTPC1000 IF EQUAL
          IF        @LESS
            GOTO      GTPC1000
          ENDIF
.
          MATCH     WTCAEDAT,WMDATE1
          IF        @EQUAL
            MOVE      SP8,WTCAEDAT
            GOTO      GTPC1000
          ENDIF
.
          MATCH     SP8,WTCAEDAT
          GOTO      GTPC1000 IF EQUAL
.
          MOVE      WTCAEDAT,CLURCTDT
          REP       " 0",CLURCTDT     * Clinical urgency cat last date
          MOVE      ONE,CATCHGFL
.
          MOVE      TCINDC3,SAVINDC3        * Save the 3rd indicator
          GOTO      GTPC1000
.
GTPC3000  DAYSEP    CLURCTDT,ENDDTE,CATASSGN
.
GTPC9000  MOVE      ZERO,EXIT
GTPC9999  RETURN
+
.******************************************************************************
.*                                  GTPC0000              Called by: GTRE0000 *
.*                           Get Category TP Changes                          *
.******************************************************************************
DRFCUR00  READ      CONTROLF,HUND11;*11,WTCNERFC
          MOVE      ZERO,URRFCDAY
          CALL      GTPC0000               * get days RFC following increase
.
          MOVE      CATASSGN,URRFCDAY
          IF        CATCHGFL=0
            MATCH     CLURCTDT,ENDDTE
            IF        @EQUAL
              DAYSEP    WMDATE1,ENDDTE,URRFCDAY
              MATCH     "1",WTCNERFC
              IF        @EQUAL
                MATCH     WMKEYDT,ENDDTE
                IF        !@LESS
                  DAYSEP    WMKEYDT,ENDDTE,URRFCDAY
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          IF        CATCHGFL=0
            MOVE      WMDATE1,CLURCTDT
            MATCH     "1",WTCNERFC
            IF        @EQUAL
              MOVE      WMKEYDT,CLURCTDT
            ENDIF
          ENDIF
          CALL      URNR0000      * calculate NRFC days
.
          ASSIGN    (URRFCDAY-LSNRFCRE),URRFCDAY
.
. *** for Victoria 1 July 2016 - add on previous days waiting at other hosp
          IF        PTCNHDPS<>3
            GOTO      DRFCUR99
          ENDIF
.
          READ      CONTROLF,HUND11;*11,WTCNERFC
          MATCH     "1",WTCNERFC
          GOTO      DRFCUR99 IF NOT EQUAL
.
          PACK      KEY17,WTWMECNT,SP70
          CALL      RDWTESE1
          BRANCH    OVRCD,DRFCUR85
.
. ** new record that has not been sent found **
          GOTO      DRFCUR90
.
DRFCUR85  PACK      KEY17,WTWMECNT,Z70
          CALL      RSWTESE1
          CALL      RPWTESE1
          BRANCH    OVRCD,DRFCUR99
.
          MATCH     WTWMECNT,WTEEUNIQ
          GOTO      DRFCUR99 IF NOT EQUAL
.
DRFCUR90  MOVE      ZERO,FORM4
          SQUEEZE   WTEEPTWT
          MOVE      WTEEPTWT,FORM4
          ASSIGN    (URRFCDAY+FORM4),URRFCDAY
          ASSIGN    (LSTDAYS+FORM4),LSTDAYS
.
DRFCUR99  RETURN
+
.******************************************************************************
.*                                  URNR0000              Called by: GTRE0000 *
.*      Calculate the number of days NRFC since last urgency reassignment     *
.******************************************************************************
URNR0000  MOVE      ZERO,NRFCDAYS
.
          MATCH     CLURCTDT,SP70
          IF        @EQUAL
            MOVE      ZERO,LSNRFCRE
            GOTO      URNR9000
          ENDIF
.
          PACK      KEY21,WMURNO,WMCODE,WMCNT,SP70
          PACK      KEY19,WMURNO,WMCODE,WMCNT,SP70
          CALL      RSWTSUS1
URNR1000  CALL      RKWTSUS1
          BRANCH    OVRCD,URNR3000
.
          MATCH     WMURNO,WTSUURNO
          GOTO      URNR3000 IF NOT EQUAL   * Different U/R no
.
          MATCH     WMCODE,WTSUCODE
          GOTO      URNR3000 IF NOT EQUAL   * Different procedure code
.
          COMPARE   WMCNT,WTSUCNT
          GOTO      URNR3000 IF NOT EQUAL
.
          MATCH     WTSUFDAT,ENDDTE
          GOTO      URNR1000 IF LESS        * End date < suspension start
.
          MATCH     SP70,WTSUTDAT
          GOTO      URNR1500 IF EQUAL
.
          MATCH     CLURCTDT,WTSUTDAT
          GOTO      URNR1000 IF LESS        * End date < suspension start
.
URNR1500  PACK      TCINDC1,SP2
          MATCH     SP3,WTSULSTS
          IF        !@EQUAL
            PACK      KEY5,ANSV,ANSL,WTSULSTS
            CALL      RDCODE1               * Read a codes file record
          ENDIF
.
          MATCH     "C",TCINDC1             * not ready for care
          GOTO      URNR2000 IF EQUAL
.
          MATCH     "D",TCINDC1
          GOTO      URNR2000 IF EQUAL
.
          MATCH     "S",TCINDC1
          GOTO      URNR1000 IF NOT EQUAL
.
URNR2000  MOVE      WTSUFDAT,CDYSFDTE
          MOVE      WTSUTDAT,CDYSTDTE
.
          MATCH     CLURCTDT,WTSUFDAT
          IF        @LESS
            MOVE      CLURCTDT,CDYSFDTE
          ENDIF
.
          MATCH     SP8,WTSUTDAT
          IF        @EQUAL
            MOVE      ENDDTE,CDYSTDTE
          ELSE
            MATCH     ENDDTE,WTSUTDAT
            IF        !@LESS
              MOVE      ENDDTE,CDYSTDTE
            ENDIF
          ENDIF
.
          CALL      CALCDAYS              * Calculate diff between dates
          SUB       ONE,CDYSDAYS
          ADD       CDYSDAYS,NRFCDAYS     * Incre the days not ready for care
.
.         MATCH     SP70,WTSUTDAT
.         IF        @EQUAL
.           ADD       ONE,NRFCDAYS        * still NRFC at end date, so add 1
.         ELSE
.           MATCH     TODAYDTE,WTSUTDAT
.           IF        !@LESS
.             ADD       ONE,NRFCDAYS      * still NRFC at end date, so add 1
.           ENDIF
.         ENDIF
.
          GOTO      URNR1000
.
URNR3000  MOVE      NRFCDAYS,LSNRFCRE
.
URNR9000  MOVE      ZERO,EXIT
URNR9999  RETURN
+
.------------------------------------------------------------
. Get Number of Hospital Postponements
.------------------------------------------------------------
WATHPT00  MOVE      ZERO,HOSPOST
          PACK      KEY16,WMURNO,SP20
          CALL      RSBKREC6                * Position on & read a booking
WATHPT10  CALL      RKBKREC6                  file record
          BRANCH    OVRCD,WATHPT99
          MATCH     WMURNO,BKREURNO
          GOTO      WATHPT99 IF NOT EQUAL   * Different U/R no
          MATCH     WMCODE,BKREPROC
          GOTO      WATHPT10 IF NOT EQUAL   * Different procedure code
          COMPARE   WMCNT,BKRECNT
          GOTO      WATHPT10 IF NOT EQUAL   * Different procedure count
.
          MATCH     "THE",BKRETYPE
          IF        !@EQUAL
            PACK      KEY5,ANSB,ANSC,BKRECANC
            CALL      RDCODE1                 * Read a codes file record
            BRANCH    OVRCD,WATHPT10
            MATCH     ANSH,TCINDC2
            GOTO      WATHPT10 IF NOT EQUAL
            ADD       ONE,HOSPOST
            GOTO      WATHPT10
          ENDIF
.
          MOVE      BKREBOOK,KEY8
          PACK      KEY31,KEY8,THREE,WMDATE1,SP30
          CALL      RSOPDEA2                * Position on & read a operation
WATHPT20  CALL      RKOPDEA2                  detail file record
          BRANCH    OVRCD,WATHPT10
          MATCH     KEY8,OPDAADMN
          GOTO      WATHPT10 IF NOT EQUAL   * Different booking no, exit
          MATCH     SP3,OPDACANC
          GOTO      WATHPT20 IF EQUAL       * Blank cancellation code, get next
.
          PACK      KEY5,ANSS,ANSC,OPDACANC
          CALL      RDCODE1                 * Read a codes file record
          BRANCH    OVRCD,WATHPT20
          MATCH     ANSH,TCINDC2
          GOTO      WATHPT20 IF NOT EQUAL
          ADD       ONE,HOSPOST
          GOTO      WATHPT20
.
WATHPT99  MOVE      HOSPOST,WLHIP
          PACK      KEY8,WMBOOK
          CALL      RDBKREC1
          IF        OVRCD=1
            CALL      CLBOKRC1
          ENDIF
          RETURN
+
.------------------------------------------------------------
. Get OEC Eligibility Number in pmselfaf if available
.------------------------------------------------------------
GETELF00  MATCH     "99",PMOESTAT
          GOTO      GETELF99 IF EQUAL
.
          PACK      KEY16,URNUMBER,SP70
          CALL      RSPMELF2
GETELF10  CALL      RKPMELF2
          BRANCH    OVRCD,GETELF90
.
          MATCH     PMOEURNO,PMEFURNO
          GOTO      GETELF90 IF NOT EQUAL
.
          MATCH     PMOEVISN,PMEFVISN
          GOTO      GETELF10 IF NOT EQUAL
.
          MATCH     PMOECNTR,PMEFCNTR
          GOTO      GETELF10 IF NOT EQUAL
.
          GOTO      GETELF99          
.
GETELF90  CALL      CLPMSELF         
.
GETELF99  RETURN
+
.--------------------------------------------------------------
. Display Presenting Illness select list in TOEC0000 Table Sort
.--------------------------------------------------------------
PRILL000  WRITE     HTMLFILE;"#",#"";
.
          WRITE     HTMLFILE;"<input type=hidden name=oecad",DRECCNT:
                             " value='",ADMISSNO,"'>";
.
          WRITE     HTMLFILE;"<input type=hidden name=oecct",DRECCNT:
                             " value='",PMOECNTR,"'>";
.
          WRITE     HTMLFILE;"<select name=oecil":
                             DRECCNT:
            " onchange='checkPresillMBS(this,TableForm.oecmb",DRECCNT,",TableForm.oecad",DRECCNT,",TableForm.oecct",DRECCNT,");'>":
            "<option value='   '></option>";
.
          MOVE      "il",CATEGORY
          MOVE      PMVXPILC,CODE
          CALL      CODSQO00 
.
          WRITE     HTMLFILE;"</select>";
.
PRILL999  RETURN
+
.------------------------------------------------------------
. Add Selection Options to Form (code value) single quotes
.------------------------------------------------------------
CODSQO00  MOVE      SP70,TDESC
          PACK      KEY5,CATEGORY,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      CATEGORY,TCODE
            MOVE      "Invalid Category",TDESC
          ENDIF
          REP       " _",TCODE
          REP       " _",THCSCOD
          WRITE     HTMLFILE;"<!--<cat-c category='",TCODE,"' name='",TDESC:
                             "' map='",THCSCOD,"'></cat-c>-->";
.
          PACK      PTCDKEY2,CATEGORY,SP70
          CALL      RDSCODE2
CODSQO10  CALL      RDKCODE2
          BRANCH    OVRCD,CODSQO99
          MATCH     CATEGORY,TCODE
          GOTO      CODSQO99 IF NOT EQUAL
          MATCH     SP70,ACODE
          GOTO      CODSQO10 IF EQUAL
          PACK      KEY60,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5:
                          TCINDC6,TCINDC7,TCINDC8,TCINDC9,TCINDC10:
                          TCINDC11,THCSCOD,PTCDNHCP,TCFORM6:
                          TCINDC12,TCINDC13,TCINDC14,TCINDC15,TCINDC16:
                          TCINDC17,TCINDC18,TCINDC19,TCINDC20,TCINDC21:
                          PTCOACTV,TCINDC22,TCINDC23,TCINDC24,TCINDC25:
                          TCINDC26,TCINDC27,TCINDC28,TCINDC29,TCINDC30:
                          TCINDC31,TCINDC32,TCINDC33,TCINDC34,TCINDC35:
                          TCINDC36,TCINDC37,TCINDC38,TCINDC39,TCINDC40:
                          TCINDC41

.
          MATCH     CODE,ACODE
          IF        @EQUAL
            IF        CATACTIV=1
              MATCH     "I",PTCOACTV               * Display active only
              GOTO      CODSQO10 IF EQUAL
            ENDIF
.
            WRITE     HTMLFILE;"<option value='",ACODE,KEY60,"' selected>":
                               TDESC,"</option>";
          ELSE
            IF        CATACTIV<>2
              MATCH     "I",PTCOACTV
              GOTO      CODSQO10 IF EQUAL
            ENDIF
.
            IF        IBCNMHOS=1
              MATCH    "1",PTCDHOSS
              IF       @EQUAL
                PACK     KEY8,WBSEHOSP,TCODE,ACODE,SP70
                CALL     RDMLCOD1
                BRANCH   OVRCD,CODSQO10
              ENDIF
            ENDIF
.
            WRITE     HTMLFILE;"<option value='",ACODE,KEY60,"'>",TDESC:
                               "</option>";
          ENDIF
          GOTO      CODSQO10
CODSQO99  RETURN
+
.------------------------------------------------------------
. Add MBS Items lookup to TOEC0000 Table Sort
.------------------------------------------------------------
MBSC0000  UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          WRITE     HTMLFILE;"#",#"";
          WRITE     HTMLFILE;"<input type=hidden name=oecdt",DRECCNT: 
                             " value='",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"'>";
.
          WRITE     HTMLFILE;"<input type=text name=oecmb",DRECCNT," size=9": 
          " maxlength=9 onblur='validateCode(4,this,TableForm.oecds",DRECCNT:
         ",TableForm.oecdt",DRECCNT,");checkPresillMBS(TableForm.oecil",DRECCNT;
.
          MATCH     SP70,AMBS
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;",this,TableForm.oecad",DRECCNT,",TableForm.oecct",DRECCNT,");' value=''>";
          ELSE
            WRITE     HTMLFILE;",this,TableForm.oecad",DRECCNT,",TableForm.oecct",DRECCNT,");' value='",AMBS,"'>";
          ENDIF
.
          WRITE     HTMLFILE;"<input type=text notab readonly": 
          " name=oecds",DRECCNT," size=17>";
.
          WRITE     HTMLFILE;"<img notab src='../images/SearchIcon.gif' class=Icon";
          WRITE     HTMLFILE;" onClick='MbsSearchFrame(TableForm.oecmb",DRECCNT,",TableForm.oecds",DRECCNT,",TableForm.oecdt",DRECCNT,")'>";
.
          WRITE     HTMLFILE;"<img src='../images/erase.gif' class=Icon";
          WRITE     HTMLFILE;" onClick='clrFields(TableForm.oecmb",DRECCNT,",TableForm.oecds",DRECCNT,");checkPresillMBS(TableForm.oecil",DRECCNT:
          ",TableForm.oecmb",DRECCNT,",TableForm.oecad",DRECCNT,",TableForm.oecct",DRECCNT,");' >"; 
.
MBSC9999  RETURN
+
.*****************************************************************************
. Check if UR has a current IP/ED visit - set the alert image value ALRTIMG5
.*****************************************************************************
          DEFPROC   CIPED000
.
          INC       EMRVISFD/INC
          INC       PATMI1FD/INC
          INC       PMSVX1FD/INC
.
          OPEN      EMRVISA3,"emrvisaf" 
          OPEN      PATMI1A8,"patmi1af"
          OPEN      PMSVX1A1,"pmsvx1af"
.
          PACK      KEY17,URNUMBER,SP70
          CALL      RSPTMI18
CIPED100  CALL      RKPTMI18
          BRANCH    OVRCD,CIPED500
.
          MATCH     URNUMBER,AURNO
          GOTO      CIPED500 IF NOT EQUAL
.
.-------- Current Admission
          IF        ASTAT=2
            CLEAR     ALRTIMG5
            APPEND    "<img class=Icon ",ALRTIMG5
            MATCH     WBSEHOSP,PMVXMHOS
            IF        @EQUAL
              APPEND    " alt='Current Inpatient'",ALRTIMG5
              APPEND    " src='../images/CurrentIP1.png'",ALRTIMG5
            ELSE
              APPEND    " alt='Current Inpatient Other'",ALRTIMG5
              APPEND    " src='../images/CurrentIP2.png'",ALRTIMG5
            ENDIF
            APPEND    " onclick='return false;'>",ALRTIMG5
            RESET     ALRTIMG5
            GOTO      CIPED900
          ENDIF
.
.-------- On Leave
          IF        ASTAT=4
            CLEAR     ALRTIMG5
            APPEND    "<img class=Icon ",ALRTIMG5
            MATCH     WBSEHOSP,PMVXMHOS
            IF        @EQUAL
              APPEND    " alt='Current Inpatient On-Leave'",ALRTIMG5
              APPEND    " src='../images/CurrentIP3.png'",ALRTIMG5
            ELSE
              APPEND    " alt='Current Inpatient On-Leave Other'",ALRTIMG5
              APPEND    " src='../images/CurrentIP4.png'",ALRTIMG5
            ENDIF
            APPEND    " onclick='return false;'>",ALRTIMG5
            RESET     ALRTIMG5
            GOTO      CIPED900
          ENDIF
.
          GOTO      CIPED100           * Read next record
.
.-------- Current ED alert image - ALRTIMG5
CIPED500  PACK      KEY16,URNUMBER,SP70
          CALL      RSEMVISA3
CIPED510  CALL      RKEMVISA3
          BRANCH    OVRCD,CIPED900
.
          MATCH     URNUMBER,EMVIURNO
          GOTO      CIPED900 IF NOT EQUAL
.
          COMPARE   ONE,EMVISTAT
          GOTO      CIPED510 IF NOT EQUAL
        
          CLEAR     ALRTIMG5
          APPEND    "<img class=Icon ",ALRTIMG5
          MATCH     WBSEESC,EMVISITE
          IF        @EQUAL
            APPEND    " alt='Current Emergency'",ALRTIMG5
            APPEND    " src='../images/CurrentED1.png'",ALRTIMG5
          ELSE
            APPEND    " alt='Current Emergency Other'",ALRTIMG5
            APPEND    " src='../images/CurrentED2.png'",ALRTIMG5
          ENDIF
          APPEND    " onclick='return false;'>",ALRTIMG5
          RESET     ALRTIMG5
          GOTO      CIPED900
.
CIPED900  CLOSE     PATMI1A8
          CLOSE     EMRVISA3
          CLOSE     PMSVX1A1
          GOTO      CIPED999
.
          INC       IBAOVRIO/INC
          INC       EMRVISIO/INC
          INC       PATMI1IO/INC
          INC       PMSVX1IO/INC
.
CIPED999  ENDPROC
+
.------------------------------------------------------------
. Table of Pre-Admissions for Online Eligibility Request
.------------------------------------------------------------
TOEW0000  PACK      KEY16,FRSTDATE,SP70
          CALL      RDSMISS3
TOEW1000  CALL      RDKMISS3
          BRANCH    OVRCD,TOEW9000
          MATCH     ADATE,LASTDATE
          GOTO      TOEW9000 IF LESS
          COMPARE   "1",ASTAT
          GOTO      TOEW1000 IF NOT EQUAL
.
          MATCH     SP70,HEALTHFN
          IF        !@EQUAL
            MATCH     HEALTHFN,AFUNDH
            GOTO      TOEW1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,CLAIMTYP
          IF        !@EQUAL
            MATCH     ACLAIM,CLAIMTYP
            GOTO      TOEW1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTBOOK
          IF        !@EQUAL
            PACK      KEY8,AADMNO,SP70
            CALL      RDBKREC1
            BRANCH    OVRCD,TOEW1000
.
            MATCH     FILTBOOK,BKRETYPE
            GOTO      TOEW1000 IF NOT EQUAL
.
          ENDIF
.
          PACK      DIM1,SP20
          PACK      DISPCLSS,SP20
          PACK      DISPALTD,SP70
          PACK      KEY5,ANSC,ANSC,ACARE,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            UNPACK      TCINDC21,DIM1
          ENDIF
          MATCH     DIM1,SP70
          IF        !@EQUAL
            PACK      DISPCLSS,ONCLCLSS,DIM1,SP70
            PACK      DISPALTD,PTCDLDES,SP70
          ENDIF
          SQUEEZE   DISPCLSS
          STRIP     DISPALTD
.
          MOVE      SP70,DISPCOMP
          MOVE      ZERO,ELCHFLAG
          PACK      KEY8,DAADMNO,SP70
          CALL      RDPTELG1
          BRANCH    OVRCD,TOEW1500
.
          IF        HOSPCOMP=1
            MATCH     "1",PTELCMPL
            IF        @EQUAL
              MOVE      "Complete",DISPCOMP   * display if elig. complete
              MOVE      TWO,ELCHFLAG
            ELSE
              MOVE      ONE,ELCHFLAG
            ENDIF
          ELSE
            MATCH     "1",PTELCMPL            * don't display if elig. complete
            GOTO      TOEW1000 IF EQUAL
.
            MOVE      ONE,ELCHFLAG
          ENDIF
.
TOEW1500  PACK      KEY11,DAADMNO,Z70
          CALL      RSWBOEC1
          CALL      RPWBOEC1                   * get last OEC request
          IF        OVRCD=1
            CALL      CLWEBOEC
            MOVE      "99",WBOCSTAT            * no request status exists
            MOVE      SP70,WBOCUDTE
          ENDIF
.
          MATCH     DAADMNO,WBOCVISN
          IF        !@EQUAL
            CALL      CLWEBOEC
            MOVE      "99",WBOCSTAT            * no request status exists
            MOVE      SP70,WBOCUDTE
          ENDIF
.
          CALL      CLWEBEEH
.
          MATCH     SP70,WBOCTRID
          IF        !@EQUAL & !@EOS
            PACK      KEY47,WBOCTRID,WBOCARID,WBOCCNTR,SP70
            CALL      RDWBEEH2
            IF        OVRCD=1
              CALL      CLWEBEEH
            ENDIF
          ENDIF
.
          MATCH     SP70,REQUSTAT
          GOTO      TOEW2000 IF EQUAL          * filter by request status ?
.
          MATCH     " 5",REQUSTAT
          IF        @EQUAL
.
            MATCH     " 6",WBOCSTAT
            GOTO      TOEW1900 IF NOT EQUAL
.
.           MATCH     SP70,WBOCTRID
.           GOTO      TOEW1900 IF EQUAL
.           GOTO      TOEW1900 IF EOS
.
.           PACK      KEY47,WBOCTRID,WBOCARID,WBOCCNTR,SP70
.           CALL      RDWBEEH2
.           BRANCH    OVRCD,TOEW1900
.
            MATCH     "REJECTED",WBEHPSCD
            GOTO      TOEW1000 IF NOT EQUAL
.
            GOTO      TOEW2000
.
          ENDIF
.
          MATCH     " 6",REQUSTAT              * Match Complete Reported
          IF        @EQUAL
.
            MATCH     " 6",WBOCSTAT
            GOTO      TOEW1900 IF NOT EQUAL
.
.           MATCH     SP70,WBOCTRID
.           GOTO      TOEW1900 IF EQUAL
.           GOTO      TOEW1900 IF EOS
.
.           PACK      KEY47,WBOCTRID,WBOCARID,WBOCCNTR,SP70
.           CALL      RDWBEEH2
.           BRANCH    OVRCD,TOEW1900
.
            MATCH     "REJECTED",WBEHPSCD
            GOTO      TOEW1000 IF EQUAL
.
            MATCH     "HEALTH_FUND_UNAVAILABLE",WBEHPSCD
            GOTO      TOEW1000 IF EQUAL
.
            GOTO      TOEW2000
.
          ENDIF
.
          MATCH     " 7",REQUSTAT
          IF        @EQUAL
.
            MATCH     " 6",WBOCSTAT
            GOTO      TOEW1900 IF NOT EQUAL
.
.           MATCH     SP70,WBOCTRID
.           GOTO      TOEW1900 IF EQUAL
.           GOTO      TOEW1900 IF EOS
.
.           PACK      KEY47,WBOCTRID,WBOCARID,WBOCCNTR,SP70
.           CALL      RDWBEEH2
.           BRANCH    OVRCD,TOEW1900
.
            MATCH     "HEALTH_FUND_UNAVAILABLE",WBEHPSCD
            GOTO      TOEW1000 IF NOT EQUAL
.
            GOTO      TOEW2000
.
          ENDIF
.
TOEW1900  MATCH     REQUSTAT,WBOCSTAT
          GOTO      TOEW1000 IF NOT EQUAL      * yes (filter)
.
TOEW2000  MOVE      AADMNO,PMVXVISN            * Find Visit extension record
          PACK      KEY8,PMVXVISN,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,TOEW5000
.
          IF        IBCNMHOS<>1
            GOTO      TOEW5000
          ENDIF
.
          MATCH     SP70,FILTHOSP
          IF        !@EQUAL
            MATCH     FILTHOSP,PMVXMHOS
            GOTO      TOEW1000 IF NOT EQUAL
          ELSE
            PACK      KEY13,USERID,SP70              * All hospital access
            CALL      RDMLSEC1
            IF        OVRCD=1
              PACK      KEY13,USERID,PMVXMHOS,SP70   * This hospital access
              CALL      RDMLSEC1
              BRANCH    OVRCD,TOEW1000
            ENDIF
          ENDIF
.
. Display the visit
.
TOEW5000  PACK      URNUMBER,AURNO
          PACK      ADMISSNO,AADMNO
          MOVE      AURNO,URNO
          CALL      GETPAT00      * Get Patient Details
          CALL      ADMDAT00      * Get Admission Date & Time
          CALL      PATLN000      * Format Patient Name with System Parameter
.
          MOVE      "Pre-admitted",STATUS20
.
          PACK      DSWOECST,SP70
          MOVE      WBOCSTAT,F2
          LOAD      DSWOECST,F2,DSPPMOE1,DSPPMOE2,DSPPMOE3,DSPPMOE4,DSPPMOE5:
                                DSPPMOE6,DSPPMOE7
.
          MATCH     " 0",WBOCSTAT
          IF        @EQUAL
            MOVE      DSPPMOE0,DSWOECST
          ENDIF
.
          MOVE      "CL",CATEGORY           * Claim code Description
          MOVE      ACLAIM,CODE
          CALL      GETCOD00
          MOVE      TDESC,CLAIMDES
.
          CALL      VOEC0000                * Validate criteria (set oecrflag)
.
          CALL      GETELW00
.
          MOVE      ZERO,REQUFLAG
          PACK      HTMLLINK,SP70,SP70,SP70,SP70
          CLEAR     HTMLLINK
          PACK      HTMLLNK3,SP70,SP70,SP70,SP70
          PACK      HTMLLNK4,SP70,SP70,SP70,SP70
          CLEAR     HTMLLNK3
          MATCH     "99",WBOCSTAT
          IF        !@EQUAL
            MOVE      ONE,REQUFLAG          * display icon if request exists
            APPEND    "javascript:ViewRequest('",HTMLLINK
            APPEND    WBOCVISN,HTMLLINK
            APPEND    "','",HTMLLINK
            APPEND    WBOCCNTR,HTMLLINK
            APPEND    "')",HTMLLINK
            RESET     HTMLLINK
.
            REP       " +",WBOCVISN
            REP       " +",WBOCCNTR
.
            APPEND    "<img src=../images/MaintenanceIcon.gif ",HTMLLNK3
            APPEND    "onclick=ViewRequest('",HTMLLNK3
            APPEND    WBOCVISN,HTMLLNK3
            APPEND    "','",HTMLLNK3
            APPEND    WBOCCNTR,HTMLLNK3
            APPEND    "');>&nbsp;",HTMLLNK3
            APPEND    DSWOECST,HTMLLNK3
            RESET     HTMLLNK3
.
            REP       "+ ",WBOCVISN
            REP       "+ ",WBOCCNTR
.
          ENDIF
.
          MOVE      ZERO,PELFFLAG
          CLEAR     HTMLLNKL
          MATCH     "99",WBOCSTAT
          IF        !@EQUAL
.            MATCH     SP70,WBEFELGN
.            IF        !@EQUAL
              MOVE      ONE,PELFFLAG
.
              REP       " +",WBOCURNO
              REP       " +",WBOCVISN
              REP       " +",WBOCCNTR
.
              APPEND    "<img src=../images/MaintenanceIcon.gif ",HTMLLNKL
              APPEND    "onclick=disOEC('",HTMLLNKL
              APPEND    WBOCURNO,HTMLLNKL
              APPEND    "','",HTMLLNKL
              APPEND    WBOCVISN,HTMLLNKL
              APPEND    "','",HTMLLNKL
              APPEND    WBOCCNTR,HTMLLNKL
              APPEND    "');>",HTMLLNKL
              RESET     HTMLLNKL
.
              CLEAR     HTMLLNK4
              APPEND    "<img src=../images/DocumentIcon.gif ",HTMLLNK4
              APPEND    "onclick=displayOEC('",HTMLLNK4
              APPEND    WBOCVISN,HTMLLNK4
              APPEND    WBOCCNTR,HTMLLNK4
              APPEND    "','",HTMLLNK4
              APPEND    WBOCURNO,HTMLLNK4
              APPEND    "','",HTMLLNK4
              APPEND    WBOCVISN,HTMLLNK4
              APPEND    "');>",HTMLLNK4
              RESET     HTMLLNK4
.
              REP       "+ ",WBOCURNO
              REP       "+ ",WBOCVISN
              REP       "+ ",WBOCCNTR
.            ENDIF
          ENDIF
.
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
          CLEAR     PATLINK
          APPEND    LINKPRG,PATLINK
          APPEND    ".pbl?reportno=",PATLINK
          APPEND    LINKREP,PATLINK
          APPEND    "&template=",PATLINK
          APPEND    LINKTEM,PATLINK
          APPEND    "&urnumber=",PATLINK
          APPEND    URNUMBER,PATLINK
          APPEND    "&admissno=",PATLINK
          APPEND    ADMISSNO,PATLINK
          RESET     PATLINK
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":        * 0
                             "#"",ADMISSNO,"#",":                 * 1
                             "#"",FORMATNM,"#",":                 * 2
                             "#"",CLAIMDES,"#",":                 * 3
                             "#"",AFUNDH,"#",":                   * 4
                             "#"",STATUS20,"#",":                 * 5
                             "#"",ADATE,"#",":                    * 6
                             "#"",DISPCOMP,"#",":                 * 7
                             "#"",DSWOECST,"#",":                 * 8
                    "#"",WBOCCDTE,WBOCCTIM,"#",":                 * 9
                             "#"",REQUFLAG,"#",";                 * 10
.
. Request checkbox: disable if mandatory fields incomplete (oecrflag=0)
.                   otherwise default to ticked (oecrflag=1)
.
          ADD       ONE,RECCNT                                    * 11
          MOVE      RECCNT,DRECCNT
          REP       " 0",DRECCNT
.
          MATCH     SP70,PMVXPILC
          IF        !@EQUAL & !@EOS
            MATCH     SP70,AMBS
            IF        !@EQUAL & !@EOS
              MOVE      ZERO,OECRFLAG
            ENDIF
          ENDIF
.
          IF        OECRFLAG<>1
            WRITE     HTMLFILE;"#"<input type=checkbox name=oereq",DRECCNT:
                      " disabled>";
          ELSE
            WRITE     HTMLFILE;"#"<input type=checkbox checked=true name=oereq":
                      DRECCNT:
                      " onClick=UpdateArray(this.value); value='",ADMISSNO:
                      OECRFLAG,"'>";
          ENDIF
.
.>>>>>    IF        OECRFLAG=1
            WRITE     HTMLFILE;"#",#"",PATLINK;
            CALL      PATFLD00
            WRITE     HTMLFILE;"#",#"",KEY3;
            WRITE     HTMLFILE;"#",#"",ADIAG1;
.
            MOVE      SP70,DOCFNAME
            MOVE      ADOCTA,KEY6
            CALL      RDDOCT1
            IF        OVRCD=0
              MOVE      DTITL,FMTTITLE
              MOVE      DGNAME,FMTGNAME
              MOVE      DSNAME,FMTSNAME
              CALL      DOCNM000
            ENDIF
.
            WRITE     HTMLFILE;"#",#"",DOCFNAME;
.
            IF        ELCHFLAG=ZERO
              WRITE     HTMLFILE;"#",#"<input type=checkbox name=oechk",DRECCNT:
                                 " disabled>";
            ELSE
              IF        ELCHFLAG=ONE
                WRITE     HTMLFILE;"#",#"<input type=checkbox name=oechk":
                                   DRECCNT:
                                   " onclick='UpdateElgCheck(this);'":
                                   " value='",ADMISSNO,"'>";
              ELSE
                WRITE     HTMLFILE;"#",#"<input type=checkbox checked name=oechk":
                                   DRECCNT:
                                   " onclick='UpdateElgCheck(this);'":
                                   " value='",ADMISSNO,"'>";
              ENDIF
            ENDIF
.
            MATCH     SP70,WBEHPSCD
            IF        @EQUAL | @EOS
              WRITE     HTMLFILE;"#",#"",HTMLLNKL,HTMLLNK4;
            ELSE
              WRITE     HTMLFILE;"#",#"",HTMLLNKL,HTMLLNK4,WBEHPSCD;
            ENDIF
.
            WRITE     HTMLFILE;"#",#"",HTMLLNK3;
.
            CALL      PRILW000
            CALL      MBSC0000
.
.           IF        OECRFLAG<>1
.             WRITE     HTMLFILE;"#",#"<input type=checkbox name=oeccn":
.                                  DRECCNT:
.                                  " disabled>";
.           ELSE
              MATCH     "1",PMVXPOEC
              IF        @EQUAL
              WRITE     HTMLFILE;"#",#"<input type=checkbox checked name=oeccn":
                                   DRECCNT:
                                   " onclick='UpdateOECConsent(this);'":
                                   " value='",ADMISSNO,"'>";
              ELSE
                WRITE     HTMLFILE;"#",#"<input type=checkbox name=oeccn":
                                   DRECCNT:
                                   " onclick='UpdateOECConsent(this);'":
                                   " value='",ADMISSNO,"'>";
              ENDIF
.           ENDIF
          WRITE     HTMLFILE;"#",#"",DISPCLSS;
          WRITE     HTMLFILE;"#",#"",DISPALTD;
.
          IF        OECRFLAG=1
            WRITE     HTMLFILE;"#");":
                               " UpdateArray('",ADMISSNO,OECRFLAG,"');"
          ELSE
            WRITE     HTMLFILE;"#");"
          ENDIF
.
          IF        RECCNT>=90
            WRITE     HTMLFILE;"alert('Limit of 90 records reached');"
            GOTO      TOEW9000
          ENDIF
.
          GOTO      TOEW1000
.
TOEW9000
TOEW9999  RETURN
+
.------------------------------------------------------------
. Get OECW Eligibility Number in webelfaf if available
.------------------------------------------------------------
GETELW00  MATCH     "99",WBOCSTAT
          GOTO      GETELW90 IF EQUAL
.
          PACK      KEY16,URNUMBER,SP70
          CALL      RSWBELF2
GETELW10  CALL      RKWBELF2
          BRANCH    OVRCD,GETELW90
.
          MATCH     WBOCURNO,WBEFURNO
          GOTO      GETELW90 IF NOT EQUAL
.
          MATCH     WBOCVISN,WBEFVISN
          GOTO      GETELW10 IF NOT EQUAL
.
          MATCH     WBOCCNTR,WBEFCNTR
          GOTO      GETELW10 IF NOT EQUAL
.
          GOTO      GETELW99
.
GETELW90  CALL      CLWEBELF
.
GETELW99  RETURN
+
.--------------------------------------------------------------------------
. Table of Theatre Bookings / Pre-Admissions for Online Eligibility Request
.--------------------------------------------------------------------------
BOEC0000  IF        LNK2PRT<>1
            UNPACK    DIM127,D1,LINKPRG,DIM127
            UNPACK    DIM127,D1,LINKREP,DIM127
            UNPACK    DIM127,D1,LINKTEM,DIM127
          ENDIF
          MOVE      ZERO,RECCNT
.
          MATCH     "1",PTCNWSIN
          GOTO      BOEC0500 IF NOT EQUAL
.
          MATCH     "1",PTCNOECW
          GOTO      BOEC0500 IF NOT EQUAL
.
          COMPARE   ONE,OECWINDC
          GOTO      BOEC0500 IF NOT EQUAL
.
          CALL      BOEW0000
          CALL      BOPW0000
          CALL      BOBW0000
.
BOEC0500  MATCH     "1",PTCNOECE
          GOTO      BOEC9000 IF EQUAL
.
          PACK      KEY16,FRSTDATE,SP70
          CALL      RSBKREC4
BOEC1000  CALL      RKBKREC4
          BRANCH    OVRCD,BOEC9000
.
          PACK      KEY8,DBKREBOO,SP70
          CALL      RDBKRX11
          BRANCH    OVRCD,BOEC1000
.
          MATCH     BKREEDAT,LASTDATE
          GOTO      BOEC9000 IF LESS
.
          IF        BKRESTAT<>1
            GOTO      BOEC1000
          ENDIF
.
          PACK      KEY8,DBKREBOO,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,BOEC1000
.
          COMPARE   "1",ASTAT
          GOTO      BOEC1000 IF NOT EQUAL
.
          MATCH     SP70,HEALTHFN
          IF        !@EQUAL
            MATCH     HEALTHFN,AFUNDH
            GOTO      BOEC1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,CLAIMTYP
          IF        !@EQUAL
            MATCH     ACLAIM,CLAIMTYP
            GOTO      BOEC1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTBOOK
          IF        !@EQUAL
.           PACK      KEY8,AADMNO,SP70
.           CALL      RDBKREC1
.           BRANCH    OVRCD,BOEC1000
.
            MATCH     FILTBOOK,BKRETYPE
            GOTO      BOEC1000 IF NOT EQUAL
.
          ENDIF
.
          MOVE      SP70,DISPCOMP
          MOVE      ZERO,ELCHFLAG
          PACK      KEY8,DAADMNO,SP70
          CALL      RDPTELG1
          BRANCH    OVRCD,BOEC1500
.
          IF        HOSPCOMP=1
            MATCH     "1",PTELCMPL
            IF        @EQUAL
              MOVE      "Complete",DISPCOMP   * display if elig. complete
              MOVE      TWO,ELCHFLAG
            ELSE
              MOVE      ONE,ELCHFLAG
            ENDIF
          ELSE
            MATCH     "1",PTELCMPL            * don't display if elig. complete
            GOTO      BOEC1000 IF EQUAL
.
            MOVE      ONE,ELCHFLAG
          ENDIF
.
BOEC1500  PACK      KEY11,DAADMNO,Z70
          CALL      RSPMOEC1
          CALL      RPPMOEC1                   * get last OEC request
          IF        OVRCD=1
            MOVE      "99",PMOESTAT            * no request status exists
            MOVE      SP70,PMOEUDTE
          ENDIF
.
          MATCH     DAADMNO,PMOEVISN
          IF        !@EQUAL
            MOVE      "99",PMOESTAT            * no request status exists
            MOVE      SP70,PMOEUDTE
          ENDIF
.
          MATCH     SP70,REQUSTAT
          GOTO      BOEC2000 IF EQUAL          * filter by request status ?
.
          MATCH     REQUSTAT,PMOESTAT
          GOTO      BOEC1000 IF NOT EQUAL      * yes (filter)
.
BOEC2000  MOVE      AADMNO,PMVXVISN            * Find Visit extension record
          PACK      KEY8,PMVXVISN,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,BOEC5000
.
          IF        IBCNMHOS<>1
            GOTO      BOEC5000
          ENDIF
.
          MATCH     SP70,FILTHOSP
          IF        !@EQUAL
            MATCH     FILTHOSP,PMVXMHOS
            GOTO      BOEC1000 IF NOT EQUAL
          ELSE
            PACK      KEY13,USERID,SP70              * All hospital access
            CALL      RDMLSEC1
            IF        OVRCD=1
              PACK      KEY13,USERID,PMVXMHOS,SP70   * This hospital access
              CALL      RDMLSEC1
              BRANCH    OVRCD,BOEC1000
            ENDIF
          ENDIF
.
. Display the visit
.
BOEC5000  PACK      URNUMBER,AURNO
          PACK      ADMISSNO,AADMNO
          MOVE      AURNO,URNO
          CALL      GETPAT00      * Get Patient Details
          CALL      ADMDAT00      * Get Admission Date & Time
          CALL      PATLN000      * Format Patient Name with System Parameter
.
          MOVE      "Pre-admitted",STATUS20
.
          PACK      DSPOECST,SP70
          MOVE      PMOESTAT,F2
          LOAD      DSPOECST,F2,DSPPMOE1,DSPPMOE2,DSPPMOE3,DSPPMOE4,DSPPMOE5:
                                DSPPMOE6,DSPPMOE7
.
          MATCH     " 0",PMOESTAT
          IF        @EQUAL
            MOVE      DSPPMOE0,DSPOECST
          ENDIF
.
          MOVE      "CL",CATEGORY           * Claim code Description
          MOVE      ACLAIM,CODE
          CALL      GETCOD00
          MOVE      TDESC,CLAIMDES
.
          CALL      VOEC0000                * Validate criteria (set oecrflag)
.
          CALL      GETELF00
.
          MOVE      ZERO,REQUFLAG
          PACK      HTMLLINK,SP70,SP70,SP70,SP70
          CLEAR     HTMLLINK
          PACK      HTMLLNK3,SP70,SP70,SP70,SP70
          CLEAR     HTMLLNK3
          MATCH     "99",PMOESTAT
          IF        !@EQUAL
            MOVE      ONE,REQUFLAG          * display icon if request exists
            APPEND    "javascript:ViewRequest('",HTMLLINK
            APPEND    PMOEVISN,HTMLLINK
            APPEND    "','",HTMLLINK
            APPEND    PMOECNTR,HTMLLINK
            APPEND    "')",HTMLLINK
            RESET     HTMLLINK
.
            REP       " +",PMOEVISN
            REP       " +",PMOECNTR
.
            APPEND    "<img src=../images/MaintenanceIcon.gif ",HTMLLNK3
            APPEND    "onclick=ViewRequest('",HTMLLNK3
            APPEND    PMOEVISN,HTMLLNK3
            APPEND    "','",HTMLLNK3
            APPEND    PMOECNTR,HTMLLNK3
            APPEND    "');>&nbsp;",HTMLLNK3
            APPEND    DSPOECST,HTMLLNK3
            RESET     HTMLLNK3
.
            REP       "+ ",PMOEVISN
            REP       "+ ",PMOECNTR
.
          ENDIF
.
          MOVE      ZERO,PELFFLAG
          CLEAR     HTMLLNKL
          MATCH     "99",PMOESTAT
          IF        !@EQUAL
.            MATCH     SP70,PMEFELGN
.            IF        !@EQUAL
              MOVE      ONE,PELFFLAG
.
              REP       " +",PMOEURNO
              REP       " +",PMOEVISN
              REP       " +",PMOECNTR
.
              APPEND    "<img src=../images/MaintenanceIcon.gif ",HTMLLNKL
              APPEND    "onclick=disOEC('",HTMLLNKL
              APPEND    PMOEURNO,HTMLLNKL
              APPEND    "','",HTMLLNKL
              APPEND    PMOEVISN,HTMLLNKL
              APPEND    "','",HTMLLNKL
              APPEND    PMOECNTR,HTMLLNKL
              APPEND    "');>",HTMLLNKL
              RESET     HTMLLNKL
.
              REP       "+ ",PMOEURNO
              REP       "+ ",PMOEVISN
              REP       "+ ",PMOECNTR
.            ENDIF
          ENDIF
.
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
          CLEAR     PATLINK
          APPEND    LINKPRG,PATLINK
          APPEND    ".pbl?reportno=",PATLINK
          APPEND    LINKREP,PATLINK
          APPEND    "&template=",PATLINK
          APPEND    LINKTEM,PATLINK
          APPEND    "&urnumber=",PATLINK
          APPEND    URNUMBER,PATLINK
          APPEND    "&admissno=",PATLINK
          APPEND    ADMISSNO,PATLINK
          RESET     PATLINK
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":        * 0
                             "#"",ADMISSNO,"#",":                 * 1
                             "#"",FORMATNM,"#",":                 * 2
                             "#"",CLAIMDES,"#",":                 * 3
                             "#"",AFUNDH,"#",":                   * 4
                             "#"",STATUS20,"#",":                 * 5
                             "#"",ADATE,"#",":                    * 6
                             "#"",DISPCOMP,"#",":                 * 7
                             "#"",DSPOECST,"#",":                 * 8
                    "#"",PMOECDTE,PMOECTIM,"#",":                 * 9
                             "#"",REQUFLAG,"#",";                 * 10
.
. Request checkbox: disable if mandatory fields incomplete (oecrflag=0)
.                   otherwise default to ticked (oecrflag=1)
.
          ADD       ONE,RECCNT                                    * 11
          MOVE      RECCNT,DRECCNT
          REP       " 0",DRECCNT
.
          MATCH     SP70,PMVXPILC
          IF        !@EQUAL & !@EOS
            MATCH     SP70,AMBS
            IF        !@EQUAL & !@EOS
              MOVE      ZERO,OECRFLAG
            ENDIF
          ENDIF
.
          IF        OECRFLAG<>1
            WRITE     HTMLFILE;"#"<input type=checkbox name=oereq",DRECCNT:
                      " disabled>";
          ELSE
            WRITE     HTMLFILE;"#"<input type=checkbox checked=true name=oereq":
                      DRECCNT:
                      " onClick=UpdateArray(this.value); value='",ADMISSNO:
                      OECRFLAG,"'>";
          ENDIF
.
.>>>>>    IF        OECRFLAG=1
            WRITE     HTMLFILE;"#",#"",PATLINK;
            CALL      PATFLD00
            WRITE     HTMLFILE;"#",#"",KEY3;
            WRITE     HTMLFILE;"#",#"",ADIAG1;
.
            MOVE      SP70,DOCFNAME
            MOVE      ADOCTA,KEY6
            CALL      RDDOCT1
            IF        OVRCD=0
              MOVE      DTITL,FMTTITLE
              MOVE      DGNAME,FMTGNAME
              MOVE      DSNAME,FMTSNAME
              CALL      DOCNM000
            ENDIF
.
            WRITE     HTMLFILE;"#",#"",DOCFNAME;
.
            IF        ELCHFLAG=ZERO
              WRITE     HTMLFILE;"#",#"<input type=checkbox name=oechk",DRECCNT:
                                 " disabled>";
            ELSE
              IF        ELCHFLAG=ONE
                WRITE     HTMLFILE;"#",#"<input type=checkbox name=oechk":
                                   DRECCNT:
                                   " onclick='UpdateElgCheck(this);'":
                                   " value='",ADMISSNO,"'>";
              ELSE
                WRITE     HTMLFILE;"#",#"<input type=checkbox checked name=oechk":
                                   DRECCNT:
                                   " onclick='UpdateElgCheck(this);'":
                                   " value='",ADMISSNO,"'>";
              ENDIF
            ENDIF
.
            WRITE     HTMLFILE;"#",#"",HTMLLNKL;
            WRITE     HTMLFILE;"#",#"",HTMLLNK3;
.
            CALL      PRILL000
            CALL      MBSC0000
.
.           IF        OECRFLAG<>1
.             WRITE     HTMLFILE;"#",#"<input type=checkbox name=oeccn":
.                                  DRECCNT:
.                                  " disabled>";
.           ELSE
              MATCH     "1",PMVXPOEC
              IF        @EQUAL
              WRITE     HTMLFILE;"#",#"<input type=checkbox checked name=oeccn":
                                   DRECCNT:
                                   " onclick='UpdateOECConsent(this);'":
                                   " value='",ADMISSNO,"'>";
              ELSE
                WRITE     HTMLFILE;"#",#"<input type=checkbox name=oeccn":
                                   DRECCNT:
                                   " onclick='UpdateOECConsent(this);'":
                                   " value='",ADMISSNO,"'>";
              ENDIF
.           ENDIF
.
.
          IF        OECRFLAG=1
            WRITE     HTMLFILE;"#");":
                               " UpdateArray('",ADMISSNO,OECRFLAG,"');"
          ELSE
            WRITE     HTMLFILE;"#");"
          ENDIF
.
          IF        RECCNT>=99
            WRITE     HTMLFILE;"alert('Limit of 99 records reached');"
            GOTO      BOEC9000
          ENDIF
.
          GOTO      BOEC1000
.
BOEC9000
BOEC9999  RETURN
+
.------------------------------------------------------------
. Table of Pre-Admissions for Online Eligibility Request
.------------------------------------------------------------
BOEW0000  PACK      KEY16,FRSTDATE,SP70
          CALL      RSBKREC4
BOEW1000  CALL      RKBKREC4
          BRANCH    OVRCD,BOEW9000
.
          PACK      KEY8,DBKREBOO,SP70
          CALL      RDBKRX11
          BRANCH    OVRCD,BOEW1000
.
          MATCH     BKREEDAT,LASTDATE
          GOTO      BOEW9000 IF LESS
.
          IF        BKRESTAT<>1
            GOTO      BOEW1000
          ENDIF
.
          PACK      KEY8,DBKREBOO,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,BOEW1000
.
          COMPARE   "1",ASTAT
          GOTO      BOEW1000 IF NOT EQUAL
.
          MATCH     SP70,HEALTHFN
          IF        !@EQUAL
            MATCH     HEALTHFN,AFUNDH
            GOTO      BOEW1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,CLAIMTYP
          IF        !@EQUAL
            MATCH     ACLAIM,CLAIMTYP
            GOTO      BOEW1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTBOOK
          IF        !@EQUAL
.           PACK      KEY8,AADMNO,SP70
.           CALL      RDBKREC1
.           BRANCH    OVRCD,BOEW1000
.
            MATCH     FILTBOOK,BKRETYPE
            GOTO      BOEW1000 IF NOT EQUAL
.
          ENDIF
.
          MOVE      SP70,DISPCOMP
          MOVE      ZERO,ELCHFLAG
          PACK      KEY8,DAADMNO,SP70
          CALL      RDPTELG1
          BRANCH    OVRCD,BOEW1500
.
          IF        HOSPCOMP=1
            MATCH     "1",PTELCMPL
            IF        @EQUAL
              MOVE      "Complete",DISPCOMP   * display if elig. complete
              MOVE      TWO,ELCHFLAG
            ELSE
              MOVE      ONE,ELCHFLAG
            ENDIF
          ELSE
            MATCH     "1",PTELCMPL            * don't display if elig. complete
            GOTO      BOEW1000 IF EQUAL
.
            MOVE      ONE,ELCHFLAG
          ENDIF
.
BOEW1500  PACK      KEY11,DAADMNO,Z70
          CALL      RSWBOEC1
          CALL      RPWBOEC1                   * get last OEC request
          IF        OVRCD=1
            CALL      CLWEBOEC
            MOVE      "99",WBOCSTAT            * no request status exists
            MOVE      SP70,WBOCUDTE
          ENDIF
.
          MATCH     DAADMNO,WBOCVISN
          IF        !@EQUAL
            CALL      CLWEBOEC
            MOVE      "99",WBOCSTAT            * no request status exists
            MOVE      SP70,WBOCUDTE
          ENDIF
.
          CALL      CLWEBEEH
.
          MATCH     SP70,WBOCTRID
          IF        !@EQUAL & !@EOS
            PACK      KEY47,WBOCTRID,WBOCARID,WBOCCNTR,SP70
            CALL      RDWBEEH2
            IF        OVRCD=1
              CALL      CLWEBEEH
            ENDIF
          ENDIF
.
          MATCH     SP70,REQUSTAT
          GOTO      BOEW2000 IF EQUAL          * filter by request status ?
.
          MATCH     " 5",REQUSTAT
          IF        @EQUAL
.
            MATCH     " 6",WBOCSTAT
            GOTO      BOEW1900 IF NOT EQUAL
.
.           MATCH     SP70,WBOCTRID
.           GOTO      BOEW1900 IF EQUAL
.           GOTO      BOEW1900 IF EOS
.
.           PACK      KEY47,WBOCTRID,WBOCARID,WBOCCNTR,SP70
.           CALL      RDWBEEH2
.           BRANCH    OVRCD,BOEW1900
.
            MATCH     "REJECTED",WBEHPSCD
            GOTO      BOEW1000 IF NOT EQUAL
.
            GOTO      BOEW2000
.
          ENDIF
.
          MATCH     " 6",REQUSTAT              * Match Complete Reported
          IF        @EQUAL
.
            MATCH     " 6",WBOCSTAT
            GOTO      BOEW1900 IF NOT EQUAL
.
.           MATCH     SP70,WBOCTRID
.           GOTO      BOEW1900 IF EQUAL
.           GOTO      BOEW1900 IF EOS
.
.           PACK      KEY47,WBOCTRID,WBOCARID,WBOCCNTR,SP70
.           CALL      RDWBEEH2
.           BRANCH    OVRCD,BOEW1900
.
            MATCH     "REJECTED",WBEHPSCD
            GOTO      BOEW1000 IF EQUAL
.
            MATCH     "HEALTH_FUND_UNAVAILABLE",WBEHPSCD
            GOTO      BOEW1000 IF EQUAL
.
            GOTO      BOEW2000
.
          ENDIF
.
          MATCH     " 7",REQUSTAT
          IF        @EQUAL
.
            MATCH     " 6",WBOCSTAT
            GOTO      BOEW1900 IF NOT EQUAL
.
.           MATCH     SP70,WBOCTRID
.           GOTO      BOEW1900 IF EQUAL
.           GOTO      BOEW1900 IF EOS
.
.           PACK      KEY47,WBOCTRID,WBOCARID,WBOCCNTR,SP70
.           CALL      RDWBEEH2
.           BRANCH    OVRCD,BOEW1900
.
            MATCH     "HEALTH_FUND_UNAVAILABLE",WBEHPSCD
            GOTO      BOEW1000 IF NOT EQUAL
.
            GOTO      BOEW2000
.
          ENDIF
.
BOEW1900  MATCH     REQUSTAT,WBOCSTAT
          GOTO      BOEW1000 IF NOT EQUAL      * yes (filter)
.
BOEW2000  MOVE      AADMNO,PMVXVISN            * Find Visit extension record
          PACK      KEY8,PMVXVISN,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,BOEW5000
.
          IF        IBCNMHOS<>1
            GOTO      BOEW5000
          ENDIF
.
          MATCH     SP70,FILTHOSP
          IF        !@EQUAL
            MATCH     FILTHOSP,PMVXMHOS
            GOTO      BOEW1000 IF NOT EQUAL
          ELSE
            PACK      KEY13,USERID,SP70              * All hospital access
            CALL      RDMLSEC1
            IF        OVRCD=1
              PACK      KEY13,USERID,PMVXMHOS,SP70   * This hospital access
              CALL      RDMLSEC1
              BRANCH    OVRCD,BOEW1000
            ENDIF
          ENDIF
.
. Display the visit
.
BOEW5000  PACK      URNUMBER,AURNO
          PACK      ADMISSNO,AADMNO
          MOVE      AURNO,URNO
          CALL      GETPAT00      * Get Patient Details
          CALL      ADMDAT00      * Get Admission Date & Time
          CALL      PATLN000      * Format Patient Name with System Parameter
.
          MOVE      "Pre-Admitted & Booked",STATUS25
.
          PACK      DSWOECST,SP70
          MOVE      WBOCSTAT,F2
          LOAD      DSWOECST,F2,DSPPMOE1,DSPPMOE2,DSPPMOE3,DSPPMOE4,DSPPMOE5:
                                DSPPMOE6,DSPPMOE7
.
          MATCH     " 0",WBOCSTAT
          IF        @EQUAL
            MOVE      DSPPMOE0,DSWOECST
          ENDIF
.
          MOVE      "CL",CATEGORY           * Claim code Description
          MOVE      ACLAIM,CODE
          CALL      GETCOD00
          MOVE      TDESC,CLAIMDES
.
          CALL      VOEC0000                * Validate criteria (set oecrflag)
.
          CALL      GETELW00
.
          MOVE      ZERO,REQUFLAG
          PACK      HTMLLINK,SP70,SP70,SP70,SP70
          CLEAR     HTMLLINK
          PACK      HTMLLNK3,SP70,SP70,SP70,SP70
          PACK      HTMLLNK4,SP70,SP70,SP70,SP70
          CLEAR     HTMLLNK3
          MATCH     "99",WBOCSTAT
          IF        !@EQUAL
            MOVE      ONE,REQUFLAG          * display icon if request exists
            APPEND    "javascript:ViewRequest('",HTMLLINK
            APPEND    WBOCVISN,HTMLLINK
            APPEND    "','",HTMLLINK
            APPEND    WBOCCNTR,HTMLLINK
            APPEND    "')",HTMLLINK
            RESET     HTMLLINK
.
            REP       " +",WBOCVISN
            REP       " +",WBOCCNTR
.
            APPEND    "<img src=../images/MaintenanceIcon.gif ",HTMLLNK3
            APPEND    "onclick=ViewRequest('",HTMLLNK3
            APPEND    WBOCVISN,HTMLLNK3
            APPEND    "','",HTMLLNK3
            APPEND    WBOCCNTR,HTMLLNK3
            APPEND    "');>&nbsp;",HTMLLNK3
            APPEND    DSWOECST,HTMLLNK3
            RESET     HTMLLNK3
.
            REP       "+ ",WBOCVISN
            REP       "+ ",WBOCCNTR
.
          ENDIF
.
          MOVE      ZERO,PELFFLAG
          CLEAR     HTMLLNKL
          CLEAR     HTMLLNK4
          MATCH     "99",WBOCSTAT
          IF        !@EQUAL
.            MATCH     SP70,WBEFELGN
.            IF        !@EQUAL
              MOVE      ONE,PELFFLAG
.
              REP       " +",WBOCURNO
              REP       " +",WBOCVISN
              REP       " +",WBOCCNTR
.
              APPEND    "<img src=../images/MaintenanceIcon.gif ",HTMLLNKL
              APPEND    "onclick=disOEC('",HTMLLNKL
              APPEND    WBOCURNO,HTMLLNKL
              APPEND    "','",HTMLLNKL
              APPEND    WBOCVISN,HTMLLNKL
              APPEND    "','",HTMLLNKL
              APPEND    WBOCCNTR,HTMLLNKL
              APPEND    "');>",HTMLLNKL
              RESET     HTMLLNKL
.
              PACK      HTMLLNK4,SP70,SP70,SP70,SP70
              CLEAR     HTMLLNK4
              APPEND    "<img src=../images/DocumentIcon.gif ",HTMLLNK4
              APPEND    "onclick=displayOEC('",HTMLLNK4
              APPEND    WBOCVISN,HTMLLNK4
              APPEND    WBOCCNTR,HTMLLNK4
              APPEND    "','",HTMLLNK4
              APPEND    WBOCURNO,HTMLLNK4
              APPEND    "','",HTMLLNK4
              APPEND    WBOCVISN,HTMLLNK4
              APPEND    "');>",HTMLLNK4
              RESET     HTMLLNK4
.
              REP       "+ ",WBOCURNO
              REP       "+ ",WBOCVISN
              REP       "+ ",WBOCCNTR
.            ENDIF
          ENDIF
.
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
          CLEAR     PATLINK
          APPEND    LINKPRG,PATLINK
          APPEND    ".pbl?reportno=",PATLINK
          APPEND    LINKREP,PATLINK
          APPEND    "&template=",PATLINK
          APPEND    LINKTEM,PATLINK
          APPEND    "&urnumber=",PATLINK
          APPEND    URNUMBER,PATLINK
          APPEND    "&admissno=",PATLINK
          APPEND    ADMISSNO,PATLINK
          RESET     PATLINK
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":        * 0
                             "#"",ADMISSNO,"#",":                 * 1
                             "#"",FORMATNM,"#",":                 * 2
                             "#"",CLAIMDES,"#",":                 * 3
                             "#"",AFUNDH,"#",":                   * 4
                             "#"",STATUS25,"#",":                 * 5
                             "#"",ADATE,"#",":                    * 6
                             "#"",DISPCOMP,"#",":                 * 7
                             "#"",DSWOECST,"#",":                 * 8
                    "#"",WBOCCDTE,WBOCCTIM,"#",":                 * 9
                             "#"",REQUFLAG,"#",";                 * 10
.
. Request checkbox: disable if mandatory fields incomplete (oecrflag=0)
.                   otherwise default to ticked (oecrflag=1)
.
          ADD       ONE,RECCNT                                    * 11
          MOVE      RECCNT,DRECCNT
          REP       " 0",DRECCNT
.
          MATCH     SP70,PMVXPILC
          IF        !@EQUAL & !@EOS
            MATCH     SP70,AMBS
            IF        !@EQUAL & !@EOS
              MOVE      ZERO,OECRFLAG
            ENDIF
          ENDIF
.
          IF        OECRFLAG<>1
            WRITE     HTMLFILE;"#"<input type=checkbox name=oereq",DRECCNT:
                      " disabled><br>OECW fields incomplete";
          ELSE
            WRITE     HTMLFILE;"#"<input type=checkbox checked=true name=oereq":
                      DRECCNT:
                      " onClick=UpdateArray(this.value); value='",ADMISSNO:
                      OECRFLAG,"'>";
          ENDIF
.
.>>>>>    IF        OECRFLAG=1
            WRITE     HTMLFILE;"#",#"",PATLINK;
            CALL      PATFLD00
            WRITE     HTMLFILE;"#",#"",KEY3;
            WRITE     HTMLFILE;"#",#"",ADIAG1;
.
            MOVE      SP70,DOCFNAME
            MOVE      ADOCTA,KEY6
            CALL      RDDOCT1
            IF        OVRCD=0
              MOVE      DTITL,FMTTITLE
              MOVE      DGNAME,FMTGNAME
              MOVE      DSNAME,FMTSNAME
              CALL      DOCNM000
            ENDIF
.
            WRITE     HTMLFILE;"#",#"",DOCFNAME;
.
            IF        ELCHFLAG=ZERO
              WRITE     HTMLFILE;"#",#"<input type=checkbox name=oechk",DRECCNT:
                                 " disabled>";
            ELSE
              IF        ELCHFLAG=ONE
                WRITE     HTMLFILE;"#",#"<input type=checkbox name=oechk":
                                   DRECCNT:
                                   " onclick='UpdateElgCheck(this);'":
                                   " value='",ADMISSNO,"'>";
              ELSE
                WRITE     HTMLFILE;"#",#"<input type=checkbox checked name=oechk":
                                   DRECCNT:
                                   " onclick='UpdateElgCheck(this);'":
                                   " value='",ADMISSNO,"'>";
              ENDIF
            ENDIF
.
            MATCH     SP70,WBEHPSCD
            IF        @EQUAL | @EOS
              WRITE     HTMLFILE;"#",#"",HTMLLNKL,HTMLLNK4;
            ELSE
              WRITE     HTMLFILE;"#",#"",HTMLLNKL,HTMLLNK4,WBEHPSCD;
            ENDIF
.
            WRITE     HTMLFILE;"#",#"",HTMLLNK3;
.
            CALL      PRILW000
            CALL      MBSC0000
.
.           IF        OECRFLAG<>1
.             WRITE     HTMLFILE;"#",#"<input type=checkbox name=oeccn":
.                                  DRECCNT:
.                                  " disabled>";
.           ELSE
              MATCH     "1",PMVXPOEC
              IF        @EQUAL
              WRITE     HTMLFILE;"#",#"<input type=checkbox checked name=oeccn":
                                   DRECCNT:
                                   " onclick='UpdateOECConsent(this);'":
                                   " value='",ADMISSNO,"'>";
              ELSE
                WRITE     HTMLFILE;"#",#"<input type=checkbox name=oeccn":
                                   DRECCNT:
                                   " onclick='UpdateOECConsent(this);'":
                                   " value='",ADMISSNO,"'>";
              ENDIF
.           ENDIF
.
          IF        OECRFLAG=1
            WRITE     HTMLFILE;"#");":
                               " UpdateArray('",ADMISSNO,OECRFLAG,"');"
          ELSE
            WRITE     HTMLFILE;"#");"
          ENDIF
.
          IF        RECCNT>=99
            WRITE     HTMLFILE;"alert('Limit of 99 records reached');"
            GOTO      BOEW9000
          ENDIF
.
          GOTO      BOEW1000
.
BOEW9000
BOEW9999  RETURN
+
.--------------------------------------------------------------------------
. Table of Theatre Bookings / Pre-Admissions for Online Eligibility Request
. Sorted by Date Booking Created (bokrx1af)
.--------------------------------------------------------------------------
COEC0000  IF        LNK2PRT<>1
            UNPACK    DIM127,D1,LINKPRG,DIM127
            UNPACK    DIM127,D1,LINKREP,DIM127
            UNPACK    DIM127,D1,LINKTEM,DIM127
          ENDIF
          MOVE      ZERO,RECCNT
.
          MATCH     "1",PTCNWSIN
          GOTO      COEC0500 IF NOT EQUAL
.
          MATCH     "1",PTCNOECW
          GOTO      COEC0500 IF NOT EQUAL
.
          COMPARE   ONE,OECWINDC
          GOTO      COEC0500 IF NOT EQUAL
.
          CALL      COEW0000
          CALL      COPW0000 
          CALL      COBW0000
.
COEC0500  MATCH     "1",PTCNOECE
          GOTO      COEC9000 IF EQUAL
.
          PACK      KEY16,FRSTDATE,SP70
          CALL      RSBKRX12
COEC1000  CALL      RKBKRX12
          BRANCH    OVRCD,COEC9000
.
          PACK      KEY8,BKRXBNUM,SP70
          CALL      RDBKREC1
          BRANCH    OVRCD,COEC1000
.
          MATCH     BKRXCRDT,LASTDATE
          GOTO      COEC9000 IF LESS
.
          IF        BKRESTAT<>1
            GOTO      COEC1000
          ENDIF
.
          PACK      KEY8,DBKREBOO,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,COEC1000
.
          COMPARE   "1",ASTAT
          GOTO      COEC1000 IF NOT EQUAL
.
          MATCH     SP70,HEALTHFN
          IF        !@EQUAL
            MATCH     HEALTHFN,AFUNDH
            GOTO      COEC1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,CLAIMTYP
          IF        !@EQUAL
            MATCH     ACLAIM,CLAIMTYP
            GOTO      COEC1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTBOOK
          IF        !@EQUAL
.           PACK      KEY8,AADMNO,SP70
.           CALL      RDBKREC1
.           BRANCH    OVRCD,COEC1000
.
            MATCH     FILTBOOK,BKRETYPE
            GOTO      COEC1000 IF NOT EQUAL
.
          ENDIF
.
          MOVE      SP70,DISPCOMP
          MOVE      ZERO,ELCHFLAG
          PACK      KEY8,DAADMNO,SP70
          CALL      RDPTELG1
          BRANCH    OVRCD,COEC1500
.
          IF        HOSPCOMP=1
            MATCH     "1",PTELCMPL
            IF        @EQUAL
              MOVE      "Complete",DISPCOMP   * display if elig. complete
              MOVE      TWO,ELCHFLAG
            ELSE
              MOVE      ONE,ELCHFLAG
            ENDIF
          ELSE
            MATCH     "1",PTELCMPL            * don't display if elig. complete
            GOTO      COEC1000 IF EQUAL
.
            MOVE      ONE,ELCHFLAG
          ENDIF
.
COEC1500  PACK      KEY11,DAADMNO,Z70
          CALL      RSPMOEC1
          CALL      RPPMOEC1                   * get last OEC request
          IF        OVRCD=1
            MOVE      "99",PMOESTAT            * no request status exists
            MOVE      SP70,PMOEUDTE
          ENDIF
.
          MATCH     DAADMNO,PMOEVISN
          IF        !@EQUAL
            MOVE      "99",PMOESTAT            * no request status exists
            MOVE      SP70,PMOEUDTE
          ENDIF
.
          MATCH     SP70,REQUSTAT
          GOTO      COEC2000 IF EQUAL          * filter by request status ?
.
          MATCH     REQUSTAT,PMOESTAT
          GOTO      COEC1000 IF NOT EQUAL      * yes (filter)
.
COEC2000  MOVE      AADMNO,PMVXVISN            * Find Visit extension record
          PACK      KEY8,PMVXVISN,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,COEC5000
.
          IF        IBCNMHOS<>1
            GOTO      COEC5000
          ENDIF
.
          MATCH     SP70,FILTHOSP
          IF        !@EQUAL
            MATCH     FILTHOSP,PMVXMHOS
            GOTO      COEC1000 IF NOT EQUAL
          ELSE
            PACK      KEY13,USERID,SP70              * All hospital access
            CALL      RDMLSEC1
            IF        OVRCD=1
              PACK      KEY13,USERID,PMVXMHOS,SP70   * This hospital access
              CALL      RDMLSEC1
              BRANCH    OVRCD,COEC1000
            ENDIF
          ENDIF
.
. Display the visit
.
COEC5000  PACK      URNUMBER,AURNO
          PACK      ADMISSNO,AADMNO
          MOVE      AURNO,URNO
          CALL      GETPAT00      * Get Patient Details
          CALL      ADMDAT00      * Get Admission Date & Time
          CALL      PATLN000      * Format Patient Name with System Parameter
.
          MOVE      "Pre-admitted",STATUS20
.
          PACK      DSPOECST,SP70
          MOVE      PMOESTAT,F2
          LOAD      DSPOECST,F2,DSPPMOE1,DSPPMOE2,DSPPMOE3,DSPPMOE4,DSPPMOE5:
                                DSPPMOE6,DSPPMOE7
.
          MATCH     " 0",PMOESTAT
          IF        @EQUAL
            MOVE      DSPPMOE0,DSPOECST
          ENDIF
.
          MOVE      "CL",CATEGORY           * Claim code Description
          MOVE      ACLAIM,CODE
          CALL      GETCOD00
          MOVE      TDESC,CLAIMDES
.
          CALL      VOEC0000                * Validate criteria (set oecrflag)
.
          CALL      GETELF00
.
          MOVE      ZERO,REQUFLAG
          PACK      HTMLLINK,SP70,SP70,SP70,SP70
          CLEAR     HTMLLINK
          PACK      HTMLLNK3,SP70,SP70,SP70,SP70
          CLEAR     HTMLLNK3
          MATCH     "99",PMOESTAT
          IF        !@EQUAL
            MOVE      ONE,REQUFLAG          * display icon if request exists
            APPEND    "javascript:ViewRequest('",HTMLLINK
            APPEND    PMOEVISN,HTMLLINK
            APPEND    "','",HTMLLINK
            APPEND    PMOECNTR,HTMLLINK
            APPEND    "')",HTMLLINK
            RESET     HTMLLINK
.
            REP       " +",PMOEVISN
            REP       " +",PMOECNTR
.
            APPEND    "<img src=../images/MaintenanceIcon.gif ",HTMLLNK3
            APPEND    "onclick=ViewRequest('",HTMLLNK3
            APPEND    PMOEVISN,HTMLLNK3
            APPEND    "','",HTMLLNK3
            APPEND    PMOECNTR,HTMLLNK3
            APPEND    "');>&nbsp;",HTMLLNK3
            APPEND    DSPOECST,HTMLLNK3
            RESET     HTMLLNK3
.
            REP       "+ ",PMOEVISN
            REP       "+ ",PMOECNTR
.
          ENDIF
.
          MOVE      ZERO,PELFFLAG
          CLEAR     HTMLLNKL
          MATCH     "99",PMOESTAT
          IF        !@EQUAL
.            MATCH     SP70,PMEFELGN
.            IF        !@EQUAL
              MOVE      ONE,PELFFLAG
.
              REP       " +",PMOEURNO
              REP       " +",PMOEVISN
              REP       " +",PMOECNTR
.
              APPEND    "<img src=../images/MaintenanceIcon.gif ",HTMLLNKL
              APPEND    "onclick=disOEC('",HTMLLNKL
              APPEND    PMOEURNO,HTMLLNKL
              APPEND    "','",HTMLLNKL
              APPEND    PMOEVISN,HTMLLNKL
              APPEND    "','",HTMLLNKL
              APPEND    PMOECNTR,HTMLLNKL
              APPEND    "');>",HTMLLNKL
              RESET     HTMLLNKL
.
              REP       "+ ",PMOEURNO
              REP       "+ ",PMOEVISN
              REP       "+ ",PMOECNTR
.            ENDIF
          ENDIF
.
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
          CLEAR     PATLINK
          APPEND    LINKPRG,PATLINK
          APPEND    ".pbl?reportno=",PATLINK
          APPEND    LINKREP,PATLINK
          APPEND    "&template=",PATLINK
          APPEND    LINKTEM,PATLINK
          APPEND    "&urnumber=",PATLINK
          APPEND    URNUMBER,PATLINK
          APPEND    "&admissno=",PATLINK
          APPEND    ADMISSNO,PATLINK
          RESET     PATLINK
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":        * 0
                             "#"",ADMISSNO,"#",":                 * 1
                             "#"",FORMATNM,"#",":                 * 2
                             "#"",CLAIMDES,"#",":                 * 3
                             "#"",AFUNDH,"#",":                   * 4
                             "#"",STATUS20,"#",":                 * 5
                             "#"",ADATE,"#",":                    * 6
                             "#"",DISPCOMP,"#",":                 * 7
                             "#"",DSPOECST,"#",":                 * 8
                    "#"",PMOECDTE,PMOECTIM,"#",":                 * 9
                             "#"",REQUFLAG,"#",";                 * 10
.
. Request checkbox: disable if mandatory fields incomplete (oecrflag=0)
.                   otherwise default to ticked (oecrflag=1)
.
          ADD       ONE,RECCNT                                    * 11
          MOVE      RECCNT,DRECCNT
          REP       " 0",DRECCNT
.
          MATCH     SP70,PMVXPILC
          IF        !@EQUAL & !@EOS
            MATCH     SP70,AMBS
            IF        !@EQUAL & !@EOS
              MOVE      ZERO,OECRFLAG
            ENDIF
          ENDIF
.
          IF        OECRFLAG<>1
            WRITE     HTMLFILE;"#"<input type=checkbox name=oereq",DRECCNT:
                      " disabled>";
          ELSE
            WRITE     HTMLFILE;"#"<input type=checkbox checked=true name=oereq":
                      DRECCNT:
                      " onClick=UpdateArray(this.value); value='",ADMISSNO:
                      OECRFLAG,"'>";
          ENDIF
.
.>>>>>    IF        OECRFLAG=1
            WRITE     HTMLFILE;"#",#"",PATLINK;
            CALL      PATFLD00
            WRITE     HTMLFILE;"#",#"",KEY3;
            WRITE     HTMLFILE;"#",#"",ADIAG1;
.
            MOVE      SP70,DOCFNAME
            MOVE      ADOCTA,KEY6
            CALL      RDDOCT1
            IF        OVRCD=0
              MOVE      DTITL,FMTTITLE
              MOVE      DGNAME,FMTGNAME
              MOVE      DSNAME,FMTSNAME
              CALL      DOCNM000
            ENDIF
.
            WRITE     HTMLFILE;"#",#"",DOCFNAME;
.
            IF        ELCHFLAG=ZERO
              WRITE     HTMLFILE;"#",#"<input type=checkbox name=oechk",DRECCNT:
                                 " disabled>";
            ELSE
              IF        ELCHFLAG=ONE
                WRITE     HTMLFILE;"#",#"<input type=checkbox name=oechk":
                                   DRECCNT:
                                   " onclick='UpdateElgCheck(this);'":
                                   " value='",ADMISSNO,"'>";
              ELSE
                WRITE     HTMLFILE;"#",#"<input type=checkbox checked name=oechk":
                                   DRECCNT:
                                   " onclick='UpdateElgCheck(this);'":
                                   " value='",ADMISSNO,"'>";
              ENDIF
            ENDIF
.
            WRITE     HTMLFILE;"#",#"",HTMLLNKL;
            WRITE     HTMLFILE;"#",#"",HTMLLNK3;
.
            CALL      PRILL000
            CALL      MBSC0000
.
.           IF        OECRFLAG<>1
.             WRITE     HTMLFILE;"#",#"<input type=checkbox name=oeccn":
.                                  DRECCNT:
.                                  " disabled>";
.           ELSE
              MATCH     "1",PMVXPOEC
              IF        @EQUAL
              WRITE     HTMLFILE;"#",#"<input type=checkbox checked name=oeccn":
                                   DRECCNT:
                                   " onclick='UpdateOECConsent(this);'":
                                   " value='",ADMISSNO,"'>";
              ELSE
                WRITE     HTMLFILE;"#",#"<input type=checkbox name=oeccn":
                                   DRECCNT:
                                   " onclick='UpdateOECConsent(this);'":
                                   " value='",ADMISSNO,"'>";
              ENDIF
.           ENDIF
.
.
          IF        OECRFLAG=1
            WRITE     HTMLFILE;"#");":
                               " UpdateArray('",ADMISSNO,OECRFLAG,"');"
          ELSE
            WRITE     HTMLFILE;"#");"
          ENDIF
.
          IF        RECCNT>=99
            WRITE     HTMLFILE;"alert('Limit of 99 records reached');"
            GOTO      COEC9000
          ENDIF
.
          GOTO      COEC1000
.
COEC9000
COEC9999  RETURN
+
.------------------------------------------------------------
. Table of Pre-Admissions for Online Eligibility Request
.------------------------------------------------------------
COEW0000  PACK      KEY16,FRSTDATE,SP70
          CALL      RSBKRX12
COEW1000  CALL      RKBKRX12
          BRANCH    OVRCD,COEW9000
.
          PACK      KEY8,BKRXBNUM,SP70
          CALL      RDBKREC1
          BRANCH    OVRCD,COEW1000
.
          MATCH     BKRXCRDT,LASTDATE
          GOTO      COEW9000 IF LESS
.
          IF        BKRESTAT<>1
            GOTO      COEW1000
          ENDIF
.
          PACK      KEY8,DBKREBOO,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,COEW1000
.
          COMPARE   "1",ASTAT
          GOTO      COEW1000 IF NOT EQUAL
.
          MATCH     SP70,HEALTHFN
          IF        !@EQUAL
            MATCH     HEALTHFN,AFUNDH
            GOTO      COEW1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,CLAIMTYP
          IF        !@EQUAL
            MATCH     ACLAIM,CLAIMTYP
            GOTO      COEW1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTBOOK
          IF        !@EQUAL
.           PACK      KEY8,AADMNO,SP70
.           CALL      RDBKREC1
.           BRANCH    OVRCD,COEW1000
.
            MATCH     FILTBOOK,BKRETYPE
            GOTO      COEW1000 IF NOT EQUAL
.
          ENDIF
.
          MOVE      SP70,DISPCOMP
          MOVE      ZERO,ELCHFLAG
          PACK      KEY8,DAADMNO,SP70
          CALL      RDPTELG1
          BRANCH    OVRCD,COEW1500
.
          IF        HOSPCOMP=1
            MATCH     "1",PTELCMPL
            IF        @EQUAL
              MOVE      "Complete",DISPCOMP   * display if elig. complete
              MOVE      TWO,ELCHFLAG
            ELSE
              MOVE      ONE,ELCHFLAG
            ENDIF
          ELSE
            MATCH     "1",PTELCMPL            * don't display if elig. complete
            GOTO      COEW1000 IF EQUAL
.
            MOVE      ONE,ELCHFLAG
          ENDIF
.
COEW1500  PACK      KEY11,DAADMNO,Z70
          CALL      RSWBOEC1
          CALL      RPWBOEC1                   * get last OEC request
          IF        OVRCD=1
            CALL      CLWEBOEC
            MOVE      "99",WBOCSTAT            * no request status exists
            MOVE      SP70,WBOCUDTE
          ENDIF
.
          MATCH     DAADMNO,WBOCVISN
          IF        !@EQUAL
            CALL      CLWEBOEC
            MOVE      "99",WBOCSTAT            * no request status exists
            MOVE      SP70,WBOCUDTE
          ENDIF
.
          CALL      CLWEBEEH
.
          MATCH     SP70,WBOCTRID
          IF        !@EQUAL & !@EOS
            PACK      KEY47,WBOCTRID,WBOCARID,WBOCCNTR,SP70
            CALL      RDWBEEH2
            IF        OVRCD=1
              CALL      CLWEBEEH
            ENDIF
          ENDIF
.
          MATCH     SP70,REQUSTAT
          GOTO      COEW2000 IF EQUAL          * filter by request status ?
.
          MATCH     " 5",REQUSTAT
          IF        @EQUAL
.
            MATCH     " 6",WBOCSTAT
            GOTO      COEW1900 IF NOT EQUAL
.
.           MATCH     SP70,WBOCTRID
.           GOTO      COEW1900 IF EQUAL
.           GOTO      COEW1900 IF EOS
.
.           PACK      KEY47,WBOCTRID,WBOCARID,WBOCCNTR,SP70
.           CALL      RDWBEEH2
.           BRANCH    OVRCD,COEW1900
.
            MATCH     "REJECTED",WBEHPSCD
            GOTO      COEW1000 IF NOT EQUAL
.
            GOTO      COEW2000
.
          ENDIF
.
          MATCH     " 6",REQUSTAT              * Match Complete Reported
          IF        @EQUAL
.
            MATCH     " 6",WBOCSTAT
            GOTO      COEW1900 IF NOT EQUAL
.
.           MATCH     SP70,WBOCTRID
.           GOTO      COEW1900 IF EQUAL
.           GOTO      COEW1900 IF EOS
.
.           PACK      KEY47,WBOCTRID,WBOCARID,WBOCCNTR,SP70
.           CALL      RDWBEEH2
.           BRANCH    OVRCD,COEW1900
.
            MATCH     "REJECTED",WBEHPSCD
            GOTO      COEW1000 IF EQUAL
.
            MATCH     "HEALTH_FUND_UNAVAILABLE",WBEHPSCD
            GOTO      COEW1000 IF EQUAL
.
            GOTO      COEW2000
.
          ENDIF
.
          MATCH     " 7",REQUSTAT
          IF        @EQUAL
.
            MATCH     " 6",WBOCSTAT
            GOTO      COEW1900 IF NOT EQUAL
.
.           MATCH     SP70,WBOCTRID
.           GOTO      COEW1900 IF EQUAL
.           GOTO      COEW1900 IF EOS
.
.           PACK      KEY47,WBOCTRID,WBOCARID,WBOCCNTR,SP70
.           CALL      RDWBEEH2
.           BRANCH    OVRCD,COEW1900
.
            MATCH     "HEALTH_FUND_UNAVAILABLE",WBEHPSCD
            GOTO      COEW1000 IF NOT EQUAL
.
            GOTO      COEW2000
.
          ENDIF
.
COEW1900  MATCH     REQUSTAT,WBOCSTAT
          GOTO      COEW1000 IF NOT EQUAL      * yes (filter)
.
COEW2000  MOVE      AADMNO,PMVXVISN            * Find Visit extension record
          PACK      KEY8,PMVXVISN,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,COEW5000
.
          IF        IBCNMHOS<>1
            GOTO      COEW5000
          ENDIF
.
          MATCH     SP70,FILTHOSP
          IF        !@EQUAL
            MATCH     FILTHOSP,PMVXMHOS
            GOTO      COEW1000 IF NOT EQUAL
          ELSE
            PACK      KEY13,USERID,SP70              * All hospital access
            CALL      RDMLSEC1
            IF        OVRCD=1
              PACK      KEY13,USERID,PMVXMHOS,SP70   * This hospital access
              CALL      RDMLSEC1
              BRANCH    OVRCD,COEW1000
            ENDIF
          ENDIF
.
. Display the visit
.
COEW5000  PACK      URNUMBER,AURNO
          PACK      ADMISSNO,AADMNO
          MOVE      AURNO,URNO
          CALL      GETPAT00      * Get Patient Details
          CALL      ADMDAT00      * Get Admission Date & Time
          CALL      PATLN000      * Format Patient Name with System Parameter
.
          MOVE      "Pre-Admitted & Booked",STATUS25
.
          PACK      DSWOECST,SP70
          MOVE      WBOCSTAT,F2
          LOAD      DSWOECST,F2,DSPPMOE1,DSPPMOE2,DSPPMOE3,DSPPMOE4,DSPPMOE5:
                                DSPPMOE6,DSPPMOE7
.
          MATCH     " 0",WBOCSTAT
          IF        @EQUAL
            MOVE      DSPPMOE0,DSWOECST
          ENDIF
.
          MOVE      "CL",CATEGORY           * Claim code Description
          MOVE      ACLAIM,CODE
          CALL      GETCOD00
          MOVE      TDESC,CLAIMDES
.
          CALL      VOEC0000                * Validate criteria (set oecrflag)
.
          CALL      GETELW00
.
          MOVE      ZERO,REQUFLAG
          PACK      HTMLLINK,SP70,SP70,SP70,SP70
          CLEAR     HTMLLINK
          PACK      HTMLLNK3,SP70,SP70,SP70,SP70
          PACK      HTMLLNK4,SP70,SP70,SP70,SP70
          CLEAR     HTMLLNK3
          MATCH     "99",WBOCSTAT
          IF        !@EQUAL
            MOVE      ONE,REQUFLAG          * display icon if request exists
            APPEND    "javascript:ViewRequest('",HTMLLINK
            APPEND    WBOCVISN,HTMLLINK
            APPEND    "','",HTMLLINK
            APPEND    WBOCCNTR,HTMLLINK
            APPEND    "')",HTMLLINK
            RESET     HTMLLINK
.
            REP       " +",WBOCVISN
            REP       " +",WBOCCNTR
.
            APPEND    "<img src=../images/MaintenanceIcon.gif ",HTMLLNK3
            APPEND    "onclick=ViewRequest('",HTMLLNK3
            APPEND    WBOCVISN,HTMLLNK3
            APPEND    "','",HTMLLNK3
            APPEND    WBOCCNTR,HTMLLNK3
            APPEND    "');>&nbsp;",HTMLLNK3
            APPEND    DSWOECST,HTMLLNK3
            RESET     HTMLLNK3
.
            REP       "+ ",WBOCVISN
            REP       "+ ",WBOCCNTR
.
          ENDIF
.
          MOVE      ZERO,PELFFLAG
          CLEAR     HTMLLNKL
          CLEAR     HTMLLNK4
          MATCH     "99",WBOCSTAT
          IF        !@EQUAL
.            MATCH     SP70,WBEFELGN
.            IF        !@EQUAL
              MOVE      ONE,PELFFLAG
.
              REP       " +",WBOCURNO
              REP       " +",WBOCVISN
              REP       " +",WBOCCNTR
.
              APPEND    "<img src=../images/MaintenanceIcon.gif ",HTMLLNKL
              APPEND    "onclick=disOEC('",HTMLLNKL
              APPEND    WBOCURNO,HTMLLNKL
              APPEND    "','",HTMLLNKL
              APPEND    WBOCVISN,HTMLLNKL
              APPEND    "','",HTMLLNKL
              APPEND    WBOCCNTR,HTMLLNKL
              APPEND    "');>",HTMLLNKL
              RESET     HTMLLNKL
.
              PACK      HTMLLNK4,SP70,SP70,SP70,SP70
              CLEAR     HTMLLNK4
              APPEND    "<img src=../images/DocumentIcon.gif ",HTMLLNK4
              APPEND    "onclick=displayOEC('",HTMLLNK4
              APPEND    WBOCVISN,HTMLLNK4
              APPEND    WBOCCNTR,HTMLLNK4
              APPEND    "','",HTMLLNK4
              APPEND    WBOCURNO,HTMLLNK4
              APPEND    "','",HTMLLNK4
              APPEND    WBOCVISN,HTMLLNK4
              APPEND    "');>",HTMLLNK4
              RESET     HTMLLNK4
.
              REP       "+ ",WBOCURNO
              REP       "+ ",WBOCVISN
              REP       "+ ",WBOCCNTR
.            ENDIF
          ENDIF
.
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
          CLEAR     PATLINK
          APPEND    LINKPRG,PATLINK
          APPEND    ".pbl?reportno=",PATLINK
          APPEND    LINKREP,PATLINK
          APPEND    "&template=",PATLINK
          APPEND    LINKTEM,PATLINK
          APPEND    "&urnumber=",PATLINK
          APPEND    URNUMBER,PATLINK
          APPEND    "&admissno=",PATLINK
          APPEND    ADMISSNO,PATLINK
          RESET     PATLINK
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":        * 0
                             "#"",ADMISSNO,"#",":                 * 1
                             "#"",FORMATNM,"#",":                 * 2
                             "#"",CLAIMDES,"#",":                 * 3
                             "#"",AFUNDH,"#",":                   * 4
                             "#"",STATUS25,"#",":                 * 5
                             "#"",ADATE,"#",":                    * 6
                             "#"",DISPCOMP,"#",":                 * 7
                             "#"",DSWOECST,"#",":                 * 8
                    "#"",WBOCCDTE,WBOCCTIM,"#",":                 * 9
                             "#"",REQUFLAG,"#",";                 * 10
.
. Request checkbox: disable if mandatory fields incomplete (oecrflag=0)
.                   otherwise default to ticked (oecrflag=1)
.
          ADD       ONE,RECCNT                                    * 11
          MOVE      RECCNT,DRECCNT
          REP       " 0",DRECCNT
.
          MATCH     SP70,PMVXPILC
          IF        !@EQUAL & !@EOS
            MATCH     SP70,AMBS
            IF        !@EQUAL & !@EOS
              MOVE      ZERO,OECRFLAG
            ENDIF
          ENDIF
.
          IF        OECRFLAG<>1
            WRITE     HTMLFILE;"#"<input type=checkbox name=oereq",DRECCNT:
                      " disabled><br>OECW fields incomplete";
          ELSE
            WRITE     HTMLFILE;"#"<input type=checkbox checked=true name=oereq":
                      DRECCNT:
                      " onClick=UpdateArray(this.value); value='",ADMISSNO:
                      OECRFLAG,"'>";
          ENDIF
.
.>>>>>    IF        OECRFLAG=1
            WRITE     HTMLFILE;"#",#"",PATLINK;
            CALL      PATFLD00
            WRITE     HTMLFILE;"#",#"",KEY3;
            WRITE     HTMLFILE;"#",#"",ADIAG1;
.
            MOVE      SP70,DOCFNAME
            MOVE      ADOCTA,KEY6
            CALL      RDDOCT1
            IF        OVRCD=0
              MOVE      DTITL,FMTTITLE
              MOVE      DGNAME,FMTGNAME
              MOVE      DSNAME,FMTSNAME
              CALL      DOCNM000
            ENDIF
.
            WRITE     HTMLFILE;"#",#"",DOCFNAME;
.
            IF        ELCHFLAG=ZERO
              WRITE     HTMLFILE;"#",#"<input type=checkbox name=oechk",DRECCNT:
                                 " disabled>";
            ELSE
              IF        ELCHFLAG=ONE
                WRITE     HTMLFILE;"#",#"<input type=checkbox name=oechk":
                                   DRECCNT:
                                   " onclick='UpdateElgCheck(this);'":
                                   " value='",ADMISSNO,"'>";
              ELSE
                WRITE     HTMLFILE;"#",#"<input type=checkbox checked name=oechk":
                                   DRECCNT:
                                   " onclick='UpdateElgCheck(this);'":
                                   " value='",ADMISSNO,"'>";
              ENDIF
            ENDIF
.
            MATCH     SP70,WBEHPSCD
            IF        @EQUAL | @EOS
              WRITE     HTMLFILE;"#",#"",HTMLLNKL,HTMLLNK4;
            ELSE
              WRITE     HTMLFILE;"#",#"",HTMLLNKL,HTMLLNK4,WBEHPSCD;
            ENDIF
.
            WRITE     HTMLFILE;"#",#"",HTMLLNK3;
.
            CALL      PRILW000
            CALL      MBSC0000
.
.           IF        OECRFLAG<>1
.             WRITE     HTMLFILE;"#",#"<input type=checkbox name=oeccn":
.                                  DRECCNT:
.                                  " disabled>";
.           ELSE
              MATCH     "1",PMVXPOEC
              IF        @EQUAL
              WRITE     HTMLFILE;"#",#"<input type=checkbox checked name=oeccn":
                                   DRECCNT:
                                   " onclick='UpdateOECConsent(this);'":
                                   " value='",ADMISSNO,"'>";
              ELSE
                WRITE     HTMLFILE;"#",#"<input type=checkbox name=oeccn":
                                   DRECCNT:
                                   " onclick='UpdateOECConsent(this);'":
                                   " value='",ADMISSNO,"'>";
              ENDIF
.           ENDIF
.
          IF        OECRFLAG=1
            WRITE     HTMLFILE;"#");":
                               " UpdateArray('",ADMISSNO,OECRFLAG,"');"
          ELSE
            WRITE     HTMLFILE;"#");"
          ENDIF
.
          IF        RECCNT>=99
            WRITE     HTMLFILE;"alert('Limit of 99 records reached');"
            GOTO      COEW9000
          ENDIF
.
          GOTO      COEW1000
.
COEW9000
COEW9999  RETURN
+
.------------------------------------------------------------
. Table of Bulk OECW - Pre Admissions only / Theatre Date
.------------------------------------------------------------
BOPW0000  PACK      KEY16,FRSTDATE,SP70
          CALL      RDSMISS3
BOPW1000  CALL      RDKMISS3
          BRANCH    OVRCD,BOPW9000
          MATCH     ADATE,LASTDATE
          GOTO      BOPW9000 IF LESS
          COMPARE   "1",ASTAT
          GOTO      BOPW1000 IF NOT EQUAL
.
          MATCH     SP70,HEALTHFN
          IF        !@EQUAL
            MATCH     HEALTHFN,AFUNDH
            GOTO      BOPW1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,CLAIMTYP
          IF        !@EQUAL
            MATCH     ACLAIM,CLAIMTYP
            GOTO      BOPW1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTBOOK
          GOTO      BOPW1000 IF NOT EQUAL
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDBKREC1
          IF        OVRCD=0
            GOTO      BOPW1000
          ENDIF 
.
          MOVE      SP70,DISPCOMP
          MOVE      ZERO,ELCHFLAG
          PACK      KEY8,DAADMNO,SP70
          CALL      RDPTELG1
          BRANCH    OVRCD,BOPW1500
.
          IF        HOSPCOMP=1
            MATCH     "1",PTELCMPL
            IF        @EQUAL
              MOVE      "Complete",DISPCOMP   * display if elig. complete
              MOVE      TWO,ELCHFLAG
            ELSE
              MOVE      ONE,ELCHFLAG
            ENDIF
          ELSE
            MATCH     "1",PTELCMPL            * don't display if elig. complete
            GOTO      BOPW1000 IF EQUAL
.
            MOVE      ONE,ELCHFLAG
          ENDIF
.
BOPW1500  PACK      KEY11,DAADMNO,Z70
          CALL      RSWBOEC1
          CALL      RPWBOEC1                   * get last OEC request
          IF        OVRCD=1
            CALL      CLWEBOEC
            MOVE      "99",WBOCSTAT            * no request status exists
            MOVE      SP70,WBOCUDTE
          ENDIF
.
          MATCH     DAADMNO,WBOCVISN
          IF        !@EQUAL
            CALL      CLWEBOEC
            MOVE      "99",WBOCSTAT            * no request status exists
            MOVE      SP70,WBOCUDTE
          ENDIF
.
          CALL      CLWEBEEH
.
          MATCH     SP70,WBOCTRID
          IF        !@EQUAL & !@EOS
            PACK      KEY47,WBOCTRID,WBOCARID,WBOCCNTR,SP70
            CALL      RDWBEEH2
            IF        OVRCD=1
              CALL      CLWEBEEH
            ENDIF
          ENDIF
.
          MATCH     SP70,REQUSTAT
          GOTO      BOPW2000 IF EQUAL          * filter by request status ?
.
          MATCH     " 5",REQUSTAT
          IF        @EQUAL
.
            MATCH     " 6",WBOCSTAT
            GOTO      BOPW1900 IF NOT EQUAL
.
.           MATCH     SP70,WBOCTRID
.           GOTO      BOPW1900 IF EQUAL
.           GOTO      BOPW1900 IF EOS
.
.           PACK      KEY47,WBOCTRID,WBOCARID,WBOCCNTR,SP70
.           CALL      RDWBEEH2
.           BRANCH    OVRCD,BOPW1900
.
            MATCH     "REJECTED",WBEHPSCD
            GOTO      BOPW1000 IF NOT EQUAL
.
            GOTO      BOPW2000
.
          ENDIF
.
          MATCH     " 6",REQUSTAT              * Match Complete Reported
          IF        @EQUAL
.
            MATCH     " 6",WBOCSTAT
            GOTO      BOPW1900 IF NOT EQUAL
.
.           MATCH     SP70,WBOCTRID
.           GOTO      BOPW1900 IF EQUAL
.           GOTO      BOPW1900 IF EOS
.
.           PACK      KEY47,WBOCTRID,WBOCARID,WBOCCNTR,SP70
.           CALL      RDWBEEH2
.           BRANCH    OVRCD,BOPW1900
.
            MATCH     "REJECTED",WBEHPSCD
            GOTO      BOPW1000 IF EQUAL
.
            MATCH     "HEALTH_FUND_UNAVAILABLE",WBEHPSCD
            GOTO      BOPW1000 IF EQUAL
.
            GOTO      BOPW2000
.
          ENDIF
.
          MATCH     " 7",REQUSTAT
          IF        @EQUAL
.
            MATCH     " 6",WBOCSTAT
            GOTO      BOPW1900 IF NOT EQUAL
.
.           MATCH     SP70,WBOCTRID
.           GOTO      BOPW1900 IF EQUAL
.           GOTO      BOPW1900 IF EOS
.
.           PACK      KEY47,WBOCTRID,WBOCARID,WBOCCNTR,SP70
.           CALL      RDWBEEH2
.           BRANCH    OVRCD,BOPW1900
.
            MATCH     "HEALTH_FUND_UNAVAILABLE",WBEHPSCD
            GOTO      BOPW1000 IF NOT EQUAL
.
            GOTO      BOPW2000
.
          ENDIF
.
BOPW1900  MATCH     REQUSTAT,WBOCSTAT
          GOTO      BOPW1000 IF NOT EQUAL      * yes (filter)
.
BOPW2000  MOVE      AADMNO,PMVXVISN            * Find Visit extension record
          PACK      KEY8,PMVXVISN,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,BOPW5000
.
          IF        IBCNMHOS<>1
            GOTO      BOPW5000
          ENDIF
.
          MATCH     SP70,FILTHOSP
          IF        !@EQUAL
            MATCH     FILTHOSP,PMVXMHOS
            GOTO      BOPW1000 IF NOT EQUAL
          ELSE
            PACK      KEY13,USERID,SP70              * All hospital access
            CALL      RDMLSEC1
            IF        OVRCD=1
              PACK      KEY13,USERID,PMVXMHOS,SP70   * This hospital access
              CALL      RDMLSEC1
              BRANCH    OVRCD,BOPW1000
            ENDIF
          ENDIF
.
. Display the visit
.
BOPW5000  PACK      URNUMBER,AURNO
          PACK      ADMISSNO,AADMNO
          MOVE      AURNO,URNO
          CALL      GETPAT00      * Get Patient Details
          CALL      ADMDAT00      * Get Admission Date & Time
          CALL      PATLN000      * Format Patient Name with System Parameter
.
          MOVE      "Pre-admitted",STATUS20
.
          PACK      DSWOECST,SP70
          MOVE      WBOCSTAT,F2
          LOAD      DSWOECST,F2,DSPPMOE1,DSPPMOE2,DSPPMOE3,DSPPMOE4,DSPPMOE5:
                                DSPPMOE6,DSPPMOE7
.
          MATCH     " 0",WBOCSTAT
          IF        @EQUAL
            MOVE      DSPPMOE0,DSWOECST
          ENDIF
.
          MOVE      "CL",CATEGORY           * Claim code Description
          MOVE      ACLAIM,CODE
          CALL      GETCOD00
          MOVE      TDESC,CLAIMDES
.
          CALL      VOEC0000                * Validate criteria (set oecrflag)
.
          CALL      GETELW00
.
          MOVE      ZERO,REQUFLAG
          PACK      HTMLLINK,SP70,SP70,SP70,SP70
          CLEAR     HTMLLINK
          PACK      HTMLLNK3,SP70,SP70,SP70,SP70
          PACK      HTMLLNK4,SP70,SP70,SP70,SP70
          CLEAR     HTMLLNK3
          MATCH     "99",WBOCSTAT
          IF        !@EQUAL
            MOVE      ONE,REQUFLAG          * display icon if request exists
            APPEND    "javascript:ViewRequest('",HTMLLINK
            APPEND    WBOCVISN,HTMLLINK
            APPEND    "','",HTMLLINK
            APPEND    WBOCCNTR,HTMLLINK
            APPEND    "')",HTMLLINK
            RESET     HTMLLINK
.
            REP       " +",WBOCVISN
            REP       " +",WBOCCNTR
.
            APPEND    "<img src=../images/MaintenanceIcon.gif ",HTMLLNK3
            APPEND    "onclick=ViewRequest('",HTMLLNK3
            APPEND    WBOCVISN,HTMLLNK3
            APPEND    "','",HTMLLNK3
            APPEND    WBOCCNTR,HTMLLNK3
            APPEND    "');>&nbsp;",HTMLLNK3
            APPEND    DSWOECST,HTMLLNK3
            RESET     HTMLLNK3
.
            REP       "+ ",WBOCVISN
            REP       "+ ",WBOCCNTR
.
          ENDIF
.
          MOVE      ZERO,PELFFLAG
          CLEAR     HTMLLNKL
          CLEAR     HTMLLNK4
          MATCH     "99",WBOCSTAT
          IF        !@EQUAL
.            MATCH     SP70,WBEFELGN
.            IF        !@EQUAL
              MOVE      ONE,PELFFLAG
.
              REP       " +",WBOCURNO
              REP       " +",WBOCVISN
              REP       " +",WBOCCNTR
.
              APPEND    "<img src=../images/MaintenanceIcon.gif ",HTMLLNKL
              APPEND    "onclick=disOEC('",HTMLLNKL
              APPEND    WBOCURNO,HTMLLNKL
              APPEND    "','",HTMLLNKL
              APPEND    WBOCVISN,HTMLLNKL
              APPEND    "','",HTMLLNKL
              APPEND    WBOCCNTR,HTMLLNKL
              APPEND    "');>",HTMLLNKL
              RESET     HTMLLNKL
.
              CLEAR     HTMLLNK4
              APPEND    "<img src=../images/DocumentIcon.gif ",HTMLLNK4
              APPEND    "onclick=displayOEC('",HTMLLNK4
              APPEND    WBOCVISN,HTMLLNK4
              APPEND    WBOCCNTR,HTMLLNK4
              APPEND    "','",HTMLLNK4
              APPEND    WBOCURNO,HTMLLNK4
              APPEND    "','",HTMLLNK4
              APPEND    WBOCVISN,HTMLLNK4
              APPEND    "');>",HTMLLNK4
              RESET     HTMLLNK4
.
              REP       "+ ",WBOCURNO
              REP       "+ ",WBOCVISN
              REP       "+ ",WBOCCNTR
.            ENDIF
          ENDIF
.
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
          CLEAR     PATLINK
          APPEND    LINKPRG,PATLINK
          APPEND    ".pbl?reportno=",PATLINK
          APPEND    LINKREP,PATLINK
          APPEND    "&template=",PATLINK
          APPEND    LINKTEM,PATLINK
          APPEND    "&urnumber=",PATLINK
          APPEND    URNUMBER,PATLINK
          APPEND    "&admissno=",PATLINK
          APPEND    ADMISSNO,PATLINK
          RESET     PATLINK
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":        * 0
                             "#"",ADMISSNO,"#",":                 * 1
                             "#"",FORMATNM,"#",":                 * 2
                             "#"",CLAIMDES,"#",":                 * 3
                             "#"",AFUNDH,"#",":                   * 4
                             "#"",STATUS20,"#",":                 * 5
                             "#"",ADATE,"#",":                    * 6
                             "#"",DISPCOMP,"#",":                 * 7
                             "#"",DSWOECST,"#",":                 * 8
                    "#"",WBOCCDTE,WBOCCTIM,"#",":                 * 9
                             "#"",REQUFLAG,"#",";                 * 10
.
. Request checkbox: disable if mandatory fields incomplete (oecrflag=0)
.                   otherwise default to ticked (oecrflag=1)
.
          ADD       ONE,RECCNT                                    * 11
          MOVE      RECCNT,DRECCNT
          REP       " 0",DRECCNT
.
          MATCH     SP70,PMVXPILC
          IF        !@EQUAL & !@EOS
            MATCH     SP70,AMBS
            IF        !@EQUAL & !@EOS
              MOVE      ZERO,OECRFLAG
            ENDIF
          ENDIF
.
          IF        OECRFLAG<>1
            WRITE     HTMLFILE;"#"<input type=checkbox name=oereq",DRECCNT:
                      " disabled><br>OECW fields incomplete";
          ELSE
            WRITE     HTMLFILE;"#"<input type=checkbox checked=true name=oereq":
                      DRECCNT:
                      " onClick=UpdateArray(this.value); value='",ADMISSNO:
                      OECRFLAG,"'>";
          ENDIF
.
.>>>>>    IF        OECRFLAG=1
            WRITE     HTMLFILE;"#",#"",PATLINK;
            CALL      PATFLD00
            WRITE     HTMLFILE;"#",#"",KEY3;
            WRITE     HTMLFILE;"#",#"",ADIAG1;
.
            MOVE      SP70,DOCFNAME
            MOVE      ADOCTA,KEY6
            CALL      RDDOCT1
            IF        OVRCD=0
              MOVE      DTITL,FMTTITLE
              MOVE      DGNAME,FMTGNAME
              MOVE      DSNAME,FMTSNAME
              CALL      DOCNM000
            ENDIF
.
            WRITE     HTMLFILE;"#",#"",DOCFNAME;
.
            IF        ELCHFLAG=ZERO
              WRITE     HTMLFILE;"#",#"<input type=checkbox name=oechk",DRECCNT:
                                 " disabled>";
            ELSE
              IF        ELCHFLAG=ONE
                WRITE     HTMLFILE;"#",#"<input type=checkbox name=oechk":
                                   DRECCNT:
                                   " onclick='UpdateElgCheck(this);'":
                                   " value='",ADMISSNO,"'>";
              ELSE
                WRITE     HTMLFILE;"#",#"<input type=checkbox checked name=oechk":
                                   DRECCNT:
                                   " onclick='UpdateElgCheck(this);'":
                                   " value='",ADMISSNO,"'>";
              ENDIF
            ENDIF
.
            MATCH     SP70,WBEHPSCD
            IF        @EQUAL | @EOS
              WRITE     HTMLFILE;"#",#"",HTMLLNKL,HTMLLNK4;
            ELSE
              WRITE     HTMLFILE;"#",#"",HTMLLNKL,HTMLLNK4,WBEHPSCD;
            ENDIF
.
            WRITE     HTMLFILE;"#",#"",HTMLLNK3;
.
            CALL      PRILW000
            CALL      MBSC0000
.
.           IF        OECRFLAG<>1
.             WRITE     HTMLFILE;"#",#"<input type=checkbox name=oeccn":
.                                  DRECCNT:
.                                  " disabled>";
.           ELSE
              MATCH     "1",PMVXPOEC
              IF        @EQUAL
              WRITE     HTMLFILE;"#",#"<input type=checkbox checked name=oeccn":
                                   DRECCNT:
                                   " onclick='UpdateOECConsent(this);'":
                                   " value='",ADMISSNO,"'>";
              ELSE
                WRITE     HTMLFILE;"#",#"<input type=checkbox name=oeccn":
                                   DRECCNT:
                                   " onclick='UpdateOECConsent(this);'":
                                   " value='",ADMISSNO,"'>";
              ENDIF
.           ENDIF
.
          IF        OECRFLAG=1
            WRITE     HTMLFILE;"#");":
                               " UpdateArray('",ADMISSNO,OECRFLAG,"');"
          ELSE
            WRITE     HTMLFILE;"#");"
          ENDIF
.
          IF        RECCNT>=99
            WRITE     HTMLFILE;"alert('Limit of 99 records reached');"
            GOTO      BOPW9000
          ENDIF
.
          GOTO      BOPW1000
.
BOPW9000
BOPW9999  RETURN
+
.------------------------------------------------------------
. Table of Bulk OECW - Theatre Bookings only / Theatre Date
.------------------------------------------------------------
BOBW0000  PACK      KEY16,FRSTDATE,SP70
          CALL      RSBKREC4
BOBW1000  CALL      RKBKREC4
          BRANCH    OVRCD,BOBW9000
.
          PACK      KEY8,DBKREBOO,SP70
          CALL      RDBKRX11
          BRANCH    OVRCD,BOBW1000
.
          MATCH     BKREEDAT,LASTDATE
          GOTO      BOBW9000 IF LESS
.
          IF        BKRESTAT<>0
            GOTO      BOBW1000
          ENDIF
.
          PACK      KEY8,DBKREBOO,SP70
          CALL      RDMISS1
          IF        OVRCD=0
            GOTO      BOBW1000
          ENDIF
.
          CALL      CLPATMIS
.
          MATCH     SP70,HEALTHFN
          GOTO      BOBW1000 IF NOT EQUAL
.
          MATCH     SP70,CLAIMTYP
          IF        !@EQUAL
            MATCH     BKRECLMT,CLAIMTYP
            GOTO      BOBW1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTBOOK
          IF        !@EQUAL
.           PACK      KEY8,AADMNO,SP70
.           CALL      RDBKREC1
.           BRANCH    OVRCD,BOBW1000
.
            MATCH     FILTBOOK,BKRETYPE
            GOTO      BOBW1000 IF NOT EQUAL
.
          ENDIF
.
          MOVE      SP70,DISPCOMP
          MOVE      ZERO,ELCHFLAG
          PACK      KEY8,DBKREBOO,SP70
          CALL      RDPTELG1
          BRANCH    OVRCD,BOBW1500
.
          IF        HOSPCOMP=1
            MATCH     "1",PTELCMPL
            IF        @EQUAL
              MOVE      "Complete",DISPCOMP   * display if elig. complete
              MOVE      TWO,ELCHFLAG
            ELSE
              MOVE      ONE,ELCHFLAG
            ENDIF
          ELSE
            MATCH     "1",PTELCMPL            * don't display if elig. complete
            GOTO      BOBW1000 IF EQUAL
.
            MOVE      ONE,ELCHFLAG
          ENDIF
.
BOBW1500  PACK      KEY11,DBKREBOO,Z70
          CALL      RSWBOEC1
          CALL      RPWBOEC1                   * get last OEC request
          IF        OVRCD=1
            CALL      CLWEBOEC
            MOVE      "99",WBOCSTAT            * no request status exists
            MOVE      SP70,WBOCUDTE
          ENDIF
.
          MATCH     DBKREBOO,WBOCVISN
          IF        !@EQUAL
            CALL      CLWEBOEC
            MOVE      "99",WBOCSTAT            * no request status exists
            MOVE      SP70,WBOCUDTE
          ENDIF
.
          CALL      CLWEBEEH
.
          MATCH     SP70,WBOCTRID
          IF        !@EQUAL & !@EOS
            PACK      KEY47,WBOCTRID,WBOCARID,WBOCCNTR,SP70
            CALL      RDWBEEH2
            IF        OVRCD=1
              CALL      CLWEBEEH
            ENDIF
          ENDIF
.
          MATCH     SP70,REQUSTAT
          GOTO      BOBW2000 IF EQUAL          * filter by request status ?
.
          MATCH     " 5",REQUSTAT
          IF        @EQUAL
.
            MATCH     " 6",WBOCSTAT
            GOTO      BOBW1900 IF NOT EQUAL
.
.           MATCH     SP70,WBOCTRID
.           GOTO      BOBW1900 IF EQUAL
.           GOTO      BOBW1900 IF EOS
.
.           PACK      KEY47,WBOCTRID,WBOCARID,WBOCCNTR,SP70
.           CALL      RDWBEEH2
.           BRANCH    OVRCD,BOBW1900
.
            MATCH     "REJECTED",WBEHPSCD
            GOTO      BOBW1000 IF NOT EQUAL
.
            GOTO      BOBW2000
.
          ENDIF
.
          MATCH     " 6",REQUSTAT              * Match Complete Reported
          IF        @EQUAL
.
            MATCH     " 6",WBOCSTAT
            GOTO      BOBW1900 IF NOT EQUAL
.
.           MATCH     SP70,WBOCTRID
.           GOTO      BOBW1900 IF EQUAL
.           GOTO      BOBW1900 IF EOS
.
.           PACK      KEY47,WBOCTRID,WBOCARID,WBOCCNTR,SP70
.           CALL      RDWBEEH2
.           BRANCH    OVRCD,BOBW1900
.
            MATCH     "REJECTED",WBEHPSCD
            GOTO      BOBW1000 IF EQUAL
.
            MATCH     "HEALTH_FUND_UNAVAILABLE",WBEHPSCD
            GOTO      BOBW1000 IF EQUAL
.
            GOTO      BOBW2000
.
          ENDIF
.
          MATCH     " 7",REQUSTAT
          IF        @EQUAL
.
            MATCH     " 6",WBOCSTAT
            GOTO      BOBW1900 IF NOT EQUAL
.
.           MATCH     SP70,WBOCTRID
.           GOTO      BOBW1900 IF EQUAL
.           GOTO      BOBW1900 IF EOS
.
.           PACK      KEY47,WBOCTRID,WBOCARID,WBOCCNTR,SP70
.           CALL      RDWBEEH2
.           BRANCH    OVRCD,BOBW1900
.
            MATCH     "HEALTH_FUND_UNAVAILABLE",WBEHPSCD
            GOTO      BOBW1000 IF NOT EQUAL
.
            GOTO      BOBW2000
.
          ENDIF
.
BOBW1900  MATCH     REQUSTAT,WBOCSTAT
          GOTO      BOBW1000 IF NOT EQUAL      * yes (filter)
.
BOBW2000  PACK      KEY31,DBKREBOO,SP70
          CALL      RSOPDEA2
          CALL      RKOPDEA2
          BRANCH    OVRCD,BOBW5000
.
          MATCH     DBKREBOO,OPDAADMN
.         GOTO      BOBW5000 IF NOT EQUAL       
          IF        !@EQUAL
            CALL      CLOPRDEA
            GOTO      BOBW5000
          ENDIF
.
          PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,SP70
          CALL      RDOPSES1
          IF        OVRCD=1
            CALL      CLOPRSES
          ENDIF
.
          IF        IBCNMHOS<>1
            GOTO      BOBW5000
          ENDIF
.
          MATCH     SP70,FILTHOSP
          IF        !@EQUAL
            MATCH     FILTHOSP,OPSEHOSP
            GOTO      BOBW1000 IF NOT EQUAL
          ELSE
            PACK      KEY13,USERID,SP70              * All hospital access
            CALL      RDMLSEC1
            IF        OVRCD=1
              PACK      KEY13,USERID,OPSEHOSP,SP70   * This hospital access
              CALL      RDMLSEC1
              BRANCH    OVRCD,BOBW1000
            ENDIF
          ENDIF
.
. Display the visit
.
BOBW5000  PACK      URNUMBER,BKREURNO
          PACK      ADMISSNO,BKREBOOK
          MOVE      BKREURNO,URNO
          CALL      GETPAT00      * Get Patient Details
.          CALL      ADMDAT00      * Get Admission Date & Time
          CALL      PATLN000      * Format Patient Name with System Parameter
.
          MOVE      "Booked",STATUS25
.
          PACK      DSWOECST,SP70
          MOVE      WBOCSTAT,F2
          LOAD      DSWOECST,F2,DSPPMOE1,DSPPMOE2,DSPPMOE3,DSPPMOE4,DSPPMOE5:
                                DSPPMOE6,DSPPMOE7
.
          MATCH     " 0",WBOCSTAT
          IF        @EQUAL
            MOVE      DSPPMOE0,DSWOECST
          ENDIF
.
          MOVE      "CL",CATEGORY           * Claim code Description
          MOVE      BKRECLMT,CODE
          CALL      GETCOD00
          MOVE      TDESC,CLAIMDES
.
          CALL      GETELW00
.
          CALL      VOEB0000                * Validate criteria (set oecrflag)
.
          MOVE      ZERO,REQUFLAG
          PACK      HTMLLINK,SP70,SP70,SP70,SP70
          CLEAR     HTMLLINK
          PACK      HTMLLNK3,SP70,SP70,SP70,SP70
          PACK      HTMLLNK4,SP70,SP70,SP70,SP70
          CLEAR     HTMLLNK3
          MATCH     "99",WBOCSTAT
          IF        !@EQUAL
            MOVE      ONE,REQUFLAG          * display icon if request exists
            APPEND    "javascript:ViewRequest('",HTMLLINK
            APPEND    WBOCVISN,HTMLLINK
            APPEND    "','",HTMLLINK
            APPEND    WBOCCNTR,HTMLLINK
            APPEND    "')",HTMLLINK
            RESET     HTMLLINK
.
            REP       " +",WBOCVISN
            REP       " +",WBOCCNTR
.
            APPEND    "<img src=../images/MaintenanceIcon.gif ",HTMLLNK3
            APPEND    "onclick=ViewRequest('",HTMLLNK3
            APPEND    WBOCVISN,HTMLLNK3
            APPEND    "','",HTMLLNK3
            APPEND    WBOCCNTR,HTMLLNK3
            APPEND    "');>&nbsp;",HTMLLNK3
            APPEND    DSWOECST,HTMLLNK3
            RESET     HTMLLNK3
.
            REP       "+ ",WBOCVISN
            REP       "+ ",WBOCCNTR
.
          ENDIF
.
          MOVE      ZERO,PELFFLAG
          CLEAR     HTMLLNKL
          CLEAR     HTMLLNK4
          MATCH     "99",WBOCSTAT
          IF        !@EQUAL
.            MATCH     SP70,WBEFELGN
.            IF        !@EQUAL
              MOVE      ONE,PELFFLAG
.
              REP       " +",WBOCURNO
              REP       " +",WBOCVISN
              REP       " +",WBOCCNTR
.
              APPEND    "<img src=../images/MaintenanceIcon.gif ",HTMLLNKL
              APPEND    "onclick=disOEC('",HTMLLNKL
              APPEND    WBOCURNO,HTMLLNKL
              APPEND    "','",HTMLLNKL
              APPEND    WBOCVISN,HTMLLNKL
              APPEND    "','",HTMLLNKL
              APPEND    WBOCCNTR,HTMLLNKL
              APPEND    "');>",HTMLLNKL
              RESET     HTMLLNKL
.
              PACK      HTMLLNK4,SP70,SP70,SP70,SP70
              CLEAR     HTMLLNK4
              APPEND    "<img src=../images/DocumentIcon.gif ",HTMLLNK4
              APPEND    "onclick=displayOEC('",HTMLLNK4
              APPEND    WBOCVISN,HTMLLNK4
              APPEND    WBOCCNTR,HTMLLNK4
              APPEND    "','",HTMLLNK4
              APPEND    WBOCURNO,HTMLLNK4
              APPEND    "','",HTMLLNK4
              APPEND    WBOCVISN,HTMLLNK4
              APPEND    "');>",HTMLLNK4
              RESET     HTMLLNK4
.
              REP       "+ ",WBOCURNO
              REP       "+ ",WBOCVISN
              REP       "+ ",WBOCCNTR
.            ENDIF
          ENDIF
.
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
          CLEAR     PATLINK
          APPEND    LINKPRG,PATLINK
          APPEND    ".pbl?reportno=",PATLINK
          APPEND    LINKREP,PATLINK
          APPEND    "&template=",PATLINK
          APPEND    LINKTEM,PATLINK
          APPEND    "&urnumber=",PATLINK
          APPEND    URNUMBER,PATLINK
          APPEND    "&admissno=",PATLINK
          APPEND    ADMISSNO,PATLINK
          RESET     PATLINK
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":        * 0
                             "#"",ADMISSNO,"#",":                 * 1
                             "#"",FORMATNM,"#",":                 * 2
                             "#"",CLAIMDES,"#",":                 * 3
                             "#"",WBEFHFND,"#",":                   * 4
                             "#"",STATUS25,"#",":                 * 5
                             "#"",WBEFEADT,"#",":                    * 6
                             "#"",DISPCOMP,"#",":                 * 7
                             "#"",DSWOECST,"#",":                 * 8
                    "#"",WBOCCDTE,WBOCCTIM,"#",":                 * 9
                             "#"",REQUFLAG,"#",";                 * 10
.
. Request checkbox: disable if mandatory fields incomplete (oecrflag=0)
.                   otherwise default to ticked (oecrflag=1)
.
          ADD       ONE,RECCNT                                    * 11
          MOVE      RECCNT,DRECCNT
          REP       " 0",DRECCNT
.
          MATCH     SP70,WBEFPRIC
          IF        !@EQUAL & !@EOS
            MATCH     SP70,WBEFPRIM
            IF        !@EQUAL & !@EOS
              MOVE      ZERO,OECRFLAG
            ENDIF
          ENDIF
.
          IF        OECRFLAG<>1
            WRITE     HTMLFILE;"#"<input type=checkbox name=oereq",DRECCNT:
                      " disabled><br>OECW fields incomplete";
          ELSE
            WRITE     HTMLFILE;"#"<input type=checkbox checked=true name=oereq":
                      DRECCNT:
                      " onClick=UpdateArray(this.value); value='",ADMISSNO:
                      OECRFLAG,"'>";
          ENDIF
.
.>>>>>    IF        OECRFLAG=1
            WRITE     HTMLFILE;"#",#"",PATLINK;
            CALL      PATFLD00
            WRITE     HTMLFILE;"#",#"",KEY3;
            WRITE     HTMLFILE;"#",#"",WBEFDIAG;
.
            MOVE      SP70,DOCFNAME
            MOVE      BKREADOC,KEY6
            CALL      RDDOCT1
            IF        OVRCD=0
              MOVE      DTITL,FMTTITLE
              MOVE      DGNAME,FMTGNAME
              MOVE      DSNAME,FMTSNAME
              CALL      DOCNM000
            ENDIF
.
            WRITE     HTMLFILE;"#",#"",DOCFNAME;
.
            IF        ELCHFLAG=ZERO
              WRITE     HTMLFILE;"#",#"<input type=checkbox name=oechk",DRECCNT:
                                 " disabled>";
            ELSE
              IF        ELCHFLAG=ONE
                WRITE     HTMLFILE;"#",#"<input type=checkbox name=oechk":
                                   DRECCNT:
                                   " onclick='UpdateElgCheck(this);'":
                                   " value='",ADMISSNO,"'>";
              ELSE
                WRITE     HTMLFILE;"#",#"<input type=checkbox checked name=oechk":
                                   DRECCNT:
                                   " onclick='UpdateElgCheck(this);'":
                                   " value='",ADMISSNO,"'>";
              ENDIF
            ENDIF
.
            MATCH     SP70,WBEHPSCD
            IF        @EQUAL | @EOS
              WRITE     HTMLFILE;"#",#"",HTMLLNKL,HTMLLNK4;
            ELSE
              WRITE     HTMLFILE;"#",#"",HTMLLNKL,HTMLLNK4,WBEHPSCD;
            ENDIF
.
            WRITE     HTMLFILE;"#",#"",HTMLLNK3;
.
            CALL      PRILB000
            CALL      MBSB0000
.
.           IF        OECRFLAG<>1
.             WRITE     HTMLFILE;"#",#"<input type=checkbox name=oeccn":
.                                  DRECCNT:
.                                  " disabled>";
.           ELSE
              MATCH     "1",BKRXPOEC
              IF        @EQUAL
              WRITE     HTMLFILE;"#",#"<input type=checkbox checked name=oeccn":
                                   DRECCNT:
                                   " onclick='UpdateOECConsentBook(this);'":
                                   " value='",ADMISSNO,"'>";
              ELSE
                WRITE     HTMLFILE;"#",#"<input type=checkbox name=oeccn":
                                   DRECCNT:
                                   " onclick='UpdateOECConsentBook(this);'":
                                   " value='",ADMISSNO,"'>";
              ENDIF
.           ENDIF
.
          IF        OECRFLAG=1
            WRITE     HTMLFILE;"#");":
                               " UpdateArray('",ADMISSNO,OECRFLAG,"');"
          ELSE
            WRITE     HTMLFILE;"#");"
          ENDIF
.
          IF        RECCNT>=99
            WRITE     HTMLFILE;"alert('Limit of 99 records reached');"
            GOTO      BOBW9000
          ENDIF
.
          GOTO      BOBW1000
.
BOBW9000
BOBW9999  RETURN
+
.------------------------------------------------------------
. Table of Bulk OECW - Pre Admissions only / Booking Date
.------------------------------------------------------------
COPW0000  PACK      KEY16,FRSTDATE,SP70
          CALL      RDSMISS3
COPW1000  CALL      RDKMISS3
          BRANCH    OVRCD,COPW9000
          MATCH     ADATE,LASTDATE
          GOTO      COPW9000 IF LESS
          COMPARE   "1",ASTAT
          GOTO      COPW1000 IF NOT EQUAL
.
          MATCH     SP70,HEALTHFN
          IF        !@EQUAL
            MATCH     HEALTHFN,AFUNDH
            GOTO      COPW1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,CLAIMTYP
          IF        !@EQUAL
            MATCH     ACLAIM,CLAIMTYP
            GOTO      COPW1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTBOOK
          GOTO      COPW1000 IF NOT EQUAL
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDBKREC1
          IF        OVRCD=0
            GOTO      COPW1000
          ENDIF
.
          MOVE      SP70,DISPCOMP
          MOVE      ZERO,ELCHFLAG
          PACK      KEY8,DAADMNO,SP70
          CALL      RDPTELG1
          BRANCH    OVRCD,COPW1500
.
          IF        HOSPCOMP=1
            MATCH     "1",PTELCMPL
            IF        @EQUAL
              MOVE      "Complete",DISPCOMP   * display if elig. complete
              MOVE      TWO,ELCHFLAG
            ELSE
              MOVE      ONE,ELCHFLAG
            ENDIF
          ELSE
            MATCH     "1",PTELCMPL            * don't display if elig. complete
            GOTO      COPW1000 IF EQUAL
.
            MOVE      ONE,ELCHFLAG
          ENDIF
.
COPW1500  PACK      KEY11,DAADMNO,Z70
          CALL      RSWBOEC1
          CALL      RPWBOEC1                   * get last OEC request
          IF        OVRCD=1
            CALL      CLWEBOEC
            MOVE      "99",WBOCSTAT            * no request status exists
            MOVE      SP70,WBOCUDTE
          ENDIF
.
          MATCH     DAADMNO,WBOCVISN
          IF        !@EQUAL
            CALL      CLWEBOEC
            MOVE      "99",WBOCSTAT            * no request status exists
            MOVE      SP70,WBOCUDTE
          ENDIF
.
          CALL      CLWEBEEH
.
          MATCH     SP70,WBOCTRID
          IF        !@EQUAL & !@EOS
            PACK      KEY47,WBOCTRID,WBOCARID,WBOCCNTR,SP70
            CALL      RDWBEEH2
            IF        OVRCD=1
              CALL      CLWEBEEH
            ENDIF
          ENDIF
.
          MATCH     SP70,REQUSTAT
          GOTO      COPW2000 IF EQUAL          * filter by request status ?
.
          MATCH     " 5",REQUSTAT
          IF        @EQUAL
.
            MATCH     " 6",WBOCSTAT
            GOTO      COPW1900 IF NOT EQUAL
.
.           MATCH     SP70,WBOCTRID
.           GOTO      COPW1900 IF EQUAL
.           GOTO      COPW1900 IF EOS
.
.           PACK      KEY47,WBOCTRID,WBOCARID,WBOCCNTR,SP70
.           CALL      RDWBEEH2
.           BRANCH    OVRCD,COPW1900
.
            MATCH     "REJECTED",WBEHPSCD
            GOTO      COPW1000 IF NOT EQUAL
.
            GOTO      COPW2000
.
          ENDIF
.
          MATCH     " 6",REQUSTAT              * Match Complete Reported
          IF        @EQUAL
.
            MATCH     " 6",WBOCSTAT
            GOTO      COPW1900 IF NOT EQUAL
.
.           MATCH     SP70,WBOCTRID
.           GOTO      COPW1900 IF EQUAL
.           GOTO      COPW1900 IF EOS
.
.           PACK      KEY47,WBOCTRID,WBOCARID,WBOCCNTR,SP70
.           CALL      RDWBEEH2
.           BRANCH    OVRCD,COPW1900
.
            MATCH     "REJECTED",WBEHPSCD
            GOTO      COPW1000 IF EQUAL
.
            MATCH     "HEALTH_FUND_UNAVAILABLE",WBEHPSCD
            GOTO      COPW1000 IF EQUAL
.
            GOTO      COPW2000
.
          ENDIF
.
          MATCH     " 7",REQUSTAT
          IF        @EQUAL
.
            MATCH     " 6",WBOCSTAT
            GOTO      COPW1900 IF NOT EQUAL
.
.           MATCH     SP70,WBOCTRID
.           GOTO      COPW1900 IF EQUAL
.           GOTO      COPW1900 IF EOS
.
.           PACK      KEY47,WBOCTRID,WBOCARID,WBOCCNTR,SP70
.           CALL      RDWBEEH2
.           BRANCH    OVRCD,COPW1900
.
            MATCH     "HEALTH_FUND_UNAVAILABLE",WBEHPSCD
            GOTO      COPW1000 IF NOT EQUAL
.
            GOTO      COPW2000
.
          ENDIF
.
COPW1900  MATCH     REQUSTAT,WBOCSTAT
          GOTO      COPW1000 IF NOT EQUAL      * yes (filter)
.
COPW2000  MOVE      AADMNO,PMVXVISN            * Find Visit extension record
          PACK      KEY8,PMVXVISN,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,COPW5000
.
          IF        IBCNMHOS<>1
            GOTO      COPW5000
          ENDIF
.
          MATCH     SP70,FILTHOSP
          IF        !@EQUAL
            MATCH     FILTHOSP,PMVXMHOS
            GOTO      COPW1000 IF NOT EQUAL
          ELSE
            PACK      KEY13,USERID,SP70              * All hospital access
            CALL      RDMLSEC1
            IF        OVRCD=1
              PACK      KEY13,USERID,PMVXMHOS,SP70   * This hospital access
              CALL      RDMLSEC1
              BRANCH    OVRCD,COPW1000
            ENDIF
          ENDIF
.
. Display the visit
.
COPW5000  PACK      URNUMBER,AURNO
          PACK      ADMISSNO,AADMNO
          MOVE      AURNO,URNO
          CALL      GETPAT00      * Get Patient Details
          CALL      ADMDAT00      * Get Admission Date & Time
          CALL      PATLN000      * Format Patient Name with System Parameter
.
          MOVE      "Pre-admitted",STATUS20
.
          PACK      DSWOECST,SP70
          MOVE      WBOCSTAT,F2
          LOAD      DSWOECST,F2,DSPPMOE1,DSPPMOE2,DSPPMOE3,DSPPMOE4,DSPPMOE5:
                                DSPPMOE6,DSPPMOE7
.
          MATCH     " 0",WBOCSTAT
          IF        @EQUAL
            MOVE      DSPPMOE0,DSWOECST
          ENDIF
.
          MOVE      "CL",CATEGORY           * Claim code Description
          MOVE      ACLAIM,CODE
          CALL      GETCOD00
          MOVE      TDESC,CLAIMDES
.
          CALL      VOEC0000                * Validate criteria (set oecrflag)
.
          CALL      GETELW00
.
          MOVE      ZERO,REQUFLAG
          PACK      HTMLLINK,SP70,SP70,SP70,SP70
          CLEAR     HTMLLINK
          PACK      HTMLLNK3,SP70,SP70,SP70,SP70
          PACK      HTMLLNK4,SP70,SP70,SP70,SP70
          CLEAR     HTMLLNK3
          MATCH     "99",WBOCSTAT
          IF        !@EQUAL
            MOVE      ONE,REQUFLAG          * display icon if request exists
            APPEND    "javascript:ViewRequest('",HTMLLINK
            APPEND    WBOCVISN,HTMLLINK
            APPEND    "','",HTMLLINK
            APPEND    WBOCCNTR,HTMLLINK
            APPEND    "')",HTMLLINK
            RESET     HTMLLINK
.
            REP       " +",WBOCVISN
            REP       " +",WBOCCNTR
.
            APPEND    "<img src=../images/MaintenanceIcon.gif ",HTMLLNK3
            APPEND    "onclick=ViewRequest('",HTMLLNK3
            APPEND    WBOCVISN,HTMLLNK3
            APPEND    "','",HTMLLNK3
            APPEND    WBOCCNTR,HTMLLNK3
            APPEND    "');>&nbsp;",HTMLLNK3
            APPEND    DSWOECST,HTMLLNK3
            RESET     HTMLLNK3
.
            REP       "+ ",WBOCVISN
            REP       "+ ",WBOCCNTR
.
          ENDIF
.
          MOVE      ZERO,PELFFLAG
          CLEAR     HTMLLNKL
          CLEAR     HTMLLNK4
          MATCH     "99",WBOCSTAT
          IF        !@EQUAL
.            MATCH     SP70,WBEFELGN
.            IF        !@EQUAL
              MOVE      ONE,PELFFLAG
.
              REP       " +",WBOCURNO
              REP       " +",WBOCVISN
              REP       " +",WBOCCNTR
.
              APPEND    "<img src=../images/MaintenanceIcon.gif ",HTMLLNKL
              APPEND    "onclick=disOEC('",HTMLLNKL
              APPEND    WBOCURNO,HTMLLNKL
              APPEND    "','",HTMLLNKL
              APPEND    WBOCVISN,HTMLLNKL
              APPEND    "','",HTMLLNKL
              APPEND    WBOCCNTR,HTMLLNKL
              APPEND    "');>",HTMLLNKL
              RESET     HTMLLNKL
.
              CLEAR     HTMLLNK4
              APPEND    "<img src=../images/DocumentIcon.gif ",HTMLLNK4
              APPEND    "onclick=displayOEC('",HTMLLNK4
              APPEND    WBOCVISN,HTMLLNK4
              APPEND    WBOCCNTR,HTMLLNK4
              APPEND    "','",HTMLLNK4
              APPEND    WBOCURNO,HTMLLNK4
              APPEND    "','",HTMLLNK4
              APPEND    WBOCVISN,HTMLLNK4
              APPEND    "');>",HTMLLNK4
              RESET     HTMLLNK4
.
              REP       "+ ",WBOCURNO
              REP       "+ ",WBOCVISN
              REP       "+ ",WBOCCNTR
.            ENDIF
          ENDIF
.
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
          CLEAR     PATLINK
          APPEND    LINKPRG,PATLINK
          APPEND    ".pbl?reportno=",PATLINK
          APPEND    LINKREP,PATLINK
          APPEND    "&template=",PATLINK
          APPEND    LINKTEM,PATLINK
          APPEND    "&urnumber=",PATLINK
          APPEND    URNUMBER,PATLINK
          APPEND    "&admissno=",PATLINK
          APPEND    ADMISSNO,PATLINK
          RESET     PATLINK
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":        * 0
                             "#"",ADMISSNO,"#",":                 * 1
                             "#"",FORMATNM,"#",":                 * 2
                             "#"",CLAIMDES,"#",":                 * 3
                             "#"",AFUNDH,"#",":                   * 4
                             "#"",STATUS20,"#",":                 * 5
                             "#"",ADATE,"#",":                    * 6
                             "#"",DISPCOMP,"#",":                 * 7
                             "#"",DSWOECST,"#",":                 * 8
                    "#"",WBOCCDTE,WBOCCTIM,"#",":                 * 9
                             "#"",REQUFLAG,"#",";                 * 10
.
. Request checkbox: disable if mandatory fields incomplete (oecrflag=0)
.                   otherwise default to ticked (oecrflag=1)
.
          ADD       ONE,RECCNT                                    * 11
          MOVE      RECCNT,DRECCNT
          REP       " 0",DRECCNT
.
          MATCH     SP70,PMVXPILC
          IF        !@EQUAL & !@EOS
            MATCH     SP70,AMBS
            IF        !@EQUAL & !@EOS
              MOVE      ZERO,OECRFLAG
            ENDIF
          ENDIF
.
          IF        OECRFLAG<>1
            WRITE     HTMLFILE;"#"<input type=checkbox name=oereq",DRECCNT:
                      " disabled><br>OECW fields incomplete";
          ELSE
            WRITE     HTMLFILE;"#"<input type=checkbox checked=true name=oereq":
                      DRECCNT:
                      " onClick=UpdateArray(this.value); value='",ADMISSNO:
                      OECRFLAG,"'>";
          ENDIF
.
.>>>>>    IF        OECRFLAG=1
            WRITE     HTMLFILE;"#",#"",PATLINK;
            CALL      PATFLD00
            WRITE     HTMLFILE;"#",#"",KEY3;
            WRITE     HTMLFILE;"#",#"",ADIAG1;
.
            MOVE      SP70,DOCFNAME
            MOVE      ADOCTA,KEY6
            CALL      RDDOCT1
            IF        OVRCD=0
              MOVE      DTITL,FMTTITLE
              MOVE      DGNAME,FMTGNAME
              MOVE      DSNAME,FMTSNAME
              CALL      DOCNM000
            ENDIF
.
            WRITE     HTMLFILE;"#",#"",DOCFNAME;
.
            IF        ELCHFLAG=ZERO
              WRITE     HTMLFILE;"#",#"<input type=checkbox name=oechk",DRECCNT:
                                 " disabled>";
            ELSE
              IF        ELCHFLAG=ONE
                WRITE     HTMLFILE;"#",#"<input type=checkbox name=oechk":
                                   DRECCNT:
                                   " onclick='UpdateElgCheck(this);'":
                                   " value='",ADMISSNO,"'>";
              ELSE
                WRITE     HTMLFILE;"#",#"<input type=checkbox checked name=oechk":
                                   DRECCNT:
                                   " onclick='UpdateElgCheck(this);'":
                                   " value='",ADMISSNO,"'>";
              ENDIF
            ENDIF
.
            MATCH     SP70,WBEHPSCD
            IF        @EQUAL | @EOS
              WRITE     HTMLFILE;"#",#"",HTMLLNKL,HTMLLNK4;
            ELSE
              WRITE     HTMLFILE;"#",#"",HTMLLNKL,HTMLLNK4,WBEHPSCD;
            ENDIF
.
            WRITE     HTMLFILE;"#",#"",HTMLLNK3;
.
            CALL      PRILW000
            CALL      MBSC0000
.
.           IF        OECRFLAG<>1
.             WRITE     HTMLFILE;"#",#"<input type=checkbox name=oeccn":
.                                  DRECCNT:
.                                  " disabled>";
.           ELSE
              MATCH     "1",PMVXPOEC
              IF        @EQUAL
              WRITE     HTMLFILE;"#",#"<input type=checkbox checked name=oeccn":
                                   DRECCNT:
                                   " onclick='UpdateOECConsent(this);'":
                                   " value='",ADMISSNO,"'>";
              ELSE
                WRITE     HTMLFILE;"#",#"<input type=checkbox name=oeccn":
                                   DRECCNT:
                                   " onclick='UpdateOECConsent(this);'":
                                   " value='",ADMISSNO,"'>";
              ENDIF
.           ENDIF
.
          IF        OECRFLAG=1
            WRITE     HTMLFILE;"#");":
                               " UpdateArray('",ADMISSNO,OECRFLAG,"');"
          ELSE
            WRITE     HTMLFILE;"#");"
          ENDIF
.
          IF        RECCNT>=99
            WRITE     HTMLFILE;"alert('Limit of 99 records reached');"
            GOTO      COPW9000
          ENDIF
.
          GOTO      COPW1000
.
COPW9000
COPW9999  RETURN
+
.------------------------------------------------------------
. Table of Bulk OECW - Theatre Bookings only / Booking Date
.------------------------------------------------------------
COBW0000  PACK      KEY16,FRSTDATE,SP70
          CALL      RSBKRX12
COBW1000  CALL      RKBKRX12
          BRANCH    OVRCD,COBW9000
.
          PACK      KEY8,BKRXBNUM,SP70
          CALL      RDBKREC1
          BRANCH    OVRCD,COBW1000
.
          MATCH     BKRXCRDT,LASTDATE
          GOTO      COBW9000 IF LESS
.
          IF        BKRESTAT<>0
            GOTO      COBW1000
          ENDIF
.
          PACK      KEY8,DBKREBOO,SP70
          CALL      RDMISS1
          IF        OVRCD=0
            GOTO      COBW1000
          ENDIF
.
          CALL      CLPATMIS
.
          MATCH     SP70,HEALTHFN
          GOTO      COBW1000 IF NOT EQUAL
.
          MATCH     SP70,CLAIMTYP
          IF        !@EQUAL
            MATCH     BKRECLMT,CLAIMTYP
            GOTO      COBW1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTBOOK
          IF        !@EQUAL
.           PACK      KEY8,AADMNO,SP70
.           CALL      RDBKREC1
.           BRANCH    OVRCD,COBW1000
.
            MATCH     FILTBOOK,BKRETYPE
            GOTO      COBW1000 IF NOT EQUAL
.
          ENDIF
.
          MOVE      SP70,DISPCOMP
          MOVE      ZERO,ELCHFLAG
          PACK      KEY8,DBKREBOO,SP70
          CALL      RDPTELG1
          BRANCH    OVRCD,COBW1500
.
          IF        HOSPCOMP=1
            MATCH     "1",PTELCMPL
            IF        @EQUAL
              MOVE      "Complete",DISPCOMP   * display if elig. complete
              MOVE      TWO,ELCHFLAG
            ELSE
              MOVE      ONE,ELCHFLAG
            ENDIF
          ELSE
            MATCH     "1",PTELCMPL            * don't display if elig. complete
            GOTO      COBW1000 IF EQUAL
.
            MOVE      ONE,ELCHFLAG
          ENDIF
.
COBW1500  PACK      KEY11,DBKREBOO,Z70
          CALL      RSWBOEC1
          CALL      RPWBOEC1                   * get last OEC request
          IF        OVRCD=1
            CALL      CLWEBOEC
            MOVE      "99",WBOCSTAT            * no request status exists
            MOVE      SP70,WBOCUDTE
          ENDIF
.
          MATCH     DBKREBOO,WBOCVISN
          IF        !@EQUAL
            CALL      CLWEBOEC
            MOVE      "99",WBOCSTAT            * no request status exists
            MOVE      SP70,WBOCUDTE
          ENDIF
.
          CALL      CLWEBEEH
.
          MATCH     SP70,WBOCTRID
          IF        !@EQUAL & !@EOS
            PACK      KEY47,WBOCTRID,WBOCARID,WBOCCNTR,SP70
            CALL      RDWBEEH2
            IF        OVRCD=1
              CALL      CLWEBEEH
            ENDIF
          ENDIF
.
          MATCH     SP70,REQUSTAT
          GOTO      COBW2000 IF EQUAL          * filter by request status ?
.
          MATCH     " 5",REQUSTAT
          IF        @EQUAL
.
            MATCH     " 6",WBOCSTAT
            GOTO      COBW1900 IF NOT EQUAL
.
.           MATCH     SP70,WBOCTRID
.           GOTO      COBW1900 IF EQUAL
.           GOTO      COBW1900 IF EOS
.
.           PACK      KEY47,WBOCTRID,WBOCARID,WBOCCNTR,SP70
.           CALL      RDWBEEH2
.           BRANCH    OVRCD,COBW1900
.
            MATCH     "REJECTED",WBEHPSCD
            GOTO      COBW1000 IF NOT EQUAL
.
            GOTO      COBW2000
.
          ENDIF
.
          MATCH     " 6",REQUSTAT              * Match Complete Reported
          IF        @EQUAL
.
            MATCH     " 6",WBOCSTAT
            GOTO      COBW1900 IF NOT EQUAL
.
.           MATCH     SP70,WBOCTRID
.           GOTO      COBW1900 IF EQUAL
.           GOTO      COBW1900 IF EOS
.
.           PACK      KEY47,WBOCTRID,WBOCARID,WBOCCNTR,SP70
.           CALL      RDWBEEH2
.           BRANCH    OVRCD,COBW1900
.
            MATCH     "REJECTED",WBEHPSCD
            GOTO      COBW1000 IF EQUAL
.
            MATCH     "HEALTH_FUND_UNAVAILABLE",WBEHPSCD
            GOTO      COBW1000 IF EQUAL
.
            GOTO      COBW2000
.
          ENDIF
.
          MATCH     " 7",REQUSTAT
          IF        @EQUAL
.
            MATCH     " 6",WBOCSTAT
            GOTO      COBW1900 IF NOT EQUAL
.
.           MATCH     SP70,WBOCTRID
.           GOTO      COBW1900 IF EQUAL
.           GOTO      COBW1900 IF EOS
.
.           PACK      KEY47,WBOCTRID,WBOCARID,WBOCCNTR,SP70
.           CALL      RDWBEEH2
.           BRANCH    OVRCD,COBW1900
.
            MATCH     "HEALTH_FUND_UNAVAILABLE",WBEHPSCD
            GOTO      COBW1000 IF NOT EQUAL
.
            GOTO      COBW2000
.
          ENDIF
.
COBW1900  MATCH     REQUSTAT,WBOCSTAT
          GOTO      COBW1000 IF NOT EQUAL      * yes (filter)
.
COBW2000  PACK      KEY31,DBKREBOO,SP70
          CALL      RSOPDEA2
          CALL      RKOPDEA2
          BRANCH    OVRCD,COBW5000
.
          MATCH     DBKREBOO,OPDAADMN
.         GOTO      COBW5000 IF NOT EQUAL
          IF        !@EQUAL
            CALL      CLOPRDEA
            GOTO      COBW5000
          ENDIF
.
          PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,SP70
          CALL      RDOPSES1
          IF        OVRCD=1
            CALL      CLOPRSES
          ENDIF
.
          IF        IBCNMHOS<>1
            GOTO      COBW5000
          ENDIF
.
          MATCH     SP70,FILTHOSP
          IF        !@EQUAL
            MATCH     FILTHOSP,OPSEHOSP
            GOTO      COBW1000 IF NOT EQUAL
          ELSE
            PACK      KEY13,USERID,SP70              * All hospital access
            CALL      RDMLSEC1
            IF        OVRCD=1
              PACK      KEY13,USERID,OPSEHOSP,SP70   * This hospital access
              CALL      RDMLSEC1
              BRANCH    OVRCD,COBW1000
            ENDIF
          ENDIF
.
. Display the visit
.
COBW5000  PACK      URNUMBER,BKREURNO
          PACK      ADMISSNO,BKREBOOK
          MOVE      BKREURNO,URNO
          CALL      GETPAT00      * Get Patient Details
.          CALL      ADMDAT00      * Get Admission Date & Time
          CALL      PATLN000      * Format Patient Name with System Parameter
.
          MOVE      "Booked",STATUS25
.
          PACK      DSWOECST,SP70
          MOVE      WBOCSTAT,F2
          LOAD      DSWOECST,F2,DSPPMOE1,DSPPMOE2,DSPPMOE3,DSPPMOE4,DSPPMOE5:
                                DSPPMOE6,DSPPMOE7
.
          MATCH     " 0",WBOCSTAT
          IF        @EQUAL
            MOVE      DSPPMOE0,DSWOECST
          ENDIF
.
          MOVE      "CL",CATEGORY           * Claim code Description
          MOVE      BKRECLMT,CODE
          CALL      GETCOD00
          MOVE      TDESC,CLAIMDES
.
          CALL      GETELW00
.
          CALL      VOEB0000                * Validate criteria (set oecrflag)
.
          MOVE      ZERO,REQUFLAG
          PACK      HTMLLINK,SP70,SP70,SP70,SP70
          CLEAR     HTMLLINK
          PACK      HTMLLNK3,SP70,SP70,SP70,SP70
          PACK      HTMLLNK4,SP70,SP70,SP70,SP70
          CLEAR     HTMLLNK3
          MATCH     "99",WBOCSTAT
          IF        !@EQUAL
            MOVE      ONE,REQUFLAG          * display icon if request exists
            APPEND    "javascript:ViewRequest('",HTMLLINK
            APPEND    WBOCVISN,HTMLLINK
            APPEND    "','",HTMLLINK
            APPEND    WBOCCNTR,HTMLLINK
            APPEND    "')",HTMLLINK
            RESET     HTMLLINK
.
            REP       " +",WBOCVISN
            REP       " +",WBOCCNTR
.
            APPEND    "<img src=../images/MaintenanceIcon.gif ",HTMLLNK3
            APPEND    "onclick=ViewRequest('",HTMLLNK3
            APPEND    WBOCVISN,HTMLLNK3
            APPEND    "','",HTMLLNK3
            APPEND    WBOCCNTR,HTMLLNK3
            APPEND    "');>&nbsp;",HTMLLNK3
            APPEND    DSWOECST,HTMLLNK3
            RESET     HTMLLNK3
.
            REP       "+ ",WBOCVISN
            REP       "+ ",WBOCCNTR
.
          ENDIF
.
          MOVE      ZERO,PELFFLAG
          CLEAR     HTMLLNKL
          CLEAR     HTMLLNK4
          MATCH     "99",WBOCSTAT
          IF        !@EQUAL
.            MATCH     SP70,WBEFELGN
.            IF        !@EQUAL
              MOVE      ONE,PELFFLAG
.
              REP       " +",WBOCURNO
              REP       " +",WBOCVISN
              REP       " +",WBOCCNTR
.
              APPEND    "<img src=../images/MaintenanceIcon.gif ",HTMLLNKL
              APPEND    "onclick=disOEC('",HTMLLNKL
              APPEND    WBOCURNO,HTMLLNKL
              APPEND    "','",HTMLLNKL
              APPEND    WBOCVISN,HTMLLNKL
              APPEND    "','",HTMLLNKL
              APPEND    WBOCCNTR,HTMLLNKL
              APPEND    "');>",HTMLLNKL
              RESET     HTMLLNKL
.
              PACK      HTMLLNK4,SP70,SP70,SP70,SP70
              CLEAR     HTMLLNK4
              APPEND    "<img src=../images/DocumentIcon.gif ",HTMLLNK4
              APPEND    "onclick=displayOEC('",HTMLLNK4
              APPEND    WBOCVISN,HTMLLNK4
              APPEND    WBOCCNTR,HTMLLNK4
              APPEND    "','",HTMLLNK4
              APPEND    WBOCURNO,HTMLLNK4
              APPEND    "','",HTMLLNK4
              APPEND    WBOCVISN,HTMLLNK4
              APPEND    "');>",HTMLLNK4
              RESET     HTMLLNK4
.
              REP       "+ ",WBOCURNO
              REP       "+ ",WBOCVISN
              REP       "+ ",WBOCCNTR
.            ENDIF
          ENDIF
.
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
          CLEAR     PATLINK
          APPEND    LINKPRG,PATLINK
          APPEND    ".pbl?reportno=",PATLINK
          APPEND    LINKREP,PATLINK
          APPEND    "&template=",PATLINK
          APPEND    LINKTEM,PATLINK
          APPEND    "&urnumber=",PATLINK
          APPEND    URNUMBER,PATLINK
          APPEND    "&admissno=",PATLINK
          APPEND    ADMISSNO,PATLINK
          RESET     PATLINK
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":        * 0
                             "#"",ADMISSNO,"#",":                 * 1
                             "#"",FORMATNM,"#",":                 * 2
                             "#"",CLAIMDES,"#",":                 * 3
                             "#"",WBEFHFND,"#",":                   * 4
                             "#"",STATUS25,"#",":                 * 5
                             "#"",WBEFEADT,"#",":                    * 6
                             "#"",DISPCOMP,"#",":                 * 7
                             "#"",DSWOECST,"#",":                 * 8
                    "#"",WBOCCDTE,WBOCCTIM,"#",":                 * 9
                             "#"",REQUFLAG,"#",";                 * 10
.
. Request checkbox: disable if mandatory fields incomplete (oecrflag=0)
.                   otherwise default to ticked (oecrflag=1)
.
          ADD       ONE,RECCNT                                    * 11
          MOVE      RECCNT,DRECCNT
          REP       " 0",DRECCNT
.
          MATCH     SP70,WBEFPRIC
          IF        !@EQUAL & !@EOS
            MATCH     SP70,WBEFPRIM
            IF        !@EQUAL & !@EOS
              MOVE      ZERO,OECRFLAG
            ENDIF
          ENDIF
.
          IF        OECRFLAG<>1
            WRITE     HTMLFILE;"#"<input type=checkbox name=oereq",DRECCNT:
                      " disabled><br>OECW fields incomplete";
          ELSE
            WRITE     HTMLFILE;"#"<input type=checkbox checked=true name=oereq":
                      DRECCNT:
                      " onClick=UpdateArray(this.value); value='",ADMISSNO:
                      OECRFLAG,"'>";
          ENDIF
.
.>>>>>    IF        OECRFLAG=1
            WRITE     HTMLFILE;"#",#"",PATLINK;
            CALL      PATFLD00
            WRITE     HTMLFILE;"#",#"",KEY3;
            WRITE     HTMLFILE;"#",#"",WBEFDIAG;
.
            MOVE      SP70,DOCFNAME
            MOVE      BKREADOC,KEY6
            CALL      RDDOCT1
            IF        OVRCD=0
              MOVE      DTITL,FMTTITLE
              MOVE      DGNAME,FMTGNAME
              MOVE      DSNAME,FMTSNAME
              CALL      DOCNM000
            ENDIF
.
            WRITE     HTMLFILE;"#",#"",DOCFNAME;
.
            IF        ELCHFLAG=ZERO
              WRITE     HTMLFILE;"#",#"<input type=checkbox name=oechk",DRECCNT:
                                 " disabled>";
            ELSE
              IF        ELCHFLAG=ONE
                WRITE     HTMLFILE;"#",#"<input type=checkbox name=oechk":
                                   DRECCNT:
                                   " onclick='UpdateElgCheck(this);'":
                                   " value='",ADMISSNO,"'>";
              ELSE
                WRITE     HTMLFILE;"#",#"<input type=checkbox checked name=oechk":
                                   DRECCNT:
                                   " onclick='UpdateElgCheck(this);'":
                                   " value='",ADMISSNO,"'>";
              ENDIF
            ENDIF
.
            MATCH     SP70,WBEHPSCD
            IF        @EQUAL | @EOS
              WRITE     HTMLFILE;"#",#"",HTMLLNKL,HTMLLNK4;
            ELSE
              WRITE     HTMLFILE;"#",#"",HTMLLNKL,HTMLLNK4,WBEHPSCD;
            ENDIF
.
            WRITE     HTMLFILE;"#",#"",HTMLLNK3;
.
            CALL      PRILB000
            CALL      MBSB0000
.
.           IF        OECRFLAG<>1
.             WRITE     HTMLFILE;"#",#"<input type=checkbox name=oeccn":
.                                  DRECCNT:
.                                  " disabled>";
.           ELSE
              MATCH     "1",BKRXPOEC
              IF        @EQUAL
              WRITE     HTMLFILE;"#",#"<input type=checkbox checked name=oeccn":
                                   DRECCNT:
                                   " onclick='UpdateOECConsentBook(this);'":
                                   " value='",ADMISSNO,"'>";
              ELSE
                WRITE     HTMLFILE;"#",#"<input type=checkbox name=oeccn":
                                   DRECCNT:
                                   " onclick='UpdateOECConsentBook(this);'":
                                   " value='",ADMISSNO,"'>";
              ENDIF
.           ENDIF
.
          IF        OECRFLAG=1
            WRITE     HTMLFILE;"#");":
                               " UpdateArray('",ADMISSNO,OECRFLAG,"');"
          ELSE
            WRITE     HTMLFILE;"#");"
          ENDIF
.
          IF        RECCNT>=99
            WRITE     HTMLFILE;"alert('Limit of 99 records reached');"
            GOTO      COBW9000
          ENDIF
.
          GOTO      COBW1000
.
COBW9000
COBW9999  RETURN
+
.******************************************************************************
.         Validate eligibility criteria for OECW Theatre Booking Only
.******************************************************************************
. Exclude all bookings not meeting the following criteria:
.
VOEB0000  MATCH     "1",BKRXPOEC
          GOTO      VOEB9500 IF NOT EQUAL
.
          MOVE      BKREURNO,KEY8
          CALL      RDMAST1
          IF        OVRCD=1
            GOTO      VOEB9500
          ENDIF
.
          MATCH     SP70,PSNAME            * surname set?
          IF        @EQUAL
            GOTO      VOEB9500
          ENDIF
.
          MATCH     SP70,PGNAME            * given name set?
          IF        @EQUAL
            GOTO      VOEB9500
          ENDIF
.
          MATCH     SP70,PBDATE            * DOB set?
          IF        @EQUAL
            GOTO      VOEB9500
          ENDIF
.
          MATCH     SP70,WBEFHFND          * Health fund set ?
          IF        @EQUAL
            GOTO      VOEB9500
          ENDIF
.
          MATCH     SP70,WBEFHFNT          * Health fund table set ?
          IF        @EQUAL
            GOTO      VOEB9500
          ENDIF
.
          MATCH     SP70,WBEFEADT          * Admission date set ?
          IF        @EQUAL
            GOTO      VOEB9500
          ENDIF
.
          MATCH     SP70,WBEFCLTY          * claim type set ?
          IF        @EQUAL
            GOTO      VOEB9500
          ENDIF
.
.         MATCH     SP70,WBEFDIAG          * admitting diagnosis set ?
.         IF        @EQUAL
.           MATCH     SP70,WBEFPRIM        * admitting mbs set ?
.           IF        @EQUAL
.             GOTO      VOEB9500
.           ENDIF
.         ENDIF
.
          MATCH     SP70,WBEFISTY      * Intended stay (sameday) indicator set?
          IF        @EQUAL
            GOTO      VOEB9500
          ENDIF
.
          MATCH     SP70,WBEFPRIC      * Presenting Illness Code CAT (il) ?
          IF        @EQUAL | @EOS
             MATCH     SP70,WBEFPRIM        * admitting mbs set ?
             IF        @EQUAL | @EOS
               GOTO      VOEB9500
             ENDIF
          ENDIF
.
          MOVE      DBKREBOO,KEY8
          CALL      RDPTELG1
          IF        OVRCD=1
            GOTO      VOEB9000
          ENDIF
.
          MATCH     "1",PTELCMPL          * eligibility Check Complete ?
          IF        @EQUAL
            GOTO      VOEB9500
          ENDIF
.
.         MATCH     SP70,PTELSPEA          * Pre-Existing Ailment indicator set?
.         IF        @EQUAL
.           GOTO      VOEB9500
.         ENDIF
.
.         MATCH     SP70,PMVXIDUS      * Intended stay (sameday) indicator set?
.         IF        @EQUAL
.           GOTO      VOEB9500
.         ENDIF
.
.         MATCH     SP70,PMVXPILC      * Presenting Illness Code CAT (il) ?
.         IF        @EQUAL
.           GOTO      VOEB9500
.         ENDIF
.
VOEB9000  MOVE      ONE,OECRFLAG            * send OEC
          GOTO      VOEB9999
.
VOEB9500  MOVE      ZERO,OECRFLAG           * don't send OEC
VOEB9999  RETURN
+
.----------------------------------------------------------------
. Display Presenting Illness select list in Bulk OECW table sorts
.----------------------------------------------------------------
PRILW000  WRITE     HTMLFILE;"#",#"";
.
          WRITE     HTMLFILE;"<input type=hidden name=oecad",DRECCNT:
                             " value='",ADMISSNO,"'>";
.
          WRITE     HTMLFILE;"<input type=hidden name=oecct",DRECCNT:
                             " value='",WBOCCNTR,"'>";
.
          WRITE     HTMLFILE;"<select name=oecil":
                             DRECCNT:
            " onchange='checkPresillMBS(this,TableForm.oecmb",DRECCNT,",TableForm.oecad",DRECCNT,",TableForm.oecct",DRECCNT,");'>":
            "<option value='   '></option>";
.
          MOVE      "il",CATEGORY
          MOVE      PMVXPILC,CODE
          CALL      CODSQO00
.
          WRITE     HTMLFILE;"</select>";
.
PRILW999  RETURN
+
.-----------------------------------------------------------------------------
. Display Presenting Illness select list in Bulk OECW table sorts Booking only
.-----------------------------------------------------------------------------
PRILB000  WRITE     HTMLFILE;"#",#"";
.
          WRITE     HTMLFILE;"<input type=hidden name=oecad",DRECCNT:
                             " value='",ADMISSNO,"'>";
.
          WRITE     HTMLFILE;"<input type=hidden name=oecct",DRECCNT:
                             " value='",WBOCCNTR,"'>";
.
          WRITE     HTMLFILE;"<select name=oecil":
                             DRECCNT:
            " onchange='checkPresillMBSBook(this,TableForm.oecmb",DRECCNT,",TableForm.oecad",DRECCNT,",TableForm.oecct",DRECCNT,");'>":
            "<option value='   '></option>";
.
          MOVE      "il",CATEGORY
          MOVE      WBEFPRIC,CODE
          CALL      CODSQO00
.
          WRITE     HTMLFILE;"</select>";
.
PRILB999  RETURN
+
.------------------------------------------------------------
. Add MBS Items lookup to Bulk OECW Table Sort
.------------------------------------------------------------
MBSB0000  UNPACK    WBEFEADT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          WRITE     HTMLFILE;"#",#"";
          WRITE     HTMLFILE;"<input type=hidden name=oecdt",DRECCNT:
                             " value='",CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"'>";
.
          WRITE     HTMLFILE;"<input type=text name=oecmb",DRECCNT," size=9":
          " maxlength=9 onblur='validateCode(4,this,TableForm.oecds",DRECCNT:
         ",TableForm.oecdt",DRECCNT,");checkPresillMBSBook(TableForm.oecil",DRECCNT;
.
          MATCH     SP70,WBEFPRIM
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;",this,TableForm.oecad",DRECCNT,",TableForm.oecct",DRECCNT,");' value=''>";
          ELSE
            WRITE     HTMLFILE;",this,TableForm.oecad",DRECCNT,",TableForm.oecct",DRECCNT,");' value='",WBEFPRIM,"'>";
          ENDIF
.
          WRITE     HTMLFILE;"<input type=text notab readonly":
          " name=oecds",DRECCNT," size=17>";
.
          WRITE     HTMLFILE;"<img notab src='../images/SearchIcon.gif' class=Icon";
          WRITE     HTMLFILE;" onClick='MbsSearchFrame(TableForm.oecmb",DRECCNT,",TableForm.oecds",DRECCNT,",TableForm.oecdt",DRECCNT,")'>";
.
          WRITE     HTMLFILE;"<img src='../images/erase.gif' class=Icon";
          WRITE     HTMLFILE;" onClick='clrFields(TableForm.oecmb",DRECCNT,",TableForm.oecds",DRECCNT,");checkPresillMBSBook(TableForm.oecil",DRECCNT:
          ",TableForm.oecmb",DRECCNT,",TableForm.oecad",DRECCNT,",TableForm.oecct",DRECCNT,");' >";
.
MBSB9999  RETURN
+
.------------------------------------------------------------
. Get HCP 1 for FHIR Response.
.------------------------------------------------------------
FHRDO100  MOVE      SP70,FHRDOCC1
          MOVE      SP70,FHRDOCT1
          MOVE      SP70,FHRDOCN1
.
          MATCH     SP70,ADOCTA
          GOTO      FHRDO199 IF EQUAL
.
          PACK      KEY10,ADOCTA,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,GFRDOC99
.
          CLEAR     FHRDOCC1
          APPEND    "HCP-",FHRDOCC1
          APPEND    ADOCTA,FHRDOCC1
          RESET     FHRDOCC1
          MOVE      "ADM",FHRDOCT1 *  Doctor Type
          SQUEEZE   PMHCTITL
          SQUEEZE   PMHCSNAM
          MOVE      PMHCGNAM,DIM1
          PACK      FHRDOCN1,PMHCTITL,SP1,DIM1,DOT,SP1,PMHCSNAM,SP70
.
FHRDO199  RETURN
+
.------------------------------------------------------------
. Get HCP 2 for FHIR Response.
.------------------------------------------------------------
FHRDO200  MOVE      SP70,FHRDOCC2
          MOVE      SP70,FHRDOCT2
          MOVE      SP70,FHRDOCN2
.
          MATCH     SP70,PMVXEDC1
          GOTO      FHRDO299 IF EQUAL
.
          PACK      KEY10,PMVXEDC1
          CALL      RDPMHCP1
          BRANCH    OVRCD,GFRDOC99
.
          CLEAR     FHRDOCC2
          APPEND    "HCP-",FHRDOCC2
          APPEND    PMVXEDC1,FHRDOCC2
          RESET     FHRDOCC2
          MOVE      "CON",FHRDOCT2
          SQUEEZE   PMHCTITL
          SQUEEZE   PMHCSNAM
          MOVE      PMHCGNAM,DIM1
          PACK      FHRDOCN2,PMHCTITL,SP1,DIM1,DOT,SP1,PMHCSNAM,SP70
.
FHRDO299  RETURN
+
.------------------------------------------------------------------------------
. FHIR Location Resource for Ward.
.------------------------------------------------------------------------------
RESWRD00  STRIP     WBDESC
          STRIP     PTHSHOSP
          CLEAR     KEY16
          APPEND    "Ward-",KEY16
          APPEND    WWARD,KEY16
          APPEND    SP70,KEY16
          RESET     KEY16
          STRIP     WBTPFIL
          WRITE     HTMLFILE;*+," { #"resourceType#": #"Location#",":
                    " #"id#": #"",KEY16,"#",":
                    " #"extension#": [":
                    " { #"url#":#"%BASEURL/extension/webPASService#"":
                        " ,#"valueString#":#"",PRGID,SP1,PRGNAM,SP1,VERSION,"#"},":
                    " { #"url#":#"%BASEURL/extension/webPASTemplate#"":
                        " ,#"valueString#":#"%TEMPLATEHOME/",WBTPFIL," %TEMPLATEVERSION#"}":
                    " ],":
                    " #"identifier#": { #"value#": #"",KEY16,"#"},":
                    " #"name#": #"",WBDESC,"#",":
                    " #"physicalType#": {":
                    "  #"coding#": [ {":
                    "   #"system#": #"http://hl7.org/fhir/location-physical-type#",":
                    "   #"code#": #"wa#",":
                    "   #"display#": #"Ward#"  } ] },";
          MATCH     SP70,WEXTN
          IF        !@EQUAL
             WRITE     HTMLFILE;*+," #"telecom#": [":
                       "{ #"system#": #"phone#",":
                       "  #"value#": #"",WEXTN,"#" } ],";
          ENDIF
          WRITE     HTMLFILE;*+," #"partOf#": { ":
                    "  #"reference#": #"Location/Hospital-",PTWDHOSN,"#"":
                    " } } ";
          RETURN
+
.------------------------------------------------------------------------------
. Write Patient Attribute 030 for Nursing Pre-assessment
.------------------------------------------------------------------------------
PTATTR00  CALL      CLPATATR
.
          CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          CLOCK     TIME,CTIMEIS
.
          PACK      KEY35,BKREURNO,ADMISSNO,ATYPE030,Z70
          CALL      RSPTATR3
          BRANCH    OVRCD,PTATTR50
          CALL      RPPTATR3
.
          MATCH     BKREURNO,PTARURNO
          GOTO      PTATTR50 IF NOT EQUAL
          MATCH     ADMISSNO,PTARVISN
          GOTO      PTATTR50 IF NOT EQUAL
          MATCH     "030",PTARTYPE
          GOTO      PTATTR50 IF NOT EQUAL     * no previous "030" record exists
.
          PACK      PTARDELR,ONE,SP70
          PACK      PTARFDTE,CURRDATE,SP70
          PACK      PTARFTME,CTIMEIS,SP70
          PACK      PTARFUSR,USERID,SP70
.
          CALL      UPPTATR3                  * Finish previous "030" record
.
PTATTR50  CALL      CLPATATR
.
          PACK      PTARURNO,BKREURNO,SP70
          PACK      PTARVISN,ADMISSNO,SP70
          PACK      PTARDATE,BOKRX012,SP70
          PACK      PTARTIME,BOKRX036,SP70
          PACK      PTARTYPE,ATYPE030,SP70
.
          PACK      KEY35,PTARURNO,PTARVISN,PTARTYPE,PTARDATE,PTARTIME,SP70
          CALL      RDPTATR3
          IF        OVRCD=1
            PACK      PTARDELR,ZERO,SP70
            PACK      PTARCOD1,BOKRX009,SP70
            PACK      PTARUUSR,USERID,SP70
            PACK      PTARUDTE,CURRDATE,SP70
            PACK      PTARUTME,CTIMEIS,SP70
            PACK      PTARTXT1,PTATR014,SP70,SP70
            PACK      PTARTXT2,PTATR015,SP70,SP70
            PACK      PTARTXT3,PTATR016,SP70,SP70
            PACK      PTARTXT4,PTATR017,SP70,SP70
            PACK      PTARCUSR,USERID,SP70
            PACK      PTARCDTE,CURRDATE,SP70
            PACK      PTARCTME,CTIMEIS,SP70
            CALL      WRPTATR3                  * write "030" record
          ELSE
            PACK      PTARDELR,ZERO,SP70
            PACK      PTARCOD1,BOKRX009,SP70
            PACK      PTARUUSR,USERID,SP70
            PACK      PTARUDTE,CURRDATE,SP70
            PACK      PTARUTME,CTIMEIS,SP70
            PACK      PTARTXT1,PTATR014,SP70,SP70
            PACK      PTARTXT2,PTATR015,SP70,SP70
            PACK      PTARTXT3,PTATR016,SP70,SP70
            PACK      PTARTXT4,PTATR017,SP70,SP70
            CALL      UPPTATR3                  * update "030" record
          ENDIF
.
PTATTR99  RETURN
+
.------------------------------------------------------------------------------
. FHIR Location Resource for Bed
.------------------------------------------------------------------------------
RESBED00  MOVE      "BT",CATEGORY
          MOVE      WEFRBT,CODE
          CALL      GETCOD00
          MOVE      TDESC,BEDTDESC
.
          MOVE      "RT",CATEGORY
          MOVE      WRTYPE,CODE
          CALL      GETCOD00
          MOVE      TDESC,ROOMDESC
.
          MOVE      CATBW,CATEGORY
          MOVE      PTWDIFST,CODE
          CALL      GETCOD00
          MOVE      TDESC,IFSTDESC
.
          COMPARE   ZERO,WACTIVE
          IF        @EQUAL
            MOVE      "true",ACTVDESC
          ELSE
            MOVE      "false",ACTVDESC
          ENDIF
          STRIP     PTHSHOSP
          STRIP     WBTPFIL
.
          CLEAR     KEY16
          APPEND    "Bed-",KEY16
          PACK      WWARD,WWARD,SP70
          APPEND    WWARD,KEY16
          APPEND    WBED,KEY16
          APPEND    SP70,KEY16
          RESET     KEY16
          STRIP     KEY16
          REP       " -",KEY16
          STRIP     WWARD
.
          WRITE     HTMLFILE;*+,"{#"resourceType#": #"Location#",":
                    " #"id#": #"",KEY16,"#",":
                    " #"extension#": [":
                    " { #"url#":#"%BASEURL/extension/webPASService#"":
                        " ,#"valueString#":#"",PRGID,SP1,PRGNAM,SP1,VERSION,"#"},":
                    " { #"url#":#"%BASEURL/extension/webPASTemplate#"":
                        " ,#"valueString#":#"%TEMPLATEHOME/",WBTPFIL," %TEMPLATEVERSION#"}":
                    " ],":
                    " #"identifier#": { #"value#": #"",KEY16,"#"},":
                    " #"name#": #"",WBDESC,"#",":
                    " #"physicalType#": {":
                    "  #"coding#": [ {":
                    "   #"system#": #"http://hl7.org/fhir/location-physical-type#",":
                    "   #"code#": #"bd#",":
                    "   #"display#": #"Bed#"  } ] },";
.
          MATCH     SP70,WEXTN
          IF        !@EQUAL
             WRITE     HTMLFILE;*+," #"telecom#": [":
                       "{ #"system#": #"phone#",":
                       "  #"value#": #"",WEXTN,"#" } ],";
          ENDIF
          WRITE     HTMLFILE;*+," #"partOf#": { ":
                    "       #"reference#": #"Location/Ward-",WWARD,"#"":
                    " } } "
.
          RETURN
+
.*****************************************************************************
.*        I/O Includes                                                       *
.*****************************************************************************
.
          INC       WEBDATCD                     * standard include
          INC       FHRDATCD                     * standard include
          INC       RSHWEBCD
          INC       CLPATELG
.
          INC       BEDBDVCD
          INC       BEDBDPRO
          INC       BOKRECTM
          INC       BOKRX1TM
          INC       CALCAGE
          INC       CLBOKRC1
          INC       CLBOKRX1
          INC       CLNHIMAS
          INC       CLOPRDEA
          INC       CLOPRSES
          INC       CLPMSPX2
          INC       CLPATMAS
          INC       CLPMSOEC
          INC       CLVISIAU
          INC       CLWATOPA
          INC       CLWEBOEC
          INC       DAYOFWEK
          INC       DGCLICUP
          INC       DGCLIUWL                * HL7 Update W/L Entry
          INC       GENBOKNO
          INC       GENANVIS
          INC       IBAWEBCD
          INC       LSTALERT
          INC       NAMSTRCD
          INC       NHOSPDAY
          INC       PATATRTM
          INC       PATDOCCD
          INC       PATDOCTM
          INC       PATMASTM                * Paitient master include
          INC       PATMSXTM
          INC       PATNAMCD
          INC       PMIGTNID
          INC       PMSHCGTM
          INC       PMSHCPTM
          INC       PMSIFTTM
          INC       PMSMORTM
          INC       PMSSMHCD
          INC       PMSPX2TM
          INC       PMSOECTM 
          INC       WEBOECTM
          INC       VISCMTCD
.
          INC       OBSPCOIO/INC      * Patient Correspondence
          INC       ACCCMTIO/INC
          INC       ACCAUDIO/INC
          INC       ALLREFIO/INC
          INC       APSMASIO/INC
          INC       BOKDIAIO/INC       
          INC       BOKRC1IO/INC
          INC       BOKRX1IO/INC
          INC       CATCOMIO/INC
          INC       COMERHIO/INC
          INC       EMRVISIO/INC            * Emergency
          INC       EOCACCIO/INC
          INC       EOCLNKIO/INC
          INC       EOCREFIO/INC
          INC       IBAPHNIO/INC  
          INC       MEHVI1IO/INC
          INC       MLTSECIO/INC
          INC       MRTMASIO/INC
          INC       MLTHCPIO/INC
          INC       MRTVISIO/INC
          INC       NHIETHIO/INC
          INC       NHIMASIO/INC
          INC       NZPSPRIO/INC            * NZ Priv Subseq't Proc/Funder Det
          INC       OBSPCTIO/INC
          INC       OPRDEAIO/INC
          INC       OPRSESIO/INC
          INC       OUTBB1IO/INC
          INC       OUTBOAIO/INC
          INC       OUTCANIO/INC            * reqd for outpatient cancellations
          INC       OUTCLIIO/INC            * Reqd for showing clinic id desc
          INC       OUTCTYIO/INC  
          INC       OUTDIAIO/INC
          INC       OUTLETIO/INC            * Outpatient letters
          INC       OUTLHIIO/INC            * Outpatient letter history
          INC       OUTMA1IO/INC            * reqd for outpatient location
          INC       OUTPREIO/INC            * outpatient booking
          INC       OUTSITIO/INC
          INC       PATALRIO/INC
          INC       PATATRIO/INC
          INC       PATBMDIO/INC
          INC       PMSUCHIO/INC
          INC       PMSUCDIO/INC
          INC       PMSEXTIO/INC
          INC       PATDADIO/INC
          INC       PATDO1IO/INC
          INC       PATDSCIO/INC
          INC       PATECDIO/INC
          INC       PATELGIO/INC
          INC       PATFN1IO/INC
          INC       PATHSPIO/INC
          INC       PATIN1IO/INC
          INC       PATLOCIO/INC
          INC       PATMA1IO/INC  
          INC       PATMI1IO/INC  
          INC       PATNIDIO/INC
          INC       PATONLIO/INC
          INC       PATPR1IO/INC
          INC       PATTRNIO/INC          
          INC       PATVADIO/INC  
          INC       PATVENIO/INC
          INC       PATVISIO/INC  
          INC       PATWC1IO/INC
          INC       PATWR1IO/INC 
          INC       PATRGMIO/INC
.
          INC       PMSLRDIO/INC
          INC       PMSCCDIO/INC   * Concession Card Details
          INC       PMSREGIO/INC
          INC       PMSAIDIO/INC                                      *I-174484
          INC       PMSBBDIO/INC
          INC       PMSBRQIO/INC
          INC       PMSEPBIO/INC
          INC       PMSELFIO/INC
          INC       PMSCNOIO/INC
          INC       PMSHCGIO/INC
          INC       PMSHCPIO/INC
          INC       PMSIFTIO/INC
          INC       PMSMORIO/INC	
          INC       PMSNUTIO/INC
          INC       PMSOECIO/INC
          INC       PMSPX2IO/INC  
          INC       PMSCEXIO/INC
          INC       PMSRELIO/INC
          INC       PMSTLEIO/INC
          INC       PMSSMHIO/INC
          INC       PMSSRMIO/INC
          INC       PMSSRRIO/INC
          INC       PMSVX1IO/INC
          INC       PMSWORIO/INC            * I-54257
          INC       PMSWTRIO/INC
          INC       PMSWX1IO/INC
          INC       VISCMTIO/INC            * visit comments file
          INC       VISIAUIO/INC
          INC       VISINTIO/INC
          INC       WATHISIO/INC
          INC       WATMESIO/INC
          INC       WATLETIO/INC
          INC       WATTR1IO/INC
          INC       WATESEIO/INC
          INC       WATSUSIO/INC
          INC       WATCATIO/INC
          INC       WATESNIO/INC
          INC       WATOPAIO/INC
          INC       WATOPSIO/INC
          INC       WATTX1IO/INC
          INC       WEBOECIO/INC
          INC       WEBELFIO/INC
          INC       WEBEEHIO/INC
          INC       RCPDTEIO/INC
          INC       RCPBNKIO/INC
          INC       COMPARIO/INC

          INC       CLCOMPAR
          INC       GTCMPA00

          INC       PMSWORTM                * I-54257
          INC       TFILENAM
          INC       CALCLEAV
          INC       CALCBMIN
          INC       CLPATATR
          INC       CLPMSNUT
          INC       CLWATTX1
          INC       CLPATWC1
          INC       CLPMSWX1
          INC       CLACCAUD                    * Clear ACC Audit file variables
          INC       CLPATMIS
          INC       CLPMSVX1
          INC       CLPMSLRD
          INC       CLPMSELF
          INC       CLWEBELF
          INC       CLWEBEEH  
