.----------------------------------------------------------------------
. Program       : MEHWEB01
.
. Function      : Mental Health Web Server
.
. Modifications : 
.----------------------------------------------------------------------
. V12.00.01 26.05.2025 Bella Turco     TSK 0955096
.           Alphanumeric changes                                          
. V11.05.02 20.12.2024 DA Sarkies      TSK 0954547
.           Commented out <cat> tags to prevent browser incompatibility
. V11.05.01 26.11.2024  Ebon Clements  Task 0954547
.           Added <cat-c> start and end tag to category=XX tag
. V11.03.05 10/01/2023  Bella Turco   TSK 0921957
.           Continued adding PTCNNRTD & NOMORE00 to maintenance lists
. V11.03.04 23/12/2022  Thanh T.      TSK 0898149
.           Removed setting MHDLSENT to 'N' when creating an inactive
.           legal status
. V11.03.03 20/12/2022  Thanh T.      TSK 0898149
.           Changed UPDDRS02. When creating an inactive legal status,
.           update MHDLEDAT/MHDLETIM with MHDLSDAT/MHDLSTIM and only
.           when MHDLEDAT and MHDLETIM are blanks   
. V11.03.02 15/12/2022  Thanh T.      TSK 0898149
.           Changed UPDDRS02 to update MHDLEDAT and MHDLETIM when creating
.           an inactive legal status  
. V11.03.01 22/11/2022  Bella Turco   TSK 0921957
.           Added NOMORE00 - Display "No more records" at end of list
.           Added PTCNNRTD - Displays number of rows set by parameter value
. V11.02.03 23/05/2022   Thanh T        TSK 0916833
.           Changed ACTVLS00 to reset the MHDLSENT send flag to "N" when
.           the status is reactive to active
. V11.02.02 12/04/2022  Sunny          TSK 0858604
.           Added CKPR0000 - to check prev visit and MH Diagnosis records
. V11.02.01 31/03/2022  Sunny          TSK 0858604
.           Recompiled for MEHDIA00
. V11.01.04 30/03/2022  Jill Parkinson TSK 0858604
.           Added match to template 005 in MEHDIA00 to allow view 
.           without a MH visit in context
. V11.01.03 29/11/2021  Sunny          TSK 0858604
.           1) Changed MEHDIA00 to write the new UR No in mehdiaaf
.           2) Added MHDLU000 to show all MH Diagnosis records for a patient
. V11.01.02 16/07/2021  J.Tan          TSK 0836566
.           Added LS management supervisor
. V11.01.01 22/03/2021  Don Nguyen     TSK 0902599
.           Corrected HTML where <font> and <b> tags are used
. V11.00.04 09/12/2020  Thanh T        TSK 0872840
.           Added PMSCCDFD/PMSCCDIO as PMSPX2TM changes
. V11.00.03 05/10/2020  Thanh T.      TSK 0887664
.           Changed RLIS0000 to add Responsible DHB description
. V11.00.02 01/06/2020  Thanh T.       TSK 0858656
.           Changed MHDLX000
. V11.00.01 30/03/2020  Jill Parkinson Task 0890087 
.           Recompiled for MEHDIATD
. V10.15.03 03/02/2020   Ebon Clements   TSK 0887467
.           Added any open legal status .3 tag to PEDAT000
. V10.15.02 07/11/2019   Tracey Nguyen   TSK 0862225
.           Modified MHRAC000 to correct the value of ATEXISTS
. V10.15.01 09/10/2019   Tracey Nguyen   TSK 0862225
.           Modified Mental Health Activity tag - MHRAC000, MHRAT000, OUTFIL00
.           ATEXISTS, SAVREFNO:
.           1)Added check for attended outpatient appointment linked to the 
.             referral 
.           2)Added check for attended group sessions linked to the referral
.           3)Added check if the Referral is a Primary Referral 
.            (allrefaf.alreuyn4=1) and has one or more linked referral, all 
.            Referrals will be checked for activity
.----------------------------------------------------------------------
. V10.14.08 20/08/2019  Thanh T.        TSK 0837991
.           Changed UPDDRS00 to write out the correct mehaudda audit rows
.           when start date/time is changed.
. V10.14.07 15/08/2019  Thanh T.        TSK 0837991
.           Changed UPDDRS00 to write out the correct mehaudda audit rows  
.           when start date/time is changed.
. V10.14.06 14/08/2019  Thanh T.        TSK 0878422
.           Recompiled for MEHHLSTM changes
. V10.14.05 12/08/2019  Thanh T.        TSK 0837991
.           Changed UPDDRS00 to not allocate the new unique for MHDLUNIQ when
.           a new mehdlsaf is created.           
. V10.14.04 25/07/2019  Thanh T.        TSK 0837991
.           Added UPDDRS00, CHGSND00 for updating legal status details 
. V10.14.03 04/06/2019  Tracey Nguyen   TSK 0856503
.           Recomplied for MEHDIATD/TM - Added Diagnosis type 1 to 6
. V10.14.02 12/03/2019  Tracey Nguyen   TSK 0863060
.           Recompiled for PATVISTM - Added VISS6400 & VISS6500
. V10.14.01 25/02/2019  Davin           TSK 0866465
.           Added HL7 triggers REF^I13 & ADT^A08 for mental health diagnosis
.           (BRDI1300 and BRDA0800 @ MEHDIA00)
.----------------------------------------------------------------------
. V10.13.02 09/01/2019  Nicole Torrisi  TSK 0867135
.           Changed Review Status in LS List to use Cat LR description
.           (LSHEAD00)
. V10.13.01 15/08/2018  Tracey Nguyen   TSK 0852969
.           1)Added HEAVIEW1 CGI variable to indicate the view/validation
.             required for HEA
.           2)Modified ADDREF00, CREF0000, OMHR0000 to validate Referral Source
.             (Cat S Ind7=I) for HEAVIEW1=1
.----------------------------------------------------------------------
. V10.12.04 18/05/2018  Thanh T.        TSK 0851528
.           Recompiled for PATVISTM changed
. V10.12.03 29/03/2018  Richa Phogat    TSK 0853040
.           Updated ADDDRF00 to automatically end previous Active Legal Status
.           entry when adding a new Legal Status which is a duplicate of an
.           existing inactive one
. V10.12.02 09/02/2018  Richa Phogat    TSK 0848894
.           Updated condition in ADDDRF00 to display error message instead of
.           crashing the system when a duplicate record is added
. V10.12.01 09/01/2018  Richa Phogat    TSK 0848894
.           Allow it to add a LegalStatus record by incrementing one second when
.           already an inactive LS record exists (ADDDRF00)
.----------------------------------------------------------------------
. V10.11.06 27/11/2017  Thanh Tieu     Task 0821710
.           Recompiled as PATMASTM changed
. V10.11.05 19/10/2017  J.Tan         TSK 0843390
.           Added Responsible DHB on Legal Status Referrer
. V10.11.04 30/07/2017  Thanh T.       TSK 0821710
.           Audit admission/outpatient/UR comments. changed PATMASTM/PMSPX2TM.
. V10.11.03 27/07/2017  Davin          TSK 0838315
.           Added five HL7 triggers for A31 messages (send if PTCNSZLS > 0)
. V10.11.02 26/07/2017  Thanh T.       TSK 0821710
.           Recompiled PASMISTM
. V10.11.01 14/07/2017  Thanh T.       TSK 0821710
.           Audit Amission/outpatient visit comments. PATMISTM changed.
.----------------------------------------------------------------------
. V10.10.07 14/06/2017  Richa Phogat   TSK 0301799
.           Modified Responsible HCP and Cast Team in MHDLX000 to display blank
.           values when mehdiaaf.mhdihcpc or mehdiaaf.mhdicast have blank value
. V10.10.06 02/06/2017  Richa Phogat   TSK 0301799
.           Add Responsible HCP and Cast Team in MHDLX000
. V10.10.05 18/05/2017  Richa Phogat   TSK 0823770
.           Added new tag for 'Include Blank Reminder Dates' and new condition 
.           to include/exclude blank reminder date records
. V10.10.04 16/05/2017  Richa Phogat   TSK 0309890
.           Replaced OPENDATE by REVWDATE in GETDAT00 to calculate Reminder Date
. V10.10.03 19/04/2017  Thanh T.       TSK 0827923
.           Changed to show the long description of the legal status instead
.           of short description on mehweb0109003 and mehweb0109003.
. V10.10.02 18/04/2017  Richa Phogat   TSK 0309890
.           Modified Reminder Days to be moved from 'Indicator 2' (patcodes.
.           tcindc2) to 'Associate Field 1' (patcodes.ptcdasc1)
. V10.10.01 12/04/2017  Ebon Clements  TSK 0834176
.           Check contacts will be include in PRIMHD extract
.           MHRAC000 - MHREA000
. V10.09.02 27/01/2017  Ebon Clements  TSK 0828785
.           Recompiled for ALLREFTM - OP Site selection list security test
. V10.09.01 19/12/016  Jill Parkinson  TSK 0829574
.           Mods to ignore inactive legal status records in ADDDRF00
. V10.08.06 11/10/2016  Peter Vela     TSK 0820798
.           Added before and after write to audit file when updating
.           Mental Health Legal Status End Date and Time in ADDDRF40
. V10.08.05 07/10/2016  Peter Vela     TSK 0824570
.           Added new tag for Legal Status long description drop down
.           selection list
. V10.08.04 08/09/2016  Ania P         CAR 0821339
.           Output User Name not User ID in HEDHIS00
. V10.08.03 05/09/2016  Ebon Clements  TSK 0820887
.           Fixed duplicate legal status file reads for U/R - ADDDRF00
. V10.08.02 16/08/2016  Peter Vela     TSK 0313694
.           Added active validation in UPDDRF00 when updateing previous legal
.           status
. V10.08.01 15/05/2016  Nicole Torrisi TSK 0817062
.           Changed ADDDRF00 - prevent Legal Status duplicates where Ind 11=D
.           Changed DLIS0000 - extra columns for Legal Status Supervisor table
.           Changed UPDDRF00 - use Ind 10=N to prevent setting of End Date/Time
.           Added LSRF3300 and LSRF3400 for Legal Status Id field
.           Added Legal Status ID column to Legal Status Details History table
. V10.07.02 15/03/2016  Peter Vela     CAR 0814048
.           Added End Date/Time to DETHIS00
. V10.07.01 01/10/2015  Peter Vela     CAR 316641
.           Fixed validation against ALENVISN in Mental Health Referral
.           Activity tags
. V10.06.07 25/09/2015  Peter Vela     CAR 316641
.           Added inpatient visit validation to Mental Health Referral Activity
.           tags
. V10.06.06 22/09/2015  Peter Vela     CAR 316641
.           Added tag for Mental Health Referral activity
.           Added tag for Mental Health Referral earliest activity date
. V10.06.05 21/09/2015  Peter Vela     CAR 321509
.           Removed validation for end date in CDSLLS13
. V10.06.04 13/08/2015  Don Nguyen        CAR 308621 
.           Recompiled for PATVISTM - Added VISS6100
.           11/08/2915  Ania P         CAR 319861
.           Recompile for ALLREFTM
. V10.06.03 12/05/2015  Ebon Clements     CAR 303890
.           Added ALLPROFD and open
. V10.06.02 20/03/2015  Don Nguyen        CAR 306757
.           Recompiled for MEHVISTM - Modified MHVS5800 to read mehdlsaf
. V10.06.01 16/03/2015  Don Nguyen        CAR 306757
.           Added PROFL990 - for redirect to raise invoice flag
.           Recompiled for MEHDISTM, MEHHLSTM and MEHVISTM
.           12/03/2015  Steve Armstrong   CAR 314108
.           Removed definition of PTCGDATE as PATCGPFD is no longer in use.
.----------------------------------------------------------------------
. V10.05.02 02/03/2015  Don Nguyen        CAR 306757
.           Fixed CHKLEG00 to go to CHKLEG98 if no Legal Status Detail records
.           (mehdlsaf) exists for the UR.
. V10.05.01 08/09/2014  J.Tan             CAR 274958
.           Added Employer to External Organisation type (pateoraf)
. V10.04.03 07/04/2014  Peter Vela        CAR 286258
.           Recompiled for PATMASTM
. V10.04.02 31.03.2014  B.G.Ackland  CAR 299363
.           Replace META Tag Redirect with Javascript in Common RDIREC00
.           Routine
. V10.04.01 26/03/2014  Ebon Clements     CAR 263127
.           Added active/inactive status to axis codes
.----------------------------------------------------------------------
. V10.03.35 01/10/2013  Patrick Adair     CAR 265798
.           Processing for Supervisor Update/Delete of MH Diagnosis records
. V10.03.34 30/08/2013  Don Nguyen        CAR 273426
.           Recompiled for changes to CLALLREF
. V10.03.33 30/06/2013  Davin             CAR 283202
.           Recompiled for changes to hl7 messaging
. V10.03.32 05/06/2013  Jill Parkinson CAR 286280    
.           Moved call to TFILENAM to be before audit branch in INIT0000
. V10.03.31 03/05/2013  Steve Armstrong  CAR 284376
.           Recompiled for changes to DGCLICUP.
. V10.03.30 29/04/2013  Ebon Clements    CAR 261630
.           Removed port number from temp file name
. V10.03.29 09/04/2013  Patrick Adair    CAR 234042
.           Increased MH diagnosis history and ICD10 to show all - MHDLX000
. V10.03.28 03/04/2013  Davin          CAR 270648
.           Recompiled for changes to HL7 messaging includes
. V10.03.27 12/10/2012  Mike Laming      CAR 272373
.           Recompiled for MEHHLSTM - Restore "Responsible Clinition" HLSF2200
. V10.03.26 10/04/2012  Mike Laming      CAR 261603
.           Remove Tables not used- MEHPATFD,MEHPCNFD,MEHPCOFD,MEHPIOFD,MEHPMFFD
. V10.03.25 06/03/2012  Mike Laming      CAR 258616
.           Mod to UPDDRF20 to set MHDLSENT to "N" (not sent) if not Inactive
. V10.03.24 15/02/2012 Peter Vela        CAR 254058
.           Added tag for Mental Health Inpatient Teams
. V10.03.23 15/02/2012  J.Tan            CAR 254056
.           Changed REFC2100 to remove checking for closed LS
. V10.03.22 07/02/2012  Peter Vela       CAR 254056
.           Changed REFC2100 to display flag for active Legal Statuses
. V10.03.21 07/02/2012  J.Tan            CAR 255259
.           Mods not allowing to have duplicate Open Inpatient Referrals
. V10.03.20 20/01/2012  Mike Laming      CAR 244643
.           Added "Case Team Description" (ALCADESC) in RMLS0000
. V10.03.19 16/01/2012  Sandra Barcham  CAR 256563
.           Recompiled for PATMASTM
. V10.03.18 03/01/2011  Peter Vela        CAR 257651
.           Added Review Date/Time display @ MHLS1500
. V10.03.17 03/01/2011  Peter Vela        CAR 252953
.           Removed End Date/Time of previous MH Legal Status when current one
.           is flagged for removal.
.           Added validation for inactive MH Legal Status record @ CDSLLS00
. V10.03.16 20/12/2011  Peter Vela        CAR 254056
.           Added indicator tag for mehdls records
. V10.03.15 20/12/2011  Peter Vela        CAR 256568
.           Added tag for open legal status key @ REFC0000
. V10.03.14 19/12/2011  Peter Vela        CAR 253349
.           Changed tags for admission date and time @ LSRF0000
. V10.03.13 19/12/2011  Peter Vela        CAR 254058
.           Added tag for ASTAT @ LSRF0000
. V10.03.12 16/12/2011  Peter Vela        CAR 254548
.           Added tags for previous legal status @ LSRF0000
. V10.03.11 15/12/2011  Peter Vela        CAR 256569
.           Changed tags in LSRF0000 to find current admission date and time
.           if existing
. V10.03.10 13/12/2011  Peter Vela        CAR 253349
.           Added tags for admission date and time to reportno 9 
. V10.03.09 09/12/2011  Peter Vela        CAR 255529
.           Validate Unique Number @ CDSLLS10
. V10.03.08 08/12/2011  Peter Vela        CAR 255529
.           Changed tag @ REFC1400 to look for open Inpatient MH Referrals only
. V10.03.07 07/12/2011  J.Tan             CAR 256568
.           Mods CHKLEG00 to check for time
. V10.03.06 06/12/2011  Peter Vela        CAR 255529
.           Added tag for open Inpatient MH Referrals
. V10.03.05 05/12/2011  Peter Vela        CAR 255529
.           Added validation for Inpatient MH Referral @ ADDREF00
. V10.03.04 25/11/2011  Peter Vela        CAR 255029
.           Added BRANCH OVRCD to REFC1500
. V10.03.03 23/11/2011  Peter Vela        CAR 255389
.           Recompiled for MEHHLSTM
.           Added Team description in RLIS0000
. V10.03.02 21/11/2011  Peter Vela        CAR 255510
.           Added less than start date validation in CHKLEG00
. V10.02.13 07/11/2011  Nicole Torrisi    CAR 244676
.           Added check on Legal Status End Date to RMLS0000
. V10.02.12 18/10/2011  Peter Vela        CAR 253188
.           Recompiled for MEHHLSTM
. V10.02.11 06/10/2011  Peter Vela        CAR 252425
.           Recompiled for MEHHLSTM
. V10.02.10 30/09/2011  Peter Vela        CAR 242151
.           Fixed order of columns @ MHLS0000
. V10.02.09 26/09/2011  Peter Vela        CAR 242151
.           Added preceding legal status functionality to WADHIS00
. V10.02.08 07/09/2011  J.Tan             CAR 242151
.           Mods for WA Mental health
. V10.02.07 03/08/2011  Peter Vela        CAR 239537
.           Added tag for preceding legal status start time
. V10.02.06 20/07/2011  J.Tan             CAR 239592
.           Mods Organisation to return contact phone
. V10.02.05 10/07/2011  Ebon Clements     CAR 242070
.           Recompiled for ALLREFTM - Referral hospital
. V10.02.04 15/07/2011  Peter Vela      CAR 246347
.           Changed Ind 4 to Ind 6 @ CDSLLS00
. V10.02.03 13/07/2011  Peter Vela      CAR 246347
.           Added tag for Legal Status Matrix selection list
. V10.02.02 21/06/2011  J.Tan           CAR 239592
.           Added Police to Organisation type
. V10.02.01 14/04/2011  Peter Vela      CAR 239537
.           Added tag for Legal Status Preceding Start Date
. V10.00.10 26/10/2010  Jill Parkinson  CAR 232009
.           Mods to save all mehhlsaf and mehdlsaf fields when making inactive
.           in UPDREF00 and UPDDRF00
. V10.00.09 20/10/2010  Davin           CAR 231688
.           Changed Reminder List (rmls0000) to use mhhlcstm for case team
. V10.00.08 29/09/2010  Peter Vela      CAR 230994
.           Recompiled for MEHHLSTM
. V10.00.07 30/08/2010  Mike Laming     CAR 228152
.           Added second ICD10 Code and first AXIS II Code 1 to Report 15
. V10.00.06 24/08/2010  Mike Laming     CAR 228152
.           Added MHDLS000 Mental Health Visit level Diagnosis List Report 15
. ......... 24/08/2010  Mike Laming     CAR 195158
.           Add "Responsible Clinician" for LS Management List at RLIS0000
. V10.00.05 20/08/2010  Mike Laming     CAR 195158
.           Recompiled for MEHHLSTM - Detail End Dates flag
. V10.00.04 12/08/2010  Mike Laming     CAR 228152
.           Mods to MEHDIA00 to stop writing blank records and duplicate data
.           18/08/2010  Davin           CAR 223805
.           Recompiled for PATVISTM
. V10.00.03 18/06/2010  Mike Laming     CAR 221911
.           Re-compiled for PATMASTM - NZ LS Alerts
. V10.00.02 31/03/2010  Mike Laming     CAR 217575
.           Recompiled for changes to MEHDIAFD
. V10.00.01 19/03/2010  Steve Armstrong   CAR 135505
.           Added HL7TRGID & HL7INCLD setting for all broadcast messages
.----------------------------------------------------------------------
. V9.12.03  08/01/2010  Mike Laming   CAR 195158
.           Recompiled for PATMASTM - Legal Status Icon change
. V9.12.02  14/12/2009  Saroeun Soeur CAR 212154
.           Recomplied for PATCODTM
. V9.12.01  23/11/2009  Mike Laming   CAR 195158
.           Mods as per Spec. - Changes to MEHHLSFD & MEHDLSFD new fields
. V9.11.06  18/03/2009  Mike Laming   CAR 191877
.           Changed PRIMHD Unique No. to DIM 3 - Change KEYS to approp. Tables
. V9.11.05  24/02/2009  Ebon Clements CAR 186403
.           Changed referral notes list to display user name - RCMTAB00
. V9.11.04  04/02/2009  Jill Habasque CAR 185175
.           Mods to output all legal status records in dlis0000
. V9.11.03  16/01/2009  Mike Laming   CAR 188016
.           Changes to External Org. Table (EORTB000) for RCH Edu.Institute
.           Add External Org. Search routines (EORSR000)
. V9.11.02  06/01/2009  Mike Laming   CAR 166690
.           Added Patient level PRIMHD Xmit Lists - Report 14
. V9.11.01  19/11/2008  Jill Habasque  CAR 178616
.           Recompiled for MEHAKIPR - mods to write axis code to keywork file
. V9.10.04  02/10/2008  Peter Vela     CAR 179602
.           Check MEHRV008 for spaces before comparison to MEHRV002  
. V9.10.03  14/08/2008  J.Tan          CAR 166690
.           Mods to set date/time/userid record updated for mehdlsaf mehhlsaf
. V9.10.02  04/06/2008  Jill Habasque  CAR 165377
.           Recompiled for MEHDIATM
. V9.10.01  22/04/2008  J.Tan          CAR 166690
.           Mods to keyin and display start time (MHDLSTIM) on screen
. V9.09.04  03/04/2008  Ebon Clements  CAR 164653
.           Recompiled for MEHHLSTM - Resindential organisation now type D
. V9.09.03  06/03/2008  J.Tan          CAR 156964
.           Added Employer details for MH
.           Added Axis III
.           06/03/2008  Jill Habasque  CAR 163309
.           Recompiled for MEHHLSTD
. V9.09.02  12/02/2008  J.Tan          CAR 135498
.           Mods for MHINC Extract
. V9.09.01  31/01/2008  Mike Laming    CAR 152286
.           Change PATEORFD fields' prefix to PTER (from PTEO - is ICD10)
. V9.08.05  29/05/2007  Jill Habasque  CAR 141121
.           Added read of allrefaf on display
. V9.08.04  15/03/2007  Jill Habasque  CAR 135513
.           Added read of allrefaf for mehvisaf status of 7 and 8
. V9.08.03  14/03/2007  Jill Habasque  CAR 115766
.           Added "Justice Department" as an external referral
. V9.08.02  25/01/2007  Peter Vela CAR 127930
.           Recompiled for MRTMASFD
. V9.08.01  06/12/2006  J.Tan         CAR 125983
.           Added admissno & urnumber to CLRPAR00
. V9.06.05  21/04/2006  J.Tan         CAR 91327
.           Added second index for audit header mehdlsaf
. V9.06.04  17/05/2006  J.Tan         CAR 90040
.           Mods Checking for MH referral file for discharging/leave
. V9.06.03  09/05/2006  J.Tan         CAR 90040
.           Mods not checking for review date for reminder list
. V9.06.02  04/05/2006  J.Tan         CAR 90040
.           Added Private hospital to Source Ref.
. V9.06.01  02/05/2006  J.Tan         CAR 90040
.           Mods to use tcindc2 catg LS to calculate Reminder date (not tcindc1)
. V9.05.02  28/03/2006  J.Tan         CAR 90040
.           Mods to default for GP and replace meheoraf with pateoraf
. V9.05.01  09/03/2006  Ebon Clements CAR 78533
.           Mods for PATCODTM - Hospital specific category codes
. V9.05.B03 30/01/2006  Ebon Clements CAR 93186
.           Mods for REDIRECT length change. Recompiled for IBAWEBDF
. V9.05.B02 20/12/2005  J.Tan         CAR 90040
.           Added options for External Organisation & Legal status referral
. V9.04.05  21/11/2005  Peter Vela    CAR 68675
.           Recompiled for PATDSCTM
. V9.04.04  01/03/2005  Peter Vela    CAR 57547
.           Recompiled for PATVADFD and PATVADIO
. V9.04.03  09/11/2004  Peter Vela     CAR 53371
.           Recompiled for PATVISTM
.           22/11/2004  Davin          CAR 44068
.           Changed mehax003 to 70 chars
. V9.04.02  14/10/2004  Guomin Fu      CAR 44068
.           Recompiled for MEHAXIFD
.           22/10/2004  Jill Habasque  CAR 46397
.           Recompiled for MEHVISTM
. V9.04.01  18.08.2004  Lina Vo        CAR 52746
.           Added open of pathspaf and included PATHSPFD & IO for PATVISTM
. V9.03.05  9/07/2004  Guomin Fu  CAR 50716
.           Removed checking on "Informal" legal status when deleting from
.           LS history as per Helen's notes in CAR call notes
. V9.03.04  07/06/2004 Peter Vela CAR 49016
.           2004 Statutory Changes - recompiled for PMSPX2TM
. V9.03.03  26/03/2004 Peter Vela    CAR 13038
.           Recompiled for PATDOCCD - Doctor Name format Parameter
. V9.03.02  30/08/2003 Jill Habasque CAR 42964
.           Commented out clearing of legal status
. V9.03.01  02/07/2003 Jill Habasque CAR 40660
.           Recompiled for PATDSCTM
. V9.02.06  11/03/2003 J.Tan
.           Recompiled for PATMISTM - admitting point
. V9.02.05  07/02/2003 Tonii CAR 35992
.           Recompiled for PATMISTM - inactive codes in patfundf
. V9.02.04  23/01/2003  J.Tan
.           Fixed validating review date
. V9.02.03  09/12/2002  J.Tan
.           Added report 6 for Legal status Review History
. V9.02.02  03/12/2002  Peter Vela    SRF 33833
.           Fixed bug: Legal Status not changing to blanks when Ind 1 = Special
. V9.02.01  29/11/2002  Jill Habasque SRF 33938
.           Added patonlvf file
. V9.02.00  09/11/2002  Peter Vela               SRF 22731
.           Added functionality for Mental Health Discharge Screen
.           09/11/2002  Jill Habasque            SRF 22730
.           Added functionality for Mental Health Leave Screen
.           16/10/2002  Lina Vo                  
.           Added Axis keyword search and Axis Maintanence.
.           12/10/2002  Katie Nelson             SRF 22726
.           Added Diagnosis Screen in Admissions
.           08/10/2002  Pat Dirito               SRF 22726
.           Created Web Server.
.----------------------------------------------------------------------
          INC       IBAWEBDF    
          INC       WEBDATDF
.
          INC       MEHDLSFD/INC
          INC       MEHHLSTD/INC
          INC       ALLCONFD/INC
          INC       ALLCASFD/INC
          INC       ALLCTMFD/INC
          INC       ALLDIAFD/INC
          INC       ALLENCFD/INC
          INC       ALLLNKFD/INC
          INC       ALLGPAFD/INC
          INC       ALLPROFD/INC
          INC       ALLPRRFD/INC
          INC       ALLQUEFD/INC
          INC       ALLREFFD/INC
          INC       ALLREFTD/INC
          INC       ALLRITFD/INC
          INC       ALLRLNFD/INC
          INC       ALLSERFD/INC
          INC       HL7CISFD/INC
          INC       HL7INBFD/INC
          INC       MEHCONFD/INC
          INC       MEHCJAFD/INC
          INC       MEHAKIFD/INC   * Axis keyword search
          INC       MEHAXIFD/INC   * MH Axis file
          INC       MEHDIAFD/INC   * MH Diagnosis History Details
          INC       MEHDIATD/INC
          INC       MEHDS1FD/INC
          INC       MEHDL1FD/INC
          INC       MEHDISTD/INC
          INC       MEHDLVTD/INC
          INC       MEHHLSFD/INC
          INC       MEHLEGTD/INC
          INC       MEHLSMFD/INC
          INC       MEHREVTD/INC
          INC       MEHLEGFD/INC
          INC       MEHREVFD/INC
          INC       MEHMDTFD/INC
          INC       MEHMTXFD/INC
          INC       MEHVISTD/INC   * MH Visit cgi fd
          INC       MEHVI1FD/INC   * MH Visit Record    
.
..notused INC       MEHPMEFD/INC   * Mental Health PRIMHD Error Table
          INC       MEHPLSFD/INC   * PRIMHD "LS" Record - Legal Status
          INC       MEHPRDFD/INC   * PRIMHD "RD" Record - Referral Disc
..notused INC       MEHPATFD/INC   * PRIMHD "AT" Record
..notused INC       MEHPCNFD/INC   * PRIMHD "CN" Record
..notused INC       MEHPCOFD/INC   * PRIMHD "CO" Record
..notused INC       MEHPOIFD/INC   * PRIMHD "OT" & "OI" record
..notused INC       MEHPTFFD/INC   * PRIMHD Transmission File table
          INC       MLTSECFD/INC
          INC       MLTSITFD/INC
.
          INC       MEHCMNFD/INC
          INC       OUTBOAFD/INC
          INC       PATEORFD/INC
          INC       PATKEOFD/INC   * Keywords for PATEORFD
          INC       PATDO1FD/INC   * Doctor File
          INC       PATHSPFD/INC
          INC       PATMI1FD/INC
          INC       PATMA1FD/INC
          INC       PATNIDFD/INC
          INC       PATONLFD/INC
          INC       PATTRNFD/INC   
          INC       PATVISFD/INC   * Patients Visits File
          INC       PMSVX1FD/INC   * Visit Extension File
          INC       PMSTEMFD/INC
          INC       PATCONFD/INC
          INC       PATALRFD/INC
          INC       OUTSITFD/INC
          INC       OUTCLIFD/INC
          INC       OUTCTYFD/INC
          INC       PRIITMFD/INC
          INC       PMSUCHFD/INC
          INC       PMSUCDFD/INC
          INC       PATMASTD/INC
          INC       PATPR1FD/INC
.
          INC       PMSCCDFD/INC   * Concession Card Details
          INC       PMSBRQFD/INC
          INC       PMSPX2FD/INC
          INC       PMSQPTFD/INC
.         INC       PMSHCGFD/INC
.         INC       PMSHCPFD/INC
          INC       PMSHCLFD/INC
          INC       PATFN1FD/INC
          INC       PATWR1FD/INC
          INC       MRTMASFD/INC
          INC       NHIMASFD/INC
          INC       NHIETHFD/INC
          INC       PATCALAG/INC
          INC       PMSPX2TD/INC
          INC       PATRE1FD/INC
          INC       PATDGWFD/INC
          INC       VISMDTFD/INC
          INC       VISMTXFD/INC
          INC       PATITMFD/INC
          INC       PATDADFD/INC
          INC       PATVADFD/INC
          INC       PATCMCFD/INC
          INC       PATASFFD/INC
          INC       PMSHCGTD/INC
          INC       PMSHCGFD/INC
          INC       PMSHCPFD/INC
          INC       PMSHCPTD/INC
          INC       TFILEVAR/INC
          INC       APSMASFD/INC
          INC       PATIN1FD/INC
          INC       PATDSCFD/INC
          INC       PATMISTD/INC
          INC       ADDSECTD/INC
.
.
.----------------------------------------------------------------------
ATEXISTS  FORM      1                       * Activity exists flag  *T0862225  
COMFILAF  FILE      ASCII, FIXED=127        * For Patient Notes
COUNTER   FORM      3
CMHTYPE   INIT      "CMH"
INPTYPE   INIT      "I/P"
INFDESC   DIM       3
IBAMFLAG  FORM      1                       * for HL7 messaging
ASOF      INIT      "- as of "
AUDIFLAG  FORM      1         * audit type
.
CALHH     DIM       2
CALMM     DIM       2
CALSS     DIM       2
CFILEPRE  DIM       3                                                *T0862225
COMFILNB  DIM       8
COMFILNC  DIM       8
CHNGLEGL  FORM      1         * change legal status flag
.                                 0 = no change
.                                 1 = changed
CHNGREVW  FORM      1         * change review status flag
.                                 0 = no change
.                                 1 = changed
.
CISMFLAG  FORM      1                       * for HL7 messaging
CURRDATE  DIM       8       * Current Date
CNTLKREF  FORM      2                       * Linked Referral counter *T0862225
CTR       FORM      1                       * Counter
CLOSEBTN  DIM       1
WORKDATE  DATE      8
DOCFILAF  FILE      ASCII, FIXED=128
DOCFLAG   FORM      1
DOCTCODE  DIM       8
DECISION  FORM      1
DEPTCODE  DIM       3  
DIADMSNO  DIM       8
DIM1A     DIM       1
DIM1B     DIM       1
DIM2A     DIM       2
DIM2B     DIM       2
DIM3A     DIM       3
DIM4A     DIM       4
DIM8A     DIM       8
DIM8B     DIM       8
DIM10A    DIM       10
DIM10B    DIM       10
DIM12A    DIM       12
DIM12B    DIM       12
DIM12C    DIM       12
DIM21     DIM       21
DIM30A    DIM       30
DIM30B    DIM       30
DIM32     DIM       32
DIM40     DIM       40
DIM60A    DIM       60
DIM60B    DIM       60
DIM60C    DIM       60
DIM60D    DIM       60
DIM60E    DIM       60
DIM60F    DIM       60
DIM80A1   DIM       80
DIM80A2   DIM       80
DIM80A3   DIM       80
DIM80B1   DIM       80
DIM80B2   DIM       80
DIM80B3   DIM       80
DIM100A   DIM       100
DIM30     DIM       30
.
DHBDESC   DIM       20
.
EXCLUDE   DIM       100
.
FORM8     FORM      8 
FORM3     FORM      3 
FORM6     FORM      6 
.
HDPEQUIV  DIM       2
HEAVIEW1  DIM       1       * CGI var for HEA view/validation    *T0852969
HIGHLIGHT DIM       1
HTMLLNK9  DIM       80
HOURTM    DIM       2

HOUR      DIM       2
MIN       DIM       2
SEC       DIM       2
SHOWSTAT  DIM       1
.
KEY11A    DIM       11
LASTITEM  FORM      3       * Last Item of FF Notes
LEGLDATE  DIM       8
LEGLTIME  DIM       5
LEGDESC   DIM       25
REVWDATE  DIM       8
REVWTIME  DIM       5
LNK2PRT   FORM      1
LSCHANGE  DIM       1
LSID      DIM       20
.
LEGLFLAG  FORM      1         * legal status date flag
.                                 0 = date not determined
.                                 1 = date determined
RVEWFLAG  FORM      1         * review status date flag
.                                 0 = date not determined
.                                 1 = date determined
REVEDATE  DIM       8         * last review status date
REFSTAT   DIM       10
LEGSDATE  DIM       8         * last legal status date
PMHDSTAT  DIM       12
MESSAGID  DIM       20
MHLRCODE  DIM       3
MHSTDATE  DIM       11
PRECDATE  DIM       11
PRECTIME  DIM       8
PTVIS028  DIM       10
FILTSTAT  DIM       1
FILTTYPE  DIM       1
.
REFCMNTS  DIM       100
MBSDESC   DIM       70
MINTIME   DIM       2
NMPNUMB   DIM       20
NOTENUMB  DIM       6       * note number
NEWLEGFL  FORM      1
NEXTPAGE  DIM       1       * Nextpage parameter CGI parameter
ORGNTYPE  DIM       1
ORIGDATE  DIM       12
PSAGECON  DIM       3
PSAGETYP  DIM       3
REVDESC   DIM       25
.
SUPERLEV  DIM       1
SECTCODE  DIM       3
REVSTATS  DIM       3
REVHRDHB  DIM       3
ACTIVFLG  FORM      1
SKEY16    DIM       16
SKEY30    DIM       30
SVDLSCOD  DIM       3
SAVKEY16  DIM       16
SAVKEY32  DIM       32
SKEY40    DIM       40
STRIKETG  DIM       10                      * Strike tag
STRENDTG  DIM       11                      * Strike end tag
SMHRVDAT  DIM       8
SMHRVTIM  DIM       5
SAVELS    DIM       3
SAVELTIM  DIM       5
SAVELDAT  DIM       8
SAVEADMN  DIM       8
SAVEDATE  DIM       8
SAVEDECI  FORM      1
SAVEREAS  DIM       3
SAVENDAT  DIM       8
SAVEREVW  DIM       3
SAVKEY10  DIM       10
SAVKEY25  DIM       25
SAVREFNO  DIM       8       * Save referral number                   *T0862225
SITECODE  DIM       6
SRCHTYPE  DIM       1
STARTKEY  DIM       10      * Starting Key
SAVKEY21  DIM       21
.
SENDZLSM  FORM      "0"     * send ZLS / A31 message?
.
TEMPDATE  DIM       8
TEMPTIME  DIM       5
UPDTTYPE  DIM       1       * Update Type
TRANDATE  DIM       8
TRANTIME  DIM       8
VALDTYPE  FORM      2 
VISTYPE   DIM       3
VISTTYPE  DIM       2
VALDCODE  DIM       70      * Validation Code
SREFCODE  DIM       3
UNIQNUMB  DIM       8
OPENDATE  DIM       8
OPENTIME  DIM       8
SECTIME   DIM       2
.
MEHAX001  DIM       1       * Type of Axis Code
MEHAX002  DIM       9       * Axis Code
MEHAX003  DIM       70      * Axis Description
MEHAX004  DIM       1       * Axis Code Status
.
MEHOR001  DIM       1       * Organisation Type
MEHOR002  DIM       6       * Organisation Code
MEHOR003  DIM       30      * Organisation Name
MEHOR004  DIM       35      * Address 1
MEHOR005  DIM       35      * Address 2
MEHOR006  DIM       35      * Address 3 (Suburb/Town)
MEHOR007  DIM       35      * Address 4
MEHOR008  DIM       8       * Postcode
MEHOR009  DIM       20      * Telephone number
MEHOR010  DIM       30      * Contact Person
MEHOR011  DIM       1       * Active/Inactive
MEHOR012  DIM       3       * Sector (Cat."EE")
MEHOR013  DIM       3       * Region (Cat."EF")
MEHOR014  DIM       3       * Unit (Business) Type
.
MHREADAT  DIM       8
.
RINVREDI  FORM      1       * Redirect to Raise Invoice
INVADMNO  DIM       8       * Invoice admission no.
TROTHFAC  DIM       1       * Transfer from other facility
.                           . 1 - Yes, 0 - No
ALLTYPE   INIT      "0"     * Search on all Axis types
AXI1TYPE  INIT      "1"     * Search on Axis I type
AXI2TYPE  INIT      "2"     * Search on Axis II type
AXI3TYPE  INIT      "3"     * Search on Axis III type
AXISI     INIT      "Axis I  - "
AXISII    INIT      "Axis II - "
AT        INIT      " at "
CATD1     INIT      "D1"
CATD2     INIT      "D2"
CATD3     INIT      "D3"
CATD4     INIT      "D4"
CATD5     INIT      "D5"
CATU6     INIT      "U6"
CATU7     INIT      "U7"
CATEE     INIT      "EE"
CATEF     INIT      "EF"
CATEI     INIT      "EI"
CATtm     INIT      "tm"
SENT      INIT      "Sent"
REJECT    INIT      "Rejected"
ACCEPT    INIT      "Accepted"
EROR      INIT      "Error"
WARN      INIT      "Warning"
EXOR      INIT      "External Organisations - "
EXAG      INIT      "External Agencies"
PUHO      INIT      "Public Hospitals"
SCHL      INIT      "Schools"
RESI      INIT      "Residential"
INOR      INIT      "Indigenous Organisations"
JUDE      INIT      "Justice Departments"
LAWS      INIT      "Lawers"
PRHO      INIT      "Private Hospitals"
EMPL      INIT      "Employer"
Z30       INIT      "zzzzzzzzzzzzzzzzzzzzzzzzzzzzzz"
ZERO2     INIT      "00"
.
.----------------------------------------------------------------------
PRGID     INIT      "MEHWEB01"
VERSION   INIT      "V12.00.01"
PRGNAM    INIT      "Mental Health Web Server"
.----------------------------------------------------------------------
.
          CALL      WEBINT00       * Initialise Fifo Etc.
          CALL      INIT0000       * Open Files
.
MAIN1000  CALL      WEBRED00       * Read Fifo WEBPID and USERID
.
          COMPARE   "999",REPORTNO * End Server Process on Report Option 999
          GOTO      MAIN9999 IF EQUAL
.
          BRANCH    REPORTNO,MAIN1100,MAIN1200,MAIN1300,MAIN1400,MAIN1500:
                             MAIN1600,MAIN1700,MAIN1800,MAIN1900,MAIN2000:
                             MAIN2100,MAIN2200,MAIN2300,MAIN2400,MAIN2500
.
          PACK      WEBTITLE,PRGID,SP1,VERSION,SP1,PRGNAM,SP70
          MOVE      "Invalid Option - MEHWEB01",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          GOTO      MAIN1000
.
MAIN1100  CALL      MEHDIA00        * Mental Health Diagnosis in Admission
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1200  CALL      SRHAXI00        * Axis code Search
          GOTO      MAIN1000
.
MAIN1300  CALL      MEHAXI00        * Axis code Maintenance
          BRANCH    EXIT,MAIN1000
          MOVE      "Update Complete",WEBTITLE
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1400  CALL      MEHDIS00        * Mental Health Discharge
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000      
.
MAIN1500  CALL      MEHDLV00        * Mental Health Leave Details
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1600  CALL      MEHLST00        * Mental Health Legal Status Review History
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1700  CALL      MEHREV00        * Mental Health Review 
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1800  CALL      PATEOR00        * External Organisation Maintenance
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1900  CALL      MEHREF00        * Legal status Referral
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2000  CALL      GETDAT00        * Get review & reminder date from a Section
          GOTO      MAIN1000
.
MAIN2100  CALL      GETREF00        * Get Referral details based on Source Ref.
          GOTO      MAIN1000
.
MAIN2200  CALL      CHKLEG00        * Check if Legal status exists on the day
          GOTO      MAIN1000
.
MAIN2300  CALL      GETEMP00        * Get MH Employer details
          GOTO      MAIN1000
.
MAIN2400  CALL      PMPLL000        * Patient level PRIMHD Transmission Lists
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2500  CALL      GETPOR00           * Get default police organisation
          GOTO      MAIN1000
.
MAIN9999  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      WEBERR00
          STOP
.------------------------------------------------------------
. Output Next Page Based on CGI Parameter nextpage
.------------------------------------------------------------
NXTPAG00  MOVE      ZERO,F1
          MOVE      NEXTPAGE,F1
          BRANCH    F1,NXTPAG10,NXTPAG20,NXTPAG30,NXTPAG40
.
          CALL      WINCLS00
          GOTO      NXTPAG99
.
NXTPAG10  CALL      RDIREC00
          GOTO      NXTPAG99
.
NXTPAG20  CALL      GOBACK00      * Go Back 1 Html page
          GOTO      NXTPAG99
.
NXTPAG30  CALL      DAH20000      * Go Back 2 html pages
          GOTO      NXTPAG99
.
NXTPAG40  CALL      PREDIR00      * Redirect Parent
          GOTO      NXTPAG99
.
NXTPAG99  RETURN
.------------------------------------------------------------------------------
.  Redirect Parent URL
.------------------------------------------------------------------------------
PREDIR00  CALL      OPENHTML
          BRANCH    EXIT,PREDIR90
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             " parent.location.href=#"",REDIRECT,"#";":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      PREDIR99
.
PREDIR90  DISPLAY   "*** Fifo Not Found ***"
.
PREDIR99  RETURN
.-------------------------------------------------------------------------------
.  Goes back 1 page
.-------------------------------------------------------------------------------
GOBACK00  CALL      OPENHTML
          BRANCH    EXIT,GOBACK99
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "    alert(#"",WEBTITLE,"#");":
                             "    self.close();":
                             "    opener.history.go(-1);":
                             "}":
                             "</script>"
          CALL      CLOSHTML
GOBACK99  RETURN
.------------------------------------------------------------
. Open Files and Initialize Variables
.------------------------------------------------------------
INIT0000  CALL      INTMAS00     * Open routine for PATMASTM 
          OPEN      ALLENCA1,"allencaf"
          OPEN      ALLLNKA1,"alllnkaf"
          OPEN      ALLGPAA2,"allgpaaf"
          OPEN      ALLREFA1,"allrefaf"
          OPEN      ALLPROA1,"allproaf"
          OPEN      ALLPROA2,"allproaf"
          OPEN      ALLRLNA1,"allrlnaf"
          OPEN      ALLSERA1,"allseraf"
          OPEN      MLTSECA1,"mltsecaf"
          OPEN      MLTSITA1,"mltsitaf"
          OPEN      PATONLV2,"patonlvf"
          OPEN      PATVADA1,"patvadaf"
          OPEN      PATVISA2,"patvisaf"
          OPEN      PATMI1A8,"patmi1af"
          OPEN      PATTRAN2,"pattranf"
          OPEN      PATWR1A1,"patwr1af"
          OPEN      PMSVX1A1,"pmsvx1af"
          OPEN      PMSTEMA1,"pmstemaf"
          OPEN      PMSHCPA1,"pmshcpaf"
          OPEN      PATRE1A1,"patre1af"
          OPEN      PATDGWA1,"patdgwaf"
          OPEN      VISMDTA1,"vismdtaf"
          OPEN      VISMTXA1,"vismtxaf"          
          OPEN      PATHSPA1,"pathspaf"
          OPEN      PATITEM1,"patitemn"
          OPEN      PATASFA1,"patasfaf"
          OPEN      PATDSCH1,"patdschf"
          OPEN      PATCODE1,"patcodes"
          OPEN      MEHDIAA1,"mehdiaaf"
          OPEN      MEHDIAA2,"mehdiaaf"
          OPEN      MEHDS1A1,"mehds1af"
          OPEN      MEHLEGA1,"mehlegaf"
          OPEN      MEHVI1A1,"mehvi1af"
          OPEN      MEHMDTA1,"mehmdtaf"
          OPEN      MEHMTXA1,"mehmtxaf"
          OPEN      PATCODE1,"patcodes"
          OPEN      PATCODE2,"patcodes"
          OPEN      MEHAKIA1,"mehakiaf"
          OPEN      MEHAKIA2,"mehakiaf"
          OPEN      MEHAXIA1,"mehaxiaf"
          OPEN      PATEORA1,"pateoraf"
          OPEN      PATEORA2,"pateoraf"
          OPEN      PATKEOA3,"patkeoaf"
          OPEN      MEHHLSA1,"mehhlsaf"
          OPEN      MEHDLSA1,"mehdlsaf"
          OPEN      MEHDLSA2,"mehdlsaf"
          OPEN      MEHDL1A1,"mehdl1af"
          OPEN      MEHLEGA1,"mehlegaf"
          OPEN      MEHLSMA1,"mehlsmaf"
          OPEN      MEHREVA1,"mehrevaf"
          OPEN      ALLCASA1,"allcasaf"
          OPEN      ALLCTMA2,"allctmaf"
          OPEN      MEHAUDHA,"mehaudha"
          OPEN      MEHAUDDA,"mehaudda"
          OPEN      MEHAUDDB,"mehaudda"
          OPEN      MEHCMNA1,"mehcmnaf"
          OPEN      PMSCCDA1,"pmsccdaf"
.
          DISPLAY   *P58:24,"controlf"
          OPEN      CONTROLF,"controlf"
          READ      CONTROLF,SIXTY9;*43,MHCNAUDA,*94,MHCNSINP,*102,MHCNPHED:
                                    *193,MHCNHDDS,*194,MHCNPRDS
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,EIGHTY;*250,PTCNHDPS
          READ      CONTROLF,HUND24;*160,PTCNSZLS
          READ      CONTROLF,HUND25;*238,PTCNNRTD
.
          MOVE      PTCNSZLS,SENDZLSM            * send ZLS / A31 message?
.
          MOVE      ZERO,F2
          MOVE      PTCNNRTD,F2
          IF        F2 = 0
            MOVE      "10",PTCNNRTD
          ENDIF
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
          ENDIF
.
          IF        PTCNHDPS = 1
            OPEN      MEHPLSA1,"mehplsaf"     * NZ PRIMHD Extract
            OPEN      MEHPLSA2,"mehplsaf"
            OPEN      MEHPLSA3,"mehplsaf"
            OPEN      MEHPRDA1,"mehprdaf"
            OPEN      MEHPRDA2,"mehprdaf"
            OPEN      MEHPRDA3,"mehprdaf"
..notused   OPEN      MEHPATA1,"mehpataf"
..notused   OPEN      MEHPCNA1,"mehpcnaf"
..notused   OPEN      MEHPCOA1,"mehpcoaf"
..notused   OPEN      MEHPOIA1,"mehpoiaf"
..notused   OPEN      MEHPTFA1,"mehptfaf"
          ENDIF
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,COMFILNB
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,COMFILNC
.
          BRANCH    MHCNAUDA,INIT9999       * no audits
          DISPLAY   *P58:24,"mehaudvi"
          OPEN      MEHAUVI1,"mehauvi1" 
.
          OPEN      OUTSITA1,"outsitaf"     * OP Site                *T0862225

INIT9999  RETURN
+
.******************************************************************************
.*                      Check Correct Files are Open for System               *
.******************************************************************************
OUTFIL00  MOVE      "out",CFILEPRE
          MOVE      SITECODE,KEY6
          CALL      RDSITA1
          BRANCH    OVRCD,OUTFIL90
          MATCH     OSTFILE,CFILEPRE          * Save Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE        * Save Current File Prefix
          ENDIF
.
          PACK      CFNAME,CFILEPRE,FILBOKA1  * Get the name of the BOKA1 file
          CLOSE     OUTBOKA6
          OPEN      OUTBOKA6,CFNAME           * Open the file
.
          MOVE      ZERO,EXIT
          GOTO      OUTFIL99
.
OUTFIL90  MOVE      "Outpatient Site Invalid",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
OUTFIL99  RETURN
.
.------------------------------------------------------------
. Clear Parameters
.------------------------------------------------------------
CLRPAR00  MOVE      ZERO,REPORTNO
          MOVE      SP70,TEMPLATE
          MOVE      SP70,NEXTPAGE
          PACK      REDIRECT,SP70,SP70,SP70,SP70
          MOVE      SP70,STARTKEY
          MOVE      SP70,UPDTTYPE
          MOVE      ZERO,STARTNUM
          MOVE      ZERO,NORECORD
          MOVE      SP70,TRANDATE
          MOVE      SP70,TRANTIME
          MOVE      SP70,UNIQNUMB
          MOVE      SP70,OPENDATE
          MOVE      SP70,OPENTIME
          MOVE      SP70,REVWDATE
          MOVE      SP70,VALDCODE
          MOVE      SP70,SREFCODE
          MOVE      TWO,DECISION
          MOVE      SP70,SECTCODE
          MOVE      SP70,REVSTATS
          MOVE      SP70,REVHRDHB
          MOVE      ZERO,ACTIVFLG
          MOVE      SP70,FRSTDATE
          MOVE      SP70,LASTDATE
          MOVE      SP70,VYEARMTH
          MOVE      SP70,VIEWTYPE
          MOVE      SP70,URNUMBER
          MOVE      SP70,ADMISSNO
          MOVE      SP70,DIADMSNO
          MOVE      SP70,FILTSTAT
          MOVE      SP70,FILTTYPE
          MOVE      ZERO,VALDTYPE
          MOVE      SP70,ORIGDATE
          MOVE      ONE,DOCFLAG
          MOVE      SP70,HEAVIEW1                                     *T0852969
          MOVE      SP70,TROTHFAC   
          MOVE      SP70,VISTTYPE  
.
          CALL      CLRMDI00           * Clear MH Diagnosis History Details
          CALL      CLRMDL00           * Clear MH Discharge to leave Details
          CALL      CLRMDS00           * Clear MH Discharge Details
          CALL      CLRMEH00           * Clear MH Visit Details
          CALL      CLRLEG00           * Clear MH Legal status details
          CALL      CLRREV00           * Clear MH Review details
          CALL      CMHHLS00           * Clear MH Referral Header
          CALL      CMHDLS00           * Clear MH Referral Details
.
          MOVE      SP70,KEYWORDS
          MOVE      SP70,SRCHTYPE
          MOVE      SP70,MEHAX001
          MOVE      SP70,MEHAX002
          MOVE      SP70,MEHAX003
          MOVE      SP70,MEHAX004
.
          MOVE      SP70,MEHOR001
          MOVE      SP70,MEHOR002
          MOVE      SP70,MEHOR003
          MOVE      SP70,MEHOR004
          MOVE      SP70,MEHOR005
          MOVE      SP70,MEHOR006
          MOVE      SP70,MEHOR007
          MOVE      SP70,MEHOR008
          MOVE      SP70,MEHOR009
          MOVE      SP70,MEHOR010
          MOVE      SP70,MEHOR011
          MOVE      SP70,MEHOR012
          MOVE      SP70,MEHOR013
          MOVE      SP70,MEHOR014
          MOVE      Z70,PTVIS028
.
          MOVE      SP70,REFCMNTS
          MOVE      SP70,NOTENUMB
          MOVE      SP70,SUPERLEV
          MOVE      ZERO,RINVREDI
          MOVE      SP70,INVADMNO
          MOVE      SP70,SHOWSTAT
          MOVE      SP70,CLOSEBTN
.
CLRPAR99  RETURN
.------------------------------------------------------------
. Set Parameters
.------------------------------------------------------------
SETPAR00  MATCH     "reportno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REPORTNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "template=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TEMPLATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updttype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDTTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "urnumber=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,URNUMBER
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "sectcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SECTCODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "revstats=",QRYNAME
          IF        @EQUAL
            PACK      QRYDATA,QRYDATA,SP70
            MOVE      QRYDATA,REVSTATS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "revhrdhb=",QRYNAME
          IF        @EQUAL
            PACK      QRYDATA,QRYDATA,SP70
            MOVE      QRYDATA,REVHRDHB
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "activflg=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ACTIVFLG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admissno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMISSNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "diadmsno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DIADMSNO
            GOTO      SETPAR99
          ENDIF
.  
          MATCH     "viewtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VIEWTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTKEY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "orgntype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ORGNTYPE
            GOTO      SETPAR99
          ENDIF
.  
          MATCH     "decision=",QRYNAME
          IF        @EQUAL
            MOVE      TWO,DECISION
            MATCH     SP70,QRYDATA
            GOTO      SETPAR99 IF EQUAL
            GOTO      SETPAR99 IF EOS
.
            MATCH     "Y",QRYDATA
            IF        @EQUAL
              MOVE      ONE,DECISION
            ELSE
              MOVE      ZERO,DECISION
            ENDIF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "legldate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LEGLDATE
            GOTO      SETPAR99
          ENDIF
.  
          MATCH     "legltime=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LEGLTIME
            GOTO      SETPAR99
          ENDIF
.  
          MATCH     "revwdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REVWDATE
            GOTO      SETPAR99
          ENDIF
.  
          MATCH     "revwtime=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REVWTIME
            GOTO      SETPAR99
          ENDIF
.  
          MATCH     "trandate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRANDATE
            GOTO      SETPAR99
          ENDIF
.  
          MATCH     "trantime=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TRANTIME
            GOTO      SETPAR99
          ENDIF
.  
          MATCH     "uniqnumb=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UNIQNUMB
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "opendate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPENDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "opentime=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OPENTIME
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nextpage=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTPAGE
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "redirect=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REDIRECT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mehdi",QRYNAME
          IF        @EQUAL
            CALL      SETMDI00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mehdl",QRYNAME
          IF        @EQUAL
            CALL      SETMDL00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mehds",QRYNAME
          IF        @EQUAL
            CALL      SETMDS00
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "mehvs",QRYNAME
          IF        @EQUAL
            CALL      SETMHF00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mehlg",QRYNAME
          IF        @EQUAL
            CALL      SETMHL00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mehrv",QRYNAME
          IF        @EQUAL
            CALL      SETMHR00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mhhls",QRYNAME
          IF        @EQUAL
            CALL      SMHHLS00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mhdls",QRYNAME
          IF        @EQUAL
            CALL      SMHDLS00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "keywords=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,KEYWORDS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "norecord=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NORECORD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startnum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTNUM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mehax",QRYNAME
          IF        @EQUAL
            CALL      STAXI000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mehor",QRYNAME
          IF        @EQUAL
            CALL      STEOR000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SRCHTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDCODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "closebtn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CLOSEBTN
            GOTO      SETPAR99
          ENDIF          
.
          MATCH     "srefcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SREFCODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "refcomnt=",QRYNAME
          IF        @EQUAL
            CALL      GETCMN00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "doconame=",QRYNAME
          IF        @EQUAL
            CALL      GETDCM00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "notenumb=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NOTENUMB
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "frstdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FRSTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "lastdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LASTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "vyearmth=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VYEARMTH
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtstat=",QRYNAME
          IF        @EQUAL
            PACK      FILTSTAT,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filttype=",QRYNAME
          IF        @EQUAL
            PACK      FILTTYPE,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptvis028=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PTVIS028
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "superlev=",QRYNAME
          IF        @EQUAL
            PACK      SUPERLEV,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "origdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ORIGDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "rinvredi=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RINVREDI
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "invadmno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,INVADMNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "heaview1=",QRYNAME       * HEA View/Valid flag *T0852969
          IF        @EQUAL
            MOVE      QRYDATA,HEAVIEW1
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trothfac=",QRYNAME       * Transfer from other facility
          IF        @EQUAL
            MOVE      QRYDATA,TROTHFAC
            GOTO      SETPAR99
          ENDIF
.
SETPAR99  RETURN
.-------------------------------------------------------------------------------
.   Set Parameters for Option 3 - Axis Code               
.-------------------------------------------------------------------------------
STAXI000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,STAXI001,STAXI002,STAXI003,STAXI004
          GOTO      STAXI999
.
STAXI001  SQUEEZE   QRYDATA
          MOVE      QRYDATA,MEHAX001
          PACK      MEHAX001,MEHAX001,SP70
          GOTO      STAXI999
.
STAXI002  MOVE      QRYDATA,MEHAX002
          GOTO      STAXI999
.
STAXI003  MOVE      QRYDATA,MEHAX003
          GOTO      STAXI999
.
STAXI004  MOVE      QRYDATA,MEHAX004
          GOTO      STAXI999
.
STAXI999  RETURN
.
.------------------------------------------------------------
. Get Referral Comments
.------------------------------------------------------------
GETCMN00  PREP      COMFILAF,COMFILNB
          MOVE      ONE,F3
          WRITE     COMFILAF,SEQ;QRYDATA
.
GETCMN10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETCMN90 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETCMN80 IF NOT EQUAL
          ADD       ONE,F3
          WRITE     COMFILAF,SEQ;QRYDATA
          GOTO      GETCMN10
.
GETCMN80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETCMN90  MOVE      F3,LASTITEM
          OPEN      COMFILAF,COMFILNB
GETCMN99  RETURN
+
.------------------------------------------------------------
. Get Document name
.------------------------------------------------------------
GETDCM00  PREP      DOCFILAF,COMFILNC
          MOVE      ZERO,DOCFLAG
          MOVE      ONE,F3
          WRITE     DOCFILAF,SEQ;QRYDATA
.
GETDCM10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETDCM90 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETDCM80 IF NOT EQUAL
          ADD       ONE,F3
          WRITE     DOCFILAF,SEQ;QRYDATA
          GOTO      GETDCM10
.
GETDCM80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETDCM90  MOVE      F3,LASTITEM
          OPEN      DOCFILAF,COMFILNC
GETDCM99  RETURN
+
.-------------------------------------------------------------------------------
.   Set Parameters for Option 8 - External Organisation Code               
.-------------------------------------------------------------------------------
STEOR000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,STEOR001,STEOR002,STEOR003,STEOR004,STEOR005:
                       STEOR006,STEOR007,STEOR008,STEOR009,STEOR010:
                       STEOR011,STEOR012,STEOR013,STEOR014
          GOTO      STEOR999
.
STEOR001  MOVE      QRYDATA,MEHOR001
          GOTO      STEOR999
.
STEOR002  MOVE      QRYDATA,MEHOR002
          PACK      MEHOR002,MEHOR002,SP70
          GOTO      STEOR999
.
STEOR003  MOVE      QRYDATA,MEHOR003
          GOTO      STEOR999
.
STEOR004  MOVE      QRYDATA,MEHOR004
          GOTO      STEOR999
.
STEOR005  MOVE      QRYDATA,MEHOR005
          GOTO      STEOR999
.
STEOR006  MOVE      QRYDATA,MEHOR006
          GOTO      STEOR999
.
STEOR007  MOVE      QRYDATA,MEHOR007
          GOTO      STEOR999
.
STEOR008  MOVE      QRYDATA,MEHOR008
          GOTO      STEOR999
.
STEOR009  MOVE      QRYDATA,MEHOR009
          GOTO      STEOR999
.
STEOR010  MOVE      QRYDATA,MEHOR010
          GOTO      STEOR999
.
STEOR011  MOVE      QRYDATA,MEHOR011
          GOTO      STEOR999
.
STEOR012  MOVE      QRYDATA,MEHOR012
          GOTO      STEOR999
.
STEOR013  MOVE      QRYDATA,MEHOR013
          GOTO      STEOR999
.
STEOR014  MOVE      QRYDATA,MEHOR014
          GOTO      STEOR999
.
.
STEOR999  RETURN
+
.------------------------------------------------------------
. Mental Health Admission
.------------------------------------------------------------
MEHDIA00  MATCH     SP70,UPDTTYPE   * displaying all diag records, no need for visit
          IF        @EQUAL
            MATCH     "005",TEMPLATE
            IF        !@EQUAL
              PACK      KEY8,ADMISSNO,SP70
              CALL      RDMHVIS1
              BRANCH    OVRCD,MEHDIA98
            ENDIF
          ENDIF
.
          CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD  
          REP       " 0",CURRDATE
.
          MATCH     SP70,UPDTTYPE
          GOTO      MEHDIA80 IF EQUAL
.
          MATCH     "A",UPDTTYPE            * Add from mehweb0101002
          GOTO      MEHDIA10 IF EQUAL
.
          MATCH     "U",UPDTTYPE            * Update from mehweb0101004
          GOTO      MEHDIA40 IF EQUAL
.
          MATCH     "D",UPDTTYPE            * Delete from mehweb0101004
          GOTO      MEHDIA70 IF EQUAL
.
          GOTO      MEHDIA90
.
.         ************* Add MH Diagnosis ************
.
MEHDIA10  PACK      KEY16,ADMISSNO,Z70
          CALL      RSMHDIA1
          CALL      RPMHDIA1
          BRANCH    OVRCD,MEHDIA20
.
          MATCH     ADMISSNO,DMHDIADM
          GOTO      MEHDIA20 IF NOT EQUAL
.
.                   ------------------------- start                   *C-228152
          CALL      MVDIA000                * move cgi to file variables
          COMPARE   ZERO,MHDICHNG           * any changes to data ?
          GOTO      MEHDIA99 IF EQUAL       * if no changes, don't update
.
          MATCH     CURRDATE,MHDIDATE
          GOTO      MEHDIA30 IF NOT EQUAL
.
.                                           * Same date - update record only
          MOVE      "0",MHDIMOHR            * Unsent
          PACK      MHDIUDAT,CCC,CYY,CMM,CDD
          REP       " 0",MHDIUDAT
          CLOCK     TIME,MHDIUTIM
          PACK      MHDIURNO,URNUMBER,SP70                                     
          MOVE      USERID,MHDIUUID                             
          CALL      UPMHDIA1
.
          IF        MHVISTAT = 7 | MHVISTAT = 8
            MOVE      EIGHT,HL7TRGID
            CALL      BRDI1300                * broadcast Update Ref. (REF^I13)
          ELSE
            MOVE      NINE,HL7TRGID
            CALL      BRDA0800                * broadcast Update Vis. (ADT^A08)
          ENDIF
.
          GOTO      MEHDIA99
.
.                                           * no previous Diag., create new recd
MEHDIA20  CALL      CLMEHDIA
          CALL      MVDIA000                * move cgi to file variables
          COMPARE   ZERO,MHDICHNG           * any changes to data ?
          GOTO      MEHDIA99 IF EQUAL       * if no changes, don't write
.
.                                           * write new record for Current date
MEHDIA30  PACK      KEY16,ADMISSNO,CURRDATE
          CALL      RAMHDIA1
          COMPARE   ZERO,OVRCD
          GOTO      MEHDIA99 IF EQUAL
.
          MOVE      ADMISSNO,MHDIADMN
          MOVE      CURRDATE,MHDIDATE
          MOVE      "0",MHDIMOHR            * Unsent
          PACK      MHDICDAT,CCC,CYY,CMM,CDD
          REP       " 0",MHDICDAT
          CLOCK     TIME,MHDICTIM
          PACK      MHDIURNO,URNUMBER,SP70
          MOVE      USERID,MHDICUID
          CALL      WRMHDIA1
.                                                               * end *C-228152
          IF        MHVISTAT = 7 | MHVISTAT = 8
            MOVE      TEN,HL7TRGID
            CALL      BRDI1300                * broadcast Update Ref. (REF^I13)
          ELSE
            MOVE      TEN1,HL7TRGID
            CALL      BRDA0800                * broadcast Update Vis. (ADT^A08)
          ENDIF
.
          GOTO      MEHDIA99
.
.         *********** Update MH Diagnosis ***********
.
MEHDIA40  PACK      KEY20,ORIGDATE,SP20
          UNPACK    KEY20,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                *Set CMON from MTHNAM3
          PACK      KEY8,CCENT,CYEAR,CMON,CDAY

          MATCH     KEY8,MEHDI002
          GOTO      MEHDIA50 IF EQUAL
.
          PACK      KEY16,ADMISSNO,MEHDI002
          CALL      RDMHDIA1
          BRANCH    OVRCD,MEHDIA50
.
          GOTO      MEHDIA96
.
MEHDIA50  PACK      KEY16,ADMISSNO,KEY8
          CALL      RDMHDIA1
          BRANCH    OVRCD,MEHDIA95
.
          CALL      MVDIA000                * move cgi to file variables
.         COMPARE   ZERO,MHDICHNG           * any changes to data ?
.         GOTO      MEHDIA99 IF EQUAL       * if no changes, don't update
.
          MOVE      "0",MHDIMOHR            * Unsent
          PACK      MHDIUDAT,CCC,CYY,CMM,CDD
          REP       " 0",MHDIUDAT
          CLOCK     TIME,MHDIUTIM
          PACK      MHDIURNO,URNUMBER,SP70
          MOVE      USERID,MHDIUUID
          CALL      UPMHDIA1
.
          IF        MHVISTAT = 7 | MHVISTAT = 8
            MOVE      TEN2,HL7TRGID
            CALL      BRDI1300                * broadcast Update Ref. (REF^I13)
          ELSE
            MOVE      TEN3,HL7TRGID
            CALL      BRDA0800                * broadcast Update Vis. (ADT^A08)
          ENDIF
.
          GOTO      MEHDIA99
.
.         *********** Delete MH Diagnosis ***********
.
MEHDIA70  PACK      KEY16,ADMISSNO,MEHDI002,SP70
          CALL      RDMHDIA1
          BRANCH    OVRCD,MEHDIA95
.
          CALL      DEMHDIA1
.
          IF        MHVISTAT = 7 | MHVISTAT = 8
            MOVE      TEN4,HL7TRGID
            CALL      BRDI1300                * broadcast Update Ref. (REF^I13)
          ELSE
            MOVE      TEN5,HL7TRGID
            CALL      BRDA0800                * broadcast Update Vis. (ADT^A08)
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      MEHDIA99
.
.         *********** Display MH Diagnosis **********
.
MEHDIA80  MOVE      URNUMBER,KEY8   * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,MEHDIA91
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MATCH     "005",TEMPLATE    * all list - no mh visit required
          GOTO      MEHDIA87 IF EQUAL
.
          MOVE      ADMISSNO,KEY8   * Read Visit File
....      CALL      RDVISA1                                           *D-228152
          CALL      RDMHVIS1                                          *I-228152
          BRANCH    OVRCD,MEHDIA92
.
          IF        MHVISTAT = 7 | MHVISTAT = 8 
            PACK      KEY8,ADMISSNO,SP70    * read Referral file
            CALL      RDALREF1
            BRANCH    OVRCD,MEHDIA94
            PACK      DAADMNO,ADMISSNO,SP70
            MOVE      ADMISSNO,AADMNO
          ELSE
            MOVE      ADMISSNO,KEY8         * Read Admission File
            CALL      RDMISS1
            BRANCH    OVRCD,MEHDIA93
          ENDIF
.
          MATCH     MEHDI002,Z70
          GOTO      MEHDIA85 IF EQUAL
.
          PACK      KEY16,ADMISSNO,MEHDI002   * Read MH Diagnosis Record
          CALL      RDMHDIA1
          IF        OVRCD=1
            CALL      CLMEHDIA
          ENDIF
.
          MATCH     SP70,DIADMSNO
          IF        !@EQUAL
            PACK      KEY16,DIADMSNO,MEHDI002 * Read MH Diagnosis Record
            CALL      RDMHDIA1
            IF        OVRCD=1
              CALL      CLMEHDIA
            ENDIF
          ENDIF
.
          GOTO      MEHDIA87
.
MEHDIA85  PACK      KEY16,ADMISSNO,Z70        * Read MH Diagnosis File
          CALL      RSMHDIA1
          CALL      RPMHDIA1
          MATCH     ADMISSNO,DMHDIADM
          IF        !@EQUAL
            CALL      CLMEHDIA
          ENDIF
.
          MATCH     "1",CLOSEBTN
          IF        @EQUAL
            CALL      CLMEHDIA
          ENDIF        
.
MEHDIA87  CLEAR     WEBTITLE
          MOVE      "Mental Health",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,MEHDIA99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      MEHDIA99
.
MEHDIA90  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEHDIA99
.
MEHDIA91  MOVE      "Can't find patient Master Details. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEHDIA99
.
MEHDIA92  MOVE      "Can't find patient Visit Details.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEHDIA99
.
MEHDIA93  MOVE      "Can't find patient Admission Details.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEHDIA99
.
MEHDIA94  MOVE      "Can't find allied health details.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEHDIA99
.
MEHDIA95  MOVE      "MH Diagnosis record does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEHDIA99
.
MEHDIA96  MOVE      "MH Diagnosis record already exists for that date",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEHDIA99
.
MEHDIA98  MOVE      "Invalid mental health admission.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEHDIA99
.
MEHDIA99  RETURN
+
.-----------------------------------------------------------
.         Broadcast I13 for mental health diagnoses
.-----------------------------------------------------------
BRDI1300  PACK      KEY8,ADMISSNO,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,BRDI1399
.
          PACK      KEY8,ALREURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,BRDI1399
.
          PACK      KEY8,ALREURNO,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,BRDI1399
.
          CALL      CLALLENC                 * don't need encounter fields
.
          CALL      PMIGTNID                 * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      SP8,HL7INCLD
          CALL      DGCLII13                 * broadcast Update Ref. (REF^I13)
.
BRDI1399  RETURN
+
.-----------------------------------------------------------
.         Broadcast A08 for mental health diagnoses
.-----------------------------------------------------------
BRDA0800  PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,BRDA0899
.
          PACK      KEY8,AURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,BRDA0899
.
          PACK      KEY8,AURNO,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,BRDA0899
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDVISA1
          BRANCH    OVRCD,BRDA0899
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDDSCH1
          IF        OVRCD=1
            CALL      CLPATDSC
          ENDIF
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDRESP1
          IF        OVRCD=1
            CALL      CLPATRE1
          ENDIF
.
          PACK      KEY30,AADMNO,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,BRDA0899
.
          MATCH     TADMN,AADMNO
          GOTO      BRDA0899 IF NOT EQUAL
.
          CALL      PMIGTNID                 * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      SP8,HL7INCLD
          PROC      DGCLICAC                 * broadcast Update Vis. (ADT^A08)
.
BRDA0899  RETURN
+
.------------------------------------------------------------
. Mental Health Axis Codes: Display,Add,Update,Delete
.------------------------------------------------------------
MEHAXI00  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      MEHAXI40 IF EQUAL
.
          MATCH     "A",UPDTTYPE    * Add formaction
          GOTO      MEHAXI10 IF EQUAL
.
          MATCH     "U",UPDTTYPE    * Update formaction
          GOTO      MEHAXI20 IF EQUAL
.
          MATCH     "D",UPDTTYPE    * Delete formaction
          GOTO      MEHAXI30 IF EQUAL
.
          GOTO      MEHAXI93
.
.         ************ ADD FORMACTION ***********
.
MEHAXI10  CALL      CHKAXI00      * Checks mandatory fields
          BRANCH    EXIT,MEHAXI99
.
          PACK      KEY10,MEHAX001,MEHAX002,SP70
          CALL      RDMHAXI1
          COMPARE   ZERO,OVRCD
          GOTO      MEHAXI92 IF EQUAL
.
          CALL      AXISAV00      * Moves input variables to file variables
          PACK      KEY10,MEHAX001,MEHAX002,SP70
          CALL      WRMHAXI1       * Writes away the data
          PROC      MEHAKIUP
.
          MOVE      ZERO,EXIT
          GOTO      MEHAXI99
.
.         ************ UPDATE FORMACTION **********
.
MEHAXI20  PACK      KEY10,MEHAX001,MEHAX002,SP70
          CALL      RDMHAXI1
          BRANCH    OVRCD,MEHAXI91
          CALL      CHKAXI00      * Checks mandatory fields
          BRANCH    EXIT,MEHAXI99
.
          CALL      AXISAV00      * Moves input variables to file variables
          PACK      KEY10,MEHAX001,MEHAX002,SP70
          CALL      UPMHAXI1      * Writes away the data
          PROC      MEHAKIUP
.
          MOVE      ZERO,EXIT
          GOTO      MEHAXI99
.
.         ************ DELETE FORMACTION **********
.
MEHAXI30  PACK      KEY10,MEHAX001,MEHAX002,SP70
          CALL      RDMHAXI1
          BRANCH    OVRCD,MEHAXI91
          CALL      DEMHAXI1
          PROC      MEHAKIUP
.
          MOVE      ZERO,EXIT
          GOTO      MEHAXI99
.
.         ************ DISPLAY FORMACTION **********
.
MEHAXI40  PACK      KEY10,MEHAX001,MEHAX002,SP70    * Axis Codes File
          CALL      RDMHAXI1
          IF        OVRCD=1
            CALL      CLRAXI00    * Clear all the file variables
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Mental Health - Axis Code Maintenance",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,MEHAXI99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      MEHAXI99
.
MEHAXI91  MOVE      "Axis record does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEHAXI99
.
MEHAXI92  MOVE      "Axis record exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEHAXI99
.
MEHAXI93  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEHAXI99
.
MEHAXI99  RETURN
.-----------------------------------------------------------
. Initialize's file data
.-----------------------------------------------------------
CLRAXI00  MOVE      SP70,MHAXCODE   * Axis Code
          MOVE      SP70,MHAXTYPE   * Type of Axis Code
          MOVE      SP70,MHAXDESC   * Axis Desription
          MOVE      SP70,MHAXSTAT   * Status
          MOVE      SP70,MHAXSPAR   * Spare
.
CLRAXI99  RETURN
.------------------------------------------------------------
. * Checks Axis mandatory fields
.------------------------------------------------------------
CHKAXI00  RESET     MEHAX001
          MATCH     SP70,MEHAX001
          GOTO      CHKAXI90 IF EQUAL
.
          RESET     MEHAX002
          MATCH     SP70,MEHAX002
          GOTO      CHKAXI91 IF EQUAL
.
          RESET     MEHAX003
          MATCH     SP70,MEHAX003
          GOTO      CHKAXI92 IF EQUAL
.
          GOTO      CHKAXI98
.
CHKAXI90  MOVE      "Axis type cannot be blank!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKAXI99
.
CHKAXI91  MOVE      "Axis code cannot be blank!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKAXI99
.
CHKAXI92  MOVE      "Axis Description is mandatory!",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      CHKAXI99
.
CHKAXI98  MOVE      ZERO,EXIT
CHKAXI99  RETURN
.-----------------------------------------------------------
. Save routine - move cgi parameters into file variables
.-----------------------------------------------------------
AXISAV00  MOVE      MEHAX001,MHAXTYPE   * Type of Axis Code
          MOVE      MEHAX002,MHAXCODE   * Axis Code
          MOVE      MEHAX003,MHAXDESC   * Axis Description
          MOVE      MEHAX004,MHAXSTAT   * Axis Code Status 
.
          MOVE      SP70,MHAXSPAR   * Spare
.
AXISAV99  RETURN
.
.------------------------------------------------------------
. Mental Health External Organisation: Display,Add,Update,Delete
.------------------------------------------------------------
PATEOR00  RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      PATEOR40 IF EQUAL
.
          MATCH     "A",UPDTTYPE    * Add formaction
          GOTO      PATEOR10 IF EQUAL
.
          MATCH     "U",UPDTTYPE    * Update formaction
          GOTO      PATEOR20 IF EQUAL
.
          MATCH     "D",UPDTTYPE    * Delete formaction
          GOTO      PATEOR30 IF EQUAL
.
          GOTO      PATEOR93
.
.         ************ ADD FORMACTION ***********
.
PATEOR10  PACK      KEY7,MEHOR001,MEHOR002,SP70
          CALL      RDPTEOR1
          COMPARE   ZERO,OVRCD
          GOTO      PATEOR92 IF EQUAL
.
          CALL      EORSAV00          * Moves input variables to file variables
          PACK      KEY7,MEHOR001,MEHOR002,SP70
          CALL      WRPTEOR1                * Writes away the data
.
          PROC      PATKEOUP                * write Keyword file
.
          MOVE      ZERO,EXIT
          GOTO      PATEOR99
.
.         ************ UPDATE FORMACTION **********
.
PATEOR20  PACK      KEY7,ORGNTYPE,MEHOR002,SP70
          CALL      RDPTEOR1
          BRANCH    OVRCD,PATEOR91
.
          CALL      EORSAV00      * Moves input variables to file variables
          PACK      KEY7,MEHOR001,MEHOR002,SP70
          CALL      UPPTEOR1      * Writes away the data
.
          PROC      PATKEOUP                * write Keyword file
.
          MOVE      ZERO,EXIT
          GOTO      PATEOR99
.
.         ************ DELETE FORMACTION **********
.
PATEOR30  PACK      KEY7,MEHOR001,MEHOR002,SP70
          CALL      RDPTEOR1
          BRANCH    OVRCD,PATEOR91
          CALL      DEPTEOR1
          MOVE      ZERO,EXIT
          GOTO      PATEOR99
.
.         ************ DISPLAY FORMACTION **********
.
PATEOR40  PACK      KEY7,MEHOR001,MEHOR002,SP70
          CALL      RDPTEOR1
          IF        OVRCD=1
            CALL      CLREOR00    * Clear all the file variables
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Mental Health - External Organisation Maintenance",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,PATEOR99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      PATEOR99
.
PATEOR91  MOVE      "Organisation record does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PATEOR99
.
PATEOR92  MOVE      "Organisation record exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PATEOR99
.
PATEOR93  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PATEOR99
.
PATEOR99  RETURN
.-----------------------------------------------------------
. Initialize's file data
.-----------------------------------------------------------
CLREOR00  MOVE      SP70,PTERTYPE   * Organisation Type 
          MOVE      SP70,PTERCODE   * Organisation Code
          MOVE      SP70,PTERNAME   * Organisation Name
          MOVE      SP70,PTERADD1   * Organisation Address
          MOVE      SP70,PTERADD2   * Organisation Address
          MOVE      SP70,PTERADD3   * Organisation Address
          MOVE      SP70,PTERADD4   * Organisation Address
          MOVE      SP70,PTERPOST   * Organisation Postcode
          MOVE      SP70,PTERTELP   * Organisation Telephone
          MOVE      SP70,PTERCONT   * Organisation Contact
          MOVE      SP70,PTERSTAT   * Organisation Active
          MOVE      SP70,PTERSECT   * Organisation Sector
          MOVE      SP70,PTERREGN   * Organisation District/Region
          MOVE      SP70,PTERUTYP   * Organisation Unit (Business) Type
          MOVE      SP70,PTERSPAR   * Spare
CLREOR99  RETURN
.-----------------------------------------------------------
. Save routine - move cgi parameters into file variables
.-----------------------------------------------------------
EORSAV00  MOVE      MEHOR001,PTERTYPE   * Type
          MOVE      MEHOR002,PTERCODE   * Organisation Code
          MOVE      MEHOR003,PTERNAME   * Name
          MOVE      MEHOR004,PTERADD1   * Address 
          MOVE      MEHOR005,PTERADD2   * Address
          MOVE      MEHOR006,PTERADD3   * Address
          MOVE      MEHOR007,PTERADD4   * Address
          MOVE      MEHOR008,PTERPOST   * Postcode
          MOVE      MEHOR009,PTERTELP   * Telephone
          MOVE      MEHOR010,PTERCONT   * Contact
          MOVE      MEHOR012,PTERSECT   * Sector 
          MOVE      MEHOR013,PTERREGN   * Region 
          MOVE      MEHOR014,PTERUTYP   * Unit (Business) Type
          MOVE      ONE,PTERSTAT     * Default to not active
          MATCH     "2",MEHOR011
          IF        @EQUAL
            MOVE      ZERO,PTERSTAT  * active
          ENDIF
.
.
EORSAV99  RETURN
.
.------------------------------------------------------------
.         Mental Health referral
.------------------------------------------------------------
MEHREF00  RESET     UPDTTYPE
          MATCH     SP70,UPDTTYPE
          GOTO      MEHREF80 IF EQUAL
.
          MATCH     "A",UPDTTYPE            * Add Referral
          GOTO      MEHREF10 IF EQUAL
.
          MATCH     "U",UPDTTYPE            * Update Referral
          GOTO      MEHREF20 IF EQUAL
.
          MATCH     "I",UPDTTYPE            * Add Referral details
          GOTO      MEHREF30 IF EQUAL
.
          MATCH     "C",UPDTTYPE            * Update Referral details
          GOTO      MEHREF40 IF EQUAL
.
          MATCH     "S",UPDTTYPE            * Update Referral details
          GOTO      MEHREF45 IF EQUAL
.  
          MATCH     "D",UPDTTYPE            * Delete Referral details
          GOTO      MEHREF50 IF EQUAL
.
          MATCH     "N",UPDTTYPE            * Add Referral comments
          GOTO      MEHREF60 IF EQUAL
.
          MATCH     "E",UPDTTYPE            * Delete Referral comments
          GOTO      MEHREF70 IF EQUAL
.
          GOTO      MEHREF95
.
MEHREF10  CALL      ADDREF00                * Add Mental health referral
          GOTO      MEHREF99
.
MEHREF20  CALL      UPDREF00                * Update Mental health referral
          GOTO      MEHREF99
.
MEHREF30  CALL      ADDDRF00                * Add referral details
          GOTO      MEHREF99
.
MEHREF40  CALL      UPDDRF00                * Update referral details
          GOTO      MEHREF99
.
MEHREF45  CALL      UPDDRS00                * Update referral supervisor
          GOTO      MEHREF99
.
MEHREF50  CALL      DELDRF00                * Delete referral details
          GOTO      MEHREF99
.
MEHREF60  CALL      ADDCMN00                * Add Referral Comments
          MOVE      ZERO,EXIT
          GOTO      MEHREF99
.
MEHREF70  CALL      DELCMN00                * Delete Referral Comments
          MOVE      ZERO,EXIT
          GOTO      MEHREF99
.
MEHREF80  PACK      KEY8,URNUMBER,SP70      * Patient Referral Details
          CALL      RDMAST1
          IF        OVRCD=1
            CALL      CLPATMAS
          ENDIF
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          CALL      CLALLREF
          MATCH     SP70,ADMISSNO
          IF        !@EQUAL
            MOVE      ADMISSNO,KEY8   * Read Visit File
            CALL      RDVISA1
            IF        OVRCD<>1
              MATCH     "10",PTVITYPE
              IF        @EQUAL
                CALL      RDALREF1
                IF        OVRCD=1
                  CALL      CLALLREF
                ENDIF
              ENDIF
.             MATCH     " 3",PTVITYPE
.             IF        @EQUAL
.               CALL      RDMISS1
.               IF        OVRCD=1
.                 CALL      CLPATMIS
.               ENDIF
.             ENDIF
            ENDIF
            CALL      RDPMVX11
            IF        OVRCD=1
              CALL      CLPMSVX1      * Clear Visit Extension fields
            ENDIF
            CALL      RDMHVIS1
            IF        OVRCD=1
              CALL      CLMEHVIS      * clear mental health details
            ENDIF
          ENDIF
.
          MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
          PACK      TEMPLATE,KEY3,SP70
.
          PACK      KEY16,URNUMBER,UNIQNUMB,SP70
          CALL      RDMHHLS1
          IF        OVRCD=1
            CALL      CLRHLS00              * clear fields
            GOTO      MEHREF82
          ENDIF
.
          MATCH     "001",TEMPLATE
          GOTO      MEHREF81 IF EQUAL
.
          MATCH     "003",TEMPLATE
          GOTO      MEHREF82 IF NOT EQUAL
.
MEHREF81  CALL      IBACLOCK
          PACK      MHHLMDAT,CCC,CYY,CMM,CDD   * Date
          REP       " 0",MHHLMDAT
          MOVE      "V",MHHLRTYP               * View record type
          MOVE      CTIMEIS,MHHLMTIM
          MOVE      USERID,MHHLMUID            * Operator
          PACK      KEY24,MHHLURNO,MHHLMDAT,MHHLMTIM
          CALL      AWMHHL                     * Write Audit Header File
.
MEHREF82  PACK      KEY32,URNUMBER,UNIQNUMB,OPENDATE,OPENTIME,SP70
          CALL      RDMHDLS1
          IF        OVRCD=1
            CALL      CLRDLS00              * clear fields
          ELSE
            MATCH     "006",TEMPLATE
            GOTO      MEHREF84 IF NOT EQUAL
.
            CALL      IBACLOCK
            PACK      MHDLMDAT,CCC,CYY,CMM,CDD   * Date
            REP       " 0",MHDLMDAT
            MOVE      "V",MHDLRTYP               * View record type
            MOVE      CTIMEIS,MHDLMTIM
            MOVE      USERID,MHDLMUID            * Operator
            PACK      KEY32,MHDLURNO,MHDLUNIQ,MHDLMDAT,MHDLMTIM
            CALL      AWMHDL                     * Write Audit Detail File
          ENDIF
.
MEHREF84  MATCH     SP70,NOTENUMB
          GOTO      MEHREF88 IF EQUAL
.
          MOVE      "001",MHMDTYPE
          PACK      KEY17,URNUMBER,MHMDTYPE,NOTENUMB
          CALL      RDMHMDT1
          IF        OVRCD=1
            CALL      CLRCMN00
          ENDIF
.
MEHREF88  
          MATCH     "012",TEMPLATE     * is this review reminder list
          IF        @EQUAL
            CALL      CURPER00
            CALL      CALCDT00   * Calculate Next and Last Period Dates
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Legal Status Referrals",WEBTITLE
          RESET     WEBTITLE 
.         
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,MEHREF99
          CALL      WEBBOD00   * Process Web Body (calls PROFLD00)
          CALL      WEBEND00   * Process End of HTML File
.                       
          MOVE      ONE,EXIT
          GOTO      MEHREF99
.
MEHREF95  MOVE      "Invalid Update Type.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEHREF99
.
MEHREF99  CLOSE     COMFILAF,DELETE
          CLOSE     DOCFILAF,DELETE
          RETURN
+
*******************************************************************************
.         MH Document Name 
.*******************************************************************************
.         copy the comments back to file - first delete existing comments
.
UPDCM000  BRANCH    DOCFLAG,UPDCM999
          MOVE      "001",KEY3
          PACK      KEY32,URNUMBER,UNIQNUMB,OPENDATE,OPENTIME,SP70
          PACK      KEY38,KEY32,KEY3,SP70
          CALL      RSMHCMN1
UPDCM400  CALL      RKMHCMN1
          BRANCH    OVRCD,UPDCM500          * end of file
.
          PACK      DIM32,MHCMURNO,MHCMUNIQ,MHCMSDAT,MHCMSTIM,SP70
          MATCH     DIM32,KEY32
          GOTO      UPDCM500 IF NOT EQUAL
.
          MATCH     MHCMCTYP,KEY3
          GOTO      UPDCM500 IF NOT EQUAL
.
          PACK      KEY38,KEY32,KEY3,MHCMLINE,SP70
          CALL      DEMHCMN1
          GOTO      UPDCM400
.
.         now write the new document name back
.
UPDCM500  UNPACK    KEY32,MHCMURNO,MHCMUNIQ,MHCMSDAT,MHCMSTIM
          MOVE      KEY3,MHCMCTYP
          MOVE      ZERO,F3
.
UPDCM510  ADD       ONE,F3
          READ      DOCFILAF,SEQ;MHCMDATA
.
          MATCH     SP70,MHCMDATA
          IF        @EQUAL
            IF        F3>=LASTITEM
              GOTO      UPDCM999
            ELSE
              GOTO      UPDCM510
            ENDIF
          ENDIF
.
          MOVE      F3,MHCMLINE
          PACK      KEY38,MHCMURNO,MHCMUNIQ,MHCMSDAT,MHCMSTIM:
                          MHCMCTYP,MHCMLINE,SP70
          CALL      WRMHCMN1
          IF        F3>=LASTITEM
            GOTO      UPDCM999
          ENDIF
          GOTO      UPDCM510
.
UPDCM999  MOVE      ONE,DOCFLAG
          RETURN
+
.------------------------------------------------------------
.         Clear comments fields
.------------------------------------------------------------
CLRCMN00  MOVE      SP70,MHMDURNO  *  UR NUMBER
          MOVE      "001",MHMDTYPE *  Referral comments
          MOVE      SP70,MHMDNOTE  *  Note Number
          MOVE      SP70,MHMDDATE  *  Date
          MOVE      SP70,MHMDTIME  *  TIME
          MOVE      SP70,MHMDUSER  *  User
          MOVE      SP70,MHMDOCCG  *  Occupational Gp.
          MOVE      SP70,MHMDDELT  *  Delete Indicator
          MOVE      SP70,MHMDDDAT  *  Delete Date
          MOVE      SP70,MHMDDTIM  *  Delete Time
          MOVE      SP70,MHMDDUSE  *  Delete User
          MOVE      SP70,MHMDDOCC  *  Occupational Group WEB User ID delete
.
          MOVE      SP70,MHMTURNO  *  UR Number
          MOVE      SP70,MHMTTYPE  *  Referral type
          MOVE      SP70,MHMTNOTE  *  Note
          MOVE      SP70,MHMTUNIQ  *  Uniq line number
          PACK      MHMTCMNT,SP70,SP70  *  Comment line
.
CLRCMN99  RETURN
+
.------------------------------------------------------------
.         Add Mental Health referral
.------------------------------------------------------------
ADDREF00  MATCH     "1",HEAVIEW1                           *T0852969-Start
          GOTO      ADDREF05 IF EQUAL                      *T0852969-End
.
          MATCH     SP70,MHHLS033
          GOTO      ADDREF50 IF EQUAL
.
          PACK      KEY5,CATtm,MHHLS033,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ADDREF50
.
          MATCH     ANSI,TCINDC1
          GOTO      ADDREF50 IF NOT EQUAL
          GOTO      ADDREF07 IF EQUAL                      *T0852969-Start
.
.-------- Check Referral Source (Cat S ind7=I) for HEA
ADDREF05  MATCH     SP70,MHHLS007
          GOTO      ADDREF50 IF EQUAL
.
          PACK      KEY5,ANSS,SP1,MHHLS007,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ADDREF50
.
          MATCH     ANSI,TCINDC7
          GOTO      ADDREF50 IF NOT EQUAL
          GOTO      ADDREF07 IF EQUAL
.
ADDREF07  PACK      KEY16,URNUMBER,SP70                    *T0852969-End
          CALL      RSMHHLS1
ADDREF10  CALL      RKMHHLS1
          BRANCH    OVRCD,ADDREF50
.
          MATCH     URNUMBER,MHHLURNO
          GOTO      ADDREF50 IF NOT EQUAL
.
          MATCH     "1",HEAVIEW1                           *T0852969-Start
          GOTO      ADDREF15 IF EQUAL                      *T0852969-End
.
          MATCH     SP70,MHHLOREF
          GOTO      ADDREF10 IF EQUAL
.
          PACK      KEY5,CATtm,MHHLOREF,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ADDREF10
.
          MATCH     ANSI,TCINDC1
          GOTO      ADDREF10 IF NOT EQUAL
          GOTO      ADDREF30 IF EQUAL                      *T0852969-Start
.
.-------- Check Referral Source (Cat S Ind7=I) for HEA
ADDREF15  MATCH     SP70,MHHLSREF
          GOTO      ADDREF10 IF EQUAL
.
          PACK      KEY5,ANSS,SP1,MHHLSREF,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ADDREF10
.
          MATCH     ANSI,TCINDC7
          GOTO      ADDREF10 IF NOT EQUAL
          GOTO      ADDREF30 IF EQUAL
.
ADDREF30  MATCH     "1",MHHLSTAT                           *T0852969-End
          GOTO      ADDREF10 IF EQUAL
.
          MATCH     SP70,MHHLEDAT
          GOTO      ADDREF90 IF EQUAL
.
          GOTO      ADDREF10
.
ADDREF50  READ      CONTROLF,SIXTY9;*86,MHCNUNIQ
          MOVE      MHCNUNIQ,FORM8
          ADD       ONE,MHCNUNIQ
          WRITAB    CONTROLF,SIXTY9;*86,MHCNUNIQ
          MOVE      FORM8,MHCNUNIQ
.
          PACK      KEY16,URNUMBER,MHCNUNIQ,SP70
          CALL      RDMHHLS1
          COMPARE   ZERO,OVRCD
          GOTO      ADDREF00 IF EQUAL     * already exist, get next unique no.
.
          CALL      CLRHLS00
          MOVE      URNUMBER,MHHLURNO
          MOVE      MHCNUNIQ,MHHLUNIQ
          CALL      MVMHHL00              * move cgi variable
.
          MOVE      "0",MHHLSTAT              * always active
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,MHHLCDAT             * date created
          CLOCK     TIME,MHHLCTIM             * time created
          MOVE      USERID,MHHLCUID           * web user id
          UNPACK    SP70,MHHLUDAT,MHHLUTIM,MHHLUUID
          CALL      WRMHHLS1
.
          CLEAR     DIM100A                                           *I-195158
          APPEND    REDIRECT,DIM100A
          APPEND    "&uniqnumb=",DIM100A
          APPEND    MHHLUNIQ,DIM100A
          RESET     DIM100A
          REP       " +",DIM100A
          MOVE      DIM100A,REDIRECT                           * end  *I-195158
.
          MOVE      "A",MHHLRTYP               * set Record Type to 'Add'
          CALL      IBACLOCK
          PACK      MHHLMDAT,CCC,CYY,CMM,CDD   * Date
          REP       " 0",MHHLMDAT
          MOVE      CTIMEIS,MHHLMTIM
          MOVE      USERID,MHHLMUID            * Operator
.
          PACK      KEY24,MHHLURNO,MHHLMDAT,MHHLMTIM
          CALL      AWMHHL                     * Write Audit Header File
.
          IF        SENDZLSM > 0
            PACK      KEY8,URNUMBER,SP70       * Patient Referral Details
            CALL      RDMAST1
            IF        OVRCD=1
              CALL      CLPATMAS
            ENDIF
            CALL      RDPMPX21
            IF        OVRCD=1
              CALL      CLPMSPX2
            ENDIF
            CALL      PMIGTNID                 * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      THREE,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICUP                 * write PMI changes to Datagate
          ENDIF
.
          MOVE      ZERO,EXIT
.
          GOTO      ADDREF99
.
ADDREF90  MOVE      "Open Inpatient MH Referrals still exist. Please close.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDREF99
.
ADDREF99  RETURN
+
.------------------------------------------------------------
.         Update Mental Health referral
.------------------------------------------------------------
UPDREF00  PACK      KEY16,URNUMBER,UNIQNUMB,SP70
          CALL      RDMHHLS1
          BRANCH    OVRCD,UPDREF91
.
          MATCH     "1",HEAVIEW1                           *T0852969-Start
          GOTO      UPDREF03 IF EQUAL                      *T0852969-End
.
          MATCH     MHHLS033,MHHLOREF
          GOTO      UPDREF08 IF EQUAL         * origin of referral not changed
          GOTO      UPDREF06 IF NOT EQUAL                  *T0852969-Start
.
UPDREF03  MATCH     MHHLS007,MHHLSREF
          GOTO      UPDREF08 IF EQUAL         * Referral Source not changed
          GOTO      UPDREF06 IF NOT EQUAL
.                                                          
UPDREF06  CALL      CREF0000      * Check for existing referral *T0852969-End
          BRANCH    EXIT,UPDREF92
.
.         Check if the record is made Inactive
.
UPDREF08  MATCH     MHHLS006,MHHLSTAT
          GOTO      UPDREF30 IF EQUAL         * status hasn't changed
.
          MATCH     "1",SUPERLEV
          IF        @EQUAL
            MATCH     "1",MHHLSTAT            * Changed from Inactive to Active?
            IF        @EQUAL
              CALL      ACTVRF00              * Record is Reactive
              GOTO      UPDREF40
            ENDIF
          ENDIF
.
.         Record is made Inactive, ignore changes to all other fields
.
          CALL      MVMHHL00                  * move cgi variable
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,MHHLUDAT             * date updated
          CLOCK     TIME,MHHLUTIM             * time updated
          MOVE      USERID,MHHLUUID           * web user id
.
          MOVE      "1",MHHLSTAT            * Inactive
          CALL      UPMHHLS1
.
.         All Sections will be made Inactive too.
.
          PACK      KEY32,MHHLURNO,MHHLUNIQ,SP70
          CALL      RSMHDLS1
UPDREF10  CALL      RKMHDLS1
          BRANCH    OVRCD,UPDREF20
          MATCH     MHHLURNO,MHDLURNO          * Same U/R number
          GOTO      UPDREF20 IF NOT EQUAL
          MATCH     MHHLUNIQ,MHDLUNIQ          * Same uniq number?
          GOTO      UPDREF20 IF NOT EQUAL
          MATCH     "1",MHDLACTV
          GOTO      UPDREF10 IF EQUAL          * Already Inactive
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,MHDLUDAT             * date updated
          CLOCK     TIME,MHDLUTIM             * time updated
          MOVE      USERID,MHDLUUID           * web user id
          PACK      MHDLEDAT,MHHLEDAT
          PACK      MHDLETIM,MHHLETIM
.
          MOVE      "1",MHDLACTV
          CALL      UPMHDLS1
.
.         write to audit file - after made Inactive
.
          CALL      IBACLOCK
          PACK      MHDLMDAT,CCC,CYY,CMM,CDD     * Date
          REP       " 0",MHDLMDAT
          MOVE      "D",MHDLRTYP               * Inactive
          MOVE      CTIMEIS,MHDLMTIM
          MOVE      USERID,MHDLMUID            * Operator
.
          PACK      KEY32,MHDLURNO,MHDLUNIQ,MHDLMDAT,MHDLMTIM
          CALL      AWMHDL                * Write Audit File
.
          GOTO      UPDREF10
.
UPDREF20  MOVE      "D",MHHLRTYP               * set Record Type to Delete
          GOTO      UPDREF40
.
.         write to audit file - before update
.
UPDREF30  CALL      IBACLOCK
          PACK      MHHLMDAT,CCC,CYY,CMM,CDD   * Date
          REP       " 0",MHHLMDAT
          MOVE      "B",MHHLRTYP               * Before
          MOVE      CTIMEIS,MHHLMTIM
          MOVE      USERID,MHHLMUID            * Operator
.
          PACK      KEY24,MHHLURNO,MHHLMDAT,MHHLMTIM
          CALL      AWMHHL                       * Write Audit File
.
          MOVE      SP70,MHHLORCD
          MOVE      SP70,MHHLHCPC
          MOVE      SP70,MHHLESDT             * sentence date
          CALL      MVMHHL00                  * move cgi variable
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,MHHLUDAT             * date updated
          CLOCK     TIME,MHHLUTIM             * time updated
          MOVE      USERID,MHHLUUID           * web user id
          CALL      UPMHHLS1
.
          MOVE      "C",MHHLRTYP               * set Record Type to After
.
UPDREF40  CALL      IBACLOCK
          PACK      MHHLMDAT,CCC,CYY,CMM,CDD   * Date
          REP       " 0",MHHLMDAT
          MOVE      CTIMEIS,MHHLMTIM
          MOVE      USERID,MHHLMUID            * Operator
.
          PACK      KEY24,MHHLURNO,MHHLMDAT,MHHLMTIM
          CALL      AWMHHL                       * Write Audit File
.
          IF        SENDZLSM > 0
            PACK      KEY8,URNUMBER,SP70       * Patient Referral Details
            CALL      RDMAST1
            IF        OVRCD=1
              CALL      CLPATMAS
            ENDIF
            CALL      RDPMPX21
            IF        OVRCD=1
              CALL      CLPMSPX2
            ENDIF
            CALL      PMIGTNID                 * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      FOUR,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICUP                 * write PMI changes to Datagate
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      UPDREF99
.
UPDREF91  MOVE      "Referral record does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDREF99
.
UPDREF92  MOVE      "Open Inpatient MH Referral still exists",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDREF99
.
UPDREF99  RETURN
+
.------------------------------------------------------------
.         Reactive MH Referral
.------------------------------------------------------------
ACTVRF00  CALL      IBACLOCK
          PACK      MHHLMDAT,CCC,CYY,CMM,CDD   * Date
          REP       " 0",MHHLMDAT
          MOVE      "B",MHHLRTYP               * Before
          MOVE      CTIMEIS,MHHLMTIM
          MOVE      USERID,MHHLMUID            * Operator
.
          PACK      KEY24,MHHLURNO,MHHLMDAT,MHHLMTIM
          CALL      AWMHHL                       * Write Audit File
.
          MOVE      SP70,MHHLORCD
          MOVE      SP70,MHHLHCPC
          MOVE      SP70,MHHLESDT             * sentence date
          CALL      MVMHHL00                  * move cgi variable
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,MHHLUDAT             * date updated
          CLOCK     TIME,MHHLUTIM             * time updated
          MOVE      USERID,MHHLUUID           * web user id
          CALL      UPMHHLS1
.
          MOVE      "R",MHHLRTYP               * set Record Type to Reactive
ACTVRF99  RETURN
+
.------------------------------------------------------------
.         Check for an existing Inpatient referral
.------------------------------------------------------------
CREF0000  MOVE      KEY16,SAVKEY16
.
          MATCH     "1",HEAVIEW1                           *T0852969-Start
          GOTO       CREF0100 IF EQUAL                     *T0852969-End
.
.         Check if this is an inpatient Origin of Referral
.
          UNPACK    MHHLS033,KEY3
          PACK      KEY5,CATtm,KEY3,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CREF8000
.
          MATCH     "I",TCINDC1
          GOTO      CREF8000 IF NOT EQUAL
          GOTO      CREF1000 IF EQUAL                      *T0852969-Start
.
.         Check Source of referral for HEA
CREF0100  UNPACK    MHHLS007,KEY3
          PACK      KEY5,ANSS,SP1,KEY3,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CREF8000
          MATCH     ANSI,TCINDC7
          GOTO      CREF8000 IF NOT EQUAL
          GOTO      CREF1000 IF EQUAL
.
.         Check if there is already existing Inpatient referral
.
CREF1000  PACK      KEY16,URNUMBER,SP70                    *T0852969-End
          CALL      RSMHHLS1
CREF2000  CALL      RKMHHLS1
          BRANCH    OVRCD,CREF8000
.
          MATCH     URNUMBER,MHHLURNO       * Same U/R no?
          GOTO      CREF8000 IF NOT EQUAL
.
          PACK      KEY16,MHHLURNO,MHHLUNIQ,SP70
          MATCH     SAVKEY16,KEY16
          GOTO      CREF2000 IF EQUAL       * ignore current record
.
          MATCH     "1",HEAVIEW1                           *T0852969-Start
          GOTO      CREF2100 IF EQUAL                      *T0852969-End
.
          MATCH     SP70,MHHLOREF
          GOTO      CREF2000 IF EQUAL
.
          PACK      KEY5,CATtm,MHHLOREF,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CREF2000
          MATCH     "I",TCINDC1
          GOTO      CREF2000 IF NOT EQUAL   * Not an inpatient referral
          GOTO      CREF3000 IF EQUAL                      *T0852969-Start
.
CREF2100  MATCH     SP70,MHHLSREF
          GOTO      CREF2000 IF EQUAL
.
          PACK      KEY5,ANSS,SP1,MHHLSREF,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CREF2000
          MATCH     ANSI,TCINDC7
          GOTO      CREF2000 IF NOT EQUAL
          GOTO      CREF3000 IF EQUAL
.
CREF3000  MATCH     "1",MHHLSTAT                           *T0852969-End
          GOTO      CREF2000 IF EQUAL       * Inactive
.
          MATCH     SP70,MHHLEDAT
          GOTO      CREF2000 IF NOT EQUAL   * not open
.
          MOVE      ONE,EXIT
          GOTO      CREF9000
.
CREF8000  MOVE      ZERO,EXIT
.
CREF9000  MOVE      SAVKEY16,KEY16          * reposition
          CALL      RDMHHLS1
CREF9999  RETURN
+
.------------------------------------------------------------
.         Add referral details
.------------------------------------------------------------
ADDDRF00  MATCH     "0",TROTHFAC
          IF        @EQUAL
            CALL      VSDAT000                   * Validate start date
            BRANCH    EXIT,ADDDRF90
          ENDIF
.
          MOVE      "LS",CATEGORY
          MOVE      MHDLS004,CODE                * To get Section code
          CALL      GETCOD00
.
          MATCH     "D",TCINDC11
          GOTO      ADDDRF40 IF NOT EQUAL
.
          MOVE      THCSCOD,HDPEQUIV
.
ADDDRF10  MOVE      URNUMBER,MHDLURNO
          PACK      KEY32,MHDLURNO,SP70           * Loop through all Legal 
          CALL      RSMHDLS1                      * Statuses for the UR
ADDDRF20  CALL      RKMHDLS1
          BRANCH    OVRCD,ADDDRF40
.
          MATCH     URNUMBER,MHDLURNO
          GOTO      ADDDRF40 IF NOT EQUAL
.
          MATCH     MHDLS002,MHDLSDAT             * Match start date
          GOTO      ADDDRF20 IF NOT EQUAL
.
          MATCH     "1",MHDLACTV
          GOTO      ADDDRF20 IF EQUAL
.
          MATCH     MHDLS004,MHDLSCOD             * Match Legal Status code (LS)
          GOTO      ADDDRF70 IF EQUAL             * Error if already exists
.
          MOVE      MHDLSCOD,CODE                 * Retrieve HDP equiv
          CALL      GETCOD00
.
          MATCH     THCSCOD,HDPEQUIV              * Match HDP equiv 
          GOTO      ADDDRF70 IF EQUAL             * Error if already exists
.
          GOTO      ADDDRF20
.
ADDDRF40  CALL      CLRDLS00
          MOVE      URNUMBER,MHDLURNO
          MOVE      UNIQNUMB,MHDLUNIQ
          CALL      MVMHDL00              * move cgi variable
.
.         CLOCK     TIME,MHDLSTIM         * time
          PACK      KEY32,MHDLURNO,MHDLUNIQ,MHDLSDAT,MHDLSTIM,SP70
          CALL      RDMHDLS1
          COMPARE   ZERO,OVRCD
          IF        @EQUAL
            MATCH     "1",MHDLACTV
            IF        @EQUAL
              CALL      CLRDLS00
              MOVE      URNUMBER,MHDLURNO
              MOVE      UNIQNUMB,MHDLUNIQ
              CALL      MVMHDL00              * move cgi variable
              CALL      ASEC0000              * add 1 sec to date/time
              PACK      KEY32,MHDLURNO,MHDLUNIQ,MHDLSDAT,MHDLSTIM,SP70
              CALL      RAMHDLS1
              COMPARE   ZERO,OVRCD
              GOTO      ADDDRF80 IF EQUAL     * already exist
            ELSE
              GOTO      ADDDRF80              * already exist
            ENDIF
          ENDIF
.
          MOVE      "0",MHDLACTV              * always active
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,MHDLCDAT             * date created
          CLOCK     TIME,MHDLCTIM             * time created
          MOVE      USERID,MHDLCUID           * web user id
          UNPACK    SP70,MHDLUDAT,MHDLUTIM,MHDLUUID
          PACK      KEY32,MHDLURNO,MHDLUNIQ,MHDLSDAT,MHDLSTIM,SP70
          CALL      WRMHDLS1
.
          CALL      IBACLOCK
          PACK      MHDLMDAT,CCC,CYY,CMM,CDD     * Date
          REP       " 0",MHDLMDAT
          MOVE      "A",MHDLRTYP               * Add 
          MOVE      CTIMEIS,MHDLMTIM
          MOVE      USERID,MHDLMUID            * Operator
.
          PACK      KEY32,MHDLURNO,MHDLUNIQ,MHDLMDAT,MHDLMTIM
          CALL      AWMHDL                * Write Audit Detail File
.
          MOVE      MHDLSDAT,OPENDATE
          MOVE      MHDLSTIM,OPENTIME
          CALL      UPDCM000                  * Update document name
.
.         Check if the previous LS record has no End date and time
.
          MOVE      "LS",CATEGORY
          MOVE      MHDLSCOD,CODE
          CALL      GETCOD00
.
          MATCH     "N",TCINDC10
          GOTO      ADDDRF60 IF EQUAL

          MOVE      MHDLSDAT,TRANDATE
          MOVE      MHDLSTIM,TRANTIME
          PACK      KEY16,MHDLURNO,MHDLUNIQ,SP70
          PACK      KEY32,MHDLURNO,MHDLUNIQ,MHDLSDAT,MHDLSTIM,SP70
          CALL      RDMHDLS1
          BRANCH    OVRCD,ADDDRF60
.
ADDDRF50  CALL      RPMHDLS1               * read previous record
          BRANCH    OVRCD,ADDDRF60
.
          PACK      SKEY16,MHDLURNO,MHDLUNIQ,SP70
          MATCH     KEY16,SKEY16
          GOTO      ADDDRF60 IF NOT EQUAL
          MATCH     SP70,MHDLEDAT
          IF        !@EQUAL
            MATCH     "1",MHDLACTV
            IF        @EQUAL
              GOTO      ADDDRF50
            ELSE
              GOTO      ADDDRF60
            ENDIF
          ENDIF
.
.         Before update end date/time audit record
.
          CALL      IBACLOCK
          PACK      MHDLMDAT,CCC,CYY,CMM,CDD   * Date
          REP       " 0",MHDLMDAT
          MOVE      "B",MHDLRTYP               * Before
          MOVE      CTIMEIS,MHDLMTIM
          MOVE      USERID,MHDLMUID            * Operator
.
          PACK      KEY32,MHDLURNO,MHDLUNIQ,MHDLMDAT,MHDLMTIM
          CALL      AWMHDL                * Write Audit File
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,MHDLUDAT             * date updated
          CLOCK     TIME,MHDLUTIM             * time updated
          MOVE      USERID,MHDLUUID           * web user id
.
          MOVE      TRANDATE,MHDLEDAT
          MOVE      TRANTIME,MHDLETIM
          MOVE      "N",MHDLSENT
          CALL      UPMHDLS1
.
.         After update end date/time audit record
.
          MOVE      "C",MHDLRTYP               * After
          CALL      IBACLOCK
          PACK      MHDLMDAT,CCC,CYY,CMM,CDD     * Date
          REP       " 0",MHDLMDAT
          MOVE      CTIMEIS,MHDLMTIM
          MOVE      USERID,MHDLMUID            * Operator
.
          PACK      KEY32,MHDLURNO,MHDLUNIQ,MHDLMDAT,MHDLMTIM
          CALL      AWMHDL                * Write Audit File
.
ADDDRF60  IF        SENDZLSM > 0
            PACK      KEY8,URNUMBER,SP70       * Patient Referral Details
            CALL      RDMAST1
            IF        OVRCD=1
              CALL      CLPATMAS
            ENDIF
            CALL      RDPMPX21
            IF        OVRCD=1
              CALL      CLPMSPX2
            ENDIF
            CALL      PMIGTNID                 * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      FIVE,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICUP                 * write PMI changes to Datagate
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      ADDDRF99
.
ADDDRF70  PACK      WEBTITLE,SP70
          RESET     WEBTITLE
          APPEND    "Duplicate Legal Status. Existing Legal Status code ",WEBTITLE
          APPEND     "or mapped PRIMHD code exists for this date.",WEBTITLE
          APPEND    SP70,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDDRF99
.
ADDDRF80  MOVE      "Legal Status record already exists for the date.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDDRF99
.
ADDDRF90  MOVE      "LS Start date must be AFTER Referral Start Date.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDDRF99
.
ADDDRF99  RETURN
+
.--------------------------------------------------------------
.         Validate start date against the ref/header start date
.--------------------------------------------------------------
VSDAT000  MOVE      MHDLS002,MHDLSDAT
          MOVE      MHDLS003,MHDLSTIM
          PACK      KEY16,URNUMBER,UNIQNUMB,SP70
          CALL      RDMHHLS1
          BRANCH    OVRCD,VSDAT900
.
          MATCH     MHHLSDAT,MHDLSDAT
          GOTO      VSDAT900 IF LESS       * date must be after Ref.start date
.
          MATCH     MHDLSDAT,MHHLSDAT
          IF        @EQUAL
            MATCH     MHHLSTIM,MHDLSTIM
            GOTO      VSDAT900 IF LESS
          ENDIF
.
VSDAT200  MATCH     SP70,MHHLEDAT          * Check end date
          GOTO      VSDAT800 IF EQUAL
.
          MATCH     MHDLSDAT,MHHLEDAT
          GOTO      VSDAT900 IF LESS       * date must be before Ref.end date
.
          MATCH     MHDLSDAT,MHHLEDAT
          IF        @EQUAL
            MATCH     MHDLSTIM,MHHLETIM
            GOTO      VSDAT900 IF LESS
          ENDIF
.
VSDAT800  MOVE      ZERO,EXIT
          GOTO      VSDAT9999
.
VSDAT900  MOVE      ONE,EXIT
VSDAT999  RETURN
+
.*****************************************************************************
.*                            ASEC0000             Called by: ADDDRF00       *
.*               Add one second to date/time                                 *
.* Requires: MHDLSTIM - Date/time value (ccyymmddhhmmss)                     *
.* Returns : MHDLSTIM - Date/time value (ccyymmddhhmmss) incremented by 1 sec*
.*****************************************************************************
.
ASEC0000  UNPACK    MHDLSTIM,HOURTM,KEY1,MINTIME,KEY1,SECTIME
          MATCH     "59",SECTIME
          IF        !@EQUAL
            MOVE      SECTIME,FORM2              * just increment seconds
            ADD       ONE,FORM2
            MOVE      FORM2,SECTIME
            REP       " 0",SECTIME
            PACK      MHDLSTIM,HOURTM,KEY1,MINTIME,KEY1,SECTIME
            GOTO      ASEC9999
          ENDIF
.
.         The seconds were "59", so reset these to "00" and increment the
.         minutes
.
          MOVE      "00",SECTIME
          MATCH     "59",MINTIME
          IF        !@EQUAL
            MOVE      MINTIME,FORM2              * just increment minutes
            ADD       ONE,FORM2
            MOVE      FORM2,MINTIME
            REP       " 0",MINTIME
            PACK      MHDLSTIM,HOURTM,KEY1,MINTIME,KEY1,SECTIME
            GOTO      ASEC9999
          ENDIF
.
.         The minutes were "59", so reset these to "00" and increment the
.         hours
.
          MOVE      "00",SECTIME
          MOVE      "00",MINTIME
          MATCH     "23",HOURTM
          IF        !@EQUAL
            MOVE      HOURTM,FORM2              * just increment hours
            ADD       ONE,FORM2
            MOVE      FORM2,HOURTM
            REP       " 0",HOURTM
            PACK      MHDLSTIM,HOURTM,KEY1,MINTIME,KEY1,SECTIME
            GOTO      ASEC9999
          ENDIF
.
.         The hours were "59", so reset these to "00" and increment the
.         date
.
          MOVE      "00",SECTIME
          MOVE      "00",MINTIME
          MOVE      "00",HOURTM
.
.         We need to increment the date by 1 day
.
          UNPACK    MHDLSDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CCENT,CC
          MOVE      CYEAR,YY
          MOVE      CMON,MM
          MOVE      CDAY,DD
          CALL      DMYCON                       * get julian day
          ADD       ONE,JULDAY                   * increment julian day
          MOVE      JULDAY,JWKDAY
          MOVE      JULYR,JWKYER
          MOVE      JULCC,JWKCC
          CALL      JULCON                       * get new date
          PACK      MHDLSDAT,CC,YY,MM,DD
          PACK      MHDLSTIM,ZERO2,COLON,ZERO2,COLON,ZERO2
          REP       " 0",MHDLSDAT
          REP       " 0",MHDLSTIM
.
ASEC9999  RETURN
.
.------------------------------------------------------------
.         Update referral details
.------------------------------------------------------------
UPDDRF00  PACK      KEY32,URNUMBER,UNIQNUMB,OPENDATE,OPENTIME,SP70
          CALL      RDMHDLS1
          BRANCH    OVRCD,UPDDRF80
.
.         Check if the record is made Inactive
.
          MATCH     MHDLS015,MHDLACTV
          GOTO      UPDDRF10 IF EQUAL          * status hasn't changed
.
          MATCH     "1",MHDLACTV
          IF        @EQUAL
            CALL      ACTVLS00              * Record is Reactive
            GOTO      UPDDRF20
          ENDIF
.
.         Record is made Inactive
.
          CALL      MVMHDL00              * move cgi variable
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,MHDLUDAT             * date updated
          CLOCK     TIME,MHDLUTIM             * time updated
          MOVE      USERID,MHDLUUID           * web user id
.
          MOVE      "1",MHDLACTV              * Inactive
          CALL      UPMHDLS1
.
          PACK      SAVKEY32,MHDLURNO,MHDLUNIQ,MHDLSDAT,MHDLSTIM
          CALL      RPMHDLS1
          IF        OVRCD=0
            MATCH     URNUMBER,MHDLURNO
            GOTO      UPDDRF05 IF NOT EQUAL
.
            MATCH     UNIQNUMB,MHDLUNIQ
            GOTO      UPDDRF05 IF NOT EQUAL
.
            MATCH     "1",MHDLACTV
            GOTO      UPDDRF05 IF EQUAL
.
            MOVE      SP70,MHDLEDAT
            MOVE      SP70,MHDLETIM
            CALL      UPMHDLS1
.
          ENDIF
.
UPDDRF05  PACK      KEY32,SAVKEY32,SP70
          CALL      RDMHDLS1
.
          MOVE      "D",MHDLRTYP               * Delete record type
          GOTO      UPDDRF20                   * Write to audit file
.
.         write to audit file - before update
.
UPDDRF10  CALL      IBACLOCK
          PACK      MHDLMDAT,CCC,CYY,CMM,CDD   * Date
          REP       " 0",MHDLMDAT
          MOVE      "B",MHDLRTYP               * Before 
          MOVE      CTIMEIS,MHDLMTIM
          MOVE      USERID,MHDLMUID            * Operator
.
          PACK      KEY32,MHDLURNO,MHDLUNIQ,MHDLMDAT,MHDLMTIM
          CALL      AWMHDL                * Write Audit File
.
          MOVE      "0",LSCHANGE
.
          MATCH     MHDLS008,MHDLHCPC
          GOTO      UPDDRF12 IF NOT EQUAL
.
          MATCH     MHDLS017,MHDLEDAT
          GOTO      UPDDRF12 IF NOT EQUAL
.
          MATCH     MHDLS018,MHDLETIM
          GOTO      UPDDRF12 IF NOT EQUAL
.
          GOTO      UPDDRF15
.
UPDDRF12  MOVE      "1",LSCHANGE
.
UPDDRF15  CALL      MVMHDL00              * move cgi variable
          MATCH     "1",MHDLRESD          * Not residential?
          IF        !@EQUAL
            MOVE      SP70,MHDLRCOD       * Place of resident should be blank
          ENDIF
.                                                                     *I-258616
          MATCH     "1",LSCHANGE
          IF        @EQUAL
            MATCH     "1",MHDLACTV          * if Active set MHDLSENT to "N"
            IF        !@EQUAL
              MOVE      "N",MHDLSENT        * update not sent
            ENDIF
          ENDIF
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,MHDLUDAT             * date updated
          CLOCK     TIME,MHDLUTIM             * time updated
          MOVE      USERID,MHDLUUID           * web user id
          CALL      UPMHDLS1
.
          CALL      UPDCM000                  * Update document name
.
.         write to audit file - after update
.
          MOVE      "C",MHDLRTYP               * After 
UPDDRF20  CALL      IBACLOCK
          PACK      MHDLMDAT,CCC,CYY,CMM,CDD     * Date
          REP       " 0",MHDLMDAT
          MOVE      CTIMEIS,MHDLMTIM
          MOVE      USERID,MHDLMUID            * Operator
.
          PACK      KEY32,MHDLURNO,MHDLUNIQ,MHDLMDAT,MHDLMTIM
          CALL      AWMHDL                * Write Audit File
.
          IF        SENDZLSM > 0
            PACK      KEY8,URNUMBER,SP70       * Patient Referral Details
            CALL      RDMAST1
            IF        OVRCD=1
              CALL      CLPATMAS
            ENDIF
            CALL      RDPMPX21
            IF        OVRCD=1
              CALL      CLPMSPX2
            ENDIF
            CALL      PMIGTNID                 * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      SIX,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICUP                 * write PMI changes to Datagate
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      UPDDRF99
.
UPDDRF80  MOVE      "Legal Status record does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDDRF99
.
UPDDRF99  RETURN
+
.------------------------------------------------------------
.         Reactive MH Legal status
.------------------------------------------------------------
ACTVLS00  CALL      IBACLOCK
          PACK      MHDLMDAT,CCC,CYY,CMM,CDD   * Date
          REP       " 0",MHDLMDAT
          MOVE      "B",MHDLRTYP               * Before
          MOVE      CTIMEIS,MHDLMTIM
          MOVE      USERID,MHDLMUID            * Operator
.
          PACK      KEY32,MHDLURNO,MHDLUNIQ,MHDLMDAT,MHDLMTIM
          CALL      AWMHDL                * Write Audit File
.
          MOVE      "0",LSCHANGE
.
          MATCH     MHDLS008,MHDLHCPC
          GOTO      ACTVLS12 IF NOT EQUAL
.
          MATCH     MHDLS017,MHDLEDAT
          GOTO      ACTVLS12 IF NOT EQUAL
.
          MATCH     MHDLS018,MHDLETIM
          GOTO      ACTVLS12 IF NOT EQUAL
.
          GOTO      ACTVLS15
.
ACTVLS12  MOVE      "1",LSCHANGE
.
ACTVLS15  CALL      MVMHDL00              * move cgi variable
          MATCH     "1",MHDLRESD          * Not residential?
          IF        !@EQUAL
            MOVE      SP70,MHDLRCOD       * Place of resident should be blank
          ENDIF
.                                                                     *I-258616
          MATCH     "1",LSCHANGE
          IF        @EQUAL
            MATCH     "1",MHDLACTV          * if Active set MHDLSENT to "N"
            IF        !@EQUAL
              MOVE      "N",MHDLSENT        * update not sent
            ENDIF
          ENDIF
.
          MATCH     "1",SUPERLEV
          IF        @EQUAL
            MATCH     "1",MHDLACTV          * if Active set MHDLSENT to "N"
            IF        !@EQUAL
              MOVE      "N",MHDLSENT        * update not sent
            ENDIF
          ENDIF
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MOVE      KEY8,MHDLUDAT             * date updated
          CLOCK     TIME,MHDLUTIM             * time updated
          MOVE      USERID,MHDLUUID           * web user id
          CALL      UPMHDLS1
          CALL      UPDCM000                  * Update document name
.
.         write to audit file - Reactive
.
          MOVE      "R",MHDLRTYP               * Reactive
.
ACTVLS99  RETURN
+
.------------------------------------------------------------
.         Update referral details for supervisor
.------------------------------------------------------------
UPDDRS00  MATCH     "0",TROTHFAC
          IF        @EQUAL
            CALL      VSDAT000                 * Validate start date
            BRANCH    EXIT,UPDDRS90
          ENDIF
.
          PACK      KEY32,URNUMBER,UNIQNUMB,OPENDATE,OPENTIME,SP70
          CALL      RDMHDLS1
          BRANCH    OVRCD,UPDDRS80
.
          CALL      CHGSND00 
.
          MATCH     MHDLS002,MHDLSDAT          * Start date changed
          GOTO      UPDDRS02 IF NOT EQUAL
.
          MATCH     MHDLS003,MHDLSTIM          * Start Time changed
          GOTO      UPDDRS02 IF NOT EQUAL
.
. Start date/time is not changed, do the normal update
.
          CALL      UPDDRF00
          GOTO      UPDDRS99 
.
.---------------------------------------------------------------------
. Start date/time is changed, update the existing mehdlsaf row with
. an inactive status and write out a new one with the new details.
.---------------------------------------------------------------------
.
UPDDRS02  CALL      IBACLOCK
          CLOCK     TIME,CTIMEIS
.
. write to audit file - before update
.
          MOVE      "B",MHDLRTYP               * Before
          PACK      MHDLMDAT,CCC,CYY,CMM,CDD   * Date
          REP       " 0",MHDLMDAT
          MOVE      CTIMEIS,MHDLMTIM
          MOVE      USERID,MHDLMUID            * Operator
.
          PACK      KEY32,MHDLURNO,MHDLUNIQ,MHDLMDAT,MHDLMTIM
          CALL      AWMHDL                     * Write Audit File
.
. Update status to inactive or active
.
          PACK      MHDLUDAT,CCC,CYY,CMM,CDD
          REP       " 0",MHDLUDAT              * date updated
          MOVE      CTIMEIS,MHDLUTIM           * time updated
          MOVE      USERID,MHDLUUID            * web user id
          MOVE      "1",MHDLACTV               * Inactive
.
          MATCH     SP70,MHDLEDAT
          IF        @EQUAL
            MOVE      MHDLSDAT,MHDLEDAT
            MOVE      MHDLSTIM,MHDLETIM
          ENDIF
.
          CALL      UPMHDLS1
.
. write to audit file - 1st row with after update
.
          MOVE      "D",MHDLRTYP               * After
          CALL      AWMHDL                     * Write Audit File
.
. create new details row with new start date/time
.
          CALL      MVMHDL00                   * move cgi variable  
.
          MOVE      "0",MHDLACTV
          MOVE      "N",MHDLSENT
.
          MATCH     "1",LSCHANGE
          IF        @EQUAL
            MATCH     "1",MHDLACTV             * if Active set MHDLSENT to "N"
            IF        !@EQUAL
              MOVE      "N",MHDLSENT           * update not sent
            ENDIF
          ENDIF
. 
          MATCH     "1",MHDLRESD               * Not residential?
          IF        !@EQUAL
            MOVE      SP70,MHDLRCOD            * Resident place should be blank
          ENDIF
.
. Check if the record is made Inactive. Changed from Active to Inactive
.
          MATCH     "0",MHDLS015
          IF        @EQUAL               
            MOVE      "C",MHDLRTYP                              
          ELSE
            MOVE      "D",MHDLRTYP    
            MOVE      "1",MHDLACTV
          ENDIF
. 
          PACK      KEY8,CCC,CYY,CMM,CDD
          UNPACK    CTIMEIS,HOUR,D1,MIN,D1,SEC
          PACK      ADATTIME,KEY8,HOUR,MIN,SEC,SP70
          REP       " 0",ADATTIME
          CALL      AD1SEC00                    * add 1 sec to date/time
                                                * to stop duplicate key
          REP       " 0",ADATTIME
          UNPACK    ADATTIME,KEY8,HOUR,MIN,SEC
          PACK      CTIMEIS,HOUR,COLON,MIN,COLON,SEC
.
          MOVE      KEY8,MHDLCDAT              * date created
          MOVE      CTIMEIS,MHDLCTIM           * time created
          MOVE      USERID,MHDLCUID            * web user id
.
          MOVE      KEY8,MHDLUDAT              * date updated
          MOVE      CTIMEIS,MHDLUTIM           * time updated
          MOVE      USERID,MHDLUUID            * web user id
.
          PACK      KEY32,MHDLURNO,MHDLUNIQ,MHDLSDAT,MHDLSTIM
          CALL      WRMHDLS1    
.
. write to audit file - 2nd row with after update
.
          MOVE      KEY8,MHDLMDAT              * Date  
          MOVE      CTIMEIS,MHDLMTIM
          MOVE      USERID,MHDLMUID            * Operator
.
          PACK      KEY32,MHDLURNO,MHDLUNIQ,MHDLMDAT,MHDLMTIM
          CALL      AWMHDL                     * Write Audit File
.
          CALL      UPDCM000                   * Update document name
.
          IF        SENDZLSM > 0
            PACK      KEY8,URNUMBER,SP70       * Patient Referral Details
            CALL      RDMAST1
            IF        OVRCD=1
              CALL      CLPATMAS
            ENDIF
            CALL      RDPMPX21
            IF        OVRCD=1
              CALL      CLPMSPX2
            ENDIF
            CALL      PMIGTNID                 * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      SIX,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICUP                 * write PMI changes to Datagate
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      UPDDRS99
.
UPDDRS80  MOVE      "Legal Status record does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      UPDDRS99
.
UPDDRS90  MOVE      "LS Start date must be AFTER Referral Start Date.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ADDDRF99
.
UPDDRS99  RETURN
.
.---------------------------------------------------------------------
. If end date/time, review HCP or legal status code is changed, set 
. LSCHANGE = "1". Otherwise, set LSCHANGE = "0".
.---------------------------------------------------------------------
CHGSND00  MOVE      "0",LSCHANGE
.
          MATCH     MHDLS017,MHDLEDAT
          GOTO      CHGSND30 IF NOT EQUAL
.
          MATCH     MHDLS018,MHDLETIM
          GOTO      CHGSND30 IF NOT EQUAL
.
          MATCH     MHDLS008,MHDLHCPC
          GOTO      CHGSND30 IF NOT EQUAL
.
          MATCH     MHDLS004,MHDLSCOD
          GOTO      CHGSND30 IF NOT EQUAL
.
          GOTO      CHGSND99
.
CHGSND30  MOVE      "1",LSCHANGE
.
CHGSND99  RETURN
.
.------------------------------------------------------------
.         Delete referral details
.------------------------------------------------------------
DELDRF00  PACK      KEY16,URNUMBER,UNIQNUMB,SP70
          CALL      RDMHHLS1
          BRANCH    OVRCD,DELDRF90
.
          MOVE      ONE,MHHLSTAT
          CALL      UPMHHLS1
.
          MOVE      "D",MHHLRTYP               * set Record Type to 'Add'
          CALL      IBACLOCK
          PACK      MHHLMDAT,CCC,CYY,CMM,CDD   * Date
          REP       " 0",MHHLMDAT
          MOVE      CTIMEIS,MHHLMTIM
          MOVE      USERID,MHHLMUID            * Operator
.
          PACK      KEY24,MHHLURNO,MHHLMDAT,MHHLMTIM
          CALL      AWMHHL                     * Write Audit Header File
.
          IF        SENDZLSM > 0
            PACK      KEY8,URNUMBER,SP70       * Patient Referral Details
            CALL      RDMAST1
            IF        OVRCD=1
              CALL      CLPATMAS
            ENDIF
            CALL      RDPMPX21
            IF        OVRCD=1
              CALL      CLPMSPX2
            ENDIF
            CALL      PMIGTNID                 * get national id for dgate write
            MOVE      NMPNUMB,PTNINMPI
            MOVE      SEVEN,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLICUP                 * write PMI changes to Datagate
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      DELDRF99
.
DELDRF90  MOVE      "Legal Status referral record does not exist",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DELDRF99
.
DELDRF99  RETURN
+
.---------------------------------------------------------------
.         Add Referral comments
.---------------------------------------------------------------
ADDCMN00  MOVE      ZERO,F6
          MOVE      URNUMBER,MHMDURNO       * UR number
.
          MOVE      "001",MHMDTYPE
          PACK      KEY17,URNUMBER,MHMDTYPE,Z70
          CALL      RSMHMDT1
          CALL      RPMHMDT1                * read back to get last record
          IF        OVRCD=1
            MOVE      ONE,F6
            MOVE      F6,MHMDNOTE           * Note Number
          ELSE
            MATCH     URNUMBER,MHMDURNO
            IF        @EQUAL
              MOVE      MHMDNOTE,F6
              ADD       ONE,F6
              MOVE      F6,MHMDNOTE
            ELSE
              MOVE      ONE,F6
              MOVE      F6,MHMDNOTE         * Note Number
            ENDIF
          ENDIF
.
          PACK      MHMDDATE,CCC,CYY,CMM,CDD
          REP       " 0",MHMDDATE          * Date
          CLOCK     TIME,MHMDTIME
          MOVE      USERID,MHMDUSER        * User
.
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,ADDCMN99
.
          MOVE      WBSEOCG,MHMDOCCG        * Occupation Group
          MOVE      "0",MHMDDELT            * Delete Indicator
          UNPACK    SP70,MHMDDDAT,MHMDDTIM,MHMDDUSE,MHMDDOCC
.
          MOVE      SP70,MHMDSPAR           * Spare
          MOVE      URNUMBER,MHMDURNO
          MOVE      "001",MHMDTYPE          * Referral comments
.
          PACK      KEY17,URNUMBER,MHMDTYPE,MHMDNOTE,SP70
          CALL      RDMHMDT1
          IF        OVRCD=1
            CALL      WRMHMDT1              * Write Record
          ELSE
            GOTO      ADDCMN99
          ENDIF
.
.         now write the medical notes
.
          MOVE      URNUMBER,MHMTURNO
          MOVE      MHMDTYPE,MHMTTYPE          * Referral comments
          MOVE      MHMDNOTE,MHMTNOTE
          MOVE      SP70,MHMTSPAR
          MOVE      ZERO,F3
.
ADDCMN90  ADD       ONE,F3
          MOVE      F3,MHMTUNIQ
.
          READ      COMFILAF,SEQ;MHMTCMNT
.
          PACK      KEY20,MHMTURNO,MHMTTYPE,MHMTNOTE,MHMTUNIQ,SP70
          CALL      WRMHMTX1
          IF        F3>=LASTITEM
            GOTO     ADDCMN99
          ENDIF
          GOTO      ADDCMN90
.
ADDCMN99  RETURN
+
.---------------------------------------------------------------
.         Delete Referral comments
.---------------------------------------------------------------
DELCMN00  MOVE      URNUMBER,MHMDURNO   *  UR number
          MOVE      "001",MHMDTYPE
.
          PACK      KEY17,URNUMBER,MHMDTYPE,NOTENUMB,SP70
          CALL      RDMHMDT1
          BRANCH    OVRCD,DELCMN99
.
          MATCH     USERID,MHMDUSER
          GOTO      DELCMN91 IF NOT EQUAL
.
          PACK      MHMDDDAT,CCC,CYY,CMM,CDD
          REP       " 0",MHMDDDAT
          CLOCK     TIME,MHMDDTIM
          MOVE      USERID,MHMDDUSE
.
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,DELCMN99
.
          MOVE      WBSEOCG,MHMDDOCC       * user group
.
          MOVE      "1",MHMDDELT           * Delete Indicator
          PACK      KEY17,URNUMBER,MHMDTYPE,NOTENUMB,SP70
          CALL      UPMHMDT1               * Write Record
          GOTO      DELCMN98
.
DELCMN91  MOVE      "User ID must be the same to strikeout this entry.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DELCMN99
.
DELCMN98  MOVE      ZERO,EXIT
.
DELCMN99  RETURN
.---------------------------------------------------------------
.         Generate review and reminder date from a Section Code
.---------------------------------------------------------------
GETDAT00  CALL      XMLHED00
          BRANCH    EXIT,GETDAT99
.
          UNPACK    SP70,MHDLRDAT,KEY11       * review date
          UNPACK    SP70,MHDLREMD,KEY11A      * reminder date
          PACK      VALDCODE,VALDCODE,SP70
          MOVE      "LS",TCODE
          PACK      KEY5,TCODE,VALDCODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,GETDAT90
.
          COMPARE   ZERO,TCFORM6        * Check associated number
          GOTO      GETDAT40 IF LESS
          GOTO      GETDAT40 IF EQUAL
.
.         Next review date will be Start date + (value of associated number)
.
          MOVE      OPENDATE,WORKDATE
          ADD       TCFORM6,WORKDATE
          MOVE      WORKDATE,MHDLRDAT   * review date
.
          UNPACK    MHDLRDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
.         Reminder date will be (value of TCINDC2) prior to the Review date
.
GETDAT40  PACK      PTCDASC1,PTCDASC1,SP8
          MATCH     SP70,PTCDASC1
          GOTO      GETDAT41 IF EQUAL
          RJUSTIFY  PTCDASC1
          TYPE      PTCDASC1
          GOTO      GETDAT85 IF NOT EQUAL   * Not numeric
          MOVE      ZERO,FORM6
          MOVE      PTCDASC1,FORM6
          MOVE      FORM6,TCFORM6
          GOTO      GETDAT42
.
GETDAT41  MATCH     SP70,TCINDC2
          GOTO      GETDAT85 IF EQUAL
          TYPE      TCINDC2
          GOTO      GETDAT85 IF NOT EQUAL   * Not numeric
          MOVE      ZERO,FORM1
          MOVE      TCINDC2,FORM1
          MOVE      FORM1,TCFORM6
.
GETDAT42  MATCH     SP70,REVWDATE
          GOTO      GETDAT85 IF EQUAL
          MOVE      REVWDATE,WORKDATE
          SUB       TCFORM6,WORKDATE
          MOVE      WORKDATE,MHDLREMD   * reminder date
.
          UNPACK    MHDLREMD,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11A,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
GETDAT85  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             KEY11,"|",KEY11A:
                             "</RETURN_VALUE>"
          GOTO      GETDAT98
.
GETDAT90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Legal Status Code - ":
                              KEY6,"</RETURN_VALUE>"
          GOTO      GETDAT98

GETDAT98  CALL      XMLEND00
GETDAT99  RETURN
+
.-------------------------------------------------------------
. Get Referral details from PMI or External Organisation table
.-------------------------------------------------------------
GETREF00  CALL      XMLHED00
          BRANCH    EXIT,GETREF99
.
          MOVE      "S ",TCODE
          PACK      KEY5,TCODE,SREFCODE      * Source referral
          CALL      RDCODE1
          BRANCH    OVRCD,GETREF90
.
          MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,GETREF91           * missing master record
.
          MATCH     "G",TCINDC7
          GOTO      GETREF10 IF EQUAL        * GP from PMI
.
          MATCH     "B",TCINDC7
          GOTO      GETREF30 IF EQUAL        * Public Hospital
.
          MATCH     "P",TCINDC7
          GOTO      GETREF30 IF EQUAL        * Private Hospital
.
          MATCH     "A",TCINDC7
          GOTO      GETREF30 IF EQUAL        * External Agency
.
          MATCH     "N",TCINDC7
          GOTO      GETREF40 IF EQUAL        * Next of Kin from PMI
.
          MATCH     "E",TCINDC7
          GOTO      GETREF50 IF EQUAL        * Emergency contact from PMI
.
          MATCH     "R",TCINDC7
          GOTO      GETREF60 IF EQUAL        * Nearest relative from PMI
          GOTO      GETREF90
.
.         GP from PMI or a selected GP
.
GETREF10  ENDSET    VALDCODE
          APPEND    SP70,VALDCODE
          RESET     VALDCODE
.
          MATCH     SP70,VALDCODE
          GOTO      GETREF16 IF EQUAL
.
          PACK      KEY10,VALDCODE,SP70
          GOTO      GETREF18
.
GETREF16  PACK      KEY10,PMPXRHC1,SP70
          MATCH     SP70,KEY10
          IF        @EQUAL
            UNPACK    SP70,DOCFNAME
            UNPACK    SP70,PMHCADR1
            UNPACK    SP70,PMHCADR2
            UNPACK    SP70,PMHCADR3
            UNPACK    SP70,PMHCADR4
            UNPACK    SP70,PMHCPOST
            UNPACK    SP70,PMHCSTEL
            GOTO      GETREF20
          ENDIF
.
GETREF18  CALL      RDPMHCP1
          BRANCH    OVRCD,GETREF92
.
          MOVE      PMHCTITL,FMTTITLE
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000
.
GETREF20  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             DOCFNAME,"|",PMHCADR1,"|",PMHCADR2,"|":
                             PMHCADR3,"|",PMHCADR4,"|",PMHCPOST,"|":
                             PMHCSTEL:
                             "</RETURN_VALUE>"
          GOTO      GETREF98
.
.         Hospital/External Agency details
.
GETREF30  UNPACK    VALDCODE,KEY6
          PACK      KEY7,TCINDC7,KEY6,SP70
          CALL      RDPTEOR1
          BRANCH    OVRCD,GETREF93
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PTERNAME,"|",PTERADD1,"|",PTERADD2,"|":
                             PTERADD3,"|",PTERADD4,"|",PTERPOST,"|":
                             PTERTELP:
                             "</RETURN_VALUE>"
          GOTO      GETREF98
.
.         Next of kin details
.
GETREF40  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PNKNAME,"|",PNKADD1,"|",PNKADD2,"|":
                             PNKSUBR,"|",PNKADD4,"|",PNKPOST,"|":
                             PNKTELP:
                             "</RETURN_VALUE>"
          GOTO      GETREF98
.
.         Emergency contact details
.
GETREF50  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PTMXECNM,"|",PTMXECA1,"|",PTMXECA2,"|":
                             PTMXECA3,"|",PTMXECA4,"|",PTMXECPC,"|":
                             PTMXECPP:
                             "</RETURN_VALUE>"
          GOTO      GETREF98
.
.         Nearest relatives details
.
GETREF60  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PTMXNRNM,"|",PTMXNRA1,"|",PTMXNRA2,"|":
                             PTMXNRA3,"|",PTMXNRA4,"|",PTMXNRPC,"|":
                             PTMXNRPP:
                             "</RETURN_VALUE>"
          GOTO      GETREF98
.
GETREF90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Source of Referral Code - ":
                              KEY6,"</RETURN_VALUE>"
          GOTO      GETREF98
.
GETREF91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Missing Master record - ":
                              URNUMBER,"</RETURN_VALUE>"
          GOTO      GETREF98
.
GETREF92  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid GP- ":
                              KEY10,"</RETURN_VALUE>"
          GOTO      GETREF98
.
GETREF93  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Organisation Code- ":
                              KEY6,"</RETURN_VALUE>"
          GOTO      GETREF98
.
GETREF98  CALL      XMLEND00
GETREF99  RETURN
.
.---------------------------------------------------------------
.         Check if Legal status already exists on the day
.---------------------------------------------------------------
CHKLEG00  CALL      XMLHED00
          BRANCH    EXIT,CHKLEG99
.
          PACK      KEY32,URNUMBER,UNIQNUMB,TRANDATE,SP70
          CALL      RSMHDLS1
CHKLEG10  CALL      RKMHDLS1
          BRANCH    OVRCD,CHKLEG98
          MATCH     URNUMBER,MHDLURNO          * check U/R number
          GOTO      CHKLEG90 IF NOT EQUAL
          MATCH     UNIQNUMB,MHDLUNIQ          * check uniq.number
          GOTO      CHKLEG90 IF NOT EQUAL
          MATCH     SP70,MHDLEDAT
          GOTO      CHKLEG10 IF NOT EQUAL
          MATCH     "1",MHDLACTV
          GOTO      CHKLEG10 IF EQUAL
          MATCH     MHDLSDAT,TRANDATE          * check start date
          GOTO      CHKLEG20 IF EQUAL
          GOTO      CHKLEG80 IF LESS
.
          GOTO      CHKLEG90
.
CHKLEG20  MATCH     SP70,TRANTIME
          GOTO      CHKLEG80 IF EQUAL
.
          MATCH     MHDLSTIM,TRANTIME
          GOTO      CHKLEG80 IF LESS
.
          GOTO      CHKLEG90
.
.         Record already exists for the date
.
CHKLEG80  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    ONE:
                    "</RETURN_VALUE>";
          GOTO      CHKLEG98
.
CHKLEG90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    ZERO:
                    "</RETURN_VALUE>";
          GOTO      CHKLEG98
.
CHKLEG98  CALL      XMLEND00
CHKLEG99  RETURN
+
.-------------------------------------------------------------
. Get Employer details from PMI or External Organisation table
.-------------------------------------------------------------
GETEMP00  CALL      XMLHED00
          BRANCH    EXIT,GETEMP99
.
.         External Agency details
.
          UNPACK    VALDCODE,KEY6
          UNPACK    SREFCODE,KEY1
          PACK      KEY7,KEY1,KEY6,SP70
          CALL      RDPTEOR1
          BRANCH    OVRCD,GETEMP93
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PTERNAME,"|",PTERADD1,"|",PTERADD2,"|":
                             PTERADD3,"|",PTERADD4,"|",PTERPOST,"|":
                             PTERTELP,"|",PTERCONT,"|":
                             "</RETURN_VALUE>"
          GOTO      GETEMP98
.
GETEMP93  BRANCH    VALDTYPE,GETTEMP94
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Organisation Code- ":
                              KEY6,"</RETURN_VALUE>"
          GOTO      GETEMP98
.
GETTEMP94 WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Employer Code- ":
                              KEY6,"</RETURN_VALUE>"
GETEMP98  CALL      XMLEND00
GETEMP99  RETURN
.
.-----------------------------------------------------------------------------.
. Patient level PRIMHD Transmission File Lists - Report 14
.-----------------------------------------------------------------------------.
PMPLL000  MOVE      ZERO,EXIT
....      RESET     UPDATETY
....      MATCH     SP70,UPDATETY
....      GOTO      PMPLL040 IF EQUAL
.
....      GOTO      PMPLL998
.
PMPLL040  CALL      CURPER00                * Display Routine
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.
          PACK      KEY8,URNUMBER,SP70      * Patient Referral Details
          CALL      RDMAST1
          IF        OVRCD=1
            CALL      CLPATMAS
          ENDIF
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MATCH     SP70,ADMISSNO
          IF        !@EQUAL
            PACK      KEY8,ADMISSNO,SP70      * Patient Referral Details
            CALL      RDVISA1
            IF        OVRCD=1
              CALL      CLPATVIS
            ENDIF
.
            CALL      RDALREF1
            IF        OVRCD=1
              CALL      CLALLREF
            ENDIF
.
          ELSE
            CALL      CLPATVIS
            CALL      CLALLREF
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "PRIMHD Transmissions",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,PMPLL999
          CALL      WEBBOD00   * Process Web Body (calls PROFLD00)
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      PMPLL999
.
.
PMPLL991  MOVE      "Invalid Patient U/R.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PMPLL999
.
PMPLL999  RETURN
.
.
.------------------------------------------------------------
. Get default Police details from External Organisation
.------------------------------------------------------------
GETPOR00  CALL      XMLHED00
          BRANCH    EXIT,GETPOR99
.
          OPEN      PATEORA1,"pateoraf"
          MOVE      "O",KEY1            * for Police
          IF        VALDTYPE=2
            MOVE      "C",KEY1          * for School
          ENDIF
          BRANCH    VALDTYPE,GETPOR20,GETPOR20
.
.         Get the first 'Police' origanisation type='O'
.
          PACK      KEY7,KEY1,SP70
          CALL      RSPTEOR1
          CALL      RKPTEOR1
          BRANCH    OVRCD,GETPOR98
          MATCH     KEY1,PTERTYPE
          GOTO      GETPOR98 IF NOT EQUAL
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PTERCODE:
                             "</RETURN_VALUE>"
          GOTO      GETPOR98
.
GETPOR20  PACK      KEY7,KEY1,VALDCODE
          CALL      RDPTEOR1
          BRANCH    OVRCD,GETPOR98
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PTERNAME,"|",PTERADD1,"|",PTERADD2,"|":
                             PTERADD3,"|",PTERADD4,"|",PTERPOST,"|":
                             PTERCONT,"|",PTERTELP:
                             "</RETURN_VALUE>"
          GOTO      GETPOR98
.
GETPOR98  CALL      XMLEND00
GETPOR99  RETURN
+
.
.------------------------------------------------------------
. Process Fields 
.------------------------------------------------------------
PROFLD00  BRANCH    REPORTNO,PROFLD10,PROFLD20,PROFLD30,PROFLD40,PROFLD50:
                             PROFLD60,PROFLD70,PROFLD80,PROFLD90,PROFLD99:
                             PROFLD99,PROFLD99,PROFLD99,PROFL140
.
          GOTO      PROFLD99 
.
PROFLD10  BRANCH    FLDSETNO,PROFLD11,PROFLD12,PROFLD13,PROFLD14,PROFLD15:
                             PROFLD16,PROFLD17,PROFLD18
          GOTO      PROFLD99
.
PROFLD11  CALL      MASF0000    * Master File Info
          GOTO      PROFLD99
.
PROFLD12  CALL      MISF0000    * Admission File Info
          GOTO      PROFLD99
.
PROFLD13  CALL      DSCF0000    * Discharge File Info
          GOTO      PROFLD99
.
PROFLD14  CALL      MHDI0000    * MH History Diagnosis Details
          GOTO      PROFLD99
.
PROFLD15  CALL      MHVS0000    * MH History Visit Details
          GOTO      PROFLD99
.
PROFLD16  CALL      MHDS0000    * MH History Discharge Details
          GOTO      PROFLD99
.
PROFLD17  CALL      MHDLS000    * MH Visit level Diagnosis list
          GOTO      PROFLD99
.
PROFLD18  CALL      DLVF0000    * Extra fields
          GOTO      PROFLD99
.
PROFLD20  BRANCH    FLDSETNO,PROFLD21         
          GOTO      PROFLD99
.
PROFLD21  CALL      SAXI0000    * Axis Search
          GOTO      PROFLD99
.
PROFLD30  CALL      MEHA0000    * Axis display         
          GOTO      PROFLD99
.
PROFLD40  BRANCH    FLDSETNO,PROFLD41,PROFLD42,PROFLD43,PROFLD44,PROFLD45
          GOTO      PROFLD99
.
PROFLD41  CALL      MASF0000    * Master File Info
          GOTO      PROFLD99
.
PROFLD42  CALL      MISF0000    * Admission file info
          GOTO      PROFLD99 
.
PROFLD43  CALL      VISF0000    * Visit file info
          GOTO      PROFLD99 
.
PROFLD44  CALL      MHVS0000    * MH History Visit Details
          GOTO      PROFLD99
.
PROFLD45  CALL      MHDS0000    * MH History Discharge Details
          GOTO      PROFLD99
.
PROFLD50  BRANCH    FLDSETNO,PROFLD51,PROFLD52,PROFLD53,PROFLD54,PROFLD55:
                             PROFLD56
          GOTO      PROFLD99
.
PROFLD51  CALL      MASF0000    * Master File Info
          GOTO      PROFLD99
.
PROFLD52  CALL      MISF0000    * Admission file info
          GOTO      PROFLD99
.
PROFLD53  CALL      VISF0000    * Visit file info
          GOTO      PROFLD99
.
PROFLD54  CALL      MHVS0000    * MH History Visit Details
          GOTO      PROFLD99
.
PROFLD55  CALL      MHDL0000    * MH History Discharge to leave Details
          GOTO      PROFLD99
.
PROFLD56  CALL      DLVF0000    * Extra fields 
          GOTO      PROFLD99
.
PROFLD60  BRANCH    FLDSETNO,PROFLD61,PROFLD62,PROFLD63,PROFLD64,PROFLD65
          GOTO      PROFLD99
.
PROFLD61  CALL      MASF0000    * Master File Info
          GOTO      PROFLD99
.
PROFLD62  CALL      MHLG0000    * Legal status fields
          GOTO      PROFLD99
.
PROFLD63  CALL      MHRV0000    * Legal status review history fields
          GOTO      PROFLD99
.
PROFLD64  CALL      LGLST000    * Legal Status History List 
          GOTO      PROFLD99
.
PROFLD65  CALL      RVLST000    * Legal status Review list
          GOTO      PROFLD99
.
PROFLD70  BRANCH    FLDSETNO,PROFLD71,PROFLD72,PROFLD73,PROFLD74
          GOTO      PROFLD99
.
PROFLD71  CALL      MASF0000    * Master File Info
          GOTO      PROFLD99
.
PROFLD72  CALL      MHLG0000    * Legal status fields
          GOTO      PROFLD99
.
PROFLD73  CALL      MHRV0000    * Legal status review history fields
          GOTO      PROFLD99
.
PROFLD74  CALL      REVW0000    * Last record of Review legal status
          GOTO      PROFLD99
.
PROFLD80  CALL      EXOR0000    * External Organisation 
          GOTO      PROFLD99
.
PROFLD90  BRANCH    FLDSETNO,PROFLD91,PROFLD92,PROFLD93,PROFLD94,PROFLD95:
                             PROFLD96,PROFLD97,PROFLD98,PROFL990
          GOTO      PROFLD99
.
PROFLD91  CALL      MASF0000    * Master File Info
          GOTO      PROFLD99
.
PROFLD92  CALL      HLSF0000    * Legal status header fields
          GOTO      PROFLD99
.
PROFLD93  CALL      DLSF0000    * Legal status detail fields
          GOTO      PROFLD99
.
PROFLD94  CALL      LSRF0000    * Legal status referral
          GOTO      PROFLD99
.
PROFLD95  CALL      REFC0000    * Referral comments/history
          GOTO      PROFLD99
.
PROFLD96  CALL      ALRE0000    * Allied health details
          GOTO      PROFLD99
.
PROFLD97  CALL      VISF0000    * Visit details
          GOTO      PROFLD99
.
PROFLD98  CALL      MHVS0000    * MH History Visit Details
          GOTO      PROFLD99
.
PROFL990  CALL      DLVF0000    * Extra fields 
          GOTO      PROFLD99
.
.                                     * PRIMHD Patient level lists
PROFL140  BRANCH    FLDSETNO,PROFL141,PROFL142,PROFL143
          GOTO      PROFLD99
.
PROFL141  CALL      MASF0000
          GOTO      PROFLD99
.
PROFL142  CALL      ALRE0000                * Patient Referral Details
          GOTO      PROFLD99
.
PROFL143  CALL      PMPL0000                * PRIMHD Patient level lists
          GOTO      PROFLD99
.
.
PROFLD99  RETURN
.
.------------------------------------------------------------
. Legal Status History List
.------------------------------------------------------------
LGLST000  MOVE      ZERO,FORM8
          PACK      KEY21,MHVIADMN,Z70
          CALL      RSMHLEG1
LGLST100  CALL      RPMHLEG1
          BRANCH    OVRCD,LGLST999          * no more data
.
          MATCH     MHVIADMN,MHLEADMN
          GOTO      LGLST999 IF NOT EQUAL   * different patient
.
. ------- display data -------
.
          MOVE      "No ",INFDESC
          MOVE      "No Legal Status",LEGDESC
          MATCH     SP3,MHLESTAT
          GOTO      LGLST110 IF EQUAL       * no code to display
.
          MOVE      "Unknown Code",LEGDESC
          PACK      KEY5,ANSL,ANSS,MHLESTAT,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MATCH     "I",TCINDC1
            IF        @EQUAL
              MOVE      "Yes",INFDESC         * informal
            ENDIF
            MOVE      TDESC,LEGDESC
          ENDIF
.
LGLST110  MOVE      SP3,VISTYPE
          MOVE      MHLEADMN,KEY8
          CALL      RDVISA1
          IF        OVRCD = 0
            LOAD      VISTYPE,PVITYPE,SP3,SP3,INPTYPE,SP3,SP3,CMHTYPE,SP3,SP3
          ENDIF
.
          MOVE      SP70,REVDESC
          MATCH     SP70,MHLEREVW
          GOTO      LGLST200 IF EQUAL
          MOVE      "Unknown code",TDESC
          PACK      KEY5,ANSL,ANSR,MHLEREVW,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,REVDESC
          ENDIF
.
LGLST200  
.         MOVE      ADOCTA,KEY6               * Search for doctor's full name
.         CALL      RDDOCT1                   * in doctor file
.         IF        OVRCD=1
.           MOVE      SP70,DOCFNAME           * If not found then output spaces
.         ELSE
.           CALL      DOCNAM00                * Format Doctor Name
.         ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:linkPatient('",HTMLLINK
          APPEND    URNUMBER,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    DMHVIADM,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    MHLEDATE,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    MHLETIME,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          BRANCH    FORM8,LGLST300
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",MHLEDATE,MHLETIME,"#",":
                             "#"",LEGDESC,"#",":
                             "#"",INFDESC,"#",":
                             "#"",REVDESC,"#",":
                             "#"",MHVITHER,"#",":
                             "#"",MHVILSRV,"#",":
                             "#"",VISTYPE,"#");"
          GOTO     LGLST400
.
LGLST300  MOVE      SP10,MHVILSRV
          MOVE      SP10,VISTYPE
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",MHLEDATE,MHLETIME,"#",":
                             "#"",LEGDESC,"#",":
                             "#"",INFDESC,"#",":
                             "#"",REVDESC,"#",":
                             "#"",MHVITHER,"#",":
                             "#"",MHVILSRV,"#",":
                             "#"",VISTYPE,"#");"
.
LGLST400  MOVE     ONE,FORM8
          GOTO     LGLST100
.
LGLST999  RETURN
+
.------------------------------------------------------------
. Legal Status Review History List
.------------------------------------------------------------
RVLST000  MOVE      ADMISSNO,MHVIADMN
          PACK      KEY21,MHVIADMN,SP70
          CALL      RSMHREV1
RVLST100  CALL      RKMHREV1
          BRANCH    OVRCD,RVLST999          * no more data
.
          MATCH     MHVIADMN,MHRVADMN
          GOTO      RVLST999 IF NOT EQUAL   * different patient
.
. ------- display data -------
.
          MOVE      "No ",KEY3
          IF        MHRVDECI=1
            MOVE      "Yes",KEY3            * review decision
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:linkPatient('",HTMLLINK
          APPEND    URNUMBER,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    DMHRVADM,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    MHRVDATE,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    MHRVTIME,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    MHRVDECI,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":
                             "#"",MHRVDATE,MHRVTIME,"#",":
                             "#"",KEY3,"#",":
                             "#"",MHRVNDAT,"#");"
          GOTO     RVLST100
.
RVLST999  RETURN
.
.------------------------------------------------------------
. Review Legal status
.------------------------------------------------------------
REVW0000  BRANCH    FLDITMNO,REVW0100,REVW0200,REVW0300
          GOTO      REVW9999
.
REVW0100  UNPACK    LEGSDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          MOVE      "Unknown Code",TDESC
          MATCH     SP3,MHLESTAT
          IF        !@EQUAL
            PACK      KEY5,ANSL,ANSS,MHLESTAT,SP70
            CALL      RDCODE1
          ELSE
            MOVE      "No Legal Status",TDESC
          ENDIF
          MATCH     SP10,LEGSDATE
          IF        @EQUAL
            WRITE     HTMLFILE;TDESC;
          ELSE
            WRITE     HTMLFILE;TDESC,ASOF,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          ENDIF
          GOTO      REVW9999
.
REVW0200  UNPACK    REVEDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          MOVE      "Unknown Code",TDESC
          MATCH     SP3,MHLEREVW
          IF        !@EQUAL
            PACK      KEY5,ANSL,ANSR,MHLEREVW,SP70
            CALL      RDCODE1
          ELSE
            MOVE      "No Review Status",TDESC
          ENDIF
          MATCH     SP10,REVEDATE
          IF        @EQUAL
            WRITE     HTMLFILE;TDESC;
          ELSE
            WRITE     HTMLFILE;TDESC,ASOF,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          ENDIF
          GOTO      REVW9999
.
REVW0300  UNPACK    MHRVDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          MATCH     SP10,MHRVDATE
          IF        !@EQUAL
            WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP5,AT,MHRVTIME;
          ENDIF
          GOTO      REVW9999
.
REVW9999  RETURN
+
.****************************************************************************
.*                              CURR0000                                    *
.*             Get date of current legal & review status                    *
.* Returns: REVEDATE  - Date of last change of review status                *
.*          LEGDATE   - Date of last change of legal status                 *
.****************************************************************************
.
CURR0000  MOVE      SP8,REVEDATE                 * initialise current dates
          MOVE      SP8,LEGSDATE
.
          MOVE      ZERO,LEGLFLAG                * initialise date set flags
          MOVE      ZERO,RVEWFLAG
.
.         Loop backward through the legal status file for the admission
.         number and get the date that the legal status and the 
.         review status were last altered.
.
          PACK      KEY21,AADMNO,Z70
          CALL      RSMHLEG1                     * position on last admn. record
CURR0500  CALL      RPMHLEG1                     * get previous record
          BRANCH    OVRCD,CURR9999               * eof - finished
.
          MATCH     AADMNO,MHLEADMN              * same admission still ?
          GOTO      CURR9999 IF NOT EQUAL        * no - finished
.
.         Prior to the addition of review status, all changes were for
.         Legal Status, so if the status field is blank, then assume
.         this was a legal status change.
.
          MOVE      MHLEFLAG,ANS
          REP       " 1L1R2B3N4",ANS             * set form field
          MOVE      ANS,FORM1
.
          COMPARE   FOUR,FORM1                   * did either status change ?
          GOTO      CURR0500 IF EQUAL            * no - ignore record
.
          BRANCH    LEGLFLAG,CURR1000            * legal status determined
.
.         Check if the legal status was changed in this record
.
          IF        FORM1 = 1 | FORM1 = 3
            MOVE      ONE,LEGLFLAG               * set legal status flag
            MOVE      MHLEDATE,LEGSDATE          * save legal status date
            IF        FORM1 = 3
              MOVE      MHLEDATE,REVEDATE        * set review status date
              GOTO      CURR9999                 * finished
            ENDIF
            BRANCH    RVEWFLAG,CURR9999          * finished
          ENDIF
.
          BRANCH    RVEWFLAG,CURR0500            * get next legal status record
.
.         Check if the review status was changed in this record
.
CURR1000  IF        FORM1 = 2 | FORM1 = 3
            MOVE      ONE,RVEWFLAG               * set review status flag
            MOVE      MHLEDATE,REVEDATE          * set review status date
            BRANCH    LEGLFLAG,CURR9999          * legal status determined
            IF        FORM1 = 3
              MOVE      MHLEDATE,LEGSDATE        * set legal status date
              GOTO      CURR9999                 * finished
            ENDIF
          ENDIF
.
          GOTO      CURR0500                     * get next legal status record
.
CURR9999  RETURN
+
.------------------------------------------------------------
. Miscellaneuos Details
.------------------------------------------------------------
DLVF0000  BRANCH    FLDITMNO,DLVF0100,DLVF0200,DLVF0300,DLVF0400,DLVF0500:
                             DLVF0600,DLVF0700,DLVF0800,DLVF0900,DLVF1000
          GOTO      DLVF9999
.
DLVF0100  WRITE     HTMLFILE;TRANDATE;
          GOTO      DLVF9999
.
DLVF0200  WRITE     HTMLFILE;TRANTIME;
          GOTO      DLVF9999
.
DLVF0300  WRITE     HTMLFILE;TWARD,SLASH,TBED;
          GOTO      DLVF9999
.
DLVF0400  MATCH     SP70,TWARD
          GOTO      DLVF9999 IF EQUAL
.
          PACK      KEY6,TWARD,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,DLVF9999
.
          WRITE     HTMLFILE;WBDESC;
          GOTO      DLVF9999
.
DLVF0500  MATCH     TRANDATE,SP70
          GOTO      DLVF9999 IF EQUAL
          UNPACK    TRANDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,AT,TTIME
          GOTO      DLVF9999
.
DLVF0600  MOVE      "TL",CATEGORY
          PACK      CODE,PTTRLTYP,SP70
          CALL      CODITM00
          GOTO      DLVF9999
.
DLVF0700  MATCH     OERDATE,SP70
          GOTO      DLVF9999 IF EQUAL
          UNPACK    OERDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          GOTO      DLVF9999
.
DLVF0800  WRITE     HTMLFILE;RINVREDI;
          GOTO      DLVF9999
.
DLVF0900  WRITE     HTMLFILE;INVADMNO;
          GOTO      DLVF9999
.
DLVF1000  CALL      CKPR0000
          GOTO      DLVF9999
.
DLVF9999  RETURN
+
.------------------------------------------------------------
.Axis Search Routine
.------------------------------------------------------------
SRHAXI00  MOVE      "Axis Search Engine",WEBTITLE
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,SRHAXI99
.
          CALL      WEBBOD00   * Process Web Body
.
          CALL      WEBEND00   * Process End of HTML File
.
SRHAXI99  RETURN
.
.------------------------------------------------------------
. Axis Search
.------------------------------------------------------------
SAXI0000  BRANCH    FLDITMNO,SAXI0100,SAXI0200,SAXI0300,SAXI0400,SAXI0500:
                             SAXI0600
          GOTO      SAXI9999
.
SAXI0100  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          WRITE     HTMLFILE;"mehweb01.pbl?reportno=02":
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&keywords=",KEYWORDS;
          GOTO      SAXI9999
.
SAXI0200  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM-NORECORD,F3
          IF        F3<0
            MOVE      ZERO,F3
          ENDIF
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          WRITE     HTMLFILE;"mehweb01.pbl?reportno=02":
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&keywords=",KEYWORDS;
          GOTO      SAXI9999
.
SAXI0300  MOVE      ZERO,LNK2PRT    * Link to alternate Program
          CALL      SPTNKA00
          GOTO      SAXI9999
.
SAXI0400  MOVE      ONE,LNK2PRT    * Link to Parent
          CALL      SPTNKA00
          GOTO      SAXI9999
.
SAXI0500  WRITE     HTMLFILE;SP10;
          GOTO      SAXI9999
.
SAXI0600  MOVE      TWO,LNK2PRT    * Link to Window
          CALL      SPTNKA00
          GOTO      SAXI9999
.
SAXI9999  RETURN
.
.------------------------------------------------------------
. Display Axis Results
.------------------------------------------------------------
.
SPTNKA00  WRITE     HTMLFILE;"<tr align=center>":
                             "<td class=HeadingCell colspan=4><b>":
                             "You Searched for ":
                               KEYWORDS,"</b></td>":
                             "</tr>":
                             "<tr>":
                             "<td class=HeadingCell><b>Axis Code</b></td>":
                             "<td class=HeadingCell><b>Description</b></td>":
                             "</tr>"
.
          CALL      GETWRD00       * This routine Splits the KEYWORDS field
.                                  * into KEYWRD01 to KEYWRD10 (IBAWEBCD)
.
          IF        LNK2PRT<>1
            UNPACK    DIM127,D1,LINKPRG,DIM127
            UNPACK    DIM127,D1,LINKREP,DIM127
            UNPACK    DIM127,D1,LINKTEM,DIM127
          ELSE
            UNPACK    DIM127,D1,SRCHTYPE,DIM127
          ENDIF
.
          IF        NORECORD=0
            MOVE      "10",NORECORD       * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          STRIP     KEYWRD01
          PACK      KEY25,KEYWRD01,SP70
          CALL      RSMHAKI2
SPTNKA10  CALL      RKMHAKI2
          BRANCH    OVRCD,SPTNKA90
.
          MATCH     SRCHTYPE,MHAKKTYP
          GOTO      SPTNKA10 IF NOT EQUAL
.
          PACK      KEY10,MHAKKTYP,MHAKKITM
          CALL      RDMHAXI1
          BRANCH    OVRCD,SPTNKA10
.
          MATCH     "1",MHAXSTAT            * Skip inactive
          GOTO      SPTNKA10 IF EQUAL
.
          CALL      SMHAKB00
          BRANCH    OVRCD,SPTNKA10,SPTNKA90
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      SPTNKA10
          ENDIF
.
          MATCH     SP70,MHAXDESC
          IF        @EQUAL
            MOVE      "&nbsp;",MHAXDESC
          ENDIF
.
          BRANCH    LNK2PRT,SPTNKA20,SPTNKA30
.
          WRITE     HTMLFILE;"<tr valign=top>":
                              "<td><a href=",LINKPRG,".pbl?":
                               "&reportno=",LINKREP:
                               "&template=",LINKTEM:
                               "&itemkeys=",KEY9,">":
                               MHAXCODE,"</a></td>":
                               "<td>",MHAXDESC,"</td>":
                             "</tr>"
.
          GOTO      SPTNKA80
.
SPTNKA20  WRITE     HTMLFILE;"<tr valign=top>":
                              "<td><a href=#"":
                              "javascript:updateParent('",MHAXDESC:
                              "','",MHAXCODE,"')#">":
                              "<img src=../images/MaintenanceIcon.gif hspace=4":
                              " border=0 align=absmiddle></a>":
                              MHAXCODE,"</td>":
                              "<td>",MHAXDESC,"</td>":
                             "</tr>"
.
          GOTO      SPTNKA80
.
SPTNKA30  WRITE     HTMLFILE;"<tr valign=top>":
                             "<td><a href='":
                             "javascript:showMbs01(#"":
                              LINKPRG,".pbl?":
                              "&reportno=",LINKREP:
                              "&template=",LINKTEM:
                              "&mbsitemn=",KEY9,"#");'>":
                              "<img src=../images/MaintenanceIcon.gif hspace=4":
                              " border=0 align=absmiddle></a>":
                              MHAXCODE,"</td>":
                              "<td>",MHAXDESC,"</td>":
                             "</tr>"
.
SPTNKA80  ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      SPTNKA10 IF NOT EQUAL
SPTNKA90
SPTNKA99  RETURN
.
.------------------------------------------------------------
. Check Axis Record
.------------------------------------------------------------
SMHAKB00  MATCH     KEYWRD01,MHAKKKWD
          GOTO      SMHAKB92 IF NOT EQUAL
          IF        KEYWRDNO>1
            PACK      SAVKEY25,MHAKKKWD,MHAKKTYP,MHAKKITM
            CALL      SMHAKC00
            BRANCH    EXIT,SMHAKB91
            MOVE      SAVKEY25,KEY25
            CALL      RDMHAKI2
          ENDIF
.
SMHAKB90  MOVE      ZERO,OVRCD
          GOTO      SMHAKB99
SMHAKB91  MOVE      ONE,OVRCD
          GOTO      SMHAKB99
SMHAKB92  MOVE      TWO,OVRCD
SMHAKB99  RETURN
.
.------------------------------------------------------------
. Check for Matching Axis Codes
.------------------------------------------------------------
SMHAKC00  MOVE      ONE,F2
          MOVE      ZERO,EXIT
          PACK      SAVKEY10,MHAKKTYP,MHAKKITM,SP70
.
SMHAKC10  COMPARE   KEYWRDNO,F2           * Loop through each Key Word in Search
          GOTO      SMHAKC99 IF EQUAL     * Exit OK
          ADD       ONE,F2
          LOAD      KEYWRDXX,F2,KEYWRD01,KEYWRD02,KEYWRD03,KEYWRD04,KEYWRD05:
                             KEYWRD06,KEYWRD07,KEYWRD08,KEYWRD09,KEYWRD10
          PACK      KEY25,MHAKKTYP,MHAKKITM,KEYWRDXX
          CALL      RDMHAKI1               * Check for Exact Match
          COMPARE   ZERO,OVRCD            * Ok so Continue Loop
          GOTO      SMHAKC10 IF EQUAL
.
          CALL      RKMHAKI1               * Not Exact so Read Next Record
          BRANCH    OVRCD,SMHAKC90        * No Match So Exit No Match
          PACK      KEY10,MHAKKTYP,MHAKKITM,SP70
          MATCH     SAVKEY10,KEY10         * Match Key Fields
          GOTO      SMHAKC90 IF NOT EQUAL * No Match So Exit
          STRIP     KEYWRDXX
          MATCH     MHAKKKWD,KEYWRDXX         * Check Key Word
          GOTO      SMHAKC90 IF NOT EQUAL * No Match So Exit
          GOTO      SMHAKC10              * Check Next Search Word
.
SMHAKC90  MOVE      ONE,EXIT
SMHAKC99  RETURN
.
.-----------------------------------------------------------
. Option 3 - Mental Health Axis codes
.-----------------------------------------------------------
MEHA0000  BRANCH    FLDITMNO,MEHA0100,MEHA0200,MEHA0300,MEHA0400,MEHA0500:
                    MEHA0600,MEHA0700,MEHA0800,MEHA0900
          WRITE     HTMLFILE;"Invalid Tag - MEHWEB01";
          GOTO      MEHA9999
.
MEHA0100  CALL      MHATB000     * Table of Axis Codes
          GOTO      MEHA9999
.
MEHA0200  CALL      NEXTPR00     * Link to Next Set of Codes
          GOTO      MEHA9999
.
MEHA0300  CALL      PREVPR00     * Link to Prev Set of Codes
          GOTO      MEHA9999
.
MEHA0400  CALL      MHTYPB00            * Axis Type
          GOTO      MEHA9999
.
MEHA0500  WRITE     HTMLFILE;MHAXCODE;  * Axis code
          GOTO      MEHA9999
.
MEHA0600  WRITE     HTMLFILE;MHAXDESC;  * Axis Description
          GOTO      MEHA9999
.
MEHA0700  WRITE     HTMLFILE;SRCHTYPE;  * Searched Axis Type
          GOTO      MEHA9999
.
MEHA0800  WRITE     HTMLFILE;MHAXSTAT;  * Axis Code Status
          GOTO      MEHA9999
.
MEHA0900  WRITE     HTMLFILE;FILTSTAT;  * Axis Code Status filter
          GOTO      MEHA9999
.
MEHA9999  RETURN
.
.------------------------------------------------------------
. Table of Axis 
.------------------------------------------------------------
MHATB000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          CALL      ONHED000      * Output Table Heading
.
          IF        NORECORD=0
            MOVE      PTCNNRTD,NORECORD      * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          CALL      GETWRD00       * This routine Splits the KEYWORDS field
.                                  * into KEYWRD01 to KEYWRD10 (IBAWEBCD)
.
          STRIP     KEYWRD01
          PACK      KEY25,KEYWRD01,SP70
          CALL      RSMHAKI2
MHATB100  CALL      RKMHAKI2
          BRANCH    OVRCD,MHATB900
.
          MATCH     SRCHTYPE,ALLTYPE  * All Axis types
          GOTO      MHATB200 IF EQUAL
.
          MATCH     SRCHTYPE,MHAKKTYP
          GOTO      MHATB100 IF NOT EQUAL
.
MHATB200  PACK      KEY10,MHAKKTYP,MHAKKITM
          CALL      RDMHAXI1
          BRANCH    OVRCD,MHATB100
.
          MATCH     "0",FILTSTAT            * Active
          IF        @EQUAL
            MATCH     "1",MHAXSTAT          * Skip inactive records
            GOTO      MHATB100 IF EQUAL
          ENDIF
.
          MATCH     "1",FILTSTAT            * Inactive
          IF        @EQUAL
            MATCH     "1",MHAXSTAT          * Skip active records
            GOTO      MHATB100 IF NOT EQUAL
          ENDIF
.
          CALL      SMHAKB00
          BRANCH    OVRCD,MHATB100,MHATB900
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      MHATB100
          ENDIF
.
          CALL      MHARW000      * Axis Table Details Row
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      MHATB100 IF NOT EQUAL
          GOTO      MHATB999
.
MHATB900  CALL      NOMORE00      * Display No More Records Message
.
MHATB999  RETURN
.------------------------------------------------------------
. Axis Table Details (TABLE HEADING)
.------------------------------------------------------------
ONHED000  WRITE     HTMLFILE;"<tr align=center>":
                             "<td class=HeadingCell colspan=5><b>":
                             "You Searched for ":
                               KEYWORDS,"</b></td>":
                             "</tr>":
                             "<tr>":
                               "<td class=HeadingCell width=18%>":
                               "Code</td>":
                               "<td class=HeadingCell width=15%>":
                               "Type</td>":
                               "<td class=HeadingCell width=35%>":
                               "Description</td>":
                               "<td class=HeadingCell width=15%>":
                               "Active</td>":
                             "</tr>"
.
ONHED999  RETURN
.------------------------------------------------------------
. Axis Table (TABLE ROW)
.------------------------------------------------------------
MHARW000  MATCH     AXI1TYPE,DMHAXTYP
          IF        @EQUAL
            MOVE      "Axis I",KEY8
          ELSE 
            MATCH     AXI2TYPE,DMHAXTYP
            IF        @EQUAL
              MOVE      "Axis II",KEY8
            ELSE 
              MATCH     AXI3TYPE,DMHAXTYP
              IF        @EQUAL
                MOVE      "Axis III",KEY8
              ELSE
                MOVE      "Unknown",KEY8
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     "1",MHAXSTAT
          IF        @EQUAL
            MOVE      "No ",KEY3
          ELSE
            MOVE      "Yes",KEY3
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td nowrap><A HREF='javascript:ShowDetail03":
                             "(#"",LINKPRG,"#.pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&srchtype=",SRCHTYPE:
                             "&mehax001=",MHAXTYPE:
                             "&mehax002=",MHAXCODE,"#")'>":
                             "<img src=../images/MaintenanceIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             MHAXCODE,"</td><td>",KEY8,"</td>":
                             "<td>",MHAXDESC,"</td>":
                             "<td>",KEY3,"</td>":
                             "</tr>"
.
MHARW999 RETURN

.-----------------------------------------------------------
. Link to Next Group Codes
.-----------------------------------------------------------
NEXTPR00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
          REP       "'~",KEYWORDS
          REP       " +",ORGNTYPE
          REP       " +",FILTSTAT
.
          WRITE     HTMLFILE;"mehweb01.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&keywords=",KEYWORDS:
                                 "&srchtype=",SRCHTYPE:
                                 "&orgntype=",ORGNTYPE:
                                 "&filtstat=",FILTSTAT;
.
          REP       "~'",KEYWORDS
          REP       "+ ",ORGNTYPE
          REP       "+ ",FILTSTAT
.
NEXTPR99  RETURN
.-----------------------------------------------------------
. Link to Prev Group Codes
.-----------------------------------------------------------
PREVPR00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM-NORECORD,F3
          IF        F3<0
            MOVE      ZERO,F3
          ENDIF
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F1
          REP       "'~",KEYWORDS
          REP       " +",ORGNTYPE
          REP       " +",FILTSTAT
.
          WRITE     HTMLFILE;"mehweb01.pbl":
                                 "?reportno=",F1:
                                 "&template=",FLDPARA:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&keywords=",KEYWORDS:
                                 "&srchtype=",SRCHTYPE:
                                 "&orgntype=",ORGNTYPE:
                                 "&filtstat=",FILTSTAT;
.
          REP       "~'",KEYWORDS
          REP       "+ ",ORGNTYPE
          REP       "+ ",FILTSTAT
.
PREVPR99  RETURN
.
.-----------------------------------------------------------
. Build Axis type selection list
.-----------------------------------------------------------
MHTYPB00  MOVE      ZERO,F1
          UNPACK    DIM127,D1,D1,DIM127
          MOVE      D1,F1
          BRANCH    F1,MHTYPB10,MHTYPB20
          GOTO      MHTYPB99
.
MHTYPB10  WRITE     HTMLFILE;MHAXTYPE;  * Axis Type
          GOTO      MHTYPB99
.
MHTYPB20  MATCH     DMHAXTYP,AXI1TYPE    * Axis I Type
          IF        @EQUAL
            WRITE     HTMLFILE;"Axis I";  
          ELSE
            MATCH     DMHAXTYP,AXI2TYPE    * Axis II Type
            IF        @EQUAL
              WRITE     HTMLFILE;"Axis II";  
            ELSE
              MATCH     DMHAXTYP,AXI3TYPE  * Axis III Type
              IF        @EQUAL
                WRITE     HTMLFILE;"Axis III";  
              ENDIF
            ENDIF
          ENDIF
          GOTO      MHTYPB99
.
MHTYPB99  RETURN
+
.-----------------------------------------------------------
. Option 8 - External Organistaion
.-----------------------------------------------------------
EXOR0000  BRANCH    FLDITMNO,EXOR0100,EXOR0200,EXOR0300,EXOR0400,EXOR0500:
                             EXOR0600,EXOR0700,EXOR0800,EXOR0900,EXOR1000:
                             EXOR1100,EXOR1200,EXOR1300,EXOR1400,EXOR1500:
                             EXOR1600,EXOR1700,EXOR1800,EXOR1900,EXOR2000
          WRITE     HTMLFILE;"Invalid Tag - MEHWEB01";
          GOTO      EXOR9999
.
EXOR0100  MOVE      ZERO,F1
          UNPACK    DIM127,D1,D1,DIM127
          MOVE      D1,F1
          BRANCH    F1,EXOR0110,EXOR0120
          GOTO      EXOR9999
.
EXOR0110  WRITE     HTMLFILE;PTERTYPE;
          GOTO      EXOR9999
.
EXOR0120  MOVE      SP70,KEY30
          CALL      GTYP0000            * Get organisation type
          WRITE     HTMLFILE;KEY30;     * Type
          GOTO      EXOR9999
.
EXOR0200  WRITE     HTMLFILE;PTERCODE;  * Code
          GOTO      EXOR9999
.
EXOR0300  WRITE     HTMLFILE;PTERNAME;  * Name
          GOTO      EXOR9999
.
EXOR0400  WRITE     HTMLFILE;PTERADD1;  * Address
          GOTO      EXOR9999
.
EXOR0500  WRITE     HTMLFILE;PTERADD2;  * Address
          GOTO      EXOR9999
.
EXOR0600  WRITE     HTMLFILE;PTERADD3;  * Address
          GOTO      EXOR9999
.
EXOR0700  WRITE     HTMLFILE;PTERADD4;  * Address
          GOTO      EXOR9999
.
EXOR0800  WRITE     HTMLFILE;PTERPOST;  * Postcode
          GOTO      EXOR9999
.
EXOR0900  WRITE     HTMLFILE;PTERTELP;  * Telephone number
          GOTO      EXOR9999
.
EXOR1000  WRITE     HTMLFILE;PTERCONT;  * Contact Name
          GOTO      EXOR9999
.
EXOR1100  WRITE     HTMLFILE;PTERSTAT;  * Active/Inactive
          GOTO      EXOR9999
.
EXOR1200  CALL      EORTB000            * External Organisation table
          GOTO      EXOR9999
.
EXOR1300  CALL      NEXTPR00            * Link to Next Set of Codes
          GOTO      EXOR9999
.
EXOR1400  CALL      PREVPR00            * Link to Prev Set of Codes
          GOTO      EXOR9999
.
EXOR1500  WRITE     HTMLFILE;ORGNTYPE;  * Filter Organisation Type 
          GOTO      EXOR9999
.
EXOR1600  MOVE      "EE",CATEGORY       * Organisation Sector
          PACK      CODE,PTERSECT,SP3
          CALL      CODITM00
          GOTO      EXOR9999
.
EXOR1700  MOVE      "EF",CATEGORY       * Organisation District/Region
          PACK      CODE,PTERREGN,SP3
          CALL      CODITM00
          GOTO      EXOR9999
.
EXOR1800  MOVE      "EI",CATEGORY       * Organisation Unit (Business) Type
          PACK      CODE,PTERUTYP,SP3
          CALL      CODITM00
          GOTO      EXOR9999
.
EXOR1900  MOVE      ZERO,LNK2PRT        * Link to initial Program
          MATCH     "E",ORGNTYPE
          IF        @EQUAL
            MOVE      TWO,LNK2PRT       * Employer Organisation type
          ENDIF
          CALL      EORSR000            * Table of Transfer Source Codes
          GOTO      EXOR9999            * List by Code
.
EXOR2000  MOVE      ONE,LNK2PRT         * Link to alternate Program
          CALL      EORSR000            * Table of Transfer Source Codes
          GOTO      EXOR9999            * List by Code
.
EXOR9999  RETURN
.
.------------------------------------------------------------
.         Get organisation type
.------------------------------------------------------------
GTYP0000  MATCH     "A",PTERTYPE
          IF        @EQUAL
            MOVE      "External Agencies",KEY30
          ENDIF
          MATCH     "L",PTERTYPE
          IF        @EQUAL
            MOVE      "Lawyers",KEY30
          ENDIF
          MATCH     "C",PTERTYPE
          IF        @EQUAL
            MOVE      "Schools",KEY30
          ENDIF
          MATCH     "P",PTERTYPE
          IF        @EQUAL
            MOVE      "Private Hospitals",KEY30
          ENDIF
          MATCH     "I",PTERTYPE
          IF        @EQUAL
            MOVE      "Indigenous Organisation",KEY30
          ENDIF
          MATCH     "B",PTERTYPE
          IF        @EQUAL
            MOVE      "Public Hospitals",KEY30
          ENDIF
          MATCH     "D",PTERTYPE
          IF        @EQUAL
            MOVE      "Residential Institute",KEY30
          ENDIF
          MATCH     "J",PTERTYPE
          IF        @EQUAL
            MOVE      "Justice Department",KEY30
          ENDIF
          MATCH     "O",PTERTYPE
          IF        @EQUAL
            MOVE      "Police            ",KEY30
          ENDIF
          MATCH     "E",PTERTYPE
          IF        @EQUAL
            MOVE      "Employer          ",KEY30
          ENDIF
GTYP9999  RETURN
+
.------------------------------------------------------------
.         Table of External Organisations
.------------------------------------------------------------
EORTB000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          CALL      EORHD000      * Output Table Heading
.
          IF        NORECORD=0
            MOVE      PTCNNRTD,NORECORD      * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          PACK      KEY7,STARTKEY,SP70
          CALL      RSPTEOR2                          * 
EORTB100  CALL      RKPTEOR2
          BRANCH    OVRCD,EORTB900
.                                                                     *I-152286
          PACK      KEY1,ORGNTYPE,SP1
          MATCH     SP1,KEY1
          GOTO      EORTB200 IF EQUAL
          MATCH     ORGNTYPE,PTERTYPE
          GOTO      EORTB100 IF NOT EQUAL
.
EORTB200  ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      EORTB100
          ENDIF
.
          CALL      EORRW000      * Display External Organisations Details Row
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      EORTB100 IF NOT EQUAL
          GOTO      EORTB999
.
EORTB900  CALL      NOMORE00      * Display No More Records Message
.
EORTB999  RETURN
.------------------------------------------------------------
. Operating Room Table Details (TABLE HEADING)
.------------------------------------------------------------
EORHD000  WRITE     HTMLFILE;"<tr>":
                               "<td class=HeadingCell width=8%>":
                               "Code</td>":
                               "<td class=HeadingCell width=22%>":
                               "Name of Organisation</td>":
                               "<td class=HeadingCell width=10%>":
                               "Org. Type</td>":
                               "<td class=HeadingCell width=25%>":
                               "Address</td>":
                               "<td class=HeadingCell width=15%>":
                               "Sector</td>":
                               "<td class=HeadingCell width=15%>":
                               "Region</td>":
                               "<td class=HeadingCell width=5%>":
                               "Status</td>":
                             "</tr>"
EORHD999  RETURN
.------------------------------------------------------------
. Organisation Table (TABLE ROW)
.------------------------------------------------------------
EORRW000  MOVE      "Active",KEY8
          MATCH     "1",PTERSTAT
          IF        @EQUAL
            MOVE      "Inactive",KEY8
          ENDIF
.
          MOVE      SP70,KEY30                           
          CALL      GTYP0000
.                                                                     *I-152286
          UNPACK    SP70,DIM30A,DIM30B
          MATCH     SP3,PTERSECT
          IF        !@EQUAL
            UNPACK    SP70,TDESC
            PACK      KEY5,CATEE,PTERSECT,SP5
            CALL      RDCODE1
            PACK      DIM30A,TDESC,SP30
          ENDIF
          MATCH     SP3,PTERREGN
          IF        !@EQUAL
            UNPACK    SP70,TDESC
            PACK      KEY5,CATEF,PTERREGN,SP5
            CALL      RDCODE1
            PACK      DIM30B,TDESC,SP30
          ENDIF
.
          REP       "' , ",PTERADD1
          STRIP     PTERADD1
          STRIP     PTERADD2
          STRIP     PTERADD3
          STRIP     PTERPOST
          PACK      DIM60A,PTERADD1,SP2,PTERADD2,SP2,PTERADD3,SP2,PTERPOST
.
          WRITE     HTMLFILE;"<tr><td nowrap><A HREF='javascript:ShowDetail08":
                             "(#"",LINKPRG,"#.pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&mehor001=",PTERTYPE:
                             "&mehor002=",PTERCODE,"#")'>":
                             "<img src=../images/MaintenanceIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             PTERCODE,"</td>":
                             "<td>&nbsp;",PTERNAME,"</td>":
                             "<td>&nbsp;",KEY30,"</td>":
                             "<td>&nbsp;",DIM60A,"</td>":
                             "<td>&nbsp;",DIM30A,"</td>":
                             "<td>&nbsp;",DIM30B,"</td>":
                             "<td>",KEY8,"</td>":
                             "</tr>"
.
EORRW999 RETURN
+
.------------------------------------------------------------
.         External Organisation Search by Keyword List
.------------------------------------------------------------
EORSR000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          CALL      EOSHD000      * Output Table Heading
.
          IF        NORECORD=0
            MOVE      "13",NORECORD       * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          PACK      KEY22,ORGNTYPE,STARTKEY,SP30
          CALL      RSPTKEO3
          IF        OVRCD=0
            CALL      RPPTKEO3
          ENDIF 
EORSR100  CALL      RKPTKEO3
          BRANCH    OVRCD,EORSR999
.
          PACK      KEY7,ORGNTYPE,PTKOCODE
          CALL      RDPTEOR1
          BRANCH    OVRCD,EORSR100
          MATCH     STARTKEY,PTKOKWRD
          GOTO      EORSR999 IF NOT EQUAL
.         
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      EORSR100
          ENDIF
.
          CALL      EOSRW000      * Display External Organisations Details Row
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      EORSR100 IF NOT EQUAL
.
EORSR999  RETURN
.
.------------------------------------------------------------
. External Organisation Search Table Headings
.------------------------------------------------------------
EOSHD000  MOVE      ORGNTYPE,DIM1A
          REP       "A1B2C3D4I5J6L7P8E9",DIM1A
          MOVE      DIM1A,F1
          LOAD      DIM30A,F1,EXAG,PUHO,SCHL,RESI,INOR,JUDE,LAWS,PRHO,EMPL
          PACK      DIM60A,EXOR,DIM30A,SP30
.
          COMPARE   TWO,LNK2PRT       * Employer Organisation type
          GOTO      EOSHD100 IF EQUAL
.
          WRITE     HTMLFILE;"<tr>":
                               "<td class=HeadingCell width=8%>":
                               "Code</td>":
                               "<td class=HeadingCell width=30%>":
                               "Name of Organisation</td>":
                               "<td class=HeadingCell width=10%>":
                               "Type</td>":
                               "<td class=HeadingCell width=30%>":    
                               "Address</td>":
                               "<td class=HeadingCell width=17%>":
                               "Region</td>":
                               "<td class=HeadingCell width=5%>":
                               "Status</td>":
                             "</tr>"
          GOTO      EOSHD999
.
EOSHD100  WRITE     HTMLFILE;"<tr>":
                               "<td class=HeadingCell width=8%>":
                               "Code</td>":
                               "<td class=HeadingCell width=30%>":
                               "Name of Organisation</td>":
                               "<td class=HeadingCell width=30%>":    
                               "Address</td>":
                               "<td class=HeadingCell width=17%>":
                               "Phone</td>":
                               "<td class=HeadingCell width=5%>":
                               "Contact</td>":
                               "<td class=HeadingCell width=5%>":
                               "Status</td>":
                             "</tr>"
          GOTO      EOSHD999
.
EOSHD999  RETURN
.
.------------------------------------------------------------
. Organisation Table Search (TABLE ROW)
.------------------------------------------------------------
EOSRW000  MOVE      "Active",KEY8
          MATCH     "1",PTERSTAT
          IF        @EQUAL
            MOVE      "Inactive",KEY8
          ENDIF     
.
          UNPACK    SP70,KEY15,TDESC
          MATCH     SP70,PTERUTYP
          IF        !@EQUAL
            PACK      KEY5,CATEI,PTERUTYP,SP5
            CALL      RDCODE1
            MOVE      TDESC,KEY15
          ENDIF
.
          UNPACK    SP70,DIM30A,DIM30B,TDESC
          MATCH     SP3,PTERREGN
          IF        !@EQUAL
            PACK      KEY5,CATEF,PTERREGN,SP5
            CALL      RDCODE1
            PACK      DIM30B,TDESC,SP30
          ENDIF
.
          BRANCH    LNK2PRT,EOSRW100,EOSRW200
.
EOSRW100  REP       "' , ",PTERADD1
          STRIP     PTERADD1
          STRIP     PTERADD2
          STRIP     PTERADD3
          STRIP     PTERPOST
          PACK      DIM60A,PTERADD1,SP2,PTERADD2,SP2,PTERADD3,SP2,PTERPOST
.
          MOVE      "Phone ",DIM10A
          MOVE      "Reg. - ",DIM10B
          PACK      DIM60B,DIM10A,PTERTELP,SP2,DIM10B,DIM30B
.
          WRITE     HTMLFILE;"<tr><td nowrap><a href='javascript:updateParent":
                             "(#"",PTERCODE,"#",#"",PTERNAME,"#",#"":
                             PTERTYPE,"#",#"",DIM60A,"#",#"",DIM60B,"#")'>":
                             "<img src=../images/MaintenanceIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             PTERCODE,"</td>":
                             "<td>&nbsp;",PTERNAME,"</td>":
                             "<td>&nbsp;",KEY15,"</td>":
                             "<td>&nbsp;",DIM60A,"</td>":
                             "<td>&nbsp;",DIM30B,"</td>":
                             "<td>",KEY8,"</td>":
                             "</tr>"
          GOTO      EOSRW999
.
EOSRW200  WRITE    HTMLFILE;"<tr><td nowrap><a href='javascript:updateParent01":
                             "(#"",PTERCODE,"#",#"",PTERNAME,"#",#"":
                             PTERTYPE,"#",#"",PTERADD1,"#",#"",PTERADD2,"#",#"":
                             PTERADD3,"#",#"",PTERADD4,"#",#"",PTERPOST,"#",#"":
                             PTERTELP,"#",#"",PTERCONT,"#")'>":
                             "<img src=../images/MaintenanceIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>";
.
          REP       "' , ",PTERADD1
          STRIP     PTERADD1
          STRIP     PTERADD2
          STRIP     PTERADD3
          STRIP     PTERPOST
          PACK      DIM60A,PTERADD1,SP2,PTERADD2,SP2,PTERADD3,SP2,PTERPOST
.
          WRITE     HTMLFILE;PTERCODE,"</td>":
                             "<td>&nbsp;",PTERNAME,"</td>":
                             "<td>&nbsp;",DIM60A,"</td>":
                             "<td>&nbsp;",PTERTELP,"</td>":
                             "<td>&nbsp;",PTERCONT,"</td>":
                             "<td>",KEY8,"</td>":
                             "</tr>"
          GOTO      EOSRW999
.
EOSRW999 RETURN
+
.------------------------------------------------------------
.         Legal status referral
.------------------------------------------------------------
LSRF0000  BRANCH    FLDITMNO,LSRF0100,LSRF0200,LSRF0300,LSRF0400,LSRF0500:
                             LSRF0600,LSRF0700,LSRF0800,LSRF0900,LSRF1000:
                             LSRF1100,LSRF1200,LSRF1300,LSRF1400,LSRF1500:
                             LSRF1600,LSRF1700,LSRF1800,LSRF1900,LSRF2000:
                             LSRF2100,LSRF2200,LSRF2300,LSRF2400,LSRF2500:
                             LSRF2600,LSRF2700,LSRF2800,LSRF2900,LSRF3000:
                             LSRF3100,LSRF3200,LSRF3300,LSRF3400,LSRF3500:
                             LSRF3600,LSRF3700,LSRF3800
          WRITE     HTMLFILE;"Invalid Tag - MEHWEB01";
          GOTO      LSRF9999
.
LSRF0100  CALL      RLIS0000                * Referral list
          GOTO      LSRF9999
.
LSRF0200  CALL      DLIS0000                * Referral details list
          GOTO      LSRF9999
.
LSRF0300  WRITE     HTMLFILE;MHDLSDAT;
          GOTO      LSRF9999
.
LSRF0400  MOVE      "PO",CATEGORY
          PACK      CODE,MHDLPOCC,SP70      * Review location/
          CALL      POCSEL00                * Place of occurence selection
          GOTO      LSRF9999
.
LSRF0500  CALL      DEFC0000
          MOVE      "LS",CATEGORY
          MOVE      KEY3,CODE
          CALL      CODITM00
          GOTO      LSRF9999
.
LSRF0600  CALL      DEFC0000
          WRITE     HTMLFILE;KEY3;
          GOTO      LSRF9999
.
LSRF0700  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      LSRF9999
.
LSRF0800  CALL      NEXT0000
          GOTO      LSRF9999
.
LSRF0900  CALL      PREV0000
          GOTO      LSRF9999
.
LSRF1000  CALL      CURSTD00
          GOTO      LSRF9999
.
LSRF1100  CALL      CUREND00
          GOTO      LSRF9999
.
LSRF1200  CALL      CURYR000
          GOTO      LSRF9999
.
LSRF1300  CALL      CURMON00
          GOTO      LSRF9999
.
LSRF1400  CALL      SELV0000
          GOTO      LSRF9999
.
LSRF1500  CALL      RMLS0000          * Review Reminder
          GOTO      LSRF9999
.
LSRF1600  WRITE     HTMLFILE;SECTCODE;
          GOTO      LSRF9999
.
LSRF1700  WRITE     HTMLFILE;REVSTATS;
          GOTO      LSRF9999
.
LSRF1800  MOVE      "LS",CATEGORY
          MOVE      SECTCODE,CODE
          CALL      CODITM00
          GOTO      LSRF9999
.
LSRF1900  MOVE      "LR",CATEGORY
          MOVE      REVSTATS,CODE
          CALL      CODITM00    
          GOTO      LSRF9999
.         
LSRF2000  CALL      PEDAT000
          GOTO      LSRF9999
.
LSRF2100  WRITE     HTMLFILE;OPENDATE;
          GOTO      LSRF9999
.
LSRF2200  WRITE     HTMLFILE;OPENTIME;
          GOTO      LSRF9999
.
LSRF2300  UNPACK    DIM127,D1,KEY1,DIM127
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,LSRF2310
          PACK      KEY10,PMPXRHC1,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,LSRF9999
          MOVE      PMHCTITL,FMTTITLE
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000
          WRITE     HTMLFILE;DOCFNAME;
          GOTO      LSRF9999
.
LSRF2310  WRITE     HTMLFILE;PMPXRHC1;
          GOTO      LSRF9999
.
LSRF2400  CALL      CDSLLS00 
          GOTO      LSRF9999 
.
LSRF2500  CALL      MHLS0000                * Referral details list for WA
          GOTO      LSRF9999
.
LSRF2600  CALL      OMHR0000                * Find an open MH Referral
          GOTO      LSRF9999
.
LSRF2700  PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          IF        OVRCD=0 
            UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          ENDIF
          GOTO      LSRF9999
.
LSRF2800  PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          IF        OVRCD=0
            WRITE     HTMLFILE;ATIME;
          ENDIF
          GOTO      LSRF9999
.
LSRF2900  MOVE      ONE,FORM1
          CALL      DLSDOC00
          GOTO      LSRF9999
.
LSRF3000  MOVE      TWO,FORM1
          CALL      DLSDOC00
          GOTO      LSRF9999
.
LSRF3100  MOVE      THREE,FORM1
          CALL      DLSDOC00
          GOTO      LSRF9999
.
LSRF3200  PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          IF        OVRCD=0
            WRITE     HTMLFILE;DASTAT;
          ENDIF 
          GOTO      LSRF9999
.
LSRF3300  WRITE     HTMLFILE;MHCNPHED;     * Using PRIMHD extract?
          GOTO      LSRF9999
.
LSRF3400  CALL      LSID0000
          WRITE     HTMLFILE;LSID;
          GOTO      LSRF9999
.
LSRF3500  CALL      CDSLLD00
          GOTO      LSRF9999
.
LSRF3600  WRITE     HTMLFILE;ACTIVFLG;     * Flag to include/exclude blank 
          GOTO      LSRF9999               * Reminder date
.
LSRF3700  WRITE     HTMLFILE;REVHRDHB;
          GOTO      LSRF9999
.
LSRF3800  MOVE      "1",SHOWSTAT            * Show MH Status
          CALL      RLIS0000                * Referral list
          MOVE      "0",SHOWSTAT
          GOTO      LSRF9999
.
LSRF9999  RETURN
+
.------------------------------------------------------------
.         Populating Legal Status ID
.------------------------------------------------------------
LSID0000  UNPACK    MHDLSDAT,XCENT,XYEAR,XMON,XDAY
          UNPACK    MHDLSTIM,CALHH,DIM1A,CALMM,DIM1A,CALSS
.
          PACK      LSID,MHDLUNIQ,XYEAR,XMON,XDAY,CALHH,CALMM,CALSS,SP20
          REP       " 0",LSID
.
LSID9999  RETURN
+
.------------------------------------------------------------
.         Previous Referral end date         
.------------------------------------------------------------
PEDAT000  UNPACK    DIM127,DIM1,KEY1,DIM127
          MOVE      KEY1,F1
          BRANCH    F1,PEDAT100,PEDAT100,PEDAT100
          WRITE     HTMLFILE;MHHLEDAT;
          GOTO      PEDAT999
.
PEDAT100  PACK      KEY16,URNUMBER,Z70
          CALL      RSMHHLS1
PEDAT200  CALL      RPMHHLS1
          BRANCH    OVRCD,PEDAT900
          MATCH     MHHLURNO,URNUMBER
          GOTO      PEDAT900 IF NOT EQUAL
.
          MATCH     "1",MHHLSTAT                 * Inactive?
          GOTO      PEDAT200 IF EQUAL            * yes, ignore
.
          IF        F3=1
            MATCH     SP70,MHHLEDAT
            IF        @EQUAL
              WRITE     HTMLFILE;ONE;            * Yes an open legal status
              GOTO      PEDAT900                 * record exists
            ENDIF
            GOTO      PEDAT200
          ENDIF
.
          MATCH     SP70,MHHLEDAT
          IF        @EQUAL
            MOVE      "99999999",MHHLEDAT        * Referral with no End date
            MOVE      "99:99:99",MHHLETIM
          ENDIF
.
          MATCH     SP70,MHHLETIM
          IF        @EQUAL
            MOVE      "99:99:99",MHHLETIM
          ENDIF
.
          IF        F1=1
            UNPACK    MHHLEDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ELSE
            WRITE     HTMLFILE;MHHLETIM;
          ENDIF
.
PEDAT900  CALL      CLRHLS00                * clear fields
PEDAT999  RETURN
+
.------------------------------------------------------------
. Previous Day, Week, Month
.------------------------------------------------------------
. Next Day, Week, Month
.------------------------------------------------------------
NEXT0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
          WRITE     HTMLFILE;"mehweb01.pbl":
                             "?reportno=",KEY2:
                             "&template=",KEY3:
                             "&frstdate=",NXTFDATE:
                             "&lastdate=",NXTLDATE:
                             "&viewtype=",VIEWTYPE:
                             "&sectcode=",SECTCODE:
                             "&revstats=",REVSTATS:
                             "&revhrdhb=",REVHRDHB:
                             "&activflg=",ACTIVFLG;
NEXT9999  RETURN
.------------------------------------------------------------
. Previous Day, Week, Month
.------------------------------------------------------------
PREV0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
          WRITE     HTMLFILE;"mehweb01.pbl":
                             "?reportno=",KEY2:
                             "&template=",KEY3:
                             "&frstdate=",PREFDATE:
                             "&lastdate=",PRELDATE:
                             "&viewtype=",VIEWTYPE:
                             "&sectcode=",SECTCODE:
                             "&revstats=",REVSTATS:
                             "&revhrdhb=",REVHRDHB:
                             "&activflg=",ACTIVFLG;
PREV9999  RETURN
+
.------------------------------------------------------------
.         Get default section code
.------------------------------------------------------------
DEFC0000  MOVE      ZERO,EXIT
          MOVE      SP70,MHDLSCOD
          MOVE      ZERO,FORM1
          PACK      KEY32,URNUMBER,Z70
          CALL      RSMHDLS1
DEFC1000  CALL      RPMHDLS1
          BRANCH    OVRCD,DEFC9000
          MATCH     URNUMBER,MHDLURNO
          GOTO      DEFC9000 IF NOT EQUAL   * no previous Legal status
.
.         Check if it's active
.
          PACK      KEY16,URNUMBER,MHDLUNIQ,SP70
          CALL      RDMHHLS1
          BRANCH    OVRCD,DEFC1000
          MATCH     "1",MHHLSTAT
          GOTO      DEFC1000 IF EQUAL       * Inactive
          MOVE      SP70,KEY3
          GOTO      DEFC9200                * found previous active legal status
.
DEFC9000  MOVE      MHCNSINP,KEY3           * Default from system parameter
DEFC9200  CALL      CLRHLS00                * clear fields
          CALL      CLRDLS00                * clear fields
          MOVE      ONE,EXIT                * no previous active LS
DEFC9999  RETURN
+
.------------------------------------------------------------
.         Legal status Referral list
.------------------------------------------------------------
RLIS0000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          MOVE      ZERO,COUNTER
          PACK      KEY16,URNUMBER,Z70
          CALL      RSMHHLS1
RLIS1000  CALL      RPMHHLS1
          BRANCH    OVRCD,RLIS9999
          MATCH     MHHLURNO,URNUMBER
          GOTO      RLIS9999 IF NOT EQUAL
.
          MATCH     "1",SHOWSTAT
          IF        !@EQUAL
            MATCH     "1",MHHLSTAT                 * Inactive?
            GOTO      RLIS1000 IF EQUAL            * yes, ignore
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:",HTMLLINK
          APPEND    "ReferralLink('",HTMLLINK
          APPEND    MHHLUNIQ,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          MOVE      "S ",CATEGORY
          MOVE      MHHLSREF,CODE                * To get Source ref.Desc
          CALL      GETCOD00
.
          PACK      KEY7,ANSL,MHHLLAWY,SP70
          CALL      RDPTEOR1
          IF        OVRCD=1
            MOVE      SP70,PTERNAME
          ENDIF
.
          ADD       ONE,COUNTER
          IF        COUNTER>200
             WRITE    HTMLFILE;"alert(#"Table exceeds 200 records. Records ":
                                     "beyond 200 will not be displayed#");";
             GOTO    RLIS9999
          ENDIF
.
          MOVE      "No  ",KEY4
          MATCH     "1",MHHLPRIS
          IF        @EQUAL
            MOVE      "Yes ",KEY4
          ENDIF
.
          MOVE      "No ",KEY3
          MATCH     "1",MHHLCURR
          IF        @EQUAL
            MOVE      "Yes",KEY3
          ENDIF
.
          PACK      KEY10,MHHLCUID,SP70
          MATCH     SP70,MHHLUUID
          IF        !@EQUAL
            PACK      KEY10,MHHLUUID,SP70
          ENDIF
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      SP70,WBSENAM
          ENDIF
.
          MOVE      "dh",KEY2
          PACK      KEY5,KEY2,MHHLRDHB
          CALL      RDCODE1
          IF        OVRCD=1 
            MOVE      MHHLRDHB,TDESC
          ENDIF
          MOVE      TDESC,DHBDESC
.                                                                     *I-195158
          PACK      DOCFNAME,MHHLRSCL,SP70                  
          PACK      KEY10,MHHLRSCL,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,RLIS5000
          MOVE      PMHCTITL,FMTTITLE
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000                * written to DOCFNAME 
.
RLIS5000  MOVE      SP70,TDESC
          MATCH     SP70,MHHLOREF
          IF        !@EQUAL
            MOVE      "tm",KEY2
            PACK      KEY5,KEY2,MHHLOREF
            CALL      RDCODE1
          ENDIF
.         
          PACK      DIM40,MHHLCSTM,SP70
          PACK      KEY10,MHHLCSTM,SP70
          CALL      RDALCAS1
          IF        OVRCD=0
            MOVE      ALCADESC,DIM40
          ENDIF
.
          MOVE      "Active",KEY8
          MATCH     "1",MHHLSTAT
          IF        @EQUAL
            MOVE      "Inactive",KEY8
          ENDIF
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":          * 0
                             "#"",MHHLSDAT,MHHLSTIM,"#",":          * 1
                             "#"",MHHLEDAT,MHHLETIM,"#",":          * 2
                             "#"",MHHLRNAM,"#",":                   * 3
                             "#"",PTERNAME,"#",":                   * 4
                             "#"",KEY4,"#",":                       * 5
                             "#"",KEY3,"#",":                       * 6
                             "#"",DOCFNAME,"#",":                   * 7
                             "#"",MHHLCSTM,"#",":                   * 8
                             "#"",TDESC,"#",":                      * 9
                             "#"",WBSENAM,"#",":                    * 10
                             "#"",DIM40,"#",":                      * 11
                             "#"",DHBDESC,"#",":                    * 12
                             "#"",KEY8,"#");"                      * 13
          GOTO      RLIS1000
.
RLIS9999  RETURN
+
.------------------------------------------------------------
.         Legal status Referral details list
.------------------------------------------------------------
DLIS0000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          CALL      LSHEAD00
.
          MOVE      ZERO,COUNTER
          PACK      KEY32,URNUMBER,UNIQNUMB,Z70
          CALL      RSMHDLS1
DLIS1000  CALL      RPMHDLS1
          BRANCH    OVRCD,DLIS9999
          MATCH     MHDLURNO,URNUMBER
          GOTO      DLIS9999 IF NOT EQUAL
          MATCH     MHDLUNIQ,UNIQNUMB
          GOTO      DLIS9999 IF NOT EQUAL
.
          MATCH     "013",TEMPLATE
          IF        !@EQUAL
            MATCH     "1",MHDLACTV
            GOTO      DLIS1000 IF EQUAL      * Ignore inactive
          ENDIF
.
          MOVE      "0",HIGHLIGHT
          MATCH     "013",TEMPLATE
          IF        @EQUAL
            CLEAR     EXCLUDE
            MOVE      "LS",CATEGORY
            MOVE      MHDLSCOD,CODE
            CALL      GETCOD00
            MATCH     "I",TCINDC1
            IF        @EQUAL
              APPEND    "<td align=center>X</td>",EXCLUDE
              MOVE      "1",HIGHLIGHT
            ELSE
              APPEND    "<td>&nbsp;</td>",EXCLUDE
            ENDIF
            MATCH     "X",TCINDC8
            IF        @EQUAL
              APPEND    "<td align=center>X</td>",EXCLUDE
              MOVE      "1",HIGHLIGHT
            ELSE
              APPEND    "<td>&nbsp;</td>",EXCLUDE
            ENDIF
            MATCH     "X",TCINDC9
            IF        @EQUAL
              APPEND    "<td align=center>X</td>",EXCLUDE
              MOVE      "1",HIGHLIGHT
            ELSE
              APPEND    "<td>&nbsp;</td>",EXCLUDE
            ENDIF
            RESET     EXCLUDE
          ENDIF
.
          CLEAR     HTMLLINK
          APPEND    "javascript:",HTMLLINK
          APPEND    "LegalLink('",HTMLLINK
          APPEND    MHDLUNIQ,HTMLLINK
          APPEND    MHDLURNO,HTMLLINK
          APPEND    MHDLSDAT,HTMLLINK
          APPEND    MHDLSTIM,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          MATCH     "1",HIGHLIGHT
          IF        @EQUAL
            WRITE     HTMLFILE;"<tr class=LSExclude>";
          ELSE
            WRITE     HTMLFILE;"<tr>";
          ENDIF
.
          WRITE     HTMLFILE;"<td><img src=../images/MaintenanceIcon.gif ":
                             " class=ListIcon onclick='linkLegal(#"":
                             UNIQNUMB,"#",#"":
                             MHDLSDAT,"#",#"":
                             MHDLSTIM,"#")'>";
.
          UNPACK    MHDLSDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          MOVE      SP70,KEY11
          REP       " 0",CYEAR
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          WRITE     HTMLFILE;"&nbsp;",KEY11," at ",MHDLSTIM,"</td>";
.
...       WRITE     HTMLFILE;"&nbsp;",KEY11,"</td>";
.
.                                                                     *I-195158
DLIS1500  MATCH     SP8,MHDLEDAT
          IF        !@EQUAL
            UNPACK    MHDLEDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            MOVE      SP70,KEY11
            REP       " 0",CYEAR
            PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
            WRITE     HTMLFILE;"<td>&nbsp;",KEY11," at ",MHDLETIM,"</td>";
          ELSE
	    WRITE     HTMLFILE;"<td> &nbsp; </td>";
          ENDIF
.
          MATCH     "1",MHCNPHED
          IF        @EQUAL
            CALL      LSID0000
            WRITE     HTMLFILE;"<td>",LSID,"</td>";
          ENDIF
.
          MATCH     "013",TEMPLATE
          IF        @EQUAL
            WRITE     HTMLFILE;EXCLUDE;
          ENDIF
.
          MOVE      SP70,PTCDLDES
          MATCH     SP70,MHDLSCOD
          IF        !@EQUAL
            PACK      KEY5,ANSL,ANSS,MHDLSCOD
            CALL      RDCODE1
          ENDIF
          WRITE     HTMLFILE;"<td>&nbsp;",PTCDLDES,"</td>";
.
          MOVE      SP70,TDESC
          MATCH     SP70,MHDLSTAT
          IF        !@EQUAL
            PACK      KEY5,ANSL,ANSR,MHDLSTAT
            CALL      RDCODE1
          ENDIF
          WRITE     HTMLFILE;"<td>&nbsp;",TDESC,"</td>";
.
          MATCH     SP70,MHDLRDAT
          IF        !@EQUAL
            UNPACK    MHDLRDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            MOVE      SP70,KEY11
            REP       " 0",CYEAR
            PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.           WRITE     HTMLFILE;"<td>&nbsp;",KEY11," at ",MHDLRTIM,"</td>";
            WRITE     HTMLFILE;"<td>&nbsp;",KEY11,"</td>";
          ELSE
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          MATCH     SP70,MHDLREMD
          IF        !@EQUAL
            UNPACK    MHDLREMD,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            MOVE      SP70,KEY11
            REP       " 0",CYEAR
            PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
            WRITE     HTMLFILE;"<td>&nbsp;",KEY11,"</td>"
          ELSE
            WRITE     HTMLFILE;"<td>&nbsp;</td>"
          ENDIF
.
          MOVE      "No ",KEY3
          MATCH     ANSY,MHDLSENT
          IF        @EQUAL
            MOVE      "Yes",KEY3
          ENDIF
          WRITE     HTMLFILE;"<td>&nbsp;",KEY3,"</td>"
.
          MOVE      "No ",KEY3
          MATCH     SP70,MHDLCMNT
          IF        !@EQUAL
            MOVE      "Yes",KEY3
          ELSE
            MATCH     SP70,MHDLCMN2
            IF        !@EQUAL
              MOVE      "Yes",KEY3
            ENDIF
          ENDIF
          WRITE     HTMLFILE;"<td>&nbsp;",KEY3,"</td>"
.
          MATCH     "013",TEMPLATE
          IF        @EQUAL
            MOVE      "Active",KEY8
            MATCH     "1",MHDLACTV
            IF        @EQUAL
              MOVE      "Inactive",KEY8
            ENDIF
            WRITE     HTMLFILE;"<td>&nbsp;",KEY8,"</td>"
          ENDIF
.
          WRITE     HTMLFILE;"</tr>"
.
...       ADD       ONE,COUNTER
...       COMPARE   "21",COUNTER
          GOTO      DLIS1000
.
DLIS9999  RETURN
+
.------------------------------------------------------------
.         Legal status table header                   
.------------------------------------------------------------
LSHEAD00  WRITE     HTMLFILE;"<tr>":
                              "<td class=HeadingCell>Start Date</td>":
                              "<td class=HeadingCell>End Date</td>";
.
          MATCH      "1",MHCNPHED
          IF         @EQUAL
            WRITE      HTMLFILE;"<td class=HeadingCell>PRIMHD Legal Status ID</td>";
          ENDIF
.
          MATCH      "013",TEMPLATE
          IF         @EQUAL
            WRITE      HTMLFILE;"<td class=HeadingCell>Informal</td>":
                                "<td class=HeadingCell>Excl NMDS</td>":
                                "<td class=HeadingCell>Excl PRIMHD</td>";
          ENDIF
.
          MOVE      SP70,TDESC
          PACK      KEY5,ANSL,ANSR,SP70
          CALL      RDCODE1
.
          WRITE      HTMLFILE;"<td class=HeadingCell>Legal Status</td>":
                              "<td class=HeadingCell>",TDESC,"</td>":
                              "<td class=HeadingCell>Review Date</td>":
                              "<td class=HeadingCell>Reminder Date</td>":
                              "<td class=HeadingCell>Sent</td>";
.
          MATCH      "013",TEMPLATE
          IF         @EQUAL
            WRITE      HTMLFILE;"<td class=HeadingCell>Comments</td>":
                              "<td class=HeadingCell>Status</td>":
                             "</tr>"
          ELSE
            WRITE      HTMLFILE;"<td class=HeadingCell>Comments</td>":
                             "</tr>"
          ENDIF
.
LSHEAD99  RETURN
+
.------------------------------------------------------------
.         Legal status Referral details list for WA
.------------------------------------------------------------
MHLS0000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          MOVE      ZERO,COUNTER
          PACK      KEY32,URNUMBER,UNIQNUMB,Z70
          CALL      RSMHDLS1
MHLS1000  CALL      RPMHDLS1
          BRANCH    OVRCD,MHLS9999
          MATCH     MHDLURNO,URNUMBER
          GOTO      MHLS9999 IF NOT EQUAL
          MATCH     MHDLUNIQ,UNIQNUMB
          GOTO      MHLS9999 IF NOT EQUAL
          MATCH     "1",MHDLACTV
          GOTO      MHLS1000 IF EQUAL      * Ignore inactive
.
          CLEAR     HTMLLINK
          APPEND    "javascript:",HTMLLINK
          APPEND    "LegalLink('",HTMLLINK
          APPEND    MHDLUNIQ,HTMLLINK
          APPEND    MHDLURNO,HTMLLINK
          APPEND    MHDLSDAT,HTMLLINK
          APPEND    MHDLSTIM,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"<tr><td>";
.
          MOVE      SP70,TDESC
          MATCH     SP70,MHDLSCOD
          IF        !@EQUAL
            PACK      KEY5,ANSL,ANSS,MHDLSCOD
            CALL      RDCODE1
          ENDIF
          WRITE     HTMLFILE;"&nbsp;",TDESC,"</td>";
.
          UNPACK    MHDLSDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          MOVE      SP70,KEY11
          REP       " 0",CYEAR
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          WRITE     HTMLFILE;"<td><img src=../images/MaintenanceIcon.gif ":
                             " class=ListIcon onclick='linkLegal(#"":
                             UNIQNUMB,"#",#"":
                             MHDLSDAT,"#",#"":
                             MHDLSTIM,"#")'>";
.
          WRITE     HTMLFILE;"&nbsp;",KEY11," at ",MHDLSTIM,"</td>";
.
MHLS1500  MATCH     SP8,MHDLEDAT
          IF        !@EQUAL
            UNPACK    MHDLEDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            MOVE      SP70,KEY11
            REP       " 0",CYEAR
            PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
            WRITE     HTMLFILE;"<td>&nbsp;",KEY11," at ",MHDLETIM,"</td>";
          ELSE
            WRITE     HTMLFILE;"<td> &nbsp; </td>";
          ENDIF
.
          MOVE      SP70,TDESC
          MATCH     SP70,MHDLPOCC
          IF        !@EQUAL
            PACK      KEY5,ANSP,ANSO,MHDLPOCC
            CALL      RDCODE1
          ENDIF
          WRITE     HTMLFILE;"<td>&nbsp;",TDESC,"</td>";
.
          MATCH     SP70,MHDLRDAT
          IF        !@EQUAL
            UNPACK    MHDLRDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            MOVE      SP70,KEY11
            REP       " 0",CYEAR
            PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
            MATCH     SP70,MHDLRTIM
            IF        !@EQUAL
              WRITE     HTMLFILE;"<td>&nbsp;",KEY11," at ",MHDLRTIM,"</td>";
            ELSE
              WRITE     HTMLFILE;"<td>&nbsp;",KEY11,"</td>";
            ENDIF
          ELSE
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          MOVE      "No ",KEY3
          MATCH     SP70,MHDLCMNT
          IF        !@EQUAL
            MOVE      "Yes",KEY3
          ELSE
            MATCH     SP70,MHDLCMN2
            IF        !@EQUAL
              MOVE      "Yes",KEY3
            ENDIF
          ENDIF
          WRITE     HTMLFILE;"<td>&nbsp;",KEY3,"</td></tr>"
.
          GOTO      MHLS1000
.
MHLS9999  RETURN
+
.-----------------------------------------------------------------------
.         Review Reminder list
.-----------------------------------------------------------------------
RMLS0000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          IF        ACTIVFLG=0
            MOVE      "0       ",MHDLREMD   * Start from non-blank Reminder Date
          ELSE 
            MOVE      "        ",MHDLREMD   * Start from blank reminder Date
          ENDIF
          PACK      KEY40,MHDLREMD,SP70
          CALL      RSMHDLS2
RMLS1000  CALL      RKMHDLS2
          BRANCH    OVRCD,RMLS9999
.
          MATCH     MHDLREMD,LASTDATE         * Check Reminder date
          GOTO      RMLS9999 IF LESS
.
          MATCH     SP70,MHDLRDAT               * Ignore if review date blank
          GOTO      RMLS1000 IF EQUAL
.
          MATCH     "1",MHDLACTV                * Inactive?
          GOTO      RMLS1000 IF EQUAL
.
          MATCH     SP70,MHDLEDAT    * CAR 244676-Ignore if there is an end date
          GOTO      RMLS1000 IF NOT EQUAL
.
.         Check if this is the last section of the U/R no
.
          CALL      CHDET000
          BRANCH    EXIT,RMLS1000
.
          PACK      KEY16,MHDLURNO,MHDLUNIQ,SP70
          CALL      RDMHHLS1
          BRANCH    OVRCD,RMLS1000
.
          MATCH     "1",MHHLSTAT                 * Inactive?
          GOTO      RMLS1000 IF EQUAL            * yes, ignore
.
          MATCH     SP3,REVHRDHB
          IF        !@EQUAL
            MATCH     MHHLRDHB,REVHRDHB
            GOTO      RMLS1000 IF NOT EQUAL       * Check Review status
          ENDIF
.
          MOVE      MHDLURNO,URNUMBER
          CALL      GETPAT00                      * Get patient details
          CALL      PATLN000
.
          MATCH     SP3,SECTCODE
          IF        !@EQUAL
            MATCH     MHDLSCOD,SECTCODE           * Check section code
            GOTO      RMLS1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP3,REVSTATS
          IF        !@EQUAL
            MATCH     MHDLSTAT,REVSTATS
            GOTO      RMLS1000 IF NOT EQUAL       * Check Review status
          ENDIF
.
          REP       " +",URNUMBER
          MOVE      MHDLUNIQ,UNIQNUMB
          REP       " +",UNIQNUMB
          MOVE      MHDLSDAT,OPENDATE
          REP       " +",OPENDATE
          MOVE      MHDLSTIM,OPENTIME
          REP       " +",OPENTIME
.
          CLEAR     HTMLLINK
          APPEND    LINKPRG,HTMLLINK
          APPEND    ".pbl?reportno=",HTMLLINK
          APPEND    LINKREP,HTMLLINK
          APPEND    "&template=",HTMLLINK
          APPEND    LINKTEM,HTMLLINK
          APPEND    "&urnumber=",HTMLLINK
          APPEND    URNUMBER,HTMLLINK
          APPEND    "&uniqnumb=",HTMLLINK
          APPEND    UNIQNUMB,HTMLLINK
          APPEND    "&opendate=",HTMLLINK
          APPEND    OPENDATE,HTMLLINK
          APPEND    "&opentime=",HTMLLINK
          APPEND    OPENTIME,HTMLLINK
          RESET     HTMLLINK
.
          MOVE      "LS",CATEGORY
          MOVE      MHDLSCOD,CODE                * To get Section code
          CALL      GETCOD00
.
          WRITE     HTMLFILE;"t.addRow(#"",FORMATNM,"#",":
                             "#"",HTMLLINK,"#",":
                             "#"",MHDLURNO,"#",":
                             "#"",MHDLSDAT,"#",":
                             "#"",TDESC,"#",";
.
          MOVE      "LR",CATEGORY
          MOVE      MHDLSTAT,CODE                * To get Review status
          CALL      GETCOD00
.
          MOVE      SP70,DOCFNAME
          PACK      KEY10,MHDLHCPC,SP70
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
          ENDIF
.
          PACK      ALCADESC,SP70           * Case Team Description   *I-244643
          MATCH     SP10,MHHLCSTM
          IF        !@EQUAL
            MOVE      "Unknown Case Team",ALCADESC
            PACK      KEY10,MHHLCSTM,SP10
            CALL      RDALCAS1
          ENDIF
.
          WRITE     HTMLFILE;"#"",TDESC,"#",":
                             "#"",MHDLRDAT,"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",MHHLCSTM,"#",":
                             "#"",MHDLREMD,"#",":
                             "#"",ALCADESC,"#");"                     *I-244643
.
          GOTO      RMLS1000
.
RMLS9999  RETURN
.
.------------------------------------------------------------
. Check if this is the last valid section of MH details
.------------------------------------------------------------
CHDET000  PACK      SKEY40,MHDLREMD,MHDLURNO,MHDLUNIQ,MHDLSDAT,MHDLSTIM,SP70
          MOVE      MHDLURNO,KEY8
          PACK      KEY32,KEY8,Z70
          CALL      RSMHDLS1
CHDET100  CALL      RPMHDLS1
          BRANCH    OVRCD,CHDET800
.
.         MATCH     SP70,MHDLRDAT               * Ignore if review date blank
.         GOTO      CHDET100 IF EQUAL
.
.         MATCH     SP70,MHDLREMD               * Ignore if reminder date blank
.         GOTO      CHDET100 IF EQUAL
.
          MATCH     "1",MHDLACTV                * Inactive?
          GOTO      CHDET100 IF EQUAL
.
          PACK      KEY40,MHDLREMD,MHDLURNO,MHDLUNIQ,MHDLSDAT,MHDLSTIM,SP70
          MATCH     KEY40,SKEY40
          GOTO      CHDET800 IF NOT EQUAL
.
          MOVE      ZERO,EXIT
          GOTO      CHDET900
.
CHDET800  MOVE      ONE,EXIT
.
CHDET900  MOVE      SKEY40,KEY40
          CALL      RDMHDLS2
CHDET999  RETURN
+
.------------------------------------------------------------
. Get Patient
.------------------------------------------------------------
GETPAT00  MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,GETPAT99
.
          MOVE      PSEX,DSEXCHAR
          CALL      SEXDSC00 
          MOVE      DSEXDESC,DISPSEX
.
          UNPACK    PBDATE,CDAY,CMON,CYEAR,CCENT
          CALL      IBACLOCK
          IF        PCEASE=1
            MOVE      PDECDTE,AGEDATE            * Date of Death
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
          CALL      PATNAM00
.
GETPAT99  RETURN
+
.-----------------------------------------------------------------------
.         Place of occurrence/Review Location selection for Legal status
.-----------------------------------------------------------------------
POCSEL00  MOVE      SP70,TDESC
          PACK      KEY5,CATEGORY,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      CATEGORY,TCODE
            MOVE      "Invalid Category",TDESC
          ENDIF
          REP       " _",TCODE
          REP       " _",THCSCOD
          WRITE     HTMLFILE;"<!--<cat-c category=#"",TCODE,"#" name=#"",TDESC:
                             "#" map=#"",THCSCOD,"#"></cat-c>-->"
.
          PACK      PTCDKEY2,CATEGORY,SP70
          CALL      RDSCODE2
POCSEL10  CALL      RDKCODE2
          BRANCH    OVRCD,POCSEL99
          MATCH     CATEGORY,TCODE
          GOTO      POCSEL99 IF NOT EQUAL
          MATCH     "L",TCINDC1
          GOTO      POCSEL10 IF NOT EQUAL     * Not for Legal status
          MATCH     SP70,ACODE
          GOTO      POCSEL10 IF EQUAL
          PACK      KEY25,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5:
                          TCINDC6,TCINDC7,TCINDC8,TCINDC9,TCINDC10:
                          TCINDC11,THCSCOD,PTCDNHCP,TCFORM6
          PACK      KEY30,QUOTE,ACODE,KEY25,QUOTE
          MATCH     CODE,ACODE
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY30," selected>":
                               TDESC,"</option>"
          ELSE
            MATCH     "I",PTCOACTV
            GOTO      POCSEL10 IF EQUAL
            WRITE     HTMLFILE;"<option value=",KEY30,">",TDESC,"</option>"
          ENDIF
          GOTO      POCSEL10
POCSEL99  RETURN
+
.------------------------------------------------------------
.         Referral comments/history
.------------------------------------------------------------
REFC0000  BRANCH    FLDITMNO,REFC0100,REFC0200,REFC0300,REFC0400,REFC0500:
                             REFC0600,REFC0700,REFC0800,REFC0900,REFC1000:
                             REFC1100,REFC1200,REFC1300,REFC1400,REFC1500:
                             REFC1600,REFC1700,REFC1800,REFC1900,REFC2000:
                             REFC2100,REFC2200,REFC2300
          WRITE     HTMLFILE;"Invalid Tag - MEHWEB01";
          GOTO      REFC9999
.
REFC0100  MATCH     SP70,MHMDNOTE
          GOTO      REFC9999 IF EQUAL
          WRITE     HTMLFILE;MHMDNOTE;
          GOTO      REFC9999
.
REFC0200  MATCH     SP70,MHMDDATE
          GOTO      REFC9999 IF EQUAL
          UNPACK    MHMDDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      ZERO,F2
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          WRITE     HTMLFILE;KEY11;
          GOTO      REFC9999
.
REFC0300  MATCH     SP70,MHMDTIME
          GOTO      REFC9999 IF EQUAL
          WRITE     HTMLFILE;MHMDTIME;
          GOTO      REFC9999
.
REFC0400  MATCH     SP70,MHMDUSER
          GOTO      REFC9999 IF EQUAL
          WRITE     HTMLFILE;MHMDUSER;
          GOTO      REFC9999
.
REFC0500  MATCH     SP70,MHMDOCCG
          GOTO      REFC9999 IF EQUAL
          WRITE     HTMLFILE;MHMDOCCG;
          GOTO      REFC9999
.
REFC0600  MATCH     SP70,MHMDDELT
          GOTO      REFC9999 IF EQUAL
          WRITE     HTMLFILE;MHMDDELT;
          GOTO      REFC9999
.
REFC0700  MATCH     SP70,MHMTCMNT
          GOTO      REFC9999 IF EQUAL
          WRITE     HTMLFILE;MHMTCMNT;
.
REFC0800  PACK      KEY20,MHMDURNO,MHMDTYPE,MHMDNOTE,SP70
          CALL      RSMHMTX1
REFC0810  CALL      RKMHMTX1
          BRANCH    OVRCD,REFC9999
.
          MATCH     MHMDURNO,MHMTURNO
          GOTO      REFC9999 IF NOT EQUAL
.
          MATCH     MHMDTYPE,MHMTTYPE
          GOTO      REFC9999 IF NOT EQUAL
.
          MATCH     MHMTNOTE,MHMDNOTE
          GOTO      REFC0810 IF NOT EQUAL
.
          WRITE     HTMLFILE;MHMTCMNT;
          GOTO      REFC0810
.
REFC0900  CALL      RCMTAB00                * Referral comment maint.
          GOTO      REFC9999
.
REFC1000  CALL      HEDHIS00                * Header record history
          GOTO      REFC9999
.
REFC1100  MOVE      ZERO,F1
          UNPACK    DIM127,D1,D1,DIM127
          MOVE      D1,F1
          BRANCH    F1,REFC1110
          CALL      DETHIS00                * Detail record history
          GOTO      REFC9999
.
REFC1110  CALL      WADHIS00                * WA Detail record history
          GOTO      REFC9999
.
REFC1200  PACK      SAVKEY32,MHDLURNO,MHDLUNIQ,MHDLSDAT,MHDLSTIM,SP70
.
          PACK      KEY32,URNUMBER,Z70
          CALL      RSMHDLS1
          CALL      RPMHDLS1
          BRANCH    OVRCD,REFC9999
.
          MATCH     MHDLURNO,URNUMBER
          GOTO      REFC9999 IF NOT EQUAL
.
          UNPACK    MHDLSDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
.
          MOVE      SAVKEY32,KEY32
          CALL      RDMHDLS1
          IF        OVRCD=ONE
            CALL      CLRDLS00
          ENDIF
.
          GOTO      REFC9999
.
REFC1300  PACK      SAVKEY32,MHDLURNO,MHDLUNIQ,MHDLSDAT,MHDLSTIM,SP70
.
          PACK      KEY32,URNUMBER,Z70
          CALL      RSMHDLS1
          CALL      RPMHDLS1
          BRANCH    OVRCD,REFC9999
.
          MATCH     MHDLURNO,URNUMBER
          GOTO      REFC9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;MHDLSTIM;
.
          MOVE      SAVKEY32,KEY32
          CALL      RDMHDLS1
          IF        OVRCD=ONE
            CALL      CLRDLS00
          ENDIF
.
          GOTO      REFC9999
.
REFC1400  MOVE      ZERO,F1
          PACK      KEY32,URNUMBER,UNIQNUMB,Z70
          CALL      RSMHDLS1
REFC1410  CALL      RPMHDLS1
          BRANCH    OVRCD,REFC1420
          MATCH     URNUMBER,MHDLURNO          * check U/R number
          GOTO      REFC1420 IF NOT EQUAL
.
          MATCH     UNIQNUMB,MHDLUNIQ
          GOTO      REFC1420 IF NOT EQUAL
.
.         Check if it's open
.
          MATCH     SP70,MHDLEDAT
          GOTO      REFC1410 IF NOT EQUAL      * Closed
          MOVE      ONE,F1
.
REFC1420  WRITE     HTMLFILE;F1;
          GOTO      REFC9999
.
REFC1500  MOVE      ZERO,F1
          UNPACK    DIM127,D1,D1,DIM127
          MOVE      D1,F1
.
          MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,REFC9999
.
          BRANCH    F1,REFC1510,REFC1520,REFC1530
.
REFC1510  WRITE     HTMLFILE;ADOCTA;
          GOTO      REFC9999
.
REFC1520  PACK      KEY10,ADOCTA,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,REFC9999
          MOVE      PMHCTITL,FMTTITLE
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000
          WRITE     HTMLFILE;DOCFNAME;
          GOTO      REFC9999
.
REFC1530  PACK      D10,ADOCTA,SP70
          MOVE      SP70,KEY20
          CALL      HCPT0000                   * Selection of teams for a doctor
          GOTO      REFC9999
.
REFC1600  MOVE      "001",KEY3
          PACK      KEY32,URNUMBER,UNIQNUMB,OPENDATE,OPENTIME,SP70
          PACK      KEY38,KEY32,KEY3,SP70
          CALL      RSMHCMN1
REFC1610  CALL      RKMHCMN1
          BRANCH    OVRCD,REFC9999          * end of file
.
          PACK      DIM32,MHCMURNO,MHCMUNIQ,MHCMSDAT,MHCMSTIM,SP70
          MATCH     DIM32,KEY32
          GOTO      REFC9999 IF NOT EQUAL
.
          MATCH     MHCMCTYP,KEY3
          GOTO      REFC9999 IF NOT EQUAL
.
          WRITE     HTMLFILE;MHCMDATA;
          GOTO      REFC1610
.
REFC1700  WRITE     HTMLFILE;SUPERLEV;
          GOTO      REFC9999
.
REFC1800  PACK      SAVKEY32,MHDLURNO,MHDLUNIQ,MHDLSDAT,MHDLSTIM,SP70
.
          PACK      KEY32,SAVKEY32,SP70
          CALL      RDMHDLS1
          CALL      RPMHDLS1
          BRANCH    OVRCD,REFC1850
.
          MATCH     MHDLURNO,URNUMBER
          GOTO      REFC1850 IF NOT EQUAL
.
          UNPACK    MHDLSDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
.
REFC1850  MOVE      SAVKEY32,KEY32
          CALL      RDMHDLS1
          IF        OVRCD=ONE
            CALL      CLRDLS00
          ENDIF
.
          GOTO      REFC9999
.
REFC1900  PACK      SAVKEY32,MHDLURNO,MHDLUNIQ,MHDLSDAT,MHDLSTIM,SP70
.
          PACK      KEY32,SAVKEY32,SP70
          CALL      RDMHDLS1
          CALL      RPMHDLS1
          BRANCH    OVRCD,REFC1950
.
          MATCH     MHDLURNO,URNUMBER
          GOTO      REFC1950 IF NOT EQUAL
.
          WRITE     HTMLFILE;MHDLSTIM;
.
REFC1950  MOVE      SAVKEY32,KEY32
          CALL      RDMHDLS1
          IF        OVRCD=ONE
            CALL      CLRDLS00
          ENDIF
.
          GOTO      REFC9999
.
REFC2000  MOVE      ZERO,F1
          PACK      KEY32,URNUMBER,UNIQNUMB,Z70
          CALL      RSMHDLS1
REFC2010  CALL      RPMHDLS1
          BRANCH    OVRCD,REFC9999
          MATCH     URNUMBER,MHDLURNO          * check U/R number
          GOTO      REFC9999 IF NOT EQUAL
.
          MATCH     UNIQNUMB,MHDLUNIQ
          GOTO      REFC9999 IF NOT EQUAL
.
.         Check if it's open
.
          MATCH     SP70,MHDLEDAT
          GOTO      REFC2010 IF NOT EQUAL      * Closed
.
          WRITE     HTMLFILE;MHDLURNO,MHDLUNIQ,MHDLSDAT,MHDLSTIM;
          GOTO      REFC9999
.
REFC2100  MOVE      ZERO,F1
          PACK      KEY32,URNUMBER,UNIQNUMB,SP70
          CALL      RSMHDLS1
REFC2150  CALL      RKMHDLS1
          BRANCH    OVRCD,REFC2120
          MATCH     URNUMBER,MHDLURNO          * check U/R number
          GOTO      REFC2120 IF NOT EQUAL
.
          MATCH     UNIQNUMB,MHDLUNIQ
          GOTO      REFC2120 IF NOT EQUAL
.
          MATCH     "0",MHDLACTV
          GOTO      REFC2150 IF NOT EQUAL      * No active
.
          MOVE      ONE,F1
.
REFC2120  WRITE     HTMLFILE;F1;
          GOTO      REFC9999
.
REFC2200  MATCH     SP70,MHHLCSTM
          GOTO      REFC9999 IF EQUAL
.
          MOVE      "Unknown Case Team",DIM40
.
          PACK      KEY10,MHHLCSTM,SP10
          CALL      RDALCAS1
          BRANCH    OVRCD,REFC2250
          MOVE      ALCADESC,DIM40
          GOTO      REFC2270
.
REFC2250  PACK      KEY5,MHHLCSTM,SP70
          CALL      RDPMTEM1
          BRANCH    OVRCD,REFC2270
          MOVE      PMTMDESC,DIM40
          GOTO      REFC2270 
.
REFC2270  WRITE     HTMLFILE;DIM40;
          GOTO      REFC9999
.
REFC2300  MATCH     "1",SUPERLEV
          IF        @EQUAL
            WRITE     HTMLFILE;"Supervisor";
          ENDIF
REFC9999  RETURN
+
.------------------------------------------------------------
. Display Table of Clinical Note
.---------------------------------------------------------------------
RCMTAB00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          CALL      RCHED000      * Output Table Heading
.
          MOVE      URNUMBER,MHMDURNO
          MOVE      "001",MHMDTYPE
          PACK      KEY17,MHMDURNO,MHMDTYPE,Z70
          CALL      RSMHMDT1
RCMTAB10  CALL      RPMHMDT1
          BRANCH    OVRCD,RCMTAB99
          MATCH     URNUMBER,MHMDURNO
          GOTO      RCMTAB99 IF NOT EQUAL
          MATCH     "001",MHMDTYPE
          GOTO      RCMTAB99 IF NOT EQUAL
.
          MATCH     MHMDDATE,SP70
          IF        @EQUAL
            MOVE     "&nbsp",KEY11
            GOTO     RCMTAB40
          ENDIF
.
          UNPACK    MHMDDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MATCH     "1",MHMDDELT
          IF        @EQUAL
            MOVE       "<strike>",STRIKETG
            MOVE       "</strike>",STRENDTG
          ELSE
            MOVE       "",STRIKETG
            MOVE       "",STRENDTG
          ENDIF
.
          REP       " +",URNUMBER
          REP       " +",MHMDNOTE
.
          PACK      KEY10,MHMDUSER,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      MHMDUSER,WBSENAM
          ENDIF
.
RCMTAB40  WRITE     HTMLFILE;"<tr><td nowrap><a href='javascript:ShowDetail02":
                             "(#"",LINKPRG,"#.pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&urnumber=",URNUMBER:
                             "&notenumb=",MHMDNOTE,"#")'>":
                             "<img src=../images/MaintenanceIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             STRIKETG,KEY11,SP1,MHMDTIME,"</td>":
                             "<td>",STRIKETG,WBSENAM," - ",MHMDOCCG,"&nbsp":
                             STRENDTG,"</td>":
                             "<td>",STRIKETG;
          MOVE      ZERO,CTR
          CALL      RCMNOT00
.
          PACK      KEY10,MHMDDUSE,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      MHMDDUSE,WBSENAM
          ENDIF
.
          WRITE     HTMLFILE;"&nbsp",STRENDTG,"</td>":
                             "<td>",WBSENAM," - ",MHMDDOCC,"&nbsp":
                             "</td>":
                             "</tr>"

          REP       "+ ",URNUMBER
          REP       "+ ",MHMDNOTE
.
          GOTO      RCMTAB10
RCMTAB99  RETURN
.------------------------------------------------------------
. Referral comment Summary (TABLE HEADING)
.------------------------------------------------------------
RCHED000  WRITE     HTMLFILE;"<tr>":
                              "<td class=HeadingCell width=20%>Date</td>":
                              "<td class=HeadingCell width=20%>Input By</td>":
                              "<td class=HeadingCell width=40%>":
                              "Notes</td>":
                              "<td class=HeadingCell width=20%>Delete By</td>":
                             "</tr>"                                   *I-50359
.
RCHED999  RETURN
.--------------------------------------------------------------------
. Patient note display
.--------------------------------------------------------------------
RCMNOT00  REP       "+ ",URNUMBER
          REP       "+ ",MHMDNOTE
          PACK      KEY20,URNUMBER,MHMDTYPE,MHMDNOTE,SP70
          CALL      RSMHMTX1
RCMNOT10  CALL      RKMHMTX1
          BRANCH    OVRCD,RCMNOT99
.
          MATCH     MHMTURNO,URNUMBER         * same U/R?
          GOTO      RCMNOT99 IF NOT EQUAL
.
          MATCH     MHMTTYPE,MHMDTYPE         * same type?
          GOTO      RCMNOT99 IF NOT EQUAL
.
          MATCH     MHMTNOTE,MHMDNOTE         * same note number
          GOTO      RCMNOT99 IF NOT EQUAL
.
          COMPARE   TWO,CTR
          GOTO      RCMNOT99 IF EQUAL
          ADD       ONE,CTR
          WRITE     HTMLFILE;MHMTCMNT,"<br>";
          GOTO      RCMNOT10
.
RCMNOT99  RETURN
+
.------------------------------------------------------------
. Display Table of Header record history
.---------------------------------------------------------------------
HEDHIS00  WRITE     HTMLFILE;"<tr>":
                    "<td class=HeadingCell>Type</td>":
                    "<td class=HeadingCell>Start Date/Time</td>":
                    "<td class=HeadingCell>End Date/Time</td>":
                    "<td class=HeadingCell>Referral Source</td>":
                    "<td class=HeadingCell>Referral Name</td>":
                    "<td class=HeadingCell>Lawyer</td>":
                    "<td class=HeadingCell>Prisoner</td>":
                    "<td class=HeadingCell>Current</td>":
                    "<td class=HeadingCell>User Name</td></tr>"
.
          MOVE      ZERO,COUNTER
          PACK      KEY24,URNUMBER,Z70
          CALL      ASMHHL
HEDHIS10  CALL      APMHHL  
          BRANCH    OVRCD,HEDHIS90
          MATCH     URNUMBER,MHHLURNO
          GOTO      HEDHIS90 IF NOT EQUAL
          ADD       ONE,COUNTER
.
          UNPACK    MHHLSDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MOVE      "Add",KEY8
          MATCH     "V",MHHLRTYP
          IF        @EQUAL
            MOVE      "View",KEY8
          ELSE
            MATCH     "B",MHHLRTYP
            IF        @EQUAL
              MOVE      "Before",KEY8
            ELSE
              MATCH     "C",MHHLRTYP
              IF        @EQUAL
                MOVE      "After",KEY8
              ELSE
                MATCH     "D",MHHLRTYP
                IF        @EQUAL
                  MOVE      "Inactive",KEY8
                ELSE
                  MATCH     "R",MHHLRTYP
                  IF        @EQUAL
                    MOVE      "Reactive",KEY8
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     "D",MHHLRTYP
          GOTO      HEDHIS16 IF EQUAL         * Delete/Inactive
          MATCH     "R",MHHLRTYP
          GOTO      HEDHIS16 IF EQUAL         * Reactive
.
          WRITE     HTMLFILE;"<tr bgcolor=#CCCCCC><td>",KEY8,"</td>":
                             "<td>",KEY11," at ",MHHLSTIM,"</td>";
          GOTO      HEDHIS18
.
HEDHIS16  WRITE     HTMLFILE;"<tr bgcolor=#CCCCCC>":
                             "<td><a><font color=#FF0000><b>",KEY8:
                             "</b></font></a></td>":
                             "<td><a><font color=#FF0000><b>",KEY11:
                             " at ",MHHLSTIM,"</b></font></a></td>";
.
HEDHIS18  MATCH     SP70,MHHLEDAT
          GOTO      HEDHIS20 IF EQUAL
.
          UNPACK    MHHLEDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          WRITE     HTMLFILE;"<td>",KEY11," at ",MHHLETIM,"</td>";
          GOTO      HEDHIS40
.
HEDHIS20  WRITE     HTMLFILE;"<td>&nbsp;</td>";
.
HEDHIS40  MOVE      "S ",CATEGORY
          MOVE      MHHLSREF,CODE                * To get Compensation Desc
          CALL      GETCOD00
          MATCH     "G",TCINDC7
          GOTO      HEDHIS50 IF EQUAL
          MATCH     "B",TCINDC7
          GOTO      HEDHIS60 IF EQUAL
          MATCH     "A",TCINDC7
          GOTO      HEDHIS60 IF EQUAL
          GOTO      HEDHIS70
.
HEDHIS50  MATCH     SP70,MHHLHCPC
          GOTO      HEDHIS70 IF EQUAL
          WRITE     HTMLFILE;"<td>&nbsp;",TDESC,"-",MHHLHCPC,"</td>";
          GOTO      HEDHIS80
.
HEDHIS60  MATCH     SP70,MHHLORCD
          GOTO      HEDHIS70 IF EQUAL
          WRITE     HTMLFILE;"<td>&nbsp;",TDESC,"-",MHHLORCD,"</td>";
          GOTO      HEDHIS80
.
HEDHIS70  WRITE     HTMLFILE;"<td>&nbsp;",TDESC,"</td>";
.
HEDHIS80  PACK      KEY7,ANSL,MHHLLAWY,SP70
          CALL      RDPTEOR1
          IF        OVRCD=1
            MOVE      SP70,PTERNAME
          ENDIF
.
          MATCH     SP70,MHHLRTEL
          IF        !@EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;",MHHLRNAM,"(",MHHLRTEL,")</td>";
          ELSE
            WRITE     HTMLFILE;"<td>&nbsp;",MHHLRNAM,"</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td>&nbsp;",PTERNAME,"</td>";
.
          MOVE      "No  ",KEY4
          MOVE      SP70,KEY11
          MATCH     "1",MHHLPRIS
          IF        @EQUAL
            MOVE      "Yes ",KEY4
          ENDIF
.
          MATCH     SP70,MHHLESDT
          IF        !@EQUAL
            UNPACK    MHHLESDT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
            WRITE     HTMLFILE;"<td>&nbsp;",KEY4,"(",KEY11,")</td>"
          ELSE
            WRITE     HTMLFILE;"<td>&nbsp;",KEY4,"</td>"
          ENDIF
.
          MOVE      "No  ",KEY4
          MATCH     "1",MHHLCURR
          IF        @EQUAL
            MOVE      "Yes ",KEY4
          ENDIF
          WRITE     HTMLFILE;"<td>&nbsp;",KEY4,"</td>"
.
          UNPACK    MHHLMDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          PACK      KEY10,MHHLMUID
          CALL      RDWBSE1
          IF        OVRCD=1
            PACK      DIM30,MHHLMUID,SP70
          ELSE
            PACK      DIM30,WBSENAM,SP70
          ENDIF
.
          STRIP      DIM30
.
          WRITE     HTMLFILE;"<td>&nbsp;",*+,DIM30,"<br>(",KEY11," at ":
                             MHHLMTIM,")</td></tr>"
.
          WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                             "<td align=right>Referral Address:</td>":
                             "<td colspan=7>&nbsp;";
.
          MATCH     SP70,MHHLRAD1
          IF        !@EQUAL
            WRITE     HTMLFILE;MHHLRAD1;
          ENDIF
.
          MATCH     SP70,MHHLRAD2
          IF        !@EQUAL
            WRITE     HTMLFILE;", ",MHHLRAD2;
          ENDIF
.
          MATCH     SP70,MHHLRAD3
          IF        !@EQUAL
            WRITE     HTMLFILE;", ",MHHLRAD3;
          ENDIF
.
          MATCH     SP70,MHHLRAD4
          IF        !@EQUAL
            WRITE     HTMLFILE;", ",MHHLRAD4;
          ENDIF
.
          MATCH     SP70,MHHLRPOS
          IF        !@EQUAL
            WRITE     HTMLFILE;", ",MHHLRPOS;
          ENDIF
.
          WRITE     HTMLFILE;"</td></tr>"
.
          GOTO      HEDHIS10
.
HEDHIS90  IF        COUNTER=0
            WRITE     HTMLFILE;"<tr><td align=center colspan=9>":
                               "<b>No Referral History Records Found</td></tr>"
          ENDIF
.
HEDHIS99  RETURN
.
.------------------------------------------------------------
. Display Table of Details record history
.---------------------------------------------------------------------
DETHIS00  WRITE     HTMLFILE;"<tr>":
                    "<td class=HeadingCell>Type</td>":
                    "<td class=HeadingCell>Start Date</td>":
                    "<td class=HeadingCell>End Date/Time</td>";
.
          MATCH     "1",MHCNPHED
          IF        @EQUAL
            WRITE     HTMLFILE;"<td class=HeadingCell>PRIMHD Legal Status ID</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td class=HeadingCell>Legal Status</td>":
                    "<td class=HeadingCell>Review Status</td>":
                    "<td class=HeadingCell>Review Date</td>":
                    "<td class=HeadingCell>HCP Code</td>":
                    "<td class=HeadingCell>Case Team</td>":
                    "<td class=HeadingCell>Location</td>":
                    "<td class=HeadingCell>Remd. Date</td>":
                    "<td class=HeadingCell>Drive</td>":
                    "<td class=HeadingCell>Residential</td>":
                    "<td class=HeadingCell>User Name</td></tr>"
.
          MOVE      ZERO,COUNTER
          MATCH     SP70,UNIQNUMB
          IF        @EQUAL
            PACK      KEY32,URNUMBER,Z70
          ELSE
            PACK      KEY32,URNUMBER,UNIQNUMB,Z70
          ENDIF
          CALL      ASMHDL
DETHIS10  CALL      APMHDL
          BRANCH    OVRCD,DETHIS90
          MATCH     URNUMBER,MHDLURNO
          GOTO      DETHIS90 IF NOT EQUAL
.
          MATCH     SP70,UNIQNUMB
          IF        !@EQUAL
            MATCH     UNIQNUMB,MHDLUNIQ
            GOTO      DETHIS90 IF NOT EQUAL
          ENDIF
.
          ADD       ONE,COUNTER
.
          UNPACK    MHDLSDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MOVE      "Add",KEY8
          MATCH     "V",MHDLRTYP
          IF        @EQUAL
            MOVE      "View",KEY8
          ELSE
            MATCH     "B",MHDLRTYP
            IF        @EQUAL
              MOVE      "Before",KEY8
            ELSE
              MATCH     "C",MHDLRTYP
              IF        @EQUAL
                MOVE      "After",KEY8
              ELSE
                MATCH     "D",MHDLRTYP
                IF        @EQUAL
                  MOVE      "Inactive",KEY8
                ELSE
                  MATCH     "R",MHDLRTYP
                  IF        @EQUAL
                    MOVE      "Reactive",KEY8
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      "LS",CATEGORY
          MOVE      MHDLSCOD,CODE                * To Section code Desc
          CALL      GETCOD00
.
          MATCH     "D",MHDLRTYP
          GOTO      DETHIS18 IF EQUAL
          MATCH     "R",MHDLRTYP
          GOTO      DETHIS18 IF EQUAL
.
          WRITE     HTMLFILE;"<tr bgcolor=#CCCCCC><td>",KEY8,"</td>":
                             "<td>",KEY11:
.                            " at ",MHDLSTIM:
                             "</a></td>";
          GOTO      DETHIS20
.
DETHIS18  WRITE     HTMLFILE;"<tr bgcolor=#CCCCCC>":
                             "<td><a><font color=#FF0000><b>",KEY8:
                             "</b></font></a></td>":
                             "<td><a><font color=#FF0000><b>",KEY11:
.                            " at ",MHDLSTIM:
                             "</b></font></a></td>";
.
DETHIS20  MATCH     SP70,MHDLEDAT
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ELSE
            UNPACK    MHDLEDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
            WRITE     HTMLFILE;"<td>",KEY11:
                               " at ",MHDLETIM:
                               "</a></td>";
.
          ENDIF
.
          MATCH     "1",MHCNPHED
          IF        @EQUAL
            CALL      LSID0000
            WRITE     HTMLFILE;"<td>",LSID,"</td>";
          ENDIF
.
          MATCH     "D",MHDLRTYP
          IF        @EQUAL
            WRITE     HTMLFILE;"<td><font color=#FF0000><b>&nbsp;":
                               TDESC,"</b></font></td>";
          ELSE
            WRITE     HTMLFILE;"<td>&nbsp;",TDESC,"</td>";
          ENDIF
.
          MOVE      "LR",CATEGORY
          MOVE      MHDLSTAT,CODE                * To Review status Desc
          CALL      GETCOD00
          WRITE     HTMLFILE;"<td>&nbsp;",TDESC,"</td>";
.
          MATCH     SP70,MHDLRDAT
          IF        !@EQUAL
            UNPACK    MHDLRDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.           WRITE     HTMLFILE;"<td>&nbsp;",KEY11," at ",MHDLRTIM,"</td>";
            WRITE     HTMLFILE;"<td>&nbsp;",KEY11,"</td>";
          ELSE
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          MOVE      SP70,DOCFNAME
          PACK      KEY10,MHDLHCPC,SP70
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
          ENDIF
          WRITE     HTMLFILE;"<td>&nbsp;",DOCFNAME,"</td>":
                             "<td>&nbsp;",MHDLCASE,"</td>";
.
          MOVE      "PO",CATEGORY
          MOVE      MHDLPOCC,CODE                * Place of Occurence/Location
          CALL      GETCOD00
          WRITE     HTMLFILE;"<td>&nbsp;",TDESC,"</td>";
.
          MOVE      SP70,KEY11
          MATCH     SP70,MHDLREMD
          IF        !@EQUAL
            UNPACK    MHDLREMD,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
          WRITE     HTMLFILE;"<td>&nbsp;",KEY11,"</td>";
.
          MOVE      "No  ",KEY4
          MATCH     "1",MHDLDRIV
          IF        @EQUAL
            MOVE      "Yes ",KEY4
          ENDIF
          WRITE     HTMLFILE;"<td>&nbsp;",KEY4,"</td>";
.
.         Residential
.
          MOVE      "No  ",KEY4
          MATCH     "1",MHDLRESD
          GOTO      DETHIS30 IF NOT EQUAL   * No resident
.
          MOVE      "Yes ",KEY4
          MATCH     SP70,MHDLRCOD
          GOTO      DETHIS30 IF EQUAL
.
          WRITE     HTMLFILE;"<td>",KEY4,"</br>";
.
          PACK      KEY7,ANSD,MHDLRCOD,SP70
          CALL      RDPTEOR1
          IF        OVRCD=1
            WRITE     HTMLFILE;"-",MHDLRCOD,"</td>";
          ELSE
            WRITE     HTMLFILE;"-",PTERNAME,"</td>";
          ENDIF
          GOTO      DETHIS40
.
DETHIS30  WRITE     HTMLFILE;"<td>",KEY4,"</td>";
.
DETHIS40  UNPACK    MHDLMDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          PACK      KEY10,MHDLMUID
          CALL      RDWBSE1
          IF        OVRCD=1
            PACK      DIM30,MHDLMUID,SP70
          ELSE
            PACK      DIM30,WBSENAM,SP70
          ENDIF
.
          STRIP      DIM30
.
          WRITE     HTMLFILE;"<td>&nbsp;",*+,DIM30,"<br>(",KEY11," at ":
                             MHDLMTIM,")</td></tr>"
.
          WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                             "<td align=right>Comments:</td>":
                             "<td colspan=12>&nbsp;":
                             MHDLCMNT,"</td></tr>"
          GOTO      DETHIS10
.
DETHIS90  IF        COUNTER=0
            WRITE     HTMLFILE;"<tr><td align=center colspan=14>":
                           "<b>No Legal Status History Records Found</td></tr>"
          ENDIF
.
DETHIS99  RETURN
+
.------------------------------------------------------------
. WA - Display Table of Details record history
.---------------------------------------------------------------------
WADHIS00  WRITE     HTMLFILE;"<tr>":
                    "<td class=HeadingCell>Type</td>":
                    "<td class=HeadingCell>Legal Status</td>":
                    "<td class=HeadingCell>Start Date/Time</td>":
                    "<td class=HeadingCell>Expiry Date/Time</td>":
                    "<td class=HeadingCell>Review Date/Time</td>":
                    "<td class=HeadingCell>Responsible Clinician</td>":
                    "<td class=HeadingCell>User ID</td></tr>"
.
          MOVE      ZERO,COUNTER
          MATCH     SP70,UNIQNUMB
          IF        @EQUAL
            PACK      KEY32,URNUMBER,Z70
          ELSE
            PACK      KEY32,URNUMBER,UNIQNUMB,Z70
          ENDIF
          CALL      ASMHDL
WADHIS10  CALL      APMHDL
          BRANCH    OVRCD,WADHIS90
          MATCH     URNUMBER,MHDLURNO
          GOTO      WADHIS90 IF NOT EQUAL
.
          MATCH     SP70,UNIQNUMB
          IF        !@EQUAL
            MATCH     UNIQNUMB,MHDLUNIQ
            GOTO      WADHIS90 IF NOT EQUAL
          ENDIF
.
          ADD       ONE,COUNTER
.
          UNPACK    MHDLSDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MOVE      "Add",KEY8
          MATCH     "V",MHDLRTYP
          IF        @EQUAL
            MOVE      "View",KEY8
          ELSE
            MATCH     "B",MHDLRTYP
            IF        @EQUAL
              MOVE      "Before",KEY8
            ELSE
              MATCH     "C",MHDLRTYP
              IF        @EQUAL
                MOVE      "After",KEY8
              ELSE
                MATCH     "D",MHDLRTYP
                IF        @EQUAL
                  MOVE      "Inactive",KEY8
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      "LS",CATEGORY
          MOVE      MHDLSCOD,CODE                * To Section code Desc
          CALL      GETCOD00
.
          MOVE      SP70,MHSTDATE
          UNPACK    MHDLSDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      MHSTDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          PACK      SAVKEY32,MHDLURNO,MHDLUNIQ,MHDLSDAT,MHDLSTIM,SP70
          MOVE      SP70,PRECDATE
          MOVE      SP70,PRECTIME
.
          PACK      KEY32,SAVKEY32,Z70
          CALL      RDMHDLS1
          CALL      RPMHDLS1
          BRANCH    OVRCD,WADHIS20
.
          MATCH     MHDLURNO,URNUMBER
          GOTO      WADHIS20 IF NOT EQUAL
.
          UNPACK    MHDLSDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      PRECDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          MOVE      MHDLSTIM,PRECTIME
.
WADHIS20  MOVE      SAVKEY32,KEY32
          CALL      RDMHDLS1
          IF        OVRCD=ONE
            CALL      CLRDLS00
          ENDIF
.
          MATCH     "D",MHDLRTYP
          IF        @EQUAL
            WRITE     HTMLFILE;"<tr bgcolor=#CCCCCC>":
                               "<td><a><font color=#FF0000><b>",KEY8:
                               "</b></font></a></td>":
                               "<td><font color=#FF0000><b>&nbsp;":
                               TDESC,"</b></font></td>":
                               "<td><a><font color=#FF0000><b>",KEY11:
                               " at ",MHDLSTIM:
                               "</b></font></a></td>";

          ELSE
            WRITE     HTMLFILE;"<tr bgcolor=#CCCCCC><td>",KEY8,"</td>":
                               "<td>&nbsp;",TDESC,"</td>":
                               "<td>",KEY11:
                               " at ",MHDLSTIM:
                               "</a></td>";
          ENDIF
.
.         Calculate Expiry Date
.
          WRITE     HTMLFILE;"<td>&nbsp;</td>";
.
          MATCH     SP70,MHDLRDAT
          IF        !@EQUAL
            UNPACK    MHDLRDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
            WRITE     HTMLFILE;"<td>&nbsp;",KEY11," at ",MHDLRTIM,"</td>";
          ELSE
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
.         Clinician Responsible
.
          MOVE      SP70,DOCFNAME
          PACK      KEY10,MHDLHCPC,SP70
          CALL      RDPMHCP1
          IF        OVRCD=0
            MOVE      PMHCTITL,FMTTITLE
            MOVE      PMHCGNAM,FMTGNAME
            MOVE      PMHCSNAM,FMTSNAME
            CALL      DOCNM000
          ENDIF
          WRITE     HTMLFILE;"<td>&nbsp;",DOCFNAME,"</td>";
.
          UNPACK    MHDLMDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          WRITE     HTMLFILE;"<td>&nbsp;",MHDLMUID,"(",KEY11," at ":
                             MHDLMTIM,")</td>"
          WRITE     HTMLFILE;" <input type=hidden value=#"",TCINDC4,"#"> "
          WRITE     HTMLFILE;" <input type=hidden value=#"",TCINDC5,"#"> "
          WRITE     HTMLFILE;" <input type=hidden value=#"",TCFORM6,"#"> "
          WRITE     HTMLFILE;" <input type=hidden value=#"",MHSTDATE,"#"> "
          WRITE     HTMLFILE;" <input type=hidden value=#"",MHDLSTIM,"#"> "
          WRITE     HTMLFILE;" <input type=hidden value=#"",PRECDATE,"#"> "
          WRITE     HTMLFILE;" <input type=hidden value=#"",PRECTIME,"#"> "
        WRITE     HTMLFILE;" <input type=hidden name=#"yescalculateitplease#"> "
          WRITE     HTMLFILE;"</tr>"
.
          WRITE     HTMLFILE;"<tr><td>&nbsp;</td>":
                             "<td align=right>Comments:</td>":
                             "<td colspan=11>&nbsp;":
                             MHDLCMNT,"</td>"
          WRITE     HTMLFILE;"</tr>"
          GOTO      WADHIS10
.
WADHIS90  IF        COUNTER=0
            WRITE     HTMLFILE;"<tr><td align=center colspan=12>":
                           "<b>No Legal Status History Records Found</td></tr>"
          ENDIF
.
WADHIS99  RETURN
+
.------------------------------------------------------------
. MEHDIS00          MH Patient Discharge      I SRF 22731
.------------------------------------------------------------
MEHDIS00  CALL      CLPATMAS                * clear master detils
          CALL      CLPV0000                * clear patvisaf details
          CALL      CLMEHVIS                * clear mental health details
          CALL      CLMEHDIS                * clear mental health discharge det
.
          MOVE      URNUMBER,KEY8           * Check if Master file exists
          CALL      RDMAST1
          BRANCH    OVRCD,MEHDIS95
.
          PACK      KEY8,ADMISSNO,SP70      * Check if MH Visit exists
          CALL      RDMHVIS1
          BRANCH    OVRCD,MEHDIS98
.
          IF        MHVISTAT = 7 | MHVISTAT = 8
            PACK      KEY8,ADMISSNO,SP70    * Check if Referral exists
            CALL      RDALREF1
            BRANCH    OVRCD,MEHDIS91
          ELSE
            PACK      KEY8,ADMISSNO,SP70    * Check if admission exists
            CALL      RDMISS1
            BRANCH    OVRCD,MEHDIS96
            PACK      KEY8,ADMISSNO,SP70    * Check if Discharge exists
            CALL      RDDSCH1
            BRANCH    OVRCD,MEHDIS92
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70      * Check if Visit exists?
          CALL      RDVISA1
          BRANCH    OVRCD,MEHDIS94
.
          PACK      KEY8,ADMISSNO,SP70      * Check for MH Discharge file
          CALL      RDMHDSC1
          BRANCH    OVRCD,MEHDIS97 
.
          MOVE      SP70,MHLESTAT           * Check for last Legal Status
          PACK      KEY21,ADMISSNO,Z70
          CALL      RSMHLEG1
          CALL      RPMHLEG1  
          BRANCH    OVRCD,MEHDIS20
          MATCH     ADMISSNO,DMHLEADM
          GOTO      MEHDIS40 IF EQUAL
.
.         Try MH referral file
.
MEHDIS20  PACK      KEY16,URNUMBER,SP70
          CALL      RSMHHLS1
          CALL      RKMHHLS1
          BRANCH    OVRCD,MEHDIS93
          MATCH     MHHLURNO,URNUMBER
          GOTO      MEHDIS93 IF NOT EQUAL
.
MEHDIS40  MATCH     ANSU,UPDTTYPE
          GOTO      MEHDIS90 IF EQUAL          
.
          MOVE      "Mental Health Details",WEBTITLE
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,MEHDIS99
 
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      MEHDIS99
.
MEHDIS90  CALL      MVDIS000                               * Move cgi into MH
          CALL      MVMEH000                               * Move cgi into MH
          CALL      UPMHDSC1                               * discharge variables
          CALL      UPMHVIS1                               * visit variables
.                                                          * and update files
          MOVE      "LS",CATEGORY
          MOVE      PTMXLS,CODE                            * Check indicator one
          CALL      GETCOD00                               * of current legal
.                                                          * status
          MATCH     ANSS,TCINDC1                           * if special then
          GOTO      MEHDIS99 IF EQUAL                      * dont change status
.
...        MOVE      "DD",CATEGORY                          * Find out if 
...        MOVE      DDEST,CODE                             * being transferred
...        CALL      GETCOD00                               * to another hosp
...
...        MOVE      ONE,DIM1
...        MATCH     TCINDC2,DIM1
.
.      * insert validation for hospital in the same board here
.
...        GOTO      MEHDIS99 IF EQUAL
...
...       MOVE      TCINDC2,FORM1                          * do not update
...       COMPARE   FORM1,ONE                              * legal status if
...       GOTO      MEHDIS99 IF EQUAL                      * transferring
.
          CALL      IBACLOCK                               * Find out current 
          PACK      CURRDATE,CCC,CYY,CMM,CDD               * date
          REP       " 0",CURRDATE
          MOVE      CURRDATE,MHLEDATE
          MOVE      CTIMEIS,MHLETIME
...       MOVE      SP70,MHLESTAT                          
...       PACK      KEY21,DMHLEADM,MHLEDATE,MHLETIME       * Pack key and write
...       CALL      WRMHLEG1                               * new legal status
...
...       MOVE      SP70,PTMXLS                            * spaces to leg stat
...       CALL      UPMAST1                                * update current leg
.
          GOTO      MEHDIS99                               * status
.
MEHDIS91  MOVE      "Allied Health details not found.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEHDIS99
.
MEHDIS92  MOVE      "Can't Find Discharge record. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEHDIS99
.
MEHDIS93  MOVE      "Can't Find Legal Status record. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEHDIS99
.
MEHDIS94  MOVE      "Can't Find Visit record. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEHDIS99
.
MEHDIS95  MOVE      "Can't Find Master Details",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEHDIS99
.
MEHDIS96  MOVE      "Admission details not found.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEHDIS99
.
MEHDIS97  MOVE      "Can't Find Mental Health Discharge Details",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEHDIS99
.
MEHDIS98  MOVE      "Invalid mental health admission.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEHDIS99
.
MEHDIS99  RETURN
+
.------------------------------------------------------------
. MEHDLV00  - Mental Health Leave Details
.------------------------------------------------------------
MEHDLV00  CALL      CLPATMAS                * clear master detils
          CALL      CLPV0000                * clear patvisaf details
          CALL      CLMEHVIS                * clear mental health details
          CALL      CLMEHDLV                * clear mental health leave details
.
          MOVE      URNUMBER,KEY8           * Check if Master file exists
          CALL      RDMAST1
          BRANCH    OVRCD,MEHDLV95
.
          PACK      KEY8,ADMISSNO,SP70      * Check if admission exists
          CALL      RDMISS1
          BRANCH    OVRCD,MEHDLV96
.
          IF        ASTAT<>4
            GOTO      MEHDLV92
          ENDIF
          PACK      KEY14,ADMISSNO,SP70
          CALL      RDSONLV2
          CALL      RDKONLV2
          BRANCH    OVRCD,MEHDLV91
          MATCH     ADMISSNO,DOADMNO
          GOTO      MEHDLV91 IF NOT EQUAL
.
          PACK      KEY30,ADMISSNO,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,MEHDLV05
          MATCH     DTADMN,ADMISSNO
          GOTO      MEHDLV05 IF NOT EQUAL
          MATCH     ANSL,TMOVE
          IF        @EQUAL
            MOVE      TDATE,TRANDATE
            MOVE      TTIME,TRANTIME
          ENDIF
.
MEHDLV05  PACK      KEY8,ADMISSNO,SP70      * Check if Visit exists?
          CALL      RDVISA1
          BRANCH    OVRCD,MEHDLV94
.
          PACK      KEY8,ADMISSNO,SP70      * Check if MH Visit exists
          CALL      RDMHVIS1
          BRANCH    OVRCD,MEHDLV98
.
          MOVE      SP70,MHLESTAT           * Check for current Legal Status
          PACK      KEY21,ADMISSNO,Z70
          CALL      RSMHLEG1
          CALL      RPMHLEG1
          BRANCH    OVRCD,MEHDLV06
          MATCH     ADMISSNO,DMHLEADM
          GOTO      MEHDLV08 IF EQUAL
.
.         Try MH referral file
.
MEHDLV06  PACK      KEY16,URNUMBER,SP70
          CALL      RSMHHLS1
          CALL      RKMHHLS1
          BRANCH    OVRCD,MEHDLV93
          MATCH     MHHLURNO,URNUMBER
          GOTO      MEHDLV93 IF NOT EQUAL
.
MEHDLV08  PACK      KEY24,ADMISSNO,TRANDATE,TRANTIME,SP70  * Check for MH Leave
          CALL      RDMHDLV1
          IF        OVRCD=1
            CALL      CLMEHDLV
          ENDIF
.
          MATCH     ANSA,UPDTTYPE
          GOTO      MEHDLV10 IF EQUAL
.
          MOVE      "Mental Health Details",WEBTITLE
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,MEHDLV99

          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      MEHDLV99
.
MEHDLV10  PACK      KEY24,ADMISSNO,TRANDATE,TRANTIME,SP70  * Check for MH Leave
          CALL      RDMHDLV1
          IF        OVRCD=1
            CALL      CLMEHDLV
          ENDIF
.
          CALL      MVDLV000      * Moves input variables to file variables
          MOVE      ADMISSNO,MHDLADMN
          MOVE      TRANDATE,MHDLDATE
          MOVE      TRANTIME,MHDLTIME
          PACK      KEY24,MHDLADMN,MHDLDATE,MHDLTIME,SP70
          CALL      RAMHDLV1
          IF        OVRCD=1
            CALL      WRMHDLV1
          ELSE
            CALL      UPMHDLV1
          ENDIF
          CALL      UPMHVS00
          GOTO      MEHDLV99
.
MEHDLV91  MOVE      "Missing on-leave record. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEHDLV99
.
MEHDLV92  MOVE      "Patient not currently on leave. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEHDLV99
.
MEHDLV93  MOVE      "Can't Find Legal Status record. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEHDLV99
.
MEHDLV94  MOVE      "Can't Find Visit record. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEHDLV99
.
MEHDLV95  MOVE      "Can't Find Master Details",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEHDLV99
.
MEHDLV96  MOVE      "Admission details not found.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEHDLV99
.
MEHDLV97  MOVE      "Can't Find Mental Health Discharge Details",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEHDLV99
.
MEHDLV98  MOVE      "Invalid mental health admission.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEHDLV99
.
MEHDLV99  RETURN
+
.------------------------------------------------------------
. MEHLST00  - Mental Health Legal Status History
.------------------------------------------------------------
MEHLST00  MOVE      URNUMBER,KEY8           * Check if Master file exists
          CALL      RDMAST1
          BRANCH    OVRCD,MEHLST95
.
          PACK      KEY8,ADMISSNO,SP70      * Check if Visit exists?
          CALL      RDVISA1
          BRANCH    OVRCD,MEHLST94
.
          MOVE      ADMISSNO,KEY8           * Read Admission File
          CALL      RDMISS1
          BRANCH    OVRCD,MEHLST96
          BRANCH    ASTAT,MEHLST92,MEHLST04,MEHLST02,MEHLST04
          GOTO      MEHLST92
.
.         Patient discharged - can not have a review option
.
MEHLST02  CALL      RDDSCH1
          BRANCH    OVRCD,MEHLST92
.
MEHLST04  PACK      KEY8,ADMISSNO,SP70      * Check if MH Visit exists
          CALL      RDMHVIS1
          BRANCH    OVRCD,MEHLST98
.
          MATCH     ANSD,UPDTTYPE
          GOTO      MEHLST10 IF EQUAL       * Delete Legal status
.
          MATCH     ANSU,UPDTTYPE
          GOTO      MEHLST20 IF EQUAL       * Change Review Date
.
          CALL      CLRLEG00                * clear mental health legal status
          CALL      CLRREV00                * clear MH review history details
.
          PACK      KEY21,ADMISSNO,LEGLDATE,LEGLTIME
          CALL      RDMHLEG1
.
          PACK      KEY21,ADMISSNO,REVWDATE,REVWTIME
          CALL      RDMHREV1
.
          MOVE      "Mental Health Details",WEBTITLE
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,MEHLST99
          CALL      WEBBOD00           * Process Web Body
          CALL      WEBEND00           * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      MEHLST99
.
MEHLST10  CALL      DELLST00           * Deleting Legal status
          GOTO      MEHLST99
.
MEHLST20  IF        MHRVDECI<>1
            MOVE      MHRVDATE,MEHRV005  * set legal status date/time
            MOVE      MHRVTIME,MEHRV006
          ENDIF
.
          CALL      VREVDT00           * Validate new review date 
          BRANCH    EXIT,MEHLST99
          CALL      VREVTM00           * Validate new review time
          BRANCH    EXIT,MEHLST99
.
          IF        MHRVDECI=1
            CALL      VLEGDT00         * Validate new review status date
            BRANCH    EXIT,MEHLST99
            CALL      VLEGTM00         * Validate new review status date
            BRANCH    EXIT,MEHLST99
          ENDIF
.
          CALL      CHGREV00           * Change Review date
          GOTO      MEHLST99
.
MEHLST92  MOVE      "Patient is not a current Inpatient. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEHLST99
.
MEHLST94  MOVE      "Can't Find Visit record. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEHLST99
.
MEHLST95  MOVE      "Can't Find Master Details",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEHLST99
.
MEHLST96  MOVE      "Admission details not found.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEHLST99
.
MEHLST98  MOVE      "Invalid mental health admission.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEHLST99
.
MEHLST99  RETURN
+
.****************************************************************************
.*                           MEHREV00                                       *
.*                 Deleting legal status                                    *
.****************************************************************************
MEHREV00  MOVE      URNUMBER,KEY8           * Check if Master file exists
          CALL      RDMAST1
          BRANCH    OVRCD,MEHREV95
.
          PACK      KEY8,ADMISSNO,SP70      * Check if Visit exists?
          CALL      RDVISA1
          BRANCH    OVRCD,MEHREV94
.
          MOVE      ADMISSNO,KEY8           * Read Admission File
          CALL      RDMISS1
          BRANCH    OVRCD,MEHREV96
          BRANCH    ASTAT,MEHREV92,MEHREV04,MEHREV02,MEHREV04
.
.         Patient discharged - can not have a review option
.
MEHREV02  CALL      RDDSCH1
          BRANCH    OVRCD,MEHREV92
.
MEHREV04  PACK      KEY8,ADMISSNO,SP70      * Check if MH Visit exists
          CALL      RDMHVIS1
          BRANCH    OVRCD,MEHREV98
.
          MATCH     ANSR,UPDTTYPE
          GOTO      MEHREV10 IF EQUAL
          CALL      CLEG0000                * Get current legal/review status
.
          MOVE      "Mental Health Details",WEBTITLE
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,MEHREV99
          CALL      WEBBOD00           * Process Web Body
          CALL      WEBEND00           * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      MEHREV99
.
MEHREV10  CALL      CLEG0000                * Get current legal/review status
.
.         check rev.date against prev.review date
.
          MATCH     SMHRVDAT,MEHRV002  
          GOTO      MEHREV91 IF LESS
          GOTO      MEHREV12 IF NOT EQUAL
          MATCH     SMHRVTIM,MEHRV003
          GOTO      MEHREV91 IF LESS
.
.         check new status date against prev. review date
.
MEHREV12  MATCH     SMHRVDAT,MEHLG002  
          GOTO      MEHREV93 IF LESS
          GOTO      MEHREV14 IF NOT EQUAL
          MATCH     SMHRVTIM,MEHLG003
          GOTO      MEHREV93 IF LESS
.
.         check next status review date against review date
.
MEHREV14  MATCH     SP70,MEHRV008
          IF        !@EQUAL & !@EOS
            MATCH     MEHRV002,MEHRV008  * check date next review date 
            GOTO      MEHREV90 IF LESS
          ENDIF
.
MEHREV20  CALL      CREV0000           * Updating review legal status
          GOTO      MEHREV99
.
MEHREV90  PACK      WEBTITLE,SP70
          RESET     WEBTITLE
          APPEND    "New Status Review Date must NOT be ",WEBTITLE
          APPEND    "before the Review Date. ",WEBTITLE
          APPEND    SP70,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEHREV99
.
MEHREV91  MOVE      "Review Date must NOT be before last Review Date. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEHREV99
.
MEHREV92  MOVE      "Patient is not a current Inpatient. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEHREV99
.
MEHREV93  MOVE  "New Status Date must NOT be before last Review Date. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEHREV99
.
MEHREV94  MOVE      "Can't Find Visit record. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEHREV99
.
MEHREV95  MOVE      "Can't Find Master Details",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEHREV99
.
MEHREV96  MOVE      "Admission details not found.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEHREV99
.
MEHREV98  MOVE      "Invalid mental health admission.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MEHREV99
.
MEHREV99  RETURN
+
.****************************************************************************
.*                           CLEG0000                                       *
.*                 Get current legal/review status                          *
.****************************************************************************
CLEG0000  CALL      CLMEHLEG                * clear MH Legal status
          CALL      CLMEHREV                * clear MH Legal status review
.
          CALL      CURR0000      * Get date of current legal & review status
.
.         get latest review details
.
          PACK      KEY21,MHVIADMN,Z70
          CALL      RSMHLEG1
          CALL      RPMHLEG1
          BRANCH    OVRCD,CLEG1000
.
          MATCH     MHVIADMN,MHLEADMN
          GOTO      CLEG2000 IF NOT EQUAL
.
CLEG1000  MOVE      SP3,MHLESTAT
          MOVE      MHVIADMN,MHLEADMN
          MOVE      SP8,MHLEDATE
          MOVE      SP5,MHLETIME
          MOVE      SP3,MHLEREVW
CLEG2000  MOVE      MHLEREVW,SAVEREVW         * save original 
.
.         get the current review record  
.
          PACK      KEY21,MHVIADMN,Z70
          CALL      RSMHREV1
          CALL      RPMHREV1
          BRANCH    OVRCD,CLEG5000
.
          MATCH     MHVIADMN,MHRVADMN
          GOTO      CLEG6000 IF NOT EQUAL
.
CLEG5000  MOVE      SP8,MHRVLDAT            * clear date
          MOVE      SP8,MHRVLTIM            * clear date
          MOVE      SP8,MHRVDATE            * clear date
          MOVE      SP5,MHRVTIME            * clear date
          MOVE      MHVIADMN,MHRVADMN
.
CLEG6000  MOVE      SP3,MHRVREAS            * reason for decision
          MOVE      MHRVDATE,SMHRVDAT
          MOVE      MHRVTIME,SMHRVTIM
          MOVE      TWO,MHRVDECI
.
CLEG9999  RETURN
+
.****************************************************************************
.*                           DELLST00                                       *
.*                 Deleting legal status                                    *
.****************************************************************************
DELLST00  PACK      KEY21,ADMISSNO,LEGLDATE,LEGLTIME
          MOVE      KEY21,DIM21
          CALL      RSMHLEG1
          CALL      RPMHLEG1
          BRANCH    OVRCD,DELLST80
          MATCH     MHLEADMN,ADMISSNO
          GOTO      DELLST80 IF NOT EQUAL  * can not delete first record
.
          MOVE      DIM21,KEY21
          CALL      RDMHLEG1
          IF        OVRCD=0
... D CAR 50716 -- Nobody seems to know why this rule was added at first place
... hence removed as per Helen's notes in CAR call notes
....        PACK      KEY5,ANSL,ANSS,MHLESTAT,SP70
....        CALL      RDCODE1
....        IF        OVRCD=0
....          MATCH     "I",TCINDC1
....          GOTO      DELLST70 IF EQUAL  * informal
....        ENDIF
.... END D CAR 50716
            CALL      DEMHLEG1             * delete legal status record
          ELSE
            MOVE      "Invalid Legal Status record",WEBTITLE
            CALL      WEBERR00
            MOVE      ONE,EXIT
            GOTO      DELLST99
          ENDIF
.
.-------- Delete from the Legal Status Review History File
.
          PACK      KEY21,MHLEADMN,SP20
          CALL      RSMHREV1
DELLST40  CALL      RKMHREV1
          BRANCH    OVRCD,DELLST50
.
          MATCH     MHLEADMN,MHRVADMN
          GOTO      DELLST50 IF NOT EQUAL
.
          MATCH     MHLEDATE,MHRVLDAT
          GOTO      DELLST40 IF NOT EQUAL
.
          MATCH     MHLETIME,MHRVLTIM
          GOTO      DELLST40 IF NOT EQUAL
.
          PACK      KEY21,MHRVADMN,MHRVDATE,MHRVTIME,SP20
          CALL      DEMHREV1
.
          GOTO      DELLST40
.
. ------- update patmx1af with current legal status
.
DELLST50  PACK      KEY8,PURNO,SP10 
          CALL      RDMAST1                 * update master file
          BRANCH    OVRCD,DELLST90
.
          PACK      KEY21,ADMISSNO,Z70
          CALL      RSMHLEG1
DELLST60  CALL      RPMHLEG1
          BRANCH    OVRCD,DELLST90
.
. ------- there must be at least one legal status record.
.
          MATCH     ADMISSNO,MHLEADMN
          IF        !@EQUAL
            MOVE      SP10,PTMXLS
            MOVE      SP10,PTMXLSDT
          ELSE
            MOVE      MHLESTAT,PTMXLS
            MOVE      MHLEDATE,PTMXLSDT
          ENDIF
             
          PACK      KEY8,PURNO,SP10
          CALL      UPMAST1                 * update master file
.
          CALL      PMIGTNID                 * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      ONE,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICUP                 * write PMI changes to Datagate
          GOTO      DELLST90
.
DELLST70  MOVE      "Cannot Delete, it's a Legal Status of Informal",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DELLST99
.
DELLST80  MOVE      "Cannot Delete the Patient's First Legal Status. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DELLST99
.
DELLST90  MOVE      ZERO,EXIT
DELLST99  RETURN
+
.****************************************************************************
.*                           VREVDT00                                       *
.*                 Validate review dates                                    *
.****************************************************************************
VREVDT00  MOVE      ZERO,EXIT
          PACK      SAVKEY21,MHRVADMN,MHRVDATE,MHRVTIME    * save key
.
          MATCH     ADATE,MEHRV002
          GOTO      VREVDT10 IF NOT LESS
.
          MOVE      "New Review Date must NOT be before Adm.Date.",WEBTITLE
          CALL      WEBERR00
          GOTO      VREVDT90
.
. Review date must be between review date before and review date after
.
VREVDT10  CALL      RPMHREV1
          IF        OVRCD=1
            MOVE      SAVKEY21,KEY21              * restore record
            CALL      RDMHREV1
          ELSE  
            MATCH     AADMNO,MHRVADMN
            IF        !@EQUAL
              MOVE      SAVKEY21,KEY21              * restore record
              CALL      RDMHREV1
              GOTO      VREVDT20
            ENDIF
            MOVE      MHRVDATE,TEMPDATE
            MOVE      SAVKEY21,KEY21              * restore record
            CALL      RDMHREV1
            MATCH     MEHRV002,TEMPDATE
            GOTO      VREVDT20 IF LESS
            GOTO      VREVDT20 IF EQUAL
.
            PACK      WEBTITLE,SP70
            RESET     WEBTITLE
            APPEND    "New Review Date must NOT be before previous",WEBTITLE
            APPEND    " Review Date.",WEBTITLE
            APPEND    SP70,WEBTITLE
            RESET     WEBTITLE
.
            CALL      WEBERR00
            GOTO      VREVDT90
          ENDIF
.
. check review date after
.
VREVDT20  CALL      RKMHREV1
          IF        OVRCD=1
            MOVE      SAVKEY21,KEY21              * restore record
            CALL      RDMHREV1
            GOTO      VREVDT80
          ELSE  
            MATCH     AADMNO,MHRVADMN
            IF        !@EQUAL
              MOVE      SAVKEY21,KEY21              * restore record
              CALL      RDMHREV1
              GOTO      VREVDT80
            ENDIF
            MOVE      MHRVDATE,TEMPDATE
            MOVE      SAVKEY21,KEY21              * restore record
            CALL      RDMHREV1
            MATCH     TEMPDATE,MEHRV002
            GOTO      VREVDT80 IF LESS
            GOTO      VREVDT80 IF EQUAL
.
            PACK      WEBTITLE,SP70
            RESET     WEBTITLE
            APPEND    "New Review Date must NOT be",WEBTITLE
            APPEND    " after next Review Date",WEBTITLE
            APPEND    SP70,WEBTITLE
            RESET     WEBTITLE
            CALL      WEBERR00
            GOTO      VREVDT90
          ENDIF
.
VREVDT80  MOVE      ZERO,EXIT                     * valid date 
          GOTO      VREVDT99
.
VREVDT90  MOVE      ONE,EXIT                     * invalid date
VREVDT99  RETURN
+
.**************************************************************************
.*  VREVTM00  :  Keyin Review time (Change   review option)               *
.**************************************************************************
VREVTM00  PACK      SAVKEY21,MHRVADMN,MHRVDATE,MHRVTIME    * save key
.
. date keyed in must be >= admission date
.
          MATCH     ADATE,MEHRV002
          GOTO      VREVTM10 IF NOT EQUAL
.
. ------- check the times -------------------------------------------------
.
          MOVE      ATIME,KEY5
          MATCH     MEHRV003,KEY5                  * review time must be >     
          GOTO      VREVTM10 IF LESS              * Ok.
.
          MOVE      "Review Time must NOT be before Admission.",WEBTITLE
          CALL      WEBERR00
          GOTO      VREVTM90
.
. date & time keyed in must be between review date before and review date after
.
. check review date & time before
.
VREVTM10  CALL      RPMHREV1
          IF        OVRCD=1
            MOVE      SAVKEY21,KEY21              * restore record
            CALL      RDMHREV1
          ELSE  
            MATCH     AADMNO,MHRVADMN
            IF        !@EQUAL
              MOVE      SAVKEY21,KEY21              * restore record
              CALL      RDMHREV1
              GOTO      VREVTM50
            ENDIF
            MOVE      MHRVDATE,TEMPDATE
            MOVE      MHRVTIME,TEMPTIME
            MOVE      SAVKEY21,KEY21              * restore record
            CALL      RDMHREV1
            MATCH     MEHRV002,TEMPDATE
            GOTO      VREVTM50 IF NOT EQUAL
            MATCH     MEHRV003,TEMPTIME
            GOTO      VREVTM50 IF LESS 
         MOVE      "New Review Time must NOT be before Previous Review",WEBTITLE
            CALL      WEBERR00
            GOTO      VREVTM90
          ENDIF
.
. check review date after
.
VREVTM50  CALL      RKMHREV1
          IF        OVRCD=1
            MOVE      SAVKEY21,KEY21              * restore record
            CALL      RDMHREV1
            GOTO      VREVTM80
          ELSE  
            MATCH     AADMNO,MHRVADMN
            IF        !@EQUAL
              MOVE      SAVKEY21,KEY21              * restore record
              CALL      RDMHREV1
              GOTO      VREVTM80
            ENDIF
            MOVE      MHRVDATE,TEMPDATE
            MOVE      MHRVTIME,TEMPTIME
            MOVE      SAVKEY21,KEY21              * restore record
            CALL      RDMHREV1
            MATCH     TEMPDATE,MEHRV002
            GOTO      VREVTM80 IF NOT EQUAL
            MATCH     TEMPTIME,MEHRV003
            GOTO      VREVTM80 IF LESS 
.
            PACK      WEBTITLE,SP70,SP70
            RESET     WEBTITLE
            APPEND    "New Review Time must NOT be after",WEBTITLE
            APPEND    " Next Review",WEBTITLE
            APPEND    SP70,WEBTITLE
            RESET     WEBTITLE
.
            CALL      WEBERR00
            GOTO      VREVTM90
          ENDIF
.
VREVTM80  MOVE      ZERO,EXIT                     * valid date
          GOTO      VREVTM99
.
VREVTM90  MOVE      ONE,EXIT                      * invalid date
VREVTM99  RETURN
+
.*********************************************************************
.*                  VLEGDT00                                         *
.*        Validate  Date of new Legal Status                         *
.*********************************************************************
VLEGDT00  PACK      SAVKEY21,MHRVADMN,MHRVLDAT,MHRVLTIM    * save key
.
          MOVE      SAVKEY21,KEY21
          CALL      RDMHLEG1
          UNPACK    MHRVLDAT,CCENT,CYEAR,CMON,CDAY
.
          MATCH     MEHRV005,CURRDATE
          GOTO      VLEGDT10 IF NOT LESS    * valid date
.
          MOVE      "New Status Date must not be in the future.",WEBTITLE
          CALL      WEBERR00
          GOTO      VLEGDT90
.
. date keyed in must be >= admission date
.
VLEGDT10  MATCH     ADATE,MEHRV005
          GOTO      VLEGDT20 IF NOT LESS
.
          MOVE     "New Status Date must NOT be before Admission Date.",WEBTITLE
          CALL      WEBERR00
          GOTO      VLEGDT90
.
. date keyed in must be between legal status date before and legal status
. date after
.
. check review date before
.
VLEGDT20  CALL      RDMHLEG1
          CALL      RPMHLEG1
          IF        OVRCD=1
            MOVE      SAVKEY21,KEY21              * restore record
            CALL      RDMHLEG1
          ELSE  
            MATCH     AADMNO,MHLEADMN
            IF        !@EQUAL
              MOVE      SAVKEY21,KEY21              * restore record
              CALL      RDMHLEG1
              GOTO      VLEGDT80
            ENDIF
            MOVE      MHLEDATE,TEMPDATE
            MOVE      SAVKEY21,KEY21              * restore record
            CALL      RDMHLEG1
            MATCH     MEHRV005,TEMPDATE
            GOTO      VLEGDT50 IF LESS
            GOTO      VLEGDT50 IF EQUAL
.
            PACK      WEBTITLE,SP70,SP70
            RESET     WEBTITLE
            APPEND    "New Status Date must NOT be before",WEBTITLE
            APPEND    " Previous Change Date.",WEBTITLE
            APPEND    SP70,WEBTITLE
            RESET     WEBTITLE
            CALL      WEBERR00
            GOTO      VLEGDT90
          ENDIF
.
. check status date after
.
VLEGDT50  CALL      RKMHLEG1
          IF        OVRCD=1
            MOVE      SAVKEY21,KEY21              * restore record
            CALL      RDMHLEG1
            GOTO      VLEGDT80
          ELSE  
            MATCH     AADMNO,MHLEADMN
            IF        !@EQUAL
              MOVE      SAVKEY21,KEY21              * restore record
              CALL      RDMHLEG1
              GOTO      VLEGDT80
            ENDIF
            MOVE      MHLEDATE,TEMPDATE
            MOVE      SAVKEY21,KEY21              * restore record
            CALL      RDMHLEG1
            MATCH     TEMPDATE,MEHRV005
            GOTO      VLEGDT80 IF LESS
            GOTO      VLEGDT80 IF EQUAL
            MOVE      "New Status Date must NOT be after Next Change.",WEBTITLE
            CALL      WEBERR00
            GOTO      VLEGDT90
          ENDIF
.
VLEGDT80  MOVE      ZERO,EXIT
          GOTO      VLEGDT99
.
VLEGDT90  MOVE      ONE,EXIT
VLEGDT99  RETURN
+
.*********************************************************************
.*                  VLEGTM00                                         *
.*        Validate  Time of new Legal Status                         *
.*********************************************************************
VLEGTM00  PACK      SAVKEY21,MHRVADMN,MHRVLDAT,MHRVLTIM    * save key
.
. check status date before
.
          CALL      RDMHLEG1
          CALL      RPMHLEG1
          IF        OVRCD=1
            MOVE      SAVKEY21,KEY21              * restore record
            CALL      RDMHLEG1
          ELSE  
            MATCH     AADMNO,MHLEADMN
            IF        !@EQUAL
              MOVE      SAVKEY21,KEY21              * restore record
              CALL      RDMHLEG1
              GOTO      VLEGTM50
            ENDIF
            MOVE      MHLEDATE,TEMPDATE
            MOVE      MHLETIME,TEMPTIME
            MOVE      SAVKEY21,KEY21              * restore record
            CALL      RDMHLEG1
            MATCH     MEHRV005,TEMPDATE
            GOTO      VLEGTM50 IF NOT EQUAL
            MATCH     MEHRV006,TEMPTIME
            GOTO      VLEGTM50 IF LESS 
.
            PACK      WEBTITLE,SP70
            APPEND    "New Status Time must NOT be before",WEBTITLE
            APPEND    " Previous Change.",WEBTITLE
            APPEND    SP70,WEBTITLE
            RESET     WEBTITLE
            CALL      WEBERR00
            GOTO      VLEGTM90
          ENDIF
.
. check status date after
.
VLEGTM50  CALL      RKMHLEG1
          IF        OVRCD=1
            MOVE      SAVKEY21,KEY21              * restore record
            CALL      RDMHLEG1
            GOTO      VLEGTM80
          ELSE  
            MATCH     AADMNO,MHLEADMN
            IF        !@EQUAL
              MOVE      SAVKEY21,KEY21              * restore record
              CALL      RDMHLEG1
              GOTO      VLEGTM80
            ENDIF
            MOVE      MHLEDATE,TEMPDATE
            MOVE      MHLETIME,TEMPTIME
            MOVE      SAVKEY21,KEY21              * restore record
            CALL      RDMHLEG1
            MATCH     TEMPDATE,MEHRV005
            GOTO      VLEGTM80 IF NOT EQUAL
            MATCH     TEMPTIME,MEHRV006
            GOTO      VLEGTM80 IF LESS 
            MOVE      "New Status Time must NOT be after next Change.",WEBTITLE
            CALL      WEBERR00
            GOTO      VLEGTM90
          ENDIF
.
VLEGTM80  MOVE      ZERO,EXIT
          GOTO      VLEGTM99
.
VLEGTM90  MOVE      ONE,EXIT
VLEGTM99  RETURN
+
.****************************************************************************
.*                           CHGREV00                                       *
.*                 Change Review details                                    *
.****************************************************************************
CHGREV00  PACK      KEY21,ADMISSNO,REVWDATE,REVWTIME
          CALL      RDMHREV1
          BRANCH    OVRCD,CHGREV99
.
          MOVE      MHRVADMN,SAVEADMN
          MOVE      MHRVDATE,SAVEDATE
          MOVE      MHRVDECI,SAVEDECI
          MOVE      MHRVLDAT,SAVELDAT
          MOVE      MHRVLTIM,SAVELTIM
          MOVE      MHRVREAS,SAVEREAS
          MOVE      MHRVNDAT,SAVENDAT
.
          PACK      KEY21,ADMISSNO,REVWDATE,REVWTIME    * delete record
          CALL      DEMHREV1
.
          MOVE      SAVEADMN,MHRVADMN              * restore variables
          MOVE      SAVEDECI,MHRVDECI
.
          MOVE      MEHRV005,MHRVLDAT
          MOVE      MEHRV006,MHRVLTIM
.
          MOVE      SAVEREAS,MHRVREAS
          MOVE      SAVENDAT,MHRVNDAT
          MOVE      MEHRV002,MHRVDATE
          MOVE      MEHRV003,MHRVTIME
.
          PACK      KEY21,MHRVADMN,MHRVDATE,MHRVTIME
          CALL      RAMHREV1
          IF        OVRCD=0
            CALL      UPMHREV1
          ELSE
            CALL      WRMHREV1
          ENDIF
.
. update legal status file with new date
.
          PACK      KEY21,SAVEADMN,SAVELDAT,SAVELTIM
          CALL      RDMHLEG1
          BRANCH    OVRCD,CHGREV99                * ignore
.
          MOVE      MHLESTAT,SAVELS               * save legal status
          CALL      DEMHLEG1                      * delete old record
.
          MOVE      SAVEADMN,MHLEADMN             * restore variables
          MOVE      MEHRV005,MHLEDATE
          MOVE      MEHRV006,MHLETIME
          MOVE      SAVELS,MHLESTAT 
.
          PACK      KEY21,MHLEADMN,MHLEDATE,MHLETIME
          CALL      RAMHLEG1
          IF        OVRCD=0
            CALL      UPMHLEG1
          ELSE
            CALL      WRMHLEG1
          ENDIF
.
CHGREV99  RETURN
+
.****************************************************************************
.*                           CREV0000                                       *
.*                 Change Review details                                    *
.****************************************************************************
CREV0000  MOVE      ZERO,CHNGLEGL
          MOVE      ZERO,CHNGREVW
.
          COMPARE   ZERO,DECISION            * Decicion is No
          GOTO      CREV6000 IF EQUAL
.
          MATCH     MEHLG004,PTMXLS              * Still same legal status ?
          IF        !@EQUAL
            MOVE      ONE,CHNGLEGL
          ENDIF
.
          MATCH     MEHLG005,SAVEREVW            * Still same review status ?
          IF        !@EQUAL
            MOVE      ONE,CHNGREVW
          ENDIF
.
          MOVE      ADMISSNO,MHRVADMN        * admission number
          MOVE      MEHRV002,MHRVDATE        * review date
          MOVE      MEHRV003,MHRVTIME        * review time
          PACK      KEY21,MHRVADMN,MHRVDATE,MHRVTIME,SP20 *update/write MEHREVFD
          CALL      RDMHREV1
.
          MOVE      ONE,MHRVDECI            * yes to review decision
          MOVE      MEHLG002,MHRVLDAT       * date of new legal status
          MOVE      MEHLG003,MHRVLTIM       * time of new legal status
          MOVE      SP3,MHRVREAS            * reason for decision
          MOVE      MEHRV008,MHRVNDAT       * date of next review
          MOVE      SP20,MHRVSPAR
.
          BRANCH    OVRCD,CREV1100          * write a new record
.
          CALL      UPMHREV1                * update record
          GOTO      CREV1200
.
CREV1100  CALL      WRMHREV1                * write new record
.
.         process MEHVI1FD
.
CREV1200  MOVE      TWO,AUDIFLAG            * before change
          CALL      MHAUDVIS                * write audit
          MOVE      MEHRV008,MHVILSRV       * date of next review
          CALL      UPMHVIS1                * update
          MOVE      THREE,AUDIFLAG          * after change
          CALL      MHAUDVIS                * write audit
.
.         process PATMX1FD
.
.
          MOVE      MEHLG004,PTMXLS         * legal status
          MOVE      MEHLG002,PTMXLSDT       * date of legal status
          CALL      UPMAST1                 * update master file
.
          CALL      PMIGTNID                 * get national id for dgate write
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TWO,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICUP                 * write PMI changes to Datagate
.
.         process MEHLEGFD
.
          MOVE      ADMISSNO,MHLEADMN       * admission number
          MOVE      MEHLG002,MHLEDATE       * date
          MOVE      MEHLG003,MHLETIME       * time
          PACK      KEY21,MHLEADMN,MHLEDATE,MHLETIME,SP20
          CALL      RDMHLEG1    
.
          MOVE      MEHLG004,MHLESTAT       * legal status
          MOVE      MEHLG005,MHLEREVW       * review status
          MOVE      SP20,MHLESPAR
          CALL      SETF0000                * set status change flag
          BRANCH    OVRCD,CREV1300          * write
.
          CALL      UPMHLEG1                * update record
          GOTO      CREV9999
.
CREV1300  MOVE      ADMISSNO,MHLEADMN       * admission number
          MOVE      MEHLG002,MHLEDATE       * date
          MOVE      MEHLG003,MHLETIME       * time
          CALL      WRMHLEG1                * write record
          GOTO      CREV9999
.
.         Review decision is No
.
CREV6000  MOVE      ADMISSNO,MHRVADMN       * admission number
          MOVE      MEHRV002,MHRVDATE        * review date
          MOVE      MEHRV003,MHRVTIME        * review time
          PACK      KEY21,MHRVADMN,MHRVDATE,MHRVTIME,SP20 *update/write MEHREVFD
          CALL      RDMHREV1
.
          MOVE      ZERO,MHRVDECI           * decision = No
          MOVE      MEHRV007,MHRVREAS       * set reason for decision
          MOVE      MEHRV008,MHRVNDAT       * date of next review
          MOVE      MEHRV002,MHRVLDAT       * review date
          MOVE      MEHRV003,MHRVLTIM       * review time
          MOVE      SP20,MHRVSPAR
.
          BRANCH    OVRCD,CREV6100          * write a new record
.
          CALL      UPMHREV1                * update
          GOTO      CREV6200
.
CREV6100  CALL      WRMHREV1                * write
.
.         process MEHVI1FD
.
CREV6200  MOVE      TWO,AUDIFLAG            * before change
          CALL      MHAUDVIS                * write audit
          MOVE      MEHRV008,MHVILSRV        * date of next review
          CALL      UPMHVIS1                * update
          MOVE      THREE,AUDIFLAG          * after change
          CALL      MHAUDVIS                * write audit
.
.         SRF 641581 - Mods to write a new record to the legal status history
.         file if the status is not changed, but is reviewed.
.
...          CALL      IBACLOCK
...          PACK      MHLEDATE,CCC,CYY,CMM,CDD
.
          MOVE      MHRVDATE,MHLEDATE
          REP       " 0",MHLEDATE
          MOVE      MHRVTIME,MHLETIME       * time
          MOVE      ADMISSNO,MHLEADMN       * admission number
          CALL      SETF0000                * set status change flag
          PACK      KEY21,MHLEADMN,MHLEDATE,MHLETIME,SP20
          CALL      RAMHLEG1
          IF        OVRCD=1
            MOVE      "N",MHLESENT
            CALL      WRMHLEG1
          ELSE
            CALL      UPMHLEG1
          ENDIF
.
CREV9999  RETURN
+
.****************************************************************************
.*                           SETF0000                                       *
.*                 Set the status change flag                               *
.****************************************************************************
SETF0000  IF        CHNGLEGL = 0 & CHNGREVW = 0
            MOVE      ANSN,MHLEFLAG              * no status
          ENDIF
          IF        CHNGLEGL = 1 & CHNGREVW = 0
            MOVE      ANSL,MHLEFLAG              * legal status only
          ENDIF
          IF        CHNGLEGL = 1 & CHNGREVW = 1
            MOVE      ANSB,MHLEFLAG              * both statuses
          ENDIF
          IF        CHNGLEGL = 0 & CHNGREVW = 1
            MOVE      ANSR,MHLEFLAG              * review status only
          ENDIF
.
SETF9999  RETURN
+
.------------------------------------------------------------
. Update Mental Health details
.------------------------------------------------------------
UPMHVS00  PACK      KEY8,ADMISSNO
          CALL      RDMHVIS1
          BRANCH    OVRCD,UPMHVS99
.
          MOVE      URNUMBER,MHVIURNO
          MOVE      ADMISSNO,MHVIADMN
          CALL      MVMEH000               * move cgi to file variables
          CALL      UPMHVIS1
.
.         MOVE      ADMISSNO,MHLEADMN
.         PACK      KEY21,MHLEADMN,MHLEDATE,MHLETIME
.         CALL      RDMHLEG1
.         IF        OVRCD=1
.           MOVE      ADMISSNO,MHLEADMN
.           MOVE      MEHVS034,MHLESTAT
.           MOVE      ANSN,MHLESENT
.           MOVE      SP70,MHLEREVW
.           MOVE      ANSL,MHLEFLAG
.           CALL      WRMHLEG1
.         ELSE
.           MOVE      MEHVS034,MHLESTAT
.           CALL      UPMHLEG1
.         ENDIF
.
.         PACK      KEY8,URNUMBER
.         CALL      RDMAST1
.         BRANCH    OVRCD,UPMHVS99
.         MOVE      MHLEDATE,PTMXLSDT
.         MOVE      MHLESTAT,PTMXLS
.         CALL      UPMAST1
.
UPMHVS99  RETURN
+
.******************************************************************************
. PMPL0000   PRIMHD Patient leve list output routine                          .
.******************************************************************************
PMPL0000  BRANCH    FLDITMNO,PMPL0010,PMPL0020,PMPL0030
          WRITE     HTMLFILE;"Invalid Tag - MEHWEB01";
          GOTO      PMPL9999
.
PMPL0010  CALL      BYPY0000                * Patient List of PRIMHD xmits
          GOTO      PMPL9999
.
PMPL0020  WRITE     HTMLFILE;FILTTYPE;      * PRIMHD Record Type Filter
          GOTO      PMPL9999
.
PMPL0030  WRITE     HTMLFILE;FILTSTAT;      * PRIMHD status filter
          GOTO      PMPL9999
.
PMPL9999  RETURN
+
.******************************************************************************
. BYPY0000    List by Patient/Admission                                       .
.******************************************************************************
BYPY0000  MOVE      ZERO,EXIT
          MATCH     "1",FILTTYPE            * select Record Type as per Filter
          GOTO      BYPY5000 IF EQUAL       * "1" is Referrals only
.
.                                           * extract Legal Status for this UR
          PACK      KEY30,URNUMBER,SP30
          CALL      RSMHPLS3
BYPY1000  CALL      RKMHPLS3
          BRANCH    OVRCD,BYPY5000
.
          MATCH     URNUMBER,MHPSURNO
          GOTO      BYPY5000 IF NOT EQUAL
.
          MATCH     SP1,FILTSTAT
          IF        !@EQUAL
            MATCH     FILTSTAT,MHPSSTAT
            GOTO      BYPY1000 IF NOT EQUAL
          ENDIF
.
.
          CLEAR     HTMLLINK
          APPEND    "javascript:LegalStatusLink('",HTMLLINK
          APPEND    MHPSVISN,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          CLEAR     HTMLLNK9
          APPEND    "javascript:ViewErrors('",HTMLLNK9
          APPEND    MHPSXDAT,HTMLLNK9
          APPEND    MHPSXNUM,HTMLLNK9
          APPEND    "','",HTMLLNK9
          APPEND    MHPSVISN,HTMLLNK9
          APPEND    "','LS",HTMLLNK9
          APPEND    "')",HTMLLNK9
          RESET     HTMLLNK9
.
          MOVE      "Legal Status",DIM12A
          MOVE      MHPSSTAT,F1
          LOAD      PMHDSTAT,F1,SENT,REJECT,ACCEPT
          MOVE      "1",KEY1
          MOVE      " / ",DIM3A
          MATCH     SP3,MHPSECNT
          IF        @EQUAL
            MATCH     SP3,MHPSWCNT
            IF        @EQUAL
              MOVE      "0",KEY1
              MOVE      SP3,DIM3A
            ENDIF
          ENDIF
          PACK      DIM10A,MHPSECNT,DIM3A,MHPSWCNT            * Err/Warn count
          UNPACK    MHPSSDAT,DIM4A,DIM1A,DIM2A,DIM1B,DIM2B
          PACK      DIM8A,DIM4A,DIM2A,DIM2B                   * Start date
          UNPACK    MHPSEDAT,DIM4A,DIM1A,DIM2A,DIM1B,DIM2B
          PACK      DIM8B,DIM4A,DIM2A,DIM2B                   * End date
.
          UNPACK    MHPSDELT,DIM1
          REP       " 1F1T2D2",DIM1
          MATCH     "2",DIM1
          IF        @EQUAL
            MOVE      "Deleted",MHPSDELT
          ELSE
            MOVE      SP10,MHPSDELT
          ENDIF
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":       0
                           "#"",MHPSXDAT,"#",":                  1
                           "#"",DIM12A,"#",":                    2
                           "#"",PMHDSTAT,"#",":                  3
                           "#"",DIM10A,"#",":                    4
                           "#"",SP10,"#",":                      5
                           "#"",SP10,"#",":                      6
                           "#"",DIM8A,"#",":                     7
                           "#"",DIM8B,"#",":                     8
                           "#"",MHPSDELT,"#",":                  9
                           "#"",HTMLLNK9,"#",":                  10
                           "#"",KEY1,"#");"                *     11
          GOTO      BYPY1000
.
.
BYPY5000  MATCH     "2",FILTTYPE            * select Record Type as per Filter
          GOTO      BYPY9999 IF EQUAL       * "2" is Legal Status only
.
.                                           * extract Referral for this UR
          PACK      KEY19,ADMISSNO,SP30
          CALL      RSMHPRD2
BYPY6000  CALL      RKMHPRD2
          BRANCH    OVRCD,BYPY9000
.
          MATCH     URNUMBER,MHPDURNO
          GOTO      BYPY9000 IF NOT EQUAL
.
          MATCH     SP1,FILTSTAT
          IF        !@EQUAL
            MATCH     FILTSTAT,MHPDSTAT
            GOTO      BYPY6000 IF NOT EQUAL
          ENDIF
.
.
          CLEAR     HTMLLINK
          APPEND    "javascript:ReferralLink('",HTMLLINK
          APPEND    MHPDVISN,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.                                            *
          CLEAR     HTMLLNK9
          APPEND    "javascript:ViewErrors('",HTMLLNK9
          APPEND    MHPDXDAT,HTMLLNK9
          APPEND    MHPDXNUM,HTMLLNK9
          APPEND    "','",HTMLLNK9
          APPEND    MHPDVISN,HTMLLNK9
          APPEND    "','RD",HTMLLNK9
          APPEND    "')",HTMLLNK9
          RESET     HTMLLNK9
.
          MOVE      "Referral",DIM12A
          MOVE      MHPDSTAT,F1
          LOAD      PMHDSTAT,F1,SENT,REJECT,ACCEPT
          MOVE      "1",KEY1                                   * Icon On/Off
          MOVE      " / ",DIM3A
          MATCH     SP3,MHPDECNT
          IF        @EQUAL
            MATCH     SP3,MHPDWCNT
            IF        @EQUAL
              MOVE      "0",KEY1
              MOVE      SP3,DIM3A
            ENDIF
          ENDIF
          PACK      DIM10A,MHPDECNT,DIM3A,MHPDWCNT             * Err/Warn count
          UNPACK    MHPDRSTR,DIM4A,DIM1A,DIM2A,DIM1B,DIM2B
          PACK      DIM8A,DIM4A,DIM2A,DIM2B                    * Start date
          UNPACK    MHPDREND,DIM4A,DIM1A,DIM2A,DIM1B,DIM2B
          PACK      DIM8B,DIM4A,DIM2A,DIM2B                    * End date
.
          UNPACK    MHPDDELT,DIM1
          REP       " 1F1T2D2",DIM1
          MATCH     "2",DIM1
          IF        @EQUAL
            MOVE      "Deleted",MHPDDELT
          ELSE
            MOVE      SP10,MHPDDELT
          ENDIF
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":       0
                           "#"",MHPDXDAT,"#",":                  1
                           "#"",DIM12A,"#",":                    2
                           "#"",PMHDSTAT,"#",":                  3
                           "#"",DIM10A,"#",":                    4
                           "#"",MHPDRFFR,"#",":                  5
                           "#"",MHPDRFTO,"#",":                  6
                           "#"",DIM8A,"#",":                     7
                           "#"",DIM8B,"#",":                     8
                           "#"",MHPDDELT,"#",":                  9
                           "#"",HTMLLNK9,"#",":                  10
                           "#"",KEY1,"#");"                *     11
          GOTO      BYPY6000
.
BYPY9000  MOVE      ZERO,EXIT
BYPY9999  RETURN
.
.******************************************************************************
. MHDLS000   Mental Health Visit level Diagnosis List                         .
.******************************************************************************
MHDLS000  BRANCH    FLDITMNO,MHDLS100,MHDLS200,MHDLS300,MHDLS400
.
          WRITE     HTMLFILE;"Invalid Tag - MHDLS000";
          GOTO      MHDLS999
.         
MHDLS100  CALL      MHDLX000                * Mental Health Diagnosis List
          GOTO      MHDLS999
.
MHDLS200  CALL      MHRAC000                * Mental Health Referral Activity
          GOTO      MHDLS999
.
MHDLS300  CALL      MHREA000                * Mental Health Referral Earliest
          GOTO      MHDLS999                * Activity Date
.
MHDLS400  CALL      MHDLU000                * All Mental Health Diagnosis List  
          GOTO      MHDLS999                                
.
MHDLS999  RETURN
.
.******************************************************************************
. MHDLX000    List by MH Visit/Diagnosis Date                                  .
.******************************************************************************
MHDLX000  MOVE      ZERO,EXIT
.
          MOVE      ZERO,F1
          UNPACK    DIM127,D1,D1,DIM127
          MOVE      D1,F1
.
          CALL      MHDLXH00
.                                           * extract Mental Health Diagnosis  
          PACK      KEY16,ADMISSNO,Z30      * (lastest first)
          CALL      RSMHDIA1
MHDLX100  CALL      RPMHDIA1
          BRANCH    OVRCD,MHDLX999
.
          MATCH     ADMISSNO,DMHDIADM
          GOTO      MHDLX999 IF NOT EQUAL
.
          PACK      DIM30A,MHDIICD1,MHDIICD2,MHDIX1CA,MHDIX2CA,SP30
          MATCH     SP30,DIM30A
          GOTO      MHDLX100 IF EQUAL
.
          MOVE      MHDIDATE,KEY8           * Diag. Date
          CALL      MEHDAT00                * reformat date (KEY8 ==> KEY12)
          MOVE      KEY12,DIM12A
.
          MOVE      "<br>",KEY4
          MOVE      " - ",KEY3              * ICD 10 Code + Description
          PACK      DIM60A,MHDIICD1,KEY3,MHDIDES1
          PACK      DIM60B,SP70
          MATCH     SP9,MHDIICD2
          IF        !@EQUAL
            PACK      DIM60B,KEY4,MHDIICD2,KEY3,MHDIDES2
          ENDIF
          PACK      DIM60C,SP70
          MATCH     SP9,MHDIICD3
          IF        !@EQUAL
            PACK      DIM60C,KEY4,MHDIICD3,KEY3,MHDIDES3
          ENDIF
          PACK      DIM60D,SP70
          MATCH     SP9,MHDIICD4
          IF        !@EQUAL
            PACK      DIM60D,KEY4,MHDIICD4,KEY3,MHDIDES4
          ENDIF
          PACK      DIM60E,SP70
          MATCH     SP9,MHDIICD5
          IF        !@EQUAL
            PACK      DIM60E,KEY4,MHDIICD5,KEY3,MHDIDES5
          ENDIF
          PACK      DIM60F,SP70
          MATCH     SP9,MHDIICD6
          IF        !@EQUAL
            PACK      DIM60F,KEY4,MHDIICD6,KEY3,MHDIDES6
          ENDIF
.
          PACK      DIM100A,SP70,SP70
          MOVE      MHDIDAT1,KEY8           * ICD 10 Date/s
          CALL      MEHDAT00                * reformat date (KEY8 ==> KEY12)
          MOVE      KEY12,DIM12B
          MOVE      KEY12,DIM100A
          MOVE      MHDIDAT2,KEY8
          CALL      MEHDAT00                * reformat date (KEY8 ==> KEY12)
          MATCH     SP9,MHDIICD2
          IF        !@EQUAL
            PACK      DIM100A,DIM100A,KEY4,KEY12
          ENDIF
          MOVE      MHDIDAT3,KEY8
          CALL      MEHDAT00                * reformat date (KEY8 ==> KEY12)
          MATCH     SP8,MHDIICD3
          IF        !@EQUAL
            PACK      DIM100A,DIM100A,KEY4,KEY12
          ENDIF
          MOVE      MHDIDAT4,KEY8
          CALL      MEHDAT00                * reformat date (KEY8 ==> KEY12)
          MATCH     SP8,MHDIICD4
          IF        !@EQUAL
            PACK      DIM100A,DIM100A,KEY4,KEY12
          ENDIF
          MOVE      MHDIDAT5,KEY8
          CALL      MEHDAT00                * reformat date (KEY8 ==> KEY12)
          MATCH     SP8,MHDIICD5
          IF        !@EQUAL
            PACK      DIM100A,DIM100A,KEY4,KEY12
          ENDIF
          MOVE      MHDIDAT6,KEY8
          CALL      MEHDAT00                * reformat date (KEY8 ==> KEY12)
          MATCH     SP8,MHDIICD6
          IF        !@EQUAL
            PACK      DIM100A,DIM100A,KEY4,KEY12
          ENDIF
.
          PACK      DIM80A1,AXISI,MHDIX1CA,KEY3,MHDIX1DA
          PACK      DIM80A2,SP70
          MATCH     SP9,MHDIX1CB
          IF        !@EQUAL
            PACK      DIM80A2,KEY4,AXISI,MHDIX1CB,KEY3,MHDIX1DB
          ENDIF
          PACK      DIM80A3,SP70
          MATCH     SP9,MHDIX1CC
          IF        !@EQUAL
            PACK      DIM80A3,KEY4,AXISI,MHDIX1CC,KEY3,MHDIX1DC
          ENDIF
          PACK      DIM80B1,SP70
          MATCH     SP9,MHDIX2CA
          IF        !@EQUAL
            PACK      DIM80B1,KEY4,AXISII,MHDIX2CA,KEY3,MHDIX2DA
          ENDIF
          PACK      DIM80B2,SP70
          MATCH     SP9,MHDIX2CB
          IF        !@EQUAL
            PACK      DIM80B2,KEY4,AXISII,MHDIX2CB,KEY3,MHDIX2DB
          ENDIF
          PACK      DIM80B3,SP70
          MATCH     SP9,MHDIX2CC
          IF        !@EQUAL
            PACK      DIM80B3,KEY4,AXISII,MHDIX2CC,KEY3,MHDIX2DC
          ENDIF
.
          MOVE      MHDIXDAT,KEY8           * Latest DSMIVR Date
          CALL      MEHDAT00                * reformat date (KEY8 ==> KEY12)
          MOVE      KEY12,DIM12C
.
          MOVE      SP70,DOCFNAME
          MATCH     SP70,MHDIHCPC           * Get Responsible HCP
          GOTO      MHDLX200 IF EQUAL
.
          MOVE      SP70,DOCFNAME
          PACK      KEY10,MHDIHCPC,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,MHDLX200
          MOVE      PMHCTITL,FMTTITLE
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000                * written to DOCFNAME
.
MHDLX200  PACK      DIM40,SP70
          MATCH     SP70,MHDICAST           * Get Case Team details
          GOTO      MHDLX210 IF EQUAL
.
          MOVE      "Unknown Case Team",DIM40
.
          PACK      KEY10,MHDICAST,SP10
          CALL      RDALCAS1
          BRANCH    OVRCD,REFC2250
          MOVE      ALCADESC,DIM40
.
MHDLX210  MATCH     "1",MHCNHDDS
          GOTO      MHDLX500 IF EQUAL
.
          IF        F1 = 1
            WRITE     HTMLFILE;"<tr><td><a href=#"":
                             "javascript:linkMHDiagnosis('",URNUMBER:
                             "','",DMHDIADM:
                             "','",DIM12A,"')#">":
                             "<img src=../images/MaintenanceIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             DIM12A,"</td>":
                             "<td>",DIM60A,DIM60B,DIM60C:
                                    DIM60D,DIM60E,DIM60F,"</td>":
                             "<td>",DIM100A,"</td>":
                             "<td>",DIM80A1,DIM80A2,DIM80A3:
                                    DIM80B1,DIM80B2,DIM80B3,"</td>":
                             "<td>",DIM12C,"</td>":
                             "<td>",DOCFNAME,"</td>":
                             "<td>",DIM40,"</td></tr>"             *    7
.
          ELSE
            WRITE     HTMLFILE;"<tr><td>",DIM12A,"</td>":              1
                             "<td>",DIM60A,DIM60B,DIM60C:
                                    DIM60D,DIM60E,DIM60F,"</td>":
                             "<td>",DIM100A,"</td>":
                             "<td>",DIM80A1,DIM80A2,DIM80A3:
                                    DIM80B1,DIM80B2,DIM80B3,"</td>":
                             "<td>",DIM12C,"</td>":
                             "<td>",DOCFNAME,"</td>":
                             "<td>",DIM40,"</td></tr>"             *    7
          ENDIF
.
          GOTO      MHDLX100
.
MHDLX500  IF        F1 = 1
            WRITE     HTMLFILE;"<tr><td><a href=#"":
                             "javascript:linkMHDiagnosis('",URNUMBER:
                             "','",DMHDIADM:
                             "','",DIM12A,"')#">":
                             "<img src=../images/MaintenanceIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             DIM12A,"</td>":
                             "<td>",DIM60A,DIM60B,DIM60C:
                                    DIM60D,DIM60E,DIM60F,"</td>":
                             "<td>",DIM100A,"</td>":
                             "<td>",DOCFNAME,"</td>":
                             "<td>",DIM40,"</td></tr>"             *    7
.
          ELSE
            WRITE     HTMLFILE;"<tr><td>",DIM12A,"</td>":              1
                             "<td>",DIM60A,DIM60B,DIM60C:
                                    DIM60D,DIM60E,DIM60F,"</td>":
                             "<td>",DIM100A,"</td>":
                             "<td>",DOCFNAME,"</td>":
                             "<td>",DIM40,"</td></tr>"             *    7
          ENDIF
.
          GOTO      MHDLX100
.
MHDLX999  RETURN
.
.-------------------------------------------------------------------------
.
.-------------------------------------------------------------------------
MHDLXH00  WRITE     HTMLFILE;"<tr>":
                        "<td class=#"HeadingCell#" width=#"10%#"":
                        "> Action Date</td>":
                        "<td class=#"HeadingCell#"":
                        ">ICD Codes</td>":
                        "<td class=#"HeadingCell#" width=#"10%#"":
                        ">ICD Codes Dates</td>";
.
          MATCH     "1",MHCNHDDS
          GOTO      MHDLXH50 IF EQUAL
. 
          WRITE     HTMLFILE;"<td class=#"HeadingCell#"":
                        ">Axis I & II</td>":
                        "<td class=#"HeadingCell#" width=#"10%#"":
                        ">Latest DSMIVR Date</td>";
.
MHDLXH50  WRITE     HTMLFILE;"<td class=#"HeadingCell#"":
                        ">Responsible HCP</td>":
                        "<td class=#"HeadingCell#"":
                        ">Case Team</td></tr>"
.
MHDLXH99  RETURN
+
.******************************************************************************
. MHDLU000    List All MH Diagnosis Details                                   .
.******************************************************************************
MHDLU000  MOVE      ZERO,EXIT
.
          MOVE      ZERO,F1
          UNPACK    DIM127,D1,D1,DIM127
          MOVE      D1,F1
.
          IF        F1 = 1
            CALL      MHDLUH00
          ENDIF
.
          PACK      KEY24,URNUMBER,Z30
          CALL      RSMHDIA2
MHDLU100  CALL      RPMHDIA2 
          BRANCH    OVRCD,MHDLU999
.
          MATCH     URNUMBER,MHDIURNO   
          GOTO      MHDLU999 IF NOT EQUAL
.
          PACK      DIM30A,MHDIICD1,MHDIICD2,MHDIX1CA,MHDIX2CA,SP30
          MATCH     SP30,DIM30A
          GOTO      MHDLU100 IF EQUAL
.
          MOVE      MHDIDATE,KEY8           * Diag. Date
          CALL      MEHDAT00                * reformat date (KEY8 ==> KEY12)
          MOVE      KEY12,DIM12A
.
          PACK      KEY8,DMHDIADM,SP70      * Visit Type
          CALL      RDVISA1
          IF        OVRCD<>1
            MATCH     " 3",PTVITYPE
            IF        @EQUAL
              MOVE      "IP",VISTTYPE
            ENDIF
.
            MATCH     "10",PTVITYPE
            IF        @EQUAL 
              MOVE      "RF",VISTTYPE	  
            ENDIF
          ENDIF
.
          MOVE      "<br>",KEY4
          MOVE      " - ",KEY3              * ICD 10 Code + Description
          PACK      DIM60A,MHDIICD1,KEY3,MHDIDES1
          PACK      DIM60B,SP70
          MATCH     SP9,MHDIICD2
          IF        !@EQUAL
            PACK      DIM60B,KEY4,MHDIICD2,KEY3,MHDIDES2
          ENDIF
          PACK      DIM60C,SP70
          MATCH     SP9,MHDIICD3
          IF        !@EQUAL
            PACK      DIM60C,KEY4,MHDIICD3,KEY3,MHDIDES3
          ENDIF
          PACK      DIM60D,SP70
          MATCH     SP9,MHDIICD4
          IF        !@EQUAL
            PACK      DIM60D,KEY4,MHDIICD4,KEY3,MHDIDES4
          ENDIF
          PACK      DIM60E,SP70
          MATCH     SP9,MHDIICD5
          IF        !@EQUAL
            PACK      DIM60E,KEY4,MHDIICD5,KEY3,MHDIDES5
          ENDIF
          PACK      DIM60F,SP70
          MATCH     SP9,MHDIICD6
          IF        !@EQUAL
            PACK      DIM60F,KEY4,MHDIICD6,KEY3,MHDIDES6
          ENDIF
.
          PACK      DIM100A,SP70,SP70
          MOVE      MHDIDAT1,KEY8           * ICD 10 Date/s
          CALL      MEHDAT00                * reformat date (KEY8 ==> KEY12)
          MOVE      KEY12,DIM12B
          MOVE      KEY12,DIM100A
          MOVE      MHDIDAT2,KEY8
          CALL      MEHDAT00                * reformat date (KEY8 ==> KEY12)
          MATCH     SP9,MHDIICD2
          IF        !@EQUAL
            PACK      DIM100A,DIM100A,KEY4,KEY12
          ENDIF
          MOVE      MHDIDAT3,KEY8
          CALL      MEHDAT00                * reformat date (KEY8 ==> KEY12)
          MATCH     SP8,MHDIICD3
          IF        !@EQUAL
            PACK      DIM100A,DIM100A,KEY4,KEY12
          ENDIF
          MOVE      MHDIDAT4,KEY8
          CALL      MEHDAT00                * reformat date (KEY8 ==> KEY12)
          MATCH     SP8,MHDIICD4
          IF        !@EQUAL
            PACK      DIM100A,DIM100A,KEY4,KEY12
          ENDIF
          MOVE      MHDIDAT5,KEY8
          CALL      MEHDAT00                * reformat date (KEY8 ==> KEY12)
          MATCH     SP8,MHDIICD5
          IF        !@EQUAL
            PACK      DIM100A,DIM100A,KEY4,KEY12
          ENDIF
          MOVE      MHDIDAT6,KEY8
          CALL      MEHDAT00                * reformat date (KEY8 ==> KEY12)
          MATCH     SP8,MHDIICD6
          IF        !@EQUAL
            PACK      DIM100A,DIM100A,KEY4,KEY12
          ENDIF
.
          PACK      DIM80A1,AXISI,MHDIX1CA,KEY3,MHDIX1DA
          PACK      DIM80A2,SP70
          MATCH     SP9,MHDIX1CB
          IF        !@EQUAL
            PACK      DIM80A2,KEY4,AXISI,MHDIX1CB,KEY3,MHDIX1DB
          ENDIF
          PACK      DIM80A3,SP70
          MATCH     SP9,MHDIX1CC
          IF        !@EQUAL
            PACK      DIM80A3,KEY4,AXISI,MHDIX1CC,KEY3,MHDIX1DC
          ENDIF
          PACK      DIM80B1,SP70
          MATCH     SP9,MHDIX2CA
          IF        !@EQUAL
            PACK      DIM80B1,KEY4,AXISII,MHDIX2CA,KEY3,MHDIX2DA
          ENDIF
          PACK      DIM80B2,SP70
          MATCH     SP9,MHDIX2CB
          IF        !@EQUAL
            PACK      DIM80B2,KEY4,AXISII,MHDIX2CB,KEY3,MHDIX2DB
          ENDIF
          PACK      DIM80B3,SP70
          MATCH     SP9,MHDIX2CC
          IF        !@EQUAL
            PACK      DIM80B3,KEY4,AXISII,MHDIX2CC,KEY3,MHDIX2DC
          ENDIF
.
          MOVE      MHDIXDAT,KEY8           * Latest DSMIVR Date
          CALL      MEHDAT00                * reformat date (KEY8 ==> KEY12)
          MOVE      KEY12,DIM12C
.
          MOVE      SP70,DOCFNAME
          MATCH     SP70,MHDIHCPC           * Get Responsible HCP
          GOTO      MHDLU200 IF EQUAL
.
          MOVE      SP70,DOCFNAME
          PACK      KEY10,MHDIHCPC,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,MHDLU200
          MOVE      PMHCTITL,FMTTITLE
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000                * written to DOCFNAME
.
MHDLU200  PACK      DIM40,SP70
          MATCH     SP70,MHDICAST
          GOTO      MHDLU210 IF EQUAL
.
          MOVE      "Unknown Case Team",DIM40
.
          PACK      KEY10,MHDICAST,SP10
          CALL      RDALCAS1
          BRANCH    OVRCD,REFC2250
          MOVE      ALCADESC,DIM40
.
MHDLU210  MATCH     "1",MHCNHDDS
          GOTO      MHDLU500 IF EQUAL
.
          IF        F1 = 1
            WRITE     HTMLFILE;"<tr><td><a href=#"":
                     "javascript:linkMHDiagnosis('",URNUMBER:
                               "','",DMHDIADM:
                               "','",DIM12A,"')#">":
                     "<img src=../images/MaintenanceIcon.gif hspace=4":
                              " border=0 align=absmiddle></a>":
                                    DIM12A,"</td>":
                             "<td>",DMHDIADM,"</td>":
                             "<td>",VISTTYPE,"</td>":
                             "<td>",DIM60A,DIM60B,DIM60C:
                                    DIM60D,DIM60E,DIM60F,"</td>":
                             "<td>",DIM100A,"</td>":
                             "<td>",DIM80A1,DIM80A2,DIM80A3:
                                    DIM80B1,DIM80B2,DIM80B3,"</td>":
                             "<td>",DIM12C,"</td>":
                             "<td>",DOCFNAME,"</td>":
                             "<td>",DIM40,"</td></tr>"                   
.
          ELSE
            WRITE     HTMLFILE;"t.addRow(#"",DIM12A,"#",":                   
                                      "#"",DMHDIADM,"#",":                  
                                      "#"",VISTTYPE,"#",":
                 "#"",DIM60A,DIM60B,DIM60C,DIM60D,DIM60E,DIM60F,"#",":
                                      "#"",DIM100A,"#",":
              "#"",DIM80A1,DIM80A2,DIM80A3,DIM80B1,DIM80B2,DIM80B3,"#",": 
                                      "#"",DIM12C,"#",":
                                      "#"",DOCFNAME,"#",":
                                      "#"",DIM40,"#");"
          ENDIF
.
          GOTO      MHDLU100
.
MHDLU500  IF        F1 = 1
            WRITE     HTMLFILE;"<tr><td><a href=#"":
                             "javascript:linkMHDiagnosis('",URNUMBER:
                             "','",DMHDIADM:
                             "','",DIM12A,"')#">":
                             "<img src=../images/MaintenanceIcon.gif hspace=4":
                             " border=0 align=absmiddle></a>":
                             DIM12A,"</td>":
                             "<td>",DMHDIADM,"</td>":
                             "<td>",VISTTYPE,"</td>":
                             "<td>",DIM60A,DIM60B,DIM60C:
                                    DIM60D,DIM60E,DIM60F,"</td>":
                             "<td>",DIM100A,"</td>":
                             "<td>",DOCFNAME,"</td>":
                             "<td>",DIM40,"</td></tr>"      
.
          ELSE
            WRITE     HTMLFILE;"t.addRow(#"",DIM12A,"#",":
                                      "#"",DMHDIADM,"#",":
                                      "#"",VISTTYPE,"#",":
                 "#"",DIM60A,DIM60B,DIM60C,DIM60D,DIM60E,DIM60F,"#",":
                                      "#"",DIM100A,"#",":
                                      "#"",DOCFNAME,"#",":
                                      "#"",DIM40,"#");"
          ENDIF
.
          GOTO      MHDLU100
.
MHDLU999  RETURN
.-------------------------------------------------------------------------
.
.-------------------------------------------------------------------------
MHDLUH00  WRITE     HTMLFILE;"<tr>":
                        "<td class=#"HeadingCell#" width=#"10%#"":
                        "> Action Date</td>":
                        "<td class=#"HeadingCell#" width=#"1%#"":
                        "> Visit</td>":
                        "<td class=#"HeadingCell#" width=#"1%#"":
                        "> Type</td>":
                        "<td class=#"HeadingCell#"":
                        ">ICD Codes</td>":
                        "<td class=#"HeadingCell#" width=#"10%#"":
                        ">ICD Codes Dates</td>";
.
          MATCH     "1",MHCNHDDS
          GOTO      MHDLUH50 IF EQUAL
.
          WRITE     HTMLFILE;"<td class=#"HeadingCell#"":
                        ">Axis I & II Codes</td>":
                        "<td class=#"HeadingCell#" width=#"10%#"":
                        ">Latest DSMIVR Date</td>";
.
MHDLUH50  WRITE     HTMLFILE;"<td class=#"HeadingCell#"":
                        ">Responsible HCP</td>":
                        "<td class=#"HeadingCell#"":
                        ">Case Team</td></tr>"
.
MHDLUH99  RETURN
+
.-------------------------------------------------------------------------
.
.-------------------------------------------------------------------------
.
MEHDAT00  UNPACK    SP20,KEY12
          MATCH     SP8,KEY8
          IF        @EQUAL
            MOVE      "&nbsp;",KEY12
          ELSE
            UNPACK    KEY8,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      KEY12,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
MEHDAT99  RETURN
.------------------------------------------------------------
. Clear patient visit variables
.------------------------------------------------------------
CLPV0000  MOVE      SP70,PVIDATE
          MOVE      SP70,PVIDOCT
          MOVE      SP70,PVILOCK
          MOVE      SP70,PVISITE
          MOVE      SP70,PVIRESI
          MOVE      ZERO,PVITYPE
          MOVE      ZERO,PVITRAN
          MOVE      ZERO,PVISTAT

          MOVE      SP70,PVISYST
          MOVE      SP70,PMVXVISN
          MOVE      SP70,PMVXVSDT
          MOVE      SP70,PMVXDOCA
          MOVE      SP70,PMVXDOCT
          MOVE      SP70,PMVXCSNR
          MOVE      SP70,PMVXPOST
          MOVE      SP70,PMVXPIND
          MOVE      SP70,PMVXVLOC
          MOVE      SP70,PMVXCFSG
          MOVE      SP70,PMVXINGP
          MOVE      SP70,PMVXCPTH
          MOVE      SP70,PMVXHCP1
          MOVE      SP70,PMVXHCP2
          MOVE      SP70,PMVXHCP3
          MOVE      SP70,PMVXHCP4
          MOVE      SP70,PMVXRHC1
          MOVE      SP70,PMVXRH1G
          MOVE      SP70,PMVXRH1C
          MOVE      SP70,PMVXRHC2
          MOVE      SP70,PMVXRH2G
          MOVE      SP70,PMVXRH2C
          MOVE      SP70,PMVXRHC3
          MOVE      SP70,PMVXRH3G
          MOVE      SP70,PMVXRH3C
          MOVE      SP70,PMVXRHC4
          MOVE      SP70,PMVXRH4G
          MOVE      SP70,PMVXRH4C
          MOVE      SP70,PMVXABRG
          MOVE      SP70,PMVXCADM
          MOVE      SP70,PMVXIRAD
          MOVE      SP70,PMVXIDUS
          MOVE      SP70,PMVXCRAV
          MOVE      SP70,PMVXRCCT
          MOVE      SP70,PMVXAPWD
          MOVE      SP70,PMVXAPBD
          MOVE      SP70,PMVXPOWD
          MOVE      SP70,PMVXPOBD
          MOVE      SP70,PMVXPSTY
          MOVE      SP70,PMVXVALW
          MOVE      SP70,PMVXPALW
          MOVE      SP70,PMVXINDC
          MOVE      SP70,PMVXMDAV
          MOVE      SP70,PMVXFRMS
          MOVE      SP70,PMVXCSNG
          MOVE      ZERO,PMVXPWGT
          MOVE      ZERO,PMVXPHGT
          MOVE      SP70,PMVXDHWR
          MOVE      SP70,PMVXEDC1
          MOVE      SP70,PMVXEDC2
          MOVE      SP70,PMVXEDC3
          MOVE      SP70,PMVXHOME
          MOVE      SP70,PMVXUDF1
          MOVE      SP70,PMVXUDF2
          MOVE      SP70,PMVXUDF3
          MOVE      SP70,PMVXUDF4
          MOVE      SP70,PMVXUDT1
          MOVE      SP70,PMVXUDT2
          MOVE      SP70,PMVXUDT3
          MOVE      SP70,PMVXUDT4
          MOVE      SP70,PMVXUDT5
          MOVE      SP70,PMVXUDT6
          MOVE      SP70,PMVXCDTE
          MOVE      SP70,PMVXCTIM
          MOVE      SP70,PMVXWEBC
          MOVE      SP70,PMVXLUPD
          MOVE      SP70,PMVXLUPT
          MOVE      SP70,PMVXWEBU
          MOVE      SP70,PMVXMHLS
          MOVE      SP70,PMVXUDIN
          MOVE      SP70,PMVXUREA
          MOVE      SP70,PMVXUSAC
          MOVE      SP70,PMVXUVTH
          MOVE      SP70,PMVXPALC
          MOVE      SP70,PMVXPPAL
          MOVE      SP70,PMVXELPS
.
          MOVE      SP70,ORGNTYPE
CLPV9999  RETURN
+
.------------------------------------------------------------
. Legal Status Selection List with Matrix Validation
.------------------------------------------------------------
CDSLLS00  MOVE      SP70,TDESC
          PACK      KEY5,ANSL,ANSS,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      "LS",TCODE
            MOVE      "Invalid Category",TDESC
          ENDIF
          REP       " _",TCODE
          REP       " _",THCSCOD
          WRITE     HTMLFILE;"<!--<cat-c category=#"",TCODE,"#" name=#"",TDESC:
                             "#" map=#"",THCSCOD,"#"></cat-c>-->"
.
          PACK      PTCDKEY2,ANSL,ANSS,SP70
          CALL      RDSCODE2
CDSLLS10  CALL      RDKCODE2
          BRANCH    OVRCD,CDSLLS99
          MATCH     "LS",TCODE
          GOTO      CDSLLS99 IF NOT EQUAL
          MATCH     SP70,ACODE
          GOTO      CDSLLS10 IF EQUAL
.
          MOVE      SP70,SVDLSCOD
          PACK      SAVKEY32,MHDLURNO,MHDLUNIQ,MHDLSDAT,MHDLSTIM,SP70
.
          PACK      KEY32,URNUMBER,UNIQNUMB,Z70
          CALL      RSMHDLS1
CDSLLS13  CALL      RPMHDLS1
          BRANCH    OVRCD,CDSLLS15
.
          MATCH     MHDLURNO,URNUMBER
          GOTO      CDSLLS15 IF NOT EQUAL
.
          MATCH     MHDLUNIQ,UNIQNUMB
          GOTO      CDSLLS15 IF NOT EQUAL
.
          MATCH     "1",MHDLACTV
          GOTO      CDSLLS13 IF EQUAL
.
.         MATCH     SP70,MHDLEDAT
.         GOTO      CDSLLS15 IF NOT EQUAL
.
          MOVE      MHDLSCOD,SVDLSCOD
.
CDSLLS15  MOVE      SAVKEY32,KEY32
          CALL      RDMHDLS1
          IF        OVRCD=ONE
            CALL      CLRDLS00
          ENDIF
.
          MATCH     SP70,SVDLSCOD
          IF        @EQUAL | @EOS
            MATCH     ANSF,TCINDC6
            GOTO      CDSLLS10 IF NOT EQUAL
          ELSE
.
            PACK      KEY6,SVDLSCOD,SP70
            CALL      RSMHLSM1
            CALL      RKMHLSM1
            BRANCH    OVRCD,CDSLLS20
.
            MATCH     SVDLSCOD,MHLMCRLS
            GOTO      CDSLLS20 IF NOT EQUAL
.
            PACK      KEY6,SVDLSCOD,ACODE,SP70
            CALL      RDMHLSM1
            BRANCH    OVRCD,CDSLLS10
          ENDIF
.
CDSLLS20  PACK      KEY35,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5:
                          TCINDC6,TCINDC7,TCINDC8,TCINDC9,TCINDC10:
                          TCINDC11,THCSCOD,PTCDNHCP,TCFORM6:
                          TCINDC12,TCINDC13,TCINDC14,TCINDC15,TCINDC16:
                          TCINDC17,TCINDC18,TCINDC19,TCINDC20,TCINDC21
          PACK      KEY40,QUOTE,ACODE,KEY35,QUOTE
          MATCH     SVDLSCOD,ACODE
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY40," selected>":
                               TDESC,"</option>"
          ELSE
            MATCH     "I",PTCOACTV
            GOTO      CDSLLS10 IF EQUAL
.
            IF        IBCNMHOS=1
              MATCH    "1",PTCDHOSS
              IF       @EQUAL
                PACK     KEY8,WBSEHOSP,TCODE,ACODE,SP70
                CALL     RDMLCOD1
                BRANCH   OVRCD,CDSLLS10
              ENDIF
            ENDIF
.
            WRITE     HTMLFILE;"<option value=",KEY40,">",TDESC,"</option>"
          ENDIF
          GOTO      CDSLLS10
CDSLLS99  RETURN
.------------------------------------------------------------
. OMHR0000 - Find an open MH Referral
.------------------------------------------------------------
OMHR0000  
.         PACK      SAVKEY16,MHHLURNO,MHHLUNIQ,SP70
.
          PACK      KEY16,URNUMBER,SP70
          CALL      RSMHHLS1
OMHR1000  CALL      RKMHHLS1
          BRANCH    OVRCD,OMHR9000
.
          MATCH     URNUMBER,MHHLURNO
          GOTO      OMHR9000 IF NOT EQUAL
.
          MATCH     "1",HEAVIEW1                           *T0852969-Start
          GOTO      OMHR2000 IF EQUAL                      *T0852969-End
.
          MATCH     SP70,MHHLOREF
          GOTO      OMHR1000 IF EQUAL
.
          PACK      KEY5,CATtm,MHHLOREF,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,OMHR1000
.
          MATCH     ANSI,TCINDC1
          GOTO      OMHR1000 IF NOT EQUAL
          GOTO      OMHR4000 IF EQUAL                      *T0852969-Start
.
.-------- Check Referral Source (Cat S Ind7=I) for HEA
OMHR2000  MATCH     SP70,MHHLSREF
          GOTO      OMHR1000 IF EQUAL
.
          PACK      KEY5,ANSS,SP1,MHHLSREF,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,OMHR1000
.
          MATCH     ANSI,TCINDC7
          GOTO      OMHR1000 IF NOT EQUAL
          GOTO      OMHR4000 IF EQUAL
.
OMHR4000  MATCH     "1",MHHLSTAT                           *T0852969-End
          GOTO      OMHR1000 IF EQUAL
.
          MATCH     SP70,MHHLEDAT
          GOTO      OMHR8000 IF EQUAL 
.
          GOTO      OMHR1000
.
OMHR8000  WRITE     HTMLFILE;ONE;
          GOTO      OMHR9500
.
OMHR9000  WRITE     HTMLFILE;ZERO;
          GOTO      OMHR9500
.
OMHR9500  
.         PACK      KEY16,SAVKEY16,SP70
.         CALL      RDMHHLS1
.
OMHR9999  RETURN
.------------------------------------------------------------
. DLSDOC00 - previous mehdls doctor tags      
.------------------------------------------------------------
DLSDOC00  PACK      KEY32,URNUMBER,UNIQNUMB,Z70
          CALL      RSMHDLS1
          CALL      RPMHDLS1
          BRANCH    OVRCD,DLSDOC99
.
          MATCH     URNUMBER,MHDLURNO
          GOTO      DLSDOC99 IF NOT EQUAL
.
          MATCH     UNIQNUMB,MHDLUNIQ
          GOTO      DLSDOC99 IF NOT EQUAL
.
          BRANCH    FORM1,DLSDOC50,DLSDOC60,DLSDOC70
          GOTO      DLSDOC99 
.
DLSDOC50  WRITE     HTMLFILE;MHDLSPSY;
          GOTO      DLSDOC99
.
DLSDOC60  WRITE     HTMLFILE;MHDLRESP;
          GOTO      DLSDOC99
.
DLSDOC70  WRITE     HTMLFILE;MHDLLDOC;
          GOTO      DLSDOC99
.
DLSDOC99  RETURN
.
.******************************************************************************
. MHRAC000    Mental Health Activity tag
. Returns ATEXISTS value:
. 0 - No activity record exists for the referral
. 1 - Activity record exists for the referral
. 2 - No ativity record exists for the Linked Referral(s)
.******************************************************************************
MHRAC000  MOVE      ZERO,ATEXISTS               * No activity exists 
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDVISA1
          BRANCH    OVRCD,MHRAC900
.
          MATCH     "10",PTVITYPE                * Allied Health Visit
          GOTO      MHRAC900 IF NOT EQUAL
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,MHRAC900
.
          MOVE      ADMISSNO,SAVREFNO            * Check if referral has
          CALL      MHRAT000                     * any activities
          BRANCH    ATEXISTS,MHRAC900            * Activity exists, exit
.
          MATCH     "1",ALREUYN4                 * Is this a Primary referral
          GOTO      MHRAC980 IF NOT EQUAL        * No, exit
.
.-------- Using the Primary referral, check if there are any linked referral
.-------- that have any activities
          MOVE      ZERO,CNTLKREF
          PACK      KEY16,ADMISSNO,SP70
          CALL      RSALRLN1
MHRAC100  CALL      RKALRLN1
          BRANCH    OVRCD,MHRAC800               * Linked Ref have no activity
.
          MATCH     ADMISSNO,ALRLVISN            * Same primary referral
          GOTO      MHRAC800 IF NOT EQUAL        * No, exit
.
          PACK      KEY8,ALRLLNKV,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,MHRAC100
.
          PACK      KEY5,ANSC,ANSG,ALREDEPT       * Check for MH dept
          CALL      RDCODE1
          BRANCH    OVRCD,MHRAC100
.
          MATCH     "M",TCINDC4                   * Is this linked MH referral
          GOTO      MHRAC100 IF NOT EQUAL         * No, read next referral
.
          MOVE      ALRLLNKV,SAVREFNO             * Check if linked referral
          CALL      MHRAT000                      * has any activities
          BRANCH    ATEXISTS,MHRAC900             * Activity exists,exit
.
          ADD       ONE,CNTLKREF                  * Linked referral counter
.
          GOTO      MHRAC100                      * Read next linked referral
. 
MHRAC800  IF        CNTLKREF = 0
            MOVE      ZERO,ATEXISTS               * Primary has no linked ref
          ELSE
            MOVE      TWO,ATEXISTS                * Linked ref have no activity
          ENDIF
          GOTO      MHRAC980
.
MHRAC900  MOVE      ONE,ATEXISTS                  * Activity exists
          GOTO      MHRAC980
.
MHRAC980  WRITE     HTMLFILE;ATEXISTS;            * Activity exists flag
          GOTO      MHRAC999
.
MHRAC999  RETURN
+
.******************************************************************************
. MHRAT000    Mental Health Check if activity exists
.****************************************************************************** 
MHRAT000  MOVE      ZERO,ATEXISTS
          PACK      KEY16,SAVREFNO,SP70
          CALL      RSALENC1
MHRAT010  CALL      RKALENC1
          BRANCH    OVRCD,MHRAT100
.
          MATCH     SAVREFNO,ALENVISN
          GOTO      MHRAT100 IF NOT EQUAL
.
          MATCH     "1",ALENRSTA
          GOTO      MHRAT010 IF EQUAL
.
          PACK      KEY9,ALREDEPT,ALENSERV,SP70
          CALL      RDALSER1
          BRANCH    OVRCD,MHRAT010
.
          MATCH     SP70,ALSRMHDP           * Ignore record if HDP is blank
          GOTO      MHRAT010 IF EQUAL
.
          GOTO      MHRAT900
.
MHRAT100  PACK      KEY16,SAVREFNO,SP70
          CALL      RSALLNK1
MHRAT110  CALL      RKALLNK1
          BRANCH    OVRCD,MHRAT200
.
          MATCH     SAVREFNO,ALLNVISN
          GOTO      MHRAT200 IF NOT EQUAL
.
          MATCH     "1",ALLNSTAT
          GOTO      MHRAT110 IF EQUAL
.
.-------- Check linked OP Appointments on alllnkaf table
          MOVE      ALLNSITE,SITECODE
          CALL      OUTFIL00       * Check Correct Files Are Open & Valid Site
          BRANCH    EXIT,MHRAT110
.
          PACK      KEY36,ALLNLNKV,SP70
          CALL      RDSBOKA6
MHRAT140  CALL      RDKBOKA6
          BRANCH    OVRCD,MHRAT200          * Activity not found
.
          MATCH     ALLNLNKV,DOBAOUTN       * (OBAOUTNO)
          GOTO      MHRAT200 IF NOT EQUAL   * Different visit number
.
.                                           * only Attended & not-Attended
          IF        OBASTAT = 4 | OBASTAT = 5
            GOTO      MHRAT900              * Activity found
          ELSE
            GOTO      MHRAT140              * Read next booking record
          ENDIF
.
MHRAT200  PACK      KEY16,SAVREFNO,SP70
          CALL      RSALGPA2
MHRAT210  CALL      RKALGPA2
          BRANCH    OVRCD,MHRAT999
.
          MATCH     SAVREFNO,ALGAREFN
          GOTO      MHRAC999 IF NOT EQUAL
.
          MATCH     "1",ALGARCST
          GOTO      MHRAT210 IF EQUAL
.
          MATCH     SP70,ALGAPSTA           * Patient Status (Cat GA)
          GOTO      MHRAT210 IF EQUAL
.
          PACK      KEY5,ANSG,ANSA,ALGAPSTA,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,MHRAT210
.
          MATCH     SP70,THCSCOD            * Ignore record if HDP is blank
          GOTO      MHRAT210 IF EQUAL
.
          GOTO      MHRAT900                * Group contact actvity found
.
MHRAT900  MOVE      ONE,ATEXISTS            * Activity exists
          GOTO      MHRAT999
.
MHRAT999  RETURN
.
.******************************************************************************
. MHREA000    Mental Health Earliest Activity Date tag
.******************************************************************************
MHREA000  MOVE      SP70,MHREADAT
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDVISA1
          BRANCH    OVRCD,MHREA900
.
          MATCH     "10",PTVITYPE
          GOTO      MHREA900 IF NOT EQUAL
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,MHREA900
.
          PACK      KEY16,ADMISSNO,SP70
          CALL      RSALENC1
MHREA010  CALL      RKALENC1
          BRANCH    OVRCD,MHREA100
.
          MATCH     ADMISSNO,ALENVISN
          GOTO      MHREA100 IF NOT EQUAL
.
          MATCH     "1",ALENRSTA
          GOTO      MHREA010 IF EQUAL
.
          PACK      KEY9,ALREDEPT,ALENSERV,SP70
          CALL      RDALSER1
          BRANCH    OVRCD,MHREA010
.
          MATCH     SP70,ALSRMHDP           * Ignore record if HDP is blank
          GOTO      MHREA010 IF EQUAL
.
          MATCH     SP70,MHREADAT
          IF        @EQUAL
            PACK      MHREADAT,ALENSDAT,SP70
          ELSE
            MATCH     MHREADAT,ALENSDAT
            IF        @LESS
              PACK      MHREADAT,ALENSDAT,SP70
            ENDIF
          ENDIF
.
          GOTO      MHREA010
.
MHREA100  PACK      KEY16,ADMISSNO,SP70
          CALL      RSALLNK1
MHREA110  CALL      RKALLNK1
          BRANCH    OVRCD,MHREA200
.
          MATCH     ADMISSNO,ALLNVISN
          GOTO      MHREA200 IF NOT EQUAL
.
          MATCH     "1",ALLNSTAT
          GOTO      MHREA110 IF EQUAL
.
          MATCH     SP70,MHREADAT
          IF        @EQUAL
            PACK      MHREADAT,ALLNDATE,SP70
          ELSE
            MATCH     MHREADAT,ALLNDATE
            IF        @LESS
              PACK      MHREADAT,ALLNDATE,SP70
            ENDIF
          ENDIF
.
          GOTO      MHREA110
.
MHREA200  PACK      KEY16,ADMISSNO,SP70
          CALL      RSALGPA2
MHREA210  CALL      RKALGPA2
          BRANCH    OVRCD,MHREA900
.
          MATCH     ADMISSNO,ALGAREFN
          GOTO      MHREA900 IF NOT EQUAL
.
          MATCH     "1",ALGARCST
          GOTO      MHREA210 IF EQUAL
.
          MATCH     SP70,ALGAPSTA           * Patient Status (Cat GA)
          GOTO      MHREA210 IF EQUAL
.
          PACK      KEY5,ANSG,ANSA,ALGAPSTA,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,MHREA210
.
          MATCH     SP70,THCSCOD            * Ignore record if HDP is blank
          GOTO      MHREA210 IF EQUAL
.
          MATCH     SP70,MHREADAT
          IF        @EQUAL
            PACK      MHREADAT,ALGACDAT,SP70
          ELSE
            MATCH     MHREADAT,ALGACDAT
            IF        @LESS
              PACK      MHREADAT,ALGACDAT,SP70
            ENDIF
          ENDIF
.
          GOTO      MHREA210
.
MHREA900  MATCH     SP70,MHREADAT
          GOTO      MHREA999 IF EQUAL
          GOTO      MHREA999 IF EOS
.
          UNPACK    MHREADAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
.
MHREA999  RETURN
.----------------------------------------------------------------------
. Legal Status Selection List with Matrix Validation (Long Description)
.----------------------------------------------------------------------
CDSLLD00  MOVE      SP70,TDESC
          PACK      KEY5,ANSL,ANSS,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      "LS",TCODE
            MOVE      "Invalid Category",TDESC
          ENDIF
          REP       " _",TCODE
          REP       " _",THCSCOD
          WRITE     HTMLFILE;"<!--<cat-c category=#"",TCODE,"#" name=#"",TDESC:
                             "#" map=#"",THCSCOD,"#"></cat-c>-->"
.
          PACK      PTCDKEY2,ANSL,ANSS,SP70
          CALL      RDSCODE2
CDSLLD10  CALL      RDKCODE2
          BRANCH    OVRCD,CDSLLD99
          MATCH     "LS",TCODE
          GOTO      CDSLLD99 IF NOT EQUAL
          MATCH     SP70,ACODE
          GOTO      CDSLLD10 IF EQUAL
.
          MOVE      SP70,SVDLSCOD
          PACK      SAVKEY32,MHDLURNO,MHDLUNIQ,MHDLSDAT,MHDLSTIM,SP70
.
          PACK      KEY32,URNUMBER,UNIQNUMB,Z70
          CALL      RSMHDLS1
CDSLLD13  CALL      RPMHDLS1
          BRANCH    OVRCD,CDSLLD15
.
          MATCH     MHDLURNO,URNUMBER
          GOTO      CDSLLD15 IF NOT EQUAL
.
          MATCH     MHDLUNIQ,UNIQNUMB
          GOTO      CDSLLD15 IF NOT EQUAL
.
          MATCH     "1",MHDLACTV
          GOTO      CDSLLD13 IF EQUAL
.
.         MATCH     SP70,MHDLEDAT
.         GOTO      CDSLLD15 IF NOT EQUAL
.
          MOVE      MHDLSCOD,SVDLSCOD
.
CDSLLD15  MOVE      SAVKEY32,KEY32
          CALL      RDMHDLS1
          IF        OVRCD=ONE
            CALL      CLRDLS00
          ENDIF
.
          MATCH     SP70,SVDLSCOD
          IF        @EQUAL | @EOS
            MATCH     ANSF,TCINDC6
            GOTO      CDSLLD10 IF NOT EQUAL
          ELSE
.
            PACK      KEY6,SVDLSCOD,SP70
            CALL      RSMHLSM1
            CALL      RKMHLSM1
            BRANCH    OVRCD,CDSLLD20
.
            MATCH     SVDLSCOD,MHLMCRLS
            GOTO      CDSLLD20 IF NOT EQUAL
.
            PACK      KEY6,SVDLSCOD,ACODE,SP70
            CALL      RDMHLSM1
            BRANCH    OVRCD,CDSLLD10
          ENDIF
.
CDSLLD20  PACK      KEY35,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5:
                          TCINDC6,TCINDC7,TCINDC8,TCINDC9,TCINDC10:
                          TCINDC11,THCSCOD,PTCDNHCP,TCFORM6:
                          TCINDC12,TCINDC13,TCINDC14,TCINDC15,TCINDC16:
                          TCINDC17,TCINDC18,TCINDC19,TCINDC20,TCINDC21
          PACK      KEY40,QUOTE,ACODE,KEY35,QUOTE
          MATCH     SVDLSCOD,ACODE
          IF        @EQUAL
            MATCH     SP70,PTCDLDES
            IF        @EQUAL
              WRITE     HTMLFILE;"<option value=",KEY40," selected>":
                                 TDESC,"</option>"
            ELSE
              WRITE     HTMLFILE;"<option value=",KEY40," selected>":
                                 PTCDLDES,"</option>"
            ENDIF
          ELSE
            MATCH     "I",PTCOACTV
            GOTO      CDSLLD10 IF EQUAL
.
            IF        IBCNMHOS=1
              MATCH    "1",PTCDHOSS
              IF       @EQUAL
                PACK     KEY8,WBSEHOSP,TCODE,ACODE,SP70
                CALL     RDMLCOD1
                BRANCH   OVRCD,CDSLLD10
              ENDIF
            ENDIF
.
            MATCH     SP70,PTCDLDES
            IF        @EQUAL
              WRITE     HTMLFILE;"<option value=",KEY40,">",TDESC,"</option>"
            ELSE
              WRITE     HTMLFILE;"<option value=",KEY40,">",PTCDLDES,"</option>"
            ENDIF
          ENDIF
          GOTO      CDSLLD10
CDSLLD99  RETURN
.------------------------------------------------------------
.         Check prev visits or MH Diagnosis records
.------------------------------------------------------------
CKPR0000  MATCH     URNUMBER,SP70
          GOTO      CKPR9000 IF EQUAL
.
          PACK      KEY24,URNUMBER,SP70
          CALL      RDSVISA2
          CALL      RDKVISA2
          BRANCH    OVRCD,CKPR9000
          MATCH     URNUMBER,PVIURNO
          GOTO      CKPR9000 IF NOT EQUAL
.
          PACK      KEY24,URNUMBER,SP70
          CALL      RSMHDIA2
          CALL      RKMHDIA2
          BRANCH    OVRCD,CKPR9000
          MATCH     URNUMBER,MHDIURNO
          GOTO      CKPR9000 IF NOT EQUAL
.
          WRITE     HTMLFILE;ZERO;          * exists
          GOTO      CKPR9999
.
CKPR9000  WRITE     HTMLFILE;ONE;           * doesn't exist
          GOTO      CKPR9999
.
CKPR9999  RETURN
.
.------------------------------------------------------------
. NOMORE00 - Display "No more records" at end of list
.------------------------------------------------------------
NOMORE00  WRITE     HTMLFILE;"<tr>":
                             "<td class=RedCell colspan=20 align=center>":
                             "No more records</td>"
.
NOMORE99  RETURN
+
.------------------------------------------------------------
          INC       IBAWEBCD
          INC       WEBDATCD
          INC       MHAUDVIS                * audits for visit file
          INC       DGCLICAC
          INC       DGCLICUP
          INC       DGCLII13
          INC       MEHHLSTM
          INC       CLALLENC
          INC       CLALLREF
          INC       ALLREFTM
          INC       PATKEOPR
.
          INC       ALLCASIO/INC
          INC       ALLCTMIO/INC
          INC       ALLENCIO/INC
          INC       ALLLNKIO/INC
          INC       ALLGPAIO/INC
          INC       ALLREFIO/INC
          INC       ALLPROIO/INC
          INC       ALLPRRIO/INC
          INC       ALLQUEIO/INC
          INC       ALLDIAIO/INC
          INC       ALLRITIO/INC
          INC       ALLRLNIO/INC
          INC       ALLSERIO/INC
          INC       HL7CISIO/INC
          INC       HL7INBIO/INC
          INC       MEHCJAIO/INC
          INC       MEHAKIIO/INC   * Axis keyword search
          INC       MEHAXIIO/INC   * MH Axis file
          INC       MEHDIAIO/INC   * MH Diagnosis History Details
          INC       MEHDS1IO/INC   * MH Discharge Details
          INC       MEHDL1IO/INC   * MH Discharge to leave Details
          INC       MEHHLSIO/INC
          INC       MEHDLSIO/INC
          INC       MEHREVIO/INC   
          INC       MEHLEGIO/INC   
          INC       MEHLSMIO/INC
          INC       MEHVI1IO/INC   * MH Visit Record    
          INC       MEHMDTIO/INC
          INC       MEHMTXIO/INC
.
..notused INC       MEHPMEIO/INC            * Mental Health PRIMHD Error Table
          INC       MEHPLSIO/INC            * PRIMHD "LS" Record - Legal Status
          INC       MEHPRDIO/INC            * PRIMHD "RD" Record - Referral Disc
..notused INC       MEHPATIO/INC            * PRIMHD "AT" Record
..notused INC       MEHPCNIO/INC            * PRIMHD "CN" Record
..notused INC       MEHPCOIO/INC            * PRIMHD "CO" Record
..notused INC       MEHPOIIO/INC            * PRIMHD "OT" & "OI" record
..notused INC       MEHPTFIO/INC            * PRIMHD Transmission File table
          INC       MLTSECIO/INC
          INC       MLTSITIO/INC
.
          INC       MEHCMNIO/INC
          INC       OUTBOAIO/INC
          INC       PATEORIO/INC
          INC       PATKEOIO/INC
          INC       PATDO1IO/INC   * Doctor File
          INC       PATHSPIO/INC
          INC       PATMI1IO/INC
          INC       PATMA1IO/INC
          INC       PATONLIO/INC
          INC       PATTRNIO/INC
          INC       PATVISIO/INC   * Patients Visits File
          INC       PMSVX1IO/INC   * Visit Extension File
          INC       PMSTEMIO/INC
          INC       PATALRIO/INC
          INC       PRIITMIO/INC
          INC       OUTSITIO/INC
          INC       OUTCTYIO/INC
          INC       OUTCLIIO/INC
          INC       PMSUCHIO/INC
          INC       PMSUCDIO/INC
          INC       PATPR1IO/INC
          INC       PMSPX2IO/INC
          INC       PMSQPTIO/INC
          INC       PATFN1IO/INC
          INC       PATWR1IO/INC
          INC       MRTMASIO/INC
          INC       NHIMASIO/INC
          INC       NHIETHIO/INC
          INC       PATRE1IO/INC
          INC       PATDGWIO/INC
          INC       VISMDTIO/INC
          INC       VISMTXIO/INC
          INC       PATITMIO/INC
          INC       PATDADIO/INC
          INC       PATVADIO/INC
          INC       PATCMCIO/INC
          INC       PATASFIO/INC
.         INC       PMSHCGIO/INC
.         INC       PMSHCPIO/INC
          INC       APSMASIO/INC
          INC       PATIN1IO/INC
          INC       PATDSCIO/INC
          INC       PATNIDIO/INC
          INC       PMSCCDIO/INC            * Concession Card Details
.
          INC       BRHLCOMN
          INC       PATNAMCD
          INC       MEHAKIPR
          INC       MEHDIATM
          INC       MEHDISTM
          INC       MEHDLVTM
          INC       MEHVISTM
          INC       CLNHIMAS                   * Clear nhimasaf file variables
          INC       CLPATMAS
          INC       CLPATMIS
          INC       CLPATVIS
          INC       CLPMSPX2
          INC       CLMEHLEG
          INC       CLMEHREV
          INC       CLMEHDIA
          INC       CLMEHDIS
          INC       CLMEHDLV
          INC       CLMEHVIS
          INC       CLPATDSC
          INC       CLPATRE1
          INC       CLPMSVX1
          INC       PATMASTM
          INC       PATDOCTM
          INC       PATVISTM
          INC       PMSHCGTM
          INC       PMSHCPTM
          INC       PATDSCTM
          INC       PMSPX2TM
          INC       PATMSXTM
          INC       PATMISTM
          INC       TFILENAM
          INC       MEHLEGTM
          INC       MEHREVTM
.         INC       PATDOCCD
          INC       CALCAGE
          INC       NAMSTRCD
          INC       DAYOFWEK
          INC       PMIGTNID
          INC       ADDSECTM 

