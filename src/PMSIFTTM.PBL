. *----------------------------------------------------------------------
. * Include Name  :   PMSIFTTM.PBL
. *
. * Function      :   CGI variables for PMSIFTFD - pmsiftaf.dat
. *
. * Includes Needed :
. * NOTE: This Include has routines to clear and set the CGI parameters 
. *       and to move CGI parameters to table fields.
. *----------------------------------------------------------------------
.  Modifications Done :
.
. V10.02.01 24/06/2011  Peter McMullen  CAR 240725
.           change call to parent function WARDLSL00 to WSEL0000
.  V9.09.01 14/11/2007  Peter Vela CAR 151199
.           Added new Emergency Cancellation status
.  V9.03.02 19/03/2004  Peter Vela CAR 13038
.           Changed call DOCNAM00 to DOCNM000 (parameter driven doctor name
.           format) for sort lists.
.  V9.03.01 14/07/2003  Lina Vo         
.           Created include.
.                       
.------------------------------------------------------------------------
.   Clear Infection Control fields
.------------------------------------------------------------------------
.
CLPMIF00  MOVE      SP70,PMIFURNO
          MOVE      SP70,PMIFADMN
          MOVE      SP70,PMIFVTYP
          MOVE      SP70,PMIFCLOC
          MOVE      SP70,PMIFICAT
          MOVE      SP70,PMIFITYP
          MOVE      SP70,PMIFILOC
          MOVE      SP70,PMIFIDTE
          MOVE      SP70,PMIFITIM
          MOVE      SP70,PMIFLVIS
          MOVE      SP70,PMIFDTIS
          MOVE      SP70,PMIFTMIS
          MOVE      SP70,PMIFDPND
          MOVE      SP70,PMIFLTGP
          MOVE      SP70,PMIFGVTN
          MOVE      SP70,PMIFGVTC
CLPMIF99  RETURN
.------------------------------------------------------------------------
.   Clear CGI Parameters
.------------------------------------------------------------------------
.
CPPMIF00  MOVE      Z70,PMIFT001
          MOVE      Z70,PMIFT002
          MOVE      Z70,PMIFT003
          MOVE      Z70,PMIFT004
          MOVE      Z70,PMIFT005
          MOVE      Z70,PMIFT006
          MOVE      Z70,PMIFT007
          MOVE      Z70,PMIFT008
          MOVE      Z70,PMIFT009
          MOVE      Z70,PMIFT010
          MOVE      Z70,PMIFT011
          MOVE      Z70,PMIFT012
          MOVE      Z70,PMIFT013
          MOVE      Z70,PMIFT014
          MOVE      Z70,PMIFT015
          MOVE      Z70,PMIFT016
.
          MOVE      SP70,ICFLUNIT
          MOVE      SP70,ICFLITYP
          MOVE      SP70,ICFLDOCT
          MOVE      SP70,ICFLWARD
.
CPPMIF99  RETURN
.------------------------------------------------------------
.   Set CGI Parameters for Infection Control file
.------------------------------------------------------------
SPIFT000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SPIFT001,SPIFT002,SPIFT003,SPIFT004,SPIFT005:
                       SPIFT006,SPIFT007,SPIFT008,SPIFT009,SPIFT010:
                       SPIFT011,SPIFT012,SPIFT013,SPIFT014,SPIFT015:
                       SPIFT016
.
          MOVE      ONE,EXIT
          GOTO      SPIFT999
.
SPIFT001  MOVE      QRYDATA,PMIFT001
          GOTO      SPIFT999
.
SPIFT002  MOVE      QRYDATA,PMIFT002
          GOTO      SPIFT999
.
SPIFT003  MOVE      QRYDATA,PMIFT003 
          GOTO      SPIFT999
.
SPIFT004  MOVE      QRYDATA,PMIFT004
          GOTO      SPIFT999
.
SPIFT005  MOVE      QRYDATA,PMIFT005
          GOTO      SPIFT999
.
SPIFT006  MOVE      QRYDATA,PMIFT006
          GOTO      SPIFT999
.
SPIFT007  MOVE      QRYDATA,PMIFT007
          GOTO      SPIFT999
.
SPIFT008  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                
          PACK      PMIFT008,CCENT,CYEAR,CMON,CDAY
          GOTO      SPIFT999
.
SPIFT009  MOVE      QRYDATA,PMIFT009
          GOTO      SPIFT999
.
SPIFT010  MOVE      QRYDATA,PMIFT010
          GOTO      SPIFT999
.
SPIFT011  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00                
          PACK      PMIFT011,CCENT,CYEAR,CMON,CDAY
          GOTO      SPIFT999
.
SPIFT012  MOVE      QRYDATA,PMIFT012
          GOTO      SPIFT999
.
SPIFT013  MOVE      QRYDATA,PMIFT013
          GOTO      SPIFT999
.
SPIFT014  MOVE      QRYDATA,PMIFT014
          GOTO      SPIFT999
.
SPIFT015  MOVE      QRYDATA,PMIFT015
          GOTO      SPIFT999
.
SPIFT016  MOVE      QRYDATA,PMIFT016
          GOTO      SPIFT999
.
SPIFT999  RETURN
.------------------------------------------------------------
.  Update Infection Control file
.------------------------------------------------------------
MVPMIF00  MATCH     PMIFT001,Z70
          IF        !@EQUAL
            MOVE      PMIFT001,PMIFURNO
          ENDIF
.
          MATCH     PMIFT002,Z70
          IF        !@EQUAL
            MOVE      PMIFT002,PMIFADMN
          ENDIF
.
          MATCH     PMIFT003,Z70
          IF        !@EQUAL
            MOVE      PMIFT003,PMIFVTYP
          ENDIF
.
          MATCH     PMIFT004,Z70
          IF        !@EQUAL
            MOVE      PMIFT004,PMIFCLOC
          ENDIF
.
          MATCH     PMIFT005,Z70
          IF        !@EQUAL
            MOVE      PMIFT005,PMIFICAT
          ENDIF
.
          MATCH     PMIFT006,Z70
          IF        !@EQUAL
            MOVE      PMIFT006,PMIFITYP
          ENDIF
.
          MATCH     PMIFT007,Z70
          IF        !@EQUAL
            MOVE      PMIFT007,PMIFILOC
          ENDIF
.
          MATCH     PMIFT008,Z70
          IF        !@EQUAL
            MOVE      PMIFT008,PMIFIDTE
          ENDIF
.
          MATCH     PMIFT009,Z70
          IF        !@EQUAL
            MOVE      PMIFT009,PMIFITIM
          ENDIF
.
          MATCH     PMIFT010,Z70
          IF        !@EQUAL
            MOVE      PMIFT010,PMIFLVIS
          ENDIF
.
          MATCH     PMIFT011,Z70
          IF        !@EQUAL
            MOVE      PMIFT011,PMIFDTIS
          ENDIF
.
          MATCH     PMIFT012,Z70
          IF        !@EQUAL
            MOVE      PMIFT012,PMIFTMIS
          ENDIF
.
          MATCH     PMIFT013,Z70
          IF        !@EQUAL
            MOVE      PMIFT013,PMIFDPND
          ENDIF
.
          MATCH     PMIFT014,Z70
          IF        !@EQUAL
            MOVE      PMIFT014,PMIFLTGP
          ENDIF
.
          MATCH     PMIFT015,Z70
          IF        !@EQUAL
            MOVE      PMIFT015,PMIFGVTN
          ENDIF
.
          MATCH     PMIFT016,Z70
          IF        !@EQUAL
            MOVE      PMIFT016,PMIFGVTC
          ENDIF
.
MVPMIF99  RETURN
.------------------------------------------------------------
PIFT0000  BRANCH    FLDITMNO,PIFT0100,PIFT0200,PIFT0300,PIFT0400,PIFT0500:
                             PIFT0600,PIFT0700,PIFT0800,PIFT0900,PIFT1000:
                             PIFT1100,PIFT1200,PIFT1300,PIFT1400,PIFT1500:
                             PIFT1600,PIFT1700,PIFT1800,PIFT1900,PIFT2000:
                             PIFT2100
.
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      PIFT9999
.
PIFT0100  WRITE     HTMLFILE;PMIFURNO;        * U/R number
          GOTO      PIFT9999
.
PIFT0200  WRITE     HTMLFILE;PMIFADMN;        * Admission number
          GOTO      PIFT9999
.
PIFT0300  WRITE     HTMLFILE;PMIFVTYP;        * Visit Type
          GOTO      PIFT9999
.
PIFT0400  MATCH     SP70,PMIFCLOC
          GOTO      PIFT0420 IF EQUAL
.
          UNPACK    PMIFCLOC,AWARD,ABED
          GOTO      PIFT0440
.
PIFT0420  PACK      KEY8,ADMISSNO
          CALL      RDPTMIS1
.
PIFT0440  PACK      KEY10,AWARD,SLASH,ABED,SP70
          SQUEEZE   KEY10
          WRITE     HTMLFILE;KEY10;           * Current Location
          GOTO      PIFT9999
.
PIFT0500  MATCH     SP70,PMIFICAT
          GOTO      PIFT0510 IF NOT EQUAL
          MOVE      "H1",PMIFICAT
.
PIFT0510  WRITE     HTMLFILE;PMIFICAT;        * Type of Infection Category
          GOTO      PIFT9999
.
PIFT0600  MATCH     SP70,PMIFICAT
          GOTO      PIFT0610 IF NOT EQUAL
          MOVE      "H1",PMIFICAT
.
PIFT0610  MOVE      PMIFICAT,CATEGORY         * Type of Infection
          PACK      CODE,PMIFITYP,SP70
          CALL      CODITM00
          GOTO      PIFT9999
.
PIFT0700  MOVE      "DJ",CATEGORY             * Location of Infection
          PACK      CODE,PMIFILOC,SP70
          CALL      CODITM00
          GOTO      PIFT9999
.
PIFT0800  MATCH     PMIFIDTE,SP70             * Date Infection Discovered
          GOTO      PIFT9999 IF EQUAL
          UNPACK    PMIFIDTE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          GOTO      PIFT9999
.
PIFT0900  WRITE     HTMLFILE;PMIFITIM;        * Time Infection Discovered
          GOTO      PIFT9999
.
PIFT1000  WRITE     HTMLFILE;PMIFLVIS;        * Level of Isolation       
          GOTO      PIFT9999
.
PIFT1100  MATCH     PMIFDTIS,SP70             * Date of Isolation         
          GOTO      PIFT9999 IF EQUAL
          UNPACK    PMIFDTIS,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          GOTO      PIFT9999
.
PIFT1200  WRITE     HTMLFILE;PMIFTMIS;        * Time of Isolation           
          GOTO      PIFT9999
.
PIFT1300  MOVE      "DB",CATEGORY             * Dependancy           
          PACK      CODE,PMIFDPND,SP70
          CALL      CODITM00
          GOTO      PIFT9999
.
PIFT1400  WRITE     HTMLFILE;PMIFLTGP;        * Letter sent to GP        
          GOTO      PIFT9999
.
PIFT1500  WRITE     HTMLFILE;PMIFGVTN;        * Government Agency Notified
          GOTO      PIFT9999
.
PIFT1600  MOVE      "CZ",CATEGORY             * Government Agency contacted via
          PACK      CODE,PMIFGVTC,SP70
          CALL      CODITM00
          GOTO      PIFT9999
.
PIFT1700  CALL      IFLST000                  * Infection List
          GOTO      PIFT9999          
.          
PIFT1800  MOVE      CATA,CATEGORY           * Admission Type (Unit) (Cat A)
          PACK      CODE,ICFLUNIT,SP70
          CALL      CODITM00
          GOTO      PIFT9999
.
PIFT1900  MOVE      CATH1,CATEGORY          * Infection Type (Cat H1)
          PACK      CODE,ICFLITYP,SP70
          CALL      CODITM00
          GOTO      PIFT9999
.
PIFT2000  MOVE      ICFLDOCT,DOCTCODE       * Doctor Details
          CALL      DOCDET00                
          GOTO      PIFT9999
.
PIFT2100  MOVE      ICFLWARD,DFLTWARD       * Ward
          CALL      WSEL0000
          GOTO      PIFT9999
.
PIFT9999  RETURN
.
.------------------------------------------------------------
.         Infection Control list
.------------------------------------------------------------
.
IFLST000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          PACK      KEY18,FRSTDATE,SP70
          CALL      RSPMIFT3
IFLST100  CALL      RKPMIFT3
          BRANCH    OVRCD,IFLST999
.
          MATCH     PMIFIDTE,LASTDATE
          GOTO      IFLST999 IF LESS
.
          MOVE      PMIFURNO,URNUMBER
          MOVE      PMIFADMN,ADMISSNO
.
          MATCH     "1 ",PMIFVTYP
          GOTO      IFLST200 IF EQUAL
.
          MATCH     "3 ",PMIFVTYP
          GOTO      IFLST300 IF EQUAL
.
          GOTO      IFLST100
.
.         Emergency
.
IFLST200  PACK      KEY8,PMIFADMN,SP70
          CALL      RDEMVIS1
          BRANCH    OVRCD,IFLST100
.
          COMPARE   FOUR,EMVISTAT
          GOTO      IFLST100 IF EQUAL
.
          MOVE      EMVIDOCT,ADOCTA
          MOVE      SP70,AWARD
          MOVE      SP70,ATYPE
          GOTO      IFLST400
.
.         Inpatient
.
IFLST300  PACK      KEY8,PMIFADMN,SP70
          CALL      RDPTMIS1
          BRANCH    OVRCD,IFLST100
.
IFLST400  PACK      ICFLUNIT,ICFLUNIT,SP70
          MATCH     SP70,ICFLUNIT
          IF        !@EQUAL
            MATCH     ATYPE,ICFLUNIT
            GOTO      IFLST100 IF NOT EQUAL
          ENDIF
.
          PACK      ICFLITYP,ICFLITYP,SP70
          MATCH     SP70,ICFLITYP
          IF        !@EQUAL
            MATCH     PMIFITYP,ICFLITYP
            GOTO      IFLST100 IF NOT EQUAL
          ENDIF
.
          PACK      ICFLWARD,ICFLWARD,SP70
          MATCH     SP70,ICFLWARD
          IF        !@EQUAL
            MATCH     AWARD,ICFLWARD
            GOTO      IFLST100 IF NOT EQUAL
          ENDIF
.
          PACK      ICFLDOCT,ICFLDOCT,SP70
          MATCH     SP70,ICFLDOCT
          IF        !@EQUAL
            MATCH     ADOCTA,ICFLDOCT
            GOTO      IFLST100 IF NOT EQUAL
          ENDIF
.
          CALL      IFFRMT00             * format fields
. 
          CALL      PATFLD00               *Returns KEY3 for folder colour code
.
          WRITE     HTMLFILE;"t.addRow(#"",PATLINK,"#",":
                             "#"",FORMATNM,"#",":
                             "#"",KEY10,"#",":                * Location
                             "#"",KEY30,"#",":                * Infection desc
                             "#"",DOCFNAME,"#",":             
                             "#"",KEY25,"#",":                * Letter to GP
                             "#"",PMIFGVTN,"#",":
                             "#"",KEY3,"#");"                
.
          GOTO      IFLST100
.
IFLST999  RETURN
.
.------------------------------------------------------------
.         Format fields for display
.------------------------------------------------------------
.
IFFRMT00  PACK      URNUMBER,AURNO
          PACK      ADMISSNO,AADMNO
          MOVE      AURNO,URNO
          CALL      GETPAT00      * Get Patient Details
          CALL      PATLN000      * Format Patient Name with System Parameter
. 
.         get Current Location
.
          MATCH     "3 ",PMIFVTYP        * Inpatient
          IF        @EQUAL
            UNPACK    PMIFCLOC,AWARD,ABED
            PACK      KEY10,AWARD,SLASH,ABED
            SQUEEZE   KEY10
            RESET     KEY10
          ELSE
            PACK      KEY10,PMIFCLOC,SP70
          ENDIF          
.
.         get Infection Description
.
          MOVE      SP70,TDESC
          MOVE      PMIFICAT,CATEGORY          
          MOVE      PMIFITYP,CODE
          CALL      GETCOD00
          MOVE      TDESC,KEY30
.
.         get letter to gp doctor
.
          MOVE      SP70,KEY25
          MATCH     "1",PMIFLTGP
          IF        @EQUAL
            PACK      KEY8,URNUMBER,SP70
            CALL      RDPMPX21
            BRANCH    OVRCD,IFFRMT10
            MOVE      SP70,DOCFNAME
            MOVE      PMPXRHC1,KEY6
            CALL      RDDOCT1
            BRANCH    OVRCD,IFFRMT10
.           CALL      DOCNAM00
            MOVE      DTITL,FMTTITLE            * I CAR 13038
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000                  * end I CAR 13038
            MOVE      DOCFNAME,KEY25
          ENDIF
.
.         get attending doctor
.
IFFRMT10  MOVE      SP70,DOCFNAME
          MOVE      ADOCTA,KEY6
          CALL      RDDOCT1
          IF        OVRCD=0
.           CALL      DOCNAM00
            MOVE      DTITL,FMTTITLE            * I CAR 13038
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000                  * end I CAR 13038
          ENDIF
.
.         get patient link
.
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
.
          CLEAR     PATLINK
          APPEND    LINKPRG,PATLINK
          APPEND    ".pbl?reportno=",PATLINK
          APPEND    LINKREP,PATLINK
          APPEND    "&template=",PATLINK
          APPEND    LINKTEM,PATLINK
          APPEND    "&urnumber=",PATLINK
          APPEND    URNUMBER,PATLINK
          APPEND    "&admissno=",PATLINK
          APPEND    ADMISSNO,PATLINK
          RESET     PATLINK
.
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
IFFRMT99  RETURN
