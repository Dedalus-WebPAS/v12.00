.----------------------------------------------------------------------
. Program       : PATWEB97
.
. Author        : Jim Stathopoulos
.
. Function      : Doctor List Server  
.
. Modifications :
.
.-----------------------------------------------------------------------
.V12.00.01 29/05/2025  PJ Le Febour   Task 0955096 AlphaNum Visitnum 
.          replace  COMPARE WSTBY.AADMNO with MATCH WSTBY.AADMNO              
.V11.05.01 25/03/2025  Ebon Clements  Task 0955097
.          Pack doctcode with SP70 in SETPAR00 for full doctor code comparison
.V11.04.06 26/07/2024  Peter Vela     Task 0949702
.          Recompiled for FHRDATCD
.V11.04.05 17.05.2024  DA Sarkies     TSK 0940941
.          Corrected the variable that holds expected bed
.V11.04.04 23.11.2023  DA Sarkied     TSK 0939514
.          Made code tighter, and moved correct value into ABED
.V11.04.03 23.11.2023  DA Sarkies     TSK 0939511
.          Undid changes
.V11.04.02 23.11.2023  DA Sarkies     TSK 0939511
.          Added code to include expected ward/bed when displaying
.          encounter Location
.V11.04.01 23.11.2023  DA Sarkies     TSK 0939514
.          Added code to include expected ward/bed when displaying
.          encounter class
.V11.03.14 17.05.2024  DA Sarkies     TSK 0940941
.          Corrected the variable that holds expected bed
.V11.03.13 24.11.2023  DA Sarkies     TSK 0939514
.          Made code tighter, and moved correct value into ABED
.V11.03.12 23.11.2023  DA Sarkies     TSK 0939511
.          Undid changes
.V11.03.11 23.11.2023  DA Sarkies     TSK 0939511
.          Added code to include expected ward/bed when displaying
.          encounter Location
.V11.03.10 23.11.2023  DA Sarkies     TSK 0939514
.          Added code to include expected ward/bed when displaying
.          encounter class
.V11.03.09 02/10/2023  Thanh T        TSK 0935071
.          Changed TABSHR10 to filter out status for FHIR
.V11.03.08 24/08/2023  Peter Vela     TSK 0935071
.          Changed TABSHR10 to check FRSTDATE/LASTDATE filter against
.V11.03.07 24/08/2023  Thanh T        TSK 0935071
.          Changed TABSHR10 to check FRSTDATE/LASTDATE filter against
.          admission date for FHIR Encounter 
.V11.03.06 11/08/2023  Peter Vela     TSK 0927262
.          Added FHRCON00 - Patient Resource contacts object for FHIR api
.V11.03.05 01/08/2023  Peter Vela     TSK 0927262
.          Recompiled for FHRDATCD
.          Added dxc-hc-hcp and dxc-hc-speciality extensions
.V11.03.04 22/06/2023 Jacob Jackson   TSK 0927731
.          Add changes so that FHIR Response contains a location object
.          for Ward and an object for Bed
.V11.03.03 01/06/2023 Sunny           TSK 0927431
.          Added filter for FHIR patient Encounter search based on status
.V11.03.02 23/05/2023  Peter Vela     TSK 0927399
.          Recompiled for FHRDATCD - Changed gender validation to
.          Indicator 7
.V11.03.01 04/05/2023  Peter Vela     TSK 0927262
.          ClinicalAide FHIR API 
.          Added Participant include FHRPARIN functionality 
.          Added Location include  FHRLOCIN functionality
.V11.01.02 16/08/2021  Ebon Clements  TSK 0899109
.          Added SDEN0000 don't display secondary doctor if end dated - TABSHR00
.V11.01.01 16/04/2021  Ebon Clements  TSK 0904815
.          Cross Browser Quotes -  TABCON00
.V11.00.02 10/12/2020  Sunny          TSK 0892649
.          Recompile for IBACOMM/IBAWEBDF - Changed DSEXDESC/DISPSEX to DIM 16
.V11.00.01 09/12/2020  Thanh T        TSK 0872840
.          Added PMSCCDFD/PMSCCDIO as PMSPX2TM changes
.-----------------------------------------------------------------------
.V10.13.04 25.01.2019  B.G.Ackland    TSK 0835482
.          Recompile for change to FHIR Encounter Reason in FHRDATCD
.V10.13.03 12.11.2017  B.G.Ackland    TSK 0835482
.          FHIR Recompile for change to FHRDATCD
.V10.13.02 06.11.2017  B.G.Ackland    TSK 0835482
.           FHIR Output Change for Boolean values to not have quotes
.V10.13.01 01.11.2018  B.G.Ackland    TSK 0835482
.          Added deceased section to patient FHR resource in FHRDATCD
.-----------------------------------------------------------------------
.V10.11.03 10.10.2017  B.G.Ackland    TSK 0835482
.          FHIR Dummy include for Extra Details
.V10.11.02 03.10.2017  B.G.Ackland    TSK 0835482 
.          FHIR Dummy include for Contact Details (Not included in List Functions)
.V10.11.01 28.08.2017  B.G.Ackland    TSK 0835482 
.          FHIR Output Change to Patient Reference ID to strip spaces
.          FHIR Change Extension Naming
.-----------------------------------------------------------------------
.V10.10.05  11.07.2017  B.G.Ackland    TSK 0835482 
.           FHIR Output Testing for ClinicalAide
.V10.10.04  28.06.2017  B.G.Ackland    TSK 0835482 
.           FHIR Interface Change Patient Resource for family name
.V10.10.03  08.05.2017  B.G.Ackland    TSK 0835482 
.           Fix ward bed output for duplicate ward name for ward only FWDBED00
.V10.10.02  08.05.2017  B.G.Ackland    TSK 0835482 
.           FHIR Output Resolve Testing Issues Incorporate Version Control
.V10.10.01  21/01/2017  B.G.Ackland    TSK 0835482 
.           FHIR output of encounters
.-----------------------------------------------------------------------
.V10.08.01  11/05/2016  J.Tan            CAR 0809575
.           Mods to TROWSC00 to display Attending and Secondary doctor
.-----------------------------------------------------------------------
.V10.07.02  17/12/2015  Don Nguyen       CAR 316624
.           Modified MATDOC00 to also output Case Team and Shared Care Consult.
.V10.07.01  23/10/2015  Don Nguyen       CAR 316624
.           Added TABADV00 - All visits for matching doctor (incl. Case Team).
.           Fixed goto in TABRDM00; changed to TABRDM30 instead of TABADM30.
.-----------------------------------------------------------------------
.V10.06.02  13/07/2015  Don Nguyen       CAR 318207
.           Modified ROWSCD00 to allow same day shared care visit to show
.V10.06.01  16/06/2015  Ebon Clements    CAR 317507
.           Fixed loop of date of care file - ROWSCD00 
.-----------------------------------------------------------------------
.V10.05.02  13/01/2014  Don Nguyen       CAR 301494
.           Fixed ROWSCD00 - replaced spaces in date string (IBACLOCK) with '0'
.V10.05.01  11/12/2014  Don Nguyen       CAR 301494
.           Added ADMT1100, SHOWADDT, ROWSCD00 and TROWSC00 to output 
.           Shared Care visits for the matching doctor.
.           Increased size of COLDAT02 to 40.
.-----------------------------------------------------------------------
. 10.03.04  12.08.2013  B.G.Ackland      CAR 289383
.           New Tag to Output JSON type Discharged Patient List PATWEB97.02.012
. 10.03.03  07.08.2013  B.G.Ackland      CAR 289943
.           Fix Expected Discharge Date to use a single routine GETCON00
. 10.03.02  11.04.2013  Steve Armstrong  CAR 283981
.           Recompiled for changes to PATVISIO
. 10.03.01  04.06.2012  Ebon Clements  CAR 247801 
.           Added multi hospital test to on leave patients - TABADM00
. 10.02.02  01/07/2011  Peter McMullen CAR 240725 
.           Mods to respond to PTCNWBDS=2 (short description)   
. 10.02.01  26/05/2011  Peter McMullen CAR 240725 
.           Output ward shert description instead of ward code
. V9.12.07  17/12/2009  Peter McMullen CAR 210130
.           Convert to newer Dr name format routine DOCNM000
. V9.12.06  16/10/2009  Ebon Clements CAR 198460
.           Fixed unit filter on shared care list TABSHR00
.           Added deftview cgi and tag
. V9.12.05  13/10/2009  WeeLee Koo    CAR 191981
.           Added filter by Secondary Doctor (TABSHR00)
. V9.12.04  26/08/2009  WeeLee Koo    CAR 191981
.           Added Attndg Doc & Secndry Doc for Current Inpatient
.           Added Health Fund Code (TABSHR00)
. V9.12.03  26/08/2009 Ebon Clements CAR 202965
.            Added visit based CDM details to TABADM00
. V9.12.02  29/07/2009  Jill Habasque CAR 145706
.            Removed check for hospital in TABGPA00
. V9.12.01  30/04/2009  Jill Habasque CAR 145706
.           Mods to only output if informgp=yes in TABGPA00
. V9.11.01  30/04/2009  Jill Habasque CAR 145706
.           Added TABGPA00 - current admissions by GP
.                 V9.09.01  12/10/2007  Davin         CAR 151896
.                           Display ward/bed description (based on parameter)
.                 V9.08.01  20/04/2007  Ebon Clements CAR 132858
.                           Recompiled for PMSWORFD file change
.                 V9.05.01  09/03/2006  Ebon Clements CAR 78533
.                           Mods for PATCODTM - Hospital specific category codes
.                 V9.04.03  08/03/2005 Peter Vela CAR 23312
.                           Added display functionality for Expected Discharge
.                           Date in pmsworaf
.                 V9.04.02  23/02/2005  Jill Habasque CAR 53046
.                           BHS Changes
.                 V9.04.01  27/08/2004  Jill Habasque CAR 53046
.                           Added check for multihospital in  TABADM00
.                 V9.03.07  11/06/2004  Mike Laming   CAR 49016  July 2004 PRS/2
.                   - Add Sex Description routine SEXDSC00 with Code "R" -
.                   "Intersex" added                                     
.                 V9.03.06  07/06/2004 Peter Vela CAR 49016
.                           2004 Statutory Changes - recompiled for PMSPX2TM
.                 V9.03.05  12.05.2004 Sylvek Litewka  CAR 49209
.                           Added variable PRIVFLAG to be used instead of 
.                           PTMXSIN5. PTMXSIN5 is now used as 'Legacy Visits'
.                           indicator and therefore should not be used for 
.                           temporary storage of 'Privacy' flag.
.                 V9.03.04  04.03.2004 Peter Vela    CAR 45278
.                           Added functionality to display different folder 
.                           colors for patweb9701007.html kids
.                 V9.03.03  11.12.2003 Peter Vela    CAR 40355
.                           Recompiled for PATNAMCD
.                 V9.03.02  02.09.2003 Jill Habasque SRF 43013
.                           Fixed output of ptmxsin1
.                 V9.03.01  17.07.2003 Jill Habasque SRF 40995
.                           Added output of Specialty for NZ lists
.                 V9.02.05  27.09.2002 Peter Vela SRF 22628
.                           Fixed Patient Discharges, Admissions, Pre-admissions.                           , Visits and Bookings table display.
.                 V9.02.04  18.01.2001 Jill Habasque 
.                           Added output of privacy indicator
.                 V9.02.03  27.11.2001 Ebon Clements 
.                           Changed lists to use standard name formats
.                 V9.02.02  20.11.2001 Jill Habasque
.                           Added filter for unit                 
.                 V9.02.01  03.10.2001 Jill Habasque
.                           Commented out replace of ' with spaces
.                 V9.01.02  15.08.2001 J.Tan
.                           Recompiled for PATMASTM
.                 V9.01.01  14.08.2001 J.Tan
.                           Recompiled for PATMASTM
.                 V5.10.B02 19/03/2001 Bronko Sosic
.                           Added a check for dead patients to GETPAT00
.                 V5.10.B01 07/03/2001 J.Tan
.                           Changed heading
.                 V5.09.B04 21/02/2001 B.Ackland
.                           Mods to display indicators 
.                 V5.09.03  15/01/2001 Bronko Sosic
.                           Recompiled for PATMASTM
.                 V5.09.B02 09/01/2001 Jill Habasque
.                           Fixed global recompile errors
.                 V5.08.05  28/09/2000 Bronko Sosic
.                           Recompiled for PATMASTM
.                 V5.08.04 05/09/2000  Tonii
.                          Mods to accept Unknown and Indeterminate as valid
.                          patient sex description
.                 V5.08.03  16/08/2000  Caleb Sharman
.                          Changed Health Fund variables to be 8 chars
.                 V5.08.02 18.07.2000 Bronko Sosic
.                          Added a check for Standby Patient STANDP00
.-----------------------------------------------------------------------
.                 V5.07.05 01.02.2000 B.G.Ackland
.                          New List Option with Results Link
.                 V5.07.04 05.01.2000 K.C.Nelson        
.                          Recompiled for WEBDATCD Y2K date correction 
.                          also for patmastm changes 
.                 V5.07.03 20.12.1999 K.C.Nelson        
.                          Recompiled for IBAWEBDF/IBAWEBCD               
.                 V5.07.02 03.11.1999 B.G.Ackland       
.                          Enable One Doctor to List Patients for Another
.                          Allow Empty Page Display
.                 V5.07.01 20/09/1999 Katie Nelson      
.                          Changed table cell bgcolor to class
.                 V5.07.00 25/06/1999 Nicole Harrington
.                          Ported from 6.06 - 5.07
.----------------------------------------------------------------------
.                 V6.04.01 01.02.1999 Andrew Peel
.                 Added Bookings for a Date Range Option 
.
.                 V6.04.00 11.02.1998 B.G.Ackland
.                          Created Program
.
.----------------------------------------------------------------------
          INC       IBAWEBDF  
          INC       WEBDATDF
          INC       FHRDATDF
.
          INC       ALLCASFD/INC
          INC       ALLCTMFD/INC
          INC       BOKRC1FD/INC
          INC       OPRDEAFD/INC
          INC       PATDHEAD/INC
          INC       PATCONFD/INC
          INC       PATCALAG/INC
          INC       PATMA1FD/INC
          INC       PMSCDNFD/INC
          INC       PMSCEXFD/INC
          INC       PMSRELFD/INC
          INC       PMSTLEFD/INC
          INC       PMSPX2FD/INC
          INC       PATHSPFD/INC
          INC       PATMI1FD/INC
          INC       PATPR1FD/INC
          INC       PATDSCFD/INC
          INC       PATVISFD/INC
          INC       PMSHCPFD/INC
          INC       PMSHCLFD/INC
          INC       PMSVX1FD/INC
          INC       PATDO1FD/INC 
          INC       PATTRNFD/INC
          INC       PATWR1FD/INC
          INC       PATVADFD/INC
.
          INC       PMSCCDFD/INC   * Concession Card Details
          INC       PMSHCGFD/INC
          INC       PMSPX2TD/INC         * I CAR 45278
          INC       PMSWORFD/INC                                       *I-23312
          INC       PMSWORTD/INC                                       *I-23312
          INC       PMSDTCFD/INC
.
          INC       TFILEVAR/INC
.
TODAYDTE  DIM       8
ADMTIME   DIM       10
DESTDESC  DIM       20            
PTYPDESC  DIM       20            
ASRCDESC  DIM       20
WARDTEXT  DIM       20
BEDTEXT   DIM       20 
CODEVI    INIT      "VI"
CATD      INIT      "D "
CATDD     INIT      "DD"
CATBW     INIT      "BW"
CATTC     INIT      "tc"
CONDESC   DIM       25
XFORMAT   FORM      1
.
ATATAT    DIM       2
ATYPDESC  DIM       20
ATNSECDC  DIM       40     * Attending Doc and Secondary Doc
ACTVDESC  DIM       3
ROOMDESC  DIM       25
BEDTDESC  DIM       25
BOOKSTAT  DIM       12 
BOOKTYPE  DIM       1
CLAIMCOD  DIM       20
DATEFLAG  DIM       1
DEFTVIEW  FORM      1
KEY8A     DIM       8
KEY16A    DIM       16
FHRSUBIN  FORM      1      * _include=Encounter:subject
FHRLOCIN  FORM      1      * _include=Encounter:location
FHRPARIN  FORM      1      * _include=Encounter:participant
DIM2A     DIM       2
DIM2B     DIM       2
DIM3      DIM       3
DIM4      DIM       4
DIM5      DIM       5
DIM8      DIM       8
DIM12     DIM       12
DAYTIME   DIM       3
DOCTCODE  DIM       6
DOCTSTAT  FORM      1
EXPCTDSC  DIM       30
EXPDDATE  DIM       12
FLAGSTAT  FORM      1
FORM8     FORM      8
ENDNAME   DIM       70
GPCODE    DIM       10
HFUND     DIM       6
IFSTDESC  DIM       25
JAVFNAME  DIM       70
JAVGNAME  DIM       25
JAVSNAME  DIM       20
DISPPCNT  DIM       2
DISPPNAM  DIM       80
DISPPRAC  DIM       10
PRACNAME  DIM       80
PRACADD1  DIM       60
PRACADD2  DIM       60
PRACADD3  DIM       60
PRACADD4  DIM       60
PRACPOST  DIM       8
PRACPEML  DIM       80
PRACPTEL  DIM       20
PRACPFAX  DIM       20
PRACPROV  DIM       10
PTSTATUS  FORM      1
STRTNAME  DIM       70
UNITCODE  DIM       3
UNITDESC  DIM       30
UNTDESC2  DIM       70
LNK2PRT   FORM      1
PATLINK   DIM       127                     * I CAR 45278
PRIVFLAG  DIM       1        * Privacy flag - replaced PTMXSIN5
SHOWADDT  FORM      1   * Show Shared Care visits (not Attending / Secondary) 
SUNTDESC  DIM       25
STATTYPE  DIM       1
STRLEAVE  FORM      1
URNO      DIM       8
VISITTYP  DIM       1
WBEDDESC  FORM      1
.
RLINKPRG  DIM       8
RLINKREP  DIM       2
RLINKTEM  DIM       3
.
.
VTYPE01   INIT      "A & E"
VTYPE02   INIT      "OUTPATIENT"
VTYPE03   INIT      "INPATIENT"
VTYPE04   INIT      "OTHER FINANCIAL"
.
.
NEWTITLE  DIM       30
TITLE01   INIT      "Current Inpatients for "
TITLE02   INIT      "Patient Discharges for "
TITLE03   INIT      "Patient Admissions for " 
TITLE04   INIT      "Patient Pre-Admissions for " 
TITLE05   INIT      "Patient Visits for "
TITLE06   INIT      "Patient Bookings for "
.
.
COLHED01  DIM       30
COLHED02  DIM       30
COLHED03  DIM       30
COLHED04  DIM       30
COLHED05  DIM       30
COLHED06  DIM       30
COLHED07  DIM       30
.
COLDAT01  DIM       30
COLDAT02  DIM       40
COLDAT03  DIM       30
COLDAT04  DIM       30
COLDAT05  DIM       30
COLDAT06  DIM       30
COLDAT07  DIM       30
.
WDBEDTXT  DIM       40
FRWRDTXT  DIM       40
FRBEDTXT  DIM       40
.
ADMTDOCN  DIM       40            * Admitting doctor name
ADMCASET  DIM       50            * Admission Case Team Name  
CASEDOCT  DIM       10            * Case Team HCP Code
CASETEAM  DIM       10            * Case Team number
CMDLINE   DIM       127
CONSULTN  DIM       100           * Consultants Name (Addmitting/Shared Care)
TEMPFIL1  DIM       8             * Temp file name
ISBUILD   INIT      "isbuild "
ISERASE   INIT      "iserase "
UKEY1     INIT      " 279 U1-8"
.
.
.         Temporary File Definition
.         -------------------------
.
DOCVTEMP  IFILE SQL, FIXED=279, KEY="U1-8"
.
.NAME     TYPE    LENGTH     PHYSICAL     START     DESCRIPTION
.----     ----    ------     --------     -----     -----------
.ADMISSNO DIM     8          8                1     Admission No.
.URNUMBER DIM     8          8                9     U/R No.
.WDBEDTXT DIM     40         40              17     Ward/Bed description
.ADATE    DIM     8          8               57     Admission Date
.ATIME    DIM     8          8               65     Admission Time
.ADIAG1   DIM     80         80              73     Admitting Diag 1
.ADIAG2   DIM     80         80             153     Admitting Diag 2
.ATYPDESC DIM     20         20             233     Admission Type
TMPADOCT  DIM     6          6              253     Attending Doctor
TMPSDOCT  DIM     10         10             259     Secondary/Shared Care Doctor
TMPCASET  DIM     10         10             269     Case Team Number
.
. End of Record                             269
.



ADMITT    INIT      "Admitted"
BOOKED    INIT      "Booked"
BKTCODE   INIT      "BK"
CANCEL    INIT      "Cancelled"
DISCHR    INIT      "Discharged"
PREADM    INIT      "Pre-Admitted"
.
ENSTATUS  DIM       20  * Enocunter Status
LCSTATUS  DIM       20  * Location Status
ID        DIM       8
TIMEZONE  DIM       6
TZFILE    FILE      ASCII, FIXED=256
.-----------------------------------------------------------
PRGID     INIT      "PATWEB97" 
VERSION   INIT      "V12.00.01"
PRGNAM    INIT      "Doctor Infomation Server"
.-----------------------------------------------------------
.
          CALL      WEBINT00       * Initialise Fifo Etc.
          CALL      INIT0000       * Open Files
.
MAIN1000  CALL      WEBRED00       * Read Fifo WEBPID and USERID
.
          COMPARE   "999",REPORTNO * End Server Process on Report Option 999
          GOTO      MAIN9999 IF EQUAL
.
          BRANCH    REPORTNO,MAIN1100,MAIN1200,MAIN1300:
                             MAIN1400,MAIN1500,MAIN1600
.
          PACK      WEBTITLE,PRGID,SP1,VERSION,SP1,PRGNAM,SP70
          MOVE      "INVALID OPTION",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          GOTO      MAIN1000
.
MAIN1100  CALL      CHKDOC00  
          GOTO      MAIN1000
.
MAIN1200  CALL      CHKDOC00  
          GOTO      MAIN1000
.
MAIN1300  CALL      CHKDOC00  
          GOTO      MAIN1000
.
MAIN1400  CALL      CHKDOC00  
          GOTO      MAIN1000
.
MAIN1500  CALL      CHKDOC00  
          GOTO      MAIN1000
.
MAIN1600  CALL      CHKDOC00  
          GOTO      MAIN1000
.
MAIN9999  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      WEBERR00
          STOP
.------------------------------------------------------------
. Open Files and Initialize Variables
.------------------------------------------------------------
INIT0000  CALL      GETTZ000
          OPEN      PATVISA1,"patvisaf"
          OPEN      PMSVX1A1,"pmsvx1af"
          OPEN      PATHSPA1,"pathspaf"
          OPEN      PATMA1A1,"patma1af"
          OPEN      PATMX1A1,"patmx1af"
          OPEN      PMSPX2A1,"pmspx2af"
          OPEN      PMSCEXA1,"pmscexaf"
          OPEN      PMSRELA1,"pmsrelaf"
          OPEN      PMSTLEA1,"pmstleaf"          * open Patient Titles table
          OPEN      PMSTLEA2,"pmstleaf"
          OPEN      PMSHCPA1,"pmshcpaf"
          OPEN      PMSHCLA1,"pmshclaf"
          OPEN      PATPX1A1,"patpx1af"
          OPEN      PATDO1A1,"patdo1af"
          OPEN      PATPR1A1,"patpr1af"
          OPEN      PATWR1A1,"patwr1af"
          OPEN      PATWR1A4,"patwr1af"
          OPEN      PATVADA1,"patvadaf"
          OPEN      PMSCDNA1,"pmscdnaf"
          OPEN      PMSDTCA1,"pmsdtcaf"
.
          OPEN      PATDO1A2,"patdo1af"
          OPEN      PATCODE1,"patcodes"
          OPEN      PATCODE2,"patcodes"
          OPEN      PATDSCH1,"patdschf"
          OPEN      PATDSCH2,"patdschf"
          OPEN      PATMI1A1,"patmi1af"
          OPEN      PATMI1A2,"patmi1af"
          OPEN      PATMI1A4,"patmi1af"
          OPEN      PATMI1A5,"patmi1af"
          OPEN      PATTRAN3,"pattranf"
          OPEN      PATVISA3,"patvisaf"
          OPEN      BOKRC1A3,"bokrc1af"
          OPEN      PATCODE1,"patcodes"
          OPEN      OPRDETA2,"oprdetaf"
          OPEN      PMSWORA1,"pmsworaf"                                *I-23312
          OPEN      CONTROLF,"controlf"
          READ      CONTROLF,ZERO;*43,IBCNMHOS        * Multi Hosp Indicator
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
          ENDIF
.
          READ      CONTROLF,HUND12;*104,PTCNWBDS
          MOVE      PTCNWBDS,WBEDDESC            * CAR 151896
.
          OPEN      ALLCTMA1,"allctmaf"     * HCP Case Team Member Details
          OPEN      ALLCTMA2,"allctmaf"
          OPEN      ALLCASA1,"allcasaf"     * HCP Case Team Details
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,TEMPFIL1
.
INIT9999  RETURN
.------------------------------------------------------------
. Get Time Zone
.------------------------------------------------------------
GETTZ000  MOVE      ZERO,OVRCD
          MOVE      "+0000",KEY5
          TRAP      OVERCOND IF IO
          OPEN      TZFILE,"timezone"
          TRAPCLR   IO
          IF        OVRCD=0
            READ      TZFILE,SEQ;KEY5
          ELSE
            EXECUTE   "date +#"%z#">timezone.txt",TASKID
            TRAP      OVERCOND IF IO
            OPEN      TZFILE,"timezone"
            TRAPCLR   IO
            IF        OVRCD=0
              READ      TZFILE,SEQ;KEY5
            ENDIF
          ENDIF
          CLOSE     TZFILE
          UNPACK    KEY5,KEY3,KEY2
          PACK      TIMEZONE,KEY3,COLON,KEY2
          RETURN
.------------------------------------------------------------
. Clear Parameters
.------------------------------------------------------------
CLRPAR00  MOVE      ZERO,REPORTNO
          MOVE      SP70,TEMPLATE
          MOVE      SP70,DOCTCODE
          MOVE      SP70,UNITCODE
          MOVE      SP70,FRSTDATE
          MOVE      SP70,LASTDATE
          MOVE      SP70,VIEWTYPE
          MOVE      SP70,VYEARMTH
          MOVE      ZERO,DOCTSTAT
          MOVE      SP70,VISITTYP
          MOVE      ZERO,DEFTVIEW
          MOVE      ZERO,SHOWADDT
          MOVE      SP70,CASETEAM
          MOVE      SP70,CASEDOCT
          MOVE      ZERO,FHRSUBIN
          MOVE      ZERO,FHRLOCIN
          MOVE      ZERO,FHRPARIN
          MOVE      ZERO,PTSTATUS
.
CLRPAR99  RETURN
.
.------------------------------------------------------------
. Set Parameters
.------------------------------------------------------------
SETPAR00  MATCH     "reportno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REPORTNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "template=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TEMPLATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "doctcode=",QRYNAME
          IF        @EQUAL
            PACK      DOCTCODE,QRYDATA,SP70
            GOTO      SETPAR99 
          ENDIF
.
          MATCH     "unitcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UNITCODE
            PACK      UNITCODE,UNITCODE,SP70
            GOTO      SETPAR99 
          ENDIF
.
          MATCH     "viewtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VIEWTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "frstdate=",QRYNAME 
          IF        @EQUAL
            MOVE      QRYDATA,FRSTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "lastdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LASTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "vyearmth=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VYEARMTH
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "visittyp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VISITTYP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "deftview=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DEFTVIEW
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fhrsubin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FHRSUBIN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fhrlocin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FHRLOCIN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fhrparin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FHRPARIN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptstatus=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PTSTATUS
            GOTO      SETPAR99
          ENDIF
.
SETPAR99  RETURN
.-------------------------------------------------------------
. Check for Valid Doctor Code
.-------------------------------------------------------------
CHKDOC00  MATCH     SP70,DOCTCODE
          IF        @EQUAL
            MOVE      WBSEDOC,DOCTCODE
          ENDIF
.
          MOVE      DOCTCODE,KEY6
          CALL      RDDOCT1
          IF        OVRCD=1
            CALL      CLRDOC00
          ENDIF
.
          CALL      CURPER00 
          CALL      CALCDT00   * Calculate Next and Last Period Dates
          MOVE      DTITL,FMTTITLE
          MOVE      DGNAME,FMTGNAME
          MOVE      DSNAME,FMTSNAME
          CALL      DOCNM000
.
          CLEAR     WEBTITLE 
          LOAD      NEWTITLE,REPORTNO,TITLE01,TITLE02,TITLE03:
                                      TITLE04,TITLE05,TITLE06 
          APPEND    NEWTITLE,WEBTITLE
          APPEND    DOCFNAME,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,CHKDOC99
.
          CALL      WEBBOD00   * Process Web Body
.
          CALL      WEBEND00   * Process End of HTML File
.
CHKDOC99  RETURN
.----------------------------------------------------------------------
. Clear Doctor Details if Code is invalid
.----------------------------------------------------------------------
CLRDOC00  MOVE       "~~~~~~",DOCTCODE
          MOVE       "~~~~~~",DCODE
          MOVE       SP70,DTITL
          MOVE       SP70,DGNAME
          MOVE       "Not Specified",DSNAME
          MOVE       SP70,DRTYPE
          MOVE       SP70,DRNAME
          MOVE       SP70,DSADD1
          MOVE       SP70,DSADD2
          MOVE       SP70,DSADD3
          MOVE       SP70,DSADD4
          MOVE       SP70,DSPOST
          MOVE       SP70,DTELES
          MOVE       SP70,DTELEP
          MOVE       ZERO,DPAGER 
          MOVE       SP70,DASSOC1   
          MOVE       SP70,DASSOC2
          MOVE       SP70,DPROV 
          MOVE       SP70,DTELEH
          MOVE       SP70,DHADD1
          MOVE       SP70,DHADD2
          MOVE       SP70,DHADD3
          MOVE       SP70,DHADD4
          MOVE       SP70,DHPOST
          MOVE       SP70,DAFIRST
          MOVE       SP70,DALAST 
          MOVE       ZERO,DAYEARS
          MOVE       SP70,DACCRED
          MOVE       SP70,DRTYPE2
          MOVE       SP70,DRTYPE3
          MOVE       SP70,DRTYPE4
          MOVE       SP70,DRTYPE5
          MOVE       SP70,PTDONHSN 
          MOVE       SP70,DBIRTH
          MOVE       ZERO,DHCSCOD
          MOVE       SP70,DALEVEL
          MOVE       ZERO,DRSTAT
          MOVE       SP70,DASPARE
.
CLRDOC99  RETURN
.
.-------------------------------------------------------------
.Process Fields From Template Body
.-------------------------------------------------------------
.
PROFLD00  BRANCH    REPORTNO,PROFLD10,PROFLD20,PROFLD30,PROFLD40:
                             PROFLD50,PROFLD60
.
. Current Admissions
.--------------------
PROFLD10  BRANCH    FLDSETNO,PROFLD11,PROFLD12  
          GOTO      PROFLD99
.
PROFLD11  CALL      ADMT0000
          GOTO      PROFLD99
.
PROFLD12  CALL      DOCF0000
          GOTO      PROFLD99
.
. Discharged Patients by Date Range
.-----------------------------------
PROFLD20  BRANCH    FLDSETNO,PROFLD21,PROFLD22  
          GOTO      PROFLD99
.
PROFLD21  CALL      PADI0000 
          GOTO      PROFLD99
.
PROFLD22  CALL      DOCF0000
          GOTO      PROFLD99
.
. Patient Admission by Date Range
.---------------------------------
PROFLD30  BRANCH    FLDSETNO,PROFLD31,PROFLD32
          GOTO      PROFLD99
.
PROFLD31  CALL      PAAD0000
          GOTO      PROFLD99
.
PROFLD32  CALL      DOCF0000
          GOTO      PROFLD99
.
. Patient Pre-Admission by Date Range
.-------------------------------------
PROFLD40  BRANCH    FLDSETNO,PROFLD41,PROFLD42
          GOTO      PROFLD99
.
PROFLD41  CALL      PAPR0000
          GOTO      PROFLD99
.
PROFLD42  CALL      DOCF0000
          GOTO      PROFLD99
.
. Patient Visits by Date Range
.-----------------------------
PROFLD50  BRANCH    FLDSETNO,PROFLD51,PROFLD52
          GOTO      PROFLD99
.
PROFLD51  CALL      PAVI0000
          GOTO      PROFLD99
.
PROFLD52  CALL      DOCF0000
          GOTO      PROFLD99
.
. Patient Bookings by Date Range
.-----------------------------
PROFLD60  BRANCH    FLDSETNO,PROFLD61,PROFLD62
          GOTO      PROFLD99
.
PROFLD61  CALL      PBOK0000
          GOTO      PROFLD99
.
PROFLD62  CALL      DOCF0000
          GOTO      PROFLD99
.
PROFLD99  RETURN
.------------------------------------------------------------
. Current Admission
.------------------------------------------------------------
ADMT0000  BRANCH    FLDITMNO,ADMT0100,ADMT0200,ADMT0300,ADMT0400,ADMT0500:
                             ADMT0600,ADMT0700,ADMT0800,ADMT0900,ADMT1000:
                             ADMT1100,ADMT1200
.
ADMT0100  MOVE      ZERO,LNK2PRT
          CALL      TOCA0000
          GOTO      ADMT9999
.
ADMT0200  MOVE      ONE,LNK2PRT
          CALL      TOCA0000
          GOTO      ADMT9999
.
ADMT0300  MOVE      TWO,LNK2PRT
          CALL      TOCA0000
          GOTO      ADMT9999
.
ADMT0400  CALL      TABADM00
          GOTO      ADMT9999
.
ADMT0500  CALL      TABRDM00
          GOTO      ADMT9999
.
ADMT0600  MOVE      "AC",CATEGORY
          MOVE      UNITCODE,CODE
          CALL      CODITM00
          GOTO      PROFLD99
.
ADMT0700  MOVE      ZERO,SHOWADDT
          CALL      TABSHR00
          GOTO      ADMT9999
.
ADMT0800  CALL      TABGPA00
          GOTO      ADMT9999
.
ADMT0900  UNPACK    DIM127,D1,KEY1,DIM127
          MATCH     SP70,WBSEGPCD
          GOTO      ADMT9999 IF EQUAL
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,ADMT0910             * 0=description, 1=code
.
          PACK      KEY10,WBSEGPCD,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,ADMT0910
          MOVE      PMHCTITL,FMTTITLE
          MOVE      PMHCSNAM,FMTSNAME
          MOVE      PMHCGNAM,FMTGNAME
          CALL      DOCNM000
          WRITE     HTMLFILE;DOCFNAME;
          GOTO      ADMT9999
.
ADMT0910  WRITE     HTMLFILE;WBSEGPCD;
          GOTO      ADMT9999
.
ADMT1000  WRITE     HTMLFILE;DEFTVIEW;
          GOTO      ADMT9999
.
ADMT1100  MOVE      ONE,SHOWADDT
          CALL      TABSHR00
          GOTO      ADMT9999
.
ADMT1200  CALL      TABADV00      * All admissions by doctor (incl. Case Team)
          GOTO      ADMT9999
.
ADMT9999  RETURN
.------------------------------------------------------------
. Table of Current Admissions
.------------------------------------------------------------
TOCA0000  WRITE     HTMLFILE;"<tr>":
                             "<td class=HeadingCell align=center colspan=7>":
                             "Current Admissions - ",DOCFNAME,"</td></tr>":
                             "<tr><td class=HeadingCell>Name</td>":
                             "<td class=HeadingCell>Ward/Bed</td>":
                             "<td class=HeadingCell>Adm. Date</td>": 
                             "<td class=HeadingCell>Sex</td>": 
                             "<td class=HeadingCell>Age</td>": 
                             "<td class=HeadingCell>Diagnosis</td>": 
                             "</tr>"
          IF        LNK2PRT=0
            UNPACK    DIM127,D1,LINKPRG,DIM127
            UNPACK    DIM127,D1,LINKREP,DIM127
            UNPACK    DIM127,D1,LINKTEM,DIM127
          ENDIF
          IF        LNK2PRT=2
            UNPACK    DIM127,D1,LINKPRG,DIM127
            UNPACK    DIM127,D1,LINKREP,DIM127
            UNPACK    DIM127,D1,LINKTEM,DIM127
            UNPACK    DIM127,D1,RLINKPRG,DIM127
            UNPACK    DIM127,D1,RLINKREP,DIM127
            UNPACK    DIM127,D1,RLINKTEM,DIM127
          ENDIF
          PACK      KEY21,TWO,DOCTCODE,SP70
          CALL      RDSMISS5
TOCA1000  CALL      RDKMISS5
          BRANCH    OVRCD,TOCA2000
          COMPARE   "2",ASTAT
          GOTO      TOCA2000 IF NOT EQUAL
          MATCH     ADOCTA,DOCTCODE
          GOTO      TOCA2000 IF NOT EQUAL
          MATCH     SP70,UNITCODE
          IF        !@EQUAL
            MATCH     UNITCODE,ACLSSFT
            GOTO      TOCA2000 IF NOT EQUAL
          ENDIF
.
          CALL      FWDBED00       * format ward/bed text  
.
          CALL      ADMDAT00
          PACK      COLDAT03,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MOVE      AURNO,URNUMBER
          MOVE      AADMNO,ADMISSNO
          MOVE      AURNO,URNO
.        
          CALL      ADMROW00
          GOTO      TOCA1000
.
TOCA2000  MOVE      ZERO,STRLEAVE
          PACK      KEY21,FOUR,DOCTCODE,SP70
          CALL      RDSMISS5
TOCA3000  CALL      RDKMISS5
          BRANCH    OVRCD,TOCA9000
. 
          MATCH     ADOCTA,DOCTCODE
          GOTO      TOCA9000 IF NOT EQUAL
          MATCH     SP70,UNITCODE
          IF        !@EQUAL
            MATCH     UNITCODE,ACLSSFT
            GOTO      TOCA2000 IF NOT EQUAL
          ENDIF
          COMPARE   "4",ASTAT
          GOTO      TOCA9000 IF NOT EQUAL
.
          PACK      COLDAT02,TWARD,SLASH,TBED
.
          CALL      ADMDAT00
          PACK      COLDAT03,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MOVE      AURNO,URNUMBER
          MOVE      AADMNO,ADMISSNO
          MOVE      AURNO,URNO
.
          IF        STRLEAVE=0
            MOVE      ONE,STRLEAVE
            WRITE     HTMLFILE;"<tr>":
                               "<td align=center colspan=6 class=HeadingCell>":
                               "<b>Patients On Leave for ",DOCFNAME,"</b></td>":
                               "</tr>"
          ENDIF
          CALL      ADMROW00
          GOTO      TOCA3000
TOCA9000  
TOCA9999  RETURN
.
.------------------------------------------------------------
. Patient Discharges by Doctor
.------------------------------------------------------------
PADI0000  BRANCH    FLDITMNO,PADI0100,PADI0200,PADI0300,PADI0400:
                             PADI0500,PADI0600,PADI0700,PADI0800:
                             PADI0900,PADI1000,PADI1100,PADI1200
.
PADI0100  CALL      NEXT0000
          GOTO      PADI9999
.
PADI0200  CALL      PREV0000
          GOTO      PADI9999
.
PADI0300  CALL      CURSTD00
          GOTO      PADI9999
.
PADI0400  CALL      CUREND00
          GOTO      PADI9999
.
PADI0500  CALL      CURYR000
          GOTO      PADI9999
.
PADI0600  CALL      CURMON00
          GOTO      PADI9999
.
PADI0700  CALL      SELV0000
          GOTO      PADI9999
.
PADI0800  MOVE      ZERO,XFORMAT
          CALL      TODP0000
          GOTO      PADI9999
.
PADI0900  WRITE     HTMLFILE;TEMPLATE;
          GOTO      PADI9999
.
PADI1000  WRITE     HTMLFILE;REPORTNO;
          GOTO      PADI9999
.
PADI1100  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      PADI9999
.
PADI1200  MOVE      ONE,XFORMAT
          CALL      TODP0000
          GOTO      PADI9999
.
PADI9999  RETURN
.
.------------------------------------------------------------
. Table of Discharged Patients
.------------------------------------------------------------
TODP0000  MOVE      "Adm. Date",COLHED02 
          MOVE      "Dis. Date",COLHED03
          MOVE      "Dis. Time",COLHED04
          IF        XFORMAT=0
            CALL      TABHED00  
          ENDIF
          PACK      KEY36,DOCTCODE,FRSTDATE,SP70 
          CALL      RDSTRAN3
TODP1000  CALL      RDKTRAN3
          BRANCH    OVRCD,TODP9000
          MATCH     DOCTCODE,TADOCT
          GOTO      TODP9000 IF NOT EQUAL
          MATCH     TDATE,LASTDATE
          GOTO      TODP9000 IF LESS
          MATCH     "D",TMOVE
          GOTO      TODP1000 IF NOT EQUAL
.
          MOVE      TADMN,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,TODP1000
.
          CALL      ADMDAT00
          PACK      COLDAT02,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          MOVE      AURNO,URNO
.
          MOVE      TADMN,KEY8
          CALL      RDDSCH1
          BRANCH    OVRCD,TODP1000
.
          CALL      DISDAT00
          PACK      COLDAT03,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          CALL      DISTIM00
          PACK      COLDAT04,DIM2,DIM1,DIM2A,SP2,DIM2B
.
          PACK      URNUMBER,DURNO 
          PACK      ADMISSNO,DADMNO
.
          IF        XFORMAT=0
            CALL      TABCON00
          ELSE
            CALL      DISCON00
          ENDIF
.
          GOTO      TODP1000
TODP9000  
TODP9999  RETURN
.------------------------------------------------------------
. Discharge Table Contents 
.------------------------------------------------------------
DISCON00  CALL      GETPAT00  
          MOVE      SP70,DOCFNAME
          MOVE      ADOCTA,KEY6
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE 
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000  
          ENDIF
          CALL      PATLN000      * Format Pateint Name with System Parameter
          IF        PTCNDRSM=1
            MOVE      CATD,CATEGORY
            MOVE      DSTAT,CODE
          ELSE
            MOVE      CATDD,CATEGORY       * Get Discharge Destination Descrip.
            MOVE      DDEST,CODE
          ENDIF
          CALL      GETCOD00
          MOVE      TDESC,DESTDESC
.
          PACK      PTYPDESC,SP70
          MATCH     SP3,PMVXIDUS
          IF        !@EQUAL
            PACK      KEY5,CODEVI,PMVXIDUS
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,PTYPDESC
            ENDIF
          ENDIF
.
          PACK      ATYPDESC,SP70
          MATCH     SP3,ATYPE
          IF        !@EQUAL
            PACK      KEY5,ANSA,SP1,ATYPE,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,ATYPDESC
            ENDIF
          ENDIF
.
          PACK      ASRCDESC,SP70
          MATCH     SP3,ASRCE
          IF        !@EQUAL
            PACK      KEY5,ANSS,SP1,ASRCE,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,ASRCDESC
            ENDIF
          ENDIF
.
          REP       "#" ",ADIAG1
          REP       "#" ",ADIAG2
          REP       "#" ",DDIAG
          REP       "#" ",DDIAG2
          PACK      KEY6,PTDSDWRD,SP70
          CALL      RDWARD1
          IF        OVRCD=1
            MOVE      SP70,WBDESC
          ENDIF
.
          WRITE     HTMLFILE;"t.addRow(":
                             "#"",URNUMBER,"#",":      *0
                             "#"",ADMISSNO,"#",":      *1
                             "#"",FORMATNM,"#",":      *2
                             "#"",ADATE,ATIME,"#",":   *3
                             "#"",DDATE,DTIME,"#",":   *4
                             "#"",DISPSEX,"#",":       *5
                             "#"";
          CALL      WRTAGE00                           *6
          CALL      PATFLD00                           
          WRITE     HTMLFILE;"#",":
                             "#"",KEY3,"#",":          *7
                             "#"",DOCFNAME,"#",":      *8
                             "#"",ADIAG1,ADIAG2,"#",": *9
                             "#"",DDIAG,DDIAG2,"#",": *10
                             "#"",DESTDESC,"#",":      *11
                             "#"",WBDESC,"#",":        *12
                             "#"",PTYPDESC,"#",":      *13
                             "#"",ATYPDESC,"#",":      *14
                             "#"",ASRCDESC,"#");"      *15
.
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
DISCON99  RETURN
.------------------------------------------------------------
. Patient Admission by Date    
.------------------------------------------------------------
PAAD0000  BRANCH    FLDITMNO,PAAD0100,PAAD0200,PAAD0300,PAAD0400:
                             PAAD0500,PAAD0600,PAAD0700,PAAD0800:
                             PAAD0900,PAAD1000,PAAD1100 
.
PAAD0100  CALL      NEXT0000
          GOTO      PAAD9999
.
PAAD0200  CALL      PREV0000
          GOTO      PAAD9999
.
PAAD0300  CALL      CURSTD00
          GOTO      PAAD9999
.
PAAD0400  CALL      CUREND00
          GOTO      PAAD9999
.
PAAD0500  CALL      CURYR000
          GOTO      PAAD9999
.
PAAD0600  CALL      CURMON00
          GOTO      PAAD9999
.
PAAD0700  CALL      SELV0000
          GOTO      PAAD9999
.
PAAD0800  CALL      TOPA0000
          GOTO      PAAD9999
.
PAAD0900  WRITE     HTMLFILE;TEMPLATE;
          GOTO      PAAD9999
.
PAAD1000  WRITE     HTMLFILE;REPORTNO;
          GOTO      PAAD9999
.
PAAD1100  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      PAAD9999
.
PAAD9999  RETURN
.
.------------------------------------------------------------
. Table of Patient Admissions
.------------------------------------------------------------
TOPA0000  MOVE      "Adm. Date",COLHED02 
          MOVE      "Dis. Date",COLHED03
          CALL      TABHED00  
          PACK      KEY36,DOCTCODE,FRSTDATE,SP70 
          CALL      RDSTRAN3
TOPA1000  CALL      RDKTRAN3
          BRANCH    OVRCD,TOPA9000
          MATCH     DOCTCODE,TADOCT
          GOTO      TOPA9000 IF NOT EQUAL
          MATCH     TDATE,LASTDATE
          GOTO      TOPA9000 IF LESS
          MATCH     "A",TMOVE
          GOTO      TOPA1000 IF NOT EQUAL
.
          MOVE      TADMN,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,TOPA1000
.
          CALL      ADMDAT00
          PACK      COLDAT02,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          MOVE      AURNO,URNO
.
          MOVE      TADMN,KEY8
          CALL      RDDSCH1
          BRANCH    OVRCD,TOPA2000
.
          CALL      DISDAT00
          PACK      COLDAT03,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
TOPA2000  PACK      COLDAT03,COLDAT03,SP70
          MOVE      TURNO,URNUMBER
          MOVE      TADMN,ADMISSNO
.
          CALL      TABCON00
.
          GOTO      TOPA1000
TOPA9000  
TOPA9999  RETURN
.------------------------------------------------------------
. Patient Pre-Admission by Date Range   
.------------------------------------------------------------
PAPR0000  BRANCH    FLDITMNO,PAPR0100,PAPR0200,PAPR0300,PAPR0400:
                             PAPR0500,PAPR0600,PAPR0700,PAPR0800:
                             PAPR0900,PAPR1000,PAPR1100 
.
PAPR0100  CALL      NEXT0000
          GOTO      PAPR9999
.
PAPR0200  CALL      PREV0000
          GOTO      PAPR9999
.
PAPR0300  CALL      CURSTD00
          GOTO      PAPR9999
.
PAPR0400  CALL      CUREND00
          GOTO      PAPR9999
.
PAPR0500  CALL      CURYR000
          GOTO      PAPR9999
.
PAPR0600  CALL      CURMON00
          GOTO      PAPR9999
.
PAPR0700  CALL      SELV0000
          GOTO      PAPR9999
.
PAPR0800  CALL      TOPR0000
          GOTO      PAPR9999
.
PAPR0900  WRITE     HTMLFILE;TEMPLATE;
          GOTO      PAPR9999
.
PAPR1000  WRITE     HTMLFILE;REPORTNO;
          GOTO      PAPR9999
.
PAPR1100  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      PAPR9999
.
PAPR9999  RETURN
.
.------------------------------------------------------------
. Table of Patient Pre-Admissions
.------------------------------------------------------------
TOPR0000  MOVE      "Ward/Bed",COLHED02 
          MOVE      "Adm. Date",COLHED03
          CALL      TABHED00  
          PACK      KEY21,ONE,DOCTCODE,SP70 
          CALL      RDSMISS5
TOPR1000  CALL      RDKMISS5
          BRANCH    OVRCD,TOPR9000
          MATCH     DOCTCODE,ADOCTA
          GOTO      TOPR9000 IF NOT EQUAL
.
          MATCH     FRSTDATE,ADATE
          GOTO      TOPR1000 IF LESS
          MATCH     LASTDATE,ADATE
          GOTO      TOPR1000 IF NOT LESS
          COMPARE   "1",ASTAT
          GOTO      TOPR1000 IF NOT EQUAL
.
          CALL      FWDBED00          * format ward/bed text 
          CALL      ADMDAT00
          PACK      COLDAT03,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MOVE      AURNO,URNUMBER
          MOVE      AADMNO,ADMISSNO
          MOVE      AURNO,URNO
.
          CALL      TABCON00
.
          GOTO      TOPR1000
TOPR9000  
TOPR9999  RETURN
.------------------------------------------------------------
. Patient Visits by Date Range   
.------------------------------------------------------------
PAVI0000  BRANCH    FLDITMNO,PAVI0100,PAVI0200,PAVI0300,PAVI0400:
                             PAVI0500,PAVI0600,PAVI0700,PAVI0800:
                             PAVI0900,PAVI1000,PAVI1100
.
PAVI0100  CALL      NEXT0000
          GOTO      PAVI9999
.
PAVI0200  CALL      PREV0000
          GOTO      PAVI9999
.
PAVI0300  CALL      CURSTD00
          GOTO      PAVI9999
.
PAVI0400  CALL      CUREND00
          GOTO      PAVI9999
.
PAVI0500  CALL      CURYR000
          GOTO      PAVI9999
.
PAVI0600  CALL      CURMON00
          GOTO      PAVI9999
.
PAVI0700  CALL      SELV0000
          GOTO      PAVI9999
.
PAVI0800  CALL      TOPV0000
          GOTO      PAVI9999
.
PAVI0900  WRITE     HTMLFILE;TEMPLATE;
          GOTO      PAVI9999
.
PAVI1000  WRITE     HTMLFILE;REPORTNO;
          GOTO      PAVI9999
.
PAVI1100  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      PAVI9999
.
PAVI9999  RETURN
.
.------------------------------------------------------------
. Table of Patient Visits          
.------------------------------------------------------------
TOPV0000  MOVE      "Visit Type",COLHED02 
          MOVE      "Visit Date",COLHED03
          CALL      TABHED00  
          PACK      KEY22,DOCTCODE,FRSTDATE,SP70
          CALL      RDSVISA3
TOPV1000  CALL      RDKVISA3
          BRANCH    OVRCD,TOPV9000
          MATCH     DOCTCODE,PVIDOCT
          GOTO      TOPV9000 IF NOT EQUAL
          MATCH     PVIDATE,LASTDATE
          GOTO      TOPV9000 IF LESS
.
          UNPACK    PVIDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      COLDAT03,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          LOAD      COLDAT02,PVITYPE,VTYPE01,VTYPE02,VTYPE03,VTYPE04
.
          MOVE      VISITTYP,F1
          IF        F1<>0
            COMPARE   F1,PVITYPE
            GOTO      TOPV1000 IF NOT EQUAL
          ENDIF
.
          PACK      URNUMBER,PVIURNO
          PACK      ADMISSNO,PVIBILL
          MOVE      PVIURNO,URNO
.
          CALL      TABCON00
.
          GOTO      TOPV1000
TOPV9000  
TOPV9999  RETURN
.
.------------------------------------------------------------
. Patient Bookings by Date    
.------------------------------------------------------------
PBOK0000  BRANCH    FLDITMNO,PBOK0100,PBOK0200,PBOK0300,PBOK0400:
                             PBOK0500,PBOK0600,PBOK0700,PBOK0800:
                             PBOK0900,PBOK1000,PBOK1100 
.
PBOK0100  CALL      NEXT0000
          GOTO      PBOK9999
.
PBOK0200  CALL      PREV0000
          GOTO      PBOK9999
.
PBOK0300  CALL      CURSTD00
          GOTO      PBOK9999
.
PBOK0400  CALL      CUREND00
          GOTO      PBOK9999
.
PBOK0500  CALL      CURYR000
          GOTO      PBOK9999
.
PBOK0600  CALL      CURMON00
          GOTO      PBOK9999
.
PBOK0700  CALL      SELV0000
          GOTO      PBOK9999
.
PBOK0800  CALL      TOPB0000
          GOTO      PBOK9999
.
PBOK0900  WRITE     HTMLFILE;TEMPLATE;
          GOTO      PBOK9999
.
PBOK1000  WRITE     HTMLFILE;REPORTNO;
          GOTO      PBOK9999
.
PBOK1100  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      PBOK9999
.
PBOK9999  RETURN
.
.------------------------------------------------------------
. Table of Patient Bookings
.------------------------------------------------------------
TOPB0000  MOVE      "Booking Date/Time",COLHED02 
          MOVE      "Booking Status",COLHED03
          MOVE      "Exp. Discharge",COLHED04
          CALL      TABHED00  
          PACK      KEY22,DOCTCODE,FRSTDATE,SP70 
          CALL      RSBKREC3
TOPB1000  CALL      RKBKREC3
          BRANCH    OVRCD,TOPB9000
          MATCH     DOCTCODE,BKREADOC
          GOTO      TOPB9000 IF NOT EQUAL
          MATCH     BKREEDAT,LASTDATE
          GOTO      TOPB9000 IF LESS
.
          REP       "aA",BOOKTYPE
          MATCH     "A",BOOKTYPE
          GOTO      TOPB4000 IF EQUAL
          MOVE      BKRESTAT,STATTYPE
          MATCH     BOOKTYPE,STATTYPE
          GOTO      TOPB1000 IF NOT EQUAL
.
TOPB4000  PACK      BOOKSTAT,BOOKED,SP6
          MOVE      BKRESTAT,F1
          LOAD      BOOKSTAT,F1,PREADM,CANCEL,ADMITT,DISCHR
          MOVE      BOOKSTAT,COLDAT03
.
          MOVE      BKREURNO,URNUMBER
          MOVE      BKREBOOK,ADMISSNO
.
          PACK      KEY5,BKTCODE,BKRETYPE,SP5
          CALL      RDCODE1
          MATCH     "THE ",THCSCOD
          IF        @EQUAL
            PACK      KEY31,BKREBOOK,Z70
            CALL      RSOPDEA2
            CALL      RPOPDEA2
            IF        OVRCD=0
              PACK      DTIME,OPDAEXPS,SP3
            ENDIF
          ELSE
            PACK      DTIME,SP8
            MOVE      BKREATIM,DTIME
          ENDIF
.
          MATCH     DTIME,SP8
          IF        @EQUAL
            MOVE      "  ",ATATAT
            MOVE      "  ",DIM2
            MOVE      " ",DIM1
            MOVE      "  ",DIM2A
            MOVE      "  ",DIM2B
          ELSE
            MOVE      "at",ATATAT
            CALL      DISTIM00
          ENDIF
.
          CALL      BOKDAT00
          PACK      COLDAT02,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,ATATAT:
                             DIM2,DIM1,DIM2A,SP2,DIM2B
          MOVE      BKREURNO,URNO   * Not required as U/R No.not displayed
.
          IF        (BKRESTAT=0)|(BKRESTAT=2)
            MOVE      "&nbsp;",EXPCTDSC
            PACK      COLDAT04,EXPCTDSC
          ENDIF
.
          IF        BKRESTAT=4
            PACK      KEY8,BKREBOOK,SP8
            CALL      RDDSCH1
            IF        OVRCD=1
              MOVE      "Error",EXPCTDSC
              PACK      COLDAT04,EXPCTDSC
            ELSE
              CALL      DISDAT00
              PACK      COLDAT04,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
            ENDIF 
          ENDIF
.
          IF        (BKRESTAT=1)|(BKRESTAT=3)
            PACK      KEY8,BKREBOOK,SP8
            CALL      RDMISS1
            IF        OVRCD=1
              MOVE      "Error",EXPCTDSC
              PACK      COLDAT04,EXPCTDSC
            ELSE
              UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
              MOVE      ASTAY,ADJDAYS
              CALL      ADJDAT00
              MOVE      CMON,F2
              LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN:
                                   JUL,AUG,SEP,OCT,NOV,DEC
         
              PACK      COLDAT04,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
            ENDIF
          ENDIF
.
.          MOVE      BKREURNO,URNUMBER
.          MOVE      BKREBOOK,ADMISSNO
.
          CALL      TABCON00
.
          GOTO      TOPB1000
TOPB9000  
TOPB9999  RETURN
.
.
.------------------------------------------------------------
. Get Patient Details
.------------------------------------------------------------
GETPAT00  MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,GETPAT90
          CALL      RDPMPX21
.
.* ****************************************** Start of Changes         *C-49016
          MOVE      PSEX,DSEXCHAR
          CALL      SEXDSC00                * get sex description (in IBACOMN)
.                                           *       returns DSEXDESC & DSEXNO
          MOVE      DSEXDESC,DISPSEX
.* ******************************************   End of Changes         *C-49016
.
          UNPACK    PBDATE,CDAY,CMON,CYEAR,CCENT
          CALL      IBACLOCK
          IF        PCEASE=1
            MOVE      PDECDTE,AGEDATE            * Date of Death
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
          MOVE      ZERO,PRIVFLAG
          PACK      KEY5,ANSP,ANSV,PMPXPRVI,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MATCH     ANSP,TCINDC1
            IF        @EQUAL
              MOVE      ONE,PRIVFLAG
            ENDIF
          ENDIF
.
          CALL      PATLN000
          CALL      STANDP00         *Checks to see is patient is on standby
          GOTO      GETPAT99
.
GETPAT90  MOVE      ADMISSNO,KEY8
          CALL      RDPRAM1
          BRANCH    OVRCD,GETPAT99
.
          CALL      CALCAGE
          CALL      PATLN000
          MOVE      "Unk",PSEX
          MOVE      ZERO,PSAGEYRS
.
GETPAT99  RETURN
.------------------------------------------------------------
. Checks for Patient on standby
.------------------------------------------------------------
STANDP00  PACK     KEY13,ABED,SP70
          PACK     KEY6,AWARD,SP70
          MATCH    SP70,AWARD
          IF       @EQUAL
            PACK      KEY14,AADMNO,SP70
            CALL      RDSWARD4
            CALL      RDKWARD4
            BRANCH    OVRCD,STANDP99
            MATCH     WSTBY,AADMNO
            GOTO      STANDP99 IF NOT EQUAL
            MOVE      WWARD,AWARD
            MOVE      WBED,ABED
            CLEAR     KEY10
            APPEND    SP1,KEY10
            APPEND    "(s)",KEY10
            RESET     KEY10
          ENDIF
          GOTO     STANDP99
.
STANDP99  RETURN
.
.-----------------------------------------------------------
. Format ward/bed text for output 
.-----------------------------------------------------------
FWDBED00  CLEAR     WDBEDTXT
          MOVE      "active",LCSTATUS     * Location Status 
          CLEAR     KEY10
          CALL      STANDP00               * check if standby
.
          MATCH     SP70,AWARD
          GOTO      FWDBED99 IF EQUAL
.  
          PACK      KEY6,AWARD,SP70
          CALL      RDWARD1
          IF        OVRCD=1
            STRIP     AWARD
            APPEND    AWARD,WDBEDTXT
          ELSE    
            STRIP     PTWDSDES
            APPEND    PTWDSDES,WDBEDTXT
          ENDIF
.
          PACK      DIM12,PTWDSDES,SP70
.                         
          MATCH     SP70,ABED
          GOTO      FWDBED90 IF EQUAL
.
          APPEND    "/",WDBEDTXT
.
          PACK      KEY6,AWARD,ABED 
          CALL      RDWARD1        
          BRANCH    OVRCD,FWDBED99
.
          IF        WBEDDESC > 0
            IF        WBEDDESC = 2 
              STRIP     PTWDSDES
              APPEND    PTWDSDES,WDBEDTXT   * use short bed text
            ELSE
              STRIP    WBDESC
              APPEND   WBDESC,WDBEDTXT      * use bed desc, not bed #
            ENDIF   
          ELSE
            STRIP    ABED
            APPEND   ABED,WDBEDTXT
          ENDIF
.
FWDBED90  MATCH     DWSTBY,ADMISSNO
          GOTO      FWDBED99 IF NOT EQUAL
          APPEND    " (s)",WDBEDTXT       * add standby ind. ' (s)'
          MOVE      "planned",LCSTATUS     * Location Status
.
          APPEND    KEY10,WDBEDTXT        * add standby ind. ' (s)'
.
FWDBED99  RESET     WDBEDTXT
          PACK      COLDAT02,WDBEDTXT,SP70
          RETURN
.
.------------------------------------------------------------
. Format FHIR Ward Display Name
.------------------------------------------------------------
FWDNAM00  CLEAR     FRWRDTXT
          MOVE      SP70,FRWRDTXT
.
          MATCH     SP70,AWARD
          GOTO      FWDNAM99 IF EQUAL
.
          PACK      KEY6,AWARD,SP70
          CALL      RDWARD1
          IF        OVRCD=1
            STRIP     AWARD
            MOVE      AWARD,FRWRDTXT
          ELSE
            STRIP     WBDESC
            MOVE      WBDESC,FRWRDTXT
          ENDIF
.
FWDNAM99  RETURN
.
.------------------------------------------------------------
. Format FHIR Bed Display Name
.------------------------------------------------------------
FBDNAM00  CLEAR     FRBEDTXT
          MOVE      SP70,FRBEDTXT
.
          MATCH     SP70,ABED
          GOTO      FBDNAM99 IF EQUAL
.
          PACK      KEY6,AWARD,ABED
          CALL      RDWARD1          
          IF        OVRCD=1
            STRIP     ABED
            MOVE      ABED,FRBEDTXT
          ELSE
            STRIP     WBDESC
            MOVE      WBDESC,FRBEDTXT
          ENDIF
.
FBDNAM99  RETURN
.
.------------------------------------------------------------
. Write Patient Age in Y,M,W or D
.------------------------------------------------------------
WRTAGE00  MATCH     "y",PSAGETYP
          GOTO      WRTAGE10 IF NOT EQUAL
          WRITE     HTMLFILE;PSAGEYRS," yrs";
          GOTO      WRTAGE99
.
WRTAGE10  MATCH     "d",PSAGETYP
          GOTO      WRTAGE20 IF NOT EQUAL
          WRITE     HTMLFILE;PSAGEDAY," days";
          GOTO      WRTAGE99
.
WRTAGE20  MATCH     "m",PSAGETYP
          GOTO      WRTAGE30 IF NOT EQUAL
          WRITE     HTMLFILE;PSAGEMNT," mths";
          GOTO      WRTAGE99
.
WRTAGE30  MATCH     "w",PSAGETYP
          GOTO      WRTAGE99 IF NOT EQUAL
          WRITE     HTMLFILE;PSAGEWKS," wks";
.
WRTAGE99  RETURN
.------------------------------------------------------------
. Next Day, Week, Month
.------------------------------------------------------------
NEXT0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
.
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
.          
          MOVE      DOCTCODE,KEY6
          REP       " +",KEY6
          MOVE      DTITL,FMTTITLE
          MOVE      DGNAME,FMTGNAME
          MOVE      DSNAME,FMTSNAME
          CALL      DOCNM000
.
          MOVE      VISITTYP,F1
          MOVE      F1,KEY1
.  
          WRITE     HTMLFILE;"patweb97.pbl":
                                 "?reportno=",KEY2:    
                                 "&template=",KEY3:
                                 "&doctcode=",KEY6:
                                 "&frstdate=",NXTFDATE:
                                 "&lastdate=",NXTLDATE:
                                 "&viewtype=",VIEWTYPE:
                                 "&visittyp=",KEY1;
.
NEXT9999  RETURN
.
.------------------------------------------------------------
. Previous Day, Week, Month
.------------------------------------------------------------
PREV0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
.
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
.          
          MOVE      DOCTCODE,KEY6
          REP       " +",KEY6
          MOVE      DTITL,FMTTITLE
          MOVE      DGNAME,FMTGNAME
          MOVE      DSNAME,FMTSNAME
          CALL      DOCNM000
.
          MOVE      VISITTYP,F1
          MOVE      F1,KEY1
.  
          WRITE     HTMLFILE;"patweb97.pbl":
                                 "?reportno=",KEY2:    
                                 "&template=",KEY3:
                                 "&doctcode=",KEY6:
                                 "&frstdate=",PREFDATE:
                                 "&lastdate=",PRELDATE:
                                 "&viewtype=",VIEWTYPE:
                                 "&visittyp=",KEY1;
.
PREV9999  RETURN
.-----------------------------------------------------------
. Select Date From
.-----------------------------------------------------------
SELDAT00  UNPACK    DIM127,D1,LINKPRG,DIM127 
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          MOVE      DOCTCODE,KEY6
          MOVE      VIEWTYPE,KEY1
          WRITE     HTMLFILE;"<form name=SelectPeriod ":
                         "action=",LINKPRG,".pbl ":
                         "method=get  >":
                         "<input type=hidden name=reportno value=",LINKREP,">":
                         "<input type=hidden name=template value=",LINKTEM,">":
                         "<input type=hidden name=doctcode value=#"",KEY6,"#">":
                         "<input type=hidden name=viewtype value=",KEY1,">"
.
          CALL      SELV0000
.
          COMPARE   "5",REPORTNO
          IF        @EQUAL
            WRITE     HTMLFILE;" Visit Type",SP2,"<select name=visittyp>":
                               "<option value=0 selected>All</option>":
                               "<option value=1>A & E</option>":
                               "<option value=2>Outpatients</option>":
                               "<option value=3>Inpatients</option>":
                               "</select>"
          ENDIF
.
          WRITE     HTMLFILE;"<input type=submit value=View>":
                             "</form>"
.
SELDAT99  RETURN
.------------------------------------------------------------
. Table Headings
.------------------------------------------------------------
TABHED00  LOAD      NEWTITLE,REPORTNO,TITLE01,TITLE02,TITLE03,TITLE04:
                                      TITLE05,TITLE06 
          WRITE     HTMLFILE;"<tr>":
                              "<td class=HeadingCell align=center colspan=7>":
                              "<b>",NEWTITLE,DOCFNAME,"</b><br>";
.
          IF        REPORTNO<>1
            WRITE     HTMLFILE;"<b>";
.
            CALL      CURSTD00
.
            WRITE     HTMLFILE;" to ";
.
            CALL      CUREND00
.
            WRITE     HTMLFILE;"</b></td></tr>";
          ENDIF
.
          WRITE     HTMLFILE;"<tr>":
                              "<td class=HeadingCell><b>Name</b></td>":
                              "<td class=HeadingCell><b>",COLHED02,"</b></td>":
                              "<td class=HeadingCell><b>",COLHED03,"</b></td>"; 
.
          COMPARE   "2",REPORTNO
          IF        @EQUAL
            WRITE     HTMLFILE;"<td class=HeadingCell><b>",COLHED04,"</b></td>";
          ENDIF
. 
          COMPARE   "6",REPORTNO
          IF        @EQUAL
            WRITE     HTMLFILE;"<td class=HeadingCell><b>",COLHED04,"</b></td>";
          ELSE
            WRITE     HTMLFILE;"<td class=HeadingCell><b>Sex</b></td>":
                               "<td class=HeadingCell><b>Age</b></td>";
          ENDIF
.
          IF        REPORTNO<5
            WRITE     HTMLFILE;"<td class=HeadingCell><b>Diagnosis</b></td>";
          ENDIF
.
          WRITE     HTMLFILE;"</tr>"
.
          COMPARE   ONE,LNK2PRT
          GOTO      TABHED99 IF EQUAL
.
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,BOOKTYPE,DIM127
.
TABHED99  RETURN
.
.------------------------------------------------------------
. Table Contents 
.------------------------------------------------------------
TABCON00  CALL      GETPAT00  
.
          COMPARE   ONE,LNK2PRT
          GOTO      TABCON20 IF EQUAL
.
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
          WRITE     HTMLFILE;"<tr><td nowrap height=30>":
                             "<A HREF='",LINKPRG,".pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO,"'>":
                             "<img src=../images/patweb97-1.gif border=0 ":
                             "hspace=4 align=absmiddle></a>";
.         COMPARE   "6",REPORTNO                        * D SRF 22628
.         IF        @EQUAL
.           WRITE     HTMLFILE;"  ",FORMATNM,"  (":
.                              DISPSEX,COMMA;
.           CALL      WRTAGE00
.           WRITE     HTMLFILE;")</td>";
.         ELSE
.           WRITE     HTMLFILE;"  ",FORMATNM,"  (",URNO,")</td>";
.         ENDIF                                         * end D SRF 22628
          WRITE     HTMLFILE;"  ",FORMATNM,"</td>";     * I SRF 22628
          WRITE     HTMLFILE;"<td nowrap align=center>",COLDAT02,"&nbsp;</td>":
                             "<td nowrap align=center>",COLDAT03,"&nbsp;</td>"; 
.
          COMPARE   "2",REPORTNO
          IF        @EQUAL
            WRITE     HTMLFILE;"<td nowrap align=center>":
                               COLDAT04,"&nbsp;</td>";
          ENDIF
.
          COMPARE   "6",REPORTNO
          IF        @EQUAL
            WRITE     HTMLFILE;"<td nowrap align=center>":
                               COLDAT04,"&nbsp;</td>";
          ELSE
            WRITE     HTMLFILE;"<td>",DISPSEX,"&nbsp;</td>":
                               "<td align=center>";
            CALL      WRTAGE00
            WRITE     HTMLFILE;"&nbsp;</td>";
          ENDIF
.
          IF        REPORTNO<5
            COMPARE   "2",REPORTNO
            IF        @EQUAL
              WRITE     HTMLFILE;"<td>&nbsp;",DDIAG,DDIAG2,"&nbsp;</td>";
            ELSE 
              WRITE     HTMLFILE;"<td>&nbsp;",ADIAG1,ADIAG2,"&nbsp;</td>";
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"</tr>"
.
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
          GOTO      TABCON99
.
TABCON20  CALL      JAVNAM00
          WRITE     HTMLFILE;"<tr><td nowrap height=30>":
                             "<a href=#"#" ":
                             "OnClick=#"updateParent('",JAVFNAME:
                             "','",ADMISSNO,"')#">":
                             "<img src=../images/patweb97-1.gif border=0 ":
                             "hspace=4 align=absmiddle></a>":
                             FORMATNM,"(",URNUMBER,")</td>":
                             "<td>",AWARD,"/",ABED,"&nbsp;</td>":
                             "<td nowrap>":
                             CDAY," ",MTHNAM3," ",CCENT,CYEAR,"&nbsp;</td>":
                             "<td>",DISPSEX,"&nbsp;</td>":
                             "<td align=center>"
            CALL      WRTAGE00
            WRITE     HTMLFILE;"&nbsp;</td>":
                             "<td>",ADIAG1,ADIAG2,"&nbsp;</td>":
                             "</tr>"
          GOTO      TABCON99
.
TABCON99  RETURN
.------------------------------------------------------------
. Admission Date
.------------------------------------------------------------
ADMDAT00  UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
ADMDAT99  RETURN
.------------------------------------------------------------
. Discharge Date
.------------------------------------------------------------
DISDAT00  UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
DISDAT99  RETURN
.------------------------------------------------------------
. Booking Date
.------------------------------------------------------------
BOKDAT00  UNPACK    BKREEDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
BOKDAT99  RETURN
.------------------------------------------------------------
. Discharge Time
.------------------------------------------------------------
DISTIM00  UNPACK    DTIME,DIM2,DIM1,DIM2A
          MOVE      DIM2,F2
          IF        F2>=12
            MOVE      "pm",DIM2B
            IF        F2>=13
              ASSIGN    F2-12,F2
              MOVE      F2,DIM2
            ENDIF
          ELSE
            MOVE      "am",DIM2B 
            MOVE      F2,DIM2
          ENDIF
.
DISTIM99  RETURN
.
.------------------------------------------------------------
. Table Contents 
.------------------------------------------------------------
ADMROW00  CALL      GETPAT00  
.
          MOVE      SP70,UNITDESC
          MATCH     SP70,ACLSSFT
          IF        !@EQUAL
            PACK      KEY5,ANSA,ANSC,ACLSSFT
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,UNITDESC
            ENDIF
          ENDIF
.
          COMPARE   ONE,LNK2PRT
          GOTO      ADMROW20 IF EQUAL
          COMPARE   TWO,LNK2PRT
          GOTO      ADMROW30 IF EQUAL
.
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
          WRITE     HTMLFILE;"<tr><td nowrap height=30>":
                             "<A HREF=",LINKPRG,".pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO,">":
                             "<img src=../images/patweb97-1.gif border=0 ":
                             "hspace=4 align=absmiddle></a>":
                             "  ",FORMATNM,"  (",URNO,")</td>":
                             "<td nowrap align=center>",COLDAT02,"&nbsp;</td>":
                             "<td nowrap align=center>",COLDAT03,"&nbsp;</td>": 
                             "<td>",DISPSEX,"&nbsp;</td>":
                             "<td align=center>";
            CALL      WRTAGE00
            WRITE     HTMLFILE;"&nbsp;</td>":
                             "<td>&nbsp;",ADIAG1,ADIAG2,"&nbsp;</td>":
                             "<td>",UNITDESC,"</td></tr>"
.
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
          GOTO      ADMROW99
.
ADMROW20  CALL      JAVNAM00
          WRITE     HTMLFILE;"<tr><td nowrap height=30>":
                             "<a href=#"#" ":
                             "OnClick=#"updateParent('",JAVFNAME:
                             "','",ADMISSNO,"')#">":
                             "<img src=../images/patweb97-1.gif border=0 ":
                             "hspace=4 align=absmiddle></a>":
                             FORMATNM,"(",URNUMBER,")</td>":
                             "<td>",AWARD,"/",ABED,"&nbsp;</td>":
                             "<td nowrap>":
                             CDAY," ",MTHNAM3," ",CCENT,CYEAR,"&nbsp;</td>":
                             "<td>",DISPSEX,"&nbsp;</td>":
                             "<td align=center>";
            CALL      WRTAGE00
            WRITE     HTMLFILE;"&nbsp;</td>":
                             "<td>",ADIAG1,ADIAG2,"&nbsp;</td>":
                             "<td>",UNITDESC,"</td></tr>"
          GOTO      ADMROW99
.
ADMROW30  REP       " +",ADMISSNO
          REP       " +",URNUMBER
          WRITE     HTMLFILE;"<tr><td nowrap height=30>":
                             "<A HREF=",LINKPRG,".pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO,">":
                             "<img src=../images/patweb97-1.gif border=0 ":
                             "hspace=4 align=absmiddle></a>":
                             "<A HREF=",RLINKPRG,".pbl":
                             "?reportno=",RLINKREP:
                             "&template=",RLINKTEM:
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO,">":
                             "<img src=../images/patweb97-2.gif border=0 ":
                             "hspace=4 align=absmiddle></a>":
                             "  ",FORMATNM,"  (",URNO,")</td>":
                             "<td nowrap align=center>",COLDAT02,"&nbsp;</td>":
                             "<td nowrap align=center>",COLDAT03,"&nbsp;</td>": 
                             "<td>",DISPSEX,"&nbsp;</td>":
                             "<td align=center>";
            CALL      WRTAGE00
            WRITE     HTMLFILE;"&nbsp;</td>":
                             "<td>&nbsp;",ADIAG1,ADIAG2,"&nbsp;</td>":
                             "<td>",UNITDESC,"</td></tr>"
.
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
          GOTO      ADMROW99
.
ADMROW99  RETURN
+
.------------------------------------------------------------
. Table of Current Admissions
.------------------------------------------------------------
TABADM00  PACK      KEY21,TWO,DOCTCODE,SP70
          MOVE      ZERO,RECNUMB
          CALL      RDSMISS5
TABADM10  CALL      RDKMISS5
          BRANCH    OVRCD,TABADM25
          COMPARE   "2",ASTAT
          GOTO      TABADM25 IF NOT EQUAL
          MATCH     ADOCTA,DOCTCODE
          GOTO      TABADM25 IF NOT EQUAL
.
          CALL      FHRCLR00
.
          MOVE      SP70,UNITDESC
          MATCH     SP70,UNITCODE
          IF        !@EQUAL
            MATCH     UNITCODE,ACLSSFT
            GOTO      TABADM10 IF NOT EQUAL
          ENDIF
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPTVIS1
          IF        OVRCD=1
            CALL      CLPATVIS
          ENDIF
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,TABADM15            * missing visit extension record
.
          IF        IBCNMHOS<>1
            GOTO      TABADM15
          ENDIF
.
          MATCH     SP70,WBSEHOSP
          GOTO      TABADM15 IF EQUAL
.
          MATCH     WBSEHOSP,PMVXMHOS
          GOTO      TABADM10 IF NOT EQUAL
.
TABADM15  PACK      KEY5,ANSA,ANSC,ACLSSFT
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,UNITDESC
          ENDIF
          MATCH     SP70,ACLSSFT
          IF        @EQUAL
            MOVE      SP70,UNITDESC
          ENDIF
.
          PACK      KEY5,ANSC,ANSL,ACLAIM
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,CLAIMCOD
          ENDIF
          MATCH     SP70,ACLAIM
          IF        @EQUAL
            MOVE      SP70,CLAIMCOD
          ENDIF
.
          PACK      KEY5,ANSA,SP1,ATYPE,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,ATYPDESC
          ENDIF
          MATCH     SP70,ATYPE 
          IF        @EQUAL
            MOVE      SP70,ATYPDESC
          ENDIF
.
          MOVE      AURNO,URNUMBER
          MOVE      AADMNO,ADMISSNO
          MOVE      AURNO,URNO
          MOVE      SP70,KEY10
          CALL      GETPAT00  
          REP       " 0",PTMXSIN1
.
          CALL      FWDBED00                    * format ward/bed text 
.
          CALL      PATFLD00                        * I CAR 45278
          CLEAR     PATLINK
          APPEND    "javascript:LinkTo('",PATLINK
          APPEND    URNUMBER,PATLINK
          APPEND    "','",PATLINK
          APPEND    ADMISSNO,PATLINK
          APPEND    "')",PATLINK
          RESET     PATLINK                         * end I CAR 45278
.
          CALL      GETCON00                    * Get Condition and Expected Discharge
.
          BRANCH    FHIRTYPE,TABADM20
          WRITE     HTMLFILE;"t.addRow(":
                             QUOTE,URNUMBER,QUOTE,COMMA:
                             QUOTE,ADMISSNO,QUOTE,COMMA:
                             QUOTE,PCEASE,PCASE:
                             PTMXSIN1,PTMXSIN2,PTMXSIN3,PTMXSIN4,PRIVFLAG:
                             QUOTE,COMMA:
                             QUOTE,FORMATNM,QUOTE,COMMA:
                             QUOTE,*+,WDBEDTXT,QUOTE,COMMA:
                             QUOTE,ADATE,ATIME,QUOTE,COMMA:
                             QUOTE,DISPSEX,QUOTE,COMMA:
                             QUOTE;
          CALL      WRTAGE00
          WRITE     HTMLFILE;QUOTE,COMMA:
                             QUOTE,ADIAG1,ADIAG2,QUOTE,COMMA:
                             QUOTE,UNITDESC,QUOTE,COMMA:
                             QUOTE,EXPDDATE,QUOTE,COMMA:
                             QUOTE,CLAIMCOD,QUOTE,COMMA:
                             QUOTE,PTMXSIN1,QUOTE,COMMA:
                             QUOTE,ATYPDESC,QUOTE,COMMA:
                             QUOTE,KEY3,QUOTE,COMMA:       * I CAR 45278
                             QUOTE,PATLINK,QUOTE,COMMA,QUOTE;   * I CAR 45278
.
          CALL      VCDM0000                * Visit based CDM
.
          WRITE     HTMLFILE;QUOTE,");"
          GOTO      TABADM10
.
TABADM20  MOVE      "arrived",ENSTATUS
          CALL      FHRENC00
          GOTO      TABADM10
.
TABADM25  MOVE      ZERO,STRLEAVE
          PACK      KEY21,FOUR,DOCTCODE,SP70
          CALL      RDSMISS5
TABADM30  CALL      RDKMISS5
          BRANCH    OVRCD,TABADM90
          MATCH     ADOCTA,DOCTCODE
          GOTO      TABADM90 IF NOT EQUAL
          CALL      FHRCLR00
          COMPARE   "4",ASTAT
          GOTO      TABADM90 IF NOT EQUAL
.
          MOVE      SP70,UNITDESC
          MATCH     SP70,UNITCODE
          IF        !@EQUAL
            MATCH     UNITCODE,ACLSSFT
            GOTO      TABADM30 IF NOT EQUAL
          ENDIF
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPTVIS1
          IF        OVRCD=1
            CALL      CLPATVIS
          ENDIF
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,TABADM35            * missing visit extension record
.
          IF        IBCNMHOS<>1
            GOTO      TABADM35
          ENDIF
.
          MATCH     SP70,WBSEHOSP
          GOTO      TABADM35 IF EQUAL
.
          MATCH     WBSEHOSP,PMVXMHOS
          GOTO      TABADM30 IF NOT EQUAL
.
TABADM35  PACK      KEY5,ANSA,ANSC,ACLSSFT
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,UNITDESC
          ENDIF
.
          PACK      KEY5,ANSA,SP1,ATYPE,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,ATYPDESC
          ENDIF
          MATCH     SP70,ATYPE
          IF        @EQUAL
            MOVE      SP70,ATYPDESC
          ENDIF
.
          MATCH     SP70,ACLSSFT
          IF        @EQUAL
            MOVE      SP70,UNITDESC
          ENDIF
.
.
          PACK      KEY5,ANSC,ANSL,ACLAIM
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,CLAIMCOD
          ENDIF
          MATCH     SP70,ACLAIM
          IF        @EQUAL
            MOVE      SP70,CLAIMCOD
          ENDIF
.
          MOVE      AURNO,URNUMBER
          MOVE      AADMNO,ADMISSNO
          MOVE      AURNO,URNO
          MOVE      "On Leave",COLDAT02
          CALL      GETPAT00  
          REP       " 0",PTMXSIN1
.
          CALL      PATFLD00                        * I CAR 45278
          CLEAR     PATLINK
          APPEND    "javascript:LinkTo('",PATLINK
          APPEND    URNUMBER,PATLINK
          APPEND    "','",PATLINK
          APPEND    ADMISSNO,PATLINK
          APPEND    "')",PATLINK
          RESET     PATLINK                         * end I CAR 45278
.
          CALL      GETCON00                    * Get Condition and Exp Discharge Date
.
          BRANCH    FHIRTYPE,TABADM40
          WRITE     HTMLFILE;"t.addRow(":
                             QUOTE,URNUMBER,QUOTE,COMMA:
                             QUOTE,ADMISSNO,QUOTE,COMMA:
                             QUOTE,PCEASE,PCASE:
                             PTMXSIN1,PTMXSIN2,PTMXSIN3,PTMXSIN4,PRIVFLAG:
                             QUOTE,COMMA:
                             QUOTE,FORMATNM,QUOTE,COMMA:
                             QUOTE,COLDAT02,QUOTE,COMMA:
                             QUOTE,ADATE,ATIME,QUOTE,COMMA:
                             QUOTE,DISPSEX,QUOTE,COMMA:
                             QUOTE;
          CALL      WRTAGE00
          WRITE     HTMLFILE;QUOTE,COMMA:
                             QUOTE,ADIAG1,ADIAG2,QUOTE,COMMA:
                             QUOTE,UNITDESC,QUOTE,COMMA:
                             QUOTE,EXPDDATE,QUOTE,COMMA:
                             QUOTE,CLAIMCOD,QUOTE,COMMA:
                             QUOTE,PTMXSIN1,QUOTE,COMMA:
                             QUOTE,ATYPDESC,QUOTE,COMMA:
                             QUOTE,KEY3,QUOTE,COMMA:       * I CAR 45278
                             QUOTE,PATLINK,QUOTE,COMMA,QUOTE;  * I CAR 45278
.
          CALL      VCDM0000                * Visit based CDM
.
          WRITE     HTMLFILE;QUOTE,");"
          GOTO      TABADM30
.
TABADM40  MOVE      "onleave",ENSTATUS
          CALL      FHRENC00
          GOTO      TABADM30
TABADM90  
TABADM99  RETURN
.
.-----------------------------------------------------------------------------
. Output Encounter FHIR JSON Response
.-----------------------------------------------------------------------------
FHRENC00  PACK      FHRENCID,URNUMBER,ADMISSNO,SP70
          PACK      FHRPATID,URNUMBER,SP70
          SQUEEZE   FHRPATID
          REP       " -",FHRENCID
.
          CLEAR     FHRWLOCC
          CLEAR     FHRBLOCC
          CLEAR     FHRLOCN
          CLEAR     FHRBLOCC
.
          MATCH     SP70,AWARD
          IF        @EQUAL
            MOVE      PTMIXWRD,AWARD
          ENDIF
.
          MATCH     SP70,AWARD
          IF        !@EQUAL
            APPEND    "Ward-",FHRWLOCC
            APPEND    AWARD,FHRWLOCC
          ENDIF
.
          MATCH     SP70,ABED
          IF        @EQUAL
            MOVE      PTMIEBED,ABED
          ENDIF
.
          MATCH     SP70,ABED
          IF        !@EQUAL
            APPEND    "Bed-",FHRBLOCC
            APPEND    AWARD,FHRBLOCC
            APPEND    ABED,FHRBLOCC
          ENDIF
.
          CALL      FWDNAM00                 * FHIR Ward Display Name
          CALL      FBDNAM00                 * FHIR Bed Display Name
.
          APPEND    SP70,FHRWLOCC
          APPEND    SP70,FHRBLOCC
          RESET     FHRWLOCC
          RESET     FHRBLOCC
          STRIP     FHRWLOCC
          STRIP     FHRBLOCC
          REP       " -",FHRWLOCC
          REP       " -",FHRBLOCC
          MOVE      FRWRDTXT,FHRLOCN
          MOVE      FRBEDTXT,FHRBLOCN
.
          MOVE      ENSTATUS,FHRSTAT     *  Encounter Status
          MOVE      "inpatient",FHRCLAS  *  Encounter Class
          MOVE      FORMATNM,FHRPATN  *  Patient Display Name
.
          CALL      GFRSDT00             * Get Period Start Date
          CALL      GFREDT00             * Get Period End Date
          CALL      GFRDOC00             * Get Doctors
.
          STRIP     ADIAG1
          STRIP     ADIAG2
          CLEAR     FHRREAS  
          APPEND    ADIAG1,FHRREAS 
          APPEND    SP1,FHRREAS 
          APPEND    ADIAG2,FHRREAS 
          RESET     FHRREAS
.
          MOVE      SP70,FHRUNITC
          MOVE      SP70,FHRUNITD
          MATCH     SP3,ACLSSFT
          IF        !@EQUAL
            MOVE      "AC",KEY2
            PACK      KEY5,KEY2,ACLSSFT
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      KEY5,FHRUNITC
              MOVE      TDESC,FHRUNITD
            ENDIF
          ENDIF
          STRIP     FHRUNITC
          STRIP     FHRUNITD
.
          MOVE      "false",FHRVISA
          MATCH     "1",PMVXVALW
          IF        @EQUAL
            MOVE      "true",FHRVISA
          ENDIF
.
          MOVE      "false",FHRPHNA
          MATCH     "1",PMVXPALW
          IF        @EQUAL
            MOVE      "true",FHRPHNA
          ENDIF
.
          IF        RECNUMB>0
            WRITE     HTMLFILE;",";
          ENDIF
          ADD       ONE,RECNUMB
          WRITE     HTMLFILE;*+,"{ #"fullUrl#" : #"%BASEURL/Encounter/",FHRENCID,"#", ":
                    " #"resource#" : ";
          CALL     RESENC00            * FHIR Resource Encounter
          WRITE    HTMLFILE;*+,"}" 
.
          IF       FHRSUBIN=1
            WRITE     HTMLFILE;*+,",{ #"fullUrl#" : #"%BASEURL/Patient/",FHRPATID,"#", ":
                      " #"resource#" : ";
            CALL     RESPAT00            * FHIR Resource Patient
            WRITE    HTMLFILE;*+,"}" 
          ENDIF
.
          IF       FHRPARIN=1
.
            CALL      FHRDO100
.
            MATCH     SP70,FHRDOCC1
            IF        !@EQUAL
.
              WRITE     HTMLFILE;*+,",{ #"fullUrl#" : #"%BASEURL/Practitioner/",FHRDOCC1,"#", ":
                        " #"resource#" : ";
              CALL     RESPRA00         * FHIR Resource Practitioner
              WRITE    HTMLFILE;*+,"}"
.
            ENDIF
.
            CALL      FHRDO200
.
            MATCH     SP70,FHRDOCC2
            IF        !@EQUAL
.
              WRITE     HTMLFILE;*+,",{ #"fullUrl#" : #"%BASEURL/Practitioner/",FHRDOCC2,"#", ":
                        " #"resource#" : ";
              CALL     RESPRA00         * FHIR Resource Practitioner
              WRITE    HTMLFILE;*+,"}"
.
            ENDIF
.
          ENDIF
.
          IF       FHRLOCIN=1
.
            PACK      KEY6,AWARD,ABED,SP70
            CALL      RDWARD1
            IF        OVRCD=0
.
              MATCH     SP70,AWARD
              IF        !@EQUAL
.
                MATCH     SP70,PTMIEBED
                IF        !@EQUAL
                  MOVE      PTMIEBED,ABED
                ENDIF
.
                MATCH     SP70,ABED
                IF        !@EQUAL
.
                  WRITE     HTMLFILE;*+,",{ #"fullUrl#" : #"%BASEURL/Location/",FHRBLOCC,"#", ":
                            " #"resource#" : ";
                  CALL     RESBED00         * FHIR Resource Location Bed
                  WRITE    HTMLFILE;*+,"}"
.
                ELSE
.
                  WRITE     HTMLFILE;*+,",{ #"fullUrl#" : #"%BASEURL/Location/",FHRWLOCC,"#", ":
                            " #"resource#" : ";
                  CALL     RESWRD00         * FHIR Resource Location Ward
                  WRITE    HTMLFILE;*+,"}"
.
                ENDIF
.
              ENDIF
.
            ENDIF
.
          ENDIF
.
          RETURN
+
.--------------------------------------------------------------------------------
. Add Diagnosis Coding to Encounter 
. Not provided for the Encounters Resource Search by Practitioner for performance
.--------------------------------------------------------------------------------
RESDIA00  
RESDIA99  RETURN
.--------------------------------------------------------------------------------
. FHIR Encounter Resource Extra Type Related Data
.--------------------------------------------------------------------------------
RESEXT00
RESEXT99  RETURN
.--------------------------------------------
. Add Contacts to FHIR Patient Resource
.--------------------------------------------
FHRCON00  MOVE      ZERO,F3
          PACK      KEY14,URNUMBER,SP20
          CALL      RSPMCEX1
FHRCON10  CALL      RKPMCEX1
          BRANCH    OVRCD,FHRCON99
          MATCH     URNUMBER,PMCEURNO
          GOTO      FHRCON99 IF NOT EQUAL
          MATCH     "0",PMCEACTV
          GOTO      FHRCON10 IF NOT EQUAL
.
          PACK      KEY5,CATTC,PMCETYPE
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      PMCETYPE,TDESC
          ENDIF
.
          PACK      KEY4,PMCETITL
          CALL      RDPMTLE1
          IF        OVRCD=1
            MOVE      PMCETITL,PMTLDESC
          ENDIF
.
          PACK      KEY10,PMCERELP,SP70
          CALL      RDPMREL1
          IF        OVRCD=1
            MOVE      PMCERELP,PMRLDESC
          ENDIF
.
          IF        F3>0
            WRITE     HTMLFILE;*+,",";
          ELSE
            ADD       ONE,F3
            WRITE     HTMLFILE;*+,",#"contact#" : [ ";
          ENDIF
          WRITE     HTMLFILE;*+,"{#"relationship#": [ {":
                                "  #"coding#":  [ {":
                                "   #"code#": #"",PMCERELP,"#",":
                                "   #"display#": #"",PMRLDESC,"#" } ] } ],":
                                " #"name#" : {":
                                "  #"use#" : #"usual#",":
                                "  #"family#": #"",PMCESNAM,"#",":
                                "  #"given#" : [#"",PMCEGNAM,"#"";
          MATCH     SP70,PMCEGNM2
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",#"",PMCEGNM2,"#"";
          ENDIF
          WRITE     HTMLFILE;*+,"],":
                      "      #"prefix#" : [#"",PMTLDESC,"#"]":
                      "     }, ";
.
          WRITE     HTMLFILE;*+," #"address#": [ {":
                                " #"use#": #"home#",":
                                " #"line#": [#"",PMCEADD1,"#"";
          MATCH     SP70,PMCEADD2
          IF        !@EQUAL
            STRIP     PMCEADD2
            WRITE     HTMLFILE;*+,",#"",PMCEADD2,"#"";
          ENDIF
          WRITE     HTMLFILE;*+,"],":
                                " #"city#": #"",PMCEADD3,"#",":
                                " #"state#": #"",PMCEADD4,"#",":
                                " #"postalCode#": #"",PMCEPOST,"#"":
                                " } ],":
                                "#"telecom#": [ ":
                                "{#"system#": #"email#",":
                                " #"value#": #"",PMCEEMAI,"#"},":
                                "{#"system#": #"phone#",":
                                " #"use#": #"home#",":
                                " #"value#": #"",PMCETELP,"#"},":
                                "{#"system#": #"phone#",":
                                " #"use#": #"work#",":
                                " #"value#": #"",PMCETELB,"#"},":
                                "{#"system#": #"phone#",":
                                " #"use#": #"mobile#",":
                                " #"value#": #"",PMCETELM,"#"} ] }";
          GOTO      FHRCON10

FHRCON99  IF        F3>0
            WRITE     HTMLFILE;*+,"  ]";
          ENDIF
          MATCH     PMPXRHC1,SP70
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",#"generalPractitioner#": [ { #"reference#": #"Practitioner/HCP-",PMPXRHC1,"#" }";
            MATCH     PMPXVGPC,SP70
            IF        !@EQUAL
              WRITE     HTMLFILE;*+,", { #"reference#": #"Practitioner/HCP-",PMPXVGPC,"#" }";
            ENDIF
            WRITE     HTMLFILE;*+," ]";
          ENDIF
          WRITE     HTMLFILE;*+,",#"telecom#": [ ";
          WRITE     HTMLFILE;*+,"{#"system#": #"phone#",":
                                " #"use#": #"home#",":
                                " #"value#": #"",PTELEP,"#"}";
          MATCH     SP70,PMPXPEML
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",{#"system#": #"email#",":
                                  " #"value#": #"",PMPXPEML,"#"}";
          ENDIF
          MATCH     SP70,PTELEB
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",{#"system#": #"phone#",":
                                  " #"use#": #"work#",":
                                  " #"value#": #"",PTELEB,"#"}";
          ENDIF
          MATCH     SP70,PTMXCELL
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",{#"system#": #"phone#",":
                                  " #"use#": #"mobile#",":
                                  " #"value#": #"",PTMXCELL,"#"} ";
          ENDIF
          WRITE     HTMLFILE;*+,"]";
          RETURN
+
.------------------------------------------------------------
. Get Period Start Date for FHIR Response.
.------------------------------------------------------------
GFRSDT00  MOVE      SP70,FHRSTRDT
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MATCH     SP70,ATIME
          IF        @EQUAL
            PACK      FHRSTRDT,CCENT,CYEAR,FHRDASH,CMON,FHRDASH,CDAY
          ELSE
            UNPACK    ATIME,CHOUR,D1,CMIN,D1,KEY2
            REP       " 0",CHOUR
            REP       " 0",CMIN
            REP       " 0",KEY2
            PACK      ATIME,CHOUR,COLON,CMIN,COLON,KEY2
            PACK      FHRSTRDT,CCENT,CYEAR,FHRDASH,CMON,FHRDASH,CDAY,ANST,ATIME,TIMEZONE,SP70
          ENDIF
          RETURN
+
.------------------------------------------------------------
. Get Period End Date for FHIR Response.
.------------------------------------------------------------
GFREDT00  MOVE      SP70,FHRENDDT
          MATCH     SP70,PMWOEDAT
          IF        !@EQUAL
            UNPACK    PMWOEDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      EXPCTDSC,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP1,PMWOEDTM
            MATCH     SP70,PMWOEDTM
            IF        @EQUAL
              PACK      FHRENDDT,CCENT,CYEAR,FHRDASH,CMON,FHRDASH,CDAY
            ELSE
              PACK      FHRENDDT,CCENT,CYEAR,FHRDASH,CMON,FHRDASH,CDAY,ANST,PMWOEDTM,TIMEZONE,SP70
            ENDIF
            GOTO      GFREDT99
          ENDIF
.
          MOVE      CCC,CCENT
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      ASTAY,ADJDAYS
          CALL      ADJDAT00
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      EXPCTDSC,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          PACK      FHRENDDT,CCENT,CYEAR,FHRDASH,CMON,FHRDASH,CDAY
.
GFREDT99  RETURN
+
.------------------------------------------------------------
. Get Doctors for FHIR Response.
.------------------------------------------------------------
GFRDOC00  MOVE      SP70,FHRDOCC1
          MOVE      SP70,FHRDOCT1
          MOVE      SP70,FHRDOCN1
.
          MOVE      SP70,FHRDOCC2
          MOVE      SP70,FHRDOCT2
          MOVE      SP70,FHRDOCN2
.
          PACK      KEY10,ADOCTA,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,GFRDOC99
.
          CLEAR     FHRDOCC1
          APPEND    "HCP-",FHRDOCC1
          APPEND    ADOCTA,FHRDOCC1
          RESET     FHRDOCC1
          MOVE      "ADM",FHRDOCT1 *  Doctor Type
          SQUEEZE   PMHCTITL
          SQUEEZE   PMHCSNAM
          MOVE      PMHCGNAM,DIM1
          PACK      FHRDOCN1,PMHCTITL,SP1,DIM1,DOT,SP1,PMHCSNAM,SP70
.
          MATCH     SP70,PMVXEDC1
          GOTO      GFRDOC99 IF EQUAL
.
          CLEAR     FHRDOCC2
          APPEND    "HCP-",FHRDOCC2
          APPEND    PMVXEDC1,FHRDOCC2
          RESET     FHRDOCC2
          MOVE      "CON",FHRDOCT2
.
          PACK      KEY10,PMVXEDC1
          CALL      RDPMHCP1
          BRANCH    OVRCD,GFRDOC99
.
          SQUEEZE   PMHCTITL
          SQUEEZE   PMHCSNAM
          MOVE      PMHCGNAM,DIM1
          PACK      FHRDOCN2,PMHCTITL,SP1,DIM1,DOT,SP1,PMHCSNAM,SP70
.
GFRDOC99  RETURN
+
.------------------------------------------------------------
. Table of Current Admissions by GP
.------------------------------------------------------------
TABGPA00  MATCH     SP70,WBSEGPCD
          GOTO      TABGPA99 IF EQUAL
.
          PACK      KEY21,TWO,SP70
          CALL      RDSMISS5
TABGPA10  CALL      RDKMISS5
          BRANCH    OVRCD,TABGPA20
          COMPARE   "2",ASTAT
          GOTO      TABGPA20 IF NOT EQUAL
.
          PACK      KEY8,AURNO,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,TABGPA10
.
          CALL      CHGP0000
          BRANCH    EXIT,TABGPA10
.
          MOVE      SP70,UNITDESC
          MATCH     SP70,UNITCODE
          IF        !@EQUAL
            MATCH     UNITCODE,ACLSSFT
            GOTO      TABGPA10 IF NOT EQUAL
          ENDIF
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,TABGPA15            * missing visit extension record
.
          MATCH     "1",PMVXINGP
          IF        !@EQUAL
            GOTO      TABGPA10               * only display if informgp=yes
          ENDIF
.
          IF        IBCNMHOS<>1
            GOTO      TABGPA15
          ENDIF
.
          MATCH     SP70,WBSEHOSP
          GOTO      TABGPA15 IF EQUAL
.
.....     MATCH     WBSEHOSP,PMVXMHOS
.....     GOTO      TABGPA10 IF NOT EQUAL
.
TABGPA15  PACK      KEY5,ANSA,ANSC,ACLSSFT
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,UNITDESC
          ENDIF
          MATCH     SP70,ACLSSFT
          IF        @EQUAL
            MOVE      SP70,UNITDESC
          ENDIF
.
          PACK      KEY5,ANSC,ANSL,ACLAIM
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,CLAIMCOD
          ENDIF
          MATCH     SP70,ACLAIM
          IF        @EQUAL
            MOVE      SP70,CLAIMCOD
          ENDIF
.
          PACK      KEY5,ANSA,SP1,ATYPE,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,ATYPDESC
          ENDIF
          MATCH     SP70,ATYPE
          IF        @EQUAL
            MOVE      SP70,ATYPDESC
          ENDIF
.
          MOVE      AURNO,URNUMBER
          MOVE      AADMNO,ADMISSNO
          MOVE      AURNO,URNO
          MOVE      SP70,KEY10
          CALL      GETPAT00
          REP       " 0",PTMXSIN1
          CALL      FWDBED00                       * format ward/bed text 
.
          IF        WBEDDESC=1
            PACK      KEY6,AWARD,ABED
            CALL      RDWARD1
            IF        OVRCD<>1
              PACK      COLDAT02,AWARD,SLASH,WBDESC,KEY10
            ENDIF
          ENDIF
.
          CALL      PATFLD00                        * I CAR 45278
          CLEAR     PATLINK
          APPEND    "javascript:LinkTo('",PATLINK
          APPEND    URNUMBER,PATLINK
          APPEND    "','",PATLINK
          APPEND    ADMISSNO,PATLINK
          APPEND    "')",PATLINK
          RESET     PATLINK                         * end I CAR 45278
.
          CALL      GETCON00                    * Get Condition and Exp Discharge Date
.
          WRITE     HTMLFILE;"t.addRow(":
                             QUOTE,URNUMBER,QUOTE,COMMA:
                             QUOTE,ADMISSNO,QUOTE,COMMA:
                             QUOTE,PCEASE,PCASE:
                             PTMXSIN1,PTMXSIN2,PTMXSIN3,PTMXSIN4,PRIVFLAG:
                             QUOTE,COMMA:
                             QUOTE,FORMATNM,QUOTE,COMMA:
                             QUOTE,WDBEDTXT,QUOTE,COMMA:
                             QUOTE,ADATE,ATIME,QUOTE,COMMA:
                             QUOTE,DISPSEX,QUOTE,COMMA:
                             QUOTE;
          CALL      WRTAGE00
          WRITE     HTMLFILE;QUOTE,COMMA:
                             QUOTE,ADIAG1,ADIAG2,QUOTE,COMMA:
                             QUOTE,UNITDESC,QUOTE,COMMA:
                             QUOTE,EXPDDATE,QUOTE,COMMA:
                             QUOTE,CLAIMCOD,QUOTE,COMMA:
                             QUOTE,PTMXSIN1,QUOTE,COMMA:
                             QUOTE,ATYPDESC,QUOTE,COMMA:
                             QUOTE,KEY3,QUOTE,COMMA:       * I CAR 45278
                             QUOTE,PATLINK,QUOTE:          * I CAR 45278
                             ");"
          GOTO      TABGPA10
.
TABGPA20  MOVE      ZERO,STRLEAVE
          PACK      KEY21,FOUR,SP70
          CALL      RDSMISS5
TABGPA30  CALL      RDKMISS5
          BRANCH    OVRCD,TABGPA90
.
          COMPARE   "4",ASTAT
          GOTO      TABGPA90 IF NOT EQUAL
.
          PACK      KEY8,AURNO,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,TABGPA30
.
          CALL      CHGP0000
          BRANCH    EXIT,TABGPA30
.
          MOVE      SP70,UNITDESC
          MATCH     SP70,UNITCODE
          IF        !@EQUAL
            MATCH     UNITCODE,ACLSSFT
            GOTO      TABGPA30 IF NOT EQUAL
          ENDIF
          PACK      KEY5,ANSA,ANSC,ACLSSFT
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,UNITDESC
          ENDIF
.
          PACK      KEY5,ANSA,SP1,ATYPE,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,ATYPDESC
          ENDIF
          MATCH     SP70,ATYPE
          IF        @EQUAL
            MOVE      SP70,ATYPDESC
          ENDIF
.
          MATCH     SP70,ACLSSFT
          IF        @EQUAL
            MOVE      SP70,UNITDESC
          ENDIF
.
.
          PACK      KEY5,ANSC,ANSL,ACLAIM
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,CLAIMCOD
          ENDIF
          MATCH     SP70,ACLAIM
          IF        @EQUAL
            MOVE      SP70,CLAIMCOD
          ENDIF
.
          MOVE      AURNO,URNUMBER
          MOVE      AADMNO,ADMISSNO
          MOVE      AURNO,URNO
          MOVE      "On Leave",COLDAT02
          CALL      GETPAT00
          REP       " 0",PTMXSIN1
.
          CALL      PATFLD00                        * I CAR 45278
          CLEAR     PATLINK
          APPEND    "javascript:LinkTo('",PATLINK
          APPEND    URNUMBER,PATLINK
          APPEND    "','",PATLINK
          APPEND    ADMISSNO,PATLINK
          APPEND    "')",PATLINK
          RESET     PATLINK                         * end I CAR 45278
.
          CALL      GETCON00                    * Get Condition and Exp Discharge Date
.
          WRITE     HTMLFILE;"t.addRow(":
                             QUOTE,URNUMBER,QUOTE,COMMA:
                             QUOTE,ADMISSNO,QUOTE,COMMA:
                             QUOTE,PCEASE,PCASE:
                             PTMXSIN1,PTMXSIN2,PTMXSIN3,PTMXSIN4,PRIVFLAG:
                             QUOTE,COMMA:
                             QUOTE,FORMATNM,QUOTE,COMMA:
                             QUOTE,COLDAT02,QUOTE,COMMA:
                             QUOTE,ADATE,ATIME,QUOTE,COMMA:
                             QUOTE,DISPSEX,QUOTE,COMMA:
                             QUOTE;
          CALL      WRTAGE00
          WRITE     HTMLFILE;QUOTE,COMMA:
                             QUOTE,ADIAG1,ADIAG2,QUOTE,COMMA:
                             QUOTE,UNITDESC,QUOTE,COMMA:
                             QUOTE,EXPDDATE,QUOTE,COMMA:
                             QUOTE,CLAIMCOD,QUOTE,COMMA:
                             QUOTE,PTMXSIN1,QUOTE,COMMA:
                             QUOTE,ATYPDESC,QUOTE,COMMA:
                             QUOTE,KEY3,QUOTE,COMMA:       * I CAR 45278
                             QUOTE,PATLINK,QUOTE:          * I CAR 45278
                             ");"
          GOTO      TABGPA30
TABGPA90
TABGPA99  RETURN
.
.------------------------------------------------------------------------
.  Check for GP Access on websecaf
.------------------------------------------------------------------------
CHGP0000 MOVE       ZERO,EXIT
         MOVE       SP70,GPCODE
.
         MATCH      WBSEGPAC,SP70           * all access
         IF         @EQUAL
           PACK       GPCODE,PMPXRHC1,SP70
         ENDIF
.
         MATCH      "1",WBSEGPAC           * using registered gp
         IF         @EQUAL
           PACK       GPCODE,PMPXRHC1,SP70
         ENDIF
.
         MATCH      "2",WBSEGPAC           * using verified gp
         IF         @EQUAL
           PACK       GPCODE,PMPXVGPC,SP70
         ENDIF
.
         MATCH      GPCODE,WBSEGPCD
         GOTO       CHGP9999 IF EQUAL
.
         MATCH      WBSEGPAC,SP70           * all access
         IF         @EQUAL
           PACK       GPCODE,PMPXVGPC,SP70
         ENDIF
.
         MATCH      GPCODE,WBSEGPCD
         GOTO       CHGP9999 IF EQUAL
.
CHGP9000 MOVE       ONE,EXIT
.
CHGP9999 RETURN
+
.------------------------------------------------------------------------------
.         Output Shared Care visit rows for matching visit & doctor (DOCTCODE).
.         Only show records where PMDTSDAT (start date) is less than the 
.         current date and PMDTEDAT (end date) is blank.
.         Also only show if the Shared Care doctor is NOT Attending or 
.         Secondary (unless Shared Care Unit is different to Secondary Unit).
.------------------------------------------------------------------------------
ROWSCD00  CALL      IBACLOCK
          PACK      DIM8,CCC,CYY,CMM,CDD
          REP       " 0",DIM8
.
          PACK      KEY24,AADMNO,SP70
          CALL      RSPMDTC1
ROWSCD10  CALL      RKPMDTC1
          BRANCH    OVRCD,ROWSCD99
.
          MATCH     DAADMNO,PMDTVISN
          GOTO      ROWSCD99 IF NOT EQUAL
.
          MATCH     DOCTCODE,PMDTDOCT
          GOTO      ROWSCD10 IF NOT EQUAL
.
          MATCH     DIM8,PMDTSDAT
          GOTO      ROWSCD11 IF EQUAL
          GOTO      ROWSCD10 IF NOT LESS
.
ROWSCD11  MATCH     SP70,PMDTEDAT
          GOTO      ROWSCD10 IF NOT EQUAL
.
          COMPARE   "2",ASTAT
          GOTO      ROWSCD20 IF EQUAL
.
          COMPARE   "4",ASTAT
          GOTO      ROWSCD20 IF EQUAL
.
          GOTO      ROWSCD10
.
ROWSCD20  MATCH     SP70,ADOCTA
          GOTO      ROWSCD30 IF EQUAL
.
          MATCH     ADOCTA,PMDTDOCT
          GOTO      ROWSCD10 IF EQUAL       * Attending Doc already displayed
.
          MATCH     SP70,PMVXEDC1
          GOTO      ROWSCD30 IF EQUAL
.
          MATCH     PMVXEDC1,PMDTDOCT       * Same as Secondary Doctor?
          IF        @EQUAL
            MATCH     PMVXEDU1,PMDTUNIT     * Same Secondary Unit?
            GOTO      ROWSCD10 IF EQUAL
          ENDIF
.
ROWSCD30  CALL      TROWSC00                * Output Shared Care patient row
          GOTO      ROWSCD10
.
ROWSCD99  RETURN
+
.------------------------------------------------------------------------
.         Output Shared Care (pmsdtcaf) row for the visit
.------------------------------------------------------------------------
TROWSC00  PACK      ATNSECDC,SP70
          PACK      DTITL,SP70
          PACK      DSNAME,SP70
          PACK      PMHCTITL,SP70
          PACK      PMHCSNAM,SP70
          MOVE      ZERO,STRLEAVE
.
          PACK      KEY6,ADOCTA,SP70
          CALL      RDDOCT1
          BRANCH    OVRCD,TROWSC10
.
          STRIP     DTITL
          STRIP     DSNAME
          MOVE      DGNAME,DIM1
.
          APPEND    DTITL,ATNSECDC
          APPEND    SP1,ATNSECDC
          APPEND    DIM1,ATNSECDC
          APPEND    SP1,ATNSECDC
          APPEND    DSNAME,ATNSECDC
.
TROWSC10  PACK      KEY10,PMVXEDC1
          CALL      RDPMHCP1
          BRANCH    OVRCD,TROWSC14
.
          STRIP     PMHCTITL
          STRIP     PMHCSNAM
          MOVE      PMHCGNAM,DIM1
.
          APPEND    SP1,ATNSECDC
          APPEND    SLASH,ATNSECDC
          APPEND    SP1,ATNSECDC
          APPEND    PMHCTITL,ATNSECDC
          APPEND    SP1,ATNSECDC
          APPEND    DIM1,ATNSECDC
          APPEND    SP1,ATNSECDC
          APPEND    PMHCSNAM,ATNSECDC
.
TROWSC14  RESET     ATNSECDC 
.
          MOVE      SP70,UNITDESC
          MATCH     SP70,UNITCODE
          IF        !@EQUAL
            MATCH     UNITCODE,PMDTUNIT
            GOTO      TROWSC99 IF NOT EQUAL
          ENDIF
.
          IF        IBCNMHOS<>1
            GOTO      TROWSC15
          ENDIF
.
          MATCH     SP70,WBSEHOSP
          GOTO      TROWSC15 IF EQUAL
.
          MATCH     WBSEHOSP,PMVXMHOS
          GOTO      TROWSC99 IF NOT EQUAL
.
TROWSC15  PACK      KEY5,ANSA,ANSC,PMDTUNIT
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,UNITDESC
          ENDIF
          MATCH     SP70,PMDTUNIT
          IF        @EQUAL
            MOVE      SP70,UNITDESC
          ENDIF
          PACK      UNTDESC2,UNITDESC,SP70
.
          PACK      KEY5,ANSC,ANSL,ACLAIM
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,CLAIMCOD
          ENDIF
          MATCH     SP70,ACLAIM
          IF        @EQUAL
            MOVE      SP70,CLAIMCOD
          ENDIF
.
          PACK      KEY5,ANSA,SP1,ATYPE,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,ATYPDESC
          ENDIF
          MATCH     SP70,ATYPE
          IF        @EQUAL
            MOVE      SP70,ATYPDESC
          ENDIF
.
          MOVE      AURNO,URNUMBER
          MOVE      AADMNO,ADMISSNO
          MOVE      AURNO,URNO
.
          COMPARE   "2",ASTAT
          IF        @EQUAL
            MOVE      SP70,KEY10
            CALL      FWDBED00              * format ward/bed
            MOVE      WDBEDTXT,COLDAT02
          ENDIF
.
          COMPARE   "4",ASTAT
          IF        @EQUAL
            MOVE      "On Leave",COLDAT02
          ENDIF
.
          CALL      GETPAT00
          REP       " 0",PTMXSIN1
.
          CALL      PATFLD00
          CLEAR     PATLINK
          APPEND    "javascript:LinkTo('",PATLINK
          APPEND    URNUMBER,PATLINK
          APPEND    "','",PATLINK
          APPEND    ADMISSNO,PATLINK
          APPEND    "')",PATLINK
          RESET     PATLINK
.
          CALL      GETCON00   * Get Condition and Expected Discharge Date
.
          MOVE      AFUNDH,HFUND 
          BRANCH    FHIRTYPE,TROWSC90 
          WRITE     HTMLFILE;"t.addRow(":
                             QUOTE,URNUMBER,QUOTE,COMMA:
                             QUOTE,ADMISSNO,QUOTE,COMMA:
                             QUOTE,PCEASE,PCASE:
                             PTMXSIN1,PTMXSIN2,PTMXSIN3,PTMXSIN4,PRIVFLAG:
                             QUOTE,COMMA:
                             QUOTE,FORMATNM,QUOTE,COMMA:
                             QUOTE,*+,COLDAT02,QUOTE,COMMA:
                             QUOTE,ADATE,ATIME,QUOTE,COMMA:
                             QUOTE,DISPSEX,QUOTE,COMMA:
                             QUOTE;

          CALL      WRTAGE00
          WRITE     HTMLFILE;QUOTE,COMMA:
                             QUOTE,ADIAG1,ADIAG2,QUOTE,COMMA:
                             QUOTE,UNTDESC2,QUOTE,COMMA:
                             QUOTE,EXPDDATE,QUOTE,COMMA:
                             QUOTE,CLAIMCOD,QUOTE,COMMA:
                             QUOTE,PTMXSIN1,QUOTE,COMMA:
                             QUOTE,ATYPDESC,QUOTE,COMMA:
                             QUOTE,KEY3,QUOTE,COMMA:
                             QUOTE,PATLINK,QUOTE,COMMA:
                             QUOTE,HFUND,QUOTE,COMMA:
                             QUOTE,ATNSECDC,QUOTE:
                             ");"
          GOTO      TROWSC99
.
TROWSC90  MOVE      "arrived",ENSTATUS
          COMPARE   "4",ASTAT
          IF        @EQUAL
            MOVE      "onleave",ENSTATUS
          ENDIF
          CALL      FHRENC00
+
TROWSC99  RETURN
+ 
.------------------------------------------------------------
. Table of Current Admissions for Shared Care
.------------------------------------------------------------
TABSHR00  PACK      ATNSECDC,SP70
          MOVE      ZERO,RECNUMB
.
. Pre-admission and admission status
.
          IF        FHIRTYPE=1
            PACK      KEY9,ONE,SP70
          ELSE
            PACK      KEY9,TWO,SP70
          ENDIF
.
          CALL      RDSMISS2
TABSHR10  CALL      RDKMISS2
          BRANCH    OVRCD,TABSHR20
.
          IF        FHIRTYPE=1
            GOTO      TABSHR11
          ENDIF
.
          COMPARE   "2",ASTAT
          GOTO      TABSHR20 IF NOT EQUAL
.
          GOTO      TABSHR13
.
. FHIR
.
TABSHR11  COMPARE   ZERO,PTSTATUS          * fhir - Is there a status filter
          IF        !@EQUAL
            COMPARE   PTSTATUS,ASTAT       * fhir - Is the status selected
            IF        !@EQUAL
              GOTO      TABSHR10
            ENDIF
          ENDIF
.
          COMPARE   "1",ASTAT
          GOTO      TABSHR12 IF EQUAL
.
          COMPARE   "2",ASTAT
          GOTO      TABSHR20 IF NOT EQUAL
.
TABSHR12  MATCH     SP70,FRSTDATE        * check frstdate available
          GOTO      TABSHR13 IF EQUAL
          GOTO      TABSHR13 IF EOS
          MATCH     FRSTDATE,ADATE
          GOTO      TABSHR10 IF LESS
          MATCH     ADATE,LASTDATE
          GOTO      TABSHR10 IF LESS
.
TABSHR13  PACK      KEY8,AADMNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,TABSHR10
.
          IF        SHOWADDT=1
            CALL      ROWSCD00         * Output Shared Care for visit/doctor
          ENDIF
.
          MATCH     ADOCTA,DOCTCODE         * is Attending doctor?
          IF        !@EQUAL
            MATCH     DOCTCODE,PMVXEDC1     * is Secondary doctor?
            GOTO      TABSHR10 IF NOT EQUAL
.
            IF        SHOWADDT=1
              CALL      SDEN0000              * has secondary doctor ended
              BRANCH    EXIT,TABSHR10
            ENDIF
          ENDIF
.
          PACK      KEY6,ADOCTA,SP70
          CALL      RDDOCT1
          BRANCH    OVRCD,TABSHR14
.
          STRIP     DTITL
          STRIP     DSNAME
          MOVE      DGNAME,DIM1
.
          APPEND    DTITL,ATNSECDC
          APPEND    SP1,ATNSECDC
          APPEND    DIM1,ATNSECDC
          APPEND    SP1,ATNSECDC
          APPEND    DSNAME,ATNSECDC
.
          PACK      KEY10,PMVXEDC1
          CALL      RDPMHCP1
          BRANCH    OVRCD,TABSHR14
.
          STRIP     PMHCTITL
          STRIP     PMHCSNAM
          MOVE      PMHCGNAM,DIM1
.
          APPEND    SP1,ATNSECDC
          APPEND    SLASH,ATNSECDC
          APPEND    SP1,ATNSECDC
          APPEND    PMHCTITL,ATNSECDC
          APPEND    SP1,ATNSECDC
          APPEND    DIM1,ATNSECDC
          APPEND    SP1,ATNSECDC
          APPEND    PMHCSNAM,ATNSECDC
.
TABSHR14  RESET     ATNSECDC 
          MOVE      SP70,UNITDESC
          MATCH     SP70,UNITCODE
          IF        !@EQUAL
            MATCH     ADOCTA,DOCTCODE
            IF        @EQUAL
              MATCH     UNITCODE,ACLSSFT
              GOTO      TABSHR10 IF NOT EQUAL
            ELSE
              MATCH     UNITCODE,PMVXEDU1
              GOTO      TABSHR10 IF NOT EQUAL
            ENDIF
          ENDIF
.
          IF        IBCNMHOS<>1
            GOTO      TABSHR15
          ENDIF
.
          MATCH     SP70,WBSEHOSP
          GOTO      TABSHR15 IF EQUAL
.
          MATCH     WBSEHOSP,PMVXMHOS
          GOTO      TABSHR10 IF NOT EQUAL
.
TABSHR15  PACK      KEY5,ANSA,ANSC,ACLSSFT
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,UNITDESC
          ENDIF
          MATCH     SP70,ACLSSFT
          IF        @EQUAL
            MOVE      SP70,UNITDESC
          ENDIF
.
          PACK      KEY5,ANSA,ANSC,PMVXEDU1
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,SUNTDESC
          ENDIF
          MATCH     SP70,PMVXEDU1
          IF        @EQUAL
            MOVE      SP70,SUNTDESC
            PACK      UNTDESC2,UNITDESC,SP70
          ELSE
            PACK      UNTDESC2,UNITDESC,SLASH,SUNTDESC,SP70
          ENDIF
.
          PACK      KEY5,ANSC,ANSL,ACLAIM
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,CLAIMCOD
          ENDIF
          MATCH     SP70,ACLAIM
          IF        @EQUAL
            MOVE      SP70,CLAIMCOD
          ENDIF
.
          PACK      KEY5,ANSA,SP1,ATYPE,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,ATYPDESC
          ENDIF
          MATCH     SP70,ATYPE
          IF        @EQUAL
            MOVE      SP70,ATYPDESC
          ENDIF
.
          MOVE      AURNO,URNUMBER
          MOVE      AADMNO,ADMISSNO
          MOVE      AURNO,URNO
          MOVE      SP70,KEY10
          CALL      GETPAT00
          REP       " 0",PTMXSIN1
.
          CALL      FWDBED00                        * format ward/bed
.
          CALL      PATFLD00                        * I CAR 45278
          CLEAR     PATLINK
          APPEND    "javascript:LinkTo('",PATLINK
          APPEND    URNUMBER,PATLINK
          APPEND    "','",PATLINK
          APPEND    ADMISSNO,PATLINK
          APPEND    "')",PATLINK
          RESET     PATLINK                         * end I CAR 45278
.
          CALL      GETCON00   * Get Condition and Expected Discharge Date
.
          MOVE      AFUNDH,HFUND 
          IF        FHIRTYPE=0
            WRITE     HTMLFILE;"t.addRow(":
                               QUOTE,URNUMBER,QUOTE,COMMA:
                               QUOTE,ADMISSNO,QUOTE,COMMA:
                               QUOTE,PCEASE,PCASE:
                               PTMXSIN1,PTMXSIN2,PTMXSIN3,PTMXSIN4,PRIVFLAG:
                               QUOTE,COMMA:
                               QUOTE,FORMATNM,QUOTE,COMMA:
                               QUOTE,*+,WDBEDTXT,QUOTE,COMMA:
                               QUOTE,ADATE,ATIME,QUOTE,COMMA:
                               QUOTE,DISPSEX,QUOTE,COMMA:
                               QUOTE;
            CALL      WRTAGE00
            WRITE     HTMLFILE;QUOTE,COMMA:
                               QUOTE,ADIAG1,ADIAG2,QUOTE,COMMA:
                               QUOTE,UNTDESC2,QUOTE,COMMA:
                               QUOTE,EXPDDATE,QUOTE,COMMA:
                               QUOTE,CLAIMCOD,QUOTE,COMMA:
                               QUOTE,PTMXSIN1,QUOTE,COMMA:
                               QUOTE,ATYPDESC,QUOTE,COMMA:
                               QUOTE,KEY3,QUOTE,COMMA:       * I CAR 45278
                               QUOTE,PATLINK,QUOTE,COMMA:    * I CAR 45278
                               QUOTE,HFUND,QUOTE,COMMA:
                               QUOTE,ATNSECDC,QUOTE:
                               ");"
          ELSE
            IF        ASTAT=1
              MOVE      "planned",ENSTATUS
            ENDIF
            IF        ASTAT=2
              MOVE      "arrived",ENSTATUS
            ENDIF
            CALL      FHRENC00
          ENDIF
.
          GOTO      TABSHR10
.
. On leave status
.
TABSHR20  MOVE      ZERO,STRLEAVE
          PACK      ATNSECDC,SP70
          PACK      DTITL,SP70
          PACK      DSNAME,SP70
          PACK      PMHCTITL,SP70
          PACK      PMHCSNAM,SP70
.
          PACK      KEY9,FOUR,SP70
          CALL      RDSMISS2
TABSHR30  CALL      RDKMISS2
          BRANCH    OVRCD,TABSHR90
.
          COMPARE   "4",ASTAT
          GOTO      TABSHR90 IF NOT EQUAL
.
TABSHR32  IF        FHIRTYPE=1
            MATCH     SP70,FRSTDATE          * check frstdate available
            GOTO      TABSHR33 IF EQUAL
            GOTO      TABSHR33 IF EOS
            MATCH     FRSTDATE,ADATE
            GOTO      TABSHR30 IF LESS
            MATCH     ADATE,LASTDATE
            GOTO      TABSHR30 IF LESS
          ENDIF
.
TABSHR33  COMPARE   ZERO,PTSTATUS          * fhir - Is there a status filter
          IF        !@EQUAL
            COMPARE   PTSTATUS,ASTAT       * fhir - Is the status selected
            IF        !@EQUAL
              GOTO      TABSHR30
            ENDIF
          ENDIF
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,TABSHR30
.
          IF        SHOWADDT=1
            CALL      ROWSCD00         * Output Shared Care for visit/doctor
          ENDIF
.
          MATCH     ADOCTA,DOCTCODE
          GOTO      TABSHR30 IF NOT EQUAL
.
          PACK      KEY6,ADOCTA,SP70
          CALL      RDDOCT1
          BRANCH    OVRCD,TABSHR35
.
          SQUEEZE   DTITL
          SQUEEZE   DSNAME
          MOVE      DGNAME,DIM1
          APPEND    DTITL,ATNSECDC
          APPEND    SP1,ATNSECDC
          APPEND    DIM1,ATNSECDC
          APPEND    SP1,ATNSECDC
          APPEND    DSNAME,ATNSECDC
.
          MATCH     SP70,PMVXEDC1
          GOTO      TABSHR35 IF EQUAL
.
          PACK      KEY10,PMVXEDC1
          CALL      RDPMHCP1
          BRANCH    OVRCD,TABSHR35
.
          SQUEEZE   PMHCTITL
          SQUEEZE   PMHCSNAM
          MOVE      PMHCGNAM,DIM1
.
          APPEND    SP1,ATNSECDC
          APPEND    SLASH,ATNSECDC
          APPEND    SP1,ATNSECDC
          APPEND    PMHCTITL,ATNSECDC
          APPEND    SP1,ATNSECDC
          APPEND    DIM1,ATNSECDC
          APPEND    SP1,ATNSECDC
          APPEND    PMHCSNAM,ATNSECDC
.
TABSHR35  RESET     ATNSECDC
          MOVE      SP70,UNITDESC
          MATCH     SP70,UNITCODE
          IF        !@EQUAL
            MATCH     ADOCTA,DOCTCODE
            IF        @EQUAL
              MATCH     UNITCODE,ACLSSFT
              GOTO      TABSHR30 IF NOT EQUAL
            ELSE
              MATCH     UNITCODE,PMVXEDU1
              GOTO      TABSHR30 IF NOT EQUAL
            ENDIF
          ENDIF
.
          PACK      KEY5,ANSA,ANSC,ACLSSFT
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,UNITDESC
          ENDIF
.
          PACK      KEY5,ANSA,ANSC,PMVXEDU1
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,SUNTDESC
          ENDIF
          MATCH     SP70,PMVXEDU1
          IF        @EQUAL
            MOVE      SP70,SUNTDESC
            PACK      UNTDESC2,UNITDESC,SP70
          ELSE
            PACK      UNTDESC2,UNITDESC,SLASH,SUNTDESC,SP70
          ENDIF
.
          PACK      KEY5,ANSA,SP1,ATYPE,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,ATYPDESC
          ENDIF
          MATCH     SP70,ATYPE
          IF        @EQUAL
            MOVE      SP70,ATYPDESC
          ENDIF
.
          MATCH     SP70,ACLSSFT
          IF        @EQUAL
            MOVE      SP70,UNITDESC
          ENDIF
.
.
          PACK      KEY5,ANSC,ANSL,ACLAIM
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,CLAIMCOD
          ENDIF
          MATCH     SP70,ACLAIM
          IF        @EQUAL
            MOVE      SP70,CLAIMCOD
          ENDIF
.
          MOVE      AURNO,URNUMBER
          MOVE      AADMNO,ADMISSNO
          MOVE      AURNO,URNO
          MOVE      "On Leave",COLDAT02
          CALL      GETPAT00
          REP       " 0",PTMXSIN1
.
          CALL      PATFLD00                        * I CAR 45278
          CLEAR     PATLINK
          APPEND    "javascript:LinkTo('",PATLINK
          APPEND    URNUMBER,PATLINK
          APPEND    "','",PATLINK
          APPEND    ADMISSNO,PATLINK
          APPEND    "')",PATLINK
          RESET     PATLINK                         * end I CAR 45278
.
          CALL      GETCON00   * Get Condition and Expected Discharge Date
.
          MOVE      AFUNDH,HFUND                    * CAR 191981
          IF        FHIRTYPE=0
            WRITE     HTMLFILE;"t.addRow(":
                               QUOTE,URNUMBER,QUOTE,COMMA:
                               QUOTE,ADMISSNO,QUOTE,COMMA:
                               QUOTE,PCEASE,PCASE:
                               PTMXSIN1,PTMXSIN2,PTMXSIN3,PTMXSIN4,PRIVFLAG:
                               QUOTE,COMMA:
                               QUOTE,FORMATNM,QUOTE,COMMA:
                               QUOTE,COLDAT02,QUOTE,COMMA:
                               QUOTE,ADATE,ATIME,QUOTE,COMMA:
                               QUOTE,DISPSEX,QUOTE,COMMA:
                               QUOTE;
            CALL      WRTAGE00
            WRITE     HTMLFILE;QUOTE,COMMA:
                               QUOTE,ADIAG1,ADIAG2,QUOTE,COMMA:
                               QUOTE,UNTDESC2,QUOTE,COMMA:
                               QUOTE,EXPDDATE,QUOTE,COMMA:
                               QUOTE,CLAIMCOD,QUOTE,COMMA:
                               QUOTE,PTMXSIN1,QUOTE,COMMA:
                               QUOTE,ATYPDESC,QUOTE,COMMA:
                               QUOTE,KEY3,QUOTE,COMMA:       * I CAR 45278
                               QUOTE,PATLINK,QUOTE,COMMA:    * I CAR 45278
                               QUOTE,HFUND,QUOTE,COMMA:
                               QUOTE,ATNSECDC,QUOTE:
                               ");"
          ELSE
            MOVE      "onleave",ENSTATUS
            CALL      FHRENC00
          ENDIF
          GOTO      TABSHR30
.
TABSHR90
TABSHR99  RETURN
+
.------------------------------------------------------------
. Don't display the secondary care doctor is they have and 
. end date in the past
.------------------------------------------------------------
SDEN0000  PACK      KEY24,PMVXVISN,Z70
          CALL      RSPMDTC1
SDEN1000  CALL      RPPMDTC1                     * Get last care record
          BRANCH    OVRCD,SDEN9000
.
          MATCH     PMVXVISN,PMDTVISN            * Correct visit
          GOTO      SDEN9000 IF NOT EQUAL
.
          MATCH     PMDTDOCT,PMVXEDC1            * Same secondary dr
          GOTO      SDEN1000 IF NOT EQUAL
.
          MATCH     PMDTUNIT,PMVXEDU1            * Same secondary dr unit
          GOTO      SDEN1000 IF NOT EQUAL
.
          MATCH     SP70,PMDTEDAT                * doctor had not ended
          GOTO      SDEN9000 IF EQUAL
.
          MOVE      SP70,KEY8A
          MOVE      PMDTETIM,KEY8A
          MATCH     SP70,KEY8A
          IF        @EQUAL
            PACK      KEY8A,ZERO,ZERO,COLON,ZERO,ZERO,COLON,ZERO,ZERO
          ENDIF
.
          PACK      KEY16,PMDTEDAT,KEY8A,SP70
.
          CALL      IBACLOCK
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          PACK      KEY16A,KEY8,CTIMEIS,SP70
.
          MATCH     KEY16A,KEY16       * End date in the past
          GOTO      SDEN9500 IF LESS
.
SDEN9000  MOVE      ZERO,EXIT          * OK Secondary doctor
          GOTO      SDEN9999           * not ended display recored
.
SDEN9500  MOVE      ONE,EXIT           * Secondary doctor has 
          GOTO      SDEN9999           * ended skip record
.         
SDEN9999  RETURN
+
.------------------------------------------------------------
. Get Condition and Expected Discharge Date
.------------------------------------------------------------
GETCON00  PACK      KEY8,ADMISSNO,SP70                                 *I-23312
          CALL      RDPMWOR1
          IF        OVRCD=1
            CALL      CLPMWO00
          ENDIF
          MATCH     SP70,PMWOEDAT
          IF        !@EQUAL
            UNPACK    PMWOEDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      EXPDDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ELSE
            MOVE      SP70,EXPDDATE
            UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
            MOVE      ASTAY,ADJDAYS
            CALL      ADJDAT00
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      EXPDDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
          RETURN
.------------------------------------------------------------
. Table of Current Admissions By Referring Doctor
.------------------------------------------------------------
TABRDM00  PACK      KEY9,TWO,SP70
          CALL      RDSMISS2
TABRDM10  CALL      RDKMISS2
          BRANCH    OVRCD,TABRDM20
          COMPARE   "2",ASTAT
          GOTO      TABRDM20 IF NOT EQUAL
          MATCH     ADOCTR,WBSEDOC
          GOTO      TABRDM10 IF NOT EQUAL
.
          MOVE      AURNO,URNUMBER
          MOVE      AADMNO,ADMISSNO
          MOVE      AURNO,URNO
          MOVE      SP70,KEY10
          CALL      GETPAT00 
          CALL      FWDBED00            * format ward/bed text   
          WRITE     HTMLFILE;"t.addRow(":
                             QUOTE,URNUMBER,QUOTE,COMMA:
                             QUOTE,ADMISSNO,QUOTE,COMMA:
                             QUOTE,PCEASE,PCASE:
                             PTMXSIN1,PTMXSIN2,PTMXSIN3,PTMXSIN4,PRIVFLAG:
                             QUOTE,COMMA:
                             QUOTE,FORMATNM,QUOTE,COMMA:
                             QUOTE,WDBEDTXT,QUOTE,COMMA:
                             QUOTE,ADATE,ATIME,QUOTE,COMMA:
                             QUOTE,DISPSEX,QUOTE,COMMA:
                             QUOTE;
          CALL      WRTAGE00
          WRITE     HTMLFILE;QUOTE,COMMA:
                             QUOTE,ADIAG1,ADIAG2,QUOTE:
                             ");"
          GOTO      TABRDM10
.
TABRDM20  MOVE      ZERO,STRLEAVE
          PACK      KEY9,FOUR,SP70
          CALL      RDSMISS2
TABRDM30  CALL      RDKMISS2
          BRANCH    OVRCD,TABRDM90
          COMPARE   "4",ASTAT
          GOTO      TABRDM90 IF NOT EQUAL
          MATCH     ADOCTR,DOCTCODE
          GOTO      TABRDM30 IF NOT EQUAL
.
          MOVE      AURNO,URNUMBER
          MOVE      AADMNO,ADMISSNO
          MOVE      AURNO,URNO
          MOVE      "On Leave",COLDAT02
          CALL      GETPAT00 
          WRITE     HTMLFILE;"t.addRow(":
                             QUOTE,URNUMBER,QUOTE,COMMA:
                             QUOTE,ADMISSNO,QUOTE,COMMA:
                             QUOTE,PCEASE,PCASE:
                             PTMXSIN1,PTMXSIN2,PTMXSIN3,PTMXSIN4,PRIVFLAG:
                             QUOTE,COMMA:
                             QUOTE,FORMATNM,QUOTE,COMMA:
                             QUOTE,COLDAT02,QUOTE,COMMA:
                             QUOTE,ADATE,ATIME,QUOTE,COMMA:
                             QUOTE,DISPSEX,QUOTE,COMMA:
                             QUOTE;
          CALL      WRTAGE00
          WRITE     HTMLFILE;QUOTE,COMMA:
                             QUOTE,ADIAG1,ADIAG2,QUOTE:
                             ");"
          GOTO      TABRDM30
.
TABRDM90 
TABRDM99  RETURN
.
.------------------------------------------------------------
. Format Patient Name (for Javascript)  <b>SURNAME</b>Title Given Names
.*** format the surname and given name by changing any ' to %60
.------------------------------------------------------------
JAVNAM00  CLEAR     DISPNAME
          MOVE      SP70,JAVFNAME
.
          MOVE      PSNAME,JAVSNAME          * surname
          SCAN      "'",JAVSNAME             * find any apostrophies
          GOTO      JAVNAM10 IF NOT EQUAL
.
          MOVE      JAVSNAME,ENDNAME
          REP       "' ",ENDNAME             * remove the apostrophy
.
          LENSET    JAVSNAME
          RESET     JAVSNAME                 * get all characters before '
          MOVE      JAVSNAME,STRTNAME
.
          REP       "'%",STRTNAME
          STRIP     STRTNAME
          PACK      JAVSNAME,STRTNAME,SIXTY,ENDNAME,SP70 * formatted surname
.
JAVNAM10  MOVE      SP70,STRTNAME
          MOVE      SP70,ENDNAME
.
          MOVE      PGNAME,JAVGNAME     * given name
          SCAN      "'",JAVGNAME        * find any apostrophies
          GOTO      JAVNAM20 IF NOT EQUAL
.
          MOVE      JAVGNAME,ENDNAME    * store all chars after apostrophy
          REP       "' ",ENDNAME        * remove the apostrophy
.
          LENSET    JAVGNAME
          RESET     JAVGNAME
          MOVE      JAVGNAME,STRTNAME   * store all chars before the '
.
          REP       "'%",STRTNAME
          STRIP     STRTNAME
          PACK      JAVGNAME,STRTNAME,SIXTY,ENDNAME,SP70  * formatted given name
.
JAVNAM20  REP       "#" ",JAVSNAME
          REP       "#" ",JAVGNAME
          MOVE      SP70,JAVFNAME
          REP       UPPLOW,JAVSNAME
          APPEND    "<b>",DISPNAME
          APPEND    JAVSNAME,DISPNAME
          APPEND    "</b>",DISPNAME
          PACK      NAME35,PTITL,SP70
          CALL      NAMSTR00
          PACK      NAME35,PGNAME,SP70
          CALL      NAMSTR00
          APPEND    SP70,DISPNAME
          RESET     DISPNAME
          MOVE      DISPNAME,JAVFNAME
          STRIP     JAVFNAME
.
JAVNAM99  RETURN
+
.------------------------------------------------------------------------------
.         Table of Current Admissions by Doctor (inclusive of Secondary,
.         Additional (Shared Care), and Case Team Doctor)
.------------------------------------------------------------------------------
TABADV00  CALL      IBACLOCK
          PACK      TODAYDTE,CCC,CYY,CMM,CDD
          REP       " 0",TODAYDTE
.
          CALL      CRETMP00           * Create new temp file
.
          CALL      GETADV00           * Get all visits for DOCTCODE
          CALL      OUTADV00           * Output table rows
.
          CALL      CLRTMP00           * Clear temp file
          CALL      KILTMP00           * Remove temp file
.
TABADV99  RETURN
+
.------------------------------------------------------------------------------
.         Gets all doctor visits (current/on leave) for DOCTCODE.
.         Matches to a Secondary, Additional (Shared Care), or Case Team Doctor.
.         Writes each matching admission to our temp file.
.------------------------------------------------------------------------------
GETADV00  PACK      KEY9,TWO,SP70
          CALL      RDSMISS2
GETADV10  CALL      RDKMISS2
          BRANCH    OVRCD,GETADV40
.
          COMPARE   "2",ASTAT               * 'Current' admission?
          GOTO      GETADV40 IF NOT EQUAL
.
          CALL      CLTMPV00                * Clear temp file vars
          CALL      MATDOC00                * Match doctor code for visit
          IF        EXIT=1
            CALL      WRTMPD00              * Write patient details to temp file
          ENDIF
.
          GOTO      GETADV10
.
.
.         Get 'On Leave' admissions...
.
GETADV40  PACK      KEY9,FOUR,SP70
          CALL      RDSMISS2
GETADV50  CALL      RDKMISS2
          BRANCH    OVRCD,GETADV99
.
          COMPARE   "4",ASTAT               * 'On Leave' admission?
          GOTO      GETADV99 IF NOT EQUAL
.
          CALL      CLTMPV00                * Clear temp file vars
          CALL      MATDOC00                * Match doctor code for visit
          IF        EXIT=1
            CALL      WRTMPD00              * Write patient details to temp file
          ENDIF
.
          GOTO      GETADV50
.
GETADV99  RETURN
+
.------------------------------------------------------------------------------
.         Matches DOCTCODE for the visit. 
.         Matches Attending/Admitting, Secondary, Shared Care and Case Team Doc.
.         Moves corresponding values to temp file vars.
.
.         Return:
.           EXIT - 0 = no match, 1 = match
.------------------------------------------------------------------------------
MATDOC00  MOVE      ZERO,EXIT
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,MATDOC99          * Missing visit extension record
.
          IF        IBCNMHOS<>1
            GOTO      MATDOC10
          ENDIF
.
          MATCH     SP70,WBSEHOSP
          GOTO      MATDOC10 IF EQUAL
.
          MATCH     WBSEHOSP,PMVXMHOS
          GOTO      MATDOC99 IF NOT EQUAL   * Hospital ID does NOT match
.
MATDOC10  MATCH     ADOCTA,DOCTCODE         * Matching Attending Doctor?
          GOTO      MATDOC91 IF EQUAL
.
.         Match Secondary doctor
.
          MATCH     PMVXEDC1,DOCTCODE       * Matching Secondary Doctor?
          IF        @EQUAL
            MOVE      PMVXEDC1,TMPSDOCT
            GOTO      MATDOC91              * yes
          ENDIF
.
.         Match Shared Care (additional) doctor
.
          CALL      MTCHSC00                * Match doctor to a shared care vis
          IF        EXIT=1
            MOVE      PMDTDOCT,TMPSDOCT
            GOTO      MATDOC91
          ENDIF
          MOVE      SP70,PMDTDOCT
.
.         Match Case Team doctor
.
          MATCH     SP70,PMVXCASE           * Case Team exists for admission?
          GOTO      MATDOC99 IF EQUAL       * no
.
          MOVE      PMVXCASE,CASETEAM
          MOVE      DOCTCODE,CASEDOCT
          CALL      MTCHCT00                * Match Case Team doctor
          IF        EXIT=1
            MOVE      PMVXCASE,TMPCASET
            GOTO      MATDOC91
          ENDIF
.
          GOTO      MATDOC99
.
MATDOC91  MOVE      ONE,EXIT
          MOVE      PMVXCASE,TMPCASET       * Output Case Team also
          MATCH     SP70,TMPSDOCT
          GOTO      MATDOC99 IF NOT EQUAL
.
          MATCH     SP70,PMVXEDC1
          GOTO      MATDOC92 IF EQUAL
.
          MOVE      PMVXEDC1,TMPSDOCT       * Output Secondary Doct if exists
          GOTO      MATDOC99
.
MATDOC92  MATCH     SP70,PMDTDOCT
          GOTO      MATDOC99 IF EQUAL
.
          MOVE      PMDTDOCT,TMPSDOCT       * Output Shared Care Doct if exists
          GOTO      MATDOC99
.
MATDOC99  RETURN
+
.------------------------------------------------------------------------------
.         Finds a matching doctor for the specified Case Team
.
.         Parameters:
.           CASETEAM - Team Number
.           CASEDOCT - Doctor Code to match
.
.         Return:
.           EXIT - 0 = no match, 1 = match
.------------------------------------------------------------------------------
MTCHCT00  MOVE      ZERO,EXIT
.
          PACK      KEY20,CASETEAM,SP70
          CALL      RSALCTM1
MTCHCT10  CALL      RKALCTM1
          BRANCH    OVRCD,MTCHCT99
.
          MATCH     CASETEAM,ALCTTEAM       * still on same Case Team?
          GOTO      MTCHCT99 IF NOT EQUAL   * no; finished and no match found
.
          MATCH     CASEDOCT,ALCTHCPC       * matching doctor?
          GOTO      MTCHCT91 IF EQUAL       * yes
.
          GOTO      MTCHCT10
.
MTCHCT91  MOVE      ONE,EXIT
MTCHCT99  RETURN
+
.------------------------------------------------------------------------------
.         Matches the doctor (DOCTCODE) for a Shared Care visit
.
.         Return:
.           EXIT - 0 = no match, 1 = match
.------------------------------------------------------------------------------
MTCHSC00  MOVE      ZERO,EXIT
.
          PACK      KEY24,AADMNO,SP70
          CALL      RSPMDTC1
MTCHSC10  CALL      RKPMDTC1
          BRANCH    OVRCD,MTCHSC99
.
          MATCH     DAADMNO,PMDTVISN
          GOTO      MTCHSC99 IF NOT EQUAL
.
          MATCH     TODAYDTE,PMDTSDAT       * start date before today?
          GOTO      MTCHSC11 IF EQUAL
          GOTO      MTCHSC10 IF NOT LESS
.
MTCHSC11  MATCH     SP70,PMDTEDAT           * shared care ended?
          GOTO      MTCHSC10 IF NOT EQUAL
.
          MATCH     DOCTCODE,PMDTDOCT       * matching doctor?
          GOTO      MTCHSC91 IF EQUAL
.
          GOTO      MTCHSC10
.
MTCHSC91  MOVE      ONE,EXIT
MTCHSC99  RETURN
+
.------------------------------------------------------------------------------
.         Write the admission details to our temp file
.------------------------------------------------------------------------------
WRTMPD00  MOVE      ADOCTA,TMPADOCT
.
          MOVE      SP70,ATYPDESC
          MATCH     SP70,ATYPE 
          IF        !@EQUAL
            PACK      KEY5,ANSA,SP1,ATYPE,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      TDESC,ATYPDESC
            ENDIF
          ENDIF
.
          MOVE      AURNO,URNUMBER
          MOVE      AADMNO,ADMISSNO
.
          CALL      FWDBED00           * Format ward/bed text (WDBEDTXT)
          COMPARE   "4",ASTAT
          IF        @EQUAL
            MOVE      "On Leave",WDBEDTXT
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RATEMP1
          IF        OVRCD=1
            CALL      WRTEMP1
          ENDIF
.
WRTMPD99  RETURN
+
.------------------------------------------------------------------------------
.         Output all admission rows for the matching doctor (DOCTCODE)
.------------------------------------------------------------------------------
OUTADV00  PACK      KEY8,SP70
          CALL      RSTEMP1
OUTADV10  CALL      RKTEMP1
          BRANCH    OVRCD,OUTADV99
.
          MOVE      URNUMBER,URNO
          MOVE      SP70,KEY10
.
          CALL      GETPAT00
          REP       " 0",PTMXSIN1      * Patient Alert icon value
.
          CALL      PATFLD00           * Determine Patient Folder String (KEY3)
.
          CALL      GETCON00           * Get Condition and Expected Discharge 
.
          MOVE      ADMISSNO,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD,OUTADV10
.
          CLEAR     PATLINK
          APPEND    "javascript:LinkTo('",PATLINK
          APPEND    URNUMBER,PATLINK
          APPEND    "','",PATLINK
          APPEND    ADMISSNO,PATLINK
          APPEND    "')",PATLINK
          RESET     PATLINK
.
          PACK      CONSULTN,SP70,SP70
          MOVE      SP70,ADMTDOCN      * Admitting Doctor Name
          MOVE      SP70,ATNSECDC      * Secondary/Additional Doctor Name
.
          MATCH     SP70,TMPADOCT
          GOTO      OUTADV20 IF EQUAL
.
          PACK      KEY6,TMPADOCT,SP70
          CALL      RDDOCT1
          BRANCH    OVRCD,OUTADV20
.
          STRIP     DTITL
          STRIP     DSNAME
          MOVE      DGNAME,DIM1
.
          CLEAR     ADMTDOCN
          APPEND    DTITL,ADMTDOCN
          APPEND    SP1,ADMTDOCN
          APPEND    DIM1,ADMTDOCN
          APPEND    SP1,ADMTDOCN
          APPEND    DSNAME,ADMTDOCN
          RESET     ADMTDOCN
.
OUTADV20  MATCH     SP70,TMPSDOCT
          GOTO      OUTADV30 IF EQUAL
.
          PACK      KEY10,TMPSDOCT,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,OUTADV30
.
          MOVE      PMHCTITL,FMTTITLE
          MOVE      PMHCSNAM,FMTSNAME
          MOVE      PMHCGNAM,FMTGNAME
          CALL      DOCNM000
          MOVE      DOCFNAME,ATNSECDC
.
OUTADV30  CLEAR     CONSULTN
          APPEND    ADMTDOCN,CONSULTN
          APPEND    "<BR>",CONSULTN
          APPEND    ATNSECDC,CONSULTN
          RESET     CONSULTN
.
          MOVE      SP70,ALCADESC
.
          MATCH     SP70,TMPCASET
          IF        !@EQUAL
            PACK      KEY10,TMPCASET,SP10
            CALL      RDALCAS1
          ENDIF
.
OUTADV50  WRITE     HTMLFILE;"t.addRow(":
                             QUOTE,URNUMBER,QUOTE,COMMA:             * 0
                             QUOTE,ADMISSNO,QUOTE,COMMA:            
                             QUOTE,PCEASE,PCASE:
                             PTMXSIN1,PTMXSIN2,PTMXSIN3,PTMXSIN4,PRIVFLAG:
                             QUOTE,COMMA:
                             QUOTE,FORMATNM,QUOTE,COMMA:
                             QUOTE,*+,WDBEDTXT,*-,QUOTE,COMMA:
                             QUOTE,ADATE,ATIME,QUOTE,COMMA:          * 5
                             QUOTE,ADIAG1,ADIAG2,QUOTE,COMMA:
                             QUOTE,EXPDDATE,QUOTE,COMMA:
                             QUOTE,PTMXSIN1,QUOTE,COMMA:
                             QUOTE,ATYPDESC,QUOTE,COMMA:
                             QUOTE,CONSULTN,QUOTE,COMMA:             * 10
                             QUOTE,ALCADESC,QUOTE,COMMA:
                             QUOTE,KEY3,QUOTE,COMMA:
                             QUOTE,PATLINK,QUOTE,COMMA,QUOTE;
.
          CALL      VCDM0000                * Visit based CDM        * 14
          WRITE     HTMLFILE;QUOTE,");"
          GOTO      OUTADV10
.
OUTADV99  RETURN
+
.------------------------------------------------------------------------------
. FHIR Encounter Resource
.------------------------------------------------------------------------------
RESPRA00  MOVE      PMHCADR1,PRACNAME       * use hcp details
          MOVE      PMHCADR2,PRACADD1
          MOVE      SP70,PRACADD2
          MOVE      PMHCADR3,PRACADD3
          MOVE      PMHCADR4,PRACADD4
          MOVE      PMHCPOST,PRACPOST
          MOVE      PMHCSEML,PRACPEML
          MOVE      PMHCSTEL,PRACPTEL
          MOVE      PMHCFAXN,PRACPFAX
          MOVE      PMHCPRV1,PRACPROV
          PACK      DISPPRAC,SP70
          PACK      DISPPNAM,SP70,SP70
          PACK      DISPPCNT,SP70
.
          MOVE      "DT",TCODE
          PACK      KEY5,TCODE,PMHCSPC1,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      SP70,TDESC
          ENDIF
          CALL      HCPNAM00
          WRITE     HTMLFILE;*+," { #"resourceType#": #"Practitioner#",":
                    "   #"id#": #"HCP-",PMHCHCPC,"#",":
                    " #"extension#": [":
                    " { #"url#":#"%BASEURL/extension/webPASService#"":
                        " ,#"valueString#":#"",PRGID,SP1,PRGNAM,SP1,VERSION,"#"},":
                    " { #"url#":#"%BASEURL/extension/webPASTemplate#"":
                        " ,#"valueString#":#"%TEMPLATEHOME/",WBTPFIL," %TEMPLATEVERSION#"},":
                    " { #"url#":#"%BASEURL/extension/dxc-hc-speciality#"":
                        " ,#"valueString#":#"",TDESC,"#"}":
                    " ],":
                    " #"identifier#": [ ":
                    "  {#"type#": { #"text#" : #"HCP ID#" },":
                    "   #"value#": #"",PMHCHCPC,"#" },":
                    "  {#"type#": { #"text#" : #"Provider Number#" },":
                    "   #"value#": #"",PRACPROV,"#" }":
                    "    ] ,":
                    " #"name#": [ { ":
                    "  #"use#": #"usual#",":
                    "  #"text#": #"",DOCFNAME,"#" ,":
                    "  #"prefix#":[ #"",PMHCTITL,"#" ],":
                    "  #"given#": [ #"",PMHCGNAM,"#" ],":
                    "  #"family#": #"",PMHCSNAM,"#" } ],":
                    "  #"telecom#": [ ":
                    "   { #"system#": #"phone#", #"use#": #"work#", ":
                    "     #"value#": #"",PRACPTEL,"#" },":
                    "   { #"system#": #"email#", #"use#": #"work#", ":
                    "     #"value#": #"",PRACPEML,"#" },":
                    "   { #"system#": #"phone#", #"use#": #"mobile#", ":
                    "     #"value#": #"",PMHCMOBN,"#" },":
                    "   { #"system#": #"fax#",   #"use#": #"work#", ":
                    "     #"value#": #"",PRACPFAX,"#" } ],":
                    " #"address#": [ {":
                    "  #"use#": #"work#",":
                    "  #"line#": [#"",PRACNAME,"#"":
                    ",#"",PRACADD1,"#"";
          MATCH     SP70,PRACADD2
          IF        !@EQUAL
            STRIP     PRACADD2
            WRITE     HTMLFILE;*+,",#"",PRACADD2,"#"";
          ENDIF
          WRITE     HTMLFILE;*+,"],":
                      "       #"city#": #"",PRACADD3,"#",":
                      "       #"state#": #"",PRACADD4,"#",":
                      "       #"postalCode#": #"",PRACPOST,"#"":
                      "      }":
                      "    ]";
          WRITE     HTMLFILE;*+,"  }";
          RETURN
+
.------------------------------------------------------------------------------
. Format HCP Name in Title Text
.------------------------------------------------------------------------------
HCPNAM00  MOVE      PMHCTITL,FMTTITLE
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000
          RETURN
.
.------------------------------------------------------------------------------
. FHIR Location Resource for Ward.
.------------------------------------------------------------------------------
RESWRD00  STRIP     WBDESC
          STRIP     PTHSHOSP
          CLEAR     KEY16
          APPEND    "Ward-",KEY16
          APPEND    WWARD,KEY16
          APPEND    SP70,KEY16
          RESET     KEY16
          STRIP     WBTPFIL
          WRITE     HTMLFILE;*+," { #"resourceType#": #"Location#",":
                    " #"id#": #"",KEY16,"#",":
                    " #"extension#": [":
                    " { #"url#":#"%BASEURL/extension/webPASService#"":
                        " ,#"valueString#":#"",PRGID,SP1,PRGNAM,SP1,VERSION,"#"},":
                    " { #"url#":#"%BASEURL/extension/webPASTemplate#"":
                        " ,#"valueString#":#"%TEMPLATEHOME/",WBTPFIL," %TEMPLATEVERSION#"}":
                    " ],":
                    " #"identifier#": { #"value#": #"",KEY16,"#"},":
                    " #"name#": #"",WBDESC,"#",":
                    " #"physicalType#": {":
                    "  #"coding#": [ {":
                    "   #"system#": #"http://hl7.org/fhir/location-physical-type#",":
                    "   #"code#": #"wa#",":
                    "   #"display#": #"Ward#"  } ] },";
          MATCH     SP70,WEXTN
          IF        !@EQUAL
             WRITE     HTMLFILE;*+," #"telecom#": [":
                       "{ #"system#": #"phone#",":
                       "  #"value#": #"",WEXTN,"#" } ],";
          ENDIF
          WRITE     HTMLFILE;*+," #"partOf#": { ":
                    "  #"reference#": #"Location/Hospital-",PTWDHOSN,"#"":
                    " } } ";
          RETURN
+
.------------------------------------------------------------------------------
. FHIR Location Resource for Bed
.------------------------------------------------------------------------------
RESBED00  MOVE      "BT",CATEGORY
          MOVE      WEFRBT,CODE
          CALL      GETCOD00
          MOVE      TDESC,BEDTDESC
.
          MOVE      "RT",CATEGORY
          MOVE      WRTYPE,CODE
          CALL      GETCOD00
          MOVE      TDESC,ROOMDESC
.
          MOVE      CATBW,CATEGORY
          MOVE      PTWDIFST,CODE
          CALL      GETCOD00
          MOVE      TDESC,IFSTDESC
.
          COMPARE   ZERO,WACTIVE
          IF        @EQUAL
            MOVE      "true",ACTVDESC
          ELSE
            MOVE      "false",ACTVDESC
          ENDIF
          STRIP     PTHSHOSP
          STRIP     WBTPFIL
.
          CLEAR     KEY16
          APPEND    "Bed-",KEY16
          PACK      WWARD,WWARD,SP70
          APPEND    WWARD,KEY16
          APPEND    WBED,KEY16
          APPEND    SP70,KEY16
          RESET     KEY16
          STRIP     KEY16
          REP       " -",KEY16
          STRIP     WWARD
.
          WRITE     HTMLFILE;*+,"{#"resourceType#": #"Location#",":
                    " #"id#": #"",KEY16,"#",":
                    " #"extension#": [":
                    " { #"url#":#"%BASEURL/extension/webPASService#"":
                        " ,#"valueString#":#"",PRGID,SP1,PRGNAM,SP1,VERSION,"#"},":
                    " { #"url#":#"%BASEURL/extension/webPASTemplate#"":
                        " ,#"valueString#":#"%TEMPLATEHOME/",WBTPFIL," %TEMPLATEVERSION#"}":
                    " ],":
                    " #"identifier#": { #"value#": #"",KEY16,"#"},":
                    " #"name#": #"",WBDESC,"#",":
                    " #"physicalType#": {":
                    "  #"coding#": [ {":
                    "   #"system#": #"http://hl7.org/fhir/location-physical-type#",":
                    "   #"code#": #"bd#",":
                    "   #"display#": #"Bed#"  } ] },";
.
          MATCH     SP70,WEXTN
          IF        !@EQUAL
             WRITE     HTMLFILE;*+," #"telecom#": [":
                       "{ #"system#": #"phone#",":
                       "  #"value#": #"",WEXTN,"#" } ],";
          ENDIF
          WRITE     HTMLFILE;*+," #"partOf#": { ":
                    "       #"reference#": #"Location/Ward-",WWARD,"#"":
                    " } } "
.
          RETURN
+
.------------------------------------------------------------
. Get HCP 1 for FHIR Response.
.------------------------------------------------------------
FHRDO100  MOVE      SP70,FHRDOCC1
          MOVE      SP70,FHRDOCT1
          MOVE      SP70,FHRDOCN1
.
          MATCH     SP70,ADOCTA
          GOTO      FHRDO199 IF EQUAL
.
          PACK      KEY10,ADOCTA,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,GFRDOC99
.
          CLEAR     FHRDOCC1
          APPEND    "HCP-",FHRDOCC1
          APPEND    ADOCTA,FHRDOCC1
          RESET     FHRDOCC1
          MOVE      "ADM",FHRDOCT1 *  Doctor Type
          SQUEEZE   PMHCTITL
          SQUEEZE   PMHCSNAM
          MOVE      PMHCGNAM,DIM1
          PACK      FHRDOCN1,PMHCTITL,SP1,DIM1,DOT,SP1,PMHCSNAM,SP70
.
FHRDO199  RETURN
+
.------------------------------------------------------------
. Get HCP 2 for FHIR Response.
.------------------------------------------------------------
FHRDO200  MOVE      SP70,FHRDOCC2
          MOVE      SP70,FHRDOCT2
          MOVE      SP70,FHRDOCN2
.
          MATCH     SP70,PMVXEDC1
          GOTO      FHRDO299 IF EQUAL
.
          PACK      KEY10,PMVXEDC1
          CALL      RDPMHCP1
          BRANCH    OVRCD,GFRDOC99
.
          CLEAR     FHRDOCC2
          APPEND    "HCP-",FHRDOCC2
          APPEND    PMVXEDC1,FHRDOCC2
          RESET     FHRDOCC2
          MOVE      "CON",FHRDOCT2
          SQUEEZE   PMHCTITL
          SQUEEZE   PMHCSNAM
          MOVE      PMHCGNAM,DIM1
          PACK      FHRDOCN2,PMHCTITL,SP1,DIM1,DOT,SP1,PMHCSNAM,SP70
.
FHRDO299  RETURN
+
.------------------------------------------------------------------------------
.                   CRETMP00
.         Create a new temporary file (cancelled visits)                  
.------------------------------------------------------------------------------
CRETMP00  CALL      KILTMP00                     * remove existing file
.
          CLEAR     CMDLINE
          PACK      CMDLINE,ISBUILD,TEMPFIL1,UKEY1
          EXECUTE   CMDLINE,TASKID               * create temporary index file
.
          OPEN      DOCVTEMP,TEMPFIL1            * open temp index 1
.
CRETMP99  RETURN
+
.------------------------------------------------------------------------------
.                   KILTMP00
.         Close and erase the temporary file
.------------------------------------------------------------------------------
KILTMP00  CLOSE     DOCVTEMP                     * close file
.
          CLEAR     CMDLINE
          PACK      CMDLINE,ISERASE,TEMPFIL1     * set file erase command
          EXECUTE   CMDLINE,TASKID               * erase temp file
.
KILTMP99 RETURN
+
.------------------------------------------------------------------------------
.                   CLER0000
.         Erase and close the temporary file
.------------------------------------------------------------------------------
CLRTMP00  MOVE      SP30,KEY8
          CALL      RSTEMP1                      * position at start of file
          CALL      RKTEMP1                      * read next record
          BRANCH    OVRCD,CLRTMP99               * eof - finished
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      DETEMP1                      * delete current record
          GOTO      CLRTMP00                     * get next record
.
CLRTMP99  RETURN
+
.------------------------------------------------------------------------------
.         Clear temp file vars
.------------------------------------------------------------------------------
CLTMPV00  UNPACK    SP70,TMPADOCT,TMPSDOCT,TMPCASET
          RETURN
+
.******************************************************************************
.*        IO ROUTINES FOR TEMPORARY FILE 2 (Cancelled Visists)                *
.******************************************************************************
.
.         Index 1
.
RSTEMP1   READ      DOCVTEMP,KEY8;;
          RETURN
.
RATEMP1   RESET     KEY8
          MOVE      ZERO,OVRCD
          READ      DOCVTEMP,KEY8;ANS
          GOTO      OVERCOND IF OVER
          RETURN
.
RDTEMP1   MOVE      ZERO,OVRCD
          READ      DOCVTEMP,KEY8;ADMISSNO,URNUMBER,WDBEDTXT,ADATE,ATIME:
                                  ADIAG1,ADIAG2,ATYPDESC,TMPADOCT,TMPSDOCT:
                                  TMPCASET
          GOTO      OVERCOND IF OVER
          RETURN
.
RKTEMP1   MOVE      ZERO,OVRCD
          READKS    DOCVTEMP;ADMISSNO,URNUMBER,WDBEDTXT,ADATE,ATIME:
                             ADIAG1,ADIAG2,ATYPDESC,TMPADOCT,TMPSDOCT:
                             TMPCASET
          GOTO      OVERCOND IF OVER
          RETURN
.
RPTEMP1   MOVE      ZERO,OVRCD
          READKP    DOCVTEMP;ADMISSNO,URNUMBER,WDBEDTXT,ADATE,ATIME:
                             ADIAG1,ADIAG2,ATYPDESC,TMPADOCT,TMPSDOCT:
                             TMPCASET
          GOTO      OVERCOND IF OVER
          RETURN
.
WRTEMP1   WRITE     DOCVTEMP,KEY8;ADMISSNO,URNUMBER,WDBEDTXT,ADATE,ATIME:
                                  ADIAG1,ADIAG2,ATYPDESC,TMPADOCT,TMPSDOCT:
                                  TMPCASET
          RETURN
.
UPTEMP1   UPDATE    DOCVTEMP;ADMISSNO,URNUMBER,WDBEDTXT,ADATE,ATIME:
                             ADIAG1,ADIAG2,ATYPDESC,TMPADOCT,TMPSDOCT:
                             TMPCASET
          RETURN
.
DETEMP1   DELETE    DOCVTEMP,KEY8
          RETURN
+
.------------------------------------------------------------------------------
          INC       FHRDATCD
          INC       CALCAGE
          INC       CLPATVIS
          INC       PATDOCTM
          INC       PATDOCCD
          INC       NAMSTRCD
          iNC       WEBDATCD
          INC       DAYOFWEK
          INC       PMSPX2TM           * I CAR 45278
          INC       PMSCDNDS
          INC       PMSWORTM                                           *I-23312
          INC       IBAWEBCD
          INC       PATNAMCD
          INC       TFILENAM
          INC       ALLCASIO/INC
          INC       ALLCTMIO/INC
          INC       BOKRC1IO/INC
          INC       OPRDEAIO/INC
          INC       PATDO1IO/INC
          INC       PATDSCIO/INC
          INC       PATHSPIO/INC
          INC       PATMI1IO/INC
          INC       PATMA1IO/INC
.
          INC       PMSCCDIO/INC   * Concession Card Details
          INC       PMSCDNIO/INC
          INC       PMSPX2IO/INC
          INC       PMSCEXIO/INC
          INC       PMSRELIO/INC
          INC       PMSTLEIO/INC
          INC       PATPR1IO/INC
          INC       PATVISIO/INC
          INC       PMSDTCIO/INC
          INC       PMSHCPIO/INC
          INC       PMSHCLIO/INC
          INC       PMSVX1IO/INC
          INC       PATTRNIO/INC
          INC       PATWR1IO/INC
          INC       PATVADIO/INC
          INC       PMSWORIO/INC                                       *I-23312
